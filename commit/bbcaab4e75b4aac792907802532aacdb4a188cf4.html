<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>feat: task section - SnapEnhance - An Xposed module offering an enhanced Snapchat experience
</title>
<link rel="icon" type="image/svg+xml" href="../../logo.png"/>
<link rel="alternate icon" href="../../favicon.png"/>
<link rel="alternate" type="application/atom+xml" title="SnapEnhance Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="SnapEnhance Atom Feed (tags)" href="../tags.xml" />
<link rel="stylesheet" type="text/css" href="../../style.css" />
<link rel="stylesheet" type="text/css" href="../../fonts.css" />
</head>
<body>
<div id="head"><table><tr><td><a class="logo" href="../../"><img src="../../logo.png" alt="" width="32" height="32" /></a></td><td><strong>SnapEnhance</strong><span class="desc"> - An Xposed module offering an enhanced Snapchat experience
</span>
</td></tr></table>
<p><a href="../about.html">About</a> | <a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/LICENSE.html">License</a></p>
</div>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/bbcaab4e75b4aac792907802532aacdb4a188cf4.html">bbcaab4e75b4aac792907802532aacdb4a188cf4</a>
<b>parent</b> <a href="../commit/31aa7151ec20757aedfac28d1dbefbdfbae39c2a.html">31aa7151ec20757aedfac28d1dbefbdfbae39c2a</a>
<b>Author:</b> rhunk &lt;<a href="mailto:101876869+rhunk@users.noreply.github.com">101876869+rhunk@users.noreply.github.com</a>&gt;
<b>Date:</b>   Sun, 29 Oct 2023 02:17:58 +0200

feat: task section

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">app/src/main/kotlin/me/rhunk/snapenhance/RemoteSideContext.kt</a></td><td> | </td><td class="num">6</td><td><span class="i">+++</span><span class="d">---</span></td></tr>
<tr><td class="D">D</td><td><a href="#h1">app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadObject.kt</a></td><td> | </td><td class="num">34</td><td><span class="i"></span><span class="d">----------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h2">app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadProcessor.kt</a></td><td> | </td><td class="num">172</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">----------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h3">app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadTaskManager.kt</a></td><td> | </td><td class="num">193</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h4">app/src/main/kotlin/me/rhunk/snapenhance/download/FFMpegProcessor.kt</a></td><td> | </td><td class="num">6</td><td><span class="i">++++</span><span class="d">--</span></td></tr>
<tr><td class="A">A</td><td><a href="#h5">app/src/main/kotlin/me/rhunk/snapenhance/task/PendingTask.kt</a></td><td> | </td><td class="num">134</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h6">app/src/main/kotlin/me/rhunk/snapenhance/task/TaskManager.kt</a></td><td> | </td><td class="num">135</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h7">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/Section.kt</a></td><td> | </td><td class="num">16</td><td><span class="i">++++++</span><span class="d">----------</span></td></tr>
<tr><td class="A">A</td><td><a href="#h8">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/TasksSection.kt</a></td><td> | </td><td class="num">232</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="D">D</td><td><a href="#h9">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/downloads/DownloadsSection.kt</a></td><td> | </td><td class="num">269</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="A">A</td><td><a href="#h10">app/src/main/kotlin/me/rhunk/snapenhance/ui/util/LifecycleHelper.kt</a></td><td> | </td><td class="num">29</td><td><span class="i">+++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h11">common/src/main/assets/lang/en_US.json</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h12">common/src/main/kotlin/me/rhunk/snapenhance/common/util/snap/RemoteMediaResolver.kt</a></td><td> | </td><td class="num">5</td><td><span class="i">+++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h13">core/src/main/kotlin/me/rhunk/snapenhance/core/messaging/MessageExporter.kt</a></td><td> | </td><td class="num">4</td><td><span class="i">++</span><span class="d">--</span></td></tr>
</table></pre><pre>14 files changed, 647 insertions(+), 590 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/RemoteSideContext.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/RemoteSideContext.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/RemoteSideContext.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/RemoteSideContext.kt</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -24,11 +24,11 @@ import me.rhunk.snapenhance.common.BuildConfig
</a> import me.rhunk.snapenhance.common.bridge.wrapper.LocaleWrapper
 import me.rhunk.snapenhance.common.bridge.wrapper.MappingsWrapper
 import me.rhunk.snapenhance.common.config.ModConfig
<a href="#h0-0-3" id="h0-0-3" class="d">-import me.rhunk.snapenhance.download.DownloadTaskManager
</a> import me.rhunk.snapenhance.e2ee.E2EEImplementation
 import me.rhunk.snapenhance.messaging.ModDatabase
 import me.rhunk.snapenhance.messaging.StreaksReminder
 import me.rhunk.snapenhance.scripting.RemoteScriptManager
<a href="#h0-0-8" id="h0-0-8" class="i">+import me.rhunk.snapenhance.task.TaskManager
</a> import me.rhunk.snapenhance.ui.manager.MainActivity
 import me.rhunk.snapenhance.ui.manager.data.InstallationSummary
 import me.rhunk.snapenhance.ui.manager.data.ModInfo
<a href="#h0-1" id="h0-1" class="h">@@ -60,7 +60,7 @@ class RemoteSideContext(
</a>     val config = ModConfig(androidContext)
     val translation = LocaleWrapper()
     val mappings = MappingsWrapper()
<a href="#h0-1-3" id="h0-1-3" class="d">-    val downloadTaskManager = DownloadTaskManager()
</a><a href="#h0-1-4" id="h0-1-4" class="i">+    val taskManager = TaskManager(this)
</a>     val modDatabase = ModDatabase(this)
     val streaksReminder = StreaksReminder(this)
     val log = LogManager(this)
<a href="#h0-2" id="h0-2" class="h">@@ -100,7 +100,7 @@ class RemoteSideContext(
</a>                 loadFromContext(androidContext)
                 init(androidContext)
             }
<a href="#h0-2-3" id="h0-2-3" class="d">-            downloadTaskManager.init(androidContext)
</a><a href="#h0-2-4" id="h0-2-4" class="i">+            taskManager.init()
</a>             modDatabase.init()
             streaksReminder.init()
             scriptManager.init()
<b>diff --git a/<a id="h1" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadObject.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadObject.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadObject.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadObject.kt</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -1,34 +0,0 @@
</a><a href="#h1-0-0" id="h1-0-0" class="d">-package me.rhunk.snapenhance.download
</a><a href="#h1-0-1" id="h1-0-1" class="d">-
</a><a href="#h1-0-2" id="h1-0-2" class="d">-import kotlinx.coroutines.Job
</a><a href="#h1-0-3" id="h1-0-3" class="d">-import me.rhunk.snapenhance.common.data.download.DownloadMetadata
</a><a href="#h1-0-4" id="h1-0-4" class="d">-import me.rhunk.snapenhance.common.data.download.DownloadStage
</a><a href="#h1-0-5" id="h1-0-5" class="d">-
</a><a href="#h1-0-6" id="h1-0-6" class="d">-data class DownloadObject(
</a><a href="#h1-0-7" id="h1-0-7" class="d">-    var downloadId: Int = 0,
</a><a href="#h1-0-8" id="h1-0-8" class="d">-    var outputFile: String? = null,
</a><a href="#h1-0-9" id="h1-0-9" class="d">-    val metadata : DownloadMetadata
</a><a href="#h1-0-10" id="h1-0-10" class="d">-) {
</a><a href="#h1-0-11" id="h1-0-11" class="d">-    var job: Job? = null
</a><a href="#h1-0-12" id="h1-0-12" class="d">-
</a><a href="#h1-0-13" id="h1-0-13" class="d">-    var changeListener = { _: DownloadStage, _: DownloadStage -&gt; }
</a><a href="#h1-0-14" id="h1-0-14" class="d">-    lateinit var updateTaskCallback: (DownloadObject) -&gt; Unit
</a><a href="#h1-0-15" id="h1-0-15" class="d">-
</a><a href="#h1-0-16" id="h1-0-16" class="d">-    private var _stage: DownloadStage = DownloadStage.PENDING
</a><a href="#h1-0-17" id="h1-0-17" class="d">-    var downloadStage: DownloadStage
</a><a href="#h1-0-18" id="h1-0-18" class="d">-        get() = synchronized(this) {
</a><a href="#h1-0-19" id="h1-0-19" class="d">-            _stage
</a><a href="#h1-0-20" id="h1-0-20" class="d">-        }
</a><a href="#h1-0-21" id="h1-0-21" class="d">-        set(value) = synchronized(this) {
</a><a href="#h1-0-22" id="h1-0-22" class="d">-            changeListener(_stage, value)
</a><a href="#h1-0-23" id="h1-0-23" class="d">-            _stage = value
</a><a href="#h1-0-24" id="h1-0-24" class="d">-            updateTaskCallback(this)
</a><a href="#h1-0-25" id="h1-0-25" class="d">-        }
</a><a href="#h1-0-26" id="h1-0-26" class="d">-
</a><a href="#h1-0-27" id="h1-0-27" class="d">-    fun isJobActive() = job?.isActive == true
</a><a href="#h1-0-28" id="h1-0-28" class="d">-
</a><a href="#h1-0-29" id="h1-0-29" class="d">-    fun cancel() {
</a><a href="#h1-0-30" id="h1-0-30" class="d">-        downloadStage = DownloadStage.CANCELLED
</a><a href="#h1-0-31" id="h1-0-31" class="d">-        job?.cancel()
</a><a href="#h1-0-32" id="h1-0-32" class="d">-    }
</a><a href="#h1-0-33" id="h1-0-33" class="d">-}
</a><b>diff --git a/<a id="h2" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadProcessor.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadProcessor.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadProcessor.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadProcessor.kt</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -18,14 +18,24 @@ import me.rhunk.snapenhance.bridge.DownloadCallback
</a> import me.rhunk.snapenhance.common.Constants
 import me.rhunk.snapenhance.common.ReceiversConfig
 import me.rhunk.snapenhance.common.data.FileType
<a href="#h2-0-3" id="h2-0-3" class="d">-import me.rhunk.snapenhance.common.data.download.*
</a><a href="#h2-0-4" id="h2-0-4" class="i">+import me.rhunk.snapenhance.common.data.download.DownloadMediaType
</a><a href="#h2-0-5" id="h2-0-5" class="i">+import me.rhunk.snapenhance.common.data.download.DownloadMetadata
</a><a href="#h2-0-6" id="h2-0-6" class="i">+import me.rhunk.snapenhance.common.data.download.DownloadRequest
</a><a href="#h2-0-7" id="h2-0-7" class="i">+import me.rhunk.snapenhance.common.data.download.InputMedia
</a><a href="#h2-0-8" id="h2-0-8" class="i">+import me.rhunk.snapenhance.common.data.download.SplitMediaAssetType
</a> import me.rhunk.snapenhance.common.util.snap.MediaDownloaderHelper
 import me.rhunk.snapenhance.common.util.snap.RemoteMediaResolver
<a href="#h2-0-11" id="h2-0-11" class="i">+import me.rhunk.snapenhance.task.PendingTask
</a><a href="#h2-0-12" id="h2-0-12" class="i">+import me.rhunk.snapenhance.task.PendingTaskListener
</a><a href="#h2-0-13" id="h2-0-13" class="i">+import me.rhunk.snapenhance.task.Task
</a><a href="#h2-0-14" id="h2-0-14" class="i">+import me.rhunk.snapenhance.task.TaskStatus
</a><a href="#h2-0-15" id="h2-0-15" class="i">+import me.rhunk.snapenhance.task.TaskType
</a> import java.io.File
 import java.io.InputStream
 import java.net.HttpURLConnection
 import java.net.URL
<a href="#h2-0-20" id="h2-0-20" class="d">-import java.util.zip.ZipInputStream
</a><a href="#h2-0-21" id="h2-0-21" class="i">+import java.util.UUID
</a><a href="#h2-0-22" id="h2-0-22" class="i">+import java.util.concurrent.ConcurrentHashMap
</a> import javax.xml.parsers.DocumentBuilderFactory
 import javax.xml.transform.TransformerFactory
 import javax.xml.transform.dom.DOMSource
<a href="#h2-1" id="h2-1" class="h">@@ -33,6 +43,7 @@ import javax.xml.transform.stream.StreamResult
</a> import kotlin.coroutines.coroutineContext
 import kotlin.io.encoding.Base64
 import kotlin.io.encoding.ExperimentalEncodingApi
<a href="#h2-1-3" id="h2-1-3" class="i">+import kotlin.math.absoluteValue
</a> 
 data class DownloadedFile(
     val file: File,
<a href="#h2-2" id="h2-2" class="h">@@ -52,12 +63,6 @@ class DownloadProcessor (
</a>         remoteSideContext.translation.getCategory(&quot;download_processor&quot;)
     }
 
<a href="#h2-2-3" id="h2-2-3" class="d">-    private val ffmpegProcessor by lazy {
</a><a href="#h2-2-4" id="h2-2-4" class="d">-        FFMpegProcessor(
</a><a href="#h2-2-5" id="h2-2-5" class="d">-            remoteSideContext.log,
</a><a href="#h2-2-6" id="h2-2-6" class="d">-            remoteSideContext.config.root.downloader.ffmpegOptions
</a><a href="#h2-2-7" id="h2-2-7" class="d">-        )
</a><a href="#h2-2-8" id="h2-2-8" class="d">-    }
</a>     private val gson by lazy { GsonBuilder().setPrettyPrinting().create() }
 
     private fun fallbackToast(message: Any) {
<a href="#h2-3" id="h2-3" class="h">@@ -84,26 +89,16 @@ class DownloadProcessor (
</a>         fallbackToast(it)
     }
 
<a href="#h2-3-3" id="h2-3-3" class="d">-    private fun extractZip(inputStream: InputStream): List&lt;File&gt; {
</a><a href="#h2-3-4" id="h2-3-4" class="d">-        val files = mutableListOf&lt;File&gt;()
</a><a href="#h2-3-5" id="h2-3-5" class="d">-        val zipInputStream = ZipInputStream(inputStream)
</a><a href="#h2-3-6" id="h2-3-6" class="d">-        var entry = zipInputStream.nextEntry
</a><a href="#h2-3-7" id="h2-3-7" class="d">-
</a><a href="#h2-3-8" id="h2-3-8" class="d">-        while (entry != null) {
</a><a href="#h2-3-9" id="h2-3-9" class="d">-            createMediaTempFile().also { file -&gt;
</a><a href="#h2-3-10" id="h2-3-10" class="d">-                file.outputStream().use { outputStream -&gt;
</a><a href="#h2-3-11" id="h2-3-11" class="d">-                    zipInputStream.copyTo(outputStream)
</a><a href="#h2-3-12" id="h2-3-12" class="d">-                }
</a><a href="#h2-3-13" id="h2-3-13" class="d">-                files += file
</a><a href="#h2-3-14" id="h2-3-14" class="d">-            }
</a><a href="#h2-3-15" id="h2-3-15" class="d">-            entry = zipInputStream.nextEntry
</a><a href="#h2-3-16" id="h2-3-16" class="i">+    private fun newFFMpegProcessor(pendingTask: PendingTask) = FFMpegProcessor(
</a><a href="#h2-3-17" id="h2-3-17" class="i">+        logManager = remoteSideContext.log,
</a><a href="#h2-3-18" id="h2-3-18" class="i">+        ffmpegOptions = remoteSideContext.config.root.downloader.ffmpegOptions,
</a><a href="#h2-3-19" id="h2-3-19" class="i">+        onStatistics = {
</a><a href="#h2-3-20" id="h2-3-20" class="i">+            pendingTask.updateProgress(&quot;Processing (frames=${it.videoFrameNumber}, fps=${it.videoFps}, time=${it.time}, bitrate=${it.bitrate}, speed=${it.speed})&quot;)
</a>         }
<a href="#h2-3-22" id="h2-3-22" class="d">-
</a><a href="#h2-3-23" id="h2-3-23" class="d">-        return files
</a><a href="#h2-3-24" id="h2-3-24" class="d">-    }
</a><a href="#h2-3-25" id="h2-3-25" class="i">+    )
</a> 
     @SuppressLint(&quot;UnspecifiedRegisterReceiverFlag&quot;)
<a href="#h2-3-28" id="h2-3-28" class="d">-    private suspend fun saveMediaToGallery(inputFile: File, downloadObject: DownloadObject) {
</a><a href="#h2-3-29" id="h2-3-29" class="i">+    private suspend fun saveMediaToGallery(pendingTask: PendingTask, inputFile: File, metadata: DownloadMetadata) {
</a>         if (coroutineContext.job.isCancelled) return
 
         runCatching {
<a href="#h2-4" id="h2-4" class="h">@@ -111,6 +106,7 @@ class DownloadProcessor (
</a> 
             if (fileType == FileType.UNKNOWN) {
                 callbackOnFailure(translation.format(&quot;failed_gallery_toast&quot;, &quot;error&quot; to &quot;Unknown media type&quot;), null)
<a href="#h2-4-3" id="h2-4-3" class="i">+                pendingTask.fail(&quot;Unknown media type&quot;)
</a>                 return
             }
 
<a href="#h2-5" id="h2-5" class="h">@@ -124,6 +120,7 @@ class DownloadProcessor (
</a>                         else -&gt; throw Exception(&quot;Invalid image format&quot;)
                     }
 
<a href="#h2-5-3" id="h2-5-3" class="i">+                    pendingTask.updateProgress(&quot;Converting image to $format&quot;)
</a>                     val outputStream = inputFile.outputStream()
                     bitmap.compress(compressFormat, 100, outputStream)
                     outputStream.close()
<a href="#h2-6" id="h2-6" class="h">@@ -132,12 +129,12 @@ class DownloadProcessor (
</a>                 }
             }
 
<a href="#h2-6-3" id="h2-6-3" class="d">-            val fileName = downloadObject.metadata.outputPath.substringAfterLast(&quot;/&quot;) + &quot;.&quot; + fileType.fileExtension
</a><a href="#h2-6-4" id="h2-6-4" class="i">+            val fileName = metadata.outputPath.substringAfterLast(&quot;/&quot;) + &quot;.&quot; + fileType.fileExtension
</a> 
             val outputFolder = DocumentFile.fromTreeUri(remoteSideContext.androidContext, Uri.parse(remoteSideContext.config.root.downloader.saveFolder.get()))
                 ?: throw Exception(&quot;Failed to open output folder&quot;)
 
<a href="#h2-6-9" id="h2-6-9" class="d">-            val outputFileFolder = downloadObject.metadata.outputPath.let {
</a><a href="#h2-6-10" id="h2-6-10" class="i">+            val outputFileFolder = metadata.outputPath.let {
</a>                 if (it.contains(&quot;/&quot;)) {
                     it.substringBeforeLast(&quot;/&quot;).split(&quot;/&quot;).fold(outputFolder) { folder, name -&gt;
                         folder.findFile(name) ?: folder.createDirectory(name)!!
<a href="#h2-7" id="h2-7" class="h">@@ -150,12 +147,13 @@ class DownloadProcessor (
</a>             val outputFile = outputFileFolder.createFile(fileType.mimeType, fileName)!!
             val outputStream = remoteSideContext.androidContext.contentResolver.openOutputStream(outputFile.uri)!!
 
<a href="#h2-7-3" id="h2-7-3" class="i">+            pendingTask.updateProgress(&quot;Saving media to gallery&quot;)
</a>             inputFile.inputStream().use { inputStream -&gt;
                 inputStream.copyTo(outputStream)
             }
 
<a href="#h2-7-8" id="h2-7-8" class="d">-            downloadObject.outputFile = outputFile.uri.toString()
</a><a href="#h2-7-9" id="h2-7-9" class="d">-            downloadObject.downloadStage = DownloadStage.SAVED
</a><a href="#h2-7-10" id="h2-7-10" class="i">+            pendingTask.task.extra = outputFile.uri.toString()
</a><a href="#h2-7-11" id="h2-7-11" class="i">+            pendingTask.success()
</a> 
             runCatching {
                 val mediaScanIntent = Intent(&quot;android.intent.action.MEDIA_SCANNER_SCAN_FILE&quot;)
<a href="#h2-8" id="h2-8" class="h">@@ -171,7 +169,7 @@ class DownloadProcessor (
</a>         }.onFailure { exception -&gt;
             remoteSideContext.log.error(&quot;Failed to save media to gallery&quot;, exception)
             callbackOnFailure(translation.format(&quot;failed_gallery_toast&quot;, &quot;error&quot; to exception.toString()), exception.message)
<a href="#h2-8-3" id="h2-8-3" class="d">-            downloadObject.downloadStage = DownloadStage.FAILED
</a><a href="#h2-8-4" id="h2-8-4" class="i">+            pendingTask.fail(&quot;Failed to save media to gallery&quot;)
</a>         }
     }
 
<a href="#h2-9" id="h2-9" class="h">@@ -179,38 +177,65 @@ class DownloadProcessor (
</a>         return File.createTempFile(&quot;media&quot;, &quot;.tmp&quot;)
     }
 
<a href="#h2-9-3" id="h2-9-3" class="d">-    private fun downloadInputMedias(downloadRequest: DownloadRequest) = runBlocking {
</a><a href="#h2-9-4" id="h2-9-4" class="i">+    private fun downloadInputMedias(pendingTask: PendingTask, downloadRequest: DownloadRequest) = runBlocking {
</a>         val jobs = mutableListOf&lt;Job&gt;()
         val downloadedMedias = mutableMapOf&lt;InputMedia, File&gt;()
<a href="#h2-9-7" id="h2-9-7" class="i">+        val inputMediaProgress = ConcurrentHashMap&lt;InputMedia, String&gt;()
</a><a href="#h2-9-8" id="h2-9-8" class="i">+
</a><a href="#h2-9-9" id="h2-9-9" class="i">+        fun updateDownloadProgress() {
</a><a href="#h2-9-10" id="h2-9-10" class="i">+            pendingTask.updateProgress(
</a><a href="#h2-9-11" id="h2-9-11" class="i">+                inputMediaProgress.values.joinToString(&quot;\n&quot;),
</a><a href="#h2-9-12" id="h2-9-12" class="i">+                progress = (jobs.filter { it.isActive }.size.toDouble() / jobs.size.toDouble() * 100.0).toInt()
</a><a href="#h2-9-13" id="h2-9-13" class="i">+            )
</a><a href="#h2-9-14" id="h2-9-14" class="i">+        }
</a> 
         downloadRequest.inputMedias.forEach { inputMedia -&gt;
<a href="#h2-9-17" id="h2-9-17" class="d">-            fun handleInputStream(inputStream: InputStream) {
</a><a href="#h2-9-18" id="h2-9-18" class="i">+            fun setProgress(progress: String) {
</a><a href="#h2-9-19" id="h2-9-19" class="i">+                inputMediaProgress[inputMedia] = progress
</a><a href="#h2-9-20" id="h2-9-20" class="i">+                updateDownloadProgress()
</a><a href="#h2-9-21" id="h2-9-21" class="i">+            }
</a><a href="#h2-9-22" id="h2-9-22" class="i">+
</a><a href="#h2-9-23" id="h2-9-23" class="i">+            fun handleInputStream(inputStream: InputStream, estimatedSize: Long = 0L) {
</a>                 createMediaTempFile().apply {
<a href="#h2-9-25" id="h2-9-25" class="d">-                    (inputMedia.encryption?.decryptInputStream(inputStream) ?: inputStream).copyTo(outputStream())
</a><a href="#h2-9-26" id="h2-9-26" class="i">+                    val decryptedInputStream = (inputMedia.encryption?.decryptInputStream(inputStream) ?: inputStream).buffered()
</a><a href="#h2-9-27" id="h2-9-27" class="i">+                    val outputStream = outputStream()
</a><a href="#h2-9-28" id="h2-9-28" class="i">+                    val buffer = ByteArray(DEFAULT_BUFFER_SIZE)
</a><a href="#h2-9-29" id="h2-9-29" class="i">+                    var read: Int
</a><a href="#h2-9-30" id="h2-9-30" class="i">+                    var totalRead = 0L
</a><a href="#h2-9-31" id="h2-9-31" class="i">+                    var lastTotalRead = 0L
</a><a href="#h2-9-32" id="h2-9-32" class="i">+
</a><a href="#h2-9-33" id="h2-9-33" class="i">+                    while (decryptedInputStream.read(buffer).also { read = it } != -1) {
</a><a href="#h2-9-34" id="h2-9-34" class="i">+                        outputStream.write(buffer, 0, read)
</a><a href="#h2-9-35" id="h2-9-35" class="i">+                        totalRead += read
</a><a href="#h2-9-36" id="h2-9-36" class="i">+                        if (totalRead - lastTotalRead &gt; 1024 * 1024) {
</a><a href="#h2-9-37" id="h2-9-37" class="i">+                            setProgress(&quot;${totalRead / 1024}KB/${estimatedSize / 1024}KB&quot;)
</a><a href="#h2-9-38" id="h2-9-38" class="i">+                            lastTotalRead = totalRead
</a><a href="#h2-9-39" id="h2-9-39" class="i">+                        }
</a><a href="#h2-9-40" id="h2-9-40" class="i">+                    }
</a>                 }.also { downloadedMedias[inputMedia] = it }
             }
 
             launch {
                 when (inputMedia.type) {
                     DownloadMediaType.PROTO_MEDIA -&gt; {
<a href="#h2-9-47" id="h2-9-47" class="d">-                        RemoteMediaResolver.downloadBoltMedia(Base64.UrlSafe.decode(inputMedia.content), decryptionCallback = { it }, resultCallback = {
</a><a href="#h2-9-48" id="h2-9-48" class="d">-                            handleInputStream(it)
</a><a href="#h2-9-49" id="h2-9-49" class="i">+                        RemoteMediaResolver.downloadBoltMedia(Base64.UrlSafe.decode(inputMedia.content), decryptionCallback = { it }, resultCallback = { inputStream, length -&gt;
</a><a href="#h2-9-50" id="h2-9-50" class="i">+                            handleInputStream(inputStream, estimatedSize = length)
</a>                         })
                     }
<a href="#h2-9-53" id="h2-9-53" class="d">-                    DownloadMediaType.DIRECT_MEDIA -&gt; {
</a><a href="#h2-9-54" id="h2-9-54" class="d">-                        val decoded = Base64.UrlSafe.decode(inputMedia.content)
</a><a href="#h2-9-55" id="h2-9-55" class="d">-                        createMediaTempFile().apply {
</a><a href="#h2-9-56" id="h2-9-56" class="d">-                            writeBytes(decoded)
</a><a href="#h2-9-57" id="h2-9-57" class="d">-                        }.also { downloadedMedias[inputMedia] = it }
</a><a href="#h2-9-58" id="h2-9-58" class="d">-                    }
</a>                     DownloadMediaType.REMOTE_MEDIA -&gt; {
                         with(URL(inputMedia.content).openConnection() as HttpURLConnection) {
                             requestMethod = &quot;GET&quot;
                             setRequestProperty(&quot;User-Agent&quot;, Constants.USER_AGENT)
                             connect()
<a href="#h2-9-64" id="h2-9-64" class="d">-                            handleInputStream(inputStream)
</a><a href="#h2-9-65" id="h2-9-65" class="i">+                            handleInputStream(inputStream, estimatedSize = contentLength.toLong())
</a>                         }
                     }
<a href="#h2-9-68" id="h2-9-68" class="i">+                    DownloadMediaType.DIRECT_MEDIA -&gt; {
</a><a href="#h2-9-69" id="h2-9-69" class="i">+                        val decoded = Base64.UrlSafe.decode(inputMedia.content)
</a><a href="#h2-9-70" id="h2-9-70" class="i">+                        createMediaTempFile().apply {
</a><a href="#h2-9-71" id="h2-9-71" class="i">+                            writeBytes(decoded)
</a><a href="#h2-9-72" id="h2-9-72" class="i">+                        }.also { downloadedMedias[inputMedia] = it }
</a><a href="#h2-9-73" id="h2-9-73" class="i">+                    }
</a>                     else -&gt; {
                         downloadedMedias[inputMedia] = File(inputMedia.content)
                     }
<a href="#h2-10" id="h2-10" class="h">@@ -222,7 +247,7 @@ class DownloadProcessor (
</a>         downloadedMedias
     }
 
<a href="#h2-10-3" id="h2-10-3" class="d">-    private suspend fun downloadRemoteMedia(downloadObjectObject: DownloadObject, downloadedMedias: Map&lt;InputMedia, DownloadedFile&gt;, downloadRequest: DownloadRequest) {
</a><a href="#h2-10-4" id="h2-10-4" class="i">+    private suspend fun downloadRemoteMedia(pendingTask: PendingTask, metadata: DownloadMetadata, downloadedMedias: Map&lt;InputMedia, DownloadedFile&gt;, downloadRequest: DownloadRequest) {
</a>         downloadRequest.inputMedias.first().let { inputMedia -&gt;
             val mediaType = inputMedia.type
             val media = downloadedMedias[inputMedia]!!
<a href="#h2-11" id="h2-11" class="h">@@ -231,19 +256,19 @@ class DownloadProcessor (
</a>                 if (inputMedia.attachmentType == &quot;NOTE&quot;) {
                     remoteSideContext.config.root.downloader.forceVoiceNoteFormat.getNullable()?.let { format -&gt;
                         val outputFile = File.createTempFile(&quot;voice_note&quot;, &quot;.$format&quot;)
<a href="#h2-11-3" id="h2-11-3" class="d">-                        ffmpegProcessor.execute(FFMpegProcessor.Request(
</a><a href="#h2-11-4" id="h2-11-4" class="i">+                        newFFMpegProcessor(pendingTask).execute(FFMpegProcessor.Request(
</a>                             action = FFMpegProcessor.Action.AUDIO_CONVERSION,
                             input = media.file,
                             output = outputFile
                         ))
                         media.file.delete()
<a href="#h2-11-10" id="h2-11-10" class="d">-                        saveMediaToGallery(outputFile, downloadObjectObject)
</a><a href="#h2-11-11" id="h2-11-11" class="i">+                        saveMediaToGallery(pendingTask, outputFile, metadata)
</a>                         outputFile.delete()
                         return
                     }
                 }
 
<a href="#h2-11-17" id="h2-11-17" class="d">-                saveMediaToGallery(media.file, downloadObjectObject)
</a><a href="#h2-11-18" id="h2-11-18" class="i">+                saveMediaToGallery(pendingTask, media.file, metadata)
</a>                 media.file.delete()
                 return
             }
<a href="#h2-12" id="h2-12" class="h">@@ -267,19 +292,19 @@ class DownloadProcessor (
</a>             callbackOnProgress(translation.format(&quot;download_toast&quot;, &quot;path&quot; to dashPlaylistFile.nameWithoutExtension))
             val outputFile = File.createTempFile(&quot;dash&quot;, &quot;.mp4&quot;)
             runCatching {
<a href="#h2-12-3" id="h2-12-3" class="d">-                ffmpegProcessor.execute(FFMpegProcessor.Request(
</a><a href="#h2-12-4" id="h2-12-4" class="i">+                newFFMpegProcessor(pendingTask).execute(FFMpegProcessor.Request(
</a>                     action = FFMpegProcessor.Action.DOWNLOAD_DASH,
                     input = dashPlaylistFile,
                     output = outputFile,
                     startTime = dashOptions.offsetTime,
                     duration = dashOptions.duration
                 ))
<a href="#h2-12-11" id="h2-12-11" class="d">-                saveMediaToGallery(outputFile, downloadObjectObject)
</a><a href="#h2-12-12" id="h2-12-12" class="i">+                saveMediaToGallery(pendingTask, outputFile, metadata)
</a>             }.onFailure { exception -&gt;
                 if (coroutineContext.job.isCancelled) return@onFailure
                 remoteSideContext.log.error(&quot;Failed to download dash media&quot;, exception)
                 callbackOnFailure(translation.format(&quot;failed_processing_toast&quot;, &quot;error&quot; to exception.toString()), exception.message)
<a href="#h2-12-17" id="h2-12-17" class="d">-                downloadObjectObject.downloadStage = DownloadStage.FAILED
</a><a href="#h2-12-18" id="h2-12-18" class="i">+                pendingTask.fail(&quot;Failed to download dash media&quot;)
</a>             }
 
             dashPlaylistFile.delete()
<a href="#h2-13" id="h2-13" class="h">@@ -299,35 +324,35 @@ class DownloadProcessor (
</a>             val downloadMetadata = gson.fromJson(intent.getStringExtra(ReceiversConfig.DOWNLOAD_METADATA_EXTRA)!!, DownloadMetadata::class.java)
             val downloadRequest = gson.fromJson(intent.getStringExtra(ReceiversConfig.DOWNLOAD_REQUEST_EXTRA)!!, DownloadRequest::class.java)
 
<a href="#h2-13-3" id="h2-13-3" class="d">-            remoteSideContext.downloadTaskManager.canDownloadMedia(downloadMetadata.mediaIdentifier)?.let { downloadStage -&gt;
</a><a href="#h2-13-4" id="h2-13-4" class="d">-                translation[if (downloadStage.isFinalStage) {
</a><a href="#h2-13-5" id="h2-13-5" class="d">-                    &quot;already_downloaded_toast&quot;
</a><a href="#h2-13-6" id="h2-13-6" class="i">+            remoteSideContext.taskManager.getTaskByHash(downloadMetadata.mediaIdentifier)?.let { task -&gt;
</a><a href="#h2-13-7" id="h2-13-7" class="i">+                remoteSideContext.log.debug(&quot;already queued or downloaded&quot;)
</a><a href="#h2-13-8" id="h2-13-8" class="i">+
</a><a href="#h2-13-9" id="h2-13-9" class="i">+                if (task.status.isFinalStage()) {
</a><a href="#h2-13-10" id="h2-13-10" class="i">+                    callbackOnFailure(translation[&quot;already_downloaded_toast&quot;], null)
</a>                 } else {
<a href="#h2-13-12" id="h2-13-12" class="d">-                    &quot;already_queued_toast&quot;
</a><a href="#h2-13-13" id="h2-13-13" class="d">-                }].let {
</a><a href="#h2-13-14" id="h2-13-14" class="d">-                    callbackOnFailure(it, null)
</a><a href="#h2-13-15" id="h2-13-15" class="i">+                    callbackOnFailure(translation[&quot;already_queued_toast&quot;], null)
</a>                 }
                 return@launch
             }
 
<a href="#h2-13-20" id="h2-13-20" class="d">-            val downloadObjectObject = DownloadObject(
</a><a href="#h2-13-21" id="h2-13-21" class="d">-                metadata = downloadMetadata
</a><a href="#h2-13-22" id="h2-13-22" class="i">+            remoteSideContext.log.debug(&quot;downloading media&quot;)
</a><a href="#h2-13-23" id="h2-13-23" class="i">+            val pendingTask = remoteSideContext.taskManager.createPendingTask(
</a><a href="#h2-13-24" id="h2-13-24" class="i">+                Task(
</a><a href="#h2-13-25" id="h2-13-25" class="i">+                    type = TaskType.DOWNLOAD,
</a><a href="#h2-13-26" id="h2-13-26" class="i">+                    title = downloadMetadata.downloadSource + &quot; (&quot; + downloadMetadata.mediaAuthor + &quot;)&quot;,
</a><a href="#h2-13-27" id="h2-13-27" class="i">+                    hash = (downloadMetadata.mediaIdentifier ?: UUID.randomUUID().toString()).hashCode().absoluteValue.toString(16)
</a><a href="#h2-13-28" id="h2-13-28" class="i">+                )
</a>             ).apply {
<a href="#h2-13-30" id="h2-13-30" class="d">-                updateTaskCallback = {
</a><a href="#h2-13-31" id="h2-13-31" class="d">-                    remoteSideContext.downloadTaskManager.updateTask(it)
</a><a href="#h2-13-32" id="h2-13-32" class="d">-                }
</a><a href="#h2-13-33" id="h2-13-33" class="d">-            }
</a><a href="#h2-13-34" id="h2-13-34" class="d">-
</a><a href="#h2-13-35" id="h2-13-35" class="d">-            downloadObjectObject.also {
</a><a href="#h2-13-36" id="h2-13-36" class="d">-                remoteSideContext.downloadTaskManager.addTask(it)
</a><a href="#h2-13-37" id="h2-13-37" class="d">-            }.apply {
</a><a href="#h2-13-38" id="h2-13-38" class="d">-                job = coroutineContext.job
</a><a href="#h2-13-39" id="h2-13-39" class="d">-                downloadStage = DownloadStage.DOWNLOADING
</a><a href="#h2-13-40" id="h2-13-40" class="i">+                status = TaskStatus.RUNNING
</a><a href="#h2-13-41" id="h2-13-41" class="i">+                addListener(PendingTaskListener(onCancel = {
</a><a href="#h2-13-42" id="h2-13-42" class="i">+                    coroutineContext.job.cancel()
</a><a href="#h2-13-43" id="h2-13-43" class="i">+                }))
</a><a href="#h2-13-44" id="h2-13-44" class="i">+                updateProgress(&quot;Downloading...&quot;)
</a>             }
 
             runCatching {
                 //first download all input medias into cache
<a href="#h2-13-49" id="h2-13-49" class="d">-                val downloadedMedias = downloadInputMedias(downloadRequest).map {
</a><a href="#h2-13-50" id="h2-13-50" class="i">+                val downloadedMedias = downloadInputMedias(pendingTask, downloadRequest).map {
</a>                     it.key to DownloadedFile(it.value, FileType.fromFile(it.value))
                 }.toMap().toMutableMap()
                 remoteSideContext.log.verbose(&quot;downloaded ${downloadedMedias.size} medias&quot;)
<a href="#h2-14" id="h2-14" class="h">@@ -369,21 +394,20 @@ class DownloadProcessor (
</a>                     val mergedOverlay: File = File.createTempFile(&quot;merged&quot;, &quot;.mp4&quot;)
                     runCatching {
                         callbackOnProgress(translation.format(&quot;processing_toast&quot;, &quot;path&quot; to media.file.nameWithoutExtension))
<a href="#h2-14-3" id="h2-14-3" class="d">-                        downloadObjectObject.downloadStage = DownloadStage.MERGING
</a> 
<a href="#h2-14-5" id="h2-14-5" class="d">-                        ffmpegProcessor.execute(FFMpegProcessor.Request(
</a><a href="#h2-14-6" id="h2-14-6" class="i">+                        newFFMpegProcessor(pendingTask).execute(FFMpegProcessor.Request(
</a>                             action = FFMpegProcessor.Action.MERGE_OVERLAY,
                             input = renamedMedia,
                             output = mergedOverlay,
                             overlay = renamedOverlayMedia
                         ))
 
<a href="#h2-14-13" id="h2-14-13" class="d">-                        saveMediaToGallery(mergedOverlay, downloadObjectObject)
</a><a href="#h2-14-14" id="h2-14-14" class="i">+                        saveMediaToGallery(pendingTask, mergedOverlay, downloadMetadata)
</a>                     }.onFailure { exception -&gt;
                         if (coroutineContext.job.isCancelled) return@onFailure
                         remoteSideContext.log.error(&quot;Failed to merge overlay&quot;, exception)
                         callbackOnFailure(translation.format(&quot;failed_processing_toast&quot;, &quot;error&quot; to exception.toString()), exception.message)
<a href="#h2-14-19" id="h2-14-19" class="d">-                        downloadObjectObject.downloadStage = DownloadStage.MERGE_FAILED
</a><a href="#h2-14-20" id="h2-14-20" class="i">+                        pendingTask.fail(&quot;Failed to merge overlay&quot;)
</a>                     }
 
                     mergedOverlay.delete()
<a href="#h2-15" id="h2-15" class="h">@@ -392,9 +416,9 @@ class DownloadProcessor (
</a>                     return@launch
                 }
 
<a href="#h2-15-3" id="h2-15-3" class="d">-                downloadRemoteMedia(downloadObjectObject, downloadedMedias, downloadRequest)
</a><a href="#h2-15-4" id="h2-15-4" class="i">+                downloadRemoteMedia(pendingTask, downloadMetadata, downloadedMedias, downloadRequest)
</a>             }.onFailure { exception -&gt;
<a href="#h2-15-6" id="h2-15-6" class="d">-                downloadObjectObject.downloadStage = DownloadStage.FAILED
</a><a href="#h2-15-7" id="h2-15-7" class="i">+                pendingTask.fail(&quot;Failed to download media&quot;)
</a>                 remoteSideContext.log.error(&quot;Failed to download media&quot;, exception)
                 callbackOnFailure(translation[&quot;failed_generic_toast&quot;], exception.message)
             }
<b>diff --git a/<a id="h3" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadTaskManager.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadTaskManager.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadTaskManager.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadTaskManager.kt</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -1,192 +0,0 @@
</a><a href="#h3-0-0" id="h3-0-0" class="d">-package me.rhunk.snapenhance.download
</a><a href="#h3-0-1" id="h3-0-1" class="d">-
</a><a href="#h3-0-2" id="h3-0-2" class="d">-import android.annotation.SuppressLint
</a><a href="#h3-0-3" id="h3-0-3" class="d">-import android.content.Context
</a><a href="#h3-0-4" id="h3-0-4" class="d">-import android.database.sqlite.SQLiteDatabase
</a><a href="#h3-0-5" id="h3-0-5" class="d">-import me.rhunk.snapenhance.common.data.download.DownloadMetadata
</a><a href="#h3-0-6" id="h3-0-6" class="d">-import me.rhunk.snapenhance.common.data.download.DownloadStage
</a><a href="#h3-0-7" id="h3-0-7" class="d">-import me.rhunk.snapenhance.common.data.download.MediaDownloadSource
</a><a href="#h3-0-8" id="h3-0-8" class="d">-import me.rhunk.snapenhance.common.util.SQLiteDatabaseHelper
</a><a href="#h3-0-9" id="h3-0-9" class="d">-import me.rhunk.snapenhance.common.util.ktx.getIntOrNull
</a><a href="#h3-0-10" id="h3-0-10" class="d">-import me.rhunk.snapenhance.common.util.ktx.getStringOrNull
</a><a href="#h3-0-11" id="h3-0-11" class="d">-import java.util.concurrent.Executors
</a><a href="#h3-0-12" id="h3-0-12" class="d">-
</a><a href="#h3-0-13" id="h3-0-13" class="d">-class DownloadTaskManager {
</a><a href="#h3-0-14" id="h3-0-14" class="d">-    private lateinit var taskDatabase: SQLiteDatabase
</a><a href="#h3-0-15" id="h3-0-15" class="d">-    private val pendingTasks = mutableMapOf&lt;Int, DownloadObject&gt;()
</a><a href="#h3-0-16" id="h3-0-16" class="d">-    private val cachedTasks = mutableMapOf&lt;Int, DownloadObject&gt;()
</a><a href="#h3-0-17" id="h3-0-17" class="d">-    private val executor = Executors.newSingleThreadExecutor()
</a><a href="#h3-0-18" id="h3-0-18" class="d">-
</a><a href="#h3-0-19" id="h3-0-19" class="d">-    @SuppressLint(&quot;Range&quot;)
</a><a href="#h3-0-20" id="h3-0-20" class="d">-    fun init(context: Context) {
</a><a href="#h3-0-21" id="h3-0-21" class="d">-        if (this::taskDatabase.isInitialized) return
</a><a href="#h3-0-22" id="h3-0-22" class="d">-        taskDatabase = context.openOrCreateDatabase(&quot;download_tasks&quot;, Context.MODE_PRIVATE, null).apply {
</a><a href="#h3-0-23" id="h3-0-23" class="d">-            SQLiteDatabaseHelper.createTablesFromSchema(this, mapOf(
</a><a href="#h3-0-24" id="h3-0-24" class="d">-                &quot;tasks&quot; to listOf(
</a><a href="#h3-0-25" id="h3-0-25" class="d">-                    &quot;id INTEGER PRIMARY KEY AUTOINCREMENT&quot;,
</a><a href="#h3-0-26" id="h3-0-26" class="d">-                    &quot;hash VARCHAR UNIQUE&quot;,
</a><a href="#h3-0-27" id="h3-0-27" class="d">-                    &quot;outputPath TEXT&quot;,
</a><a href="#h3-0-28" id="h3-0-28" class="d">-                    &quot;outputFile TEXT&quot;,
</a><a href="#h3-0-29" id="h3-0-29" class="d">-                    &quot;mediaAuthor TEXT&quot;,
</a><a href="#h3-0-30" id="h3-0-30" class="d">-                    &quot;downloadSource TEXT&quot;,
</a><a href="#h3-0-31" id="h3-0-31" class="d">-                    &quot;iconUrl TEXT&quot;,
</a><a href="#h3-0-32" id="h3-0-32" class="d">-                    &quot;downloadStage TEXT&quot;
</a><a href="#h3-0-33" id="h3-0-33" class="d">-                )
</a><a href="#h3-0-34" id="h3-0-34" class="d">-            ))
</a><a href="#h3-0-35" id="h3-0-35" class="d">-        }
</a><a href="#h3-0-36" id="h3-0-36" class="d">-    }
</a><a href="#h3-0-37" id="h3-0-37" class="d">-
</a><a href="#h3-0-38" id="h3-0-38" class="d">-    fun addTask(task: DownloadObject) {
</a><a href="#h3-0-39" id="h3-0-39" class="d">-        executor.execute {
</a><a href="#h3-0-40" id="h3-0-40" class="d">-            taskDatabase.execSQL(&quot;INSERT INTO tasks (hash, outputPath, outputFile, downloadSource, mediaAuthor, iconUrl, downloadStage) VALUES (?, ?, ?, ?, ?, ?, ?)&quot;,
</a><a href="#h3-0-41" id="h3-0-41" class="d">-                arrayOf(
</a><a href="#h3-0-42" id="h3-0-42" class="d">-                    task.metadata.mediaIdentifier,
</a><a href="#h3-0-43" id="h3-0-43" class="d">-                    task.metadata.outputPath,
</a><a href="#h3-0-44" id="h3-0-44" class="d">-                    task.outputFile,
</a><a href="#h3-0-45" id="h3-0-45" class="d">-                    task.metadata.downloadSource,
</a><a href="#h3-0-46" id="h3-0-46" class="d">-                    task.metadata.mediaAuthor,
</a><a href="#h3-0-47" id="h3-0-47" class="d">-                    task.metadata.iconUrl,
</a><a href="#h3-0-48" id="h3-0-48" class="d">-                    task.downloadStage.name
</a><a href="#h3-0-49" id="h3-0-49" class="d">-                )
</a><a href="#h3-0-50" id="h3-0-50" class="d">-            )
</a><a href="#h3-0-51" id="h3-0-51" class="d">-            task.downloadId = taskDatabase.rawQuery(&quot;SELECT last_insert_rowid()&quot;, null).use {
</a><a href="#h3-0-52" id="h3-0-52" class="d">-                it.moveToFirst()
</a><a href="#h3-0-53" id="h3-0-53" class="d">-                it.getInt(0)
</a><a href="#h3-0-54" id="h3-0-54" class="d">-            }
</a><a href="#h3-0-55" id="h3-0-55" class="d">-            pendingTasks[task.downloadId] = task
</a><a href="#h3-0-56" id="h3-0-56" class="d">-        }
</a><a href="#h3-0-57" id="h3-0-57" class="d">-    }
</a><a href="#h3-0-58" id="h3-0-58" class="d">-
</a><a href="#h3-0-59" id="h3-0-59" class="d">-    fun updateTask(task: DownloadObject) {
</a><a href="#h3-0-60" id="h3-0-60" class="d">-        executor.execute {
</a><a href="#h3-0-61" id="h3-0-61" class="d">-            taskDatabase.execSQL(
</a><a href="#h3-0-62" id="h3-0-62" class="d">-                &quot;UPDATE tasks SET hash = ?, outputPath = ?, outputFile = ?, downloadSource = ?, mediaAuthor = ?, iconUrl = ?, downloadStage = ? WHERE id = ?&quot;,
</a><a href="#h3-0-63" id="h3-0-63" class="d">-                arrayOf(
</a><a href="#h3-0-64" id="h3-0-64" class="d">-                    task.metadata.mediaIdentifier,
</a><a href="#h3-0-65" id="h3-0-65" class="d">-                    task.metadata.outputPath,
</a><a href="#h3-0-66" id="h3-0-66" class="d">-                    task.outputFile,
</a><a href="#h3-0-67" id="h3-0-67" class="d">-                    task.metadata.downloadSource,
</a><a href="#h3-0-68" id="h3-0-68" class="d">-                    task.metadata.mediaAuthor,
</a><a href="#h3-0-69" id="h3-0-69" class="d">-                    task.metadata.iconUrl,
</a><a href="#h3-0-70" id="h3-0-70" class="d">-                    task.downloadStage.name,
</a><a href="#h3-0-71" id="h3-0-71" class="d">-                    task.downloadId
</a><a href="#h3-0-72" id="h3-0-72" class="d">-                )
</a><a href="#h3-0-73" id="h3-0-73" class="d">-            )
</a><a href="#h3-0-74" id="h3-0-74" class="d">-        }
</a><a href="#h3-0-75" id="h3-0-75" class="d">-        //if the task is no longer active, move it to the cached tasks
</a><a href="#h3-0-76" id="h3-0-76" class="d">-        if (task.isJobActive()) {
</a><a href="#h3-0-77" id="h3-0-77" class="d">-            pendingTasks[task.downloadId] = task
</a><a href="#h3-0-78" id="h3-0-78" class="d">-        } else {
</a><a href="#h3-0-79" id="h3-0-79" class="d">-            pendingTasks.remove(task.downloadId)
</a><a href="#h3-0-80" id="h3-0-80" class="d">-            cachedTasks[task.downloadId] = task
</a><a href="#h3-0-81" id="h3-0-81" class="d">-        }
</a><a href="#h3-0-82" id="h3-0-82" class="d">-    }
</a><a href="#h3-0-83" id="h3-0-83" class="d">-
</a><a href="#h3-0-84" id="h3-0-84" class="d">-    @SuppressLint(&quot;Range&quot;)
</a><a href="#h3-0-85" id="h3-0-85" class="d">-    fun canDownloadMedia(mediaIdentifier: String?): DownloadStage? {
</a><a href="#h3-0-86" id="h3-0-86" class="d">-        if (mediaIdentifier == null) return null
</a><a href="#h3-0-87" id="h3-0-87" class="d">-
</a><a href="#h3-0-88" id="h3-0-88" class="d">-        val cursor = taskDatabase.rawQuery(&quot;SELECT * FROM tasks WHERE hash = ?&quot;, arrayOf(mediaIdentifier))
</a><a href="#h3-0-89" id="h3-0-89" class="d">-        if (cursor.count &gt; 0) {
</a><a href="#h3-0-90" id="h3-0-90" class="d">-            cursor.moveToFirst()
</a><a href="#h3-0-91" id="h3-0-91" class="d">-            val downloadStage = DownloadStage.valueOf(cursor.getString(cursor.getColumnIndex(&quot;downloadStage&quot;)))
</a><a href="#h3-0-92" id="h3-0-92" class="d">-            cursor.close()
</a><a href="#h3-0-93" id="h3-0-93" class="d">-
</a><a href="#h3-0-94" id="h3-0-94" class="d">-            //if the stage has reached a final stage and is not in a saved state, remove the task
</a><a href="#h3-0-95" id="h3-0-95" class="d">-            if (downloadStage.isFinalStage &amp;&amp; downloadStage != DownloadStage.SAVED) {
</a><a href="#h3-0-96" id="h3-0-96" class="d">-                taskDatabase.execSQL(&quot;DELETE FROM tasks WHERE hash = ?&quot;, arrayOf(mediaIdentifier))
</a><a href="#h3-0-97" id="h3-0-97" class="d">-                return null
</a><a href="#h3-0-98" id="h3-0-98" class="d">-            }
</a><a href="#h3-0-99" id="h3-0-99" class="d">-
</a><a href="#h3-0-100" id="h3-0-100" class="d">-            return downloadStage
</a><a href="#h3-0-101" id="h3-0-101" class="d">-        }
</a><a href="#h3-0-102" id="h3-0-102" class="d">-        cursor.close()
</a><a href="#h3-0-103" id="h3-0-103" class="d">-        return null
</a><a href="#h3-0-104" id="h3-0-104" class="d">-    }
</a><a href="#h3-0-105" id="h3-0-105" class="d">-
</a><a href="#h3-0-106" id="h3-0-106" class="d">-    fun isEmpty(): Boolean {
</a><a href="#h3-0-107" id="h3-0-107" class="d">-        return cachedTasks.isEmpty() &amp;&amp; pendingTasks.isEmpty()
</a><a href="#h3-0-108" id="h3-0-108" class="d">-    }
</a><a href="#h3-0-109" id="h3-0-109" class="d">-
</a><a href="#h3-0-110" id="h3-0-110" class="d">-    private fun removeTask(id: Int) {
</a><a href="#h3-0-111" id="h3-0-111" class="d">-        executor.execute {
</a><a href="#h3-0-112" id="h3-0-112" class="d">-            taskDatabase.execSQL(&quot;DELETE FROM tasks WHERE id = ?&quot;, arrayOf(id))
</a><a href="#h3-0-113" id="h3-0-113" class="d">-            cachedTasks.remove(id)
</a><a href="#h3-0-114" id="h3-0-114" class="d">-            pendingTasks.remove(id)
</a><a href="#h3-0-115" id="h3-0-115" class="d">-        }
</a><a href="#h3-0-116" id="h3-0-116" class="d">-    }
</a><a href="#h3-0-117" id="h3-0-117" class="d">-
</a><a href="#h3-0-118" id="h3-0-118" class="d">-    fun removeTask(task: DownloadObject) {
</a><a href="#h3-0-119" id="h3-0-119" class="d">-        removeTask(task.downloadId)
</a><a href="#h3-0-120" id="h3-0-120" class="d">-    }
</a><a href="#h3-0-121" id="h3-0-121" class="d">-
</a><a href="#h3-0-122" id="h3-0-122" class="d">-    fun queryFirstTasks(filter: MediaDownloadSource): Map&lt;Int, DownloadObject&gt; {
</a><a href="#h3-0-123" id="h3-0-123" class="d">-        val isPendingFilter = filter == MediaDownloadSource.PENDING
</a><a href="#h3-0-124" id="h3-0-124" class="d">-        val tasks = mutableMapOf&lt;Int, DownloadObject&gt;()
</a><a href="#h3-0-125" id="h3-0-125" class="d">-
</a><a href="#h3-0-126" id="h3-0-126" class="d">-        tasks.putAll(pendingTasks.filter { isPendingFilter || filter.matches(it.value.metadata.downloadSource) })
</a><a href="#h3-0-127" id="h3-0-127" class="d">-        if (isPendingFilter) {
</a><a href="#h3-0-128" id="h3-0-128" class="d">-            return tasks.toSortedMap(reverseOrder())
</a><a href="#h3-0-129" id="h3-0-129" class="d">-        }
</a><a href="#h3-0-130" id="h3-0-130" class="d">-
</a><a href="#h3-0-131" id="h3-0-131" class="d">-        tasks.putAll(queryTasks(
</a><a href="#h3-0-132" id="h3-0-132" class="d">-            from = tasks.values.lastOrNull()?.downloadId ?: Int.MAX_VALUE,
</a><a href="#h3-0-133" id="h3-0-133" class="d">-            amount = 30,
</a><a href="#h3-0-134" id="h3-0-134" class="d">-            filter = filter
</a><a href="#h3-0-135" id="h3-0-135" class="d">-        ))
</a><a href="#h3-0-136" id="h3-0-136" class="d">-
</a><a href="#h3-0-137" id="h3-0-137" class="d">-        return tasks.toSortedMap(reverseOrder())
</a><a href="#h3-0-138" id="h3-0-138" class="d">-    }
</a><a href="#h3-0-139" id="h3-0-139" class="d">-
</a><a href="#h3-0-140" id="h3-0-140" class="d">-    @SuppressLint(&quot;Range&quot;)
</a><a href="#h3-0-141" id="h3-0-141" class="d">-    fun queryTasks(from: Int, amount: Int = 30, filter: MediaDownloadSource = MediaDownloadSource.NONE): Map&lt;Int, DownloadObject&gt; {
</a><a href="#h3-0-142" id="h3-0-142" class="d">-        if (filter == MediaDownloadSource.PENDING) {
</a><a href="#h3-0-143" id="h3-0-143" class="d">-            return emptyMap()
</a><a href="#h3-0-144" id="h3-0-144" class="d">-        }
</a><a href="#h3-0-145" id="h3-0-145" class="d">-
</a><a href="#h3-0-146" id="h3-0-146" class="d">-        val cursor = taskDatabase.rawQuery(
</a><a href="#h3-0-147" id="h3-0-147" class="d">-            &quot;SELECT * FROM tasks WHERE id &lt; ? AND downloadSource LIKE ? ORDER BY id DESC LIMIT ?&quot;,
</a><a href="#h3-0-148" id="h3-0-148" class="d">-            arrayOf(
</a><a href="#h3-0-149" id="h3-0-149" class="d">-                from.toString(),
</a><a href="#h3-0-150" id="h3-0-150" class="d">-                if (filter.ignoreFilter) &quot;%&quot; else &quot;%${filter.key}&quot;,
</a><a href="#h3-0-151" id="h3-0-151" class="d">-                amount.toString()
</a><a href="#h3-0-152" id="h3-0-152" class="d">-            )
</a><a href="#h3-0-153" id="h3-0-153" class="d">-        )
</a><a href="#h3-0-154" id="h3-0-154" class="d">-
</a><a href="#h3-0-155" id="h3-0-155" class="d">-        val result = sortedMapOf&lt;Int, DownloadObject&gt;()
</a><a href="#h3-0-156" id="h3-0-156" class="d">-
</a><a href="#h3-0-157" id="h3-0-157" class="d">-        while (cursor.moveToNext()) {
</a><a href="#h3-0-158" id="h3-0-158" class="d">-            val task = DownloadObject(
</a><a href="#h3-0-159" id="h3-0-159" class="d">-                downloadId = cursor.getIntOrNull(&quot;id&quot;)!!,
</a><a href="#h3-0-160" id="h3-0-160" class="d">-                outputFile = cursor.getStringOrNull(&quot;outputFile&quot;),
</a><a href="#h3-0-161" id="h3-0-161" class="d">-                metadata = DownloadMetadata(
</a><a href="#h3-0-162" id="h3-0-162" class="d">-                    outputPath = cursor.getStringOrNull(&quot;outputPath&quot;)!!,
</a><a href="#h3-0-163" id="h3-0-163" class="d">-                    mediaIdentifier = cursor.getStringOrNull(&quot;hash&quot;),
</a><a href="#h3-0-164" id="h3-0-164" class="d">-                    downloadSource = cursor.getStringOrNull(&quot;downloadSource&quot;)
</a><a href="#h3-0-165" id="h3-0-165" class="d">-                        ?: MediaDownloadSource.NONE.key,
</a><a href="#h3-0-166" id="h3-0-166" class="d">-                    mediaAuthor = cursor.getStringOrNull(&quot;mediaAuthor&quot;),
</a><a href="#h3-0-167" id="h3-0-167" class="d">-                    iconUrl = cursor.getStringOrNull(&quot;iconUrl&quot;)
</a><a href="#h3-0-168" id="h3-0-168" class="d">-                )
</a><a href="#h3-0-169" id="h3-0-169" class="d">-            ).apply {
</a><a href="#h3-0-170" id="h3-0-170" class="d">-                updateTaskCallback = { updateTask(it) }
</a><a href="#h3-0-171" id="h3-0-171" class="d">-                downloadStage = DownloadStage.valueOf(cursor.getStringOrNull(&quot;downloadStage&quot;)!!)
</a><a href="#h3-0-172" id="h3-0-172" class="d">-                //if downloadStage is not saved, it means the app was killed before the download was finished
</a><a href="#h3-0-173" id="h3-0-173" class="d">-                if (downloadStage != DownloadStage.SAVED) {
</a><a href="#h3-0-174" id="h3-0-174" class="d">-                    downloadStage = DownloadStage.FAILED
</a><a href="#h3-0-175" id="h3-0-175" class="d">-                }
</a><a href="#h3-0-176" id="h3-0-176" class="d">-            }
</a><a href="#h3-0-177" id="h3-0-177" class="d">-            result[task.downloadId] = task
</a><a href="#h3-0-178" id="h3-0-178" class="d">-        }
</a><a href="#h3-0-179" id="h3-0-179" class="d">-        cursor.close()
</a><a href="#h3-0-180" id="h3-0-180" class="d">-
</a><a href="#h3-0-181" id="h3-0-181" class="d">-        return result.toSortedMap(reverseOrder())
</a><a href="#h3-0-182" id="h3-0-182" class="d">-    }
</a><a href="#h3-0-183" id="h3-0-183" class="d">-
</a><a href="#h3-0-184" id="h3-0-184" class="d">-    fun removeAllTasks() {
</a><a href="#h3-0-185" id="h3-0-185" class="d">-        executor.execute {
</a><a href="#h3-0-186" id="h3-0-186" class="d">-            taskDatabase.execSQL(&quot;DELETE FROM tasks&quot;)
</a><a href="#h3-0-187" id="h3-0-187" class="d">-            cachedTasks.clear()
</a><a href="#h3-0-188" id="h3-0-188" class="d">-            pendingTasks.clear()
</a><a href="#h3-0-189" id="h3-0-189" class="d">-        }
</a><a href="#h3-0-190" id="h3-0-190" class="d">-    }
</a><a href="#h3-0-191" id="h3-0-191" class="d">-}</a><a href="#h3-0-192" id="h3-0-192" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h4" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/download/FFMpegProcessor.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/download/FFMpegProcessor.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/download/FFMpegProcessor.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/download/FFMpegProcessor.kt</a></b>
<a href="#h4-0" id="h4-0" class="h">@@ -3,6 +3,7 @@ package me.rhunk.snapenhance.download
</a> import com.arthenica.ffmpegkit.FFmpegKit
 import com.arthenica.ffmpegkit.FFmpegSession
 import com.arthenica.ffmpegkit.Level
<a href="#h4-0-3" id="h4-0-3" class="i">+import com.arthenica.ffmpegkit.Statistics
</a> import kotlinx.coroutines.suspendCancellableCoroutine
 import me.rhunk.snapenhance.LogManager
 import me.rhunk.snapenhance.common.config.impl.DownloaderConfig
<a href="#h4-1" id="h4-1" class="h">@@ -35,7 +36,8 @@ class ArgumentList : LinkedHashMap&lt;String, MutableList&lt;String&gt;&gt;() {
</a> 
 class FFMpegProcessor(
     private val logManager: LogManager,
<a href="#h4-1-3" id="h4-1-3" class="d">-    private val ffmpegOptions: DownloaderConfig.FFMpegOptions
</a><a href="#h4-1-4" id="h4-1-4" class="i">+    private val ffmpegOptions: DownloaderConfig.FFMpegOptions,
</a><a href="#h4-1-5" id="h4-1-5" class="i">+    private val onStatistics: (Statistics) -&gt; Unit = {}
</a> ) {
     companion object {
         private const val TAG = &quot;ffmpeg-processor&quot;
<a href="#h4-2" id="h4-2" class="h">@@ -88,7 +90,7 @@ class FFMpegProcessor(
</a>                     Level.AV_LOG_VERBOSE -&gt; LogLevel.VERBOSE
                     else -&gt; return@logFunction
                 }, log.message)
<a href="#h4-2-3" id="h4-2-3" class="d">-            }, { logManager.verbose(it.toString(), &quot;ffmpeg-stats&quot;) }, Executors.newSingleThreadExecutor())
</a><a href="#h4-2-4" id="h4-2-4" class="i">+            }, { onStatistics(it) }, Executors.newSingleThreadExecutor())
</a>     }
 
     suspend fun execute(args: Request) {
<b>diff --git a/<a id="h5" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/task/PendingTask.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/task/PendingTask.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/task/PendingTask.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/task/PendingTask.kt</a></b>
<a href="#h5-0" id="h5-0" class="h">@@ -0,0 +1,133 @@
</a><a href="#h5-0-0" id="h5-0-0" class="i">+package me.rhunk.snapenhance.task
</a><a href="#h5-0-1" id="h5-0-1" class="i">+
</a><a href="#h5-0-2" id="h5-0-2" class="i">+
</a><a href="#h5-0-3" id="h5-0-3" class="i">+enum class TaskType(
</a><a href="#h5-0-4" id="h5-0-4" class="i">+    val key: String
</a><a href="#h5-0-5" id="h5-0-5" class="i">+) {
</a><a href="#h5-0-6" id="h5-0-6" class="i">+    DOWNLOAD(&quot;download&quot;),
</a><a href="#h5-0-7" id="h5-0-7" class="i">+    CHAT_ACTION(&quot;chat_action&quot;);
</a><a href="#h5-0-8" id="h5-0-8" class="i">+
</a><a href="#h5-0-9" id="h5-0-9" class="i">+    companion object {
</a><a href="#h5-0-10" id="h5-0-10" class="i">+        fun fromKey(key: String): TaskType {
</a><a href="#h5-0-11" id="h5-0-11" class="i">+            return entries.find { it.key == key } ?: throw IllegalArgumentException(&quot;Invalid key $key&quot;)
</a><a href="#h5-0-12" id="h5-0-12" class="i">+        }
</a><a href="#h5-0-13" id="h5-0-13" class="i">+    }
</a><a href="#h5-0-14" id="h5-0-14" class="i">+}
</a><a href="#h5-0-15" id="h5-0-15" class="i">+
</a><a href="#h5-0-16" id="h5-0-16" class="i">+enum class TaskStatus(
</a><a href="#h5-0-17" id="h5-0-17" class="i">+    val key: String
</a><a href="#h5-0-18" id="h5-0-18" class="i">+) {
</a><a href="#h5-0-19" id="h5-0-19" class="i">+    PENDING(&quot;pending&quot;),
</a><a href="#h5-0-20" id="h5-0-20" class="i">+    RUNNING(&quot;running&quot;),
</a><a href="#h5-0-21" id="h5-0-21" class="i">+    SUCCESS(&quot;success&quot;),
</a><a href="#h5-0-22" id="h5-0-22" class="i">+    FAILURE(&quot;failure&quot;),
</a><a href="#h5-0-23" id="h5-0-23" class="i">+    CANCELLED(&quot;cancelled&quot;);
</a><a href="#h5-0-24" id="h5-0-24" class="i">+
</a><a href="#h5-0-25" id="h5-0-25" class="i">+    fun isFinalStage(): Boolean {
</a><a href="#h5-0-26" id="h5-0-26" class="i">+        return this == SUCCESS || this == FAILURE || this == CANCELLED
</a><a href="#h5-0-27" id="h5-0-27" class="i">+    }
</a><a href="#h5-0-28" id="h5-0-28" class="i">+
</a><a href="#h5-0-29" id="h5-0-29" class="i">+    companion object {
</a><a href="#h5-0-30" id="h5-0-30" class="i">+        fun fromKey(key: String): TaskStatus {
</a><a href="#h5-0-31" id="h5-0-31" class="i">+            return entries.find { it.key == key } ?: throw IllegalArgumentException(&quot;Invalid key $key&quot;)
</a><a href="#h5-0-32" id="h5-0-32" class="i">+        }
</a><a href="#h5-0-33" id="h5-0-33" class="i">+    }
</a><a href="#h5-0-34" id="h5-0-34" class="i">+}
</a><a href="#h5-0-35" id="h5-0-35" class="i">+
</a><a href="#h5-0-36" id="h5-0-36" class="i">+data class PendingTaskListener(
</a><a href="#h5-0-37" id="h5-0-37" class="i">+    val onSuccess: () -&gt; Unit = {},
</a><a href="#h5-0-38" id="h5-0-38" class="i">+    val onCancel: () -&gt; Unit = {},
</a><a href="#h5-0-39" id="h5-0-39" class="i">+    val onProgress: (label: String?, progress: Int) -&gt; Unit = { _, _ -&gt; },
</a><a href="#h5-0-40" id="h5-0-40" class="i">+    val onStateChange: (status: TaskStatus) -&gt; Unit = {},
</a><a href="#h5-0-41" id="h5-0-41" class="i">+)
</a><a href="#h5-0-42" id="h5-0-42" class="i">+
</a><a href="#h5-0-43" id="h5-0-43" class="i">+data class Task(
</a><a href="#h5-0-44" id="h5-0-44" class="i">+    val type: TaskType,
</a><a href="#h5-0-45" id="h5-0-45" class="i">+    val title: String,
</a><a href="#h5-0-46" id="h5-0-46" class="i">+    val hash: String
</a><a href="#h5-0-47" id="h5-0-47" class="i">+) {
</a><a href="#h5-0-48" id="h5-0-48" class="i">+    var changeListener: () -&gt; Unit = {}
</a><a href="#h5-0-49" id="h5-0-49" class="i">+
</a><a href="#h5-0-50" id="h5-0-50" class="i">+    var extra: String? = null
</a><a href="#h5-0-51" id="h5-0-51" class="i">+        set(value) {
</a><a href="#h5-0-52" id="h5-0-52" class="i">+            field = value
</a><a href="#h5-0-53" id="h5-0-53" class="i">+            changeListener()
</a><a href="#h5-0-54" id="h5-0-54" class="i">+        }
</a><a href="#h5-0-55" id="h5-0-55" class="i">+    var status: TaskStatus = TaskStatus.PENDING
</a><a href="#h5-0-56" id="h5-0-56" class="i">+        set(value) {
</a><a href="#h5-0-57" id="h5-0-57" class="i">+            field = value
</a><a href="#h5-0-58" id="h5-0-58" class="i">+            changeListener()
</a><a href="#h5-0-59" id="h5-0-59" class="i">+        }
</a><a href="#h5-0-60" id="h5-0-60" class="i">+}
</a><a href="#h5-0-61" id="h5-0-61" class="i">+
</a><a href="#h5-0-62" id="h5-0-62" class="i">+class PendingTask(
</a><a href="#h5-0-63" id="h5-0-63" class="i">+    val task: Task
</a><a href="#h5-0-64" id="h5-0-64" class="i">+) {
</a><a href="#h5-0-65" id="h5-0-65" class="i">+    private val listeners = mutableListOf&lt;PendingTaskListener&gt;()
</a><a href="#h5-0-66" id="h5-0-66" class="i">+
</a><a href="#h5-0-67" id="h5-0-67" class="i">+    fun addListener(listener: PendingTaskListener) {
</a><a href="#h5-0-68" id="h5-0-68" class="i">+        synchronized(listeners) { listeners.add(listener) }
</a><a href="#h5-0-69" id="h5-0-69" class="i">+    }
</a><a href="#h5-0-70" id="h5-0-70" class="i">+
</a><a href="#h5-0-71" id="h5-0-71" class="i">+    fun removeListener(listener: PendingTaskListener) {
</a><a href="#h5-0-72" id="h5-0-72" class="i">+        synchronized(listeners) { listeners.remove(listener) }
</a><a href="#h5-0-73" id="h5-0-73" class="i">+    }
</a><a href="#h5-0-74" id="h5-0-74" class="i">+
</a><a href="#h5-0-75" id="h5-0-75" class="i">+    var status
</a><a href="#h5-0-76" id="h5-0-76" class="i">+        get() = task.status;
</a><a href="#h5-0-77" id="h5-0-77" class="i">+        set(value) {
</a><a href="#h5-0-78" id="h5-0-78" class="i">+            task.status = value;
</a><a href="#h5-0-79" id="h5-0-79" class="i">+            synchronized(listeners) {
</a><a href="#h5-0-80" id="h5-0-80" class="i">+                listeners.forEach { it.onStateChange(value) }
</a><a href="#h5-0-81" id="h5-0-81" class="i">+            }
</a><a href="#h5-0-82" id="h5-0-82" class="i">+        }
</a><a href="#h5-0-83" id="h5-0-83" class="i">+
</a><a href="#h5-0-84" id="h5-0-84" class="i">+    var progressLabel: String? = null
</a><a href="#h5-0-85" id="h5-0-85" class="i">+        set(value) {
</a><a href="#h5-0-86" id="h5-0-86" class="i">+            field = value
</a><a href="#h5-0-87" id="h5-0-87" class="i">+            synchronized(listeners) {
</a><a href="#h5-0-88" id="h5-0-88" class="i">+                listeners.forEach { it.onProgress(value, progress) }
</a><a href="#h5-0-89" id="h5-0-89" class="i">+            }
</a><a href="#h5-0-90" id="h5-0-90" class="i">+        }
</a><a href="#h5-0-91" id="h5-0-91" class="i">+
</a><a href="#h5-0-92" id="h5-0-92" class="i">+    private var _progress = 0
</a><a href="#h5-0-93" id="h5-0-93" class="i">+        set(value) {
</a><a href="#h5-0-94" id="h5-0-94" class="i">+            assert(value in 0..100 || value == -1)
</a><a href="#h5-0-95" id="h5-0-95" class="i">+            field = value
</a><a href="#h5-0-96" id="h5-0-96" class="i">+        }
</a><a href="#h5-0-97" id="h5-0-97" class="i">+
</a><a href="#h5-0-98" id="h5-0-98" class="i">+    var progress get() = _progress
</a><a href="#h5-0-99" id="h5-0-99" class="i">+        set(value) {
</a><a href="#h5-0-100" id="h5-0-100" class="i">+            _progress = value
</a><a href="#h5-0-101" id="h5-0-101" class="i">+            synchronized(listeners) {
</a><a href="#h5-0-102" id="h5-0-102" class="i">+                listeners.forEach { it.onProgress(progressLabel, value) }
</a><a href="#h5-0-103" id="h5-0-103" class="i">+            }
</a><a href="#h5-0-104" id="h5-0-104" class="i">+        }
</a><a href="#h5-0-105" id="h5-0-105" class="i">+
</a><a href="#h5-0-106" id="h5-0-106" class="i">+    fun updateProgress(label: String, progress: Int = -1) {
</a><a href="#h5-0-107" id="h5-0-107" class="i">+        _progress = progress
</a><a href="#h5-0-108" id="h5-0-108" class="i">+        progressLabel = label
</a><a href="#h5-0-109" id="h5-0-109" class="i">+    }
</a><a href="#h5-0-110" id="h5-0-110" class="i">+
</a><a href="#h5-0-111" id="h5-0-111" class="i">+    fun fail(reason: String) {
</a><a href="#h5-0-112" id="h5-0-112" class="i">+        status = TaskStatus.FAILURE
</a><a href="#h5-0-113" id="h5-0-113" class="i">+        synchronized(listeners) {
</a><a href="#h5-0-114" id="h5-0-114" class="i">+            listeners.forEach { it.onCancel() }
</a><a href="#h5-0-115" id="h5-0-115" class="i">+        }
</a><a href="#h5-0-116" id="h5-0-116" class="i">+        updateProgress(reason)
</a><a href="#h5-0-117" id="h5-0-117" class="i">+    }
</a><a href="#h5-0-118" id="h5-0-118" class="i">+
</a><a href="#h5-0-119" id="h5-0-119" class="i">+    fun success() {
</a><a href="#h5-0-120" id="h5-0-120" class="i">+        status = TaskStatus.SUCCESS
</a><a href="#h5-0-121" id="h5-0-121" class="i">+        synchronized(listeners) {
</a><a href="#h5-0-122" id="h5-0-122" class="i">+            listeners.forEach { it.onSuccess() }
</a><a href="#h5-0-123" id="h5-0-123" class="i">+        }
</a><a href="#h5-0-124" id="h5-0-124" class="i">+    }
</a><a href="#h5-0-125" id="h5-0-125" class="i">+
</a><a href="#h5-0-126" id="h5-0-126" class="i">+    fun cancel() {
</a><a href="#h5-0-127" id="h5-0-127" class="i">+        status = TaskStatus.CANCELLED
</a><a href="#h5-0-128" id="h5-0-128" class="i">+        synchronized(listeners) {
</a><a href="#h5-0-129" id="h5-0-129" class="i">+            listeners.forEach { it.onCancel() }
</a><a href="#h5-0-130" id="h5-0-130" class="i">+        }
</a><a href="#h5-0-131" id="h5-0-131" class="i">+    }
</a><a href="#h5-0-132" id="h5-0-132" class="i">+}</a><a href="#h5-0-133" id="h5-0-133" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h6" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/task/TaskManager.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/task/TaskManager.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/task/TaskManager.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/task/TaskManager.kt</a></b>
<a href="#h6-0" id="h6-0" class="h">@@ -0,0 +1,134 @@
</a><a href="#h6-0-0" id="h6-0-0" class="i">+package me.rhunk.snapenhance.task
</a><a href="#h6-0-1" id="h6-0-1" class="i">+
</a><a href="#h6-0-2" id="h6-0-2" class="i">+import android.content.ContentValues
</a><a href="#h6-0-3" id="h6-0-3" class="i">+import android.content.Context
</a><a href="#h6-0-4" id="h6-0-4" class="i">+import android.database.sqlite.SQLiteDatabase
</a><a href="#h6-0-5" id="h6-0-5" class="i">+import kotlinx.coroutines.asCoroutineDispatcher
</a><a href="#h6-0-6" id="h6-0-6" class="i">+import kotlinx.coroutines.launch
</a><a href="#h6-0-7" id="h6-0-7" class="i">+import kotlinx.coroutines.runBlocking
</a><a href="#h6-0-8" id="h6-0-8" class="i">+import me.rhunk.snapenhance.RemoteSideContext
</a><a href="#h6-0-9" id="h6-0-9" class="i">+import me.rhunk.snapenhance.common.util.SQLiteDatabaseHelper
</a><a href="#h6-0-10" id="h6-0-10" class="i">+import me.rhunk.snapenhance.common.util.ktx.getLong
</a><a href="#h6-0-11" id="h6-0-11" class="i">+import me.rhunk.snapenhance.common.util.ktx.getStringOrNull
</a><a href="#h6-0-12" id="h6-0-12" class="i">+import java.util.concurrent.Executors
</a><a href="#h6-0-13" id="h6-0-13" class="i">+import kotlin.coroutines.suspendCoroutine
</a><a href="#h6-0-14" id="h6-0-14" class="i">+
</a><a href="#h6-0-15" id="h6-0-15" class="i">+class TaskManager(
</a><a href="#h6-0-16" id="h6-0-16" class="i">+    private val remoteSideContext: RemoteSideContext
</a><a href="#h6-0-17" id="h6-0-17" class="i">+) {
</a><a href="#h6-0-18" id="h6-0-18" class="i">+    private lateinit var taskDatabase: SQLiteDatabase
</a><a href="#h6-0-19" id="h6-0-19" class="i">+    private val queueExecutor = Executors.newSingleThreadExecutor()
</a><a href="#h6-0-20" id="h6-0-20" class="i">+
</a><a href="#h6-0-21" id="h6-0-21" class="i">+    fun init() {
</a><a href="#h6-0-22" id="h6-0-22" class="i">+        taskDatabase = remoteSideContext.androidContext.openOrCreateDatabase(&quot;tasks&quot;, Context.MODE_PRIVATE, null).apply {
</a><a href="#h6-0-23" id="h6-0-23" class="i">+            SQLiteDatabaseHelper.createTablesFromSchema(this, mapOf(
</a><a href="#h6-0-24" id="h6-0-24" class="i">+                &quot;tasks&quot; to listOf(
</a><a href="#h6-0-25" id="h6-0-25" class="i">+                    &quot;id INTEGER PRIMARY KEY AUTOINCREMENT&quot;,
</a><a href="#h6-0-26" id="h6-0-26" class="i">+                    &quot;hash VARCHAR UNIQUE&quot;,
</a><a href="#h6-0-27" id="h6-0-27" class="i">+                    &quot;title VARCHAR(255) NOT NULL&quot;,
</a><a href="#h6-0-28" id="h6-0-28" class="i">+                    &quot;type VARCHAR(255) NOT NULL&quot;,
</a><a href="#h6-0-29" id="h6-0-29" class="i">+                    &quot;status VARCHAR(255) NOT NULL&quot;,
</a><a href="#h6-0-30" id="h6-0-30" class="i">+                    &quot;extra TEXT&quot;
</a><a href="#h6-0-31" id="h6-0-31" class="i">+                )
</a><a href="#h6-0-32" id="h6-0-32" class="i">+            ))
</a><a href="#h6-0-33" id="h6-0-33" class="i">+        }
</a><a href="#h6-0-34" id="h6-0-34" class="i">+    }
</a><a href="#h6-0-35" id="h6-0-35" class="i">+
</a><a href="#h6-0-36" id="h6-0-36" class="i">+    private val activeTasks = mutableMapOf&lt;Long, PendingTask&gt;()
</a><a href="#h6-0-37" id="h6-0-37" class="i">+
</a><a href="#h6-0-38" id="h6-0-38" class="i">+    private fun readTaskFromCursor(cursor: android.database.Cursor): Task {
</a><a href="#h6-0-39" id="h6-0-39" class="i">+        val task = Task(TaskType.fromKey(cursor.getStringOrNull(&quot;type&quot;)!!), cursor.getStringOrNull(&quot;title&quot;)!!, cursor.getStringOrNull(&quot;hash&quot;)!!)
</a><a href="#h6-0-40" id="h6-0-40" class="i">+        task.status = TaskStatus.fromKey(cursor.getStringOrNull(&quot;status&quot;)!!)
</a><a href="#h6-0-41" id="h6-0-41" class="i">+        task.extra = cursor.getStringOrNull(&quot;extra&quot;)
</a><a href="#h6-0-42" id="h6-0-42" class="i">+        task.changeListener = {
</a><a href="#h6-0-43" id="h6-0-43" class="i">+            updateTask(cursor.getLong(&quot;id&quot;), task)
</a><a href="#h6-0-44" id="h6-0-44" class="i">+        }
</a><a href="#h6-0-45" id="h6-0-45" class="i">+        return task
</a><a href="#h6-0-46" id="h6-0-46" class="i">+    }
</a><a href="#h6-0-47" id="h6-0-47" class="i">+
</a><a href="#h6-0-48" id="h6-0-48" class="i">+    private fun putNewTask(task: Task): Long {
</a><a href="#h6-0-49" id="h6-0-49" class="i">+        return runBlocking {
</a><a href="#h6-0-50" id="h6-0-50" class="i">+            suspendCoroutine {
</a><a href="#h6-0-51" id="h6-0-51" class="i">+                queueExecutor.execute {
</a><a href="#h6-0-52" id="h6-0-52" class="i">+                    val result = taskDatabase.insert(&quot;tasks&quot;, null, ContentValues().apply {
</a><a href="#h6-0-53" id="h6-0-53" class="i">+                        put(&quot;type&quot;, task.type.key)
</a><a href="#h6-0-54" id="h6-0-54" class="i">+                        put(&quot;hash&quot;, task.hash)
</a><a href="#h6-0-55" id="h6-0-55" class="i">+                        put(&quot;title&quot;, task.title)
</a><a href="#h6-0-56" id="h6-0-56" class="i">+                        put(&quot;status&quot;, task.status.key)
</a><a href="#h6-0-57" id="h6-0-57" class="i">+                        put(&quot;extra&quot;, task.extra)
</a><a href="#h6-0-58" id="h6-0-58" class="i">+                    })
</a><a href="#h6-0-59" id="h6-0-59" class="i">+                    it.resumeWith(Result.success(result))
</a><a href="#h6-0-60" id="h6-0-60" class="i">+                }
</a><a href="#h6-0-61" id="h6-0-61" class="i">+            }
</a><a href="#h6-0-62" id="h6-0-62" class="i">+        }
</a><a href="#h6-0-63" id="h6-0-63" class="i">+    }
</a><a href="#h6-0-64" id="h6-0-64" class="i">+
</a><a href="#h6-0-65" id="h6-0-65" class="i">+    private fun updateTask(id: Long, task: Task) {
</a><a href="#h6-0-66" id="h6-0-66" class="i">+        queueExecutor.execute {
</a><a href="#h6-0-67" id="h6-0-67" class="i">+            taskDatabase.execSQL(&quot;UPDATE tasks SET status = ?, extra = ? WHERE id = ?&quot;,
</a><a href="#h6-0-68" id="h6-0-68" class="i">+                arrayOf(
</a><a href="#h6-0-69" id="h6-0-69" class="i">+                    task.status.key,
</a><a href="#h6-0-70" id="h6-0-70" class="i">+                    task.extra,
</a><a href="#h6-0-71" id="h6-0-71" class="i">+                    id.toString()
</a><a href="#h6-0-72" id="h6-0-72" class="i">+                )
</a><a href="#h6-0-73" id="h6-0-73" class="i">+            )
</a><a href="#h6-0-74" id="h6-0-74" class="i">+        }
</a><a href="#h6-0-75" id="h6-0-75" class="i">+    }
</a><a href="#h6-0-76" id="h6-0-76" class="i">+
</a><a href="#h6-0-77" id="h6-0-77" class="i">+    fun clearAllTasks() {
</a><a href="#h6-0-78" id="h6-0-78" class="i">+        runBlocking {
</a><a href="#h6-0-79" id="h6-0-79" class="i">+            launch(queueExecutor.asCoroutineDispatcher()) {
</a><a href="#h6-0-80" id="h6-0-80" class="i">+                taskDatabase.execSQL(&quot;DELETE FROM tasks&quot;)
</a><a href="#h6-0-81" id="h6-0-81" class="i">+            }
</a><a href="#h6-0-82" id="h6-0-82" class="i">+        }
</a><a href="#h6-0-83" id="h6-0-83" class="i">+    }
</a><a href="#h6-0-84" id="h6-0-84" class="i">+
</a><a href="#h6-0-85" id="h6-0-85" class="i">+    fun createPendingTask(task: Task): PendingTask {
</a><a href="#h6-0-86" id="h6-0-86" class="i">+        val taskId = putNewTask(task)
</a><a href="#h6-0-87" id="h6-0-87" class="i">+        task.changeListener = {
</a><a href="#h6-0-88" id="h6-0-88" class="i">+            updateTask(taskId, task)
</a><a href="#h6-0-89" id="h6-0-89" class="i">+        }
</a><a href="#h6-0-90" id="h6-0-90" class="i">+
</a><a href="#h6-0-91" id="h6-0-91" class="i">+        val pendingTask = PendingTask(task)
</a><a href="#h6-0-92" id="h6-0-92" class="i">+        activeTasks[taskId] = pendingTask
</a><a href="#h6-0-93" id="h6-0-93" class="i">+        return pendingTask
</a><a href="#h6-0-94" id="h6-0-94" class="i">+    }
</a><a href="#h6-0-95" id="h6-0-95" class="i">+
</a><a href="#h6-0-96" id="h6-0-96" class="i">+    fun getTaskByHash(hash: String?): Task? {
</a><a href="#h6-0-97" id="h6-0-97" class="i">+        if (hash == null) return null
</a><a href="#h6-0-98" id="h6-0-98" class="i">+        taskDatabase.rawQuery(&quot;SELECT * FROM tasks WHERE hash = ?&quot;, arrayOf(hash)).use { cursor -&gt;
</a><a href="#h6-0-99" id="h6-0-99" class="i">+            if (cursor.moveToNext()) {
</a><a href="#h6-0-100" id="h6-0-100" class="i">+                return readTaskFromCursor(cursor)
</a><a href="#h6-0-101" id="h6-0-101" class="i">+            }
</a><a href="#h6-0-102" id="h6-0-102" class="i">+        }
</a><a href="#h6-0-103" id="h6-0-103" class="i">+        return null
</a><a href="#h6-0-104" id="h6-0-104" class="i">+    }
</a><a href="#h6-0-105" id="h6-0-105" class="i">+
</a><a href="#h6-0-106" id="h6-0-106" class="i">+    fun getActiveTasks() = activeTasks
</a><a href="#h6-0-107" id="h6-0-107" class="i">+
</a><a href="#h6-0-108" id="h6-0-108" class="i">+    fun fetchStoredTasks(lastId: Long = Long.MAX_VALUE, limit: Int = 10): Map&lt;Long, Task&gt; {
</a><a href="#h6-0-109" id="h6-0-109" class="i">+        val tasks = mutableMapOf&lt;Long, Task&gt;()
</a><a href="#h6-0-110" id="h6-0-110" class="i">+        val invalidTasks = mutableListOf&lt;Long&gt;()
</a><a href="#h6-0-111" id="h6-0-111" class="i">+
</a><a href="#h6-0-112" id="h6-0-112" class="i">+        taskDatabase.rawQuery(&quot;SELECT * FROM tasks WHERE id &lt; ? ORDER BY id DESC LIMIT ?&quot;, arrayOf(lastId.toString(), limit.toString())).use { cursor -&gt;
</a><a href="#h6-0-113" id="h6-0-113" class="i">+            while (cursor.moveToNext()) {
</a><a href="#h6-0-114" id="h6-0-114" class="i">+                runCatching {
</a><a href="#h6-0-115" id="h6-0-115" class="i">+                    val task = readTaskFromCursor(cursor)
</a><a href="#h6-0-116" id="h6-0-116" class="i">+                    if (!task.status.isFinalStage()) { task.status = TaskStatus.FAILURE }
</a><a href="#h6-0-117" id="h6-0-117" class="i">+                    tasks[cursor.getLong(&quot;id&quot;)] = task
</a><a href="#h6-0-118" id="h6-0-118" class="i">+                }.onFailure {
</a><a href="#h6-0-119" id="h6-0-119" class="i">+                    invalidTasks.add(cursor.getLong(&quot;id&quot;))
</a><a href="#h6-0-120" id="h6-0-120" class="i">+                    remoteSideContext.log.warn(&quot;Failed to read task ${cursor.getLong(&quot;id&quot;)}&quot;)
</a><a href="#h6-0-121" id="h6-0-121" class="i">+                }
</a><a href="#h6-0-122" id="h6-0-122" class="i">+            }
</a><a href="#h6-0-123" id="h6-0-123" class="i">+        }
</a><a href="#h6-0-124" id="h6-0-124" class="i">+
</a><a href="#h6-0-125" id="h6-0-125" class="i">+        invalidTasks.forEach {
</a><a href="#h6-0-126" id="h6-0-126" class="i">+            queueExecutor.execute {
</a><a href="#h6-0-127" id="h6-0-127" class="i">+                taskDatabase.execSQL(&quot;DELETE FROM tasks WHERE id = ?&quot;, arrayOf(it.toString()))
</a><a href="#h6-0-128" id="h6-0-128" class="i">+            }
</a><a href="#h6-0-129" id="h6-0-129" class="i">+        }
</a><a href="#h6-0-130" id="h6-0-130" class="i">+
</a><a href="#h6-0-131" id="h6-0-131" class="i">+        return tasks
</a><a href="#h6-0-132" id="h6-0-132" class="i">+    }
</a><a href="#h6-0-133" id="h6-0-133" class="i">+}</a><a href="#h6-0-134" id="h6-0-134" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h7" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/Section.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/Section.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/Section.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/Section.kt</a></b>
<a href="#h7-0" id="h7-0" class="h">@@ -2,11 +2,7 @@ package me.rhunk.snapenhance.ui.manager
</a> 
 import androidx.compose.foundation.layout.RowScope
 import androidx.compose.material.icons.Icons
<a href="#h7-0-3" id="h7-0-3" class="d">-import androidx.compose.material.icons.filled.DataObject
</a><a href="#h7-0-4" id="h7-0-4" class="d">-import androidx.compose.material.icons.filled.Download
</a><a href="#h7-0-5" id="h7-0-5" class="d">-import androidx.compose.material.icons.filled.Group
</a><a href="#h7-0-6" id="h7-0-6" class="d">-import androidx.compose.material.icons.filled.Home
</a><a href="#h7-0-7" id="h7-0-7" class="d">-import androidx.compose.material.icons.filled.Stars
</a><a href="#h7-0-8" id="h7-0-8" class="i">+import androidx.compose.material.icons.filled.*
</a> import androidx.compose.runtime.Composable
 import androidx.compose.ui.graphics.vector.ImageVector
 import androidx.navigation.NavController
<a href="#h7-1" id="h7-1" class="h">@@ -14,7 +10,7 @@ import androidx.navigation.NavGraphBuilder
</a> import androidx.navigation.compose.composable
 import me.rhunk.snapenhance.RemoteSideContext
 import me.rhunk.snapenhance.ui.manager.sections.NotImplemented
<a href="#h7-1-3" id="h7-1-3" class="d">-import me.rhunk.snapenhance.ui.manager.sections.downloads.DownloadsSection
</a><a href="#h7-1-4" id="h7-1-4" class="i">+import me.rhunk.snapenhance.ui.manager.sections.TasksSection
</a> import me.rhunk.snapenhance.ui.manager.sections.features.FeaturesSection
 import me.rhunk.snapenhance.ui.manager.sections.home.HomeSection
 import me.rhunk.snapenhance.ui.manager.sections.scripting.ScriptsSection
<a href="#h7-2" id="h7-2" class="h">@@ -26,10 +22,10 @@ enum class EnumSection(
</a>     val icon: ImageVector,
     val section: KClass&lt;out Section&gt; = NotImplemented::class
 ) {
<a href="#h7-2-3" id="h7-2-3" class="d">-    DOWNLOADS(
</a><a href="#h7-2-4" id="h7-2-4" class="d">-        route = &quot;downloads&quot;,
</a><a href="#h7-2-5" id="h7-2-5" class="d">-        icon = Icons.Filled.Download,
</a><a href="#h7-2-6" id="h7-2-6" class="d">-        section = DownloadsSection::class
</a><a href="#h7-2-7" id="h7-2-7" class="i">+    TASKS(
</a><a href="#h7-2-8" id="h7-2-8" class="i">+        route = &quot;tasks&quot;,
</a><a href="#h7-2-9" id="h7-2-9" class="i">+        icon = Icons.Filled.TaskAlt,
</a><a href="#h7-2-10" id="h7-2-10" class="i">+        section = TasksSection::class
</a>     ),
     FEATURES(
         route = &quot;features&quot;,
<b>diff --git a/<a id="h8" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/TasksSection.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/TasksSection.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/TasksSection.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/TasksSection.kt</a></b>
<a href="#h8-0" id="h8-0" class="h">@@ -0,0 +1,231 @@
</a><a href="#h8-0-0" id="h8-0-0" class="i">+package me.rhunk.snapenhance.ui.manager.sections
</a><a href="#h8-0-1" id="h8-0-1" class="i">+
</a><a href="#h8-0-2" id="h8-0-2" class="i">+import androidx.compose.foundation.layout.*
</a><a href="#h8-0-3" id="h8-0-3" class="i">+import androidx.compose.foundation.lazy.LazyColumn
</a><a href="#h8-0-4" id="h8-0-4" class="i">+import androidx.compose.foundation.lazy.items
</a><a href="#h8-0-5" id="h8-0-5" class="i">+import androidx.compose.foundation.lazy.rememberLazyListState
</a><a href="#h8-0-6" id="h8-0-6" class="i">+import androidx.compose.material.icons.Icons
</a><a href="#h8-0-7" id="h8-0-7" class="i">+import androidx.compose.material.icons.filled.*
</a><a href="#h8-0-8" id="h8-0-8" class="i">+import androidx.compose.material3.*
</a><a href="#h8-0-9" id="h8-0-9" class="i">+import androidx.compose.runtime.*
</a><a href="#h8-0-10" id="h8-0-10" class="i">+import androidx.compose.ui.Alignment
</a><a href="#h8-0-11" id="h8-0-11" class="i">+import androidx.compose.ui.Modifier
</a><a href="#h8-0-12" id="h8-0-12" class="i">+import androidx.compose.ui.graphics.StrokeCap
</a><a href="#h8-0-13" id="h8-0-13" class="i">+import androidx.compose.ui.tooling.preview.Preview
</a><a href="#h8-0-14" id="h8-0-14" class="i">+import androidx.compose.ui.unit.dp
</a><a href="#h8-0-15" id="h8-0-15" class="i">+import androidx.lifecycle.Lifecycle
</a><a href="#h8-0-16" id="h8-0-16" class="i">+import kotlinx.coroutines.Dispatchers
</a><a href="#h8-0-17" id="h8-0-17" class="i">+import kotlinx.coroutines.launch
</a><a href="#h8-0-18" id="h8-0-18" class="i">+import me.rhunk.snapenhance.task.PendingTask
</a><a href="#h8-0-19" id="h8-0-19" class="i">+import me.rhunk.snapenhance.task.PendingTaskListener
</a><a href="#h8-0-20" id="h8-0-20" class="i">+import me.rhunk.snapenhance.task.Task
</a><a href="#h8-0-21" id="h8-0-21" class="i">+import me.rhunk.snapenhance.task.TaskStatus
</a><a href="#h8-0-22" id="h8-0-22" class="i">+import me.rhunk.snapenhance.task.TaskType
</a><a href="#h8-0-23" id="h8-0-23" class="i">+import me.rhunk.snapenhance.ui.manager.Section
</a><a href="#h8-0-24" id="h8-0-24" class="i">+import me.rhunk.snapenhance.ui.util.OnLifecycleEvent
</a><a href="#h8-0-25" id="h8-0-25" class="i">+
</a><a href="#h8-0-26" id="h8-0-26" class="i">+class TasksSection : Section() {
</a><a href="#h8-0-27" id="h8-0-27" class="i">+    private lateinit var activeTasks: MutableMap&lt;Long, PendingTask&gt;
</a><a href="#h8-0-28" id="h8-0-28" class="i">+    private lateinit var recentTasks: MutableList&lt;Task&gt;
</a><a href="#h8-0-29" id="h8-0-29" class="i">+
</a><a href="#h8-0-30" id="h8-0-30" class="i">+    @Composable
</a><a href="#h8-0-31" id="h8-0-31" class="i">+    override fun TopBarActions(rowScope: RowScope) {
</a><a href="#h8-0-32" id="h8-0-32" class="i">+        var showConfirmDialog by remember { mutableStateOf(false) }
</a><a href="#h8-0-33" id="h8-0-33" class="i">+
</a><a href="#h8-0-34" id="h8-0-34" class="i">+        IconButton(onClick = {
</a><a href="#h8-0-35" id="h8-0-35" class="i">+            showConfirmDialog = true
</a><a href="#h8-0-36" id="h8-0-36" class="i">+        }) {
</a><a href="#h8-0-37" id="h8-0-37" class="i">+            Icon(Icons.Filled.Delete, contentDescription = &quot;Clear all tasks&quot;)
</a><a href="#h8-0-38" id="h8-0-38" class="i">+        }
</a><a href="#h8-0-39" id="h8-0-39" class="i">+
</a><a href="#h8-0-40" id="h8-0-40" class="i">+        if (showConfirmDialog) {
</a><a href="#h8-0-41" id="h8-0-41" class="i">+            AlertDialog(
</a><a href="#h8-0-42" id="h8-0-42" class="i">+                onDismissRequest = { showConfirmDialog = false },
</a><a href="#h8-0-43" id="h8-0-43" class="i">+                title = { Text(&quot;Clear all tasks&quot;) },
</a><a href="#h8-0-44" id="h8-0-44" class="i">+                text = { Text(&quot;Are you sure you want to clear all tasks?&quot;) },
</a><a href="#h8-0-45" id="h8-0-45" class="i">+                confirmButton = {
</a><a href="#h8-0-46" id="h8-0-46" class="i">+                    Button(
</a><a href="#h8-0-47" id="h8-0-47" class="i">+                        onClick = {
</a><a href="#h8-0-48" id="h8-0-48" class="i">+                            context.taskManager.clearAllTasks()
</a><a href="#h8-0-49" id="h8-0-49" class="i">+                            recentTasks.clear()
</a><a href="#h8-0-50" id="h8-0-50" class="i">+                            activeTasks.toList().forEach {
</a><a href="#h8-0-51" id="h8-0-51" class="i">+                                runCatching {
</a><a href="#h8-0-52" id="h8-0-52" class="i">+                                    it.second.cancel()
</a><a href="#h8-0-53" id="h8-0-53" class="i">+                                }.onFailure { throwable -&gt;
</a><a href="#h8-0-54" id="h8-0-54" class="i">+                                    context.log.error(&quot;Failed to cancel task ${it.first}&quot;, throwable)
</a><a href="#h8-0-55" id="h8-0-55" class="i">+                                }
</a><a href="#h8-0-56" id="h8-0-56" class="i">+                                activeTasks.remove(it.first)
</a><a href="#h8-0-57" id="h8-0-57" class="i">+                            }
</a><a href="#h8-0-58" id="h8-0-58" class="i">+                            context.taskManager.getActiveTasks().clear()
</a><a href="#h8-0-59" id="h8-0-59" class="i">+                            showConfirmDialog = false
</a><a href="#h8-0-60" id="h8-0-60" class="i">+                        }
</a><a href="#h8-0-61" id="h8-0-61" class="i">+                    ) {
</a><a href="#h8-0-62" id="h8-0-62" class="i">+                        Text(&quot;Yes&quot;)
</a><a href="#h8-0-63" id="h8-0-63" class="i">+                    }
</a><a href="#h8-0-64" id="h8-0-64" class="i">+                },
</a><a href="#h8-0-65" id="h8-0-65" class="i">+                dismissButton = {
</a><a href="#h8-0-66" id="h8-0-66" class="i">+                    Button(
</a><a href="#h8-0-67" id="h8-0-67" class="i">+                        onClick = {
</a><a href="#h8-0-68" id="h8-0-68" class="i">+                            showConfirmDialog = false
</a><a href="#h8-0-69" id="h8-0-69" class="i">+                        }
</a><a href="#h8-0-70" id="h8-0-70" class="i">+                    ) {
</a><a href="#h8-0-71" id="h8-0-71" class="i">+                        Text(&quot;No&quot;)
</a><a href="#h8-0-72" id="h8-0-72" class="i">+                    }
</a><a href="#h8-0-73" id="h8-0-73" class="i">+                }
</a><a href="#h8-0-74" id="h8-0-74" class="i">+            )
</a><a href="#h8-0-75" id="h8-0-75" class="i">+        }
</a><a href="#h8-0-76" id="h8-0-76" class="i">+    }
</a><a href="#h8-0-77" id="h8-0-77" class="i">+
</a><a href="#h8-0-78" id="h8-0-78" class="i">+    @Composable
</a><a href="#h8-0-79" id="h8-0-79" class="i">+    private fun TaskCard(modifier: Modifier, task: Task, pendingTask: PendingTask? = null) {
</a><a href="#h8-0-80" id="h8-0-80" class="i">+        var taskStatus by remember { mutableStateOf(task.status) }
</a><a href="#h8-0-81" id="h8-0-81" class="i">+        var taskProgressLabel by remember { mutableStateOf&lt;String?&gt;(null) }
</a><a href="#h8-0-82" id="h8-0-82" class="i">+        var taskProgress by remember { mutableIntStateOf(-1) }
</a><a href="#h8-0-83" id="h8-0-83" class="i">+
</a><a href="#h8-0-84" id="h8-0-84" class="i">+        val listener = remember { PendingTaskListener(
</a><a href="#h8-0-85" id="h8-0-85" class="i">+            onStateChange = {
</a><a href="#h8-0-86" id="h8-0-86" class="i">+                taskStatus = it
</a><a href="#h8-0-87" id="h8-0-87" class="i">+            },
</a><a href="#h8-0-88" id="h8-0-88" class="i">+            onProgress = { label, progress -&gt;
</a><a href="#h8-0-89" id="h8-0-89" class="i">+                taskProgressLabel = label
</a><a href="#h8-0-90" id="h8-0-90" class="i">+                taskProgress = progress
</a><a href="#h8-0-91" id="h8-0-91" class="i">+            }
</a><a href="#h8-0-92" id="h8-0-92" class="i">+        ).also { pendingTask?.addListener(it) }}
</a><a href="#h8-0-93" id="h8-0-93" class="i">+
</a><a href="#h8-0-94" id="h8-0-94" class="i">+        DisposableEffect(Unit) {
</a><a href="#h8-0-95" id="h8-0-95" class="i">+            onDispose {
</a><a href="#h8-0-96" id="h8-0-96" class="i">+                pendingTask?.removeListener(listener)
</a><a href="#h8-0-97" id="h8-0-97" class="i">+            }
</a><a href="#h8-0-98" id="h8-0-98" class="i">+        }
</a><a href="#h8-0-99" id="h8-0-99" class="i">+
</a><a href="#h8-0-100" id="h8-0-100" class="i">+        OutlinedCard(modifier = modifier) {
</a><a href="#h8-0-101" id="h8-0-101" class="i">+            Row(
</a><a href="#h8-0-102" id="h8-0-102" class="i">+                modifier = Modifier.padding(15.dp),
</a><a href="#h8-0-103" id="h8-0-103" class="i">+                verticalAlignment = Alignment.CenterVertically
</a><a href="#h8-0-104" id="h8-0-104" class="i">+            ) {
</a><a href="#h8-0-105" id="h8-0-105" class="i">+                Column(
</a><a href="#h8-0-106" id="h8-0-106" class="i">+                    modifier = Modifier.padding(end = 15.dp)
</a><a href="#h8-0-107" id="h8-0-107" class="i">+                ) {
</a><a href="#h8-0-108" id="h8-0-108" class="i">+                    when (task.type) {
</a><a href="#h8-0-109" id="h8-0-109" class="i">+                        TaskType.DOWNLOAD -&gt; Icon(Icons.Filled.Download, contentDescription = &quot;Download&quot;)
</a><a href="#h8-0-110" id="h8-0-110" class="i">+                        TaskType.CHAT_ACTION -&gt; Icon(Icons.Filled.ChatBubble, contentDescription = &quot;Chat Action&quot;)
</a><a href="#h8-0-111" id="h8-0-111" class="i">+                    }
</a><a href="#h8-0-112" id="h8-0-112" class="i">+                }
</a><a href="#h8-0-113" id="h8-0-113" class="i">+                Column(
</a><a href="#h8-0-114" id="h8-0-114" class="i">+                    modifier = Modifier.weight(1f),
</a><a href="#h8-0-115" id="h8-0-115" class="i">+                ) {
</a><a href="#h8-0-116" id="h8-0-116" class="i">+                    Text(task.title, style = MaterialTheme.typography.bodyLarge)
</a><a href="#h8-0-117" id="h8-0-117" class="i">+                    Text(task.hash, style = MaterialTheme.typography.labelSmall)
</a><a href="#h8-0-118" id="h8-0-118" class="i">+                    Column(
</a><a href="#h8-0-119" id="h8-0-119" class="i">+                        modifier = Modifier.padding(top = 5.dp),
</a><a href="#h8-0-120" id="h8-0-120" class="i">+                        verticalArrangement = Arrangement.spacedBy(5.dp)
</a><a href="#h8-0-121" id="h8-0-121" class="i">+                    ) {
</a><a href="#h8-0-122" id="h8-0-122" class="i">+                        if (taskStatus.isFinalStage()) {
</a><a href="#h8-0-123" id="h8-0-123" class="i">+                            if (taskStatus != TaskStatus.SUCCESS) {
</a><a href="#h8-0-124" id="h8-0-124" class="i">+                                Text(&quot;$taskStatus&quot;, style = MaterialTheme.typography.bodySmall)
</a><a href="#h8-0-125" id="h8-0-125" class="i">+                            }
</a><a href="#h8-0-126" id="h8-0-126" class="i">+                        } else {
</a><a href="#h8-0-127" id="h8-0-127" class="i">+                            taskProgressLabel?.let {
</a><a href="#h8-0-128" id="h8-0-128" class="i">+                                Text(it, style = MaterialTheme.typography.bodySmall)
</a><a href="#h8-0-129" id="h8-0-129" class="i">+                            }
</a><a href="#h8-0-130" id="h8-0-130" class="i">+                            if (taskProgress != -1) {
</a><a href="#h8-0-131" id="h8-0-131" class="i">+                                LinearProgressIndicator(
</a><a href="#h8-0-132" id="h8-0-132" class="i">+                                    progress = taskProgress.toFloat() / 100f,
</a><a href="#h8-0-133" id="h8-0-133" class="i">+                                    strokeCap = StrokeCap.Round
</a><a href="#h8-0-134" id="h8-0-134" class="i">+                                )
</a><a href="#h8-0-135" id="h8-0-135" class="i">+                            } else {
</a><a href="#h8-0-136" id="h8-0-136" class="i">+                                task.extra?.let {
</a><a href="#h8-0-137" id="h8-0-137" class="i">+                                    Text(it, style = MaterialTheme.typography.bodySmall)
</a><a href="#h8-0-138" id="h8-0-138" class="i">+                                }
</a><a href="#h8-0-139" id="h8-0-139" class="i">+                            }
</a><a href="#h8-0-140" id="h8-0-140" class="i">+                        }
</a><a href="#h8-0-141" id="h8-0-141" class="i">+                    }
</a><a href="#h8-0-142" id="h8-0-142" class="i">+                }
</a><a href="#h8-0-143" id="h8-0-143" class="i">+
</a><a href="#h8-0-144" id="h8-0-144" class="i">+                Column {
</a><a href="#h8-0-145" id="h8-0-145" class="i">+                    if (pendingTask != null &amp;&amp; !taskStatus.isFinalStage()) {
</a><a href="#h8-0-146" id="h8-0-146" class="i">+                        CircularProgressIndicator(modifier = Modifier.size(30.dp))
</a><a href="#h8-0-147" id="h8-0-147" class="i">+                    } else {
</a><a href="#h8-0-148" id="h8-0-148" class="i">+                        when (taskStatus) {
</a><a href="#h8-0-149" id="h8-0-149" class="i">+                            TaskStatus.SUCCESS -&gt; Icon(Icons.Filled.Check, contentDescription = &quot;Success&quot;, tint = MaterialTheme.colorScheme.primary)
</a><a href="#h8-0-150" id="h8-0-150" class="i">+                            TaskStatus.FAILURE -&gt; Icon(Icons.Filled.Error, contentDescription = &quot;Failure&quot;, tint = MaterialTheme.colorScheme.error)
</a><a href="#h8-0-151" id="h8-0-151" class="i">+                            TaskStatus.CANCELLED -&gt; Icon(Icons.Filled.Cancel, contentDescription = &quot;Cancelled&quot;, tint = MaterialTheme.colorScheme.error)
</a><a href="#h8-0-152" id="h8-0-152" class="i">+                            else -&gt; {}
</a><a href="#h8-0-153" id="h8-0-153" class="i">+                        }
</a><a href="#h8-0-154" id="h8-0-154" class="i">+                    }
</a><a href="#h8-0-155" id="h8-0-155" class="i">+                }
</a><a href="#h8-0-156" id="h8-0-156" class="i">+            }
</a><a href="#h8-0-157" id="h8-0-157" class="i">+        }
</a><a href="#h8-0-158" id="h8-0-158" class="i">+    }
</a><a href="#h8-0-159" id="h8-0-159" class="i">+
</a><a href="#h8-0-160" id="h8-0-160" class="i">+    @Preview
</a><a href="#h8-0-161" id="h8-0-161" class="i">+    @Composable
</a><a href="#h8-0-162" id="h8-0-162" class="i">+    override fun Content() {
</a><a href="#h8-0-163" id="h8-0-163" class="i">+        val scrollState = rememberLazyListState()
</a><a href="#h8-0-164" id="h8-0-164" class="i">+        val scope = rememberCoroutineScope()
</a><a href="#h8-0-165" id="h8-0-165" class="i">+        activeTasks = remember { mutableStateMapOf() }
</a><a href="#h8-0-166" id="h8-0-166" class="i">+        recentTasks = remember { mutableStateListOf() }
</a><a href="#h8-0-167" id="h8-0-167" class="i">+        var lastFetchedTaskId: Long? by remember { mutableStateOf(null) }
</a><a href="#h8-0-168" id="h8-0-168" class="i">+
</a><a href="#h8-0-169" id="h8-0-169" class="i">+        fun fetchNewRecentTasks() {
</a><a href="#h8-0-170" id="h8-0-170" class="i">+            scope.launch(Dispatchers.IO) {
</a><a href="#h8-0-171" id="h8-0-171" class="i">+                val tasks = context.taskManager.fetchStoredTasks(lastFetchedTaskId ?: Long.MAX_VALUE)
</a><a href="#h8-0-172" id="h8-0-172" class="i">+                if (tasks.isNotEmpty()) {
</a><a href="#h8-0-173" id="h8-0-173" class="i">+                    lastFetchedTaskId = tasks.keys.last()
</a><a href="#h8-0-174" id="h8-0-174" class="i">+                    recentTasks.addAll(tasks.filter { !activeTasks.containsKey(it.key) }.values)
</a><a href="#h8-0-175" id="h8-0-175" class="i">+                }
</a><a href="#h8-0-176" id="h8-0-176" class="i">+            }
</a><a href="#h8-0-177" id="h8-0-177" class="i">+        }
</a><a href="#h8-0-178" id="h8-0-178" class="i">+
</a><a href="#h8-0-179" id="h8-0-179" class="i">+        fun fetchActiveTasks() {
</a><a href="#h8-0-180" id="h8-0-180" class="i">+            scope.launch {
</a><a href="#h8-0-181" id="h8-0-181" class="i">+                activeTasks.clear()
</a><a href="#h8-0-182" id="h8-0-182" class="i">+                activeTasks.putAll(context.taskManager.getActiveTasks())
</a><a href="#h8-0-183" id="h8-0-183" class="i">+            }
</a><a href="#h8-0-184" id="h8-0-184" class="i">+        }
</a><a href="#h8-0-185" id="h8-0-185" class="i">+
</a><a href="#h8-0-186" id="h8-0-186" class="i">+        SideEffect {
</a><a href="#h8-0-187" id="h8-0-187" class="i">+            fetchActiveTasks()
</a><a href="#h8-0-188" id="h8-0-188" class="i">+        }
</a><a href="#h8-0-189" id="h8-0-189" class="i">+
</a><a href="#h8-0-190" id="h8-0-190" class="i">+        OnLifecycleEvent { _, event -&gt;
</a><a href="#h8-0-191" id="h8-0-191" class="i">+            when (event) {
</a><a href="#h8-0-192" id="h8-0-192" class="i">+                Lifecycle.Event.ON_RESUME -&gt; {
</a><a href="#h8-0-193" id="h8-0-193" class="i">+                    fetchActiveTasks()
</a><a href="#h8-0-194" id="h8-0-194" class="i">+                }
</a><a href="#h8-0-195" id="h8-0-195" class="i">+                else -&gt; {}
</a><a href="#h8-0-196" id="h8-0-196" class="i">+            }
</a><a href="#h8-0-197" id="h8-0-197" class="i">+        }
</a><a href="#h8-0-198" id="h8-0-198" class="i">+
</a><a href="#h8-0-199" id="h8-0-199" class="i">+        LazyColumn(
</a><a href="#h8-0-200" id="h8-0-200" class="i">+            state = scrollState,
</a><a href="#h8-0-201" id="h8-0-201" class="i">+            modifier = Modifier.fillMaxSize()
</a><a href="#h8-0-202" id="h8-0-202" class="i">+        ) {
</a><a href="#h8-0-203" id="h8-0-203" class="i">+            item {
</a><a href="#h8-0-204" id="h8-0-204" class="i">+                if (activeTasks.isEmpty() &amp;&amp; recentTasks.isEmpty()) {
</a><a href="#h8-0-205" id="h8-0-205" class="i">+                    Column(
</a><a href="#h8-0-206" id="h8-0-206" class="i">+                        modifier = Modifier.fillMaxSize(),
</a><a href="#h8-0-207" id="h8-0-207" class="i">+                        horizontalAlignment = Alignment.CenterHorizontally,
</a><a href="#h8-0-208" id="h8-0-208" class="i">+                        verticalArrangement = Arrangement.Center
</a><a href="#h8-0-209" id="h8-0-209" class="i">+                    ) {
</a><a href="#h8-0-210" id="h8-0-210" class="i">+                        Icon(Icons.Filled.CheckCircle, contentDescription = &quot;No tasks&quot;, tint = MaterialTheme.colorScheme.primary)
</a><a href="#h8-0-211" id="h8-0-211" class="i">+                        Text(&quot;No tasks&quot;, style = MaterialTheme.typography.bodyLarge)
</a><a href="#h8-0-212" id="h8-0-212" class="i">+                    }
</a><a href="#h8-0-213" id="h8-0-213" class="i">+                }
</a><a href="#h8-0-214" id="h8-0-214" class="i">+            }
</a><a href="#h8-0-215" id="h8-0-215" class="i">+            items(activeTasks.size) { index -&gt;
</a><a href="#h8-0-216" id="h8-0-216" class="i">+                val pendingTask = activeTasks.values.elementAt(index)
</a><a href="#h8-0-217" id="h8-0-217" class="i">+                TaskCard(modifier = Modifier.padding(8.dp), pendingTask.task, pendingTask = pendingTask)
</a><a href="#h8-0-218" id="h8-0-218" class="i">+            }
</a><a href="#h8-0-219" id="h8-0-219" class="i">+            items(recentTasks) { task -&gt;
</a><a href="#h8-0-220" id="h8-0-220" class="i">+                TaskCard(modifier = Modifier.padding(8.dp), task)
</a><a href="#h8-0-221" id="h8-0-221" class="i">+            }
</a><a href="#h8-0-222" id="h8-0-222" class="i">+            item {
</a><a href="#h8-0-223" id="h8-0-223" class="i">+                Spacer(modifier = Modifier.height(20.dp))
</a><a href="#h8-0-224" id="h8-0-224" class="i">+                SideEffect {
</a><a href="#h8-0-225" id="h8-0-225" class="i">+                    fetchNewRecentTasks()
</a><a href="#h8-0-226" id="h8-0-226" class="i">+                }
</a><a href="#h8-0-227" id="h8-0-227" class="i">+            }
</a><a href="#h8-0-228" id="h8-0-228" class="i">+        }
</a><a href="#h8-0-229" id="h8-0-229" class="i">+    }
</a><a href="#h8-0-230" id="h8-0-230" class="i">+}</a><a href="#h8-0-231" id="h8-0-231" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h9" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/downloads/DownloadsSection.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/downloads/DownloadsSection.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/downloads/DownloadsSection.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/downloads/DownloadsSection.kt</a></b>
<a href="#h9-0" id="h9-0" class="h">@@ -1,268 +0,0 @@
</a><a href="#h9-0-0" id="h9-0-0" class="d">-package me.rhunk.snapenhance.ui.manager.sections.downloads
</a><a href="#h9-0-1" id="h9-0-1" class="d">-
</a><a href="#h9-0-2" id="h9-0-2" class="d">-import android.content.Intent
</a><a href="#h9-0-3" id="h9-0-3" class="d">-import android.net.Uri
</a><a href="#h9-0-4" id="h9-0-4" class="d">-import androidx.compose.foundation.Image
</a><a href="#h9-0-5" id="h9-0-5" class="d">-import androidx.compose.foundation.background
</a><a href="#h9-0-6" id="h9-0-6" class="d">-import androidx.compose.foundation.layout.*
</a><a href="#h9-0-7" id="h9-0-7" class="d">-import androidx.compose.foundation.lazy.LazyColumn
</a><a href="#h9-0-8" id="h9-0-8" class="d">-import androidx.compose.foundation.lazy.rememberLazyListState
</a><a href="#h9-0-9" id="h9-0-9" class="d">-import androidx.compose.material.icons.Icons
</a><a href="#h9-0-10" id="h9-0-10" class="d">-import androidx.compose.material.icons.automirrored.filled.OpenInNew
</a><a href="#h9-0-11" id="h9-0-11" class="d">-import androidx.compose.material.icons.filled.Delete
</a><a href="#h9-0-12" id="h9-0-12" class="d">-import androidx.compose.material.icons.filled.FilterList
</a><a href="#h9-0-13" id="h9-0-13" class="d">-import androidx.compose.material3.*
</a><a href="#h9-0-14" id="h9-0-14" class="d">-import androidx.compose.runtime.*
</a><a href="#h9-0-15" id="h9-0-15" class="d">-import androidx.compose.ui.Alignment
</a><a href="#h9-0-16" id="h9-0-16" class="d">-import androidx.compose.ui.Modifier
</a><a href="#h9-0-17" id="h9-0-17" class="d">-import androidx.compose.ui.draw.blur
</a><a href="#h9-0-18" id="h9-0-18" class="d">-import androidx.compose.ui.draw.clip
</a><a href="#h9-0-19" id="h9-0-19" class="d">-import androidx.compose.ui.graphics.FilterQuality
</a><a href="#h9-0-20" id="h9-0-20" class="d">-import androidx.compose.ui.layout.ContentScale
</a><a href="#h9-0-21" id="h9-0-21" class="d">-import androidx.compose.ui.text.font.FontWeight
</a><a href="#h9-0-22" id="h9-0-22" class="d">-import androidx.compose.ui.text.style.TextAlign
</a><a href="#h9-0-23" id="h9-0-23" class="d">-import androidx.compose.ui.text.style.TextOverflow
</a><a href="#h9-0-24" id="h9-0-24" class="d">-import androidx.compose.ui.unit.dp
</a><a href="#h9-0-25" id="h9-0-25" class="d">-import androidx.compose.ui.unit.sp
</a><a href="#h9-0-26" id="h9-0-26" class="d">-import coil.compose.rememberAsyncImagePainter
</a><a href="#h9-0-27" id="h9-0-27" class="d">-import kotlinx.coroutines.Dispatchers
</a><a href="#h9-0-28" id="h9-0-28" class="d">-import kotlinx.coroutines.future.asCompletableFuture
</a><a href="#h9-0-29" id="h9-0-29" class="d">-import kotlinx.coroutines.launch
</a><a href="#h9-0-30" id="h9-0-30" class="d">-import me.rhunk.snapenhance.common.data.FileType
</a><a href="#h9-0-31" id="h9-0-31" class="d">-import me.rhunk.snapenhance.common.data.download.MediaDownloadSource
</a><a href="#h9-0-32" id="h9-0-32" class="d">-import me.rhunk.snapenhance.download.DownloadObject
</a><a href="#h9-0-33" id="h9-0-33" class="d">-import me.rhunk.snapenhance.ui.manager.Section
</a><a href="#h9-0-34" id="h9-0-34" class="d">-import me.rhunk.snapenhance.ui.util.BitmojiImage
</a><a href="#h9-0-35" id="h9-0-35" class="d">-import me.rhunk.snapenhance.ui.util.ImageRequestHelper
</a><a href="#h9-0-36" id="h9-0-36" class="d">-
</a><a href="#h9-0-37" id="h9-0-37" class="d">-class DownloadsSection : Section() {
</a><a href="#h9-0-38" id="h9-0-38" class="d">-    private val loadedDownloads = mutableStateOf(mapOf&lt;Int, DownloadObject&gt;())
</a><a href="#h9-0-39" id="h9-0-39" class="d">-    private var currentFilter = mutableStateOf(MediaDownloadSource.NONE)
</a><a href="#h9-0-40" id="h9-0-40" class="d">-
</a><a href="#h9-0-41" id="h9-0-41" class="d">-    override fun onResumed() {
</a><a href="#h9-0-42" id="h9-0-42" class="d">-        super.onResumed()
</a><a href="#h9-0-43" id="h9-0-43" class="d">-        context.coroutineScope.launch {
</a><a href="#h9-0-44" id="h9-0-44" class="d">-            loadByFilter(currentFilter.value)
</a><a href="#h9-0-45" id="h9-0-45" class="d">-        }
</a><a href="#h9-0-46" id="h9-0-46" class="d">-    }
</a><a href="#h9-0-47" id="h9-0-47" class="d">-
</a><a href="#h9-0-48" id="h9-0-48" class="d">-    private fun loadByFilter(filter: MediaDownloadSource) {
</a><a href="#h9-0-49" id="h9-0-49" class="d">-        this.currentFilter.value = filter
</a><a href="#h9-0-50" id="h9-0-50" class="d">-        synchronized(loadedDownloads) {
</a><a href="#h9-0-51" id="h9-0-51" class="d">-            loadedDownloads.value = context.downloadTaskManager.queryFirstTasks(filter).toMutableMap()
</a><a href="#h9-0-52" id="h9-0-52" class="d">-        }
</a><a href="#h9-0-53" id="h9-0-53" class="d">-    }
</a><a href="#h9-0-54" id="h9-0-54" class="d">-
</a><a href="#h9-0-55" id="h9-0-55" class="d">-    private fun removeTask(download: DownloadObject) {
</a><a href="#h9-0-56" id="h9-0-56" class="d">-        synchronized(loadedDownloads) {
</a><a href="#h9-0-57" id="h9-0-57" class="d">-            loadedDownloads.value = loadedDownloads.value.toMutableMap().also {
</a><a href="#h9-0-58" id="h9-0-58" class="d">-                it.remove(download.downloadId)
</a><a href="#h9-0-59" id="h9-0-59" class="d">-            }
</a><a href="#h9-0-60" id="h9-0-60" class="d">-            context.downloadTaskManager.removeTask(download)
</a><a href="#h9-0-61" id="h9-0-61" class="d">-        }
</a><a href="#h9-0-62" id="h9-0-62" class="d">-    }
</a><a href="#h9-0-63" id="h9-0-63" class="d">-
</a><a href="#h9-0-64" id="h9-0-64" class="d">-    private fun lazyLoadFromIndex(lastIndex: Int) {
</a><a href="#h9-0-65" id="h9-0-65" class="d">-        synchronized(loadedDownloads) {
</a><a href="#h9-0-66" id="h9-0-66" class="d">-            loadedDownloads.value = loadedDownloads.value.toMutableMap().also {
</a><a href="#h9-0-67" id="h9-0-67" class="d">-                val lastVisible = loadedDownloads.value.values.elementAt(lastIndex)
</a><a href="#h9-0-68" id="h9-0-68" class="d">-                it += context.downloadTaskManager.queryTasks(
</a><a href="#h9-0-69" id="h9-0-69" class="d">-                    from = lastVisible.downloadId,
</a><a href="#h9-0-70" id="h9-0-70" class="d">-                    filter = currentFilter.value
</a><a href="#h9-0-71" id="h9-0-71" class="d">-                )
</a><a href="#h9-0-72" id="h9-0-72" class="d">-            }
</a><a href="#h9-0-73" id="h9-0-73" class="d">-        }
</a><a href="#h9-0-74" id="h9-0-74" class="d">-    }
</a><a href="#h9-0-75" id="h9-0-75" class="d">-
</a><a href="#h9-0-76" id="h9-0-76" class="d">-    @Composable
</a><a href="#h9-0-77" id="h9-0-77" class="d">-    private fun FilterList() {
</a><a href="#h9-0-78" id="h9-0-78" class="d">-        var showMenu by remember { mutableStateOf(false) }
</a><a href="#h9-0-79" id="h9-0-79" class="d">-        IconButton(onClick = { showMenu = !showMenu}) {
</a><a href="#h9-0-80" id="h9-0-80" class="d">-            Icon(
</a><a href="#h9-0-81" id="h9-0-81" class="d">-                imageVector = Icons.Default.FilterList,
</a><a href="#h9-0-82" id="h9-0-82" class="d">-                contentDescription = null
</a><a href="#h9-0-83" id="h9-0-83" class="d">-            )
</a><a href="#h9-0-84" id="h9-0-84" class="d">-        }
</a><a href="#h9-0-85" id="h9-0-85" class="d">-
</a><a href="#h9-0-86" id="h9-0-86" class="d">-        DropdownMenu(expanded = showMenu, onDismissRequest = { showMenu = false }) {
</a><a href="#h9-0-87" id="h9-0-87" class="d">-            MediaDownloadSource.entries.forEach { filter -&gt;
</a><a href="#h9-0-88" id="h9-0-88" class="d">-                DropdownMenuItem(
</a><a href="#h9-0-89" id="h9-0-89" class="d">-                    text = {
</a><a href="#h9-0-90" id="h9-0-90" class="d">-                        Row(
</a><a href="#h9-0-91" id="h9-0-91" class="d">-                            modifier = Modifier
</a><a href="#h9-0-92" id="h9-0-92" class="d">-                                .fillMaxWidth(),
</a><a href="#h9-0-93" id="h9-0-93" class="d">-                            verticalAlignment = Alignment.CenterVertically
</a><a href="#h9-0-94" id="h9-0-94" class="d">-                        ) {
</a><a href="#h9-0-95" id="h9-0-95" class="d">-                            RadioButton(
</a><a href="#h9-0-96" id="h9-0-96" class="d">-                                modifier = Modifier.padding(end = 16.dp),
</a><a href="#h9-0-97" id="h9-0-97" class="d">-                                selected = (currentFilter.value == filter),
</a><a href="#h9-0-98" id="h9-0-98" class="d">-                                onClick = null
</a><a href="#h9-0-99" id="h9-0-99" class="d">-                            )
</a><a href="#h9-0-100" id="h9-0-100" class="d">-                            Text(filter.displayName, modifier = Modifier.weight(1f))
</a><a href="#h9-0-101" id="h9-0-101" class="d">-                        }
</a><a href="#h9-0-102" id="h9-0-102" class="d">-                   },
</a><a href="#h9-0-103" id="h9-0-103" class="d">-                    onClick = {
</a><a href="#h9-0-104" id="h9-0-104" class="d">-                        context.coroutineScope.launch {
</a><a href="#h9-0-105" id="h9-0-105" class="d">-                            loadByFilter(filter)
</a><a href="#h9-0-106" id="h9-0-106" class="d">-                            showMenu = false
</a><a href="#h9-0-107" id="h9-0-107" class="d">-                        }
</a><a href="#h9-0-108" id="h9-0-108" class="d">-                    }
</a><a href="#h9-0-109" id="h9-0-109" class="d">-                )
</a><a href="#h9-0-110" id="h9-0-110" class="d">-            }
</a><a href="#h9-0-111" id="h9-0-111" class="d">-        }
</a><a href="#h9-0-112" id="h9-0-112" class="d">-    }
</a><a href="#h9-0-113" id="h9-0-113" class="d">-
</a><a href="#h9-0-114" id="h9-0-114" class="d">-    @Composable
</a><a href="#h9-0-115" id="h9-0-115" class="d">-    override fun TopBarActions(rowScope: RowScope) {
</a><a href="#h9-0-116" id="h9-0-116" class="d">-        FilterList()
</a><a href="#h9-0-117" id="h9-0-117" class="d">-    }
</a><a href="#h9-0-118" id="h9-0-118" class="d">-
</a><a href="#h9-0-119" id="h9-0-119" class="d">-    @Composable
</a><a href="#h9-0-120" id="h9-0-120" class="d">-    private fun DownloadItem(download: DownloadObject) {
</a><a href="#h9-0-121" id="h9-0-121" class="d">-        Card(
</a><a href="#h9-0-122" id="h9-0-122" class="d">-            modifier = Modifier
</a><a href="#h9-0-123" id="h9-0-123" class="d">-                .padding(6.dp)
</a><a href="#h9-0-124" id="h9-0-124" class="d">-                .fillMaxWidth()
</a><a href="#h9-0-125" id="h9-0-125" class="d">-                .clip(MaterialTheme.shapes.medium)
</a><a href="#h9-0-126" id="h9-0-126" class="d">-        ) {
</a><a href="#h9-0-127" id="h9-0-127" class="d">-            Box(modifier = Modifier.height(100.dp)) {
</a><a href="#h9-0-128" id="h9-0-128" class="d">-                Image(
</a><a href="#h9-0-129" id="h9-0-129" class="d">-                    painter = rememberAsyncImagePainter(
</a><a href="#h9-0-130" id="h9-0-130" class="d">-                        model = ImageRequestHelper.newDownloadPreviewImageRequest(
</a><a href="#h9-0-131" id="h9-0-131" class="d">-                            context.androidContext,
</a><a href="#h9-0-132" id="h9-0-132" class="d">-                            download.outputFile
</a><a href="#h9-0-133" id="h9-0-133" class="d">-                        ),
</a><a href="#h9-0-134" id="h9-0-134" class="d">-                        imageLoader = context.imageLoader,
</a><a href="#h9-0-135" id="h9-0-135" class="d">-                        filterQuality = FilterQuality.None,
</a><a href="#h9-0-136" id="h9-0-136" class="d">-                    ),
</a><a href="#h9-0-137" id="h9-0-137" class="d">-                    modifier = Modifier
</a><a href="#h9-0-138" id="h9-0-138" class="d">-                        .matchParentSize()
</a><a href="#h9-0-139" id="h9-0-139" class="d">-                        .blur(5.dp),
</a><a href="#h9-0-140" id="h9-0-140" class="d">-                    contentDescription = null,
</a><a href="#h9-0-141" id="h9-0-141" class="d">-                    contentScale = ContentScale.FillWidth
</a><a href="#h9-0-142" id="h9-0-142" class="d">-                )
</a><a href="#h9-0-143" id="h9-0-143" class="d">-
</a><a href="#h9-0-144" id="h9-0-144" class="d">-                Row(
</a><a href="#h9-0-145" id="h9-0-145" class="d">-                    modifier = Modifier
</a><a href="#h9-0-146" id="h9-0-146" class="d">-                        .padding(start = 10.dp, end = 10.dp)
</a><a href="#h9-0-147" id="h9-0-147" class="d">-                        .fillMaxHeight(),
</a><a href="#h9-0-148" id="h9-0-148" class="d">-
</a><a href="#h9-0-149" id="h9-0-149" class="d">-                    verticalAlignment = Alignment.CenterVertically,
</a><a href="#h9-0-150" id="h9-0-150" class="d">-                ){
</a><a href="#h9-0-151" id="h9-0-151" class="d">-                    //info card
</a><a href="#h9-0-152" id="h9-0-152" class="d">-                    Row(
</a><a href="#h9-0-153" id="h9-0-153" class="d">-                        modifier = Modifier
</a><a href="#h9-0-154" id="h9-0-154" class="d">-                            .background(
</a><a href="#h9-0-155" id="h9-0-155" class="d">-                                color = MaterialTheme.colorScheme.background,
</a><a href="#h9-0-156" id="h9-0-156" class="d">-                                shape = MaterialTheme.shapes.medium
</a><a href="#h9-0-157" id="h9-0-157" class="d">-                            )
</a><a href="#h9-0-158" id="h9-0-158" class="d">-                            .padding(15.dp),
</a><a href="#h9-0-159" id="h9-0-159" class="d">-                        verticalAlignment = Alignment.CenterVertically
</a><a href="#h9-0-160" id="h9-0-160" class="d">-                    ) {
</a><a href="#h9-0-161" id="h9-0-161" class="d">-                        BitmojiImage(context = context, url = download.metadata.iconUrl, size = 48)
</a><a href="#h9-0-162" id="h9-0-162" class="d">-                        Column(
</a><a href="#h9-0-163" id="h9-0-163" class="d">-                            modifier = Modifier
</a><a href="#h9-0-164" id="h9-0-164" class="d">-                                .padding(start = 10.dp),
</a><a href="#h9-0-165" id="h9-0-165" class="d">-                            verticalArrangement = Arrangement.SpaceBetween
</a><a href="#h9-0-166" id="h9-0-166" class="d">-                        ) {
</a><a href="#h9-0-167" id="h9-0-167" class="d">-                            Text(
</a><a href="#h9-0-168" id="h9-0-168" class="d">-                                text = MediaDownloadSource.fromKey(download.metadata.downloadSource).displayName,
</a><a href="#h9-0-169" id="h9-0-169" class="d">-                                overflow = TextOverflow.Ellipsis,
</a><a href="#h9-0-170" id="h9-0-170" class="d">-                                fontSize = 16.sp,
</a><a href="#h9-0-171" id="h9-0-171" class="d">-                                fontWeight = FontWeight.Bold
</a><a href="#h9-0-172" id="h9-0-172" class="d">-                            )
</a><a href="#h9-0-173" id="h9-0-173" class="d">-                            Text(
</a><a href="#h9-0-174" id="h9-0-174" class="d">-                                text = download.metadata.mediaAuthor ?: &quot;&quot;,
</a><a href="#h9-0-175" id="h9-0-175" class="d">-                                overflow = TextOverflow.Ellipsis,
</a><a href="#h9-0-176" id="h9-0-176" class="d">-                                fontSize = 12.sp,
</a><a href="#h9-0-177" id="h9-0-177" class="d">-                                fontWeight = FontWeight.Light
</a><a href="#h9-0-178" id="h9-0-178" class="d">-                            )
</a><a href="#h9-0-179" id="h9-0-179" class="d">-                        }
</a><a href="#h9-0-180" id="h9-0-180" class="d">-                    }
</a><a href="#h9-0-181" id="h9-0-181" class="d">-
</a><a href="#h9-0-182" id="h9-0-182" class="d">-                    //action buttons
</a><a href="#h9-0-183" id="h9-0-183" class="d">-                    Row(
</a><a href="#h9-0-184" id="h9-0-184" class="d">-                        modifier = Modifier
</a><a href="#h9-0-185" id="h9-0-185" class="d">-                            .padding(5.dp)
</a><a href="#h9-0-186" id="h9-0-186" class="d">-                            .fillMaxWidth(),
</a><a href="#h9-0-187" id="h9-0-187" class="d">-                        horizontalArrangement = Arrangement.End,
</a><a href="#h9-0-188" id="h9-0-188" class="d">-                        verticalAlignment = Alignment.CenterVertically
</a><a href="#h9-0-189" id="h9-0-189" class="d">-                    ) {
</a><a href="#h9-0-190" id="h9-0-190" class="d">-                        FilledIconButton(
</a><a href="#h9-0-191" id="h9-0-191" class="d">-                            onClick = {
</a><a href="#h9-0-192" id="h9-0-192" class="d">-                                removeTask(download)
</a><a href="#h9-0-193" id="h9-0-193" class="d">-                            },
</a><a href="#h9-0-194" id="h9-0-194" class="d">-                            colors = IconButtonDefaults.iconButtonColors(
</a><a href="#h9-0-195" id="h9-0-195" class="d">-                                containerColor = MaterialTheme.colorScheme.error,
</a><a href="#h9-0-196" id="h9-0-196" class="d">-                                contentColor = MaterialTheme.colorScheme.onError
</a><a href="#h9-0-197" id="h9-0-197" class="d">-                            )
</a><a href="#h9-0-198" id="h9-0-198" class="d">-                        ) {
</a><a href="#h9-0-199" id="h9-0-199" class="d">-                            Icon(
</a><a href="#h9-0-200" id="h9-0-200" class="d">-                                imageVector = Icons.Default.Delete,
</a><a href="#h9-0-201" id="h9-0-201" class="d">-                                contentDescription = null
</a><a href="#h9-0-202" id="h9-0-202" class="d">-                            )
</a><a href="#h9-0-203" id="h9-0-203" class="d">-                        }
</a><a href="#h9-0-204" id="h9-0-204" class="d">-                        //open
</a><a href="#h9-0-205" id="h9-0-205" class="d">-                        FilledIconButton(onClick = {
</a><a href="#h9-0-206" id="h9-0-206" class="d">-                            if (download.outputFile == null) return@FilledIconButton
</a><a href="#h9-0-207" id="h9-0-207" class="d">-                            val fileType = runCatching {
</a><a href="#h9-0-208" id="h9-0-208" class="d">-                                context.androidContext.contentResolver.openInputStream(Uri.parse(download.outputFile))?.use { input -&gt;
</a><a href="#h9-0-209" id="h9-0-209" class="d">-                                    FileType.fromInputStream(input)
</a><a href="#h9-0-210" id="h9-0-210" class="d">-                                }
</a><a href="#h9-0-211" id="h9-0-211" class="d">-                            }.getOrNull() ?: FileType.UNKNOWN
</a><a href="#h9-0-212" id="h9-0-212" class="d">-
</a><a href="#h9-0-213" id="h9-0-213" class="d">-                            val intent = Intent(Intent.ACTION_VIEW).apply {
</a><a href="#h9-0-214" id="h9-0-214" class="d">-                                setDataAndType(Uri.parse(download.outputFile), fileType.mimeType)
</a><a href="#h9-0-215" id="h9-0-215" class="d">-                                flags = Intent.FLAG_ACTIVITY_NEW_TASK or Intent.FLAG_GRANT_READ_URI_PERMISSION
</a><a href="#h9-0-216" id="h9-0-216" class="d">-                            }
</a><a href="#h9-0-217" id="h9-0-217" class="d">-                            context.androidContext.startActivity(intent)
</a><a href="#h9-0-218" id="h9-0-218" class="d">-                        }) {
</a><a href="#h9-0-219" id="h9-0-219" class="d">-                            Icon(
</a><a href="#h9-0-220" id="h9-0-220" class="d">-                                imageVector = Icons.AutoMirrored.Filled.OpenInNew,
</a><a href="#h9-0-221" id="h9-0-221" class="d">-                                contentDescription = null
</a><a href="#h9-0-222" id="h9-0-222" class="d">-                            )
</a><a href="#h9-0-223" id="h9-0-223" class="d">-                        }
</a><a href="#h9-0-224" id="h9-0-224" class="d">-                    }
</a><a href="#h9-0-225" id="h9-0-225" class="d">-                }
</a><a href="#h9-0-226" id="h9-0-226" class="d">-            }
</a><a href="#h9-0-227" id="h9-0-227" class="d">-        }
</a><a href="#h9-0-228" id="h9-0-228" class="d">-    }
</a><a href="#h9-0-229" id="h9-0-229" class="d">-
</a><a href="#h9-0-230" id="h9-0-230" class="d">-    @Composable
</a><a href="#h9-0-231" id="h9-0-231" class="d">-    override fun Content() {
</a><a href="#h9-0-232" id="h9-0-232" class="d">-        val scrollState = rememberLazyListState()
</a><a href="#h9-0-233" id="h9-0-233" class="d">-        val scope = rememberCoroutineScope()
</a><a href="#h9-0-234" id="h9-0-234" class="d">-
</a><a href="#h9-0-235" id="h9-0-235" class="d">-        LazyColumn(
</a><a href="#h9-0-236" id="h9-0-236" class="d">-            state = scrollState,
</a><a href="#h9-0-237" id="h9-0-237" class="d">-            modifier = Modifier.fillMaxSize()
</a><a href="#h9-0-238" id="h9-0-238" class="d">-        ) {
</a><a href="#h9-0-239" id="h9-0-239" class="d">-            items(loadedDownloads.value.size) { index -&gt;
</a><a href="#h9-0-240" id="h9-0-240" class="d">-                DownloadItem(loadedDownloads.value.values.elementAt(index))
</a><a href="#h9-0-241" id="h9-0-241" class="d">-            }
</a><a href="#h9-0-242" id="h9-0-242" class="d">-
</a><a href="#h9-0-243" id="h9-0-243" class="d">-            item {
</a><a href="#h9-0-244" id="h9-0-244" class="d">-                Spacer(Modifier.height(20.dp))
</a><a href="#h9-0-245" id="h9-0-245" class="d">-                if (loadedDownloads.value.isEmpty()) {
</a><a href="#h9-0-246" id="h9-0-246" class="d">-                    Text(
</a><a href="#h9-0-247" id="h9-0-247" class="d">-                        text = context.translation[&quot;manager.sections.downloads.empty_download_list&quot;],
</a><a href="#h9-0-248" id="h9-0-248" class="d">-                        fontSize = 20.sp,
</a><a href="#h9-0-249" id="h9-0-249" class="d">-                        modifier = Modifier
</a><a href="#h9-0-250" id="h9-0-250" class="d">-                        .fillMaxWidth()
</a><a href="#h9-0-251" id="h9-0-251" class="d">-                        .padding(10.dp), textAlign = TextAlign.Center
</a><a href="#h9-0-252" id="h9-0-252" class="d">-                    )
</a><a href="#h9-0-253" id="h9-0-253" class="d">-                }
</a><a href="#h9-0-254" id="h9-0-254" class="d">-                LaunchedEffect(Unit) {
</a><a href="#h9-0-255" id="h9-0-255" class="d">-                    val lastItemIndex = (loadedDownloads.value.size - 1).takeIf { it &gt;= 0 } ?: return@LaunchedEffect
</a><a href="#h9-0-256" id="h9-0-256" class="d">-                    scope.launch(Dispatchers.IO) {
</a><a href="#h9-0-257" id="h9-0-257" class="d">-                        lazyLoadFromIndex(lastItemIndex)
</a><a href="#h9-0-258" id="h9-0-258" class="d">-                    }.asCompletableFuture().thenAccept {
</a><a href="#h9-0-259" id="h9-0-259" class="d">-                        scope.launch {
</a><a href="#h9-0-260" id="h9-0-260" class="d">-                            scrollState.animateScrollToItem(lastItemIndex)
</a><a href="#h9-0-261" id="h9-0-261" class="d">-                        }
</a><a href="#h9-0-262" id="h9-0-262" class="d">-                    }
</a><a href="#h9-0-263" id="h9-0-263" class="d">-                }
</a><a href="#h9-0-264" id="h9-0-264" class="d">-            }
</a><a href="#h9-0-265" id="h9-0-265" class="d">-        }
</a><a href="#h9-0-266" id="h9-0-266" class="d">-    }
</a><a href="#h9-0-267" id="h9-0-267" class="d">-}</a><a href="#h9-0-268" id="h9-0-268" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h10" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/util/LifecycleHelper.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/util/LifecycleHelper.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/util/LifecycleHelper.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/util/LifecycleHelper.kt</a></b>
<a href="#h10-0" id="h10-0" class="h">@@ -0,0 +1,28 @@
</a><a href="#h10-0-0" id="h10-0-0" class="i">+package me.rhunk.snapenhance.ui.util
</a><a href="#h10-0-1" id="h10-0-1" class="i">+
</a><a href="#h10-0-2" id="h10-0-2" class="i">+import androidx.compose.runtime.Composable
</a><a href="#h10-0-3" id="h10-0-3" class="i">+import androidx.compose.runtime.DisposableEffect
</a><a href="#h10-0-4" id="h10-0-4" class="i">+import androidx.compose.runtime.rememberUpdatedState
</a><a href="#h10-0-5" id="h10-0-5" class="i">+import androidx.compose.ui.platform.LocalLifecycleOwner
</a><a href="#h10-0-6" id="h10-0-6" class="i">+import androidx.lifecycle.Lifecycle
</a><a href="#h10-0-7" id="h10-0-7" class="i">+import androidx.lifecycle.LifecycleEventObserver
</a><a href="#h10-0-8" id="h10-0-8" class="i">+import androidx.lifecycle.LifecycleOwner
</a><a href="#h10-0-9" id="h10-0-9" class="i">+
</a><a href="#h10-0-10" id="h10-0-10" class="i">+//https://stackoverflow.com/questions/66546962/jetpack-compose-how-do-i-refresh-a-screen-when-app-returns-to-foreground
</a><a href="#h10-0-11" id="h10-0-11" class="i">+@Composable
</a><a href="#h10-0-12" id="h10-0-12" class="i">+fun OnLifecycleEvent(onEvent: (owner: LifecycleOwner, event: Lifecycle.Event) -&gt; Unit) {
</a><a href="#h10-0-13" id="h10-0-13" class="i">+    val eventHandler = rememberUpdatedState(onEvent)
</a><a href="#h10-0-14" id="h10-0-14" class="i">+    val lifecycleOwner = rememberUpdatedState(LocalLifecycleOwner.current)
</a><a href="#h10-0-15" id="h10-0-15" class="i">+
</a><a href="#h10-0-16" id="h10-0-16" class="i">+    DisposableEffect(lifecycleOwner.value) {
</a><a href="#h10-0-17" id="h10-0-17" class="i">+        val lifecycle = lifecycleOwner.value.lifecycle
</a><a href="#h10-0-18" id="h10-0-18" class="i">+        val observer = LifecycleEventObserver { owner, event -&gt;
</a><a href="#h10-0-19" id="h10-0-19" class="i">+            eventHandler.value(owner, event)
</a><a href="#h10-0-20" id="h10-0-20" class="i">+        }
</a><a href="#h10-0-21" id="h10-0-21" class="i">+
</a><a href="#h10-0-22" id="h10-0-22" class="i">+        lifecycle.addObserver(observer)
</a><a href="#h10-0-23" id="h10-0-23" class="i">+        onDispose {
</a><a href="#h10-0-24" id="h10-0-24" class="i">+            lifecycle.removeObserver(observer)
</a><a href="#h10-0-25" id="h10-0-25" class="i">+        }
</a><a href="#h10-0-26" id="h10-0-26" class="i">+    }
</a><a href="#h10-0-27" id="h10-0-27" class="i">+}</a><a href="#h10-0-28" id="h10-0-28" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h11" href="../file/common/src/main/assets/lang/en_US.json.html">common/src/main/assets/lang/en_US.json</a> b/<a href="../file/common/src/main/assets/lang/en_US.json.html">common/src/main/assets/lang/en_US.json</a></b>
<a href="#h11-0" id="h11-0" class="h">@@ -23,7 +23,7 @@
</a> 
     &quot;manager&quot;: {
         &quot;routes&quot;: {
<a href="#h11-0-3" id="h11-0-3" class="d">-            &quot;downloads&quot;: &quot;Downloads&quot;,
</a><a href="#h11-0-4" id="h11-0-4" class="i">+            &quot;tasks&quot;: &quot;Tasks&quot;,
</a>             &quot;features&quot;: &quot;Features&quot;,
             &quot;home&quot;: &quot;Home&quot;,
             &quot;home_settings&quot;: &quot;Settings&quot;,
<b>diff --git a/<a id="h12" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/util/snap/RemoteMediaResolver.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/util/snap/RemoteMediaResolver.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/util/snap/RemoteMediaResolver.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/util/snap/RemoteMediaResolver.kt</a></b>
<a href="#h12-0" id="h12-0" class="h">@@ -53,7 +53,7 @@ object RemoteMediaResolver {
</a>         }
     }
     
<a href="#h12-0-3" id="h12-0-3" class="d">-    fun downloadBoltMedia(protoKey: ByteArray, decryptionCallback: (InputStream) -&gt; InputStream = { it }, resultCallback: (InputStream) -&gt; Unit) {
</a><a href="#h12-0-4" id="h12-0-4" class="i">+    fun downloadBoltMedia(protoKey: ByteArray, decryptionCallback: (InputStream) -&gt; InputStream = { it }, resultCallback: (stream: InputStream, length: Long) -&gt; Unit) {
</a>         okHttpClient.newCall(newResolveRequest(protoKey)).execute().use { response -&gt;
             if (!response.isSuccessful) {
                 throw Throwable(&quot;invalid response ${response.code}&quot;)
<a href="#h12-1" id="h12-1" class="h">@@ -61,7 +61,8 @@ object RemoteMediaResolver {
</a>             resultCallback(
                 decryptionCallback(
                     response.body.byteStream()
<a href="#h12-1-3" id="h12-1-3" class="d">-                )
</a><a href="#h12-1-4" id="h12-1-4" class="i">+                ),
</a><a href="#h12-1-5" id="h12-1-5" class="i">+                response.body.contentLength()
</a>             )
         }
     }
<b>diff --git a/<a id="h13" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/messaging/MessageExporter.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/messaging/MessageExporter.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/messaging/MessageExporter.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/messaging/MessageExporter.kt</a></b>
<a href="#h13-0" id="h13-0" class="h">@@ -122,8 +122,8 @@ class MessageExporter(
</a>                         runCatching {
                             RemoteMediaResolver.downloadBoltMedia(protoMediaReference, decryptionCallback = {
                                 (attachment.attachmentInfo?.encryption?.decryptInputStream(it) ?: it)
<a href="#h13-0-3" id="h13-0-3" class="d">-                            }) {
</a><a href="#h13-0-4" id="h13-0-4" class="d">-                                it.use { inputStream -&gt;
</a><a href="#h13-0-5" id="h13-0-5" class="i">+                            }) { downloadedInputStream, _ -&gt;
</a><a href="#h13-0-6" id="h13-0-6" class="i">+                                downloadedInputStream.use { inputStream -&gt;
</a>                                     MediaDownloaderHelper.getSplitElements(inputStream) { type, splitInputStream -&gt;
                                         val fileName = &quot;${type}_${Base64.UrlSafe.encode(protoMediaReference).replace(&quot;=&quot;, &quot;&quot;)}&quot;
                                         val bufferedInputStream = BufferedInputStream(splitInputStream)
</pre>
</div>
</body>
</html>
