<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>refactor: bridge - SnapEnhance - An Xposed module offering an enhanced Snapchat experience
</title>
<link rel="icon" type="image/svg+xml" href="../../logo.png"/>
<link rel="alternate icon" href="../../favicon.png"/>
<link rel="alternate" type="application/atom+xml" title="SnapEnhance Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="SnapEnhance Atom Feed (tags)" href="../tags.xml" />
<link rel="stylesheet" type="text/css" href="../../style.css" />
<link rel="stylesheet" type="text/css" href="../../fonts.css" />
</head>
<body>
<div id="head"><table><tr><td><a class="logo" href="../../"><img src="../../logo.png" alt="" width="32" height="32" /></a></td><td><strong>SnapEnhance</strong><span class="desc"> - An Xposed module offering an enhanced Snapchat experience
</span>
</td></tr></table>
<p><a href="../about.html">About</a> | <a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/LICENSE.html">License</a></p>
</div>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/a49447ef64a729073cdb42137847e0a9a70b793f.html">a49447ef64a729073cdb42137847e0a9a70b793f</a>
<b>parent</b> <a href="../commit/cd04fd047724f433d8273aa2c29e152d4032cc6a.html">cd04fd047724f433d8273aa2c29e152d4032cc6a</a>
<b>Author:</b> rhunk &lt;<a href="mailto:101876869+rhunk@users.noreply.github.com">101876869+rhunk@users.noreply.github.com</a>&gt;
<b>Date:</b>   Sat,  1 Jun 2024 16:23:54 +0200

refactor: bridge

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">app/src/main/kotlin/me/rhunk/snapenhance/RemoteSideContext.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">app/src/main/kotlin/me/rhunk/snapenhance/bridge/BridgeService.kt</a></td><td> | </td><td class="num">4</td><td><span class="i">++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h2">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/social/MessagingPreview.kt</a></td><td> | </td><td class="num">32</td><td><span class="i">++++++++++++++++++++++</span><span class="d">----------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h3">common/src/main/assets/lang/en_US.json</a></td><td> | </td><td class="num">4</td><td><span class="i">++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h4">core/src/main/kotlin/me/rhunk/snapenhance/core/ModContext.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h5">core/src/main/kotlin/me/rhunk/snapenhance/core/SnapEnhance.kt</a></td><td> | </td><td class="num">105</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++</span><span class="d">--------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h6">core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/BridgeClient.kt</a></td><td> | </td><td class="num">163</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">-------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h7">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/Messaging.kt</a></td><td> | </td><td class="num">10</td><td><span class="i">++++++++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h8">core/src/main/kotlin/me/rhunk/snapenhance/core/util/LSPatchUpdater.kt</a></td><td> | </td><td class="num">5</td><td><span class="i">++</span><span class="d">---</span></td></tr>
</table></pre><pre>9 files changed, 208 insertions(+), 119 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/RemoteSideContext.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/RemoteSideContext.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/RemoteSideContext.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/RemoteSideContext.kt</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -186,7 +186,7 @@ class RemoteSideContext(
</a>         log.debug(message.toString())
     }
 
<a href="#h0-0-3" id="h0-0-3" class="d">-    fun hasMessagingBridge() = bridgeService != null &amp;&amp; bridgeService?.messagingBridge != null
</a><a href="#h0-0-4" id="h0-0-4" class="i">+    fun hasMessagingBridge() = bridgeService != null &amp;&amp; bridgeService?.messagingBridge != null &amp;&amp; bridgeService?.messagingBridge?.asBinder()?.pingBinder() == true
</a> 
     fun checkForRequirements(overrideRequirements: Int? = null): Boolean {
         var requirements = overrideRequirements ?: 0
<b>diff --git a/<a id="h1" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/BridgeService.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/BridgeService.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/BridgeService.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/BridgeService.kt</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -45,6 +45,10 @@ class BridgeService : Service() {
</a> 
     fun triggerScopeSync(scope: SocialScope, id: String, updateOnly: Boolean = false) {
         runCatching {
<a href="#h1-0-3" id="h1-0-3" class="i">+            if (!syncCallback.asBinder().pingBinder()) {
</a><a href="#h1-0-4" id="h1-0-4" class="i">+                remoteSideContext.log.warn(&quot;Failed to sync $scope $id: Callback is dead&quot;)
</a><a href="#h1-0-5" id="h1-0-5" class="i">+                return
</a><a href="#h1-0-6" id="h1-0-6" class="i">+            }
</a>             val modDatabase = remoteSideContext.database
             val syncedObject = when (scope) {
                 SocialScope.FRIEND -&gt; {
<b>diff --git a/<a id="h2" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/social/MessagingPreview.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/social/MessagingPreview.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/social/MessagingPreview.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/social/MessagingPreview.kt</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -44,10 +44,10 @@ import me.rhunk.snapenhance.ui.util.Dialog
</a> 
 class MessagingPreview: Routes.Route() {
     private lateinit var coroutineScope: CoroutineScope
<a href="#h2-0-3" id="h2-0-3" class="d">-    private lateinit var messagingBridge: MessagingBridge
</a>     private lateinit var previewScrollState: LazyListState
 
     private val contentTypeTranslation by lazy { context.translation.getCategory(&quot;content_type&quot;) }
<a href="#h2-0-7" id="h2-0-7" class="i">+    private val messagingBridge: MessagingBridge? get() = context.bridgeService?.messagingBridge
</a> 
     private var messages = mutableStateListOf&lt;Message&gt;()
     private var conversationId by mutableStateOf&lt;String?&gt;(null)
<a href="#h2-1" id="h2-1" class="h">@@ -194,10 +194,14 @@ class MessagingPreview: Routes.Route() {
</a>         }
 
         fun launchMessagingTask(taskType: MessagingTaskType, constraints: List&lt;MessagingTaskConstraint&gt; = listOf(), onSuccess: (Message) -&gt; Unit = {}) {
<a href="#h2-1-3" id="h2-1-3" class="i">+            if (messagingBridge == null) {
</a><a href="#h2-1-4" id="h2-1-4" class="i">+                context.longToast(translation[&quot;bridge_connection_failed&quot;])
</a><a href="#h2-1-5" id="h2-1-5" class="i">+                return
</a><a href="#h2-1-6" id="h2-1-6" class="i">+            }
</a>             taskSelectionDropdown = false
             processMessageCount.intValue = 0
             activeTask = MessagingTask(
<a href="#h2-1-10" id="h2-1-10" class="d">-                messagingBridge, conversationId!!, taskType, constraints,
</a><a href="#h2-1-11" id="h2-1-11" class="i">+                messagingBridge!!, conversationId!!, taskType, constraints,
</a>                 overrideClientMessageIds = selectedMessages.takeIf { it.isNotEmpty() }?.toList(),
                 processedMessageCount = processMessageCount,
                 onSuccess = onSuccess,
<a href="#h2-2" id="h2-2" class="h">@@ -299,15 +303,23 @@ class MessagingPreview: Routes.Route() {
</a>                     else selectConstraintsDialog = true
                 }
                 ActionButton(text = translation[if (hasSelection) &quot;mark_selection_as_seen_option&quot; else &quot;mark_all_as_seen_option&quot;], icon = Icons.Rounded.RemoveRedEye) {
<a href="#h2-2-3" id="h2-2-3" class="i">+                    if (messagingBridge == null) {
</a><a href="#h2-2-4" id="h2-2-4" class="i">+                        context.longToast(translation[&quot;bridge_connection_failed&quot;])
</a><a href="#h2-2-5" id="h2-2-5" class="i">+                        return@ActionButton
</a><a href="#h2-2-6" id="h2-2-6" class="i">+                    }
</a>                     launchMessagingTask(
                         MessagingTaskType.READ, listOf(
<a href="#h2-2-9" id="h2-2-9" class="d">-                        MessagingConstraints.NO_USER_ID(messagingBridge.myUserId),
</a><a href="#h2-2-10" id="h2-2-10" class="i">+                        MessagingConstraints.NO_USER_ID(messagingBridge!!.myUserId),
</a>                         MessagingConstraints.CONTENT_TYPE(arrayOf(ContentType.SNAP))
                     ))
                     runCurrentTask()
                 }
                 ActionButton(text = translation[if (hasSelection) &quot;delete_selection_option&quot; else &quot;delete_all_option&quot;], icon = Icons.Rounded.DeleteForever) {
<a href="#h2-2-16" id="h2-2-16" class="d">-                    launchMessagingTask(MessagingTaskType.DELETE, listOf(MessagingConstraints.USER_ID(messagingBridge.myUserId), {
</a><a href="#h2-2-17" id="h2-2-17" class="i">+                    if (messagingBridge == null) {
</a><a href="#h2-2-18" id="h2-2-18" class="i">+                        context.longToast(translation[&quot;bridge_connection_failed&quot;])
</a><a href="#h2-2-19" id="h2-2-19" class="i">+                        return@ActionButton
</a><a href="#h2-2-20" id="h2-2-20" class="i">+                    }
</a><a href="#h2-2-21" id="h2-2-21" class="i">+                    launchMessagingTask(MessagingTaskType.DELETE, listOf(MessagingConstraints.USER_ID(messagingBridge!!.myUserId), {
</a>                         contentType != ContentType.STATUS.id
                     })) { message -&gt;
                         coroutineScope.launch {
<a href="#h2-3" id="h2-3" class="h">@@ -426,7 +438,7 @@ class MessagingPreview: Routes.Route() {
</a>         fun fetchNewMessages() {
             coroutineScope.launch(Dispatchers.IO) cs@{
                 runCatching {
<a href="#h2-3-3" id="h2-3-3" class="d">-                    val queriedMessages = messagingBridge.fetchConversationWithMessagesPaginated(
</a><a href="#h2-3-4" id="h2-3-4" class="i">+                    val queriedMessages = messagingBridge!!.fetchConversationWithMessagesPaginated(
</a>                         conversationId!!,
                         20,
                         lastMessageId
<a href="#h2-4" id="h2-4" class="h">@@ -447,18 +459,18 @@ class MessagingPreview: Routes.Route() {
</a>             context.log.verbose(&quot;onMessagingBridgeReady: $scope $scopeId&quot;)
 
             runCatching {
<a href="#h2-4-3" id="h2-4-3" class="d">-                messagingBridge = context.bridgeService!!.messagingBridge!!
</a><a href="#h2-4-4" id="h2-4-4" class="d">-                conversationId = (if (scope == SocialScope.FRIEND) messagingBridge.getOneToOneConversationId(scopeId) else scopeId) ?: throw IllegalStateException(&quot;Failed to get conversation id&quot;)
</a><a href="#h2-4-5" id="h2-4-5" class="d">-                if (runCatching { !messagingBridge.isSessionStarted }.getOrDefault(true)) {
</a><a href="#h2-4-6" id="h2-4-6" class="i">+                conversationId = (if (scope == SocialScope.FRIEND) messagingBridge!!.getOneToOneConversationId(scopeId) else scopeId) ?: throw IllegalStateException(&quot;Failed to get conversation id&quot;)
</a><a href="#h2-4-7" id="h2-4-7" class="i">+                if (runCatching { !messagingBridge!!.isSessionStarted }.getOrDefault(true)) {
</a>                     context.androidContext.packageManager.getLaunchIntentForPackage(
                         Constants.SNAPCHAT_PACKAGE_NAME
                     )?.let {
<a href="#h2-4-11" id="h2-4-11" class="d">-                        val mainIntent = Intent.makeRestartActivityTask(it.component).apply {
</a><a href="#h2-4-12" id="h2-4-12" class="i">+                        val mainIntent = Intent.makeMainActivity(it.component).apply {
</a>                             putExtra(ReceiversConfig.MESSAGING_PREVIEW_EXTRA, true)
<a href="#h2-4-14" id="h2-4-14" class="i">+                            addFlags(Intent.FLAG_ACTIVITY_NEW_TASK)
</a>                         }
                         context.androidContext.startActivity(mainIntent)
                     }
<a href="#h2-4-18" id="h2-4-18" class="d">-                    messagingBridge.registerSessionStartListener(object: SessionStartListener.Stub() {
</a><a href="#h2-4-19" id="h2-4-19" class="i">+                    messagingBridge!!.registerSessionStartListener(object: SessionStartListener.Stub() {
</a>                         override fun onConnected() {
                             fetchNewMessages()
                         }
<b>diff --git a/<a id="h3" href="../file/common/src/main/assets/lang/en_US.json.html">common/src/main/assets/lang/en_US.json</a> b/<a href="../file/common/src/main/assets/lang/en_US.json.html">common/src/main/assets/lang/en_US.json</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -109,8 +109,8 @@
</a>                 &quot;save_from_cache_button&quot;: &quot;Save from Cache&quot;
             },
             &quot;messaging_preview&quot;: {
<a href="#h3-0-3" id="h3-0-3" class="d">-                &quot;bridge_connection_failed&quot;: &quot;Failed to connect to Snapchat through bridge service&quot;,
</a><a href="#h3-0-4" id="h3-0-4" class="d">-                &quot;bridge_init_failed&quot;: &quot;Failed to initialize messaging bridge&quot;,
</a><a href="#h3-0-5" id="h3-0-5" class="i">+                &quot;bridge_connection_failed&quot;: &quot;Failed to connect to bridge. Make sure Snapchat is running in the background&quot;,
</a><a href="#h3-0-6" id="h3-0-6" class="i">+                &quot;bridge_init_failed&quot;: &quot;Failed to initialize messaging bridge. Make sure Snapchat is running in the background&quot;,
</a>                 &quot;message_fetch_failed&quot;: &quot;Failed to fetch messages&quot;,
                 &quot;no_message_hint&quot;: &quot;No message&quot;,
                 &quot;save_selection_option&quot;: &quot;Save Selection&quot;,
<b>diff --git a/<a id="h4" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/ModContext.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/ModContext.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/ModContext.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/ModContext.kt</a></b>
<a href="#h4-0" id="h4-0" class="h">@@ -163,4 +163,6 @@ class ModContext(
</a>     fun getConfigLocale(): String {
         return _config.locale
     }
<a href="#h4-0-3" id="h4-0-3" class="i">+
</a><a href="#h4-0-4" id="h4-0-4" class="i">+    fun isLoggedIn() = androidContext.getSharedPreferences(&quot;user_session_shared_pref&quot;, 0).getString(&quot;key_user_id&quot;, null) != null
</a> } 
\ No newline at end of file
<b>diff --git a/<a id="h5" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/SnapEnhance.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/SnapEnhance.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/SnapEnhance.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/SnapEnhance.kt</a></b>
<a href="#h5-0" id="h5-0" class="h">@@ -27,6 +27,7 @@ import me.rhunk.snapenhance.core.util.LSPatchUpdater
</a> import me.rhunk.snapenhance.core.util.hook.HookAdapter
 import me.rhunk.snapenhance.core.util.hook.HookStage
 import me.rhunk.snapenhance.core.util.hook.hook
<a href="#h5-0-3" id="h5-0-3" class="i">+import kotlin.system.exitProcess
</a> import kotlin.system.measureTimeMillis
 
 
<a href="#h5-1" id="h5-1" class="h">@@ -56,44 +57,55 @@ class SnapEnhance {
</a>             )
             appContext.apply {
                 bridgeClient = BridgeClient(this)
<a href="#h5-1-3" id="h5-1-3" class="d">-                bridgeClient.apply {
</a><a href="#h5-1-4" id="h5-1-4" class="d">-                    connect(
</a><a href="#h5-1-5" id="h5-1-5" class="d">-                        onFailure = {
</a><a href="#h5-1-6" id="h5-1-6" class="d">-                            InAppOverlay.showCrashOverlay(
</a><a href="#h5-1-7" id="h5-1-7" class="d">-                                &quot;Snapchat can&#39;t connect to the SnapEnhance app. Make sure you have the latest version installed on your device. You can download the latest stable version on github.com/rhunk/SnapEnhance&quot;,
</a><a href="#h5-1-8" id="h5-1-8" class="d">-                                throwable = it
</a><a href="#h5-1-9" id="h5-1-9" class="d">-                            )
</a><a href="#h5-1-10" id="h5-1-10" class="d">-                        }
</a><a href="#h5-1-11" id="h5-1-11" class="d">-                    ) { bridgeResult -&gt;
</a><a href="#h5-1-12" id="h5-1-12" class="d">-                        if (!bridgeResult) {
</a><a href="#h5-1-13" id="h5-1-13" class="d">-                            InAppOverlay.showCrashOverlay(
</a><a href="#h5-1-14" id="h5-1-14" class="d">-                                &quot;Snapchat timed out while trying to connect to the SnapEnhance app. Make sure you have disabled any battery optimizations for SnapEnhance.&quot;
</a><a href="#h5-1-15" id="h5-1-15" class="d">-                            )
</a><a href="#h5-1-16" id="h5-1-16" class="d">-                            logCritical(&quot;Cannot connect to the SnapEnhance app&quot;)
</a><a href="#h5-1-17" id="h5-1-17" class="d">-                            return@connect
</a><a href="#h5-1-18" id="h5-1-18" class="d">-                        }
</a><a href="#h5-1-19" id="h5-1-19" class="i">+                initConfigListener()
</a><a href="#h5-1-20" id="h5-1-20" class="i">+                bridgeClient.addOnConnectedCallback {
</a><a href="#h5-1-21" id="h5-1-21" class="i">+                    bridgeClient.registerMessagingBridge(messagingBridge)
</a><a href="#h5-1-22" id="h5-1-22" class="i">+                    coroutineScope.launch {
</a>                         runCatching {
<a href="#h5-1-24" id="h5-1-24" class="d">-                            LSPatchUpdater.onBridgeConnected(appContext, bridgeClient)
</a><a href="#h5-1-25" id="h5-1-25" class="i">+                            syncRemote()
</a>                         }.onFailure {
<a href="#h5-1-27" id="h5-1-27" class="d">-                            log.error(&quot;Failed to init LSPatchUpdater&quot;, it)
</a><a href="#h5-1-28" id="h5-1-28" class="d">-                        }
</a><a href="#h5-1-29" id="h5-1-29" class="d">-                        runCatching {
</a><a href="#h5-1-30" id="h5-1-30" class="d">-                            measureTimeMillis {
</a><a href="#h5-1-31" id="h5-1-31" class="d">-                                runBlocking {
</a><a href="#h5-1-32" id="h5-1-32" class="d">-                                    init(this)
</a><a href="#h5-1-33" id="h5-1-33" class="d">-                                }
</a><a href="#h5-1-34" id="h5-1-34" class="d">-                            }.also {
</a><a href="#h5-1-35" id="h5-1-35" class="d">-                                appContext.log.verbose(&quot;init took ${it}ms&quot;)
</a><a href="#h5-1-36" id="h5-1-36" class="d">-                            }
</a><a href="#h5-1-37" id="h5-1-37" class="d">-                        }.onSuccess {
</a><a href="#h5-1-38" id="h5-1-38" class="d">-                            isBridgeInitialized = true
</a><a href="#h5-1-39" id="h5-1-39" class="d">-                        }.onFailure {
</a><a href="#h5-1-40" id="h5-1-40" class="d">-                            logCritical(&quot;Failed to initialize bridge&quot;, it)
</a><a href="#h5-1-41" id="h5-1-41" class="d">-                            InAppOverlay.showCrashOverlay(&quot;SnapEnhance failed to initialize. Please check logs for more details.&quot;, it)
</a><a href="#h5-1-42" id="h5-1-42" class="i">+                            log.error(&quot;Failed to sync remote&quot;, it)
</a>                         }
                     }
                 }
             }
<a href="#h5-1-47" id="h5-1-47" class="i">+
</a><a href="#h5-1-48" id="h5-1-48" class="i">+            runBlocking {
</a><a href="#h5-1-49" id="h5-1-49" class="i">+                var throwable: Throwable? = null
</a><a href="#h5-1-50" id="h5-1-50" class="i">+                val canLoad = appContext.bridgeClient.connect { throwable = it }
</a><a href="#h5-1-51" id="h5-1-51" class="i">+                if (canLoad == null) {
</a><a href="#h5-1-52" id="h5-1-52" class="i">+                    InAppOverlay.showCrashOverlay(
</a><a href="#h5-1-53" id="h5-1-53" class="i">+                        buildString {
</a><a href="#h5-1-54" id="h5-1-54" class="i">+                            append(&quot;Snapchat timed out while trying to connect to SnapEnhance\n\n&quot;)
</a><a href="#h5-1-55" id="h5-1-55" class="i">+                            append(&quot;Make sure you:\n&quot;)
</a><a href="#h5-1-56" id="h5-1-56" class="i">+                            append(&quot; - Have installed the latest SnapEnhance version (https://github.com/rhunk/SnapEnhance)\n&quot;)
</a><a href="#h5-1-57" id="h5-1-57" class="i">+                            append(&quot; - Disabled battery optimizations\n&quot;)
</a><a href="#h5-1-58" id="h5-1-58" class="i">+                            append(&quot; - Excluded SnapEnhance and Snapchat in HideMyApplist&quot;)
</a><a href="#h5-1-59" id="h5-1-59" class="i">+                        },
</a><a href="#h5-1-60" id="h5-1-60" class="i">+                        throwable
</a><a href="#h5-1-61" id="h5-1-61" class="i">+                    )
</a><a href="#h5-1-62" id="h5-1-62" class="i">+                    appContext.logCritical(&quot;Cannot connect to the SnapEnhance app&quot;)
</a><a href="#h5-1-63" id="h5-1-63" class="i">+                    return@runBlocking
</a><a href="#h5-1-64" id="h5-1-64" class="i">+                }
</a><a href="#h5-1-65" id="h5-1-65" class="i">+                if (!canLoad) exitProcess(1)
</a><a href="#h5-1-66" id="h5-1-66" class="i">+                runCatching {
</a><a href="#h5-1-67" id="h5-1-67" class="i">+                    LSPatchUpdater.onBridgeConnected(appContext)
</a><a href="#h5-1-68" id="h5-1-68" class="i">+                }.onFailure {
</a><a href="#h5-1-69" id="h5-1-69" class="i">+                    appContext.log.error(&quot;Failed to init LSPatchUpdater&quot;, it)
</a><a href="#h5-1-70" id="h5-1-70" class="i">+                }
</a><a href="#h5-1-71" id="h5-1-71" class="i">+                runCatching {
</a><a href="#h5-1-72" id="h5-1-72" class="i">+                    measureTimeMillis {
</a><a href="#h5-1-73" id="h5-1-73" class="i">+                        init(this)
</a><a href="#h5-1-74" id="h5-1-74" class="i">+                    }.also {
</a><a href="#h5-1-75" id="h5-1-75" class="i">+                        appContext.log.verbose(&quot;init took ${it}ms&quot;)
</a><a href="#h5-1-76" id="h5-1-76" class="i">+                    }
</a><a href="#h5-1-77" id="h5-1-77" class="i">+                }.onSuccess {
</a><a href="#h5-1-78" id="h5-1-78" class="i">+                    isBridgeInitialized = true
</a><a href="#h5-1-79" id="h5-1-79" class="i">+                }.onFailure {
</a><a href="#h5-1-80" id="h5-1-80" class="i">+                    appContext.logCritical(&quot;Failed to initialize bridge&quot;, it)
</a><a href="#h5-1-81" id="h5-1-81" class="i">+                    InAppOverlay.showCrashOverlay(&quot;SnapEnhance failed to initialize. Please check logs for more details.&quot;, it)
</a><a href="#h5-1-82" id="h5-1-82" class="i">+                }
</a><a href="#h5-1-83" id="h5-1-83" class="i">+            }
</a>         }
 
         hookMainActivity(&quot;onCreate&quot;) {
<a href="#h5-2" id="h5-2" class="h">@@ -137,15 +149,9 @@ class SnapEnhance {
</a>             }
 
             reloadConfig()
<a href="#h5-2-3" id="h5-2-3" class="d">-            initConfigListener()
</a>             initWidgetListener()
             initNative()
             scope.launch(Dispatchers.IO) {
<a href="#h5-2-7" id="h5-2-7" class="d">-                runCatching {
</a><a href="#h5-2-8" id="h5-2-8" class="d">-                    syncRemote()
</a><a href="#h5-2-9" id="h5-2-9" class="d">-                }.onFailure {
</a><a href="#h5-2-10" id="h5-2-10" class="d">-                    log.error(&quot;Failed to sync remote&quot;, it)
</a><a href="#h5-2-11" id="h5-2-11" class="d">-                }
</a>                 translation.userLocale = getConfigLocale()
                 translation.load()
             }
<a href="#h5-3" id="h5-3" class="h">@@ -155,7 +161,6 @@ class SnapEnhance {
</a>             eventDispatcher.init()
             //if mappings aren&#39;t loaded, we can&#39;t initialize features
             if (!mappings.isMappingsLoaded) return
<a href="#h5-3-3" id="h5-3-3" class="d">-            bridgeClient.registerMessagingBridge(messagingBridge)
</a>             features.init()
             scriptRuntime.connect(bridgeClient.getScriptingInterface())
             scriptRuntime.eachModule { callFunction(&quot;module.onSnapApplicationLoad&quot;, androidContext) }
<a href="#h5-4" id="h5-4" class="h">@@ -178,7 +183,7 @@ class SnapEnhance {
</a>     private fun initNative() {
         // don&#39;t initialize native when not logged in
         if (
<a href="#h5-4-3" id="h5-4-3" class="d">-            appContext.androidContext.getSharedPreferences(&quot;user_session_shared_pref&quot;, 0).getString(&quot;key_user_id&quot;, null) == null &amp;&amp;
</a><a href="#h5-4-4" id="h5-4-4" class="i">+            !appContext.isLoggedIn() &amp;&amp;
</a>             appContext.bridgeClient.getDebugProp(&quot;force_native_load&quot;, null) != &quot;true&quot;
         ) return
         if (appContext.config.experimental.nativeHooks.globalState != true) return
<a href="#h5-5" id="h5-5" class="h">@@ -219,27 +224,27 @@ class SnapEnhance {
</a>             }
         }
 
<a href="#h5-5-3" id="h5-5-3" class="d">-        appContext.executeAsync {
</a><a href="#h5-5-4" id="h5-5-4" class="d">-            bridgeClient.registerConfigStateListener(object: ConfigStateListener.Stub() {
</a><a href="#h5-5-5" id="h5-5-5" class="i">+        appContext.bridgeClient.addOnConnectedCallback {
</a><a href="#h5-5-6" id="h5-5-6" class="i">+            appContext.bridgeClient.registerConfigStateListener(object: ConfigStateListener.Stub() {
</a>                 override fun onConfigChanged() {
<a href="#h5-5-8" id="h5-5-8" class="d">-                    log.verbose(&quot;onConfigChanged&quot;)
</a><a href="#h5-5-9" id="h5-5-9" class="d">-                    reloadConfig()
</a><a href="#h5-5-10" id="h5-5-10" class="i">+                    appContext.log.verbose(&quot;onConfigChanged&quot;)
</a><a href="#h5-5-11" id="h5-5-11" class="i">+                    appContext.reloadConfig()
</a>                 }
 
                 override fun onRestartRequired() {
<a href="#h5-5-15" id="h5-5-15" class="d">-                    log.verbose(&quot;onRestartRequired&quot;)
</a><a href="#h5-5-16" id="h5-5-16" class="i">+                    appContext.log.verbose(&quot;onRestartRequired&quot;)
</a>                     runLater {
<a href="#h5-5-18" id="h5-5-18" class="d">-                        log.verbose(&quot;softRestart&quot;)
</a><a href="#h5-5-19" id="h5-5-19" class="d">-                        softRestartApp(saveSettings = false)
</a><a href="#h5-5-20" id="h5-5-20" class="i">+                        appContext.log.verbose(&quot;softRestart&quot;)
</a><a href="#h5-5-21" id="h5-5-21" class="i">+                        appContext.softRestartApp(saveSettings = false)
</a>                     }
                 }
 
                 override fun onCleanCacheRequired() {
<a href="#h5-5-26" id="h5-5-26" class="d">-                    log.verbose(&quot;onCleanCacheRequired&quot;)
</a><a href="#h5-5-27" id="h5-5-27" class="i">+                    appContext.log.verbose(&quot;onCleanCacheRequired&quot;)
</a>                     tasks.clear()
                     runLater {
<a href="#h5-5-30" id="h5-5-30" class="d">-                        log.verbose(&quot;cleanCache&quot;)
</a><a href="#h5-5-31" id="h5-5-31" class="d">-                        actionManager.execute(EnumAction.CLEAN_CACHE)
</a><a href="#h5-5-32" id="h5-5-32" class="i">+                        appContext.log.verbose(&quot;cleanCache&quot;)
</a><a href="#h5-5-33" id="h5-5-33" class="i">+                        appContext.actionManager.execute(EnumAction.CLEAN_CACHE)
</a>                     }
                 }
             })
<b>diff --git a/<a id="h6" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/BridgeClient.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/BridgeClient.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/BridgeClient.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/BridgeClient.kt</a></b>
<a href="#h6-0" id="h6-0" class="h">@@ -5,9 +5,18 @@ import android.content.ComponentName
</a> import android.content.Context
 import android.content.Intent
 import android.content.ServiceConnection
<a href="#h6-0-3" id="h6-0-3" class="d">-import android.os.*
</a><a href="#h6-0-4" id="h6-0-4" class="i">+import android.os.Build
</a><a href="#h6-0-5" id="h6-0-5" class="i">+import android.os.DeadObjectException
</a><a href="#h6-0-6" id="h6-0-6" class="i">+import android.os.Handler
</a><a href="#h6-0-7" id="h6-0-7" class="i">+import android.os.HandlerThread
</a><a href="#h6-0-8" id="h6-0-8" class="i">+import android.os.IBinder
</a><a href="#h6-0-9" id="h6-0-9" class="i">+import android.os.ParcelFileDescriptor
</a><a href="#h6-0-10" id="h6-0-10" class="i">+import android.os.Process
</a> import android.util.Log
 import de.robv.android.xposed.XposedHelpers
<a href="#h6-0-13" id="h6-0-13" class="i">+import kotlinx.coroutines.runBlocking
</a><a href="#h6-0-14" id="h6-0-14" class="i">+import kotlinx.coroutines.suspendCancellableCoroutine
</a><a href="#h6-0-15" id="h6-0-15" class="i">+import kotlinx.coroutines.withTimeoutOrNull
</a> import me.rhunk.snapenhance.bridge.AccountStorage
 import me.rhunk.snapenhance.bridge.BridgeInterface
 import me.rhunk.snapenhance.bridge.ConfigStateListener
<a href="#h6-1" id="h6-1" class="h">@@ -26,83 +35,135 @@ import me.rhunk.snapenhance.common.data.MessagingRuleType
</a> import me.rhunk.snapenhance.common.data.SocialScope
 import me.rhunk.snapenhance.common.util.toSerialized
 import me.rhunk.snapenhance.core.ModContext
<a href="#h6-1-3" id="h6-1-3" class="d">-import java.util.concurrent.CompletableFuture
</a> import java.util.concurrent.Executors
<a href="#h6-1-5" id="h6-1-5" class="d">-import java.util.concurrent.TimeUnit
</a><a href="#h6-1-6" id="h6-1-6" class="d">-import kotlin.system.exitProcess
</a><a href="#h6-1-7" id="h6-1-7" class="i">+import kotlin.coroutines.Continuation
</a><a href="#h6-1-8" id="h6-1-8" class="i">+import kotlin.coroutines.resume
</a> 
 class BridgeClient(
     private val context: ModContext
 ):  ServiceConnection {
<a href="#h6-1-13" id="h6-1-13" class="d">-    private lateinit var future: CompletableFuture&lt;Boolean&gt;
</a><a href="#h6-1-14" id="h6-1-14" class="i">+    private var continuation: Continuation&lt;Boolean&gt;? = null
</a>     private lateinit var service: BridgeInterface
 
<a href="#h6-1-17" id="h6-1-17" class="d">-    fun connect(onFailure: (Throwable) -&gt; Unit, onResult: (Boolean) -&gt; Unit) {
</a><a href="#h6-1-18" id="h6-1-18" class="d">-        this.future = CompletableFuture()
</a><a href="#h6-1-19" id="h6-1-19" class="i">+    private val onConnectedCallbacks = mutableListOf&lt;suspend () -&gt; Unit&gt;()
</a> 
<a href="#h6-1-21" id="h6-1-21" class="d">-        with(context.androidContext) {
</a><a href="#h6-1-22" id="h6-1-22" class="d">-            runCatching {
</a><a href="#h6-1-23" id="h6-1-23" class="d">-                startActivity(Intent()
</a><a href="#h6-1-24" id="h6-1-24" class="d">-                    .setClassName(Constants.SE_PACKAGE_NAME, &quot;me.rhunk.snapenhance.bridge.ForceStartActivity&quot;)
</a><a href="#h6-1-25" id="h6-1-25" class="d">-                    .addFlags(Intent.FLAG_ACTIVITY_NEW_TASK or Intent.FLAG_ACTIVITY_MULTIPLE_TASK)
</a><a href="#h6-1-26" id="h6-1-26" class="d">-                )
</a><a href="#h6-1-27" id="h6-1-27" class="d">-            }
</a><a href="#h6-1-28" id="h6-1-28" class="i">+    fun addOnConnectedCallback(callback: suspend () -&gt; Unit) {
</a><a href="#h6-1-29" id="h6-1-29" class="i">+        synchronized(onConnectedCallbacks) {
</a><a href="#h6-1-30" id="h6-1-30" class="i">+            onConnectedCallbacks.add(callback)
</a><a href="#h6-1-31" id="h6-1-31" class="i">+        }
</a><a href="#h6-1-32" id="h6-1-32" class="i">+    }
</a><a href="#h6-1-33" id="h6-1-33" class="i">+
</a><a href="#h6-1-34" id="h6-1-34" class="i">+    suspend fun connect(onFailure: (Throwable) -&gt; Unit): Boolean? {
</a><a href="#h6-1-35" id="h6-1-35" class="i">+        if (this::service.isInitialized &amp;&amp; service.asBinder().pingBinder()) {
</a><a href="#h6-1-36" id="h6-1-36" class="i">+            return true
</a><a href="#h6-1-37" id="h6-1-37" class="i">+        }
</a> 
<a href="#h6-1-39" id="h6-1-39" class="d">-            //ensure the remote process is running
</a><a href="#h6-1-40" id="h6-1-40" class="d">-            runCatching {
</a><a href="#h6-1-41" id="h6-1-41" class="d">-                val intent = Intent()
</a><a href="#h6-1-42" id="h6-1-42" class="d">-                    .setClassName(Constants.SE_PACKAGE_NAME,&quot;me.rhunk.snapenhance.bridge.BridgeService&quot;)
</a><a href="#h6-1-43" id="h6-1-43" class="d">-                if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.Q) {
</a><a href="#h6-1-44" id="h6-1-44" class="d">-                    bindService(
</a><a href="#h6-1-45" id="h6-1-45" class="d">-                        intent,
</a><a href="#h6-1-46" id="h6-1-46" class="d">-                        Context.BIND_AUTO_CREATE,
</a><a href="#h6-1-47" id="h6-1-47" class="d">-                        Executors.newSingleThreadExecutor(),
</a><a href="#h6-1-48" id="h6-1-48" class="d">-                        this@BridgeClient
</a><a href="#h6-1-49" id="h6-1-49" class="d">-                    )
</a><a href="#h6-1-50" id="h6-1-50" class="d">-                } else {
</a><a href="#h6-1-51" id="h6-1-51" class="d">-                    XposedHelpers.callMethod(
</a><a href="#h6-1-52" id="h6-1-52" class="d">-                        this,
</a><a href="#h6-1-53" id="h6-1-53" class="d">-                        &quot;bindServiceAsUser&quot;,
</a><a href="#h6-1-54" id="h6-1-54" class="d">-                        intent,
</a><a href="#h6-1-55" id="h6-1-55" class="d">-                        this@BridgeClient,
</a><a href="#h6-1-56" id="h6-1-56" class="d">-                        Context.BIND_AUTO_CREATE,
</a><a href="#h6-1-57" id="h6-1-57" class="d">-                        Handler(HandlerThread(&quot;BridgeClient&quot;).apply {
</a><a href="#h6-1-58" id="h6-1-58" class="d">-                            start()
</a><a href="#h6-1-59" id="h6-1-59" class="d">-                        }.looper),
</a><a href="#h6-1-60" id="h6-1-60" class="d">-                        android.os.Process.myUserHandle()
</a><a href="#h6-1-61" id="h6-1-61" class="d">-                    )
</a><a href="#h6-1-62" id="h6-1-62" class="i">+        return withTimeoutOrNull(5000L) {
</a><a href="#h6-1-63" id="h6-1-63" class="i">+            suspendCancellableCoroutine { cancellableContinuation -&gt;
</a><a href="#h6-1-64" id="h6-1-64" class="i">+                continuation = cancellableContinuation
</a><a href="#h6-1-65" id="h6-1-65" class="i">+                with(context.androidContext) {
</a><a href="#h6-1-66" id="h6-1-66" class="i">+                    //ensure the remote process is running
</a><a href="#h6-1-67" id="h6-1-67" class="i">+                    runCatching {
</a><a href="#h6-1-68" id="h6-1-68" class="i">+                        startActivity(Intent()
</a><a href="#h6-1-69" id="h6-1-69" class="i">+                            .setClassName(Constants.SE_PACKAGE_NAME, &quot;me.rhunk.snapenhance.bridge.ForceStartActivity&quot;)
</a><a href="#h6-1-70" id="h6-1-70" class="i">+                            .addFlags(Intent.FLAG_ACTIVITY_NEW_TASK or Intent.FLAG_ACTIVITY_MULTIPLE_TASK)
</a><a href="#h6-1-71" id="h6-1-71" class="i">+                        )
</a><a href="#h6-1-72" id="h6-1-72" class="i">+                    }
</a><a href="#h6-1-73" id="h6-1-73" class="i">+
</a><a href="#h6-1-74" id="h6-1-74" class="i">+                    runCatching {
</a><a href="#h6-1-75" id="h6-1-75" class="i">+                        val intent = Intent()
</a><a href="#h6-1-76" id="h6-1-76" class="i">+                            .setClassName(Constants.SE_PACKAGE_NAME, &quot;me.rhunk.snapenhance.bridge.BridgeService&quot;)
</a><a href="#h6-1-77" id="h6-1-77" class="i">+                        runCatching {
</a><a href="#h6-1-78" id="h6-1-78" class="i">+                            if (this@BridgeClient::service.isInitialized) {
</a><a href="#h6-1-79" id="h6-1-79" class="i">+                                unbindService(this@BridgeClient)
</a><a href="#h6-1-80" id="h6-1-80" class="i">+                            }
</a><a href="#h6-1-81" id="h6-1-81" class="i">+                        }
</a><a href="#h6-1-82" id="h6-1-82" class="i">+                        if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.Q) {
</a><a href="#h6-1-83" id="h6-1-83" class="i">+                            bindService(
</a><a href="#h6-1-84" id="h6-1-84" class="i">+                                intent,
</a><a href="#h6-1-85" id="h6-1-85" class="i">+                                Context.BIND_AUTO_CREATE,
</a><a href="#h6-1-86" id="h6-1-86" class="i">+                                Executors.newSingleThreadExecutor(),
</a><a href="#h6-1-87" id="h6-1-87" class="i">+                                this@BridgeClient
</a><a href="#h6-1-88" id="h6-1-88" class="i">+                            )
</a><a href="#h6-1-89" id="h6-1-89" class="i">+                        } else {
</a><a href="#h6-1-90" id="h6-1-90" class="i">+                            XposedHelpers.callMethod(
</a><a href="#h6-1-91" id="h6-1-91" class="i">+                                this,
</a><a href="#h6-1-92" id="h6-1-92" class="i">+                                &quot;bindServiceAsUser&quot;,
</a><a href="#h6-1-93" id="h6-1-93" class="i">+                                intent,
</a><a href="#h6-1-94" id="h6-1-94" class="i">+                                this@BridgeClient,
</a><a href="#h6-1-95" id="h6-1-95" class="i">+                                Context.BIND_AUTO_CREATE,
</a><a href="#h6-1-96" id="h6-1-96" class="i">+                                Handler(HandlerThread(&quot;BridgeClient&quot;).apply {
</a><a href="#h6-1-97" id="h6-1-97" class="i">+                                    start()
</a><a href="#h6-1-98" id="h6-1-98" class="i">+                                }.looper),
</a><a href="#h6-1-99" id="h6-1-99" class="i">+                                Process.myUserHandle()
</a><a href="#h6-1-100" id="h6-1-100" class="i">+                            )
</a><a href="#h6-1-101" id="h6-1-101" class="i">+                        }
</a><a href="#h6-1-102" id="h6-1-102" class="i">+                    }.onFailure {
</a><a href="#h6-1-103" id="h6-1-103" class="i">+                        onFailure(it)
</a><a href="#h6-1-104" id="h6-1-104" class="i">+                        continuation = null
</a><a href="#h6-1-105" id="h6-1-105" class="i">+                        cancellableContinuation.resume(false)
</a><a href="#h6-1-106" id="h6-1-106" class="i">+                    }
</a>                 }
<a href="#h6-1-108" id="h6-1-108" class="d">-                onResult(future.get(15, TimeUnit.SECONDS))
</a><a href="#h6-1-109" id="h6-1-109" class="d">-            }.onFailure {
</a><a href="#h6-1-110" id="h6-1-110" class="d">-                onFailure(it)
</a>             }
         }
     }
 
<a href="#h6-1-115" id="h6-1-115" class="d">-
</a>     override fun onServiceConnected(name: ComponentName, service: IBinder) {
         this.service = BridgeInterface.Stub.asInterface(service)
<a href="#h6-1-118" id="h6-1-118" class="d">-        future.complete(true)
</a><a href="#h6-1-119" id="h6-1-119" class="i">+        runBlocking {
</a><a href="#h6-1-120" id="h6-1-120" class="i">+            onConnectedCallbacks.forEach {
</a><a href="#h6-1-121" id="h6-1-121" class="i">+                runCatching {
</a><a href="#h6-1-122" id="h6-1-122" class="i">+                    it()
</a><a href="#h6-1-123" id="h6-1-123" class="i">+                }.onFailure {
</a><a href="#h6-1-124" id="h6-1-124" class="i">+                    context.log.error(&quot;Failed to run onConnectedCallback&quot;, it)
</a><a href="#h6-1-125" id="h6-1-125" class="i">+                }
</a><a href="#h6-1-126" id="h6-1-126" class="i">+            }
</a><a href="#h6-1-127" id="h6-1-127" class="i">+        }
</a><a href="#h6-1-128" id="h6-1-128" class="i">+        continuation?.resume(true)
</a><a href="#h6-1-129" id="h6-1-129" class="i">+        continuation = null
</a>     }
 
     override fun onNullBinding(name: ComponentName) {
<a href="#h6-1-133" id="h6-1-133" class="d">-        context.log.error(&quot;BridgeClient&quot;, &quot;failed to connect to bridge service&quot;)
</a><a href="#h6-1-134" id="h6-1-134" class="d">-        exitProcess(1)
</a><a href="#h6-1-135" id="h6-1-135" class="i">+        Log.d(&quot;BridgeClient&quot;, &quot;bridge null binding&quot;)
</a><a href="#h6-1-136" id="h6-1-136" class="i">+        continuation?.resume(false)
</a><a href="#h6-1-137" id="h6-1-137" class="i">+        continuation = null
</a>     }
 
     override fun onServiceDisconnected(name: ComponentName) {
<a href="#h6-1-141" id="h6-1-141" class="d">-        exitProcess(0)
</a><a href="#h6-1-142" id="h6-1-142" class="i">+        continuation = null
</a><a href="#h6-1-143" id="h6-1-143" class="i">+    }
</a><a href="#h6-1-144" id="h6-1-144" class="i">+
</a><a href="#h6-1-145" id="h6-1-145" class="i">+    private fun tryReconnect() {
</a><a href="#h6-1-146" id="h6-1-146" class="i">+        runBlocking {
</a><a href="#h6-1-147" id="h6-1-147" class="i">+            Log.d(&quot;BridgeClient&quot;, &quot;service is dead, restarting&quot;)
</a><a href="#h6-1-148" id="h6-1-148" class="i">+            val canLoad = connect {
</a><a href="#h6-1-149" id="h6-1-149" class="i">+                Log.e(&quot;BridgeClient&quot;, &quot;connection failed&quot;, it)
</a><a href="#h6-1-150" id="h6-1-150" class="i">+                context.softRestartApp()
</a><a href="#h6-1-151" id="h6-1-151" class="i">+            }
</a><a href="#h6-1-152" id="h6-1-152" class="i">+            if (canLoad != true) {
</a><a href="#h6-1-153" id="h6-1-153" class="i">+                Log.e(&quot;BridgeClient&quot;, &quot;failed to reconnect to service&quot;, Throwable())
</a><a href="#h6-1-154" id="h6-1-154" class="i">+                context.softRestartApp()
</a><a href="#h6-1-155" id="h6-1-155" class="i">+            }
</a><a href="#h6-1-156" id="h6-1-156" class="i">+        }
</a>     }
 
     private fun &lt;T&gt; safeServiceCall(block: () -&gt; T): T {
         return runCatching {
             block()
<a href="#h6-1-162" id="h6-1-162" class="d">-        }.getOrElse {
</a><a href="#h6-1-163" id="h6-1-163" class="d">-            Log.e(&quot;SnapEnhance&quot;, &quot;service call failed&quot;, it)
</a><a href="#h6-1-164" id="h6-1-164" class="d">-            if (it is DeadObjectException) {
</a><a href="#h6-1-165" id="h6-1-165" class="d">-                context.softRestartApp()
</a><a href="#h6-1-166" id="h6-1-166" class="i">+        }.getOrElse { throwable -&gt;
</a><a href="#h6-1-167" id="h6-1-167" class="i">+            if (throwable is DeadObjectException) {
</a><a href="#h6-1-168" id="h6-1-168" class="i">+                tryReconnect()
</a><a href="#h6-1-169" id="h6-1-169" class="i">+                return@getOrElse runCatching {
</a><a href="#h6-1-170" id="h6-1-170" class="i">+                    block()
</a><a href="#h6-1-171" id="h6-1-171" class="i">+                }.getOrElse {
</a><a href="#h6-1-172" id="h6-1-172" class="i">+                    Log.e(&quot;BridgeClient&quot;, &quot;service call failed&quot;, it)
</a><a href="#h6-1-173" id="h6-1-173" class="i">+                    if (it is DeadObjectException) {
</a><a href="#h6-1-174" id="h6-1-174" class="i">+                        context.softRestartApp()
</a><a href="#h6-1-175" id="h6-1-175" class="i">+                    }
</a><a href="#h6-1-176" id="h6-1-176" class="i">+                    throw it
</a><a href="#h6-1-177" id="h6-1-177" class="i">+                }
</a>             }
<a href="#h6-1-179" id="h6-1-179" class="d">-            throw it
</a><a href="#h6-1-180" id="h6-1-180" class="i">+            throw throwable
</a>         }
     }
 
<a href="#h6-2" id="h6-2" class="h">@@ -180,5 +241,5 @@ class BridgeClient(
</a> 
     fun registerConfigStateListener(listener: ConfigStateListener) = safeServiceCall { service.registerConfigStateListener(listener) }
 
<a href="#h6-2-3" id="h6-2-3" class="d">-    fun getDebugProp(name: String, defaultValue: String? = null) = safeServiceCall { service.getDebugProp(name, defaultValue) }
</a><a href="#h6-2-4" id="h6-2-4" class="i">+    fun getDebugProp(name: String, defaultValue: String? = null): String? = safeServiceCall { service.getDebugProp(name, defaultValue) }
</a> }
<b>diff --git a/<a id="h7" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/Messaging.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/Messaging.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/Messaging.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/Messaging.kt</a></b>
<a href="#h7-0" id="h7-0" class="h">@@ -1,5 +1,8 @@
</a> package me.rhunk.snapenhance.core.features.impl.messaging
 
<a href="#h7-0-2" id="h7-0-2" class="i">+import android.content.ComponentName
</a><a href="#h7-0-3" id="h7-0-3" class="i">+import android.content.Intent
</a><a href="#h7-0-4" id="h7-0-4" class="i">+import me.rhunk.snapenhance.common.Constants
</a> import me.rhunk.snapenhance.common.ReceiversConfig
 import me.rhunk.snapenhance.core.event.events.impl.ConversationUpdateEvent
 import me.rhunk.snapenhance.core.event.events.impl.OnSnapInteractionEvent
<a href="#h7-1" id="h7-1" class="h">@@ -48,8 +51,11 @@ class Messaging : Feature(&quot;Messaging&quot;, loadParams = FeatureLoadParams.ACTIVITY_C
</a>         context.classCache.conversationManager.hookConstructor(HookStage.BEFORE) { param -&gt;
             conversationManager = ConversationManager(context, param.thisObject())
             context.messagingBridge.triggerSessionStart()
<a href="#h7-1-3" id="h7-1-3" class="d">-            context.mainActivity?.takeIf { it.intent.getBooleanExtra(ReceiversConfig.MESSAGING_PREVIEW_EXTRA,false) }?.run {
</a><a href="#h7-1-4" id="h7-1-4" class="d">-                finishAndRemoveTask()
</a><a href="#h7-1-5" id="h7-1-5" class="i">+            context.mainActivity?.takeIf { it.intent.getBooleanExtra(ReceiversConfig.MESSAGING_PREVIEW_EXTRA, false) }?.run {
</a><a href="#h7-1-6" id="h7-1-6" class="i">+                startActivity(Intent().apply {
</a><a href="#h7-1-7" id="h7-1-7" class="i">+                    setComponent(ComponentName(Constants.SE_PACKAGE_NAME, &quot;me.rhunk.snapenhance.ui.manager.MainActivity&quot;))
</a><a href="#h7-1-8" id="h7-1-8" class="i">+                    addFlags(Intent.FLAG_ACTIVITY_NEW_TASK)
</a><a href="#h7-1-9" id="h7-1-9" class="i">+                })
</a>             }
         }
 
<b>diff --git a/<a id="h8" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/util/LSPatchUpdater.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/util/LSPatchUpdater.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/util/LSPatchUpdater.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/util/LSPatchUpdater.kt</a></b>
<a href="#h8-0" id="h8-0" class="h">@@ -2,7 +2,6 @@ package me.rhunk.snapenhance.core.util
</a> 
 import me.rhunk.snapenhance.common.Constants
 import me.rhunk.snapenhance.core.ModContext
<a href="#h8-0-3" id="h8-0-3" class="d">-import me.rhunk.snapenhance.core.bridge.BridgeClient
</a> import java.io.File
 import java.util.zip.ZipFile
 
<a href="#h8-1" id="h8-1" class="h">@@ -20,7 +19,7 @@ object LSPatchUpdater {
</a>             .toString(16)
     }
 
<a href="#h8-1-3" id="h8-1-3" class="d">-    fun onBridgeConnected(context: ModContext, bridgeClient: BridgeClient) {
</a><a href="#h8-1-4" id="h8-1-4" class="i">+    fun onBridgeConnected(context: ModContext) {
</a>         val obfuscatedModulePath by lazy {
             (runCatching {
                 context::class.java.classLoader?.loadClass(&quot;org.lsposed.lspatch.share.Constants&quot;)
<a href="#h8-2" id="h8-2" class="h">@@ -44,7 +43,7 @@ object LSPatchUpdater {
</a>         HAS_LSPATCH = true
         context.log.verbose(&quot;Found embedded SE at ${embeddedModule.absolutePath}&quot;, TAG)
 
<a href="#h8-2-3" id="h8-2-3" class="d">-        val seAppApk = File(bridgeClient.getApplicationApkPath()).also {
</a><a href="#h8-2-4" id="h8-2-4" class="i">+        val seAppApk = File(context.bridgeClient.getApplicationApkPath()).also {
</a>             if (!it.canRead()) {
                 throw IllegalStateException(&quot;Cannot read SnapEnhance apk&quot;)
             }
</pre>
</div>
</body>
</html>
