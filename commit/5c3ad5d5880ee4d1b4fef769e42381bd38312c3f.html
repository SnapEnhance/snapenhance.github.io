<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>feat: rule system - SnapEnhance - An Xposed module offering an enhanced Snapchat experience
</title>
<link rel="icon" type="image/svg+xml" href="../../logo.png"/>
<link rel="alternate icon" href="../../favicon.png"/>
<link rel="alternate" type="application/atom+xml" title="SnapEnhance Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="SnapEnhance Atom Feed (tags)" href="../tags.xml" />
<link rel="stylesheet" type="text/css" href="../../style.css" />
<link rel="stylesheet" type="text/css" href="../../fonts.css" />
</head>
<body>
<div id="head"><table><tr><td><a class="logo" href="../../"><img src="../../logo.png" alt="" width="32" height="32" /></a></td><td><strong>SnapEnhance</strong><span class="desc"> - An Xposed module offering an enhanced Snapchat experience
</span>
</td></tr></table>
<p><a href="../about.html">About</a> | <a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/LICENSE.html">License</a></p>
</div>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/5c3ad5d5880ee4d1b4fef769e42381bd38312c3f.html">5c3ad5d5880ee4d1b4fef769e42381bd38312c3f</a>
<b>parent</b> <a href="../commit/2b90ee2deb3711b023a2b7c256f328731e90eda6.html">2b90ee2deb3711b023a2b7c256f328731e90eda6</a>
<b>Author:</b> rhunk &lt;<a href="mailto:101876869+rhunk@users.noreply.github.com">101876869+rhunk@users.noreply.github.com</a>&gt;
<b>Date:</b>   Tue, 22 Aug 2023 18:41:23 +0200

feat: rule system

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">app/src/main/kotlin/me/rhunk/snapenhance/bridge/BridgeService.kt</a></td><td> | </td><td class="num">11</td><td><span class="i">++++++</span><span class="d">-----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">app/src/main/kotlin/me/rhunk/snapenhance/messaging/ModDatabase.kt</a></td><td> | </td><td class="num">36</td><td><span class="i">++++++++++++++</span><span class="d">----------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h2">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/features/Dialogs.kt</a></td><td> | </td><td class="num">5</td><td><span class="i">+</span><span class="d">----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h3">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/features/FeaturesSection.kt</a></td><td> | </td><td class="num">20</td><td><span class="i">++++++++++</span><span class="d">----------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h4">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/social/ScopeContent.kt</a></td><td> | </td><td class="num">34</td><td><span class="i">++++++++++++++++++++++</span><span class="d">------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h5">core/src/main/aidl/me/rhunk/snapenhance/bridge/BridgeInterface.aidl</a></td><td> | </td><td class="num">6</td><td><span class="i">+++++</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h6">core/src/main/assets/lang/en_US.json</a></td><td> | </td><td class="num">40</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h7">core/src/main/kotlin/me/rhunk/snapenhance/bridge/BridgeClient.kt</a></td><td> | </td><td class="num">13</td><td><span class="i">++++++</span><span class="d">-------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h8">core/src/main/kotlin/me/rhunk/snapenhance/core/config/ConfigContainer.kt</a></td><td> | </td><td class="num">5</td><td><span class="i">++</span><span class="d">---</span></td></tr>
<tr><td class="M">M</td><td><a href="#h9">core/src/main/kotlin/me/rhunk/snapenhance/core/config/ConfigObjects.kt</a></td><td> | </td><td class="num">63</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">----------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h10">core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/Camera.kt</a></td><td> | </td><td class="num">5</td><td><span class="i">+++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h11">core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/DownloaderConfig.kt</a></td><td> | </td><td class="num">3</td><td><span class="i">++</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h12">core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/Global.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h13">core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/RootConfig.kt</a></td><td> | </td><td class="num">1</td><td><span class="i">+</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h14">core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/Rules.kt</a></td><td> | </td><td class="num">27</td><td><span class="i">+++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h15">core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/UserInterfaceTweaks.kt</a></td><td> | </td><td class="num">16</td><td><span class="i">++++++++++</span><span class="d">------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h16">core/src/main/kotlin/me/rhunk/snapenhance/core/messaging/MessagingCoreObjects.kt</a></td><td> | </td><td class="num">31</td><td><span class="i">+++++++++++++++++++++++</span><span class="d">--------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h17">core/src/main/kotlin/me/rhunk/snapenhance/database/DatabaseAccess.kt</a></td><td> | </td><td class="num">52</td><td><span class="i">++++++++++++++++++++++++++++++++++</span><span class="d">------------------</span></td></tr>
<tr><td class="A">A</td><td><a href="#h18">core/src/main/kotlin/me/rhunk/snapenhance/features/MessagingRuleFeature.kt</a></td><td> | </td><td class="num">34</td><td><span class="i">++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h19">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/Messaging.kt</a></td><td> | </td><td class="num">4</td><td><span class="i">++</span><span class="d">--</span></td></tr>
<tr><td class="D">D</td><td><a href="#h20">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/AntiAutoDownload.kt</a></td><td> | </td><td class="num">20</td><td><span class="i"></span><span class="d">--------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h21">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/MediaDownloader.kt</a></td><td> | </td><td class="num">9</td><td><span class="i">+++++</span><span class="d">----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h22">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/spying/MessageLogger.kt</a></td><td> | </td><td class="num">4</td><td><span class="i">+</span><span class="d">---</span></td></tr>
<tr><td class="M">M</td><td><a href="#h23">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/spying/PreventReadReceipts.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h24">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/spying/StealthMode.kt</a></td><td> | </td><td class="num">20</td><td><span class="i">++++</span><span class="d">----------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h25">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/AutoSave.kt</a></td><td> | </td><td class="num">13</td><td><span class="i">++++++</span><span class="d">-------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h26">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/Notifications.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h27">core/src/main/kotlin/me/rhunk/snapenhance/manager/impl/FeatureManager.kt</a></td><td> | </td><td class="num">2</td><td><span class="i"></span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h28">core/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/FriendFeedInfoMenu.kt</a></td><td> | </td><td class="num">201</td><td><span class="i">+++++++++++++</span><span class="d">------------------------------------------------------------------</span></td></tr>
</table></pre><pre>29 files changed, 347 insertions(+), 334 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/BridgeService.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/BridgeService.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/BridgeService.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/BridgeService.kt</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -123,11 +123,12 @@ class BridgeService : Service() {
</a>             ).onReceive(intent)
         }
 
<a href="#h0-0-3" id="h0-0-3" class="d">-        override fun getRules(objectType: String, uuid: String): MutableList&lt;String&gt; {
</a><a href="#h0-0-4" id="h0-0-4" class="d">-            remoteSideContext.modDatabase.getRulesFromId(SocialScope.valueOf(objectType), uuid)
</a><a href="#h0-0-5" id="h0-0-5" class="d">-                .let { rules -&gt;
</a><a href="#h0-0-6" id="h0-0-6" class="d">-                    return rules.map { it.toJson() }.toMutableList()
</a><a href="#h0-0-7" id="h0-0-7" class="d">-                }
</a><a href="#h0-0-8" id="h0-0-8" class="i">+        override fun getRules(uuid: String): List&lt;String&gt; {
</a><a href="#h0-0-9" id="h0-0-9" class="i">+            return remoteSideContext.modDatabase.getRules(uuid).map { it.key }
</a><a href="#h0-0-10" id="h0-0-10" class="i">+        }
</a><a href="#h0-0-11" id="h0-0-11" class="i">+
</a><a href="#h0-0-12" id="h0-0-12" class="i">+        override fun setRule(uuid: String, rule: String, state: Boolean) {
</a><a href="#h0-0-13" id="h0-0-13" class="i">+            remoteSideContext.modDatabase.setRule(uuid, rule, state)
</a>         }
 
         override fun sync(callback: SyncCallback) {
<b>diff --git a/<a id="h1" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/messaging/ModDatabase.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/messaging/ModDatabase.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/messaging/ModDatabase.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/messaging/ModDatabase.kt</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -6,8 +6,7 @@ import me.rhunk.snapenhance.RemoteSideContext
</a> import me.rhunk.snapenhance.core.messaging.FriendStreaks
 import me.rhunk.snapenhance.core.messaging.MessagingFriendInfo
 import me.rhunk.snapenhance.core.messaging.MessagingGroupInfo
<a href="#h1-0-3" id="h1-0-3" class="d">-import me.rhunk.snapenhance.core.messaging.MessagingRule
</a><a href="#h1-0-4" id="h1-0-4" class="d">-import me.rhunk.snapenhance.core.messaging.SocialScope
</a><a href="#h1-0-5" id="h1-0-5" class="i">+import me.rhunk.snapenhance.core.messaging.MessagingRuleType
</a> import me.rhunk.snapenhance.database.objects.FriendInfo
 import me.rhunk.snapenhance.util.SQLiteDatabaseHelper
 import me.rhunk.snapenhance.util.ktx.getInteger
<a href="#h1-1" id="h1-1" class="h">@@ -53,10 +52,8 @@ class ModDatabase(
</a>             ),
             &quot;rules&quot; to listOf(
                 &quot;id INTEGER PRIMARY KEY AUTOINCREMENT&quot;,
<a href="#h1-1-3" id="h1-1-3" class="d">-                &quot;scope VARCHAR&quot;,
</a><a href="#h1-1-4" id="h1-1-4" class="d">-                &quot;targetUuid VARCHAR&quot;,
</a><a href="#h1-1-5" id="h1-1-5" class="d">-                //&quot;mode VARCHAR&quot;,
</a><a href="#h1-1-6" id="h1-1-6" class="d">-                &quot;subject VARCHAR&quot;
</a><a href="#h1-1-7" id="h1-1-7" class="i">+                &quot;type VARCHAR&quot;,
</a><a href="#h1-1-8" id="h1-1-8" class="i">+                &quot;targetUuid VARCHAR&quot;
</a>             ),
             &quot;streaks&quot; to listOf(
                 &quot;userId VARCHAR PRIMARY KEY&quot;,
<a href="#h1-2" id="h1-2" class="h">@@ -157,34 +154,29 @@ class ModDatabase(
</a>         }
     }
 
<a href="#h1-2-3" id="h1-2-3" class="d">-    fun getRulesFromId(type: SocialScope, targetUuid: String): List&lt;MessagingRule&gt; {
</a><a href="#h1-2-4" id="h1-2-4" class="d">-        return database.rawQuery(&quot;SELECT * FROM rules WHERE scope = ? AND targetUuid = ?&quot;, arrayOf(type.name, targetUuid)).use { cursor -&gt;
</a><a href="#h1-2-5" id="h1-2-5" class="d">-            val rules = mutableListOf&lt;MessagingRule&gt;()
</a><a href="#h1-2-6" id="h1-2-6" class="i">+    fun getRules(targetUuid: String): List&lt;MessagingRuleType&gt; {
</a><a href="#h1-2-7" id="h1-2-7" class="i">+        return database.rawQuery(&quot;SELECT type FROM rules WHERE targetUuid = ?&quot;, arrayOf(
</a><a href="#h1-2-8" id="h1-2-8" class="i">+            targetUuid
</a><a href="#h1-2-9" id="h1-2-9" class="i">+        )).use { cursor -&gt;
</a><a href="#h1-2-10" id="h1-2-10" class="i">+            val rules = mutableListOf&lt;MessagingRuleType&gt;()
</a>             while (cursor.moveToNext()) {
<a href="#h1-2-12" id="h1-2-12" class="d">-                rules.add(MessagingRule(
</a><a href="#h1-2-13" id="h1-2-13" class="d">-                    id = cursor.getInteger(&quot;id&quot;),
</a><a href="#h1-2-14" id="h1-2-14" class="d">-                    socialScope = SocialScope.valueOf(cursor.getStringOrNull(&quot;scope&quot;)!!),
</a><a href="#h1-2-15" id="h1-2-15" class="d">-                    targetUuid = cursor.getStringOrNull(&quot;targetUuid&quot;)!!,
</a><a href="#h1-2-16" id="h1-2-16" class="d">-                    subject = cursor.getStringOrNull(&quot;subject&quot;)!!
</a><a href="#h1-2-17" id="h1-2-17" class="d">-                ))
</a><a href="#h1-2-18" id="h1-2-18" class="i">+                rules.add(MessagingRuleType.getByName(cursor.getStringOrNull(&quot;type&quot;)!!))
</a>             }
             rules
         }
     }
 
<a href="#h1-2-24" id="h1-2-24" class="d">-    fun toggleRuleFor(type: SocialScope, targetUuid: String, subject: String, enabled: Boolean) {
</a><a href="#h1-2-25" id="h1-2-25" class="i">+    fun setRule(targetUuid: String, type: String, enabled: Boolean) {
</a>         executeAsync {
             if (enabled) {
<a href="#h1-2-28" id="h1-2-28" class="d">-                database.execSQL(&quot;INSERT OR REPLACE INTO rules (scope, targetUuid, subject) VALUES (?, ?, ?)&quot;, arrayOf(
</a><a href="#h1-2-29" id="h1-2-29" class="d">-                    type.name,
</a><a href="#h1-2-30" id="h1-2-30" class="i">+                database.execSQL(&quot;INSERT OR REPLACE INTO rules (targetUuid, type) VALUES (?, ?)&quot;, arrayOf(
</a>                     targetUuid,
<a href="#h1-2-32" id="h1-2-32" class="d">-                    subject
</a><a href="#h1-2-33" id="h1-2-33" class="i">+                    type
</a>                 ))
             } else {
<a href="#h1-2-36" id="h1-2-36" class="d">-                database.execSQL(&quot;DELETE FROM rules WHERE scope = ? AND targetUuid = ? AND subject = ?&quot;, arrayOf(
</a><a href="#h1-2-37" id="h1-2-37" class="d">-                    type.name,
</a><a href="#h1-2-38" id="h1-2-38" class="i">+                database.execSQL(&quot;DELETE FROM rules WHERE targetUuid = ? AND type = ?&quot;, arrayOf(
</a>                     targetUuid,
<a href="#h1-2-40" id="h1-2-40" class="d">-                    subject
</a><a href="#h1-2-41" id="h1-2-41" class="i">+                    type
</a>                 ))
             }
         }
<b>diff --git a/<a id="h2" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/features/Dialogs.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/features/Dialogs.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/features/Dialogs.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/features/Dialogs.kt</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -57,10 +57,7 @@ class Dialogs(
</a>     @Composable
     fun TranslatedText(property: PropertyPair&lt;*&gt;, key: String, modifier: Modifier = Modifier) {
         Text(
<a href="#h2-0-3" id="h2-0-3" class="d">-            text = when (key) {
</a><a href="#h2-0-4" id="h2-0-4" class="d">-                &quot;null&quot; -&gt; translation[&quot;manager.features.disabled&quot;]
</a><a href="#h2-0-5" id="h2-0-5" class="d">-                else -&gt; if (property.key.params.shouldTranslate) translation[&quot;features.options.${property.key.name}.$key&quot;] else key
</a><a href="#h2-0-6" id="h2-0-6" class="d">-            },
</a><a href="#h2-0-7" id="h2-0-7" class="i">+            text = property.key.propertyOption(translation, key),
</a>             modifier = Modifier
                 .padding(10.dp, 10.dp, 10.dp, 10.dp)
                 .then(modifier)
<b>diff --git a/<a id="h3" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/features/FeaturesSection.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/features/FeaturesSection.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/features/FeaturesSection.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/features/FeaturesSection.kt</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -28,6 +28,7 @@ import androidx.compose.material.icons.Icons
</a> import androidx.compose.material.icons.filled.Close
 import androidx.compose.material.icons.filled.FolderOpen
 import androidx.compose.material.icons.filled.OpenInNew
<a href="#h3-0-3" id="h3-0-3" class="i">+import androidx.compose.material.icons.filled.Rule
</a> import androidx.compose.material.icons.filled.Search
 import androidx.compose.material.icons.rounded.Save
 import androidx.compose.material3.BottomSheetScaffoldState
<a href="#h3-1" id="h3-1" class="h">@@ -71,6 +72,7 @@ import kotlinx.coroutines.Job
</a> import kotlinx.coroutines.delay
 import kotlinx.coroutines.launch
 import me.rhunk.snapenhance.core.config.ConfigContainer
<a href="#h3-1-3" id="h3-1-3" class="i">+import me.rhunk.snapenhance.core.config.ConfigFlag
</a> import me.rhunk.snapenhance.core.config.DataProcessors
 import me.rhunk.snapenhance.core.config.PropertyKey
 import me.rhunk.snapenhance.core.config.PropertyPair
<a href="#h3-2" id="h3-2" class="h">@@ -172,8 +174,8 @@ class FeaturesSection : Section() {
</a>                 backStackEntry.arguments?.getString(&quot;keyword&quot;)?.let { keyword -&gt;
                     val properties = allProperties.filter {
                         it.key.name.contains(keyword, ignoreCase = true) ||
<a href="#h3-2-3" id="h3-2-3" class="d">-                                context.translation[&quot;${it.key.propertyTranslationPath()}.name&quot;].contains(keyword, ignoreCase = true) ||
</a><a href="#h3-2-4" id="h3-2-4" class="d">-                                context.translation[&quot;${it.key.propertyTranslationPath()}.description&quot;].contains(keyword, ignoreCase = true)
</a><a href="#h3-2-5" id="h3-2-5" class="i">+                                context.translation[it.key.propertyName()].contains(keyword, ignoreCase = true) ||
</a><a href="#h3-2-6" id="h3-2-6" class="i">+                                context.translation[it.key.propertyDescription()].contains(keyword, ignoreCase = true)
</a>                     }.map { PropertyPair(it.key, it.value) }
 
                     PropertiesView(properties)
<a href="#h3-3" id="h3-3" class="h">@@ -199,7 +201,7 @@ class FeaturesSection : Section() {
</a> 
         val propertyValue = property.value
 
<a href="#h3-3-3" id="h3-3-3" class="d">-        if (property.key.params.isFolder) {
</a><a href="#h3-3-4" id="h3-3-4" class="i">+        if (property.key.params.flags.contains(ConfigFlag.FOLDER)) {
</a>             IconButton(onClick = registerClickCallback {
                 openFolderCallback = { uri -&gt;
                     propertyValue.setAny(uri)
<a href="#h3-4" id="h3-4" class="h">@@ -234,11 +236,9 @@ class FeaturesSection : Section() {
</a>                     overflow = TextOverflow.Ellipsis,
                     maxLines = 1,
                     modifier = Modifier.widthIn(0.dp, 120.dp),
<a href="#h3-4-3" id="h3-4-3" class="d">-                    text = (propertyValue.getNullable() as? String)?.let{
</a><a href="#h3-4-4" id="h3-4-4" class="d">-                        if (property.key.params.shouldTranslate) {
</a><a href="#h3-4-5" id="h3-4-5" class="d">-                            context.translation[&quot;features.options.${property.name}.$it&quot;]
</a><a href="#h3-4-6" id="h3-4-6" class="d">-                        } else it
</a><a href="#h3-4-7" id="h3-4-7" class="d">-                    } ?: context.translation[&quot;manager.features.disabled&quot;],
</a><a href="#h3-4-8" id="h3-4-8" class="i">+                    text = (propertyValue.getNullable() as? String ?: &quot;null&quot;).let {
</a><a href="#h3-4-9" id="h3-4-9" class="i">+                        property.key.propertyOption(context.translation, it)
</a><a href="#h3-4-10" id="h3-4-10" class="i">+                    }
</a>                 )
             }
 
<a href="#h3-5" id="h3-5" class="h">@@ -353,12 +353,12 @@ class FeaturesSection : Section() {
</a>                         .padding(all = 10.dp)
                 ) {
                     Text(
<a href="#h3-5-3" id="h3-5-3" class="d">-                        text = context.translation[&quot;${property.key.propertyTranslationPath()}.name&quot;],
</a><a href="#h3-5-4" id="h3-5-4" class="i">+                        text = context.translation[property.key.propertyName()],
</a>                         fontSize = 16.sp,
                         fontWeight = FontWeight.Bold
                     )
                     Text(
<a href="#h3-5-9" id="h3-5-9" class="d">-                        text = context.translation[&quot;${property.key.propertyTranslationPath()}.description&quot;],
</a><a href="#h3-5-10" id="h3-5-10" class="i">+                        text = context.translation[property.key.propertyDescription()],
</a>                         fontSize = 12.sp,
                         lineHeight = 15.sp
                     )
<b>diff --git a/<a id="h4" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/social/ScopeContent.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/social/ScopeContent.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/social/ScopeContent.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/social/ScopeContent.kt</a></b>
<a href="#h4-0" id="h4-0" class="h">@@ -71,23 +71,33 @@ class ScopeContent(
</a> 
             Spacer(modifier = Modifier.height(16.dp))
 
<a href="#h4-0-3" id="h4-0-3" class="d">-            val scopeRules = context.modDatabase.getRulesFromId(scope, id)
</a><a href="#h4-0-4" id="h4-0-4" class="i">+            val rules = context.modDatabase.getRules(id)
</a> 
             SectionTitle(&quot;Rules&quot;)
 
             ContentCard {
                 //manager anti features etc
<a href="#h4-0-10" id="h4-0-10" class="d">-                MessagingRuleType.values().forEach { feature -&gt;
</a><a href="#h4-0-11" id="h4-0-11" class="d">-                    var featureEnabled by remember {
</a><a href="#h4-0-12" id="h4-0-12" class="d">-                        mutableStateOf(scopeRules.any { it.subject == feature.key })
</a><a href="#h4-0-13" id="h4-0-13" class="i">+                MessagingRuleType.values().forEach { ruleType -&gt;
</a><a href="#h4-0-14" id="h4-0-14" class="i">+                    var ruleEnabled by remember {
</a><a href="#h4-0-15" id="h4-0-15" class="i">+                        mutableStateOf(rules.any { it.key == ruleType.key })
</a>                     }
<a href="#h4-0-17" id="h4-0-17" class="d">-                    val featureEnabledText = if (featureEnabled) &quot;Enabled&quot; else &quot;Disabled&quot;
</a> 
<a href="#h4-0-19" id="h4-0-19" class="d">-                    Row {
</a><a href="#h4-0-20" id="h4-0-20" class="d">-                        Text(text = &quot;${feature.key}: $featureEnabledText&quot;, maxLines = 1)
</a><a href="#h4-0-21" id="h4-0-21" class="d">-                        Switch(checked = featureEnabled, onCheckedChange = {
</a><a href="#h4-0-22" id="h4-0-22" class="d">-                            context.modDatabase.toggleRuleFor(scope, id, feature.key, it)
</a><a href="#h4-0-23" id="h4-0-23" class="d">-                            featureEnabled = it
</a><a href="#h4-0-24" id="h4-0-24" class="i">+                    val ruleState = context.config.root.rules.getRuleState(ruleType)
</a><a href="#h4-0-25" id="h4-0-25" class="i">+
</a><a href="#h4-0-26" id="h4-0-26" class="i">+                    Row(
</a><a href="#h4-0-27" id="h4-0-27" class="i">+                        verticalAlignment = Alignment.CenterVertically,
</a><a href="#h4-0-28" id="h4-0-28" class="i">+                        modifier = Modifier.padding(all = 4.dp)
</a><a href="#h4-0-29" id="h4-0-29" class="i">+                    ) {
</a><a href="#h4-0-30" id="h4-0-30" class="i">+                        Text(
</a><a href="#h4-0-31" id="h4-0-31" class="i">+                            text = if (ruleType.listMode &amp;&amp; ruleState != null) {
</a><a href="#h4-0-32" id="h4-0-32" class="i">+                                context.translation[&quot;rules.properties.${ruleType.key}.options.${ruleState.key}&quot;]
</a><a href="#h4-0-33" id="h4-0-33" class="i">+                            } else context.translation[&quot;rules.properties.${ruleType.key}.name&quot;],
</a><a href="#h4-0-34" id="h4-0-34" class="i">+                            maxLines = 1,
</a><a href="#h4-0-35" id="h4-0-35" class="i">+                            modifier = Modifier.weight(1f)
</a><a href="#h4-0-36" id="h4-0-36" class="i">+                        )
</a><a href="#h4-0-37" id="h4-0-37" class="i">+                        Switch(checked = ruleEnabled, enabled = if (ruleType.listMode) ruleState != null else true, onCheckedChange = {
</a><a href="#h4-0-38" id="h4-0-38" class="i">+                            context.modDatabase.setRule(id, ruleType.key, it)
</a><a href="#h4-0-39" id="h4-0-39" class="i">+                            ruleEnabled = it
</a>                         })
                     }
                 }
<a href="#h4-1" id="h4-1" class="h">@@ -195,9 +205,9 @@ class ScopeContent(
</a>                 fontSize = 12.sp,
                 fontWeight = FontWeight.Light
             )
<a href="#h4-1-3" id="h4-1-3" class="d">-            Spacer(modifier = Modifier.height(16.dp))
</a><a href="#h4-1-4" id="h4-1-4" class="i">+           // Spacer(modifier = Modifier.height(16.dp))
</a> 
<a href="#h4-1-6" id="h4-1-6" class="d">-            DeleteScopeEntityButton()
</a><a href="#h4-1-7" id="h4-1-7" class="i">+            //DeleteScopeEntityButton()
</a>         }
 
         Spacer(modifier = Modifier.height(16.dp))
<b>diff --git a/<a id="h5" href="../file/core/src/main/aidl/me/rhunk/snapenhance/bridge/BridgeInterface.aidl.html">core/src/main/aidl/me/rhunk/snapenhance/bridge/BridgeInterface.aidl</a> b/<a href="../file/core/src/main/aidl/me/rhunk/snapenhance/bridge/BridgeInterface.aidl.html">core/src/main/aidl/me/rhunk/snapenhance/bridge/BridgeInterface.aidl</a></b>
<a href="#h5-0" id="h5-0" class="h">@@ -63,8 +63,12 @@ interface BridgeInterface {
</a>     /**
     * Get rules for a given user or conversation
     */
<a href="#h5-0-3" id="h5-0-3" class="i">+    List&lt;String&gt; getRules(String uuid);
</a> 
<a href="#h5-0-5" id="h5-0-5" class="d">-    List&lt;String&gt; getRules(String objectType, String uuid);
</a><a href="#h5-0-6" id="h5-0-6" class="i">+    /**
</a><a href="#h5-0-7" id="h5-0-7" class="i">+    * Update rule for a giver user or conversation
</a><a href="#h5-0-8" id="h5-0-8" class="i">+    */
</a><a href="#h5-0-9" id="h5-0-9" class="i">+    void setRule(String uuid, String type, boolean state);
</a> 
     /**
     * Sync groups and friends
<b>diff --git a/<a id="h6" href="../file/core/src/main/assets/lang/en_US.json.html">core/src/main/assets/lang/en_US.json</a> b/<a href="../file/core/src/main/assets/lang/en_US.json.html">core/src/main/assets/lang/en_US.json</a></b>
<a href="#h6-0" id="h6-0" class="h">@@ -28,6 +28,42 @@
</a>         }
     },
 
<a href="#h6-0-3" id="h6-0-3" class="i">+    &quot;rules&quot;: {
</a><a href="#h6-0-4" id="h6-0-4" class="i">+        &quot;modes&quot;: {
</a><a href="#h6-0-5" id="h6-0-5" class="i">+            &quot;blacklist&quot;: &quot;Blacklist mode&quot;,
</a><a href="#h6-0-6" id="h6-0-6" class="i">+            &quot;whitelist&quot;: &quot;Whitelist mode&quot;
</a><a href="#h6-0-7" id="h6-0-7" class="i">+        },
</a><a href="#h6-0-8" id="h6-0-8" class="i">+        &quot;properties&quot;: {
</a><a href="#h6-0-9" id="h6-0-9" class="i">+            &quot;auto_download&quot;: {
</a><a href="#h6-0-10" id="h6-0-10" class="i">+                &quot;name&quot;: &quot;Auto download&quot;,
</a><a href="#h6-0-11" id="h6-0-11" class="i">+                &quot;description&quot;: &quot;Auto download snaps when viewed&quot;,
</a><a href="#h6-0-12" id="h6-0-12" class="i">+                &quot;options&quot;: {
</a><a href="#h6-0-13" id="h6-0-13" class="i">+                    &quot;blacklist&quot;: &quot;Exclude from Auto Download&quot;,
</a><a href="#h6-0-14" id="h6-0-14" class="i">+                    &quot;whitelist&quot;: &quot;Auto Download&quot;
</a><a href="#h6-0-15" id="h6-0-15" class="i">+                }
</a><a href="#h6-0-16" id="h6-0-16" class="i">+            },
</a><a href="#h6-0-17" id="h6-0-17" class="i">+            &quot;stealth&quot;: {
</a><a href="#h6-0-18" id="h6-0-18" class="i">+                &quot;name&quot;: &quot;Stealth Mode&quot;,
</a><a href="#h6-0-19" id="h6-0-19" class="i">+                &quot;description&quot;: &quot;Prevents anyone from knowing you&#39;ve opened their Snaps/Chats and conversations&quot;,
</a><a href="#h6-0-20" id="h6-0-20" class="i">+                &quot;options&quot;: {
</a><a href="#h6-0-21" id="h6-0-21" class="i">+                    &quot;blacklist&quot;: &quot;Exclude from stealth mode&quot;,
</a><a href="#h6-0-22" id="h6-0-22" class="i">+                    &quot;whitelist&quot;: &quot;Stealth mode&quot;
</a><a href="#h6-0-23" id="h6-0-23" class="i">+                }
</a><a href="#h6-0-24" id="h6-0-24" class="i">+            },
</a><a href="#h6-0-25" id="h6-0-25" class="i">+            &quot;auto_save&quot;: {
</a><a href="#h6-0-26" id="h6-0-26" class="i">+                &quot;name&quot;: &quot;Auto Save&quot;,
</a><a href="#h6-0-27" id="h6-0-27" class="i">+                &quot;description&quot;: &quot;Saves chat messages when viewed&quot;,
</a><a href="#h6-0-28" id="h6-0-28" class="i">+                &quot;options&quot;: {
</a><a href="#h6-0-29" id="h6-0-29" class="i">+                    &quot;blacklist&quot;: &quot;Exclude from auto save&quot;,
</a><a href="#h6-0-30" id="h6-0-30" class="i">+                    &quot;whitelist&quot;: &quot;Auto save&quot;
</a><a href="#h6-0-31" id="h6-0-31" class="i">+                }
</a><a href="#h6-0-32" id="h6-0-32" class="i">+            },
</a><a href="#h6-0-33" id="h6-0-33" class="i">+            &quot;hide_chat_feed&quot;: {
</a><a href="#h6-0-34" id="h6-0-34" class="i">+                &quot;name&quot;: &quot;Hide from chat feed&quot;
</a><a href="#h6-0-35" id="h6-0-35" class="i">+            }
</a><a href="#h6-0-36" id="h6-0-36" class="i">+        }
</a><a href="#h6-0-37" id="h6-0-37" class="i">+    },
</a><a href="#h6-0-38" id="h6-0-38" class="i">+
</a>     &quot;action&quot;: {
         &quot;clean_cache&quot;: &quot;Clean Cache&quot;,
         &quot;clear_message_logger&quot;: &quot;Clear Message Logger&quot;,
<a href="#h6-1" id="h6-1" class="h">@@ -239,6 +275,10 @@
</a>                     }
                 }
             },
<a href="#h6-1-3" id="h6-1-3" class="i">+            &quot;rules&quot;: {
</a><a href="#h6-1-4" id="h6-1-4" class="i">+                &quot;name&quot;: &quot;Rules&quot;,
</a><a href="#h6-1-5" id="h6-1-5" class="i">+                &quot;description&quot;: &quot;Manage automatic features\nThe social tab lets you assign a rule to an object&quot;
</a><a href="#h6-1-6" id="h6-1-6" class="i">+            },
</a>             &quot;camera&quot;: {
                 &quot;name&quot;: &quot;Camera&quot;,
                 &quot;description&quot;: &quot;Adjust the right settings for the perfect snap&quot;,
<b>diff --git a/<a id="h7" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/bridge/BridgeClient.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/bridge/BridgeClient.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/bridge/BridgeClient.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/bridge/BridgeClient.kt</a></b>
<a href="#h7-0" id="h7-0" class="h">@@ -15,10 +15,8 @@ import me.rhunk.snapenhance.ModContext
</a> import me.rhunk.snapenhance.bridge.types.BridgeFileType
 import me.rhunk.snapenhance.bridge.types.FileActionType
 import me.rhunk.snapenhance.core.BuildConfig
<a href="#h7-0-3" id="h7-0-3" class="d">-import me.rhunk.snapenhance.core.messaging.MessagingRule
</a><a href="#h7-0-4" id="h7-0-4" class="d">-import me.rhunk.snapenhance.core.messaging.SocialScope
</a><a href="#h7-0-5" id="h7-0-5" class="i">+import me.rhunk.snapenhance.core.messaging.MessagingRuleType
</a> import me.rhunk.snapenhance.data.LocalePair
<a href="#h7-0-7" id="h7-0-7" class="d">-import me.rhunk.snapenhance.util.SerializableDataObject
</a> import java.util.concurrent.CompletableFuture
 import java.util.concurrent.Executors
 import kotlin.system.exitProcess
<a href="#h7-1" id="h7-1" class="h">@@ -138,9 +136,10 @@ class BridgeClient(
</a> 
     fun passGroupsAndFriends(groups: List&lt;String&gt;, friends: List&lt;String&gt;) = service.passGroupsAndFriends(groups, friends)
 
<a href="#h7-1-3" id="h7-1-3" class="d">-    fun getRulesFromId(type: SocialScope, targetUuid: String): List&lt;MessagingRule&gt; {
</a><a href="#h7-1-4" id="h7-1-4" class="d">-        return service.getRules(type.name, targetUuid).map {
</a><a href="#h7-1-5" id="h7-1-5" class="d">-            SerializableDataObject.fromJson(it, MessagingRule::class.java)
</a><a href="#h7-1-6" id="h7-1-6" class="d">-        }.toList()
</a><a href="#h7-1-7" id="h7-1-7" class="i">+    fun getRules(targetUuid: String): List&lt;MessagingRuleType&gt; {
</a><a href="#h7-1-8" id="h7-1-8" class="i">+        return service.getRules(targetUuid).map { MessagingRuleType.getByName(it) }
</a>     }
<a href="#h7-1-10" id="h7-1-10" class="i">+
</a><a href="#h7-1-11" id="h7-1-11" class="i">+    fun setRule(targetUuid: String, type: MessagingRuleType, state: Boolean)
</a><a href="#h7-1-12" id="h7-1-12" class="i">+        = service.setRule(targetUuid, type.key, state)
</a> }
<b>diff --git a/<a id="h8" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/config/ConfigContainer.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/config/ConfigContainer.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/config/ConfigContainer.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/config/ConfigContainer.kt</a></b>
<a href="#h8-0" id="h8-0" class="h">@@ -71,9 +71,8 @@ open class ConfigContainer(
</a>     fun fromJson(json: JsonObject) {
         properties.forEach { (key, _) -&gt;
             val jsonElement = json.get(key.name) ?: return@forEach
<a href="#h8-0-3" id="h8-0-3" class="d">-            key.dataType.deserializeAny(jsonElement)?.let {
</a><a href="#h8-0-4" id="h8-0-4" class="d">-                properties[key]?.setAny(it)
</a><a href="#h8-0-5" id="h8-0-5" class="d">-            }
</a><a href="#h8-0-6" id="h8-0-6" class="i">+            //TODO: check incoming values
</a><a href="#h8-0-7" id="h8-0-7" class="i">+            properties[key]?.setAny(key.dataType.deserializeAny(jsonElement))
</a>         }
     }
 
<b>diff --git a/<a id="h9" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/config/ConfigObjects.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/config/ConfigObjects.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/config/ConfigObjects.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/config/ConfigObjects.kt</a></b>
<a href="#h9-0" id="h9-0" class="h">@@ -1,5 +1,6 @@
</a> package me.rhunk.snapenhance.core.config
 
<a href="#h9-0-2" id="h9-0-2" class="i">+import me.rhunk.snapenhance.bridge.wrapper.LocaleWrapper
</a> import kotlin.reflect.KProperty
 
 
<a href="#h9-1" id="h9-1" class="h">@@ -10,17 +11,43 @@ data class PropertyPair&lt;T&gt;(
</a>     val name get() = key.name
 }
 
<a href="#h9-1-3" id="h9-1-3" class="i">+enum class FeatureNotice(
</a><a href="#h9-1-4" id="h9-1-4" class="i">+    val id: Int,
</a><a href="#h9-1-5" id="h9-1-5" class="i">+    val key: String
</a><a href="#h9-1-6" id="h9-1-6" class="i">+) {
</a><a href="#h9-1-7" id="h9-1-7" class="i">+    UNSTABLE(0b0001, &quot;unstable&quot;),
</a><a href="#h9-1-8" id="h9-1-8" class="i">+    MAY_BAN(0b0010, &quot;may_ban&quot;),
</a><a href="#h9-1-9" id="h9-1-9" class="i">+    MAY_BREAK_INTERNAL_BEHAVIOR(0b0100, &quot;may_break_internal_behavior&quot;),
</a><a href="#h9-1-10" id="h9-1-10" class="i">+    MAY_CAUSE_CRASHES(0b1000, &quot;may_cause_crashes&quot;);
</a><a href="#h9-1-11" id="h9-1-11" class="i">+}
</a><a href="#h9-1-12" id="h9-1-12" class="i">+
</a><a href="#h9-1-13" id="h9-1-13" class="i">+enum class ConfigFlag(
</a><a href="#h9-1-14" id="h9-1-14" class="i">+    val id: Int
</a><a href="#h9-1-15" id="h9-1-15" class="i">+) {
</a><a href="#h9-1-16" id="h9-1-16" class="i">+    NO_TRANSLATE(0b0001),
</a><a href="#h9-1-17" id="h9-1-17" class="i">+    HIDDEN(0b0010),
</a><a href="#h9-1-18" id="h9-1-18" class="i">+    FOLDER(0b0100),
</a><a href="#h9-1-19" id="h9-1-19" class="i">+    NO_DISABLE_KEY(0b1000)
</a><a href="#h9-1-20" id="h9-1-20" class="i">+}
</a><a href="#h9-1-21" id="h9-1-21" class="i">+
</a> class ConfigParams(
<a href="#h9-1-23" id="h9-1-23" class="i">+    private var _flags: Int? = null,
</a>     private var _notices: Int? = null,
<a href="#h9-1-25" id="h9-1-25" class="d">-    var shouldTranslate: Boolean = true,
</a><a href="#h9-1-26" id="h9-1-26" class="d">-    var isHidden: Boolean = false,
</a><a href="#h9-1-27" id="h9-1-27" class="d">-    var isFolder: Boolean = false,
</a><a href="#h9-1-28" id="h9-1-28" class="i">+
</a><a href="#h9-1-29" id="h9-1-29" class="i">+    var icon: String? = null,
</a>     var disabledKey: String? = null,
<a href="#h9-1-31" id="h9-1-31" class="d">-    var icon: String? = null
</a><a href="#h9-1-32" id="h9-1-32" class="i">+    var customTranslationPath: String? = null,
</a><a href="#h9-1-33" id="h9-1-33" class="i">+    var customOptionTranslationPath: String? = null
</a> ) {
     val notices get() = _notices?.let { FeatureNotice.values().filter { flag -&gt; it and flag.id != 0 } } ?: emptyList()
<a href="#h9-1-36" id="h9-1-36" class="d">-    fun addNotices(vararg flags: FeatureNotice) {
</a><a href="#h9-1-37" id="h9-1-37" class="d">-        this._notices = (this._notices ?: 0) or flags.fold(0) { acc, featureNotice -&gt; acc or featureNotice.id }
</a><a href="#h9-1-38" id="h9-1-38" class="i">+    val flags get() = _flags?.let { ConfigFlag.values().filter { flag -&gt; it and flag.id != 0 } } ?: emptyList()
</a><a href="#h9-1-39" id="h9-1-39" class="i">+
</a><a href="#h9-1-40" id="h9-1-40" class="i">+    fun addNotices(vararg values: FeatureNotice) {
</a><a href="#h9-1-41" id="h9-1-41" class="i">+        this._notices = (this._notices ?: 0) or values.fold(0) { acc, featureNotice -&gt; acc or featureNotice.id }
</a><a href="#h9-1-42" id="h9-1-42" class="i">+    }
</a><a href="#h9-1-43" id="h9-1-43" class="i">+
</a><a href="#h9-1-44" id="h9-1-44" class="i">+    fun addFlags(vararg values: ConfigFlag) {
</a><a href="#h9-1-45" id="h9-1-45" class="i">+        this._flags = (this._flags ?: 0) or values.fold(0) { acc, flag -&gt; acc or flag.id }
</a>     }
 }
 
<a href="#h9-2" id="h9-2" class="h">@@ -55,12 +82,28 @@ data class PropertyKey&lt;T&gt;(
</a> ) {
     val parentKey by lazy { _parent() }
 
<a href="#h9-2-3" id="h9-2-3" class="i">+    fun propertyOption(translation: LocaleWrapper, key: String): String {
</a><a href="#h9-2-4" id="h9-2-4" class="i">+        if (key == &quot;null&quot;) {
</a><a href="#h9-2-5" id="h9-2-5" class="i">+            return translation[params.disabledKey ?: &quot;manager.features.disabled&quot;]
</a><a href="#h9-2-6" id="h9-2-6" class="i">+        }
</a><a href="#h9-2-7" id="h9-2-7" class="i">+
</a><a href="#h9-2-8" id="h9-2-8" class="i">+        return if (!params.flags.contains(ConfigFlag.NO_TRANSLATE))
</a><a href="#h9-2-9" id="h9-2-9" class="i">+            translation[params.customOptionTranslationPath?.let {
</a><a href="#h9-2-10" id="h9-2-10" class="i">+                &quot;$it.$key&quot;
</a><a href="#h9-2-11" id="h9-2-11" class="i">+            } ?: &quot;features.options.${name}.$key&quot;]
</a><a href="#h9-2-12" id="h9-2-12" class="i">+        else key
</a><a href="#h9-2-13" id="h9-2-13" class="i">+    }
</a><a href="#h9-2-14" id="h9-2-14" class="i">+
</a><a href="#h9-2-15" id="h9-2-15" class="i">+    fun propertyName() = propertyTranslationPath() + &quot;.name&quot;
</a><a href="#h9-2-16" id="h9-2-16" class="i">+    fun propertyDescription() = propertyTranslationPath() + &quot;.description&quot;
</a><a href="#h9-2-17" id="h9-2-17" class="i">+
</a>     fun propertyTranslationPath(): String {
<a href="#h9-2-19" id="h9-2-19" class="d">-        return if (parentKey != null) {
</a><a href="#h9-2-20" id="h9-2-20" class="d">-            &quot;${parentKey!!.propertyTranslationPath()}.properties.$name&quot;
</a><a href="#h9-2-21" id="h9-2-21" class="d">-        } else {
</a><a href="#h9-2-22" id="h9-2-22" class="d">-            &quot;features.properties.$name&quot;
</a><a href="#h9-2-23" id="h9-2-23" class="i">+        params.customTranslationPath?.let {
</a><a href="#h9-2-24" id="h9-2-24" class="i">+            return it
</a>         }
<a href="#h9-2-26" id="h9-2-26" class="i">+        return parentKey?.let {
</a><a href="#h9-2-27" id="h9-2-27" class="i">+            &quot;${it.propertyTranslationPath()}.properties.$name&quot;
</a><a href="#h9-2-28" id="h9-2-28" class="i">+        } ?: &quot;features.properties.$name&quot;
</a>     }
 }
 
<b>diff --git a/<a id="h10" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/Camera.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/Camera.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/Camera.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/Camera.kt</a></b>
<a href="#h10-0" id="h10-0" class="h">@@ -1,6 +1,7 @@
</a> package me.rhunk.snapenhance.core.config.impl
 
 import me.rhunk.snapenhance.core.config.ConfigContainer
<a href="#h10-0-3" id="h10-0-3" class="i">+import me.rhunk.snapenhance.core.config.ConfigFlag
</a> import me.rhunk.snapenhance.core.config.FeatureNotice
 import me.rhunk.snapenhance.features.impl.tweaks.CameraTweaks
 
<a href="#h10-1" id="h10-1" class="h">@@ -8,9 +9,9 @@ class Camera : ConfigContainer() {
</a>     val disable = boolean(&quot;disable_camera&quot;)
     val immersiveCameraPreview = boolean(&quot;immersive_camera_preview&quot;) { addNotices(FeatureNotice.MAY_CAUSE_CRASHES) }
     val overridePreviewResolution = unique(&quot;override_preview_resolution&quot;, *CameraTweaks.resolutions.toTypedArray())
<a href="#h10-1-3" id="h10-1-3" class="d">-        { shouldTranslate = false }
</a><a href="#h10-1-4" id="h10-1-4" class="i">+        { addFlags(ConfigFlag.NO_TRANSLATE) }
</a>     val overridePictureResolution = unique(&quot;override_picture_resolution&quot;, *CameraTweaks.resolutions.toTypedArray())
<a href="#h10-1-6" id="h10-1-6" class="d">-        { shouldTranslate = false }
</a><a href="#h10-1-7" id="h10-1-7" class="i">+        { addFlags(ConfigFlag.NO_TRANSLATE) }
</a>     val forceHighestFrameRate = boolean(&quot;force_highest_frame_rate&quot;) { addNotices(FeatureNotice.MAY_BREAK_INTERNAL_BEHAVIOR) }
     val forceCameraSourceEncoding = boolean(&quot;force_camera_source_encoding&quot;)
 }
<b>diff --git a/<a id="h11" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/DownloaderConfig.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/DownloaderConfig.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/DownloaderConfig.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/DownloaderConfig.kt</a></b>
<a href="#h11-0" id="h11-0" class="h">@@ -1,10 +1,11 @@
</a> package me.rhunk.snapenhance.core.config.impl
 
 import me.rhunk.snapenhance.core.config.ConfigContainer
<a href="#h11-0-3" id="h11-0-3" class="i">+import me.rhunk.snapenhance.core.config.ConfigFlag
</a> import me.rhunk.snapenhance.core.config.FeatureNotice
 
 class DownloaderConfig : ConfigContainer() {
<a href="#h11-0-7" id="h11-0-7" class="d">-    val saveFolder = string(&quot;save_folder&quot;) { isFolder = true }
</a><a href="#h11-0-8" id="h11-0-8" class="i">+    val saveFolder = string(&quot;save_folder&quot;) { addFlags(ConfigFlag.FOLDER) }
</a>     val autoDownloadOptions = multiple(&quot;auto_download_options&quot;,
         &quot;friend_snaps&quot;,
         &quot;friend_stories&quot;,
<b>diff --git a/<a id="h12" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/Global.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/Global.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/Global.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/Global.kt</a></b>
<a href="#h12-0" id="h12-0" class="h">@@ -6,7 +6,7 @@ import me.rhunk.snapenhance.data.NotificationType
</a> 
 class Global : ConfigContainer() {
     val snapchatPlus = boolean(&quot;snapchat_plus&quot;) { addNotices(FeatureNotice.MAY_BAN) }
<a href="#h12-0-3" id="h12-0-3" class="d">-    val autoUpdater = unique(&quot;auto_updater&quot;, &quot;EVERY_LAUNCH&quot;, &quot;DAILY&quot;, &quot;WEEKLY&quot;)
</a><a href="#h12-0-4" id="h12-0-4" class="i">+    val autoUpdater = unique(&quot;auto_updater&quot;, &quot;EVERY_LAUNCH&quot;, &quot;DAILY&quot;, &quot;WEEKLY&quot;).apply { set(&quot;DAILY&quot;) }
</a>     val disableMetrics = boolean(&quot;disable_metrics&quot;)
     val blockAds = boolean(&quot;block_ads&quot;)
     val disableVideoLengthRestrictions = boolean(&quot;disable_video_length_restrictions&quot;) { addNotices(FeatureNotice.MAY_BAN) }
<b>diff --git a/<a id="h13" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/RootConfig.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/RootConfig.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/RootConfig.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/RootConfig.kt</a></b>
<a href="#h13-0" id="h13-0" class="h">@@ -7,6 +7,7 @@ class RootConfig : ConfigContainer() {
</a>     val userInterface = container(&quot;user_interface&quot;, UserInterfaceTweaks()) { icon = &quot;RemoveRedEye&quot;}
     val messaging = container(&quot;messaging&quot;, MessagingTweaks()) { icon = &quot;Send&quot; }
     val global = container(&quot;global&quot;, Global()) { icon = &quot;MiscellaneousServices&quot; }
<a href="#h13-0-3" id="h13-0-3" class="i">+    val rules = container(&quot;rules&quot;, Rules()) { icon = &quot;Rule&quot; }
</a>     val camera = container(&quot;camera&quot;, Camera()) { icon = &quot;Camera&quot;}
     val experimental = container(&quot;experimental&quot;, Experimental()) { icon = &quot;Science&quot; }
     val spoof = container(&quot;spoof&quot;, Spoof()) { icon = &quot;Fingerprint&quot; }
<b>diff --git a/<a id="h14" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/Rules.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/Rules.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/Rules.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/Rules.kt</a></b>
<a href="#h14-0" id="h14-0" class="h">@@ -0,0 +1,26 @@
</a><a href="#h14-0-0" id="h14-0-0" class="i">+package me.rhunk.snapenhance.core.config.impl
</a><a href="#h14-0-1" id="h14-0-1" class="i">+
</a><a href="#h14-0-2" id="h14-0-2" class="i">+import me.rhunk.snapenhance.core.config.ConfigContainer
</a><a href="#h14-0-3" id="h14-0-3" class="i">+import me.rhunk.snapenhance.core.config.PropertyValue
</a><a href="#h14-0-4" id="h14-0-4" class="i">+import me.rhunk.snapenhance.core.messaging.MessagingRuleType
</a><a href="#h14-0-5" id="h14-0-5" class="i">+import me.rhunk.snapenhance.core.messaging.RuleState
</a><a href="#h14-0-6" id="h14-0-6" class="i">+
</a><a href="#h14-0-7" id="h14-0-7" class="i">+
</a><a href="#h14-0-8" id="h14-0-8" class="i">+class Rules : ConfigContainer() {
</a><a href="#h14-0-9" id="h14-0-9" class="i">+    private val rules = mutableMapOf&lt;MessagingRuleType, PropertyValue&lt;String&gt;&gt;()
</a><a href="#h14-0-10" id="h14-0-10" class="i">+
</a><a href="#h14-0-11" id="h14-0-11" class="i">+    fun getRuleState(ruleType: MessagingRuleType): RuleState? {
</a><a href="#h14-0-12" id="h14-0-12" class="i">+        return rules[ruleType]?.getNullable()?.let { RuleState.getByName(it) }
</a><a href="#h14-0-13" id="h14-0-13" class="i">+    }
</a><a href="#h14-0-14" id="h14-0-14" class="i">+
</a><a href="#h14-0-15" id="h14-0-15" class="i">+    init {
</a><a href="#h14-0-16" id="h14-0-16" class="i">+        MessagingRuleType.values().filter { it.listMode }.forEach { ruleType -&gt;
</a><a href="#h14-0-17" id="h14-0-17" class="i">+            rules[ruleType] = unique(ruleType.key,&quot;whitelist&quot;, &quot;blacklist&quot;) {
</a><a href="#h14-0-18" id="h14-0-18" class="i">+                customTranslationPath = &quot;rules.properties.${ruleType.key}&quot;
</a><a href="#h14-0-19" id="h14-0-19" class="i">+                customOptionTranslationPath = &quot;rules.modes&quot;
</a><a href="#h14-0-20" id="h14-0-20" class="i">+            }.apply {
</a><a href="#h14-0-21" id="h14-0-21" class="i">+                set(&quot;whitelist&quot;)
</a><a href="#h14-0-22" id="h14-0-22" class="i">+            }
</a><a href="#h14-0-23" id="h14-0-23" class="i">+        }
</a><a href="#h14-0-24" id="h14-0-24" class="i">+    }
</a><a href="#h14-0-25" id="h14-0-25" class="i">+}</a><a href="#h14-0-26" id="h14-0-26" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h15" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/UserInterfaceTweaks.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/UserInterfaceTweaks.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/UserInterfaceTweaks.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/UserInterfaceTweaks.kt</a></b>
<a href="#h15-0" id="h15-0" class="h">@@ -2,15 +2,22 @@ package me.rhunk.snapenhance.core.config.impl
</a> 
 import me.rhunk.snapenhance.core.config.ConfigContainer
 import me.rhunk.snapenhance.core.config.FeatureNotice
<a href="#h15-0-3" id="h15-0-3" class="i">+import me.rhunk.snapenhance.core.messaging.MessagingRuleType
</a> 
 class UserInterfaceTweaks : ConfigContainer() {
     val enableAppAppearance = boolean(&quot;enable_app_appearance&quot;)
<a href="#h15-0-7" id="h15-0-7" class="i">+    val friendFeedMenuButtons = multiple(
</a><a href="#h15-0-8" id="h15-0-8" class="i">+        &quot;friend_feed_menu_buttons&quot;,&quot;conversation_info&quot;, *MessagingRuleType.values().toList().filter { it.listMode }.map { it.key }.toTypedArray()
</a><a href="#h15-0-9" id="h15-0-9" class="i">+    ).apply {
</a><a href="#h15-0-10" id="h15-0-10" class="i">+        set(mutableListOf(&quot;conversation_info&quot;, MessagingRuleType.STEALTH.key))
</a><a href="#h15-0-11" id="h15-0-11" class="i">+    }
</a><a href="#h15-0-12" id="h15-0-12" class="i">+    val friendFeedMenuPosition = integer(&quot;friend_feed_menu_position&quot;, defaultValue = 1)
</a>     val amoledDarkMode = boolean(&quot;amoled_dark_mode&quot;) { addNotices(FeatureNotice.UNSTABLE) }
     val mapFriendNameTags = boolean(&quot;map_friend_nametags&quot;)
     val streakExpirationInfo = boolean(&quot;streak_expiration_info&quot;)
<a href="#h15-0-16" id="h15-0-16" class="d">-    val hideStorySections = multiple(&quot;hide_story_sections&quot;, &quot;hide_friend_suggestions&quot;, &quot;hide_friends&quot;, &quot;hide_following&quot;, &quot;hide_for_you&quot;)
</a><a href="#h15-0-17" id="h15-0-17" class="d">-    val hideUiComponents = multiple(
</a><a href="#h15-0-18" id="h15-0-18" class="d">-        &quot;hide_ui_components&quot;,
</a><a href="#h15-0-19" id="h15-0-19" class="i">+    val hideStorySections = multiple(&quot;hide_story_sections&quot;,
</a><a href="#h15-0-20" id="h15-0-20" class="i">+        &quot;hide_friend_suggestions&quot;, &quot;hide_friends&quot;, &quot;hide_following&quot;, &quot;hide_for_you&quot;)
</a><a href="#h15-0-21" id="h15-0-21" class="i">+    val hideUiComponents = multiple(&quot;hide_ui_components&quot;,
</a>         &quot;hide_voice_record_button&quot;,
         &quot;hide_stickers_button&quot;,
         &quot;hide_cognac_button&quot;,
<a href="#h15-1" id="h15-1" class="h">@@ -27,7 +34,4 @@ class UserInterfaceTweaks : ConfigContainer() {
</a>         &quot;ngs_search_icon_container&quot;
     )
     val storyViewerOverride = unique(&quot;story_viewer_override&quot;, &quot;DISCOVER_PLAYBACK_SEEKBAR&quot;, &quot;VERTICAL_STORY_VIEWER&quot;) { addNotices(FeatureNotice.UNSTABLE) }
<a href="#h15-1-3" id="h15-1-3" class="d">-    val friendFeedMenuButtons = multiple(&quot;friend_feed_menu_buttons&quot;, &quot;auto_download_blacklist&quot;, &quot;anti_auto_save&quot;, &quot;stealth_mode&quot;, &quot;conversation_info&quot;)
</a><a href="#h15-1-4" id="h15-1-4" class="d">-    val friendFeedMenuPosition = integer(&quot;friend_feed_menu_position&quot;, defaultValue = 1)
</a><a href="#h15-1-5" id="h15-1-5" class="d">-    val enableFriendFeedMenuBar = boolean(&quot;enable_friend_feed_menu_bar&quot;)
</a> }
<b>diff --git a/<a id="h16" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/messaging/MessagingCoreObjects.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/messaging/MessagingCoreObjects.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/messaging/MessagingCoreObjects.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/messaging/MessagingCoreObjects.kt</a></b>
<a href="#h16-0" id="h16-0" class="h">@@ -3,9 +3,15 @@ package me.rhunk.snapenhance.core.messaging
</a> import me.rhunk.snapenhance.util.SerializableDataObject
 
 
<a href="#h16-0-3" id="h16-0-3" class="d">-enum class Mode {
</a><a href="#h16-0-4" id="h16-0-4" class="d">-    BLACKLIST,
</a><a href="#h16-0-5" id="h16-0-5" class="d">-    WHITELIST
</a><a href="#h16-0-6" id="h16-0-6" class="i">+enum class RuleState(
</a><a href="#h16-0-7" id="h16-0-7" class="i">+    val key: String
</a><a href="#h16-0-8" id="h16-0-8" class="i">+) {
</a><a href="#h16-0-9" id="h16-0-9" class="i">+    BLACKLIST(&quot;blacklist&quot;),
</a><a href="#h16-0-10" id="h16-0-10" class="i">+    WHITELIST(&quot;whitelist&quot;);
</a><a href="#h16-0-11" id="h16-0-11" class="i">+
</a><a href="#h16-0-12" id="h16-0-12" class="i">+    companion object {
</a><a href="#h16-0-13" id="h16-0-13" class="i">+        fun getByName(name: String) = values().first { it.key == name }
</a><a href="#h16-0-14" id="h16-0-14" class="i">+    }
</a> }
 
 enum class SocialScope(
<a href="#h16-1" id="h16-1" class="h">@@ -18,11 +24,20 @@ enum class SocialScope(
</a> 
 enum class MessagingRuleType(
     val key: String,
<a href="#h16-1-3" id="h16-1-3" class="d">-    val socialScope: SocialScope,
</a><a href="#h16-1-4" id="h16-1-4" class="i">+    val listMode: Boolean
</a> ) {
<a href="#h16-1-6" id="h16-1-6" class="d">-    DOWNLOAD(&quot;download&quot;, SocialScope.FRIEND),
</a><a href="#h16-1-7" id="h16-1-7" class="d">-    STEALTH(&quot;stealth&quot;, SocialScope.GROUP),
</a><a href="#h16-1-8" id="h16-1-8" class="d">-    AUTO_SAVE(&quot;auto_save&quot;, SocialScope.GROUP);
</a><a href="#h16-1-9" id="h16-1-9" class="i">+    AUTO_DOWNLOAD(&quot;auto_download&quot;, true),
</a><a href="#h16-1-10" id="h16-1-10" class="i">+    STEALTH(&quot;stealth&quot;, true),
</a><a href="#h16-1-11" id="h16-1-11" class="i">+    AUTO_SAVE(&quot;auto_save&quot;, true),
</a><a href="#h16-1-12" id="h16-1-12" class="i">+    HIDE_CHAT_FEED(&quot;hide_chat_feed&quot;, false);
</a><a href="#h16-1-13" id="h16-1-13" class="i">+
</a><a href="#h16-1-14" id="h16-1-14" class="i">+    fun translateOptionKey(optionKey: String): String {
</a><a href="#h16-1-15" id="h16-1-15" class="i">+        return &quot;rules.properties.${key}.options.${optionKey}&quot;
</a><a href="#h16-1-16" id="h16-1-16" class="i">+    }
</a><a href="#h16-1-17" id="h16-1-17" class="i">+
</a><a href="#h16-1-18" id="h16-1-18" class="i">+    companion object {
</a><a href="#h16-1-19" id="h16-1-19" class="i">+        fun getByName(name: String) = values().first { it.key == name }
</a><a href="#h16-1-20" id="h16-1-20" class="i">+    }
</a> }
 
 data class FriendStreaks(
<a href="#h16-2" id="h16-2" class="h">@@ -50,8 +65,8 @@ data class MessagingFriendInfo(
</a> 
 data class MessagingRule(
     val id: Int,
<a href="#h16-2-3" id="h16-2-3" class="i">+    val type: MessagingRuleType,
</a>     val socialScope: SocialScope,
     val targetUuid: String,
     //val mode: Mode?,
<a href="#h16-2-7" id="h16-2-7" class="d">-    val subject: String
</a> ) : SerializableDataObject() 
\ No newline at end of file
<b>diff --git a/<a id="h17" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/database/DatabaseAccess.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/database/DatabaseAccess.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/database/DatabaseAccess.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/database/DatabaseAccess.kt</a></b>
<a href="#h17-0" id="h17-0" class="h">@@ -86,6 +86,23 @@ class DatabaseAccess(private val context: ModContext) : Manager {
</a>         }
     }
 
<a href="#h17-0-3" id="h17-0-3" class="i">+    val myUserId by lazy {
</a><a href="#h17-0-4" id="h17-0-4" class="i">+        safeDatabaseOperation(openArroyo()) { arroyoDatabase: SQLiteDatabase -&gt;
</a><a href="#h17-0-5" id="h17-0-5" class="i">+            val cursor = arroyoDatabase.rawQuery(buildString {
</a><a href="#h17-0-6" id="h17-0-6" class="i">+                append(&quot;SELECT * FROM required_values WHERE key = &#39;USERID&#39;&quot;)
</a><a href="#h17-0-7" id="h17-0-7" class="i">+            }, null)
</a><a href="#h17-0-8" id="h17-0-8" class="i">+
</a><a href="#h17-0-9" id="h17-0-9" class="i">+            if (!cursor.moveToFirst()) {
</a><a href="#h17-0-10" id="h17-0-10" class="i">+                cursor.close()
</a><a href="#h17-0-11" id="h17-0-11" class="i">+                return@safeDatabaseOperation null
</a><a href="#h17-0-12" id="h17-0-12" class="i">+            }
</a><a href="#h17-0-13" id="h17-0-13" class="i">+
</a><a href="#h17-0-14" id="h17-0-14" class="i">+            val userId = cursor.getString(cursor.getColumnIndex(&quot;value&quot;))
</a><a href="#h17-0-15" id="h17-0-15" class="i">+            cursor.close()
</a><a href="#h17-0-16" id="h17-0-16" class="i">+            userId
</a><a href="#h17-0-17" id="h17-0-17" class="i">+        }!!
</a><a href="#h17-0-18" id="h17-0-18" class="i">+    }
</a><a href="#h17-0-19" id="h17-0-19" class="i">+
</a>     fun getFeedEntryByConversationId(conversationId: String): FriendFeedEntry? {
         return safeDatabaseOperation(openMain()) {
             readDatabaseObject(
<a href="#h17-1" id="h17-1" class="h">@@ -157,7 +174,7 @@ class DatabaseAccess(private val context: ModContext) : Manager {
</a>         }
     }
 
<a href="#h17-1-3" id="h17-1-3" class="d">-    fun getDMConversationIdFromUserId(userId: String): UserConversationLink? {
</a><a href="#h17-1-4" id="h17-1-4" class="i">+    fun getConversationLinkFromUserId(userId: String): UserConversationLink? {
</a>         return safeDatabaseOperation(openArroyo()) {
             readDatabaseObject(
                 UserConversationLink(),
<a href="#h17-2" id="h17-2" class="h">@@ -169,6 +186,22 @@ class DatabaseAccess(private val context: ModContext) : Manager {
</a>         }
     }
 
<a href="#h17-2-3" id="h17-2-3" class="i">+    fun getDMOtherParticipant(conversationId: String): String? {
</a><a href="#h17-2-4" id="h17-2-4" class="i">+        return safeDatabaseOperation(openArroyo()) { cursor -&gt;
</a><a href="#h17-2-5" id="h17-2-5" class="i">+            val query = cursor.rawQuery(
</a><a href="#h17-2-6" id="h17-2-6" class="i">+                &quot;SELECT * FROM user_conversation WHERE client_conversation_id = ? AND conversation_type = 0&quot;,
</a><a href="#h17-2-7" id="h17-2-7" class="i">+                arrayOf(conversationId)
</a><a href="#h17-2-8" id="h17-2-8" class="i">+            )
</a><a href="#h17-2-9" id="h17-2-9" class="i">+            val participants = mutableListOf&lt;String&gt;()
</a><a href="#h17-2-10" id="h17-2-10" class="i">+            while (query.moveToNext()) {
</a><a href="#h17-2-11" id="h17-2-11" class="i">+                participants.add(query.getString(query.getColumnIndex(&quot;user_id&quot;)))
</a><a href="#h17-2-12" id="h17-2-12" class="i">+            }
</a><a href="#h17-2-13" id="h17-2-13" class="i">+            query.close()
</a><a href="#h17-2-14" id="h17-2-14" class="i">+            participants.firstOrNull { it != myUserId }
</a><a href="#h17-2-15" id="h17-2-15" class="i">+        }
</a><a href="#h17-2-16" id="h17-2-16" class="i">+    }
</a><a href="#h17-2-17" id="h17-2-17" class="i">+
</a><a href="#h17-2-18" id="h17-2-18" class="i">+
</a>     fun getStoryEntryFromId(storyId: String): StoryEntry? {
         return safeDatabaseOperation(openMain()) {
             readDatabaseObject(StoryEntry(), it, &quot;Story&quot;, &quot;storyId = ?&quot;, arrayOf(storyId))
<a href="#h17-3" id="h17-3" class="h">@@ -194,23 +227,6 @@ class DatabaseAccess(private val context: ModContext) : Manager {
</a>         }
     }
 
<a href="#h17-3-3" id="h17-3-3" class="d">-    fun getMyUserId(): String? {
</a><a href="#h17-3-4" id="h17-3-4" class="d">-        return safeDatabaseOperation(openArroyo()) { arroyoDatabase: SQLiteDatabase -&gt;
</a><a href="#h17-3-5" id="h17-3-5" class="d">-            val cursor = arroyoDatabase.rawQuery(buildString {
</a><a href="#h17-3-6" id="h17-3-6" class="d">-                append(&quot;SELECT * FROM required_values WHERE key = &#39;USERID&#39;&quot;)
</a><a href="#h17-3-7" id="h17-3-7" class="d">-            }, null)
</a><a href="#h17-3-8" id="h17-3-8" class="d">-
</a><a href="#h17-3-9" id="h17-3-9" class="d">-            if (!cursor.moveToFirst()) {
</a><a href="#h17-3-10" id="h17-3-10" class="d">-                cursor.close()
</a><a href="#h17-3-11" id="h17-3-11" class="d">-                return@safeDatabaseOperation null
</a><a href="#h17-3-12" id="h17-3-12" class="d">-            }
</a><a href="#h17-3-13" id="h17-3-13" class="d">-
</a><a href="#h17-3-14" id="h17-3-14" class="d">-            val userId = cursor.getString(cursor.getColumnIndex(&quot;value&quot;))
</a><a href="#h17-3-15" id="h17-3-15" class="d">-            cursor.close()
</a><a href="#h17-3-16" id="h17-3-16" class="d">-            userId
</a><a href="#h17-3-17" id="h17-3-17" class="d">-        }
</a><a href="#h17-3-18" id="h17-3-18" class="d">-    }
</a><a href="#h17-3-19" id="h17-3-19" class="d">-
</a>     fun getMessagesFromConversationId(
         conversationId: String,
         limit: Int
<b>diff --git a/<a id="h18" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/MessagingRuleFeature.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/MessagingRuleFeature.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/MessagingRuleFeature.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/MessagingRuleFeature.kt</a></b>
<a href="#h18-0" id="h18-0" class="h">@@ -0,0 +1,33 @@
</a><a href="#h18-0-0" id="h18-0-0" class="i">+package me.rhunk.snapenhance.features
</a><a href="#h18-0-1" id="h18-0-1" class="i">+
</a><a href="#h18-0-2" id="h18-0-2" class="i">+import me.rhunk.snapenhance.core.messaging.MessagingRuleType
</a><a href="#h18-0-3" id="h18-0-3" class="i">+import me.rhunk.snapenhance.core.messaging.RuleState
</a><a href="#h18-0-4" id="h18-0-4" class="i">+
</a><a href="#h18-0-5" id="h18-0-5" class="i">+abstract class MessagingRuleFeature(name: String, val ruleType: MessagingRuleType, loadParams: Int = 0) : Feature(name, loadParams) {
</a><a href="#h18-0-6" id="h18-0-6" class="i">+    init {
</a><a href="#h18-0-7" id="h18-0-7" class="i">+        if (!ruleType.listMode) throw IllegalArgumentException(&quot;Rule type must be a list mode&quot;)
</a><a href="#h18-0-8" id="h18-0-8" class="i">+    }
</a><a href="#h18-0-9" id="h18-0-9" class="i">+
</a><a href="#h18-0-10" id="h18-0-10" class="i">+    fun getRuleState() = context.config.rules.getRuleState(ruleType)
</a><a href="#h18-0-11" id="h18-0-11" class="i">+
</a><a href="#h18-0-12" id="h18-0-12" class="i">+    fun setState(conversationId: String, state: Boolean) {
</a><a href="#h18-0-13" id="h18-0-13" class="i">+        context.bridgeClient.setRule(
</a><a href="#h18-0-14" id="h18-0-14" class="i">+            context.database.getDMOtherParticipant(conversationId) ?: conversationId,
</a><a href="#h18-0-15" id="h18-0-15" class="i">+            ruleType,
</a><a href="#h18-0-16" id="h18-0-16" class="i">+            state
</a><a href="#h18-0-17" id="h18-0-17" class="i">+        )
</a><a href="#h18-0-18" id="h18-0-18" class="i">+    }
</a><a href="#h18-0-19" id="h18-0-19" class="i">+
</a><a href="#h18-0-20" id="h18-0-20" class="i">+    fun getState(conversationId: String) =
</a><a href="#h18-0-21" id="h18-0-21" class="i">+        context.bridgeClient.getRules(
</a><a href="#h18-0-22" id="h18-0-22" class="i">+            context.database.getDMOtherParticipant(conversationId) ?: conversationId
</a><a href="#h18-0-23" id="h18-0-23" class="i">+        ).contains(ruleType) &amp;&amp; getRuleState() != null
</a><a href="#h18-0-24" id="h18-0-24" class="i">+
</a><a href="#h18-0-25" id="h18-0-25" class="i">+    fun canUseRule(conversationId: String): Boolean {
</a><a href="#h18-0-26" id="h18-0-26" class="i">+        val state = getState(conversationId)
</a><a href="#h18-0-27" id="h18-0-27" class="i">+        if (context.config.rules.getRuleState(ruleType) == RuleState.BLACKLIST) {
</a><a href="#h18-0-28" id="h18-0-28" class="i">+            return !state
</a><a href="#h18-0-29" id="h18-0-29" class="i">+        }
</a><a href="#h18-0-30" id="h18-0-30" class="i">+        return state
</a><a href="#h18-0-31" id="h18-0-31" class="i">+    }
</a><a href="#h18-0-32" id="h18-0-32" class="i">+}</a><a href="#h18-0-33" id="h18-0-33" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h19" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/Messaging.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/Messaging.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/Messaging.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/Messaging.kt</a></b>
<a href="#h19-0" id="h19-0" class="h">@@ -68,7 +68,7 @@ class Messaging : Feature(&quot;Messaging&quot;, loadParams = FeatureLoadParams.ACTIVITY_C
</a> 
         arrayOf(&quot;activate&quot;, &quot;deactivate&quot;, &quot;processTypingActivity&quot;).forEach { hook -&gt;
             Hooker.hook(context.classCache.presenceSession, hook, HookStage.BEFORE, {
<a href="#h19-0-3" id="h19-0-3" class="d">-                hideBitmojiPresence || stealthMode.isStealth(openedConversationUUID.toString())
</a><a href="#h19-0-4" id="h19-0-4" class="i">+                hideBitmojiPresence || stealthMode.canUseRule(openedConversationUUID.toString())
</a>             }) {
                 it.setResult(null)
             }
<a href="#h19-1" id="h19-1" class="h">@@ -86,7 +86,7 @@ class Messaging : Feature(&quot;Messaging&quot;, loadParams = FeatureLoadParams.ACTIVITY_C
</a>         }
 
         Hooker.hook(context.classCache.conversationManager, &quot;sendTypingNotification&quot;, HookStage.BEFORE, {
<a href="#h19-1-3" id="h19-1-3" class="d">-            hideTypingNotification || stealthMode.isStealth(openedConversationUUID.toString())
</a><a href="#h19-1-4" id="h19-1-4" class="i">+            hideTypingNotification || stealthMode.canUseRule(openedConversationUUID.toString())
</a>         }) {
             it.setResult(null)
         }
<b>diff --git a/<a id="h20" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/AntiAutoDownload.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/AntiAutoDownload.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/AntiAutoDownload.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/AntiAutoDownload.kt</a></b>
<a href="#h20-0" id="h20-0" class="h">@@ -1,19 +0,0 @@
</a><a href="#h20-0-0" id="h20-0-0" class="d">-package me.rhunk.snapenhance.features.impl.downloader
</a><a href="#h20-0-1" id="h20-0-1" class="d">-
</a><a href="#h20-0-2" id="h20-0-2" class="d">-import me.rhunk.snapenhance.bridge.types.BridgeFileType
</a><a href="#h20-0-3" id="h20-0-3" class="d">-import me.rhunk.snapenhance.features.BridgeFileFeature
</a><a href="#h20-0-4" id="h20-0-4" class="d">-import me.rhunk.snapenhance.features.FeatureLoadParams
</a><a href="#h20-0-5" id="h20-0-5" class="d">-
</a><a href="#h20-0-6" id="h20-0-6" class="d">-class AntiAutoDownload : BridgeFileFeature(&quot;AntiAutoDownload&quot;, BridgeFileType.ANTI_AUTO_DOWNLOAD, loadParams = FeatureLoadParams.ACTIVITY_CREATE_SYNC) {
</a><a href="#h20-0-7" id="h20-0-7" class="d">-    override fun onActivityCreate() {
</a><a href="#h20-0-8" id="h20-0-8" class="d">-        readFile()
</a><a href="#h20-0-9" id="h20-0-9" class="d">-    }
</a><a href="#h20-0-10" id="h20-0-10" class="d">-
</a><a href="#h20-0-11" id="h20-0-11" class="d">-    fun setUserIgnored(userId: String, state: Boolean) {
</a><a href="#h20-0-12" id="h20-0-12" class="d">-        setState(userId.hashCode().toLong().toString(16), state)
</a><a href="#h20-0-13" id="h20-0-13" class="d">-    }
</a><a href="#h20-0-14" id="h20-0-14" class="d">-
</a><a href="#h20-0-15" id="h20-0-15" class="d">-    fun isUserIgnored(userId: String): Boolean {
</a><a href="#h20-0-16" id="h20-0-16" class="d">-        return exists(userId.hashCode().toLong().toString(16))
</a><a href="#h20-0-17" id="h20-0-17" class="d">-    }
</a><a href="#h20-0-18" id="h20-0-18" class="d">-}</a><a href="#h20-0-19" id="h20-0-19" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h21" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/MediaDownloader.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/MediaDownloader.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/MediaDownloader.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/MediaDownloader.kt</a></b>
<a href="#h21-0" id="h21-0" class="h">@@ -9,6 +9,7 @@ import kotlinx.coroutines.runBlocking
</a> import me.rhunk.snapenhance.Logger
 import me.rhunk.snapenhance.Logger.xposedLog
 import me.rhunk.snapenhance.bridge.DownloadCallback
<a href="#h21-0-3" id="h21-0-3" class="i">+import me.rhunk.snapenhance.core.messaging.MessagingRuleType
</a> import me.rhunk.snapenhance.data.ContentType
 import me.rhunk.snapenhance.data.FileType
 import me.rhunk.snapenhance.data.wrapper.impl.media.MediaInfo
<a href="#h21-1" id="h21-1" class="h">@@ -24,8 +25,8 @@ import me.rhunk.snapenhance.download.data.InputMedia
</a> import me.rhunk.snapenhance.download.data.MediaFilter
 import me.rhunk.snapenhance.download.data.SplitMediaAssetType
 import me.rhunk.snapenhance.download.data.toKeyPair
<a href="#h21-1-3" id="h21-1-3" class="d">-import me.rhunk.snapenhance.features.Feature
</a> import me.rhunk.snapenhance.features.FeatureLoadParams
<a href="#h21-1-5" id="h21-1-5" class="i">+import me.rhunk.snapenhance.features.MessagingRuleFeature
</a> import me.rhunk.snapenhance.features.impl.Messaging
 import me.rhunk.snapenhance.features.impl.spying.MessageLogger
 import me.rhunk.snapenhance.hook.HookAdapter
<a href="#h21-2" id="h21-2" class="h">@@ -47,7 +48,7 @@ import kotlin.io.encoding.Base64
</a> import kotlin.io.encoding.ExperimentalEncodingApi
 
 @OptIn(ExperimentalEncodingApi::class)
<a href="#h21-2-3" id="h21-2-3" class="d">-class MediaDownloader : Feature(&quot;MediaDownloader&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_ASYNC) {
</a><a href="#h21-2-4" id="h21-2-4" class="i">+class MediaDownloader : MessagingRuleFeature(&quot;MediaDownloader&quot;, MessagingRuleType.AUTO_DOWNLOAD, loadParams = FeatureLoadParams.ACTIVITY_CREATE_ASYNC) {
</a>     private var lastSeenMediaInfoMap: MutableMap&lt;SplitMediaAssetType, MediaInfo&gt;? = null
     private var lastSeenMapParams: ParamMap? = null
 
<a href="#h21-3" id="h21-3" class="h">@@ -230,7 +231,7 @@ class MediaDownloader : Feature(&quot;MediaDownloader&quot;, loadParams = FeatureLoadParam
</a>             val senderId = conversationMessage.senderId!!
             val conversationId = conversationMessage.clientConversationId!!
 
<a href="#h21-3-3" id="h21-3-3" class="d">-            if (!forceDownload &amp;&amp; context.feature(AntiAutoDownload::class).isUserIgnored(senderId)) {
</a><a href="#h21-3-4" id="h21-3-4" class="i">+            if (!forceDownload &amp;&amp; canUseRule(senderId)) {
</a>                 return
             }
 
<a href="#h21-4" id="h21-4" class="h">@@ -272,7 +273,7 @@ class MediaDownloader : Feature(&quot;MediaDownloader&quot;, loadParams = FeatureLoadParam
</a> 
             val author = context.database.getFriendInfo(
                 if (storyUserId == null || storyUserId == &quot;null&quot;)
<a href="#h21-4-3" id="h21-4-3" class="d">-                    context.database.getMyUserId()!!
</a><a href="#h21-4-4" id="h21-4-4" class="i">+                    context.database.myUserId
</a>                 else storyUserId
             ) ?: throw Exception(&quot;Friend not found in database&quot;)
             val authorName = author.usernameForSorting!!
<b>diff --git a/<a id="h22" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/spying/MessageLogger.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/spying/MessageLogger.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/spying/MessageLogger.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/spying/MessageLogger.kt</a></b>
<a href="#h22-0" id="h22-0" class="h">@@ -37,8 +37,6 @@ class MessageLogger : Feature(&quot;MessageLogger&quot;,
</a>     private val fetchedMessages = mutableListOf&lt;Long&gt;()
     private val deletedMessageCache = mutableMapOf&lt;Long, JsonObject&gt;()
 
<a href="#h22-0-3" id="h22-0-3" class="d">-    private val myUserId by lazy { context.database.getMyUserId() }
</a><a href="#h22-0-4" id="h22-0-4" class="d">-
</a>     fun isMessageRemoved(conversationId: String, orderKey: Long) = deletedMessageCache.containsKey(computeMessageIdentifier(conversationId, orderKey))
 
     fun deleteMessage(conversationId: String, clientMessageId: Long) {
<a href="#h22-1" id="h22-1" class="h">@@ -83,7 +81,7 @@ class MessageLogger : Feature(&quot;MessageLogger&quot;,
</a>         if (message.messageState != MessageState.COMMITTED) return
 
         //exclude messages sent by me
<a href="#h22-1-3" id="h22-1-3" class="d">-        if (message.senderId.toString() == myUserId) return
</a><a href="#h22-1-4" id="h22-1-4" class="i">+        if (message.senderId.toString() == context.database.myUserId) return
</a> 
         val conversationId = message.messageDescriptor.conversationId.toString()
         val serverIdentifier = computeMessageIdentifier(conversationId, message.orderKey)
<b>diff --git a/<a id="h23" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/spying/PreventReadReceipts.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/spying/PreventReadReceipts.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/spying/PreventReadReceipts.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/spying/PreventReadReceipts.kt</a></b>
<a href="#h23-0" id="h23-0" class="h">@@ -12,7 +12,7 @@ class PreventReadReceipts : Feature(&quot;PreventReadReceipts&quot;, loadParams = FeatureL
</a>         val preventReadReceipts by context.config.messaging.preventReadReceipts
         val isConversationInStealthMode: (SnapUUID) -&gt; Boolean = hook@{
             if (preventReadReceipts) return@hook true
<a href="#h23-0-3" id="h23-0-3" class="d">-            context.feature(StealthMode::class).isStealth(it.toString())
</a><a href="#h23-0-4" id="h23-0-4" class="i">+            context.feature(StealthMode::class).canUseRule(it.toString())
</a>         }
 
         arrayOf(&quot;mediaMessagesDisplayed&quot;, &quot;displayedMessages&quot;).forEach { methodName: String -&gt;
<b>diff --git a/<a id="h24" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/spying/StealthMode.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/spying/StealthMode.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/spying/StealthMode.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/spying/StealthMode.kt</a></b>
<a href="#h24-0" id="h24-0" class="h">@@ -1,19 +1,6 @@
</a> package me.rhunk.snapenhance.features.impl.spying
 
<a href="#h24-0-2" id="h24-0-2" class="d">-import me.rhunk.snapenhance.bridge.types.BridgeFileType
</a><a href="#h24-0-3" id="h24-0-3" class="d">-import me.rhunk.snapenhance.features.BridgeFileFeature
</a><a href="#h24-0-4" id="h24-0-4" class="d">-import me.rhunk.snapenhance.features.FeatureLoadParams
</a><a href="#h24-0-5" id="h24-0-5" class="i">+import me.rhunk.snapenhance.core.messaging.MessagingRuleType
</a><a href="#h24-0-6" id="h24-0-6" class="i">+import me.rhunk.snapenhance.features.MessagingRuleFeature
</a> 
<a href="#h24-0-8" id="h24-0-8" class="d">-class StealthMode : BridgeFileFeature(&quot;StealthMode&quot;, BridgeFileType.STEALTH, loadParams = FeatureLoadParams.ACTIVITY_CREATE_SYNC) {
</a><a href="#h24-0-9" id="h24-0-9" class="d">-    override fun onActivityCreate() {
</a><a href="#h24-0-10" id="h24-0-10" class="d">-        readFile()
</a><a href="#h24-0-11" id="h24-0-11" class="d">-    }
</a><a href="#h24-0-12" id="h24-0-12" class="d">-
</a><a href="#h24-0-13" id="h24-0-13" class="d">-    fun setStealth(conversationId: String, stealth: Boolean) {
</a><a href="#h24-0-14" id="h24-0-14" class="d">-        setState(conversationId.hashCode().toLong().toString(16), stealth)
</a><a href="#h24-0-15" id="h24-0-15" class="d">-    }
</a><a href="#h24-0-16" id="h24-0-16" class="d">-
</a><a href="#h24-0-17" id="h24-0-17" class="d">-    fun isStealth(conversationId: String): Boolean {
</a><a href="#h24-0-18" id="h24-0-18" class="d">-        return exists(conversationId.hashCode().toLong().toString(16))
</a><a href="#h24-0-19" id="h24-0-19" class="d">-    }
</a><a href="#h24-0-20" id="h24-0-20" class="d">-}
</a><a href="#h24-0-21" id="h24-0-21" class="i">+class StealthMode : MessagingRuleFeature(&quot;StealthMode&quot;, MessagingRuleType.STEALTH)</a><a href="#h24-0-22" id="h24-0-22" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h25" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/AutoSave.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/AutoSave.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/AutoSave.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/AutoSave.kt</a></b>
<a href="#h25-0" id="h25-0" class="h">@@ -1,11 +1,12 @@
</a> package me.rhunk.snapenhance.features.impl.tweaks
 
 import me.rhunk.snapenhance.Logger
<a href="#h25-0-3" id="h25-0-3" class="i">+import me.rhunk.snapenhance.core.messaging.MessagingRuleType
</a> import me.rhunk.snapenhance.data.MessageState
 import me.rhunk.snapenhance.data.wrapper.impl.Message
 import me.rhunk.snapenhance.data.wrapper.impl.SnapUUID
<a href="#h25-0-7" id="h25-0-7" class="d">-import me.rhunk.snapenhance.features.Feature
</a> import me.rhunk.snapenhance.features.FeatureLoadParams
<a href="#h25-0-9" id="h25-0-9" class="i">+import me.rhunk.snapenhance.features.MessagingRuleFeature
</a> import me.rhunk.snapenhance.features.impl.Messaging
 import me.rhunk.snapenhance.features.impl.spying.MessageLogger
 import me.rhunk.snapenhance.features.impl.spying.StealthMode
<a href="#h25-1" id="h25-1" class="h">@@ -15,14 +16,12 @@ import me.rhunk.snapenhance.util.CallbackBuilder
</a> import me.rhunk.snapenhance.util.ktx.getObjectField
 import java.util.concurrent.Executors
 
<a href="#h25-1-3" id="h25-1-3" class="d">-class AutoSave : Feature(&quot;Auto Save&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_ASYNC) {
</a><a href="#h25-1-4" id="h25-1-4" class="i">+class AutoSave : MessagingRuleFeature(&quot;Auto Save&quot;, MessagingRuleType.AUTO_SAVE, loadParams = FeatureLoadParams.ACTIVITY_CREATE_ASYNC) {
</a>     private val asyncSaveExecutorService = Executors.newSingleThreadExecutor()
 
     private val messageLogger by lazy { context.feature(MessageLogger::class) }
     private val messaging by lazy { context.feature(Messaging::class) }
 
<a href="#h25-1-10" id="h25-1-10" class="d">-    private val myUserId by lazy { context.database.getMyUserId() }
</a><a href="#h25-1-11" id="h25-1-11" class="d">-
</a>     private val fetchConversationWithMessagesCallbackClass by lazy {  context.mappings.getMappedClass(&quot;callbacks&quot;, &quot;FetchConversationWithMessagesCallback&quot;) }
     private val callbackClass by lazy {  context.mappings.getMappedClass(&quot;callbacks&quot;, &quot;Callback&quot;) }
 
<a href="#h25-2" id="h25-2" class="h">@@ -62,7 +61,7 @@ class AutoSave : Feature(&quot;Auto Save&quot;, loadParams = FeatureLoadParams.ACTIVITY_CR
</a>     }
 
     private fun canSaveMessage(message: Message): Boolean {
<a href="#h25-2-3" id="h25-2-3" class="d">-        if (message.messageMetadata.savedBy.any { uuid -&gt; uuid.toString() == myUserId }) return false
</a><a href="#h25-2-4" id="h25-2-4" class="i">+        if (message.messageMetadata.savedBy.any { uuid -&gt; uuid.toString() == context.database.myUserId }) return false
</a>         val contentType = message.messageContent.contentType.toString()
 
         return autoSaveFilter.any { it == contentType }
<a href="#h25-3" id="h25-3" class="h">@@ -74,8 +73,8 @@ class AutoSave : Feature(&quot;Auto Save&quot;, loadParams = FeatureLoadParams.ACTIVITY_CR
</a>         with(context.feature(Messaging::class)) {
             if (openedConversationUUID == null) return@canSave false
             val conversation = openedConversationUUID.toString()
<a href="#h25-3-3" id="h25-3-3" class="d">-            if (context.feature(StealthMode::class).isStealth(conversation)) return@canSave false
</a><a href="#h25-3-4" id="h25-3-4" class="d">-            if (context.feature(AntiAutoSave::class).isConversationIgnored(conversation)) return@canSave false
</a><a href="#h25-3-5" id="h25-3-5" class="i">+            if (context.feature(StealthMode::class).canUseRule(conversation)) return@canSave false
</a><a href="#h25-3-6" id="h25-3-6" class="i">+            if (canUseRule(conversation)) return@canSave false
</a>         }
         return true
     }
<b>diff --git a/<a id="h26" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/Notifications.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/Notifications.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/Notifications.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/Notifications.kt</a></b>
<a href="#h26-0" id="h26-0" class="h">@@ -154,7 +154,7 @@ class Notifications : Feature(&quot;Notifications&quot;, loadParams = FeatureLoadParams.IN
</a>                     val input = RemoteInput.getResultsFromIntent(intent).getCharSequence(&quot;chat_reply_input&quot;)
                         .toString()
 
<a href="#h26-0-3" id="h26-0-3" class="d">-                    context.database.getMyUserId()?.let { context.database.getFriendInfo(it) }?.let { myUser -&gt;
</a><a href="#h26-0-4" id="h26-0-4" class="i">+                    context.database.myUserId.let { context.database.getFriendInfo(it) }?.let { myUser -&gt;
</a>                         cachedMessages.computeIfAbsent(conversationId) { mutableListOf() }.add(&quot;${myUser.displayName}: $input&quot;)
 
                         updateNotification(notificationId) { notification -&gt;
<b>diff --git a/<a id="h27" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/manager/impl/FeatureManager.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/manager/impl/FeatureManager.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/manager/impl/FeatureManager.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/manager/impl/FeatureManager.kt</a></b>
<a href="#h27-0" id="h27-0" class="h">@@ -7,7 +7,6 @@ import me.rhunk.snapenhance.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.features.impl.AutoUpdater
 import me.rhunk.snapenhance.features.impl.ConfigurationOverride
 import me.rhunk.snapenhance.features.impl.Messaging
<a href="#h27-0-3" id="h27-0-3" class="d">-import me.rhunk.snapenhance.features.impl.downloader.AntiAutoDownload
</a> import me.rhunk.snapenhance.features.impl.downloader.MediaDownloader
 import me.rhunk.snapenhance.features.impl.experiments.AmoledDarkMode
 import me.rhunk.snapenhance.features.impl.experiments.AppPasscode
<a href="#h27-1" id="h27-1" class="h">@@ -76,7 +75,6 @@ class FeatureManager(private val context: ModContext) : Manager {
</a>         register(AutoSave::class)
         register(UITweaks::class)
         register(ConfigurationOverride::class)
<a href="#h27-1-3" id="h27-1-3" class="d">-        register(AntiAutoDownload::class)
</a>         register(GalleryMediaSendOverride::class)
         register(AntiAutoSave::class)
         register(UnlimitedSnapViewTime::class)
<b>diff --git a/<a id="h28" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/FriendFeedInfoMenu.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/FriendFeedInfoMenu.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/FriendFeedInfoMenu.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/FriendFeedInfoMenu.kt</a></b>
<a href="#h28-0" id="h28-0" class="h">@@ -4,32 +4,23 @@ import android.annotation.SuppressLint
</a> import android.content.Context
 import android.content.DialogInterface
 import android.content.res.Resources
<a href="#h28-0-3" id="h28-0-3" class="d">-import android.graphics.Bitmap
</a> import android.graphics.BitmapFactory
<a href="#h28-0-5" id="h28-0-5" class="d">-import android.graphics.Canvas
</a><a href="#h28-0-6" id="h28-0-6" class="d">-import android.graphics.Color
</a><a href="#h28-0-7" id="h28-0-7" class="d">-import android.graphics.Paint
</a> import android.graphics.drawable.BitmapDrawable
 import android.graphics.drawable.Drawable
<a href="#h28-0-10" id="h28-0-10" class="d">-import android.view.Gravity
</a><a href="#h28-0-11" id="h28-0-11" class="d">-import android.view.MotionEvent
</a> import android.view.View
<a href="#h28-0-13" id="h28-0-13" class="d">-import android.view.ViewGroup
</a> import android.widget.Button
 import android.widget.CompoundButton
<a href="#h28-0-16" id="h28-0-16" class="d">-import android.widget.LinearLayout
</a> import android.widget.Switch
<a href="#h28-0-18" id="h28-0-18" class="d">-import android.widget.Toast
</a> import me.rhunk.snapenhance.Logger
 import me.rhunk.snapenhance.data.ContentType
<a href="#h28-0-21" id="h28-0-21" class="d">-import me.rhunk.snapenhance.data.wrapper.impl.FriendActionButton
</a> import me.rhunk.snapenhance.database.objects.ConversationMessage
 import me.rhunk.snapenhance.database.objects.FriendInfo
 import me.rhunk.snapenhance.database.objects.UserConversationLink
<a href="#h28-0-25" id="h28-0-25" class="i">+import me.rhunk.snapenhance.features.MessagingRuleFeature
</a> import me.rhunk.snapenhance.features.impl.Messaging
<a href="#h28-0-27" id="h28-0-27" class="d">-import me.rhunk.snapenhance.features.impl.downloader.AntiAutoDownload
</a><a href="#h28-0-28" id="h28-0-28" class="i">+import me.rhunk.snapenhance.features.impl.downloader.MediaDownloader
</a> import me.rhunk.snapenhance.features.impl.spying.StealthMode
<a href="#h28-0-30" id="h28-0-30" class="d">-import me.rhunk.snapenhance.features.impl.tweaks.AntiAutoSave
</a><a href="#h28-0-31" id="h28-0-31" class="i">+import me.rhunk.snapenhance.features.impl.tweaks.AutoSave
</a> import me.rhunk.snapenhance.ui.ViewAppearanceHelper
 import me.rhunk.snapenhance.ui.menu.AbstractMenu
 import me.rhunk.snapenhance.util.snap.BitmojiSelfie
<a href="#h28-1" id="h28-1" class="h">@@ -106,17 +97,18 @@ class FriendFeedInfoMenu : AbstractMenu() {
</a>             context.config.messaging.messagePreviewLength.get()
         )?.reversed()
 
<a href="#h28-1-3" id="h28-1-3" class="d">-        if (messages.isNullOrEmpty()) {
</a><a href="#h28-1-4" id="h28-1-4" class="d">-            Toast.makeText(androidCtx, &quot;No messages found&quot;, Toast.LENGTH_SHORT).show()
</a><a href="#h28-1-5" id="h28-1-5" class="i">+        if (messages == null) {
</a><a href="#h28-1-6" id="h28-1-6" class="i">+            context.longToast(&quot;Can&#39;t fetch messages&quot;)
</a>             return
         }
<a href="#h28-1-9" id="h28-1-9" class="i">+
</a>         val participants: Map&lt;String, FriendInfo&gt; = context.database.getConversationParticipants(conversationId)!!
             .map { context.database.getFriendInfo(it)!! }
             .associateBy { it.userId!! }
         
         val messageBuilder = StringBuilder()
 
<a href="#h28-1-16" id="h28-1-16" class="d">-        messages.forEach{ message: ConversationMessage -&gt;
</a><a href="#h28-1-17" id="h28-1-17" class="i">+        messages.forEach { message -&gt;
</a>             val sender: FriendInfo? = participants[message.senderId]
 
             var messageString: String = message.getMessageAsString() ?: ContentType.fromId(message.contentType).name
<a href="#h28-2" id="h28-2" class="h">@@ -164,7 +156,6 @@ class FriendFeedInfoMenu : AbstractMenu() {
</a>                 .append(&quot;\n&quot;)
         }
 
<a href="#h28-2-3" id="h28-2-3" class="d">-
</a>         //alert dialog
         val builder = ViewAppearanceHelper.newAlertDialogBuilder(context.mainActivity)
         builder.setTitle(context.translation[&quot;conversation_preview.title&quot;])
<a href="#h28-3" id="h28-3" class="h">@@ -182,22 +173,6 @@ class FriendFeedInfoMenu : AbstractMenu() {
</a>         builder.show()
     }
 
<a href="#h28-3-3" id="h28-3-3" class="d">-    private fun createEmojiDrawable(text: String, width: Int, height: Int, textSize: Float, disabled: Boolean = false): Drawable {
</a><a href="#h28-3-4" id="h28-3-4" class="d">-        val bitmap = Bitmap.createBitmap(width, height, Bitmap.Config.ARGB_8888)
</a><a href="#h28-3-5" id="h28-3-5" class="d">-        val canvas = Canvas(bitmap)
</a><a href="#h28-3-6" id="h28-3-6" class="d">-        val paint = Paint()
</a><a href="#h28-3-7" id="h28-3-7" class="d">-        paint.textSize = textSize
</a><a href="#h28-3-8" id="h28-3-8" class="d">-        paint.color = Color.BLACK
</a><a href="#h28-3-9" id="h28-3-9" class="d">-        paint.textAlign = Paint.Align.CENTER
</a><a href="#h28-3-10" id="h28-3-10" class="d">-        canvas.drawText(text, width / 2f, height.toFloat() - paint.descent(), paint)
</a><a href="#h28-3-11" id="h28-3-11" class="d">-        if (disabled) {
</a><a href="#h28-3-12" id="h28-3-12" class="d">-            paint.color = Color.RED
</a><a href="#h28-3-13" id="h28-3-13" class="d">-            paint.strokeWidth = 5f
</a><a href="#h28-3-14" id="h28-3-14" class="d">-            canvas.drawLine(0f, 0f, width.toFloat(), height.toFloat(), paint)
</a><a href="#h28-3-15" id="h28-3-15" class="d">-        }
</a><a href="#h28-3-16" id="h28-3-16" class="d">-        return BitmapDrawable(context.resources, bitmap)
</a><a href="#h28-3-17" id="h28-3-17" class="d">-    }
</a><a href="#h28-3-18" id="h28-3-18" class="d">-
</a>     private fun getCurrentConversationInfo(): Pair&lt;String, String?&gt; {
         val messaging = context.feature(Messaging::class)
         val focusedConversationTargetUser: String? = messaging.lastFetchConversationUserUUID?.toString()
<a href="#h28-4" id="h28-4" class="h">@@ -213,7 +188,7 @@ class FriendFeedInfoMenu : AbstractMenu() {
</a> 
         //old conversation fetch
         val conversationId = if (messaging.lastFetchConversationUUID == null &amp;&amp; focusedConversationTargetUser != null) {
<a href="#h28-4-3" id="h28-4-3" class="d">-            val conversation: UserConversationLink = context.database.getDMConversationIdFromUserId(focusedConversationTargetUser) ?: throw IllegalStateException(&quot;No conversation found&quot;)
</a><a href="#h28-4-4" id="h28-4-4" class="i">+            val conversation: UserConversationLink = context.database.getConversationLinkFromUserId(focusedConversationTargetUser) ?: throw IllegalStateException(&quot;No conversation found&quot;)
</a>             conversation.clientConversationId!!.trim().lowercase()
         } else {
             messaging.lastFetchConversationUUID.toString()
<a href="#h28-5" id="h28-5" class="h">@@ -244,148 +219,38 @@ class FriendFeedInfoMenu : AbstractMenu() {
</a> 
         val (conversationId, targetUser) = getCurrentConversationInfo()
 
<a href="#h28-5-3" id="h28-5-3" class="d">-        if (!context.config.userInterface.enableFriendFeedMenuBar.get()) {
</a><a href="#h28-5-4" id="h28-5-4" class="d">-            //preview button
</a><a href="#h28-5-5" id="h28-5-5" class="d">-            val previewButton = Button(viewModel.context).apply {
</a><a href="#h28-5-6" id="h28-5-6" class="d">-                text = modContext.translation[&quot;friend_menu_option.preview&quot;]
</a><a href="#h28-5-7" id="h28-5-7" class="d">-                ViewAppearanceHelper.applyTheme(this, viewModel.width)
</a><a href="#h28-5-8" id="h28-5-8" class="d">-                setOnClickListener {
</a><a href="#h28-5-9" id="h28-5-9" class="d">-                    showPreview(
</a><a href="#h28-5-10" id="h28-5-10" class="d">-                        targetUser,
</a><a href="#h28-5-11" id="h28-5-11" class="d">-                        conversationId,
</a><a href="#h28-5-12" id="h28-5-12" class="d">-                        context
</a><a href="#h28-5-13" id="h28-5-13" class="d">-                    )
</a><a href="#h28-5-14" id="h28-5-14" class="d">-                }
</a><a href="#h28-5-15" id="h28-5-15" class="d">-            }
</a><a href="#h28-5-16" id="h28-5-16" class="d">-
</a><a href="#h28-5-17" id="h28-5-17" class="d">-            //stealth switch
</a><a href="#h28-5-18" id="h28-5-18" class="d">-            val stealthSwitch = Switch(viewModel.context).apply {
</a><a href="#h28-5-19" id="h28-5-19" class="d">-                text = modContext.translation[&quot;friend_menu_option.stealth_mode&quot;]
</a><a href="#h28-5-20" id="h28-5-20" class="d">-                isChecked = modContext.feature(StealthMode::class).isStealth(conversationId)
</a><a href="#h28-5-21" id="h28-5-21" class="d">-                ViewAppearanceHelper.applyTheme(this)
</a><a href="#h28-5-22" id="h28-5-22" class="d">-                setOnCheckedChangeListener { _: CompoundButton?, isChecked: Boolean -&gt;
</a><a href="#h28-5-23" id="h28-5-23" class="d">-                    modContext.feature(StealthMode::class).setStealth(
</a><a href="#h28-5-24" id="h28-5-24" class="d">-                        conversationId,
</a><a href="#h28-5-25" id="h28-5-25" class="d">-                        isChecked
</a><a href="#h28-5-26" id="h28-5-26" class="d">-                    )
</a><a href="#h28-5-27" id="h28-5-27" class="d">-                }
</a><a href="#h28-5-28" id="h28-5-28" class="d">-            }
</a><a href="#h28-5-29" id="h28-5-29" class="d">-
</a><a href="#h28-5-30" id="h28-5-30" class="d">-            if (friendFeedMenuOptions.contains(&quot;anti_auto_save&quot;)) {
</a><a href="#h28-5-31" id="h28-5-31" class="d">-                createToggleFeature(viewConsumer,
</a><a href="#h28-5-32" id="h28-5-32" class="d">-                    &quot;friend_menu_option.anti_auto_save&quot;,
</a><a href="#h28-5-33" id="h28-5-33" class="d">-                    { context.feature(AntiAutoSave::class).isConversationIgnored(conversationId) },
</a><a href="#h28-5-34" id="h28-5-34" class="d">-                    { context.feature(AntiAutoSave::class).setConversationIgnored(conversationId, it) }
</a><a href="#h28-5-35" id="h28-5-35" class="d">-                )
</a><a href="#h28-5-36" id="h28-5-36" class="d">-            }
</a><a href="#h28-5-37" id="h28-5-37" class="d">-
</a><a href="#h28-5-38" id="h28-5-38" class="d">-            run {
</a><a href="#h28-5-39" id="h28-5-39" class="d">-                val userId = context.database.getFeedEntryByConversationId(conversationId)?.friendUserId ?: return@run
</a><a href="#h28-5-40" id="h28-5-40" class="d">-                if (friendFeedMenuOptions.contains(&quot;auto_download_blacklist&quot;)) {
</a><a href="#h28-5-41" id="h28-5-41" class="d">-                    createToggleFeature(viewConsumer,
</a><a href="#h28-5-42" id="h28-5-42" class="d">-                        &quot;friend_menu_option.auto_download_blacklist&quot;,
</a><a href="#h28-5-43" id="h28-5-43" class="d">-                        { context.feature(AntiAutoDownload::class).isUserIgnored(userId) },
</a><a href="#h28-5-44" id="h28-5-44" class="d">-                        { context.feature(AntiAutoDownload::class).setUserIgnored(userId, it) }
</a><a href="#h28-5-45" id="h28-5-45" class="d">-                    )
</a><a href="#h28-5-46" id="h28-5-46" class="d">-                }
</a><a href="#h28-5-47" id="h28-5-47" class="d">-            }
</a><a href="#h28-5-48" id="h28-5-48" class="d">-
</a><a href="#h28-5-49" id="h28-5-49" class="d">-            if (friendFeedMenuOptions.contains(&quot;stealth_mode&quot;)) {
</a><a href="#h28-5-50" id="h28-5-50" class="d">-                viewConsumer(stealthSwitch)
</a><a href="#h28-5-51" id="h28-5-51" class="d">-            }
</a><a href="#h28-5-52" id="h28-5-52" class="d">-            if (friendFeedMenuOptions.contains(&quot;conversation_info&quot;)) {
</a><a href="#h28-5-53" id="h28-5-53" class="d">-                viewConsumer(previewButton)
</a><a href="#h28-5-54" id="h28-5-54" class="d">-            }
</a><a href="#h28-5-55" id="h28-5-55" class="d">-            return
</a><a href="#h28-5-56" id="h28-5-56" class="d">-        }
</a><a href="#h28-5-57" id="h28-5-57" class="d">-
</a><a href="#h28-5-58" id="h28-5-58" class="d">-        val menuButtonBar = LinearLayout(viewModel.context).apply {
</a><a href="#h28-5-59" id="h28-5-59" class="d">-            layoutParams = ViewGroup.LayoutParams(ViewGroup.LayoutParams.MATCH_PARENT, ViewGroup.LayoutParams.WRAP_CONTENT)
</a><a href="#h28-5-60" id="h28-5-60" class="d">-            orientation = LinearLayout.HORIZONTAL
</a><a href="#h28-5-61" id="h28-5-61" class="d">-            gravity = Gravity.CENTER
</a><a href="#h28-5-62" id="h28-5-62" class="d">-        }
</a><a href="#h28-5-63" id="h28-5-63" class="d">-
</a><a href="#h28-5-64" id="h28-5-64" class="d">-        fun createActionButton(icon: String, isDisabled: Boolean? = null, onClick: (Boolean) -&gt; Unit) {
</a><a href="#h28-5-65" id="h28-5-65" class="d">-            //FIXME: hardcoded values
</a><a href="#h28-5-66" id="h28-5-66" class="d">-            menuButtonBar.addView(LinearLayout(viewModel.context).apply {
</a><a href="#h28-5-67" id="h28-5-67" class="d">-                layoutParams = LinearLayout.LayoutParams(0, ViewGroup.LayoutParams.MATCH_PARENT, 1f)
</a><a href="#h28-5-68" id="h28-5-68" class="d">-                gravity = Gravity.CENTER
</a><a href="#h28-5-69" id="h28-5-69" class="d">-                isClickable = false
</a><a href="#h28-5-70" id="h28-5-70" class="d">-
</a><a href="#h28-5-71" id="h28-5-71" class="d">-                var isLineThrough = isDisabled ?: false
</a><a href="#h28-5-72" id="h28-5-72" class="d">-                FriendActionButton.new(viewModel.context).apply {
</a><a href="#h28-5-73" id="h28-5-73" class="d">-                    fun setLineThrough(value: Boolean) {
</a><a href="#h28-5-74" id="h28-5-74" class="d">-                        setIconDrawable(createEmojiDrawable(icon, 60, 60, 50f, if (isDisabled == null) false else value))
</a><a href="#h28-5-75" id="h28-5-75" class="d">-                    }
</a><a href="#h28-5-76" id="h28-5-76" class="d">-                    setLineThrough(isLineThrough)
</a><a href="#h28-5-77" id="h28-5-77" class="d">-                    (instanceNonNull() as View).apply {
</a><a href="#h28-5-78" id="h28-5-78" class="d">-                        layoutParams = LinearLayout.LayoutParams(ViewGroup.LayoutParams.WRAP_CONTENT, ViewGroup.LayoutParams.WRAP_CONTENT).apply {
</a><a href="#h28-5-79" id="h28-5-79" class="d">-                            setMargins(0, 40, 0, 40)
</a><a href="#h28-5-80" id="h28-5-80" class="d">-                        }
</a><a href="#h28-5-81" id="h28-5-81" class="d">-                        setOnTouchListener { _, event -&gt;
</a><a href="#h28-5-82" id="h28-5-82" class="d">-                            if (event.action == MotionEvent.ACTION_UP) {
</a><a href="#h28-5-83" id="h28-5-83" class="d">-                                isLineThrough = !isLineThrough
</a><a href="#h28-5-84" id="h28-5-84" class="d">-                                onClick(isLineThrough)
</a><a href="#h28-5-85" id="h28-5-85" class="d">-                                setLineThrough(isLineThrough)
</a><a href="#h28-5-86" id="h28-5-86" class="d">-                            }
</a><a href="#h28-5-87" id="h28-5-87" class="d">-                            false
</a><a href="#h28-5-88" id="h28-5-88" class="d">-                        }
</a><a href="#h28-5-89" id="h28-5-89" class="d">-                    }
</a><a href="#h28-5-90" id="h28-5-90" class="d">-
</a><a href="#h28-5-91" id="h28-5-91" class="d">-                }.also { addView(it.instanceNonNull() as View) }
</a><a href="#h28-5-92" id="h28-5-92" class="d">-
</a><a href="#h28-5-93" id="h28-5-93" class="d">-            })
</a><a href="#h28-5-94" id="h28-5-94" class="d">-        }
</a><a href="#h28-5-95" id="h28-5-95" class="d">-
</a><a href="#h28-5-96" id="h28-5-96" class="d">-        if (friendFeedMenuOptions.contains(&quot;auto_download_blacklist&quot;)) {
</a><a href="#h28-5-97" id="h28-5-97" class="d">-            run {
</a><a href="#h28-5-98" id="h28-5-98" class="d">-                val userId =
</a><a href="#h28-5-99" id="h28-5-99" class="d">-                    context.database.getFeedEntryByConversationId(conversationId)?.friendUserId
</a><a href="#h28-5-100" id="h28-5-100" class="d">-                        ?: return@run
</a><a href="#h28-5-101" id="h28-5-101" class="d">-                createActionButton(
</a><a href="#h28-5-102" id="h28-5-102" class="d">-                    &quot;\u2B07\uFE0F&quot;,
</a><a href="#h28-5-103" id="h28-5-103" class="d">-                    isDisabled = !context.feature(AntiAutoDownload::class).isUserIgnored(userId)
</a><a href="#h28-5-104" id="h28-5-104" class="d">-                ) {
</a><a href="#h28-5-105" id="h28-5-105" class="d">-                    context.feature(AntiAutoDownload::class).setUserIgnored(userId, !it)
</a><a href="#h28-5-106" id="h28-5-106" class="d">-                }
</a><a href="#h28-5-107" id="h28-5-107" class="d">-            }
</a><a href="#h28-5-108" id="h28-5-108" class="d">-        }
</a><a href="#h28-5-109" id="h28-5-109" class="d">-
</a><a href="#h28-5-110" id="h28-5-110" class="d">-        if (friendFeedMenuOptions.contains(&quot;anti_auto_save&quot;)) {
</a><a href="#h28-5-111" id="h28-5-111" class="d">-            //diskette
</a><a href="#h28-5-112" id="h28-5-112" class="d">-            createActionButton(&quot;\uD83D\uDCAC&quot;,
</a><a href="#h28-5-113" id="h28-5-113" class="d">-                isDisabled = !context.feature(AntiAutoSave::class)
</a><a href="#h28-5-114" id="h28-5-114" class="d">-                    .isConversationIgnored(conversationId)
</a><a href="#h28-5-115" id="h28-5-115" class="d">-            ) {
</a><a href="#h28-5-116" id="h28-5-116" class="d">-                context.feature(AntiAutoSave::class).setConversationIgnored(conversationId, !it)
</a><a href="#h28-5-117" id="h28-5-117" class="d">-            }
</a><a href="#h28-5-118" id="h28-5-118" class="d">-        }
</a><a href="#h28-5-119" id="h28-5-119" class="d">-
</a><a href="#h28-5-120" id="h28-5-120" class="d">-
</a><a href="#h28-5-121" id="h28-5-121" class="d">-        if (friendFeedMenuOptions.contains(&quot;stealth_mode&quot;)) {
</a><a href="#h28-5-122" id="h28-5-122" class="d">-            //eyes
</a><a href="#h28-5-123" id="h28-5-123" class="d">-            createActionButton(
</a><a href="#h28-5-124" id="h28-5-124" class="d">-                &quot;\uD83D\uDC7B&quot;,
</a><a href="#h28-5-125" id="h28-5-125" class="d">-                isDisabled = !context.feature(StealthMode::class).isStealth(conversationId)
</a><a href="#h28-5-126" id="h28-5-126" class="d">-            ) { isChecked -&gt;
</a><a href="#h28-5-127" id="h28-5-127" class="d">-                context.feature(StealthMode::class).setStealth(
</a><a href="#h28-5-128" id="h28-5-128" class="i">+        val previewButton = Button(viewModel.context).apply {
</a><a href="#h28-5-129" id="h28-5-129" class="i">+            text = modContext.translation[&quot;friend_menu_option.preview&quot;]
</a><a href="#h28-5-130" id="h28-5-130" class="i">+            ViewAppearanceHelper.applyTheme(this, viewModel.width)
</a><a href="#h28-5-131" id="h28-5-131" class="i">+            setOnClickListener {
</a><a href="#h28-5-132" id="h28-5-132" class="i">+                showPreview(
</a><a href="#h28-5-133" id="h28-5-133" class="i">+                    targetUser,
</a>                     conversationId,
<a href="#h28-5-135" id="h28-5-135" class="d">-                    !isChecked
</a><a href="#h28-5-136" id="h28-5-136" class="i">+                    context
</a>                 )
             }
         }
 
         if (friendFeedMenuOptions.contains(&quot;conversation_info&quot;)) {
<a href="#h28-5-142" id="h28-5-142" class="d">-            //user
</a><a href="#h28-5-143" id="h28-5-143" class="d">-            createActionButton(&quot;\uD83D\uDC64&quot;) {
</a><a href="#h28-5-144" id="h28-5-144" class="d">-                showPreview(
</a><a href="#h28-5-145" id="h28-5-145" class="d">-                    targetUser,
</a><a href="#h28-5-146" id="h28-5-146" class="d">-                    conversationId,
</a><a href="#h28-5-147" id="h28-5-147" class="d">-                    viewModel.context
</a><a href="#h28-5-148" id="h28-5-148" class="d">-                )
</a><a href="#h28-5-149" id="h28-5-149" class="d">-            }
</a><a href="#h28-5-150" id="h28-5-150" class="i">+            viewConsumer(previewButton)
</a>         }
 
<a href="#h28-5-153" id="h28-5-153" class="d">-        viewConsumer(menuButtonBar)
</a><a href="#h28-5-154" id="h28-5-154" class="i">+        val rules: Array&lt;MessagingRuleFeature&gt; = arrayOf(
</a><a href="#h28-5-155" id="h28-5-155" class="i">+            StealthMode::class,
</a><a href="#h28-5-156" id="h28-5-156" class="i">+            AutoSave::class,
</a><a href="#h28-5-157" id="h28-5-157" class="i">+            MediaDownloader::class
</a><a href="#h28-5-158" id="h28-5-158" class="i">+        ).map { modContext.feature(it) }.toTypedArray()
</a><a href="#h28-5-159" id="h28-5-159" class="i">+
</a><a href="#h28-5-160" id="h28-5-160" class="i">+        rules.forEach { ruleFeature -&gt;
</a><a href="#h28-5-161" id="h28-5-161" class="i">+            if (!friendFeedMenuOptions.contains(ruleFeature.ruleType.key)) return@forEach
</a><a href="#h28-5-162" id="h28-5-162" class="i">+            Logger.debug(&quot;${ruleFeature.ruleType.key} ${ruleFeature.getRuleState()}&quot;)
</a><a href="#h28-5-163" id="h28-5-163" class="i">+
</a><a href="#h28-5-164" id="h28-5-164" class="i">+            val ruleState = ruleFeature.getRuleState() ?: return@forEach
</a><a href="#h28-5-165" id="h28-5-165" class="i">+            createToggleFeature(viewConsumer,
</a><a href="#h28-5-166" id="h28-5-166" class="i">+                ruleFeature.ruleType.translateOptionKey(ruleState.key),
</a><a href="#h28-5-167" id="h28-5-167" class="i">+                { ruleFeature.getState(conversationId) },
</a><a href="#h28-5-168" id="h28-5-168" class="i">+                { ruleFeature.setState(conversationId, it) }
</a><a href="#h28-5-169" id="h28-5-169" class="i">+            )
</a><a href="#h28-5-170" id="h28-5-170" class="i">+        }
</a>     }
 } 
\ No newline at end of file
</pre>
</div>
</body>
</html>
