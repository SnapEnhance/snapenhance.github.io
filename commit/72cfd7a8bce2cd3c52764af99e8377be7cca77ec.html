<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>feat(ui/new_chat_action_menu): debug view - SnapEnhance - An Xposed module offering an enhanced Snapchat experience
</title>
<link rel="icon" type="image/svg+xml" href="../../logo.png"/>
<link rel="alternate icon" href="../../favicon.png"/>
<link rel="alternate" type="application/atom+xml" title="SnapEnhance Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="SnapEnhance Atom Feed (tags)" href="../tags.xml" />
<link rel="stylesheet" type="text/css" href="../../style.css" />
<link rel="stylesheet" type="text/css" href="../../fonts.css" />
</head>
<body>
<div id="head"><table><tr><td><a class="logo" href="../../"><img src="../../logo.png" alt="" width="32" height="32" /></a></td><td><strong>SnapEnhance</strong><span class="desc"> - An Xposed module offering an enhanced Snapchat experience
</span>
</td></tr></table>
<p><a href="../about.html">About</a> | <a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/.gitmodules.html">Submodules</a> | <a href="../file/LICENSE.html">License</a></p>
</div>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/72cfd7a8bce2cd3c52764af99e8377be7cca77ec.html">72cfd7a8bce2cd3c52764af99e8377be7cca77ec</a>
<b>parent</b> <a href="../commit/7619cc0b8eb752bbd5e51f9a70c184ee9bd1933b.html">7619cc0b8eb752bbd5e51f9a70c184ee9bd1933b</a>
<b>Author:</b> rhunk &lt;<a href="mailto:101876869+rhunk@users.noreply.github.com">101876869+rhunk@users.noreply.github.com</a>&gt;
<b>Date:</b>   Mon,  4 Mar 2024 00:03:43 +0100

feat(ui/new_chat_action_menu): debug view

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/MenuViewInjector.kt</a></td><td> | </td><td class="num">11</td><td><span class="i">+++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/ChatActionMenu.kt</a></td><td> | </td><td class="num">150</td><td><span class="i">+</span><span class="d">------------------------------------------------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h2">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/NewChatActionMenu.kt</a></td><td> | </td><td class="num">146</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">-</span></td></tr>
</table></pre><pre>3 files changed, 157 insertions(+), 150 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/MenuViewInjector.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/MenuViewInjector.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/MenuViewInjector.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/MenuViewInjector.kt</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -40,6 +40,7 @@ class MenuViewInjector : Feature(&quot;MenuViewInjector&quot;, loadParams = FeatureLoadPar
</a>         val componentsHolder = context.resources.getIdentifier(&quot;components_holder&quot;, &quot;id&quot;)
         val feedNewChat = context.resources.getIdentifier(&quot;feed_new_chat&quot;, &quot;id&quot;)
         val contextMenuButtonIconView = context.resources.getIdentifier(&quot;context_menu_button_icon_view&quot;, &quot;id&quot;)
<a href="#h0-0-3" id="h0-0-3" class="i">+        val chatActionMenu = context.resources.getIdentifier(&quot;chat_action_menu&quot;, &quot;id&quot;)
</a> 
         context.event.subscribe(AddViewEvent::class) { event -&gt;
             val originalAddView: (View) -&gt; Unit = {
<a href="#h0-1" id="h0-1" class="h">@@ -75,6 +76,16 @@ class MenuViewInjector : Feature(&quot;MenuViewInjector&quot;, loadParams = FeatureLoadPar
</a>                 return@subscribe
             }
 
<a href="#h0-1-3" id="h0-1-3" class="i">+            if (viewGroup !is LinearLayout &amp;&amp; childView.id == chatActionMenu &amp;&amp; context.config.experimental.newChatActionMenu.get() &amp;&amp; context.isDeveloper) {
</a><a href="#h0-1-4" id="h0-1-4" class="i">+                event.view = LinearLayout(childView.context).apply {
</a><a href="#h0-1-5" id="h0-1-5" class="i">+                    orientation = LinearLayout.VERTICAL
</a><a href="#h0-1-6" id="h0-1-6" class="i">+                    addView(
</a><a href="#h0-1-7" id="h0-1-7" class="i">+                        (menuMap[NewChatActionMenu::class]!! as NewChatActionMenu).createDebugInfoView(childView.context)
</a><a href="#h0-1-8" id="h0-1-8" class="i">+                    )
</a><a href="#h0-1-9" id="h0-1-9" class="i">+                    addView(event.view)
</a><a href="#h0-1-10" id="h0-1-10" class="i">+                }
</a><a href="#h0-1-11" id="h0-1-11" class="i">+            }
</a><a href="#h0-1-12" id="h0-1-12" class="i">+
</a>             if (childView.javaClass.name.endsWith(&quot;ChatActionMenuComponent&quot;) &amp;&amp; context.config.experimental.newChatActionMenu.get()) {
                 (menuMap[NewChatActionMenu::class]!! as NewChatActionMenu).handle(event)
                 return@subscribe
<b>diff --git a/<a id="h1" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/ChatActionMenu.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/ChatActionMenu.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/ChatActionMenu.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/ChatActionMenu.kt</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -1,56 +1,28 @@
</a> package me.rhunk.snapenhance.core.ui.menu.impl
 
<a href="#h1-0-2" id="h1-0-2" class="d">-import android.annotation.SuppressLint
</a><a href="#h1-0-3" id="h1-0-3" class="d">-import android.content.Context
</a><a href="#h1-0-4" id="h1-0-4" class="d">-import android.text.format.Formatter
</a> import android.view.View
 import android.view.ViewGroup
 import android.view.ViewGroup.MarginLayoutParams
 import android.widget.Button
 import android.widget.LinearLayout
<a href="#h1-0-10" id="h1-0-10" class="d">-import androidx.compose.foundation.layout.Arrangement
</a><a href="#h1-0-11" id="h1-0-11" class="d">-import androidx.compose.foundation.layout.ExperimentalLayoutApi
</a><a href="#h1-0-12" id="h1-0-12" class="d">-import androidx.compose.foundation.layout.FlowRow
</a><a href="#h1-0-13" id="h1-0-13" class="d">-import androidx.compose.foundation.layout.fillMaxWidth
</a><a href="#h1-0-14" id="h1-0-14" class="d">-import androidx.compose.foundation.layout.padding
</a><a href="#h1-0-15" id="h1-0-15" class="d">-import androidx.compose.material3.Button
</a><a href="#h1-0-16" id="h1-0-16" class="d">-import androidx.compose.material3.Text
</a><a href="#h1-0-17" id="h1-0-17" class="d">-import androidx.compose.ui.Modifier
</a><a href="#h1-0-18" id="h1-0-18" class="d">-import androidx.compose.ui.unit.dp
</a><a href="#h1-0-19" id="h1-0-19" class="d">-import me.rhunk.snapenhance.common.data.ContentType
</a><a href="#h1-0-20" id="h1-0-20" class="d">-import me.rhunk.snapenhance.common.ui.createComposeView
</a><a href="#h1-0-21" id="h1-0-21" class="d">-import me.rhunk.snapenhance.common.util.ktx.copyToClipboard
</a><a href="#h1-0-22" id="h1-0-22" class="d">-import me.rhunk.snapenhance.common.util.protobuf.ProtoReader
</a><a href="#h1-0-23" id="h1-0-23" class="d">-import me.rhunk.snapenhance.common.util.snap.RemoteMediaResolver
</a> import me.rhunk.snapenhance.core.features.impl.downloader.MediaDownloader
<a href="#h1-0-25" id="h1-0-25" class="d">-import me.rhunk.snapenhance.core.features.impl.downloader.decoder.MessageDecoder
</a> import me.rhunk.snapenhance.core.features.impl.experiments.ConvertMessageLocally
 import me.rhunk.snapenhance.core.features.impl.messaging.Messaging
 import me.rhunk.snapenhance.core.features.impl.spying.MessageLogger
<a href="#h1-0-29" id="h1-0-29" class="d">-import me.rhunk.snapenhance.core.ui.ViewAppearanceHelper
</a> import me.rhunk.snapenhance.core.ui.ViewTagState
 import me.rhunk.snapenhance.core.ui.applyTheme
<a href="#h1-0-32" id="h1-0-32" class="d">-import me.rhunk.snapenhance.core.ui.debugEditText
</a> import me.rhunk.snapenhance.core.ui.menu.AbstractMenu
 import me.rhunk.snapenhance.core.ui.triggerCloseTouchEvent
 import me.rhunk.snapenhance.core.util.hook.HookStage
 import me.rhunk.snapenhance.core.util.hook.hook
 import me.rhunk.snapenhance.core.util.ktx.getDimens
 import me.rhunk.snapenhance.core.util.ktx.vibrateLongPress
<a href="#h1-0-39" id="h1-0-39" class="d">-import java.text.SimpleDateFormat
</a><a href="#h1-0-40" id="h1-0-40" class="d">-import java.util.Date
</a><a href="#h1-0-41" id="h1-0-41" class="d">-import kotlin.io.encoding.Base64
</a><a href="#h1-0-42" id="h1-0-42" class="d">-import kotlin.io.encoding.ExperimentalEncodingApi
</a> 
 
<a href="#h1-0-45" id="h1-0-45" class="d">-@SuppressLint(&quot;DiscouragedApi&quot;)
</a> class ChatActionMenu : AbstractMenu() {
     private val viewTagState = ViewTagState()
<a href="#h1-0-48" id="h1-0-48" class="d">-
</a>     private val defaultGap by lazy { context.resources.getDimens(&quot;default_gap&quot;) }
<a href="#h1-0-50" id="h1-0-50" class="d">-
</a>     private val chatActionMenuItemMargin by lazy { context.resources.getDimens(&quot;chat_action_menu_item_margin&quot;) }
<a href="#h1-0-52" id="h1-0-52" class="d">-
</a>     private val actionMenuItemHeight by lazy { context.resources.getDimens(&quot;action_menu_item_height&quot;) }
 
     private fun createContainer(viewGroup: ViewGroup): LinearLayout {
<a href="#h1-1" id="h1-1" class="h">@@ -68,29 +40,13 @@ class ChatActionMenu : AbstractMenu() {
</a>         }
     }
 
<a href="#h1-1-3" id="h1-1-3" class="d">-    private fun debugAlertDialog(context: Context, title: String, text: String) {
</a><a href="#h1-1-4" id="h1-1-4" class="d">-        this@ChatActionMenu.context.runOnUiThread {
</a><a href="#h1-1-5" id="h1-1-5" class="d">-            ViewAppearanceHelper.newAlertDialogBuilder(context).apply {
</a><a href="#h1-1-6" id="h1-1-6" class="d">-                setTitle(title)
</a><a href="#h1-1-7" id="h1-1-7" class="d">-                setView(debugEditText(context, text))
</a><a href="#h1-1-8" id="h1-1-8" class="d">-                setPositiveButton(&quot;OK&quot;) { dialog, _ -&gt; dialog.dismiss() }
</a><a href="#h1-1-9" id="h1-1-9" class="d">-                setNegativeButton(&quot;Copy&quot;) { _, _ -&gt;
</a><a href="#h1-1-10" id="h1-1-10" class="d">-                    context.copyToClipboard(text, title)
</a><a href="#h1-1-11" id="h1-1-11" class="d">-                }
</a><a href="#h1-1-12" id="h1-1-12" class="d">-            }.show()
</a><a href="#h1-1-13" id="h1-1-13" class="d">-        }
</a><a href="#h1-1-14" id="h1-1-14" class="d">-    }
</a><a href="#h1-1-15" id="h1-1-15" class="d">-
</a><a href="#h1-1-16" id="h1-1-16" class="d">-    private val lastFocusedMessage
</a><a href="#h1-1-17" id="h1-1-17" class="d">-        get() = context.database.getConversationMessageFromId(context.feature(Messaging::class).lastFocusedMessageId)
</a><a href="#h1-1-18" id="h1-1-18" class="d">-
</a>     override fun init() {
         runCatching {
             if (!context.config.downloader.downloadContextMenu.get() &amp;&amp; context.config.messaging.messageLogger.globalState != true &amp;&amp; !context.isDeveloper) return
             context.androidContext.classLoader.loadClass(&quot;com.snap.messaging.chat.features.actionmenu.ActionMenuChatItemContainer&quot;)
                 .hook(&quot;onMeasure&quot;, HookStage.BEFORE) { param -&gt;
                     param.setArg(1,
<a href="#h1-1-25" id="h1-1-25" class="d">-                        View.MeasureSpec.makeMeasureSpec((context.resources.displayMetrics.heightPixels * 0.35).toInt(), View.MeasureSpec.AT_MOST)
</a><a href="#h1-1-26" id="h1-1-26" class="i">+                        View.MeasureSpec.makeMeasureSpec((context.resources.displayMetrics.heightPixels * 0.25).toInt(), View.MeasureSpec.AT_MOST)
</a>                     )
                 }
         }.onFailure {
<a href="#h1-2" id="h1-2" class="h">@@ -98,8 +54,6 @@ class ChatActionMenu : AbstractMenu() {
</a>         }
     }
 
<a href="#h1-2-3" id="h1-2-3" class="d">-    @OptIn(ExperimentalLayoutApi::class, ExperimentalEncodingApi::class)
</a><a href="#h1-2-4" id="h1-2-4" class="d">-    @SuppressLint(&quot;SetTextI18n&quot;, &quot;DiscouragedApi&quot;, &quot;ClickableViewAccessibility&quot;)
</a>     override fun inject(parent: ViewGroup, view: View, viewConsumer: (View) -&gt; Unit) {
         val viewGroup = parent.parent.parent as? ViewGroup ?: return
         if (viewTagState[viewGroup]) return
<a href="#h1-3" id="h1-3" class="h">@@ -202,108 +156,6 @@ class ChatActionMenu : AbstractMenu() {
</a>             })
         }
 
<a href="#h1-3-3" id="h1-3-3" class="d">-        if (context.isDeveloper) {
</a><a href="#h1-3-4" id="h1-3-4" class="d">-            val composeDebugView = createComposeView(viewGroup.context) {
</a><a href="#h1-3-5" id="h1-3-5" class="d">-                FlowRow(
</a><a href="#h1-3-6" id="h1-3-6" class="d">-                    modifier = Modifier.fillMaxWidth().padding(5.dp),
</a><a href="#h1-3-7" id="h1-3-7" class="d">-                    horizontalArrangement = Arrangement.spacedBy(3.dp)
</a><a href="#h1-3-8" id="h1-3-8" class="d">-                ) {
</a><a href="#h1-3-9" id="h1-3-9" class="d">-                    Button(onClick = {
</a><a href="#h1-3-10" id="h1-3-10" class="d">-                        val arroyoMessage = lastFocusedMessage ?: return@Button
</a><a href="#h1-3-11" id="h1-3-11" class="d">-                        debugAlertDialog(viewGroup.context,
</a><a href="#h1-3-12" id="h1-3-12" class="d">-                            &quot;Message Info&quot;,
</a><a href="#h1-3-13" id="h1-3-13" class="d">-                            StringBuilder().apply {
</a><a href="#h1-3-14" id="h1-3-14" class="d">-                                runCatching {
</a><a href="#h1-3-15" id="h1-3-15" class="d">-                                    append(&quot;conversation_id: ${arroyoMessage.clientConversationId}\n&quot;)
</a><a href="#h1-3-16" id="h1-3-16" class="d">-                                    append(&quot;sender_id: ${arroyoMessage.senderId}\n&quot;)
</a><a href="#h1-3-17" id="h1-3-17" class="d">-                                    append(&quot;client_id: ${arroyoMessage.clientMessageId}, server_id: ${arroyoMessage.serverMessageId}\n&quot;)
</a><a href="#h1-3-18" id="h1-3-18" class="d">-                                    append(&quot;content_type: ${ContentType.fromId(arroyoMessage.contentType)} (${arroyoMessage.contentType})\n&quot;)
</a><a href="#h1-3-19" id="h1-3-19" class="d">-                                    append(&quot;parsed_content_type: ${
</a><a href="#h1-3-20" id="h1-3-20" class="d">-                                        ContentType.fromMessageContainer(
</a><a href="#h1-3-21" id="h1-3-21" class="d">-                                            ProtoReader(arroyoMessage.messageContent!!).followPath(4, 4)
</a><a href="#h1-3-22" id="h1-3-22" class="d">-                                        ).let { &quot;$it (${it?.id})&quot; }}\n&quot;)
</a><a href="#h1-3-23" id="h1-3-23" class="d">-                                    append(&quot;creation_timestamp: ${
</a><a href="#h1-3-24" id="h1-3-24" class="d">-                                        SimpleDateFormat.getDateTimeInstance().format(
</a><a href="#h1-3-25" id="h1-3-25" class="d">-                                            Date(arroyoMessage.creationTimestamp)
</a><a href="#h1-3-26" id="h1-3-26" class="d">-                                        )} (${arroyoMessage.creationTimestamp})\n&quot;)
</a><a href="#h1-3-27" id="h1-3-27" class="d">-                                    append(&quot;read_timestamp: ${SimpleDateFormat.getDateTimeInstance().format(
</a><a href="#h1-3-28" id="h1-3-28" class="d">-                                        Date(arroyoMessage.readTimestamp)
</a><a href="#h1-3-29" id="h1-3-29" class="d">-                                    )} (${arroyoMessage.readTimestamp})\n&quot;)
</a><a href="#h1-3-30" id="h1-3-30" class="d">-                                    append(&quot;ml_deleted: ${messageLogger.isMessageDeleted(arroyoMessage.clientConversationId!!, arroyoMessage.clientMessageId.toLong())}, &quot;)
</a><a href="#h1-3-31" id="h1-3-31" class="d">-                                    append(&quot;ml_stored: ${messageLogger.getMessageObject(arroyoMessage.clientConversationId!!, arroyoMessage.clientMessageId.toLong()) != null}\n&quot;)
</a><a href="#h1-3-32" id="h1-3-32" class="d">-                                }
</a><a href="#h1-3-33" id="h1-3-33" class="d">-                            }.toString()
</a><a href="#h1-3-34" id="h1-3-34" class="d">-                        )
</a><a href="#h1-3-35" id="h1-3-35" class="d">-                    }) {
</a><a href="#h1-3-36" id="h1-3-36" class="d">-                        Text(&quot;Info&quot;)
</a><a href="#h1-3-37" id="h1-3-37" class="d">-                    }
</a><a href="#h1-3-38" id="h1-3-38" class="d">-                    Button(onClick = {
</a><a href="#h1-3-39" id="h1-3-39" class="d">-                        val arroyoMessage = lastFocusedMessage ?: return@Button
</a><a href="#h1-3-40" id="h1-3-40" class="d">-                        messaging.conversationManager?.fetchMessage(arroyoMessage.clientConversationId!!, arroyoMessage.clientMessageId.toLong(), onSuccess = { message -&gt;
</a><a href="#h1-3-41" id="h1-3-41" class="d">-                            val decodedAttachments = MessageDecoder.decode(message.messageContent!!)
</a><a href="#h1-3-42" id="h1-3-42" class="d">-
</a><a href="#h1-3-43" id="h1-3-43" class="d">-                            debugAlertDialog(
</a><a href="#h1-3-44" id="h1-3-44" class="d">-                                viewGroup.context,
</a><a href="#h1-3-45" id="h1-3-45" class="d">-                                &quot;Media References&quot;,
</a><a href="#h1-3-46" id="h1-3-46" class="d">-                                decodedAttachments.mapIndexed { index, attachment -&gt;
</a><a href="#h1-3-47" id="h1-3-47" class="d">-                                    StringBuilder().apply {
</a><a href="#h1-3-48" id="h1-3-48" class="d">-                                        append(&quot;---- media $index ----\n&quot;)
</a><a href="#h1-3-49" id="h1-3-49" class="d">-                                        append(&quot;resolveProto: ${attachment.mediaUrlKey}\n&quot;)
</a><a href="#h1-3-50" id="h1-3-50" class="d">-                                        append(&quot;type: ${attachment.type}\n&quot;)
</a><a href="#h1-3-51" id="h1-3-51" class="d">-                                        attachment.attachmentInfo?.apply {
</a><a href="#h1-3-52" id="h1-3-52" class="d">-                                            encryption?.let {
</a><a href="#h1-3-53" id="h1-3-53" class="d">-                                                append(&quot;encryption:\n  - key: ${it.key}\n  - iv: ${it.iv}\n&quot;)
</a><a href="#h1-3-54" id="h1-3-54" class="d">-                                            }
</a><a href="#h1-3-55" id="h1-3-55" class="d">-                                            resolution?.let {
</a><a href="#h1-3-56" id="h1-3-56" class="d">-                                                append(&quot;resolution: ${it.first}x${it.second}\n&quot;)
</a><a href="#h1-3-57" id="h1-3-57" class="d">-                                            }
</a><a href="#h1-3-58" id="h1-3-58" class="d">-                                            duration?.let {
</a><a href="#h1-3-59" id="h1-3-59" class="d">-                                                append(&quot;duration: $it\n&quot;)
</a><a href="#h1-3-60" id="h1-3-60" class="d">-                                            }
</a><a href="#h1-3-61" id="h1-3-61" class="d">-                                        }
</a><a href="#h1-3-62" id="h1-3-62" class="d">-                                        runCatching {
</a><a href="#h1-3-63" id="h1-3-63" class="d">-                                            val mediaHeaders = RemoteMediaResolver.getMediaHeaders(Base64.UrlSafe.decode(attachment.mediaUrlKey ?: return@runCatching))
</a><a href="#h1-3-64" id="h1-3-64" class="d">-                                            append(&quot;content-type: ${mediaHeaders[&quot;content-type&quot;]}\n&quot;)
</a><a href="#h1-3-65" id="h1-3-65" class="d">-                                            append(&quot;content-length: ${Formatter.formatShortFileSize(context.androidContext, mediaHeaders[&quot;content-length&quot;]?.toLongOrNull() ?: 0)}\n&quot;)
</a><a href="#h1-3-66" id="h1-3-66" class="d">-                                            append(&quot;creation-date: ${mediaHeaders[&quot;last-modified&quot;]}\n&quot;)
</a><a href="#h1-3-67" id="h1-3-67" class="d">-                                        }
</a><a href="#h1-3-68" id="h1-3-68" class="d">-                                    }.toString()
</a><a href="#h1-3-69" id="h1-3-69" class="d">-                                }.joinToString(&quot;\n\n&quot;)
</a><a href="#h1-3-70" id="h1-3-70" class="d">-                            )
</a><a href="#h1-3-71" id="h1-3-71" class="d">-                        })
</a><a href="#h1-3-72" id="h1-3-72" class="d">-                    }) {
</a><a href="#h1-3-73" id="h1-3-73" class="d">-                        Text(&quot;Refs&quot;)
</a><a href="#h1-3-74" id="h1-3-74" class="d">-                    }
</a><a href="#h1-3-75" id="h1-3-75" class="d">-                    Button(onClick = {
</a><a href="#h1-3-76" id="h1-3-76" class="d">-                        val message = lastFocusedMessage ?: return@Button
</a><a href="#h1-3-77" id="h1-3-77" class="d">-                        debugAlertDialog(
</a><a href="#h1-3-78" id="h1-3-78" class="d">-                            viewGroup.context,
</a><a href="#h1-3-79" id="h1-3-79" class="d">-                            &quot;Arroyo proto&quot;,
</a><a href="#h1-3-80" id="h1-3-80" class="d">-                            message.messageContent?.let { ProtoReader(it) }?.toString() ?: &quot;empty&quot;
</a><a href="#h1-3-81" id="h1-3-81" class="d">-                        )
</a><a href="#h1-3-82" id="h1-3-82" class="d">-                    }) {
</a><a href="#h1-3-83" id="h1-3-83" class="d">-                        Text(&quot;Arroyo proto&quot;)
</a><a href="#h1-3-84" id="h1-3-84" class="d">-                    }
</a><a href="#h1-3-85" id="h1-3-85" class="d">-                    Button(onClick = {
</a><a href="#h1-3-86" id="h1-3-86" class="d">-                        val arroyoMessage = lastFocusedMessage ?: return@Button
</a><a href="#h1-3-87" id="h1-3-87" class="d">-                        messaging.conversationManager?.fetchMessage(arroyoMessage.clientConversationId!!, arroyoMessage.clientMessageId.toLong(), onSuccess = { message -&gt;
</a><a href="#h1-3-88" id="h1-3-88" class="d">-                            debugAlertDialog(
</a><a href="#h1-3-89" id="h1-3-89" class="d">-                                viewGroup.context,
</a><a href="#h1-3-90" id="h1-3-90" class="d">-                                &quot;Message proto&quot;,
</a><a href="#h1-3-91" id="h1-3-91" class="d">-                                message.messageContent?.content?.let { ProtoReader(it) }?.toString() ?: &quot;empty&quot;
</a><a href="#h1-3-92" id="h1-3-92" class="d">-                            )
</a><a href="#h1-3-93" id="h1-3-93" class="d">-                        }, onError = {
</a><a href="#h1-3-94" id="h1-3-94" class="d">-                            this@ChatActionMenu.context.shortToast(&quot;Failed to fetch message: $it&quot;)
</a><a href="#h1-3-95" id="h1-3-95" class="d">-                        })
</a><a href="#h1-3-96" id="h1-3-96" class="d">-                    }) {
</a><a href="#h1-3-97" id="h1-3-97" class="d">-                        Text(&quot;Message proto&quot;)
</a><a href="#h1-3-98" id="h1-3-98" class="d">-                    }
</a><a href="#h1-3-99" id="h1-3-99" class="d">-                }
</a><a href="#h1-3-100" id="h1-3-100" class="d">-            }
</a><a href="#h1-3-101" id="h1-3-101" class="d">-            viewGroup.addView(createContainer(viewGroup).apply {
</a><a href="#h1-3-102" id="h1-3-102" class="d">-                addView(composeDebugView)
</a><a href="#h1-3-103" id="h1-3-103" class="d">-            })
</a><a href="#h1-3-104" id="h1-3-104" class="d">-        }
</a> 
         viewGroup.addView(buttonContainer)
     }
<b>diff --git a/<a id="h2" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/NewChatActionMenu.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/NewChatActionMenu.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/NewChatActionMenu.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/NewChatActionMenu.kt</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -1,5 +1,7 @@
</a> package me.rhunk.snapenhance.core.ui.menu.impl
 
<a href="#h2-0-2" id="h2-0-2" class="i">+import android.content.Context
</a><a href="#h2-0-3" id="h2-0-3" class="i">+import android.text.format.Formatter
</a> import android.view.ViewGroup
 import android.widget.LinearLayout
 import android.widget.ScrollView
<a href="#h2-1" id="h2-1" class="h">@@ -12,6 +14,8 @@ import androidx.compose.material.icons.filled.Download
</a> import androidx.compose.material.icons.filled.RemoveRedEye
 import androidx.compose.material.icons.outlined.Image
 import androidx.compose.material.icons.rounded.BookmarkRemove
<a href="#h2-1-3" id="h2-1-3" class="i">+import androidx.compose.material3.Button
</a><a href="#h2-1-4" id="h2-1-4" class="i">+import androidx.compose.material3.Card
</a> import androidx.compose.material3.Icon
 import androidx.compose.material3.MaterialTheme
 import androidx.compose.material3.Text
<a href="#h2-2" id="h2-2" class="h">@@ -21,21 +25,160 @@ import androidx.compose.ui.Modifier
</a> import androidx.compose.ui.graphics.Color
 import androidx.compose.ui.graphics.vector.ImageVector
 import androidx.compose.ui.input.pointer.pointerInput
<a href="#h2-2-3" id="h2-2-3" class="i">+import androidx.compose.ui.platform.ComposeView
</a> import androidx.compose.ui.unit.dp
<a href="#h2-2-5" id="h2-2-5" class="i">+import me.rhunk.snapenhance.common.data.ContentType
</a> import me.rhunk.snapenhance.common.ui.createComposeView
<a href="#h2-2-7" id="h2-2-7" class="i">+import me.rhunk.snapenhance.common.util.ktx.copyToClipboard
</a><a href="#h2-2-8" id="h2-2-8" class="i">+import me.rhunk.snapenhance.common.util.protobuf.ProtoReader
</a><a href="#h2-2-9" id="h2-2-9" class="i">+import me.rhunk.snapenhance.common.util.snap.RemoteMediaResolver
</a> import me.rhunk.snapenhance.core.event.events.impl.AddViewEvent
 import me.rhunk.snapenhance.core.features.impl.downloader.MediaDownloader
<a href="#h2-2-12" id="h2-2-12" class="i">+import me.rhunk.snapenhance.core.features.impl.downloader.decoder.MessageDecoder
</a> import me.rhunk.snapenhance.core.features.impl.experiments.ConvertMessageLocally
 import me.rhunk.snapenhance.core.features.impl.messaging.Messaging
 import me.rhunk.snapenhance.core.features.impl.spying.MessageLogger
<a href="#h2-2-16" id="h2-2-16" class="i">+import me.rhunk.snapenhance.core.ui.ViewAppearanceHelper
</a><a href="#h2-2-17" id="h2-2-17" class="i">+import me.rhunk.snapenhance.core.ui.debugEditText
</a> import me.rhunk.snapenhance.core.ui.iterateParent
 import me.rhunk.snapenhance.core.ui.menu.AbstractMenu
 import me.rhunk.snapenhance.core.ui.triggerCloseTouchEvent
 import me.rhunk.snapenhance.core.util.ktx.isDarkTheme
 import me.rhunk.snapenhance.core.util.ktx.setObjectField
 import me.rhunk.snapenhance.core.util.ktx.vibrateLongPress
<a href="#h2-2-24" id="h2-2-24" class="i">+import java.text.SimpleDateFormat
</a><a href="#h2-2-25" id="h2-2-25" class="i">+import java.util.Date
</a><a href="#h2-2-26" id="h2-2-26" class="i">+import kotlin.io.encoding.Base64
</a><a href="#h2-2-27" id="h2-2-27" class="i">+import kotlin.io.encoding.ExperimentalEncodingApi
</a> 
 class NewChatActionMenu : AbstractMenu() {
<a href="#h2-2-30" id="h2-2-30" class="i">+    private fun debugAlertDialog(context: Context, title: String, text: String) {
</a><a href="#h2-2-31" id="h2-2-31" class="i">+        this@NewChatActionMenu.context.runOnUiThread {
</a><a href="#h2-2-32" id="h2-2-32" class="i">+            ViewAppearanceHelper.newAlertDialogBuilder(context).apply {
</a><a href="#h2-2-33" id="h2-2-33" class="i">+                setTitle(title)
</a><a href="#h2-2-34" id="h2-2-34" class="i">+                setView(debugEditText(context, text))
</a><a href="#h2-2-35" id="h2-2-35" class="i">+                setPositiveButton(&quot;OK&quot;) { dialog, _ -&gt; dialog.dismiss() }
</a><a href="#h2-2-36" id="h2-2-36" class="i">+                setNegativeButton(&quot;Copy&quot;) { _, _ -&gt;
</a><a href="#h2-2-37" id="h2-2-37" class="i">+                    context.copyToClipboard(text, title)
</a><a href="#h2-2-38" id="h2-2-38" class="i">+                }
</a><a href="#h2-2-39" id="h2-2-39" class="i">+            }.show()
</a><a href="#h2-2-40" id="h2-2-40" class="i">+        }
</a><a href="#h2-2-41" id="h2-2-41" class="i">+    }
</a><a href="#h2-2-42" id="h2-2-42" class="i">+
</a><a href="#h2-2-43" id="h2-2-43" class="i">+    private val lastFocusedMessage
</a><a href="#h2-2-44" id="h2-2-44" class="i">+        get() = context.database.getConversationMessageFromId(context.feature(Messaging::class).lastFocusedMessageId)
</a><a href="#h2-2-45" id="h2-2-45" class="i">+
</a><a href="#h2-2-46" id="h2-2-46" class="i">+    @OptIn(ExperimentalLayoutApi::class, ExperimentalEncodingApi::class)
</a><a href="#h2-2-47" id="h2-2-47" class="i">+    fun createDebugInfoView(context: Context): ComposeView {
</a><a href="#h2-2-48" id="h2-2-48" class="i">+        val messageLogger = this@NewChatActionMenu.context.feature(MessageLogger::class)
</a><a href="#h2-2-49" id="h2-2-49" class="i">+        val messaging = this@NewChatActionMenu.context.feature(Messaging::class)
</a><a href="#h2-2-50" id="h2-2-50" class="i">+
</a><a href="#h2-2-51" id="h2-2-51" class="i">+        return createComposeView(context) {
</a><a href="#h2-2-52" id="h2-2-52" class="i">+            Card(
</a><a href="#h2-2-53" id="h2-2-53" class="i">+                modifier = Modifier.padding(start = 16.dp, end = 16.dp, top = 0.dp, bottom = 0.dp)
</a><a href="#h2-2-54" id="h2-2-54" class="i">+            ) {
</a><a href="#h2-2-55" id="h2-2-55" class="i">+                FlowRow(
</a><a href="#h2-2-56" id="h2-2-56" class="i">+                    modifier = Modifier
</a><a href="#h2-2-57" id="h2-2-57" class="i">+                        .fillMaxWidth()
</a><a href="#h2-2-58" id="h2-2-58" class="i">+                        .padding(5.dp),
</a><a href="#h2-2-59" id="h2-2-59" class="i">+                    horizontalArrangement = Arrangement.SpaceEvenly,
</a><a href="#h2-2-60" id="h2-2-60" class="i">+                ) {
</a><a href="#h2-2-61" id="h2-2-61" class="i">+                    Button(onClick = {
</a><a href="#h2-2-62" id="h2-2-62" class="i">+                        val arroyoMessage = lastFocusedMessage ?: return@Button
</a><a href="#h2-2-63" id="h2-2-63" class="i">+                        debugAlertDialog(context,
</a><a href="#h2-2-64" id="h2-2-64" class="i">+                            &quot;Message Info&quot;,
</a><a href="#h2-2-65" id="h2-2-65" class="i">+                            StringBuilder().apply {
</a><a href="#h2-2-66" id="h2-2-66" class="i">+                                runCatching {
</a><a href="#h2-2-67" id="h2-2-67" class="i">+                                    append(&quot;conversation_id: ${arroyoMessage.clientConversationId}\n&quot;)
</a><a href="#h2-2-68" id="h2-2-68" class="i">+                                    append(&quot;sender_id: ${arroyoMessage.senderId}\n&quot;)
</a><a href="#h2-2-69" id="h2-2-69" class="i">+                                    append(&quot;client_id: ${arroyoMessage.clientMessageId}, server_id: ${arroyoMessage.serverMessageId}\n&quot;)
</a><a href="#h2-2-70" id="h2-2-70" class="i">+                                    append(&quot;content_type: ${ContentType.fromId(arroyoMessage.contentType)} (${arroyoMessage.contentType})\n&quot;)
</a><a href="#h2-2-71" id="h2-2-71" class="i">+                                    append(&quot;parsed_content_type: ${
</a><a href="#h2-2-72" id="h2-2-72" class="i">+                                        ContentType.fromMessageContainer(
</a><a href="#h2-2-73" id="h2-2-73" class="i">+                                            ProtoReader(arroyoMessage.messageContent!!).followPath(4, 4)
</a><a href="#h2-2-74" id="h2-2-74" class="i">+                                        ).let { &quot;$it (${it?.id})&quot; }}\n&quot;)
</a><a href="#h2-2-75" id="h2-2-75" class="i">+                                    append(&quot;creation_timestamp: ${
</a><a href="#h2-2-76" id="h2-2-76" class="i">+                                        SimpleDateFormat.getDateTimeInstance().format(
</a><a href="#h2-2-77" id="h2-2-77" class="i">+                                            Date(arroyoMessage.creationTimestamp)
</a><a href="#h2-2-78" id="h2-2-78" class="i">+                                        )} (${arroyoMessage.creationTimestamp})\n&quot;)
</a><a href="#h2-2-79" id="h2-2-79" class="i">+                                    append(&quot;read_timestamp: ${
</a><a href="#h2-2-80" id="h2-2-80" class="i">+                                        SimpleDateFormat.getDateTimeInstance().format(
</a><a href="#h2-2-81" id="h2-2-81" class="i">+                                            Date(arroyoMessage.readTimestamp)
</a><a href="#h2-2-82" id="h2-2-82" class="i">+                                        )} (${arroyoMessage.readTimestamp})\n&quot;)
</a><a href="#h2-2-83" id="h2-2-83" class="i">+                                    append(&quot;ml_deleted: ${messageLogger.isMessageDeleted(arroyoMessage.clientConversationId!!, arroyoMessage.clientMessageId.toLong())}, &quot;)
</a><a href="#h2-2-84" id="h2-2-84" class="i">+                                    append(&quot;ml_stored: ${messageLogger.getMessageObject(arroyoMessage.clientConversationId!!, arroyoMessage.clientMessageId.toLong()) != null}\n&quot;)
</a><a href="#h2-2-85" id="h2-2-85" class="i">+                                }
</a><a href="#h2-2-86" id="h2-2-86" class="i">+                            }.toString()
</a><a href="#h2-2-87" id="h2-2-87" class="i">+                        )
</a><a href="#h2-2-88" id="h2-2-88" class="i">+                    }) {
</a><a href="#h2-2-89" id="h2-2-89" class="i">+                        Text(&quot;Info&quot;)
</a><a href="#h2-2-90" id="h2-2-90" class="i">+                    }
</a><a href="#h2-2-91" id="h2-2-91" class="i">+                    Button(onClick = {
</a><a href="#h2-2-92" id="h2-2-92" class="i">+                        val arroyoMessage = lastFocusedMessage ?: return@Button
</a><a href="#h2-2-93" id="h2-2-93" class="i">+                        messaging.conversationManager?.fetchMessage(arroyoMessage.clientConversationId!!, arroyoMessage.clientMessageId.toLong(), onSuccess = { message -&gt;
</a><a href="#h2-2-94" id="h2-2-94" class="i">+                            val decodedAttachments = MessageDecoder.decode(message.messageContent!!)
</a><a href="#h2-2-95" id="h2-2-95" class="i">+                            debugAlertDialog(
</a><a href="#h2-2-96" id="h2-2-96" class="i">+                                context,
</a><a href="#h2-2-97" id="h2-2-97" class="i">+                                &quot;Media References&quot;,
</a><a href="#h2-2-98" id="h2-2-98" class="i">+                                decodedAttachments.mapIndexed { index, attachment -&gt;
</a><a href="#h2-2-99" id="h2-2-99" class="i">+                                    StringBuilder().apply {
</a><a href="#h2-2-100" id="h2-2-100" class="i">+                                        append(&quot;---- media $index ----\n&quot;)
</a><a href="#h2-2-101" id="h2-2-101" class="i">+                                        append(&quot;resolveProto: ${attachment.mediaUrlKey}\n&quot;)
</a><a href="#h2-2-102" id="h2-2-102" class="i">+                                        append(&quot;type: ${attachment.type}\n&quot;)
</a><a href="#h2-2-103" id="h2-2-103" class="i">+                                        attachment.attachmentInfo?.apply {
</a><a href="#h2-2-104" id="h2-2-104" class="i">+                                            encryption?.let {
</a><a href="#h2-2-105" id="h2-2-105" class="i">+                                                append(&quot;encryption:\n  - key: ${it.key}\n  - iv: ${it.iv}\n&quot;)
</a><a href="#h2-2-106" id="h2-2-106" class="i">+                                            }
</a><a href="#h2-2-107" id="h2-2-107" class="i">+                                            resolution?.let {
</a><a href="#h2-2-108" id="h2-2-108" class="i">+                                                append(&quot;resolution: ${it.first}x${it.second}\n&quot;)
</a><a href="#h2-2-109" id="h2-2-109" class="i">+                                            }
</a><a href="#h2-2-110" id="h2-2-110" class="i">+                                            duration?.let {
</a><a href="#h2-2-111" id="h2-2-111" class="i">+                                                append(&quot;duration: $it\n&quot;)
</a><a href="#h2-2-112" id="h2-2-112" class="i">+                                            }
</a><a href="#h2-2-113" id="h2-2-113" class="i">+                                        }
</a><a href="#h2-2-114" id="h2-2-114" class="i">+                                        runCatching {
</a><a href="#h2-2-115" id="h2-2-115" class="i">+                                            val mediaHeaders = RemoteMediaResolver.getMediaHeaders(
</a><a href="#h2-2-116" id="h2-2-116" class="i">+                                                Base64.UrlSafe.decode(attachment.mediaUrlKey ?: return@runCatching))
</a><a href="#h2-2-117" id="h2-2-117" class="i">+                                            append(&quot;content-type: ${mediaHeaders[&quot;content-type&quot;]}\n&quot;)
</a><a href="#h2-2-118" id="h2-2-118" class="i">+                                            append(&quot;content-length: ${Formatter.formatShortFileSize(context, mediaHeaders[&quot;content-length&quot;]?.toLongOrNull() ?: 0)}\n&quot;)
</a><a href="#h2-2-119" id="h2-2-119" class="i">+                                            append(&quot;creation-date: ${mediaHeaders[&quot;last-modified&quot;]}\n&quot;)
</a><a href="#h2-2-120" id="h2-2-120" class="i">+                                        }
</a><a href="#h2-2-121" id="h2-2-121" class="i">+                                    }.toString()
</a><a href="#h2-2-122" id="h2-2-122" class="i">+                                }.joinToString(&quot;\n\n&quot;)
</a><a href="#h2-2-123" id="h2-2-123" class="i">+                            )
</a><a href="#h2-2-124" id="h2-2-124" class="i">+                        })
</a><a href="#h2-2-125" id="h2-2-125" class="i">+                    }) {
</a><a href="#h2-2-126" id="h2-2-126" class="i">+                        Text(&quot;Refs&quot;)
</a><a href="#h2-2-127" id="h2-2-127" class="i">+                    }
</a><a href="#h2-2-128" id="h2-2-128" class="i">+                    Button(onClick = {
</a><a href="#h2-2-129" id="h2-2-129" class="i">+                        val message = lastFocusedMessage ?: return@Button
</a><a href="#h2-2-130" id="h2-2-130" class="i">+                        debugAlertDialog(
</a><a href="#h2-2-131" id="h2-2-131" class="i">+                            context,
</a><a href="#h2-2-132" id="h2-2-132" class="i">+                            &quot;Arroyo proto&quot;,
</a><a href="#h2-2-133" id="h2-2-133" class="i">+                            message.messageContent?.let { ProtoReader(it) }?.toString() ?: &quot;empty&quot;
</a><a href="#h2-2-134" id="h2-2-134" class="i">+                        )
</a><a href="#h2-2-135" id="h2-2-135" class="i">+                    }) {
</a><a href="#h2-2-136" id="h2-2-136" class="i">+                        Text(&quot;Arroyo&quot;)
</a><a href="#h2-2-137" id="h2-2-137" class="i">+                    }
</a><a href="#h2-2-138" id="h2-2-138" class="i">+                    Button(onClick = {
</a><a href="#h2-2-139" id="h2-2-139" class="i">+                        val arroyoMessage = lastFocusedMessage ?: return@Button
</a><a href="#h2-2-140" id="h2-2-140" class="i">+                        messaging.conversationManager?.fetchMessage(arroyoMessage.clientConversationId!!, arroyoMessage.clientMessageId.toLong(), onSuccess = { message -&gt;
</a><a href="#h2-2-141" id="h2-2-141" class="i">+                            debugAlertDialog(
</a><a href="#h2-2-142" id="h2-2-142" class="i">+                                context,
</a><a href="#h2-2-143" id="h2-2-143" class="i">+                                &quot;Message proto&quot;,
</a><a href="#h2-2-144" id="h2-2-144" class="i">+                                message.messageContent?.content?.let { ProtoReader(it) }?.toString() ?: &quot;empty&quot;
</a><a href="#h2-2-145" id="h2-2-145" class="i">+                            )
</a><a href="#h2-2-146" id="h2-2-146" class="i">+                        }, onError = {
</a><a href="#h2-2-147" id="h2-2-147" class="i">+                            this@NewChatActionMenu.context.shortToast(&quot;Failed to fetch message: $it&quot;)
</a><a href="#h2-2-148" id="h2-2-148" class="i">+                        })
</a><a href="#h2-2-149" id="h2-2-149" class="i">+                    }) {
</a><a href="#h2-2-150" id="h2-2-150" class="i">+                        Text(&quot;Message&quot;)
</a><a href="#h2-2-151" id="h2-2-151" class="i">+                    }
</a><a href="#h2-2-152" id="h2-2-152" class="i">+                }
</a><a href="#h2-2-153" id="h2-2-153" class="i">+            }
</a><a href="#h2-2-154" id="h2-2-154" class="i">+        }
</a><a href="#h2-2-155" id="h2-2-155" class="i">+    }
</a><a href="#h2-2-156" id="h2-2-156" class="i">+
</a>     fun handle(event: AddViewEvent) {
         if (event.parent is LinearLayout) return
         val closeActionMenu = { event.parent.iterateParent {
<a href="#h2-3" id="h2-3" class="h">@@ -149,9 +292,10 @@ class NewChatActionMenu : AbstractMenu() {
</a>                 addView(composeView)
                 composeView.post {
                     (event.parent.layoutParams as ViewGroup.MarginLayoutParams).apply {
<a href="#h2-3-3" id="h2-3-3" class="d">-                        setObjectField(&quot;a&quot;, null) // remove drag callback
</a>                         if (height &lt; composeView.measuredHeight) {
                             height += composeView.measuredHeight
<a href="#h2-3-6" id="h2-3-6" class="i">+                        } else {
</a><a href="#h2-3-7" id="h2-3-7" class="i">+                            setObjectField(&quot;a&quot;, null) // remove drag callback
</a>                         }
                     }
                     event.parent.requestLayout()
</pre>
</div>
</body>
</html>
