<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>fix(messagelogger): message unique identifier - refactor bridge - developer mode (shows additional info about messages) - add ability to see deleted messages in ff preview - fix notification username - SnapEnhance - An Xposed module offering an enhanced Snapchat experience
</title>
<link rel="icon" type="image/svg+xml" href="../../logo.png"/>
<link rel="alternate icon" href="../../favicon.png"/>
<link rel="alternate" type="application/atom+xml" title="SnapEnhance Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="SnapEnhance Atom Feed (tags)" href="../tags.xml" />
<link rel="stylesheet" type="text/css" href="../../style.css" />
<link rel="stylesheet" type="text/css" href="../../fonts.css" />
</head>
<body>
<div id="head"><table><tr><td><a class="logo" href="../../"><img src="../../logo.png" alt="" width="32" height="32" /></a></td><td><strong>SnapEnhance</strong><span class="desc"> - An Xposed module offering an enhanced Snapchat experience
</span>
</td></tr></table>
<p><a href="../about.html">About</a> | <a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/LICENSE.html">License</a></p>
</div>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/1e2c71403e2535db4293a9cb4686fc4bf63de09f.html">1e2c71403e2535db4293a9cb4686fc4bf63de09f</a>
<b>parent</b> <a href="../commit/476de8dc38b04fef5435d5e4c1559e52a26c0793.html">476de8dc38b04fef5435d5e4c1559e52a26c0793</a>
<b>Author:</b> rhunk &lt;<a href="mailto:101876869+rhunk@users.noreply.github.com">101876869+rhunk@users.noreply.github.com</a>&gt;
<b>Date:</b>   Sat, 30 Sep 2023 16:08:05 +0200

fix(messagelogger): message unique identifier
- refactor bridge
- developer mode (shows additional info about messages)
- add ability to see deleted messages in ff preview
- fix notification username

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">app/src/main/kotlin/me/rhunk/snapenhance/bridge/BridgeService.kt</a></td><td> | </td><td class="num">14</td><td><span class="i">+</span><span class="d">-------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">core/src/main/aidl/me/rhunk/snapenhance/bridge/BridgeInterface.aidl</a></td><td> | </td><td class="num">24</td><td><span class="i">+++</span><span class="d">---------------------</span></td></tr>
<tr><td class="A">A</td><td><a href="#h2">core/src/main/aidl/me/rhunk/snapenhance/bridge/MessageLoggerInterface.aidl</a></td><td> | </td><td class="num">25</td><td><span class="i">+++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h3">core/src/main/assets/lang/en_US.json</a></td><td> | </td><td class="num">4</td><td><span class="i">++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h4">core/src/main/kotlin/me/rhunk/snapenhance/Constants.kt</a></td><td> | </td><td class="num">1</td><td><span class="i"></span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h5">core/src/main/kotlin/me/rhunk/snapenhance/ModContext.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h6">core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/BridgeClient.kt</a></td><td> | </td><td class="num">10</td><td><span class="i">++</span><span class="d">--------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h7">core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/wrapper/MessageLoggerWrapper.kt</a></td><td> | </td><td class="num">65</td><td><span class="i">+++++++++++++++++++++++++++++++++++++</span><span class="d">----------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h8">core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/Scripting.kt</a></td><td> | </td><td class="num">1</td><td><span class="i">+</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h9">core/src/main/kotlin/me/rhunk/snapenhance/core/database/objects/ConversationMessage.kt</a></td><td> | </td><td class="num">7</td><td><span class="i"></span><span class="d">-------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h10">core/src/main/kotlin/me/rhunk/snapenhance/data/SnapEnums.kt</a></td><td> | </td><td class="num">16</td><td><span class="i">++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h11">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/MediaDownloader.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h12">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/experiments/EndToEndEncryption.kt</a></td><td> | </td><td class="num">1</td><td><span class="i"></span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h13">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/spying/MessageLogger.kt</a></td><td> | </td><td class="num">93</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++</span><span class="d">------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h14">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/AutoSave.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h15">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/Notifications.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h16">core/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/ChatActionMenu.kt</a></td><td> | </td><td class="num">145</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">----------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h17">core/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/FriendFeedInfoMenu.kt</a></td><td> | </td><td class="num">36</td><td><span class="i">++++++++++++++++++++</span><span class="d">----------------</span></td></tr>
</table></pre><pre>18 files changed, 282 insertions(+), 168 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/BridgeService.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/BridgeService.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/BridgeService.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/BridgeService.kt</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -109,19 +109,6 @@ class BridgeService : Service() {
</a>             }
         }
 
<a href="#h0-0-3" id="h0-0-3" class="d">-        override fun getLoggedMessageIds(conversationId: String, limit: Int) =
</a><a href="#h0-0-4" id="h0-0-4" class="d">-            messageLoggerWrapper.getMessageIds(conversationId, limit).toLongArray()
</a><a href="#h0-0-5" id="h0-0-5" class="d">-
</a><a href="#h0-0-6" id="h0-0-6" class="d">-        override fun getMessageLoggerMessage(conversationId: String, id: Long) =
</a><a href="#h0-0-7" id="h0-0-7" class="d">-            messageLoggerWrapper.getMessage(conversationId, id).second
</a><a href="#h0-0-8" id="h0-0-8" class="d">-
</a><a href="#h0-0-9" id="h0-0-9" class="d">-        override fun addMessageLoggerMessage(conversationId: String, id: Long, message: ByteArray) {
</a><a href="#h0-0-10" id="h0-0-10" class="d">-            messageLoggerWrapper.addMessage(conversationId, id, message)
</a><a href="#h0-0-11" id="h0-0-11" class="d">-        }
</a><a href="#h0-0-12" id="h0-0-12" class="d">-
</a><a href="#h0-0-13" id="h0-0-13" class="d">-        override fun deleteMessageLoggerMessage(conversationId: String, id: Long) =
</a><a href="#h0-0-14" id="h0-0-14" class="d">-            messageLoggerWrapper.deleteMessage(conversationId, id)
</a><a href="#h0-0-15" id="h0-0-15" class="d">-
</a>         override fun getApplicationApkPath(): String = applicationInfo.publicSourceDir
 
         override fun fetchLocales(userLocale: String) =
<a href="#h0-1" id="h0-1" class="h">@@ -189,6 +176,7 @@ class BridgeService : Service() {
</a>         override fun getScriptingInterface() = remoteSideContext.scriptManager
 
         override fun getE2eeInterface() = remoteSideContext.e2eeImplementation
<a href="#h0-1-3" id="h0-1-3" class="i">+        override fun getMessageLogger() = messageLoggerWrapper
</a> 
         override fun openSettingsOverlay() {
             runCatching {
<b>diff --git a/<a id="h1" href="../file/core/src/main/aidl/me/rhunk/snapenhance/bridge/BridgeInterface.aidl.html">core/src/main/aidl/me/rhunk/snapenhance/bridge/BridgeInterface.aidl</a> b/<a href="../file/core/src/main/aidl/me/rhunk/snapenhance/bridge/BridgeInterface.aidl.html">core/src/main/aidl/me/rhunk/snapenhance/bridge/BridgeInterface.aidl</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -5,6 +5,7 @@ import me.rhunk.snapenhance.bridge.DownloadCallback;
</a> import me.rhunk.snapenhance.bridge.SyncCallback;
 import me.rhunk.snapenhance.bridge.scripting.IScripting;
 import me.rhunk.snapenhance.bridge.e2ee.E2eeInterface;
<a href="#h1-0-3" id="h1-0-3" class="i">+import me.rhunk.snapenhance.bridge.MessageLoggerInterface;
</a> 
 interface BridgeInterface {
     /**
<a href="#h1-1" id="h1-1" class="h">@@ -19,27 +20,6 @@ interface BridgeInterface {
</a>     byte[] fileOperation(int action, int fileType, in @nullable byte[] content);
 
     /**
<a href="#h1-1-3" id="h1-1-3" class="d">-     * Get the content of a logged message from the database
</a><a href="#h1-1-4" id="h1-1-4" class="d">-     * @return message ids that are logged
</a><a href="#h1-1-5" id="h1-1-5" class="d">-     */
</a><a href="#h1-1-6" id="h1-1-6" class="d">-    long[] getLoggedMessageIds(String conversationId, int limit);
</a><a href="#h1-1-7" id="h1-1-7" class="d">-
</a><a href="#h1-1-8" id="h1-1-8" class="d">-    /**
</a><a href="#h1-1-9" id="h1-1-9" class="d">-     * Get the content of a logged message from the database
</a><a href="#h1-1-10" id="h1-1-10" class="d">-     */
</a><a href="#h1-1-11" id="h1-1-11" class="d">-    @nullable byte[] getMessageLoggerMessage(String conversationId, long id);
</a><a href="#h1-1-12" id="h1-1-12" class="d">-
</a><a href="#h1-1-13" id="h1-1-13" class="d">-    /**
</a><a href="#h1-1-14" id="h1-1-14" class="d">-     * Add a message to the message logger database
</a><a href="#h1-1-15" id="h1-1-15" class="d">-     */
</a><a href="#h1-1-16" id="h1-1-16" class="d">-    void addMessageLoggerMessage(String conversationId, long id, in byte[] message);
</a><a href="#h1-1-17" id="h1-1-17" class="d">-
</a><a href="#h1-1-18" id="h1-1-18" class="d">-    /**
</a><a href="#h1-1-19" id="h1-1-19" class="d">-     * Delete a message from the message logger database
</a><a href="#h1-1-20" id="h1-1-20" class="d">-     */
</a><a href="#h1-1-21" id="h1-1-21" class="d">-    void deleteMessageLoggerMessage(String conversationId, long id);
</a><a href="#h1-1-22" id="h1-1-22" class="d">-
</a><a href="#h1-1-23" id="h1-1-23" class="d">-    /**
</a>     * Get the application APK path (assets for the conversation exporter)
     */
     String getApplicationApkPath();
<a href="#h1-2" id="h1-2" class="h">@@ -97,6 +77,8 @@ interface BridgeInterface {
</a> 
     E2eeInterface getE2eeInterface();
 
<a href="#h1-2-3" id="h1-2-3" class="i">+    MessageLoggerInterface getMessageLogger();
</a><a href="#h1-2-4" id="h1-2-4" class="i">+
</a>     void openSettingsOverlay();
 
     void closeSettingsOverlay();
<b>diff --git a/<a id="h2" href="../file/core/src/main/aidl/me/rhunk/snapenhance/bridge/MessageLoggerInterface.aidl.html">core/src/main/aidl/me/rhunk/snapenhance/bridge/MessageLoggerInterface.aidl</a> b/<a href="../file/core/src/main/aidl/me/rhunk/snapenhance/bridge/MessageLoggerInterface.aidl.html">core/src/main/aidl/me/rhunk/snapenhance/bridge/MessageLoggerInterface.aidl</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -0,0 +1,24 @@
</a><a href="#h2-0-0" id="h2-0-0" class="i">+package me.rhunk.snapenhance.bridge;
</a><a href="#h2-0-1" id="h2-0-1" class="i">+
</a><a href="#h2-0-2" id="h2-0-2" class="i">+interface MessageLoggerInterface {
</a><a href="#h2-0-3" id="h2-0-3" class="i">+    /**
</a><a href="#h2-0-4" id="h2-0-4" class="i">+     * Get the ids of the messages that are logged
</a><a href="#h2-0-5" id="h2-0-5" class="i">+     * @return message ids that are logged
</a><a href="#h2-0-6" id="h2-0-6" class="i">+     */
</a><a href="#h2-0-7" id="h2-0-7" class="i">+    long[] getLoggedIds(in String[] conversationIds, int limit);
</a><a href="#h2-0-8" id="h2-0-8" class="i">+
</a><a href="#h2-0-9" id="h2-0-9" class="i">+    /**
</a><a href="#h2-0-10" id="h2-0-10" class="i">+     * Get the content of a logged message from the database
</a><a href="#h2-0-11" id="h2-0-11" class="i">+     */
</a><a href="#h2-0-12" id="h2-0-12" class="i">+    @nullable byte[] getMessage(String conversationId, long id);
</a><a href="#h2-0-13" id="h2-0-13" class="i">+
</a><a href="#h2-0-14" id="h2-0-14" class="i">+    /**
</a><a href="#h2-0-15" id="h2-0-15" class="i">+     * Add a message to the message logger database if it is not already there
</a><a href="#h2-0-16" id="h2-0-16" class="i">+     */
</a><a href="#h2-0-17" id="h2-0-17" class="i">+    boolean addMessage(String conversationId, long id, in byte[] message);
</a><a href="#h2-0-18" id="h2-0-18" class="i">+
</a><a href="#h2-0-19" id="h2-0-19" class="i">+    /**
</a><a href="#h2-0-20" id="h2-0-20" class="i">+     * Delete a message from the message logger database
</a><a href="#h2-0-21" id="h2-0-21" class="i">+     */
</a><a href="#h2-0-22" id="h2-0-22" class="i">+    void deleteMessage(String conversationId, long id);
</a><a href="#h2-0-23" id="h2-0-23" class="i">+}</a><a href="#h2-0-24" id="h2-0-24" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h3" href="../file/core/src/main/assets/lang/en_US.json.html">core/src/main/assets/lang/en_US.json</a> b/<a href="../file/core/src/main/assets/lang/en_US.json.html">core/src/main/assets/lang/en_US.json</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -548,6 +548,10 @@
</a>                 &quot;name&quot;: &quot;Scripting&quot;,
                 &quot;description&quot;: &quot;Run custom scripts to extend SnapEnhance&quot;,
                 &quot;properties&quot;: {
<a href="#h3-0-3" id="h3-0-3" class="i">+                    &quot;developer_mode&quot;: {
</a><a href="#h3-0-4" id="h3-0-4" class="i">+                        &quot;name&quot;: &quot;Developer Mode&quot;,
</a><a href="#h3-0-5" id="h3-0-5" class="i">+                        &quot;description&quot;: &quot;Shows debug info on Snapchat&#39;s UI&quot;
</a><a href="#h3-0-6" id="h3-0-6" class="i">+                    },
</a>                     &quot;module_folder&quot;: {
                         &quot;name&quot;: &quot;Module Folder&quot;,
                         &quot;description&quot;: &quot;The folder where the scripts are located&quot;
<b>diff --git a/<a id="h4" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/Constants.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/Constants.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/Constants.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/Constants.kt</a></b>
<a href="#h4-0" id="h4-0" class="h">@@ -4,7 +4,6 @@ object Constants {
</a>     const val SNAPCHAT_PACKAGE_NAME = &quot;com.snapchat.android&quot;
 
     val ARROYO_MEDIA_CONTAINER_PROTO_PATH = intArrayOf(4, 4)
<a href="#h4-0-3" id="h4-0-3" class="d">-    val ARROYO_STRING_CHAT_MESSAGE_PROTO = ARROYO_MEDIA_CONTAINER_PROTO_PATH + intArrayOf(2, 1)
</a> 
     const val USER_AGENT = &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36&quot;
 } 
\ No newline at end of file
<b>diff --git a/<a id="h5" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/ModContext.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/ModContext.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/ModContext.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/ModContext.kt</a></b>
<a href="#h5-0" id="h5-0" class="h">@@ -58,6 +58,8 @@ class ModContext {
</a>     val native = NativeLib()
     val scriptRuntime by lazy { CoreScriptRuntime(log, androidContext.classLoader) }
 
<a href="#h5-0-3" id="h5-0-3" class="i">+    val isDeveloper by lazy { config.scripting.developerMode.get() }
</a><a href="#h5-0-4" id="h5-0-4" class="i">+
</a>     fun &lt;T : Feature&gt; feature(featureClass: KClass&lt;T&gt;): T {
         return features.get(featureClass)!!
     }
<b>diff --git a/<a id="h6" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/BridgeClient.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/BridgeClient.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/BridgeClient.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/BridgeClient.kt</a></b>
<a href="#h6-0" id="h6-0" class="h">@@ -111,14 +111,6 @@ class BridgeClient(
</a> 
     fun isFileExists(fileType: BridgeFileType) = service.fileOperation(FileActionType.EXISTS.ordinal, fileType.value, null).isNotEmpty()
 
<a href="#h6-0-3" id="h6-0-3" class="d">-    fun getLoggedMessageIds(conversationId: String, limit: Int): LongArray = service.getLoggedMessageIds(conversationId, limit)
</a><a href="#h6-0-4" id="h6-0-4" class="d">-
</a><a href="#h6-0-5" id="h6-0-5" class="d">-    fun getMessageLoggerMessage(conversationId: String, id: Long): ByteArray? = service.getMessageLoggerMessage(conversationId, id)
</a><a href="#h6-0-6" id="h6-0-6" class="d">-
</a><a href="#h6-0-7" id="h6-0-7" class="d">-    fun addMessageLoggerMessage(conversationId: String, id: Long, message: ByteArray) = service.addMessageLoggerMessage(conversationId, id, message)
</a><a href="#h6-0-8" id="h6-0-8" class="d">-
</a><a href="#h6-0-9" id="h6-0-9" class="d">-    fun deleteMessageLoggerMessage(conversationId: String, id: Long) = service.deleteMessageLoggerMessage(conversationId, id)
</a><a href="#h6-0-10" id="h6-0-10" class="d">-
</a>     fun fetchLocales(userLocale: String) = service.fetchLocales(userLocale).map {
         LocalePair(it.key, it.value)
     }
<a href="#h6-1" id="h6-1" class="h">@@ -148,6 +140,8 @@ class BridgeClient(
</a> 
     fun getE2eeInterface(): E2eeInterface = service.getE2eeInterface()
 
<a href="#h6-1-3" id="h6-1-3" class="i">+    fun getMessageLogger() = service.messageLogger
</a><a href="#h6-1-4" id="h6-1-4" class="i">+
</a>     fun openSettingsOverlay() = service.openSettingsOverlay()
     fun closeSettingsOverlay() = service.closeSettingsOverlay()
 }
<b>diff --git a/<a id="h7" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/wrapper/MessageLoggerWrapper.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/wrapper/MessageLoggerWrapper.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/wrapper/MessageLoggerWrapper.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/wrapper/MessageLoggerWrapper.kt</a></b>
<a href="#h7-0" id="h7-0" class="h">@@ -2,14 +2,15 @@ package me.rhunk.snapenhance.core.bridge.wrapper
</a> 
 import android.content.ContentValues
 import android.database.sqlite.SQLiteDatabase
<a href="#h7-0-3" id="h7-0-3" class="i">+import me.rhunk.snapenhance.bridge.MessageLoggerInterface
</a> import me.rhunk.snapenhance.core.util.SQLiteDatabaseHelper
 import java.io.File
<a href="#h7-0-6" id="h7-0-6" class="i">+import java.util.UUID
</a> 
 class MessageLoggerWrapper(
     private val databaseFile: File
<a href="#h7-0-10" id="h7-0-10" class="d">-) {
</a><a href="#h7-0-11" id="h7-0-11" class="d">-
</a><a href="#h7-0-12" id="h7-0-12" class="d">-    lateinit var database: SQLiteDatabase
</a><a href="#h7-0-13" id="h7-0-13" class="i">+): MessageLoggerInterface.Stub() {
</a><a href="#h7-0-14" id="h7-0-14" class="i">+    private lateinit var database: SQLiteDatabase
</a> 
     fun init() {
         database = SQLiteDatabase.openDatabase(databaseFile.absolutePath, null, SQLiteDatabase.CREATE_IF_NECESSARY or SQLiteDatabase.OPEN_READWRITE)
<a href="#h7-1" id="h7-1" class="h">@@ -23,11 +24,37 @@ class MessageLoggerWrapper(
</a>         ))
     }
 
<a href="#h7-1-3" id="h7-1-3" class="d">-    fun deleteMessage(conversationId: String, messageId: Long) {
</a><a href="#h7-1-4" id="h7-1-4" class="d">-        database.execSQL(&quot;DELETE FROM messages WHERE conversation_id = ? AND message_id = ?&quot;, arrayOf(conversationId, messageId.toString()))
</a><a href="#h7-1-5" id="h7-1-5" class="i">+    override fun getLoggedIds(conversationId: Array&lt;String&gt;, limit: Int): LongArray {
</a><a href="#h7-1-6" id="h7-1-6" class="i">+        if (conversationId.any {
</a><a href="#h7-1-7" id="h7-1-7" class="i">+            runCatching { UUID.fromString(it) }.isFailure
</a><a href="#h7-1-8" id="h7-1-8" class="i">+        }) return longArrayOf()
</a><a href="#h7-1-9" id="h7-1-9" class="i">+
</a><a href="#h7-1-10" id="h7-1-10" class="i">+        val cursor = database.rawQuery(&quot;SELECT message_id FROM messages WHERE conversation_id IN (${
</a><a href="#h7-1-11" id="h7-1-11" class="i">+            conversationId.joinToString(
</a><a href="#h7-1-12" id="h7-1-12" class="i">+                &quot;,&quot;
</a><a href="#h7-1-13" id="h7-1-13" class="i">+            ) { &quot;&#39;$it&#39;&quot; }
</a><a href="#h7-1-14" id="h7-1-14" class="i">+        }) ORDER BY message_id DESC LIMIT $limit&quot;, null)
</a><a href="#h7-1-15" id="h7-1-15" class="i">+
</a><a href="#h7-1-16" id="h7-1-16" class="i">+        val ids = mutableListOf&lt;Long&gt;()
</a><a href="#h7-1-17" id="h7-1-17" class="i">+        while (cursor.moveToNext()) {
</a><a href="#h7-1-18" id="h7-1-18" class="i">+            ids.add(cursor.getLong(0))
</a><a href="#h7-1-19" id="h7-1-19" class="i">+        }
</a><a href="#h7-1-20" id="h7-1-20" class="i">+        cursor.close()
</a><a href="#h7-1-21" id="h7-1-21" class="i">+        return ids.toLongArray()
</a>     }
 
<a href="#h7-1-24" id="h7-1-24" class="d">-    fun addMessage(conversationId: String, messageId: Long, serializedMessage: ByteArray): Boolean {
</a><a href="#h7-1-25" id="h7-1-25" class="i">+    override fun getMessage(conversationId: String?, id: Long): ByteArray? {
</a><a href="#h7-1-26" id="h7-1-26" class="i">+        val cursor = database.rawQuery(&quot;SELECT message_data FROM messages WHERE conversation_id = ? AND message_id = ?&quot;, arrayOf(conversationId, id.toString()))
</a><a href="#h7-1-27" id="h7-1-27" class="i">+        val message: ByteArray? = if (cursor.moveToFirst()) {
</a><a href="#h7-1-28" id="h7-1-28" class="i">+            cursor.getBlob(0)
</a><a href="#h7-1-29" id="h7-1-29" class="i">+        } else {
</a><a href="#h7-1-30" id="h7-1-30" class="i">+            null
</a><a href="#h7-1-31" id="h7-1-31" class="i">+        }
</a><a href="#h7-1-32" id="h7-1-32" class="i">+        cursor.close()
</a><a href="#h7-1-33" id="h7-1-33" class="i">+        return message
</a><a href="#h7-1-34" id="h7-1-34" class="i">+    }
</a><a href="#h7-1-35" id="h7-1-35" class="i">+
</a><a href="#h7-1-36" id="h7-1-36" class="i">+    override fun addMessage(conversationId: String, messageId: Long, serializedMessage: ByteArray): Boolean {
</a>         val cursor = database.rawQuery(&quot;SELECT message_id FROM messages WHERE conversation_id = ? AND message_id = ?&quot;, arrayOf(conversationId, messageId.toString()))
         val state = cursor.moveToFirst()
         cursor.close()
<a href="#h7-2" id="h7-2" class="h">@@ -42,29 +69,11 @@ class MessageLoggerWrapper(
</a>         return true
     }
 
<a href="#h7-2-3" id="h7-2-3" class="d">-    fun getMessage(conversationId: String, messageId: Long): Pair&lt;Boolean, ByteArray?&gt; {
</a><a href="#h7-2-4" id="h7-2-4" class="d">-        val cursor = database.rawQuery(&quot;SELECT message_data FROM messages WHERE conversation_id = ? AND message_id = ?&quot;, arrayOf(conversationId, messageId.toString()))
</a><a href="#h7-2-5" id="h7-2-5" class="d">-        val state = cursor.moveToFirst()
</a><a href="#h7-2-6" id="h7-2-6" class="d">-        val message: ByteArray? = if (state) {
</a><a href="#h7-2-7" id="h7-2-7" class="d">-            cursor.getBlob(0)
</a><a href="#h7-2-8" id="h7-2-8" class="d">-        } else {
</a><a href="#h7-2-9" id="h7-2-9" class="d">-            null
</a><a href="#h7-2-10" id="h7-2-10" class="d">-        }
</a><a href="#h7-2-11" id="h7-2-11" class="d">-        cursor.close()
</a><a href="#h7-2-12" id="h7-2-12" class="d">-        return Pair(state, message)
</a><a href="#h7-2-13" id="h7-2-13" class="d">-    }
</a><a href="#h7-2-14" id="h7-2-14" class="d">-
</a><a href="#h7-2-15" id="h7-2-15" class="d">-    fun getMessageIds(conversationId: String, limit: Int): List&lt;Long&gt; {
</a><a href="#h7-2-16" id="h7-2-16" class="d">-        val cursor = database.rawQuery(&quot;SELECT message_id FROM messages WHERE conversation_id = ? ORDER BY message_id DESC LIMIT ?&quot;, arrayOf(conversationId, limit.toString()))
</a><a href="#h7-2-17" id="h7-2-17" class="d">-        val messageIds = mutableListOf&lt;Long&gt;()
</a><a href="#h7-2-18" id="h7-2-18" class="d">-        while (cursor.moveToNext()) {
</a><a href="#h7-2-19" id="h7-2-19" class="d">-            messageIds.add(cursor.getLong(0))
</a><a href="#h7-2-20" id="h7-2-20" class="d">-        }
</a><a href="#h7-2-21" id="h7-2-21" class="d">-        cursor.close()
</a><a href="#h7-2-22" id="h7-2-22" class="d">-        return messageIds
</a><a href="#h7-2-23" id="h7-2-23" class="d">-    }
</a><a href="#h7-2-24" id="h7-2-24" class="d">-
</a>     fun clearMessages() {
         database.execSQL(&quot;DELETE FROM messages&quot;)
     }
<a href="#h7-2-28" id="h7-2-28" class="i">+
</a><a href="#h7-2-29" id="h7-2-29" class="i">+    override fun deleteMessage(conversationId: String, messageId: Long) {
</a><a href="#h7-2-30" id="h7-2-30" class="i">+        database.execSQL(&quot;DELETE FROM messages WHERE conversation_id = ? AND message_id = ?&quot;, arrayOf(conversationId, messageId.toString()))
</a><a href="#h7-2-31" id="h7-2-31" class="i">+    }
</a> } 
\ No newline at end of file
<b>diff --git a/<a id="h8" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/Scripting.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/Scripting.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/Scripting.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/Scripting.kt</a></b>
<a href="#h8-0" id="h8-0" class="h">@@ -4,6 +4,7 @@ import me.rhunk.snapenhance.core.config.ConfigContainer
</a> import me.rhunk.snapenhance.core.config.ConfigFlag
 
 class Scripting : ConfigContainer() {
<a href="#h8-0-3" id="h8-0-3" class="i">+    val developerMode = boolean(&quot;developer_mode&quot;, false)
</a>     val moduleFolder = string(&quot;module_folder&quot;, &quot;modules&quot;) { addFlags(ConfigFlag.FOLDER)  }
     val hotReload = boolean(&quot;hot_reload&quot;, false)
 } 
\ No newline at end of file
<b>diff --git a/<a id="h9" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/database/objects/ConversationMessage.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/database/objects/ConversationMessage.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/database/objects/ConversationMessage.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/database/objects/ConversationMessage.kt</a></b>
<a href="#h9-0" id="h9-0" class="h">@@ -40,11 +40,4 @@ data class ConversationMessage(
</a>             senderId = getStringOrNull(&quot;sender_id&quot;)
         }
     }
<a href="#h9-0-3" id="h9-0-3" class="d">-
</a><a href="#h9-0-4" id="h9-0-4" class="d">-    fun getMessageAsString(): String? {
</a><a href="#h9-0-5" id="h9-0-5" class="d">-        return when (ContentType.fromId(contentType)) {
</a><a href="#h9-0-6" id="h9-0-6" class="d">-            ContentType.CHAT -&gt; messageContent?.let { ProtoReader(it).getString(*Constants.ARROYO_STRING_CHAT_MESSAGE_PROTO) }
</a><a href="#h9-0-7" id="h9-0-7" class="d">-            else -&gt; null
</a><a href="#h9-0-8" id="h9-0-8" class="d">-        }
</a><a href="#h9-0-9" id="h9-0-9" class="d">-    }
</a> }
<b>diff --git a/<a id="h10" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/data/SnapEnums.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/data/SnapEnums.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/data/SnapEnums.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/data/SnapEnums.kt</a></b>
<a href="#h10-0" id="h10-0" class="h">@@ -1,5 +1,7 @@
</a> package me.rhunk.snapenhance.data
 
<a href="#h10-0-2" id="h10-0-2" class="i">+import me.rhunk.snapenhance.core.util.protobuf.ProtoReader
</a><a href="#h10-0-3" id="h10-0-3" class="i">+
</a> enum class MessageState {
     PREPARING, SENDING, COMMITTED, FAILED, CANCELING
 }
<a href="#h10-1" id="h10-1" class="h">@@ -63,6 +65,20 @@ enum class ContentType(val id: Int) {
</a>         fun fromId(i: Int): ContentType {
             return values().firstOrNull { it.id == i } ?: UNKNOWN
         }
<a href="#h10-1-3" id="h10-1-3" class="i">+
</a><a href="#h10-1-4" id="h10-1-4" class="i">+        fun fromMessageContainer(protoReader: ProtoReader?): ContentType {
</a><a href="#h10-1-5" id="h10-1-5" class="i">+            if (protoReader == null) return UNKNOWN
</a><a href="#h10-1-6" id="h10-1-6" class="i">+            return when {
</a><a href="#h10-1-7" id="h10-1-7" class="i">+                protoReader.containsPath(2) -&gt; CHAT
</a><a href="#h10-1-8" id="h10-1-8" class="i">+                protoReader.containsPath(11) -&gt; SNAP
</a><a href="#h10-1-9" id="h10-1-9" class="i">+                protoReader.containsPath(6) -&gt; NOTE
</a><a href="#h10-1-10" id="h10-1-10" class="i">+                protoReader.containsPath(3) -&gt; EXTERNAL_MEDIA
</a><a href="#h10-1-11" id="h10-1-11" class="i">+                protoReader.containsPath(4) -&gt; STICKER
</a><a href="#h10-1-12" id="h10-1-12" class="i">+                protoReader.containsPath(5) -&gt; SHARE
</a><a href="#h10-1-13" id="h10-1-13" class="i">+                protoReader.containsPath(7) -&gt; EXTERNAL_MEDIA// story replies
</a><a href="#h10-1-14" id="h10-1-14" class="i">+                else -&gt; UNKNOWN
</a><a href="#h10-1-15" id="h10-1-15" class="i">+            }
</a><a href="#h10-1-16" id="h10-1-16" class="i">+        }
</a>     }
 }
 
<b>diff --git a/<a id="h11" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/MediaDownloader.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/MediaDownloader.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/MediaDownloader.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/MediaDownloader.kt</a></b>
<a href="#h11-0" id="h11-0" class="h">@@ -526,7 +526,7 @@ class MediaDownloader : MessagingRuleFeature(&quot;MediaDownloader&quot;, MessagingRuleTyp
</a>         val friendInfo: FriendInfo = context.database.getFriendInfo(message.senderId!!) ?: throw Exception(&quot;Friend not found in database&quot;)
         val authorName = friendInfo.usernameForSorting!!
 
<a href="#h11-0-3" id="h11-0-3" class="d">-        val decodedAttachments = messageLogger.getMessageObject(message.clientConversationId!!, message.serverMessageId.toLong())?.let {
</a><a href="#h11-0-4" id="h11-0-4" class="i">+        val decodedAttachments = messageLogger.takeIf { it.isEnabled }?.getMessageObject(message.clientConversationId!!, message.clientMessageId.toLong())?.let {
</a>             MessageDecoder.decode(it.getAsJsonObject(&quot;mMessageContent&quot;))
         } ?: MessageDecoder.decode(
             protoReader = ProtoReader(message.messageContent!!)
<b>diff --git a/<a id="h12" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/experiments/EndToEndEncryption.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/experiments/EndToEndEncryption.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/experiments/EndToEndEncryption.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/experiments/EndToEndEncryption.kt</a></b>
<a href="#h12-0" id="h12-0" class="h">@@ -284,7 +284,6 @@ class EndToEndEncryption : MessagingRuleFeature(
</a> 
             if (messageTypeId == ENCRYPTED_MESSAGE_ID) {
                 runCatching {
<a href="#h12-0-3" id="h12-0-3" class="d">-                    replaceMessageText(&quot;Cannot find a key to decrypt this message.&quot;)
</a>                     eachBuffer(2) {
                         val participantIdHash = getByteArray(1) ?: return@eachBuffer
                         val iv = getByteArray(2) ?: return@eachBuffer
<b>diff --git a/<a id="h13" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/spying/MessageLogger.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/spying/MessageLogger.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/spying/MessageLogger.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/spying/MessageLogger.kt</a></b>
<a href="#h13-0" id="h13-0" class="h">@@ -8,6 +8,7 @@ import android.os.DeadObjectException
</a> import com.google.gson.JsonObject
 import com.google.gson.JsonParser
 import me.rhunk.snapenhance.core.event.events.impl.BindViewEvent
<a href="#h13-0-3" id="h13-0-3" class="i">+import me.rhunk.snapenhance.core.util.protobuf.ProtoReader
</a> import me.rhunk.snapenhance.data.ContentType
 import me.rhunk.snapenhance.data.MessageState
 import me.rhunk.snapenhance.data.wrapper.impl.Message
<a href="#h13-1" id="h13-1" class="h">@@ -39,39 +40,55 @@ class MessageLogger : Feature(&quot;MessageLogger&quot;,
</a>         const val DELETED_MESSAGE_COLOR = 0x2Eb71c1c
     }
 
<a href="#h13-1-3" id="h13-1-3" class="d">-    private val isEnabled get() = context.config.messaging.messageLogger.get()
</a><a href="#h13-1-4" id="h13-1-4" class="i">+    private val messageLoggerInterface by lazy { context.bridgeClient.getMessageLogger() }
</a><a href="#h13-1-5" id="h13-1-5" class="i">+
</a><a href="#h13-1-6" id="h13-1-6" class="i">+    val isEnabled get() = context.config.messaging.messageLogger.get()
</a> 
     private val threadPool = Executors.newFixedThreadPool(10)
 
<a href="#h13-1-10" id="h13-1-10" class="d">-    //two level of cache to avoid querying the database
</a><a href="#h13-1-11" id="h13-1-11" class="d">-    private val fetchedMessages = mutableListOf&lt;Long&gt;()
</a><a href="#h13-1-12" id="h13-1-12" class="d">-    private val deletedMessageCache = mutableMapOf&lt;Long, JsonObject&gt;()
</a><a href="#h13-1-13" id="h13-1-13" class="i">+    private val cachedIdLinks = mutableMapOf&lt;Long, Long&gt;() // client id -&gt; server id
</a><a href="#h13-1-14" id="h13-1-14" class="i">+    private val fetchedMessages = mutableListOf&lt;Long&gt;() // list of unique message ids
</a><a href="#h13-1-15" id="h13-1-15" class="i">+    private val deletedMessageCache = mutableMapOf&lt;Long, JsonObject&gt;() // unique message id -&gt; message json object
</a> 
<a href="#h13-1-17" id="h13-1-17" class="d">-    fun isMessageRemoved(conversationId: String, orderKey: Long) = deletedMessageCache.containsKey(computeMessageIdentifier(conversationId, orderKey))
</a><a href="#h13-1-18" id="h13-1-18" class="i">+    fun isMessageDeleted(conversationId: String, clientMessageId: Long)
</a><a href="#h13-1-19" id="h13-1-19" class="i">+        = makeUniqueIdentifier(conversationId, clientMessageId)?.let { deletedMessageCache.containsKey(it) } ?: false
</a> 
     fun deleteMessage(conversationId: String, clientMessageId: Long) {
<a href="#h13-1-22" id="h13-1-22" class="d">-        val serverMessageId = getServerMessageIdentifier(conversationId, clientMessageId) ?: return
</a><a href="#h13-1-23" id="h13-1-23" class="d">-        fetchedMessages.remove(serverMessageId)
</a><a href="#h13-1-24" id="h13-1-24" class="d">-        deletedMessageCache.remove(serverMessageId)
</a><a href="#h13-1-25" id="h13-1-25" class="d">-        context.bridgeClient.deleteMessageLoggerMessage(conversationId, serverMessageId)
</a><a href="#h13-1-26" id="h13-1-26" class="i">+        val uniqueMessageId = makeUniqueIdentifier(conversationId, clientMessageId) ?: return
</a><a href="#h13-1-27" id="h13-1-27" class="i">+        fetchedMessages.remove(uniqueMessageId)
</a><a href="#h13-1-28" id="h13-1-28" class="i">+        deletedMessageCache.remove(uniqueMessageId)
</a><a href="#h13-1-29" id="h13-1-29" class="i">+        messageLoggerInterface.deleteMessage(conversationId, uniqueMessageId)
</a>     }
 
<a href="#h13-1-32" id="h13-1-32" class="d">-    fun getMessageObject(conversationId: String, orderKey: Long): JsonObject? {
</a><a href="#h13-1-33" id="h13-1-33" class="d">-        val messageIdentifier = computeMessageIdentifier(conversationId, orderKey)
</a><a href="#h13-1-34" id="h13-1-34" class="d">-        if (deletedMessageCache.containsKey(messageIdentifier)) {
</a><a href="#h13-1-35" id="h13-1-35" class="d">-            return deletedMessageCache[messageIdentifier]
</a><a href="#h13-1-36" id="h13-1-36" class="i">+    fun getMessageObject(conversationId: String, clientMessageId: Long): JsonObject? {
</a><a href="#h13-1-37" id="h13-1-37" class="i">+        val uniqueMessageId = makeUniqueIdentifier(conversationId, clientMessageId) ?: return null
</a><a href="#h13-1-38" id="h13-1-38" class="i">+        if (deletedMessageCache.containsKey(uniqueMessageId)) {
</a><a href="#h13-1-39" id="h13-1-39" class="i">+            return deletedMessageCache[uniqueMessageId]
</a>         }
<a href="#h13-1-41" id="h13-1-41" class="d">-        return context.bridgeClient.getMessageLoggerMessage(conversationId, messageIdentifier)?.let {
</a><a href="#h13-1-42" id="h13-1-42" class="i">+        return messageLoggerInterface.getMessage(conversationId, uniqueMessageId)?.let {
</a>             JsonParser.parseString(it.toString(Charsets.UTF_8)).asJsonObject
         }
     }
 
<a href="#h13-1-47" id="h13-1-47" class="d">-    private fun computeMessageIdentifier(conversationId: String, orderKey: Long) = (orderKey.toString() + conversationId).longHashCode()
</a><a href="#h13-1-48" id="h13-1-48" class="d">-    private fun getServerMessageIdentifier(conversationId: String, clientMessageId: Long): Long? {
</a><a href="#h13-1-49" id="h13-1-49" class="d">-        val serverMessageId = context.database.getConversationMessageFromId(clientMessageId)?.serverMessageId?.toLong() ?: return run {
</a><a href="#h13-1-50" id="h13-1-50" class="d">-            context.log.error(&quot;Failed to get server message id for $conversationId $clientMessageId&quot;)
</a><a href="#h13-1-51" id="h13-1-51" class="d">-            null
</a><a href="#h13-1-52" id="h13-1-52" class="i">+    fun getMessageProto(conversationId: String, clientMessageId: Long): ProtoReader? {
</a><a href="#h13-1-53" id="h13-1-53" class="i">+        return getMessageObject(conversationId, clientMessageId)?.let { message -&gt;
</a><a href="#h13-1-54" id="h13-1-54" class="i">+            ProtoReader(message.getAsJsonObject(&quot;mMessageContent&quot;).getAsJsonArray(&quot;mContent&quot;)
</a><a href="#h13-1-55" id="h13-1-55" class="i">+                .map { it.asByte }
</a><a href="#h13-1-56" id="h13-1-56" class="i">+                .toByteArray())
</a>         }
<a href="#h13-1-58" id="h13-1-58" class="i">+    }
</a><a href="#h13-1-59" id="h13-1-59" class="i">+
</a><a href="#h13-1-60" id="h13-1-60" class="i">+    private fun computeMessageIdentifier(conversationId: String, orderKey: Long) = (orderKey.toString() + conversationId).longHashCode()
</a><a href="#h13-1-61" id="h13-1-61" class="i">+
</a><a href="#h13-1-62" id="h13-1-62" class="i">+    private fun makeUniqueIdentifier(conversationId: String, clientMessageId: Long): Long? {
</a><a href="#h13-1-63" id="h13-1-63" class="i">+        val serverMessageId = cachedIdLinks[clientMessageId] ?:
</a><a href="#h13-1-64" id="h13-1-64" class="i">+            context.database.getConversationMessageFromId(clientMessageId)?.serverMessageId?.toLong()?.also {
</a><a href="#h13-1-65" id="h13-1-65" class="i">+                cachedIdLinks[clientMessageId] = it
</a><a href="#h13-1-66" id="h13-1-66" class="i">+            }
</a><a href="#h13-1-67" id="h13-1-67" class="i">+            ?: return run {
</a><a href="#h13-1-68" id="h13-1-68" class="i">+                context.log.error(&quot;Failed to get server message id for $conversationId $clientMessageId&quot;)
</a><a href="#h13-1-69" id="h13-1-69" class="i">+                null
</a><a href="#h13-1-70" id="h13-1-70" class="i">+            }
</a>         return computeMessageIdentifier(conversationId, serverMessageId)
     }
 
<a href="#h13-2" id="h13-2" class="h">@@ -82,9 +99,9 @@ class MessageLogger : Feature(&quot;MessageLogger&quot;,
</a>         }
 
         measureTime {
<a href="#h13-2-3" id="h13-2-3" class="d">-            context.database.getFeedEntries(PREFETCH_FEED_COUNT).forEach { friendFeedInfo -&gt;
</a><a href="#h13-2-4" id="h13-2-4" class="d">-                fetchedMessages.addAll(context.bridgeClient.getLoggedMessageIds(friendFeedInfo.key!!, PREFETCH_MESSAGE_COUNT).toList())
</a><a href="#h13-2-5" id="h13-2-5" class="d">-            }
</a><a href="#h13-2-6" id="h13-2-6" class="i">+            val conversationIds = context.database.getFeedEntries(PREFETCH_FEED_COUNT).map { it.key!! }
</a><a href="#h13-2-7" id="h13-2-7" class="i">+            if (conversationIds.isEmpty()) return@measureTime
</a><a href="#h13-2-8" id="h13-2-8" class="i">+            fetchedMessages.addAll(messageLoggerInterface.getLoggedIds(conversationIds.toTypedArray(), PREFETCH_MESSAGE_COUNT).toList())
</a>         }.also { context.log.verbose(&quot;Loaded ${fetchedMessages.size} cached messages in $it&quot;) }
     }
 
<a href="#h13-3" id="h13-3" class="h">@@ -93,22 +110,20 @@ class MessageLogger : Feature(&quot;MessageLogger&quot;,
</a> 
         if (message.messageState != MessageState.COMMITTED) return
 
<a href="#h13-3-3" id="h13-3-3" class="i">+        cachedIdLinks[message.messageDescriptor.messageId] = message.orderKey
</a><a href="#h13-3-4" id="h13-3-4" class="i">+        val conversationId = message.messageDescriptor.conversationId.toString()
</a>         //exclude messages sent by me
         if (message.senderId.toString() == context.database.myUserId) return
 
<a href="#h13-3-8" id="h13-3-8" class="d">-        val conversationId = message.messageDescriptor.conversationId.toString()
</a><a href="#h13-3-9" id="h13-3-9" class="d">-        val serverIdentifier = computeMessageIdentifier(conversationId, message.orderKey)
</a><a href="#h13-3-10" id="h13-3-10" class="i">+        val uniqueMessageIdentifier = computeMessageIdentifier(conversationId, message.orderKey)
</a> 
         if (message.messageContent.contentType != ContentType.STATUS) {
<a href="#h13-3-13" id="h13-3-13" class="d">-            if (fetchedMessages.contains(serverIdentifier)) return
</a><a href="#h13-3-14" id="h13-3-14" class="d">-            fetchedMessages.add(serverIdentifier)
</a><a href="#h13-3-15" id="h13-3-15" class="i">+            if (fetchedMessages.contains(uniqueMessageIdentifier)) return
</a><a href="#h13-3-16" id="h13-3-16" class="i">+            fetchedMessages.add(uniqueMessageIdentifier)
</a> 
             threadPool.execute {
                 try {
<a href="#h13-3-20" id="h13-3-20" class="d">-                    context.bridgeClient.getMessageLoggerMessage(conversationId, serverIdentifier)?.let {
</a><a href="#h13-3-21" id="h13-3-21" class="d">-                        return@execute
</a><a href="#h13-3-22" id="h13-3-22" class="d">-                    }
</a><a href="#h13-3-23" id="h13-3-23" class="d">-                    context.bridgeClient.addMessageLoggerMessage(conversationId, serverIdentifier, context.gson.toJson(messageInstance).toByteArray(Charsets.UTF_8))
</a><a href="#h13-3-24" id="h13-3-24" class="i">+                    messageLoggerInterface.addMessage(conversationId, uniqueMessageIdentifier, context.gson.toJson(messageInstance).toByteArray(Charsets.UTF_8))
</a>                 } catch (ignored: DeadObjectException) {}
             }
 
<a href="#h13-4" id="h13-4" class="h">@@ -116,10 +131,10 @@ class MessageLogger : Feature(&quot;MessageLogger&quot;,
</a>         }
 
         //query the deleted message
<a href="#h13-4-3" id="h13-4-3" class="d">-        val deletedMessageObject: JsonObject = if (deletedMessageCache.containsKey(serverIdentifier))
</a><a href="#h13-4-4" id="h13-4-4" class="d">-            deletedMessageCache[serverIdentifier]
</a><a href="#h13-4-5" id="h13-4-5" class="i">+        val deletedMessageObject: JsonObject = if (deletedMessageCache.containsKey(uniqueMessageIdentifier))
</a><a href="#h13-4-6" id="h13-4-6" class="i">+            deletedMessageCache[uniqueMessageIdentifier]
</a>         else {
<a href="#h13-4-8" id="h13-4-8" class="d">-            context.bridgeClient.getMessageLoggerMessage(conversationId, serverIdentifier)?.let {
</a><a href="#h13-4-9" id="h13-4-9" class="i">+            messageLoggerInterface.getMessage(conversationId, uniqueMessageIdentifier)?.let {
</a>                 JsonParser.parseString(it.toString(Charsets.UTF_8)).asJsonObject
             }
         } ?: return
<a href="#h13-5" id="h13-5" class="h">@@ -134,19 +149,13 @@ class MessageLogger : Feature(&quot;MessageLogger&quot;,
</a>         //serialize all properties of messageJsonObject and put in the message object
         messageInstance.javaClass.declaredFields.forEach { field -&gt;
             field.isAccessible = true
<a href="#h13-5-3" id="h13-5-3" class="i">+            if (field.name == &quot;mDescriptor&quot;) return@forEach // prevent the client message id from being overwritten
</a>             messageJsonObject[field.name]?.let { fieldValue -&gt;
                 field.set(messageInstance, context.gson.fromJson(fieldValue, field.type))
             }
         }
 
<a href="#h13-5-9" id="h13-5-9" class="d">-        /*//set the message state to PREPARING for visibility
</a><a href="#h13-5-10" id="h13-5-10" class="d">-        with(message.messageContent.contentType) {
</a><a href="#h13-5-11" id="h13-5-11" class="d">-            if (this != ContentType.SNAP &amp;&amp; this != ContentType.EXTERNAL_MEDIA) {
</a><a href="#h13-5-12" id="h13-5-12" class="d">-                message.messageState = MessageState.PREPARING
</a><a href="#h13-5-13" id="h13-5-13" class="d">-            }
</a><a href="#h13-5-14" id="h13-5-14" class="d">-        }*/
</a><a href="#h13-5-15" id="h13-5-15" class="d">-
</a><a href="#h13-5-16" id="h13-5-16" class="d">-        deletedMessageCache[serverIdentifier] = deletedMessageObject
</a><a href="#h13-5-17" id="h13-5-17" class="i">+        deletedMessageCache[uniqueMessageIdentifier] = deletedMessageObject
</a>     }
 
     override fun init() {
<a href="#h13-6" id="h13-6" class="h">@@ -161,7 +170,7 @@ class MessageLogger : Feature(&quot;MessageLogger&quot;,
</a>         context.event.subscribe(BindViewEvent::class) { event -&gt;
             event.chatMessage { conversationId, messageId -&gt;
                 event.view.removeForegroundDrawable(&quot;deletedMessage&quot;)
<a href="#h13-6-3" id="h13-6-3" class="d">-                getServerMessageIdentifier(conversationId, messageId.toLong())?.let { serverMessageId -&gt;
</a><a href="#h13-6-4" id="h13-6-4" class="i">+                makeUniqueIdentifier(conversationId, messageId.toLong())?.let { serverMessageId -&gt;
</a>                     if (!deletedMessageCache.contains(serverMessageId)) return@chatMessage
                 } ?: return@chatMessage
 
<b>diff --git a/<a id="h14" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/AutoSave.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/AutoSave.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/AutoSave.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/AutoSave.kt</a></b>
<a href="#h14-0" id="h14-0" class="h">@@ -36,7 +36,7 @@ class AutoSave : MessagingRuleFeature(&quot;Auto Save&quot;, MessagingRuleType.AUTO_SAVE, 
</a> 
     private fun saveMessage(conversationId: SnapUUID, message: Message) {
         val messageId = message.messageDescriptor.messageId
<a href="#h14-0-3" id="h14-0-3" class="d">-        if (messageLogger.isMessageRemoved(conversationId.toString(), message.orderKey)) return
</a><a href="#h14-0-4" id="h14-0-4" class="i">+        if (messageLogger.takeIf { it.isEnabled }?.isMessageDeleted(conversationId.toString(), message.messageDescriptor.messageId) == true) return
</a>         if (message.messageState != MessageState.COMMITTED) return
 
         runCatching {
<b>diff --git a/<a id="h15" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/Notifications.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/Notifications.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/Notifications.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/Notifications.kt</a></b>
<a href="#h15-0" id="h15-0" class="h">@@ -220,7 +220,7 @@ class Notifications : Feature(&quot;Notifications&quot;, loadParams = FeatureLoadParams.IN
</a>                 val snapMessage = messages.firstOrNull { message -&gt; message.orderKey == messageId } ?: return
                 val senderUsername by lazy {
                     context.database.getFriendInfo(snapMessage.senderId.toString())?.let {
<a href="#h15-0-3" id="h15-0-3" class="d">-                        it.displayName ?: it.username
</a><a href="#h15-0-4" id="h15-0-4" class="i">+                        it.displayName ?: it.mutableUsername
</a>                     }
                 }
 
<b>diff --git a/<a id="h16" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/ChatActionMenu.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/ChatActionMenu.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/ChatActionMenu.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/ChatActionMenu.kt</a></b>
<a href="#h16-0" id="h16-0" class="h">@@ -1,6 +1,7 @@
</a> package me.rhunk.snapenhance.ui.menu.impl
 
 import android.annotation.SuppressLint
<a href="#h16-0-3" id="h16-0-3" class="i">+import android.content.Context
</a> import android.os.SystemClock
 import android.view.MotionEvent
 import android.view.View
<a href="#h16-1" id="h16-1" class="h">@@ -8,61 +9,58 @@ import android.view.ViewGroup
</a> import android.view.ViewGroup.MarginLayoutParams
 import android.widget.Button
 import android.widget.LinearLayout
<a href="#h16-1-3" id="h16-1-3" class="i">+import android.widget.TextView
</a> import me.rhunk.snapenhance.Constants
<a href="#h16-1-5" id="h16-1-5" class="i">+import me.rhunk.snapenhance.core.util.protobuf.ProtoReader
</a><a href="#h16-1-6" id="h16-1-6" class="i">+import me.rhunk.snapenhance.data.ContentType
</a> import me.rhunk.snapenhance.features.impl.Messaging
 import me.rhunk.snapenhance.features.impl.downloader.MediaDownloader
 import me.rhunk.snapenhance.features.impl.spying.MessageLogger
<a href="#h16-1-10" id="h16-1-10" class="i">+import me.rhunk.snapenhance.ui.ViewAppearanceHelper
</a> import me.rhunk.snapenhance.ui.ViewTagState
 import me.rhunk.snapenhance.ui.applyTheme
 import me.rhunk.snapenhance.ui.menu.AbstractMenu
<a href="#h16-1-14" id="h16-1-14" class="i">+import java.time.Instant
</a> 
 
<a href="#h16-1-17" id="h16-1-17" class="i">+@SuppressLint(&quot;DiscouragedApi&quot;)
</a> class ChatActionMenu : AbstractMenu() {
     private val viewTagState = ViewTagState()
 
<a href="#h16-1-21" id="h16-1-21" class="d">-    @SuppressLint(&quot;SetTextI18n&quot;, &quot;DiscouragedApi&quot;)
</a><a href="#h16-1-22" id="h16-1-22" class="d">-    fun inject(viewGroup: ViewGroup) {
</a><a href="#h16-1-23" id="h16-1-23" class="d">-        val parent = viewGroup.parent.parent as ViewGroup
</a><a href="#h16-1-24" id="h16-1-24" class="d">-        if (viewTagState[parent]) return
</a><a href="#h16-1-25" id="h16-1-25" class="d">-        //close the action menu using a touch event
</a><a href="#h16-1-26" id="h16-1-26" class="d">-        val closeActionMenu = {
</a><a href="#h16-1-27" id="h16-1-27" class="d">-            viewGroup.dispatchTouchEvent(
</a><a href="#h16-1-28" id="h16-1-28" class="d">-                MotionEvent.obtain(
</a><a href="#h16-1-29" id="h16-1-29" class="d">-                    SystemClock.uptimeMillis(),
</a><a href="#h16-1-30" id="h16-1-30" class="d">-                    SystemClock.uptimeMillis(),
</a><a href="#h16-1-31" id="h16-1-31" class="d">-                    MotionEvent.ACTION_DOWN,
</a><a href="#h16-1-32" id="h16-1-32" class="d">-                    0f,
</a><a href="#h16-1-33" id="h16-1-33" class="d">-                    0f,
</a><a href="#h16-1-34" id="h16-1-34" class="d">-                    0
</a><a href="#h16-1-35" id="h16-1-35" class="d">-                )
</a><a href="#h16-1-36" id="h16-1-36" class="d">-            )
</a><a href="#h16-1-37" id="h16-1-37" class="d">-        }
</a><a href="#h16-1-38" id="h16-1-38" class="d">-
</a><a href="#h16-1-39" id="h16-1-39" class="d">-        val defaultGap = viewGroup.resources.getDimensionPixelSize(
</a><a href="#h16-1-40" id="h16-1-40" class="d">-            viewGroup.resources.getIdentifier(
</a><a href="#h16-1-41" id="h16-1-41" class="i">+    private val defaultGap by lazy {
</a><a href="#h16-1-42" id="h16-1-42" class="i">+        context.androidContext.resources.getDimensionPixelSize(
</a><a href="#h16-1-43" id="h16-1-43" class="i">+            context.androidContext.resources.getIdentifier(
</a>                 &quot;default_gap&quot;,
                 &quot;dimen&quot;,
                 Constants.SNAPCHAT_PACKAGE_NAME
             )
         )
<a href="#h16-1-49" id="h16-1-49" class="i">+    }
</a> 
<a href="#h16-1-51" id="h16-1-51" class="d">-        val chatActionMenuItemMargin = viewGroup.resources.getDimensionPixelSize(
</a><a href="#h16-1-52" id="h16-1-52" class="d">-            viewGroup.resources.getIdentifier(
</a><a href="#h16-1-53" id="h16-1-53" class="i">+    private val chatActionMenuItemMargin by lazy {
</a><a href="#h16-1-54" id="h16-1-54" class="i">+        context.androidContext.resources.getDimensionPixelSize(
</a><a href="#h16-1-55" id="h16-1-55" class="i">+            context.androidContext.resources.getIdentifier(
</a>                 &quot;chat_action_menu_item_margin&quot;,
                 &quot;dimen&quot;,
                 Constants.SNAPCHAT_PACKAGE_NAME
             )
         )
<a href="#h16-1-61" id="h16-1-61" class="i">+    }
</a> 
<a href="#h16-1-63" id="h16-1-63" class="d">-        val actionMenuItemHeight = viewGroup.resources.getDimensionPixelSize(
</a><a href="#h16-1-64" id="h16-1-64" class="d">-            viewGroup.resources.getIdentifier(
</a><a href="#h16-1-65" id="h16-1-65" class="i">+    private val actionMenuItemHeight by lazy {
</a><a href="#h16-1-66" id="h16-1-66" class="i">+        context.androidContext.resources.getDimensionPixelSize(
</a><a href="#h16-1-67" id="h16-1-67" class="i">+            context.androidContext.resources.getIdentifier(
</a>                 &quot;action_menu_item_height&quot;,
                 &quot;dimen&quot;,
                 Constants.SNAPCHAT_PACKAGE_NAME
             )
         )
<a href="#h16-1-73" id="h16-1-73" class="i">+    }
</a><a href="#h16-1-74" id="h16-1-74" class="i">+
</a><a href="#h16-1-75" id="h16-1-75" class="i">+    private fun createContainer(viewGroup: ViewGroup): LinearLayout {
</a><a href="#h16-1-76" id="h16-1-76" class="i">+        val parent = viewGroup.parent.parent as ViewGroup
</a> 
<a href="#h16-1-78" id="h16-1-78" class="d">-        val buttonContainer = LinearLayout(viewGroup.context).apply layout@{
</a><a href="#h16-1-79" id="h16-1-79" class="i">+        return LinearLayout(viewGroup.context).apply layout@{
</a>             orientation = LinearLayout.VERTICAL
             layoutParams = MarginLayoutParams(
                 ViewGroup.LayoutParams.MATCH_PARENT,
<a href="#h16-2" id="h16-2" class="h">@@ -72,6 +70,45 @@ class ChatActionMenu : AbstractMenu() {
</a>                 setMargins(chatActionMenuItemMargin, 0, chatActionMenuItemMargin, defaultGap)
             }
         }
<a href="#h16-2-3" id="h16-2-3" class="i">+    }
</a><a href="#h16-2-4" id="h16-2-4" class="i">+
</a><a href="#h16-2-5" id="h16-2-5" class="i">+    private fun copyAlertDialog(context: Context, title: String, text: String) {
</a><a href="#h16-2-6" id="h16-2-6" class="i">+        ViewAppearanceHelper.newAlertDialogBuilder(context).apply {
</a><a href="#h16-2-7" id="h16-2-7" class="i">+            setTitle(title)
</a><a href="#h16-2-8" id="h16-2-8" class="i">+            setMessage(text)
</a><a href="#h16-2-9" id="h16-2-9" class="i">+            setPositiveButton(&quot;OK&quot;) { dialog, _ -&gt; dialog.dismiss() }
</a><a href="#h16-2-10" id="h16-2-10" class="i">+            setNegativeButton(&quot;Copy&quot;) { _, _ -&gt;
</a><a href="#h16-2-11" id="h16-2-11" class="i">+                val clipboardManager = context.getSystemService(Context.CLIPBOARD_SERVICE) as android.content.ClipboardManager
</a><a href="#h16-2-12" id="h16-2-12" class="i">+                clipboardManager.setPrimaryClip(android.content.ClipData.newPlainText(&quot;debug&quot;, text))
</a><a href="#h16-2-13" id="h16-2-13" class="i">+            }
</a><a href="#h16-2-14" id="h16-2-14" class="i">+        }.show()
</a><a href="#h16-2-15" id="h16-2-15" class="i">+    }
</a><a href="#h16-2-16" id="h16-2-16" class="i">+
</a><a href="#h16-2-17" id="h16-2-17" class="i">+    private val lastFocusedMessage
</a><a href="#h16-2-18" id="h16-2-18" class="i">+        get() = context.database.getConversationMessageFromId(context.feature(Messaging::class).lastFocusedMessageId)
</a><a href="#h16-2-19" id="h16-2-19" class="i">+
</a><a href="#h16-2-20" id="h16-2-20" class="i">+    @SuppressLint(&quot;SetTextI18n&quot;, &quot;DiscouragedApi&quot;, &quot;ClickableViewAccessibility&quot;)
</a><a href="#h16-2-21" id="h16-2-21" class="i">+    fun inject(viewGroup: ViewGroup) {
</a><a href="#h16-2-22" id="h16-2-22" class="i">+        val parent = viewGroup.parent.parent as? ViewGroup ?: return
</a><a href="#h16-2-23" id="h16-2-23" class="i">+        if (viewTagState[parent]) return
</a><a href="#h16-2-24" id="h16-2-24" class="i">+        //close the action menu using a touch event
</a><a href="#h16-2-25" id="h16-2-25" class="i">+        val closeActionMenu = {
</a><a href="#h16-2-26" id="h16-2-26" class="i">+            viewGroup.dispatchTouchEvent(
</a><a href="#h16-2-27" id="h16-2-27" class="i">+                MotionEvent.obtain(
</a><a href="#h16-2-28" id="h16-2-28" class="i">+                    SystemClock.uptimeMillis(),
</a><a href="#h16-2-29" id="h16-2-29" class="i">+                    SystemClock.uptimeMillis(),
</a><a href="#h16-2-30" id="h16-2-30" class="i">+                    MotionEvent.ACTION_DOWN,
</a><a href="#h16-2-31" id="h16-2-31" class="i">+                    0f,
</a><a href="#h16-2-32" id="h16-2-32" class="i">+                    0f,
</a><a href="#h16-2-33" id="h16-2-33" class="i">+                    0
</a><a href="#h16-2-34" id="h16-2-34" class="i">+                )
</a><a href="#h16-2-35" id="h16-2-35" class="i">+            )
</a><a href="#h16-2-36" id="h16-2-36" class="i">+        }
</a><a href="#h16-2-37" id="h16-2-37" class="i">+
</a><a href="#h16-2-38" id="h16-2-38" class="i">+        val messaging = context.feature(Messaging::class)
</a><a href="#h16-2-39" id="h16-2-39" class="i">+        val messageLogger = context.feature(MessageLogger::class)
</a><a href="#h16-2-40" id="h16-2-40" class="i">+
</a><a href="#h16-2-41" id="h16-2-41" class="i">+        val buttonContainer = createContainer(viewGroup)
</a> 
         val injectButton = { button: Button -&gt;
             if (buttonContainer.childCount &gt; 0) {
<a href="#h16-3" id="h16-3" class="h">@@ -125,14 +162,66 @@ class ChatActionMenu : AbstractMenu() {
</a>                 setOnClickListener {
                     closeActionMenu()
                     this@ChatActionMenu.context.executeAsync {
<a href="#h16-3-3" id="h16-3-3" class="d">-                        feature(Messaging::class).apply {
</a><a href="#h16-3-4" id="h16-3-4" class="d">-                            feature(MessageLogger::class).deleteMessage(openedConversationUUID.toString(), lastFocusedMessageId)
</a><a href="#h16-3-5" id="h16-3-5" class="d">-                        }
</a><a href="#h16-3-6" id="h16-3-6" class="i">+                        messageLogger.deleteMessage(messaging.openedConversationUUID.toString(), messaging.lastFocusedMessageId)
</a>                     }
                 }
             })
         }
 
<a href="#h16-3-12" id="h16-3-12" class="i">+        if (context.isDeveloper) {
</a><a href="#h16-3-13" id="h16-3-13" class="i">+            parent.addView(createContainer(viewGroup).apply {
</a><a href="#h16-3-14" id="h16-3-14" class="i">+                val debugText = StringBuilder()
</a><a href="#h16-3-15" id="h16-3-15" class="i">+
</a><a href="#h16-3-16" id="h16-3-16" class="i">+                setOnClickListener {
</a><a href="#h16-3-17" id="h16-3-17" class="i">+                    val clipboardManager = context.getSystemService(android.content.Context.CLIPBOARD_SERVICE) as android.content.ClipboardManager
</a><a href="#h16-3-18" id="h16-3-18" class="i">+                    clipboardManager.setPrimaryClip(android.content.ClipData.newPlainText(&quot;debug&quot;, debugText.toString()))
</a><a href="#h16-3-19" id="h16-3-19" class="i">+                }
</a><a href="#h16-3-20" id="h16-3-20" class="i">+
</a><a href="#h16-3-21" id="h16-3-21" class="i">+                addView(TextView(viewGroup.context).apply {
</a><a href="#h16-3-22" id="h16-3-22" class="i">+                    setPadding(20, 20, 20, 20)
</a><a href="#h16-3-23" id="h16-3-23" class="i">+                    textSize = 10f
</a><a href="#h16-3-24" id="h16-3-24" class="i">+                    addOnLayoutChangeListener { _, _, _, _, _, _, _, _, _ -&gt;
</a><a href="#h16-3-25" id="h16-3-25" class="i">+                        val arroyoMessage = lastFocusedMessage ?: return@addOnLayoutChangeListener
</a><a href="#h16-3-26" id="h16-3-26" class="i">+                        text = debugText.apply {
</a><a href="#h16-3-27" id="h16-3-27" class="i">+                            runCatching {
</a><a href="#h16-3-28" id="h16-3-28" class="i">+                                clear()
</a><a href="#h16-3-29" id="h16-3-29" class="i">+                                append(&quot;sender_id: ${arroyoMessage.senderId}\n&quot;)
</a><a href="#h16-3-30" id="h16-3-30" class="i">+                                append(&quot;client_id: ${arroyoMessage.clientMessageId}, server_id: ${arroyoMessage.serverMessageId}\n&quot;)
</a><a href="#h16-3-31" id="h16-3-31" class="i">+                                append(&quot;conversation_id: ${arroyoMessage.clientConversationId}\n&quot;)
</a><a href="#h16-3-32" id="h16-3-32" class="i">+                                append(&quot;arroyo_content_type: ${ContentType.fromId(arroyoMessage.contentType)} (${arroyoMessage.contentType})\n&quot;)
</a><a href="#h16-3-33" id="h16-3-33" class="i">+                                append(&quot;parsed_content_type: ${ContentType.fromMessageContainer(
</a><a href="#h16-3-34" id="h16-3-34" class="i">+                                    ProtoReader(arroyoMessage.messageContent!!).followPath(4, 4)
</a><a href="#h16-3-35" id="h16-3-35" class="i">+                                ).let { &quot;$it (${it.id})&quot; }}\n&quot;)
</a><a href="#h16-3-36" id="h16-3-36" class="i">+                                append(&quot;creation_timestamp: ${arroyoMessage.creationTimestamp} (${Instant.ofEpochMilli(arroyoMessage.creationTimestamp)})\n&quot;)
</a><a href="#h16-3-37" id="h16-3-37" class="i">+                                append(&quot;read_timestamp: ${arroyoMessage.readTimestamp} (${Instant.ofEpochMilli(arroyoMessage.readTimestamp)})\n&quot;)
</a><a href="#h16-3-38" id="h16-3-38" class="i">+                                append(&quot;is_messagelogger_deleted: ${messageLogger.isMessageDeleted(arroyoMessage.clientConversationId!!, arroyoMessage.clientMessageId.toLong())}\n&quot;)
</a><a href="#h16-3-39" id="h16-3-39" class="i">+                                append(&quot;is_messagelogger_stored: ${messageLogger.getMessageObject(arroyoMessage.clientConversationId!!, arroyoMessage.clientMessageId.toLong()) != null}\n&quot;)
</a><a href="#h16-3-40" id="h16-3-40" class="i">+                            }.onFailure {
</a><a href="#h16-3-41" id="h16-3-41" class="i">+                                debugText.append(&quot;Error: $it\n&quot;)
</a><a href="#h16-3-42" id="h16-3-42" class="i">+                            }
</a><a href="#h16-3-43" id="h16-3-43" class="i">+                        }.toString().trimEnd()
</a><a href="#h16-3-44" id="h16-3-44" class="i">+                    }
</a><a href="#h16-3-45" id="h16-3-45" class="i">+                })
</a><a href="#h16-3-46" id="h16-3-46" class="i">+
</a><a href="#h16-3-47" id="h16-3-47" class="i">+                // action buttons
</a><a href="#h16-3-48" id="h16-3-48" class="i">+                addView(LinearLayout(viewGroup.context).apply {
</a><a href="#h16-3-49" id="h16-3-49" class="i">+                    orientation = LinearLayout.HORIZONTAL
</a><a href="#h16-3-50" id="h16-3-50" class="i">+                    addView(Button(viewGroup.context).apply {
</a><a href="#h16-3-51" id="h16-3-51" class="i">+                        text = &quot;Show Deleted Message Object&quot;
</a><a href="#h16-3-52" id="h16-3-52" class="i">+                        setOnClickListener {
</a><a href="#h16-3-53" id="h16-3-53" class="i">+                            val message = lastFocusedMessage ?: return@setOnClickListener
</a><a href="#h16-3-54" id="h16-3-54" class="i">+                            copyAlertDialog(
</a><a href="#h16-3-55" id="h16-3-55" class="i">+                                viewGroup.context,
</a><a href="#h16-3-56" id="h16-3-56" class="i">+                                &quot;Deleted Message Object&quot;,
</a><a href="#h16-3-57" id="h16-3-57" class="i">+                                messageLogger.getMessageObject(message.clientConversationId!!, message.clientMessageId.toLong())?.toString()
</a><a href="#h16-3-58" id="h16-3-58" class="i">+                                    ?: &quot;null&quot;
</a><a href="#h16-3-59" id="h16-3-59" class="i">+                            )
</a><a href="#h16-3-60" id="h16-3-60" class="i">+                        }
</a><a href="#h16-3-61" id="h16-3-61" class="i">+                    })
</a><a href="#h16-3-62" id="h16-3-62" class="i">+                })
</a><a href="#h16-3-63" id="h16-3-63" class="i">+            })
</a><a href="#h16-3-64" id="h16-3-64" class="i">+        }
</a><a href="#h16-3-65" id="h16-3-65" class="i">+
</a>         parent.addView(buttonContainer)
     }
 }
<b>diff --git a/<a id="h17" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/FriendFeedInfoMenu.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/FriendFeedInfoMenu.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/FriendFeedInfoMenu.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/FriendFeedInfoMenu.kt</a></b>
<a href="#h17-0" id="h17-0" class="h">@@ -14,10 +14,12 @@ import android.widget.Switch
</a> import me.rhunk.snapenhance.core.database.objects.ConversationMessage
 import me.rhunk.snapenhance.core.database.objects.FriendInfo
 import me.rhunk.snapenhance.core.database.objects.UserConversationLink
<a href="#h17-0-3" id="h17-0-3" class="i">+import me.rhunk.snapenhance.core.util.protobuf.ProtoReader
</a> import me.rhunk.snapenhance.core.util.snap.BitmojiSelfie
 import me.rhunk.snapenhance.data.ContentType
 import me.rhunk.snapenhance.data.FriendLinkType
 import me.rhunk.snapenhance.features.impl.Messaging
<a href="#h17-0-8" id="h17-0-8" class="i">+import me.rhunk.snapenhance.features.impl.spying.MessageLogger
</a> import me.rhunk.snapenhance.ui.ViewAppearanceHelper
 import me.rhunk.snapenhance.ui.applyTheme
 import me.rhunk.snapenhance.ui.menu.AbstractMenu
<a href="#h17-1" id="h17-1" class="h">@@ -102,15 +104,11 @@ class FriendFeedInfoMenu : AbstractMenu() {
</a> 
     private fun showPreview(userId: String?, conversationId: String, androidCtx: Context?) {
         //query message
<a href="#h17-1-3" id="h17-1-3" class="d">-        val messages: List&lt;ConversationMessage&gt;? = context.database.getMessagesFromConversationId(
</a><a href="#h17-1-4" id="h17-1-4" class="i">+        val messageLogger = context.feature(MessageLogger::class)
</a><a href="#h17-1-5" id="h17-1-5" class="i">+        val messages: List&lt;ConversationMessage&gt; = context.database.getMessagesFromConversationId(
</a>             conversationId,
             context.config.messaging.messagePreviewLength.get()
<a href="#h17-1-8" id="h17-1-8" class="d">-        )?.reversed()
</a><a href="#h17-1-9" id="h17-1-9" class="d">-
</a><a href="#h17-1-10" id="h17-1-10" class="d">-        if (messages == null) {
</a><a href="#h17-1-11" id="h17-1-11" class="d">-            context.longToast(&quot;Can&#39;t fetch messages&quot;)
</a><a href="#h17-1-12" id="h17-1-12" class="d">-            return
</a><a href="#h17-1-13" id="h17-1-13" class="d">-        }
</a><a href="#h17-1-14" id="h17-1-14" class="i">+        )?.reversed() ?: emptyList()
</a> 
         val participants: Map&lt;String, FriendInfo&gt; = context.database.getConversationParticipants(conversationId)!!
             .map { context.database.getFriendInfo(it)!! }
<a href="#h17-2" id="h17-2" class="h">@@ -119,19 +117,26 @@ class FriendFeedInfoMenu : AbstractMenu() {
</a>         val messageBuilder = StringBuilder()
 
         messages.forEach { message -&gt;
<a href="#h17-2-3" id="h17-2-3" class="d">-            val sender: FriendInfo? = participants[message.senderId]
</a><a href="#h17-2-4" id="h17-2-4" class="d">-
</a><a href="#h17-2-5" id="h17-2-5" class="d">-            var messageString: String = message.getMessageAsString() ?: ContentType.fromId(message.contentType).name
</a><a href="#h17-2-6" id="h17-2-6" class="i">+            val sender = participants[message.senderId]
</a><a href="#h17-2-7" id="h17-2-7" class="i">+            val protoReader = (
</a><a href="#h17-2-8" id="h17-2-8" class="i">+                messageLogger.takeIf { it.isEnabled }?.getMessageProto(conversationId, message.clientMessageId.toLong()) ?: ProtoReader(message.messageContent ?: return@forEach).followPath(4, 4)
</a><a href="#h17-2-9" id="h17-2-9" class="i">+            ) ?: return@forEach
</a><a href="#h17-2-10" id="h17-2-10" class="i">+
</a><a href="#h17-2-11" id="h17-2-11" class="i">+            val contentType = ContentType.fromMessageContainer(protoReader)
</a><a href="#h17-2-12" id="h17-2-12" class="i">+            var messageString = if (contentType == ContentType.CHAT) {
</a><a href="#h17-2-13" id="h17-2-13" class="i">+                protoReader.getString(2, 1) ?: return@forEach
</a><a href="#h17-2-14" id="h17-2-14" class="i">+            } else {
</a><a href="#h17-2-15" id="h17-2-15" class="i">+                contentType.name
</a><a href="#h17-2-16" id="h17-2-16" class="i">+            }
</a> 
<a href="#h17-2-18" id="h17-2-18" class="d">-            if (message.contentType == ContentType.SNAP.id) {
</a><a href="#h17-2-19" id="h17-2-19" class="d">-                val readTimeStamp: Long = message.readTimestamp
</a><a href="#h17-2-20" id="h17-2-20" class="i">+            if (contentType == ContentType.SNAP) {
</a>                 messageString = &quot;\uD83D\uDFE5&quot; //red square
<a href="#h17-2-22" id="h17-2-22" class="d">-                if (readTimeStamp &gt; 0) {
</a><a href="#h17-2-23" id="h17-2-23" class="i">+                if (message.readTimestamp &gt; 0) {
</a>                     messageString += &quot; \uD83D\uDC40 &quot; //eyes
                     messageString += DateFormat.getDateTimeInstance(
                         DateFormat.SHORT,
                         DateFormat.SHORT
<a href="#h17-2-28" id="h17-2-28" class="d">-                    ).format(Date(readTimeStamp))
</a><a href="#h17-2-29" id="h17-2-29" class="i">+                    ).format(Date(message.readTimestamp))
</a>                 }
             }
 
<a href="#h17-3" id="h17-3" class="h">@@ -144,8 +149,7 @@ class FriendFeedInfoMenu : AbstractMenu() {
</a>             messageBuilder.append(displayUsername).append(&quot;: &quot;).append(messageString).append(&quot;\n&quot;)
         }
 
<a href="#h17-3-3" id="h17-3-3" class="d">-        val targetPerson: FriendInfo? =
</a><a href="#h17-3-4" id="h17-3-4" class="d">-            if (userId == null) null else participants[userId]
</a><a href="#h17-3-5" id="h17-3-5" class="i">+        val targetPerson = if (userId == null) null else participants[userId]
</a> 
         targetPerson?.streakExpirationTimestamp?.takeIf { it &gt; 0 }?.let {
             val timeSecondDiff = ((it - System.currentTimeMillis()) / 1000 / 60).toInt()
</pre>
</div>
</body>
</html>
