<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>feat(experimental): session events - refactor SnapUUID - SnapEnhance - An Xposed module offering an enhanced Snapchat experience
</title>
<link rel="icon" type="image/svg+xml" href="../../logo.png"/>
<link rel="alternate icon" href="../../favicon.png"/>
<link rel="alternate" type="application/atom+xml" title="SnapEnhance Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="SnapEnhance Atom Feed (tags)" href="../tags.xml" />
<link rel="stylesheet" type="text/css" href="../../style.css" />
<link rel="stylesheet" type="text/css" href="../../fonts.css" />
</head>
<body>
<div id="head"><table><tr><td><a class="logo" href="../../"><img src="../../logo.png" alt="" width="32" height="32" /></a></td><td><strong>SnapEnhance</strong><span class="desc"> - An Xposed module offering an enhanced Snapchat experience
</span>
</td></tr></table>
<p><a href="../about.html">About</a> | <a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/LICENSE.html">License</a></p>
</div>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/60ee3680a484a1de4fc305a6ce64834c6dde3ed4.html">60ee3680a484a1de4fc305a6ce64834c6dde3ed4</a>
<b>parent</b> <a href="../commit/08c9d46858b18018c0c826063ad87dfdbc761503.html">08c9d46858b18018c0c826063ad87dfdbc761503</a>
<b>Author:</b> rhunk &lt;<a href="mailto:101876869+rhunk@users.noreply.github.com">101876869+rhunk@users.noreply.github.com</a>&gt;
<b>Date:</b>   Tue, 13 Feb 2024 22:55:30 +0100

feat(experimental): session events
- refactor SnapUUID

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">common/src/main/assets/lang/en_US.json</a></td><td> | </td><td class="num">14</td><td><span class="i">++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="D">D</td><td><a href="#h1">common/src/main/kotlin/me/rhunk/snapenhance/common/config/impl/E2EEConfig.kt</a></td><td> | </td><td class="num">9</td><td><span class="i"></span><span class="d">---------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h2">common/src/main/kotlin/me/rhunk/snapenhance/common/config/impl/Experimental.kt</a></td><td> | </td><td class="num">11</td><td><span class="i">+++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h3">common/src/main/kotlin/me/rhunk/snapenhance/common/data/SessionEventsData.kt</a></td><td> | </td><td class="num">42</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h4">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/EndToEndEncryption.kt</a></td><td> | </td><td class="num">4</td><td><span class="i">++</span><span class="d">--</span></td></tr>
<tr><td class="A">A</td><td><a href="#h5">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/SessionEvents.kt</a></td><td> | </td><td class="num">233</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h6">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/Messaging.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h7">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/Notifications.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h8">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/tweaks/UnsaveableMessages.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h9">core/src/main/kotlin/me/rhunk/snapenhance/core/manager/impl/FeatureManager.kt</a></td><td> | </td><td class="num">1</td><td><span class="i">+</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h10">core/src/main/kotlin/me/rhunk/snapenhance/core/scripting/impl/CoreMessaging.kt</a></td><td> | </td><td class="num">4</td><td><span class="i">++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h11">core/src/main/kotlin/me/rhunk/snapenhance/core/wrapper/AbstractWrapper.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h12">core/src/main/kotlin/me/rhunk/snapenhance/core/wrapper/impl/ConversationManager.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h13">core/src/main/kotlin/me/rhunk/snapenhance/core/wrapper/impl/SnapUUID.kt</a></td><td> | </td><td class="num">60</td><td><span class="i">++++++++++++++++++++++++++++++++++++</span><span class="d">------------------------</span></td></tr>
<tr><td class="A">A</td><td><a href="#h14">native/jni/src/hooks/duplex_hook.h</a></td><td> | </td><td class="num">27</td><td><span class="i">+++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h15">native/jni/src/library.cpp</a></td><td> | </td><td class="num">2</td><td><span class="i">++</span><span class="d"></span></td></tr>
</table></pre><pre>16 files changed, 375 insertions(+), 42 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/common/src/main/assets/lang/en_US.json.html">common/src/main/assets/lang/en_US.json</a> b/<a href="../file/common/src/main/assets/lang/en_US.json.html">common/src/main/assets/lang/en_US.json</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -618,6 +618,20 @@
</a>                             }
                         }
                     },
<a href="#h0-0-3" id="h0-0-3" class="i">+                    &quot;session_events&quot;: {
</a><a href="#h0-0-4" id="h0-0-4" class="i">+                        &quot;name&quot;: &quot;Session Events&quot;,
</a><a href="#h0-0-5" id="h0-0-5" class="i">+                        &quot;description&quot;: &quot;Records session events&quot;,
</a><a href="#h0-0-6" id="h0-0-6" class="i">+                        &quot;properties&quot;: {
</a><a href="#h0-0-7" id="h0-0-7" class="i">+                            &quot;capture_duplex_events&quot;: {
</a><a href="#h0-0-8" id="h0-0-8" class="i">+                                &quot;name&quot;: &quot;Capture Duplex Events&quot;,
</a><a href="#h0-0-9" id="h0-0-9" class="i">+                                &quot;description&quot;: &quot;Capture presence and messaging events when a session is active&quot;
</a><a href="#h0-0-10" id="h0-0-10" class="i">+                            },
</a><a href="#h0-0-11" id="h0-0-11" class="i">+                            &quot;allow_running_in_background&quot;: {
</a><a href="#h0-0-12" id="h0-0-12" class="i">+                                &quot;name&quot;: &quot;Allow Running in Background&quot;,
</a><a href="#h0-0-13" id="h0-0-13" class="i">+                                &quot;description&quot;: &quot;Allows session to run in the background&quot;
</a><a href="#h0-0-14" id="h0-0-14" class="i">+                            }
</a><a href="#h0-0-15" id="h0-0-15" class="i">+                        }
</a><a href="#h0-0-16" id="h0-0-16" class="i">+                    },
</a>                     &quot;spoof&quot;: {
                         &quot;name&quot;: &quot;Spoof&quot;,
                         &quot;description&quot;: &quot;Spoof various information about you&quot;,
<b>diff --git a/<a id="h1" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/config/impl/E2EEConfig.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/config/impl/E2EEConfig.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/config/impl/E2EEConfig.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/config/impl/E2EEConfig.kt</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -1,8 +0,0 @@
</a><a href="#h1-0-0" id="h1-0-0" class="d">-package me.rhunk.snapenhance.common.config.impl
</a><a href="#h1-0-1" id="h1-0-1" class="d">-
</a><a href="#h1-0-2" id="h1-0-2" class="d">-import me.rhunk.snapenhance.common.config.ConfigContainer
</a><a href="#h1-0-3" id="h1-0-3" class="d">-
</a><a href="#h1-0-4" id="h1-0-4" class="d">-class E2EEConfig : ConfigContainer(hasGlobalState = true) {
</a><a href="#h1-0-5" id="h1-0-5" class="d">-    val encryptedMessageIndicator = boolean(&quot;encrypted_message_indicator&quot;)
</a><a href="#h1-0-6" id="h1-0-6" class="d">-    val forceMessageEncryption = boolean(&quot;force_message_encryption&quot;)
</a><a href="#h1-0-7" id="h1-0-7" class="d">-}</a><a href="#h1-0-8" id="h1-0-8" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h2" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/config/impl/Experimental.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/config/impl/Experimental.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/config/impl/Experimental.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/config/impl/Experimental.kt</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -4,11 +4,22 @@ import me.rhunk.snapenhance.common.config.ConfigContainer
</a> import me.rhunk.snapenhance.common.config.FeatureNotice
 
 class Experimental : ConfigContainer() {
<a href="#h2-0-3" id="h2-0-3" class="i">+    class SessionEventsConfig : ConfigContainer(hasGlobalState = true) {
</a><a href="#h2-0-4" id="h2-0-4" class="i">+        val captureDuplexEvents = boolean(&quot;capture_duplex_events&quot;, true)
</a><a href="#h2-0-5" id="h2-0-5" class="i">+        val allowRunningInBackground = boolean(&quot;allow_running_in_background&quot;, true)
</a><a href="#h2-0-6" id="h2-0-6" class="i">+    }
</a><a href="#h2-0-7" id="h2-0-7" class="i">+
</a>     class NativeHooks : ConfigContainer(hasGlobalState = true) {
         val disableBitmoji = boolean(&quot;disable_bitmoji&quot;)
     }
 
<a href="#h2-0-12" id="h2-0-12" class="i">+    class E2EEConfig : ConfigContainer(hasGlobalState = true) {
</a><a href="#h2-0-13" id="h2-0-13" class="i">+        val encryptedMessageIndicator = boolean(&quot;encrypted_message_indicator&quot;)
</a><a href="#h2-0-14" id="h2-0-14" class="i">+        val forceMessageEncryption = boolean(&quot;force_message_encryption&quot;)
</a><a href="#h2-0-15" id="h2-0-15" class="i">+    }
</a><a href="#h2-0-16" id="h2-0-16" class="i">+
</a>     val nativeHooks = container(&quot;native_hooks&quot;, NativeHooks()) { icon = &quot;Memory&quot;; requireRestart() }
<a href="#h2-0-18" id="h2-0-18" class="i">+    val sessionEvents = container(&quot;session_events&quot;, SessionEventsConfig()) { requireRestart(); nativeHooks() }
</a>     val spoof = container(&quot;spoof&quot;, Spoof()) { icon = &quot;Fingerprint&quot; ; addNotices(FeatureNotice.BAN_RISK); requireRestart() }
     val convertMessageLocally = boolean(&quot;convert_message_locally&quot;) { requireRestart() }
     val storyLogger = boolean(&quot;story_logger&quot;) { requireRestart(); addNotices(FeatureNotice.UNSTABLE); }
<b>diff --git a/<a id="h3" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/data/SessionEventsData.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/data/SessionEventsData.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/data/SessionEventsData.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/data/SessionEventsData.kt</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -0,0 +1,42 @@
</a><a href="#h3-0-0" id="h3-0-0" class="i">+package me.rhunk.snapenhance.common.data
</a><a href="#h3-0-1" id="h3-0-1" class="i">+
</a><a href="#h3-0-2" id="h3-0-2" class="i">+
</a><a href="#h3-0-3" id="h3-0-3" class="i">+data class FriendPresenceState(
</a><a href="#h3-0-4" id="h3-0-4" class="i">+    val bitmojiPresent: Boolean,
</a><a href="#h3-0-5" id="h3-0-5" class="i">+    val typing: Boolean,
</a><a href="#h3-0-6" id="h3-0-6" class="i">+    val wasTyping: Boolean,
</a><a href="#h3-0-7" id="h3-0-7" class="i">+    val speaking: Boolean,
</a><a href="#h3-0-8" id="h3-0-8" class="i">+    val peeking: Boolean
</a><a href="#h3-0-9" id="h3-0-9" class="i">+)
</a><a href="#h3-0-10" id="h3-0-10" class="i">+
</a><a href="#h3-0-11" id="h3-0-11" class="i">+open class SessionEvent(
</a><a href="#h3-0-12" id="h3-0-12" class="i">+    val type: SessionEventType,
</a><a href="#h3-0-13" id="h3-0-13" class="i">+    val conversationId: String,
</a><a href="#h3-0-14" id="h3-0-14" class="i">+    val authorUserId: String,
</a><a href="#h3-0-15" id="h3-0-15" class="i">+)
</a><a href="#h3-0-16" id="h3-0-16" class="i">+
</a><a href="#h3-0-17" id="h3-0-17" class="i">+class SessionMessageEvent(
</a><a href="#h3-0-18" id="h3-0-18" class="i">+    type: SessionEventType,
</a><a href="#h3-0-19" id="h3-0-19" class="i">+    conversationId: String,
</a><a href="#h3-0-20" id="h3-0-20" class="i">+    authorUserId: String,
</a><a href="#h3-0-21" id="h3-0-21" class="i">+    val serverMessageId: Long,
</a><a href="#h3-0-22" id="h3-0-22" class="i">+    val messageData: ByteArray? = null,
</a><a href="#h3-0-23" id="h3-0-23" class="i">+    val reactionId: Int? = null,
</a><a href="#h3-0-24" id="h3-0-24" class="i">+) : SessionEvent(type, conversationId, authorUserId)
</a><a href="#h3-0-25" id="h3-0-25" class="i">+
</a><a href="#h3-0-26" id="h3-0-26" class="i">+
</a><a href="#h3-0-27" id="h3-0-27" class="i">+enum class SessionEventType(
</a><a href="#h3-0-28" id="h3-0-28" class="i">+    val key: String
</a><a href="#h3-0-29" id="h3-0-29" class="i">+) {
</a><a href="#h3-0-30" id="h3-0-30" class="i">+    MESSAGE_READ_RECEIPTS(&quot;message_read_receipts&quot;),
</a><a href="#h3-0-31" id="h3-0-31" class="i">+    MESSAGE_DELETED(&quot;message_deleted&quot;),
</a><a href="#h3-0-32" id="h3-0-32" class="i">+    MESSAGE_SAVED(&quot;message_saved&quot;),
</a><a href="#h3-0-33" id="h3-0-33" class="i">+    MESSAGE_UNSAVED(&quot;message_unsaved&quot;),
</a><a href="#h3-0-34" id="h3-0-34" class="i">+    MESSAGE_REACTION_ADD(&quot;message_reaction_add&quot;),
</a><a href="#h3-0-35" id="h3-0-35" class="i">+    MESSAGE_REACTION_REMOVE(&quot;message_reaction_remove&quot;),
</a><a href="#h3-0-36" id="h3-0-36" class="i">+    SNAP_OPENED(&quot;snap_opened&quot;),
</a><a href="#h3-0-37" id="h3-0-37" class="i">+    SNAP_REPLAYED(&quot;snap_replayed&quot;),
</a><a href="#h3-0-38" id="h3-0-38" class="i">+    SNAP_REPLAYED_TWICE(&quot;snap_replayed_twice&quot;),
</a><a href="#h3-0-39" id="h3-0-39" class="i">+    SNAP_SCREENSHOT(&quot;snap_screenshot&quot;),
</a><a href="#h3-0-40" id="h3-0-40" class="i">+    SNAP_SCREEN_RECORD(&quot;snap_screen_record&quot;),
</a><a href="#h3-0-41" id="h3-0-41" class="i">+}
</a><b>diff --git a/<a id="h4" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/EndToEndEncryption.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/EndToEndEncryption.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/EndToEndEncryption.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/EndToEndEncryption.kt</a></b>
<a href="#h4-0" id="h4-0" class="h">@@ -90,7 +90,7 @@ class EndToEndEncryption : MessagingRuleFeature(
</a> 
     private fun sendCustomMessage(conversationId: String, messageId: Int, message: ProtoWriter.() -&gt; Unit) {
         context.messageSender.sendCustomChatMessage(
<a href="#h4-0-3" id="h4-0-3" class="d">-            listOf(SnapUUID.fromString(conversationId)),
</a><a href="#h4-0-4" id="h4-0-4" class="i">+            listOf(SnapUUID(conversationId)),
</a>             ContentType.CHAT,
             message = {
                 from(2) {
<a href="#h4-1" id="h4-1" class="h">@@ -444,7 +444,7 @@ class EndToEndEncryption : MessagingRuleFeature(
</a>                     hasStory = true
                     return@eachBuffer
                 }
<a href="#h4-1-3" id="h4-1-3" class="d">-                conversationIds.add(SnapUUID.fromBytes(getByteArray(1, 1, 1) ?: return@eachBuffer))
</a><a href="#h4-1-4" id="h4-1-4" class="i">+                conversationIds.add(SnapUUID(getByteArray(1, 1, 1) ?: return@eachBuffer))
</a>             }
 
             if (hasStory) {
<b>diff --git a/<a id="h5" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/SessionEvents.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/SessionEvents.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/SessionEvents.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/SessionEvents.kt</a></b>
<a href="#h5-0" id="h5-0" class="h">@@ -0,0 +1,232 @@
</a><a href="#h5-0-0" id="h5-0-0" class="i">+package me.rhunk.snapenhance.core.features.impl.experiments
</a><a href="#h5-0-1" id="h5-0-1" class="i">+
</a><a href="#h5-0-2" id="h5-0-2" class="i">+import me.rhunk.snapenhance.common.data.SessionMessageEvent
</a><a href="#h5-0-3" id="h5-0-3" class="i">+import me.rhunk.snapenhance.common.data.SessionEvent
</a><a href="#h5-0-4" id="h5-0-4" class="i">+import me.rhunk.snapenhance.common.data.SessionEventType
</a><a href="#h5-0-5" id="h5-0-5" class="i">+import me.rhunk.snapenhance.common.data.FriendPresenceState
</a><a href="#h5-0-6" id="h5-0-6" class="i">+import me.rhunk.snapenhance.common.util.protobuf.ProtoReader
</a><a href="#h5-0-7" id="h5-0-7" class="i">+import me.rhunk.snapenhance.core.features.Feature
</a><a href="#h5-0-8" id="h5-0-8" class="i">+import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a><a href="#h5-0-9" id="h5-0-9" class="i">+import me.rhunk.snapenhance.core.util.hook.HookStage
</a><a href="#h5-0-10" id="h5-0-10" class="i">+import me.rhunk.snapenhance.core.util.hook.hook
</a><a href="#h5-0-11" id="h5-0-11" class="i">+import me.rhunk.snapenhance.core.util.hook.hookConstructor
</a><a href="#h5-0-12" id="h5-0-12" class="i">+import me.rhunk.snapenhance.core.wrapper.impl.toSnapUUID
</a><a href="#h5-0-13" id="h5-0-13" class="i">+import me.rhunk.snapenhance.nativelib.NativeLib
</a><a href="#h5-0-14" id="h5-0-14" class="i">+import java.lang.reflect.Method
</a><a href="#h5-0-15" id="h5-0-15" class="i">+import java.nio.ByteBuffer
</a><a href="#h5-0-16" id="h5-0-16" class="i">+
</a><a href="#h5-0-17" id="h5-0-17" class="i">+class SessionEvents : Feature(&quot;Session Events&quot;, loadParams = FeatureLoadParams.INIT_SYNC) {
</a><a href="#h5-0-18" id="h5-0-18" class="i">+    private val conversationPresenceState = mutableMapOf&lt;String, MutableMap&lt;String, FriendPresenceState?&gt;&gt;() // conversationId -&gt; (userId -&gt; state)
</a><a href="#h5-0-19" id="h5-0-19" class="i">+
</a><a href="#h5-0-20" id="h5-0-20" class="i">+    private fun handleVolatileEvent(protoReader: ProtoReader) {
</a><a href="#h5-0-21" id="h5-0-21" class="i">+        context.log.verbose(&quot;volatile event\n$protoReader&quot;)
</a><a href="#h5-0-22" id="h5-0-22" class="i">+    }
</a><a href="#h5-0-23" id="h5-0-23" class="i">+
</a><a href="#h5-0-24" id="h5-0-24" class="i">+    private fun onConversationPresenceUpdate(conversationId: String, userId: String, oldState: FriendPresenceState?, currentState: FriendPresenceState?) {
</a><a href="#h5-0-25" id="h5-0-25" class="i">+        context.log.verbose(&quot;presence state for $userId in conversation $conversationId\n$currentState&quot;)
</a><a href="#h5-0-26" id="h5-0-26" class="i">+    }
</a><a href="#h5-0-27" id="h5-0-27" class="i">+
</a><a href="#h5-0-28" id="h5-0-28" class="i">+    private fun onConversationMessagingEvent(event: SessionEvent) {
</a><a href="#h5-0-29" id="h5-0-29" class="i">+        context.log.verbose(&quot;conversation messaging event\n${event.type} in ${event.conversationId} from ${event.authorUserId}&quot;)
</a><a href="#h5-0-30" id="h5-0-30" class="i">+    }
</a><a href="#h5-0-31" id="h5-0-31" class="i">+
</a><a href="#h5-0-32" id="h5-0-32" class="i">+    private fun handlePresenceEvent(protoReader: ProtoReader) {
</a><a href="#h5-0-33" id="h5-0-33" class="i">+        val conversationId = protoReader.getString(6) ?: return
</a><a href="#h5-0-34" id="h5-0-34" class="i">+
</a><a href="#h5-0-35" id="h5-0-35" class="i">+        val presenceMap = conversationPresenceState.getOrPut(conversationId) { mutableMapOf() }.toMutableMap()
</a><a href="#h5-0-36" id="h5-0-36" class="i">+        val userIds = mutableSetOf&lt;String&gt;()
</a><a href="#h5-0-37" id="h5-0-37" class="i">+
</a><a href="#h5-0-38" id="h5-0-38" class="i">+        protoReader.eachBuffer(4) {
</a><a href="#h5-0-39" id="h5-0-39" class="i">+            val participantUserId = getString(1)?.takeIf { it.contains(&quot;:&quot;) }?.substringBefore(&quot;:&quot;) ?: return@eachBuffer
</a><a href="#h5-0-40" id="h5-0-40" class="i">+            userIds.add(participantUserId)
</a><a href="#h5-0-41" id="h5-0-41" class="i">+            if (participantUserId == context.database.myUserId) return@eachBuffer
</a><a href="#h5-0-42" id="h5-0-42" class="i">+            val stateMap = getVarInt(2, 1)?.toString(2)?.padStart(16, &#39;0&#39;)?.reversed()?.map { it == &#39;1&#39; } ?: return@eachBuffer
</a><a href="#h5-0-43" id="h5-0-43" class="i">+
</a><a href="#h5-0-44" id="h5-0-44" class="i">+            presenceMap[participantUserId] = FriendPresenceState(
</a><a href="#h5-0-45" id="h5-0-45" class="i">+                bitmojiPresent = stateMap[0],
</a><a href="#h5-0-46" id="h5-0-46" class="i">+                typing = stateMap[4],
</a><a href="#h5-0-47" id="h5-0-47" class="i">+                wasTyping = stateMap[5],
</a><a href="#h5-0-48" id="h5-0-48" class="i">+                speaking = stateMap[6] &amp;&amp; stateMap[4],
</a><a href="#h5-0-49" id="h5-0-49" class="i">+                peeking = stateMap[8]
</a><a href="#h5-0-50" id="h5-0-50" class="i">+            )
</a><a href="#h5-0-51" id="h5-0-51" class="i">+        }
</a><a href="#h5-0-52" id="h5-0-52" class="i">+
</a><a href="#h5-0-53" id="h5-0-53" class="i">+        presenceMap.keys.filterNot { it in userIds }.forEach { presenceMap[it] = null }
</a><a href="#h5-0-54" id="h5-0-54" class="i">+
</a><a href="#h5-0-55" id="h5-0-55" class="i">+        presenceMap.forEach { (userId, state) -&gt;
</a><a href="#h5-0-56" id="h5-0-56" class="i">+            val oldState = conversationPresenceState[conversationId]?.get(userId)
</a><a href="#h5-0-57" id="h5-0-57" class="i">+            if (oldState != state) {
</a><a href="#h5-0-58" id="h5-0-58" class="i">+                onConversationPresenceUpdate(conversationId, userId, oldState, state)
</a><a href="#h5-0-59" id="h5-0-59" class="i">+            }
</a><a href="#h5-0-60" id="h5-0-60" class="i">+        }
</a><a href="#h5-0-61" id="h5-0-61" class="i">+
</a><a href="#h5-0-62" id="h5-0-62" class="i">+        conversationPresenceState[conversationId] = presenceMap
</a><a href="#h5-0-63" id="h5-0-63" class="i">+    }
</a><a href="#h5-0-64" id="h5-0-64" class="i">+
</a><a href="#h5-0-65" id="h5-0-65" class="i">+    private fun handleMessagingEvent(protoReader: ProtoReader) {
</a><a href="#h5-0-66" id="h5-0-66" class="i">+        // read receipts
</a><a href="#h5-0-67" id="h5-0-67" class="i">+        protoReader.followPath(12) {
</a><a href="#h5-0-68" id="h5-0-68" class="i">+            val conversationId = getByteArray(1, 1)?.toSnapUUID().toString() ?: return@followPath
</a><a href="#h5-0-69" id="h5-0-69" class="i">+
</a><a href="#h5-0-70" id="h5-0-70" class="i">+            followPath(7) readReceipts@{
</a><a href="#h5-0-71" id="h5-0-71" class="i">+                val senderId = getByteArray(1, 1)?.toSnapUUID()?.toString() ?: return@readReceipts
</a><a href="#h5-0-72" id="h5-0-72" class="i">+                val serverMessageId = getVarInt(2, 2) ?: return@readReceipts
</a><a href="#h5-0-73" id="h5-0-73" class="i">+
</a><a href="#h5-0-74" id="h5-0-74" class="i">+                onConversationMessagingEvent(
</a><a href="#h5-0-75" id="h5-0-75" class="i">+                    SessionMessageEvent(
</a><a href="#h5-0-76" id="h5-0-76" class="i">+                        SessionEventType.MESSAGE_READ_RECEIPTS,
</a><a href="#h5-0-77" id="h5-0-77" class="i">+                        conversationId,
</a><a href="#h5-0-78" id="h5-0-78" class="i">+                        senderId,
</a><a href="#h5-0-79" id="h5-0-79" class="i">+                        serverMessageId,
</a><a href="#h5-0-80" id="h5-0-80" class="i">+                    )
</a><a href="#h5-0-81" id="h5-0-81" class="i">+                )
</a><a href="#h5-0-82" id="h5-0-82" class="i">+            }
</a><a href="#h5-0-83" id="h5-0-83" class="i">+        }
</a><a href="#h5-0-84" id="h5-0-84" class="i">+
</a><a href="#h5-0-85" id="h5-0-85" class="i">+        protoReader.followPath(6, 2) {
</a><a href="#h5-0-86" id="h5-0-86" class="i">+            val conversationId = getByteArray(1, 1)?.toSnapUUID()?.toString() ?: return@followPath
</a><a href="#h5-0-87" id="h5-0-87" class="i">+            val senderId = getByteArray(3, 1)?.toSnapUUID()?.toString() ?: return@followPath
</a><a href="#h5-0-88" id="h5-0-88" class="i">+            val serverMessageId = getVarInt(2) ?: return@followPath
</a><a href="#h5-0-89" id="h5-0-89" class="i">+
</a><a href="#h5-0-90" id="h5-0-90" class="i">+            if (contains(4)) {
</a><a href="#h5-0-91" id="h5-0-91" class="i">+                onConversationMessagingEvent(
</a><a href="#h5-0-92" id="h5-0-92" class="i">+                    SessionMessageEvent(
</a><a href="#h5-0-93" id="h5-0-93" class="i">+                        SessionEventType.SNAP_OPENED,
</a><a href="#h5-0-94" id="h5-0-94" class="i">+                        conversationId,
</a><a href="#h5-0-95" id="h5-0-95" class="i">+                        senderId,
</a><a href="#h5-0-96" id="h5-0-96" class="i">+                        serverMessageId
</a><a href="#h5-0-97" id="h5-0-97" class="i">+                    )
</a><a href="#h5-0-98" id="h5-0-98" class="i">+                )
</a><a href="#h5-0-99" id="h5-0-99" class="i">+            }
</a><a href="#h5-0-100" id="h5-0-100" class="i">+
</a><a href="#h5-0-101" id="h5-0-101" class="i">+            if (contains(13)) {
</a><a href="#h5-0-102" id="h5-0-102" class="i">+                onConversationMessagingEvent(
</a><a href="#h5-0-103" id="h5-0-103" class="i">+                    SessionMessageEvent(
</a><a href="#h5-0-104" id="h5-0-104" class="i">+                        if (getVarInt(13, 1) == 2L) SessionEventType.SNAP_REPLAYED_TWICE else SessionEventType.SNAP_REPLAYED,
</a><a href="#h5-0-105" id="h5-0-105" class="i">+                        conversationId,
</a><a href="#h5-0-106" id="h5-0-106" class="i">+                        senderId,
</a><a href="#h5-0-107" id="h5-0-107" class="i">+                        serverMessageId
</a><a href="#h5-0-108" id="h5-0-108" class="i">+                    )
</a><a href="#h5-0-109" id="h5-0-109" class="i">+                )
</a><a href="#h5-0-110" id="h5-0-110" class="i">+            }
</a><a href="#h5-0-111" id="h5-0-111" class="i">+
</a><a href="#h5-0-112" id="h5-0-112" class="i">+            if (contains(6) || contains(7)) {
</a><a href="#h5-0-113" id="h5-0-113" class="i">+                onConversationMessagingEvent(
</a><a href="#h5-0-114" id="h5-0-114" class="i">+                    SessionMessageEvent(
</a><a href="#h5-0-115" id="h5-0-115" class="i">+                        if (contains(6)) SessionEventType.MESSAGE_SAVED else SessionEventType.MESSAGE_UNSAVED,
</a><a href="#h5-0-116" id="h5-0-116" class="i">+                        conversationId,
</a><a href="#h5-0-117" id="h5-0-117" class="i">+                        senderId,
</a><a href="#h5-0-118" id="h5-0-118" class="i">+                        serverMessageId
</a><a href="#h5-0-119" id="h5-0-119" class="i">+                    )
</a><a href="#h5-0-120" id="h5-0-120" class="i">+                )
</a><a href="#h5-0-121" id="h5-0-121" class="i">+            }
</a><a href="#h5-0-122" id="h5-0-122" class="i">+
</a><a href="#h5-0-123" id="h5-0-123" class="i">+            if (contains(11) || contains(12)) {
</a><a href="#h5-0-124" id="h5-0-124" class="i">+                onConversationMessagingEvent(
</a><a href="#h5-0-125" id="h5-0-125" class="i">+                    SessionMessageEvent(
</a><a href="#h5-0-126" id="h5-0-126" class="i">+                        if (contains(11)) SessionEventType.SNAP_SCREENSHOT else SessionEventType.SNAP_SCREEN_RECORD,
</a><a href="#h5-0-127" id="h5-0-127" class="i">+                        conversationId,
</a><a href="#h5-0-128" id="h5-0-128" class="i">+                        senderId,
</a><a href="#h5-0-129" id="h5-0-129" class="i">+                        serverMessageId,
</a><a href="#h5-0-130" id="h5-0-130" class="i">+                    )
</a><a href="#h5-0-131" id="h5-0-131" class="i">+                )
</a><a href="#h5-0-132" id="h5-0-132" class="i">+            }
</a><a href="#h5-0-133" id="h5-0-133" class="i">+
</a><a href="#h5-0-134" id="h5-0-134" class="i">+            followPath(16) {
</a><a href="#h5-0-135" id="h5-0-135" class="i">+                onConversationMessagingEvent(
</a><a href="#h5-0-136" id="h5-0-136" class="i">+                    SessionMessageEvent(
</a><a href="#h5-0-137" id="h5-0-137" class="i">+                        SessionEventType.MESSAGE_REACTION_ADD, conversationId, senderId, serverMessageId, reactionId = getVarInt(1, 1, 1)?.toInt() ?: -1
</a><a href="#h5-0-138" id="h5-0-138" class="i">+                    )
</a><a href="#h5-0-139" id="h5-0-139" class="i">+                )
</a><a href="#h5-0-140" id="h5-0-140" class="i">+            }
</a><a href="#h5-0-141" id="h5-0-141" class="i">+
</a><a href="#h5-0-142" id="h5-0-142" class="i">+            if (contains(17)) {
</a><a href="#h5-0-143" id="h5-0-143" class="i">+                onConversationMessagingEvent(
</a><a href="#h5-0-144" id="h5-0-144" class="i">+                    SessionMessageEvent(SessionEventType.MESSAGE_REACTION_REMOVE, conversationId, senderId, serverMessageId)
</a><a href="#h5-0-145" id="h5-0-145" class="i">+                )
</a><a href="#h5-0-146" id="h5-0-146" class="i">+            }
</a><a href="#h5-0-147" id="h5-0-147" class="i">+
</a><a href="#h5-0-148" id="h5-0-148" class="i">+            followPath(8) {
</a><a href="#h5-0-149" id="h5-0-149" class="i">+                onConversationMessagingEvent(
</a><a href="#h5-0-150" id="h5-0-150" class="i">+                    SessionMessageEvent(SessionEventType.MESSAGE_DELETED, conversationId, senderId, serverMessageId, messageData = getByteArray(1))
</a><a href="#h5-0-151" id="h5-0-151" class="i">+                )
</a><a href="#h5-0-152" id="h5-0-152" class="i">+            }
</a><a href="#h5-0-153" id="h5-0-153" class="i">+        }
</a><a href="#h5-0-154" id="h5-0-154" class="i">+    }
</a><a href="#h5-0-155" id="h5-0-155" class="i">+
</a><a href="#h5-0-156" id="h5-0-156" class="i">+    override fun init() {
</a><a href="#h5-0-157" id="h5-0-157" class="i">+        val sessionEventsConfig = context.config.experimental.sessionEvents
</a><a href="#h5-0-158" id="h5-0-158" class="i">+        if (sessionEventsConfig.globalState != true) return
</a><a href="#h5-0-159" id="h5-0-159" class="i">+
</a><a href="#h5-0-160" id="h5-0-160" class="i">+        if (sessionEventsConfig.allowRunningInBackground.get()) {
</a><a href="#h5-0-161" id="h5-0-161" class="i">+            findClass(&quot;com.snapchat.client.duplex.DuplexClient\$CppProxy&quot;).apply {
</a><a href="#h5-0-162" id="h5-0-162" class="i">+                // prevent disabling events when the app is inactive
</a><a href="#h5-0-163" id="h5-0-163" class="i">+                hook(&quot;appStateChanged&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h5-0-164" id="h5-0-164" class="i">+                    if (param.arg&lt;Any&gt;(0).toString() == &quot;INACTIVE&quot;) param.setResult(null)
</a><a href="#h5-0-165" id="h5-0-165" class="i">+                }
</a><a href="#h5-0-166" id="h5-0-166" class="i">+                // allow events when a notification is received
</a><a href="#h5-0-167" id="h5-0-167" class="i">+                hookConstructor(HookStage.AFTER) { param -&gt;
</a><a href="#h5-0-168" id="h5-0-168" class="i">+                    methods.first { it.name == &quot;appStateChanged&quot; }.let { method -&gt;
</a><a href="#h5-0-169" id="h5-0-169" class="i">+                        method.invoke(param.thisObject(), method.parameterTypes[0].enumConstants.first { it.toString() == &quot;ACTIVE&quot; })
</a><a href="#h5-0-170" id="h5-0-170" class="i">+                    }
</a><a href="#h5-0-171" id="h5-0-171" class="i">+                }
</a><a href="#h5-0-172" id="h5-0-172" class="i">+            }
</a><a href="#h5-0-173" id="h5-0-173" class="i">+        }
</a><a href="#h5-0-174" id="h5-0-174" class="i">+
</a><a href="#h5-0-175" id="h5-0-175" class="i">+        if (sessionEventsConfig.captureDuplexEvents.get()) {
</a><a href="#h5-0-176" id="h5-0-176" class="i">+            val messageHandlerClass = findClass(&quot;com.snapchat.client.duplex.MessageHandler\$CppProxy&quot;).apply {
</a><a href="#h5-0-177" id="h5-0-177" class="i">+                hook(&quot;onReceive&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h5-0-178" id="h5-0-178" class="i">+                    param.setResult(null)
</a><a href="#h5-0-179" id="h5-0-179" class="i">+
</a><a href="#h5-0-180" id="h5-0-180" class="i">+                    val byteBuffer = param.arg&lt;ByteBuffer&gt;(0)
</a><a href="#h5-0-181" id="h5-0-181" class="i">+                    val content = byteBuffer.let {
</a><a href="#h5-0-182" id="h5-0-182" class="i">+                        val bytes = ByteArray(it.limit())
</a><a href="#h5-0-183" id="h5-0-183" class="i">+                        it.get(bytes)
</a><a href="#h5-0-184" id="h5-0-184" class="i">+                        bytes
</a><a href="#h5-0-185" id="h5-0-185" class="i">+                    }
</a><a href="#h5-0-186" id="h5-0-186" class="i">+                    val reader = ProtoReader(content)
</a><a href="#h5-0-187" id="h5-0-187" class="i">+                    reader.getString(1, 1)?.let {
</a><a href="#h5-0-188" id="h5-0-188" class="i">+                        val eventData = reader.followPath(1, 2) ?: return@let
</a><a href="#h5-0-189" id="h5-0-189" class="i">+                        if (it == &quot;volatile&quot;) {
</a><a href="#h5-0-190" id="h5-0-190" class="i">+                            handleVolatileEvent(eventData)
</a><a href="#h5-0-191" id="h5-0-191" class="i">+                            return@hook
</a><a href="#h5-0-192" id="h5-0-192" class="i">+                        }
</a><a href="#h5-0-193" id="h5-0-193" class="i">+
</a><a href="#h5-0-194" id="h5-0-194" class="i">+                        if (it == &quot;presence&quot;) {
</a><a href="#h5-0-195" id="h5-0-195" class="i">+                            handlePresenceEvent(eventData)
</a><a href="#h5-0-196" id="h5-0-196" class="i">+                            return@hook
</a><a href="#h5-0-197" id="h5-0-197" class="i">+                        }
</a><a href="#h5-0-198" id="h5-0-198" class="i">+                    }
</a><a href="#h5-0-199" id="h5-0-199" class="i">+                    handleMessagingEvent(reader)
</a><a href="#h5-0-200" id="h5-0-200" class="i">+                }
</a><a href="#h5-0-201" id="h5-0-201" class="i">+                hook(&quot;nativeDestroy&quot;, HookStage.BEFORE) { it.setResult(null) }
</a><a href="#h5-0-202" id="h5-0-202" class="i">+            }
</a><a href="#h5-0-203" id="h5-0-203" class="i">+
</a><a href="#h5-0-204" id="h5-0-204" class="i">+
</a><a href="#h5-0-205" id="h5-0-205" class="i">+            findClass(&quot;com.snapchat.client.messaging.Session&quot;).hook(&quot;create&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h5-0-206" id="h5-0-206" class="i">+                if (!NativeLib.initialized) {
</a><a href="#h5-0-207" id="h5-0-207" class="i">+                    context.log.warn(&quot;Can&#39;t register duplex message handler, native lib not initialized&quot;)
</a><a href="#h5-0-208" id="h5-0-208" class="i">+                    return@hook
</a><a href="#h5-0-209" id="h5-0-209" class="i">+                }
</a><a href="#h5-0-210" id="h5-0-210" class="i">+
</a><a href="#h5-0-211" id="h5-0-211" class="i">+                val method = param.method() as Method
</a><a href="#h5-0-212" id="h5-0-212" class="i">+                val duplexClient = method.parameterTypes.indexOfFirst { it.name.endsWith(&quot;DuplexClient&quot;) }.let {
</a><a href="#h5-0-213" id="h5-0-213" class="i">+                    param.arg&lt;Any&gt;(it)
</a><a href="#h5-0-214" id="h5-0-214" class="i">+                }
</a><a href="#h5-0-215" id="h5-0-215" class="i">+                val dispatchQueue = method.parameterTypes.indexOfFirst { it.name.endsWith(&quot;DispatchQueue&quot;) }.let {
</a><a href="#h5-0-216" id="h5-0-216" class="i">+                    param.arg&lt;Any&gt;(it)
</a><a href="#h5-0-217" id="h5-0-217" class="i">+                }
</a><a href="#h5-0-218" id="h5-0-218" class="i">+                for (channel in arrayOf(&quot;pcs&quot;, &quot;mcs&quot;)) {
</a><a href="#h5-0-219" id="h5-0-219" class="i">+                    duplexClient::class.java.methods.first {
</a><a href="#h5-0-220" id="h5-0-220" class="i">+                        it.name == &quot;registerHandler&quot;
</a><a href="#h5-0-221" id="h5-0-221" class="i">+                    }.invoke(
</a><a href="#h5-0-222" id="h5-0-222" class="i">+                        duplexClient,
</a><a href="#h5-0-223" id="h5-0-223" class="i">+                        channel,
</a><a href="#h5-0-224" id="h5-0-224" class="i">+                        messageHandlerClass.declaredConstructors.first().also { it.isAccessible = true }.newInstance(-1),
</a><a href="#h5-0-225" id="h5-0-225" class="i">+                        dispatchQueue
</a><a href="#h5-0-226" id="h5-0-226" class="i">+                    )
</a><a href="#h5-0-227" id="h5-0-227" class="i">+                }
</a><a href="#h5-0-228" id="h5-0-228" class="i">+            }
</a><a href="#h5-0-229" id="h5-0-229" class="i">+        }
</a><a href="#h5-0-230" id="h5-0-230" class="i">+    }
</a><a href="#h5-0-231" id="h5-0-231" class="i">+}</a><a href="#h5-0-232" id="h5-0-232" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h6" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/Messaging.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/Messaging.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/Messaging.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/Messaging.kt</a></b>
<a href="#h6-0" id="h6-0" class="h">@@ -110,7 +110,7 @@ class Messaging : Feature(&quot;Messaging&quot;, loadParams = FeatureLoadParams.ACTIVITY_C
</a>                     if (it.startsWith(&quot;null&quot;)) return@hook
                 }
                 context.database.getConversationType(conversationId)?.takeIf { it == 1 }?.run {
<a href="#h6-0-3" id="h6-0-3" class="d">-                    lastFetchGroupConversationUUID = SnapUUID.fromString(conversationId)
</a><a href="#h6-0-4" id="h6-0-4" class="i">+                    lastFetchGroupConversationUUID = SnapUUID(conversationId)
</a>                 }
             }
         }
<b>diff --git a/<a id="h7" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/Notifications.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/Notifications.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/Notifications.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/Notifications.kt</a></b>
<a href="#h7-0" id="h7-0" class="h">@@ -193,7 +193,7 @@ class Notifications : Feature(&quot;Notifications&quot;, loadParams = FeatureLoadParams.IN
</a>                         .toString()
                     val myUser = context.database.myUserId.let { context.database.getFriendInfo(it) } ?: return@subscribe
 
<a href="#h7-0-3" id="h7-0-3" class="d">-                    context.messageSender.sendChatMessage(listOf(SnapUUID.fromString(conversationId)), input, onError = {
</a><a href="#h7-0-4" id="h7-0-4" class="i">+                    context.messageSender.sendChatMessage(listOf(SnapUUID(conversationId)), input, onError = {
</a>                         context.longToast(&quot;Failed to send message: $it&quot;)
                         context.coroutineScope.launch(coroutineDispatcher) {
                             appendNotificationText(&quot;Failed to send message: $it&quot;)
<b>diff --git a/<a id="h8" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/tweaks/UnsaveableMessages.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/tweaks/UnsaveableMessages.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/tweaks/UnsaveableMessages.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/tweaks/UnsaveableMessages.kt</a></b>
<a href="#h8-0" id="h8-0" class="h">@@ -27,7 +27,7 @@ class UnsaveableMessages : MessagingRuleFeature(
</a>                 if (contains(2)) {
                     return@eachBuffer
                 }
<a href="#h8-0-3" id="h8-0-3" class="d">-                conversationIds.add(SnapUUID.fromBytes(getByteArray(1, 1, 1) ?: return@eachBuffer).toString())
</a><a href="#h8-0-4" id="h8-0-4" class="i">+                conversationIds.add(SnapUUID(getByteArray(1, 1, 1) ?: return@eachBuffer).toString())
</a>             }
 
             if (conversationIds.all { canUseRule(it) }) {
<b>diff --git a/<a id="h9" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/manager/impl/FeatureManager.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/manager/impl/FeatureManager.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/manager/impl/FeatureManager.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/manager/impl/FeatureManager.kt</a></b>
<a href="#h9-0" id="h9-0" class="h">@@ -118,6 +118,7 @@ class FeatureManager(
</a>             OperaViewerParamsOverride(),
             StealthModeIndicator(),
             DisablePermissionRequests(),
<a href="#h9-0-3" id="h9-0-3" class="i">+            SessionEvents(),
</a>         )
 
         initializeFeatures()
<b>diff --git a/<a id="h10" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/scripting/impl/CoreMessaging.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/scripting/impl/CoreMessaging.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/scripting/impl/CoreMessaging.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/scripting/impl/CoreMessaging.kt</a></b>
<a href="#h10-0" id="h10-0" class="h">@@ -23,7 +23,7 @@ class CoreMessaging(
</a>     fun isPresent() = conversationManager != null
 
     @JSFunction
<a href="#h10-0-3" id="h10-0-3" class="d">-    fun newSnapUUID(uuid: String) = SnapUUID.fromString(uuid)
</a><a href="#h10-0-4" id="h10-0-4" class="i">+    fun newSnapUUID(uuid: String) = SnapUUID(uuid)
</a> 
     @JSFunction
     fun updateMessage(
<a href="#h10-1" id="h10-1" class="h">@@ -143,7 +143,7 @@ class CoreMessaging(
</a>         message: String,
         result: (error: String?) -&gt; Unit
     ) {
<a href="#h10-1-3" id="h10-1-3" class="d">-        modContext.messageSender.sendChatMessage(listOf(SnapUUID.fromString(conversationId)), message, onSuccess = { result(null) }, onError = { result(it.toString()) })
</a><a href="#h10-1-4" id="h10-1-4" class="i">+        modContext.messageSender.sendChatMessage(listOf(SnapUUID(conversationId)), message, onSuccess = { result(null) }, onError = { result(it.toString()) })
</a>     }
 
     @JSFunction
<b>diff --git a/<a id="h11" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/wrapper/AbstractWrapper.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/wrapper/AbstractWrapper.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/wrapper/AbstractWrapper.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/wrapper/AbstractWrapper.kt</a></b>
<a href="#h11-0" id="h11-0" class="h">@@ -6,7 +6,7 @@ import me.rhunk.snapenhance.core.wrapper.impl.SnapUUID
</a> import kotlin.reflect.KProperty
 
 abstract class AbstractWrapper(
<a href="#h11-0-3" id="h11-0-3" class="d">-    protected var instance: Any?
</a><a href="#h11-0-4" id="h11-0-4" class="i">+    protected open var instance: Any?
</a> ) {
     protected val uuidArrayListMapper: (Any?) -&gt; ArrayList&lt;SnapUUID&gt; get() = { (it as ArrayList&lt;*&gt;).map { i -&gt; SnapUUID(i) }.toCollection(ArrayList()) }
 
<b>diff --git a/<a id="h12" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/wrapper/impl/ConversationManager.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/wrapper/impl/ConversationManager.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/wrapper/impl/ConversationManager.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/wrapper/impl/ConversationManager.kt</a></b>
<a href="#h12-0" id="h12-0" class="h">@@ -40,7 +40,7 @@ class ConversationManager(
</a>     fun updateMessage(conversationId: String, messageId: Long, action: MessageUpdate, onResult: CallbackResult = {}) {
         updateMessageMethod.invoke(
             instanceNonNull(),
<a href="#h12-0-3" id="h12-0-3" class="d">-            SnapUUID.fromString(conversationId).instanceNonNull(),
</a><a href="#h12-0-4" id="h12-0-4" class="i">+            SnapUUID(conversationId).instanceNonNull(),
</a>             messageId,
             context.classCache.messageUpdateEnum.enumConstants.first { it.toString() == action.toString() },
             CallbackBuilder(getCallbackClass(&quot;Callback&quot;))
<b>diff --git a/<a id="h13" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/wrapper/impl/SnapUUID.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/wrapper/impl/SnapUUID.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/wrapper/impl/SnapUUID.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/wrapper/impl/SnapUUID.kt</a></b>
<a href="#h13-0" id="h13-0" class="h">@@ -6,41 +6,53 @@ import me.rhunk.snapenhance.core.wrapper.AbstractWrapper
</a> import java.nio.ByteBuffer
 import java.util.UUID
 
<a href="#h13-0-3" id="h13-0-3" class="d">-fun String.toSnapUUID() = SnapUUID.fromString(this)
</a><a href="#h13-0-4" id="h13-0-4" class="i">+fun String.toSnapUUID() = SnapUUID(this)
</a><a href="#h13-0-5" id="h13-0-5" class="i">+fun ByteArray.toSnapUUID() = SnapUUID(this)
</a><a href="#h13-0-6" id="h13-0-6" class="i">+
</a><a href="#h13-0-7" id="h13-0-7" class="i">+fun UUID.toBytes(): ByteArray =
</a><a href="#h13-0-8" id="h13-0-8" class="i">+    ByteBuffer.allocate(16).let {
</a><a href="#h13-0-9" id="h13-0-9" class="i">+        it.putLong(this.mostSignificantBits)
</a><a href="#h13-0-10" id="h13-0-10" class="i">+        it.putLong(this.leastSignificantBits)
</a><a href="#h13-0-11" id="h13-0-11" class="i">+        it.array()
</a><a href="#h13-0-12" id="h13-0-12" class="i">+    }
</a> 
<a href="#h13-0-14" id="h13-0-14" class="d">-class SnapUUID(obj: Any?) : AbstractWrapper(obj) {
</a><a href="#h13-0-15" id="h13-0-15" class="d">-    private val uuidString by lazy { toUUID().toString() }
</a><a href="#h13-0-16" id="h13-0-16" class="i">+class SnapUUID(
</a><a href="#h13-0-17" id="h13-0-17" class="i">+    private val obj: Any?
</a><a href="#h13-0-18" id="h13-0-18" class="i">+) : AbstractWrapper(obj) {
</a><a href="#h13-0-19" id="h13-0-19" class="i">+    private val uuidBytes by lazy {
</a><a href="#h13-0-20" id="h13-0-20" class="i">+        when {
</a><a href="#h13-0-21" id="h13-0-21" class="i">+            obj is String -&gt; {
</a><a href="#h13-0-22" id="h13-0-22" class="i">+                UUID.fromString(obj).toBytes()
</a><a href="#h13-0-23" id="h13-0-23" class="i">+            }
</a><a href="#h13-0-24" id="h13-0-24" class="i">+            obj is ByteArray -&gt; {
</a><a href="#h13-0-25" id="h13-0-25" class="i">+                assert(obj.size == 16)
</a><a href="#h13-0-26" id="h13-0-26" class="i">+                obj
</a><a href="#h13-0-27" id="h13-0-27" class="i">+            }
</a><a href="#h13-0-28" id="h13-0-28" class="i">+            obj is UUID -&gt; obj.toBytes()
</a><a href="#h13-0-29" id="h13-0-29" class="i">+            SnapEnhance.classCache.snapUUID.isInstance(obj) -&gt; {
</a><a href="#h13-0-30" id="h13-0-30" class="i">+                obj?.getObjectField(&quot;mId&quot;) as ByteArray
</a><a href="#h13-0-31" id="h13-0-31" class="i">+            }
</a><a href="#h13-0-32" id="h13-0-32" class="i">+            else -&gt; ByteArray(16)
</a><a href="#h13-0-33" id="h13-0-33" class="i">+        }
</a><a href="#h13-0-34" id="h13-0-34" class="i">+    }
</a> 
<a href="#h13-0-36" id="h13-0-36" class="d">-    private val bytes: ByteArray get() = instanceNonNull().getObjectField(&quot;mId&quot;) as ByteArray
</a><a href="#h13-0-37" id="h13-0-37" class="i">+    private val uuidString by lazy { ByteBuffer.wrap(uuidBytes).run { UUID(long, long) }.toString() }
</a> 
<a href="#h13-0-39" id="h13-0-39" class="d">-    private fun toUUID(): UUID {
</a><a href="#h13-0-40" id="h13-0-40" class="d">-        val buffer = ByteBuffer.wrap(bytes)
</a><a href="#h13-0-41" id="h13-0-41" class="d">-        return UUID(buffer.long, buffer.long)
</a><a href="#h13-0-42" id="h13-0-42" class="d">-    }
</a><a href="#h13-0-43" id="h13-0-43" class="i">+    override var instance: Any?
</a><a href="#h13-0-44" id="h13-0-44" class="i">+        set(_) {}
</a><a href="#h13-0-45" id="h13-0-45" class="i">+        get() = SnapEnhance.classCache.snapUUID.getConstructor(ByteArray::class.java).newInstance(uuidBytes)
</a> 
     override fun toString(): String {
         return uuidString
     }
 
<a href="#h13-0-51" id="h13-0-51" class="d">-    fun toBytes() = bytes
</a><a href="#h13-0-52" id="h13-0-52" class="i">+    fun toBytes() = uuidBytes
</a> 
     override fun equals(other: Any?): Boolean {
<a href="#h13-0-55" id="h13-0-55" class="d">-        return other is SnapUUID &amp;&amp; other.uuidString == uuidString
</a><a href="#h13-0-56" id="h13-0-56" class="i">+        return other is SnapUUID &amp;&amp; other.uuidBytes.contentEquals(this.uuidBytes)
</a>     }
 
<a href="#h13-0-59" id="h13-0-59" class="d">-    companion object {
</a><a href="#h13-0-60" id="h13-0-60" class="d">-        fun fromString(uuid: String): SnapUUID {
</a><a href="#h13-0-61" id="h13-0-61" class="d">-            return fromUUID(UUID.fromString(uuid))
</a><a href="#h13-0-62" id="h13-0-62" class="d">-        }
</a><a href="#h13-0-63" id="h13-0-63" class="d">-        fun fromBytes(bytes: ByteArray): SnapUUID {
</a><a href="#h13-0-64" id="h13-0-64" class="d">-            val constructor = SnapEnhance.classCache.snapUUID.getConstructor(ByteArray::class.java)
</a><a href="#h13-0-65" id="h13-0-65" class="d">-            return SnapUUID(constructor.newInstance(bytes))
</a><a href="#h13-0-66" id="h13-0-66" class="d">-        }
</a><a href="#h13-0-67" id="h13-0-67" class="d">-        fun fromUUID(uuid: UUID): SnapUUID {
</a><a href="#h13-0-68" id="h13-0-68" class="d">-            val buffer = ByteBuffer.allocate(16)
</a><a href="#h13-0-69" id="h13-0-69" class="d">-            buffer.putLong(uuid.mostSignificantBits)
</a><a href="#h13-0-70" id="h13-0-70" class="d">-            buffer.putLong(uuid.leastSignificantBits)
</a><a href="#h13-0-71" id="h13-0-71" class="d">-            return fromBytes(buffer.array())
</a><a href="#h13-0-72" id="h13-0-72" class="d">-        }
</a><a href="#h13-0-73" id="h13-0-73" class="i">+    override fun hashCode(): Int {
</a><a href="#h13-0-74" id="h13-0-74" class="i">+        return uuidBytes.contentHashCode()
</a>     }
 }
<b>diff --git a/<a id="h14" href="../file/native/jni/src/hooks/duplex_hook.h.html">native/jni/src/hooks/duplex_hook.h</a> b/<a href="../file/native/jni/src/hooks/duplex_hook.h.html">native/jni/src/hooks/duplex_hook.h</a></b>
<a href="#h14-0" id="h14-0" class="h">@@ -0,0 +1,26 @@
</a><a href="#h14-0-0" id="h14-0-0" class="i">+#pragma once
</a><a href="#h14-0-1" id="h14-0-1" class="i">+
</a><a href="#h14-0-2" id="h14-0-2" class="i">+
</a><a href="#h14-0-3" id="h14-0-3" class="i">+namespace DuplexHook {
</a><a href="#h14-0-4" id="h14-0-4" class="i">+    HOOK_DEF(jboolean, IsSameObject, JNIEnv * env, jobject obj1, jobject obj2) {
</a><a href="#h14-0-5" id="h14-0-5" class="i">+        if (obj1 == nullptr || obj2 == nullptr) return IsSameObject_original(env, obj1, obj2);
</a><a href="#h14-0-6" id="h14-0-6" class="i">+
</a><a href="#h14-0-7" id="h14-0-7" class="i">+        auto clazz = env-&gt;FindClass(&quot;java/lang/Class&quot;);
</a><a href="#h14-0-8" id="h14-0-8" class="i">+        if (!env-&gt;IsInstanceOf(obj1, clazz)) return IsSameObject_original(env, obj1, obj2);
</a><a href="#h14-0-9" id="h14-0-9" class="i">+
</a><a href="#h14-0-10" id="h14-0-10" class="i">+        jstring obj1ClassName = (jstring) env-&gt;CallObjectMethod(obj1, env-&gt;GetMethodID(clazz, &quot;getName&quot;, &quot;()Ljava/lang/String;&quot;));
</a><a href="#h14-0-11" id="h14-0-11" class="i">+        const char* obj1ClassNameStr = env-&gt;GetStringUTFChars(obj1ClassName, nullptr);
</a><a href="#h14-0-12" id="h14-0-12" class="i">+
</a><a href="#h14-0-13" id="h14-0-13" class="i">+        if (strstr(obj1ClassNameStr, &quot;com.snapchat.client.duplex.MessageHandler&quot;) != 0) {
</a><a href="#h14-0-14" id="h14-0-14" class="i">+            env-&gt;ReleaseStringUTFChars(obj1ClassName, obj1ClassNameStr);
</a><a href="#h14-0-15" id="h14-0-15" class="i">+            return JNI_FALSE;
</a><a href="#h14-0-16" id="h14-0-16" class="i">+        }
</a><a href="#h14-0-17" id="h14-0-17" class="i">+
</a><a href="#h14-0-18" id="h14-0-18" class="i">+        env-&gt;ReleaseStringUTFChars(obj1ClassName, obj1ClassNameStr);
</a><a href="#h14-0-19" id="h14-0-19" class="i">+        return IsSameObject_original(env, obj1, obj2);
</a><a href="#h14-0-20" id="h14-0-20" class="i">+    }
</a><a href="#h14-0-21" id="h14-0-21" class="i">+
</a><a href="#h14-0-22" id="h14-0-22" class="i">+    void init(JNIEnv* env) {
</a><a href="#h14-0-23" id="h14-0-23" class="i">+        DobbyHook((void *)env-&gt;functions-&gt;IsSameObject, (void *)IsSameObject, (void **)&amp;IsSameObject_original);
</a><a href="#h14-0-24" id="h14-0-24" class="i">+    }
</a><a href="#h14-0-25" id="h14-0-25" class="i">+}</a><a href="#h14-0-26" id="h14-0-26" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h15" href="../file/native/jni/src/library.cpp.html">native/jni/src/library.cpp</a> b/<a href="../file/native/jni/src/library.cpp.html">native/jni/src/library.cpp</a></b>
<a href="#h15-0" id="h15-0" class="h">@@ -9,6 +9,7 @@
</a> #include &quot;hooks/unary_call.h&quot;
 #include &quot;hooks/fstat_hook.h&quot;
 #include &quot;hooks/sqlite_mutex.h&quot;
<a href="#h15-0-3" id="h15-0-3" class="i">+#include &quot;hooks/duplex_hook.h&quot;
</a> 
 void JNICALL init(JNIEnv *env, jobject clazz) {
     LOGD(&quot;Initializing native&quot;);
<a href="#h15-1" id="h15-1" class="h">@@ -29,6 +30,7 @@ void JNICALL init(JNIEnv *env, jobject clazz) {
</a>     UnaryCallHook::init(env);
     FstatHook::init();
     SqliteMutexHook::init();
<a href="#h15-1-3" id="h15-1-3" class="i">+    DuplexHook::init(env);
</a> 
     LOGD(&quot;Native initialized&quot;);
 }
</pre>
</div>
</body>
</html>
