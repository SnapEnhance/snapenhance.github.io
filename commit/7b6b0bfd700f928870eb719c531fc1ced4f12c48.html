<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>feat: download section - SnapEnhance - An Xposed module offering an enhanced Snapchat experience
</title>
<link rel="icon" type="image/svg+xml" href="../../logo.png"/>
<link rel="alternate icon" href="../../favicon.png"/>
<link rel="alternate" type="application/atom+xml" title="SnapEnhance Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="SnapEnhance Atom Feed (tags)" href="../tags.xml" />
<link rel="stylesheet" type="text/css" href="../../style.css" />
<link rel="stylesheet" type="text/css" href="../../fonts.css" />
</head>
<body>
<div id="head"><table><tr><td><a class="logo" href="../../"><img src="../../logo.png" alt="" width="32" height="32" /></a></td><td><strong>SnapEnhance</strong><span class="desc"> - An Xposed module offering an enhanced Snapchat experience
</span>
</td></tr></table>
<p><a href="../about.html">About</a> | <a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/LICENSE.html">License</a></p>
</div>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/7b6b0bfd700f928870eb719c531fc1ced4f12c48.html">7b6b0bfd700f928870eb719c531fc1ced4f12c48</a>
<b>parent</b> <a href="../commit/e6e75123f85f21e4405769ff97c7712505be533e.html">e6e75123f85f21e4405769ff97c7712505be533e</a>
<b>Author:</b> rhunk &lt;<a href="mailto:101876869+rhunk@users.noreply.github.com">101876869+rhunk@users.noreply.github.com</a>&gt;
<b>Date:</b>   Sat,  5 Aug 2023 19:34:31 +0200

feat: download section

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">app/build.gradle.kts</a></td><td> | </td><td class="num">5</td><td><span class="i">++++</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadProcessor.kt</a></td><td> | </td><td class="num">39</td><td><span class="i">+++++++++++++++++++</span><span class="d">--------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h2">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/Navigation.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h3">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/Section.kt</a></td><td> | </td><td class="num">8</td><td><span class="i">++++++</span><span class="d">--</span></td></tr>
<tr><td class="D">D</td><td><a href="#h4">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/download/DownloadSection.kt</a></td><td> | </td><td class="num">13</td><td><span class="i"></span><span class="d">-------------</span></td></tr>
<tr><td class="A">A</td><td><a href="#h5">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/downloads/DownloadsSection.kt</a></td><td> | </td><td class="num">297</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h6">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/features/FeaturesSection.kt</a></td><td> | </td><td class="num">9</td><td><span class="i">++++</span><span class="d">-----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h7">app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/screens/impl/MappingsScreen.kt</a></td><td> | </td><td class="num">4</td><td><span class="i">++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h8">app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/screens/impl/PickLanguageScreen.kt</a></td><td> | </td><td class="num">5</td><td><span class="i">++</span><span class="d">---</span></td></tr>
<tr><td class="R">R</td><td><a href="#h9">core/src/main/res/drawable/bitmoji_blank.xml -&gt; app/src/main/res/drawable/bitmoji_blank.xml</a></td><td> | </td><td class="num">0</td><td><span class="i"></span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h10">core/src/main/kotlin/me/rhunk/snapenhance/download/DownloadTaskManager.kt</a></td><td> | </td><td class="num">42</td><td><span class="i">++++++++++++++++++++++</span><span class="d">--------------------</span></td></tr>
<tr><td class="A">A</td><td><a href="#h11">core/src/main/kotlin/me/rhunk/snapenhance/download/data/DownloadObject.kt</a></td><td> | </td><td class="num">32</td><td><span class="i">++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="D">D</td><td><a href="#h12">core/src/main/kotlin/me/rhunk/snapenhance/download/data/PendingDownload.kt</a></td><td> | </td><td class="num">33</td><td><span class="i"></span><span class="d">---------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h13">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/MediaDownloader.kt</a></td><td> | </td><td class="num">8</td><td><span class="i">++++</span><span class="d">----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h14">core/src/main/kotlin/me/rhunk/snapenhance/ui/download/DownloadListAdapter.kt</a></td><td> | </td><td class="num">10</td><td><span class="i">+++++</span><span class="d">-----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h15">core/src/main/kotlin/me/rhunk/snapenhance/ui/download/DownloadManagerActivity.kt</a></td><td> | </td><td class="num">6</td><td><span class="i">+++</span><span class="d">---</span></td></tr>
<tr><td class="M">M</td><td><a href="#h16">core/src/main/kotlin/me/rhunk/snapenhance/ui/download/MediaFilter.kt</a></td><td> | </td><td class="num">16</td><td><span class="i">++++++++</span><span class="d">--------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h17">core/src/main/kotlin/me/rhunk/snapenhance/util/snap/PreviewUtils.kt</a></td><td> | </td><td class="num">4</td><td><span class="i">+</span><span class="d">---</span></td></tr>
<tr><td class="M">M</td><td><a href="#h18">gradle/libs.versions.toml</a></td><td> | </td><td class="num">10</td><td><span class="i">+++++++</span><span class="d">---</span></td></tr>
</table></pre><pre>19 files changed, 418 insertions(+), 125 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/app/build.gradle.kts.html">app/build.gradle.kts</a> b/<a href="../file/app/build.gradle.kts.html">app/build.gradle.kts</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -91,13 +91,16 @@ android {
</a> 
 dependencies {
     implementation(project(&quot;:core&quot;))
<a href="#h0-0-3" id="h0-0-3" class="i">+    implementation(libs.androidx.material.icons.core)
</a><a href="#h0-0-4" id="h0-0-4" class="i">+    implementation(libs.androidx.material.ripple)
</a>     implementation(libs.androidx.material.icons.extended)
     implementation(libs.androidx.material3)
<a href="#h0-0-7" id="h0-0-7" class="d">-    implementation(libs.androidx.material)
</a>     implementation(libs.androidx.activity.ktx)
     implementation(libs.androidx.navigation.compose)
     implementation(libs.androidx.documentfile)
     implementation(libs.gson)
<a href="#h0-0-12" id="h0-0-12" class="i">+    implementation(libs.coil.compose)
</a><a href="#h0-0-13" id="h0-0-13" class="i">+    implementation(libs.coil.video)
</a> 
     debugImplementation(&quot;androidx.compose.ui:ui-tooling:1.4.3&quot;)
     implementation(&quot;androidx.compose.ui:ui-tooling-preview:1.4.3&quot;)
<b>diff --git a/<a id="h1" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadProcessor.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadProcessor.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadProcessor.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadProcessor.kt</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -16,16 +16,15 @@ import kotlinx.coroutines.runBlocking
</a> import me.rhunk.snapenhance.Constants
 import me.rhunk.snapenhance.Logger
 import me.rhunk.snapenhance.RemoteSideContext
<a href="#h1-0-3" id="h1-0-3" class="d">-import me.rhunk.snapenhance.SharedContext
</a> import me.rhunk.snapenhance.bridge.DownloadCallback
 import me.rhunk.snapenhance.data.FileType
 import me.rhunk.snapenhance.download.data.DownloadMediaType
 import me.rhunk.snapenhance.download.data.DownloadMetadata
<a href="#h1-0-8" id="h1-0-8" class="i">+import me.rhunk.snapenhance.download.data.DownloadObject
</a> import me.rhunk.snapenhance.download.data.DownloadRequest
 import me.rhunk.snapenhance.download.data.DownloadStage
 import me.rhunk.snapenhance.download.data.InputMedia
 import me.rhunk.snapenhance.download.data.MediaEncryptionKeyPair
<a href="#h1-0-13" id="h1-0-13" class="d">-import me.rhunk.snapenhance.download.data.PendingDownload
</a> import me.rhunk.snapenhance.util.download.RemoteMediaResolver
 import me.rhunk.snapenhance.util.snap.MediaDownloaderHelper
 import java.io.File
<a href="#h1-1" id="h1-1" class="h">@@ -60,7 +59,7 @@ class DownloadProcessor (
</a> ) {
 
     private val translation by lazy {
<a href="#h1-1-3" id="h1-1-3" class="d">-        SharedContext.translation.getCategory(&quot;download_processor&quot;)
</a><a href="#h1-1-4" id="h1-1-4" class="i">+        remoteSideContext.translation.getCategory(&quot;download_processor&quot;)
</a>     }
 
     private val gson by lazy {
<a href="#h1-2" id="h1-2" class="h">@@ -118,7 +117,7 @@ class DownloadProcessor (
</a>     }
 
     @SuppressLint(&quot;UnspecifiedRegisterReceiverFlag&quot;)
<a href="#h1-2-3" id="h1-2-3" class="d">-    private suspend fun saveMediaToGallery(inputFile: File, pendingDownload: PendingDownload) {
</a><a href="#h1-2-4" id="h1-2-4" class="i">+    private suspend fun saveMediaToGallery(inputFile: File, downloadObject: DownloadObject) {
</a>         if (coroutineContext.job.isCancelled) return
 
         runCatching {
<a href="#h1-3" id="h1-3" class="h">@@ -128,12 +127,12 @@ class DownloadProcessor (
</a>                 return
             }
 
<a href="#h1-3-3" id="h1-3-3" class="d">-            val fileName = pendingDownload.metadata.outputPath.substringAfterLast(&quot;/&quot;) + &quot;.&quot; + fileType.fileExtension
</a><a href="#h1-3-4" id="h1-3-4" class="i">+            val fileName = downloadObject.metadata.outputPath.substringAfterLast(&quot;/&quot;) + &quot;.&quot; + fileType.fileExtension
</a> 
             val outputFolder = DocumentFile.fromTreeUri(remoteSideContext.androidContext, Uri.parse(remoteSideContext.config.root.downloader.saveFolder.get()))
                 ?: throw Exception(&quot;Failed to open output folder&quot;)
 
<a href="#h1-3-9" id="h1-3-9" class="d">-            val outputFileFolder = pendingDownload.metadata.outputPath.let {
</a><a href="#h1-3-10" id="h1-3-10" class="i">+            val outputFileFolder = downloadObject.metadata.outputPath.let {
</a>                 if (it.contains(&quot;/&quot;)) {
                     it.substringBeforeLast(&quot;/&quot;).split(&quot;/&quot;).fold(outputFolder) { folder, name -&gt;
                         folder.findFile(name) ?: folder.createDirectory(name)!!
<a href="#h1-4" id="h1-4" class="h">@@ -150,8 +149,8 @@ class DownloadProcessor (
</a>                 inputStream.copyTo(outputStream)
             }
 
<a href="#h1-4-3" id="h1-4-3" class="d">-            pendingDownload.outputFile = outputFile.uri.toString()
</a><a href="#h1-4-4" id="h1-4-4" class="d">-            pendingDownload.downloadStage = DownloadStage.SAVED
</a><a href="#h1-4-5" id="h1-4-5" class="i">+            downloadObject.outputFile = outputFile.uri.toString()
</a><a href="#h1-4-6" id="h1-4-6" class="i">+            downloadObject.downloadStage = DownloadStage.SAVED
</a> 
             runCatching {
                 val mediaScanIntent = Intent(&quot;android.intent.action.MEDIA_SCANNER_SCAN_FILE&quot;)
<a href="#h1-5" id="h1-5" class="h">@@ -167,7 +166,7 @@ class DownloadProcessor (
</a>         }.onFailure { exception -&gt;
             Logger.error(exception)
             callbackOnFailure(translation.format(&quot;failed_gallery_toast&quot;, &quot;error&quot; to exception.toString()), exception.message)
<a href="#h1-5-3" id="h1-5-3" class="d">-            pendingDownload.downloadStage = DownloadStage.FAILED
</a><a href="#h1-5-4" id="h1-5-4" class="i">+            downloadObject.downloadStage = DownloadStage.FAILED
</a>         }
     }
 
<a href="#h1-6" id="h1-6" class="h">@@ -226,13 +225,13 @@ class DownloadProcessor (
</a>         downloadedMedias
     }
 
<a href="#h1-6-3" id="h1-6-3" class="d">-    private suspend fun downloadRemoteMedia(pendingDownloadObject: PendingDownload, downloadedMedias: Map&lt;InputMedia, DownloadedFile&gt;, downloadRequest: DownloadRequest) {
</a><a href="#h1-6-4" id="h1-6-4" class="i">+    private suspend fun downloadRemoteMedia(downloadObjectObject: DownloadObject, downloadedMedias: Map&lt;InputMedia, DownloadedFile&gt;, downloadRequest: DownloadRequest) {
</a>         downloadRequest.inputMedias.first().let { inputMedia -&gt;
             val mediaType = inputMedia.type
             val media = downloadedMedias[inputMedia]!!
 
             if (!downloadRequest.isDashPlaylist) {
<a href="#h1-6-10" id="h1-6-10" class="d">-                saveMediaToGallery(media.file, pendingDownloadObject)
</a><a href="#h1-6-11" id="h1-6-11" class="i">+                saveMediaToGallery(media.file, downloadObjectObject)
</a>                 media.file.delete()
                 return
             }
<a href="#h1-7" id="h1-7" class="h">@@ -261,12 +260,12 @@ class DownloadProcessor (
</a>                     output = outputFile,
                     startTime = dashOptions.offsetTime,
                     duration = dashOptions.duration)
<a href="#h1-7-3" id="h1-7-3" class="d">-                saveMediaToGallery(outputFile, pendingDownloadObject)
</a><a href="#h1-7-4" id="h1-7-4" class="i">+                saveMediaToGallery(outputFile, downloadObjectObject)
</a>             }.onFailure { exception -&gt;
                 if (coroutineContext.job.isCancelled) return@onFailure
                 Logger.error(exception)
                 callbackOnFailure(translation.format(&quot;failed_processing_toast&quot;, &quot;error&quot; to exception.toString()), exception.message)
<a href="#h1-7-9" id="h1-7-9" class="d">-                pendingDownloadObject.downloadStage = DownloadStage.FAILED
</a><a href="#h1-7-10" id="h1-7-10" class="i">+                downloadObjectObject.downloadStage = DownloadStage.FAILED
</a>             }
 
             dashPlaylistFile.delete()
<a href="#h1-8" id="h1-8" class="h">@@ -297,11 +296,11 @@ class DownloadProcessor (
</a>                 return@launch
             }
 
<a href="#h1-8-3" id="h1-8-3" class="d">-            val pendingDownloadObject = PendingDownload(
</a><a href="#h1-8-4" id="h1-8-4" class="i">+            val downloadObjectObject = DownloadObject(
</a>                 metadata = downloadMetadata
             ).apply { downloadTaskManager = remoteSideContext.downloadTaskManager }
 
<a href="#h1-8-8" id="h1-8-8" class="d">-            pendingDownloadObject.also {
</a><a href="#h1-8-9" id="h1-8-9" class="i">+            downloadObjectObject.also {
</a>                 remoteSideContext.downloadTaskManager.addTask(it)
             }.apply {
                 job = coroutineContext.job
<a href="#h1-9" id="h1-9" class="h">@@ -345,7 +344,7 @@ class DownloadProcessor (
</a>                     val mergedOverlay: File = File.createTempFile(&quot;merged&quot;, &quot;.&quot; + media.fileType.fileExtension)
                     runCatching {
                         callbackOnProgress(translation.format(&quot;download_toast&quot;, &quot;path&quot; to media.file.nameWithoutExtension))
<a href="#h1-9-3" id="h1-9-3" class="d">-                        pendingDownloadObject.downloadStage = DownloadStage.MERGING
</a><a href="#h1-9-4" id="h1-9-4" class="i">+                        downloadObjectObject.downloadStage = DownloadStage.MERGING
</a> 
                         MediaDownloaderHelper.mergeOverlayFile(
                             media = renamedMedia,
<a href="#h1-10" id="h1-10" class="h">@@ -353,12 +352,12 @@ class DownloadProcessor (
</a>                             output = mergedOverlay
                         )
 
<a href="#h1-10-3" id="h1-10-3" class="d">-                        saveMediaToGallery(mergedOverlay, pendingDownloadObject)
</a><a href="#h1-10-4" id="h1-10-4" class="i">+                        saveMediaToGallery(mergedOverlay, downloadObjectObject)
</a>                     }.onFailure { exception -&gt;
                         if (coroutineContext.job.isCancelled) return@onFailure
                         Logger.error(exception)
                         callbackOnFailure(translation.format(&quot;failed_processing_toast&quot;, &quot;error&quot; to exception.toString()), exception.message)
<a href="#h1-10-9" id="h1-10-9" class="d">-                        pendingDownloadObject.downloadStage = DownloadStage.MERGE_FAILED
</a><a href="#h1-10-10" id="h1-10-10" class="i">+                        downloadObjectObject.downloadStage = DownloadStage.MERGE_FAILED
</a>                     }
 
                     mergedOverlay.delete()
<a href="#h1-11" id="h1-11" class="h">@@ -367,9 +366,9 @@ class DownloadProcessor (
</a>                     return@launch
                 }
 
<a href="#h1-11-3" id="h1-11-3" class="d">-                downloadRemoteMedia(pendingDownloadObject, downloadedMedias, downloadRequest)
</a><a href="#h1-11-4" id="h1-11-4" class="i">+                downloadRemoteMedia(downloadObjectObject, downloadedMedias, downloadRequest)
</a>             }.onFailure { exception -&gt;
<a href="#h1-11-6" id="h1-11-6" class="d">-                pendingDownloadObject.downloadStage = DownloadStage.FAILED
</a><a href="#h1-11-7" id="h1-11-7" class="i">+                downloadObjectObject.downloadStage = DownloadStage.FAILED
</a>                 Logger.error(exception)
                 callbackOnFailure(translation[&quot;failed_generic_toast&quot;], exception.message)
             }
<b>diff --git a/<a id="h2" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/Navigation.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/Navigation.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/Navigation.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/Navigation.kt</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -71,6 +71,8 @@ class Navigation(
</a>                     Icon(Icons.Filled.ArrowBack, contentDescription = null)
                 }
             }
<a href="#h2-0-3" id="h2-0-3" class="i">+        }, actions = {
</a><a href="#h2-0-4" id="h2-0-4" class="i">+            currentSection.TopBarActions(this)
</a>         })
     }
 
<b>diff --git a/<a id="h3" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/Section.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/Section.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/Section.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/Section.kt</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -1,5 +1,6 @@
</a> package me.rhunk.snapenhance.ui.manager
 
<a href="#h3-0-2" id="h3-0-2" class="i">+import androidx.compose.foundation.layout.RowScope
</a> import androidx.compose.material.icons.Icons
 import androidx.compose.material.icons.filled.BugReport
 import androidx.compose.material.icons.filled.Download
<a href="#h3-1" id="h3-1" class="h">@@ -14,7 +15,7 @@ import androidx.navigation.compose.composable
</a> import me.rhunk.snapenhance.RemoteSideContext
 import me.rhunk.snapenhance.ui.manager.sections.HomeSection
 import me.rhunk.snapenhance.ui.manager.sections.NotImplemented
<a href="#h3-1-3" id="h3-1-3" class="d">-import me.rhunk.snapenhance.ui.manager.sections.download.DownloadSection
</a><a href="#h3-1-4" id="h3-1-4" class="i">+import me.rhunk.snapenhance.ui.manager.sections.downloads.DownloadsSection
</a> import me.rhunk.snapenhance.ui.manager.sections.features.FeaturesSection
 import kotlin.reflect.KClass
 
<a href="#h3-2" id="h3-2" class="h">@@ -26,7 +27,7 @@ enum class EnumSection(
</a>     DOWNLOADS(
         route = &quot;downloads&quot;,
         icon = Icons.Filled.Download,
<a href="#h3-2-3" id="h3-2-3" class="d">-        section = DownloadSection::class
</a><a href="#h3-2-4" id="h3-2-4" class="i">+        section = DownloadsSection::class
</a>     ),
     FEATURES(
         route = &quot;features&quot;,
<a href="#h3-3" id="h3-3" class="h">@@ -70,6 +71,9 @@ open class Section {
</a>     @Composable
     open fun Content() { NotImplemented() }
 
<a href="#h3-3-3" id="h3-3-3" class="i">+    @Composable
</a><a href="#h3-3-4" id="h3-3-4" class="i">+    open fun TopBarActions(rowScope: RowScope) {}
</a><a href="#h3-3-5" id="h3-3-5" class="i">+
</a>     open fun build(navGraphBuilder: NavGraphBuilder) {
         navGraphBuilder.composable(enumSection.route) {
             Content()
<b>diff --git a/<a id="h4" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/download/DownloadSection.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/download/DownloadSection.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/download/DownloadSection.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/download/DownloadSection.kt</a></b>
<a href="#h4-0" id="h4-0" class="h">@@ -1,12 +0,0 @@
</a><a href="#h4-0-0" id="h4-0-0" class="d">-package me.rhunk.snapenhance.ui.manager.sections.download
</a><a href="#h4-0-1" id="h4-0-1" class="d">-
</a><a href="#h4-0-2" id="h4-0-2" class="d">-import androidx.compose.runtime.Composable
</a><a href="#h4-0-3" id="h4-0-3" class="d">-import me.rhunk.snapenhance.ui.manager.Section
</a><a href="#h4-0-4" id="h4-0-4" class="d">-import me.rhunk.snapenhance.ui.manager.sections.NotImplemented
</a><a href="#h4-0-5" id="h4-0-5" class="d">-
</a><a href="#h4-0-6" id="h4-0-6" class="d">-class DownloadSection : Section() {
</a><a href="#h4-0-7" id="h4-0-7" class="d">-    @Composable
</a><a href="#h4-0-8" id="h4-0-8" class="d">-    override fun Content() {
</a><a href="#h4-0-9" id="h4-0-9" class="d">-        NotImplemented()
</a><a href="#h4-0-10" id="h4-0-10" class="d">-    }
</a><a href="#h4-0-11" id="h4-0-11" class="d">-}</a><a href="#h4-0-12" id="h4-0-12" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h5" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/downloads/DownloadsSection.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/downloads/DownloadsSection.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/downloads/DownloadsSection.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/downloads/DownloadsSection.kt</a></b>
<a href="#h5-0" id="h5-0" class="h">@@ -0,0 +1,296 @@
</a><a href="#h5-0-0" id="h5-0-0" class="i">+package me.rhunk.snapenhance.ui.manager.sections.downloads
</a><a href="#h5-0-1" id="h5-0-1" class="i">+
</a><a href="#h5-0-2" id="h5-0-2" class="i">+import android.content.Intent
</a><a href="#h5-0-3" id="h5-0-3" class="i">+import android.net.Uri
</a><a href="#h5-0-4" id="h5-0-4" class="i">+import androidx.compose.foundation.Image
</a><a href="#h5-0-5" id="h5-0-5" class="i">+import androidx.compose.foundation.background
</a><a href="#h5-0-6" id="h5-0-6" class="i">+import androidx.compose.foundation.layout.Arrangement
</a><a href="#h5-0-7" id="h5-0-7" class="i">+import androidx.compose.foundation.layout.Box
</a><a href="#h5-0-8" id="h5-0-8" class="i">+import androidx.compose.foundation.layout.Column
</a><a href="#h5-0-9" id="h5-0-9" class="i">+import androidx.compose.foundation.layout.Row
</a><a href="#h5-0-10" id="h5-0-10" class="i">+import androidx.compose.foundation.layout.RowScope
</a><a href="#h5-0-11" id="h5-0-11" class="i">+import androidx.compose.foundation.layout.Spacer
</a><a href="#h5-0-12" id="h5-0-12" class="i">+import androidx.compose.foundation.layout.fillMaxHeight
</a><a href="#h5-0-13" id="h5-0-13" class="i">+import androidx.compose.foundation.layout.fillMaxSize
</a><a href="#h5-0-14" id="h5-0-14" class="i">+import androidx.compose.foundation.layout.fillMaxWidth
</a><a href="#h5-0-15" id="h5-0-15" class="i">+import androidx.compose.foundation.layout.height
</a><a href="#h5-0-16" id="h5-0-16" class="i">+import androidx.compose.foundation.layout.padding
</a><a href="#h5-0-17" id="h5-0-17" class="i">+import androidx.compose.foundation.layout.requiredWidthIn
</a><a href="#h5-0-18" id="h5-0-18" class="i">+import androidx.compose.foundation.lazy.LazyColumn
</a><a href="#h5-0-19" id="h5-0-19" class="i">+import androidx.compose.foundation.lazy.rememberLazyListState
</a><a href="#h5-0-20" id="h5-0-20" class="i">+import androidx.compose.material.icons.Icons
</a><a href="#h5-0-21" id="h5-0-21" class="i">+import androidx.compose.material.icons.filled.Delete
</a><a href="#h5-0-22" id="h5-0-22" class="i">+import androidx.compose.material.icons.filled.FilterList
</a><a href="#h5-0-23" id="h5-0-23" class="i">+import androidx.compose.material.icons.filled.OpenInNew
</a><a href="#h5-0-24" id="h5-0-24" class="i">+import androidx.compose.material3.Card
</a><a href="#h5-0-25" id="h5-0-25" class="i">+import androidx.compose.material3.DropdownMenu
</a><a href="#h5-0-26" id="h5-0-26" class="i">+import androidx.compose.material3.DropdownMenuItem
</a><a href="#h5-0-27" id="h5-0-27" class="i">+import androidx.compose.material3.FilledIconButton
</a><a href="#h5-0-28" id="h5-0-28" class="i">+import androidx.compose.material3.Icon
</a><a href="#h5-0-29" id="h5-0-29" class="i">+import androidx.compose.material3.IconButton
</a><a href="#h5-0-30" id="h5-0-30" class="i">+import androidx.compose.material3.IconButtonDefaults
</a><a href="#h5-0-31" id="h5-0-31" class="i">+import androidx.compose.material3.MaterialTheme
</a><a href="#h5-0-32" id="h5-0-32" class="i">+import androidx.compose.material3.RadioButton
</a><a href="#h5-0-33" id="h5-0-33" class="i">+import androidx.compose.material3.Text
</a><a href="#h5-0-34" id="h5-0-34" class="i">+import androidx.compose.runtime.Composable
</a><a href="#h5-0-35" id="h5-0-35" class="i">+import androidx.compose.runtime.LaunchedEffect
</a><a href="#h5-0-36" id="h5-0-36" class="i">+import androidx.compose.runtime.mutableStateOf
</a><a href="#h5-0-37" id="h5-0-37" class="i">+import androidx.compose.runtime.remember
</a><a href="#h5-0-38" id="h5-0-38" class="i">+import androidx.compose.runtime.rememberCoroutineScope
</a><a href="#h5-0-39" id="h5-0-39" class="i">+import androidx.compose.ui.Alignment
</a><a href="#h5-0-40" id="h5-0-40" class="i">+import androidx.compose.ui.Modifier
</a><a href="#h5-0-41" id="h5-0-41" class="i">+import androidx.compose.ui.draw.blur
</a><a href="#h5-0-42" id="h5-0-42" class="i">+import androidx.compose.ui.draw.clip
</a><a href="#h5-0-43" id="h5-0-43" class="i">+import androidx.compose.ui.layout.ContentScale
</a><a href="#h5-0-44" id="h5-0-44" class="i">+import androidx.compose.ui.text.font.FontWeight
</a><a href="#h5-0-45" id="h5-0-45" class="i">+import androidx.compose.ui.text.style.TextAlign
</a><a href="#h5-0-46" id="h5-0-46" class="i">+import androidx.compose.ui.text.style.TextOverflow
</a><a href="#h5-0-47" id="h5-0-47" class="i">+import androidx.compose.ui.unit.dp
</a><a href="#h5-0-48" id="h5-0-48" class="i">+import androidx.compose.ui.unit.sp
</a><a href="#h5-0-49" id="h5-0-49" class="i">+import coil.ImageLoader
</a><a href="#h5-0-50" id="h5-0-50" class="i">+import coil.compose.rememberAsyncImagePainter
</a><a href="#h5-0-51" id="h5-0-51" class="i">+import coil.decode.VideoFrameDecoder
</a><a href="#h5-0-52" id="h5-0-52" class="i">+import coil.memory.MemoryCache
</a><a href="#h5-0-53" id="h5-0-53" class="i">+import coil.request.ImageRequest
</a><a href="#h5-0-54" id="h5-0-54" class="i">+import kotlinx.coroutines.Dispatchers
</a><a href="#h5-0-55" id="h5-0-55" class="i">+import kotlinx.coroutines.launch
</a><a href="#h5-0-56" id="h5-0-56" class="i">+import me.rhunk.snapenhance.R
</a><a href="#h5-0-57" id="h5-0-57" class="i">+import me.rhunk.snapenhance.data.FileType
</a><a href="#h5-0-58" id="h5-0-58" class="i">+import me.rhunk.snapenhance.download.data.DownloadObject
</a><a href="#h5-0-59" id="h5-0-59" class="i">+import me.rhunk.snapenhance.ui.download.MediaFilter
</a><a href="#h5-0-60" id="h5-0-60" class="i">+import me.rhunk.snapenhance.ui.manager.Section
</a><a href="#h5-0-61" id="h5-0-61" class="i">+
</a><a href="#h5-0-62" id="h5-0-62" class="i">+class DownloadsSection : Section() {
</a><a href="#h5-0-63" id="h5-0-63" class="i">+    private val loadedDownloads = mutableStateOf(mapOf&lt;Int, DownloadObject&gt;())
</a><a href="#h5-0-64" id="h5-0-64" class="i">+    private var currentFilter = mutableStateOf(MediaFilter.NONE)
</a><a href="#h5-0-65" id="h5-0-65" class="i">+
</a><a href="#h5-0-66" id="h5-0-66" class="i">+    private val imageLoader by lazy {
</a><a href="#h5-0-67" id="h5-0-67" class="i">+        ImageLoader.Builder(context.androidContext)
</a><a href="#h5-0-68" id="h5-0-68" class="i">+            .dispatcher(Dispatchers.IO)
</a><a href="#h5-0-69" id="h5-0-69" class="i">+            .memoryCache {
</a><a href="#h5-0-70" id="h5-0-70" class="i">+                MemoryCache.Builder(context.androidContext)
</a><a href="#h5-0-71" id="h5-0-71" class="i">+                    .maxSizePercent(0.25)
</a><a href="#h5-0-72" id="h5-0-72" class="i">+                    .build()
</a><a href="#h5-0-73" id="h5-0-73" class="i">+            }.components { add(VideoFrameDecoder.Factory()) }.build()
</a><a href="#h5-0-74" id="h5-0-74" class="i">+    }
</a><a href="#h5-0-75" id="h5-0-75" class="i">+
</a><a href="#h5-0-76" id="h5-0-76" class="i">+    override fun onResumed() {
</a><a href="#h5-0-77" id="h5-0-77" class="i">+        super.onResumed()
</a><a href="#h5-0-78" id="h5-0-78" class="i">+        loadByFilter(currentFilter.value)
</a><a href="#h5-0-79" id="h5-0-79" class="i">+    }
</a><a href="#h5-0-80" id="h5-0-80" class="i">+
</a><a href="#h5-0-81" id="h5-0-81" class="i">+    private fun loadByFilter(filter: MediaFilter) {
</a><a href="#h5-0-82" id="h5-0-82" class="i">+        this.currentFilter.value = filter
</a><a href="#h5-0-83" id="h5-0-83" class="i">+        synchronized(loadedDownloads) {
</a><a href="#h5-0-84" id="h5-0-84" class="i">+            loadedDownloads.value = context.downloadTaskManager.queryFirstTasks(filter)
</a><a href="#h5-0-85" id="h5-0-85" class="i">+        }
</a><a href="#h5-0-86" id="h5-0-86" class="i">+    }
</a><a href="#h5-0-87" id="h5-0-87" class="i">+
</a><a href="#h5-0-88" id="h5-0-88" class="i">+    private fun lazyLoadFromIndex(lastIndex: Int) {
</a><a href="#h5-0-89" id="h5-0-89" class="i">+        synchronized(loadedDownloads) {
</a><a href="#h5-0-90" id="h5-0-90" class="i">+            loadedDownloads.value = loadedDownloads.value.toMutableMap().also {
</a><a href="#h5-0-91" id="h5-0-91" class="i">+                val lastVisible = loadedDownloads.value.values.elementAt(lastIndex)
</a><a href="#h5-0-92" id="h5-0-92" class="i">+                it += context.downloadTaskManager.queryTasks(
</a><a href="#h5-0-93" id="h5-0-93" class="i">+                    from = lastVisible.downloadId,
</a><a href="#h5-0-94" id="h5-0-94" class="i">+                    filter = currentFilter.value
</a><a href="#h5-0-95" id="h5-0-95" class="i">+                )
</a><a href="#h5-0-96" id="h5-0-96" class="i">+            }
</a><a href="#h5-0-97" id="h5-0-97" class="i">+        }
</a><a href="#h5-0-98" id="h5-0-98" class="i">+    }
</a><a href="#h5-0-99" id="h5-0-99" class="i">+
</a><a href="#h5-0-100" id="h5-0-100" class="i">+    @Composable
</a><a href="#h5-0-101" id="h5-0-101" class="i">+    private fun FilterList() {
</a><a href="#h5-0-102" id="h5-0-102" class="i">+        val coroutineScope = rememberCoroutineScope()
</a><a href="#h5-0-103" id="h5-0-103" class="i">+        val showMenu = remember { mutableStateOf(false) }
</a><a href="#h5-0-104" id="h5-0-104" class="i">+        IconButton(onClick = { showMenu.value = !showMenu.value}) {
</a><a href="#h5-0-105" id="h5-0-105" class="i">+            Icon(
</a><a href="#h5-0-106" id="h5-0-106" class="i">+                imageVector = Icons.Default.FilterList,
</a><a href="#h5-0-107" id="h5-0-107" class="i">+                contentDescription = null
</a><a href="#h5-0-108" id="h5-0-108" class="i">+            )
</a><a href="#h5-0-109" id="h5-0-109" class="i">+        }
</a><a href="#h5-0-110" id="h5-0-110" class="i">+
</a><a href="#h5-0-111" id="h5-0-111" class="i">+        DropdownMenu(expanded = showMenu.value, onDismissRequest = { showMenu.value = false }) {
</a><a href="#h5-0-112" id="h5-0-112" class="i">+            MediaFilter.values().toList().forEach { filter -&gt;
</a><a href="#h5-0-113" id="h5-0-113" class="i">+                DropdownMenuItem(
</a><a href="#h5-0-114" id="h5-0-114" class="i">+                    text = {
</a><a href="#h5-0-115" id="h5-0-115" class="i">+                        Row(
</a><a href="#h5-0-116" id="h5-0-116" class="i">+                            modifier = Modifier
</a><a href="#h5-0-117" id="h5-0-117" class="i">+                                .fillMaxWidth(),
</a><a href="#h5-0-118" id="h5-0-118" class="i">+                            verticalAlignment = Alignment.CenterVertically
</a><a href="#h5-0-119" id="h5-0-119" class="i">+                        ) {
</a><a href="#h5-0-120" id="h5-0-120" class="i">+                            RadioButton(
</a><a href="#h5-0-121" id="h5-0-121" class="i">+                                modifier = Modifier.padding(end = 16.dp),
</a><a href="#h5-0-122" id="h5-0-122" class="i">+                                selected = (currentFilter.value == filter),
</a><a href="#h5-0-123" id="h5-0-123" class="i">+                                onClick = null
</a><a href="#h5-0-124" id="h5-0-124" class="i">+                            )
</a><a href="#h5-0-125" id="h5-0-125" class="i">+                            Text(filter.name, modifier = Modifier.weight(1f))
</a><a href="#h5-0-126" id="h5-0-126" class="i">+                        }
</a><a href="#h5-0-127" id="h5-0-127" class="i">+                   },
</a><a href="#h5-0-128" id="h5-0-128" class="i">+                    onClick = {
</a><a href="#h5-0-129" id="h5-0-129" class="i">+                        coroutineScope.launch {
</a><a href="#h5-0-130" id="h5-0-130" class="i">+                            loadByFilter(filter)
</a><a href="#h5-0-131" id="h5-0-131" class="i">+                            showMenu.value = false
</a><a href="#h5-0-132" id="h5-0-132" class="i">+                        }
</a><a href="#h5-0-133" id="h5-0-133" class="i">+                    }
</a><a href="#h5-0-134" id="h5-0-134" class="i">+                )
</a><a href="#h5-0-135" id="h5-0-135" class="i">+            }
</a><a href="#h5-0-136" id="h5-0-136" class="i">+        }
</a><a href="#h5-0-137" id="h5-0-137" class="i">+    }
</a><a href="#h5-0-138" id="h5-0-138" class="i">+
</a><a href="#h5-0-139" id="h5-0-139" class="i">+    @Composable
</a><a href="#h5-0-140" id="h5-0-140" class="i">+    override fun TopBarActions(rowScope: RowScope) {
</a><a href="#h5-0-141" id="h5-0-141" class="i">+        FilterList()
</a><a href="#h5-0-142" id="h5-0-142" class="i">+    }
</a><a href="#h5-0-143" id="h5-0-143" class="i">+
</a><a href="#h5-0-144" id="h5-0-144" class="i">+    @Composable
</a><a href="#h5-0-145" id="h5-0-145" class="i">+    private fun DownloadItem(download: DownloadObject) {
</a><a href="#h5-0-146" id="h5-0-146" class="i">+        Card(
</a><a href="#h5-0-147" id="h5-0-147" class="i">+            modifier = Modifier
</a><a href="#h5-0-148" id="h5-0-148" class="i">+                .padding(6.dp)
</a><a href="#h5-0-149" id="h5-0-149" class="i">+                .fillMaxWidth()
</a><a href="#h5-0-150" id="h5-0-150" class="i">+                .clip(MaterialTheme.shapes.medium)
</a><a href="#h5-0-151" id="h5-0-151" class="i">+        ) {
</a><a href="#h5-0-152" id="h5-0-152" class="i">+            Box(modifier = Modifier.height(120.dp)) {
</a><a href="#h5-0-153" id="h5-0-153" class="i">+                Image(
</a><a href="#h5-0-154" id="h5-0-154" class="i">+                    painter = rememberAsyncImagePainter(
</a><a href="#h5-0-155" id="h5-0-155" class="i">+                        model = ImageRequest.Builder(context.androidContext)
</a><a href="#h5-0-156" id="h5-0-156" class="i">+                            .data(download.outputFile)
</a><a href="#h5-0-157" id="h5-0-157" class="i">+                            .memoryCacheKey(download.outputFile)
</a><a href="#h5-0-158" id="h5-0-158" class="i">+                            .build(),
</a><a href="#h5-0-159" id="h5-0-159" class="i">+                        imageLoader = imageLoader
</a><a href="#h5-0-160" id="h5-0-160" class="i">+                    ),
</a><a href="#h5-0-161" id="h5-0-161" class="i">+                    modifier = Modifier
</a><a href="#h5-0-162" id="h5-0-162" class="i">+                        .matchParentSize()
</a><a href="#h5-0-163" id="h5-0-163" class="i">+                        .blur(5.dp),
</a><a href="#h5-0-164" id="h5-0-164" class="i">+                    contentDescription = null,
</a><a href="#h5-0-165" id="h5-0-165" class="i">+                    contentScale = ContentScale.FillWidth
</a><a href="#h5-0-166" id="h5-0-166" class="i">+                )
</a><a href="#h5-0-167" id="h5-0-167" class="i">+
</a><a href="#h5-0-168" id="h5-0-168" class="i">+                Row(
</a><a href="#h5-0-169" id="h5-0-169" class="i">+                    modifier = Modifier
</a><a href="#h5-0-170" id="h5-0-170" class="i">+                        .padding(start = 16.dp, end = 16.dp)
</a><a href="#h5-0-171" id="h5-0-171" class="i">+                        .fillMaxWidth()
</a><a href="#h5-0-172" id="h5-0-172" class="i">+                        .fillMaxHeight(),
</a><a href="#h5-0-173" id="h5-0-173" class="i">+                    verticalAlignment = Alignment.CenterVertically
</a><a href="#h5-0-174" id="h5-0-174" class="i">+                ){
</a><a href="#h5-0-175" id="h5-0-175" class="i">+                    //info card
</a><a href="#h5-0-176" id="h5-0-176" class="i">+                    Row(
</a><a href="#h5-0-177" id="h5-0-177" class="i">+                        modifier = Modifier
</a><a href="#h5-0-178" id="h5-0-178" class="i">+                            .background(
</a><a href="#h5-0-179" id="h5-0-179" class="i">+                                color = MaterialTheme.colorScheme.background,
</a><a href="#h5-0-180" id="h5-0-180" class="i">+                                shape = MaterialTheme.shapes.medium
</a><a href="#h5-0-181" id="h5-0-181" class="i">+                            )
</a><a href="#h5-0-182" id="h5-0-182" class="i">+                            .padding(15.dp),
</a><a href="#h5-0-183" id="h5-0-183" class="i">+                        verticalAlignment = Alignment.CenterVertically
</a><a href="#h5-0-184" id="h5-0-184" class="i">+                    ) {
</a><a href="#h5-0-185" id="h5-0-185" class="i">+                        Image(
</a><a href="#h5-0-186" id="h5-0-186" class="i">+                            painter = rememberAsyncImagePainter(
</a><a href="#h5-0-187" id="h5-0-187" class="i">+                                model = ImageRequest.Builder(context.androidContext)
</a><a href="#h5-0-188" id="h5-0-188" class="i">+                                    .data(download.metadata.iconUrl)
</a><a href="#h5-0-189" id="h5-0-189" class="i">+                                    .fallback(R.drawable.bitmoji_blank)
</a><a href="#h5-0-190" id="h5-0-190" class="i">+                                    .memoryCacheKey(download.metadata.iconUrl)
</a><a href="#h5-0-191" id="h5-0-191" class="i">+                                    .build(),
</a><a href="#h5-0-192" id="h5-0-192" class="i">+                                imageLoader = imageLoader
</a><a href="#h5-0-193" id="h5-0-193" class="i">+                            ),
</a><a href="#h5-0-194" id="h5-0-194" class="i">+                            contentDescription = null,
</a><a href="#h5-0-195" id="h5-0-195" class="i">+                            contentScale = ContentScale.Crop,
</a><a href="#h5-0-196" id="h5-0-196" class="i">+                            modifier = Modifier
</a><a href="#h5-0-197" id="h5-0-197" class="i">+                                .requiredWidthIn(min = 0.dp, max = 48.dp)
</a><a href="#h5-0-198" id="h5-0-198" class="i">+                                .height(48.dp)
</a><a href="#h5-0-199" id="h5-0-199" class="i">+                                .clip(MaterialTheme.shapes.medium)
</a><a href="#h5-0-200" id="h5-0-200" class="i">+                        )
</a><a href="#h5-0-201" id="h5-0-201" class="i">+
</a><a href="#h5-0-202" id="h5-0-202" class="i">+                        Column(
</a><a href="#h5-0-203" id="h5-0-203" class="i">+                            modifier = Modifier
</a><a href="#h5-0-204" id="h5-0-204" class="i">+                                .padding(start = 10.dp),
</a><a href="#h5-0-205" id="h5-0-205" class="i">+                            verticalArrangement = Arrangement.SpaceBetween
</a><a href="#h5-0-206" id="h5-0-206" class="i">+                        ) {
</a><a href="#h5-0-207" id="h5-0-207" class="i">+                            Text(
</a><a href="#h5-0-208" id="h5-0-208" class="i">+                                text = download.metadata.mediaDisplayType ?: &quot;&quot;,
</a><a href="#h5-0-209" id="h5-0-209" class="i">+                                overflow = TextOverflow.Ellipsis,
</a><a href="#h5-0-210" id="h5-0-210" class="i">+                                fontSize = 16.sp,
</a><a href="#h5-0-211" id="h5-0-211" class="i">+                                fontWeight = FontWeight.Bold
</a><a href="#h5-0-212" id="h5-0-212" class="i">+                            )
</a><a href="#h5-0-213" id="h5-0-213" class="i">+                            Text(
</a><a href="#h5-0-214" id="h5-0-214" class="i">+                                text = download.metadata.mediaDisplaySource ?: &quot;&quot;,
</a><a href="#h5-0-215" id="h5-0-215" class="i">+                                overflow = TextOverflow.Ellipsis,
</a><a href="#h5-0-216" id="h5-0-216" class="i">+                                fontSize = 12.sp,
</a><a href="#h5-0-217" id="h5-0-217" class="i">+                                fontWeight = FontWeight.Light
</a><a href="#h5-0-218" id="h5-0-218" class="i">+                            )
</a><a href="#h5-0-219" id="h5-0-219" class="i">+                        }
</a><a href="#h5-0-220" id="h5-0-220" class="i">+                    }
</a><a href="#h5-0-221" id="h5-0-221" class="i">+
</a><a href="#h5-0-222" id="h5-0-222" class="i">+                    Spacer(modifier = Modifier.weight(1f))
</a><a href="#h5-0-223" id="h5-0-223" class="i">+
</a><a href="#h5-0-224" id="h5-0-224" class="i">+                    //action buttons
</a><a href="#h5-0-225" id="h5-0-225" class="i">+                    Row(
</a><a href="#h5-0-226" id="h5-0-226" class="i">+                        modifier = Modifier
</a><a href="#h5-0-227" id="h5-0-227" class="i">+                            .padding(5.dp),
</a><a href="#h5-0-228" id="h5-0-228" class="i">+                        verticalAlignment = Alignment.CenterVertically
</a><a href="#h5-0-229" id="h5-0-229" class="i">+                    ) {
</a><a href="#h5-0-230" id="h5-0-230" class="i">+                        FilledIconButton(
</a><a href="#h5-0-231" id="h5-0-231" class="i">+                            onClick = {
</a><a href="#h5-0-232" id="h5-0-232" class="i">+                            },
</a><a href="#h5-0-233" id="h5-0-233" class="i">+                            colors = IconButtonDefaults.iconButtonColors(
</a><a href="#h5-0-234" id="h5-0-234" class="i">+                                containerColor = MaterialTheme.colorScheme.error,
</a><a href="#h5-0-235" id="h5-0-235" class="i">+                                contentColor = MaterialTheme.colorScheme.onError
</a><a href="#h5-0-236" id="h5-0-236" class="i">+                            )
</a><a href="#h5-0-237" id="h5-0-237" class="i">+                        ) {
</a><a href="#h5-0-238" id="h5-0-238" class="i">+                            Icon(
</a><a href="#h5-0-239" id="h5-0-239" class="i">+                                imageVector = Icons.Default.Delete,
</a><a href="#h5-0-240" id="h5-0-240" class="i">+                                contentDescription = null
</a><a href="#h5-0-241" id="h5-0-241" class="i">+                            )
</a><a href="#h5-0-242" id="h5-0-242" class="i">+                        }
</a><a href="#h5-0-243" id="h5-0-243" class="i">+                        //open
</a><a href="#h5-0-244" id="h5-0-244" class="i">+                        FilledIconButton(onClick = {
</a><a href="#h5-0-245" id="h5-0-245" class="i">+                            val fileType = runCatching {
</a><a href="#h5-0-246" id="h5-0-246" class="i">+                                context.androidContext.contentResolver.openInputStream(Uri.parse(download.outputFile))?.use { input -&gt;
</a><a href="#h5-0-247" id="h5-0-247" class="i">+                                    FileType.fromInputStream(input)
</a><a href="#h5-0-248" id="h5-0-248" class="i">+                                }
</a><a href="#h5-0-249" id="h5-0-249" class="i">+                            }.getOrNull() ?: FileType.UNKNOWN
</a><a href="#h5-0-250" id="h5-0-250" class="i">+
</a><a href="#h5-0-251" id="h5-0-251" class="i">+                            val intent = Intent(Intent.ACTION_VIEW).apply {
</a><a href="#h5-0-252" id="h5-0-252" class="i">+                                setDataAndType(Uri.parse(download.outputFile), fileType.mimeType)
</a><a href="#h5-0-253" id="h5-0-253" class="i">+                                flags = Intent.FLAG_ACTIVITY_NEW_TASK or Intent.FLAG_GRANT_READ_URI_PERMISSION
</a><a href="#h5-0-254" id="h5-0-254" class="i">+                            }
</a><a href="#h5-0-255" id="h5-0-255" class="i">+                            context.androidContext.startActivity(intent)
</a><a href="#h5-0-256" id="h5-0-256" class="i">+                        }) {
</a><a href="#h5-0-257" id="h5-0-257" class="i">+                            Icon(
</a><a href="#h5-0-258" id="h5-0-258" class="i">+                                imageVector = Icons.Default.OpenInNew,
</a><a href="#h5-0-259" id="h5-0-259" class="i">+                                contentDescription = null
</a><a href="#h5-0-260" id="h5-0-260" class="i">+                            )
</a><a href="#h5-0-261" id="h5-0-261" class="i">+                        }
</a><a href="#h5-0-262" id="h5-0-262" class="i">+                    }
</a><a href="#h5-0-263" id="h5-0-263" class="i">+                }
</a><a href="#h5-0-264" id="h5-0-264" class="i">+            }
</a><a href="#h5-0-265" id="h5-0-265" class="i">+        }
</a><a href="#h5-0-266" id="h5-0-266" class="i">+    }
</a><a href="#h5-0-267" id="h5-0-267" class="i">+
</a><a href="#h5-0-268" id="h5-0-268" class="i">+    @Composable
</a><a href="#h5-0-269" id="h5-0-269" class="i">+    override fun Content() {
</a><a href="#h5-0-270" id="h5-0-270" class="i">+        val scrollState = rememberLazyListState()
</a><a href="#h5-0-271" id="h5-0-271" class="i">+
</a><a href="#h5-0-272" id="h5-0-272" class="i">+        LazyColumn(
</a><a href="#h5-0-273" id="h5-0-273" class="i">+            state = scrollState,
</a><a href="#h5-0-274" id="h5-0-274" class="i">+            modifier = Modifier.fillMaxSize()
</a><a href="#h5-0-275" id="h5-0-275" class="i">+        ) {
</a><a href="#h5-0-276" id="h5-0-276" class="i">+            items(loadedDownloads.value.size) { index -&gt;
</a><a href="#h5-0-277" id="h5-0-277" class="i">+                DownloadItem(loadedDownloads.value.values.elementAt(index))
</a><a href="#h5-0-278" id="h5-0-278" class="i">+            }
</a><a href="#h5-0-279" id="h5-0-279" class="i">+
</a><a href="#h5-0-280" id="h5-0-280" class="i">+            item {
</a><a href="#h5-0-281" id="h5-0-281" class="i">+                Spacer(Modifier.height(20.dp))
</a><a href="#h5-0-282" id="h5-0-282" class="i">+                if (loadedDownloads.value.isEmpty()) {
</a><a href="#h5-0-283" id="h5-0-283" class="i">+                    Text(text = &quot;No downloads&quot;, fontSize = 20.sp, modifier = Modifier
</a><a href="#h5-0-284" id="h5-0-284" class="i">+                        .fillMaxWidth()
</a><a href="#h5-0-285" id="h5-0-285" class="i">+                        .padding(10.dp), textAlign = TextAlign.Center)
</a><a href="#h5-0-286" id="h5-0-286" class="i">+                }
</a><a href="#h5-0-287" id="h5-0-287" class="i">+                LaunchedEffect(true) {
</a><a href="#h5-0-288" id="h5-0-288" class="i">+                    val lastItemIndex = (loadedDownloads.value.size - 1).takeIf { it &gt;= 0 } ?: return@LaunchedEffect
</a><a href="#h5-0-289" id="h5-0-289" class="i">+                    lazyLoadFromIndex(lastItemIndex)
</a><a href="#h5-0-290" id="h5-0-290" class="i">+                    scrollState.animateScrollToItem(lastItemIndex)
</a><a href="#h5-0-291" id="h5-0-291" class="i">+                }
</a><a href="#h5-0-292" id="h5-0-292" class="i">+            }
</a><a href="#h5-0-293" id="h5-0-293" class="i">+        }
</a><a href="#h5-0-294" id="h5-0-294" class="i">+    }
</a><a href="#h5-0-295" id="h5-0-295" class="i">+}</a><a href="#h5-0-296" id="h5-0-296" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h6" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/features/FeaturesSection.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/features/FeaturesSection.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/features/FeaturesSection.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/features/FeaturesSection.kt</a></b>
<a href="#h6-0" id="h6-0" class="h">@@ -19,7 +19,6 @@ import androidx.compose.foundation.layout.wrapContentWidth
</a> import androidx.compose.foundation.lazy.LazyColumn
 import androidx.compose.foundation.lazy.items
 import androidx.compose.foundation.shape.RoundedCornerShape
<a href="#h6-0-3" id="h6-0-3" class="d">-import androidx.compose.material.MaterialTheme
</a> import androidx.compose.material.icons.Icons
 import androidx.compose.material.icons.filled.FolderOpen
 import androidx.compose.material.icons.filled.OpenInNew
<a href="#h6-1" id="h6-1" class="h">@@ -30,6 +29,7 @@ import androidx.compose.material3.FilledIconButton
</a> import androidx.compose.material3.FloatingActionButton
 import androidx.compose.material3.Icon
 import androidx.compose.material3.IconButton
<a href="#h6-1-3" id="h6-1-3" class="i">+import androidx.compose.material3.MaterialTheme
</a> import androidx.compose.material3.Scaffold
 import androidx.compose.material3.SnackbarHost
 import androidx.compose.material3.Switch
<a href="#h6-2" id="h6-2" class="h">@@ -46,7 +46,6 @@ import androidx.compose.ui.text.style.TextOverflow
</a> import androidx.compose.ui.unit.dp
 import androidx.compose.ui.unit.sp
 import androidx.compose.ui.window.Dialog
<a href="#h6-2-3" id="h6-2-3" class="d">-import androidx.compose.ui.window.DialogProperties
</a> import androidx.navigation.NavGraphBuilder
 import androidx.navigation.compose.composable
 import androidx.navigation.navigation
<a href="#h6-3" id="h6-3" class="h">@@ -238,7 +237,7 @@ class FeaturesSection : Section() {
</a>                         .height(50.dp)
                         .width(1.dp)
                         .background(
<a href="#h6-3-3" id="h6-3-3" class="d">-                            color = MaterialTheme.colors.onBackground.copy(alpha = 0.12f),
</a><a href="#h6-3-4" id="h6-3-4" class="i">+                            color = MaterialTheme.colorScheme.primary.copy(alpha = 0.12f),
</a>                             shape = RoundedCornerShape(5.dp)
                         ))
                 }
<a href="#h6-4" id="h6-4" class="h">@@ -329,8 +328,8 @@ class FeaturesSection : Section() {
</a>                         }
                     },
                     modifier = Modifier.padding(10.dp),
<a href="#h6-4-3" id="h6-4-3" class="d">-                    containerColor = MaterialTheme.colors.primary,
</a><a href="#h6-4-4" id="h6-4-4" class="d">-                    contentColor = MaterialTheme.colors.onPrimary,
</a><a href="#h6-4-5" id="h6-4-5" class="i">+                    containerColor = MaterialTheme.colorScheme.primary,
</a><a href="#h6-4-6" id="h6-4-6" class="i">+                    contentColor = MaterialTheme.colorScheme.onPrimary,
</a>                     shape = RoundedCornerShape(16.dp),
                 ) {
                     Icon(
<b>diff --git a/<a id="h7" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/screens/impl/MappingsScreen.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/screens/impl/MappingsScreen.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/screens/impl/MappingsScreen.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/screens/impl/MappingsScreen.kt</a></b>
<a href="#h7-0" id="h7-0" class="h">@@ -5,9 +5,9 @@ import androidx.compose.foundation.layout.fillMaxWidth
</a> import androidx.compose.foundation.layout.padding
 import androidx.compose.foundation.layout.size
 import androidx.compose.foundation.shape.RoundedCornerShape
<a href="#h7-0-3" id="h7-0-3" class="d">-import androidx.compose.material.MaterialTheme
</a> import androidx.compose.material3.Button
 import androidx.compose.material3.CircularProgressIndicator
<a href="#h7-0-6" id="h7-0-6" class="i">+import androidx.compose.material3.MaterialTheme
</a> import androidx.compose.material3.Surface
 import androidx.compose.material3.Text
 import androidx.compose.runtime.Composable
<a href="#h7-1" id="h7-1" class="h">@@ -87,7 +87,7 @@ class MappingsScreen : SetupScreen() {
</a>                 CircularProgressIndicator(
                     modifier = Modifier.padding().size(30.dp),
                     strokeWidth = 3.dp,
<a href="#h7-1-3" id="h7-1-3" class="d">-                    color = MaterialTheme.colors.onPrimary
</a><a href="#h7-1-4" id="h7-1-4" class="i">+                    color = MaterialTheme.colorScheme.onPrimary
</a>                 )
             } else {
                 Text(text = context.translation[&quot;setup.mappings.generate_button&quot;])
<b>diff --git a/<a id="h8" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/screens/impl/PickLanguageScreen.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/screens/impl/PickLanguageScreen.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/screens/impl/PickLanguageScreen.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/screens/impl/PickLanguageScreen.kt</a></b>
<a href="#h8-0" id="h8-0" class="h">@@ -10,10 +10,10 @@ import androidx.compose.foundation.layout.padding
</a> import androidx.compose.foundation.lazy.LazyColumn
 import androidx.compose.foundation.lazy.items
 import androidx.compose.foundation.rememberScrollState
<a href="#h8-0-3" id="h8-0-3" class="d">-import androidx.compose.material.Surface
</a><a href="#h8-0-4" id="h8-0-4" class="d">-import androidx.compose.material.Text
</a> import androidx.compose.material3.Button
 import androidx.compose.material3.MaterialTheme
<a href="#h8-0-7" id="h8-0-7" class="i">+import androidx.compose.material3.Surface
</a><a href="#h8-0-8" id="h8-0-8" class="i">+import androidx.compose.material3.Text
</a> import androidx.compose.runtime.Composable
 import androidx.compose.runtime.mutableStateOf
 import androidx.compose.runtime.remember
<a href="#h8-1" id="h8-1" class="h">@@ -86,7 +86,6 @@ class PickLanguageScreen : SetupScreen(){
</a>                     modifier = Modifier
                         .padding(10.dp)
                         .fillMaxWidth(),
<a href="#h8-1-3" id="h8-1-3" class="d">-                    elevation = 8.dp,
</a>                     shape = MaterialTheme.shapes.medium
                 ) {
                     LazyColumn(
<b>diff --git a/<a id="h9" href="../file/core/src/main/res/drawable/bitmoji_blank.xml.html">core/src/main/res/drawable/bitmoji_blank.xml</a> b/<a href="../file/app/src/main/res/drawable/bitmoji_blank.xml.html">app/src/main/res/drawable/bitmoji_blank.xml</a></b>
<b>diff --git a/<a id="h10" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/download/DownloadTaskManager.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/download/DownloadTaskManager.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/download/DownloadTaskManager.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/download/DownloadTaskManager.kt</a></b>
<a href="#h10-0" id="h10-0" class="h">@@ -4,15 +4,17 @@ import android.annotation.SuppressLint
</a> import android.content.Context
 import android.database.sqlite.SQLiteDatabase
 import me.rhunk.snapenhance.download.data.DownloadMetadata
<a href="#h10-0-3" id="h10-0-3" class="d">-import me.rhunk.snapenhance.download.data.PendingDownload
</a><a href="#h10-0-4" id="h10-0-4" class="i">+import me.rhunk.snapenhance.download.data.DownloadObject
</a> import me.rhunk.snapenhance.download.data.DownloadStage
 import me.rhunk.snapenhance.ui.download.MediaFilter
 import me.rhunk.snapenhance.util.SQLiteDatabaseHelper
<a href="#h10-0-8" id="h10-0-8" class="i">+import me.rhunk.snapenhance.util.getIntOrNull
</a><a href="#h10-0-9" id="h10-0-9" class="i">+import me.rhunk.snapenhance.util.getStringOrNull
</a> 
 class DownloadTaskManager {
     private lateinit var taskDatabase: SQLiteDatabase
<a href="#h10-0-13" id="h10-0-13" class="d">-    private val pendingTasks = mutableMapOf&lt;Int, PendingDownload&gt;()
</a><a href="#h10-0-14" id="h10-0-14" class="d">-    private val cachedTasks = mutableMapOf&lt;Int, PendingDownload&gt;()
</a><a href="#h10-0-15" id="h10-0-15" class="i">+    private val pendingTasks = mutableMapOf&lt;Int, DownloadObject&gt;()
</a><a href="#h10-0-16" id="h10-0-16" class="i">+    private val cachedTasks = mutableMapOf&lt;Int, DownloadObject&gt;()
</a> 
     @SuppressLint(&quot;Range&quot;)
     fun init(context: Context) {
<a href="#h10-1" id="h10-1" class="h">@@ -33,7 +35,7 @@ class DownloadTaskManager {
</a>         }
     }
 
<a href="#h10-1-3" id="h10-1-3" class="d">-    fun addTask(task: PendingDownload): Int {
</a><a href="#h10-1-4" id="h10-1-4" class="i">+    fun addTask(task: DownloadObject): Int {
</a>         taskDatabase.execSQL(&quot;INSERT INTO tasks (hash, outputPath, outputFile, mediaDisplayType, mediaDisplaySource, iconUrl, downloadStage) VALUES (?, ?, ?, ?, ?, ?, ?)&quot;,
             arrayOf(
                 task.metadata.mediaIdentifier,
<a href="#h10-2" id="h10-2" class="h">@@ -53,7 +55,7 @@ class DownloadTaskManager {
</a>         return task.downloadId
     }
 
<a href="#h10-2-3" id="h10-2-3" class="d">-    fun updateTask(task: PendingDownload) {
</a><a href="#h10-2-4" id="h10-2-4" class="i">+    fun updateTask(task: DownloadObject) {
</a>         taskDatabase.execSQL(&quot;UPDATE tasks SET hash = ?, outputPath = ?, outputFile = ?, mediaDisplayType = ?, mediaDisplaySource = ?, iconUrl = ?, downloadStage = ? WHERE id = ?&quot;,
             arrayOf(
                 task.metadata.mediaIdentifier,
<a href="#h10-3" id="h10-3" class="h">@@ -107,13 +109,13 @@ class DownloadTaskManager {
</a>         pendingTasks.remove(id)
     }
 
<a href="#h10-3-3" id="h10-3-3" class="d">-    fun removeTask(task: PendingDownload) {
</a><a href="#h10-3-4" id="h10-3-4" class="i">+    fun removeTask(task: DownloadObject) {
</a>         removeTask(task.downloadId)
     }
 
<a href="#h10-3-8" id="h10-3-8" class="d">-    fun queryAllTasks(filter: MediaFilter): Map&lt;Int, PendingDownload&gt; {
</a><a href="#h10-3-9" id="h10-3-9" class="i">+    fun queryFirstTasks(filter: MediaFilter): Map&lt;Int, DownloadObject&gt; {
</a>         val isPendingFilter = filter == MediaFilter.PENDING
<a href="#h10-3-11" id="h10-3-11" class="d">-        val tasks = mutableMapOf&lt;Int, PendingDownload&gt;()
</a><a href="#h10-3-12" id="h10-3-12" class="i">+        val tasks = mutableMapOf&lt;Int, DownloadObject&gt;()
</a> 
         tasks.putAll(pendingTasks.filter { isPendingFilter || filter.matches(it.value.metadata.mediaDisplayType) })
         if (isPendingFilter) {
<a href="#h10-4" id="h10-4" class="h">@@ -130,7 +132,7 @@ class DownloadTaskManager {
</a>     }
 
     @SuppressLint(&quot;Range&quot;)
<a href="#h10-4-3" id="h10-4-3" class="d">-    fun queryTasks(from: Int, amount: Int = 20, filter: MediaFilter = MediaFilter.NONE): Map&lt;Int, PendingDownload&gt; {
</a><a href="#h10-4-4" id="h10-4-4" class="i">+    fun queryTasks(from: Int, amount: Int = 30, filter: MediaFilter = MediaFilter.NONE): Map&lt;Int, DownloadObject&gt; {
</a>         if (filter == MediaFilter.PENDING) {
             return emptyMap()
         }
<a href="#h10-5" id="h10-5" class="h">@@ -139,27 +141,27 @@ class DownloadTaskManager {
</a>             &quot;SELECT * FROM tasks WHERE id &lt; ? AND mediaDisplayType LIKE ? ORDER BY id DESC LIMIT ?&quot;,
             arrayOf(
                 from.toString(),
<a href="#h10-5-3" id="h10-5-3" class="d">-                filter.mediaDisplayType.let { if (it == null) &quot;%&quot; else &quot;%$it&quot; },
</a><a href="#h10-5-4" id="h10-5-4" class="i">+                if (filter.shouldIgnoreFilter) &quot;%&quot; else &quot;%${filter.key}&quot;,
</a>                 amount.toString()
             )
         )
 
<a href="#h10-5-9" id="h10-5-9" class="d">-        val result = sortedMapOf&lt;Int, PendingDownload&gt;()
</a><a href="#h10-5-10" id="h10-5-10" class="i">+        val result = sortedMapOf&lt;Int, DownloadObject&gt;()
</a> 
         while (cursor.moveToNext()) {
<a href="#h10-5-13" id="h10-5-13" class="d">-            val task = PendingDownload(
</a><a href="#h10-5-14" id="h10-5-14" class="d">-                downloadId = cursor.getInt(cursor.getColumnIndex(&quot;id&quot;)),
</a><a href="#h10-5-15" id="h10-5-15" class="d">-                outputFile = cursor.getString(cursor.getColumnIndex(&quot;outputFile&quot;)),
</a><a href="#h10-5-16" id="h10-5-16" class="i">+            val task = DownloadObject(
</a><a href="#h10-5-17" id="h10-5-17" class="i">+                downloadId = cursor.getIntOrNull(&quot;id&quot;)!!,
</a><a href="#h10-5-18" id="h10-5-18" class="i">+                outputFile = cursor.getStringOrNull(&quot;outputFile&quot;),
</a>                 metadata = DownloadMetadata(
<a href="#h10-5-20" id="h10-5-20" class="d">-                    outputPath = cursor.getString(cursor.getColumnIndex(&quot;outputPath&quot;)),
</a><a href="#h10-5-21" id="h10-5-21" class="d">-                    mediaIdentifier = cursor.getString(cursor.getColumnIndex(&quot;hash&quot;)),
</a><a href="#h10-5-22" id="h10-5-22" class="d">-                    mediaDisplayType = cursor.getString(cursor.getColumnIndex(&quot;mediaDisplayType&quot;)),
</a><a href="#h10-5-23" id="h10-5-23" class="d">-                    mediaDisplaySource = cursor.getString(cursor.getColumnIndex(&quot;mediaDisplaySource&quot;)),
</a><a href="#h10-5-24" id="h10-5-24" class="d">-                    iconUrl = cursor.getString(cursor.getColumnIndex(&quot;iconUrl&quot;))
</a><a href="#h10-5-25" id="h10-5-25" class="i">+                    outputPath = cursor.getStringOrNull(&quot;outputPath&quot;)!!,
</a><a href="#h10-5-26" id="h10-5-26" class="i">+                    mediaIdentifier = cursor.getStringOrNull(&quot;hash&quot;),
</a><a href="#h10-5-27" id="h10-5-27" class="i">+                    mediaDisplayType = cursor.getStringOrNull(&quot;mediaDisplayType&quot;),
</a><a href="#h10-5-28" id="h10-5-28" class="i">+                    mediaDisplaySource = cursor.getStringOrNull(&quot;mediaDisplaySource&quot;),
</a><a href="#h10-5-29" id="h10-5-29" class="i">+                    iconUrl = cursor.getStringOrNull(&quot;iconUrl&quot;)
</a>                 )
             ).apply {
                 downloadTaskManager = this@DownloadTaskManager
<a href="#h10-5-33" id="h10-5-33" class="d">-                downloadStage = DownloadStage.valueOf(cursor.getString(cursor.getColumnIndex(&quot;downloadStage&quot;)))
</a><a href="#h10-5-34" id="h10-5-34" class="i">+                downloadStage = DownloadStage.valueOf(cursor.getStringOrNull(&quot;downloadStage&quot;)!!)
</a>                 //if downloadStage is not saved, it means the app was killed before the download was finished
                 if (downloadStage != DownloadStage.SAVED) {
                     downloadStage = DownloadStage.FAILED
<b>diff --git a/<a id="h11" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/download/data/DownloadObject.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/download/data/DownloadObject.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/download/data/DownloadObject.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/download/data/DownloadObject.kt</a></b>
<a href="#h11-0" id="h11-0" class="h">@@ -0,0 +1,32 @@
</a><a href="#h11-0-0" id="h11-0-0" class="i">+package me.rhunk.snapenhance.download.data
</a><a href="#h11-0-1" id="h11-0-1" class="i">+
</a><a href="#h11-0-2" id="h11-0-2" class="i">+import kotlinx.coroutines.Job
</a><a href="#h11-0-3" id="h11-0-3" class="i">+import me.rhunk.snapenhance.download.DownloadTaskManager
</a><a href="#h11-0-4" id="h11-0-4" class="i">+
</a><a href="#h11-0-5" id="h11-0-5" class="i">+data class DownloadObject(
</a><a href="#h11-0-6" id="h11-0-6" class="i">+    var downloadId: Int = 0,
</a><a href="#h11-0-7" id="h11-0-7" class="i">+    var outputFile: String? = null,
</a><a href="#h11-0-8" id="h11-0-8" class="i">+    val metadata : DownloadMetadata
</a><a href="#h11-0-9" id="h11-0-9" class="i">+) {
</a><a href="#h11-0-10" id="h11-0-10" class="i">+    lateinit var downloadTaskManager: DownloadTaskManager
</a><a href="#h11-0-11" id="h11-0-11" class="i">+    var job: Job? = null
</a><a href="#h11-0-12" id="h11-0-12" class="i">+
</a><a href="#h11-0-13" id="h11-0-13" class="i">+    var changeListener = { _: DownloadStage, _: DownloadStage -&gt; }
</a><a href="#h11-0-14" id="h11-0-14" class="i">+    private var _stage: DownloadStage = DownloadStage.PENDING
</a><a href="#h11-0-15" id="h11-0-15" class="i">+    var downloadStage: DownloadStage
</a><a href="#h11-0-16" id="h11-0-16" class="i">+        get() = synchronized(this) {
</a><a href="#h11-0-17" id="h11-0-17" class="i">+            _stage
</a><a href="#h11-0-18" id="h11-0-18" class="i">+        }
</a><a href="#h11-0-19" id="h11-0-19" class="i">+        set(value) = synchronized(this) {
</a><a href="#h11-0-20" id="h11-0-20" class="i">+            changeListener(_stage, value)
</a><a href="#h11-0-21" id="h11-0-21" class="i">+            _stage = value
</a><a href="#h11-0-22" id="h11-0-22" class="i">+            downloadTaskManager.updateTask(this)
</a><a href="#h11-0-23" id="h11-0-23" class="i">+        }
</a><a href="#h11-0-24" id="h11-0-24" class="i">+
</a><a href="#h11-0-25" id="h11-0-25" class="i">+    fun isJobActive() = job?.isActive == true
</a><a href="#h11-0-26" id="h11-0-26" class="i">+
</a><a href="#h11-0-27" id="h11-0-27" class="i">+    fun cancel() {
</a><a href="#h11-0-28" id="h11-0-28" class="i">+        downloadStage = DownloadStage.CANCELLED
</a><a href="#h11-0-29" id="h11-0-29" class="i">+        job?.cancel()
</a><a href="#h11-0-30" id="h11-0-30" class="i">+    }
</a><a href="#h11-0-31" id="h11-0-31" class="i">+}
</a><b>diff --git a/<a id="h12" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/download/data/PendingDownload.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/download/data/PendingDownload.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/download/data/PendingDownload.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/download/data/PendingDownload.kt</a></b>
<a href="#h12-0" id="h12-0" class="h">@@ -1,33 +0,0 @@
</a><a href="#h12-0-0" id="h12-0-0" class="d">-package me.rhunk.snapenhance.download.data
</a><a href="#h12-0-1" id="h12-0-1" class="d">-
</a><a href="#h12-0-2" id="h12-0-2" class="d">-import kotlinx.coroutines.Job
</a><a href="#h12-0-3" id="h12-0-3" class="d">-import me.rhunk.snapenhance.SharedContext
</a><a href="#h12-0-4" id="h12-0-4" class="d">-import me.rhunk.snapenhance.download.DownloadTaskManager
</a><a href="#h12-0-5" id="h12-0-5" class="d">-
</a><a href="#h12-0-6" id="h12-0-6" class="d">-data class PendingDownload(
</a><a href="#h12-0-7" id="h12-0-7" class="d">-    var downloadId: Int = 0,
</a><a href="#h12-0-8" id="h12-0-8" class="d">-    var outputFile: String? = null,
</a><a href="#h12-0-9" id="h12-0-9" class="d">-    val metadata : DownloadMetadata
</a><a href="#h12-0-10" id="h12-0-10" class="d">-) {
</a><a href="#h12-0-11" id="h12-0-11" class="d">-    lateinit var downloadTaskManager: DownloadTaskManager
</a><a href="#h12-0-12" id="h12-0-12" class="d">-    var job: Job? = null
</a><a href="#h12-0-13" id="h12-0-13" class="d">-
</a><a href="#h12-0-14" id="h12-0-14" class="d">-    var changeListener = { _: DownloadStage, _: DownloadStage -&gt; }
</a><a href="#h12-0-15" id="h12-0-15" class="d">-    private var _stage: DownloadStage = DownloadStage.PENDING
</a><a href="#h12-0-16" id="h12-0-16" class="d">-    var downloadStage: DownloadStage
</a><a href="#h12-0-17" id="h12-0-17" class="d">-        get() = synchronized(this) {
</a><a href="#h12-0-18" id="h12-0-18" class="d">-            _stage
</a><a href="#h12-0-19" id="h12-0-19" class="d">-        }
</a><a href="#h12-0-20" id="h12-0-20" class="d">-        set(value) = synchronized(this) {
</a><a href="#h12-0-21" id="h12-0-21" class="d">-            changeListener(_stage, value)
</a><a href="#h12-0-22" id="h12-0-22" class="d">-            _stage = value
</a><a href="#h12-0-23" id="h12-0-23" class="d">-            downloadTaskManager.updateTask(this)
</a><a href="#h12-0-24" id="h12-0-24" class="d">-        }
</a><a href="#h12-0-25" id="h12-0-25" class="d">-
</a><a href="#h12-0-26" id="h12-0-26" class="d">-    fun isJobActive() = job?.isActive == true
</a><a href="#h12-0-27" id="h12-0-27" class="d">-
</a><a href="#h12-0-28" id="h12-0-28" class="d">-    fun cancel() {
</a><a href="#h12-0-29" id="h12-0-29" class="d">-        downloadStage = DownloadStage.CANCELLED
</a><a href="#h12-0-30" id="h12-0-30" class="d">-        job?.cancel()
</a><a href="#h12-0-31" id="h12-0-31" class="d">-    }
</a><a href="#h12-0-32" id="h12-0-32" class="d">-}
</a><b>diff --git a/<a id="h13" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/MediaDownloader.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/MediaDownloader.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/MediaDownloader.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/MediaDownloader.kt</a></b>
<a href="#h13-0" id="h13-0" class="h">@@ -242,7 +242,7 @@ class MediaDownloader : Feature(&quot;MediaDownloader&quot;, loadParams = FeatureLoadParam
</a>                 pathSuffix = authorUsername,
                 mediaIdentifier = &quot;$conversationId$senderId${conversationMessage.server_message_id}&quot;,
                 mediaDisplaySource = authorUsername,
<a href="#h13-0-3" id="h13-0-3" class="d">-                mediaDisplayType = MediaFilter.CHAT_MEDIA.mediaDisplayType,
</a><a href="#h13-0-4" id="h13-0-4" class="i">+                mediaDisplayType = MediaFilter.CHAT_MEDIA.key,
</a>                 friendInfo = author
             ), mediaInfoMap)
 
<a href="#h13-1" id="h13-1" class="h">@@ -282,7 +282,7 @@ class MediaDownloader : Feature(&quot;MediaDownloader&quot;, loadParams = FeatureLoadParam
</a>                 pathSuffix = authorName,
                 mediaIdentifier = paramMap[&quot;MEDIA_ID&quot;].toString(),
                 mediaDisplaySource = authorName,
<a href="#h13-1-3" id="h13-1-3" class="d">-                mediaDisplayType = MediaFilter.STORY.mediaDisplayType,
</a><a href="#h13-1-4" id="h13-1-4" class="i">+                mediaDisplayType = MediaFilter.STORY.key,
</a>                 friendInfo = author
             ), mediaInfoMap)
             return
<a href="#h13-2" id="h13-2" class="h">@@ -311,7 +311,7 @@ class MediaDownloader : Feature(&quot;MediaDownloader&quot;, loadParams = FeatureLoadParam
</a>             downloadOperaMedia(provideDownloadManagerClient(
                 pathSuffix = &quot;Spotlight&quot;,
                 mediaIdentifier = paramMap[&quot;SNAP_ID&quot;].toString(),
<a href="#h13-2-3" id="h13-2-3" class="d">-                mediaDisplayType = MediaFilter.SPOTLIGHT.mediaDisplayType,
</a><a href="#h13-2-4" id="h13-2-4" class="i">+                mediaDisplayType = MediaFilter.SPOTLIGHT.key,
</a>                 mediaDisplaySource = paramMap[&quot;TIME_STAMP&quot;].toString()
             ), mediaInfoMap)
             return
<a href="#h13-3" id="h13-3" class="h">@@ -476,7 +476,7 @@ class MediaDownloader : Feature(&quot;MediaDownloader&quot;, loadParams = FeatureLoadParam
</a>                     pathSuffix = authorName,
                     mediaIdentifier = &quot;${message.client_conversation_id}${message.sender_id}${message.server_message_id}&quot;,
                     mediaDisplaySource = authorName,
<a href="#h13-3-3" id="h13-3-3" class="d">-                    mediaDisplayType = MediaFilter.CHAT_MEDIA.mediaDisplayType,
</a><a href="#h13-3-4" id="h13-3-4" class="i">+                    mediaDisplayType = MediaFilter.CHAT_MEDIA.key,
</a>                     friendInfo = friendInfo
                 ).downloadSingleMedia(
                     Base64.UrlSafe.encode(urlProto),
<b>diff --git a/<a id="h14" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/ui/download/DownloadListAdapter.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/ui/download/DownloadListAdapter.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/ui/download/DownloadListAdapter.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/ui/download/DownloadListAdapter.kt</a></b>
<a href="#h14-0" id="h14-0" class="h">@@ -26,7 +26,7 @@ import me.rhunk.snapenhance.Logger
</a> import me.rhunk.snapenhance.SharedContext
 import me.rhunk.snapenhance.core.R
 import me.rhunk.snapenhance.data.FileType
<a href="#h14-0-3" id="h14-0-3" class="d">-import me.rhunk.snapenhance.download.data.PendingDownload
</a><a href="#h14-0-4" id="h14-0-4" class="i">+import me.rhunk.snapenhance.download.data.DownloadObject
</a> import me.rhunk.snapenhance.download.data.DownloadStage
 import me.rhunk.snapenhance.util.snap.PreviewUtils
 import java.io.File
<a href="#h14-1" id="h14-1" class="h">@@ -37,7 +37,7 @@ import kotlin.coroutines.coroutineContext
</a> 
 class DownloadListAdapter(
     private val activity: DownloadManagerActivity,
<a href="#h14-1-3" id="h14-1-3" class="d">-    private val downloadList: MutableList&lt;PendingDownload&gt;
</a><a href="#h14-1-4" id="h14-1-4" class="i">+    private val downloadList: MutableList&lt;DownloadObject&gt;
</a> ): Adapter&lt;DownloadListAdapter.ViewHolder&gt;() {
     private val coroutineScope = CoroutineScope(Dispatchers.IO)
     private val previewJobs = mutableMapOf&lt;Int, Job&gt;()
<a href="#h14-2" id="h14-2" class="h">@@ -68,7 +68,7 @@ class DownloadListAdapter(
</a>     }
 
     @SuppressLint(&quot;Recycle&quot;)
<a href="#h14-2-3" id="h14-2-3" class="d">-    private suspend fun handlePreview(download: PendingDownload, holder: ViewHolder) {
</a><a href="#h14-2-4" id="h14-2-4" class="i">+    private suspend fun handlePreview(download: DownloadObject, holder: ViewHolder) {
</a>         download.outputFile?.let {
             val uri = Uri.parse(it)
             runCatching {
<a href="#h14-3" id="h14-3" class="h">@@ -124,7 +124,7 @@ class DownloadListAdapter(
</a>         }
     }
 
<a href="#h14-3-3" id="h14-3-3" class="d">-    private fun updateViewHolder(download: PendingDownload, holder: ViewHolder) {
</a><a href="#h14-3-4" id="h14-3-4" class="i">+    private fun updateViewHolder(download: DownloadObject, holder: ViewHolder) {
</a>         holder.status.text = download.downloadStage.toString()
         holder.view.background = holder.view.context.getDrawable(R.drawable.download_manager_item_background)
 
<a href="#h14-4" id="h14-4" class="h">@@ -163,7 +163,7 @@ class DownloadListAdapter(
</a>             }
         }
 
<a href="#h14-4-3" id="h14-4-3" class="d">-        holder.bitmojiIcon.setImageResource(R.drawable.bitmoji_blank)
</a><a href="#h14-4-4" id="h14-4-4" class="i">+       // holder.bitmojiIcon.setImageResource(R.drawable.bitmoji_blank)
</a> 
         pendingDownload.metadata.iconUrl?.let { url -&gt;
             thread(start = true) {
<b>diff --git a/<a id="h15" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/ui/download/DownloadManagerActivity.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/ui/download/DownloadManagerActivity.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/ui/download/DownloadManagerActivity.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/ui/download/DownloadManagerActivity.kt</a></b>
<a href="#h15-0" id="h15-0" class="h">@@ -19,13 +19,13 @@ import me.rhunk.snapenhance.SharedContext
</a> import me.rhunk.snapenhance.bridge.wrapper.LocaleWrapper
 import me.rhunk.snapenhance.core.BuildConfig
 import me.rhunk.snapenhance.core.R
<a href="#h15-0-3" id="h15-0-3" class="d">-import me.rhunk.snapenhance.download.data.PendingDownload
</a><a href="#h15-0-4" id="h15-0-4" class="i">+import me.rhunk.snapenhance.download.data.DownloadObject
</a> 
 class DownloadManagerActivity : Activity() {
     lateinit var translation: LocaleWrapper
 
     private val backCallbacks = mutableListOf&lt;() -&gt; Unit&gt;()
<a href="#h15-0-10" id="h15-0-10" class="d">-    private val fetchedDownloadTasks = mutableListOf&lt;PendingDownload&gt;()
</a><a href="#h15-0-11" id="h15-0-11" class="i">+    private val fetchedDownloadTasks = mutableListOf&lt;DownloadObject&gt;()
</a>     private var listFilter = MediaFilter.NONE
 
     private val preferences by lazy {
<a href="#h15-1" id="h15-1" class="h">@@ -42,7 +42,7 @@ class DownloadManagerActivity : Activity() {
</a>     @SuppressLint(&quot;NotifyDataSetChanged&quot;)
     private fun updateListContent() {
         fetchedDownloadTasks.clear()
<a href="#h15-1-3" id="h15-1-3" class="d">-        fetchedDownloadTasks.addAll(SharedContext.downloadTaskManager.queryAllTasks(filter = listFilter).values)
</a><a href="#h15-1-4" id="h15-1-4" class="i">+        fetchedDownloadTasks.addAll(SharedContext.downloadTaskManager.queryFirstTasks(filter = listFilter).values)
</a> 
         with(findViewById&lt;RecyclerView&gt;(R.id.download_list)) {
             adapter?.notifyDataSetChanged()
<b>diff --git a/<a id="h16" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/ui/download/MediaFilter.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/ui/download/MediaFilter.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/ui/download/MediaFilter.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/ui/download/MediaFilter.kt</a></b>
<a href="#h16-0" id="h16-0" class="h">@@ -1,17 +1,17 @@
</a> package me.rhunk.snapenhance.ui.download
 
 enum class MediaFilter(
<a href="#h16-0-3" id="h16-0-3" class="d">-    val mediaDisplayType: String? = null
</a><a href="#h16-0-4" id="h16-0-4" class="i">+    val key: String,
</a><a href="#h16-0-5" id="h16-0-5" class="i">+    val shouldIgnoreFilter: Boolean = false
</a> ) {
<a href="#h16-0-7" id="h16-0-7" class="d">-    NONE,
</a><a href="#h16-0-8" id="h16-0-8" class="d">-    PENDING,
</a><a href="#h16-0-9" id="h16-0-9" class="d">-    CHAT_MEDIA(&quot;Chat Media&quot;),
</a><a href="#h16-0-10" id="h16-0-10" class="d">-    STORY(&quot;Story&quot;),
</a><a href="#h16-0-11" id="h16-0-11" class="d">-    SPOTLIGHT(&quot;Spotlight&quot;);
</a><a href="#h16-0-12" id="h16-0-12" class="i">+    NONE(&quot;none&quot;, true),
</a><a href="#h16-0-13" id="h16-0-13" class="i">+    PENDING(&quot;pending&quot;, true),
</a><a href="#h16-0-14" id="h16-0-14" class="i">+    CHAT_MEDIA(&quot;chat_media&quot;),
</a><a href="#h16-0-15" id="h16-0-15" class="i">+    STORY(&quot;story&quot;),
</a><a href="#h16-0-16" id="h16-0-16" class="i">+    SPOTLIGHT(&quot;spotlight&quot;);
</a> 
     fun matches(source: String?): Boolean {
<a href="#h16-0-19" id="h16-0-19" class="d">-        if (mediaDisplayType == null) return true
</a>         if (source == null) return false
<a href="#h16-0-21" id="h16-0-21" class="d">-        return source.contains(mediaDisplayType, ignoreCase = true)
</a><a href="#h16-0-22" id="h16-0-22" class="i">+        return source.contains(key, ignoreCase = true)
</a>     }
 } 
\ No newline at end of file
<b>diff --git a/<a id="h17" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/util/snap/PreviewUtils.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/util/snap/PreviewUtils.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/util/snap/PreviewUtils.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/util/snap/PreviewUtils.kt</a></b>
<a href="#h17-0" id="h17-0" class="h">@@ -48,9 +48,7 @@ object PreviewUtils {
</a>                 setDataSource(file.absolutePath)
             }.getFrameAtTime(0, MediaMetadataRetriever.OPTION_CLOSEST_SYNC)
         } else {
<a href="#h17-0-3" id="h17-0-3" class="d">-            BitmapFactory.decodeFile(file.absolutePath, BitmapFactory.Options().apply {
</a><a href="#h17-0-4" id="h17-0-4" class="d">-                inSampleSize = 1
</a><a href="#h17-0-5" id="h17-0-5" class="d">-            })
</a><a href="#h17-0-6" id="h17-0-6" class="i">+            BitmapFactory.decodeFile(file.absolutePath, BitmapFactory.Options())
</a>         }
     }
 
<b>diff --git a/<a id="h18" href="../file/gradle/libs.versions.toml.html">gradle/libs.versions.toml</a> b/<a href="../file/gradle/libs.versions.toml.html">gradle/libs.versions.toml</a></b>
<a href="#h18-0" id="h18-0" class="h">@@ -1,11 +1,12 @@
</a> [versions]
 agp = &quot;8.2.0-alpha14&quot;
<a href="#h18-0-2" id="h18-0-2" class="d">-androidx-material = &quot;1.6.0-alpha02&quot;
</a><a href="#h18-0-3" id="h18-0-3" class="i">+coil-compose = &quot;2.4.0&quot;
</a> junit = &quot;4.13.2&quot;
 kotlin = &quot;1.8.22&quot;
 kotlinx-coroutines-android = &quot;1.7.2&quot;
 kotlin-reflect = &quot;1.8.22&quot;
<a href="#h18-0-8" id="h18-0-8" class="d">-material-icons-extended = &quot;1.6.0-alpha03&quot;
</a><a href="#h18-0-9" id="h18-0-9" class="i">+material-icons-core = &quot;1.4.3&quot;
</a><a href="#h18-0-10" id="h18-0-10" class="i">+material-icons-extended = &quot;1.6.0-alpha02&quot;
</a> navigation-compose = &quot;2.7.0-rc01&quot;
 recyclerview = &quot;1.3.1&quot;
 gson = &quot;2.10.1&quot;
<a href="#h18-1" id="h18-1" class="h">@@ -19,9 +20,12 @@ material3 = &quot;1.1.1&quot;
</a> 
 
 [libraries]
<a href="#h18-1-3" id="h18-1-3" class="d">-androidx-material = { module = &quot;androidx.compose.material:material&quot;, version.ref = &quot;androidx-material&quot; }
</a><a href="#h18-1-4" id="h18-1-4" class="i">+androidx-material-icons-core = { module = &quot;androidx.compose.material:material-icons-core&quot;, version.ref = &quot;material-icons-core&quot; }
</a> androidx-material-icons-extended = { module = &quot;androidx.compose.material:material-icons-extended&quot;, version.ref = &quot;material-icons-extended&quot; }
<a href="#h18-1-6" id="h18-1-6" class="i">+androidx-material-ripple = { module = &quot;androidx.compose.material:material-ripple&quot;, version.ref = &quot;material-icons-core&quot; }
</a> androidx-navigation-compose = { module = &quot;androidx.navigation:navigation-compose&quot;, version.ref = &quot;navigation-compose&quot; }
<a href="#h18-1-8" id="h18-1-8" class="i">+coil-compose = { module = &quot;io.coil-kt:coil-compose&quot;, version.ref = &quot;coil-compose&quot; }
</a><a href="#h18-1-9" id="h18-1-9" class="i">+coil-video = { module = &quot;io.coil-kt:coil-video&quot;, version.ref = &quot;coil-compose&quot; }
</a> coroutines = { group = &quot;org.jetbrains.kotlinx&quot;, name = &quot;kotlinx-coroutines-android&quot;, version.ref = &quot;kotlinx-coroutines-android&quot; }
 junit = { module = &quot;junit:junit&quot;, version.ref = &quot;junit&quot; }
 kotlin-reflect = { group = &quot;org.jetbrains.kotlin&quot;, name = &quot;kotlin-reflect&quot;, version.ref = &quot;kotlin-reflect&quot; }
</pre>
</div>
</body>
</html>
