<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>refactor: resources ktx - SnapEnhance - An Xposed module offering an enhanced Snapchat experience
</title>
<link rel="icon" type="image/svg+xml" href="../../logo.png"/>
<link rel="alternate icon" href="../../favicon.png"/>
<link rel="alternate" type="application/atom+xml" title="SnapEnhance Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="SnapEnhance Atom Feed (tags)" href="../tags.xml" />
<link rel="stylesheet" type="text/css" href="../../style.css" />
<link rel="stylesheet" type="text/css" href="../../fonts.css" />
</head>
<body>
<div id="head"><table><tr><td><a class="logo" href="../../"><img src="../../logo.png" alt="" width="32" height="32" /></a></td><td><strong>SnapEnhance</strong><span class="desc"> - An Xposed module offering an enhanced Snapchat experience
</span>
</td></tr></table>
<p><a href="../about.html">About</a> | <a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/.gitmodules.html">Submodules</a> | <a href="../file/LICENSE.html">License</a></p>
</div>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/0ea7001ec50a3731e1ee1ef8915d84e5499abe47.html">0ea7001ec50a3731e1ee1ef8915d84e5499abe47</a>
<b>parent</b> <a href="../commit/3d053155c35c27146f64880b23f5fd6d9f564b63.html">3d053155c35c27146f64880b23f5fd6d9f564b63</a>
<b>Author:</b> rhunk &lt;<a href="mailto:101876869+rhunk@users.noreply.github.com">101876869+rhunk@users.noreply.github.com</a>&gt;
<b>Date:</b>   Thu,  2 Nov 2023 10:25:41 +0100

refactor: resources ktx

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">common/src/main/kotlin/me/rhunk/snapenhance/common/Constants.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/AmoledDarkMode.kt</a></td><td> | </td><td class="num">4</td><td><span class="i">++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h2">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/CallStartConfirmation.kt</a></td><td> | </td><td class="num">5</td><td><span class="i">+++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h3">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/SendOverride.kt</a></td><td> | </td><td class="num">6</td><td><span class="i">+++</span><span class="d">---</span></td></tr>
<tr><td class="M">M</td><td><a href="#h4">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/FriendFeedMessagePreview.kt</a></td><td> | </td><td class="num">20</td><td><span class="i">++++++++++</span><span class="d">----------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h5">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/SnapPreview.kt</a></td><td> | </td><td class="num">12</td><td><span class="i">+++++++</span><span class="d">-----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h6">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/UITweaks.kt</a></td><td> | </td><td class="num">38</td><td><span class="i">+++++++++++++++++++</span><span class="d">-------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h7">core/src/main/kotlin/me/rhunk/snapenhance/core/messaging/MessageExporter.kt</a></td><td> | </td><td class="num">25</td><td><span class="i">+++++++++++++++</span><span class="d">----------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h8">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/ViewAppearanceHelper.kt</a></td><td> | </td><td class="num">38</td><td><span class="i">++++++++++++++++++++++++++++</span><span class="d">----------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h9">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/AbstractMenu.kt</a></td><td> | </td><td class="num">4</td><td><span class="i">++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h10">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/ChatActionMenu.kt</a></td><td> | </td><td class="num">60</td><td><span class="i">++++++++++++</span><span class="d">------------------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h11">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/FriendFeedInfoMenu.kt</a></td><td> | </td><td class="num">25</td><td><span class="i">++++++++++++</span><span class="d">-------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h12">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/MenuViewInjector.kt</a></td><td> | </td><td class="num">47</td><td><span class="i">+++++++++++++++++++++++</span><span class="d">------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h13">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/OperaContextActionMenu.kt</a></td><td> | </td><td class="num">26</td><td><span class="i">++++++++++++</span><span class="d">--------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h14">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/SettingsGearInjector.kt</a></td><td> | </td><td class="num">37</td><td><span class="i">+++++++++++</span><span class="d">--------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h15">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/SettingsMenu.kt</a></td><td> | </td><td class="num">23</td><td><span class="i"></span><span class="d">-----------------------</span></td></tr>
<tr><td class="A">A</td><td><a href="#h16">core/src/main/kotlin/me/rhunk/snapenhance/core/util/ktx/AndroidExt.kt</a></td><td> | </td><td class="num">33</td><td><span class="i">+++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h17">core/src/main/kotlin/me/rhunk/snapenhance/core/util/ktx/XposedHelperExt.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
</table></pre><pre>18 files changed, 196 insertions(+), 211 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/Constants.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/Constants.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/Constants.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/Constants.kt</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -1,7 +1,7 @@
</a> package me.rhunk.snapenhance.common
 
 object Constants {
<a href="#h0-0-3" id="h0-0-3" class="d">-    const val SNAPCHAT_PACKAGE_NAME = &quot;com.snapchat.android&quot;
</a><a href="#h0-0-4" id="h0-0-4" class="i">+    val SNAPCHAT_PACKAGE_NAME get() = &quot;com.snapchat.android&quot;
</a> 
     val ARROYO_MEDIA_CONTAINER_PROTO_PATH = intArrayOf(4, 4)
 
<b>diff --git a/<a id="h1" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/AmoledDarkMode.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/AmoledDarkMode.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/AmoledDarkMode.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/AmoledDarkMode.kt</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -3,12 +3,12 @@ package me.rhunk.snapenhance.core.features.impl.experiments
</a> import android.annotation.SuppressLint
 import android.content.res.TypedArray
 import android.graphics.drawable.ColorDrawable
<a href="#h1-0-3" id="h1-0-3" class="d">-import me.rhunk.snapenhance.common.Constants
</a> import me.rhunk.snapenhance.core.features.Feature
 import me.rhunk.snapenhance.core.features.FeatureLoadParams
 import me.rhunk.snapenhance.core.util.hook.HookStage
 import me.rhunk.snapenhance.core.util.hook.Hooker
 import me.rhunk.snapenhance.core.util.hook.hook
<a href="#h1-0-9" id="h1-0-9" class="i">+import me.rhunk.snapenhance.core.util.ktx.getIdentifier
</a> 
 class AmoledDarkMode : Feature(&quot;Amoled Dark Mode&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_SYNC) {
     @SuppressLint(&quot;DiscouragedApi&quot;)
<a href="#h1-1" id="h1-1" class="h">@@ -18,7 +18,7 @@ class AmoledDarkMode : Feature(&quot;Amoled Dark Mode&quot;, loadParams = FeatureLoadParam
</a> 
         fun getAttribute(name: String): Int {
             if (attributeCache.containsKey(name)) return attributeCache[name]!!
<a href="#h1-1-3" id="h1-1-3" class="d">-            return context.resources.getIdentifier(name, &quot;attr&quot;, Constants.SNAPCHAT_PACKAGE_NAME).also { attributeCache[name] = it }
</a><a href="#h1-1-4" id="h1-1-4" class="i">+            return context.resources.getIdentifier(name, &quot;attr&quot;).also { attributeCache[name] = it }
</a>         }
 
         context.androidContext.theme.javaClass.getMethod(&quot;obtainStyledAttributes&quot;, IntArray::class.java).hook(
<b>diff --git a/<a id="h2" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/CallStartConfirmation.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/CallStartConfirmation.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/CallStartConfirmation.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/CallStartConfirmation.kt</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -9,6 +9,7 @@ import me.rhunk.snapenhance.core.ui.ViewAppearanceHelper
</a> import me.rhunk.snapenhance.core.util.hook.HookAdapter
 import me.rhunk.snapenhance.core.util.hook.HookStage
 import me.rhunk.snapenhance.core.util.hook.hook
<a href="#h2-0-3" id="h2-0-3" class="i">+import me.rhunk.snapenhance.core.util.ktx.getId
</a> 
 class CallStartConfirmation : Feature(&quot;CallStartConfirmation&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_SYNC) {
     private fun hookTouchEvent(param: HookAdapter, motionEvent: MotionEvent, onConfirm: () -&gt; Unit) {
<a href="#h2-1" id="h2-1" class="h">@@ -33,8 +34,8 @@ class CallStartConfirmation : Feature(&quot;CallStartConfirmation&quot;, loadParams = Feat
</a>             }
         }
 
<a href="#h2-1-3" id="h2-1-3" class="d">-        val callButton1 = context.resources.getIdentifier(&quot;friend_action_button3&quot;, &quot;id&quot;, &quot;com.snapchat.android&quot;)
</a><a href="#h2-1-4" id="h2-1-4" class="d">-        val callButton2 = context.resources.getIdentifier(&quot;friend_action_button4&quot;, &quot;id&quot;, &quot;com.snapchat.android&quot;)
</a><a href="#h2-1-5" id="h2-1-5" class="i">+        val callButton1 = context.resources.getId(&quot;friend_action_button3&quot;)
</a><a href="#h2-1-6" id="h2-1-6" class="i">+        val callButton2 = context.resources.getId(&quot;friend_action_button4&quot;)
</a> 
         findClass(&quot;com.snap.ui.view.stackdraw.StackDrawLayout&quot;).hook(&quot;onTouchEvent&quot;, HookStage.BEFORE) { param -&gt;
             val view = param.thisObject&lt;View&gt;()
<b>diff --git a/<a id="h3" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/SendOverride.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/SendOverride.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/SendOverride.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/SendOverride.kt</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -1,6 +1,5 @@
</a> package me.rhunk.snapenhance.core.features.impl.messaging
 
<a href="#h3-0-2" id="h3-0-2" class="d">-import me.rhunk.snapenhance.common.Constants
</a> import me.rhunk.snapenhance.common.data.ContentType
 import me.rhunk.snapenhance.common.util.protobuf.ProtoEditor
 import me.rhunk.snapenhance.common.util.protobuf.ProtoReader
<a href="#h3-1" id="h3-1" class="h">@@ -14,6 +13,7 @@ import me.rhunk.snapenhance.nativelib.NativeLib
</a> 
 class SendOverride : Feature(&quot;Send Override&quot;, loadParams = FeatureLoadParams.INIT_SYNC) {
     private var isLastSnapSavable = false
<a href="#h3-1-3" id="h3-1-3" class="i">+    private val arroyoMessageContainerPath = intArrayOf(4, 4)
</a>     private val typeNames by lazy {
         mutableListOf(
             &quot;ORIGINAL&quot;,
<a href="#h3-2" id="h3-2" class="h">@@ -33,8 +33,8 @@ class SendOverride : Feature(&quot;Send Override&quot;, loadParams = FeatureLoadParams.INI
</a>             if (event.uri != &quot;/messagingcoreservice.MessagingCoreService/CreateContentMessage&quot;) return@subscribe
             val protoEditor = ProtoEditor(event.buffer)
 
<a href="#h3-2-3" id="h3-2-3" class="d">-            if (isLastSnapSavable &amp;&amp; ProtoReader(event.buffer).containsPath(*Constants.ARROYO_MEDIA_CONTAINER_PROTO_PATH, 11)) {
</a><a href="#h3-2-4" id="h3-2-4" class="d">-                protoEditor.edit(*Constants.ARROYO_MEDIA_CONTAINER_PROTO_PATH, 11, 5, 2) {
</a><a href="#h3-2-5" id="h3-2-5" class="i">+            if (isLastSnapSavable &amp;&amp; ProtoReader(event.buffer).containsPath(*arroyoMessageContainerPath, 11)) {
</a><a href="#h3-2-6" id="h3-2-6" class="i">+                protoEditor.edit(*arroyoMessageContainerPath, 11, 5, 2) {
</a>                     remove(8)
                     addBuffer(6, byteArrayOf())
                 }
<b>diff --git a/<a id="h4" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/FriendFeedMessagePreview.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/FriendFeedMessagePreview.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/FriendFeedMessagePreview.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/FriendFeedMessagePreview.kt</a></b>
<a href="#h4-0" id="h4-0" class="h">@@ -9,7 +9,6 @@ import android.graphics.drawable.shapes.Shape
</a> import android.text.TextPaint
 import android.view.View
 import android.view.ViewGroup
<a href="#h4-0-3" id="h4-0-3" class="d">-import me.rhunk.snapenhance.common.Constants
</a> import me.rhunk.snapenhance.common.data.ContentType
 import me.rhunk.snapenhance.common.util.protobuf.ProtoReader
 import me.rhunk.snapenhance.core.event.events.impl.BindViewEvent
<a href="#h4-1" id="h4-1" class="h">@@ -19,20 +18,21 @@ import me.rhunk.snapenhance.core.features.impl.experiments.EndToEndEncryption
</a> import me.rhunk.snapenhance.core.ui.addForegroundDrawable
 import me.rhunk.snapenhance.core.ui.removeForegroundDrawable
 import me.rhunk.snapenhance.core.util.EvictingMap
<a href="#h4-1-3" id="h4-1-3" class="i">+import me.rhunk.snapenhance.core.util.ktx.getDimens
</a><a href="#h4-1-4" id="h4-1-4" class="i">+import me.rhunk.snapenhance.core.util.ktx.getId
</a><a href="#h4-1-5" id="h4-1-5" class="i">+import me.rhunk.snapenhance.core.util.ktx.getIdentifier
</a> import kotlin.math.absoluteValue
 
 @SuppressLint(&quot;DiscouragedApi&quot;)
 class FriendFeedMessagePreview : Feature(&quot;FriendFeedMessagePreview&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_SYNC) {
     private val sigColorTextPrimary by lazy {
         context.mainActivity!!.theme.obtainStyledAttributes(
<a href="#h4-1-12" id="h4-1-12" class="d">-            intArrayOf(context.resources.getIdentifier(&quot;sigColorTextPrimary&quot;, &quot;attr&quot;, Constants.SNAPCHAT_PACKAGE_NAME))
</a><a href="#h4-1-13" id="h4-1-13" class="i">+            intArrayOf(context.resources.getIdentifier(&quot;sigColorTextPrimary&quot;, &quot;attr&quot;))
</a>         ).getColor(0, 0)
     }
 
     private val friendNameCache = EvictingMap&lt;String, String&gt;(100)
 
<a href="#h4-1-19" id="h4-1-19" class="d">-    private fun getDimens(name: String) = context.resources.getDimensionPixelSize(context.resources.getIdentifier(name, &quot;dimen&quot;, Constants.SNAPCHAT_PACKAGE_NAME))
</a><a href="#h4-1-20" id="h4-1-20" class="d">-
</a>     override fun onActivityCreate() {
         val setting = context.config.userInterface.friendFeedMessagePreview
         if (setting.globalState != true) return
<a href="#h4-2" id="h4-2" class="h">@@ -40,13 +40,13 @@ class FriendFeedMessagePreview : Feature(&quot;FriendFeedMessagePreview&quot;, loadParams 
</a>         val hasE2EE = context.config.experimental.e2eEncryption.globalState == true
         val endToEndEncryption by lazy { context.feature(EndToEndEncryption::class) }
 
<a href="#h4-2-3" id="h4-2-3" class="d">-        val ffItemId = context.resources.getIdentifier(&quot;ff_item&quot;, &quot;id&quot;, Constants.SNAPCHAT_PACKAGE_NAME)
</a><a href="#h4-2-4" id="h4-2-4" class="i">+        val ffItemId = context.resources.getId(&quot;ff_item&quot;)
</a> 
<a href="#h4-2-6" id="h4-2-6" class="d">-        val secondaryTextSize = getDimens(&quot;ff_feed_cell_secondary_text_size&quot;).toFloat()
</a><a href="#h4-2-7" id="h4-2-7" class="d">-        val ffSdlAvatarMargin = getDimens(&quot;ff_sdl_avatar_margin&quot;)
</a><a href="#h4-2-8" id="h4-2-8" class="d">-        val ffSdlAvatarSize = getDimens(&quot;ff_sdl_avatar_size&quot;)
</a><a href="#h4-2-9" id="h4-2-9" class="d">-        val ffSdlAvatarStartMargin = getDimens(&quot;ff_sdl_avatar_start_margin&quot;)
</a><a href="#h4-2-10" id="h4-2-10" class="d">-        val ffSdlPrimaryTextStartMargin = getDimens(&quot;ff_sdl_primary_text_start_margin&quot;).toFloat()
</a><a href="#h4-2-11" id="h4-2-11" class="i">+        val secondaryTextSize = context.resources.getDimens(&quot;ff_feed_cell_secondary_text_size&quot;).toFloat()
</a><a href="#h4-2-12" id="h4-2-12" class="i">+        val ffSdlAvatarMargin = context.resources.getDimens(&quot;ff_sdl_avatar_margin&quot;)
</a><a href="#h4-2-13" id="h4-2-13" class="i">+        val ffSdlAvatarSize = context.resources.getDimens(&quot;ff_sdl_avatar_size&quot;)
</a><a href="#h4-2-14" id="h4-2-14" class="i">+        val ffSdlAvatarStartMargin = context.resources.getDimens(&quot;ff_sdl_avatar_start_margin&quot;)
</a><a href="#h4-2-15" id="h4-2-15" class="i">+        val ffSdlPrimaryTextStartMargin = context.resources.getDimens(&quot;ff_sdl_primary_text_start_margin&quot;).toFloat()
</a> 
         val feedEntryHeight = ffSdlAvatarSize + ffSdlAvatarMargin * 2 + ffSdlAvatarStartMargin
         val separatorHeight = (context.resources.displayMetrics.density * 2).toInt()
<b>diff --git a/<a id="h5" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/SnapPreview.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/SnapPreview.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/SnapPreview.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/SnapPreview.kt</a></b>
<a href="#h5-0" id="h5-0" class="h">@@ -1,10 +1,11 @@
</a> package me.rhunk.snapenhance.core.features.impl.ui
 
 import android.annotation.SuppressLint
<a href="#h5-0-3" id="h5-0-3" class="d">-import android.graphics.*
</a><a href="#h5-0-4" id="h5-0-4" class="i">+import android.graphics.Bitmap
</a><a href="#h5-0-5" id="h5-0-5" class="i">+import android.graphics.Canvas
</a><a href="#h5-0-6" id="h5-0-6" class="i">+import android.graphics.Paint
</a> import android.graphics.drawable.ShapeDrawable
 import android.graphics.drawable.shapes.Shape
<a href="#h5-0-9" id="h5-0-9" class="d">-import me.rhunk.snapenhance.common.Constants
</a> import me.rhunk.snapenhance.common.data.ContentType
 import me.rhunk.snapenhance.common.util.protobuf.ProtoReader
 import me.rhunk.snapenhance.core.event.events.impl.BindViewEvent
<a href="#h5-1" id="h5-1" class="h">@@ -15,6 +16,7 @@ import me.rhunk.snapenhance.core.ui.removeForegroundDrawable
</a> import me.rhunk.snapenhance.core.util.EvictingMap
 import me.rhunk.snapenhance.core.util.hook.HookStage
 import me.rhunk.snapenhance.core.util.hook.hook
<a href="#h5-1-3" id="h5-1-3" class="i">+import me.rhunk.snapenhance.core.util.ktx.getDimens
</a> import me.rhunk.snapenhance.core.util.ktx.getObjectField
 import me.rhunk.snapenhance.core.util.media.PreviewUtils
 import java.io.File
<a href="#h5-2" id="h5-2" class="h">@@ -44,9 +46,9 @@ class SnapPreview : Feature(&quot;SnapPreview&quot;, loadParams = FeatureLoadParams.INIT_S
</a>     @SuppressLint(&quot;DiscouragedApi&quot;)
     override fun onActivityCreate() {
         if (!isEnabled) return
<a href="#h5-2-3" id="h5-2-3" class="d">-        val chatMediaCardHeight = context.resources.getDimensionPixelSize(context.resources.getIdentifier(&quot;chat_media_card_height&quot;, &quot;dimen&quot;, Constants.SNAPCHAT_PACKAGE_NAME))
</a><a href="#h5-2-4" id="h5-2-4" class="d">-        val chatMediaCardSnapMargin = context.resources.getDimensionPixelSize(context.resources.getIdentifier(&quot;chat_media_card_snap_margin&quot;, &quot;dimen&quot;, Constants.SNAPCHAT_PACKAGE_NAME))
</a><a href="#h5-2-5" id="h5-2-5" class="d">-        val chatMediaCardSnapMarginStartSdl = context.resources.getDimensionPixelSize(context.resources.getIdentifier(&quot;chat_media_card_snap_margin_start_sdl&quot;, &quot;dimen&quot;, Constants.SNAPCHAT_PACKAGE_NAME))
</a><a href="#h5-2-6" id="h5-2-6" class="i">+        val chatMediaCardHeight = context.resources.getDimens(&quot;chat_media_card_height&quot;)
</a><a href="#h5-2-7" id="h5-2-7" class="i">+        val chatMediaCardSnapMargin = context.resources.getDimens(&quot;chat_media_card_snap_margin&quot;)
</a><a href="#h5-2-8" id="h5-2-8" class="i">+        val chatMediaCardSnapMarginStartSdl = context.resources.getDimens(&quot;chat_media_card_snap_margin_start_sdl&quot;)
</a> 
         fun decodeMedia(file: File) = runCatching {
             bitmapCache.getOrPut(file.absolutePath) {
<b>diff --git a/<a id="h6" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/UITweaks.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/UITweaks.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/UITweaks.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/UITweaks.kt</a></b>
<a href="#h6-0" id="h6-0" class="h">@@ -7,21 +7,21 @@ import android.text.SpannableString
</a> import android.view.View
 import android.view.ViewGroup.MarginLayoutParams
 import android.widget.FrameLayout
<a href="#h6-0-3" id="h6-0-3" class="d">-import me.rhunk.snapenhance.common.Constants
</a> import me.rhunk.snapenhance.core.event.events.impl.AddViewEvent
 import me.rhunk.snapenhance.core.features.Feature
 import me.rhunk.snapenhance.core.features.FeatureLoadParams
 import me.rhunk.snapenhance.core.util.hook.HookStage
 import me.rhunk.snapenhance.core.util.hook.Hooker
 import me.rhunk.snapenhance.core.util.hook.hook
<a href="#h6-0-10" id="h6-0-10" class="i">+import me.rhunk.snapenhance.core.util.ktx.getIdentifier
</a> 
 class UITweaks : Feature(&quot;UITweaks&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_SYNC) {
     private val identifierCache = mutableMapOf&lt;String, Int&gt;()
 
     @SuppressLint(&quot;DiscouragedApi&quot;)
<a href="#h6-0-16" id="h6-0-16" class="d">-    fun getIdentifier(name: String, defType: String): Int {
</a><a href="#h6-0-17" id="h6-0-17" class="i">+    fun getId(name: String, defType: String): Int {
</a>         return identifierCache.getOrPut(&quot;$name:$defType&quot;) {
<a href="#h6-0-19" id="h6-0-19" class="d">-            context.resources.getIdentifier(name, defType, Constants.SNAPCHAT_PACKAGE_NAME)
</a><a href="#h6-0-20" id="h6-0-20" class="i">+            context.resources.getIdentifier(name, defType)
</a>         }
     }
 
<a href="#h6-1" id="h6-1" class="h">@@ -45,11 +45,11 @@ class UITweaks : Feature(&quot;UITweaks&quot;, loadParams = FeatureLoadParams.ACTIVITY_CRE
</a>         val displayMetrics = context.resources.displayMetrics
         val deviceAspectRatio = displayMetrics.widthPixels.toFloat() / displayMetrics.heightPixels.toFloat()
 
<a href="#h6-1-3" id="h6-1-3" class="d">-        val callButtonsStub = getIdentifier(&quot;call_buttons_stub&quot;, &quot;id&quot;)
</a><a href="#h6-1-4" id="h6-1-4" class="d">-        val callButton1 = getIdentifier(&quot;friend_action_button3&quot;, &quot;id&quot;)
</a><a href="#h6-1-5" id="h6-1-5" class="d">-        val callButton2 = getIdentifier(&quot;friend_action_button4&quot;, &quot;id&quot;)
</a><a href="#h6-1-6" id="h6-1-6" class="i">+        val callButtonsStub = getId(&quot;call_buttons_stub&quot;, &quot;id&quot;)
</a><a href="#h6-1-7" id="h6-1-7" class="i">+        val callButton1 = getId(&quot;friend_action_button3&quot;, &quot;id&quot;)
</a><a href="#h6-1-8" id="h6-1-8" class="i">+        val callButton2 = getId(&quot;friend_action_button4&quot;, &quot;id&quot;)
</a> 
<a href="#h6-1-10" id="h6-1-10" class="d">-        val chatNoteRecordButton = getIdentifier(&quot;chat_note_record_button&quot;, &quot;id&quot;)
</a><a href="#h6-1-11" id="h6-1-11" class="i">+        val chatNoteRecordButton = getId(&quot;chat_note_record_button&quot;, &quot;id&quot;)
</a> 
         View::class.java.hook(&quot;setVisibility&quot;, HookStage.BEFORE) { methodParam -&gt;
             val viewId = (methodParam.thisObject() as View).id
<a href="#h6-2" id="h6-2" class="h">@@ -64,8 +64,8 @@ class UITweaks : Feature(&quot;UITweaks&quot;, loadParams = FeatureLoadParams.ACTIVITY_CRE
</a>             { isImmersiveCamera }
         ) { param -&gt;
             val id = param.arg&lt;Int&gt;(0)
<a href="#h6-2-3" id="h6-2-3" class="d">-            if (id == getIdentifier(&quot;capri_viewfinder_default_corner_radius&quot;, &quot;dimen&quot;) ||
</a><a href="#h6-2-4" id="h6-2-4" class="d">-                id == getIdentifier(&quot;ngs_hova_nav_larger_camera_button_size&quot;, &quot;dimen&quot;)) {
</a><a href="#h6-2-5" id="h6-2-5" class="i">+            if (id == getId(&quot;capri_viewfinder_default_corner_radius&quot;, &quot;dimen&quot;) ||
</a><a href="#h6-2-6" id="h6-2-6" class="i">+                id == getId(&quot;ngs_hova_nav_larger_camera_button_size&quot;, &quot;dimen&quot;)) {
</a>                 param.setResult(0)
             }
         }
<a href="#h6-3" id="h6-3" class="h">@@ -75,17 +75,17 @@ class UITweaks : Feature(&quot;UITweaks&quot;, loadParams = FeatureLoadParams.ACTIVITY_CRE
</a>             val view = event.view
 
             if (hideStorySections.contains(&quot;hide_for_you&quot;)) {
<a href="#h6-3-3" id="h6-3-3" class="d">-                if (viewId == getIdentifier(&quot;df_large_story&quot;, &quot;id&quot;) ||
</a><a href="#h6-3-4" id="h6-3-4" class="d">-                            viewId == getIdentifier(&quot;df_promoted_story&quot;, &quot;id&quot;)) {
</a><a href="#h6-3-5" id="h6-3-5" class="i">+                if (viewId == getId(&quot;df_large_story&quot;, &quot;id&quot;) ||
</a><a href="#h6-3-6" id="h6-3-6" class="i">+                            viewId == getId(&quot;df_promoted_story&quot;, &quot;id&quot;)) {
</a>                     hideStorySection(event)
                     return@subscribe
                 }
<a href="#h6-3-10" id="h6-3-10" class="d">-                if (viewId == getIdentifier(&quot;stories_load_progress_layout&quot;, &quot;id&quot;)) {
</a><a href="#h6-3-11" id="h6-3-11" class="i">+                if (viewId == getId(&quot;stories_load_progress_layout&quot;, &quot;id&quot;)) {
</a>                     event.canceled = true
                 }
             }
 
<a href="#h6-3-16" id="h6-3-16" class="d">-            if (hideStorySections.contains(&quot;hide_friends&quot;) &amp;&amp; viewId == getIdentifier(&quot;friend_card_frame&quot;, &quot;id&quot;)) {
</a><a href="#h6-3-17" id="h6-3-17" class="i">+            if (hideStorySections.contains(&quot;hide_friends&quot;) &amp;&amp; viewId == getId(&quot;friend_card_frame&quot;, &quot;id&quot;)) {
</a>                 hideStorySection(event)
             }
 
<a href="#h6-4" id="h6-4" class="h">@@ -103,24 +103,24 @@ class UITweaks : Feature(&quot;UITweaks&quot;, loadParams = FeatureLoadParams.ACTIVITY_CRE
</a>                 }
             }
 
<a href="#h6-4-3" id="h6-4-3" class="d">-            if (hideStorySections.contains(&quot;hide_suggested&quot;) &amp;&amp; (viewId == getIdentifier(&quot;df_small_story&quot;, &quot;id&quot;))
</a><a href="#h6-4-4" id="h6-4-4" class="i">+            if (hideStorySections.contains(&quot;hide_suggested&quot;) &amp;&amp; (viewId == getId(&quot;df_small_story&quot;, &quot;id&quot;))
</a>             ) {
                 hideStorySection(event)
             }
 
<a href="#h6-4-9" id="h6-4-9" class="d">-            if (blockAds &amp;&amp; viewId == getIdentifier(&quot;df_promoted_story&quot;, &quot;id&quot;)) {
</a><a href="#h6-4-10" id="h6-4-10" class="i">+            if (blockAds &amp;&amp; viewId == getId(&quot;df_promoted_story&quot;, &quot;id&quot;)) {
</a>                 hideStorySection(event)
             }
 
             if (isImmersiveCamera) {
<a href="#h6-4-15" id="h6-4-15" class="d">-                if (view.id == getIdentifier(&quot;edits_container&quot;, &quot;id&quot;)) {
</a><a href="#h6-4-16" id="h6-4-16" class="i">+                if (view.id == getId(&quot;edits_container&quot;, &quot;id&quot;)) {
</a>                     Hooker.hookObjectMethod(View::class.java, view, &quot;layout&quot;, HookStage.BEFORE) {
                         val width = it.arg(2) as Int
                         val realHeight = (width / deviceAspectRatio).toInt()
                         it.setArg(3, realHeight)
                     }
                 }
<a href="#h6-4-23" id="h6-4-23" class="d">-                if (view.id == getIdentifier(&quot;full_screen_surface_view&quot;, &quot;id&quot;)) {
</a><a href="#h6-4-24" id="h6-4-24" class="i">+                if (view.id == getId(&quot;full_screen_surface_view&quot;, &quot;id&quot;)) {
</a>                     Hooker.hookObjectMethod(View::class.java, view, &quot;layout&quot;, HookStage.BEFORE) {
                         it.setArg(1, 1)
                         it.setArg(3, displayMetrics.heightPixels)
<a href="#h6-5" id="h6-5" class="h">@@ -130,8 +130,8 @@ class UITweaks : Feature(&quot;UITweaks&quot;, loadParams = FeatureLoadParams.ACTIVITY_CRE
</a> 
             if (
                 (viewId == chatNoteRecordButton &amp;&amp; hiddenElements.contains(&quot;hide_voice_record_button&quot;)) ||
<a href="#h6-5-3" id="h6-5-3" class="d">-                (viewId == getIdentifier(&quot;chat_input_bar_sticker&quot;, &quot;id&quot;) &amp;&amp; hiddenElements.contains(&quot;hide_stickers_button&quot;)) ||
</a><a href="#h6-5-4" id="h6-5-4" class="d">-                (viewId == getIdentifier(&quot;chat_input_bar_sharing_drawer_button&quot;, &quot;id&quot;) &amp;&amp; hiddenElements.contains(&quot;hide_live_location_share_button&quot;)) ||
</a><a href="#h6-5-5" id="h6-5-5" class="i">+                (viewId == getId(&quot;chat_input_bar_sticker&quot;, &quot;id&quot;) &amp;&amp; hiddenElements.contains(&quot;hide_stickers_button&quot;)) ||
</a><a href="#h6-5-6" id="h6-5-6" class="i">+                (viewId == getId(&quot;chat_input_bar_sharing_drawer_button&quot;, &quot;id&quot;) &amp;&amp; hiddenElements.contains(&quot;hide_live_location_share_button&quot;)) ||
</a>                 (viewId == callButtonsStub &amp;&amp; hiddenElements.contains(&quot;hide_chat_call_buttons&quot;))
             ) {
                 view.apply {
<b>diff --git a/<a id="h7" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/messaging/MessageExporter.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/messaging/MessageExporter.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/messaging/MessageExporter.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/messaging/MessageExporter.kt</a></b>
<a href="#h7-0" id="h7-0" class="h">@@ -22,7 +22,11 @@ import me.rhunk.snapenhance.core.features.impl.downloader.decoder.AttachmentType
</a> import me.rhunk.snapenhance.core.features.impl.downloader.decoder.MessageDecoder
 import me.rhunk.snapenhance.core.wrapper.impl.Message
 import me.rhunk.snapenhance.core.wrapper.impl.SnapUUID
<a href="#h7-0-3" id="h7-0-3" class="d">-import java.io.*
</a><a href="#h7-0-4" id="h7-0-4" class="i">+import java.io.BufferedInputStream
</a><a href="#h7-0-5" id="h7-0-5" class="i">+import java.io.File
</a><a href="#h7-0-6" id="h7-0-6" class="i">+import java.io.FileOutputStream
</a><a href="#h7-0-7" id="h7-0-7" class="i">+import java.io.InputStream
</a><a href="#h7-0-8" id="h7-0-8" class="i">+import java.io.OutputStream
</a> import java.text.SimpleDateFormat
 import java.util.Collections
 import java.util.Date
<a href="#h7-1" id="h7-1" class="h">@@ -96,7 +100,7 @@ class MessageExporter(
</a>         writer.flush()
     }
 
<a href="#h7-1-3" id="h7-1-3" class="d">-    suspend fun exportHtml(output: OutputStream) {
</a><a href="#h7-1-4" id="h7-1-4" class="i">+    private suspend fun exportHtml(output: OutputStream) {
</a>         val downloadMediaCacheFolder = File(Environment.getExternalStoragePublicDirectory(Environment.DIRECTORY_DOWNLOADS), &quot;SnapEnhance/cache&quot;).also { it.mkdirs() }
         val mediaFiles = Collections.synchronizedMap(mutableMapOf&lt;String, Pair&lt;FileType, File&gt;&gt;())
         val threadPool = Executors.newFixedThreadPool(15)
<a href="#h7-2" id="h7-2" class="h">@@ -318,14 +322,15 @@ class MessageExporter(
</a>     }
 
     suspend fun exportTo(exportFormat: ExportFormat) {
<a href="#h7-2-3" id="h7-2-3" class="d">-        val output = FileOutputStream(outputFile)
</a><a href="#h7-2-4" id="h7-2-4" class="d">-
</a><a href="#h7-2-5" id="h7-2-5" class="d">-        when (exportFormat) {
</a><a href="#h7-2-6" id="h7-2-6" class="d">-            ExportFormat.HTML -&gt; exportHtml(output)
</a><a href="#h7-2-7" id="h7-2-7" class="d">-            ExportFormat.JSON -&gt; exportJson(output)
</a><a href="#h7-2-8" id="h7-2-8" class="d">-            ExportFormat.TEXT -&gt; exportText(output)
</a><a href="#h7-2-9" id="h7-2-9" class="i">+        withContext(Dispatchers.IO) {
</a><a href="#h7-2-10" id="h7-2-10" class="i">+            FileOutputStream(outputFile).apply {
</a><a href="#h7-2-11" id="h7-2-11" class="i">+                when (exportFormat) {
</a><a href="#h7-2-12" id="h7-2-12" class="i">+                    ExportFormat.HTML -&gt; exportHtml(this)
</a><a href="#h7-2-13" id="h7-2-13" class="i">+                    ExportFormat.JSON -&gt; exportJson(this)
</a><a href="#h7-2-14" id="h7-2-14" class="i">+                    ExportFormat.TEXT -&gt; exportText(this)
</a><a href="#h7-2-15" id="h7-2-15" class="i">+                }
</a><a href="#h7-2-16" id="h7-2-16" class="i">+                close()
</a><a href="#h7-2-17" id="h7-2-17" class="i">+            }
</a>         }
<a href="#h7-2-19" id="h7-2-19" class="d">-
</a><a href="#h7-2-20" id="h7-2-20" class="d">-        output.close()
</a>     }
 } 
\ No newline at end of file
<b>diff --git a/<a id="h8" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/ui/ViewAppearanceHelper.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/ViewAppearanceHelper.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/ui/ViewAppearanceHelper.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/ViewAppearanceHelper.kt</a></b>
<a href="#h8-0" id="h8-0" class="h">@@ -12,11 +12,14 @@ import android.graphics.drawable.Drawable
</a> import android.graphics.drawable.ShapeDrawable
 import android.graphics.drawable.StateListDrawable
 import android.graphics.drawable.shapes.Shape
<a href="#h8-0-3" id="h8-0-3" class="i">+import android.os.SystemClock
</a> import android.view.Gravity
<a href="#h8-0-5" id="h8-0-5" class="i">+import android.view.MotionEvent
</a> import android.view.View
 import android.widget.Switch
 import android.widget.TextView
<a href="#h8-0-9" id="h8-0-9" class="d">-import me.rhunk.snapenhance.common.Constants
</a><a href="#h8-0-10" id="h8-0-10" class="i">+import me.rhunk.snapenhance.core.util.ktx.getDimens
</a><a href="#h8-0-11" id="h8-0-11" class="i">+import me.rhunk.snapenhance.core.util.ktx.getIdentifier
</a> import kotlin.random.Random
 
 fun View.applyTheme(componentWidth: Int? = null, hasRadius: Boolean = false, isAmoled: Boolean = true) {
<a href="#h8-1" id="h8-1" class="h">@@ -54,11 +57,28 @@ fun View.addForegroundDrawable(tag: String, drawable: Drawable) {
</a>     updateForegroundDrawable()
 }
 
<a href="#h8-1-3" id="h8-1-3" class="i">+fun View.triggerCloseTouchEvent() {
</a><a href="#h8-1-4" id="h8-1-4" class="i">+    arrayOf(MotionEvent.ACTION_DOWN, MotionEvent.ACTION_UP).forEach {
</a><a href="#h8-1-5" id="h8-1-5" class="i">+        this.dispatchTouchEvent(
</a><a href="#h8-1-6" id="h8-1-6" class="i">+            MotionEvent.obtain(
</a><a href="#h8-1-7" id="h8-1-7" class="i">+                SystemClock.uptimeMillis(),
</a><a href="#h8-1-8" id="h8-1-8" class="i">+                SystemClock.uptimeMillis(),
</a><a href="#h8-1-9" id="h8-1-9" class="i">+                it, 0f, 0f, 0
</a><a href="#h8-1-10" id="h8-1-10" class="i">+            )
</a><a href="#h8-1-11" id="h8-1-11" class="i">+        )
</a><a href="#h8-1-12" id="h8-1-12" class="i">+    }
</a><a href="#h8-1-13" id="h8-1-13" class="i">+}
</a><a href="#h8-1-14" id="h8-1-14" class="i">+
</a><a href="#h8-1-15" id="h8-1-15" class="i">+fun View.iterateParent(predicate: (View) -&gt; Boolean) {
</a><a href="#h8-1-16" id="h8-1-16" class="i">+    var parent = this.parent as? View ?: return
</a><a href="#h8-1-17" id="h8-1-17" class="i">+    while (true) {
</a><a href="#h8-1-18" id="h8-1-18" class="i">+        if (predicate(parent)) return
</a><a href="#h8-1-19" id="h8-1-19" class="i">+        parent = parent.parent as? View ?: return
</a><a href="#h8-1-20" id="h8-1-20" class="i">+    }
</a><a href="#h8-1-21" id="h8-1-21" class="i">+}
</a><a href="#h8-1-22" id="h8-1-22" class="i">+
</a> 
 object ViewAppearanceHelper {
<a href="#h8-1-25" id="h8-1-25" class="d">-    @SuppressLint(&quot;UseSwitchCompatOrMaterialCode&quot;, &quot;RtlHardcoded&quot;, &quot;DiscouragedApi&quot;,
</a><a href="#h8-1-26" id="h8-1-26" class="d">-        &quot;ClickableViewAccessibility&quot;
</a><a href="#h8-1-27" id="h8-1-27" class="d">-    )
</a>     private var sigColorTextPrimary: Int = 0
     private var sigColorBackgroundSurface: Int = 0
 
<a href="#h8-2" id="h8-2" class="h">@@ -81,16 +101,16 @@ object ViewAppearanceHelper {
</a>         if (sigColorBackgroundSurface == 0 || sigColorTextPrimary == 0) {
             with(component.context.theme) {
                 sigColorTextPrimary = obtainStyledAttributes(
<a href="#h8-2-3" id="h8-2-3" class="d">-                    intArrayOf(resources.getIdentifier(&quot;sigColorTextPrimary&quot;, &quot;attr&quot;, Constants.SNAPCHAT_PACKAGE_NAME))
</a><a href="#h8-2-4" id="h8-2-4" class="i">+                    intArrayOf(resources.getIdentifier(&quot;sigColorTextPrimary&quot;, &quot;attr&quot;))
</a>                 ).getColor(0, 0)
 
                 sigColorBackgroundSurface = obtainStyledAttributes(
<a href="#h8-2-8" id="h8-2-8" class="d">-                    intArrayOf(resources.getIdentifier(&quot;sigColorBackgroundSurface&quot;, &quot;attr&quot;, Constants.SNAPCHAT_PACKAGE_NAME))
</a><a href="#h8-2-9" id="h8-2-9" class="i">+                    intArrayOf(resources.getIdentifier(&quot;sigColorBackgroundSurface&quot;, &quot;attr&quot;))
</a>                 ).getColor(0, 0)
             }
         }
 
<a href="#h8-2-14" id="h8-2-14" class="d">-        val snapchatFontResId = resources.getIdentifier(&quot;avenir_next_medium&quot;, &quot;font&quot;, Constants.SNAPCHAT_PACKAGE_NAME)
</a><a href="#h8-2-15" id="h8-2-15" class="i">+        val snapchatFontResId = resources.getIdentifier(&quot;avenir_next_medium&quot;, &quot;font&quot;)
</a>         val scalingFactor = resources.displayMetrics.densityDpi.toDouble() / 400
 
         with(component) {
<a href="#h8-3" id="h8-3" class="h">@@ -117,9 +137,7 @@ object ViewAppearanceHelper {
</a>         }
 
         if (component is Switch) {
<a href="#h8-3-3" id="h8-3-3" class="d">-            with(resources) {
</a><a href="#h8-3-4" id="h8-3-4" class="d">-                component.switchMinWidth = getDimension(getIdentifier(&quot;v11_switch_min_width&quot;, &quot;dimen&quot;, Constants.SNAPCHAT_PACKAGE_NAME)).toInt()
</a><a href="#h8-3-5" id="h8-3-5" class="d">-            }
</a><a href="#h8-3-6" id="h8-3-6" class="i">+            component.switchMinWidth = resources.getDimens(&quot;v11_switch_min_width&quot;)
</a>             component.trackTintList = ColorStateList(
                 arrayOf(intArrayOf(-android.R.attr.state_checked), intArrayOf(android.R.attr.state_checked)
                 ), intArrayOf(
<b>diff --git a/<a id="h9" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/AbstractMenu.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/AbstractMenu.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/AbstractMenu.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/AbstractMenu.kt</a></b>
<a href="#h9-0" id="h9-0" class="h">@@ -1,9 +1,13 @@
</a> package me.rhunk.snapenhance.core.ui.menu
 
<a href="#h9-0-2" id="h9-0-2" class="i">+import android.view.View
</a><a href="#h9-0-3" id="h9-0-3" class="i">+import android.view.ViewGroup
</a> import me.rhunk.snapenhance.core.ModContext
 
 abstract class AbstractMenu {
     lateinit var context: ModContext
 
<a href="#h9-0-9" id="h9-0-9" class="i">+    open fun inject(parent: ViewGroup, view: View, viewConsumer: (View) -&gt; Unit) {}
</a><a href="#h9-0-10" id="h9-0-10" class="i">+
</a>     open fun init() {}
 } 
\ No newline at end of file
<b>diff --git a/<a id="h10" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/ChatActionMenu.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/ChatActionMenu.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/ChatActionMenu.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/ChatActionMenu.kt</a></b>
<a href="#h10-0" id="h10-0" class="h">@@ -2,15 +2,12 @@ package me.rhunk.snapenhance.core.ui.menu.impl
</a> 
 import android.annotation.SuppressLint
 import android.content.Context
<a href="#h10-0-3" id="h10-0-3" class="d">-import android.os.SystemClock
</a><a href="#h10-0-4" id="h10-0-4" class="d">-import android.view.MotionEvent
</a> import android.view.View
 import android.view.ViewGroup
 import android.view.ViewGroup.MarginLayoutParams
 import android.widget.Button
 import android.widget.LinearLayout
 import android.widget.TextView
<a href="#h10-0-11" id="h10-0-11" class="d">-import me.rhunk.snapenhance.common.Constants
</a> import me.rhunk.snapenhance.common.data.ContentType
 import me.rhunk.snapenhance.common.util.protobuf.ProtoReader
 import me.rhunk.snapenhance.core.features.impl.downloader.MediaDownloader
<a href="#h10-1" id="h10-1" class="h">@@ -20,6 +17,8 @@ import me.rhunk.snapenhance.core.ui.ViewAppearanceHelper
</a> import me.rhunk.snapenhance.core.ui.ViewTagState
 import me.rhunk.snapenhance.core.ui.applyTheme
 import me.rhunk.snapenhance.core.ui.menu.AbstractMenu
<a href="#h10-1-3" id="h10-1-3" class="i">+import me.rhunk.snapenhance.core.ui.triggerCloseTouchEvent
</a><a href="#h10-1-4" id="h10-1-4" class="i">+import me.rhunk.snapenhance.core.util.ktx.getDimens
</a> import java.time.Instant
 
 
<a href="#h10-2" id="h10-2" class="h">@@ -27,35 +26,11 @@ import java.time.Instant
</a> class ChatActionMenu : AbstractMenu() {
     private val viewTagState = ViewTagState()
 
<a href="#h10-2-3" id="h10-2-3" class="d">-    private val defaultGap by lazy {
</a><a href="#h10-2-4" id="h10-2-4" class="d">-        context.androidContext.resources.getDimensionPixelSize(
</a><a href="#h10-2-5" id="h10-2-5" class="d">-            context.androidContext.resources.getIdentifier(
</a><a href="#h10-2-6" id="h10-2-6" class="d">-                &quot;default_gap&quot;,
</a><a href="#h10-2-7" id="h10-2-7" class="d">-                &quot;dimen&quot;,
</a><a href="#h10-2-8" id="h10-2-8" class="d">-                Constants.SNAPCHAT_PACKAGE_NAME
</a><a href="#h10-2-9" id="h10-2-9" class="d">-            )
</a><a href="#h10-2-10" id="h10-2-10" class="d">-        )
</a><a href="#h10-2-11" id="h10-2-11" class="d">-    }
</a><a href="#h10-2-12" id="h10-2-12" class="i">+    private val defaultGap by lazy { context.resources.getDimens(&quot;default_gap&quot;) }
</a> 
<a href="#h10-2-14" id="h10-2-14" class="d">-    private val chatActionMenuItemMargin by lazy {
</a><a href="#h10-2-15" id="h10-2-15" class="d">-        context.androidContext.resources.getDimensionPixelSize(
</a><a href="#h10-2-16" id="h10-2-16" class="d">-            context.androidContext.resources.getIdentifier(
</a><a href="#h10-2-17" id="h10-2-17" class="d">-                &quot;chat_action_menu_item_margin&quot;,
</a><a href="#h10-2-18" id="h10-2-18" class="d">-                &quot;dimen&quot;,
</a><a href="#h10-2-19" id="h10-2-19" class="d">-                Constants.SNAPCHAT_PACKAGE_NAME
</a><a href="#h10-2-20" id="h10-2-20" class="d">-            )
</a><a href="#h10-2-21" id="h10-2-21" class="d">-        )
</a><a href="#h10-2-22" id="h10-2-22" class="d">-    }
</a><a href="#h10-2-23" id="h10-2-23" class="i">+    private val chatActionMenuItemMargin by lazy { context.resources.getDimens(&quot;chat_action_menu_item_margin&quot;) }
</a> 
<a href="#h10-2-25" id="h10-2-25" class="d">-    private val actionMenuItemHeight by lazy {
</a><a href="#h10-2-26" id="h10-2-26" class="d">-        context.androidContext.resources.getDimensionPixelSize(
</a><a href="#h10-2-27" id="h10-2-27" class="d">-            context.androidContext.resources.getIdentifier(
</a><a href="#h10-2-28" id="h10-2-28" class="d">-                &quot;action_menu_item_height&quot;,
</a><a href="#h10-2-29" id="h10-2-29" class="d">-                &quot;dimen&quot;,
</a><a href="#h10-2-30" id="h10-2-30" class="d">-                Constants.SNAPCHAT_PACKAGE_NAME
</a><a href="#h10-2-31" id="h10-2-31" class="d">-            )
</a><a href="#h10-2-32" id="h10-2-32" class="d">-        )
</a><a href="#h10-2-33" id="h10-2-33" class="d">-    }
</a><a href="#h10-2-34" id="h10-2-34" class="i">+    private val actionMenuItemHeight by lazy { context.resources.getDimens(&quot;action_menu_item_height&quot;) }
</a> 
     private fun createContainer(viewGroup: ViewGroup): LinearLayout {
         val parent = viewGroup.parent.parent as ViewGroup
<a href="#h10-3" id="h10-3" class="h">@@ -87,22 +62,11 @@ class ChatActionMenu : AbstractMenu() {
</a>         get() = context.database.getConversationMessageFromId(context.feature(Messaging::class).lastFocusedMessageId)
 
     @SuppressLint(&quot;SetTextI18n&quot;, &quot;DiscouragedApi&quot;, &quot;ClickableViewAccessibility&quot;)
<a href="#h10-3-3" id="h10-3-3" class="d">-    fun inject(viewGroup: ViewGroup) {
</a><a href="#h10-3-4" id="h10-3-4" class="d">-        val parent = viewGroup.parent.parent as? ViewGroup ?: return
</a><a href="#h10-3-5" id="h10-3-5" class="d">-        if (viewTagState[parent]) return
</a><a href="#h10-3-6" id="h10-3-6" class="i">+    override fun inject(parent: ViewGroup, view: View, viewConsumer: (View) -&gt; Unit) {
</a><a href="#h10-3-7" id="h10-3-7" class="i">+        val viewGroup = parent.parent.parent as? ViewGroup ?: return
</a><a href="#h10-3-8" id="h10-3-8" class="i">+        if (viewTagState[viewGroup]) return
</a>         //close the action menu using a touch event
<a href="#h10-3-10" id="h10-3-10" class="d">-        val closeActionMenu = {
</a><a href="#h10-3-11" id="h10-3-11" class="d">-            viewGroup.dispatchTouchEvent(
</a><a href="#h10-3-12" id="h10-3-12" class="d">-                MotionEvent.obtain(
</a><a href="#h10-3-13" id="h10-3-13" class="d">-                    SystemClock.uptimeMillis(),
</a><a href="#h10-3-14" id="h10-3-14" class="d">-                    SystemClock.uptimeMillis(),
</a><a href="#h10-3-15" id="h10-3-15" class="d">-                    MotionEvent.ACTION_DOWN,
</a><a href="#h10-3-16" id="h10-3-16" class="d">-                    0f,
</a><a href="#h10-3-17" id="h10-3-17" class="d">-                    0f,
</a><a href="#h10-3-18" id="h10-3-18" class="d">-                    0
</a><a href="#h10-3-19" id="h10-3-19" class="d">-                )
</a><a href="#h10-3-20" id="h10-3-20" class="d">-            )
</a><a href="#h10-3-21" id="h10-3-21" class="d">-        }
</a><a href="#h10-3-22" id="h10-3-22" class="i">+        val closeActionMenu = { parent.triggerCloseTouchEvent() }
</a> 
         val messaging = context.feature(Messaging::class)
         val messageLogger = context.feature(MessageLogger::class)
<a href="#h10-4" id="h10-4" class="h">@@ -123,7 +87,7 @@ class ChatActionMenu : AbstractMenu() {
</a>             }
 
             with(button) {
<a href="#h10-4-3" id="h10-4-3" class="d">-                applyTheme(parent.width, true)
</a><a href="#h10-4-4" id="h10-4-4" class="i">+                applyTheme(viewGroup.width, true)
</a>                 layoutParams = MarginLayoutParams(
                     ViewGroup.LayoutParams.MATCH_PARENT,
                     ViewGroup.LayoutParams.WRAP_CONTENT
<a href="#h10-5" id="h10-5" class="h">@@ -168,7 +132,7 @@ class ChatActionMenu : AbstractMenu() {
</a>         }
 
         if (context.isDeveloper) {
<a href="#h10-5-3" id="h10-5-3" class="d">-            parent.addView(createContainer(viewGroup).apply {
</a><a href="#h10-5-4" id="h10-5-4" class="i">+            viewGroup.addView(createContainer(viewGroup).apply {
</a>                 val debugText = StringBuilder()
 
                 setOnClickListener {
<a href="#h10-6" id="h10-6" class="h">@@ -221,6 +185,6 @@ class ChatActionMenu : AbstractMenu() {
</a>             })
         }
 
<a href="#h10-6-3" id="h10-6-3" class="d">-        parent.addView(buttonContainer)
</a><a href="#h10-6-4" id="h10-6-4" class="i">+        viewGroup.addView(buttonContainer)
</a>     }
 }
<b>diff --git a/<a id="h11" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/FriendFeedInfoMenu.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/FriendFeedInfoMenu.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/FriendFeedInfoMenu.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/FriendFeedInfoMenu.kt</a></b>
<a href="#h11-0" id="h11-0" class="h">@@ -6,6 +6,7 @@ import android.graphics.BitmapFactory
</a> import android.graphics.drawable.BitmapDrawable
 import android.graphics.drawable.Drawable
 import android.view.View
<a href="#h11-0-3" id="h11-0-3" class="i">+import android.view.ViewGroup
</a> import android.widget.Button
 import android.widget.CompoundButton
 import android.widget.Switch
<a href="#h11-1" id="h11-1" class="h">@@ -221,7 +222,7 @@ class FriendFeedInfoMenu : AbstractMenu() {
</a>         viewConsumer(switch)
     }
 
<a href="#h11-1-3" id="h11-1-3" class="d">-    fun inject(viewModel: View, viewConsumer: ((View) -&gt; Unit)) {
</a><a href="#h11-1-4" id="h11-1-4" class="i">+    override fun inject(parent: ViewGroup, view: View, viewConsumer: ((View) -&gt; Unit)) {
</a>         val modContext = context
 
         val friendFeedMenuOptions by context.config.userInterface.friendFeedMenuButtons
<a href="#h11-2" id="h11-2" class="h">@@ -229,19 +230,17 @@ class FriendFeedInfoMenu : AbstractMenu() {
</a> 
         val (conversationId, targetUser) = getCurrentConversationInfo()
 
<a href="#h11-2-3" id="h11-2-3" class="d">-        val previewButton = Button(viewModel.context).apply {
</a><a href="#h11-2-4" id="h11-2-4" class="d">-            text = modContext.translation[&quot;friend_menu_option.preview&quot;]
</a><a href="#h11-2-5" id="h11-2-5" class="d">-            applyTheme(viewModel.width, hasRadius = true)
</a><a href="#h11-2-6" id="h11-2-6" class="d">-            setOnClickListener {
</a><a href="#h11-2-7" id="h11-2-7" class="d">-                showPreview(
</a><a href="#h11-2-8" id="h11-2-8" class="d">-                    targetUser,
</a><a href="#h11-2-9" id="h11-2-9" class="d">-                    conversationId
</a><a href="#h11-2-10" id="h11-2-10" class="d">-                )
</a><a href="#h11-2-11" id="h11-2-11" class="d">-            }
</a><a href="#h11-2-12" id="h11-2-12" class="d">-        }
</a><a href="#h11-2-13" id="h11-2-13" class="d">-
</a>         if (friendFeedMenuOptions.contains(&quot;conversation_info&quot;)) {
<a href="#h11-2-15" id="h11-2-15" class="d">-            viewConsumer(previewButton)
</a><a href="#h11-2-16" id="h11-2-16" class="i">+            viewConsumer(Button(view.context).apply {
</a><a href="#h11-2-17" id="h11-2-17" class="i">+                text = modContext.translation[&quot;friend_menu_option.preview&quot;]
</a><a href="#h11-2-18" id="h11-2-18" class="i">+                applyTheme(view.width, hasRadius = true)
</a><a href="#h11-2-19" id="h11-2-19" class="i">+                setOnClickListener {
</a><a href="#h11-2-20" id="h11-2-20" class="i">+                    showPreview(
</a><a href="#h11-2-21" id="h11-2-21" class="i">+                        targetUser,
</a><a href="#h11-2-22" id="h11-2-22" class="i">+                        conversationId
</a><a href="#h11-2-23" id="h11-2-23" class="i">+                    )
</a><a href="#h11-2-24" id="h11-2-24" class="i">+                }
</a><a href="#h11-2-25" id="h11-2-25" class="i">+            })
</a>         }
 
         modContext.features.getRuleFeatures().forEach { ruleFeature -&gt;
<b>diff --git a/<a id="h12" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/MenuViewInjector.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/MenuViewInjector.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/MenuViewInjector.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/MenuViewInjector.kt</a></b>
<a href="#h12-0" id="h12-0" class="h">@@ -6,43 +6,42 @@ import android.view.View
</a> import android.view.ViewGroup
 import android.widget.FrameLayout
 import android.widget.LinearLayout
<a href="#h12-0-3" id="h12-0-3" class="d">-import me.rhunk.snapenhance.common.Constants
</a> import me.rhunk.snapenhance.core.event.events.impl.AddViewEvent
 import me.rhunk.snapenhance.core.features.Feature
 import me.rhunk.snapenhance.core.features.FeatureLoadParams
 import me.rhunk.snapenhance.core.features.impl.messaging.Messaging
 import me.rhunk.snapenhance.core.ui.ViewTagState
<a href="#h12-0-9" id="h12-0-9" class="i">+import me.rhunk.snapenhance.core.ui.menu.AbstractMenu
</a><a href="#h12-0-10" id="h12-0-10" class="i">+import me.rhunk.snapenhance.core.util.ktx.getIdentifier
</a> import java.lang.reflect.Modifier
<a href="#h12-0-12" id="h12-0-12" class="i">+import kotlin.reflect.KClass
</a> 
 @SuppressLint(&quot;DiscouragedApi&quot;)
 class MenuViewInjector : Feature(&quot;MenuViewInjector&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_ASYNC) {
     private val viewTagState = ViewTagState()
 
<a href="#h12-0-18" id="h12-0-18" class="d">-    private val friendFeedInfoMenu = FriendFeedInfoMenu()
</a><a href="#h12-0-19" id="h12-0-19" class="d">-    private val operaContextActionMenu = OperaContextActionMenu()
</a><a href="#h12-0-20" id="h12-0-20" class="d">-    private val chatActionMenu = ChatActionMenu()
</a><a href="#h12-0-21" id="h12-0-21" class="d">-    private val settingMenu = SettingsMenu()
</a><a href="#h12-0-22" id="h12-0-22" class="d">-    private val settingsGearInjector = SettingsGearInjector()
</a><a href="#h12-0-23" id="h12-0-23" class="d">-
</a><a href="#h12-0-24" id="h12-0-24" class="i">+    private val menuMap = mutableMapOf&lt;KClass&lt;*&gt;, AbstractMenu&gt;()
</a>     private val newChatString by lazy {
<a href="#h12-0-26" id="h12-0-26" class="d">-        context.resources.getString(context.resources.getIdentifier(&quot;new_chat&quot;, &quot;string&quot;, Constants.SNAPCHAT_PACKAGE_NAME))
</a><a href="#h12-0-27" id="h12-0-27" class="i">+        context.resources.getString(context.resources.getIdentifier(&quot;new_chat&quot;, &quot;string&quot;))
</a>     }
 
     @SuppressLint(&quot;ResourceType&quot;)
     override fun asyncOnActivityCreate() {
<a href="#h12-0-32" id="h12-0-32" class="d">-        friendFeedInfoMenu.context = context
</a><a href="#h12-0-33" id="h12-0-33" class="d">-        operaContextActionMenu.context = context
</a><a href="#h12-0-34" id="h12-0-34" class="d">-        chatActionMenu.context = context
</a><a href="#h12-0-35" id="h12-0-35" class="d">-        settingMenu.context = context
</a><a href="#h12-0-36" id="h12-0-36" class="d">-        settingsGearInjector.context = context
</a><a href="#h12-0-37" id="h12-0-37" class="i">+        menuMap[SettingsGearInjector::class] = SettingsGearInjector()
</a><a href="#h12-0-38" id="h12-0-38" class="i">+        menuMap[FriendFeedInfoMenu::class] = FriendFeedInfoMenu()
</a><a href="#h12-0-39" id="h12-0-39" class="i">+        menuMap[OperaContextActionMenu::class] = OperaContextActionMenu()
</a><a href="#h12-0-40" id="h12-0-40" class="i">+        menuMap[ChatActionMenu::class] = ChatActionMenu()
</a><a href="#h12-0-41" id="h12-0-41" class="i">+        menuMap[SettingsMenu::class] = SettingsMenu()
</a><a href="#h12-0-42" id="h12-0-42" class="i">+
</a><a href="#h12-0-43" id="h12-0-43" class="i">+        menuMap.values.forEach { it.context = context }
</a> 
         val messaging = context.feature(Messaging::class)
 
<a href="#h12-0-47" id="h12-0-47" class="d">-        val actionSheetItemsContainerLayoutId = context.resources.getIdentifier(&quot;action_sheet_items_container&quot;, &quot;id&quot;, Constants.SNAPCHAT_PACKAGE_NAME)
</a><a href="#h12-0-48" id="h12-0-48" class="d">-        val actionSheetContainer = context.resources.getIdentifier(&quot;action_sheet_container&quot;, &quot;id&quot;, Constants.SNAPCHAT_PACKAGE_NAME)
</a><a href="#h12-0-49" id="h12-0-49" class="d">-        val actionMenu = context.resources.getIdentifier(&quot;action_menu&quot;, &quot;id&quot;, Constants.SNAPCHAT_PACKAGE_NAME)
</a><a href="#h12-0-50" id="h12-0-50" class="d">-        val componentsHolder = context.resources.getIdentifier(&quot;components_holder&quot;, &quot;id&quot;, Constants.SNAPCHAT_PACKAGE_NAME)
</a><a href="#h12-0-51" id="h12-0-51" class="d">-        val feedNewChat = context.resources.getIdentifier(&quot;feed_new_chat&quot;, &quot;id&quot;, Constants.SNAPCHAT_PACKAGE_NAME)
</a><a href="#h12-0-52" id="h12-0-52" class="i">+        val actionSheetItemsContainerLayoutId = context.resources.getIdentifier(&quot;action_sheet_items_container&quot;, &quot;id&quot;)
</a><a href="#h12-0-53" id="h12-0-53" class="i">+        val actionSheetContainer = context.resources.getIdentifier(&quot;action_sheet_container&quot;, &quot;id&quot;)
</a><a href="#h12-0-54" id="h12-0-54" class="i">+        val actionMenu = context.resources.getIdentifier(&quot;action_menu&quot;, &quot;id&quot;)
</a><a href="#h12-0-55" id="h12-0-55" class="i">+        val componentsHolder = context.resources.getIdentifier(&quot;components_holder&quot;, &quot;id&quot;)
</a><a href="#h12-0-56" id="h12-0-56" class="i">+        val feedNewChat = context.resources.getIdentifier(&quot;feed_new_chat&quot;, &quot;id&quot;)
</a> 
         context.event.subscribe(AddViewEvent::class) { event -&gt;
             val originalAddView: (View) -&gt; Unit = {
<a href="#h12-1" id="h12-1" class="h">@@ -56,17 +55,17 @@ class MenuViewInjector : Feature(&quot;MenuViewInjector&quot;, loadParams = FeatureLoadPar
</a> 
             val viewGroup: ViewGroup = event.parent
             val childView: View = event.view
<a href="#h12-1-3" id="h12-1-3" class="d">-            operaContextActionMenu.inject(event.parent, childView)
</a><a href="#h12-1-4" id="h12-1-4" class="i">+            menuMap[OperaContextActionMenu::class]!!.inject(viewGroup, childView, originalAddView)
</a> 
             if (event.parent.id == componentsHolder &amp;&amp; childView.id == feedNewChat) {
<a href="#h12-1-7" id="h12-1-7" class="d">-                settingsGearInjector.inject(event.parent, childView)
</a><a href="#h12-1-8" id="h12-1-8" class="i">+                menuMap[SettingsGearInjector::class]!!.inject(viewGroup, childView, originalAddView)
</a>                 return@subscribe
             }
 
             //download in chat snaps and notes from the chat action menu
             if (viewGroup.javaClass.name.endsWith(&quot;ActionMenuChatItemContainer&quot;)) {
                 if (viewGroup.parent == null || viewGroup.parent.parent == null) return@subscribe
<a href="#h12-1-15" id="h12-1-15" class="d">-                chatActionMenu.inject(viewGroup)
</a><a href="#h12-1-16" id="h12-1-16" class="i">+                menuMap[ChatActionMenu::class]!!.inject(viewGroup, childView, originalAddView)
</a>                 return@subscribe
             }
 
<a href="#h12-2" id="h12-2" class="h">@@ -87,7 +86,7 @@ class MenuViewInjector : Feature(&quot;MenuViewInjector&quot;, loadParams = FeatureLoadPar
</a> 
                 val viewList = mutableListOf&lt;View&gt;()
                 context.runOnUiThread {
<a href="#h12-2-3" id="h12-2-3" class="d">-                    friendFeedInfoMenu.inject(injectedLayout) { view -&gt;
</a><a href="#h12-2-4" id="h12-2-4" class="i">+                    menuMap[FriendFeedInfoMenu::class]?.inject(event.parent, injectedLayout) { view -&gt;
</a>                         view.layoutParams = LinearLayout.LayoutParams(
                             ViewGroup.LayoutParams.MATCH_PARENT,
                             ViewGroup.LayoutParams.WRAP_CONTENT
<a href="#h12-3" id="h12-3" class="h">@@ -124,7 +123,7 @@ class MenuViewInjector : Feature(&quot;MenuViewInjector&quot;, loadParams = FeatureLoadPar
</a> 
                 //the 3 dot button shows a menu which contains the first item as a Plain object
                 if (viewGroup.getChildCount() == 0 &amp;&amp; itemStringInterface != null &amp;&amp; itemStringInterface.toString().startsWith(&quot;Plain(primaryText=$newChatString&quot;)) {
<a href="#h12-3-3" id="h12-3-3" class="d">-                    settingMenu.inject(viewGroup, originalAddView)
</a><a href="#h12-3-4" id="h12-3-4" class="i">+                    menuMap[SettingsMenu::class]!!.inject(viewGroup, childView, originalAddView)
</a>                     viewGroup.addOnAttachStateChangeListener(object: View.OnAttachStateChangeListener {
                         override fun onViewAttachedToWindow(v: View) {}
                         override fun onViewDetachedFromWindow(v: View) {
<a href="#h12-4" id="h12-4" class="h">@@ -139,7 +138,7 @@ class MenuViewInjector : Feature(&quot;MenuViewInjector&quot;, loadParams = FeatureLoadPar
</a>                 //filter by the slot index
                 if (viewGroup.getChildCount() != context.config.userInterface.friendFeedMenuPosition.get()) return@subscribe
                 if (viewTagState[viewGroup]) return@subscribe
<a href="#h12-4-3" id="h12-4-3" class="d">-                friendFeedInfoMenu.inject(viewGroup, originalAddView)
</a><a href="#h12-4-4" id="h12-4-4" class="i">+                menuMap[FriendFeedInfoMenu::class]!!.inject(viewGroup, childView, originalAddView)
</a>             }
         }
     }
<b>diff --git a/<a id="h13" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/OperaContextActionMenu.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/OperaContextActionMenu.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/OperaContextActionMenu.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/OperaContextActionMenu.kt</a></b>
<a href="#h13-0" id="h13-0" class="h">@@ -7,16 +7,14 @@ import android.view.ViewGroup
</a> import android.widget.Button
 import android.widget.LinearLayout
 import android.widget.ScrollView
<a href="#h13-0-3" id="h13-0-3" class="d">-import me.rhunk.snapenhance.common.Constants
</a> import me.rhunk.snapenhance.core.features.impl.downloader.MediaDownloader
 import me.rhunk.snapenhance.core.ui.applyTheme
 import me.rhunk.snapenhance.core.ui.menu.AbstractMenu
<a href="#h13-0-7" id="h13-0-7" class="i">+import me.rhunk.snapenhance.core.util.ktx.getId
</a> 
 @SuppressLint(&quot;DiscouragedApi&quot;)
 class OperaContextActionMenu : AbstractMenu() {
<a href="#h13-0-11" id="h13-0-11" class="d">-    private val contextCardsScrollView by lazy {
</a><a href="#h13-0-12" id="h13-0-12" class="d">-        context.resources.getIdentifier(&quot;context_cards_scroll_view&quot;, &quot;id&quot;, Constants.SNAPCHAT_PACKAGE_NAME)
</a><a href="#h13-0-13" id="h13-0-13" class="d">-    }
</a><a href="#h13-0-14" id="h13-0-14" class="i">+    private val contextCardsScrollView by lazy { context.resources.getId(&quot;context_cards_scroll_view&quot;) }
</a> 
     /*
     LinearLayout :
<a href="#h13-1" id="h13-1" class="h">@@ -52,15 +50,15 @@ class OperaContextActionMenu : AbstractMenu() {
</a>     }
 
     @SuppressLint(&quot;SetTextI18n&quot;)
<a href="#h13-1-3" id="h13-1-3" class="d">-    fun inject(viewGroup: ViewGroup, childView: View) {
</a><a href="#h13-1-4" id="h13-1-4" class="i">+    override fun inject(parent: ViewGroup, view: View, viewConsumer: (View) -&gt; Unit) {
</a>         try {
<a href="#h13-1-6" id="h13-1-6" class="d">-            if (viewGroup.parent !is ScrollView) return
</a><a href="#h13-1-7" id="h13-1-7" class="d">-            val parent = viewGroup.parent as ScrollView
</a><a href="#h13-1-8" id="h13-1-8" class="d">-            if (parent.id != contextCardsScrollView) return
</a><a href="#h13-1-9" id="h13-1-9" class="d">-            if (childView !is LinearLayout) return
</a><a href="#h13-1-10" id="h13-1-10" class="d">-            if (!isViewGroupButtonMenuContainer(childView as ViewGroup)) return
</a><a href="#h13-1-11" id="h13-1-11" class="i">+            if (parent.parent !is ScrollView) return
</a><a href="#h13-1-12" id="h13-1-12" class="i">+            val parentView = parent.parent as ScrollView
</a><a href="#h13-1-13" id="h13-1-13" class="i">+            if (parentView.id != contextCardsScrollView) return
</a><a href="#h13-1-14" id="h13-1-14" class="i">+            if (view !is LinearLayout) return
</a><a href="#h13-1-15" id="h13-1-15" class="i">+            if (!isViewGroupButtonMenuContainer(view as ViewGroup)) return
</a> 
<a href="#h13-1-17" id="h13-1-17" class="d">-            val linearLayout = LinearLayout(childView.getContext())
</a><a href="#h13-1-18" id="h13-1-18" class="i">+            val linearLayout = LinearLayout(view.context)
</a>             linearLayout.orientation = LinearLayout.VERTICAL
             linearLayout.gravity = Gravity.CENTER
             linearLayout.layoutParams =
<a href="#h13-2" id="h13-2" class="h">@@ -71,21 +69,21 @@ class OperaContextActionMenu : AbstractMenu() {
</a>             val translation = context.translation
             val mediaDownloader = context.feature(MediaDownloader::class)
 
<a href="#h13-2-3" id="h13-2-3" class="d">-            linearLayout.addView(Button(childView.getContext()).apply {
</a><a href="#h13-2-4" id="h13-2-4" class="i">+            linearLayout.addView(Button(view.context).apply {
</a>                 text = translation[&quot;opera_context_menu.download&quot;]
                 setOnClickListener { mediaDownloader.downloadLastOperaMediaAsync() }
                 applyTheme(isAmoled = false)
             })
 
             if (context.isDeveloper) {
<a href="#h13-2-11" id="h13-2-11" class="d">-                linearLayout.addView(Button(childView.getContext()).apply {
</a><a href="#h13-2-12" id="h13-2-12" class="i">+                linearLayout.addView(Button(view.context).apply {
</a>                     text = &quot;Show debug info&quot;
                     setOnClickListener { mediaDownloader.showLastOperaDebugMediaInfo() }
                     applyTheme(isAmoled = false)
                 })
             }
 
<a href="#h13-2-19" id="h13-2-19" class="d">-            (childView as ViewGroup).addView(linearLayout, 0)
</a><a href="#h13-2-20" id="h13-2-20" class="i">+            (view as ViewGroup).addView(linearLayout, 0)
</a>         } catch (e: Throwable) {
             context.log.error(&quot;Error while injecting OperaContextActionMenu&quot;, e)
         }
<b>diff --git a/<a id="h14" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/SettingsGearInjector.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/SettingsGearInjector.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/SettingsGearInjector.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/SettingsGearInjector.kt</a></b>
<a href="#h14-0" id="h14-0" class="h">@@ -5,36 +5,21 @@ import android.view.View
</a> import android.view.ViewGroup
 import android.widget.FrameLayout
 import android.widget.ImageView
<a href="#h14-0-3" id="h14-0-3" class="d">-import me.rhunk.snapenhance.common.Constants
</a> import me.rhunk.snapenhance.core.ui.menu.AbstractMenu
<a href="#h14-0-5" id="h14-0-5" class="i">+import me.rhunk.snapenhance.core.util.ktx.getDimens
</a><a href="#h14-0-6" id="h14-0-6" class="i">+import me.rhunk.snapenhance.core.util.ktx.getDrawable
</a><a href="#h14-0-7" id="h14-0-7" class="i">+import me.rhunk.snapenhance.core.util.ktx.getStyledAttributes
</a> 
 
 @SuppressLint(&quot;DiscouragedApi&quot;)
 class SettingsGearInjector : AbstractMenu() {
<a href="#h14-0-12" id="h14-0-12" class="d">-    private val headerButtonOpaqueIconTint by lazy {
</a><a href="#h14-0-13" id="h14-0-13" class="d">-        context.resources.getIdentifier(&quot;headerButtonOpaqueIconTint&quot;, &quot;attr&quot;, Constants.SNAPCHAT_PACKAGE_NAME).let {
</a><a href="#h14-0-14" id="h14-0-14" class="d">-            context.androidContext.theme.obtainStyledAttributes(intArrayOf(it)).getColorStateList(0)
</a><a href="#h14-0-15" id="h14-0-15" class="d">-        }
</a><a href="#h14-0-16" id="h14-0-16" class="d">-    }
</a><a href="#h14-0-17" id="h14-0-17" class="d">-
</a><a href="#h14-0-18" id="h14-0-18" class="d">-    private val settingsSvg by lazy {
</a><a href="#h14-0-19" id="h14-0-19" class="d">-        context.resources.getIdentifier(&quot;svg_settings_32x32&quot;, &quot;drawable&quot;, Constants.SNAPCHAT_PACKAGE_NAME).let {
</a><a href="#h14-0-20" id="h14-0-20" class="d">-            context.resources.getDrawable(it, context.androidContext.theme)
</a><a href="#h14-0-21" id="h14-0-21" class="d">-        }
</a><a href="#h14-0-22" id="h14-0-22" class="d">-    }
</a><a href="#h14-0-23" id="h14-0-23" class="d">-
</a><a href="#h14-0-24" id="h14-0-24" class="d">-    private val ngsHovaHeaderSearchIconBackgroundMarginLeft by lazy {
</a><a href="#h14-0-25" id="h14-0-25" class="d">-        context.resources.getIdentifier(&quot;ngs_hova_header_search_icon_background_margin_left&quot;, &quot;dimen&quot;, Constants.SNAPCHAT_PACKAGE_NAME).let {
</a><a href="#h14-0-26" id="h14-0-26" class="d">-            context.resources.getDimensionPixelSize(it)
</a><a href="#h14-0-27" id="h14-0-27" class="d">-        }
</a><a href="#h14-0-28" id="h14-0-28" class="d">-    }
</a><a href="#h14-0-29" id="h14-0-29" class="i">+    override fun inject(parent: ViewGroup, view: View, viewConsumer: (View) -&gt; Unit) {
</a><a href="#h14-0-30" id="h14-0-30" class="i">+        val firstView = (view as ViewGroup).getChildAt(0)
</a> 
<a href="#h14-0-32" id="h14-0-32" class="d">-    @SuppressLint(&quot;SetTextI18n&quot;, &quot;ClickableViewAccessibility&quot;)
</a><a href="#h14-0-33" id="h14-0-33" class="d">-    fun inject(parent: ViewGroup, child: View) {
</a><a href="#h14-0-34" id="h14-0-34" class="d">-        val firstView = (child as ViewGroup).getChildAt(0)
</a><a href="#h14-0-35" id="h14-0-35" class="i">+        val ngsHovaHeaderSearchIconBackgroundMarginLeft = context.resources.getDimens(&quot;ngs_hova_header_search_icon_background_margin_left&quot;)
</a> 
<a href="#h14-0-37" id="h14-0-37" class="d">-        child.clipChildren = false
</a><a href="#h14-0-38" id="h14-0-38" class="d">-        child.addView(FrameLayout(parent.context).apply {
</a><a href="#h14-0-39" id="h14-0-39" class="i">+        view.clipChildren = false
</a><a href="#h14-0-40" id="h14-0-40" class="i">+        view.addView(FrameLayout(parent.context).apply {
</a>             layoutParams = FrameLayout.LayoutParams(firstView.layoutParams.width, firstView.layoutParams.height).apply {
                 y = 0f
                 x = -(ngsHovaHeaderSearchIconBackgroundMarginLeft + firstView.layoutParams.width).toFloat()
<a href="#h14-1" id="h14-1" class="h">@@ -52,7 +37,7 @@ class SettingsGearInjector : AbstractMenu() {
</a>             }
 
             parent.setOnTouchListener { _, event -&gt;
<a href="#h14-1-3" id="h14-1-3" class="d">-                if (child.visibility == View.INVISIBLE || child.alpha == 0F) return@setOnTouchListener false
</a><a href="#h14-1-4" id="h14-1-4" class="i">+                if (view.visibility == View.INVISIBLE || view.alpha == 0F) return@setOnTouchListener false
</a> 
                 val viewLocation = IntArray(2)
                 getLocationOnScreen(viewLocation)
<a href="#h14-2" id="h14-2" class="h">@@ -73,8 +58,8 @@ class SettingsGearInjector : AbstractMenu() {
</a>                 layoutParams = FrameLayout.LayoutParams(ViewGroup.LayoutParams.WRAP_CONTENT, ViewGroup.LayoutParams.WRAP_CONTENT, 17).apply {
                     gravity = android.view.Gravity.CENTER
                 }
<a href="#h14-2-3" id="h14-2-3" class="d">-                setImageDrawable(settingsSvg)
</a><a href="#h14-2-4" id="h14-2-4" class="d">-                headerButtonOpaqueIconTint?.let {
</a><a href="#h14-2-5" id="h14-2-5" class="i">+                setImageDrawable(context.resources.getDrawable(&quot;svg_settings_32x32&quot;, context.theme))
</a><a href="#h14-2-6" id="h14-2-6" class="i">+                context.resources.getStyledAttributes(&quot;headerButtonOpaqueIconTint&quot;, context.theme).getColorStateList(0)?.let {
</a>                     imageTintList = it
                 }
             })
<b>diff --git a/<a id="h15" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/SettingsMenu.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/SettingsMenu.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/SettingsMenu.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/SettingsMenu.kt</a></b>
<a href="#h15-0" id="h15-0" class="h">@@ -1,29 +1,6 @@
</a> package me.rhunk.snapenhance.core.ui.menu.impl
 
<a href="#h15-0-2" id="h15-0-2" class="d">-import android.annotation.SuppressLint
</a><a href="#h15-0-3" id="h15-0-3" class="d">-import android.view.View
</a> import me.rhunk.snapenhance.core.ui.menu.AbstractMenu
 
 class SettingsMenu : AbstractMenu() {
<a href="#h15-0-7" id="h15-0-7" class="d">-    //TODO: quick settings
</a><a href="#h15-0-8" id="h15-0-8" class="d">-    @SuppressLint(&quot;SetTextI18n&quot;)
</a><a href="#h15-0-9" id="h15-0-9" class="d">-    @Suppress(&quot;UNUSED_PARAMETER&quot;)
</a><a href="#h15-0-10" id="h15-0-10" class="d">-    fun inject(viewModel: View, addView: (View) -&gt; Unit) {
</a><a href="#h15-0-11" id="h15-0-11" class="d">-        /*val actions = context.actionManager.getActions().map {
</a><a href="#h15-0-12" id="h15-0-12" class="d">-            Pair(it) {
</a><a href="#h15-0-13" id="h15-0-13" class="d">-                val button = Button(viewModel.context)
</a><a href="#h15-0-14" id="h15-0-14" class="d">-                button.text = context.translation[it.nameKey]
</a><a href="#h15-0-15" id="h15-0-15" class="d">-
</a><a href="#h15-0-16" id="h15-0-16" class="d">-                button.setOnClickListener { _ -&gt;
</a><a href="#h15-0-17" id="h15-0-17" class="d">-                    it.run()
</a><a href="#h15-0-18" id="h15-0-18" class="d">-                }
</a><a href="#h15-0-19" id="h15-0-19" class="d">-                ViewAppearanceHelper.applyTheme(button)
</a><a href="#h15-0-20" id="h15-0-20" class="d">-                button
</a><a href="#h15-0-21" id="h15-0-21" class="d">-            }
</a><a href="#h15-0-22" id="h15-0-22" class="d">-        }
</a><a href="#h15-0-23" id="h15-0-23" class="d">-
</a><a href="#h15-0-24" id="h15-0-24" class="d">-        actions.forEach {
</a><a href="#h15-0-25" id="h15-0-25" class="d">-            addView(it.second())
</a><a href="#h15-0-26" id="h15-0-26" class="d">-        }*/
</a><a href="#h15-0-27" id="h15-0-27" class="d">-    }
</a> } 
\ No newline at end of file
<b>diff --git a/<a id="h16" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/util/ktx/AndroidExt.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/util/ktx/AndroidExt.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/util/ktx/AndroidExt.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/util/ktx/AndroidExt.kt</a></b>
<a href="#h16-0" id="h16-0" class="h">@@ -0,0 +1,33 @@
</a><a href="#h16-0-0" id="h16-0-0" class="i">+package me.rhunk.snapenhance.core.util.ktx
</a><a href="#h16-0-1" id="h16-0-1" class="i">+
</a><a href="#h16-0-2" id="h16-0-2" class="i">+import android.annotation.SuppressLint
</a><a href="#h16-0-3" id="h16-0-3" class="i">+import android.content.res.Resources
</a><a href="#h16-0-4" id="h16-0-4" class="i">+import android.content.res.Resources.Theme
</a><a href="#h16-0-5" id="h16-0-5" class="i">+import android.content.res.TypedArray
</a><a href="#h16-0-6" id="h16-0-6" class="i">+import android.graphics.drawable.Drawable
</a><a href="#h16-0-7" id="h16-0-7" class="i">+import me.rhunk.snapenhance.common.Constants
</a><a href="#h16-0-8" id="h16-0-8" class="i">+
</a><a href="#h16-0-9" id="h16-0-9" class="i">+
</a><a href="#h16-0-10" id="h16-0-10" class="i">+@SuppressLint(&quot;DiscouragedApi&quot;)
</a><a href="#h16-0-11" id="h16-0-11" class="i">+fun Resources.getIdentifier(name: String, type: String): Int {
</a><a href="#h16-0-12" id="h16-0-12" class="i">+    return getIdentifier(name, type, Constants.SNAPCHAT_PACKAGE_NAME)
</a><a href="#h16-0-13" id="h16-0-13" class="i">+}
</a><a href="#h16-0-14" id="h16-0-14" class="i">+
</a><a href="#h16-0-15" id="h16-0-15" class="i">+@SuppressLint(&quot;DiscouragedApi&quot;)
</a><a href="#h16-0-16" id="h16-0-16" class="i">+fun Resources.getId(name: String): Int {
</a><a href="#h16-0-17" id="h16-0-17" class="i">+    return getIdentifier(name, &quot;id&quot;, Constants.SNAPCHAT_PACKAGE_NAME)
</a><a href="#h16-0-18" id="h16-0-18" class="i">+}
</a><a href="#h16-0-19" id="h16-0-19" class="i">+
</a><a href="#h16-0-20" id="h16-0-20" class="i">+fun Resources.getDimens(name: String): Int {
</a><a href="#h16-0-21" id="h16-0-21" class="i">+    return getDimensionPixelSize(getIdentifier(name, &quot;dimen&quot;))
</a><a href="#h16-0-22" id="h16-0-22" class="i">+}
</a><a href="#h16-0-23" id="h16-0-23" class="i">+
</a><a href="#h16-0-24" id="h16-0-24" class="i">+fun Resources.getStyledAttributes(name: String, theme: Theme): TypedArray {
</a><a href="#h16-0-25" id="h16-0-25" class="i">+    return getIdentifier(name, &quot;attr&quot;).let {
</a><a href="#h16-0-26" id="h16-0-26" class="i">+        theme.obtainStyledAttributes(intArrayOf(it))
</a><a href="#h16-0-27" id="h16-0-27" class="i">+    }
</a><a href="#h16-0-28" id="h16-0-28" class="i">+}
</a><a href="#h16-0-29" id="h16-0-29" class="i">+
</a><a href="#h16-0-30" id="h16-0-30" class="i">+fun Resources.getDrawable(name: String, theme: Theme): Drawable {
</a><a href="#h16-0-31" id="h16-0-31" class="i">+    return getDrawable(getIdentifier(name, &quot;drawable&quot;), theme)
</a><a href="#h16-0-32" id="h16-0-32" class="i">+}
</a><b>diff --git a/<a id="h17" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/util/ktx/XposedHelperExt.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/util/ktx/XposedHelperExt.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/util/ktx/XposedHelperExt.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/util/ktx/XposedHelperExt.kt</a></b>
<a href="#h17-0" id="h17-0" class="h">@@ -20,7 +20,7 @@ fun Any.setObjectField(fieldName: String, value: Any?) {
</a> fun Any.getObjectFieldOrNull(fieldName: String): Any? {
     return try {
         getObjectField(fieldName)
<a href="#h17-0-3" id="h17-0-3" class="d">-    } catch (e: Exception) {
</a><a href="#h17-0-4" id="h17-0-4" class="i">+    } catch (t: Throwable) {
</a>         null
     }
 }
</pre>
</div>
</body>
</html>
