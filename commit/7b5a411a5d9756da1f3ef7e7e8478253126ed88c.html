<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>refactor: core package - SnapEnhance - An Xposed module offering an enhanced Snapchat experience
</title>
<link rel="icon" type="image/svg+xml" href="../../logo.png"/>
<link rel="alternate icon" href="../../favicon.png"/>
<link rel="alternate" type="application/atom+xml" title="SnapEnhance Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="SnapEnhance Atom Feed (tags)" href="../tags.xml" />
<link rel="stylesheet" type="text/css" href="../../style.css" />
<link rel="stylesheet" type="text/css" href="../../fonts.css" />
</head>
<body>
<div id="head"><table><tr><td><a class="logo" href="../../"><img src="../../logo.png" alt="" width="32" height="32" /></a></td><td><strong>SnapEnhance</strong><span class="desc"> - An Xposed module offering an enhanced Snapchat experience
</span>
</td></tr></table>
<p><a href="../about.html">About</a> | <a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/.gitmodules.html">Submodules</a> | <a href="../file/LICENSE.html">License</a></p>
</div>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/7b5a411a5d9756da1f3ef7e7e8478253126ed88c.html">7b5a411a5d9756da1f3ef7e7e8478253126ed88c</a>
<b>parent</b> <a href="../commit/249569468ce871173a3f60c53a7aadc7f89e3cf8.html">249569468ce871173a3f60c53a7aadc7f89e3cf8</a>
<b>Author:</b> rhunk &lt;<a href="mailto:101876869+rhunk@users.noreply.github.com">101876869+rhunk@users.noreply.github.com</a>&gt;
<b>Date:</b>   Sat,  9 Sep 2023 15:35:26 +0200

refactor: core package

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">app/src/main/kotlin/me/rhunk/snapenhance/LogManager.kt</a></td><td> | </td><td class="num">1</td><td><span class="i">+</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">app/src/main/kotlin/me/rhunk/snapenhance/bridge/BridgeService.kt</a></td><td> | </td><td class="num">4</td><td><span class="i">++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h2">app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadProcessor.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h3">app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadTaskManager.kt</a></td><td> | </td><td class="num">6</td><td><span class="i">+++</span><span class="d">---</span></td></tr>
<tr><td class="M">M</td><td><a href="#h4">app/src/main/kotlin/me/rhunk/snapenhance/download/FFMpegProcessor.kt</a></td><td> | </td><td class="num">4</td><td><span class="i">++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h5">app/src/main/kotlin/me/rhunk/snapenhance/messaging/ModDatabase.kt</a></td><td> | </td><td class="num">8</td><td><span class="i">++++</span><span class="d">----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h6">app/src/main/kotlin/me/rhunk/snapenhance/messaging/StreaksReminder.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h7">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/home/HomeSubSection.kt</a></td><td> | </td><td class="num">4</td><td><span class="i">++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h8">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/social/AddFriendDialog.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h9">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/social/ScopeContent.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h10">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/social/SocialSection.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h11">app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/screens/impl/MappingsScreen.kt</a></td><td> | </td><td class="num">5</td><td><span class="i"></span><span class="d">-----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h12">app/src/main/kotlin/me/rhunk/snapenhance/ui/util/ActivityLauncherHelper.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h13">core/src/main/kotlin/me/rhunk/snapenhance/EventDispatcher.kt</a></td><td> | </td><td class="num">6</td><td><span class="i">+++</span><span class="d">---</span></td></tr>
<tr><td class="D">D</td><td><a href="#h14">core/src/main/kotlin/me/rhunk/snapenhance/Logger.kt</a></td><td> | </td><td class="num">124</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h15">core/src/main/kotlin/me/rhunk/snapenhance/ModContext.kt</a></td><td> | </td><td class="num">3</td><td><span class="i">++</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h16">core/src/main/kotlin/me/rhunk/snapenhance/SnapEnhance.kt</a></td><td> | </td><td class="num">3</td><td><span class="i">++</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h17">core/src/main/kotlin/me/rhunk/snapenhance/action/impl/ExportChatMessages.kt</a></td><td> | </td><td class="num">8</td><td><span class="i">++++</span><span class="d">----</span></td></tr>
<tr><td class="A">A</td><td><a href="#h18">core/src/main/kotlin/me/rhunk/snapenhance/core/Logger.kt</a></td><td> | </td><td class="num">124</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h19">core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/wrapper/LocaleWrapper.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h20">core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/wrapper/MappingsWrapper.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h21">core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/wrapper/MessageLoggerWrapper.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h22">core/src/main/kotlin/me/rhunk/snapenhance/core/database/DatabaseAccess.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h23">core/src/main/kotlin/me/rhunk/snapenhance/core/database/objects/ConversationMessage.kt</a></td><td> | </td><td class="num">10</td><td><span class="i">+++++</span><span class="d">-----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h24">core/src/main/kotlin/me/rhunk/snapenhance/core/database/objects/FriendFeedEntry.kt</a></td><td> | </td><td class="num">8</td><td><span class="i">++++</span><span class="d">----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h25">core/src/main/kotlin/me/rhunk/snapenhance/core/database/objects/FriendInfo.kt</a></td><td> | </td><td class="num">8</td><td><span class="i">++++</span><span class="d">----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h26">core/src/main/kotlin/me/rhunk/snapenhance/core/database/objects/StoryEntry.kt</a></td><td> | </td><td class="num">4</td><td><span class="i">++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h27">core/src/main/kotlin/me/rhunk/snapenhance/core/database/objects/UserConversationLink.kt</a></td><td> | </td><td class="num">4</td><td><span class="i">++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h28">core/src/main/kotlin/me/rhunk/snapenhance/core/messaging/MessagingCoreObjects.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="A">A</td><td><a href="#h29">core/src/main/kotlin/me/rhunk/snapenhance/core/util/CallbackBuilder.kt</a></td><td> | </td><td class="num">94</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h30">core/src/main/kotlin/me/rhunk/snapenhance/core/util/ReflectionHelper.kt</a></td><td> | </td><td class="num">120</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h31">core/src/main/kotlin/me/rhunk/snapenhance/core/util/SQLiteDatabaseHelper.kt</a></td><td> | </td><td class="num">32</td><td><span class="i">++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h32">core/src/main/kotlin/me/rhunk/snapenhance/core/util/SerializableDataObject.kt</a></td><td> | </td><td class="num">23</td><td><span class="i">+++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h33">core/src/main/kotlin/me/rhunk/snapenhance/core/util/download/HttpServer.kt</a></td><td> | </td><td class="num">140</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h34">core/src/main/kotlin/me/rhunk/snapenhance/core/util/download/RemoteMediaResolver.kt</a></td><td> | </td><td class="num">53</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h35">core/src/main/kotlin/me/rhunk/snapenhance/core/util/export/MessageExporter.kt</a></td><td> | </td><td class="num">343</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h36">core/src/main/kotlin/me/rhunk/snapenhance/core/util/ktx/AndroidCompatExtensions.kt</a></td><td> | </td><td class="num">13</td><td><span class="i">+++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h37">core/src/main/kotlin/me/rhunk/snapenhance/core/util/ktx/DbCursorExt.kt</a></td><td> | </td><td class="num">38</td><td><span class="i">++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h38">core/src/main/kotlin/me/rhunk/snapenhance/core/util/ktx/XposedHelperExt.kt</a></td><td> | </td><td class="num">27</td><td><span class="i">+++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h39">core/src/main/kotlin/me/rhunk/snapenhance/core/util/protobuf/ProtoEditor.kt</a></td><td> | </td><td class="num">68</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h40">core/src/main/kotlin/me/rhunk/snapenhance/core/util/protobuf/ProtoReader.kt</a></td><td> | </td><td class="num">176</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h41">core/src/main/kotlin/me/rhunk/snapenhance/core/util/protobuf/ProtoWriter.kt</a></td><td> | </td><td class="num">118</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h42">core/src/main/kotlin/me/rhunk/snapenhance/core/util/protobuf/WireType.kt</a></td><td> | </td><td class="num">14</td><td><span class="i">++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h43">core/src/main/kotlin/me/rhunk/snapenhance/core/util/snap/BitmojiSelfie.kt</a></td><td> | </td><td class="num">21</td><td><span class="i">+++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h44">core/src/main/kotlin/me/rhunk/snapenhance/core/util/snap/EncryptionHelper.kt</a></td><td> | </td><td class="num">53</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h45">core/src/main/kotlin/me/rhunk/snapenhance/core/util/snap/MediaDownloaderHelper.kt</a></td><td> | </td><td class="num">71</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h46">core/src/main/kotlin/me/rhunk/snapenhance/core/util/snap/PreviewUtils.kt</a></td><td> | </td><td class="num">87</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h47">core/src/main/kotlin/me/rhunk/snapenhance/core/util/snap/SnapWidgetBroadcastReceiverHelper.kt</a></td><td> | </td><td class="num">25</td><td><span class="i">+++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h48">core/src/main/kotlin/me/rhunk/snapenhance/data/FileType.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h49">core/src/main/kotlin/me/rhunk/snapenhance/data/MessageSender.kt</a></td><td> | </td><td class="num">4</td><td><span class="i">++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h50">core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/AbstractWrapper.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h51">core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/Message.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h52">core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/MessageContent.kt</a></td><td> | </td><td class="num">4</td><td><span class="i">++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h53">core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/MessageDescriptor.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h54">core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/MessageDestinations.kt</a></td><td> | </td><td class="num">4</td><td><span class="i">++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h55">core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/MessageMetadata.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h56">core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/SnapUUID.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h57">core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/UserIdToReaction.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h58">core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/media/MediaInfo.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h59">core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/media/opera/Layer.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h60">core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/media/opera/LayerController.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h61">core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/media/opera/ParamMap.kt</a></td><td> | </td><td class="num">4</td><td><span class="i">++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h62">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/ConfigurationOverride.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h63">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/Messaging.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h64">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/MediaDownloader.kt</a></td><td> | </td><td class="num">14</td><td><span class="i">+++++++</span><span class="d">-------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h65">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/ProfilePictureDownloader.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h66">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/experiments/UnlimitedMultiSnap.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h67">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/spying/AnonymousStoryViewing.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h68">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/AutoSave.kt</a></td><td> | </td><td class="num">6</td><td><span class="i">+++</span><span class="d">---</span></td></tr>
<tr><td class="M">M</td><td><a href="#h69">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/CameraTweaks.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h70">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/DisableReplayInFF.kt</a></td><td> | </td><td class="num">4</td><td><span class="i">++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h71">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/Notifications.kt</a></td><td> | </td><td class="num">16</td><td><span class="i">++++++++</span><span class="d">--------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h72">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/OldBitmojiSelfie.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h73">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/SendOverride.kt</a></td><td> | </td><td class="num">4</td><td><span class="i">++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h74">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/UnlimitedSnapViewTime.kt</a></td><td> | </td><td class="num">8</td><td><span class="i">++++</span><span class="d">----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h75">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/PinConversations.kt</a></td><td> | </td><td class="num">4</td><td><span class="i">++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h76">core/src/main/kotlin/me/rhunk/snapenhance/manager/impl/FeatureManager.kt</a></td><td> | </td><td class="num">4</td><td><span class="i">++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h77">core/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/FriendFeedInfoMenu.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="D">D</td><td><a href="#h78">core/src/main/kotlin/me/rhunk/snapenhance/util/CallbackBuilder.kt</a></td><td> | </td><td class="num">94</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h79">core/src/main/kotlin/me/rhunk/snapenhance/util/ReflectionHelper.kt</a></td><td> | </td><td class="num">120</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h80">core/src/main/kotlin/me/rhunk/snapenhance/util/SQLiteDatabaseHelper.kt</a></td><td> | </td><td class="num">32</td><td><span class="i"></span><span class="d">--------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h81">core/src/main/kotlin/me/rhunk/snapenhance/util/SerializableDataObject.kt</a></td><td> | </td><td class="num">23</td><td><span class="i"></span><span class="d">-----------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h82">core/src/main/kotlin/me/rhunk/snapenhance/util/download/HttpServer.kt</a></td><td> | </td><td class="num">140</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h83">core/src/main/kotlin/me/rhunk/snapenhance/util/download/RemoteMediaResolver.kt</a></td><td> | </td><td class="num">53</td><td><span class="i"></span><span class="d">-----------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h84">core/src/main/kotlin/me/rhunk/snapenhance/util/export/MessageExporter.kt</a></td><td> | </td><td class="num">343</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h85">core/src/main/kotlin/me/rhunk/snapenhance/util/ktx/AndroidCompatExtensions.kt</a></td><td> | </td><td class="num">13</td><td><span class="i"></span><span class="d">-------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h86">core/src/main/kotlin/me/rhunk/snapenhance/util/ktx/DbCursorExt.kt</a></td><td> | </td><td class="num">38</td><td><span class="i"></span><span class="d">--------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h87">core/src/main/kotlin/me/rhunk/snapenhance/util/ktx/XposedHelperExt.kt</a></td><td> | </td><td class="num">27</td><td><span class="i"></span><span class="d">---------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h88">core/src/main/kotlin/me/rhunk/snapenhance/util/protobuf/ProtoEditor.kt</a></td><td> | </td><td class="num">68</td><td><span class="i"></span><span class="d">--------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h89">core/src/main/kotlin/me/rhunk/snapenhance/util/protobuf/ProtoReader.kt</a></td><td> | </td><td class="num">176</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h90">core/src/main/kotlin/me/rhunk/snapenhance/util/protobuf/ProtoWriter.kt</a></td><td> | </td><td class="num">118</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h91">core/src/main/kotlin/me/rhunk/snapenhance/util/protobuf/WireType.kt</a></td><td> | </td><td class="num">14</td><td><span class="i"></span><span class="d">--------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h92">core/src/main/kotlin/me/rhunk/snapenhance/util/snap/BitmojiSelfie.kt</a></td><td> | </td><td class="num">21</td><td><span class="i"></span><span class="d">---------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h93">core/src/main/kotlin/me/rhunk/snapenhance/util/snap/EncryptionHelper.kt</a></td><td> | </td><td class="num">49</td><td><span class="i"></span><span class="d">-------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h94">core/src/main/kotlin/me/rhunk/snapenhance/util/snap/MediaDownloaderHelper.kt</a></td><td> | </td><td class="num">71</td><td><span class="i"></span><span class="d">-----------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h95">core/src/main/kotlin/me/rhunk/snapenhance/util/snap/PreviewUtils.kt</a></td><td> | </td><td class="num">87</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h96">core/src/main/kotlin/me/rhunk/snapenhance/util/snap/SnapWidgetBroadcastReceiverHelper.kt</a></td><td> | </td><td class="num">25</td><td><span class="i"></span><span class="d">-------------------------</span></td></tr>
</table></pre><pre>97 files changed, 1749 insertions(+), 1747 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/LogManager.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/LogManager.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/LogManager.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/LogManager.kt</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -3,6 +3,7 @@ package me.rhunk.snapenhance
</a> import android.content.SharedPreferences
 import android.util.Log
 import com.google.gson.GsonBuilder
<a href="#h0-0-3" id="h0-0-3" class="i">+import me.rhunk.snapenhance.core.LogLevel
</a> import java.io.File
 import java.io.OutputStream
 import java.io.RandomAccessFile
<b>diff --git a/<a id="h1" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/BridgeService.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/BridgeService.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/BridgeService.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/BridgeService.kt</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -3,7 +3,7 @@ package me.rhunk.snapenhance.bridge
</a> import android.app.Service
 import android.content.Intent
 import android.os.IBinder
<a href="#h1-0-3" id="h1-0-3" class="d">-import me.rhunk.snapenhance.LogLevel
</a><a href="#h1-0-4" id="h1-0-4" class="i">+import me.rhunk.snapenhance.core.LogLevel
</a> import me.rhunk.snapenhance.RemoteSideContext
 import me.rhunk.snapenhance.SharedContextHolder
 import me.rhunk.snapenhance.core.bridge.types.BridgeFileType
<a href="#h1-1" id="h1-1" class="h">@@ -14,7 +14,7 @@ import me.rhunk.snapenhance.core.database.objects.FriendInfo
</a> import me.rhunk.snapenhance.core.messaging.MessagingFriendInfo
 import me.rhunk.snapenhance.core.messaging.MessagingGroupInfo
 import me.rhunk.snapenhance.download.DownloadProcessor
<a href="#h1-1-3" id="h1-1-3" class="d">-import me.rhunk.snapenhance.util.SerializableDataObject
</a><a href="#h1-1-4" id="h1-1-4" class="i">+import me.rhunk.snapenhance.core.util.SerializableDataObject
</a> import kotlin.system.measureTimeMillis
 
 class BridgeService : Service() {
<b>diff --git a/<a id="h2" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadProcessor.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadProcessor.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadProcessor.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadProcessor.kt</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -26,7 +26,7 @@ import me.rhunk.snapenhance.core.download.data.DownloadRequest
</a> import me.rhunk.snapenhance.core.download.data.DownloadStage
 import me.rhunk.snapenhance.core.download.data.InputMedia
 import me.rhunk.snapenhance.core.download.data.MediaEncryptionKeyPair
<a href="#h2-0-3" id="h2-0-3" class="d">-import me.rhunk.snapenhance.util.download.RemoteMediaResolver
</a><a href="#h2-0-4" id="h2-0-4" class="i">+import me.rhunk.snapenhance.core.util.download.RemoteMediaResolver
</a> import java.io.File
 import java.io.InputStream
 import java.net.HttpURLConnection
<b>diff --git a/<a id="h3" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadTaskManager.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadTaskManager.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadTaskManager.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadTaskManager.kt</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -6,9 +6,9 @@ import android.database.sqlite.SQLiteDatabase
</a> import me.rhunk.snapenhance.core.download.data.DownloadMetadata
 import me.rhunk.snapenhance.core.download.data.DownloadStage
 import me.rhunk.snapenhance.core.download.data.MediaDownloadSource
<a href="#h3-0-3" id="h3-0-3" class="d">-import me.rhunk.snapenhance.util.SQLiteDatabaseHelper
</a><a href="#h3-0-4" id="h3-0-4" class="d">-import me.rhunk.snapenhance.util.ktx.getIntOrNull
</a><a href="#h3-0-5" id="h3-0-5" class="d">-import me.rhunk.snapenhance.util.ktx.getStringOrNull
</a><a href="#h3-0-6" id="h3-0-6" class="i">+import me.rhunk.snapenhance.core.util.SQLiteDatabaseHelper
</a><a href="#h3-0-7" id="h3-0-7" class="i">+import me.rhunk.snapenhance.core.util.ktx.getIntOrNull
</a><a href="#h3-0-8" id="h3-0-8" class="i">+import me.rhunk.snapenhance.core.util.ktx.getStringOrNull
</a> 
 class DownloadTaskManager {
     private lateinit var taskDatabase: SQLiteDatabase
<b>diff --git a/<a id="h4" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/download/FFMpegProcessor.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/download/FFMpegProcessor.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/download/FFMpegProcessor.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/download/FFMpegProcessor.kt</a></b>
<a href="#h4-0" id="h4-0" class="h">@@ -4,9 +4,9 @@ import com.arthenica.ffmpegkit.FFmpegKit
</a> import com.arthenica.ffmpegkit.FFmpegSession
 import com.arthenica.ffmpegkit.Level
 import kotlinx.coroutines.suspendCancellableCoroutine
<a href="#h4-0-3" id="h4-0-3" class="d">-import me.rhunk.snapenhance.LogLevel
</a><a href="#h4-0-4" id="h4-0-4" class="i">+import me.rhunk.snapenhance.core.LogLevel
</a> import me.rhunk.snapenhance.LogManager
<a href="#h4-0-6" id="h4-0-6" class="d">-import me.rhunk.snapenhance.Logger
</a><a href="#h4-0-7" id="h4-0-7" class="i">+import me.rhunk.snapenhance.core.Logger
</a> import me.rhunk.snapenhance.core.config.impl.DownloaderConfig
 import java.io.File
 import java.util.concurrent.Executors
<b>diff --git a/<a id="h5" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/messaging/ModDatabase.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/messaging/ModDatabase.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/messaging/ModDatabase.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/messaging/ModDatabase.kt</a></b>
<a href="#h5-0" id="h5-0" class="h">@@ -7,10 +7,10 @@ import me.rhunk.snapenhance.core.messaging.FriendStreaks
</a> import me.rhunk.snapenhance.core.messaging.MessagingFriendInfo
 import me.rhunk.snapenhance.core.messaging.MessagingGroupInfo
 import me.rhunk.snapenhance.core.messaging.MessagingRuleType
<a href="#h5-0-3" id="h5-0-3" class="d">-import me.rhunk.snapenhance.util.SQLiteDatabaseHelper
</a><a href="#h5-0-4" id="h5-0-4" class="d">-import me.rhunk.snapenhance.util.ktx.getInteger
</a><a href="#h5-0-5" id="h5-0-5" class="d">-import me.rhunk.snapenhance.util.ktx.getLongOrNull
</a><a href="#h5-0-6" id="h5-0-6" class="d">-import me.rhunk.snapenhance.util.ktx.getStringOrNull
</a><a href="#h5-0-7" id="h5-0-7" class="i">+import me.rhunk.snapenhance.core.util.SQLiteDatabaseHelper
</a><a href="#h5-0-8" id="h5-0-8" class="i">+import me.rhunk.snapenhance.core.util.ktx.getInteger
</a><a href="#h5-0-9" id="h5-0-9" class="i">+import me.rhunk.snapenhance.core.util.ktx.getLongOrNull
</a><a href="#h5-0-10" id="h5-0-10" class="i">+import me.rhunk.snapenhance.core.util.ktx.getStringOrNull
</a> import java.util.concurrent.Executors
 
 
<b>diff --git a/<a id="h6" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/messaging/StreaksReminder.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/messaging/StreaksReminder.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/messaging/StreaksReminder.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/messaging/StreaksReminder.kt</a></b>
<a href="#h6-0" id="h6-0" class="h">@@ -15,7 +15,7 @@ import me.rhunk.snapenhance.RemoteSideContext
</a> import me.rhunk.snapenhance.SharedContextHolder
 import me.rhunk.snapenhance.bridge.ForceStartActivity
 import me.rhunk.snapenhance.ui.util.ImageRequestHelper
<a href="#h6-0-3" id="h6-0-3" class="d">-import me.rhunk.snapenhance.util.snap.BitmojiSelfie
</a><a href="#h6-0-4" id="h6-0-4" class="i">+import me.rhunk.snapenhance.core.util.snap.BitmojiSelfie
</a> 
 class StreaksReminder(
     private val remoteSideContext: RemoteSideContext? = null
<b>diff --git a/<a id="h7" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/home/HomeSubSection.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/home/HomeSubSection.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/home/HomeSubSection.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/home/HomeSubSection.kt</a></b>
<a href="#h7-0" id="h7-0" class="h">@@ -53,8 +53,8 @@ import androidx.compose.ui.window.Dialog
</a> import kotlinx.coroutines.Dispatchers
 import kotlinx.coroutines.launch
 import me.rhunk.snapenhance.Constants
<a href="#h7-0-3" id="h7-0-3" class="d">-import me.rhunk.snapenhance.LogChannels
</a><a href="#h7-0-4" id="h7-0-4" class="d">-import me.rhunk.snapenhance.LogLevel
</a><a href="#h7-0-5" id="h7-0-5" class="i">+import me.rhunk.snapenhance.core.LogChannels
</a><a href="#h7-0-6" id="h7-0-6" class="i">+import me.rhunk.snapenhance.core.LogLevel
</a> import me.rhunk.snapenhance.LogReader
 import me.rhunk.snapenhance.RemoteSideContext
 import me.rhunk.snapenhance.action.EnumAction
<b>diff --git a/<a id="h8" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/social/AddFriendDialog.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/social/AddFriendDialog.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/social/AddFriendDialog.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/social/AddFriendDialog.kt</a></b>
<a href="#h8-0" id="h8-0" class="h">@@ -47,7 +47,7 @@ import me.rhunk.snapenhance.RemoteSideContext
</a> import me.rhunk.snapenhance.core.bridge.BridgeClient
 import me.rhunk.snapenhance.core.messaging.MessagingFriendInfo
 import me.rhunk.snapenhance.core.messaging.MessagingGroupInfo
<a href="#h8-0-3" id="h8-0-3" class="d">-import me.rhunk.snapenhance.util.snap.SnapWidgetBroadcastReceiverHelper
</a><a href="#h8-0-4" id="h8-0-4" class="i">+import me.rhunk.snapenhance.core.util.snap.SnapWidgetBroadcastReceiverHelper
</a> 
 class AddFriendDialog(
     private val context: RemoteSideContext,
<b>diff --git a/<a id="h9" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/social/ScopeContent.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/social/ScopeContent.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/social/ScopeContent.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/social/ScopeContent.kt</a></b>
<a href="#h9-0" id="h9-0" class="h">@@ -31,7 +31,7 @@ import me.rhunk.snapenhance.RemoteSideContext
</a> import me.rhunk.snapenhance.core.messaging.MessagingRuleType
 import me.rhunk.snapenhance.core.messaging.SocialScope
 import me.rhunk.snapenhance.ui.util.BitmojiImage
<a href="#h9-0-3" id="h9-0-3" class="d">-import me.rhunk.snapenhance.util.snap.BitmojiSelfie
</a><a href="#h9-0-4" id="h9-0-4" class="i">+import me.rhunk.snapenhance.core.util.snap.BitmojiSelfie
</a> 
 class ScopeContent(
     private val context: RemoteSideContext,
<b>diff --git a/<a id="h10" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/social/SocialSection.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/social/SocialSection.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/social/SocialSection.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/social/SocialSection.kt</a></b>
<a href="#h10-0" id="h10-0" class="h">@@ -57,7 +57,7 @@ import me.rhunk.snapenhance.ui.manager.Section
</a> import me.rhunk.snapenhance.ui.util.AlertDialogs
 import me.rhunk.snapenhance.ui.util.BitmojiImage
 import me.rhunk.snapenhance.ui.util.pagerTabIndicatorOffset
<a href="#h10-0-3" id="h10-0-3" class="d">-import me.rhunk.snapenhance.util.snap.BitmojiSelfie
</a><a href="#h10-0-4" id="h10-0-4" class="i">+import me.rhunk.snapenhance.core.util.snap.BitmojiSelfie
</a> 
 class SocialSection : Section() {
     private lateinit var friendList: List&lt;MessagingFriendInfo&gt;
<b>diff --git a/<a id="h11" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/screens/impl/MappingsScreen.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/screens/impl/MappingsScreen.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/screens/impl/MappingsScreen.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/screens/impl/MappingsScreen.kt</a></b>
<a href="#h11-0" id="h11-0" class="h">@@ -1,14 +1,10 @@
</a> package me.rhunk.snapenhance.ui.setup.screens.impl
 
<a href="#h11-0-2" id="h11-0-2" class="d">-import androidx.compose.foundation.layout.Column
</a><a href="#h11-0-3" id="h11-0-3" class="d">-import androidx.compose.foundation.layout.fillMaxWidth
</a> import androidx.compose.foundation.layout.padding
 import androidx.compose.foundation.layout.size
<a href="#h11-0-6" id="h11-0-6" class="d">-import androidx.compose.foundation.shape.RoundedCornerShape
</a> import androidx.compose.material3.Button
 import androidx.compose.material3.CircularProgressIndicator
 import androidx.compose.material3.MaterialTheme
<a href="#h11-0-10" id="h11-0-10" class="d">-import androidx.compose.material3.Surface
</a> import androidx.compose.material3.Text
 import androidx.compose.runtime.Composable
 import androidx.compose.runtime.getValue
<a href="#h11-1" id="h11-1" class="h">@@ -21,7 +17,6 @@ import androidx.compose.ui.unit.dp
</a> import androidx.compose.ui.window.Dialog
 import kotlinx.coroutines.Dispatchers
 import kotlinx.coroutines.launch
<a href="#h11-1-3" id="h11-1-3" class="d">-import me.rhunk.snapenhance.Logger
</a> import me.rhunk.snapenhance.ui.setup.screens.SetupScreen
 import me.rhunk.snapenhance.ui.util.AlertDialogs
 
<b>diff --git a/<a id="h12" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/util/ActivityLauncherHelper.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/util/ActivityLauncherHelper.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/util/ActivityLauncherHelper.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/util/ActivityLauncherHelper.kt</a></b>
<a href="#h12-0" id="h12-0" class="h">@@ -4,7 +4,7 @@ import android.content.Intent
</a> import androidx.activity.ComponentActivity
 import androidx.activity.result.ActivityResultLauncher
 import androidx.activity.result.contract.ActivityResultContracts
<a href="#h12-0-3" id="h12-0-3" class="d">-import me.rhunk.snapenhance.Logger
</a><a href="#h12-0-4" id="h12-0-4" class="i">+import me.rhunk.snapenhance.core.Logger
</a> 
 typealias ActivityLauncherCallback = (resultCode: Int, intent: Intent?) -&gt; Unit
 
<b>diff --git a/<a id="h13" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/EventDispatcher.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/EventDispatcher.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/EventDispatcher.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/EventDispatcher.kt</a></b>
<a href="#h13-0" id="h13-0" class="h">@@ -9,15 +9,15 @@ import me.rhunk.snapenhance.core.eventbus.events.impl.NetworkApiRequestEvent
</a> import me.rhunk.snapenhance.core.eventbus.events.impl.OnSnapInteractionEvent
 import me.rhunk.snapenhance.core.eventbus.events.impl.SendMessageWithContentEvent
 import me.rhunk.snapenhance.core.eventbus.events.impl.SnapWidgetBroadcastReceiveEvent
<a href="#h13-0-3" id="h13-0-3" class="i">+import me.rhunk.snapenhance.core.util.ktx.getObjectField
</a><a href="#h13-0-4" id="h13-0-4" class="i">+import me.rhunk.snapenhance.core.util.ktx.setObjectField
</a><a href="#h13-0-5" id="h13-0-5" class="i">+import me.rhunk.snapenhance.core.util.snap.SnapWidgetBroadcastReceiverHelper
</a> import me.rhunk.snapenhance.data.wrapper.impl.MessageContent
 import me.rhunk.snapenhance.data.wrapper.impl.MessageDestinations
 import me.rhunk.snapenhance.data.wrapper.impl.SnapUUID
 import me.rhunk.snapenhance.hook.HookStage
 import me.rhunk.snapenhance.hook.hook
 import me.rhunk.snapenhance.manager.Manager
<a href="#h13-0-12" id="h13-0-12" class="d">-import me.rhunk.snapenhance.util.ktx.getObjectField
</a><a href="#h13-0-13" id="h13-0-13" class="d">-import me.rhunk.snapenhance.util.ktx.setObjectField
</a><a href="#h13-0-14" id="h13-0-14" class="d">-import me.rhunk.snapenhance.util.snap.SnapWidgetBroadcastReceiverHelper
</a> 
 class EventDispatcher(
     private val context: ModContext
<b>diff --git a/<a id="h14" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/Logger.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/Logger.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/Logger.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/Logger.kt</a></b>
<a href="#h14-0" id="h14-0" class="h">@@ -1,123 +0,0 @@
</a><a href="#h14-0-0" id="h14-0-0" class="d">-package me.rhunk.snapenhance
</a><a href="#h14-0-1" id="h14-0-1" class="d">-
</a><a href="#h14-0-2" id="h14-0-2" class="d">-import android.annotation.SuppressLint
</a><a href="#h14-0-3" id="h14-0-3" class="d">-import android.util.Log
</a><a href="#h14-0-4" id="h14-0-4" class="d">-import de.robv.android.xposed.XposedBridge
</a><a href="#h14-0-5" id="h14-0-5" class="d">-import me.rhunk.snapenhance.core.bridge.BridgeClient
</a><a href="#h14-0-6" id="h14-0-6" class="d">-import me.rhunk.snapenhance.hook.HookStage
</a><a href="#h14-0-7" id="h14-0-7" class="d">-import me.rhunk.snapenhance.hook.hook
</a><a href="#h14-0-8" id="h14-0-8" class="d">-
</a><a href="#h14-0-9" id="h14-0-9" class="d">-enum class LogLevel(
</a><a href="#h14-0-10" id="h14-0-10" class="d">-    val letter: String,
</a><a href="#h14-0-11" id="h14-0-11" class="d">-    val shortName: String,
</a><a href="#h14-0-12" id="h14-0-12" class="d">-    val priority: Int = Log.INFO
</a><a href="#h14-0-13" id="h14-0-13" class="d">-) {
</a><a href="#h14-0-14" id="h14-0-14" class="d">-    VERBOSE(&quot;V&quot;, &quot;verbose&quot;, Log.VERBOSE),
</a><a href="#h14-0-15" id="h14-0-15" class="d">-    DEBUG(&quot;D&quot;, &quot;debug&quot;, Log.DEBUG),
</a><a href="#h14-0-16" id="h14-0-16" class="d">-    INFO(&quot;I&quot;, &quot;info&quot;, Log.INFO),
</a><a href="#h14-0-17" id="h14-0-17" class="d">-    WARN(&quot;W&quot;, &quot;warn&quot;, Log.WARN),
</a><a href="#h14-0-18" id="h14-0-18" class="d">-    ERROR(&quot;E&quot;, &quot;error&quot;, Log.ERROR),
</a><a href="#h14-0-19" id="h14-0-19" class="d">-    ASSERT(&quot;A&quot;, &quot;assert&quot;, Log.ASSERT);
</a><a href="#h14-0-20" id="h14-0-20" class="d">-
</a><a href="#h14-0-21" id="h14-0-21" class="d">-    companion object {
</a><a href="#h14-0-22" id="h14-0-22" class="d">-        fun fromLetter(letter: String): LogLevel? {
</a><a href="#h14-0-23" id="h14-0-23" class="d">-            return values().find { it.letter == letter }
</a><a href="#h14-0-24" id="h14-0-24" class="d">-        }
</a><a href="#h14-0-25" id="h14-0-25" class="d">-
</a><a href="#h14-0-26" id="h14-0-26" class="d">-        fun fromShortName(shortName: String): LogLevel? {
</a><a href="#h14-0-27" id="h14-0-27" class="d">-            return values().find { it.shortName == shortName }
</a><a href="#h14-0-28" id="h14-0-28" class="d">-        }
</a><a href="#h14-0-29" id="h14-0-29" class="d">-
</a><a href="#h14-0-30" id="h14-0-30" class="d">-        fun fromPriority(priority: Int): LogLevel? {
</a><a href="#h14-0-31" id="h14-0-31" class="d">-            return values().find { it.priority == priority }
</a><a href="#h14-0-32" id="h14-0-32" class="d">-        }
</a><a href="#h14-0-33" id="h14-0-33" class="d">-    }
</a><a href="#h14-0-34" id="h14-0-34" class="d">-}
</a><a href="#h14-0-35" id="h14-0-35" class="d">-
</a><a href="#h14-0-36" id="h14-0-36" class="d">-enum class LogChannels(val channel: String, val shortName: String) {
</a><a href="#h14-0-37" id="h14-0-37" class="d">-    CORE(&quot;SnapEnhanceCore&quot;, &quot;core&quot;),
</a><a href="#h14-0-38" id="h14-0-38" class="d">-    NATIVE(&quot;SnapEnhanceNative&quot;, &quot;native&quot;),
</a><a href="#h14-0-39" id="h14-0-39" class="d">-    MANAGER(&quot;SnapEnhanceManager&quot;, &quot;manager&quot;),
</a><a href="#h14-0-40" id="h14-0-40" class="d">-    XPOSED(&quot;LSPosed-Bridge&quot;, &quot;xposed&quot;);
</a><a href="#h14-0-41" id="h14-0-41" class="d">-
</a><a href="#h14-0-42" id="h14-0-42" class="d">-    companion object {
</a><a href="#h14-0-43" id="h14-0-43" class="d">-        fun fromChannel(channel: String): LogChannels? {
</a><a href="#h14-0-44" id="h14-0-44" class="d">-            return values().find { it.channel == channel }
</a><a href="#h14-0-45" id="h14-0-45" class="d">-        }
</a><a href="#h14-0-46" id="h14-0-46" class="d">-    }
</a><a href="#h14-0-47" id="h14-0-47" class="d">-}
</a><a href="#h14-0-48" id="h14-0-48" class="d">-
</a><a href="#h14-0-49" id="h14-0-49" class="d">-
</a><a href="#h14-0-50" id="h14-0-50" class="d">-@SuppressLint(&quot;PrivateApi&quot;)
</a><a href="#h14-0-51" id="h14-0-51" class="d">-class Logger(
</a><a href="#h14-0-52" id="h14-0-52" class="d">-    private val bridgeClient: BridgeClient
</a><a href="#h14-0-53" id="h14-0-53" class="d">-) {
</a><a href="#h14-0-54" id="h14-0-54" class="d">-    companion object {
</a><a href="#h14-0-55" id="h14-0-55" class="d">-        private const val TAG = &quot;SnapEnhanceCore&quot;
</a><a href="#h14-0-56" id="h14-0-56" class="d">-
</a><a href="#h14-0-57" id="h14-0-57" class="d">-        fun directDebug(message: Any?, tag: String = TAG) {
</a><a href="#h14-0-58" id="h14-0-58" class="d">-            Log.println(Log.DEBUG, tag, message.toString())
</a><a href="#h14-0-59" id="h14-0-59" class="d">-        }
</a><a href="#h14-0-60" id="h14-0-60" class="d">-
</a><a href="#h14-0-61" id="h14-0-61" class="d">-        fun directError(message: Any?, throwable: Throwable, tag: String = TAG) {
</a><a href="#h14-0-62" id="h14-0-62" class="d">-            Log.println(Log.ERROR, tag, message.toString())
</a><a href="#h14-0-63" id="h14-0-63" class="d">-            Log.println(Log.ERROR, tag, throwable.toString())
</a><a href="#h14-0-64" id="h14-0-64" class="d">-        }
</a><a href="#h14-0-65" id="h14-0-65" class="d">-
</a><a href="#h14-0-66" id="h14-0-66" class="d">-        fun xposedLog(message: Any?, tag: String = TAG) {
</a><a href="#h14-0-67" id="h14-0-67" class="d">-            Log.println(Log.INFO, tag, message.toString())
</a><a href="#h14-0-68" id="h14-0-68" class="d">-            XposedBridge.log(&quot;$tag: $message&quot;)
</a><a href="#h14-0-69" id="h14-0-69" class="d">-        }
</a><a href="#h14-0-70" id="h14-0-70" class="d">-
</a><a href="#h14-0-71" id="h14-0-71" class="d">-        fun xposedLog(message: Any?, throwable: Throwable, tag: String = TAG) {
</a><a href="#h14-0-72" id="h14-0-72" class="d">-            Log.println(Log.INFO, tag, message.toString())
</a><a href="#h14-0-73" id="h14-0-73" class="d">-            XposedBridge.log(&quot;$tag: $message&quot;)
</a><a href="#h14-0-74" id="h14-0-74" class="d">-            XposedBridge.log(throwable)
</a><a href="#h14-0-75" id="h14-0-75" class="d">-        }
</a><a href="#h14-0-76" id="h14-0-76" class="d">-    }
</a><a href="#h14-0-77" id="h14-0-77" class="d">-
</a><a href="#h14-0-78" id="h14-0-78" class="d">-    private var invokeOriginalPrintLog: (Int, String, String) -&gt; Unit
</a><a href="#h14-0-79" id="h14-0-79" class="d">-
</a><a href="#h14-0-80" id="h14-0-80" class="d">-    init {
</a><a href="#h14-0-81" id="h14-0-81" class="d">-        val printLnMethod = Log::class.java.getDeclaredMethod(&quot;println&quot;, Int::class.java, String::class.java, String::class.java)
</a><a href="#h14-0-82" id="h14-0-82" class="d">-        printLnMethod.hook(HookStage.BEFORE) { param -&gt;
</a><a href="#h14-0-83" id="h14-0-83" class="d">-            val priority = param.arg(0) as Int
</a><a href="#h14-0-84" id="h14-0-84" class="d">-            val tag = param.arg(1) as String
</a><a href="#h14-0-85" id="h14-0-85" class="d">-            val message = param.arg(2) as String
</a><a href="#h14-0-86" id="h14-0-86" class="d">-            internalLog(tag, LogLevel.fromPriority(priority) ?: LogLevel.INFO, message)
</a><a href="#h14-0-87" id="h14-0-87" class="d">-        }
</a><a href="#h14-0-88" id="h14-0-88" class="d">-
</a><a href="#h14-0-89" id="h14-0-89" class="d">-        invokeOriginalPrintLog = { priority, tag, message -&gt;
</a><a href="#h14-0-90" id="h14-0-90" class="d">-            XposedBridge.invokeOriginalMethod(
</a><a href="#h14-0-91" id="h14-0-91" class="d">-                printLnMethod,
</a><a href="#h14-0-92" id="h14-0-92" class="d">-                null,
</a><a href="#h14-0-93" id="h14-0-93" class="d">-                arrayOf(priority, tag, message)
</a><a href="#h14-0-94" id="h14-0-94" class="d">-            )
</a><a href="#h14-0-95" id="h14-0-95" class="d">-        }
</a><a href="#h14-0-96" id="h14-0-96" class="d">-    }
</a><a href="#h14-0-97" id="h14-0-97" class="d">-
</a><a href="#h14-0-98" id="h14-0-98" class="d">-    private fun internalLog(tag: String, logLevel: LogLevel, message: Any?) {
</a><a href="#h14-0-99" id="h14-0-99" class="d">-        runCatching {
</a><a href="#h14-0-100" id="h14-0-100" class="d">-            bridgeClient.broadcastLog(tag, logLevel.shortName, message.toString())
</a><a href="#h14-0-101" id="h14-0-101" class="d">-        }.onFailure {
</a><a href="#h14-0-102" id="h14-0-102" class="d">-            invokeOriginalPrintLog(logLevel.priority, tag, message.toString())
</a><a href="#h14-0-103" id="h14-0-103" class="d">-        }
</a><a href="#h14-0-104" id="h14-0-104" class="d">-    }
</a><a href="#h14-0-105" id="h14-0-105" class="d">-
</a><a href="#h14-0-106" id="h14-0-106" class="d">-    fun debug(message: Any?, tag: String = TAG) = internalLog(tag, LogLevel.DEBUG, message)
</a><a href="#h14-0-107" id="h14-0-107" class="d">-
</a><a href="#h14-0-108" id="h14-0-108" class="d">-    fun error(message: Any?, tag: String = TAG) = internalLog(tag, LogLevel.ERROR, message)
</a><a href="#h14-0-109" id="h14-0-109" class="d">-
</a><a href="#h14-0-110" id="h14-0-110" class="d">-    fun error(message: Any?, throwable: Throwable, tag: String = TAG) {
</a><a href="#h14-0-111" id="h14-0-111" class="d">-        internalLog(tag, LogLevel.ERROR, message)
</a><a href="#h14-0-112" id="h14-0-112" class="d">-        internalLog(tag, LogLevel.ERROR, throwable.stackTraceToString())
</a><a href="#h14-0-113" id="h14-0-113" class="d">-    }
</a><a href="#h14-0-114" id="h14-0-114" class="d">-
</a><a href="#h14-0-115" id="h14-0-115" class="d">-    fun info(message: Any?, tag: String = TAG) = internalLog(tag, LogLevel.INFO, message)
</a><a href="#h14-0-116" id="h14-0-116" class="d">-
</a><a href="#h14-0-117" id="h14-0-117" class="d">-    fun verbose(message: Any?, tag: String = TAG) = internalLog(tag, LogLevel.VERBOSE, message)
</a><a href="#h14-0-118" id="h14-0-118" class="d">-
</a><a href="#h14-0-119" id="h14-0-119" class="d">-    fun warn(message: Any?, tag: String = TAG) = internalLog(tag, LogLevel.WARN, message)
</a><a href="#h14-0-120" id="h14-0-120" class="d">-
</a><a href="#h14-0-121" id="h14-0-121" class="d">-    fun assert(message: Any?, tag: String = TAG) = internalLog(tag, LogLevel.ASSERT, message)
</a><a href="#h14-0-122" id="h14-0-122" class="d">-}</a><a href="#h14-0-123" id="h14-0-123" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h15" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/ModContext.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/ModContext.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/ModContext.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/ModContext.kt</a></b>
<a href="#h15-0" id="h15-0" class="h">@@ -11,19 +11,20 @@ import android.widget.Toast
</a> import com.google.gson.Gson
 import com.google.gson.GsonBuilder
 import kotlinx.coroutines.asCoroutineDispatcher
<a href="#h15-0-3" id="h15-0-3" class="i">+import me.rhunk.snapenhance.core.Logger
</a> import me.rhunk.snapenhance.core.bridge.BridgeClient
 import me.rhunk.snapenhance.core.bridge.wrapper.LocaleWrapper
 import me.rhunk.snapenhance.core.bridge.wrapper.MappingsWrapper
 import me.rhunk.snapenhance.core.config.ModConfig
 import me.rhunk.snapenhance.core.database.DatabaseAccess
 import me.rhunk.snapenhance.core.eventbus.EventBus
<a href="#h15-0-10" id="h15-0-10" class="i">+import me.rhunk.snapenhance.core.util.download.HttpServer
</a> import me.rhunk.snapenhance.data.MessageSender
 import me.rhunk.snapenhance.features.Feature
 import me.rhunk.snapenhance.manager.impl.ActionManager
 import me.rhunk.snapenhance.manager.impl.FeatureManager
 import me.rhunk.snapenhance.nativelib.NativeConfig
 import me.rhunk.snapenhance.nativelib.NativeLib
<a href="#h15-0-17" id="h15-0-17" class="d">-import me.rhunk.snapenhance.util.download.HttpServer
</a> import java.util.concurrent.ExecutorService
 import java.util.concurrent.Executors
 import kotlin.reflect.KClass
<b>diff --git a/<a id="h16" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/SnapEnhance.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/SnapEnhance.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/SnapEnhance.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/SnapEnhance.kt</a></b>
<a href="#h16-0" id="h16-0" class="h">@@ -8,16 +8,17 @@ import kotlinx.coroutines.runBlocking
</a> import kotlinx.coroutines.withContext
 import me.rhunk.snapenhance.bridge.SyncCallback
 import me.rhunk.snapenhance.core.BuildConfig
<a href="#h16-0-3" id="h16-0-3" class="i">+import me.rhunk.snapenhance.core.Logger
</a> import me.rhunk.snapenhance.core.bridge.BridgeClient
 import me.rhunk.snapenhance.core.eventbus.events.impl.SnapWidgetBroadcastReceiveEvent
 import me.rhunk.snapenhance.core.eventbus.events.impl.UnaryCallEvent
 import me.rhunk.snapenhance.core.messaging.MessagingFriendInfo
 import me.rhunk.snapenhance.core.messaging.MessagingGroupInfo
<a href="#h16-0-9" id="h16-0-9" class="i">+import me.rhunk.snapenhance.core.util.ktx.getApplicationInfoCompat
</a> import me.rhunk.snapenhance.data.SnapClassCache
 import me.rhunk.snapenhance.hook.HookStage
 import me.rhunk.snapenhance.hook.Hooker
 import me.rhunk.snapenhance.hook.hook
<a href="#h16-0-14" id="h16-0-14" class="d">-import me.rhunk.snapenhance.util.ktx.getApplicationInfoCompat
</a> import kotlin.time.ExperimentalTime
 import kotlin.time.measureTime
 
<b>diff --git a/<a id="h17" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/action/impl/ExportChatMessages.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/action/impl/ExportChatMessages.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/action/impl/ExportChatMessages.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/action/impl/ExportChatMessages.kt</a></b>
<a href="#h17-0" id="h17-0" class="h">@@ -11,17 +11,17 @@ import kotlinx.coroutines.Job
</a> import kotlinx.coroutines.joinAll
 import kotlinx.coroutines.launch
 import kotlinx.coroutines.suspendCancellableCoroutine
<a href="#h17-0-3" id="h17-0-3" class="d">-import me.rhunk.snapenhance.Logger
</a> import me.rhunk.snapenhance.action.AbstractAction
<a href="#h17-0-5" id="h17-0-5" class="i">+import me.rhunk.snapenhance.core.Logger
</a> import me.rhunk.snapenhance.core.database.objects.FriendFeedEntry
<a href="#h17-0-7" id="h17-0-7" class="i">+import me.rhunk.snapenhance.core.util.CallbackBuilder
</a><a href="#h17-0-8" id="h17-0-8" class="i">+import me.rhunk.snapenhance.core.util.export.ExportFormat
</a><a href="#h17-0-9" id="h17-0-9" class="i">+import me.rhunk.snapenhance.core.util.export.MessageExporter
</a> import me.rhunk.snapenhance.data.ContentType
 import me.rhunk.snapenhance.data.wrapper.impl.Message
 import me.rhunk.snapenhance.data.wrapper.impl.SnapUUID
 import me.rhunk.snapenhance.features.impl.Messaging
 import me.rhunk.snapenhance.ui.ViewAppearanceHelper
<a href="#h17-0-15" id="h17-0-15" class="d">-import me.rhunk.snapenhance.util.CallbackBuilder
</a><a href="#h17-0-16" id="h17-0-16" class="d">-import me.rhunk.snapenhance.util.export.ExportFormat
</a><a href="#h17-0-17" id="h17-0-17" class="d">-import me.rhunk.snapenhance.util.export.MessageExporter
</a> import java.io.File
 import kotlin.math.absoluteValue
 
<b>diff --git a/<a id="h18" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/Logger.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/Logger.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/Logger.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/Logger.kt</a></b>
<a href="#h18-0" id="h18-0" class="h">@@ -0,0 +1,123 @@
</a><a href="#h18-0-0" id="h18-0-0" class="i">+package me.rhunk.snapenhance.core
</a><a href="#h18-0-1" id="h18-0-1" class="i">+
</a><a href="#h18-0-2" id="h18-0-2" class="i">+import android.annotation.SuppressLint
</a><a href="#h18-0-3" id="h18-0-3" class="i">+import android.util.Log
</a><a href="#h18-0-4" id="h18-0-4" class="i">+import de.robv.android.xposed.XposedBridge
</a><a href="#h18-0-5" id="h18-0-5" class="i">+import me.rhunk.snapenhance.core.bridge.BridgeClient
</a><a href="#h18-0-6" id="h18-0-6" class="i">+import me.rhunk.snapenhance.hook.HookStage
</a><a href="#h18-0-7" id="h18-0-7" class="i">+import me.rhunk.snapenhance.hook.hook
</a><a href="#h18-0-8" id="h18-0-8" class="i">+
</a><a href="#h18-0-9" id="h18-0-9" class="i">+enum class LogLevel(
</a><a href="#h18-0-10" id="h18-0-10" class="i">+    val letter: String,
</a><a href="#h18-0-11" id="h18-0-11" class="i">+    val shortName: String,
</a><a href="#h18-0-12" id="h18-0-12" class="i">+    val priority: Int = Log.INFO
</a><a href="#h18-0-13" id="h18-0-13" class="i">+) {
</a><a href="#h18-0-14" id="h18-0-14" class="i">+    VERBOSE(&quot;V&quot;, &quot;verbose&quot;, Log.VERBOSE),
</a><a href="#h18-0-15" id="h18-0-15" class="i">+    DEBUG(&quot;D&quot;, &quot;debug&quot;, Log.DEBUG),
</a><a href="#h18-0-16" id="h18-0-16" class="i">+    INFO(&quot;I&quot;, &quot;info&quot;, Log.INFO),
</a><a href="#h18-0-17" id="h18-0-17" class="i">+    WARN(&quot;W&quot;, &quot;warn&quot;, Log.WARN),
</a><a href="#h18-0-18" id="h18-0-18" class="i">+    ERROR(&quot;E&quot;, &quot;error&quot;, Log.ERROR),
</a><a href="#h18-0-19" id="h18-0-19" class="i">+    ASSERT(&quot;A&quot;, &quot;assert&quot;, Log.ASSERT);
</a><a href="#h18-0-20" id="h18-0-20" class="i">+
</a><a href="#h18-0-21" id="h18-0-21" class="i">+    companion object {
</a><a href="#h18-0-22" id="h18-0-22" class="i">+        fun fromLetter(letter: String): LogLevel? {
</a><a href="#h18-0-23" id="h18-0-23" class="i">+            return values().find { it.letter == letter }
</a><a href="#h18-0-24" id="h18-0-24" class="i">+        }
</a><a href="#h18-0-25" id="h18-0-25" class="i">+
</a><a href="#h18-0-26" id="h18-0-26" class="i">+        fun fromShortName(shortName: String): LogLevel? {
</a><a href="#h18-0-27" id="h18-0-27" class="i">+            return values().find { it.shortName == shortName }
</a><a href="#h18-0-28" id="h18-0-28" class="i">+        }
</a><a href="#h18-0-29" id="h18-0-29" class="i">+
</a><a href="#h18-0-30" id="h18-0-30" class="i">+        fun fromPriority(priority: Int): LogLevel? {
</a><a href="#h18-0-31" id="h18-0-31" class="i">+            return values().find { it.priority == priority }
</a><a href="#h18-0-32" id="h18-0-32" class="i">+        }
</a><a href="#h18-0-33" id="h18-0-33" class="i">+    }
</a><a href="#h18-0-34" id="h18-0-34" class="i">+}
</a><a href="#h18-0-35" id="h18-0-35" class="i">+
</a><a href="#h18-0-36" id="h18-0-36" class="i">+enum class LogChannels(val channel: String, val shortName: String) {
</a><a href="#h18-0-37" id="h18-0-37" class="i">+    CORE(&quot;SnapEnhanceCore&quot;, &quot;core&quot;),
</a><a href="#h18-0-38" id="h18-0-38" class="i">+    NATIVE(&quot;SnapEnhanceNative&quot;, &quot;native&quot;),
</a><a href="#h18-0-39" id="h18-0-39" class="i">+    MANAGER(&quot;SnapEnhanceManager&quot;, &quot;manager&quot;),
</a><a href="#h18-0-40" id="h18-0-40" class="i">+    XPOSED(&quot;LSPosed-Bridge&quot;, &quot;xposed&quot;);
</a><a href="#h18-0-41" id="h18-0-41" class="i">+
</a><a href="#h18-0-42" id="h18-0-42" class="i">+    companion object {
</a><a href="#h18-0-43" id="h18-0-43" class="i">+        fun fromChannel(channel: String): LogChannels? {
</a><a href="#h18-0-44" id="h18-0-44" class="i">+            return values().find { it.channel == channel }
</a><a href="#h18-0-45" id="h18-0-45" class="i">+        }
</a><a href="#h18-0-46" id="h18-0-46" class="i">+    }
</a><a href="#h18-0-47" id="h18-0-47" class="i">+}
</a><a href="#h18-0-48" id="h18-0-48" class="i">+
</a><a href="#h18-0-49" id="h18-0-49" class="i">+
</a><a href="#h18-0-50" id="h18-0-50" class="i">+@SuppressLint(&quot;PrivateApi&quot;)
</a><a href="#h18-0-51" id="h18-0-51" class="i">+class Logger(
</a><a href="#h18-0-52" id="h18-0-52" class="i">+    private val bridgeClient: BridgeClient
</a><a href="#h18-0-53" id="h18-0-53" class="i">+) {
</a><a href="#h18-0-54" id="h18-0-54" class="i">+    companion object {
</a><a href="#h18-0-55" id="h18-0-55" class="i">+        private const val TAG = &quot;SnapEnhanceCore&quot;
</a><a href="#h18-0-56" id="h18-0-56" class="i">+
</a><a href="#h18-0-57" id="h18-0-57" class="i">+        fun directDebug(message: Any?, tag: String = TAG) {
</a><a href="#h18-0-58" id="h18-0-58" class="i">+            Log.println(Log.DEBUG, tag, message.toString())
</a><a href="#h18-0-59" id="h18-0-59" class="i">+        }
</a><a href="#h18-0-60" id="h18-0-60" class="i">+
</a><a href="#h18-0-61" id="h18-0-61" class="i">+        fun directError(message: Any?, throwable: Throwable, tag: String = TAG) {
</a><a href="#h18-0-62" id="h18-0-62" class="i">+            Log.println(Log.ERROR, tag, message.toString())
</a><a href="#h18-0-63" id="h18-0-63" class="i">+            Log.println(Log.ERROR, tag, throwable.toString())
</a><a href="#h18-0-64" id="h18-0-64" class="i">+        }
</a><a href="#h18-0-65" id="h18-0-65" class="i">+
</a><a href="#h18-0-66" id="h18-0-66" class="i">+        fun xposedLog(message: Any?, tag: String = TAG) {
</a><a href="#h18-0-67" id="h18-0-67" class="i">+            Log.println(Log.INFO, tag, message.toString())
</a><a href="#h18-0-68" id="h18-0-68" class="i">+            XposedBridge.log(&quot;$tag: $message&quot;)
</a><a href="#h18-0-69" id="h18-0-69" class="i">+        }
</a><a href="#h18-0-70" id="h18-0-70" class="i">+
</a><a href="#h18-0-71" id="h18-0-71" class="i">+        fun xposedLog(message: Any?, throwable: Throwable, tag: String = TAG) {
</a><a href="#h18-0-72" id="h18-0-72" class="i">+            Log.println(Log.INFO, tag, message.toString())
</a><a href="#h18-0-73" id="h18-0-73" class="i">+            XposedBridge.log(&quot;$tag: $message&quot;)
</a><a href="#h18-0-74" id="h18-0-74" class="i">+            XposedBridge.log(throwable)
</a><a href="#h18-0-75" id="h18-0-75" class="i">+        }
</a><a href="#h18-0-76" id="h18-0-76" class="i">+    }
</a><a href="#h18-0-77" id="h18-0-77" class="i">+
</a><a href="#h18-0-78" id="h18-0-78" class="i">+    private var invokeOriginalPrintLog: (Int, String, String) -&gt; Unit
</a><a href="#h18-0-79" id="h18-0-79" class="i">+
</a><a href="#h18-0-80" id="h18-0-80" class="i">+    init {
</a><a href="#h18-0-81" id="h18-0-81" class="i">+        val printLnMethod = Log::class.java.getDeclaredMethod(&quot;println&quot;, Int::class.java, String::class.java, String::class.java)
</a><a href="#h18-0-82" id="h18-0-82" class="i">+        printLnMethod.hook(HookStage.BEFORE) { param -&gt;
</a><a href="#h18-0-83" id="h18-0-83" class="i">+            val priority = param.arg(0) as Int
</a><a href="#h18-0-84" id="h18-0-84" class="i">+            val tag = param.arg(1) as String
</a><a href="#h18-0-85" id="h18-0-85" class="i">+            val message = param.arg(2) as String
</a><a href="#h18-0-86" id="h18-0-86" class="i">+            internalLog(tag, LogLevel.fromPriority(priority) ?: LogLevel.INFO, message)
</a><a href="#h18-0-87" id="h18-0-87" class="i">+        }
</a><a href="#h18-0-88" id="h18-0-88" class="i">+
</a><a href="#h18-0-89" id="h18-0-89" class="i">+        invokeOriginalPrintLog = { priority, tag, message -&gt;
</a><a href="#h18-0-90" id="h18-0-90" class="i">+            XposedBridge.invokeOriginalMethod(
</a><a href="#h18-0-91" id="h18-0-91" class="i">+                printLnMethod,
</a><a href="#h18-0-92" id="h18-0-92" class="i">+                null,
</a><a href="#h18-0-93" id="h18-0-93" class="i">+                arrayOf(priority, tag, message)
</a><a href="#h18-0-94" id="h18-0-94" class="i">+            )
</a><a href="#h18-0-95" id="h18-0-95" class="i">+        }
</a><a href="#h18-0-96" id="h18-0-96" class="i">+    }
</a><a href="#h18-0-97" id="h18-0-97" class="i">+
</a><a href="#h18-0-98" id="h18-0-98" class="i">+    private fun internalLog(tag: String, logLevel: LogLevel, message: Any?) {
</a><a href="#h18-0-99" id="h18-0-99" class="i">+        runCatching {
</a><a href="#h18-0-100" id="h18-0-100" class="i">+            bridgeClient.broadcastLog(tag, logLevel.shortName, message.toString())
</a><a href="#h18-0-101" id="h18-0-101" class="i">+        }.onFailure {
</a><a href="#h18-0-102" id="h18-0-102" class="i">+            invokeOriginalPrintLog(logLevel.priority, tag, message.toString())
</a><a href="#h18-0-103" id="h18-0-103" class="i">+        }
</a><a href="#h18-0-104" id="h18-0-104" class="i">+    }
</a><a href="#h18-0-105" id="h18-0-105" class="i">+
</a><a href="#h18-0-106" id="h18-0-106" class="i">+    fun debug(message: Any?, tag: String = TAG) = internalLog(tag, LogLevel.DEBUG, message)
</a><a href="#h18-0-107" id="h18-0-107" class="i">+
</a><a href="#h18-0-108" id="h18-0-108" class="i">+    fun error(message: Any?, tag: String = TAG) = internalLog(tag, LogLevel.ERROR, message)
</a><a href="#h18-0-109" id="h18-0-109" class="i">+
</a><a href="#h18-0-110" id="h18-0-110" class="i">+    fun error(message: Any?, throwable: Throwable, tag: String = TAG) {
</a><a href="#h18-0-111" id="h18-0-111" class="i">+        internalLog(tag, LogLevel.ERROR, message)
</a><a href="#h18-0-112" id="h18-0-112" class="i">+        internalLog(tag, LogLevel.ERROR, throwable.stackTraceToString())
</a><a href="#h18-0-113" id="h18-0-113" class="i">+    }
</a><a href="#h18-0-114" id="h18-0-114" class="i">+
</a><a href="#h18-0-115" id="h18-0-115" class="i">+    fun info(message: Any?, tag: String = TAG) = internalLog(tag, LogLevel.INFO, message)
</a><a href="#h18-0-116" id="h18-0-116" class="i">+
</a><a href="#h18-0-117" id="h18-0-117" class="i">+    fun verbose(message: Any?, tag: String = TAG) = internalLog(tag, LogLevel.VERBOSE, message)
</a><a href="#h18-0-118" id="h18-0-118" class="i">+
</a><a href="#h18-0-119" id="h18-0-119" class="i">+    fun warn(message: Any?, tag: String = TAG) = internalLog(tag, LogLevel.WARN, message)
</a><a href="#h18-0-120" id="h18-0-120" class="i">+
</a><a href="#h18-0-121" id="h18-0-121" class="i">+    fun assert(message: Any?, tag: String = TAG) = internalLog(tag, LogLevel.ASSERT, message)
</a><a href="#h18-0-122" id="h18-0-122" class="i">+}</a><a href="#h18-0-123" id="h18-0-123" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h19" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/wrapper/LocaleWrapper.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/wrapper/LocaleWrapper.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/wrapper/LocaleWrapper.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/wrapper/LocaleWrapper.kt</a></b>
<a href="#h19-0" id="h19-0" class="h">@@ -3,7 +3,7 @@ package me.rhunk.snapenhance.core.bridge.wrapper
</a> import android.content.Context
 import com.google.gson.JsonObject
 import com.google.gson.JsonParser
<a href="#h19-0-3" id="h19-0-3" class="d">-import me.rhunk.snapenhance.Logger
</a><a href="#h19-0-4" id="h19-0-4" class="i">+import me.rhunk.snapenhance.core.Logger
</a> import me.rhunk.snapenhance.core.bridge.BridgeClient
 import me.rhunk.snapenhance.data.LocalePair
 import java.util.Locale
<b>diff --git a/<a id="h20" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/wrapper/MappingsWrapper.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/wrapper/MappingsWrapper.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/wrapper/MappingsWrapper.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/wrapper/MappingsWrapper.kt</a></b>
<a href="#h20-0" id="h20-0" class="h">@@ -5,7 +5,7 @@ import com.google.gson.GsonBuilder
</a> import com.google.gson.JsonElement
 import com.google.gson.JsonParser
 import me.rhunk.snapenhance.Constants
<a href="#h20-0-3" id="h20-0-3" class="d">-import me.rhunk.snapenhance.Logger
</a><a href="#h20-0-4" id="h20-0-4" class="i">+import me.rhunk.snapenhance.core.Logger
</a> import me.rhunk.snapenhance.core.bridge.FileLoaderWrapper
 import me.rhunk.snapenhance.core.bridge.types.BridgeFileType
 import me.rhunk.snapmapper.Mapper
<b>diff --git a/<a id="h21" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/wrapper/MessageLoggerWrapper.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/wrapper/MessageLoggerWrapper.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/wrapper/MessageLoggerWrapper.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/wrapper/MessageLoggerWrapper.kt</a></b>
<a href="#h21-0" id="h21-0" class="h">@@ -2,7 +2,7 @@ package me.rhunk.snapenhance.core.bridge.wrapper
</a> 
 import android.content.ContentValues
 import android.database.sqlite.SQLiteDatabase
<a href="#h21-0-3" id="h21-0-3" class="d">-import me.rhunk.snapenhance.util.SQLiteDatabaseHelper
</a><a href="#h21-0-4" id="h21-0-4" class="i">+import me.rhunk.snapenhance.core.util.SQLiteDatabaseHelper
</a> import java.io.File
 
 class MessageLoggerWrapper(
<b>diff --git a/<a id="h22" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/database/DatabaseAccess.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/database/DatabaseAccess.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/database/DatabaseAccess.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/database/DatabaseAccess.kt</a></b>
<a href="#h22-0" id="h22-0" class="h">@@ -2,8 +2,8 @@ package me.rhunk.snapenhance.core.database
</a> 
 import android.annotation.SuppressLint
 import android.database.sqlite.SQLiteDatabase
<a href="#h22-0-3" id="h22-0-3" class="d">-import me.rhunk.snapenhance.Logger
</a> import me.rhunk.snapenhance.ModContext
<a href="#h22-0-5" id="h22-0-5" class="i">+import me.rhunk.snapenhance.core.Logger
</a> import me.rhunk.snapenhance.core.database.objects.ConversationMessage
 import me.rhunk.snapenhance.core.database.objects.FriendFeedEntry
 import me.rhunk.snapenhance.core.database.objects.FriendInfo
<b>diff --git a/<a id="h23" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/database/objects/ConversationMessage.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/database/objects/ConversationMessage.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/database/objects/ConversationMessage.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/database/objects/ConversationMessage.kt</a></b>
<a href="#h23-0" id="h23-0" class="h">@@ -4,12 +4,12 @@ import android.annotation.SuppressLint
</a> import android.database.Cursor
 import me.rhunk.snapenhance.Constants
 import me.rhunk.snapenhance.core.database.DatabaseObject
<a href="#h23-0-3" id="h23-0-3" class="i">+import me.rhunk.snapenhance.core.util.ktx.getBlobOrNull
</a><a href="#h23-0-4" id="h23-0-4" class="i">+import me.rhunk.snapenhance.core.util.ktx.getInteger
</a><a href="#h23-0-5" id="h23-0-5" class="i">+import me.rhunk.snapenhance.core.util.ktx.getLong
</a><a href="#h23-0-6" id="h23-0-6" class="i">+import me.rhunk.snapenhance.core.util.ktx.getStringOrNull
</a><a href="#h23-0-7" id="h23-0-7" class="i">+import me.rhunk.snapenhance.core.util.protobuf.ProtoReader
</a> import me.rhunk.snapenhance.data.ContentType
<a href="#h23-0-9" id="h23-0-9" class="d">-import me.rhunk.snapenhance.util.ktx.getBlobOrNull
</a><a href="#h23-0-10" id="h23-0-10" class="d">-import me.rhunk.snapenhance.util.ktx.getInteger
</a><a href="#h23-0-11" id="h23-0-11" class="d">-import me.rhunk.snapenhance.util.ktx.getLong
</a><a href="#h23-0-12" id="h23-0-12" class="d">-import me.rhunk.snapenhance.util.ktx.getStringOrNull
</a><a href="#h23-0-13" id="h23-0-13" class="d">-import me.rhunk.snapenhance.util.protobuf.ProtoReader
</a> 
 @Suppress(&quot;ArrayInDataClass&quot;)
 data class ConversationMessage(
<b>diff --git a/<a id="h24" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/database/objects/FriendFeedEntry.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/database/objects/FriendFeedEntry.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/database/objects/FriendFeedEntry.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/database/objects/FriendFeedEntry.kt</a></b>
<a href="#h24-0" id="h24-0" class="h">@@ -3,10 +3,10 @@ package me.rhunk.snapenhance.core.database.objects
</a> import android.annotation.SuppressLint
 import android.database.Cursor
 import me.rhunk.snapenhance.core.database.DatabaseObject
<a href="#h24-0-3" id="h24-0-3" class="d">-import me.rhunk.snapenhance.util.ktx.getIntOrNull
</a><a href="#h24-0-4" id="h24-0-4" class="d">-import me.rhunk.snapenhance.util.ktx.getInteger
</a><a href="#h24-0-5" id="h24-0-5" class="d">-import me.rhunk.snapenhance.util.ktx.getLong
</a><a href="#h24-0-6" id="h24-0-6" class="d">-import me.rhunk.snapenhance.util.ktx.getStringOrNull
</a><a href="#h24-0-7" id="h24-0-7" class="i">+import me.rhunk.snapenhance.core.util.ktx.getIntOrNull
</a><a href="#h24-0-8" id="h24-0-8" class="i">+import me.rhunk.snapenhance.core.util.ktx.getInteger
</a><a href="#h24-0-9" id="h24-0-9" class="i">+import me.rhunk.snapenhance.core.util.ktx.getLong
</a><a href="#h24-0-10" id="h24-0-10" class="i">+import me.rhunk.snapenhance.core.util.ktx.getStringOrNull
</a> 
 data class FriendFeedEntry(
     var id: Int = 0,
<b>diff --git a/<a id="h25" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/database/objects/FriendInfo.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/database/objects/FriendInfo.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/database/objects/FriendInfo.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/database/objects/FriendInfo.kt</a></b>
<a href="#h25-0" id="h25-0" class="h">@@ -3,10 +3,10 @@ package me.rhunk.snapenhance.core.database.objects
</a> import android.annotation.SuppressLint
 import android.database.Cursor
 import me.rhunk.snapenhance.core.database.DatabaseObject
<a href="#h25-0-3" id="h25-0-3" class="d">-import me.rhunk.snapenhance.util.SerializableDataObject
</a><a href="#h25-0-4" id="h25-0-4" class="d">-import me.rhunk.snapenhance.util.ktx.getInteger
</a><a href="#h25-0-5" id="h25-0-5" class="d">-import me.rhunk.snapenhance.util.ktx.getLong
</a><a href="#h25-0-6" id="h25-0-6" class="d">-import me.rhunk.snapenhance.util.ktx.getStringOrNull
</a><a href="#h25-0-7" id="h25-0-7" class="i">+import me.rhunk.snapenhance.core.util.SerializableDataObject
</a><a href="#h25-0-8" id="h25-0-8" class="i">+import me.rhunk.snapenhance.core.util.ktx.getInteger
</a><a href="#h25-0-9" id="h25-0-9" class="i">+import me.rhunk.snapenhance.core.util.ktx.getLong
</a><a href="#h25-0-10" id="h25-0-10" class="i">+import me.rhunk.snapenhance.core.util.ktx.getStringOrNull
</a> 
 data class FriendInfo(
     var id: Int = 0,
<b>diff --git a/<a id="h26" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/database/objects/StoryEntry.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/database/objects/StoryEntry.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/database/objects/StoryEntry.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/database/objects/StoryEntry.kt</a></b>
<a href="#h26-0" id="h26-0" class="h">@@ -3,8 +3,8 @@ package me.rhunk.snapenhance.core.database.objects
</a> import android.annotation.SuppressLint
 import android.database.Cursor
 import me.rhunk.snapenhance.core.database.DatabaseObject
<a href="#h26-0-3" id="h26-0-3" class="d">-import me.rhunk.snapenhance.util.ktx.getInteger
</a><a href="#h26-0-4" id="h26-0-4" class="d">-import me.rhunk.snapenhance.util.ktx.getStringOrNull
</a><a href="#h26-0-5" id="h26-0-5" class="i">+import me.rhunk.snapenhance.core.util.ktx.getInteger
</a><a href="#h26-0-6" id="h26-0-6" class="i">+import me.rhunk.snapenhance.core.util.ktx.getStringOrNull
</a> 
 data class StoryEntry(
     var id: Int = 0,
<b>diff --git a/<a id="h27" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/database/objects/UserConversationLink.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/database/objects/UserConversationLink.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/database/objects/UserConversationLink.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/database/objects/UserConversationLink.kt</a></b>
<a href="#h27-0" id="h27-0" class="h">@@ -3,8 +3,8 @@ package me.rhunk.snapenhance.core.database.objects
</a> import android.annotation.SuppressLint
 import android.database.Cursor
 import me.rhunk.snapenhance.core.database.DatabaseObject
<a href="#h27-0-3" id="h27-0-3" class="d">-import me.rhunk.snapenhance.util.ktx.getInteger
</a><a href="#h27-0-4" id="h27-0-4" class="d">-import me.rhunk.snapenhance.util.ktx.getStringOrNull
</a><a href="#h27-0-5" id="h27-0-5" class="i">+import me.rhunk.snapenhance.core.util.ktx.getInteger
</a><a href="#h27-0-6" id="h27-0-6" class="i">+import me.rhunk.snapenhance.core.util.ktx.getStringOrNull
</a> 
 class UserConversationLink(
     var userId: String? = null,
<b>diff --git a/<a id="h28" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/messaging/MessagingCoreObjects.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/messaging/MessagingCoreObjects.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/messaging/MessagingCoreObjects.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/messaging/MessagingCoreObjects.kt</a></b>
<a href="#h28-0" id="h28-0" class="h">@@ -1,6 +1,6 @@
</a> package me.rhunk.snapenhance.core.messaging
 
<a href="#h28-0-2" id="h28-0-2" class="d">-import me.rhunk.snapenhance.util.SerializableDataObject
</a><a href="#h28-0-3" id="h28-0-3" class="i">+import me.rhunk.snapenhance.core.util.SerializableDataObject
</a> 
 
 enum class RuleState(
<b>diff --git a/<a id="h29" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/util/CallbackBuilder.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/util/CallbackBuilder.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/util/CallbackBuilder.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/util/CallbackBuilder.kt</a></b>
<a href="#h29-0" id="h29-0" class="h">@@ -0,0 +1,93 @@
</a><a href="#h29-0-0" id="h29-0-0" class="i">+package me.rhunk.snapenhance.core.util
</a><a href="#h29-0-1" id="h29-0-1" class="i">+
</a><a href="#h29-0-2" id="h29-0-2" class="i">+import de.robv.android.xposed.XC_MethodHook
</a><a href="#h29-0-3" id="h29-0-3" class="i">+import me.rhunk.snapenhance.hook.HookAdapter
</a><a href="#h29-0-4" id="h29-0-4" class="i">+import me.rhunk.snapenhance.hook.HookStage
</a><a href="#h29-0-5" id="h29-0-5" class="i">+import me.rhunk.snapenhance.hook.Hooker
</a><a href="#h29-0-6" id="h29-0-6" class="i">+import java.lang.reflect.Constructor
</a><a href="#h29-0-7" id="h29-0-7" class="i">+import java.lang.reflect.Field
</a><a href="#h29-0-8" id="h29-0-8" class="i">+import java.lang.reflect.Modifier
</a><a href="#h29-0-9" id="h29-0-9" class="i">+
</a><a href="#h29-0-10" id="h29-0-10" class="i">+class CallbackBuilder(
</a><a href="#h29-0-11" id="h29-0-11" class="i">+    private val callbackClass: Class&lt;*&gt;
</a><a href="#h29-0-12" id="h29-0-12" class="i">+) {
</a><a href="#h29-0-13" id="h29-0-13" class="i">+    internal class Override(
</a><a href="#h29-0-14" id="h29-0-14" class="i">+        val methodName: String,
</a><a href="#h29-0-15" id="h29-0-15" class="i">+        val shouldUnhook: Boolean = true,
</a><a href="#h29-0-16" id="h29-0-16" class="i">+        val callback: (HookAdapter) -&gt; Unit
</a><a href="#h29-0-17" id="h29-0-17" class="i">+    )
</a><a href="#h29-0-18" id="h29-0-18" class="i">+
</a><a href="#h29-0-19" id="h29-0-19" class="i">+    private val methodOverrides = mutableListOf&lt;Override&gt;()
</a><a href="#h29-0-20" id="h29-0-20" class="i">+
</a><a href="#h29-0-21" id="h29-0-21" class="i">+    fun override(methodName: String, shouldUnhook: Boolean = true, callback: (HookAdapter) -&gt; Unit = {}): CallbackBuilder {
</a><a href="#h29-0-22" id="h29-0-22" class="i">+        methodOverrides.add(Override(methodName, shouldUnhook, callback))
</a><a href="#h29-0-23" id="h29-0-23" class="i">+        return this
</a><a href="#h29-0-24" id="h29-0-24" class="i">+    }
</a><a href="#h29-0-25" id="h29-0-25" class="i">+
</a><a href="#h29-0-26" id="h29-0-26" class="i">+    fun build(): Any {
</a><a href="#h29-0-27" id="h29-0-27" class="i">+        //get the first param of the first constructor to get the class of the invoker
</a><a href="#h29-0-28" id="h29-0-28" class="i">+        val invokerClass: Class&lt;*&gt; = callbackClass.constructors[0].parameterTypes[0]
</a><a href="#h29-0-29" id="h29-0-29" class="i">+        //get the invoker field based on the invoker class
</a><a href="#h29-0-30" id="h29-0-30" class="i">+        val invokerField = callbackClass.fields.first { field: Field -&gt;
</a><a href="#h29-0-31" id="h29-0-31" class="i">+            field.type.isAssignableFrom(invokerClass)
</a><a href="#h29-0-32" id="h29-0-32" class="i">+        }
</a><a href="#h29-0-33" id="h29-0-33" class="i">+        //get the callback field based on the callback class
</a><a href="#h29-0-34" id="h29-0-34" class="i">+        val callbackInstance = createEmptyObject(callbackClass.constructors[0])!!
</a><a href="#h29-0-35" id="h29-0-35" class="i">+        val callbackInstanceHashCode: Int = callbackInstance.hashCode()
</a><a href="#h29-0-36" id="h29-0-36" class="i">+        val callbackInstanceClass = callbackInstance.javaClass
</a><a href="#h29-0-37" id="h29-0-37" class="i">+
</a><a href="#h29-0-38" id="h29-0-38" class="i">+        val unhooks = mutableListOf&lt;XC_MethodHook.Unhook&gt;()
</a><a href="#h29-0-39" id="h29-0-39" class="i">+
</a><a href="#h29-0-40" id="h29-0-40" class="i">+        callbackInstanceClass.methods.forEach { method -&gt;
</a><a href="#h29-0-41" id="h29-0-41" class="i">+            if (method.declaringClass != callbackInstanceClass) return@forEach
</a><a href="#h29-0-42" id="h29-0-42" class="i">+            if (Modifier.isPrivate(method.modifiers)) return@forEach
</a><a href="#h29-0-43" id="h29-0-43" class="i">+
</a><a href="#h29-0-44" id="h29-0-44" class="i">+            //default hook that unhooks the callback and returns null
</a><a href="#h29-0-45" id="h29-0-45" class="i">+            val defaultHook: (HookAdapter) -&gt; Boolean = defaultHook@{
</a><a href="#h29-0-46" id="h29-0-46" class="i">+                //checking invokerField ensure that&#39;s the callback was created by the CallbackBuilder
</a><a href="#h29-0-47" id="h29-0-47" class="i">+                if (invokerField.get(it.thisObject()) != null) return@defaultHook false
</a><a href="#h29-0-48" id="h29-0-48" class="i">+                if ((it.thisObject() as Any).hashCode() != callbackInstanceHashCode) return@defaultHook false
</a><a href="#h29-0-49" id="h29-0-49" class="i">+                it.setResult(null)
</a><a href="#h29-0-50" id="h29-0-50" class="i">+                true
</a><a href="#h29-0-51" id="h29-0-51" class="i">+            }
</a><a href="#h29-0-52" id="h29-0-52" class="i">+
</a><a href="#h29-0-53" id="h29-0-53" class="i">+            var hook: (HookAdapter) -&gt; Unit = { defaultHook(it) }
</a><a href="#h29-0-54" id="h29-0-54" class="i">+
</a><a href="#h29-0-55" id="h29-0-55" class="i">+            //override the default hook if the method is in the override list
</a><a href="#h29-0-56" id="h29-0-56" class="i">+            methodOverrides.find { it.methodName == method.name }?.run {
</a><a href="#h29-0-57" id="h29-0-57" class="i">+                hook = {
</a><a href="#h29-0-58" id="h29-0-58" class="i">+                    if (defaultHook(it)) {
</a><a href="#h29-0-59" id="h29-0-59" class="i">+                        callback(it)
</a><a href="#h29-0-60" id="h29-0-60" class="i">+                        if (shouldUnhook) unhooks.forEach { unhook -&gt; unhook.unhook() }
</a><a href="#h29-0-61" id="h29-0-61" class="i">+                    }
</a><a href="#h29-0-62" id="h29-0-62" class="i">+                }
</a><a href="#h29-0-63" id="h29-0-63" class="i">+            }
</a><a href="#h29-0-64" id="h29-0-64" class="i">+
</a><a href="#h29-0-65" id="h29-0-65" class="i">+            unhooks.add(Hooker.hook(method, HookStage.BEFORE, hook))
</a><a href="#h29-0-66" id="h29-0-66" class="i">+        }
</a><a href="#h29-0-67" id="h29-0-67" class="i">+        return callbackInstance
</a><a href="#h29-0-68" id="h29-0-68" class="i">+    }
</a><a href="#h29-0-69" id="h29-0-69" class="i">+
</a><a href="#h29-0-70" id="h29-0-70" class="i">+    companion object {
</a><a href="#h29-0-71" id="h29-0-71" class="i">+        fun createEmptyObject(constructor: Constructor&lt;*&gt;): Any? {
</a><a href="#h29-0-72" id="h29-0-72" class="i">+            //compute the args for the constructor with null or default primitive values
</a><a href="#h29-0-73" id="h29-0-73" class="i">+            val args = constructor.parameterTypes.map { type: Class&lt;*&gt; -&gt;
</a><a href="#h29-0-74" id="h29-0-74" class="i">+                if (type.isPrimitive) {
</a><a href="#h29-0-75" id="h29-0-75" class="i">+                    when (type.name) {
</a><a href="#h29-0-76" id="h29-0-76" class="i">+                        &quot;boolean&quot; -&gt; return@map false
</a><a href="#h29-0-77" id="h29-0-77" class="i">+                        &quot;byte&quot; -&gt; return@map 0.toByte()
</a><a href="#h29-0-78" id="h29-0-78" class="i">+                        &quot;char&quot; -&gt; return@map 0.toChar()
</a><a href="#h29-0-79" id="h29-0-79" class="i">+                        &quot;short&quot; -&gt; return@map 0.toShort()
</a><a href="#h29-0-80" id="h29-0-80" class="i">+                        &quot;int&quot; -&gt; return@map 0
</a><a href="#h29-0-81" id="h29-0-81" class="i">+                        &quot;long&quot; -&gt; return@map 0L
</a><a href="#h29-0-82" id="h29-0-82" class="i">+                        &quot;float&quot; -&gt; return@map 0f
</a><a href="#h29-0-83" id="h29-0-83" class="i">+                        &quot;double&quot; -&gt; return@map 0.0
</a><a href="#h29-0-84" id="h29-0-84" class="i">+                    }
</a><a href="#h29-0-85" id="h29-0-85" class="i">+                }
</a><a href="#h29-0-86" id="h29-0-86" class="i">+                null
</a><a href="#h29-0-87" id="h29-0-87" class="i">+            }.toTypedArray()
</a><a href="#h29-0-88" id="h29-0-88" class="i">+            return constructor.newInstance(*args)
</a><a href="#h29-0-89" id="h29-0-89" class="i">+        }
</a><a href="#h29-0-90" id="h29-0-90" class="i">+
</a><a href="#h29-0-91" id="h29-0-91" class="i">+    }
</a><a href="#h29-0-92" id="h29-0-92" class="i">+}</a><a href="#h29-0-93" id="h29-0-93" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h30" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/util/ReflectionHelper.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/util/ReflectionHelper.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/util/ReflectionHelper.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/util/ReflectionHelper.kt</a></b>
<a href="#h30-0" id="h30-0" class="h">@@ -0,0 +1,119 @@
</a><a href="#h30-0-0" id="h30-0-0" class="i">+package me.rhunk.snapenhance.core.util
</a><a href="#h30-0-1" id="h30-0-1" class="i">+
</a><a href="#h30-0-2" id="h30-0-2" class="i">+import java.lang.reflect.Field
</a><a href="#h30-0-3" id="h30-0-3" class="i">+import java.lang.reflect.Method
</a><a href="#h30-0-4" id="h30-0-4" class="i">+import java.util.Arrays
</a><a href="#h30-0-5" id="h30-0-5" class="i">+import java.util.Objects
</a><a href="#h30-0-6" id="h30-0-6" class="i">+
</a><a href="#h30-0-7" id="h30-0-7" class="i">+object ReflectionHelper {
</a><a href="#h30-0-8" id="h30-0-8" class="i">+    /**
</a><a href="#h30-0-9" id="h30-0-9" class="i">+     * Searches for a field with a class that has a method with the specified name
</a><a href="#h30-0-10" id="h30-0-10" class="i">+     */
</a><a href="#h30-0-11" id="h30-0-11" class="i">+    fun searchFieldWithClassMethod(clazz: Class&lt;*&gt;, methodName: String): Field? {
</a><a href="#h30-0-12" id="h30-0-12" class="i">+        return clazz.declaredFields.firstOrNull { f: Field? -&gt;
</a><a href="#h30-0-13" id="h30-0-13" class="i">+            try {
</a><a href="#h30-0-14" id="h30-0-14" class="i">+                return@firstOrNull Arrays.stream(
</a><a href="#h30-0-15" id="h30-0-15" class="i">+                    f!!.type.declaredMethods
</a><a href="#h30-0-16" id="h30-0-16" class="i">+                ).anyMatch { method: Method -&gt; method.name == methodName }
</a><a href="#h30-0-17" id="h30-0-17" class="i">+            } catch (e: Exception) {
</a><a href="#h30-0-18" id="h30-0-18" class="i">+                return@firstOrNull false
</a><a href="#h30-0-19" id="h30-0-19" class="i">+            }
</a><a href="#h30-0-20" id="h30-0-20" class="i">+        }
</a><a href="#h30-0-21" id="h30-0-21" class="i">+    }
</a><a href="#h30-0-22" id="h30-0-22" class="i">+
</a><a href="#h30-0-23" id="h30-0-23" class="i">+    fun searchFieldByType(clazz: Class&lt;*&gt;, type: Class&lt;*&gt;): Field? {
</a><a href="#h30-0-24" id="h30-0-24" class="i">+        return clazz.declaredFields.firstOrNull { f: Field? -&gt; f!!.type == type }
</a><a href="#h30-0-25" id="h30-0-25" class="i">+    }
</a><a href="#h30-0-26" id="h30-0-26" class="i">+
</a><a href="#h30-0-27" id="h30-0-27" class="i">+    fun searchFieldTypeInSuperClasses(clazz: Class&lt;*&gt;, type: Class&lt;*&gt;): Field? {
</a><a href="#h30-0-28" id="h30-0-28" class="i">+        val field = searchFieldByType(clazz, type)
</a><a href="#h30-0-29" id="h30-0-29" class="i">+        if (field != null) {
</a><a href="#h30-0-30" id="h30-0-30" class="i">+            return field
</a><a href="#h30-0-31" id="h30-0-31" class="i">+        }
</a><a href="#h30-0-32" id="h30-0-32" class="i">+        val superclass = clazz.superclass
</a><a href="#h30-0-33" id="h30-0-33" class="i">+        return superclass?.let { searchFieldTypeInSuperClasses(it, type) }
</a><a href="#h30-0-34" id="h30-0-34" class="i">+    }
</a><a href="#h30-0-35" id="h30-0-35" class="i">+
</a><a href="#h30-0-36" id="h30-0-36" class="i">+    fun searchFieldStartsWithToString(
</a><a href="#h30-0-37" id="h30-0-37" class="i">+        clazz: Class&lt;*&gt;,
</a><a href="#h30-0-38" id="h30-0-38" class="i">+        instance: Any,
</a><a href="#h30-0-39" id="h30-0-39" class="i">+        toString: String?
</a><a href="#h30-0-40" id="h30-0-40" class="i">+    ): Field? {
</a><a href="#h30-0-41" id="h30-0-41" class="i">+        return clazz.declaredFields.firstOrNull { f: Field -&gt;
</a><a href="#h30-0-42" id="h30-0-42" class="i">+            try {
</a><a href="#h30-0-43" id="h30-0-43" class="i">+                f.isAccessible = true
</a><a href="#h30-0-44" id="h30-0-44" class="i">+                return@firstOrNull Objects.requireNonNull(f[instance]).toString()
</a><a href="#h30-0-45" id="h30-0-45" class="i">+                    .startsWith(
</a><a href="#h30-0-46" id="h30-0-46" class="i">+                        toString!!
</a><a href="#h30-0-47" id="h30-0-47" class="i">+                    )
</a><a href="#h30-0-48" id="h30-0-48" class="i">+            } catch (e: Throwable) {
</a><a href="#h30-0-49" id="h30-0-49" class="i">+                return@firstOrNull false
</a><a href="#h30-0-50" id="h30-0-50" class="i">+            }
</a><a href="#h30-0-51" id="h30-0-51" class="i">+        }
</a><a href="#h30-0-52" id="h30-0-52" class="i">+    }
</a><a href="#h30-0-53" id="h30-0-53" class="i">+
</a><a href="#h30-0-54" id="h30-0-54" class="i">+
</a><a href="#h30-0-55" id="h30-0-55" class="i">+    fun searchFieldContainsToString(
</a><a href="#h30-0-56" id="h30-0-56" class="i">+        clazz: Class&lt;*&gt;,
</a><a href="#h30-0-57" id="h30-0-57" class="i">+        instance: Any?,
</a><a href="#h30-0-58" id="h30-0-58" class="i">+        toString: String?
</a><a href="#h30-0-59" id="h30-0-59" class="i">+    ): Field? {
</a><a href="#h30-0-60" id="h30-0-60" class="i">+        return clazz.declaredFields.firstOrNull { f: Field -&gt;
</a><a href="#h30-0-61" id="h30-0-61" class="i">+            try {
</a><a href="#h30-0-62" id="h30-0-62" class="i">+                f.isAccessible = true
</a><a href="#h30-0-63" id="h30-0-63" class="i">+                return@firstOrNull Objects.requireNonNull(f[instance]).toString()
</a><a href="#h30-0-64" id="h30-0-64" class="i">+                    .contains(toString!!)
</a><a href="#h30-0-65" id="h30-0-65" class="i">+            } catch (e: Throwable) {
</a><a href="#h30-0-66" id="h30-0-66" class="i">+                return@firstOrNull false
</a><a href="#h30-0-67" id="h30-0-67" class="i">+            }
</a><a href="#h30-0-68" id="h30-0-68" class="i">+        }
</a><a href="#h30-0-69" id="h30-0-69" class="i">+    }
</a><a href="#h30-0-70" id="h30-0-70" class="i">+
</a><a href="#h30-0-71" id="h30-0-71" class="i">+    fun searchFirstFieldTypeInClassRecursive(clazz: Class&lt;*&gt;, type: Class&lt;*&gt;): Field? {
</a><a href="#h30-0-72" id="h30-0-72" class="i">+        return clazz.declaredFields.firstOrNull {
</a><a href="#h30-0-73" id="h30-0-73" class="i">+            val field = searchFieldByType(it.type, type)
</a><a href="#h30-0-74" id="h30-0-74" class="i">+            return@firstOrNull field != null
</a><a href="#h30-0-75" id="h30-0-75" class="i">+        }
</a><a href="#h30-0-76" id="h30-0-76" class="i">+    }
</a><a href="#h30-0-77" id="h30-0-77" class="i">+
</a><a href="#h30-0-78" id="h30-0-78" class="i">+    /**
</a><a href="#h30-0-79" id="h30-0-79" class="i">+     * Searches for a field with a class that has a method with the specified return type
</a><a href="#h30-0-80" id="h30-0-80" class="i">+     */
</a><a href="#h30-0-81" id="h30-0-81" class="i">+    fun searchMethodWithReturnType(clazz: Class&lt;*&gt;, returnType: Class&lt;*&gt;): Method? {
</a><a href="#h30-0-82" id="h30-0-82" class="i">+        return clazz.declaredMethods.first { m: Method -&gt; m.returnType == returnType }
</a><a href="#h30-0-83" id="h30-0-83" class="i">+    }
</a><a href="#h30-0-84" id="h30-0-84" class="i">+
</a><a href="#h30-0-85" id="h30-0-85" class="i">+    /**
</a><a href="#h30-0-86" id="h30-0-86" class="i">+     * Searches for a field with a class that has a method with the specified return type and parameter types
</a><a href="#h30-0-87" id="h30-0-87" class="i">+     */
</a><a href="#h30-0-88" id="h30-0-88" class="i">+    fun searchMethodWithParameterAndReturnType(
</a><a href="#h30-0-89" id="h30-0-89" class="i">+        aClass: Class&lt;*&gt;,
</a><a href="#h30-0-90" id="h30-0-90" class="i">+        returnType: Class&lt;*&gt;,
</a><a href="#h30-0-91" id="h30-0-91" class="i">+        vararg parameters: Class&lt;*&gt;
</a><a href="#h30-0-92" id="h30-0-92" class="i">+    ): Method? {
</a><a href="#h30-0-93" id="h30-0-93" class="i">+        return aClass.declaredMethods.firstOrNull { m: Method -&gt;
</a><a href="#h30-0-94" id="h30-0-94" class="i">+            if (m.returnType != returnType) {
</a><a href="#h30-0-95" id="h30-0-95" class="i">+                return@firstOrNull false
</a><a href="#h30-0-96" id="h30-0-96" class="i">+            }
</a><a href="#h30-0-97" id="h30-0-97" class="i">+            val parameterTypes = m.parameterTypes
</a><a href="#h30-0-98" id="h30-0-98" class="i">+            if (parameterTypes.size != parameters.size) {
</a><a href="#h30-0-99" id="h30-0-99" class="i">+                return@firstOrNull false
</a><a href="#h30-0-100" id="h30-0-100" class="i">+            }
</a><a href="#h30-0-101" id="h30-0-101" class="i">+            for (i in parameterTypes.indices) {
</a><a href="#h30-0-102" id="h30-0-102" class="i">+                if (parameterTypes[i] != parameters[i]) {
</a><a href="#h30-0-103" id="h30-0-103" class="i">+                    return@firstOrNull false
</a><a href="#h30-0-104" id="h30-0-104" class="i">+                }
</a><a href="#h30-0-105" id="h30-0-105" class="i">+            }
</a><a href="#h30-0-106" id="h30-0-106" class="i">+            true
</a><a href="#h30-0-107" id="h30-0-107" class="i">+        }
</a><a href="#h30-0-108" id="h30-0-108" class="i">+    }
</a><a href="#h30-0-109" id="h30-0-109" class="i">+
</a><a href="#h30-0-110" id="h30-0-110" class="i">+    fun getDeclaredFieldsRecursively(clazz: Class&lt;*&gt;): List&lt;Field&gt; {
</a><a href="#h30-0-111" id="h30-0-111" class="i">+        val fields = clazz.declaredFields.toMutableList()
</a><a href="#h30-0-112" id="h30-0-112" class="i">+        val superclass = clazz.superclass
</a><a href="#h30-0-113" id="h30-0-113" class="i">+        if (superclass != null) {
</a><a href="#h30-0-114" id="h30-0-114" class="i">+            fields.addAll(getDeclaredFieldsRecursively(superclass))
</a><a href="#h30-0-115" id="h30-0-115" class="i">+        }
</a><a href="#h30-0-116" id="h30-0-116" class="i">+        return fields
</a><a href="#h30-0-117" id="h30-0-117" class="i">+    }
</a><a href="#h30-0-118" id="h30-0-118" class="i">+}</a><a href="#h30-0-119" id="h30-0-119" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h31" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/util/SQLiteDatabaseHelper.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/util/SQLiteDatabaseHelper.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/util/SQLiteDatabaseHelper.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/util/SQLiteDatabaseHelper.kt</a></b>
<a href="#h31-0" id="h31-0" class="h">@@ -0,0 +1,31 @@
</a><a href="#h31-0-0" id="h31-0-0" class="i">+package me.rhunk.snapenhance.core.util
</a><a href="#h31-0-1" id="h31-0-1" class="i">+
</a><a href="#h31-0-2" id="h31-0-2" class="i">+import android.annotation.SuppressLint
</a><a href="#h31-0-3" id="h31-0-3" class="i">+import android.database.sqlite.SQLiteDatabase
</a><a href="#h31-0-4" id="h31-0-4" class="i">+import me.rhunk.snapenhance.core.Logger
</a><a href="#h31-0-5" id="h31-0-5" class="i">+
</a><a href="#h31-0-6" id="h31-0-6" class="i">+object SQLiteDatabaseHelper {
</a><a href="#h31-0-7" id="h31-0-7" class="i">+    @SuppressLint(&quot;Range&quot;)
</a><a href="#h31-0-8" id="h31-0-8" class="i">+    fun createTablesFromSchema(sqLiteDatabase: SQLiteDatabase, databaseSchema: Map&lt;String, List&lt;String&gt;&gt;) {
</a><a href="#h31-0-9" id="h31-0-9" class="i">+        databaseSchema.forEach { (tableName, columns) -&gt;
</a><a href="#h31-0-10" id="h31-0-10" class="i">+            sqLiteDatabase.execSQL(&quot;CREATE TABLE IF NOT EXISTS $tableName (${columns.joinToString(&quot;, &quot;)})&quot;)
</a><a href="#h31-0-11" id="h31-0-11" class="i">+
</a><a href="#h31-0-12" id="h31-0-12" class="i">+            val cursor = sqLiteDatabase.rawQuery(&quot;PRAGMA table_info($tableName)&quot;, null)
</a><a href="#h31-0-13" id="h31-0-13" class="i">+            val existingColumns = mutableListOf&lt;String&gt;()
</a><a href="#h31-0-14" id="h31-0-14" class="i">+            while (cursor.moveToNext()) {
</a><a href="#h31-0-15" id="h31-0-15" class="i">+                existingColumns.add(cursor.getString(cursor.getColumnIndex(&quot;name&quot;)) + &quot; &quot; + cursor.getString(cursor.getColumnIndex(&quot;type&quot;)))
</a><a href="#h31-0-16" id="h31-0-16" class="i">+            }
</a><a href="#h31-0-17" id="h31-0-17" class="i">+            cursor.close()
</a><a href="#h31-0-18" id="h31-0-18" class="i">+
</a><a href="#h31-0-19" id="h31-0-19" class="i">+            val newColumns = columns.filter {
</a><a href="#h31-0-20" id="h31-0-20" class="i">+                existingColumns.none { existingColumn -&gt; it.startsWith(existingColumn) }
</a><a href="#h31-0-21" id="h31-0-21" class="i">+            }
</a><a href="#h31-0-22" id="h31-0-22" class="i">+
</a><a href="#h31-0-23" id="h31-0-23" class="i">+            if (newColumns.isEmpty()) return@forEach
</a><a href="#h31-0-24" id="h31-0-24" class="i">+
</a><a href="#h31-0-25" id="h31-0-25" class="i">+            Logger.directDebug(&quot;Schema for table $tableName has changed&quot;)
</a><a href="#h31-0-26" id="h31-0-26" class="i">+            sqLiteDatabase.execSQL(&quot;DROP TABLE $tableName&quot;)
</a><a href="#h31-0-27" id="h31-0-27" class="i">+            sqLiteDatabase.execSQL(&quot;CREATE TABLE IF NOT EXISTS $tableName (${columns.joinToString(&quot;, &quot;)})&quot;)
</a><a href="#h31-0-28" id="h31-0-28" class="i">+        }
</a><a href="#h31-0-29" id="h31-0-29" class="i">+    }
</a><a href="#h31-0-30" id="h31-0-30" class="i">+}</a><a href="#h31-0-31" id="h31-0-31" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h32" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/util/SerializableDataObject.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/util/SerializableDataObject.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/util/SerializableDataObject.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/util/SerializableDataObject.kt</a></b>
<a href="#h32-0" id="h32-0" class="h">@@ -0,0 +1,22 @@
</a><a href="#h32-0-0" id="h32-0-0" class="i">+package me.rhunk.snapenhance.core.util
</a><a href="#h32-0-1" id="h32-0-1" class="i">+
</a><a href="#h32-0-2" id="h32-0-2" class="i">+import com.google.gson.Gson
</a><a href="#h32-0-3" id="h32-0-3" class="i">+import com.google.gson.GsonBuilder
</a><a href="#h32-0-4" id="h32-0-4" class="i">+
</a><a href="#h32-0-5" id="h32-0-5" class="i">+open class SerializableDataObject {
</a><a href="#h32-0-6" id="h32-0-6" class="i">+    companion object {
</a><a href="#h32-0-7" id="h32-0-7" class="i">+        val gson: Gson = GsonBuilder().create()
</a><a href="#h32-0-8" id="h32-0-8" class="i">+
</a><a href="#h32-0-9" id="h32-0-9" class="i">+        inline fun &lt;reified T : SerializableDataObject&gt; fromJson(json: String): T {
</a><a href="#h32-0-10" id="h32-0-10" class="i">+            return gson.fromJson(json, T::class.java)
</a><a href="#h32-0-11" id="h32-0-11" class="i">+        }
</a><a href="#h32-0-12" id="h32-0-12" class="i">+
</a><a href="#h32-0-13" id="h32-0-13" class="i">+        inline fun &lt;reified T : SerializableDataObject&gt; fromJson(json: String, type: Class&lt;T&gt;): T {
</a><a href="#h32-0-14" id="h32-0-14" class="i">+            return gson.fromJson(json, type)
</a><a href="#h32-0-15" id="h32-0-15" class="i">+        }
</a><a href="#h32-0-16" id="h32-0-16" class="i">+    }
</a><a href="#h32-0-17" id="h32-0-17" class="i">+
</a><a href="#h32-0-18" id="h32-0-18" class="i">+    fun toJson(): String {
</a><a href="#h32-0-19" id="h32-0-19" class="i">+        return gson.toJson(this)
</a><a href="#h32-0-20" id="h32-0-20" class="i">+    }
</a><a href="#h32-0-21" id="h32-0-21" class="i">+}</a><a href="#h32-0-22" id="h32-0-22" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h33" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/util/download/HttpServer.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/util/download/HttpServer.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/util/download/HttpServer.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/util/download/HttpServer.kt</a></b>
<a href="#h33-0" id="h33-0" class="h">@@ -0,0 +1,139 @@
</a><a href="#h33-0-0" id="h33-0-0" class="i">+package me.rhunk.snapenhance.core.util.download
</a><a href="#h33-0-1" id="h33-0-1" class="i">+
</a><a href="#h33-0-2" id="h33-0-2" class="i">+import kotlinx.coroutines.CoroutineScope
</a><a href="#h33-0-3" id="h33-0-3" class="i">+import kotlinx.coroutines.Dispatchers
</a><a href="#h33-0-4" id="h33-0-4" class="i">+import kotlinx.coroutines.Job
</a><a href="#h33-0-5" id="h33-0-5" class="i">+import kotlinx.coroutines.delay
</a><a href="#h33-0-6" id="h33-0-6" class="i">+import kotlinx.coroutines.launch
</a><a href="#h33-0-7" id="h33-0-7" class="i">+import me.rhunk.snapenhance.core.Logger
</a><a href="#h33-0-8" id="h33-0-8" class="i">+import java.io.BufferedReader
</a><a href="#h33-0-9" id="h33-0-9" class="i">+import java.io.InputStream
</a><a href="#h33-0-10" id="h33-0-10" class="i">+import java.io.InputStreamReader
</a><a href="#h33-0-11" id="h33-0-11" class="i">+import java.io.PrintWriter
</a><a href="#h33-0-12" id="h33-0-12" class="i">+import java.net.ServerSocket
</a><a href="#h33-0-13" id="h33-0-13" class="i">+import java.net.Socket
</a><a href="#h33-0-14" id="h33-0-14" class="i">+import java.net.SocketException
</a><a href="#h33-0-15" id="h33-0-15" class="i">+import java.util.Locale
</a><a href="#h33-0-16" id="h33-0-16" class="i">+import java.util.StringTokenizer
</a><a href="#h33-0-17" id="h33-0-17" class="i">+import java.util.concurrent.ConcurrentHashMap
</a><a href="#h33-0-18" id="h33-0-18" class="i">+import kotlin.random.Random
</a><a href="#h33-0-19" id="h33-0-19" class="i">+
</a><a href="#h33-0-20" id="h33-0-20" class="i">+class HttpServer(
</a><a href="#h33-0-21" id="h33-0-21" class="i">+    private val timeout: Int = 10000
</a><a href="#h33-0-22" id="h33-0-22" class="i">+) {
</a><a href="#h33-0-23" id="h33-0-23" class="i">+    val port = Random.nextInt(10000, 65535)
</a><a href="#h33-0-24" id="h33-0-24" class="i">+
</a><a href="#h33-0-25" id="h33-0-25" class="i">+    private val coroutineScope = CoroutineScope(Dispatchers.IO)
</a><a href="#h33-0-26" id="h33-0-26" class="i">+    private var timeoutJob: Job? = null
</a><a href="#h33-0-27" id="h33-0-27" class="i">+    private var socketJob: Job? = null
</a><a href="#h33-0-28" id="h33-0-28" class="i">+
</a><a href="#h33-0-29" id="h33-0-29" class="i">+    private val cachedData = ConcurrentHashMap&lt;String, Pair&lt;InputStream, Long&gt;&gt;()
</a><a href="#h33-0-30" id="h33-0-30" class="i">+    private var serverSocket: ServerSocket? = null
</a><a href="#h33-0-31" id="h33-0-31" class="i">+
</a><a href="#h33-0-32" id="h33-0-32" class="i">+    fun ensureServerStarted(callback: HttpServer.() -&gt; Unit) {
</a><a href="#h33-0-33" id="h33-0-33" class="i">+        if (serverSocket != null &amp;&amp; !serverSocket!!.isClosed) {
</a><a href="#h33-0-34" id="h33-0-34" class="i">+            callback(this)
</a><a href="#h33-0-35" id="h33-0-35" class="i">+            return
</a><a href="#h33-0-36" id="h33-0-36" class="i">+        }
</a><a href="#h33-0-37" id="h33-0-37" class="i">+
</a><a href="#h33-0-38" id="h33-0-38" class="i">+        coroutineScope.launch(Dispatchers.IO) {
</a><a href="#h33-0-39" id="h33-0-39" class="i">+            Logger.directDebug(&quot;starting http server on port $port&quot;)
</a><a href="#h33-0-40" id="h33-0-40" class="i">+            serverSocket = ServerSocket(port)
</a><a href="#h33-0-41" id="h33-0-41" class="i">+            callback(this@HttpServer)
</a><a href="#h33-0-42" id="h33-0-42" class="i">+            while (!serverSocket!!.isClosed) {
</a><a href="#h33-0-43" id="h33-0-43" class="i">+                try {
</a><a href="#h33-0-44" id="h33-0-44" class="i">+                    val socket = serverSocket!!.accept()
</a><a href="#h33-0-45" id="h33-0-45" class="i">+                    timeoutJob?.cancel()
</a><a href="#h33-0-46" id="h33-0-46" class="i">+                    launch {
</a><a href="#h33-0-47" id="h33-0-47" class="i">+                        handleRequest(socket)
</a><a href="#h33-0-48" id="h33-0-48" class="i">+                        timeoutJob = launch {
</a><a href="#h33-0-49" id="h33-0-49" class="i">+                            delay(timeout.toLong())
</a><a href="#h33-0-50" id="h33-0-50" class="i">+                            Logger.directDebug(&quot;http server closed due to timeout&quot;)
</a><a href="#h33-0-51" id="h33-0-51" class="i">+                            runCatching {
</a><a href="#h33-0-52" id="h33-0-52" class="i">+                                socketJob?.cancel()
</a><a href="#h33-0-53" id="h33-0-53" class="i">+                                socket.close()
</a><a href="#h33-0-54" id="h33-0-54" class="i">+                                serverSocket?.close()
</a><a href="#h33-0-55" id="h33-0-55" class="i">+                            }.onFailure {
</a><a href="#h33-0-56" id="h33-0-56" class="i">+                                Logger.directError(&quot;failed to close socket&quot;, it)
</a><a href="#h33-0-57" id="h33-0-57" class="i">+                            }
</a><a href="#h33-0-58" id="h33-0-58" class="i">+                        }
</a><a href="#h33-0-59" id="h33-0-59" class="i">+                    }
</a><a href="#h33-0-60" id="h33-0-60" class="i">+                } catch (e: SocketException) {
</a><a href="#h33-0-61" id="h33-0-61" class="i">+                    Logger.directDebug(&quot;http server timed out&quot;)
</a><a href="#h33-0-62" id="h33-0-62" class="i">+                    break;
</a><a href="#h33-0-63" id="h33-0-63" class="i">+                } catch (e: Throwable) {
</a><a href="#h33-0-64" id="h33-0-64" class="i">+                    Logger.directError(&quot;failed to handle request&quot;, e)
</a><a href="#h33-0-65" id="h33-0-65" class="i">+                }
</a><a href="#h33-0-66" id="h33-0-66" class="i">+            }
</a><a href="#h33-0-67" id="h33-0-67" class="i">+        }.also { socketJob = it }
</a><a href="#h33-0-68" id="h33-0-68" class="i">+    }
</a><a href="#h33-0-69" id="h33-0-69" class="i">+
</a><a href="#h33-0-70" id="h33-0-70" class="i">+    fun close() {
</a><a href="#h33-0-71" id="h33-0-71" class="i">+        serverSocket?.close()
</a><a href="#h33-0-72" id="h33-0-72" class="i">+    }
</a><a href="#h33-0-73" id="h33-0-73" class="i">+
</a><a href="#h33-0-74" id="h33-0-74" class="i">+    fun putDownloadableContent(inputStream: InputStream, size: Long): String {
</a><a href="#h33-0-75" id="h33-0-75" class="i">+        val key = System.nanoTime().toString(16)
</a><a href="#h33-0-76" id="h33-0-76" class="i">+        cachedData[key] = inputStream to size
</a><a href="#h33-0-77" id="h33-0-77" class="i">+        return &quot;http://127.0.0.1:$port/$key&quot;
</a><a href="#h33-0-78" id="h33-0-78" class="i">+    }
</a><a href="#h33-0-79" id="h33-0-79" class="i">+
</a><a href="#h33-0-80" id="h33-0-80" class="i">+    private fun handleRequest(socket: Socket) {
</a><a href="#h33-0-81" id="h33-0-81" class="i">+        val reader = BufferedReader(InputStreamReader(socket.getInputStream()))
</a><a href="#h33-0-82" id="h33-0-82" class="i">+        val outputStream = socket.getOutputStream()
</a><a href="#h33-0-83" id="h33-0-83" class="i">+        val writer = PrintWriter(outputStream)
</a><a href="#h33-0-84" id="h33-0-84" class="i">+        val line = reader.readLine() ?: return
</a><a href="#h33-0-85" id="h33-0-85" class="i">+        fun close() {
</a><a href="#h33-0-86" id="h33-0-86" class="i">+            runCatching {
</a><a href="#h33-0-87" id="h33-0-87" class="i">+                reader.close()
</a><a href="#h33-0-88" id="h33-0-88" class="i">+                writer.close()
</a><a href="#h33-0-89" id="h33-0-89" class="i">+                outputStream.close()
</a><a href="#h33-0-90" id="h33-0-90" class="i">+                socket.close()
</a><a href="#h33-0-91" id="h33-0-91" class="i">+            }.onFailure {
</a><a href="#h33-0-92" id="h33-0-92" class="i">+                Logger.directError(&quot;failed to close socket&quot;, it)
</a><a href="#h33-0-93" id="h33-0-93" class="i">+            }
</a><a href="#h33-0-94" id="h33-0-94" class="i">+        }
</a><a href="#h33-0-95" id="h33-0-95" class="i">+        val parse = StringTokenizer(line)
</a><a href="#h33-0-96" id="h33-0-96" class="i">+        val method = parse.nextToken().uppercase(Locale.getDefault())
</a><a href="#h33-0-97" id="h33-0-97" class="i">+        var fileRequested = parse.nextToken().lowercase(Locale.getDefault())
</a><a href="#h33-0-98" id="h33-0-98" class="i">+        Logger.directDebug(&quot;[http-server:${port}] $method $fileRequested&quot;)
</a><a href="#h33-0-99" id="h33-0-99" class="i">+
</a><a href="#h33-0-100" id="h33-0-100" class="i">+        if (method != &quot;GET&quot;) {
</a><a href="#h33-0-101" id="h33-0-101" class="i">+            with(writer) {
</a><a href="#h33-0-102" id="h33-0-102" class="i">+                println(&quot;HTTP/1.1 501 Not Implemented&quot;)
</a><a href="#h33-0-103" id="h33-0-103" class="i">+                println(&quot;Content-type: &quot; + &quot;application/octet-stream&quot;)
</a><a href="#h33-0-104" id="h33-0-104" class="i">+                println(&quot;Content-length: &quot; + 0)
</a><a href="#h33-0-105" id="h33-0-105" class="i">+                println()
</a><a href="#h33-0-106" id="h33-0-106" class="i">+                flush()
</a><a href="#h33-0-107" id="h33-0-107" class="i">+            }
</a><a href="#h33-0-108" id="h33-0-108" class="i">+            close()
</a><a href="#h33-0-109" id="h33-0-109" class="i">+            return
</a><a href="#h33-0-110" id="h33-0-110" class="i">+        }
</a><a href="#h33-0-111" id="h33-0-111" class="i">+        if (fileRequested.startsWith(&quot;/&quot;)) {
</a><a href="#h33-0-112" id="h33-0-112" class="i">+            fileRequested = fileRequested.substring(1)
</a><a href="#h33-0-113" id="h33-0-113" class="i">+        }
</a><a href="#h33-0-114" id="h33-0-114" class="i">+        if (!cachedData.containsKey(fileRequested)) {
</a><a href="#h33-0-115" id="h33-0-115" class="i">+            with(writer) {
</a><a href="#h33-0-116" id="h33-0-116" class="i">+                println(&quot;HTTP/1.1 404 Not Found&quot;)
</a><a href="#h33-0-117" id="h33-0-117" class="i">+                println(&quot;Content-type: &quot; + &quot;application/octet-stream&quot;)
</a><a href="#h33-0-118" id="h33-0-118" class="i">+                println(&quot;Content-length: &quot; + 0)
</a><a href="#h33-0-119" id="h33-0-119" class="i">+                println()
</a><a href="#h33-0-120" id="h33-0-120" class="i">+                flush()
</a><a href="#h33-0-121" id="h33-0-121" class="i">+            }
</a><a href="#h33-0-122" id="h33-0-122" class="i">+            close()
</a><a href="#h33-0-123" id="h33-0-123" class="i">+            return
</a><a href="#h33-0-124" id="h33-0-124" class="i">+        }
</a><a href="#h33-0-125" id="h33-0-125" class="i">+        val requestedData = cachedData[fileRequested]!!
</a><a href="#h33-0-126" id="h33-0-126" class="i">+        with(writer) {
</a><a href="#h33-0-127" id="h33-0-127" class="i">+            println(&quot;HTTP/1.1 200 OK&quot;)
</a><a href="#h33-0-128" id="h33-0-128" class="i">+            println(&quot;Content-type: &quot; + &quot;application/octet-stream&quot;)
</a><a href="#h33-0-129" id="h33-0-129" class="i">+            println(&quot;Content-length: &quot; + requestedData.second)
</a><a href="#h33-0-130" id="h33-0-130" class="i">+            println()
</a><a href="#h33-0-131" id="h33-0-131" class="i">+            flush()
</a><a href="#h33-0-132" id="h33-0-132" class="i">+        }
</a><a href="#h33-0-133" id="h33-0-133" class="i">+        requestedData.first.copyTo(outputStream)
</a><a href="#h33-0-134" id="h33-0-134" class="i">+        outputStream.flush()
</a><a href="#h33-0-135" id="h33-0-135" class="i">+        cachedData.remove(fileRequested)
</a><a href="#h33-0-136" id="h33-0-136" class="i">+        close()
</a><a href="#h33-0-137" id="h33-0-137" class="i">+    }
</a><a href="#h33-0-138" id="h33-0-138" class="i">+}</a><a href="#h33-0-139" id="h33-0-139" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h34" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/util/download/RemoteMediaResolver.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/util/download/RemoteMediaResolver.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/util/download/RemoteMediaResolver.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/util/download/RemoteMediaResolver.kt</a></b>
<a href="#h34-0" id="h34-0" class="h">@@ -0,0 +1,53 @@
</a><a href="#h34-0-0" id="h34-0-0" class="i">+package me.rhunk.snapenhance.core.util.download
</a><a href="#h34-0-1" id="h34-0-1" class="i">+
</a><a href="#h34-0-2" id="h34-0-2" class="i">+import me.rhunk.snapenhance.Constants
</a><a href="#h34-0-3" id="h34-0-3" class="i">+import me.rhunk.snapenhance.core.Logger
</a><a href="#h34-0-4" id="h34-0-4" class="i">+import okhttp3.OkHttpClient
</a><a href="#h34-0-5" id="h34-0-5" class="i">+import okhttp3.Request
</a><a href="#h34-0-6" id="h34-0-6" class="i">+import java.io.ByteArrayInputStream
</a><a href="#h34-0-7" id="h34-0-7" class="i">+import java.io.InputStream
</a><a href="#h34-0-8" id="h34-0-8" class="i">+import java.util.Base64
</a><a href="#h34-0-9" id="h34-0-9" class="i">+
</a><a href="#h34-0-10" id="h34-0-10" class="i">+object RemoteMediaResolver {
</a><a href="#h34-0-11" id="h34-0-11" class="i">+    private const val BOLT_HTTP_RESOLVER_URL = &quot;https://aws.api.snapchat.com/bolt-http&quot;
</a><a href="#h34-0-12" id="h34-0-12" class="i">+    const val CF_ST_CDN_D = &quot;https://cf-st.sc-cdn.net/d/&quot;
</a><a href="#h34-0-13" id="h34-0-13" class="i">+
</a><a href="#h34-0-14" id="h34-0-14" class="i">+    private val urlCache = mutableMapOf&lt;String, String&gt;()
</a><a href="#h34-0-15" id="h34-0-15" class="i">+
</a><a href="#h34-0-16" id="h34-0-16" class="i">+    private val okHttpClient = OkHttpClient.Builder()
</a><a href="#h34-0-17" id="h34-0-17" class="i">+        .followRedirects(true)
</a><a href="#h34-0-18" id="h34-0-18" class="i">+        .retryOnConnectionFailure(true)
</a><a href="#h34-0-19" id="h34-0-19" class="i">+        .readTimeout(20, java.util.concurrent.TimeUnit.SECONDS)
</a><a href="#h34-0-20" id="h34-0-20" class="i">+        .addInterceptor { chain -&gt;
</a><a href="#h34-0-21" id="h34-0-21" class="i">+            val request = chain.request()
</a><a href="#h34-0-22" id="h34-0-22" class="i">+            val requestUrl = request.url.toString()
</a><a href="#h34-0-23" id="h34-0-23" class="i">+
</a><a href="#h34-0-24" id="h34-0-24" class="i">+            if (urlCache.containsKey(requestUrl)) {
</a><a href="#h34-0-25" id="h34-0-25" class="i">+                val cachedUrl = urlCache[requestUrl]!!
</a><a href="#h34-0-26" id="h34-0-26" class="i">+                return@addInterceptor chain.proceed(request.newBuilder().url(cachedUrl).build())
</a><a href="#h34-0-27" id="h34-0-27" class="i">+            }
</a><a href="#h34-0-28" id="h34-0-28" class="i">+
</a><a href="#h34-0-29" id="h34-0-29" class="i">+            chain.proceed(request).apply {
</a><a href="#h34-0-30" id="h34-0-30" class="i">+                val responseUrl = this.request.url.toString()
</a><a href="#h34-0-31" id="h34-0-31" class="i">+                if (responseUrl.startsWith(&quot;https://cf-st.sc-cdn.net&quot;)) {
</a><a href="#h34-0-32" id="h34-0-32" class="i">+                    urlCache[requestUrl] = responseUrl
</a><a href="#h34-0-33" id="h34-0-33" class="i">+                }
</a><a href="#h34-0-34" id="h34-0-34" class="i">+            }
</a><a href="#h34-0-35" id="h34-0-35" class="i">+        }
</a><a href="#h34-0-36" id="h34-0-36" class="i">+        .build()
</a><a href="#h34-0-37" id="h34-0-37" class="i">+
</a><a href="#h34-0-38" id="h34-0-38" class="i">+    fun downloadBoltMedia(protoKey: ByteArray): InputStream? {
</a><a href="#h34-0-39" id="h34-0-39" class="i">+        val request = Request.Builder()
</a><a href="#h34-0-40" id="h34-0-40" class="i">+            .url(BOLT_HTTP_RESOLVER_URL + &quot;/resolve?co=&quot; + Base64.getUrlEncoder().encodeToString(protoKey))
</a><a href="#h34-0-41" id="h34-0-41" class="i">+            .addHeader(&quot;User-Agent&quot;, Constants.USER_AGENT)
</a><a href="#h34-0-42" id="h34-0-42" class="i">+            .build()
</a><a href="#h34-0-43" id="h34-0-43" class="i">+
</a><a href="#h34-0-44" id="h34-0-44" class="i">+        okHttpClient.newCall(request).execute().use { response -&gt;
</a><a href="#h34-0-45" id="h34-0-45" class="i">+            if (!response.isSuccessful) {
</a><a href="#h34-0-46" id="h34-0-46" class="i">+                Logger.directDebug(&quot;Unexpected code $response&quot;)
</a><a href="#h34-0-47" id="h34-0-47" class="i">+                return null
</a><a href="#h34-0-48" id="h34-0-48" class="i">+            }
</a><a href="#h34-0-49" id="h34-0-49" class="i">+            return ByteArrayInputStream(response.body.bytes())
</a><a href="#h34-0-50" id="h34-0-50" class="i">+        }
</a><a href="#h34-0-51" id="h34-0-51" class="i">+    }
</a><a href="#h34-0-52" id="h34-0-52" class="i">+}
</a><b>diff --git a/<a id="h35" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/util/export/MessageExporter.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/util/export/MessageExporter.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/util/export/MessageExporter.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/util/export/MessageExporter.kt</a></b>
<a href="#h35-0" id="h35-0" class="h">@@ -0,0 +1,342 @@
</a><a href="#h35-0-0" id="h35-0-0" class="i">+package me.rhunk.snapenhance.core.util.export
</a><a href="#h35-0-1" id="h35-0-1" class="i">+
</a><a href="#h35-0-2" id="h35-0-2" class="i">+import android.os.Environment
</a><a href="#h35-0-3" id="h35-0-3" class="i">+import android.util.Base64InputStream
</a><a href="#h35-0-4" id="h35-0-4" class="i">+import com.google.gson.JsonArray
</a><a href="#h35-0-5" id="h35-0-5" class="i">+import com.google.gson.JsonObject
</a><a href="#h35-0-6" id="h35-0-6" class="i">+import de.robv.android.xposed.XposedHelpers
</a><a href="#h35-0-7" id="h35-0-7" class="i">+import kotlinx.coroutines.Dispatchers
</a><a href="#h35-0-8" id="h35-0-8" class="i">+import kotlinx.coroutines.withContext
</a><a href="#h35-0-9" id="h35-0-9" class="i">+import me.rhunk.snapenhance.ModContext
</a><a href="#h35-0-10" id="h35-0-10" class="i">+import me.rhunk.snapenhance.core.BuildConfig
</a><a href="#h35-0-11" id="h35-0-11" class="i">+import me.rhunk.snapenhance.core.database.objects.FriendFeedEntry
</a><a href="#h35-0-12" id="h35-0-12" class="i">+import me.rhunk.snapenhance.core.database.objects.FriendInfo
</a><a href="#h35-0-13" id="h35-0-13" class="i">+import me.rhunk.snapenhance.core.util.protobuf.ProtoReader
</a><a href="#h35-0-14" id="h35-0-14" class="i">+import me.rhunk.snapenhance.core.util.snap.EncryptionHelper
</a><a href="#h35-0-15" id="h35-0-15" class="i">+import me.rhunk.snapenhance.core.util.snap.MediaDownloaderHelper
</a><a href="#h35-0-16" id="h35-0-16" class="i">+import me.rhunk.snapenhance.data.ContentType
</a><a href="#h35-0-17" id="h35-0-17" class="i">+import me.rhunk.snapenhance.data.FileType
</a><a href="#h35-0-18" id="h35-0-18" class="i">+import me.rhunk.snapenhance.data.MediaReferenceType
</a><a href="#h35-0-19" id="h35-0-19" class="i">+import me.rhunk.snapenhance.data.wrapper.impl.Message
</a><a href="#h35-0-20" id="h35-0-20" class="i">+import me.rhunk.snapenhance.data.wrapper.impl.SnapUUID
</a><a href="#h35-0-21" id="h35-0-21" class="i">+import java.io.File
</a><a href="#h35-0-22" id="h35-0-22" class="i">+import java.io.FileOutputStream
</a><a href="#h35-0-23" id="h35-0-23" class="i">+import java.io.InputStream
</a><a href="#h35-0-24" id="h35-0-24" class="i">+import java.io.OutputStream
</a><a href="#h35-0-25" id="h35-0-25" class="i">+import java.text.SimpleDateFormat
</a><a href="#h35-0-26" id="h35-0-26" class="i">+import java.util.Base64
</a><a href="#h35-0-27" id="h35-0-27" class="i">+import java.util.Collections
</a><a href="#h35-0-28" id="h35-0-28" class="i">+import java.util.Date
</a><a href="#h35-0-29" id="h35-0-29" class="i">+import java.util.Locale
</a><a href="#h35-0-30" id="h35-0-30" class="i">+import java.util.concurrent.Executors
</a><a href="#h35-0-31" id="h35-0-31" class="i">+import java.util.concurrent.TimeUnit
</a><a href="#h35-0-32" id="h35-0-32" class="i">+import java.util.zip.Deflater
</a><a href="#h35-0-33" id="h35-0-33" class="i">+import java.util.zip.DeflaterInputStream
</a><a href="#h35-0-34" id="h35-0-34" class="i">+import java.util.zip.ZipFile
</a><a href="#h35-0-35" id="h35-0-35" class="i">+import kotlin.io.encoding.ExperimentalEncodingApi
</a><a href="#h35-0-36" id="h35-0-36" class="i">+
</a><a href="#h35-0-37" id="h35-0-37" class="i">+
</a><a href="#h35-0-38" id="h35-0-38" class="i">+enum class ExportFormat(
</a><a href="#h35-0-39" id="h35-0-39" class="i">+    val extension: String,
</a><a href="#h35-0-40" id="h35-0-40" class="i">+){
</a><a href="#h35-0-41" id="h35-0-41" class="i">+    JSON(&quot;json&quot;),
</a><a href="#h35-0-42" id="h35-0-42" class="i">+    TEXT(&quot;txt&quot;),
</a><a href="#h35-0-43" id="h35-0-43" class="i">+    HTML(&quot;html&quot;);
</a><a href="#h35-0-44" id="h35-0-44" class="i">+}
</a><a href="#h35-0-45" id="h35-0-45" class="i">+
</a><a href="#h35-0-46" id="h35-0-46" class="i">+class MessageExporter(
</a><a href="#h35-0-47" id="h35-0-47" class="i">+    private val context: ModContext,
</a><a href="#h35-0-48" id="h35-0-48" class="i">+    private val outputFile: File,
</a><a href="#h35-0-49" id="h35-0-49" class="i">+    private val friendFeedEntry: FriendFeedEntry,
</a><a href="#h35-0-50" id="h35-0-50" class="i">+    private val mediaToDownload: List&lt;ContentType&gt;? = null,
</a><a href="#h35-0-51" id="h35-0-51" class="i">+    private val printLog: (String) -&gt; Unit = {},
</a><a href="#h35-0-52" id="h35-0-52" class="i">+) {
</a><a href="#h35-0-53" id="h35-0-53" class="i">+    private lateinit var conversationParticipants: Map&lt;String, FriendInfo&gt;
</a><a href="#h35-0-54" id="h35-0-54" class="i">+    private lateinit var messages: List&lt;Message&gt;
</a><a href="#h35-0-55" id="h35-0-55" class="i">+
</a><a href="#h35-0-56" id="h35-0-56" class="i">+    fun readMessages(messages: List&lt;Message&gt;) {
</a><a href="#h35-0-57" id="h35-0-57" class="i">+        conversationParticipants =
</a><a href="#h35-0-58" id="h35-0-58" class="i">+            context.database.getConversationParticipants(friendFeedEntry.key!!)
</a><a href="#h35-0-59" id="h35-0-59" class="i">+                ?.mapNotNull {
</a><a href="#h35-0-60" id="h35-0-60" class="i">+                    context.database.getFriendInfo(it)
</a><a href="#h35-0-61" id="h35-0-61" class="i">+                }?.associateBy { it.userId!! } ?: emptyMap()
</a><a href="#h35-0-62" id="h35-0-62" class="i">+
</a><a href="#h35-0-63" id="h35-0-63" class="i">+        if (conversationParticipants.isEmpty())
</a><a href="#h35-0-64" id="h35-0-64" class="i">+            throw Throwable(&quot;Failed to get conversation participants for ${friendFeedEntry.key}&quot;)
</a><a href="#h35-0-65" id="h35-0-65" class="i">+
</a><a href="#h35-0-66" id="h35-0-66" class="i">+        this.messages = messages.sortedBy { it.orderKey }
</a><a href="#h35-0-67" id="h35-0-67" class="i">+    }
</a><a href="#h35-0-68" id="h35-0-68" class="i">+
</a><a href="#h35-0-69" id="h35-0-69" class="i">+    private fun serializeMessageContent(message: Message): String? {
</a><a href="#h35-0-70" id="h35-0-70" class="i">+        return if (message.messageContent.contentType == ContentType.CHAT) {
</a><a href="#h35-0-71" id="h35-0-71" class="i">+            ProtoReader(message.messageContent.content).getString(2, 1) ?: &quot;Failed to parse message&quot;
</a><a href="#h35-0-72" id="h35-0-72" class="i">+        } else null
</a><a href="#h35-0-73" id="h35-0-73" class="i">+    }
</a><a href="#h35-0-74" id="h35-0-74" class="i">+
</a><a href="#h35-0-75" id="h35-0-75" class="i">+    private fun exportText(output: OutputStream) {
</a><a href="#h35-0-76" id="h35-0-76" class="i">+        val writer = output.bufferedWriter()
</a><a href="#h35-0-77" id="h35-0-77" class="i">+        writer.write(&quot;Conversation key: ${friendFeedEntry.key}\n&quot;)
</a><a href="#h35-0-78" id="h35-0-78" class="i">+        writer.write(&quot;Conversation Name: ${friendFeedEntry.feedDisplayName}\n&quot;)
</a><a href="#h35-0-79" id="h35-0-79" class="i">+        writer.write(&quot;Participants:\n&quot;)
</a><a href="#h35-0-80" id="h35-0-80" class="i">+        conversationParticipants.forEach { (userId, friendInfo) -&gt;
</a><a href="#h35-0-81" id="h35-0-81" class="i">+            writer.write(&quot;  $userId: ${friendInfo.displayName}\n&quot;)
</a><a href="#h35-0-82" id="h35-0-82" class="i">+        }
</a><a href="#h35-0-83" id="h35-0-83" class="i">+
</a><a href="#h35-0-84" id="h35-0-84" class="i">+        writer.write(&quot;\nMessages:\n&quot;)
</a><a href="#h35-0-85" id="h35-0-85" class="i">+        messages.forEach { message -&gt;
</a><a href="#h35-0-86" id="h35-0-86" class="i">+            val sender = conversationParticipants[message.senderId.toString()]
</a><a href="#h35-0-87" id="h35-0-87" class="i">+            val senderUsername = sender?.usernameForSorting ?: message.senderId.toString()
</a><a href="#h35-0-88" id="h35-0-88" class="i">+            val senderDisplayName = sender?.displayName ?: message.senderId.toString()
</a><a href="#h35-0-89" id="h35-0-89" class="i">+            val messageContent = serializeMessageContent(message) ?: message.messageContent.contentType?.name
</a><a href="#h35-0-90" id="h35-0-90" class="i">+            val date = SimpleDateFormat(&quot;yyyy-MM-dd HH:mm:ss&quot;, Locale.ENGLISH).format(Date(message.messageMetadata.createdAt))
</a><a href="#h35-0-91" id="h35-0-91" class="i">+            writer.write(&quot;[$date] - $senderDisplayName (${senderUsername}): $messageContent\n&quot;)
</a><a href="#h35-0-92" id="h35-0-92" class="i">+        }
</a><a href="#h35-0-93" id="h35-0-93" class="i">+        writer.flush()
</a><a href="#h35-0-94" id="h35-0-94" class="i">+    }
</a><a href="#h35-0-95" id="h35-0-95" class="i">+
</a><a href="#h35-0-96" id="h35-0-96" class="i">+    @OptIn(ExperimentalEncodingApi::class)
</a><a href="#h35-0-97" id="h35-0-97" class="i">+    suspend fun exportHtml(output: OutputStream) {
</a><a href="#h35-0-98" id="h35-0-98" class="i">+        val downloadMediaCacheFolder = File(Environment.getExternalStoragePublicDirectory(Environment.DIRECTORY_DOWNLOADS), &quot;SnapEnhance/cache&quot;).also { it.mkdirs() }
</a><a href="#h35-0-99" id="h35-0-99" class="i">+        val mediaFiles = Collections.synchronizedMap(mutableMapOf&lt;String, Pair&lt;FileType, File&gt;&gt;())
</a><a href="#h35-0-100" id="h35-0-100" class="i">+        val threadPool = Executors.newFixedThreadPool(15)
</a><a href="#h35-0-101" id="h35-0-101" class="i">+
</a><a href="#h35-0-102" id="h35-0-102" class="i">+        withContext(Dispatchers.IO) {
</a><a href="#h35-0-103" id="h35-0-103" class="i">+            var processCount = 0
</a><a href="#h35-0-104" id="h35-0-104" class="i">+
</a><a href="#h35-0-105" id="h35-0-105" class="i">+            fun updateProgress(type: String) {
</a><a href="#h35-0-106" id="h35-0-106" class="i">+                val total = messages.filter {
</a><a href="#h35-0-107" id="h35-0-107" class="i">+                    mediaToDownload?.contains(it.messageContent.contentType) ?: false
</a><a href="#h35-0-108" id="h35-0-108" class="i">+                }.size
</a><a href="#h35-0-109" id="h35-0-109" class="i">+                processCount++
</a><a href="#h35-0-110" id="h35-0-110" class="i">+                printLog(&quot;$type $processCount/$total&quot;)
</a><a href="#h35-0-111" id="h35-0-111" class="i">+            }
</a><a href="#h35-0-112" id="h35-0-112" class="i">+
</a><a href="#h35-0-113" id="h35-0-113" class="i">+            messages.filter {
</a><a href="#h35-0-114" id="h35-0-114" class="i">+                mediaToDownload?.contains(it.messageContent.contentType) ?: false
</a><a href="#h35-0-115" id="h35-0-115" class="i">+            }.forEach { message -&gt;
</a><a href="#h35-0-116" id="h35-0-116" class="i">+                threadPool.execute {
</a><a href="#h35-0-117" id="h35-0-117" class="i">+                    val remoteMediaReferences by lazy {
</a><a href="#h35-0-118" id="h35-0-118" class="i">+                        val serializedMessageContent = context.gson.toJsonTree(message.messageContent.instanceNonNull()).asJsonObject
</a><a href="#h35-0-119" id="h35-0-119" class="i">+                        serializedMessageContent[&quot;mRemoteMediaReferences&quot;]
</a><a href="#h35-0-120" id="h35-0-120" class="i">+                            .asJsonArray.map { it.asJsonObject[&quot;mMediaReferences&quot;].asJsonArray }
</a><a href="#h35-0-121" id="h35-0-121" class="i">+                            .flatten()
</a><a href="#h35-0-122" id="h35-0-122" class="i">+                    }
</a><a href="#h35-0-123" id="h35-0-123" class="i">+
</a><a href="#h35-0-124" id="h35-0-124" class="i">+                    remoteMediaReferences.firstOrNull().takeIf { it != null }?.let { media -&gt;
</a><a href="#h35-0-125" id="h35-0-125" class="i">+                        val protoMediaReference = media.asJsonObject[&quot;mContentObject&quot;].asJsonArray.map { it.asByte }.toByteArray()
</a><a href="#h35-0-126" id="h35-0-126" class="i">+
</a><a href="#h35-0-127" id="h35-0-127" class="i">+                        runCatching {
</a><a href="#h35-0-128" id="h35-0-128" class="i">+                            val downloadedMedia = MediaDownloaderHelper.downloadMediaFromReference(protoMediaReference) {
</a><a href="#h35-0-129" id="h35-0-129" class="i">+                                EncryptionHelper.decryptInputStream(it, message.messageContent.contentType!!, ProtoReader(message.messageContent.content), isArroyo = false)
</a><a href="#h35-0-130" id="h35-0-130" class="i">+                            }
</a><a href="#h35-0-131" id="h35-0-131" class="i">+
</a><a href="#h35-0-132" id="h35-0-132" class="i">+                            downloadedMedia.forEach { (type, mediaData) -&gt;
</a><a href="#h35-0-133" id="h35-0-133" class="i">+                                val fileType = FileType.fromByteArray(mediaData)
</a><a href="#h35-0-134" id="h35-0-134" class="i">+                                val fileName = &quot;${type}_${kotlin.io.encoding.Base64.UrlSafe.encode(protoMediaReference).replace(&quot;=&quot;, &quot;&quot;)}&quot;
</a><a href="#h35-0-135" id="h35-0-135" class="i">+
</a><a href="#h35-0-136" id="h35-0-136" class="i">+                                val mediaFile = File(downloadMediaCacheFolder, &quot;$fileName.${fileType.fileExtension}&quot;)
</a><a href="#h35-0-137" id="h35-0-137" class="i">+
</a><a href="#h35-0-138" id="h35-0-138" class="i">+                                FileOutputStream(mediaFile).use { fos -&gt;
</a><a href="#h35-0-139" id="h35-0-139" class="i">+                                    mediaData.inputStream().copyTo(fos)
</a><a href="#h35-0-140" id="h35-0-140" class="i">+                                }
</a><a href="#h35-0-141" id="h35-0-141" class="i">+
</a><a href="#h35-0-142" id="h35-0-142" class="i">+                                mediaFiles[fileName] = fileType to mediaFile
</a><a href="#h35-0-143" id="h35-0-143" class="i">+                                updateProgress(&quot;downloaded&quot;)
</a><a href="#h35-0-144" id="h35-0-144" class="i">+                            }
</a><a href="#h35-0-145" id="h35-0-145" class="i">+                        }.onFailure {
</a><a href="#h35-0-146" id="h35-0-146" class="i">+                            printLog(&quot;failed to download media for ${message.messageDescriptor.conversationId}_${message.orderKey}&quot;)
</a><a href="#h35-0-147" id="h35-0-147" class="i">+                            context.log.error(&quot;failed to download media for ${message.messageDescriptor.conversationId}_${message.orderKey}&quot;, it)
</a><a href="#h35-0-148" id="h35-0-148" class="i">+                        }
</a><a href="#h35-0-149" id="h35-0-149" class="i">+                    }
</a><a href="#h35-0-150" id="h35-0-150" class="i">+                }
</a><a href="#h35-0-151" id="h35-0-151" class="i">+            }
</a><a href="#h35-0-152" id="h35-0-152" class="i">+
</a><a href="#h35-0-153" id="h35-0-153" class="i">+            threadPool.shutdown()
</a><a href="#h35-0-154" id="h35-0-154" class="i">+            threadPool.awaitTermination(30, TimeUnit.DAYS)
</a><a href="#h35-0-155" id="h35-0-155" class="i">+            processCount = 0
</a><a href="#h35-0-156" id="h35-0-156" class="i">+
</a><a href="#h35-0-157" id="h35-0-157" class="i">+            printLog(&quot;writing downloaded medias...&quot;)
</a><a href="#h35-0-158" id="h35-0-158" class="i">+
</a><a href="#h35-0-159" id="h35-0-159" class="i">+            //write the head of the html file
</a><a href="#h35-0-160" id="h35-0-160" class="i">+            output.write(&quot;&quot;&quot;
</a><a href="#h35-0-161" id="h35-0-161" class="i">+                &lt;!DOCTYPE html&gt;
</a><a href="#h35-0-162" id="h35-0-162" class="i">+                &lt;html&gt;
</a><a href="#h35-0-163" id="h35-0-163" class="i">+                &lt;head&gt;
</a><a href="#h35-0-164" id="h35-0-164" class="i">+                    &lt;meta charset=&quot;UTF-8&quot;&gt;
</a><a href="#h35-0-165" id="h35-0-165" class="i">+                    &lt;meta http-equiv=&quot;X-UA-Compatible&quot; content=&quot;IE=edge&quot;&gt;
</a><a href="#h35-0-166" id="h35-0-166" class="i">+                    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot;&gt;
</a><a href="#h35-0-167" id="h35-0-167" class="i">+                    &lt;title&gt;&lt;/title&gt;
</a><a href="#h35-0-168" id="h35-0-168" class="i">+                &lt;/head&gt;
</a><a href="#h35-0-169" id="h35-0-169" class="i">+            &quot;&quot;&quot;.trimIndent().toByteArray())
</a><a href="#h35-0-170" id="h35-0-170" class="i">+
</a><a href="#h35-0-171" id="h35-0-171" class="i">+            output.write(&quot;&lt;!-- This file was generated by SnapEnhance ${BuildConfig.VERSION_NAME} --&gt;\n&quot;.toByteArray())
</a><a href="#h35-0-172" id="h35-0-172" class="i">+
</a><a href="#h35-0-173" id="h35-0-173" class="i">+            mediaFiles.forEach { (key, filePair) -&gt;
</a><a href="#h35-0-174" id="h35-0-174" class="i">+                output.write(&quot;&lt;div class=\&quot;media-$key\&quot;&gt;&lt;!-- &quot;.toByteArray())
</a><a href="#h35-0-175" id="h35-0-175" class="i">+
</a><a href="#h35-0-176" id="h35-0-176" class="i">+                val deflateInputStream = DeflaterInputStream(filePair.second.inputStream(), Deflater(Deflater.BEST_COMPRESSION, true))
</a><a href="#h35-0-177" id="h35-0-177" class="i">+                val base64InputStream = XposedHelpers.newInstance(
</a><a href="#h35-0-178" id="h35-0-178" class="i">+                    Base64InputStream::class.java,
</a><a href="#h35-0-179" id="h35-0-179" class="i">+                    deflateInputStream,
</a><a href="#h35-0-180" id="h35-0-180" class="i">+                    android.util.Base64.DEFAULT or android.util.Base64.NO_WRAP,
</a><a href="#h35-0-181" id="h35-0-181" class="i">+                    true
</a><a href="#h35-0-182" id="h35-0-182" class="i">+                ) as InputStream
</a><a href="#h35-0-183" id="h35-0-183" class="i">+                base64InputStream.copyTo(output)
</a><a href="#h35-0-184" id="h35-0-184" class="i">+                deflateInputStream.close()
</a><a href="#h35-0-185" id="h35-0-185" class="i">+
</a><a href="#h35-0-186" id="h35-0-186" class="i">+                output.write(&quot; --&gt;&lt;/div&gt;\n&quot;.toByteArray())
</a><a href="#h35-0-187" id="h35-0-187" class="i">+                output.flush()
</a><a href="#h35-0-188" id="h35-0-188" class="i">+                updateProgress(&quot;wrote&quot;)
</a><a href="#h35-0-189" id="h35-0-189" class="i">+            }
</a><a href="#h35-0-190" id="h35-0-190" class="i">+            printLog(&quot;writing json conversation data...&quot;)
</a><a href="#h35-0-191" id="h35-0-191" class="i">+
</a><a href="#h35-0-192" id="h35-0-192" class="i">+            //write the json file
</a><a href="#h35-0-193" id="h35-0-193" class="i">+            output.write(&quot;&lt;script type=\&quot;application/json\&quot; class=\&quot;exported_content\&quot;&gt;&quot;.toByteArray())
</a><a href="#h35-0-194" id="h35-0-194" class="i">+            exportJson(output)
</a><a href="#h35-0-195" id="h35-0-195" class="i">+            output.write(&quot;&lt;/script&gt;\n&quot;.toByteArray())
</a><a href="#h35-0-196" id="h35-0-196" class="i">+
</a><a href="#h35-0-197" id="h35-0-197" class="i">+            printLog(&quot;writing template...&quot;)
</a><a href="#h35-0-198" id="h35-0-198" class="i">+
</a><a href="#h35-0-199" id="h35-0-199" class="i">+            runCatching {
</a><a href="#h35-0-200" id="h35-0-200" class="i">+                ZipFile(context.bridgeClient.getApplicationApkPath()).use { apkFile -&gt;
</a><a href="#h35-0-201" id="h35-0-201" class="i">+                    //export rawinflate.js
</a><a href="#h35-0-202" id="h35-0-202" class="i">+                    apkFile.getEntry(&quot;assets/web/rawinflate.js&quot;).let { entry -&gt;
</a><a href="#h35-0-203" id="h35-0-203" class="i">+                        output.write(&quot;&lt;script&gt;&quot;.toByteArray())
</a><a href="#h35-0-204" id="h35-0-204" class="i">+                        apkFile.getInputStream(entry).copyTo(output)
</a><a href="#h35-0-205" id="h35-0-205" class="i">+                        output.write(&quot;&lt;/script&gt;\n&quot;.toByteArray())
</a><a href="#h35-0-206" id="h35-0-206" class="i">+                    }
</a><a href="#h35-0-207" id="h35-0-207" class="i">+
</a><a href="#h35-0-208" id="h35-0-208" class="i">+                    //export avenir next font
</a><a href="#h35-0-209" id="h35-0-209" class="i">+                    apkFile.getEntry(&quot;res/font/avenir_next_medium.ttf&quot;).let { entry -&gt;
</a><a href="#h35-0-210" id="h35-0-210" class="i">+                        val encodedFontData = kotlin.io.encoding.Base64.Default.encode(apkFile.getInputStream(entry).readBytes())
</a><a href="#h35-0-211" id="h35-0-211" class="i">+                        output.write(&quot;&quot;&quot;
</a><a href="#h35-0-212" id="h35-0-212" class="i">+                        &lt;style&gt;
</a><a href="#h35-0-213" id="h35-0-213" class="i">+                            @font-face {
</a><a href="#h35-0-214" id="h35-0-214" class="i">+                                font-family: &#39;Avenir Next&#39;;
</a><a href="#h35-0-215" id="h35-0-215" class="i">+                                src: url(&#39;data:font/truetype;charset=utf-8;base64, $encodedFontData&#39;);
</a><a href="#h35-0-216" id="h35-0-216" class="i">+                                font-weight: normal;
</a><a href="#h35-0-217" id="h35-0-217" class="i">+                                font-style: normal;
</a><a href="#h35-0-218" id="h35-0-218" class="i">+                            }
</a><a href="#h35-0-219" id="h35-0-219" class="i">+                        &lt;/style&gt;
</a><a href="#h35-0-220" id="h35-0-220" class="i">+                    &quot;&quot;&quot;.trimIndent().toByteArray())
</a><a href="#h35-0-221" id="h35-0-221" class="i">+                    }
</a><a href="#h35-0-222" id="h35-0-222" class="i">+
</a><a href="#h35-0-223" id="h35-0-223" class="i">+                    apkFile.getEntry(&quot;assets/web/export_template.html&quot;).let { entry -&gt;
</a><a href="#h35-0-224" id="h35-0-224" class="i">+                        apkFile.getInputStream(entry).copyTo(output)
</a><a href="#h35-0-225" id="h35-0-225" class="i">+                    }
</a><a href="#h35-0-226" id="h35-0-226" class="i">+
</a><a href="#h35-0-227" id="h35-0-227" class="i">+                    apkFile.close()
</a><a href="#h35-0-228" id="h35-0-228" class="i">+                }
</a><a href="#h35-0-229" id="h35-0-229" class="i">+            }.onFailure {
</a><a href="#h35-0-230" id="h35-0-230" class="i">+                throw Throwable(&quot;Failed to read template from apk&quot;, it)
</a><a href="#h35-0-231" id="h35-0-231" class="i">+            }
</a><a href="#h35-0-232" id="h35-0-232" class="i">+
</a><a href="#h35-0-233" id="h35-0-233" class="i">+            output.write(&quot;&lt;/html&gt;&quot;.toByteArray())
</a><a href="#h35-0-234" id="h35-0-234" class="i">+            output.close()
</a><a href="#h35-0-235" id="h35-0-235" class="i">+        }
</a><a href="#h35-0-236" id="h35-0-236" class="i">+    }
</a><a href="#h35-0-237" id="h35-0-237" class="i">+
</a><a href="#h35-0-238" id="h35-0-238" class="i">+    private fun exportJson(output: OutputStream) {
</a><a href="#h35-0-239" id="h35-0-239" class="i">+        val rootObject = JsonObject().apply {
</a><a href="#h35-0-240" id="h35-0-240" class="i">+            addProperty(&quot;conversationId&quot;, friendFeedEntry.key)
</a><a href="#h35-0-241" id="h35-0-241" class="i">+            addProperty(&quot;conversationName&quot;, friendFeedEntry.feedDisplayName)
</a><a href="#h35-0-242" id="h35-0-242" class="i">+
</a><a href="#h35-0-243" id="h35-0-243" class="i">+            var index = 0
</a><a href="#h35-0-244" id="h35-0-244" class="i">+            val participants = mutableMapOf&lt;String, Int&gt;()
</a><a href="#h35-0-245" id="h35-0-245" class="i">+
</a><a href="#h35-0-246" id="h35-0-246" class="i">+            add(&quot;participants&quot;, JsonObject().apply {
</a><a href="#h35-0-247" id="h35-0-247" class="i">+                conversationParticipants.forEach { (userId, friendInfo) -&gt;
</a><a href="#h35-0-248" id="h35-0-248" class="i">+                    add(userId, JsonObject().apply {
</a><a href="#h35-0-249" id="h35-0-249" class="i">+                        addProperty(&quot;id&quot;, index)
</a><a href="#h35-0-250" id="h35-0-250" class="i">+                        addProperty(&quot;displayName&quot;, friendInfo.displayName)
</a><a href="#h35-0-251" id="h35-0-251" class="i">+                        addProperty(&quot;username&quot;, friendInfo.usernameForSorting)
</a><a href="#h35-0-252" id="h35-0-252" class="i">+                        addProperty(&quot;bitmojiSelfieId&quot;, friendInfo.bitmojiSelfieId)
</a><a href="#h35-0-253" id="h35-0-253" class="i">+                    })
</a><a href="#h35-0-254" id="h35-0-254" class="i">+                    participants[userId] = index++
</a><a href="#h35-0-255" id="h35-0-255" class="i">+                }
</a><a href="#h35-0-256" id="h35-0-256" class="i">+            })
</a><a href="#h35-0-257" id="h35-0-257" class="i">+            add(&quot;messages&quot;, JsonArray().apply {
</a><a href="#h35-0-258" id="h35-0-258" class="i">+                messages.forEach { message -&gt;
</a><a href="#h35-0-259" id="h35-0-259" class="i">+                    add(JsonObject().apply {
</a><a href="#h35-0-260" id="h35-0-260" class="i">+                        addProperty(&quot;orderKey&quot;, message.orderKey)
</a><a href="#h35-0-261" id="h35-0-261" class="i">+                        addProperty(&quot;senderId&quot;, participants.getOrDefault(message.senderId.toString(), -1))
</a><a href="#h35-0-262" id="h35-0-262" class="i">+                        addProperty(&quot;type&quot;, message.messageContent.contentType.toString())
</a><a href="#h35-0-263" id="h35-0-263" class="i">+
</a><a href="#h35-0-264" id="h35-0-264" class="i">+                        fun addUUIDList(name: String, list: List&lt;SnapUUID&gt;) {
</a><a href="#h35-0-265" id="h35-0-265" class="i">+                            add(name, JsonArray().apply {
</a><a href="#h35-0-266" id="h35-0-266" class="i">+                                list.map { participants.getOrDefault(it.toString(), -1) }.forEach { add(it) }
</a><a href="#h35-0-267" id="h35-0-267" class="i">+                            })
</a><a href="#h35-0-268" id="h35-0-268" class="i">+                        }
</a><a href="#h35-0-269" id="h35-0-269" class="i">+
</a><a href="#h35-0-270" id="h35-0-270" class="i">+                        addUUIDList(&quot;savedBy&quot;, message.messageMetadata.savedBy)
</a><a href="#h35-0-271" id="h35-0-271" class="i">+                        addUUIDList(&quot;seenBy&quot;, message.messageMetadata.seenBy)
</a><a href="#h35-0-272" id="h35-0-272" class="i">+                        addUUIDList(&quot;openedBy&quot;, message.messageMetadata.openedBy)
</a><a href="#h35-0-273" id="h35-0-273" class="i">+
</a><a href="#h35-0-274" id="h35-0-274" class="i">+                        add(&quot;reactions&quot;, JsonObject().apply {
</a><a href="#h35-0-275" id="h35-0-275" class="i">+                            message.messageMetadata.reactions.forEach { reaction -&gt;
</a><a href="#h35-0-276" id="h35-0-276" class="i">+                                addProperty(
</a><a href="#h35-0-277" id="h35-0-277" class="i">+                                    participants.getOrDefault(reaction.userId.toString(), -1L).toString(),
</a><a href="#h35-0-278" id="h35-0-278" class="i">+                                    reaction.reactionId
</a><a href="#h35-0-279" id="h35-0-279" class="i">+                                )
</a><a href="#h35-0-280" id="h35-0-280" class="i">+                            }
</a><a href="#h35-0-281" id="h35-0-281" class="i">+                        })
</a><a href="#h35-0-282" id="h35-0-282" class="i">+
</a><a href="#h35-0-283" id="h35-0-283" class="i">+                        addProperty(&quot;createdTimestamp&quot;, message.messageMetadata.createdAt)
</a><a href="#h35-0-284" id="h35-0-284" class="i">+                        addProperty(&quot;readTimestamp&quot;, message.messageMetadata.readAt)
</a><a href="#h35-0-285" id="h35-0-285" class="i">+                        addProperty(&quot;serializedContent&quot;, serializeMessageContent(message))
</a><a href="#h35-0-286" id="h35-0-286" class="i">+                        addProperty(&quot;rawContent&quot;, Base64.getUrlEncoder().encodeToString(message.messageContent.content))
</a><a href="#h35-0-287" id="h35-0-287" class="i">+
</a><a href="#h35-0-288" id="h35-0-288" class="i">+                        val messageContentType = message.messageContent.contentType ?: ContentType.CHAT
</a><a href="#h35-0-289" id="h35-0-289" class="i">+
</a><a href="#h35-0-290" id="h35-0-290" class="i">+                        EncryptionHelper.getEncryptionKeys(messageContentType, ProtoReader(message.messageContent.content), isArroyo = false)?.let { encryptionKeyPair -&gt;
</a><a href="#h35-0-291" id="h35-0-291" class="i">+                            add(&quot;encryption&quot;, JsonObject().apply encryption@{
</a><a href="#h35-0-292" id="h35-0-292" class="i">+                                addProperty(&quot;key&quot;, Base64.getEncoder().encodeToString(encryptionKeyPair.first))
</a><a href="#h35-0-293" id="h35-0-293" class="i">+                                addProperty(&quot;iv&quot;, Base64.getEncoder().encodeToString(encryptionKeyPair.second))
</a><a href="#h35-0-294" id="h35-0-294" class="i">+                            })
</a><a href="#h35-0-295" id="h35-0-295" class="i">+                        }
</a><a href="#h35-0-296" id="h35-0-296" class="i">+
</a><a href="#h35-0-297" id="h35-0-297" class="i">+                        val remoteMediaReferences by lazy {
</a><a href="#h35-0-298" id="h35-0-298" class="i">+                            val serializedMessageContent = context.gson.toJsonTree(message.messageContent.instanceNonNull()).asJsonObject
</a><a href="#h35-0-299" id="h35-0-299" class="i">+                            serializedMessageContent[&quot;mRemoteMediaReferences&quot;]
</a><a href="#h35-0-300" id="h35-0-300" class="i">+                                .asJsonArray.map { it.asJsonObject[&quot;mMediaReferences&quot;].asJsonArray }
</a><a href="#h35-0-301" id="h35-0-301" class="i">+                                .flatten()
</a><a href="#h35-0-302" id="h35-0-302" class="i">+                        }
</a><a href="#h35-0-303" id="h35-0-303" class="i">+
</a><a href="#h35-0-304" id="h35-0-304" class="i">+                        add(&quot;mediaReferences&quot;, JsonArray().apply mediaReferences@ {
</a><a href="#h35-0-305" id="h35-0-305" class="i">+                            if (messageContentType != ContentType.EXTERNAL_MEDIA &amp;&amp;
</a><a href="#h35-0-306" id="h35-0-306" class="i">+                                messageContentType != ContentType.STICKER &amp;&amp;
</a><a href="#h35-0-307" id="h35-0-307" class="i">+                                messageContentType != ContentType.SNAP &amp;&amp;
</a><a href="#h35-0-308" id="h35-0-308" class="i">+                                messageContentType != ContentType.NOTE)
</a><a href="#h35-0-309" id="h35-0-309" class="i">+                                return@mediaReferences
</a><a href="#h35-0-310" id="h35-0-310" class="i">+
</a><a href="#h35-0-311" id="h35-0-311" class="i">+                            remoteMediaReferences.forEach { media -&gt;
</a><a href="#h35-0-312" id="h35-0-312" class="i">+                                val protoMediaReference = media.asJsonObject[&quot;mContentObject&quot;].asJsonArray.map { it.asByte }.toByteArray()
</a><a href="#h35-0-313" id="h35-0-313" class="i">+                                val mediaType = MediaReferenceType.valueOf(media.asJsonObject[&quot;mMediaType&quot;].asString)
</a><a href="#h35-0-314" id="h35-0-314" class="i">+                                add(JsonObject().apply {
</a><a href="#h35-0-315" id="h35-0-315" class="i">+                                    addProperty(&quot;mediaType&quot;, mediaType.toString())
</a><a href="#h35-0-316" id="h35-0-316" class="i">+                                    addProperty(&quot;content&quot;, Base64.getUrlEncoder().encodeToString(protoMediaReference))
</a><a href="#h35-0-317" id="h35-0-317" class="i">+                                })
</a><a href="#h35-0-318" id="h35-0-318" class="i">+                            }
</a><a href="#h35-0-319" id="h35-0-319" class="i">+                        })
</a><a href="#h35-0-320" id="h35-0-320" class="i">+
</a><a href="#h35-0-321" id="h35-0-321" class="i">+                    })
</a><a href="#h35-0-322" id="h35-0-322" class="i">+                }
</a><a href="#h35-0-323" id="h35-0-323" class="i">+            })
</a><a href="#h35-0-324" id="h35-0-324" class="i">+        }
</a><a href="#h35-0-325" id="h35-0-325" class="i">+
</a><a href="#h35-0-326" id="h35-0-326" class="i">+        output.write(context.gson.toJson(rootObject).toByteArray())
</a><a href="#h35-0-327" id="h35-0-327" class="i">+        output.flush()
</a><a href="#h35-0-328" id="h35-0-328" class="i">+    }
</a><a href="#h35-0-329" id="h35-0-329" class="i">+
</a><a href="#h35-0-330" id="h35-0-330" class="i">+    suspend fun exportTo(exportFormat: ExportFormat) {
</a><a href="#h35-0-331" id="h35-0-331" class="i">+        val output = FileOutputStream(outputFile)
</a><a href="#h35-0-332" id="h35-0-332" class="i">+
</a><a href="#h35-0-333" id="h35-0-333" class="i">+        when (exportFormat) {
</a><a href="#h35-0-334" id="h35-0-334" class="i">+            ExportFormat.HTML -&gt; exportHtml(output)
</a><a href="#h35-0-335" id="h35-0-335" class="i">+            ExportFormat.JSON -&gt; exportJson(output)
</a><a href="#h35-0-336" id="h35-0-336" class="i">+            ExportFormat.TEXT -&gt; exportText(output)
</a><a href="#h35-0-337" id="h35-0-337" class="i">+        }
</a><a href="#h35-0-338" id="h35-0-338" class="i">+
</a><a href="#h35-0-339" id="h35-0-339" class="i">+        output.close()
</a><a href="#h35-0-340" id="h35-0-340" class="i">+    }
</a><a href="#h35-0-341" id="h35-0-341" class="i">+}</a><a href="#h35-0-342" id="h35-0-342" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h36" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/util/ktx/AndroidCompatExtensions.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/util/ktx/AndroidCompatExtensions.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/util/ktx/AndroidCompatExtensions.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/util/ktx/AndroidCompatExtensions.kt</a></b>
<a href="#h36-0" id="h36-0" class="h">@@ -0,0 +1,13 @@
</a><a href="#h36-0-0" id="h36-0-0" class="i">+package me.rhunk.snapenhance.core.util.ktx
</a><a href="#h36-0-1" id="h36-0-1" class="i">+
</a><a href="#h36-0-2" id="h36-0-2" class="i">+import android.content.pm.PackageManager
</a><a href="#h36-0-3" id="h36-0-3" class="i">+import android.content.pm.PackageManager.ApplicationInfoFlags
</a><a href="#h36-0-4" id="h36-0-4" class="i">+import android.os.Build
</a><a href="#h36-0-5" id="h36-0-5" class="i">+
</a><a href="#h36-0-6" id="h36-0-6" class="i">+fun PackageManager.getApplicationInfoCompat(packageName: String, flags: Int) =
</a><a href="#h36-0-7" id="h36-0-7" class="i">+    if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.TIRAMISU) {
</a><a href="#h36-0-8" id="h36-0-8" class="i">+        getApplicationInfo(packageName, ApplicationInfoFlags.of(flags.toLong()))
</a><a href="#h36-0-9" id="h36-0-9" class="i">+    } else {
</a><a href="#h36-0-10" id="h36-0-10" class="i">+        @Suppress(&quot;DEPRECATION&quot;)
</a><a href="#h36-0-11" id="h36-0-11" class="i">+        getApplicationInfo(packageName, flags)
</a><a href="#h36-0-12" id="h36-0-12" class="i">+    }
</a><b>diff --git a/<a id="h37" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/util/ktx/DbCursorExt.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/util/ktx/DbCursorExt.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/util/ktx/DbCursorExt.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/util/ktx/DbCursorExt.kt</a></b>
<a href="#h37-0" id="h37-0" class="h">@@ -0,0 +1,37 @@
</a><a href="#h37-0-0" id="h37-0-0" class="i">+package me.rhunk.snapenhance.core.util.ktx
</a><a href="#h37-0-1" id="h37-0-1" class="i">+
</a><a href="#h37-0-2" id="h37-0-2" class="i">+import android.database.Cursor
</a><a href="#h37-0-3" id="h37-0-3" class="i">+
</a><a href="#h37-0-4" id="h37-0-4" class="i">+fun Cursor.getStringOrNull(columnName: String): String? {
</a><a href="#h37-0-5" id="h37-0-5" class="i">+    val columnIndex = getColumnIndex(columnName)
</a><a href="#h37-0-6" id="h37-0-6" class="i">+    return if (columnIndex == -1) null else getString(columnIndex)
</a><a href="#h37-0-7" id="h37-0-7" class="i">+}
</a><a href="#h37-0-8" id="h37-0-8" class="i">+
</a><a href="#h37-0-9" id="h37-0-9" class="i">+fun Cursor.getIntOrNull(columnName: String): Int? {
</a><a href="#h37-0-10" id="h37-0-10" class="i">+    val columnIndex = getColumnIndex(columnName)
</a><a href="#h37-0-11" id="h37-0-11" class="i">+    return if (columnIndex == -1) null else getInt(columnIndex)
</a><a href="#h37-0-12" id="h37-0-12" class="i">+}
</a><a href="#h37-0-13" id="h37-0-13" class="i">+
</a><a href="#h37-0-14" id="h37-0-14" class="i">+fun Cursor.getInteger(columnName: String) = getIntOrNull(columnName) ?: throw NullPointerException(&quot;Column $columnName is null&quot;)
</a><a href="#h37-0-15" id="h37-0-15" class="i">+fun Cursor.getLong(columnName: String) = getLongOrNull(columnName) ?: throw NullPointerException(&quot;Column $columnName is null&quot;)
</a><a href="#h37-0-16" id="h37-0-16" class="i">+
</a><a href="#h37-0-17" id="h37-0-17" class="i">+fun Cursor.getBlobOrNull(columnName: String): ByteArray? {
</a><a href="#h37-0-18" id="h37-0-18" class="i">+    val columnIndex = getColumnIndex(columnName)
</a><a href="#h37-0-19" id="h37-0-19" class="i">+    return if (columnIndex == -1) null else getBlob(columnIndex)
</a><a href="#h37-0-20" id="h37-0-20" class="i">+}
</a><a href="#h37-0-21" id="h37-0-21" class="i">+
</a><a href="#h37-0-22" id="h37-0-22" class="i">+
</a><a href="#h37-0-23" id="h37-0-23" class="i">+fun Cursor.getLongOrNull(columnName: String): Long? {
</a><a href="#h37-0-24" id="h37-0-24" class="i">+    val columnIndex = getColumnIndex(columnName)
</a><a href="#h37-0-25" id="h37-0-25" class="i">+    return if (columnIndex == -1) null else getLong(columnIndex)
</a><a href="#h37-0-26" id="h37-0-26" class="i">+}
</a><a href="#h37-0-27" id="h37-0-27" class="i">+
</a><a href="#h37-0-28" id="h37-0-28" class="i">+fun Cursor.getDoubleOrNull(columnName: String): Double? {
</a><a href="#h37-0-29" id="h37-0-29" class="i">+    val columnIndex = getColumnIndex(columnName)
</a><a href="#h37-0-30" id="h37-0-30" class="i">+    return if (columnIndex == -1) null else getDouble(columnIndex)
</a><a href="#h37-0-31" id="h37-0-31" class="i">+}
</a><a href="#h37-0-32" id="h37-0-32" class="i">+
</a><a href="#h37-0-33" id="h37-0-33" class="i">+fun Cursor.getFloatOrNull(columnName: String): Float? {
</a><a href="#h37-0-34" id="h37-0-34" class="i">+    val columnIndex = getColumnIndex(columnName)
</a><a href="#h37-0-35" id="h37-0-35" class="i">+    return if (columnIndex == -1) null else getFloat(columnIndex)
</a><a href="#h37-0-36" id="h37-0-36" class="i">+}</a><a href="#h37-0-37" id="h37-0-37" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h38" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/util/ktx/XposedHelperExt.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/util/ktx/XposedHelperExt.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/util/ktx/XposedHelperExt.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/util/ktx/XposedHelperExt.kt</a></b>
<a href="#h38-0" id="h38-0" class="h">@@ -0,0 +1,27 @@
</a><a href="#h38-0-0" id="h38-0-0" class="i">+package me.rhunk.snapenhance.core.util.ktx
</a><a href="#h38-0-1" id="h38-0-1" class="i">+
</a><a href="#h38-0-2" id="h38-0-2" class="i">+import de.robv.android.xposed.XposedHelpers
</a><a href="#h38-0-3" id="h38-0-3" class="i">+
</a><a href="#h38-0-4" id="h38-0-4" class="i">+fun Any.getObjectField(fieldName: String): Any? {
</a><a href="#h38-0-5" id="h38-0-5" class="i">+    return XposedHelpers.getObjectField(this, fieldName)
</a><a href="#h38-0-6" id="h38-0-6" class="i">+}
</a><a href="#h38-0-7" id="h38-0-7" class="i">+
</a><a href="#h38-0-8" id="h38-0-8" class="i">+fun Any.setEnumField(fieldName: String, value: String) {
</a><a href="#h38-0-9" id="h38-0-9" class="i">+    this::class.java.getDeclaredField(fieldName)
</a><a href="#h38-0-10" id="h38-0-10" class="i">+        .type.enumConstants?.firstOrNull { it.toString() == value }?.let { enum -&gt;
</a><a href="#h38-0-11" id="h38-0-11" class="i">+        setObjectField(fieldName, enum)
</a><a href="#h38-0-12" id="h38-0-12" class="i">+    }
</a><a href="#h38-0-13" id="h38-0-13" class="i">+}
</a><a href="#h38-0-14" id="h38-0-14" class="i">+
</a><a href="#h38-0-15" id="h38-0-15" class="i">+fun Any.setObjectField(fieldName: String, value: Any?) {
</a><a href="#h38-0-16" id="h38-0-16" class="i">+    XposedHelpers.setObjectField(this, fieldName, value)
</a><a href="#h38-0-17" id="h38-0-17" class="i">+}
</a><a href="#h38-0-18" id="h38-0-18" class="i">+
</a><a href="#h38-0-19" id="h38-0-19" class="i">+fun Any.getObjectFieldOrNull(fieldName: String): Any? {
</a><a href="#h38-0-20" id="h38-0-20" class="i">+    return try {
</a><a href="#h38-0-21" id="h38-0-21" class="i">+        getObjectField(fieldName)
</a><a href="#h38-0-22" id="h38-0-22" class="i">+    } catch (e: Exception) {
</a><a href="#h38-0-23" id="h38-0-23" class="i">+        null
</a><a href="#h38-0-24" id="h38-0-24" class="i">+    }
</a><a href="#h38-0-25" id="h38-0-25" class="i">+}
</a><a href="#h38-0-26" id="h38-0-26" class="i">+
</a><b>diff --git a/<a id="h39" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/util/protobuf/ProtoEditor.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/util/protobuf/ProtoEditor.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/util/protobuf/ProtoEditor.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/util/protobuf/ProtoEditor.kt</a></b>
<a href="#h39-0" id="h39-0" class="h">@@ -0,0 +1,67 @@
</a><a href="#h39-0-0" id="h39-0-0" class="i">+package me.rhunk.snapenhance.core.util.protobuf
</a><a href="#h39-0-1" id="h39-0-1" class="i">+
</a><a href="#h39-0-2" id="h39-0-2" class="i">+
</a><a href="#h39-0-3" id="h39-0-3" class="i">+typealias WireCallback = EditorContext.() -&gt; Unit
</a><a href="#h39-0-4" id="h39-0-4" class="i">+
</a><a href="#h39-0-5" id="h39-0-5" class="i">+class EditorContext(
</a><a href="#h39-0-6" id="h39-0-6" class="i">+    private val wires: MutableMap&lt;Int, MutableList&lt;Wire&gt;&gt;
</a><a href="#h39-0-7" id="h39-0-7" class="i">+) {
</a><a href="#h39-0-8" id="h39-0-8" class="i">+    fun clear() {
</a><a href="#h39-0-9" id="h39-0-9" class="i">+        wires.clear()
</a><a href="#h39-0-10" id="h39-0-10" class="i">+    }
</a><a href="#h39-0-11" id="h39-0-11" class="i">+    fun addWire(wire: Wire) {
</a><a href="#h39-0-12" id="h39-0-12" class="i">+        wires.getOrPut(wire.id) { mutableListOf() }.add(wire)
</a><a href="#h39-0-13" id="h39-0-13" class="i">+    }
</a><a href="#h39-0-14" id="h39-0-14" class="i">+    fun addVarInt(id: Int, value: Int) = addVarInt(id, value.toLong())
</a><a href="#h39-0-15" id="h39-0-15" class="i">+    fun addVarInt(id: Int, value: Long) = addWire(Wire(id, WireType.VARINT, value))
</a><a href="#h39-0-16" id="h39-0-16" class="i">+    fun addBuffer(id: Int, value: ByteArray) = addWire(Wire(id, WireType.LENGTH_DELIMITED, value))
</a><a href="#h39-0-17" id="h39-0-17" class="i">+    fun add(id: Int, content: ProtoWriter.() -&gt; Unit) = addBuffer(id, ProtoWriter().apply(content).toByteArray())
</a><a href="#h39-0-18" id="h39-0-18" class="i">+    fun addString(id: Int, value: String) = addBuffer(id, value.toByteArray())
</a><a href="#h39-0-19" id="h39-0-19" class="i">+    fun addFixed64(id: Int, value: Long) = addWire(Wire(id, WireType.FIXED64, value))
</a><a href="#h39-0-20" id="h39-0-20" class="i">+    fun addFixed32(id: Int, value: Int) = addWire(Wire(id, WireType.FIXED32, value))
</a><a href="#h39-0-21" id="h39-0-21" class="i">+
</a><a href="#h39-0-22" id="h39-0-22" class="i">+    fun firstOrNull(id: Int) = wires[id]?.firstOrNull()
</a><a href="#h39-0-23" id="h39-0-23" class="i">+    fun getOrNull(id: Int) = wires[id]
</a><a href="#h39-0-24" id="h39-0-24" class="i">+    fun get(id: Int) = wires[id]!!
</a><a href="#h39-0-25" id="h39-0-25" class="i">+
</a><a href="#h39-0-26" id="h39-0-26" class="i">+    fun remove(id: Int) = wires.remove(id)
</a><a href="#h39-0-27" id="h39-0-27" class="i">+    fun remove(id: Int, index: Int) = wires[id]?.removeAt(index)
</a><a href="#h39-0-28" id="h39-0-28" class="i">+}
</a><a href="#h39-0-29" id="h39-0-29" class="i">+
</a><a href="#h39-0-30" id="h39-0-30" class="i">+class ProtoEditor(
</a><a href="#h39-0-31" id="h39-0-31" class="i">+    private var buffer: ByteArray
</a><a href="#h39-0-32" id="h39-0-32" class="i">+) {
</a><a href="#h39-0-33" id="h39-0-33" class="i">+    fun edit(vararg path: Int, callback: WireCallback) {
</a><a href="#h39-0-34" id="h39-0-34" class="i">+        buffer = writeAtPath(path, 0, ProtoReader(buffer), callback)
</a><a href="#h39-0-35" id="h39-0-35" class="i">+    }
</a><a href="#h39-0-36" id="h39-0-36" class="i">+
</a><a href="#h39-0-37" id="h39-0-37" class="i">+    private fun writeAtPath(path: IntArray, currentIndex: Int, rootReader: ProtoReader, wireToWriteCallback: WireCallback): ByteArray {
</a><a href="#h39-0-38" id="h39-0-38" class="i">+        val id = path.getOrNull(currentIndex)
</a><a href="#h39-0-39" id="h39-0-39" class="i">+        val output = ProtoWriter()
</a><a href="#h39-0-40" id="h39-0-40" class="i">+        val wires = mutableMapOf&lt;Int, MutableList&lt;Wire&gt;&gt;()
</a><a href="#h39-0-41" id="h39-0-41" class="i">+
</a><a href="#h39-0-42" id="h39-0-42" class="i">+        rootReader.forEach { wireId, value -&gt;
</a><a href="#h39-0-43" id="h39-0-43" class="i">+            wires.putIfAbsent(wireId, mutableListOf())
</a><a href="#h39-0-44" id="h39-0-44" class="i">+            if (id != null &amp;&amp; wireId == id) {
</a><a href="#h39-0-45" id="h39-0-45" class="i">+                val childReader = rootReader.followPath(id)
</a><a href="#h39-0-46" id="h39-0-46" class="i">+                if (childReader == null) {
</a><a href="#h39-0-47" id="h39-0-47" class="i">+                    wires.getOrPut(wireId) { mutableListOf() }.add(value)
</a><a href="#h39-0-48" id="h39-0-48" class="i">+                    return@forEach
</a><a href="#h39-0-49" id="h39-0-49" class="i">+                }
</a><a href="#h39-0-50" id="h39-0-50" class="i">+                wires[wireId]!!.add(Wire(wireId, WireType.LENGTH_DELIMITED, writeAtPath(path, currentIndex + 1, childReader, wireToWriteCallback)))
</a><a href="#h39-0-51" id="h39-0-51" class="i">+                return@forEach
</a><a href="#h39-0-52" id="h39-0-52" class="i">+            }
</a><a href="#h39-0-53" id="h39-0-53" class="i">+            wires[wireId]!!.add(value)
</a><a href="#h39-0-54" id="h39-0-54" class="i">+        }
</a><a href="#h39-0-55" id="h39-0-55" class="i">+
</a><a href="#h39-0-56" id="h39-0-56" class="i">+        if (currentIndex == path.size) {
</a><a href="#h39-0-57" id="h39-0-57" class="i">+            wireToWriteCallback(EditorContext(wires))
</a><a href="#h39-0-58" id="h39-0-58" class="i">+        }
</a><a href="#h39-0-59" id="h39-0-59" class="i">+
</a><a href="#h39-0-60" id="h39-0-60" class="i">+        wires.values.flatten().forEach(output::addWire)
</a><a href="#h39-0-61" id="h39-0-61" class="i">+
</a><a href="#h39-0-62" id="h39-0-62" class="i">+        return output.toByteArray()
</a><a href="#h39-0-63" id="h39-0-63" class="i">+    }
</a><a href="#h39-0-64" id="h39-0-64" class="i">+
</a><a href="#h39-0-65" id="h39-0-65" class="i">+    fun toByteArray() = buffer
</a><a href="#h39-0-66" id="h39-0-66" class="i">+}</a><a href="#h39-0-67" id="h39-0-67" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h40" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/util/protobuf/ProtoReader.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/util/protobuf/ProtoReader.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/util/protobuf/ProtoReader.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/util/protobuf/ProtoReader.kt</a></b>
<a href="#h40-0" id="h40-0" class="h">@@ -0,0 +1,175 @@
</a><a href="#h40-0-0" id="h40-0-0" class="i">+package me.rhunk.snapenhance.core.util.protobuf
</a><a href="#h40-0-1" id="h40-0-1" class="i">+
</a><a href="#h40-0-2" id="h40-0-2" class="i">+data class Wire(val id: Int, val type: WireType, val value: Any)
</a><a href="#h40-0-3" id="h40-0-3" class="i">+
</a><a href="#h40-0-4" id="h40-0-4" class="i">+class ProtoReader(private val buffer: ByteArray) {
</a><a href="#h40-0-5" id="h40-0-5" class="i">+    private var offset: Int = 0
</a><a href="#h40-0-6" id="h40-0-6" class="i">+    private val values = mutableMapOf&lt;Int, MutableList&lt;Wire&gt;&gt;()
</a><a href="#h40-0-7" id="h40-0-7" class="i">+
</a><a href="#h40-0-8" id="h40-0-8" class="i">+    init {
</a><a href="#h40-0-9" id="h40-0-9" class="i">+        read()
</a><a href="#h40-0-10" id="h40-0-10" class="i">+    }
</a><a href="#h40-0-11" id="h40-0-11" class="i">+
</a><a href="#h40-0-12" id="h40-0-12" class="i">+    fun getBuffer() = buffer
</a><a href="#h40-0-13" id="h40-0-13" class="i">+
</a><a href="#h40-0-14" id="h40-0-14" class="i">+    private fun readByte() = buffer[offset++]
</a><a href="#h40-0-15" id="h40-0-15" class="i">+
</a><a href="#h40-0-16" id="h40-0-16" class="i">+    private fun readVarInt(): Long {
</a><a href="#h40-0-17" id="h40-0-17" class="i">+        var result = 0L
</a><a href="#h40-0-18" id="h40-0-18" class="i">+        var shift = 0
</a><a href="#h40-0-19" id="h40-0-19" class="i">+        while (true) {
</a><a href="#h40-0-20" id="h40-0-20" class="i">+            val b = readByte()
</a><a href="#h40-0-21" id="h40-0-21" class="i">+            result = result or ((b.toLong() and 0x7F) shl shift)
</a><a href="#h40-0-22" id="h40-0-22" class="i">+            if (b.toInt() and 0x80 == 0) {
</a><a href="#h40-0-23" id="h40-0-23" class="i">+                break
</a><a href="#h40-0-24" id="h40-0-24" class="i">+            }
</a><a href="#h40-0-25" id="h40-0-25" class="i">+            shift += 7
</a><a href="#h40-0-26" id="h40-0-26" class="i">+        }
</a><a href="#h40-0-27" id="h40-0-27" class="i">+        return result
</a><a href="#h40-0-28" id="h40-0-28" class="i">+    }
</a><a href="#h40-0-29" id="h40-0-29" class="i">+
</a><a href="#h40-0-30" id="h40-0-30" class="i">+    private fun read() {
</a><a href="#h40-0-31" id="h40-0-31" class="i">+        while (offset &lt; buffer.size) {
</a><a href="#h40-0-32" id="h40-0-32" class="i">+            val tag = readVarInt().toInt()
</a><a href="#h40-0-33" id="h40-0-33" class="i">+            val id = tag ushr 3
</a><a href="#h40-0-34" id="h40-0-34" class="i">+            val type = WireType.fromValue(tag and 0x7) ?: break
</a><a href="#h40-0-35" id="h40-0-35" class="i">+            try {
</a><a href="#h40-0-36" id="h40-0-36" class="i">+                val value = when (type) {
</a><a href="#h40-0-37" id="h40-0-37" class="i">+                    WireType.VARINT -&gt; readVarInt()
</a><a href="#h40-0-38" id="h40-0-38" class="i">+                    WireType.FIXED64 -&gt; {
</a><a href="#h40-0-39" id="h40-0-39" class="i">+                        val bytes = ByteArray(8)
</a><a href="#h40-0-40" id="h40-0-40" class="i">+                        for (i in 0..7) {
</a><a href="#h40-0-41" id="h40-0-41" class="i">+                            bytes[i] = readByte()
</a><a href="#h40-0-42" id="h40-0-42" class="i">+                        }
</a><a href="#h40-0-43" id="h40-0-43" class="i">+                        bytes
</a><a href="#h40-0-44" id="h40-0-44" class="i">+                    }
</a><a href="#h40-0-45" id="h40-0-45" class="i">+                    WireType.LENGTH_DELIMITED -&gt; {
</a><a href="#h40-0-46" id="h40-0-46" class="i">+                        val length = readVarInt().toInt()
</a><a href="#h40-0-47" id="h40-0-47" class="i">+                        val bytes = ByteArray(length)
</a><a href="#h40-0-48" id="h40-0-48" class="i">+                        for (i in 0 until length) {
</a><a href="#h40-0-49" id="h40-0-49" class="i">+                            bytes[i] = readByte()
</a><a href="#h40-0-50" id="h40-0-50" class="i">+                        }
</a><a href="#h40-0-51" id="h40-0-51" class="i">+                        bytes
</a><a href="#h40-0-52" id="h40-0-52" class="i">+                    }
</a><a href="#h40-0-53" id="h40-0-53" class="i">+                    WireType.START_GROUP -&gt; {
</a><a href="#h40-0-54" id="h40-0-54" class="i">+                        val bytes = mutableListOf&lt;Byte&gt;()
</a><a href="#h40-0-55" id="h40-0-55" class="i">+                        while (true) {
</a><a href="#h40-0-56" id="h40-0-56" class="i">+                            val b = readByte()
</a><a href="#h40-0-57" id="h40-0-57" class="i">+                            if (b.toInt() == WireType.END_GROUP.value) {
</a><a href="#h40-0-58" id="h40-0-58" class="i">+                                break
</a><a href="#h40-0-59" id="h40-0-59" class="i">+                            }
</a><a href="#h40-0-60" id="h40-0-60" class="i">+                            bytes.add(b)
</a><a href="#h40-0-61" id="h40-0-61" class="i">+                        }
</a><a href="#h40-0-62" id="h40-0-62" class="i">+                        bytes.toByteArray()
</a><a href="#h40-0-63" id="h40-0-63" class="i">+                    }
</a><a href="#h40-0-64" id="h40-0-64" class="i">+                    WireType.FIXED32 -&gt; {
</a><a href="#h40-0-65" id="h40-0-65" class="i">+                        val bytes = ByteArray(4)
</a><a href="#h40-0-66" id="h40-0-66" class="i">+                        for (i in 0..3) {
</a><a href="#h40-0-67" id="h40-0-67" class="i">+                            bytes[i] = readByte()
</a><a href="#h40-0-68" id="h40-0-68" class="i">+                        }
</a><a href="#h40-0-69" id="h40-0-69" class="i">+                        bytes
</a><a href="#h40-0-70" id="h40-0-70" class="i">+                    }
</a><a href="#h40-0-71" id="h40-0-71" class="i">+                    WireType.END_GROUP -&gt; continue
</a><a href="#h40-0-72" id="h40-0-72" class="i">+                }
</a><a href="#h40-0-73" id="h40-0-73" class="i">+                values.getOrPut(id) { mutableListOf() }.add(Wire(id, type, value))
</a><a href="#h40-0-74" id="h40-0-74" class="i">+            } catch (t: Throwable) {
</a><a href="#h40-0-75" id="h40-0-75" class="i">+                values.clear()
</a><a href="#h40-0-76" id="h40-0-76" class="i">+                break
</a><a href="#h40-0-77" id="h40-0-77" class="i">+            }
</a><a href="#h40-0-78" id="h40-0-78" class="i">+        }
</a><a href="#h40-0-79" id="h40-0-79" class="i">+    }
</a><a href="#h40-0-80" id="h40-0-80" class="i">+
</a><a href="#h40-0-81" id="h40-0-81" class="i">+    fun followPath(vararg ids: Int, excludeLast: Boolean = false, reader: (ProtoReader.() -&gt; Unit)? = null): ProtoReader? {
</a><a href="#h40-0-82" id="h40-0-82" class="i">+        var thisReader = this
</a><a href="#h40-0-83" id="h40-0-83" class="i">+        ids.let {
</a><a href="#h40-0-84" id="h40-0-84" class="i">+            if (excludeLast) {
</a><a href="#h40-0-85" id="h40-0-85" class="i">+                it.sliceArray(0 until it.size - 1)
</a><a href="#h40-0-86" id="h40-0-86" class="i">+            } else {
</a><a href="#h40-0-87" id="h40-0-87" class="i">+                it
</a><a href="#h40-0-88" id="h40-0-88" class="i">+            }
</a><a href="#h40-0-89" id="h40-0-89" class="i">+        }.forEach { id -&gt;
</a><a href="#h40-0-90" id="h40-0-90" class="i">+            if (!thisReader.contains(id)) {
</a><a href="#h40-0-91" id="h40-0-91" class="i">+                return null
</a><a href="#h40-0-92" id="h40-0-92" class="i">+            }
</a><a href="#h40-0-93" id="h40-0-93" class="i">+            thisReader = ProtoReader(thisReader.getByteArray(id) ?: return null)
</a><a href="#h40-0-94" id="h40-0-94" class="i">+        }
</a><a href="#h40-0-95" id="h40-0-95" class="i">+        if (reader != null) {
</a><a href="#h40-0-96" id="h40-0-96" class="i">+            thisReader.reader()
</a><a href="#h40-0-97" id="h40-0-97" class="i">+        }
</a><a href="#h40-0-98" id="h40-0-98" class="i">+        return thisReader
</a><a href="#h40-0-99" id="h40-0-99" class="i">+    }
</a><a href="#h40-0-100" id="h40-0-100" class="i">+
</a><a href="#h40-0-101" id="h40-0-101" class="i">+    fun containsPath(vararg ids: Int): Boolean {
</a><a href="#h40-0-102" id="h40-0-102" class="i">+        var thisReader = this
</a><a href="#h40-0-103" id="h40-0-103" class="i">+        ids.forEach { id -&gt;
</a><a href="#h40-0-104" id="h40-0-104" class="i">+            if (!thisReader.contains(id)) {
</a><a href="#h40-0-105" id="h40-0-105" class="i">+                return false
</a><a href="#h40-0-106" id="h40-0-106" class="i">+            }
</a><a href="#h40-0-107" id="h40-0-107" class="i">+            thisReader = ProtoReader(thisReader.getByteArray(id) ?: return false)
</a><a href="#h40-0-108" id="h40-0-108" class="i">+        }
</a><a href="#h40-0-109" id="h40-0-109" class="i">+        return true
</a><a href="#h40-0-110" id="h40-0-110" class="i">+    }
</a><a href="#h40-0-111" id="h40-0-111" class="i">+
</a><a href="#h40-0-112" id="h40-0-112" class="i">+    fun forEach(reader: (Int, Wire) -&gt; Unit) {
</a><a href="#h40-0-113" id="h40-0-113" class="i">+        values.forEach { (id, wires) -&gt;
</a><a href="#h40-0-114" id="h40-0-114" class="i">+            wires.forEach { wire -&gt;
</a><a href="#h40-0-115" id="h40-0-115" class="i">+                reader(id, wire)
</a><a href="#h40-0-116" id="h40-0-116" class="i">+            }
</a><a href="#h40-0-117" id="h40-0-117" class="i">+        }
</a><a href="#h40-0-118" id="h40-0-118" class="i">+    }
</a><a href="#h40-0-119" id="h40-0-119" class="i">+
</a><a href="#h40-0-120" id="h40-0-120" class="i">+    fun forEach(vararg id: Int, reader: ProtoReader.() -&gt; Unit) {
</a><a href="#h40-0-121" id="h40-0-121" class="i">+        followPath(*id)?.eachBuffer { _, buffer -&gt;
</a><a href="#h40-0-122" id="h40-0-122" class="i">+            ProtoReader(buffer).reader()
</a><a href="#h40-0-123" id="h40-0-123" class="i">+        }
</a><a href="#h40-0-124" id="h40-0-124" class="i">+    }
</a><a href="#h40-0-125" id="h40-0-125" class="i">+
</a><a href="#h40-0-126" id="h40-0-126" class="i">+    fun eachBuffer(vararg ids: Int, reader: ProtoReader.() -&gt; Unit) {
</a><a href="#h40-0-127" id="h40-0-127" class="i">+        followPath(*ids, excludeLast = true)?.eachBuffer { id, buffer -&gt;
</a><a href="#h40-0-128" id="h40-0-128" class="i">+            if (id == ids.last()) {
</a><a href="#h40-0-129" id="h40-0-129" class="i">+                ProtoReader(buffer).reader()
</a><a href="#h40-0-130" id="h40-0-130" class="i">+            }
</a><a href="#h40-0-131" id="h40-0-131" class="i">+        }
</a><a href="#h40-0-132" id="h40-0-132" class="i">+    }
</a><a href="#h40-0-133" id="h40-0-133" class="i">+
</a><a href="#h40-0-134" id="h40-0-134" class="i">+    fun eachBuffer(reader: (Int, ByteArray) -&gt; Unit) {
</a><a href="#h40-0-135" id="h40-0-135" class="i">+        values.forEach { (id, wires) -&gt;
</a><a href="#h40-0-136" id="h40-0-136" class="i">+            wires.forEach { wire -&gt;
</a><a href="#h40-0-137" id="h40-0-137" class="i">+                if (wire.type == WireType.LENGTH_DELIMITED) {
</a><a href="#h40-0-138" id="h40-0-138" class="i">+                    reader(id, wire.value as ByteArray)
</a><a href="#h40-0-139" id="h40-0-139" class="i">+                }
</a><a href="#h40-0-140" id="h40-0-140" class="i">+            }
</a><a href="#h40-0-141" id="h40-0-141" class="i">+        }
</a><a href="#h40-0-142" id="h40-0-142" class="i">+    }
</a><a href="#h40-0-143" id="h40-0-143" class="i">+
</a><a href="#h40-0-144" id="h40-0-144" class="i">+    fun contains(id: Int) = values.containsKey(id)
</a><a href="#h40-0-145" id="h40-0-145" class="i">+
</a><a href="#h40-0-146" id="h40-0-146" class="i">+    fun getWire(id: Int) = values[id]?.firstOrNull()
</a><a href="#h40-0-147" id="h40-0-147" class="i">+    fun getRawValue(id: Int) = getWire(id)?.value
</a><a href="#h40-0-148" id="h40-0-148" class="i">+    fun getByteArray(id: Int) = getRawValue(id) as? ByteArray
</a><a href="#h40-0-149" id="h40-0-149" class="i">+    fun getByteArray(vararg ids: Int) = followPath(*ids, excludeLast = true)?.getByteArray(ids.last())
</a><a href="#h40-0-150" id="h40-0-150" class="i">+    fun getString(id: Int) = getByteArray(id)?.toString(Charsets.UTF_8)
</a><a href="#h40-0-151" id="h40-0-151" class="i">+    fun getString(vararg ids: Int) = followPath(*ids, excludeLast = true)?.getString(ids.last())
</a><a href="#h40-0-152" id="h40-0-152" class="i">+    fun getVarInt(id: Int) = getRawValue(id) as? Long
</a><a href="#h40-0-153" id="h40-0-153" class="i">+    fun getVarInt(vararg ids: Int) = followPath(*ids, excludeLast = true)?.getVarInt(ids.last())
</a><a href="#h40-0-154" id="h40-0-154" class="i">+    fun getCount(id: Int) = values[id]?.size ?: 0
</a><a href="#h40-0-155" id="h40-0-155" class="i">+
</a><a href="#h40-0-156" id="h40-0-156" class="i">+    fun getFixed64(id: Int): Long {
</a><a href="#h40-0-157" id="h40-0-157" class="i">+        val bytes = getByteArray(id) ?: return 0L
</a><a href="#h40-0-158" id="h40-0-158" class="i">+        var value = 0L
</a><a href="#h40-0-159" id="h40-0-159" class="i">+        for (i in 0..7) {
</a><a href="#h40-0-160" id="h40-0-160" class="i">+            value = value or ((bytes[i].toLong() and 0xFF) shl (i * 8))
</a><a href="#h40-0-161" id="h40-0-161" class="i">+        }
</a><a href="#h40-0-162" id="h40-0-162" class="i">+        return value
</a><a href="#h40-0-163" id="h40-0-163" class="i">+    }
</a><a href="#h40-0-164" id="h40-0-164" class="i">+
</a><a href="#h40-0-165" id="h40-0-165" class="i">+
</a><a href="#h40-0-166" id="h40-0-166" class="i">+    fun getFixed32(id: Int): Int {
</a><a href="#h40-0-167" id="h40-0-167" class="i">+        val bytes = getByteArray(id) ?: return 0
</a><a href="#h40-0-168" id="h40-0-168" class="i">+        var value = 0
</a><a href="#h40-0-169" id="h40-0-169" class="i">+        for (i in 0..3) {
</a><a href="#h40-0-170" id="h40-0-170" class="i">+            value = value or ((bytes[i].toInt() and 0xFF) shl (i * 8))
</a><a href="#h40-0-171" id="h40-0-171" class="i">+        }
</a><a href="#h40-0-172" id="h40-0-172" class="i">+        return value
</a><a href="#h40-0-173" id="h40-0-173" class="i">+    }
</a><a href="#h40-0-174" id="h40-0-174" class="i">+}</a><a href="#h40-0-175" id="h40-0-175" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h41" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/util/protobuf/ProtoWriter.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/util/protobuf/ProtoWriter.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/util/protobuf/ProtoWriter.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/util/protobuf/ProtoWriter.kt</a></b>
<a href="#h41-0" id="h41-0" class="h">@@ -0,0 +1,117 @@
</a><a href="#h41-0-0" id="h41-0-0" class="i">+package me.rhunk.snapenhance.core.util.protobuf
</a><a href="#h41-0-1" id="h41-0-1" class="i">+
</a><a href="#h41-0-2" id="h41-0-2" class="i">+import java.io.ByteArrayOutputStream
</a><a href="#h41-0-3" id="h41-0-3" class="i">+
</a><a href="#h41-0-4" id="h41-0-4" class="i">+class ProtoWriter {
</a><a href="#h41-0-5" id="h41-0-5" class="i">+    private val stream: ByteArrayOutputStream = ByteArrayOutputStream()
</a><a href="#h41-0-6" id="h41-0-6" class="i">+
</a><a href="#h41-0-7" id="h41-0-7" class="i">+    private fun writeVarInt(value: Int) {
</a><a href="#h41-0-8" id="h41-0-8" class="i">+        var v = value
</a><a href="#h41-0-9" id="h41-0-9" class="i">+        while (v and -0x80 != 0) {
</a><a href="#h41-0-10" id="h41-0-10" class="i">+            stream.write(v and 0x7F or 0x80)
</a><a href="#h41-0-11" id="h41-0-11" class="i">+            v = v ushr 7
</a><a href="#h41-0-12" id="h41-0-12" class="i">+        }
</a><a href="#h41-0-13" id="h41-0-13" class="i">+        stream.write(v)
</a><a href="#h41-0-14" id="h41-0-14" class="i">+    }
</a><a href="#h41-0-15" id="h41-0-15" class="i">+
</a><a href="#h41-0-16" id="h41-0-16" class="i">+    private fun writeVarLong(value: Long) {
</a><a href="#h41-0-17" id="h41-0-17" class="i">+        var v = value
</a><a href="#h41-0-18" id="h41-0-18" class="i">+        while (v and -0x80L != 0L) {
</a><a href="#h41-0-19" id="h41-0-19" class="i">+            stream.write((v and 0x7FL or 0x80L).toInt())
</a><a href="#h41-0-20" id="h41-0-20" class="i">+            v = v ushr 7
</a><a href="#h41-0-21" id="h41-0-21" class="i">+        }
</a><a href="#h41-0-22" id="h41-0-22" class="i">+        stream.write(v.toInt())
</a><a href="#h41-0-23" id="h41-0-23" class="i">+    }
</a><a href="#h41-0-24" id="h41-0-24" class="i">+
</a><a href="#h41-0-25" id="h41-0-25" class="i">+    fun addBuffer(id: Int, value: ByteArray) {
</a><a href="#h41-0-26" id="h41-0-26" class="i">+        writeVarInt(id shl 3 or WireType.LENGTH_DELIMITED.value)
</a><a href="#h41-0-27" id="h41-0-27" class="i">+        writeVarInt(value.size)
</a><a href="#h41-0-28" id="h41-0-28" class="i">+        stream.write(value)
</a><a href="#h41-0-29" id="h41-0-29" class="i">+    }
</a><a href="#h41-0-30" id="h41-0-30" class="i">+
</a><a href="#h41-0-31" id="h41-0-31" class="i">+    fun addVarInt(id: Int, value: Int) = addVarInt(id, value.toLong())
</a><a href="#h41-0-32" id="h41-0-32" class="i">+
</a><a href="#h41-0-33" id="h41-0-33" class="i">+    fun addVarInt(id: Int, value: Long) {
</a><a href="#h41-0-34" id="h41-0-34" class="i">+        writeVarInt(id shl 3)
</a><a href="#h41-0-35" id="h41-0-35" class="i">+        writeVarLong(value)
</a><a href="#h41-0-36" id="h41-0-36" class="i">+    }
</a><a href="#h41-0-37" id="h41-0-37" class="i">+
</a><a href="#h41-0-38" id="h41-0-38" class="i">+    fun addString(id: Int, value: String) = addBuffer(id, value.toByteArray())
</a><a href="#h41-0-39" id="h41-0-39" class="i">+
</a><a href="#h41-0-40" id="h41-0-40" class="i">+    fun addFixed32(id: Int, value: Int) {
</a><a href="#h41-0-41" id="h41-0-41" class="i">+        writeVarInt(id shl 3 or WireType.FIXED32.value)
</a><a href="#h41-0-42" id="h41-0-42" class="i">+        val bytes = ByteArray(4)
</a><a href="#h41-0-43" id="h41-0-43" class="i">+        for (i in 0..3) {
</a><a href="#h41-0-44" id="h41-0-44" class="i">+            bytes[i] = (value shr (i * 8)).toByte()
</a><a href="#h41-0-45" id="h41-0-45" class="i">+        }
</a><a href="#h41-0-46" id="h41-0-46" class="i">+        stream.write(bytes)
</a><a href="#h41-0-47" id="h41-0-47" class="i">+    }
</a><a href="#h41-0-48" id="h41-0-48" class="i">+
</a><a href="#h41-0-49" id="h41-0-49" class="i">+    fun addFixed64(id: Int, value: Long) {
</a><a href="#h41-0-50" id="h41-0-50" class="i">+        writeVarInt(id shl 3 or WireType.FIXED64.value)
</a><a href="#h41-0-51" id="h41-0-51" class="i">+        val bytes = ByteArray(8)
</a><a href="#h41-0-52" id="h41-0-52" class="i">+        for (i in 0..7) {
</a><a href="#h41-0-53" id="h41-0-53" class="i">+            bytes[i] = (value shr (i * 8)).toByte()
</a><a href="#h41-0-54" id="h41-0-54" class="i">+        }
</a><a href="#h41-0-55" id="h41-0-55" class="i">+        stream.write(bytes)
</a><a href="#h41-0-56" id="h41-0-56" class="i">+    }
</a><a href="#h41-0-57" id="h41-0-57" class="i">+
</a><a href="#h41-0-58" id="h41-0-58" class="i">+    fun from(id: Int, writer: ProtoWriter.() -&gt; Unit) {
</a><a href="#h41-0-59" id="h41-0-59" class="i">+        val writerStream = ProtoWriter()
</a><a href="#h41-0-60" id="h41-0-60" class="i">+        writer(writerStream)
</a><a href="#h41-0-61" id="h41-0-61" class="i">+        addBuffer(id, writerStream.stream.toByteArray())
</a><a href="#h41-0-62" id="h41-0-62" class="i">+    }
</a><a href="#h41-0-63" id="h41-0-63" class="i">+
</a><a href="#h41-0-64" id="h41-0-64" class="i">+    fun from(vararg ids: Int, writer: ProtoWriter.() -&gt; Unit) {
</a><a href="#h41-0-65" id="h41-0-65" class="i">+        val writerStream = ProtoWriter()
</a><a href="#h41-0-66" id="h41-0-66" class="i">+        writer(writerStream)
</a><a href="#h41-0-67" id="h41-0-67" class="i">+        var stream = writerStream.stream.toByteArray()
</a><a href="#h41-0-68" id="h41-0-68" class="i">+        ids.reversed().forEach { id -&gt;
</a><a href="#h41-0-69" id="h41-0-69" class="i">+            with(ProtoWriter()) {
</a><a href="#h41-0-70" id="h41-0-70" class="i">+                addBuffer(id, stream)
</a><a href="#h41-0-71" id="h41-0-71" class="i">+                stream = this.stream.toByteArray()
</a><a href="#h41-0-72" id="h41-0-72" class="i">+            }
</a><a href="#h41-0-73" id="h41-0-73" class="i">+        }
</a><a href="#h41-0-74" id="h41-0-74" class="i">+        stream.let(this.stream::write)
</a><a href="#h41-0-75" id="h41-0-75" class="i">+    }
</a><a href="#h41-0-76" id="h41-0-76" class="i">+
</a><a href="#h41-0-77" id="h41-0-77" class="i">+    fun addWire(wire: Wire) {
</a><a href="#h41-0-78" id="h41-0-78" class="i">+        writeVarInt(wire.id shl 3 or wire.type.value)
</a><a href="#h41-0-79" id="h41-0-79" class="i">+        when (wire.type) {
</a><a href="#h41-0-80" id="h41-0-80" class="i">+            WireType.VARINT -&gt; writeVarLong(wire.value as Long)
</a><a href="#h41-0-81" id="h41-0-81" class="i">+            WireType.FIXED64, WireType.FIXED32 -&gt; {
</a><a href="#h41-0-82" id="h41-0-82" class="i">+                when (wire.value) {
</a><a href="#h41-0-83" id="h41-0-83" class="i">+                    is Int -&gt; {
</a><a href="#h41-0-84" id="h41-0-84" class="i">+                        val bytes = ByteArray(4)
</a><a href="#h41-0-85" id="h41-0-85" class="i">+                        for (i in 0..3) {
</a><a href="#h41-0-86" id="h41-0-86" class="i">+                            bytes[i] = (wire.value shr (i * 8)).toByte()
</a><a href="#h41-0-87" id="h41-0-87" class="i">+                        }
</a><a href="#h41-0-88" id="h41-0-88" class="i">+                        stream.write(bytes)
</a><a href="#h41-0-89" id="h41-0-89" class="i">+                    }
</a><a href="#h41-0-90" id="h41-0-90" class="i">+                    is Long -&gt; {
</a><a href="#h41-0-91" id="h41-0-91" class="i">+                        val bytes = ByteArray(8)
</a><a href="#h41-0-92" id="h41-0-92" class="i">+                        for (i in 0..7) {
</a><a href="#h41-0-93" id="h41-0-93" class="i">+                            bytes[i] = (wire.value shr (i * 8)).toByte()
</a><a href="#h41-0-94" id="h41-0-94" class="i">+                        }
</a><a href="#h41-0-95" id="h41-0-95" class="i">+                        stream.write(bytes)
</a><a href="#h41-0-96" id="h41-0-96" class="i">+                    }
</a><a href="#h41-0-97" id="h41-0-97" class="i">+                    is ByteArray -&gt; stream.write(wire.value)
</a><a href="#h41-0-98" id="h41-0-98" class="i">+                }
</a><a href="#h41-0-99" id="h41-0-99" class="i">+            }
</a><a href="#h41-0-100" id="h41-0-100" class="i">+            WireType.LENGTH_DELIMITED -&gt; {
</a><a href="#h41-0-101" id="h41-0-101" class="i">+                val value = wire.value as ByteArray
</a><a href="#h41-0-102" id="h41-0-102" class="i">+                writeVarInt(value.size)
</a><a href="#h41-0-103" id="h41-0-103" class="i">+                stream.write(value)
</a><a href="#h41-0-104" id="h41-0-104" class="i">+            }
</a><a href="#h41-0-105" id="h41-0-105" class="i">+            WireType.START_GROUP -&gt; {
</a><a href="#h41-0-106" id="h41-0-106" class="i">+                val value = wire.value as ByteArray
</a><a href="#h41-0-107" id="h41-0-107" class="i">+                stream.write(value)
</a><a href="#h41-0-108" id="h41-0-108" class="i">+            }
</a><a href="#h41-0-109" id="h41-0-109" class="i">+            WireType.END_GROUP -&gt; return
</a><a href="#h41-0-110" id="h41-0-110" class="i">+        }
</a><a href="#h41-0-111" id="h41-0-111" class="i">+    }
</a><a href="#h41-0-112" id="h41-0-112" class="i">+
</a><a href="#h41-0-113" id="h41-0-113" class="i">+    fun toByteArray(): ByteArray {
</a><a href="#h41-0-114" id="h41-0-114" class="i">+        return stream.toByteArray()
</a><a href="#h41-0-115" id="h41-0-115" class="i">+    }
</a><a href="#h41-0-116" id="h41-0-116" class="i">+}</a><a href="#h41-0-117" id="h41-0-117" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h42" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/util/protobuf/WireType.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/util/protobuf/WireType.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/util/protobuf/WireType.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/util/protobuf/WireType.kt</a></b>
<a href="#h42-0" id="h42-0" class="h">@@ -0,0 +1,14 @@
</a><a href="#h42-0-0" id="h42-0-0" class="i">+package me.rhunk.snapenhance.core.util.protobuf;
</a><a href="#h42-0-1" id="h42-0-1" class="i">+
</a><a href="#h42-0-2" id="h42-0-2" class="i">+enum class WireType(val value: Int) {
</a><a href="#h42-0-3" id="h42-0-3" class="i">+    VARINT(0),
</a><a href="#h42-0-4" id="h42-0-4" class="i">+    FIXED64(1),
</a><a href="#h42-0-5" id="h42-0-5" class="i">+    LENGTH_DELIMITED(2),
</a><a href="#h42-0-6" id="h42-0-6" class="i">+    START_GROUP(3),
</a><a href="#h42-0-7" id="h42-0-7" class="i">+    END_GROUP(4),
</a><a href="#h42-0-8" id="h42-0-8" class="i">+    FIXED32(5);
</a><a href="#h42-0-9" id="h42-0-9" class="i">+
</a><a href="#h42-0-10" id="h42-0-10" class="i">+    companion object {
</a><a href="#h42-0-11" id="h42-0-11" class="i">+        fun fromValue(value: Int) = values().firstOrNull { it.value == value }
</a><a href="#h42-0-12" id="h42-0-12" class="i">+    }
</a><a href="#h42-0-13" id="h42-0-13" class="i">+}
</a><b>diff --git a/<a id="h43" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/util/snap/BitmojiSelfie.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/util/snap/BitmojiSelfie.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/util/snap/BitmojiSelfie.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/util/snap/BitmojiSelfie.kt</a></b>
<a href="#h43-0" id="h43-0" class="h">@@ -0,0 +1,20 @@
</a><a href="#h43-0-0" id="h43-0-0" class="i">+package me.rhunk.snapenhance.core.util.snap
</a><a href="#h43-0-1" id="h43-0-1" class="i">+
</a><a href="#h43-0-2" id="h43-0-2" class="i">+object BitmojiSelfie {
</a><a href="#h43-0-3" id="h43-0-3" class="i">+    enum class BitmojiSelfieType(
</a><a href="#h43-0-4" id="h43-0-4" class="i">+        val prefixUrl: String,
</a><a href="#h43-0-5" id="h43-0-5" class="i">+    ) {
</a><a href="#h43-0-6" id="h43-0-6" class="i">+        STANDARD(&quot;https://sdk.bitmoji.com/render/panel/&quot;),
</a><a href="#h43-0-7" id="h43-0-7" class="i">+        THREE_D(&quot;https://images.bitmoji.com/3d/render/&quot;)
</a><a href="#h43-0-8" id="h43-0-8" class="i">+    }
</a><a href="#h43-0-9" id="h43-0-9" class="i">+
</a><a href="#h43-0-10" id="h43-0-10" class="i">+    fun getBitmojiSelfie(selfieId: String?, avatarId: String?, type: BitmojiSelfieType): String? {
</a><a href="#h43-0-11" id="h43-0-11" class="i">+        if (selfieId.isNullOrEmpty() || avatarId.isNullOrEmpty()) {
</a><a href="#h43-0-12" id="h43-0-12" class="i">+            return null
</a><a href="#h43-0-13" id="h43-0-13" class="i">+        }
</a><a href="#h43-0-14" id="h43-0-14" class="i">+        return when (type) {
</a><a href="#h43-0-15" id="h43-0-15" class="i">+            BitmojiSelfieType.STANDARD -&gt; &quot;${type.prefixUrl}$selfieId-$avatarId-v1.webp?transparent=1&quot;
</a><a href="#h43-0-16" id="h43-0-16" class="i">+            BitmojiSelfieType.THREE_D -&gt; &quot;${type.prefixUrl}$selfieId-$avatarId-v1.webp?trim=circle&quot;
</a><a href="#h43-0-17" id="h43-0-17" class="i">+        }
</a><a href="#h43-0-18" id="h43-0-18" class="i">+    }
</a><a href="#h43-0-19" id="h43-0-19" class="i">+}</a><a href="#h43-0-20" id="h43-0-20" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h44" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/util/snap/EncryptionHelper.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/util/snap/EncryptionHelper.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/util/snap/EncryptionHelper.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/util/snap/EncryptionHelper.kt</a></b>
<a href="#h44-0" id="h44-0" class="h">@@ -0,0 +1,53 @@
</a><a href="#h44-0-0" id="h44-0-0" class="i">+package me.rhunk.snapenhance.core.util.snap
</a><a href="#h44-0-1" id="h44-0-1" class="i">+
</a><a href="#h44-0-2" id="h44-0-2" class="i">+import me.rhunk.snapenhance.Constants
</a><a href="#h44-0-3" id="h44-0-3" class="i">+import me.rhunk.snapenhance.core.util.protobuf.ProtoReader
</a><a href="#h44-0-4" id="h44-0-4" class="i">+import me.rhunk.snapenhance.data.ContentType
</a><a href="#h44-0-5" id="h44-0-5" class="i">+import java.io.InputStream
</a><a href="#h44-0-6" id="h44-0-6" class="i">+import java.util.Base64
</a><a href="#h44-0-7" id="h44-0-7" class="i">+import javax.crypto.Cipher
</a><a href="#h44-0-8" id="h44-0-8" class="i">+import javax.crypto.CipherInputStream
</a><a href="#h44-0-9" id="h44-0-9" class="i">+import javax.crypto.spec.IvParameterSpec
</a><a href="#h44-0-10" id="h44-0-10" class="i">+import javax.crypto.spec.SecretKeySpec
</a><a href="#h44-0-11" id="h44-0-11" class="i">+
</a><a href="#h44-0-12" id="h44-0-12" class="i">+object EncryptionHelper {
</a><a href="#h44-0-13" id="h44-0-13" class="i">+    fun getEncryptionKeys(contentType: ContentType, messageProto: ProtoReader, isArroyo: Boolean): Pair&lt;ByteArray, ByteArray&gt;? {
</a><a href="#h44-0-14" id="h44-0-14" class="i">+        val mediaEncryptionInfo = MediaDownloaderHelper.getMessageMediaEncryptionInfo(
</a><a href="#h44-0-15" id="h44-0-15" class="i">+            messageProto,
</a><a href="#h44-0-16" id="h44-0-16" class="i">+            contentType,
</a><a href="#h44-0-17" id="h44-0-17" class="i">+            isArroyo
</a><a href="#h44-0-18" id="h44-0-18" class="i">+        ) ?: return null
</a><a href="#h44-0-19" id="h44-0-19" class="i">+        val encryptionProtoIndex = if (mediaEncryptionInfo.contains(Constants.ENCRYPTION_PROTO_INDEX_V2)) {
</a><a href="#h44-0-20" id="h44-0-20" class="i">+            Constants.ENCRYPTION_PROTO_INDEX_V2
</a><a href="#h44-0-21" id="h44-0-21" class="i">+        } else {
</a><a href="#h44-0-22" id="h44-0-22" class="i">+            Constants.ENCRYPTION_PROTO_INDEX
</a><a href="#h44-0-23" id="h44-0-23" class="i">+        }
</a><a href="#h44-0-24" id="h44-0-24" class="i">+        val encryptionProto = mediaEncryptionInfo.followPath(encryptionProtoIndex) ?: return null
</a><a href="#h44-0-25" id="h44-0-25" class="i">+
</a><a href="#h44-0-26" id="h44-0-26" class="i">+        var key: ByteArray = encryptionProto.getByteArray(1)!!
</a><a href="#h44-0-27" id="h44-0-27" class="i">+        var iv: ByteArray = encryptionProto.getByteArray(2)!!
</a><a href="#h44-0-28" id="h44-0-28" class="i">+
</a><a href="#h44-0-29" id="h44-0-29" class="i">+        if (encryptionProtoIndex == Constants.ENCRYPTION_PROTO_INDEX_V2) {
</a><a href="#h44-0-30" id="h44-0-30" class="i">+            val decoder = Base64.getMimeDecoder()
</a><a href="#h44-0-31" id="h44-0-31" class="i">+            key = decoder.decode(key)
</a><a href="#h44-0-32" id="h44-0-32" class="i">+            iv = decoder.decode(iv)
</a><a href="#h44-0-33" id="h44-0-33" class="i">+        }
</a><a href="#h44-0-34" id="h44-0-34" class="i">+
</a><a href="#h44-0-35" id="h44-0-35" class="i">+        return Pair(key, iv)
</a><a href="#h44-0-36" id="h44-0-36" class="i">+    }
</a><a href="#h44-0-37" id="h44-0-37" class="i">+
</a><a href="#h44-0-38" id="h44-0-38" class="i">+    fun decryptInputStream(
</a><a href="#h44-0-39" id="h44-0-39" class="i">+        inputStream: InputStream,
</a><a href="#h44-0-40" id="h44-0-40" class="i">+        contentType: ContentType,
</a><a href="#h44-0-41" id="h44-0-41" class="i">+        messageProto: ProtoReader,
</a><a href="#h44-0-42" id="h44-0-42" class="i">+        isArroyo: Boolean
</a><a href="#h44-0-43" id="h44-0-43" class="i">+    ): InputStream {
</a><a href="#h44-0-44" id="h44-0-44" class="i">+        val encryptionKeys = getEncryptionKeys(contentType, messageProto, isArroyo) ?: throw Exception(&quot;Failed to get encryption keys&quot;)
</a><a href="#h44-0-45" id="h44-0-45" class="i">+
</a><a href="#h44-0-46" id="h44-0-46" class="i">+        Cipher.getInstance(&quot;AES/CBC/PKCS5Padding&quot;).apply {
</a><a href="#h44-0-47" id="h44-0-47" class="i">+            init(Cipher.DECRYPT_MODE, SecretKeySpec(encryptionKeys.first, &quot;AES&quot;), IvParameterSpec(encryptionKeys.second))
</a><a href="#h44-0-48" id="h44-0-48" class="i">+        }.let { cipher -&gt;
</a><a href="#h44-0-49" id="h44-0-49" class="i">+            return CipherInputStream(inputStream, cipher)
</a><a href="#h44-0-50" id="h44-0-50" class="i">+        }
</a><a href="#h44-0-51" id="h44-0-51" class="i">+    }
</a><a href="#h44-0-52" id="h44-0-52" class="i">+}
</a><b>diff --git a/<a id="h45" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/util/snap/MediaDownloaderHelper.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/util/snap/MediaDownloaderHelper.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/util/snap/MediaDownloaderHelper.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/util/snap/MediaDownloaderHelper.kt</a></b>
<a href="#h45-0" id="h45-0" class="h">@@ -0,0 +1,70 @@
</a><a href="#h45-0-0" id="h45-0-0" class="i">+package me.rhunk.snapenhance.core.util.snap
</a><a href="#h45-0-1" id="h45-0-1" class="i">+
</a><a href="#h45-0-2" id="h45-0-2" class="i">+import me.rhunk.snapenhance.Constants
</a><a href="#h45-0-3" id="h45-0-3" class="i">+import me.rhunk.snapenhance.core.download.data.SplitMediaAssetType
</a><a href="#h45-0-4" id="h45-0-4" class="i">+import me.rhunk.snapenhance.core.util.download.RemoteMediaResolver
</a><a href="#h45-0-5" id="h45-0-5" class="i">+import me.rhunk.snapenhance.core.util.protobuf.ProtoReader
</a><a href="#h45-0-6" id="h45-0-6" class="i">+import me.rhunk.snapenhance.data.ContentType
</a><a href="#h45-0-7" id="h45-0-7" class="i">+import me.rhunk.snapenhance.data.FileType
</a><a href="#h45-0-8" id="h45-0-8" class="i">+import java.io.ByteArrayInputStream
</a><a href="#h45-0-9" id="h45-0-9" class="i">+import java.io.FileNotFoundException
</a><a href="#h45-0-10" id="h45-0-10" class="i">+import java.io.InputStream
</a><a href="#h45-0-11" id="h45-0-11" class="i">+import java.util.zip.ZipInputStream
</a><a href="#h45-0-12" id="h45-0-12" class="i">+
</a><a href="#h45-0-13" id="h45-0-13" class="i">+
</a><a href="#h45-0-14" id="h45-0-14" class="i">+object MediaDownloaderHelper {
</a><a href="#h45-0-15" id="h45-0-15" class="i">+    fun getMessageMediaEncryptionInfo(protoReader: ProtoReader, contentType: ContentType, isArroyo: Boolean): ProtoReader? {
</a><a href="#h45-0-16" id="h45-0-16" class="i">+        val messageContainerPath = if (isArroyo) protoReader.followPath(*Constants.ARROYO_MEDIA_CONTAINER_PROTO_PATH)!! else protoReader
</a><a href="#h45-0-17" id="h45-0-17" class="i">+        val mediaContainerPath = if (contentType == ContentType.NOTE) intArrayOf(6, 1, 1) else intArrayOf(5, 1, 1)
</a><a href="#h45-0-18" id="h45-0-18" class="i">+
</a><a href="#h45-0-19" id="h45-0-19" class="i">+        return when (contentType) {
</a><a href="#h45-0-20" id="h45-0-20" class="i">+            ContentType.NOTE -&gt; messageContainerPath.followPath(*mediaContainerPath)
</a><a href="#h45-0-21" id="h45-0-21" class="i">+            ContentType.SNAP -&gt; messageContainerPath.followPath(*(intArrayOf(11) + mediaContainerPath))
</a><a href="#h45-0-22" id="h45-0-22" class="i">+            ContentType.EXTERNAL_MEDIA -&gt; {
</a><a href="#h45-0-23" id="h45-0-23" class="i">+                val externalMediaTypes = arrayOf(
</a><a href="#h45-0-24" id="h45-0-24" class="i">+                    intArrayOf(3, 3, *mediaContainerPath), //normal external media
</a><a href="#h45-0-25" id="h45-0-25" class="i">+                    intArrayOf(7, 15, 1, 1), //attached audio note
</a><a href="#h45-0-26" id="h45-0-26" class="i">+                    intArrayOf(7, 12, 3, *mediaContainerPath), //attached story reply
</a><a href="#h45-0-27" id="h45-0-27" class="i">+                    intArrayOf(7, 3, *mediaContainerPath), //original story reply
</a><a href="#h45-0-28" id="h45-0-28" class="i">+                )
</a><a href="#h45-0-29" id="h45-0-29" class="i">+                externalMediaTypes.forEach { path -&gt;
</a><a href="#h45-0-30" id="h45-0-30" class="i">+                    messageContainerPath.followPath(*path)?.also { return it }
</a><a href="#h45-0-31" id="h45-0-31" class="i">+                }
</a><a href="#h45-0-32" id="h45-0-32" class="i">+                null
</a><a href="#h45-0-33" id="h45-0-33" class="i">+            }
</a><a href="#h45-0-34" id="h45-0-34" class="i">+            else -&gt; null
</a><a href="#h45-0-35" id="h45-0-35" class="i">+        }
</a><a href="#h45-0-36" id="h45-0-36" class="i">+    }
</a><a href="#h45-0-37" id="h45-0-37" class="i">+
</a><a href="#h45-0-38" id="h45-0-38" class="i">+    fun downloadMediaFromReference(
</a><a href="#h45-0-39" id="h45-0-39" class="i">+        mediaReference: ByteArray,
</a><a href="#h45-0-40" id="h45-0-40" class="i">+        decryptionCallback: (InputStream) -&gt; InputStream,
</a><a href="#h45-0-41" id="h45-0-41" class="i">+    ): Map&lt;SplitMediaAssetType, ByteArray&gt; {
</a><a href="#h45-0-42" id="h45-0-42" class="i">+        val inputStream = RemoteMediaResolver.downloadBoltMedia(mediaReference) ?: throw FileNotFoundException(&quot;Unable to get media key. Check the logs for more info&quot;)
</a><a href="#h45-0-43" id="h45-0-43" class="i">+        val content = decryptionCallback(inputStream).readBytes()
</a><a href="#h45-0-44" id="h45-0-44" class="i">+        val fileType = FileType.fromByteArray(content)
</a><a href="#h45-0-45" id="h45-0-45" class="i">+        val isZipFile = fileType == FileType.ZIP
</a><a href="#h45-0-46" id="h45-0-46" class="i">+
</a><a href="#h45-0-47" id="h45-0-47" class="i">+        //videos with overlay are packed in a zip file
</a><a href="#h45-0-48" id="h45-0-48" class="i">+        //there are 2 files in the zip file, the video (webm) and the overlay (png)
</a><a href="#h45-0-49" id="h45-0-49" class="i">+        if (isZipFile) {
</a><a href="#h45-0-50" id="h45-0-50" class="i">+            var videoData: ByteArray? = null
</a><a href="#h45-0-51" id="h45-0-51" class="i">+            var overlayData: ByteArray? = null
</a><a href="#h45-0-52" id="h45-0-52" class="i">+            val zipInputStream = ZipInputStream(ByteArrayInputStream(content))
</a><a href="#h45-0-53" id="h45-0-53" class="i">+            while (zipInputStream.nextEntry != null) {
</a><a href="#h45-0-54" id="h45-0-54" class="i">+                val zipEntryData: ByteArray = zipInputStream.readBytes()
</a><a href="#h45-0-55" id="h45-0-55" class="i">+                val entryFileType = FileType.fromByteArray(zipEntryData)
</a><a href="#h45-0-56" id="h45-0-56" class="i">+                if (entryFileType.isVideo) {
</a><a href="#h45-0-57" id="h45-0-57" class="i">+                    videoData = zipEntryData
</a><a href="#h45-0-58" id="h45-0-58" class="i">+                } else if (entryFileType.isImage) {
</a><a href="#h45-0-59" id="h45-0-59" class="i">+                    overlayData = zipEntryData
</a><a href="#h45-0-60" id="h45-0-60" class="i">+                }
</a><a href="#h45-0-61" id="h45-0-61" class="i">+            }
</a><a href="#h45-0-62" id="h45-0-62" class="i">+            videoData ?: throw FileNotFoundException(&quot;Unable to find video file in zip file&quot;)
</a><a href="#h45-0-63" id="h45-0-63" class="i">+            overlayData ?: throw FileNotFoundException(&quot;Unable to find overlay file in zip file&quot;)
</a><a href="#h45-0-64" id="h45-0-64" class="i">+            return mapOf(SplitMediaAssetType.ORIGINAL to videoData, SplitMediaAssetType.OVERLAY to overlayData)
</a><a href="#h45-0-65" id="h45-0-65" class="i">+        }
</a><a href="#h45-0-66" id="h45-0-66" class="i">+
</a><a href="#h45-0-67" id="h45-0-67" class="i">+        return mapOf(SplitMediaAssetType.ORIGINAL to content)
</a><a href="#h45-0-68" id="h45-0-68" class="i">+    }
</a><a href="#h45-0-69" id="h45-0-69" class="i">+}</a><a href="#h45-0-70" id="h45-0-70" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h46" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/util/snap/PreviewUtils.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/util/snap/PreviewUtils.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/util/snap/PreviewUtils.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/util/snap/PreviewUtils.kt</a></b>
<a href="#h46-0" id="h46-0" class="h">@@ -0,0 +1,87 @@
</a><a href="#h46-0-0" id="h46-0-0" class="i">+package me.rhunk.snapenhance.core.util.snap
</a><a href="#h46-0-1" id="h46-0-1" class="i">+
</a><a href="#h46-0-2" id="h46-0-2" class="i">+import android.graphics.Bitmap
</a><a href="#h46-0-3" id="h46-0-3" class="i">+import android.graphics.BitmapFactory
</a><a href="#h46-0-4" id="h46-0-4" class="i">+import android.graphics.Canvas
</a><a href="#h46-0-5" id="h46-0-5" class="i">+import android.graphics.Matrix
</a><a href="#h46-0-6" id="h46-0-6" class="i">+import android.media.MediaDataSource
</a><a href="#h46-0-7" id="h46-0-7" class="i">+import android.media.MediaMetadataRetriever
</a><a href="#h46-0-8" id="h46-0-8" class="i">+import me.rhunk.snapenhance.data.FileType
</a><a href="#h46-0-9" id="h46-0-9" class="i">+import java.io.File
</a><a href="#h46-0-10" id="h46-0-10" class="i">+
</a><a href="#h46-0-11" id="h46-0-11" class="i">+object PreviewUtils {
</a><a href="#h46-0-12" id="h46-0-12" class="i">+    fun createPreview(data: ByteArray, isVideo: Boolean): Bitmap? {
</a><a href="#h46-0-13" id="h46-0-13" class="i">+        if (!isVideo) {
</a><a href="#h46-0-14" id="h46-0-14" class="i">+            return BitmapFactory.decodeByteArray(data, 0, data.size)
</a><a href="#h46-0-15" id="h46-0-15" class="i">+        }
</a><a href="#h46-0-16" id="h46-0-16" class="i">+        return MediaMetadataRetriever().apply {
</a><a href="#h46-0-17" id="h46-0-17" class="i">+            setDataSource(object : MediaDataSource() {
</a><a href="#h46-0-18" id="h46-0-18" class="i">+                override fun readAt(
</a><a href="#h46-0-19" id="h46-0-19" class="i">+                    position: Long,
</a><a href="#h46-0-20" id="h46-0-20" class="i">+                    buffer: ByteArray,
</a><a href="#h46-0-21" id="h46-0-21" class="i">+                    offset: Int,
</a><a href="#h46-0-22" id="h46-0-22" class="i">+                    size: Int
</a><a href="#h46-0-23" id="h46-0-23" class="i">+                ): Int {
</a><a href="#h46-0-24" id="h46-0-24" class="i">+                    var newSize = size
</a><a href="#h46-0-25" id="h46-0-25" class="i">+                    val length = data.size
</a><a href="#h46-0-26" id="h46-0-26" class="i">+                    if (position &gt;= length) {
</a><a href="#h46-0-27" id="h46-0-27" class="i">+                        return -1
</a><a href="#h46-0-28" id="h46-0-28" class="i">+                    }
</a><a href="#h46-0-29" id="h46-0-29" class="i">+                    if (position + newSize &gt; length) {
</a><a href="#h46-0-30" id="h46-0-30" class="i">+                        newSize = length - position.toInt()
</a><a href="#h46-0-31" id="h46-0-31" class="i">+                    }
</a><a href="#h46-0-32" id="h46-0-32" class="i">+                    System.arraycopy(data, position.toInt(), buffer, offset, newSize)
</a><a href="#h46-0-33" id="h46-0-33" class="i">+                    return newSize
</a><a href="#h46-0-34" id="h46-0-34" class="i">+                }
</a><a href="#h46-0-35" id="h46-0-35" class="i">+
</a><a href="#h46-0-36" id="h46-0-36" class="i">+                override fun getSize(): Long {
</a><a href="#h46-0-37" id="h46-0-37" class="i">+                    return data.size.toLong()
</a><a href="#h46-0-38" id="h46-0-38" class="i">+                }
</a><a href="#h46-0-39" id="h46-0-39" class="i">+                override fun close() {}
</a><a href="#h46-0-40" id="h46-0-40" class="i">+            })
</a><a href="#h46-0-41" id="h46-0-41" class="i">+        }.getFrameAtTime(0, MediaMetadataRetriever.OPTION_CLOSEST_SYNC)
</a><a href="#h46-0-42" id="h46-0-42" class="i">+    }
</a><a href="#h46-0-43" id="h46-0-43" class="i">+
</a><a href="#h46-0-44" id="h46-0-44" class="i">+    fun createPreviewFromFile(file: File): Bitmap? {
</a><a href="#h46-0-45" id="h46-0-45" class="i">+        return if (FileType.fromFile(file).isVideo) {
</a><a href="#h46-0-46" id="h46-0-46" class="i">+            MediaMetadataRetriever().apply {
</a><a href="#h46-0-47" id="h46-0-47" class="i">+                setDataSource(file.absolutePath)
</a><a href="#h46-0-48" id="h46-0-48" class="i">+            }.getFrameAtTime(0, MediaMetadataRetriever.OPTION_CLOSEST_SYNC)
</a><a href="#h46-0-49" id="h46-0-49" class="i">+        } else {
</a><a href="#h46-0-50" id="h46-0-50" class="i">+            BitmapFactory.decodeFile(file.absolutePath, BitmapFactory.Options())
</a><a href="#h46-0-51" id="h46-0-51" class="i">+        }
</a><a href="#h46-0-52" id="h46-0-52" class="i">+    }
</a><a href="#h46-0-53" id="h46-0-53" class="i">+
</a><a href="#h46-0-54" id="h46-0-54" class="i">+    private fun resizeBitmap(bitmap: Bitmap, outWidth: Int, outHeight: Int): Bitmap? {
</a><a href="#h46-0-55" id="h46-0-55" class="i">+        val scaleWidth = outWidth.toFloat() / bitmap.width
</a><a href="#h46-0-56" id="h46-0-56" class="i">+        val scaleHeight = outHeight.toFloat() / bitmap.height
</a><a href="#h46-0-57" id="h46-0-57" class="i">+        val matrix = Matrix()
</a><a href="#h46-0-58" id="h46-0-58" class="i">+        matrix.postScale(scaleWidth, scaleHeight)
</a><a href="#h46-0-59" id="h46-0-59" class="i">+        val resizedBitmap = Bitmap.createBitmap(bitmap, 0, 0, bitmap.width, bitmap.height, matrix, false)
</a><a href="#h46-0-60" id="h46-0-60" class="i">+        bitmap.recycle()
</a><a href="#h46-0-61" id="h46-0-61" class="i">+        return resizedBitmap
</a><a href="#h46-0-62" id="h46-0-62" class="i">+    }
</a><a href="#h46-0-63" id="h46-0-63" class="i">+
</a><a href="#h46-0-64" id="h46-0-64" class="i">+    fun mergeBitmapOverlay(originalMedia: Bitmap, overlayLayer: Bitmap): Bitmap {
</a><a href="#h46-0-65" id="h46-0-65" class="i">+        val biggestBitmap = if (originalMedia.width * originalMedia.height &gt; overlayLayer.width * overlayLayer.height) originalMedia else overlayLayer
</a><a href="#h46-0-66" id="h46-0-66" class="i">+        val smallestBitmap = if (biggestBitmap == originalMedia) overlayLayer else originalMedia
</a><a href="#h46-0-67" id="h46-0-67" class="i">+
</a><a href="#h46-0-68" id="h46-0-68" class="i">+        val mergedBitmap = Bitmap.createBitmap(biggestBitmap.width, biggestBitmap.height, biggestBitmap.config)
</a><a href="#h46-0-69" id="h46-0-69" class="i">+
</a><a href="#h46-0-70" id="h46-0-70" class="i">+        with(Canvas(mergedBitmap)) {
</a><a href="#h46-0-71" id="h46-0-71" class="i">+            val scaleMatrix = Matrix().apply {
</a><a href="#h46-0-72" id="h46-0-72" class="i">+                postScale(biggestBitmap.width.toFloat() / smallestBitmap.width.toFloat(), biggestBitmap.height.toFloat() / smallestBitmap.height.toFloat())
</a><a href="#h46-0-73" id="h46-0-73" class="i">+            }
</a><a href="#h46-0-74" id="h46-0-74" class="i">+
</a><a href="#h46-0-75" id="h46-0-75" class="i">+            if (biggestBitmap == originalMedia) {
</a><a href="#h46-0-76" id="h46-0-76" class="i">+                drawBitmap(originalMedia, 0f, 0f, null)
</a><a href="#h46-0-77" id="h46-0-77" class="i">+                drawBitmap(overlayLayer, scaleMatrix, null)
</a><a href="#h46-0-78" id="h46-0-78" class="i">+            } else {
</a><a href="#h46-0-79" id="h46-0-79" class="i">+                drawBitmap(originalMedia, scaleMatrix, null)
</a><a href="#h46-0-80" id="h46-0-80" class="i">+                drawBitmap(overlayLayer, 0f, 0f, null)
</a><a href="#h46-0-81" id="h46-0-81" class="i">+            }
</a><a href="#h46-0-82" id="h46-0-82" class="i">+        }
</a><a href="#h46-0-83" id="h46-0-83" class="i">+
</a><a href="#h46-0-84" id="h46-0-84" class="i">+        return mergedBitmap
</a><a href="#h46-0-85" id="h46-0-85" class="i">+    }
</a><a href="#h46-0-86" id="h46-0-86" class="i">+}
</a><b>diff --git a/<a id="h47" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/util/snap/SnapWidgetBroadcastReceiverHelper.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/util/snap/SnapWidgetBroadcastReceiverHelper.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/util/snap/SnapWidgetBroadcastReceiverHelper.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/util/snap/SnapWidgetBroadcastReceiverHelper.kt</a></b>
<a href="#h47-0" id="h47-0" class="h">@@ -0,0 +1,24 @@
</a><a href="#h47-0-0" id="h47-0-0" class="i">+package me.rhunk.snapenhance.core.util.snap
</a><a href="#h47-0-1" id="h47-0-1" class="i">+
</a><a href="#h47-0-2" id="h47-0-2" class="i">+import android.content.Intent
</a><a href="#h47-0-3" id="h47-0-3" class="i">+import me.rhunk.snapenhance.Constants
</a><a href="#h47-0-4" id="h47-0-4" class="i">+
</a><a href="#h47-0-5" id="h47-0-5" class="i">+object SnapWidgetBroadcastReceiverHelper {
</a><a href="#h47-0-6" id="h47-0-6" class="i">+    private const val ACTION_WIDGET_UPDATE = &quot;com.snap.android.WIDGET_APP_START_UPDATE_ACTION&quot;
</a><a href="#h47-0-7" id="h47-0-7" class="i">+    const val CLASS_NAME = &quot;com.snap.widgets.core.BestFriendsWidgetProvider&quot;
</a><a href="#h47-0-8" id="h47-0-8" class="i">+
</a><a href="#h47-0-9" id="h47-0-9" class="i">+    fun create(targetAction: String, callback: Intent.() -&gt; Unit): Intent {
</a><a href="#h47-0-10" id="h47-0-10" class="i">+        with(Intent()) {
</a><a href="#h47-0-11" id="h47-0-11" class="i">+            callback(this)
</a><a href="#h47-0-12" id="h47-0-12" class="i">+            action = ACTION_WIDGET_UPDATE
</a><a href="#h47-0-13" id="h47-0-13" class="i">+            putExtra(&quot;:)&quot;, true)
</a><a href="#h47-0-14" id="h47-0-14" class="i">+            putExtra(&quot;action&quot;, targetAction)
</a><a href="#h47-0-15" id="h47-0-15" class="i">+            setClassName(Constants.SNAPCHAT_PACKAGE_NAME, CLASS_NAME)
</a><a href="#h47-0-16" id="h47-0-16" class="i">+            return this
</a><a href="#h47-0-17" id="h47-0-17" class="i">+        }
</a><a href="#h47-0-18" id="h47-0-18" class="i">+    }
</a><a href="#h47-0-19" id="h47-0-19" class="i">+
</a><a href="#h47-0-20" id="h47-0-20" class="i">+    fun isIncomingIntentValid(intent: Intent): Boolean {
</a><a href="#h47-0-21" id="h47-0-21" class="i">+        return intent.action == ACTION_WIDGET_UPDATE &amp;&amp; intent.getBooleanExtra(&quot;:)&quot;, false)
</a><a href="#h47-0-22" id="h47-0-22" class="i">+    }
</a><a href="#h47-0-23" id="h47-0-23" class="i">+}</a><a href="#h47-0-24" id="h47-0-24" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h48" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/data/FileType.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/data/FileType.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/data/FileType.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/data/FileType.kt</a></b>
<a href="#h48-0" id="h48-0" class="h">@@ -1,6 +1,6 @@
</a> package me.rhunk.snapenhance.data
 
<a href="#h48-0-2" id="h48-0-2" class="d">-import me.rhunk.snapenhance.Logger
</a><a href="#h48-0-3" id="h48-0-3" class="i">+import me.rhunk.snapenhance.core.Logger
</a> import java.io.File
 import java.io.InputStream
 
<b>diff --git a/<a id="h49" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/data/MessageSender.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/data/MessageSender.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/data/MessageSender.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/data/MessageSender.kt</a></b>
<a href="#h49-0" id="h49-0" class="h">@@ -1,12 +1,12 @@
</a> package me.rhunk.snapenhance.data
 
 import me.rhunk.snapenhance.ModContext
<a href="#h49-0-3" id="h49-0-3" class="i">+import me.rhunk.snapenhance.core.util.CallbackBuilder
</a><a href="#h49-0-4" id="h49-0-4" class="i">+import me.rhunk.snapenhance.core.util.protobuf.ProtoWriter
</a> import me.rhunk.snapenhance.data.wrapper.AbstractWrapper
 import me.rhunk.snapenhance.data.wrapper.impl.MessageDestinations
 import me.rhunk.snapenhance.data.wrapper.impl.SnapUUID
 import me.rhunk.snapenhance.features.impl.Messaging
<a href="#h49-0-9" id="h49-0-9" class="d">-import me.rhunk.snapenhance.util.CallbackBuilder
</a><a href="#h49-0-10" id="h49-0-10" class="d">-import me.rhunk.snapenhance.util.protobuf.ProtoWriter
</a> 
 class MessageSender(
     private val context: ModContext,
<b>diff --git a/<a id="h50" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/AbstractWrapper.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/AbstractWrapper.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/AbstractWrapper.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/AbstractWrapper.kt</a></b>
<a href="#h50-0" id="h50-0" class="h">@@ -1,7 +1,7 @@
</a> package me.rhunk.snapenhance.data.wrapper
 
 import de.robv.android.xposed.XposedHelpers
<a href="#h50-0-3" id="h50-0-3" class="d">-import me.rhunk.snapenhance.util.CallbackBuilder
</a><a href="#h50-0-4" id="h50-0-4" class="i">+import me.rhunk.snapenhance.core.util.CallbackBuilder
</a> import kotlin.reflect.KProperty
 
 abstract class AbstractWrapper(
<b>diff --git a/<a id="h51" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/Message.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/Message.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/Message.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/Message.kt</a></b>
<a href="#h51-0" id="h51-0" class="h">@@ -1,8 +1,8 @@
</a> package me.rhunk.snapenhance.data.wrapper.impl
 
<a href="#h51-0-2" id="h51-0-2" class="i">+import me.rhunk.snapenhance.core.util.ktx.getObjectField
</a> import me.rhunk.snapenhance.data.MessageState
 import me.rhunk.snapenhance.data.wrapper.AbstractWrapper
<a href="#h51-0-5" id="h51-0-5" class="d">-import me.rhunk.snapenhance.util.ktx.getObjectField
</a> 
 class Message(obj: Any?) : AbstractWrapper(obj) {
     val orderKey get() = instanceNonNull().getObjectField(&quot;mOrderKey&quot;) as Long
<b>diff --git a/<a id="h52" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/MessageContent.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/MessageContent.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/MessageContent.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/MessageContent.kt</a></b>
<a href="#h52-0" id="h52-0" class="h">@@ -1,9 +1,9 @@
</a> package me.rhunk.snapenhance.data.wrapper.impl
 
<a href="#h52-0-2" id="h52-0-2" class="i">+import me.rhunk.snapenhance.core.util.ktx.getObjectField
</a><a href="#h52-0-3" id="h52-0-3" class="i">+import me.rhunk.snapenhance.core.util.ktx.setObjectField
</a> import me.rhunk.snapenhance.data.ContentType
 import me.rhunk.snapenhance.data.wrapper.AbstractWrapper
<a href="#h52-0-6" id="h52-0-6" class="d">-import me.rhunk.snapenhance.util.ktx.getObjectField
</a><a href="#h52-0-7" id="h52-0-7" class="d">-import me.rhunk.snapenhance.util.ktx.setObjectField
</a> 
 class MessageContent(obj: Any?) : AbstractWrapper(obj) {
     var content
<b>diff --git a/<a id="h53" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/MessageDescriptor.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/MessageDescriptor.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/MessageDescriptor.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/MessageDescriptor.kt</a></b>
<a href="#h53-0" id="h53-0" class="h">@@ -1,7 +1,7 @@
</a> package me.rhunk.snapenhance.data.wrapper.impl
 
<a href="#h53-0-2" id="h53-0-2" class="i">+import me.rhunk.snapenhance.core.util.ktx.getObjectField
</a> import me.rhunk.snapenhance.data.wrapper.AbstractWrapper
<a href="#h53-0-4" id="h53-0-4" class="d">-import me.rhunk.snapenhance.util.ktx.getObjectField
</a> 
 class MessageDescriptor(obj: Any?) : AbstractWrapper(obj) {
     val messageId: Long get() = instanceNonNull().getObjectField(&quot;mMessageId&quot;) as Long
<b>diff --git a/<a id="h54" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/MessageDestinations.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/MessageDestinations.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/MessageDestinations.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/MessageDestinations.kt</a></b>
<a href="#h54-0" id="h54-0" class="h">@@ -1,8 +1,8 @@
</a> package me.rhunk.snapenhance.data.wrapper.impl
 
<a href="#h54-0-2" id="h54-0-2" class="i">+import me.rhunk.snapenhance.core.util.ktx.getObjectField
</a><a href="#h54-0-3" id="h54-0-3" class="i">+import me.rhunk.snapenhance.core.util.ktx.setObjectField
</a> import me.rhunk.snapenhance.data.wrapper.AbstractWrapper
<a href="#h54-0-5" id="h54-0-5" class="d">-import me.rhunk.snapenhance.util.ktx.getObjectField
</a><a href="#h54-0-6" id="h54-0-6" class="d">-import me.rhunk.snapenhance.util.ktx.setObjectField
</a> 
 @Suppress(&quot;UNCHECKED_CAST&quot;)
 class MessageDestinations(obj: Any) : AbstractWrapper(obj){
<b>diff --git a/<a id="h55" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/MessageMetadata.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/MessageMetadata.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/MessageMetadata.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/MessageMetadata.kt</a></b>
<a href="#h55-0" id="h55-0" class="h">@@ -1,8 +1,8 @@
</a> package me.rhunk.snapenhance.data.wrapper.impl
 
<a href="#h55-0-2" id="h55-0-2" class="i">+import me.rhunk.snapenhance.core.util.ktx.getObjectField
</a> import me.rhunk.snapenhance.data.PlayableSnapState
 import me.rhunk.snapenhance.data.wrapper.AbstractWrapper
<a href="#h55-0-5" id="h55-0-5" class="d">-import me.rhunk.snapenhance.util.ktx.getObjectField
</a> 
 class MessageMetadata(obj: Any?) : AbstractWrapper(obj){
     val createdAt: Long get() = instanceNonNull().getObjectField(&quot;mCreatedAt&quot;) as Long
<b>diff --git a/<a id="h56" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/SnapUUID.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/SnapUUID.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/SnapUUID.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/SnapUUID.kt</a></b>
<a href="#h56-0" id="h56-0" class="h">@@ -1,8 +1,8 @@
</a> package me.rhunk.snapenhance.data.wrapper.impl
 
 import me.rhunk.snapenhance.SnapEnhance
<a href="#h56-0-3" id="h56-0-3" class="i">+import me.rhunk.snapenhance.core.util.ktx.getObjectField
</a> import me.rhunk.snapenhance.data.wrapper.AbstractWrapper
<a href="#h56-0-5" id="h56-0-5" class="d">-import me.rhunk.snapenhance.util.ktx.getObjectField
</a> import java.nio.ByteBuffer
 import java.util.UUID
 
<b>diff --git a/<a id="h57" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/UserIdToReaction.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/UserIdToReaction.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/UserIdToReaction.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/UserIdToReaction.kt</a></b>
<a href="#h57-0" id="h57-0" class="h">@@ -1,7 +1,7 @@
</a> package me.rhunk.snapenhance.data.wrapper.impl
 
<a href="#h57-0-2" id="h57-0-2" class="i">+import me.rhunk.snapenhance.core.util.ktx.getObjectField
</a> import me.rhunk.snapenhance.data.wrapper.AbstractWrapper
<a href="#h57-0-4" id="h57-0-4" class="d">-import me.rhunk.snapenhance.util.ktx.getObjectField
</a> 
 class UserIdToReaction(obj: Any?) : AbstractWrapper(obj) {
     val userId = SnapUUID(instanceNonNull().getObjectField(&quot;mUserId&quot;))
<b>diff --git a/<a id="h58" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/media/MediaInfo.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/media/MediaInfo.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/media/MediaInfo.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/media/MediaInfo.kt</a></b>
<a href="#h58-0" id="h58-0" class="h">@@ -1,8 +1,8 @@
</a> package me.rhunk.snapenhance.data.wrapper.impl.media
 
 import android.os.Parcelable
<a href="#h58-0-3" id="h58-0-3" class="i">+import me.rhunk.snapenhance.core.util.ktx.getObjectField
</a> import me.rhunk.snapenhance.data.wrapper.AbstractWrapper
<a href="#h58-0-5" id="h58-0-5" class="d">-import me.rhunk.snapenhance.util.ktx.getObjectField
</a> import java.lang.reflect.Field
 
 
<b>diff --git a/<a id="h59" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/media/opera/Layer.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/media/opera/Layer.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/media/opera/Layer.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/media/opera/Layer.kt</a></b>
<a href="#h59-0" id="h59-0" class="h">@@ -1,7 +1,7 @@
</a> package me.rhunk.snapenhance.data.wrapper.impl.media.opera
 
<a href="#h59-0-2" id="h59-0-2" class="i">+import me.rhunk.snapenhance.core.util.ReflectionHelper
</a> import me.rhunk.snapenhance.data.wrapper.AbstractWrapper
<a href="#h59-0-4" id="h59-0-4" class="d">-import me.rhunk.snapenhance.util.ReflectionHelper
</a> 
 class Layer(obj: Any?) : AbstractWrapper(obj) {
     val paramMap: ParamMap
<b>diff --git a/<a id="h60" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/media/opera/LayerController.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/media/opera/LayerController.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/media/opera/LayerController.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/media/opera/LayerController.kt</a></b>
<a href="#h60-0" id="h60-0" class="h">@@ -1,8 +1,8 @@
</a> package me.rhunk.snapenhance.data.wrapper.impl.media.opera
 
 import de.robv.android.xposed.XposedHelpers
<a href="#h60-0-3" id="h60-0-3" class="i">+import me.rhunk.snapenhance.core.util.ReflectionHelper
</a> import me.rhunk.snapenhance.data.wrapper.AbstractWrapper
<a href="#h60-0-5" id="h60-0-5" class="d">-import me.rhunk.snapenhance.util.ReflectionHelper
</a> import java.lang.reflect.Field
 import java.util.concurrent.ConcurrentHashMap
 
<b>diff --git a/<a id="h61" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/media/opera/ParamMap.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/media/opera/ParamMap.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/media/opera/ParamMap.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/media/opera/ParamMap.kt</a></b>
<a href="#h61-0" id="h61-0" class="h">@@ -1,8 +1,8 @@
</a> package me.rhunk.snapenhance.data.wrapper.impl.media.opera
 
<a href="#h61-0-2" id="h61-0-2" class="i">+import me.rhunk.snapenhance.core.util.ReflectionHelper
</a><a href="#h61-0-3" id="h61-0-3" class="i">+import me.rhunk.snapenhance.core.util.ktx.getObjectField
</a> import me.rhunk.snapenhance.data.wrapper.AbstractWrapper
<a href="#h61-0-5" id="h61-0-5" class="d">-import me.rhunk.snapenhance.util.ReflectionHelper
</a><a href="#h61-0-6" id="h61-0-6" class="d">-import me.rhunk.snapenhance.util.ktx.getObjectField
</a> import java.lang.reflect.Field
 import java.util.concurrent.ConcurrentHashMap
 
<b>diff --git a/<a id="h62" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/ConfigurationOverride.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/ConfigurationOverride.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/ConfigurationOverride.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/ConfigurationOverride.kt</a></b>
<a href="#h62-0" id="h62-0" class="h">@@ -1,11 +1,11 @@
</a> package me.rhunk.snapenhance.features.impl
 
 import de.robv.android.xposed.XposedHelpers
<a href="#h62-0-3" id="h62-0-3" class="i">+import me.rhunk.snapenhance.core.util.ktx.setObjectField
</a> import me.rhunk.snapenhance.features.Feature
 import me.rhunk.snapenhance.features.FeatureLoadParams
 import me.rhunk.snapenhance.hook.HookStage
 import me.rhunk.snapenhance.hook.hook
<a href="#h62-0-8" id="h62-0-8" class="d">-import me.rhunk.snapenhance.util.ktx.setObjectField
</a> 
 class ConfigurationOverride : Feature(&quot;Configuration Override&quot;, loadParams = FeatureLoadParams.INIT_SYNC) {
     override fun init() {
<b>diff --git a/<a id="h63" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/Messaging.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/Messaging.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/Messaging.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/Messaging.kt</a></b>
<a href="#h63-0" id="h63-0" class="h">@@ -1,6 +1,7 @@
</a> package me.rhunk.snapenhance.features.impl
 
 import me.rhunk.snapenhance.core.eventbus.events.impl.OnSnapInteractionEvent
<a href="#h63-0-3" id="h63-0-3" class="i">+import me.rhunk.snapenhance.core.util.ktx.getObjectField
</a> import me.rhunk.snapenhance.data.wrapper.impl.SnapUUID
 import me.rhunk.snapenhance.features.Feature
 import me.rhunk.snapenhance.features.FeatureLoadParams
<a href="#h63-1" id="h63-1" class="h">@@ -8,7 +9,6 @@ import me.rhunk.snapenhance.features.impl.spying.StealthMode
</a> import me.rhunk.snapenhance.hook.HookStage
 import me.rhunk.snapenhance.hook.Hooker
 import me.rhunk.snapenhance.hook.hook
<a href="#h63-1-3" id="h63-1-3" class="d">-import me.rhunk.snapenhance.util.ktx.getObjectField
</a> 
 class Messaging : Feature(&quot;Messaging&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_SYNC or FeatureLoadParams.INIT_ASYNC or FeatureLoadParams.INIT_SYNC) {
     lateinit var conversationManager: Any
<b>diff --git a/<a id="h64" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/MediaDownloader.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/MediaDownloader.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/MediaDownloader.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/MediaDownloader.kt</a></b>
<a href="#h64-0" id="h64-0" class="h">@@ -16,6 +16,13 @@ import me.rhunk.snapenhance.core.download.data.MediaDownloadSource
</a> import me.rhunk.snapenhance.core.download.data.SplitMediaAssetType
 import me.rhunk.snapenhance.core.download.data.toKeyPair
 import me.rhunk.snapenhance.core.messaging.MessagingRuleType
<a href="#h64-0-3" id="h64-0-3" class="i">+import me.rhunk.snapenhance.core.util.download.RemoteMediaResolver
</a><a href="#h64-0-4" id="h64-0-4" class="i">+import me.rhunk.snapenhance.core.util.ktx.getObjectField
</a><a href="#h64-0-5" id="h64-0-5" class="i">+import me.rhunk.snapenhance.core.util.protobuf.ProtoReader
</a><a href="#h64-0-6" id="h64-0-6" class="i">+import me.rhunk.snapenhance.core.util.snap.BitmojiSelfie
</a><a href="#h64-0-7" id="h64-0-7" class="i">+import me.rhunk.snapenhance.core.util.snap.EncryptionHelper
</a><a href="#h64-0-8" id="h64-0-8" class="i">+import me.rhunk.snapenhance.core.util.snap.MediaDownloaderHelper
</a><a href="#h64-0-9" id="h64-0-9" class="i">+import me.rhunk.snapenhance.core.util.snap.PreviewUtils
</a> import me.rhunk.snapenhance.data.ContentType
 import me.rhunk.snapenhance.data.FileType
 import me.rhunk.snapenhance.data.wrapper.impl.media.MediaInfo
<a href="#h64-1" id="h64-1" class="h">@@ -31,13 +38,6 @@ import me.rhunk.snapenhance.hook.HookAdapter
</a> import me.rhunk.snapenhance.hook.HookStage
 import me.rhunk.snapenhance.hook.Hooker
 import me.rhunk.snapenhance.ui.ViewAppearanceHelper
<a href="#h64-1-3" id="h64-1-3" class="d">-import me.rhunk.snapenhance.util.download.RemoteMediaResolver
</a><a href="#h64-1-4" id="h64-1-4" class="d">-import me.rhunk.snapenhance.util.ktx.getObjectField
</a><a href="#h64-1-5" id="h64-1-5" class="d">-import me.rhunk.snapenhance.util.protobuf.ProtoReader
</a><a href="#h64-1-6" id="h64-1-6" class="d">-import me.rhunk.snapenhance.util.snap.BitmojiSelfie
</a><a href="#h64-1-7" id="h64-1-7" class="d">-import me.rhunk.snapenhance.util.snap.EncryptionHelper
</a><a href="#h64-1-8" id="h64-1-8" class="d">-import me.rhunk.snapenhance.util.snap.MediaDownloaderHelper
</a><a href="#h64-1-9" id="h64-1-9" class="d">-import me.rhunk.snapenhance.util.snap.PreviewUtils
</a> import java.nio.file.Paths
 import java.text.SimpleDateFormat
 import java.util.Locale
<b>diff --git a/<a id="h65" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/ProfilePictureDownloader.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/ProfilePictureDownloader.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/ProfilePictureDownloader.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/ProfilePictureDownloader.kt</a></b>
<a href="#h65-0" id="h65-0" class="h">@@ -5,12 +5,12 @@ import android.widget.Button
</a> import android.widget.RelativeLayout
 import me.rhunk.snapenhance.core.eventbus.events.impl.AddViewEvent
 import me.rhunk.snapenhance.core.eventbus.events.impl.NetworkApiRequestEvent
<a href="#h65-0-3" id="h65-0-3" class="i">+import me.rhunk.snapenhance.core.util.protobuf.ProtoReader
</a> import me.rhunk.snapenhance.features.Feature
 import me.rhunk.snapenhance.features.FeatureLoadParams
 import me.rhunk.snapenhance.hook.HookStage
 import me.rhunk.snapenhance.hook.Hooker
 import me.rhunk.snapenhance.ui.ViewAppearanceHelper
<a href="#h65-0-9" id="h65-0-9" class="d">-import me.rhunk.snapenhance.util.protobuf.ProtoReader
</a> import java.nio.ByteBuffer
 
 class ProfilePictureDownloader : Feature(&quot;ProfilePictureDownloader&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_ASYNC) {
<b>diff --git a/<a id="h66" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/experiments/UnlimitedMultiSnap.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/experiments/UnlimitedMultiSnap.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/experiments/UnlimitedMultiSnap.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/experiments/UnlimitedMultiSnap.kt</a></b>
<a href="#h66-0" id="h66-0" class="h">@@ -1,10 +1,10 @@
</a> package me.rhunk.snapenhance.features.impl.experiments
 
<a href="#h66-0-2" id="h66-0-2" class="i">+import me.rhunk.snapenhance.core.util.ktx.setObjectField
</a> import me.rhunk.snapenhance.features.Feature
 import me.rhunk.snapenhance.features.FeatureLoadParams
 import me.rhunk.snapenhance.hook.HookStage
 import me.rhunk.snapenhance.hook.hookConstructor
<a href="#h66-0-7" id="h66-0-7" class="d">-import me.rhunk.snapenhance.util.ktx.setObjectField
</a> 
 class UnlimitedMultiSnap : Feature(&quot;UnlimitedMultiSnap&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_ASYNC) {
     override fun asyncOnActivityCreate() {
<b>diff --git a/<a id="h67" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/spying/AnonymousStoryViewing.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/spying/AnonymousStoryViewing.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/spying/AnonymousStoryViewing.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/spying/AnonymousStoryViewing.kt</a></b>
<a href="#h67-0" id="h67-0" class="h">@@ -2,9 +2,9 @@ package me.rhunk.snapenhance.features.impl.spying
</a> 
 import kotlinx.coroutines.runBlocking
 import me.rhunk.snapenhance.core.eventbus.events.impl.NetworkApiRequestEvent
<a href="#h67-0-3" id="h67-0-3" class="i">+import me.rhunk.snapenhance.core.util.download.HttpServer
</a> import me.rhunk.snapenhance.features.Feature
 import me.rhunk.snapenhance.features.FeatureLoadParams
<a href="#h67-0-6" id="h67-0-6" class="d">-import me.rhunk.snapenhance.util.download.HttpServer
</a> import kotlin.coroutines.suspendCoroutine
 
 class AnonymousStoryViewing : Feature(&quot;Anonymous Story Viewing&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_ASYNC) {
<b>diff --git a/<a id="h68" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/AutoSave.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/AutoSave.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/AutoSave.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/AutoSave.kt</a></b>
<a href="#h68-0" id="h68-0" class="h">@@ -1,7 +1,9 @@
</a> package me.rhunk.snapenhance.features.impl.tweaks
 
<a href="#h68-0-2" id="h68-0-2" class="d">-import me.rhunk.snapenhance.Logger
</a><a href="#h68-0-3" id="h68-0-3" class="i">+import me.rhunk.snapenhance.core.Logger
</a> import me.rhunk.snapenhance.core.messaging.MessagingRuleType
<a href="#h68-0-5" id="h68-0-5" class="i">+import me.rhunk.snapenhance.core.util.CallbackBuilder
</a><a href="#h68-0-6" id="h68-0-6" class="i">+import me.rhunk.snapenhance.core.util.ktx.getObjectField
</a> import me.rhunk.snapenhance.data.MessageState
 import me.rhunk.snapenhance.data.wrapper.impl.Message
 import me.rhunk.snapenhance.data.wrapper.impl.SnapUUID
<a href="#h68-1" id="h68-1" class="h">@@ -12,8 +14,6 @@ import me.rhunk.snapenhance.features.impl.spying.MessageLogger
</a> import me.rhunk.snapenhance.features.impl.spying.StealthMode
 import me.rhunk.snapenhance.hook.HookStage
 import me.rhunk.snapenhance.hook.Hooker
<a href="#h68-1-3" id="h68-1-3" class="d">-import me.rhunk.snapenhance.util.CallbackBuilder
</a><a href="#h68-1-4" id="h68-1-4" class="d">-import me.rhunk.snapenhance.util.ktx.getObjectField
</a> import java.util.concurrent.Executors
 
 class AutoSave : MessagingRuleFeature(&quot;Auto Save&quot;, MessagingRuleType.AUTO_SAVE, loadParams = FeatureLoadParams.ACTIVITY_CREATE_ASYNC) {
<b>diff --git a/<a id="h69" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/CameraTweaks.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/CameraTweaks.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/CameraTweaks.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/CameraTweaks.kt</a></b>
<a href="#h69-0" id="h69-0" class="h">@@ -8,13 +8,13 @@ import android.hardware.camera2.CameraCharacteristics
</a> import android.hardware.camera2.CameraCharacteristics.Key
 import android.hardware.camera2.CameraManager
 import android.util.Range
<a href="#h69-0-3" id="h69-0-3" class="i">+import me.rhunk.snapenhance.core.util.ktx.setObjectField
</a> import me.rhunk.snapenhance.data.wrapper.impl.ScSize
 import me.rhunk.snapenhance.features.Feature
 import me.rhunk.snapenhance.features.FeatureLoadParams
 import me.rhunk.snapenhance.hook.HookStage
 import me.rhunk.snapenhance.hook.hook
 import me.rhunk.snapenhance.hook.hookConstructor
<a href="#h69-0-10" id="h69-0-10" class="d">-import me.rhunk.snapenhance.util.ktx.setObjectField
</a> 
 class CameraTweaks : Feature(&quot;Camera Tweaks&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_SYNC) {
     companion object {
<b>diff --git a/<a id="h70" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/DisableReplayInFF.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/DisableReplayInFF.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/DisableReplayInFF.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/DisableReplayInFF.kt</a></b>
<a href="#h70-0" id="h70-0" class="h">@@ -1,11 +1,11 @@
</a> package me.rhunk.snapenhance.features.impl.tweaks
 
<a href="#h70-0-2" id="h70-0-2" class="i">+import me.rhunk.snapenhance.core.util.ktx.getObjectField
</a><a href="#h70-0-3" id="h70-0-3" class="i">+import me.rhunk.snapenhance.core.util.ktx.setEnumField
</a> import me.rhunk.snapenhance.features.Feature
 import me.rhunk.snapenhance.features.FeatureLoadParams
 import me.rhunk.snapenhance.hook.HookStage
 import me.rhunk.snapenhance.hook.hookConstructor
<a href="#h70-0-8" id="h70-0-8" class="d">-import me.rhunk.snapenhance.util.ktx.getObjectField
</a><a href="#h70-0-9" id="h70-0-9" class="d">-import me.rhunk.snapenhance.util.ktx.setEnumField
</a> 
 class DisableReplayInFF : Feature(&quot;DisableReplayInFF&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_ASYNC) {
     override fun asyncOnActivityCreate() {
<b>diff --git a/<a id="h71" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/Notifications.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/Notifications.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/Notifications.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/Notifications.kt</a></b>
<a href="#h71-0" id="h71-0" class="h">@@ -12,9 +12,16 @@ import android.os.Bundle
</a> import android.os.UserHandle
 import de.robv.android.xposed.XposedBridge
 import de.robv.android.xposed.XposedHelpers
<a href="#h71-0-3" id="h71-0-3" class="d">-import me.rhunk.snapenhance.Logger
</a><a href="#h71-0-4" id="h71-0-4" class="i">+import me.rhunk.snapenhance.core.Logger
</a> import me.rhunk.snapenhance.core.download.data.SplitMediaAssetType
 import me.rhunk.snapenhance.core.eventbus.events.impl.SnapWidgetBroadcastReceiveEvent
<a href="#h71-0-7" id="h71-0-7" class="i">+import me.rhunk.snapenhance.core.util.CallbackBuilder
</a><a href="#h71-0-8" id="h71-0-8" class="i">+import me.rhunk.snapenhance.core.util.ktx.setObjectField
</a><a href="#h71-0-9" id="h71-0-9" class="i">+import me.rhunk.snapenhance.core.util.protobuf.ProtoReader
</a><a href="#h71-0-10" id="h71-0-10" class="i">+import me.rhunk.snapenhance.core.util.snap.EncryptionHelper
</a><a href="#h71-0-11" id="h71-0-11" class="i">+import me.rhunk.snapenhance.core.util.snap.MediaDownloaderHelper
</a><a href="#h71-0-12" id="h71-0-12" class="i">+import me.rhunk.snapenhance.core.util.snap.PreviewUtils
</a><a href="#h71-0-13" id="h71-0-13" class="i">+import me.rhunk.snapenhance.core.util.snap.SnapWidgetBroadcastReceiverHelper
</a> import me.rhunk.snapenhance.data.ContentType
 import me.rhunk.snapenhance.data.MediaReferenceType
 import me.rhunk.snapenhance.data.wrapper.impl.Message
<a href="#h71-1" id="h71-1" class="h">@@ -26,13 +33,6 @@ import me.rhunk.snapenhance.features.impl.downloader.MediaDownloader
</a> import me.rhunk.snapenhance.hook.HookStage
 import me.rhunk.snapenhance.hook.Hooker
 import me.rhunk.snapenhance.hook.hook
<a href="#h71-1-3" id="h71-1-3" class="d">-import me.rhunk.snapenhance.util.CallbackBuilder
</a><a href="#h71-1-4" id="h71-1-4" class="d">-import me.rhunk.snapenhance.util.ktx.setObjectField
</a><a href="#h71-1-5" id="h71-1-5" class="d">-import me.rhunk.snapenhance.util.protobuf.ProtoReader
</a><a href="#h71-1-6" id="h71-1-6" class="d">-import me.rhunk.snapenhance.util.snap.EncryptionHelper
</a><a href="#h71-1-7" id="h71-1-7" class="d">-import me.rhunk.snapenhance.util.snap.MediaDownloaderHelper
</a><a href="#h71-1-8" id="h71-1-8" class="d">-import me.rhunk.snapenhance.util.snap.PreviewUtils
</a><a href="#h71-1-9" id="h71-1-9" class="d">-import me.rhunk.snapenhance.util.snap.SnapWidgetBroadcastReceiverHelper
</a> 
 class Notifications : Feature(&quot;Notifications&quot;, loadParams = FeatureLoadParams.INIT_SYNC) {
     companion object{
<b>diff --git a/<a id="h72" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/OldBitmojiSelfie.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/OldBitmojiSelfie.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/OldBitmojiSelfie.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/OldBitmojiSelfie.kt</a></b>
<a href="#h72-0" id="h72-0" class="h">@@ -1,9 +1,9 @@
</a> package me.rhunk.snapenhance.features.impl.tweaks
 
 import me.rhunk.snapenhance.core.eventbus.events.impl.NetworkApiRequestEvent
<a href="#h72-0-3" id="h72-0-3" class="i">+import me.rhunk.snapenhance.core.util.snap.BitmojiSelfie
</a> import me.rhunk.snapenhance.features.Feature
 import me.rhunk.snapenhance.features.FeatureLoadParams
<a href="#h72-0-6" id="h72-0-6" class="d">-import me.rhunk.snapenhance.util.snap.BitmojiSelfie
</a> 
 class OldBitmojiSelfie : Feature(&quot;OldBitmojiSelfie&quot;, loadParams = FeatureLoadParams.INIT_SYNC) {
     override fun init() {
<b>diff --git a/<a id="h73" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/SendOverride.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/SendOverride.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/SendOverride.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/SendOverride.kt</a></b>
<a href="#h73-0" id="h73-0" class="h">@@ -3,13 +3,13 @@ package me.rhunk.snapenhance.features.impl.tweaks
</a> import me.rhunk.snapenhance.Constants
 import me.rhunk.snapenhance.core.eventbus.events.impl.SendMessageWithContentEvent
 import me.rhunk.snapenhance.core.eventbus.events.impl.UnaryCallEvent
<a href="#h73-0-3" id="h73-0-3" class="i">+import me.rhunk.snapenhance.core.util.protobuf.ProtoEditor
</a><a href="#h73-0-4" id="h73-0-4" class="i">+import me.rhunk.snapenhance.core.util.protobuf.ProtoReader
</a> import me.rhunk.snapenhance.data.ContentType
 import me.rhunk.snapenhance.data.MessageSender
 import me.rhunk.snapenhance.features.Feature
 import me.rhunk.snapenhance.features.FeatureLoadParams
 import me.rhunk.snapenhance.ui.ViewAppearanceHelper
<a href="#h73-0-10" id="h73-0-10" class="d">-import me.rhunk.snapenhance.util.protobuf.ProtoEditor
</a><a href="#h73-0-11" id="h73-0-11" class="d">-import me.rhunk.snapenhance.util.protobuf.ProtoReader
</a> 
 class SendOverride : Feature(&quot;Send Override&quot;, loadParams = FeatureLoadParams.INIT_SYNC) {
     private var isLastSnapSavable = false
<b>diff --git a/<a id="h74" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/UnlimitedSnapViewTime.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/UnlimitedSnapViewTime.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/UnlimitedSnapViewTime.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/UnlimitedSnapViewTime.kt</a></b>
<a href="#h74-0" id="h74-0" class="h">@@ -1,20 +1,20 @@
</a> package me.rhunk.snapenhance.features.impl.tweaks
 
<a href="#h74-0-2" id="h74-0-2" class="i">+import me.rhunk.snapenhance.core.util.protobuf.ProtoEditor
</a><a href="#h74-0-3" id="h74-0-3" class="i">+import me.rhunk.snapenhance.core.util.protobuf.ProtoReader
</a> import me.rhunk.snapenhance.data.ContentType
 import me.rhunk.snapenhance.data.MessageState
 import me.rhunk.snapenhance.data.wrapper.impl.Message
 import me.rhunk.snapenhance.features.Feature
 import me.rhunk.snapenhance.features.FeatureLoadParams
 import me.rhunk.snapenhance.hook.HookStage
<a href="#h74-0-10" id="h74-0-10" class="d">-import me.rhunk.snapenhance.hook.Hooker
</a><a href="#h74-0-11" id="h74-0-11" class="d">-import me.rhunk.snapenhance.util.protobuf.ProtoEditor
</a><a href="#h74-0-12" id="h74-0-12" class="d">-import me.rhunk.snapenhance.util.protobuf.ProtoReader
</a><a href="#h74-0-13" id="h74-0-13" class="i">+import me.rhunk.snapenhance.hook.hookConstructor
</a> 
 class UnlimitedSnapViewTime :
     Feature(&quot;UnlimitedSnapViewTime&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_SYNC) {
     override fun onActivityCreate() {
         val state by context.config.messaging.unlimitedSnapViewTime
<a href="#h74-0-19" id="h74-0-19" class="d">-        Hooker.hookConstructor(context.classCache.message, HookStage.AFTER, { state }) { param -&gt;
</a><a href="#h74-0-20" id="h74-0-20" class="i">+        context.classCache.message.hookConstructor(HookStage.AFTER, { state }) { param -&gt;
</a>             val message = Message(param.thisObject())
             if (message.messageState != MessageState.COMMITTED) return@hookConstructor
             if (message.messageContent.contentType != ContentType.SNAP) return@hookConstructor
<b>diff --git a/<a id="h75" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/PinConversations.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/PinConversations.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/PinConversations.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/PinConversations.kt</a></b>
<a href="#h75-0" id="h75-0" class="h">@@ -1,14 +1,14 @@
</a> package me.rhunk.snapenhance.features.impl.ui
 
 import me.rhunk.snapenhance.core.bridge.types.BridgeFileType
<a href="#h75-0-3" id="h75-0-3" class="i">+import me.rhunk.snapenhance.core.util.ktx.getObjectField
</a><a href="#h75-0-4" id="h75-0-4" class="i">+import me.rhunk.snapenhance.core.util.ktx.setObjectField
</a> import me.rhunk.snapenhance.data.wrapper.impl.SnapUUID
 import me.rhunk.snapenhance.features.BridgeFileFeature
 import me.rhunk.snapenhance.features.FeatureLoadParams
 import me.rhunk.snapenhance.hook.HookStage
 import me.rhunk.snapenhance.hook.hook
 import me.rhunk.snapenhance.hook.hookConstructor
<a href="#h75-0-11" id="h75-0-11" class="d">-import me.rhunk.snapenhance.util.ktx.getObjectField
</a><a href="#h75-0-12" id="h75-0-12" class="d">-import me.rhunk.snapenhance.util.ktx.setObjectField
</a> 
 class PinConversations : BridgeFileFeature(&quot;PinConversations&quot;, BridgeFileType.PINNED_CONVERSATIONS, loadParams = FeatureLoadParams.ACTIVITY_CREATE_SYNC) {
     override fun onActivityCreate() {
<b>diff --git a/<a id="h76" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/manager/impl/FeatureManager.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/manager/impl/FeatureManager.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/manager/impl/FeatureManager.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/manager/impl/FeatureManager.kt</a></b>
<a href="#h76-0" id="h76-0" class="h">@@ -1,7 +1,7 @@
</a> package me.rhunk.snapenhance.manager.impl
 
<a href="#h76-0-2" id="h76-0-2" class="d">-import me.rhunk.snapenhance.Logger
</a> import me.rhunk.snapenhance.ModContext
<a href="#h76-0-4" id="h76-0-4" class="i">+import me.rhunk.snapenhance.core.Logger
</a> import me.rhunk.snapenhance.features.Feature
 import me.rhunk.snapenhance.features.FeatureLoadParams
 import me.rhunk.snapenhance.features.impl.ConfigurationOverride
<a href="#h76-1" id="h76-1" class="h">@@ -34,8 +34,8 @@ import me.rhunk.snapenhance.features.impl.tweaks.OldBitmojiSelfie
</a> import me.rhunk.snapenhance.features.impl.tweaks.SendOverride
 import me.rhunk.snapenhance.features.impl.tweaks.SnapchatPlus
 import me.rhunk.snapenhance.features.impl.tweaks.UnlimitedSnapViewTime
<a href="#h76-1-3" id="h76-1-3" class="d">-import me.rhunk.snapenhance.features.impl.ui.PinConversations
</a> import me.rhunk.snapenhance.features.impl.ui.ClientBootstrapOverride
<a href="#h76-1-5" id="h76-1-5" class="i">+import me.rhunk.snapenhance.features.impl.ui.PinConversations
</a> import me.rhunk.snapenhance.features.impl.ui.UITweaks
 import me.rhunk.snapenhance.manager.Manager
 import me.rhunk.snapenhance.ui.menu.impl.MenuViewInjector
<b>diff --git a/<a id="h77" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/FriendFeedInfoMenu.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/FriendFeedInfoMenu.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/FriendFeedInfoMenu.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/FriendFeedInfoMenu.kt</a></b>
<a href="#h77-0" id="h77-0" class="h">@@ -14,6 +14,7 @@ import android.widget.Switch
</a> import me.rhunk.snapenhance.core.database.objects.ConversationMessage
 import me.rhunk.snapenhance.core.database.objects.FriendInfo
 import me.rhunk.snapenhance.core.database.objects.UserConversationLink
<a href="#h77-0-3" id="h77-0-3" class="i">+import me.rhunk.snapenhance.core.util.snap.BitmojiSelfie
</a> import me.rhunk.snapenhance.data.ContentType
 import me.rhunk.snapenhance.features.MessagingRuleFeature
 import me.rhunk.snapenhance.features.impl.Messaging
<a href="#h77-1" id="h77-1" class="h">@@ -22,7 +23,6 @@ import me.rhunk.snapenhance.features.impl.spying.StealthMode
</a> import me.rhunk.snapenhance.features.impl.tweaks.AutoSave
 import me.rhunk.snapenhance.ui.ViewAppearanceHelper
 import me.rhunk.snapenhance.ui.menu.AbstractMenu
<a href="#h77-1-3" id="h77-1-3" class="d">-import me.rhunk.snapenhance.util.snap.BitmojiSelfie
</a> import java.net.HttpURLConnection
 import java.net.URL
 import java.text.DateFormat
<b>diff --git a/<a id="h78" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/util/CallbackBuilder.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/util/CallbackBuilder.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/util/CallbackBuilder.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/util/CallbackBuilder.kt</a></b>
<a href="#h78-0" id="h78-0" class="h">@@ -1,93 +0,0 @@
</a><a href="#h78-0-0" id="h78-0-0" class="d">-package me.rhunk.snapenhance.util
</a><a href="#h78-0-1" id="h78-0-1" class="d">-
</a><a href="#h78-0-2" id="h78-0-2" class="d">-import de.robv.android.xposed.XC_MethodHook
</a><a href="#h78-0-3" id="h78-0-3" class="d">-import me.rhunk.snapenhance.hook.HookAdapter
</a><a href="#h78-0-4" id="h78-0-4" class="d">-import me.rhunk.snapenhance.hook.HookStage
</a><a href="#h78-0-5" id="h78-0-5" class="d">-import me.rhunk.snapenhance.hook.Hooker
</a><a href="#h78-0-6" id="h78-0-6" class="d">-import java.lang.reflect.Constructor
</a><a href="#h78-0-7" id="h78-0-7" class="d">-import java.lang.reflect.Field
</a><a href="#h78-0-8" id="h78-0-8" class="d">-import java.lang.reflect.Modifier
</a><a href="#h78-0-9" id="h78-0-9" class="d">-
</a><a href="#h78-0-10" id="h78-0-10" class="d">-class CallbackBuilder(
</a><a href="#h78-0-11" id="h78-0-11" class="d">-    private val callbackClass: Class&lt;*&gt;
</a><a href="#h78-0-12" id="h78-0-12" class="d">-) {
</a><a href="#h78-0-13" id="h78-0-13" class="d">-    internal class Override(
</a><a href="#h78-0-14" id="h78-0-14" class="d">-        val methodName: String,
</a><a href="#h78-0-15" id="h78-0-15" class="d">-        val shouldUnhook: Boolean = true,
</a><a href="#h78-0-16" id="h78-0-16" class="d">-        val callback: (HookAdapter) -&gt; Unit
</a><a href="#h78-0-17" id="h78-0-17" class="d">-    )
</a><a href="#h78-0-18" id="h78-0-18" class="d">-
</a><a href="#h78-0-19" id="h78-0-19" class="d">-    private val methodOverrides = mutableListOf&lt;Override&gt;()
</a><a href="#h78-0-20" id="h78-0-20" class="d">-
</a><a href="#h78-0-21" id="h78-0-21" class="d">-    fun override(methodName: String, shouldUnhook: Boolean = true, callback: (HookAdapter) -&gt; Unit = {}): CallbackBuilder {
</a><a href="#h78-0-22" id="h78-0-22" class="d">-        methodOverrides.add(Override(methodName, shouldUnhook, callback))
</a><a href="#h78-0-23" id="h78-0-23" class="d">-        return this
</a><a href="#h78-0-24" id="h78-0-24" class="d">-    }
</a><a href="#h78-0-25" id="h78-0-25" class="d">-
</a><a href="#h78-0-26" id="h78-0-26" class="d">-    fun build(): Any {
</a><a href="#h78-0-27" id="h78-0-27" class="d">-        //get the first param of the first constructor to get the class of the invoker
</a><a href="#h78-0-28" id="h78-0-28" class="d">-        val invokerClass: Class&lt;*&gt; = callbackClass.constructors[0].parameterTypes[0]
</a><a href="#h78-0-29" id="h78-0-29" class="d">-        //get the invoker field based on the invoker class
</a><a href="#h78-0-30" id="h78-0-30" class="d">-        val invokerField = callbackClass.fields.first { field: Field -&gt;
</a><a href="#h78-0-31" id="h78-0-31" class="d">-            field.type.isAssignableFrom(invokerClass)
</a><a href="#h78-0-32" id="h78-0-32" class="d">-        }
</a><a href="#h78-0-33" id="h78-0-33" class="d">-        //get the callback field based on the callback class
</a><a href="#h78-0-34" id="h78-0-34" class="d">-        val callbackInstance = createEmptyObject(callbackClass.constructors[0])!!
</a><a href="#h78-0-35" id="h78-0-35" class="d">-        val callbackInstanceHashCode: Int = callbackInstance.hashCode()
</a><a href="#h78-0-36" id="h78-0-36" class="d">-        val callbackInstanceClass = callbackInstance.javaClass
</a><a href="#h78-0-37" id="h78-0-37" class="d">-
</a><a href="#h78-0-38" id="h78-0-38" class="d">-        val unhooks = mutableListOf&lt;XC_MethodHook.Unhook&gt;()
</a><a href="#h78-0-39" id="h78-0-39" class="d">-
</a><a href="#h78-0-40" id="h78-0-40" class="d">-        callbackInstanceClass.methods.forEach { method -&gt;
</a><a href="#h78-0-41" id="h78-0-41" class="d">-            if (method.declaringClass != callbackInstanceClass) return@forEach
</a><a href="#h78-0-42" id="h78-0-42" class="d">-            if (Modifier.isPrivate(method.modifiers)) return@forEach
</a><a href="#h78-0-43" id="h78-0-43" class="d">-
</a><a href="#h78-0-44" id="h78-0-44" class="d">-            //default hook that unhooks the callback and returns null
</a><a href="#h78-0-45" id="h78-0-45" class="d">-            val defaultHook: (HookAdapter) -&gt; Boolean = defaultHook@{
</a><a href="#h78-0-46" id="h78-0-46" class="d">-                //checking invokerField ensure that&#39;s the callback was created by the CallbackBuilder
</a><a href="#h78-0-47" id="h78-0-47" class="d">-                if (invokerField.get(it.thisObject()) != null) return@defaultHook false
</a><a href="#h78-0-48" id="h78-0-48" class="d">-                if ((it.thisObject() as Any).hashCode() != callbackInstanceHashCode) return@defaultHook false
</a><a href="#h78-0-49" id="h78-0-49" class="d">-                it.setResult(null)
</a><a href="#h78-0-50" id="h78-0-50" class="d">-                true
</a><a href="#h78-0-51" id="h78-0-51" class="d">-            }
</a><a href="#h78-0-52" id="h78-0-52" class="d">-
</a><a href="#h78-0-53" id="h78-0-53" class="d">-            var hook: (HookAdapter) -&gt; Unit = { defaultHook(it) }
</a><a href="#h78-0-54" id="h78-0-54" class="d">-
</a><a href="#h78-0-55" id="h78-0-55" class="d">-            //override the default hook if the method is in the override list
</a><a href="#h78-0-56" id="h78-0-56" class="d">-            methodOverrides.find { it.methodName == method.name }?.run {
</a><a href="#h78-0-57" id="h78-0-57" class="d">-                hook = {
</a><a href="#h78-0-58" id="h78-0-58" class="d">-                    if (defaultHook(it)) {
</a><a href="#h78-0-59" id="h78-0-59" class="d">-                        callback(it)
</a><a href="#h78-0-60" id="h78-0-60" class="d">-                        if (shouldUnhook) unhooks.forEach { unhook -&gt; unhook.unhook() }
</a><a href="#h78-0-61" id="h78-0-61" class="d">-                    }
</a><a href="#h78-0-62" id="h78-0-62" class="d">-                }
</a><a href="#h78-0-63" id="h78-0-63" class="d">-            }
</a><a href="#h78-0-64" id="h78-0-64" class="d">-
</a><a href="#h78-0-65" id="h78-0-65" class="d">-            unhooks.add(Hooker.hook(method, HookStage.BEFORE, hook))
</a><a href="#h78-0-66" id="h78-0-66" class="d">-        }
</a><a href="#h78-0-67" id="h78-0-67" class="d">-        return callbackInstance
</a><a href="#h78-0-68" id="h78-0-68" class="d">-    }
</a><a href="#h78-0-69" id="h78-0-69" class="d">-
</a><a href="#h78-0-70" id="h78-0-70" class="d">-    companion object {
</a><a href="#h78-0-71" id="h78-0-71" class="d">-        fun createEmptyObject(constructor: Constructor&lt;*&gt;): Any? {
</a><a href="#h78-0-72" id="h78-0-72" class="d">-            //compute the args for the constructor with null or default primitive values
</a><a href="#h78-0-73" id="h78-0-73" class="d">-            val args = constructor.parameterTypes.map { type: Class&lt;*&gt; -&gt;
</a><a href="#h78-0-74" id="h78-0-74" class="d">-                if (type.isPrimitive) {
</a><a href="#h78-0-75" id="h78-0-75" class="d">-                    when (type.name) {
</a><a href="#h78-0-76" id="h78-0-76" class="d">-                        &quot;boolean&quot; -&gt; return@map false
</a><a href="#h78-0-77" id="h78-0-77" class="d">-                        &quot;byte&quot; -&gt; return@map 0.toByte()
</a><a href="#h78-0-78" id="h78-0-78" class="d">-                        &quot;char&quot; -&gt; return@map 0.toChar()
</a><a href="#h78-0-79" id="h78-0-79" class="d">-                        &quot;short&quot; -&gt; return@map 0.toShort()
</a><a href="#h78-0-80" id="h78-0-80" class="d">-                        &quot;int&quot; -&gt; return@map 0
</a><a href="#h78-0-81" id="h78-0-81" class="d">-                        &quot;long&quot; -&gt; return@map 0L
</a><a href="#h78-0-82" id="h78-0-82" class="d">-                        &quot;float&quot; -&gt; return@map 0f
</a><a href="#h78-0-83" id="h78-0-83" class="d">-                        &quot;double&quot; -&gt; return@map 0.0
</a><a href="#h78-0-84" id="h78-0-84" class="d">-                    }
</a><a href="#h78-0-85" id="h78-0-85" class="d">-                }
</a><a href="#h78-0-86" id="h78-0-86" class="d">-                null
</a><a href="#h78-0-87" id="h78-0-87" class="d">-            }.toTypedArray()
</a><a href="#h78-0-88" id="h78-0-88" class="d">-            return constructor.newInstance(*args)
</a><a href="#h78-0-89" id="h78-0-89" class="d">-        }
</a><a href="#h78-0-90" id="h78-0-90" class="d">-
</a><a href="#h78-0-91" id="h78-0-91" class="d">-    }
</a><a href="#h78-0-92" id="h78-0-92" class="d">-}</a><a href="#h78-0-93" id="h78-0-93" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h79" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/util/ReflectionHelper.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/util/ReflectionHelper.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/util/ReflectionHelper.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/util/ReflectionHelper.kt</a></b>
<a href="#h79-0" id="h79-0" class="h">@@ -1,119 +0,0 @@
</a><a href="#h79-0-0" id="h79-0-0" class="d">-package me.rhunk.snapenhance.util
</a><a href="#h79-0-1" id="h79-0-1" class="d">-
</a><a href="#h79-0-2" id="h79-0-2" class="d">-import java.lang.reflect.Field
</a><a href="#h79-0-3" id="h79-0-3" class="d">-import java.lang.reflect.Method
</a><a href="#h79-0-4" id="h79-0-4" class="d">-import java.util.Arrays
</a><a href="#h79-0-5" id="h79-0-5" class="d">-import java.util.Objects
</a><a href="#h79-0-6" id="h79-0-6" class="d">-
</a><a href="#h79-0-7" id="h79-0-7" class="d">-object ReflectionHelper {
</a><a href="#h79-0-8" id="h79-0-8" class="d">-    /**
</a><a href="#h79-0-9" id="h79-0-9" class="d">-     * Searches for a field with a class that has a method with the specified name
</a><a href="#h79-0-10" id="h79-0-10" class="d">-     */
</a><a href="#h79-0-11" id="h79-0-11" class="d">-    fun searchFieldWithClassMethod(clazz: Class&lt;*&gt;, methodName: String): Field? {
</a><a href="#h79-0-12" id="h79-0-12" class="d">-        return clazz.declaredFields.firstOrNull { f: Field? -&gt;
</a><a href="#h79-0-13" id="h79-0-13" class="d">-            try {
</a><a href="#h79-0-14" id="h79-0-14" class="d">-                return@firstOrNull Arrays.stream(
</a><a href="#h79-0-15" id="h79-0-15" class="d">-                    f!!.type.declaredMethods
</a><a href="#h79-0-16" id="h79-0-16" class="d">-                ).anyMatch { method: Method -&gt; method.name == methodName }
</a><a href="#h79-0-17" id="h79-0-17" class="d">-            } catch (e: Exception) {
</a><a href="#h79-0-18" id="h79-0-18" class="d">-                return@firstOrNull false
</a><a href="#h79-0-19" id="h79-0-19" class="d">-            }
</a><a href="#h79-0-20" id="h79-0-20" class="d">-        }
</a><a href="#h79-0-21" id="h79-0-21" class="d">-    }
</a><a href="#h79-0-22" id="h79-0-22" class="d">-
</a><a href="#h79-0-23" id="h79-0-23" class="d">-    fun searchFieldByType(clazz: Class&lt;*&gt;, type: Class&lt;*&gt;): Field? {
</a><a href="#h79-0-24" id="h79-0-24" class="d">-        return clazz.declaredFields.firstOrNull { f: Field? -&gt; f!!.type == type }
</a><a href="#h79-0-25" id="h79-0-25" class="d">-    }
</a><a href="#h79-0-26" id="h79-0-26" class="d">-
</a><a href="#h79-0-27" id="h79-0-27" class="d">-    fun searchFieldTypeInSuperClasses(clazz: Class&lt;*&gt;, type: Class&lt;*&gt;): Field? {
</a><a href="#h79-0-28" id="h79-0-28" class="d">-        val field = searchFieldByType(clazz, type)
</a><a href="#h79-0-29" id="h79-0-29" class="d">-        if (field != null) {
</a><a href="#h79-0-30" id="h79-0-30" class="d">-            return field
</a><a href="#h79-0-31" id="h79-0-31" class="d">-        }
</a><a href="#h79-0-32" id="h79-0-32" class="d">-        val superclass = clazz.superclass
</a><a href="#h79-0-33" id="h79-0-33" class="d">-        return superclass?.let { searchFieldTypeInSuperClasses(it, type) }
</a><a href="#h79-0-34" id="h79-0-34" class="d">-    }
</a><a href="#h79-0-35" id="h79-0-35" class="d">-
</a><a href="#h79-0-36" id="h79-0-36" class="d">-    fun searchFieldStartsWithToString(
</a><a href="#h79-0-37" id="h79-0-37" class="d">-        clazz: Class&lt;*&gt;,
</a><a href="#h79-0-38" id="h79-0-38" class="d">-        instance: Any,
</a><a href="#h79-0-39" id="h79-0-39" class="d">-        toString: String?
</a><a href="#h79-0-40" id="h79-0-40" class="d">-    ): Field? {
</a><a href="#h79-0-41" id="h79-0-41" class="d">-        return clazz.declaredFields.firstOrNull { f: Field -&gt;
</a><a href="#h79-0-42" id="h79-0-42" class="d">-            try {
</a><a href="#h79-0-43" id="h79-0-43" class="d">-                f.isAccessible = true
</a><a href="#h79-0-44" id="h79-0-44" class="d">-                return@firstOrNull Objects.requireNonNull(f[instance]).toString()
</a><a href="#h79-0-45" id="h79-0-45" class="d">-                    .startsWith(
</a><a href="#h79-0-46" id="h79-0-46" class="d">-                        toString!!
</a><a href="#h79-0-47" id="h79-0-47" class="d">-                    )
</a><a href="#h79-0-48" id="h79-0-48" class="d">-            } catch (e: Throwable) {
</a><a href="#h79-0-49" id="h79-0-49" class="d">-                return@firstOrNull false
</a><a href="#h79-0-50" id="h79-0-50" class="d">-            }
</a><a href="#h79-0-51" id="h79-0-51" class="d">-        }
</a><a href="#h79-0-52" id="h79-0-52" class="d">-    }
</a><a href="#h79-0-53" id="h79-0-53" class="d">-
</a><a href="#h79-0-54" id="h79-0-54" class="d">-
</a><a href="#h79-0-55" id="h79-0-55" class="d">-    fun searchFieldContainsToString(
</a><a href="#h79-0-56" id="h79-0-56" class="d">-        clazz: Class&lt;*&gt;,
</a><a href="#h79-0-57" id="h79-0-57" class="d">-        instance: Any?,
</a><a href="#h79-0-58" id="h79-0-58" class="d">-        toString: String?
</a><a href="#h79-0-59" id="h79-0-59" class="d">-    ): Field? {
</a><a href="#h79-0-60" id="h79-0-60" class="d">-        return clazz.declaredFields.firstOrNull { f: Field -&gt;
</a><a href="#h79-0-61" id="h79-0-61" class="d">-            try {
</a><a href="#h79-0-62" id="h79-0-62" class="d">-                f.isAccessible = true
</a><a href="#h79-0-63" id="h79-0-63" class="d">-                return@firstOrNull Objects.requireNonNull(f[instance]).toString()
</a><a href="#h79-0-64" id="h79-0-64" class="d">-                    .contains(toString!!)
</a><a href="#h79-0-65" id="h79-0-65" class="d">-            } catch (e: Throwable) {
</a><a href="#h79-0-66" id="h79-0-66" class="d">-                return@firstOrNull false
</a><a href="#h79-0-67" id="h79-0-67" class="d">-            }
</a><a href="#h79-0-68" id="h79-0-68" class="d">-        }
</a><a href="#h79-0-69" id="h79-0-69" class="d">-    }
</a><a href="#h79-0-70" id="h79-0-70" class="d">-
</a><a href="#h79-0-71" id="h79-0-71" class="d">-    fun searchFirstFieldTypeInClassRecursive(clazz: Class&lt;*&gt;, type: Class&lt;*&gt;): Field? {
</a><a href="#h79-0-72" id="h79-0-72" class="d">-        return clazz.declaredFields.firstOrNull {
</a><a href="#h79-0-73" id="h79-0-73" class="d">-            val field = searchFieldByType(it.type, type)
</a><a href="#h79-0-74" id="h79-0-74" class="d">-            return@firstOrNull field != null
</a><a href="#h79-0-75" id="h79-0-75" class="d">-        }
</a><a href="#h79-0-76" id="h79-0-76" class="d">-    }
</a><a href="#h79-0-77" id="h79-0-77" class="d">-
</a><a href="#h79-0-78" id="h79-0-78" class="d">-    /**
</a><a href="#h79-0-79" id="h79-0-79" class="d">-     * Searches for a field with a class that has a method with the specified return type
</a><a href="#h79-0-80" id="h79-0-80" class="d">-     */
</a><a href="#h79-0-81" id="h79-0-81" class="d">-    fun searchMethodWithReturnType(clazz: Class&lt;*&gt;, returnType: Class&lt;*&gt;): Method? {
</a><a href="#h79-0-82" id="h79-0-82" class="d">-        return clazz.declaredMethods.first { m: Method -&gt; m.returnType == returnType }
</a><a href="#h79-0-83" id="h79-0-83" class="d">-    }
</a><a href="#h79-0-84" id="h79-0-84" class="d">-
</a><a href="#h79-0-85" id="h79-0-85" class="d">-    /**
</a><a href="#h79-0-86" id="h79-0-86" class="d">-     * Searches for a field with a class that has a method with the specified return type and parameter types
</a><a href="#h79-0-87" id="h79-0-87" class="d">-     */
</a><a href="#h79-0-88" id="h79-0-88" class="d">-    fun searchMethodWithParameterAndReturnType(
</a><a href="#h79-0-89" id="h79-0-89" class="d">-        aClass: Class&lt;*&gt;,
</a><a href="#h79-0-90" id="h79-0-90" class="d">-        returnType: Class&lt;*&gt;,
</a><a href="#h79-0-91" id="h79-0-91" class="d">-        vararg parameters: Class&lt;*&gt;
</a><a href="#h79-0-92" id="h79-0-92" class="d">-    ): Method? {
</a><a href="#h79-0-93" id="h79-0-93" class="d">-        return aClass.declaredMethods.firstOrNull { m: Method -&gt;
</a><a href="#h79-0-94" id="h79-0-94" class="d">-            if (m.returnType != returnType) {
</a><a href="#h79-0-95" id="h79-0-95" class="d">-                return@firstOrNull false
</a><a href="#h79-0-96" id="h79-0-96" class="d">-            }
</a><a href="#h79-0-97" id="h79-0-97" class="d">-            val parameterTypes = m.parameterTypes
</a><a href="#h79-0-98" id="h79-0-98" class="d">-            if (parameterTypes.size != parameters.size) {
</a><a href="#h79-0-99" id="h79-0-99" class="d">-                return@firstOrNull false
</a><a href="#h79-0-100" id="h79-0-100" class="d">-            }
</a><a href="#h79-0-101" id="h79-0-101" class="d">-            for (i in parameterTypes.indices) {
</a><a href="#h79-0-102" id="h79-0-102" class="d">-                if (parameterTypes[i] != parameters[i]) {
</a><a href="#h79-0-103" id="h79-0-103" class="d">-                    return@firstOrNull false
</a><a href="#h79-0-104" id="h79-0-104" class="d">-                }
</a><a href="#h79-0-105" id="h79-0-105" class="d">-            }
</a><a href="#h79-0-106" id="h79-0-106" class="d">-            true
</a><a href="#h79-0-107" id="h79-0-107" class="d">-        }
</a><a href="#h79-0-108" id="h79-0-108" class="d">-    }
</a><a href="#h79-0-109" id="h79-0-109" class="d">-
</a><a href="#h79-0-110" id="h79-0-110" class="d">-    fun getDeclaredFieldsRecursively(clazz: Class&lt;*&gt;): List&lt;Field&gt; {
</a><a href="#h79-0-111" id="h79-0-111" class="d">-        val fields = clazz.declaredFields.toMutableList()
</a><a href="#h79-0-112" id="h79-0-112" class="d">-        val superclass = clazz.superclass
</a><a href="#h79-0-113" id="h79-0-113" class="d">-        if (superclass != null) {
</a><a href="#h79-0-114" id="h79-0-114" class="d">-            fields.addAll(getDeclaredFieldsRecursively(superclass))
</a><a href="#h79-0-115" id="h79-0-115" class="d">-        }
</a><a href="#h79-0-116" id="h79-0-116" class="d">-        return fields
</a><a href="#h79-0-117" id="h79-0-117" class="d">-    }
</a><a href="#h79-0-118" id="h79-0-118" class="d">-}</a><a href="#h79-0-119" id="h79-0-119" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h80" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/util/SQLiteDatabaseHelper.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/util/SQLiteDatabaseHelper.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/util/SQLiteDatabaseHelper.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/util/SQLiteDatabaseHelper.kt</a></b>
<a href="#h80-0" id="h80-0" class="h">@@ -1,31 +0,0 @@
</a><a href="#h80-0-0" id="h80-0-0" class="d">-package me.rhunk.snapenhance.util
</a><a href="#h80-0-1" id="h80-0-1" class="d">-
</a><a href="#h80-0-2" id="h80-0-2" class="d">-import android.annotation.SuppressLint
</a><a href="#h80-0-3" id="h80-0-3" class="d">-import android.database.sqlite.SQLiteDatabase
</a><a href="#h80-0-4" id="h80-0-4" class="d">-import me.rhunk.snapenhance.Logger
</a><a href="#h80-0-5" id="h80-0-5" class="d">-
</a><a href="#h80-0-6" id="h80-0-6" class="d">-object SQLiteDatabaseHelper {
</a><a href="#h80-0-7" id="h80-0-7" class="d">-    @SuppressLint(&quot;Range&quot;)
</a><a href="#h80-0-8" id="h80-0-8" class="d">-    fun createTablesFromSchema(sqLiteDatabase: SQLiteDatabase, databaseSchema: Map&lt;String, List&lt;String&gt;&gt;) {
</a><a href="#h80-0-9" id="h80-0-9" class="d">-        databaseSchema.forEach { (tableName, columns) -&gt;
</a><a href="#h80-0-10" id="h80-0-10" class="d">-            sqLiteDatabase.execSQL(&quot;CREATE TABLE IF NOT EXISTS $tableName (${columns.joinToString(&quot;, &quot;)})&quot;)
</a><a href="#h80-0-11" id="h80-0-11" class="d">-
</a><a href="#h80-0-12" id="h80-0-12" class="d">-            val cursor = sqLiteDatabase.rawQuery(&quot;PRAGMA table_info($tableName)&quot;, null)
</a><a href="#h80-0-13" id="h80-0-13" class="d">-            val existingColumns = mutableListOf&lt;String&gt;()
</a><a href="#h80-0-14" id="h80-0-14" class="d">-            while (cursor.moveToNext()) {
</a><a href="#h80-0-15" id="h80-0-15" class="d">-                existingColumns.add(cursor.getString(cursor.getColumnIndex(&quot;name&quot;)) + &quot; &quot; + cursor.getString(cursor.getColumnIndex(&quot;type&quot;)))
</a><a href="#h80-0-16" id="h80-0-16" class="d">-            }
</a><a href="#h80-0-17" id="h80-0-17" class="d">-            cursor.close()
</a><a href="#h80-0-18" id="h80-0-18" class="d">-
</a><a href="#h80-0-19" id="h80-0-19" class="d">-            val newColumns = columns.filter {
</a><a href="#h80-0-20" id="h80-0-20" class="d">-                existingColumns.none { existingColumn -&gt; it.startsWith(existingColumn) }
</a><a href="#h80-0-21" id="h80-0-21" class="d">-            }
</a><a href="#h80-0-22" id="h80-0-22" class="d">-
</a><a href="#h80-0-23" id="h80-0-23" class="d">-            if (newColumns.isEmpty()) return@forEach
</a><a href="#h80-0-24" id="h80-0-24" class="d">-
</a><a href="#h80-0-25" id="h80-0-25" class="d">-            Logger.directDebug(&quot;Schema for table $tableName has changed&quot;)
</a><a href="#h80-0-26" id="h80-0-26" class="d">-            sqLiteDatabase.execSQL(&quot;DROP TABLE $tableName&quot;)
</a><a href="#h80-0-27" id="h80-0-27" class="d">-            sqLiteDatabase.execSQL(&quot;CREATE TABLE IF NOT EXISTS $tableName (${columns.joinToString(&quot;, &quot;)})&quot;)
</a><a href="#h80-0-28" id="h80-0-28" class="d">-        }
</a><a href="#h80-0-29" id="h80-0-29" class="d">-    }
</a><a href="#h80-0-30" id="h80-0-30" class="d">-}</a><a href="#h80-0-31" id="h80-0-31" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h81" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/util/SerializableDataObject.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/util/SerializableDataObject.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/util/SerializableDataObject.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/util/SerializableDataObject.kt</a></b>
<a href="#h81-0" id="h81-0" class="h">@@ -1,22 +0,0 @@
</a><a href="#h81-0-0" id="h81-0-0" class="d">-package me.rhunk.snapenhance.util
</a><a href="#h81-0-1" id="h81-0-1" class="d">-
</a><a href="#h81-0-2" id="h81-0-2" class="d">-import com.google.gson.Gson
</a><a href="#h81-0-3" id="h81-0-3" class="d">-import com.google.gson.GsonBuilder
</a><a href="#h81-0-4" id="h81-0-4" class="d">-
</a><a href="#h81-0-5" id="h81-0-5" class="d">-open class SerializableDataObject {
</a><a href="#h81-0-6" id="h81-0-6" class="d">-    companion object {
</a><a href="#h81-0-7" id="h81-0-7" class="d">-        val gson: Gson = GsonBuilder().create()
</a><a href="#h81-0-8" id="h81-0-8" class="d">-
</a><a href="#h81-0-9" id="h81-0-9" class="d">-        inline fun &lt;reified T : SerializableDataObject&gt; fromJson(json: String): T {
</a><a href="#h81-0-10" id="h81-0-10" class="d">-            return gson.fromJson(json, T::class.java)
</a><a href="#h81-0-11" id="h81-0-11" class="d">-        }
</a><a href="#h81-0-12" id="h81-0-12" class="d">-
</a><a href="#h81-0-13" id="h81-0-13" class="d">-        inline fun &lt;reified T : SerializableDataObject&gt; fromJson(json: String, type: Class&lt;T&gt;): T {
</a><a href="#h81-0-14" id="h81-0-14" class="d">-            return gson.fromJson(json, type)
</a><a href="#h81-0-15" id="h81-0-15" class="d">-        }
</a><a href="#h81-0-16" id="h81-0-16" class="d">-    }
</a><a href="#h81-0-17" id="h81-0-17" class="d">-
</a><a href="#h81-0-18" id="h81-0-18" class="d">-    fun toJson(): String {
</a><a href="#h81-0-19" id="h81-0-19" class="d">-        return gson.toJson(this)
</a><a href="#h81-0-20" id="h81-0-20" class="d">-    }
</a><a href="#h81-0-21" id="h81-0-21" class="d">-}</a><a href="#h81-0-22" id="h81-0-22" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h82" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/util/download/HttpServer.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/util/download/HttpServer.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/util/download/HttpServer.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/util/download/HttpServer.kt</a></b>
<a href="#h82-0" id="h82-0" class="h">@@ -1,139 +0,0 @@
</a><a href="#h82-0-0" id="h82-0-0" class="d">-package me.rhunk.snapenhance.util.download
</a><a href="#h82-0-1" id="h82-0-1" class="d">-
</a><a href="#h82-0-2" id="h82-0-2" class="d">-import kotlinx.coroutines.CoroutineScope
</a><a href="#h82-0-3" id="h82-0-3" class="d">-import kotlinx.coroutines.Dispatchers
</a><a href="#h82-0-4" id="h82-0-4" class="d">-import kotlinx.coroutines.Job
</a><a href="#h82-0-5" id="h82-0-5" class="d">-import kotlinx.coroutines.delay
</a><a href="#h82-0-6" id="h82-0-6" class="d">-import kotlinx.coroutines.launch
</a><a href="#h82-0-7" id="h82-0-7" class="d">-import me.rhunk.snapenhance.Logger
</a><a href="#h82-0-8" id="h82-0-8" class="d">-import java.io.BufferedReader
</a><a href="#h82-0-9" id="h82-0-9" class="d">-import java.io.InputStream
</a><a href="#h82-0-10" id="h82-0-10" class="d">-import java.io.InputStreamReader
</a><a href="#h82-0-11" id="h82-0-11" class="d">-import java.io.PrintWriter
</a><a href="#h82-0-12" id="h82-0-12" class="d">-import java.net.ServerSocket
</a><a href="#h82-0-13" id="h82-0-13" class="d">-import java.net.Socket
</a><a href="#h82-0-14" id="h82-0-14" class="d">-import java.net.SocketException
</a><a href="#h82-0-15" id="h82-0-15" class="d">-import java.util.Locale
</a><a href="#h82-0-16" id="h82-0-16" class="d">-import java.util.StringTokenizer
</a><a href="#h82-0-17" id="h82-0-17" class="d">-import java.util.concurrent.ConcurrentHashMap
</a><a href="#h82-0-18" id="h82-0-18" class="d">-import kotlin.random.Random
</a><a href="#h82-0-19" id="h82-0-19" class="d">-
</a><a href="#h82-0-20" id="h82-0-20" class="d">-class HttpServer(
</a><a href="#h82-0-21" id="h82-0-21" class="d">-    private val timeout: Int = 10000
</a><a href="#h82-0-22" id="h82-0-22" class="d">-) {
</a><a href="#h82-0-23" id="h82-0-23" class="d">-    val port = Random.nextInt(10000, 65535)
</a><a href="#h82-0-24" id="h82-0-24" class="d">-
</a><a href="#h82-0-25" id="h82-0-25" class="d">-    private val coroutineScope = CoroutineScope(Dispatchers.IO)
</a><a href="#h82-0-26" id="h82-0-26" class="d">-    private var timeoutJob: Job? = null
</a><a href="#h82-0-27" id="h82-0-27" class="d">-    private var socketJob: Job? = null
</a><a href="#h82-0-28" id="h82-0-28" class="d">-
</a><a href="#h82-0-29" id="h82-0-29" class="d">-    private val cachedData = ConcurrentHashMap&lt;String, Pair&lt;InputStream, Long&gt;&gt;()
</a><a href="#h82-0-30" id="h82-0-30" class="d">-    private var serverSocket: ServerSocket? = null
</a><a href="#h82-0-31" id="h82-0-31" class="d">-
</a><a href="#h82-0-32" id="h82-0-32" class="d">-    fun ensureServerStarted(callback: HttpServer.() -&gt; Unit) {
</a><a href="#h82-0-33" id="h82-0-33" class="d">-        if (serverSocket != null &amp;&amp; !serverSocket!!.isClosed) {
</a><a href="#h82-0-34" id="h82-0-34" class="d">-            callback(this)
</a><a href="#h82-0-35" id="h82-0-35" class="d">-            return
</a><a href="#h82-0-36" id="h82-0-36" class="d">-        }
</a><a href="#h82-0-37" id="h82-0-37" class="d">-
</a><a href="#h82-0-38" id="h82-0-38" class="d">-        coroutineScope.launch(Dispatchers.IO) {
</a><a href="#h82-0-39" id="h82-0-39" class="d">-            Logger.directDebug(&quot;starting http server on port $port&quot;)
</a><a href="#h82-0-40" id="h82-0-40" class="d">-            serverSocket = ServerSocket(port)
</a><a href="#h82-0-41" id="h82-0-41" class="d">-            callback(this@HttpServer)
</a><a href="#h82-0-42" id="h82-0-42" class="d">-            while (!serverSocket!!.isClosed) {
</a><a href="#h82-0-43" id="h82-0-43" class="d">-                try {
</a><a href="#h82-0-44" id="h82-0-44" class="d">-                    val socket = serverSocket!!.accept()
</a><a href="#h82-0-45" id="h82-0-45" class="d">-                    timeoutJob?.cancel()
</a><a href="#h82-0-46" id="h82-0-46" class="d">-                    launch {
</a><a href="#h82-0-47" id="h82-0-47" class="d">-                        handleRequest(socket)
</a><a href="#h82-0-48" id="h82-0-48" class="d">-                        timeoutJob = launch {
</a><a href="#h82-0-49" id="h82-0-49" class="d">-                            delay(timeout.toLong())
</a><a href="#h82-0-50" id="h82-0-50" class="d">-                            Logger.directDebug(&quot;http server closed due to timeout&quot;)
</a><a href="#h82-0-51" id="h82-0-51" class="d">-                            runCatching {
</a><a href="#h82-0-52" id="h82-0-52" class="d">-                                socketJob?.cancel()
</a><a href="#h82-0-53" id="h82-0-53" class="d">-                                socket.close()
</a><a href="#h82-0-54" id="h82-0-54" class="d">-                                serverSocket?.close()
</a><a href="#h82-0-55" id="h82-0-55" class="d">-                            }.onFailure {
</a><a href="#h82-0-56" id="h82-0-56" class="d">-                                Logger.directError(&quot;failed to close socket&quot;, it)
</a><a href="#h82-0-57" id="h82-0-57" class="d">-                            }
</a><a href="#h82-0-58" id="h82-0-58" class="d">-                        }
</a><a href="#h82-0-59" id="h82-0-59" class="d">-                    }
</a><a href="#h82-0-60" id="h82-0-60" class="d">-                } catch (e: SocketException) {
</a><a href="#h82-0-61" id="h82-0-61" class="d">-                    Logger.directDebug(&quot;http server timed out&quot;)
</a><a href="#h82-0-62" id="h82-0-62" class="d">-                    break;
</a><a href="#h82-0-63" id="h82-0-63" class="d">-                } catch (e: Throwable) {
</a><a href="#h82-0-64" id="h82-0-64" class="d">-                    Logger.directError(&quot;failed to handle request&quot;, e)
</a><a href="#h82-0-65" id="h82-0-65" class="d">-                }
</a><a href="#h82-0-66" id="h82-0-66" class="d">-            }
</a><a href="#h82-0-67" id="h82-0-67" class="d">-        }.also { socketJob = it }
</a><a href="#h82-0-68" id="h82-0-68" class="d">-    }
</a><a href="#h82-0-69" id="h82-0-69" class="d">-
</a><a href="#h82-0-70" id="h82-0-70" class="d">-    fun close() {
</a><a href="#h82-0-71" id="h82-0-71" class="d">-        serverSocket?.close()
</a><a href="#h82-0-72" id="h82-0-72" class="d">-    }
</a><a href="#h82-0-73" id="h82-0-73" class="d">-
</a><a href="#h82-0-74" id="h82-0-74" class="d">-    fun putDownloadableContent(inputStream: InputStream, size: Long): String {
</a><a href="#h82-0-75" id="h82-0-75" class="d">-        val key = System.nanoTime().toString(16)
</a><a href="#h82-0-76" id="h82-0-76" class="d">-        cachedData[key] = inputStream to size
</a><a href="#h82-0-77" id="h82-0-77" class="d">-        return &quot;http://127.0.0.1:$port/$key&quot;
</a><a href="#h82-0-78" id="h82-0-78" class="d">-    }
</a><a href="#h82-0-79" id="h82-0-79" class="d">-
</a><a href="#h82-0-80" id="h82-0-80" class="d">-    private fun handleRequest(socket: Socket) {
</a><a href="#h82-0-81" id="h82-0-81" class="d">-        val reader = BufferedReader(InputStreamReader(socket.getInputStream()))
</a><a href="#h82-0-82" id="h82-0-82" class="d">-        val outputStream = socket.getOutputStream()
</a><a href="#h82-0-83" id="h82-0-83" class="d">-        val writer = PrintWriter(outputStream)
</a><a href="#h82-0-84" id="h82-0-84" class="d">-        val line = reader.readLine() ?: return
</a><a href="#h82-0-85" id="h82-0-85" class="d">-        fun close() {
</a><a href="#h82-0-86" id="h82-0-86" class="d">-            runCatching {
</a><a href="#h82-0-87" id="h82-0-87" class="d">-                reader.close()
</a><a href="#h82-0-88" id="h82-0-88" class="d">-                writer.close()
</a><a href="#h82-0-89" id="h82-0-89" class="d">-                outputStream.close()
</a><a href="#h82-0-90" id="h82-0-90" class="d">-                socket.close()
</a><a href="#h82-0-91" id="h82-0-91" class="d">-            }.onFailure {
</a><a href="#h82-0-92" id="h82-0-92" class="d">-                Logger.directError(&quot;failed to close socket&quot;, it)
</a><a href="#h82-0-93" id="h82-0-93" class="d">-            }
</a><a href="#h82-0-94" id="h82-0-94" class="d">-        }
</a><a href="#h82-0-95" id="h82-0-95" class="d">-        val parse = StringTokenizer(line)
</a><a href="#h82-0-96" id="h82-0-96" class="d">-        val method = parse.nextToken().uppercase(Locale.getDefault())
</a><a href="#h82-0-97" id="h82-0-97" class="d">-        var fileRequested = parse.nextToken().lowercase(Locale.getDefault())
</a><a href="#h82-0-98" id="h82-0-98" class="d">-        Logger.directDebug(&quot;[http-server:${port}] $method $fileRequested&quot;)
</a><a href="#h82-0-99" id="h82-0-99" class="d">-
</a><a href="#h82-0-100" id="h82-0-100" class="d">-        if (method != &quot;GET&quot;) {
</a><a href="#h82-0-101" id="h82-0-101" class="d">-            with(writer) {
</a><a href="#h82-0-102" id="h82-0-102" class="d">-                println(&quot;HTTP/1.1 501 Not Implemented&quot;)
</a><a href="#h82-0-103" id="h82-0-103" class="d">-                println(&quot;Content-type: &quot; + &quot;application/octet-stream&quot;)
</a><a href="#h82-0-104" id="h82-0-104" class="d">-                println(&quot;Content-length: &quot; + 0)
</a><a href="#h82-0-105" id="h82-0-105" class="d">-                println()
</a><a href="#h82-0-106" id="h82-0-106" class="d">-                flush()
</a><a href="#h82-0-107" id="h82-0-107" class="d">-            }
</a><a href="#h82-0-108" id="h82-0-108" class="d">-            close()
</a><a href="#h82-0-109" id="h82-0-109" class="d">-            return
</a><a href="#h82-0-110" id="h82-0-110" class="d">-        }
</a><a href="#h82-0-111" id="h82-0-111" class="d">-        if (fileRequested.startsWith(&quot;/&quot;)) {
</a><a href="#h82-0-112" id="h82-0-112" class="d">-            fileRequested = fileRequested.substring(1)
</a><a href="#h82-0-113" id="h82-0-113" class="d">-        }
</a><a href="#h82-0-114" id="h82-0-114" class="d">-        if (!cachedData.containsKey(fileRequested)) {
</a><a href="#h82-0-115" id="h82-0-115" class="d">-            with(writer) {
</a><a href="#h82-0-116" id="h82-0-116" class="d">-                println(&quot;HTTP/1.1 404 Not Found&quot;)
</a><a href="#h82-0-117" id="h82-0-117" class="d">-                println(&quot;Content-type: &quot; + &quot;application/octet-stream&quot;)
</a><a href="#h82-0-118" id="h82-0-118" class="d">-                println(&quot;Content-length: &quot; + 0)
</a><a href="#h82-0-119" id="h82-0-119" class="d">-                println()
</a><a href="#h82-0-120" id="h82-0-120" class="d">-                flush()
</a><a href="#h82-0-121" id="h82-0-121" class="d">-            }
</a><a href="#h82-0-122" id="h82-0-122" class="d">-            close()
</a><a href="#h82-0-123" id="h82-0-123" class="d">-            return
</a><a href="#h82-0-124" id="h82-0-124" class="d">-        }
</a><a href="#h82-0-125" id="h82-0-125" class="d">-        val requestedData = cachedData[fileRequested]!!
</a><a href="#h82-0-126" id="h82-0-126" class="d">-        with(writer) {
</a><a href="#h82-0-127" id="h82-0-127" class="d">-            println(&quot;HTTP/1.1 200 OK&quot;)
</a><a href="#h82-0-128" id="h82-0-128" class="d">-            println(&quot;Content-type: &quot; + &quot;application/octet-stream&quot;)
</a><a href="#h82-0-129" id="h82-0-129" class="d">-            println(&quot;Content-length: &quot; + requestedData.second)
</a><a href="#h82-0-130" id="h82-0-130" class="d">-            println()
</a><a href="#h82-0-131" id="h82-0-131" class="d">-            flush()
</a><a href="#h82-0-132" id="h82-0-132" class="d">-        }
</a><a href="#h82-0-133" id="h82-0-133" class="d">-        requestedData.first.copyTo(outputStream)
</a><a href="#h82-0-134" id="h82-0-134" class="d">-        outputStream.flush()
</a><a href="#h82-0-135" id="h82-0-135" class="d">-        cachedData.remove(fileRequested)
</a><a href="#h82-0-136" id="h82-0-136" class="d">-        close()
</a><a href="#h82-0-137" id="h82-0-137" class="d">-    }
</a><a href="#h82-0-138" id="h82-0-138" class="d">-}</a><a href="#h82-0-139" id="h82-0-139" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h83" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/util/download/RemoteMediaResolver.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/util/download/RemoteMediaResolver.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/util/download/RemoteMediaResolver.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/util/download/RemoteMediaResolver.kt</a></b>
<a href="#h83-0" id="h83-0" class="h">@@ -1,53 +0,0 @@
</a><a href="#h83-0-0" id="h83-0-0" class="d">-package me.rhunk.snapenhance.util.download
</a><a href="#h83-0-1" id="h83-0-1" class="d">-
</a><a href="#h83-0-2" id="h83-0-2" class="d">-import me.rhunk.snapenhance.Constants
</a><a href="#h83-0-3" id="h83-0-3" class="d">-import me.rhunk.snapenhance.Logger
</a><a href="#h83-0-4" id="h83-0-4" class="d">-import okhttp3.OkHttpClient
</a><a href="#h83-0-5" id="h83-0-5" class="d">-import okhttp3.Request
</a><a href="#h83-0-6" id="h83-0-6" class="d">-import java.io.ByteArrayInputStream
</a><a href="#h83-0-7" id="h83-0-7" class="d">-import java.io.InputStream
</a><a href="#h83-0-8" id="h83-0-8" class="d">-import java.util.Base64
</a><a href="#h83-0-9" id="h83-0-9" class="d">-
</a><a href="#h83-0-10" id="h83-0-10" class="d">-object RemoteMediaResolver {
</a><a href="#h83-0-11" id="h83-0-11" class="d">-    private const val BOLT_HTTP_RESOLVER_URL = &quot;https://aws.api.snapchat.com/bolt-http&quot;
</a><a href="#h83-0-12" id="h83-0-12" class="d">-    const val CF_ST_CDN_D = &quot;https://cf-st.sc-cdn.net/d/&quot;
</a><a href="#h83-0-13" id="h83-0-13" class="d">-
</a><a href="#h83-0-14" id="h83-0-14" class="d">-    private val urlCache = mutableMapOf&lt;String, String&gt;()
</a><a href="#h83-0-15" id="h83-0-15" class="d">-
</a><a href="#h83-0-16" id="h83-0-16" class="d">-    private val okHttpClient = OkHttpClient.Builder()
</a><a href="#h83-0-17" id="h83-0-17" class="d">-        .followRedirects(true)
</a><a href="#h83-0-18" id="h83-0-18" class="d">-        .retryOnConnectionFailure(true)
</a><a href="#h83-0-19" id="h83-0-19" class="d">-        .readTimeout(20, java.util.concurrent.TimeUnit.SECONDS)
</a><a href="#h83-0-20" id="h83-0-20" class="d">-        .addInterceptor { chain -&gt;
</a><a href="#h83-0-21" id="h83-0-21" class="d">-            val request = chain.request()
</a><a href="#h83-0-22" id="h83-0-22" class="d">-            val requestUrl = request.url.toString()
</a><a href="#h83-0-23" id="h83-0-23" class="d">-
</a><a href="#h83-0-24" id="h83-0-24" class="d">-            if (urlCache.containsKey(requestUrl)) {
</a><a href="#h83-0-25" id="h83-0-25" class="d">-                val cachedUrl = urlCache[requestUrl]!!
</a><a href="#h83-0-26" id="h83-0-26" class="d">-                return@addInterceptor chain.proceed(request.newBuilder().url(cachedUrl).build())
</a><a href="#h83-0-27" id="h83-0-27" class="d">-            }
</a><a href="#h83-0-28" id="h83-0-28" class="d">-
</a><a href="#h83-0-29" id="h83-0-29" class="d">-            chain.proceed(request).apply {
</a><a href="#h83-0-30" id="h83-0-30" class="d">-                val responseUrl = this.request.url.toString()
</a><a href="#h83-0-31" id="h83-0-31" class="d">-                if (responseUrl.startsWith(&quot;https://cf-st.sc-cdn.net&quot;)) {
</a><a href="#h83-0-32" id="h83-0-32" class="d">-                    urlCache[requestUrl] = responseUrl
</a><a href="#h83-0-33" id="h83-0-33" class="d">-                }
</a><a href="#h83-0-34" id="h83-0-34" class="d">-            }
</a><a href="#h83-0-35" id="h83-0-35" class="d">-        }
</a><a href="#h83-0-36" id="h83-0-36" class="d">-        .build()
</a><a href="#h83-0-37" id="h83-0-37" class="d">-
</a><a href="#h83-0-38" id="h83-0-38" class="d">-    fun downloadBoltMedia(protoKey: ByteArray): InputStream? {
</a><a href="#h83-0-39" id="h83-0-39" class="d">-        val request = Request.Builder()
</a><a href="#h83-0-40" id="h83-0-40" class="d">-            .url(BOLT_HTTP_RESOLVER_URL + &quot;/resolve?co=&quot; + Base64.getUrlEncoder().encodeToString(protoKey))
</a><a href="#h83-0-41" id="h83-0-41" class="d">-            .addHeader(&quot;User-Agent&quot;, Constants.USER_AGENT)
</a><a href="#h83-0-42" id="h83-0-42" class="d">-            .build()
</a><a href="#h83-0-43" id="h83-0-43" class="d">-
</a><a href="#h83-0-44" id="h83-0-44" class="d">-        okHttpClient.newCall(request).execute().use { response -&gt;
</a><a href="#h83-0-45" id="h83-0-45" class="d">-            if (!response.isSuccessful) {
</a><a href="#h83-0-46" id="h83-0-46" class="d">-                Logger.directDebug(&quot;Unexpected code $response&quot;)
</a><a href="#h83-0-47" id="h83-0-47" class="d">-                return null
</a><a href="#h83-0-48" id="h83-0-48" class="d">-            }
</a><a href="#h83-0-49" id="h83-0-49" class="d">-            return ByteArrayInputStream(response.body.bytes())
</a><a href="#h83-0-50" id="h83-0-50" class="d">-        }
</a><a href="#h83-0-51" id="h83-0-51" class="d">-    }
</a><a href="#h83-0-52" id="h83-0-52" class="d">-}
</a><b>diff --git a/<a id="h84" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/util/export/MessageExporter.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/util/export/MessageExporter.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/util/export/MessageExporter.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/util/export/MessageExporter.kt</a></b>
<a href="#h84-0" id="h84-0" class="h">@@ -1,342 +0,0 @@
</a><a href="#h84-0-0" id="h84-0-0" class="d">-package me.rhunk.snapenhance.util.export
</a><a href="#h84-0-1" id="h84-0-1" class="d">-
</a><a href="#h84-0-2" id="h84-0-2" class="d">-import android.os.Environment
</a><a href="#h84-0-3" id="h84-0-3" class="d">-import android.util.Base64InputStream
</a><a href="#h84-0-4" id="h84-0-4" class="d">-import com.google.gson.JsonArray
</a><a href="#h84-0-5" id="h84-0-5" class="d">-import com.google.gson.JsonObject
</a><a href="#h84-0-6" id="h84-0-6" class="d">-import de.robv.android.xposed.XposedHelpers
</a><a href="#h84-0-7" id="h84-0-7" class="d">-import kotlinx.coroutines.Dispatchers
</a><a href="#h84-0-8" id="h84-0-8" class="d">-import kotlinx.coroutines.withContext
</a><a href="#h84-0-9" id="h84-0-9" class="d">-import me.rhunk.snapenhance.ModContext
</a><a href="#h84-0-10" id="h84-0-10" class="d">-import me.rhunk.snapenhance.core.BuildConfig
</a><a href="#h84-0-11" id="h84-0-11" class="d">-import me.rhunk.snapenhance.core.database.objects.FriendFeedEntry
</a><a href="#h84-0-12" id="h84-0-12" class="d">-import me.rhunk.snapenhance.core.database.objects.FriendInfo
</a><a href="#h84-0-13" id="h84-0-13" class="d">-import me.rhunk.snapenhance.data.ContentType
</a><a href="#h84-0-14" id="h84-0-14" class="d">-import me.rhunk.snapenhance.data.FileType
</a><a href="#h84-0-15" id="h84-0-15" class="d">-import me.rhunk.snapenhance.data.MediaReferenceType
</a><a href="#h84-0-16" id="h84-0-16" class="d">-import me.rhunk.snapenhance.data.wrapper.impl.Message
</a><a href="#h84-0-17" id="h84-0-17" class="d">-import me.rhunk.snapenhance.data.wrapper.impl.SnapUUID
</a><a href="#h84-0-18" id="h84-0-18" class="d">-import me.rhunk.snapenhance.util.protobuf.ProtoReader
</a><a href="#h84-0-19" id="h84-0-19" class="d">-import me.rhunk.snapenhance.util.snap.EncryptionHelper
</a><a href="#h84-0-20" id="h84-0-20" class="d">-import me.rhunk.snapenhance.util.snap.MediaDownloaderHelper
</a><a href="#h84-0-21" id="h84-0-21" class="d">-import java.io.File
</a><a href="#h84-0-22" id="h84-0-22" class="d">-import java.io.FileOutputStream
</a><a href="#h84-0-23" id="h84-0-23" class="d">-import java.io.InputStream
</a><a href="#h84-0-24" id="h84-0-24" class="d">-import java.io.OutputStream
</a><a href="#h84-0-25" id="h84-0-25" class="d">-import java.text.SimpleDateFormat
</a><a href="#h84-0-26" id="h84-0-26" class="d">-import java.util.Base64
</a><a href="#h84-0-27" id="h84-0-27" class="d">-import java.util.Collections
</a><a href="#h84-0-28" id="h84-0-28" class="d">-import java.util.Date
</a><a href="#h84-0-29" id="h84-0-29" class="d">-import java.util.Locale
</a><a href="#h84-0-30" id="h84-0-30" class="d">-import java.util.concurrent.Executors
</a><a href="#h84-0-31" id="h84-0-31" class="d">-import java.util.concurrent.TimeUnit
</a><a href="#h84-0-32" id="h84-0-32" class="d">-import java.util.zip.Deflater
</a><a href="#h84-0-33" id="h84-0-33" class="d">-import java.util.zip.DeflaterInputStream
</a><a href="#h84-0-34" id="h84-0-34" class="d">-import java.util.zip.ZipFile
</a><a href="#h84-0-35" id="h84-0-35" class="d">-import kotlin.io.encoding.ExperimentalEncodingApi
</a><a href="#h84-0-36" id="h84-0-36" class="d">-
</a><a href="#h84-0-37" id="h84-0-37" class="d">-
</a><a href="#h84-0-38" id="h84-0-38" class="d">-enum class ExportFormat(
</a><a href="#h84-0-39" id="h84-0-39" class="d">-    val extension: String,
</a><a href="#h84-0-40" id="h84-0-40" class="d">-){
</a><a href="#h84-0-41" id="h84-0-41" class="d">-    JSON(&quot;json&quot;),
</a><a href="#h84-0-42" id="h84-0-42" class="d">-    TEXT(&quot;txt&quot;),
</a><a href="#h84-0-43" id="h84-0-43" class="d">-    HTML(&quot;html&quot;);
</a><a href="#h84-0-44" id="h84-0-44" class="d">-}
</a><a href="#h84-0-45" id="h84-0-45" class="d">-
</a><a href="#h84-0-46" id="h84-0-46" class="d">-class MessageExporter(
</a><a href="#h84-0-47" id="h84-0-47" class="d">-    private val context: ModContext,
</a><a href="#h84-0-48" id="h84-0-48" class="d">-    private val outputFile: File,
</a><a href="#h84-0-49" id="h84-0-49" class="d">-    private val friendFeedEntry: FriendFeedEntry,
</a><a href="#h84-0-50" id="h84-0-50" class="d">-    private val mediaToDownload: List&lt;ContentType&gt;? = null,
</a><a href="#h84-0-51" id="h84-0-51" class="d">-    private val printLog: (String) -&gt; Unit = {},
</a><a href="#h84-0-52" id="h84-0-52" class="d">-) {
</a><a href="#h84-0-53" id="h84-0-53" class="d">-    private lateinit var conversationParticipants: Map&lt;String, FriendInfo&gt;
</a><a href="#h84-0-54" id="h84-0-54" class="d">-    private lateinit var messages: List&lt;Message&gt;
</a><a href="#h84-0-55" id="h84-0-55" class="d">-
</a><a href="#h84-0-56" id="h84-0-56" class="d">-    fun readMessages(messages: List&lt;Message&gt;) {
</a><a href="#h84-0-57" id="h84-0-57" class="d">-        conversationParticipants =
</a><a href="#h84-0-58" id="h84-0-58" class="d">-            context.database.getConversationParticipants(friendFeedEntry.key!!)
</a><a href="#h84-0-59" id="h84-0-59" class="d">-                ?.mapNotNull {
</a><a href="#h84-0-60" id="h84-0-60" class="d">-                    context.database.getFriendInfo(it)
</a><a href="#h84-0-61" id="h84-0-61" class="d">-                }?.associateBy { it.userId!! } ?: emptyMap()
</a><a href="#h84-0-62" id="h84-0-62" class="d">-
</a><a href="#h84-0-63" id="h84-0-63" class="d">-        if (conversationParticipants.isEmpty())
</a><a href="#h84-0-64" id="h84-0-64" class="d">-            throw Throwable(&quot;Failed to get conversation participants for ${friendFeedEntry.key}&quot;)
</a><a href="#h84-0-65" id="h84-0-65" class="d">-
</a><a href="#h84-0-66" id="h84-0-66" class="d">-        this.messages = messages.sortedBy { it.orderKey }
</a><a href="#h84-0-67" id="h84-0-67" class="d">-    }
</a><a href="#h84-0-68" id="h84-0-68" class="d">-
</a><a href="#h84-0-69" id="h84-0-69" class="d">-    private fun serializeMessageContent(message: Message): String? {
</a><a href="#h84-0-70" id="h84-0-70" class="d">-        return if (message.messageContent.contentType == ContentType.CHAT) {
</a><a href="#h84-0-71" id="h84-0-71" class="d">-            ProtoReader(message.messageContent.content).getString(2, 1) ?: &quot;Failed to parse message&quot;
</a><a href="#h84-0-72" id="h84-0-72" class="d">-        } else null
</a><a href="#h84-0-73" id="h84-0-73" class="d">-    }
</a><a href="#h84-0-74" id="h84-0-74" class="d">-
</a><a href="#h84-0-75" id="h84-0-75" class="d">-    private fun exportText(output: OutputStream) {
</a><a href="#h84-0-76" id="h84-0-76" class="d">-        val writer = output.bufferedWriter()
</a><a href="#h84-0-77" id="h84-0-77" class="d">-        writer.write(&quot;Conversation key: ${friendFeedEntry.key}\n&quot;)
</a><a href="#h84-0-78" id="h84-0-78" class="d">-        writer.write(&quot;Conversation Name: ${friendFeedEntry.feedDisplayName}\n&quot;)
</a><a href="#h84-0-79" id="h84-0-79" class="d">-        writer.write(&quot;Participants:\n&quot;)
</a><a href="#h84-0-80" id="h84-0-80" class="d">-        conversationParticipants.forEach { (userId, friendInfo) -&gt;
</a><a href="#h84-0-81" id="h84-0-81" class="d">-            writer.write(&quot;  $userId: ${friendInfo.displayName}\n&quot;)
</a><a href="#h84-0-82" id="h84-0-82" class="d">-        }
</a><a href="#h84-0-83" id="h84-0-83" class="d">-
</a><a href="#h84-0-84" id="h84-0-84" class="d">-        writer.write(&quot;\nMessages:\n&quot;)
</a><a href="#h84-0-85" id="h84-0-85" class="d">-        messages.forEach { message -&gt;
</a><a href="#h84-0-86" id="h84-0-86" class="d">-            val sender = conversationParticipants[message.senderId.toString()]
</a><a href="#h84-0-87" id="h84-0-87" class="d">-            val senderUsername = sender?.usernameForSorting ?: message.senderId.toString()
</a><a href="#h84-0-88" id="h84-0-88" class="d">-            val senderDisplayName = sender?.displayName ?: message.senderId.toString()
</a><a href="#h84-0-89" id="h84-0-89" class="d">-            val messageContent = serializeMessageContent(message) ?: message.messageContent.contentType?.name
</a><a href="#h84-0-90" id="h84-0-90" class="d">-            val date = SimpleDateFormat(&quot;yyyy-MM-dd HH:mm:ss&quot;, Locale.ENGLISH).format(Date(message.messageMetadata.createdAt))
</a><a href="#h84-0-91" id="h84-0-91" class="d">-            writer.write(&quot;[$date] - $senderDisplayName (${senderUsername}): $messageContent\n&quot;)
</a><a href="#h84-0-92" id="h84-0-92" class="d">-        }
</a><a href="#h84-0-93" id="h84-0-93" class="d">-        writer.flush()
</a><a href="#h84-0-94" id="h84-0-94" class="d">-    }
</a><a href="#h84-0-95" id="h84-0-95" class="d">-
</a><a href="#h84-0-96" id="h84-0-96" class="d">-    @OptIn(ExperimentalEncodingApi::class)
</a><a href="#h84-0-97" id="h84-0-97" class="d">-    suspend fun exportHtml(output: OutputStream) {
</a><a href="#h84-0-98" id="h84-0-98" class="d">-        val downloadMediaCacheFolder = File(Environment.getExternalStoragePublicDirectory(Environment.DIRECTORY_DOWNLOADS), &quot;SnapEnhance/cache&quot;).also { it.mkdirs() }
</a><a href="#h84-0-99" id="h84-0-99" class="d">-        val mediaFiles = Collections.synchronizedMap(mutableMapOf&lt;String, Pair&lt;FileType, File&gt;&gt;())
</a><a href="#h84-0-100" id="h84-0-100" class="d">-        val threadPool = Executors.newFixedThreadPool(15)
</a><a href="#h84-0-101" id="h84-0-101" class="d">-
</a><a href="#h84-0-102" id="h84-0-102" class="d">-        withContext(Dispatchers.IO) {
</a><a href="#h84-0-103" id="h84-0-103" class="d">-            var processCount = 0
</a><a href="#h84-0-104" id="h84-0-104" class="d">-
</a><a href="#h84-0-105" id="h84-0-105" class="d">-            fun updateProgress(type: String) {
</a><a href="#h84-0-106" id="h84-0-106" class="d">-                val total = messages.filter {
</a><a href="#h84-0-107" id="h84-0-107" class="d">-                    mediaToDownload?.contains(it.messageContent.contentType) ?: false
</a><a href="#h84-0-108" id="h84-0-108" class="d">-                }.size
</a><a href="#h84-0-109" id="h84-0-109" class="d">-                processCount++
</a><a href="#h84-0-110" id="h84-0-110" class="d">-                printLog(&quot;$type $processCount/$total&quot;)
</a><a href="#h84-0-111" id="h84-0-111" class="d">-            }
</a><a href="#h84-0-112" id="h84-0-112" class="d">-
</a><a href="#h84-0-113" id="h84-0-113" class="d">-            messages.filter {
</a><a href="#h84-0-114" id="h84-0-114" class="d">-                mediaToDownload?.contains(it.messageContent.contentType) ?: false
</a><a href="#h84-0-115" id="h84-0-115" class="d">-            }.forEach { message -&gt;
</a><a href="#h84-0-116" id="h84-0-116" class="d">-                threadPool.execute {
</a><a href="#h84-0-117" id="h84-0-117" class="d">-                    val remoteMediaReferences by lazy {
</a><a href="#h84-0-118" id="h84-0-118" class="d">-                        val serializedMessageContent = context.gson.toJsonTree(message.messageContent.instanceNonNull()).asJsonObject
</a><a href="#h84-0-119" id="h84-0-119" class="d">-                        serializedMessageContent[&quot;mRemoteMediaReferences&quot;]
</a><a href="#h84-0-120" id="h84-0-120" class="d">-                            .asJsonArray.map { it.asJsonObject[&quot;mMediaReferences&quot;].asJsonArray }
</a><a href="#h84-0-121" id="h84-0-121" class="d">-                            .flatten()
</a><a href="#h84-0-122" id="h84-0-122" class="d">-                    }
</a><a href="#h84-0-123" id="h84-0-123" class="d">-
</a><a href="#h84-0-124" id="h84-0-124" class="d">-                    remoteMediaReferences.firstOrNull().takeIf { it != null }?.let { media -&gt;
</a><a href="#h84-0-125" id="h84-0-125" class="d">-                        val protoMediaReference = media.asJsonObject[&quot;mContentObject&quot;].asJsonArray.map { it.asByte }.toByteArray()
</a><a href="#h84-0-126" id="h84-0-126" class="d">-
</a><a href="#h84-0-127" id="h84-0-127" class="d">-                        runCatching {
</a><a href="#h84-0-128" id="h84-0-128" class="d">-                            val downloadedMedia = MediaDownloaderHelper.downloadMediaFromReference(protoMediaReference) {
</a><a href="#h84-0-129" id="h84-0-129" class="d">-                                EncryptionHelper.decryptInputStream(it, message.messageContent.contentType!!, ProtoReader(message.messageContent.content), isArroyo = false)
</a><a href="#h84-0-130" id="h84-0-130" class="d">-                            }
</a><a href="#h84-0-131" id="h84-0-131" class="d">-
</a><a href="#h84-0-132" id="h84-0-132" class="d">-                            downloadedMedia.forEach { (type, mediaData) -&gt;
</a><a href="#h84-0-133" id="h84-0-133" class="d">-                                val fileType = FileType.fromByteArray(mediaData)
</a><a href="#h84-0-134" id="h84-0-134" class="d">-                                val fileName = &quot;${type}_${kotlin.io.encoding.Base64.UrlSafe.encode(protoMediaReference).replace(&quot;=&quot;, &quot;&quot;)}&quot;
</a><a href="#h84-0-135" id="h84-0-135" class="d">-
</a><a href="#h84-0-136" id="h84-0-136" class="d">-                                val mediaFile = File(downloadMediaCacheFolder, &quot;$fileName.${fileType.fileExtension}&quot;)
</a><a href="#h84-0-137" id="h84-0-137" class="d">-
</a><a href="#h84-0-138" id="h84-0-138" class="d">-                                FileOutputStream(mediaFile).use { fos -&gt;
</a><a href="#h84-0-139" id="h84-0-139" class="d">-                                    mediaData.inputStream().copyTo(fos)
</a><a href="#h84-0-140" id="h84-0-140" class="d">-                                }
</a><a href="#h84-0-141" id="h84-0-141" class="d">-
</a><a href="#h84-0-142" id="h84-0-142" class="d">-                                mediaFiles[fileName] = fileType to mediaFile
</a><a href="#h84-0-143" id="h84-0-143" class="d">-                                updateProgress(&quot;downloaded&quot;)
</a><a href="#h84-0-144" id="h84-0-144" class="d">-                            }
</a><a href="#h84-0-145" id="h84-0-145" class="d">-                        }.onFailure {
</a><a href="#h84-0-146" id="h84-0-146" class="d">-                            printLog(&quot;failed to download media for ${message.messageDescriptor.conversationId}_${message.orderKey}&quot;)
</a><a href="#h84-0-147" id="h84-0-147" class="d">-                            context.log.error(&quot;failed to download media for ${message.messageDescriptor.conversationId}_${message.orderKey}&quot;, it)
</a><a href="#h84-0-148" id="h84-0-148" class="d">-                        }
</a><a href="#h84-0-149" id="h84-0-149" class="d">-                    }
</a><a href="#h84-0-150" id="h84-0-150" class="d">-                }
</a><a href="#h84-0-151" id="h84-0-151" class="d">-            }
</a><a href="#h84-0-152" id="h84-0-152" class="d">-
</a><a href="#h84-0-153" id="h84-0-153" class="d">-            threadPool.shutdown()
</a><a href="#h84-0-154" id="h84-0-154" class="d">-            threadPool.awaitTermination(30, TimeUnit.DAYS)
</a><a href="#h84-0-155" id="h84-0-155" class="d">-            processCount = 0
</a><a href="#h84-0-156" id="h84-0-156" class="d">-
</a><a href="#h84-0-157" id="h84-0-157" class="d">-            printLog(&quot;writing downloaded medias...&quot;)
</a><a href="#h84-0-158" id="h84-0-158" class="d">-
</a><a href="#h84-0-159" id="h84-0-159" class="d">-            //write the head of the html file
</a><a href="#h84-0-160" id="h84-0-160" class="d">-            output.write(&quot;&quot;&quot;
</a><a href="#h84-0-161" id="h84-0-161" class="d">-                &lt;!DOCTYPE html&gt;
</a><a href="#h84-0-162" id="h84-0-162" class="d">-                &lt;html&gt;
</a><a href="#h84-0-163" id="h84-0-163" class="d">-                &lt;head&gt;
</a><a href="#h84-0-164" id="h84-0-164" class="d">-                    &lt;meta charset=&quot;UTF-8&quot;&gt;
</a><a href="#h84-0-165" id="h84-0-165" class="d">-                    &lt;meta http-equiv=&quot;X-UA-Compatible&quot; content=&quot;IE=edge&quot;&gt;
</a><a href="#h84-0-166" id="h84-0-166" class="d">-                    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot;&gt;
</a><a href="#h84-0-167" id="h84-0-167" class="d">-                    &lt;title&gt;&lt;/title&gt;
</a><a href="#h84-0-168" id="h84-0-168" class="d">-                &lt;/head&gt;
</a><a href="#h84-0-169" id="h84-0-169" class="d">-            &quot;&quot;&quot;.trimIndent().toByteArray())
</a><a href="#h84-0-170" id="h84-0-170" class="d">-
</a><a href="#h84-0-171" id="h84-0-171" class="d">-            output.write(&quot;&lt;!-- This file was generated by SnapEnhance ${BuildConfig.VERSION_NAME} --&gt;\n&quot;.toByteArray())
</a><a href="#h84-0-172" id="h84-0-172" class="d">-
</a><a href="#h84-0-173" id="h84-0-173" class="d">-            mediaFiles.forEach { (key, filePair) -&gt;
</a><a href="#h84-0-174" id="h84-0-174" class="d">-                output.write(&quot;&lt;div class=\&quot;media-$key\&quot;&gt;&lt;!-- &quot;.toByteArray())
</a><a href="#h84-0-175" id="h84-0-175" class="d">-
</a><a href="#h84-0-176" id="h84-0-176" class="d">-                val deflateInputStream = DeflaterInputStream(filePair.second.inputStream(), Deflater(Deflater.BEST_COMPRESSION, true))
</a><a href="#h84-0-177" id="h84-0-177" class="d">-                val base64InputStream = XposedHelpers.newInstance(
</a><a href="#h84-0-178" id="h84-0-178" class="d">-                    Base64InputStream::class.java,
</a><a href="#h84-0-179" id="h84-0-179" class="d">-                    deflateInputStream,
</a><a href="#h84-0-180" id="h84-0-180" class="d">-                    android.util.Base64.DEFAULT or android.util.Base64.NO_WRAP,
</a><a href="#h84-0-181" id="h84-0-181" class="d">-                    true
</a><a href="#h84-0-182" id="h84-0-182" class="d">-                ) as InputStream
</a><a href="#h84-0-183" id="h84-0-183" class="d">-                base64InputStream.copyTo(output)
</a><a href="#h84-0-184" id="h84-0-184" class="d">-                deflateInputStream.close()
</a><a href="#h84-0-185" id="h84-0-185" class="d">-
</a><a href="#h84-0-186" id="h84-0-186" class="d">-                output.write(&quot; --&gt;&lt;/div&gt;\n&quot;.toByteArray())
</a><a href="#h84-0-187" id="h84-0-187" class="d">-                output.flush()
</a><a href="#h84-0-188" id="h84-0-188" class="d">-                updateProgress(&quot;wrote&quot;)
</a><a href="#h84-0-189" id="h84-0-189" class="d">-            }
</a><a href="#h84-0-190" id="h84-0-190" class="d">-            printLog(&quot;writing json conversation data...&quot;)
</a><a href="#h84-0-191" id="h84-0-191" class="d">-
</a><a href="#h84-0-192" id="h84-0-192" class="d">-            //write the json file
</a><a href="#h84-0-193" id="h84-0-193" class="d">-            output.write(&quot;&lt;script type=\&quot;application/json\&quot; class=\&quot;exported_content\&quot;&gt;&quot;.toByteArray())
</a><a href="#h84-0-194" id="h84-0-194" class="d">-            exportJson(output)
</a><a href="#h84-0-195" id="h84-0-195" class="d">-            output.write(&quot;&lt;/script&gt;\n&quot;.toByteArray())
</a><a href="#h84-0-196" id="h84-0-196" class="d">-
</a><a href="#h84-0-197" id="h84-0-197" class="d">-            printLog(&quot;writing template...&quot;)
</a><a href="#h84-0-198" id="h84-0-198" class="d">-
</a><a href="#h84-0-199" id="h84-0-199" class="d">-            runCatching {
</a><a href="#h84-0-200" id="h84-0-200" class="d">-                ZipFile(context.bridgeClient.getApplicationApkPath()).use { apkFile -&gt;
</a><a href="#h84-0-201" id="h84-0-201" class="d">-                    //export rawinflate.js
</a><a href="#h84-0-202" id="h84-0-202" class="d">-                    apkFile.getEntry(&quot;assets/web/rawinflate.js&quot;).let { entry -&gt;
</a><a href="#h84-0-203" id="h84-0-203" class="d">-                        output.write(&quot;&lt;script&gt;&quot;.toByteArray())
</a><a href="#h84-0-204" id="h84-0-204" class="d">-                        apkFile.getInputStream(entry).copyTo(output)
</a><a href="#h84-0-205" id="h84-0-205" class="d">-                        output.write(&quot;&lt;/script&gt;\n&quot;.toByteArray())
</a><a href="#h84-0-206" id="h84-0-206" class="d">-                    }
</a><a href="#h84-0-207" id="h84-0-207" class="d">-
</a><a href="#h84-0-208" id="h84-0-208" class="d">-                    //export avenir next font
</a><a href="#h84-0-209" id="h84-0-209" class="d">-                    apkFile.getEntry(&quot;res/font/avenir_next_medium.ttf&quot;).let { entry -&gt;
</a><a href="#h84-0-210" id="h84-0-210" class="d">-                        val encodedFontData = kotlin.io.encoding.Base64.Default.encode(apkFile.getInputStream(entry).readBytes())
</a><a href="#h84-0-211" id="h84-0-211" class="d">-                        output.write(&quot;&quot;&quot;
</a><a href="#h84-0-212" id="h84-0-212" class="d">-                        &lt;style&gt;
</a><a href="#h84-0-213" id="h84-0-213" class="d">-                            @font-face {
</a><a href="#h84-0-214" id="h84-0-214" class="d">-                                font-family: &#39;Avenir Next&#39;;
</a><a href="#h84-0-215" id="h84-0-215" class="d">-                                src: url(&#39;data:font/truetype;charset=utf-8;base64, $encodedFontData&#39;);
</a><a href="#h84-0-216" id="h84-0-216" class="d">-                                font-weight: normal;
</a><a href="#h84-0-217" id="h84-0-217" class="d">-                                font-style: normal;
</a><a href="#h84-0-218" id="h84-0-218" class="d">-                            }
</a><a href="#h84-0-219" id="h84-0-219" class="d">-                        &lt;/style&gt;
</a><a href="#h84-0-220" id="h84-0-220" class="d">-                    &quot;&quot;&quot;.trimIndent().toByteArray())
</a><a href="#h84-0-221" id="h84-0-221" class="d">-                    }
</a><a href="#h84-0-222" id="h84-0-222" class="d">-
</a><a href="#h84-0-223" id="h84-0-223" class="d">-                    apkFile.getEntry(&quot;assets/web/export_template.html&quot;).let { entry -&gt;
</a><a href="#h84-0-224" id="h84-0-224" class="d">-                        apkFile.getInputStream(entry).copyTo(output)
</a><a href="#h84-0-225" id="h84-0-225" class="d">-                    }
</a><a href="#h84-0-226" id="h84-0-226" class="d">-
</a><a href="#h84-0-227" id="h84-0-227" class="d">-                    apkFile.close()
</a><a href="#h84-0-228" id="h84-0-228" class="d">-                }
</a><a href="#h84-0-229" id="h84-0-229" class="d">-            }.onFailure {
</a><a href="#h84-0-230" id="h84-0-230" class="d">-                throw Throwable(&quot;Failed to read template from apk&quot;, it)
</a><a href="#h84-0-231" id="h84-0-231" class="d">-            }
</a><a href="#h84-0-232" id="h84-0-232" class="d">-
</a><a href="#h84-0-233" id="h84-0-233" class="d">-            output.write(&quot;&lt;/html&gt;&quot;.toByteArray())
</a><a href="#h84-0-234" id="h84-0-234" class="d">-            output.close()
</a><a href="#h84-0-235" id="h84-0-235" class="d">-        }
</a><a href="#h84-0-236" id="h84-0-236" class="d">-    }
</a><a href="#h84-0-237" id="h84-0-237" class="d">-
</a><a href="#h84-0-238" id="h84-0-238" class="d">-    private fun exportJson(output: OutputStream) {
</a><a href="#h84-0-239" id="h84-0-239" class="d">-        val rootObject = JsonObject().apply {
</a><a href="#h84-0-240" id="h84-0-240" class="d">-            addProperty(&quot;conversationId&quot;, friendFeedEntry.key)
</a><a href="#h84-0-241" id="h84-0-241" class="d">-            addProperty(&quot;conversationName&quot;, friendFeedEntry.feedDisplayName)
</a><a href="#h84-0-242" id="h84-0-242" class="d">-
</a><a href="#h84-0-243" id="h84-0-243" class="d">-            var index = 0
</a><a href="#h84-0-244" id="h84-0-244" class="d">-            val participants = mutableMapOf&lt;String, Int&gt;()
</a><a href="#h84-0-245" id="h84-0-245" class="d">-
</a><a href="#h84-0-246" id="h84-0-246" class="d">-            add(&quot;participants&quot;, JsonObject().apply {
</a><a href="#h84-0-247" id="h84-0-247" class="d">-                conversationParticipants.forEach { (userId, friendInfo) -&gt;
</a><a href="#h84-0-248" id="h84-0-248" class="d">-                    add(userId, JsonObject().apply {
</a><a href="#h84-0-249" id="h84-0-249" class="d">-                        addProperty(&quot;id&quot;, index)
</a><a href="#h84-0-250" id="h84-0-250" class="d">-                        addProperty(&quot;displayName&quot;, friendInfo.displayName)
</a><a href="#h84-0-251" id="h84-0-251" class="d">-                        addProperty(&quot;username&quot;, friendInfo.usernameForSorting)
</a><a href="#h84-0-252" id="h84-0-252" class="d">-                        addProperty(&quot;bitmojiSelfieId&quot;, friendInfo.bitmojiSelfieId)
</a><a href="#h84-0-253" id="h84-0-253" class="d">-                    })
</a><a href="#h84-0-254" id="h84-0-254" class="d">-                    participants[userId] = index++
</a><a href="#h84-0-255" id="h84-0-255" class="d">-                }
</a><a href="#h84-0-256" id="h84-0-256" class="d">-            })
</a><a href="#h84-0-257" id="h84-0-257" class="d">-            add(&quot;messages&quot;, JsonArray().apply {
</a><a href="#h84-0-258" id="h84-0-258" class="d">-                messages.forEach { message -&gt;
</a><a href="#h84-0-259" id="h84-0-259" class="d">-                    add(JsonObject().apply {
</a><a href="#h84-0-260" id="h84-0-260" class="d">-                        addProperty(&quot;orderKey&quot;, message.orderKey)
</a><a href="#h84-0-261" id="h84-0-261" class="d">-                        addProperty(&quot;senderId&quot;, participants.getOrDefault(message.senderId.toString(), -1))
</a><a href="#h84-0-262" id="h84-0-262" class="d">-                        addProperty(&quot;type&quot;, message.messageContent.contentType.toString())
</a><a href="#h84-0-263" id="h84-0-263" class="d">-
</a><a href="#h84-0-264" id="h84-0-264" class="d">-                        fun addUUIDList(name: String, list: List&lt;SnapUUID&gt;) {
</a><a href="#h84-0-265" id="h84-0-265" class="d">-                            add(name, JsonArray().apply {
</a><a href="#h84-0-266" id="h84-0-266" class="d">-                                list.map { participants.getOrDefault(it.toString(), -1) }.forEach { add(it) }
</a><a href="#h84-0-267" id="h84-0-267" class="d">-                            })
</a><a href="#h84-0-268" id="h84-0-268" class="d">-                        }
</a><a href="#h84-0-269" id="h84-0-269" class="d">-
</a><a href="#h84-0-270" id="h84-0-270" class="d">-                        addUUIDList(&quot;savedBy&quot;, message.messageMetadata.savedBy)
</a><a href="#h84-0-271" id="h84-0-271" class="d">-                        addUUIDList(&quot;seenBy&quot;, message.messageMetadata.seenBy)
</a><a href="#h84-0-272" id="h84-0-272" class="d">-                        addUUIDList(&quot;openedBy&quot;, message.messageMetadata.openedBy)
</a><a href="#h84-0-273" id="h84-0-273" class="d">-
</a><a href="#h84-0-274" id="h84-0-274" class="d">-                        add(&quot;reactions&quot;, JsonObject().apply {
</a><a href="#h84-0-275" id="h84-0-275" class="d">-                            message.messageMetadata.reactions.forEach { reaction -&gt;
</a><a href="#h84-0-276" id="h84-0-276" class="d">-                                addProperty(
</a><a href="#h84-0-277" id="h84-0-277" class="d">-                                    participants.getOrDefault(reaction.userId.toString(), -1L).toString(),
</a><a href="#h84-0-278" id="h84-0-278" class="d">-                                    reaction.reactionId
</a><a href="#h84-0-279" id="h84-0-279" class="d">-                                )
</a><a href="#h84-0-280" id="h84-0-280" class="d">-                            }
</a><a href="#h84-0-281" id="h84-0-281" class="d">-                        })
</a><a href="#h84-0-282" id="h84-0-282" class="d">-
</a><a href="#h84-0-283" id="h84-0-283" class="d">-                        addProperty(&quot;createdTimestamp&quot;, message.messageMetadata.createdAt)
</a><a href="#h84-0-284" id="h84-0-284" class="d">-                        addProperty(&quot;readTimestamp&quot;, message.messageMetadata.readAt)
</a><a href="#h84-0-285" id="h84-0-285" class="d">-                        addProperty(&quot;serializedContent&quot;, serializeMessageContent(message))
</a><a href="#h84-0-286" id="h84-0-286" class="d">-                        addProperty(&quot;rawContent&quot;, Base64.getUrlEncoder().encodeToString(message.messageContent.content))
</a><a href="#h84-0-287" id="h84-0-287" class="d">-
</a><a href="#h84-0-288" id="h84-0-288" class="d">-                        val messageContentType = message.messageContent.contentType ?: ContentType.CHAT
</a><a href="#h84-0-289" id="h84-0-289" class="d">-
</a><a href="#h84-0-290" id="h84-0-290" class="d">-                        EncryptionHelper.getEncryptionKeys(messageContentType, ProtoReader(message.messageContent.content), isArroyo = false)?.let { encryptionKeyPair -&gt;
</a><a href="#h84-0-291" id="h84-0-291" class="d">-                            add(&quot;encryption&quot;, JsonObject().apply encryption@{
</a><a href="#h84-0-292" id="h84-0-292" class="d">-                                addProperty(&quot;key&quot;, Base64.getEncoder().encodeToString(encryptionKeyPair.first))
</a><a href="#h84-0-293" id="h84-0-293" class="d">-                                addProperty(&quot;iv&quot;, Base64.getEncoder().encodeToString(encryptionKeyPair.second))
</a><a href="#h84-0-294" id="h84-0-294" class="d">-                            })
</a><a href="#h84-0-295" id="h84-0-295" class="d">-                        }
</a><a href="#h84-0-296" id="h84-0-296" class="d">-
</a><a href="#h84-0-297" id="h84-0-297" class="d">-                        val remoteMediaReferences by lazy {
</a><a href="#h84-0-298" id="h84-0-298" class="d">-                            val serializedMessageContent = context.gson.toJsonTree(message.messageContent.instanceNonNull()).asJsonObject
</a><a href="#h84-0-299" id="h84-0-299" class="d">-                            serializedMessageContent[&quot;mRemoteMediaReferences&quot;]
</a><a href="#h84-0-300" id="h84-0-300" class="d">-                                .asJsonArray.map { it.asJsonObject[&quot;mMediaReferences&quot;].asJsonArray }
</a><a href="#h84-0-301" id="h84-0-301" class="d">-                                .flatten()
</a><a href="#h84-0-302" id="h84-0-302" class="d">-                        }
</a><a href="#h84-0-303" id="h84-0-303" class="d">-
</a><a href="#h84-0-304" id="h84-0-304" class="d">-                        add(&quot;mediaReferences&quot;, JsonArray().apply mediaReferences@ {
</a><a href="#h84-0-305" id="h84-0-305" class="d">-                            if (messageContentType != ContentType.EXTERNAL_MEDIA &amp;&amp;
</a><a href="#h84-0-306" id="h84-0-306" class="d">-                                messageContentType != ContentType.STICKER &amp;&amp;
</a><a href="#h84-0-307" id="h84-0-307" class="d">-                                messageContentType != ContentType.SNAP &amp;&amp;
</a><a href="#h84-0-308" id="h84-0-308" class="d">-                                messageContentType != ContentType.NOTE)
</a><a href="#h84-0-309" id="h84-0-309" class="d">-                                return@mediaReferences
</a><a href="#h84-0-310" id="h84-0-310" class="d">-
</a><a href="#h84-0-311" id="h84-0-311" class="d">-                            remoteMediaReferences.forEach { media -&gt;
</a><a href="#h84-0-312" id="h84-0-312" class="d">-                                val protoMediaReference = media.asJsonObject[&quot;mContentObject&quot;].asJsonArray.map { it.asByte }.toByteArray()
</a><a href="#h84-0-313" id="h84-0-313" class="d">-                                val mediaType = MediaReferenceType.valueOf(media.asJsonObject[&quot;mMediaType&quot;].asString)
</a><a href="#h84-0-314" id="h84-0-314" class="d">-                                add(JsonObject().apply {
</a><a href="#h84-0-315" id="h84-0-315" class="d">-                                    addProperty(&quot;mediaType&quot;, mediaType.toString())
</a><a href="#h84-0-316" id="h84-0-316" class="d">-                                    addProperty(&quot;content&quot;, Base64.getUrlEncoder().encodeToString(protoMediaReference))
</a><a href="#h84-0-317" id="h84-0-317" class="d">-                                })
</a><a href="#h84-0-318" id="h84-0-318" class="d">-                            }
</a><a href="#h84-0-319" id="h84-0-319" class="d">-                        })
</a><a href="#h84-0-320" id="h84-0-320" class="d">-
</a><a href="#h84-0-321" id="h84-0-321" class="d">-                    })
</a><a href="#h84-0-322" id="h84-0-322" class="d">-                }
</a><a href="#h84-0-323" id="h84-0-323" class="d">-            })
</a><a href="#h84-0-324" id="h84-0-324" class="d">-        }
</a><a href="#h84-0-325" id="h84-0-325" class="d">-
</a><a href="#h84-0-326" id="h84-0-326" class="d">-        output.write(context.gson.toJson(rootObject).toByteArray())
</a><a href="#h84-0-327" id="h84-0-327" class="d">-        output.flush()
</a><a href="#h84-0-328" id="h84-0-328" class="d">-    }
</a><a href="#h84-0-329" id="h84-0-329" class="d">-
</a><a href="#h84-0-330" id="h84-0-330" class="d">-    suspend fun exportTo(exportFormat: ExportFormat) {
</a><a href="#h84-0-331" id="h84-0-331" class="d">-        val output = FileOutputStream(outputFile)
</a><a href="#h84-0-332" id="h84-0-332" class="d">-
</a><a href="#h84-0-333" id="h84-0-333" class="d">-        when (exportFormat) {
</a><a href="#h84-0-334" id="h84-0-334" class="d">-            ExportFormat.HTML -&gt; exportHtml(output)
</a><a href="#h84-0-335" id="h84-0-335" class="d">-            ExportFormat.JSON -&gt; exportJson(output)
</a><a href="#h84-0-336" id="h84-0-336" class="d">-            ExportFormat.TEXT -&gt; exportText(output)
</a><a href="#h84-0-337" id="h84-0-337" class="d">-        }
</a><a href="#h84-0-338" id="h84-0-338" class="d">-
</a><a href="#h84-0-339" id="h84-0-339" class="d">-        output.close()
</a><a href="#h84-0-340" id="h84-0-340" class="d">-    }
</a><a href="#h84-0-341" id="h84-0-341" class="d">-}</a><a href="#h84-0-342" id="h84-0-342" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h85" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/util/ktx/AndroidCompatExtensions.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/util/ktx/AndroidCompatExtensions.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/util/ktx/AndroidCompatExtensions.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/util/ktx/AndroidCompatExtensions.kt</a></b>
<a href="#h85-0" id="h85-0" class="h">@@ -1,13 +0,0 @@
</a><a href="#h85-0-0" id="h85-0-0" class="d">-package me.rhunk.snapenhance.util.ktx
</a><a href="#h85-0-1" id="h85-0-1" class="d">-
</a><a href="#h85-0-2" id="h85-0-2" class="d">-import android.content.pm.PackageManager
</a><a href="#h85-0-3" id="h85-0-3" class="d">-import android.content.pm.PackageManager.ApplicationInfoFlags
</a><a href="#h85-0-4" id="h85-0-4" class="d">-import android.os.Build
</a><a href="#h85-0-5" id="h85-0-5" class="d">-
</a><a href="#h85-0-6" id="h85-0-6" class="d">-fun PackageManager.getApplicationInfoCompat(packageName: String, flags: Int) =
</a><a href="#h85-0-7" id="h85-0-7" class="d">-    if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.TIRAMISU) {
</a><a href="#h85-0-8" id="h85-0-8" class="d">-        getApplicationInfo(packageName, ApplicationInfoFlags.of(flags.toLong()))
</a><a href="#h85-0-9" id="h85-0-9" class="d">-    } else {
</a><a href="#h85-0-10" id="h85-0-10" class="d">-        @Suppress(&quot;DEPRECATION&quot;)
</a><a href="#h85-0-11" id="h85-0-11" class="d">-        getApplicationInfo(packageName, flags)
</a><a href="#h85-0-12" id="h85-0-12" class="d">-    }
</a><b>diff --git a/<a id="h86" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/util/ktx/DbCursorExt.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/util/ktx/DbCursorExt.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/util/ktx/DbCursorExt.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/util/ktx/DbCursorExt.kt</a></b>
<a href="#h86-0" id="h86-0" class="h">@@ -1,37 +0,0 @@
</a><a href="#h86-0-0" id="h86-0-0" class="d">-package me.rhunk.snapenhance.util.ktx
</a><a href="#h86-0-1" id="h86-0-1" class="d">-
</a><a href="#h86-0-2" id="h86-0-2" class="d">-import android.database.Cursor
</a><a href="#h86-0-3" id="h86-0-3" class="d">-
</a><a href="#h86-0-4" id="h86-0-4" class="d">-fun Cursor.getStringOrNull(columnName: String): String? {
</a><a href="#h86-0-5" id="h86-0-5" class="d">-    val columnIndex = getColumnIndex(columnName)
</a><a href="#h86-0-6" id="h86-0-6" class="d">-    return if (columnIndex == -1) null else getString(columnIndex)
</a><a href="#h86-0-7" id="h86-0-7" class="d">-}
</a><a href="#h86-0-8" id="h86-0-8" class="d">-
</a><a href="#h86-0-9" id="h86-0-9" class="d">-fun Cursor.getIntOrNull(columnName: String): Int? {
</a><a href="#h86-0-10" id="h86-0-10" class="d">-    val columnIndex = getColumnIndex(columnName)
</a><a href="#h86-0-11" id="h86-0-11" class="d">-    return if (columnIndex == -1) null else getInt(columnIndex)
</a><a href="#h86-0-12" id="h86-0-12" class="d">-}
</a><a href="#h86-0-13" id="h86-0-13" class="d">-
</a><a href="#h86-0-14" id="h86-0-14" class="d">-fun Cursor.getInteger(columnName: String) = getIntOrNull(columnName) ?: throw NullPointerException(&quot;Column $columnName is null&quot;)
</a><a href="#h86-0-15" id="h86-0-15" class="d">-fun Cursor.getLong(columnName: String) = getLongOrNull(columnName) ?: throw NullPointerException(&quot;Column $columnName is null&quot;)
</a><a href="#h86-0-16" id="h86-0-16" class="d">-
</a><a href="#h86-0-17" id="h86-0-17" class="d">-fun Cursor.getBlobOrNull(columnName: String): ByteArray? {
</a><a href="#h86-0-18" id="h86-0-18" class="d">-    val columnIndex = getColumnIndex(columnName)
</a><a href="#h86-0-19" id="h86-0-19" class="d">-    return if (columnIndex == -1) null else getBlob(columnIndex)
</a><a href="#h86-0-20" id="h86-0-20" class="d">-}
</a><a href="#h86-0-21" id="h86-0-21" class="d">-
</a><a href="#h86-0-22" id="h86-0-22" class="d">-
</a><a href="#h86-0-23" id="h86-0-23" class="d">-fun Cursor.getLongOrNull(columnName: String): Long? {
</a><a href="#h86-0-24" id="h86-0-24" class="d">-    val columnIndex = getColumnIndex(columnName)
</a><a href="#h86-0-25" id="h86-0-25" class="d">-    return if (columnIndex == -1) null else getLong(columnIndex)
</a><a href="#h86-0-26" id="h86-0-26" class="d">-}
</a><a href="#h86-0-27" id="h86-0-27" class="d">-
</a><a href="#h86-0-28" id="h86-0-28" class="d">-fun Cursor.getDoubleOrNull(columnName: String): Double? {
</a><a href="#h86-0-29" id="h86-0-29" class="d">-    val columnIndex = getColumnIndex(columnName)
</a><a href="#h86-0-30" id="h86-0-30" class="d">-    return if (columnIndex == -1) null else getDouble(columnIndex)
</a><a href="#h86-0-31" id="h86-0-31" class="d">-}
</a><a href="#h86-0-32" id="h86-0-32" class="d">-
</a><a href="#h86-0-33" id="h86-0-33" class="d">-fun Cursor.getFloatOrNull(columnName: String): Float? {
</a><a href="#h86-0-34" id="h86-0-34" class="d">-    val columnIndex = getColumnIndex(columnName)
</a><a href="#h86-0-35" id="h86-0-35" class="d">-    return if (columnIndex == -1) null else getFloat(columnIndex)
</a><a href="#h86-0-36" id="h86-0-36" class="d">-}</a><a href="#h86-0-37" id="h86-0-37" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h87" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/util/ktx/XposedHelperExt.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/util/ktx/XposedHelperExt.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/util/ktx/XposedHelperExt.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/util/ktx/XposedHelperExt.kt</a></b>
<a href="#h87-0" id="h87-0" class="h">@@ -1,27 +0,0 @@
</a><a href="#h87-0-0" id="h87-0-0" class="d">-package me.rhunk.snapenhance.util.ktx
</a><a href="#h87-0-1" id="h87-0-1" class="d">-
</a><a href="#h87-0-2" id="h87-0-2" class="d">-import de.robv.android.xposed.XposedHelpers
</a><a href="#h87-0-3" id="h87-0-3" class="d">-
</a><a href="#h87-0-4" id="h87-0-4" class="d">-fun Any.getObjectField(fieldName: String): Any? {
</a><a href="#h87-0-5" id="h87-0-5" class="d">-    return XposedHelpers.getObjectField(this, fieldName)
</a><a href="#h87-0-6" id="h87-0-6" class="d">-}
</a><a href="#h87-0-7" id="h87-0-7" class="d">-
</a><a href="#h87-0-8" id="h87-0-8" class="d">-fun Any.setEnumField(fieldName: String, value: String) {
</a><a href="#h87-0-9" id="h87-0-9" class="d">-    this::class.java.getDeclaredField(fieldName)
</a><a href="#h87-0-10" id="h87-0-10" class="d">-        .type.enumConstants?.firstOrNull { it.toString() == value }?.let { enum -&gt;
</a><a href="#h87-0-11" id="h87-0-11" class="d">-        setObjectField(fieldName, enum)
</a><a href="#h87-0-12" id="h87-0-12" class="d">-    }
</a><a href="#h87-0-13" id="h87-0-13" class="d">-}
</a><a href="#h87-0-14" id="h87-0-14" class="d">-
</a><a href="#h87-0-15" id="h87-0-15" class="d">-fun Any.setObjectField(fieldName: String, value: Any?) {
</a><a href="#h87-0-16" id="h87-0-16" class="d">-    XposedHelpers.setObjectField(this, fieldName, value)
</a><a href="#h87-0-17" id="h87-0-17" class="d">-}
</a><a href="#h87-0-18" id="h87-0-18" class="d">-
</a><a href="#h87-0-19" id="h87-0-19" class="d">-fun Any.getObjectFieldOrNull(fieldName: String): Any? {
</a><a href="#h87-0-20" id="h87-0-20" class="d">-    return try {
</a><a href="#h87-0-21" id="h87-0-21" class="d">-        getObjectField(fieldName)
</a><a href="#h87-0-22" id="h87-0-22" class="d">-    } catch (e: Exception) {
</a><a href="#h87-0-23" id="h87-0-23" class="d">-        null
</a><a href="#h87-0-24" id="h87-0-24" class="d">-    }
</a><a href="#h87-0-25" id="h87-0-25" class="d">-}
</a><a href="#h87-0-26" id="h87-0-26" class="d">-
</a><b>diff --git a/<a id="h88" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/util/protobuf/ProtoEditor.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/util/protobuf/ProtoEditor.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/util/protobuf/ProtoEditor.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/util/protobuf/ProtoEditor.kt</a></b>
<a href="#h88-0" id="h88-0" class="h">@@ -1,67 +0,0 @@
</a><a href="#h88-0-0" id="h88-0-0" class="d">-package me.rhunk.snapenhance.util.protobuf
</a><a href="#h88-0-1" id="h88-0-1" class="d">-
</a><a href="#h88-0-2" id="h88-0-2" class="d">-
</a><a href="#h88-0-3" id="h88-0-3" class="d">-typealias WireCallback = EditorContext.() -&gt; Unit
</a><a href="#h88-0-4" id="h88-0-4" class="d">-
</a><a href="#h88-0-5" id="h88-0-5" class="d">-class EditorContext(
</a><a href="#h88-0-6" id="h88-0-6" class="d">-    private val wires: MutableMap&lt;Int, MutableList&lt;Wire&gt;&gt;
</a><a href="#h88-0-7" id="h88-0-7" class="d">-) {
</a><a href="#h88-0-8" id="h88-0-8" class="d">-    fun clear() {
</a><a href="#h88-0-9" id="h88-0-9" class="d">-        wires.clear()
</a><a href="#h88-0-10" id="h88-0-10" class="d">-    }
</a><a href="#h88-0-11" id="h88-0-11" class="d">-    fun addWire(wire: Wire) {
</a><a href="#h88-0-12" id="h88-0-12" class="d">-        wires.getOrPut(wire.id) { mutableListOf() }.add(wire)
</a><a href="#h88-0-13" id="h88-0-13" class="d">-    }
</a><a href="#h88-0-14" id="h88-0-14" class="d">-    fun addVarInt(id: Int, value: Int) = addVarInt(id, value.toLong())
</a><a href="#h88-0-15" id="h88-0-15" class="d">-    fun addVarInt(id: Int, value: Long) = addWire(Wire(id, WireType.VARINT, value))
</a><a href="#h88-0-16" id="h88-0-16" class="d">-    fun addBuffer(id: Int, value: ByteArray) = addWire(Wire(id, WireType.LENGTH_DELIMITED, value))
</a><a href="#h88-0-17" id="h88-0-17" class="d">-    fun add(id: Int, content: ProtoWriter.() -&gt; Unit) = addBuffer(id, ProtoWriter().apply(content).toByteArray())
</a><a href="#h88-0-18" id="h88-0-18" class="d">-    fun addString(id: Int, value: String) = addBuffer(id, value.toByteArray())
</a><a href="#h88-0-19" id="h88-0-19" class="d">-    fun addFixed64(id: Int, value: Long) = addWire(Wire(id, WireType.FIXED64, value))
</a><a href="#h88-0-20" id="h88-0-20" class="d">-    fun addFixed32(id: Int, value: Int) = addWire(Wire(id, WireType.FIXED32, value))
</a><a href="#h88-0-21" id="h88-0-21" class="d">-
</a><a href="#h88-0-22" id="h88-0-22" class="d">-    fun firstOrNull(id: Int) = wires[id]?.firstOrNull()
</a><a href="#h88-0-23" id="h88-0-23" class="d">-    fun getOrNull(id: Int) = wires[id]
</a><a href="#h88-0-24" id="h88-0-24" class="d">-    fun get(id: Int) = wires[id]!!
</a><a href="#h88-0-25" id="h88-0-25" class="d">-
</a><a href="#h88-0-26" id="h88-0-26" class="d">-    fun remove(id: Int) = wires.remove(id)
</a><a href="#h88-0-27" id="h88-0-27" class="d">-    fun remove(id: Int, index: Int) = wires[id]?.removeAt(index)
</a><a href="#h88-0-28" id="h88-0-28" class="d">-}
</a><a href="#h88-0-29" id="h88-0-29" class="d">-
</a><a href="#h88-0-30" id="h88-0-30" class="d">-class ProtoEditor(
</a><a href="#h88-0-31" id="h88-0-31" class="d">-    private var buffer: ByteArray
</a><a href="#h88-0-32" id="h88-0-32" class="d">-) {
</a><a href="#h88-0-33" id="h88-0-33" class="d">-    fun edit(vararg path: Int, callback: WireCallback) {
</a><a href="#h88-0-34" id="h88-0-34" class="d">-        buffer = writeAtPath(path, 0, ProtoReader(buffer), callback)
</a><a href="#h88-0-35" id="h88-0-35" class="d">-    }
</a><a href="#h88-0-36" id="h88-0-36" class="d">-
</a><a href="#h88-0-37" id="h88-0-37" class="d">-    private fun writeAtPath(path: IntArray, currentIndex: Int, rootReader: ProtoReader, wireToWriteCallback: WireCallback): ByteArray {
</a><a href="#h88-0-38" id="h88-0-38" class="d">-        val id = path.getOrNull(currentIndex)
</a><a href="#h88-0-39" id="h88-0-39" class="d">-        val output = ProtoWriter()
</a><a href="#h88-0-40" id="h88-0-40" class="d">-        val wires = mutableMapOf&lt;Int, MutableList&lt;Wire&gt;&gt;()
</a><a href="#h88-0-41" id="h88-0-41" class="d">-
</a><a href="#h88-0-42" id="h88-0-42" class="d">-        rootReader.forEach { wireId, value -&gt;
</a><a href="#h88-0-43" id="h88-0-43" class="d">-            wires.putIfAbsent(wireId, mutableListOf())
</a><a href="#h88-0-44" id="h88-0-44" class="d">-            if (id != null &amp;&amp; wireId == id) {
</a><a href="#h88-0-45" id="h88-0-45" class="d">-                val childReader = rootReader.followPath(id)
</a><a href="#h88-0-46" id="h88-0-46" class="d">-                if (childReader == null) {
</a><a href="#h88-0-47" id="h88-0-47" class="d">-                    wires.getOrPut(wireId) { mutableListOf() }.add(value)
</a><a href="#h88-0-48" id="h88-0-48" class="d">-                    return@forEach
</a><a href="#h88-0-49" id="h88-0-49" class="d">-                }
</a><a href="#h88-0-50" id="h88-0-50" class="d">-                wires[wireId]!!.add(Wire(wireId, WireType.LENGTH_DELIMITED, writeAtPath(path, currentIndex + 1, childReader, wireToWriteCallback)))
</a><a href="#h88-0-51" id="h88-0-51" class="d">-                return@forEach
</a><a href="#h88-0-52" id="h88-0-52" class="d">-            }
</a><a href="#h88-0-53" id="h88-0-53" class="d">-            wires[wireId]!!.add(value)
</a><a href="#h88-0-54" id="h88-0-54" class="d">-        }
</a><a href="#h88-0-55" id="h88-0-55" class="d">-
</a><a href="#h88-0-56" id="h88-0-56" class="d">-        if (currentIndex == path.size) {
</a><a href="#h88-0-57" id="h88-0-57" class="d">-            wireToWriteCallback(EditorContext(wires))
</a><a href="#h88-0-58" id="h88-0-58" class="d">-        }
</a><a href="#h88-0-59" id="h88-0-59" class="d">-
</a><a href="#h88-0-60" id="h88-0-60" class="d">-        wires.values.flatten().forEach(output::addWire)
</a><a href="#h88-0-61" id="h88-0-61" class="d">-
</a><a href="#h88-0-62" id="h88-0-62" class="d">-        return output.toByteArray()
</a><a href="#h88-0-63" id="h88-0-63" class="d">-    }
</a><a href="#h88-0-64" id="h88-0-64" class="d">-
</a><a href="#h88-0-65" id="h88-0-65" class="d">-    fun toByteArray() = buffer
</a><a href="#h88-0-66" id="h88-0-66" class="d">-}</a><a href="#h88-0-67" id="h88-0-67" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h89" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/util/protobuf/ProtoReader.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/util/protobuf/ProtoReader.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/util/protobuf/ProtoReader.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/util/protobuf/ProtoReader.kt</a></b>
<a href="#h89-0" id="h89-0" class="h">@@ -1,175 +0,0 @@
</a><a href="#h89-0-0" id="h89-0-0" class="d">-package me.rhunk.snapenhance.util.protobuf
</a><a href="#h89-0-1" id="h89-0-1" class="d">-
</a><a href="#h89-0-2" id="h89-0-2" class="d">-data class Wire(val id: Int, val type: WireType, val value: Any)
</a><a href="#h89-0-3" id="h89-0-3" class="d">-
</a><a href="#h89-0-4" id="h89-0-4" class="d">-class ProtoReader(private val buffer: ByteArray) {
</a><a href="#h89-0-5" id="h89-0-5" class="d">-    private var offset: Int = 0
</a><a href="#h89-0-6" id="h89-0-6" class="d">-    private val values = mutableMapOf&lt;Int, MutableList&lt;Wire&gt;&gt;()
</a><a href="#h89-0-7" id="h89-0-7" class="d">-
</a><a href="#h89-0-8" id="h89-0-8" class="d">-    init {
</a><a href="#h89-0-9" id="h89-0-9" class="d">-        read()
</a><a href="#h89-0-10" id="h89-0-10" class="d">-    }
</a><a href="#h89-0-11" id="h89-0-11" class="d">-
</a><a href="#h89-0-12" id="h89-0-12" class="d">-    fun getBuffer() = buffer
</a><a href="#h89-0-13" id="h89-0-13" class="d">-
</a><a href="#h89-0-14" id="h89-0-14" class="d">-    private fun readByte() = buffer[offset++]
</a><a href="#h89-0-15" id="h89-0-15" class="d">-
</a><a href="#h89-0-16" id="h89-0-16" class="d">-    private fun readVarInt(): Long {
</a><a href="#h89-0-17" id="h89-0-17" class="d">-        var result = 0L
</a><a href="#h89-0-18" id="h89-0-18" class="d">-        var shift = 0
</a><a href="#h89-0-19" id="h89-0-19" class="d">-        while (true) {
</a><a href="#h89-0-20" id="h89-0-20" class="d">-            val b = readByte()
</a><a href="#h89-0-21" id="h89-0-21" class="d">-            result = result or ((b.toLong() and 0x7F) shl shift)
</a><a href="#h89-0-22" id="h89-0-22" class="d">-            if (b.toInt() and 0x80 == 0) {
</a><a href="#h89-0-23" id="h89-0-23" class="d">-                break
</a><a href="#h89-0-24" id="h89-0-24" class="d">-            }
</a><a href="#h89-0-25" id="h89-0-25" class="d">-            shift += 7
</a><a href="#h89-0-26" id="h89-0-26" class="d">-        }
</a><a href="#h89-0-27" id="h89-0-27" class="d">-        return result
</a><a href="#h89-0-28" id="h89-0-28" class="d">-    }
</a><a href="#h89-0-29" id="h89-0-29" class="d">-
</a><a href="#h89-0-30" id="h89-0-30" class="d">-    private fun read() {
</a><a href="#h89-0-31" id="h89-0-31" class="d">-        while (offset &lt; buffer.size) {
</a><a href="#h89-0-32" id="h89-0-32" class="d">-            val tag = readVarInt().toInt()
</a><a href="#h89-0-33" id="h89-0-33" class="d">-            val id = tag ushr 3
</a><a href="#h89-0-34" id="h89-0-34" class="d">-            val type = WireType.fromValue(tag and 0x7) ?: break
</a><a href="#h89-0-35" id="h89-0-35" class="d">-            try {
</a><a href="#h89-0-36" id="h89-0-36" class="d">-                val value = when (type) {
</a><a href="#h89-0-37" id="h89-0-37" class="d">-                    WireType.VARINT -&gt; readVarInt()
</a><a href="#h89-0-38" id="h89-0-38" class="d">-                    WireType.FIXED64 -&gt; {
</a><a href="#h89-0-39" id="h89-0-39" class="d">-                        val bytes = ByteArray(8)
</a><a href="#h89-0-40" id="h89-0-40" class="d">-                        for (i in 0..7) {
</a><a href="#h89-0-41" id="h89-0-41" class="d">-                            bytes[i] = readByte()
</a><a href="#h89-0-42" id="h89-0-42" class="d">-                        }
</a><a href="#h89-0-43" id="h89-0-43" class="d">-                        bytes
</a><a href="#h89-0-44" id="h89-0-44" class="d">-                    }
</a><a href="#h89-0-45" id="h89-0-45" class="d">-                    WireType.LENGTH_DELIMITED -&gt; {
</a><a href="#h89-0-46" id="h89-0-46" class="d">-                        val length = readVarInt().toInt()
</a><a href="#h89-0-47" id="h89-0-47" class="d">-                        val bytes = ByteArray(length)
</a><a href="#h89-0-48" id="h89-0-48" class="d">-                        for (i in 0 until length) {
</a><a href="#h89-0-49" id="h89-0-49" class="d">-                            bytes[i] = readByte()
</a><a href="#h89-0-50" id="h89-0-50" class="d">-                        }
</a><a href="#h89-0-51" id="h89-0-51" class="d">-                        bytes
</a><a href="#h89-0-52" id="h89-0-52" class="d">-                    }
</a><a href="#h89-0-53" id="h89-0-53" class="d">-                    WireType.START_GROUP -&gt; {
</a><a href="#h89-0-54" id="h89-0-54" class="d">-                        val bytes = mutableListOf&lt;Byte&gt;()
</a><a href="#h89-0-55" id="h89-0-55" class="d">-                        while (true) {
</a><a href="#h89-0-56" id="h89-0-56" class="d">-                            val b = readByte()
</a><a href="#h89-0-57" id="h89-0-57" class="d">-                            if (b.toInt() == WireType.END_GROUP.value) {
</a><a href="#h89-0-58" id="h89-0-58" class="d">-                                break
</a><a href="#h89-0-59" id="h89-0-59" class="d">-                            }
</a><a href="#h89-0-60" id="h89-0-60" class="d">-                            bytes.add(b)
</a><a href="#h89-0-61" id="h89-0-61" class="d">-                        }
</a><a href="#h89-0-62" id="h89-0-62" class="d">-                        bytes.toByteArray()
</a><a href="#h89-0-63" id="h89-0-63" class="d">-                    }
</a><a href="#h89-0-64" id="h89-0-64" class="d">-                    WireType.FIXED32 -&gt; {
</a><a href="#h89-0-65" id="h89-0-65" class="d">-                        val bytes = ByteArray(4)
</a><a href="#h89-0-66" id="h89-0-66" class="d">-                        for (i in 0..3) {
</a><a href="#h89-0-67" id="h89-0-67" class="d">-                            bytes[i] = readByte()
</a><a href="#h89-0-68" id="h89-0-68" class="d">-                        }
</a><a href="#h89-0-69" id="h89-0-69" class="d">-                        bytes
</a><a href="#h89-0-70" id="h89-0-70" class="d">-                    }
</a><a href="#h89-0-71" id="h89-0-71" class="d">-                    WireType.END_GROUP -&gt; continue
</a><a href="#h89-0-72" id="h89-0-72" class="d">-                }
</a><a href="#h89-0-73" id="h89-0-73" class="d">-                values.getOrPut(id) { mutableListOf() }.add(Wire(id, type, value))
</a><a href="#h89-0-74" id="h89-0-74" class="d">-            } catch (t: Throwable) {
</a><a href="#h89-0-75" id="h89-0-75" class="d">-                values.clear()
</a><a href="#h89-0-76" id="h89-0-76" class="d">-                break
</a><a href="#h89-0-77" id="h89-0-77" class="d">-            }
</a><a href="#h89-0-78" id="h89-0-78" class="d">-        }
</a><a href="#h89-0-79" id="h89-0-79" class="d">-    }
</a><a href="#h89-0-80" id="h89-0-80" class="d">-
</a><a href="#h89-0-81" id="h89-0-81" class="d">-    fun followPath(vararg ids: Int, excludeLast: Boolean = false, reader: (ProtoReader.() -&gt; Unit)? = null): ProtoReader? {
</a><a href="#h89-0-82" id="h89-0-82" class="d">-        var thisReader = this
</a><a href="#h89-0-83" id="h89-0-83" class="d">-        ids.let {
</a><a href="#h89-0-84" id="h89-0-84" class="d">-            if (excludeLast) {
</a><a href="#h89-0-85" id="h89-0-85" class="d">-                it.sliceArray(0 until it.size - 1)
</a><a href="#h89-0-86" id="h89-0-86" class="d">-            } else {
</a><a href="#h89-0-87" id="h89-0-87" class="d">-                it
</a><a href="#h89-0-88" id="h89-0-88" class="d">-            }
</a><a href="#h89-0-89" id="h89-0-89" class="d">-        }.forEach { id -&gt;
</a><a href="#h89-0-90" id="h89-0-90" class="d">-            if (!thisReader.contains(id)) {
</a><a href="#h89-0-91" id="h89-0-91" class="d">-                return null
</a><a href="#h89-0-92" id="h89-0-92" class="d">-            }
</a><a href="#h89-0-93" id="h89-0-93" class="d">-            thisReader = ProtoReader(thisReader.getByteArray(id) ?: return null)
</a><a href="#h89-0-94" id="h89-0-94" class="d">-        }
</a><a href="#h89-0-95" id="h89-0-95" class="d">-        if (reader != null) {
</a><a href="#h89-0-96" id="h89-0-96" class="d">-            thisReader.reader()
</a><a href="#h89-0-97" id="h89-0-97" class="d">-        }
</a><a href="#h89-0-98" id="h89-0-98" class="d">-        return thisReader
</a><a href="#h89-0-99" id="h89-0-99" class="d">-    }
</a><a href="#h89-0-100" id="h89-0-100" class="d">-
</a><a href="#h89-0-101" id="h89-0-101" class="d">-    fun containsPath(vararg ids: Int): Boolean {
</a><a href="#h89-0-102" id="h89-0-102" class="d">-        var thisReader = this
</a><a href="#h89-0-103" id="h89-0-103" class="d">-        ids.forEach { id -&gt;
</a><a href="#h89-0-104" id="h89-0-104" class="d">-            if (!thisReader.contains(id)) {
</a><a href="#h89-0-105" id="h89-0-105" class="d">-                return false
</a><a href="#h89-0-106" id="h89-0-106" class="d">-            }
</a><a href="#h89-0-107" id="h89-0-107" class="d">-            thisReader = ProtoReader(thisReader.getByteArray(id) ?: return false)
</a><a href="#h89-0-108" id="h89-0-108" class="d">-        }
</a><a href="#h89-0-109" id="h89-0-109" class="d">-        return true
</a><a href="#h89-0-110" id="h89-0-110" class="d">-    }
</a><a href="#h89-0-111" id="h89-0-111" class="d">-
</a><a href="#h89-0-112" id="h89-0-112" class="d">-    fun forEach(reader: (Int, Wire) -&gt; Unit) {
</a><a href="#h89-0-113" id="h89-0-113" class="d">-        values.forEach { (id, wires) -&gt;
</a><a href="#h89-0-114" id="h89-0-114" class="d">-            wires.forEach { wire -&gt;
</a><a href="#h89-0-115" id="h89-0-115" class="d">-                reader(id, wire)
</a><a href="#h89-0-116" id="h89-0-116" class="d">-            }
</a><a href="#h89-0-117" id="h89-0-117" class="d">-        }
</a><a href="#h89-0-118" id="h89-0-118" class="d">-    }
</a><a href="#h89-0-119" id="h89-0-119" class="d">-
</a><a href="#h89-0-120" id="h89-0-120" class="d">-    fun forEach(vararg id: Int, reader: ProtoReader.() -&gt; Unit) {
</a><a href="#h89-0-121" id="h89-0-121" class="d">-        followPath(*id)?.eachBuffer { _, buffer -&gt;
</a><a href="#h89-0-122" id="h89-0-122" class="d">-            ProtoReader(buffer).reader()
</a><a href="#h89-0-123" id="h89-0-123" class="d">-        }
</a><a href="#h89-0-124" id="h89-0-124" class="d">-    }
</a><a href="#h89-0-125" id="h89-0-125" class="d">-
</a><a href="#h89-0-126" id="h89-0-126" class="d">-    fun eachBuffer(vararg ids: Int, reader: ProtoReader.() -&gt; Unit) {
</a><a href="#h89-0-127" id="h89-0-127" class="d">-        followPath(*ids, excludeLast = true)?.eachBuffer { id, buffer -&gt;
</a><a href="#h89-0-128" id="h89-0-128" class="d">-            if (id == ids.last()) {
</a><a href="#h89-0-129" id="h89-0-129" class="d">-                ProtoReader(buffer).reader()
</a><a href="#h89-0-130" id="h89-0-130" class="d">-            }
</a><a href="#h89-0-131" id="h89-0-131" class="d">-        }
</a><a href="#h89-0-132" id="h89-0-132" class="d">-    }
</a><a href="#h89-0-133" id="h89-0-133" class="d">-
</a><a href="#h89-0-134" id="h89-0-134" class="d">-    fun eachBuffer(reader: (Int, ByteArray) -&gt; Unit) {
</a><a href="#h89-0-135" id="h89-0-135" class="d">-        values.forEach { (id, wires) -&gt;
</a><a href="#h89-0-136" id="h89-0-136" class="d">-            wires.forEach { wire -&gt;
</a><a href="#h89-0-137" id="h89-0-137" class="d">-                if (wire.type == WireType.LENGTH_DELIMITED) {
</a><a href="#h89-0-138" id="h89-0-138" class="d">-                    reader(id, wire.value as ByteArray)
</a><a href="#h89-0-139" id="h89-0-139" class="d">-                }
</a><a href="#h89-0-140" id="h89-0-140" class="d">-            }
</a><a href="#h89-0-141" id="h89-0-141" class="d">-        }
</a><a href="#h89-0-142" id="h89-0-142" class="d">-    }
</a><a href="#h89-0-143" id="h89-0-143" class="d">-
</a><a href="#h89-0-144" id="h89-0-144" class="d">-    fun contains(id: Int) = values.containsKey(id)
</a><a href="#h89-0-145" id="h89-0-145" class="d">-
</a><a href="#h89-0-146" id="h89-0-146" class="d">-    fun getWire(id: Int) = values[id]?.firstOrNull()
</a><a href="#h89-0-147" id="h89-0-147" class="d">-    fun getRawValue(id: Int) = getWire(id)?.value
</a><a href="#h89-0-148" id="h89-0-148" class="d">-    fun getByteArray(id: Int) = getRawValue(id) as? ByteArray
</a><a href="#h89-0-149" id="h89-0-149" class="d">-    fun getByteArray(vararg ids: Int) = followPath(*ids, excludeLast = true)?.getByteArray(ids.last())
</a><a href="#h89-0-150" id="h89-0-150" class="d">-    fun getString(id: Int) = getByteArray(id)?.toString(Charsets.UTF_8)
</a><a href="#h89-0-151" id="h89-0-151" class="d">-    fun getString(vararg ids: Int) = followPath(*ids, excludeLast = true)?.getString(ids.last())
</a><a href="#h89-0-152" id="h89-0-152" class="d">-    fun getVarInt(id: Int) = getRawValue(id) as? Long
</a><a href="#h89-0-153" id="h89-0-153" class="d">-    fun getVarInt(vararg ids: Int) = followPath(*ids, excludeLast = true)?.getVarInt(ids.last())
</a><a href="#h89-0-154" id="h89-0-154" class="d">-    fun getCount(id: Int) = values[id]?.size ?: 0
</a><a href="#h89-0-155" id="h89-0-155" class="d">-
</a><a href="#h89-0-156" id="h89-0-156" class="d">-    fun getFixed64(id: Int): Long {
</a><a href="#h89-0-157" id="h89-0-157" class="d">-        val bytes = getByteArray(id) ?: return 0L
</a><a href="#h89-0-158" id="h89-0-158" class="d">-        var value = 0L
</a><a href="#h89-0-159" id="h89-0-159" class="d">-        for (i in 0..7) {
</a><a href="#h89-0-160" id="h89-0-160" class="d">-            value = value or ((bytes[i].toLong() and 0xFF) shl (i * 8))
</a><a href="#h89-0-161" id="h89-0-161" class="d">-        }
</a><a href="#h89-0-162" id="h89-0-162" class="d">-        return value
</a><a href="#h89-0-163" id="h89-0-163" class="d">-    }
</a><a href="#h89-0-164" id="h89-0-164" class="d">-
</a><a href="#h89-0-165" id="h89-0-165" class="d">-
</a><a href="#h89-0-166" id="h89-0-166" class="d">-    fun getFixed32(id: Int): Int {
</a><a href="#h89-0-167" id="h89-0-167" class="d">-        val bytes = getByteArray(id) ?: return 0
</a><a href="#h89-0-168" id="h89-0-168" class="d">-        var value = 0
</a><a href="#h89-0-169" id="h89-0-169" class="d">-        for (i in 0..3) {
</a><a href="#h89-0-170" id="h89-0-170" class="d">-            value = value or ((bytes[i].toInt() and 0xFF) shl (i * 8))
</a><a href="#h89-0-171" id="h89-0-171" class="d">-        }
</a><a href="#h89-0-172" id="h89-0-172" class="d">-        return value
</a><a href="#h89-0-173" id="h89-0-173" class="d">-    }
</a><a href="#h89-0-174" id="h89-0-174" class="d">-}</a><a href="#h89-0-175" id="h89-0-175" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h90" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/util/protobuf/ProtoWriter.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/util/protobuf/ProtoWriter.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/util/protobuf/ProtoWriter.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/util/protobuf/ProtoWriter.kt</a></b>
<a href="#h90-0" id="h90-0" class="h">@@ -1,117 +0,0 @@
</a><a href="#h90-0-0" id="h90-0-0" class="d">-package me.rhunk.snapenhance.util.protobuf
</a><a href="#h90-0-1" id="h90-0-1" class="d">-
</a><a href="#h90-0-2" id="h90-0-2" class="d">-import java.io.ByteArrayOutputStream
</a><a href="#h90-0-3" id="h90-0-3" class="d">-
</a><a href="#h90-0-4" id="h90-0-4" class="d">-class ProtoWriter {
</a><a href="#h90-0-5" id="h90-0-5" class="d">-    private val stream: ByteArrayOutputStream = ByteArrayOutputStream()
</a><a href="#h90-0-6" id="h90-0-6" class="d">-
</a><a href="#h90-0-7" id="h90-0-7" class="d">-    private fun writeVarInt(value: Int) {
</a><a href="#h90-0-8" id="h90-0-8" class="d">-        var v = value
</a><a href="#h90-0-9" id="h90-0-9" class="d">-        while (v and -0x80 != 0) {
</a><a href="#h90-0-10" id="h90-0-10" class="d">-            stream.write(v and 0x7F or 0x80)
</a><a href="#h90-0-11" id="h90-0-11" class="d">-            v = v ushr 7
</a><a href="#h90-0-12" id="h90-0-12" class="d">-        }
</a><a href="#h90-0-13" id="h90-0-13" class="d">-        stream.write(v)
</a><a href="#h90-0-14" id="h90-0-14" class="d">-    }
</a><a href="#h90-0-15" id="h90-0-15" class="d">-
</a><a href="#h90-0-16" id="h90-0-16" class="d">-    private fun writeVarLong(value: Long) {
</a><a href="#h90-0-17" id="h90-0-17" class="d">-        var v = value
</a><a href="#h90-0-18" id="h90-0-18" class="d">-        while (v and -0x80L != 0L) {
</a><a href="#h90-0-19" id="h90-0-19" class="d">-            stream.write((v and 0x7FL or 0x80L).toInt())
</a><a href="#h90-0-20" id="h90-0-20" class="d">-            v = v ushr 7
</a><a href="#h90-0-21" id="h90-0-21" class="d">-        }
</a><a href="#h90-0-22" id="h90-0-22" class="d">-        stream.write(v.toInt())
</a><a href="#h90-0-23" id="h90-0-23" class="d">-    }
</a><a href="#h90-0-24" id="h90-0-24" class="d">-
</a><a href="#h90-0-25" id="h90-0-25" class="d">-    fun addBuffer(id: Int, value: ByteArray) {
</a><a href="#h90-0-26" id="h90-0-26" class="d">-        writeVarInt(id shl 3 or WireType.LENGTH_DELIMITED.value)
</a><a href="#h90-0-27" id="h90-0-27" class="d">-        writeVarInt(value.size)
</a><a href="#h90-0-28" id="h90-0-28" class="d">-        stream.write(value)
</a><a href="#h90-0-29" id="h90-0-29" class="d">-    }
</a><a href="#h90-0-30" id="h90-0-30" class="d">-
</a><a href="#h90-0-31" id="h90-0-31" class="d">-    fun addVarInt(id: Int, value: Int) = addVarInt(id, value.toLong())
</a><a href="#h90-0-32" id="h90-0-32" class="d">-
</a><a href="#h90-0-33" id="h90-0-33" class="d">-    fun addVarInt(id: Int, value: Long) {
</a><a href="#h90-0-34" id="h90-0-34" class="d">-        writeVarInt(id shl 3)
</a><a href="#h90-0-35" id="h90-0-35" class="d">-        writeVarLong(value)
</a><a href="#h90-0-36" id="h90-0-36" class="d">-    }
</a><a href="#h90-0-37" id="h90-0-37" class="d">-
</a><a href="#h90-0-38" id="h90-0-38" class="d">-    fun addString(id: Int, value: String) = addBuffer(id, value.toByteArray())
</a><a href="#h90-0-39" id="h90-0-39" class="d">-
</a><a href="#h90-0-40" id="h90-0-40" class="d">-    fun addFixed32(id: Int, value: Int) {
</a><a href="#h90-0-41" id="h90-0-41" class="d">-        writeVarInt(id shl 3 or WireType.FIXED32.value)
</a><a href="#h90-0-42" id="h90-0-42" class="d">-        val bytes = ByteArray(4)
</a><a href="#h90-0-43" id="h90-0-43" class="d">-        for (i in 0..3) {
</a><a href="#h90-0-44" id="h90-0-44" class="d">-            bytes[i] = (value shr (i * 8)).toByte()
</a><a href="#h90-0-45" id="h90-0-45" class="d">-        }
</a><a href="#h90-0-46" id="h90-0-46" class="d">-        stream.write(bytes)
</a><a href="#h90-0-47" id="h90-0-47" class="d">-    }
</a><a href="#h90-0-48" id="h90-0-48" class="d">-
</a><a href="#h90-0-49" id="h90-0-49" class="d">-    fun addFixed64(id: Int, value: Long) {
</a><a href="#h90-0-50" id="h90-0-50" class="d">-        writeVarInt(id shl 3 or WireType.FIXED64.value)
</a><a href="#h90-0-51" id="h90-0-51" class="d">-        val bytes = ByteArray(8)
</a><a href="#h90-0-52" id="h90-0-52" class="d">-        for (i in 0..7) {
</a><a href="#h90-0-53" id="h90-0-53" class="d">-            bytes[i] = (value shr (i * 8)).toByte()
</a><a href="#h90-0-54" id="h90-0-54" class="d">-        }
</a><a href="#h90-0-55" id="h90-0-55" class="d">-        stream.write(bytes)
</a><a href="#h90-0-56" id="h90-0-56" class="d">-    }
</a><a href="#h90-0-57" id="h90-0-57" class="d">-
</a><a href="#h90-0-58" id="h90-0-58" class="d">-    fun from(id: Int, writer: ProtoWriter.() -&gt; Unit) {
</a><a href="#h90-0-59" id="h90-0-59" class="d">-        val writerStream = ProtoWriter()
</a><a href="#h90-0-60" id="h90-0-60" class="d">-        writer(writerStream)
</a><a href="#h90-0-61" id="h90-0-61" class="d">-        addBuffer(id, writerStream.stream.toByteArray())
</a><a href="#h90-0-62" id="h90-0-62" class="d">-    }
</a><a href="#h90-0-63" id="h90-0-63" class="d">-
</a><a href="#h90-0-64" id="h90-0-64" class="d">-    fun from(vararg ids: Int, writer: ProtoWriter.() -&gt; Unit) {
</a><a href="#h90-0-65" id="h90-0-65" class="d">-        val writerStream = ProtoWriter()
</a><a href="#h90-0-66" id="h90-0-66" class="d">-        writer(writerStream)
</a><a href="#h90-0-67" id="h90-0-67" class="d">-        var stream = writerStream.stream.toByteArray()
</a><a href="#h90-0-68" id="h90-0-68" class="d">-        ids.reversed().forEach { id -&gt;
</a><a href="#h90-0-69" id="h90-0-69" class="d">-            with(ProtoWriter()) {
</a><a href="#h90-0-70" id="h90-0-70" class="d">-                addBuffer(id, stream)
</a><a href="#h90-0-71" id="h90-0-71" class="d">-                stream = this.stream.toByteArray()
</a><a href="#h90-0-72" id="h90-0-72" class="d">-            }
</a><a href="#h90-0-73" id="h90-0-73" class="d">-        }
</a><a href="#h90-0-74" id="h90-0-74" class="d">-        stream.let(this.stream::write)
</a><a href="#h90-0-75" id="h90-0-75" class="d">-    }
</a><a href="#h90-0-76" id="h90-0-76" class="d">-
</a><a href="#h90-0-77" id="h90-0-77" class="d">-    fun addWire(wire: Wire) {
</a><a href="#h90-0-78" id="h90-0-78" class="d">-        writeVarInt(wire.id shl 3 or wire.type.value)
</a><a href="#h90-0-79" id="h90-0-79" class="d">-        when (wire.type) {
</a><a href="#h90-0-80" id="h90-0-80" class="d">-            WireType.VARINT -&gt; writeVarLong(wire.value as Long)
</a><a href="#h90-0-81" id="h90-0-81" class="d">-            WireType.FIXED64, WireType.FIXED32 -&gt; {
</a><a href="#h90-0-82" id="h90-0-82" class="d">-                when (wire.value) {
</a><a href="#h90-0-83" id="h90-0-83" class="d">-                    is Int -&gt; {
</a><a href="#h90-0-84" id="h90-0-84" class="d">-                        val bytes = ByteArray(4)
</a><a href="#h90-0-85" id="h90-0-85" class="d">-                        for (i in 0..3) {
</a><a href="#h90-0-86" id="h90-0-86" class="d">-                            bytes[i] = (wire.value shr (i * 8)).toByte()
</a><a href="#h90-0-87" id="h90-0-87" class="d">-                        }
</a><a href="#h90-0-88" id="h90-0-88" class="d">-                        stream.write(bytes)
</a><a href="#h90-0-89" id="h90-0-89" class="d">-                    }
</a><a href="#h90-0-90" id="h90-0-90" class="d">-                    is Long -&gt; {
</a><a href="#h90-0-91" id="h90-0-91" class="d">-                        val bytes = ByteArray(8)
</a><a href="#h90-0-92" id="h90-0-92" class="d">-                        for (i in 0..7) {
</a><a href="#h90-0-93" id="h90-0-93" class="d">-                            bytes[i] = (wire.value shr (i * 8)).toByte()
</a><a href="#h90-0-94" id="h90-0-94" class="d">-                        }
</a><a href="#h90-0-95" id="h90-0-95" class="d">-                        stream.write(bytes)
</a><a href="#h90-0-96" id="h90-0-96" class="d">-                    }
</a><a href="#h90-0-97" id="h90-0-97" class="d">-                    is ByteArray -&gt; stream.write(wire.value)
</a><a href="#h90-0-98" id="h90-0-98" class="d">-                }
</a><a href="#h90-0-99" id="h90-0-99" class="d">-            }
</a><a href="#h90-0-100" id="h90-0-100" class="d">-            WireType.LENGTH_DELIMITED -&gt; {
</a><a href="#h90-0-101" id="h90-0-101" class="d">-                val value = wire.value as ByteArray
</a><a href="#h90-0-102" id="h90-0-102" class="d">-                writeVarInt(value.size)
</a><a href="#h90-0-103" id="h90-0-103" class="d">-                stream.write(value)
</a><a href="#h90-0-104" id="h90-0-104" class="d">-            }
</a><a href="#h90-0-105" id="h90-0-105" class="d">-            WireType.START_GROUP -&gt; {
</a><a href="#h90-0-106" id="h90-0-106" class="d">-                val value = wire.value as ByteArray
</a><a href="#h90-0-107" id="h90-0-107" class="d">-                stream.write(value)
</a><a href="#h90-0-108" id="h90-0-108" class="d">-            }
</a><a href="#h90-0-109" id="h90-0-109" class="d">-            WireType.END_GROUP -&gt; return
</a><a href="#h90-0-110" id="h90-0-110" class="d">-        }
</a><a href="#h90-0-111" id="h90-0-111" class="d">-    }
</a><a href="#h90-0-112" id="h90-0-112" class="d">-
</a><a href="#h90-0-113" id="h90-0-113" class="d">-    fun toByteArray(): ByteArray {
</a><a href="#h90-0-114" id="h90-0-114" class="d">-        return stream.toByteArray()
</a><a href="#h90-0-115" id="h90-0-115" class="d">-    }
</a><a href="#h90-0-116" id="h90-0-116" class="d">-}</a><a href="#h90-0-117" id="h90-0-117" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h91" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/util/protobuf/WireType.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/util/protobuf/WireType.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/util/protobuf/WireType.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/util/protobuf/WireType.kt</a></b>
<a href="#h91-0" id="h91-0" class="h">@@ -1,14 +0,0 @@
</a><a href="#h91-0-0" id="h91-0-0" class="d">-package me.rhunk.snapenhance.util.protobuf;
</a><a href="#h91-0-1" id="h91-0-1" class="d">-
</a><a href="#h91-0-2" id="h91-0-2" class="d">-enum class WireType(val value: Int) {
</a><a href="#h91-0-3" id="h91-0-3" class="d">-    VARINT(0),
</a><a href="#h91-0-4" id="h91-0-4" class="d">-    FIXED64(1),
</a><a href="#h91-0-5" id="h91-0-5" class="d">-    LENGTH_DELIMITED(2),
</a><a href="#h91-0-6" id="h91-0-6" class="d">-    START_GROUP(3),
</a><a href="#h91-0-7" id="h91-0-7" class="d">-    END_GROUP(4),
</a><a href="#h91-0-8" id="h91-0-8" class="d">-    FIXED32(5);
</a><a href="#h91-0-9" id="h91-0-9" class="d">-
</a><a href="#h91-0-10" id="h91-0-10" class="d">-    companion object {
</a><a href="#h91-0-11" id="h91-0-11" class="d">-        fun fromValue(value: Int) = values().firstOrNull { it.value == value }
</a><a href="#h91-0-12" id="h91-0-12" class="d">-    }
</a><a href="#h91-0-13" id="h91-0-13" class="d">-}
</a><b>diff --git a/<a id="h92" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/util/snap/BitmojiSelfie.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/util/snap/BitmojiSelfie.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/util/snap/BitmojiSelfie.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/util/snap/BitmojiSelfie.kt</a></b>
<a href="#h92-0" id="h92-0" class="h">@@ -1,20 +0,0 @@
</a><a href="#h92-0-0" id="h92-0-0" class="d">-package me.rhunk.snapenhance.util.snap
</a><a href="#h92-0-1" id="h92-0-1" class="d">-
</a><a href="#h92-0-2" id="h92-0-2" class="d">-object BitmojiSelfie {
</a><a href="#h92-0-3" id="h92-0-3" class="d">-    enum class BitmojiSelfieType(
</a><a href="#h92-0-4" id="h92-0-4" class="d">-        val prefixUrl: String,
</a><a href="#h92-0-5" id="h92-0-5" class="d">-    ) {
</a><a href="#h92-0-6" id="h92-0-6" class="d">-        STANDARD(&quot;https://sdk.bitmoji.com/render/panel/&quot;),
</a><a href="#h92-0-7" id="h92-0-7" class="d">-        THREE_D(&quot;https://images.bitmoji.com/3d/render/&quot;)
</a><a href="#h92-0-8" id="h92-0-8" class="d">-    }
</a><a href="#h92-0-9" id="h92-0-9" class="d">-
</a><a href="#h92-0-10" id="h92-0-10" class="d">-    fun getBitmojiSelfie(selfieId: String?, avatarId: String?, type: BitmojiSelfieType): String? {
</a><a href="#h92-0-11" id="h92-0-11" class="d">-        if (selfieId.isNullOrEmpty() || avatarId.isNullOrEmpty()) {
</a><a href="#h92-0-12" id="h92-0-12" class="d">-            return null
</a><a href="#h92-0-13" id="h92-0-13" class="d">-        }
</a><a href="#h92-0-14" id="h92-0-14" class="d">-        return when (type) {
</a><a href="#h92-0-15" id="h92-0-15" class="d">-            BitmojiSelfieType.STANDARD -&gt; &quot;${type.prefixUrl}$selfieId-$avatarId-v1.webp?transparent=1&quot;
</a><a href="#h92-0-16" id="h92-0-16" class="d">-            BitmojiSelfieType.THREE_D -&gt; &quot;${type.prefixUrl}$selfieId-$avatarId-v1.webp?trim=circle&quot;
</a><a href="#h92-0-17" id="h92-0-17" class="d">-        }
</a><a href="#h92-0-18" id="h92-0-18" class="d">-    }
</a><a href="#h92-0-19" id="h92-0-19" class="d">-}</a><a href="#h92-0-20" id="h92-0-20" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h93" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/util/snap/EncryptionHelper.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/util/snap/EncryptionHelper.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/util/snap/EncryptionHelper.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/util/snap/EncryptionHelper.kt</a></b>
<a href="#h93-0" id="h93-0" class="h">@@ -1,49 +0,0 @@
</a><a href="#h93-0-0" id="h93-0-0" class="d">-package me.rhunk.snapenhance.util.snap
</a><a href="#h93-0-1" id="h93-0-1" class="d">-
</a><a href="#h93-0-2" id="h93-0-2" class="d">-import me.rhunk.snapenhance.Constants
</a><a href="#h93-0-3" id="h93-0-3" class="d">-import me.rhunk.snapenhance.data.ContentType
</a><a href="#h93-0-4" id="h93-0-4" class="d">-import me.rhunk.snapenhance.util.protobuf.ProtoReader
</a><a href="#h93-0-5" id="h93-0-5" class="d">-import java.io.InputStream
</a><a href="#h93-0-6" id="h93-0-6" class="d">-import java.util.Base64
</a><a href="#h93-0-7" id="h93-0-7" class="d">-import javax.crypto.Cipher
</a><a href="#h93-0-8" id="h93-0-8" class="d">-import javax.crypto.CipherInputStream
</a><a href="#h93-0-9" id="h93-0-9" class="d">-import javax.crypto.spec.IvParameterSpec
</a><a href="#h93-0-10" id="h93-0-10" class="d">-import javax.crypto.spec.SecretKeySpec
</a><a href="#h93-0-11" id="h93-0-11" class="d">-
</a><a href="#h93-0-12" id="h93-0-12" class="d">-object EncryptionHelper {
</a><a href="#h93-0-13" id="h93-0-13" class="d">-    fun getEncryptionKeys(contentType: ContentType, messageProto: ProtoReader, isArroyo: Boolean): Pair&lt;ByteArray, ByteArray&gt;? {
</a><a href="#h93-0-14" id="h93-0-14" class="d">-        val mediaEncryptionInfo = MediaDownloaderHelper.getMessageMediaEncryptionInfo(messageProto, contentType, isArroyo) ?: return null
</a><a href="#h93-0-15" id="h93-0-15" class="d">-        val encryptionProtoIndex = if (mediaEncryptionInfo.contains(Constants.ENCRYPTION_PROTO_INDEX_V2)) {
</a><a href="#h93-0-16" id="h93-0-16" class="d">-            Constants.ENCRYPTION_PROTO_INDEX_V2
</a><a href="#h93-0-17" id="h93-0-17" class="d">-        } else {
</a><a href="#h93-0-18" id="h93-0-18" class="d">-            Constants.ENCRYPTION_PROTO_INDEX
</a><a href="#h93-0-19" id="h93-0-19" class="d">-        }
</a><a href="#h93-0-20" id="h93-0-20" class="d">-        val encryptionProto = mediaEncryptionInfo.followPath(encryptionProtoIndex) ?: return null
</a><a href="#h93-0-21" id="h93-0-21" class="d">-
</a><a href="#h93-0-22" id="h93-0-22" class="d">-        var key: ByteArray = encryptionProto.getByteArray(1)!!
</a><a href="#h93-0-23" id="h93-0-23" class="d">-        var iv: ByteArray = encryptionProto.getByteArray(2)!!
</a><a href="#h93-0-24" id="h93-0-24" class="d">-
</a><a href="#h93-0-25" id="h93-0-25" class="d">-        if (encryptionProtoIndex == Constants.ENCRYPTION_PROTO_INDEX_V2) {
</a><a href="#h93-0-26" id="h93-0-26" class="d">-            val decoder = Base64.getMimeDecoder()
</a><a href="#h93-0-27" id="h93-0-27" class="d">-            key = decoder.decode(key)
</a><a href="#h93-0-28" id="h93-0-28" class="d">-            iv = decoder.decode(iv)
</a><a href="#h93-0-29" id="h93-0-29" class="d">-        }
</a><a href="#h93-0-30" id="h93-0-30" class="d">-
</a><a href="#h93-0-31" id="h93-0-31" class="d">-        return Pair(key, iv)
</a><a href="#h93-0-32" id="h93-0-32" class="d">-    }
</a><a href="#h93-0-33" id="h93-0-33" class="d">-
</a><a href="#h93-0-34" id="h93-0-34" class="d">-    fun decryptInputStream(
</a><a href="#h93-0-35" id="h93-0-35" class="d">-        inputStream: InputStream,
</a><a href="#h93-0-36" id="h93-0-36" class="d">-        contentType: ContentType,
</a><a href="#h93-0-37" id="h93-0-37" class="d">-        messageProto: ProtoReader,
</a><a href="#h93-0-38" id="h93-0-38" class="d">-        isArroyo: Boolean
</a><a href="#h93-0-39" id="h93-0-39" class="d">-    ): InputStream {
</a><a href="#h93-0-40" id="h93-0-40" class="d">-        val encryptionKeys = getEncryptionKeys(contentType, messageProto, isArroyo) ?: throw Exception(&quot;Failed to get encryption keys&quot;)
</a><a href="#h93-0-41" id="h93-0-41" class="d">-
</a><a href="#h93-0-42" id="h93-0-42" class="d">-        Cipher.getInstance(&quot;AES/CBC/PKCS5Padding&quot;).apply {
</a><a href="#h93-0-43" id="h93-0-43" class="d">-            init(Cipher.DECRYPT_MODE, SecretKeySpec(encryptionKeys.first, &quot;AES&quot;), IvParameterSpec(encryptionKeys.second))
</a><a href="#h93-0-44" id="h93-0-44" class="d">-        }.let { cipher -&gt;
</a><a href="#h93-0-45" id="h93-0-45" class="d">-            return CipherInputStream(inputStream, cipher)
</a><a href="#h93-0-46" id="h93-0-46" class="d">-        }
</a><a href="#h93-0-47" id="h93-0-47" class="d">-    }
</a><a href="#h93-0-48" id="h93-0-48" class="d">-}
</a><b>diff --git a/<a id="h94" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/util/snap/MediaDownloaderHelper.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/util/snap/MediaDownloaderHelper.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/util/snap/MediaDownloaderHelper.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/util/snap/MediaDownloaderHelper.kt</a></b>
<a href="#h94-0" id="h94-0" class="h">@@ -1,70 +0,0 @@
</a><a href="#h94-0-0" id="h94-0-0" class="d">-package me.rhunk.snapenhance.util.snap
</a><a href="#h94-0-1" id="h94-0-1" class="d">-
</a><a href="#h94-0-2" id="h94-0-2" class="d">-import me.rhunk.snapenhance.Constants
</a><a href="#h94-0-3" id="h94-0-3" class="d">-import me.rhunk.snapenhance.core.download.data.SplitMediaAssetType
</a><a href="#h94-0-4" id="h94-0-4" class="d">-import me.rhunk.snapenhance.data.ContentType
</a><a href="#h94-0-5" id="h94-0-5" class="d">-import me.rhunk.snapenhance.data.FileType
</a><a href="#h94-0-6" id="h94-0-6" class="d">-import me.rhunk.snapenhance.util.download.RemoteMediaResolver
</a><a href="#h94-0-7" id="h94-0-7" class="d">-import me.rhunk.snapenhance.util.protobuf.ProtoReader
</a><a href="#h94-0-8" id="h94-0-8" class="d">-import java.io.ByteArrayInputStream
</a><a href="#h94-0-9" id="h94-0-9" class="d">-import java.io.FileNotFoundException
</a><a href="#h94-0-10" id="h94-0-10" class="d">-import java.io.InputStream
</a><a href="#h94-0-11" id="h94-0-11" class="d">-import java.util.zip.ZipInputStream
</a><a href="#h94-0-12" id="h94-0-12" class="d">-
</a><a href="#h94-0-13" id="h94-0-13" class="d">-
</a><a href="#h94-0-14" id="h94-0-14" class="d">-object MediaDownloaderHelper {
</a><a href="#h94-0-15" id="h94-0-15" class="d">-    fun getMessageMediaEncryptionInfo(protoReader: ProtoReader, contentType: ContentType, isArroyo: Boolean): ProtoReader? {
</a><a href="#h94-0-16" id="h94-0-16" class="d">-        val messageContainerPath = if (isArroyo) protoReader.followPath(*Constants.ARROYO_MEDIA_CONTAINER_PROTO_PATH)!! else protoReader
</a><a href="#h94-0-17" id="h94-0-17" class="d">-        val mediaContainerPath = if (contentType == ContentType.NOTE) intArrayOf(6, 1, 1) else intArrayOf(5, 1, 1)
</a><a href="#h94-0-18" id="h94-0-18" class="d">-
</a><a href="#h94-0-19" id="h94-0-19" class="d">-        return when (contentType) {
</a><a href="#h94-0-20" id="h94-0-20" class="d">-            ContentType.NOTE -&gt; messageContainerPath.followPath(*mediaContainerPath)
</a><a href="#h94-0-21" id="h94-0-21" class="d">-            ContentType.SNAP -&gt; messageContainerPath.followPath(*(intArrayOf(11) + mediaContainerPath))
</a><a href="#h94-0-22" id="h94-0-22" class="d">-            ContentType.EXTERNAL_MEDIA -&gt; {
</a><a href="#h94-0-23" id="h94-0-23" class="d">-                val externalMediaTypes = arrayOf(
</a><a href="#h94-0-24" id="h94-0-24" class="d">-                    intArrayOf(3, 3, *mediaContainerPath), //normal external media
</a><a href="#h94-0-25" id="h94-0-25" class="d">-                    intArrayOf(7, 15, 1, 1), //attached audio note
</a><a href="#h94-0-26" id="h94-0-26" class="d">-                    intArrayOf(7, 12, 3, *mediaContainerPath), //attached story reply
</a><a href="#h94-0-27" id="h94-0-27" class="d">-                    intArrayOf(7, 3, *mediaContainerPath), //original story reply
</a><a href="#h94-0-28" id="h94-0-28" class="d">-                )
</a><a href="#h94-0-29" id="h94-0-29" class="d">-                externalMediaTypes.forEach { path -&gt;
</a><a href="#h94-0-30" id="h94-0-30" class="d">-                    messageContainerPath.followPath(*path)?.also { return it }
</a><a href="#h94-0-31" id="h94-0-31" class="d">-                }
</a><a href="#h94-0-32" id="h94-0-32" class="d">-                null
</a><a href="#h94-0-33" id="h94-0-33" class="d">-            }
</a><a href="#h94-0-34" id="h94-0-34" class="d">-            else -&gt; null
</a><a href="#h94-0-35" id="h94-0-35" class="d">-        }
</a><a href="#h94-0-36" id="h94-0-36" class="d">-    }
</a><a href="#h94-0-37" id="h94-0-37" class="d">-
</a><a href="#h94-0-38" id="h94-0-38" class="d">-    fun downloadMediaFromReference(
</a><a href="#h94-0-39" id="h94-0-39" class="d">-        mediaReference: ByteArray,
</a><a href="#h94-0-40" id="h94-0-40" class="d">-        decryptionCallback: (InputStream) -&gt; InputStream,
</a><a href="#h94-0-41" id="h94-0-41" class="d">-    ): Map&lt;SplitMediaAssetType, ByteArray&gt; {
</a><a href="#h94-0-42" id="h94-0-42" class="d">-        val inputStream = RemoteMediaResolver.downloadBoltMedia(mediaReference) ?: throw FileNotFoundException(&quot;Unable to get media key. Check the logs for more info&quot;)
</a><a href="#h94-0-43" id="h94-0-43" class="d">-        val content = decryptionCallback(inputStream).readBytes()
</a><a href="#h94-0-44" id="h94-0-44" class="d">-        val fileType = FileType.fromByteArray(content)
</a><a href="#h94-0-45" id="h94-0-45" class="d">-        val isZipFile = fileType == FileType.ZIP
</a><a href="#h94-0-46" id="h94-0-46" class="d">-
</a><a href="#h94-0-47" id="h94-0-47" class="d">-        //videos with overlay are packed in a zip file
</a><a href="#h94-0-48" id="h94-0-48" class="d">-        //there are 2 files in the zip file, the video (webm) and the overlay (png)
</a><a href="#h94-0-49" id="h94-0-49" class="d">-        if (isZipFile) {
</a><a href="#h94-0-50" id="h94-0-50" class="d">-            var videoData: ByteArray? = null
</a><a href="#h94-0-51" id="h94-0-51" class="d">-            var overlayData: ByteArray? = null
</a><a href="#h94-0-52" id="h94-0-52" class="d">-            val zipInputStream = ZipInputStream(ByteArrayInputStream(content))
</a><a href="#h94-0-53" id="h94-0-53" class="d">-            while (zipInputStream.nextEntry != null) {
</a><a href="#h94-0-54" id="h94-0-54" class="d">-                val zipEntryData: ByteArray = zipInputStream.readBytes()
</a><a href="#h94-0-55" id="h94-0-55" class="d">-                val entryFileType = FileType.fromByteArray(zipEntryData)
</a><a href="#h94-0-56" id="h94-0-56" class="d">-                if (entryFileType.isVideo) {
</a><a href="#h94-0-57" id="h94-0-57" class="d">-                    videoData = zipEntryData
</a><a href="#h94-0-58" id="h94-0-58" class="d">-                } else if (entryFileType.isImage) {
</a><a href="#h94-0-59" id="h94-0-59" class="d">-                    overlayData = zipEntryData
</a><a href="#h94-0-60" id="h94-0-60" class="d">-                }
</a><a href="#h94-0-61" id="h94-0-61" class="d">-            }
</a><a href="#h94-0-62" id="h94-0-62" class="d">-            videoData ?: throw FileNotFoundException(&quot;Unable to find video file in zip file&quot;)
</a><a href="#h94-0-63" id="h94-0-63" class="d">-            overlayData ?: throw FileNotFoundException(&quot;Unable to find overlay file in zip file&quot;)
</a><a href="#h94-0-64" id="h94-0-64" class="d">-            return mapOf(SplitMediaAssetType.ORIGINAL to videoData, SplitMediaAssetType.OVERLAY to overlayData)
</a><a href="#h94-0-65" id="h94-0-65" class="d">-        }
</a><a href="#h94-0-66" id="h94-0-66" class="d">-
</a><a href="#h94-0-67" id="h94-0-67" class="d">-        return mapOf(SplitMediaAssetType.ORIGINAL to content)
</a><a href="#h94-0-68" id="h94-0-68" class="d">-    }
</a><a href="#h94-0-69" id="h94-0-69" class="d">-}</a><a href="#h94-0-70" id="h94-0-70" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h95" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/util/snap/PreviewUtils.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/util/snap/PreviewUtils.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/util/snap/PreviewUtils.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/util/snap/PreviewUtils.kt</a></b>
<a href="#h95-0" id="h95-0" class="h">@@ -1,87 +0,0 @@
</a><a href="#h95-0-0" id="h95-0-0" class="d">-package me.rhunk.snapenhance.util.snap
</a><a href="#h95-0-1" id="h95-0-1" class="d">-
</a><a href="#h95-0-2" id="h95-0-2" class="d">-import android.graphics.Bitmap
</a><a href="#h95-0-3" id="h95-0-3" class="d">-import android.graphics.BitmapFactory
</a><a href="#h95-0-4" id="h95-0-4" class="d">-import android.graphics.Canvas
</a><a href="#h95-0-5" id="h95-0-5" class="d">-import android.graphics.Matrix
</a><a href="#h95-0-6" id="h95-0-6" class="d">-import android.media.MediaDataSource
</a><a href="#h95-0-7" id="h95-0-7" class="d">-import android.media.MediaMetadataRetriever
</a><a href="#h95-0-8" id="h95-0-8" class="d">-import me.rhunk.snapenhance.data.FileType
</a><a href="#h95-0-9" id="h95-0-9" class="d">-import java.io.File
</a><a href="#h95-0-10" id="h95-0-10" class="d">-
</a><a href="#h95-0-11" id="h95-0-11" class="d">-object PreviewUtils {
</a><a href="#h95-0-12" id="h95-0-12" class="d">-    fun createPreview(data: ByteArray, isVideo: Boolean): Bitmap? {
</a><a href="#h95-0-13" id="h95-0-13" class="d">-        if (!isVideo) {
</a><a href="#h95-0-14" id="h95-0-14" class="d">-            return BitmapFactory.decodeByteArray(data, 0, data.size)
</a><a href="#h95-0-15" id="h95-0-15" class="d">-        }
</a><a href="#h95-0-16" id="h95-0-16" class="d">-        return MediaMetadataRetriever().apply {
</a><a href="#h95-0-17" id="h95-0-17" class="d">-            setDataSource(object : MediaDataSource() {
</a><a href="#h95-0-18" id="h95-0-18" class="d">-                override fun readAt(
</a><a href="#h95-0-19" id="h95-0-19" class="d">-                    position: Long,
</a><a href="#h95-0-20" id="h95-0-20" class="d">-                    buffer: ByteArray,
</a><a href="#h95-0-21" id="h95-0-21" class="d">-                    offset: Int,
</a><a href="#h95-0-22" id="h95-0-22" class="d">-                    size: Int
</a><a href="#h95-0-23" id="h95-0-23" class="d">-                ): Int {
</a><a href="#h95-0-24" id="h95-0-24" class="d">-                    var newSize = size
</a><a href="#h95-0-25" id="h95-0-25" class="d">-                    val length = data.size
</a><a href="#h95-0-26" id="h95-0-26" class="d">-                    if (position &gt;= length) {
</a><a href="#h95-0-27" id="h95-0-27" class="d">-                        return -1
</a><a href="#h95-0-28" id="h95-0-28" class="d">-                    }
</a><a href="#h95-0-29" id="h95-0-29" class="d">-                    if (position + newSize &gt; length) {
</a><a href="#h95-0-30" id="h95-0-30" class="d">-                        newSize = length - position.toInt()
</a><a href="#h95-0-31" id="h95-0-31" class="d">-                    }
</a><a href="#h95-0-32" id="h95-0-32" class="d">-                    System.arraycopy(data, position.toInt(), buffer, offset, newSize)
</a><a href="#h95-0-33" id="h95-0-33" class="d">-                    return newSize
</a><a href="#h95-0-34" id="h95-0-34" class="d">-                }
</a><a href="#h95-0-35" id="h95-0-35" class="d">-
</a><a href="#h95-0-36" id="h95-0-36" class="d">-                override fun getSize(): Long {
</a><a href="#h95-0-37" id="h95-0-37" class="d">-                    return data.size.toLong()
</a><a href="#h95-0-38" id="h95-0-38" class="d">-                }
</a><a href="#h95-0-39" id="h95-0-39" class="d">-                override fun close() {}
</a><a href="#h95-0-40" id="h95-0-40" class="d">-            })
</a><a href="#h95-0-41" id="h95-0-41" class="d">-        }.getFrameAtTime(0, MediaMetadataRetriever.OPTION_CLOSEST_SYNC)
</a><a href="#h95-0-42" id="h95-0-42" class="d">-    }
</a><a href="#h95-0-43" id="h95-0-43" class="d">-
</a><a href="#h95-0-44" id="h95-0-44" class="d">-    fun createPreviewFromFile(file: File): Bitmap? {
</a><a href="#h95-0-45" id="h95-0-45" class="d">-        return if (FileType.fromFile(file).isVideo) {
</a><a href="#h95-0-46" id="h95-0-46" class="d">-            MediaMetadataRetriever().apply {
</a><a href="#h95-0-47" id="h95-0-47" class="d">-                setDataSource(file.absolutePath)
</a><a href="#h95-0-48" id="h95-0-48" class="d">-            }.getFrameAtTime(0, MediaMetadataRetriever.OPTION_CLOSEST_SYNC)
</a><a href="#h95-0-49" id="h95-0-49" class="d">-        } else {
</a><a href="#h95-0-50" id="h95-0-50" class="d">-            BitmapFactory.decodeFile(file.absolutePath, BitmapFactory.Options())
</a><a href="#h95-0-51" id="h95-0-51" class="d">-        }
</a><a href="#h95-0-52" id="h95-0-52" class="d">-    }
</a><a href="#h95-0-53" id="h95-0-53" class="d">-
</a><a href="#h95-0-54" id="h95-0-54" class="d">-    private fun resizeBitmap(bitmap: Bitmap, outWidth: Int, outHeight: Int): Bitmap? {
</a><a href="#h95-0-55" id="h95-0-55" class="d">-        val scaleWidth = outWidth.toFloat() / bitmap.width
</a><a href="#h95-0-56" id="h95-0-56" class="d">-        val scaleHeight = outHeight.toFloat() / bitmap.height
</a><a href="#h95-0-57" id="h95-0-57" class="d">-        val matrix = Matrix()
</a><a href="#h95-0-58" id="h95-0-58" class="d">-        matrix.postScale(scaleWidth, scaleHeight)
</a><a href="#h95-0-59" id="h95-0-59" class="d">-        val resizedBitmap = Bitmap.createBitmap(bitmap, 0, 0, bitmap.width, bitmap.height, matrix, false)
</a><a href="#h95-0-60" id="h95-0-60" class="d">-        bitmap.recycle()
</a><a href="#h95-0-61" id="h95-0-61" class="d">-        return resizedBitmap
</a><a href="#h95-0-62" id="h95-0-62" class="d">-    }
</a><a href="#h95-0-63" id="h95-0-63" class="d">-
</a><a href="#h95-0-64" id="h95-0-64" class="d">-    fun mergeBitmapOverlay(originalMedia: Bitmap, overlayLayer: Bitmap): Bitmap {
</a><a href="#h95-0-65" id="h95-0-65" class="d">-        val biggestBitmap = if (originalMedia.width * originalMedia.height &gt; overlayLayer.width * overlayLayer.height) originalMedia else overlayLayer
</a><a href="#h95-0-66" id="h95-0-66" class="d">-        val smallestBitmap = if (biggestBitmap == originalMedia) overlayLayer else originalMedia
</a><a href="#h95-0-67" id="h95-0-67" class="d">-
</a><a href="#h95-0-68" id="h95-0-68" class="d">-        val mergedBitmap = Bitmap.createBitmap(biggestBitmap.width, biggestBitmap.height, biggestBitmap.config)
</a><a href="#h95-0-69" id="h95-0-69" class="d">-
</a><a href="#h95-0-70" id="h95-0-70" class="d">-        with(Canvas(mergedBitmap)) {
</a><a href="#h95-0-71" id="h95-0-71" class="d">-            val scaleMatrix = Matrix().apply {
</a><a href="#h95-0-72" id="h95-0-72" class="d">-                postScale(biggestBitmap.width.toFloat() / smallestBitmap.width.toFloat(), biggestBitmap.height.toFloat() / smallestBitmap.height.toFloat())
</a><a href="#h95-0-73" id="h95-0-73" class="d">-            }
</a><a href="#h95-0-74" id="h95-0-74" class="d">-
</a><a href="#h95-0-75" id="h95-0-75" class="d">-            if (biggestBitmap == originalMedia) {
</a><a href="#h95-0-76" id="h95-0-76" class="d">-                drawBitmap(originalMedia, 0f, 0f, null)
</a><a href="#h95-0-77" id="h95-0-77" class="d">-                drawBitmap(overlayLayer, scaleMatrix, null)
</a><a href="#h95-0-78" id="h95-0-78" class="d">-            } else {
</a><a href="#h95-0-79" id="h95-0-79" class="d">-                drawBitmap(originalMedia, scaleMatrix, null)
</a><a href="#h95-0-80" id="h95-0-80" class="d">-                drawBitmap(overlayLayer, 0f, 0f, null)
</a><a href="#h95-0-81" id="h95-0-81" class="d">-            }
</a><a href="#h95-0-82" id="h95-0-82" class="d">-        }
</a><a href="#h95-0-83" id="h95-0-83" class="d">-
</a><a href="#h95-0-84" id="h95-0-84" class="d">-        return mergedBitmap
</a><a href="#h95-0-85" id="h95-0-85" class="d">-    }
</a><a href="#h95-0-86" id="h95-0-86" class="d">-}
</a><b>diff --git a/<a id="h96" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/util/snap/SnapWidgetBroadcastReceiverHelper.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/util/snap/SnapWidgetBroadcastReceiverHelper.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/util/snap/SnapWidgetBroadcastReceiverHelper.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/util/snap/SnapWidgetBroadcastReceiverHelper.kt</a></b>
<a href="#h96-0" id="h96-0" class="h">@@ -1,24 +0,0 @@
</a><a href="#h96-0-0" id="h96-0-0" class="d">-package me.rhunk.snapenhance.util.snap
</a><a href="#h96-0-1" id="h96-0-1" class="d">-
</a><a href="#h96-0-2" id="h96-0-2" class="d">-import android.content.Intent
</a><a href="#h96-0-3" id="h96-0-3" class="d">-import me.rhunk.snapenhance.Constants
</a><a href="#h96-0-4" id="h96-0-4" class="d">-
</a><a href="#h96-0-5" id="h96-0-5" class="d">-object SnapWidgetBroadcastReceiverHelper {
</a><a href="#h96-0-6" id="h96-0-6" class="d">-    private const val ACTION_WIDGET_UPDATE = &quot;com.snap.android.WIDGET_APP_START_UPDATE_ACTION&quot;
</a><a href="#h96-0-7" id="h96-0-7" class="d">-    const val CLASS_NAME = &quot;com.snap.widgets.core.BestFriendsWidgetProvider&quot;
</a><a href="#h96-0-8" id="h96-0-8" class="d">-
</a><a href="#h96-0-9" id="h96-0-9" class="d">-    fun create(targetAction: String, callback: Intent.() -&gt; Unit): Intent {
</a><a href="#h96-0-10" id="h96-0-10" class="d">-        with(Intent()) {
</a><a href="#h96-0-11" id="h96-0-11" class="d">-            callback(this)
</a><a href="#h96-0-12" id="h96-0-12" class="d">-            action = ACTION_WIDGET_UPDATE
</a><a href="#h96-0-13" id="h96-0-13" class="d">-            putExtra(&quot;:)&quot;, true)
</a><a href="#h96-0-14" id="h96-0-14" class="d">-            putExtra(&quot;action&quot;, targetAction)
</a><a href="#h96-0-15" id="h96-0-15" class="d">-            setClassName(Constants.SNAPCHAT_PACKAGE_NAME, CLASS_NAME)
</a><a href="#h96-0-16" id="h96-0-16" class="d">-            return this
</a><a href="#h96-0-17" id="h96-0-17" class="d">-        }
</a><a href="#h96-0-18" id="h96-0-18" class="d">-    }
</a><a href="#h96-0-19" id="h96-0-19" class="d">-
</a><a href="#h96-0-20" id="h96-0-20" class="d">-    fun isIncomingIntentValid(intent: Intent): Boolean {
</a><a href="#h96-0-21" id="h96-0-21" class="d">-        return intent.action == ACTION_WIDGET_UPDATE &amp;&amp; intent.getBooleanExtra(&quot;:)&quot;, false)
</a><a href="#h96-0-22" id="h96-0-22" class="d">-    }
</a><a href="#h96-0-23" id="h96-0-23" class="d">-}</a><a href="#h96-0-24" id="h96-0-24" class="d">-
\ No newline at end of file
</a></pre>
</div>
</body>
</html>
