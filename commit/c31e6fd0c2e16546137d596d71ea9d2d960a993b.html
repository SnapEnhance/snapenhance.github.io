<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>refactor: file handle manager - SnapEnhance - An Xposed module offering an enhanced Snapchat experience
</title>
<link rel="icon" type="image/svg+xml" href="../../logo.png"/>
<link rel="alternate icon" href="../../favicon.png"/>
<link rel="alternate" type="application/atom+xml" title="SnapEnhance Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="SnapEnhance Atom Feed (tags)" href="../tags.xml" />
<link rel="stylesheet" type="text/css" href="../../style.css" />
<link rel="stylesheet" type="text/css" href="../../fonts.css" />
</head>
<body>
<div id="head"><table><tr><td><a class="logo" href="../../"><img src="../../logo.png" alt="" width="32" height="32" /></a></td><td><strong>SnapEnhance</strong><span class="desc"> - An Xposed module offering an enhanced Snapchat experience
</span>
</td></tr></table>
<p><a href="../about.html">About</a> | <a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/LICENSE.html">License</a></p>
</div>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/c31e6fd0c2e16546137d596d71ea9d2d960a993b.html">c31e6fd0c2e16546137d596d71ea9d2d960a993b</a>
<b>parent</b> <a href="../commit/84fc7c6ee344860cb9a4f5bfe81d2afaff05995d.html">84fc7c6ee344860cb9a4f5bfe81d2afaff05995d</a>
<b>Author:</b> rhunk &lt;<a href="mailto:101876869+rhunk@users.noreply.github.com">101876869+rhunk@users.noreply.github.com</a>&gt;
<b>Date:</b>   Tue, 28 May 2024 23:41:52 +0200

refactor: file handle manager

<b>Diffstat:</b>
<table><tr><td class="A">A</td><td><a href="#h0">app/src/main/kotlin/me/rhunk/snapenhance/RemoteFileHandleManager.kt</a></td><td> | </td><td class="num">88</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">app/src/main/kotlin/me/rhunk/snapenhance/RemoteSideContext.kt</a></td><td> | </td><td class="num">15</td><td><span class="i">+++++++</span><span class="d">--------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h2">app/src/main/kotlin/me/rhunk/snapenhance/bridge/BridgeService.kt</a></td><td> | </td><td class="num">52</td><td><span class="i">++++</span><span class="d">------------------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h3">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/LoggerHistoryRoot.kt</a></td><td> | </td><td class="num">4</td><td><span class="i">+</span><span class="d">---</span></td></tr>
<tr><td class="M">M</td><td><a href="#h4">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/home/HomeSettings.kt</a></td><td> | </td><td class="num">12</td><td><span class="i">+++++</span><span class="d">-------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h5">app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/screens/impl/PickLanguageScreen.kt</a></td><td> | </td><td class="num">3</td><td><span class="i">+</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h6">common/src/main/aidl/me/rhunk/snapenhance/bridge/BridgeInterface.aidl</a></td><td> | </td><td class="num">22</td><td><span class="i">++++++</span><span class="d">----------------</span></td></tr>
<tr><td class="A">A</td><td><a href="#h7">common/src/main/aidl/me/rhunk/snapenhance/bridge/storage/FileHandle.aidl</a></td><td> | </td><td class="num">10</td><td><span class="i">++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h8">common/src/main/aidl/me/rhunk/snapenhance/bridge/storage/FileHandleManager.aidl</a></td><td> | </td><td class="num">8</td><td><span class="i">++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h9">common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/BridgeFiles.kt</a></td><td> | </td><td class="num">94</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="D">D</td><td><a href="#h10">common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/FileLoaderWrapper.kt</a></td><td> | </td><td class="num">30</td><td><span class="i"></span><span class="d">------------------------------</span></td></tr>
<tr><td class="A">A</td><td><a href="#h11">common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/InternalFileWrapper.kt</a></td><td> | </td><td class="num">18</td><td><span class="i">++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="D">D</td><td><a href="#h12">common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/types/BridgeFileType.kt</a></td><td> | </td><td class="num">27</td><td><span class="i"></span><span class="d">---------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h13">common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/types/FileActionType.kt</a></td><td> | </td><td class="num">6</td><td><span class="i"></span><span class="d">------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h14">common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/types/LocalePair.kt</a></td><td> | </td><td class="num">18</td><td><span class="i"></span><span class="d">------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h15">common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/wrapper/LocaleWrapper.kt</a></td><td> | </td><td class="num">75</td><td><span class="i">++++++++++++++++++++++++++++++++++</span><span class="d">-----------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h16">common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/wrapper/LoggerWrapper.kt</a></td><td> | </td><td class="num">4</td><td><span class="i">++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h17">common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/wrapper/MappingsWrapper.kt</a></td><td> | </td><td class="num">17</td><td><span class="i">++++++++++</span><span class="d">-------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h18">common/src/main/kotlin/me/rhunk/snapenhance/common/config/ModConfig.kt</a></td><td> | </td><td class="num">30</td><td><span class="i">+++++++++++</span><span class="d">-------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h19">core/src/main/kotlin/me/rhunk/snapenhance/core/ModContext.kt</a></td><td> | </td><td class="num">13</td><td><span class="i">+++++</span><span class="d">--------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h20">core/src/main/kotlin/me/rhunk/snapenhance/core/SnapEnhance.kt</a></td><td> | </td><td class="num">6</td><td><span class="i">+</span><span class="d">-----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h21">core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/BridgeClient.kt</a></td><td> | </td><td class="num">48</td><td><span class="i">+++</span><span class="d">---------------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h22">core/src/main/kotlin/me/rhunk/snapenhance/core/features/BridgeFileFeature.kt</a></td><td> | </td><td class="num">30</td><td><span class="i">++++++++++++++++++</span><span class="d">------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h23">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/BestFriendPinning.kt</a></td><td> | </td><td class="num">4</td><td><span class="i">++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h24">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/SuspendLocationUpdates.kt</a></td><td> | </td><td class="num">4</td><td><span class="i">++</span><span class="d">--</span></td></tr>
</table></pre><pre>25 files changed, 332 insertions(+), 306 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/RemoteFileHandleManager.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/RemoteFileHandleManager.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/RemoteFileHandleManager.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/RemoteFileHandleManager.kt</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -0,0 +1,87 @@
</a><a href="#h0-0-0" id="h0-0-0" class="i">+package me.rhunk.snapenhance
</a><a href="#h0-0-1" id="h0-0-1" class="i">+
</a><a href="#h0-0-2" id="h0-0-2" class="i">+import android.os.ParcelFileDescriptor
</a><a href="#h0-0-3" id="h0-0-3" class="i">+import me.rhunk.snapenhance.bridge.storage.FileHandle
</a><a href="#h0-0-4" id="h0-0-4" class="i">+import me.rhunk.snapenhance.bridge.storage.FileHandleManager
</a><a href="#h0-0-5" id="h0-0-5" class="i">+import me.rhunk.snapenhance.common.bridge.FileHandleScope
</a><a href="#h0-0-6" id="h0-0-6" class="i">+import me.rhunk.snapenhance.common.bridge.InternalFileHandleType
</a><a href="#h0-0-7" id="h0-0-7" class="i">+import me.rhunk.snapenhance.common.bridge.wrapper.LocaleWrapper
</a><a href="#h0-0-8" id="h0-0-8" class="i">+import me.rhunk.snapenhance.common.logger.AbstractLogger
</a><a href="#h0-0-9" id="h0-0-9" class="i">+import me.rhunk.snapenhance.common.util.ktx.toParcelFileDescriptor
</a><a href="#h0-0-10" id="h0-0-10" class="i">+import java.io.File
</a><a href="#h0-0-11" id="h0-0-11" class="i">+
</a><a href="#h0-0-12" id="h0-0-12" class="i">+
</a><a href="#h0-0-13" id="h0-0-13" class="i">+class LocalFileHandle(
</a><a href="#h0-0-14" id="h0-0-14" class="i">+    private val file: File
</a><a href="#h0-0-15" id="h0-0-15" class="i">+): FileHandle.Stub() {
</a><a href="#h0-0-16" id="h0-0-16" class="i">+    override fun exists() = file.exists()
</a><a href="#h0-0-17" id="h0-0-17" class="i">+    override fun create() = file.createNewFile()
</a><a href="#h0-0-18" id="h0-0-18" class="i">+    override fun delete() = file.delete()
</a><a href="#h0-0-19" id="h0-0-19" class="i">+
</a><a href="#h0-0-20" id="h0-0-20" class="i">+    override fun open(mode: Int): ParcelFileDescriptor? {
</a><a href="#h0-0-21" id="h0-0-21" class="i">+        return runCatching {
</a><a href="#h0-0-22" id="h0-0-22" class="i">+            ParcelFileDescriptor.open(file, mode)
</a><a href="#h0-0-23" id="h0-0-23" class="i">+        }.onFailure {
</a><a href="#h0-0-24" id="h0-0-24" class="i">+            AbstractLogger.directError(&quot;Failed to open file handle: ${it.message}&quot;, it)
</a><a href="#h0-0-25" id="h0-0-25" class="i">+        }.getOrNull()
</a><a href="#h0-0-26" id="h0-0-26" class="i">+    }
</a><a href="#h0-0-27" id="h0-0-27" class="i">+}
</a><a href="#h0-0-28" id="h0-0-28" class="i">+
</a><a href="#h0-0-29" id="h0-0-29" class="i">+class AssetFileHandle(
</a><a href="#h0-0-30" id="h0-0-30" class="i">+    private val context: RemoteSideContext,
</a><a href="#h0-0-31" id="h0-0-31" class="i">+    private val assetPath: String
</a><a href="#h0-0-32" id="h0-0-32" class="i">+): FileHandle.Stub() {
</a><a href="#h0-0-33" id="h0-0-33" class="i">+    override fun exists() = true
</a><a href="#h0-0-34" id="h0-0-34" class="i">+    override fun create() = false
</a><a href="#h0-0-35" id="h0-0-35" class="i">+    override fun delete() = false
</a><a href="#h0-0-36" id="h0-0-36" class="i">+
</a><a href="#h0-0-37" id="h0-0-37" class="i">+    override fun open(mode: Int): ParcelFileDescriptor? {
</a><a href="#h0-0-38" id="h0-0-38" class="i">+        return runCatching {
</a><a href="#h0-0-39" id="h0-0-39" class="i">+            context.androidContext.assets.open(assetPath).toParcelFileDescriptor(context.coroutineScope)
</a><a href="#h0-0-40" id="h0-0-40" class="i">+        }.onFailure {
</a><a href="#h0-0-41" id="h0-0-41" class="i">+            AbstractLogger.directError(&quot;Failed to open asset handle: ${it.message}&quot;, it)
</a><a href="#h0-0-42" id="h0-0-42" class="i">+        }.getOrNull()
</a><a href="#h0-0-43" id="h0-0-43" class="i">+    }
</a><a href="#h0-0-44" id="h0-0-44" class="i">+}
</a><a href="#h0-0-45" id="h0-0-45" class="i">+
</a><a href="#h0-0-46" id="h0-0-46" class="i">+
</a><a href="#h0-0-47" id="h0-0-47" class="i">+class RemoteFileHandleManager(
</a><a href="#h0-0-48" id="h0-0-48" class="i">+    private val context: RemoteSideContext
</a><a href="#h0-0-49" id="h0-0-49" class="i">+): FileHandleManager.Stub() {
</a><a href="#h0-0-50" id="h0-0-50" class="i">+    override fun getFileHandle(scope: String, name: String): FileHandle? {
</a><a href="#h0-0-51" id="h0-0-51" class="i">+        val fileHandleScope = FileHandleScope.fromValue(scope) ?: run {
</a><a href="#h0-0-52" id="h0-0-52" class="i">+            context.log.error(&quot;invalid file handle scope: $scope&quot;, &quot;FileHandleManager&quot;)
</a><a href="#h0-0-53" id="h0-0-53" class="i">+            return null
</a><a href="#h0-0-54" id="h0-0-54" class="i">+        }
</a><a href="#h0-0-55" id="h0-0-55" class="i">+        when (fileHandleScope) {
</a><a href="#h0-0-56" id="h0-0-56" class="i">+            FileHandleScope.INTERNAL -&gt; {
</a><a href="#h0-0-57" id="h0-0-57" class="i">+                val fileHandleType = InternalFileHandleType.fromValue(name) ?: run {
</a><a href="#h0-0-58" id="h0-0-58" class="i">+                    context.log.error(&quot;invalid file handle name: $name&quot;, &quot;FileHandleManager&quot;)
</a><a href="#h0-0-59" id="h0-0-59" class="i">+                    return null
</a><a href="#h0-0-60" id="h0-0-60" class="i">+                }
</a><a href="#h0-0-61" id="h0-0-61" class="i">+
</a><a href="#h0-0-62" id="h0-0-62" class="i">+                return LocalFileHandle(
</a><a href="#h0-0-63" id="h0-0-63" class="i">+                    fileHandleType.resolve(context.androidContext)
</a><a href="#h0-0-64" id="h0-0-64" class="i">+                )
</a><a href="#h0-0-65" id="h0-0-65" class="i">+            }
</a><a href="#h0-0-66" id="h0-0-66" class="i">+            FileHandleScope.LOCALE -&gt; {
</a><a href="#h0-0-67" id="h0-0-67" class="i">+                val foundLocale = context.androidContext.resources.assets.list(&quot;lang&quot;)?.firstOrNull {
</a><a href="#h0-0-68" id="h0-0-68" class="i">+                    it.startsWith(name)
</a><a href="#h0-0-69" id="h0-0-69" class="i">+                }?.substringBefore(&quot;.&quot;) ?: return null
</a><a href="#h0-0-70" id="h0-0-70" class="i">+
</a><a href="#h0-0-71" id="h0-0-71" class="i">+                if (name == LocaleWrapper.DEFAULT_LOCALE) {
</a><a href="#h0-0-72" id="h0-0-72" class="i">+                    return AssetFileHandle(
</a><a href="#h0-0-73" id="h0-0-73" class="i">+                        context,
</a><a href="#h0-0-74" id="h0-0-74" class="i">+                        &quot;lang/${LocaleWrapper.DEFAULT_LOCALE}.json&quot;
</a><a href="#h0-0-75" id="h0-0-75" class="i">+                    )
</a><a href="#h0-0-76" id="h0-0-76" class="i">+                }
</a><a href="#h0-0-77" id="h0-0-77" class="i">+
</a><a href="#h0-0-78" id="h0-0-78" class="i">+                return AssetFileHandle(
</a><a href="#h0-0-79" id="h0-0-79" class="i">+                    context,
</a><a href="#h0-0-80" id="h0-0-80" class="i">+                    &quot;lang/$foundLocale.json&quot;
</a><a href="#h0-0-81" id="h0-0-81" class="i">+                )
</a><a href="#h0-0-82" id="h0-0-82" class="i">+            }
</a><a href="#h0-0-83" id="h0-0-83" class="i">+            else -&gt; return null
</a><a href="#h0-0-84" id="h0-0-84" class="i">+        }
</a><a href="#h0-0-85" id="h0-0-85" class="i">+    }
</a><a href="#h0-0-86" id="h0-0-86" class="i">+}</a><a href="#h0-0-87" id="h0-0-87" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h1" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/RemoteSideContext.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/RemoteSideContext.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/RemoteSideContext.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/RemoteSideContext.kt</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -23,7 +23,6 @@ import kotlinx.coroutines.launch
</a> import kotlinx.coroutines.runBlocking
 import me.rhunk.snapenhance.bridge.BridgeService
 import me.rhunk.snapenhance.common.BuildConfig
<a href="#h1-0-3" id="h1-0-3" class="d">-import me.rhunk.snapenhance.common.bridge.types.BridgeFileType
</a> import me.rhunk.snapenhance.common.bridge.wrapper.LocaleWrapper
 import me.rhunk.snapenhance.common.bridge.wrapper.LoggerWrapper
 import me.rhunk.snapenhance.common.bridge.wrapper.MappingsWrapper
<a href="#h1-1" id="h1-1" class="h">@@ -60,9 +59,10 @@ class RemoteSideContext(
</a>         set(value) { _activity?.clear(); _activity = WeakReference(value) }
 
     val sharedPreferences: SharedPreferences get() = androidContext.getSharedPreferences(&quot;prefs&quot;, 0)
<a href="#h1-1-3" id="h1-1-3" class="d">-    val config = ModConfig(androidContext)
</a><a href="#h1-1-4" id="h1-1-4" class="d">-    val translation = LocaleWrapper()
</a><a href="#h1-1-5" id="h1-1-5" class="d">-    val mappings = MappingsWrapper()
</a><a href="#h1-1-6" id="h1-1-6" class="i">+    val fileHandleManager = RemoteFileHandleManager(this)
</a><a href="#h1-1-7" id="h1-1-7" class="i">+    val config = ModConfig(androidContext, fileHandleManager)
</a><a href="#h1-1-8" id="h1-1-8" class="i">+    val translation = LocaleWrapper(fileHandleManager)
</a><a href="#h1-1-9" id="h1-1-9" class="i">+    val mappings = MappingsWrapper(fileHandleManager)
</a>     val taskManager = TaskManager(this)
     val database = AppDatabase(this)
     val streaksReminder = StreaksReminder(this)
<a href="#h1-2" id="h1-2" class="h">@@ -70,7 +70,7 @@ class RemoteSideContext(
</a>     val scriptManager = RemoteScriptManager(this)
     val settingsOverlay = SettingsOverlay(this)
     val e2eeImplementation = E2EEImplementation(this)
<a href="#h1-2-3" id="h1-2-3" class="d">-    val messageLogger by lazy { LoggerWrapper(androidContext.getDatabasePath(BridgeFileType.MESSAGE_LOGGER_DATABASE.fileName)) }
</a><a href="#h1-2-4" id="h1-2-4" class="i">+    val messageLogger by lazy { LoggerWrapper(androidContext) }
</a>     val tracker = RemoteTracker(this)
     val accountStorage = RemoteAccountStorage(this)
 
<a href="#h1-3" id="h1-3" class="h">@@ -99,16 +99,15 @@ class RemoteSideContext(
</a>             runBlocking(Dispatchers.IO) {
                 log.init()
                 log.verbose(&quot;Loading RemoteSideContext&quot;)
<a href="#h1-3-3" id="h1-3-3" class="d">-                config.loadFromContext(androidContext)
</a><a href="#h1-3-4" id="h1-3-4" class="i">+                config.load()
</a>                 launch {
                     mappings.apply {
<a href="#h1-3-7" id="h1-3-7" class="d">-                        loadFromContext(androidContext)
</a>                         init(androidContext)
                     }
                 }
                 translation.apply {
                     userLocale = config.locale
<a href="#h1-3-13" id="h1-3-13" class="d">-                    loadFromContext(androidContext)
</a><a href="#h1-3-14" id="h1-3-14" class="i">+                    load()
</a>                 }
                 database.init()
                 streaksReminder.init()
<b>diff --git a/<a id="h2" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/BridgeService.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/BridgeService.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/BridgeService.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/BridgeService.kt</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -8,9 +8,6 @@ import kotlinx.coroutines.runBlocking
</a> import me.rhunk.snapenhance.RemoteSideContext
 import me.rhunk.snapenhance.SharedContextHolder
 import me.rhunk.snapenhance.bridge.snapclient.MessagingBridge
<a href="#h2-0-3" id="h2-0-3" class="d">-import me.rhunk.snapenhance.common.bridge.types.BridgeFileType
</a><a href="#h2-0-4" id="h2-0-4" class="d">-import me.rhunk.snapenhance.common.bridge.types.FileActionType
</a><a href="#h2-0-5" id="h2-0-5" class="d">-import me.rhunk.snapenhance.common.bridge.wrapper.LocaleWrapper
</a> import me.rhunk.snapenhance.common.data.MessagingFriendInfo
 import me.rhunk.snapenhance.common.data.MessagingGroupInfo
 import me.rhunk.snapenhance.common.data.SocialScope
<a href="#h2-1" id="h2-1" class="h">@@ -84,54 +81,11 @@ class BridgeService : Service() {
</a>     }
 
     inner class BridgeBinder : BridgeInterface.Stub() {
<a href="#h2-1-3" id="h2-1-3" class="i">+        override fun getApplicationApkPath(): String = applicationInfo.publicSourceDir
</a><a href="#h2-1-4" id="h2-1-4" class="i">+
</a>         override fun broadcastLog(tag: String, level: String, message: String) {
             remoteSideContext.log.internalLog(tag, LogLevel.fromShortName(level) ?: LogLevel.INFO, message)
         }
<a href="#h2-1-8" id="h2-1-8" class="d">-
</a><a href="#h2-1-9" id="h2-1-9" class="d">-        override fun fileOperation(action: Int, fileType: Int, content: ByteArray?): ByteArray {
</a><a href="#h2-1-10" id="h2-1-10" class="d">-            val resolvedFile = BridgeFileType.fromValue(fileType)?.resolve(this@BridgeService)
</a><a href="#h2-1-11" id="h2-1-11" class="d">-
</a><a href="#h2-1-12" id="h2-1-12" class="d">-            return when (FileActionType.entries[action]) {
</a><a href="#h2-1-13" id="h2-1-13" class="d">-                FileActionType.CREATE_AND_READ -&gt; {
</a><a href="#h2-1-14" id="h2-1-14" class="d">-                    resolvedFile?.let {
</a><a href="#h2-1-15" id="h2-1-15" class="d">-                        if (!it.exists()) {
</a><a href="#h2-1-16" id="h2-1-16" class="d">-                            return content?.also { content -&gt; it.writeBytes(content) } ?: ByteArray(
</a><a href="#h2-1-17" id="h2-1-17" class="d">-                                0
</a><a href="#h2-1-18" id="h2-1-18" class="d">-                            )
</a><a href="#h2-1-19" id="h2-1-19" class="d">-                        }
</a><a href="#h2-1-20" id="h2-1-20" class="d">-
</a><a href="#h2-1-21" id="h2-1-21" class="d">-                        it.readBytes()
</a><a href="#h2-1-22" id="h2-1-22" class="d">-                    } ?: ByteArray(0)
</a><a href="#h2-1-23" id="h2-1-23" class="d">-                }
</a><a href="#h2-1-24" id="h2-1-24" class="d">-
</a><a href="#h2-1-25" id="h2-1-25" class="d">-                FileActionType.READ -&gt; {
</a><a href="#h2-1-26" id="h2-1-26" class="d">-                    resolvedFile?.takeIf { it.exists() }?.readBytes() ?: ByteArray(0)
</a><a href="#h2-1-27" id="h2-1-27" class="d">-                }
</a><a href="#h2-1-28" id="h2-1-28" class="d">-
</a><a href="#h2-1-29" id="h2-1-29" class="d">-                FileActionType.WRITE -&gt; {
</a><a href="#h2-1-30" id="h2-1-30" class="d">-                    content?.also { resolvedFile?.writeBytes(content) } ?: ByteArray(0)
</a><a href="#h2-1-31" id="h2-1-31" class="d">-                }
</a><a href="#h2-1-32" id="h2-1-32" class="d">-
</a><a href="#h2-1-33" id="h2-1-33" class="d">-                FileActionType.DELETE -&gt; {
</a><a href="#h2-1-34" id="h2-1-34" class="d">-                    resolvedFile?.takeIf { it.exists() }?.delete()
</a><a href="#h2-1-35" id="h2-1-35" class="d">-                    ByteArray(0)
</a><a href="#h2-1-36" id="h2-1-36" class="d">-                }
</a><a href="#h2-1-37" id="h2-1-37" class="d">-
</a><a href="#h2-1-38" id="h2-1-38" class="d">-                FileActionType.EXISTS -&gt; {
</a><a href="#h2-1-39" id="h2-1-39" class="d">-                    if (resolvedFile?.exists() == true)
</a><a href="#h2-1-40" id="h2-1-40" class="d">-                        ByteArray(1)
</a><a href="#h2-1-41" id="h2-1-41" class="d">-                    else ByteArray(0)
</a><a href="#h2-1-42" id="h2-1-42" class="d">-                }
</a><a href="#h2-1-43" id="h2-1-43" class="d">-            }
</a><a href="#h2-1-44" id="h2-1-44" class="d">-        }
</a><a href="#h2-1-45" id="h2-1-45" class="d">-
</a><a href="#h2-1-46" id="h2-1-46" class="d">-        override fun getApplicationApkPath(): String = applicationInfo.publicSourceDir
</a><a href="#h2-1-47" id="h2-1-47" class="d">-
</a><a href="#h2-1-48" id="h2-1-48" class="d">-        override fun fetchLocales(userLocale: String) =
</a><a href="#h2-1-49" id="h2-1-49" class="d">-            LocaleWrapper.fetchLocales(context = this@BridgeService, userLocale).associate {
</a><a href="#h2-1-50" id="h2-1-50" class="d">-                it.locale to it.content
</a><a href="#h2-1-51" id="h2-1-51" class="d">-            }
</a><a href="#h2-1-52" id="h2-1-52" class="d">-
</a>         override fun enqueueDownload(intent: Intent, callback: DownloadCallback) {
             DownloadProcessor(
                 remoteSideContext = remoteSideContext,
<a href="#h2-2" id="h2-2" class="h">@@ -242,6 +196,8 @@ class BridgeService : Service() {
</a>         override fun getLogger() = remoteSideContext.messageLogger
         override fun getTracker() = remoteSideContext.tracker
         override fun getAccountStorage() = remoteSideContext.accountStorage
<a href="#h2-2-3" id="h2-2-3" class="i">+        override fun getFileHandleManager() = remoteSideContext.fileHandleManager
</a><a href="#h2-2-4" id="h2-2-4" class="i">+
</a>         override fun registerMessagingBridge(bridge: MessagingBridge) {
             messagingBridge = bridge
         }
<b>diff --git a/<a id="h3" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/LoggerHistoryRoot.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/LoggerHistoryRoot.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/LoggerHistoryRoot.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/LoggerHistoryRoot.kt</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -222,9 +222,7 @@ class LoggerHistoryRoot : Routes.Route() {
</a>     @OptIn(ExperimentalMaterial3Api::class)
     override val content: @Composable (NavBackStackEntry) -&gt; Unit = {
         LaunchedEffect(Unit) {
<a href="#h3-0-3" id="h3-0-3" class="d">-            loggerWrapper = LoggerWrapper(
</a><a href="#h3-0-4" id="h3-0-4" class="d">-                context.androidContext.getDatabasePath(&quot;message_logger.db&quot;)
</a><a href="#h3-0-5" id="h3-0-5" class="d">-            )
</a><a href="#h3-0-6" id="h3-0-6" class="i">+            loggerWrapper = LoggerWrapper(context.androidContext)
</a>         }
 
         Column {
<b>diff --git a/<a id="h4" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/home/HomeSettings.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/home/HomeSettings.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/home/HomeSettings.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/home/HomeSettings.kt</a></b>
<a href="#h4-0" id="h4-0" class="h">@@ -17,12 +17,10 @@ import androidx.compose.ui.unit.sp
</a> import androidx.compose.ui.window.Dialog
 import androidx.core.net.toUri
 import androidx.navigation.NavBackStackEntry
<a href="#h4-0-3" id="h4-0-3" class="d">-import kotlinx.coroutines.Dispatchers
</a> import kotlinx.coroutines.launch
<a href="#h4-0-5" id="h4-0-5" class="d">-import kotlinx.coroutines.withContext
</a> import me.rhunk.snapenhance.common.Constants
 import me.rhunk.snapenhance.common.action.EnumAction
<a href="#h4-0-8" id="h4-0-8" class="d">-import me.rhunk.snapenhance.common.bridge.types.BridgeFileType
</a><a href="#h4-0-9" id="h4-0-9" class="i">+import me.rhunk.snapenhance.common.bridge.InternalFileHandleType
</a> import me.rhunk.snapenhance.common.ui.rememberAsyncMutableState
 import me.rhunk.snapenhance.ui.manager.Routes
 import me.rhunk.snapenhance.ui.setup.Requirements
<a href="#h4-1" id="h4-1" class="h">@@ -239,7 +237,7 @@ class HomeSettings : Routes.Route() {
</a>                 horizontalArrangement = Arrangement.SpaceBetween,
                 verticalAlignment = Alignment.CenterVertically,
             ) {
<a href="#h4-1-3" id="h4-1-3" class="d">-                var selectedFileType by remember { mutableStateOf(BridgeFileType.entries.first()) }
</a><a href="#h4-1-4" id="h4-1-4" class="i">+                var selectedFileType by remember { mutableStateOf(InternalFileHandleType.entries.first()) }
</a>                 Box(
                     modifier = Modifier
                         .weight(1f)
<a href="#h4-2" id="h4-2" class="h">@@ -253,19 +251,19 @@ class HomeSettings : Routes.Route() {
</a>                         modifier = Modifier.fillMaxWidth(0.7f)
                     ) {
                         TextField(
<a href="#h4-2-3" id="h4-2-3" class="d">-                            value = selectedFileType.displayName,
</a><a href="#h4-2-4" id="h4-2-4" class="i">+                            value = selectedFileType.fileName,
</a>                             onValueChange = {},
                             readOnly = true,
                             modifier = Modifier.menuAnchor()
                         )
 
                         ExposedDropdownMenu(expanded = expanded, onDismissRequest = { expanded = false }) {
<a href="#h4-2-11" id="h4-2-11" class="d">-                            BridgeFileType.entries.forEach { fileType -&gt;
</a><a href="#h4-2-12" id="h4-2-12" class="i">+                            InternalFileHandleType.entries.forEach { fileType -&gt;
</a>                                 DropdownMenuItem(onClick = {
                                     expanded = false
                                     selectedFileType = fileType
                                 }, text = {
<a href="#h4-2-17" id="h4-2-17" class="d">-                                    Text(text = fileType.displayName)
</a><a href="#h4-2-18" id="h4-2-18" class="i">+                                    Text(text = fileType.fileName)
</a>                                 })
                             }
                         }
<b>diff --git a/<a id="h5" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/screens/impl/PickLanguageScreen.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/screens/impl/PickLanguageScreen.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/screens/impl/PickLanguageScreen.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/screens/impl/PickLanguageScreen.kt</a></b>
<a href="#h5-0" id="h5-0" class="h">@@ -46,14 +46,13 @@ class PickLanguageScreen : SetupScreen(){
</a>     }
 
     private fun reloadTranslation(selectedLocale: String) {
<a href="#h5-0-3" id="h5-0-3" class="d">-        context.translation.reloadFromContext(context.androidContext, selectedLocale)
</a><a href="#h5-0-4" id="h5-0-4" class="i">+        context.translation.reload(selectedLocale)
</a>     }
 
     private fun setLocale(locale: String) {
         with(context) {
             config.locale = locale
             config.writeConfig()
<a href="#h5-0-11" id="h5-0-11" class="d">-            translation.reloadFromContext(androidContext, locale)
</a>             reloadTranslation(locale)
         }
     }
<b>diff --git a/<a id="h6" href="../file/common/src/main/aidl/me/rhunk/snapenhance/bridge/BridgeInterface.aidl.html">common/src/main/aidl/me/rhunk/snapenhance/bridge/BridgeInterface.aidl</a> b/<a href="../file/common/src/main/aidl/me/rhunk/snapenhance/bridge/BridgeInterface.aidl.html">common/src/main/aidl/me/rhunk/snapenhance/bridge/BridgeInterface.aidl</a></b>
<a href="#h6-0" id="h6-0" class="h">@@ -10,30 +10,18 @@ import me.rhunk.snapenhance.bridge.logger.TrackerInterface;
</a> import me.rhunk.snapenhance.bridge.ConfigStateListener;
 import me.rhunk.snapenhance.bridge.snapclient.MessagingBridge;
 import me.rhunk.snapenhance.bridge.AccountStorage;
<a href="#h6-0-3" id="h6-0-3" class="i">+import me.rhunk.snapenhance.bridge.storage.FileHandleManager;
</a> 
 interface BridgeInterface {
     /**
<a href="#h6-0-7" id="h6-0-7" class="d">-    * broadcast a log message
</a><a href="#h6-0-8" id="h6-0-8" class="d">-    */
</a><a href="#h6-0-9" id="h6-0-9" class="d">-    oneway void broadcastLog(String tag, String level, String message);
</a><a href="#h6-0-10" id="h6-0-10" class="d">-
</a><a href="#h6-0-11" id="h6-0-11" class="d">-    /**
</a><a href="#h6-0-12" id="h6-0-12" class="d">-    * Execute a file operation
</a><a href="#h6-0-13" id="h6-0-13" class="d">-    * @param fileType the corresponding file type (see BridgeFileType)
</a><a href="#h6-0-14" id="h6-0-14" class="d">-    */
</a><a href="#h6-0-15" id="h6-0-15" class="d">-    byte[] fileOperation(int action, int fileType, in @nullable byte[] content);
</a><a href="#h6-0-16" id="h6-0-16" class="d">-
</a><a href="#h6-0-17" id="h6-0-17" class="d">-    /**
</a>     * Get the application APK path (assets for the conversation exporter)
     */
     String getApplicationApkPath();
 
     /**
<a href="#h6-0-23" id="h6-0-23" class="d">-     * Fetch the locales
</a><a href="#h6-0-24" id="h6-0-24" class="d">-     *
</a><a href="#h6-0-25" id="h6-0-25" class="d">-     * @return the map of locales (key: locale short name, value: locale data as json)
</a><a href="#h6-0-26" id="h6-0-26" class="d">-     */
</a><a href="#h6-0-27" id="h6-0-27" class="d">-    Map&lt;String, ParcelFileDescriptor&gt; fetchLocales(String userLocale);
</a><a href="#h6-0-28" id="h6-0-28" class="i">+    * broadcast a log message
</a><a href="#h6-0-29" id="h6-0-29" class="i">+    */
</a><a href="#h6-0-30" id="h6-0-30" class="i">+    oneway void broadcastLog(String tag, String level, String message);
</a> 
     /**
      * Enqueue a download
<a href="#h6-1" id="h6-1" class="h">@@ -92,6 +80,8 @@ interface BridgeInterface {
</a> 
     AccountStorage getAccountStorage();
 
<a href="#h6-1-3" id="h6-1-3" class="i">+    FileHandleManager getFileHandleManager();
</a><a href="#h6-1-4" id="h6-1-4" class="i">+
</a>     oneway void registerMessagingBridge(MessagingBridge bridge);
 
     oneway void openSettingsOverlay();
<b>diff --git a/<a id="h7" href="../file/common/src/main/aidl/me/rhunk/snapenhance/bridge/storage/FileHandle.aidl.html">common/src/main/aidl/me/rhunk/snapenhance/bridge/storage/FileHandle.aidl</a> b/<a href="../file/common/src/main/aidl/me/rhunk/snapenhance/bridge/storage/FileHandle.aidl.html">common/src/main/aidl/me/rhunk/snapenhance/bridge/storage/FileHandle.aidl</a></b>
<a href="#h7-0" id="h7-0" class="h">@@ -0,0 +1,9 @@
</a><a href="#h7-0-0" id="h7-0-0" class="i">+package me.rhunk.snapenhance.bridge.storage;
</a><a href="#h7-0-1" id="h7-0-1" class="i">+
</a><a href="#h7-0-2" id="h7-0-2" class="i">+interface FileHandle {
</a><a href="#h7-0-3" id="h7-0-3" class="i">+    boolean exists();
</a><a href="#h7-0-4" id="h7-0-4" class="i">+    boolean create();
</a><a href="#h7-0-5" id="h7-0-5" class="i">+    boolean delete();
</a><a href="#h7-0-6" id="h7-0-6" class="i">+
</a><a href="#h7-0-7" id="h7-0-7" class="i">+    @nullable ParcelFileDescriptor open(int mode);
</a><a href="#h7-0-8" id="h7-0-8" class="i">+}</a><a href="#h7-0-9" id="h7-0-9" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h8" href="../file/common/src/main/aidl/me/rhunk/snapenhance/bridge/storage/FileHandleManager.aidl.html">common/src/main/aidl/me/rhunk/snapenhance/bridge/storage/FileHandleManager.aidl</a> b/<a href="../file/common/src/main/aidl/me/rhunk/snapenhance/bridge/storage/FileHandleManager.aidl.html">common/src/main/aidl/me/rhunk/snapenhance/bridge/storage/FileHandleManager.aidl</a></b>
<a href="#h8-0" id="h8-0" class="h">@@ -0,0 +1,7 @@
</a><a href="#h8-0-0" id="h8-0-0" class="i">+package me.rhunk.snapenhance.bridge.storage;
</a><a href="#h8-0-1" id="h8-0-1" class="i">+
</a><a href="#h8-0-2" id="h8-0-2" class="i">+import me.rhunk.snapenhance.bridge.storage.FileHandle;
</a><a href="#h8-0-3" id="h8-0-3" class="i">+
</a><a href="#h8-0-4" id="h8-0-4" class="i">+interface FileHandleManager {
</a><a href="#h8-0-5" id="h8-0-5" class="i">+    @nullable FileHandle getFileHandle(String scope, String name);
</a><a href="#h8-0-6" id="h8-0-6" class="i">+}</a><a href="#h8-0-7" id="h8-0-7" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h9" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/BridgeFiles.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/BridgeFiles.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/BridgeFiles.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/BridgeFiles.kt</a></b>
<a href="#h9-0" id="h9-0" class="h">@@ -0,0 +1,94 @@
</a><a href="#h9-0-0" id="h9-0-0" class="i">+package me.rhunk.snapenhance.common.bridge
</a><a href="#h9-0-1" id="h9-0-1" class="i">+
</a><a href="#h9-0-2" id="h9-0-2" class="i">+import android.content.Context
</a><a href="#h9-0-3" id="h9-0-3" class="i">+import android.os.ParcelFileDescriptor
</a><a href="#h9-0-4" id="h9-0-4" class="i">+import android.os.ParcelFileDescriptor.AutoCloseInputStream
</a><a href="#h9-0-5" id="h9-0-5" class="i">+import android.os.ParcelFileDescriptor.AutoCloseOutputStream
</a><a href="#h9-0-6" id="h9-0-6" class="i">+import me.rhunk.snapenhance.bridge.storage.FileHandle
</a><a href="#h9-0-7" id="h9-0-7" class="i">+import java.io.File
</a><a href="#h9-0-8" id="h9-0-8" class="i">+
</a><a href="#h9-0-9" id="h9-0-9" class="i">+
</a><a href="#h9-0-10" id="h9-0-10" class="i">+enum class FileHandleScope(
</a><a href="#h9-0-11" id="h9-0-11" class="i">+    val key: String
</a><a href="#h9-0-12" id="h9-0-12" class="i">+) {
</a><a href="#h9-0-13" id="h9-0-13" class="i">+    INTERNAL(&quot;internal&quot;),
</a><a href="#h9-0-14" id="h9-0-14" class="i">+    LOCALE(&quot;locale&quot;);
</a><a href="#h9-0-15" id="h9-0-15" class="i">+
</a><a href="#h9-0-16" id="h9-0-16" class="i">+    companion object {
</a><a href="#h9-0-17" id="h9-0-17" class="i">+        fun fromValue(name: String): FileHandleScope? = entries.find { it.key == name }
</a><a href="#h9-0-18" id="h9-0-18" class="i">+    }
</a><a href="#h9-0-19" id="h9-0-19" class="i">+}
</a><a href="#h9-0-20" id="h9-0-20" class="i">+
</a><a href="#h9-0-21" id="h9-0-21" class="i">+enum class InternalFileHandleType(
</a><a href="#h9-0-22" id="h9-0-22" class="i">+    val key: String,
</a><a href="#h9-0-23" id="h9-0-23" class="i">+    val fileName: String,
</a><a href="#h9-0-24" id="h9-0-24" class="i">+    val isDatabase: Boolean = false
</a><a href="#h9-0-25" id="h9-0-25" class="i">+) {
</a><a href="#h9-0-26" id="h9-0-26" class="i">+    CONFIG(&quot;config&quot;, &quot;config.json&quot;),
</a><a href="#h9-0-27" id="h9-0-27" class="i">+    MAPPINGS(&quot;mappings&quot;, &quot;mappings.json&quot;),
</a><a href="#h9-0-28" id="h9-0-28" class="i">+    MESSAGE_LOGGER(&quot;message_logger&quot;, &quot;message_logger.db&quot;, isDatabase = true),
</a><a href="#h9-0-29" id="h9-0-29" class="i">+    SUSPEND_LOCATION_STATE(&quot;suspend_location_state&quot;, &quot;suspend_location_state.txt&quot;),
</a><a href="#h9-0-30" id="h9-0-30" class="i">+    PINNED_BEST_FRIEND(&quot;pinned_best_friend&quot;, &quot;pinned_best_friend.txt&quot;);
</a><a href="#h9-0-31" id="h9-0-31" class="i">+
</a><a href="#h9-0-32" id="h9-0-32" class="i">+
</a><a href="#h9-0-33" id="h9-0-33" class="i">+    fun resolve(context: Context): File = if (isDatabase) {
</a><a href="#h9-0-34" id="h9-0-34" class="i">+        context.getDatabasePath(fileName)
</a><a href="#h9-0-35" id="h9-0-35" class="i">+    } else {
</a><a href="#h9-0-36" id="h9-0-36" class="i">+        File(context.filesDir, fileName)
</a><a href="#h9-0-37" id="h9-0-37" class="i">+    }
</a><a href="#h9-0-38" id="h9-0-38" class="i">+
</a><a href="#h9-0-39" id="h9-0-39" class="i">+    companion object {
</a><a href="#h9-0-40" id="h9-0-40" class="i">+        fun fromValue(name: String): InternalFileHandleType? = entries.find { it.key == name }
</a><a href="#h9-0-41" id="h9-0-41" class="i">+    }
</a><a href="#h9-0-42" id="h9-0-42" class="i">+}
</a><a href="#h9-0-43" id="h9-0-43" class="i">+
</a><a href="#h9-0-44" id="h9-0-44" class="i">+fun FileHandle.toWrapper() = FileHandleWrapper(lazy { this })
</a><a href="#h9-0-45" id="h9-0-45" class="i">+
</a><a href="#h9-0-46" id="h9-0-46" class="i">+open class FileHandleWrapper(
</a><a href="#h9-0-47" id="h9-0-47" class="i">+    private val fileHandle: Lazy&lt;FileHandle&gt;
</a><a href="#h9-0-48" id="h9-0-48" class="i">+) {
</a><a href="#h9-0-49" id="h9-0-49" class="i">+    fun exists() = fileHandle.value.exists()
</a><a href="#h9-0-50" id="h9-0-50" class="i">+    fun create() = fileHandle.value.create()
</a><a href="#h9-0-51" id="h9-0-51" class="i">+    fun delete() = fileHandle.value.delete()
</a><a href="#h9-0-52" id="h9-0-52" class="i">+
</a><a href="#h9-0-53" id="h9-0-53" class="i">+    fun writeBytes(data: ByteArray) = fileHandle.value.open(
</a><a href="#h9-0-54" id="h9-0-54" class="i">+        ParcelFileDescriptor.MODE_WRITE_ONLY or
</a><a href="#h9-0-55" id="h9-0-55" class="i">+                ParcelFileDescriptor.MODE_CREATE or
</a><a href="#h9-0-56" id="h9-0-56" class="i">+                ParcelFileDescriptor.MODE_TRUNCATE
</a><a href="#h9-0-57" id="h9-0-57" class="i">+    ).use { pfd -&gt;
</a><a href="#h9-0-58" id="h9-0-58" class="i">+        AutoCloseOutputStream(pfd).use {
</a><a href="#h9-0-59" id="h9-0-59" class="i">+            it.write(data)
</a><a href="#h9-0-60" id="h9-0-60" class="i">+        }
</a><a href="#h9-0-61" id="h9-0-61" class="i">+    }
</a><a href="#h9-0-62" id="h9-0-62" class="i">+
</a><a href="#h9-0-63" id="h9-0-63" class="i">+    open fun readBytes(): ByteArray = fileHandle.value.open(
</a><a href="#h9-0-64" id="h9-0-64" class="i">+        ParcelFileDescriptor.MODE_READ_ONLY or
</a><a href="#h9-0-65" id="h9-0-65" class="i">+                ParcelFileDescriptor.MODE_CREATE
</a><a href="#h9-0-66" id="h9-0-66" class="i">+    ).use { pfd -&gt;
</a><a href="#h9-0-67" id="h9-0-67" class="i">+        AutoCloseInputStream(pfd).use {
</a><a href="#h9-0-68" id="h9-0-68" class="i">+            it.readBytes()
</a><a href="#h9-0-69" id="h9-0-69" class="i">+        }
</a><a href="#h9-0-70" id="h9-0-70" class="i">+    }
</a><a href="#h9-0-71" id="h9-0-71" class="i">+
</a><a href="#h9-0-72" id="h9-0-72" class="i">+    fun inputStream(block: (AutoCloseInputStream) -&gt; Unit) = fileHandle.value.open(
</a><a href="#h9-0-73" id="h9-0-73" class="i">+        ParcelFileDescriptor.MODE_READ_ONLY or
</a><a href="#h9-0-74" id="h9-0-74" class="i">+                ParcelFileDescriptor.MODE_CREATE
</a><a href="#h9-0-75" id="h9-0-75" class="i">+    ).use { pfd -&gt;
</a><a href="#h9-0-76" id="h9-0-76" class="i">+        AutoCloseInputStream(pfd).use {
</a><a href="#h9-0-77" id="h9-0-77" class="i">+            block(it)
</a><a href="#h9-0-78" id="h9-0-78" class="i">+        }
</a><a href="#h9-0-79" id="h9-0-79" class="i">+    }
</a><a href="#h9-0-80" id="h9-0-80" class="i">+
</a><a href="#h9-0-81" id="h9-0-81" class="i">+    fun outputStream(block: (AutoCloseOutputStream) -&gt; Unit) = fileHandle.value.open(
</a><a href="#h9-0-82" id="h9-0-82" class="i">+        ParcelFileDescriptor.MODE_WRITE_ONLY or
</a><a href="#h9-0-83" id="h9-0-83" class="i">+                ParcelFileDescriptor.MODE_CREATE or
</a><a href="#h9-0-84" id="h9-0-84" class="i">+                ParcelFileDescriptor.MODE_TRUNCATE
</a><a href="#h9-0-85" id="h9-0-85" class="i">+    ).use { pfd -&gt;
</a><a href="#h9-0-86" id="h9-0-86" class="i">+        AutoCloseOutputStream(pfd).use {
</a><a href="#h9-0-87" id="h9-0-87" class="i">+            block(it)
</a><a href="#h9-0-88" id="h9-0-88" class="i">+        }
</a><a href="#h9-0-89" id="h9-0-89" class="i">+    }
</a><a href="#h9-0-90" id="h9-0-90" class="i">+}
</a><a href="#h9-0-91" id="h9-0-91" class="i">+
</a><a href="#h9-0-92" id="h9-0-92" class="i">+
</a><a href="#h9-0-93" id="h9-0-93" class="i">+
</a><b>diff --git a/<a id="h10" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/FileLoaderWrapper.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/FileLoaderWrapper.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/FileLoaderWrapper.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/FileLoaderWrapper.kt</a></b>
<a href="#h10-0" id="h10-0" class="h">@@ -1,29 +0,0 @@
</a><a href="#h10-0-0" id="h10-0-0" class="d">-package me.rhunk.snapenhance.common.bridge
</a><a href="#h10-0-1" id="h10-0-1" class="d">-
</a><a href="#h10-0-2" id="h10-0-2" class="d">-import android.content.Context
</a><a href="#h10-0-3" id="h10-0-3" class="d">-import me.rhunk.snapenhance.common.bridge.types.BridgeFileType
</a><a href="#h10-0-4" id="h10-0-4" class="d">-
</a><a href="#h10-0-5" id="h10-0-5" class="d">-open class FileLoaderWrapper(
</a><a href="#h10-0-6" id="h10-0-6" class="d">-    val fileType: BridgeFileType,
</a><a href="#h10-0-7" id="h10-0-7" class="d">-    val defaultContent: ByteArray
</a><a href="#h10-0-8" id="h10-0-8" class="d">-) {
</a><a href="#h10-0-9" id="h10-0-9" class="d">-    lateinit var isFileExists: () -&gt; Boolean
</a><a href="#h10-0-10" id="h10-0-10" class="d">-    lateinit var write: (ByteArray) -&gt; Unit
</a><a href="#h10-0-11" id="h10-0-11" class="d">-    lateinit var read: () -&gt; ByteArray
</a><a href="#h10-0-12" id="h10-0-12" class="d">-    lateinit var delete: () -&gt; Unit
</a><a href="#h10-0-13" id="h10-0-13" class="d">-
</a><a href="#h10-0-14" id="h10-0-14" class="d">-    fun loadFromContext(context: Context) {
</a><a href="#h10-0-15" id="h10-0-15" class="d">-        val file = fileType.resolve(context)
</a><a href="#h10-0-16" id="h10-0-16" class="d">-        isFileExists = { file.exists() }
</a><a href="#h10-0-17" id="h10-0-17" class="d">-        read = {
</a><a href="#h10-0-18" id="h10-0-18" class="d">-            if (!file.exists()) {
</a><a href="#h10-0-19" id="h10-0-19" class="d">-                file.createNewFile()
</a><a href="#h10-0-20" id="h10-0-20" class="d">-                file.writeBytes(&quot;{}&quot;.toByteArray(Charsets.UTF_8))
</a><a href="#h10-0-21" id="h10-0-21" class="d">-            }
</a><a href="#h10-0-22" id="h10-0-22" class="d">-            file.readBytes()
</a><a href="#h10-0-23" id="h10-0-23" class="d">-        }
</a><a href="#h10-0-24" id="h10-0-24" class="d">-        write = { file.writeBytes(it) }
</a><a href="#h10-0-25" id="h10-0-25" class="d">-        delete = { file.delete() }
</a><a href="#h10-0-26" id="h10-0-26" class="d">-    }
</a><a href="#h10-0-27" id="h10-0-27" class="d">-
</a><a href="#h10-0-28" id="h10-0-28" class="d">-}</a><a href="#h10-0-29" id="h10-0-29" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h11" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/InternalFileWrapper.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/InternalFileWrapper.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/InternalFileWrapper.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/InternalFileWrapper.kt</a></b>
<a href="#h11-0" id="h11-0" class="h">@@ -0,0 +1,17 @@
</a><a href="#h11-0-0" id="h11-0-0" class="i">+package me.rhunk.snapenhance.common.bridge
</a><a href="#h11-0-1" id="h11-0-1" class="i">+
</a><a href="#h11-0-2" id="h11-0-2" class="i">+import me.rhunk.snapenhance.bridge.storage.FileHandleManager
</a><a href="#h11-0-3" id="h11-0-3" class="i">+
</a><a href="#h11-0-4" id="h11-0-4" class="i">+open class InternalFileWrapper(
</a><a href="#h11-0-5" id="h11-0-5" class="i">+    fileHandleManager: FileHandleManager,
</a><a href="#h11-0-6" id="h11-0-6" class="i">+    private val fileType: InternalFileHandleType,
</a><a href="#h11-0-7" id="h11-0-7" class="i">+    val defaultValue: String? = null
</a><a href="#h11-0-8" id="h11-0-8" class="i">+): FileHandleWrapper(lazy { fileHandleManager.getFileHandle(FileHandleScope.INTERNAL.key, fileType.key)!! }) {
</a><a href="#h11-0-9" id="h11-0-9" class="i">+    override fun readBytes(): ByteArray {
</a><a href="#h11-0-10" id="h11-0-10" class="i">+        val bytes = super.readBytes()
</a><a href="#h11-0-11" id="h11-0-11" class="i">+        if (bytes.isEmpty()) {
</a><a href="#h11-0-12" id="h11-0-12" class="i">+            defaultValue?.let { writeBytes(it.toByteArray()) }
</a><a href="#h11-0-13" id="h11-0-13" class="i">+        }
</a><a href="#h11-0-14" id="h11-0-14" class="i">+        return super.readBytes()
</a><a href="#h11-0-15" id="h11-0-15" class="i">+    }
</a><a href="#h11-0-16" id="h11-0-16" class="i">+}</a><a href="#h11-0-17" id="h11-0-17" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h12" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/types/BridgeFileType.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/types/BridgeFileType.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/types/BridgeFileType.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/types/BridgeFileType.kt</a></b>
<a href="#h12-0" id="h12-0" class="h">@@ -1,26 +0,0 @@
</a><a href="#h12-0-0" id="h12-0-0" class="d">-package me.rhunk.snapenhance.common.bridge.types
</a><a href="#h12-0-1" id="h12-0-1" class="d">-
</a><a href="#h12-0-2" id="h12-0-2" class="d">-import android.content.Context
</a><a href="#h12-0-3" id="h12-0-3" class="d">-import java.io.File
</a><a href="#h12-0-4" id="h12-0-4" class="d">-
</a><a href="#h12-0-5" id="h12-0-5" class="d">-
</a><a href="#h12-0-6" id="h12-0-6" class="d">-enum class BridgeFileType(val value: Int, val fileName: String, val displayName: String, private val isDatabase: Boolean = false) {
</a><a href="#h12-0-7" id="h12-0-7" class="d">-    CONFIG(0, &quot;config.json&quot;, &quot;Config&quot;),
</a><a href="#h12-0-8" id="h12-0-8" class="d">-    MAPPINGS(1, &quot;mappings.json&quot;, &quot;Mappings&quot;),
</a><a href="#h12-0-9" id="h12-0-9" class="d">-    MESSAGE_LOGGER_DATABASE(2, &quot;message_logger.db&quot;, &quot;Message Logger&quot;,true),
</a><a href="#h12-0-10" id="h12-0-10" class="d">-    PINNED_CONVERSATIONS(3, &quot;pinned_conversations.txt&quot;, &quot;Pinned Conversations&quot;),
</a><a href="#h12-0-11" id="h12-0-11" class="d">-    SUSPEND_LOCATION_STATE(4, &quot;suspend_location_state.txt&quot;, &quot;Suspend Location State&quot;),
</a><a href="#h12-0-12" id="h12-0-12" class="d">-    PINNED_BEST_FRIEND(5, &quot;pinned_best_friend.txt&quot;, &quot;Pinned Best Friend&quot;);
</a><a href="#h12-0-13" id="h12-0-13" class="d">-
</a><a href="#h12-0-14" id="h12-0-14" class="d">-    fun resolve(context: Context): File = if (isDatabase) {
</a><a href="#h12-0-15" id="h12-0-15" class="d">-        context.getDatabasePath(fileName)
</a><a href="#h12-0-16" id="h12-0-16" class="d">-    } else {
</a><a href="#h12-0-17" id="h12-0-17" class="d">-        File(context.filesDir, fileName)
</a><a href="#h12-0-18" id="h12-0-18" class="d">-    }
</a><a href="#h12-0-19" id="h12-0-19" class="d">-
</a><a href="#h12-0-20" id="h12-0-20" class="d">-    companion object {
</a><a href="#h12-0-21" id="h12-0-21" class="d">-        fun fromValue(value: Int): BridgeFileType? {
</a><a href="#h12-0-22" id="h12-0-22" class="d">-            return entries.firstOrNull { it.value == value }
</a><a href="#h12-0-23" id="h12-0-23" class="d">-        }
</a><a href="#h12-0-24" id="h12-0-24" class="d">-    }
</a><a href="#h12-0-25" id="h12-0-25" class="d">-}</a><a href="#h12-0-26" id="h12-0-26" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h13" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/types/FileActionType.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/types/FileActionType.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/types/FileActionType.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/types/FileActionType.kt</a></b>
<a href="#h13-0" id="h13-0" class="h">@@ -1,5 +0,0 @@
</a><a href="#h13-0-0" id="h13-0-0" class="d">-package me.rhunk.snapenhance.common.bridge.types
</a><a href="#h13-0-1" id="h13-0-1" class="d">-
</a><a href="#h13-0-2" id="h13-0-2" class="d">-enum class FileActionType {
</a><a href="#h13-0-3" id="h13-0-3" class="d">-    CREATE_AND_READ, READ, WRITE, DELETE, EXISTS
</a><a href="#h13-0-4" id="h13-0-4" class="d">-}</a><a href="#h13-0-5" id="h13-0-5" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h14" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/types/LocalePair.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/types/LocalePair.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/types/LocalePair.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/types/LocalePair.kt</a></b>
<a href="#h14-0" id="h14-0" class="h">@@ -1,17 +0,0 @@
</a><a href="#h14-0-0" id="h14-0-0" class="d">-package me.rhunk.snapenhance.common.bridge.types
</a><a href="#h14-0-1" id="h14-0-1" class="d">-
</a><a href="#h14-0-2" id="h14-0-2" class="d">-import android.os.ParcelFileDescriptor
</a><a href="#h14-0-3" id="h14-0-3" class="d">-import java.util.Locale
</a><a href="#h14-0-4" id="h14-0-4" class="d">-
</a><a href="#h14-0-5" id="h14-0-5" class="d">-data class LocalePair(
</a><a href="#h14-0-6" id="h14-0-6" class="d">-    val locale: String,
</a><a href="#h14-0-7" id="h14-0-7" class="d">-    val content: ParcelFileDescriptor
</a><a href="#h14-0-8" id="h14-0-8" class="d">-) {
</a><a href="#h14-0-9" id="h14-0-9" class="d">-    fun getLocale(): Locale {
</a><a href="#h14-0-10" id="h14-0-10" class="d">-        if (locale.contains(&quot;_&quot;)) {
</a><a href="#h14-0-11" id="h14-0-11" class="d">-            val split = locale.split(&quot;_&quot;)
</a><a href="#h14-0-12" id="h14-0-12" class="d">-            return Locale(split[0], split[1])
</a><a href="#h14-0-13" id="h14-0-13" class="d">-        }
</a><a href="#h14-0-14" id="h14-0-14" class="d">-        return Locale(locale)
</a><a href="#h14-0-15" id="h14-0-15" class="d">-    }
</a><a href="#h14-0-16" id="h14-0-16" class="d">-}</a><a href="#h14-0-17" id="h14-0-17" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h15" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/wrapper/LocaleWrapper.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/wrapper/LocaleWrapper.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/wrapper/LocaleWrapper.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/wrapper/LocaleWrapper.kt</a></b>
<a href="#h15-0" id="h15-0" class="h">@@ -1,41 +1,22 @@
</a> package me.rhunk.snapenhance.common.bridge.wrapper
 
 import android.content.Context
<a href="#h15-0-3" id="h15-0-3" class="i">+import android.os.ParcelFileDescriptor
</a> import android.os.ParcelFileDescriptor.AutoCloseInputStream
 import com.google.gson.JsonObject
 import com.google.gson.JsonParser
<a href="#h15-0-7" id="h15-0-7" class="d">-import kotlinx.coroutines.CoroutineScope
</a><a href="#h15-0-8" id="h15-0-8" class="d">-import kotlinx.coroutines.Dispatchers
</a><a href="#h15-0-9" id="h15-0-9" class="d">-import me.rhunk.snapenhance.common.bridge.types.LocalePair
</a><a href="#h15-0-10" id="h15-0-10" class="i">+import me.rhunk.snapenhance.bridge.storage.FileHandleManager
</a><a href="#h15-0-11" id="h15-0-11" class="i">+import me.rhunk.snapenhance.common.bridge.FileHandleScope
</a> import me.rhunk.snapenhance.common.logger.AbstractLogger
<a href="#h15-0-13" id="h15-0-13" class="d">-import me.rhunk.snapenhance.common.util.ktx.toParcelFileDescriptor
</a> import java.util.Locale
 
 
<a href="#h15-0-17" id="h15-0-17" class="d">-class LocaleWrapper {
</a><a href="#h15-0-18" id="h15-0-18" class="i">+class LocaleWrapper(
</a><a href="#h15-0-19" id="h15-0-19" class="i">+    private val fileHandleManager: FileHandleManager
</a><a href="#h15-0-20" id="h15-0-20" class="i">+) {
</a>     companion object {
         const val DEFAULT_LOCALE = &quot;en_US&quot;
 
<a href="#h15-0-24" id="h15-0-24" class="d">-        fun fetchLocales(context: Context, locale: String = DEFAULT_LOCALE): List&lt;LocalePair&gt; {
</a><a href="#h15-0-25" id="h15-0-25" class="d">-            val coroutineScope = CoroutineScope(Dispatchers.IO)
</a><a href="#h15-0-26" id="h15-0-26" class="d">-            val locales = mutableListOf&lt;LocalePair&gt;().apply {
</a><a href="#h15-0-27" id="h15-0-27" class="d">-                add(LocalePair(DEFAULT_LOCALE, context.resources.assets.open(&quot;lang/$DEFAULT_LOCALE.json&quot;).toParcelFileDescriptor(coroutineScope)))
</a><a href="#h15-0-28" id="h15-0-28" class="d">-            }
</a><a href="#h15-0-29" id="h15-0-29" class="d">-
</a><a href="#h15-0-30" id="h15-0-30" class="d">-            if (locale == DEFAULT_LOCALE) return locales
</a><a href="#h15-0-31" id="h15-0-31" class="d">-
</a><a href="#h15-0-32" id="h15-0-32" class="d">-            val compatibleLocale = context.resources.assets.list(&quot;lang&quot;)?.firstOrNull { it.startsWith(locale) }?.substringBefore(&quot;.&quot;) ?: return locales
</a><a href="#h15-0-33" id="h15-0-33" class="d">-
</a><a href="#h15-0-34" id="h15-0-34" class="d">-            locales.add(
</a><a href="#h15-0-35" id="h15-0-35" class="d">-                LocalePair(
</a><a href="#h15-0-36" id="h15-0-36" class="d">-                    compatibleLocale,
</a><a href="#h15-0-37" id="h15-0-37" class="d">-                    context.resources.assets.open(&quot;lang/$compatibleLocale.json&quot;).toParcelFileDescriptor(coroutineScope)
</a><a href="#h15-0-38" id="h15-0-38" class="d">-                )
</a><a href="#h15-0-39" id="h15-0-39" class="d">-            )
</a><a href="#h15-0-40" id="h15-0-40" class="d">-
</a><a href="#h15-0-41" id="h15-0-41" class="d">-            return locales
</a><a href="#h15-0-42" id="h15-0-42" class="d">-        }
</a><a href="#h15-0-43" id="h15-0-43" class="d">-
</a>         fun fetchAvailableLocales(context: Context): List&lt;String&gt; {
             return context.resources.assets.list(&quot;lang&quot;)?.map { it.substringBefore(&quot;.&quot;) }?.sorted() ?: listOf(DEFAULT_LOCALE)
         }
<a href="#h15-1" id="h15-1" class="h">@@ -47,14 +28,23 @@ class LocaleWrapper {
</a> 
     lateinit var loadedLocale: Locale
 
<a href="#h15-1-3" id="h15-1-3" class="d">-    private fun load(localePair: LocalePair) {
</a><a href="#h15-1-4" id="h15-1-4" class="d">-        loadedLocale = localePair.getLocale()
</a><a href="#h15-1-5" id="h15-1-5" class="i">+    private fun load(locale: String, pfd: ParcelFileDescriptor) {
</a><a href="#h15-1-6" id="h15-1-6" class="i">+        loadedLocale = if (locale.contains(&quot;_&quot;)) {
</a><a href="#h15-1-7" id="h15-1-7" class="i">+            val split = locale.split(&quot;_&quot;)
</a><a href="#h15-1-8" id="h15-1-8" class="i">+            Locale(split[0], split[1])
</a><a href="#h15-1-9" id="h15-1-9" class="i">+        } else {
</a><a href="#h15-1-10" id="h15-1-10" class="i">+            Locale(locale)
</a><a href="#h15-1-11" id="h15-1-11" class="i">+        }
</a> 
<a href="#h15-1-13" id="h15-1-13" class="d">-        val translations = AutoCloseInputStream(localePair.content).use {
</a><a href="#h15-1-14" id="h15-1-14" class="d">-            JsonParser.parseReader(it.reader()).asJsonObject
</a><a href="#h15-1-15" id="h15-1-15" class="i">+        val translations = AutoCloseInputStream(pfd).use {
</a><a href="#h15-1-16" id="h15-1-16" class="i">+            runCatching {
</a><a href="#h15-1-17" id="h15-1-17" class="i">+                JsonParser.parseReader(it.reader()).asJsonObject
</a><a href="#h15-1-18" id="h15-1-18" class="i">+            }.onFailure {
</a><a href="#h15-1-19" id="h15-1-19" class="i">+                AbstractLogger.directError(&quot;Failed to parse locale file: ${it.message}&quot;, it)
</a><a href="#h15-1-20" id="h15-1-20" class="i">+            }.getOrNull()
</a>         }
         if (translations == null || translations.isJsonNull) {
<a href="#h15-1-23" id="h15-1-23" class="d">-            return
</a><a href="#h15-1-24" id="h15-1-24" class="i">+            throw IllegalStateException(&quot;Failed to parse $locale.json&quot;)
</a>         }
 
         fun scanObject(jsonObject: JsonObject, prefix: String = &quot;&quot;) {
<a href="#h15-2" id="h15-2" class="h">@@ -71,22 +61,25 @@ class LocaleWrapper {
</a>         scanObject(translations)
     }
 
<a href="#h15-2-3" id="h15-2-3" class="d">-    fun loadFromCallback(callback: (String) -&gt; List&lt;LocalePair&gt;) {
</a><a href="#h15-2-4" id="h15-2-4" class="d">-        callback(userLocale).forEach {
</a><a href="#h15-2-5" id="h15-2-5" class="d">-            load(it)
</a><a href="#h15-2-6" id="h15-2-6" class="d">-        }
</a><a href="#h15-2-7" id="h15-2-7" class="d">-    }
</a><a href="#h15-2-8" id="h15-2-8" class="i">+    fun load() {
</a><a href="#h15-2-9" id="h15-2-9" class="i">+        load(
</a><a href="#h15-2-10" id="h15-2-10" class="i">+            DEFAULT_LOCALE,
</a><a href="#h15-2-11" id="h15-2-11" class="i">+            fileHandleManager.getFileHandle(FileHandleScope.LOCALE.key, &quot;$DEFAULT_LOCALE.json&quot;)?.open(ParcelFileDescriptor.MODE_READ_ONLY) ?: run {
</a><a href="#h15-2-12" id="h15-2-12" class="i">+                throw IllegalStateException(&quot;Failed to load default locale&quot;)
</a><a href="#h15-2-13" id="h15-2-13" class="i">+            }
</a><a href="#h15-2-14" id="h15-2-14" class="i">+        )
</a> 
<a href="#h15-2-16" id="h15-2-16" class="d">-    fun loadFromContext(context: Context) {
</a><a href="#h15-2-17" id="h15-2-17" class="d">-        fetchLocales(context, userLocale).forEach {
</a><a href="#h15-2-18" id="h15-2-18" class="d">-            load(it)
</a><a href="#h15-2-19" id="h15-2-19" class="i">+        if (userLocale != DEFAULT_LOCALE) {
</a><a href="#h15-2-20" id="h15-2-20" class="i">+            fileHandleManager.getFileHandle(FileHandleScope.LOCALE.key, &quot;$userLocale.json&quot;)?.open(ParcelFileDescriptor.MODE_READ_ONLY)?.let {
</a><a href="#h15-2-21" id="h15-2-21" class="i">+                load(userLocale, it)
</a><a href="#h15-2-22" id="h15-2-22" class="i">+            }
</a>         }
     }
 
<a href="#h15-2-26" id="h15-2-26" class="d">-    fun reloadFromContext(context: Context, locale: String) {
</a><a href="#h15-2-27" id="h15-2-27" class="i">+    fun reload(locale: String) {
</a>         userLocale = locale
         translationMap.clear()
<a href="#h15-2-30" id="h15-2-30" class="d">-        loadFromContext(context)
</a><a href="#h15-2-31" id="h15-2-31" class="i">+        load()
</a>     }
 
     operator fun get(key: String) = translationMap[key] ?: key.also { AbstractLogger.directDebug(&quot;Missing translation for $key&quot;) }
<a href="#h15-3" id="h15-3" class="h">@@ -99,7 +92,7 @@ class LocaleWrapper {
</a>     }
 
     fun getCategory(key: String): LocaleWrapper {
<a href="#h15-3-3" id="h15-3-3" class="d">-        return LocaleWrapper().apply {
</a><a href="#h15-3-4" id="h15-3-4" class="i">+        return LocaleWrapper(fileHandleManager).apply {
</a>             translationMap.putAll(
                 this@LocaleWrapper.translationMap
                     .filterKeys { it.startsWith(&quot;$key.&quot;) }
<b>diff --git a/<a id="h16" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/wrapper/LoggerWrapper.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/wrapper/LoggerWrapper.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/wrapper/LoggerWrapper.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/wrapper/LoggerWrapper.kt</a></b>
<a href="#h16-0" id="h16-0" class="h">@@ -1,11 +1,13 @@
</a> package me.rhunk.snapenhance.common.bridge.wrapper
 
 import android.content.ContentValues
<a href="#h16-0-3" id="h16-0-3" class="i">+import android.content.Context
</a> import android.database.sqlite.SQLiteDatabase
 import com.google.gson.GsonBuilder
 import com.google.gson.JsonObject
 import kotlinx.coroutines.*
 import me.rhunk.snapenhance.bridge.logger.LoggerInterface
<a href="#h16-0-9" id="h16-0-9" class="i">+import me.rhunk.snapenhance.common.bridge.InternalFileHandleType
</a> import me.rhunk.snapenhance.common.data.StoryData
 import me.rhunk.snapenhance.common.logger.AbstractLogger
 import me.rhunk.snapenhance.common.util.SQLiteDatabaseHelper
<a href="#h16-1" id="h16-1" class="h">@@ -61,6 +63,8 @@ class TrackerLog(
</a> class LoggerWrapper(
     val databaseFile: File
 ): LoggerInterface.Stub() {
<a href="#h16-1-3" id="h16-1-3" class="i">+    constructor(context: Context): this(File(context.getDatabasePath(InternalFileHandleType.MESSAGE_LOGGER.fileName).absolutePath))
</a><a href="#h16-1-4" id="h16-1-4" class="i">+
</a>     private var _database: SQLiteDatabase? = null
     @OptIn(ExperimentalCoroutinesApi::class)
     private val coroutineScope = CoroutineScope(Dispatchers.IO.limitedParallelism(1))
<b>diff --git a/<a id="h17" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/wrapper/MappingsWrapper.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/wrapper/MappingsWrapper.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/wrapper/MappingsWrapper.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/wrapper/MappingsWrapper.kt</a></b>
<a href="#h17-0" id="h17-0" class="h">@@ -3,16 +3,19 @@ package me.rhunk.snapenhance.common.bridge.wrapper
</a> import android.content.Context
 import com.google.gson.JsonParser
 import kotlinx.coroutines.runBlocking
<a href="#h17-0-3" id="h17-0-3" class="i">+import me.rhunk.snapenhance.bridge.storage.FileHandleManager
</a> import me.rhunk.snapenhance.common.BuildConfig
 import me.rhunk.snapenhance.common.Constants
<a href="#h17-0-6" id="h17-0-6" class="d">-import me.rhunk.snapenhance.common.bridge.FileLoaderWrapper
</a><a href="#h17-0-7" id="h17-0-7" class="d">-import me.rhunk.snapenhance.common.bridge.types.BridgeFileType
</a><a href="#h17-0-8" id="h17-0-8" class="i">+import me.rhunk.snapenhance.common.bridge.InternalFileHandleType
</a><a href="#h17-0-9" id="h17-0-9" class="i">+import me.rhunk.snapenhance.common.bridge.InternalFileWrapper
</a> import me.rhunk.snapenhance.common.logger.AbstractLogger
 import me.rhunk.snapenhance.mapper.AbstractClassMapper
 import me.rhunk.snapenhance.mapper.ClassMapper
 import kotlin.reflect.KClass
 
<a href="#h17-0-15" id="h17-0-15" class="d">-class MappingsWrapper : FileLoaderWrapper(BridgeFileType.MAPPINGS, &quot;{}&quot;.toByteArray(Charsets.UTF_8)) {
</a><a href="#h17-0-16" id="h17-0-16" class="i">+class MappingsWrapper(
</a><a href="#h17-0-17" id="h17-0-17" class="i">+    fileHandleManager: FileHandleManager
</a><a href="#h17-0-18" id="h17-0-18" class="i">+): InternalFileWrapper(fileHandleManager, InternalFileHandleType.MAPPINGS, defaultValue = &quot;{}&quot;) {
</a>     private lateinit var context: Context
     private var mappingUniqueHash: Long = 0
     var isMappingsLoaded = false
<a href="#h17-1" id="h17-1" class="h">@@ -26,7 +29,7 @@ class MappingsWrapper : FileLoaderWrapper(BridgeFileType.MAPPINGS, &quot;{}&quot;.toByteAr
</a>         this.context = context
         mappingUniqueHash = getUniqueBuildId()
 
<a href="#h17-1-3" id="h17-1-3" class="d">-        if (isFileExists()) {
</a><a href="#h17-1-4" id="h17-1-4" class="i">+        if (exists()) {
</a>             runCatching {
                 loadCached()
             }.onFailure {
<a href="#h17-2" id="h17-2" class="h">@@ -46,10 +49,10 @@ class MappingsWrapper : FileLoaderWrapper(BridgeFileType.MAPPINGS, &quot;{}&quot;.toByteAr
</a>     fun isMappingsOutdated() = mappingUniqueHash != getUniqueBuildId() || isMappingsLoaded.not()
 
     private fun loadCached() {
<a href="#h17-2-3" id="h17-2-3" class="d">-        if (!isFileExists()) {
</a><a href="#h17-2-4" id="h17-2-4" class="i">+        if (!exists()) {
</a>             throw Exception(&quot;Mappings file does not exist&quot;)
         }
<a href="#h17-2-7" id="h17-2-7" class="d">-        val mappingsObject = JsonParser.parseString(read().toString(Charsets.UTF_8)).asJsonObject.also {
</a><a href="#h17-2-8" id="h17-2-8" class="i">+        val mappingsObject = JsonParser.parseString(readBytes().toString(Charsets.UTF_8)).asJsonObject.also {
</a>             mappingUniqueHash = it[&quot;unique_hash&quot;].asLong
         }
 
<a href="#h17-3" id="h17-3" class="h">@@ -76,7 +79,7 @@ class MappingsWrapper : FileLoaderWrapper(BridgeFileType.MAPPINGS, &quot;{}&quot;.toByteAr
</a>             val result = classMapper.run().apply {
                 addProperty(&quot;unique_hash&quot;, mappingUniqueHash)
             }
<a href="#h17-3-3" id="h17-3-3" class="d">-            write(result.toString().toByteArray())
</a><a href="#h17-3-4" id="h17-3-4" class="i">+            writeBytes(result.toString().toByteArray())
</a>         }
     }
 
<b>diff --git a/<a id="h18" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/config/ModConfig.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/config/ModConfig.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/config/ModConfig.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/config/ModConfig.kt</a></b>
<a href="#h18-0" id="h18-0" class="h">@@ -5,20 +5,22 @@ import com.google.gson.Gson
</a> import com.google.gson.GsonBuilder
 import com.google.gson.JsonObject
 import me.rhunk.snapenhance.bridge.ConfigStateListener
<a href="#h18-0-3" id="h18-0-3" class="d">-import me.rhunk.snapenhance.common.bridge.FileLoaderWrapper
</a><a href="#h18-0-4" id="h18-0-4" class="d">-import me.rhunk.snapenhance.common.bridge.types.BridgeFileType
</a><a href="#h18-0-5" id="h18-0-5" class="i">+import me.rhunk.snapenhance.bridge.storage.FileHandleManager
</a><a href="#h18-0-6" id="h18-0-6" class="i">+import me.rhunk.snapenhance.common.bridge.InternalFileHandleType
</a><a href="#h18-0-7" id="h18-0-7" class="i">+import me.rhunk.snapenhance.common.bridge.InternalFileWrapper
</a> import me.rhunk.snapenhance.common.bridge.wrapper.LocaleWrapper
 import me.rhunk.snapenhance.common.config.impl.RootConfig
 import me.rhunk.snapenhance.common.logger.AbstractLogger
 import kotlin.properties.Delegates
 
 class ModConfig(
<a href="#h18-0-14" id="h18-0-14" class="d">-    private val context: Context
</a><a href="#h18-0-15" id="h18-0-15" class="i">+    private val context: Context,
</a><a href="#h18-0-16" id="h18-0-16" class="i">+    fileHandleManager: FileHandleManager
</a> ) {
<a href="#h18-0-18" id="h18-0-18" class="i">+    private val fileWrapper = InternalFileWrapper(fileHandleManager, InternalFileHandleType.CONFIG, &quot;{}&quot;)
</a>     var locale: String = LocaleWrapper.DEFAULT_LOCALE
 
     private val gson: Gson = GsonBuilder().setPrettyPrinting().create()
<a href="#h18-0-22" id="h18-0-22" class="d">-    private val file = FileLoaderWrapper(BridgeFileType.CONFIG, &quot;{}&quot;.toByteArray(Charsets.UTF_8))
</a>     var wasPresent by Delegates.notNull&lt;Boolean&gt;()
 
     /* Used to notify the bridge client about config changes */
<a href="#h18-1" id="h18-1" class="h">@@ -30,9 +32,9 @@ class ModConfig(
</a> 
     private fun createRootConfig() = RootConfig().apply { lateInit(context) }
 
<a href="#h18-1-3" id="h18-1-3" class="d">-    private fun load() {
</a><a href="#h18-1-4" id="h18-1-4" class="i">+    fun load() {
</a>         root = createRootConfig()
<a href="#h18-1-6" id="h18-1-6" class="d">-        wasPresent = file.isFileExists()
</a><a href="#h18-1-7" id="h18-1-7" class="i">+        wasPresent = fileWrapper.exists()
</a>         if (!wasPresent) {
             writeConfig()
             return
<a href="#h18-2" id="h18-2" class="h">@@ -46,7 +48,7 @@ class ModConfig(
</a>     }
 
     private fun loadConfig() {
<a href="#h18-2-3" id="h18-2-3" class="d">-        val configFileContent = file.read()
</a><a href="#h18-2-4" id="h18-2-4" class="i">+        val configFileContent = fileWrapper.readBytes()
</a>         val configObject = gson.fromJson(configFileContent.toString(Charsets.UTF_8), JsonObject::class.java)
         locale = configObject.get(&quot;_locale&quot;)?.asString ?: LocaleWrapper.DEFAULT_LOCALE
         root.fromJson(configObject)
<a href="#h18-3" id="h18-3" class="h">@@ -99,8 +101,8 @@ class ModConfig(
</a>             }
         }
 
<a href="#h18-3-3" id="h18-3-3" class="d">-        val oldConfig = runCatching { file.read().toString(Charsets.UTF_8) }.getOrNull()
</a><a href="#h18-3-4" id="h18-3-4" class="d">-        file.write(exportToString().toByteArray(Charsets.UTF_8))
</a><a href="#h18-3-5" id="h18-3-5" class="i">+        val oldConfig = runCatching { fileWrapper.readBytes().toString(Charsets.UTF_8) }.getOrNull()
</a><a href="#h18-3-6" id="h18-3-6" class="i">+        fileWrapper.writeBytes(exportToString().toByteArray(Charsets.UTF_8))
</a> 
         configStateListener?.also {
             runCatching {
<a href="#h18-4" id="h18-4" class="h">@@ -125,14 +127,4 @@ class ModConfig(
</a>         root.fromJson(configObject)
         writeConfig()
     }
<a href="#h18-4-3" id="h18-4-3" class="d">-
</a><a href="#h18-4-4" id="h18-4-4" class="d">-    fun loadFromContext(context: Context) {
</a><a href="#h18-4-5" id="h18-4-5" class="d">-        file.loadFromContext(context)
</a><a href="#h18-4-6" id="h18-4-6" class="d">-        load()
</a><a href="#h18-4-7" id="h18-4-7" class="d">-    }
</a><a href="#h18-4-8" id="h18-4-8" class="d">-
</a><a href="#h18-4-9" id="h18-4-9" class="d">-    fun loadFromCallback(callback: (FileLoaderWrapper) -&gt; Unit) {
</a><a href="#h18-4-10" id="h18-4-10" class="d">-        callback(file)
</a><a href="#h18-4-11" id="h18-4-11" class="d">-        load()
</a><a href="#h18-4-12" id="h18-4-12" class="d">-    }
</a> } 
\ No newline at end of file
<b>diff --git a/<a id="h19" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/ModContext.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/ModContext.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/ModContext.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/ModContext.kt</a></b>
<a href="#h19-0" id="h19-0" class="h">@@ -19,7 +19,6 @@ import me.rhunk.snapenhance.common.bridge.wrapper.MappingsWrapper
</a> import me.rhunk.snapenhance.common.config.ModConfig
 import me.rhunk.snapenhance.core.action.ActionManager
 import me.rhunk.snapenhance.core.bridge.BridgeClient
<a href="#h19-0-3" id="h19-0-3" class="d">-import me.rhunk.snapenhance.core.bridge.loadFromBridge
</a> import me.rhunk.snapenhance.core.database.DatabaseAccess
 import me.rhunk.snapenhance.core.event.EventBus
 import me.rhunk.snapenhance.core.event.EventDispatcher
<a href="#h19-1" id="h19-1" class="h">@@ -48,15 +47,15 @@ class ModContext(
</a>     val resources: Resources get() = androidContext.resources
     val gson: Gson = GsonBuilder().create()
 
<a href="#h19-1-3" id="h19-1-3" class="d">-    private val _config = ModConfig(androidContext)
</a><a href="#h19-1-4" id="h19-1-4" class="d">-    val config by _config::root
</a><a href="#h19-1-5" id="h19-1-5" class="i">+    private val _config by lazy { ModConfig(androidContext, bridgeClient.getFileHandlerManager()) }
</a><a href="#h19-1-6" id="h19-1-6" class="i">+    val config get() = _config.root
</a>     val log by lazy { CoreLogger(this.bridgeClient) }
<a href="#h19-1-8" id="h19-1-8" class="d">-    val translation = LocaleWrapper()
</a><a href="#h19-1-9" id="h19-1-9" class="i">+    val translation by lazy { LocaleWrapper(bridgeClient.getFileHandlerManager()) }
</a>     val httpServer = HttpServer()
     val messageSender = MessageSender(this)
 
     val features = FeatureManager(this)
<a href="#h19-1-14" id="h19-1-14" class="d">-    val mappings = MappingsWrapper()
</a><a href="#h19-1-15" id="h19-1-15" class="i">+    val mappings by lazy { MappingsWrapper(bridgeClient.getFileHandlerManager()) }
</a>     val actionManager = ActionManager(this)
     val database = DatabaseAccess(this)
     val event = EventBus(this)
<a href="#h19-2" id="h19-2" class="h">@@ -144,9 +143,7 @@ class ModContext(
</a> 
     fun reloadConfig() {
         log.verbose(&quot;reloading config&quot;)
<a href="#h19-2-3" id="h19-2-3" class="d">-        _config.loadFromCallback { file -&gt;
</a><a href="#h19-2-4" id="h19-2-4" class="d">-            file.loadFromBridge(bridgeClient)
</a><a href="#h19-2-5" id="h19-2-5" class="d">-        }
</a><a href="#h19-2-6" id="h19-2-6" class="i">+        _config.load()
</a>         reloadNativeConfig()
     }
 
<b>diff --git a/<a id="h20" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/SnapEnhance.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/SnapEnhance.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/SnapEnhance.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/SnapEnhance.kt</a></b>
<a href="#h20-0" id="h20-0" class="h">@@ -19,7 +19,6 @@ import me.rhunk.snapenhance.common.data.MessagingFriendInfo
</a> import me.rhunk.snapenhance.common.data.MessagingGroupInfo
 import me.rhunk.snapenhance.common.util.toSerialized
 import me.rhunk.snapenhance.core.bridge.BridgeClient
<a href="#h20-0-3" id="h20-0-3" class="d">-import me.rhunk.snapenhance.core.bridge.loadFromBridge
</a> import me.rhunk.snapenhance.core.data.SnapClassCache
 import me.rhunk.snapenhance.core.event.events.impl.NativeUnaryCallEvent
 import me.rhunk.snapenhance.core.event.events.impl.SnapWidgetBroadcastReceiveEvent
<a href="#h20-1" id="h20-1" class="h">@@ -148,12 +147,9 @@ class SnapEnhance {
</a>                     log.error(&quot;Failed to sync remote&quot;, it)
                 }
                 translation.userLocale = getConfigLocale()
<a href="#h20-1-3" id="h20-1-3" class="d">-                translation.loadFromCallback { locale -&gt;
</a><a href="#h20-1-4" id="h20-1-4" class="d">-                    bridgeClient.fetchLocales(locale)
</a><a href="#h20-1-5" id="h20-1-5" class="d">-                }
</a><a href="#h20-1-6" id="h20-1-6" class="i">+                translation.load()
</a>             }
 
<a href="#h20-1-9" id="h20-1-9" class="d">-            mappings.loadFromBridge(bridgeClient)
</a>             mappings.init(androidContext)
             database.init()
             eventDispatcher.init()
<b>diff --git a/<a id="h21" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/BridgeClient.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/BridgeClient.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/BridgeClient.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/BridgeClient.kt</a></b>
<a href="#h21-0" id="h21-0" class="h">@@ -18,11 +18,8 @@ import me.rhunk.snapenhance.bridge.logger.LoggerInterface
</a> import me.rhunk.snapenhance.bridge.logger.TrackerInterface
 import me.rhunk.snapenhance.bridge.scripting.IScripting
 import me.rhunk.snapenhance.bridge.snapclient.MessagingBridge
<a href="#h21-0-3" id="h21-0-3" class="i">+import me.rhunk.snapenhance.bridge.storage.FileHandleManager
</a> import me.rhunk.snapenhance.common.Constants
<a href="#h21-0-5" id="h21-0-5" class="d">-import me.rhunk.snapenhance.common.bridge.FileLoaderWrapper
</a><a href="#h21-0-6" id="h21-0-6" class="d">-import me.rhunk.snapenhance.common.bridge.types.BridgeFileType
</a><a href="#h21-0-7" id="h21-0-7" class="d">-import me.rhunk.snapenhance.common.bridge.types.FileActionType
</a><a href="#h21-0-8" id="h21-0-8" class="d">-import me.rhunk.snapenhance.common.bridge.types.LocalePair
</a> import me.rhunk.snapenhance.common.data.MessagingFriendInfo
 import me.rhunk.snapenhance.common.data.MessagingGroupInfo
 import me.rhunk.snapenhance.common.data.MessagingRuleType
<a href="#h21-1" id="h21-1" class="h">@@ -34,14 +31,6 @@ import java.util.concurrent.Executors
</a> import java.util.concurrent.TimeUnit
 import kotlin.system.exitProcess
 
<a href="#h21-1-3" id="h21-1-3" class="d">-fun FileLoaderWrapper.loadFromBridge(bridgeClient: BridgeClient) {
</a><a href="#h21-1-4" id="h21-1-4" class="d">-    isFileExists = { bridgeClient.isFileExists(fileType) }
</a><a href="#h21-1-5" id="h21-1-5" class="d">-    read = { bridgeClient.createAndReadFile(fileType, defaultContent) }
</a><a href="#h21-1-6" id="h21-1-6" class="d">-    write = { bridgeClient.writeFile(fileType, it) }
</a><a href="#h21-1-7" id="h21-1-7" class="d">-    delete = { bridgeClient.deleteFile(fileType) }
</a><a href="#h21-1-8" id="h21-1-8" class="d">-}
</a><a href="#h21-1-9" id="h21-1-9" class="d">-
</a><a href="#h21-1-10" id="h21-1-10" class="d">-
</a> class BridgeClient(
     private val context: ModContext
 ):  ServiceConnection {
<a href="#h21-2" id="h21-2" class="h">@@ -125,39 +114,6 @@ class BridgeClient(
</a>         }
     }
 
<a href="#h21-2-3" id="h21-2-3" class="d">-    //TODO: use interfaces instead of direct file access
</a><a href="#h21-2-4" id="h21-2-4" class="d">-    fun createAndReadFile(
</a><a href="#h21-2-5" id="h21-2-5" class="d">-        fileType: BridgeFileType,
</a><a href="#h21-2-6" id="h21-2-6" class="d">-        defaultContent: ByteArray
</a><a href="#h21-2-7" id="h21-2-7" class="d">-    ): ByteArray = safeServiceCall {
</a><a href="#h21-2-8" id="h21-2-8" class="d">-        service.fileOperation(FileActionType.CREATE_AND_READ.ordinal, fileType.value, defaultContent)
</a><a href="#h21-2-9" id="h21-2-9" class="d">-    }
</a><a href="#h21-2-10" id="h21-2-10" class="d">-
</a><a href="#h21-2-11" id="h21-2-11" class="d">-    fun readFile(fileType: BridgeFileType): ByteArray = safeServiceCall { service.fileOperation(FileActionType.READ.ordinal, fileType.value, null) }
</a><a href="#h21-2-12" id="h21-2-12" class="d">-
</a><a href="#h21-2-13" id="h21-2-13" class="d">-    fun writeFile(
</a><a href="#h21-2-14" id="h21-2-14" class="d">-        fileType: BridgeFileType,
</a><a href="#h21-2-15" id="h21-2-15" class="d">-        content: ByteArray?
</a><a href="#h21-2-16" id="h21-2-16" class="d">-    ): ByteArray = safeServiceCall {
</a><a href="#h21-2-17" id="h21-2-17" class="d">-        service.fileOperation(FileActionType.WRITE.ordinal, fileType.value, content)
</a><a href="#h21-2-18" id="h21-2-18" class="d">-    }
</a><a href="#h21-2-19" id="h21-2-19" class="d">-
</a><a href="#h21-2-20" id="h21-2-20" class="d">-    fun deleteFile(fileType: BridgeFileType) {
</a><a href="#h21-2-21" id="h21-2-21" class="d">-        safeServiceCall {
</a><a href="#h21-2-22" id="h21-2-22" class="d">-            service.fileOperation(FileActionType.DELETE.ordinal, fileType.value, null)
</a><a href="#h21-2-23" id="h21-2-23" class="d">-        }
</a><a href="#h21-2-24" id="h21-2-24" class="d">-    }
</a><a href="#h21-2-25" id="h21-2-25" class="d">-
</a><a href="#h21-2-26" id="h21-2-26" class="d">-    fun isFileExists(fileType: BridgeFileType) = safeServiceCall {
</a><a href="#h21-2-27" id="h21-2-27" class="d">-        service.fileOperation(FileActionType.EXISTS.ordinal, fileType.value, null).isNotEmpty()
</a><a href="#h21-2-28" id="h21-2-28" class="d">-    }
</a><a href="#h21-2-29" id="h21-2-29" class="d">-
</a><a href="#h21-2-30" id="h21-2-30" class="d">-    fun fetchLocales(userLocale: String) = safeServiceCall {
</a><a href="#h21-2-31" id="h21-2-31" class="d">-        service.fetchLocales(userLocale).map {
</a><a href="#h21-2-32" id="h21-2-32" class="d">-            LocalePair(it.key, it.value)
</a><a href="#h21-2-33" id="h21-2-33" class="d">-        }
</a><a href="#h21-2-34" id="h21-2-34" class="d">-    }
</a><a href="#h21-2-35" id="h21-2-35" class="d">-
</a>     fun getApplicationApkPath(): String = safeServiceCall { service.applicationApkPath }
 
     fun enqueueDownload(intent: Intent, callback: DownloadCallback) = safeServiceCall {
<a href="#h21-3" id="h21-3" class="h">@@ -215,6 +171,8 @@ class BridgeClient(
</a> 
     fun getAccountStorage(): AccountStorage = safeServiceCall { service.accountStorage }
 
<a href="#h21-3-3" id="h21-3-3" class="i">+    fun getFileHandlerManager(): FileHandleManager = safeServiceCall { service.fileHandleManager }
</a><a href="#h21-3-4" id="h21-3-4" class="i">+
</a>     fun registerMessagingBridge(bridge: MessagingBridge) = safeServiceCall { service.registerMessagingBridge(bridge) }
 
     fun openSettingsOverlay() = safeServiceCall { service.openSettingsOverlay() }
<b>diff --git a/<a id="h22" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/BridgeFileFeature.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/BridgeFileFeature.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/BridgeFileFeature.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/BridgeFileFeature.kt</a></b>
<a href="#h22-0" id="h22-0" class="h">@@ -1,32 +1,38 @@
</a> package me.rhunk.snapenhance.core.features
 
<a href="#h22-0-2" id="h22-0-2" class="d">-import me.rhunk.snapenhance.common.bridge.types.BridgeFileType
</a><a href="#h22-0-3" id="h22-0-3" class="i">+import me.rhunk.snapenhance.common.bridge.FileHandleScope
</a><a href="#h22-0-4" id="h22-0-4" class="i">+import me.rhunk.snapenhance.common.bridge.InternalFileHandleType
</a><a href="#h22-0-5" id="h22-0-5" class="i">+import me.rhunk.snapenhance.common.bridge.toWrapper
</a> import java.io.BufferedReader
<a href="#h22-0-7" id="h22-0-7" class="d">-import java.io.ByteArrayInputStream
</a> import java.io.InputStreamReader
 import java.nio.charset.StandardCharsets
 
<a href="#h22-0-11" id="h22-0-11" class="d">-abstract class BridgeFileFeature(name: String, private val bridgeFileType: BridgeFileType, loadParams: Int) : Feature(name, loadParams) {
</a><a href="#h22-0-12" id="h22-0-12" class="i">+abstract class BridgeFileFeature(name: String, private val bridgeFileType: InternalFileHandleType, loadParams: Int) : Feature(name, loadParams) {
</a>     private val fileLines = mutableListOf&lt;String&gt;()
<a href="#h22-0-14" id="h22-0-14" class="i">+    private val fileWrapper by lazy { context.bridgeClient.getFileHandlerManager().getFileHandle(FileHandleScope.INTERNAL.key, bridgeFileType.key)!!.toWrapper() }
</a> 
     protected fun readFile() {
         val temporaryLines = mutableListOf&lt;String&gt;()
<a href="#h22-0-18" id="h22-0-18" class="d">-        val fileData: ByteArray = context.bridgeClient.createAndReadFile(bridgeFileType, ByteArray(0))
</a><a href="#h22-0-19" id="h22-0-19" class="d">-        with(BufferedReader(InputStreamReader(ByteArrayInputStream(fileData), StandardCharsets.UTF_8))) {
</a><a href="#h22-0-20" id="h22-0-20" class="d">-            var line = &quot;&quot;
</a><a href="#h22-0-21" id="h22-0-21" class="d">-            while (readLine()?.also { line = it } != null) temporaryLines.add(line)
</a><a href="#h22-0-22" id="h22-0-22" class="d">-            close()
</a><a href="#h22-0-23" id="h22-0-23" class="i">+        fileWrapper.inputStream { stream -&gt;
</a><a href="#h22-0-24" id="h22-0-24" class="i">+            with(BufferedReader(InputStreamReader(stream, StandardCharsets.UTF_8))) {
</a><a href="#h22-0-25" id="h22-0-25" class="i">+                var line = &quot;&quot;
</a><a href="#h22-0-26" id="h22-0-26" class="i">+                while (readLine()?.also { line = it } != null) temporaryLines.add(line)
</a><a href="#h22-0-27" id="h22-0-27" class="i">+                close()
</a><a href="#h22-0-28" id="h22-0-28" class="i">+            }
</a>         }
<a href="#h22-0-30" id="h22-0-30" class="i">+
</a>         fileLines.clear()
         fileLines.addAll(temporaryLines)
     }
 
     private fun updateFile() {
<a href="#h22-0-36" id="h22-0-36" class="d">-        val sb = StringBuilder()
</a><a href="#h22-0-37" id="h22-0-37" class="d">-        fileLines.forEach {
</a><a href="#h22-0-38" id="h22-0-38" class="d">-            sb.append(it).append(&quot;\n&quot;)
</a><a href="#h22-0-39" id="h22-0-39" class="i">+        fileWrapper.outputStream { stream -&gt;
</a><a href="#h22-0-40" id="h22-0-40" class="i">+            fileLines.forEach {
</a><a href="#h22-0-41" id="h22-0-41" class="i">+                stream.write(it.toByteArray())
</a><a href="#h22-0-42" id="h22-0-42" class="i">+                stream.write(&quot;\n&quot;.toByteArray())
</a><a href="#h22-0-43" id="h22-0-43" class="i">+                stream.flush()
</a><a href="#h22-0-44" id="h22-0-44" class="i">+            }
</a>         }
<a href="#h22-0-46" id="h22-0-46" class="d">-        context.bridgeClient.writeFile(bridgeFileType, sb.toString().toByteArray(Charsets.UTF_8))
</a>     }
 
     protected fun exists(line: String) = fileLines.contains(line)
<b>diff --git a/<a id="h23" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/BestFriendPinning.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/BestFriendPinning.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/BestFriendPinning.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/BestFriendPinning.kt</a></b>
<a href="#h23-0" id="h23-0" class="h">@@ -7,7 +7,7 @@ import com.google.gson.JsonObject
</a> import kotlinx.coroutines.Dispatchers
 import kotlinx.coroutines.delay
 import kotlinx.coroutines.launch
<a href="#h23-0-3" id="h23-0-3" class="d">-import me.rhunk.snapenhance.common.bridge.types.BridgeFileType
</a><a href="#h23-0-4" id="h23-0-4" class="i">+import me.rhunk.snapenhance.common.bridge.InternalFileHandleType
</a> import me.rhunk.snapenhance.common.util.protobuf.ProtoReader
 import me.rhunk.snapenhance.core.event.events.impl.NetworkApiRequestEvent
 import me.rhunk.snapenhance.core.event.events.impl.UnaryCallEvent
<a href="#h23-1" id="h23-1" class="h">@@ -18,7 +18,7 @@ import java.io.InputStreamReader
</a> import java.nio.ByteBuffer
 import java.util.UUID
 
<a href="#h23-1-3" id="h23-1-3" class="d">-class BestFriendPinning: BridgeFileFeature(&quot;Best Friend Pinning&quot;, BridgeFileType.PINNED_BEST_FRIEND, loadParams = FeatureLoadParams.INIT_SYNC) {
</a><a href="#h23-1-4" id="h23-1-4" class="i">+class BestFriendPinning: BridgeFileFeature(&quot;Best Friend Pinning&quot;, InternalFileHandleType.PINNED_BEST_FRIEND, loadParams = FeatureLoadParams.INIT_SYNC) {
</a>     private fun updatePinnedBestFriendStatus() {
         lines().firstOrNull()?.trim()?.let {
             context.database.updatePinnedBestFriendStatus(it.substring(0, 36), &quot;number_one_bf_for_two_months&quot;)
<b>diff --git a/<a id="h24" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/SuspendLocationUpdates.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/SuspendLocationUpdates.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/SuspendLocationUpdates.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/SuspendLocationUpdates.kt</a></b>
<a href="#h24-0" id="h24-0" class="h">@@ -2,7 +2,7 @@ package me.rhunk.snapenhance.core.features.impl.global
</a> 
 import android.view.ViewGroup
 import android.widget.Switch
<a href="#h24-0-3" id="h24-0-3" class="d">-import me.rhunk.snapenhance.common.bridge.types.BridgeFileType
</a><a href="#h24-0-4" id="h24-0-4" class="i">+import me.rhunk.snapenhance.common.bridge.InternalFileHandleType
</a> import me.rhunk.snapenhance.core.event.events.impl.LayoutInflateEvent
 import me.rhunk.snapenhance.core.features.BridgeFileFeature
 import me.rhunk.snapenhance.core.features.FeatureLoadParams
<a href="#h24-1" id="h24-1" class="h">@@ -12,7 +12,7 @@ import me.rhunk.snapenhance.core.util.ktx.getLayoutId
</a> 
 class SuspendLocationUpdates : BridgeFileFeature(
     &quot;Suspend Location Updates&quot;,
<a href="#h24-1-3" id="h24-1-3" class="d">-    loadParams = FeatureLoadParams.ACTIVITY_CREATE_SYNC, bridgeFileType = BridgeFileType.SUSPEND_LOCATION_STATE) {
</a><a href="#h24-1-4" id="h24-1-4" class="i">+    loadParams = FeatureLoadParams.ACTIVITY_CREATE_SYNC, bridgeFileType = InternalFileHandleType.SUSPEND_LOCATION_STATE) {
</a>     fun isSuspended() = exists(&quot;true&quot;)
     private fun setSuspended(suspended: Boolean) = setState(&quot;true&quot;, suspended)
 
</pre>
</div>
</body>
</html>
