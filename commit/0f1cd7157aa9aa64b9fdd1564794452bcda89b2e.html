<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>feat: randomize package name - SnapEnhance - An Xposed module offering an enhanced Snapchat experience
</title>
<link rel="icon" type="image/svg+xml" href="../../logo.png"/>
<link rel="alternate icon" href="../../favicon.png"/>
<link rel="alternate" type="application/atom+xml" title="SnapEnhance Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="SnapEnhance Atom Feed (tags)" href="../tags.xml" />
<link rel="stylesheet" type="text/css" href="../../style.css" />
<link rel="stylesheet" type="text/css" href="../../fonts.css" />
</head>
<body>
<div id="head"><table><tr><td><a class="logo" href="../../"><img src="../../logo.png" alt="" width="32" height="32" /></a></td><td><strong>SnapEnhance</strong><span class="desc"> - An Xposed module offering an enhanced Snapchat experience
</span>
</td></tr></table>
<p><a href="../about.html">About</a> | <a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/LICENSE.html">License</a></p>
</div>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/0f1cd7157aa9aa64b9fdd1564794452bcda89b2e.html">0f1cd7157aa9aa64b9fdd1564794452bcda89b2e</a>
<b>parent</b> <a href="../commit/dc30d4ee254581ba86d69742f5ae5d33cbefcc94.html">dc30d4ee254581ba86d69742f5ae5d33cbefcc94</a>
<b>Author:</b> rhunk &lt;<a href="mailto:101876869+rhunk@users.noreply.github.com">101876869+rhunk@users.noreply.github.com</a>&gt;
<b>Date:</b>   Sat, 11 Nov 2023 18:15:27 +0100

feat: randomize package name

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">app/src/main/kotlin/me/rhunk/snapenhance/RemoteSideContext.kt</a></td><td> | </td><td class="num">4</td><td><span class="i">++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">common/src/main/kotlin/me/rhunk/snapenhance/common/Constants.kt</a></td><td> | </td><td class="num">4</td><td><span class="i">+</span><span class="d">---</span></td></tr>
<tr><td class="M">M</td><td><a href="#h2">common/src/main/kotlin/me/rhunk/snapenhance/common/ReceiversConfig.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h3">core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/BridgeClient.kt</a></td><td> | </td><td class="num">6</td><td><span class="i">+++</span><span class="d">---</span></td></tr>
<tr><td class="M">M</td><td><a href="#h4">core/src/main/kotlin/me/rhunk/snapenhance/core/util/LSPatchUpdater.kt</a></td><td> | </td><td class="num">4</td><td><span class="i">++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h5">manager/src/main/kotlin/me/rhunk/snapenhance/manager/data/SharedConfig.kt</a></td><td> | </td><td class="num">5</td><td><span class="i">++++</span><span class="d">-</span></td></tr>
<tr><td class="D">D</td><td><a href="#h6">manager/src/main/kotlin/me/rhunk/snapenhance/manager/lspatch/LSPatch.kt</a></td><td> | </td><td class="num">253</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h7">manager/src/main/kotlin/me/rhunk/snapenhance/manager/lspatch/LSPatchObfuscation.kt</a></td><td> | </td><td class="num">108</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h8">manager/src/main/kotlin/me/rhunk/snapenhance/manager/lspatch/config/Constants.kt</a></td><td> | </td><td class="num">8</td><td><span class="i"></span><span class="d">--------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h9">manager/src/main/kotlin/me/rhunk/snapenhance/manager/lspatch/config/PatchConfig.kt</a></td><td> | </td><td class="num">20</td><td><span class="i"></span><span class="d">--------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h10">manager/src/main/kotlin/me/rhunk/snapenhance/manager/lspatch/util/ApkSignatureHelper.kt</a></td><td> | </td><td class="num">147</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="A">A</td><td><a href="#h11">manager/src/main/kotlin/me/rhunk/snapenhance/manager/patch/LSPatch.kt</a></td><td> | </td><td class="num">234</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h12">manager/src/main/kotlin/me/rhunk/snapenhance/manager/patch/LSPatchObfuscation.kt</a></td><td> | </td><td class="num">59</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h13">manager/src/main/kotlin/me/rhunk/snapenhance/manager/patch/Repackager.kt</a></td><td> | </td><td class="num">90</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h14">manager/src/main/kotlin/me/rhunk/snapenhance/manager/patch/config/Constants.kt</a></td><td> | </td><td class="num">8</td><td><span class="i">++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h15">manager/src/main/kotlin/me/rhunk/snapenhance/manager/patch/config/PatchConfig.kt</a></td><td> | </td><td class="num">20</td><td><span class="i">++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h16">manager/src/main/kotlin/me/rhunk/snapenhance/manager/patch/util/ApkSignatureHelper.kt</a></td><td> | </td><td class="num">168</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h17">manager/src/main/kotlin/me/rhunk/snapenhance/manager/patch/util/DexLibExt.kt</a></td><td> | </td><td class="num">63</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h18">manager/src/main/kotlin/me/rhunk/snapenhance/manager/ui/MainActivity.kt</a></td><td> | </td><td class="num">3</td><td><span class="i">++</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h19">manager/src/main/kotlin/me/rhunk/snapenhance/manager/ui/tab/impl/HomeTab.kt</a></td><td> | </td><td class="num">5</td><td><span class="i">+++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h20">manager/src/main/kotlin/me/rhunk/snapenhance/manager/ui/tab/impl/SettingsTab.kt</a></td><td> | </td><td class="num">25</td><td><span class="i">++++++++++++++++++</span><span class="d">-------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h21">manager/src/main/kotlin/me/rhunk/snapenhance/manager/ui/tab/impl/download/LSPatchTab.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="A">A</td><td><a href="#h22">manager/src/main/kotlin/me/rhunk/snapenhance/manager/ui/tab/impl/download/RepackageTab.kt</a></td><td> | </td><td class="num">87</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h23">manager/src/main/kotlin/me/rhunk/snapenhance/manager/ui/tab/impl/download/SEDownloadTab.kt</a></td><td> | </td><td class="num">25</td><td><span class="i">+++++++++++++++++++++</span><span class="d">----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h24">manager/src/main/kotlin/me/rhunk/snapenhance/manager/ui/tab/impl/download/SnapchatPatchTab.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
</table></pre><pre>25 files changed, 788 insertions(+), 564 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/RemoteSideContext.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/RemoteSideContext.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/RemoteSideContext.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/RemoteSideContext.kt</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -126,10 +126,10 @@ class RemoteSideContext(
</a>             },
             modInfo = ModInfo(
                 loaderPackageName = MainActivity::class.java.`package`?.name,
<a href="#h0-0-3" id="h0-0-3" class="d">-                buildPackageName = BuildConfig.APPLICATION_ID,
</a><a href="#h0-0-4" id="h0-0-4" class="i">+                buildPackageName = androidContext.packageName,
</a>                 buildVersion = BuildConfig.VERSION_NAME,
                 buildVersionCode = BuildConfig.VERSION_CODE.toLong(),
<a href="#h0-0-7" id="h0-0-7" class="d">-                buildIssuer = androidContext.packageManager.getPackageInfo(BuildConfig.APPLICATION_ID, PackageManager.GET_SIGNING_CERTIFICATES)
</a><a href="#h0-0-8" id="h0-0-8" class="i">+                buildIssuer = androidContext.packageManager.getPackageInfo(androidContext.packageName, PackageManager.GET_SIGNING_CERTIFICATES)
</a>                     ?.signingInfo?.apkContentsSigners?.firstOrNull()?.let {
                         val certFactory = CertificateFactory.getInstance(&quot;X509&quot;)
                         val cert = certFactory.generateCertificate(ByteArrayInputStream(it.toByteArray())) as X509Certificate
<b>diff --git a/<a id="h1" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/Constants.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/Constants.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/Constants.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/Constants.kt</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -2,8 +2,6 @@ package me.rhunk.snapenhance.common
</a> 
 object Constants {
     val SNAPCHAT_PACKAGE_NAME get() = &quot;com.snapchat.android&quot;
<a href="#h1-0-3" id="h1-0-3" class="d">-
</a><a href="#h1-0-4" id="h1-0-4" class="d">-    val ARROYO_MEDIA_CONTAINER_PROTO_PATH = intArrayOf(4, 4)
</a><a href="#h1-0-5" id="h1-0-5" class="d">-
</a><a href="#h1-0-6" id="h1-0-6" class="i">+    val SE_PACKAGE_NAME get() = BuildConfig.APPLICATION_ID
</a>     const val USER_AGENT = &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36&quot;
 } 
\ No newline at end of file
<b>diff --git a/<a id="h2" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/ReceiversConfig.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/ReceiversConfig.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/ReceiversConfig.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/ReceiversConfig.kt</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -1,7 +1,7 @@
</a> package me.rhunk.snapenhance.common
 
 object ReceiversConfig {
<a href="#h2-0-3" id="h2-0-3" class="d">-    const val BRIDGE_SYNC_ACTION = BuildConfig.APPLICATION_ID + &quot;.core.bridge.SYNC&quot;
</a><a href="#h2-0-4" id="h2-0-4" class="i">+    const val BRIDGE_SYNC_ACTION = &quot;me.rhunk.snapenhance.core.bridge.SYNC&quot;
</a>     const val DOWNLOAD_REQUEST_EXTRA = &quot;request&quot;
     const val DOWNLOAD_METADATA_EXTRA = &quot;metadata&quot;
     const val MESSAGING_PREVIEW_EXTRA = &quot;messaging_preview&quot;
<b>diff --git a/<a id="h3" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/BridgeClient.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/BridgeClient.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/BridgeClient.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/BridgeClient.kt</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -18,7 +18,7 @@ import me.rhunk.snapenhance.bridge.SyncCallback
</a> import me.rhunk.snapenhance.bridge.e2ee.E2eeInterface
 import me.rhunk.snapenhance.bridge.scripting.IScripting
 import me.rhunk.snapenhance.bridge.snapclient.MessagingBridge
<a href="#h3-0-3" id="h3-0-3" class="d">-import me.rhunk.snapenhance.common.BuildConfig
</a><a href="#h3-0-4" id="h3-0-4" class="i">+import me.rhunk.snapenhance.common.Constants
</a> import me.rhunk.snapenhance.common.bridge.FileLoaderWrapper
 import me.rhunk.snapenhance.common.bridge.types.BridgeFileType
 import me.rhunk.snapenhance.common.bridge.types.FileActionType
<a href="#h3-1" id="h3-1" class="h">@@ -51,7 +51,7 @@ class BridgeClient(
</a>         with(context.androidContext) {
             runCatching {
                 startActivity(Intent()
<a href="#h3-1-3" id="h3-1-3" class="d">-                    .setClassName(BuildConfig.APPLICATION_ID, BuildConfig.APPLICATION_ID + &quot;.bridge.ForceStartActivity&quot;)
</a><a href="#h3-1-4" id="h3-1-4" class="i">+                    .setClassName(Constants.SE_PACKAGE_NAME, &quot;me.rhunk.snapenhance.bridge.ForceStartActivity&quot;)
</a>                     .addFlags(Intent.FLAG_ACTIVITY_NEW_TASK or Intent.FLAG_ACTIVITY_MULTIPLE_TASK)
                 )
             }
<a href="#h3-2" id="h3-2" class="h">@@ -59,7 +59,7 @@ class BridgeClient(
</a>             //ensure the remote process is running
             runCatching {
                 val intent = Intent()
<a href="#h3-2-3" id="h3-2-3" class="d">-                    .setClassName(BuildConfig.APPLICATION_ID, BuildConfig.APPLICATION_ID + &quot;.bridge.BridgeService&quot;)
</a><a href="#h3-2-4" id="h3-2-4" class="i">+                    .setClassName(Constants.SE_PACKAGE_NAME,&quot;me.rhunk.snapenhance.bridge.BridgeService&quot;)
</a>                 if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.Q) {
                     bindService(
                         intent,
<b>diff --git a/<a id="h4" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/util/LSPatchUpdater.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/util/LSPatchUpdater.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/util/LSPatchUpdater.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/util/LSPatchUpdater.kt</a></b>
<a href="#h4-0" id="h4-0" class="h">@@ -1,6 +1,6 @@
</a> package me.rhunk.snapenhance.core.util
 
<a href="#h4-0-2" id="h4-0-2" class="d">-import me.rhunk.snapenhance.common.BuildConfig
</a><a href="#h4-0-3" id="h4-0-3" class="i">+import me.rhunk.snapenhance.common.Constants
</a> import me.rhunk.snapenhance.core.ModContext
 import me.rhunk.snapenhance.core.bridge.BridgeClient
 import java.io.File
<a href="#h4-1" id="h4-1" class="h">@@ -28,7 +28,7 @@ object LSPatchUpdater {
</a> 
         val embeddedModule = context.androidContext.cacheDir
             .resolve(&quot;lspatch&quot;)
<a href="#h4-1-3" id="h4-1-3" class="d">-            .resolve(BuildConfig.APPLICATION_ID).let { moduleDir -&gt;
</a><a href="#h4-1-4" id="h4-1-4" class="i">+            .resolve(Constants.SE_PACKAGE_NAME).let { moduleDir -&gt;
</a>                 if (!moduleDir.exists()) return@let null
                 moduleDir.listFiles()?.firstOrNull { it.extension == &quot;apk&quot; }
             } ?: obfuscatedModulePath?.let { path -&gt;
<b>diff --git a/<a id="h5" href="../file/manager/src/main/kotlin/me/rhunk/snapenhance/manager/data/SharedConfig.kt.html">manager/src/main/kotlin/me/rhunk/snapenhance/manager/data/SharedConfig.kt</a> b/<a href="../file/manager/src/main/kotlin/me/rhunk/snapenhance/manager/data/SharedConfig.kt.html">manager/src/main/kotlin/me/rhunk/snapenhance/manager/data/SharedConfig.kt</a></b>
<a href="#h5-0" id="h5-0" class="h">@@ -1,6 +1,7 @@
</a> package me.rhunk.snapenhance.manager.data
 
 import android.content.Context
<a href="#h5-0-3" id="h5-0-3" class="i">+import me.rhunk.snapenhance.manager.BuildConfig
</a> 
 class SharedConfig(
     context: Context
<a href="#h5-1" id="h5-1" class="h">@@ -16,8 +17,10 @@ class SharedConfig(
</a>     var snapchatPackageName get() = sharedPreferences.getString(&quot;snapchatPackageName&quot;, &quot;com.snapchat.android&quot;)?.takeIf { it.isNotEmpty() } ?: &quot;com.snapchat.android&quot;
         set(value) = sharedPreferences.edit().putString(&quot;snapchatPackageName&quot;, value).apply()
 
<a href="#h5-1-3" id="h5-1-3" class="d">-    var snapEnhancePackageName get() = sharedPreferences.getString(&quot;snapEnhancePackageName&quot;, &quot;me.rhunk.snapenhance&quot;)?.takeIf { it.isNotEmpty() } ?: &quot;me.rhunk.snapenhance&quot;
</a><a href="#h5-1-4" id="h5-1-4" class="i">+    var snapEnhancePackageName get() = sharedPreferences.getString(&quot;snapEnhancePackageName&quot;, BuildConfig.APPLICATION_ID)?.takeIf { it.isNotEmpty() } ?: BuildConfig.APPLICATION_ID
</a>         set(value) = sharedPreferences.edit().putString(&quot;snapEnhancePackageName&quot;, value).apply()
<a href="#h5-1-6" id="h5-1-6" class="i">+    var enableRepackage get() = sharedPreferences.getBoolean(&quot;enableRepackage&quot;, false)
</a><a href="#h5-1-7" id="h5-1-7" class="i">+        set(value) = sharedPreferences.edit().putBoolean(&quot;enableRepackage&quot;, value).apply()
</a> 
     var useRootInstaller get() = sharedPreferences.getBoolean(&quot;useRootInstaller&quot;, false)
         set(value) = sharedPreferences.edit().putBoolean(&quot;useRootInstaller&quot;, value).apply()
<b>diff --git a/<a id="h6" href="../file/manager/src/main/kotlin/me/rhunk/snapenhance/manager/lspatch/LSPatch.kt.html">manager/src/main/kotlin/me/rhunk/snapenhance/manager/lspatch/LSPatch.kt</a> b/<a href="../file/manager/src/main/kotlin/me/rhunk/snapenhance/manager/lspatch/LSPatch.kt.html">manager/src/main/kotlin/me/rhunk/snapenhance/manager/lspatch/LSPatch.kt</a></b>
<a href="#h6-0" id="h6-0" class="h">@@ -1,252 +0,0 @@
</a><a href="#h6-0-0" id="h6-0-0" class="d">-package me.rhunk.snapenhance.manager.lspatch
</a><a href="#h6-0-1" id="h6-0-1" class="d">-
</a><a href="#h6-0-2" id="h6-0-2" class="d">-import android.content.Context
</a><a href="#h6-0-3" id="h6-0-3" class="d">-import com.android.tools.build.apkzlib.sign.SigningExtension
</a><a href="#h6-0-4" id="h6-0-4" class="d">-import com.android.tools.build.apkzlib.sign.SigningOptions
</a><a href="#h6-0-5" id="h6-0-5" class="d">-import com.android.tools.build.apkzlib.zip.AlignmentRules
</a><a href="#h6-0-6" id="h6-0-6" class="d">-import com.android.tools.build.apkzlib.zip.ZFile
</a><a href="#h6-0-7" id="h6-0-7" class="d">-import com.android.tools.build.apkzlib.zip.ZFileOptions
</a><a href="#h6-0-8" id="h6-0-8" class="d">-import com.google.gson.Gson
</a><a href="#h6-0-9" id="h6-0-9" class="d">-import com.wind.meditor.core.ManifestEditor
</a><a href="#h6-0-10" id="h6-0-10" class="d">-import com.wind.meditor.property.AttributeItem
</a><a href="#h6-0-11" id="h6-0-11" class="d">-import com.wind.meditor.property.ModificationProperty
</a><a href="#h6-0-12" id="h6-0-12" class="d">-import me.rhunk.snapenhance.manager.lspatch.config.Constants.PROXY_APP_COMPONENT_FACTORY
</a><a href="#h6-0-13" id="h6-0-13" class="d">-import me.rhunk.snapenhance.manager.lspatch.config.PatchConfig
</a><a href="#h6-0-14" id="h6-0-14" class="d">-import me.rhunk.snapenhance.manager.lspatch.util.ApkSignatureHelper
</a><a href="#h6-0-15" id="h6-0-15" class="d">-import java.io.ByteArrayInputStream
</a><a href="#h6-0-16" id="h6-0-16" class="d">-import java.io.ByteArrayOutputStream
</a><a href="#h6-0-17" id="h6-0-17" class="d">-import java.io.File
</a><a href="#h6-0-18" id="h6-0-18" class="d">-import java.security.KeyStore
</a><a href="#h6-0-19" id="h6-0-19" class="d">-import java.security.cert.X509Certificate
</a><a href="#h6-0-20" id="h6-0-20" class="d">-import java.util.zip.ZipFile
</a><a href="#h6-0-21" id="h6-0-21" class="d">-import kotlin.io.encoding.Base64
</a><a href="#h6-0-22" id="h6-0-22" class="d">-import kotlin.io.encoding.ExperimentalEncodingApi
</a><a href="#h6-0-23" id="h6-0-23" class="d">-import kotlin.random.Random
</a><a href="#h6-0-24" id="h6-0-24" class="d">-
</a><a href="#h6-0-25" id="h6-0-25" class="d">-
</a><a href="#h6-0-26" id="h6-0-26" class="d">-//https://github.com/LSPosed/LSPatch/blob/master/patch/src/main/java/org/lsposed/patch/LSPatch.java
</a><a href="#h6-0-27" id="h6-0-27" class="d">-class LSPatch(
</a><a href="#h6-0-28" id="h6-0-28" class="d">-    private val context: Context,
</a><a href="#h6-0-29" id="h6-0-29" class="d">-    private val modules: Map&lt;String, File&gt;, //packageName -&gt; file
</a><a href="#h6-0-30" id="h6-0-30" class="d">-    private val obfuscate: Boolean,
</a><a href="#h6-0-31" id="h6-0-31" class="d">-    private val printLog: (Any) -&gt; Unit
</a><a href="#h6-0-32" id="h6-0-32" class="d">-) {
</a><a href="#h6-0-33" id="h6-0-33" class="d">-
</a><a href="#h6-0-34" id="h6-0-34" class="d">-    private fun patchManifest(data: ByteArray, lspatchMetadata: Pair&lt;String, String&gt;): ByteArray {
</a><a href="#h6-0-35" id="h6-0-35" class="d">-        val property = ModificationProperty()
</a><a href="#h6-0-36" id="h6-0-36" class="d">-
</a><a href="#h6-0-37" id="h6-0-37" class="d">-        property.addApplicationAttribute(AttributeItem(&quot;appComponentFactory&quot;, PROXY_APP_COMPONENT_FACTORY))
</a><a href="#h6-0-38" id="h6-0-38" class="d">-        property.addMetaData(ModificationProperty.MetaData(lspatchMetadata.first, lspatchMetadata.second))
</a><a href="#h6-0-39" id="h6-0-39" class="d">-
</a><a href="#h6-0-40" id="h6-0-40" class="d">-        return ByteArrayOutputStream().apply {
</a><a href="#h6-0-41" id="h6-0-41" class="d">-            ManifestEditor(ByteArrayInputStream(data), this, property).processManifest()
</a><a href="#h6-0-42" id="h6-0-42" class="d">-            flush()
</a><a href="#h6-0-43" id="h6-0-43" class="d">-            close()
</a><a href="#h6-0-44" id="h6-0-44" class="d">-        }.toByteArray()
</a><a href="#h6-0-45" id="h6-0-45" class="d">-    }
</a><a href="#h6-0-46" id="h6-0-46" class="d">-
</a><a href="#h6-0-47" id="h6-0-47" class="d">-    private fun provideSigningExtension(): SigningExtension {
</a><a href="#h6-0-48" id="h6-0-48" class="d">-        val keyStore = KeyStore.getInstance(KeyStore.getDefaultType())
</a><a href="#h6-0-49" id="h6-0-49" class="d">-        keyStore.load(context.assets.open(&quot;lspatch/keystore.jks&quot;), &quot;android&quot;.toCharArray())
</a><a href="#h6-0-50" id="h6-0-50" class="d">-        val key = keyStore.getEntry(&quot;androiddebugkey&quot;, KeyStore.PasswordProtection(&quot;android&quot;.toCharArray())) as KeyStore.PrivateKeyEntry
</a><a href="#h6-0-51" id="h6-0-51" class="d">-        val certificates = key.certificateChain.mapNotNull { it as? X509Certificate }.toTypedArray()
</a><a href="#h6-0-52" id="h6-0-52" class="d">-
</a><a href="#h6-0-53" id="h6-0-53" class="d">-        return SigningExtension(
</a><a href="#h6-0-54" id="h6-0-54" class="d">-            SigningOptions.builder().apply {
</a><a href="#h6-0-55" id="h6-0-55" class="d">-                setMinSdkVersion(28)
</a><a href="#h6-0-56" id="h6-0-56" class="d">-                setV2SigningEnabled(true)
</a><a href="#h6-0-57" id="h6-0-57" class="d">-                setCertificates(*certificates)
</a><a href="#h6-0-58" id="h6-0-58" class="d">-                setKey(key.privateKey)
</a><a href="#h6-0-59" id="h6-0-59" class="d">-            }.build()
</a><a href="#h6-0-60" id="h6-0-60" class="d">-        )
</a><a href="#h6-0-61" id="h6-0-61" class="d">-    }
</a><a href="#h6-0-62" id="h6-0-62" class="d">-
</a><a href="#h6-0-63" id="h6-0-63" class="d">-    private fun resignApk(inputApkFile: File, outputFile: File) {
</a><a href="#h6-0-64" id="h6-0-64" class="d">-        printLog(&quot;Resigning ${inputApkFile.absolutePath} to ${outputFile.absolutePath}&quot;)
</a><a href="#h6-0-65" id="h6-0-65" class="d">-        val dstZFile = ZFile.openReadWrite(outputFile, ZFileOptions())
</a><a href="#h6-0-66" id="h6-0-66" class="d">-        val inZFile = ZFile.openReadOnly(inputApkFile)
</a><a href="#h6-0-67" id="h6-0-67" class="d">-
</a><a href="#h6-0-68" id="h6-0-68" class="d">-        inZFile.entries().forEach { entry -&gt;
</a><a href="#h6-0-69" id="h6-0-69" class="d">-            dstZFile.add(entry.centralDirectoryHeader.name, entry.open())
</a><a href="#h6-0-70" id="h6-0-70" class="d">-        }
</a><a href="#h6-0-71" id="h6-0-71" class="d">-
</a><a href="#h6-0-72" id="h6-0-72" class="d">-        // sign apk
</a><a href="#h6-0-73" id="h6-0-73" class="d">-        runCatching {
</a><a href="#h6-0-74" id="h6-0-74" class="d">-            provideSigningExtension().register(dstZFile)
</a><a href="#h6-0-75" id="h6-0-75" class="d">-        }.onFailure {
</a><a href="#h6-0-76" id="h6-0-76" class="d">-            throw Exception(&quot;Failed to sign apk&quot;, it)
</a><a href="#h6-0-77" id="h6-0-77" class="d">-        }
</a><a href="#h6-0-78" id="h6-0-78" class="d">-
</a><a href="#h6-0-79" id="h6-0-79" class="d">-        dstZFile.realign()
</a><a href="#h6-0-80" id="h6-0-80" class="d">-        dstZFile.close()
</a><a href="#h6-0-81" id="h6-0-81" class="d">-        inZFile.close()
</a><a href="#h6-0-82" id="h6-0-82" class="d">-        printLog(&quot;Done&quot;)
</a><a href="#h6-0-83" id="h6-0-83" class="d">-    }
</a><a href="#h6-0-84" id="h6-0-84" class="d">-
</a><a href="#h6-0-85" id="h6-0-85" class="d">-    private fun uniqueHash(): String {
</a><a href="#h6-0-86" id="h6-0-86" class="d">-        return Random.nextBytes(Random.nextInt(5, 10)).joinToString(&quot;&quot;) { &quot;%02x&quot;.format(it) }
</a><a href="#h6-0-87" id="h6-0-87" class="d">-    }
</a><a href="#h6-0-88" id="h6-0-88" class="d">-
</a><a href="#h6-0-89" id="h6-0-89" class="d">-    @Suppress(&quot;UNCHECKED_CAST&quot;)
</a><a href="#h6-0-90" id="h6-0-90" class="d">-    @OptIn(ExperimentalEncodingApi::class)
</a><a href="#h6-0-91" id="h6-0-91" class="d">-    private fun patchApk(inputApkFile: File, outputFile: File) {
</a><a href="#h6-0-92" id="h6-0-92" class="d">-        printLog(&quot;Patching ${inputApkFile.absolutePath} to ${outputFile.absolutePath}&quot;)
</a><a href="#h6-0-93" id="h6-0-93" class="d">-
</a><a href="#h6-0-94" id="h6-0-94" class="d">-        val obfuscationCacheFolder = File(context.cacheDir, &quot;lspatch&quot;).apply {
</a><a href="#h6-0-95" id="h6-0-95" class="d">-            if (exists()) deleteRecursively()
</a><a href="#h6-0-96" id="h6-0-96" class="d">-            mkdirs()
</a><a href="#h6-0-97" id="h6-0-97" class="d">-        }
</a><a href="#h6-0-98" id="h6-0-98" class="d">-        val lspatchObfuscation = LSPatchObfuscation(obfuscationCacheFolder) { printLog(it) }
</a><a href="#h6-0-99" id="h6-0-99" class="d">-        val dexObfuscationConfig = if (obfuscate) DexObfuscationConfig(
</a><a href="#h6-0-100" id="h6-0-100" class="d">-            packageName = uniqueHash(),
</a><a href="#h6-0-101" id="h6-0-101" class="d">-            metadataManifestField = uniqueHash(),
</a><a href="#h6-0-102" id="h6-0-102" class="d">-            metaLoaderFilePath = uniqueHash(),
</a><a href="#h6-0-103" id="h6-0-103" class="d">-            configFilePath = uniqueHash(),
</a><a href="#h6-0-104" id="h6-0-104" class="d">-            loaderFilePath = uniqueHash(),
</a><a href="#h6-0-105" id="h6-0-105" class="d">-            libNativeFilePath = mapOf(
</a><a href="#h6-0-106" id="h6-0-106" class="d">-                &quot;arm64-v8a&quot; to uniqueHash() + &quot;.so&quot;,
</a><a href="#h6-0-107" id="h6-0-107" class="d">-                &quot;armeabi-v7a&quot; to uniqueHash() + &quot;.so&quot;,
</a><a href="#h6-0-108" id="h6-0-108" class="d">-            ),
</a><a href="#h6-0-109" id="h6-0-109" class="d">-            originApkPath = uniqueHash(),
</a><a href="#h6-0-110" id="h6-0-110" class="d">-            cachedOriginApkPath = uniqueHash(),
</a><a href="#h6-0-111" id="h6-0-111" class="d">-            openAtApkPath = uniqueHash(),
</a><a href="#h6-0-112" id="h6-0-112" class="d">-            assetModuleFolderPath = uniqueHash(),
</a><a href="#h6-0-113" id="h6-0-113" class="d">-        ) else null
</a><a href="#h6-0-114" id="h6-0-114" class="d">-
</a><a href="#h6-0-115" id="h6-0-115" class="d">-        val dstZFile = ZFile.openReadWrite(outputFile, ZFileOptions().setAlignmentRule(
</a><a href="#h6-0-116" id="h6-0-116" class="d">-            AlignmentRules.compose(
</a><a href="#h6-0-117" id="h6-0-117" class="d">-                AlignmentRules.constantForSuffix(&quot;.so&quot;, 4096),
</a><a href="#h6-0-118" id="h6-0-118" class="d">-                AlignmentRules.constantForSuffix(&quot;assets/&quot; + (dexObfuscationConfig?.originApkPath ?: &quot;lspatch/origin.apk&quot;), 4096)
</a><a href="#h6-0-119" id="h6-0-119" class="d">-            )
</a><a href="#h6-0-120" id="h6-0-120" class="d">-        ))
</a><a href="#h6-0-121" id="h6-0-121" class="d">-
</a><a href="#h6-0-122" id="h6-0-122" class="d">-        val patchConfig = PatchConfig(
</a><a href="#h6-0-123" id="h6-0-123" class="d">-            useManager = false,
</a><a href="#h6-0-124" id="h6-0-124" class="d">-            debuggable = false,
</a><a href="#h6-0-125" id="h6-0-125" class="d">-            overrideVersionCode = false,
</a><a href="#h6-0-126" id="h6-0-126" class="d">-            sigBypassLevel = 2,
</a><a href="#h6-0-127" id="h6-0-127" class="d">-            originalSignature = ApkSignatureHelper.getApkSignInfo(inputApkFile.absolutePath),
</a><a href="#h6-0-128" id="h6-0-128" class="d">-            appComponentFactory = &quot;androidx.core.app.CoreComponentFactory&quot;
</a><a href="#h6-0-129" id="h6-0-129" class="d">-        ).let { Gson().toJson(it) }
</a><a href="#h6-0-130" id="h6-0-130" class="d">-
</a><a href="#h6-0-131" id="h6-0-131" class="d">-        // sign apk
</a><a href="#h6-0-132" id="h6-0-132" class="d">-        runCatching {
</a><a href="#h6-0-133" id="h6-0-133" class="d">-            provideSigningExtension().register(dstZFile)
</a><a href="#h6-0-134" id="h6-0-134" class="d">-        }.onFailure {
</a><a href="#h6-0-135" id="h6-0-135" class="d">-            throw Exception(&quot;Failed to sign apk&quot;, it)
</a><a href="#h6-0-136" id="h6-0-136" class="d">-        }
</a><a href="#h6-0-137" id="h6-0-137" class="d">-
</a><a href="#h6-0-138" id="h6-0-138" class="d">-        printLog(&quot;Patching manifest&quot;)
</a><a href="#h6-0-139" id="h6-0-139" class="d">-
</a><a href="#h6-0-140" id="h6-0-140" class="d">-        val sourceApkFile = dstZFile.addNestedZip({ &quot;assets/&quot; + (dexObfuscationConfig?.originApkPath ?: &quot;lspatch/origin.apk&quot;) }, inputApkFile, false)
</a><a href="#h6-0-141" id="h6-0-141" class="d">-        val originalManifestEntry = sourceApkFile.get(&quot;AndroidManifest.xml&quot;) ?: throw Exception(&quot;No original manifest found&quot;)
</a><a href="#h6-0-142" id="h6-0-142" class="d">-        originalManifestEntry.open().use { inputStream -&gt;
</a><a href="#h6-0-143" id="h6-0-143" class="d">-            val patchedManifestData = patchManifest(inputStream.readBytes(), (dexObfuscationConfig?.metadataManifestField ?: &quot;lspatch&quot;) to Base64.encode(patchConfig.toByteArray()))
</a><a href="#h6-0-144" id="h6-0-144" class="d">-            dstZFile.add(&quot;AndroidManifest.xml&quot;, patchedManifestData.inputStream())
</a><a href="#h6-0-145" id="h6-0-145" class="d">-        }
</a><a href="#h6-0-146" id="h6-0-146" class="d">-
</a><a href="#h6-0-147" id="h6-0-147" class="d">-        //add config
</a><a href="#h6-0-148" id="h6-0-148" class="d">-        printLog(&quot;Adding config&quot;)
</a><a href="#h6-0-149" id="h6-0-149" class="d">-        dstZFile.add(&quot;assets/&quot; + (dexObfuscationConfig?.configFilePath ?: &quot;lspatch/config.json&quot;), ByteArrayInputStream(patchConfig.toByteArray()))
</a><a href="#h6-0-150" id="h6-0-150" class="d">-
</a><a href="#h6-0-151" id="h6-0-151" class="d">-        // add loader dex
</a><a href="#h6-0-152" id="h6-0-152" class="d">-        printLog(&quot;Adding loader dex&quot;)
</a><a href="#h6-0-153" id="h6-0-153" class="d">-        context.assets.open(&quot;lspatch/dexes/loader.dex&quot;).use { inputStream -&gt;
</a><a href="#h6-0-154" id="h6-0-154" class="d">-            dstZFile.add(&quot;assets/&quot; + (dexObfuscationConfig?.loaderFilePath ?: &quot;lspatch/loader.dex&quot;), dexObfuscationConfig?.let {
</a><a href="#h6-0-155" id="h6-0-155" class="d">-                lspatchObfuscation.obfuscateLoader(inputStream, it).inputStream()
</a><a href="#h6-0-156" id="h6-0-156" class="d">-            } ?: inputStream)
</a><a href="#h6-0-157" id="h6-0-157" class="d">-        }
</a><a href="#h6-0-158" id="h6-0-158" class="d">-
</a><a href="#h6-0-159" id="h6-0-159" class="d">-        //add natives
</a><a href="#h6-0-160" id="h6-0-160" class="d">-        printLog(&quot;Adding natives&quot;)
</a><a href="#h6-0-161" id="h6-0-161" class="d">-        context.assets.list(&quot;lspatch/so&quot;)?.forEach { native -&gt;
</a><a href="#h6-0-162" id="h6-0-162" class="d">-            dstZFile.add(&quot;assets/${dexObfuscationConfig?.libNativeFilePath?.get(native) ?: &quot;lspatch/so/$native/liblspatch.so&quot;}&quot;, context.assets.open(&quot;lspatch/so/$native/liblspatch.so&quot;), false)
</a><a href="#h6-0-163" id="h6-0-163" class="d">-        }
</a><a href="#h6-0-164" id="h6-0-164" class="d">-
</a><a href="#h6-0-165" id="h6-0-165" class="d">-        //embed modules
</a><a href="#h6-0-166" id="h6-0-166" class="d">-        printLog(&quot;Embedding modules&quot;)
</a><a href="#h6-0-167" id="h6-0-167" class="d">-        modules.forEach { (packageName, module) -&gt;
</a><a href="#h6-0-168" id="h6-0-168" class="d">-            val obfuscatedPackageName = dexObfuscationConfig?.packageName ?: packageName
</a><a href="#h6-0-169" id="h6-0-169" class="d">-            printLog(&quot;- $obfuscatedPackageName&quot;)
</a><a href="#h6-0-170" id="h6-0-170" class="d">-            dstZFile.add(&quot;assets/${dexObfuscationConfig?.assetModuleFolderPath ?: &quot;lspatch/modules&quot;}/$obfuscatedPackageName.apk&quot;, module.inputStream())
</a><a href="#h6-0-171" id="h6-0-171" class="d">-        }
</a><a href="#h6-0-172" id="h6-0-172" class="d">-
</a><a href="#h6-0-173" id="h6-0-173" class="d">-        // link apk entries
</a><a href="#h6-0-174" id="h6-0-174" class="d">-        printLog(&quot;Linking apk entries&quot;)
</a><a href="#h6-0-175" id="h6-0-175" class="d">-
</a><a href="#h6-0-176" id="h6-0-176" class="d">-        for (entry in sourceApkFile.entries()) {
</a><a href="#h6-0-177" id="h6-0-177" class="d">-            val name = entry.centralDirectoryHeader.name
</a><a href="#h6-0-178" id="h6-0-178" class="d">-            if (dexObfuscationConfig == null &amp;&amp; name.startsWith(&quot;classes&quot;) &amp;&amp; name.endsWith(&quot;.dex&quot;)) continue
</a><a href="#h6-0-179" id="h6-0-179" class="d">-            if (dstZFile[name] != null) continue
</a><a href="#h6-0-180" id="h6-0-180" class="d">-            if (name == &quot;AndroidManifest.xml&quot;) continue
</a><a href="#h6-0-181" id="h6-0-181" class="d">-            if (name.startsWith(&quot;META-INF&quot;) &amp;&amp; (name.endsWith(&quot;.SF&quot;) || name.endsWith(&quot;.MF&quot;) || name.endsWith(
</a><a href="#h6-0-182" id="h6-0-182" class="d">-                    &quot;.RSA&quot;
</a><a href="#h6-0-183" id="h6-0-183" class="d">-                ))
</a><a href="#h6-0-184" id="h6-0-184" class="d">-            ) continue
</a><a href="#h6-0-185" id="h6-0-185" class="d">-            sourceApkFile.addFileLink(name, name)
</a><a href="#h6-0-186" id="h6-0-186" class="d">-        }
</a><a href="#h6-0-187" id="h6-0-187" class="d">-
</a><a href="#h6-0-188" id="h6-0-188" class="d">-        printLog(&quot;Adding meta loader dex&quot;)
</a><a href="#h6-0-189" id="h6-0-189" class="d">-        context.assets.open(&quot;lspatch/dexes/metaloader.dex&quot;).use { inputStream -&gt;
</a><a href="#h6-0-190" id="h6-0-190" class="d">-            dstZFile.add(dexObfuscationConfig?.let { &quot;classes9.dex&quot; } ?: &quot;classes.dex&quot;, dexObfuscationConfig?.let {
</a><a href="#h6-0-191" id="h6-0-191" class="d">-                lspatchObfuscation.obfuscateMetaLoader(inputStream, it).inputStream()
</a><a href="#h6-0-192" id="h6-0-192" class="d">-            } ?: inputStream)
</a><a href="#h6-0-193" id="h6-0-193" class="d">-        }
</a><a href="#h6-0-194" id="h6-0-194" class="d">-
</a><a href="#h6-0-195" id="h6-0-195" class="d">-        printLog(&quot;Writing apk&quot;)
</a><a href="#h6-0-196" id="h6-0-196" class="d">-        dstZFile.realign()
</a><a href="#h6-0-197" id="h6-0-197" class="d">-        dstZFile.close()
</a><a href="#h6-0-198" id="h6-0-198" class="d">-        sourceApkFile.close()
</a><a href="#h6-0-199" id="h6-0-199" class="d">-
</a><a href="#h6-0-200" id="h6-0-200" class="d">-        printLog(&quot;Cleaning obfuscation cache&quot;)
</a><a href="#h6-0-201" id="h6-0-201" class="d">-        obfuscationCacheFolder.deleteRecursively()
</a><a href="#h6-0-202" id="h6-0-202" class="d">-        printLog(&quot;Done&quot;)
</a><a href="#h6-0-203" id="h6-0-203" class="d">-    }
</a><a href="#h6-0-204" id="h6-0-204" class="d">-
</a><a href="#h6-0-205" id="h6-0-205" class="d">-    fun patchSplits(inputs: List&lt;File&gt;): Map&lt;String, File&gt; {
</a><a href="#h6-0-206" id="h6-0-206" class="d">-        val outputs = mutableMapOf&lt;String, File&gt;()
</a><a href="#h6-0-207" id="h6-0-207" class="d">-        inputs.forEach { input -&gt;
</a><a href="#h6-0-208" id="h6-0-208" class="d">-            val outputFile = File.createTempFile(&quot;patched&quot;, &quot;.apk&quot;, context.externalCacheDir ?: context.cacheDir)
</a><a href="#h6-0-209" id="h6-0-209" class="d">-            if (input.name.contains(&quot;split&quot;)) {
</a><a href="#h6-0-210" id="h6-0-210" class="d">-                resignApk(input, outputFile)
</a><a href="#h6-0-211" id="h6-0-211" class="d">-                outputs[input.name] = outputFile
</a><a href="#h6-0-212" id="h6-0-212" class="d">-                return@forEach
</a><a href="#h6-0-213" id="h6-0-213" class="d">-            }
</a><a href="#h6-0-214" id="h6-0-214" class="d">-            patch(input, outputFile)
</a><a href="#h6-0-215" id="h6-0-215" class="d">-            outputs[&quot;base.apk&quot;] = outputFile
</a><a href="#h6-0-216" id="h6-0-216" class="d">-        }
</a><a href="#h6-0-217" id="h6-0-217" class="d">-        return outputs
</a><a href="#h6-0-218" id="h6-0-218" class="d">-    }
</a><a href="#h6-0-219" id="h6-0-219" class="d">-
</a><a href="#h6-0-220" id="h6-0-220" class="d">-    private fun patch(input: File, outputFile: File) {
</a><a href="#h6-0-221" id="h6-0-221" class="d">-        //check if input apk is already patched
</a><a href="#h6-0-222" id="h6-0-222" class="d">-        var isAlreadyPatched = false
</a><a href="#h6-0-223" id="h6-0-223" class="d">-        var inputFile = input
</a><a href="#h6-0-224" id="h6-0-224" class="d">-
</a><a href="#h6-0-225" id="h6-0-225" class="d">-        // extract origin
</a><a href="#h6-0-226" id="h6-0-226" class="d">-        printLog(&quot;Extracting origin apk&quot;)
</a><a href="#h6-0-227" id="h6-0-227" class="d">-        ZipFile(input).use { zipFile -&gt;
</a><a href="#h6-0-228" id="h6-0-228" class="d">-            zipFile.getEntry(&quot;assets/lspatch/origin.apk&quot;)?.apply {
</a><a href="#h6-0-229" id="h6-0-229" class="d">-                inputFile = File.createTempFile(&quot;origin&quot;, &quot;.apk&quot;)
</a><a href="#h6-0-230" id="h6-0-230" class="d">-                inputFile.outputStream().use {
</a><a href="#h6-0-231" id="h6-0-231" class="d">-                    zipFile.getInputStream(this).copyTo(it)
</a><a href="#h6-0-232" id="h6-0-232" class="d">-                }
</a><a href="#h6-0-233" id="h6-0-233" class="d">-                isAlreadyPatched = true
</a><a href="#h6-0-234" id="h6-0-234" class="d">-            }
</a><a href="#h6-0-235" id="h6-0-235" class="d">-        }
</a><a href="#h6-0-236" id="h6-0-236" class="d">-
</a><a href="#h6-0-237" id="h6-0-237" class="d">-        if (outputFile.exists()) outputFile.delete()
</a><a href="#h6-0-238" id="h6-0-238" class="d">-
</a><a href="#h6-0-239" id="h6-0-239" class="d">-        printLog(&quot;Patching apk&quot;)
</a><a href="#h6-0-240" id="h6-0-240" class="d">-        runCatching {
</a><a href="#h6-0-241" id="h6-0-241" class="d">-            patchApk(inputFile, outputFile)
</a><a href="#h6-0-242" id="h6-0-242" class="d">-        }.onFailure {
</a><a href="#h6-0-243" id="h6-0-243" class="d">-            if (isAlreadyPatched) {
</a><a href="#h6-0-244" id="h6-0-244" class="d">-                inputFile.delete()
</a><a href="#h6-0-245" id="h6-0-245" class="d">-            }
</a><a href="#h6-0-246" id="h6-0-246" class="d">-            outputFile.delete()
</a><a href="#h6-0-247" id="h6-0-247" class="d">-            printLog(&quot;Failed to patch&quot;)
</a><a href="#h6-0-248" id="h6-0-248" class="d">-            printLog(it)
</a><a href="#h6-0-249" id="h6-0-249" class="d">-        }
</a><a href="#h6-0-250" id="h6-0-250" class="d">-    }
</a><a href="#h6-0-251" id="h6-0-251" class="d">-}</a><a href="#h6-0-252" id="h6-0-252" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h7" href="../file/manager/src/main/kotlin/me/rhunk/snapenhance/manager/lspatch/LSPatchObfuscation.kt.html">manager/src/main/kotlin/me/rhunk/snapenhance/manager/lspatch/LSPatchObfuscation.kt</a> b/<a href="../file/manager/src/main/kotlin/me/rhunk/snapenhance/manager/lspatch/LSPatchObfuscation.kt.html">manager/src/main/kotlin/me/rhunk/snapenhance/manager/lspatch/LSPatchObfuscation.kt</a></b>
<a href="#h7-0" id="h7-0" class="h">@@ -1,107 +0,0 @@
</a><a href="#h7-0-0" id="h7-0-0" class="d">-package me.rhunk.snapenhance.manager.lspatch
</a><a href="#h7-0-1" id="h7-0-1" class="d">-
</a><a href="#h7-0-2" id="h7-0-2" class="d">-import org.jf.dexlib2.Opcodes
</a><a href="#h7-0-3" id="h7-0-3" class="d">-import org.jf.dexlib2.dexbacked.DexBackedDexFile
</a><a href="#h7-0-4" id="h7-0-4" class="d">-import org.jf.dexlib2.iface.reference.StringReference
</a><a href="#h7-0-5" id="h7-0-5" class="d">-import org.jf.dexlib2.writer.io.FileDataStore
</a><a href="#h7-0-6" id="h7-0-6" class="d">-import org.jf.dexlib2.writer.pool.DexPool
</a><a href="#h7-0-7" id="h7-0-7" class="d">-import org.jf.dexlib2.writer.pool.StringPool
</a><a href="#h7-0-8" id="h7-0-8" class="d">-import java.io.BufferedInputStream
</a><a href="#h7-0-9" id="h7-0-9" class="d">-import java.io.File
</a><a href="#h7-0-10" id="h7-0-10" class="d">-import java.io.InputStream
</a><a href="#h7-0-11" id="h7-0-11" class="d">-
</a><a href="#h7-0-12" id="h7-0-12" class="d">-data class DexObfuscationConfig(
</a><a href="#h7-0-13" id="h7-0-13" class="d">-    val packageName: String,
</a><a href="#h7-0-14" id="h7-0-14" class="d">-    val metadataManifestField: String? = null,
</a><a href="#h7-0-15" id="h7-0-15" class="d">-    val metaLoaderFilePath: String? = null,
</a><a href="#h7-0-16" id="h7-0-16" class="d">-    val configFilePath: String? = null,
</a><a href="#h7-0-17" id="h7-0-17" class="d">-    val loaderFilePath: String? = null,
</a><a href="#h7-0-18" id="h7-0-18" class="d">-    val originApkPath: String? = null,
</a><a href="#h7-0-19" id="h7-0-19" class="d">-    val cachedOriginApkPath: String? = null,
</a><a href="#h7-0-20" id="h7-0-20" class="d">-    val openAtApkPath: String? = null,
</a><a href="#h7-0-21" id="h7-0-21" class="d">-    val assetModuleFolderPath: String? = null,
</a><a href="#h7-0-22" id="h7-0-22" class="d">-    val libNativeFilePath: Map&lt;String, String&gt; = mapOf(),
</a><a href="#h7-0-23" id="h7-0-23" class="d">-)
</a><a href="#h7-0-24" id="h7-0-24" class="d">-
</a><a href="#h7-0-25" id="h7-0-25" class="d">-class LSPatchObfuscation(
</a><a href="#h7-0-26" id="h7-0-26" class="d">-    private val cacheFolder: File,
</a><a href="#h7-0-27" id="h7-0-27" class="d">-    private val printLog: (String) -&gt; Unit = { println(it) }
</a><a href="#h7-0-28" id="h7-0-28" class="d">-) {
</a><a href="#h7-0-29" id="h7-0-29" class="d">-    private fun obfuscateDexFile(dexStrings: Map&lt;String, String?&gt;, inputStream: InputStream): File {
</a><a href="#h7-0-30" id="h7-0-30" class="d">-        val dexFile = DexBackedDexFile.fromInputStream(Opcodes.forApi(29), BufferedInputStream(inputStream))
</a><a href="#h7-0-31" id="h7-0-31" class="d">-
</a><a href="#h7-0-32" id="h7-0-32" class="d">-        val dexPool = object: DexPool(dexFile.opcodes) {
</a><a href="#h7-0-33" id="h7-0-33" class="d">-            override fun getSectionProvider(): SectionProvider {
</a><a href="#h7-0-34" id="h7-0-34" class="d">-                val dexPool = this
</a><a href="#h7-0-35" id="h7-0-35" class="d">-                return object: DexPoolSectionProvider() {
</a><a href="#h7-0-36" id="h7-0-36" class="d">-                    override fun getStringSection() = object: StringPool(dexPool) {
</a><a href="#h7-0-37" id="h7-0-37" class="d">-                        private val cacheMap = mutableMapOf&lt;String, String&gt;()
</a><a href="#h7-0-38" id="h7-0-38" class="d">-
</a><a href="#h7-0-39" id="h7-0-39" class="d">-                        override fun intern(string: CharSequence) {
</a><a href="#h7-0-40" id="h7-0-40" class="d">-                            dexStrings[string.toString()]?.let {
</a><a href="#h7-0-41" id="h7-0-41" class="d">-                                cacheMap[string.toString()] = it
</a><a href="#h7-0-42" id="h7-0-42" class="d">-                                printLog(&quot;mapping $string to $it&quot;)
</a><a href="#h7-0-43" id="h7-0-43" class="d">-                                super.intern(it)
</a><a href="#h7-0-44" id="h7-0-44" class="d">-                                return
</a><a href="#h7-0-45" id="h7-0-45" class="d">-                            }
</a><a href="#h7-0-46" id="h7-0-46" class="d">-                            super.intern(string)
</a><a href="#h7-0-47" id="h7-0-47" class="d">-                        }
</a><a href="#h7-0-48" id="h7-0-48" class="d">-
</a><a href="#h7-0-49" id="h7-0-49" class="d">-                        override fun getItemIndex(key: CharSequence): Int {
</a><a href="#h7-0-50" id="h7-0-50" class="d">-                            return cacheMap[key.toString()]?.let {
</a><a href="#h7-0-51" id="h7-0-51" class="d">-                                internedItems[it]
</a><a href="#h7-0-52" id="h7-0-52" class="d">-                            } ?: super.getItemIndex(key)
</a><a href="#h7-0-53" id="h7-0-53" class="d">-                        }
</a><a href="#h7-0-54" id="h7-0-54" class="d">-
</a><a href="#h7-0-55" id="h7-0-55" class="d">-                        override fun getItemIndex(key: StringReference): Int {
</a><a href="#h7-0-56" id="h7-0-56" class="d">-                            return cacheMap[key.toString()]?.let {
</a><a href="#h7-0-57" id="h7-0-57" class="d">-                                internedItems[it]
</a><a href="#h7-0-58" id="h7-0-58" class="d">-                            } ?: super.getItemIndex(key)
</a><a href="#h7-0-59" id="h7-0-59" class="d">-                        }
</a><a href="#h7-0-60" id="h7-0-60" class="d">-                    }
</a><a href="#h7-0-61" id="h7-0-61" class="d">-                }
</a><a href="#h7-0-62" id="h7-0-62" class="d">-            }
</a><a href="#h7-0-63" id="h7-0-63" class="d">-        }
</a><a href="#h7-0-64" id="h7-0-64" class="d">-        dexFile.classes.forEach { dexBackedClassDef -&gt;
</a><a href="#h7-0-65" id="h7-0-65" class="d">-            dexPool.internClass(dexBackedClassDef)
</a><a href="#h7-0-66" id="h7-0-66" class="d">-        }
</a><a href="#h7-0-67" id="h7-0-67" class="d">-        val outputFile = File.createTempFile(&quot;obf&quot;, &quot;.dex&quot;, cacheFolder)
</a><a href="#h7-0-68" id="h7-0-68" class="d">-        dexPool.writeTo(FileDataStore(outputFile))
</a><a href="#h7-0-69" id="h7-0-69" class="d">-        return outputFile
</a><a href="#h7-0-70" id="h7-0-70" class="d">-    }
</a><a href="#h7-0-71" id="h7-0-71" class="d">-
</a><a href="#h7-0-72" id="h7-0-72" class="d">-
</a><a href="#h7-0-73" id="h7-0-73" class="d">-    fun obfuscateMetaLoader(inputStream: InputStream, config: DexObfuscationConfig): File {
</a><a href="#h7-0-74" id="h7-0-74" class="d">-        return obfuscateDexFile(mapOf(
</a><a href="#h7-0-75" id="h7-0-75" class="d">-            &quot;assets/lspatch/config.json&quot; to &quot;assets/${config.configFilePath}&quot;,
</a><a href="#h7-0-76" id="h7-0-76" class="d">-            &quot;assets/lspatch/loader.dex&quot; to &quot;assets/${config.loaderFilePath}&quot;,
</a><a href="#h7-0-77" id="h7-0-77" class="d">-        ) + (config.libNativeFilePath.takeIf { it.isNotEmpty() }?.let {
</a><a href="#h7-0-78" id="h7-0-78" class="d">-            mapOf(
</a><a href="#h7-0-79" id="h7-0-79" class="d">-                &quot;!/assets/lspatch/so/&quot; to &quot;!/assets/&quot;,
</a><a href="#h7-0-80" id="h7-0-80" class="d">-                &quot;assets/lspatch/so/&quot; to &quot;assets/&quot;,
</a><a href="#h7-0-81" id="h7-0-81" class="d">-                &quot;/liblspatch.so&quot; to &quot;&quot;,
</a><a href="#h7-0-82" id="h7-0-82" class="d">-                &quot;arm64-v8a&quot; to config.libNativeFilePath[&quot;arm64-v8a&quot;],
</a><a href="#h7-0-83" id="h7-0-83" class="d">-                &quot;armeabi-v7a&quot; to config.libNativeFilePath[&quot;armeabi-v7a&quot;],
</a><a href="#h7-0-84" id="h7-0-84" class="d">-                &quot;x86&quot; to config.libNativeFilePath[&quot;x86&quot;],
</a><a href="#h7-0-85" id="h7-0-85" class="d">-                &quot;x86_64&quot; to config.libNativeFilePath[&quot;x86_64&quot;],
</a><a href="#h7-0-86" id="h7-0-86" class="d">-            )
</a><a href="#h7-0-87" id="h7-0-87" class="d">-        } ?: mapOf()), inputStream)
</a><a href="#h7-0-88" id="h7-0-88" class="d">-    }
</a><a href="#h7-0-89" id="h7-0-89" class="d">-
</a><a href="#h7-0-90" id="h7-0-90" class="d">-    fun obfuscateLoader(inputStream: InputStream, config: DexObfuscationConfig): File {
</a><a href="#h7-0-91" id="h7-0-91" class="d">-        return obfuscateDexFile(mapOf(
</a><a href="#h7-0-92" id="h7-0-92" class="d">-            &quot;assets/lspatch/config.json&quot; to config.configFilePath?.let { &quot;assets/$it&quot; },
</a><a href="#h7-0-93" id="h7-0-93" class="d">-            &quot;assets/lspatch/loader.dex&quot; to config.loaderFilePath?.let { &quot;assets/$it&quot; },
</a><a href="#h7-0-94" id="h7-0-94" class="d">-            &quot;assets/lspatch/metaloader.dex&quot; to config.metaLoaderFilePath?.let { &quot;assets/$it&quot; },
</a><a href="#h7-0-95" id="h7-0-95" class="d">-            &quot;assets/lspatch/origin.apk&quot; to config.originApkPath?.let { &quot;assets/$it&quot; },
</a><a href="#h7-0-96" id="h7-0-96" class="d">-            &quot;/lspatch/origin/&quot; to config.cachedOriginApkPath?.let { &quot;/$it/&quot; }, // context.getCacheDir() + ==&gt; &quot;/lspatch/origin/&quot; &lt;== + sourceFile.getEntry(ORIGINAL_APK_ASSET_PATH).getCrc() + &quot;.apk&quot;;
</a><a href="#h7-0-97" id="h7-0-97" class="d">-            &quot;/lspatch/&quot; to config.cachedOriginApkPath?.let { &quot;/$it/&quot; }, // context.getCacheDir() + &quot;/lspatch/&quot; + packageName + &quot;/&quot;
</a><a href="#h7-0-98" id="h7-0-98" class="d">-            &quot;cache/lspatch/origin/&quot; to config.cachedOriginApkPath?.let { &quot;cache/$it&quot; }, //LSPApplication =&gt; Path originPath = Paths.get(appInfo.dataDir, &quot;cache/lspatch/origin/&quot;);
</a><a href="#h7-0-99" id="h7-0-99" class="d">-            &quot;assets/lspatch/modules/&quot; to config.assetModuleFolderPath?.let { &quot;assets/$it/&quot; }, // Constants.java =&gt; EMBEDDED_MODULES_ASSET_PATH
</a><a href="#h7-0-100" id="h7-0-100" class="d">-            &quot;lspatch/modules&quot; to config.assetModuleFolderPath, // LocalApplicationService.java =&gt; context.getAssets().list(&quot;lspatch/modules&quot;),
</a><a href="#h7-0-101" id="h7-0-101" class="d">-            &quot;lspatch/modules/&quot; to config.assetModuleFolderPath?.let { &quot;$it/&quot; }, // LocalApplicationService.java =&gt; try (var is = context.getAssets().open(&quot;lspatch/modules/&quot; + name)) {
</a><a href="#h7-0-102" id="h7-0-102" class="d">-            &quot;lspatch&quot; to config.metadataManifestField, // SigBypass.java =&gt; &quot;lspatch&quot;,
</a><a href="#h7-0-103" id="h7-0-103" class="d">-            &quot;org.lsposed.lspatch&quot; to config.cachedOriginApkPath?.let { &quot;$it/${config.packageName}/&quot; }, // Constants.java =&gt; &quot;org.lsposed.lspatch&quot;, (Used in LSPatchUpdater.kt)
</a><a href="#h7-0-104" id="h7-0-104" class="d">-        ), inputStream)
</a><a href="#h7-0-105" id="h7-0-105" class="d">-    }
</a><a href="#h7-0-106" id="h7-0-106" class="d">-}</a><a href="#h7-0-107" id="h7-0-107" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h8" href="../file/manager/src/main/kotlin/me/rhunk/snapenhance/manager/lspatch/config/Constants.kt.html">manager/src/main/kotlin/me/rhunk/snapenhance/manager/lspatch/config/Constants.kt</a> b/<a href="../file/manager/src/main/kotlin/me/rhunk/snapenhance/manager/lspatch/config/Constants.kt.html">manager/src/main/kotlin/me/rhunk/snapenhance/manager/lspatch/config/Constants.kt</a></b>
<a href="#h8-0" id="h8-0" class="h">@@ -1,7 +0,0 @@
</a><a href="#h8-0-0" id="h8-0-0" class="d">-package me.rhunk.snapenhance.manager.lspatch.config
</a><a href="#h8-0-1" id="h8-0-1" class="d">-
</a><a href="#h8-0-2" id="h8-0-2" class="d">-//https://github.com/LSPosed/LSPatch/blob/master/share/java/src/main/java/org/lsposed/lspatch/share/Constants.java
</a><a href="#h8-0-3" id="h8-0-3" class="d">-object Constants {
</a><a href="#h8-0-4" id="h8-0-4" class="d">-    const val PROXY_APP_COMPONENT_FACTORY =
</a><a href="#h8-0-5" id="h8-0-5" class="d">-        &quot;org.lsposed.lspatch.metaloader.LSPAppComponentFactoryStub&quot;
</a><a href="#h8-0-6" id="h8-0-6" class="d">-}</a><a href="#h8-0-7" id="h8-0-7" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h9" href="../file/manager/src/main/kotlin/me/rhunk/snapenhance/manager/lspatch/config/PatchConfig.kt.html">manager/src/main/kotlin/me/rhunk/snapenhance/manager/lspatch/config/PatchConfig.kt</a> b/<a href="../file/manager/src/main/kotlin/me/rhunk/snapenhance/manager/lspatch/config/PatchConfig.kt.html">manager/src/main/kotlin/me/rhunk/snapenhance/manager/lspatch/config/PatchConfig.kt</a></b>
<a href="#h9-0" id="h9-0" class="h">@@ -1,19 +0,0 @@
</a><a href="#h9-0-0" id="h9-0-0" class="d">-package me.rhunk.snapenhance.manager.lspatch.config
</a><a href="#h9-0-1" id="h9-0-1" class="d">-
</a><a href="#h9-0-2" id="h9-0-2" class="d">-data class PatchConfig(
</a><a href="#h9-0-3" id="h9-0-3" class="d">-    val useManager: Boolean = false,
</a><a href="#h9-0-4" id="h9-0-4" class="d">-    val debuggable: Boolean = false,
</a><a href="#h9-0-5" id="h9-0-5" class="d">-    val overrideVersionCode: Boolean = false,
</a><a href="#h9-0-6" id="h9-0-6" class="d">-    val sigBypassLevel: Int = 0,
</a><a href="#h9-0-7" id="h9-0-7" class="d">-    val originalSignature: String? = null,
</a><a href="#h9-0-8" id="h9-0-8" class="d">-    val appComponentFactory: String? = null,
</a><a href="#h9-0-9" id="h9-0-9" class="d">-    val lspConfig: LSPConfig? = LSPConfig()
</a><a href="#h9-0-10" id="h9-0-10" class="d">-) {
</a><a href="#h9-0-11" id="h9-0-11" class="d">-    data class LSPConfig(
</a><a href="#h9-0-12" id="h9-0-12" class="d">-        var API_CODE: Int = 93,
</a><a href="#h9-0-13" id="h9-0-13" class="d">-        var VERSION_CODE: Int = 360,
</a><a href="#h9-0-14" id="h9-0-14" class="d">-        var VERSION_NAME: String = &quot;0.5.1&quot;,
</a><a href="#h9-0-15" id="h9-0-15" class="d">-        var CORE_VERSION_CODE: Int = 6649,
</a><a href="#h9-0-16" id="h9-0-16" class="d">-        var CORE_VERSION_NAME: String = &quot;1.8.5&quot;,
</a><a href="#h9-0-17" id="h9-0-17" class="d">-    )
</a><a href="#h9-0-18" id="h9-0-18" class="d">-}</a><a href="#h9-0-19" id="h9-0-19" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h10" href="../file/manager/src/main/kotlin/me/rhunk/snapenhance/manager/lspatch/util/ApkSignatureHelper.kt.html">manager/src/main/kotlin/me/rhunk/snapenhance/manager/lspatch/util/ApkSignatureHelper.kt</a> b/<a href="../file/manager/src/main/kotlin/me/rhunk/snapenhance/manager/lspatch/util/ApkSignatureHelper.kt.html">manager/src/main/kotlin/me/rhunk/snapenhance/manager/lspatch/util/ApkSignatureHelper.kt</a></b>
<a href="#h10-0" id="h10-0" class="h">@@ -1,146 +0,0 @@
</a><a href="#h10-0-0" id="h10-0-0" class="d">-package me.rhunk.snapenhance.manager.lspatch.util;
</a><a href="#h10-0-1" id="h10-0-1" class="d">-
</a><a href="#h10-0-2" id="h10-0-2" class="d">-import java.io.IOException
</a><a href="#h10-0-3" id="h10-0-3" class="d">-import java.io.RandomAccessFile
</a><a href="#h10-0-4" id="h10-0-4" class="d">-import java.io.UnsupportedEncodingException
</a><a href="#h10-0-5" id="h10-0-5" class="d">-import java.nio.ByteBuffer
</a><a href="#h10-0-6" id="h10-0-6" class="d">-import java.nio.ByteOrder
</a><a href="#h10-0-7" id="h10-0-7" class="d">-import java.security.cert.Certificate
</a><a href="#h10-0-8" id="h10-0-8" class="d">-import java.util.Enumeration
</a><a href="#h10-0-9" id="h10-0-9" class="d">-import java.util.jar.JarEntry
</a><a href="#h10-0-10" id="h10-0-10" class="d">-import java.util.jar.JarFile
</a><a href="#h10-0-11" id="h10-0-11" class="d">-
</a><a href="#h10-0-12" id="h10-0-12" class="d">-
</a><a href="#h10-0-13" id="h10-0-13" class="d">-//https://github.com/LSPosed/LSPatch/blob/master/patch/src/main/java/org/lsposed/patch/util/ApkSignatureHelper.java
</a><a href="#h10-0-14" id="h10-0-14" class="d">-object ApkSignatureHelper {
</a><a href="#h10-0-15" id="h10-0-15" class="d">-    private val APK_V2_MAGIC = charArrayOf(&#39;A&#39;, &#39;P&#39;, &#39;K&#39;, &#39; &#39;, &#39;S&#39;, &#39;i&#39;, &#39;g&#39;, &#39; &#39;,
</a><a href="#h10-0-16" id="h10-0-16" class="d">-        &#39;B&#39;, &#39;l&#39;, &#39;o&#39;, &#39;c&#39;, &#39;k&#39;, &#39; &#39;, &#39;4&#39;, &#39;2&#39;)
</a><a href="#h10-0-17" id="h10-0-17" class="d">-
</a><a href="#h10-0-18" id="h10-0-18" class="d">-    private fun toChars(mSignature: ByteArray): CharArray {
</a><a href="#h10-0-19" id="h10-0-19" class="d">-        val N = mSignature.size
</a><a href="#h10-0-20" id="h10-0-20" class="d">-        val N2 = N * 2
</a><a href="#h10-0-21" id="h10-0-21" class="d">-        val text = CharArray(N2)
</a><a href="#h10-0-22" id="h10-0-22" class="d">-        for (j in 0 until N) {
</a><a href="#h10-0-23" id="h10-0-23" class="d">-            val v = mSignature[j]
</a><a href="#h10-0-24" id="h10-0-24" class="d">-            var d = v.toInt() shr 4 and 0xf
</a><a href="#h10-0-25" id="h10-0-25" class="d">-            text[j * 2] = (if (d &gt;= 10) &#39;a&#39;.code + d - 10 else &#39;0&#39;.code + d).toChar()
</a><a href="#h10-0-26" id="h10-0-26" class="d">-            d = v.toInt() and 0xf
</a><a href="#h10-0-27" id="h10-0-27" class="d">-            text[j * 2 + 1] = (if (d &gt;= 10) &#39;a&#39;.code + d - 10 else &#39;0&#39;.code + d).toChar()
</a><a href="#h10-0-28" id="h10-0-28" class="d">-        }
</a><a href="#h10-0-29" id="h10-0-29" class="d">-        return text
</a><a href="#h10-0-30" id="h10-0-30" class="d">-    }
</a><a href="#h10-0-31" id="h10-0-31" class="d">-
</a><a href="#h10-0-32" id="h10-0-32" class="d">-    private fun loadCertificates(
</a><a href="#h10-0-33" id="h10-0-33" class="d">-        jarFile: JarFile,
</a><a href="#h10-0-34" id="h10-0-34" class="d">-        je: JarEntry?,
</a><a href="#h10-0-35" id="h10-0-35" class="d">-        readBuffer: ByteArray
</a><a href="#h10-0-36" id="h10-0-36" class="d">-    ): Array&lt;Certificate?&gt;? {
</a><a href="#h10-0-37" id="h10-0-37" class="d">-        try {
</a><a href="#h10-0-38" id="h10-0-38" class="d">-            val `is` = jarFile.getInputStream(je)
</a><a href="#h10-0-39" id="h10-0-39" class="d">-            while (`is`.read(readBuffer, 0, readBuffer.size) != -1) {
</a><a href="#h10-0-40" id="h10-0-40" class="d">-            }
</a><a href="#h10-0-41" id="h10-0-41" class="d">-            `is`.close()
</a><a href="#h10-0-42" id="h10-0-42" class="d">-            return je?.certificates as Array&lt;Certificate?&gt;?
</a><a href="#h10-0-43" id="h10-0-43" class="d">-        } catch (e: Exception) {
</a><a href="#h10-0-44" id="h10-0-44" class="d">-        }
</a><a href="#h10-0-45" id="h10-0-45" class="d">-        return null
</a><a href="#h10-0-46" id="h10-0-46" class="d">-    }
</a><a href="#h10-0-47" id="h10-0-47" class="d">-
</a><a href="#h10-0-48" id="h10-0-48" class="d">-    fun getApkSignInfo(apkFilePath: String): String? {
</a><a href="#h10-0-49" id="h10-0-49" class="d">-        return try {
</a><a href="#h10-0-50" id="h10-0-50" class="d">-            getApkSignV2(apkFilePath)
</a><a href="#h10-0-51" id="h10-0-51" class="d">-        } catch (e: Exception) {
</a><a href="#h10-0-52" id="h10-0-52" class="d">-            getApkSignV1(apkFilePath)
</a><a href="#h10-0-53" id="h10-0-53" class="d">-        }
</a><a href="#h10-0-54" id="h10-0-54" class="d">-    }
</a><a href="#h10-0-55" id="h10-0-55" class="d">-
</a><a href="#h10-0-56" id="h10-0-56" class="d">-    fun getApkSignV1(apkFilePath: String?): String? {
</a><a href="#h10-0-57" id="h10-0-57" class="d">-        val readBuffer = ByteArray(8192)
</a><a href="#h10-0-58" id="h10-0-58" class="d">-        var certs: Array&lt;Certificate?&gt;? = null
</a><a href="#h10-0-59" id="h10-0-59" class="d">-        try {
</a><a href="#h10-0-60" id="h10-0-60" class="d">-            val jarFile = JarFile(apkFilePath)
</a><a href="#h10-0-61" id="h10-0-61" class="d">-            val entries: Enumeration&lt;*&gt; = jarFile.entries()
</a><a href="#h10-0-62" id="h10-0-62" class="d">-            while (entries.hasMoreElements()) {
</a><a href="#h10-0-63" id="h10-0-63" class="d">-                val je = entries.nextElement() as JarEntry
</a><a href="#h10-0-64" id="h10-0-64" class="d">-                if (je.isDirectory) {
</a><a href="#h10-0-65" id="h10-0-65" class="d">-                    continue
</a><a href="#h10-0-66" id="h10-0-66" class="d">-                }
</a><a href="#h10-0-67" id="h10-0-67" class="d">-                if (je.name.startsWith(&quot;META-INF/&quot;)) {
</a><a href="#h10-0-68" id="h10-0-68" class="d">-                    continue
</a><a href="#h10-0-69" id="h10-0-69" class="d">-                }
</a><a href="#h10-0-70" id="h10-0-70" class="d">-                val localCerts = loadCertificates(jarFile, je, readBuffer)
</a><a href="#h10-0-71" id="h10-0-71" class="d">-                if (certs == null) {
</a><a href="#h10-0-72" id="h10-0-72" class="d">-                    certs = localCerts
</a><a href="#h10-0-73" id="h10-0-73" class="d">-                } else {
</a><a href="#h10-0-74" id="h10-0-74" class="d">-                    for (i in certs.indices) {
</a><a href="#h10-0-75" id="h10-0-75" class="d">-                        var found = false
</a><a href="#h10-0-76" id="h10-0-76" class="d">-                        for (j in localCerts!!.indices) {
</a><a href="#h10-0-77" id="h10-0-77" class="d">-                            if (certs[i] != null &amp;&amp; certs[i] == localCerts[j]) {
</a><a href="#h10-0-78" id="h10-0-78" class="d">-                                found = true
</a><a href="#h10-0-79" id="h10-0-79" class="d">-                                break
</a><a href="#h10-0-80" id="h10-0-80" class="d">-                            }
</a><a href="#h10-0-81" id="h10-0-81" class="d">-                        }
</a><a href="#h10-0-82" id="h10-0-82" class="d">-                        if (!found || certs.size != localCerts.size) {
</a><a href="#h10-0-83" id="h10-0-83" class="d">-                            jarFile.close()
</a><a href="#h10-0-84" id="h10-0-84" class="d">-                            return null
</a><a href="#h10-0-85" id="h10-0-85" class="d">-                        }
</a><a href="#h10-0-86" id="h10-0-86" class="d">-                    }
</a><a href="#h10-0-87" id="h10-0-87" class="d">-                }
</a><a href="#h10-0-88" id="h10-0-88" class="d">-            }
</a><a href="#h10-0-89" id="h10-0-89" class="d">-            jarFile.close()
</a><a href="#h10-0-90" id="h10-0-90" class="d">-            return if (certs != null) String(toChars(certs[0]!!.encoded)) else null
</a><a href="#h10-0-91" id="h10-0-91" class="d">-        } catch (ignored: Throwable) {
</a><a href="#h10-0-92" id="h10-0-92" class="d">-        }
</a><a href="#h10-0-93" id="h10-0-93" class="d">-        return null
</a><a href="#h10-0-94" id="h10-0-94" class="d">-    }
</a><a href="#h10-0-95" id="h10-0-95" class="d">-
</a><a href="#h10-0-96" id="h10-0-96" class="d">-    @Throws(IOException::class)
</a><a href="#h10-0-97" id="h10-0-97" class="d">-    private fun getApkSignV2(apkFilePath: String): String {
</a><a href="#h10-0-98" id="h10-0-98" class="d">-        RandomAccessFile(apkFilePath, &quot;r&quot;).use { apk -&gt;
</a><a href="#h10-0-99" id="h10-0-99" class="d">-            val buffer = ByteBuffer.allocate(0x10)
</a><a href="#h10-0-100" id="h10-0-100" class="d">-            buffer.order(ByteOrder.LITTLE_ENDIAN)
</a><a href="#h10-0-101" id="h10-0-101" class="d">-            apk.seek(apk.length() - 0x6)
</a><a href="#h10-0-102" id="h10-0-102" class="d">-            apk.readFully(buffer.array(), 0x0, 0x6)
</a><a href="#h10-0-103" id="h10-0-103" class="d">-            val offset = buffer.getInt()
</a><a href="#h10-0-104" id="h10-0-104" class="d">-            if (buffer.getShort().toInt() != 0) {
</a><a href="#h10-0-105" id="h10-0-105" class="d">-                throw UnsupportedEncodingException(&quot;no zip&quot;)
</a><a href="#h10-0-106" id="h10-0-106" class="d">-            }
</a><a href="#h10-0-107" id="h10-0-107" class="d">-            apk.seek((offset - 0x10).toLong())
</a><a href="#h10-0-108" id="h10-0-108" class="d">-            apk.readFully(buffer.array(), 0x0, 0x10)
</a><a href="#h10-0-109" id="h10-0-109" class="d">-            if (!buffer.array().contentEquals(APK_V2_MAGIC.map { it.code.toByte() }.toByteArray())) {
</a><a href="#h10-0-110" id="h10-0-110" class="d">-                throw UnsupportedEncodingException(&quot;no apk v2&quot;)
</a><a href="#h10-0-111" id="h10-0-111" class="d">-            }
</a><a href="#h10-0-112" id="h10-0-112" class="d">-
</a><a href="#h10-0-113" id="h10-0-113" class="d">-            // Read and compare size fields
</a><a href="#h10-0-114" id="h10-0-114" class="d">-            apk.seek((offset - 0x18).toLong())
</a><a href="#h10-0-115" id="h10-0-115" class="d">-            apk.readFully(buffer.array(), 0x0, 0x8)
</a><a href="#h10-0-116" id="h10-0-116" class="d">-            buffer.rewind()
</a><a href="#h10-0-117" id="h10-0-117" class="d">-            var size = buffer.getLong().toInt()
</a><a href="#h10-0-118" id="h10-0-118" class="d">-            val block = ByteBuffer.allocate(size + 0x8)
</a><a href="#h10-0-119" id="h10-0-119" class="d">-            block.order(ByteOrder.LITTLE_ENDIAN)
</a><a href="#h10-0-120" id="h10-0-120" class="d">-            apk.seek((offset - block.capacity()).toLong())
</a><a href="#h10-0-121" id="h10-0-121" class="d">-            apk.readFully(block.array(), 0x0, block.capacity())
</a><a href="#h10-0-122" id="h10-0-122" class="d">-            if (size.toLong() != block.getLong()) {
</a><a href="#h10-0-123" id="h10-0-123" class="d">-                throw UnsupportedEncodingException(&quot;no apk v2&quot;)
</a><a href="#h10-0-124" id="h10-0-124" class="d">-            }
</a><a href="#h10-0-125" id="h10-0-125" class="d">-            while (block.remaining() &gt; 24) {
</a><a href="#h10-0-126" id="h10-0-126" class="d">-                size = block.getLong().toInt()
</a><a href="#h10-0-127" id="h10-0-127" class="d">-                if (block.getInt() == 0x7109871a) {
</a><a href="#h10-0-128" id="h10-0-128" class="d">-                    // signer-sequence length, signer length, signed data length
</a><a href="#h10-0-129" id="h10-0-129" class="d">-                    block.position(block.position() + 12)
</a><a href="#h10-0-130" id="h10-0-130" class="d">-                    size = block.getInt() // digests-sequence length
</a><a href="#h10-0-131" id="h10-0-131" class="d">-
</a><a href="#h10-0-132" id="h10-0-132" class="d">-                    // digests, certificates length
</a><a href="#h10-0-133" id="h10-0-133" class="d">-                    block.position(block.position() + size + 0x4)
</a><a href="#h10-0-134" id="h10-0-134" class="d">-                    size = block.getInt() // certificate length
</a><a href="#h10-0-135" id="h10-0-135" class="d">-                    break
</a><a href="#h10-0-136" id="h10-0-136" class="d">-                } else {
</a><a href="#h10-0-137" id="h10-0-137" class="d">-                    block.position(block.position() + size - 0x4)
</a><a href="#h10-0-138" id="h10-0-138" class="d">-                }
</a><a href="#h10-0-139" id="h10-0-139" class="d">-            }
</a><a href="#h10-0-140" id="h10-0-140" class="d">-            val certificate = ByteArray(size)
</a><a href="#h10-0-141" id="h10-0-141" class="d">-            block[certificate]
</a><a href="#h10-0-142" id="h10-0-142" class="d">-            return String(toChars(certificate))
</a><a href="#h10-0-143" id="h10-0-143" class="d">-        }
</a><a href="#h10-0-144" id="h10-0-144" class="d">-    }
</a><a href="#h10-0-145" id="h10-0-145" class="d">-}</a><a href="#h10-0-146" id="h10-0-146" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h11" href="../file/manager/src/main/kotlin/me/rhunk/snapenhance/manager/patch/LSPatch.kt.html">manager/src/main/kotlin/me/rhunk/snapenhance/manager/patch/LSPatch.kt</a> b/<a href="../file/manager/src/main/kotlin/me/rhunk/snapenhance/manager/patch/LSPatch.kt.html">manager/src/main/kotlin/me/rhunk/snapenhance/manager/patch/LSPatch.kt</a></b>
<a href="#h11-0" id="h11-0" class="h">@@ -0,0 +1,233 @@
</a><a href="#h11-0-0" id="h11-0-0" class="i">+package me.rhunk.snapenhance.manager.patch
</a><a href="#h11-0-1" id="h11-0-1" class="i">+
</a><a href="#h11-0-2" id="h11-0-2" class="i">+import android.content.Context
</a><a href="#h11-0-3" id="h11-0-3" class="i">+import com.android.tools.build.apkzlib.zip.AlignmentRules
</a><a href="#h11-0-4" id="h11-0-4" class="i">+import com.android.tools.build.apkzlib.zip.ZFile
</a><a href="#h11-0-5" id="h11-0-5" class="i">+import com.android.tools.build.apkzlib.zip.ZFileOptions
</a><a href="#h11-0-6" id="h11-0-6" class="i">+import com.google.gson.Gson
</a><a href="#h11-0-7" id="h11-0-7" class="i">+import com.wind.meditor.core.ManifestEditor
</a><a href="#h11-0-8" id="h11-0-8" class="i">+import com.wind.meditor.property.AttributeItem
</a><a href="#h11-0-9" id="h11-0-9" class="i">+import com.wind.meditor.property.ModificationProperty
</a><a href="#h11-0-10" id="h11-0-10" class="i">+import me.rhunk.snapenhance.manager.patch.config.Constants.PROXY_APP_COMPONENT_FACTORY
</a><a href="#h11-0-11" id="h11-0-11" class="i">+import me.rhunk.snapenhance.manager.patch.config.PatchConfig
</a><a href="#h11-0-12" id="h11-0-12" class="i">+import me.rhunk.snapenhance.manager.patch.util.ApkSignatureHelper
</a><a href="#h11-0-13" id="h11-0-13" class="i">+import me.rhunk.snapenhance.manager.patch.util.ApkSignatureHelper.provideSigningExtension
</a><a href="#h11-0-14" id="h11-0-14" class="i">+import java.io.ByteArrayInputStream
</a><a href="#h11-0-15" id="h11-0-15" class="i">+import java.io.ByteArrayOutputStream
</a><a href="#h11-0-16" id="h11-0-16" class="i">+import java.io.File
</a><a href="#h11-0-17" id="h11-0-17" class="i">+import java.util.zip.ZipFile
</a><a href="#h11-0-18" id="h11-0-18" class="i">+import kotlin.io.encoding.Base64
</a><a href="#h11-0-19" id="h11-0-19" class="i">+import kotlin.io.encoding.ExperimentalEncodingApi
</a><a href="#h11-0-20" id="h11-0-20" class="i">+import kotlin.random.Random
</a><a href="#h11-0-21" id="h11-0-21" class="i">+
</a><a href="#h11-0-22" id="h11-0-22" class="i">+
</a><a href="#h11-0-23" id="h11-0-23" class="i">+//https://github.com/LSPosed/LSPatch/blob/master/patch/src/main/java/org/lsposed/patch/LSPatch.java
</a><a href="#h11-0-24" id="h11-0-24" class="i">+class LSPatch(
</a><a href="#h11-0-25" id="h11-0-25" class="i">+    private val context: Context,
</a><a href="#h11-0-26" id="h11-0-26" class="i">+    private val modules: Map&lt;String, File&gt;, //packageName -&gt; file
</a><a href="#h11-0-27" id="h11-0-27" class="i">+    private val obfuscate: Boolean,
</a><a href="#h11-0-28" id="h11-0-28" class="i">+    private val printLog: (Any) -&gt; Unit
</a><a href="#h11-0-29" id="h11-0-29" class="i">+) {
</a><a href="#h11-0-30" id="h11-0-30" class="i">+
</a><a href="#h11-0-31" id="h11-0-31" class="i">+    private fun patchManifest(data: ByteArray, lspatchMetadata: Pair&lt;String, String&gt;): ByteArray {
</a><a href="#h11-0-32" id="h11-0-32" class="i">+        val property = ModificationProperty()
</a><a href="#h11-0-33" id="h11-0-33" class="i">+
</a><a href="#h11-0-34" id="h11-0-34" class="i">+        property.addApplicationAttribute(AttributeItem(&quot;appComponentFactory&quot;, PROXY_APP_COMPONENT_FACTORY))
</a><a href="#h11-0-35" id="h11-0-35" class="i">+        property.addMetaData(ModificationProperty.MetaData(lspatchMetadata.first, lspatchMetadata.second))
</a><a href="#h11-0-36" id="h11-0-36" class="i">+
</a><a href="#h11-0-37" id="h11-0-37" class="i">+        return ByteArrayOutputStream().apply {
</a><a href="#h11-0-38" id="h11-0-38" class="i">+            ManifestEditor(ByteArrayInputStream(data), this, property).processManifest()
</a><a href="#h11-0-39" id="h11-0-39" class="i">+            flush()
</a><a href="#h11-0-40" id="h11-0-40" class="i">+            close()
</a><a href="#h11-0-41" id="h11-0-41" class="i">+        }.toByteArray()
</a><a href="#h11-0-42" id="h11-0-42" class="i">+    }
</a><a href="#h11-0-43" id="h11-0-43" class="i">+
</a><a href="#h11-0-44" id="h11-0-44" class="i">+    private fun resignApk(inputApkFile: File, outputFile: File) {
</a><a href="#h11-0-45" id="h11-0-45" class="i">+        printLog(&quot;Resigning ${inputApkFile.absolutePath} to ${outputFile.absolutePath}&quot;)
</a><a href="#h11-0-46" id="h11-0-46" class="i">+        val dstZFile = ZFile.openReadWrite(outputFile, ZFileOptions())
</a><a href="#h11-0-47" id="h11-0-47" class="i">+        val inZFile = ZFile.openReadOnly(inputApkFile)
</a><a href="#h11-0-48" id="h11-0-48" class="i">+
</a><a href="#h11-0-49" id="h11-0-49" class="i">+        inZFile.entries().forEach { entry -&gt;
</a><a href="#h11-0-50" id="h11-0-50" class="i">+            dstZFile.add(entry.centralDirectoryHeader.name, entry.open())
</a><a href="#h11-0-51" id="h11-0-51" class="i">+        }
</a><a href="#h11-0-52" id="h11-0-52" class="i">+
</a><a href="#h11-0-53" id="h11-0-53" class="i">+        // sign apk
</a><a href="#h11-0-54" id="h11-0-54" class="i">+        runCatching {
</a><a href="#h11-0-55" id="h11-0-55" class="i">+            provideSigningExtension(context.assets.open(&quot;lspatch/keystore.jks&quot;)).register(dstZFile)
</a><a href="#h11-0-56" id="h11-0-56" class="i">+        }.onFailure {
</a><a href="#h11-0-57" id="h11-0-57" class="i">+            throw Exception(&quot;Failed to sign apk&quot;, it)
</a><a href="#h11-0-58" id="h11-0-58" class="i">+        }
</a><a href="#h11-0-59" id="h11-0-59" class="i">+
</a><a href="#h11-0-60" id="h11-0-60" class="i">+        dstZFile.realign()
</a><a href="#h11-0-61" id="h11-0-61" class="i">+        dstZFile.close()
</a><a href="#h11-0-62" id="h11-0-62" class="i">+        inZFile.close()
</a><a href="#h11-0-63" id="h11-0-63" class="i">+        printLog(&quot;Done&quot;)
</a><a href="#h11-0-64" id="h11-0-64" class="i">+    }
</a><a href="#h11-0-65" id="h11-0-65" class="i">+
</a><a href="#h11-0-66" id="h11-0-66" class="i">+    private fun uniqueHash(): String {
</a><a href="#h11-0-67" id="h11-0-67" class="i">+        return Random.nextBytes(Random.nextInt(5, 10)).joinToString(&quot;&quot;) { &quot;%02x&quot;.format(it) }
</a><a href="#h11-0-68" id="h11-0-68" class="i">+    }
</a><a href="#h11-0-69" id="h11-0-69" class="i">+
</a><a href="#h11-0-70" id="h11-0-70" class="i">+    @Suppress(&quot;UNCHECKED_CAST&quot;)
</a><a href="#h11-0-71" id="h11-0-71" class="i">+    @OptIn(ExperimentalEncodingApi::class)
</a><a href="#h11-0-72" id="h11-0-72" class="i">+    private fun patchApk(inputApkFile: File, outputFile: File) {
</a><a href="#h11-0-73" id="h11-0-73" class="i">+        printLog(&quot;Patching ${inputApkFile.absolutePath} to ${outputFile.absolutePath}&quot;)
</a><a href="#h11-0-74" id="h11-0-74" class="i">+
</a><a href="#h11-0-75" id="h11-0-75" class="i">+        val obfuscationCacheFolder = File(context.cacheDir, &quot;lspatch&quot;).apply {
</a><a href="#h11-0-76" id="h11-0-76" class="i">+            if (exists()) deleteRecursively()
</a><a href="#h11-0-77" id="h11-0-77" class="i">+            mkdirs()
</a><a href="#h11-0-78" id="h11-0-78" class="i">+        }
</a><a href="#h11-0-79" id="h11-0-79" class="i">+        val lspatchObfuscation = LSPatchObfuscation(obfuscationCacheFolder) { printLog(it) }
</a><a href="#h11-0-80" id="h11-0-80" class="i">+        val dexObfuscationConfig = if (obfuscate) DexObfuscationConfig(
</a><a href="#h11-0-81" id="h11-0-81" class="i">+            packageName = uniqueHash(),
</a><a href="#h11-0-82" id="h11-0-82" class="i">+            metadataManifestField = uniqueHash(),
</a><a href="#h11-0-83" id="h11-0-83" class="i">+            metaLoaderFilePath = uniqueHash(),
</a><a href="#h11-0-84" id="h11-0-84" class="i">+            configFilePath = uniqueHash(),
</a><a href="#h11-0-85" id="h11-0-85" class="i">+            loaderFilePath = uniqueHash(),
</a><a href="#h11-0-86" id="h11-0-86" class="i">+            libNativeFilePath = mapOf(
</a><a href="#h11-0-87" id="h11-0-87" class="i">+                &quot;arm64-v8a&quot; to uniqueHash() + &quot;.so&quot;,
</a><a href="#h11-0-88" id="h11-0-88" class="i">+                &quot;armeabi-v7a&quot; to uniqueHash() + &quot;.so&quot;,
</a><a href="#h11-0-89" id="h11-0-89" class="i">+            ),
</a><a href="#h11-0-90" id="h11-0-90" class="i">+            originApkPath = uniqueHash(),
</a><a href="#h11-0-91" id="h11-0-91" class="i">+            cachedOriginApkPath = uniqueHash(),
</a><a href="#h11-0-92" id="h11-0-92" class="i">+            openAtApkPath = uniqueHash(),
</a><a href="#h11-0-93" id="h11-0-93" class="i">+            assetModuleFolderPath = uniqueHash(),
</a><a href="#h11-0-94" id="h11-0-94" class="i">+        ) else null
</a><a href="#h11-0-95" id="h11-0-95" class="i">+
</a><a href="#h11-0-96" id="h11-0-96" class="i">+        val dstZFile = ZFile.openReadWrite(outputFile, ZFileOptions().setAlignmentRule(
</a><a href="#h11-0-97" id="h11-0-97" class="i">+            AlignmentRules.compose(
</a><a href="#h11-0-98" id="h11-0-98" class="i">+                AlignmentRules.constantForSuffix(&quot;.so&quot;, 4096),
</a><a href="#h11-0-99" id="h11-0-99" class="i">+                AlignmentRules.constantForSuffix(&quot;assets/&quot; + (dexObfuscationConfig?.originApkPath ?: &quot;lspatch/origin.apk&quot;), 4096)
</a><a href="#h11-0-100" id="h11-0-100" class="i">+            )
</a><a href="#h11-0-101" id="h11-0-101" class="i">+        ))
</a><a href="#h11-0-102" id="h11-0-102" class="i">+
</a><a href="#h11-0-103" id="h11-0-103" class="i">+        val patchConfig = PatchConfig(
</a><a href="#h11-0-104" id="h11-0-104" class="i">+            useManager = false,
</a><a href="#h11-0-105" id="h11-0-105" class="i">+            debuggable = false,
</a><a href="#h11-0-106" id="h11-0-106" class="i">+            overrideVersionCode = false,
</a><a href="#h11-0-107" id="h11-0-107" class="i">+            sigBypassLevel = 2,
</a><a href="#h11-0-108" id="h11-0-108" class="i">+            originalSignature = ApkSignatureHelper.getApkSignInfo(inputApkFile.absolutePath),
</a><a href="#h11-0-109" id="h11-0-109" class="i">+            appComponentFactory = &quot;androidx.core.app.CoreComponentFactory&quot;
</a><a href="#h11-0-110" id="h11-0-110" class="i">+        ).let { Gson().toJson(it) }
</a><a href="#h11-0-111" id="h11-0-111" class="i">+
</a><a href="#h11-0-112" id="h11-0-112" class="i">+        // sign apk
</a><a href="#h11-0-113" id="h11-0-113" class="i">+        runCatching {
</a><a href="#h11-0-114" id="h11-0-114" class="i">+            provideSigningExtension(context.assets.open(&quot;lspatch/keystore.jks&quot;)).register(dstZFile)
</a><a href="#h11-0-115" id="h11-0-115" class="i">+        }.onFailure {
</a><a href="#h11-0-116" id="h11-0-116" class="i">+            throw Exception(&quot;Failed to sign apk&quot;, it)
</a><a href="#h11-0-117" id="h11-0-117" class="i">+        }
</a><a href="#h11-0-118" id="h11-0-118" class="i">+
</a><a href="#h11-0-119" id="h11-0-119" class="i">+        printLog(&quot;Patching manifest&quot;)
</a><a href="#h11-0-120" id="h11-0-120" class="i">+
</a><a href="#h11-0-121" id="h11-0-121" class="i">+        val sourceApkFile = dstZFile.addNestedZip({ &quot;assets/&quot; + (dexObfuscationConfig?.originApkPath ?: &quot;lspatch/origin.apk&quot;) }, inputApkFile, false)
</a><a href="#h11-0-122" id="h11-0-122" class="i">+        val originalManifestEntry = sourceApkFile.get(&quot;AndroidManifest.xml&quot;) ?: throw Exception(&quot;No original manifest found&quot;)
</a><a href="#h11-0-123" id="h11-0-123" class="i">+        originalManifestEntry.open().use { inputStream -&gt;
</a><a href="#h11-0-124" id="h11-0-124" class="i">+            val patchedManifestData = patchManifest(inputStream.readBytes(), (dexObfuscationConfig?.metadataManifestField ?: &quot;lspatch&quot;) to Base64.encode(patchConfig.toByteArray()))
</a><a href="#h11-0-125" id="h11-0-125" class="i">+            dstZFile.add(&quot;AndroidManifest.xml&quot;, patchedManifestData.inputStream())
</a><a href="#h11-0-126" id="h11-0-126" class="i">+        }
</a><a href="#h11-0-127" id="h11-0-127" class="i">+
</a><a href="#h11-0-128" id="h11-0-128" class="i">+        //add config
</a><a href="#h11-0-129" id="h11-0-129" class="i">+        printLog(&quot;Adding config&quot;)
</a><a href="#h11-0-130" id="h11-0-130" class="i">+        dstZFile.add(&quot;assets/&quot; + (dexObfuscationConfig?.configFilePath ?: &quot;lspatch/config.json&quot;), ByteArrayInputStream(patchConfig.toByteArray()))
</a><a href="#h11-0-131" id="h11-0-131" class="i">+
</a><a href="#h11-0-132" id="h11-0-132" class="i">+        // add loader dex
</a><a href="#h11-0-133" id="h11-0-133" class="i">+        printLog(&quot;Adding loader dex&quot;)
</a><a href="#h11-0-134" id="h11-0-134" class="i">+        context.assets.open(&quot;lspatch/dexes/loader.dex&quot;).use { inputStream -&gt;
</a><a href="#h11-0-135" id="h11-0-135" class="i">+            dstZFile.add(&quot;assets/&quot; + (dexObfuscationConfig?.loaderFilePath ?: &quot;lspatch/loader.dex&quot;), dexObfuscationConfig?.let {
</a><a href="#h11-0-136" id="h11-0-136" class="i">+                lspatchObfuscation.obfuscateLoader(inputStream, it).inputStream()
</a><a href="#h11-0-137" id="h11-0-137" class="i">+            } ?: inputStream)
</a><a href="#h11-0-138" id="h11-0-138" class="i">+        }
</a><a href="#h11-0-139" id="h11-0-139" class="i">+
</a><a href="#h11-0-140" id="h11-0-140" class="i">+        //add natives
</a><a href="#h11-0-141" id="h11-0-141" class="i">+        printLog(&quot;Adding natives&quot;)
</a><a href="#h11-0-142" id="h11-0-142" class="i">+        context.assets.list(&quot;lspatch/so&quot;)?.forEach { native -&gt;
</a><a href="#h11-0-143" id="h11-0-143" class="i">+            dstZFile.add(&quot;assets/${dexObfuscationConfig?.libNativeFilePath?.get(native) ?: &quot;lspatch/so/$native/liblspatch.so&quot;}&quot;, context.assets.open(&quot;lspatch/so/$native/liblspatch.so&quot;), false)
</a><a href="#h11-0-144" id="h11-0-144" class="i">+        }
</a><a href="#h11-0-145" id="h11-0-145" class="i">+
</a><a href="#h11-0-146" id="h11-0-146" class="i">+        //embed modules
</a><a href="#h11-0-147" id="h11-0-147" class="i">+        printLog(&quot;Embedding modules&quot;)
</a><a href="#h11-0-148" id="h11-0-148" class="i">+        modules.forEach { (packageName, module) -&gt;
</a><a href="#h11-0-149" id="h11-0-149" class="i">+            val obfuscatedPackageName = dexObfuscationConfig?.packageName ?: packageName
</a><a href="#h11-0-150" id="h11-0-150" class="i">+            printLog(&quot;- $obfuscatedPackageName&quot;)
</a><a href="#h11-0-151" id="h11-0-151" class="i">+            dstZFile.add(&quot;assets/${dexObfuscationConfig?.assetModuleFolderPath ?: &quot;lspatch/modules&quot;}/$obfuscatedPackageName.apk&quot;, module.inputStream())
</a><a href="#h11-0-152" id="h11-0-152" class="i">+        }
</a><a href="#h11-0-153" id="h11-0-153" class="i">+
</a><a href="#h11-0-154" id="h11-0-154" class="i">+        // link apk entries
</a><a href="#h11-0-155" id="h11-0-155" class="i">+        printLog(&quot;Linking apk entries&quot;)
</a><a href="#h11-0-156" id="h11-0-156" class="i">+
</a><a href="#h11-0-157" id="h11-0-157" class="i">+        for (entry in sourceApkFile.entries()) {
</a><a href="#h11-0-158" id="h11-0-158" class="i">+            val name = entry.centralDirectoryHeader.name
</a><a href="#h11-0-159" id="h11-0-159" class="i">+            if (dexObfuscationConfig == null &amp;&amp; name.startsWith(&quot;classes&quot;) &amp;&amp; name.endsWith(&quot;.dex&quot;)) continue
</a><a href="#h11-0-160" id="h11-0-160" class="i">+            if (dstZFile[name] != null) continue
</a><a href="#h11-0-161" id="h11-0-161" class="i">+            if (name == &quot;AndroidManifest.xml&quot;) continue
</a><a href="#h11-0-162" id="h11-0-162" class="i">+            if (name.startsWith(&quot;META-INF&quot;) &amp;&amp; (name.endsWith(&quot;.SF&quot;) || name.endsWith(&quot;.MF&quot;) || name.endsWith(
</a><a href="#h11-0-163" id="h11-0-163" class="i">+                    &quot;.RSA&quot;
</a><a href="#h11-0-164" id="h11-0-164" class="i">+                ))
</a><a href="#h11-0-165" id="h11-0-165" class="i">+            ) continue
</a><a href="#h11-0-166" id="h11-0-166" class="i">+            sourceApkFile.addFileLink(name, name)
</a><a href="#h11-0-167" id="h11-0-167" class="i">+        }
</a><a href="#h11-0-168" id="h11-0-168" class="i">+
</a><a href="#h11-0-169" id="h11-0-169" class="i">+        printLog(&quot;Adding meta loader dex&quot;)
</a><a href="#h11-0-170" id="h11-0-170" class="i">+        context.assets.open(&quot;lspatch/dexes/metaloader.dex&quot;).use { inputStream -&gt;
</a><a href="#h11-0-171" id="h11-0-171" class="i">+            dstZFile.add(dexObfuscationConfig?.let { &quot;classes9.dex&quot; } ?: &quot;classes.dex&quot;, dexObfuscationConfig?.let {
</a><a href="#h11-0-172" id="h11-0-172" class="i">+                lspatchObfuscation.obfuscateMetaLoader(inputStream, it).inputStream()
</a><a href="#h11-0-173" id="h11-0-173" class="i">+            } ?: inputStream)
</a><a href="#h11-0-174" id="h11-0-174" class="i">+        }
</a><a href="#h11-0-175" id="h11-0-175" class="i">+
</a><a href="#h11-0-176" id="h11-0-176" class="i">+        printLog(&quot;Writing apk&quot;)
</a><a href="#h11-0-177" id="h11-0-177" class="i">+        dstZFile.realign()
</a><a href="#h11-0-178" id="h11-0-178" class="i">+        dstZFile.close()
</a><a href="#h11-0-179" id="h11-0-179" class="i">+        sourceApkFile.close()
</a><a href="#h11-0-180" id="h11-0-180" class="i">+
</a><a href="#h11-0-181" id="h11-0-181" class="i">+        printLog(&quot;Cleaning obfuscation cache&quot;)
</a><a href="#h11-0-182" id="h11-0-182" class="i">+        obfuscationCacheFolder.deleteRecursively()
</a><a href="#h11-0-183" id="h11-0-183" class="i">+        printLog(&quot;Done&quot;)
</a><a href="#h11-0-184" id="h11-0-184" class="i">+    }
</a><a href="#h11-0-185" id="h11-0-185" class="i">+
</a><a href="#h11-0-186" id="h11-0-186" class="i">+    fun patchSplits(inputs: List&lt;File&gt;): Map&lt;String, File&gt; {
</a><a href="#h11-0-187" id="h11-0-187" class="i">+        val outputs = mutableMapOf&lt;String, File&gt;()
</a><a href="#h11-0-188" id="h11-0-188" class="i">+        inputs.forEach { input -&gt;
</a><a href="#h11-0-189" id="h11-0-189" class="i">+            val outputFile = File.createTempFile(&quot;patched&quot;, &quot;.apk&quot;, context.externalCacheDir ?: context.cacheDir)
</a><a href="#h11-0-190" id="h11-0-190" class="i">+            if (input.name.contains(&quot;split&quot;)) {
</a><a href="#h11-0-191" id="h11-0-191" class="i">+                resignApk(input, outputFile)
</a><a href="#h11-0-192" id="h11-0-192" class="i">+                outputs[input.name] = outputFile
</a><a href="#h11-0-193" id="h11-0-193" class="i">+                return@forEach
</a><a href="#h11-0-194" id="h11-0-194" class="i">+            }
</a><a href="#h11-0-195" id="h11-0-195" class="i">+            patch(input, outputFile)
</a><a href="#h11-0-196" id="h11-0-196" class="i">+            outputs[&quot;base.apk&quot;] = outputFile
</a><a href="#h11-0-197" id="h11-0-197" class="i">+        }
</a><a href="#h11-0-198" id="h11-0-198" class="i">+        return outputs
</a><a href="#h11-0-199" id="h11-0-199" class="i">+    }
</a><a href="#h11-0-200" id="h11-0-200" class="i">+
</a><a href="#h11-0-201" id="h11-0-201" class="i">+    private fun patch(input: File, outputFile: File) {
</a><a href="#h11-0-202" id="h11-0-202" class="i">+        //check if input apk is already patched
</a><a href="#h11-0-203" id="h11-0-203" class="i">+        var isAlreadyPatched = false
</a><a href="#h11-0-204" id="h11-0-204" class="i">+        var inputFile = input
</a><a href="#h11-0-205" id="h11-0-205" class="i">+
</a><a href="#h11-0-206" id="h11-0-206" class="i">+        // extract origin
</a><a href="#h11-0-207" id="h11-0-207" class="i">+        printLog(&quot;Extracting origin apk&quot;)
</a><a href="#h11-0-208" id="h11-0-208" class="i">+        ZipFile(input).use { zipFile -&gt;
</a><a href="#h11-0-209" id="h11-0-209" class="i">+            zipFile.getEntry(&quot;assets/lspatch/origin.apk&quot;)?.apply {
</a><a href="#h11-0-210" id="h11-0-210" class="i">+                inputFile = File.createTempFile(&quot;origin&quot;, &quot;.apk&quot;)
</a><a href="#h11-0-211" id="h11-0-211" class="i">+                inputFile.outputStream().use {
</a><a href="#h11-0-212" id="h11-0-212" class="i">+                    zipFile.getInputStream(this).copyTo(it)
</a><a href="#h11-0-213" id="h11-0-213" class="i">+                }
</a><a href="#h11-0-214" id="h11-0-214" class="i">+                isAlreadyPatched = true
</a><a href="#h11-0-215" id="h11-0-215" class="i">+            }
</a><a href="#h11-0-216" id="h11-0-216" class="i">+        }
</a><a href="#h11-0-217" id="h11-0-217" class="i">+
</a><a href="#h11-0-218" id="h11-0-218" class="i">+        if (outputFile.exists()) outputFile.delete()
</a><a href="#h11-0-219" id="h11-0-219" class="i">+
</a><a href="#h11-0-220" id="h11-0-220" class="i">+        printLog(&quot;Patching apk&quot;)
</a><a href="#h11-0-221" id="h11-0-221" class="i">+        runCatching {
</a><a href="#h11-0-222" id="h11-0-222" class="i">+            patchApk(inputFile, outputFile)
</a><a href="#h11-0-223" id="h11-0-223" class="i">+        }.onFailure {
</a><a href="#h11-0-224" id="h11-0-224" class="i">+            if (isAlreadyPatched) {
</a><a href="#h11-0-225" id="h11-0-225" class="i">+                inputFile.delete()
</a><a href="#h11-0-226" id="h11-0-226" class="i">+            }
</a><a href="#h11-0-227" id="h11-0-227" class="i">+            outputFile.delete()
</a><a href="#h11-0-228" id="h11-0-228" class="i">+            printLog(&quot;Failed to patch&quot;)
</a><a href="#h11-0-229" id="h11-0-229" class="i">+            printLog(it)
</a><a href="#h11-0-230" id="h11-0-230" class="i">+        }
</a><a href="#h11-0-231" id="h11-0-231" class="i">+    }
</a><a href="#h11-0-232" id="h11-0-232" class="i">+}</a><a href="#h11-0-233" id="h11-0-233" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h12" href="../file/manager/src/main/kotlin/me/rhunk/snapenhance/manager/patch/LSPatchObfuscation.kt.html">manager/src/main/kotlin/me/rhunk/snapenhance/manager/patch/LSPatchObfuscation.kt</a> b/<a href="../file/manager/src/main/kotlin/me/rhunk/snapenhance/manager/patch/LSPatchObfuscation.kt.html">manager/src/main/kotlin/me/rhunk/snapenhance/manager/patch/LSPatchObfuscation.kt</a></b>
<a href="#h12-0" id="h12-0" class="h">@@ -0,0 +1,58 @@
</a><a href="#h12-0-0" id="h12-0-0" class="i">+package me.rhunk.snapenhance.manager.patch
</a><a href="#h12-0-1" id="h12-0-1" class="i">+
</a><a href="#h12-0-2" id="h12-0-2" class="i">+import me.rhunk.snapenhance.manager.patch.util.obfuscateDexFile
</a><a href="#h12-0-3" id="h12-0-3" class="i">+import java.io.File
</a><a href="#h12-0-4" id="h12-0-4" class="i">+import java.io.InputStream
</a><a href="#h12-0-5" id="h12-0-5" class="i">+
</a><a href="#h12-0-6" id="h12-0-6" class="i">+data class DexObfuscationConfig(
</a><a href="#h12-0-7" id="h12-0-7" class="i">+    val packageName: String,
</a><a href="#h12-0-8" id="h12-0-8" class="i">+    val metadataManifestField: String? = null,
</a><a href="#h12-0-9" id="h12-0-9" class="i">+    val metaLoaderFilePath: String? = null,
</a><a href="#h12-0-10" id="h12-0-10" class="i">+    val configFilePath: String? = null,
</a><a href="#h12-0-11" id="h12-0-11" class="i">+    val loaderFilePath: String? = null,
</a><a href="#h12-0-12" id="h12-0-12" class="i">+    val originApkPath: String? = null,
</a><a href="#h12-0-13" id="h12-0-13" class="i">+    val cachedOriginApkPath: String? = null,
</a><a href="#h12-0-14" id="h12-0-14" class="i">+    val openAtApkPath: String? = null,
</a><a href="#h12-0-15" id="h12-0-15" class="i">+    val assetModuleFolderPath: String? = null,
</a><a href="#h12-0-16" id="h12-0-16" class="i">+    val libNativeFilePath: Map&lt;String, String&gt; = mapOf(),
</a><a href="#h12-0-17" id="h12-0-17" class="i">+)
</a><a href="#h12-0-18" id="h12-0-18" class="i">+
</a><a href="#h12-0-19" id="h12-0-19" class="i">+class LSPatchObfuscation(
</a><a href="#h12-0-20" id="h12-0-20" class="i">+    private val cacheFolder: File,
</a><a href="#h12-0-21" id="h12-0-21" class="i">+    private val printLog: (String) -&gt; Unit = { println(it) }
</a><a href="#h12-0-22" id="h12-0-22" class="i">+) {
</a><a href="#h12-0-23" id="h12-0-23" class="i">+
</a><a href="#h12-0-24" id="h12-0-24" class="i">+    fun obfuscateMetaLoader(inputStream: InputStream, config: DexObfuscationConfig): File {
</a><a href="#h12-0-25" id="h12-0-25" class="i">+        return inputStream.obfuscateDexFile(cacheFolder, mapOf(
</a><a href="#h12-0-26" id="h12-0-26" class="i">+            &quot;assets/lspatch/config.json&quot; to &quot;assets/${config.configFilePath}&quot;,
</a><a href="#h12-0-27" id="h12-0-27" class="i">+            &quot;assets/lspatch/loader.dex&quot; to &quot;assets/${config.loaderFilePath}&quot;,
</a><a href="#h12-0-28" id="h12-0-28" class="i">+        ) + (config.libNativeFilePath.takeIf { it.isNotEmpty() }?.let {
</a><a href="#h12-0-29" id="h12-0-29" class="i">+            mapOf(
</a><a href="#h12-0-30" id="h12-0-30" class="i">+                &quot;!/assets/lspatch/so/&quot; to &quot;!/assets/&quot;,
</a><a href="#h12-0-31" id="h12-0-31" class="i">+                &quot;assets/lspatch/so/&quot; to &quot;assets/&quot;,
</a><a href="#h12-0-32" id="h12-0-32" class="i">+                &quot;/liblspatch.so&quot; to &quot;&quot;,
</a><a href="#h12-0-33" id="h12-0-33" class="i">+                &quot;arm64-v8a&quot; to config.libNativeFilePath[&quot;arm64-v8a&quot;],
</a><a href="#h12-0-34" id="h12-0-34" class="i">+                &quot;armeabi-v7a&quot; to config.libNativeFilePath[&quot;armeabi-v7a&quot;],
</a><a href="#h12-0-35" id="h12-0-35" class="i">+                &quot;x86&quot; to config.libNativeFilePath[&quot;x86&quot;],
</a><a href="#h12-0-36" id="h12-0-36" class="i">+                &quot;x86_64&quot; to config.libNativeFilePath[&quot;x86_64&quot;],
</a><a href="#h12-0-37" id="h12-0-37" class="i">+            )
</a><a href="#h12-0-38" id="h12-0-38" class="i">+        } ?: mapOf()))
</a><a href="#h12-0-39" id="h12-0-39" class="i">+    }
</a><a href="#h12-0-40" id="h12-0-40" class="i">+
</a><a href="#h12-0-41" id="h12-0-41" class="i">+    fun obfuscateLoader(inputStream: InputStream, config: DexObfuscationConfig): File {
</a><a href="#h12-0-42" id="h12-0-42" class="i">+        return inputStream.obfuscateDexFile(cacheFolder, mapOf(
</a><a href="#h12-0-43" id="h12-0-43" class="i">+            &quot;assets/lspatch/config.json&quot; to config.configFilePath?.let { &quot;assets/$it&quot; },
</a><a href="#h12-0-44" id="h12-0-44" class="i">+            &quot;assets/lspatch/loader.dex&quot; to config.loaderFilePath?.let { &quot;assets/$it&quot; },
</a><a href="#h12-0-45" id="h12-0-45" class="i">+            &quot;assets/lspatch/metaloader.dex&quot; to config.metaLoaderFilePath?.let { &quot;assets/$it&quot; },
</a><a href="#h12-0-46" id="h12-0-46" class="i">+            &quot;assets/lspatch/origin.apk&quot; to config.originApkPath?.let { &quot;assets/$it&quot; },
</a><a href="#h12-0-47" id="h12-0-47" class="i">+            &quot;/lspatch/origin/&quot; to config.cachedOriginApkPath?.let { &quot;/$it/&quot; }, // context.getCacheDir() + ==&gt; &quot;/lspatch/origin/&quot; &lt;== + sourceFile.getEntry(ORIGINAL_APK_ASSET_PATH).getCrc() + &quot;.apk&quot;;
</a><a href="#h12-0-48" id="h12-0-48" class="i">+            &quot;/lspatch/&quot; to config.cachedOriginApkPath?.let { &quot;/$it/&quot; }, // context.getCacheDir() + &quot;/lspatch/&quot; + packageName + &quot;/&quot;
</a><a href="#h12-0-49" id="h12-0-49" class="i">+            &quot;cache/lspatch/origin/&quot; to config.cachedOriginApkPath?.let { &quot;cache/$it&quot; }, //LSPApplication =&gt; Path originPath = Paths.get(appInfo.dataDir, &quot;cache/lspatch/origin/&quot;);
</a><a href="#h12-0-50" id="h12-0-50" class="i">+            &quot;assets/lspatch/modules/&quot; to config.assetModuleFolderPath?.let { &quot;assets/$it/&quot; }, // Constants.java =&gt; EMBEDDED_MODULES_ASSET_PATH
</a><a href="#h12-0-51" id="h12-0-51" class="i">+            &quot;lspatch/modules&quot; to config.assetModuleFolderPath, // LocalApplicationService.java =&gt; context.getAssets().list(&quot;lspatch/modules&quot;),
</a><a href="#h12-0-52" id="h12-0-52" class="i">+            &quot;lspatch/modules/&quot; to config.assetModuleFolderPath?.let { &quot;$it/&quot; }, // LocalApplicationService.java =&gt; try (var is = context.getAssets().open(&quot;lspatch/modules/&quot; + name)) {
</a><a href="#h12-0-53" id="h12-0-53" class="i">+            &quot;lspatch&quot; to config.metadataManifestField, // SigBypass.java =&gt; &quot;lspatch&quot;,
</a><a href="#h12-0-54" id="h12-0-54" class="i">+            &quot;org.lsposed.lspatch&quot; to config.cachedOriginApkPath?.let { &quot;$it/${config.packageName}/&quot; }, // Constants.java =&gt; &quot;org.lsposed.lspatch&quot;, (Used in LSPatchUpdater.kt)
</a><a href="#h12-0-55" id="h12-0-55" class="i">+        ))
</a><a href="#h12-0-56" id="h12-0-56" class="i">+    }
</a><a href="#h12-0-57" id="h12-0-57" class="i">+}</a><a href="#h12-0-58" id="h12-0-58" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h13" href="../file/manager/src/main/kotlin/me/rhunk/snapenhance/manager/patch/Repackager.kt.html">manager/src/main/kotlin/me/rhunk/snapenhance/manager/patch/Repackager.kt</a> b/<a href="../file/manager/src/main/kotlin/me/rhunk/snapenhance/manager/patch/Repackager.kt.html">manager/src/main/kotlin/me/rhunk/snapenhance/manager/patch/Repackager.kt</a></b>
<a href="#h13-0" id="h13-0" class="h">@@ -0,0 +1,89 @@
</a><a href="#h13-0-0" id="h13-0-0" class="i">+package me.rhunk.snapenhance.manager.patch
</a><a href="#h13-0-1" id="h13-0-1" class="i">+
</a><a href="#h13-0-2" id="h13-0-2" class="i">+import android.content.Context
</a><a href="#h13-0-3" id="h13-0-3" class="i">+import com.android.tools.build.apkzlib.zip.AlignmentRules
</a><a href="#h13-0-4" id="h13-0-4" class="i">+import com.android.tools.build.apkzlib.zip.ZFile
</a><a href="#h13-0-5" id="h13-0-5" class="i">+import com.android.tools.build.apkzlib.zip.ZFileOptions
</a><a href="#h13-0-6" id="h13-0-6" class="i">+import com.wind.meditor.core.ManifestEditor
</a><a href="#h13-0-7" id="h13-0-7" class="i">+import com.wind.meditor.property.AttributeItem
</a><a href="#h13-0-8" id="h13-0-8" class="i">+import com.wind.meditor.property.ModificationProperty
</a><a href="#h13-0-9" id="h13-0-9" class="i">+import me.rhunk.snapenhance.manager.BuildConfig
</a><a href="#h13-0-10" id="h13-0-10" class="i">+import me.rhunk.snapenhance.manager.patch.util.ApkSignatureHelper.provideSigningExtension
</a><a href="#h13-0-11" id="h13-0-11" class="i">+import me.rhunk.snapenhance.manager.patch.util.obfuscateDexFile
</a><a href="#h13-0-12" id="h13-0-12" class="i">+import java.io.ByteArrayInputStream
</a><a href="#h13-0-13" id="h13-0-13" class="i">+import java.io.ByteArrayOutputStream
</a><a href="#h13-0-14" id="h13-0-14" class="i">+import java.io.File
</a><a href="#h13-0-15" id="h13-0-15" class="i">+
</a><a href="#h13-0-16" id="h13-0-16" class="i">+class Repackager(
</a><a href="#h13-0-17" id="h13-0-17" class="i">+    private val context: Context,
</a><a href="#h13-0-18" id="h13-0-18" class="i">+    private val cacheFolder: File,
</a><a href="#h13-0-19" id="h13-0-19" class="i">+    private val packageName: String,
</a><a href="#h13-0-20" id="h13-0-20" class="i">+) {
</a><a href="#h13-0-21" id="h13-0-21" class="i">+    private fun patchManifest(data: ByteArray): ByteArray {
</a><a href="#h13-0-22" id="h13-0-22" class="i">+        val property = ModificationProperty()
</a><a href="#h13-0-23" id="h13-0-23" class="i">+
</a><a href="#h13-0-24" id="h13-0-24" class="i">+        property.addManifestAttribute(AttributeItem(&quot;package&quot;, packageName).apply {
</a><a href="#h13-0-25" id="h13-0-25" class="i">+            type = 3
</a><a href="#h13-0-26" id="h13-0-26" class="i">+            namespace = null
</a><a href="#h13-0-27" id="h13-0-27" class="i">+        })
</a><a href="#h13-0-28" id="h13-0-28" class="i">+
</a><a href="#h13-0-29" id="h13-0-29" class="i">+        return ByteArrayOutputStream().apply {
</a><a href="#h13-0-30" id="h13-0-30" class="i">+            ManifestEditor(ByteArrayInputStream(data), this, property).processManifest()
</a><a href="#h13-0-31" id="h13-0-31" class="i">+            flush()
</a><a href="#h13-0-32" id="h13-0-32" class="i">+            close()
</a><a href="#h13-0-33" id="h13-0-33" class="i">+        }.toByteArray()
</a><a href="#h13-0-34" id="h13-0-34" class="i">+    }
</a><a href="#h13-0-35" id="h13-0-35" class="i">+
</a><a href="#h13-0-36" id="h13-0-36" class="i">+    fun patch(apkFile: File): File {
</a><a href="#h13-0-37" id="h13-0-37" class="i">+        val outputFile = File(cacheFolder, &quot;patched-${apkFile.name}&quot;)
</a><a href="#h13-0-38" id="h13-0-38" class="i">+        runCatching {
</a><a href="#h13-0-39" id="h13-0-39" class="i">+            patch(apkFile, outputFile)
</a><a href="#h13-0-40" id="h13-0-40" class="i">+        }.onFailure {
</a><a href="#h13-0-41" id="h13-0-41" class="i">+            outputFile.delete()
</a><a href="#h13-0-42" id="h13-0-42" class="i">+            throw it
</a><a href="#h13-0-43" id="h13-0-43" class="i">+        }
</a><a href="#h13-0-44" id="h13-0-44" class="i">+        return outputFile
</a><a href="#h13-0-45" id="h13-0-45" class="i">+    }
</a><a href="#h13-0-46" id="h13-0-46" class="i">+
</a><a href="#h13-0-47" id="h13-0-47" class="i">+    fun patch(apkFile: File, outputFile: File) {
</a><a href="#h13-0-48" id="h13-0-48" class="i">+        val dstZFile = ZFile.openReadWrite(outputFile, ZFileOptions().setAlignmentRule(
</a><a href="#h13-0-49" id="h13-0-49" class="i">+            AlignmentRules.compose(AlignmentRules.constantForSuffix(&quot;.so&quot;, 4096))
</a><a href="#h13-0-50" id="h13-0-50" class="i">+        ))
</a><a href="#h13-0-51" id="h13-0-51" class="i">+        provideSigningExtension(context.assets.open(&quot;lspatch/keystore.jks&quot;)).register(dstZFile)
</a><a href="#h13-0-52" id="h13-0-52" class="i">+        val srcZFile = ZFile.openReadOnly(apkFile)
</a><a href="#h13-0-53" id="h13-0-53" class="i">+        val dexFiles = mutableListOf&lt;File&gt;()
</a><a href="#h13-0-54" id="h13-0-54" class="i">+
</a><a href="#h13-0-55" id="h13-0-55" class="i">+        for (entry in srcZFile.entries()) {
</a><a href="#h13-0-56" id="h13-0-56" class="i">+            val name = entry.centralDirectoryHeader.name
</a><a href="#h13-0-57" id="h13-0-57" class="i">+            if (name.startsWith(&quot;AndroidManifest.xml&quot;)) {
</a><a href="#h13-0-58" id="h13-0-58" class="i">+                dstZFile.add(name, ByteArrayInputStream(
</a><a href="#h13-0-59" id="h13-0-59" class="i">+                    patchManifest(entry.read())
</a><a href="#h13-0-60" id="h13-0-60" class="i">+                ), false)
</a><a href="#h13-0-61" id="h13-0-61" class="i">+                continue
</a><a href="#h13-0-62" id="h13-0-62" class="i">+            }
</a><a href="#h13-0-63" id="h13-0-63" class="i">+            if (name.startsWith(&quot;classes&quot;) &amp;&amp; name.endsWith(&quot;.dex&quot;)) {
</a><a href="#h13-0-64" id="h13-0-64" class="i">+                println(&quot;obfuscating $name&quot;)
</a><a href="#h13-0-65" id="h13-0-65" class="i">+                val inputStream = entry.open() ?: continue
</a><a href="#h13-0-66" id="h13-0-66" class="i">+                val obfuscatedDexFile = inputStream.obfuscateDexFile(cacheFolder, { dexFile -&gt;
</a><a href="#h13-0-67" id="h13-0-67" class="i">+                    dexFile.classes.firstOrNull { it.type == &quot;Lme/rhunk/snapenhance/common/Constants;&quot; } != null
</a><a href="#h13-0-68" id="h13-0-68" class="i">+                }, mapOf(
</a><a href="#h13-0-69" id="h13-0-69" class="i">+                    BuildConfig.APPLICATION_ID to packageName
</a><a href="#h13-0-70" id="h13-0-70" class="i">+                ))?.also { dexFiles.add(it) }
</a><a href="#h13-0-71" id="h13-0-71" class="i">+
</a><a href="#h13-0-72" id="h13-0-72" class="i">+                if (obfuscatedDexFile == null) {
</a><a href="#h13-0-73" id="h13-0-73" class="i">+                    inputStream.close()
</a><a href="#h13-0-74" id="h13-0-74" class="i">+                    dstZFile.add(name, entry.open(), false)
</a><a href="#h13-0-75" id="h13-0-75" class="i">+                    continue
</a><a href="#h13-0-76" id="h13-0-76" class="i">+                }
</a><a href="#h13-0-77" id="h13-0-77" class="i">+
</a><a href="#h13-0-78" id="h13-0-78" class="i">+                dstZFile.add(name, obfuscatedDexFile.inputStream(), false)
</a><a href="#h13-0-79" id="h13-0-79" class="i">+                continue
</a><a href="#h13-0-80" id="h13-0-80" class="i">+            }
</a><a href="#h13-0-81" id="h13-0-81" class="i">+            dstZFile.add(name, entry.open(), false)
</a><a href="#h13-0-82" id="h13-0-82" class="i">+        }
</a><a href="#h13-0-83" id="h13-0-83" class="i">+        dstZFile.realign()
</a><a href="#h13-0-84" id="h13-0-84" class="i">+        dstZFile.close()
</a><a href="#h13-0-85" id="h13-0-85" class="i">+        srcZFile.close()
</a><a href="#h13-0-86" id="h13-0-86" class="i">+        dexFiles.forEach { it.delete() }
</a><a href="#h13-0-87" id="h13-0-87" class="i">+    }
</a><a href="#h13-0-88" id="h13-0-88" class="i">+}</a><a href="#h13-0-89" id="h13-0-89" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h14" href="../file/manager/src/main/kotlin/me/rhunk/snapenhance/manager/patch/config/Constants.kt.html">manager/src/main/kotlin/me/rhunk/snapenhance/manager/patch/config/Constants.kt</a> b/<a href="../file/manager/src/main/kotlin/me/rhunk/snapenhance/manager/patch/config/Constants.kt.html">manager/src/main/kotlin/me/rhunk/snapenhance/manager/patch/config/Constants.kt</a></b>
<a href="#h14-0" id="h14-0" class="h">@@ -0,0 +1,7 @@
</a><a href="#h14-0-0" id="h14-0-0" class="i">+package me.rhunk.snapenhance.manager.patch.config
</a><a href="#h14-0-1" id="h14-0-1" class="i">+
</a><a href="#h14-0-2" id="h14-0-2" class="i">+//https://github.com/LSPosed/LSPatch/blob/master/share/java/src/main/java/org/lsposed/lspatch/share/Constants.java
</a><a href="#h14-0-3" id="h14-0-3" class="i">+object Constants {
</a><a href="#h14-0-4" id="h14-0-4" class="i">+    const val PROXY_APP_COMPONENT_FACTORY =
</a><a href="#h14-0-5" id="h14-0-5" class="i">+        &quot;org.lsposed.lspatch.metaloader.LSPAppComponentFactoryStub&quot;
</a><a href="#h14-0-6" id="h14-0-6" class="i">+}</a><a href="#h14-0-7" id="h14-0-7" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h15" href="../file/manager/src/main/kotlin/me/rhunk/snapenhance/manager/patch/config/PatchConfig.kt.html">manager/src/main/kotlin/me/rhunk/snapenhance/manager/patch/config/PatchConfig.kt</a> b/<a href="../file/manager/src/main/kotlin/me/rhunk/snapenhance/manager/patch/config/PatchConfig.kt.html">manager/src/main/kotlin/me/rhunk/snapenhance/manager/patch/config/PatchConfig.kt</a></b>
<a href="#h15-0" id="h15-0" class="h">@@ -0,0 +1,19 @@
</a><a href="#h15-0-0" id="h15-0-0" class="i">+package me.rhunk.snapenhance.manager.patch.config
</a><a href="#h15-0-1" id="h15-0-1" class="i">+
</a><a href="#h15-0-2" id="h15-0-2" class="i">+data class PatchConfig(
</a><a href="#h15-0-3" id="h15-0-3" class="i">+    val useManager: Boolean = false,
</a><a href="#h15-0-4" id="h15-0-4" class="i">+    val debuggable: Boolean = false,
</a><a href="#h15-0-5" id="h15-0-5" class="i">+    val overrideVersionCode: Boolean = false,
</a><a href="#h15-0-6" id="h15-0-6" class="i">+    val sigBypassLevel: Int = 0,
</a><a href="#h15-0-7" id="h15-0-7" class="i">+    val originalSignature: String? = null,
</a><a href="#h15-0-8" id="h15-0-8" class="i">+    val appComponentFactory: String? = null,
</a><a href="#h15-0-9" id="h15-0-9" class="i">+    val lspConfig: LSPConfig? = LSPConfig()
</a><a href="#h15-0-10" id="h15-0-10" class="i">+) {
</a><a href="#h15-0-11" id="h15-0-11" class="i">+    data class LSPConfig(
</a><a href="#h15-0-12" id="h15-0-12" class="i">+        var API_CODE: Int = 93,
</a><a href="#h15-0-13" id="h15-0-13" class="i">+        var VERSION_CODE: Int = 360,
</a><a href="#h15-0-14" id="h15-0-14" class="i">+        var VERSION_NAME: String = &quot;0.5.1&quot;,
</a><a href="#h15-0-15" id="h15-0-15" class="i">+        var CORE_VERSION_CODE: Int = 6649,
</a><a href="#h15-0-16" id="h15-0-16" class="i">+        var CORE_VERSION_NAME: String = &quot;1.8.5&quot;,
</a><a href="#h15-0-17" id="h15-0-17" class="i">+    )
</a><a href="#h15-0-18" id="h15-0-18" class="i">+}</a><a href="#h15-0-19" id="h15-0-19" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h16" href="../file/manager/src/main/kotlin/me/rhunk/snapenhance/manager/patch/util/ApkSignatureHelper.kt.html">manager/src/main/kotlin/me/rhunk/snapenhance/manager/patch/util/ApkSignatureHelper.kt</a> b/<a href="../file/manager/src/main/kotlin/me/rhunk/snapenhance/manager/patch/util/ApkSignatureHelper.kt.html">manager/src/main/kotlin/me/rhunk/snapenhance/manager/patch/util/ApkSignatureHelper.kt</a></b>
<a href="#h16-0" id="h16-0" class="h">@@ -0,0 +1,167 @@
</a><a href="#h16-0-0" id="h16-0-0" class="i">+package me.rhunk.snapenhance.manager.patch.util;
</a><a href="#h16-0-1" id="h16-0-1" class="i">+
</a><a href="#h16-0-2" id="h16-0-2" class="i">+import com.android.tools.build.apkzlib.sign.SigningExtension
</a><a href="#h16-0-3" id="h16-0-3" class="i">+import com.android.tools.build.apkzlib.sign.SigningOptions
</a><a href="#h16-0-4" id="h16-0-4" class="i">+import java.io.IOException
</a><a href="#h16-0-5" id="h16-0-5" class="i">+import java.io.InputStream
</a><a href="#h16-0-6" id="h16-0-6" class="i">+import java.io.RandomAccessFile
</a><a href="#h16-0-7" id="h16-0-7" class="i">+import java.io.UnsupportedEncodingException
</a><a href="#h16-0-8" id="h16-0-8" class="i">+import java.nio.ByteBuffer
</a><a href="#h16-0-9" id="h16-0-9" class="i">+import java.nio.ByteOrder
</a><a href="#h16-0-10" id="h16-0-10" class="i">+import java.security.KeyStore
</a><a href="#h16-0-11" id="h16-0-11" class="i">+import java.security.cert.Certificate
</a><a href="#h16-0-12" id="h16-0-12" class="i">+import java.security.cert.X509Certificate
</a><a href="#h16-0-13" id="h16-0-13" class="i">+import java.util.Enumeration
</a><a href="#h16-0-14" id="h16-0-14" class="i">+import java.util.jar.JarEntry
</a><a href="#h16-0-15" id="h16-0-15" class="i">+import java.util.jar.JarFile
</a><a href="#h16-0-16" id="h16-0-16" class="i">+
</a><a href="#h16-0-17" id="h16-0-17" class="i">+
</a><a href="#h16-0-18" id="h16-0-18" class="i">+//https://github.com/LSPosed/LSPatch/blob/master/patch/src/main/java/org/lsposed/patch/util/ApkSignatureHelper.java
</a><a href="#h16-0-19" id="h16-0-19" class="i">+object ApkSignatureHelper {
</a><a href="#h16-0-20" id="h16-0-20" class="i">+    private val APK_V2_MAGIC = charArrayOf(&#39;A&#39;, &#39;P&#39;, &#39;K&#39;, &#39; &#39;, &#39;S&#39;, &#39;i&#39;, &#39;g&#39;, &#39; &#39;,
</a><a href="#h16-0-21" id="h16-0-21" class="i">+        &#39;B&#39;, &#39;l&#39;, &#39;o&#39;, &#39;c&#39;, &#39;k&#39;, &#39; &#39;, &#39;4&#39;, &#39;2&#39;)
</a><a href="#h16-0-22" id="h16-0-22" class="i">+
</a><a href="#h16-0-23" id="h16-0-23" class="i">+    fun provideSigningExtension(keyStoreInputStream: InputStream): SigningExtension {
</a><a href="#h16-0-24" id="h16-0-24" class="i">+        val keyStore = KeyStore.getInstance(KeyStore.getDefaultType())
</a><a href="#h16-0-25" id="h16-0-25" class="i">+        keyStore.load(keyStoreInputStream, &quot;android&quot;.toCharArray())
</a><a href="#h16-0-26" id="h16-0-26" class="i">+        val key = keyStore.getEntry(&quot;androiddebugkey&quot;, KeyStore.PasswordProtection(&quot;android&quot;.toCharArray())) as KeyStore.PrivateKeyEntry
</a><a href="#h16-0-27" id="h16-0-27" class="i">+        val certificates = key.certificateChain.mapNotNull { it as? X509Certificate }.toTypedArray()
</a><a href="#h16-0-28" id="h16-0-28" class="i">+
</a><a href="#h16-0-29" id="h16-0-29" class="i">+        return SigningExtension(
</a><a href="#h16-0-30" id="h16-0-30" class="i">+            SigningOptions.builder().apply {
</a><a href="#h16-0-31" id="h16-0-31" class="i">+                setMinSdkVersion(28)
</a><a href="#h16-0-32" id="h16-0-32" class="i">+                setV2SigningEnabled(true)
</a><a href="#h16-0-33" id="h16-0-33" class="i">+                setCertificates(*certificates)
</a><a href="#h16-0-34" id="h16-0-34" class="i">+                setKey(key.privateKey)
</a><a href="#h16-0-35" id="h16-0-35" class="i">+            }.build()
</a><a href="#h16-0-36" id="h16-0-36" class="i">+        )
</a><a href="#h16-0-37" id="h16-0-37" class="i">+    }
</a><a href="#h16-0-38" id="h16-0-38" class="i">+
</a><a href="#h16-0-39" id="h16-0-39" class="i">+    private fun toChars(mSignature: ByteArray): CharArray {
</a><a href="#h16-0-40" id="h16-0-40" class="i">+        val N = mSignature.size
</a><a href="#h16-0-41" id="h16-0-41" class="i">+        val N2 = N * 2
</a><a href="#h16-0-42" id="h16-0-42" class="i">+        val text = CharArray(N2)
</a><a href="#h16-0-43" id="h16-0-43" class="i">+        for (j in 0 until N) {
</a><a href="#h16-0-44" id="h16-0-44" class="i">+            val v = mSignature[j]
</a><a href="#h16-0-45" id="h16-0-45" class="i">+            var d = v.toInt() shr 4 and 0xf
</a><a href="#h16-0-46" id="h16-0-46" class="i">+            text[j * 2] = (if (d &gt;= 10) &#39;a&#39;.code + d - 10 else &#39;0&#39;.code + d).toChar()
</a><a href="#h16-0-47" id="h16-0-47" class="i">+            d = v.toInt() and 0xf
</a><a href="#h16-0-48" id="h16-0-48" class="i">+            text[j * 2 + 1] = (if (d &gt;= 10) &#39;a&#39;.code + d - 10 else &#39;0&#39;.code + d).toChar()
</a><a href="#h16-0-49" id="h16-0-49" class="i">+        }
</a><a href="#h16-0-50" id="h16-0-50" class="i">+        return text
</a><a href="#h16-0-51" id="h16-0-51" class="i">+    }
</a><a href="#h16-0-52" id="h16-0-52" class="i">+
</a><a href="#h16-0-53" id="h16-0-53" class="i">+    private fun loadCertificates(
</a><a href="#h16-0-54" id="h16-0-54" class="i">+        jarFile: JarFile,
</a><a href="#h16-0-55" id="h16-0-55" class="i">+        je: JarEntry?,
</a><a href="#h16-0-56" id="h16-0-56" class="i">+        readBuffer: ByteArray
</a><a href="#h16-0-57" id="h16-0-57" class="i">+    ): Array&lt;Certificate?&gt;? {
</a><a href="#h16-0-58" id="h16-0-58" class="i">+        try {
</a><a href="#h16-0-59" id="h16-0-59" class="i">+            val `is` = jarFile.getInputStream(je)
</a><a href="#h16-0-60" id="h16-0-60" class="i">+            while (`is`.read(readBuffer, 0, readBuffer.size) != -1) {
</a><a href="#h16-0-61" id="h16-0-61" class="i">+            }
</a><a href="#h16-0-62" id="h16-0-62" class="i">+            `is`.close()
</a><a href="#h16-0-63" id="h16-0-63" class="i">+            return je?.certificates as Array&lt;Certificate?&gt;?
</a><a href="#h16-0-64" id="h16-0-64" class="i">+        } catch (e: Exception) {
</a><a href="#h16-0-65" id="h16-0-65" class="i">+        }
</a><a href="#h16-0-66" id="h16-0-66" class="i">+        return null
</a><a href="#h16-0-67" id="h16-0-67" class="i">+    }
</a><a href="#h16-0-68" id="h16-0-68" class="i">+
</a><a href="#h16-0-69" id="h16-0-69" class="i">+    fun getApkSignInfo(apkFilePath: String): String? {
</a><a href="#h16-0-70" id="h16-0-70" class="i">+        return try {
</a><a href="#h16-0-71" id="h16-0-71" class="i">+            getApkSignV2(apkFilePath)
</a><a href="#h16-0-72" id="h16-0-72" class="i">+        } catch (e: Exception) {
</a><a href="#h16-0-73" id="h16-0-73" class="i">+            getApkSignV1(apkFilePath)
</a><a href="#h16-0-74" id="h16-0-74" class="i">+        }
</a><a href="#h16-0-75" id="h16-0-75" class="i">+    }
</a><a href="#h16-0-76" id="h16-0-76" class="i">+
</a><a href="#h16-0-77" id="h16-0-77" class="i">+    fun getApkSignV1(apkFilePath: String?): String? {
</a><a href="#h16-0-78" id="h16-0-78" class="i">+        val readBuffer = ByteArray(8192)
</a><a href="#h16-0-79" id="h16-0-79" class="i">+        var certs: Array&lt;Certificate?&gt;? = null
</a><a href="#h16-0-80" id="h16-0-80" class="i">+        try {
</a><a href="#h16-0-81" id="h16-0-81" class="i">+            val jarFile = JarFile(apkFilePath)
</a><a href="#h16-0-82" id="h16-0-82" class="i">+            val entries: Enumeration&lt;*&gt; = jarFile.entries()
</a><a href="#h16-0-83" id="h16-0-83" class="i">+            while (entries.hasMoreElements()) {
</a><a href="#h16-0-84" id="h16-0-84" class="i">+                val je = entries.nextElement() as JarEntry
</a><a href="#h16-0-85" id="h16-0-85" class="i">+                if (je.isDirectory) {
</a><a href="#h16-0-86" id="h16-0-86" class="i">+                    continue
</a><a href="#h16-0-87" id="h16-0-87" class="i">+                }
</a><a href="#h16-0-88" id="h16-0-88" class="i">+                if (je.name.startsWith(&quot;META-INF/&quot;)) {
</a><a href="#h16-0-89" id="h16-0-89" class="i">+                    continue
</a><a href="#h16-0-90" id="h16-0-90" class="i">+                }
</a><a href="#h16-0-91" id="h16-0-91" class="i">+                val localCerts = loadCertificates(jarFile, je, readBuffer)
</a><a href="#h16-0-92" id="h16-0-92" class="i">+                if (certs == null) {
</a><a href="#h16-0-93" id="h16-0-93" class="i">+                    certs = localCerts
</a><a href="#h16-0-94" id="h16-0-94" class="i">+                } else {
</a><a href="#h16-0-95" id="h16-0-95" class="i">+                    for (i in certs.indices) {
</a><a href="#h16-0-96" id="h16-0-96" class="i">+                        var found = false
</a><a href="#h16-0-97" id="h16-0-97" class="i">+                        for (j in localCerts!!.indices) {
</a><a href="#h16-0-98" id="h16-0-98" class="i">+                            if (certs[i] != null &amp;&amp; certs[i] == localCerts[j]) {
</a><a href="#h16-0-99" id="h16-0-99" class="i">+                                found = true
</a><a href="#h16-0-100" id="h16-0-100" class="i">+                                break
</a><a href="#h16-0-101" id="h16-0-101" class="i">+                            }
</a><a href="#h16-0-102" id="h16-0-102" class="i">+                        }
</a><a href="#h16-0-103" id="h16-0-103" class="i">+                        if (!found || certs.size != localCerts.size) {
</a><a href="#h16-0-104" id="h16-0-104" class="i">+                            jarFile.close()
</a><a href="#h16-0-105" id="h16-0-105" class="i">+                            return null
</a><a href="#h16-0-106" id="h16-0-106" class="i">+                        }
</a><a href="#h16-0-107" id="h16-0-107" class="i">+                    }
</a><a href="#h16-0-108" id="h16-0-108" class="i">+                }
</a><a href="#h16-0-109" id="h16-0-109" class="i">+            }
</a><a href="#h16-0-110" id="h16-0-110" class="i">+            jarFile.close()
</a><a href="#h16-0-111" id="h16-0-111" class="i">+            return if (certs != null) String(toChars(certs[0]!!.encoded)) else null
</a><a href="#h16-0-112" id="h16-0-112" class="i">+        } catch (ignored: Throwable) {
</a><a href="#h16-0-113" id="h16-0-113" class="i">+        }
</a><a href="#h16-0-114" id="h16-0-114" class="i">+        return null
</a><a href="#h16-0-115" id="h16-0-115" class="i">+    }
</a><a href="#h16-0-116" id="h16-0-116" class="i">+
</a><a href="#h16-0-117" id="h16-0-117" class="i">+    @Throws(IOException::class)
</a><a href="#h16-0-118" id="h16-0-118" class="i">+    private fun getApkSignV2(apkFilePath: String): String {
</a><a href="#h16-0-119" id="h16-0-119" class="i">+        RandomAccessFile(apkFilePath, &quot;r&quot;).use { apk -&gt;
</a><a href="#h16-0-120" id="h16-0-120" class="i">+            val buffer = ByteBuffer.allocate(0x10)
</a><a href="#h16-0-121" id="h16-0-121" class="i">+            buffer.order(ByteOrder.LITTLE_ENDIAN)
</a><a href="#h16-0-122" id="h16-0-122" class="i">+            apk.seek(apk.length() - 0x6)
</a><a href="#h16-0-123" id="h16-0-123" class="i">+            apk.readFully(buffer.array(), 0x0, 0x6)
</a><a href="#h16-0-124" id="h16-0-124" class="i">+            val offset = buffer.getInt()
</a><a href="#h16-0-125" id="h16-0-125" class="i">+            if (buffer.getShort().toInt() != 0) {
</a><a href="#h16-0-126" id="h16-0-126" class="i">+                throw UnsupportedEncodingException(&quot;no zip&quot;)
</a><a href="#h16-0-127" id="h16-0-127" class="i">+            }
</a><a href="#h16-0-128" id="h16-0-128" class="i">+            apk.seek((offset - 0x10).toLong())
</a><a href="#h16-0-129" id="h16-0-129" class="i">+            apk.readFully(buffer.array(), 0x0, 0x10)
</a><a href="#h16-0-130" id="h16-0-130" class="i">+            if (!buffer.array().contentEquals(APK_V2_MAGIC.map { it.code.toByte() }.toByteArray())) {
</a><a href="#h16-0-131" id="h16-0-131" class="i">+                throw UnsupportedEncodingException(&quot;no apk v2&quot;)
</a><a href="#h16-0-132" id="h16-0-132" class="i">+            }
</a><a href="#h16-0-133" id="h16-0-133" class="i">+
</a><a href="#h16-0-134" id="h16-0-134" class="i">+            // Read and compare size fields
</a><a href="#h16-0-135" id="h16-0-135" class="i">+            apk.seek((offset - 0x18).toLong())
</a><a href="#h16-0-136" id="h16-0-136" class="i">+            apk.readFully(buffer.array(), 0x0, 0x8)
</a><a href="#h16-0-137" id="h16-0-137" class="i">+            buffer.rewind()
</a><a href="#h16-0-138" id="h16-0-138" class="i">+            var size = buffer.getLong().toInt()
</a><a href="#h16-0-139" id="h16-0-139" class="i">+            val block = ByteBuffer.allocate(size + 0x8)
</a><a href="#h16-0-140" id="h16-0-140" class="i">+            block.order(ByteOrder.LITTLE_ENDIAN)
</a><a href="#h16-0-141" id="h16-0-141" class="i">+            apk.seek((offset - block.capacity()).toLong())
</a><a href="#h16-0-142" id="h16-0-142" class="i">+            apk.readFully(block.array(), 0x0, block.capacity())
</a><a href="#h16-0-143" id="h16-0-143" class="i">+            if (size.toLong() != block.getLong()) {
</a><a href="#h16-0-144" id="h16-0-144" class="i">+                throw UnsupportedEncodingException(&quot;no apk v2&quot;)
</a><a href="#h16-0-145" id="h16-0-145" class="i">+            }
</a><a href="#h16-0-146" id="h16-0-146" class="i">+            while (block.remaining() &gt; 24) {
</a><a href="#h16-0-147" id="h16-0-147" class="i">+                size = block.getLong().toInt()
</a><a href="#h16-0-148" id="h16-0-148" class="i">+                if (block.getInt() == 0x7109871a) {
</a><a href="#h16-0-149" id="h16-0-149" class="i">+                    // signer-sequence length, signer length, signed data length
</a><a href="#h16-0-150" id="h16-0-150" class="i">+                    block.position(block.position() + 12)
</a><a href="#h16-0-151" id="h16-0-151" class="i">+                    size = block.getInt() // digests-sequence length
</a><a href="#h16-0-152" id="h16-0-152" class="i">+
</a><a href="#h16-0-153" id="h16-0-153" class="i">+                    // digests, certificates length
</a><a href="#h16-0-154" id="h16-0-154" class="i">+                    block.position(block.position() + size + 0x4)
</a><a href="#h16-0-155" id="h16-0-155" class="i">+                    size = block.getInt() // certificate length
</a><a href="#h16-0-156" id="h16-0-156" class="i">+                    break
</a><a href="#h16-0-157" id="h16-0-157" class="i">+                } else {
</a><a href="#h16-0-158" id="h16-0-158" class="i">+                    block.position(block.position() + size - 0x4)
</a><a href="#h16-0-159" id="h16-0-159" class="i">+                }
</a><a href="#h16-0-160" id="h16-0-160" class="i">+            }
</a><a href="#h16-0-161" id="h16-0-161" class="i">+            val certificate = ByteArray(size)
</a><a href="#h16-0-162" id="h16-0-162" class="i">+            block[certificate]
</a><a href="#h16-0-163" id="h16-0-163" class="i">+            return String(toChars(certificate))
</a><a href="#h16-0-164" id="h16-0-164" class="i">+        }
</a><a href="#h16-0-165" id="h16-0-165" class="i">+    }
</a><a href="#h16-0-166" id="h16-0-166" class="i">+}</a><a href="#h16-0-167" id="h16-0-167" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h17" href="../file/manager/src/main/kotlin/me/rhunk/snapenhance/manager/patch/util/DexLibExt.kt.html">manager/src/main/kotlin/me/rhunk/snapenhance/manager/patch/util/DexLibExt.kt</a> b/<a href="../file/manager/src/main/kotlin/me/rhunk/snapenhance/manager/patch/util/DexLibExt.kt.html">manager/src/main/kotlin/me/rhunk/snapenhance/manager/patch/util/DexLibExt.kt</a></b>
<a href="#h17-0" id="h17-0" class="h">@@ -0,0 +1,63 @@
</a><a href="#h17-0-0" id="h17-0-0" class="i">+package me.rhunk.snapenhance.manager.patch.util
</a><a href="#h17-0-1" id="h17-0-1" class="i">+
</a><a href="#h17-0-2" id="h17-0-2" class="i">+import org.jf.dexlib2.Opcodes
</a><a href="#h17-0-3" id="h17-0-3" class="i">+import org.jf.dexlib2.dexbacked.DexBackedDexFile
</a><a href="#h17-0-4" id="h17-0-4" class="i">+import org.jf.dexlib2.iface.DexFile
</a><a href="#h17-0-5" id="h17-0-5" class="i">+import org.jf.dexlib2.iface.reference.StringReference
</a><a href="#h17-0-6" id="h17-0-6" class="i">+import org.jf.dexlib2.writer.io.FileDataStore
</a><a href="#h17-0-7" id="h17-0-7" class="i">+import org.jf.dexlib2.writer.pool.DexPool
</a><a href="#h17-0-8" id="h17-0-8" class="i">+import org.jf.dexlib2.writer.pool.StringPool
</a><a href="#h17-0-9" id="h17-0-9" class="i">+import java.io.BufferedInputStream
</a><a href="#h17-0-10" id="h17-0-10" class="i">+import java.io.File
</a><a href="#h17-0-11" id="h17-0-11" class="i">+import java.io.InputStream
</a><a href="#h17-0-12" id="h17-0-12" class="i">+
</a><a href="#h17-0-13" id="h17-0-13" class="i">+
</a><a href="#h17-0-14" id="h17-0-14" class="i">+private fun obfuscateStrings(dexFile: DexFile, dexStrings: Map&lt;String, String?&gt;): DexPool {
</a><a href="#h17-0-15" id="h17-0-15" class="i">+    val dexPool = object: DexPool(dexFile.opcodes) {
</a><a href="#h17-0-16" id="h17-0-16" class="i">+        override fun getSectionProvider(): SectionProvider {
</a><a href="#h17-0-17" id="h17-0-17" class="i">+            val dexPool = this
</a><a href="#h17-0-18" id="h17-0-18" class="i">+            return object: DexPoolSectionProvider() {
</a><a href="#h17-0-19" id="h17-0-19" class="i">+                override fun getStringSection() = object: StringPool(dexPool) {
</a><a href="#h17-0-20" id="h17-0-20" class="i">+                    private val cacheMap = mutableMapOf&lt;String, String&gt;()
</a><a href="#h17-0-21" id="h17-0-21" class="i">+
</a><a href="#h17-0-22" id="h17-0-22" class="i">+                    override fun intern(string: CharSequence) {
</a><a href="#h17-0-23" id="h17-0-23" class="i">+                        dexStrings[string.toString()]?.let {
</a><a href="#h17-0-24" id="h17-0-24" class="i">+                            cacheMap[string.toString()] = it
</a><a href="#h17-0-25" id="h17-0-25" class="i">+                            println(&quot;mapping $string to $it&quot;)
</a><a href="#h17-0-26" id="h17-0-26" class="i">+                            super.intern(it)
</a><a href="#h17-0-27" id="h17-0-27" class="i">+                            return
</a><a href="#h17-0-28" id="h17-0-28" class="i">+                        }
</a><a href="#h17-0-29" id="h17-0-29" class="i">+                        super.intern(string)
</a><a href="#h17-0-30" id="h17-0-30" class="i">+                    }
</a><a href="#h17-0-31" id="h17-0-31" class="i">+
</a><a href="#h17-0-32" id="h17-0-32" class="i">+                    override fun getItemIndex(key: CharSequence): Int {
</a><a href="#h17-0-33" id="h17-0-33" class="i">+                        return cacheMap[key.toString()]?.let {
</a><a href="#h17-0-34" id="h17-0-34" class="i">+                            internedItems[it]
</a><a href="#h17-0-35" id="h17-0-35" class="i">+                        } ?: super.getItemIndex(key)
</a><a href="#h17-0-36" id="h17-0-36" class="i">+                    }
</a><a href="#h17-0-37" id="h17-0-37" class="i">+
</a><a href="#h17-0-38" id="h17-0-38" class="i">+                    override fun getItemIndex(key: StringReference): Int {
</a><a href="#h17-0-39" id="h17-0-39" class="i">+                        return cacheMap[key.toString()]?.let {
</a><a href="#h17-0-40" id="h17-0-40" class="i">+                            internedItems[it]
</a><a href="#h17-0-41" id="h17-0-41" class="i">+                        } ?: super.getItemIndex(key)
</a><a href="#h17-0-42" id="h17-0-42" class="i">+                    }
</a><a href="#h17-0-43" id="h17-0-43" class="i">+                }
</a><a href="#h17-0-44" id="h17-0-44" class="i">+            }
</a><a href="#h17-0-45" id="h17-0-45" class="i">+        }
</a><a href="#h17-0-46" id="h17-0-46" class="i">+    }
</a><a href="#h17-0-47" id="h17-0-47" class="i">+    dexFile.classes.forEach { dexBackedClassDef -&gt;
</a><a href="#h17-0-48" id="h17-0-48" class="i">+        dexPool.internClass(dexBackedClassDef)
</a><a href="#h17-0-49" id="h17-0-49" class="i">+    }
</a><a href="#h17-0-50" id="h17-0-50" class="i">+    return dexPool
</a><a href="#h17-0-51" id="h17-0-51" class="i">+}
</a><a href="#h17-0-52" id="h17-0-52" class="i">+
</a><a href="#h17-0-53" id="h17-0-53" class="i">+fun InputStream.obfuscateDexFile(cacheFolder: File, dexStrings: Map&lt;String, String?&gt;)
</a><a href="#h17-0-54" id="h17-0-54" class="i">+    = this.obfuscateDexFile(cacheFolder, { true }, dexStrings)!!
</a><a href="#h17-0-55" id="h17-0-55" class="i">+
</a><a href="#h17-0-56" id="h17-0-56" class="i">+fun InputStream.obfuscateDexFile(cacheFolder: File, filter: (DexFile) -&gt; Boolean, dexStrings: Map&lt;String, String?&gt;): File? {
</a><a href="#h17-0-57" id="h17-0-57" class="i">+    val dexFile = DexBackedDexFile.fromInputStream(Opcodes.forApi(29), BufferedInputStream(this))
</a><a href="#h17-0-58" id="h17-0-58" class="i">+    if (!filter(dexFile)) return null
</a><a href="#h17-0-59" id="h17-0-59" class="i">+    val outputFile = File.createTempFile(&quot;dexobf&quot;, &quot;.dex&quot;, cacheFolder)
</a><a href="#h17-0-60" id="h17-0-60" class="i">+    obfuscateStrings(dexFile, dexStrings).writeTo(FileDataStore(outputFile))
</a><a href="#h17-0-61" id="h17-0-61" class="i">+    return outputFile
</a><a href="#h17-0-62" id="h17-0-62" class="i">+}
</a><b>diff --git a/<a id="h18" href="../file/manager/src/main/kotlin/me/rhunk/snapenhance/manager/ui/MainActivity.kt.html">manager/src/main/kotlin/me/rhunk/snapenhance/manager/ui/MainActivity.kt</a> b/<a href="../file/manager/src/main/kotlin/me/rhunk/snapenhance/manager/ui/MainActivity.kt.html">manager/src/main/kotlin/me/rhunk/snapenhance/manager/ui/MainActivity.kt</a></b>
<a href="#h18-0" id="h18-0" class="h">@@ -16,10 +16,11 @@ import me.rhunk.snapenhance.manager.ui.tab.Tab
</a> import me.rhunk.snapenhance.manager.ui.tab.impl.HomeTab
 import me.rhunk.snapenhance.manager.ui.tab.impl.SettingsTab
 import me.rhunk.snapenhance.manager.ui.tab.impl.download.InstallPackageTab
<a href="#h18-0-3" id="h18-0-3" class="i">+import me.rhunk.snapenhance.manager.ui.tab.impl.download.RepackageTab
</a> 
 class MainActivity : ComponentActivity() {
     companion object{
<a href="#h18-0-7" id="h18-0-7" class="d">-        private val primaryTabs = listOf(HomeTab::class, SettingsTab::class, InstallPackageTab::class)
</a><a href="#h18-0-8" id="h18-0-8" class="i">+        private val primaryTabs = listOf(HomeTab::class, SettingsTab::class, InstallPackageTab::class, RepackageTab::class)
</a>     }
 
     override fun onCreate(savedInstanceState: Bundle?) {
<b>diff --git a/<a id="h19" href="../file/manager/src/main/kotlin/me/rhunk/snapenhance/manager/ui/tab/impl/HomeTab.kt.html">manager/src/main/kotlin/me/rhunk/snapenhance/manager/ui/tab/impl/HomeTab.kt</a> b/<a href="../file/manager/src/main/kotlin/me/rhunk/snapenhance/manager/ui/tab/impl/HomeTab.kt.html">manager/src/main/kotlin/me/rhunk/snapenhance/manager/ui/tab/impl/HomeTab.kt</a></b>
<a href="#h19-0" id="h19-0" class="h">@@ -10,10 +10,10 @@ import androidx.compose.foundation.layout.Row
</a> import androidx.compose.foundation.layout.fillMaxWidth
 import androidx.compose.foundation.layout.padding
 import androidx.compose.material.icons.Icons
<a href="#h19-0-3" id="h19-0-3" class="d">-import androidx.compose.material.icons.filled.OpenInNew
</a> import androidx.compose.material.icons.filled.Check
 import androidx.compose.material.icons.filled.Close
 import androidx.compose.material.icons.filled.Home
<a href="#h19-0-7" id="h19-0-7" class="i">+import androidx.compose.material.icons.filled.OpenInNew
</a> import androidx.compose.material3.Card
 import androidx.compose.material3.Icon
 import androidx.compose.material3.MaterialTheme
<a href="#h19-1" id="h19-1" class="h">@@ -27,7 +27,7 @@ import androidx.compose.ui.unit.dp
</a> import androidx.compose.ui.unit.sp
 import kotlinx.coroutines.Dispatchers
 import kotlinx.coroutines.launch
<a href="#h19-1-3" id="h19-1-3" class="d">-import me.rhunk.snapenhance.manager.lspatch.config.Constants
</a><a href="#h19-1-4" id="h19-1-4" class="i">+import me.rhunk.snapenhance.manager.patch.config.Constants
</a> import me.rhunk.snapenhance.manager.ui.tab.Tab
 import me.rhunk.snapenhance.manager.ui.tab.impl.download.SEDownloadTab
 import me.rhunk.snapenhance.manager.ui.tab.impl.download.SnapchatPatchTab
<a href="#h19-2" id="h19-2" class="h">@@ -66,6 +66,7 @@ class HomeTab : Tab(&quot;home&quot;, true, icon = Icons.Default.Home) {
</a>                         Text(text = &quot;SnapEnhance&quot;, fontSize = 24.sp, color = MaterialTheme.colorScheme.onSurface, fontWeight = FontWeight.Bold)
                         snapEnhanceInfo?.let {
                             Text(text = &quot;${it.versionName} (${it.longVersionCode}) - ${if ((it.applicationInfo.flags and FLAG_DEBUGGABLE) != 0) &quot;Debug&quot; else &quot;Release&quot;}&quot;, fontSize = 12.sp, color = MaterialTheme.colorScheme.onSurfaceVariant)
<a href="#h19-2-3" id="h19-2-3" class="i">+                            Text(it.packageName, fontSize = 12.sp, color = MaterialTheme.colorScheme.onSurfaceVariant)
</a>                         }
                     }
                     Row(
<b>diff --git a/<a id="h20" href="../file/manager/src/main/kotlin/me/rhunk/snapenhance/manager/ui/tab/impl/SettingsTab.kt.html">manager/src/main/kotlin/me/rhunk/snapenhance/manager/ui/tab/impl/SettingsTab.kt</a> b/<a href="../file/manager/src/main/kotlin/me/rhunk/snapenhance/manager/ui/tab/impl/SettingsTab.kt.html">manager/src/main/kotlin/me/rhunk/snapenhance/manager/ui/tab/impl/SettingsTab.kt</a></b>
<a href="#h20-0" id="h20-0" class="h">@@ -22,10 +22,11 @@ import androidx.compose.ui.unit.dp
</a> import androidx.compose.ui.unit.sp
 import androidx.compose.ui.window.Dialog
 import me.rhunk.snapenhance.manager.ui.tab.Tab
<a href="#h20-0-3" id="h20-0-3" class="i">+import kotlin.random.Random
</a> 
 class SettingsTab : Tab(&quot;settings&quot;, isPrimary = true, icon = Icons.Default.Settings) {
     @Composable
<a href="#h20-0-7" id="h20-0-7" class="d">-    private fun ConfigEditRow(getValue: () -&gt; String?, setValue: (String) -&gt; Unit, label: String) {
</a><a href="#h20-0-8" id="h20-0-8" class="i">+    private fun ConfigEditRow(getValue: () -&gt; String?, setValue: (String) -&gt; Unit, label: String, randomValueProvider: (() -&gt; String)? = null) {
</a>         var showDialog by remember { mutableStateOf(false) }
 
         if (showDialog) {
<a href="#h20-1" id="h20-1" class="h">@@ -65,6 +66,13 @@ class SettingsTab : Tab(&quot;settings&quot;, isPrimary = true, icon = Icons.Default.Setti
</a>                             }) {
                                 Text(text = &quot;Cancel&quot;)
                             }
<a href="#h20-1-3" id="h20-1-3" class="i">+                            if (randomValueProvider != null) {
</a><a href="#h20-1-4" id="h20-1-4" class="i">+                                Button(onClick = {
</a><a href="#h20-1-5" id="h20-1-5" class="i">+                                    textFieldValue = TextFieldValue(randomValueProvider(), TextRange(0))
</a><a href="#h20-1-6" id="h20-1-6" class="i">+                                }) {
</a><a href="#h20-1-7" id="h20-1-7" class="i">+                                    Text(text = &quot;Random&quot;)
</a><a href="#h20-1-8" id="h20-1-8" class="i">+                                }
</a><a href="#h20-1-9" id="h20-1-9" class="i">+                            }
</a>                             Button(onClick = {
                                 setValue(textFieldValue.text)
                                 showDialog = false
<a href="#h20-2" id="h20-2" class="h">@@ -131,14 +139,17 @@ class SettingsTab : Tab(&quot;settings&quot;, isPrimary = true, icon = Icons.Default.Setti
</a>         Column {
             Spacer(modifier = Modifier.height(16.dp))
             ConfigEditRow(
<a href="#h20-2-3" id="h20-2-3" class="d">-                getValue = { sharedConfig.snapchatPackageName },
</a><a href="#h20-2-4" id="h20-2-4" class="d">-                setValue = { sharedConfig.snapchatPackageName = it },
</a><a href="#h20-2-5" id="h20-2-5" class="d">-                label = &quot;Override Snapchat package name&quot;
</a><a href="#h20-2-6" id="h20-2-6" class="d">-            )
</a><a href="#h20-2-7" id="h20-2-7" class="d">-            ConfigEditRow(
</a>                 getValue = { sharedConfig.snapEnhancePackageName },
                 setValue = { sharedConfig.snapEnhancePackageName = it },
<a href="#h20-2-10" id="h20-2-10" class="d">-                label = &quot;Override SnapEnhance package name&quot;
</a><a href="#h20-2-11" id="h20-2-11" class="i">+                label = &quot;Override SnapEnhance package name&quot;,
</a><a href="#h20-2-12" id="h20-2-12" class="i">+                randomValueProvider = {
</a><a href="#h20-2-13" id="h20-2-13" class="i">+                    (0..Random.nextInt(7, 16)).map { (&#39;a&#39;..&#39;z&#39;).random() }.joinToString(&quot;&quot;).chunked(4).joinToString(&quot;.&quot;)
</a><a href="#h20-2-14" id="h20-2-14" class="i">+                }
</a><a href="#h20-2-15" id="h20-2-15" class="i">+            )
</a><a href="#h20-2-16" id="h20-2-16" class="i">+            ConfigBooleanRow(
</a><a href="#h20-2-17" id="h20-2-17" class="i">+                getValue = { sharedConfig.enableRepackage },
</a><a href="#h20-2-18" id="h20-2-18" class="i">+                setValue = { sharedConfig.enableRepackage = it },
</a><a href="#h20-2-19" id="h20-2-19" class="i">+                label = &quot;Repackage SnapEnhance (experimental)&quot;
</a>             )
             ConfigBooleanRow(
                 getValue = { sharedConfig.useRootInstaller },
<b>diff --git a/<a id="h21" href="../file/manager/src/main/kotlin/me/rhunk/snapenhance/manager/ui/tab/impl/download/LSPatchTab.kt.html">manager/src/main/kotlin/me/rhunk/snapenhance/manager/ui/tab/impl/download/LSPatchTab.kt</a> b/<a href="../file/manager/src/main/kotlin/me/rhunk/snapenhance/manager/ui/tab/impl/download/LSPatchTab.kt.html">manager/src/main/kotlin/me/rhunk/snapenhance/manager/ui/tab/impl/download/LSPatchTab.kt</a></b>
<a href="#h21-0" id="h21-0" class="h">@@ -20,7 +20,7 @@ import kotlinx.coroutines.cancel
</a> import kotlinx.coroutines.launch
 import me.rhunk.snapenhance.manager.data.APKMirror
 import me.rhunk.snapenhance.manager.data.DownloadItem
<a href="#h21-0-3" id="h21-0-3" class="d">-import me.rhunk.snapenhance.manager.lspatch.LSPatch
</a><a href="#h21-0-4" id="h21-0-4" class="i">+import me.rhunk.snapenhance.manager.patch.LSPatch
</a> import me.rhunk.snapenhance.manager.ui.components.DowngradeNoticeDialog
 import me.rhunk.snapenhance.manager.ui.tab.Tab
 import okio.use
<b>diff --git a/<a id="h22" href="../file/manager/src/main/kotlin/me/rhunk/snapenhance/manager/ui/tab/impl/download/RepackageTab.kt.html">manager/src/main/kotlin/me/rhunk/snapenhance/manager/ui/tab/impl/download/RepackageTab.kt</a> b/<a href="../file/manager/src/main/kotlin/me/rhunk/snapenhance/manager/ui/tab/impl/download/RepackageTab.kt.html">manager/src/main/kotlin/me/rhunk/snapenhance/manager/ui/tab/impl/download/RepackageTab.kt</a></b>
<a href="#h22-0" id="h22-0" class="h">@@ -0,0 +1,86 @@
</a><a href="#h22-0-0" id="h22-0-0" class="i">+package me.rhunk.snapenhance.manager.ui.tab.impl.download
</a><a href="#h22-0-1" id="h22-0-1" class="i">+
</a><a href="#h22-0-2" id="h22-0-2" class="i">+import android.os.Bundle
</a><a href="#h22-0-3" id="h22-0-3" class="i">+import androidx.compose.foundation.layout.Arrangement
</a><a href="#h22-0-4" id="h22-0-4" class="i">+import androidx.compose.foundation.layout.Column
</a><a href="#h22-0-5" id="h22-0-5" class="i">+import androidx.compose.foundation.layout.fillMaxSize
</a><a href="#h22-0-6" id="h22-0-6" class="i">+import androidx.compose.material3.CircularProgressIndicator
</a><a href="#h22-0-7" id="h22-0-7" class="i">+import androidx.compose.material3.Text
</a><a href="#h22-0-8" id="h22-0-8" class="i">+import androidx.compose.runtime.Composable
</a><a href="#h22-0-9" id="h22-0-9" class="i">+import androidx.compose.runtime.LaunchedEffect
</a><a href="#h22-0-10" id="h22-0-10" class="i">+import androidx.compose.runtime.MutableState
</a><a href="#h22-0-11" id="h22-0-11" class="i">+import androidx.compose.runtime.mutableStateOf
</a><a href="#h22-0-12" id="h22-0-12" class="i">+import androidx.compose.runtime.remember
</a><a href="#h22-0-13" id="h22-0-13" class="i">+import androidx.compose.ui.Alignment
</a><a href="#h22-0-14" id="h22-0-14" class="i">+import androidx.compose.ui.Modifier
</a><a href="#h22-0-15" id="h22-0-15" class="i">+import kotlinx.coroutines.Dispatchers
</a><a href="#h22-0-16" id="h22-0-16" class="i">+import kotlinx.coroutines.launch
</a><a href="#h22-0-17" id="h22-0-17" class="i">+import kotlinx.coroutines.withContext
</a><a href="#h22-0-18" id="h22-0-18" class="i">+import me.rhunk.snapenhance.manager.patch.Repackager
</a><a href="#h22-0-19" id="h22-0-19" class="i">+import me.rhunk.snapenhance.manager.ui.tab.Tab
</a><a href="#h22-0-20" id="h22-0-20" class="i">+import java.io.File
</a><a href="#h22-0-21" id="h22-0-21" class="i">+
</a><a href="#h22-0-22" id="h22-0-22" class="i">+enum class RepackageState {
</a><a href="#h22-0-23" id="h22-0-23" class="i">+    IDLE,
</a><a href="#h22-0-24" id="h22-0-24" class="i">+    WORKING,
</a><a href="#h22-0-25" id="h22-0-25" class="i">+    SUCCESS,
</a><a href="#h22-0-26" id="h22-0-26" class="i">+    FAILED
</a><a href="#h22-0-27" id="h22-0-27" class="i">+}
</a><a href="#h22-0-28" id="h22-0-28" class="i">+
</a><a href="#h22-0-29" id="h22-0-29" class="i">+class RepackageTab : Tab(&quot;repackage&quot;) {
</a><a href="#h22-0-30" id="h22-0-30" class="i">+    private var throwable: Throwable? = null
</a><a href="#h22-0-31" id="h22-0-31" class="i">+
</a><a href="#h22-0-32" id="h22-0-32" class="i">+    private suspend fun repackage(apk: File, oldPackage: String, state: MutableState&lt;RepackageState&gt;) {
</a><a href="#h22-0-33" id="h22-0-33" class="i">+        state.value = RepackageState.WORKING
</a><a href="#h22-0-34" id="h22-0-34" class="i">+        val repackager = Repackager(activity, activity.externalCacheDirs.first(), sharedConfig.snapEnhancePackageName)
</a><a href="#h22-0-35" id="h22-0-35" class="i">+
</a><a href="#h22-0-36" id="h22-0-36" class="i">+        runCatching {
</a><a href="#h22-0-37" id="h22-0-37" class="i">+            repackager.patch(apk)
</a><a href="#h22-0-38" id="h22-0-38" class="i">+        }.onFailure {
</a><a href="#h22-0-39" id="h22-0-39" class="i">+            throwable = it
</a><a href="#h22-0-40" id="h22-0-40" class="i">+            state.value = RepackageState.FAILED
</a><a href="#h22-0-41" id="h22-0-41" class="i">+            return
</a><a href="#h22-0-42" id="h22-0-42" class="i">+        }.onSuccess { originApk -&gt;
</a><a href="#h22-0-43" id="h22-0-43" class="i">+            state.value = RepackageState.SUCCESS
</a><a href="#h22-0-44" id="h22-0-44" class="i">+
</a><a href="#h22-0-45" id="h22-0-45" class="i">+            withContext(Dispatchers.Main) {
</a><a href="#h22-0-46" id="h22-0-46" class="i">+                navigation.navigateTo(InstallPackageTab::class, Bundle().apply {
</a><a href="#h22-0-47" id="h22-0-47" class="i">+                    putString(&quot;downloadPath&quot;, originApk.absolutePath)
</a><a href="#h22-0-48" id="h22-0-48" class="i">+                    putString(&quot;appPackage&quot;, oldPackage)
</a><a href="#h22-0-49" id="h22-0-49" class="i">+                    putBoolean(&quot;uninstall&quot;, true)
</a><a href="#h22-0-50" id="h22-0-50" class="i">+                }, noHistory = true)
</a><a href="#h22-0-51" id="h22-0-51" class="i">+            }
</a><a href="#h22-0-52" id="h22-0-52" class="i">+
</a><a href="#h22-0-53" id="h22-0-53" class="i">+            return
</a><a href="#h22-0-54" id="h22-0-54" class="i">+        }
</a><a href="#h22-0-55" id="h22-0-55" class="i">+    }
</a><a href="#h22-0-56" id="h22-0-56" class="i">+
</a><a href="#h22-0-57" id="h22-0-57" class="i">+    @Composable
</a><a href="#h22-0-58" id="h22-0-58" class="i">+    override fun Content() {
</a><a href="#h22-0-59" id="h22-0-59" class="i">+        val apkPath = remember { getArguments()?.getString(&quot;apkPath&quot;) } ?: return
</a><a href="#h22-0-60" id="h22-0-60" class="i">+        val oldPackage = remember { getArguments()?.getString(&quot;oldPackage&quot;) } ?: return
</a><a href="#h22-0-61" id="h22-0-61" class="i">+        val state = remember { mutableStateOf(RepackageState.IDLE) }
</a><a href="#h22-0-62" id="h22-0-62" class="i">+
</a><a href="#h22-0-63" id="h22-0-63" class="i">+        LaunchedEffect(apkPath) {
</a><a href="#h22-0-64" id="h22-0-64" class="i">+            launch(Dispatchers.IO) {
</a><a href="#h22-0-65" id="h22-0-65" class="i">+                repackage(File(apkPath), oldPackage,  state)
</a><a href="#h22-0-66" id="h22-0-66" class="i">+            }
</a><a href="#h22-0-67" id="h22-0-67" class="i">+        }
</a><a href="#h22-0-68" id="h22-0-68" class="i">+
</a><a href="#h22-0-69" id="h22-0-69" class="i">+        Column(
</a><a href="#h22-0-70" id="h22-0-70" class="i">+            modifier = Modifier.fillMaxSize(),
</a><a href="#h22-0-71" id="h22-0-71" class="i">+            horizontalAlignment = Alignment.CenterHorizontally,
</a><a href="#h22-0-72" id="h22-0-72" class="i">+            verticalArrangement = Arrangement.Center
</a><a href="#h22-0-73" id="h22-0-73" class="i">+        ) {
</a><a href="#h22-0-74" id="h22-0-74" class="i">+            CircularProgressIndicator()
</a><a href="#h22-0-75" id="h22-0-75" class="i">+            when (state.value) {
</a><a href="#h22-0-76" id="h22-0-76" class="i">+                RepackageState.WORKING -&gt; Text(text = &quot;Repackaging ...&quot;)
</a><a href="#h22-0-77" id="h22-0-77" class="i">+                RepackageState.FAILED -&gt; {
</a><a href="#h22-0-78" id="h22-0-78" class="i">+                    Text(text = &quot;Failed&quot;)
</a><a href="#h22-0-79" id="h22-0-79" class="i">+                    Text(text = (throwable?.localizedMessage + throwable?.stackTraceToString()))
</a><a href="#h22-0-80" id="h22-0-80" class="i">+                }
</a><a href="#h22-0-81" id="h22-0-81" class="i">+                else -&gt; {}
</a><a href="#h22-0-82" id="h22-0-82" class="i">+            }
</a><a href="#h22-0-83" id="h22-0-83" class="i">+        }
</a><a href="#h22-0-84" id="h22-0-84" class="i">+    }
</a><a href="#h22-0-85" id="h22-0-85" class="i">+}</a><a href="#h22-0-86" id="h22-0-86" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h23" href="../file/manager/src/main/kotlin/me/rhunk/snapenhance/manager/ui/tab/impl/download/SEDownloadTab.kt.html">manager/src/main/kotlin/me/rhunk/snapenhance/manager/ui/tab/impl/download/SEDownloadTab.kt</a> b/<a href="../file/manager/src/main/kotlin/me/rhunk/snapenhance/manager/ui/tab/impl/download/SEDownloadTab.kt.html">manager/src/main/kotlin/me/rhunk/snapenhance/manager/ui/tab/impl/download/SEDownloadTab.kt</a></b>
<a href="#h23-0" id="h23-0" class="h">@@ -24,6 +24,7 @@ import androidx.compose.ui.window.Dialog
</a> import com.google.gson.JsonParser
 import kotlinx.coroutines.Dispatchers
 import kotlinx.coroutines.launch
<a href="#h23-0-3" id="h23-0-3" class="i">+import me.rhunk.snapenhance.manager.BuildConfig
</a> import me.rhunk.snapenhance.manager.data.download.SEArtifact
 import me.rhunk.snapenhance.manager.data.download.SEVersion
 import me.rhunk.snapenhance.manager.ui.components.DowngradeNoticeDialog
<a href="#h23-1" id="h23-1" class="h">@@ -82,7 +83,9 @@ class SEDownloadTab : Tab(&quot;se_download&quot;) {
</a> 
         var selectedVersion by remember { mutableStateOf(null as SEVersion?) }
         var selectedArtifact by remember { mutableStateOf(null as SEArtifact?) }
<a href="#h23-1-3" id="h23-1-3" class="d">-        val isAppInstalled = remember { runCatching { activity.packageManager.getPackageInfo(sharedConfig.snapEnhancePackageName, 0) != null }.getOrNull() != null }
</a><a href="#h23-1-4" id="h23-1-4" class="i">+        val snapEnhanceApp = remember {
</a><a href="#h23-1-5" id="h23-1-5" class="i">+            runCatching { activity.packageManager.getPackageInfo(BuildConfig.APPLICATION_ID, 0) }.getOrNull()
</a><a href="#h23-1-6" id="h23-1-6" class="i">+        }
</a> 
         var showDowngradeNotice by remember { mutableStateOf(false) }
 
<a href="#h23-2" id="h23-2" class="h">@@ -209,7 +212,21 @@ class SEDownloadTab : Tab(&quot;se_download&quot;) {
</a>                     .fillMaxWidth(),
                 horizontalAlignment = Alignment.CenterHorizontally
             ) {
<a href="#h23-2-3" id="h23-2-3" class="d">-                if (isAppInstalled) {
</a><a href="#h23-2-4" id="h23-2-4" class="i">+                if (snapEnhanceApp != null) {
</a><a href="#h23-2-5" id="h23-2-5" class="i">+                    if (sharedConfig.enableRepackage &amp;&amp; sharedConfig.snapEnhancePackageName != snapEnhanceApp.packageName) {
</a><a href="#h23-2-6" id="h23-2-6" class="i">+                        Button(
</a><a href="#h23-2-7" id="h23-2-7" class="i">+                            onClick = {
</a><a href="#h23-2-8" id="h23-2-8" class="i">+                                navigation.navigateTo(RepackageTab::class, Bundle().apply {
</a><a href="#h23-2-9" id="h23-2-9" class="i">+                                    putString(&quot;apkPath&quot;, snapEnhanceApp.applicationInfo.sourceDir)
</a><a href="#h23-2-10" id="h23-2-10" class="i">+                                    putString(&quot;oldPackage&quot;, snapEnhanceApp.packageName)
</a><a href="#h23-2-11" id="h23-2-11" class="i">+                                }, noHistory = true)
</a><a href="#h23-2-12" id="h23-2-12" class="i">+                            },
</a><a href="#h23-2-13" id="h23-2-13" class="i">+                            enabled = true,
</a><a href="#h23-2-14" id="h23-2-14" class="i">+                            modifier = Modifier.fillMaxWidth()
</a><a href="#h23-2-15" id="h23-2-15" class="i">+                        ) {
</a><a href="#h23-2-16" id="h23-2-16" class="i">+                            Text(text = &quot;Repackage installed version (&gt;=2.0.0)&quot;)
</a><a href="#h23-2-17" id="h23-2-17" class="i">+                        }
</a><a href="#h23-2-18" id="h23-2-18" class="i">+                    }
</a>                     Button(
                         onClick = {
                             triggerPackageInstallation(true)
<a href="#h23-3" id="h23-3" class="h">@@ -222,7 +239,7 @@ class SEDownloadTab : Tab(&quot;se_download&quot;) {
</a>                 }
                 Button(
                     onClick = {
<a href="#h23-3-3" id="h23-3-3" class="d">-                        if (isAppInstalled) {
</a><a href="#h23-3-4" id="h23-3-4" class="i">+                        if (snapEnhanceApp != null) {
</a>                             showDowngradeNotice = true
                         } else {
                             triggerPackageInstallation(false)
<a href="#h23-4" id="h23-4" class="h">@@ -231,7 +248,7 @@ class SEDownloadTab : Tab(&quot;se_download&quot;) {
</a>                     enabled = selectedVersion != null &amp;&amp; selectedArtifact != null,
                     modifier = Modifier.fillMaxWidth()
                 ) {
<a href="#h23-4-3" id="h23-4-3" class="d">-                    Text(text = if (isAppInstalled) &quot;Update&quot; else &quot;Install&quot;)
</a><a href="#h23-4-4" id="h23-4-4" class="i">+                    Text(text = if (snapEnhanceApp != null) &quot;Update&quot; else &quot;Install&quot;)
</a>                 }
             }
         }
<b>diff --git a/<a id="h24" href="../file/manager/src/main/kotlin/me/rhunk/snapenhance/manager/ui/tab/impl/download/SnapchatPatchTab.kt.html">manager/src/main/kotlin/me/rhunk/snapenhance/manager/ui/tab/impl/download/SnapchatPatchTab.kt</a> b/<a href="../file/manager/src/main/kotlin/me/rhunk/snapenhance/manager/ui/tab/impl/download/SnapchatPatchTab.kt.html">manager/src/main/kotlin/me/rhunk/snapenhance/manager/ui/tab/impl/download/SnapchatPatchTab.kt</a></b>
<a href="#h24-0" id="h24-0" class="h">@@ -23,7 +23,7 @@ import kotlinx.coroutines.withContext
</a> import me.rhunk.snapenhance.manager.R
 import me.rhunk.snapenhance.manager.data.APKMirror
 import me.rhunk.snapenhance.manager.data.DownloadItem
<a href="#h24-0-3" id="h24-0-3" class="d">-import me.rhunk.snapenhance.manager.lspatch.config.Constants
</a><a href="#h24-0-4" id="h24-0-4" class="i">+import me.rhunk.snapenhance.manager.patch.config.Constants
</a> import me.rhunk.snapenhance.manager.ui.components.ConfirmationDialog
 import me.rhunk.snapenhance.manager.ui.tab.Tab
 import java.io.File
</pre>
</div>
</body>
</html>
