<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>feat: friend tracker experiment - SnapEnhance - An Xposed module offering an enhanced Snapchat experience
</title>
<link rel="icon" type="image/svg+xml" href="../../logo.png"/>
<link rel="alternate icon" href="../../favicon.png"/>
<link rel="alternate" type="application/atom+xml" title="SnapEnhance Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="SnapEnhance Atom Feed (tags)" href="../tags.xml" />
<link rel="stylesheet" type="text/css" href="../../style.css" />
<link rel="stylesheet" type="text/css" href="../../fonts.css" />
</head>
<body>
<div id="head"><table><tr><td><a class="logo" href="../../"><img src="../../logo.png" alt="" width="32" height="32" /></a></td><td><strong>SnapEnhance</strong><span class="desc"> - An Xposed module offering an enhanced Snapchat experience
</span>
</td></tr></table>
<p><a href="../about.html">About</a> | <a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/LICENSE.html">License</a></p>
</div>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/4aab812e5c161780ec5e08ea4e9a82e8ff5d1f43.html">4aab812e5c161780ec5e08ea4e9a82e8ff5d1f43</a>
<b>parent</b> <a href="../commit/80386d6f582a9fe0b96e6a349857de0a7da35cbe.html">80386d6f582a9fe0b96e6a349857de0a7da35cbe</a>
<b>Author:</b> rhunk &lt;<a href="mailto:101876869+rhunk@users.noreply.github.com">101876869+rhunk@users.noreply.github.com</a>&gt;
<b>Date:</b>   Mon, 19 Feb 2024 00:42:31 +0100

feat: friend tracker experiment

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">app/src/main/kotlin/me/rhunk/snapenhance/RemoteSideContext.kt</a></td><td> | </td><td class="num">6</td><td><span class="i">++++</span><span class="d">--</span></td></tr>
<tr><td class="A">A</td><td><a href="#h1">app/src/main/kotlin/me/rhunk/snapenhance/RemoteTracker.kt</a></td><td> | </td><td class="num">30</td><td><span class="i">++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h2">app/src/main/kotlin/me/rhunk/snapenhance/bridge/BridgeService.kt</a></td><td> | </td><td class="num">3</td><td><span class="i">++</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h3">app/src/main/kotlin/me/rhunk/snapenhance/messaging/ModDatabase.kt</a></td><td> | </td><td class="num">106</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">---</span></td></tr>
<tr><td class="M">M</td><td><a href="#h4">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/Routes.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h5">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/FriendTrackerManagerRoot.kt</a></td><td> | </td><td class="num">331</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h6">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/LoggerHistoryRoot.kt</a></td><td> | </td><td class="num">10</td><td><span class="i">+++++</span><span class="d">-----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h7">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/home/HomeRoot.kt</a></td><td> | </td><td class="num">12</td><td><span class="i">++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h8">common/src/main/aidl/me/rhunk/snapenhance/bridge/BridgeInterface.aidl</a></td><td> | </td><td class="num">7</td><td><span class="i">+++++</span><span class="d">--</span></td></tr>
<tr><td class="D">D</td><td><a href="#h9">common/src/main/aidl/me/rhunk/snapenhance/bridge/MessageLoggerInterface.aidl</a></td><td> | </td><td class="num">30</td><td><span class="i"></span><span class="d">------------------------------</span></td></tr>
<tr><td class="A">A</td><td><a href="#h10">common/src/main/aidl/me/rhunk/snapenhance/bridge/logger/LoggerInterface.aidl</a></td><td> | </td><td class="num">40</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h11">common/src/main/aidl/me/rhunk/snapenhance/bridge/logger/TrackerInterface.aidl</a></td><td> | </td><td class="num">6</td><td><span class="i">++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h12">common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/wrapper/LoggerWrapper.kt</a></td><td> | </td><td class="num">306</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="D">D</td><td><a href="#h13">common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/wrapper/MessageLoggerWrapper.kt</a></td><td> | </td><td class="num">213</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h14">common/src/main/kotlin/me/rhunk/snapenhance/common/data/SessionEventsData.kt</a></td><td> | </td><td class="num">94</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h15">core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/BridgeClient.kt</a></td><td> | </td><td class="num">11</td><td><span class="i">+++++++</span><span class="d">----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h16">core/src/main/kotlin/me/rhunk/snapenhance/core/database/DatabaseAccess.kt</a></td><td> | </td><td class="num">11</td><td><span class="i">+++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h17">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/SessionEvents.kt</a></td><td> | </td><td class="num">141</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h18">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/spying/MessageLogger.kt</a></td><td> | </td><td class="num">12</td><td><span class="i">++++++</span><span class="d">------</span></td></tr>
</table></pre><pre>19 files changed, 1097 insertions(+), 274 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/RemoteSideContext.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/RemoteSideContext.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/RemoteSideContext.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/RemoteSideContext.kt</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -23,8 +23,8 @@ import me.rhunk.snapenhance.bridge.BridgeService
</a> import me.rhunk.snapenhance.common.BuildConfig
 import me.rhunk.snapenhance.common.bridge.types.BridgeFileType
 import me.rhunk.snapenhance.common.bridge.wrapper.LocaleWrapper
<a href="#h0-0-3" id="h0-0-3" class="i">+import me.rhunk.snapenhance.common.bridge.wrapper.LoggerWrapper
</a> import me.rhunk.snapenhance.common.bridge.wrapper.MappingsWrapper
<a href="#h0-0-5" id="h0-0-5" class="d">-import me.rhunk.snapenhance.common.bridge.wrapper.MessageLoggerWrapper
</a> import me.rhunk.snapenhance.common.config.ModConfig
 import me.rhunk.snapenhance.e2ee.E2EEImplementation
 import me.rhunk.snapenhance.messaging.ModDatabase
<a href="#h0-1" id="h0-1" class="h">@@ -69,7 +69,8 @@ class RemoteSideContext(
</a>     val scriptManager = RemoteScriptManager(this)
     val settingsOverlay = SettingsOverlay(this)
     val e2eeImplementation = E2EEImplementation(this)
<a href="#h0-1-3" id="h0-1-3" class="d">-    val messageLogger by lazy { MessageLoggerWrapper(androidContext.getDatabasePath(BridgeFileType.MESSAGE_LOGGER_DATABASE.fileName)) }
</a><a href="#h0-1-4" id="h0-1-4" class="i">+    val messageLogger by lazy { LoggerWrapper(androidContext.getDatabasePath(BridgeFileType.MESSAGE_LOGGER_DATABASE.fileName)) }
</a><a href="#h0-1-5" id="h0-1-5" class="i">+    val tracker = RemoteTracker(this)
</a> 
     //used to load bitmoji selfies and download previews
     val imageLoader by lazy {
<a href="#h0-2" id="h0-2" class="h">@@ -108,6 +109,7 @@ class RemoteSideContext(
</a>             streaksReminder.init()
             scriptManager.init()
             messageLogger.init()
<a href="#h0-2-3" id="h0-2-3" class="i">+            tracker.init()
</a>             config.root.messaging.messageLogger.takeIf {
                 it.globalState == true
             }?.getAutoPurgeTime()?.let {
<b>diff --git a/<a id="h1" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/RemoteTracker.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/RemoteTracker.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/RemoteTracker.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/RemoteTracker.kt</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -0,0 +1,29 @@
</a><a href="#h1-0-0" id="h1-0-0" class="i">+package me.rhunk.snapenhance
</a><a href="#h1-0-1" id="h1-0-1" class="i">+
</a><a href="#h1-0-2" id="h1-0-2" class="i">+import me.rhunk.snapenhance.bridge.logger.TrackerInterface
</a><a href="#h1-0-3" id="h1-0-3" class="i">+import me.rhunk.snapenhance.common.data.TrackerEventsResult
</a><a href="#h1-0-4" id="h1-0-4" class="i">+import me.rhunk.snapenhance.common.data.TrackerRule
</a><a href="#h1-0-5" id="h1-0-5" class="i">+import me.rhunk.snapenhance.common.data.TrackerRuleEvent
</a><a href="#h1-0-6" id="h1-0-6" class="i">+import me.rhunk.snapenhance.common.util.toSerialized
</a><a href="#h1-0-7" id="h1-0-7" class="i">+
</a><a href="#h1-0-8" id="h1-0-8" class="i">+
</a><a href="#h1-0-9" id="h1-0-9" class="i">+class RemoteTracker(
</a><a href="#h1-0-10" id="h1-0-10" class="i">+    private val context: RemoteSideContext
</a><a href="#h1-0-11" id="h1-0-11" class="i">+): TrackerInterface.Stub() {
</a><a href="#h1-0-12" id="h1-0-12" class="i">+    fun init() {
</a><a href="#h1-0-13" id="h1-0-13" class="i">+        /*TrackerEventType.entries.forEach { eventType -&gt;
</a><a href="#h1-0-14" id="h1-0-14" class="i">+            val ruleId = context.modDatabase.addTrackerRule(TrackerFlags.TRACK or TrackerFlags.LOG or TrackerFlags.NOTIFY, null, null)
</a><a href="#h1-0-15" id="h1-0-15" class="i">+            context.modDatabase.addTrackerRuleEvent(ruleId, TrackerFlags.TRACK or TrackerFlags.LOG or TrackerFlags.NOTIFY, eventType.key)
</a><a href="#h1-0-16" id="h1-0-16" class="i">+        }*/
</a><a href="#h1-0-17" id="h1-0-17" class="i">+    }
</a><a href="#h1-0-18" id="h1-0-18" class="i">+
</a><a href="#h1-0-19" id="h1-0-19" class="i">+    override fun getTrackedEvents(eventType: String): String? {
</a><a href="#h1-0-20" id="h1-0-20" class="i">+        val events = mutableMapOf&lt;TrackerRule, MutableList&lt;TrackerRuleEvent&gt;&gt;()
</a><a href="#h1-0-21" id="h1-0-21" class="i">+
</a><a href="#h1-0-22" id="h1-0-22" class="i">+        context.modDatabase.getTrackerEvents(eventType).forEach { (event, rule) -&gt;
</a><a href="#h1-0-23" id="h1-0-23" class="i">+            events.getOrPut(rule) { mutableListOf() }.add(event)
</a><a href="#h1-0-24" id="h1-0-24" class="i">+        }
</a><a href="#h1-0-25" id="h1-0-25" class="i">+
</a><a href="#h1-0-26" id="h1-0-26" class="i">+        return TrackerEventsResult(events).toSerialized()
</a><a href="#h1-0-27" id="h1-0-27" class="i">+    }
</a><a href="#h1-0-28" id="h1-0-28" class="i">+}</a><a href="#h1-0-29" id="h1-0-29" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h2" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/BridgeService.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/BridgeService.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/BridgeService.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/BridgeService.kt</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -176,7 +176,8 @@ class BridgeService : Service() {
</a>         override fun getScriptingInterface() = remoteSideContext.scriptManager
 
         override fun getE2eeInterface() = remoteSideContext.e2eeImplementation
<a href="#h2-0-3" id="h2-0-3" class="d">-        override fun getMessageLogger() = remoteSideContext.messageLogger
</a><a href="#h2-0-4" id="h2-0-4" class="i">+        override fun getLogger() = remoteSideContext.messageLogger
</a><a href="#h2-0-5" id="h2-0-5" class="i">+        override fun getTracker() = remoteSideContext.tracker
</a>         override fun registerMessagingBridge(bridge: MessagingBridge) {
             messagingBridge = bridge
         }
<b>diff --git a/<a id="h3" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/messaging/ModDatabase.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/messaging/ModDatabase.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/messaging/ModDatabase.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/messaging/ModDatabase.kt</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -1,17 +1,17 @@
</a> package me.rhunk.snapenhance.messaging
 
<a href="#h3-0-2" id="h3-0-2" class="i">+import android.content.ContentValues
</a> import android.database.sqlite.SQLiteDatabase
<a href="#h3-0-4" id="h3-0-4" class="i">+import kotlinx.coroutines.runBlocking
</a> import me.rhunk.snapenhance.RemoteSideContext
<a href="#h3-0-6" id="h3-0-6" class="d">-import me.rhunk.snapenhance.common.data.FriendStreaks
</a><a href="#h3-0-7" id="h3-0-7" class="d">-import me.rhunk.snapenhance.common.data.MessagingFriendInfo
</a><a href="#h3-0-8" id="h3-0-8" class="d">-import me.rhunk.snapenhance.common.data.MessagingGroupInfo
</a><a href="#h3-0-9" id="h3-0-9" class="d">-import me.rhunk.snapenhance.common.data.MessagingRuleType
</a><a href="#h3-0-10" id="h3-0-10" class="i">+import me.rhunk.snapenhance.common.data.*
</a> import me.rhunk.snapenhance.common.scripting.type.ModuleInfo
 import me.rhunk.snapenhance.common.util.SQLiteDatabaseHelper
 import me.rhunk.snapenhance.common.util.ktx.getInteger
 import me.rhunk.snapenhance.common.util.ktx.getLongOrNull
 import me.rhunk.snapenhance.common.util.ktx.getStringOrNull
 import java.util.concurrent.Executors
<a href="#h3-0-17" id="h3-0-17" class="i">+import kotlin.coroutines.suspendCoroutine
</a> 
 
 class ModDatabase(
<a href="#h3-1" id="h3-1" class="h">@@ -67,6 +67,18 @@ class ModDatabase(
</a>                 &quot;description VARCHAR&quot;,
                 &quot;author VARCHAR NOT NULL&quot;,
                 &quot;enabled BOOLEAN&quot;
<a href="#h3-1-3" id="h3-1-3" class="i">+            ),
</a><a href="#h3-1-4" id="h3-1-4" class="i">+            &quot;tracker_rules&quot; to listOf(
</a><a href="#h3-1-5" id="h3-1-5" class="i">+                &quot;id INTEGER PRIMARY KEY AUTOINCREMENT&quot;,
</a><a href="#h3-1-6" id="h3-1-6" class="i">+                &quot;flags INTEGER&quot;,
</a><a href="#h3-1-7" id="h3-1-7" class="i">+                &quot;conversation_id CHAR(36)&quot;, // nullable
</a><a href="#h3-1-8" id="h3-1-8" class="i">+                &quot;user_id CHAR(36)&quot;, // nullable
</a><a href="#h3-1-9" id="h3-1-9" class="i">+            ),
</a><a href="#h3-1-10" id="h3-1-10" class="i">+            &quot;tracker_rules_events&quot; to listOf(
</a><a href="#h3-1-11" id="h3-1-11" class="i">+                &quot;id INTEGER PRIMARY KEY AUTOINCREMENT&quot;,
</a><a href="#h3-1-12" id="h3-1-12" class="i">+                &quot;flags INTEGER&quot;,
</a><a href="#h3-1-13" id="h3-1-13" class="i">+                &quot;rule_id INTEGER&quot;,
</a><a href="#h3-1-14" id="h3-1-14" class="i">+                &quot;event_type VARCHAR&quot;,
</a>             )
         ))
     }
<a href="#h3-2" id="h3-2" class="h">@@ -333,4 +345,90 @@ class ModDatabase(
</a>             }
         }
     }
<a href="#h3-2-3" id="h3-2-3" class="i">+
</a><a href="#h3-2-4" id="h3-2-4" class="i">+    fun addTrackerRule(flags: Int, conversationId: String?, userId: String?): Int {
</a><a href="#h3-2-5" id="h3-2-5" class="i">+        return runBlocking {
</a><a href="#h3-2-6" id="h3-2-6" class="i">+            suspendCoroutine { continuation -&gt;
</a><a href="#h3-2-7" id="h3-2-7" class="i">+                executeAsync {
</a><a href="#h3-2-8" id="h3-2-8" class="i">+                    val id = database.insert(&quot;tracker_rules&quot;, null, ContentValues().apply {
</a><a href="#h3-2-9" id="h3-2-9" class="i">+                        put(&quot;flags&quot;, flags)
</a><a href="#h3-2-10" id="h3-2-10" class="i">+                        put(&quot;conversation_id&quot;, conversationId)
</a><a href="#h3-2-11" id="h3-2-11" class="i">+                        put(&quot;user_id&quot;, userId)
</a><a href="#h3-2-12" id="h3-2-12" class="i">+                    })
</a><a href="#h3-2-13" id="h3-2-13" class="i">+                    continuation.resumeWith(Result.success(id.toInt()))
</a><a href="#h3-2-14" id="h3-2-14" class="i">+                }
</a><a href="#h3-2-15" id="h3-2-15" class="i">+            }
</a><a href="#h3-2-16" id="h3-2-16" class="i">+        }
</a><a href="#h3-2-17" id="h3-2-17" class="i">+    }
</a><a href="#h3-2-18" id="h3-2-18" class="i">+
</a><a href="#h3-2-19" id="h3-2-19" class="i">+    fun addTrackerRuleEvent(ruleId: Int, flags: Int, eventType: String) {
</a><a href="#h3-2-20" id="h3-2-20" class="i">+        executeAsync {
</a><a href="#h3-2-21" id="h3-2-21" class="i">+            database.execSQL(&quot;INSERT INTO tracker_rules_events (flags, rule_id, event_type) VALUES (?, ?, ?)&quot;, arrayOf(
</a><a href="#h3-2-22" id="h3-2-22" class="i">+                flags,
</a><a href="#h3-2-23" id="h3-2-23" class="i">+                ruleId,
</a><a href="#h3-2-24" id="h3-2-24" class="i">+                eventType
</a><a href="#h3-2-25" id="h3-2-25" class="i">+            ))
</a><a href="#h3-2-26" id="h3-2-26" class="i">+        }
</a><a href="#h3-2-27" id="h3-2-27" class="i">+    }
</a><a href="#h3-2-28" id="h3-2-28" class="i">+
</a><a href="#h3-2-29" id="h3-2-29" class="i">+     fun getTrackerRules(conversationId: String?, userId: String?): List&lt;TrackerRule&gt; {
</a><a href="#h3-2-30" id="h3-2-30" class="i">+        val rules = mutableListOf&lt;TrackerRule&gt;()
</a><a href="#h3-2-31" id="h3-2-31" class="i">+
</a><a href="#h3-2-32" id="h3-2-32" class="i">+        database.rawQuery(&quot;SELECT * FROM tracker_rules WHERE (conversation_id = ? OR conversation_id IS NULL) AND (user_id = ? OR user_id IS NULL)&quot;, arrayOf(conversationId, userId).filterNotNull().toTypedArray()).use { cursor -&gt;
</a><a href="#h3-2-33" id="h3-2-33" class="i">+            while (cursor.moveToNext()) {
</a><a href="#h3-2-34" id="h3-2-34" class="i">+                rules.add(
</a><a href="#h3-2-35" id="h3-2-35" class="i">+                    TrackerRule(
</a><a href="#h3-2-36" id="h3-2-36" class="i">+                        id = cursor.getInteger(&quot;id&quot;),
</a><a href="#h3-2-37" id="h3-2-37" class="i">+                        flags = cursor.getInteger(&quot;flags&quot;),
</a><a href="#h3-2-38" id="h3-2-38" class="i">+                        conversationId = cursor.getStringOrNull(&quot;conversation_id&quot;),
</a><a href="#h3-2-39" id="h3-2-39" class="i">+                        userId = cursor.getStringOrNull(&quot;user_id&quot;)
</a><a href="#h3-2-40" id="h3-2-40" class="i">+                    )
</a><a href="#h3-2-41" id="h3-2-41" class="i">+                )
</a><a href="#h3-2-42" id="h3-2-42" class="i">+            }
</a><a href="#h3-2-43" id="h3-2-43" class="i">+        }
</a><a href="#h3-2-44" id="h3-2-44" class="i">+        
</a><a href="#h3-2-45" id="h3-2-45" class="i">+        return rules
</a><a href="#h3-2-46" id="h3-2-46" class="i">+    }
</a><a href="#h3-2-47" id="h3-2-47" class="i">+
</a><a href="#h3-2-48" id="h3-2-48" class="i">+    fun getTrackerEvents(ruleId: Int): List&lt;TrackerRuleEvent&gt; {
</a><a href="#h3-2-49" id="h3-2-49" class="i">+        val events = mutableListOf&lt;TrackerRuleEvent&gt;()
</a><a href="#h3-2-50" id="h3-2-50" class="i">+        database.rawQuery(&quot;SELECT * FROM tracker_rules_events WHERE rule_id = ?&quot;, arrayOf(ruleId.toString())).use { cursor -&gt;
</a><a href="#h3-2-51" id="h3-2-51" class="i">+            while (cursor.moveToNext()) {
</a><a href="#h3-2-52" id="h3-2-52" class="i">+                events.add(
</a><a href="#h3-2-53" id="h3-2-53" class="i">+                    TrackerRuleEvent(
</a><a href="#h3-2-54" id="h3-2-54" class="i">+                        id = cursor.getInteger(&quot;id&quot;),
</a><a href="#h3-2-55" id="h3-2-55" class="i">+                        flags = cursor.getInteger(&quot;flags&quot;),
</a><a href="#h3-2-56" id="h3-2-56" class="i">+                        eventType = cursor.getStringOrNull(&quot;event_type&quot;) ?: continue
</a><a href="#h3-2-57" id="h3-2-57" class="i">+                    )
</a><a href="#h3-2-58" id="h3-2-58" class="i">+                )
</a><a href="#h3-2-59" id="h3-2-59" class="i">+            }
</a><a href="#h3-2-60" id="h3-2-60" class="i">+        }
</a><a href="#h3-2-61" id="h3-2-61" class="i">+        return events
</a><a href="#h3-2-62" id="h3-2-62" class="i">+    }
</a><a href="#h3-2-63" id="h3-2-63" class="i">+
</a><a href="#h3-2-64" id="h3-2-64" class="i">+    fun getTrackerEvents(eventType: String): Map&lt;TrackerRuleEvent, TrackerRule&gt; {
</a><a href="#h3-2-65" id="h3-2-65" class="i">+        val events = mutableMapOf&lt;TrackerRuleEvent, TrackerRule&gt;()
</a><a href="#h3-2-66" id="h3-2-66" class="i">+        database.rawQuery(&quot;SELECT tracker_rules_events.id as event_id, tracker_rules_events.flags, tracker_rules_events.event_type, tracker_rules.conversation_id, tracker_rules.user_id &quot; +
</a><a href="#h3-2-67" id="h3-2-67" class="i">+                &quot;FROM tracker_rules_events &quot; +
</a><a href="#h3-2-68" id="h3-2-68" class="i">+                &quot;INNER JOIN tracker_rules &quot; +
</a><a href="#h3-2-69" id="h3-2-69" class="i">+                &quot;ON tracker_rules_events.rule_id = tracker_rules.id &quot; +
</a><a href="#h3-2-70" id="h3-2-70" class="i">+                &quot;WHERE event_type = ?&quot;, arrayOf(eventType)
</a><a href="#h3-2-71" id="h3-2-71" class="i">+        ).use { cursor -&gt;
</a><a href="#h3-2-72" id="h3-2-72" class="i">+            while (cursor.moveToNext()) {
</a><a href="#h3-2-73" id="h3-2-73" class="i">+                val trackerRule = TrackerRule(
</a><a href="#h3-2-74" id="h3-2-74" class="i">+                    id = -1,
</a><a href="#h3-2-75" id="h3-2-75" class="i">+                    flags = cursor.getInteger(&quot;flags&quot;),
</a><a href="#h3-2-76" id="h3-2-76" class="i">+                    conversationId = cursor.getStringOrNull(&quot;conversation_id&quot;),
</a><a href="#h3-2-77" id="h3-2-77" class="i">+                    userId = cursor.getStringOrNull(&quot;user_id&quot;)
</a><a href="#h3-2-78" id="h3-2-78" class="i">+                )
</a><a href="#h3-2-79" id="h3-2-79" class="i">+                val trackerRuleEvent = TrackerRuleEvent(
</a><a href="#h3-2-80" id="h3-2-80" class="i">+                    id = cursor.getInteger(&quot;event_id&quot;),
</a><a href="#h3-2-81" id="h3-2-81" class="i">+                    flags = cursor.getInteger(&quot;flags&quot;),
</a><a href="#h3-2-82" id="h3-2-82" class="i">+                    eventType = cursor.getStringOrNull(&quot;event_type&quot;) ?: continue
</a><a href="#h3-2-83" id="h3-2-83" class="i">+                )
</a><a href="#h3-2-84" id="h3-2-84" class="i">+                events[trackerRuleEvent] = trackerRule
</a><a href="#h3-2-85" id="h3-2-85" class="i">+            }
</a><a href="#h3-2-86" id="h3-2-86" class="i">+        }
</a><a href="#h3-2-87" id="h3-2-87" class="i">+        return events
</a><a href="#h3-2-88" id="h3-2-88" class="i">+    }
</a> } 
\ No newline at end of file
<b>diff --git a/<a id="h4" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/Routes.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/Routes.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/Routes.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/Routes.kt</a></b>
<a href="#h4-0" id="h4-0" class="h">@@ -15,6 +15,7 @@ import androidx.navigation.NavDestination.Companion.hierarchy
</a> import androidx.navigation.NavGraph.Companion.findStartDestination
 import androidx.navigation.NavGraphBuilder
 import me.rhunk.snapenhance.RemoteSideContext
<a href="#h4-0-3" id="h4-0-3" class="i">+import me.rhunk.snapenhance.ui.manager.pages.FriendTrackerManagerRoot
</a> import me.rhunk.snapenhance.ui.manager.pages.LoggerHistoryRoot
 import me.rhunk.snapenhance.ui.manager.pages.TasksRoot
 import me.rhunk.snapenhance.ui.manager.pages.features.FeaturesRoot
<a href="#h4-1" id="h4-1" class="h">@@ -53,6 +54,7 @@ class Routes(
</a>     val settings = route(RouteInfo(&quot;home_settings&quot;), HomeSettings()).parent(home)
     val homeLogs = route(RouteInfo(&quot;home_logs&quot;), HomeLogs()).parent(home)
     val loggerHistory = route(RouteInfo(&quot;logger_history&quot;), LoggerHistoryRoot()).parent(home)
<a href="#h4-1-3" id="h4-1-3" class="i">+    val friendTracker = route(RouteInfo(&quot;friend_tracker&quot;), FriendTrackerManagerRoot()).parent(home)
</a> 
     val social = route(RouteInfo(&quot;social&quot;, icon = Icons.Default.Group, primary = true), SocialRoot())
     val manageScope = route(RouteInfo(&quot;manage_scope/?scope={scope}&amp;id={id}&quot;), ManageScope()).parent(social)
<b>diff --git a/<a id="h5" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/FriendTrackerManagerRoot.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/FriendTrackerManagerRoot.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/FriendTrackerManagerRoot.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/FriendTrackerManagerRoot.kt</a></b>
<a href="#h5-0" id="h5-0" class="h">@@ -0,0 +1,330 @@
</a><a href="#h5-0-0" id="h5-0-0" class="i">+package me.rhunk.snapenhance.ui.manager.pages
</a><a href="#h5-0-1" id="h5-0-1" class="i">+
</a><a href="#h5-0-2" id="h5-0-2" class="i">+import androidx.compose.foundation.ExperimentalFoundationApi
</a><a href="#h5-0-3" id="h5-0-3" class="i">+import androidx.compose.foundation.layout.*
</a><a href="#h5-0-4" id="h5-0-4" class="i">+import androidx.compose.foundation.lazy.LazyColumn
</a><a href="#h5-0-5" id="h5-0-5" class="i">+import androidx.compose.foundation.lazy.items
</a><a href="#h5-0-6" id="h5-0-6" class="i">+import androidx.compose.foundation.pager.HorizontalPager
</a><a href="#h5-0-7" id="h5-0-7" class="i">+import androidx.compose.foundation.pager.rememberPagerState
</a><a href="#h5-0-8" id="h5-0-8" class="i">+import androidx.compose.material.icons.Icons
</a><a href="#h5-0-9" id="h5-0-9" class="i">+import androidx.compose.material.icons.filled.Add
</a><a href="#h5-0-10" id="h5-0-10" class="i">+import androidx.compose.material.icons.filled.DeleteOutline
</a><a href="#h5-0-11" id="h5-0-11" class="i">+import androidx.compose.material3.*
</a><a href="#h5-0-12" id="h5-0-12" class="i">+import androidx.compose.runtime.*
</a><a href="#h5-0-13" id="h5-0-13" class="i">+import androidx.compose.ui.Alignment
</a><a href="#h5-0-14" id="h5-0-14" class="i">+import androidx.compose.ui.Modifier
</a><a href="#h5-0-15" id="h5-0-15" class="i">+import androidx.compose.ui.graphics.Color
</a><a href="#h5-0-16" id="h5-0-16" class="i">+import androidx.compose.ui.text.font.FontWeight
</a><a href="#h5-0-17" id="h5-0-17" class="i">+import androidx.compose.ui.text.style.TextAlign
</a><a href="#h5-0-18" id="h5-0-18" class="i">+import androidx.compose.ui.text.style.TextOverflow
</a><a href="#h5-0-19" id="h5-0-19" class="i">+import androidx.compose.ui.unit.dp
</a><a href="#h5-0-20" id="h5-0-20" class="i">+import androidx.compose.ui.unit.sp
</a><a href="#h5-0-21" id="h5-0-21" class="i">+import androidx.compose.ui.window.PopupProperties
</a><a href="#h5-0-22" id="h5-0-22" class="i">+import androidx.navigation.NavBackStackEntry
</a><a href="#h5-0-23" id="h5-0-23" class="i">+import kotlinx.coroutines.Dispatchers
</a><a href="#h5-0-24" id="h5-0-24" class="i">+import kotlinx.coroutines.Job
</a><a href="#h5-0-25" id="h5-0-25" class="i">+import kotlinx.coroutines.delay
</a><a href="#h5-0-26" id="h5-0-26" class="i">+import kotlinx.coroutines.launch
</a><a href="#h5-0-27" id="h5-0-27" class="i">+import kotlinx.coroutines.withContext
</a><a href="#h5-0-28" id="h5-0-28" class="i">+import me.rhunk.snapenhance.common.bridge.wrapper.TrackerLog
</a><a href="#h5-0-29" id="h5-0-29" class="i">+import me.rhunk.snapenhance.common.data.TrackerEventType
</a><a href="#h5-0-30" id="h5-0-30" class="i">+import me.rhunk.snapenhance.common.data.TrackerRule
</a><a href="#h5-0-31" id="h5-0-31" class="i">+import me.rhunk.snapenhance.common.data.TrackerRuleEvent
</a><a href="#h5-0-32" id="h5-0-32" class="i">+import me.rhunk.snapenhance.ui.manager.Routes
</a><a href="#h5-0-33" id="h5-0-33" class="i">+import me.rhunk.snapenhance.ui.util.pagerTabIndicatorOffset
</a><a href="#h5-0-34" id="h5-0-34" class="i">+import java.text.DateFormat
</a><a href="#h5-0-35" id="h5-0-35" class="i">+
</a><a href="#h5-0-36" id="h5-0-36" class="i">+
</a><a href="#h5-0-37" id="h5-0-37" class="i">+@OptIn(ExperimentalFoundationApi::class)
</a><a href="#h5-0-38" id="h5-0-38" class="i">+class FriendTrackerManagerRoot : Routes.Route() {
</a><a href="#h5-0-39" id="h5-0-39" class="i">+    enum class FilterType {
</a><a href="#h5-0-40" id="h5-0-40" class="i">+        CONVERSATION, USERNAME, EVENT
</a><a href="#h5-0-41" id="h5-0-41" class="i">+    }
</a><a href="#h5-0-42" id="h5-0-42" class="i">+
</a><a href="#h5-0-43" id="h5-0-43" class="i">+    private val titles = listOf(&quot;Logs&quot;, &quot;Config Rules&quot;)
</a><a href="#h5-0-44" id="h5-0-44" class="i">+    private var currentPage by mutableIntStateOf(0)
</a><a href="#h5-0-45" id="h5-0-45" class="i">+
</a><a href="#h5-0-46" id="h5-0-46" class="i">+    override val floatingActionButton: @Composable () -&gt; Unit = {
</a><a href="#h5-0-47" id="h5-0-47" class="i">+        if (currentPage == 1) {
</a><a href="#h5-0-48" id="h5-0-48" class="i">+            ExtendedFloatingActionButton(
</a><a href="#h5-0-49" id="h5-0-49" class="i">+                icon = { Icon(Icons.Default.Add, contentDescription = &quot;Add Rule&quot;) },
</a><a href="#h5-0-50" id="h5-0-50" class="i">+                expanded = false,
</a><a href="#h5-0-51" id="h5-0-51" class="i">+                text = {},
</a><a href="#h5-0-52" id="h5-0-52" class="i">+                onClick = {}
</a><a href="#h5-0-53" id="h5-0-53" class="i">+            )
</a><a href="#h5-0-54" id="h5-0-54" class="i">+        }
</a><a href="#h5-0-55" id="h5-0-55" class="i">+    }
</a><a href="#h5-0-56" id="h5-0-56" class="i">+
</a><a href="#h5-0-57" id="h5-0-57" class="i">+    @OptIn(ExperimentalMaterial3Api::class)
</a><a href="#h5-0-58" id="h5-0-58" class="i">+    @Composable
</a><a href="#h5-0-59" id="h5-0-59" class="i">+    private fun LogsTab() {
</a><a href="#h5-0-60" id="h5-0-60" class="i">+        val coroutineScope = rememberCoroutineScope()
</a><a href="#h5-0-61" id="h5-0-61" class="i">+
</a><a href="#h5-0-62" id="h5-0-62" class="i">+        val logs = remember { mutableStateListOf&lt;TrackerLog&gt;() }
</a><a href="#h5-0-63" id="h5-0-63" class="i">+        var lastTimestamp by remember { mutableLongStateOf(Long.MAX_VALUE) }
</a><a href="#h5-0-64" id="h5-0-64" class="i">+        var filterType by remember { mutableStateOf(FilterType.USERNAME) }
</a><a href="#h5-0-65" id="h5-0-65" class="i">+
</a><a href="#h5-0-66" id="h5-0-66" class="i">+        var filter by remember { mutableStateOf(&quot;&quot;) }
</a><a href="#h5-0-67" id="h5-0-67" class="i">+        var searchTimeoutJob by remember { mutableStateOf&lt;Job?&gt;(null) }
</a><a href="#h5-0-68" id="h5-0-68" class="i">+
</a><a href="#h5-0-69" id="h5-0-69" class="i">+        suspend fun loadNewLogs() {
</a><a href="#h5-0-70" id="h5-0-70" class="i">+            withContext(Dispatchers.IO) {
</a><a href="#h5-0-71" id="h5-0-71" class="i">+                logs.addAll(context.messageLogger.getLogs(lastTimestamp, filter = {
</a><a href="#h5-0-72" id="h5-0-72" class="i">+                    when (filterType) {
</a><a href="#h5-0-73" id="h5-0-73" class="i">+                        FilterType.USERNAME -&gt; it.username.contains(filter, ignoreCase = true)
</a><a href="#h5-0-74" id="h5-0-74" class="i">+                        FilterType.CONVERSATION -&gt; it.conversationTitle?.contains(filter, ignoreCase = true) == true || (it.username == filter &amp;&amp; !it.isGroup)
</a><a href="#h5-0-75" id="h5-0-75" class="i">+                        FilterType.EVENT -&gt; it.eventType.contains(filter, ignoreCase = true)
</a><a href="#h5-0-76" id="h5-0-76" class="i">+                    }
</a><a href="#h5-0-77" id="h5-0-77" class="i">+                }).apply {
</a><a href="#h5-0-78" id="h5-0-78" class="i">+                    lastTimestamp = minOfOrNull { it.timestamp } ?: lastTimestamp
</a><a href="#h5-0-79" id="h5-0-79" class="i">+                })
</a><a href="#h5-0-80" id="h5-0-80" class="i">+            }
</a><a href="#h5-0-81" id="h5-0-81" class="i">+        }
</a><a href="#h5-0-82" id="h5-0-82" class="i">+
</a><a href="#h5-0-83" id="h5-0-83" class="i">+        suspend fun resetAndLoadLogs() {
</a><a href="#h5-0-84" id="h5-0-84" class="i">+            logs.clear()
</a><a href="#h5-0-85" id="h5-0-85" class="i">+            lastTimestamp = Long.MAX_VALUE
</a><a href="#h5-0-86" id="h5-0-86" class="i">+            loadNewLogs()
</a><a href="#h5-0-87" id="h5-0-87" class="i">+        }
</a><a href="#h5-0-88" id="h5-0-88" class="i">+
</a><a href="#h5-0-89" id="h5-0-89" class="i">+        Column(
</a><a href="#h5-0-90" id="h5-0-90" class="i">+            modifier = Modifier.fillMaxSize()
</a><a href="#h5-0-91" id="h5-0-91" class="i">+        ) {
</a><a href="#h5-0-92" id="h5-0-92" class="i">+            Row(
</a><a href="#h5-0-93" id="h5-0-93" class="i">+                modifier = Modifier.fillMaxWidth(),
</a><a href="#h5-0-94" id="h5-0-94" class="i">+                verticalAlignment = Alignment.CenterVertically,
</a><a href="#h5-0-95" id="h5-0-95" class="i">+            ) {
</a><a href="#h5-0-96" id="h5-0-96" class="i">+                var showAutoComplete by remember { mutableStateOf(false) }
</a><a href="#h5-0-97" id="h5-0-97" class="i">+                ExposedDropdownMenuBox(expanded = showAutoComplete, onExpandedChange = { showAutoComplete = it }) {
</a><a href="#h5-0-98" id="h5-0-98" class="i">+                    TextField(
</a><a href="#h5-0-99" id="h5-0-99" class="i">+                        value = filter,
</a><a href="#h5-0-100" id="h5-0-100" class="i">+                        onValueChange = {
</a><a href="#h5-0-101" id="h5-0-101" class="i">+                            filter = it
</a><a href="#h5-0-102" id="h5-0-102" class="i">+                            coroutineScope.launch {
</a><a href="#h5-0-103" id="h5-0-103" class="i">+                                searchTimeoutJob?.cancel()
</a><a href="#h5-0-104" id="h5-0-104" class="i">+                                searchTimeoutJob = coroutineScope.launch {
</a><a href="#h5-0-105" id="h5-0-105" class="i">+                                    delay(200)
</a><a href="#h5-0-106" id="h5-0-106" class="i">+                                    showAutoComplete = true
</a><a href="#h5-0-107" id="h5-0-107" class="i">+                                    resetAndLoadLogs()
</a><a href="#h5-0-108" id="h5-0-108" class="i">+                                }
</a><a href="#h5-0-109" id="h5-0-109" class="i">+                            }
</a><a href="#h5-0-110" id="h5-0-110" class="i">+                        },
</a><a href="#h5-0-111" id="h5-0-111" class="i">+                        placeholder = { Text(&quot;Search&quot;) },
</a><a href="#h5-0-112" id="h5-0-112" class="i">+                        maxLines = 1,
</a><a href="#h5-0-113" id="h5-0-113" class="i">+                        colors = TextFieldDefaults.colors(
</a><a href="#h5-0-114" id="h5-0-114" class="i">+                            focusedContainerColor = Color.Transparent,
</a><a href="#h5-0-115" id="h5-0-115" class="i">+                            unfocusedContainerColor = Color.Transparent
</a><a href="#h5-0-116" id="h5-0-116" class="i">+                        ),
</a><a href="#h5-0-117" id="h5-0-117" class="i">+                        modifier = Modifier
</a><a href="#h5-0-118" id="h5-0-118" class="i">+                            .weight(1F)
</a><a href="#h5-0-119" id="h5-0-119" class="i">+                            .menuAnchor()
</a><a href="#h5-0-120" id="h5-0-120" class="i">+                            .padding(8.dp)
</a><a href="#h5-0-121" id="h5-0-121" class="i">+                    )
</a><a href="#h5-0-122" id="h5-0-122" class="i">+
</a><a href="#h5-0-123" id="h5-0-123" class="i">+                    DropdownMenu(expanded = showAutoComplete, onDismissRequest = {
</a><a href="#h5-0-124" id="h5-0-124" class="i">+                        showAutoComplete = false
</a><a href="#h5-0-125" id="h5-0-125" class="i">+                    }, properties = PopupProperties(focusable = false)) {
</a><a href="#h5-0-126" id="h5-0-126" class="i">+                        val suggestedEntries = remember(filter) {
</a><a href="#h5-0-127" id="h5-0-127" class="i">+                            mutableStateListOf&lt;String&gt;()
</a><a href="#h5-0-128" id="h5-0-128" class="i">+                        }
</a><a href="#h5-0-129" id="h5-0-129" class="i">+
</a><a href="#h5-0-130" id="h5-0-130" class="i">+                        LaunchedEffect(filter) {
</a><a href="#h5-0-131" id="h5-0-131" class="i">+                            suggestedEntries.addAll(when (filterType) {
</a><a href="#h5-0-132" id="h5-0-132" class="i">+                                FilterType.USERNAME -&gt; context.messageLogger.findUsername(filter)
</a><a href="#h5-0-133" id="h5-0-133" class="i">+                                FilterType.CONVERSATION -&gt; context.messageLogger.findConversation(filter) + context.messageLogger.findUsername(filter)
</a><a href="#h5-0-134" id="h5-0-134" class="i">+                                FilterType.EVENT -&gt; TrackerEventType.entries.filter { it.name.contains(filter, ignoreCase = true) }.map { it.key }
</a><a href="#h5-0-135" id="h5-0-135" class="i">+                            }.take(5))
</a><a href="#h5-0-136" id="h5-0-136" class="i">+                        }
</a><a href="#h5-0-137" id="h5-0-137" class="i">+
</a><a href="#h5-0-138" id="h5-0-138" class="i">+                        suggestedEntries.forEach { entry -&gt;
</a><a href="#h5-0-139" id="h5-0-139" class="i">+                            DropdownMenuItem(onClick = {
</a><a href="#h5-0-140" id="h5-0-140" class="i">+                                filter = entry
</a><a href="#h5-0-141" id="h5-0-141" class="i">+                                coroutineScope.launch {
</a><a href="#h5-0-142" id="h5-0-142" class="i">+                                    resetAndLoadLogs()
</a><a href="#h5-0-143" id="h5-0-143" class="i">+                                }
</a><a href="#h5-0-144" id="h5-0-144" class="i">+                                showAutoComplete = false
</a><a href="#h5-0-145" id="h5-0-145" class="i">+                            }, text = {
</a><a href="#h5-0-146" id="h5-0-146" class="i">+                                Text(entry)
</a><a href="#h5-0-147" id="h5-0-147" class="i">+                            })
</a><a href="#h5-0-148" id="h5-0-148" class="i">+                        }
</a><a href="#h5-0-149" id="h5-0-149" class="i">+                    }
</a><a href="#h5-0-150" id="h5-0-150" class="i">+                }
</a><a href="#h5-0-151" id="h5-0-151" class="i">+
</a><a href="#h5-0-152" id="h5-0-152" class="i">+                var dropDownExpanded by remember { mutableStateOf(false) }
</a><a href="#h5-0-153" id="h5-0-153" class="i">+                ExposedDropdownMenuBox(expanded = dropDownExpanded, onExpandedChange = { dropDownExpanded = it }) {
</a><a href="#h5-0-154" id="h5-0-154" class="i">+                    ElevatedCard(
</a><a href="#h5-0-155" id="h5-0-155" class="i">+                        modifier = Modifier.menuAnchor()
</a><a href="#h5-0-156" id="h5-0-156" class="i">+                    ) {
</a><a href="#h5-0-157" id="h5-0-157" class="i">+                        Text(&quot;Filter &quot; + filterType.name, modifier = Modifier.padding(8.dp))
</a><a href="#h5-0-158" id="h5-0-158" class="i">+                    }
</a><a href="#h5-0-159" id="h5-0-159" class="i">+                    DropdownMenu(expanded = dropDownExpanded, onDismissRequest = {
</a><a href="#h5-0-160" id="h5-0-160" class="i">+                        dropDownExpanded = false
</a><a href="#h5-0-161" id="h5-0-161" class="i">+                    }) {
</a><a href="#h5-0-162" id="h5-0-162" class="i">+                        FilterType.entries.forEach { type -&gt;
</a><a href="#h5-0-163" id="h5-0-163" class="i">+                            DropdownMenuItem(onClick = {
</a><a href="#h5-0-164" id="h5-0-164" class="i">+                                filterType = type
</a><a href="#h5-0-165" id="h5-0-165" class="i">+                                dropDownExpanded = false
</a><a href="#h5-0-166" id="h5-0-166" class="i">+                                coroutineScope.launch {
</a><a href="#h5-0-167" id="h5-0-167" class="i">+                                    resetAndLoadLogs()
</a><a href="#h5-0-168" id="h5-0-168" class="i">+                                }
</a><a href="#h5-0-169" id="h5-0-169" class="i">+                            }, text = {
</a><a href="#h5-0-170" id="h5-0-170" class="i">+                                Text(type.name)
</a><a href="#h5-0-171" id="h5-0-171" class="i">+                            })
</a><a href="#h5-0-172" id="h5-0-172" class="i">+                        }
</a><a href="#h5-0-173" id="h5-0-173" class="i">+                    }
</a><a href="#h5-0-174" id="h5-0-174" class="i">+                }
</a><a href="#h5-0-175" id="h5-0-175" class="i">+            }
</a><a href="#h5-0-176" id="h5-0-176" class="i">+
</a><a href="#h5-0-177" id="h5-0-177" class="i">+            LazyColumn(
</a><a href="#h5-0-178" id="h5-0-178" class="i">+                modifier = Modifier.weight(1f)
</a><a href="#h5-0-179" id="h5-0-179" class="i">+            ) {
</a><a href="#h5-0-180" id="h5-0-180" class="i">+                item {
</a><a href="#h5-0-181" id="h5-0-181" class="i">+                    if (logs.isEmpty()) {
</a><a href="#h5-0-182" id="h5-0-182" class="i">+                        Text(&quot;No logs found&quot;, modifier = Modifier.padding(16.dp).fillMaxWidth(), textAlign = TextAlign.Center, fontWeight = FontWeight.Light)
</a><a href="#h5-0-183" id="h5-0-183" class="i">+                    }
</a><a href="#h5-0-184" id="h5-0-184" class="i">+                }
</a><a href="#h5-0-185" id="h5-0-185" class="i">+                items(logs) { log -&gt;
</a><a href="#h5-0-186" id="h5-0-186" class="i">+                    ElevatedCard(
</a><a href="#h5-0-187" id="h5-0-187" class="i">+                        modifier = Modifier
</a><a href="#h5-0-188" id="h5-0-188" class="i">+                            .fillMaxWidth()
</a><a href="#h5-0-189" id="h5-0-189" class="i">+                            .padding(5.dp)
</a><a href="#h5-0-190" id="h5-0-190" class="i">+                    ) {
</a><a href="#h5-0-191" id="h5-0-191" class="i">+                        Row(
</a><a href="#h5-0-192" id="h5-0-192" class="i">+                            modifier = Modifier
</a><a href="#h5-0-193" id="h5-0-193" class="i">+                                .fillMaxWidth()
</a><a href="#h5-0-194" id="h5-0-194" class="i">+                                .padding(8.dp),
</a><a href="#h5-0-195" id="h5-0-195" class="i">+                        ) {
</a><a href="#h5-0-196" id="h5-0-196" class="i">+                            Column(
</a><a href="#h5-0-197" id="h5-0-197" class="i">+                                modifier = Modifier
</a><a href="#h5-0-198" id="h5-0-198" class="i">+                                    .weight(1f)
</a><a href="#h5-0-199" id="h5-0-199" class="i">+                            ) {
</a><a href="#h5-0-200" id="h5-0-200" class="i">+                                Text(log.username + &quot; &quot; + log.eventType + &quot; in &quot; + log.conversationTitle)
</a><a href="#h5-0-201" id="h5-0-201" class="i">+                                Text(
</a><a href="#h5-0-202" id="h5-0-202" class="i">+                                    DateFormat.getDateTimeInstance().format(log.timestamp),
</a><a href="#h5-0-203" id="h5-0-203" class="i">+                                    fontSize = 12.sp,
</a><a href="#h5-0-204" id="h5-0-204" class="i">+                                    fontWeight = FontWeight.Light
</a><a href="#h5-0-205" id="h5-0-205" class="i">+                                )
</a><a href="#h5-0-206" id="h5-0-206" class="i">+                            }
</a><a href="#h5-0-207" id="h5-0-207" class="i">+
</a><a href="#h5-0-208" id="h5-0-208" class="i">+                            OutlinedIconButton(
</a><a href="#h5-0-209" id="h5-0-209" class="i">+                                onClick = {
</a><a href="#h5-0-210" id="h5-0-210" class="i">+
</a><a href="#h5-0-211" id="h5-0-211" class="i">+                                }
</a><a href="#h5-0-212" id="h5-0-212" class="i">+                            ) {
</a><a href="#h5-0-213" id="h5-0-213" class="i">+                                Icon(Icons.Default.DeleteOutline, contentDescription = &quot;Delete&quot;)
</a><a href="#h5-0-214" id="h5-0-214" class="i">+                            }
</a><a href="#h5-0-215" id="h5-0-215" class="i">+                        }
</a><a href="#h5-0-216" id="h5-0-216" class="i">+                    }
</a><a href="#h5-0-217" id="h5-0-217" class="i">+                }
</a><a href="#h5-0-218" id="h5-0-218" class="i">+                item {
</a><a href="#h5-0-219" id="h5-0-219" class="i">+                    Spacer(modifier = Modifier.height(16.dp))
</a><a href="#h5-0-220" id="h5-0-220" class="i">+
</a><a href="#h5-0-221" id="h5-0-221" class="i">+                    LaunchedEffect(lastTimestamp) {
</a><a href="#h5-0-222" id="h5-0-222" class="i">+                        loadNewLogs()
</a><a href="#h5-0-223" id="h5-0-223" class="i">+                    }
</a><a href="#h5-0-224" id="h5-0-224" class="i">+                }
</a><a href="#h5-0-225" id="h5-0-225" class="i">+            }
</a><a href="#h5-0-226" id="h5-0-226" class="i">+        }
</a><a href="#h5-0-227" id="h5-0-227" class="i">+
</a><a href="#h5-0-228" id="h5-0-228" class="i">+    }
</a><a href="#h5-0-229" id="h5-0-229" class="i">+
</a><a href="#h5-0-230" id="h5-0-230" class="i">+    @Composable
</a><a href="#h5-0-231" id="h5-0-231" class="i">+    @OptIn(ExperimentalLayoutApi::class)
</a><a href="#h5-0-232" id="h5-0-232" class="i">+    private fun ConfigRulesTab() {
</a><a href="#h5-0-233" id="h5-0-233" class="i">+        val rules = remember { mutableStateListOf&lt;TrackerRule&gt;() }
</a><a href="#h5-0-234" id="h5-0-234" class="i">+
</a><a href="#h5-0-235" id="h5-0-235" class="i">+        Column(
</a><a href="#h5-0-236" id="h5-0-236" class="i">+            modifier = Modifier.fillMaxSize()
</a><a href="#h5-0-237" id="h5-0-237" class="i">+        ) {
</a><a href="#h5-0-238" id="h5-0-238" class="i">+            LazyColumn(
</a><a href="#h5-0-239" id="h5-0-239" class="i">+                modifier = Modifier.weight(1f)
</a><a href="#h5-0-240" id="h5-0-240" class="i">+            ) {
</a><a href="#h5-0-241" id="h5-0-241" class="i">+                items(rules) { rule -&gt;
</a><a href="#h5-0-242" id="h5-0-242" class="i">+                    val events = remember(rule.id) {
</a><a href="#h5-0-243" id="h5-0-243" class="i">+                        mutableStateListOf&lt;TrackerRuleEvent&gt;()
</a><a href="#h5-0-244" id="h5-0-244" class="i">+                    }
</a><a href="#h5-0-245" id="h5-0-245" class="i">+
</a><a href="#h5-0-246" id="h5-0-246" class="i">+                    LaunchedEffect(rule.id) {
</a><a href="#h5-0-247" id="h5-0-247" class="i">+                        withContext(Dispatchers.IO) {
</a><a href="#h5-0-248" id="h5-0-248" class="i">+                            events.addAll(context.modDatabase.getTrackerEvents(rule.id))
</a><a href="#h5-0-249" id="h5-0-249" class="i">+                        }
</a><a href="#h5-0-250" id="h5-0-250" class="i">+                    }
</a><a href="#h5-0-251" id="h5-0-251" class="i">+
</a><a href="#h5-0-252" id="h5-0-252" class="i">+                    ElevatedCard(
</a><a href="#h5-0-253" id="h5-0-253" class="i">+                        modifier = Modifier
</a><a href="#h5-0-254" id="h5-0-254" class="i">+                            .fillMaxWidth()
</a><a href="#h5-0-255" id="h5-0-255" class="i">+                            .padding(5.dp)
</a><a href="#h5-0-256" id="h5-0-256" class="i">+                    ) {
</a><a href="#h5-0-257" id="h5-0-257" class="i">+                        Column(
</a><a href="#h5-0-258" id="h5-0-258" class="i">+                            modifier = Modifier
</a><a href="#h5-0-259" id="h5-0-259" class="i">+                                .fillMaxWidth()
</a><a href="#h5-0-260" id="h5-0-260" class="i">+                                .padding(16.dp),
</a><a href="#h5-0-261" id="h5-0-261" class="i">+                            verticalArrangement = Arrangement.spacedBy(2.dp)
</a><a href="#h5-0-262" id="h5-0-262" class="i">+                        ) {
</a><a href="#h5-0-263" id="h5-0-263" class="i">+                            Text(&quot;Rule: ${rule.id} - conversationId: ${rule.conversationId?.let { &quot;present&quot; } ?: &quot;none&quot; } - userId: ${rule.userId?.let { &quot;present&quot; } ?: &quot;none&quot;}&quot;)
</a><a href="#h5-0-264" id="h5-0-264" class="i">+                            FlowRow(
</a><a href="#h5-0-265" id="h5-0-265" class="i">+                                modifier = Modifier.fillMaxWidth(),
</a><a href="#h5-0-266" id="h5-0-266" class="i">+                                horizontalArrangement = Arrangement.spacedBy(5.dp)
</a><a href="#h5-0-267" id="h5-0-267" class="i">+                            ) {
</a><a href="#h5-0-268" id="h5-0-268" class="i">+                                events.forEach { event -&gt;
</a><a href="#h5-0-269" id="h5-0-269" class="i">+                                    Text(&quot;${event.eventType} - ${event.flags}&quot;)
</a><a href="#h5-0-270" id="h5-0-270" class="i">+                                }
</a><a href="#h5-0-271" id="h5-0-271" class="i">+                            }
</a><a href="#h5-0-272" id="h5-0-272" class="i">+                        }
</a><a href="#h5-0-273" id="h5-0-273" class="i">+                    }
</a><a href="#h5-0-274" id="h5-0-274" class="i">+                }
</a><a href="#h5-0-275" id="h5-0-275" class="i">+            }
</a><a href="#h5-0-276" id="h5-0-276" class="i">+        }
</a><a href="#h5-0-277" id="h5-0-277" class="i">+
</a><a href="#h5-0-278" id="h5-0-278" class="i">+        LaunchedEffect(Unit) {
</a><a href="#h5-0-279" id="h5-0-279" class="i">+            rules.addAll(context.modDatabase.getTrackerRules(null, null))
</a><a href="#h5-0-280" id="h5-0-280" class="i">+        }
</a><a href="#h5-0-281" id="h5-0-281" class="i">+    }
</a><a href="#h5-0-282" id="h5-0-282" class="i">+
</a><a href="#h5-0-283" id="h5-0-283" class="i">+
</a><a href="#h5-0-284" id="h5-0-284" class="i">+    @OptIn(ExperimentalFoundationApi::class)
</a><a href="#h5-0-285" id="h5-0-285" class="i">+    override val content: @Composable (NavBackStackEntry) -&gt; Unit = {
</a><a href="#h5-0-286" id="h5-0-286" class="i">+        val coroutineScope = rememberCoroutineScope()
</a><a href="#h5-0-287" id="h5-0-287" class="i">+        val pagerState = rememberPagerState { titles.size }
</a><a href="#h5-0-288" id="h5-0-288" class="i">+        currentPage = pagerState.currentPage
</a><a href="#h5-0-289" id="h5-0-289" class="i">+
</a><a href="#h5-0-290" id="h5-0-290" class="i">+        Column {
</a><a href="#h5-0-291" id="h5-0-291" class="i">+            TabRow(selectedTabIndex = pagerState.currentPage, indicator = { tabPositions -&gt;
</a><a href="#h5-0-292" id="h5-0-292" class="i">+                TabRowDefaults.Indicator(
</a><a href="#h5-0-293" id="h5-0-293" class="i">+                    Modifier.pagerTabIndicatorOffset(
</a><a href="#h5-0-294" id="h5-0-294" class="i">+                        pagerState = pagerState,
</a><a href="#h5-0-295" id="h5-0-295" class="i">+                        tabPositions = tabPositions
</a><a href="#h5-0-296" id="h5-0-296" class="i">+                    )
</a><a href="#h5-0-297" id="h5-0-297" class="i">+                )
</a><a href="#h5-0-298" id="h5-0-298" class="i">+            }) {
</a><a href="#h5-0-299" id="h5-0-299" class="i">+                titles.forEachIndexed { index, title -&gt;
</a><a href="#h5-0-300" id="h5-0-300" class="i">+                    Tab(
</a><a href="#h5-0-301" id="h5-0-301" class="i">+                        selected = pagerState.currentPage == index,
</a><a href="#h5-0-302" id="h5-0-302" class="i">+                        onClick = {
</a><a href="#h5-0-303" id="h5-0-303" class="i">+                            coroutineScope.launch {
</a><a href="#h5-0-304" id="h5-0-304" class="i">+                                pagerState.animateScrollToPage(index)
</a><a href="#h5-0-305" id="h5-0-305" class="i">+                            }
</a><a href="#h5-0-306" id="h5-0-306" class="i">+                        },
</a><a href="#h5-0-307" id="h5-0-307" class="i">+                        text = {
</a><a href="#h5-0-308" id="h5-0-308" class="i">+                            Text(
</a><a href="#h5-0-309" id="h5-0-309" class="i">+                                text = title,
</a><a href="#h5-0-310" id="h5-0-310" class="i">+                                maxLines = 2,
</a><a href="#h5-0-311" id="h5-0-311" class="i">+                                overflow = TextOverflow.Ellipsis
</a><a href="#h5-0-312" id="h5-0-312" class="i">+                            )
</a><a href="#h5-0-313" id="h5-0-313" class="i">+                        }
</a><a href="#h5-0-314" id="h5-0-314" class="i">+                    )
</a><a href="#h5-0-315" id="h5-0-315" class="i">+                }
</a><a href="#h5-0-316" id="h5-0-316" class="i">+            }
</a><a href="#h5-0-317" id="h5-0-317" class="i">+
</a><a href="#h5-0-318" id="h5-0-318" class="i">+            HorizontalPager(
</a><a href="#h5-0-319" id="h5-0-319" class="i">+                modifier = Modifier.weight(1f),
</a><a href="#h5-0-320" id="h5-0-320" class="i">+                state = pagerState
</a><a href="#h5-0-321" id="h5-0-321" class="i">+            ) { page -&gt;
</a><a href="#h5-0-322" id="h5-0-322" class="i">+                when (page) {
</a><a href="#h5-0-323" id="h5-0-323" class="i">+                    0 -&gt; LogsTab()
</a><a href="#h5-0-324" id="h5-0-324" class="i">+                    1 -&gt; ConfigRulesTab()
</a><a href="#h5-0-325" id="h5-0-325" class="i">+                }
</a><a href="#h5-0-326" id="h5-0-326" class="i">+            }
</a><a href="#h5-0-327" id="h5-0-327" class="i">+        }
</a><a href="#h5-0-328" id="h5-0-328" class="i">+    }
</a><a href="#h5-0-329" id="h5-0-329" class="i">+}</a><a href="#h5-0-330" id="h5-0-330" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h6" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/LoggerHistoryRoot.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/LoggerHistoryRoot.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/LoggerHistoryRoot.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/LoggerHistoryRoot.kt</a></b>
<a href="#h6-0" id="h6-0" class="h">@@ -26,7 +26,7 @@ import kotlinx.coroutines.launch
</a> import kotlinx.coroutines.withContext
 import me.rhunk.snapenhance.bridge.DownloadCallback
 import me.rhunk.snapenhance.common.bridge.wrapper.LoggedMessage
<a href="#h6-0-3" id="h6-0-3" class="d">-import me.rhunk.snapenhance.common.bridge.wrapper.MessageLoggerWrapper
</a><a href="#h6-0-4" id="h6-0-4" class="i">+import me.rhunk.snapenhance.common.bridge.wrapper.LoggerWrapper
</a> import me.rhunk.snapenhance.common.data.ContentType
 import me.rhunk.snapenhance.common.data.download.*
 import me.rhunk.snapenhance.common.util.ktx.copyToClipboard
<a href="#h6-1" id="h6-1" class="h">@@ -40,7 +40,7 @@ import kotlin.math.absoluteValue
</a> 
 
 class LoggerHistoryRoot : Routes.Route() {
<a href="#h6-1-3" id="h6-1-3" class="d">-    private lateinit var messageLoggerWrapper: MessageLoggerWrapper
</a><a href="#h6-1-4" id="h6-1-4" class="i">+    private lateinit var loggerWrapper: LoggerWrapper
</a>     private var selectedConversation by mutableStateOf&lt;String?&gt;(null)
     private var stringFilter by mutableStateOf(&quot;&quot;)
     private var reverseOrder by mutableStateOf(true)
<a href="#h6-2" id="h6-2" class="h">@@ -182,7 +182,7 @@ class LoggerHistoryRoot : Routes.Route() {
</a>     @OptIn(ExperimentalMaterial3Api::class)
     override val content: @Composable (NavBackStackEntry) -&gt; Unit = {
         LaunchedEffect(Unit) {
<a href="#h6-2-3" id="h6-2-3" class="d">-            messageLoggerWrapper = MessageLoggerWrapper(
</a><a href="#h6-2-4" id="h6-2-4" class="i">+            loggerWrapper = LoggerWrapper(
</a>                 context.androidContext.getDatabasePath(&quot;message_logger.db&quot;)
             )
         }
<a href="#h6-3" id="h6-3" class="h">@@ -208,7 +208,7 @@ class LoggerHistoryRoot : Routes.Route() {
</a>                 LaunchedEffect(Unit) {
                     conversations.clear()
                     withContext(Dispatchers.IO) {
<a href="#h6-3-3" id="h6-3-3" class="d">-                        conversations.addAll(messageLoggerWrapper.getAllConversations())
</a><a href="#h6-3-4" id="h6-3-4" class="i">+                        conversations.addAll(loggerWrapper.getAllConversations())
</a>                     }
                 }
 
<a href="#h6-4" id="h6-4" class="h">@@ -270,7 +270,7 @@ class LoggerHistoryRoot : Routes.Route() {
</a>                     }
                     LaunchedEffect(Unit, selectedConversation, stringFilter, reverseOrder) {
                         withContext(Dispatchers.IO) {
<a href="#h6-4-3" id="h6-4-3" class="d">-                            val newMessages = messageLoggerWrapper.fetchMessages(
</a><a href="#h6-4-4" id="h6-4-4" class="i">+                            val newMessages = loggerWrapper.fetchMessages(
</a>                                 selectedConversation ?: return@withContext,
                                 lastFetchMessageTimestamp,
                                 30,
<b>diff --git a/<a id="h7" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/home/HomeRoot.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/home/HomeRoot.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/home/HomeRoot.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/home/HomeRoot.kt</a></b>
<a href="#h7-0" id="h7-0" class="h">@@ -271,6 +271,18 @@ class HomeRoot : Routes.Route() {
</a>                 updateInstallationSummary(coroutineScope)
             }
 
<a href="#h7-0-3" id="h7-0-3" class="i">+            Row(
</a><a href="#h7-0-4" id="h7-0-4" class="i">+                modifier = Modifier.fillMaxWidth(),
</a><a href="#h7-0-5" id="h7-0-5" class="i">+                horizontalArrangement = Arrangement.Center
</a><a href="#h7-0-6" id="h7-0-6" class="i">+            ) {
</a><a href="#h7-0-7" id="h7-0-7" class="i">+                ElevatedButton(onClick = {
</a><a href="#h7-0-8" id="h7-0-8" class="i">+                    routes.friendTracker.navigate()
</a><a href="#h7-0-9" id="h7-0-9" class="i">+                }) {
</a><a href="#h7-0-10" id="h7-0-10" class="i">+                    Text(text = &quot;Friend Tracker&quot;, fontSize = 18.sp)
</a><a href="#h7-0-11" id="h7-0-11" class="i">+                }
</a><a href="#h7-0-12" id="h7-0-12" class="i">+            }
</a><a href="#h7-0-13" id="h7-0-13" class="i">+
</a><a href="#h7-0-14" id="h7-0-14" class="i">+            Spacer(modifier = Modifier.height(20.dp))
</a>             installationSummary?.let { SummaryCards(installationSummary = it) }
         }
     }
<b>diff --git a/<a id="h8" href="../file/common/src/main/aidl/me/rhunk/snapenhance/bridge/BridgeInterface.aidl.html">common/src/main/aidl/me/rhunk/snapenhance/bridge/BridgeInterface.aidl</a> b/<a href="../file/common/src/main/aidl/me/rhunk/snapenhance/bridge/BridgeInterface.aidl.html">common/src/main/aidl/me/rhunk/snapenhance/bridge/BridgeInterface.aidl</a></b>
<a href="#h8-0" id="h8-0" class="h">@@ -5,7 +5,8 @@ import me.rhunk.snapenhance.bridge.DownloadCallback;
</a> import me.rhunk.snapenhance.bridge.SyncCallback;
 import me.rhunk.snapenhance.bridge.scripting.IScripting;
 import me.rhunk.snapenhance.bridge.e2ee.E2eeInterface;
<a href="#h8-0-3" id="h8-0-3" class="d">-import me.rhunk.snapenhance.bridge.MessageLoggerInterface;
</a><a href="#h8-0-4" id="h8-0-4" class="i">+import me.rhunk.snapenhance.bridge.logger.LoggerInterface;
</a><a href="#h8-0-5" id="h8-0-5" class="i">+import me.rhunk.snapenhance.bridge.logger.TrackerInterface;
</a> import me.rhunk.snapenhance.bridge.ConfigStateListener;
 import me.rhunk.snapenhance.bridge.snapclient.MessagingBridge;
 
<a href="#h8-1" id="h8-1" class="h">@@ -79,7 +80,9 @@ interface BridgeInterface {
</a> 
     E2eeInterface getE2eeInterface();
 
<a href="#h8-1-3" id="h8-1-3" class="d">-    MessageLoggerInterface getMessageLogger();
</a><a href="#h8-1-4" id="h8-1-4" class="i">+    LoggerInterface getLogger();
</a><a href="#h8-1-5" id="h8-1-5" class="i">+
</a><a href="#h8-1-6" id="h8-1-6" class="i">+    TrackerInterface getTracker();
</a> 
     oneway void registerMessagingBridge(MessagingBridge bridge);
 
<b>diff --git a/<a id="h9" href="../file/common/src/main/aidl/me/rhunk/snapenhance/bridge/MessageLoggerInterface.aidl.html">common/src/main/aidl/me/rhunk/snapenhance/bridge/MessageLoggerInterface.aidl</a> b/<a href="../file/common/src/main/aidl/me/rhunk/snapenhance/bridge/MessageLoggerInterface.aidl.html">common/src/main/aidl/me/rhunk/snapenhance/bridge/MessageLoggerInterface.aidl</a></b>
<a href="#h9-0" id="h9-0" class="h">@@ -1,29 +0,0 @@
</a><a href="#h9-0-0" id="h9-0-0" class="d">-package me.rhunk.snapenhance.bridge;
</a><a href="#h9-0-1" id="h9-0-1" class="d">-
</a><a href="#h9-0-2" id="h9-0-2" class="d">-interface MessageLoggerInterface {
</a><a href="#h9-0-3" id="h9-0-3" class="d">-    /**
</a><a href="#h9-0-4" id="h9-0-4" class="d">-     * Get the ids of the messages that are logged
</a><a href="#h9-0-5" id="h9-0-5" class="d">-     * @return message ids that are logged
</a><a href="#h9-0-6" id="h9-0-6" class="d">-     */
</a><a href="#h9-0-7" id="h9-0-7" class="d">-    long[] getLoggedIds(in String[] conversationIds, int limit);
</a><a href="#h9-0-8" id="h9-0-8" class="d">-
</a><a href="#h9-0-9" id="h9-0-9" class="d">-    /**
</a><a href="#h9-0-10" id="h9-0-10" class="d">-     * Get the content of a logged message from the database
</a><a href="#h9-0-11" id="h9-0-11" class="d">-     */
</a><a href="#h9-0-12" id="h9-0-12" class="d">-    @nullable byte[] getMessage(String conversationId, long id);
</a><a href="#h9-0-13" id="h9-0-13" class="d">-
</a><a href="#h9-0-14" id="h9-0-14" class="d">-    /**
</a><a href="#h9-0-15" id="h9-0-15" class="d">-     * Add a message to the message logger database if it is not already there
</a><a href="#h9-0-16" id="h9-0-16" class="d">-     */
</a><a href="#h9-0-17" id="h9-0-17" class="d">-    oneway void addMessage(String conversationId, long id, in byte[] message);
</a><a href="#h9-0-18" id="h9-0-18" class="d">-
</a><a href="#h9-0-19" id="h9-0-19" class="d">-    /**
</a><a href="#h9-0-20" id="h9-0-20" class="d">-     * Delete a message from the message logger database
</a><a href="#h9-0-21" id="h9-0-21" class="d">-     */
</a><a href="#h9-0-22" id="h9-0-22" class="d">-    oneway void deleteMessage(String conversationId, long id);
</a><a href="#h9-0-23" id="h9-0-23" class="d">-
</a><a href="#h9-0-24" id="h9-0-24" class="d">-    /**
</a><a href="#h9-0-25" id="h9-0-25" class="d">-    * Add a story to the message logger database if it is not already there
</a><a href="#h9-0-26" id="h9-0-26" class="d">-    */
</a><a href="#h9-0-27" id="h9-0-27" class="d">-    boolean addStory(String userId, String url, long postedAt, long createdAt, in byte[] key, in byte[] iv);
</a><a href="#h9-0-28" id="h9-0-28" class="d">-}</a><a href="#h9-0-29" id="h9-0-29" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h10" href="../file/common/src/main/aidl/me/rhunk/snapenhance/bridge/logger/LoggerInterface.aidl.html">common/src/main/aidl/me/rhunk/snapenhance/bridge/logger/LoggerInterface.aidl</a> b/<a href="../file/common/src/main/aidl/me/rhunk/snapenhance/bridge/logger/LoggerInterface.aidl.html">common/src/main/aidl/me/rhunk/snapenhance/bridge/logger/LoggerInterface.aidl</a></b>
<a href="#h10-0" id="h10-0" class="h">@@ -0,0 +1,39 @@
</a><a href="#h10-0-0" id="h10-0-0" class="i">+package me.rhunk.snapenhance.bridge.logger;
</a><a href="#h10-0-1" id="h10-0-1" class="i">+
</a><a href="#h10-0-2" id="h10-0-2" class="i">+interface LoggerInterface {
</a><a href="#h10-0-3" id="h10-0-3" class="i">+    /**
</a><a href="#h10-0-4" id="h10-0-4" class="i">+     * Get the ids of the messages that are logged
</a><a href="#h10-0-5" id="h10-0-5" class="i">+     * @return message ids that are logged
</a><a href="#h10-0-6" id="h10-0-6" class="i">+     */
</a><a href="#h10-0-7" id="h10-0-7" class="i">+    long[] getLoggedIds(in String[] conversationIds, int limit);
</a><a href="#h10-0-8" id="h10-0-8" class="i">+
</a><a href="#h10-0-9" id="h10-0-9" class="i">+    /**
</a><a href="#h10-0-10" id="h10-0-10" class="i">+     * Get the content of a logged message from the database
</a><a href="#h10-0-11" id="h10-0-11" class="i">+     */
</a><a href="#h10-0-12" id="h10-0-12" class="i">+    @nullable byte[] getMessage(String conversationId, long id);
</a><a href="#h10-0-13" id="h10-0-13" class="i">+
</a><a href="#h10-0-14" id="h10-0-14" class="i">+    /**
</a><a href="#h10-0-15" id="h10-0-15" class="i">+     * Add a message to the message logger database if it is not already there
</a><a href="#h10-0-16" id="h10-0-16" class="i">+     */
</a><a href="#h10-0-17" id="h10-0-17" class="i">+    oneway void addMessage(String conversationId, long id, in byte[] message);
</a><a href="#h10-0-18" id="h10-0-18" class="i">+
</a><a href="#h10-0-19" id="h10-0-19" class="i">+    /**
</a><a href="#h10-0-20" id="h10-0-20" class="i">+     * Delete a message from the message logger database
</a><a href="#h10-0-21" id="h10-0-21" class="i">+     */
</a><a href="#h10-0-22" id="h10-0-22" class="i">+    oneway void deleteMessage(String conversationId, long id);
</a><a href="#h10-0-23" id="h10-0-23" class="i">+
</a><a href="#h10-0-24" id="h10-0-24" class="i">+    /**
</a><a href="#h10-0-25" id="h10-0-25" class="i">+    * Add a story to the message logger database if it is not already there
</a><a href="#h10-0-26" id="h10-0-26" class="i">+    */
</a><a href="#h10-0-27" id="h10-0-27" class="i">+    boolean addStory(String userId, String url, long postedAt, long createdAt, in byte[] key, in byte[] iv);
</a><a href="#h10-0-28" id="h10-0-28" class="i">+
</a><a href="#h10-0-29" id="h10-0-29" class="i">+    oneway void logTrackerEvent(
</a><a href="#h10-0-30" id="h10-0-30" class="i">+        String conversationId,
</a><a href="#h10-0-31" id="h10-0-31" class="i">+        String conversationTitle,
</a><a href="#h10-0-32" id="h10-0-32" class="i">+        boolean isGroup,
</a><a href="#h10-0-33" id="h10-0-33" class="i">+        String username,
</a><a href="#h10-0-34" id="h10-0-34" class="i">+        String userId,
</a><a href="#h10-0-35" id="h10-0-35" class="i">+        String eventType,
</a><a href="#h10-0-36" id="h10-0-36" class="i">+        String data
</a><a href="#h10-0-37" id="h10-0-37" class="i">+    );
</a><a href="#h10-0-38" id="h10-0-38" class="i">+}</a><a href="#h10-0-39" id="h10-0-39" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h11" href="../file/common/src/main/aidl/me/rhunk/snapenhance/bridge/logger/TrackerInterface.aidl.html">common/src/main/aidl/me/rhunk/snapenhance/bridge/logger/TrackerInterface.aidl</a> b/<a href="../file/common/src/main/aidl/me/rhunk/snapenhance/bridge/logger/TrackerInterface.aidl.html">common/src/main/aidl/me/rhunk/snapenhance/bridge/logger/TrackerInterface.aidl</a></b>
<a href="#h11-0" id="h11-0" class="h">@@ -0,0 +1,5 @@
</a><a href="#h11-0-0" id="h11-0-0" class="i">+package me.rhunk.snapenhance.bridge.logger;
</a><a href="#h11-0-1" id="h11-0-1" class="i">+
</a><a href="#h11-0-2" id="h11-0-2" class="i">+interface TrackerInterface {
</a><a href="#h11-0-3" id="h11-0-3" class="i">+    String getTrackedEvents(String eventType); // returns serialized TrackerEventsResult
</a><a href="#h11-0-4" id="h11-0-4" class="i">+}</a><a href="#h11-0-5" id="h11-0-5" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h12" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/wrapper/LoggerWrapper.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/wrapper/LoggerWrapper.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/wrapper/LoggerWrapper.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/wrapper/LoggerWrapper.kt</a></b>
<a href="#h12-0" id="h12-0" class="h">@@ -0,0 +1,305 @@
</a><a href="#h12-0-0" id="h12-0-0" class="i">+package me.rhunk.snapenhance.common.bridge.wrapper
</a><a href="#h12-0-1" id="h12-0-1" class="i">+
</a><a href="#h12-0-2" id="h12-0-2" class="i">+import android.content.ContentValues
</a><a href="#h12-0-3" id="h12-0-3" class="i">+import android.database.sqlite.SQLiteDatabase
</a><a href="#h12-0-4" id="h12-0-4" class="i">+import kotlinx.coroutines.*
</a><a href="#h12-0-5" id="h12-0-5" class="i">+import me.rhunk.snapenhance.bridge.logger.LoggerInterface
</a><a href="#h12-0-6" id="h12-0-6" class="i">+import me.rhunk.snapenhance.common.data.StoryData
</a><a href="#h12-0-7" id="h12-0-7" class="i">+import me.rhunk.snapenhance.common.util.SQLiteDatabaseHelper
</a><a href="#h12-0-8" id="h12-0-8" class="i">+import me.rhunk.snapenhance.common.util.ktx.getBlobOrNull
</a><a href="#h12-0-9" id="h12-0-9" class="i">+import me.rhunk.snapenhance.common.util.ktx.getIntOrNull
</a><a href="#h12-0-10" id="h12-0-10" class="i">+import me.rhunk.snapenhance.common.util.ktx.getLongOrNull
</a><a href="#h12-0-11" id="h12-0-11" class="i">+import me.rhunk.snapenhance.common.util.ktx.getStringOrNull
</a><a href="#h12-0-12" id="h12-0-12" class="i">+import java.io.File
</a><a href="#h12-0-13" id="h12-0-13" class="i">+import java.util.UUID
</a><a href="#h12-0-14" id="h12-0-14" class="i">+
</a><a href="#h12-0-15" id="h12-0-15" class="i">+
</a><a href="#h12-0-16" id="h12-0-16" class="i">+class LoggedMessage(
</a><a href="#h12-0-17" id="h12-0-17" class="i">+    val messageId: Long,
</a><a href="#h12-0-18" id="h12-0-18" class="i">+    val timestamp: Long,
</a><a href="#h12-0-19" id="h12-0-19" class="i">+    val messageData: ByteArray
</a><a href="#h12-0-20" id="h12-0-20" class="i">+)
</a><a href="#h12-0-21" id="h12-0-21" class="i">+
</a><a href="#h12-0-22" id="h12-0-22" class="i">+class TrackerLog(
</a><a href="#h12-0-23" id="h12-0-23" class="i">+    val timestamp: Long,
</a><a href="#h12-0-24" id="h12-0-24" class="i">+    val conversationId: String,
</a><a href="#h12-0-25" id="h12-0-25" class="i">+    val conversationTitle: String?,
</a><a href="#h12-0-26" id="h12-0-26" class="i">+    val isGroup: Boolean,
</a><a href="#h12-0-27" id="h12-0-27" class="i">+    val username: String,
</a><a href="#h12-0-28" id="h12-0-28" class="i">+    val userId: String,
</a><a href="#h12-0-29" id="h12-0-29" class="i">+    val eventType: String,
</a><a href="#h12-0-30" id="h12-0-30" class="i">+    val data: String
</a><a href="#h12-0-31" id="h12-0-31" class="i">+)
</a><a href="#h12-0-32" id="h12-0-32" class="i">+
</a><a href="#h12-0-33" id="h12-0-33" class="i">+class LoggerWrapper(
</a><a href="#h12-0-34" id="h12-0-34" class="i">+    val databaseFile: File
</a><a href="#h12-0-35" id="h12-0-35" class="i">+): LoggerInterface.Stub() {
</a><a href="#h12-0-36" id="h12-0-36" class="i">+    private var _database: SQLiteDatabase? = null
</a><a href="#h12-0-37" id="h12-0-37" class="i">+    @OptIn(ExperimentalCoroutinesApi::class)
</a><a href="#h12-0-38" id="h12-0-38" class="i">+    private val coroutineScope = CoroutineScope(Dispatchers.IO.limitedParallelism(1))
</a><a href="#h12-0-39" id="h12-0-39" class="i">+
</a><a href="#h12-0-40" id="h12-0-40" class="i">+    private val database get() = synchronized(this) {
</a><a href="#h12-0-41" id="h12-0-41" class="i">+        _database?.takeIf { it.isOpen } ?: run {
</a><a href="#h12-0-42" id="h12-0-42" class="i">+            _database?.close()
</a><a href="#h12-0-43" id="h12-0-43" class="i">+            val openedDatabase = SQLiteDatabase.openDatabase(databaseFile.absolutePath, null, SQLiteDatabase.CREATE_IF_NECESSARY or SQLiteDatabase.OPEN_READWRITE)
</a><a href="#h12-0-44" id="h12-0-44" class="i">+            SQLiteDatabaseHelper.createTablesFromSchema(openedDatabase, mapOf(
</a><a href="#h12-0-45" id="h12-0-45" class="i">+                &quot;messages&quot; to listOf(
</a><a href="#h12-0-46" id="h12-0-46" class="i">+                    &quot;id INTEGER PRIMARY KEY&quot;,
</a><a href="#h12-0-47" id="h12-0-47" class="i">+                    &quot;added_timestamp BIGINT&quot;,
</a><a href="#h12-0-48" id="h12-0-48" class="i">+                    &quot;conversation_id VARCHAR&quot;,
</a><a href="#h12-0-49" id="h12-0-49" class="i">+                    &quot;message_id BIGINT&quot;,
</a><a href="#h12-0-50" id="h12-0-50" class="i">+                    &quot;message_data BLOB&quot;
</a><a href="#h12-0-51" id="h12-0-51" class="i">+                ),
</a><a href="#h12-0-52" id="h12-0-52" class="i">+                &quot;stories&quot; to listOf(
</a><a href="#h12-0-53" id="h12-0-53" class="i">+                    &quot;id INTEGER PRIMARY KEY&quot;,
</a><a href="#h12-0-54" id="h12-0-54" class="i">+                    &quot;added_timestamp BIGINT&quot;,
</a><a href="#h12-0-55" id="h12-0-55" class="i">+                    &quot;user_id VARCHAR&quot;,
</a><a href="#h12-0-56" id="h12-0-56" class="i">+                    &quot;posted_timestamp BIGINT&quot;,
</a><a href="#h12-0-57" id="h12-0-57" class="i">+                    &quot;created_timestamp BIGINT&quot;,
</a><a href="#h12-0-58" id="h12-0-58" class="i">+                    &quot;url VARCHAR&quot;,
</a><a href="#h12-0-59" id="h12-0-59" class="i">+                    &quot;encryption_key BLOB&quot;,
</a><a href="#h12-0-60" id="h12-0-60" class="i">+                    &quot;encryption_iv BLOB&quot;
</a><a href="#h12-0-61" id="h12-0-61" class="i">+                ),
</a><a href="#h12-0-62" id="h12-0-62" class="i">+                &quot;tracker_events&quot; to listOf(
</a><a href="#h12-0-63" id="h12-0-63" class="i">+                    &quot;id INTEGER PRIMARY KEY&quot;,
</a><a href="#h12-0-64" id="h12-0-64" class="i">+                    &quot;timestamp BIGINT&quot;,
</a><a href="#h12-0-65" id="h12-0-65" class="i">+                    &quot;conversation_id CHAR(36)&quot;,
</a><a href="#h12-0-66" id="h12-0-66" class="i">+                    &quot;conversation_title VARCHAR&quot;,
</a><a href="#h12-0-67" id="h12-0-67" class="i">+                    &quot;is_group BOOLEAN&quot;,
</a><a href="#h12-0-68" id="h12-0-68" class="i">+                    &quot;username VARCHAR&quot;,
</a><a href="#h12-0-69" id="h12-0-69" class="i">+                    &quot;user_id VARCHAR&quot;,
</a><a href="#h12-0-70" id="h12-0-70" class="i">+                    &quot;event_type VARCHAR&quot;,
</a><a href="#h12-0-71" id="h12-0-71" class="i">+                    &quot;data VARCHAR&quot;
</a><a href="#h12-0-72" id="h12-0-72" class="i">+                )
</a><a href="#h12-0-73" id="h12-0-73" class="i">+            ))
</a><a href="#h12-0-74" id="h12-0-74" class="i">+            _database = openedDatabase
</a><a href="#h12-0-75" id="h12-0-75" class="i">+            openedDatabase
</a><a href="#h12-0-76" id="h12-0-76" class="i">+        }
</a><a href="#h12-0-77" id="h12-0-77" class="i">+    }
</a><a href="#h12-0-78" id="h12-0-78" class="i">+
</a><a href="#h12-0-79" id="h12-0-79" class="i">+    protected fun finalize() {
</a><a href="#h12-0-80" id="h12-0-80" class="i">+        _database?.close()
</a><a href="#h12-0-81" id="h12-0-81" class="i">+    }
</a><a href="#h12-0-82" id="h12-0-82" class="i">+
</a><a href="#h12-0-83" id="h12-0-83" class="i">+    fun init() {
</a><a href="#h12-0-84" id="h12-0-84" class="i">+
</a><a href="#h12-0-85" id="h12-0-85" class="i">+    }
</a><a href="#h12-0-86" id="h12-0-86" class="i">+
</a><a href="#h12-0-87" id="h12-0-87" class="i">+    override fun getLoggedIds(conversationId: Array&lt;String&gt;, limit: Int): LongArray {
</a><a href="#h12-0-88" id="h12-0-88" class="i">+        if (conversationId.any {
</a><a href="#h12-0-89" id="h12-0-89" class="i">+            runCatching { UUID.fromString(it) }.isFailure
</a><a href="#h12-0-90" id="h12-0-90" class="i">+        }) return longArrayOf()
</a><a href="#h12-0-91" id="h12-0-91" class="i">+
</a><a href="#h12-0-92" id="h12-0-92" class="i">+        return database.rawQuery(&quot;SELECT message_id FROM messages WHERE conversation_id IN (${
</a><a href="#h12-0-93" id="h12-0-93" class="i">+            conversationId.joinToString(&quot;,&quot;) { &quot;&#39;$it&#39;&quot; }
</a><a href="#h12-0-94" id="h12-0-94" class="i">+        }) ORDER BY message_id DESC LIMIT $limit&quot;, null).use {
</a><a href="#h12-0-95" id="h12-0-95" class="i">+            val ids = mutableListOf&lt;Long&gt;()
</a><a href="#h12-0-96" id="h12-0-96" class="i">+            while (it.moveToNext()) {
</a><a href="#h12-0-97" id="h12-0-97" class="i">+                ids.add(it.getLong(0))
</a><a href="#h12-0-98" id="h12-0-98" class="i">+            }
</a><a href="#h12-0-99" id="h12-0-99" class="i">+            ids.toLongArray()
</a><a href="#h12-0-100" id="h12-0-100" class="i">+        }
</a><a href="#h12-0-101" id="h12-0-101" class="i">+    }
</a><a href="#h12-0-102" id="h12-0-102" class="i">+
</a><a href="#h12-0-103" id="h12-0-103" class="i">+    override fun getMessage(conversationId: String?, id: Long): ByteArray? {
</a><a href="#h12-0-104" id="h12-0-104" class="i">+        return database.rawQuery(
</a><a href="#h12-0-105" id="h12-0-105" class="i">+            &quot;SELECT message_data FROM messages WHERE conversation_id = ? AND message_id = ?&quot;,
</a><a href="#h12-0-106" id="h12-0-106" class="i">+            arrayOf(conversationId, id.toString())
</a><a href="#h12-0-107" id="h12-0-107" class="i">+        ).use {
</a><a href="#h12-0-108" id="h12-0-108" class="i">+            if (it.moveToFirst()) it.getBlob(0) else null
</a><a href="#h12-0-109" id="h12-0-109" class="i">+        }
</a><a href="#h12-0-110" id="h12-0-110" class="i">+    }
</a><a href="#h12-0-111" id="h12-0-111" class="i">+
</a><a href="#h12-0-112" id="h12-0-112" class="i">+    override fun addMessage(conversationId: String, messageId: Long, serializedMessage: ByteArray) {
</a><a href="#h12-0-113" id="h12-0-113" class="i">+        val cursor = database.rawQuery(&quot;SELECT message_id FROM messages WHERE conversation_id = ? AND message_id = ?&quot;, arrayOf(conversationId, messageId.toString()))
</a><a href="#h12-0-114" id="h12-0-114" class="i">+        val state = cursor.moveToFirst()
</a><a href="#h12-0-115" id="h12-0-115" class="i">+        cursor.close()
</a><a href="#h12-0-116" id="h12-0-116" class="i">+        if (state) return
</a><a href="#h12-0-117" id="h12-0-117" class="i">+        runBlocking {
</a><a href="#h12-0-118" id="h12-0-118" class="i">+            withContext(coroutineScope.coroutineContext) {
</a><a href="#h12-0-119" id="h12-0-119" class="i">+                database.insert(&quot;messages&quot;, null, ContentValues().apply {
</a><a href="#h12-0-120" id="h12-0-120" class="i">+                    put(&quot;added_timestamp&quot;, System.currentTimeMillis())
</a><a href="#h12-0-121" id="h12-0-121" class="i">+                    put(&quot;conversation_id&quot;, conversationId)
</a><a href="#h12-0-122" id="h12-0-122" class="i">+                    put(&quot;message_id&quot;, messageId)
</a><a href="#h12-0-123" id="h12-0-123" class="i">+                    put(&quot;message_data&quot;, serializedMessage)
</a><a href="#h12-0-124" id="h12-0-124" class="i">+                })
</a><a href="#h12-0-125" id="h12-0-125" class="i">+            }
</a><a href="#h12-0-126" id="h12-0-126" class="i">+        }
</a><a href="#h12-0-127" id="h12-0-127" class="i">+    }
</a><a href="#h12-0-128" id="h12-0-128" class="i">+
</a><a href="#h12-0-129" id="h12-0-129" class="i">+    fun purgeAll(maxAge: Long? = null) {
</a><a href="#h12-0-130" id="h12-0-130" class="i">+        coroutineScope.launch {
</a><a href="#h12-0-131" id="h12-0-131" class="i">+            maxAge?.let {
</a><a href="#h12-0-132" id="h12-0-132" class="i">+                val maxTime = System.currentTimeMillis() - it
</a><a href="#h12-0-133" id="h12-0-133" class="i">+                database.execSQL(&quot;DELETE FROM messages WHERE added_timestamp &lt; ?&quot;, arrayOf(maxTime.toString()))
</a><a href="#h12-0-134" id="h12-0-134" class="i">+                database.execSQL(&quot;DELETE FROM stories WHERE added_timestamp &lt; ?&quot;, arrayOf(maxTime.toString()))
</a><a href="#h12-0-135" id="h12-0-135" class="i">+            } ?: run {
</a><a href="#h12-0-136" id="h12-0-136" class="i">+                database.execSQL(&quot;DELETE FROM messages&quot;)
</a><a href="#h12-0-137" id="h12-0-137" class="i">+                database.execSQL(&quot;DELETE FROM stories&quot;)
</a><a href="#h12-0-138" id="h12-0-138" class="i">+            }
</a><a href="#h12-0-139" id="h12-0-139" class="i">+        }
</a><a href="#h12-0-140" id="h12-0-140" class="i">+    }
</a><a href="#h12-0-141" id="h12-0-141" class="i">+
</a><a href="#h12-0-142" id="h12-0-142" class="i">+    fun getStoredMessageCount(): Int {
</a><a href="#h12-0-143" id="h12-0-143" class="i">+        return database.rawQuery(&quot;SELECT COUNT(*) FROM messages&quot;, null).use {
</a><a href="#h12-0-144" id="h12-0-144" class="i">+            it.moveToFirst()
</a><a href="#h12-0-145" id="h12-0-145" class="i">+            it.getInt(0)
</a><a href="#h12-0-146" id="h12-0-146" class="i">+        }
</a><a href="#h12-0-147" id="h12-0-147" class="i">+    }
</a><a href="#h12-0-148" id="h12-0-148" class="i">+
</a><a href="#h12-0-149" id="h12-0-149" class="i">+    fun getStoredStoriesCount(): Int {
</a><a href="#h12-0-150" id="h12-0-150" class="i">+        return database.rawQuery(&quot;SELECT COUNT(*) FROM stories&quot;, null).use {
</a><a href="#h12-0-151" id="h12-0-151" class="i">+            it.moveToFirst()
</a><a href="#h12-0-152" id="h12-0-152" class="i">+            it.getInt(0)
</a><a href="#h12-0-153" id="h12-0-153" class="i">+        }
</a><a href="#h12-0-154" id="h12-0-154" class="i">+    }
</a><a href="#h12-0-155" id="h12-0-155" class="i">+
</a><a href="#h12-0-156" id="h12-0-156" class="i">+    override fun deleteMessage(conversationId: String, messageId: Long) {
</a><a href="#h12-0-157" id="h12-0-157" class="i">+        coroutineScope.launch {
</a><a href="#h12-0-158" id="h12-0-158" class="i">+            database.execSQL(&quot;DELETE FROM messages WHERE conversation_id = ? AND message_id = ?&quot;, arrayOf(conversationId, messageId.toString()))
</a><a href="#h12-0-159" id="h12-0-159" class="i">+        }
</a><a href="#h12-0-160" id="h12-0-160" class="i">+    }
</a><a href="#h12-0-161" id="h12-0-161" class="i">+
</a><a href="#h12-0-162" id="h12-0-162" class="i">+    override fun addStory(userId: String, url: String, postedAt: Long, createdAt: Long, key: ByteArray?, iv: ByteArray?): Boolean {
</a><a href="#h12-0-163" id="h12-0-163" class="i">+        if (database.rawQuery(&quot;SELECT id FROM stories WHERE user_id = ? AND url = ?&quot;, arrayOf(userId, url)).use {
</a><a href="#h12-0-164" id="h12-0-164" class="i">+            it.moveToFirst()
</a><a href="#h12-0-165" id="h12-0-165" class="i">+        }) {
</a><a href="#h12-0-166" id="h12-0-166" class="i">+            return false
</a><a href="#h12-0-167" id="h12-0-167" class="i">+        }
</a><a href="#h12-0-168" id="h12-0-168" class="i">+        runBlocking {
</a><a href="#h12-0-169" id="h12-0-169" class="i">+            withContext(coroutineScope.coroutineContext) {
</a><a href="#h12-0-170" id="h12-0-170" class="i">+                database.insert(&quot;stories&quot;, null, ContentValues().apply {
</a><a href="#h12-0-171" id="h12-0-171" class="i">+                    put(&quot;user_id&quot;, userId)
</a><a href="#h12-0-172" id="h12-0-172" class="i">+                    put(&quot;added_timestamp&quot;, System.currentTimeMillis())
</a><a href="#h12-0-173" id="h12-0-173" class="i">+                    put(&quot;url&quot;, url)
</a><a href="#h12-0-174" id="h12-0-174" class="i">+                    put(&quot;posted_timestamp&quot;, postedAt)
</a><a href="#h12-0-175" id="h12-0-175" class="i">+                    put(&quot;created_timestamp&quot;, createdAt)
</a><a href="#h12-0-176" id="h12-0-176" class="i">+                    put(&quot;encryption_key&quot;, key)
</a><a href="#h12-0-177" id="h12-0-177" class="i">+                    put(&quot;encryption_iv&quot;, iv)
</a><a href="#h12-0-178" id="h12-0-178" class="i">+                })
</a><a href="#h12-0-179" id="h12-0-179" class="i">+            }
</a><a href="#h12-0-180" id="h12-0-180" class="i">+        }
</a><a href="#h12-0-181" id="h12-0-181" class="i">+        return true
</a><a href="#h12-0-182" id="h12-0-182" class="i">+    }
</a><a href="#h12-0-183" id="h12-0-183" class="i">+
</a><a href="#h12-0-184" id="h12-0-184" class="i">+    override fun logTrackerEvent(
</a><a href="#h12-0-185" id="h12-0-185" class="i">+        conversationId: String,
</a><a href="#h12-0-186" id="h12-0-186" class="i">+        conversationTitle: String?,
</a><a href="#h12-0-187" id="h12-0-187" class="i">+        isGroup: Boolean,
</a><a href="#h12-0-188" id="h12-0-188" class="i">+        username: String,
</a><a href="#h12-0-189" id="h12-0-189" class="i">+        userId: String,
</a><a href="#h12-0-190" id="h12-0-190" class="i">+        eventType: String,
</a><a href="#h12-0-191" id="h12-0-191" class="i">+        data: String
</a><a href="#h12-0-192" id="h12-0-192" class="i">+    ) {
</a><a href="#h12-0-193" id="h12-0-193" class="i">+        runBlocking {
</a><a href="#h12-0-194" id="h12-0-194" class="i">+            withContext(coroutineScope.coroutineContext) {
</a><a href="#h12-0-195" id="h12-0-195" class="i">+                database.insert(&quot;tracker_events&quot;, null, ContentValues().apply {
</a><a href="#h12-0-196" id="h12-0-196" class="i">+                    put(&quot;timestamp&quot;, System.currentTimeMillis())
</a><a href="#h12-0-197" id="h12-0-197" class="i">+                    put(&quot;conversation_id&quot;, conversationId)
</a><a href="#h12-0-198" id="h12-0-198" class="i">+                    put(&quot;conversation_title&quot;, conversationTitle)
</a><a href="#h12-0-199" id="h12-0-199" class="i">+                    put(&quot;is_group&quot;, isGroup)
</a><a href="#h12-0-200" id="h12-0-200" class="i">+                    put(&quot;username&quot;, username)
</a><a href="#h12-0-201" id="h12-0-201" class="i">+                    put(&quot;user_id&quot;, userId)
</a><a href="#h12-0-202" id="h12-0-202" class="i">+                    put(&quot;event_type&quot;, eventType)
</a><a href="#h12-0-203" id="h12-0-203" class="i">+                    put(&quot;data&quot;, data)
</a><a href="#h12-0-204" id="h12-0-204" class="i">+                })
</a><a href="#h12-0-205" id="h12-0-205" class="i">+            }
</a><a href="#h12-0-206" id="h12-0-206" class="i">+        }
</a><a href="#h12-0-207" id="h12-0-207" class="i">+    }
</a><a href="#h12-0-208" id="h12-0-208" class="i">+
</a><a href="#h12-0-209" id="h12-0-209" class="i">+    fun getLogs(
</a><a href="#h12-0-210" id="h12-0-210" class="i">+        lastTimestamp: Long,
</a><a href="#h12-0-211" id="h12-0-211" class="i">+        filter: ((TrackerLog) -&gt; Boolean)? = null
</a><a href="#h12-0-212" id="h12-0-212" class="i">+    ): List&lt;TrackerLog&gt; {
</a><a href="#h12-0-213" id="h12-0-213" class="i">+        return database.rawQuery(&quot;SELECT * FROM tracker_events WHERE timestamp &lt; ? ORDER BY timestamp DESC&quot;, arrayOf(lastTimestamp.toString())).use {
</a><a href="#h12-0-214" id="h12-0-214" class="i">+            val logs = mutableListOf&lt;TrackerLog&gt;()
</a><a href="#h12-0-215" id="h12-0-215" class="i">+            while (it.moveToNext() &amp;&amp; logs.size &lt; 50) {
</a><a href="#h12-0-216" id="h12-0-216" class="i">+                val log = TrackerLog(
</a><a href="#h12-0-217" id="h12-0-217" class="i">+                    timestamp = it.getLongOrNull(&quot;timestamp&quot;) ?: continue,
</a><a href="#h12-0-218" id="h12-0-218" class="i">+                    conversationId = it.getStringOrNull(&quot;conversation_id&quot;) ?: continue,
</a><a href="#h12-0-219" id="h12-0-219" class="i">+                    conversationTitle = it.getStringOrNull(&quot;conversation_title&quot;),
</a><a href="#h12-0-220" id="h12-0-220" class="i">+                    isGroup = it.getIntOrNull(&quot;is_group&quot;) == 1,
</a><a href="#h12-0-221" id="h12-0-221" class="i">+                    username = it.getStringOrNull(&quot;username&quot;) ?: continue,
</a><a href="#h12-0-222" id="h12-0-222" class="i">+                    userId = it.getStringOrNull(&quot;user_id&quot;) ?: continue,
</a><a href="#h12-0-223" id="h12-0-223" class="i">+                    eventType = it.getStringOrNull(&quot;event_type&quot;) ?: continue,
</a><a href="#h12-0-224" id="h12-0-224" class="i">+                    data = it.getStringOrNull(&quot;data&quot;) ?: continue
</a><a href="#h12-0-225" id="h12-0-225" class="i">+                )
</a><a href="#h12-0-226" id="h12-0-226" class="i">+                if (filter != null &amp;&amp; !filter(log)) continue
</a><a href="#h12-0-227" id="h12-0-227" class="i">+                logs.add(log)
</a><a href="#h12-0-228" id="h12-0-228" class="i">+            }
</a><a href="#h12-0-229" id="h12-0-229" class="i">+            logs
</a><a href="#h12-0-230" id="h12-0-230" class="i">+        }
</a><a href="#h12-0-231" id="h12-0-231" class="i">+    }
</a><a href="#h12-0-232" id="h12-0-232" class="i">+
</a><a href="#h12-0-233" id="h12-0-233" class="i">+    fun findConversation(search: String): List&lt;String&gt; {
</a><a href="#h12-0-234" id="h12-0-234" class="i">+        return database.rawQuery(&quot;SELECT DISTINCT conversation_id FROM tracker_events WHERE is_group = 1 AND conversation_id LIKE ?&quot;, arrayOf(&quot;%$search%&quot;)).use {
</a><a href="#h12-0-235" id="h12-0-235" class="i">+            val conversations = mutableListOf&lt;String&gt;()
</a><a href="#h12-0-236" id="h12-0-236" class="i">+            while (it.moveToNext()) {
</a><a href="#h12-0-237" id="h12-0-237" class="i">+                conversations.add(it.getString(0))
</a><a href="#h12-0-238" id="h12-0-238" class="i">+            }
</a><a href="#h12-0-239" id="h12-0-239" class="i">+            conversations
</a><a href="#h12-0-240" id="h12-0-240" class="i">+        }
</a><a href="#h12-0-241" id="h12-0-241" class="i">+    }
</a><a href="#h12-0-242" id="h12-0-242" class="i">+
</a><a href="#h12-0-243" id="h12-0-243" class="i">+    fun findUsername(search: String): List&lt;String&gt; {
</a><a href="#h12-0-244" id="h12-0-244" class="i">+        return database.rawQuery(&quot;SELECT DISTINCT username FROM tracker_events WHERE username LIKE ?&quot;, arrayOf(&quot;%$search%&quot;)).use {
</a><a href="#h12-0-245" id="h12-0-245" class="i">+            val usernames = mutableListOf&lt;String&gt;()
</a><a href="#h12-0-246" id="h12-0-246" class="i">+            while (it.moveToNext()) {
</a><a href="#h12-0-247" id="h12-0-247" class="i">+                usernames.add(it.getString(0))
</a><a href="#h12-0-248" id="h12-0-248" class="i">+            }
</a><a href="#h12-0-249" id="h12-0-249" class="i">+            usernames
</a><a href="#h12-0-250" id="h12-0-250" class="i">+        }
</a><a href="#h12-0-251" id="h12-0-251" class="i">+    }
</a><a href="#h12-0-252" id="h12-0-252" class="i">+
</a><a href="#h12-0-253" id="h12-0-253" class="i">+
</a><a href="#h12-0-254" id="h12-0-254" class="i">+    fun getStories(userId: String, from: Long, limit: Int = Int.MAX_VALUE): Map&lt;Long, StoryData&gt; {
</a><a href="#h12-0-255" id="h12-0-255" class="i">+        val stories = sortedMapOf&lt;Long, StoryData&gt;()
</a><a href="#h12-0-256" id="h12-0-256" class="i">+        database.rawQuery(&quot;SELECT * FROM stories WHERE user_id = ? AND posted_timestamp &lt; ? ORDER BY posted_timestamp DESC LIMIT $limit&quot;, arrayOf(userId, from.toString())).use {
</a><a href="#h12-0-257" id="h12-0-257" class="i">+            while (it.moveToNext()) {
</a><a href="#h12-0-258" id="h12-0-258" class="i">+                stories[it.getLongOrNull(&quot;posted_timestamp&quot;) ?: continue] = StoryData(
</a><a href="#h12-0-259" id="h12-0-259" class="i">+                    url = it.getStringOrNull(&quot;url&quot;) ?: continue,
</a><a href="#h12-0-260" id="h12-0-260" class="i">+                    postedAt = it.getLongOrNull(&quot;posted_timestamp&quot;) ?: continue,
</a><a href="#h12-0-261" id="h12-0-261" class="i">+                    createdAt = it.getLongOrNull(&quot;created_timestamp&quot;) ?: continue,
</a><a href="#h12-0-262" id="h12-0-262" class="i">+                    key = it.getBlobOrNull(&quot;encryption_key&quot;),
</a><a href="#h12-0-263" id="h12-0-263" class="i">+                    iv = it.getBlobOrNull(&quot;encryption_iv&quot;)
</a><a href="#h12-0-264" id="h12-0-264" class="i">+                )
</a><a href="#h12-0-265" id="h12-0-265" class="i">+            }
</a><a href="#h12-0-266" id="h12-0-266" class="i">+        }
</a><a href="#h12-0-267" id="h12-0-267" class="i">+        return stories
</a><a href="#h12-0-268" id="h12-0-268" class="i">+    }
</a><a href="#h12-0-269" id="h12-0-269" class="i">+
</a><a href="#h12-0-270" id="h12-0-270" class="i">+    fun getAllConversations(): List&lt;String&gt; {
</a><a href="#h12-0-271" id="h12-0-271" class="i">+        return database.rawQuery(&quot;SELECT DISTINCT conversation_id FROM messages&quot;, null).use {
</a><a href="#h12-0-272" id="h12-0-272" class="i">+            val conversations = mutableListOf&lt;String&gt;()
</a><a href="#h12-0-273" id="h12-0-273" class="i">+            while (it.moveToNext()) {
</a><a href="#h12-0-274" id="h12-0-274" class="i">+                conversations.add(it.getString(0))
</a><a href="#h12-0-275" id="h12-0-275" class="i">+            }
</a><a href="#h12-0-276" id="h12-0-276" class="i">+            conversations
</a><a href="#h12-0-277" id="h12-0-277" class="i">+        }
</a><a href="#h12-0-278" id="h12-0-278" class="i">+    }
</a><a href="#h12-0-279" id="h12-0-279" class="i">+
</a><a href="#h12-0-280" id="h12-0-280" class="i">+    fun fetchMessages(
</a><a href="#h12-0-281" id="h12-0-281" class="i">+        conversationId: String,
</a><a href="#h12-0-282" id="h12-0-282" class="i">+        fromTimestamp: Long,
</a><a href="#h12-0-283" id="h12-0-283" class="i">+        limit: Int,
</a><a href="#h12-0-284" id="h12-0-284" class="i">+        reverseOrder: Boolean = true,
</a><a href="#h12-0-285" id="h12-0-285" class="i">+        filter: ((LoggedMessage) -&gt; Boolean)? = null
</a><a href="#h12-0-286" id="h12-0-286" class="i">+    ): List&lt;LoggedMessage&gt; {
</a><a href="#h12-0-287" id="h12-0-287" class="i">+        val messages = mutableListOf&lt;LoggedMessage&gt;()
</a><a href="#h12-0-288" id="h12-0-288" class="i">+        database.rawQuery(
</a><a href="#h12-0-289" id="h12-0-289" class="i">+            &quot;SELECT * FROM messages WHERE conversation_id = ? AND added_timestamp ${if (reverseOrder) &quot;&lt;&quot; else &quot;&gt;&quot;} ? ORDER BY added_timestamp ${if (reverseOrder) &quot;DESC&quot; else &quot;ASC&quot;}&quot;,
</a><a href="#h12-0-290" id="h12-0-290" class="i">+            arrayOf(conversationId, fromTimestamp.toString())
</a><a href="#h12-0-291" id="h12-0-291" class="i">+        ).use {
</a><a href="#h12-0-292" id="h12-0-292" class="i">+            while (it.moveToNext() &amp;&amp; messages.size &lt; limit) {
</a><a href="#h12-0-293" id="h12-0-293" class="i">+                val message = LoggedMessage(
</a><a href="#h12-0-294" id="h12-0-294" class="i">+                    messageId = it.getLongOrNull(&quot;message_id&quot;) ?: continue,
</a><a href="#h12-0-295" id="h12-0-295" class="i">+                    timestamp = it.getLongOrNull(&quot;added_timestamp&quot;) ?: continue,
</a><a href="#h12-0-296" id="h12-0-296" class="i">+                    messageData = it.getBlobOrNull(&quot;message_data&quot;) ?: continue
</a><a href="#h12-0-297" id="h12-0-297" class="i">+                )
</a><a href="#h12-0-298" id="h12-0-298" class="i">+                if (filter != null &amp;&amp; !filter(message)) continue
</a><a href="#h12-0-299" id="h12-0-299" class="i">+                messages.add(message)
</a><a href="#h12-0-300" id="h12-0-300" class="i">+            }
</a><a href="#h12-0-301" id="h12-0-301" class="i">+        }
</a><a href="#h12-0-302" id="h12-0-302" class="i">+        return messages
</a><a href="#h12-0-303" id="h12-0-303" class="i">+    }
</a><a href="#h12-0-304" id="h12-0-304" class="i">+}</a><a href="#h12-0-305" id="h12-0-305" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h13" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/wrapper/MessageLoggerWrapper.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/wrapper/MessageLoggerWrapper.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/wrapper/MessageLoggerWrapper.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/wrapper/MessageLoggerWrapper.kt</a></b>
<a href="#h13-0" id="h13-0" class="h">@@ -1,212 +0,0 @@
</a><a href="#h13-0-0" id="h13-0-0" class="d">-package me.rhunk.snapenhance.common.bridge.wrapper
</a><a href="#h13-0-1" id="h13-0-1" class="d">-
</a><a href="#h13-0-2" id="h13-0-2" class="d">-import android.content.ContentValues
</a><a href="#h13-0-3" id="h13-0-3" class="d">-import android.database.sqlite.SQLiteDatabase
</a><a href="#h13-0-4" id="h13-0-4" class="d">-import kotlinx.coroutines.*
</a><a href="#h13-0-5" id="h13-0-5" class="d">-import me.rhunk.snapenhance.bridge.MessageLoggerInterface
</a><a href="#h13-0-6" id="h13-0-6" class="d">-import me.rhunk.snapenhance.common.data.StoryData
</a><a href="#h13-0-7" id="h13-0-7" class="d">-import me.rhunk.snapenhance.common.util.SQLiteDatabaseHelper
</a><a href="#h13-0-8" id="h13-0-8" class="d">-import me.rhunk.snapenhance.common.util.ktx.getBlobOrNull
</a><a href="#h13-0-9" id="h13-0-9" class="d">-import me.rhunk.snapenhance.common.util.ktx.getLongOrNull
</a><a href="#h13-0-10" id="h13-0-10" class="d">-import me.rhunk.snapenhance.common.util.ktx.getStringOrNull
</a><a href="#h13-0-11" id="h13-0-11" class="d">-import java.io.File
</a><a href="#h13-0-12" id="h13-0-12" class="d">-import java.util.UUID
</a><a href="#h13-0-13" id="h13-0-13" class="d">-
</a><a href="#h13-0-14" id="h13-0-14" class="d">-
</a><a href="#h13-0-15" id="h13-0-15" class="d">-class LoggedMessage(
</a><a href="#h13-0-16" id="h13-0-16" class="d">-    val messageId: Long,
</a><a href="#h13-0-17" id="h13-0-17" class="d">-    val timestamp: Long,
</a><a href="#h13-0-18" id="h13-0-18" class="d">-    val messageData: ByteArray
</a><a href="#h13-0-19" id="h13-0-19" class="d">-)
</a><a href="#h13-0-20" id="h13-0-20" class="d">-
</a><a href="#h13-0-21" id="h13-0-21" class="d">-class MessageLoggerWrapper(
</a><a href="#h13-0-22" id="h13-0-22" class="d">-    val databaseFile: File
</a><a href="#h13-0-23" id="h13-0-23" class="d">-): MessageLoggerInterface.Stub() {
</a><a href="#h13-0-24" id="h13-0-24" class="d">-    private var _database: SQLiteDatabase? = null
</a><a href="#h13-0-25" id="h13-0-25" class="d">-    @OptIn(ExperimentalCoroutinesApi::class)
</a><a href="#h13-0-26" id="h13-0-26" class="d">-    private val coroutineScope = CoroutineScope(Dispatchers.IO.limitedParallelism(1))
</a><a href="#h13-0-27" id="h13-0-27" class="d">-
</a><a href="#h13-0-28" id="h13-0-28" class="d">-    private val database get() = synchronized(this) {
</a><a href="#h13-0-29" id="h13-0-29" class="d">-        _database?.takeIf { it.isOpen } ?: run {
</a><a href="#h13-0-30" id="h13-0-30" class="d">-            _database?.close()
</a><a href="#h13-0-31" id="h13-0-31" class="d">-            val openedDatabase = SQLiteDatabase.openDatabase(databaseFile.absolutePath, null, SQLiteDatabase.CREATE_IF_NECESSARY or SQLiteDatabase.OPEN_READWRITE)
</a><a href="#h13-0-32" id="h13-0-32" class="d">-            SQLiteDatabaseHelper.createTablesFromSchema(openedDatabase, mapOf(
</a><a href="#h13-0-33" id="h13-0-33" class="d">-                &quot;messages&quot; to listOf(
</a><a href="#h13-0-34" id="h13-0-34" class="d">-                    &quot;id INTEGER PRIMARY KEY&quot;,
</a><a href="#h13-0-35" id="h13-0-35" class="d">-                    &quot;added_timestamp BIGINT&quot;,
</a><a href="#h13-0-36" id="h13-0-36" class="d">-                    &quot;conversation_id VARCHAR&quot;,
</a><a href="#h13-0-37" id="h13-0-37" class="d">-                    &quot;message_id BIGINT&quot;,
</a><a href="#h13-0-38" id="h13-0-38" class="d">-                    &quot;message_data BLOB&quot;
</a><a href="#h13-0-39" id="h13-0-39" class="d">-                ),
</a><a href="#h13-0-40" id="h13-0-40" class="d">-                &quot;stories&quot; to listOf(
</a><a href="#h13-0-41" id="h13-0-41" class="d">-                    &quot;id INTEGER PRIMARY KEY&quot;,
</a><a href="#h13-0-42" id="h13-0-42" class="d">-                    &quot;added_timestamp BIGINT&quot;,
</a><a href="#h13-0-43" id="h13-0-43" class="d">-                    &quot;user_id VARCHAR&quot;,
</a><a href="#h13-0-44" id="h13-0-44" class="d">-                    &quot;posted_timestamp BIGINT&quot;,
</a><a href="#h13-0-45" id="h13-0-45" class="d">-                    &quot;created_timestamp BIGINT&quot;,
</a><a href="#h13-0-46" id="h13-0-46" class="d">-                    &quot;url VARCHAR&quot;,
</a><a href="#h13-0-47" id="h13-0-47" class="d">-                    &quot;encryption_key BLOB&quot;,
</a><a href="#h13-0-48" id="h13-0-48" class="d">-                    &quot;encryption_iv BLOB&quot;
</a><a href="#h13-0-49" id="h13-0-49" class="d">-                )
</a><a href="#h13-0-50" id="h13-0-50" class="d">-            ))
</a><a href="#h13-0-51" id="h13-0-51" class="d">-            _database = openedDatabase
</a><a href="#h13-0-52" id="h13-0-52" class="d">-            openedDatabase
</a><a href="#h13-0-53" id="h13-0-53" class="d">-        }
</a><a href="#h13-0-54" id="h13-0-54" class="d">-    }
</a><a href="#h13-0-55" id="h13-0-55" class="d">-
</a><a href="#h13-0-56" id="h13-0-56" class="d">-    protected fun finalize() {
</a><a href="#h13-0-57" id="h13-0-57" class="d">-        _database?.close()
</a><a href="#h13-0-58" id="h13-0-58" class="d">-    }
</a><a href="#h13-0-59" id="h13-0-59" class="d">-
</a><a href="#h13-0-60" id="h13-0-60" class="d">-    fun init() {
</a><a href="#h13-0-61" id="h13-0-61" class="d">-
</a><a href="#h13-0-62" id="h13-0-62" class="d">-    }
</a><a href="#h13-0-63" id="h13-0-63" class="d">-
</a><a href="#h13-0-64" id="h13-0-64" class="d">-    override fun getLoggedIds(conversationId: Array&lt;String&gt;, limit: Int): LongArray {
</a><a href="#h13-0-65" id="h13-0-65" class="d">-        if (conversationId.any {
</a><a href="#h13-0-66" id="h13-0-66" class="d">-            runCatching { UUID.fromString(it) }.isFailure
</a><a href="#h13-0-67" id="h13-0-67" class="d">-        }) return longArrayOf()
</a><a href="#h13-0-68" id="h13-0-68" class="d">-
</a><a href="#h13-0-69" id="h13-0-69" class="d">-        return database.rawQuery(&quot;SELECT message_id FROM messages WHERE conversation_id IN (${
</a><a href="#h13-0-70" id="h13-0-70" class="d">-            conversationId.joinToString(&quot;,&quot;) { &quot;&#39;$it&#39;&quot; }
</a><a href="#h13-0-71" id="h13-0-71" class="d">-        }) ORDER BY message_id DESC LIMIT $limit&quot;, null).use {
</a><a href="#h13-0-72" id="h13-0-72" class="d">-            val ids = mutableListOf&lt;Long&gt;()
</a><a href="#h13-0-73" id="h13-0-73" class="d">-            while (it.moveToNext()) {
</a><a href="#h13-0-74" id="h13-0-74" class="d">-                ids.add(it.getLong(0))
</a><a href="#h13-0-75" id="h13-0-75" class="d">-            }
</a><a href="#h13-0-76" id="h13-0-76" class="d">-            ids.toLongArray()
</a><a href="#h13-0-77" id="h13-0-77" class="d">-        }
</a><a href="#h13-0-78" id="h13-0-78" class="d">-    }
</a><a href="#h13-0-79" id="h13-0-79" class="d">-
</a><a href="#h13-0-80" id="h13-0-80" class="d">-    override fun getMessage(conversationId: String?, id: Long): ByteArray? {
</a><a href="#h13-0-81" id="h13-0-81" class="d">-        return database.rawQuery(
</a><a href="#h13-0-82" id="h13-0-82" class="d">-            &quot;SELECT message_data FROM messages WHERE conversation_id = ? AND message_id = ?&quot;,
</a><a href="#h13-0-83" id="h13-0-83" class="d">-            arrayOf(conversationId, id.toString())
</a><a href="#h13-0-84" id="h13-0-84" class="d">-        ).use {
</a><a href="#h13-0-85" id="h13-0-85" class="d">-            if (it.moveToFirst()) it.getBlob(0) else null
</a><a href="#h13-0-86" id="h13-0-86" class="d">-        }
</a><a href="#h13-0-87" id="h13-0-87" class="d">-    }
</a><a href="#h13-0-88" id="h13-0-88" class="d">-
</a><a href="#h13-0-89" id="h13-0-89" class="d">-    override fun addMessage(conversationId: String, messageId: Long, serializedMessage: ByteArray) {
</a><a href="#h13-0-90" id="h13-0-90" class="d">-        val cursor = database.rawQuery(&quot;SELECT message_id FROM messages WHERE conversation_id = ? AND message_id = ?&quot;, arrayOf(conversationId, messageId.toString()))
</a><a href="#h13-0-91" id="h13-0-91" class="d">-        val state = cursor.moveToFirst()
</a><a href="#h13-0-92" id="h13-0-92" class="d">-        cursor.close()
</a><a href="#h13-0-93" id="h13-0-93" class="d">-        if (state) return
</a><a href="#h13-0-94" id="h13-0-94" class="d">-        runBlocking {
</a><a href="#h13-0-95" id="h13-0-95" class="d">-            withContext(coroutineScope.coroutineContext) {
</a><a href="#h13-0-96" id="h13-0-96" class="d">-                database.insert(&quot;messages&quot;, null, ContentValues().apply {
</a><a href="#h13-0-97" id="h13-0-97" class="d">-                    put(&quot;added_timestamp&quot;, System.currentTimeMillis())
</a><a href="#h13-0-98" id="h13-0-98" class="d">-                    put(&quot;conversation_id&quot;, conversationId)
</a><a href="#h13-0-99" id="h13-0-99" class="d">-                    put(&quot;message_id&quot;, messageId)
</a><a href="#h13-0-100" id="h13-0-100" class="d">-                    put(&quot;message_data&quot;, serializedMessage)
</a><a href="#h13-0-101" id="h13-0-101" class="d">-                })
</a><a href="#h13-0-102" id="h13-0-102" class="d">-            }
</a><a href="#h13-0-103" id="h13-0-103" class="d">-        }
</a><a href="#h13-0-104" id="h13-0-104" class="d">-    }
</a><a href="#h13-0-105" id="h13-0-105" class="d">-
</a><a href="#h13-0-106" id="h13-0-106" class="d">-    fun purgeAll(maxAge: Long? = null) {
</a><a href="#h13-0-107" id="h13-0-107" class="d">-        coroutineScope.launch {
</a><a href="#h13-0-108" id="h13-0-108" class="d">-            maxAge?.let {
</a><a href="#h13-0-109" id="h13-0-109" class="d">-                val maxTime = System.currentTimeMillis() - it
</a><a href="#h13-0-110" id="h13-0-110" class="d">-                database.execSQL(&quot;DELETE FROM messages WHERE added_timestamp &lt; ?&quot;, arrayOf(maxTime.toString()))
</a><a href="#h13-0-111" id="h13-0-111" class="d">-                database.execSQL(&quot;DELETE FROM stories WHERE added_timestamp &lt; ?&quot;, arrayOf(maxTime.toString()))
</a><a href="#h13-0-112" id="h13-0-112" class="d">-            } ?: run {
</a><a href="#h13-0-113" id="h13-0-113" class="d">-                database.execSQL(&quot;DELETE FROM messages&quot;)
</a><a href="#h13-0-114" id="h13-0-114" class="d">-                database.execSQL(&quot;DELETE FROM stories&quot;)
</a><a href="#h13-0-115" id="h13-0-115" class="d">-            }
</a><a href="#h13-0-116" id="h13-0-116" class="d">-        }
</a><a href="#h13-0-117" id="h13-0-117" class="d">-    }
</a><a href="#h13-0-118" id="h13-0-118" class="d">-
</a><a href="#h13-0-119" id="h13-0-119" class="d">-    fun getStoredMessageCount(): Int {
</a><a href="#h13-0-120" id="h13-0-120" class="d">-        return database.rawQuery(&quot;SELECT COUNT(*) FROM messages&quot;, null).use {
</a><a href="#h13-0-121" id="h13-0-121" class="d">-            it.moveToFirst()
</a><a href="#h13-0-122" id="h13-0-122" class="d">-            it.getInt(0)
</a><a href="#h13-0-123" id="h13-0-123" class="d">-        }
</a><a href="#h13-0-124" id="h13-0-124" class="d">-    }
</a><a href="#h13-0-125" id="h13-0-125" class="d">-
</a><a href="#h13-0-126" id="h13-0-126" class="d">-    fun getStoredStoriesCount(): Int {
</a><a href="#h13-0-127" id="h13-0-127" class="d">-        return database.rawQuery(&quot;SELECT COUNT(*) FROM stories&quot;, null).use {
</a><a href="#h13-0-128" id="h13-0-128" class="d">-            it.moveToFirst()
</a><a href="#h13-0-129" id="h13-0-129" class="d">-            it.getInt(0)
</a><a href="#h13-0-130" id="h13-0-130" class="d">-        }
</a><a href="#h13-0-131" id="h13-0-131" class="d">-    }
</a><a href="#h13-0-132" id="h13-0-132" class="d">-
</a><a href="#h13-0-133" id="h13-0-133" class="d">-    override fun deleteMessage(conversationId: String, messageId: Long) {
</a><a href="#h13-0-134" id="h13-0-134" class="d">-        coroutineScope.launch {
</a><a href="#h13-0-135" id="h13-0-135" class="d">-            database.execSQL(&quot;DELETE FROM messages WHERE conversation_id = ? AND message_id = ?&quot;, arrayOf(conversationId, messageId.toString()))
</a><a href="#h13-0-136" id="h13-0-136" class="d">-        }
</a><a href="#h13-0-137" id="h13-0-137" class="d">-    }
</a><a href="#h13-0-138" id="h13-0-138" class="d">-
</a><a href="#h13-0-139" id="h13-0-139" class="d">-    override fun addStory(userId: String, url: String, postedAt: Long, createdAt: Long, key: ByteArray?, iv: ByteArray?): Boolean {
</a><a href="#h13-0-140" id="h13-0-140" class="d">-        if (database.rawQuery(&quot;SELECT id FROM stories WHERE user_id = ? AND url = ?&quot;, arrayOf(userId, url)).use {
</a><a href="#h13-0-141" id="h13-0-141" class="d">-            it.moveToFirst()
</a><a href="#h13-0-142" id="h13-0-142" class="d">-        }) {
</a><a href="#h13-0-143" id="h13-0-143" class="d">-            return false
</a><a href="#h13-0-144" id="h13-0-144" class="d">-        }
</a><a href="#h13-0-145" id="h13-0-145" class="d">-        runBlocking {
</a><a href="#h13-0-146" id="h13-0-146" class="d">-            withContext(coroutineScope.coroutineContext) {
</a><a href="#h13-0-147" id="h13-0-147" class="d">-                database.insert(&quot;stories&quot;, null, ContentValues().apply {
</a><a href="#h13-0-148" id="h13-0-148" class="d">-                    put(&quot;user_id&quot;, userId)
</a><a href="#h13-0-149" id="h13-0-149" class="d">-                    put(&quot;added_timestamp&quot;, System.currentTimeMillis())
</a><a href="#h13-0-150" id="h13-0-150" class="d">-                    put(&quot;url&quot;, url)
</a><a href="#h13-0-151" id="h13-0-151" class="d">-                    put(&quot;posted_timestamp&quot;, postedAt)
</a><a href="#h13-0-152" id="h13-0-152" class="d">-                    put(&quot;created_timestamp&quot;, createdAt)
</a><a href="#h13-0-153" id="h13-0-153" class="d">-                    put(&quot;encryption_key&quot;, key)
</a><a href="#h13-0-154" id="h13-0-154" class="d">-                    put(&quot;encryption_iv&quot;, iv)
</a><a href="#h13-0-155" id="h13-0-155" class="d">-                })
</a><a href="#h13-0-156" id="h13-0-156" class="d">-            }
</a><a href="#h13-0-157" id="h13-0-157" class="d">-        }
</a><a href="#h13-0-158" id="h13-0-158" class="d">-        return true
</a><a href="#h13-0-159" id="h13-0-159" class="d">-    }
</a><a href="#h13-0-160" id="h13-0-160" class="d">-
</a><a href="#h13-0-161" id="h13-0-161" class="d">-    fun getStories(userId: String, from: Long, limit: Int = Int.MAX_VALUE): Map&lt;Long, StoryData&gt; {
</a><a href="#h13-0-162" id="h13-0-162" class="d">-        val stories = sortedMapOf&lt;Long, StoryData&gt;()
</a><a href="#h13-0-163" id="h13-0-163" class="d">-        database.rawQuery(&quot;SELECT * FROM stories WHERE user_id = ? AND posted_timestamp &lt; ? ORDER BY posted_timestamp DESC LIMIT $limit&quot;, arrayOf(userId, from.toString())).use {
</a><a href="#h13-0-164" id="h13-0-164" class="d">-            while (it.moveToNext()) {
</a><a href="#h13-0-165" id="h13-0-165" class="d">-                stories[it.getLongOrNull(&quot;posted_timestamp&quot;) ?: continue] = StoryData(
</a><a href="#h13-0-166" id="h13-0-166" class="d">-                    url = it.getStringOrNull(&quot;url&quot;) ?: continue,
</a><a href="#h13-0-167" id="h13-0-167" class="d">-                    postedAt = it.getLongOrNull(&quot;posted_timestamp&quot;) ?: continue,
</a><a href="#h13-0-168" id="h13-0-168" class="d">-                    createdAt = it.getLongOrNull(&quot;created_timestamp&quot;) ?: continue,
</a><a href="#h13-0-169" id="h13-0-169" class="d">-                    key = it.getBlobOrNull(&quot;encryption_key&quot;),
</a><a href="#h13-0-170" id="h13-0-170" class="d">-                    iv = it.getBlobOrNull(&quot;encryption_iv&quot;)
</a><a href="#h13-0-171" id="h13-0-171" class="d">-                )
</a><a href="#h13-0-172" id="h13-0-172" class="d">-            }
</a><a href="#h13-0-173" id="h13-0-173" class="d">-        }
</a><a href="#h13-0-174" id="h13-0-174" class="d">-        return stories
</a><a href="#h13-0-175" id="h13-0-175" class="d">-    }
</a><a href="#h13-0-176" id="h13-0-176" class="d">-
</a><a href="#h13-0-177" id="h13-0-177" class="d">-    fun getAllConversations(): List&lt;String&gt; {
</a><a href="#h13-0-178" id="h13-0-178" class="d">-        return database.rawQuery(&quot;SELECT DISTINCT conversation_id FROM messages&quot;, null).use {
</a><a href="#h13-0-179" id="h13-0-179" class="d">-            val conversations = mutableListOf&lt;String&gt;()
</a><a href="#h13-0-180" id="h13-0-180" class="d">-            while (it.moveToNext()) {
</a><a href="#h13-0-181" id="h13-0-181" class="d">-                conversations.add(it.getString(0))
</a><a href="#h13-0-182" id="h13-0-182" class="d">-            }
</a><a href="#h13-0-183" id="h13-0-183" class="d">-            conversations
</a><a href="#h13-0-184" id="h13-0-184" class="d">-        }
</a><a href="#h13-0-185" id="h13-0-185" class="d">-    }
</a><a href="#h13-0-186" id="h13-0-186" class="d">-
</a><a href="#h13-0-187" id="h13-0-187" class="d">-    fun fetchMessages(
</a><a href="#h13-0-188" id="h13-0-188" class="d">-        conversationId: String,
</a><a href="#h13-0-189" id="h13-0-189" class="d">-        fromTimestamp: Long,
</a><a href="#h13-0-190" id="h13-0-190" class="d">-        limit: Int,
</a><a href="#h13-0-191" id="h13-0-191" class="d">-        reverseOrder: Boolean = true,
</a><a href="#h13-0-192" id="h13-0-192" class="d">-        filter: ((LoggedMessage) -&gt; Boolean)? = null
</a><a href="#h13-0-193" id="h13-0-193" class="d">-    ): List&lt;LoggedMessage&gt; {
</a><a href="#h13-0-194" id="h13-0-194" class="d">-        val messages = mutableListOf&lt;LoggedMessage&gt;()
</a><a href="#h13-0-195" id="h13-0-195" class="d">-        database.rawQuery(
</a><a href="#h13-0-196" id="h13-0-196" class="d">-            &quot;SELECT * FROM messages WHERE conversation_id = ? AND added_timestamp ${if (reverseOrder) &quot;&lt;&quot; else &quot;&gt;&quot;} ? ORDER BY added_timestamp ${if (reverseOrder) &quot;DESC&quot; else &quot;ASC&quot;}&quot;,
</a><a href="#h13-0-197" id="h13-0-197" class="d">-            arrayOf(conversationId, fromTimestamp.toString())
</a><a href="#h13-0-198" id="h13-0-198" class="d">-        ).use {
</a><a href="#h13-0-199" id="h13-0-199" class="d">-            while (it.moveToNext() &amp;&amp; messages.size &lt; limit) {
</a><a href="#h13-0-200" id="h13-0-200" class="d">-                val message = LoggedMessage(
</a><a href="#h13-0-201" id="h13-0-201" class="d">-                    messageId = it.getLongOrNull(&quot;message_id&quot;) ?: continue,
</a><a href="#h13-0-202" id="h13-0-202" class="d">-                    timestamp = it.getLongOrNull(&quot;added_timestamp&quot;) ?: continue,
</a><a href="#h13-0-203" id="h13-0-203" class="d">-                    messageData = it.getBlobOrNull(&quot;message_data&quot;) ?: continue
</a><a href="#h13-0-204" id="h13-0-204" class="d">-                )
</a><a href="#h13-0-205" id="h13-0-205" class="d">-                if (filter != null &amp;&amp; !filter(message)) continue
</a><a href="#h13-0-206" id="h13-0-206" class="d">-                messages.add(message)
</a><a href="#h13-0-207" id="h13-0-207" class="d">-            }
</a><a href="#h13-0-208" id="h13-0-208" class="d">-        }
</a><a href="#h13-0-209" id="h13-0-209" class="d">-        return messages
</a><a href="#h13-0-210" id="h13-0-210" class="d">-    }
</a><a href="#h13-0-211" id="h13-0-211" class="d">-}</a><a href="#h13-0-212" id="h13-0-212" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h14" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/data/SessionEventsData.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/data/SessionEventsData.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/data/SessionEventsData.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/data/SessionEventsData.kt</a></b>
<a href="#h14-0" id="h14-0" class="h">@@ -1,5 +1,8 @@
</a> package me.rhunk.snapenhance.common.data
 
<a href="#h14-0-2" id="h14-0-2" class="i">+import android.os.Parcelable
</a><a href="#h14-0-3" id="h14-0-3" class="i">+import kotlinx.parcelize.Parcelize
</a><a href="#h14-0-4" id="h14-0-4" class="i">+
</a> 
 data class FriendPresenceState(
     val bitmojiPresent: Boolean,
<a href="#h14-1" id="h14-1" class="h">@@ -40,3 +43,94 @@ enum class SessionEventType(
</a>     SNAP_SCREENSHOT(&quot;snap_screenshot&quot;),
     SNAP_SCREEN_RECORD(&quot;snap_screen_record&quot;),
 }
<a href="#h14-1-3" id="h14-1-3" class="i">+
</a><a href="#h14-1-4" id="h14-1-4" class="i">+object TrackerFlags {
</a><a href="#h14-1-5" id="h14-1-5" class="i">+    const val TRACK = 1
</a><a href="#h14-1-6" id="h14-1-6" class="i">+    const val LOG = 2
</a><a href="#h14-1-7" id="h14-1-7" class="i">+    const val NOTIFY = 4
</a><a href="#h14-1-8" id="h14-1-8" class="i">+    const val APP_IS_ACTIVE = 8
</a><a href="#h14-1-9" id="h14-1-9" class="i">+    const val APP_IS_INACTIVE = 16
</a><a href="#h14-1-10" id="h14-1-10" class="i">+    const val IS_IN_CONVERSATION = 32
</a><a href="#h14-1-11" id="h14-1-11" class="i">+}
</a><a href="#h14-1-12" id="h14-1-12" class="i">+
</a><a href="#h14-1-13" id="h14-1-13" class="i">+@Parcelize
</a><a href="#h14-1-14" id="h14-1-14" class="i">+class TrackerEventsResult(
</a><a href="#h14-1-15" id="h14-1-15" class="i">+    private val rules: Map&lt;TrackerRule, List&lt;TrackerRuleEvent&gt;&gt;
</a><a href="#h14-1-16" id="h14-1-16" class="i">+): Parcelable {
</a><a href="#h14-1-17" id="h14-1-17" class="i">+    fun hasFlags(vararg flags: Int): Boolean {
</a><a href="#h14-1-18" id="h14-1-18" class="i">+        return rules.any { (_, ruleEvents) -&gt;
</a><a href="#h14-1-19" id="h14-1-19" class="i">+            ruleEvents.any { flags.all { flag -&gt; it.flags and flag != 0 } }
</a><a href="#h14-1-20" id="h14-1-20" class="i">+        }
</a><a href="#h14-1-21" id="h14-1-21" class="i">+    }
</a><a href="#h14-1-22" id="h14-1-22" class="i">+
</a><a href="#h14-1-23" id="h14-1-23" class="i">+    fun canTrackOn(conversationId: String?, userId: String?): Boolean {
</a><a href="#h14-1-24" id="h14-1-24" class="i">+        return rules.any t@{ (rule, ruleEvents) -&gt;
</a><a href="#h14-1-25" id="h14-1-25" class="i">+            ruleEvents.any { event -&gt;
</a><a href="#h14-1-26" id="h14-1-26" class="i">+                if (event.flags and TrackerFlags.TRACK == 0) {
</a><a href="#h14-1-27" id="h14-1-27" class="i">+                    return@any false
</a><a href="#h14-1-28" id="h14-1-28" class="i">+                }
</a><a href="#h14-1-29" id="h14-1-29" class="i">+
</a><a href="#h14-1-30" id="h14-1-30" class="i">+                // global rule
</a><a href="#h14-1-31" id="h14-1-31" class="i">+                if (rule.conversationId == null &amp;&amp; rule.userId == null) {
</a><a href="#h14-1-32" id="h14-1-32" class="i">+                    return@any true
</a><a href="#h14-1-33" id="h14-1-33" class="i">+                }
</a><a href="#h14-1-34" id="h14-1-34" class="i">+
</a><a href="#h14-1-35" id="h14-1-35" class="i">+                // user rule
</a><a href="#h14-1-36" id="h14-1-36" class="i">+                if (rule.conversationId == null &amp;&amp; rule.userId == userId) {
</a><a href="#h14-1-37" id="h14-1-37" class="i">+                    return@any true
</a><a href="#h14-1-38" id="h14-1-38" class="i">+                }
</a><a href="#h14-1-39" id="h14-1-39" class="i">+
</a><a href="#h14-1-40" id="h14-1-40" class="i">+                // conversation rule
</a><a href="#h14-1-41" id="h14-1-41" class="i">+                if (rule.conversationId == conversationId &amp;&amp; rule.userId == null) {
</a><a href="#h14-1-42" id="h14-1-42" class="i">+                    return@any true
</a><a href="#h14-1-43" id="h14-1-43" class="i">+                }
</a><a href="#h14-1-44" id="h14-1-44" class="i">+
</a><a href="#h14-1-45" id="h14-1-45" class="i">+                // conversation and user rule
</a><a href="#h14-1-46" id="h14-1-46" class="i">+                return@any rule.conversationId == conversationId &amp;&amp; rule.userId == userId
</a><a href="#h14-1-47" id="h14-1-47" class="i">+            }
</a><a href="#h14-1-48" id="h14-1-48" class="i">+        }
</a><a href="#h14-1-49" id="h14-1-49" class="i">+    }
</a><a href="#h14-1-50" id="h14-1-50" class="i">+}
</a><a href="#h14-1-51" id="h14-1-51" class="i">+
</a><a href="#h14-1-52" id="h14-1-52" class="i">+
</a><a href="#h14-1-53" id="h14-1-53" class="i">+@Parcelize
</a><a href="#h14-1-54" id="h14-1-54" class="i">+data class TrackerRule(
</a><a href="#h14-1-55" id="h14-1-55" class="i">+    val id: Int,
</a><a href="#h14-1-56" id="h14-1-56" class="i">+    val flags: Int,
</a><a href="#h14-1-57" id="h14-1-57" class="i">+    val conversationId: String?,
</a><a href="#h14-1-58" id="h14-1-58" class="i">+    val userId: String?
</a><a href="#h14-1-59" id="h14-1-59" class="i">+): Parcelable
</a><a href="#h14-1-60" id="h14-1-60" class="i">+
</a><a href="#h14-1-61" id="h14-1-61" class="i">+@Parcelize
</a><a href="#h14-1-62" id="h14-1-62" class="i">+data class TrackerRuleEvent(
</a><a href="#h14-1-63" id="h14-1-63" class="i">+    val id: Int,
</a><a href="#h14-1-64" id="h14-1-64" class="i">+    val flags: Int,
</a><a href="#h14-1-65" id="h14-1-65" class="i">+    val eventType: String,
</a><a href="#h14-1-66" id="h14-1-66" class="i">+): Parcelable
</a><a href="#h14-1-67" id="h14-1-67" class="i">+
</a><a href="#h14-1-68" id="h14-1-68" class="i">+enum class TrackerEventType(
</a><a href="#h14-1-69" id="h14-1-69" class="i">+    val key: String
</a><a href="#h14-1-70" id="h14-1-70" class="i">+) {
</a><a href="#h14-1-71" id="h14-1-71" class="i">+    // pcs events
</a><a href="#h14-1-72" id="h14-1-72" class="i">+    CONVERSATION_ENTER(&quot;conversation_enter&quot;),
</a><a href="#h14-1-73" id="h14-1-73" class="i">+    CONVERSATION_EXIT(&quot;conversation_exit&quot;),
</a><a href="#h14-1-74" id="h14-1-74" class="i">+    STARTED_TYPING(&quot;started_typing&quot;),
</a><a href="#h14-1-75" id="h14-1-75" class="i">+    STOPPED_TYPING(&quot;stopped_typing&quot;),
</a><a href="#h14-1-76" id="h14-1-76" class="i">+    STARTED_SPEAKING(&quot;started_speaking&quot;),
</a><a href="#h14-1-77" id="h14-1-77" class="i">+    STOPPED_SPEAKING(&quot;stopped_speaking&quot;),
</a><a href="#h14-1-78" id="h14-1-78" class="i">+    STARTED_PEEKING(&quot;started_peeking&quot;),
</a><a href="#h14-1-79" id="h14-1-79" class="i">+    STOPPED_PEEKING(&quot;stopped_peeking&quot;),
</a><a href="#h14-1-80" id="h14-1-80" class="i">+
</a><a href="#h14-1-81" id="h14-1-81" class="i">+    // mcs events
</a><a href="#h14-1-82" id="h14-1-82" class="i">+    MESSAGE_READ(&quot;message_read&quot;),
</a><a href="#h14-1-83" id="h14-1-83" class="i">+    MESSAGE_DELETED(&quot;message_deleted&quot;),
</a><a href="#h14-1-84" id="h14-1-84" class="i">+    MESSAGE_SAVED(&quot;message_saved&quot;),
</a><a href="#h14-1-85" id="h14-1-85" class="i">+    MESSAGE_UNSAVED(&quot;message_unsaved&quot;),
</a><a href="#h14-1-86" id="h14-1-86" class="i">+    MESSAGE_REACTION_ADD(&quot;message_reaction_add&quot;),
</a><a href="#h14-1-87" id="h14-1-87" class="i">+    MESSAGE_REACTION_REMOVE(&quot;message_reaction_remove&quot;),
</a><a href="#h14-1-88" id="h14-1-88" class="i">+    SNAP_OPENED(&quot;snap_opened&quot;),
</a><a href="#h14-1-89" id="h14-1-89" class="i">+    SNAP_REPLAYED(&quot;snap_replayed&quot;),
</a><a href="#h14-1-90" id="h14-1-90" class="i">+    SNAP_REPLAYED_TWICE(&quot;snap_replayed_twice&quot;),
</a><a href="#h14-1-91" id="h14-1-91" class="i">+    SNAP_SCREENSHOT(&quot;snap_screenshot&quot;),
</a><a href="#h14-1-92" id="h14-1-92" class="i">+    SNAP_SCREEN_RECORD(&quot;snap_screen_record&quot;),
</a><a href="#h14-1-93" id="h14-1-93" class="i">+}
</a><b>diff --git a/<a id="h15" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/BridgeClient.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/BridgeClient.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/BridgeClient.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/BridgeClient.kt</a></b>
<a href="#h15-0" id="h15-0" class="h">@@ -14,9 +14,10 @@ import de.robv.android.xposed.XposedHelpers
</a> import me.rhunk.snapenhance.bridge.BridgeInterface
 import me.rhunk.snapenhance.bridge.ConfigStateListener
 import me.rhunk.snapenhance.bridge.DownloadCallback
<a href="#h15-0-3" id="h15-0-3" class="d">-import me.rhunk.snapenhance.bridge.MessageLoggerInterface
</a><a href="#h15-0-4" id="h15-0-4" class="i">+import me.rhunk.snapenhance.bridge.logger.LoggerInterface
</a> import me.rhunk.snapenhance.bridge.SyncCallback
 import me.rhunk.snapenhance.bridge.e2ee.E2eeInterface
<a href="#h15-0-7" id="h15-0-7" class="i">+import me.rhunk.snapenhance.bridge.logger.TrackerInterface
</a> import me.rhunk.snapenhance.bridge.scripting.IScripting
 import me.rhunk.snapenhance.bridge.snapclient.MessagingBridge
 import me.rhunk.snapenhance.common.Constants
<a href="#h15-1" id="h15-1" class="h">@@ -191,11 +192,13 @@ class BridgeClient(
</a>         service.setRule(targetUuid, type.key, state)
     }
 
<a href="#h15-1-3" id="h15-1-3" class="d">-    fun getScriptingInterface(): IScripting = safeServiceCall { service.getScriptingInterface() }
</a><a href="#h15-1-4" id="h15-1-4" class="i">+    fun getScriptingInterface(): IScripting = safeServiceCall { service.scriptingInterface }
</a> 
<a href="#h15-1-6" id="h15-1-6" class="d">-    fun getE2eeInterface(): E2eeInterface = safeServiceCall { service.getE2eeInterface() }
</a><a href="#h15-1-7" id="h15-1-7" class="i">+    fun getE2eeInterface(): E2eeInterface = safeServiceCall { service.e2eeInterface }
</a> 
<a href="#h15-1-9" id="h15-1-9" class="d">-    fun getMessageLogger(): MessageLoggerInterface = safeServiceCall { service.messageLogger }
</a><a href="#h15-1-10" id="h15-1-10" class="i">+    fun getMessageLogger(): LoggerInterface = safeServiceCall { service.logger }
</a><a href="#h15-1-11" id="h15-1-11" class="i">+
</a><a href="#h15-1-12" id="h15-1-12" class="i">+    fun getTracker(): TrackerInterface = safeServiceCall { service.tracker }
</a> 
     fun registerMessagingBridge(bridge: MessagingBridge) = safeServiceCall { service.registerMessagingBridge(bridge) }
 
<b>diff --git a/<a id="h16" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/database/DatabaseAccess.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/database/DatabaseAccess.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/database/DatabaseAccess.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/database/DatabaseAccess.kt</a></b>
<a href="#h16-0" id="h16-0" class="h">@@ -252,6 +252,17 @@ class DatabaseAccess(
</a>         }
     }
 
<a href="#h16-0-3" id="h16-0-3" class="i">+    fun getConversationServerMessage(conversationId: String, serverId: Long): ConversationMessage? {
</a><a href="#h16-0-4" id="h16-0-4" class="i">+        return useDatabase(DatabaseType.ARROYO)?.performOperation {
</a><a href="#h16-0-5" id="h16-0-5" class="i">+            readDatabaseObject(
</a><a href="#h16-0-6" id="h16-0-6" class="i">+                ConversationMessage(),
</a><a href="#h16-0-7" id="h16-0-7" class="i">+                &quot;conversation_message&quot;,
</a><a href="#h16-0-8" id="h16-0-8" class="i">+                &quot;client_conversation_id = ? AND server_message_id = ?&quot;,
</a><a href="#h16-0-9" id="h16-0-9" class="i">+                arrayOf(conversationId, serverId.toString())
</a><a href="#h16-0-10" id="h16-0-10" class="i">+            )
</a><a href="#h16-0-11" id="h16-0-11" class="i">+        }
</a><a href="#h16-0-12" id="h16-0-12" class="i">+    }
</a><a href="#h16-0-13" id="h16-0-13" class="i">+
</a>     fun getConversationType(conversationId: String): Int? {
         return useDatabase(DatabaseType.ARROYO)?.performOperation {
             safeRawQuery(
<b>diff --git a/<a id="h17" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/SessionEvents.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/SessionEvents.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/SessionEvents.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/SessionEvents.kt</a></b>
<a href="#h17-0" id="h17-0" class="h">@@ -1,12 +1,15 @@
</a> package me.rhunk.snapenhance.core.features.impl.experiments
 
<a href="#h17-0-2" id="h17-0-2" class="d">-import me.rhunk.snapenhance.common.data.SessionMessageEvent
</a><a href="#h17-0-3" id="h17-0-3" class="d">-import me.rhunk.snapenhance.common.data.SessionEvent
</a><a href="#h17-0-4" id="h17-0-4" class="d">-import me.rhunk.snapenhance.common.data.SessionEventType
</a><a href="#h17-0-5" id="h17-0-5" class="d">-import me.rhunk.snapenhance.common.data.FriendPresenceState
</a><a href="#h17-0-6" id="h17-0-6" class="i">+import android.app.Notification
</a><a href="#h17-0-7" id="h17-0-7" class="i">+import android.app.NotificationManager
</a><a href="#h17-0-8" id="h17-0-8" class="i">+import android.app.PendingIntent
</a><a href="#h17-0-9" id="h17-0-9" class="i">+import me.rhunk.snapenhance.common.Constants
</a><a href="#h17-0-10" id="h17-0-10" class="i">+import me.rhunk.snapenhance.common.data.*
</a> import me.rhunk.snapenhance.common.util.protobuf.ProtoReader
<a href="#h17-0-12" id="h17-0-12" class="i">+import me.rhunk.snapenhance.common.util.toParcelable
</a> import me.rhunk.snapenhance.core.features.Feature
 import me.rhunk.snapenhance.core.features.FeatureLoadParams
<a href="#h17-0-15" id="h17-0-15" class="i">+import me.rhunk.snapenhance.core.features.impl.messaging.Messaging
</a> import me.rhunk.snapenhance.core.util.hook.HookStage
 import me.rhunk.snapenhance.core.util.hook.hook
 import me.rhunk.snapenhance.core.util.hook.hookConstructor
<a href="#h17-1" id="h17-1" class="h">@@ -17,6 +20,43 @@ import java.nio.ByteBuffer
</a> 
 class SessionEvents : Feature(&quot;Session Events&quot;, loadParams = FeatureLoadParams.INIT_SYNC) {
     private val conversationPresenceState = mutableMapOf&lt;String, MutableMap&lt;String, FriendPresenceState?&gt;&gt;() // conversationId -&gt; (userId -&gt; state)
<a href="#h17-1-3" id="h17-1-3" class="i">+    private val tracker by lazy { context.bridgeClient.getTracker() }
</a><a href="#h17-1-4" id="h17-1-4" class="i">+
</a><a href="#h17-1-5" id="h17-1-5" class="i">+    private fun getTrackedEvents(eventType: TrackerEventType): TrackerEventsResult? {
</a><a href="#h17-1-6" id="h17-1-6" class="i">+        return runCatching {
</a><a href="#h17-1-7" id="h17-1-7" class="i">+            tracker.getTrackedEvents(eventType.key)?.let {
</a><a href="#h17-1-8" id="h17-1-8" class="i">+                toParcelable&lt;TrackerEventsResult&gt;(it)
</a><a href="#h17-1-9" id="h17-1-9" class="i">+            }
</a><a href="#h17-1-10" id="h17-1-10" class="i">+        }.onFailure {
</a><a href="#h17-1-11" id="h17-1-11" class="i">+            context.log.error(&quot;Failed to get tracked events for $eventType&quot;, it)
</a><a href="#h17-1-12" id="h17-1-12" class="i">+        }.getOrNull()
</a><a href="#h17-1-13" id="h17-1-13" class="i">+    }
</a><a href="#h17-1-14" id="h17-1-14" class="i">+
</a><a href="#h17-1-15" id="h17-1-15" class="i">+    private fun isInConversation(conversationId: String) = context.feature(Messaging::class).openedConversationUUID?.toString() == conversationId
</a><a href="#h17-1-16" id="h17-1-16" class="i">+
</a><a href="#h17-1-17" id="h17-1-17" class="i">+    private fun sendInfoNotification(id: Int = System.nanoTime().toInt(), text: String) {
</a><a href="#h17-1-18" id="h17-1-18" class="i">+        context.androidContext.getSystemService(NotificationManager::class.java).notify(
</a><a href="#h17-1-19" id="h17-1-19" class="i">+            id,
</a><a href="#h17-1-20" id="h17-1-20" class="i">+                Notification.Builder(
</a><a href="#h17-1-21" id="h17-1-21" class="i">+                    context.androidContext,
</a><a href="#h17-1-22" id="h17-1-22" class="i">+                    &quot;general_group_generic_push_noisy_generic_push_B~LVSD2&quot;
</a><a href="#h17-1-23" id="h17-1-23" class="i">+                )
</a><a href="#h17-1-24" id="h17-1-24" class="i">+                .setSmallIcon(android.R.drawable.ic_dialog_info)
</a><a href="#h17-1-25" id="h17-1-25" class="i">+                .setAutoCancel(true)
</a><a href="#h17-1-26" id="h17-1-26" class="i">+                .setShowWhen(true)
</a><a href="#h17-1-27" id="h17-1-27" class="i">+                .setWhen(System.currentTimeMillis())
</a><a href="#h17-1-28" id="h17-1-28" class="i">+                .setContentIntent(context.androidContext.packageManager.getLaunchIntentForPackage(
</a><a href="#h17-1-29" id="h17-1-29" class="i">+                    Constants.SNAPCHAT_PACKAGE_NAME
</a><a href="#h17-1-30" id="h17-1-30" class="i">+                )?.let {
</a><a href="#h17-1-31" id="h17-1-31" class="i">+                    PendingIntent.getActivity(
</a><a href="#h17-1-32" id="h17-1-32" class="i">+                        context.androidContext,
</a><a href="#h17-1-33" id="h17-1-33" class="i">+                        0, it, PendingIntent.FLAG_IMMUTABLE
</a><a href="#h17-1-34" id="h17-1-34" class="i">+                    )
</a><a href="#h17-1-35" id="h17-1-35" class="i">+                })
</a><a href="#h17-1-36" id="h17-1-36" class="i">+                .setContentText(text)
</a><a href="#h17-1-37" id="h17-1-37" class="i">+                .build()
</a><a href="#h17-1-38" id="h17-1-38" class="i">+        )
</a><a href="#h17-1-39" id="h17-1-39" class="i">+    }
</a> 
     private fun handleVolatileEvent(protoReader: ProtoReader) {
         context.log.verbose(&quot;volatile event\n$protoReader&quot;)
<a href="#h17-2" id="h17-2" class="h">@@ -24,10 +64,97 @@ class SessionEvents : Feature(&quot;Session Events&quot;, loadParams = FeatureLoadParams.I
</a> 
     private fun onConversationPresenceUpdate(conversationId: String, userId: String, oldState: FriendPresenceState?, currentState: FriendPresenceState?) {
         context.log.verbose(&quot;presence state for $userId in conversation $conversationId\n$currentState&quot;)
<a href="#h17-2-3" id="h17-2-3" class="i">+
</a><a href="#h17-2-4" id="h17-2-4" class="i">+        val eventType = when {
</a><a href="#h17-2-5" id="h17-2-5" class="i">+            (oldState == null || currentState?.bitmojiPresent == false) &amp;&amp; currentState?.bitmojiPresent == true -&gt; TrackerEventType.CONVERSATION_ENTER
</a><a href="#h17-2-6" id="h17-2-6" class="i">+            (currentState == null || oldState?.bitmojiPresent == false) &amp;&amp; oldState?.bitmojiPresent == true -&gt; TrackerEventType.CONVERSATION_EXIT
</a><a href="#h17-2-7" id="h17-2-7" class="i">+            oldState?.typing == false &amp;&amp; currentState?.typing == true -&gt; if (currentState.speaking) TrackerEventType.STARTED_SPEAKING else TrackerEventType.STARTED_TYPING
</a><a href="#h17-2-8" id="h17-2-8" class="i">+            oldState?.typing == true &amp;&amp; (currentState == null || !currentState.typing) -&gt; if (oldState.speaking) TrackerEventType.STOPPED_SPEAKING else TrackerEventType.STOPPED_TYPING
</a><a href="#h17-2-9" id="h17-2-9" class="i">+            (oldState == null || !oldState.peeking) &amp;&amp; currentState?.peeking == true -&gt; TrackerEventType.STARTED_PEEKING
</a><a href="#h17-2-10" id="h17-2-10" class="i">+            oldState?.peeking == true &amp;&amp; (currentState == null || !currentState.peeking) -&gt; TrackerEventType.STOPPED_PEEKING
</a><a href="#h17-2-11" id="h17-2-11" class="i">+            else -&gt; null
</a><a href="#h17-2-12" id="h17-2-12" class="i">+        } ?: return
</a><a href="#h17-2-13" id="h17-2-13" class="i">+
</a><a href="#h17-2-14" id="h17-2-14" class="i">+        val feedEntry = context.database.getFeedEntryByConversationId(conversationId)
</a><a href="#h17-2-15" id="h17-2-15" class="i">+        val conversationName = feedEntry?.feedDisplayName ?: &quot;DMs&quot;
</a><a href="#h17-2-16" id="h17-2-16" class="i">+        val authorName = context.database.getFriendInfo(userId)?.mutableUsername ?: &quot;Unknown&quot;
</a><a href="#h17-2-17" id="h17-2-17" class="i">+
</a><a href="#h17-2-18" id="h17-2-18" class="i">+        context.log.verbose(&quot;$authorName $eventType in $conversationName&quot;)
</a><a href="#h17-2-19" id="h17-2-19" class="i">+
</a><a href="#h17-2-20" id="h17-2-20" class="i">+        getTrackedEvents(eventType)?.takeIf { it.canTrackOn(conversationId, userId) }?.apply {
</a><a href="#h17-2-21" id="h17-2-21" class="i">+            if (hasFlags(TrackerFlags.APP_IS_ACTIVE) &amp;&amp; context.isMainActivityPaused) return
</a><a href="#h17-2-22" id="h17-2-22" class="i">+            if (hasFlags(TrackerFlags.APP_IS_INACTIVE) &amp;&amp; !context.isMainActivityPaused) return
</a><a href="#h17-2-23" id="h17-2-23" class="i">+            if (hasFlags(TrackerFlags.IS_IN_CONVERSATION) &amp;&amp; !isInConversation(conversationId)) return
</a><a href="#h17-2-24" id="h17-2-24" class="i">+            if (hasFlags(TrackerFlags.NOTIFY)) sendInfoNotification(text = &quot;$authorName $eventType in $conversationName&quot;)
</a><a href="#h17-2-25" id="h17-2-25" class="i">+            if (hasFlags(TrackerFlags.LOG)) {
</a><a href="#h17-2-26" id="h17-2-26" class="i">+                context.bridgeClient.getMessageLogger().logTrackerEvent(
</a><a href="#h17-2-27" id="h17-2-27" class="i">+                    conversationId,
</a><a href="#h17-2-28" id="h17-2-28" class="i">+                    conversationName,
</a><a href="#h17-2-29" id="h17-2-29" class="i">+                    context.database.getConversationType(conversationId) == 1,
</a><a href="#h17-2-30" id="h17-2-30" class="i">+                    authorName,
</a><a href="#h17-2-31" id="h17-2-31" class="i">+                    userId,
</a><a href="#h17-2-32" id="h17-2-32" class="i">+                    eventType.key,
</a><a href="#h17-2-33" id="h17-2-33" class="i">+                    &quot;&quot;
</a><a href="#h17-2-34" id="h17-2-34" class="i">+                )
</a><a href="#h17-2-35" id="h17-2-35" class="i">+            }
</a><a href="#h17-2-36" id="h17-2-36" class="i">+        }
</a>     }
 
     private fun onConversationMessagingEvent(event: SessionEvent) {
         context.log.verbose(&quot;conversation messaging event\n${event.type} in ${event.conversationId} from ${event.authorUserId}&quot;)
<a href="#h17-2-41" id="h17-2-41" class="i">+        val isConversationGroup = context.database.getConversationType(event.conversationId) == 1
</a><a href="#h17-2-42" id="h17-2-42" class="i">+        val authorName = context.database.getFriendInfo(event.authorUserId)?.mutableUsername ?: &quot;Unknown&quot;
</a><a href="#h17-2-43" id="h17-2-43" class="i">+        val conversationName = context.database.getFeedEntryByConversationId(event.conversationId)?.feedDisplayName ?: &quot;DMs&quot;
</a><a href="#h17-2-44" id="h17-2-44" class="i">+
</a><a href="#h17-2-45" id="h17-2-45" class="i">+        val conversationMessage by lazy {
</a><a href="#h17-2-46" id="h17-2-46" class="i">+            (event as? SessionMessageEvent)?.serverMessageId?.let { context.database.getConversationServerMessage(event.conversationId, it) }
</a><a href="#h17-2-47" id="h17-2-47" class="i">+        }
</a><a href="#h17-2-48" id="h17-2-48" class="i">+
</a><a href="#h17-2-49" id="h17-2-49" class="i">+        val eventType = when(event.type) {
</a><a href="#h17-2-50" id="h17-2-50" class="i">+            SessionEventType.MESSAGE_READ_RECEIPTS -&gt; TrackerEventType.MESSAGE_READ
</a><a href="#h17-2-51" id="h17-2-51" class="i">+            SessionEventType.MESSAGE_DELETED -&gt; TrackerEventType.MESSAGE_DELETED
</a><a href="#h17-2-52" id="h17-2-52" class="i">+            SessionEventType.MESSAGE_REACTION_ADD -&gt; TrackerEventType.MESSAGE_REACTION_ADD
</a><a href="#h17-2-53" id="h17-2-53" class="i">+            SessionEventType.MESSAGE_REACTION_REMOVE -&gt; TrackerEventType.MESSAGE_REACTION_REMOVE
</a><a href="#h17-2-54" id="h17-2-54" class="i">+            SessionEventType.MESSAGE_SAVED -&gt; TrackerEventType.MESSAGE_SAVED
</a><a href="#h17-2-55" id="h17-2-55" class="i">+            SessionEventType.MESSAGE_UNSAVED -&gt; TrackerEventType.MESSAGE_UNSAVED
</a><a href="#h17-2-56" id="h17-2-56" class="i">+            SessionEventType.SNAP_OPENED -&gt; TrackerEventType.SNAP_OPENED
</a><a href="#h17-2-57" id="h17-2-57" class="i">+            SessionEventType.SNAP_REPLAYED -&gt; TrackerEventType.SNAP_REPLAYED
</a><a href="#h17-2-58" id="h17-2-58" class="i">+            SessionEventType.SNAP_REPLAYED_TWICE -&gt; TrackerEventType.SNAP_REPLAYED_TWICE
</a><a href="#h17-2-59" id="h17-2-59" class="i">+            SessionEventType.SNAP_SCREENSHOT -&gt; TrackerEventType.SNAP_SCREENSHOT
</a><a href="#h17-2-60" id="h17-2-60" class="i">+            SessionEventType.SNAP_SCREEN_RECORD -&gt; TrackerEventType.SNAP_SCREEN_RECORD
</a><a href="#h17-2-61" id="h17-2-61" class="i">+            else -&gt; return
</a><a href="#h17-2-62" id="h17-2-62" class="i">+        }
</a><a href="#h17-2-63" id="h17-2-63" class="i">+
</a><a href="#h17-2-64" id="h17-2-64" class="i">+        val messageEvents = arrayOf(
</a><a href="#h17-2-65" id="h17-2-65" class="i">+            TrackerEventType.MESSAGE_READ,
</a><a href="#h17-2-66" id="h17-2-66" class="i">+            TrackerEventType.MESSAGE_DELETED,
</a><a href="#h17-2-67" id="h17-2-67" class="i">+            TrackerEventType.MESSAGE_REACTION_ADD,
</a><a href="#h17-2-68" id="h17-2-68" class="i">+            TrackerEventType.MESSAGE_REACTION_REMOVE,
</a><a href="#h17-2-69" id="h17-2-69" class="i">+            TrackerEventType.MESSAGE_SAVED,
</a><a href="#h17-2-70" id="h17-2-70" class="i">+            TrackerEventType.MESSAGE_UNSAVED
</a><a href="#h17-2-71" id="h17-2-71" class="i">+        )
</a><a href="#h17-2-72" id="h17-2-72" class="i">+
</a><a href="#h17-2-73" id="h17-2-73" class="i">+        getTrackedEvents(eventType)?.takeIf { it.canTrackOn(event.conversationId, event.authorUserId) }?.apply {
</a><a href="#h17-2-74" id="h17-2-74" class="i">+            if (messageEvents.contains(eventType) &amp;&amp; conversationMessage?.senderId == context.database.myUserId) return
</a><a href="#h17-2-75" id="h17-2-75" class="i">+
</a><a href="#h17-2-76" id="h17-2-76" class="i">+            if (hasFlags(TrackerFlags.APP_IS_ACTIVE) &amp;&amp; context.isMainActivityPaused) return
</a><a href="#h17-2-77" id="h17-2-77" class="i">+            if (hasFlags(TrackerFlags.APP_IS_INACTIVE) &amp;&amp; !context.isMainActivityPaused) return
</a><a href="#h17-2-78" id="h17-2-78" class="i">+            if (hasFlags(TrackerFlags.IS_IN_CONVERSATION) &amp;&amp; !isInConversation(event.conversationId)) return
</a><a href="#h17-2-79" id="h17-2-79" class="i">+            if (hasFlags(TrackerFlags.NOTIFY)) sendInfoNotification(text = &quot;$authorName $eventType in $conversationName&quot;)
</a><a href="#h17-2-80" id="h17-2-80" class="i">+            if (hasFlags(TrackerFlags.LOG)) {
</a><a href="#h17-2-81" id="h17-2-81" class="i">+                context.bridgeClient.getMessageLogger().logTrackerEvent(
</a><a href="#h17-2-82" id="h17-2-82" class="i">+                    event.conversationId,
</a><a href="#h17-2-83" id="h17-2-83" class="i">+                    conversationName,
</a><a href="#h17-2-84" id="h17-2-84" class="i">+                    isConversationGroup,
</a><a href="#h17-2-85" id="h17-2-85" class="i">+                    authorName,
</a><a href="#h17-2-86" id="h17-2-86" class="i">+                    event.authorUserId,
</a><a href="#h17-2-87" id="h17-2-87" class="i">+                    eventType.key,
</a><a href="#h17-2-88" id="h17-2-88" class="i">+                    messageEvents.takeIf { it.contains(eventType) }?.let {
</a><a href="#h17-2-89" id="h17-2-89" class="i">+                        conversationMessage?.contentType?.let { ContentType.fromId(it) } ?.name
</a><a href="#h17-2-90" id="h17-2-90" class="i">+                    } ?: &quot;&quot;
</a><a href="#h17-2-91" id="h17-2-91" class="i">+                )
</a><a href="#h17-2-92" id="h17-2-92" class="i">+            }
</a><a href="#h17-2-93" id="h17-2-93" class="i">+        }
</a>     }
 
     private fun handlePresenceEvent(protoReader: ProtoReader) {
<a href="#h17-3" id="h17-3" class="h">@@ -66,7 +193,7 @@ class SessionEvents : Feature(&quot;Session Events&quot;, loadParams = FeatureLoadParams.I
</a>     private fun handleMessagingEvent(protoReader: ProtoReader) {
         // read receipts
         protoReader.followPath(12) {
<a href="#h17-3-3" id="h17-3-3" class="d">-            val conversationId = getByteArray(1, 1)?.toSnapUUID().toString() ?: return@followPath
</a><a href="#h17-3-4" id="h17-3-4" class="i">+            val conversationId = getByteArray(1, 1)?.toSnapUUID()?.toString() ?: return@followPath
</a> 
             followPath(7) readReceipts@{
                 val senderId = getByteArray(1, 1)?.toSnapUUID()?.toString() ?: return@readReceipts
<a href="#h17-4" id="h17-4" class="h">@@ -84,8 +211,8 @@ class SessionEvents : Feature(&quot;Session Events&quot;, loadParams = FeatureLoadParams.I
</a>         }
 
         protoReader.followPath(6, 2) {
<a href="#h17-4-3" id="h17-4-3" class="d">-            val conversationId = getByteArray(1, 1)?.toSnapUUID()?.toString() ?: return@followPath
</a><a href="#h17-4-4" id="h17-4-4" class="d">-            val senderId = getByteArray(3, 1)?.toSnapUUID()?.toString() ?: return@followPath
</a><a href="#h17-4-5" id="h17-4-5" class="i">+            val conversationId = getByteArray(3, 1)?.toSnapUUID()?.toString() ?: return@followPath
</a><a href="#h17-4-6" id="h17-4-6" class="i">+            val senderId = getByteArray(1, 1)?.toSnapUUID()?.toString() ?: return@followPath
</a>             val serverMessageId = getVarInt(2) ?: return@followPath
 
             if (contains(4)) {
<b>diff --git a/<a id="h18" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/spying/MessageLogger.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/spying/MessageLogger.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/spying/MessageLogger.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/spying/MessageLogger.kt</a></b>
<a href="#h18-0" id="h18-0" class="h">@@ -33,7 +33,7 @@ class MessageLogger : Feature(&quot;MessageLogger&quot;,
</a>         const val DELETED_MESSAGE_COLOR = 0x6Eb71c1c
     }
 
<a href="#h18-0-3" id="h18-0-3" class="d">-    private val messageLoggerInterface by lazy { context.bridgeClient.getMessageLogger() }
</a><a href="#h18-0-4" id="h18-0-4" class="i">+    private val loggerInterface by lazy { context.bridgeClient.getMessageLogger() }
</a> 
     val isEnabled get() = context.config.messaging.messageLogger.globalState == true
 
<a href="#h18-1" id="h18-1" class="h">@@ -50,7 +50,7 @@ class MessageLogger : Feature(&quot;MessageLogger&quot;,
</a>         val uniqueMessageId = makeUniqueIdentifier(conversationId, clientMessageId) ?: return
         fetchedMessages.remove(uniqueMessageId)
         deletedMessageCache.remove(uniqueMessageId)
<a href="#h18-1-3" id="h18-1-3" class="d">-        messageLoggerInterface.deleteMessage(conversationId, uniqueMessageId)
</a><a href="#h18-1-4" id="h18-1-4" class="i">+        loggerInterface.deleteMessage(conversationId, uniqueMessageId)
</a>     }
 
     fun getMessageObject(conversationId: String, clientMessageId: Long): JsonObject? {
<a href="#h18-2" id="h18-2" class="h">@@ -58,7 +58,7 @@ class MessageLogger : Feature(&quot;MessageLogger&quot;,
</a>         if (deletedMessageCache.containsKey(uniqueMessageId)) {
             return deletedMessageCache[uniqueMessageId]
         }
<a href="#h18-2-3" id="h18-2-3" class="d">-        return messageLoggerInterface.getMessage(conversationId, uniqueMessageId)?.let {
</a><a href="#h18-2-4" id="h18-2-4" class="i">+        return loggerInterface.getMessage(conversationId, uniqueMessageId)?.let {
</a>             JsonParser.parseString(it.toString(Charsets.UTF_8)).asJsonObject
         }
     }
<a href="#h18-3" id="h18-3" class="h">@@ -93,7 +93,7 @@ class MessageLogger : Feature(&quot;MessageLogger&quot;,
</a>         measureTimeMillis {
             val conversationIds = context.database.getFeedEntries(PREFETCH_FEED_COUNT).map { it.key!! }
             if (conversationIds.isEmpty()) return@measureTimeMillis
<a href="#h18-3-3" id="h18-3-3" class="d">-            fetchedMessages.addAll(messageLoggerInterface.getLoggedIds(conversationIds.toTypedArray(), PREFETCH_MESSAGE_COUNT).toList())
</a><a href="#h18-3-4" id="h18-3-4" class="i">+            fetchedMessages.addAll(loggerInterface.getLoggedIds(conversationIds.toTypedArray(), PREFETCH_MESSAGE_COUNT).toList())
</a>         }.also { context.log.verbose(&quot;Loaded ${fetchedMessages.size} cached messages in ${it}ms&quot;) }
     }
 
<a href="#h18-4" id="h18-4" class="h">@@ -124,7 +124,7 @@ class MessageLogger : Feature(&quot;MessageLogger&quot;,
</a> 
                 threadPool.execute {
                     try {
<a href="#h18-4-3" id="h18-4-3" class="d">-                        messageLoggerInterface.addMessage(conversationId, uniqueMessageIdentifier, context.gson.toJson(messageInstance).toByteArray(Charsets.UTF_8))
</a><a href="#h18-4-4" id="h18-4-4" class="i">+                        loggerInterface.addMessage(conversationId, uniqueMessageIdentifier, context.gson.toJson(messageInstance).toByteArray(Charsets.UTF_8))
</a>                     } catch (ignored: DeadObjectException) {}
                 }
 
<a href="#h18-5" id="h18-5" class="h">@@ -135,7 +135,7 @@ class MessageLogger : Feature(&quot;MessageLogger&quot;,
</a>             val deletedMessageObject: JsonObject = if (deletedMessageCache.containsKey(uniqueMessageIdentifier))
                 deletedMessageCache[uniqueMessageIdentifier]
             else {
<a href="#h18-5-3" id="h18-5-3" class="d">-                messageLoggerInterface.getMessage(conversationId, uniqueMessageIdentifier)?.let {
</a><a href="#h18-5-4" id="h18-5-4" class="i">+                loggerInterface.getMessage(conversationId, uniqueMessageIdentifier)?.let {
</a>                     JsonParser.parseString(it.toString(Charsets.UTF_8)).asJsonObject
                 }
             } ?: return@subscribe
</pre>
</div>
</body>
</html>
