<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>feat: more profile information - refactor DatabaseAccess - refactor wasInjectedView to ViewTagState - refactor applyTheme ktx - SnapEnhance - An Xposed module offering an enhanced Snapchat experience
</title>
<link rel="icon" type="image/svg+xml" href="../../logo.png"/>
<link rel="alternate icon" href="../../favicon.png"/>
<link rel="alternate" type="application/atom+xml" title="SnapEnhance Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="SnapEnhance Atom Feed (tags)" href="../tags.xml" />
<link rel="stylesheet" type="text/css" href="../../style.css" />
<link rel="stylesheet" type="text/css" href="../../fonts.css" />
</head>
<body>
<div id="head"><table><tr><td><a class="logo" href="../../"><img src="../../logo.png" alt="" width="32" height="32" /></a></td><td><strong>SnapEnhance</strong><span class="desc"> - An Xposed module offering an enhanced Snapchat experience
</span>
</td></tr></table>
<p><a href="../about.html">About</a> | <a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/LICENSE.html">License</a></p>
</div>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/a341801be37427ff60e663b2d20ed10c91a50b32.html">a341801be37427ff60e663b2d20ed10c91a50b32</a>
<b>parent</b> <a href="../commit/2c16f41fd69c12b713b3bc1cfa3a5426b798b4e1.html">2c16f41fd69c12b713b3bc1cfa3a5426b798b4e1</a>
<b>Author:</b> rhunk &lt;<a href="mailto:101876869+rhunk@users.noreply.github.com">101876869+rhunk@users.noreply.github.com</a>&gt;
<b>Date:</b>   Sun, 24 Sep 2023 00:22:03 +0200

feat: more profile information
- refactor DatabaseAccess
- refactor wasInjectedView to ViewTagState
- refactor applyTheme ktx

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">core/src/main/assets/lang/en_US.json</a></td><td> | </td><td class="num">22</td><td><span class="i">++++++++++++++++++++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">core/src/main/kotlin/me/rhunk/snapenhance/core/database/DatabaseAccess.kt</a></td><td> | </td><td class="num">143</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++</span><span class="d">--------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h2">core/src/main/kotlin/me/rhunk/snapenhance/core/database/objects/FriendInfo.kt</a></td><td> | </td><td class="num">10</td><td><span class="i">+++++++++</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h3">core/src/main/kotlin/me/rhunk/snapenhance/data/SnapEnums.kt</a></td><td> | </td><td class="num">18</td><td><span class="i">++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h4">core/src/main/kotlin/me/rhunk/snapenhance/ui/ViewAppearanceHelper.kt</a></td><td> | </td><td class="num">4</td><td><span class="i">++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h5">core/src/main/kotlin/me/rhunk/snapenhance/ui/ViewTagState.kt</a></td><td> | </td><td class="num">21</td><td><span class="i">+++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h6">core/src/main/kotlin/me/rhunk/snapenhance/ui/menu/AbstractMenu.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h7">core/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/ChatActionMenu.kt</a></td><td> | </td><td class="num">18</td><td><span class="i">++++++</span><span class="d">------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h8">core/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/FriendFeedInfoMenu.kt</a></td><td> | </td><td class="num">35</td><td><span class="i">+++++++++++++++++++++++++</span><span class="d">----------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h9">core/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/MenuViewInjector.kt</a></td><td> | </td><td class="num">7</td><td><span class="i">++++++</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h10">core/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/OperaContextActionMenu.kt</a></td><td> | </td><td class="num">4</td><td><span class="i">++</span><span class="d">--</span></td></tr>
</table></pre><pre>11 files changed, 187 insertions(+), 97 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/core/src/main/assets/lang/en_US.json.html">core/src/main/assets/lang/en_US.json</a> b/<a href="../file/core/src/main/assets/lang/en_US.json.html">core/src/main/assets/lang/en_US.json</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -672,10 +672,28 @@
</a> 
     &quot;profile_info&quot;: {
         &quot;title&quot;: &quot;Profile Info&quot;,
<a href="#h0-0-3" id="h0-0-3" class="d">-        &quot;username&quot;: &quot;Username&quot;,
</a><a href="#h0-0-4" id="h0-0-4" class="i">+        &quot;first_created_username&quot;: &quot;First Created Username&quot;,
</a><a href="#h0-0-5" id="h0-0-5" class="i">+        &quot;mutable_username&quot;: &quot;Mutable Username&quot;,
</a>         &quot;display_name&quot;: &quot;Display Name&quot;,
         &quot;added_date&quot;: &quot;Added Date&quot;,
<a href="#h0-0-8" id="h0-0-8" class="d">-        &quot;birthday&quot;: &quot;Birthday : {month} {day}&quot;
</a><a href="#h0-0-9" id="h0-0-9" class="i">+        &quot;birthday&quot;: &quot;Birthday : {month} {day}&quot;,
</a><a href="#h0-0-10" id="h0-0-10" class="i">+        &quot;friendship&quot;: &quot;Friendship&quot;,
</a><a href="#h0-0-11" id="h0-0-11" class="i">+        &quot;add_source&quot;: &quot;Add Source&quot;,
</a><a href="#h0-0-12" id="h0-0-12" class="i">+        &quot;snapchat_plus&quot;: &quot;Snapchat Plus&quot;,
</a><a href="#h0-0-13" id="h0-0-13" class="i">+        &quot;snapchat_plus_state&quot;: {
</a><a href="#h0-0-14" id="h0-0-14" class="i">+            &quot;subscribed&quot;: &quot;Subscribed&quot;,
</a><a href="#h0-0-15" id="h0-0-15" class="i">+            &quot;not_subscribed&quot;: &quot;Not Subscribed&quot;
</a><a href="#h0-0-16" id="h0-0-16" class="i">+        },
</a><a href="#h0-0-17" id="h0-0-17" class="i">+        &quot;friendship_link_type&quot;: {
</a><a href="#h0-0-18" id="h0-0-18" class="i">+            &quot;mutual&quot;: &quot;Mutual&quot;,
</a><a href="#h0-0-19" id="h0-0-19" class="i">+            &quot;outgoing&quot;: &quot;Outgoing&quot;,
</a><a href="#h0-0-20" id="h0-0-20" class="i">+            &quot;blocked&quot;: &quot;Blocked&quot;,
</a><a href="#h0-0-21" id="h0-0-21" class="i">+            &quot;deleted&quot;: &quot;Deleted&quot;,
</a><a href="#h0-0-22" id="h0-0-22" class="i">+            &quot;following&quot;: &quot;Following&quot;,
</a><a href="#h0-0-23" id="h0-0-23" class="i">+            &quot;suggested&quot;: &quot;Suggested&quot;,
</a><a href="#h0-0-24" id="h0-0-24" class="i">+            &quot;incoming&quot;: &quot;Incoming&quot;,
</a><a href="#h0-0-25" id="h0-0-25" class="i">+            &quot;incoming_follower&quot;: &quot;Incoming Follower&quot;
</a><a href="#h0-0-26" id="h0-0-26" class="i">+        }
</a>     },
 
     &quot;chat_export&quot;: {
<b>diff --git a/<a id="h1" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/database/DatabaseAccess.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/database/DatabaseAccess.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/database/DatabaseAccess.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/database/DatabaseAccess.kt</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -9,6 +9,7 @@ import me.rhunk.snapenhance.core.database.objects.FriendFeedEntry
</a> import me.rhunk.snapenhance.core.database.objects.FriendInfo
 import me.rhunk.snapenhance.core.database.objects.StoryEntry
 import me.rhunk.snapenhance.core.database.objects.UserConversationLink
<a href="#h1-0-3" id="h1-0-3" class="i">+import me.rhunk.snapenhance.core.util.ktx.getStringOrNull
</a> import me.rhunk.snapenhance.manager.Manager
 import java.io.File
 
<a href="#h1-1" id="h1-1" class="h">@@ -66,19 +67,16 @@ class DatabaseAccess(private val context: ModContext) : Manager {
</a>         table: String,
         where: String,
         args: Array&lt;String&gt;
<a href="#h1-1-3" id="h1-1-3" class="d">-    ): T? {
</a><a href="#h1-1-4" id="h1-1-4" class="d">-        val cursor = database.rawQuery(&quot;SELECT * FROM $table WHERE $where&quot;, args)
</a><a href="#h1-1-5" id="h1-1-5" class="d">-        if (!cursor.moveToFirst()) {
</a><a href="#h1-1-6" id="h1-1-6" class="d">-            cursor.close()
</a><a href="#h1-1-7" id="h1-1-7" class="i">+    ): T? = database.rawQuery(&quot;SELECT * FROM $table WHERE $where&quot;, args).use {
</a><a href="#h1-1-8" id="h1-1-8" class="i">+        if (!it.moveToFirst()) {
</a>             return null
         }
         try {
<a href="#h1-1-12" id="h1-1-12" class="d">-            obj.write(cursor)
</a><a href="#h1-1-13" id="h1-1-13" class="i">+            obj.write(it)
</a>         } catch (e: Throwable) {
             context.log.error(&quot;Failed to read database object&quot;, e)
         }
<a href="#h1-1-17" id="h1-1-17" class="d">-        cursor.close()
</a><a href="#h1-1-18" id="h1-1-18" class="d">-        return obj
</a><a href="#h1-1-19" id="h1-1-19" class="i">+        obj
</a>     }
 
     fun getFeedEntryByUserId(userId: String): FriendFeedEntry? {
<a href="#h1-2" id="h1-2" class="h">@@ -95,18 +93,14 @@ class DatabaseAccess(private val context: ModContext) : Manager {
</a> 
     val myUserId by lazy {
         safeDatabaseOperation(openArroyo()) { arroyoDatabase: SQLiteDatabase -&gt;
<a href="#h1-2-3" id="h1-2-3" class="d">-            val cursor = arroyoDatabase.rawQuery(buildString {
</a><a href="#h1-2-4" id="h1-2-4" class="i">+            arroyoDatabase.rawQuery(buildString {
</a>                 append(&quot;SELECT * FROM required_values WHERE key = &#39;USERID&#39;&quot;)
<a href="#h1-2-6" id="h1-2-6" class="d">-            }, null)
</a><a href="#h1-2-7" id="h1-2-7" class="d">-
</a><a href="#h1-2-8" id="h1-2-8" class="d">-            if (!cursor.moveToFirst()) {
</a><a href="#h1-2-9" id="h1-2-9" class="d">-                cursor.close()
</a><a href="#h1-2-10" id="h1-2-10" class="d">-                return@safeDatabaseOperation null
</a><a href="#h1-2-11" id="h1-2-11" class="i">+            }, null).use { query -&gt;
</a><a href="#h1-2-12" id="h1-2-12" class="i">+                if (!query.moveToFirst()) {
</a><a href="#h1-2-13" id="h1-2-13" class="i">+                    return@safeDatabaseOperation null
</a><a href="#h1-2-14" id="h1-2-14" class="i">+                }
</a><a href="#h1-2-15" id="h1-2-15" class="i">+                query.getStringOrNull(&quot;value&quot;)!!
</a>             }
<a href="#h1-2-17" id="h1-2-17" class="d">-
</a><a href="#h1-2-18" id="h1-2-18" class="d">-            val userId = cursor.getString(cursor.getColumnIndex(&quot;value&quot;))
</a><a href="#h1-2-19" id="h1-2-19" class="d">-            cursor.close()
</a><a href="#h1-2-20" id="h1-2-20" class="d">-            userId
</a>         }!!
     }
 
<a href="#h1-3" id="h1-3" class="h">@@ -136,20 +130,20 @@ class DatabaseAccess(private val context: ModContext) : Manager {
</a> 
     fun getFeedEntries(limit: Int): List&lt;FriendFeedEntry&gt; {
         return safeDatabaseOperation(openMain()) { database -&gt;
<a href="#h1-3-3" id="h1-3-3" class="d">-            val cursor = database.rawQuery(
</a><a href="#h1-3-4" id="h1-3-4" class="i">+            database.rawQuery(
</a>                 &quot;SELECT * FROM FriendsFeedView ORDER BY _id LIMIT ?&quot;,
                 arrayOf(limit.toString())
<a href="#h1-3-7" id="h1-3-7" class="d">-            )
</a><a href="#h1-3-8" id="h1-3-8" class="d">-            val list = mutableListOf&lt;FriendFeedEntry&gt;()
</a><a href="#h1-3-9" id="h1-3-9" class="d">-            while (cursor.moveToNext()) {
</a><a href="#h1-3-10" id="h1-3-10" class="d">-                val friendFeedEntry = FriendFeedEntry()
</a><a href="#h1-3-11" id="h1-3-11" class="d">-                try {
</a><a href="#h1-3-12" id="h1-3-12" class="d">-                    friendFeedEntry.write(cursor)
</a><a href="#h1-3-13" id="h1-3-13" class="d">-                } catch (_: Throwable) {}
</a><a href="#h1-3-14" id="h1-3-14" class="d">-                list.add(friendFeedEntry)
</a><a href="#h1-3-15" id="h1-3-15" class="i">+            ).use { query -&gt;
</a><a href="#h1-3-16" id="h1-3-16" class="i">+                val list = mutableListOf&lt;FriendFeedEntry&gt;()
</a><a href="#h1-3-17" id="h1-3-17" class="i">+                while (query.moveToNext()) {
</a><a href="#h1-3-18" id="h1-3-18" class="i">+                    val friendFeedEntry = FriendFeedEntry()
</a><a href="#h1-3-19" id="h1-3-19" class="i">+                    try {
</a><a href="#h1-3-20" id="h1-3-20" class="i">+                        friendFeedEntry.write(query)
</a><a href="#h1-3-21" id="h1-3-21" class="i">+                    } catch (_: Throwable) {}
</a><a href="#h1-3-22" id="h1-3-22" class="i">+                    list.add(friendFeedEntry)
</a><a href="#h1-3-23" id="h1-3-23" class="i">+                }
</a><a href="#h1-3-24" id="h1-3-24" class="i">+                list
</a>             }
<a href="#h1-3-26" id="h1-3-26" class="d">-            cursor.close()
</a><a href="#h1-3-27" id="h1-3-27" class="d">-            list
</a>         } ?: emptyList()
     }
 
<a href="#h1-4" id="h1-4" class="h">@@ -166,18 +160,16 @@ class DatabaseAccess(private val context: ModContext) : Manager {
</a>     }
 
     fun getConversationType(conversationId: String): Int? {
<a href="#h1-4-3" id="h1-4-3" class="d">-        return safeDatabaseOperation(openArroyo()) {
</a><a href="#h1-4-4" id="h1-4-4" class="d">-            val cursor = it.rawQuery(
</a><a href="#h1-4-5" id="h1-4-5" class="i">+        return safeDatabaseOperation(openArroyo()) { database -&gt;
</a><a href="#h1-4-6" id="h1-4-6" class="i">+            database.rawQuery(
</a>                 &quot;SELECT * FROM user_conversation WHERE client_conversation_id = ?&quot;,
                 arrayOf(conversationId)
<a href="#h1-4-9" id="h1-4-9" class="d">-            )
</a><a href="#h1-4-10" id="h1-4-10" class="d">-            if (!cursor.moveToFirst()) {
</a><a href="#h1-4-11" id="h1-4-11" class="d">-                cursor.close()
</a><a href="#h1-4-12" id="h1-4-12" class="d">-                return@safeDatabaseOperation null
</a><a href="#h1-4-13" id="h1-4-13" class="i">+            ).use { query -&gt;
</a><a href="#h1-4-14" id="h1-4-14" class="i">+                if (!query.moveToFirst()) {
</a><a href="#h1-4-15" id="h1-4-15" class="i">+                    return@safeDatabaseOperation null
</a><a href="#h1-4-16" id="h1-4-16" class="i">+                }
</a><a href="#h1-4-17" id="h1-4-17" class="i">+                query.getInt(query.getColumnIndex(&quot;conversation_type&quot;))
</a>             }
<a href="#h1-4-19" id="h1-4-19" class="d">-            val type = cursor.getInt(cursor.getColumnIndex(&quot;conversation_type&quot;))
</a><a href="#h1-4-20" id="h1-4-20" class="d">-            cursor.close()
</a><a href="#h1-4-21" id="h1-4-21" class="d">-            type
</a>         }
     }
 
<a href="#h1-5" id="h1-5" class="h">@@ -195,16 +187,19 @@ class DatabaseAccess(private val context: ModContext) : Manager {
</a> 
     fun getDMOtherParticipant(conversationId: String): String? {
         return safeDatabaseOperation(openArroyo()) { cursor -&gt;
<a href="#h1-5-3" id="h1-5-3" class="d">-            val query = cursor.rawQuery(
</a><a href="#h1-5-4" id="h1-5-4" class="i">+            cursor.rawQuery(
</a>                 &quot;SELECT * FROM user_conversation WHERE client_conversation_id = ? AND conversation_type = 0&quot;,
                 arrayOf(conversationId)
<a href="#h1-5-7" id="h1-5-7" class="d">-            )
</a><a href="#h1-5-8" id="h1-5-8" class="d">-            val participants = mutableListOf&lt;String&gt;()
</a><a href="#h1-5-9" id="h1-5-9" class="d">-            while (query.moveToNext()) {
</a><a href="#h1-5-10" id="h1-5-10" class="d">-                participants.add(query.getString(query.getColumnIndex(&quot;user_id&quot;)))
</a><a href="#h1-5-11" id="h1-5-11" class="i">+            ).use { query -&gt;
</a><a href="#h1-5-12" id="h1-5-12" class="i">+                val participants = mutableListOf&lt;String&gt;()
</a><a href="#h1-5-13" id="h1-5-13" class="i">+                if (!query.moveToFirst()) {
</a><a href="#h1-5-14" id="h1-5-14" class="i">+                    return@safeDatabaseOperation null
</a><a href="#h1-5-15" id="h1-5-15" class="i">+                }
</a><a href="#h1-5-16" id="h1-5-16" class="i">+                do {
</a><a href="#h1-5-17" id="h1-5-17" class="i">+                    participants.add(query.getString(query.getColumnIndex(&quot;user_id&quot;)))
</a><a href="#h1-5-18" id="h1-5-18" class="i">+                } while (query.moveToNext())
</a><a href="#h1-5-19" id="h1-5-19" class="i">+                participants.firstOrNull { it != myUserId }
</a>             }
<a href="#h1-5-21" id="h1-5-21" class="d">-            query.close()
</a><a href="#h1-5-22" id="h1-5-22" class="d">-            participants.firstOrNull { it != myUserId }
</a>         }
     }
 
<a href="#h1-6" id="h1-6" class="h">@@ -217,20 +212,19 @@ class DatabaseAccess(private val context: ModContext) : Manager {
</a> 
     fun getConversationParticipants(conversationId: String): List&lt;String&gt;? {
         return safeDatabaseOperation(openArroyo()) { arroyoDatabase: SQLiteDatabase -&gt;
<a href="#h1-6-3" id="h1-6-3" class="d">-            val cursor = arroyoDatabase.rawQuery(
</a><a href="#h1-6-4" id="h1-6-4" class="i">+            arroyoDatabase.rawQuery(
</a>                 &quot;SELECT * FROM user_conversation WHERE client_conversation_id = ?&quot;,
                 arrayOf(conversationId)
<a href="#h1-6-7" id="h1-6-7" class="d">-            )
</a><a href="#h1-6-8" id="h1-6-8" class="d">-            if (!cursor.moveToFirst()) {
</a><a href="#h1-6-9" id="h1-6-9" class="d">-                cursor.close()
</a><a href="#h1-6-10" id="h1-6-10" class="d">-                return@safeDatabaseOperation emptyList()
</a><a href="#h1-6-11" id="h1-6-11" class="i">+            ).use {
</a><a href="#h1-6-12" id="h1-6-12" class="i">+                if (!it.moveToFirst()) {
</a><a href="#h1-6-13" id="h1-6-13" class="i">+                    return@safeDatabaseOperation null
</a><a href="#h1-6-14" id="h1-6-14" class="i">+                }
</a><a href="#h1-6-15" id="h1-6-15" class="i">+                val participants = mutableListOf&lt;String&gt;()
</a><a href="#h1-6-16" id="h1-6-16" class="i">+                do {
</a><a href="#h1-6-17" id="h1-6-17" class="i">+                    participants.add(it.getString(it.getColumnIndex(&quot;user_id&quot;)))
</a><a href="#h1-6-18" id="h1-6-18" class="i">+                } while (it.moveToNext())
</a><a href="#h1-6-19" id="h1-6-19" class="i">+                participants
</a>             }
<a href="#h1-6-21" id="h1-6-21" class="d">-            val participants = mutableListOf&lt;String&gt;()
</a><a href="#h1-6-22" id="h1-6-22" class="d">-            do {
</a><a href="#h1-6-23" id="h1-6-23" class="d">-                participants.add(cursor.getString(cursor.getColumnIndex(&quot;user_id&quot;)))
</a><a href="#h1-6-24" id="h1-6-24" class="d">-            } while (cursor.moveToNext())
</a><a href="#h1-6-25" id="h1-6-25" class="d">-            cursor.close()
</a><a href="#h1-6-26" id="h1-6-26" class="d">-            participants
</a>         }
     }
 
<a href="#h1-7" id="h1-7" class="h">@@ -239,22 +233,35 @@ class DatabaseAccess(private val context: ModContext) : Manager {
</a>         limit: Int
     ): List&lt;ConversationMessage&gt;? {
         return safeDatabaseOperation(openArroyo()) { arroyoDatabase: SQLiteDatabase -&gt;
<a href="#h1-7-3" id="h1-7-3" class="d">-            val cursor = arroyoDatabase.rawQuery(
</a><a href="#h1-7-4" id="h1-7-4" class="i">+            arroyoDatabase.rawQuery(
</a>                 &quot;SELECT * FROM conversation_message WHERE client_conversation_id = ? ORDER BY creation_timestamp DESC LIMIT ?&quot;,
                 arrayOf(conversationId, limit.toString())
<a href="#h1-7-7" id="h1-7-7" class="d">-            )
</a><a href="#h1-7-8" id="h1-7-8" class="d">-            if (!cursor.moveToFirst()) {
</a><a href="#h1-7-9" id="h1-7-9" class="d">-                cursor.close()
</a><a href="#h1-7-10" id="h1-7-10" class="d">-                return@safeDatabaseOperation emptyList()
</a><a href="#h1-7-11" id="h1-7-11" class="i">+            ).use { query -&gt;
</a><a href="#h1-7-12" id="h1-7-12" class="i">+                if (!query.moveToFirst()) {
</a><a href="#h1-7-13" id="h1-7-13" class="i">+                    return@safeDatabaseOperation null
</a><a href="#h1-7-14" id="h1-7-14" class="i">+                }
</a><a href="#h1-7-15" id="h1-7-15" class="i">+                val messages = mutableListOf&lt;ConversationMessage&gt;()
</a><a href="#h1-7-16" id="h1-7-16" class="i">+                do {
</a><a href="#h1-7-17" id="h1-7-17" class="i">+                    val message = ConversationMessage()
</a><a href="#h1-7-18" id="h1-7-18" class="i">+                    message.write(query)
</a><a href="#h1-7-19" id="h1-7-19" class="i">+                    messages.add(message)
</a><a href="#h1-7-20" id="h1-7-20" class="i">+                } while (query.moveToNext())
</a><a href="#h1-7-21" id="h1-7-21" class="i">+                messages
</a><a href="#h1-7-22" id="h1-7-22" class="i">+            }
</a><a href="#h1-7-23" id="h1-7-23" class="i">+        }
</a><a href="#h1-7-24" id="h1-7-24" class="i">+    }
</a><a href="#h1-7-25" id="h1-7-25" class="i">+
</a><a href="#h1-7-26" id="h1-7-26" class="i">+    fun getAddSource(userId: String): String? {
</a><a href="#h1-7-27" id="h1-7-27" class="i">+        return safeDatabaseOperation(openMain()) { database -&gt;
</a><a href="#h1-7-28" id="h1-7-28" class="i">+            database.rawQuery(
</a><a href="#h1-7-29" id="h1-7-29" class="i">+                &quot;SELECT addSource FROM FriendWhoAddedMe WHERE userId = ?&quot;,
</a><a href="#h1-7-30" id="h1-7-30" class="i">+                arrayOf(userId)
</a><a href="#h1-7-31" id="h1-7-31" class="i">+            ).use {
</a><a href="#h1-7-32" id="h1-7-32" class="i">+                if (!it.moveToFirst()) {
</a><a href="#h1-7-33" id="h1-7-33" class="i">+                    return@safeDatabaseOperation null
</a><a href="#h1-7-34" id="h1-7-34" class="i">+                }
</a><a href="#h1-7-35" id="h1-7-35" class="i">+                it.getStringOrNull(&quot;addSource&quot;)
</a>             }
<a href="#h1-7-37" id="h1-7-37" class="d">-            val messages = mutableListOf&lt;ConversationMessage&gt;()
</a><a href="#h1-7-38" id="h1-7-38" class="d">-            do {
</a><a href="#h1-7-39" id="h1-7-39" class="d">-                val message = ConversationMessage()
</a><a href="#h1-7-40" id="h1-7-40" class="d">-                message.write(cursor)
</a><a href="#h1-7-41" id="h1-7-41" class="d">-                messages.add(message)
</a><a href="#h1-7-42" id="h1-7-42" class="d">-            } while (cursor.moveToNext())
</a><a href="#h1-7-43" id="h1-7-43" class="d">-            cursor.close()
</a><a href="#h1-7-44" id="h1-7-44" class="d">-            messages
</a>         }
     }
 } 
\ No newline at end of file
<b>diff --git a/<a id="h2" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/database/objects/FriendInfo.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/database/objects/FriendInfo.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/database/objects/FriendInfo.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/database/objects/FriendInfo.kt</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -30,8 +30,13 @@ data class FriendInfo(
</a>     var reverseBestFriendRanking: Int = 0,
     var isPinnedBestFriend: Int = 0,
     var plusBadgeVisibility: Int = 0,
<a href="#h2-0-3" id="h2-0-3" class="d">-    var usernameForSorting: String? = null
</a><a href="#h2-0-4" id="h2-0-4" class="i">+    var usernameForSorting: String? = null,
</a><a href="#h2-0-5" id="h2-0-5" class="i">+    var friendLinkType: Int = 0,
</a><a href="#h2-0-6" id="h2-0-6" class="i">+    var postViewEmoji: String? = null,
</a> ) : DatabaseObject, SerializableDataObject() {
<a href="#h2-0-8" id="h2-0-8" class="i">+    val mutableUsername get() = username?.split(&quot;|&quot;)?.last()
</a><a href="#h2-0-9" id="h2-0-9" class="i">+    val firstCreatedUsername get() = username?.split(&quot;|&quot;)?.first()
</a><a href="#h2-0-10" id="h2-0-10" class="i">+
</a>     @SuppressLint(&quot;Range&quot;)
     override fun write(cursor: Cursor) {
         with(cursor) {
<a href="#h2-1" id="h2-1" class="h">@@ -55,10 +60,13 @@ data class FriendInfo(
</a>             streakExpirationTimestamp = getLong(&quot;streakExpiration&quot;)
             reverseBestFriendRanking = getInteger(&quot;reverseBestFriendRanking&quot;)
             usernameForSorting = getStringOrNull(&quot;usernameForSorting&quot;)
<a href="#h2-1-3" id="h2-1-3" class="i">+            friendLinkType = getInteger(&quot;friendLinkType&quot;)
</a><a href="#h2-1-4" id="h2-1-4" class="i">+            postViewEmoji = getStringOrNull(&quot;postViewEmoji&quot;)
</a>             if (getColumnIndex(&quot;isPinnedBestFriend&quot;) != -1) isPinnedBestFriend =
                 getInteger(&quot;isPinnedBestFriend&quot;)
             if (getColumnIndex(&quot;plusBadgeVisibility&quot;) != -1) plusBadgeVisibility =
                 getInteger(&quot;plusBadgeVisibility&quot;)
         }
     }
<a href="#h2-1-11" id="h2-1-11" class="i">+
</a> }
<b>diff --git a/<a id="h3" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/data/SnapEnums.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/data/SnapEnums.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/data/SnapEnums.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/data/SnapEnums.kt</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -133,3 +133,20 @@ enum class MetricsMessageType {
</a> enum class MediaReferenceType {
     UNASSIGNED, OVERLAY, IMAGE, VIDEO, ASSET_BUNDLE, AUDIO, ANIMATED_IMAGE, FONT, WEB_VIEW_CONTENT, VIDEO_NO_AUDIO
 }
<a href="#h3-0-3" id="h3-0-3" class="i">+
</a><a href="#h3-0-4" id="h3-0-4" class="i">+enum class FriendLinkType(val value: Int, val shortName: String) {
</a><a href="#h3-0-5" id="h3-0-5" class="i">+    MUTUAL(0, &quot;mutual&quot;),
</a><a href="#h3-0-6" id="h3-0-6" class="i">+    OUTGOING(1, &quot;outgoing&quot;),
</a><a href="#h3-0-7" id="h3-0-7" class="i">+    BLOCKED(2, &quot;blocked&quot;),
</a><a href="#h3-0-8" id="h3-0-8" class="i">+    DELETED(3, &quot;deleted&quot;),
</a><a href="#h3-0-9" id="h3-0-9" class="i">+    FOLLOWING(4, &quot;following&quot;),
</a><a href="#h3-0-10" id="h3-0-10" class="i">+    SUGGESTED(5, &quot;suggested&quot;),
</a><a href="#h3-0-11" id="h3-0-11" class="i">+    INCOMING(6, &quot;incoming&quot;),
</a><a href="#h3-0-12" id="h3-0-12" class="i">+    INCOMING_FOLLOWER(7, &quot;incoming_follower&quot;);
</a><a href="#h3-0-13" id="h3-0-13" class="i">+
</a><a href="#h3-0-14" id="h3-0-14" class="i">+    companion object {
</a><a href="#h3-0-15" id="h3-0-15" class="i">+        fun fromValue(value: Int): FriendLinkType {
</a><a href="#h3-0-16" id="h3-0-16" class="i">+            return values().firstOrNull { it.value == value } ?: MUTUAL
</a><a href="#h3-0-17" id="h3-0-17" class="i">+        }
</a><a href="#h3-0-18" id="h3-0-18" class="i">+    }
</a><a href="#h3-0-19" id="h3-0-19" class="i">+}</a><a href="#h3-0-20" id="h3-0-20" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h4" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/ui/ViewAppearanceHelper.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/ui/ViewAppearanceHelper.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/ui/ViewAppearanceHelper.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/ui/ViewAppearanceHelper.kt</a></b>
<a href="#h4-0" id="h4-0" class="h">@@ -15,6 +15,10 @@ import android.widget.Switch
</a> import android.widget.TextView
 import me.rhunk.snapenhance.Constants
 
<a href="#h4-0-3" id="h4-0-3" class="i">+fun View.applyTheme(componentWidth: Int? = null, hasRadius: Boolean = false, isAmoled: Boolean = true) {
</a><a href="#h4-0-4" id="h4-0-4" class="i">+    ViewAppearanceHelper.applyTheme(this, componentWidth, hasRadius, isAmoled)
</a><a href="#h4-0-5" id="h4-0-5" class="i">+}
</a><a href="#h4-0-6" id="h4-0-6" class="i">+
</a> object ViewAppearanceHelper {
     @SuppressLint(&quot;UseSwitchCompatOrMaterialCode&quot;, &quot;RtlHardcoded&quot;, &quot;DiscouragedApi&quot;,
         &quot;ClickableViewAccessibility&quot;
<b>diff --git a/<a id="h5" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/ui/ViewTagState.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/ui/ViewTagState.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/ui/ViewTagState.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/ui/ViewTagState.kt</a></b>
<a href="#h5-0" id="h5-0" class="h">@@ -0,0 +1,20 @@
</a><a href="#h5-0-0" id="h5-0-0" class="i">+package me.rhunk.snapenhance.ui
</a><a href="#h5-0-1" id="h5-0-1" class="i">+
</a><a href="#h5-0-2" id="h5-0-2" class="i">+import android.view.View
</a><a href="#h5-0-3" id="h5-0-3" class="i">+import kotlin.random.Random
</a><a href="#h5-0-4" id="h5-0-4" class="i">+
</a><a href="#h5-0-5" id="h5-0-5" class="i">+class ViewTagState {
</a><a href="#h5-0-6" id="h5-0-6" class="i">+    private val tag = Random.nextInt(0x7000000, 0x7FFFFFFF)
</a><a href="#h5-0-7" id="h5-0-7" class="i">+
</a><a href="#h5-0-8" id="h5-0-8" class="i">+    operator fun get(view: View) = hasState(view)
</a><a href="#h5-0-9" id="h5-0-9" class="i">+
</a><a href="#h5-0-10" id="h5-0-10" class="i">+    private fun hasState(view: View): Boolean {
</a><a href="#h5-0-11" id="h5-0-11" class="i">+        if (view.getTag(tag) != null) return true
</a><a href="#h5-0-12" id="h5-0-12" class="i">+        view.setTag(tag, true)
</a><a href="#h5-0-13" id="h5-0-13" class="i">+        return false
</a><a href="#h5-0-14" id="h5-0-14" class="i">+    }
</a><a href="#h5-0-15" id="h5-0-15" class="i">+
</a><a href="#h5-0-16" id="h5-0-16" class="i">+    fun removeState(view: View) {
</a><a href="#h5-0-17" id="h5-0-17" class="i">+        view.setTag(tag, null)
</a><a href="#h5-0-18" id="h5-0-18" class="i">+    }
</a><a href="#h5-0-19" id="h5-0-19" class="i">+}</a><a href="#h5-0-20" id="h5-0-20" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h6" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/ui/menu/AbstractMenu.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/ui/menu/AbstractMenu.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/ui/menu/AbstractMenu.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/ui/menu/AbstractMenu.kt</a></b>
<a href="#h6-0" id="h6-0" class="h">@@ -2,7 +2,7 @@ package me.rhunk.snapenhance.ui.menu
</a> 
 import me.rhunk.snapenhance.ModContext
 
<a href="#h6-0-3" id="h6-0-3" class="d">-abstract class AbstractMenu() {
</a><a href="#h6-0-4" id="h6-0-4" class="i">+abstract class AbstractMenu {
</a>     lateinit var context: ModContext
 
     open fun init() {}
<b>diff --git a/<a id="h7" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/ChatActionMenu.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/ChatActionMenu.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/ChatActionMenu.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/ChatActionMenu.kt</a></b>
<a href="#h7-0" id="h7-0" class="h">@@ -12,23 +12,18 @@ import me.rhunk.snapenhance.Constants
</a> import me.rhunk.snapenhance.features.impl.Messaging
 import me.rhunk.snapenhance.features.impl.downloader.MediaDownloader
 import me.rhunk.snapenhance.features.impl.spying.MessageLogger
<a href="#h7-0-3" id="h7-0-3" class="d">-import me.rhunk.snapenhance.ui.ViewAppearanceHelper
</a><a href="#h7-0-4" id="h7-0-4" class="i">+import me.rhunk.snapenhance.ui.ViewTagState
</a><a href="#h7-0-5" id="h7-0-5" class="i">+import me.rhunk.snapenhance.ui.applyTheme
</a> import me.rhunk.snapenhance.ui.menu.AbstractMenu
 
 
 class ChatActionMenu : AbstractMenu() {
<a href="#h7-0-10" id="h7-0-10" class="d">-    private val viewInjectedTag = 0x7FFFFF02
</a><a href="#h7-0-11" id="h7-0-11" class="d">-
</a><a href="#h7-0-12" id="h7-0-12" class="d">-    private fun wasInjectedView(view: View): Boolean {
</a><a href="#h7-0-13" id="h7-0-13" class="d">-        if (view.getTag(viewInjectedTag) != null) return true
</a><a href="#h7-0-14" id="h7-0-14" class="d">-        view.setTag(viewInjectedTag, true)
</a><a href="#h7-0-15" id="h7-0-15" class="d">-        return false
</a><a href="#h7-0-16" id="h7-0-16" class="d">-    }
</a><a href="#h7-0-17" id="h7-0-17" class="i">+    private val viewTagState = ViewTagState()
</a> 
     @SuppressLint(&quot;SetTextI18n&quot;, &quot;DiscouragedApi&quot;)
     fun inject(viewGroup: ViewGroup) {
         val parent = viewGroup.parent.parent as ViewGroup
<a href="#h7-0-22" id="h7-0-22" class="d">-        if (wasInjectedView(parent)) return
</a><a href="#h7-0-23" id="h7-0-23" class="i">+        if (viewTagState[parent]) return
</a>         //close the action menu using a touch event
         val closeActionMenu = {
             viewGroup.dispatchTouchEvent(
<a href="#h7-1" id="h7-1" class="h">@@ -73,7 +68,7 @@ class ChatActionMenu : AbstractMenu() {
</a>                 ViewGroup.LayoutParams.MATCH_PARENT,
                 ViewGroup.LayoutParams.WRAP_CONTENT
             ).apply {
<a href="#h7-1-3" id="h7-1-3" class="d">-                ViewAppearanceHelper.applyTheme(this@layout, parent.width, true)
</a><a href="#h7-1-4" id="h7-1-4" class="i">+                applyTheme(parent.width, true)
</a>                 setMargins(chatActionMenuItemMargin, 0, chatActionMenuItemMargin, defaultGap)
             }
         }
<a href="#h7-2" id="h7-2" class="h">@@ -91,9 +86,8 @@ class ChatActionMenu : AbstractMenu() {
</a>                 })
             }
 
<a href="#h7-2-3" id="h7-2-3" class="d">-            ViewAppearanceHelper.applyTheme(button, parent.width, true)
</a><a href="#h7-2-4" id="h7-2-4" class="d">-
</a>             with(button) {
<a href="#h7-2-6" id="h7-2-6" class="i">+                applyTheme(parent.width, true)
</a>                 layoutParams = MarginLayoutParams(
                     ViewGroup.LayoutParams.MATCH_PARENT,
                     ViewGroup.LayoutParams.WRAP_CONTENT
<b>diff --git a/<a id="h8" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/FriendFeedInfoMenu.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/FriendFeedInfoMenu.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/FriendFeedInfoMenu.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/FriendFeedInfoMenu.kt</a></b>
<a href="#h8-0" id="h8-0" class="h">@@ -16,12 +16,14 @@ import me.rhunk.snapenhance.core.database.objects.FriendInfo
</a> import me.rhunk.snapenhance.core.database.objects.UserConversationLink
 import me.rhunk.snapenhance.core.util.snap.BitmojiSelfie
 import me.rhunk.snapenhance.data.ContentType
<a href="#h8-0-3" id="h8-0-3" class="i">+import me.rhunk.snapenhance.data.FriendLinkType
</a> import me.rhunk.snapenhance.features.MessagingRuleFeature
 import me.rhunk.snapenhance.features.impl.Messaging
 import me.rhunk.snapenhance.features.impl.downloader.MediaDownloader
 import me.rhunk.snapenhance.features.impl.spying.StealthMode
 import me.rhunk.snapenhance.features.impl.tweaks.AutoSave
 import me.rhunk.snapenhance.ui.ViewAppearanceHelper
<a href="#h8-0-10" id="h8-0-10" class="i">+import me.rhunk.snapenhance.ui.applyTheme
</a> import me.rhunk.snapenhance.ui.menu.AbstractMenu
 import java.net.HttpURLConnection
 import java.net.URL
<a href="#h8-1" id="h8-1" class="h">@@ -59,6 +61,8 @@ class FriendFeedInfoMenu : AbstractMenu() {
</a>             context.log.error(&quot;Error loading bitmoji selfie&quot;, e)
         }
         val finalIcon = icon
<a href="#h8-1-3" id="h8-1-3" class="i">+        val translation = context.translation.getCategory(&quot;profile_info&quot;)
</a><a href="#h8-1-4" id="h8-1-4" class="i">+
</a>         context.runOnUiThread {
             val addedTimestamp: Long = profile.addedTimestamp.coerceAtLeast(profile.reverseAddedTimestamp)
             val builder = ViewAppearanceHelper.newAlertDialogBuilder(context.mainActivity)
<a href="#h8-2" id="h8-2" class="h">@@ -67,11 +71,13 @@ class FriendFeedInfoMenu : AbstractMenu() {
</a> 
             val birthday = Calendar.getInstance()
             birthday[Calendar.MONTH] = (profile.birthday shr 32).toInt() - 1
<a href="#h8-2-3" id="h8-2-3" class="d">-            val message: String = &quot;&quot;&quot;
</a><a href="#h8-2-4" id="h8-2-4" class="d">-                ${context.translation[&quot;profile_info.username&quot;]}: ${profile.username}
</a><a href="#h8-2-5" id="h8-2-5" class="d">-                ${context.translation[&quot;profile_info.display_name&quot;]}: ${profile.displayName}
</a><a href="#h8-2-6" id="h8-2-6" class="d">-                ${context.translation[&quot;profile_info.added_date&quot;]}: ${formatDate(addedTimestamp)}
</a><a href="#h8-2-7" id="h8-2-7" class="d">-                ${birthday.getDisplayName(
</a><a href="#h8-2-8" id="h8-2-8" class="i">+
</a><a href="#h8-2-9" id="h8-2-9" class="i">+            builder.setMessage(mapOf(
</a><a href="#h8-2-10" id="h8-2-10" class="i">+                translation[&quot;first_created_username&quot;] to profile.firstCreatedUsername,
</a><a href="#h8-2-11" id="h8-2-11" class="i">+                translation[&quot;mutable_username&quot;] to profile.mutableUsername,
</a><a href="#h8-2-12" id="h8-2-12" class="i">+                translation[&quot;display_name&quot;] to profile.displayName,
</a><a href="#h8-2-13" id="h8-2-13" class="i">+                translation[&quot;added_date&quot;] to formatDate(addedTimestamp),
</a><a href="#h8-2-14" id="h8-2-14" class="i">+                null to birthday.getDisplayName(
</a>                     Calendar.MONTH,
                     Calendar.LONG,
                     context.translation.loadedLocale
<a href="#h8-3" id="h8-3" class="h">@@ -79,9 +85,18 @@ class FriendFeedInfoMenu : AbstractMenu() {
</a>                     context.translation.format(&quot;profile_info.birthday&quot;,
                         &quot;month&quot; to it,
                         &quot;day&quot; to profile.birthday.toInt().toString())
<a href="#h8-3-3" id="h8-3-3" class="d">-                }}
</a><a href="#h8-3-4" id="h8-3-4" class="d">-            &quot;&quot;&quot;.trimIndent()
</a><a href="#h8-3-5" id="h8-3-5" class="d">-            builder.setMessage(message)
</a><a href="#h8-3-6" id="h8-3-6" class="i">+                },
</a><a href="#h8-3-7" id="h8-3-7" class="i">+                translation[&quot;friendship&quot;] to run {
</a><a href="#h8-3-8" id="h8-3-8" class="i">+                    translation.getCategory(&quot;friendship_link_type&quot;)[FriendLinkType.fromValue(profile.friendLinkType).shortName]
</a><a href="#h8-3-9" id="h8-3-9" class="i">+                },
</a><a href="#h8-3-10" id="h8-3-10" class="i">+                translation[&quot;add_source&quot;] to context.database.getAddSource(profile.userId!!)?.takeIf { it.isNotEmpty() },
</a><a href="#h8-3-11" id="h8-3-11" class="i">+                translation[&quot;snapchat_plus&quot;] to run {
</a><a href="#h8-3-12" id="h8-3-12" class="i">+                    translation.getCategory(&quot;snapchat_plus_state&quot;)[if (profile.postViewEmoji != null) &quot;subscribed&quot; else &quot;not_subscribed&quot;]
</a><a href="#h8-3-13" id="h8-3-13" class="i">+                }
</a><a href="#h8-3-14" id="h8-3-14" class="i">+            ).filterValues { it != null }.map {
</a><a href="#h8-3-15" id="h8-3-15" class="i">+                line -&gt; &quot;${line.key?.let { &quot;$it: &quot; } ?: &quot;&quot;}${line.value}&quot;
</a><a href="#h8-3-16" id="h8-3-16" class="i">+            }.joinToString(&quot;\n&quot;))
</a><a href="#h8-3-17" id="h8-3-17" class="i">+
</a>             builder.setPositiveButton(
                 &quot;OK&quot;
             ) { dialog: DialogInterface, _: Int -&gt; dialog.dismiss() }
<a href="#h8-4" id="h8-4" class="h">@@ -198,7 +213,7 @@ class FriendFeedInfoMenu : AbstractMenu() {
</a>         val switch = Switch(context.androidContext)
         switch.text = context.translation[text]
         switch.isChecked = isChecked()
<a href="#h8-4-3" id="h8-4-3" class="d">-        ViewAppearanceHelper.applyTheme(switch)
</a><a href="#h8-4-4" id="h8-4-4" class="i">+        switch.applyTheme()
</a>         switch.setOnCheckedChangeListener { _: CompoundButton?, checked: Boolean -&gt;
             toggle(checked)
         }
<a href="#h8-5" id="h8-5" class="h">@@ -218,7 +233,7 @@ class FriendFeedInfoMenu : AbstractMenu() {
</a> 
         val previewButton = Button(viewModel.context).apply {
             text = modContext.translation[&quot;friend_menu_option.preview&quot;]
<a href="#h8-5-3" id="h8-5-3" class="d">-            ViewAppearanceHelper.applyTheme(this, viewModel.width)
</a><a href="#h8-5-4" id="h8-5-4" class="i">+            applyTheme(viewModel.width)
</a>             setOnClickListener {
                 showPreview(
                     targetUser,
<b>diff --git a/<a id="h9" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/MenuViewInjector.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/MenuViewInjector.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/MenuViewInjector.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/MenuViewInjector.kt</a></b>
<a href="#h9-0" id="h9-0" class="h">@@ -11,10 +11,13 @@ import me.rhunk.snapenhance.core.event.events.impl.AddViewEvent
</a> import me.rhunk.snapenhance.features.Feature
 import me.rhunk.snapenhance.features.FeatureLoadParams
 import me.rhunk.snapenhance.features.impl.Messaging
<a href="#h9-0-3" id="h9-0-3" class="i">+import me.rhunk.snapenhance.ui.ViewTagState
</a> import java.lang.reflect.Modifier
 
 @SuppressLint(&quot;DiscouragedApi&quot;)
 class MenuViewInjector : Feature(&quot;MenuViewInjector&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_ASYNC) {
<a href="#h9-0-8" id="h9-0-8" class="i">+    private val viewTagState = ViewTagState()
</a><a href="#h9-0-9" id="h9-0-9" class="i">+
</a>     private val friendFeedInfoMenu = FriendFeedInfoMenu()
     private val operaContextActionMenu = OperaContextActionMenu()
     private val chatActionMenu = ChatActionMenu()
<a href="#h9-1" id="h9-1" class="h">@@ -114,15 +117,17 @@ class MenuViewInjector : Feature(&quot;MenuViewInjector&quot;, loadParams = FeatureLoadPar
</a>                     viewGroup.addOnAttachStateChangeListener(object: View.OnAttachStateChangeListener {
                         override fun onViewAttachedToWindow(v: View) {}
                         override fun onViewDetachedFromWindow(v: View) {
<a href="#h9-1-3" id="h9-1-3" class="d">-                            //context.config.writeConfig()
</a><a href="#h9-1-4" id="h9-1-4" class="i">+                            viewTagState.removeState(viewGroup)
</a>                         }
                     })
<a href="#h9-1-7" id="h9-1-7" class="i">+                    viewTagState[viewGroup]
</a>                     return@subscribe
                 }
                 if (messaging.lastFetchConversationUUID == null || messaging.lastFetchConversationUserUUID == null) return@subscribe
 
                 //filter by the slot index
                 if (viewGroup.getChildCount() != context.config.userInterface.friendFeedMenuPosition.get()) return@subscribe
<a href="#h9-1-14" id="h9-1-14" class="i">+                if (viewTagState[viewGroup]) return@subscribe
</a>                 friendFeedInfoMenu.inject(viewGroup, originalAddView)
             }
         }
<b>diff --git a/<a id="h10" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/OperaContextActionMenu.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/OperaContextActionMenu.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/OperaContextActionMenu.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/OperaContextActionMenu.kt</a></b>
<a href="#h10-0" id="h10-0" class="h">@@ -9,7 +9,7 @@ import android.widget.LinearLayout
</a> import android.widget.ScrollView
 import me.rhunk.snapenhance.Constants
 import me.rhunk.snapenhance.features.impl.downloader.MediaDownloader
<a href="#h10-0-3" id="h10-0-3" class="d">-import me.rhunk.snapenhance.ui.ViewAppearanceHelper.applyTheme
</a><a href="#h10-0-4" id="h10-0-4" class="i">+import me.rhunk.snapenhance.ui.applyTheme
</a> import me.rhunk.snapenhance.ui.menu.AbstractMenu
 
 @SuppressLint(&quot;DiscouragedApi&quot;)
<a href="#h10-1" id="h10-1" class="h">@@ -71,7 +71,7 @@ class OperaContextActionMenu : AbstractMenu() {
</a>             val button = Button(childView.getContext())
             button.text = context.translation[&quot;opera_context_menu.download&quot;]
             button.setOnClickListener { context.feature(MediaDownloader::class).downloadLastOperaMediaAsync() }
<a href="#h10-1-3" id="h10-1-3" class="d">-            applyTheme(button, isAmoled = false)
</a><a href="#h10-1-4" id="h10-1-4" class="i">+            button.applyTheme(isAmoled = false)
</a>             linearLayout.addView(button)
             (childView as ViewGroup).addView(linearLayout, 0)
         } catch (e: Throwable) {
</pre>
</div>
</body>
</html>
