<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>refactor: common submodule - organize import - remove unused xml - SnapEnhance - An Xposed module offering an enhanced Snapchat experience
</title>
<link rel="icon" type="image/svg+xml" href="../../logo.png"/>
<link rel="alternate icon" href="../../favicon.png"/>
<link rel="alternate" type="application/atom+xml" title="SnapEnhance Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="SnapEnhance Atom Feed (tags)" href="../tags.xml" />
<link rel="stylesheet" type="text/css" href="../../style.css" />
<link rel="stylesheet" type="text/css" href="../../fonts.css" />
</head>
<body>
<div id="head"><table><tr><td><a class="logo" href="../../"><img src="../../logo.png" alt="" width="32" height="32" /></a></td><td><strong>SnapEnhance</strong><span class="desc"> - An Xposed module offering an enhanced Snapchat experience
</span>
</td></tr></table>
<p><a href="../about.html">About</a> | <a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/LICENSE.html">License</a></p>
</div>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/13d6ae75542e0e29c41e8ba0c35d913f5ecde95c.html">13d6ae75542e0e29c41e8ba0c35d913f5ecde95c</a>
<b>parent</b> <a href="../commit/00a33b9ce63d8017caf4d742f5df42faf2e225bc.html">00a33b9ce63d8017caf4d742f5df42faf2e225bc</a>
<b>Author:</b> rhunk &lt;<a href="mailto:101876869+rhunk@users.noreply.github.com">101876869+rhunk@users.noreply.github.com</a>&gt;
<b>Date:</b>   Wed, 11 Oct 2023 01:25:27 +0200

refactor: common submodule
- organize import
- remove unused xml

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">app/build.gradle.kts</a></td><td> | </td><td class="num">1</td><td><span class="i">+</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">app/src/main/AndroidManifest.xml</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h2">app/src/main/kotlin/me/rhunk/snapenhance/LogManager.kt</a></td><td> | </td><td class="num">6</td><td><span class="i">+++</span><span class="d">---</span></td></tr>
<tr><td class="M">M</td><td><a href="#h3">app/src/main/kotlin/me/rhunk/snapenhance/RemoteSideContext.kt</a></td><td> | </td><td class="num">8</td><td><span class="i">++++</span><span class="d">----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h4">app/src/main/kotlin/me/rhunk/snapenhance/bridge/BridgeService.kt</a></td><td> | </td><td class="num">20</td><td><span class="i">++++++++++</span><span class="d">----------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h5">app/src/main/kotlin/me/rhunk/snapenhance/bridge/ForceStartActivity.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h6">app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadObject.kt</a></td><td> | </td><td class="num">4</td><td><span class="i">++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h7">app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadProcessor.kt</a></td><td> | </td><td class="num">16</td><td><span class="i">++++++++</span><span class="d">--------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h8">app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadTaskManager.kt</a></td><td> | </td><td class="num">15</td><td><span class="i">++++++++</span><span class="d">-------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h9">app/src/main/kotlin/me/rhunk/snapenhance/download/FFMpegProcessor.kt</a></td><td> | </td><td class="num">7</td><td><span class="i">+++</span><span class="d">----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h10">app/src/main/kotlin/me/rhunk/snapenhance/messaging/ModDatabase.kt</a></td><td> | </td><td class="num">32</td><td><span class="i">++++++++++++++++++</span><span class="d">--------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h11">app/src/main/kotlin/me/rhunk/snapenhance/messaging/StreaksReminder.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h12">app/src/main/kotlin/me/rhunk/snapenhance/scripting/RemoteScriptManager.kt</a></td><td> | </td><td class="num">5</td><td><span class="i">+++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h13">app/src/main/kotlin/me/rhunk/snapenhance/scripting/impl/RemoteManagerIPC.kt</a></td><td> | </td><td class="num">8</td><td><span class="i">++++</span><span class="d">----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h14">app/src/main/kotlin/me/rhunk/snapenhance/scripting/impl/ui/InterfaceManager.kt</a></td><td> | </td><td class="num">4</td><td><span class="i">++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h15">app/src/main/kotlin/me/rhunk/snapenhance/ui/MapActivity.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h16">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/data/Updater.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h17">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/downloads/DownloadsSection.kt</a></td><td> | </td><td class="num">4</td><td><span class="i">++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h18">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/features/FeaturesSection.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h19">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/home/HomeSubSection.kt</a></td><td> | </td><td class="num">4</td><td><span class="i">++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h20">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/home/SettingsSection.kt</a></td><td> | </td><td class="num">9</td><td><span class="i">++++</span><span class="d">-----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h21">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/scripting/ScriptInterface.kt</a></td><td> | </td><td class="num">4</td><td><span class="i">++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h22">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/scripting/ScriptsSection.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h23">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/social/AddFriendDialog.kt</a></td><td> | </td><td class="num">12</td><td><span class="i">++++++</span><span class="d">------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h24">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/social/ScopeContent.kt</a></td><td> | </td><td class="num">6</td><td><span class="i">+++</span><span class="d">---</span></td></tr>
<tr><td class="M">M</td><td><a href="#h25">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/social/SocialSection.kt</a></td><td> | </td><td class="num">8</td><td><span class="i">++++</span><span class="d">----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h26">app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/screens/impl/PickLanguageScreen.kt</a></td><td> | </td><td class="num">8</td><td><span class="i">++++++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h27">app/src/main/kotlin/me/rhunk/snapenhance/ui/util/ActivityLauncherHelper.kt</a></td><td> | </td><td class="num">6</td><td><span class="i">+++</span><span class="d">---</span></td></tr>
<tr><td class="M">M</td><td><a href="#h28">app/src/main/kotlin/me/rhunk/snapenhance/ui/util/AlertDialogs.kt</a></td><td> | </td><td class="num">6</td><td><span class="i">+++</span><span class="d">---</span></td></tr>
<tr><td class="A">A</td><td><a href="#h29">app/src/main/res/font/avenir_next_medium.ttf</a></td><td> | </td><td class="num">0</td><td><span class="i"></span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h30">app/src/main/res/layout/map.xml</a></td><td> | </td><td class="num">44</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h31">app/src/main/res/layout/precise_location_dialog.xml</a></td><td> | </td><td class="num">29</td><td><span class="i">+++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h32">app/src/main/res/values/colors.xml</a></td><td> | </td><td class="num">7</td><td><span class="i">+++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h33">app/src/main/res/values/launcher_icon_background.xml</a></td><td> | </td><td class="num">5</td><td><span class="i">+++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h34">app/src/main/res/values/strings.xml</a></td><td> | </td><td class="num">4</td><td><span class="i">++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h35">app/src/main/res/values/themes.xml</a></td><td> | </td><td class="num">13</td><td><span class="i">+++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h36">build.gradle.kts</a></td><td> | </td><td class="num">7</td><td><span class="i">+++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h37">common/.gitignore</a></td><td> | </td><td class="num">2</td><td><span class="i">++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h38">common/build.gradle.kts</a></td><td> | </td><td class="num">38</td><td><span class="i">++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="R">R</td><td><a href="#h39">core/src/main/aidl/me/rhunk/snapenhance/bridge/BridgeInterface.aidl -&gt; common/src/main/aidl/me/rhunk/snapenhance/bridge/BridgeInterface.aidl</a></td><td> | </td><td class="num">0</td><td><span class="i"></span><span class="d"></span></td></tr>
<tr><td class="R">R</td><td><a href="#h40">core/src/main/aidl/me/rhunk/snapenhance/bridge/ConfigStateListener.aidl -&gt; common/src/main/aidl/me/rhunk/snapenhance/bridge/ConfigStateListener.aidl</a></td><td> | </td><td class="num">0</td><td><span class="i"></span><span class="d"></span></td></tr>
<tr><td class="R">R</td><td><a href="#h41">core/src/main/aidl/me/rhunk/snapenhance/bridge/DownloadCallback.aidl -&gt; common/src/main/aidl/me/rhunk/snapenhance/bridge/DownloadCallback.aidl</a></td><td> | </td><td class="num">0</td><td><span class="i"></span><span class="d"></span></td></tr>
<tr><td class="R">R</td><td><a href="#h42">core/src/main/aidl/me/rhunk/snapenhance/bridge/MessageLoggerInterface.aidl -&gt; common/src/main/aidl/me/rhunk/snapenhance/bridge/MessageLoggerInterface.aidl</a></td><td> | </td><td class="num">0</td><td><span class="i"></span><span class="d"></span></td></tr>
<tr><td class="R">R</td><td><a href="#h43">core/src/main/aidl/me/rhunk/snapenhance/bridge/SyncCallback.aidl -&gt; common/src/main/aidl/me/rhunk/snapenhance/bridge/SyncCallback.aidl</a></td><td> | </td><td class="num">0</td><td><span class="i"></span><span class="d"></span></td></tr>
<tr><td class="R">R</td><td><a href="#h44">core/src/main/aidl/me/rhunk/snapenhance/bridge/e2ee/E2eeInterface.aidl -&gt; common/src/main/aidl/me/rhunk/snapenhance/bridge/e2ee/E2eeInterface.aidl</a></td><td> | </td><td class="num">0</td><td><span class="i"></span><span class="d"></span></td></tr>
<tr><td class="R">R</td><td><a href="#h45">core/src/main/aidl/me/rhunk/snapenhance/bridge/e2ee/EncryptionResult.aidl -&gt; common/src/main/aidl/me/rhunk/snapenhance/bridge/e2ee/EncryptionResult.aidl</a></td><td> | </td><td class="num">0</td><td><span class="i"></span><span class="d"></span></td></tr>
<tr><td class="R">R</td><td><a href="#h46">core/src/main/aidl/me/rhunk/snapenhance/bridge/scripting/IPCListener.aidl -&gt; common/src/main/aidl/me/rhunk/snapenhance/bridge/scripting/IPCListener.aidl</a></td><td> | </td><td class="num">0</td><td><span class="i"></span><span class="d"></span></td></tr>
<tr><td class="R">R</td><td><a href="#h47">core/src/main/aidl/me/rhunk/snapenhance/bridge/scripting/IScripting.aidl -&gt; common/src/main/aidl/me/rhunk/snapenhance/bridge/scripting/IScripting.aidl</a></td><td> | </td><td class="num">0</td><td><span class="i"></span><span class="d"></span></td></tr>
<tr><td class="R">R</td><td><a href="#h48">core/src/main/assets/lang/ar_SA.json -&gt; common/src/main/assets/lang/ar_SA.json</a></td><td> | </td><td class="num">0</td><td><span class="i"></span><span class="d"></span></td></tr>
<tr><td class="R">R</td><td><a href="#h49">core/src/main/assets/lang/de_DE.json -&gt; common/src/main/assets/lang/de_DE.json</a></td><td> | </td><td class="num">0</td><td><span class="i"></span><span class="d"></span></td></tr>
<tr><td class="R">R</td><td><a href="#h50">core/src/main/assets/lang/en_US.json -&gt; common/src/main/assets/lang/en_US.json</a></td><td> | </td><td class="num">0</td><td><span class="i"></span><span class="d"></span></td></tr>
<tr><td class="R">R</td><td><a href="#h51">core/src/main/assets/lang/fr_FR.json -&gt; common/src/main/assets/lang/fr_FR.json</a></td><td> | </td><td class="num">0</td><td><span class="i"></span><span class="d"></span></td></tr>
<tr><td class="R">R</td><td><a href="#h52">core/src/main/assets/lang/hi_IN.json -&gt; common/src/main/assets/lang/hi_IN.json</a></td><td> | </td><td class="num">0</td><td><span class="i"></span><span class="d"></span></td></tr>
<tr><td class="R">R</td><td><a href="#h53">core/src/main/assets/lang/hu_HU.json -&gt; common/src/main/assets/lang/hu_HU.json</a></td><td> | </td><td class="num">0</td><td><span class="i"></span><span class="d"></span></td></tr>
<tr><td class="R">R</td><td><a href="#h54">core/src/main/assets/lang/it_IT.json -&gt; common/src/main/assets/lang/it_IT.json</a></td><td> | </td><td class="num">0</td><td><span class="i"></span><span class="d"></span></td></tr>
<tr><td class="R">R</td><td><a href="#h55">core/src/main/assets/lang/tr_TR.json -&gt; common/src/main/assets/lang/tr_TR.json</a></td><td> | </td><td class="num">0</td><td><span class="i"></span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h56">common/src/main/kotlin/me/rhunk/snapenhance/common/Constants.kt</a></td><td> | </td><td class="num">10</td><td><span class="i">++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h57">common/src/main/kotlin/me/rhunk/snapenhance/common/ReceiversConfig.kt</a></td><td> | </td><td class="num">8</td><td><span class="i">++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h58">common/src/main/kotlin/me/rhunk/snapenhance/common/action/EnumAction.kt</a></td><td> | </td><td class="num">18</td><td><span class="i">++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h59">common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/FileLoaderWrapper.kt</a></td><td> | </td><td class="num">30</td><td><span class="i">++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h60">common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/types/BridgeFileType.kt</a></td><td> | </td><td class="num">25</td><td><span class="i">+++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h61">common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/types/FileActionType.kt</a></td><td> | </td><td class="num">6</td><td><span class="i">++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h62">common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/types/LocalePair.kt</a></td><td> | </td><td class="num">7</td><td><span class="i">+++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h63">common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/wrapper/LocaleWrapper.kt</a></td><td> | </td><td class="num">100</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h64">common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/wrapper/MappingsWrapper.kt</a></td><td> | </td><td class="num">149</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h65">common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/wrapper/MessageLoggerWrapper.kt</a></td><td> | </td><td class="num">80</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h66">common/src/main/kotlin/me/rhunk/snapenhance/common/config/ConfigContainer.kt</a></td><td> | </td><td class="num">83</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h67">common/src/main/kotlin/me/rhunk/snapenhance/common/config/ConfigObjects.kt</a></td><td> | </td><td class="num">117</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h68">common/src/main/kotlin/me/rhunk/snapenhance/common/config/DataProcessors.kt</a></td><td> | </td><td class="num">95</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h69">common/src/main/kotlin/me/rhunk/snapenhance/common/config/ModConfig.kt</a></td><td> | </td><td class="num">132</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h70">common/src/main/kotlin/me/rhunk/snapenhance/common/config/impl/Camera.kt</a></td><td> | </td><td class="num">22</td><td><span class="i">++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h71">common/src/main/kotlin/me/rhunk/snapenhance/common/config/impl/DownloaderConfig.kt</a></td><td> | </td><td class="num">51</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h72">common/src/main/kotlin/me/rhunk/snapenhance/common/config/impl/E2EEConfig.kt</a></td><td> | </td><td class="num">9</td><td><span class="i">+++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h73">common/src/main/kotlin/me/rhunk/snapenhance/common/config/impl/Experimental.kt</a></td><td> | </td><td class="num">28</td><td><span class="i">++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h74">common/src/main/kotlin/me/rhunk/snapenhance/common/config/impl/Global.kt</a></td><td> | </td><td class="num">16</td><td><span class="i">++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h75">common/src/main/kotlin/me/rhunk/snapenhance/common/config/impl/MessagingTweaks.kt</a></td><td> | </td><td class="num">32</td><td><span class="i">++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h76">common/src/main/kotlin/me/rhunk/snapenhance/common/config/impl/NativeHooks.kt</a></td><td> | </td><td class="num">9</td><td><span class="i">+++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h77">common/src/main/kotlin/me/rhunk/snapenhance/common/config/impl/RootConfig.kt</a></td><td> | </td><td class="num">19</td><td><span class="i">+++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h78">common/src/main/kotlin/me/rhunk/snapenhance/common/config/impl/Rules.kt</a></td><td> | </td><td class="num">27</td><td><span class="i">+++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h79">common/src/main/kotlin/me/rhunk/snapenhance/common/config/impl/Scripting.kt</a></td><td> | </td><td class="num">11</td><td><span class="i">+++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h80">common/src/main/kotlin/me/rhunk/snapenhance/common/config/impl/Spoof.kt</a></td><td> | </td><td class="num">25</td><td><span class="i">+++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h81">common/src/main/kotlin/me/rhunk/snapenhance/common/config/impl/StreaksReminderConfig.kt</a></td><td> | </td><td class="num">10</td><td><span class="i">++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h82">common/src/main/kotlin/me/rhunk/snapenhance/common/config/impl/UserInterfaceTweaks.kt</a></td><td> | </td><td class="num">45</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h83">common/src/main/kotlin/me/rhunk/snapenhance/common/data/FileType.kt</a></td><td> | </td><td class="num">72</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h84">common/src/main/kotlin/me/rhunk/snapenhance/common/data/MessagingCoreObjects.kt</a></td><td> | </td><td class="num">73</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h85">common/src/main/kotlin/me/rhunk/snapenhance/common/data/SnapEnums.kt</a></td><td> | </td><td class="num">173</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h86">common/src/main/kotlin/me/rhunk/snapenhance/common/data/download/DownloadMediaType.kt</a></td><td> | </td><td class="num">23</td><td><span class="i">+++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h87">common/src/main/kotlin/me/rhunk/snapenhance/common/data/download/DownloadMetadata.kt</a></td><td> | </td><td class="num">10</td><td><span class="i">++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h88">common/src/main/kotlin/me/rhunk/snapenhance/common/data/download/DownloadRequest.kt</a></td><td> | </td><td class="num">29</td><td><span class="i">+++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h89">common/src/main/kotlin/me/rhunk/snapenhance/common/data/download/DownloadStage.kt</a></td><td> | </td><td class="num">15</td><td><span class="i">+++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h90">common/src/main/kotlin/me/rhunk/snapenhance/common/data/download/MediaDownloadSource.kt</a></td><td> | </td><td class="num">29</td><td><span class="i">+++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h91">common/src/main/kotlin/me/rhunk/snapenhance/common/data/download/MediaEncryptionKeyPair.kt</a></td><td> | </td><td class="num">26</td><td><span class="i">++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h92">common/src/main/kotlin/me/rhunk/snapenhance/common/data/download/SplitMediaAssetType.kt</a></td><td> | </td><td class="num">5</td><td><span class="i">+++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h93">common/src/main/kotlin/me/rhunk/snapenhance/common/database/DatabaseObject.kt</a></td><td> | </td><td class="num">7</td><td><span class="i">+++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h94">common/src/main/kotlin/me/rhunk/snapenhance/common/database/impl/ConversationMessage.kt</a></td><td> | </td><td class="num">40</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h95">common/src/main/kotlin/me/rhunk/snapenhance/common/database/impl/FriendFeedEntry.kt</a></td><td> | </td><td class="num">47</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h96">common/src/main/kotlin/me/rhunk/snapenhance/common/database/impl/FriendInfo.kt</a></td><td> | </td><td class="num">72</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h97">common/src/main/kotlin/me/rhunk/snapenhance/common/database/impl/StoryEntry.kt</a></td><td> | </td><td class="num">27</td><td><span class="i">+++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h98">common/src/main/kotlin/me/rhunk/snapenhance/common/database/impl/UserConversationLink.kt</a></td><td> | </td><td class="num">23</td><td><span class="i">+++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h99">common/src/main/kotlin/me/rhunk/snapenhance/common/logger/AbstractLogger.kt</a></td><td> | </td><td class="num">39</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h100">common/src/main/kotlin/me/rhunk/snapenhance/common/logger/LogChannel.kt</a></td><td> | </td><td class="num">18</td><td><span class="i">++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h101">common/src/main/kotlin/me/rhunk/snapenhance/common/logger/LogLevel.kt</a></td><td> | </td><td class="num">31</td><td><span class="i">+++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h102">common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/IPCInterface.kt</a></td><td> | </td><td class="num">18</td><td><span class="i">++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h103">common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/JSModule.kt</a></td><td> | </td><td class="num">135</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h104">common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/PrimitiveUtil.kt</a></td><td> | </td><td class="num">18</td><td><span class="i">++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h105">common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/ScriptRuntime.kt</a></td><td> | </td><td class="num">91</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h106">common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/ktx/RhinoKtx.kt</a></td><td> | </td><td class="num">44</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h107">common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/type/ModuleInfo.kt</a></td><td> | </td><td class="num">12</td><td><span class="i">++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h108">common/src/main/kotlin/me/rhunk/snapenhance/common/util/SQLiteDatabaseHelper.kt</a></td><td> | </td><td class="num">32</td><td><span class="i">++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h109">common/src/main/kotlin/me/rhunk/snapenhance/common/util/SerializableDataObject.kt</a></td><td> | </td><td class="num">23</td><td><span class="i">+++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h110">common/src/main/kotlin/me/rhunk/snapenhance/common/util/ktx/AndroidCompatExtensions.kt</a></td><td> | </td><td class="num">13</td><td><span class="i">+++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h111">common/src/main/kotlin/me/rhunk/snapenhance/common/util/ktx/DbCursorExt.kt</a></td><td> | </td><td class="num">38</td><td><span class="i">++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h112">common/src/main/kotlin/me/rhunk/snapenhance/common/util/protobuf/ProtoEditor.kt</a></td><td> | </td><td class="num">68</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h113">common/src/main/kotlin/me/rhunk/snapenhance/common/util/protobuf/ProtoReader.kt</a></td><td> | </td><td class="num">256</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h114">common/src/main/kotlin/me/rhunk/snapenhance/common/util/protobuf/ProtoWriter.kt</a></td><td> | </td><td class="num">118</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h115">common/src/main/kotlin/me/rhunk/snapenhance/common/util/protobuf/WireType.kt</a></td><td> | </td><td class="num">14</td><td><span class="i">++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h116">common/src/main/kotlin/me/rhunk/snapenhance/common/util/snap/BitmojiSelfie.kt</a></td><td> | </td><td class="num">21</td><td><span class="i">+++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h117">common/src/main/kotlin/me/rhunk/snapenhance/common/util/snap/MediaDownloaderHelper.kt</a></td><td> | </td><td class="num">46</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h118">common/src/main/kotlin/me/rhunk/snapenhance/common/util/snap/RemoteMediaResolver.kt</a></td><td> | </td><td class="num">68</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h119">common/src/main/kotlin/me/rhunk/snapenhance/common/util/snap/SnapWidgetBroadcastReceiverHelper.kt</a></td><td> | </td><td class="num">25</td><td><span class="i">+++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h120">core/build.gradle.kts</a></td><td> | </td><td class="num">17</td><td><span class="i">+</span><span class="d">----------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h121">core/src/main/assets/xposed_init</a></td><td> | </td><td class="num">4</td><td><span class="i">++</span><span class="d">--</span></td></tr>
<tr><td class="D">D</td><td><a href="#h122">core/src/main/kotlin/me/rhunk/snapenhance/Constants.kt</a></td><td> | </td><td class="num">10</td><td><span class="i"></span><span class="d">----------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h123">core/src/main/kotlin/me/rhunk/snapenhance/ModContext.kt</a></td><td> | </td><td class="num">156</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h124">core/src/main/kotlin/me/rhunk/snapenhance/SnapEnhance.kt</a></td><td> | </td><td class="num">254</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h125">core/src/main/kotlin/me/rhunk/snapenhance/XposedLoader.kt</a></td><td> | </td><td class="num">12</td><td><span class="i"></span><span class="d">------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h126">core/src/main/kotlin/me/rhunk/snapenhance/action/AbstractAction.kt</a></td><td> | </td><td class="num">24</td><td><span class="i"></span><span class="d">------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h127">core/src/main/kotlin/me/rhunk/snapenhance/action/EnumAction.kt</a></td><td> | </td><td class="num">18</td><td><span class="i"></span><span class="d">------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h128">core/src/main/kotlin/me/rhunk/snapenhance/action/impl/CleanCache.kt</a></td><td> | </td><td class="num">42</td><td><span class="i"></span><span class="d">------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h129">core/src/main/kotlin/me/rhunk/snapenhance/action/impl/ExportChatMessages.kt</a></td><td> | </td><td class="num">314</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h130">core/src/main/kotlin/me/rhunk/snapenhance/action/impl/OpenMap.kt</a></td><td> | </td><td class="num">22</td><td><span class="i"></span><span class="d">----------------------</span></td></tr>
<tr><td class="A">A</td><td><a href="#h131">core/src/main/kotlin/me/rhunk/snapenhance/core/DownloadManagerClient.kt</a></td><td> | </td><td class="num">71</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="D">D</td><td><a href="#h132">core/src/main/kotlin/me/rhunk/snapenhance/core/Logger.kt</a></td><td> | </td><td class="num">87</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="A">A</td><td><a href="#h133">core/src/main/kotlin/me/rhunk/snapenhance/core/ModContext.kt</a></td><td> | </td><td class="num">160</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h134">core/src/main/kotlin/me/rhunk/snapenhance/core/SnapEnhance.kt</a></td><td> | </td><td class="num">259</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h135">core/src/main/kotlin/me/rhunk/snapenhance/core/XposedLoader.kt</a></td><td> | </td><td class="num">13</td><td><span class="i">+++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h136">core/src/main/kotlin/me/rhunk/snapenhance/core/action/AbstractAction.kt</a></td><td> | </td><td class="num">24</td><td><span class="i">++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h137">core/src/main/kotlin/me/rhunk/snapenhance/core/action/impl/CleanCache.kt</a></td><td> | </td><td class="num">42</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h138">core/src/main/kotlin/me/rhunk/snapenhance/core/action/impl/ExportChatMessages.kt</a></td><td> | </td><td class="num">314</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h139">core/src/main/kotlin/me/rhunk/snapenhance/core/action/impl/OpenMap.kt</a></td><td> | </td><td class="num">22</td><td><span class="i">++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h140">core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/BridgeClient.kt</a></td><td> | </td><td class="num">26</td><td><span class="i">+++++++++++++++</span><span class="d">-----------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h141">core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/FileLoaderWrapper.kt</a></td><td> | </td><td class="num">36</td><td><span class="i"></span><span class="d">------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h142">core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/types/BridgeFileType.kt</a></td><td> | </td><td class="num">25</td><td><span class="i"></span><span class="d">-------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h143">core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/types/FileActionType.kt</a></td><td> | </td><td class="num">6</td><td><span class="i"></span><span class="d">------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h144">core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/wrapper/LocaleWrapper.kt</a></td><td> | </td><td class="num">101</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h145">core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/wrapper/MappingsWrapper.kt</a></td><td> | </td><td class="num">152</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h146">core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/wrapper/MessageLoggerWrapper.kt</a></td><td> | </td><td class="num">80</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h147">core/src/main/kotlin/me/rhunk/snapenhance/core/config/ConfigContainer.kt</a></td><td> | </td><td class="num">83</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h148">core/src/main/kotlin/me/rhunk/snapenhance/core/config/ConfigObjects.kt</a></td><td> | </td><td class="num">117</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h149">core/src/main/kotlin/me/rhunk/snapenhance/core/config/DataProcessors.kt</a></td><td> | </td><td class="num">95</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h150">core/src/main/kotlin/me/rhunk/snapenhance/core/config/ModConfig.kt</a></td><td> | </td><td class="num">133</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h151">core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/Camera.kt</a></td><td> | </td><td class="num">19</td><td><span class="i"></span><span class="d">-------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h152">core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/DownloaderConfig.kt</a></td><td> | </td><td class="num">51</td><td><span class="i"></span><span class="d">---------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h153">core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/E2EEConfig.kt</a></td><td> | </td><td class="num">9</td><td><span class="i"></span><span class="d">---------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h154">core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/Experimental.kt</a></td><td> | </td><td class="num">28</td><td><span class="i"></span><span class="d">----------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h155">core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/Global.kt</a></td><td> | </td><td class="num">15</td><td><span class="i"></span><span class="d">---------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h156">core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/MessagingTweaks.kt</a></td><td> | </td><td class="num">32</td><td><span class="i"></span><span class="d">--------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h157">core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/NativeHooks.kt</a></td><td> | </td><td class="num">9</td><td><span class="i"></span><span class="d">---------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h158">core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/RootConfig.kt</a></td><td> | </td><td class="num">19</td><td><span class="i"></span><span class="d">-------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h159">core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/Rules.kt</a></td><td> | </td><td class="num">27</td><td><span class="i"></span><span class="d">---------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h160">core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/Scripting.kt</a></td><td> | </td><td class="num">11</td><td><span class="i"></span><span class="d">-----------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h161">core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/Spoof.kt</a></td><td> | </td><td class="num">25</td><td><span class="i"></span><span class="d">-------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h162">core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/StreaksReminderConfig.kt</a></td><td> | </td><td class="num">10</td><td><span class="i"></span><span class="d">----------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h163">core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/UserInterfaceTweaks.kt</a></td><td> | </td><td class="num">42</td><td><span class="i"></span><span class="d">------------------------------------------</span></td></tr>
<tr><td class="A">A</td><td><a href="#h164">core/src/main/kotlin/me/rhunk/snapenhance/core/data/SnapClassCache.kt</a></td><td> | </td><td class="num">31</td><td><span class="i">+++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h165">core/src/main/kotlin/me/rhunk/snapenhance/core/database/DatabaseAccess.kt</a></td><td> | </td><td class="num">21</td><td><span class="i">+++++++++++</span><span class="d">----------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h166">core/src/main/kotlin/me/rhunk/snapenhance/core/database/DatabaseObject.kt</a></td><td> | </td><td class="num">7</td><td><span class="i"></span><span class="d">-------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h167">core/src/main/kotlin/me/rhunk/snapenhance/core/database/objects/ConversationMessage.kt</a></td><td> | </td><td class="num">43</td><td><span class="i"></span><span class="d">-------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h168">core/src/main/kotlin/me/rhunk/snapenhance/core/database/objects/FriendFeedEntry.kt</a></td><td> | </td><td class="num">47</td><td><span class="i"></span><span class="d">-----------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h169">core/src/main/kotlin/me/rhunk/snapenhance/core/database/objects/FriendInfo.kt</a></td><td> | </td><td class="num">72</td><td><span class="i"></span><span class="d">------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h170">core/src/main/kotlin/me/rhunk/snapenhance/core/database/objects/StoryEntry.kt</a></td><td> | </td><td class="num">27</td><td><span class="i"></span><span class="d">---------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h171">core/src/main/kotlin/me/rhunk/snapenhance/core/database/objects/UserConversationLink.kt</a></td><td> | </td><td class="num">23</td><td><span class="i"></span><span class="d">-----------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h172">core/src/main/kotlin/me/rhunk/snapenhance/core/download/DownloadManagerClient.kt</a></td><td> | </td><td class="num">81</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h173">core/src/main/kotlin/me/rhunk/snapenhance/core/download/data/DownloadMediaType.kt</a></td><td> | </td><td class="num">23</td><td><span class="i"></span><span class="d">-----------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h174">core/src/main/kotlin/me/rhunk/snapenhance/core/download/data/DownloadMetadata.kt</a></td><td> | </td><td class="num">10</td><td><span class="i"></span><span class="d">----------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h175">core/src/main/kotlin/me/rhunk/snapenhance/core/download/data/DownloadRequest.kt</a></td><td> | </td><td class="num">29</td><td><span class="i"></span><span class="d">-----------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h176">core/src/main/kotlin/me/rhunk/snapenhance/core/download/data/DownloadStage.kt</a></td><td> | </td><td class="num">15</td><td><span class="i"></span><span class="d">---------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h177">core/src/main/kotlin/me/rhunk/snapenhance/core/download/data/MediaDownloadSource.kt</a></td><td> | </td><td class="num">29</td><td><span class="i"></span><span class="d">-----------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h178">core/src/main/kotlin/me/rhunk/snapenhance/core/download/data/MediaEncryptionKeyPair.kt</a></td><td> | </td><td class="num">31</td><td><span class="i"></span><span class="d">-------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h179">core/src/main/kotlin/me/rhunk/snapenhance/core/download/data/SplitMediaAssetType.kt</a></td><td> | </td><td class="num">5</td><td><span class="i"></span><span class="d">-----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h180">core/src/main/kotlin/me/rhunk/snapenhance/core/event/EventBus.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h181">core/src/main/kotlin/me/rhunk/snapenhance/core/event/EventDispatcher.kt</a></td><td> | </td><td class="num">24</td><td><span class="i">+++++++++++++</span><span class="d">-----------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h182">core/src/main/kotlin/me/rhunk/snapenhance/core/event/events/AbstractHookEvent.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h183">core/src/main/kotlin/me/rhunk/snapenhance/core/event/events/impl/BuildMessageEvent.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h184">core/src/main/kotlin/me/rhunk/snapenhance/core/event/events/impl/OnSnapInteractionEvent.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h185">core/src/main/kotlin/me/rhunk/snapenhance/core/event/events/impl/SendMessageWithContentEvent.kt</a></td><td> | </td><td class="num">8</td><td><span class="i">++++</span><span class="d">----</span></td></tr>
<tr><td class="A">A</td><td><a href="#h186">core/src/main/kotlin/me/rhunk/snapenhance/core/features/BridgeFileFeature.kt</a></td><td> | </td><td class="num">55</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h187">core/src/main/kotlin/me/rhunk/snapenhance/core/features/Feature.kt</a></td><td> | </td><td class="num">40</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h188">core/src/main/kotlin/me/rhunk/snapenhance/core/features/FeatureLoadParams.kt</a></td><td> | </td><td class="num">12</td><td><span class="i">++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h189">core/src/main/kotlin/me/rhunk/snapenhance/core/features/MessagingRuleFeature.kt</a></td><td> | </td><td class="num">31</td><td><span class="i">+++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h190">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ConfigurationOverride.kt</a></td><td> | </td><td class="num">82</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h191">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ScopeSync.kt</a></td><td> | </td><td class="num">44</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h192">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/downloader/MediaDownloader.kt</a></td><td> | </td><td class="num">719</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h193">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/downloader/ProfilePictureDownloader.kt</a></td><td> | </td><td class="num">81</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h194">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/downloader/decoder/AttachmentInfo.kt</a></td><td> | </td><td class="num">16</td><td><span class="i">++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h195">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/downloader/decoder/AttachmentType.kt</a></td><td> | </td><td class="num">12</td><td><span class="i">++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h196">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/downloader/decoder/MessageDecoder.kt</a></td><td> | </td><td class="num">192</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h197">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/AddFriendSourceSpoof.kt</a></td><td> | </td><td class="num">56</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h198">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/AmoledDarkMode.kt</a></td><td> | </td><td class="num">51</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h199">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/AppPasscode.kt</a></td><td> | </td><td class="num">107</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h200">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/DeviceSpooferHook.kt</a></td><td> | </td><td class="num">94</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h201">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/EndToEndEncryption.kt</a></td><td> | </td><td class="num">501</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h202">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/InfiniteStoryBoost.kt</a></td><td> | </td><td class="num">24</td><td><span class="i">++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h203">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/MeoPasscodeBypass.kt</a></td><td> | </td><td class="num">23</td><td><span class="i">+++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h204">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/NoFriendScoreDelay.kt</a></td><td> | </td><td class="num">21</td><td><span class="i">+++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h205">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/UnlimitedMultiSnap.kt</a></td><td> | </td><td class="num">25</td><td><span class="i">+++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h206">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/BypassVideoLengthRestriction.kt</a></td><td> | </td><td class="num">73</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h207">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/DisableMetrics.kt</a></td><td> | </td><td class="num">31</td><td><span class="i">+++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h208">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/GooglePlayServicesDialogs.kt</a></td><td> | </td><td class="num">23</td><td><span class="i">+++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h209">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/LocationSpoofer.kt</a></td><td> | </td><td class="num">42</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h210">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/MediaQualityLevelOverride.kt</a></td><td> | </td><td class="num">24</td><td><span class="i">++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h211">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/SnapchatPlus.kt</a></td><td> | </td><td class="num">46</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h212">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/AnonymousStoryViewing.kt</a></td><td> | </td><td class="num">27</td><td><span class="i">+++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h213">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/AutoSave.kt</a></td><td> | </td><td class="num">139</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h214">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/DisableReplayInFF.kt</a></td><td> | </td><td class="num">23</td><td><span class="i">+++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h215">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/Messaging.kt</a></td><td> | </td><td class="num">95</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h216">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/Notifications.kt</a></td><td> | </td><td class="num">371</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h217">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/PreventMessageSending.kt</a></td><td> | </td><td class="num">49</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h218">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/PreventReadReceipts.kt</a></td><td> | </td><td class="num">32</td><td><span class="i">++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h219">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/SendOverride.kt</a></td><td> | </td><td class="num">117</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h220">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/UnlimitedSnapViewTime.kt</a></td><td> | </td><td class="num">32</td><td><span class="i">++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h221">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/spying/MessageLogger.kt</a></td><td> | </td><td class="num">180</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h222">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/spying/SnapToChatMedia.kt</a></td><td> | </td><td class="num">26</td><td><span class="i">++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h223">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/spying/StealthMode.kt</a></td><td> | </td><td class="num">7</td><td><span class="i">+++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h224">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/tweaks/CameraTweaks.kt</a></td><td> | </td><td class="num">76</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h225">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/ClientBootstrapOverride.kt</a></td><td> | </td><td class="num">33</td><td><span class="i">+++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h226">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/FriendFeedMessagePreview.kt</a></td><td> | </td><td class="num">107</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h227">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/HideStreakRestore.kt</a></td><td> | </td><td class="num">20</td><td><span class="i">++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h228">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/OldBitmojiSelfie.kt</a></td><td> | </td><td class="num">23</td><td><span class="i">+++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h229">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/PinConversations.kt</a></td><td> | </td><td class="num">42</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h230">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/UITweaks.kt</a></td><td> | </td><td class="num">151</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="D">D</td><td><a href="#h231">core/src/main/kotlin/me/rhunk/snapenhance/core/logger/AbstractLogger.kt</a></td><td> | </td><td class="num">23</td><td><span class="i"></span><span class="d">-----------------------</span></td></tr>
<tr><td class="A">A</td><td><a href="#h232">core/src/main/kotlin/me/rhunk/snapenhance/core/logger/CoreLogger.kt</a></td><td> | </td><td class="num">78</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="D">D</td><td><a href="#h233">core/src/main/kotlin/me/rhunk/snapenhance/core/logger/LogChannel.kt</a></td><td> | </td><td class="num">18</td><td><span class="i"></span><span class="d">------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h234">core/src/main/kotlin/me/rhunk/snapenhance/core/logger/LogLevel.kt</a></td><td> | </td><td class="num">31</td><td><span class="i"></span><span class="d">-------------------------------</span></td></tr>
<tr><td class="A">A</td><td><a href="#h235">core/src/main/kotlin/me/rhunk/snapenhance/core/manager/Manager.kt</a></td><td> | </td><td class="num">7</td><td><span class="i">+++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h236">core/src/main/kotlin/me/rhunk/snapenhance/core/manager/impl/ActionManager.kt</a></td><td> | </td><td class="num">44</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h237">core/src/main/kotlin/me/rhunk/snapenhance/core/manager/impl/FeatureManager.kt</a></td><td> | </td><td class="num">165</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h238">core/src/main/kotlin/me/rhunk/snapenhance/core/messaging/MessageExporter.kt</a></td><td> | </td><td class="num">326</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h239">core/src/main/kotlin/me/rhunk/snapenhance/core/messaging/MessageSender.kt</a></td><td> | </td><td class="num">182</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="D">D</td><td><a href="#h240">core/src/main/kotlin/me/rhunk/snapenhance/core/messaging/MessagingCoreObjects.kt</a></td><td> | </td><td class="num">73</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------</span></td></tr>
<tr><td class="A">A</td><td><a href="#h241">core/src/main/kotlin/me/rhunk/snapenhance/core/scripting/CoreScriptRuntime.kt</a></td><td> | </td><td class="num">57</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h242">core/src/main/kotlin/me/rhunk/snapenhance/core/scripting/impl/ScriptHooker.kt</a></td><td> | </td><td class="num">162</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h243">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/ViewAppearanceHelper.kt</a></td><td> | </td><td class="num">141</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h244">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/ViewTagState.kt</a></td><td> | </td><td class="num">21</td><td><span class="i">+++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h245">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/AbstractMenu.kt</a></td><td> | </td><td class="num">10</td><td><span class="i">++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h246">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/ChatActionMenu.kt</a></td><td> | </td><td class="num">226</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h247">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/FriendFeedInfoMenu.kt</a></td><td> | </td><td class="num">256</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h248">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/MenuViewInjector.kt</a></td><td> | </td><td class="num">147</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h249">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/OperaContextActionMenu.kt</a></td><td> | </td><td class="num">93</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h250">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/SettingsGearInjector.kt</a></td><td> | </td><td class="num">84</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h251">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/SettingsMenu.kt</a></td><td> | </td><td class="num">30</td><td><span class="i">++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h252">core/src/main/kotlin/me/rhunk/snapenhance/core/util/CallbackBuilder.kt</a></td><td> | </td><td class="num">6</td><td><span class="i">+++</span><span class="d">---</span></td></tr>
<tr><td class="D">D</td><td><a href="#h253">core/src/main/kotlin/me/rhunk/snapenhance/core/util/SQLiteDatabaseHelper.kt</a></td><td> | </td><td class="num">32</td><td><span class="i"></span><span class="d">--------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h254">core/src/main/kotlin/me/rhunk/snapenhance/core/util/SerializableDataObject.kt</a></td><td> | </td><td class="num">23</td><td><span class="i"></span><span class="d">-----------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h255">core/src/main/kotlin/me/rhunk/snapenhance/core/util/download/HttpServer.kt</a></td><td> | </td><td class="num">140</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h256">core/src/main/kotlin/me/rhunk/snapenhance/core/util/download/RemoteMediaResolver.kt</a></td><td> | </td><td class="num">68</td><td><span class="i"></span><span class="d">--------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h257">core/src/main/kotlin/me/rhunk/snapenhance/core/util/export/MessageExporter.kt</a></td><td> | </td><td class="num">326</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="A">A</td><td><a href="#h258">core/src/main/kotlin/me/rhunk/snapenhance/core/util/hook/HookAdapter.kt</a></td><td> | </td><td class="num">77</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h259">core/src/main/kotlin/me/rhunk/snapenhance/core/util/hook/HookStage.kt</a></td><td> | </td><td class="num">7</td><td><span class="i">+++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h260">core/src/main/kotlin/me/rhunk/snapenhance/core/util/hook/Hooker.kt</a></td><td> | </td><td class="num">157</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="D">D</td><td><a href="#h261">core/src/main/kotlin/me/rhunk/snapenhance/core/util/ktx/AndroidCompatExtensions.kt</a></td><td> | </td><td class="num">13</td><td><span class="i"></span><span class="d">-------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h262">core/src/main/kotlin/me/rhunk/snapenhance/core/util/ktx/DbCursorExt.kt</a></td><td> | </td><td class="num">38</td><td><span class="i"></span><span class="d">--------------------------------------</span></td></tr>
<tr><td class="A">A</td><td><a href="#h263">core/src/main/kotlin/me/rhunk/snapenhance/core/util/media/HttpServer.kt</a></td><td> | </td><td class="num">140</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h264">core/src/main/kotlin/me/rhunk/snapenhance/core/util/media/PreviewUtils.kt</a></td><td> | </td><td class="num">87</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="D">D</td><td><a href="#h265">core/src/main/kotlin/me/rhunk/snapenhance/core/util/protobuf/ProtoEditor.kt</a></td><td> | </td><td class="num">68</td><td><span class="i"></span><span class="d">--------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h266">core/src/main/kotlin/me/rhunk/snapenhance/core/util/protobuf/ProtoReader.kt</a></td><td> | </td><td class="num">256</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h267">core/src/main/kotlin/me/rhunk/snapenhance/core/util/protobuf/ProtoWriter.kt</a></td><td> | </td><td class="num">118</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h268">core/src/main/kotlin/me/rhunk/snapenhance/core/util/protobuf/WireType.kt</a></td><td> | </td><td class="num">14</td><td><span class="i"></span><span class="d">--------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h269">core/src/main/kotlin/me/rhunk/snapenhance/core/util/snap/BitmojiSelfie.kt</a></td><td> | </td><td class="num">21</td><td><span class="i"></span><span class="d">---------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h270">core/src/main/kotlin/me/rhunk/snapenhance/core/util/snap/MediaDownloaderHelper.kt</a></td><td> | </td><td class="num">46</td><td><span class="i"></span><span class="d">----------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h271">core/src/main/kotlin/me/rhunk/snapenhance/core/util/snap/PreviewUtils.kt</a></td><td> | </td><td class="num">87</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h272">core/src/main/kotlin/me/rhunk/snapenhance/core/util/snap/SnapWidgetBroadcastReceiverHelper.kt</a></td><td> | </td><td class="num">25</td><td><span class="i"></span><span class="d">-------------------------</span></td></tr>
<tr><td class="A">A</td><td><a href="#h273">core/src/main/kotlin/me/rhunk/snapenhance/core/wrapper/AbstractWrapper.kt</a></td><td> | </td><td class="num">47</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h274">core/src/main/kotlin/me/rhunk/snapenhance/core/wrapper/impl/FriendActionButton.kt</a></td><td> | </td><td class="num">39</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h275">core/src/main/kotlin/me/rhunk/snapenhance/core/wrapper/impl/Message.kt</a></td><td> | </td><td class="num">15</td><td><span class="i">+++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h276">core/src/main/kotlin/me/rhunk/snapenhance/core/wrapper/impl/MessageContent.kt</a></td><td> | </td><td class="num">14</td><td><span class="i">++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h277">core/src/main/kotlin/me/rhunk/snapenhance/core/wrapper/impl/MessageDescriptor.kt</a></td><td> | </td><td class="num">10</td><td><span class="i">++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h278">core/src/main/kotlin/me/rhunk/snapenhance/core/wrapper/impl/MessageDestinations.kt</a></td><td> | </td><td class="num">16</td><td><span class="i">++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h279">core/src/main/kotlin/me/rhunk/snapenhance/core/wrapper/impl/MessageMetadata.kt</a></td><td> | </td><td class="num">29</td><td><span class="i">+++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h280">core/src/main/kotlin/me/rhunk/snapenhance/core/wrapper/impl/ScSize.kt</a></td><td> | </td><td class="num">27</td><td><span class="i">+++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h281">core/src/main/kotlin/me/rhunk/snapenhance/core/wrapper/impl/SnapUUID.kt</a></td><td> | </td><td class="num">44</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h282">core/src/main/kotlin/me/rhunk/snapenhance/core/wrapper/impl/UserIdToReaction.kt</a></td><td> | </td><td class="num">12</td><td><span class="i">++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h283">core/src/main/kotlin/me/rhunk/snapenhance/core/wrapper/impl/media/EncryptionWrapper.kt</a></td><td> | </td><td class="num">81</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h284">core/src/main/kotlin/me/rhunk/snapenhance/core/wrapper/impl/media/MediaInfo.kt</a></td><td> | </td><td class="num">34</td><td><span class="i">++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h285">core/src/main/kotlin/me/rhunk/snapenhance/core/wrapper/impl/media/dash/LongformVideoPlaylistItem.kt</a></td><td> | </td><td class="num">12</td><td><span class="i">++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h286">core/src/main/kotlin/me/rhunk/snapenhance/core/wrapper/impl/media/dash/SnapChapter.kt</a></td><td> | </td><td class="num">13</td><td><span class="i">+++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h287">core/src/main/kotlin/me/rhunk/snapenhance/core/wrapper/impl/media/dash/SnapPlaylistItem.kt</a></td><td> | </td><td class="num">10</td><td><span class="i">++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h288">core/src/main/kotlin/me/rhunk/snapenhance/core/wrapper/impl/media/opera/Layer.kt</a></td><td> | </td><td class="num">21</td><td><span class="i">+++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h289">core/src/main/kotlin/me/rhunk/snapenhance/core/wrapper/impl/media/opera/LayerController.kt</a></td><td> | </td><td class="num">18</td><td><span class="i">++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h290">core/src/main/kotlin/me/rhunk/snapenhance/core/wrapper/impl/media/opera/ParamMap.kt</a></td><td> | </td><td class="num">37</td><td><span class="i">+++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="D">D</td><td><a href="#h291">core/src/main/kotlin/me/rhunk/snapenhance/data/FileType.kt</a></td><td> | </td><td class="num">75</td><td><span class="i"></span><span class="d">---------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h292">core/src/main/kotlin/me/rhunk/snapenhance/data/LocalePair.kt</a></td><td> | </td><td class="num">4</td><td><span class="i"></span><span class="d">----</span></td></tr>
<tr><td class="D">D</td><td><a href="#h293">core/src/main/kotlin/me/rhunk/snapenhance/data/MessageSender.kt</a></td><td> | </td><td class="num">179</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h294">core/src/main/kotlin/me/rhunk/snapenhance/data/SnapClassCache.kt</a></td><td> | </td><td class="num">31</td><td><span class="i"></span><span class="d">-------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h295">core/src/main/kotlin/me/rhunk/snapenhance/data/SnapEnums.kt</a></td><td> | </td><td class="num">173</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h296">core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/AbstractWrapper.kt</a></td><td> | </td><td class="num">47</td><td><span class="i"></span><span class="d">-----------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h297">core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/FriendActionButton.kt</a></td><td> | </td><td class="num">39</td><td><span class="i"></span><span class="d">---------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h298">core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/Message.kt</a></td><td> | </td><td class="num">15</td><td><span class="i"></span><span class="d">---------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h299">core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/MessageContent.kt</a></td><td> | </td><td class="num">14</td><td><span class="i"></span><span class="d">--------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h300">core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/MessageDescriptor.kt</a></td><td> | </td><td class="num">10</td><td><span class="i"></span><span class="d">----------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h301">core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/MessageDestinations.kt</a></td><td> | </td><td class="num">16</td><td><span class="i"></span><span class="d">----------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h302">core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/MessageMetadata.kt</a></td><td> | </td><td class="num">29</td><td><span class="i"></span><span class="d">-----------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h303">core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/ScSize.kt</a></td><td> | </td><td class="num">27</td><td><span class="i"></span><span class="d">---------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h304">core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/SnapUUID.kt</a></td><td> | </td><td class="num">44</td><td><span class="i"></span><span class="d">--------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h305">core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/UserIdToReaction.kt</a></td><td> | </td><td class="num">12</td><td><span class="i"></span><span class="d">------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h306">core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/media/EncryptionWrapper.kt</a></td><td> | </td><td class="num">73</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h307">core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/media/MediaInfo.kt</a></td><td> | </td><td class="num">34</td><td><span class="i"></span><span class="d">----------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h308">core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/media/dash/LongformVideoPlaylistItem.kt</a></td><td> | </td><td class="num">12</td><td><span class="i"></span><span class="d">------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h309">core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/media/dash/SnapChapter.kt</a></td><td> | </td><td class="num">13</td><td><span class="i"></span><span class="d">-------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h310">core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/media/dash/SnapPlaylistItem.kt</a></td><td> | </td><td class="num">10</td><td><span class="i"></span><span class="d">----------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h311">core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/media/opera/Layer.kt</a></td><td> | </td><td class="num">21</td><td><span class="i"></span><span class="d">---------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h312">core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/media/opera/LayerController.kt</a></td><td> | </td><td class="num">18</td><td><span class="i"></span><span class="d">------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h313">core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/media/opera/ParamMap.kt</a></td><td> | </td><td class="num">37</td><td><span class="i"></span><span class="d">-------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h314">core/src/main/kotlin/me/rhunk/snapenhance/features/BridgeFileFeature.kt</a></td><td> | </td><td class="num">55</td><td><span class="i"></span><span class="d">-------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h315">core/src/main/kotlin/me/rhunk/snapenhance/features/Feature.kt</a></td><td> | </td><td class="num">40</td><td><span class="i"></span><span class="d">----------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h316">core/src/main/kotlin/me/rhunk/snapenhance/features/FeatureLoadParams.kt</a></td><td> | </td><td class="num">12</td><td><span class="i"></span><span class="d">------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h317">core/src/main/kotlin/me/rhunk/snapenhance/features/MessagingRuleFeature.kt</a></td><td> | </td><td class="num">31</td><td><span class="i"></span><span class="d">-------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h318">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/ConfigurationOverride.kt</a></td><td> | </td><td class="num">82</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h319">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/Messaging.kt</a></td><td> | </td><td class="num">95</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h320">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/ScopeSync.kt</a></td><td> | </td><td class="num">44</td><td><span class="i"></span><span class="d">--------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h321">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/MediaDownloader.kt</a></td><td> | </td><td class="num">714</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h322">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/ProfilePictureDownloader.kt</a></td><td> | </td><td class="num">81</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h323">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/decoder/AttachmentInfo.kt</a></td><td> | </td><td class="num">16</td><td><span class="i"></span><span class="d">----------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h324">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/decoder/AttachmentType.kt</a></td><td> | </td><td class="num">12</td><td><span class="i"></span><span class="d">------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h325">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/decoder/MessageDecoder.kt</a></td><td> | </td><td class="num">192</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h326">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/experiments/AddFriendSourceSpoof.kt</a></td><td> | </td><td class="num">56</td><td><span class="i"></span><span class="d">--------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h327">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/experiments/AmoledDarkMode.kt</a></td><td> | </td><td class="num">50</td><td><span class="i"></span><span class="d">--------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h328">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/experiments/AppPasscode.kt</a></td><td> | </td><td class="num">107</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h329">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/experiments/DeviceSpooferHook.kt</a></td><td> | </td><td class="num">94</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h330">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/experiments/EndToEndEncryption.kt</a></td><td> | </td><td class="num">501</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h331">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/experiments/InfiniteStoryBoost.kt</a></td><td> | </td><td class="num">24</td><td><span class="i"></span><span class="d">------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h332">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/experiments/MeoPasscodeBypass.kt</a></td><td> | </td><td class="num">23</td><td><span class="i"></span><span class="d">-----------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h333">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/experiments/NoFriendScoreDelay.kt</a></td><td> | </td><td class="num">21</td><td><span class="i"></span><span class="d">---------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h334">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/experiments/UnlimitedMultiSnap.kt</a></td><td> | </td><td class="num">25</td><td><span class="i"></span><span class="d">-------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h335">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/privacy/DisableMetrics.kt</a></td><td> | </td><td class="num">31</td><td><span class="i"></span><span class="d">-------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h336">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/privacy/PreventMessageSending.kt</a></td><td> | </td><td class="num">49</td><td><span class="i"></span><span class="d">-------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h337">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/spying/AnonymousStoryViewing.kt</a></td><td> | </td><td class="num">27</td><td><span class="i"></span><span class="d">---------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h338">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/spying/MessageLogger.kt</a></td><td> | </td><td class="num">180</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h339">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/spying/PreventReadReceipts.kt</a></td><td> | </td><td class="num">29</td><td><span class="i"></span><span class="d">-----------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h340">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/spying/SnapToChatMedia.kt</a></td><td> | </td><td class="num">26</td><td><span class="i"></span><span class="d">--------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h341">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/spying/StealthMode.kt</a></td><td> | </td><td class="num">7</td><td><span class="i"></span><span class="d">-------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h342">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/AutoSave.kt</a></td><td> | </td><td class="num">140</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h343">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/BypassVideoLengthRestriction.kt</a></td><td> | </td><td class="num">73</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h344">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/CameraTweaks.kt</a></td><td> | </td><td class="num">79</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h345">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/DisableReplayInFF.kt</a></td><td> | </td><td class="num">23</td><td><span class="i"></span><span class="d">-----------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h346">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/GooglePlayServicesDialogs.kt</a></td><td> | </td><td class="num">23</td><td><span class="i"></span><span class="d">-----------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h347">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/LocationSpoofer.kt</a></td><td> | </td><td class="num">42</td><td><span class="i"></span><span class="d">------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h348">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/MediaQualityLevelOverride.kt</a></td><td> | </td><td class="num">24</td><td><span class="i"></span><span class="d">------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h349">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/Notifications.kt</a></td><td> | </td><td class="num">373</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h350">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/OldBitmojiSelfie.kt</a></td><td> | </td><td class="num">23</td><td><span class="i"></span><span class="d">-----------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h351">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/SendOverride.kt</a></td><td> | </td><td class="num">117</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h352">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/SnapchatPlus.kt</a></td><td> | </td><td class="num">46</td><td><span class="i"></span><span class="d">----------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h353">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/UnlimitedSnapViewTime.kt</a></td><td> | </td><td class="num">32</td><td><span class="i"></span><span class="d">--------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h354">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/ClientBootstrapOverride.kt</a></td><td> | </td><td class="num">35</td><td><span class="i"></span><span class="d">-----------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h355">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/FriendFeedMessagePreview.kt</a></td><td> | </td><td class="num">107</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h356">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/HideStreakRestore.kt</a></td><td> | </td><td class="num">20</td><td><span class="i"></span><span class="d">--------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h357">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/PinConversations.kt</a></td><td> | </td><td class="num">42</td><td><span class="i"></span><span class="d">------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h358">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/UITweaks.kt</a></td><td> | </td><td class="num">151</td><td><span class="i"></span><span class="d">------------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h359">core/src/main/kotlin/me/rhunk/snapenhance/hook/HookAdapter.kt</a></td><td> | </td><td class="num">77</td><td><span class="i"></span><span class="d">-----------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h360">core/src/main/kotlin/me/rhunk/snapenhance/hook/HookStage.kt</a></td><td> | </td><td class="num">7</td><td><span class="i"></span><span class="d">-------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h361">core/src/main/kotlin/me/rhunk/snapenhance/hook/Hooker.kt</a></td><td> | </td><td class="num">157</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h362">core/src/main/kotlin/me/rhunk/snapenhance/manager/Manager.kt</a></td><td> | </td><td class="num">7</td><td><span class="i"></span><span class="d">-------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h363">core/src/main/kotlin/me/rhunk/snapenhance/manager/impl/ActionManager.kt</a></td><td> | </td><td class="num">38</td><td><span class="i"></span><span class="d">--------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h364">core/src/main/kotlin/me/rhunk/snapenhance/manager/impl/FeatureManager.kt</a></td><td> | </td><td class="num">172</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h365">core/src/main/kotlin/me/rhunk/snapenhance/scripting/IPCInterface.kt</a></td><td> | </td><td class="num">18</td><td><span class="i"></span><span class="d">------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h366">core/src/main/kotlin/me/rhunk/snapenhance/scripting/JSModule.kt</a></td><td> | </td><td class="num">135</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h367">core/src/main/kotlin/me/rhunk/snapenhance/scripting/PrimitiveUtil.kt</a></td><td> | </td><td class="num">18</td><td><span class="i"></span><span class="d">------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h368">core/src/main/kotlin/me/rhunk/snapenhance/scripting/ScriptRuntime.kt</a></td><td> | </td><td class="num">91</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h369">core/src/main/kotlin/me/rhunk/snapenhance/scripting/core/CoreScriptRuntime.kt</a></td><td> | </td><td class="num">57</td><td><span class="i"></span><span class="d">---------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h370">core/src/main/kotlin/me/rhunk/snapenhance/scripting/core/impl/ScriptHooker.kt</a></td><td> | </td><td class="num">162</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h371">core/src/main/kotlin/me/rhunk/snapenhance/scripting/ktx/RhinoKtx.kt</a></td><td> | </td><td class="num">44</td><td><span class="i"></span><span class="d">--------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h372">core/src/main/kotlin/me/rhunk/snapenhance/scripting/type/ModuleInfo.kt</a></td><td> | </td><td class="num">12</td><td><span class="i"></span><span class="d">------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h373">core/src/main/kotlin/me/rhunk/snapenhance/ui/ViewAppearanceHelper.kt</a></td><td> | </td><td class="num">141</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h374">core/src/main/kotlin/me/rhunk/snapenhance/ui/ViewTagState.kt</a></td><td> | </td><td class="num">21</td><td><span class="i"></span><span class="d">---------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h375">core/src/main/kotlin/me/rhunk/snapenhance/ui/menu/AbstractMenu.kt</a></td><td> | </td><td class="num">10</td><td><span class="i"></span><span class="d">----------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h376">core/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/ChatActionMenu.kt</a></td><td> | </td><td class="num">225</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h377">core/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/FriendFeedInfoMenu.kt</a></td><td> | </td><td class="num">256</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h378">core/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/MenuViewInjector.kt</a></td><td> | </td><td class="num">147</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h379">core/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/OperaContextActionMenu.kt</a></td><td> | </td><td class="num">93</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h380">core/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/SettingsGearInjector.kt</a></td><td> | </td><td class="num">86</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h381">core/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/SettingsMenu.kt</a></td><td> | </td><td class="num">30</td><td><span class="i"></span><span class="d">------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h382">core/src/main/res/drawable/back_arrow.xml</a></td><td> | </td><td class="num">11</td><td><span class="i"></span><span class="d">-----------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h383">core/src/main/res/font/avenir_next_bold.ttf</a></td><td> | </td><td class="num">0</td><td><span class="i"></span><span class="d"></span></td></tr>
<tr><td class="D">D</td><td><a href="#h384">core/src/main/res/font/avenir_next_medium.ttf</a></td><td> | </td><td class="num">0</td><td><span class="i"></span><span class="d"></span></td></tr>
<tr><td class="D">D</td><td><a href="#h385">core/src/main/res/layout/activity_default_header.xml</a></td><td> | </td><td class="num">37</td><td><span class="i"></span><span class="d">-------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h386">core/src/main/res/layout/debug_setting_item.xml</a></td><td> | </td><td class="num">19</td><td><span class="i"></span><span class="d">-------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h387">core/src/main/res/layout/debug_settings_page.xml</a></td><td> | </td><td class="num">21</td><td><span class="i"></span><span class="d">---------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h388">core/src/main/res/layout/device_spoofer_activity.xml</a></td><td> | </td><td class="num">28</td><td><span class="i"></span><span class="d">----------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h389">core/src/main/res/layout/map.xml</a></td><td> | </td><td class="num">44</td><td><span class="i"></span><span class="d">--------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h390">core/src/main/res/layout/precise_location_dialog.xml</a></td><td> | </td><td class="num">29</td><td><span class="i"></span><span class="d">-----------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h391">core/src/main/res/values/arrays.xml</a></td><td> | </td><td class="num">7</td><td><span class="i"></span><span class="d">-------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h392">core/src/main/res/values/colors.xml</a></td><td> | </td><td class="num">7</td><td><span class="i"></span><span class="d">-------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h393">core/src/main/res/values/launcher_icon_background.xml</a></td><td> | </td><td class="num">5</td><td><span class="i"></span><span class="d">-----</span></td></tr>
<tr><td class="D">D</td><td><a href="#h394">core/src/main/res/values/strings.xml</a></td><td> | </td><td class="num">4</td><td><span class="i"></span><span class="d">----</span></td></tr>
<tr><td class="D">D</td><td><a href="#h395">core/src/main/res/values/themes.xml</a></td><td> | </td><td class="num">13</td><td><span class="i"></span><span class="d">-------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h396">settings.gradle.kts</a></td><td> | </td><td class="num">1</td><td><span class="i">+</span><span class="d"></span></td></tr>
</table></pre><pre>397 files changed, 11161 insertions(+), 11222 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/app/build.gradle.kts.html">app/build.gradle.kts</a> b/<a href="../file/app/build.gradle.kts.html">app/build.gradle.kts</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -127,6 +127,7 @@ dependencies {
</a>     }
 
     implementation(project(&quot;:core&quot;))
<a href="#h0-0-3" id="h0-0-3" class="i">+    implementation(project(&quot;:common&quot;))
</a>     implementation(libs.androidx.documentfile)
     implementation(libs.gson)
     implementation(libs.ffmpeg.kit)
<b>diff --git a/<a id="h1" href="../file/app/src/main/AndroidManifest.xml.html">app/src/main/AndroidManifest.xml</a> b/<a href="../file/app/src/main/AndroidManifest.xml.html">app/src/main/AndroidManifest.xml</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -28,7 +28,7 @@
</a>             android:value=&quot;93&quot; /&gt;
         &lt;meta-data
             android:name=&quot;xposedscope&quot;
<a href="#h1-0-3" id="h1-0-3" class="d">-            android:resource=&quot;@array/xposed_scope&quot; /&gt;
</a><a href="#h1-0-4" id="h1-0-4" class="i">+            android:value=&quot;com.snapchat.android&quot; /&gt;
</a> 
         &lt;service
             android:name=&quot;.bridge.BridgeService&quot;
<b>diff --git a/<a id="h2" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/LogManager.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/LogManager.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/LogManager.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/LogManager.kt</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -3,9 +3,9 @@ package me.rhunk.snapenhance
</a> import android.content.SharedPreferences
 import android.util.Log
 import com.google.gson.GsonBuilder
<a href="#h2-0-3" id="h2-0-3" class="d">-import me.rhunk.snapenhance.core.logger.AbstractLogger
</a><a href="#h2-0-4" id="h2-0-4" class="d">-import me.rhunk.snapenhance.core.logger.LogChannel
</a><a href="#h2-0-5" id="h2-0-5" class="d">-import me.rhunk.snapenhance.core.logger.LogLevel
</a><a href="#h2-0-6" id="h2-0-6" class="i">+import me.rhunk.snapenhance.common.logger.AbstractLogger
</a><a href="#h2-0-7" id="h2-0-7" class="i">+import me.rhunk.snapenhance.common.logger.LogChannel
</a><a href="#h2-0-8" id="h2-0-8" class="i">+import me.rhunk.snapenhance.common.logger.LogLevel
</a> import java.io.File
 import java.io.OutputStream
 import java.io.RandomAccessFile
<b>diff --git a/<a id="h3" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/RemoteSideContext.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/RemoteSideContext.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/RemoteSideContext.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/RemoteSideContext.kt</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -17,10 +17,10 @@ import coil.memory.MemoryCache
</a> import kotlinx.coroutines.CoroutineScope
 import kotlinx.coroutines.Dispatchers
 import me.rhunk.snapenhance.bridge.BridgeService
<a href="#h3-0-3" id="h3-0-3" class="d">-import me.rhunk.snapenhance.core.BuildConfig
</a><a href="#h3-0-4" id="h3-0-4" class="d">-import me.rhunk.snapenhance.core.bridge.wrapper.LocaleWrapper
</a><a href="#h3-0-5" id="h3-0-5" class="d">-import me.rhunk.snapenhance.core.bridge.wrapper.MappingsWrapper
</a><a href="#h3-0-6" id="h3-0-6" class="d">-import me.rhunk.snapenhance.core.config.ModConfig
</a><a href="#h3-0-7" id="h3-0-7" class="i">+import me.rhunk.snapenhance.common.BuildConfig
</a><a href="#h3-0-8" id="h3-0-8" class="i">+import me.rhunk.snapenhance.common.bridge.wrapper.LocaleWrapper
</a><a href="#h3-0-9" id="h3-0-9" class="i">+import me.rhunk.snapenhance.common.bridge.wrapper.MappingsWrapper
</a><a href="#h3-0-10" id="h3-0-10" class="i">+import me.rhunk.snapenhance.common.config.ModConfig
</a> import me.rhunk.snapenhance.download.DownloadTaskManager
 import me.rhunk.snapenhance.e2ee.E2EEImplementation
 import me.rhunk.snapenhance.messaging.ModDatabase
<b>diff --git a/<a id="h4" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/BridgeService.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/BridgeService.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/BridgeService.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/BridgeService.kt</a></b>
<a href="#h4-0" id="h4-0" class="h">@@ -5,16 +5,16 @@ import android.content.Intent
</a> import android.os.IBinder
 import me.rhunk.snapenhance.RemoteSideContext
 import me.rhunk.snapenhance.SharedContextHolder
<a href="#h4-0-3" id="h4-0-3" class="d">-import me.rhunk.snapenhance.core.bridge.types.BridgeFileType
</a><a href="#h4-0-4" id="h4-0-4" class="d">-import me.rhunk.snapenhance.core.bridge.types.FileActionType
</a><a href="#h4-0-5" id="h4-0-5" class="d">-import me.rhunk.snapenhance.core.bridge.wrapper.LocaleWrapper
</a><a href="#h4-0-6" id="h4-0-6" class="d">-import me.rhunk.snapenhance.core.bridge.wrapper.MessageLoggerWrapper
</a><a href="#h4-0-7" id="h4-0-7" class="d">-import me.rhunk.snapenhance.core.database.objects.FriendInfo
</a><a href="#h4-0-8" id="h4-0-8" class="d">-import me.rhunk.snapenhance.core.logger.LogLevel
</a><a href="#h4-0-9" id="h4-0-9" class="d">-import me.rhunk.snapenhance.core.messaging.MessagingFriendInfo
</a><a href="#h4-0-10" id="h4-0-10" class="d">-import me.rhunk.snapenhance.core.messaging.MessagingGroupInfo
</a><a href="#h4-0-11" id="h4-0-11" class="d">-import me.rhunk.snapenhance.core.messaging.SocialScope
</a><a href="#h4-0-12" id="h4-0-12" class="d">-import me.rhunk.snapenhance.core.util.SerializableDataObject
</a><a href="#h4-0-13" id="h4-0-13" class="i">+import me.rhunk.snapenhance.common.bridge.types.BridgeFileType
</a><a href="#h4-0-14" id="h4-0-14" class="i">+import me.rhunk.snapenhance.common.bridge.types.FileActionType
</a><a href="#h4-0-15" id="h4-0-15" class="i">+import me.rhunk.snapenhance.common.bridge.wrapper.LocaleWrapper
</a><a href="#h4-0-16" id="h4-0-16" class="i">+import me.rhunk.snapenhance.common.bridge.wrapper.MessageLoggerWrapper
</a><a href="#h4-0-17" id="h4-0-17" class="i">+import me.rhunk.snapenhance.common.data.MessagingFriendInfo
</a><a href="#h4-0-18" id="h4-0-18" class="i">+import me.rhunk.snapenhance.common.data.MessagingGroupInfo
</a><a href="#h4-0-19" id="h4-0-19" class="i">+import me.rhunk.snapenhance.common.data.SocialScope
</a><a href="#h4-0-20" id="h4-0-20" class="i">+import me.rhunk.snapenhance.common.database.impl.FriendInfo
</a><a href="#h4-0-21" id="h4-0-21" class="i">+import me.rhunk.snapenhance.common.logger.LogLevel
</a><a href="#h4-0-22" id="h4-0-22" class="i">+import me.rhunk.snapenhance.common.util.SerializableDataObject
</a> import me.rhunk.snapenhance.download.DownloadProcessor
 import kotlin.system.measureTimeMillis
 
<b>diff --git a/<a id="h5" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/ForceStartActivity.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/ForceStartActivity.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/ForceStartActivity.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/ForceStartActivity.kt</a></b>
<a href="#h5-0" id="h5-0" class="h">@@ -3,8 +3,8 @@ package me.rhunk.snapenhance.bridge
</a> import android.app.Activity
 import android.content.Intent
 import android.os.Bundle
<a href="#h5-0-3" id="h5-0-3" class="d">-import me.rhunk.snapenhance.Constants
</a> import me.rhunk.snapenhance.SharedContextHolder
<a href="#h5-0-5" id="h5-0-5" class="i">+import me.rhunk.snapenhance.common.Constants
</a> 
 class ForceStartActivity : Activity() {
     override fun onCreate(savedInstanceState: Bundle?) {
<b>diff --git a/<a id="h6" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadObject.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadObject.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadObject.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadObject.kt</a></b>
<a href="#h6-0" id="h6-0" class="h">@@ -1,8 +1,8 @@
</a> package me.rhunk.snapenhance.download
 
 import kotlinx.coroutines.Job
<a href="#h6-0-3" id="h6-0-3" class="d">-import me.rhunk.snapenhance.core.download.data.DownloadMetadata
</a><a href="#h6-0-4" id="h6-0-4" class="d">-import me.rhunk.snapenhance.core.download.data.DownloadStage
</a><a href="#h6-0-5" id="h6-0-5" class="i">+import me.rhunk.snapenhance.common.data.download.DownloadMetadata
</a><a href="#h6-0-6" id="h6-0-6" class="i">+import me.rhunk.snapenhance.common.data.download.DownloadStage
</a> 
 data class DownloadObject(
     var downloadId: Int = 0,
<b>diff --git a/<a id="h7" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadProcessor.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadProcessor.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadProcessor.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadProcessor.kt</a></b>
<a href="#h7-0" id="h7-0" class="h">@@ -13,14 +13,14 @@ import kotlinx.coroutines.job
</a> import kotlinx.coroutines.joinAll
 import kotlinx.coroutines.launch
 import kotlinx.coroutines.runBlocking
<a href="#h7-0-3" id="h7-0-3" class="d">-import me.rhunk.snapenhance.Constants
</a> import me.rhunk.snapenhance.RemoteSideContext
 import me.rhunk.snapenhance.bridge.DownloadCallback
<a href="#h7-0-6" id="h7-0-6" class="d">-import me.rhunk.snapenhance.core.download.DownloadManagerClient
</a><a href="#h7-0-7" id="h7-0-7" class="d">-import me.rhunk.snapenhance.core.download.data.*
</a><a href="#h7-0-8" id="h7-0-8" class="d">-import me.rhunk.snapenhance.core.util.download.RemoteMediaResolver
</a><a href="#h7-0-9" id="h7-0-9" class="d">-import me.rhunk.snapenhance.core.util.snap.MediaDownloaderHelper
</a><a href="#h7-0-10" id="h7-0-10" class="d">-import me.rhunk.snapenhance.data.FileType
</a><a href="#h7-0-11" id="h7-0-11" class="i">+import me.rhunk.snapenhance.common.Constants
</a><a href="#h7-0-12" id="h7-0-12" class="i">+import me.rhunk.snapenhance.common.ReceiversConfig
</a><a href="#h7-0-13" id="h7-0-13" class="i">+import me.rhunk.snapenhance.common.data.FileType
</a><a href="#h7-0-14" id="h7-0-14" class="i">+import me.rhunk.snapenhance.common.data.download.*
</a><a href="#h7-0-15" id="h7-0-15" class="i">+import me.rhunk.snapenhance.common.util.snap.MediaDownloaderHelper
</a><a href="#h7-0-16" id="h7-0-16" class="i">+import me.rhunk.snapenhance.common.util.snap.RemoteMediaResolver
</a> import java.io.File
 import java.io.InputStream
 import java.net.HttpURLConnection
<a href="#h7-1" id="h7-1" class="h">@@ -296,8 +296,8 @@ class DownloadProcessor (
</a> 
     fun onReceive(intent: Intent) {
         remoteSideContext.coroutineScope.launch {
<a href="#h7-1-3" id="h7-1-3" class="d">-            val downloadMetadata = gson.fromJson(intent.getStringExtra(DownloadManagerClient.DOWNLOAD_METADATA_EXTRA)!!, DownloadMetadata::class.java)
</a><a href="#h7-1-4" id="h7-1-4" class="d">-            val downloadRequest = gson.fromJson(intent.getStringExtra(DownloadManagerClient.DOWNLOAD_REQUEST_EXTRA)!!, DownloadRequest::class.java)
</a><a href="#h7-1-5" id="h7-1-5" class="i">+            val downloadMetadata = gson.fromJson(intent.getStringExtra(ReceiversConfig.DOWNLOAD_METADATA_EXTRA)!!, DownloadMetadata::class.java)
</a><a href="#h7-1-6" id="h7-1-6" class="i">+            val downloadRequest = gson.fromJson(intent.getStringExtra(ReceiversConfig.DOWNLOAD_REQUEST_EXTRA)!!, DownloadRequest::class.java)
</a> 
             remoteSideContext.downloadTaskManager.canDownloadMedia(downloadMetadata.mediaIdentifier)?.let { downloadStage -&gt;
                 translation[if (downloadStage.isFinalStage) {
<b>diff --git a/<a id="h8" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadTaskManager.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadTaskManager.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadTaskManager.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadTaskManager.kt</a></b>
<a href="#h8-0" id="h8-0" class="h">@@ -3,12 +3,12 @@ package me.rhunk.snapenhance.download
</a> import android.annotation.SuppressLint
 import android.content.Context
 import android.database.sqlite.SQLiteDatabase
<a href="#h8-0-3" id="h8-0-3" class="d">-import me.rhunk.snapenhance.core.download.data.DownloadMetadata
</a><a href="#h8-0-4" id="h8-0-4" class="d">-import me.rhunk.snapenhance.core.download.data.DownloadStage
</a><a href="#h8-0-5" id="h8-0-5" class="d">-import me.rhunk.snapenhance.core.download.data.MediaDownloadSource
</a><a href="#h8-0-6" id="h8-0-6" class="d">-import me.rhunk.snapenhance.core.util.SQLiteDatabaseHelper
</a><a href="#h8-0-7" id="h8-0-7" class="d">-import me.rhunk.snapenhance.core.util.ktx.getIntOrNull
</a><a href="#h8-0-8" id="h8-0-8" class="d">-import me.rhunk.snapenhance.core.util.ktx.getStringOrNull
</a><a href="#h8-0-9" id="h8-0-9" class="i">+import me.rhunk.snapenhance.common.data.download.DownloadMetadata
</a><a href="#h8-0-10" id="h8-0-10" class="i">+import me.rhunk.snapenhance.common.data.download.DownloadStage
</a><a href="#h8-0-11" id="h8-0-11" class="i">+import me.rhunk.snapenhance.common.data.download.MediaDownloadSource
</a><a href="#h8-0-12" id="h8-0-12" class="i">+import me.rhunk.snapenhance.common.util.SQLiteDatabaseHelper
</a><a href="#h8-0-13" id="h8-0-13" class="i">+import me.rhunk.snapenhance.common.util.ktx.getIntOrNull
</a><a href="#h8-0-14" id="h8-0-14" class="i">+import me.rhunk.snapenhance.common.util.ktx.getStringOrNull
</a> import java.util.concurrent.Executors
 
 class DownloadTaskManager {
<a href="#h8-1" id="h8-1" class="h">@@ -162,7 +162,8 @@ class DownloadTaskManager {
</a>                 metadata = DownloadMetadata(
                     outputPath = cursor.getStringOrNull(&quot;outputPath&quot;)!!,
                     mediaIdentifier = cursor.getStringOrNull(&quot;hash&quot;),
<a href="#h8-1-3" id="h8-1-3" class="d">-                    downloadSource = cursor.getStringOrNull(&quot;downloadSource&quot;) ?: MediaDownloadSource.NONE.key,
</a><a href="#h8-1-4" id="h8-1-4" class="i">+                    downloadSource = cursor.getStringOrNull(&quot;downloadSource&quot;)
</a><a href="#h8-1-5" id="h8-1-5" class="i">+                        ?: MediaDownloadSource.NONE.key,
</a>                     mediaAuthor = cursor.getStringOrNull(&quot;mediaAuthor&quot;),
                     iconUrl = cursor.getStringOrNull(&quot;iconUrl&quot;)
                 )
<b>diff --git a/<a id="h9" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/download/FFMpegProcessor.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/download/FFMpegProcessor.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/download/FFMpegProcessor.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/download/FFMpegProcessor.kt</a></b>
<a href="#h9-0" id="h9-0" class="h">@@ -5,9 +5,8 @@ import com.arthenica.ffmpegkit.FFmpegSession
</a> import com.arthenica.ffmpegkit.Level
 import kotlinx.coroutines.suspendCancellableCoroutine
 import me.rhunk.snapenhance.LogManager
<a href="#h9-0-3" id="h9-0-3" class="d">-import me.rhunk.snapenhance.core.Logger
</a><a href="#h9-0-4" id="h9-0-4" class="d">-import me.rhunk.snapenhance.core.config.impl.DownloaderConfig
</a><a href="#h9-0-5" id="h9-0-5" class="d">-import me.rhunk.snapenhance.core.logger.LogLevel
</a><a href="#h9-0-6" id="h9-0-6" class="i">+import me.rhunk.snapenhance.common.config.impl.DownloaderConfig
</a><a href="#h9-0-7" id="h9-0-7" class="i">+import me.rhunk.snapenhance.common.logger.LogLevel
</a> import java.io.File
 import java.util.concurrent.Executors
 
<a href="#h9-1" id="h9-1" class="h">@@ -71,7 +70,7 @@ class FFMpegProcessor(
</a>             }
         }
 
<a href="#h9-1-3" id="h9-1-3" class="d">-        Logger.directDebug(&quot;arguments: $stringBuilder&quot;, &quot;FFMpegProcessor&quot;)
</a><a href="#h9-1-4" id="h9-1-4" class="i">+        logManager.debug(&quot;arguments: $stringBuilder&quot;, &quot;FFMpegProcessor&quot;)
</a> 
         FFmpegKit.executeAsync(stringBuilder.toString(),
             { session -&gt;
<b>diff --git a/<a id="h10" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/messaging/ModDatabase.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/messaging/ModDatabase.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/messaging/ModDatabase.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/messaging/ModDatabase.kt</a></b>
<a href="#h10-0" id="h10-0" class="h">@@ -2,16 +2,16 @@ package me.rhunk.snapenhance.messaging
</a> 
 import android.database.sqlite.SQLiteDatabase
 import me.rhunk.snapenhance.RemoteSideContext
<a href="#h10-0-3" id="h10-0-3" class="d">-import me.rhunk.snapenhance.core.database.objects.FriendInfo
</a><a href="#h10-0-4" id="h10-0-4" class="d">-import me.rhunk.snapenhance.core.messaging.FriendStreaks
</a><a href="#h10-0-5" id="h10-0-5" class="d">-import me.rhunk.snapenhance.core.messaging.MessagingFriendInfo
</a><a href="#h10-0-6" id="h10-0-6" class="d">-import me.rhunk.snapenhance.core.messaging.MessagingGroupInfo
</a><a href="#h10-0-7" id="h10-0-7" class="d">-import me.rhunk.snapenhance.core.messaging.MessagingRuleType
</a><a href="#h10-0-8" id="h10-0-8" class="d">-import me.rhunk.snapenhance.core.util.SQLiteDatabaseHelper
</a><a href="#h10-0-9" id="h10-0-9" class="d">-import me.rhunk.snapenhance.core.util.ktx.getInteger
</a><a href="#h10-0-10" id="h10-0-10" class="d">-import me.rhunk.snapenhance.core.util.ktx.getLongOrNull
</a><a href="#h10-0-11" id="h10-0-11" class="d">-import me.rhunk.snapenhance.core.util.ktx.getStringOrNull
</a><a href="#h10-0-12" id="h10-0-12" class="d">-import me.rhunk.snapenhance.scripting.type.ModuleInfo
</a><a href="#h10-0-13" id="h10-0-13" class="i">+import me.rhunk.snapenhance.common.data.FriendStreaks
</a><a href="#h10-0-14" id="h10-0-14" class="i">+import me.rhunk.snapenhance.common.data.MessagingFriendInfo
</a><a href="#h10-0-15" id="h10-0-15" class="i">+import me.rhunk.snapenhance.common.data.MessagingGroupInfo
</a><a href="#h10-0-16" id="h10-0-16" class="i">+import me.rhunk.snapenhance.common.data.MessagingRuleType
</a><a href="#h10-0-17" id="h10-0-17" class="i">+import me.rhunk.snapenhance.common.database.impl.FriendInfo
</a><a href="#h10-0-18" id="h10-0-18" class="i">+import me.rhunk.snapenhance.common.scripting.type.ModuleInfo
</a><a href="#h10-0-19" id="h10-0-19" class="i">+import me.rhunk.snapenhance.common.util.SQLiteDatabaseHelper
</a><a href="#h10-0-20" id="h10-0-20" class="i">+import me.rhunk.snapenhance.common.util.ktx.getInteger
</a><a href="#h10-0-21" id="h10-0-21" class="i">+import me.rhunk.snapenhance.common.util.ktx.getLongOrNull
</a><a href="#h10-0-22" id="h10-0-22" class="i">+import me.rhunk.snapenhance.common.util.ktx.getStringOrNull
</a> import java.util.concurrent.Executors
 
 
<a href="#h10-1" id="h10-1" class="h">@@ -75,11 +75,13 @@ class ModDatabase(
</a>         return database.rawQuery(&quot;SELECT * FROM groups&quot;, null).use { cursor -&gt;
             val groups = mutableListOf&lt;MessagingGroupInfo&gt;()
             while (cursor.moveToNext()) {
<a href="#h10-1-3" id="h10-1-3" class="d">-                groups.add(MessagingGroupInfo(
</a><a href="#h10-1-4" id="h10-1-4" class="i">+                groups.add(
</a><a href="#h10-1-5" id="h10-1-5" class="i">+                    MessagingGroupInfo(
</a>                     conversationId = cursor.getStringOrNull(&quot;conversationId&quot;)!!,
                     name = cursor.getStringOrNull(&quot;name&quot;)!!,
                     participantsCount = cursor.getInteger(&quot;participantsCount&quot;)
<a href="#h10-1-9" id="h10-1-9" class="d">-                ))
</a><a href="#h10-1-10" id="h10-1-10" class="i">+                )
</a><a href="#h10-1-11" id="h10-1-11" class="i">+                )
</a>             }
             groups
         }
<a href="#h10-2" id="h10-2" class="h">@@ -90,13 +92,15 @@ class ModDatabase(
</a>             val friends = mutableListOf&lt;MessagingFriendInfo&gt;()
             while (cursor.moveToNext()) {
                 runCatching {
<a href="#h10-2-3" id="h10-2-3" class="d">-                    friends.add(MessagingFriendInfo(
</a><a href="#h10-2-4" id="h10-2-4" class="i">+                    friends.add(
</a><a href="#h10-2-5" id="h10-2-5" class="i">+                        MessagingFriendInfo(
</a>                         userId = cursor.getStringOrNull(&quot;userId&quot;)!!,
                         displayName = cursor.getStringOrNull(&quot;displayName&quot;),
                         mutableUsername = cursor.getStringOrNull(&quot;mutableUsername&quot;)!!,
                         bitmojiId = cursor.getStringOrNull(&quot;bitmojiId&quot;),
                         selfieId = cursor.getStringOrNull(&quot;selfieId&quot;)
<a href="#h10-2-11" id="h10-2-11" class="d">-                    ))
</a><a href="#h10-2-12" id="h10-2-12" class="i">+                    )
</a><a href="#h10-2-13" id="h10-2-13" class="i">+                    )
</a>                 }.onFailure {
                     context.log.error(&quot;Failed to parse friend&quot;, it)
                 }
<b>diff --git a/<a id="h11" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/messaging/StreaksReminder.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/messaging/StreaksReminder.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/messaging/StreaksReminder.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/messaging/StreaksReminder.kt</a></b>
<a href="#h11-0" id="h11-0" class="h">@@ -14,7 +14,7 @@ import me.rhunk.snapenhance.R
</a> import me.rhunk.snapenhance.RemoteSideContext
 import me.rhunk.snapenhance.SharedContextHolder
 import me.rhunk.snapenhance.bridge.ForceStartActivity
<a href="#h11-0-3" id="h11-0-3" class="d">-import me.rhunk.snapenhance.core.util.snap.BitmojiSelfie
</a><a href="#h11-0-4" id="h11-0-4" class="i">+import me.rhunk.snapenhance.common.util.snap.BitmojiSelfie
</a> import me.rhunk.snapenhance.ui.util.ImageRequestHelper
 
 class StreaksReminder(
<b>diff --git a/<a id="h12" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/scripting/RemoteScriptManager.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/scripting/RemoteScriptManager.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/scripting/RemoteScriptManager.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/scripting/RemoteScriptManager.kt</a></b>
<a href="#h12-0" id="h12-0" class="h">@@ -5,11 +5,12 @@ import androidx.documentfile.provider.DocumentFile
</a> import me.rhunk.snapenhance.RemoteSideContext
 import me.rhunk.snapenhance.bridge.scripting.IPCListener
 import me.rhunk.snapenhance.bridge.scripting.IScripting
<a href="#h12-0-3" id="h12-0-3" class="i">+import me.rhunk.snapenhance.common.scripting.ScriptRuntime
</a><a href="#h12-0-4" id="h12-0-4" class="i">+import me.rhunk.snapenhance.common.scripting.type.ModuleInfo
</a> import me.rhunk.snapenhance.scripting.impl.IPCListeners
<a href="#h12-0-6" id="h12-0-6" class="i">+import me.rhunk.snapenhance.scripting.impl.RemoteManagerIPC
</a> import me.rhunk.snapenhance.scripting.impl.ui.InterfaceBuilder
 import me.rhunk.snapenhance.scripting.impl.ui.InterfaceManager
<a href="#h12-0-9" id="h12-0-9" class="d">-import me.rhunk.snapenhance.scripting.impl.RemoteManagerIPC
</a><a href="#h12-0-10" id="h12-0-10" class="d">-import me.rhunk.snapenhance.scripting.type.ModuleInfo
</a> import java.io.InputStream
 
 class RemoteScriptManager(
<b>diff --git a/<a id="h13" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/scripting/impl/RemoteManagerIPC.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/scripting/impl/RemoteManagerIPC.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/scripting/impl/RemoteManagerIPC.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/scripting/impl/RemoteManagerIPC.kt</a></b>
<a href="#h13-0" id="h13-0" class="h">@@ -2,10 +2,10 @@ package me.rhunk.snapenhance.scripting.impl
</a> 
 import android.os.DeadObjectException
 import me.rhunk.snapenhance.bridge.scripting.IPCListener
<a href="#h13-0-3" id="h13-0-3" class="d">-import me.rhunk.snapenhance.core.logger.AbstractLogger
</a><a href="#h13-0-4" id="h13-0-4" class="d">-import me.rhunk.snapenhance.scripting.IPCInterface
</a><a href="#h13-0-5" id="h13-0-5" class="d">-import me.rhunk.snapenhance.scripting.Listener
</a><a href="#h13-0-6" id="h13-0-6" class="d">-import me.rhunk.snapenhance.scripting.type.ModuleInfo
</a><a href="#h13-0-7" id="h13-0-7" class="i">+import me.rhunk.snapenhance.common.logger.AbstractLogger
</a><a href="#h13-0-8" id="h13-0-8" class="i">+import me.rhunk.snapenhance.common.scripting.IPCInterface
</a><a href="#h13-0-9" id="h13-0-9" class="i">+import me.rhunk.snapenhance.common.scripting.Listener
</a><a href="#h13-0-10" id="h13-0-10" class="i">+import me.rhunk.snapenhance.common.scripting.type.ModuleInfo
</a> import java.util.concurrent.ConcurrentHashMap
 
 typealias IPCListeners = ConcurrentHashMap&lt;String, MutableMap&lt;String, MutableSet&lt;IPCListener&gt;&gt;&gt;  // channel, eventName -&gt; listeners
<b>diff --git a/<a id="h14" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/scripting/impl/ui/InterfaceManager.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/scripting/impl/ui/InterfaceManager.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/scripting/impl/ui/InterfaceManager.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/scripting/impl/ui/InterfaceManager.kt</a></b>
<a href="#h14-0" id="h14-0" class="h">@@ -1,10 +1,10 @@
</a> package me.rhunk.snapenhance.scripting.impl.ui
 
<a href="#h14-0-2" id="h14-0-2" class="d">-import me.rhunk.snapenhance.core.logger.AbstractLogger
</a><a href="#h14-0-3" id="h14-0-3" class="i">+import me.rhunk.snapenhance.common.logger.AbstractLogger
</a><a href="#h14-0-4" id="h14-0-4" class="i">+import me.rhunk.snapenhance.common.scripting.type.ModuleInfo
</a> import me.rhunk.snapenhance.scripting.impl.ui.components.Node
 import me.rhunk.snapenhance.scripting.impl.ui.components.NodeType
 import me.rhunk.snapenhance.scripting.impl.ui.components.impl.RowColumnNode
<a href="#h14-0-8" id="h14-0-8" class="d">-import me.rhunk.snapenhance.scripting.type.ModuleInfo
</a> import org.mozilla.javascript.Context
 import org.mozilla.javascript.Function
 import org.mozilla.javascript.annotations.JSFunction
<b>diff --git a/<a id="h15" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/MapActivity.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/MapActivity.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/MapActivity.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/MapActivity.kt</a></b>
<a href="#h15-0" id="h15-0" class="h">@@ -8,7 +8,7 @@ import android.os.Bundle
</a> import android.view.MotionEvent
 import android.widget.Button
 import android.widget.EditText
<a href="#h15-0-3" id="h15-0-3" class="d">-import me.rhunk.snapenhance.core.R
</a><a href="#h15-0-4" id="h15-0-4" class="i">+import me.rhunk.snapenhance.R
</a> import org.osmdroid.config.Configuration
 import org.osmdroid.tileprovider.tilesource.TileSourceFactory
 import org.osmdroid.util.GeoPoint
<b>diff --git a/<a id="h16" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/data/Updater.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/data/Updater.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/data/Updater.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/data/Updater.kt</a></b>
<a href="#h16-0" id="h16-0" class="h">@@ -1,7 +1,7 @@
</a> package me.rhunk.snapenhance.ui.manager.data
 
 import com.google.gson.JsonParser
<a href="#h16-0-3" id="h16-0-3" class="d">-import me.rhunk.snapenhance.core.BuildConfig
</a><a href="#h16-0-4" id="h16-0-4" class="i">+import me.rhunk.snapenhance.common.BuildConfig
</a> import okhttp3.OkHttpClient
 import okhttp3.Request
 
<b>diff --git a/<a id="h17" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/downloads/DownloadsSection.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/downloads/DownloadsSection.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/downloads/DownloadsSection.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/downloads/DownloadsSection.kt</a></b>
<a href="#h17-0" id="h17-0" class="h">@@ -28,8 +28,8 @@ import coil.compose.rememberAsyncImagePainter
</a> import kotlinx.coroutines.Dispatchers
 import kotlinx.coroutines.future.asCompletableFuture
 import kotlinx.coroutines.launch
<a href="#h17-0-3" id="h17-0-3" class="d">-import me.rhunk.snapenhance.core.download.data.MediaDownloadSource
</a><a href="#h17-0-4" id="h17-0-4" class="d">-import me.rhunk.snapenhance.data.FileType
</a><a href="#h17-0-5" id="h17-0-5" class="i">+import me.rhunk.snapenhance.common.data.FileType
</a><a href="#h17-0-6" id="h17-0-6" class="i">+import me.rhunk.snapenhance.common.data.download.MediaDownloadSource
</a> import me.rhunk.snapenhance.download.DownloadObject
 import me.rhunk.snapenhance.ui.manager.Section
 import me.rhunk.snapenhance.ui.util.BitmojiImage
<b>diff --git a/<a id="h18" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/features/FeaturesSection.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/features/FeaturesSection.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/features/FeaturesSection.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/features/FeaturesSection.kt</a></b>
<a href="#h18-0" id="h18-0" class="h">@@ -37,7 +37,7 @@ import androidx.navigation.navigation
</a> import kotlinx.coroutines.Job
 import kotlinx.coroutines.delay
 import kotlinx.coroutines.launch
<a href="#h18-0-3" id="h18-0-3" class="d">-import me.rhunk.snapenhance.core.config.*
</a><a href="#h18-0-4" id="h18-0-4" class="i">+import me.rhunk.snapenhance.common.config.*
</a> import me.rhunk.snapenhance.ui.manager.MainActivity
 import me.rhunk.snapenhance.ui.manager.Section
 import me.rhunk.snapenhance.ui.util.*
<b>diff --git a/<a id="h19" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/home/HomeSubSection.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/home/HomeSubSection.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/home/HomeSubSection.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/home/HomeSubSection.kt</a></b>
<a href="#h19-0" id="h19-0" class="h">@@ -33,8 +33,8 @@ import kotlinx.coroutines.Dispatchers
</a> import kotlinx.coroutines.launch
 import me.rhunk.snapenhance.LogReader
 import me.rhunk.snapenhance.RemoteSideContext
<a href="#h19-0-3" id="h19-0-3" class="d">-import me.rhunk.snapenhance.core.logger.LogChannel
</a><a href="#h19-0-4" id="h19-0-4" class="d">-import me.rhunk.snapenhance.core.logger.LogLevel
</a><a href="#h19-0-5" id="h19-0-5" class="i">+import me.rhunk.snapenhance.common.logger.LogChannel
</a><a href="#h19-0-6" id="h19-0-6" class="i">+import me.rhunk.snapenhance.common.logger.LogLevel
</a> 
 class HomeSubSection(
     private val context: RemoteSideContext
<b>diff --git a/<a id="h20" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/home/SettingsSection.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/home/SettingsSection.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/home/SettingsSection.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/home/SettingsSection.kt</a></b>
<a href="#h20-0" id="h20-0" class="h">@@ -20,10 +20,9 @@ import androidx.compose.ui.text.font.FontWeight
</a> import androidx.compose.ui.unit.dp
 import androidx.compose.ui.unit.sp
 import androidx.compose.ui.window.Dialog
<a href="#h20-0-3" id="h20-0-3" class="d">-import me.rhunk.snapenhance.Constants
</a><a href="#h20-0-4" id="h20-0-4" class="d">-import me.rhunk.snapenhance.action.EnumAction
</a><a href="#h20-0-5" id="h20-0-5" class="d">-import me.rhunk.snapenhance.core.bridge.types.BridgeFileType
</a><a href="#h20-0-6" id="h20-0-6" class="d">-import me.rhunk.snapenhance.manager.impl.ActionManager
</a><a href="#h20-0-7" id="h20-0-7" class="i">+import me.rhunk.snapenhance.common.Constants
</a><a href="#h20-0-8" id="h20-0-8" class="i">+import me.rhunk.snapenhance.common.action.EnumAction
</a><a href="#h20-0-9" id="h20-0-9" class="i">+import me.rhunk.snapenhance.common.bridge.types.BridgeFileType
</a> import me.rhunk.snapenhance.ui.manager.Section
 import me.rhunk.snapenhance.ui.util.AlertDialogs
 
<a href="#h20-1" id="h20-1" class="h">@@ -83,7 +82,7 @@ class SettingsSection : Section() {
</a> 
     private fun launchActionIntent(action: EnumAction) {
         val intent = context.androidContext.packageManager.getLaunchIntentForPackage(Constants.SNAPCHAT_PACKAGE_NAME)
<a href="#h20-1-3" id="h20-1-3" class="d">-        intent?.putExtra(ActionManager.ACTION_PARAMETER, action.key)
</a><a href="#h20-1-4" id="h20-1-4" class="i">+        intent?.putExtra(EnumAction.ACTION_PARAMETER, action.key)
</a>         context.androidContext.startActivity(intent)
     }
 
<b>diff --git a/<a id="h21" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/scripting/ScriptInterface.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/scripting/ScriptInterface.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/scripting/ScriptInterface.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/scripting/ScriptInterface.kt</a></b>
<a href="#h21-0" id="h21-0" class="h">@@ -12,7 +12,7 @@ import androidx.compose.ui.graphics.Color
</a> import androidx.compose.ui.unit.dp
 import androidx.compose.ui.unit.sp
 import kotlinx.coroutines.launch
<a href="#h21-0-3" id="h21-0-3" class="d">-import me.rhunk.snapenhance.core.Logger
</a><a href="#h21-0-4" id="h21-0-4" class="i">+import me.rhunk.snapenhance.common.logger.AbstractLogger
</a> import me.rhunk.snapenhance.scripting.impl.ui.InterfaceBuilder
 import me.rhunk.snapenhance.scripting.impl.ui.components.Node
 import me.rhunk.snapenhance.scripting.impl.ui.components.NodeType
<a href="#h21-1" id="h21-1" class="h">@@ -54,7 +54,7 @@ private fun DrawNode(node: Node) {
</a>         runCatching {
             callback()
         }.onFailure {
<a href="#h21-1-3" id="h21-1-3" class="d">-            Logger.directError(&quot;Error running callback&quot;, it)
</a><a href="#h21-1-4" id="h21-1-4" class="i">+            AbstractLogger.directError(&quot;Error running callback&quot;, it)
</a>         }
     }
 
<b>diff --git a/<a id="h22" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/scripting/ScriptsSection.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/scripting/ScriptsSection.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/scripting/ScriptsSection.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/scripting/ScriptsSection.kt</a></b>
<a href="#h22-0" id="h22-0" class="h">@@ -13,7 +13,7 @@ import androidx.compose.ui.unit.dp
</a> import androidx.compose.ui.unit.sp
 import kotlinx.coroutines.delay
 import kotlinx.coroutines.launch
<a href="#h22-0-3" id="h22-0-3" class="d">-import me.rhunk.snapenhance.scripting.type.ModuleInfo
</a><a href="#h22-0-4" id="h22-0-4" class="i">+import me.rhunk.snapenhance.common.scripting.type.ModuleInfo
</a> import me.rhunk.snapenhance.ui.manager.Section
 import me.rhunk.snapenhance.ui.util.pullrefresh.PullRefreshIndicator
 import me.rhunk.snapenhance.ui.util.pullrefresh.pullRefresh
<b>diff --git a/<a id="h23" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/social/AddFriendDialog.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/social/AddFriendDialog.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/social/AddFriendDialog.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/social/AddFriendDialog.kt</a></b>
<a href="#h23-0" id="h23-0" class="h">@@ -24,11 +24,11 @@ import kotlinx.coroutines.delay
</a> import kotlinx.coroutines.launch
 import kotlinx.coroutines.withContext
 import me.rhunk.snapenhance.RemoteSideContext
<a href="#h23-0-3" id="h23-0-3" class="d">-import me.rhunk.snapenhance.core.bridge.BridgeClient
</a><a href="#h23-0-4" id="h23-0-4" class="d">-import me.rhunk.snapenhance.core.messaging.MessagingFriendInfo
</a><a href="#h23-0-5" id="h23-0-5" class="d">-import me.rhunk.snapenhance.core.messaging.MessagingGroupInfo
</a><a href="#h23-0-6" id="h23-0-6" class="d">-import me.rhunk.snapenhance.core.messaging.SocialScope
</a><a href="#h23-0-7" id="h23-0-7" class="d">-import me.rhunk.snapenhance.core.util.snap.SnapWidgetBroadcastReceiverHelper
</a><a href="#h23-0-8" id="h23-0-8" class="i">+import me.rhunk.snapenhance.common.ReceiversConfig
</a><a href="#h23-0-9" id="h23-0-9" class="i">+import me.rhunk.snapenhance.common.data.MessagingFriendInfo
</a><a href="#h23-0-10" id="h23-0-10" class="i">+import me.rhunk.snapenhance.common.data.MessagingGroupInfo
</a><a href="#h23-0-11" id="h23-0-11" class="i">+import me.rhunk.snapenhance.common.data.SocialScope
</a><a href="#h23-0-12" id="h23-0-12" class="i">+import me.rhunk.snapenhance.common.util.snap.SnapWidgetBroadcastReceiverHelper
</a> 
 class AddFriendDialog(
     private val context: RemoteSideContext,
<a href="#h23-1" id="h23-1" class="h">@@ -128,7 +128,7 @@ class AddFriendDialog(
</a>                 timeoutJob?.cancel()
                 hasFetchError = false
             }
<a href="#h23-1-3" id="h23-1-3" class="d">-            SnapWidgetBroadcastReceiverHelper.create(BridgeClient.BRIDGE_SYNC_ACTION) {}.also {
</a><a href="#h23-1-4" id="h23-1-4" class="i">+            SnapWidgetBroadcastReceiverHelper.create(ReceiversConfig.BRIDGE_SYNC_ACTION) {}.also {
</a>                 runCatching {
                     context.androidContext.sendBroadcast(it)
                 }.onFailure {
<b>diff --git a/<a id="h24" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/social/ScopeContent.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/social/ScopeContent.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/social/ScopeContent.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/social/ScopeContent.kt</a></b>
<a href="#h24-0" id="h24-0" class="h">@@ -22,9 +22,9 @@ import androidx.navigation.NavController
</a> import kotlinx.coroutines.CoroutineScope
 import kotlinx.coroutines.launch
 import me.rhunk.snapenhance.RemoteSideContext
<a href="#h24-0-3" id="h24-0-3" class="d">-import me.rhunk.snapenhance.core.messaging.MessagingRuleType
</a><a href="#h24-0-4" id="h24-0-4" class="d">-import me.rhunk.snapenhance.core.messaging.SocialScope
</a><a href="#h24-0-5" id="h24-0-5" class="d">-import me.rhunk.snapenhance.core.util.snap.BitmojiSelfie
</a><a href="#h24-0-6" id="h24-0-6" class="i">+import me.rhunk.snapenhance.common.data.MessagingRuleType
</a><a href="#h24-0-7" id="h24-0-7" class="i">+import me.rhunk.snapenhance.common.data.SocialScope
</a><a href="#h24-0-8" id="h24-0-8" class="i">+import me.rhunk.snapenhance.common.util.snap.BitmojiSelfie
</a> import me.rhunk.snapenhance.ui.util.AlertDialogs
 import me.rhunk.snapenhance.ui.util.BitmojiImage
 import me.rhunk.snapenhance.ui.util.Dialog
<b>diff --git a/<a id="h25" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/social/SocialSection.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/social/SocialSection.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/social/SocialSection.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/social/SocialSection.kt</a></b>
<a href="#h25-0" id="h25-0" class="h">@@ -27,10 +27,10 @@ import androidx.navigation.compose.composable
</a> import androidx.navigation.navigation
 import kotlinx.coroutines.launch
 import me.rhunk.snapenhance.R
<a href="#h25-0-3" id="h25-0-3" class="d">-import me.rhunk.snapenhance.core.messaging.MessagingFriendInfo
</a><a href="#h25-0-4" id="h25-0-4" class="d">-import me.rhunk.snapenhance.core.messaging.MessagingGroupInfo
</a><a href="#h25-0-5" id="h25-0-5" class="d">-import me.rhunk.snapenhance.core.messaging.SocialScope
</a><a href="#h25-0-6" id="h25-0-6" class="d">-import me.rhunk.snapenhance.core.util.snap.BitmojiSelfie
</a><a href="#h25-0-7" id="h25-0-7" class="i">+import me.rhunk.snapenhance.common.data.MessagingFriendInfo
</a><a href="#h25-0-8" id="h25-0-8" class="i">+import me.rhunk.snapenhance.common.data.MessagingGroupInfo
</a><a href="#h25-0-9" id="h25-0-9" class="i">+import me.rhunk.snapenhance.common.data.SocialScope
</a><a href="#h25-0-10" id="h25-0-10" class="i">+import me.rhunk.snapenhance.common.util.snap.BitmojiSelfie
</a> import me.rhunk.snapenhance.ui.manager.Section
 import me.rhunk.snapenhance.ui.util.AlertDialogs
 import me.rhunk.snapenhance.ui.util.BitmojiImage
<b>diff --git a/<a id="h26" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/screens/impl/PickLanguageScreen.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/screens/impl/PickLanguageScreen.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/screens/impl/PickLanguageScreen.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/screens/impl/PickLanguageScreen.kt</a></b>
<a href="#h26-0" id="h26-0" class="h">@@ -14,14 +14,18 @@ import androidx.compose.material3.Button
</a> import androidx.compose.material3.MaterialTheme
 import androidx.compose.material3.Surface
 import androidx.compose.material3.Text
<a href="#h26-0-3" id="h26-0-3" class="d">-import androidx.compose.runtime.*
</a><a href="#h26-0-4" id="h26-0-4" class="i">+import androidx.compose.runtime.Composable
</a><a href="#h26-0-5" id="h26-0-5" class="i">+import androidx.compose.runtime.getValue
</a><a href="#h26-0-6" id="h26-0-6" class="i">+import androidx.compose.runtime.mutableStateOf
</a><a href="#h26-0-7" id="h26-0-7" class="i">+import androidx.compose.runtime.remember
</a><a href="#h26-0-8" id="h26-0-8" class="i">+import androidx.compose.runtime.setValue
</a> import androidx.compose.ui.Alignment
 import androidx.compose.ui.Modifier
 import androidx.compose.ui.text.font.FontWeight
 import androidx.compose.ui.unit.dp
 import androidx.compose.ui.unit.sp
 import androidx.compose.ui.window.Dialog
<a href="#h26-0-15" id="h26-0-15" class="d">-import me.rhunk.snapenhance.core.bridge.wrapper.LocaleWrapper
</a><a href="#h26-0-16" id="h26-0-16" class="i">+import me.rhunk.snapenhance.common.bridge.wrapper.LocaleWrapper
</a> import me.rhunk.snapenhance.ui.setup.screens.SetupScreen
 import me.rhunk.snapenhance.ui.util.ObservableMutableState
 import java.util.Locale
<b>diff --git a/<a id="h27" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/util/ActivityLauncherHelper.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/util/ActivityLauncherHelper.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/util/ActivityLauncherHelper.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/util/ActivityLauncherHelper.kt</a></b>
<a href="#h27-0" id="h27-0" class="h">@@ -4,7 +4,7 @@ import android.content.Intent
</a> import androidx.activity.ComponentActivity
 import androidx.activity.result.ActivityResultLauncher
 import androidx.activity.result.contract.ActivityResultContracts
<a href="#h27-0-3" id="h27-0-3" class="d">-import me.rhunk.snapenhance.core.Logger
</a><a href="#h27-0-4" id="h27-0-4" class="i">+import me.rhunk.snapenhance.common.logger.AbstractLogger
</a> 
 typealias ActivityLauncherCallback = (resultCode: Int, intent: Intent?) -&gt; Unit
 
<a href="#h27-1" id="h27-1" class="h">@@ -17,7 +17,7 @@ class ActivityLauncherHelper(
</a>             runCatching {
                 callback?.let { it(if (result) ComponentActivity.RESULT_OK else ComponentActivity.RESULT_CANCELED, null) }
             }.onFailure {
<a href="#h27-1-3" id="h27-1-3" class="d">-                Logger.directError(&quot;Failed to process activity result&quot;, it)
</a><a href="#h27-1-4" id="h27-1-4" class="i">+                AbstractLogger.directError(&quot;Failed to process activity result&quot;, it)
</a>             }
             callback = null
         }
<a href="#h27-2" id="h27-2" class="h">@@ -27,7 +27,7 @@ class ActivityLauncherHelper(
</a>             runCatching {
                 callback?.let { it(result.resultCode, result.data) }
             }.onFailure {
<a href="#h27-2-3" id="h27-2-3" class="d">-                Logger.directError(&quot;Failed to process activity result&quot;, it)
</a><a href="#h27-2-4" id="h27-2-4" class="i">+                AbstractLogger.directError(&quot;Failed to process activity result&quot;, it)
</a>             }
             callback = null
         }
<b>diff --git a/<a id="h28" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/util/AlertDialogs.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/util/AlertDialogs.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/util/AlertDialogs.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/util/AlertDialogs.kt</a></b>
<a href="#h28-0" id="h28-0" class="h">@@ -22,9 +22,9 @@ import androidx.compose.ui.text.input.KeyboardType
</a> import androidx.compose.ui.text.input.TextFieldValue
 import androidx.compose.ui.unit.dp
 import androidx.compose.ui.unit.sp
<a href="#h28-0-3" id="h28-0-3" class="d">-import me.rhunk.snapenhance.core.bridge.wrapper.LocaleWrapper
</a><a href="#h28-0-4" id="h28-0-4" class="d">-import me.rhunk.snapenhance.core.config.DataProcessors
</a><a href="#h28-0-5" id="h28-0-5" class="d">-import me.rhunk.snapenhance.core.config.PropertyPair
</a><a href="#h28-0-6" id="h28-0-6" class="i">+import me.rhunk.snapenhance.common.bridge.wrapper.LocaleWrapper
</a><a href="#h28-0-7" id="h28-0-7" class="i">+import me.rhunk.snapenhance.common.config.DataProcessors
</a><a href="#h28-0-8" id="h28-0-8" class="i">+import me.rhunk.snapenhance.common.config.PropertyPair
</a> 
 
 class AlertDialogs(
<b>diff --git a/<a id="h29" href="../file/app/src/main/res/font/avenir_next_medium.ttf.html">app/src/main/res/font/avenir_next_medium.ttf</a> b/<a href="../file/app/src/main/res/font/avenir_next_medium.ttf.html">app/src/main/res/font/avenir_next_medium.ttf</a></b>
Binary files differ.
<b>diff --git a/<a id="h30" href="../file/app/src/main/res/layout/map.xml.html">app/src/main/res/layout/map.xml</a> b/<a href="../file/app/src/main/res/layout/map.xml.html">app/src/main/res/layout/map.xml</a></b>
<a href="#h30-0" id="h30-0" class="h">@@ -0,0 +1,44 @@
</a><a href="#h30-0-0" id="h30-0-0" class="i">+&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
</a><a href="#h30-0-1" id="h30-0-1" class="i">+&lt;FrameLayout xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;
</a><a href="#h30-0-2" id="h30-0-2" class="i">+    xmlns:tools=&quot;http://schemas.android.com/tools&quot;
</a><a href="#h30-0-3" id="h30-0-3" class="i">+    android:layout_width=&quot;match_parent&quot;
</a><a href="#h30-0-4" id="h30-0-4" class="i">+    android:layout_height=&quot;match_parent&quot;&gt;
</a><a href="#h30-0-5" id="h30-0-5" class="i">+
</a><a href="#h30-0-6" id="h30-0-6" class="i">+    &lt;org.osmdroid.views.MapView
</a><a href="#h30-0-7" id="h30-0-7" class="i">+        android:id=&quot;@+id/mapView&quot;
</a><a href="#h30-0-8" id="h30-0-8" class="i">+        android:layout_width=&quot;match_parent&quot;
</a><a href="#h30-0-9" id="h30-0-9" class="i">+        android:layout_height=&quot;match_parent&quot; &gt;
</a><a href="#h30-0-10" id="h30-0-10" class="i">+
</a><a href="#h30-0-11" id="h30-0-11" class="i">+    &lt;/org.osmdroid.views.MapView&gt;
</a><a href="#h30-0-12" id="h30-0-12" class="i">+
</a><a href="#h30-0-13" id="h30-0-13" class="i">+    &lt;FrameLayout
</a><a href="#h30-0-14" id="h30-0-14" class="i">+        android:layout_width=&quot;match_parent&quot;
</a><a href="#h30-0-15" id="h30-0-15" class="i">+        android:layout_height=&quot;wrap_content&quot;&gt;
</a><a href="#h30-0-16" id="h30-0-16" class="i">+
</a><a href="#h30-0-17" id="h30-0-17" class="i">+        &lt;Button
</a><a href="#h30-0-18" id="h30-0-18" class="i">+            android:id=&quot;@+id/set_precise_location_button&quot;
</a><a href="#h30-0-19" id="h30-0-19" class="i">+            android:layout_width=&quot;wrap_content&quot;
</a><a href="#h30-0-20" id="h30-0-20" class="i">+            android:layout_height=&quot;match_parent&quot;
</a><a href="#h30-0-21" id="h30-0-21" class="i">+            android:layout_gravity=&quot;left&quot;
</a><a href="#h30-0-22" id="h30-0-22" class="i">+            android:layout_marginStart=&quot;20dp&quot;
</a><a href="#h30-0-23" id="h30-0-23" class="i">+            android:layout_marginTop=&quot;20dp&quot;
</a><a href="#h30-0-24" id="h30-0-24" class="i">+            android:padding=&quot;10dp&quot;
</a><a href="#h30-0-25" id="h30-0-25" class="i">+            android:background=&quot;@android:color/white&quot;
</a><a href="#h30-0-26" id="h30-0-26" class="i">+            android:text=&quot;Set Precise Location&quot;
</a><a href="#h30-0-27" id="h30-0-27" class="i">+            android:textSize=&quot;20sp&quot;
</a><a href="#h30-0-28" id="h30-0-28" class="i">+            tools:ignore=&quot;HardcodedText,RtlHardcoded&quot; /&gt;
</a><a href="#h30-0-29" id="h30-0-29" class="i">+
</a><a href="#h30-0-30" id="h30-0-30" class="i">+        &lt;Button
</a><a href="#h30-0-31" id="h30-0-31" class="i">+            android:id=&quot;@+id/apply_location_button&quot;
</a><a href="#h30-0-32" id="h30-0-32" class="i">+            android:layout_width=&quot;wrap_content&quot;
</a><a href="#h30-0-33" id="h30-0-33" class="i">+            android:layout_height=&quot;wrap_content&quot;
</a><a href="#h30-0-34" id="h30-0-34" class="i">+            android:layout_gravity=&quot;right&quot;
</a><a href="#h30-0-35" id="h30-0-35" class="i">+            android:layout_marginTop=&quot;20dp&quot;
</a><a href="#h30-0-36" id="h30-0-36" class="i">+            android:layout_marginRight=&quot;20dp&quot;
</a><a href="#h30-0-37" id="h30-0-37" class="i">+            android:background=&quot;@android:color/white&quot;
</a><a href="#h30-0-38" id="h30-0-38" class="i">+            android:text=&quot;Apply&quot;
</a><a href="#h30-0-39" id="h30-0-39" class="i">+            android:textSize=&quot;20sp&quot;
</a><a href="#h30-0-40" id="h30-0-40" class="i">+            tools:ignore=&quot;HardcodedText,RtlHardcoded&quot; /&gt;
</a><a href="#h30-0-41" id="h30-0-41" class="i">+    &lt;/FrameLayout&gt;
</a><a href="#h30-0-42" id="h30-0-42" class="i">+
</a><a href="#h30-0-43" id="h30-0-43" class="i">+&lt;/FrameLayout&gt;
</a><b>diff --git a/<a id="h31" href="../file/app/src/main/res/layout/precise_location_dialog.xml.html">app/src/main/res/layout/precise_location_dialog.xml</a> b/<a href="../file/app/src/main/res/layout/precise_location_dialog.xml.html">app/src/main/res/layout/precise_location_dialog.xml</a></b>
<a href="#h31-0" id="h31-0" class="h">@@ -0,0 +1,28 @@
</a><a href="#h31-0-0" id="h31-0-0" class="i">+&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
</a><a href="#h31-0-1" id="h31-0-1" class="i">+&lt;LinearLayout xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;
</a><a href="#h31-0-2" id="h31-0-2" class="i">+    xmlns:tools=&quot;http://schemas.android.com/tools&quot;
</a><a href="#h31-0-3" id="h31-0-3" class="i">+    android:layout_width=&quot;match_parent&quot;
</a><a href="#h31-0-4" id="h31-0-4" class="i">+    android:layout_height=&quot;match_parent&quot;
</a><a href="#h31-0-5" id="h31-0-5" class="i">+    android:padding=&quot;20dp&quot;
</a><a href="#h31-0-6" id="h31-0-6" class="i">+    android:orientation=&quot;vertical&quot;
</a><a href="#h31-0-7" id="h31-0-7" class="i">+    tools:ignore=&quot;HardcodedText&quot;&gt;
</a><a href="#h31-0-8" id="h31-0-8" class="i">+
</a><a href="#h31-0-9" id="h31-0-9" class="i">+    &lt;EditText
</a><a href="#h31-0-10" id="h31-0-10" class="i">+        android:id=&quot;@+id/dialog_latitude&quot;
</a><a href="#h31-0-11" id="h31-0-11" class="i">+        android:layout_width=&quot;match_parent&quot;
</a><a href="#h31-0-12" id="h31-0-12" class="i">+        android:layout_height=&quot;wrap_content&quot;
</a><a href="#h31-0-13" id="h31-0-13" class="i">+        android:autofillHints=&quot;&quot;
</a><a href="#h31-0-14" id="h31-0-14" class="i">+        android:ems=&quot;10&quot;
</a><a href="#h31-0-15" id="h31-0-15" class="i">+        android:hint=&quot;Latitude&quot;
</a><a href="#h31-0-16" id="h31-0-16" class="i">+        android:inputType=&quot;number|numberDecimal|numberSigned&quot; /&gt;
</a><a href="#h31-0-17" id="h31-0-17" class="i">+
</a><a href="#h31-0-18" id="h31-0-18" class="i">+    &lt;EditText
</a><a href="#h31-0-19" id="h31-0-19" class="i">+        android:id=&quot;@+id/dialog_longitude&quot;
</a><a href="#h31-0-20" id="h31-0-20" class="i">+        android:layout_width=&quot;match_parent&quot;
</a><a href="#h31-0-21" id="h31-0-21" class="i">+        android:layout_height=&quot;wrap_content&quot;
</a><a href="#h31-0-22" id="h31-0-22" class="i">+        android:autofillHints=&quot;&quot;
</a><a href="#h31-0-23" id="h31-0-23" class="i">+        android:ems=&quot;10&quot;
</a><a href="#h31-0-24" id="h31-0-24" class="i">+        android:hint=&quot;Longitude&quot;
</a><a href="#h31-0-25" id="h31-0-25" class="i">+        android:inputType=&quot;number|numberDecimal|numberSigned&quot; /&gt;
</a><a href="#h31-0-26" id="h31-0-26" class="i">+
</a><a href="#h31-0-27" id="h31-0-27" class="i">+&lt;/LinearLayout&gt;</a><a href="#h31-0-28" id="h31-0-28" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h32" href="../file/app/src/main/res/values/colors.xml.html">app/src/main/res/values/colors.xml</a> b/<a href="../file/app/src/main/res/values/colors.xml.html">app/src/main/res/values/colors.xml</a></b>
<a href="#h32-0" id="h32-0" class="h">@@ -0,0 +1,6 @@
</a><a href="#h32-0-0" id="h32-0-0" class="i">+&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
</a><a href="#h32-0-1" id="h32-0-1" class="i">+&lt;resources&gt;
</a><a href="#h32-0-2" id="h32-0-2" class="i">+    &lt;color name=&quot;primaryText&quot;&gt;#DEDEDE&lt;/color&gt;
</a><a href="#h32-0-3" id="h32-0-3" class="i">+    &lt;color name=&quot;primaryBackground&quot;&gt;#121212&lt;/color&gt;
</a><a href="#h32-0-4" id="h32-0-4" class="i">+    &lt;color name=&quot;borderColor&quot;&gt;#424242&lt;/color&gt;
</a><a href="#h32-0-5" id="h32-0-5" class="i">+&lt;/resources&gt;</a><a href="#h32-0-6" id="h32-0-6" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h33" href="../file/app/src/main/res/values/launcher_icon_background.xml.html">app/src/main/res/values/launcher_icon_background.xml</a> b/<a href="../file/app/src/main/res/values/launcher_icon_background.xml.html">app/src/main/res/values/launcher_icon_background.xml</a></b>
<a href="#h33-0" id="h33-0" class="h">@@ -0,0 +1,4 @@
</a><a href="#h33-0-0" id="h33-0-0" class="i">+&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
</a><a href="#h33-0-1" id="h33-0-1" class="i">+&lt;resources&gt;
</a><a href="#h33-0-2" id="h33-0-2" class="i">+    &lt;color name=&quot;launcher_icon_background&quot;&gt;#FDFA00&lt;/color&gt;
</a><a href="#h33-0-3" id="h33-0-3" class="i">+&lt;/resources&gt;</a><a href="#h33-0-4" id="h33-0-4" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h34" href="../file/app/src/main/res/values/strings.xml.html">app/src/main/res/values/strings.xml</a> b/<a href="../file/app/src/main/res/values/strings.xml.html">app/src/main/res/values/strings.xml</a></b>
<a href="#h34-0" id="h34-0" class="h">@@ -0,0 +1,3 @@
</a><a href="#h34-0-0" id="h34-0-0" class="i">+&lt;resources&gt;
</a><a href="#h34-0-1" id="h34-0-1" class="i">+    &lt;string name=&quot;app_name&quot; translatable=&quot;false&quot;&gt;SnapEnhance&lt;/string&gt;
</a><a href="#h34-0-2" id="h34-0-2" class="i">+&lt;/resources&gt;</a><a href="#h34-0-3" id="h34-0-3" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h35" href="../file/app/src/main/res/values/themes.xml.html">app/src/main/res/values/themes.xml</a> b/<a href="../file/app/src/main/res/values/themes.xml.html">app/src/main/res/values/themes.xml</a></b>
<a href="#h35-0" id="h35-0" class="h">@@ -0,0 +1,12 @@
</a><a href="#h35-0-0" id="h35-0-0" class="i">+&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;
</a><a href="#h35-0-1" id="h35-0-1" class="i">+&lt;resources&gt;
</a><a href="#h35-0-2" id="h35-0-2" class="i">+    &lt;style name=&quot;AppTheme&quot;&gt;
</a><a href="#h35-0-3" id="h35-0-3" class="i">+        &lt;item name=&quot;android:fontFamily&quot;&gt;@font/avenir_next_medium&lt;/item&gt;
</a><a href="#h35-0-4" id="h35-0-4" class="i">+        &lt;item name=&quot;android:windowNoTitle&quot;&gt;true&lt;/item&gt;
</a><a href="#h35-0-5" id="h35-0-5" class="i">+        &lt;item name=&quot;android:windowContentOverlay&quot;&gt;@null&lt;/item&gt;
</a><a href="#h35-0-6" id="h35-0-6" class="i">+        &lt;item name=&quot;android:navigationBarColor&quot;&gt;@color/primaryBackground&lt;/item&gt;
</a><a href="#h35-0-7" id="h35-0-7" class="i">+        &lt;item name=&quot;android:textColor&quot;&gt;@color/primaryText&lt;/item&gt;
</a><a href="#h35-0-8" id="h35-0-8" class="i">+        &lt;item name=&quot;android:editTextColor&quot;&gt;@color/primaryText&lt;/item&gt;
</a><a href="#h35-0-9" id="h35-0-9" class="i">+        &lt;item name=&quot;android:alertDialogTheme&quot;&gt;@android:style/Theme.DeviceDefault.Dialog.Alert&lt;/item&gt;
</a><a href="#h35-0-10" id="h35-0-10" class="i">+    &lt;/style&gt;
</a><a href="#h35-0-11" id="h35-0-11" class="i">+&lt;/resources&gt;</a><a href="#h35-0-12" id="h35-0-12" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h36" href="../file/build.gradle.kts.html">build.gradle.kts</a> b/<a href="../file/build.gradle.kts.html">build.gradle.kts</a></b>
<a href="#h36-0" id="h36-0" class="h">@@ -12,3 +12,10 @@ rootProject.ext.set(&quot;appVersionName&quot;, versionName)
</a> rootProject.ext.set(&quot;appVersionCode&quot;, versionCode)
 rootProject.ext.set(&quot;applicationId&quot;, &quot;me.rhunk.snapenhance&quot;)
 rootProject.ext.set(&quot;nativeName&quot;, properties[&quot;custom_native_name&quot;] ?: java.security.SecureRandom().nextLong(1000000000, 99999999999).toString(16))
<a href="#h36-0-3" id="h36-0-3" class="i">+
</a><a href="#h36-0-4" id="h36-0-4" class="i">+tasks.register(&quot;getVersion&quot;) {
</a><a href="#h36-0-5" id="h36-0-5" class="i">+    doLast {
</a><a href="#h36-0-6" id="h36-0-6" class="i">+        val versionFile = File(&quot;app/build/version.txt&quot;)
</a><a href="#h36-0-7" id="h36-0-7" class="i">+        versionFile.writeText(versionName)
</a><a href="#h36-0-8" id="h36-0-8" class="i">+    }
</a><a href="#h36-0-9" id="h36-0-9" class="i">+}
</a><b>diff --git a/<a id="h37" href="../file/common/.gitignore.html">common/.gitignore</a> b/<a href="../file/common/.gitignore.html">common/.gitignore</a></b>
<a href="#h37-0" id="h37-0" class="h">@@ -0,0 +1 @@
</a><a href="#h37-0-0" id="h37-0-0" class="i">+/build</a><a href="#h37-0-1" id="h37-0-1" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h38" href="../file/common/build.gradle.kts.html">common/build.gradle.kts</a> b/<a href="../file/common/build.gradle.kts.html">common/build.gradle.kts</a></b>
<a href="#h38-0" id="h38-0" class="h">@@ -0,0 +1,37 @@
</a><a href="#h38-0-0" id="h38-0-0" class="i">+plugins {
</a><a href="#h38-0-1" id="h38-0-1" class="i">+    alias(libs.plugins.androidLibrary)
</a><a href="#h38-0-2" id="h38-0-2" class="i">+    alias(libs.plugins.kotlinAndroid)
</a><a href="#h38-0-3" id="h38-0-3" class="i">+}
</a><a href="#h38-0-4" id="h38-0-4" class="i">+
</a><a href="#h38-0-5" id="h38-0-5" class="i">+android {
</a><a href="#h38-0-6" id="h38-0-6" class="i">+    namespace = rootProject.ext[&quot;applicationId&quot;].toString() + &quot;.common&quot;
</a><a href="#h38-0-7" id="h38-0-7" class="i">+    compileSdk = 34
</a><a href="#h38-0-8" id="h38-0-8" class="i">+
</a><a href="#h38-0-9" id="h38-0-9" class="i">+    buildFeatures {
</a><a href="#h38-0-10" id="h38-0-10" class="i">+        aidl = true
</a><a href="#h38-0-11" id="h38-0-11" class="i">+        buildConfig = true
</a><a href="#h38-0-12" id="h38-0-12" class="i">+    }
</a><a href="#h38-0-13" id="h38-0-13" class="i">+
</a><a href="#h38-0-14" id="h38-0-14" class="i">+    defaultConfig {
</a><a href="#h38-0-15" id="h38-0-15" class="i">+        minSdk = 28
</a><a href="#h38-0-16" id="h38-0-16" class="i">+        buildConfigField(&quot;String&quot;, &quot;VERSION_NAME&quot;, &quot;\&quot;${rootProject.ext[&quot;appVersionName&quot;]}\&quot;&quot;)
</a><a href="#h38-0-17" id="h38-0-17" class="i">+        buildConfigField(&quot;int&quot;, &quot;VERSION_CODE&quot;, &quot;${rootProject.ext[&quot;appVersionCode&quot;]}&quot;)
</a><a href="#h38-0-18" id="h38-0-18" class="i">+        buildConfigField(&quot;String&quot;, &quot;APPLICATION_ID&quot;, &quot;\&quot;${rootProject.ext[&quot;applicationId&quot;]}\&quot;&quot;)
</a><a href="#h38-0-19" id="h38-0-19" class="i">+        buildConfigField(&quot;int&quot;, &quot;BUILD_DATE&quot;, &quot;${System.currentTimeMillis() / 1000}&quot;)
</a><a href="#h38-0-20" id="h38-0-20" class="i">+    }
</a><a href="#h38-0-21" id="h38-0-21" class="i">+
</a><a href="#h38-0-22" id="h38-0-22" class="i">+    kotlinOptions {
</a><a href="#h38-0-23" id="h38-0-23" class="i">+        jvmTarget = &quot;1.8&quot;
</a><a href="#h38-0-24" id="h38-0-24" class="i">+    }
</a><a href="#h38-0-25" id="h38-0-25" class="i">+}
</a><a href="#h38-0-26" id="h38-0-26" class="i">+
</a><a href="#h38-0-27" id="h38-0-27" class="i">+dependencies {
</a><a href="#h38-0-28" id="h38-0-28" class="i">+    implementation(libs.coroutines)
</a><a href="#h38-0-29" id="h38-0-29" class="i">+    implementation(libs.gson)
</a><a href="#h38-0-30" id="h38-0-30" class="i">+    implementation(libs.okhttp)
</a><a href="#h38-0-31" id="h38-0-31" class="i">+    implementation(libs.androidx.documentfile)
</a><a href="#h38-0-32" id="h38-0-32" class="i">+    implementation(libs.rhino)
</a><a href="#h38-0-33" id="h38-0-33" class="i">+
</a><a href="#h38-0-34" id="h38-0-34" class="i">+    implementation(project(&quot;:stub&quot;))
</a><a href="#h38-0-35" id="h38-0-35" class="i">+    implementation(project(&quot;:mapper&quot;))
</a><a href="#h38-0-36" id="h38-0-36" class="i">+}</a><a href="#h38-0-37" id="h38-0-37" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h39" href="../file/core/src/main/aidl/me/rhunk/snapenhance/bridge/BridgeInterface.aidl.html">core/src/main/aidl/me/rhunk/snapenhance/bridge/BridgeInterface.aidl</a> b/<a href="../file/common/src/main/aidl/me/rhunk/snapenhance/bridge/BridgeInterface.aidl.html">common/src/main/aidl/me/rhunk/snapenhance/bridge/BridgeInterface.aidl</a></b>
<b>diff --git a/<a id="h40" href="../file/core/src/main/aidl/me/rhunk/snapenhance/bridge/ConfigStateListener.aidl.html">core/src/main/aidl/me/rhunk/snapenhance/bridge/ConfigStateListener.aidl</a> b/<a href="../file/common/src/main/aidl/me/rhunk/snapenhance/bridge/ConfigStateListener.aidl.html">common/src/main/aidl/me/rhunk/snapenhance/bridge/ConfigStateListener.aidl</a></b>
<b>diff --git a/<a id="h41" href="../file/core/src/main/aidl/me/rhunk/snapenhance/bridge/DownloadCallback.aidl.html">core/src/main/aidl/me/rhunk/snapenhance/bridge/DownloadCallback.aidl</a> b/<a href="../file/common/src/main/aidl/me/rhunk/snapenhance/bridge/DownloadCallback.aidl.html">common/src/main/aidl/me/rhunk/snapenhance/bridge/DownloadCallback.aidl</a></b>
<b>diff --git a/<a id="h42" href="../file/core/src/main/aidl/me/rhunk/snapenhance/bridge/MessageLoggerInterface.aidl.html">core/src/main/aidl/me/rhunk/snapenhance/bridge/MessageLoggerInterface.aidl</a> b/<a href="../file/common/src/main/aidl/me/rhunk/snapenhance/bridge/MessageLoggerInterface.aidl.html">common/src/main/aidl/me/rhunk/snapenhance/bridge/MessageLoggerInterface.aidl</a></b>
<b>diff --git a/<a id="h43" href="../file/core/src/main/aidl/me/rhunk/snapenhance/bridge/SyncCallback.aidl.html">core/src/main/aidl/me/rhunk/snapenhance/bridge/SyncCallback.aidl</a> b/<a href="../file/common/src/main/aidl/me/rhunk/snapenhance/bridge/SyncCallback.aidl.html">common/src/main/aidl/me/rhunk/snapenhance/bridge/SyncCallback.aidl</a></b>
<b>diff --git a/<a id="h44" href="../file/core/src/main/aidl/me/rhunk/snapenhance/bridge/e2ee/E2eeInterface.aidl.html">core/src/main/aidl/me/rhunk/snapenhance/bridge/e2ee/E2eeInterface.aidl</a> b/<a href="../file/common/src/main/aidl/me/rhunk/snapenhance/bridge/e2ee/E2eeInterface.aidl.html">common/src/main/aidl/me/rhunk/snapenhance/bridge/e2ee/E2eeInterface.aidl</a></b>
<b>diff --git a/<a id="h45" href="../file/core/src/main/aidl/me/rhunk/snapenhance/bridge/e2ee/EncryptionResult.aidl.html">core/src/main/aidl/me/rhunk/snapenhance/bridge/e2ee/EncryptionResult.aidl</a> b/<a href="../file/common/src/main/aidl/me/rhunk/snapenhance/bridge/e2ee/EncryptionResult.aidl.html">common/src/main/aidl/me/rhunk/snapenhance/bridge/e2ee/EncryptionResult.aidl</a></b>
<b>diff --git a/<a id="h46" href="../file/core/src/main/aidl/me/rhunk/snapenhance/bridge/scripting/IPCListener.aidl.html">core/src/main/aidl/me/rhunk/snapenhance/bridge/scripting/IPCListener.aidl</a> b/<a href="../file/common/src/main/aidl/me/rhunk/snapenhance/bridge/scripting/IPCListener.aidl.html">common/src/main/aidl/me/rhunk/snapenhance/bridge/scripting/IPCListener.aidl</a></b>
<b>diff --git a/<a id="h47" href="../file/core/src/main/aidl/me/rhunk/snapenhance/bridge/scripting/IScripting.aidl.html">core/src/main/aidl/me/rhunk/snapenhance/bridge/scripting/IScripting.aidl</a> b/<a href="../file/common/src/main/aidl/me/rhunk/snapenhance/bridge/scripting/IScripting.aidl.html">common/src/main/aidl/me/rhunk/snapenhance/bridge/scripting/IScripting.aidl</a></b>
<b>diff --git a/<a id="h48" href="../file/core/src/main/assets/lang/ar_SA.json.html">core/src/main/assets/lang/ar_SA.json</a> b/<a href="../file/common/src/main/assets/lang/ar_SA.json.html">common/src/main/assets/lang/ar_SA.json</a></b>
<b>diff --git a/<a id="h49" href="../file/core/src/main/assets/lang/de_DE.json.html">core/src/main/assets/lang/de_DE.json</a> b/<a href="../file/common/src/main/assets/lang/de_DE.json.html">common/src/main/assets/lang/de_DE.json</a></b>
<b>diff --git a/<a id="h50" href="../file/core/src/main/assets/lang/en_US.json.html">core/src/main/assets/lang/en_US.json</a> b/<a href="../file/common/src/main/assets/lang/en_US.json.html">common/src/main/assets/lang/en_US.json</a></b>
<b>diff --git a/<a id="h51" href="../file/core/src/main/assets/lang/fr_FR.json.html">core/src/main/assets/lang/fr_FR.json</a> b/<a href="../file/common/src/main/assets/lang/fr_FR.json.html">common/src/main/assets/lang/fr_FR.json</a></b>
<b>diff --git a/<a id="h52" href="../file/core/src/main/assets/lang/hi_IN.json.html">core/src/main/assets/lang/hi_IN.json</a> b/<a href="../file/common/src/main/assets/lang/hi_IN.json.html">common/src/main/assets/lang/hi_IN.json</a></b>
<b>diff --git a/<a id="h53" href="../file/core/src/main/assets/lang/hu_HU.json.html">core/src/main/assets/lang/hu_HU.json</a> b/<a href="../file/common/src/main/assets/lang/hu_HU.json.html">common/src/main/assets/lang/hu_HU.json</a></b>
<b>diff --git a/<a id="h54" href="../file/core/src/main/assets/lang/it_IT.json.html">core/src/main/assets/lang/it_IT.json</a> b/<a href="../file/common/src/main/assets/lang/it_IT.json.html">common/src/main/assets/lang/it_IT.json</a></b>
<b>diff --git a/<a id="h55" href="../file/core/src/main/assets/lang/tr_TR.json.html">core/src/main/assets/lang/tr_TR.json</a> b/<a href="../file/common/src/main/assets/lang/tr_TR.json.html">common/src/main/assets/lang/tr_TR.json</a></b>
<b>diff --git a/<a id="h56" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/Constants.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/Constants.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/Constants.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/Constants.kt</a></b>
<a href="#h56-0" id="h56-0" class="h">@@ -0,0 +1,9 @@
</a><a href="#h56-0-0" id="h56-0-0" class="i">+package me.rhunk.snapenhance.common
</a><a href="#h56-0-1" id="h56-0-1" class="i">+
</a><a href="#h56-0-2" id="h56-0-2" class="i">+object Constants {
</a><a href="#h56-0-3" id="h56-0-3" class="i">+    const val SNAPCHAT_PACKAGE_NAME = &quot;com.snapchat.android&quot;
</a><a href="#h56-0-4" id="h56-0-4" class="i">+
</a><a href="#h56-0-5" id="h56-0-5" class="i">+    val ARROYO_MEDIA_CONTAINER_PROTO_PATH = intArrayOf(4, 4)
</a><a href="#h56-0-6" id="h56-0-6" class="i">+
</a><a href="#h56-0-7" id="h56-0-7" class="i">+    const val USER_AGENT = &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36&quot;
</a><a href="#h56-0-8" id="h56-0-8" class="i">+}</a><a href="#h56-0-9" id="h56-0-9" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h57" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/ReceiversConfig.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/ReceiversConfig.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/ReceiversConfig.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/ReceiversConfig.kt</a></b>
<a href="#h57-0" id="h57-0" class="h">@@ -0,0 +1,7 @@
</a><a href="#h57-0-0" id="h57-0-0" class="i">+package me.rhunk.snapenhance.common
</a><a href="#h57-0-1" id="h57-0-1" class="i">+
</a><a href="#h57-0-2" id="h57-0-2" class="i">+object ReceiversConfig {
</a><a href="#h57-0-3" id="h57-0-3" class="i">+    const val BRIDGE_SYNC_ACTION = BuildConfig.APPLICATION_ID + &quot;.core.bridge.SYNC&quot;
</a><a href="#h57-0-4" id="h57-0-4" class="i">+    const val DOWNLOAD_REQUEST_EXTRA = &quot;request&quot;
</a><a href="#h57-0-5" id="h57-0-5" class="i">+    const val DOWNLOAD_METADATA_EXTRA = &quot;metadata&quot;
</a><a href="#h57-0-6" id="h57-0-6" class="i">+}</a><a href="#h57-0-7" id="h57-0-7" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h58" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/action/EnumAction.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/action/EnumAction.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/action/EnumAction.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/action/EnumAction.kt</a></b>
<a href="#h58-0" id="h58-0" class="h">@@ -0,0 +1,17 @@
</a><a href="#h58-0-0" id="h58-0-0" class="i">+package me.rhunk.snapenhance.common.action
</a><a href="#h58-0-1" id="h58-0-1" class="i">+
</a><a href="#h58-0-2" id="h58-0-2" class="i">+
</a><a href="#h58-0-3" id="h58-0-3" class="i">+
</a><a href="#h58-0-4" id="h58-0-4" class="i">+enum class EnumAction(
</a><a href="#h58-0-5" id="h58-0-5" class="i">+    val key: String,
</a><a href="#h58-0-6" id="h58-0-6" class="i">+    val exitOnFinish: Boolean = false,
</a><a href="#h58-0-7" id="h58-0-7" class="i">+    val isCritical: Boolean = false,
</a><a href="#h58-0-8" id="h58-0-8" class="i">+) {
</a><a href="#h58-0-9" id="h58-0-9" class="i">+    CLEAN_CACHE(&quot;clean_snapchat_cache&quot;, exitOnFinish = true),
</a><a href="#h58-0-10" id="h58-0-10" class="i">+    EXPORT_CHAT_MESSAGES(&quot;export_chat_messages&quot;),
</a><a href="#h58-0-11" id="h58-0-11" class="i">+    OPEN_MAP(&quot;open_map&quot;);
</a><a href="#h58-0-12" id="h58-0-12" class="i">+
</a><a href="#h58-0-13" id="h58-0-13" class="i">+    companion object {
</a><a href="#h58-0-14" id="h58-0-14" class="i">+        const val ACTION_PARAMETER = &quot;se_action&quot;
</a><a href="#h58-0-15" id="h58-0-15" class="i">+    }
</a><a href="#h58-0-16" id="h58-0-16" class="i">+}</a><a href="#h58-0-17" id="h58-0-17" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h59" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/FileLoaderWrapper.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/FileLoaderWrapper.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/FileLoaderWrapper.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/FileLoaderWrapper.kt</a></b>
<a href="#h59-0" id="h59-0" class="h">@@ -0,0 +1,29 @@
</a><a href="#h59-0-0" id="h59-0-0" class="i">+package me.rhunk.snapenhance.common.bridge
</a><a href="#h59-0-1" id="h59-0-1" class="i">+
</a><a href="#h59-0-2" id="h59-0-2" class="i">+import android.content.Context
</a><a href="#h59-0-3" id="h59-0-3" class="i">+import me.rhunk.snapenhance.common.bridge.types.BridgeFileType
</a><a href="#h59-0-4" id="h59-0-4" class="i">+
</a><a href="#h59-0-5" id="h59-0-5" class="i">+open class FileLoaderWrapper(
</a><a href="#h59-0-6" id="h59-0-6" class="i">+    val fileType: BridgeFileType,
</a><a href="#h59-0-7" id="h59-0-7" class="i">+    val defaultContent: ByteArray
</a><a href="#h59-0-8" id="h59-0-8" class="i">+) {
</a><a href="#h59-0-9" id="h59-0-9" class="i">+    lateinit var isFileExists: () -&gt; Boolean
</a><a href="#h59-0-10" id="h59-0-10" class="i">+    lateinit var write: (ByteArray) -&gt; Unit
</a><a href="#h59-0-11" id="h59-0-11" class="i">+    lateinit var read: () -&gt; ByteArray
</a><a href="#h59-0-12" id="h59-0-12" class="i">+    lateinit var delete: () -&gt; Unit
</a><a href="#h59-0-13" id="h59-0-13" class="i">+
</a><a href="#h59-0-14" id="h59-0-14" class="i">+    fun loadFromContext(context: Context) {
</a><a href="#h59-0-15" id="h59-0-15" class="i">+        val file = fileType.resolve(context)
</a><a href="#h59-0-16" id="h59-0-16" class="i">+        isFileExists = { file.exists() }
</a><a href="#h59-0-17" id="h59-0-17" class="i">+        read = {
</a><a href="#h59-0-18" id="h59-0-18" class="i">+            if (!file.exists()) {
</a><a href="#h59-0-19" id="h59-0-19" class="i">+                file.createNewFile()
</a><a href="#h59-0-20" id="h59-0-20" class="i">+                file.writeBytes(&quot;{}&quot;.toByteArray(Charsets.UTF_8))
</a><a href="#h59-0-21" id="h59-0-21" class="i">+            }
</a><a href="#h59-0-22" id="h59-0-22" class="i">+            file.readBytes()
</a><a href="#h59-0-23" id="h59-0-23" class="i">+        }
</a><a href="#h59-0-24" id="h59-0-24" class="i">+        write = { file.writeBytes(it) }
</a><a href="#h59-0-25" id="h59-0-25" class="i">+        delete = { file.delete() }
</a><a href="#h59-0-26" id="h59-0-26" class="i">+    }
</a><a href="#h59-0-27" id="h59-0-27" class="i">+
</a><a href="#h59-0-28" id="h59-0-28" class="i">+}</a><a href="#h59-0-29" id="h59-0-29" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h60" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/types/BridgeFileType.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/types/BridgeFileType.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/types/BridgeFileType.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/types/BridgeFileType.kt</a></b>
<a href="#h60-0" id="h60-0" class="h">@@ -0,0 +1,24 @@
</a><a href="#h60-0-0" id="h60-0-0" class="i">+package me.rhunk.snapenhance.common.bridge.types
</a><a href="#h60-0-1" id="h60-0-1" class="i">+
</a><a href="#h60-0-2" id="h60-0-2" class="i">+import android.content.Context
</a><a href="#h60-0-3" id="h60-0-3" class="i">+import java.io.File
</a><a href="#h60-0-4" id="h60-0-4" class="i">+
</a><a href="#h60-0-5" id="h60-0-5" class="i">+
</a><a href="#h60-0-6" id="h60-0-6" class="i">+enum class BridgeFileType(val value: Int, val fileName: String, val displayName: String, private val isDatabase: Boolean = false) {
</a><a href="#h60-0-7" id="h60-0-7" class="i">+    CONFIG(0, &quot;config.json&quot;, &quot;Config&quot;),
</a><a href="#h60-0-8" id="h60-0-8" class="i">+    MAPPINGS(1, &quot;mappings.json&quot;, &quot;Mappings&quot;),
</a><a href="#h60-0-9" id="h60-0-9" class="i">+    MESSAGE_LOGGER_DATABASE(2, &quot;message_logger.db&quot;, &quot;Message Logger&quot;,true),
</a><a href="#h60-0-10" id="h60-0-10" class="i">+    PINNED_CONVERSATIONS(3, &quot;pinned_conversations.txt&quot;, &quot;Pinned Conversations&quot;);
</a><a href="#h60-0-11" id="h60-0-11" class="i">+
</a><a href="#h60-0-12" id="h60-0-12" class="i">+    fun resolve(context: Context): File = if (isDatabase) {
</a><a href="#h60-0-13" id="h60-0-13" class="i">+        context.getDatabasePath(fileName)
</a><a href="#h60-0-14" id="h60-0-14" class="i">+    } else {
</a><a href="#h60-0-15" id="h60-0-15" class="i">+        File(context.filesDir, fileName)
</a><a href="#h60-0-16" id="h60-0-16" class="i">+    }
</a><a href="#h60-0-17" id="h60-0-17" class="i">+
</a><a href="#h60-0-18" id="h60-0-18" class="i">+    companion object {
</a><a href="#h60-0-19" id="h60-0-19" class="i">+        fun fromValue(value: Int): BridgeFileType? {
</a><a href="#h60-0-20" id="h60-0-20" class="i">+            return entries.firstOrNull { it.value == value }
</a><a href="#h60-0-21" id="h60-0-21" class="i">+        }
</a><a href="#h60-0-22" id="h60-0-22" class="i">+    }
</a><a href="#h60-0-23" id="h60-0-23" class="i">+}</a><a href="#h60-0-24" id="h60-0-24" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h61" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/types/FileActionType.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/types/FileActionType.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/types/FileActionType.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/types/FileActionType.kt</a></b>
<a href="#h61-0" id="h61-0" class="h">@@ -0,0 +1,5 @@
</a><a href="#h61-0-0" id="h61-0-0" class="i">+package me.rhunk.snapenhance.common.bridge.types
</a><a href="#h61-0-1" id="h61-0-1" class="i">+
</a><a href="#h61-0-2" id="h61-0-2" class="i">+enum class FileActionType {
</a><a href="#h61-0-3" id="h61-0-3" class="i">+    CREATE_AND_READ, READ, WRITE, DELETE, EXISTS
</a><a href="#h61-0-4" id="h61-0-4" class="i">+}</a><a href="#h61-0-5" id="h61-0-5" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h62" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/types/LocalePair.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/types/LocalePair.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/types/LocalePair.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/types/LocalePair.kt</a></b>
<a href="#h62-0" id="h62-0" class="h">@@ -0,0 +1,6 @@
</a><a href="#h62-0-0" id="h62-0-0" class="i">+package me.rhunk.snapenhance.common.bridge.types
</a><a href="#h62-0-1" id="h62-0-1" class="i">+
</a><a href="#h62-0-2" id="h62-0-2" class="i">+data class LocalePair(
</a><a href="#h62-0-3" id="h62-0-3" class="i">+    val locale: String,
</a><a href="#h62-0-4" id="h62-0-4" class="i">+    val content: String
</a><a href="#h62-0-5" id="h62-0-5" class="i">+)</a><a href="#h62-0-6" id="h62-0-6" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h63" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/wrapper/LocaleWrapper.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/wrapper/LocaleWrapper.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/wrapper/LocaleWrapper.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/wrapper/LocaleWrapper.kt</a></b>
<a href="#h63-0" id="h63-0" class="h">@@ -0,0 +1,99 @@
</a><a href="#h63-0-0" id="h63-0-0" class="i">+package me.rhunk.snapenhance.common.bridge.wrapper
</a><a href="#h63-0-1" id="h63-0-1" class="i">+
</a><a href="#h63-0-2" id="h63-0-2" class="i">+import android.content.Context
</a><a href="#h63-0-3" id="h63-0-3" class="i">+import com.google.gson.JsonObject
</a><a href="#h63-0-4" id="h63-0-4" class="i">+import com.google.gson.JsonParser
</a><a href="#h63-0-5" id="h63-0-5" class="i">+import me.rhunk.snapenhance.common.bridge.types.LocalePair
</a><a href="#h63-0-6" id="h63-0-6" class="i">+import me.rhunk.snapenhance.common.logger.AbstractLogger
</a><a href="#h63-0-7" id="h63-0-7" class="i">+import java.util.Locale
</a><a href="#h63-0-8" id="h63-0-8" class="i">+
</a><a href="#h63-0-9" id="h63-0-9" class="i">+
</a><a href="#h63-0-10" id="h63-0-10" class="i">+class LocaleWrapper {
</a><a href="#h63-0-11" id="h63-0-11" class="i">+    companion object {
</a><a href="#h63-0-12" id="h63-0-12" class="i">+        const val DEFAULT_LOCALE = &quot;en_US&quot;
</a><a href="#h63-0-13" id="h63-0-13" class="i">+
</a><a href="#h63-0-14" id="h63-0-14" class="i">+        fun fetchLocales(context: Context, locale: String = DEFAULT_LOCALE): List&lt;LocalePair&gt; {
</a><a href="#h63-0-15" id="h63-0-15" class="i">+            val locales = mutableListOf&lt;LocalePair&gt;().apply {
</a><a href="#h63-0-16" id="h63-0-16" class="i">+                add(LocalePair(DEFAULT_LOCALE, context.resources.assets.open(&quot;lang/$DEFAULT_LOCALE.json&quot;).bufferedReader().use { it.readText() }))
</a><a href="#h63-0-17" id="h63-0-17" class="i">+            }
</a><a href="#h63-0-18" id="h63-0-18" class="i">+
</a><a href="#h63-0-19" id="h63-0-19" class="i">+            if (locale == DEFAULT_LOCALE) return locales
</a><a href="#h63-0-20" id="h63-0-20" class="i">+
</a><a href="#h63-0-21" id="h63-0-21" class="i">+            val compatibleLocale = context.resources.assets.list(&quot;lang&quot;)?.firstOrNull { it.startsWith(locale) }?.substring(0, 5) ?: return locales
</a><a href="#h63-0-22" id="h63-0-22" class="i">+
</a><a href="#h63-0-23" id="h63-0-23" class="i">+            context.resources.assets.open(&quot;lang/$compatibleLocale.json&quot;).use { inputStream -&gt;
</a><a href="#h63-0-24" id="h63-0-24" class="i">+                locales.add(LocalePair(compatibleLocale, inputStream.bufferedReader().use { it.readText() }))
</a><a href="#h63-0-25" id="h63-0-25" class="i">+            }
</a><a href="#h63-0-26" id="h63-0-26" class="i">+
</a><a href="#h63-0-27" id="h63-0-27" class="i">+            return locales
</a><a href="#h63-0-28" id="h63-0-28" class="i">+        }
</a><a href="#h63-0-29" id="h63-0-29" class="i">+
</a><a href="#h63-0-30" id="h63-0-30" class="i">+        fun fetchAvailableLocales(context: Context): List&lt;String&gt; {
</a><a href="#h63-0-31" id="h63-0-31" class="i">+            return context.resources.assets.list(&quot;lang&quot;)?.map { it.substring(0, 5) } ?: listOf()
</a><a href="#h63-0-32" id="h63-0-32" class="i">+        }
</a><a href="#h63-0-33" id="h63-0-33" class="i">+    }
</a><a href="#h63-0-34" id="h63-0-34" class="i">+
</a><a href="#h63-0-35" id="h63-0-35" class="i">+    var userLocale = DEFAULT_LOCALE
</a><a href="#h63-0-36" id="h63-0-36" class="i">+
</a><a href="#h63-0-37" id="h63-0-37" class="i">+    private val translationMap = linkedMapOf&lt;String, String&gt;()
</a><a href="#h63-0-38" id="h63-0-38" class="i">+
</a><a href="#h63-0-39" id="h63-0-39" class="i">+    lateinit var loadedLocale: Locale
</a><a href="#h63-0-40" id="h63-0-40" class="i">+
</a><a href="#h63-0-41" id="h63-0-41" class="i">+    private fun load(localePair: LocalePair) {
</a><a href="#h63-0-42" id="h63-0-42" class="i">+        loadedLocale = localePair.locale.let { Locale(it.substring(0, 2), it.substring(3, 5)) }
</a><a href="#h63-0-43" id="h63-0-43" class="i">+
</a><a href="#h63-0-44" id="h63-0-44" class="i">+        val translations = JsonParser.parseString(localePair.content).asJsonObject
</a><a href="#h63-0-45" id="h63-0-45" class="i">+        if (translations == null || translations.isJsonNull) {
</a><a href="#h63-0-46" id="h63-0-46" class="i">+            return
</a><a href="#h63-0-47" id="h63-0-47" class="i">+        }
</a><a href="#h63-0-48" id="h63-0-48" class="i">+
</a><a href="#h63-0-49" id="h63-0-49" class="i">+        fun scanObject(jsonObject: JsonObject, prefix: String = &quot;&quot;) {
</a><a href="#h63-0-50" id="h63-0-50" class="i">+            jsonObject.entrySet().forEach {
</a><a href="#h63-0-51" id="h63-0-51" class="i">+                if (it.value.isJsonPrimitive) {
</a><a href="#h63-0-52" id="h63-0-52" class="i">+                    val key = &quot;$prefix${it.key}&quot;
</a><a href="#h63-0-53" id="h63-0-53" class="i">+                    translationMap[key] = it.value.asString
</a><a href="#h63-0-54" id="h63-0-54" class="i">+                }
</a><a href="#h63-0-55" id="h63-0-55" class="i">+                if (!it.value.isJsonObject) return@forEach
</a><a href="#h63-0-56" id="h63-0-56" class="i">+                scanObject(it.value.asJsonObject, &quot;$prefix${it.key}.&quot;)
</a><a href="#h63-0-57" id="h63-0-57" class="i">+            }
</a><a href="#h63-0-58" id="h63-0-58" class="i">+        }
</a><a href="#h63-0-59" id="h63-0-59" class="i">+
</a><a href="#h63-0-60" id="h63-0-60" class="i">+        scanObject(translations)
</a><a href="#h63-0-61" id="h63-0-61" class="i">+    }
</a><a href="#h63-0-62" id="h63-0-62" class="i">+
</a><a href="#h63-0-63" id="h63-0-63" class="i">+    fun loadFromCallback(callback: (String) -&gt; List&lt;LocalePair&gt;) {
</a><a href="#h63-0-64" id="h63-0-64" class="i">+        callback(userLocale).forEach {
</a><a href="#h63-0-65" id="h63-0-65" class="i">+            load(it)
</a><a href="#h63-0-66" id="h63-0-66" class="i">+        }
</a><a href="#h63-0-67" id="h63-0-67" class="i">+    }
</a><a href="#h63-0-68" id="h63-0-68" class="i">+
</a><a href="#h63-0-69" id="h63-0-69" class="i">+    fun loadFromContext(context: Context) {
</a><a href="#h63-0-70" id="h63-0-70" class="i">+        fetchLocales(context, userLocale).forEach {
</a><a href="#h63-0-71" id="h63-0-71" class="i">+            load(it)
</a><a href="#h63-0-72" id="h63-0-72" class="i">+        }
</a><a href="#h63-0-73" id="h63-0-73" class="i">+    }
</a><a href="#h63-0-74" id="h63-0-74" class="i">+
</a><a href="#h63-0-75" id="h63-0-75" class="i">+    fun reloadFromContext(context: Context, locale: String) {
</a><a href="#h63-0-76" id="h63-0-76" class="i">+        userLocale = locale
</a><a href="#h63-0-77" id="h63-0-77" class="i">+        translationMap.clear()
</a><a href="#h63-0-78" id="h63-0-78" class="i">+        loadFromContext(context)
</a><a href="#h63-0-79" id="h63-0-79" class="i">+    }
</a><a href="#h63-0-80" id="h63-0-80" class="i">+
</a><a href="#h63-0-81" id="h63-0-81" class="i">+    operator fun get(key: String) = translationMap[key] ?: key.also { AbstractLogger.directDebug(&quot;Missing translation for $key&quot;) }
</a><a href="#h63-0-82" id="h63-0-82" class="i">+
</a><a href="#h63-0-83" id="h63-0-83" class="i">+    fun format(key: String, vararg args: Pair&lt;String, String&gt;): String {
</a><a href="#h63-0-84" id="h63-0-84" class="i">+        return args.fold(get(key)) { acc, pair -&gt;
</a><a href="#h63-0-85" id="h63-0-85" class="i">+            acc.replace(&quot;{${pair.first}}&quot;, pair.second)
</a><a href="#h63-0-86" id="h63-0-86" class="i">+        }
</a><a href="#h63-0-87" id="h63-0-87" class="i">+    }
</a><a href="#h63-0-88" id="h63-0-88" class="i">+
</a><a href="#h63-0-89" id="h63-0-89" class="i">+    fun getCategory(key: String): LocaleWrapper {
</a><a href="#h63-0-90" id="h63-0-90" class="i">+        return LocaleWrapper().apply {
</a><a href="#h63-0-91" id="h63-0-91" class="i">+            translationMap.putAll(
</a><a href="#h63-0-92" id="h63-0-92" class="i">+                this@LocaleWrapper.translationMap
</a><a href="#h63-0-93" id="h63-0-93" class="i">+                    .filterKeys { it.startsWith(&quot;$key.&quot;) }
</a><a href="#h63-0-94" id="h63-0-94" class="i">+                    .mapKeys { it.key.substring(key.length + 1) }
</a><a href="#h63-0-95" id="h63-0-95" class="i">+            )
</a><a href="#h63-0-96" id="h63-0-96" class="i">+        }
</a><a href="#h63-0-97" id="h63-0-97" class="i">+    }
</a><a href="#h63-0-98" id="h63-0-98" class="i">+}</a><a href="#h63-0-99" id="h63-0-99" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h64" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/wrapper/MappingsWrapper.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/wrapper/MappingsWrapper.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/wrapper/MappingsWrapper.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/wrapper/MappingsWrapper.kt</a></b>
<a href="#h64-0" id="h64-0" class="h">@@ -0,0 +1,148 @@
</a><a href="#h64-0-0" id="h64-0-0" class="i">+package me.rhunk.snapenhance.common.bridge.wrapper
</a><a href="#h64-0-1" id="h64-0-1" class="i">+
</a><a href="#h64-0-2" id="h64-0-2" class="i">+import android.content.Context
</a><a href="#h64-0-3" id="h64-0-3" class="i">+import com.google.gson.GsonBuilder
</a><a href="#h64-0-4" id="h64-0-4" class="i">+import com.google.gson.JsonElement
</a><a href="#h64-0-5" id="h64-0-5" class="i">+import com.google.gson.JsonParser
</a><a href="#h64-0-6" id="h64-0-6" class="i">+import me.rhunk.snapenhance.common.Constants
</a><a href="#h64-0-7" id="h64-0-7" class="i">+import me.rhunk.snapenhance.common.bridge.FileLoaderWrapper
</a><a href="#h64-0-8" id="h64-0-8" class="i">+import me.rhunk.snapenhance.common.bridge.types.BridgeFileType
</a><a href="#h64-0-9" id="h64-0-9" class="i">+import me.rhunk.snapenhance.mapper.Mapper
</a><a href="#h64-0-10" id="h64-0-10" class="i">+import me.rhunk.snapenhance.mapper.impl.*
</a><a href="#h64-0-11" id="h64-0-11" class="i">+import java.util.concurrent.ConcurrentHashMap
</a><a href="#h64-0-12" id="h64-0-12" class="i">+import kotlin.system.measureTimeMillis
</a><a href="#h64-0-13" id="h64-0-13" class="i">+
</a><a href="#h64-0-14" id="h64-0-14" class="i">+class MappingsWrapper : FileLoaderWrapper(BridgeFileType.MAPPINGS, &quot;{}&quot;.toByteArray(Charsets.UTF_8)) {
</a><a href="#h64-0-15" id="h64-0-15" class="i">+    companion object {
</a><a href="#h64-0-16" id="h64-0-16" class="i">+        private val gson = GsonBuilder().setPrettyPrinting().create()
</a><a href="#h64-0-17" id="h64-0-17" class="i">+        private val mappers = arrayOf(
</a><a href="#h64-0-18" id="h64-0-18" class="i">+            BCryptClassMapper::class,
</a><a href="#h64-0-19" id="h64-0-19" class="i">+            CallbackMapper::class,
</a><a href="#h64-0-20" id="h64-0-20" class="i">+            DefaultMediaItemMapper::class,
</a><a href="#h64-0-21" id="h64-0-21" class="i">+            MediaQualityLevelProviderMapper::class,
</a><a href="#h64-0-22" id="h64-0-22" class="i">+            OperaPageViewControllerMapper::class,
</a><a href="#h64-0-23" id="h64-0-23" class="i">+            PlatformAnalyticsCreatorMapper::class,
</a><a href="#h64-0-24" id="h64-0-24" class="i">+            PlusSubscriptionMapper::class,
</a><a href="#h64-0-25" id="h64-0-25" class="i">+            ScCameraSettingsMapper::class,
</a><a href="#h64-0-26" id="h64-0-26" class="i">+            StoryBoostStateMapper::class,
</a><a href="#h64-0-27" id="h64-0-27" class="i">+            FriendsFeedEventDispatcherMapper::class,
</a><a href="#h64-0-28" id="h64-0-28" class="i">+            CompositeConfigurationProviderMapper::class,
</a><a href="#h64-0-29" id="h64-0-29" class="i">+            ScoreUpdateMapper::class,
</a><a href="#h64-0-30" id="h64-0-30" class="i">+            FriendRelationshipChangerMapper::class,
</a><a href="#h64-0-31" id="h64-0-31" class="i">+            ViewBinderMapper::class,
</a><a href="#h64-0-32" id="h64-0-32" class="i">+        )
</a><a href="#h64-0-33" id="h64-0-33" class="i">+    }
</a><a href="#h64-0-34" id="h64-0-34" class="i">+
</a><a href="#h64-0-35" id="h64-0-35" class="i">+    private lateinit var context: Context
</a><a href="#h64-0-36" id="h64-0-36" class="i">+
</a><a href="#h64-0-37" id="h64-0-37" class="i">+    private val mappings = ConcurrentHashMap&lt;String, Any&gt;()
</a><a href="#h64-0-38" id="h64-0-38" class="i">+    private var snapBuildNumber: Long = 0
</a><a href="#h64-0-39" id="h64-0-39" class="i">+
</a><a href="#h64-0-40" id="h64-0-40" class="i">+    fun init(context: Context) {
</a><a href="#h64-0-41" id="h64-0-41" class="i">+        this.context = context
</a><a href="#h64-0-42" id="h64-0-42" class="i">+        snapBuildNumber = getSnapchatVersionCode()
</a><a href="#h64-0-43" id="h64-0-43" class="i">+
</a><a href="#h64-0-44" id="h64-0-44" class="i">+        if (isFileExists()) {
</a><a href="#h64-0-45" id="h64-0-45" class="i">+            runCatching {
</a><a href="#h64-0-46" id="h64-0-46" class="i">+                loadCached()
</a><a href="#h64-0-47" id="h64-0-47" class="i">+            }.onFailure {
</a><a href="#h64-0-48" id="h64-0-48" class="i">+                delete()
</a><a href="#h64-0-49" id="h64-0-49" class="i">+            }
</a><a href="#h64-0-50" id="h64-0-50" class="i">+        }
</a><a href="#h64-0-51" id="h64-0-51" class="i">+    }
</a><a href="#h64-0-52" id="h64-0-52" class="i">+
</a><a href="#h64-0-53" id="h64-0-53" class="i">+    fun getSnapchatPackageInfo() = runCatching {
</a><a href="#h64-0-54" id="h64-0-54" class="i">+        context.packageManager.getPackageInfo(
</a><a href="#h64-0-55" id="h64-0-55" class="i">+            Constants.SNAPCHAT_PACKAGE_NAME,
</a><a href="#h64-0-56" id="h64-0-56" class="i">+            0
</a><a href="#h64-0-57" id="h64-0-57" class="i">+        )
</a><a href="#h64-0-58" id="h64-0-58" class="i">+    }.getOrNull()
</a><a href="#h64-0-59" id="h64-0-59" class="i">+
</a><a href="#h64-0-60" id="h64-0-60" class="i">+    fun getSnapchatVersionCode() = getSnapchatPackageInfo()?.longVersionCode ?: -1
</a><a href="#h64-0-61" id="h64-0-61" class="i">+    fun getApplicationSourceDir() = getSnapchatPackageInfo()?.applicationInfo?.sourceDir
</a><a href="#h64-0-62" id="h64-0-62" class="i">+    fun getGeneratedBuildNumber() = snapBuildNumber
</a><a href="#h64-0-63" id="h64-0-63" class="i">+
</a><a href="#h64-0-64" id="h64-0-64" class="i">+    fun isMappingsOutdated(): Boolean {
</a><a href="#h64-0-65" id="h64-0-65" class="i">+        return snapBuildNumber != getSnapchatVersionCode() || isMappingsLoaded().not()
</a><a href="#h64-0-66" id="h64-0-66" class="i">+    }
</a><a href="#h64-0-67" id="h64-0-67" class="i">+
</a><a href="#h64-0-68" id="h64-0-68" class="i">+    fun isMappingsLoaded(): Boolean {
</a><a href="#h64-0-69" id="h64-0-69" class="i">+        return mappings.isNotEmpty()
</a><a href="#h64-0-70" id="h64-0-70" class="i">+    }
</a><a href="#h64-0-71" id="h64-0-71" class="i">+
</a><a href="#h64-0-72" id="h64-0-72" class="i">+    private fun loadCached() {
</a><a href="#h64-0-73" id="h64-0-73" class="i">+        if (!isFileExists()) {
</a><a href="#h64-0-74" id="h64-0-74" class="i">+            throw Exception(&quot;Mappings file does not exist&quot;)
</a><a href="#h64-0-75" id="h64-0-75" class="i">+        }
</a><a href="#h64-0-76" id="h64-0-76" class="i">+        val mappingsObject = JsonParser.parseString(read().toString(Charsets.UTF_8)).asJsonObject.also {
</a><a href="#h64-0-77" id="h64-0-77" class="i">+            snapBuildNumber = it[&quot;snap_build_number&quot;].asLong
</a><a href="#h64-0-78" id="h64-0-78" class="i">+        }
</a><a href="#h64-0-79" id="h64-0-79" class="i">+
</a><a href="#h64-0-80" id="h64-0-80" class="i">+        mappingsObject.entrySet().forEach { (key, value): Map.Entry&lt;String, JsonElement&gt; -&gt;
</a><a href="#h64-0-81" id="h64-0-81" class="i">+            if (value.isJsonArray) {
</a><a href="#h64-0-82" id="h64-0-82" class="i">+                mappings[key] = gson.fromJson(value, ArrayList::class.java)
</a><a href="#h64-0-83" id="h64-0-83" class="i">+                return@forEach
</a><a href="#h64-0-84" id="h64-0-84" class="i">+            }
</a><a href="#h64-0-85" id="h64-0-85" class="i">+            if (value.isJsonObject) {
</a><a href="#h64-0-86" id="h64-0-86" class="i">+                mappings[key] = gson.fromJson(value, ConcurrentHashMap::class.java)
</a><a href="#h64-0-87" id="h64-0-87" class="i">+                return@forEach
</a><a href="#h64-0-88" id="h64-0-88" class="i">+            }
</a><a href="#h64-0-89" id="h64-0-89" class="i">+            mappings[key] = value.asString
</a><a href="#h64-0-90" id="h64-0-90" class="i">+        }
</a><a href="#h64-0-91" id="h64-0-91" class="i">+    }
</a><a href="#h64-0-92" id="h64-0-92" class="i">+
</a><a href="#h64-0-93" id="h64-0-93" class="i">+    fun refresh() {
</a><a href="#h64-0-94" id="h64-0-94" class="i">+        snapBuildNumber = getSnapchatVersionCode()
</a><a href="#h64-0-95" id="h64-0-95" class="i">+        val mapper = Mapper(*mappers)
</a><a href="#h64-0-96" id="h64-0-96" class="i">+
</a><a href="#h64-0-97" id="h64-0-97" class="i">+        runCatching {
</a><a href="#h64-0-98" id="h64-0-98" class="i">+            mapper.loadApk(getApplicationSourceDir() ?: throw Exception(&quot;Failed to get APK&quot;))
</a><a href="#h64-0-99" id="h64-0-99" class="i">+        }.onFailure {
</a><a href="#h64-0-100" id="h64-0-100" class="i">+            throw Exception(&quot;Failed to load APK&quot;, it)
</a><a href="#h64-0-101" id="h64-0-101" class="i">+        }
</a><a href="#h64-0-102" id="h64-0-102" class="i">+
</a><a href="#h64-0-103" id="h64-0-103" class="i">+        measureTimeMillis {
</a><a href="#h64-0-104" id="h64-0-104" class="i">+            val result = mapper.start().apply {
</a><a href="#h64-0-105" id="h64-0-105" class="i">+                addProperty(&quot;snap_build_number&quot;, snapBuildNumber)
</a><a href="#h64-0-106" id="h64-0-106" class="i">+            }
</a><a href="#h64-0-107" id="h64-0-107" class="i">+            write(result.toString().toByteArray())
</a><a href="#h64-0-108" id="h64-0-108" class="i">+        }
</a><a href="#h64-0-109" id="h64-0-109" class="i">+    }
</a><a href="#h64-0-110" id="h64-0-110" class="i">+
</a><a href="#h64-0-111" id="h64-0-111" class="i">+    fun getMappedObject(key: String): Any {
</a><a href="#h64-0-112" id="h64-0-112" class="i">+        if (mappings.containsKey(key)) {
</a><a href="#h64-0-113" id="h64-0-113" class="i">+            return mappings[key]!!
</a><a href="#h64-0-114" id="h64-0-114" class="i">+        }
</a><a href="#h64-0-115" id="h64-0-115" class="i">+        throw Exception(&quot;No mapping found for $key&quot;)
</a><a href="#h64-0-116" id="h64-0-116" class="i">+    }
</a><a href="#h64-0-117" id="h64-0-117" class="i">+
</a><a href="#h64-0-118" id="h64-0-118" class="i">+    fun getMappedObjectNullable(key: String): Any? {
</a><a href="#h64-0-119" id="h64-0-119" class="i">+        return mappings[key]
</a><a href="#h64-0-120" id="h64-0-120" class="i">+    }
</a><a href="#h64-0-121" id="h64-0-121" class="i">+
</a><a href="#h64-0-122" id="h64-0-122" class="i">+    fun getMappedClass(className: String): Class&lt;*&gt; {
</a><a href="#h64-0-123" id="h64-0-123" class="i">+        return context.classLoader.loadClass(getMappedObject(className) as String)
</a><a href="#h64-0-124" id="h64-0-124" class="i">+    }
</a><a href="#h64-0-125" id="h64-0-125" class="i">+
</a><a href="#h64-0-126" id="h64-0-126" class="i">+    fun getMappedClass(key: String, subKey: String): Class&lt;*&gt; {
</a><a href="#h64-0-127" id="h64-0-127" class="i">+        return context.classLoader.loadClass(getMappedValue(key, subKey))
</a><a href="#h64-0-128" id="h64-0-128" class="i">+    }
</a><a href="#h64-0-129" id="h64-0-129" class="i">+
</a><a href="#h64-0-130" id="h64-0-130" class="i">+    fun getMappedValue(key: String): String {
</a><a href="#h64-0-131" id="h64-0-131" class="i">+        return getMappedObject(key) as String
</a><a href="#h64-0-132" id="h64-0-132" class="i">+    }
</a><a href="#h64-0-133" id="h64-0-133" class="i">+
</a><a href="#h64-0-134" id="h64-0-134" class="i">+    @Suppress(&quot;UNCHECKED_CAST&quot;)
</a><a href="#h64-0-135" id="h64-0-135" class="i">+    fun &lt;T : Any&gt; getMappedList(key: String): List&lt;T&gt; {
</a><a href="#h64-0-136" id="h64-0-136" class="i">+        return listOf(getMappedObject(key) as List&lt;T&gt;).flatten()
</a><a href="#h64-0-137" id="h64-0-137" class="i">+    }
</a><a href="#h64-0-138" id="h64-0-138" class="i">+
</a><a href="#h64-0-139" id="h64-0-139" class="i">+    fun getMappedValue(key: String, subKey: String): String {
</a><a href="#h64-0-140" id="h64-0-140" class="i">+        return getMappedMap(key)[subKey] as String
</a><a href="#h64-0-141" id="h64-0-141" class="i">+    }
</a><a href="#h64-0-142" id="h64-0-142" class="i">+
</a><a href="#h64-0-143" id="h64-0-143" class="i">+    @Suppress(&quot;UNCHECKED_CAST&quot;)
</a><a href="#h64-0-144" id="h64-0-144" class="i">+    fun getMappedMap(key: String): Map&lt;String, *&gt; {
</a><a href="#h64-0-145" id="h64-0-145" class="i">+        return getMappedObject(key) as Map&lt;String, *&gt;
</a><a href="#h64-0-146" id="h64-0-146" class="i">+    }
</a><a href="#h64-0-147" id="h64-0-147" class="i">+}</a><a href="#h64-0-148" id="h64-0-148" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h65" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/wrapper/MessageLoggerWrapper.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/wrapper/MessageLoggerWrapper.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/wrapper/MessageLoggerWrapper.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/wrapper/MessageLoggerWrapper.kt</a></b>
<a href="#h65-0" id="h65-0" class="h">@@ -0,0 +1,79 @@
</a><a href="#h65-0-0" id="h65-0-0" class="i">+package me.rhunk.snapenhance.common.bridge.wrapper
</a><a href="#h65-0-1" id="h65-0-1" class="i">+
</a><a href="#h65-0-2" id="h65-0-2" class="i">+import android.content.ContentValues
</a><a href="#h65-0-3" id="h65-0-3" class="i">+import android.database.sqlite.SQLiteDatabase
</a><a href="#h65-0-4" id="h65-0-4" class="i">+import me.rhunk.snapenhance.bridge.MessageLoggerInterface
</a><a href="#h65-0-5" id="h65-0-5" class="i">+import me.rhunk.snapenhance.common.util.SQLiteDatabaseHelper
</a><a href="#h65-0-6" id="h65-0-6" class="i">+import java.io.File
</a><a href="#h65-0-7" id="h65-0-7" class="i">+import java.util.UUID
</a><a href="#h65-0-8" id="h65-0-8" class="i">+
</a><a href="#h65-0-9" id="h65-0-9" class="i">+class MessageLoggerWrapper(
</a><a href="#h65-0-10" id="h65-0-10" class="i">+    private val databaseFile: File
</a><a href="#h65-0-11" id="h65-0-11" class="i">+): MessageLoggerInterface.Stub() {
</a><a href="#h65-0-12" id="h65-0-12" class="i">+    private lateinit var database: SQLiteDatabase
</a><a href="#h65-0-13" id="h65-0-13" class="i">+
</a><a href="#h65-0-14" id="h65-0-14" class="i">+    fun init() {
</a><a href="#h65-0-15" id="h65-0-15" class="i">+        database = SQLiteDatabase.openDatabase(databaseFile.absolutePath, null, SQLiteDatabase.CREATE_IF_NECESSARY or SQLiteDatabase.OPEN_READWRITE)
</a><a href="#h65-0-16" id="h65-0-16" class="i">+        SQLiteDatabaseHelper.createTablesFromSchema(database, mapOf(
</a><a href="#h65-0-17" id="h65-0-17" class="i">+            &quot;messages&quot; to listOf(
</a><a href="#h65-0-18" id="h65-0-18" class="i">+                &quot;id INTEGER PRIMARY KEY&quot;,
</a><a href="#h65-0-19" id="h65-0-19" class="i">+                &quot;conversation_id VARCHAR&quot;,
</a><a href="#h65-0-20" id="h65-0-20" class="i">+                &quot;message_id BIGINT&quot;,
</a><a href="#h65-0-21" id="h65-0-21" class="i">+                &quot;message_data BLOB&quot;
</a><a href="#h65-0-22" id="h65-0-22" class="i">+            )
</a><a href="#h65-0-23" id="h65-0-23" class="i">+        ))
</a><a href="#h65-0-24" id="h65-0-24" class="i">+    }
</a><a href="#h65-0-25" id="h65-0-25" class="i">+
</a><a href="#h65-0-26" id="h65-0-26" class="i">+    override fun getLoggedIds(conversationId: Array&lt;String&gt;, limit: Int): LongArray {
</a><a href="#h65-0-27" id="h65-0-27" class="i">+        if (conversationId.any {
</a><a href="#h65-0-28" id="h65-0-28" class="i">+            runCatching { UUID.fromString(it) }.isFailure
</a><a href="#h65-0-29" id="h65-0-29" class="i">+        }) return longArrayOf()
</a><a href="#h65-0-30" id="h65-0-30" class="i">+
</a><a href="#h65-0-31" id="h65-0-31" class="i">+        val cursor = database.rawQuery(&quot;SELECT message_id FROM messages WHERE conversation_id IN (${
</a><a href="#h65-0-32" id="h65-0-32" class="i">+            conversationId.joinToString(
</a><a href="#h65-0-33" id="h65-0-33" class="i">+                &quot;,&quot;
</a><a href="#h65-0-34" id="h65-0-34" class="i">+            ) { &quot;&#39;$it&#39;&quot; }
</a><a href="#h65-0-35" id="h65-0-35" class="i">+        }) ORDER BY message_id DESC LIMIT $limit&quot;, null)
</a><a href="#h65-0-36" id="h65-0-36" class="i">+
</a><a href="#h65-0-37" id="h65-0-37" class="i">+        val ids = mutableListOf&lt;Long&gt;()
</a><a href="#h65-0-38" id="h65-0-38" class="i">+        while (cursor.moveToNext()) {
</a><a href="#h65-0-39" id="h65-0-39" class="i">+            ids.add(cursor.getLong(0))
</a><a href="#h65-0-40" id="h65-0-40" class="i">+        }
</a><a href="#h65-0-41" id="h65-0-41" class="i">+        cursor.close()
</a><a href="#h65-0-42" id="h65-0-42" class="i">+        return ids.toLongArray()
</a><a href="#h65-0-43" id="h65-0-43" class="i">+    }
</a><a href="#h65-0-44" id="h65-0-44" class="i">+
</a><a href="#h65-0-45" id="h65-0-45" class="i">+    override fun getMessage(conversationId: String?, id: Long): ByteArray? {
</a><a href="#h65-0-46" id="h65-0-46" class="i">+        val cursor = database.rawQuery(&quot;SELECT message_data FROM messages WHERE conversation_id = ? AND message_id = ?&quot;, arrayOf(conversationId, id.toString()))
</a><a href="#h65-0-47" id="h65-0-47" class="i">+        val message: ByteArray? = if (cursor.moveToFirst()) {
</a><a href="#h65-0-48" id="h65-0-48" class="i">+            cursor.getBlob(0)
</a><a href="#h65-0-49" id="h65-0-49" class="i">+        } else {
</a><a href="#h65-0-50" id="h65-0-50" class="i">+            null
</a><a href="#h65-0-51" id="h65-0-51" class="i">+        }
</a><a href="#h65-0-52" id="h65-0-52" class="i">+        cursor.close()
</a><a href="#h65-0-53" id="h65-0-53" class="i">+        return message
</a><a href="#h65-0-54" id="h65-0-54" class="i">+    }
</a><a href="#h65-0-55" id="h65-0-55" class="i">+
</a><a href="#h65-0-56" id="h65-0-56" class="i">+    override fun addMessage(conversationId: String, messageId: Long, serializedMessage: ByteArray): Boolean {
</a><a href="#h65-0-57" id="h65-0-57" class="i">+        val cursor = database.rawQuery(&quot;SELECT message_id FROM messages WHERE conversation_id = ? AND message_id = ?&quot;, arrayOf(conversationId, messageId.toString()))
</a><a href="#h65-0-58" id="h65-0-58" class="i">+        val state = cursor.moveToFirst()
</a><a href="#h65-0-59" id="h65-0-59" class="i">+        cursor.close()
</a><a href="#h65-0-60" id="h65-0-60" class="i">+        if (state) {
</a><a href="#h65-0-61" id="h65-0-61" class="i">+            return false
</a><a href="#h65-0-62" id="h65-0-62" class="i">+        }
</a><a href="#h65-0-63" id="h65-0-63" class="i">+        database.insert(&quot;messages&quot;, null, ContentValues().apply {
</a><a href="#h65-0-64" id="h65-0-64" class="i">+            put(&quot;conversation_id&quot;, conversationId)
</a><a href="#h65-0-65" id="h65-0-65" class="i">+            put(&quot;message_id&quot;, messageId)
</a><a href="#h65-0-66" id="h65-0-66" class="i">+            put(&quot;message_data&quot;, serializedMessage)
</a><a href="#h65-0-67" id="h65-0-67" class="i">+        })
</a><a href="#h65-0-68" id="h65-0-68" class="i">+        return true
</a><a href="#h65-0-69" id="h65-0-69" class="i">+    }
</a><a href="#h65-0-70" id="h65-0-70" class="i">+
</a><a href="#h65-0-71" id="h65-0-71" class="i">+    fun clearMessages() {
</a><a href="#h65-0-72" id="h65-0-72" class="i">+        database.execSQL(&quot;DELETE FROM messages&quot;)
</a><a href="#h65-0-73" id="h65-0-73" class="i">+    }
</a><a href="#h65-0-74" id="h65-0-74" class="i">+
</a><a href="#h65-0-75" id="h65-0-75" class="i">+    override fun deleteMessage(conversationId: String, messageId: Long) {
</a><a href="#h65-0-76" id="h65-0-76" class="i">+        database.execSQL(&quot;DELETE FROM messages WHERE conversation_id = ? AND message_id = ?&quot;, arrayOf(conversationId, messageId.toString()))
</a><a href="#h65-0-77" id="h65-0-77" class="i">+    }
</a><a href="#h65-0-78" id="h65-0-78" class="i">+}</a><a href="#h65-0-79" id="h65-0-79" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h66" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/config/ConfigContainer.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/config/ConfigContainer.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/config/ConfigContainer.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/config/ConfigContainer.kt</a></b>
<a href="#h66-0" id="h66-0" class="h">@@ -0,0 +1,82 @@
</a><a href="#h66-0-0" id="h66-0-0" class="i">+package me.rhunk.snapenhance.common.config
</a><a href="#h66-0-1" id="h66-0-1" class="i">+
</a><a href="#h66-0-2" id="h66-0-2" class="i">+import com.google.gson.JsonObject
</a><a href="#h66-0-3" id="h66-0-3" class="i">+import kotlin.reflect.KProperty
</a><a href="#h66-0-4" id="h66-0-4" class="i">+
</a><a href="#h66-0-5" id="h66-0-5" class="i">+typealias ConfigParamsBuilder = ConfigParams.() -&gt; Unit
</a><a href="#h66-0-6" id="h66-0-6" class="i">+
</a><a href="#h66-0-7" id="h66-0-7" class="i">+open class ConfigContainer(
</a><a href="#h66-0-8" id="h66-0-8" class="i">+    val hasGlobalState: Boolean = false
</a><a href="#h66-0-9" id="h66-0-9" class="i">+) {
</a><a href="#h66-0-10" id="h66-0-10" class="i">+    var parentContainerKey: PropertyKey&lt;*&gt;? = null
</a><a href="#h66-0-11" id="h66-0-11" class="i">+    val properties = mutableMapOf&lt;PropertyKey&lt;*&gt;, PropertyValue&lt;*&gt;&gt;()
</a><a href="#h66-0-12" id="h66-0-12" class="i">+    var globalState: Boolean? = null
</a><a href="#h66-0-13" id="h66-0-13" class="i">+
</a><a href="#h66-0-14" id="h66-0-14" class="i">+    private inline fun &lt;T&gt; registerProperty(
</a><a href="#h66-0-15" id="h66-0-15" class="i">+        key: String,
</a><a href="#h66-0-16" id="h66-0-16" class="i">+        type: DataProcessors.PropertyDataProcessor&lt;*&gt;,
</a><a href="#h66-0-17" id="h66-0-17" class="i">+        defaultValue: PropertyValue&lt;T&gt;,
</a><a href="#h66-0-18" id="h66-0-18" class="i">+        params: ConfigParams.() -&gt; Unit = {},
</a><a href="#h66-0-19" id="h66-0-19" class="i">+        propertyKeyCallback: (PropertyKey&lt;*&gt;) -&gt; Unit = {}
</a><a href="#h66-0-20" id="h66-0-20" class="i">+    ): PropertyValue&lt;T&gt; {
</a><a href="#h66-0-21" id="h66-0-21" class="i">+        val propertyKey = PropertyKey({ parentContainerKey }, key, type, ConfigParams().also { it.params() })
</a><a href="#h66-0-22" id="h66-0-22" class="i">+        properties[propertyKey] = defaultValue
</a><a href="#h66-0-23" id="h66-0-23" class="i">+        propertyKeyCallback(propertyKey)
</a><a href="#h66-0-24" id="h66-0-24" class="i">+        return defaultValue
</a><a href="#h66-0-25" id="h66-0-25" class="i">+    }
</a><a href="#h66-0-26" id="h66-0-26" class="i">+
</a><a href="#h66-0-27" id="h66-0-27" class="i">+    protected fun boolean(key: String, defaultValue: Boolean = false, params: ConfigParamsBuilder = {}) =
</a><a href="#h66-0-28" id="h66-0-28" class="i">+        registerProperty(key, DataProcessors.BOOLEAN, PropertyValue(defaultValue), params)
</a><a href="#h66-0-29" id="h66-0-29" class="i">+
</a><a href="#h66-0-30" id="h66-0-30" class="i">+    protected fun integer(key: String, defaultValue: Int = 0, params: ConfigParamsBuilder = {}) =
</a><a href="#h66-0-31" id="h66-0-31" class="i">+        registerProperty(key, DataProcessors.INTEGER, PropertyValue(defaultValue), params)
</a><a href="#h66-0-32" id="h66-0-32" class="i">+
</a><a href="#h66-0-33" id="h66-0-33" class="i">+    protected fun float(key: String, defaultValue: Float = 0f, params: ConfigParamsBuilder = {}) =
</a><a href="#h66-0-34" id="h66-0-34" class="i">+        registerProperty(key, DataProcessors.FLOAT, PropertyValue(defaultValue), params)
</a><a href="#h66-0-35" id="h66-0-35" class="i">+
</a><a href="#h66-0-36" id="h66-0-36" class="i">+    protected fun string(key: String, defaultValue: String = &quot;&quot;, params: ConfigParamsBuilder = {}) =
</a><a href="#h66-0-37" id="h66-0-37" class="i">+        registerProperty(key, DataProcessors.STRING, PropertyValue(defaultValue), params)
</a><a href="#h66-0-38" id="h66-0-38" class="i">+
</a><a href="#h66-0-39" id="h66-0-39" class="i">+    protected fun multiple(
</a><a href="#h66-0-40" id="h66-0-40" class="i">+        key: String,
</a><a href="#h66-0-41" id="h66-0-41" class="i">+        vararg values: String = emptyArray(),
</a><a href="#h66-0-42" id="h66-0-42" class="i">+        params: ConfigParamsBuilder = {}
</a><a href="#h66-0-43" id="h66-0-43" class="i">+    ) = registerProperty(key,
</a><a href="#h66-0-44" id="h66-0-44" class="i">+        DataProcessors.STRING_MULTIPLE_SELECTION, PropertyValue(mutableListOf&lt;String&gt;(), defaultValues = values.toList()), params)
</a><a href="#h66-0-45" id="h66-0-45" class="i">+
</a><a href="#h66-0-46" id="h66-0-46" class="i">+    //null value is considered as Off/Disabled
</a><a href="#h66-0-47" id="h66-0-47" class="i">+    protected fun unique(
</a><a href="#h66-0-48" id="h66-0-48" class="i">+        key: String,
</a><a href="#h66-0-49" id="h66-0-49" class="i">+        vararg values: String = emptyArray(),
</a><a href="#h66-0-50" id="h66-0-50" class="i">+        params: ConfigParamsBuilder = {}
</a><a href="#h66-0-51" id="h66-0-51" class="i">+    ) = registerProperty(key,
</a><a href="#h66-0-52" id="h66-0-52" class="i">+        DataProcessors.STRING_UNIQUE_SELECTION, PropertyValue(&quot;null&quot;, defaultValues = values.toList()), params)
</a><a href="#h66-0-53" id="h66-0-53" class="i">+
</a><a href="#h66-0-54" id="h66-0-54" class="i">+    protected fun &lt;T : ConfigContainer&gt; container(
</a><a href="#h66-0-55" id="h66-0-55" class="i">+        key: String,
</a><a href="#h66-0-56" id="h66-0-56" class="i">+        container: T,
</a><a href="#h66-0-57" id="h66-0-57" class="i">+        params: ConfigParamsBuilder = {}
</a><a href="#h66-0-58" id="h66-0-58" class="i">+    ) = registerProperty(key, DataProcessors.container(container), PropertyValue(container), params) {
</a><a href="#h66-0-59" id="h66-0-59" class="i">+        container.parentContainerKey = it
</a><a href="#h66-0-60" id="h66-0-60" class="i">+    }.get()
</a><a href="#h66-0-61" id="h66-0-61" class="i">+
</a><a href="#h66-0-62" id="h66-0-62" class="i">+    fun toJson(): JsonObject {
</a><a href="#h66-0-63" id="h66-0-63" class="i">+        val json = JsonObject()
</a><a href="#h66-0-64" id="h66-0-64" class="i">+        properties.forEach { (propertyKey, propertyValue) -&gt;
</a><a href="#h66-0-65" id="h66-0-65" class="i">+            val serializedValue = propertyValue.getNullable()?.let { propertyKey.dataType.serializeAny(it) }
</a><a href="#h66-0-66" id="h66-0-66" class="i">+            json.add(propertyKey.name, serializedValue)
</a><a href="#h66-0-67" id="h66-0-67" class="i">+        }
</a><a href="#h66-0-68" id="h66-0-68" class="i">+        return json
</a><a href="#h66-0-69" id="h66-0-69" class="i">+    }
</a><a href="#h66-0-70" id="h66-0-70" class="i">+
</a><a href="#h66-0-71" id="h66-0-71" class="i">+    fun fromJson(json: JsonObject) {
</a><a href="#h66-0-72" id="h66-0-72" class="i">+        properties.forEach { (key, _) -&gt;
</a><a href="#h66-0-73" id="h66-0-73" class="i">+            val jsonElement = json.get(key.name) ?: return@forEach
</a><a href="#h66-0-74" id="h66-0-74" class="i">+            //TODO: check incoming values
</a><a href="#h66-0-75" id="h66-0-75" class="i">+            properties[key]?.setAny(key.dataType.deserializeAny(jsonElement))
</a><a href="#h66-0-76" id="h66-0-76" class="i">+        }
</a><a href="#h66-0-77" id="h66-0-77" class="i">+    }
</a><a href="#h66-0-78" id="h66-0-78" class="i">+
</a><a href="#h66-0-79" id="h66-0-79" class="i">+    operator fun getValue(t: Any?, property: KProperty&lt;*&gt;) = this.globalState
</a><a href="#h66-0-80" id="h66-0-80" class="i">+    operator fun setValue(t: Any?, property: KProperty&lt;*&gt;, t1: Boolean?) { this.globalState = t1 }
</a><a href="#h66-0-81" id="h66-0-81" class="i">+}</a><a href="#h66-0-82" id="h66-0-82" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h67" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/config/ConfigObjects.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/config/ConfigObjects.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/config/ConfigObjects.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/config/ConfigObjects.kt</a></b>
<a href="#h67-0" id="h67-0" class="h">@@ -0,0 +1,117 @@
</a><a href="#h67-0-0" id="h67-0-0" class="i">+package me.rhunk.snapenhance.common.config
</a><a href="#h67-0-1" id="h67-0-1" class="i">+
</a><a href="#h67-0-2" id="h67-0-2" class="i">+import me.rhunk.snapenhance.common.bridge.wrapper.LocaleWrapper
</a><a href="#h67-0-3" id="h67-0-3" class="i">+import kotlin.reflect.KProperty
</a><a href="#h67-0-4" id="h67-0-4" class="i">+
</a><a href="#h67-0-5" id="h67-0-5" class="i">+data class PropertyPair&lt;T&gt;(
</a><a href="#h67-0-6" id="h67-0-6" class="i">+    val key: PropertyKey&lt;T&gt;,
</a><a href="#h67-0-7" id="h67-0-7" class="i">+    val value: PropertyValue&lt;*&gt;
</a><a href="#h67-0-8" id="h67-0-8" class="i">+) {
</a><a href="#h67-0-9" id="h67-0-9" class="i">+    val name get() = key.name
</a><a href="#h67-0-10" id="h67-0-10" class="i">+}
</a><a href="#h67-0-11" id="h67-0-11" class="i">+
</a><a href="#h67-0-12" id="h67-0-12" class="i">+enum class FeatureNotice(
</a><a href="#h67-0-13" id="h67-0-13" class="i">+    val id: Int,
</a><a href="#h67-0-14" id="h67-0-14" class="i">+    val key: String
</a><a href="#h67-0-15" id="h67-0-15" class="i">+) {
</a><a href="#h67-0-16" id="h67-0-16" class="i">+    UNSTABLE(0b0001, &quot;unstable&quot;),
</a><a href="#h67-0-17" id="h67-0-17" class="i">+    BAN_RISK(0b0010, &quot;ban_risk&quot;),
</a><a href="#h67-0-18" id="h67-0-18" class="i">+    INTERNAL_BEHAVIOR(0b0100, &quot;internal_behavior&quot;)
</a><a href="#h67-0-19" id="h67-0-19" class="i">+}
</a><a href="#h67-0-20" id="h67-0-20" class="i">+
</a><a href="#h67-0-21" id="h67-0-21" class="i">+enum class ConfigFlag(
</a><a href="#h67-0-22" id="h67-0-22" class="i">+    val id: Int
</a><a href="#h67-0-23" id="h67-0-23" class="i">+) {
</a><a href="#h67-0-24" id="h67-0-24" class="i">+    NO_TRANSLATE(0b000001),
</a><a href="#h67-0-25" id="h67-0-25" class="i">+    HIDDEN(0b000010),
</a><a href="#h67-0-26" id="h67-0-26" class="i">+    FOLDER(0b000100),
</a><a href="#h67-0-27" id="h67-0-27" class="i">+    NO_DISABLE_KEY(0b001000),
</a><a href="#h67-0-28" id="h67-0-28" class="i">+    REQUIRE_RESTART(0b010000),
</a><a href="#h67-0-29" id="h67-0-29" class="i">+    REQUIRE_CLEAN_CACHE(0b100000)
</a><a href="#h67-0-30" id="h67-0-30" class="i">+}
</a><a href="#h67-0-31" id="h67-0-31" class="i">+
</a><a href="#h67-0-32" id="h67-0-32" class="i">+class ConfigParams(
</a><a href="#h67-0-33" id="h67-0-33" class="i">+    private var _flags: Int? = null,
</a><a href="#h67-0-34" id="h67-0-34" class="i">+    private var _notices: Int? = null,
</a><a href="#h67-0-35" id="h67-0-35" class="i">+
</a><a href="#h67-0-36" id="h67-0-36" class="i">+    var icon: String? = null,
</a><a href="#h67-0-37" id="h67-0-37" class="i">+    var disabledKey: String? = null,
</a><a href="#h67-0-38" id="h67-0-38" class="i">+    var customTranslationPath: String? = null,
</a><a href="#h67-0-39" id="h67-0-39" class="i">+    var customOptionTranslationPath: String? = null
</a><a href="#h67-0-40" id="h67-0-40" class="i">+) {
</a><a href="#h67-0-41" id="h67-0-41" class="i">+    val notices get() = _notices?.let { FeatureNotice.entries.filter { flag -&gt; it and flag.id != 0 } } ?: emptyList()
</a><a href="#h67-0-42" id="h67-0-42" class="i">+    val flags get() = _flags?.let { ConfigFlag.entries.filter { flag -&gt; it and flag.id != 0 } } ?: emptyList()
</a><a href="#h67-0-43" id="h67-0-43" class="i">+
</a><a href="#h67-0-44" id="h67-0-44" class="i">+    fun addNotices(vararg values: FeatureNotice) {
</a><a href="#h67-0-45" id="h67-0-45" class="i">+        this._notices = (this._notices ?: 0) or values.fold(0) { acc, featureNotice -&gt; acc or featureNotice.id }
</a><a href="#h67-0-46" id="h67-0-46" class="i">+    }
</a><a href="#h67-0-47" id="h67-0-47" class="i">+
</a><a href="#h67-0-48" id="h67-0-48" class="i">+    fun addFlags(vararg values: ConfigFlag) {
</a><a href="#h67-0-49" id="h67-0-49" class="i">+        this._flags = (this._flags ?: 0) or values.fold(0) { acc, flag -&gt; acc or flag.id }
</a><a href="#h67-0-50" id="h67-0-50" class="i">+    }
</a><a href="#h67-0-51" id="h67-0-51" class="i">+
</a><a href="#h67-0-52" id="h67-0-52" class="i">+    fun requireRestart() {
</a><a href="#h67-0-53" id="h67-0-53" class="i">+        addFlags(ConfigFlag.REQUIRE_RESTART)
</a><a href="#h67-0-54" id="h67-0-54" class="i">+    }
</a><a href="#h67-0-55" id="h67-0-55" class="i">+    fun requireCleanCache() {
</a><a href="#h67-0-56" id="h67-0-56" class="i">+        addFlags(ConfigFlag.REQUIRE_CLEAN_CACHE)
</a><a href="#h67-0-57" id="h67-0-57" class="i">+    }
</a><a href="#h67-0-58" id="h67-0-58" class="i">+}
</a><a href="#h67-0-59" id="h67-0-59" class="i">+
</a><a href="#h67-0-60" id="h67-0-60" class="i">+class PropertyValue&lt;T&gt;(
</a><a href="#h67-0-61" id="h67-0-61" class="i">+    private var value: T? = null,
</a><a href="#h67-0-62" id="h67-0-62" class="i">+    val defaultValues: List&lt;*&gt;? = null
</a><a href="#h67-0-63" id="h67-0-63" class="i">+) {
</a><a href="#h67-0-64" id="h67-0-64" class="i">+    inner class PropertyValueNullable {
</a><a href="#h67-0-65" id="h67-0-65" class="i">+        fun get() = value
</a><a href="#h67-0-66" id="h67-0-66" class="i">+        operator fun getValue(t: Any?, property: KProperty&lt;*&gt;): T? = getNullable()
</a><a href="#h67-0-67" id="h67-0-67" class="i">+        operator fun setValue(t: Any?, property: KProperty&lt;*&gt;, t1: T?) = set(t1)
</a><a href="#h67-0-68" id="h67-0-68" class="i">+    }
</a><a href="#h67-0-69" id="h67-0-69" class="i">+
</a><a href="#h67-0-70" id="h67-0-70" class="i">+    fun nullable() = PropertyValueNullable()
</a><a href="#h67-0-71" id="h67-0-71" class="i">+
</a><a href="#h67-0-72" id="h67-0-72" class="i">+    fun isSet() = value != null
</a><a href="#h67-0-73" id="h67-0-73" class="i">+    fun getNullable() = value?.takeIf { it != &quot;null&quot; }
</a><a href="#h67-0-74" id="h67-0-74" class="i">+    fun isEmpty() = value == null || value == &quot;null&quot; || value.toString().isEmpty()
</a><a href="#h67-0-75" id="h67-0-75" class="i">+    fun get() = getNullable() ?: throw IllegalStateException(&quot;Property is not set&quot;)
</a><a href="#h67-0-76" id="h67-0-76" class="i">+    fun set(value: T?) { setAny(value) }
</a><a href="#h67-0-77" id="h67-0-77" class="i">+    @Suppress(&quot;UNCHECKED_CAST&quot;)
</a><a href="#h67-0-78" id="h67-0-78" class="i">+    fun setAny(value: Any?) { this.value = value as T? }
</a><a href="#h67-0-79" id="h67-0-79" class="i">+
</a><a href="#h67-0-80" id="h67-0-80" class="i">+    operator fun getValue(t: Any?, property: KProperty&lt;*&gt;): T = get()
</a><a href="#h67-0-81" id="h67-0-81" class="i">+    operator fun setValue(t: Any?, property: KProperty&lt;*&gt;, t1: T?) = set(t1)
</a><a href="#h67-0-82" id="h67-0-82" class="i">+}
</a><a href="#h67-0-83" id="h67-0-83" class="i">+
</a><a href="#h67-0-84" id="h67-0-84" class="i">+data class PropertyKey&lt;T&gt;(
</a><a href="#h67-0-85" id="h67-0-85" class="i">+    private val _parent: () -&gt; PropertyKey&lt;*&gt;?,
</a><a href="#h67-0-86" id="h67-0-86" class="i">+    val name: String,
</a><a href="#h67-0-87" id="h67-0-87" class="i">+    val dataType: DataProcessors.PropertyDataProcessor&lt;T&gt;,
</a><a href="#h67-0-88" id="h67-0-88" class="i">+    val params: ConfigParams = ConfigParams(),
</a><a href="#h67-0-89" id="h67-0-89" class="i">+) {
</a><a href="#h67-0-90" id="h67-0-90" class="i">+    private val parentKey by lazy { _parent() }
</a><a href="#h67-0-91" id="h67-0-91" class="i">+
</a><a href="#h67-0-92" id="h67-0-92" class="i">+    fun propertyOption(translation: LocaleWrapper, key: String): String {
</a><a href="#h67-0-93" id="h67-0-93" class="i">+        if (key == &quot;null&quot;) {
</a><a href="#h67-0-94" id="h67-0-94" class="i">+            return translation[params.disabledKey ?: &quot;manager.sections.features.disabled&quot;]
</a><a href="#h67-0-95" id="h67-0-95" class="i">+        }
</a><a href="#h67-0-96" id="h67-0-96" class="i">+
</a><a href="#h67-0-97" id="h67-0-97" class="i">+        return if (!params.flags.contains(ConfigFlag.NO_TRANSLATE))
</a><a href="#h67-0-98" id="h67-0-98" class="i">+            translation[params.customOptionTranslationPath?.let {
</a><a href="#h67-0-99" id="h67-0-99" class="i">+                &quot;$it.$key&quot;
</a><a href="#h67-0-100" id="h67-0-100" class="i">+            } ?: &quot;features.options.${name}.$key&quot;]
</a><a href="#h67-0-101" id="h67-0-101" class="i">+        else key
</a><a href="#h67-0-102" id="h67-0-102" class="i">+    }
</a><a href="#h67-0-103" id="h67-0-103" class="i">+
</a><a href="#h67-0-104" id="h67-0-104" class="i">+    fun propertyName() = propertyTranslationPath() + &quot;.name&quot;
</a><a href="#h67-0-105" id="h67-0-105" class="i">+    fun propertyDescription() = propertyTranslationPath() + &quot;.description&quot;
</a><a href="#h67-0-106" id="h67-0-106" class="i">+
</a><a href="#h67-0-107" id="h67-0-107" class="i">+    fun propertyTranslationPath(): String {
</a><a href="#h67-0-108" id="h67-0-108" class="i">+        params.customTranslationPath?.let {
</a><a href="#h67-0-109" id="h67-0-109" class="i">+            return it
</a><a href="#h67-0-110" id="h67-0-110" class="i">+        }
</a><a href="#h67-0-111" id="h67-0-111" class="i">+        return parentKey?.let {
</a><a href="#h67-0-112" id="h67-0-112" class="i">+            &quot;${it.propertyTranslationPath()}.properties.$name&quot;
</a><a href="#h67-0-113" id="h67-0-113" class="i">+        } ?: &quot;features.properties.$name&quot;
</a><a href="#h67-0-114" id="h67-0-114" class="i">+    }
</a><a href="#h67-0-115" id="h67-0-115" class="i">+}
</a><a href="#h67-0-116" id="h67-0-116" class="i">+
</a><b>diff --git a/<a id="h68" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/config/DataProcessors.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/config/DataProcessors.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/config/DataProcessors.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/config/DataProcessors.kt</a></b>
<a href="#h68-0" id="h68-0" class="h">@@ -0,0 +1,94 @@
</a><a href="#h68-0-0" id="h68-0-0" class="i">+package me.rhunk.snapenhance.common.config
</a><a href="#h68-0-1" id="h68-0-1" class="i">+
</a><a href="#h68-0-2" id="h68-0-2" class="i">+import com.google.gson.JsonArray
</a><a href="#h68-0-3" id="h68-0-3" class="i">+import com.google.gson.JsonElement
</a><a href="#h68-0-4" id="h68-0-4" class="i">+import com.google.gson.JsonNull
</a><a href="#h68-0-5" id="h68-0-5" class="i">+import com.google.gson.JsonObject
</a><a href="#h68-0-6" id="h68-0-6" class="i">+import com.google.gson.JsonPrimitive
</a><a href="#h68-0-7" id="h68-0-7" class="i">+
</a><a href="#h68-0-8" id="h68-0-8" class="i">+object DataProcessors {
</a><a href="#h68-0-9" id="h68-0-9" class="i">+    enum class Type {
</a><a href="#h68-0-10" id="h68-0-10" class="i">+        STRING,
</a><a href="#h68-0-11" id="h68-0-11" class="i">+        BOOLEAN,
</a><a href="#h68-0-12" id="h68-0-12" class="i">+        INTEGER,
</a><a href="#h68-0-13" id="h68-0-13" class="i">+        FLOAT,
</a><a href="#h68-0-14" id="h68-0-14" class="i">+        STRING_MULTIPLE_SELECTION,
</a><a href="#h68-0-15" id="h68-0-15" class="i">+        STRING_UNIQUE_SELECTION,
</a><a href="#h68-0-16" id="h68-0-16" class="i">+        CONTAINER,
</a><a href="#h68-0-17" id="h68-0-17" class="i">+    }
</a><a href="#h68-0-18" id="h68-0-18" class="i">+
</a><a href="#h68-0-19" id="h68-0-19" class="i">+    data class PropertyDataProcessor&lt;T&gt;
</a><a href="#h68-0-20" id="h68-0-20" class="i">+    internal constructor(
</a><a href="#h68-0-21" id="h68-0-21" class="i">+        val type: Type,
</a><a href="#h68-0-22" id="h68-0-22" class="i">+        private val serialize: (T) -&gt; JsonElement,
</a><a href="#h68-0-23" id="h68-0-23" class="i">+        private val deserialize: (JsonElement) -&gt; T
</a><a href="#h68-0-24" id="h68-0-24" class="i">+    ) {
</a><a href="#h68-0-25" id="h68-0-25" class="i">+        @Suppress(&quot;UNCHECKED_CAST&quot;)
</a><a href="#h68-0-26" id="h68-0-26" class="i">+        fun serializeAny(value: Any) = serialize(value as T)
</a><a href="#h68-0-27" id="h68-0-27" class="i">+        fun deserializeAny(value: JsonElement) = deserialize(value)
</a><a href="#h68-0-28" id="h68-0-28" class="i">+    }
</a><a href="#h68-0-29" id="h68-0-29" class="i">+
</a><a href="#h68-0-30" id="h68-0-30" class="i">+    val STRING = PropertyDataProcessor(
</a><a href="#h68-0-31" id="h68-0-31" class="i">+        type = Type.STRING,
</a><a href="#h68-0-32" id="h68-0-32" class="i">+        serialize = {
</a><a href="#h68-0-33" id="h68-0-33" class="i">+            if (it != null) JsonPrimitive(it)
</a><a href="#h68-0-34" id="h68-0-34" class="i">+            else JsonNull.INSTANCE
</a><a href="#h68-0-35" id="h68-0-35" class="i">+        },
</a><a href="#h68-0-36" id="h68-0-36" class="i">+        deserialize = {
</a><a href="#h68-0-37" id="h68-0-37" class="i">+            if (it.isJsonNull) null
</a><a href="#h68-0-38" id="h68-0-38" class="i">+            else it.asString
</a><a href="#h68-0-39" id="h68-0-39" class="i">+        },
</a><a href="#h68-0-40" id="h68-0-40" class="i">+    )
</a><a href="#h68-0-41" id="h68-0-41" class="i">+
</a><a href="#h68-0-42" id="h68-0-42" class="i">+    val BOOLEAN = PropertyDataProcessor(
</a><a href="#h68-0-43" id="h68-0-43" class="i">+        type = Type.BOOLEAN,
</a><a href="#h68-0-44" id="h68-0-44" class="i">+        serialize = {
</a><a href="#h68-0-45" id="h68-0-45" class="i">+            if (it) JsonPrimitive(true)
</a><a href="#h68-0-46" id="h68-0-46" class="i">+            else JsonPrimitive(false)
</a><a href="#h68-0-47" id="h68-0-47" class="i">+        },
</a><a href="#h68-0-48" id="h68-0-48" class="i">+        deserialize = { it.asBoolean },
</a><a href="#h68-0-49" id="h68-0-49" class="i">+    )
</a><a href="#h68-0-50" id="h68-0-50" class="i">+
</a><a href="#h68-0-51" id="h68-0-51" class="i">+    val INTEGER = PropertyDataProcessor(
</a><a href="#h68-0-52" id="h68-0-52" class="i">+        type = Type.INTEGER,
</a><a href="#h68-0-53" id="h68-0-53" class="i">+        serialize = { JsonPrimitive(it) },
</a><a href="#h68-0-54" id="h68-0-54" class="i">+        deserialize = { it.asInt },
</a><a href="#h68-0-55" id="h68-0-55" class="i">+    )
</a><a href="#h68-0-56" id="h68-0-56" class="i">+
</a><a href="#h68-0-57" id="h68-0-57" class="i">+    val FLOAT = PropertyDataProcessor(
</a><a href="#h68-0-58" id="h68-0-58" class="i">+        type = Type.FLOAT,
</a><a href="#h68-0-59" id="h68-0-59" class="i">+        serialize = { JsonPrimitive(it) },
</a><a href="#h68-0-60" id="h68-0-60" class="i">+        deserialize = { it.asFloat },
</a><a href="#h68-0-61" id="h68-0-61" class="i">+    )
</a><a href="#h68-0-62" id="h68-0-62" class="i">+
</a><a href="#h68-0-63" id="h68-0-63" class="i">+    val STRING_MULTIPLE_SELECTION = PropertyDataProcessor(
</a><a href="#h68-0-64" id="h68-0-64" class="i">+        type = Type.STRING_MULTIPLE_SELECTION,
</a><a href="#h68-0-65" id="h68-0-65" class="i">+        serialize = { JsonArray().apply { it.forEach { add(it) } } },
</a><a href="#h68-0-66" id="h68-0-66" class="i">+        deserialize = { obj -&gt;
</a><a href="#h68-0-67" id="h68-0-67" class="i">+            obj.asJsonArray.map { it.asString }.toMutableList()
</a><a href="#h68-0-68" id="h68-0-68" class="i">+        },
</a><a href="#h68-0-69" id="h68-0-69" class="i">+    )
</a><a href="#h68-0-70" id="h68-0-70" class="i">+
</a><a href="#h68-0-71" id="h68-0-71" class="i">+    val STRING_UNIQUE_SELECTION = PropertyDataProcessor(
</a><a href="#h68-0-72" id="h68-0-72" class="i">+        type = Type.STRING_UNIQUE_SELECTION,
</a><a href="#h68-0-73" id="h68-0-73" class="i">+        serialize = { JsonPrimitive(it) },
</a><a href="#h68-0-74" id="h68-0-74" class="i">+        deserialize = { obj -&gt; obj.takeIf { !it.isJsonNull }?.asString }
</a><a href="#h68-0-75" id="h68-0-75" class="i">+    )
</a><a href="#h68-0-76" id="h68-0-76" class="i">+
</a><a href="#h68-0-77" id="h68-0-77" class="i">+    fun &lt;T : ConfigContainer&gt; container(container: T) = PropertyDataProcessor(
</a><a href="#h68-0-78" id="h68-0-78" class="i">+        type = Type.CONTAINER,
</a><a href="#h68-0-79" id="h68-0-79" class="i">+        serialize = {
</a><a href="#h68-0-80" id="h68-0-80" class="i">+            JsonObject().apply {
</a><a href="#h68-0-81" id="h68-0-81" class="i">+                addProperty(&quot;state&quot;, it.globalState)
</a><a href="#h68-0-82" id="h68-0-82" class="i">+                add(&quot;properties&quot;, it.toJson())
</a><a href="#h68-0-83" id="h68-0-83" class="i">+            }
</a><a href="#h68-0-84" id="h68-0-84" class="i">+        },
</a><a href="#h68-0-85" id="h68-0-85" class="i">+        deserialize = { obj -&gt;
</a><a href="#h68-0-86" id="h68-0-86" class="i">+            val jsonObject = obj.asJsonObject
</a><a href="#h68-0-87" id="h68-0-87" class="i">+            container.apply {
</a><a href="#h68-0-88" id="h68-0-88" class="i">+                globalState = jsonObject[&quot;state&quot;].takeIf { !it.isJsonNull }?.asBoolean
</a><a href="#h68-0-89" id="h68-0-89" class="i">+                fromJson(jsonObject[&quot;properties&quot;].asJsonObject)
</a><a href="#h68-0-90" id="h68-0-90" class="i">+            }
</a><a href="#h68-0-91" id="h68-0-91" class="i">+        },
</a><a href="#h68-0-92" id="h68-0-92" class="i">+    )
</a><a href="#h68-0-93" id="h68-0-93" class="i">+}</a><a href="#h68-0-94" id="h68-0-94" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h69" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/config/ModConfig.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/config/ModConfig.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/config/ModConfig.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/config/ModConfig.kt</a></b>
<a href="#h69-0" id="h69-0" class="h">@@ -0,0 +1,131 @@
</a><a href="#h69-0-0" id="h69-0-0" class="i">+package me.rhunk.snapenhance.common.config
</a><a href="#h69-0-1" id="h69-0-1" class="i">+
</a><a href="#h69-0-2" id="h69-0-2" class="i">+import android.content.Context
</a><a href="#h69-0-3" id="h69-0-3" class="i">+import com.google.gson.Gson
</a><a href="#h69-0-4" id="h69-0-4" class="i">+import com.google.gson.GsonBuilder
</a><a href="#h69-0-5" id="h69-0-5" class="i">+import com.google.gson.JsonObject
</a><a href="#h69-0-6" id="h69-0-6" class="i">+import me.rhunk.snapenhance.bridge.ConfigStateListener
</a><a href="#h69-0-7" id="h69-0-7" class="i">+import me.rhunk.snapenhance.common.bridge.FileLoaderWrapper
</a><a href="#h69-0-8" id="h69-0-8" class="i">+import me.rhunk.snapenhance.common.bridge.types.BridgeFileType
</a><a href="#h69-0-9" id="h69-0-9" class="i">+import me.rhunk.snapenhance.common.bridge.wrapper.LocaleWrapper
</a><a href="#h69-0-10" id="h69-0-10" class="i">+import me.rhunk.snapenhance.common.config.impl.RootConfig
</a><a href="#h69-0-11" id="h69-0-11" class="i">+import me.rhunk.snapenhance.common.logger.AbstractLogger
</a><a href="#h69-0-12" id="h69-0-12" class="i">+import kotlin.properties.Delegates
</a><a href="#h69-0-13" id="h69-0-13" class="i">+
</a><a href="#h69-0-14" id="h69-0-14" class="i">+class ModConfig {
</a><a href="#h69-0-15" id="h69-0-15" class="i">+    var locale: String = LocaleWrapper.DEFAULT_LOCALE
</a><a href="#h69-0-16" id="h69-0-16" class="i">+
</a><a href="#h69-0-17" id="h69-0-17" class="i">+    private val gson: Gson = GsonBuilder().setPrettyPrinting().create()
</a><a href="#h69-0-18" id="h69-0-18" class="i">+    private val file = FileLoaderWrapper(BridgeFileType.CONFIG, &quot;{}&quot;.toByteArray(Charsets.UTF_8))
</a><a href="#h69-0-19" id="h69-0-19" class="i">+    var wasPresent by Delegates.notNull&lt;Boolean&gt;()
</a><a href="#h69-0-20" id="h69-0-20" class="i">+
</a><a href="#h69-0-21" id="h69-0-21" class="i">+    /* Used to notify the bridge client about config changes */
</a><a href="#h69-0-22" id="h69-0-22" class="i">+    var configStateListener: ConfigStateListener? = null
</a><a href="#h69-0-23" id="h69-0-23" class="i">+    lateinit var root: RootConfig
</a><a href="#h69-0-24" id="h69-0-24" class="i">+        private set
</a><a href="#h69-0-25" id="h69-0-25" class="i">+
</a><a href="#h69-0-26" id="h69-0-26" class="i">+    private fun load() {
</a><a href="#h69-0-27" id="h69-0-27" class="i">+        root = RootConfig()
</a><a href="#h69-0-28" id="h69-0-28" class="i">+        wasPresent = file.isFileExists()
</a><a href="#h69-0-29" id="h69-0-29" class="i">+        if (!file.isFileExists()) {
</a><a href="#h69-0-30" id="h69-0-30" class="i">+            writeConfig()
</a><a href="#h69-0-31" id="h69-0-31" class="i">+            return
</a><a href="#h69-0-32" id="h69-0-32" class="i">+        }
</a><a href="#h69-0-33" id="h69-0-33" class="i">+
</a><a href="#h69-0-34" id="h69-0-34" class="i">+        runCatching {
</a><a href="#h69-0-35" id="h69-0-35" class="i">+            loadConfig()
</a><a href="#h69-0-36" id="h69-0-36" class="i">+        }.onFailure {
</a><a href="#h69-0-37" id="h69-0-37" class="i">+            writeConfig()
</a><a href="#h69-0-38" id="h69-0-38" class="i">+        }
</a><a href="#h69-0-39" id="h69-0-39" class="i">+    }
</a><a href="#h69-0-40" id="h69-0-40" class="i">+
</a><a href="#h69-0-41" id="h69-0-41" class="i">+    private fun loadConfig() {
</a><a href="#h69-0-42" id="h69-0-42" class="i">+        val configFileContent = file.read()
</a><a href="#h69-0-43" id="h69-0-43" class="i">+        val configObject = gson.fromJson(configFileContent.toString(Charsets.UTF_8), JsonObject::class.java)
</a><a href="#h69-0-44" id="h69-0-44" class="i">+        locale = configObject.get(&quot;_locale&quot;)?.asString ?: LocaleWrapper.DEFAULT_LOCALE
</a><a href="#h69-0-45" id="h69-0-45" class="i">+        root.fromJson(configObject)
</a><a href="#h69-0-46" id="h69-0-46" class="i">+    }
</a><a href="#h69-0-47" id="h69-0-47" class="i">+
</a><a href="#h69-0-48" id="h69-0-48" class="i">+    fun exportToString(): String {
</a><a href="#h69-0-49" id="h69-0-49" class="i">+        val configObject = root.toJson()
</a><a href="#h69-0-50" id="h69-0-50" class="i">+        configObject.addProperty(&quot;_locale&quot;, locale)
</a><a href="#h69-0-51" id="h69-0-51" class="i">+        return configObject.toString()
</a><a href="#h69-0-52" id="h69-0-52" class="i">+    }
</a><a href="#h69-0-53" id="h69-0-53" class="i">+
</a><a href="#h69-0-54" id="h69-0-54" class="i">+    fun reset() {
</a><a href="#h69-0-55" id="h69-0-55" class="i">+        root = RootConfig()
</a><a href="#h69-0-56" id="h69-0-56" class="i">+        writeConfig()
</a><a href="#h69-0-57" id="h69-0-57" class="i">+    }
</a><a href="#h69-0-58" id="h69-0-58" class="i">+
</a><a href="#h69-0-59" id="h69-0-59" class="i">+    fun writeConfig() {
</a><a href="#h69-0-60" id="h69-0-60" class="i">+        var shouldRestart = false
</a><a href="#h69-0-61" id="h69-0-61" class="i">+        var shouldCleanCache = false
</a><a href="#h69-0-62" id="h69-0-62" class="i">+        var configChanged = false
</a><a href="#h69-0-63" id="h69-0-63" class="i">+
</a><a href="#h69-0-64" id="h69-0-64" class="i">+        fun compareDiff(originalContainer: ConfigContainer, modifiedContainer: ConfigContainer) {
</a><a href="#h69-0-65" id="h69-0-65" class="i">+            val parentContainerFlags = modifiedContainer.parentContainerKey?.params?.flags ?: emptySet()
</a><a href="#h69-0-66" id="h69-0-66" class="i">+
</a><a href="#h69-0-67" id="h69-0-67" class="i">+            parentContainerFlags.takeIf { originalContainer.hasGlobalState }?.apply {
</a><a href="#h69-0-68" id="h69-0-68" class="i">+                if (modifiedContainer.globalState != originalContainer.globalState) {
</a><a href="#h69-0-69" id="h69-0-69" class="i">+                    configChanged = true
</a><a href="#h69-0-70" id="h69-0-70" class="i">+                    if (contains(ConfigFlag.REQUIRE_RESTART)) shouldRestart = true
</a><a href="#h69-0-71" id="h69-0-71" class="i">+                    if (contains(ConfigFlag.REQUIRE_CLEAN_CACHE)) shouldCleanCache = true
</a><a href="#h69-0-72" id="h69-0-72" class="i">+                }
</a><a href="#h69-0-73" id="h69-0-73" class="i">+            }
</a><a href="#h69-0-74" id="h69-0-74" class="i">+
</a><a href="#h69-0-75" id="h69-0-75" class="i">+            for (property in modifiedContainer.properties) {
</a><a href="#h69-0-76" id="h69-0-76" class="i">+                val modifiedValue = property.value.getNullable()
</a><a href="#h69-0-77" id="h69-0-77" class="i">+                val originalValue = originalContainer.properties.entries.firstOrNull {
</a><a href="#h69-0-78" id="h69-0-78" class="i">+                    it.key.name == property.key.name
</a><a href="#h69-0-79" id="h69-0-79" class="i">+                }?.value?.getNullable()
</a><a href="#h69-0-80" id="h69-0-80" class="i">+
</a><a href="#h69-0-81" id="h69-0-81" class="i">+                if (originalValue is ConfigContainer &amp;&amp; modifiedValue is ConfigContainer) {
</a><a href="#h69-0-82" id="h69-0-82" class="i">+                    compareDiff(originalValue, modifiedValue)
</a><a href="#h69-0-83" id="h69-0-83" class="i">+                    continue
</a><a href="#h69-0-84" id="h69-0-84" class="i">+                }
</a><a href="#h69-0-85" id="h69-0-85" class="i">+
</a><a href="#h69-0-86" id="h69-0-86" class="i">+                if (modifiedValue != originalValue) {
</a><a href="#h69-0-87" id="h69-0-87" class="i">+                    val flags = property.key.params.flags + parentContainerFlags
</a><a href="#h69-0-88" id="h69-0-88" class="i">+                    configChanged = true
</a><a href="#h69-0-89" id="h69-0-89" class="i">+                    if (flags.contains(ConfigFlag.REQUIRE_RESTART)) shouldRestart = true
</a><a href="#h69-0-90" id="h69-0-90" class="i">+                    if (flags.contains(ConfigFlag.REQUIRE_CLEAN_CACHE)) shouldCleanCache = true
</a><a href="#h69-0-91" id="h69-0-91" class="i">+                }
</a><a href="#h69-0-92" id="h69-0-92" class="i">+            }
</a><a href="#h69-0-93" id="h69-0-93" class="i">+        }
</a><a href="#h69-0-94" id="h69-0-94" class="i">+
</a><a href="#h69-0-95" id="h69-0-95" class="i">+        configStateListener?.also {
</a><a href="#h69-0-96" id="h69-0-96" class="i">+            runCatching {
</a><a href="#h69-0-97" id="h69-0-97" class="i">+                compareDiff(RootConfig().apply {
</a><a href="#h69-0-98" id="h69-0-98" class="i">+                    fromJson(gson.fromJson(file.read().toString(Charsets.UTF_8), JsonObject::class.java))
</a><a href="#h69-0-99" id="h69-0-99" class="i">+                }, root)
</a><a href="#h69-0-100" id="h69-0-100" class="i">+
</a><a href="#h69-0-101" id="h69-0-101" class="i">+                if (configChanged) {
</a><a href="#h69-0-102" id="h69-0-102" class="i">+                    it.onConfigChanged()
</a><a href="#h69-0-103" id="h69-0-103" class="i">+                    if (shouldCleanCache) it.onCleanCacheRequired()
</a><a href="#h69-0-104" id="h69-0-104" class="i">+                    else if (shouldRestart) it.onRestartRequired()
</a><a href="#h69-0-105" id="h69-0-105" class="i">+                }
</a><a href="#h69-0-106" id="h69-0-106" class="i">+            }.onFailure {
</a><a href="#h69-0-107" id="h69-0-107" class="i">+                AbstractLogger.directError(&quot;Error while calling config state listener&quot;, it, &quot;ConfigStateListener&quot;)
</a><a href="#h69-0-108" id="h69-0-108" class="i">+            }
</a><a href="#h69-0-109" id="h69-0-109" class="i">+        }
</a><a href="#h69-0-110" id="h69-0-110" class="i">+
</a><a href="#h69-0-111" id="h69-0-111" class="i">+        file.write(exportToString().toByteArray(Charsets.UTF_8))
</a><a href="#h69-0-112" id="h69-0-112" class="i">+    }
</a><a href="#h69-0-113" id="h69-0-113" class="i">+
</a><a href="#h69-0-114" id="h69-0-114" class="i">+    fun loadFromString(string: String) {
</a><a href="#h69-0-115" id="h69-0-115" class="i">+        val configObject = gson.fromJson(string, JsonObject::class.java)
</a><a href="#h69-0-116" id="h69-0-116" class="i">+        locale = configObject.get(&quot;_locale&quot;)?.asString ?: LocaleWrapper.DEFAULT_LOCALE
</a><a href="#h69-0-117" id="h69-0-117" class="i">+        root.fromJson(configObject)
</a><a href="#h69-0-118" id="h69-0-118" class="i">+        writeConfig()
</a><a href="#h69-0-119" id="h69-0-119" class="i">+    }
</a><a href="#h69-0-120" id="h69-0-120" class="i">+
</a><a href="#h69-0-121" id="h69-0-121" class="i">+    fun loadFromContext(context: Context) {
</a><a href="#h69-0-122" id="h69-0-122" class="i">+        file.loadFromContext(context)
</a><a href="#h69-0-123" id="h69-0-123" class="i">+        load()
</a><a href="#h69-0-124" id="h69-0-124" class="i">+    }
</a><a href="#h69-0-125" id="h69-0-125" class="i">+
</a><a href="#h69-0-126" id="h69-0-126" class="i">+    fun loadFromCallback(callback: (FileLoaderWrapper) -&gt; Unit) {
</a><a href="#h69-0-127" id="h69-0-127" class="i">+        callback(file)
</a><a href="#h69-0-128" id="h69-0-128" class="i">+        load()
</a><a href="#h69-0-129" id="h69-0-129" class="i">+    }
</a><a href="#h69-0-130" id="h69-0-130" class="i">+}</a><a href="#h69-0-131" id="h69-0-131" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h70" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/config/impl/Camera.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/config/impl/Camera.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/config/impl/Camera.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/config/impl/Camera.kt</a></b>
<a href="#h70-0" id="h70-0" class="h">@@ -0,0 +1,22 @@
</a><a href="#h70-0-0" id="h70-0-0" class="i">+package me.rhunk.snapenhance.common.config.impl
</a><a href="#h70-0-1" id="h70-0-1" class="i">+
</a><a href="#h70-0-2" id="h70-0-2" class="i">+import me.rhunk.snapenhance.common.config.ConfigContainer
</a><a href="#h70-0-3" id="h70-0-3" class="i">+import me.rhunk.snapenhance.common.config.ConfigFlag
</a><a href="#h70-0-4" id="h70-0-4" class="i">+import me.rhunk.snapenhance.common.config.FeatureNotice
</a><a href="#h70-0-5" id="h70-0-5" class="i">+
</a><a href="#h70-0-6" id="h70-0-6" class="i">+class Camera : ConfigContainer() {
</a><a href="#h70-0-7" id="h70-0-7" class="i">+    companion object {
</a><a href="#h70-0-8" id="h70-0-8" class="i">+        val resolutions = listOf(&quot;3264x2448&quot;, &quot;3264x1840&quot;, &quot;3264x1504&quot;, &quot;2688x1512&quot;, &quot;2560x1920&quot;, &quot;2448x2448&quot;, &quot;2340x1080&quot;, &quot;2160x1080&quot;, &quot;1920x1440&quot;, &quot;1920x1080&quot;, &quot;1600x1200&quot;, &quot;1600x960&quot;, &quot;1600x900&quot;, &quot;1600x736&quot;, &quot;1600x720&quot;, &quot;1560x720&quot;, &quot;1520x720&quot;, &quot;1440x1080&quot;, &quot;1440x720&quot;, &quot;1280x720&quot;, &quot;1080x1080&quot;, &quot;1080x720&quot;, &quot;960x720&quot;, &quot;720x720&quot;, &quot;720x480&quot;, &quot;640x480&quot;, &quot;352x288&quot;, &quot;320x240&quot;, &quot;176x144&quot;).toTypedArray()
</a><a href="#h70-0-9" id="h70-0-9" class="i">+    }
</a><a href="#h70-0-10" id="h70-0-10" class="i">+
</a><a href="#h70-0-11" id="h70-0-11" class="i">+    val disable = boolean(&quot;disable_camera&quot;)
</a><a href="#h70-0-12" id="h70-0-12" class="i">+    val immersiveCameraPreview = boolean(&quot;immersive_camera_preview&quot;) { addNotices(FeatureNotice.UNSTABLE) }
</a><a href="#h70-0-13" id="h70-0-13" class="i">+    val overridePreviewResolution = unique(&quot;override_preview_resolution&quot;, *resolutions)
</a><a href="#h70-0-14" id="h70-0-14" class="i">+        { addFlags(ConfigFlag.NO_TRANSLATE) }
</a><a href="#h70-0-15" id="h70-0-15" class="i">+    val overridePictureResolution = unique(&quot;override_picture_resolution&quot;, *resolutions)
</a><a href="#h70-0-16" id="h70-0-16" class="i">+        { addFlags(ConfigFlag.NO_TRANSLATE) }
</a><a href="#h70-0-17" id="h70-0-17" class="i">+    val customFrameRate = unique(&quot;custom_frame_rate&quot;,
</a><a href="#h70-0-18" id="h70-0-18" class="i">+        &quot;5&quot;, &quot;10&quot;, &quot;20&quot;, &quot;25&quot;, &quot;30&quot;, &quot;48&quot;, &quot;60&quot;, &quot;90&quot;, &quot;120&quot;
</a><a href="#h70-0-19" id="h70-0-19" class="i">+    ) { addNotices(FeatureNotice.UNSTABLE); addFlags(ConfigFlag.NO_TRANSLATE) }
</a><a href="#h70-0-20" id="h70-0-20" class="i">+    val forceCameraSourceEncoding = boolean(&quot;force_camera_source_encoding&quot;)
</a><a href="#h70-0-21" id="h70-0-21" class="i">+}
</a><b>diff --git a/<a id="h71" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/config/impl/DownloaderConfig.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/config/impl/DownloaderConfig.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/config/impl/DownloaderConfig.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/config/impl/DownloaderConfig.kt</a></b>
<a href="#h71-0" id="h71-0" class="h">@@ -0,0 +1,50 @@
</a><a href="#h71-0-0" id="h71-0-0" class="i">+package me.rhunk.snapenhance.common.config.impl
</a><a href="#h71-0-1" id="h71-0-1" class="i">+
</a><a href="#h71-0-2" id="h71-0-2" class="i">+import me.rhunk.snapenhance.common.config.ConfigContainer
</a><a href="#h71-0-3" id="h71-0-3" class="i">+import me.rhunk.snapenhance.common.config.ConfigFlag
</a><a href="#h71-0-4" id="h71-0-4" class="i">+import me.rhunk.snapenhance.common.config.FeatureNotice
</a><a href="#h71-0-5" id="h71-0-5" class="i">+
</a><a href="#h71-0-6" id="h71-0-6" class="i">+class DownloaderConfig : ConfigContainer() {
</a><a href="#h71-0-7" id="h71-0-7" class="i">+    inner class FFMpegOptions : ConfigContainer() {
</a><a href="#h71-0-8" id="h71-0-8" class="i">+        val threads = integer(&quot;threads&quot;, 1)
</a><a href="#h71-0-9" id="h71-0-9" class="i">+        val preset = unique(&quot;preset&quot;, &quot;ultrafast&quot;, &quot;superfast&quot;, &quot;veryfast&quot;, &quot;faster&quot;, &quot;fast&quot;, &quot;medium&quot;, &quot;slow&quot;, &quot;slower&quot;, &quot;veryslow&quot;) {
</a><a href="#h71-0-10" id="h71-0-10" class="i">+            addFlags(ConfigFlag.NO_TRANSLATE)
</a><a href="#h71-0-11" id="h71-0-11" class="i">+        }
</a><a href="#h71-0-12" id="h71-0-12" class="i">+        val constantRateFactor = integer(&quot;constant_rate_factor&quot;, 30)
</a><a href="#h71-0-13" id="h71-0-13" class="i">+        val videoBitrate = integer(&quot;video_bitrate&quot;, 5000)
</a><a href="#h71-0-14" id="h71-0-14" class="i">+        val audioBitrate = integer(&quot;audio_bitrate&quot;, 128)
</a><a href="#h71-0-15" id="h71-0-15" class="i">+        val customVideoCodec = string(&quot;custom_video_codec&quot;) { addFlags(ConfigFlag.NO_TRANSLATE) }
</a><a href="#h71-0-16" id="h71-0-16" class="i">+        val customAudioCodec = string(&quot;custom_audio_codec&quot;) { addFlags(ConfigFlag.NO_TRANSLATE) }
</a><a href="#h71-0-17" id="h71-0-17" class="i">+    }
</a><a href="#h71-0-18" id="h71-0-18" class="i">+
</a><a href="#h71-0-19" id="h71-0-19" class="i">+    val saveFolder = string(&quot;save_folder&quot;) { addFlags(ConfigFlag.FOLDER); requireRestart() }
</a><a href="#h71-0-20" id="h71-0-20" class="i">+    val autoDownloadSources = multiple(&quot;auto_download_sources&quot;,
</a><a href="#h71-0-21" id="h71-0-21" class="i">+        &quot;friend_snaps&quot;,
</a><a href="#h71-0-22" id="h71-0-22" class="i">+        &quot;friend_stories&quot;,
</a><a href="#h71-0-23" id="h71-0-23" class="i">+        &quot;public_stories&quot;,
</a><a href="#h71-0-24" id="h71-0-24" class="i">+        &quot;spotlight&quot;
</a><a href="#h71-0-25" id="h71-0-25" class="i">+    )
</a><a href="#h71-0-26" id="h71-0-26" class="i">+    val preventSelfAutoDownload = boolean(&quot;prevent_self_auto_download&quot;)
</a><a href="#h71-0-27" id="h71-0-27" class="i">+    val pathFormat = multiple(&quot;path_format&quot;,
</a><a href="#h71-0-28" id="h71-0-28" class="i">+        &quot;create_author_folder&quot;,
</a><a href="#h71-0-29" id="h71-0-29" class="i">+        &quot;create_source_folder&quot;,
</a><a href="#h71-0-30" id="h71-0-30" class="i">+        &quot;append_hash&quot;,
</a><a href="#h71-0-31" id="h71-0-31" class="i">+        &quot;append_source&quot;,
</a><a href="#h71-0-32" id="h71-0-32" class="i">+        &quot;append_username&quot;,
</a><a href="#h71-0-33" id="h71-0-33" class="i">+        &quot;append_date_time&quot;,
</a><a href="#h71-0-34" id="h71-0-34" class="i">+    ).apply { set(mutableListOf(&quot;append_hash&quot;, &quot;append_date_time&quot;, &quot;append_type&quot;, &quot;append_username&quot;)) }
</a><a href="#h71-0-35" id="h71-0-35" class="i">+    val allowDuplicate = boolean(&quot;allow_duplicate&quot;)
</a><a href="#h71-0-36" id="h71-0-36" class="i">+    val mergeOverlays = boolean(&quot;merge_overlays&quot;) { addNotices(FeatureNotice.UNSTABLE) }
</a><a href="#h71-0-37" id="h71-0-37" class="i">+    val forceImageFormat = unique(&quot;force_image_format&quot;, &quot;jpg&quot;, &quot;png&quot;, &quot;webp&quot;) {
</a><a href="#h71-0-38" id="h71-0-38" class="i">+        addFlags(ConfigFlag.NO_TRANSLATE)
</a><a href="#h71-0-39" id="h71-0-39" class="i">+    }
</a><a href="#h71-0-40" id="h71-0-40" class="i">+    val forceVoiceNoteFormat = unique(&quot;force_voice_note_format&quot;, &quot;aac&quot;, &quot;mp3&quot;, &quot;opus&quot;) {
</a><a href="#h71-0-41" id="h71-0-41" class="i">+        addFlags(ConfigFlag.NO_TRANSLATE)
</a><a href="#h71-0-42" id="h71-0-42" class="i">+    }
</a><a href="#h71-0-43" id="h71-0-43" class="i">+    val downloadProfilePictures = boolean(&quot;download_profile_pictures&quot;) { requireRestart() }
</a><a href="#h71-0-44" id="h71-0-44" class="i">+    val chatDownloadContextMenu = boolean(&quot;chat_download_context_menu&quot;)
</a><a href="#h71-0-45" id="h71-0-45" class="i">+    val ffmpegOptions = container(&quot;ffmpeg_options&quot;, FFMpegOptions()) { addNotices(FeatureNotice.UNSTABLE) }
</a><a href="#h71-0-46" id="h71-0-46" class="i">+    val logging = multiple(&quot;logging&quot;, &quot;started&quot;, &quot;success&quot;, &quot;progress&quot;, &quot;failure&quot;).apply {
</a><a href="#h71-0-47" id="h71-0-47" class="i">+        set(mutableListOf(&quot;started&quot;, &quot;success&quot;))
</a><a href="#h71-0-48" id="h71-0-48" class="i">+    }
</a><a href="#h71-0-49" id="h71-0-49" class="i">+}</a><a href="#h71-0-50" id="h71-0-50" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h72" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/config/impl/E2EEConfig.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/config/impl/E2EEConfig.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/config/impl/E2EEConfig.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/config/impl/E2EEConfig.kt</a></b>
<a href="#h72-0" id="h72-0" class="h">@@ -0,0 +1,8 @@
</a><a href="#h72-0-0" id="h72-0-0" class="i">+package me.rhunk.snapenhance.common.config.impl
</a><a href="#h72-0-1" id="h72-0-1" class="i">+
</a><a href="#h72-0-2" id="h72-0-2" class="i">+import me.rhunk.snapenhance.common.config.ConfigContainer
</a><a href="#h72-0-3" id="h72-0-3" class="i">+
</a><a href="#h72-0-4" id="h72-0-4" class="i">+class E2EEConfig : ConfigContainer(hasGlobalState = true) {
</a><a href="#h72-0-5" id="h72-0-5" class="i">+    val encryptedMessageIndicator = boolean(&quot;encrypted_message_indicator&quot;)
</a><a href="#h72-0-6" id="h72-0-6" class="i">+    val forceMessageEncryption = boolean(&quot;force_message_encryption&quot;)
</a><a href="#h72-0-7" id="h72-0-7" class="i">+}</a><a href="#h72-0-8" id="h72-0-8" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h73" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/config/impl/Experimental.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/config/impl/Experimental.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/config/impl/Experimental.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/config/impl/Experimental.kt</a></b>
<a href="#h73-0" id="h73-0" class="h">@@ -0,0 +1,27 @@
</a><a href="#h73-0-0" id="h73-0-0" class="i">+package me.rhunk.snapenhance.common.config.impl
</a><a href="#h73-0-1" id="h73-0-1" class="i">+
</a><a href="#h73-0-2" id="h73-0-2" class="i">+import me.rhunk.snapenhance.common.config.ConfigContainer
</a><a href="#h73-0-3" id="h73-0-3" class="i">+import me.rhunk.snapenhance.common.config.FeatureNotice
</a><a href="#h73-0-4" id="h73-0-4" class="i">+
</a><a href="#h73-0-5" id="h73-0-5" class="i">+class Experimental : ConfigContainer() {
</a><a href="#h73-0-6" id="h73-0-6" class="i">+    val nativeHooks = container(&quot;native_hooks&quot;, NativeHooks()) { icon = &quot;Memory&quot;; requireRestart() }
</a><a href="#h73-0-7" id="h73-0-7" class="i">+    val spoof = container(&quot;spoof&quot;, Spoof()) { icon = &quot;Fingerprint&quot; }
</a><a href="#h73-0-8" id="h73-0-8" class="i">+    val appPasscode = string(&quot;app_passcode&quot;)
</a><a href="#h73-0-9" id="h73-0-9" class="i">+    val appLockOnResume = boolean(&quot;app_lock_on_resume&quot;)
</a><a href="#h73-0-10" id="h73-0-10" class="i">+    val infiniteStoryBoost = boolean(&quot;infinite_story_boost&quot;)
</a><a href="#h73-0-11" id="h73-0-11" class="i">+    val meoPasscodeBypass = boolean(&quot;meo_passcode_bypass&quot;)
</a><a href="#h73-0-12" id="h73-0-12" class="i">+    val unlimitedMultiSnap = boolean(&quot;unlimited_multi_snap&quot;) { addNotices(FeatureNotice.BAN_RISK)}
</a><a href="#h73-0-13" id="h73-0-13" class="i">+    val noFriendScoreDelay = boolean(&quot;no_friend_score_delay&quot;) { requireRestart()}
</a><a href="#h73-0-14" id="h73-0-14" class="i">+    val e2eEncryption = container(&quot;e2ee&quot;, E2EEConfig()) { requireRestart()}
</a><a href="#h73-0-15" id="h73-0-15" class="i">+    val hiddenSnapchatPlusFeatures = boolean(&quot;hidden_snapchat_plus_features&quot;) {
</a><a href="#h73-0-16" id="h73-0-16" class="i">+        addNotices(FeatureNotice.BAN_RISK, FeatureNotice.UNSTABLE)
</a><a href="#h73-0-17" id="h73-0-17" class="i">+        requireRestart()
</a><a href="#h73-0-18" id="h73-0-18" class="i">+    }
</a><a href="#h73-0-19" id="h73-0-19" class="i">+    val addFriendSourceSpoof = unique(&quot;add_friend_source_spoof&quot;,
</a><a href="#h73-0-20" id="h73-0-20" class="i">+        &quot;added_by_username&quot;,
</a><a href="#h73-0-21" id="h73-0-21" class="i">+        &quot;added_by_mention&quot;,
</a><a href="#h73-0-22" id="h73-0-22" class="i">+        &quot;added_by_group_chat&quot;,
</a><a href="#h73-0-23" id="h73-0-23" class="i">+        &quot;added_by_qr_code&quot;,
</a><a href="#h73-0-24" id="h73-0-24" class="i">+        &quot;added_by_community&quot;,
</a><a href="#h73-0-25" id="h73-0-25" class="i">+    ) { addNotices(FeatureNotice.BAN_RISK) }
</a><a href="#h73-0-26" id="h73-0-26" class="i">+}</a><a href="#h73-0-27" id="h73-0-27" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h74" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/config/impl/Global.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/config/impl/Global.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/config/impl/Global.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/config/impl/Global.kt</a></b>
<a href="#h74-0" id="h74-0" class="h">@@ -0,0 +1,15 @@
</a><a href="#h74-0-0" id="h74-0-0" class="i">+package me.rhunk.snapenhance.common.config.impl
</a><a href="#h74-0-1" id="h74-0-1" class="i">+
</a><a href="#h74-0-2" id="h74-0-2" class="i">+import me.rhunk.snapenhance.common.config.ConfigContainer
</a><a href="#h74-0-3" id="h74-0-3" class="i">+import me.rhunk.snapenhance.common.config.FeatureNotice
</a><a href="#h74-0-4" id="h74-0-4" class="i">+
</a><a href="#h74-0-5" id="h74-0-5" class="i">+class Global : ConfigContainer() {
</a><a href="#h74-0-6" id="h74-0-6" class="i">+    val snapchatPlus = boolean(&quot;snapchat_plus&quot;) { addNotices(FeatureNotice.BAN_RISK); requireRestart() }
</a><a href="#h74-0-7" id="h74-0-7" class="i">+    val disableMetrics = boolean(&quot;disable_metrics&quot;)
</a><a href="#h74-0-8" id="h74-0-8" class="i">+    val blockAds = boolean(&quot;block_ads&quot;)
</a><a href="#h74-0-9" id="h74-0-9" class="i">+    val bypassVideoLengthRestriction = unique(&quot;bypass_video_length_restriction&quot;, &quot;split&quot;, &quot;single&quot;) { addNotices(
</a><a href="#h74-0-10" id="h74-0-10" class="i">+        FeatureNotice.BAN_RISK); requireRestart() }
</a><a href="#h74-0-11" id="h74-0-11" class="i">+    val disableGooglePlayDialogs = boolean(&quot;disable_google_play_dialogs&quot;) { requireRestart() }
</a><a href="#h74-0-12" id="h74-0-12" class="i">+    val forceMediaSourceQuality = boolean(&quot;force_media_source_quality&quot;)
</a><a href="#h74-0-13" id="h74-0-13" class="i">+    val disableSnapSplitting = boolean(&quot;disable_snap_splitting&quot;) { addNotices(FeatureNotice.INTERNAL_BEHAVIOR) }
</a><a href="#h74-0-14" id="h74-0-14" class="i">+}</a><a href="#h74-0-15" id="h74-0-15" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h75" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/config/impl/MessagingTweaks.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/config/impl/MessagingTweaks.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/config/impl/MessagingTweaks.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/config/impl/MessagingTweaks.kt</a></b>
<a href="#h75-0" id="h75-0" class="h">@@ -0,0 +1,31 @@
</a><a href="#h75-0-0" id="h75-0-0" class="i">+package me.rhunk.snapenhance.common.config.impl
</a><a href="#h75-0-1" id="h75-0-1" class="i">+
</a><a href="#h75-0-2" id="h75-0-2" class="i">+import me.rhunk.snapenhance.common.config.ConfigContainer
</a><a href="#h75-0-3" id="h75-0-3" class="i">+import me.rhunk.snapenhance.common.config.FeatureNotice
</a><a href="#h75-0-4" id="h75-0-4" class="i">+import me.rhunk.snapenhance.common.data.NotificationType
</a><a href="#h75-0-5" id="h75-0-5" class="i">+
</a><a href="#h75-0-6" id="h75-0-6" class="i">+class MessagingTweaks : ConfigContainer() {
</a><a href="#h75-0-7" id="h75-0-7" class="i">+    val anonymousStoryViewing = boolean(&quot;anonymous_story_viewing&quot;)
</a><a href="#h75-0-8" id="h75-0-8" class="i">+    val hideBitmojiPresence = boolean(&quot;hide_bitmoji_presence&quot;)
</a><a href="#h75-0-9" id="h75-0-9" class="i">+    val hideTypingNotifications = boolean(&quot;hide_typing_notifications&quot;)
</a><a href="#h75-0-10" id="h75-0-10" class="i">+    val unlimitedSnapViewTime = boolean(&quot;unlimited_snap_view_time&quot;)
</a><a href="#h75-0-11" id="h75-0-11" class="i">+    val disableReplayInFF = boolean(&quot;disable_replay_in_ff&quot;)
</a><a href="#h75-0-12" id="h75-0-12" class="i">+    val autoSaveMessagesInConversations = multiple(&quot;auto_save_messages_in_conversations&quot;,
</a><a href="#h75-0-13" id="h75-0-13" class="i">+        &quot;CHAT&quot;,
</a><a href="#h75-0-14" id="h75-0-14" class="i">+        &quot;SNAP&quot;,
</a><a href="#h75-0-15" id="h75-0-15" class="i">+        &quot;NOTE&quot;,
</a><a href="#h75-0-16" id="h75-0-16" class="i">+        &quot;EXTERNAL_MEDIA&quot;,
</a><a href="#h75-0-17" id="h75-0-17" class="i">+        &quot;STICKER&quot;
</a><a href="#h75-0-18" id="h75-0-18" class="i">+    ) { requireRestart() }
</a><a href="#h75-0-19" id="h75-0-19" class="i">+    val snapToChatMedia = boolean(&quot;snap_to_chat_media&quot;) { requireRestart() }
</a><a href="#h75-0-20" id="h75-0-20" class="i">+    val preventMessageSending = multiple(&quot;prevent_message_sending&quot;, *NotificationType.getOutgoingValues().map { it.key }.toTypedArray()) {
</a><a href="#h75-0-21" id="h75-0-21" class="i">+        customOptionTranslationPath = &quot;features.options.notifications&quot;
</a><a href="#h75-0-22" id="h75-0-22" class="i">+    }
</a><a href="#h75-0-23" id="h75-0-23" class="i">+    val betterNotifications = multiple(&quot;better_notifications&quot;, &quot;snap&quot;, &quot;chat&quot;, &quot;reply_button&quot;, &quot;download_button&quot;, &quot;group&quot;) { requireRestart() }
</a><a href="#h75-0-24" id="h75-0-24" class="i">+    val notificationBlacklist = multiple(&quot;notification_blacklist&quot;, *NotificationType.getIncomingValues().map { it.key }.toTypedArray()) {
</a><a href="#h75-0-25" id="h75-0-25" class="i">+        customOptionTranslationPath = &quot;features.options.notifications&quot;
</a><a href="#h75-0-26" id="h75-0-26" class="i">+    }
</a><a href="#h75-0-27" id="h75-0-27" class="i">+    val messageLogger = boolean(&quot;message_logger&quot;) { addNotices(FeatureNotice.UNSTABLE); requireRestart() }
</a><a href="#h75-0-28" id="h75-0-28" class="i">+    val galleryMediaSendOverride = boolean(&quot;gallery_media_send_override&quot;)
</a><a href="#h75-0-29" id="h75-0-29" class="i">+    val messagePreviewLength = integer(&quot;message_preview_length&quot;, defaultValue = 20)
</a><a href="#h75-0-30" id="h75-0-30" class="i">+}</a><a href="#h75-0-31" id="h75-0-31" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h76" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/config/impl/NativeHooks.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/config/impl/NativeHooks.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/config/impl/NativeHooks.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/config/impl/NativeHooks.kt</a></b>
<a href="#h76-0" id="h76-0" class="h">@@ -0,0 +1,8 @@
</a><a href="#h76-0-0" id="h76-0-0" class="i">+package me.rhunk.snapenhance.common.config.impl
</a><a href="#h76-0-1" id="h76-0-1" class="i">+
</a><a href="#h76-0-2" id="h76-0-2" class="i">+import me.rhunk.snapenhance.common.config.ConfigContainer
</a><a href="#h76-0-3" id="h76-0-3" class="i">+
</a><a href="#h76-0-4" id="h76-0-4" class="i">+class NativeHooks: ConfigContainer(hasGlobalState = true) {
</a><a href="#h76-0-5" id="h76-0-5" class="i">+    val disableBitmoji = boolean(&quot;disable_bitmoji&quot;)
</a><a href="#h76-0-6" id="h76-0-6" class="i">+    val fixGalleryMediaOverride = boolean(&quot;fix_gallery_media_override&quot;)
</a><a href="#h76-0-7" id="h76-0-7" class="i">+}</a><a href="#h76-0-8" id="h76-0-8" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h77" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/config/impl/RootConfig.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/config/impl/RootConfig.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/config/impl/RootConfig.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/config/impl/RootConfig.kt</a></b>
<a href="#h77-0" id="h77-0" class="h">@@ -0,0 +1,18 @@
</a><a href="#h77-0-0" id="h77-0-0" class="i">+package me.rhunk.snapenhance.common.config.impl
</a><a href="#h77-0-1" id="h77-0-1" class="i">+
</a><a href="#h77-0-2" id="h77-0-2" class="i">+import me.rhunk.snapenhance.common.config.ConfigContainer
</a><a href="#h77-0-3" id="h77-0-3" class="i">+import me.rhunk.snapenhance.common.config.FeatureNotice
</a><a href="#h77-0-4" id="h77-0-4" class="i">+
</a><a href="#h77-0-5" id="h77-0-5" class="i">+class RootConfig : ConfigContainer() {
</a><a href="#h77-0-6" id="h77-0-6" class="i">+    val downloader = container(&quot;downloader&quot;, DownloaderConfig()) { icon = &quot;Download&quot;}
</a><a href="#h77-0-7" id="h77-0-7" class="i">+    val userInterface = container(&quot;user_interface&quot;, UserInterfaceTweaks()) { icon = &quot;RemoveRedEye&quot;}
</a><a href="#h77-0-8" id="h77-0-8" class="i">+    val messaging = container(&quot;messaging&quot;, MessagingTweaks()) { icon = &quot;Send&quot; }
</a><a href="#h77-0-9" id="h77-0-9" class="i">+    val global = container(&quot;global&quot;, Global()) { icon = &quot;MiscellaneousServices&quot; }
</a><a href="#h77-0-10" id="h77-0-10" class="i">+    val rules = container(&quot;rules&quot;, Rules()) { icon = &quot;Rule&quot; }
</a><a href="#h77-0-11" id="h77-0-11" class="i">+    val camera = container(&quot;camera&quot;, Camera()) { icon = &quot;Camera&quot;; requireRestart() }
</a><a href="#h77-0-12" id="h77-0-12" class="i">+    val streaksReminder = container(&quot;streaks_reminder&quot;, StreaksReminderConfig()) { icon = &quot;Alarm&quot; }
</a><a href="#h77-0-13" id="h77-0-13" class="i">+    val experimental = container(&quot;experimental&quot;, Experimental()) {
</a><a href="#h77-0-14" id="h77-0-14" class="i">+        icon = &quot;Science&quot;; addNotices(FeatureNotice.UNSTABLE)
</a><a href="#h77-0-15" id="h77-0-15" class="i">+    }
</a><a href="#h77-0-16" id="h77-0-16" class="i">+    val scripting = container(&quot;scripting&quot;, Scripting()) { icon = &quot;DataObject&quot; }
</a><a href="#h77-0-17" id="h77-0-17" class="i">+}</a><a href="#h77-0-18" id="h77-0-18" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h78" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/config/impl/Rules.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/config/impl/Rules.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/config/impl/Rules.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/config/impl/Rules.kt</a></b>
<a href="#h78-0" id="h78-0" class="h">@@ -0,0 +1,26 @@
</a><a href="#h78-0-0" id="h78-0-0" class="i">+package me.rhunk.snapenhance.common.config.impl
</a><a href="#h78-0-1" id="h78-0-1" class="i">+
</a><a href="#h78-0-2" id="h78-0-2" class="i">+import me.rhunk.snapenhance.common.config.ConfigContainer
</a><a href="#h78-0-3" id="h78-0-3" class="i">+import me.rhunk.snapenhance.common.config.PropertyValue
</a><a href="#h78-0-4" id="h78-0-4" class="i">+import me.rhunk.snapenhance.common.data.MessagingRuleType
</a><a href="#h78-0-5" id="h78-0-5" class="i">+import me.rhunk.snapenhance.common.data.RuleState
</a><a href="#h78-0-6" id="h78-0-6" class="i">+
</a><a href="#h78-0-7" id="h78-0-7" class="i">+
</a><a href="#h78-0-8" id="h78-0-8" class="i">+class Rules : ConfigContainer() {
</a><a href="#h78-0-9" id="h78-0-9" class="i">+    private val rules = mutableMapOf&lt;MessagingRuleType, PropertyValue&lt;String&gt;&gt;()
</a><a href="#h78-0-10" id="h78-0-10" class="i">+
</a><a href="#h78-0-11" id="h78-0-11" class="i">+    fun getRuleState(ruleType: MessagingRuleType): RuleState? {
</a><a href="#h78-0-12" id="h78-0-12" class="i">+        return rules[ruleType]?.getNullable()?.let { RuleState.getByName(it) }
</a><a href="#h78-0-13" id="h78-0-13" class="i">+    }
</a><a href="#h78-0-14" id="h78-0-14" class="i">+
</a><a href="#h78-0-15" id="h78-0-15" class="i">+    init {
</a><a href="#h78-0-16" id="h78-0-16" class="i">+        MessagingRuleType.entries.filter { it.listMode }.forEach { ruleType -&gt;
</a><a href="#h78-0-17" id="h78-0-17" class="i">+            rules[ruleType] = unique(ruleType.key,&quot;whitelist&quot;, &quot;blacklist&quot;) {
</a><a href="#h78-0-18" id="h78-0-18" class="i">+                customTranslationPath = &quot;rules.properties.${ruleType.key}&quot;
</a><a href="#h78-0-19" id="h78-0-19" class="i">+                customOptionTranslationPath = &quot;rules.modes&quot;
</a><a href="#h78-0-20" id="h78-0-20" class="i">+            }.apply {
</a><a href="#h78-0-21" id="h78-0-21" class="i">+                set(&quot;whitelist&quot;)
</a><a href="#h78-0-22" id="h78-0-22" class="i">+            }
</a><a href="#h78-0-23" id="h78-0-23" class="i">+        }
</a><a href="#h78-0-24" id="h78-0-24" class="i">+    }
</a><a href="#h78-0-25" id="h78-0-25" class="i">+}</a><a href="#h78-0-26" id="h78-0-26" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h79" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/config/impl/Scripting.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/config/impl/Scripting.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/config/impl/Scripting.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/config/impl/Scripting.kt</a></b>
<a href="#h79-0" id="h79-0" class="h">@@ -0,0 +1,10 @@
</a><a href="#h79-0-0" id="h79-0-0" class="i">+package me.rhunk.snapenhance.common.config.impl
</a><a href="#h79-0-1" id="h79-0-1" class="i">+
</a><a href="#h79-0-2" id="h79-0-2" class="i">+import me.rhunk.snapenhance.common.config.ConfigContainer
</a><a href="#h79-0-3" id="h79-0-3" class="i">+import me.rhunk.snapenhance.common.config.ConfigFlag
</a><a href="#h79-0-4" id="h79-0-4" class="i">+
</a><a href="#h79-0-5" id="h79-0-5" class="i">+class Scripting : ConfigContainer() {
</a><a href="#h79-0-6" id="h79-0-6" class="i">+    val developerMode = boolean(&quot;developer_mode&quot;, false) { requireRestart() }
</a><a href="#h79-0-7" id="h79-0-7" class="i">+    val moduleFolder = string(&quot;module_folder&quot;, &quot;modules&quot;) { addFlags(ConfigFlag.FOLDER); requireRestart()  }
</a><a href="#h79-0-8" id="h79-0-8" class="i">+    val hotReload = boolean(&quot;hot_reload&quot;, false)
</a><a href="#h79-0-9" id="h79-0-9" class="i">+}</a><a href="#h79-0-10" id="h79-0-10" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h80" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/config/impl/Spoof.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/config/impl/Spoof.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/config/impl/Spoof.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/config/impl/Spoof.kt</a></b>
<a href="#h80-0" id="h80-0" class="h">@@ -0,0 +1,24 @@
</a><a href="#h80-0-0" id="h80-0-0" class="i">+package me.rhunk.snapenhance.common.config.impl
</a><a href="#h80-0-1" id="h80-0-1" class="i">+
</a><a href="#h80-0-2" id="h80-0-2" class="i">+import me.rhunk.snapenhance.common.config.ConfigContainer
</a><a href="#h80-0-3" id="h80-0-3" class="i">+import me.rhunk.snapenhance.common.config.FeatureNotice
</a><a href="#h80-0-4" id="h80-0-4" class="i">+
</a><a href="#h80-0-5" id="h80-0-5" class="i">+class Spoof : ConfigContainer() {
</a><a href="#h80-0-6" id="h80-0-6" class="i">+    inner class Location : ConfigContainer(hasGlobalState = true) {
</a><a href="#h80-0-7" id="h80-0-7" class="i">+        val latitude = float(&quot;location_latitude&quot;)
</a><a href="#h80-0-8" id="h80-0-8" class="i">+        val longitude = float(&quot;location_longitude&quot;)
</a><a href="#h80-0-9" id="h80-0-9" class="i">+    }
</a><a href="#h80-0-10" id="h80-0-10" class="i">+    val location = container(&quot;location&quot;, Location())
</a><a href="#h80-0-11" id="h80-0-11" class="i">+
</a><a href="#h80-0-12" id="h80-0-12" class="i">+    inner class Device : ConfigContainer(hasGlobalState = true) {
</a><a href="#h80-0-13" id="h80-0-13" class="i">+        val fingerprint = string(&quot;fingerprint&quot;)
</a><a href="#h80-0-14" id="h80-0-14" class="i">+        val androidId = string(&quot;android_id&quot;)
</a><a href="#h80-0-15" id="h80-0-15" class="i">+        val getInstallerPackageName = string(&quot;installer_package_name&quot;)
</a><a href="#h80-0-16" id="h80-0-16" class="i">+        val debugFlag = boolean(&quot;debug_flag&quot;)
</a><a href="#h80-0-17" id="h80-0-17" class="i">+        val mockLocationState = boolean(&quot;mock_location&quot;)
</a><a href="#h80-0-18" id="h80-0-18" class="i">+        val splitClassLoader = string(&quot;split_classloader&quot;)
</a><a href="#h80-0-19" id="h80-0-19" class="i">+        val isLowEndDevice = string(&quot;low_end_device&quot;)
</a><a href="#h80-0-20" id="h80-0-20" class="i">+        val getDataDirectory = string(&quot;get_data_directory&quot;)
</a><a href="#h80-0-21" id="h80-0-21" class="i">+    }
</a><a href="#h80-0-22" id="h80-0-22" class="i">+    val device = container(&quot;device&quot;, Device()) { addNotices(FeatureNotice.BAN_RISK) }
</a><a href="#h80-0-23" id="h80-0-23" class="i">+}</a><a href="#h80-0-24" id="h80-0-24" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h81" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/config/impl/StreaksReminderConfig.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/config/impl/StreaksReminderConfig.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/config/impl/StreaksReminderConfig.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/config/impl/StreaksReminderConfig.kt</a></b>
<a href="#h81-0" id="h81-0" class="h">@@ -0,0 +1,9 @@
</a><a href="#h81-0-0" id="h81-0-0" class="i">+package me.rhunk.snapenhance.common.config.impl
</a><a href="#h81-0-1" id="h81-0-1" class="i">+
</a><a href="#h81-0-2" id="h81-0-2" class="i">+import me.rhunk.snapenhance.common.config.ConfigContainer
</a><a href="#h81-0-3" id="h81-0-3" class="i">+
</a><a href="#h81-0-4" id="h81-0-4" class="i">+class StreaksReminderConfig : ConfigContainer(hasGlobalState = true) {
</a><a href="#h81-0-5" id="h81-0-5" class="i">+    val interval = integer(&quot;interval&quot;, 2)
</a><a href="#h81-0-6" id="h81-0-6" class="i">+    val remainingHours = integer(&quot;remaining_hours&quot;, 13)
</a><a href="#h81-0-7" id="h81-0-7" class="i">+    val groupNotifications = boolean(&quot;group_notifications&quot;, true)
</a><a href="#h81-0-8" id="h81-0-8" class="i">+}</a><a href="#h81-0-9" id="h81-0-9" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h82" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/config/impl/UserInterfaceTweaks.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/config/impl/UserInterfaceTweaks.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/config/impl/UserInterfaceTweaks.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/config/impl/UserInterfaceTweaks.kt</a></b>
<a href="#h82-0" id="h82-0" class="h">@@ -0,0 +1,45 @@
</a><a href="#h82-0-0" id="h82-0-0" class="i">+package me.rhunk.snapenhance.common.config.impl
</a><a href="#h82-0-1" id="h82-0-1" class="i">+
</a><a href="#h82-0-2" id="h82-0-2" class="i">+import me.rhunk.snapenhance.common.config.ConfigContainer
</a><a href="#h82-0-3" id="h82-0-3" class="i">+import me.rhunk.snapenhance.common.config.FeatureNotice
</a><a href="#h82-0-4" id="h82-0-4" class="i">+import me.rhunk.snapenhance.common.data.MessagingRuleType
</a><a href="#h82-0-5" id="h82-0-5" class="i">+
</a><a href="#h82-0-6" id="h82-0-6" class="i">+class UserInterfaceTweaks : ConfigContainer() {
</a><a href="#h82-0-7" id="h82-0-7" class="i">+    class BootstrapOverride : ConfigContainer() {
</a><a href="#h82-0-8" id="h82-0-8" class="i">+        companion object {
</a><a href="#h82-0-9" id="h82-0-9" class="i">+            val tabs = arrayOf(&quot;map&quot;, &quot;chat&quot;, &quot;camera&quot;, &quot;discover&quot;, &quot;spotlight&quot;)
</a><a href="#h82-0-10" id="h82-0-10" class="i">+        }
</a><a href="#h82-0-11" id="h82-0-11" class="i">+
</a><a href="#h82-0-12" id="h82-0-12" class="i">+        val appAppearance = unique(&quot;app_appearance&quot;, &quot;always_light&quot;, &quot;always_dark&quot;)
</a><a href="#h82-0-13" id="h82-0-13" class="i">+        val homeTab = unique(&quot;home_tab&quot;, *tabs) { addNotices(FeatureNotice.UNSTABLE) }
</a><a href="#h82-0-14" id="h82-0-14" class="i">+    }
</a><a href="#h82-0-15" id="h82-0-15" class="i">+
</a><a href="#h82-0-16" id="h82-0-16" class="i">+    inner class FriendFeedMessagePreview : ConfigContainer(hasGlobalState = true) {
</a><a href="#h82-0-17" id="h82-0-17" class="i">+        val amount = integer(&quot;amount&quot;, defaultValue = 1)
</a><a href="#h82-0-18" id="h82-0-18" class="i">+    }
</a><a href="#h82-0-19" id="h82-0-19" class="i">+
</a><a href="#h82-0-20" id="h82-0-20" class="i">+    val friendFeedMenuButtons = multiple(
</a><a href="#h82-0-21" id="h82-0-21" class="i">+        &quot;friend_feed_menu_buttons&quot;,&quot;conversation_info&quot;, *MessagingRuleType.entries.filter { it.showInFriendMenu }.map { it.key }.toTypedArray()
</a><a href="#h82-0-22" id="h82-0-22" class="i">+    ).apply {
</a><a href="#h82-0-23" id="h82-0-23" class="i">+        set(mutableListOf(&quot;conversation_info&quot;, MessagingRuleType.STEALTH.key))
</a><a href="#h82-0-24" id="h82-0-24" class="i">+    }
</a><a href="#h82-0-25" id="h82-0-25" class="i">+    val friendFeedMenuPosition = integer(&quot;friend_feed_menu_position&quot;, defaultValue = 1)
</a><a href="#h82-0-26" id="h82-0-26" class="i">+    val amoledDarkMode = boolean(&quot;amoled_dark_mode&quot;) { addNotices(FeatureNotice.UNSTABLE); requireRestart() }
</a><a href="#h82-0-27" id="h82-0-27" class="i">+    val friendFeedMessagePreview = container(&quot;friend_feed_message_preview&quot;, FriendFeedMessagePreview()) { requireRestart() }
</a><a href="#h82-0-28" id="h82-0-28" class="i">+    val bootstrapOverride = container(&quot;bootstrap_override&quot;, BootstrapOverride()) { requireRestart() }
</a><a href="#h82-0-29" id="h82-0-29" class="i">+    val mapFriendNameTags = boolean(&quot;map_friend_nametags&quot;) { requireRestart() }
</a><a href="#h82-0-30" id="h82-0-30" class="i">+    val streakExpirationInfo = boolean(&quot;streak_expiration_info&quot;) { requireRestart() }
</a><a href="#h82-0-31" id="h82-0-31" class="i">+    val hideStreakRestore = boolean(&quot;hide_streak_restore&quot;) { requireRestart() }
</a><a href="#h82-0-32" id="h82-0-32" class="i">+    val hideStorySections = multiple(&quot;hide_story_sections&quot;,
</a><a href="#h82-0-33" id="h82-0-33" class="i">+        &quot;hide_friend_suggestions&quot;, &quot;hide_friends&quot;, &quot;hide_suggested&quot;, &quot;hide_for_you&quot;) { requireRestart() }
</a><a href="#h82-0-34" id="h82-0-34" class="i">+    val hideUiComponents = multiple(&quot;hide_ui_components&quot;,
</a><a href="#h82-0-35" id="h82-0-35" class="i">+        &quot;hide_voice_record_button&quot;,
</a><a href="#h82-0-36" id="h82-0-36" class="i">+        &quot;hide_stickers_button&quot;,
</a><a href="#h82-0-37" id="h82-0-37" class="i">+        &quot;hide_live_location_share_button&quot;,
</a><a href="#h82-0-38" id="h82-0-38" class="i">+        &quot;hide_chat_call_buttons&quot;,
</a><a href="#h82-0-39" id="h82-0-39" class="i">+        &quot;hide_profile_call_buttons&quot;
</a><a href="#h82-0-40" id="h82-0-40" class="i">+    ) { requireRestart() }
</a><a href="#h82-0-41" id="h82-0-41" class="i">+    val ddBitmojiSelfie = boolean(&quot;2d_bitmoji_selfie&quot;) { requireCleanCache() }
</a><a href="#h82-0-42" id="h82-0-42" class="i">+    val disableSpotlight = boolean(&quot;disable_spotlight&quot;) { requireRestart() }
</a><a href="#h82-0-43" id="h82-0-43" class="i">+    val storyViewerOverride = unique(&quot;story_viewer_override&quot;, &quot;DISCOVER_PLAYBACK_SEEKBAR&quot;, &quot;VERTICAL_STORY_VIEWER&quot;) { requireRestart() }
</a><a href="#h82-0-44" id="h82-0-44" class="i">+}
</a><b>diff --git a/<a id="h83" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/data/FileType.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/data/FileType.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/data/FileType.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/data/FileType.kt</a></b>
<a href="#h83-0" id="h83-0" class="h">@@ -0,0 +1,72 @@
</a><a href="#h83-0-0" id="h83-0-0" class="i">+package me.rhunk.snapenhance.common.data
</a><a href="#h83-0-1" id="h83-0-1" class="i">+
</a><a href="#h83-0-2" id="h83-0-2" class="i">+import java.io.File
</a><a href="#h83-0-3" id="h83-0-3" class="i">+import java.io.InputStream
</a><a href="#h83-0-4" id="h83-0-4" class="i">+
</a><a href="#h83-0-5" id="h83-0-5" class="i">+enum class FileType(
</a><a href="#h83-0-6" id="h83-0-6" class="i">+    val fileExtension: String? = null,
</a><a href="#h83-0-7" id="h83-0-7" class="i">+    val mimeType: String,
</a><a href="#h83-0-8" id="h83-0-8" class="i">+    val isVideo: Boolean = false,
</a><a href="#h83-0-9" id="h83-0-9" class="i">+    val isImage: Boolean = false,
</a><a href="#h83-0-10" id="h83-0-10" class="i">+    val isAudio: Boolean = false
</a><a href="#h83-0-11" id="h83-0-11" class="i">+) {
</a><a href="#h83-0-12" id="h83-0-12" class="i">+    GIF(&quot;gif&quot;, &quot;image/gif&quot;, false, false, false),
</a><a href="#h83-0-13" id="h83-0-13" class="i">+    PNG(&quot;png&quot;, &quot;image/png&quot;, false, true, false),
</a><a href="#h83-0-14" id="h83-0-14" class="i">+    MP4(&quot;mp4&quot;, &quot;video/mp4&quot;, true, false, false),
</a><a href="#h83-0-15" id="h83-0-15" class="i">+    MP3(&quot;mp3&quot;, &quot;audio/mp3&quot;,false, false, true),
</a><a href="#h83-0-16" id="h83-0-16" class="i">+    OPUS(&quot;opus&quot;, &quot;audio/opus&quot;, false, false, true),
</a><a href="#h83-0-17" id="h83-0-17" class="i">+    AAC(&quot;aac&quot;, &quot;audio/aac&quot;, false, false, true),
</a><a href="#h83-0-18" id="h83-0-18" class="i">+    JPG(&quot;jpg&quot;, &quot;image/jpg&quot;,false, true, false),
</a><a href="#h83-0-19" id="h83-0-19" class="i">+    ZIP(&quot;zip&quot;, &quot;application/zip&quot;, false, false, false),
</a><a href="#h83-0-20" id="h83-0-20" class="i">+    WEBP(&quot;webp&quot;, &quot;image/webp&quot;, false, true, false),
</a><a href="#h83-0-21" id="h83-0-21" class="i">+    MPD(&quot;mpd&quot;, &quot;text/xml&quot;, false, false, false),
</a><a href="#h83-0-22" id="h83-0-22" class="i">+    UNKNOWN(&quot;dat&quot;, &quot;application/octet-stream&quot;, false, false, false);
</a><a href="#h83-0-23" id="h83-0-23" class="i">+
</a><a href="#h83-0-24" id="h83-0-24" class="i">+    companion object {
</a><a href="#h83-0-25" id="h83-0-25" class="i">+        private val fileSignatures = mapOf(
</a><a href="#h83-0-26" id="h83-0-26" class="i">+            &quot;52494646&quot; to WEBP,
</a><a href="#h83-0-27" id="h83-0-27" class="i">+            &quot;504b0304&quot; to ZIP,
</a><a href="#h83-0-28" id="h83-0-28" class="i">+            &quot;89504e47&quot; to PNG,
</a><a href="#h83-0-29" id="h83-0-29" class="i">+            &quot;00000020&quot; to MP4,
</a><a href="#h83-0-30" id="h83-0-30" class="i">+            &quot;00000018&quot; to MP4,
</a><a href="#h83-0-31" id="h83-0-31" class="i">+            &quot;0000001c&quot; to MP4,
</a><a href="#h83-0-32" id="h83-0-32" class="i">+            &quot;494433&quot; to MP3,
</a><a href="#h83-0-33" id="h83-0-33" class="i">+            &quot;4f676753&quot; to OPUS,
</a><a href="#h83-0-34" id="h83-0-34" class="i">+            &quot;fff15&quot; to AAC,
</a><a href="#h83-0-35" id="h83-0-35" class="i">+            &quot;ffd8ff&quot; to JPG,
</a><a href="#h83-0-36" id="h83-0-36" class="i">+        )
</a><a href="#h83-0-37" id="h83-0-37" class="i">+
</a><a href="#h83-0-38" id="h83-0-38" class="i">+        fun fromString(string: String?): FileType {
</a><a href="#h83-0-39" id="h83-0-39" class="i">+            return entries.firstOrNull { it.fileExtension.equals(string, ignoreCase = true) } ?: UNKNOWN
</a><a href="#h83-0-40" id="h83-0-40" class="i">+        }
</a><a href="#h83-0-41" id="h83-0-41" class="i">+
</a><a href="#h83-0-42" id="h83-0-42" class="i">+        private fun bytesToHex(bytes: ByteArray): String {
</a><a href="#h83-0-43" id="h83-0-43" class="i">+            val result = StringBuilder()
</a><a href="#h83-0-44" id="h83-0-44" class="i">+            for (b in bytes) {
</a><a href="#h83-0-45" id="h83-0-45" class="i">+                result.append(String.format(&quot;%02x&quot;, b))
</a><a href="#h83-0-46" id="h83-0-46" class="i">+            }
</a><a href="#h83-0-47" id="h83-0-47" class="i">+            return result.toString()
</a><a href="#h83-0-48" id="h83-0-48" class="i">+        }
</a><a href="#h83-0-49" id="h83-0-49" class="i">+
</a><a href="#h83-0-50" id="h83-0-50" class="i">+        fun fromFile(file: File): FileType {
</a><a href="#h83-0-51" id="h83-0-51" class="i">+            file.inputStream().use { inputStream -&gt;
</a><a href="#h83-0-52" id="h83-0-52" class="i">+                val buffer = ByteArray(16)
</a><a href="#h83-0-53" id="h83-0-53" class="i">+                inputStream.read(buffer)
</a><a href="#h83-0-54" id="h83-0-54" class="i">+                return fromByteArray(buffer)
</a><a href="#h83-0-55" id="h83-0-55" class="i">+            }
</a><a href="#h83-0-56" id="h83-0-56" class="i">+        }
</a><a href="#h83-0-57" id="h83-0-57" class="i">+
</a><a href="#h83-0-58" id="h83-0-58" class="i">+        fun fromByteArray(array: ByteArray): FileType {
</a><a href="#h83-0-59" id="h83-0-59" class="i">+            val headerBytes = ByteArray(16)
</a><a href="#h83-0-60" id="h83-0-60" class="i">+            System.arraycopy(array, 0, headerBytes, 0, 16)
</a><a href="#h83-0-61" id="h83-0-61" class="i">+            val hex = bytesToHex(headerBytes)
</a><a href="#h83-0-62" id="h83-0-62" class="i">+            return fileSignatures.entries.firstOrNull { hex.startsWith(it.key) }?.value ?: UNKNOWN
</a><a href="#h83-0-63" id="h83-0-63" class="i">+        }
</a><a href="#h83-0-64" id="h83-0-64" class="i">+
</a><a href="#h83-0-65" id="h83-0-65" class="i">+        fun fromInputStream(inputStream: InputStream): FileType {
</a><a href="#h83-0-66" id="h83-0-66" class="i">+            val buffer = ByteArray(16)
</a><a href="#h83-0-67" id="h83-0-67" class="i">+            inputStream.read(buffer)
</a><a href="#h83-0-68" id="h83-0-68" class="i">+            return fromByteArray(buffer)
</a><a href="#h83-0-69" id="h83-0-69" class="i">+        }
</a><a href="#h83-0-70" id="h83-0-70" class="i">+    }
</a><a href="#h83-0-71" id="h83-0-71" class="i">+}
</a><b>diff --git a/<a id="h84" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/data/MessagingCoreObjects.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/data/MessagingCoreObjects.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/data/MessagingCoreObjects.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/data/MessagingCoreObjects.kt</a></b>
<a href="#h84-0" id="h84-0" class="h">@@ -0,0 +1,73 @@
</a><a href="#h84-0-0" id="h84-0-0" class="i">+package me.rhunk.snapenhance.common.data
</a><a href="#h84-0-1" id="h84-0-1" class="i">+
</a><a href="#h84-0-2" id="h84-0-2" class="i">+import me.rhunk.snapenhance.common.util.SerializableDataObject
</a><a href="#h84-0-3" id="h84-0-3" class="i">+
</a><a href="#h84-0-4" id="h84-0-4" class="i">+
</a><a href="#h84-0-5" id="h84-0-5" class="i">+enum class RuleState(
</a><a href="#h84-0-6" id="h84-0-6" class="i">+    val key: String
</a><a href="#h84-0-7" id="h84-0-7" class="i">+) {
</a><a href="#h84-0-8" id="h84-0-8" class="i">+    BLACKLIST(&quot;blacklist&quot;),
</a><a href="#h84-0-9" id="h84-0-9" class="i">+    WHITELIST(&quot;whitelist&quot;);
</a><a href="#h84-0-10" id="h84-0-10" class="i">+
</a><a href="#h84-0-11" id="h84-0-11" class="i">+    companion object {
</a><a href="#h84-0-12" id="h84-0-12" class="i">+        fun getByName(name: String) = entries.first { it.key == name }
</a><a href="#h84-0-13" id="h84-0-13" class="i">+    }
</a><a href="#h84-0-14" id="h84-0-14" class="i">+}
</a><a href="#h84-0-15" id="h84-0-15" class="i">+
</a><a href="#h84-0-16" id="h84-0-16" class="i">+enum class SocialScope(
</a><a href="#h84-0-17" id="h84-0-17" class="i">+    val key: String,
</a><a href="#h84-0-18" id="h84-0-18" class="i">+    val tabRoute: String,
</a><a href="#h84-0-19" id="h84-0-19" class="i">+) {
</a><a href="#h84-0-20" id="h84-0-20" class="i">+    FRIEND(&quot;friend&quot;, &quot;friend_info/{id}&quot;),
</a><a href="#h84-0-21" id="h84-0-21" class="i">+    GROUP(&quot;group&quot;, &quot;group_info/{id}&quot;);
</a><a href="#h84-0-22" id="h84-0-22" class="i">+
</a><a href="#h84-0-23" id="h84-0-23" class="i">+    companion object {
</a><a href="#h84-0-24" id="h84-0-24" class="i">+        fun getByName(name: String) = entries.first { it.key == name }
</a><a href="#h84-0-25" id="h84-0-25" class="i">+    }
</a><a href="#h84-0-26" id="h84-0-26" class="i">+}
</a><a href="#h84-0-27" id="h84-0-27" class="i">+
</a><a href="#h84-0-28" id="h84-0-28" class="i">+enum class MessagingRuleType(
</a><a href="#h84-0-29" id="h84-0-29" class="i">+    val key: String,
</a><a href="#h84-0-30" id="h84-0-30" class="i">+    val listMode: Boolean,
</a><a href="#h84-0-31" id="h84-0-31" class="i">+    val showInFriendMenu: Boolean = true
</a><a href="#h84-0-32" id="h84-0-32" class="i">+) {
</a><a href="#h84-0-33" id="h84-0-33" class="i">+    AUTO_DOWNLOAD(&quot;auto_download&quot;, true),
</a><a href="#h84-0-34" id="h84-0-34" class="i">+    STEALTH(&quot;stealth&quot;, true),
</a><a href="#h84-0-35" id="h84-0-35" class="i">+    AUTO_SAVE(&quot;auto_save&quot;, true),
</a><a href="#h84-0-36" id="h84-0-36" class="i">+    HIDE_CHAT_FEED(&quot;hide_chat_feed&quot;, false, showInFriendMenu = false),
</a><a href="#h84-0-37" id="h84-0-37" class="i">+    E2E_ENCRYPTION(&quot;e2e_encryption&quot;, false),
</a><a href="#h84-0-38" id="h84-0-38" class="i">+    PIN_CONVERSATION(&quot;pin_conversation&quot;, false, showInFriendMenu = false);
</a><a href="#h84-0-39" id="h84-0-39" class="i">+
</a><a href="#h84-0-40" id="h84-0-40" class="i">+    fun translateOptionKey(optionKey: String): String {
</a><a href="#h84-0-41" id="h84-0-41" class="i">+        return if (listMode) &quot;rules.properties.$key.options.$optionKey&quot; else &quot;rules.properties.$key.name&quot;
</a><a href="#h84-0-42" id="h84-0-42" class="i">+    }
</a><a href="#h84-0-43" id="h84-0-43" class="i">+
</a><a href="#h84-0-44" id="h84-0-44" class="i">+    companion object {
</a><a href="#h84-0-45" id="h84-0-45" class="i">+        fun getByName(name: String) = entries.firstOrNull { it.key == name }
</a><a href="#h84-0-46" id="h84-0-46" class="i">+    }
</a><a href="#h84-0-47" id="h84-0-47" class="i">+}
</a><a href="#h84-0-48" id="h84-0-48" class="i">+
</a><a href="#h84-0-49" id="h84-0-49" class="i">+data class FriendStreaks(
</a><a href="#h84-0-50" id="h84-0-50" class="i">+    val userId: String,
</a><a href="#h84-0-51" id="h84-0-51" class="i">+    val notify: Boolean,
</a><a href="#h84-0-52" id="h84-0-52" class="i">+    val expirationTimestamp: Long,
</a><a href="#h84-0-53" id="h84-0-53" class="i">+    val length: Int
</a><a href="#h84-0-54" id="h84-0-54" class="i">+) : SerializableDataObject() {
</a><a href="#h84-0-55" id="h84-0-55" class="i">+    fun hoursLeft() = (expirationTimestamp - System.currentTimeMillis()) / 1000 / 60 / 60
</a><a href="#h84-0-56" id="h84-0-56" class="i">+
</a><a href="#h84-0-57" id="h84-0-57" class="i">+    fun isAboutToExpire(expireHours: Int) = expirationTimestamp - System.currentTimeMillis() &lt; expireHours * 60 * 60 * 1000
</a><a href="#h84-0-58" id="h84-0-58" class="i">+}
</a><a href="#h84-0-59" id="h84-0-59" class="i">+
</a><a href="#h84-0-60" id="h84-0-60" class="i">+data class MessagingGroupInfo(
</a><a href="#h84-0-61" id="h84-0-61" class="i">+    val conversationId: String,
</a><a href="#h84-0-62" id="h84-0-62" class="i">+    val name: String,
</a><a href="#h84-0-63" id="h84-0-63" class="i">+    val participantsCount: Int
</a><a href="#h84-0-64" id="h84-0-64" class="i">+) : SerializableDataObject()
</a><a href="#h84-0-65" id="h84-0-65" class="i">+
</a><a href="#h84-0-66" id="h84-0-66" class="i">+data class MessagingFriendInfo(
</a><a href="#h84-0-67" id="h84-0-67" class="i">+    val userId: String,
</a><a href="#h84-0-68" id="h84-0-68" class="i">+    val displayName: String?,
</a><a href="#h84-0-69" id="h84-0-69" class="i">+    val mutableUsername: String,
</a><a href="#h84-0-70" id="h84-0-70" class="i">+    val bitmojiId: String?,
</a><a href="#h84-0-71" id="h84-0-71" class="i">+    val selfieId: String?
</a><a href="#h84-0-72" id="h84-0-72" class="i">+) : SerializableDataObject()
</a><b>diff --git a/<a id="h85" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/data/SnapEnums.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/data/SnapEnums.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/data/SnapEnums.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/data/SnapEnums.kt</a></b>
<a href="#h85-0" id="h85-0" class="h">@@ -0,0 +1,172 @@
</a><a href="#h85-0-0" id="h85-0-0" class="i">+package me.rhunk.snapenhance.common.data
</a><a href="#h85-0-1" id="h85-0-1" class="i">+
</a><a href="#h85-0-2" id="h85-0-2" class="i">+import me.rhunk.snapenhance.common.util.protobuf.ProtoReader
</a><a href="#h85-0-3" id="h85-0-3" class="i">+
</a><a href="#h85-0-4" id="h85-0-4" class="i">+enum class MessageState {
</a><a href="#h85-0-5" id="h85-0-5" class="i">+    PREPARING, SENDING, COMMITTED, FAILED, CANCELING
</a><a href="#h85-0-6" id="h85-0-6" class="i">+}
</a><a href="#h85-0-7" id="h85-0-7" class="i">+
</a><a href="#h85-0-8" id="h85-0-8" class="i">+enum class NotificationType (
</a><a href="#h85-0-9" id="h85-0-9" class="i">+    val key: String,
</a><a href="#h85-0-10" id="h85-0-10" class="i">+    val isIncoming: Boolean = false,
</a><a href="#h85-0-11" id="h85-0-11" class="i">+    val associatedOutgoingContentType: ContentType? = null,
</a><a href="#h85-0-12" id="h85-0-12" class="i">+) {
</a><a href="#h85-0-13" id="h85-0-13" class="i">+    SCREENSHOT(&quot;chat_screenshot&quot;, true, ContentType.STATUS_CONVERSATION_CAPTURE_SCREENSHOT),
</a><a href="#h85-0-14" id="h85-0-14" class="i">+    SCREEN_RECORD(&quot;chat_screen_record&quot;, true, ContentType.STATUS_CONVERSATION_CAPTURE_RECORD),
</a><a href="#h85-0-15" id="h85-0-15" class="i">+    CAMERA_ROLL_SAVE(&quot;camera_roll_save&quot;, true, ContentType.STATUS_SAVE_TO_CAMERA_ROLL),
</a><a href="#h85-0-16" id="h85-0-16" class="i">+    SNAP_REPLAY(&quot;snap_replay&quot;, true, ContentType.STATUS),
</a><a href="#h85-0-17" id="h85-0-17" class="i">+    SNAP(&quot;snap&quot;,true),
</a><a href="#h85-0-18" id="h85-0-18" class="i">+    CHAT(&quot;chat&quot;,true),
</a><a href="#h85-0-19" id="h85-0-19" class="i">+    CHAT_REPLY(&quot;chat_reply&quot;,true),
</a><a href="#h85-0-20" id="h85-0-20" class="i">+    TYPING(&quot;typing&quot;, true),
</a><a href="#h85-0-21" id="h85-0-21" class="i">+    STORIES(&quot;stories&quot;,true),
</a><a href="#h85-0-22" id="h85-0-22" class="i">+    INITIATE_AUDIO(&quot;initiate_audio&quot;,true),
</a><a href="#h85-0-23" id="h85-0-23" class="i">+    ABANDON_AUDIO(&quot;abandon_audio&quot;, false, ContentType.STATUS_CALL_MISSED_AUDIO),
</a><a href="#h85-0-24" id="h85-0-24" class="i">+    INITIATE_VIDEO(&quot;initiate_video&quot;,true),
</a><a href="#h85-0-25" id="h85-0-25" class="i">+    ABANDON_VIDEO(&quot;abandon_video&quot;, false, ContentType.STATUS_CALL_MISSED_VIDEO);
</a><a href="#h85-0-26" id="h85-0-26" class="i">+
</a><a href="#h85-0-27" id="h85-0-27" class="i">+    companion object {
</a><a href="#h85-0-28" id="h85-0-28" class="i">+        fun getIncomingValues(): List&lt;NotificationType&gt; {
</a><a href="#h85-0-29" id="h85-0-29" class="i">+            return entries.filter { it.isIncoming }.toList()
</a><a href="#h85-0-30" id="h85-0-30" class="i">+        }
</a><a href="#h85-0-31" id="h85-0-31" class="i">+
</a><a href="#h85-0-32" id="h85-0-32" class="i">+        fun getOutgoingValues(): List&lt;NotificationType&gt; {
</a><a href="#h85-0-33" id="h85-0-33" class="i">+            return entries.filter { it.associatedOutgoingContentType != null }.toList()
</a><a href="#h85-0-34" id="h85-0-34" class="i">+        }
</a><a href="#h85-0-35" id="h85-0-35" class="i">+
</a><a href="#h85-0-36" id="h85-0-36" class="i">+        fun fromContentType(contentType: ContentType): NotificationType? {
</a><a href="#h85-0-37" id="h85-0-37" class="i">+            return entries.firstOrNull { it.associatedOutgoingContentType == contentType }
</a><a href="#h85-0-38" id="h85-0-38" class="i">+        }
</a><a href="#h85-0-39" id="h85-0-39" class="i">+    }
</a><a href="#h85-0-40" id="h85-0-40" class="i">+}
</a><a href="#h85-0-41" id="h85-0-41" class="i">+
</a><a href="#h85-0-42" id="h85-0-42" class="i">+enum class ContentType(val id: Int) {
</a><a href="#h85-0-43" id="h85-0-43" class="i">+    UNKNOWN(-1),
</a><a href="#h85-0-44" id="h85-0-44" class="i">+    SNAP(0),
</a><a href="#h85-0-45" id="h85-0-45" class="i">+    CHAT(1),
</a><a href="#h85-0-46" id="h85-0-46" class="i">+    EXTERNAL_MEDIA(2),
</a><a href="#h85-0-47" id="h85-0-47" class="i">+    SHARE(3),
</a><a href="#h85-0-48" id="h85-0-48" class="i">+    NOTE(4),
</a><a href="#h85-0-49" id="h85-0-49" class="i">+    STICKER(5),
</a><a href="#h85-0-50" id="h85-0-50" class="i">+    STATUS(6),
</a><a href="#h85-0-51" id="h85-0-51" class="i">+    LOCATION(7),
</a><a href="#h85-0-52" id="h85-0-52" class="i">+    STATUS_SAVE_TO_CAMERA_ROLL(8),
</a><a href="#h85-0-53" id="h85-0-53" class="i">+    STATUS_CONVERSATION_CAPTURE_SCREENSHOT(9),
</a><a href="#h85-0-54" id="h85-0-54" class="i">+    STATUS_CONVERSATION_CAPTURE_RECORD(10),
</a><a href="#h85-0-55" id="h85-0-55" class="i">+    STATUS_CALL_MISSED_VIDEO(11),
</a><a href="#h85-0-56" id="h85-0-56" class="i">+    STATUS_CALL_MISSED_AUDIO(12),
</a><a href="#h85-0-57" id="h85-0-57" class="i">+    LIVE_LOCATION_SHARE(13),
</a><a href="#h85-0-58" id="h85-0-58" class="i">+    CREATIVE_TOOL_ITEM(14),
</a><a href="#h85-0-59" id="h85-0-59" class="i">+    FAMILY_CENTER_INVITE(15),
</a><a href="#h85-0-60" id="h85-0-60" class="i">+    FAMILY_CENTER_ACCEPT(16),
</a><a href="#h85-0-61" id="h85-0-61" class="i">+    FAMILY_CENTER_LEAVE(17),
</a><a href="#h85-0-62" id="h85-0-62" class="i">+    STATUS_PLUS_GIFT(18);
</a><a href="#h85-0-63" id="h85-0-63" class="i">+
</a><a href="#h85-0-64" id="h85-0-64" class="i">+    companion object {
</a><a href="#h85-0-65" id="h85-0-65" class="i">+        fun fromId(i: Int): ContentType {
</a><a href="#h85-0-66" id="h85-0-66" class="i">+            return entries.firstOrNull { it.id == i } ?: UNKNOWN
</a><a href="#h85-0-67" id="h85-0-67" class="i">+        }
</a><a href="#h85-0-68" id="h85-0-68" class="i">+
</a><a href="#h85-0-69" id="h85-0-69" class="i">+        fun fromMessageContainer(protoReader: ProtoReader?): ContentType? {
</a><a href="#h85-0-70" id="h85-0-70" class="i">+            if (protoReader == null) return null
</a><a href="#h85-0-71" id="h85-0-71" class="i">+            return protoReader.run {
</a><a href="#h85-0-72" id="h85-0-72" class="i">+                when {
</a><a href="#h85-0-73" id="h85-0-73" class="i">+                    contains(8) -&gt; STATUS
</a><a href="#h85-0-74" id="h85-0-74" class="i">+                    contains(2) -&gt; CHAT
</a><a href="#h85-0-75" id="h85-0-75" class="i">+                    contains(11) -&gt; SNAP
</a><a href="#h85-0-76" id="h85-0-76" class="i">+                    contains(6) -&gt; NOTE
</a><a href="#h85-0-77" id="h85-0-77" class="i">+                    contains(3) -&gt; EXTERNAL_MEDIA
</a><a href="#h85-0-78" id="h85-0-78" class="i">+                    contains(4) -&gt; STICKER
</a><a href="#h85-0-79" id="h85-0-79" class="i">+                    contains(5) -&gt; SHARE
</a><a href="#h85-0-80" id="h85-0-80" class="i">+                    contains(7) -&gt; EXTERNAL_MEDIA // story replies
</a><a href="#h85-0-81" id="h85-0-81" class="i">+                    else -&gt; null
</a><a href="#h85-0-82" id="h85-0-82" class="i">+                }
</a><a href="#h85-0-83" id="h85-0-83" class="i">+            }
</a><a href="#h85-0-84" id="h85-0-84" class="i">+        }
</a><a href="#h85-0-85" id="h85-0-85" class="i">+    }
</a><a href="#h85-0-86" id="h85-0-86" class="i">+}
</a><a href="#h85-0-87" id="h85-0-87" class="i">+
</a><a href="#h85-0-88" id="h85-0-88" class="i">+enum class PlayableSnapState {
</a><a href="#h85-0-89" id="h85-0-89" class="i">+    NOTDOWNLOADED, DOWNLOADING, DOWNLOADFAILED, PLAYABLE, VIEWEDREPLAYABLE, PLAYING, VIEWEDNOTREPLAYABLE
</a><a href="#h85-0-90" id="h85-0-90" class="i">+}
</a><a href="#h85-0-91" id="h85-0-91" class="i">+
</a><a href="#h85-0-92" id="h85-0-92" class="i">+enum class MetricsMessageMediaType {
</a><a href="#h85-0-93" id="h85-0-93" class="i">+    NO_MEDIA,
</a><a href="#h85-0-94" id="h85-0-94" class="i">+    IMAGE,
</a><a href="#h85-0-95" id="h85-0-95" class="i">+    VIDEO,
</a><a href="#h85-0-96" id="h85-0-96" class="i">+    VIDEO_NO_SOUND,
</a><a href="#h85-0-97" id="h85-0-97" class="i">+    GIF,
</a><a href="#h85-0-98" id="h85-0-98" class="i">+    DERIVED_FROM_MESSAGE_TYPE,
</a><a href="#h85-0-99" id="h85-0-99" class="i">+    REACTION
</a><a href="#h85-0-100" id="h85-0-100" class="i">+}
</a><a href="#h85-0-101" id="h85-0-101" class="i">+
</a><a href="#h85-0-102" id="h85-0-102" class="i">+enum class MetricsMessageType {
</a><a href="#h85-0-103" id="h85-0-103" class="i">+    TEXT,
</a><a href="#h85-0-104" id="h85-0-104" class="i">+    STICKER,
</a><a href="#h85-0-105" id="h85-0-105" class="i">+    CUSTOM_STICKER,
</a><a href="#h85-0-106" id="h85-0-106" class="i">+    SNAP,
</a><a href="#h85-0-107" id="h85-0-107" class="i">+    AUDIO_NOTE,
</a><a href="#h85-0-108" id="h85-0-108" class="i">+    MEDIA,
</a><a href="#h85-0-109" id="h85-0-109" class="i">+    BATCHED_MEDIA,
</a><a href="#h85-0-110" id="h85-0-110" class="i">+    MISSED_AUDIO_CALL,
</a><a href="#h85-0-111" id="h85-0-111" class="i">+    MISSED_VIDEO_CALL,
</a><a href="#h85-0-112" id="h85-0-112" class="i">+    JOINED_CALL,
</a><a href="#h85-0-113" id="h85-0-113" class="i">+    LEFT_CALL,
</a><a href="#h85-0-114" id="h85-0-114" class="i">+    SNAPCHATTER,
</a><a href="#h85-0-115" id="h85-0-115" class="i">+    LOCATION_SHARE,
</a><a href="#h85-0-116" id="h85-0-116" class="i">+    LOCATION_REQUEST,
</a><a href="#h85-0-117" id="h85-0-117" class="i">+    SCREENSHOT,
</a><a href="#h85-0-118" id="h85-0-118" class="i">+    SCREEN_RECORDING,
</a><a href="#h85-0-119" id="h85-0-119" class="i">+    GAME_CLOSED,
</a><a href="#h85-0-120" id="h85-0-120" class="i">+    STORY_SHARE,
</a><a href="#h85-0-121" id="h85-0-121" class="i">+    MAP_DROP_SHARE,
</a><a href="#h85-0-122" id="h85-0-122" class="i">+    MAP_STORY_SHARE,
</a><a href="#h85-0-123" id="h85-0-123" class="i">+    MAP_STORY_SNAP_SHARE,
</a><a href="#h85-0-124" id="h85-0-124" class="i">+    MAP_HEAT_SNAP_SHARE,
</a><a href="#h85-0-125" id="h85-0-125" class="i">+    MAP_SCREENSHOT_SHARE,
</a><a href="#h85-0-126" id="h85-0-126" class="i">+    MEMORIES_STORY,
</a><a href="#h85-0-127" id="h85-0-127" class="i">+    SEARCH_STORY_SHARE,
</a><a href="#h85-0-128" id="h85-0-128" class="i">+    SEARCH_STORY_SNAP_SHARE,
</a><a href="#h85-0-129" id="h85-0-129" class="i">+    DISCOVER_SHARE,
</a><a href="#h85-0-130" id="h85-0-130" class="i">+    SHAZAM_SHARE,
</a><a href="#h85-0-131" id="h85-0-131" class="i">+    SAVE_TO_CAMERA_ROLL,
</a><a href="#h85-0-132" id="h85-0-132" class="i">+    GAME_SCORE_SHARE,
</a><a href="#h85-0-133" id="h85-0-133" class="i">+    SNAP_PRO_PROFILE_SHARE,
</a><a href="#h85-0-134" id="h85-0-134" class="i">+    SNAP_PRO_SNAP_SHARE,
</a><a href="#h85-0-135" id="h85-0-135" class="i">+    CANVAS_APP_SHARE,
</a><a href="#h85-0-136" id="h85-0-136" class="i">+    AD_SHARE,
</a><a href="#h85-0-137" id="h85-0-137" class="i">+    STORY_REPLY,
</a><a href="#h85-0-138" id="h85-0-138" class="i">+    SPOTLIGHT_STORY_SHARE,
</a><a href="#h85-0-139" id="h85-0-139" class="i">+    CAMEO,
</a><a href="#h85-0-140" id="h85-0-140" class="i">+    MEMOJI,
</a><a href="#h85-0-141" id="h85-0-141" class="i">+    BITMOJI_OUTFIT_SHARE,
</a><a href="#h85-0-142" id="h85-0-142" class="i">+    LIVE_LOCATION_SHARE,
</a><a href="#h85-0-143" id="h85-0-143" class="i">+    CREATIVE_TOOL_ITEM,
</a><a href="#h85-0-144" id="h85-0-144" class="i">+    SNAP_KIT_INVITE_SHARE,
</a><a href="#h85-0-145" id="h85-0-145" class="i">+    QUOTE_REPLY_SHARE,
</a><a href="#h85-0-146" id="h85-0-146" class="i">+    BLOOPS_STORY_SHARE,
</a><a href="#h85-0-147" id="h85-0-147" class="i">+    SNAP_PRO_SAVED_STORY_SHARE,
</a><a href="#h85-0-148" id="h85-0-148" class="i">+    PLACE_PROFILE_SHARE,
</a><a href="#h85-0-149" id="h85-0-149" class="i">+    PLACE_STORY_SHARE,
</a><a href="#h85-0-150" id="h85-0-150" class="i">+    SAVED_STORY_SHARE
</a><a href="#h85-0-151" id="h85-0-151" class="i">+}
</a><a href="#h85-0-152" id="h85-0-152" class="i">+enum class MediaReferenceType {
</a><a href="#h85-0-153" id="h85-0-153" class="i">+    UNASSIGNED, OVERLAY, IMAGE, VIDEO, ASSET_BUNDLE, AUDIO, ANIMATED_IMAGE, FONT, WEB_VIEW_CONTENT, VIDEO_NO_AUDIO
</a><a href="#h85-0-154" id="h85-0-154" class="i">+}
</a><a href="#h85-0-155" id="h85-0-155" class="i">+
</a><a href="#h85-0-156" id="h85-0-156" class="i">+enum class FriendLinkType(val value: Int, val shortName: String) {
</a><a href="#h85-0-157" id="h85-0-157" class="i">+    MUTUAL(0, &quot;mutual&quot;),
</a><a href="#h85-0-158" id="h85-0-158" class="i">+    OUTGOING(1, &quot;outgoing&quot;),
</a><a href="#h85-0-159" id="h85-0-159" class="i">+    BLOCKED(2, &quot;blocked&quot;),
</a><a href="#h85-0-160" id="h85-0-160" class="i">+    DELETED(3, &quot;deleted&quot;),
</a><a href="#h85-0-161" id="h85-0-161" class="i">+    FOLLOWING(4, &quot;following&quot;),
</a><a href="#h85-0-162" id="h85-0-162" class="i">+    SUGGESTED(5, &quot;suggested&quot;),
</a><a href="#h85-0-163" id="h85-0-163" class="i">+    INCOMING(6, &quot;incoming&quot;),
</a><a href="#h85-0-164" id="h85-0-164" class="i">+    INCOMING_FOLLOWER(7, &quot;incoming_follower&quot;);
</a><a href="#h85-0-165" id="h85-0-165" class="i">+
</a><a href="#h85-0-166" id="h85-0-166" class="i">+    companion object {
</a><a href="#h85-0-167" id="h85-0-167" class="i">+        fun fromValue(value: Int): FriendLinkType {
</a><a href="#h85-0-168" id="h85-0-168" class="i">+            return entries.firstOrNull { it.value == value } ?: MUTUAL
</a><a href="#h85-0-169" id="h85-0-169" class="i">+        }
</a><a href="#h85-0-170" id="h85-0-170" class="i">+    }
</a><a href="#h85-0-171" id="h85-0-171" class="i">+}</a><a href="#h85-0-172" id="h85-0-172" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h86" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/data/download/DownloadMediaType.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/data/download/DownloadMediaType.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/data/download/DownloadMediaType.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/data/download/DownloadMediaType.kt</a></b>
<a href="#h86-0" id="h86-0" class="h">@@ -0,0 +1,22 @@
</a><a href="#h86-0-0" id="h86-0-0" class="i">+package me.rhunk.snapenhance.common.data.download
</a><a href="#h86-0-1" id="h86-0-1" class="i">+
</a><a href="#h86-0-2" id="h86-0-2" class="i">+import android.net.Uri
</a><a href="#h86-0-3" id="h86-0-3" class="i">+
</a><a href="#h86-0-4" id="h86-0-4" class="i">+enum class DownloadMediaType {
</a><a href="#h86-0-5" id="h86-0-5" class="i">+    PROTO_MEDIA,
</a><a href="#h86-0-6" id="h86-0-6" class="i">+    DIRECT_MEDIA,
</a><a href="#h86-0-7" id="h86-0-7" class="i">+    REMOTE_MEDIA,
</a><a href="#h86-0-8" id="h86-0-8" class="i">+    LOCAL_MEDIA;
</a><a href="#h86-0-9" id="h86-0-9" class="i">+
</a><a href="#h86-0-10" id="h86-0-10" class="i">+    companion object {
</a><a href="#h86-0-11" id="h86-0-11" class="i">+        fun fromUri(uri: Uri): DownloadMediaType {
</a><a href="#h86-0-12" id="h86-0-12" class="i">+            return when (uri.scheme) {
</a><a href="#h86-0-13" id="h86-0-13" class="i">+                &quot;proto&quot; -&gt; PROTO_MEDIA
</a><a href="#h86-0-14" id="h86-0-14" class="i">+                &quot;direct&quot; -&gt; DIRECT_MEDIA
</a><a href="#h86-0-15" id="h86-0-15" class="i">+                &quot;http&quot;, &quot;https&quot; -&gt; REMOTE_MEDIA
</a><a href="#h86-0-16" id="h86-0-16" class="i">+                &quot;file&quot; -&gt; LOCAL_MEDIA
</a><a href="#h86-0-17" id="h86-0-17" class="i">+                else -&gt; throw IllegalArgumentException(&quot;Unknown uri scheme: ${uri.scheme}&quot;)
</a><a href="#h86-0-18" id="h86-0-18" class="i">+            }
</a><a href="#h86-0-19" id="h86-0-19" class="i">+        }
</a><a href="#h86-0-20" id="h86-0-20" class="i">+    }
</a><a href="#h86-0-21" id="h86-0-21" class="i">+}</a><a href="#h86-0-22" id="h86-0-22" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h87" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/data/download/DownloadMetadata.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/data/download/DownloadMetadata.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/data/download/DownloadMetadata.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/data/download/DownloadMetadata.kt</a></b>
<a href="#h87-0" id="h87-0" class="h">@@ -0,0 +1,9 @@
</a><a href="#h87-0-0" id="h87-0-0" class="i">+package me.rhunk.snapenhance.common.data.download
</a><a href="#h87-0-1" id="h87-0-1" class="i">+
</a><a href="#h87-0-2" id="h87-0-2" class="i">+data class DownloadMetadata(
</a><a href="#h87-0-3" id="h87-0-3" class="i">+    val mediaIdentifier: String?,
</a><a href="#h87-0-4" id="h87-0-4" class="i">+    val outputPath: String,
</a><a href="#h87-0-5" id="h87-0-5" class="i">+    val mediaAuthor: String?,
</a><a href="#h87-0-6" id="h87-0-6" class="i">+    val downloadSource: String,
</a><a href="#h87-0-7" id="h87-0-7" class="i">+    val iconUrl: String?
</a><a href="#h87-0-8" id="h87-0-8" class="i">+)</a><a href="#h87-0-9" id="h87-0-9" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h88" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/data/download/DownloadRequest.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/data/download/DownloadRequest.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/data/download/DownloadRequest.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/data/download/DownloadRequest.kt</a></b>
<a href="#h88-0" id="h88-0" class="h">@@ -0,0 +1,28 @@
</a><a href="#h88-0-0" id="h88-0-0" class="i">+package me.rhunk.snapenhance.common.data.download
</a><a href="#h88-0-1" id="h88-0-1" class="i">+
</a><a href="#h88-0-2" id="h88-0-2" class="i">+
</a><a href="#h88-0-3" id="h88-0-3" class="i">+data class DashOptions(val offsetTime: Long, val duration: Long?)
</a><a href="#h88-0-4" id="h88-0-4" class="i">+data class InputMedia(
</a><a href="#h88-0-5" id="h88-0-5" class="i">+    val content: String,
</a><a href="#h88-0-6" id="h88-0-6" class="i">+    val type: DownloadMediaType,
</a><a href="#h88-0-7" id="h88-0-7" class="i">+    val encryption: MediaEncryptionKeyPair? = null,
</a><a href="#h88-0-8" id="h88-0-8" class="i">+    val attachmentType: String? = null,
</a><a href="#h88-0-9" id="h88-0-9" class="i">+    val isOverlay: Boolean = false,
</a><a href="#h88-0-10" id="h88-0-10" class="i">+)
</a><a href="#h88-0-11" id="h88-0-11" class="i">+
</a><a href="#h88-0-12" id="h88-0-12" class="i">+class DownloadRequest(
</a><a href="#h88-0-13" id="h88-0-13" class="i">+    val inputMedias: Array&lt;InputMedia&gt;,
</a><a href="#h88-0-14" id="h88-0-14" class="i">+    val dashOptions: DashOptions? = null,
</a><a href="#h88-0-15" id="h88-0-15" class="i">+    private val flags: Int = 0,
</a><a href="#h88-0-16" id="h88-0-16" class="i">+) {
</a><a href="#h88-0-17" id="h88-0-17" class="i">+    object Flags {
</a><a href="#h88-0-18" id="h88-0-18" class="i">+        const val MERGE_OVERLAY = 1
</a><a href="#h88-0-19" id="h88-0-19" class="i">+        const val IS_DASH_PLAYLIST = 2
</a><a href="#h88-0-20" id="h88-0-20" class="i">+    }
</a><a href="#h88-0-21" id="h88-0-21" class="i">+
</a><a href="#h88-0-22" id="h88-0-22" class="i">+    val isDashPlaylist: Boolean
</a><a href="#h88-0-23" id="h88-0-23" class="i">+        get() = flags and Flags.IS_DASH_PLAYLIST != 0
</a><a href="#h88-0-24" id="h88-0-24" class="i">+
</a><a href="#h88-0-25" id="h88-0-25" class="i">+    val shouldMergeOverlay: Boolean
</a><a href="#h88-0-26" id="h88-0-26" class="i">+        get() = flags and Flags.MERGE_OVERLAY != 0
</a><a href="#h88-0-27" id="h88-0-27" class="i">+}</a><a href="#h88-0-28" id="h88-0-28" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h89" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/data/download/DownloadStage.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/data/download/DownloadStage.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/data/download/DownloadStage.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/data/download/DownloadStage.kt</a></b>
<a href="#h89-0" id="h89-0" class="h">@@ -0,0 +1,14 @@
</a><a href="#h89-0-0" id="h89-0-0" class="i">+package me.rhunk.snapenhance.common.data.download
</a><a href="#h89-0-1" id="h89-0-1" class="i">+
</a><a href="#h89-0-2" id="h89-0-2" class="i">+enum class DownloadStage(
</a><a href="#h89-0-3" id="h89-0-3" class="i">+    val isFinalStage: Boolean = false,
</a><a href="#h89-0-4" id="h89-0-4" class="i">+) {
</a><a href="#h89-0-5" id="h89-0-5" class="i">+    PENDING(false),
</a><a href="#h89-0-6" id="h89-0-6" class="i">+    DOWNLOADING(false),
</a><a href="#h89-0-7" id="h89-0-7" class="i">+    MERGING(false),
</a><a href="#h89-0-8" id="h89-0-8" class="i">+    DOWNLOADED(true),
</a><a href="#h89-0-9" id="h89-0-9" class="i">+    SAVED(true),
</a><a href="#h89-0-10" id="h89-0-10" class="i">+    MERGE_FAILED(true),
</a><a href="#h89-0-11" id="h89-0-11" class="i">+    FAILED(true),
</a><a href="#h89-0-12" id="h89-0-12" class="i">+    CANCELLED(true)
</a><a href="#h89-0-13" id="h89-0-13" class="i">+}</a><a href="#h89-0-14" id="h89-0-14" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h90" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/data/download/MediaDownloadSource.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/data/download/MediaDownloadSource.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/data/download/MediaDownloadSource.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/data/download/MediaDownloadSource.kt</a></b>
<a href="#h90-0" id="h90-0" class="h">@@ -0,0 +1,28 @@
</a><a href="#h90-0-0" id="h90-0-0" class="i">+package me.rhunk.snapenhance.common.data.download
</a><a href="#h90-0-1" id="h90-0-1" class="i">+
</a><a href="#h90-0-2" id="h90-0-2" class="i">+enum class MediaDownloadSource(
</a><a href="#h90-0-3" id="h90-0-3" class="i">+    val key: String,
</a><a href="#h90-0-4" id="h90-0-4" class="i">+    val displayName: String = key,
</a><a href="#h90-0-5" id="h90-0-5" class="i">+    val pathName: String = key,
</a><a href="#h90-0-6" id="h90-0-6" class="i">+    val ignoreFilter: Boolean = false
</a><a href="#h90-0-7" id="h90-0-7" class="i">+) {
</a><a href="#h90-0-8" id="h90-0-8" class="i">+    NONE(&quot;none&quot;, &quot;None&quot;, ignoreFilter = true),
</a><a href="#h90-0-9" id="h90-0-9" class="i">+    PENDING(&quot;pending&quot;, &quot;Pending&quot;, ignoreFilter = true),
</a><a href="#h90-0-10" id="h90-0-10" class="i">+    CHAT_MEDIA(&quot;chat_media&quot;, &quot;Chat Media&quot;, &quot;chat_media&quot;),
</a><a href="#h90-0-11" id="h90-0-11" class="i">+    STORY(&quot;story&quot;, &quot;Story&quot;, &quot;story&quot;),
</a><a href="#h90-0-12" id="h90-0-12" class="i">+    PUBLIC_STORY(&quot;public_story&quot;, &quot;Public Story&quot;, &quot;public_story&quot;),
</a><a href="#h90-0-13" id="h90-0-13" class="i">+    SPOTLIGHT(&quot;spotlight&quot;, &quot;Spotlight&quot;, &quot;spotlight&quot;),
</a><a href="#h90-0-14" id="h90-0-14" class="i">+    PROFILE_PICTURE(&quot;profile_picture&quot;, &quot;Profile Picture&quot;, &quot;profile_picture&quot;);
</a><a href="#h90-0-15" id="h90-0-15" class="i">+
</a><a href="#h90-0-16" id="h90-0-16" class="i">+    fun matches(source: String?): Boolean {
</a><a href="#h90-0-17" id="h90-0-17" class="i">+        if (source == null) return false
</a><a href="#h90-0-18" id="h90-0-18" class="i">+        return source.contains(key, ignoreCase = true)
</a><a href="#h90-0-19" id="h90-0-19" class="i">+    }
</a><a href="#h90-0-20" id="h90-0-20" class="i">+
</a><a href="#h90-0-21" id="h90-0-21" class="i">+    companion object {
</a><a href="#h90-0-22" id="h90-0-22" class="i">+        fun fromKey(key: String?): MediaDownloadSource {
</a><a href="#h90-0-23" id="h90-0-23" class="i">+            if (key == null) return NONE
</a><a href="#h90-0-24" id="h90-0-24" class="i">+            return entries.find { it.key == key } ?: NONE
</a><a href="#h90-0-25" id="h90-0-25" class="i">+        }
</a><a href="#h90-0-26" id="h90-0-26" class="i">+    }
</a><a href="#h90-0-27" id="h90-0-27" class="i">+}</a><a href="#h90-0-28" id="h90-0-28" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h91" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/data/download/MediaEncryptionKeyPair.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/data/download/MediaEncryptionKeyPair.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/data/download/MediaEncryptionKeyPair.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/data/download/MediaEncryptionKeyPair.kt</a></b>
<a href="#h91-0" id="h91-0" class="h">@@ -0,0 +1,26 @@
</a><a href="#h91-0-0" id="h91-0-0" class="i">+@file:OptIn(ExperimentalEncodingApi::class)
</a><a href="#h91-0-1" id="h91-0-1" class="i">+
</a><a href="#h91-0-2" id="h91-0-2" class="i">+package me.rhunk.snapenhance.common.data.download
</a><a href="#h91-0-3" id="h91-0-3" class="i">+
</a><a href="#h91-0-4" id="h91-0-4" class="i">+import java.io.InputStream
</a><a href="#h91-0-5" id="h91-0-5" class="i">+import javax.crypto.Cipher
</a><a href="#h91-0-6" id="h91-0-6" class="i">+import javax.crypto.CipherInputStream
</a><a href="#h91-0-7" id="h91-0-7" class="i">+import javax.crypto.spec.IvParameterSpec
</a><a href="#h91-0-8" id="h91-0-8" class="i">+import javax.crypto.spec.SecretKeySpec
</a><a href="#h91-0-9" id="h91-0-9" class="i">+import kotlin.io.encoding.Base64
</a><a href="#h91-0-10" id="h91-0-10" class="i">+import kotlin.io.encoding.ExperimentalEncodingApi
</a><a href="#h91-0-11" id="h91-0-11" class="i">+
</a><a href="#h91-0-12" id="h91-0-12" class="i">+// key and iv are base64 encoded into url safe strings
</a><a href="#h91-0-13" id="h91-0-13" class="i">+data class MediaEncryptionKeyPair(
</a><a href="#h91-0-14" id="h91-0-14" class="i">+    val key: String,
</a><a href="#h91-0-15" id="h91-0-15" class="i">+    val iv: String
</a><a href="#h91-0-16" id="h91-0-16" class="i">+) {
</a><a href="#h91-0-17" id="h91-0-17" class="i">+    fun decryptInputStream(inputStream: InputStream): InputStream {
</a><a href="#h91-0-18" id="h91-0-18" class="i">+        val cipher = Cipher.getInstance(&quot;AES/CBC/PKCS5Padding&quot;)
</a><a href="#h91-0-19" id="h91-0-19" class="i">+        cipher.init(Cipher.DECRYPT_MODE, SecretKeySpec(Base64.UrlSafe.decode(key), &quot;AES&quot;), IvParameterSpec(Base64.UrlSafe.decode(iv)))
</a><a href="#h91-0-20" id="h91-0-20" class="i">+        return CipherInputStream(inputStream, cipher)
</a><a href="#h91-0-21" id="h91-0-21" class="i">+    }
</a><a href="#h91-0-22" id="h91-0-22" class="i">+}
</a><a href="#h91-0-23" id="h91-0-23" class="i">+
</a><a href="#h91-0-24" id="h91-0-24" class="i">+fun Pair&lt;ByteArray, ByteArray&gt;.toKeyPair()
</a><a href="#h91-0-25" id="h91-0-25" class="i">+    = MediaEncryptionKeyPair(Base64.UrlSafe.encode(this.first), Base64.UrlSafe.encode(this.second))
</a><b>diff --git a/<a id="h92" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/data/download/SplitMediaAssetType.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/data/download/SplitMediaAssetType.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/data/download/SplitMediaAssetType.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/data/download/SplitMediaAssetType.kt</a></b>
<a href="#h92-0" id="h92-0" class="h">@@ -0,0 +1,5 @@
</a><a href="#h92-0-0" id="h92-0-0" class="i">+package me.rhunk.snapenhance.common.data.download
</a><a href="#h92-0-1" id="h92-0-1" class="i">+
</a><a href="#h92-0-2" id="h92-0-2" class="i">+enum class SplitMediaAssetType {
</a><a href="#h92-0-3" id="h92-0-3" class="i">+    ORIGINAL, OVERLAY
</a><a href="#h92-0-4" id="h92-0-4" class="i">+}
</a><b>diff --git a/<a id="h93" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/database/DatabaseObject.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/database/DatabaseObject.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/database/DatabaseObject.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/database/DatabaseObject.kt</a></b>
<a href="#h93-0" id="h93-0" class="h">@@ -0,0 +1,7 @@
</a><a href="#h93-0-0" id="h93-0-0" class="i">+package me.rhunk.snapenhance.common.database
</a><a href="#h93-0-1" id="h93-0-1" class="i">+
</a><a href="#h93-0-2" id="h93-0-2" class="i">+import android.database.Cursor
</a><a href="#h93-0-3" id="h93-0-3" class="i">+
</a><a href="#h93-0-4" id="h93-0-4" class="i">+interface DatabaseObject {
</a><a href="#h93-0-5" id="h93-0-5" class="i">+    fun write(cursor: Cursor)
</a><a href="#h93-0-6" id="h93-0-6" class="i">+}
</a><b>diff --git a/<a id="h94" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/database/impl/ConversationMessage.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/database/impl/ConversationMessage.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/database/impl/ConversationMessage.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/database/impl/ConversationMessage.kt</a></b>
<a href="#h94-0" id="h94-0" class="h">@@ -0,0 +1,40 @@
</a><a href="#h94-0-0" id="h94-0-0" class="i">+package me.rhunk.snapenhance.common.database.impl
</a><a href="#h94-0-1" id="h94-0-1" class="i">+
</a><a href="#h94-0-2" id="h94-0-2" class="i">+import android.annotation.SuppressLint
</a><a href="#h94-0-3" id="h94-0-3" class="i">+import android.database.Cursor
</a><a href="#h94-0-4" id="h94-0-4" class="i">+import me.rhunk.snapenhance.common.database.DatabaseObject
</a><a href="#h94-0-5" id="h94-0-5" class="i">+import me.rhunk.snapenhance.common.util.ktx.getBlobOrNull
</a><a href="#h94-0-6" id="h94-0-6" class="i">+import me.rhunk.snapenhance.common.util.ktx.getInteger
</a><a href="#h94-0-7" id="h94-0-7" class="i">+import me.rhunk.snapenhance.common.util.ktx.getLong
</a><a href="#h94-0-8" id="h94-0-8" class="i">+import me.rhunk.snapenhance.common.util.ktx.getStringOrNull
</a><a href="#h94-0-9" id="h94-0-9" class="i">+
</a><a href="#h94-0-10" id="h94-0-10" class="i">+@Suppress(&quot;ArrayInDataClass&quot;)
</a><a href="#h94-0-11" id="h94-0-11" class="i">+data class ConversationMessage(
</a><a href="#h94-0-12" id="h94-0-12" class="i">+    var clientConversationId: String? = null,
</a><a href="#h94-0-13" id="h94-0-13" class="i">+    var clientMessageId: Int = 0,
</a><a href="#h94-0-14" id="h94-0-14" class="i">+    var serverMessageId: Int = 0,
</a><a href="#h94-0-15" id="h94-0-15" class="i">+    var messageContent: ByteArray? = null,
</a><a href="#h94-0-16" id="h94-0-16" class="i">+    var isSaved: Int = 0,
</a><a href="#h94-0-17" id="h94-0-17" class="i">+    var isViewedByUser: Int = 0,
</a><a href="#h94-0-18" id="h94-0-18" class="i">+    var contentType: Int = 0,
</a><a href="#h94-0-19" id="h94-0-19" class="i">+    var creationTimestamp: Long = 0,
</a><a href="#h94-0-20" id="h94-0-20" class="i">+    var readTimestamp: Long = 0,
</a><a href="#h94-0-21" id="h94-0-21" class="i">+    var senderId: String? = null
</a><a href="#h94-0-22" id="h94-0-22" class="i">+) : DatabaseObject {
</a><a href="#h94-0-23" id="h94-0-23" class="i">+
</a><a href="#h94-0-24" id="h94-0-24" class="i">+    @SuppressLint(&quot;Range&quot;)
</a><a href="#h94-0-25" id="h94-0-25" class="i">+    override fun write(cursor: Cursor) {
</a><a href="#h94-0-26" id="h94-0-26" class="i">+        with(cursor) {
</a><a href="#h94-0-27" id="h94-0-27" class="i">+            clientConversationId = getStringOrNull(&quot;client_conversation_id&quot;)
</a><a href="#h94-0-28" id="h94-0-28" class="i">+            clientMessageId = getInteger(&quot;client_message_id&quot;)
</a><a href="#h94-0-29" id="h94-0-29" class="i">+            serverMessageId = getInteger(&quot;server_message_id&quot;)
</a><a href="#h94-0-30" id="h94-0-30" class="i">+            messageContent = getBlobOrNull(&quot;message_content&quot;)
</a><a href="#h94-0-31" id="h94-0-31" class="i">+            isSaved = getInteger(&quot;is_saved&quot;)
</a><a href="#h94-0-32" id="h94-0-32" class="i">+            isViewedByUser = getInteger(&quot;is_viewed_by_user&quot;)
</a><a href="#h94-0-33" id="h94-0-33" class="i">+            contentType = getInteger(&quot;content_type&quot;)
</a><a href="#h94-0-34" id="h94-0-34" class="i">+            creationTimestamp = getLong(&quot;creation_timestamp&quot;)
</a><a href="#h94-0-35" id="h94-0-35" class="i">+            readTimestamp = getLong(&quot;read_timestamp&quot;)
</a><a href="#h94-0-36" id="h94-0-36" class="i">+            senderId = getStringOrNull(&quot;sender_id&quot;)
</a><a href="#h94-0-37" id="h94-0-37" class="i">+        }
</a><a href="#h94-0-38" id="h94-0-38" class="i">+    }
</a><a href="#h94-0-39" id="h94-0-39" class="i">+}
</a><b>diff --git a/<a id="h95" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/database/impl/FriendFeedEntry.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/database/impl/FriendFeedEntry.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/database/impl/FriendFeedEntry.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/database/impl/FriendFeedEntry.kt</a></b>
<a href="#h95-0" id="h95-0" class="h">@@ -0,0 +1,47 @@
</a><a href="#h95-0-0" id="h95-0-0" class="i">+package me.rhunk.snapenhance.common.database.impl
</a><a href="#h95-0-1" id="h95-0-1" class="i">+
</a><a href="#h95-0-2" id="h95-0-2" class="i">+import android.annotation.SuppressLint
</a><a href="#h95-0-3" id="h95-0-3" class="i">+import android.database.Cursor
</a><a href="#h95-0-4" id="h95-0-4" class="i">+import me.rhunk.snapenhance.common.database.DatabaseObject
</a><a href="#h95-0-5" id="h95-0-5" class="i">+import me.rhunk.snapenhance.common.util.ktx.getIntOrNull
</a><a href="#h95-0-6" id="h95-0-6" class="i">+import me.rhunk.snapenhance.common.util.ktx.getInteger
</a><a href="#h95-0-7" id="h95-0-7" class="i">+import me.rhunk.snapenhance.common.util.ktx.getLong
</a><a href="#h95-0-8" id="h95-0-8" class="i">+import me.rhunk.snapenhance.common.util.ktx.getStringOrNull
</a><a href="#h95-0-9" id="h95-0-9" class="i">+
</a><a href="#h95-0-10" id="h95-0-10" class="i">+data class FriendFeedEntry(
</a><a href="#h95-0-11" id="h95-0-11" class="i">+    var id: Int = 0,
</a><a href="#h95-0-12" id="h95-0-12" class="i">+    var feedDisplayName: String? = null,
</a><a href="#h95-0-13" id="h95-0-13" class="i">+    var participantsSize: Int = 0,
</a><a href="#h95-0-14" id="h95-0-14" class="i">+    var lastInteractionTimestamp: Long = 0,
</a><a href="#h95-0-15" id="h95-0-15" class="i">+    var displayTimestamp: Long = 0,
</a><a href="#h95-0-16" id="h95-0-16" class="i">+    var displayInteractionType: String? = null,
</a><a href="#h95-0-17" id="h95-0-17" class="i">+    var lastInteractionUserId: Int? = null,
</a><a href="#h95-0-18" id="h95-0-18" class="i">+    var key: String? = null,
</a><a href="#h95-0-19" id="h95-0-19" class="i">+    var friendUserId: String? = null,
</a><a href="#h95-0-20" id="h95-0-20" class="i">+    var friendDisplayName: String? = null,
</a><a href="#h95-0-21" id="h95-0-21" class="i">+    var friendDisplayUsername: String? = null,
</a><a href="#h95-0-22" id="h95-0-22" class="i">+    var friendLinkType: Int? = null,
</a><a href="#h95-0-23" id="h95-0-23" class="i">+    var bitmojiAvatarId: String? = null,
</a><a href="#h95-0-24" id="h95-0-24" class="i">+    var bitmojiSelfieId: String? = null,
</a><a href="#h95-0-25" id="h95-0-25" class="i">+) : DatabaseObject {
</a><a href="#h95-0-26" id="h95-0-26" class="i">+
</a><a href="#h95-0-27" id="h95-0-27" class="i">+    @SuppressLint(&quot;Range&quot;)
</a><a href="#h95-0-28" id="h95-0-28" class="i">+    override fun write(cursor: Cursor) {
</a><a href="#h95-0-29" id="h95-0-29" class="i">+        with(cursor) {
</a><a href="#h95-0-30" id="h95-0-30" class="i">+            id = getInteger(&quot;_id&quot;)
</a><a href="#h95-0-31" id="h95-0-31" class="i">+            feedDisplayName = getStringOrNull(&quot;feedDisplayName&quot;)
</a><a href="#h95-0-32" id="h95-0-32" class="i">+            participantsSize = getInteger(&quot;participantsSize&quot;)
</a><a href="#h95-0-33" id="h95-0-33" class="i">+            lastInteractionTimestamp = getLong(&quot;lastInteractionTimestamp&quot;)
</a><a href="#h95-0-34" id="h95-0-34" class="i">+            displayTimestamp = getLong(&quot;displayTimestamp&quot;)
</a><a href="#h95-0-35" id="h95-0-35" class="i">+            displayInteractionType = getStringOrNull(&quot;displayInteractionType&quot;)
</a><a href="#h95-0-36" id="h95-0-36" class="i">+            lastInteractionUserId = getIntOrNull(&quot;lastInteractionUserId&quot;)
</a><a href="#h95-0-37" id="h95-0-37" class="i">+            key = getStringOrNull(&quot;key&quot;)
</a><a href="#h95-0-38" id="h95-0-38" class="i">+            friendUserId = getStringOrNull(&quot;friendUserId&quot;)
</a><a href="#h95-0-39" id="h95-0-39" class="i">+            friendDisplayName = getStringOrNull(&quot;friendDisplayName&quot;)
</a><a href="#h95-0-40" id="h95-0-40" class="i">+            friendDisplayUsername = getStringOrNull(&quot;friendDisplayUsername&quot;)
</a><a href="#h95-0-41" id="h95-0-41" class="i">+            friendLinkType = getIntOrNull(&quot;friendLinkType&quot;)
</a><a href="#h95-0-42" id="h95-0-42" class="i">+            bitmojiAvatarId = getStringOrNull(&quot;bitmojiAvatarId&quot;)
</a><a href="#h95-0-43" id="h95-0-43" class="i">+            bitmojiSelfieId = getStringOrNull(&quot;bitmojiSelfieId&quot;)
</a><a href="#h95-0-44" id="h95-0-44" class="i">+        }
</a><a href="#h95-0-45" id="h95-0-45" class="i">+    }
</a><a href="#h95-0-46" id="h95-0-46" class="i">+}
</a><b>diff --git a/<a id="h96" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/database/impl/FriendInfo.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/database/impl/FriendInfo.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/database/impl/FriendInfo.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/database/impl/FriendInfo.kt</a></b>
<a href="#h96-0" id="h96-0" class="h">@@ -0,0 +1,72 @@
</a><a href="#h96-0-0" id="h96-0-0" class="i">+package me.rhunk.snapenhance.common.database.impl
</a><a href="#h96-0-1" id="h96-0-1" class="i">+
</a><a href="#h96-0-2" id="h96-0-2" class="i">+import android.annotation.SuppressLint
</a><a href="#h96-0-3" id="h96-0-3" class="i">+import android.database.Cursor
</a><a href="#h96-0-4" id="h96-0-4" class="i">+import me.rhunk.snapenhance.common.database.DatabaseObject
</a><a href="#h96-0-5" id="h96-0-5" class="i">+import me.rhunk.snapenhance.common.util.SerializableDataObject
</a><a href="#h96-0-6" id="h96-0-6" class="i">+import me.rhunk.snapenhance.common.util.ktx.getInteger
</a><a href="#h96-0-7" id="h96-0-7" class="i">+import me.rhunk.snapenhance.common.util.ktx.getLong
</a><a href="#h96-0-8" id="h96-0-8" class="i">+import me.rhunk.snapenhance.common.util.ktx.getStringOrNull
</a><a href="#h96-0-9" id="h96-0-9" class="i">+
</a><a href="#h96-0-10" id="h96-0-10" class="i">+data class FriendInfo(
</a><a href="#h96-0-11" id="h96-0-11" class="i">+    var id: Int = 0,
</a><a href="#h96-0-12" id="h96-0-12" class="i">+    var lastModifiedTimestamp: Long = 0,
</a><a href="#h96-0-13" id="h96-0-13" class="i">+    var username: String? = null,
</a><a href="#h96-0-14" id="h96-0-14" class="i">+    var userId: String? = null,
</a><a href="#h96-0-15" id="h96-0-15" class="i">+    var displayName: String? = null,
</a><a href="#h96-0-16" id="h96-0-16" class="i">+    var bitmojiAvatarId: String? = null,
</a><a href="#h96-0-17" id="h96-0-17" class="i">+    var bitmojiSelfieId: String? = null,
</a><a href="#h96-0-18" id="h96-0-18" class="i">+    var bitmojiSceneId: String? = null,
</a><a href="#h96-0-19" id="h96-0-19" class="i">+    var bitmojiBackgroundId: String? = null,
</a><a href="#h96-0-20" id="h96-0-20" class="i">+    var friendmojis: String? = null,
</a><a href="#h96-0-21" id="h96-0-21" class="i">+    var friendmojiCategories: String? = null,
</a><a href="#h96-0-22" id="h96-0-22" class="i">+    var snapScore: Int = 0,
</a><a href="#h96-0-23" id="h96-0-23" class="i">+    var birthday: Long = 0,
</a><a href="#h96-0-24" id="h96-0-24" class="i">+    var addedTimestamp: Long = 0,
</a><a href="#h96-0-25" id="h96-0-25" class="i">+    var reverseAddedTimestamp: Long = 0,
</a><a href="#h96-0-26" id="h96-0-26" class="i">+    var serverDisplayName: String? = null,
</a><a href="#h96-0-27" id="h96-0-27" class="i">+    var streakLength: Int = 0,
</a><a href="#h96-0-28" id="h96-0-28" class="i">+    var streakExpirationTimestamp: Long = 0,
</a><a href="#h96-0-29" id="h96-0-29" class="i">+    var reverseBestFriendRanking: Int = 0,
</a><a href="#h96-0-30" id="h96-0-30" class="i">+    var isPinnedBestFriend: Int = 0,
</a><a href="#h96-0-31" id="h96-0-31" class="i">+    var plusBadgeVisibility: Int = 0,
</a><a href="#h96-0-32" id="h96-0-32" class="i">+    var usernameForSorting: String? = null,
</a><a href="#h96-0-33" id="h96-0-33" class="i">+    var friendLinkType: Int = 0,
</a><a href="#h96-0-34" id="h96-0-34" class="i">+    var postViewEmoji: String? = null,
</a><a href="#h96-0-35" id="h96-0-35" class="i">+) : DatabaseObject, SerializableDataObject() {
</a><a href="#h96-0-36" id="h96-0-36" class="i">+    val mutableUsername get() = username?.split(&quot;|&quot;)?.last()
</a><a href="#h96-0-37" id="h96-0-37" class="i">+    val firstCreatedUsername get() = username?.split(&quot;|&quot;)?.first()
</a><a href="#h96-0-38" id="h96-0-38" class="i">+
</a><a href="#h96-0-39" id="h96-0-39" class="i">+    @SuppressLint(&quot;Range&quot;)
</a><a href="#h96-0-40" id="h96-0-40" class="i">+    override fun write(cursor: Cursor) {
</a><a href="#h96-0-41" id="h96-0-41" class="i">+        with(cursor) {
</a><a href="#h96-0-42" id="h96-0-42" class="i">+            id = getInteger(&quot;_id&quot;)
</a><a href="#h96-0-43" id="h96-0-43" class="i">+            lastModifiedTimestamp = getLong(&quot;_lastModifiedTimestamp&quot;)
</a><a href="#h96-0-44" id="h96-0-44" class="i">+            username = getStringOrNull(&quot;username&quot;)
</a><a href="#h96-0-45" id="h96-0-45" class="i">+            userId = getStringOrNull(&quot;userId&quot;)
</a><a href="#h96-0-46" id="h96-0-46" class="i">+            displayName = getStringOrNull(&quot;displayName&quot;)
</a><a href="#h96-0-47" id="h96-0-47" class="i">+            bitmojiAvatarId = getStringOrNull(&quot;bitmojiAvatarId&quot;)
</a><a href="#h96-0-48" id="h96-0-48" class="i">+            bitmojiSelfieId = getStringOrNull(&quot;bitmojiSelfieId&quot;)
</a><a href="#h96-0-49" id="h96-0-49" class="i">+            bitmojiSceneId = getStringOrNull(&quot;bitmojiSceneId&quot;)
</a><a href="#h96-0-50" id="h96-0-50" class="i">+            bitmojiBackgroundId = getStringOrNull(&quot;bitmojiBackgroundId&quot;)
</a><a href="#h96-0-51" id="h96-0-51" class="i">+            friendmojis = getStringOrNull(&quot;friendmojis&quot;)
</a><a href="#h96-0-52" id="h96-0-52" class="i">+            friendmojiCategories = getStringOrNull(&quot;friendmojiCategories&quot;)
</a><a href="#h96-0-53" id="h96-0-53" class="i">+            snapScore = getInteger(&quot;score&quot;)
</a><a href="#h96-0-54" id="h96-0-54" class="i">+            birthday = getLong(&quot;birthday&quot;)
</a><a href="#h96-0-55" id="h96-0-55" class="i">+            addedTimestamp = getLong(&quot;addedTimestamp&quot;)
</a><a href="#h96-0-56" id="h96-0-56" class="i">+            reverseAddedTimestamp = getLong(&quot;reverseAddedTimestamp&quot;)
</a><a href="#h96-0-57" id="h96-0-57" class="i">+            serverDisplayName = getStringOrNull(&quot;serverDisplayName&quot;)
</a><a href="#h96-0-58" id="h96-0-58" class="i">+            streakLength = getInteger(&quot;streakLength&quot;)
</a><a href="#h96-0-59" id="h96-0-59" class="i">+            streakExpirationTimestamp = getLong(&quot;streakExpiration&quot;)
</a><a href="#h96-0-60" id="h96-0-60" class="i">+            reverseBestFriendRanking = getInteger(&quot;reverseBestFriendRanking&quot;)
</a><a href="#h96-0-61" id="h96-0-61" class="i">+            usernameForSorting = getStringOrNull(&quot;usernameForSorting&quot;)
</a><a href="#h96-0-62" id="h96-0-62" class="i">+            friendLinkType = getInteger(&quot;friendLinkType&quot;)
</a><a href="#h96-0-63" id="h96-0-63" class="i">+            postViewEmoji = getStringOrNull(&quot;postViewEmoji&quot;)
</a><a href="#h96-0-64" id="h96-0-64" class="i">+            if (getColumnIndex(&quot;isPinnedBestFriend&quot;) != -1) isPinnedBestFriend =
</a><a href="#h96-0-65" id="h96-0-65" class="i">+                getInteger(&quot;isPinnedBestFriend&quot;)
</a><a href="#h96-0-66" id="h96-0-66" class="i">+            if (getColumnIndex(&quot;plusBadgeVisibility&quot;) != -1) plusBadgeVisibility =
</a><a href="#h96-0-67" id="h96-0-67" class="i">+                getInteger(&quot;plusBadgeVisibility&quot;)
</a><a href="#h96-0-68" id="h96-0-68" class="i">+        }
</a><a href="#h96-0-69" id="h96-0-69" class="i">+    }
</a><a href="#h96-0-70" id="h96-0-70" class="i">+
</a><a href="#h96-0-71" id="h96-0-71" class="i">+}
</a><b>diff --git a/<a id="h97" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/database/impl/StoryEntry.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/database/impl/StoryEntry.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/database/impl/StoryEntry.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/database/impl/StoryEntry.kt</a></b>
<a href="#h97-0" id="h97-0" class="h">@@ -0,0 +1,27 @@
</a><a href="#h97-0-0" id="h97-0-0" class="i">+package me.rhunk.snapenhance.common.database.impl
</a><a href="#h97-0-1" id="h97-0-1" class="i">+
</a><a href="#h97-0-2" id="h97-0-2" class="i">+import android.annotation.SuppressLint
</a><a href="#h97-0-3" id="h97-0-3" class="i">+import android.database.Cursor
</a><a href="#h97-0-4" id="h97-0-4" class="i">+import me.rhunk.snapenhance.common.database.DatabaseObject
</a><a href="#h97-0-5" id="h97-0-5" class="i">+import me.rhunk.snapenhance.common.util.ktx.getInteger
</a><a href="#h97-0-6" id="h97-0-6" class="i">+import me.rhunk.snapenhance.common.util.ktx.getStringOrNull
</a><a href="#h97-0-7" id="h97-0-7" class="i">+
</a><a href="#h97-0-8" id="h97-0-8" class="i">+data class StoryEntry(
</a><a href="#h97-0-9" id="h97-0-9" class="i">+    var id: Int = 0,
</a><a href="#h97-0-10" id="h97-0-10" class="i">+    var storyId: String? = null,
</a><a href="#h97-0-11" id="h97-0-11" class="i">+    var displayName: String? = null,
</a><a href="#h97-0-12" id="h97-0-12" class="i">+    var isLocal: Boolean? = null,
</a><a href="#h97-0-13" id="h97-0-13" class="i">+    var userId: String? = null
</a><a href="#h97-0-14" id="h97-0-14" class="i">+) : DatabaseObject {
</a><a href="#h97-0-15" id="h97-0-15" class="i">+
</a><a href="#h97-0-16" id="h97-0-16" class="i">+    @SuppressLint(&quot;Range&quot;)
</a><a href="#h97-0-17" id="h97-0-17" class="i">+    override fun write(cursor: Cursor) {
</a><a href="#h97-0-18" id="h97-0-18" class="i">+        with(cursor) {
</a><a href="#h97-0-19" id="h97-0-19" class="i">+            id = getInteger(&quot;_id&quot;)
</a><a href="#h97-0-20" id="h97-0-20" class="i">+            storyId = getStringOrNull(&quot;storyId&quot;)
</a><a href="#h97-0-21" id="h97-0-21" class="i">+            displayName = getStringOrNull(&quot;displayName&quot;)
</a><a href="#h97-0-22" id="h97-0-22" class="i">+            isLocal = getInteger(&quot;isLocal&quot;) == 1
</a><a href="#h97-0-23" id="h97-0-23" class="i">+            userId = getStringOrNull(&quot;userId&quot;)
</a><a href="#h97-0-24" id="h97-0-24" class="i">+        }
</a><a href="#h97-0-25" id="h97-0-25" class="i">+    }
</a><a href="#h97-0-26" id="h97-0-26" class="i">+}
</a><b>diff --git a/<a id="h98" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/database/impl/UserConversationLink.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/database/impl/UserConversationLink.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/database/impl/UserConversationLink.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/database/impl/UserConversationLink.kt</a></b>
<a href="#h98-0" id="h98-0" class="h">@@ -0,0 +1,23 @@
</a><a href="#h98-0-0" id="h98-0-0" class="i">+package me.rhunk.snapenhance.common.database.impl
</a><a href="#h98-0-1" id="h98-0-1" class="i">+
</a><a href="#h98-0-2" id="h98-0-2" class="i">+import android.annotation.SuppressLint
</a><a href="#h98-0-3" id="h98-0-3" class="i">+import android.database.Cursor
</a><a href="#h98-0-4" id="h98-0-4" class="i">+import me.rhunk.snapenhance.common.database.DatabaseObject
</a><a href="#h98-0-5" id="h98-0-5" class="i">+import me.rhunk.snapenhance.common.util.ktx.getInteger
</a><a href="#h98-0-6" id="h98-0-6" class="i">+import me.rhunk.snapenhance.common.util.ktx.getStringOrNull
</a><a href="#h98-0-7" id="h98-0-7" class="i">+
</a><a href="#h98-0-8" id="h98-0-8" class="i">+class UserConversationLink(
</a><a href="#h98-0-9" id="h98-0-9" class="i">+    var userId: String? = null,
</a><a href="#h98-0-10" id="h98-0-10" class="i">+    var clientConversationId: String? = null,
</a><a href="#h98-0-11" id="h98-0-11" class="i">+    var conversationType: Int = 0
</a><a href="#h98-0-12" id="h98-0-12" class="i">+) : DatabaseObject {
</a><a href="#h98-0-13" id="h98-0-13" class="i">+
</a><a href="#h98-0-14" id="h98-0-14" class="i">+    @SuppressLint(&quot;Range&quot;)
</a><a href="#h98-0-15" id="h98-0-15" class="i">+    override fun write(cursor: Cursor) {
</a><a href="#h98-0-16" id="h98-0-16" class="i">+        with(cursor) {
</a><a href="#h98-0-17" id="h98-0-17" class="i">+            userId = getStringOrNull(&quot;user_id&quot;)
</a><a href="#h98-0-18" id="h98-0-18" class="i">+            clientConversationId = getStringOrNull(&quot;client_conversation_id&quot;)
</a><a href="#h98-0-19" id="h98-0-19" class="i">+            conversationType = getInteger(&quot;conversation_type&quot;)
</a><a href="#h98-0-20" id="h98-0-20" class="i">+        }
</a><a href="#h98-0-21" id="h98-0-21" class="i">+    }
</a><a href="#h98-0-22" id="h98-0-22" class="i">+}
</a><b>diff --git a/<a id="h99" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/logger/AbstractLogger.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/logger/AbstractLogger.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/logger/AbstractLogger.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/logger/AbstractLogger.kt</a></b>
<a href="#h99-0" id="h99-0" class="h">@@ -0,0 +1,38 @@
</a><a href="#h99-0-0" id="h99-0-0" class="i">+package me.rhunk.snapenhance.common.logger
</a><a href="#h99-0-1" id="h99-0-1" class="i">+
</a><a href="#h99-0-2" id="h99-0-2" class="i">+import android.util.Log
</a><a href="#h99-0-3" id="h99-0-3" class="i">+
</a><a href="#h99-0-4" id="h99-0-4" class="i">+abstract class AbstractLogger(
</a><a href="#h99-0-5" id="h99-0-5" class="i">+    logChannel: LogChannel,
</a><a href="#h99-0-6" id="h99-0-6" class="i">+) {
</a><a href="#h99-0-7" id="h99-0-7" class="i">+    private val TAG = logChannel.shortName
</a><a href="#h99-0-8" id="h99-0-8" class="i">+
</a><a href="#h99-0-9" id="h99-0-9" class="i">+    companion object {
</a><a href="#h99-0-10" id="h99-0-10" class="i">+
</a><a href="#h99-0-11" id="h99-0-11" class="i">+        private const val TAG = &quot;SnapEnhanceCommon&quot;
</a><a href="#h99-0-12" id="h99-0-12" class="i">+
</a><a href="#h99-0-13" id="h99-0-13" class="i">+        fun directDebug(message: Any?, tag: String = TAG) {
</a><a href="#h99-0-14" id="h99-0-14" class="i">+            Log.println(Log.DEBUG, tag, message.toString())
</a><a href="#h99-0-15" id="h99-0-15" class="i">+        }
</a><a href="#h99-0-16" id="h99-0-16" class="i">+
</a><a href="#h99-0-17" id="h99-0-17" class="i">+        fun directError(message: Any?, throwable: Throwable, tag: String = TAG) {
</a><a href="#h99-0-18" id="h99-0-18" class="i">+            Log.println(Log.ERROR, tag, message.toString())
</a><a href="#h99-0-19" id="h99-0-19" class="i">+            Log.println(Log.ERROR, tag, throwable.toString())
</a><a href="#h99-0-20" id="h99-0-20" class="i">+        }
</a><a href="#h99-0-21" id="h99-0-21" class="i">+
</a><a href="#h99-0-22" id="h99-0-22" class="i">+    }
</a><a href="#h99-0-23" id="h99-0-23" class="i">+
</a><a href="#h99-0-24" id="h99-0-24" class="i">+    open fun debug(message: Any?, tag: String = TAG) {}
</a><a href="#h99-0-25" id="h99-0-25" class="i">+
</a><a href="#h99-0-26" id="h99-0-26" class="i">+    open fun error(message: Any?, tag: String = TAG) {}
</a><a href="#h99-0-27" id="h99-0-27" class="i">+
</a><a href="#h99-0-28" id="h99-0-28" class="i">+    open fun error(message: Any?, throwable: Throwable, tag: String = TAG) {}
</a><a href="#h99-0-29" id="h99-0-29" class="i">+
</a><a href="#h99-0-30" id="h99-0-30" class="i">+    open fun info(message: Any?, tag: String = TAG) {}
</a><a href="#h99-0-31" id="h99-0-31" class="i">+
</a><a href="#h99-0-32" id="h99-0-32" class="i">+    open fun verbose(message: Any?, tag: String = TAG) {}
</a><a href="#h99-0-33" id="h99-0-33" class="i">+
</a><a href="#h99-0-34" id="h99-0-34" class="i">+    open fun warn(message: Any?, tag: String = TAG) {}
</a><a href="#h99-0-35" id="h99-0-35" class="i">+
</a><a href="#h99-0-36" id="h99-0-36" class="i">+    open fun assert(message: Any?, tag: String = TAG) {}
</a><a href="#h99-0-37" id="h99-0-37" class="i">+}</a><a href="#h99-0-38" id="h99-0-38" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h100" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/logger/LogChannel.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/logger/LogChannel.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/logger/LogChannel.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/logger/LogChannel.kt</a></b>
<a href="#h100-0" id="h100-0" class="h">@@ -0,0 +1,17 @@
</a><a href="#h100-0-0" id="h100-0-0" class="i">+package me.rhunk.snapenhance.common.logger
</a><a href="#h100-0-1" id="h100-0-1" class="i">+
</a><a href="#h100-0-2" id="h100-0-2" class="i">+enum class LogChannel(
</a><a href="#h100-0-3" id="h100-0-3" class="i">+    val channel: String,
</a><a href="#h100-0-4" id="h100-0-4" class="i">+    val shortName: String
</a><a href="#h100-0-5" id="h100-0-5" class="i">+) {
</a><a href="#h100-0-6" id="h100-0-6" class="i">+    CORE(&quot;SnapEnhanceCore&quot;, &quot;core&quot;),
</a><a href="#h100-0-7" id="h100-0-7" class="i">+    NATIVE(&quot;SnapEnhanceNative&quot;, &quot;native&quot;),
</a><a href="#h100-0-8" id="h100-0-8" class="i">+    MANAGER(&quot;SnapEnhanceManager&quot;, &quot;manager&quot;),
</a><a href="#h100-0-9" id="h100-0-9" class="i">+    XPOSED(&quot;LSPosed-Bridge&quot;, &quot;xposed&quot;);
</a><a href="#h100-0-10" id="h100-0-10" class="i">+
</a><a href="#h100-0-11" id="h100-0-11" class="i">+    companion object {
</a><a href="#h100-0-12" id="h100-0-12" class="i">+        fun fromChannel(channel: String): LogChannel? {
</a><a href="#h100-0-13" id="h100-0-13" class="i">+            return entries.find { it.channel == channel }
</a><a href="#h100-0-14" id="h100-0-14" class="i">+        }
</a><a href="#h100-0-15" id="h100-0-15" class="i">+    }
</a><a href="#h100-0-16" id="h100-0-16" class="i">+}</a><a href="#h100-0-17" id="h100-0-17" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h101" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/logger/LogLevel.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/logger/LogLevel.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/logger/LogLevel.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/logger/LogLevel.kt</a></b>
<a href="#h101-0" id="h101-0" class="h">@@ -0,0 +1,30 @@
</a><a href="#h101-0-0" id="h101-0-0" class="i">+package me.rhunk.snapenhance.common.logger
</a><a href="#h101-0-1" id="h101-0-1" class="i">+
</a><a href="#h101-0-2" id="h101-0-2" class="i">+import android.util.Log
</a><a href="#h101-0-3" id="h101-0-3" class="i">+
</a><a href="#h101-0-4" id="h101-0-4" class="i">+enum class LogLevel(
</a><a href="#h101-0-5" id="h101-0-5" class="i">+    val letter: String,
</a><a href="#h101-0-6" id="h101-0-6" class="i">+    val shortName: String,
</a><a href="#h101-0-7" id="h101-0-7" class="i">+    val priority: Int = Log.INFO
</a><a href="#h101-0-8" id="h101-0-8" class="i">+) {
</a><a href="#h101-0-9" id="h101-0-9" class="i">+    VERBOSE(&quot;V&quot;, &quot;verbose&quot;, Log.VERBOSE),
</a><a href="#h101-0-10" id="h101-0-10" class="i">+    DEBUG(&quot;D&quot;, &quot;debug&quot;, Log.DEBUG),
</a><a href="#h101-0-11" id="h101-0-11" class="i">+    INFO(&quot;I&quot;, &quot;info&quot;, Log.INFO),
</a><a href="#h101-0-12" id="h101-0-12" class="i">+    WARN(&quot;W&quot;, &quot;warn&quot;, Log.WARN),
</a><a href="#h101-0-13" id="h101-0-13" class="i">+    ERROR(&quot;E&quot;, &quot;error&quot;, Log.ERROR),
</a><a href="#h101-0-14" id="h101-0-14" class="i">+    ASSERT(&quot;A&quot;, &quot;assert&quot;, Log.ASSERT);
</a><a href="#h101-0-15" id="h101-0-15" class="i">+
</a><a href="#h101-0-16" id="h101-0-16" class="i">+    companion object {
</a><a href="#h101-0-17" id="h101-0-17" class="i">+        fun fromLetter(letter: String): LogLevel? {
</a><a href="#h101-0-18" id="h101-0-18" class="i">+            return entries.find { it.letter == letter }
</a><a href="#h101-0-19" id="h101-0-19" class="i">+        }
</a><a href="#h101-0-20" id="h101-0-20" class="i">+
</a><a href="#h101-0-21" id="h101-0-21" class="i">+        fun fromShortName(shortName: String): LogLevel? {
</a><a href="#h101-0-22" id="h101-0-22" class="i">+            return entries.find { it.shortName == shortName }
</a><a href="#h101-0-23" id="h101-0-23" class="i">+        }
</a><a href="#h101-0-24" id="h101-0-24" class="i">+
</a><a href="#h101-0-25" id="h101-0-25" class="i">+        fun fromPriority(priority: Int): LogLevel? {
</a><a href="#h101-0-26" id="h101-0-26" class="i">+            return entries.find { it.priority == priority }
</a><a href="#h101-0-27" id="h101-0-27" class="i">+        }
</a><a href="#h101-0-28" id="h101-0-28" class="i">+    }
</a><a href="#h101-0-29" id="h101-0-29" class="i">+}</a><a href="#h101-0-30" id="h101-0-30" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h102" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/IPCInterface.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/IPCInterface.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/IPCInterface.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/IPCInterface.kt</a></b>
<a href="#h102-0" id="h102-0" class="h">@@ -0,0 +1,17 @@
</a><a href="#h102-0-0" id="h102-0-0" class="i">+package me.rhunk.snapenhance.common.scripting
</a><a href="#h102-0-1" id="h102-0-1" class="i">+
</a><a href="#h102-0-2" id="h102-0-2" class="i">+typealias Listener = (Array&lt;out String?&gt;) -&gt; Unit
</a><a href="#h102-0-3" id="h102-0-3" class="i">+
</a><a href="#h102-0-4" id="h102-0-4" class="i">+abstract class IPCInterface {
</a><a href="#h102-0-5" id="h102-0-5" class="i">+    abstract fun on(eventName: String, listener: Listener)
</a><a href="#h102-0-6" id="h102-0-6" class="i">+
</a><a href="#h102-0-7" id="h102-0-7" class="i">+    abstract fun onBroadcast(channel: String, eventName: String, listener: Listener)
</a><a href="#h102-0-8" id="h102-0-8" class="i">+
</a><a href="#h102-0-9" id="h102-0-9" class="i">+    abstract fun emit(eventName: String, vararg args: String?)
</a><a href="#h102-0-10" id="h102-0-10" class="i">+    abstract fun broadcast(channel: String, eventName: String, vararg args: String?)
</a><a href="#h102-0-11" id="h102-0-11" class="i">+
</a><a href="#h102-0-12" id="h102-0-12" class="i">+    @Suppress(&quot;unused&quot;)
</a><a href="#h102-0-13" id="h102-0-13" class="i">+    fun emit(eventName: String) = emit(eventName, *emptyArray())
</a><a href="#h102-0-14" id="h102-0-14" class="i">+    @Suppress(&quot;unused&quot;)
</a><a href="#h102-0-15" id="h102-0-15" class="i">+    fun emit(channel: String, eventName: String) = broadcast(channel, eventName)
</a><a href="#h102-0-16" id="h102-0-16" class="i">+}</a><a href="#h102-0-17" id="h102-0-17" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h103" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/JSModule.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/JSModule.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/JSModule.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/JSModule.kt</a></b>
<a href="#h103-0" id="h103-0" class="h">@@ -0,0 +1,134 @@
</a><a href="#h103-0-0" id="h103-0-0" class="i">+package me.rhunk.snapenhance.common.scripting
</a><a href="#h103-0-1" id="h103-0-1" class="i">+
</a><a href="#h103-0-2" id="h103-0-2" class="i">+import android.os.Handler
</a><a href="#h103-0-3" id="h103-0-3" class="i">+import android.widget.Toast
</a><a href="#h103-0-4" id="h103-0-4" class="i">+import me.rhunk.snapenhance.common.scripting.ktx.contextScope
</a><a href="#h103-0-5" id="h103-0-5" class="i">+import me.rhunk.snapenhance.common.scripting.ktx.putFunction
</a><a href="#h103-0-6" id="h103-0-6" class="i">+import me.rhunk.snapenhance.common.scripting.ktx.scriptableObject
</a><a href="#h103-0-7" id="h103-0-7" class="i">+import me.rhunk.snapenhance.common.scripting.type.ModuleInfo
</a><a href="#h103-0-8" id="h103-0-8" class="i">+import org.mozilla.javascript.Function
</a><a href="#h103-0-9" id="h103-0-9" class="i">+import org.mozilla.javascript.NativeJavaObject
</a><a href="#h103-0-10" id="h103-0-10" class="i">+import org.mozilla.javascript.ScriptableObject
</a><a href="#h103-0-11" id="h103-0-11" class="i">+import org.mozilla.javascript.Undefined
</a><a href="#h103-0-12" id="h103-0-12" class="i">+import org.mozilla.javascript.Wrapper
</a><a href="#h103-0-13" id="h103-0-13" class="i">+import java.lang.reflect.Modifier
</a><a href="#h103-0-14" id="h103-0-14" class="i">+
</a><a href="#h103-0-15" id="h103-0-15" class="i">+class JSModule(
</a><a href="#h103-0-16" id="h103-0-16" class="i">+    val scriptRuntime: ScriptRuntime,
</a><a href="#h103-0-17" id="h103-0-17" class="i">+    val moduleInfo: ModuleInfo,
</a><a href="#h103-0-18" id="h103-0-18" class="i">+    val content: String,
</a><a href="#h103-0-19" id="h103-0-19" class="i">+) {
</a><a href="#h103-0-20" id="h103-0-20" class="i">+    private lateinit var moduleObject: ScriptableObject
</a><a href="#h103-0-21" id="h103-0-21" class="i">+
</a><a href="#h103-0-22" id="h103-0-22" class="i">+    fun load(block: ScriptableObject.() -&gt; Unit) {
</a><a href="#h103-0-23" id="h103-0-23" class="i">+        contextScope {
</a><a href="#h103-0-24" id="h103-0-24" class="i">+            val classLoader = scriptRuntime.androidContext.classLoader
</a><a href="#h103-0-25" id="h103-0-25" class="i">+            moduleObject = initSafeStandardObjects()
</a><a href="#h103-0-26" id="h103-0-26" class="i">+            moduleObject.putConst(&quot;module&quot;, moduleObject, scriptableObject {
</a><a href="#h103-0-27" id="h103-0-27" class="i">+                putConst(&quot;info&quot;, this, scriptableObject {
</a><a href="#h103-0-28" id="h103-0-28" class="i">+                    putConst(&quot;name&quot;, this, moduleInfo.name)
</a><a href="#h103-0-29" id="h103-0-29" class="i">+                    putConst(&quot;version&quot;, this, moduleInfo.version)
</a><a href="#h103-0-30" id="h103-0-30" class="i">+                    putConst(&quot;description&quot;, this, moduleInfo.description)
</a><a href="#h103-0-31" id="h103-0-31" class="i">+                    putConst(&quot;author&quot;, this, moduleInfo.author)
</a><a href="#h103-0-32" id="h103-0-32" class="i">+                    putConst(&quot;minSnapchatVersion&quot;, this, moduleInfo.minSnapchatVersion)
</a><a href="#h103-0-33" id="h103-0-33" class="i">+                    putConst(&quot;minSEVersion&quot;, this, moduleInfo.minSEVersion)
</a><a href="#h103-0-34" id="h103-0-34" class="i">+                    putConst(&quot;grantPermissions&quot;, this, moduleInfo.grantPermissions)
</a><a href="#h103-0-35" id="h103-0-35" class="i">+                })
</a><a href="#h103-0-36" id="h103-0-36" class="i">+            })
</a><a href="#h103-0-37" id="h103-0-37" class="i">+
</a><a href="#h103-0-38" id="h103-0-38" class="i">+            moduleObject.putFunction(&quot;setField&quot;) { args -&gt;
</a><a href="#h103-0-39" id="h103-0-39" class="i">+                val obj = args?.get(0) as? NativeJavaObject ?: return@putFunction Undefined.instance
</a><a href="#h103-0-40" id="h103-0-40" class="i">+                val name = args[1].toString()
</a><a href="#h103-0-41" id="h103-0-41" class="i">+                val value = args[2]
</a><a href="#h103-0-42" id="h103-0-42" class="i">+                val field = obj.unwrap().javaClass.declaredFields.find { it.name == name } ?: return@putFunction Undefined.instance
</a><a href="#h103-0-43" id="h103-0-43" class="i">+                field.isAccessible = true
</a><a href="#h103-0-44" id="h103-0-44" class="i">+                field.set(obj.unwrap(), value.toPrimitiveValue(lazy { field.type.name }))
</a><a href="#h103-0-45" id="h103-0-45" class="i">+                Undefined.instance
</a><a href="#h103-0-46" id="h103-0-46" class="i">+            }
</a><a href="#h103-0-47" id="h103-0-47" class="i">+
</a><a href="#h103-0-48" id="h103-0-48" class="i">+            moduleObject.putFunction(&quot;getField&quot;) { args -&gt;
</a><a href="#h103-0-49" id="h103-0-49" class="i">+                val obj = args?.get(0) as? NativeJavaObject ?: return@putFunction Undefined.instance
</a><a href="#h103-0-50" id="h103-0-50" class="i">+                val name = args[1].toString()
</a><a href="#h103-0-51" id="h103-0-51" class="i">+                val field = obj.unwrap().javaClass.declaredFields.find { it.name == name } ?: return@putFunction Undefined.instance
</a><a href="#h103-0-52" id="h103-0-52" class="i">+                field.isAccessible = true
</a><a href="#h103-0-53" id="h103-0-53" class="i">+                field.get(obj.unwrap())
</a><a href="#h103-0-54" id="h103-0-54" class="i">+            }
</a><a href="#h103-0-55" id="h103-0-55" class="i">+
</a><a href="#h103-0-56" id="h103-0-56" class="i">+            moduleObject.putFunction(&quot;findClass&quot;) {
</a><a href="#h103-0-57" id="h103-0-57" class="i">+                val className = it?.get(0).toString()
</a><a href="#h103-0-58" id="h103-0-58" class="i">+                classLoader.loadClass(className)
</a><a href="#h103-0-59" id="h103-0-59" class="i">+            }
</a><a href="#h103-0-60" id="h103-0-60" class="i">+
</a><a href="#h103-0-61" id="h103-0-61" class="i">+            moduleObject.putFunction(&quot;type&quot;) { args -&gt;
</a><a href="#h103-0-62" id="h103-0-62" class="i">+                val className = args?.get(0).toString()
</a><a href="#h103-0-63" id="h103-0-63" class="i">+                val clazz = classLoader.loadClass(className)
</a><a href="#h103-0-64" id="h103-0-64" class="i">+
</a><a href="#h103-0-65" id="h103-0-65" class="i">+                scriptableObject(&quot;JavaClassWrapper&quot;) {
</a><a href="#h103-0-66" id="h103-0-66" class="i">+                    putFunction(&quot;newInstance&quot;) newInstance@{ args -&gt;
</a><a href="#h103-0-67" id="h103-0-67" class="i">+                        val constructor = clazz.declaredConstructors.find {
</a><a href="#h103-0-68" id="h103-0-68" class="i">+                            it.parameterCount == (args?.size ?: 0)
</a><a href="#h103-0-69" id="h103-0-69" class="i">+                        } ?: return@newInstance Undefined.instance
</a><a href="#h103-0-70" id="h103-0-70" class="i">+                        constructor.newInstance(*args ?: emptyArray())
</a><a href="#h103-0-71" id="h103-0-71" class="i">+                    }
</a><a href="#h103-0-72" id="h103-0-72" class="i">+
</a><a href="#h103-0-73" id="h103-0-73" class="i">+                    clazz.declaredMethods.filter { Modifier.isStatic(it.modifiers) }.forEach { method -&gt;
</a><a href="#h103-0-74" id="h103-0-74" class="i">+                        putFunction(method.name) { args -&gt;
</a><a href="#h103-0-75" id="h103-0-75" class="i">+                            clazz.declaredMethods.find {
</a><a href="#h103-0-76" id="h103-0-76" class="i">+                                it.name == method.name &amp;&amp; it.parameterTypes.zip(args ?: emptyArray()).all { (type, arg) -&gt;
</a><a href="#h103-0-77" id="h103-0-77" class="i">+                                    type.isAssignableFrom(arg.javaClass)
</a><a href="#h103-0-78" id="h103-0-78" class="i">+                                }
</a><a href="#h103-0-79" id="h103-0-79" class="i">+                            }?.invoke(null, *args ?: emptyArray())
</a><a href="#h103-0-80" id="h103-0-80" class="i">+                        }
</a><a href="#h103-0-81" id="h103-0-81" class="i">+                    }
</a><a href="#h103-0-82" id="h103-0-82" class="i">+
</a><a href="#h103-0-83" id="h103-0-83" class="i">+                    clazz.declaredFields.filter { Modifier.isStatic(it.modifiers) }.forEach { field -&gt;
</a><a href="#h103-0-84" id="h103-0-84" class="i">+                        field.isAccessible = true
</a><a href="#h103-0-85" id="h103-0-85" class="i">+                        defineProperty(field.name, { field.get(null)}, { value -&gt; field.set(null, value) }, 0)
</a><a href="#h103-0-86" id="h103-0-86" class="i">+                    }
</a><a href="#h103-0-87" id="h103-0-87" class="i">+                }
</a><a href="#h103-0-88" id="h103-0-88" class="i">+            }
</a><a href="#h103-0-89" id="h103-0-89" class="i">+
</a><a href="#h103-0-90" id="h103-0-90" class="i">+            moduleObject.putFunction(&quot;logInfo&quot;) { args -&gt;
</a><a href="#h103-0-91" id="h103-0-91" class="i">+                scriptRuntime.logger.info(args?.joinToString(&quot; &quot;) {
</a><a href="#h103-0-92" id="h103-0-92" class="i">+                    when (it) {
</a><a href="#h103-0-93" id="h103-0-93" class="i">+                        is Wrapper -&gt; it.unwrap().toString()
</a><a href="#h103-0-94" id="h103-0-94" class="i">+                        else -&gt; it.toString()
</a><a href="#h103-0-95" id="h103-0-95" class="i">+                    }
</a><a href="#h103-0-96" id="h103-0-96" class="i">+                } ?: &quot;null&quot;)
</a><a href="#h103-0-97" id="h103-0-97" class="i">+                Undefined.instance
</a><a href="#h103-0-98" id="h103-0-98" class="i">+            }
</a><a href="#h103-0-99" id="h103-0-99" class="i">+
</a><a href="#h103-0-100" id="h103-0-100" class="i">+            for (toastFunc in listOf(&quot;longToast&quot;, &quot;shortToast&quot;)) {
</a><a href="#h103-0-101" id="h103-0-101" class="i">+                moduleObject.putFunction(toastFunc) { args -&gt;
</a><a href="#h103-0-102" id="h103-0-102" class="i">+                    Handler(scriptRuntime.androidContext.mainLooper).post {
</a><a href="#h103-0-103" id="h103-0-103" class="i">+                        Toast.makeText(
</a><a href="#h103-0-104" id="h103-0-104" class="i">+                            scriptRuntime.androidContext,
</a><a href="#h103-0-105" id="h103-0-105" class="i">+                            args?.joinToString(&quot; &quot;) ?: &quot;&quot;,
</a><a href="#h103-0-106" id="h103-0-106" class="i">+                            if (toastFunc == &quot;longToast&quot;) Toast.LENGTH_LONG else Toast.LENGTH_SHORT
</a><a href="#h103-0-107" id="h103-0-107" class="i">+                        ).show()
</a><a href="#h103-0-108" id="h103-0-108" class="i">+                    }
</a><a href="#h103-0-109" id="h103-0-109" class="i">+                    Undefined.instance
</a><a href="#h103-0-110" id="h103-0-110" class="i">+                }
</a><a href="#h103-0-111" id="h103-0-111" class="i">+            }
</a><a href="#h103-0-112" id="h103-0-112" class="i">+
</a><a href="#h103-0-113" id="h103-0-113" class="i">+            block(moduleObject)
</a><a href="#h103-0-114" id="h103-0-114" class="i">+            evaluateString(moduleObject, content, moduleInfo.name, 1, null)
</a><a href="#h103-0-115" id="h103-0-115" class="i">+        }
</a><a href="#h103-0-116" id="h103-0-116" class="i">+    }
</a><a href="#h103-0-117" id="h103-0-117" class="i">+
</a><a href="#h103-0-118" id="h103-0-118" class="i">+    fun unload() {
</a><a href="#h103-0-119" id="h103-0-119" class="i">+        callFunction(&quot;module.onUnload&quot;)
</a><a href="#h103-0-120" id="h103-0-120" class="i">+    }
</a><a href="#h103-0-121" id="h103-0-121" class="i">+
</a><a href="#h103-0-122" id="h103-0-122" class="i">+    fun callFunction(name: String, vararg args: Any?) {
</a><a href="#h103-0-123" id="h103-0-123" class="i">+        contextScope {
</a><a href="#h103-0-124" id="h103-0-124" class="i">+            name.split(&quot;.&quot;).also { split -&gt;
</a><a href="#h103-0-125" id="h103-0-125" class="i">+                val function = split.dropLast(1).fold(moduleObject) { obj, key -&gt;
</a><a href="#h103-0-126" id="h103-0-126" class="i">+                    obj.get(key, obj) as? ScriptableObject ?: return@contextScope
</a><a href="#h103-0-127" id="h103-0-127" class="i">+                }.get(split.last(), moduleObject) as? Function ?: return@contextScope
</a><a href="#h103-0-128" id="h103-0-128" class="i">+
</a><a href="#h103-0-129" id="h103-0-129" class="i">+                function.call(this, moduleObject, moduleObject, args)
</a><a href="#h103-0-130" id="h103-0-130" class="i">+            }
</a><a href="#h103-0-131" id="h103-0-131" class="i">+        }
</a><a href="#h103-0-132" id="h103-0-132" class="i">+    }
</a><a href="#h103-0-133" id="h103-0-133" class="i">+}</a><a href="#h103-0-134" id="h103-0-134" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h104" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/PrimitiveUtil.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/PrimitiveUtil.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/PrimitiveUtil.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/PrimitiveUtil.kt</a></b>
<a href="#h104-0" id="h104-0" class="h">@@ -0,0 +1,17 @@
</a><a href="#h104-0-0" id="h104-0-0" class="i">+package me.rhunk.snapenhance.common.scripting
</a><a href="#h104-0-1" id="h104-0-1" class="i">+
</a><a href="#h104-0-2" id="h104-0-2" class="i">+fun Any?.toPrimitiveValue(type: Lazy&lt;String&gt;) = when (this) {
</a><a href="#h104-0-3" id="h104-0-3" class="i">+    is Number -&gt; when (type.value) {
</a><a href="#h104-0-4" id="h104-0-4" class="i">+        &quot;byte&quot; -&gt; this.toByte()
</a><a href="#h104-0-5" id="h104-0-5" class="i">+        &quot;short&quot; -&gt; this.toShort()
</a><a href="#h104-0-6" id="h104-0-6" class="i">+        &quot;int&quot; -&gt; this.toInt()
</a><a href="#h104-0-7" id="h104-0-7" class="i">+        &quot;long&quot; -&gt; this.toLong()
</a><a href="#h104-0-8" id="h104-0-8" class="i">+        &quot;float&quot; -&gt; this.toFloat()
</a><a href="#h104-0-9" id="h104-0-9" class="i">+        &quot;double&quot; -&gt; this.toDouble()
</a><a href="#h104-0-10" id="h104-0-10" class="i">+        &quot;boolean&quot; -&gt; this.toByte() != 0.toByte()
</a><a href="#h104-0-11" id="h104-0-11" class="i">+        &quot;char&quot; -&gt; this.toInt().toChar()
</a><a href="#h104-0-12" id="h104-0-12" class="i">+        else -&gt; this
</a><a href="#h104-0-13" id="h104-0-13" class="i">+    }
</a><a href="#h104-0-14" id="h104-0-14" class="i">+    is Boolean -&gt; if (type.value == &quot;boolean&quot;) this.toString().toBoolean() else this
</a><a href="#h104-0-15" id="h104-0-15" class="i">+    else -&gt; this
</a><a href="#h104-0-16" id="h104-0-16" class="i">+}</a><a href="#h104-0-17" id="h104-0-17" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h105" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/ScriptRuntime.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/ScriptRuntime.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/ScriptRuntime.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/ScriptRuntime.kt</a></b>
<a href="#h105-0" id="h105-0" class="h">@@ -0,0 +1,90 @@
</a><a href="#h105-0-0" id="h105-0-0" class="i">+package me.rhunk.snapenhance.common.scripting
</a><a href="#h105-0-1" id="h105-0-1" class="i">+
</a><a href="#h105-0-2" id="h105-0-2" class="i">+import android.content.Context
</a><a href="#h105-0-3" id="h105-0-3" class="i">+import me.rhunk.snapenhance.common.logger.AbstractLogger
</a><a href="#h105-0-4" id="h105-0-4" class="i">+import me.rhunk.snapenhance.common.scripting.type.ModuleInfo
</a><a href="#h105-0-5" id="h105-0-5" class="i">+import org.mozilla.javascript.ScriptableObject
</a><a href="#h105-0-6" id="h105-0-6" class="i">+import java.io.BufferedReader
</a><a href="#h105-0-7" id="h105-0-7" class="i">+import java.io.ByteArrayInputStream
</a><a href="#h105-0-8" id="h105-0-8" class="i">+import java.io.InputStream
</a><a href="#h105-0-9" id="h105-0-9" class="i">+
</a><a href="#h105-0-10" id="h105-0-10" class="i">+open class ScriptRuntime(
</a><a href="#h105-0-11" id="h105-0-11" class="i">+    val androidContext: Context,
</a><a href="#h105-0-12" id="h105-0-12" class="i">+    val logger: AbstractLogger,
</a><a href="#h105-0-13" id="h105-0-13" class="i">+) {
</a><a href="#h105-0-14" id="h105-0-14" class="i">+    var buildModuleObject: ScriptableObject.(JSModule) -&gt; Unit = {}
</a><a href="#h105-0-15" id="h105-0-15" class="i">+    private val modules = mutableMapOf&lt;String, JSModule&gt;()
</a><a href="#h105-0-16" id="h105-0-16" class="i">+
</a><a href="#h105-0-17" id="h105-0-17" class="i">+    fun eachModule(f: JSModule.() -&gt; Unit) {
</a><a href="#h105-0-18" id="h105-0-18" class="i">+        modules.values.forEach { module -&gt;
</a><a href="#h105-0-19" id="h105-0-19" class="i">+            runCatching {
</a><a href="#h105-0-20" id="h105-0-20" class="i">+                module.f()
</a><a href="#h105-0-21" id="h105-0-21" class="i">+            }.onFailure {
</a><a href="#h105-0-22" id="h105-0-22" class="i">+                logger.error(&quot;Failed to run module function in ${module.moduleInfo.name}&quot;, it)
</a><a href="#h105-0-23" id="h105-0-23" class="i">+            }
</a><a href="#h105-0-24" id="h105-0-24" class="i">+        }
</a><a href="#h105-0-25" id="h105-0-25" class="i">+    }
</a><a href="#h105-0-26" id="h105-0-26" class="i">+
</a><a href="#h105-0-27" id="h105-0-27" class="i">+    private fun readModuleInfo(reader: BufferedReader): ModuleInfo {
</a><a href="#h105-0-28" id="h105-0-28" class="i">+        val header = reader.readLine()
</a><a href="#h105-0-29" id="h105-0-29" class="i">+        if (!header.startsWith(&quot;// ==SE_module==&quot;)) {
</a><a href="#h105-0-30" id="h105-0-30" class="i">+            throw Exception(&quot;Invalid module header&quot;)
</a><a href="#h105-0-31" id="h105-0-31" class="i">+        }
</a><a href="#h105-0-32" id="h105-0-32" class="i">+
</a><a href="#h105-0-33" id="h105-0-33" class="i">+        val properties = mutableMapOf&lt;String, String&gt;()
</a><a href="#h105-0-34" id="h105-0-34" class="i">+        while (true) {
</a><a href="#h105-0-35" id="h105-0-35" class="i">+            val line = reader.readLine()
</a><a href="#h105-0-36" id="h105-0-36" class="i">+            if (line.startsWith(&quot;// ==/SE_module==&quot;)) {
</a><a href="#h105-0-37" id="h105-0-37" class="i">+                break
</a><a href="#h105-0-38" id="h105-0-38" class="i">+            }
</a><a href="#h105-0-39" id="h105-0-39" class="i">+            val split = line.replaceFirst(&quot;//&quot;, &quot;&quot;).split(&quot;:&quot;)
</a><a href="#h105-0-40" id="h105-0-40" class="i">+            if (split.size != 2) {
</a><a href="#h105-0-41" id="h105-0-41" class="i">+                throw Exception(&quot;Invalid module property&quot;)
</a><a href="#h105-0-42" id="h105-0-42" class="i">+            }
</a><a href="#h105-0-43" id="h105-0-43" class="i">+            properties[split[0].trim()] = split[1].trim()
</a><a href="#h105-0-44" id="h105-0-44" class="i">+        }
</a><a href="#h105-0-45" id="h105-0-45" class="i">+
</a><a href="#h105-0-46" id="h105-0-46" class="i">+        return ModuleInfo(
</a><a href="#h105-0-47" id="h105-0-47" class="i">+            name = properties[&quot;name&quot;] ?: throw Exception(&quot;Missing module name&quot;),
</a><a href="#h105-0-48" id="h105-0-48" class="i">+            version = properties[&quot;version&quot;] ?: throw Exception(&quot;Missing module version&quot;),
</a><a href="#h105-0-49" id="h105-0-49" class="i">+            description = properties[&quot;description&quot;],
</a><a href="#h105-0-50" id="h105-0-50" class="i">+            author = properties[&quot;author&quot;],
</a><a href="#h105-0-51" id="h105-0-51" class="i">+            minSnapchatVersion = properties[&quot;minSnapchatVersion&quot;]?.toLong(),
</a><a href="#h105-0-52" id="h105-0-52" class="i">+            minSEVersion = properties[&quot;minSEVersion&quot;]?.toLong(),
</a><a href="#h105-0-53" id="h105-0-53" class="i">+            grantPermissions = properties[&quot;permissions&quot;]?.split(&quot;,&quot;)?.map { it.trim() },
</a><a href="#h105-0-54" id="h105-0-54" class="i">+        )
</a><a href="#h105-0-55" id="h105-0-55" class="i">+    }
</a><a href="#h105-0-56" id="h105-0-56" class="i">+
</a><a href="#h105-0-57" id="h105-0-57" class="i">+    fun getModuleInfo(inputStream: InputStream): ModuleInfo {
</a><a href="#h105-0-58" id="h105-0-58" class="i">+        return readModuleInfo(inputStream.bufferedReader())
</a><a href="#h105-0-59" id="h105-0-59" class="i">+    }
</a><a href="#h105-0-60" id="h105-0-60" class="i">+
</a><a href="#h105-0-61" id="h105-0-61" class="i">+    fun reload(path: String, content: String) {
</a><a href="#h105-0-62" id="h105-0-62" class="i">+        unload(path)
</a><a href="#h105-0-63" id="h105-0-63" class="i">+        load(path, content)
</a><a href="#h105-0-64" id="h105-0-64" class="i">+    }
</a><a href="#h105-0-65" id="h105-0-65" class="i">+
</a><a href="#h105-0-66" id="h105-0-66" class="i">+    private fun unload(path: String) {
</a><a href="#h105-0-67" id="h105-0-67" class="i">+        val module = modules[path] ?: return
</a><a href="#h105-0-68" id="h105-0-68" class="i">+        module.unload()
</a><a href="#h105-0-69" id="h105-0-69" class="i">+        modules.remove(path)
</a><a href="#h105-0-70" id="h105-0-70" class="i">+    }
</a><a href="#h105-0-71" id="h105-0-71" class="i">+
</a><a href="#h105-0-72" id="h105-0-72" class="i">+    fun load(path: String, content: String): JSModule? {
</a><a href="#h105-0-73" id="h105-0-73" class="i">+        logger.info(&quot;Loading module $path&quot;)
</a><a href="#h105-0-74" id="h105-0-74" class="i">+        return runCatching {
</a><a href="#h105-0-75" id="h105-0-75" class="i">+            JSModule(
</a><a href="#h105-0-76" id="h105-0-76" class="i">+                scriptRuntime = this,
</a><a href="#h105-0-77" id="h105-0-77" class="i">+                moduleInfo = readModuleInfo(ByteArrayInputStream(content.toByteArray(Charsets.UTF_8)).bufferedReader()),
</a><a href="#h105-0-78" id="h105-0-78" class="i">+                content = content,
</a><a href="#h105-0-79" id="h105-0-79" class="i">+            ).apply {
</a><a href="#h105-0-80" id="h105-0-80" class="i">+                load {
</a><a href="#h105-0-81" id="h105-0-81" class="i">+                    buildModuleObject(this, this@apply)
</a><a href="#h105-0-82" id="h105-0-82" class="i">+                }
</a><a href="#h105-0-83" id="h105-0-83" class="i">+                modules[path] = this
</a><a href="#h105-0-84" id="h105-0-84" class="i">+            }
</a><a href="#h105-0-85" id="h105-0-85" class="i">+        }.onFailure {
</a><a href="#h105-0-86" id="h105-0-86" class="i">+            logger.error(&quot;Failed to load module $path&quot;, it)
</a><a href="#h105-0-87" id="h105-0-87" class="i">+        }.getOrNull()
</a><a href="#h105-0-88" id="h105-0-88" class="i">+    }
</a><a href="#h105-0-89" id="h105-0-89" class="i">+}</a><a href="#h105-0-90" id="h105-0-90" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h106" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/ktx/RhinoKtx.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/ktx/RhinoKtx.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/ktx/RhinoKtx.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/ktx/RhinoKtx.kt</a></b>
<a href="#h106-0" id="h106-0" class="h">@@ -0,0 +1,43 @@
</a><a href="#h106-0-0" id="h106-0-0" class="i">+package me.rhunk.snapenhance.common.scripting.ktx
</a><a href="#h106-0-1" id="h106-0-1" class="i">+
</a><a href="#h106-0-2" id="h106-0-2" class="i">+import org.mozilla.javascript.Context
</a><a href="#h106-0-3" id="h106-0-3" class="i">+import org.mozilla.javascript.Function
</a><a href="#h106-0-4" id="h106-0-4" class="i">+import org.mozilla.javascript.Scriptable
</a><a href="#h106-0-5" id="h106-0-5" class="i">+import org.mozilla.javascript.ScriptableObject
</a><a href="#h106-0-6" id="h106-0-6" class="i">+
</a><a href="#h106-0-7" id="h106-0-7" class="i">+fun contextScope(f: Context.() -&gt; Unit) {
</a><a href="#h106-0-8" id="h106-0-8" class="i">+    val context = Context.enter()
</a><a href="#h106-0-9" id="h106-0-9" class="i">+    context.optimizationLevel = -1
</a><a href="#h106-0-10" id="h106-0-10" class="i">+    try {
</a><a href="#h106-0-11" id="h106-0-11" class="i">+        context.f()
</a><a href="#h106-0-12" id="h106-0-12" class="i">+    } finally {
</a><a href="#h106-0-13" id="h106-0-13" class="i">+        Context.exit()
</a><a href="#h106-0-14" id="h106-0-14" class="i">+    }
</a><a href="#h106-0-15" id="h106-0-15" class="i">+}
</a><a href="#h106-0-16" id="h106-0-16" class="i">+
</a><a href="#h106-0-17" id="h106-0-17" class="i">+fun Scriptable.scriptable(name: String): Scriptable? {
</a><a href="#h106-0-18" id="h106-0-18" class="i">+    return this.get(name, this) as? Scriptable
</a><a href="#h106-0-19" id="h106-0-19" class="i">+}
</a><a href="#h106-0-20" id="h106-0-20" class="i">+
</a><a href="#h106-0-21" id="h106-0-21" class="i">+fun Scriptable.function(name: String): Function? {
</a><a href="#h106-0-22" id="h106-0-22" class="i">+    return this.get(name, this) as? Function
</a><a href="#h106-0-23" id="h106-0-23" class="i">+}
</a><a href="#h106-0-24" id="h106-0-24" class="i">+
</a><a href="#h106-0-25" id="h106-0-25" class="i">+fun ScriptableObject.putFunction(name: String, proxy: Scriptable.(Array&lt;out Any&gt;?) -&gt; Any?) {
</a><a href="#h106-0-26" id="h106-0-26" class="i">+    this.putConst(name, this, object: org.mozilla.javascript.BaseFunction() {
</a><a href="#h106-0-27" id="h106-0-27" class="i">+        override fun call(
</a><a href="#h106-0-28" id="h106-0-28" class="i">+            cx: Context?,
</a><a href="#h106-0-29" id="h106-0-29" class="i">+            scope: Scriptable,
</a><a href="#h106-0-30" id="h106-0-30" class="i">+            thisObj: Scriptable,
</a><a href="#h106-0-31" id="h106-0-31" class="i">+            args: Array&lt;out Any&gt;?
</a><a href="#h106-0-32" id="h106-0-32" class="i">+        ): Any? {
</a><a href="#h106-0-33" id="h106-0-33" class="i">+            return thisObj.proxy(args)
</a><a href="#h106-0-34" id="h106-0-34" class="i">+        }
</a><a href="#h106-0-35" id="h106-0-35" class="i">+    })
</a><a href="#h106-0-36" id="h106-0-36" class="i">+}
</a><a href="#h106-0-37" id="h106-0-37" class="i">+
</a><a href="#h106-0-38" id="h106-0-38" class="i">+fun scriptableObject(name: String? = &quot;ScriptableObject&quot;, f: ScriptableObject.() -&gt; Unit): ScriptableObject {
</a><a href="#h106-0-39" id="h106-0-39" class="i">+    return object: ScriptableObject() {
</a><a href="#h106-0-40" id="h106-0-40" class="i">+        override fun getClassName() = name
</a><a href="#h106-0-41" id="h106-0-41" class="i">+    }.apply(f)
</a><a href="#h106-0-42" id="h106-0-42" class="i">+}</a><a href="#h106-0-43" id="h106-0-43" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h107" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/type/ModuleInfo.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/type/ModuleInfo.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/type/ModuleInfo.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/type/ModuleInfo.kt</a></b>
<a href="#h107-0" id="h107-0" class="h">@@ -0,0 +1,11 @@
</a><a href="#h107-0-0" id="h107-0-0" class="i">+package me.rhunk.snapenhance.common.scripting.type
</a><a href="#h107-0-1" id="h107-0-1" class="i">+
</a><a href="#h107-0-2" id="h107-0-2" class="i">+data class ModuleInfo(
</a><a href="#h107-0-3" id="h107-0-3" class="i">+    val name: String,
</a><a href="#h107-0-4" id="h107-0-4" class="i">+    val version: String,
</a><a href="#h107-0-5" id="h107-0-5" class="i">+    val description: String? = null,
</a><a href="#h107-0-6" id="h107-0-6" class="i">+    val author: String? = null,
</a><a href="#h107-0-7" id="h107-0-7" class="i">+    val minSnapchatVersion: Long? = null,
</a><a href="#h107-0-8" id="h107-0-8" class="i">+    val minSEVersion: Long? = null,
</a><a href="#h107-0-9" id="h107-0-9" class="i">+    val grantPermissions: List&lt;String&gt;? = null,
</a><a href="#h107-0-10" id="h107-0-10" class="i">+)</a><a href="#h107-0-11" id="h107-0-11" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h108" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/util/SQLiteDatabaseHelper.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/util/SQLiteDatabaseHelper.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/util/SQLiteDatabaseHelper.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/util/SQLiteDatabaseHelper.kt</a></b>
<a href="#h108-0" id="h108-0" class="h">@@ -0,0 +1,31 @@
</a><a href="#h108-0-0" id="h108-0-0" class="i">+package me.rhunk.snapenhance.common.util
</a><a href="#h108-0-1" id="h108-0-1" class="i">+
</a><a href="#h108-0-2" id="h108-0-2" class="i">+import android.annotation.SuppressLint
</a><a href="#h108-0-3" id="h108-0-3" class="i">+import android.database.sqlite.SQLiteDatabase
</a><a href="#h108-0-4" id="h108-0-4" class="i">+import me.rhunk.snapenhance.common.logger.AbstractLogger
</a><a href="#h108-0-5" id="h108-0-5" class="i">+
</a><a href="#h108-0-6" id="h108-0-6" class="i">+object SQLiteDatabaseHelper {
</a><a href="#h108-0-7" id="h108-0-7" class="i">+    @SuppressLint(&quot;Range&quot;)
</a><a href="#h108-0-8" id="h108-0-8" class="i">+    fun createTablesFromSchema(sqLiteDatabase: SQLiteDatabase, databaseSchema: Map&lt;String, List&lt;String&gt;&gt;) {
</a><a href="#h108-0-9" id="h108-0-9" class="i">+        databaseSchema.forEach { (tableName, columns) -&gt;
</a><a href="#h108-0-10" id="h108-0-10" class="i">+            sqLiteDatabase.execSQL(&quot;CREATE TABLE IF NOT EXISTS $tableName (${columns.joinToString(&quot;, &quot;)})&quot;)
</a><a href="#h108-0-11" id="h108-0-11" class="i">+
</a><a href="#h108-0-12" id="h108-0-12" class="i">+            val cursor = sqLiteDatabase.rawQuery(&quot;PRAGMA table_info($tableName)&quot;, null)
</a><a href="#h108-0-13" id="h108-0-13" class="i">+            val existingColumns = mutableListOf&lt;String&gt;()
</a><a href="#h108-0-14" id="h108-0-14" class="i">+            while (cursor.moveToNext()) {
</a><a href="#h108-0-15" id="h108-0-15" class="i">+                existingColumns.add(cursor.getString(cursor.getColumnIndex(&quot;name&quot;)) + &quot; &quot; + cursor.getString(cursor.getColumnIndex(&quot;type&quot;)))
</a><a href="#h108-0-16" id="h108-0-16" class="i">+            }
</a><a href="#h108-0-17" id="h108-0-17" class="i">+            cursor.close()
</a><a href="#h108-0-18" id="h108-0-18" class="i">+
</a><a href="#h108-0-19" id="h108-0-19" class="i">+            val newColumns = columns.filter {
</a><a href="#h108-0-20" id="h108-0-20" class="i">+                existingColumns.none { existingColumn -&gt; it.startsWith(existingColumn) }
</a><a href="#h108-0-21" id="h108-0-21" class="i">+            }
</a><a href="#h108-0-22" id="h108-0-22" class="i">+
</a><a href="#h108-0-23" id="h108-0-23" class="i">+            if (newColumns.isEmpty()) return@forEach
</a><a href="#h108-0-24" id="h108-0-24" class="i">+
</a><a href="#h108-0-25" id="h108-0-25" class="i">+            AbstractLogger.directDebug(&quot;Schema for table $tableName has changed&quot;)
</a><a href="#h108-0-26" id="h108-0-26" class="i">+            sqLiteDatabase.execSQL(&quot;DROP TABLE $tableName&quot;)
</a><a href="#h108-0-27" id="h108-0-27" class="i">+            sqLiteDatabase.execSQL(&quot;CREATE TABLE IF NOT EXISTS $tableName (${columns.joinToString(&quot;, &quot;)})&quot;)
</a><a href="#h108-0-28" id="h108-0-28" class="i">+        }
</a><a href="#h108-0-29" id="h108-0-29" class="i">+    }
</a><a href="#h108-0-30" id="h108-0-30" class="i">+}</a><a href="#h108-0-31" id="h108-0-31" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h109" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/util/SerializableDataObject.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/util/SerializableDataObject.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/util/SerializableDataObject.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/util/SerializableDataObject.kt</a></b>
<a href="#h109-0" id="h109-0" class="h">@@ -0,0 +1,22 @@
</a><a href="#h109-0-0" id="h109-0-0" class="i">+package me.rhunk.snapenhance.common.util
</a><a href="#h109-0-1" id="h109-0-1" class="i">+
</a><a href="#h109-0-2" id="h109-0-2" class="i">+import com.google.gson.Gson
</a><a href="#h109-0-3" id="h109-0-3" class="i">+import com.google.gson.GsonBuilder
</a><a href="#h109-0-4" id="h109-0-4" class="i">+
</a><a href="#h109-0-5" id="h109-0-5" class="i">+open class SerializableDataObject {
</a><a href="#h109-0-6" id="h109-0-6" class="i">+    companion object {
</a><a href="#h109-0-7" id="h109-0-7" class="i">+        val gson: Gson = GsonBuilder().create()
</a><a href="#h109-0-8" id="h109-0-8" class="i">+
</a><a href="#h109-0-9" id="h109-0-9" class="i">+        inline fun &lt;reified T : SerializableDataObject&gt; fromJson(json: String): T {
</a><a href="#h109-0-10" id="h109-0-10" class="i">+            return gson.fromJson(json, T::class.java)
</a><a href="#h109-0-11" id="h109-0-11" class="i">+        }
</a><a href="#h109-0-12" id="h109-0-12" class="i">+
</a><a href="#h109-0-13" id="h109-0-13" class="i">+        inline fun &lt;reified T : SerializableDataObject&gt; fromJson(json: String, type: Class&lt;T&gt;): T {
</a><a href="#h109-0-14" id="h109-0-14" class="i">+            return gson.fromJson(json, type)
</a><a href="#h109-0-15" id="h109-0-15" class="i">+        }
</a><a href="#h109-0-16" id="h109-0-16" class="i">+    }
</a><a href="#h109-0-17" id="h109-0-17" class="i">+
</a><a href="#h109-0-18" id="h109-0-18" class="i">+    fun toJson(): String {
</a><a href="#h109-0-19" id="h109-0-19" class="i">+        return gson.toJson(this)
</a><a href="#h109-0-20" id="h109-0-20" class="i">+    }
</a><a href="#h109-0-21" id="h109-0-21" class="i">+}</a><a href="#h109-0-22" id="h109-0-22" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h110" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/util/ktx/AndroidCompatExtensions.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/util/ktx/AndroidCompatExtensions.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/util/ktx/AndroidCompatExtensions.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/util/ktx/AndroidCompatExtensions.kt</a></b>
<a href="#h110-0" id="h110-0" class="h">@@ -0,0 +1,13 @@
</a><a href="#h110-0-0" id="h110-0-0" class="i">+package me.rhunk.snapenhance.common.util.ktx
</a><a href="#h110-0-1" id="h110-0-1" class="i">+
</a><a href="#h110-0-2" id="h110-0-2" class="i">+import android.content.pm.PackageManager
</a><a href="#h110-0-3" id="h110-0-3" class="i">+import android.content.pm.PackageManager.ApplicationInfoFlags
</a><a href="#h110-0-4" id="h110-0-4" class="i">+import android.os.Build
</a><a href="#h110-0-5" id="h110-0-5" class="i">+
</a><a href="#h110-0-6" id="h110-0-6" class="i">+fun PackageManager.getApplicationInfoCompat(packageName: String, flags: Int) =
</a><a href="#h110-0-7" id="h110-0-7" class="i">+    if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.TIRAMISU) {
</a><a href="#h110-0-8" id="h110-0-8" class="i">+        getApplicationInfo(packageName, ApplicationInfoFlags.of(flags.toLong()))
</a><a href="#h110-0-9" id="h110-0-9" class="i">+    } else {
</a><a href="#h110-0-10" id="h110-0-10" class="i">+        @Suppress(&quot;DEPRECATION&quot;)
</a><a href="#h110-0-11" id="h110-0-11" class="i">+        getApplicationInfo(packageName, flags)
</a><a href="#h110-0-12" id="h110-0-12" class="i">+    }
</a><b>diff --git a/<a id="h111" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/util/ktx/DbCursorExt.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/util/ktx/DbCursorExt.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/util/ktx/DbCursorExt.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/util/ktx/DbCursorExt.kt</a></b>
<a href="#h111-0" id="h111-0" class="h">@@ -0,0 +1,37 @@
</a><a href="#h111-0-0" id="h111-0-0" class="i">+package me.rhunk.snapenhance.common.util.ktx
</a><a href="#h111-0-1" id="h111-0-1" class="i">+
</a><a href="#h111-0-2" id="h111-0-2" class="i">+import android.database.Cursor
</a><a href="#h111-0-3" id="h111-0-3" class="i">+
</a><a href="#h111-0-4" id="h111-0-4" class="i">+fun Cursor.getStringOrNull(columnName: String): String? {
</a><a href="#h111-0-5" id="h111-0-5" class="i">+    val columnIndex = getColumnIndex(columnName)
</a><a href="#h111-0-6" id="h111-0-6" class="i">+    return if (columnIndex == -1) null else getString(columnIndex)
</a><a href="#h111-0-7" id="h111-0-7" class="i">+}
</a><a href="#h111-0-8" id="h111-0-8" class="i">+
</a><a href="#h111-0-9" id="h111-0-9" class="i">+fun Cursor.getIntOrNull(columnName: String): Int? {
</a><a href="#h111-0-10" id="h111-0-10" class="i">+    val columnIndex = getColumnIndex(columnName)
</a><a href="#h111-0-11" id="h111-0-11" class="i">+    return if (columnIndex == -1) null else getInt(columnIndex)
</a><a href="#h111-0-12" id="h111-0-12" class="i">+}
</a><a href="#h111-0-13" id="h111-0-13" class="i">+
</a><a href="#h111-0-14" id="h111-0-14" class="i">+fun Cursor.getInteger(columnName: String) = getIntOrNull(columnName) ?: throw NullPointerException(&quot;Column $columnName is null&quot;)
</a><a href="#h111-0-15" id="h111-0-15" class="i">+fun Cursor.getLong(columnName: String) = getLongOrNull(columnName) ?: throw NullPointerException(&quot;Column $columnName is null&quot;)
</a><a href="#h111-0-16" id="h111-0-16" class="i">+
</a><a href="#h111-0-17" id="h111-0-17" class="i">+fun Cursor.getBlobOrNull(columnName: String): ByteArray? {
</a><a href="#h111-0-18" id="h111-0-18" class="i">+    val columnIndex = getColumnIndex(columnName)
</a><a href="#h111-0-19" id="h111-0-19" class="i">+    return if (columnIndex == -1) null else getBlob(columnIndex)
</a><a href="#h111-0-20" id="h111-0-20" class="i">+}
</a><a href="#h111-0-21" id="h111-0-21" class="i">+
</a><a href="#h111-0-22" id="h111-0-22" class="i">+
</a><a href="#h111-0-23" id="h111-0-23" class="i">+fun Cursor.getLongOrNull(columnName: String): Long? {
</a><a href="#h111-0-24" id="h111-0-24" class="i">+    val columnIndex = getColumnIndex(columnName)
</a><a href="#h111-0-25" id="h111-0-25" class="i">+    return if (columnIndex == -1) null else getLong(columnIndex)
</a><a href="#h111-0-26" id="h111-0-26" class="i">+}
</a><a href="#h111-0-27" id="h111-0-27" class="i">+
</a><a href="#h111-0-28" id="h111-0-28" class="i">+fun Cursor.getDoubleOrNull(columnName: String): Double? {
</a><a href="#h111-0-29" id="h111-0-29" class="i">+    val columnIndex = getColumnIndex(columnName)
</a><a href="#h111-0-30" id="h111-0-30" class="i">+    return if (columnIndex == -1) null else getDouble(columnIndex)
</a><a href="#h111-0-31" id="h111-0-31" class="i">+}
</a><a href="#h111-0-32" id="h111-0-32" class="i">+
</a><a href="#h111-0-33" id="h111-0-33" class="i">+fun Cursor.getFloatOrNull(columnName: String): Float? {
</a><a href="#h111-0-34" id="h111-0-34" class="i">+    val columnIndex = getColumnIndex(columnName)
</a><a href="#h111-0-35" id="h111-0-35" class="i">+    return if (columnIndex == -1) null else getFloat(columnIndex)
</a><a href="#h111-0-36" id="h111-0-36" class="i">+}</a><a href="#h111-0-37" id="h111-0-37" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h112" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/util/protobuf/ProtoEditor.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/util/protobuf/ProtoEditor.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/util/protobuf/ProtoEditor.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/util/protobuf/ProtoEditor.kt</a></b>
<a href="#h112-0" id="h112-0" class="h">@@ -0,0 +1,67 @@
</a><a href="#h112-0-0" id="h112-0-0" class="i">+package me.rhunk.snapenhance.common.util.protobuf
</a><a href="#h112-0-1" id="h112-0-1" class="i">+
</a><a href="#h112-0-2" id="h112-0-2" class="i">+
</a><a href="#h112-0-3" id="h112-0-3" class="i">+typealias WireCallback = EditorContext.() -&gt; Unit
</a><a href="#h112-0-4" id="h112-0-4" class="i">+
</a><a href="#h112-0-5" id="h112-0-5" class="i">+class EditorContext(
</a><a href="#h112-0-6" id="h112-0-6" class="i">+    private val wires: MutableMap&lt;Int, MutableList&lt;Wire&gt;&gt;
</a><a href="#h112-0-7" id="h112-0-7" class="i">+) {
</a><a href="#h112-0-8" id="h112-0-8" class="i">+    fun clear() {
</a><a href="#h112-0-9" id="h112-0-9" class="i">+        wires.clear()
</a><a href="#h112-0-10" id="h112-0-10" class="i">+    }
</a><a href="#h112-0-11" id="h112-0-11" class="i">+    fun addWire(wire: Wire) {
</a><a href="#h112-0-12" id="h112-0-12" class="i">+        wires.getOrPut(wire.id) { mutableListOf() }.add(wire)
</a><a href="#h112-0-13" id="h112-0-13" class="i">+    }
</a><a href="#h112-0-14" id="h112-0-14" class="i">+    fun addVarInt(id: Int, value: Int) = addVarInt(id, value.toLong())
</a><a href="#h112-0-15" id="h112-0-15" class="i">+    fun addVarInt(id: Int, value: Long) = addWire(Wire(id, WireType.VARINT, value))
</a><a href="#h112-0-16" id="h112-0-16" class="i">+    fun addBuffer(id: Int, value: ByteArray) = addWire(Wire(id, WireType.CHUNK, value))
</a><a href="#h112-0-17" id="h112-0-17" class="i">+    fun add(id: Int, content: ProtoWriter.() -&gt; Unit) = addBuffer(id, ProtoWriter().apply(content).toByteArray())
</a><a href="#h112-0-18" id="h112-0-18" class="i">+    fun addString(id: Int, value: String) = addBuffer(id, value.toByteArray())
</a><a href="#h112-0-19" id="h112-0-19" class="i">+    fun addFixed64(id: Int, value: Long) = addWire(Wire(id, WireType.FIXED64, value))
</a><a href="#h112-0-20" id="h112-0-20" class="i">+    fun addFixed32(id: Int, value: Int) = addWire(Wire(id, WireType.FIXED32, value))
</a><a href="#h112-0-21" id="h112-0-21" class="i">+
</a><a href="#h112-0-22" id="h112-0-22" class="i">+    fun firstOrNull(id: Int) = wires[id]?.firstOrNull()
</a><a href="#h112-0-23" id="h112-0-23" class="i">+    fun getOrNull(id: Int) = wires[id]
</a><a href="#h112-0-24" id="h112-0-24" class="i">+    fun get(id: Int) = wires[id]!!
</a><a href="#h112-0-25" id="h112-0-25" class="i">+
</a><a href="#h112-0-26" id="h112-0-26" class="i">+    fun remove(id: Int) = wires.remove(id)
</a><a href="#h112-0-27" id="h112-0-27" class="i">+    fun remove(id: Int, index: Int) = wires[id]?.removeAt(index)
</a><a href="#h112-0-28" id="h112-0-28" class="i">+}
</a><a href="#h112-0-29" id="h112-0-29" class="i">+
</a><a href="#h112-0-30" id="h112-0-30" class="i">+class ProtoEditor(
</a><a href="#h112-0-31" id="h112-0-31" class="i">+    private var buffer: ByteArray
</a><a href="#h112-0-32" id="h112-0-32" class="i">+) {
</a><a href="#h112-0-33" id="h112-0-33" class="i">+    fun edit(vararg path: Int, callback: WireCallback) {
</a><a href="#h112-0-34" id="h112-0-34" class="i">+        buffer = writeAtPath(path, 0, ProtoReader(buffer), callback)
</a><a href="#h112-0-35" id="h112-0-35" class="i">+    }
</a><a href="#h112-0-36" id="h112-0-36" class="i">+
</a><a href="#h112-0-37" id="h112-0-37" class="i">+    private fun writeAtPath(path: IntArray, currentIndex: Int, rootReader: ProtoReader, wireToWriteCallback: WireCallback): ByteArray {
</a><a href="#h112-0-38" id="h112-0-38" class="i">+        val id = path.getOrNull(currentIndex)
</a><a href="#h112-0-39" id="h112-0-39" class="i">+        val output = ProtoWriter()
</a><a href="#h112-0-40" id="h112-0-40" class="i">+        val wires = sortedMapOf&lt;Int, MutableList&lt;Wire&gt;&gt;()
</a><a href="#h112-0-41" id="h112-0-41" class="i">+
</a><a href="#h112-0-42" id="h112-0-42" class="i">+        rootReader.forEach { wireId, value -&gt;
</a><a href="#h112-0-43" id="h112-0-43" class="i">+            wires.putIfAbsent(wireId, mutableListOf())
</a><a href="#h112-0-44" id="h112-0-44" class="i">+            if (id != null &amp;&amp; wireId == id) {
</a><a href="#h112-0-45" id="h112-0-45" class="i">+                val childReader = rootReader.followPath(id)
</a><a href="#h112-0-46" id="h112-0-46" class="i">+                if (childReader == null) {
</a><a href="#h112-0-47" id="h112-0-47" class="i">+                    wires.getOrPut(wireId) { mutableListOf() }.add(value)
</a><a href="#h112-0-48" id="h112-0-48" class="i">+                    return@forEach
</a><a href="#h112-0-49" id="h112-0-49" class="i">+                }
</a><a href="#h112-0-50" id="h112-0-50" class="i">+                wires[wireId]!!.add(Wire(wireId, WireType.CHUNK, writeAtPath(path, currentIndex + 1, childReader, wireToWriteCallback)))
</a><a href="#h112-0-51" id="h112-0-51" class="i">+                return@forEach
</a><a href="#h112-0-52" id="h112-0-52" class="i">+            }
</a><a href="#h112-0-53" id="h112-0-53" class="i">+            wires[wireId]!!.add(value)
</a><a href="#h112-0-54" id="h112-0-54" class="i">+        }
</a><a href="#h112-0-55" id="h112-0-55" class="i">+
</a><a href="#h112-0-56" id="h112-0-56" class="i">+        if (currentIndex == path.size) {
</a><a href="#h112-0-57" id="h112-0-57" class="i">+            wireToWriteCallback(EditorContext(wires))
</a><a href="#h112-0-58" id="h112-0-58" class="i">+        }
</a><a href="#h112-0-59" id="h112-0-59" class="i">+
</a><a href="#h112-0-60" id="h112-0-60" class="i">+        wires.values.flatten().forEach(output::addWire)
</a><a href="#h112-0-61" id="h112-0-61" class="i">+
</a><a href="#h112-0-62" id="h112-0-62" class="i">+        return output.toByteArray()
</a><a href="#h112-0-63" id="h112-0-63" class="i">+    }
</a><a href="#h112-0-64" id="h112-0-64" class="i">+
</a><a href="#h112-0-65" id="h112-0-65" class="i">+    fun toByteArray() = buffer
</a><a href="#h112-0-66" id="h112-0-66" class="i">+}</a><a href="#h112-0-67" id="h112-0-67" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h113" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/util/protobuf/ProtoReader.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/util/protobuf/ProtoReader.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/util/protobuf/ProtoReader.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/util/protobuf/ProtoReader.kt</a></b>
<a href="#h113-0" id="h113-0" class="h">@@ -0,0 +1,255 @@
</a><a href="#h113-0-0" id="h113-0-0" class="i">+package me.rhunk.snapenhance.common.util.protobuf
</a><a href="#h113-0-1" id="h113-0-1" class="i">+
</a><a href="#h113-0-2" id="h113-0-2" class="i">+import java.util.UUID
</a><a href="#h113-0-3" id="h113-0-3" class="i">+
</a><a href="#h113-0-4" id="h113-0-4" class="i">+data class Wire(val id: Int, val type: WireType, val value: Any)
</a><a href="#h113-0-5" id="h113-0-5" class="i">+
</a><a href="#h113-0-6" id="h113-0-6" class="i">+class ProtoReader(private val buffer: ByteArray) {
</a><a href="#h113-0-7" id="h113-0-7" class="i">+    private var offset: Int = 0
</a><a href="#h113-0-8" id="h113-0-8" class="i">+    private val values = mutableMapOf&lt;Int, MutableList&lt;Wire&gt;&gt;()
</a><a href="#h113-0-9" id="h113-0-9" class="i">+
</a><a href="#h113-0-10" id="h113-0-10" class="i">+    init {
</a><a href="#h113-0-11" id="h113-0-11" class="i">+        read()
</a><a href="#h113-0-12" id="h113-0-12" class="i">+    }
</a><a href="#h113-0-13" id="h113-0-13" class="i">+
</a><a href="#h113-0-14" id="h113-0-14" class="i">+    fun getBuffer() = buffer
</a><a href="#h113-0-15" id="h113-0-15" class="i">+
</a><a href="#h113-0-16" id="h113-0-16" class="i">+    private fun readByte() = buffer[offset++]
</a><a href="#h113-0-17" id="h113-0-17" class="i">+
</a><a href="#h113-0-18" id="h113-0-18" class="i">+    private fun readVarInt(): Long {
</a><a href="#h113-0-19" id="h113-0-19" class="i">+        var result = 0L
</a><a href="#h113-0-20" id="h113-0-20" class="i">+        var shift = 0
</a><a href="#h113-0-21" id="h113-0-21" class="i">+        while (true) {
</a><a href="#h113-0-22" id="h113-0-22" class="i">+            val b = readByte()
</a><a href="#h113-0-23" id="h113-0-23" class="i">+            result = result or ((b.toLong() and 0x7F) shl shift)
</a><a href="#h113-0-24" id="h113-0-24" class="i">+            if (b.toInt() and 0x80 == 0) {
</a><a href="#h113-0-25" id="h113-0-25" class="i">+                break
</a><a href="#h113-0-26" id="h113-0-26" class="i">+            }
</a><a href="#h113-0-27" id="h113-0-27" class="i">+            shift += 7
</a><a href="#h113-0-28" id="h113-0-28" class="i">+        }
</a><a href="#h113-0-29" id="h113-0-29" class="i">+        return result
</a><a href="#h113-0-30" id="h113-0-30" class="i">+    }
</a><a href="#h113-0-31" id="h113-0-31" class="i">+
</a><a href="#h113-0-32" id="h113-0-32" class="i">+    private fun read() {
</a><a href="#h113-0-33" id="h113-0-33" class="i">+        while (offset &lt; buffer.size) {
</a><a href="#h113-0-34" id="h113-0-34" class="i">+            try {
</a><a href="#h113-0-35" id="h113-0-35" class="i">+                val tag = readVarInt().toInt()
</a><a href="#h113-0-36" id="h113-0-36" class="i">+                val id = tag ushr 3
</a><a href="#h113-0-37" id="h113-0-37" class="i">+                val type = WireType.fromValue(tag and 0x7) ?: break
</a><a href="#h113-0-38" id="h113-0-38" class="i">+                val value = when (type) {
</a><a href="#h113-0-39" id="h113-0-39" class="i">+                    WireType.VARINT -&gt; readVarInt()
</a><a href="#h113-0-40" id="h113-0-40" class="i">+                    WireType.FIXED64 -&gt; {
</a><a href="#h113-0-41" id="h113-0-41" class="i">+                        val bytes = ByteArray(8)
</a><a href="#h113-0-42" id="h113-0-42" class="i">+                        for (i in 0..7) {
</a><a href="#h113-0-43" id="h113-0-43" class="i">+                            bytes[i] = readByte()
</a><a href="#h113-0-44" id="h113-0-44" class="i">+                        }
</a><a href="#h113-0-45" id="h113-0-45" class="i">+                        bytes
</a><a href="#h113-0-46" id="h113-0-46" class="i">+                    }
</a><a href="#h113-0-47" id="h113-0-47" class="i">+                    WireType.CHUNK -&gt; {
</a><a href="#h113-0-48" id="h113-0-48" class="i">+                        val length = readVarInt().toInt()
</a><a href="#h113-0-49" id="h113-0-49" class="i">+                        val bytes = ByteArray(length)
</a><a href="#h113-0-50" id="h113-0-50" class="i">+                        for (i in 0 until length) {
</a><a href="#h113-0-51" id="h113-0-51" class="i">+                            bytes[i] = readByte()
</a><a href="#h113-0-52" id="h113-0-52" class="i">+                        }
</a><a href="#h113-0-53" id="h113-0-53" class="i">+                        bytes
</a><a href="#h113-0-54" id="h113-0-54" class="i">+                    }
</a><a href="#h113-0-55" id="h113-0-55" class="i">+                    WireType.START_GROUP -&gt; {
</a><a href="#h113-0-56" id="h113-0-56" class="i">+                        val bytes = mutableListOf&lt;Byte&gt;()
</a><a href="#h113-0-57" id="h113-0-57" class="i">+                        while (true) {
</a><a href="#h113-0-58" id="h113-0-58" class="i">+                            val b = readByte()
</a><a href="#h113-0-59" id="h113-0-59" class="i">+                            if (b.toInt() == WireType.END_GROUP.value) {
</a><a href="#h113-0-60" id="h113-0-60" class="i">+                                break
</a><a href="#h113-0-61" id="h113-0-61" class="i">+                            }
</a><a href="#h113-0-62" id="h113-0-62" class="i">+                            bytes.add(b)
</a><a href="#h113-0-63" id="h113-0-63" class="i">+                        }
</a><a href="#h113-0-64" id="h113-0-64" class="i">+                        bytes.toByteArray()
</a><a href="#h113-0-65" id="h113-0-65" class="i">+                    }
</a><a href="#h113-0-66" id="h113-0-66" class="i">+                    WireType.FIXED32 -&gt; {
</a><a href="#h113-0-67" id="h113-0-67" class="i">+                        val bytes = ByteArray(4)
</a><a href="#h113-0-68" id="h113-0-68" class="i">+                        for (i in 0..3) {
</a><a href="#h113-0-69" id="h113-0-69" class="i">+                            bytes[i] = readByte()
</a><a href="#h113-0-70" id="h113-0-70" class="i">+                        }
</a><a href="#h113-0-71" id="h113-0-71" class="i">+                        bytes
</a><a href="#h113-0-72" id="h113-0-72" class="i">+                    }
</a><a href="#h113-0-73" id="h113-0-73" class="i">+                    WireType.END_GROUP -&gt; continue
</a><a href="#h113-0-74" id="h113-0-74" class="i">+                }
</a><a href="#h113-0-75" id="h113-0-75" class="i">+                values.getOrPut(id) { mutableListOf() }.add(Wire(id, type, value))
</a><a href="#h113-0-76" id="h113-0-76" class="i">+            } catch (t: Throwable) {
</a><a href="#h113-0-77" id="h113-0-77" class="i">+                values.clear()
</a><a href="#h113-0-78" id="h113-0-78" class="i">+                break
</a><a href="#h113-0-79" id="h113-0-79" class="i">+            }
</a><a href="#h113-0-80" id="h113-0-80" class="i">+        }
</a><a href="#h113-0-81" id="h113-0-81" class="i">+    }
</a><a href="#h113-0-82" id="h113-0-82" class="i">+
</a><a href="#h113-0-83" id="h113-0-83" class="i">+    fun followPath(vararg ids: Int, excludeLast: Boolean = false, reader: (ProtoReader.() -&gt; Unit)? = null): ProtoReader? {
</a><a href="#h113-0-84" id="h113-0-84" class="i">+        var thisReader = this
</a><a href="#h113-0-85" id="h113-0-85" class="i">+        ids.let {
</a><a href="#h113-0-86" id="h113-0-86" class="i">+            if (excludeLast) {
</a><a href="#h113-0-87" id="h113-0-87" class="i">+                it.sliceArray(0 until it.size - 1)
</a><a href="#h113-0-88" id="h113-0-88" class="i">+            } else {
</a><a href="#h113-0-89" id="h113-0-89" class="i">+                it
</a><a href="#h113-0-90" id="h113-0-90" class="i">+            }
</a><a href="#h113-0-91" id="h113-0-91" class="i">+        }.forEach { id -&gt;
</a><a href="#h113-0-92" id="h113-0-92" class="i">+            if (!thisReader.contains(id)) {
</a><a href="#h113-0-93" id="h113-0-93" class="i">+                return null
</a><a href="#h113-0-94" id="h113-0-94" class="i">+            }
</a><a href="#h113-0-95" id="h113-0-95" class="i">+            thisReader = ProtoReader(thisReader.getByteArray(id) ?: return null)
</a><a href="#h113-0-96" id="h113-0-96" class="i">+        }
</a><a href="#h113-0-97" id="h113-0-97" class="i">+        if (reader != null) {
</a><a href="#h113-0-98" id="h113-0-98" class="i">+            thisReader.reader()
</a><a href="#h113-0-99" id="h113-0-99" class="i">+        }
</a><a href="#h113-0-100" id="h113-0-100" class="i">+        return thisReader
</a><a href="#h113-0-101" id="h113-0-101" class="i">+    }
</a><a href="#h113-0-102" id="h113-0-102" class="i">+
</a><a href="#h113-0-103" id="h113-0-103" class="i">+    fun containsPath(vararg ids: Int): Boolean {
</a><a href="#h113-0-104" id="h113-0-104" class="i">+        var thisReader = this
</a><a href="#h113-0-105" id="h113-0-105" class="i">+        ids.forEach { id -&gt;
</a><a href="#h113-0-106" id="h113-0-106" class="i">+            if (!thisReader.contains(id)) {
</a><a href="#h113-0-107" id="h113-0-107" class="i">+                return false
</a><a href="#h113-0-108" id="h113-0-108" class="i">+            }
</a><a href="#h113-0-109" id="h113-0-109" class="i">+            thisReader = ProtoReader(thisReader.getByteArray(id) ?: return false)
</a><a href="#h113-0-110" id="h113-0-110" class="i">+        }
</a><a href="#h113-0-111" id="h113-0-111" class="i">+        return true
</a><a href="#h113-0-112" id="h113-0-112" class="i">+    }
</a><a href="#h113-0-113" id="h113-0-113" class="i">+
</a><a href="#h113-0-114" id="h113-0-114" class="i">+    fun forEach(reader: (Int, Wire) -&gt; Unit) {
</a><a href="#h113-0-115" id="h113-0-115" class="i">+        values.forEach { (id, wires) -&gt;
</a><a href="#h113-0-116" id="h113-0-116" class="i">+            wires.forEach { wire -&gt;
</a><a href="#h113-0-117" id="h113-0-117" class="i">+                reader(id, wire)
</a><a href="#h113-0-118" id="h113-0-118" class="i">+            }
</a><a href="#h113-0-119" id="h113-0-119" class="i">+        }
</a><a href="#h113-0-120" id="h113-0-120" class="i">+    }
</a><a href="#h113-0-121" id="h113-0-121" class="i">+
</a><a href="#h113-0-122" id="h113-0-122" class="i">+    fun forEach(vararg id: Int, reader: ProtoReader.() -&gt; Unit) {
</a><a href="#h113-0-123" id="h113-0-123" class="i">+        followPath(*id)?.eachBuffer { _, buffer -&gt;
</a><a href="#h113-0-124" id="h113-0-124" class="i">+            ProtoReader(buffer).reader()
</a><a href="#h113-0-125" id="h113-0-125" class="i">+        }
</a><a href="#h113-0-126" id="h113-0-126" class="i">+    }
</a><a href="#h113-0-127" id="h113-0-127" class="i">+
</a><a href="#h113-0-128" id="h113-0-128" class="i">+    fun eachBuffer(vararg ids: Int, reader: ProtoReader.() -&gt; Unit) {
</a><a href="#h113-0-129" id="h113-0-129" class="i">+        followPath(*ids, excludeLast = true)?.eachBuffer { id, buffer -&gt;
</a><a href="#h113-0-130" id="h113-0-130" class="i">+            if (id == ids.last()) {
</a><a href="#h113-0-131" id="h113-0-131" class="i">+                ProtoReader(buffer).reader()
</a><a href="#h113-0-132" id="h113-0-132" class="i">+            }
</a><a href="#h113-0-133" id="h113-0-133" class="i">+        }
</a><a href="#h113-0-134" id="h113-0-134" class="i">+    }
</a><a href="#h113-0-135" id="h113-0-135" class="i">+
</a><a href="#h113-0-136" id="h113-0-136" class="i">+    fun eachBuffer(reader: (Int, ByteArray) -&gt; Unit) {
</a><a href="#h113-0-137" id="h113-0-137" class="i">+        values.forEach { (id, wires) -&gt;
</a><a href="#h113-0-138" id="h113-0-138" class="i">+            wires.forEach { wire -&gt;
</a><a href="#h113-0-139" id="h113-0-139" class="i">+                if (wire.type == WireType.CHUNK) {
</a><a href="#h113-0-140" id="h113-0-140" class="i">+                    reader(id, wire.value as ByteArray)
</a><a href="#h113-0-141" id="h113-0-141" class="i">+                }
</a><a href="#h113-0-142" id="h113-0-142" class="i">+            }
</a><a href="#h113-0-143" id="h113-0-143" class="i">+        }
</a><a href="#h113-0-144" id="h113-0-144" class="i">+    }
</a><a href="#h113-0-145" id="h113-0-145" class="i">+
</a><a href="#h113-0-146" id="h113-0-146" class="i">+    fun contains(id: Int) = values.containsKey(id)
</a><a href="#h113-0-147" id="h113-0-147" class="i">+
</a><a href="#h113-0-148" id="h113-0-148" class="i">+    fun getWire(id: Int) = values[id]?.firstOrNull()
</a><a href="#h113-0-149" id="h113-0-149" class="i">+    fun getRawValue(id: Int) = getWire(id)?.value
</a><a href="#h113-0-150" id="h113-0-150" class="i">+    fun getByteArray(id: Int) = getRawValue(id) as? ByteArray
</a><a href="#h113-0-151" id="h113-0-151" class="i">+    fun getByteArray(vararg ids: Int) = followPath(*ids, excludeLast = true)?.getByteArray(ids.last())
</a><a href="#h113-0-152" id="h113-0-152" class="i">+    fun getString(id: Int) = getByteArray(id)?.toString(Charsets.UTF_8)
</a><a href="#h113-0-153" id="h113-0-153" class="i">+    fun getString(vararg ids: Int) = followPath(*ids, excludeLast = true)?.getString(ids.last())
</a><a href="#h113-0-154" id="h113-0-154" class="i">+    fun getVarInt(id: Int) = getRawValue(id) as? Long
</a><a href="#h113-0-155" id="h113-0-155" class="i">+    fun getVarInt(vararg ids: Int) = followPath(*ids, excludeLast = true)?.getVarInt(ids.last())
</a><a href="#h113-0-156" id="h113-0-156" class="i">+    fun getCount(id: Int) = values[id]?.size ?: 0
</a><a href="#h113-0-157" id="h113-0-157" class="i">+
</a><a href="#h113-0-158" id="h113-0-158" class="i">+    fun getFixed64(id: Int): Long {
</a><a href="#h113-0-159" id="h113-0-159" class="i">+        val bytes = getByteArray(id) ?: return 0L
</a><a href="#h113-0-160" id="h113-0-160" class="i">+        var value = 0L
</a><a href="#h113-0-161" id="h113-0-161" class="i">+        for (i in 0..7) {
</a><a href="#h113-0-162" id="h113-0-162" class="i">+            value = value or ((bytes[i].toLong() and 0xFF) shl (i * 8))
</a><a href="#h113-0-163" id="h113-0-163" class="i">+        }
</a><a href="#h113-0-164" id="h113-0-164" class="i">+        return value
</a><a href="#h113-0-165" id="h113-0-165" class="i">+    }
</a><a href="#h113-0-166" id="h113-0-166" class="i">+
</a><a href="#h113-0-167" id="h113-0-167" class="i">+
</a><a href="#h113-0-168" id="h113-0-168" class="i">+    fun getFixed32(id: Int): Int {
</a><a href="#h113-0-169" id="h113-0-169" class="i">+        val bytes = getByteArray(id) ?: return 0
</a><a href="#h113-0-170" id="h113-0-170" class="i">+        var value = 0
</a><a href="#h113-0-171" id="h113-0-171" class="i">+        for (i in 0..3) {
</a><a href="#h113-0-172" id="h113-0-172" class="i">+            value = value or ((bytes[i].toInt() and 0xFF) shl (i * 8))
</a><a href="#h113-0-173" id="h113-0-173" class="i">+        }
</a><a href="#h113-0-174" id="h113-0-174" class="i">+        return value
</a><a href="#h113-0-175" id="h113-0-175" class="i">+    }
</a><a href="#h113-0-176" id="h113-0-176" class="i">+
</a><a href="#h113-0-177" id="h113-0-177" class="i">+    private fun prettyPrint(tabSize: Int): String {
</a><a href="#h113-0-178" id="h113-0-178" class="i">+        val tabLine = &quot;    &quot;.repeat(tabSize)
</a><a href="#h113-0-179" id="h113-0-179" class="i">+        val stringBuilder = StringBuilder()
</a><a href="#h113-0-180" id="h113-0-180" class="i">+        values.forEach { (id, wires) -&gt;
</a><a href="#h113-0-181" id="h113-0-181" class="i">+            wires.forEach { wire -&gt;
</a><a href="#h113-0-182" id="h113-0-182" class="i">+                stringBuilder.append(tabLine)
</a><a href="#h113-0-183" id="h113-0-183" class="i">+                stringBuilder.append(&quot;$id &lt;${wire.type.name.lowercase()}&gt; = &quot;)
</a><a href="#h113-0-184" id="h113-0-184" class="i">+                when (wire.type) {
</a><a href="#h113-0-185" id="h113-0-185" class="i">+                    WireType.VARINT -&gt; stringBuilder.append(&quot;${wire.value}\n&quot;)
</a><a href="#h113-0-186" id="h113-0-186" class="i">+                    WireType.FIXED64, WireType.FIXED32 -&gt; {
</a><a href="#h113-0-187" id="h113-0-187" class="i">+                        //print as double, int, floating point
</a><a href="#h113-0-188" id="h113-0-188" class="i">+                        val doubleValue = run {
</a><a href="#h113-0-189" id="h113-0-189" class="i">+                            val bytes = wire.value as ByteArray
</a><a href="#h113-0-190" id="h113-0-190" class="i">+                            var value = 0L
</a><a href="#h113-0-191" id="h113-0-191" class="i">+                            for (i in bytes.indices) {
</a><a href="#h113-0-192" id="h113-0-192" class="i">+                                value = value or ((bytes[i].toLong() and 0xFF) shl (i * 8))
</a><a href="#h113-0-193" id="h113-0-193" class="i">+                            }
</a><a href="#h113-0-194" id="h113-0-194" class="i">+                            value
</a><a href="#h113-0-195" id="h113-0-195" class="i">+                        }.let {
</a><a href="#h113-0-196" id="h113-0-196" class="i">+                            if (wire.type == WireType.FIXED32) {
</a><a href="#h113-0-197" id="h113-0-197" class="i">+                                it.toInt()
</a><a href="#h113-0-198" id="h113-0-198" class="i">+                            } else {
</a><a href="#h113-0-199" id="h113-0-199" class="i">+                                it
</a><a href="#h113-0-200" id="h113-0-200" class="i">+                            }
</a><a href="#h113-0-201" id="h113-0-201" class="i">+                        }
</a><a href="#h113-0-202" id="h113-0-202" class="i">+
</a><a href="#h113-0-203" id="h113-0-203" class="i">+                        stringBuilder.append(&quot;$doubleValue/${doubleValue.toDouble().toBits().toString(16)}\n&quot;)
</a><a href="#h113-0-204" id="h113-0-204" class="i">+                    }
</a><a href="#h113-0-205" id="h113-0-205" class="i">+                    WireType.CHUNK -&gt; {
</a><a href="#h113-0-206" id="h113-0-206" class="i">+                        fun printArray() {
</a><a href="#h113-0-207" id="h113-0-207" class="i">+                            stringBuilder.append(&quot;\n&quot;)
</a><a href="#h113-0-208" id="h113-0-208" class="i">+                            stringBuilder.append(&quot;$tabLine    &quot;)
</a><a href="#h113-0-209" id="h113-0-209" class="i">+                            stringBuilder.append((wire.value as ByteArray).joinToString(&quot; &quot;) { byte -&gt; &quot;%02x&quot;.format(byte) })
</a><a href="#h113-0-210" id="h113-0-210" class="i">+                            stringBuilder.append(&quot;\n&quot;)
</a><a href="#h113-0-211" id="h113-0-211" class="i">+                        }
</a><a href="#h113-0-212" id="h113-0-212" class="i">+                        runCatching {
</a><a href="#h113-0-213" id="h113-0-213" class="i">+                            val array = (wire.value as ByteArray)
</a><a href="#h113-0-214" id="h113-0-214" class="i">+                            if (array.isEmpty()) {
</a><a href="#h113-0-215" id="h113-0-215" class="i">+                                stringBuilder.append(&quot;empty\n&quot;)
</a><a href="#h113-0-216" id="h113-0-216" class="i">+                                return@runCatching
</a><a href="#h113-0-217" id="h113-0-217" class="i">+                            }
</a><a href="#h113-0-218" id="h113-0-218" class="i">+                            //auto detect ascii strings
</a><a href="#h113-0-219" id="h113-0-219" class="i">+                            if (array.all { it in 0x20..0x7E }) {
</a><a href="#h113-0-220" id="h113-0-220" class="i">+                                stringBuilder.append(&quot;string: ${array.toString(Charsets.UTF_8)}\n&quot;)
</a><a href="#h113-0-221" id="h113-0-221" class="i">+                                return@runCatching
</a><a href="#h113-0-222" id="h113-0-222" class="i">+                            }
</a><a href="#h113-0-223" id="h113-0-223" class="i">+
</a><a href="#h113-0-224" id="h113-0-224" class="i">+                            // auto detect uuids
</a><a href="#h113-0-225" id="h113-0-225" class="i">+                            if (array.size == 16) {
</a><a href="#h113-0-226" id="h113-0-226" class="i">+                                val longs = LongArray(2)
</a><a href="#h113-0-227" id="h113-0-227" class="i">+                                for (i in 0 .. 7) {
</a><a href="#h113-0-228" id="h113-0-228" class="i">+                                    longs[0] = longs[0] or ((array[i].toLong() and 0xFF) shl ((7 - i) * 8))
</a><a href="#h113-0-229" id="h113-0-229" class="i">+                                }
</a><a href="#h113-0-230" id="h113-0-230" class="i">+                                for (i in 8 .. 15) {
</a><a href="#h113-0-231" id="h113-0-231" class="i">+                                    longs[1] = longs[1] or ((array[i].toLong() and 0xFF) shl ((15 - i) * 8))
</a><a href="#h113-0-232" id="h113-0-232" class="i">+                                }
</a><a href="#h113-0-233" id="h113-0-233" class="i">+                                stringBuilder.append(&quot;uuid: ${UUID(longs[0], longs[1])}\n&quot;)
</a><a href="#h113-0-234" id="h113-0-234" class="i">+                                return@runCatching
</a><a href="#h113-0-235" id="h113-0-235" class="i">+                            }
</a><a href="#h113-0-236" id="h113-0-236" class="i">+
</a><a href="#h113-0-237" id="h113-0-237" class="i">+                            ProtoReader(array).prettyPrint(tabSize + 1).takeIf { it.isNotEmpty() }?.let {
</a><a href="#h113-0-238" id="h113-0-238" class="i">+                                stringBuilder.append(&quot;message:\n&quot;)
</a><a href="#h113-0-239" id="h113-0-239" class="i">+                                stringBuilder.append(it)
</a><a href="#h113-0-240" id="h113-0-240" class="i">+                            } ?: printArray()
</a><a href="#h113-0-241" id="h113-0-241" class="i">+                        }.onFailure {
</a><a href="#h113-0-242" id="h113-0-242" class="i">+                            printArray()
</a><a href="#h113-0-243" id="h113-0-243" class="i">+                        }
</a><a href="#h113-0-244" id="h113-0-244" class="i">+                    }
</a><a href="#h113-0-245" id="h113-0-245" class="i">+                    else -&gt; stringBuilder.append(&quot;unknown\n&quot;)
</a><a href="#h113-0-246" id="h113-0-246" class="i">+                }
</a><a href="#h113-0-247" id="h113-0-247" class="i">+            }
</a><a href="#h113-0-248" id="h113-0-248" class="i">+        }
</a><a href="#h113-0-249" id="h113-0-249" class="i">+
</a><a href="#h113-0-250" id="h113-0-250" class="i">+        return stringBuilder.toString()
</a><a href="#h113-0-251" id="h113-0-251" class="i">+    }
</a><a href="#h113-0-252" id="h113-0-252" class="i">+
</a><a href="#h113-0-253" id="h113-0-253" class="i">+    override fun toString() = prettyPrint(0)
</a><a href="#h113-0-254" id="h113-0-254" class="i">+}</a><a href="#h113-0-255" id="h113-0-255" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h114" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/util/protobuf/ProtoWriter.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/util/protobuf/ProtoWriter.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/util/protobuf/ProtoWriter.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/util/protobuf/ProtoWriter.kt</a></b>
<a href="#h114-0" id="h114-0" class="h">@@ -0,0 +1,117 @@
</a><a href="#h114-0-0" id="h114-0-0" class="i">+package me.rhunk.snapenhance.common.util.protobuf
</a><a href="#h114-0-1" id="h114-0-1" class="i">+
</a><a href="#h114-0-2" id="h114-0-2" class="i">+import java.io.ByteArrayOutputStream
</a><a href="#h114-0-3" id="h114-0-3" class="i">+
</a><a href="#h114-0-4" id="h114-0-4" class="i">+class ProtoWriter {
</a><a href="#h114-0-5" id="h114-0-5" class="i">+    private val stream: ByteArrayOutputStream = ByteArrayOutputStream()
</a><a href="#h114-0-6" id="h114-0-6" class="i">+
</a><a href="#h114-0-7" id="h114-0-7" class="i">+    private fun writeVarInt(value: Int) {
</a><a href="#h114-0-8" id="h114-0-8" class="i">+        var v = value
</a><a href="#h114-0-9" id="h114-0-9" class="i">+        while (v and -0x80 != 0) {
</a><a href="#h114-0-10" id="h114-0-10" class="i">+            stream.write(v and 0x7F or 0x80)
</a><a href="#h114-0-11" id="h114-0-11" class="i">+            v = v ushr 7
</a><a href="#h114-0-12" id="h114-0-12" class="i">+        }
</a><a href="#h114-0-13" id="h114-0-13" class="i">+        stream.write(v)
</a><a href="#h114-0-14" id="h114-0-14" class="i">+    }
</a><a href="#h114-0-15" id="h114-0-15" class="i">+
</a><a href="#h114-0-16" id="h114-0-16" class="i">+    private fun writeVarLong(value: Long) {
</a><a href="#h114-0-17" id="h114-0-17" class="i">+        var v = value
</a><a href="#h114-0-18" id="h114-0-18" class="i">+        while (v and -0x80L != 0L) {
</a><a href="#h114-0-19" id="h114-0-19" class="i">+            stream.write((v and 0x7FL or 0x80L).toInt())
</a><a href="#h114-0-20" id="h114-0-20" class="i">+            v = v ushr 7
</a><a href="#h114-0-21" id="h114-0-21" class="i">+        }
</a><a href="#h114-0-22" id="h114-0-22" class="i">+        stream.write(v.toInt())
</a><a href="#h114-0-23" id="h114-0-23" class="i">+    }
</a><a href="#h114-0-24" id="h114-0-24" class="i">+
</a><a href="#h114-0-25" id="h114-0-25" class="i">+    fun addBuffer(id: Int, value: ByteArray) {
</a><a href="#h114-0-26" id="h114-0-26" class="i">+        writeVarInt(id shl 3 or WireType.CHUNK.value)
</a><a href="#h114-0-27" id="h114-0-27" class="i">+        writeVarInt(value.size)
</a><a href="#h114-0-28" id="h114-0-28" class="i">+        stream.write(value)
</a><a href="#h114-0-29" id="h114-0-29" class="i">+    }
</a><a href="#h114-0-30" id="h114-0-30" class="i">+
</a><a href="#h114-0-31" id="h114-0-31" class="i">+    fun addVarInt(id: Int, value: Int) = addVarInt(id, value.toLong())
</a><a href="#h114-0-32" id="h114-0-32" class="i">+
</a><a href="#h114-0-33" id="h114-0-33" class="i">+    fun addVarInt(id: Int, value: Long) {
</a><a href="#h114-0-34" id="h114-0-34" class="i">+        writeVarInt(id shl 3)
</a><a href="#h114-0-35" id="h114-0-35" class="i">+        writeVarLong(value)
</a><a href="#h114-0-36" id="h114-0-36" class="i">+    }
</a><a href="#h114-0-37" id="h114-0-37" class="i">+
</a><a href="#h114-0-38" id="h114-0-38" class="i">+    fun addString(id: Int, value: String) = addBuffer(id, value.toByteArray())
</a><a href="#h114-0-39" id="h114-0-39" class="i">+
</a><a href="#h114-0-40" id="h114-0-40" class="i">+    fun addFixed32(id: Int, value: Int) {
</a><a href="#h114-0-41" id="h114-0-41" class="i">+        writeVarInt(id shl 3 or WireType.FIXED32.value)
</a><a href="#h114-0-42" id="h114-0-42" class="i">+        val bytes = ByteArray(4)
</a><a href="#h114-0-43" id="h114-0-43" class="i">+        for (i in 0..3) {
</a><a href="#h114-0-44" id="h114-0-44" class="i">+            bytes[i] = (value shr (i * 8)).toByte()
</a><a href="#h114-0-45" id="h114-0-45" class="i">+        }
</a><a href="#h114-0-46" id="h114-0-46" class="i">+        stream.write(bytes)
</a><a href="#h114-0-47" id="h114-0-47" class="i">+    }
</a><a href="#h114-0-48" id="h114-0-48" class="i">+
</a><a href="#h114-0-49" id="h114-0-49" class="i">+    fun addFixed64(id: Int, value: Long) {
</a><a href="#h114-0-50" id="h114-0-50" class="i">+        writeVarInt(id shl 3 or WireType.FIXED64.value)
</a><a href="#h114-0-51" id="h114-0-51" class="i">+        val bytes = ByteArray(8)
</a><a href="#h114-0-52" id="h114-0-52" class="i">+        for (i in 0..7) {
</a><a href="#h114-0-53" id="h114-0-53" class="i">+            bytes[i] = (value shr (i * 8)).toByte()
</a><a href="#h114-0-54" id="h114-0-54" class="i">+        }
</a><a href="#h114-0-55" id="h114-0-55" class="i">+        stream.write(bytes)
</a><a href="#h114-0-56" id="h114-0-56" class="i">+    }
</a><a href="#h114-0-57" id="h114-0-57" class="i">+
</a><a href="#h114-0-58" id="h114-0-58" class="i">+    fun from(id: Int, writer: ProtoWriter.() -&gt; Unit) {
</a><a href="#h114-0-59" id="h114-0-59" class="i">+        val writerStream = ProtoWriter()
</a><a href="#h114-0-60" id="h114-0-60" class="i">+        writer(writerStream)
</a><a href="#h114-0-61" id="h114-0-61" class="i">+        addBuffer(id, writerStream.stream.toByteArray())
</a><a href="#h114-0-62" id="h114-0-62" class="i">+    }
</a><a href="#h114-0-63" id="h114-0-63" class="i">+
</a><a href="#h114-0-64" id="h114-0-64" class="i">+    fun from(vararg ids: Int, writer: ProtoWriter.() -&gt; Unit) {
</a><a href="#h114-0-65" id="h114-0-65" class="i">+        val writerStream = ProtoWriter()
</a><a href="#h114-0-66" id="h114-0-66" class="i">+        writer(writerStream)
</a><a href="#h114-0-67" id="h114-0-67" class="i">+        var stream = writerStream.stream.toByteArray()
</a><a href="#h114-0-68" id="h114-0-68" class="i">+        ids.reversed().forEach { id -&gt;
</a><a href="#h114-0-69" id="h114-0-69" class="i">+            with(ProtoWriter()) {
</a><a href="#h114-0-70" id="h114-0-70" class="i">+                addBuffer(id, stream)
</a><a href="#h114-0-71" id="h114-0-71" class="i">+                stream = this.stream.toByteArray()
</a><a href="#h114-0-72" id="h114-0-72" class="i">+            }
</a><a href="#h114-0-73" id="h114-0-73" class="i">+        }
</a><a href="#h114-0-74" id="h114-0-74" class="i">+        stream.let(this.stream::write)
</a><a href="#h114-0-75" id="h114-0-75" class="i">+    }
</a><a href="#h114-0-76" id="h114-0-76" class="i">+
</a><a href="#h114-0-77" id="h114-0-77" class="i">+    fun addWire(wire: Wire) {
</a><a href="#h114-0-78" id="h114-0-78" class="i">+        writeVarInt(wire.id shl 3 or wire.type.value)
</a><a href="#h114-0-79" id="h114-0-79" class="i">+        when (wire.type) {
</a><a href="#h114-0-80" id="h114-0-80" class="i">+            WireType.VARINT -&gt; writeVarLong(wire.value as Long)
</a><a href="#h114-0-81" id="h114-0-81" class="i">+            WireType.FIXED64, WireType.FIXED32 -&gt; {
</a><a href="#h114-0-82" id="h114-0-82" class="i">+                when (wire.value) {
</a><a href="#h114-0-83" id="h114-0-83" class="i">+                    is Int -&gt; {
</a><a href="#h114-0-84" id="h114-0-84" class="i">+                        val bytes = ByteArray(4)
</a><a href="#h114-0-85" id="h114-0-85" class="i">+                        for (i in 0..3) {
</a><a href="#h114-0-86" id="h114-0-86" class="i">+                            bytes[i] = (wire.value shr (i * 8)).toByte()
</a><a href="#h114-0-87" id="h114-0-87" class="i">+                        }
</a><a href="#h114-0-88" id="h114-0-88" class="i">+                        stream.write(bytes)
</a><a href="#h114-0-89" id="h114-0-89" class="i">+                    }
</a><a href="#h114-0-90" id="h114-0-90" class="i">+                    is Long -&gt; {
</a><a href="#h114-0-91" id="h114-0-91" class="i">+                        val bytes = ByteArray(8)
</a><a href="#h114-0-92" id="h114-0-92" class="i">+                        for (i in 0..7) {
</a><a href="#h114-0-93" id="h114-0-93" class="i">+                            bytes[i] = (wire.value shr (i * 8)).toByte()
</a><a href="#h114-0-94" id="h114-0-94" class="i">+                        }
</a><a href="#h114-0-95" id="h114-0-95" class="i">+                        stream.write(bytes)
</a><a href="#h114-0-96" id="h114-0-96" class="i">+                    }
</a><a href="#h114-0-97" id="h114-0-97" class="i">+                    is ByteArray -&gt; stream.write(wire.value)
</a><a href="#h114-0-98" id="h114-0-98" class="i">+                }
</a><a href="#h114-0-99" id="h114-0-99" class="i">+            }
</a><a href="#h114-0-100" id="h114-0-100" class="i">+            WireType.CHUNK -&gt; {
</a><a href="#h114-0-101" id="h114-0-101" class="i">+                val value = wire.value as ByteArray
</a><a href="#h114-0-102" id="h114-0-102" class="i">+                writeVarInt(value.size)
</a><a href="#h114-0-103" id="h114-0-103" class="i">+                stream.write(value)
</a><a href="#h114-0-104" id="h114-0-104" class="i">+            }
</a><a href="#h114-0-105" id="h114-0-105" class="i">+            WireType.START_GROUP -&gt; {
</a><a href="#h114-0-106" id="h114-0-106" class="i">+                val value = wire.value as ByteArray
</a><a href="#h114-0-107" id="h114-0-107" class="i">+                stream.write(value)
</a><a href="#h114-0-108" id="h114-0-108" class="i">+            }
</a><a href="#h114-0-109" id="h114-0-109" class="i">+            WireType.END_GROUP -&gt; return
</a><a href="#h114-0-110" id="h114-0-110" class="i">+        }
</a><a href="#h114-0-111" id="h114-0-111" class="i">+    }
</a><a href="#h114-0-112" id="h114-0-112" class="i">+
</a><a href="#h114-0-113" id="h114-0-113" class="i">+    fun toByteArray(): ByteArray {
</a><a href="#h114-0-114" id="h114-0-114" class="i">+        return stream.toByteArray()
</a><a href="#h114-0-115" id="h114-0-115" class="i">+    }
</a><a href="#h114-0-116" id="h114-0-116" class="i">+}</a><a href="#h114-0-117" id="h114-0-117" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h115" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/util/protobuf/WireType.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/util/protobuf/WireType.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/util/protobuf/WireType.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/util/protobuf/WireType.kt</a></b>
<a href="#h115-0" id="h115-0" class="h">@@ -0,0 +1,14 @@
</a><a href="#h115-0-0" id="h115-0-0" class="i">+package me.rhunk.snapenhance.common.util.protobuf;
</a><a href="#h115-0-1" id="h115-0-1" class="i">+
</a><a href="#h115-0-2" id="h115-0-2" class="i">+enum class WireType(val value: Int) {
</a><a href="#h115-0-3" id="h115-0-3" class="i">+    VARINT(0),
</a><a href="#h115-0-4" id="h115-0-4" class="i">+    FIXED64(1),
</a><a href="#h115-0-5" id="h115-0-5" class="i">+    CHUNK(2),
</a><a href="#h115-0-6" id="h115-0-6" class="i">+    START_GROUP(3),
</a><a href="#h115-0-7" id="h115-0-7" class="i">+    END_GROUP(4),
</a><a href="#h115-0-8" id="h115-0-8" class="i">+    FIXED32(5);
</a><a href="#h115-0-9" id="h115-0-9" class="i">+
</a><a href="#h115-0-10" id="h115-0-10" class="i">+    companion object {
</a><a href="#h115-0-11" id="h115-0-11" class="i">+        fun fromValue(value: Int) = entries.firstOrNull { it.value == value }
</a><a href="#h115-0-12" id="h115-0-12" class="i">+    }
</a><a href="#h115-0-13" id="h115-0-13" class="i">+}
</a><b>diff --git a/<a id="h116" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/util/snap/BitmojiSelfie.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/util/snap/BitmojiSelfie.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/util/snap/BitmojiSelfie.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/util/snap/BitmojiSelfie.kt</a></b>
<a href="#h116-0" id="h116-0" class="h">@@ -0,0 +1,20 @@
</a><a href="#h116-0-0" id="h116-0-0" class="i">+package me.rhunk.snapenhance.common.util.snap
</a><a href="#h116-0-1" id="h116-0-1" class="i">+
</a><a href="#h116-0-2" id="h116-0-2" class="i">+object BitmojiSelfie {
</a><a href="#h116-0-3" id="h116-0-3" class="i">+    enum class BitmojiSelfieType(
</a><a href="#h116-0-4" id="h116-0-4" class="i">+        val prefixUrl: String,
</a><a href="#h116-0-5" id="h116-0-5" class="i">+    ) {
</a><a href="#h116-0-6" id="h116-0-6" class="i">+        STANDARD(&quot;https://sdk.bitmoji.com/render/panel/&quot;),
</a><a href="#h116-0-7" id="h116-0-7" class="i">+        THREE_D(&quot;https://images.bitmoji.com/3d/render/&quot;)
</a><a href="#h116-0-8" id="h116-0-8" class="i">+    }
</a><a href="#h116-0-9" id="h116-0-9" class="i">+
</a><a href="#h116-0-10" id="h116-0-10" class="i">+    fun getBitmojiSelfie(selfieId: String?, avatarId: String?, type: BitmojiSelfieType): String? {
</a><a href="#h116-0-11" id="h116-0-11" class="i">+        if (selfieId.isNullOrEmpty() || avatarId.isNullOrEmpty()) {
</a><a href="#h116-0-12" id="h116-0-12" class="i">+            return null
</a><a href="#h116-0-13" id="h116-0-13" class="i">+        }
</a><a href="#h116-0-14" id="h116-0-14" class="i">+        return when (type) {
</a><a href="#h116-0-15" id="h116-0-15" class="i">+            BitmojiSelfieType.STANDARD -&gt; &quot;${type.prefixUrl}$selfieId-$avatarId-v1.webp?transparent=1&quot;
</a><a href="#h116-0-16" id="h116-0-16" class="i">+            BitmojiSelfieType.THREE_D -&gt; &quot;${type.prefixUrl}$selfieId-$avatarId-v1.webp?trim=circle&quot;
</a><a href="#h116-0-17" id="h116-0-17" class="i">+        }
</a><a href="#h116-0-18" id="h116-0-18" class="i">+    }
</a><a href="#h116-0-19" id="h116-0-19" class="i">+}</a><a href="#h116-0-20" id="h116-0-20" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h117" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/util/snap/MediaDownloaderHelper.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/util/snap/MediaDownloaderHelper.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/util/snap/MediaDownloaderHelper.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/util/snap/MediaDownloaderHelper.kt</a></b>
<a href="#h117-0" id="h117-0" class="h">@@ -0,0 +1,45 @@
</a><a href="#h117-0-0" id="h117-0-0" class="i">+package me.rhunk.snapenhance.common.util.snap
</a><a href="#h117-0-1" id="h117-0-1" class="i">+
</a><a href="#h117-0-2" id="h117-0-2" class="i">+import me.rhunk.snapenhance.common.data.FileType
</a><a href="#h117-0-3" id="h117-0-3" class="i">+import me.rhunk.snapenhance.common.data.download.SplitMediaAssetType
</a><a href="#h117-0-4" id="h117-0-4" class="i">+import java.io.BufferedInputStream
</a><a href="#h117-0-5" id="h117-0-5" class="i">+import java.io.InputStream
</a><a href="#h117-0-6" id="h117-0-6" class="i">+import java.util.zip.ZipEntry
</a><a href="#h117-0-7" id="h117-0-7" class="i">+import java.util.zip.ZipInputStream
</a><a href="#h117-0-8" id="h117-0-8" class="i">+
</a><a href="#h117-0-9" id="h117-0-9" class="i">+
</a><a href="#h117-0-10" id="h117-0-10" class="i">+object MediaDownloaderHelper {
</a><a href="#h117-0-11" id="h117-0-11" class="i">+    fun getFileType(bufferedInputStream: BufferedInputStream): FileType {
</a><a href="#h117-0-12" id="h117-0-12" class="i">+        val buffer = ByteArray(16)
</a><a href="#h117-0-13" id="h117-0-13" class="i">+        bufferedInputStream.mark(16)
</a><a href="#h117-0-14" id="h117-0-14" class="i">+        bufferedInputStream.read(buffer)
</a><a href="#h117-0-15" id="h117-0-15" class="i">+        bufferedInputStream.reset()
</a><a href="#h117-0-16" id="h117-0-16" class="i">+        return FileType.fromByteArray(buffer)
</a><a href="#h117-0-17" id="h117-0-17" class="i">+    }
</a><a href="#h117-0-18" id="h117-0-18" class="i">+
</a><a href="#h117-0-19" id="h117-0-19" class="i">+
</a><a href="#h117-0-20" id="h117-0-20" class="i">+    fun getSplitElements(
</a><a href="#h117-0-21" id="h117-0-21" class="i">+        inputStream: InputStream,
</a><a href="#h117-0-22" id="h117-0-22" class="i">+        callback: (SplitMediaAssetType, InputStream) -&gt; Unit
</a><a href="#h117-0-23" id="h117-0-23" class="i">+    ) {
</a><a href="#h117-0-24" id="h117-0-24" class="i">+        val bufferedInputStream = BufferedInputStream(inputStream)
</a><a href="#h117-0-25" id="h117-0-25" class="i">+        val fileType = getFileType(bufferedInputStream)
</a><a href="#h117-0-26" id="h117-0-26" class="i">+
</a><a href="#h117-0-27" id="h117-0-27" class="i">+        if (fileType != FileType.ZIP) {
</a><a href="#h117-0-28" id="h117-0-28" class="i">+            callback(SplitMediaAssetType.ORIGINAL, bufferedInputStream)
</a><a href="#h117-0-29" id="h117-0-29" class="i">+            return
</a><a href="#h117-0-30" id="h117-0-30" class="i">+        }
</a><a href="#h117-0-31" id="h117-0-31" class="i">+
</a><a href="#h117-0-32" id="h117-0-32" class="i">+        val zipInputStream = ZipInputStream(bufferedInputStream)
</a><a href="#h117-0-33" id="h117-0-33" class="i">+
</a><a href="#h117-0-34" id="h117-0-34" class="i">+        var entry: ZipEntry? = zipInputStream.nextEntry
</a><a href="#h117-0-35" id="h117-0-35" class="i">+        while (entry != null) {
</a><a href="#h117-0-36" id="h117-0-36" class="i">+            if (entry.name.startsWith(&quot;overlay&quot;)) {
</a><a href="#h117-0-37" id="h117-0-37" class="i">+                callback(SplitMediaAssetType.OVERLAY, zipInputStream)
</a><a href="#h117-0-38" id="h117-0-38" class="i">+            } else if (entry.name.startsWith(&quot;media&quot;)) {
</a><a href="#h117-0-39" id="h117-0-39" class="i">+                callback(SplitMediaAssetType.ORIGINAL, zipInputStream)
</a><a href="#h117-0-40" id="h117-0-40" class="i">+            }
</a><a href="#h117-0-41" id="h117-0-41" class="i">+            entry = zipInputStream.nextEntry
</a><a href="#h117-0-42" id="h117-0-42" class="i">+        }
</a><a href="#h117-0-43" id="h117-0-43" class="i">+    }
</a><a href="#h117-0-44" id="h117-0-44" class="i">+}</a><a href="#h117-0-45" id="h117-0-45" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h118" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/util/snap/RemoteMediaResolver.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/util/snap/RemoteMediaResolver.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/util/snap/RemoteMediaResolver.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/util/snap/RemoteMediaResolver.kt</a></b>
<a href="#h118-0" id="h118-0" class="h">@@ -0,0 +1,68 @@
</a><a href="#h118-0-0" id="h118-0-0" class="i">+package me.rhunk.snapenhance.common.util.snap
</a><a href="#h118-0-1" id="h118-0-1" class="i">+
</a><a href="#h118-0-2" id="h118-0-2" class="i">+import me.rhunk.snapenhance.common.Constants
</a><a href="#h118-0-3" id="h118-0-3" class="i">+import me.rhunk.snapenhance.common.logger.AbstractLogger
</a><a href="#h118-0-4" id="h118-0-4" class="i">+import okhttp3.OkHttpClient
</a><a href="#h118-0-5" id="h118-0-5" class="i">+import okhttp3.Request
</a><a href="#h118-0-6" id="h118-0-6" class="i">+import java.io.InputStream
</a><a href="#h118-0-7" id="h118-0-7" class="i">+import java.util.Base64
</a><a href="#h118-0-8" id="h118-0-8" class="i">+
</a><a href="#h118-0-9" id="h118-0-9" class="i">+object RemoteMediaResolver {
</a><a href="#h118-0-10" id="h118-0-10" class="i">+    private const val BOLT_HTTP_RESOLVER_URL = &quot;https://web.snapchat.com/bolt-http&quot;
</a><a href="#h118-0-11" id="h118-0-11" class="i">+    const val CF_ST_CDN_D = &quot;https://cf-st.sc-cdn.net/d/&quot;
</a><a href="#h118-0-12" id="h118-0-12" class="i">+
</a><a href="#h118-0-13" id="h118-0-13" class="i">+    private val urlCache = mutableMapOf&lt;String, String&gt;()
</a><a href="#h118-0-14" id="h118-0-14" class="i">+
</a><a href="#h118-0-15" id="h118-0-15" class="i">+    private val okHttpClient = OkHttpClient.Builder()
</a><a href="#h118-0-16" id="h118-0-16" class="i">+        .followRedirects(true)
</a><a href="#h118-0-17" id="h118-0-17" class="i">+        .retryOnConnectionFailure(true)
</a><a href="#h118-0-18" id="h118-0-18" class="i">+        .readTimeout(20, java.util.concurrent.TimeUnit.SECONDS)
</a><a href="#h118-0-19" id="h118-0-19" class="i">+        .addInterceptor { chain -&gt;
</a><a href="#h118-0-20" id="h118-0-20" class="i">+            val request = chain.request()
</a><a href="#h118-0-21" id="h118-0-21" class="i">+            val requestUrl = request.url.toString()
</a><a href="#h118-0-22" id="h118-0-22" class="i">+
</a><a href="#h118-0-23" id="h118-0-23" class="i">+            if (urlCache.containsKey(requestUrl)) {
</a><a href="#h118-0-24" id="h118-0-24" class="i">+                val cachedUrl = urlCache[requestUrl]!!
</a><a href="#h118-0-25" id="h118-0-25" class="i">+                return@addInterceptor chain.proceed(request.newBuilder().url(cachedUrl).build())
</a><a href="#h118-0-26" id="h118-0-26" class="i">+            }
</a><a href="#h118-0-27" id="h118-0-27" class="i">+
</a><a href="#h118-0-28" id="h118-0-28" class="i">+            chain.proceed(request).apply {
</a><a href="#h118-0-29" id="h118-0-29" class="i">+                val responseUrl = this.request.url.toString()
</a><a href="#h118-0-30" id="h118-0-30" class="i">+                if (responseUrl.startsWith(&quot;https://cf-st.sc-cdn.net&quot;)) {
</a><a href="#h118-0-31" id="h118-0-31" class="i">+                    urlCache[requestUrl] = responseUrl
</a><a href="#h118-0-32" id="h118-0-32" class="i">+                }
</a><a href="#h118-0-33" id="h118-0-33" class="i">+            }
</a><a href="#h118-0-34" id="h118-0-34" class="i">+        }
</a><a href="#h118-0-35" id="h118-0-35" class="i">+        .build()
</a><a href="#h118-0-36" id="h118-0-36" class="i">+
</a><a href="#h118-0-37" id="h118-0-37" class="i">+    private fun newResolveRequest(protoKey: ByteArray) = Request.Builder()
</a><a href="#h118-0-38" id="h118-0-38" class="i">+        .url(BOLT_HTTP_RESOLVER_URL + &quot;/resolve?co=&quot; + Base64.getUrlEncoder().encodeToString(protoKey))
</a><a href="#h118-0-39" id="h118-0-39" class="i">+        .addHeader(&quot;User-Agent&quot;, Constants.USER_AGENT)
</a><a href="#h118-0-40" id="h118-0-40" class="i">+        .build()
</a><a href="#h118-0-41" id="h118-0-41" class="i">+
</a><a href="#h118-0-42" id="h118-0-42" class="i">+    /**
</a><a href="#h118-0-43" id="h118-0-43" class="i">+     * Download bolt media with memory allocation
</a><a href="#h118-0-44" id="h118-0-44" class="i">+     */
</a><a href="#h118-0-45" id="h118-0-45" class="i">+    fun downloadBoltMedia(protoKey: ByteArray, decryptionCallback: (InputStream) -&gt; InputStream = { it }): ByteArray? {
</a><a href="#h118-0-46" id="h118-0-46" class="i">+        okHttpClient.newCall(newResolveRequest(protoKey)).execute().use { response -&gt;
</a><a href="#h118-0-47" id="h118-0-47" class="i">+            if (!response.isSuccessful) {
</a><a href="#h118-0-48" id="h118-0-48" class="i">+                AbstractLogger.directDebug(&quot;Unexpected code $response&quot;)
</a><a href="#h118-0-49" id="h118-0-49" class="i">+                return null
</a><a href="#h118-0-50" id="h118-0-50" class="i">+            }
</a><a href="#h118-0-51" id="h118-0-51" class="i">+            return decryptionCallback(response.body.byteStream()).readBytes()
</a><a href="#h118-0-52" id="h118-0-52" class="i">+        }
</a><a href="#h118-0-53" id="h118-0-53" class="i">+    }
</a><a href="#h118-0-54" id="h118-0-54" class="i">+    
</a><a href="#h118-0-55" id="h118-0-55" class="i">+    fun downloadBoltMedia(protoKey: ByteArray, decryptionCallback: (InputStream) -&gt; InputStream = { it }, resultCallback: (InputStream) -&gt; Unit) {
</a><a href="#h118-0-56" id="h118-0-56" class="i">+        okHttpClient.newCall(newResolveRequest(protoKey)).execute().use { response -&gt;
</a><a href="#h118-0-57" id="h118-0-57" class="i">+            if (!response.isSuccessful) {
</a><a href="#h118-0-58" id="h118-0-58" class="i">+                throw Throwable(&quot;invalid response ${response.code}&quot;)
</a><a href="#h118-0-59" id="h118-0-59" class="i">+            }
</a><a href="#h118-0-60" id="h118-0-60" class="i">+            resultCallback(
</a><a href="#h118-0-61" id="h118-0-61" class="i">+                decryptionCallback(
</a><a href="#h118-0-62" id="h118-0-62" class="i">+                    response.body.byteStream()
</a><a href="#h118-0-63" id="h118-0-63" class="i">+                )
</a><a href="#h118-0-64" id="h118-0-64" class="i">+            )
</a><a href="#h118-0-65" id="h118-0-65" class="i">+        }
</a><a href="#h118-0-66" id="h118-0-66" class="i">+    }
</a><a href="#h118-0-67" id="h118-0-67" class="i">+}
</a><b>diff --git a/<a id="h119" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/util/snap/SnapWidgetBroadcastReceiverHelper.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/util/snap/SnapWidgetBroadcastReceiverHelper.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/util/snap/SnapWidgetBroadcastReceiverHelper.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/util/snap/SnapWidgetBroadcastReceiverHelper.kt</a></b>
<a href="#h119-0" id="h119-0" class="h">@@ -0,0 +1,24 @@
</a><a href="#h119-0-0" id="h119-0-0" class="i">+package me.rhunk.snapenhance.common.util.snap
</a><a href="#h119-0-1" id="h119-0-1" class="i">+
</a><a href="#h119-0-2" id="h119-0-2" class="i">+import android.content.Intent
</a><a href="#h119-0-3" id="h119-0-3" class="i">+import me.rhunk.snapenhance.common.Constants
</a><a href="#h119-0-4" id="h119-0-4" class="i">+
</a><a href="#h119-0-5" id="h119-0-5" class="i">+object SnapWidgetBroadcastReceiverHelper {
</a><a href="#h119-0-6" id="h119-0-6" class="i">+    private const val ACTION_WIDGET_UPDATE = &quot;com.snap.android.WIDGET_APP_START_UPDATE_ACTION&quot;
</a><a href="#h119-0-7" id="h119-0-7" class="i">+    const val CLASS_NAME = &quot;com.snap.widgets.core.BestFriendsWidgetProvider&quot;
</a><a href="#h119-0-8" id="h119-0-8" class="i">+
</a><a href="#h119-0-9" id="h119-0-9" class="i">+    fun create(targetAction: String, callback: Intent.() -&gt; Unit): Intent {
</a><a href="#h119-0-10" id="h119-0-10" class="i">+        with(Intent()) {
</a><a href="#h119-0-11" id="h119-0-11" class="i">+            callback(this)
</a><a href="#h119-0-12" id="h119-0-12" class="i">+            action = ACTION_WIDGET_UPDATE
</a><a href="#h119-0-13" id="h119-0-13" class="i">+            putExtra(&quot;:)&quot;, true)
</a><a href="#h119-0-14" id="h119-0-14" class="i">+            putExtra(&quot;action&quot;, targetAction)
</a><a href="#h119-0-15" id="h119-0-15" class="i">+            setClassName(Constants.SNAPCHAT_PACKAGE_NAME, CLASS_NAME)
</a><a href="#h119-0-16" id="h119-0-16" class="i">+            return this
</a><a href="#h119-0-17" id="h119-0-17" class="i">+        }
</a><a href="#h119-0-18" id="h119-0-18" class="i">+    }
</a><a href="#h119-0-19" id="h119-0-19" class="i">+
</a><a href="#h119-0-20" id="h119-0-20" class="i">+    fun isIncomingIntentValid(intent: Intent): Boolean {
</a><a href="#h119-0-21" id="h119-0-21" class="i">+        return intent.action == ACTION_WIDGET_UPDATE &amp;&amp; intent.getBooleanExtra(&quot;:)&quot;, false)
</a><a href="#h119-0-22" id="h119-0-22" class="i">+    }
</a><a href="#h119-0-23" id="h119-0-23" class="i">+}</a><a href="#h119-0-24" id="h119-0-24" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h120" href="../file/core/build.gradle.kts.html">core/build.gradle.kts</a> b/<a href="../file/core/build.gradle.kts.html">core/build.gradle.kts</a></b>
<a href="#h120-0" id="h120-0" class="h">@@ -7,17 +7,8 @@ android {
</a>     namespace = rootProject.ext[&quot;applicationId&quot;].toString() + &quot;.core&quot;
     compileSdk = 34
 
<a href="#h120-0-3" id="h120-0-3" class="d">-    buildFeatures {
</a><a href="#h120-0-4" id="h120-0-4" class="d">-        aidl = true
</a><a href="#h120-0-5" id="h120-0-5" class="d">-        buildConfig = true
</a><a href="#h120-0-6" id="h120-0-6" class="d">-    }
</a><a href="#h120-0-7" id="h120-0-7" class="d">-
</a>     defaultConfig {
         minSdk = 28
<a href="#h120-0-10" id="h120-0-10" class="d">-        buildConfigField(&quot;String&quot;, &quot;VERSION_NAME&quot;, &quot;\&quot;${rootProject.ext[&quot;appVersionName&quot;]}\&quot;&quot;)
</a><a href="#h120-0-11" id="h120-0-11" class="d">-        buildConfigField(&quot;int&quot;, &quot;VERSION_CODE&quot;, &quot;${rootProject.ext[&quot;appVersionCode&quot;]}&quot;)
</a><a href="#h120-0-12" id="h120-0-12" class="d">-        buildConfigField(&quot;String&quot;, &quot;APPLICATION_ID&quot;, &quot;\&quot;${rootProject.ext[&quot;applicationId&quot;]}\&quot;&quot;)
</a><a href="#h120-0-13" id="h120-0-13" class="d">-        buildConfigField(&quot;int&quot;, &quot;BUILD_DATE&quot;, &quot;${System.currentTimeMillis() / 1000}&quot;)
</a>     }
 
     kotlinOptions {
<a href="#h120-1" id="h120-1" class="h">@@ -25,13 +16,6 @@ android {
</a>     }
 }
 
<a href="#h120-1-3" id="h120-1-3" class="d">-tasks.register(&quot;getVersion&quot;) {
</a><a href="#h120-1-4" id="h120-1-4" class="d">-    doLast {
</a><a href="#h120-1-5" id="h120-1-5" class="d">-        val versionFile = File(&quot;app/build/version.txt&quot;)
</a><a href="#h120-1-6" id="h120-1-6" class="d">-        versionFile.writeText(rootProject.ext[&quot;appVersionName&quot;].toString())
</a><a href="#h120-1-7" id="h120-1-7" class="d">-    }
</a><a href="#h120-1-8" id="h120-1-8" class="d">-}
</a><a href="#h120-1-9" id="h120-1-9" class="d">-
</a> dependencies {
     compileOnly(files(&quot;libs/LSPosed-api-1.0-SNAPSHOT.jar&quot;))
     implementation(libs.coroutines)
<a href="#h120-2" id="h120-2" class="h">@@ -41,6 +25,7 @@ dependencies {
</a>     implementation(libs.androidx.documentfile)
     implementation(libs.rhino)
 
<a href="#h120-2-3" id="h120-2-3" class="i">+    implementation(project(&quot;:common&quot;))
</a>     implementation(project(&quot;:stub&quot;))
     implementation(project(&quot;:mapper&quot;))
     implementation(project(&quot;:native&quot;))
<b>diff --git a/<a id="h121" href="../file/core/src/main/assets/xposed_init.html">core/src/main/assets/xposed_init</a> b/<a href="../file/core/src/main/assets/xposed_init.html">core/src/main/assets/xposed_init</a></b>
<a href="#h121-0" id="h121-0" class="h">@@ -1 +1 @@
</a><a href="#h121-0-0" id="h121-0-0" class="d">-me.rhunk.snapenhance.XposedLoader</a><a href="#h121-0-1" id="h121-0-1" class="d">-
\ No newline at end of file
</a><a href="#h121-0-2" id="h121-0-2" class="i">+me.rhunk.snapenhance.core.XposedLoader</a><a href="#h121-0-3" id="h121-0-3" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h122" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/Constants.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/Constants.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/Constants.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/Constants.kt</a></b>
<a href="#h122-0" id="h122-0" class="h">@@ -1,9 +0,0 @@
</a><a href="#h122-0-0" id="h122-0-0" class="d">-package me.rhunk.snapenhance
</a><a href="#h122-0-1" id="h122-0-1" class="d">-
</a><a href="#h122-0-2" id="h122-0-2" class="d">-object Constants {
</a><a href="#h122-0-3" id="h122-0-3" class="d">-    const val SNAPCHAT_PACKAGE_NAME = &quot;com.snapchat.android&quot;
</a><a href="#h122-0-4" id="h122-0-4" class="d">-
</a><a href="#h122-0-5" id="h122-0-5" class="d">-    val ARROYO_MEDIA_CONTAINER_PROTO_PATH = intArrayOf(4, 4)
</a><a href="#h122-0-6" id="h122-0-6" class="d">-
</a><a href="#h122-0-7" id="h122-0-7" class="d">-    const val USER_AGENT = &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36&quot;
</a><a href="#h122-0-8" id="h122-0-8" class="d">-}</a><a href="#h122-0-9" id="h122-0-9" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h123" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/ModContext.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/ModContext.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/ModContext.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/ModContext.kt</a></b>
<a href="#h123-0" id="h123-0" class="h">@@ -1,155 +0,0 @@
</a><a href="#h123-0-0" id="h123-0-0" class="d">-package me.rhunk.snapenhance
</a><a href="#h123-0-1" id="h123-0-1" class="d">-
</a><a href="#h123-0-2" id="h123-0-2" class="d">-import android.app.Activity
</a><a href="#h123-0-3" id="h123-0-3" class="d">-import android.content.ClipData
</a><a href="#h123-0-4" id="h123-0-4" class="d">-import android.content.Context
</a><a href="#h123-0-5" id="h123-0-5" class="d">-import android.content.Intent
</a><a href="#h123-0-6" id="h123-0-6" class="d">-import android.content.res.Resources
</a><a href="#h123-0-7" id="h123-0-7" class="d">-import android.os.Handler
</a><a href="#h123-0-8" id="h123-0-8" class="d">-import android.os.Looper
</a><a href="#h123-0-9" id="h123-0-9" class="d">-import android.os.Process
</a><a href="#h123-0-10" id="h123-0-10" class="d">-import android.widget.Toast
</a><a href="#h123-0-11" id="h123-0-11" class="d">-import com.google.gson.Gson
</a><a href="#h123-0-12" id="h123-0-12" class="d">-import com.google.gson.GsonBuilder
</a><a href="#h123-0-13" id="h123-0-13" class="d">-import kotlinx.coroutines.CoroutineScope
</a><a href="#h123-0-14" id="h123-0-14" class="d">-import kotlinx.coroutines.Dispatchers
</a><a href="#h123-0-15" id="h123-0-15" class="d">-import kotlinx.coroutines.launch
</a><a href="#h123-0-16" id="h123-0-16" class="d">-import me.rhunk.snapenhance.core.Logger
</a><a href="#h123-0-17" id="h123-0-17" class="d">-import me.rhunk.snapenhance.core.bridge.BridgeClient
</a><a href="#h123-0-18" id="h123-0-18" class="d">-import me.rhunk.snapenhance.core.bridge.wrapper.LocaleWrapper
</a><a href="#h123-0-19" id="h123-0-19" class="d">-import me.rhunk.snapenhance.core.bridge.wrapper.MappingsWrapper
</a><a href="#h123-0-20" id="h123-0-20" class="d">-import me.rhunk.snapenhance.core.config.ModConfig
</a><a href="#h123-0-21" id="h123-0-21" class="d">-import me.rhunk.snapenhance.core.database.DatabaseAccess
</a><a href="#h123-0-22" id="h123-0-22" class="d">-import me.rhunk.snapenhance.core.event.EventBus
</a><a href="#h123-0-23" id="h123-0-23" class="d">-import me.rhunk.snapenhance.core.event.EventDispatcher
</a><a href="#h123-0-24" id="h123-0-24" class="d">-import me.rhunk.snapenhance.core.util.download.HttpServer
</a><a href="#h123-0-25" id="h123-0-25" class="d">-import me.rhunk.snapenhance.data.MessageSender
</a><a href="#h123-0-26" id="h123-0-26" class="d">-import me.rhunk.snapenhance.features.Feature
</a><a href="#h123-0-27" id="h123-0-27" class="d">-import me.rhunk.snapenhance.manager.impl.ActionManager
</a><a href="#h123-0-28" id="h123-0-28" class="d">-import me.rhunk.snapenhance.manager.impl.FeatureManager
</a><a href="#h123-0-29" id="h123-0-29" class="d">-import me.rhunk.snapenhance.nativelib.NativeConfig
</a><a href="#h123-0-30" id="h123-0-30" class="d">-import me.rhunk.snapenhance.nativelib.NativeLib
</a><a href="#h123-0-31" id="h123-0-31" class="d">-import me.rhunk.snapenhance.scripting.core.CoreScriptRuntime
</a><a href="#h123-0-32" id="h123-0-32" class="d">-import kotlin.reflect.KClass
</a><a href="#h123-0-33" id="h123-0-33" class="d">-import kotlin.system.exitProcess
</a><a href="#h123-0-34" id="h123-0-34" class="d">-
</a><a href="#h123-0-35" id="h123-0-35" class="d">-class ModContext {
</a><a href="#h123-0-36" id="h123-0-36" class="d">-    val coroutineScope = CoroutineScope(Dispatchers.IO)
</a><a href="#h123-0-37" id="h123-0-37" class="d">-
</a><a href="#h123-0-38" id="h123-0-38" class="d">-    lateinit var androidContext: Context
</a><a href="#h123-0-39" id="h123-0-39" class="d">-    lateinit var bridgeClient: BridgeClient
</a><a href="#h123-0-40" id="h123-0-40" class="d">-    var mainActivity: Activity? = null
</a><a href="#h123-0-41" id="h123-0-41" class="d">-
</a><a href="#h123-0-42" id="h123-0-42" class="d">-    val classCache get() = SnapEnhance.classCache
</a><a href="#h123-0-43" id="h123-0-43" class="d">-    val resources: Resources get() = androidContext.resources
</a><a href="#h123-0-44" id="h123-0-44" class="d">-    val gson: Gson = GsonBuilder().create()
</a><a href="#h123-0-45" id="h123-0-45" class="d">-
</a><a href="#h123-0-46" id="h123-0-46" class="d">-    private val _config = ModConfig()
</a><a href="#h123-0-47" id="h123-0-47" class="d">-    val config by _config::root
</a><a href="#h123-0-48" id="h123-0-48" class="d">-    val log by lazy { Logger(this.bridgeClient) }
</a><a href="#h123-0-49" id="h123-0-49" class="d">-    val translation = LocaleWrapper()
</a><a href="#h123-0-50" id="h123-0-50" class="d">-    val httpServer = HttpServer()
</a><a href="#h123-0-51" id="h123-0-51" class="d">-    val messageSender = MessageSender(this)
</a><a href="#h123-0-52" id="h123-0-52" class="d">-
</a><a href="#h123-0-53" id="h123-0-53" class="d">-    val features = FeatureManager(this)
</a><a href="#h123-0-54" id="h123-0-54" class="d">-    val mappings = MappingsWrapper()
</a><a href="#h123-0-55" id="h123-0-55" class="d">-    val actionManager = ActionManager(this)
</a><a href="#h123-0-56" id="h123-0-56" class="d">-    val database = DatabaseAccess(this)
</a><a href="#h123-0-57" id="h123-0-57" class="d">-    val event = EventBus(this)
</a><a href="#h123-0-58" id="h123-0-58" class="d">-    val eventDispatcher = EventDispatcher(this)
</a><a href="#h123-0-59" id="h123-0-59" class="d">-    val native = NativeLib()
</a><a href="#h123-0-60" id="h123-0-60" class="d">-    val scriptRuntime by lazy { CoreScriptRuntime(androidContext, log) }
</a><a href="#h123-0-61" id="h123-0-61" class="d">-
</a><a href="#h123-0-62" id="h123-0-62" class="d">-    val isDeveloper by lazy { config.scripting.developerMode.get() }
</a><a href="#h123-0-63" id="h123-0-63" class="d">-
</a><a href="#h123-0-64" id="h123-0-64" class="d">-    fun &lt;T : Feature&gt; feature(featureClass: KClass&lt;T&gt;): T {
</a><a href="#h123-0-65" id="h123-0-65" class="d">-        return features.get(featureClass)!!
</a><a href="#h123-0-66" id="h123-0-66" class="d">-    }
</a><a href="#h123-0-67" id="h123-0-67" class="d">-
</a><a href="#h123-0-68" id="h123-0-68" class="d">-    fun runOnUiThread(runnable: () -&gt; Unit) {
</a><a href="#h123-0-69" id="h123-0-69" class="d">-        if (Looper.myLooper() == Looper.getMainLooper()) {
</a><a href="#h123-0-70" id="h123-0-70" class="d">-            runnable()
</a><a href="#h123-0-71" id="h123-0-71" class="d">-            return
</a><a href="#h123-0-72" id="h123-0-72" class="d">-        }
</a><a href="#h123-0-73" id="h123-0-73" class="d">-        Handler(Looper.getMainLooper()).post {
</a><a href="#h123-0-74" id="h123-0-74" class="d">-            runCatching(runnable).onFailure {
</a><a href="#h123-0-75" id="h123-0-75" class="d">-                Logger.xposedLog(&quot;UI thread runnable failed&quot;, it)
</a><a href="#h123-0-76" id="h123-0-76" class="d">-            }
</a><a href="#h123-0-77" id="h123-0-77" class="d">-        }
</a><a href="#h123-0-78" id="h123-0-78" class="d">-    }
</a><a href="#h123-0-79" id="h123-0-79" class="d">-
</a><a href="#h123-0-80" id="h123-0-80" class="d">-    fun executeAsync(runnable: suspend ModContext.() -&gt; Unit) {
</a><a href="#h123-0-81" id="h123-0-81" class="d">-        coroutineScope.launch {
</a><a href="#h123-0-82" id="h123-0-82" class="d">-            runCatching {
</a><a href="#h123-0-83" id="h123-0-83" class="d">-                runnable()
</a><a href="#h123-0-84" id="h123-0-84" class="d">-            }.onFailure {
</a><a href="#h123-0-85" id="h123-0-85" class="d">-                longToast(&quot;Async task failed &quot; + it.message)
</a><a href="#h123-0-86" id="h123-0-86" class="d">-                log.error(&quot;Async task failed&quot;, it)
</a><a href="#h123-0-87" id="h123-0-87" class="d">-            }
</a><a href="#h123-0-88" id="h123-0-88" class="d">-        }
</a><a href="#h123-0-89" id="h123-0-89" class="d">-    }
</a><a href="#h123-0-90" id="h123-0-90" class="d">-
</a><a href="#h123-0-91" id="h123-0-91" class="d">-    fun shortToast(message: Any?) {
</a><a href="#h123-0-92" id="h123-0-92" class="d">-        runOnUiThread {
</a><a href="#h123-0-93" id="h123-0-93" class="d">-            Toast.makeText(androidContext, message.toString(), Toast.LENGTH_SHORT).show()
</a><a href="#h123-0-94" id="h123-0-94" class="d">-        }
</a><a href="#h123-0-95" id="h123-0-95" class="d">-    }
</a><a href="#h123-0-96" id="h123-0-96" class="d">-
</a><a href="#h123-0-97" id="h123-0-97" class="d">-    fun longToast(message: Any?) {
</a><a href="#h123-0-98" id="h123-0-98" class="d">-        runOnUiThread {
</a><a href="#h123-0-99" id="h123-0-99" class="d">-            Toast.makeText(androidContext, message.toString(), Toast.LENGTH_LONG).show()
</a><a href="#h123-0-100" id="h123-0-100" class="d">-        }
</a><a href="#h123-0-101" id="h123-0-101" class="d">-    }
</a><a href="#h123-0-102" id="h123-0-102" class="d">-
</a><a href="#h123-0-103" id="h123-0-103" class="d">-    fun softRestartApp(saveSettings: Boolean = false) {
</a><a href="#h123-0-104" id="h123-0-104" class="d">-        if (saveSettings) {
</a><a href="#h123-0-105" id="h123-0-105" class="d">-            _config.writeConfig()
</a><a href="#h123-0-106" id="h123-0-106" class="d">-        }
</a><a href="#h123-0-107" id="h123-0-107" class="d">-        val intent: Intent? = androidContext.packageManager.getLaunchIntentForPackage(
</a><a href="#h123-0-108" id="h123-0-108" class="d">-            Constants.SNAPCHAT_PACKAGE_NAME
</a><a href="#h123-0-109" id="h123-0-109" class="d">-        )
</a><a href="#h123-0-110" id="h123-0-110" class="d">-        intent?.let {
</a><a href="#h123-0-111" id="h123-0-111" class="d">-            val mainIntent = Intent.makeRestartActivityTask(intent.component)
</a><a href="#h123-0-112" id="h123-0-112" class="d">-            androidContext.startActivity(mainIntent)
</a><a href="#h123-0-113" id="h123-0-113" class="d">-        }
</a><a href="#h123-0-114" id="h123-0-114" class="d">-        exitProcess(1)
</a><a href="#h123-0-115" id="h123-0-115" class="d">-    }
</a><a href="#h123-0-116" id="h123-0-116" class="d">-
</a><a href="#h123-0-117" id="h123-0-117" class="d">-    fun crash(message: String, throwable: Throwable? = null) {
</a><a href="#h123-0-118" id="h123-0-118" class="d">-        logCritical(message, throwable ?: Throwable())
</a><a href="#h123-0-119" id="h123-0-119" class="d">-        delayForceCloseApp(100)
</a><a href="#h123-0-120" id="h123-0-120" class="d">-    }
</a><a href="#h123-0-121" id="h123-0-121" class="d">-
</a><a href="#h123-0-122" id="h123-0-122" class="d">-    fun logCritical(message: Any?, throwable: Throwable = Throwable()) {
</a><a href="#h123-0-123" id="h123-0-123" class="d">-        log.error(message ?: &quot;Snapchat crash&quot;, throwable)
</a><a href="#h123-0-124" id="h123-0-124" class="d">-        longToast(message ?: &quot;Snapchat has crashed! Please check logs for more details.&quot;)
</a><a href="#h123-0-125" id="h123-0-125" class="d">-    }
</a><a href="#h123-0-126" id="h123-0-126" class="d">-
</a><a href="#h123-0-127" id="h123-0-127" class="d">-    private fun delayForceCloseApp(delay: Long) = Handler(Looper.getMainLooper()).postDelayed({
</a><a href="#h123-0-128" id="h123-0-128" class="d">-        forceCloseApp()
</a><a href="#h123-0-129" id="h123-0-129" class="d">-    }, delay)
</a><a href="#h123-0-130" id="h123-0-130" class="d">-
</a><a href="#h123-0-131" id="h123-0-131" class="d">-    fun forceCloseApp() {
</a><a href="#h123-0-132" id="h123-0-132" class="d">-        Process.killProcess(Process.myPid())
</a><a href="#h123-0-133" id="h123-0-133" class="d">-        exitProcess(1)
</a><a href="#h123-0-134" id="h123-0-134" class="d">-    }
</a><a href="#h123-0-135" id="h123-0-135" class="d">-
</a><a href="#h123-0-136" id="h123-0-136" class="d">-    fun reloadConfig() {
</a><a href="#h123-0-137" id="h123-0-137" class="d">-        log.verbose(&quot;reloading config&quot;)
</a><a href="#h123-0-138" id="h123-0-138" class="d">-        _config.loadFromBridge(bridgeClient)
</a><a href="#h123-0-139" id="h123-0-139" class="d">-        native.loadNativeConfig(
</a><a href="#h123-0-140" id="h123-0-140" class="d">-            NativeConfig(
</a><a href="#h123-0-141" id="h123-0-141" class="d">-                disableBitmoji = config.experimental.nativeHooks.disableBitmoji.get(),
</a><a href="#h123-0-142" id="h123-0-142" class="d">-                disableMetrics = config.global.disableMetrics.get()
</a><a href="#h123-0-143" id="h123-0-143" class="d">-            )
</a><a href="#h123-0-144" id="h123-0-144" class="d">-        )
</a><a href="#h123-0-145" id="h123-0-145" class="d">-    }
</a><a href="#h123-0-146" id="h123-0-146" class="d">-
</a><a href="#h123-0-147" id="h123-0-147" class="d">-    fun getConfigLocale(): String {
</a><a href="#h123-0-148" id="h123-0-148" class="d">-        return _config.locale
</a><a href="#h123-0-149" id="h123-0-149" class="d">-    }
</a><a href="#h123-0-150" id="h123-0-150" class="d">-
</a><a href="#h123-0-151" id="h123-0-151" class="d">-    fun copyToClipboard(data: String, label: String = &quot;Copied Text&quot;) {
</a><a href="#h123-0-152" id="h123-0-152" class="d">-        androidContext.getSystemService(android.content.ClipboardManager::class.java).setPrimaryClip(ClipData.newPlainText(label, data))
</a><a href="#h123-0-153" id="h123-0-153" class="d">-    }
</a><a href="#h123-0-154" id="h123-0-154" class="d">-}</a><a href="#h123-0-155" id="h123-0-155" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h124" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/SnapEnhance.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/SnapEnhance.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/SnapEnhance.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/SnapEnhance.kt</a></b>
<a href="#h124-0" id="h124-0" class="h">@@ -1,253 +0,0 @@
</a><a href="#h124-0-0" id="h124-0-0" class="d">-package me.rhunk.snapenhance
</a><a href="#h124-0-1" id="h124-0-1" class="d">-
</a><a href="#h124-0-2" id="h124-0-2" class="d">-import android.app.Activity
</a><a href="#h124-0-3" id="h124-0-3" class="d">-import android.app.Application
</a><a href="#h124-0-4" id="h124-0-4" class="d">-import android.content.Context
</a><a href="#h124-0-5" id="h124-0-5" class="d">-import kotlinx.coroutines.CoroutineScope
</a><a href="#h124-0-6" id="h124-0-6" class="d">-import kotlinx.coroutines.Dispatchers
</a><a href="#h124-0-7" id="h124-0-7" class="d">-import kotlinx.coroutines.launch
</a><a href="#h124-0-8" id="h124-0-8" class="d">-import kotlinx.coroutines.runBlocking
</a><a href="#h124-0-9" id="h124-0-9" class="d">-import me.rhunk.snapenhance.action.EnumAction
</a><a href="#h124-0-10" id="h124-0-10" class="d">-import me.rhunk.snapenhance.bridge.ConfigStateListener
</a><a href="#h124-0-11" id="h124-0-11" class="d">-import me.rhunk.snapenhance.bridge.SyncCallback
</a><a href="#h124-0-12" id="h124-0-12" class="d">-import me.rhunk.snapenhance.core.bridge.BridgeClient
</a><a href="#h124-0-13" id="h124-0-13" class="d">-import me.rhunk.snapenhance.core.event.events.impl.SnapWidgetBroadcastReceiveEvent
</a><a href="#h124-0-14" id="h124-0-14" class="d">-import me.rhunk.snapenhance.core.event.events.impl.UnaryCallEvent
</a><a href="#h124-0-15" id="h124-0-15" class="d">-import me.rhunk.snapenhance.core.messaging.MessagingFriendInfo
</a><a href="#h124-0-16" id="h124-0-16" class="d">-import me.rhunk.snapenhance.core.messaging.MessagingGroupInfo
</a><a href="#h124-0-17" id="h124-0-17" class="d">-import me.rhunk.snapenhance.data.SnapClassCache
</a><a href="#h124-0-18" id="h124-0-18" class="d">-import me.rhunk.snapenhance.hook.HookStage
</a><a href="#h124-0-19" id="h124-0-19" class="d">-import me.rhunk.snapenhance.hook.hook
</a><a href="#h124-0-20" id="h124-0-20" class="d">-import kotlin.system.measureTimeMillis
</a><a href="#h124-0-21" id="h124-0-21" class="d">-
</a><a href="#h124-0-22" id="h124-0-22" class="d">-
</a><a href="#h124-0-23" id="h124-0-23" class="d">-class SnapEnhance {
</a><a href="#h124-0-24" id="h124-0-24" class="d">-    companion object {
</a><a href="#h124-0-25" id="h124-0-25" class="d">-        lateinit var classLoader: ClassLoader
</a><a href="#h124-0-26" id="h124-0-26" class="d">-            private set
</a><a href="#h124-0-27" id="h124-0-27" class="d">-        val classCache by lazy {
</a><a href="#h124-0-28" id="h124-0-28" class="d">-            SnapClassCache(classLoader)
</a><a href="#h124-0-29" id="h124-0-29" class="d">-        }
</a><a href="#h124-0-30" id="h124-0-30" class="d">-    }
</a><a href="#h124-0-31" id="h124-0-31" class="d">-    private val appContext = ModContext()
</a><a href="#h124-0-32" id="h124-0-32" class="d">-    private var isBridgeInitialized = false
</a><a href="#h124-0-33" id="h124-0-33" class="d">-    private var isActivityPaused = false
</a><a href="#h124-0-34" id="h124-0-34" class="d">-
</a><a href="#h124-0-35" id="h124-0-35" class="d">-    private fun hookMainActivity(methodName: String, stage: HookStage = HookStage.AFTER, block: Activity.() -&gt; Unit) {
</a><a href="#h124-0-36" id="h124-0-36" class="d">-        Activity::class.java.hook(methodName, stage, { isBridgeInitialized }) { param -&gt;
</a><a href="#h124-0-37" id="h124-0-37" class="d">-            val activity = param.thisObject() as Activity
</a><a href="#h124-0-38" id="h124-0-38" class="d">-            if (!activity.packageName.equals(Constants.SNAPCHAT_PACKAGE_NAME)) return@hook
</a><a href="#h124-0-39" id="h124-0-39" class="d">-            block(activity)
</a><a href="#h124-0-40" id="h124-0-40" class="d">-        }
</a><a href="#h124-0-41" id="h124-0-41" class="d">-    }
</a><a href="#h124-0-42" id="h124-0-42" class="d">-
</a><a href="#h124-0-43" id="h124-0-43" class="d">-    init {
</a><a href="#h124-0-44" id="h124-0-44" class="d">-        Application::class.java.hook(&quot;attach&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h124-0-45" id="h124-0-45" class="d">-            appContext.apply {
</a><a href="#h124-0-46" id="h124-0-46" class="d">-                androidContext = param.arg&lt;Context&gt;(0).also {
</a><a href="#h124-0-47" id="h124-0-47" class="d">-                    classLoader = it.classLoader
</a><a href="#h124-0-48" id="h124-0-48" class="d">-                }
</a><a href="#h124-0-49" id="h124-0-49" class="d">-                bridgeClient = BridgeClient(appContext)
</a><a href="#h124-0-50" id="h124-0-50" class="d">-                bridgeClient.apply {
</a><a href="#h124-0-51" id="h124-0-51" class="d">-                    connect(
</a><a href="#h124-0-52" id="h124-0-52" class="d">-                        timeout = {
</a><a href="#h124-0-53" id="h124-0-53" class="d">-                            crash(&quot;SnapEnhance bridge service is not responding. Please download stable version from https://github.com/rhunk/SnapEnhance/releases&quot;, it)
</a><a href="#h124-0-54" id="h124-0-54" class="d">-                        }
</a><a href="#h124-0-55" id="h124-0-55" class="d">-                    ) { bridgeResult -&gt;
</a><a href="#h124-0-56" id="h124-0-56" class="d">-                        if (!bridgeResult) {
</a><a href="#h124-0-57" id="h124-0-57" class="d">-                            logCritical(&quot;Cannot connect to bridge service&quot;)
</a><a href="#h124-0-58" id="h124-0-58" class="d">-                            softRestartApp()
</a><a href="#h124-0-59" id="h124-0-59" class="d">-                            return@connect
</a><a href="#h124-0-60" id="h124-0-60" class="d">-                        }
</a><a href="#h124-0-61" id="h124-0-61" class="d">-                        runCatching {
</a><a href="#h124-0-62" id="h124-0-62" class="d">-                            measureTimeMillis {
</a><a href="#h124-0-63" id="h124-0-63" class="d">-                                runBlocking {
</a><a href="#h124-0-64" id="h124-0-64" class="d">-                                    init(this)
</a><a href="#h124-0-65" id="h124-0-65" class="d">-                                }
</a><a href="#h124-0-66" id="h124-0-66" class="d">-                            }.also {
</a><a href="#h124-0-67" id="h124-0-67" class="d">-                                appContext.log.verbose(&quot;init took ${it}ms&quot;)
</a><a href="#h124-0-68" id="h124-0-68" class="d">-                            }
</a><a href="#h124-0-69" id="h124-0-69" class="d">-                        }.onSuccess {
</a><a href="#h124-0-70" id="h124-0-70" class="d">-                            isBridgeInitialized = true
</a><a href="#h124-0-71" id="h124-0-71" class="d">-                        }.onFailure {
</a><a href="#h124-0-72" id="h124-0-72" class="d">-                            logCritical(&quot;Failed to initialize bridge&quot;, it)
</a><a href="#h124-0-73" id="h124-0-73" class="d">-                        }
</a><a href="#h124-0-74" id="h124-0-74" class="d">-                    }
</a><a href="#h124-0-75" id="h124-0-75" class="d">-                }
</a><a href="#h124-0-76" id="h124-0-76" class="d">-            }
</a><a href="#h124-0-77" id="h124-0-77" class="d">-        }
</a><a href="#h124-0-78" id="h124-0-78" class="d">-
</a><a href="#h124-0-79" id="h124-0-79" class="d">-        hookMainActivity(&quot;onCreate&quot;) {
</a><a href="#h124-0-80" id="h124-0-80" class="d">-            val isMainActivityNotNull = appContext.mainActivity != null
</a><a href="#h124-0-81" id="h124-0-81" class="d">-            appContext.mainActivity = this
</a><a href="#h124-0-82" id="h124-0-82" class="d">-            if (isMainActivityNotNull || !appContext.mappings.isMappingsLoaded()) return@hookMainActivity
</a><a href="#h124-0-83" id="h124-0-83" class="d">-            onActivityCreate()
</a><a href="#h124-0-84" id="h124-0-84" class="d">-        }
</a><a href="#h124-0-85" id="h124-0-85" class="d">-
</a><a href="#h124-0-86" id="h124-0-86" class="d">-        hookMainActivity(&quot;onPause&quot;) {
</a><a href="#h124-0-87" id="h124-0-87" class="d">-            appContext.bridgeClient.closeSettingsOverlay()
</a><a href="#h124-0-88" id="h124-0-88" class="d">-            isActivityPaused = true
</a><a href="#h124-0-89" id="h124-0-89" class="d">-        }
</a><a href="#h124-0-90" id="h124-0-90" class="d">-
</a><a href="#h124-0-91" id="h124-0-91" class="d">-        var activityWasResumed = false
</a><a href="#h124-0-92" id="h124-0-92" class="d">-        //we need to reload the config when the app is resumed
</a><a href="#h124-0-93" id="h124-0-93" class="d">-        //FIXME: called twice at first launch
</a><a href="#h124-0-94" id="h124-0-94" class="d">-        hookMainActivity(&quot;onResume&quot;) {
</a><a href="#h124-0-95" id="h124-0-95" class="d">-            isActivityPaused = false
</a><a href="#h124-0-96" id="h124-0-96" class="d">-            if (!activityWasResumed) {
</a><a href="#h124-0-97" id="h124-0-97" class="d">-                activityWasResumed = true
</a><a href="#h124-0-98" id="h124-0-98" class="d">-                return@hookMainActivity
</a><a href="#h124-0-99" id="h124-0-99" class="d">-            }
</a><a href="#h124-0-100" id="h124-0-100" class="d">-
</a><a href="#h124-0-101" id="h124-0-101" class="d">-            appContext.actionManager.onNewIntent(this.intent)
</a><a href="#h124-0-102" id="h124-0-102" class="d">-            appContext.reloadConfig()
</a><a href="#h124-0-103" id="h124-0-103" class="d">-            syncRemote()
</a><a href="#h124-0-104" id="h124-0-104" class="d">-        }
</a><a href="#h124-0-105" id="h124-0-105" class="d">-    }
</a><a href="#h124-0-106" id="h124-0-106" class="d">-
</a><a href="#h124-0-107" id="h124-0-107" class="d">-    private fun init(scope: CoroutineScope) {
</a><a href="#h124-0-108" id="h124-0-108" class="d">-        with(appContext) {
</a><a href="#h124-0-109" id="h124-0-109" class="d">-            Thread::class.java.hook(&quot;dispatchUncaughtException&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h124-0-110" id="h124-0-110" class="d">-                runCatching {
</a><a href="#h124-0-111" id="h124-0-111" class="d">-                    val throwable = param.argNullable(0) ?: Throwable()
</a><a href="#h124-0-112" id="h124-0-112" class="d">-                    logCritical(null, throwable)
</a><a href="#h124-0-113" id="h124-0-113" class="d">-                }
</a><a href="#h124-0-114" id="h124-0-114" class="d">-            }
</a><a href="#h124-0-115" id="h124-0-115" class="d">-
</a><a href="#h124-0-116" id="h124-0-116" class="d">-            reloadConfig()
</a><a href="#h124-0-117" id="h124-0-117" class="d">-            actionManager.init()
</a><a href="#h124-0-118" id="h124-0-118" class="d">-            initConfigListener()
</a><a href="#h124-0-119" id="h124-0-119" class="d">-            scope.launch(Dispatchers.IO) {
</a><a href="#h124-0-120" id="h124-0-120" class="d">-                initNative()
</a><a href="#h124-0-121" id="h124-0-121" class="d">-                translation.userLocale = getConfigLocale()
</a><a href="#h124-0-122" id="h124-0-122" class="d">-                translation.loadFromBridge(bridgeClient)
</a><a href="#h124-0-123" id="h124-0-123" class="d">-            }
</a><a href="#h124-0-124" id="h124-0-124" class="d">-
</a><a href="#h124-0-125" id="h124-0-125" class="d">-            mappings.loadFromBridge(bridgeClient)
</a><a href="#h124-0-126" id="h124-0-126" class="d">-            mappings.init(androidContext)
</a><a href="#h124-0-127" id="h124-0-127" class="d">-            eventDispatcher.init()
</a><a href="#h124-0-128" id="h124-0-128" class="d">-            //if mappings aren&#39;t loaded, we can&#39;t initialize features
</a><a href="#h124-0-129" id="h124-0-129" class="d">-            if (!mappings.isMappingsLoaded()) return
</a><a href="#h124-0-130" id="h124-0-130" class="d">-            features.init()
</a><a href="#h124-0-131" id="h124-0-131" class="d">-            scriptRuntime.connect(bridgeClient.getScriptingInterface())
</a><a href="#h124-0-132" id="h124-0-132" class="d">-            syncRemote()
</a><a href="#h124-0-133" id="h124-0-133" class="d">-        }
</a><a href="#h124-0-134" id="h124-0-134" class="d">-    }
</a><a href="#h124-0-135" id="h124-0-135" class="d">-
</a><a href="#h124-0-136" id="h124-0-136" class="d">-    private fun onActivityCreate() {
</a><a href="#h124-0-137" id="h124-0-137" class="d">-        measureTimeMillis {
</a><a href="#h124-0-138" id="h124-0-138" class="d">-            with(appContext) {
</a><a href="#h124-0-139" id="h124-0-139" class="d">-                features.onActivityCreate()
</a><a href="#h124-0-140" id="h124-0-140" class="d">-                scriptRuntime.eachModule { callFunction(&quot;module.onSnapActivity&quot;, mainActivity!!) }
</a><a href="#h124-0-141" id="h124-0-141" class="d">-            }
</a><a href="#h124-0-142" id="h124-0-142" class="d">-        }.also { time -&gt;
</a><a href="#h124-0-143" id="h124-0-143" class="d">-            appContext.log.verbose(&quot;onActivityCreate took $time&quot;)
</a><a href="#h124-0-144" id="h124-0-144" class="d">-        }
</a><a href="#h124-0-145" id="h124-0-145" class="d">-    }
</a><a href="#h124-0-146" id="h124-0-146" class="d">-
</a><a href="#h124-0-147" id="h124-0-147" class="d">-    private fun initNative() {
</a><a href="#h124-0-148" id="h124-0-148" class="d">-        // don&#39;t initialize native when not logged in
</a><a href="#h124-0-149" id="h124-0-149" class="d">-        if (!appContext.database.hasArroyo()) return
</a><a href="#h124-0-150" id="h124-0-150" class="d">-        appContext.native.apply {
</a><a href="#h124-0-151" id="h124-0-151" class="d">-            if (appContext.config.experimental.nativeHooks.globalState != true) return@apply
</a><a href="#h124-0-152" id="h124-0-152" class="d">-            initOnce(appContext.androidContext.classLoader)
</a><a href="#h124-0-153" id="h124-0-153" class="d">-            nativeUnaryCallCallback = { request -&gt;
</a><a href="#h124-0-154" id="h124-0-154" class="d">-                appContext.event.post(UnaryCallEvent(request.uri, request.buffer)) {
</a><a href="#h124-0-155" id="h124-0-155" class="d">-                    request.buffer = buffer
</a><a href="#h124-0-156" id="h124-0-156" class="d">-                    request.canceled = canceled
</a><a href="#h124-0-157" id="h124-0-157" class="d">-                }
</a><a href="#h124-0-158" id="h124-0-158" class="d">-            }
</a><a href="#h124-0-159" id="h124-0-159" class="d">-        }
</a><a href="#h124-0-160" id="h124-0-160" class="d">-    }
</a><a href="#h124-0-161" id="h124-0-161" class="d">-
</a><a href="#h124-0-162" id="h124-0-162" class="d">-    private fun initConfigListener() {
</a><a href="#h124-0-163" id="h124-0-163" class="d">-        val tasks = linkedSetOf&lt;() -&gt; Unit&gt;()
</a><a href="#h124-0-164" id="h124-0-164" class="d">-        hookMainActivity(&quot;onResume&quot;) {
</a><a href="#h124-0-165" id="h124-0-165" class="d">-            tasks.forEach { it() }
</a><a href="#h124-0-166" id="h124-0-166" class="d">-        }
</a><a href="#h124-0-167" id="h124-0-167" class="d">-
</a><a href="#h124-0-168" id="h124-0-168" class="d">-        fun runLater(task: () -&gt; Unit) {
</a><a href="#h124-0-169" id="h124-0-169" class="d">-            if (isActivityPaused) {
</a><a href="#h124-0-170" id="h124-0-170" class="d">-                tasks.add(task)
</a><a href="#h124-0-171" id="h124-0-171" class="d">-            } else {
</a><a href="#h124-0-172" id="h124-0-172" class="d">-                task()
</a><a href="#h124-0-173" id="h124-0-173" class="d">-            }
</a><a href="#h124-0-174" id="h124-0-174" class="d">-        }
</a><a href="#h124-0-175" id="h124-0-175" class="d">-
</a><a href="#h124-0-176" id="h124-0-176" class="d">-        appContext.apply {
</a><a href="#h124-0-177" id="h124-0-177" class="d">-            bridgeClient.registerConfigStateListener(object: ConfigStateListener.Stub() {
</a><a href="#h124-0-178" id="h124-0-178" class="d">-                override fun onConfigChanged() {
</a><a href="#h124-0-179" id="h124-0-179" class="d">-                    log.verbose(&quot;onConfigChanged&quot;)
</a><a href="#h124-0-180" id="h124-0-180" class="d">-                    reloadConfig()
</a><a href="#h124-0-181" id="h124-0-181" class="d">-                }
</a><a href="#h124-0-182" id="h124-0-182" class="d">-
</a><a href="#h124-0-183" id="h124-0-183" class="d">-                override fun onRestartRequired() {
</a><a href="#h124-0-184" id="h124-0-184" class="d">-                    log.verbose(&quot;onRestartRequired&quot;)
</a><a href="#h124-0-185" id="h124-0-185" class="d">-                    runLater {
</a><a href="#h124-0-186" id="h124-0-186" class="d">-                        log.verbose(&quot;softRestart&quot;)
</a><a href="#h124-0-187" id="h124-0-187" class="d">-                        softRestartApp(saveSettings = false)
</a><a href="#h124-0-188" id="h124-0-188" class="d">-                    }
</a><a href="#h124-0-189" id="h124-0-189" class="d">-                }
</a><a href="#h124-0-190" id="h124-0-190" class="d">-
</a><a href="#h124-0-191" id="h124-0-191" class="d">-                override fun onCleanCacheRequired() {
</a><a href="#h124-0-192" id="h124-0-192" class="d">-                    log.verbose(&quot;onCleanCacheRequired&quot;)
</a><a href="#h124-0-193" id="h124-0-193" class="d">-                    tasks.clear()
</a><a href="#h124-0-194" id="h124-0-194" class="d">-                    runLater {
</a><a href="#h124-0-195" id="h124-0-195" class="d">-                        log.verbose(&quot;cleanCache&quot;)
</a><a href="#h124-0-196" id="h124-0-196" class="d">-                        actionManager.execute(EnumAction.CLEAN_CACHE)
</a><a href="#h124-0-197" id="h124-0-197" class="d">-                    }
</a><a href="#h124-0-198" id="h124-0-198" class="d">-                }
</a><a href="#h124-0-199" id="h124-0-199" class="d">-            })
</a><a href="#h124-0-200" id="h124-0-200" class="d">-        }
</a><a href="#h124-0-201" id="h124-0-201" class="d">-
</a><a href="#h124-0-202" id="h124-0-202" class="d">-    }
</a><a href="#h124-0-203" id="h124-0-203" class="d">-
</a><a href="#h124-0-204" id="h124-0-204" class="d">-    private fun syncRemote() {
</a><a href="#h124-0-205" id="h124-0-205" class="d">-        appContext.executeAsync {
</a><a href="#h124-0-206" id="h124-0-206" class="d">-            bridgeClient.sync(object : SyncCallback.Stub() {
</a><a href="#h124-0-207" id="h124-0-207" class="d">-                override fun syncFriend(uuid: String): String? {
</a><a href="#h124-0-208" id="h124-0-208" class="d">-                    return database.getFriendInfo(uuid)?.toJson()
</a><a href="#h124-0-209" id="h124-0-209" class="d">-                }
</a><a href="#h124-0-210" id="h124-0-210" class="d">-
</a><a href="#h124-0-211" id="h124-0-211" class="d">-                override fun syncGroup(uuid: String): String? {
</a><a href="#h124-0-212" id="h124-0-212" class="d">-                    return database.getFeedEntryByConversationId(uuid)?.let {
</a><a href="#h124-0-213" id="h124-0-213" class="d">-                        MessagingGroupInfo(
</a><a href="#h124-0-214" id="h124-0-214" class="d">-                            it.key!!,
</a><a href="#h124-0-215" id="h124-0-215" class="d">-                            it.feedDisplayName!!,
</a><a href="#h124-0-216" id="h124-0-216" class="d">-                            it.participantsSize
</a><a href="#h124-0-217" id="h124-0-217" class="d">-                        ).toJson()
</a><a href="#h124-0-218" id="h124-0-218" class="d">-                    }
</a><a href="#h124-0-219" id="h124-0-219" class="d">-                }
</a><a href="#h124-0-220" id="h124-0-220" class="d">-            })
</a><a href="#h124-0-221" id="h124-0-221" class="d">-
</a><a href="#h124-0-222" id="h124-0-222" class="d">-            event.subscribe(SnapWidgetBroadcastReceiveEvent::class) { event -&gt;
</a><a href="#h124-0-223" id="h124-0-223" class="d">-                if (event.action != BridgeClient.BRIDGE_SYNC_ACTION) return@subscribe
</a><a href="#h124-0-224" id="h124-0-224" class="d">-                event.canceled = true
</a><a href="#h124-0-225" id="h124-0-225" class="d">-                val feedEntries = appContext.database.getFeedEntries(Int.MAX_VALUE)
</a><a href="#h124-0-226" id="h124-0-226" class="d">-
</a><a href="#h124-0-227" id="h124-0-227" class="d">-                val groups = feedEntries.filter { it.friendUserId == null }.map {
</a><a href="#h124-0-228" id="h124-0-228" class="d">-                    MessagingGroupInfo(
</a><a href="#h124-0-229" id="h124-0-229" class="d">-                        it.key!!,
</a><a href="#h124-0-230" id="h124-0-230" class="d">-                        it.feedDisplayName!!,
</a><a href="#h124-0-231" id="h124-0-231" class="d">-                        it.participantsSize
</a><a href="#h124-0-232" id="h124-0-232" class="d">-                    )
</a><a href="#h124-0-233" id="h124-0-233" class="d">-                }
</a><a href="#h124-0-234" id="h124-0-234" class="d">-
</a><a href="#h124-0-235" id="h124-0-235" class="d">-                val friends = feedEntries.filter { it.friendUserId != null }.map {
</a><a href="#h124-0-236" id="h124-0-236" class="d">-                    MessagingFriendInfo(
</a><a href="#h124-0-237" id="h124-0-237" class="d">-                        it.friendUserId!!,
</a><a href="#h124-0-238" id="h124-0-238" class="d">-                        it.friendDisplayName,
</a><a href="#h124-0-239" id="h124-0-239" class="d">-                        it.friendDisplayUsername!!.split(&quot;|&quot;)[1],
</a><a href="#h124-0-240" id="h124-0-240" class="d">-                        it.bitmojiAvatarId,
</a><a href="#h124-0-241" id="h124-0-241" class="d">-                        it.bitmojiSelfieId
</a><a href="#h124-0-242" id="h124-0-242" class="d">-                    )
</a><a href="#h124-0-243" id="h124-0-243" class="d">-                }
</a><a href="#h124-0-244" id="h124-0-244" class="d">-
</a><a href="#h124-0-245" id="h124-0-245" class="d">-                bridgeClient.passGroupsAndFriends(
</a><a href="#h124-0-246" id="h124-0-246" class="d">-                    groups.map { it.toJson() },
</a><a href="#h124-0-247" id="h124-0-247" class="d">-                    friends.map { it.toJson() }
</a><a href="#h124-0-248" id="h124-0-248" class="d">-                )
</a><a href="#h124-0-249" id="h124-0-249" class="d">-            }
</a><a href="#h124-0-250" id="h124-0-250" class="d">-        }
</a><a href="#h124-0-251" id="h124-0-251" class="d">-    }
</a><a href="#h124-0-252" id="h124-0-252" class="d">-}</a><a href="#h124-0-253" id="h124-0-253" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h125" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/XposedLoader.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/XposedLoader.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/XposedLoader.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/XposedLoader.kt</a></b>
<a href="#h125-0" id="h125-0" class="h">@@ -1,11 +0,0 @@
</a><a href="#h125-0-0" id="h125-0-0" class="d">-package me.rhunk.snapenhance
</a><a href="#h125-0-1" id="h125-0-1" class="d">-
</a><a href="#h125-0-2" id="h125-0-2" class="d">-import de.robv.android.xposed.IXposedHookLoadPackage
</a><a href="#h125-0-3" id="h125-0-3" class="d">-import de.robv.android.xposed.callbacks.XC_LoadPackage
</a><a href="#h125-0-4" id="h125-0-4" class="d">-
</a><a href="#h125-0-5" id="h125-0-5" class="d">-class XposedLoader : IXposedHookLoadPackage {
</a><a href="#h125-0-6" id="h125-0-6" class="d">-    override fun handleLoadPackage(p0: XC_LoadPackage.LoadPackageParam) {
</a><a href="#h125-0-7" id="h125-0-7" class="d">-        if (p0.packageName != Constants.SNAPCHAT_PACKAGE_NAME) return
</a><a href="#h125-0-8" id="h125-0-8" class="d">-        SnapEnhance()
</a><a href="#h125-0-9" id="h125-0-9" class="d">-    }
</a><a href="#h125-0-10" id="h125-0-10" class="d">-}</a><a href="#h125-0-11" id="h125-0-11" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h126" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/action/AbstractAction.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/action/AbstractAction.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/action/AbstractAction.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/action/AbstractAction.kt</a></b>
<a href="#h126-0" id="h126-0" class="h">@@ -1,23 +0,0 @@
</a><a href="#h126-0-0" id="h126-0-0" class="d">-package me.rhunk.snapenhance.action
</a><a href="#h126-0-1" id="h126-0-1" class="d">-
</a><a href="#h126-0-2" id="h126-0-2" class="d">-import me.rhunk.snapenhance.ModContext
</a><a href="#h126-0-3" id="h126-0-3" class="d">-import java.io.File
</a><a href="#h126-0-4" id="h126-0-4" class="d">-
</a><a href="#h126-0-5" id="h126-0-5" class="d">-abstract class AbstractAction{
</a><a href="#h126-0-6" id="h126-0-6" class="d">-    lateinit var context: ModContext
</a><a href="#h126-0-7" id="h126-0-7" class="d">-
</a><a href="#h126-0-8" id="h126-0-8" class="d">-    /**
</a><a href="#h126-0-9" id="h126-0-9" class="d">-     * called when the action is triggered
</a><a href="#h126-0-10" id="h126-0-10" class="d">-     */
</a><a href="#h126-0-11" id="h126-0-11" class="d">-    open fun run() {}
</a><a href="#h126-0-12" id="h126-0-12" class="d">-
</a><a href="#h126-0-13" id="h126-0-13" class="d">-    protected open fun deleteRecursively(parent: File?) {
</a><a href="#h126-0-14" id="h126-0-14" class="d">-        if (parent == null) return
</a><a href="#h126-0-15" id="h126-0-15" class="d">-        if (parent.isDirectory) for (child in parent.listFiles()!!) deleteRecursively(
</a><a href="#h126-0-16" id="h126-0-16" class="d">-            child
</a><a href="#h126-0-17" id="h126-0-17" class="d">-        )
</a><a href="#h126-0-18" id="h126-0-18" class="d">-        if (parent.exists() &amp;&amp; (parent.isFile || parent.isDirectory)) {
</a><a href="#h126-0-19" id="h126-0-19" class="d">-            parent.delete()
</a><a href="#h126-0-20" id="h126-0-20" class="d">-        }
</a><a href="#h126-0-21" id="h126-0-21" class="d">-    }
</a><a href="#h126-0-22" id="h126-0-22" class="d">-}</a><a href="#h126-0-23" id="h126-0-23" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h127" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/action/EnumAction.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/action/EnumAction.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/action/EnumAction.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/action/EnumAction.kt</a></b>
<a href="#h127-0" id="h127-0" class="h">@@ -1,17 +0,0 @@
</a><a href="#h127-0-0" id="h127-0-0" class="d">-package me.rhunk.snapenhance.action
</a><a href="#h127-0-1" id="h127-0-1" class="d">-
</a><a href="#h127-0-2" id="h127-0-2" class="d">-import me.rhunk.snapenhance.action.impl.CleanCache
</a><a href="#h127-0-3" id="h127-0-3" class="d">-import me.rhunk.snapenhance.action.impl.ExportChatMessages
</a><a href="#h127-0-4" id="h127-0-4" class="d">-import me.rhunk.snapenhance.action.impl.OpenMap
</a><a href="#h127-0-5" id="h127-0-5" class="d">-import kotlin.reflect.KClass
</a><a href="#h127-0-6" id="h127-0-6" class="d">-
</a><a href="#h127-0-7" id="h127-0-7" class="d">-enum class EnumAction(
</a><a href="#h127-0-8" id="h127-0-8" class="d">-    val key: String,
</a><a href="#h127-0-9" id="h127-0-9" class="d">-    val clazz: KClass&lt;out AbstractAction&gt;,
</a><a href="#h127-0-10" id="h127-0-10" class="d">-    val exitOnFinish: Boolean = false,
</a><a href="#h127-0-11" id="h127-0-11" class="d">-    val isCritical: Boolean = false,
</a><a href="#h127-0-12" id="h127-0-12" class="d">-) {
</a><a href="#h127-0-13" id="h127-0-13" class="d">-    CLEAN_CACHE(&quot;clean_snapchat_cache&quot;, CleanCache::class, exitOnFinish = true),
</a><a href="#h127-0-14" id="h127-0-14" class="d">-    EXPORT_CHAT_MESSAGES(&quot;export_chat_messages&quot;, ExportChatMessages::class),
</a><a href="#h127-0-15" id="h127-0-15" class="d">-    OPEN_MAP(&quot;open_map&quot;, OpenMap::class);
</a><a href="#h127-0-16" id="h127-0-16" class="d">-}</a><a href="#h127-0-17" id="h127-0-17" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h128" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/action/impl/CleanCache.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/action/impl/CleanCache.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/action/impl/CleanCache.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/action/impl/CleanCache.kt</a></b>
<a href="#h128-0" id="h128-0" class="h">@@ -1,41 +0,0 @@
</a><a href="#h128-0-0" id="h128-0-0" class="d">-package me.rhunk.snapenhance.action.impl
</a><a href="#h128-0-1" id="h128-0-1" class="d">-
</a><a href="#h128-0-2" id="h128-0-2" class="d">-import me.rhunk.snapenhance.action.AbstractAction
</a><a href="#h128-0-3" id="h128-0-3" class="d">-import java.io.File
</a><a href="#h128-0-4" id="h128-0-4" class="d">-
</a><a href="#h128-0-5" id="h128-0-5" class="d">-class CleanCache : AbstractAction() {
</a><a href="#h128-0-6" id="h128-0-6" class="d">-    companion object {
</a><a href="#h128-0-7" id="h128-0-7" class="d">-        private val FILES = arrayOf(
</a><a href="#h128-0-8" id="h128-0-8" class="d">-            &quot;files/mbgl-offline.db&quot;,
</a><a href="#h128-0-9" id="h128-0-9" class="d">-            &quot;files/native_content_manager/*&quot;,
</a><a href="#h128-0-10" id="h128-0-10" class="d">-            &quot;files/file_manager/*&quot;,
</a><a href="#h128-0-11" id="h128-0-11" class="d">-            &quot;files/blizzardv2/*&quot;,
</a><a href="#h128-0-12" id="h128-0-12" class="d">-            &quot;files/streaming/*&quot;,
</a><a href="#h128-0-13" id="h128-0-13" class="d">-            &quot;cache/*&quot;,
</a><a href="#h128-0-14" id="h128-0-14" class="d">-            &quot;databases/media_packages&quot;,
</a><a href="#h128-0-15" id="h128-0-15" class="d">-            &quot;databases/simple_db_helper.db&quot;,
</a><a href="#h128-0-16" id="h128-0-16" class="d">-            &quot;databases/journal.db&quot;,
</a><a href="#h128-0-17" id="h128-0-17" class="d">-            &quot;databases/arroyo.db&quot;,
</a><a href="#h128-0-18" id="h128-0-18" class="d">-            &quot;databases/arroyo.db-wal&quot;,
</a><a href="#h128-0-19" id="h128-0-19" class="d">-            &quot;databases/native_content_manager/*&quot;
</a><a href="#h128-0-20" id="h128-0-20" class="d">-        )
</a><a href="#h128-0-21" id="h128-0-21" class="d">-    }
</a><a href="#h128-0-22" id="h128-0-22" class="d">-
</a><a href="#h128-0-23" id="h128-0-23" class="d">-    override fun run() {
</a><a href="#h128-0-24" id="h128-0-24" class="d">-        FILES.forEach { fileName -&gt;
</a><a href="#h128-0-25" id="h128-0-25" class="d">-            val fileCache = File(context.androidContext.dataDir, fileName)
</a><a href="#h128-0-26" id="h128-0-26" class="d">-            if (fileName.endsWith(&quot;*&quot;)) {
</a><a href="#h128-0-27" id="h128-0-27" class="d">-                val parent = fileCache.parentFile ?: throw IllegalStateException(&quot;Parent file is null&quot;)
</a><a href="#h128-0-28" id="h128-0-28" class="d">-                if (parent.exists()) {
</a><a href="#h128-0-29" id="h128-0-29" class="d">-                    parent.listFiles()?.forEach(this::deleteRecursively)
</a><a href="#h128-0-30" id="h128-0-30" class="d">-                }
</a><a href="#h128-0-31" id="h128-0-31" class="d">-                return@forEach
</a><a href="#h128-0-32" id="h128-0-32" class="d">-            }
</a><a href="#h128-0-33" id="h128-0-33" class="d">-            if (fileCache.exists()) {
</a><a href="#h128-0-34" id="h128-0-34" class="d">-                deleteRecursively(fileCache)
</a><a href="#h128-0-35" id="h128-0-35" class="d">-            }
</a><a href="#h128-0-36" id="h128-0-36" class="d">-        }
</a><a href="#h128-0-37" id="h128-0-37" class="d">-
</a><a href="#h128-0-38" id="h128-0-38" class="d">-        context.softRestartApp()
</a><a href="#h128-0-39" id="h128-0-39" class="d">-    }
</a><a href="#h128-0-40" id="h128-0-40" class="d">-}</a><a href="#h128-0-41" id="h128-0-41" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h129" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/action/impl/ExportChatMessages.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/action/impl/ExportChatMessages.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/action/impl/ExportChatMessages.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/action/impl/ExportChatMessages.kt</a></b>
<a href="#h129-0" id="h129-0" class="h">@@ -1,313 +0,0 @@
</a><a href="#h129-0-0" id="h129-0-0" class="d">-package me.rhunk.snapenhance.action.impl
</a><a href="#h129-0-1" id="h129-0-1" class="d">-
</a><a href="#h129-0-2" id="h129-0-2" class="d">-import android.app.AlertDialog
</a><a href="#h129-0-3" id="h129-0-3" class="d">-import android.content.DialogInterface
</a><a href="#h129-0-4" id="h129-0-4" class="d">-import android.os.Environment
</a><a href="#h129-0-5" id="h129-0-5" class="d">-import android.text.InputType
</a><a href="#h129-0-6" id="h129-0-6" class="d">-import android.widget.EditText
</a><a href="#h129-0-7" id="h129-0-7" class="d">-import kotlinx.coroutines.Dispatchers
</a><a href="#h129-0-8" id="h129-0-8" class="d">-import kotlinx.coroutines.Job
</a><a href="#h129-0-9" id="h129-0-9" class="d">-import kotlinx.coroutines.joinAll
</a><a href="#h129-0-10" id="h129-0-10" class="d">-import kotlinx.coroutines.launch
</a><a href="#h129-0-11" id="h129-0-11" class="d">-import kotlinx.coroutines.suspendCancellableCoroutine
</a><a href="#h129-0-12" id="h129-0-12" class="d">-import me.rhunk.snapenhance.action.AbstractAction
</a><a href="#h129-0-13" id="h129-0-13" class="d">-import me.rhunk.snapenhance.core.Logger
</a><a href="#h129-0-14" id="h129-0-14" class="d">-import me.rhunk.snapenhance.core.database.objects.FriendFeedEntry
</a><a href="#h129-0-15" id="h129-0-15" class="d">-import me.rhunk.snapenhance.core.util.CallbackBuilder
</a><a href="#h129-0-16" id="h129-0-16" class="d">-import me.rhunk.snapenhance.core.util.export.ExportFormat
</a><a href="#h129-0-17" id="h129-0-17" class="d">-import me.rhunk.snapenhance.core.util.export.MessageExporter
</a><a href="#h129-0-18" id="h129-0-18" class="d">-import me.rhunk.snapenhance.data.ContentType
</a><a href="#h129-0-19" id="h129-0-19" class="d">-import me.rhunk.snapenhance.data.wrapper.impl.Message
</a><a href="#h129-0-20" id="h129-0-20" class="d">-import me.rhunk.snapenhance.data.wrapper.impl.SnapUUID
</a><a href="#h129-0-21" id="h129-0-21" class="d">-import me.rhunk.snapenhance.features.impl.Messaging
</a><a href="#h129-0-22" id="h129-0-22" class="d">-import me.rhunk.snapenhance.ui.ViewAppearanceHelper
</a><a href="#h129-0-23" id="h129-0-23" class="d">-import java.io.File
</a><a href="#h129-0-24" id="h129-0-24" class="d">-import kotlin.math.absoluteValue
</a><a href="#h129-0-25" id="h129-0-25" class="d">-
</a><a href="#h129-0-26" id="h129-0-26" class="d">-class ExportChatMessages : AbstractAction() {
</a><a href="#h129-0-27" id="h129-0-27" class="d">-    private val callbackClass by lazy {  context.mappings.getMappedClass(&quot;callbacks&quot;, &quot;Callback&quot;) }
</a><a href="#h129-0-28" id="h129-0-28" class="d">-
</a><a href="#h129-0-29" id="h129-0-29" class="d">-    private val fetchConversationWithMessagesCallbackClass by lazy {  context.mappings.getMappedClass(&quot;callbacks&quot;, &quot;FetchConversationWithMessagesCallback&quot;) }
</a><a href="#h129-0-30" id="h129-0-30" class="d">-
</a><a href="#h129-0-31" id="h129-0-31" class="d">-    private val enterConversationMethod by lazy {
</a><a href="#h129-0-32" id="h129-0-32" class="d">-        context.classCache.conversationManager.methods.first { it.name == &quot;enterConversation&quot; }
</a><a href="#h129-0-33" id="h129-0-33" class="d">-    }
</a><a href="#h129-0-34" id="h129-0-34" class="d">-    private val exitConversationMethod by lazy {
</a><a href="#h129-0-35" id="h129-0-35" class="d">-        context.classCache.conversationManager.methods.first { it.name == &quot;exitConversation&quot; }
</a><a href="#h129-0-36" id="h129-0-36" class="d">-    }
</a><a href="#h129-0-37" id="h129-0-37" class="d">-    private val fetchConversationWithMessagesPaginatedMethod by lazy {
</a><a href="#h129-0-38" id="h129-0-38" class="d">-        context.classCache.conversationManager.methods.first { it.name == &quot;fetchConversationWithMessagesPaginated&quot; }
</a><a href="#h129-0-39" id="h129-0-39" class="d">-    }
</a><a href="#h129-0-40" id="h129-0-40" class="d">-
</a><a href="#h129-0-41" id="h129-0-41" class="d">-    private val conversationManagerInstance by lazy {
</a><a href="#h129-0-42" id="h129-0-42" class="d">-        context.feature(Messaging::class).conversationManager
</a><a href="#h129-0-43" id="h129-0-43" class="d">-    }
</a><a href="#h129-0-44" id="h129-0-44" class="d">-
</a><a href="#h129-0-45" id="h129-0-45" class="d">-    private val dialogLogs = mutableListOf&lt;String&gt;()
</a><a href="#h129-0-46" id="h129-0-46" class="d">-    private var currentActionDialog: AlertDialog? = null
</a><a href="#h129-0-47" id="h129-0-47" class="d">-
</a><a href="#h129-0-48" id="h129-0-48" class="d">-    private var exportType: ExportFormat? = null
</a><a href="#h129-0-49" id="h129-0-49" class="d">-    private var mediaToDownload: List&lt;ContentType&gt;? = null
</a><a href="#h129-0-50" id="h129-0-50" class="d">-    private var amountOfMessages: Int? = null
</a><a href="#h129-0-51" id="h129-0-51" class="d">-
</a><a href="#h129-0-52" id="h129-0-52" class="d">-    private fun logDialog(message: String) {
</a><a href="#h129-0-53" id="h129-0-53" class="d">-        context.runOnUiThread {
</a><a href="#h129-0-54" id="h129-0-54" class="d">-            if (dialogLogs.size &gt; 10) dialogLogs.removeAt(0)
</a><a href="#h129-0-55" id="h129-0-55" class="d">-            dialogLogs.add(message)
</a><a href="#h129-0-56" id="h129-0-56" class="d">-            context.log.debug(&quot;dialog: $message&quot;, &quot;ExportChatMessages&quot;)
</a><a href="#h129-0-57" id="h129-0-57" class="d">-            currentActionDialog!!.setMessage(dialogLogs.joinToString(&quot;\n&quot;))
</a><a href="#h129-0-58" id="h129-0-58" class="d">-        }
</a><a href="#h129-0-59" id="h129-0-59" class="d">-    }
</a><a href="#h129-0-60" id="h129-0-60" class="d">-
</a><a href="#h129-0-61" id="h129-0-61" class="d">-    private fun setStatus(message: String) {
</a><a href="#h129-0-62" id="h129-0-62" class="d">-        context.runOnUiThread {
</a><a href="#h129-0-63" id="h129-0-63" class="d">-            currentActionDialog!!.setTitle(message)
</a><a href="#h129-0-64" id="h129-0-64" class="d">-        }
</a><a href="#h129-0-65" id="h129-0-65" class="d">-    }
</a><a href="#h129-0-66" id="h129-0-66" class="d">-
</a><a href="#h129-0-67" id="h129-0-67" class="d">-    private suspend fun askExportType() = suspendCancellableCoroutine { cont -&gt;
</a><a href="#h129-0-68" id="h129-0-68" class="d">-        context.runOnUiThread {
</a><a href="#h129-0-69" id="h129-0-69" class="d">-            ViewAppearanceHelper.newAlertDialogBuilder(context.mainActivity)
</a><a href="#h129-0-70" id="h129-0-70" class="d">-                .setTitle(context.translation[&quot;chat_export.select_export_format&quot;])
</a><a href="#h129-0-71" id="h129-0-71" class="d">-                .setItems(ExportFormat.entries.map { it.name }.toTypedArray()) { _, which -&gt;
</a><a href="#h129-0-72" id="h129-0-72" class="d">-                    cont.resumeWith(Result.success(ExportFormat.entries[which]))
</a><a href="#h129-0-73" id="h129-0-73" class="d">-                }
</a><a href="#h129-0-74" id="h129-0-74" class="d">-                .setOnCancelListener {
</a><a href="#h129-0-75" id="h129-0-75" class="d">-                    cont.resumeWith(Result.success(null))
</a><a href="#h129-0-76" id="h129-0-76" class="d">-                }
</a><a href="#h129-0-77" id="h129-0-77" class="d">-                .show()
</a><a href="#h129-0-78" id="h129-0-78" class="d">-        }
</a><a href="#h129-0-79" id="h129-0-79" class="d">-    }
</a><a href="#h129-0-80" id="h129-0-80" class="d">-
</a><a href="#h129-0-81" id="h129-0-81" class="d">-    private suspend fun askAmountOfMessages() = suspendCancellableCoroutine { cont -&gt;
</a><a href="#h129-0-82" id="h129-0-82" class="d">-        context.coroutineScope.launch(Dispatchers.Main) {
</a><a href="#h129-0-83" id="h129-0-83" class="d">-            val input = EditText(context.mainActivity)
</a><a href="#h129-0-84" id="h129-0-84" class="d">-            input.inputType = InputType.TYPE_CLASS_NUMBER
</a><a href="#h129-0-85" id="h129-0-85" class="d">-            input.setSingleLine()
</a><a href="#h129-0-86" id="h129-0-86" class="d">-            input.maxLines = 1
</a><a href="#h129-0-87" id="h129-0-87" class="d">-
</a><a href="#h129-0-88" id="h129-0-88" class="d">-            ViewAppearanceHelper.newAlertDialogBuilder(context.mainActivity)
</a><a href="#h129-0-89" id="h129-0-89" class="d">-                .setTitle(context.translation[&quot;chat_export.select_amount_of_messages&quot;])
</a><a href="#h129-0-90" id="h129-0-90" class="d">-                .setView(input)
</a><a href="#h129-0-91" id="h129-0-91" class="d">-                .setPositiveButton(context.translation[&quot;button.ok&quot;]) { _, _ -&gt;
</a><a href="#h129-0-92" id="h129-0-92" class="d">-                    cont.resumeWith(Result.success(input.text.takeIf { it.isNotEmpty() }?.toString()?.toIntOrNull()?.absoluteValue))
</a><a href="#h129-0-93" id="h129-0-93" class="d">-                }
</a><a href="#h129-0-94" id="h129-0-94" class="d">-                .setOnCancelListener {
</a><a href="#h129-0-95" id="h129-0-95" class="d">-                    cont.resumeWith(Result.success(null))
</a><a href="#h129-0-96" id="h129-0-96" class="d">-                }
</a><a href="#h129-0-97" id="h129-0-97" class="d">-                .show()
</a><a href="#h129-0-98" id="h129-0-98" class="d">-        }
</a><a href="#h129-0-99" id="h129-0-99" class="d">-    }
</a><a href="#h129-0-100" id="h129-0-100" class="d">-
</a><a href="#h129-0-101" id="h129-0-101" class="d">-    private suspend fun askMediaToDownload() = suspendCancellableCoroutine { cont -&gt;
</a><a href="#h129-0-102" id="h129-0-102" class="d">-        context.runOnUiThread {
</a><a href="#h129-0-103" id="h129-0-103" class="d">-            val mediasToDownload = mutableListOf&lt;ContentType&gt;()
</a><a href="#h129-0-104" id="h129-0-104" class="d">-            val contentTypes = arrayOf(
</a><a href="#h129-0-105" id="h129-0-105" class="d">-                ContentType.SNAP,
</a><a href="#h129-0-106" id="h129-0-106" class="d">-                ContentType.EXTERNAL_MEDIA,
</a><a href="#h129-0-107" id="h129-0-107" class="d">-                ContentType.NOTE,
</a><a href="#h129-0-108" id="h129-0-108" class="d">-                ContentType.STICKER
</a><a href="#h129-0-109" id="h129-0-109" class="d">-            )
</a><a href="#h129-0-110" id="h129-0-110" class="d">-            ViewAppearanceHelper.newAlertDialogBuilder(context.mainActivity)
</a><a href="#h129-0-111" id="h129-0-111" class="d">-                .setTitle(context.translation[&quot;chat_export.select_media_type&quot;])
</a><a href="#h129-0-112" id="h129-0-112" class="d">-                .setMultiChoiceItems(contentTypes.map { it.name }.toTypedArray(), BooleanArray(contentTypes.size) { false }) { _, which, isChecked -&gt;
</a><a href="#h129-0-113" id="h129-0-113" class="d">-                    val media = contentTypes[which]
</a><a href="#h129-0-114" id="h129-0-114" class="d">-                    if (isChecked) {
</a><a href="#h129-0-115" id="h129-0-115" class="d">-                        mediasToDownload.add(media)
</a><a href="#h129-0-116" id="h129-0-116" class="d">-                    } else if (mediasToDownload.contains(media)) {
</a><a href="#h129-0-117" id="h129-0-117" class="d">-                        mediasToDownload.remove(media)
</a><a href="#h129-0-118" id="h129-0-118" class="d">-                    }
</a><a href="#h129-0-119" id="h129-0-119" class="d">-                }
</a><a href="#h129-0-120" id="h129-0-120" class="d">-                .setOnCancelListener {
</a><a href="#h129-0-121" id="h129-0-121" class="d">-                    cont.resumeWith(Result.success(null))
</a><a href="#h129-0-122" id="h129-0-122" class="d">-                }
</a><a href="#h129-0-123" id="h129-0-123" class="d">-                .setPositiveButton(context.translation[&quot;button.ok&quot;]) { _, _ -&gt;
</a><a href="#h129-0-124" id="h129-0-124" class="d">-                    cont.resumeWith(Result.success(mediasToDownload))
</a><a href="#h129-0-125" id="h129-0-125" class="d">-                }
</a><a href="#h129-0-126" id="h129-0-126" class="d">-                .show()
</a><a href="#h129-0-127" id="h129-0-127" class="d">-        }
</a><a href="#h129-0-128" id="h129-0-128" class="d">-    }
</a><a href="#h129-0-129" id="h129-0-129" class="d">-
</a><a href="#h129-0-130" id="h129-0-130" class="d">-    override fun run() {
</a><a href="#h129-0-131" id="h129-0-131" class="d">-        context.coroutineScope.launch(Dispatchers.Main) {
</a><a href="#h129-0-132" id="h129-0-132" class="d">-            exportType = askExportType() ?: return@launch
</a><a href="#h129-0-133" id="h129-0-133" class="d">-            mediaToDownload = if (exportType == ExportFormat.HTML) askMediaToDownload() else null
</a><a href="#h129-0-134" id="h129-0-134" class="d">-            amountOfMessages = askAmountOfMessages()
</a><a href="#h129-0-135" id="h129-0-135" class="d">-
</a><a href="#h129-0-136" id="h129-0-136" class="d">-            val friendFeedEntries = context.database.getFeedEntries(500)
</a><a href="#h129-0-137" id="h129-0-137" class="d">-            val selectedConversations = mutableListOf&lt;FriendFeedEntry&gt;()
</a><a href="#h129-0-138" id="h129-0-138" class="d">-
</a><a href="#h129-0-139" id="h129-0-139" class="d">-            ViewAppearanceHelper.newAlertDialogBuilder(context.mainActivity)
</a><a href="#h129-0-140" id="h129-0-140" class="d">-                .setTitle(context.translation[&quot;chat_export.select_conversation&quot;])
</a><a href="#h129-0-141" id="h129-0-141" class="d">-                .setMultiChoiceItems(
</a><a href="#h129-0-142" id="h129-0-142" class="d">-                    friendFeedEntries.map { it.feedDisplayName ?: it.friendDisplayUsername!!.split(&quot;|&quot;).firstOrNull() }.toTypedArray(),
</a><a href="#h129-0-143" id="h129-0-143" class="d">-                    BooleanArray(friendFeedEntries.size) { false }
</a><a href="#h129-0-144" id="h129-0-144" class="d">-                ) { _, which, isChecked -&gt;
</a><a href="#h129-0-145" id="h129-0-145" class="d">-                    if (isChecked) {
</a><a href="#h129-0-146" id="h129-0-146" class="d">-                        selectedConversations.add(friendFeedEntries[which])
</a><a href="#h129-0-147" id="h129-0-147" class="d">-                    } else if (selectedConversations.contains(friendFeedEntries[which])) {
</a><a href="#h129-0-148" id="h129-0-148" class="d">-                        selectedConversations.remove(friendFeedEntries[which])
</a><a href="#h129-0-149" id="h129-0-149" class="d">-                    }
</a><a href="#h129-0-150" id="h129-0-150" class="d">-                }
</a><a href="#h129-0-151" id="h129-0-151" class="d">-                .setNegativeButton(context.translation[&quot;chat_export.dialog_negative_button&quot;]) { dialog, _ -&gt;
</a><a href="#h129-0-152" id="h129-0-152" class="d">-                    dialog.dismiss()
</a><a href="#h129-0-153" id="h129-0-153" class="d">-                }
</a><a href="#h129-0-154" id="h129-0-154" class="d">-                .setNeutralButton(context.translation[&quot;chat_export.dialog_neutral_button&quot;]) { _, _ -&gt;
</a><a href="#h129-0-155" id="h129-0-155" class="d">-                    exportChatForConversations(friendFeedEntries)
</a><a href="#h129-0-156" id="h129-0-156" class="d">-                }
</a><a href="#h129-0-157" id="h129-0-157" class="d">-                .setPositiveButton(context.translation[&quot;chat_export.dialog_positive_button&quot;]) { _, _ -&gt;
</a><a href="#h129-0-158" id="h129-0-158" class="d">-                    exportChatForConversations(selectedConversations)
</a><a href="#h129-0-159" id="h129-0-159" class="d">-                }
</a><a href="#h129-0-160" id="h129-0-160" class="d">-                .show()
</a><a href="#h129-0-161" id="h129-0-161" class="d">-        }
</a><a href="#h129-0-162" id="h129-0-162" class="d">-    }
</a><a href="#h129-0-163" id="h129-0-163" class="d">-
</a><a href="#h129-0-164" id="h129-0-164" class="d">-    private suspend fun conversationAction(isEntering: Boolean, conversationId: String, conversationType: String?) = suspendCancellableCoroutine { continuation -&gt;
</a><a href="#h129-0-165" id="h129-0-165" class="d">-        val callback = CallbackBuilder(callbackClass)
</a><a href="#h129-0-166" id="h129-0-166" class="d">-            .override(&quot;onSuccess&quot;) { _ -&gt;
</a><a href="#h129-0-167" id="h129-0-167" class="d">-                continuation.resumeWith(Result.success(Unit))
</a><a href="#h129-0-168" id="h129-0-168" class="d">-            }
</a><a href="#h129-0-169" id="h129-0-169" class="d">-            .override(&quot;onError&quot;) {
</a><a href="#h129-0-170" id="h129-0-170" class="d">-                continuation.resumeWith(Result.failure(Exception(&quot;Failed to ${if (isEntering) &quot;enter&quot; else &quot;exit&quot;} conversation&quot;)))
</a><a href="#h129-0-171" id="h129-0-171" class="d">-            }.build()
</a><a href="#h129-0-172" id="h129-0-172" class="d">-
</a><a href="#h129-0-173" id="h129-0-173" class="d">-        if (isEntering) {
</a><a href="#h129-0-174" id="h129-0-174" class="d">-            enterConversationMethod.invoke(
</a><a href="#h129-0-175" id="h129-0-175" class="d">-                conversationManagerInstance,
</a><a href="#h129-0-176" id="h129-0-176" class="d">-                SnapUUID.fromString(conversationId).instanceNonNull(),
</a><a href="#h129-0-177" id="h129-0-177" class="d">-                enterConversationMethod.parameterTypes[1].enumConstants.first { it.toString() == conversationType },
</a><a href="#h129-0-178" id="h129-0-178" class="d">-                callback
</a><a href="#h129-0-179" id="h129-0-179" class="d">-            )
</a><a href="#h129-0-180" id="h129-0-180" class="d">-        } else {
</a><a href="#h129-0-181" id="h129-0-181" class="d">-            exitConversationMethod.invoke(
</a><a href="#h129-0-182" id="h129-0-182" class="d">-                conversationManagerInstance,
</a><a href="#h129-0-183" id="h129-0-183" class="d">-                SnapUUID.fromString(conversationId).instanceNonNull(),
</a><a href="#h129-0-184" id="h129-0-184" class="d">-                Long.MAX_VALUE,
</a><a href="#h129-0-185" id="h129-0-185" class="d">-                callback
</a><a href="#h129-0-186" id="h129-0-186" class="d">-            )
</a><a href="#h129-0-187" id="h129-0-187" class="d">-        }
</a><a href="#h129-0-188" id="h129-0-188" class="d">-    }
</a><a href="#h129-0-189" id="h129-0-189" class="d">-
</a><a href="#h129-0-190" id="h129-0-190" class="d">-    private suspend fun fetchMessagesPaginated(conversationId: String, lastMessageId: Long) = suspendCancellableCoroutine { continuation -&gt;
</a><a href="#h129-0-191" id="h129-0-191" class="d">-        val callback = CallbackBuilder(fetchConversationWithMessagesCallbackClass)
</a><a href="#h129-0-192" id="h129-0-192" class="d">-            .override(&quot;onFetchConversationWithMessagesComplete&quot;) { param -&gt;
</a><a href="#h129-0-193" id="h129-0-193" class="d">-                val messagesList = param.arg&lt;List&lt;*&gt;&gt;(1).map { Message(it) }
</a><a href="#h129-0-194" id="h129-0-194" class="d">-                continuation.resumeWith(Result.success(messagesList))
</a><a href="#h129-0-195" id="h129-0-195" class="d">-            }
</a><a href="#h129-0-196" id="h129-0-196" class="d">-            .override(&quot;onServerRequest&quot;, shouldUnhook = false) {}
</a><a href="#h129-0-197" id="h129-0-197" class="d">-            .override(&quot;onError&quot;) {
</a><a href="#h129-0-198" id="h129-0-198" class="d">-                continuation.resumeWith(Result.failure(Exception(&quot;Failed to fetch messages&quot;)))
</a><a href="#h129-0-199" id="h129-0-199" class="d">-            }.build()
</a><a href="#h129-0-200" id="h129-0-200" class="d">-
</a><a href="#h129-0-201" id="h129-0-201" class="d">-        fetchConversationWithMessagesPaginatedMethod.invoke(
</a><a href="#h129-0-202" id="h129-0-202" class="d">-            conversationManagerInstance,
</a><a href="#h129-0-203" id="h129-0-203" class="d">-            SnapUUID.fromString(conversationId).instanceNonNull(),
</a><a href="#h129-0-204" id="h129-0-204" class="d">-            lastMessageId,
</a><a href="#h129-0-205" id="h129-0-205" class="d">-            500,
</a><a href="#h129-0-206" id="h129-0-206" class="d">-            callback
</a><a href="#h129-0-207" id="h129-0-207" class="d">-        )
</a><a href="#h129-0-208" id="h129-0-208" class="d">-    }
</a><a href="#h129-0-209" id="h129-0-209" class="d">-
</a><a href="#h129-0-210" id="h129-0-210" class="d">-    private suspend fun exportFullConversation(friendFeedEntry: FriendFeedEntry) {
</a><a href="#h129-0-211" id="h129-0-211" class="d">-        //first fetch the first message
</a><a href="#h129-0-212" id="h129-0-212" class="d">-        val conversationId = friendFeedEntry.key!!
</a><a href="#h129-0-213" id="h129-0-213" class="d">-        val conversationName = friendFeedEntry.feedDisplayName ?: friendFeedEntry.friendDisplayName!!.split(&quot;|&quot;).lastOrNull() ?: &quot;unknown&quot;
</a><a href="#h129-0-214" id="h129-0-214" class="d">-
</a><a href="#h129-0-215" id="h129-0-215" class="d">-        runCatching {
</a><a href="#h129-0-216" id="h129-0-216" class="d">-            conversationAction(true, conversationId, if (friendFeedEntry.feedDisplayName != null) &quot;USERCREATEDGROUP&quot; else &quot;ONEONONE&quot;)
</a><a href="#h129-0-217" id="h129-0-217" class="d">-        }
</a><a href="#h129-0-218" id="h129-0-218" class="d">-
</a><a href="#h129-0-219" id="h129-0-219" class="d">-        logDialog(context.translation.format(&quot;chat_export.exporting_message&quot;, &quot;conversation&quot; to conversationName))
</a><a href="#h129-0-220" id="h129-0-220" class="d">-
</a><a href="#h129-0-221" id="h129-0-221" class="d">-        val foundMessages = fetchMessagesPaginated(conversationId, Long.MAX_VALUE).toMutableList()
</a><a href="#h129-0-222" id="h129-0-222" class="d">-        var lastMessageId = foundMessages.firstOrNull()?.messageDescriptor?.messageId ?: run {
</a><a href="#h129-0-223" id="h129-0-223" class="d">-            logDialog(context.translation[&quot;chat_export.no_messages_found&quot;])
</a><a href="#h129-0-224" id="h129-0-224" class="d">-            return
</a><a href="#h129-0-225" id="h129-0-225" class="d">-        }
</a><a href="#h129-0-226" id="h129-0-226" class="d">-
</a><a href="#h129-0-227" id="h129-0-227" class="d">-        while (true) {
</a><a href="#h129-0-228" id="h129-0-228" class="d">-            val messages = fetchMessagesPaginated(conversationId, lastMessageId)
</a><a href="#h129-0-229" id="h129-0-229" class="d">-            if (messages.isEmpty()) break
</a><a href="#h129-0-230" id="h129-0-230" class="d">-
</a><a href="#h129-0-231" id="h129-0-231" class="d">-            if (amountOfMessages != null &amp;&amp; messages.size + foundMessages.size &gt;= amountOfMessages!!) {
</a><a href="#h129-0-232" id="h129-0-232" class="d">-                foundMessages.addAll(messages.take(amountOfMessages!! - foundMessages.size))
</a><a href="#h129-0-233" id="h129-0-233" class="d">-                break
</a><a href="#h129-0-234" id="h129-0-234" class="d">-            }
</a><a href="#h129-0-235" id="h129-0-235" class="d">-
</a><a href="#h129-0-236" id="h129-0-236" class="d">-            foundMessages.addAll(messages)
</a><a href="#h129-0-237" id="h129-0-237" class="d">-            messages.firstOrNull()?.let {
</a><a href="#h129-0-238" id="h129-0-238" class="d">-                lastMessageId = it.messageDescriptor.messageId
</a><a href="#h129-0-239" id="h129-0-239" class="d">-            }
</a><a href="#h129-0-240" id="h129-0-240" class="d">-            setStatus(&quot;Exporting (${foundMessages.size} / ${foundMessages.firstOrNull()?.orderKey})&quot;)
</a><a href="#h129-0-241" id="h129-0-241" class="d">-        }
</a><a href="#h129-0-242" id="h129-0-242" class="d">-
</a><a href="#h129-0-243" id="h129-0-243" class="d">-        val outputFile = File(
</a><a href="#h129-0-244" id="h129-0-244" class="d">-            Environment.getExternalStoragePublicDirectory(Environment.DIRECTORY_DOWNLOADS),
</a><a href="#h129-0-245" id="h129-0-245" class="d">-            &quot;SnapEnhance/conversation_${conversationName}_${System.currentTimeMillis()}.${exportType!!.extension}&quot;
</a><a href="#h129-0-246" id="h129-0-246" class="d">-        ).also { it.parentFile?.mkdirs() }
</a><a href="#h129-0-247" id="h129-0-247" class="d">-
</a><a href="#h129-0-248" id="h129-0-248" class="d">-        logDialog(context.translation[&quot;chat_export.writing_output&quot;])
</a><a href="#h129-0-249" id="h129-0-249" class="d">-
</a><a href="#h129-0-250" id="h129-0-250" class="d">-        runCatching {
</a><a href="#h129-0-251" id="h129-0-251" class="d">-            MessageExporter(
</a><a href="#h129-0-252" id="h129-0-252" class="d">-                context = context,
</a><a href="#h129-0-253" id="h129-0-253" class="d">-                friendFeedEntry = friendFeedEntry,
</a><a href="#h129-0-254" id="h129-0-254" class="d">-                outputFile = outputFile,
</a><a href="#h129-0-255" id="h129-0-255" class="d">-                mediaToDownload = mediaToDownload,
</a><a href="#h129-0-256" id="h129-0-256" class="d">-                printLog = ::logDialog
</a><a href="#h129-0-257" id="h129-0-257" class="d">-            ).apply { readMessages(foundMessages) }.exportTo(exportType!!)
</a><a href="#h129-0-258" id="h129-0-258" class="d">-        }.onFailure {
</a><a href="#h129-0-259" id="h129-0-259" class="d">-            logDialog(context.translation.format(&quot;chat_export.export_failed&quot;,&quot;conversation&quot; to it.message.toString()))
</a><a href="#h129-0-260" id="h129-0-260" class="d">-            context.log.error(&quot;Failed to export conversation $conversationName&quot;, it)
</a><a href="#h129-0-261" id="h129-0-261" class="d">-            return
</a><a href="#h129-0-262" id="h129-0-262" class="d">-        }
</a><a href="#h129-0-263" id="h129-0-263" class="d">-
</a><a href="#h129-0-264" id="h129-0-264" class="d">-        dialogLogs.clear()
</a><a href="#h129-0-265" id="h129-0-265" class="d">-        logDialog(&quot;\n&quot; + context.translation.format(&quot;chat_export.exported_to&quot;,
</a><a href="#h129-0-266" id="h129-0-266" class="d">-            &quot;path&quot; to outputFile.absolutePath.toString()
</a><a href="#h129-0-267" id="h129-0-267" class="d">-        ) + &quot;\n&quot;)
</a><a href="#h129-0-268" id="h129-0-268" class="d">-
</a><a href="#h129-0-269" id="h129-0-269" class="d">-        runCatching {
</a><a href="#h129-0-270" id="h129-0-270" class="d">-            conversationAction(false, conversationId, null)
</a><a href="#h129-0-271" id="h129-0-271" class="d">-        }
</a><a href="#h129-0-272" id="h129-0-272" class="d">-    }
</a><a href="#h129-0-273" id="h129-0-273" class="d">-
</a><a href="#h129-0-274" id="h129-0-274" class="d">-    private fun exportChatForConversations(conversations: List&lt;FriendFeedEntry&gt;) {
</a><a href="#h129-0-275" id="h129-0-275" class="d">-        dialogLogs.clear()
</a><a href="#h129-0-276" id="h129-0-276" class="d">-        val jobs = mutableListOf&lt;Job&gt;()
</a><a href="#h129-0-277" id="h129-0-277" class="d">-
</a><a href="#h129-0-278" id="h129-0-278" class="d">-        currentActionDialog = ViewAppearanceHelper.newAlertDialogBuilder(context.mainActivity)
</a><a href="#h129-0-279" id="h129-0-279" class="d">-            .setTitle(context.translation[&quot;chat_export.exporting_chats&quot;])
</a><a href="#h129-0-280" id="h129-0-280" class="d">-            .setCancelable(false)
</a><a href="#h129-0-281" id="h129-0-281" class="d">-            .setMessage(&quot;&quot;)
</a><a href="#h129-0-282" id="h129-0-282" class="d">-            .create()
</a><a href="#h129-0-283" id="h129-0-283" class="d">-        
</a><a href="#h129-0-284" id="h129-0-284" class="d">-        val conversationSize = context.translation.format(&quot;chat_export.processing_chats&quot;, &quot;amount&quot; to conversations.size.toString())
</a><a href="#h129-0-285" id="h129-0-285" class="d">-        
</a><a href="#h129-0-286" id="h129-0-286" class="d">-        logDialog(conversationSize)
</a><a href="#h129-0-287" id="h129-0-287" class="d">-
</a><a href="#h129-0-288" id="h129-0-288" class="d">-        context.coroutineScope.launch {
</a><a href="#h129-0-289" id="h129-0-289" class="d">-            conversations.forEach { conversation -&gt;
</a><a href="#h129-0-290" id="h129-0-290" class="d">-                launch {
</a><a href="#h129-0-291" id="h129-0-291" class="d">-                    runCatching {
</a><a href="#h129-0-292" id="h129-0-292" class="d">-                        exportFullConversation(conversation)
</a><a href="#h129-0-293" id="h129-0-293" class="d">-                    }.onFailure {
</a><a href="#h129-0-294" id="h129-0-294" class="d">-                        logDialog(context.translation.format(&quot;chat_export.export_fail&quot;, &quot;conversation&quot; to conversation.key.toString()))
</a><a href="#h129-0-295" id="h129-0-295" class="d">-                        logDialog(it.stackTraceToString())
</a><a href="#h129-0-296" id="h129-0-296" class="d">-                        Logger.xposedLog(it)
</a><a href="#h129-0-297" id="h129-0-297" class="d">-                    }
</a><a href="#h129-0-298" id="h129-0-298" class="d">-                }.also { jobs.add(it) }
</a><a href="#h129-0-299" id="h129-0-299" class="d">-            }
</a><a href="#h129-0-300" id="h129-0-300" class="d">-            jobs.joinAll()
</a><a href="#h129-0-301" id="h129-0-301" class="d">-            logDialog(context.translation[&quot;chat_export.finished&quot;])
</a><a href="#h129-0-302" id="h129-0-302" class="d">-        }.also {
</a><a href="#h129-0-303" id="h129-0-303" class="d">-            currentActionDialog?.setButton(DialogInterface.BUTTON_POSITIVE, context.translation[&quot;chat_export.dialog_negative_button&quot;]) { dialog, _ -&gt;
</a><a href="#h129-0-304" id="h129-0-304" class="d">-                it.cancel()
</a><a href="#h129-0-305" id="h129-0-305" class="d">-                jobs.forEach { it.cancel() }
</a><a href="#h129-0-306" id="h129-0-306" class="d">-                dialog.dismiss()
</a><a href="#h129-0-307" id="h129-0-307" class="d">-            }
</a><a href="#h129-0-308" id="h129-0-308" class="d">-        }
</a><a href="#h129-0-309" id="h129-0-309" class="d">-
</a><a href="#h129-0-310" id="h129-0-310" class="d">-        currentActionDialog!!.show()
</a><a href="#h129-0-311" id="h129-0-311" class="d">-    }
</a><a href="#h129-0-312" id="h129-0-312" class="d">-}</a><a href="#h129-0-313" id="h129-0-313" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h130" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/action/impl/OpenMap.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/action/impl/OpenMap.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/action/impl/OpenMap.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/action/impl/OpenMap.kt</a></b>
<a href="#h130-0" id="h130-0" class="h">@@ -1,21 +0,0 @@
</a><a href="#h130-0-0" id="h130-0-0" class="d">-package me.rhunk.snapenhance.action.impl
</a><a href="#h130-0-1" id="h130-0-1" class="d">-
</a><a href="#h130-0-2" id="h130-0-2" class="d">-import android.content.Intent
</a><a href="#h130-0-3" id="h130-0-3" class="d">-import android.os.Bundle
</a><a href="#h130-0-4" id="h130-0-4" class="d">-import me.rhunk.snapenhance.action.AbstractAction
</a><a href="#h130-0-5" id="h130-0-5" class="d">-import me.rhunk.snapenhance.core.BuildConfig
</a><a href="#h130-0-6" id="h130-0-6" class="d">-
</a><a href="#h130-0-7" id="h130-0-7" class="d">-class OpenMap: AbstractAction() {
</a><a href="#h130-0-8" id="h130-0-8" class="d">-    override fun run() {
</a><a href="#h130-0-9" id="h130-0-9" class="d">-        context.runOnUiThread {
</a><a href="#h130-0-10" id="h130-0-10" class="d">-            val mapActivityIntent = Intent()
</a><a href="#h130-0-11" id="h130-0-11" class="d">-            mapActivityIntent.setClassName(BuildConfig.APPLICATION_ID, BuildConfig.APPLICATION_ID + &quot;.ui.MapActivity&quot;)
</a><a href="#h130-0-12" id="h130-0-12" class="d">-            mapActivityIntent.putExtra(&quot;location&quot;, Bundle().apply {
</a><a href="#h130-0-13" id="h130-0-13" class="d">-                putDouble(&quot;latitude&quot;, context.config.experimental.spoof.location.latitude.get().toDouble())
</a><a href="#h130-0-14" id="h130-0-14" class="d">-                putDouble(&quot;longitude&quot;, context.config.experimental.spoof.location.longitude.get().toDouble())
</a><a href="#h130-0-15" id="h130-0-15" class="d">-            })
</a><a href="#h130-0-16" id="h130-0-16" class="d">-
</a><a href="#h130-0-17" id="h130-0-17" class="d">-            context.mainActivity!!.startActivityForResult(mapActivityIntent, 0x1337)
</a><a href="#h130-0-18" id="h130-0-18" class="d">-        }
</a><a href="#h130-0-19" id="h130-0-19" class="d">-    }
</a><a href="#h130-0-20" id="h130-0-20" class="d">-}</a><a href="#h130-0-21" id="h130-0-21" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h131" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/DownloadManagerClient.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/DownloadManagerClient.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/DownloadManagerClient.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/DownloadManagerClient.kt</a></b>
<a href="#h131-0" id="h131-0" class="h">@@ -0,0 +1,70 @@
</a><a href="#h131-0-0" id="h131-0-0" class="i">+package me.rhunk.snapenhance.core
</a><a href="#h131-0-1" id="h131-0-1" class="i">+
</a><a href="#h131-0-2" id="h131-0-2" class="i">+import android.content.Intent
</a><a href="#h131-0-3" id="h131-0-3" class="i">+import android.os.Bundle
</a><a href="#h131-0-4" id="h131-0-4" class="i">+import me.rhunk.snapenhance.bridge.DownloadCallback
</a><a href="#h131-0-5" id="h131-0-5" class="i">+import me.rhunk.snapenhance.common.ReceiversConfig
</a><a href="#h131-0-6" id="h131-0-6" class="i">+import me.rhunk.snapenhance.common.data.download.*
</a><a href="#h131-0-7" id="h131-0-7" class="i">+import me.rhunk.snapenhance.core.features.impl.downloader.decoder.AttachmentType
</a><a href="#h131-0-8" id="h131-0-8" class="i">+
</a><a href="#h131-0-9" id="h131-0-9" class="i">+class DownloadManagerClient (
</a><a href="#h131-0-10" id="h131-0-10" class="i">+    private val context: ModContext,
</a><a href="#h131-0-11" id="h131-0-11" class="i">+    private val metadata: DownloadMetadata,
</a><a href="#h131-0-12" id="h131-0-12" class="i">+    private val callback: DownloadCallback
</a><a href="#h131-0-13" id="h131-0-13" class="i">+) {
</a><a href="#h131-0-14" id="h131-0-14" class="i">+    private fun enqueueDownloadRequest(request: DownloadRequest) {
</a><a href="#h131-0-15" id="h131-0-15" class="i">+        context.bridgeClient.enqueueDownload(Intent().apply {
</a><a href="#h131-0-16" id="h131-0-16" class="i">+            putExtras(Bundle().apply {
</a><a href="#h131-0-17" id="h131-0-17" class="i">+                putString(ReceiversConfig.DOWNLOAD_REQUEST_EXTRA, context.gson.toJson(request))
</a><a href="#h131-0-18" id="h131-0-18" class="i">+                putString(ReceiversConfig.DOWNLOAD_METADATA_EXTRA, context.gson.toJson(metadata))
</a><a href="#h131-0-19" id="h131-0-19" class="i">+            })
</a><a href="#h131-0-20" id="h131-0-20" class="i">+        }, callback)
</a><a href="#h131-0-21" id="h131-0-21" class="i">+    }
</a><a href="#h131-0-22" id="h131-0-22" class="i">+
</a><a href="#h131-0-23" id="h131-0-23" class="i">+    fun downloadDashMedia(playlistUrl: String, offsetTime: Long, duration: Long?) {
</a><a href="#h131-0-24" id="h131-0-24" class="i">+        enqueueDownloadRequest(
</a><a href="#h131-0-25" id="h131-0-25" class="i">+            DownloadRequest(
</a><a href="#h131-0-26" id="h131-0-26" class="i">+                inputMedias = arrayOf(
</a><a href="#h131-0-27" id="h131-0-27" class="i">+                    InputMedia(
</a><a href="#h131-0-28" id="h131-0-28" class="i">+                    content = playlistUrl,
</a><a href="#h131-0-29" id="h131-0-29" class="i">+                    type = DownloadMediaType.REMOTE_MEDIA
</a><a href="#h131-0-30" id="h131-0-30" class="i">+                )
</a><a href="#h131-0-31" id="h131-0-31" class="i">+                ),
</a><a href="#h131-0-32" id="h131-0-32" class="i">+                dashOptions = DashOptions(offsetTime, duration),
</a><a href="#h131-0-33" id="h131-0-33" class="i">+                flags = DownloadRequest.Flags.IS_DASH_PLAYLIST
</a><a href="#h131-0-34" id="h131-0-34" class="i">+            )
</a><a href="#h131-0-35" id="h131-0-35" class="i">+        )
</a><a href="#h131-0-36" id="h131-0-36" class="i">+    }
</a><a href="#h131-0-37" id="h131-0-37" class="i">+
</a><a href="#h131-0-38" id="h131-0-38" class="i">+    fun downloadSingleMedia(
</a><a href="#h131-0-39" id="h131-0-39" class="i">+        mediaData: String,
</a><a href="#h131-0-40" id="h131-0-40" class="i">+        mediaType: DownloadMediaType,
</a><a href="#h131-0-41" id="h131-0-41" class="i">+        encryption: MediaEncryptionKeyPair? = null,
</a><a href="#h131-0-42" id="h131-0-42" class="i">+        attachmentType: AttachmentType? = null
</a><a href="#h131-0-43" id="h131-0-43" class="i">+    ) {
</a><a href="#h131-0-44" id="h131-0-44" class="i">+        enqueueDownloadRequest(
</a><a href="#h131-0-45" id="h131-0-45" class="i">+            DownloadRequest(
</a><a href="#h131-0-46" id="h131-0-46" class="i">+                inputMedias = arrayOf(
</a><a href="#h131-0-47" id="h131-0-47" class="i">+                    InputMedia(
</a><a href="#h131-0-48" id="h131-0-48" class="i">+                        content = mediaData,
</a><a href="#h131-0-49" id="h131-0-49" class="i">+                        type = mediaType,
</a><a href="#h131-0-50" id="h131-0-50" class="i">+                        encryption = encryption,
</a><a href="#h131-0-51" id="h131-0-51" class="i">+                        attachmentType = attachmentType?.name
</a><a href="#h131-0-52" id="h131-0-52" class="i">+                    )
</a><a href="#h131-0-53" id="h131-0-53" class="i">+                )
</a><a href="#h131-0-54" id="h131-0-54" class="i">+            )
</a><a href="#h131-0-55" id="h131-0-55" class="i">+        )
</a><a href="#h131-0-56" id="h131-0-56" class="i">+    }
</a><a href="#h131-0-57" id="h131-0-57" class="i">+
</a><a href="#h131-0-58" id="h131-0-58" class="i">+    fun downloadMediaWithOverlay(
</a><a href="#h131-0-59" id="h131-0-59" class="i">+        original: InputMedia,
</a><a href="#h131-0-60" id="h131-0-60" class="i">+        overlay: InputMedia,
</a><a href="#h131-0-61" id="h131-0-61" class="i">+    ) {
</a><a href="#h131-0-62" id="h131-0-62" class="i">+        enqueueDownloadRequest(
</a><a href="#h131-0-63" id="h131-0-63" class="i">+            DownloadRequest(
</a><a href="#h131-0-64" id="h131-0-64" class="i">+                inputMedias = arrayOf(original, overlay),
</a><a href="#h131-0-65" id="h131-0-65" class="i">+                flags = DownloadRequest.Flags.MERGE_OVERLAY
</a><a href="#h131-0-66" id="h131-0-66" class="i">+            )
</a><a href="#h131-0-67" id="h131-0-67" class="i">+        )
</a><a href="#h131-0-68" id="h131-0-68" class="i">+    }
</a><a href="#h131-0-69" id="h131-0-69" class="i">+}</a><a href="#h131-0-70" id="h131-0-70" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h132" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/Logger.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/Logger.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/Logger.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/Logger.kt</a></b>
<a href="#h132-0" id="h132-0" class="h">@@ -1,86 +0,0 @@
</a><a href="#h132-0-0" id="h132-0-0" class="d">-package me.rhunk.snapenhance.core
</a><a href="#h132-0-1" id="h132-0-1" class="d">-
</a><a href="#h132-0-2" id="h132-0-2" class="d">-import android.annotation.SuppressLint
</a><a href="#h132-0-3" id="h132-0-3" class="d">-import android.util.Log
</a><a href="#h132-0-4" id="h132-0-4" class="d">-import de.robv.android.xposed.XposedBridge
</a><a href="#h132-0-5" id="h132-0-5" class="d">-import me.rhunk.snapenhance.core.bridge.BridgeClient
</a><a href="#h132-0-6" id="h132-0-6" class="d">-import me.rhunk.snapenhance.core.logger.AbstractLogger
</a><a href="#h132-0-7" id="h132-0-7" class="d">-import me.rhunk.snapenhance.core.logger.LogChannel
</a><a href="#h132-0-8" id="h132-0-8" class="d">-import me.rhunk.snapenhance.hook.HookStage
</a><a href="#h132-0-9" id="h132-0-9" class="d">-import me.rhunk.snapenhance.hook.hook
</a><a href="#h132-0-10" id="h132-0-10" class="d">-import me.rhunk.snapenhance.core.logger.LogLevel
</a><a href="#h132-0-11" id="h132-0-11" class="d">-
</a><a href="#h132-0-12" id="h132-0-12" class="d">-
</a><a href="#h132-0-13" id="h132-0-13" class="d">-@SuppressLint(&quot;PrivateApi&quot;)
</a><a href="#h132-0-14" id="h132-0-14" class="d">-class Logger(
</a><a href="#h132-0-15" id="h132-0-15" class="d">-    private val bridgeClient: BridgeClient
</a><a href="#h132-0-16" id="h132-0-16" class="d">-): AbstractLogger(LogChannel.CORE) {
</a><a href="#h132-0-17" id="h132-0-17" class="d">-    companion object {
</a><a href="#h132-0-18" id="h132-0-18" class="d">-        private const val TAG = &quot;SnapEnhanceCore&quot;
</a><a href="#h132-0-19" id="h132-0-19" class="d">-
</a><a href="#h132-0-20" id="h132-0-20" class="d">-        fun directDebug(message: Any?, tag: String = TAG) {
</a><a href="#h132-0-21" id="h132-0-21" class="d">-            Log.println(Log.DEBUG, tag, message.toString())
</a><a href="#h132-0-22" id="h132-0-22" class="d">-        }
</a><a href="#h132-0-23" id="h132-0-23" class="d">-
</a><a href="#h132-0-24" id="h132-0-24" class="d">-        fun directError(message: Any?, throwable: Throwable, tag: String = TAG) {
</a><a href="#h132-0-25" id="h132-0-25" class="d">-            Log.println(Log.ERROR, tag, message.toString())
</a><a href="#h132-0-26" id="h132-0-26" class="d">-            Log.println(Log.ERROR, tag, throwable.toString())
</a><a href="#h132-0-27" id="h132-0-27" class="d">-        }
</a><a href="#h132-0-28" id="h132-0-28" class="d">-
</a><a href="#h132-0-29" id="h132-0-29" class="d">-        fun xposedLog(message: Any?, tag: String = TAG) {
</a><a href="#h132-0-30" id="h132-0-30" class="d">-            Log.println(Log.INFO, tag, message.toString())
</a><a href="#h132-0-31" id="h132-0-31" class="d">-            XposedBridge.log(&quot;$tag: $message&quot;)
</a><a href="#h132-0-32" id="h132-0-32" class="d">-        }
</a><a href="#h132-0-33" id="h132-0-33" class="d">-
</a><a href="#h132-0-34" id="h132-0-34" class="d">-        fun xposedLog(message: Any?, throwable: Throwable, tag: String = TAG) {
</a><a href="#h132-0-35" id="h132-0-35" class="d">-            Log.println(Log.INFO, tag, message.toString())
</a><a href="#h132-0-36" id="h132-0-36" class="d">-            XposedBridge.log(&quot;$tag: $message&quot;)
</a><a href="#h132-0-37" id="h132-0-37" class="d">-            XposedBridge.log(throwable)
</a><a href="#h132-0-38" id="h132-0-38" class="d">-        }
</a><a href="#h132-0-39" id="h132-0-39" class="d">-    }
</a><a href="#h132-0-40" id="h132-0-40" class="d">-
</a><a href="#h132-0-41" id="h132-0-41" class="d">-    private var invokeOriginalPrintLog: (Int, String, String) -&gt; Unit
</a><a href="#h132-0-42" id="h132-0-42" class="d">-
</a><a href="#h132-0-43" id="h132-0-43" class="d">-    init {
</a><a href="#h132-0-44" id="h132-0-44" class="d">-        val printLnMethod = Log::class.java.getDeclaredMethod(&quot;println&quot;, Int::class.java, String::class.java, String::class.java)
</a><a href="#h132-0-45" id="h132-0-45" class="d">-        printLnMethod.hook(HookStage.BEFORE) { param -&gt;
</a><a href="#h132-0-46" id="h132-0-46" class="d">-            val priority = param.arg(0) as Int
</a><a href="#h132-0-47" id="h132-0-47" class="d">-            val tag = param.arg(1) as String
</a><a href="#h132-0-48" id="h132-0-48" class="d">-            val message = param.arg(2) as String
</a><a href="#h132-0-49" id="h132-0-49" class="d">-            internalLog(tag, LogLevel.fromPriority(priority) ?: LogLevel.INFO, message)
</a><a href="#h132-0-50" id="h132-0-50" class="d">-        }
</a><a href="#h132-0-51" id="h132-0-51" class="d">-
</a><a href="#h132-0-52" id="h132-0-52" class="d">-        invokeOriginalPrintLog = { priority, tag, message -&gt;
</a><a href="#h132-0-53" id="h132-0-53" class="d">-            XposedBridge.invokeOriginalMethod(
</a><a href="#h132-0-54" id="h132-0-54" class="d">-                printLnMethod,
</a><a href="#h132-0-55" id="h132-0-55" class="d">-                null,
</a><a href="#h132-0-56" id="h132-0-56" class="d">-                arrayOf(priority, tag, message)
</a><a href="#h132-0-57" id="h132-0-57" class="d">-            )
</a><a href="#h132-0-58" id="h132-0-58" class="d">-        }
</a><a href="#h132-0-59" id="h132-0-59" class="d">-    }
</a><a href="#h132-0-60" id="h132-0-60" class="d">-
</a><a href="#h132-0-61" id="h132-0-61" class="d">-    private fun internalLog(tag: String, logLevel: LogLevel, message: Any?) {
</a><a href="#h132-0-62" id="h132-0-62" class="d">-        runCatching {
</a><a href="#h132-0-63" id="h132-0-63" class="d">-            bridgeClient.broadcastLog(tag, logLevel.shortName, message.toString())
</a><a href="#h132-0-64" id="h132-0-64" class="d">-        }.onFailure {
</a><a href="#h132-0-65" id="h132-0-65" class="d">-            invokeOriginalPrintLog(logLevel.priority, tag, message.toString())
</a><a href="#h132-0-66" id="h132-0-66" class="d">-        }
</a><a href="#h132-0-67" id="h132-0-67" class="d">-    }
</a><a href="#h132-0-68" id="h132-0-68" class="d">-
</a><a href="#h132-0-69" id="h132-0-69" class="d">-    override fun debug(message: Any?, tag: String) = internalLog(tag, LogLevel.DEBUG, message)
</a><a href="#h132-0-70" id="h132-0-70" class="d">-
</a><a href="#h132-0-71" id="h132-0-71" class="d">-    override fun error(message: Any?, tag: String) = internalLog(tag, LogLevel.ERROR, message)
</a><a href="#h132-0-72" id="h132-0-72" class="d">-
</a><a href="#h132-0-73" id="h132-0-73" class="d">-    override fun error(message: Any?, throwable: Throwable, tag: String) {
</a><a href="#h132-0-74" id="h132-0-74" class="d">-        internalLog(tag, LogLevel.ERROR, message)
</a><a href="#h132-0-75" id="h132-0-75" class="d">-        internalLog(tag, LogLevel.ERROR, throwable.stackTraceToString())
</a><a href="#h132-0-76" id="h132-0-76" class="d">-    }
</a><a href="#h132-0-77" id="h132-0-77" class="d">-
</a><a href="#h132-0-78" id="h132-0-78" class="d">-    override fun info(message: Any?, tag: String) = internalLog(tag, LogLevel.INFO, message)
</a><a href="#h132-0-79" id="h132-0-79" class="d">-
</a><a href="#h132-0-80" id="h132-0-80" class="d">-    override fun verbose(message: Any?, tag: String) = internalLog(tag, LogLevel.VERBOSE, message)
</a><a href="#h132-0-81" id="h132-0-81" class="d">-
</a><a href="#h132-0-82" id="h132-0-82" class="d">-    override fun warn(message: Any?, tag: String) = internalLog(tag, LogLevel.WARN, message)
</a><a href="#h132-0-83" id="h132-0-83" class="d">-
</a><a href="#h132-0-84" id="h132-0-84" class="d">-    override fun assert(message: Any?, tag: String) = internalLog(tag, LogLevel.ASSERT, message)
</a><a href="#h132-0-85" id="h132-0-85" class="d">-}</a><a href="#h132-0-86" id="h132-0-86" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h133" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/ModContext.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/ModContext.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/ModContext.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/ModContext.kt</a></b>
<a href="#h133-0" id="h133-0" class="h">@@ -0,0 +1,159 @@
</a><a href="#h133-0-0" id="h133-0-0" class="i">+package me.rhunk.snapenhance.core
</a><a href="#h133-0-1" id="h133-0-1" class="i">+
</a><a href="#h133-0-2" id="h133-0-2" class="i">+import android.app.Activity
</a><a href="#h133-0-3" id="h133-0-3" class="i">+import android.content.ClipData
</a><a href="#h133-0-4" id="h133-0-4" class="i">+import android.content.Context
</a><a href="#h133-0-5" id="h133-0-5" class="i">+import android.content.Intent
</a><a href="#h133-0-6" id="h133-0-6" class="i">+import android.content.res.Resources
</a><a href="#h133-0-7" id="h133-0-7" class="i">+import android.os.Handler
</a><a href="#h133-0-8" id="h133-0-8" class="i">+import android.os.Looper
</a><a href="#h133-0-9" id="h133-0-9" class="i">+import android.os.Process
</a><a href="#h133-0-10" id="h133-0-10" class="i">+import android.widget.Toast
</a><a href="#h133-0-11" id="h133-0-11" class="i">+import com.google.gson.Gson
</a><a href="#h133-0-12" id="h133-0-12" class="i">+import com.google.gson.GsonBuilder
</a><a href="#h133-0-13" id="h133-0-13" class="i">+import kotlinx.coroutines.CoroutineScope
</a><a href="#h133-0-14" id="h133-0-14" class="i">+import kotlinx.coroutines.Dispatchers
</a><a href="#h133-0-15" id="h133-0-15" class="i">+import kotlinx.coroutines.launch
</a><a href="#h133-0-16" id="h133-0-16" class="i">+import me.rhunk.snapenhance.common.Constants
</a><a href="#h133-0-17" id="h133-0-17" class="i">+import me.rhunk.snapenhance.common.bridge.wrapper.LocaleWrapper
</a><a href="#h133-0-18" id="h133-0-18" class="i">+import me.rhunk.snapenhance.common.bridge.wrapper.MappingsWrapper
</a><a href="#h133-0-19" id="h133-0-19" class="i">+import me.rhunk.snapenhance.common.config.ModConfig
</a><a href="#h133-0-20" id="h133-0-20" class="i">+import me.rhunk.snapenhance.core.bridge.BridgeClient
</a><a href="#h133-0-21" id="h133-0-21" class="i">+import me.rhunk.snapenhance.core.bridge.loadFromBridge
</a><a href="#h133-0-22" id="h133-0-22" class="i">+import me.rhunk.snapenhance.core.database.DatabaseAccess
</a><a href="#h133-0-23" id="h133-0-23" class="i">+import me.rhunk.snapenhance.core.event.EventBus
</a><a href="#h133-0-24" id="h133-0-24" class="i">+import me.rhunk.snapenhance.core.event.EventDispatcher
</a><a href="#h133-0-25" id="h133-0-25" class="i">+import me.rhunk.snapenhance.core.features.Feature
</a><a href="#h133-0-26" id="h133-0-26" class="i">+import me.rhunk.snapenhance.core.logger.CoreLogger
</a><a href="#h133-0-27" id="h133-0-27" class="i">+import me.rhunk.snapenhance.core.manager.impl.ActionManager
</a><a href="#h133-0-28" id="h133-0-28" class="i">+import me.rhunk.snapenhance.core.manager.impl.FeatureManager
</a><a href="#h133-0-29" id="h133-0-29" class="i">+import me.rhunk.snapenhance.core.messaging.MessageSender
</a><a href="#h133-0-30" id="h133-0-30" class="i">+import me.rhunk.snapenhance.core.scripting.CoreScriptRuntime
</a><a href="#h133-0-31" id="h133-0-31" class="i">+import me.rhunk.snapenhance.core.util.media.HttpServer
</a><a href="#h133-0-32" id="h133-0-32" class="i">+import me.rhunk.snapenhance.nativelib.NativeConfig
</a><a href="#h133-0-33" id="h133-0-33" class="i">+import me.rhunk.snapenhance.nativelib.NativeLib
</a><a href="#h133-0-34" id="h133-0-34" class="i">+import kotlin.reflect.KClass
</a><a href="#h133-0-35" id="h133-0-35" class="i">+import kotlin.system.exitProcess
</a><a href="#h133-0-36" id="h133-0-36" class="i">+
</a><a href="#h133-0-37" id="h133-0-37" class="i">+class ModContext {
</a><a href="#h133-0-38" id="h133-0-38" class="i">+    val coroutineScope = CoroutineScope(Dispatchers.IO)
</a><a href="#h133-0-39" id="h133-0-39" class="i">+
</a><a href="#h133-0-40" id="h133-0-40" class="i">+    lateinit var androidContext: Context
</a><a href="#h133-0-41" id="h133-0-41" class="i">+    lateinit var bridgeClient: BridgeClient
</a><a href="#h133-0-42" id="h133-0-42" class="i">+    var mainActivity: Activity? = null
</a><a href="#h133-0-43" id="h133-0-43" class="i">+
</a><a href="#h133-0-44" id="h133-0-44" class="i">+    val classCache get() = SnapEnhance.classCache
</a><a href="#h133-0-45" id="h133-0-45" class="i">+    val resources: Resources get() = androidContext.resources
</a><a href="#h133-0-46" id="h133-0-46" class="i">+    val gson: Gson = GsonBuilder().create()
</a><a href="#h133-0-47" id="h133-0-47" class="i">+
</a><a href="#h133-0-48" id="h133-0-48" class="i">+    private val _config = ModConfig()
</a><a href="#h133-0-49" id="h133-0-49" class="i">+    val config by _config::root
</a><a href="#h133-0-50" id="h133-0-50" class="i">+    val log by lazy { CoreLogger(this.bridgeClient) }
</a><a href="#h133-0-51" id="h133-0-51" class="i">+    val translation = LocaleWrapper()
</a><a href="#h133-0-52" id="h133-0-52" class="i">+    val httpServer = HttpServer()
</a><a href="#h133-0-53" id="h133-0-53" class="i">+    val messageSender = MessageSender(this)
</a><a href="#h133-0-54" id="h133-0-54" class="i">+
</a><a href="#h133-0-55" id="h133-0-55" class="i">+    val features = FeatureManager(this)
</a><a href="#h133-0-56" id="h133-0-56" class="i">+    val mappings = MappingsWrapper()
</a><a href="#h133-0-57" id="h133-0-57" class="i">+    val actionManager = ActionManager(this)
</a><a href="#h133-0-58" id="h133-0-58" class="i">+    val database = DatabaseAccess(this)
</a><a href="#h133-0-59" id="h133-0-59" class="i">+    val event = EventBus(this)
</a><a href="#h133-0-60" id="h133-0-60" class="i">+    val eventDispatcher = EventDispatcher(this)
</a><a href="#h133-0-61" id="h133-0-61" class="i">+    val native = NativeLib()
</a><a href="#h133-0-62" id="h133-0-62" class="i">+    val scriptRuntime by lazy { CoreScriptRuntime(androidContext, log) }
</a><a href="#h133-0-63" id="h133-0-63" class="i">+
</a><a href="#h133-0-64" id="h133-0-64" class="i">+    val isDeveloper by lazy { config.scripting.developerMode.get() }
</a><a href="#h133-0-65" id="h133-0-65" class="i">+
</a><a href="#h133-0-66" id="h133-0-66" class="i">+    fun &lt;T : Feature&gt; feature(featureClass: KClass&lt;T&gt;): T {
</a><a href="#h133-0-67" id="h133-0-67" class="i">+        return features.get(featureClass)!!
</a><a href="#h133-0-68" id="h133-0-68" class="i">+    }
</a><a href="#h133-0-69" id="h133-0-69" class="i">+
</a><a href="#h133-0-70" id="h133-0-70" class="i">+    fun runOnUiThread(runnable: () -&gt; Unit) {
</a><a href="#h133-0-71" id="h133-0-71" class="i">+        if (Looper.myLooper() == Looper.getMainLooper()) {
</a><a href="#h133-0-72" id="h133-0-72" class="i">+            runnable()
</a><a href="#h133-0-73" id="h133-0-73" class="i">+            return
</a><a href="#h133-0-74" id="h133-0-74" class="i">+        }
</a><a href="#h133-0-75" id="h133-0-75" class="i">+        Handler(Looper.getMainLooper()).post {
</a><a href="#h133-0-76" id="h133-0-76" class="i">+            runCatching(runnable).onFailure {
</a><a href="#h133-0-77" id="h133-0-77" class="i">+                CoreLogger.xposedLog(&quot;UI thread runnable failed&quot;, it)
</a><a href="#h133-0-78" id="h133-0-78" class="i">+            }
</a><a href="#h133-0-79" id="h133-0-79" class="i">+        }
</a><a href="#h133-0-80" id="h133-0-80" class="i">+    }
</a><a href="#h133-0-81" id="h133-0-81" class="i">+
</a><a href="#h133-0-82" id="h133-0-82" class="i">+    fun executeAsync(runnable: suspend ModContext.() -&gt; Unit) {
</a><a href="#h133-0-83" id="h133-0-83" class="i">+        coroutineScope.launch {
</a><a href="#h133-0-84" id="h133-0-84" class="i">+            runCatching {
</a><a href="#h133-0-85" id="h133-0-85" class="i">+                runnable()
</a><a href="#h133-0-86" id="h133-0-86" class="i">+            }.onFailure {
</a><a href="#h133-0-87" id="h133-0-87" class="i">+                longToast(&quot;Async task failed &quot; + it.message)
</a><a href="#h133-0-88" id="h133-0-88" class="i">+                log.error(&quot;Async task failed&quot;, it)
</a><a href="#h133-0-89" id="h133-0-89" class="i">+            }
</a><a href="#h133-0-90" id="h133-0-90" class="i">+        }
</a><a href="#h133-0-91" id="h133-0-91" class="i">+    }
</a><a href="#h133-0-92" id="h133-0-92" class="i">+
</a><a href="#h133-0-93" id="h133-0-93" class="i">+    fun shortToast(message: Any?) {
</a><a href="#h133-0-94" id="h133-0-94" class="i">+        runOnUiThread {
</a><a href="#h133-0-95" id="h133-0-95" class="i">+            Toast.makeText(androidContext, message.toString(), Toast.LENGTH_SHORT).show()
</a><a href="#h133-0-96" id="h133-0-96" class="i">+        }
</a><a href="#h133-0-97" id="h133-0-97" class="i">+    }
</a><a href="#h133-0-98" id="h133-0-98" class="i">+
</a><a href="#h133-0-99" id="h133-0-99" class="i">+    fun longToast(message: Any?) {
</a><a href="#h133-0-100" id="h133-0-100" class="i">+        runOnUiThread {
</a><a href="#h133-0-101" id="h133-0-101" class="i">+            Toast.makeText(androidContext, message.toString(), Toast.LENGTH_LONG).show()
</a><a href="#h133-0-102" id="h133-0-102" class="i">+        }
</a><a href="#h133-0-103" id="h133-0-103" class="i">+    }
</a><a href="#h133-0-104" id="h133-0-104" class="i">+
</a><a href="#h133-0-105" id="h133-0-105" class="i">+    fun softRestartApp(saveSettings: Boolean = false) {
</a><a href="#h133-0-106" id="h133-0-106" class="i">+        if (saveSettings) {
</a><a href="#h133-0-107" id="h133-0-107" class="i">+            _config.writeConfig()
</a><a href="#h133-0-108" id="h133-0-108" class="i">+        }
</a><a href="#h133-0-109" id="h133-0-109" class="i">+        val intent: Intent? = androidContext.packageManager.getLaunchIntentForPackage(
</a><a href="#h133-0-110" id="h133-0-110" class="i">+            Constants.SNAPCHAT_PACKAGE_NAME
</a><a href="#h133-0-111" id="h133-0-111" class="i">+        )
</a><a href="#h133-0-112" id="h133-0-112" class="i">+        intent?.let {
</a><a href="#h133-0-113" id="h133-0-113" class="i">+            val mainIntent = Intent.makeRestartActivityTask(intent.component)
</a><a href="#h133-0-114" id="h133-0-114" class="i">+            androidContext.startActivity(mainIntent)
</a><a href="#h133-0-115" id="h133-0-115" class="i">+        }
</a><a href="#h133-0-116" id="h133-0-116" class="i">+        exitProcess(1)
</a><a href="#h133-0-117" id="h133-0-117" class="i">+    }
</a><a href="#h133-0-118" id="h133-0-118" class="i">+
</a><a href="#h133-0-119" id="h133-0-119" class="i">+    fun crash(message: String, throwable: Throwable? = null) {
</a><a href="#h133-0-120" id="h133-0-120" class="i">+        logCritical(message, throwable ?: Throwable())
</a><a href="#h133-0-121" id="h133-0-121" class="i">+        delayForceCloseApp(100)
</a><a href="#h133-0-122" id="h133-0-122" class="i">+    }
</a><a href="#h133-0-123" id="h133-0-123" class="i">+
</a><a href="#h133-0-124" id="h133-0-124" class="i">+    fun logCritical(message: Any?, throwable: Throwable = Throwable()) {
</a><a href="#h133-0-125" id="h133-0-125" class="i">+        log.error(message ?: &quot;Snapchat crash&quot;, throwable)
</a><a href="#h133-0-126" id="h133-0-126" class="i">+        longToast(message ?: &quot;Snapchat has crashed! Please check logs for more details.&quot;)
</a><a href="#h133-0-127" id="h133-0-127" class="i">+    }
</a><a href="#h133-0-128" id="h133-0-128" class="i">+
</a><a href="#h133-0-129" id="h133-0-129" class="i">+    private fun delayForceCloseApp(delay: Long) = Handler(Looper.getMainLooper()).postDelayed({
</a><a href="#h133-0-130" id="h133-0-130" class="i">+        forceCloseApp()
</a><a href="#h133-0-131" id="h133-0-131" class="i">+    }, delay)
</a><a href="#h133-0-132" id="h133-0-132" class="i">+
</a><a href="#h133-0-133" id="h133-0-133" class="i">+    fun forceCloseApp() {
</a><a href="#h133-0-134" id="h133-0-134" class="i">+        Process.killProcess(Process.myPid())
</a><a href="#h133-0-135" id="h133-0-135" class="i">+        exitProcess(1)
</a><a href="#h133-0-136" id="h133-0-136" class="i">+    }
</a><a href="#h133-0-137" id="h133-0-137" class="i">+
</a><a href="#h133-0-138" id="h133-0-138" class="i">+    fun reloadConfig() {
</a><a href="#h133-0-139" id="h133-0-139" class="i">+        log.verbose(&quot;reloading config&quot;)
</a><a href="#h133-0-140" id="h133-0-140" class="i">+        _config.loadFromCallback { file -&gt;
</a><a href="#h133-0-141" id="h133-0-141" class="i">+            file.loadFromBridge(bridgeClient)
</a><a href="#h133-0-142" id="h133-0-142" class="i">+        }
</a><a href="#h133-0-143" id="h133-0-143" class="i">+        native.loadNativeConfig(
</a><a href="#h133-0-144" id="h133-0-144" class="i">+            NativeConfig(
</a><a href="#h133-0-145" id="h133-0-145" class="i">+                disableBitmoji = config.experimental.nativeHooks.disableBitmoji.get(),
</a><a href="#h133-0-146" id="h133-0-146" class="i">+                disableMetrics = config.global.disableMetrics.get()
</a><a href="#h133-0-147" id="h133-0-147" class="i">+            )
</a><a href="#h133-0-148" id="h133-0-148" class="i">+        )
</a><a href="#h133-0-149" id="h133-0-149" class="i">+    }
</a><a href="#h133-0-150" id="h133-0-150" class="i">+
</a><a href="#h133-0-151" id="h133-0-151" class="i">+    fun getConfigLocale(): String {
</a><a href="#h133-0-152" id="h133-0-152" class="i">+        return _config.locale
</a><a href="#h133-0-153" id="h133-0-153" class="i">+    }
</a><a href="#h133-0-154" id="h133-0-154" class="i">+
</a><a href="#h133-0-155" id="h133-0-155" class="i">+    fun copyToClipboard(data: String, label: String = &quot;Copied Text&quot;) {
</a><a href="#h133-0-156" id="h133-0-156" class="i">+        androidContext.getSystemService(android.content.ClipboardManager::class.java).setPrimaryClip(ClipData.newPlainText(label, data))
</a><a href="#h133-0-157" id="h133-0-157" class="i">+    }
</a><a href="#h133-0-158" id="h133-0-158" class="i">+}</a><a href="#h133-0-159" id="h133-0-159" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h134" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/SnapEnhance.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/SnapEnhance.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/SnapEnhance.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/SnapEnhance.kt</a></b>
<a href="#h134-0" id="h134-0" class="h">@@ -0,0 +1,258 @@
</a><a href="#h134-0-0" id="h134-0-0" class="i">+package me.rhunk.snapenhance.core
</a><a href="#h134-0-1" id="h134-0-1" class="i">+
</a><a href="#h134-0-2" id="h134-0-2" class="i">+import android.app.Activity
</a><a href="#h134-0-3" id="h134-0-3" class="i">+import android.app.Application
</a><a href="#h134-0-4" id="h134-0-4" class="i">+import android.content.Context
</a><a href="#h134-0-5" id="h134-0-5" class="i">+import kotlinx.coroutines.CoroutineScope
</a><a href="#h134-0-6" id="h134-0-6" class="i">+import kotlinx.coroutines.Dispatchers
</a><a href="#h134-0-7" id="h134-0-7" class="i">+import kotlinx.coroutines.launch
</a><a href="#h134-0-8" id="h134-0-8" class="i">+import kotlinx.coroutines.runBlocking
</a><a href="#h134-0-9" id="h134-0-9" class="i">+import me.rhunk.snapenhance.bridge.ConfigStateListener
</a><a href="#h134-0-10" id="h134-0-10" class="i">+import me.rhunk.snapenhance.bridge.SyncCallback
</a><a href="#h134-0-11" id="h134-0-11" class="i">+import me.rhunk.snapenhance.common.Constants
</a><a href="#h134-0-12" id="h134-0-12" class="i">+import me.rhunk.snapenhance.common.ReceiversConfig
</a><a href="#h134-0-13" id="h134-0-13" class="i">+import me.rhunk.snapenhance.common.action.EnumAction
</a><a href="#h134-0-14" id="h134-0-14" class="i">+import me.rhunk.snapenhance.common.data.MessagingFriendInfo
</a><a href="#h134-0-15" id="h134-0-15" class="i">+import me.rhunk.snapenhance.common.data.MessagingGroupInfo
</a><a href="#h134-0-16" id="h134-0-16" class="i">+import me.rhunk.snapenhance.core.bridge.BridgeClient
</a><a href="#h134-0-17" id="h134-0-17" class="i">+import me.rhunk.snapenhance.core.bridge.loadFromBridge
</a><a href="#h134-0-18" id="h134-0-18" class="i">+import me.rhunk.snapenhance.core.data.SnapClassCache
</a><a href="#h134-0-19" id="h134-0-19" class="i">+import me.rhunk.snapenhance.core.event.events.impl.SnapWidgetBroadcastReceiveEvent
</a><a href="#h134-0-20" id="h134-0-20" class="i">+import me.rhunk.snapenhance.core.event.events.impl.UnaryCallEvent
</a><a href="#h134-0-21" id="h134-0-21" class="i">+import me.rhunk.snapenhance.core.util.hook.HookStage
</a><a href="#h134-0-22" id="h134-0-22" class="i">+import me.rhunk.snapenhance.core.util.hook.hook
</a><a href="#h134-0-23" id="h134-0-23" class="i">+import kotlin.system.measureTimeMillis
</a><a href="#h134-0-24" id="h134-0-24" class="i">+
</a><a href="#h134-0-25" id="h134-0-25" class="i">+
</a><a href="#h134-0-26" id="h134-0-26" class="i">+class SnapEnhance {
</a><a href="#h134-0-27" id="h134-0-27" class="i">+    companion object {
</a><a href="#h134-0-28" id="h134-0-28" class="i">+        lateinit var classLoader: ClassLoader
</a><a href="#h134-0-29" id="h134-0-29" class="i">+            private set
</a><a href="#h134-0-30" id="h134-0-30" class="i">+        val classCache by lazy {
</a><a href="#h134-0-31" id="h134-0-31" class="i">+            SnapClassCache(classLoader)
</a><a href="#h134-0-32" id="h134-0-32" class="i">+        }
</a><a href="#h134-0-33" id="h134-0-33" class="i">+    }
</a><a href="#h134-0-34" id="h134-0-34" class="i">+    private val appContext = ModContext()
</a><a href="#h134-0-35" id="h134-0-35" class="i">+    private var isBridgeInitialized = false
</a><a href="#h134-0-36" id="h134-0-36" class="i">+    private var isActivityPaused = false
</a><a href="#h134-0-37" id="h134-0-37" class="i">+
</a><a href="#h134-0-38" id="h134-0-38" class="i">+    private fun hookMainActivity(methodName: String, stage: HookStage = HookStage.AFTER, block: Activity.() -&gt; Unit) {
</a><a href="#h134-0-39" id="h134-0-39" class="i">+        Activity::class.java.hook(methodName, stage, { isBridgeInitialized }) { param -&gt;
</a><a href="#h134-0-40" id="h134-0-40" class="i">+            val activity = param.thisObject() as Activity
</a><a href="#h134-0-41" id="h134-0-41" class="i">+            if (!activity.packageName.equals(Constants.SNAPCHAT_PACKAGE_NAME)) return@hook
</a><a href="#h134-0-42" id="h134-0-42" class="i">+            block(activity)
</a><a href="#h134-0-43" id="h134-0-43" class="i">+        }
</a><a href="#h134-0-44" id="h134-0-44" class="i">+    }
</a><a href="#h134-0-45" id="h134-0-45" class="i">+
</a><a href="#h134-0-46" id="h134-0-46" class="i">+    init {
</a><a href="#h134-0-47" id="h134-0-47" class="i">+        Application::class.java.hook(&quot;attach&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h134-0-48" id="h134-0-48" class="i">+            appContext.apply {
</a><a href="#h134-0-49" id="h134-0-49" class="i">+                androidContext = param.arg&lt;Context&gt;(0).also {
</a><a href="#h134-0-50" id="h134-0-50" class="i">+                    classLoader = it.classLoader
</a><a href="#h134-0-51" id="h134-0-51" class="i">+                }
</a><a href="#h134-0-52" id="h134-0-52" class="i">+                bridgeClient = BridgeClient(appContext)
</a><a href="#h134-0-53" id="h134-0-53" class="i">+                bridgeClient.apply {
</a><a href="#h134-0-54" id="h134-0-54" class="i">+                    connect(
</a><a href="#h134-0-55" id="h134-0-55" class="i">+                        timeout = {
</a><a href="#h134-0-56" id="h134-0-56" class="i">+                            crash(&quot;SnapEnhance bridge service is not responding. Please download stable version from https://github.com/rhunk/SnapEnhance/releases&quot;, it)
</a><a href="#h134-0-57" id="h134-0-57" class="i">+                        }
</a><a href="#h134-0-58" id="h134-0-58" class="i">+                    ) { bridgeResult -&gt;
</a><a href="#h134-0-59" id="h134-0-59" class="i">+                        if (!bridgeResult) {
</a><a href="#h134-0-60" id="h134-0-60" class="i">+                            logCritical(&quot;Cannot connect to bridge service&quot;)
</a><a href="#h134-0-61" id="h134-0-61" class="i">+                            softRestartApp()
</a><a href="#h134-0-62" id="h134-0-62" class="i">+                            return@connect
</a><a href="#h134-0-63" id="h134-0-63" class="i">+                        }
</a><a href="#h134-0-64" id="h134-0-64" class="i">+                        runCatching {
</a><a href="#h134-0-65" id="h134-0-65" class="i">+                            measureTimeMillis {
</a><a href="#h134-0-66" id="h134-0-66" class="i">+                                runBlocking {
</a><a href="#h134-0-67" id="h134-0-67" class="i">+                                    init(this)
</a><a href="#h134-0-68" id="h134-0-68" class="i">+                                }
</a><a href="#h134-0-69" id="h134-0-69" class="i">+                            }.also {
</a><a href="#h134-0-70" id="h134-0-70" class="i">+                                appContext.log.verbose(&quot;init took ${it}ms&quot;)
</a><a href="#h134-0-71" id="h134-0-71" class="i">+                            }
</a><a href="#h134-0-72" id="h134-0-72" class="i">+                        }.onSuccess {
</a><a href="#h134-0-73" id="h134-0-73" class="i">+                            isBridgeInitialized = true
</a><a href="#h134-0-74" id="h134-0-74" class="i">+                        }.onFailure {
</a><a href="#h134-0-75" id="h134-0-75" class="i">+                            logCritical(&quot;Failed to initialize bridge&quot;, it)
</a><a href="#h134-0-76" id="h134-0-76" class="i">+                        }
</a><a href="#h134-0-77" id="h134-0-77" class="i">+                    }
</a><a href="#h134-0-78" id="h134-0-78" class="i">+                }
</a><a href="#h134-0-79" id="h134-0-79" class="i">+            }
</a><a href="#h134-0-80" id="h134-0-80" class="i">+        }
</a><a href="#h134-0-81" id="h134-0-81" class="i">+
</a><a href="#h134-0-82" id="h134-0-82" class="i">+        hookMainActivity(&quot;onCreate&quot;) {
</a><a href="#h134-0-83" id="h134-0-83" class="i">+            val isMainActivityNotNull = appContext.mainActivity != null
</a><a href="#h134-0-84" id="h134-0-84" class="i">+            appContext.mainActivity = this
</a><a href="#h134-0-85" id="h134-0-85" class="i">+            if (isMainActivityNotNull || !appContext.mappings.isMappingsLoaded()) return@hookMainActivity
</a><a href="#h134-0-86" id="h134-0-86" class="i">+            onActivityCreate()
</a><a href="#h134-0-87" id="h134-0-87" class="i">+        }
</a><a href="#h134-0-88" id="h134-0-88" class="i">+
</a><a href="#h134-0-89" id="h134-0-89" class="i">+        hookMainActivity(&quot;onPause&quot;) {
</a><a href="#h134-0-90" id="h134-0-90" class="i">+            appContext.bridgeClient.closeSettingsOverlay()
</a><a href="#h134-0-91" id="h134-0-91" class="i">+            isActivityPaused = true
</a><a href="#h134-0-92" id="h134-0-92" class="i">+        }
</a><a href="#h134-0-93" id="h134-0-93" class="i">+
</a><a href="#h134-0-94" id="h134-0-94" class="i">+        var activityWasResumed = false
</a><a href="#h134-0-95" id="h134-0-95" class="i">+        //we need to reload the config when the app is resumed
</a><a href="#h134-0-96" id="h134-0-96" class="i">+        //FIXME: called twice at first launch
</a><a href="#h134-0-97" id="h134-0-97" class="i">+        hookMainActivity(&quot;onResume&quot;) {
</a><a href="#h134-0-98" id="h134-0-98" class="i">+            isActivityPaused = false
</a><a href="#h134-0-99" id="h134-0-99" class="i">+            if (!activityWasResumed) {
</a><a href="#h134-0-100" id="h134-0-100" class="i">+                activityWasResumed = true
</a><a href="#h134-0-101" id="h134-0-101" class="i">+                return@hookMainActivity
</a><a href="#h134-0-102" id="h134-0-102" class="i">+            }
</a><a href="#h134-0-103" id="h134-0-103" class="i">+
</a><a href="#h134-0-104" id="h134-0-104" class="i">+            appContext.actionManager.onNewIntent(this.intent)
</a><a href="#h134-0-105" id="h134-0-105" class="i">+            appContext.reloadConfig()
</a><a href="#h134-0-106" id="h134-0-106" class="i">+            syncRemote()
</a><a href="#h134-0-107" id="h134-0-107" class="i">+        }
</a><a href="#h134-0-108" id="h134-0-108" class="i">+    }
</a><a href="#h134-0-109" id="h134-0-109" class="i">+
</a><a href="#h134-0-110" id="h134-0-110" class="i">+    private fun init(scope: CoroutineScope) {
</a><a href="#h134-0-111" id="h134-0-111" class="i">+        with(appContext) {
</a><a href="#h134-0-112" id="h134-0-112" class="i">+            Thread::class.java.hook(&quot;dispatchUncaughtException&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h134-0-113" id="h134-0-113" class="i">+                runCatching {
</a><a href="#h134-0-114" id="h134-0-114" class="i">+                    val throwable = param.argNullable(0) ?: Throwable()
</a><a href="#h134-0-115" id="h134-0-115" class="i">+                    logCritical(null, throwable)
</a><a href="#h134-0-116" id="h134-0-116" class="i">+                }
</a><a href="#h134-0-117" id="h134-0-117" class="i">+            }
</a><a href="#h134-0-118" id="h134-0-118" class="i">+
</a><a href="#h134-0-119" id="h134-0-119" class="i">+            reloadConfig()
</a><a href="#h134-0-120" id="h134-0-120" class="i">+            actionManager.init()
</a><a href="#h134-0-121" id="h134-0-121" class="i">+            initConfigListener()
</a><a href="#h134-0-122" id="h134-0-122" class="i">+            scope.launch(Dispatchers.IO) {
</a><a href="#h134-0-123" id="h134-0-123" class="i">+                initNative()
</a><a href="#h134-0-124" id="h134-0-124" class="i">+                translation.userLocale = getConfigLocale()
</a><a href="#h134-0-125" id="h134-0-125" class="i">+                translation.loadFromCallback { locale -&gt;
</a><a href="#h134-0-126" id="h134-0-126" class="i">+                    bridgeClient.fetchLocales(locale)
</a><a href="#h134-0-127" id="h134-0-127" class="i">+                }
</a><a href="#h134-0-128" id="h134-0-128" class="i">+            }
</a><a href="#h134-0-129" id="h134-0-129" class="i">+
</a><a href="#h134-0-130" id="h134-0-130" class="i">+            mappings.loadFromBridge(bridgeClient)
</a><a href="#h134-0-131" id="h134-0-131" class="i">+            mappings.init(androidContext)
</a><a href="#h134-0-132" id="h134-0-132" class="i">+            eventDispatcher.init()
</a><a href="#h134-0-133" id="h134-0-133" class="i">+            //if mappings aren&#39;t loaded, we can&#39;t initialize features
</a><a href="#h134-0-134" id="h134-0-134" class="i">+            if (!mappings.isMappingsLoaded()) return
</a><a href="#h134-0-135" id="h134-0-135" class="i">+            features.init()
</a><a href="#h134-0-136" id="h134-0-136" class="i">+            scriptRuntime.connect(bridgeClient.getScriptingInterface())
</a><a href="#h134-0-137" id="h134-0-137" class="i">+            syncRemote()
</a><a href="#h134-0-138" id="h134-0-138" class="i">+        }
</a><a href="#h134-0-139" id="h134-0-139" class="i">+    }
</a><a href="#h134-0-140" id="h134-0-140" class="i">+
</a><a href="#h134-0-141" id="h134-0-141" class="i">+    private fun onActivityCreate() {
</a><a href="#h134-0-142" id="h134-0-142" class="i">+        measureTimeMillis {
</a><a href="#h134-0-143" id="h134-0-143" class="i">+            with(appContext) {
</a><a href="#h134-0-144" id="h134-0-144" class="i">+                features.onActivityCreate()
</a><a href="#h134-0-145" id="h134-0-145" class="i">+                scriptRuntime.eachModule { callFunction(&quot;module.onSnapActivity&quot;, mainActivity!!) }
</a><a href="#h134-0-146" id="h134-0-146" class="i">+            }
</a><a href="#h134-0-147" id="h134-0-147" class="i">+        }.also { time -&gt;
</a><a href="#h134-0-148" id="h134-0-148" class="i">+            appContext.log.verbose(&quot;onActivityCreate took $time&quot;)
</a><a href="#h134-0-149" id="h134-0-149" class="i">+        }
</a><a href="#h134-0-150" id="h134-0-150" class="i">+    }
</a><a href="#h134-0-151" id="h134-0-151" class="i">+
</a><a href="#h134-0-152" id="h134-0-152" class="i">+    private fun initNative() {
</a><a href="#h134-0-153" id="h134-0-153" class="i">+        // don&#39;t initialize native when not logged in
</a><a href="#h134-0-154" id="h134-0-154" class="i">+        if (!appContext.database.hasArroyo()) return
</a><a href="#h134-0-155" id="h134-0-155" class="i">+        appContext.native.apply {
</a><a href="#h134-0-156" id="h134-0-156" class="i">+            if (appContext.config.experimental.nativeHooks.globalState != true) return@apply
</a><a href="#h134-0-157" id="h134-0-157" class="i">+            initOnce(appContext.androidContext.classLoader)
</a><a href="#h134-0-158" id="h134-0-158" class="i">+            nativeUnaryCallCallback = { request -&gt;
</a><a href="#h134-0-159" id="h134-0-159" class="i">+                appContext.event.post(UnaryCallEvent(request.uri, request.buffer)) {
</a><a href="#h134-0-160" id="h134-0-160" class="i">+                    request.buffer = buffer
</a><a href="#h134-0-161" id="h134-0-161" class="i">+                    request.canceled = canceled
</a><a href="#h134-0-162" id="h134-0-162" class="i">+                }
</a><a href="#h134-0-163" id="h134-0-163" class="i">+            }
</a><a href="#h134-0-164" id="h134-0-164" class="i">+        }
</a><a href="#h134-0-165" id="h134-0-165" class="i">+    }
</a><a href="#h134-0-166" id="h134-0-166" class="i">+
</a><a href="#h134-0-167" id="h134-0-167" class="i">+    private fun initConfigListener() {
</a><a href="#h134-0-168" id="h134-0-168" class="i">+        val tasks = linkedSetOf&lt;() -&gt; Unit&gt;()
</a><a href="#h134-0-169" id="h134-0-169" class="i">+        hookMainActivity(&quot;onResume&quot;) {
</a><a href="#h134-0-170" id="h134-0-170" class="i">+            tasks.forEach { it() }
</a><a href="#h134-0-171" id="h134-0-171" class="i">+        }
</a><a href="#h134-0-172" id="h134-0-172" class="i">+
</a><a href="#h134-0-173" id="h134-0-173" class="i">+        fun runLater(task: () -&gt; Unit) {
</a><a href="#h134-0-174" id="h134-0-174" class="i">+            if (isActivityPaused) {
</a><a href="#h134-0-175" id="h134-0-175" class="i">+                tasks.add(task)
</a><a href="#h134-0-176" id="h134-0-176" class="i">+            } else {
</a><a href="#h134-0-177" id="h134-0-177" class="i">+                task()
</a><a href="#h134-0-178" id="h134-0-178" class="i">+            }
</a><a href="#h134-0-179" id="h134-0-179" class="i">+        }
</a><a href="#h134-0-180" id="h134-0-180" class="i">+
</a><a href="#h134-0-181" id="h134-0-181" class="i">+        appContext.apply {
</a><a href="#h134-0-182" id="h134-0-182" class="i">+            bridgeClient.registerConfigStateListener(object: ConfigStateListener.Stub() {
</a><a href="#h134-0-183" id="h134-0-183" class="i">+                override fun onConfigChanged() {
</a><a href="#h134-0-184" id="h134-0-184" class="i">+                    log.verbose(&quot;onConfigChanged&quot;)
</a><a href="#h134-0-185" id="h134-0-185" class="i">+                    reloadConfig()
</a><a href="#h134-0-186" id="h134-0-186" class="i">+                }
</a><a href="#h134-0-187" id="h134-0-187" class="i">+
</a><a href="#h134-0-188" id="h134-0-188" class="i">+                override fun onRestartRequired() {
</a><a href="#h134-0-189" id="h134-0-189" class="i">+                    log.verbose(&quot;onRestartRequired&quot;)
</a><a href="#h134-0-190" id="h134-0-190" class="i">+                    runLater {
</a><a href="#h134-0-191" id="h134-0-191" class="i">+                        log.verbose(&quot;softRestart&quot;)
</a><a href="#h134-0-192" id="h134-0-192" class="i">+                        softRestartApp(saveSettings = false)
</a><a href="#h134-0-193" id="h134-0-193" class="i">+                    }
</a><a href="#h134-0-194" id="h134-0-194" class="i">+                }
</a><a href="#h134-0-195" id="h134-0-195" class="i">+
</a><a href="#h134-0-196" id="h134-0-196" class="i">+                override fun onCleanCacheRequired() {
</a><a href="#h134-0-197" id="h134-0-197" class="i">+                    log.verbose(&quot;onCleanCacheRequired&quot;)
</a><a href="#h134-0-198" id="h134-0-198" class="i">+                    tasks.clear()
</a><a href="#h134-0-199" id="h134-0-199" class="i">+                    runLater {
</a><a href="#h134-0-200" id="h134-0-200" class="i">+                        log.verbose(&quot;cleanCache&quot;)
</a><a href="#h134-0-201" id="h134-0-201" class="i">+                        actionManager.execute(EnumAction.CLEAN_CACHE)
</a><a href="#h134-0-202" id="h134-0-202" class="i">+                    }
</a><a href="#h134-0-203" id="h134-0-203" class="i">+                }
</a><a href="#h134-0-204" id="h134-0-204" class="i">+            })
</a><a href="#h134-0-205" id="h134-0-205" class="i">+        }
</a><a href="#h134-0-206" id="h134-0-206" class="i">+
</a><a href="#h134-0-207" id="h134-0-207" class="i">+    }
</a><a href="#h134-0-208" id="h134-0-208" class="i">+
</a><a href="#h134-0-209" id="h134-0-209" class="i">+    private fun syncRemote() {
</a><a href="#h134-0-210" id="h134-0-210" class="i">+        appContext.executeAsync {
</a><a href="#h134-0-211" id="h134-0-211" class="i">+            bridgeClient.sync(object : SyncCallback.Stub() {
</a><a href="#h134-0-212" id="h134-0-212" class="i">+                override fun syncFriend(uuid: String): String? {
</a><a href="#h134-0-213" id="h134-0-213" class="i">+                    return database.getFriendInfo(uuid)?.toJson()
</a><a href="#h134-0-214" id="h134-0-214" class="i">+                }
</a><a href="#h134-0-215" id="h134-0-215" class="i">+
</a><a href="#h134-0-216" id="h134-0-216" class="i">+                override fun syncGroup(uuid: String): String? {
</a><a href="#h134-0-217" id="h134-0-217" class="i">+                    return database.getFeedEntryByConversationId(uuid)?.let {
</a><a href="#h134-0-218" id="h134-0-218" class="i">+                        MessagingGroupInfo(
</a><a href="#h134-0-219" id="h134-0-219" class="i">+                            it.key!!,
</a><a href="#h134-0-220" id="h134-0-220" class="i">+                            it.feedDisplayName!!,
</a><a href="#h134-0-221" id="h134-0-221" class="i">+                            it.participantsSize
</a><a href="#h134-0-222" id="h134-0-222" class="i">+                        ).toJson()
</a><a href="#h134-0-223" id="h134-0-223" class="i">+                    }
</a><a href="#h134-0-224" id="h134-0-224" class="i">+                }
</a><a href="#h134-0-225" id="h134-0-225" class="i">+            })
</a><a href="#h134-0-226" id="h134-0-226" class="i">+
</a><a href="#h134-0-227" id="h134-0-227" class="i">+            event.subscribe(SnapWidgetBroadcastReceiveEvent::class) { event -&gt;
</a><a href="#h134-0-228" id="h134-0-228" class="i">+                if (event.action != ReceiversConfig.BRIDGE_SYNC_ACTION) return@subscribe
</a><a href="#h134-0-229" id="h134-0-229" class="i">+                event.canceled = true
</a><a href="#h134-0-230" id="h134-0-230" class="i">+                val feedEntries = appContext.database.getFeedEntries(Int.MAX_VALUE)
</a><a href="#h134-0-231" id="h134-0-231" class="i">+
</a><a href="#h134-0-232" id="h134-0-232" class="i">+                val groups = feedEntries.filter { it.friendUserId == null }.map {
</a><a href="#h134-0-233" id="h134-0-233" class="i">+                    MessagingGroupInfo(
</a><a href="#h134-0-234" id="h134-0-234" class="i">+                        it.key!!,
</a><a href="#h134-0-235" id="h134-0-235" class="i">+                        it.feedDisplayName!!,
</a><a href="#h134-0-236" id="h134-0-236" class="i">+                        it.participantsSize
</a><a href="#h134-0-237" id="h134-0-237" class="i">+                    )
</a><a href="#h134-0-238" id="h134-0-238" class="i">+                }
</a><a href="#h134-0-239" id="h134-0-239" class="i">+
</a><a href="#h134-0-240" id="h134-0-240" class="i">+                val friends = feedEntries.filter { it.friendUserId != null }.map {
</a><a href="#h134-0-241" id="h134-0-241" class="i">+                    MessagingFriendInfo(
</a><a href="#h134-0-242" id="h134-0-242" class="i">+                        it.friendUserId!!,
</a><a href="#h134-0-243" id="h134-0-243" class="i">+                        it.friendDisplayName,
</a><a href="#h134-0-244" id="h134-0-244" class="i">+                        it.friendDisplayUsername!!.split(&quot;|&quot;)[1],
</a><a href="#h134-0-245" id="h134-0-245" class="i">+                        it.bitmojiAvatarId,
</a><a href="#h134-0-246" id="h134-0-246" class="i">+                        it.bitmojiSelfieId
</a><a href="#h134-0-247" id="h134-0-247" class="i">+                    )
</a><a href="#h134-0-248" id="h134-0-248" class="i">+                }
</a><a href="#h134-0-249" id="h134-0-249" class="i">+
</a><a href="#h134-0-250" id="h134-0-250" class="i">+                bridgeClient.passGroupsAndFriends(
</a><a href="#h134-0-251" id="h134-0-251" class="i">+                    groups.map { it.toJson() },
</a><a href="#h134-0-252" id="h134-0-252" class="i">+                    friends.map { it.toJson() }
</a><a href="#h134-0-253" id="h134-0-253" class="i">+                )
</a><a href="#h134-0-254" id="h134-0-254" class="i">+            }
</a><a href="#h134-0-255" id="h134-0-255" class="i">+        }
</a><a href="#h134-0-256" id="h134-0-256" class="i">+    }
</a><a href="#h134-0-257" id="h134-0-257" class="i">+}</a><a href="#h134-0-258" id="h134-0-258" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h135" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/XposedLoader.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/XposedLoader.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/XposedLoader.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/XposedLoader.kt</a></b>
<a href="#h135-0" id="h135-0" class="h">@@ -0,0 +1,12 @@
</a><a href="#h135-0-0" id="h135-0-0" class="i">+package me.rhunk.snapenhance.core
</a><a href="#h135-0-1" id="h135-0-1" class="i">+
</a><a href="#h135-0-2" id="h135-0-2" class="i">+import de.robv.android.xposed.IXposedHookLoadPackage
</a><a href="#h135-0-3" id="h135-0-3" class="i">+import de.robv.android.xposed.callbacks.XC_LoadPackage
</a><a href="#h135-0-4" id="h135-0-4" class="i">+import me.rhunk.snapenhance.common.Constants
</a><a href="#h135-0-5" id="h135-0-5" class="i">+
</a><a href="#h135-0-6" id="h135-0-6" class="i">+class XposedLoader : IXposedHookLoadPackage {
</a><a href="#h135-0-7" id="h135-0-7" class="i">+    override fun handleLoadPackage(p0: XC_LoadPackage.LoadPackageParam) {
</a><a href="#h135-0-8" id="h135-0-8" class="i">+        if (p0.packageName != Constants.SNAPCHAT_PACKAGE_NAME) return
</a><a href="#h135-0-9" id="h135-0-9" class="i">+        SnapEnhance()
</a><a href="#h135-0-10" id="h135-0-10" class="i">+    }
</a><a href="#h135-0-11" id="h135-0-11" class="i">+}</a><a href="#h135-0-12" id="h135-0-12" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h136" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/action/AbstractAction.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/action/AbstractAction.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/action/AbstractAction.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/action/AbstractAction.kt</a></b>
<a href="#h136-0" id="h136-0" class="h">@@ -0,0 +1,23 @@
</a><a href="#h136-0-0" id="h136-0-0" class="i">+package me.rhunk.snapenhance.core.action
</a><a href="#h136-0-1" id="h136-0-1" class="i">+
</a><a href="#h136-0-2" id="h136-0-2" class="i">+import me.rhunk.snapenhance.core.ModContext
</a><a href="#h136-0-3" id="h136-0-3" class="i">+import java.io.File
</a><a href="#h136-0-4" id="h136-0-4" class="i">+
</a><a href="#h136-0-5" id="h136-0-5" class="i">+abstract class AbstractAction{
</a><a href="#h136-0-6" id="h136-0-6" class="i">+    lateinit var context: ModContext
</a><a href="#h136-0-7" id="h136-0-7" class="i">+
</a><a href="#h136-0-8" id="h136-0-8" class="i">+    /**
</a><a href="#h136-0-9" id="h136-0-9" class="i">+     * called when the action is triggered
</a><a href="#h136-0-10" id="h136-0-10" class="i">+     */
</a><a href="#h136-0-11" id="h136-0-11" class="i">+    open fun run() {}
</a><a href="#h136-0-12" id="h136-0-12" class="i">+
</a><a href="#h136-0-13" id="h136-0-13" class="i">+    protected open fun deleteRecursively(parent: File?) {
</a><a href="#h136-0-14" id="h136-0-14" class="i">+        if (parent == null) return
</a><a href="#h136-0-15" id="h136-0-15" class="i">+        if (parent.isDirectory) for (child in parent.listFiles()!!) deleteRecursively(
</a><a href="#h136-0-16" id="h136-0-16" class="i">+            child
</a><a href="#h136-0-17" id="h136-0-17" class="i">+        )
</a><a href="#h136-0-18" id="h136-0-18" class="i">+        if (parent.exists() &amp;&amp; (parent.isFile || parent.isDirectory)) {
</a><a href="#h136-0-19" id="h136-0-19" class="i">+            parent.delete()
</a><a href="#h136-0-20" id="h136-0-20" class="i">+        }
</a><a href="#h136-0-21" id="h136-0-21" class="i">+    }
</a><a href="#h136-0-22" id="h136-0-22" class="i">+}</a><a href="#h136-0-23" id="h136-0-23" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h137" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/action/impl/CleanCache.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/action/impl/CleanCache.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/action/impl/CleanCache.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/action/impl/CleanCache.kt</a></b>
<a href="#h137-0" id="h137-0" class="h">@@ -0,0 +1,41 @@
</a><a href="#h137-0-0" id="h137-0-0" class="i">+package me.rhunk.snapenhance.core.action.impl
</a><a href="#h137-0-1" id="h137-0-1" class="i">+
</a><a href="#h137-0-2" id="h137-0-2" class="i">+import me.rhunk.snapenhance.core.action.AbstractAction
</a><a href="#h137-0-3" id="h137-0-3" class="i">+import java.io.File
</a><a href="#h137-0-4" id="h137-0-4" class="i">+
</a><a href="#h137-0-5" id="h137-0-5" class="i">+class CleanCache : AbstractAction() {
</a><a href="#h137-0-6" id="h137-0-6" class="i">+    companion object {
</a><a href="#h137-0-7" id="h137-0-7" class="i">+        private val FILES = arrayOf(
</a><a href="#h137-0-8" id="h137-0-8" class="i">+            &quot;files/mbgl-offline.db&quot;,
</a><a href="#h137-0-9" id="h137-0-9" class="i">+            &quot;files/native_content_manager/*&quot;,
</a><a href="#h137-0-10" id="h137-0-10" class="i">+            &quot;files/file_manager/*&quot;,
</a><a href="#h137-0-11" id="h137-0-11" class="i">+            &quot;files/blizzardv2/*&quot;,
</a><a href="#h137-0-12" id="h137-0-12" class="i">+            &quot;files/streaming/*&quot;,
</a><a href="#h137-0-13" id="h137-0-13" class="i">+            &quot;cache/*&quot;,
</a><a href="#h137-0-14" id="h137-0-14" class="i">+            &quot;databases/media_packages&quot;,
</a><a href="#h137-0-15" id="h137-0-15" class="i">+            &quot;databases/simple_db_helper.db&quot;,
</a><a href="#h137-0-16" id="h137-0-16" class="i">+            &quot;databases/journal.db&quot;,
</a><a href="#h137-0-17" id="h137-0-17" class="i">+            &quot;databases/arroyo.db&quot;,
</a><a href="#h137-0-18" id="h137-0-18" class="i">+            &quot;databases/arroyo.db-wal&quot;,
</a><a href="#h137-0-19" id="h137-0-19" class="i">+            &quot;databases/native_content_manager/*&quot;
</a><a href="#h137-0-20" id="h137-0-20" class="i">+        )
</a><a href="#h137-0-21" id="h137-0-21" class="i">+    }
</a><a href="#h137-0-22" id="h137-0-22" class="i">+
</a><a href="#h137-0-23" id="h137-0-23" class="i">+    override fun run() {
</a><a href="#h137-0-24" id="h137-0-24" class="i">+        FILES.forEach { fileName -&gt;
</a><a href="#h137-0-25" id="h137-0-25" class="i">+            val fileCache = File(context.androidContext.dataDir, fileName)
</a><a href="#h137-0-26" id="h137-0-26" class="i">+            if (fileName.endsWith(&quot;*&quot;)) {
</a><a href="#h137-0-27" id="h137-0-27" class="i">+                val parent = fileCache.parentFile ?: throw IllegalStateException(&quot;Parent file is null&quot;)
</a><a href="#h137-0-28" id="h137-0-28" class="i">+                if (parent.exists()) {
</a><a href="#h137-0-29" id="h137-0-29" class="i">+                    parent.listFiles()?.forEach(this::deleteRecursively)
</a><a href="#h137-0-30" id="h137-0-30" class="i">+                }
</a><a href="#h137-0-31" id="h137-0-31" class="i">+                return@forEach
</a><a href="#h137-0-32" id="h137-0-32" class="i">+            }
</a><a href="#h137-0-33" id="h137-0-33" class="i">+            if (fileCache.exists()) {
</a><a href="#h137-0-34" id="h137-0-34" class="i">+                deleteRecursively(fileCache)
</a><a href="#h137-0-35" id="h137-0-35" class="i">+            }
</a><a href="#h137-0-36" id="h137-0-36" class="i">+        }
</a><a href="#h137-0-37" id="h137-0-37" class="i">+
</a><a href="#h137-0-38" id="h137-0-38" class="i">+        context.softRestartApp()
</a><a href="#h137-0-39" id="h137-0-39" class="i">+    }
</a><a href="#h137-0-40" id="h137-0-40" class="i">+}</a><a href="#h137-0-41" id="h137-0-41" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h138" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/action/impl/ExportChatMessages.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/action/impl/ExportChatMessages.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/action/impl/ExportChatMessages.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/action/impl/ExportChatMessages.kt</a></b>
<a href="#h138-0" id="h138-0" class="h">@@ -0,0 +1,313 @@
</a><a href="#h138-0-0" id="h138-0-0" class="i">+package me.rhunk.snapenhance.core.action.impl
</a><a href="#h138-0-1" id="h138-0-1" class="i">+
</a><a href="#h138-0-2" id="h138-0-2" class="i">+import android.app.AlertDialog
</a><a href="#h138-0-3" id="h138-0-3" class="i">+import android.content.DialogInterface
</a><a href="#h138-0-4" id="h138-0-4" class="i">+import android.os.Environment
</a><a href="#h138-0-5" id="h138-0-5" class="i">+import android.text.InputType
</a><a href="#h138-0-6" id="h138-0-6" class="i">+import android.widget.EditText
</a><a href="#h138-0-7" id="h138-0-7" class="i">+import kotlinx.coroutines.Dispatchers
</a><a href="#h138-0-8" id="h138-0-8" class="i">+import kotlinx.coroutines.Job
</a><a href="#h138-0-9" id="h138-0-9" class="i">+import kotlinx.coroutines.joinAll
</a><a href="#h138-0-10" id="h138-0-10" class="i">+import kotlinx.coroutines.launch
</a><a href="#h138-0-11" id="h138-0-11" class="i">+import kotlinx.coroutines.suspendCancellableCoroutine
</a><a href="#h138-0-12" id="h138-0-12" class="i">+import me.rhunk.snapenhance.common.data.ContentType
</a><a href="#h138-0-13" id="h138-0-13" class="i">+import me.rhunk.snapenhance.common.database.impl.FriendFeedEntry
</a><a href="#h138-0-14" id="h138-0-14" class="i">+import me.rhunk.snapenhance.core.action.AbstractAction
</a><a href="#h138-0-15" id="h138-0-15" class="i">+import me.rhunk.snapenhance.core.features.impl.messaging.Messaging
</a><a href="#h138-0-16" id="h138-0-16" class="i">+import me.rhunk.snapenhance.core.logger.CoreLogger
</a><a href="#h138-0-17" id="h138-0-17" class="i">+import me.rhunk.snapenhance.core.messaging.ExportFormat
</a><a href="#h138-0-18" id="h138-0-18" class="i">+import me.rhunk.snapenhance.core.messaging.MessageExporter
</a><a href="#h138-0-19" id="h138-0-19" class="i">+import me.rhunk.snapenhance.core.ui.ViewAppearanceHelper
</a><a href="#h138-0-20" id="h138-0-20" class="i">+import me.rhunk.snapenhance.core.util.CallbackBuilder
</a><a href="#h138-0-21" id="h138-0-21" class="i">+import me.rhunk.snapenhance.core.wrapper.impl.Message
</a><a href="#h138-0-22" id="h138-0-22" class="i">+import me.rhunk.snapenhance.core.wrapper.impl.SnapUUID
</a><a href="#h138-0-23" id="h138-0-23" class="i">+import java.io.File
</a><a href="#h138-0-24" id="h138-0-24" class="i">+import kotlin.math.absoluteValue
</a><a href="#h138-0-25" id="h138-0-25" class="i">+
</a><a href="#h138-0-26" id="h138-0-26" class="i">+class ExportChatMessages : AbstractAction() {
</a><a href="#h138-0-27" id="h138-0-27" class="i">+    private val callbackClass by lazy {  context.mappings.getMappedClass(&quot;callbacks&quot;, &quot;Callback&quot;) }
</a><a href="#h138-0-28" id="h138-0-28" class="i">+
</a><a href="#h138-0-29" id="h138-0-29" class="i">+    private val fetchConversationWithMessagesCallbackClass by lazy {  context.mappings.getMappedClass(&quot;callbacks&quot;, &quot;FetchConversationWithMessagesCallback&quot;) }
</a><a href="#h138-0-30" id="h138-0-30" class="i">+
</a><a href="#h138-0-31" id="h138-0-31" class="i">+    private val enterConversationMethod by lazy {
</a><a href="#h138-0-32" id="h138-0-32" class="i">+        context.classCache.conversationManager.methods.first { it.name == &quot;enterConversation&quot; }
</a><a href="#h138-0-33" id="h138-0-33" class="i">+    }
</a><a href="#h138-0-34" id="h138-0-34" class="i">+    private val exitConversationMethod by lazy {
</a><a href="#h138-0-35" id="h138-0-35" class="i">+        context.classCache.conversationManager.methods.first { it.name == &quot;exitConversation&quot; }
</a><a href="#h138-0-36" id="h138-0-36" class="i">+    }
</a><a href="#h138-0-37" id="h138-0-37" class="i">+    private val fetchConversationWithMessagesPaginatedMethod by lazy {
</a><a href="#h138-0-38" id="h138-0-38" class="i">+        context.classCache.conversationManager.methods.first { it.name == &quot;fetchConversationWithMessagesPaginated&quot; }
</a><a href="#h138-0-39" id="h138-0-39" class="i">+    }
</a><a href="#h138-0-40" id="h138-0-40" class="i">+
</a><a href="#h138-0-41" id="h138-0-41" class="i">+    private val conversationManagerInstance by lazy {
</a><a href="#h138-0-42" id="h138-0-42" class="i">+        context.feature(Messaging::class).conversationManager
</a><a href="#h138-0-43" id="h138-0-43" class="i">+    }
</a><a href="#h138-0-44" id="h138-0-44" class="i">+
</a><a href="#h138-0-45" id="h138-0-45" class="i">+    private val dialogLogs = mutableListOf&lt;String&gt;()
</a><a href="#h138-0-46" id="h138-0-46" class="i">+    private var currentActionDialog: AlertDialog? = null
</a><a href="#h138-0-47" id="h138-0-47" class="i">+
</a><a href="#h138-0-48" id="h138-0-48" class="i">+    private var exportType: ExportFormat? = null
</a><a href="#h138-0-49" id="h138-0-49" class="i">+    private var mediaToDownload: List&lt;ContentType&gt;? = null
</a><a href="#h138-0-50" id="h138-0-50" class="i">+    private var amountOfMessages: Int? = null
</a><a href="#h138-0-51" id="h138-0-51" class="i">+
</a><a href="#h138-0-52" id="h138-0-52" class="i">+    private fun logDialog(message: String) {
</a><a href="#h138-0-53" id="h138-0-53" class="i">+        context.runOnUiThread {
</a><a href="#h138-0-54" id="h138-0-54" class="i">+            if (dialogLogs.size &gt; 10) dialogLogs.removeAt(0)
</a><a href="#h138-0-55" id="h138-0-55" class="i">+            dialogLogs.add(message)
</a><a href="#h138-0-56" id="h138-0-56" class="i">+            context.log.debug(&quot;dialog: $message&quot;, &quot;ExportChatMessages&quot;)
</a><a href="#h138-0-57" id="h138-0-57" class="i">+            currentActionDialog!!.setMessage(dialogLogs.joinToString(&quot;\n&quot;))
</a><a href="#h138-0-58" id="h138-0-58" class="i">+        }
</a><a href="#h138-0-59" id="h138-0-59" class="i">+    }
</a><a href="#h138-0-60" id="h138-0-60" class="i">+
</a><a href="#h138-0-61" id="h138-0-61" class="i">+    private fun setStatus(message: String) {
</a><a href="#h138-0-62" id="h138-0-62" class="i">+        context.runOnUiThread {
</a><a href="#h138-0-63" id="h138-0-63" class="i">+            currentActionDialog!!.setTitle(message)
</a><a href="#h138-0-64" id="h138-0-64" class="i">+        }
</a><a href="#h138-0-65" id="h138-0-65" class="i">+    }
</a><a href="#h138-0-66" id="h138-0-66" class="i">+
</a><a href="#h138-0-67" id="h138-0-67" class="i">+    private suspend fun askExportType() = suspendCancellableCoroutine { cont -&gt;
</a><a href="#h138-0-68" id="h138-0-68" class="i">+        context.runOnUiThread {
</a><a href="#h138-0-69" id="h138-0-69" class="i">+            ViewAppearanceHelper.newAlertDialogBuilder(context.mainActivity)
</a><a href="#h138-0-70" id="h138-0-70" class="i">+                .setTitle(context.translation[&quot;chat_export.select_export_format&quot;])
</a><a href="#h138-0-71" id="h138-0-71" class="i">+                .setItems(ExportFormat.entries.map { it.name }.toTypedArray()) { _, which -&gt;
</a><a href="#h138-0-72" id="h138-0-72" class="i">+                    cont.resumeWith(Result.success(ExportFormat.entries[which]))
</a><a href="#h138-0-73" id="h138-0-73" class="i">+                }
</a><a href="#h138-0-74" id="h138-0-74" class="i">+                .setOnCancelListener {
</a><a href="#h138-0-75" id="h138-0-75" class="i">+                    cont.resumeWith(Result.success(null))
</a><a href="#h138-0-76" id="h138-0-76" class="i">+                }
</a><a href="#h138-0-77" id="h138-0-77" class="i">+                .show()
</a><a href="#h138-0-78" id="h138-0-78" class="i">+        }
</a><a href="#h138-0-79" id="h138-0-79" class="i">+    }
</a><a href="#h138-0-80" id="h138-0-80" class="i">+
</a><a href="#h138-0-81" id="h138-0-81" class="i">+    private suspend fun askAmountOfMessages() = suspendCancellableCoroutine { cont -&gt;
</a><a href="#h138-0-82" id="h138-0-82" class="i">+        context.coroutineScope.launch(Dispatchers.Main) {
</a><a href="#h138-0-83" id="h138-0-83" class="i">+            val input = EditText(context.mainActivity)
</a><a href="#h138-0-84" id="h138-0-84" class="i">+            input.inputType = InputType.TYPE_CLASS_NUMBER
</a><a href="#h138-0-85" id="h138-0-85" class="i">+            input.setSingleLine()
</a><a href="#h138-0-86" id="h138-0-86" class="i">+            input.maxLines = 1
</a><a href="#h138-0-87" id="h138-0-87" class="i">+
</a><a href="#h138-0-88" id="h138-0-88" class="i">+            ViewAppearanceHelper.newAlertDialogBuilder(context.mainActivity)
</a><a href="#h138-0-89" id="h138-0-89" class="i">+                .setTitle(context.translation[&quot;chat_export.select_amount_of_messages&quot;])
</a><a href="#h138-0-90" id="h138-0-90" class="i">+                .setView(input)
</a><a href="#h138-0-91" id="h138-0-91" class="i">+                .setPositiveButton(context.translation[&quot;button.ok&quot;]) { _, _ -&gt;
</a><a href="#h138-0-92" id="h138-0-92" class="i">+                    cont.resumeWith(Result.success(input.text.takeIf { it.isNotEmpty() }?.toString()?.toIntOrNull()?.absoluteValue))
</a><a href="#h138-0-93" id="h138-0-93" class="i">+                }
</a><a href="#h138-0-94" id="h138-0-94" class="i">+                .setOnCancelListener {
</a><a href="#h138-0-95" id="h138-0-95" class="i">+                    cont.resumeWith(Result.success(null))
</a><a href="#h138-0-96" id="h138-0-96" class="i">+                }
</a><a href="#h138-0-97" id="h138-0-97" class="i">+                .show()
</a><a href="#h138-0-98" id="h138-0-98" class="i">+        }
</a><a href="#h138-0-99" id="h138-0-99" class="i">+    }
</a><a href="#h138-0-100" id="h138-0-100" class="i">+
</a><a href="#h138-0-101" id="h138-0-101" class="i">+    private suspend fun askMediaToDownload() = suspendCancellableCoroutine { cont -&gt;
</a><a href="#h138-0-102" id="h138-0-102" class="i">+        context.runOnUiThread {
</a><a href="#h138-0-103" id="h138-0-103" class="i">+            val mediasToDownload = mutableListOf&lt;ContentType&gt;()
</a><a href="#h138-0-104" id="h138-0-104" class="i">+            val contentTypes = arrayOf(
</a><a href="#h138-0-105" id="h138-0-105" class="i">+                ContentType.SNAP,
</a><a href="#h138-0-106" id="h138-0-106" class="i">+                ContentType.EXTERNAL_MEDIA,
</a><a href="#h138-0-107" id="h138-0-107" class="i">+                ContentType.NOTE,
</a><a href="#h138-0-108" id="h138-0-108" class="i">+                ContentType.STICKER
</a><a href="#h138-0-109" id="h138-0-109" class="i">+            )
</a><a href="#h138-0-110" id="h138-0-110" class="i">+            ViewAppearanceHelper.newAlertDialogBuilder(context.mainActivity)
</a><a href="#h138-0-111" id="h138-0-111" class="i">+                .setTitle(context.translation[&quot;chat_export.select_media_type&quot;])
</a><a href="#h138-0-112" id="h138-0-112" class="i">+                .setMultiChoiceItems(contentTypes.map { it.name }.toTypedArray(), BooleanArray(contentTypes.size) { false }) { _, which, isChecked -&gt;
</a><a href="#h138-0-113" id="h138-0-113" class="i">+                    val media = contentTypes[which]
</a><a href="#h138-0-114" id="h138-0-114" class="i">+                    if (isChecked) {
</a><a href="#h138-0-115" id="h138-0-115" class="i">+                        mediasToDownload.add(media)
</a><a href="#h138-0-116" id="h138-0-116" class="i">+                    } else if (mediasToDownload.contains(media)) {
</a><a href="#h138-0-117" id="h138-0-117" class="i">+                        mediasToDownload.remove(media)
</a><a href="#h138-0-118" id="h138-0-118" class="i">+                    }
</a><a href="#h138-0-119" id="h138-0-119" class="i">+                }
</a><a href="#h138-0-120" id="h138-0-120" class="i">+                .setOnCancelListener {
</a><a href="#h138-0-121" id="h138-0-121" class="i">+                    cont.resumeWith(Result.success(null))
</a><a href="#h138-0-122" id="h138-0-122" class="i">+                }
</a><a href="#h138-0-123" id="h138-0-123" class="i">+                .setPositiveButton(context.translation[&quot;button.ok&quot;]) { _, _ -&gt;
</a><a href="#h138-0-124" id="h138-0-124" class="i">+                    cont.resumeWith(Result.success(mediasToDownload))
</a><a href="#h138-0-125" id="h138-0-125" class="i">+                }
</a><a href="#h138-0-126" id="h138-0-126" class="i">+                .show()
</a><a href="#h138-0-127" id="h138-0-127" class="i">+        }
</a><a href="#h138-0-128" id="h138-0-128" class="i">+    }
</a><a href="#h138-0-129" id="h138-0-129" class="i">+
</a><a href="#h138-0-130" id="h138-0-130" class="i">+    override fun run() {
</a><a href="#h138-0-131" id="h138-0-131" class="i">+        context.coroutineScope.launch(Dispatchers.Main) {
</a><a href="#h138-0-132" id="h138-0-132" class="i">+            exportType = askExportType() ?: return@launch
</a><a href="#h138-0-133" id="h138-0-133" class="i">+            mediaToDownload = if (exportType == ExportFormat.HTML) askMediaToDownload() else null
</a><a href="#h138-0-134" id="h138-0-134" class="i">+            amountOfMessages = askAmountOfMessages()
</a><a href="#h138-0-135" id="h138-0-135" class="i">+
</a><a href="#h138-0-136" id="h138-0-136" class="i">+            val friendFeedEntries = context.database.getFeedEntries(500)
</a><a href="#h138-0-137" id="h138-0-137" class="i">+            val selectedConversations = mutableListOf&lt;FriendFeedEntry&gt;()
</a><a href="#h138-0-138" id="h138-0-138" class="i">+
</a><a href="#h138-0-139" id="h138-0-139" class="i">+            ViewAppearanceHelper.newAlertDialogBuilder(context.mainActivity)
</a><a href="#h138-0-140" id="h138-0-140" class="i">+                .setTitle(context.translation[&quot;chat_export.select_conversation&quot;])
</a><a href="#h138-0-141" id="h138-0-141" class="i">+                .setMultiChoiceItems(
</a><a href="#h138-0-142" id="h138-0-142" class="i">+                    friendFeedEntries.map { it.feedDisplayName ?: it.friendDisplayUsername!!.split(&quot;|&quot;).firstOrNull() }.toTypedArray(),
</a><a href="#h138-0-143" id="h138-0-143" class="i">+                    BooleanArray(friendFeedEntries.size) { false }
</a><a href="#h138-0-144" id="h138-0-144" class="i">+                ) { _, which, isChecked -&gt;
</a><a href="#h138-0-145" id="h138-0-145" class="i">+                    if (isChecked) {
</a><a href="#h138-0-146" id="h138-0-146" class="i">+                        selectedConversations.add(friendFeedEntries[which])
</a><a href="#h138-0-147" id="h138-0-147" class="i">+                    } else if (selectedConversations.contains(friendFeedEntries[which])) {
</a><a href="#h138-0-148" id="h138-0-148" class="i">+                        selectedConversations.remove(friendFeedEntries[which])
</a><a href="#h138-0-149" id="h138-0-149" class="i">+                    }
</a><a href="#h138-0-150" id="h138-0-150" class="i">+                }
</a><a href="#h138-0-151" id="h138-0-151" class="i">+                .setNegativeButton(context.translation[&quot;chat_export.dialog_negative_button&quot;]) { dialog, _ -&gt;
</a><a href="#h138-0-152" id="h138-0-152" class="i">+                    dialog.dismiss()
</a><a href="#h138-0-153" id="h138-0-153" class="i">+                }
</a><a href="#h138-0-154" id="h138-0-154" class="i">+                .setNeutralButton(context.translation[&quot;chat_export.dialog_neutral_button&quot;]) { _, _ -&gt;
</a><a href="#h138-0-155" id="h138-0-155" class="i">+                    exportChatForConversations(friendFeedEntries)
</a><a href="#h138-0-156" id="h138-0-156" class="i">+                }
</a><a href="#h138-0-157" id="h138-0-157" class="i">+                .setPositiveButton(context.translation[&quot;chat_export.dialog_positive_button&quot;]) { _, _ -&gt;
</a><a href="#h138-0-158" id="h138-0-158" class="i">+                    exportChatForConversations(selectedConversations)
</a><a href="#h138-0-159" id="h138-0-159" class="i">+                }
</a><a href="#h138-0-160" id="h138-0-160" class="i">+                .show()
</a><a href="#h138-0-161" id="h138-0-161" class="i">+        }
</a><a href="#h138-0-162" id="h138-0-162" class="i">+    }
</a><a href="#h138-0-163" id="h138-0-163" class="i">+
</a><a href="#h138-0-164" id="h138-0-164" class="i">+    private suspend fun conversationAction(isEntering: Boolean, conversationId: String, conversationType: String?) = suspendCancellableCoroutine { continuation -&gt;
</a><a href="#h138-0-165" id="h138-0-165" class="i">+        val callback = CallbackBuilder(callbackClass)
</a><a href="#h138-0-166" id="h138-0-166" class="i">+            .override(&quot;onSuccess&quot;) { _ -&gt;
</a><a href="#h138-0-167" id="h138-0-167" class="i">+                continuation.resumeWith(Result.success(Unit))
</a><a href="#h138-0-168" id="h138-0-168" class="i">+            }
</a><a href="#h138-0-169" id="h138-0-169" class="i">+            .override(&quot;onError&quot;) {
</a><a href="#h138-0-170" id="h138-0-170" class="i">+                continuation.resumeWith(Result.failure(Exception(&quot;Failed to ${if (isEntering) &quot;enter&quot; else &quot;exit&quot;} conversation&quot;)))
</a><a href="#h138-0-171" id="h138-0-171" class="i">+            }.build()
</a><a href="#h138-0-172" id="h138-0-172" class="i">+
</a><a href="#h138-0-173" id="h138-0-173" class="i">+        if (isEntering) {
</a><a href="#h138-0-174" id="h138-0-174" class="i">+            enterConversationMethod.invoke(
</a><a href="#h138-0-175" id="h138-0-175" class="i">+                conversationManagerInstance,
</a><a href="#h138-0-176" id="h138-0-176" class="i">+                SnapUUID.fromString(conversationId).instanceNonNull(),
</a><a href="#h138-0-177" id="h138-0-177" class="i">+                enterConversationMethod.parameterTypes[1].enumConstants.first { it.toString() == conversationType },
</a><a href="#h138-0-178" id="h138-0-178" class="i">+                callback
</a><a href="#h138-0-179" id="h138-0-179" class="i">+            )
</a><a href="#h138-0-180" id="h138-0-180" class="i">+        } else {
</a><a href="#h138-0-181" id="h138-0-181" class="i">+            exitConversationMethod.invoke(
</a><a href="#h138-0-182" id="h138-0-182" class="i">+                conversationManagerInstance,
</a><a href="#h138-0-183" id="h138-0-183" class="i">+                SnapUUID.fromString(conversationId).instanceNonNull(),
</a><a href="#h138-0-184" id="h138-0-184" class="i">+                Long.MAX_VALUE,
</a><a href="#h138-0-185" id="h138-0-185" class="i">+                callback
</a><a href="#h138-0-186" id="h138-0-186" class="i">+            )
</a><a href="#h138-0-187" id="h138-0-187" class="i">+        }
</a><a href="#h138-0-188" id="h138-0-188" class="i">+    }
</a><a href="#h138-0-189" id="h138-0-189" class="i">+
</a><a href="#h138-0-190" id="h138-0-190" class="i">+    private suspend fun fetchMessagesPaginated(conversationId: String, lastMessageId: Long) = suspendCancellableCoroutine { continuation -&gt;
</a><a href="#h138-0-191" id="h138-0-191" class="i">+        val callback = CallbackBuilder(fetchConversationWithMessagesCallbackClass)
</a><a href="#h138-0-192" id="h138-0-192" class="i">+            .override(&quot;onFetchConversationWithMessagesComplete&quot;) { param -&gt;
</a><a href="#h138-0-193" id="h138-0-193" class="i">+                val messagesList = param.arg&lt;List&lt;*&gt;&gt;(1).map { Message(it) }
</a><a href="#h138-0-194" id="h138-0-194" class="i">+                continuation.resumeWith(Result.success(messagesList))
</a><a href="#h138-0-195" id="h138-0-195" class="i">+            }
</a><a href="#h138-0-196" id="h138-0-196" class="i">+            .override(&quot;onServerRequest&quot;, shouldUnhook = false) {}
</a><a href="#h138-0-197" id="h138-0-197" class="i">+            .override(&quot;onError&quot;) {
</a><a href="#h138-0-198" id="h138-0-198" class="i">+                continuation.resumeWith(Result.failure(Exception(&quot;Failed to fetch messages&quot;)))
</a><a href="#h138-0-199" id="h138-0-199" class="i">+            }.build()
</a><a href="#h138-0-200" id="h138-0-200" class="i">+
</a><a href="#h138-0-201" id="h138-0-201" class="i">+        fetchConversationWithMessagesPaginatedMethod.invoke(
</a><a href="#h138-0-202" id="h138-0-202" class="i">+            conversationManagerInstance,
</a><a href="#h138-0-203" id="h138-0-203" class="i">+            SnapUUID.fromString(conversationId).instanceNonNull(),
</a><a href="#h138-0-204" id="h138-0-204" class="i">+            lastMessageId,
</a><a href="#h138-0-205" id="h138-0-205" class="i">+            500,
</a><a href="#h138-0-206" id="h138-0-206" class="i">+            callback
</a><a href="#h138-0-207" id="h138-0-207" class="i">+        )
</a><a href="#h138-0-208" id="h138-0-208" class="i">+    }
</a><a href="#h138-0-209" id="h138-0-209" class="i">+
</a><a href="#h138-0-210" id="h138-0-210" class="i">+    private suspend fun exportFullConversation(friendFeedEntry: FriendFeedEntry) {
</a><a href="#h138-0-211" id="h138-0-211" class="i">+        //first fetch the first message
</a><a href="#h138-0-212" id="h138-0-212" class="i">+        val conversationId = friendFeedEntry.key!!
</a><a href="#h138-0-213" id="h138-0-213" class="i">+        val conversationName = friendFeedEntry.feedDisplayName ?: friendFeedEntry.friendDisplayName!!.split(&quot;|&quot;).lastOrNull() ?: &quot;unknown&quot;
</a><a href="#h138-0-214" id="h138-0-214" class="i">+
</a><a href="#h138-0-215" id="h138-0-215" class="i">+        runCatching {
</a><a href="#h138-0-216" id="h138-0-216" class="i">+            conversationAction(true, conversationId, if (friendFeedEntry.feedDisplayName != null) &quot;USERCREATEDGROUP&quot; else &quot;ONEONONE&quot;)
</a><a href="#h138-0-217" id="h138-0-217" class="i">+        }
</a><a href="#h138-0-218" id="h138-0-218" class="i">+
</a><a href="#h138-0-219" id="h138-0-219" class="i">+        logDialog(context.translation.format(&quot;chat_export.exporting_message&quot;, &quot;conversation&quot; to conversationName))
</a><a href="#h138-0-220" id="h138-0-220" class="i">+
</a><a href="#h138-0-221" id="h138-0-221" class="i">+        val foundMessages = fetchMessagesPaginated(conversationId, Long.MAX_VALUE).toMutableList()
</a><a href="#h138-0-222" id="h138-0-222" class="i">+        var lastMessageId = foundMessages.firstOrNull()?.messageDescriptor?.messageId ?: run {
</a><a href="#h138-0-223" id="h138-0-223" class="i">+            logDialog(context.translation[&quot;chat_export.no_messages_found&quot;])
</a><a href="#h138-0-224" id="h138-0-224" class="i">+            return
</a><a href="#h138-0-225" id="h138-0-225" class="i">+        }
</a><a href="#h138-0-226" id="h138-0-226" class="i">+
</a><a href="#h138-0-227" id="h138-0-227" class="i">+        while (true) {
</a><a href="#h138-0-228" id="h138-0-228" class="i">+            val messages = fetchMessagesPaginated(conversationId, lastMessageId)
</a><a href="#h138-0-229" id="h138-0-229" class="i">+            if (messages.isEmpty()) break
</a><a href="#h138-0-230" id="h138-0-230" class="i">+
</a><a href="#h138-0-231" id="h138-0-231" class="i">+            if (amountOfMessages != null &amp;&amp; messages.size + foundMessages.size &gt;= amountOfMessages!!) {
</a><a href="#h138-0-232" id="h138-0-232" class="i">+                foundMessages.addAll(messages.take(amountOfMessages!! - foundMessages.size))
</a><a href="#h138-0-233" id="h138-0-233" class="i">+                break
</a><a href="#h138-0-234" id="h138-0-234" class="i">+            }
</a><a href="#h138-0-235" id="h138-0-235" class="i">+
</a><a href="#h138-0-236" id="h138-0-236" class="i">+            foundMessages.addAll(messages)
</a><a href="#h138-0-237" id="h138-0-237" class="i">+            messages.firstOrNull()?.let {
</a><a href="#h138-0-238" id="h138-0-238" class="i">+                lastMessageId = it.messageDescriptor.messageId
</a><a href="#h138-0-239" id="h138-0-239" class="i">+            }
</a><a href="#h138-0-240" id="h138-0-240" class="i">+            setStatus(&quot;Exporting (${foundMessages.size} / ${foundMessages.firstOrNull()?.orderKey})&quot;)
</a><a href="#h138-0-241" id="h138-0-241" class="i">+        }
</a><a href="#h138-0-242" id="h138-0-242" class="i">+
</a><a href="#h138-0-243" id="h138-0-243" class="i">+        val outputFile = File(
</a><a href="#h138-0-244" id="h138-0-244" class="i">+            Environment.getExternalStoragePublicDirectory(Environment.DIRECTORY_DOWNLOADS),
</a><a href="#h138-0-245" id="h138-0-245" class="i">+            &quot;SnapEnhance/conversation_${conversationName}_${System.currentTimeMillis()}.${exportType!!.extension}&quot;
</a><a href="#h138-0-246" id="h138-0-246" class="i">+        ).also { it.parentFile?.mkdirs() }
</a><a href="#h138-0-247" id="h138-0-247" class="i">+
</a><a href="#h138-0-248" id="h138-0-248" class="i">+        logDialog(context.translation[&quot;chat_export.writing_output&quot;])
</a><a href="#h138-0-249" id="h138-0-249" class="i">+
</a><a href="#h138-0-250" id="h138-0-250" class="i">+        runCatching {
</a><a href="#h138-0-251" id="h138-0-251" class="i">+            MessageExporter(
</a><a href="#h138-0-252" id="h138-0-252" class="i">+                context = context,
</a><a href="#h138-0-253" id="h138-0-253" class="i">+                friendFeedEntry = friendFeedEntry,
</a><a href="#h138-0-254" id="h138-0-254" class="i">+                outputFile = outputFile,
</a><a href="#h138-0-255" id="h138-0-255" class="i">+                mediaToDownload = mediaToDownload,
</a><a href="#h138-0-256" id="h138-0-256" class="i">+                printLog = ::logDialog
</a><a href="#h138-0-257" id="h138-0-257" class="i">+            ).apply { readMessages(foundMessages) }.exportTo(exportType!!)
</a><a href="#h138-0-258" id="h138-0-258" class="i">+        }.onFailure {
</a><a href="#h138-0-259" id="h138-0-259" class="i">+            logDialog(context.translation.format(&quot;chat_export.export_failed&quot;,&quot;conversation&quot; to it.message.toString()))
</a><a href="#h138-0-260" id="h138-0-260" class="i">+            context.log.error(&quot;Failed to export conversation $conversationName&quot;, it)
</a><a href="#h138-0-261" id="h138-0-261" class="i">+            return
</a><a href="#h138-0-262" id="h138-0-262" class="i">+        }
</a><a href="#h138-0-263" id="h138-0-263" class="i">+
</a><a href="#h138-0-264" id="h138-0-264" class="i">+        dialogLogs.clear()
</a><a href="#h138-0-265" id="h138-0-265" class="i">+        logDialog(&quot;\n&quot; + context.translation.format(&quot;chat_export.exported_to&quot;,
</a><a href="#h138-0-266" id="h138-0-266" class="i">+            &quot;path&quot; to outputFile.absolutePath.toString()
</a><a href="#h138-0-267" id="h138-0-267" class="i">+        ) + &quot;\n&quot;)
</a><a href="#h138-0-268" id="h138-0-268" class="i">+
</a><a href="#h138-0-269" id="h138-0-269" class="i">+        runCatching {
</a><a href="#h138-0-270" id="h138-0-270" class="i">+            conversationAction(false, conversationId, null)
</a><a href="#h138-0-271" id="h138-0-271" class="i">+        }
</a><a href="#h138-0-272" id="h138-0-272" class="i">+    }
</a><a href="#h138-0-273" id="h138-0-273" class="i">+
</a><a href="#h138-0-274" id="h138-0-274" class="i">+    private fun exportChatForConversations(conversations: List&lt;FriendFeedEntry&gt;) {
</a><a href="#h138-0-275" id="h138-0-275" class="i">+        dialogLogs.clear()
</a><a href="#h138-0-276" id="h138-0-276" class="i">+        val jobs = mutableListOf&lt;Job&gt;()
</a><a href="#h138-0-277" id="h138-0-277" class="i">+
</a><a href="#h138-0-278" id="h138-0-278" class="i">+        currentActionDialog = ViewAppearanceHelper.newAlertDialogBuilder(context.mainActivity)
</a><a href="#h138-0-279" id="h138-0-279" class="i">+            .setTitle(context.translation[&quot;chat_export.exporting_chats&quot;])
</a><a href="#h138-0-280" id="h138-0-280" class="i">+            .setCancelable(false)
</a><a href="#h138-0-281" id="h138-0-281" class="i">+            .setMessage(&quot;&quot;)
</a><a href="#h138-0-282" id="h138-0-282" class="i">+            .create()
</a><a href="#h138-0-283" id="h138-0-283" class="i">+        
</a><a href="#h138-0-284" id="h138-0-284" class="i">+        val conversationSize = context.translation.format(&quot;chat_export.processing_chats&quot;, &quot;amount&quot; to conversations.size.toString())
</a><a href="#h138-0-285" id="h138-0-285" class="i">+        
</a><a href="#h138-0-286" id="h138-0-286" class="i">+        logDialog(conversationSize)
</a><a href="#h138-0-287" id="h138-0-287" class="i">+
</a><a href="#h138-0-288" id="h138-0-288" class="i">+        context.coroutineScope.launch {
</a><a href="#h138-0-289" id="h138-0-289" class="i">+            conversations.forEach { conversation -&gt;
</a><a href="#h138-0-290" id="h138-0-290" class="i">+                launch {
</a><a href="#h138-0-291" id="h138-0-291" class="i">+                    runCatching {
</a><a href="#h138-0-292" id="h138-0-292" class="i">+                        exportFullConversation(conversation)
</a><a href="#h138-0-293" id="h138-0-293" class="i">+                    }.onFailure {
</a><a href="#h138-0-294" id="h138-0-294" class="i">+                        logDialog(context.translation.format(&quot;chat_export.export_fail&quot;, &quot;conversation&quot; to conversation.key.toString()))
</a><a href="#h138-0-295" id="h138-0-295" class="i">+                        logDialog(it.stackTraceToString())
</a><a href="#h138-0-296" id="h138-0-296" class="i">+                        CoreLogger.xposedLog(it)
</a><a href="#h138-0-297" id="h138-0-297" class="i">+                    }
</a><a href="#h138-0-298" id="h138-0-298" class="i">+                }.also { jobs.add(it) }
</a><a href="#h138-0-299" id="h138-0-299" class="i">+            }
</a><a href="#h138-0-300" id="h138-0-300" class="i">+            jobs.joinAll()
</a><a href="#h138-0-301" id="h138-0-301" class="i">+            logDialog(context.translation[&quot;chat_export.finished&quot;])
</a><a href="#h138-0-302" id="h138-0-302" class="i">+        }.also {
</a><a href="#h138-0-303" id="h138-0-303" class="i">+            currentActionDialog?.setButton(DialogInterface.BUTTON_POSITIVE, context.translation[&quot;chat_export.dialog_negative_button&quot;]) { dialog, _ -&gt;
</a><a href="#h138-0-304" id="h138-0-304" class="i">+                it.cancel()
</a><a href="#h138-0-305" id="h138-0-305" class="i">+                jobs.forEach { it.cancel() }
</a><a href="#h138-0-306" id="h138-0-306" class="i">+                dialog.dismiss()
</a><a href="#h138-0-307" id="h138-0-307" class="i">+            }
</a><a href="#h138-0-308" id="h138-0-308" class="i">+        }
</a><a href="#h138-0-309" id="h138-0-309" class="i">+
</a><a href="#h138-0-310" id="h138-0-310" class="i">+        currentActionDialog!!.show()
</a><a href="#h138-0-311" id="h138-0-311" class="i">+    }
</a><a href="#h138-0-312" id="h138-0-312" class="i">+}</a><a href="#h138-0-313" id="h138-0-313" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h139" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/action/impl/OpenMap.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/action/impl/OpenMap.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/action/impl/OpenMap.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/action/impl/OpenMap.kt</a></b>
<a href="#h139-0" id="h139-0" class="h">@@ -0,0 +1,21 @@
</a><a href="#h139-0-0" id="h139-0-0" class="i">+package me.rhunk.snapenhance.core.action.impl
</a><a href="#h139-0-1" id="h139-0-1" class="i">+
</a><a href="#h139-0-2" id="h139-0-2" class="i">+import android.content.Intent
</a><a href="#h139-0-3" id="h139-0-3" class="i">+import android.os.Bundle
</a><a href="#h139-0-4" id="h139-0-4" class="i">+import me.rhunk.snapenhance.common.BuildConfig
</a><a href="#h139-0-5" id="h139-0-5" class="i">+import me.rhunk.snapenhance.core.action.AbstractAction
</a><a href="#h139-0-6" id="h139-0-6" class="i">+
</a><a href="#h139-0-7" id="h139-0-7" class="i">+class OpenMap: AbstractAction() {
</a><a href="#h139-0-8" id="h139-0-8" class="i">+    override fun run() {
</a><a href="#h139-0-9" id="h139-0-9" class="i">+        context.runOnUiThread {
</a><a href="#h139-0-10" id="h139-0-10" class="i">+            val mapActivityIntent = Intent()
</a><a href="#h139-0-11" id="h139-0-11" class="i">+            mapActivityIntent.setClassName(BuildConfig.APPLICATION_ID, BuildConfig.APPLICATION_ID + &quot;.ui.MapActivity&quot;)
</a><a href="#h139-0-12" id="h139-0-12" class="i">+            mapActivityIntent.putExtra(&quot;location&quot;, Bundle().apply {
</a><a href="#h139-0-13" id="h139-0-13" class="i">+                putDouble(&quot;latitude&quot;, context.config.experimental.spoof.location.latitude.get().toDouble())
</a><a href="#h139-0-14" id="h139-0-14" class="i">+                putDouble(&quot;longitude&quot;, context.config.experimental.spoof.location.longitude.get().toDouble())
</a><a href="#h139-0-15" id="h139-0-15" class="i">+            })
</a><a href="#h139-0-16" id="h139-0-16" class="i">+
</a><a href="#h139-0-17" id="h139-0-17" class="i">+            context.mainActivity!!.startActivityForResult(mapActivityIntent, 0x1337)
</a><a href="#h139-0-18" id="h139-0-18" class="i">+        }
</a><a href="#h139-0-19" id="h139-0-19" class="i">+    }
</a><a href="#h139-0-20" id="h139-0-20" class="i">+}</a><a href="#h139-0-21" id="h139-0-21" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h140" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/BridgeClient.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/BridgeClient.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/BridgeClient.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/BridgeClient.kt</a></b>
<a href="#h140-0" id="h140-0" class="h">@@ -10,24 +10,32 @@ import android.os.Handler
</a> import android.os.HandlerThread
 import android.os.IBinder
 import de.robv.android.xposed.XposedHelpers
<a href="#h140-0-3" id="h140-0-3" class="d">-import me.rhunk.snapenhance.ModContext
</a> import me.rhunk.snapenhance.bridge.BridgeInterface
 import me.rhunk.snapenhance.bridge.ConfigStateListener
 import me.rhunk.snapenhance.bridge.DownloadCallback
 import me.rhunk.snapenhance.bridge.SyncCallback
 import me.rhunk.snapenhance.bridge.e2ee.E2eeInterface
 import me.rhunk.snapenhance.bridge.scripting.IScripting
<a href="#h140-0-10" id="h140-0-10" class="d">-import me.rhunk.snapenhance.core.BuildConfig
</a><a href="#h140-0-11" id="h140-0-11" class="d">-import me.rhunk.snapenhance.core.bridge.types.BridgeFileType
</a><a href="#h140-0-12" id="h140-0-12" class="d">-import me.rhunk.snapenhance.core.bridge.types.FileActionType
</a><a href="#h140-0-13" id="h140-0-13" class="d">-import me.rhunk.snapenhance.core.messaging.MessagingRuleType
</a><a href="#h140-0-14" id="h140-0-14" class="d">-import me.rhunk.snapenhance.core.messaging.SocialScope
</a><a href="#h140-0-15" id="h140-0-15" class="d">-import me.rhunk.snapenhance.data.LocalePair
</a><a href="#h140-0-16" id="h140-0-16" class="i">+import me.rhunk.snapenhance.common.BuildConfig
</a><a href="#h140-0-17" id="h140-0-17" class="i">+import me.rhunk.snapenhance.common.bridge.FileLoaderWrapper
</a><a href="#h140-0-18" id="h140-0-18" class="i">+import me.rhunk.snapenhance.common.bridge.types.BridgeFileType
</a><a href="#h140-0-19" id="h140-0-19" class="i">+import me.rhunk.snapenhance.common.bridge.types.FileActionType
</a><a href="#h140-0-20" id="h140-0-20" class="i">+import me.rhunk.snapenhance.common.bridge.types.LocalePair
</a><a href="#h140-0-21" id="h140-0-21" class="i">+import me.rhunk.snapenhance.common.data.MessagingRuleType
</a><a href="#h140-0-22" id="h140-0-22" class="i">+import me.rhunk.snapenhance.common.data.SocialScope
</a><a href="#h140-0-23" id="h140-0-23" class="i">+import me.rhunk.snapenhance.core.ModContext
</a> import java.util.concurrent.CompletableFuture
 import java.util.concurrent.Executors
 import java.util.concurrent.TimeUnit
 import kotlin.system.exitProcess
 
<a href="#h140-0-29" id="h140-0-29" class="i">+fun FileLoaderWrapper.loadFromBridge(bridgeClient: BridgeClient) {
</a><a href="#h140-0-30" id="h140-0-30" class="i">+    isFileExists = { bridgeClient.isFileExists(fileType) }
</a><a href="#h140-0-31" id="h140-0-31" class="i">+    read = { bridgeClient.createAndReadFile(fileType, defaultContent) }
</a><a href="#h140-0-32" id="h140-0-32" class="i">+    write = { bridgeClient.writeFile(fileType, it) }
</a><a href="#h140-0-33" id="h140-0-33" class="i">+    delete = { bridgeClient.deleteFile(fileType) }
</a><a href="#h140-0-34" id="h140-0-34" class="i">+}
</a><a href="#h140-0-35" id="h140-0-35" class="i">+
</a> 
 class BridgeClient(
     private val context: ModContext
<a href="#h140-1" id="h140-1" class="h">@@ -35,10 +43,6 @@ class BridgeClient(
</a>     private lateinit var future: CompletableFuture&lt;Boolean&gt;
     private lateinit var service: BridgeInterface
 
<a href="#h140-1-3" id="h140-1-3" class="d">-    companion object {
</a><a href="#h140-1-4" id="h140-1-4" class="d">-        const val BRIDGE_SYNC_ACTION = BuildConfig.APPLICATION_ID + &quot;.core.bridge.SYNC&quot;
</a><a href="#h140-1-5" id="h140-1-5" class="d">-    }
</a><a href="#h140-1-6" id="h140-1-6" class="d">-
</a>     fun connect(timeout: (Throwable) -&gt; Unit, onResult: (Boolean) -&gt; Unit) {
         this.future = CompletableFuture()
 
<b>diff --git a/<a id="h141" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/FileLoaderWrapper.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/FileLoaderWrapper.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/FileLoaderWrapper.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/FileLoaderWrapper.kt</a></b>
<a href="#h141-0" id="h141-0" class="h">@@ -1,35 +0,0 @@
</a><a href="#h141-0-0" id="h141-0-0" class="d">-package me.rhunk.snapenhance.core.bridge
</a><a href="#h141-0-1" id="h141-0-1" class="d">-
</a><a href="#h141-0-2" id="h141-0-2" class="d">-import android.content.Context
</a><a href="#h141-0-3" id="h141-0-3" class="d">-import me.rhunk.snapenhance.core.bridge.types.BridgeFileType
</a><a href="#h141-0-4" id="h141-0-4" class="d">-
</a><a href="#h141-0-5" id="h141-0-5" class="d">-open class FileLoaderWrapper(
</a><a href="#h141-0-6" id="h141-0-6" class="d">-    private val fileType: BridgeFileType,
</a><a href="#h141-0-7" id="h141-0-7" class="d">-    private val defaultContent: ByteArray
</a><a href="#h141-0-8" id="h141-0-8" class="d">-) {
</a><a href="#h141-0-9" id="h141-0-9" class="d">-    lateinit var isFileExists: () -&gt; Boolean
</a><a href="#h141-0-10" id="h141-0-10" class="d">-    lateinit var write: (ByteArray) -&gt; Unit
</a><a href="#h141-0-11" id="h141-0-11" class="d">-    lateinit var read: () -&gt; ByteArray
</a><a href="#h141-0-12" id="h141-0-12" class="d">-    lateinit var delete: () -&gt; Unit
</a><a href="#h141-0-13" id="h141-0-13" class="d">-
</a><a href="#h141-0-14" id="h141-0-14" class="d">-    fun loadFromContext(context: Context) {
</a><a href="#h141-0-15" id="h141-0-15" class="d">-        val file = fileType.resolve(context)
</a><a href="#h141-0-16" id="h141-0-16" class="d">-        isFileExists = { file.exists() }
</a><a href="#h141-0-17" id="h141-0-17" class="d">-        read = {
</a><a href="#h141-0-18" id="h141-0-18" class="d">-            if (!file.exists()) {
</a><a href="#h141-0-19" id="h141-0-19" class="d">-                file.createNewFile()
</a><a href="#h141-0-20" id="h141-0-20" class="d">-                file.writeBytes(&quot;{}&quot;.toByteArray(Charsets.UTF_8))
</a><a href="#h141-0-21" id="h141-0-21" class="d">-            }
</a><a href="#h141-0-22" id="h141-0-22" class="d">-            file.readBytes()
</a><a href="#h141-0-23" id="h141-0-23" class="d">-        }
</a><a href="#h141-0-24" id="h141-0-24" class="d">-        write = { file.writeBytes(it) }
</a><a href="#h141-0-25" id="h141-0-25" class="d">-        delete = { file.delete() }
</a><a href="#h141-0-26" id="h141-0-26" class="d">-    }
</a><a href="#h141-0-27" id="h141-0-27" class="d">-
</a><a href="#h141-0-28" id="h141-0-28" class="d">-    fun loadFromBridge(bridgeClient: BridgeClient) {
</a><a href="#h141-0-29" id="h141-0-29" class="d">-        isFileExists = { bridgeClient.isFileExists(fileType) }
</a><a href="#h141-0-30" id="h141-0-30" class="d">-        read = { bridgeClient.createAndReadFile(fileType, defaultContent) }
</a><a href="#h141-0-31" id="h141-0-31" class="d">-        write = { bridgeClient.writeFile(fileType, it) }
</a><a href="#h141-0-32" id="h141-0-32" class="d">-        delete = { bridgeClient.deleteFile(fileType) }
</a><a href="#h141-0-33" id="h141-0-33" class="d">-    }
</a><a href="#h141-0-34" id="h141-0-34" class="d">-}</a><a href="#h141-0-35" id="h141-0-35" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h142" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/types/BridgeFileType.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/types/BridgeFileType.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/types/BridgeFileType.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/types/BridgeFileType.kt</a></b>
<a href="#h142-0" id="h142-0" class="h">@@ -1,24 +0,0 @@
</a><a href="#h142-0-0" id="h142-0-0" class="d">-package me.rhunk.snapenhance.core.bridge.types
</a><a href="#h142-0-1" id="h142-0-1" class="d">-
</a><a href="#h142-0-2" id="h142-0-2" class="d">-import android.content.Context
</a><a href="#h142-0-3" id="h142-0-3" class="d">-import java.io.File
</a><a href="#h142-0-4" id="h142-0-4" class="d">-
</a><a href="#h142-0-5" id="h142-0-5" class="d">-
</a><a href="#h142-0-6" id="h142-0-6" class="d">-enum class BridgeFileType(val value: Int, val fileName: String, val displayName: String, private val isDatabase: Boolean = false) {
</a><a href="#h142-0-7" id="h142-0-7" class="d">-    CONFIG(0, &quot;config.json&quot;, &quot;Config&quot;),
</a><a href="#h142-0-8" id="h142-0-8" class="d">-    MAPPINGS(1, &quot;mappings.json&quot;, &quot;Mappings&quot;),
</a><a href="#h142-0-9" id="h142-0-9" class="d">-    MESSAGE_LOGGER_DATABASE(2, &quot;message_logger.db&quot;, &quot;Message Logger&quot;,true),
</a><a href="#h142-0-10" id="h142-0-10" class="d">-    PINNED_CONVERSATIONS(3, &quot;pinned_conversations.txt&quot;, &quot;Pinned Conversations&quot;);
</a><a href="#h142-0-11" id="h142-0-11" class="d">-
</a><a href="#h142-0-12" id="h142-0-12" class="d">-    fun resolve(context: Context): File = if (isDatabase) {
</a><a href="#h142-0-13" id="h142-0-13" class="d">-        context.getDatabasePath(fileName)
</a><a href="#h142-0-14" id="h142-0-14" class="d">-    } else {
</a><a href="#h142-0-15" id="h142-0-15" class="d">-        File(context.filesDir, fileName)
</a><a href="#h142-0-16" id="h142-0-16" class="d">-    }
</a><a href="#h142-0-17" id="h142-0-17" class="d">-
</a><a href="#h142-0-18" id="h142-0-18" class="d">-    companion object {
</a><a href="#h142-0-19" id="h142-0-19" class="d">-        fun fromValue(value: Int): BridgeFileType? {
</a><a href="#h142-0-20" id="h142-0-20" class="d">-            return entries.firstOrNull { it.value == value }
</a><a href="#h142-0-21" id="h142-0-21" class="d">-        }
</a><a href="#h142-0-22" id="h142-0-22" class="d">-    }
</a><a href="#h142-0-23" id="h142-0-23" class="d">-}</a><a href="#h142-0-24" id="h142-0-24" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h143" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/types/FileActionType.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/types/FileActionType.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/types/FileActionType.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/types/FileActionType.kt</a></b>
<a href="#h143-0" id="h143-0" class="h">@@ -1,5 +0,0 @@
</a><a href="#h143-0-0" id="h143-0-0" class="d">-package me.rhunk.snapenhance.core.bridge.types
</a><a href="#h143-0-1" id="h143-0-1" class="d">-
</a><a href="#h143-0-2" id="h143-0-2" class="d">-enum class FileActionType {
</a><a href="#h143-0-3" id="h143-0-3" class="d">-    CREATE_AND_READ, READ, WRITE, DELETE, EXISTS
</a><a href="#h143-0-4" id="h143-0-4" class="d">-}</a><a href="#h143-0-5" id="h143-0-5" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h144" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/wrapper/LocaleWrapper.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/wrapper/LocaleWrapper.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/wrapper/LocaleWrapper.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/wrapper/LocaleWrapper.kt</a></b>
<a href="#h144-0" id="h144-0" class="h">@@ -1,100 +0,0 @@
</a><a href="#h144-0-0" id="h144-0-0" class="d">-package me.rhunk.snapenhance.core.bridge.wrapper
</a><a href="#h144-0-1" id="h144-0-1" class="d">-
</a><a href="#h144-0-2" id="h144-0-2" class="d">-import android.content.Context
</a><a href="#h144-0-3" id="h144-0-3" class="d">-import com.google.gson.JsonObject
</a><a href="#h144-0-4" id="h144-0-4" class="d">-import com.google.gson.JsonParser
</a><a href="#h144-0-5" id="h144-0-5" class="d">-import me.rhunk.snapenhance.core.Logger
</a><a href="#h144-0-6" id="h144-0-6" class="d">-import me.rhunk.snapenhance.core.bridge.BridgeClient
</a><a href="#h144-0-7" id="h144-0-7" class="d">-import me.rhunk.snapenhance.data.LocalePair
</a><a href="#h144-0-8" id="h144-0-8" class="d">-import java.util.Locale
</a><a href="#h144-0-9" id="h144-0-9" class="d">-
</a><a href="#h144-0-10" id="h144-0-10" class="d">-
</a><a href="#h144-0-11" id="h144-0-11" class="d">-class LocaleWrapper {
</a><a href="#h144-0-12" id="h144-0-12" class="d">-    companion object {
</a><a href="#h144-0-13" id="h144-0-13" class="d">-        const val DEFAULT_LOCALE = &quot;en_US&quot;
</a><a href="#h144-0-14" id="h144-0-14" class="d">-
</a><a href="#h144-0-15" id="h144-0-15" class="d">-        fun fetchLocales(context: Context, locale: String = DEFAULT_LOCALE): List&lt;LocalePair&gt; {
</a><a href="#h144-0-16" id="h144-0-16" class="d">-            val locales = mutableListOf&lt;LocalePair&gt;().apply {
</a><a href="#h144-0-17" id="h144-0-17" class="d">-                add(LocalePair(DEFAULT_LOCALE, context.resources.assets.open(&quot;lang/$DEFAULT_LOCALE.json&quot;).bufferedReader().use { it.readText() }))
</a><a href="#h144-0-18" id="h144-0-18" class="d">-            }
</a><a href="#h144-0-19" id="h144-0-19" class="d">-
</a><a href="#h144-0-20" id="h144-0-20" class="d">-            if (locale == DEFAULT_LOCALE) return locales
</a><a href="#h144-0-21" id="h144-0-21" class="d">-
</a><a href="#h144-0-22" id="h144-0-22" class="d">-            val compatibleLocale = context.resources.assets.list(&quot;lang&quot;)?.firstOrNull { it.startsWith(locale) }?.substring(0, 5) ?: return locales
</a><a href="#h144-0-23" id="h144-0-23" class="d">-
</a><a href="#h144-0-24" id="h144-0-24" class="d">-            context.resources.assets.open(&quot;lang/$compatibleLocale.json&quot;).use { inputStream -&gt;
</a><a href="#h144-0-25" id="h144-0-25" class="d">-                locales.add(LocalePair(compatibleLocale, inputStream.bufferedReader().use { it.readText() }))
</a><a href="#h144-0-26" id="h144-0-26" class="d">-            }
</a><a href="#h144-0-27" id="h144-0-27" class="d">-
</a><a href="#h144-0-28" id="h144-0-28" class="d">-            return locales
</a><a href="#h144-0-29" id="h144-0-29" class="d">-        }
</a><a href="#h144-0-30" id="h144-0-30" class="d">-
</a><a href="#h144-0-31" id="h144-0-31" class="d">-        fun fetchAvailableLocales(context: Context): List&lt;String&gt; {
</a><a href="#h144-0-32" id="h144-0-32" class="d">-            return context.resources.assets.list(&quot;lang&quot;)?.map { it.substring(0, 5) } ?: listOf()
</a><a href="#h144-0-33" id="h144-0-33" class="d">-        }
</a><a href="#h144-0-34" id="h144-0-34" class="d">-    }
</a><a href="#h144-0-35" id="h144-0-35" class="d">-
</a><a href="#h144-0-36" id="h144-0-36" class="d">-    var userLocale = DEFAULT_LOCALE
</a><a href="#h144-0-37" id="h144-0-37" class="d">-
</a><a href="#h144-0-38" id="h144-0-38" class="d">-    private val translationMap = linkedMapOf&lt;String, String&gt;()
</a><a href="#h144-0-39" id="h144-0-39" class="d">-
</a><a href="#h144-0-40" id="h144-0-40" class="d">-    lateinit var loadedLocale: Locale
</a><a href="#h144-0-41" id="h144-0-41" class="d">-
</a><a href="#h144-0-42" id="h144-0-42" class="d">-    private fun load(localePair: LocalePair) {
</a><a href="#h144-0-43" id="h144-0-43" class="d">-        loadedLocale = localePair.locale.let { Locale(it.substring(0, 2), it.substring(3, 5)) }
</a><a href="#h144-0-44" id="h144-0-44" class="d">-
</a><a href="#h144-0-45" id="h144-0-45" class="d">-        val translations = JsonParser.parseString(localePair.content).asJsonObject
</a><a href="#h144-0-46" id="h144-0-46" class="d">-        if (translations == null || translations.isJsonNull) {
</a><a href="#h144-0-47" id="h144-0-47" class="d">-            return
</a><a href="#h144-0-48" id="h144-0-48" class="d">-        }
</a><a href="#h144-0-49" id="h144-0-49" class="d">-
</a><a href="#h144-0-50" id="h144-0-50" class="d">-        fun scanObject(jsonObject: JsonObject, prefix: String = &quot;&quot;) {
</a><a href="#h144-0-51" id="h144-0-51" class="d">-            jsonObject.entrySet().forEach {
</a><a href="#h144-0-52" id="h144-0-52" class="d">-                if (it.value.isJsonPrimitive) {
</a><a href="#h144-0-53" id="h144-0-53" class="d">-                    val key = &quot;$prefix${it.key}&quot;
</a><a href="#h144-0-54" id="h144-0-54" class="d">-                    translationMap[key] = it.value.asString
</a><a href="#h144-0-55" id="h144-0-55" class="d">-                }
</a><a href="#h144-0-56" id="h144-0-56" class="d">-                if (!it.value.isJsonObject) return@forEach
</a><a href="#h144-0-57" id="h144-0-57" class="d">-                scanObject(it.value.asJsonObject, &quot;$prefix${it.key}.&quot;)
</a><a href="#h144-0-58" id="h144-0-58" class="d">-            }
</a><a href="#h144-0-59" id="h144-0-59" class="d">-        }
</a><a href="#h144-0-60" id="h144-0-60" class="d">-
</a><a href="#h144-0-61" id="h144-0-61" class="d">-        scanObject(translations)
</a><a href="#h144-0-62" id="h144-0-62" class="d">-    }
</a><a href="#h144-0-63" id="h144-0-63" class="d">-
</a><a href="#h144-0-64" id="h144-0-64" class="d">-    fun loadFromBridge(bridgeClient: BridgeClient) {
</a><a href="#h144-0-65" id="h144-0-65" class="d">-        bridgeClient.fetchLocales(userLocale).forEach {
</a><a href="#h144-0-66" id="h144-0-66" class="d">-            load(it)
</a><a href="#h144-0-67" id="h144-0-67" class="d">-        }
</a><a href="#h144-0-68" id="h144-0-68" class="d">-    }
</a><a href="#h144-0-69" id="h144-0-69" class="d">-
</a><a href="#h144-0-70" id="h144-0-70" class="d">-    fun loadFromContext(context: Context) {
</a><a href="#h144-0-71" id="h144-0-71" class="d">-        fetchLocales(context, userLocale).forEach {
</a><a href="#h144-0-72" id="h144-0-72" class="d">-            load(it)
</a><a href="#h144-0-73" id="h144-0-73" class="d">-        }
</a><a href="#h144-0-74" id="h144-0-74" class="d">-    }
</a><a href="#h144-0-75" id="h144-0-75" class="d">-
</a><a href="#h144-0-76" id="h144-0-76" class="d">-    fun reloadFromContext(context: Context, locale: String) {
</a><a href="#h144-0-77" id="h144-0-77" class="d">-        userLocale = locale
</a><a href="#h144-0-78" id="h144-0-78" class="d">-        translationMap.clear()
</a><a href="#h144-0-79" id="h144-0-79" class="d">-        loadFromContext(context)
</a><a href="#h144-0-80" id="h144-0-80" class="d">-    }
</a><a href="#h144-0-81" id="h144-0-81" class="d">-
</a><a href="#h144-0-82" id="h144-0-82" class="d">-    operator fun get(key: String) = translationMap[key] ?: key.also { Logger.directDebug(&quot;Missing translation for $key&quot;) }
</a><a href="#h144-0-83" id="h144-0-83" class="d">-
</a><a href="#h144-0-84" id="h144-0-84" class="d">-    fun format(key: String, vararg args: Pair&lt;String, String&gt;): String {
</a><a href="#h144-0-85" id="h144-0-85" class="d">-        return args.fold(get(key)) { acc, pair -&gt;
</a><a href="#h144-0-86" id="h144-0-86" class="d">-            acc.replace(&quot;{${pair.first}}&quot;, pair.second)
</a><a href="#h144-0-87" id="h144-0-87" class="d">-        }
</a><a href="#h144-0-88" id="h144-0-88" class="d">-    }
</a><a href="#h144-0-89" id="h144-0-89" class="d">-
</a><a href="#h144-0-90" id="h144-0-90" class="d">-    fun getCategory(key: String): LocaleWrapper {
</a><a href="#h144-0-91" id="h144-0-91" class="d">-        return LocaleWrapper().apply {
</a><a href="#h144-0-92" id="h144-0-92" class="d">-            translationMap.putAll(
</a><a href="#h144-0-93" id="h144-0-93" class="d">-                this@LocaleWrapper.translationMap
</a><a href="#h144-0-94" id="h144-0-94" class="d">-                    .filterKeys { it.startsWith(&quot;$key.&quot;) }
</a><a href="#h144-0-95" id="h144-0-95" class="d">-                    .mapKeys { it.key.substring(key.length + 1) }
</a><a href="#h144-0-96" id="h144-0-96" class="d">-            )
</a><a href="#h144-0-97" id="h144-0-97" class="d">-        }
</a><a href="#h144-0-98" id="h144-0-98" class="d">-    }
</a><a href="#h144-0-99" id="h144-0-99" class="d">-}</a><a href="#h144-0-100" id="h144-0-100" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h145" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/wrapper/MappingsWrapper.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/wrapper/MappingsWrapper.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/wrapper/MappingsWrapper.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/wrapper/MappingsWrapper.kt</a></b>
<a href="#h145-0" id="h145-0" class="h">@@ -1,151 +0,0 @@
</a><a href="#h145-0-0" id="h145-0-0" class="d">-package me.rhunk.snapenhance.core.bridge.wrapper
</a><a href="#h145-0-1" id="h145-0-1" class="d">-
</a><a href="#h145-0-2" id="h145-0-2" class="d">-import android.content.Context
</a><a href="#h145-0-3" id="h145-0-3" class="d">-import com.google.gson.GsonBuilder
</a><a href="#h145-0-4" id="h145-0-4" class="d">-import com.google.gson.JsonElement
</a><a href="#h145-0-5" id="h145-0-5" class="d">-import com.google.gson.JsonParser
</a><a href="#h145-0-6" id="h145-0-6" class="d">-import me.rhunk.snapenhance.Constants
</a><a href="#h145-0-7" id="h145-0-7" class="d">-import me.rhunk.snapenhance.core.Logger
</a><a href="#h145-0-8" id="h145-0-8" class="d">-import me.rhunk.snapenhance.core.bridge.FileLoaderWrapper
</a><a href="#h145-0-9" id="h145-0-9" class="d">-import me.rhunk.snapenhance.core.bridge.types.BridgeFileType
</a><a href="#h145-0-10" id="h145-0-10" class="d">-import me.rhunk.snapenhance.mapper.Mapper
</a><a href="#h145-0-11" id="h145-0-11" class="d">-import me.rhunk.snapenhance.mapper.impl.*
</a><a href="#h145-0-12" id="h145-0-12" class="d">-import java.util.concurrent.ConcurrentHashMap
</a><a href="#h145-0-13" id="h145-0-13" class="d">-import kotlin.system.measureTimeMillis
</a><a href="#h145-0-14" id="h145-0-14" class="d">-
</a><a href="#h145-0-15" id="h145-0-15" class="d">-class MappingsWrapper : FileLoaderWrapper(BridgeFileType.MAPPINGS, &quot;{}&quot;.toByteArray(Charsets.UTF_8)) {
</a><a href="#h145-0-16" id="h145-0-16" class="d">-    companion object {
</a><a href="#h145-0-17" id="h145-0-17" class="d">-        private val gson = GsonBuilder().setPrettyPrinting().create()
</a><a href="#h145-0-18" id="h145-0-18" class="d">-        private val mappers = arrayOf(
</a><a href="#h145-0-19" id="h145-0-19" class="d">-            BCryptClassMapper::class,
</a><a href="#h145-0-20" id="h145-0-20" class="d">-            CallbackMapper::class,
</a><a href="#h145-0-21" id="h145-0-21" class="d">-            DefaultMediaItemMapper::class,
</a><a href="#h145-0-22" id="h145-0-22" class="d">-            MediaQualityLevelProviderMapper::class,
</a><a href="#h145-0-23" id="h145-0-23" class="d">-            OperaPageViewControllerMapper::class,
</a><a href="#h145-0-24" id="h145-0-24" class="d">-            PlatformAnalyticsCreatorMapper::class,
</a><a href="#h145-0-25" id="h145-0-25" class="d">-            PlusSubscriptionMapper::class,
</a><a href="#h145-0-26" id="h145-0-26" class="d">-            ScCameraSettingsMapper::class,
</a><a href="#h145-0-27" id="h145-0-27" class="d">-            StoryBoostStateMapper::class,
</a><a href="#h145-0-28" id="h145-0-28" class="d">-            FriendsFeedEventDispatcherMapper::class,
</a><a href="#h145-0-29" id="h145-0-29" class="d">-            CompositeConfigurationProviderMapper::class,
</a><a href="#h145-0-30" id="h145-0-30" class="d">-            ScoreUpdateMapper::class,
</a><a href="#h145-0-31" id="h145-0-31" class="d">-            FriendRelationshipChangerMapper::class,
</a><a href="#h145-0-32" id="h145-0-32" class="d">-            ViewBinderMapper::class,
</a><a href="#h145-0-33" id="h145-0-33" class="d">-        )
</a><a href="#h145-0-34" id="h145-0-34" class="d">-    }
</a><a href="#h145-0-35" id="h145-0-35" class="d">-
</a><a href="#h145-0-36" id="h145-0-36" class="d">-    private lateinit var context: Context
</a><a href="#h145-0-37" id="h145-0-37" class="d">-
</a><a href="#h145-0-38" id="h145-0-38" class="d">-    private val mappings = ConcurrentHashMap&lt;String, Any&gt;()
</a><a href="#h145-0-39" id="h145-0-39" class="d">-    private var snapBuildNumber: Long = 0
</a><a href="#h145-0-40" id="h145-0-40" class="d">-
</a><a href="#h145-0-41" id="h145-0-41" class="d">-    fun init(context: Context) {
</a><a href="#h145-0-42" id="h145-0-42" class="d">-        this.context = context
</a><a href="#h145-0-43" id="h145-0-43" class="d">-        snapBuildNumber = getSnapchatVersionCode()
</a><a href="#h145-0-44" id="h145-0-44" class="d">-
</a><a href="#h145-0-45" id="h145-0-45" class="d">-        if (isFileExists()) {
</a><a href="#h145-0-46" id="h145-0-46" class="d">-            runCatching {
</a><a href="#h145-0-47" id="h145-0-47" class="d">-                loadCached()
</a><a href="#h145-0-48" id="h145-0-48" class="d">-            }.onFailure {
</a><a href="#h145-0-49" id="h145-0-49" class="d">-                delete()
</a><a href="#h145-0-50" id="h145-0-50" class="d">-            }
</a><a href="#h145-0-51" id="h145-0-51" class="d">-        }
</a><a href="#h145-0-52" id="h145-0-52" class="d">-    }
</a><a href="#h145-0-53" id="h145-0-53" class="d">-
</a><a href="#h145-0-54" id="h145-0-54" class="d">-    fun getSnapchatPackageInfo() = runCatching {
</a><a href="#h145-0-55" id="h145-0-55" class="d">-        context.packageManager.getPackageInfo(
</a><a href="#h145-0-56" id="h145-0-56" class="d">-            Constants.SNAPCHAT_PACKAGE_NAME,
</a><a href="#h145-0-57" id="h145-0-57" class="d">-            0
</a><a href="#h145-0-58" id="h145-0-58" class="d">-        )
</a><a href="#h145-0-59" id="h145-0-59" class="d">-    }.getOrNull()
</a><a href="#h145-0-60" id="h145-0-60" class="d">-
</a><a href="#h145-0-61" id="h145-0-61" class="d">-    fun getSnapchatVersionCode() = getSnapchatPackageInfo()?.longVersionCode ?: -1
</a><a href="#h145-0-62" id="h145-0-62" class="d">-    fun getApplicationSourceDir() = getSnapchatPackageInfo()?.applicationInfo?.sourceDir
</a><a href="#h145-0-63" id="h145-0-63" class="d">-    fun getGeneratedBuildNumber() = snapBuildNumber
</a><a href="#h145-0-64" id="h145-0-64" class="d">-
</a><a href="#h145-0-65" id="h145-0-65" class="d">-    fun isMappingsOutdated(): Boolean {
</a><a href="#h145-0-66" id="h145-0-66" class="d">-        return snapBuildNumber != getSnapchatVersionCode() || isMappingsLoaded().not()
</a><a href="#h145-0-67" id="h145-0-67" class="d">-    }
</a><a href="#h145-0-68" id="h145-0-68" class="d">-
</a><a href="#h145-0-69" id="h145-0-69" class="d">-    fun isMappingsLoaded(): Boolean {
</a><a href="#h145-0-70" id="h145-0-70" class="d">-        return mappings.isNotEmpty()
</a><a href="#h145-0-71" id="h145-0-71" class="d">-    }
</a><a href="#h145-0-72" id="h145-0-72" class="d">-
</a><a href="#h145-0-73" id="h145-0-73" class="d">-    private fun loadCached() {
</a><a href="#h145-0-74" id="h145-0-74" class="d">-        if (!isFileExists()) {
</a><a href="#h145-0-75" id="h145-0-75" class="d">-            throw Exception(&quot;Mappings file does not exist&quot;)
</a><a href="#h145-0-76" id="h145-0-76" class="d">-        }
</a><a href="#h145-0-77" id="h145-0-77" class="d">-        val mappingsObject = JsonParser.parseString(read().toString(Charsets.UTF_8)).asJsonObject.also {
</a><a href="#h145-0-78" id="h145-0-78" class="d">-            snapBuildNumber = it[&quot;snap_build_number&quot;].asLong
</a><a href="#h145-0-79" id="h145-0-79" class="d">-        }
</a><a href="#h145-0-80" id="h145-0-80" class="d">-
</a><a href="#h145-0-81" id="h145-0-81" class="d">-        mappingsObject.entrySet().forEach { (key, value): Map.Entry&lt;String, JsonElement&gt; -&gt;
</a><a href="#h145-0-82" id="h145-0-82" class="d">-            if (value.isJsonArray) {
</a><a href="#h145-0-83" id="h145-0-83" class="d">-                mappings[key] = gson.fromJson(value, ArrayList::class.java)
</a><a href="#h145-0-84" id="h145-0-84" class="d">-                return@forEach
</a><a href="#h145-0-85" id="h145-0-85" class="d">-            }
</a><a href="#h145-0-86" id="h145-0-86" class="d">-            if (value.isJsonObject) {
</a><a href="#h145-0-87" id="h145-0-87" class="d">-                mappings[key] = gson.fromJson(value, ConcurrentHashMap::class.java)
</a><a href="#h145-0-88" id="h145-0-88" class="d">-                return@forEach
</a><a href="#h145-0-89" id="h145-0-89" class="d">-            }
</a><a href="#h145-0-90" id="h145-0-90" class="d">-            mappings[key] = value.asString
</a><a href="#h145-0-91" id="h145-0-91" class="d">-        }
</a><a href="#h145-0-92" id="h145-0-92" class="d">-    }
</a><a href="#h145-0-93" id="h145-0-93" class="d">-
</a><a href="#h145-0-94" id="h145-0-94" class="d">-    fun refresh() {
</a><a href="#h145-0-95" id="h145-0-95" class="d">-        snapBuildNumber = getSnapchatVersionCode()
</a><a href="#h145-0-96" id="h145-0-96" class="d">-        val mapper = Mapper(*mappers)
</a><a href="#h145-0-97" id="h145-0-97" class="d">-
</a><a href="#h145-0-98" id="h145-0-98" class="d">-        runCatching {
</a><a href="#h145-0-99" id="h145-0-99" class="d">-            mapper.loadApk(getApplicationSourceDir() ?: throw Exception(&quot;Failed to get APK&quot;))
</a><a href="#h145-0-100" id="h145-0-100" class="d">-        }.onFailure {
</a><a href="#h145-0-101" id="h145-0-101" class="d">-            throw Exception(&quot;Failed to load APK&quot;, it)
</a><a href="#h145-0-102" id="h145-0-102" class="d">-        }
</a><a href="#h145-0-103" id="h145-0-103" class="d">-
</a><a href="#h145-0-104" id="h145-0-104" class="d">-        measureTimeMillis {
</a><a href="#h145-0-105" id="h145-0-105" class="d">-            val result = mapper.start().apply {
</a><a href="#h145-0-106" id="h145-0-106" class="d">-                addProperty(&quot;snap_build_number&quot;, snapBuildNumber)
</a><a href="#h145-0-107" id="h145-0-107" class="d">-            }
</a><a href="#h145-0-108" id="h145-0-108" class="d">-            write(result.toString().toByteArray())
</a><a href="#h145-0-109" id="h145-0-109" class="d">-        }.also {
</a><a href="#h145-0-110" id="h145-0-110" class="d">-            Logger.directDebug(&quot;Generated mappings in $it ms&quot;)
</a><a href="#h145-0-111" id="h145-0-111" class="d">-        }
</a><a href="#h145-0-112" id="h145-0-112" class="d">-    }
</a><a href="#h145-0-113" id="h145-0-113" class="d">-
</a><a href="#h145-0-114" id="h145-0-114" class="d">-    fun getMappedObject(key: String): Any {
</a><a href="#h145-0-115" id="h145-0-115" class="d">-        if (mappings.containsKey(key)) {
</a><a href="#h145-0-116" id="h145-0-116" class="d">-            return mappings[key]!!
</a><a href="#h145-0-117" id="h145-0-117" class="d">-        }
</a><a href="#h145-0-118" id="h145-0-118" class="d">-        throw Exception(&quot;No mapping found for $key&quot;)
</a><a href="#h145-0-119" id="h145-0-119" class="d">-    }
</a><a href="#h145-0-120" id="h145-0-120" class="d">-
</a><a href="#h145-0-121" id="h145-0-121" class="d">-    fun getMappedObjectNullable(key: String): Any? {
</a><a href="#h145-0-122" id="h145-0-122" class="d">-        return mappings[key]
</a><a href="#h145-0-123" id="h145-0-123" class="d">-    }
</a><a href="#h145-0-124" id="h145-0-124" class="d">-
</a><a href="#h145-0-125" id="h145-0-125" class="d">-    fun getMappedClass(className: String): Class&lt;*&gt; {
</a><a href="#h145-0-126" id="h145-0-126" class="d">-        return context.classLoader.loadClass(getMappedObject(className) as String)
</a><a href="#h145-0-127" id="h145-0-127" class="d">-    }
</a><a href="#h145-0-128" id="h145-0-128" class="d">-
</a><a href="#h145-0-129" id="h145-0-129" class="d">-    fun getMappedClass(key: String, subKey: String): Class&lt;*&gt; {
</a><a href="#h145-0-130" id="h145-0-130" class="d">-        return context.classLoader.loadClass(getMappedValue(key, subKey))
</a><a href="#h145-0-131" id="h145-0-131" class="d">-    }
</a><a href="#h145-0-132" id="h145-0-132" class="d">-
</a><a href="#h145-0-133" id="h145-0-133" class="d">-    fun getMappedValue(key: String): String {
</a><a href="#h145-0-134" id="h145-0-134" class="d">-        return getMappedObject(key) as String
</a><a href="#h145-0-135" id="h145-0-135" class="d">-    }
</a><a href="#h145-0-136" id="h145-0-136" class="d">-
</a><a href="#h145-0-137" id="h145-0-137" class="d">-    @Suppress(&quot;UNCHECKED_CAST&quot;)
</a><a href="#h145-0-138" id="h145-0-138" class="d">-    fun &lt;T : Any&gt; getMappedList(key: String): List&lt;T&gt; {
</a><a href="#h145-0-139" id="h145-0-139" class="d">-        return listOf(getMappedObject(key) as List&lt;T&gt;).flatten()
</a><a href="#h145-0-140" id="h145-0-140" class="d">-    }
</a><a href="#h145-0-141" id="h145-0-141" class="d">-
</a><a href="#h145-0-142" id="h145-0-142" class="d">-    fun getMappedValue(key: String, subKey: String): String {
</a><a href="#h145-0-143" id="h145-0-143" class="d">-        return getMappedMap(key)[subKey] as String
</a><a href="#h145-0-144" id="h145-0-144" class="d">-    }
</a><a href="#h145-0-145" id="h145-0-145" class="d">-
</a><a href="#h145-0-146" id="h145-0-146" class="d">-    @Suppress(&quot;UNCHECKED_CAST&quot;)
</a><a href="#h145-0-147" id="h145-0-147" class="d">-    fun getMappedMap(key: String): Map&lt;String, *&gt; {
</a><a href="#h145-0-148" id="h145-0-148" class="d">-        return getMappedObject(key) as Map&lt;String, *&gt;
</a><a href="#h145-0-149" id="h145-0-149" class="d">-    }
</a><a href="#h145-0-150" id="h145-0-150" class="d">-}</a><a href="#h145-0-151" id="h145-0-151" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h146" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/wrapper/MessageLoggerWrapper.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/wrapper/MessageLoggerWrapper.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/wrapper/MessageLoggerWrapper.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/wrapper/MessageLoggerWrapper.kt</a></b>
<a href="#h146-0" id="h146-0" class="h">@@ -1,79 +0,0 @@
</a><a href="#h146-0-0" id="h146-0-0" class="d">-package me.rhunk.snapenhance.core.bridge.wrapper
</a><a href="#h146-0-1" id="h146-0-1" class="d">-
</a><a href="#h146-0-2" id="h146-0-2" class="d">-import android.content.ContentValues
</a><a href="#h146-0-3" id="h146-0-3" class="d">-import android.database.sqlite.SQLiteDatabase
</a><a href="#h146-0-4" id="h146-0-4" class="d">-import me.rhunk.snapenhance.bridge.MessageLoggerInterface
</a><a href="#h146-0-5" id="h146-0-5" class="d">-import me.rhunk.snapenhance.core.util.SQLiteDatabaseHelper
</a><a href="#h146-0-6" id="h146-0-6" class="d">-import java.io.File
</a><a href="#h146-0-7" id="h146-0-7" class="d">-import java.util.UUID
</a><a href="#h146-0-8" id="h146-0-8" class="d">-
</a><a href="#h146-0-9" id="h146-0-9" class="d">-class MessageLoggerWrapper(
</a><a href="#h146-0-10" id="h146-0-10" class="d">-    private val databaseFile: File
</a><a href="#h146-0-11" id="h146-0-11" class="d">-): MessageLoggerInterface.Stub() {
</a><a href="#h146-0-12" id="h146-0-12" class="d">-    private lateinit var database: SQLiteDatabase
</a><a href="#h146-0-13" id="h146-0-13" class="d">-
</a><a href="#h146-0-14" id="h146-0-14" class="d">-    fun init() {
</a><a href="#h146-0-15" id="h146-0-15" class="d">-        database = SQLiteDatabase.openDatabase(databaseFile.absolutePath, null, SQLiteDatabase.CREATE_IF_NECESSARY or SQLiteDatabase.OPEN_READWRITE)
</a><a href="#h146-0-16" id="h146-0-16" class="d">-        SQLiteDatabaseHelper.createTablesFromSchema(database, mapOf(
</a><a href="#h146-0-17" id="h146-0-17" class="d">-            &quot;messages&quot; to listOf(
</a><a href="#h146-0-18" id="h146-0-18" class="d">-                &quot;id INTEGER PRIMARY KEY&quot;,
</a><a href="#h146-0-19" id="h146-0-19" class="d">-                &quot;conversation_id VARCHAR&quot;,
</a><a href="#h146-0-20" id="h146-0-20" class="d">-                &quot;message_id BIGINT&quot;,
</a><a href="#h146-0-21" id="h146-0-21" class="d">-                &quot;message_data BLOB&quot;
</a><a href="#h146-0-22" id="h146-0-22" class="d">-            )
</a><a href="#h146-0-23" id="h146-0-23" class="d">-        ))
</a><a href="#h146-0-24" id="h146-0-24" class="d">-    }
</a><a href="#h146-0-25" id="h146-0-25" class="d">-
</a><a href="#h146-0-26" id="h146-0-26" class="d">-    override fun getLoggedIds(conversationId: Array&lt;String&gt;, limit: Int): LongArray {
</a><a href="#h146-0-27" id="h146-0-27" class="d">-        if (conversationId.any {
</a><a href="#h146-0-28" id="h146-0-28" class="d">-            runCatching { UUID.fromString(it) }.isFailure
</a><a href="#h146-0-29" id="h146-0-29" class="d">-        }) return longArrayOf()
</a><a href="#h146-0-30" id="h146-0-30" class="d">-
</a><a href="#h146-0-31" id="h146-0-31" class="d">-        val cursor = database.rawQuery(&quot;SELECT message_id FROM messages WHERE conversation_id IN (${
</a><a href="#h146-0-32" id="h146-0-32" class="d">-            conversationId.joinToString(
</a><a href="#h146-0-33" id="h146-0-33" class="d">-                &quot;,&quot;
</a><a href="#h146-0-34" id="h146-0-34" class="d">-            ) { &quot;&#39;$it&#39;&quot; }
</a><a href="#h146-0-35" id="h146-0-35" class="d">-        }) ORDER BY message_id DESC LIMIT $limit&quot;, null)
</a><a href="#h146-0-36" id="h146-0-36" class="d">-
</a><a href="#h146-0-37" id="h146-0-37" class="d">-        val ids = mutableListOf&lt;Long&gt;()
</a><a href="#h146-0-38" id="h146-0-38" class="d">-        while (cursor.moveToNext()) {
</a><a href="#h146-0-39" id="h146-0-39" class="d">-            ids.add(cursor.getLong(0))
</a><a href="#h146-0-40" id="h146-0-40" class="d">-        }
</a><a href="#h146-0-41" id="h146-0-41" class="d">-        cursor.close()
</a><a href="#h146-0-42" id="h146-0-42" class="d">-        return ids.toLongArray()
</a><a href="#h146-0-43" id="h146-0-43" class="d">-    }
</a><a href="#h146-0-44" id="h146-0-44" class="d">-
</a><a href="#h146-0-45" id="h146-0-45" class="d">-    override fun getMessage(conversationId: String?, id: Long): ByteArray? {
</a><a href="#h146-0-46" id="h146-0-46" class="d">-        val cursor = database.rawQuery(&quot;SELECT message_data FROM messages WHERE conversation_id = ? AND message_id = ?&quot;, arrayOf(conversationId, id.toString()))
</a><a href="#h146-0-47" id="h146-0-47" class="d">-        val message: ByteArray? = if (cursor.moveToFirst()) {
</a><a href="#h146-0-48" id="h146-0-48" class="d">-            cursor.getBlob(0)
</a><a href="#h146-0-49" id="h146-0-49" class="d">-        } else {
</a><a href="#h146-0-50" id="h146-0-50" class="d">-            null
</a><a href="#h146-0-51" id="h146-0-51" class="d">-        }
</a><a href="#h146-0-52" id="h146-0-52" class="d">-        cursor.close()
</a><a href="#h146-0-53" id="h146-0-53" class="d">-        return message
</a><a href="#h146-0-54" id="h146-0-54" class="d">-    }
</a><a href="#h146-0-55" id="h146-0-55" class="d">-
</a><a href="#h146-0-56" id="h146-0-56" class="d">-    override fun addMessage(conversationId: String, messageId: Long, serializedMessage: ByteArray): Boolean {
</a><a href="#h146-0-57" id="h146-0-57" class="d">-        val cursor = database.rawQuery(&quot;SELECT message_id FROM messages WHERE conversation_id = ? AND message_id = ?&quot;, arrayOf(conversationId, messageId.toString()))
</a><a href="#h146-0-58" id="h146-0-58" class="d">-        val state = cursor.moveToFirst()
</a><a href="#h146-0-59" id="h146-0-59" class="d">-        cursor.close()
</a><a href="#h146-0-60" id="h146-0-60" class="d">-        if (state) {
</a><a href="#h146-0-61" id="h146-0-61" class="d">-            return false
</a><a href="#h146-0-62" id="h146-0-62" class="d">-        }
</a><a href="#h146-0-63" id="h146-0-63" class="d">-        database.insert(&quot;messages&quot;, null, ContentValues().apply {
</a><a href="#h146-0-64" id="h146-0-64" class="d">-            put(&quot;conversation_id&quot;, conversationId)
</a><a href="#h146-0-65" id="h146-0-65" class="d">-            put(&quot;message_id&quot;, messageId)
</a><a href="#h146-0-66" id="h146-0-66" class="d">-            put(&quot;message_data&quot;, serializedMessage)
</a><a href="#h146-0-67" id="h146-0-67" class="d">-        })
</a><a href="#h146-0-68" id="h146-0-68" class="d">-        return true
</a><a href="#h146-0-69" id="h146-0-69" class="d">-    }
</a><a href="#h146-0-70" id="h146-0-70" class="d">-
</a><a href="#h146-0-71" id="h146-0-71" class="d">-    fun clearMessages() {
</a><a href="#h146-0-72" id="h146-0-72" class="d">-        database.execSQL(&quot;DELETE FROM messages&quot;)
</a><a href="#h146-0-73" id="h146-0-73" class="d">-    }
</a><a href="#h146-0-74" id="h146-0-74" class="d">-
</a><a href="#h146-0-75" id="h146-0-75" class="d">-    override fun deleteMessage(conversationId: String, messageId: Long) {
</a><a href="#h146-0-76" id="h146-0-76" class="d">-        database.execSQL(&quot;DELETE FROM messages WHERE conversation_id = ? AND message_id = ?&quot;, arrayOf(conversationId, messageId.toString()))
</a><a href="#h146-0-77" id="h146-0-77" class="d">-    }
</a><a href="#h146-0-78" id="h146-0-78" class="d">-}</a><a href="#h146-0-79" id="h146-0-79" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h147" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/config/ConfigContainer.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/config/ConfigContainer.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/config/ConfigContainer.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/config/ConfigContainer.kt</a></b>
<a href="#h147-0" id="h147-0" class="h">@@ -1,82 +0,0 @@
</a><a href="#h147-0-0" id="h147-0-0" class="d">-package me.rhunk.snapenhance.core.config
</a><a href="#h147-0-1" id="h147-0-1" class="d">-
</a><a href="#h147-0-2" id="h147-0-2" class="d">-import com.google.gson.JsonObject
</a><a href="#h147-0-3" id="h147-0-3" class="d">-import kotlin.reflect.KProperty
</a><a href="#h147-0-4" id="h147-0-4" class="d">-
</a><a href="#h147-0-5" id="h147-0-5" class="d">-typealias ConfigParamsBuilder = ConfigParams.() -&gt; Unit
</a><a href="#h147-0-6" id="h147-0-6" class="d">-
</a><a href="#h147-0-7" id="h147-0-7" class="d">-open class ConfigContainer(
</a><a href="#h147-0-8" id="h147-0-8" class="d">-    val hasGlobalState: Boolean = false
</a><a href="#h147-0-9" id="h147-0-9" class="d">-) {
</a><a href="#h147-0-10" id="h147-0-10" class="d">-    var parentContainerKey: PropertyKey&lt;*&gt;? = null
</a><a href="#h147-0-11" id="h147-0-11" class="d">-    val properties = mutableMapOf&lt;PropertyKey&lt;*&gt;, PropertyValue&lt;*&gt;&gt;()
</a><a href="#h147-0-12" id="h147-0-12" class="d">-    var globalState: Boolean? = null
</a><a href="#h147-0-13" id="h147-0-13" class="d">-
</a><a href="#h147-0-14" id="h147-0-14" class="d">-    private inline fun &lt;T&gt; registerProperty(
</a><a href="#h147-0-15" id="h147-0-15" class="d">-        key: String,
</a><a href="#h147-0-16" id="h147-0-16" class="d">-        type: DataProcessors.PropertyDataProcessor&lt;*&gt;,
</a><a href="#h147-0-17" id="h147-0-17" class="d">-        defaultValue: PropertyValue&lt;T&gt;,
</a><a href="#h147-0-18" id="h147-0-18" class="d">-        params: ConfigParams.() -&gt; Unit = {},
</a><a href="#h147-0-19" id="h147-0-19" class="d">-        propertyKeyCallback: (PropertyKey&lt;*&gt;) -&gt; Unit = {}
</a><a href="#h147-0-20" id="h147-0-20" class="d">-    ): PropertyValue&lt;T&gt; {
</a><a href="#h147-0-21" id="h147-0-21" class="d">-        val propertyKey = PropertyKey({ parentContainerKey }, key, type, ConfigParams().also { it.params() })
</a><a href="#h147-0-22" id="h147-0-22" class="d">-        properties[propertyKey] = defaultValue
</a><a href="#h147-0-23" id="h147-0-23" class="d">-        propertyKeyCallback(propertyKey)
</a><a href="#h147-0-24" id="h147-0-24" class="d">-        return defaultValue
</a><a href="#h147-0-25" id="h147-0-25" class="d">-    }
</a><a href="#h147-0-26" id="h147-0-26" class="d">-
</a><a href="#h147-0-27" id="h147-0-27" class="d">-    protected fun boolean(key: String, defaultValue: Boolean = false, params: ConfigParamsBuilder = {}) =
</a><a href="#h147-0-28" id="h147-0-28" class="d">-        registerProperty(key, DataProcessors.BOOLEAN, PropertyValue(defaultValue), params)
</a><a href="#h147-0-29" id="h147-0-29" class="d">-
</a><a href="#h147-0-30" id="h147-0-30" class="d">-    protected fun integer(key: String, defaultValue: Int = 0, params: ConfigParamsBuilder = {}) =
</a><a href="#h147-0-31" id="h147-0-31" class="d">-        registerProperty(key, DataProcessors.INTEGER, PropertyValue(defaultValue), params)
</a><a href="#h147-0-32" id="h147-0-32" class="d">-
</a><a href="#h147-0-33" id="h147-0-33" class="d">-    protected fun float(key: String, defaultValue: Float = 0f, params: ConfigParamsBuilder = {}) =
</a><a href="#h147-0-34" id="h147-0-34" class="d">-        registerProperty(key, DataProcessors.FLOAT, PropertyValue(defaultValue), params)
</a><a href="#h147-0-35" id="h147-0-35" class="d">-
</a><a href="#h147-0-36" id="h147-0-36" class="d">-    protected fun string(key: String, defaultValue: String = &quot;&quot;, params: ConfigParamsBuilder = {}) =
</a><a href="#h147-0-37" id="h147-0-37" class="d">-        registerProperty(key, DataProcessors.STRING, PropertyValue(defaultValue), params)
</a><a href="#h147-0-38" id="h147-0-38" class="d">-
</a><a href="#h147-0-39" id="h147-0-39" class="d">-    protected fun multiple(
</a><a href="#h147-0-40" id="h147-0-40" class="d">-        key: String,
</a><a href="#h147-0-41" id="h147-0-41" class="d">-        vararg values: String = emptyArray(),
</a><a href="#h147-0-42" id="h147-0-42" class="d">-        params: ConfigParamsBuilder = {}
</a><a href="#h147-0-43" id="h147-0-43" class="d">-    ) = registerProperty(key,
</a><a href="#h147-0-44" id="h147-0-44" class="d">-        DataProcessors.STRING_MULTIPLE_SELECTION, PropertyValue(mutableListOf&lt;String&gt;(), defaultValues = values.toList()), params)
</a><a href="#h147-0-45" id="h147-0-45" class="d">-
</a><a href="#h147-0-46" id="h147-0-46" class="d">-    //null value is considered as Off/Disabled
</a><a href="#h147-0-47" id="h147-0-47" class="d">-    protected fun unique(
</a><a href="#h147-0-48" id="h147-0-48" class="d">-        key: String,
</a><a href="#h147-0-49" id="h147-0-49" class="d">-        vararg values: String = emptyArray(),
</a><a href="#h147-0-50" id="h147-0-50" class="d">-        params: ConfigParamsBuilder = {}
</a><a href="#h147-0-51" id="h147-0-51" class="d">-    ) = registerProperty(key,
</a><a href="#h147-0-52" id="h147-0-52" class="d">-        DataProcessors.STRING_UNIQUE_SELECTION, PropertyValue(&quot;null&quot;, defaultValues = values.toList()), params)
</a><a href="#h147-0-53" id="h147-0-53" class="d">-
</a><a href="#h147-0-54" id="h147-0-54" class="d">-    protected fun &lt;T : ConfigContainer&gt; container(
</a><a href="#h147-0-55" id="h147-0-55" class="d">-        key: String,
</a><a href="#h147-0-56" id="h147-0-56" class="d">-        container: T,
</a><a href="#h147-0-57" id="h147-0-57" class="d">-        params: ConfigParamsBuilder = {}
</a><a href="#h147-0-58" id="h147-0-58" class="d">-    ) = registerProperty(key, DataProcessors.container(container), PropertyValue(container), params) {
</a><a href="#h147-0-59" id="h147-0-59" class="d">-        container.parentContainerKey = it
</a><a href="#h147-0-60" id="h147-0-60" class="d">-    }.get()
</a><a href="#h147-0-61" id="h147-0-61" class="d">-
</a><a href="#h147-0-62" id="h147-0-62" class="d">-    fun toJson(): JsonObject {
</a><a href="#h147-0-63" id="h147-0-63" class="d">-        val json = JsonObject()
</a><a href="#h147-0-64" id="h147-0-64" class="d">-        properties.forEach { (propertyKey, propertyValue) -&gt;
</a><a href="#h147-0-65" id="h147-0-65" class="d">-            val serializedValue = propertyValue.getNullable()?.let { propertyKey.dataType.serializeAny(it) }
</a><a href="#h147-0-66" id="h147-0-66" class="d">-            json.add(propertyKey.name, serializedValue)
</a><a href="#h147-0-67" id="h147-0-67" class="d">-        }
</a><a href="#h147-0-68" id="h147-0-68" class="d">-        return json
</a><a href="#h147-0-69" id="h147-0-69" class="d">-    }
</a><a href="#h147-0-70" id="h147-0-70" class="d">-
</a><a href="#h147-0-71" id="h147-0-71" class="d">-    fun fromJson(json: JsonObject) {
</a><a href="#h147-0-72" id="h147-0-72" class="d">-        properties.forEach { (key, _) -&gt;
</a><a href="#h147-0-73" id="h147-0-73" class="d">-            val jsonElement = json.get(key.name) ?: return@forEach
</a><a href="#h147-0-74" id="h147-0-74" class="d">-            //TODO: check incoming values
</a><a href="#h147-0-75" id="h147-0-75" class="d">-            properties[key]?.setAny(key.dataType.deserializeAny(jsonElement))
</a><a href="#h147-0-76" id="h147-0-76" class="d">-        }
</a><a href="#h147-0-77" id="h147-0-77" class="d">-    }
</a><a href="#h147-0-78" id="h147-0-78" class="d">-
</a><a href="#h147-0-79" id="h147-0-79" class="d">-    operator fun getValue(t: Any?, property: KProperty&lt;*&gt;) = this.globalState
</a><a href="#h147-0-80" id="h147-0-80" class="d">-    operator fun setValue(t: Any?, property: KProperty&lt;*&gt;, t1: Boolean?) { this.globalState = t1 }
</a><a href="#h147-0-81" id="h147-0-81" class="d">-}</a><a href="#h147-0-82" id="h147-0-82" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h148" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/config/ConfigObjects.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/config/ConfigObjects.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/config/ConfigObjects.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/config/ConfigObjects.kt</a></b>
<a href="#h148-0" id="h148-0" class="h">@@ -1,117 +0,0 @@
</a><a href="#h148-0-0" id="h148-0-0" class="d">-package me.rhunk.snapenhance.core.config
</a><a href="#h148-0-1" id="h148-0-1" class="d">-
</a><a href="#h148-0-2" id="h148-0-2" class="d">-import me.rhunk.snapenhance.core.bridge.wrapper.LocaleWrapper
</a><a href="#h148-0-3" id="h148-0-3" class="d">-import kotlin.reflect.KProperty
</a><a href="#h148-0-4" id="h148-0-4" class="d">-
</a><a href="#h148-0-5" id="h148-0-5" class="d">-data class PropertyPair&lt;T&gt;(
</a><a href="#h148-0-6" id="h148-0-6" class="d">-    val key: PropertyKey&lt;T&gt;,
</a><a href="#h148-0-7" id="h148-0-7" class="d">-    val value: PropertyValue&lt;*&gt;
</a><a href="#h148-0-8" id="h148-0-8" class="d">-) {
</a><a href="#h148-0-9" id="h148-0-9" class="d">-    val name get() = key.name
</a><a href="#h148-0-10" id="h148-0-10" class="d">-}
</a><a href="#h148-0-11" id="h148-0-11" class="d">-
</a><a href="#h148-0-12" id="h148-0-12" class="d">-enum class FeatureNotice(
</a><a href="#h148-0-13" id="h148-0-13" class="d">-    val id: Int,
</a><a href="#h148-0-14" id="h148-0-14" class="d">-    val key: String
</a><a href="#h148-0-15" id="h148-0-15" class="d">-) {
</a><a href="#h148-0-16" id="h148-0-16" class="d">-    UNSTABLE(0b0001, &quot;unstable&quot;),
</a><a href="#h148-0-17" id="h148-0-17" class="d">-    BAN_RISK(0b0010, &quot;ban_risk&quot;),
</a><a href="#h148-0-18" id="h148-0-18" class="d">-    INTERNAL_BEHAVIOR(0b0100, &quot;internal_behavior&quot;)
</a><a href="#h148-0-19" id="h148-0-19" class="d">-}
</a><a href="#h148-0-20" id="h148-0-20" class="d">-
</a><a href="#h148-0-21" id="h148-0-21" class="d">-enum class ConfigFlag(
</a><a href="#h148-0-22" id="h148-0-22" class="d">-    val id: Int
</a><a href="#h148-0-23" id="h148-0-23" class="d">-) {
</a><a href="#h148-0-24" id="h148-0-24" class="d">-    NO_TRANSLATE(0b000001),
</a><a href="#h148-0-25" id="h148-0-25" class="d">-    HIDDEN(0b000010),
</a><a href="#h148-0-26" id="h148-0-26" class="d">-    FOLDER(0b000100),
</a><a href="#h148-0-27" id="h148-0-27" class="d">-    NO_DISABLE_KEY(0b001000),
</a><a href="#h148-0-28" id="h148-0-28" class="d">-    REQUIRE_RESTART(0b010000),
</a><a href="#h148-0-29" id="h148-0-29" class="d">-    REQUIRE_CLEAN_CACHE(0b100000)
</a><a href="#h148-0-30" id="h148-0-30" class="d">-}
</a><a href="#h148-0-31" id="h148-0-31" class="d">-
</a><a href="#h148-0-32" id="h148-0-32" class="d">-class ConfigParams(
</a><a href="#h148-0-33" id="h148-0-33" class="d">-    private var _flags: Int? = null,
</a><a href="#h148-0-34" id="h148-0-34" class="d">-    private var _notices: Int? = null,
</a><a href="#h148-0-35" id="h148-0-35" class="d">-
</a><a href="#h148-0-36" id="h148-0-36" class="d">-    var icon: String? = null,
</a><a href="#h148-0-37" id="h148-0-37" class="d">-    var disabledKey: String? = null,
</a><a href="#h148-0-38" id="h148-0-38" class="d">-    var customTranslationPath: String? = null,
</a><a href="#h148-0-39" id="h148-0-39" class="d">-    var customOptionTranslationPath: String? = null
</a><a href="#h148-0-40" id="h148-0-40" class="d">-) {
</a><a href="#h148-0-41" id="h148-0-41" class="d">-    val notices get() = _notices?.let { FeatureNotice.entries.filter { flag -&gt; it and flag.id != 0 } } ?: emptyList()
</a><a href="#h148-0-42" id="h148-0-42" class="d">-    val flags get() = _flags?.let { ConfigFlag.entries.filter { flag -&gt; it and flag.id != 0 } } ?: emptyList()
</a><a href="#h148-0-43" id="h148-0-43" class="d">-
</a><a href="#h148-0-44" id="h148-0-44" class="d">-    fun addNotices(vararg values: FeatureNotice) {
</a><a href="#h148-0-45" id="h148-0-45" class="d">-        this._notices = (this._notices ?: 0) or values.fold(0) { acc, featureNotice -&gt; acc or featureNotice.id }
</a><a href="#h148-0-46" id="h148-0-46" class="d">-    }
</a><a href="#h148-0-47" id="h148-0-47" class="d">-
</a><a href="#h148-0-48" id="h148-0-48" class="d">-    fun addFlags(vararg values: ConfigFlag) {
</a><a href="#h148-0-49" id="h148-0-49" class="d">-        this._flags = (this._flags ?: 0) or values.fold(0) { acc, flag -&gt; acc or flag.id }
</a><a href="#h148-0-50" id="h148-0-50" class="d">-    }
</a><a href="#h148-0-51" id="h148-0-51" class="d">-
</a><a href="#h148-0-52" id="h148-0-52" class="d">-    fun requireRestart() {
</a><a href="#h148-0-53" id="h148-0-53" class="d">-        addFlags(ConfigFlag.REQUIRE_RESTART)
</a><a href="#h148-0-54" id="h148-0-54" class="d">-    }
</a><a href="#h148-0-55" id="h148-0-55" class="d">-    fun requireCleanCache() {
</a><a href="#h148-0-56" id="h148-0-56" class="d">-        addFlags(ConfigFlag.REQUIRE_CLEAN_CACHE)
</a><a href="#h148-0-57" id="h148-0-57" class="d">-    }
</a><a href="#h148-0-58" id="h148-0-58" class="d">-}
</a><a href="#h148-0-59" id="h148-0-59" class="d">-
</a><a href="#h148-0-60" id="h148-0-60" class="d">-class PropertyValue&lt;T&gt;(
</a><a href="#h148-0-61" id="h148-0-61" class="d">-    private var value: T? = null,
</a><a href="#h148-0-62" id="h148-0-62" class="d">-    val defaultValues: List&lt;*&gt;? = null
</a><a href="#h148-0-63" id="h148-0-63" class="d">-) {
</a><a href="#h148-0-64" id="h148-0-64" class="d">-    inner class PropertyValueNullable {
</a><a href="#h148-0-65" id="h148-0-65" class="d">-        fun get() = value
</a><a href="#h148-0-66" id="h148-0-66" class="d">-        operator fun getValue(t: Any?, property: KProperty&lt;*&gt;): T? = getNullable()
</a><a href="#h148-0-67" id="h148-0-67" class="d">-        operator fun setValue(t: Any?, property: KProperty&lt;*&gt;, t1: T?) = set(t1)
</a><a href="#h148-0-68" id="h148-0-68" class="d">-    }
</a><a href="#h148-0-69" id="h148-0-69" class="d">-
</a><a href="#h148-0-70" id="h148-0-70" class="d">-    fun nullable() = PropertyValueNullable()
</a><a href="#h148-0-71" id="h148-0-71" class="d">-
</a><a href="#h148-0-72" id="h148-0-72" class="d">-    fun isSet() = value != null
</a><a href="#h148-0-73" id="h148-0-73" class="d">-    fun getNullable() = value?.takeIf { it != &quot;null&quot; }
</a><a href="#h148-0-74" id="h148-0-74" class="d">-    fun isEmpty() = value == null || value == &quot;null&quot; || value.toString().isEmpty()
</a><a href="#h148-0-75" id="h148-0-75" class="d">-    fun get() = getNullable() ?: throw IllegalStateException(&quot;Property is not set&quot;)
</a><a href="#h148-0-76" id="h148-0-76" class="d">-    fun set(value: T?) { setAny(value) }
</a><a href="#h148-0-77" id="h148-0-77" class="d">-    @Suppress(&quot;UNCHECKED_CAST&quot;)
</a><a href="#h148-0-78" id="h148-0-78" class="d">-    fun setAny(value: Any?) { this.value = value as T? }
</a><a href="#h148-0-79" id="h148-0-79" class="d">-
</a><a href="#h148-0-80" id="h148-0-80" class="d">-    operator fun getValue(t: Any?, property: KProperty&lt;*&gt;): T = get()
</a><a href="#h148-0-81" id="h148-0-81" class="d">-    operator fun setValue(t: Any?, property: KProperty&lt;*&gt;, t1: T?) = set(t1)
</a><a href="#h148-0-82" id="h148-0-82" class="d">-}
</a><a href="#h148-0-83" id="h148-0-83" class="d">-
</a><a href="#h148-0-84" id="h148-0-84" class="d">-data class PropertyKey&lt;T&gt;(
</a><a href="#h148-0-85" id="h148-0-85" class="d">-    private val _parent: () -&gt; PropertyKey&lt;*&gt;?,
</a><a href="#h148-0-86" id="h148-0-86" class="d">-    val name: String,
</a><a href="#h148-0-87" id="h148-0-87" class="d">-    val dataType: DataProcessors.PropertyDataProcessor&lt;T&gt;,
</a><a href="#h148-0-88" id="h148-0-88" class="d">-    val params: ConfigParams = ConfigParams(),
</a><a href="#h148-0-89" id="h148-0-89" class="d">-) {
</a><a href="#h148-0-90" id="h148-0-90" class="d">-    private val parentKey by lazy { _parent() }
</a><a href="#h148-0-91" id="h148-0-91" class="d">-
</a><a href="#h148-0-92" id="h148-0-92" class="d">-    fun propertyOption(translation: LocaleWrapper, key: String): String {
</a><a href="#h148-0-93" id="h148-0-93" class="d">-        if (key == &quot;null&quot;) {
</a><a href="#h148-0-94" id="h148-0-94" class="d">-            return translation[params.disabledKey ?: &quot;manager.sections.features.disabled&quot;]
</a><a href="#h148-0-95" id="h148-0-95" class="d">-        }
</a><a href="#h148-0-96" id="h148-0-96" class="d">-
</a><a href="#h148-0-97" id="h148-0-97" class="d">-        return if (!params.flags.contains(ConfigFlag.NO_TRANSLATE))
</a><a href="#h148-0-98" id="h148-0-98" class="d">-            translation[params.customOptionTranslationPath?.let {
</a><a href="#h148-0-99" id="h148-0-99" class="d">-                &quot;$it.$key&quot;
</a><a href="#h148-0-100" id="h148-0-100" class="d">-            } ?: &quot;features.options.${name}.$key&quot;]
</a><a href="#h148-0-101" id="h148-0-101" class="d">-        else key
</a><a href="#h148-0-102" id="h148-0-102" class="d">-    }
</a><a href="#h148-0-103" id="h148-0-103" class="d">-
</a><a href="#h148-0-104" id="h148-0-104" class="d">-    fun propertyName() = propertyTranslationPath() + &quot;.name&quot;
</a><a href="#h148-0-105" id="h148-0-105" class="d">-    fun propertyDescription() = propertyTranslationPath() + &quot;.description&quot;
</a><a href="#h148-0-106" id="h148-0-106" class="d">-
</a><a href="#h148-0-107" id="h148-0-107" class="d">-    fun propertyTranslationPath(): String {
</a><a href="#h148-0-108" id="h148-0-108" class="d">-        params.customTranslationPath?.let {
</a><a href="#h148-0-109" id="h148-0-109" class="d">-            return it
</a><a href="#h148-0-110" id="h148-0-110" class="d">-        }
</a><a href="#h148-0-111" id="h148-0-111" class="d">-        return parentKey?.let {
</a><a href="#h148-0-112" id="h148-0-112" class="d">-            &quot;${it.propertyTranslationPath()}.properties.$name&quot;
</a><a href="#h148-0-113" id="h148-0-113" class="d">-        } ?: &quot;features.properties.$name&quot;
</a><a href="#h148-0-114" id="h148-0-114" class="d">-    }
</a><a href="#h148-0-115" id="h148-0-115" class="d">-}
</a><a href="#h148-0-116" id="h148-0-116" class="d">-
</a><b>diff --git a/<a id="h149" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/config/DataProcessors.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/config/DataProcessors.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/config/DataProcessors.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/config/DataProcessors.kt</a></b>
<a href="#h149-0" id="h149-0" class="h">@@ -1,94 +0,0 @@
</a><a href="#h149-0-0" id="h149-0-0" class="d">-package me.rhunk.snapenhance.core.config
</a><a href="#h149-0-1" id="h149-0-1" class="d">-
</a><a href="#h149-0-2" id="h149-0-2" class="d">-import com.google.gson.JsonArray
</a><a href="#h149-0-3" id="h149-0-3" class="d">-import com.google.gson.JsonElement
</a><a href="#h149-0-4" id="h149-0-4" class="d">-import com.google.gson.JsonNull
</a><a href="#h149-0-5" id="h149-0-5" class="d">-import com.google.gson.JsonObject
</a><a href="#h149-0-6" id="h149-0-6" class="d">-import com.google.gson.JsonPrimitive
</a><a href="#h149-0-7" id="h149-0-7" class="d">-
</a><a href="#h149-0-8" id="h149-0-8" class="d">-object DataProcessors {
</a><a href="#h149-0-9" id="h149-0-9" class="d">-    enum class Type {
</a><a href="#h149-0-10" id="h149-0-10" class="d">-        STRING,
</a><a href="#h149-0-11" id="h149-0-11" class="d">-        BOOLEAN,
</a><a href="#h149-0-12" id="h149-0-12" class="d">-        INTEGER,
</a><a href="#h149-0-13" id="h149-0-13" class="d">-        FLOAT,
</a><a href="#h149-0-14" id="h149-0-14" class="d">-        STRING_MULTIPLE_SELECTION,
</a><a href="#h149-0-15" id="h149-0-15" class="d">-        STRING_UNIQUE_SELECTION,
</a><a href="#h149-0-16" id="h149-0-16" class="d">-        CONTAINER,
</a><a href="#h149-0-17" id="h149-0-17" class="d">-    }
</a><a href="#h149-0-18" id="h149-0-18" class="d">-
</a><a href="#h149-0-19" id="h149-0-19" class="d">-    data class PropertyDataProcessor&lt;T&gt;
</a><a href="#h149-0-20" id="h149-0-20" class="d">-    internal constructor(
</a><a href="#h149-0-21" id="h149-0-21" class="d">-        val type: Type,
</a><a href="#h149-0-22" id="h149-0-22" class="d">-        private val serialize: (T) -&gt; JsonElement,
</a><a href="#h149-0-23" id="h149-0-23" class="d">-        private val deserialize: (JsonElement) -&gt; T
</a><a href="#h149-0-24" id="h149-0-24" class="d">-    ) {
</a><a href="#h149-0-25" id="h149-0-25" class="d">-        @Suppress(&quot;UNCHECKED_CAST&quot;)
</a><a href="#h149-0-26" id="h149-0-26" class="d">-        fun serializeAny(value: Any) = serialize(value as T)
</a><a href="#h149-0-27" id="h149-0-27" class="d">-        fun deserializeAny(value: JsonElement) = deserialize(value)
</a><a href="#h149-0-28" id="h149-0-28" class="d">-    }
</a><a href="#h149-0-29" id="h149-0-29" class="d">-
</a><a href="#h149-0-30" id="h149-0-30" class="d">-    val STRING = PropertyDataProcessor(
</a><a href="#h149-0-31" id="h149-0-31" class="d">-        type = Type.STRING,
</a><a href="#h149-0-32" id="h149-0-32" class="d">-        serialize = {
</a><a href="#h149-0-33" id="h149-0-33" class="d">-            if (it != null) JsonPrimitive(it)
</a><a href="#h149-0-34" id="h149-0-34" class="d">-            else JsonNull.INSTANCE
</a><a href="#h149-0-35" id="h149-0-35" class="d">-        },
</a><a href="#h149-0-36" id="h149-0-36" class="d">-        deserialize = {
</a><a href="#h149-0-37" id="h149-0-37" class="d">-            if (it.isJsonNull) null
</a><a href="#h149-0-38" id="h149-0-38" class="d">-            else it.asString
</a><a href="#h149-0-39" id="h149-0-39" class="d">-        },
</a><a href="#h149-0-40" id="h149-0-40" class="d">-    )
</a><a href="#h149-0-41" id="h149-0-41" class="d">-
</a><a href="#h149-0-42" id="h149-0-42" class="d">-    val BOOLEAN = PropertyDataProcessor(
</a><a href="#h149-0-43" id="h149-0-43" class="d">-        type = Type.BOOLEAN,
</a><a href="#h149-0-44" id="h149-0-44" class="d">-        serialize = {
</a><a href="#h149-0-45" id="h149-0-45" class="d">-            if (it) JsonPrimitive(true)
</a><a href="#h149-0-46" id="h149-0-46" class="d">-            else JsonPrimitive(false)
</a><a href="#h149-0-47" id="h149-0-47" class="d">-        },
</a><a href="#h149-0-48" id="h149-0-48" class="d">-        deserialize = { it.asBoolean },
</a><a href="#h149-0-49" id="h149-0-49" class="d">-    )
</a><a href="#h149-0-50" id="h149-0-50" class="d">-
</a><a href="#h149-0-51" id="h149-0-51" class="d">-    val INTEGER = PropertyDataProcessor(
</a><a href="#h149-0-52" id="h149-0-52" class="d">-        type = Type.INTEGER,
</a><a href="#h149-0-53" id="h149-0-53" class="d">-        serialize = { JsonPrimitive(it) },
</a><a href="#h149-0-54" id="h149-0-54" class="d">-        deserialize = { it.asInt },
</a><a href="#h149-0-55" id="h149-0-55" class="d">-    )
</a><a href="#h149-0-56" id="h149-0-56" class="d">-
</a><a href="#h149-0-57" id="h149-0-57" class="d">-    val FLOAT = PropertyDataProcessor(
</a><a href="#h149-0-58" id="h149-0-58" class="d">-        type = Type.FLOAT,
</a><a href="#h149-0-59" id="h149-0-59" class="d">-        serialize = { JsonPrimitive(it) },
</a><a href="#h149-0-60" id="h149-0-60" class="d">-        deserialize = { it.asFloat },
</a><a href="#h149-0-61" id="h149-0-61" class="d">-    )
</a><a href="#h149-0-62" id="h149-0-62" class="d">-
</a><a href="#h149-0-63" id="h149-0-63" class="d">-    val STRING_MULTIPLE_SELECTION = PropertyDataProcessor(
</a><a href="#h149-0-64" id="h149-0-64" class="d">-        type = Type.STRING_MULTIPLE_SELECTION,
</a><a href="#h149-0-65" id="h149-0-65" class="d">-        serialize = { JsonArray().apply { it.forEach { add(it) } } },
</a><a href="#h149-0-66" id="h149-0-66" class="d">-        deserialize = { obj -&gt;
</a><a href="#h149-0-67" id="h149-0-67" class="d">-            obj.asJsonArray.map { it.asString }.toMutableList()
</a><a href="#h149-0-68" id="h149-0-68" class="d">-        },
</a><a href="#h149-0-69" id="h149-0-69" class="d">-    )
</a><a href="#h149-0-70" id="h149-0-70" class="d">-
</a><a href="#h149-0-71" id="h149-0-71" class="d">-    val STRING_UNIQUE_SELECTION = PropertyDataProcessor(
</a><a href="#h149-0-72" id="h149-0-72" class="d">-        type = Type.STRING_UNIQUE_SELECTION,
</a><a href="#h149-0-73" id="h149-0-73" class="d">-        serialize = { JsonPrimitive(it) },
</a><a href="#h149-0-74" id="h149-0-74" class="d">-        deserialize = { obj -&gt; obj.takeIf { !it.isJsonNull }?.asString }
</a><a href="#h149-0-75" id="h149-0-75" class="d">-    )
</a><a href="#h149-0-76" id="h149-0-76" class="d">-
</a><a href="#h149-0-77" id="h149-0-77" class="d">-    fun &lt;T : ConfigContainer&gt; container(container: T) = PropertyDataProcessor(
</a><a href="#h149-0-78" id="h149-0-78" class="d">-        type = Type.CONTAINER,
</a><a href="#h149-0-79" id="h149-0-79" class="d">-        serialize = {
</a><a href="#h149-0-80" id="h149-0-80" class="d">-            JsonObject().apply {
</a><a href="#h149-0-81" id="h149-0-81" class="d">-                addProperty(&quot;state&quot;, it.globalState)
</a><a href="#h149-0-82" id="h149-0-82" class="d">-                add(&quot;properties&quot;, it.toJson())
</a><a href="#h149-0-83" id="h149-0-83" class="d">-            }
</a><a href="#h149-0-84" id="h149-0-84" class="d">-        },
</a><a href="#h149-0-85" id="h149-0-85" class="d">-        deserialize = { obj -&gt;
</a><a href="#h149-0-86" id="h149-0-86" class="d">-            val jsonObject = obj.asJsonObject
</a><a href="#h149-0-87" id="h149-0-87" class="d">-            container.apply {
</a><a href="#h149-0-88" id="h149-0-88" class="d">-                globalState = jsonObject[&quot;state&quot;].takeIf { !it.isJsonNull }?.asBoolean
</a><a href="#h149-0-89" id="h149-0-89" class="d">-                fromJson(jsonObject[&quot;properties&quot;].asJsonObject)
</a><a href="#h149-0-90" id="h149-0-90" class="d">-            }
</a><a href="#h149-0-91" id="h149-0-91" class="d">-        },
</a><a href="#h149-0-92" id="h149-0-92" class="d">-    )
</a><a href="#h149-0-93" id="h149-0-93" class="d">-}</a><a href="#h149-0-94" id="h149-0-94" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h150" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/config/ModConfig.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/config/ModConfig.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/config/ModConfig.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/config/ModConfig.kt</a></b>
<a href="#h150-0" id="h150-0" class="h">@@ -1,132 +0,0 @@
</a><a href="#h150-0-0" id="h150-0-0" class="d">-package me.rhunk.snapenhance.core.config
</a><a href="#h150-0-1" id="h150-0-1" class="d">-
</a><a href="#h150-0-2" id="h150-0-2" class="d">-import android.content.Context
</a><a href="#h150-0-3" id="h150-0-3" class="d">-import com.google.gson.Gson
</a><a href="#h150-0-4" id="h150-0-4" class="d">-import com.google.gson.GsonBuilder
</a><a href="#h150-0-5" id="h150-0-5" class="d">-import com.google.gson.JsonObject
</a><a href="#h150-0-6" id="h150-0-6" class="d">-import me.rhunk.snapenhance.bridge.ConfigStateListener
</a><a href="#h150-0-7" id="h150-0-7" class="d">-import me.rhunk.snapenhance.core.Logger
</a><a href="#h150-0-8" id="h150-0-8" class="d">-import me.rhunk.snapenhance.core.bridge.BridgeClient
</a><a href="#h150-0-9" id="h150-0-9" class="d">-import me.rhunk.snapenhance.core.bridge.FileLoaderWrapper
</a><a href="#h150-0-10" id="h150-0-10" class="d">-import me.rhunk.snapenhance.core.bridge.types.BridgeFileType
</a><a href="#h150-0-11" id="h150-0-11" class="d">-import me.rhunk.snapenhance.core.bridge.wrapper.LocaleWrapper
</a><a href="#h150-0-12" id="h150-0-12" class="d">-import me.rhunk.snapenhance.core.config.impl.RootConfig
</a><a href="#h150-0-13" id="h150-0-13" class="d">-import kotlin.properties.Delegates
</a><a href="#h150-0-14" id="h150-0-14" class="d">-
</a><a href="#h150-0-15" id="h150-0-15" class="d">-class ModConfig {
</a><a href="#h150-0-16" id="h150-0-16" class="d">-    var locale: String = LocaleWrapper.DEFAULT_LOCALE
</a><a href="#h150-0-17" id="h150-0-17" class="d">-
</a><a href="#h150-0-18" id="h150-0-18" class="d">-    private val gson: Gson = GsonBuilder().setPrettyPrinting().create()
</a><a href="#h150-0-19" id="h150-0-19" class="d">-    private val file = FileLoaderWrapper(BridgeFileType.CONFIG, &quot;{}&quot;.toByteArray(Charsets.UTF_8))
</a><a href="#h150-0-20" id="h150-0-20" class="d">-    var wasPresent by Delegates.notNull&lt;Boolean&gt;()
</a><a href="#h150-0-21" id="h150-0-21" class="d">-
</a><a href="#h150-0-22" id="h150-0-22" class="d">-    /* Used to notify the bridge client about config changes */
</a><a href="#h150-0-23" id="h150-0-23" class="d">-    var configStateListener: ConfigStateListener? = null
</a><a href="#h150-0-24" id="h150-0-24" class="d">-    lateinit var root: RootConfig
</a><a href="#h150-0-25" id="h150-0-25" class="d">-        private set
</a><a href="#h150-0-26" id="h150-0-26" class="d">-
</a><a href="#h150-0-27" id="h150-0-27" class="d">-    private fun load() {
</a><a href="#h150-0-28" id="h150-0-28" class="d">-        root = RootConfig()
</a><a href="#h150-0-29" id="h150-0-29" class="d">-        wasPresent = file.isFileExists()
</a><a href="#h150-0-30" id="h150-0-30" class="d">-        if (!file.isFileExists()) {
</a><a href="#h150-0-31" id="h150-0-31" class="d">-            writeConfig()
</a><a href="#h150-0-32" id="h150-0-32" class="d">-            return
</a><a href="#h150-0-33" id="h150-0-33" class="d">-        }
</a><a href="#h150-0-34" id="h150-0-34" class="d">-
</a><a href="#h150-0-35" id="h150-0-35" class="d">-        runCatching {
</a><a href="#h150-0-36" id="h150-0-36" class="d">-            loadConfig()
</a><a href="#h150-0-37" id="h150-0-37" class="d">-        }.onFailure {
</a><a href="#h150-0-38" id="h150-0-38" class="d">-            writeConfig()
</a><a href="#h150-0-39" id="h150-0-39" class="d">-        }
</a><a href="#h150-0-40" id="h150-0-40" class="d">-    }
</a><a href="#h150-0-41" id="h150-0-41" class="d">-
</a><a href="#h150-0-42" id="h150-0-42" class="d">-    private fun loadConfig() {
</a><a href="#h150-0-43" id="h150-0-43" class="d">-        val configFileContent = file.read()
</a><a href="#h150-0-44" id="h150-0-44" class="d">-        val configObject = gson.fromJson(configFileContent.toString(Charsets.UTF_8), JsonObject::class.java)
</a><a href="#h150-0-45" id="h150-0-45" class="d">-        locale = configObject.get(&quot;_locale&quot;)?.asString ?: LocaleWrapper.DEFAULT_LOCALE
</a><a href="#h150-0-46" id="h150-0-46" class="d">-        root.fromJson(configObject)
</a><a href="#h150-0-47" id="h150-0-47" class="d">-    }
</a><a href="#h150-0-48" id="h150-0-48" class="d">-
</a><a href="#h150-0-49" id="h150-0-49" class="d">-    fun exportToString(): String {
</a><a href="#h150-0-50" id="h150-0-50" class="d">-        val configObject = root.toJson()
</a><a href="#h150-0-51" id="h150-0-51" class="d">-        configObject.addProperty(&quot;_locale&quot;, locale)
</a><a href="#h150-0-52" id="h150-0-52" class="d">-        return configObject.toString()
</a><a href="#h150-0-53" id="h150-0-53" class="d">-    }
</a><a href="#h150-0-54" id="h150-0-54" class="d">-
</a><a href="#h150-0-55" id="h150-0-55" class="d">-    fun reset() {
</a><a href="#h150-0-56" id="h150-0-56" class="d">-        root = RootConfig()
</a><a href="#h150-0-57" id="h150-0-57" class="d">-        writeConfig()
</a><a href="#h150-0-58" id="h150-0-58" class="d">-    }
</a><a href="#h150-0-59" id="h150-0-59" class="d">-
</a><a href="#h150-0-60" id="h150-0-60" class="d">-    fun writeConfig() {
</a><a href="#h150-0-61" id="h150-0-61" class="d">-        var shouldRestart = false
</a><a href="#h150-0-62" id="h150-0-62" class="d">-        var shouldCleanCache = false
</a><a href="#h150-0-63" id="h150-0-63" class="d">-        var configChanged = false
</a><a href="#h150-0-64" id="h150-0-64" class="d">-
</a><a href="#h150-0-65" id="h150-0-65" class="d">-        fun compareDiff(originalContainer: ConfigContainer, modifiedContainer: ConfigContainer) {
</a><a href="#h150-0-66" id="h150-0-66" class="d">-            val parentContainerFlags = modifiedContainer.parentContainerKey?.params?.flags ?: emptySet()
</a><a href="#h150-0-67" id="h150-0-67" class="d">-
</a><a href="#h150-0-68" id="h150-0-68" class="d">-            parentContainerFlags.takeIf { originalContainer.hasGlobalState }?.apply {
</a><a href="#h150-0-69" id="h150-0-69" class="d">-                if (modifiedContainer.globalState != originalContainer.globalState) {
</a><a href="#h150-0-70" id="h150-0-70" class="d">-                    configChanged = true
</a><a href="#h150-0-71" id="h150-0-71" class="d">-                    if (contains(ConfigFlag.REQUIRE_RESTART)) shouldRestart = true
</a><a href="#h150-0-72" id="h150-0-72" class="d">-                    if (contains(ConfigFlag.REQUIRE_CLEAN_CACHE)) shouldCleanCache = true
</a><a href="#h150-0-73" id="h150-0-73" class="d">-                }
</a><a href="#h150-0-74" id="h150-0-74" class="d">-            }
</a><a href="#h150-0-75" id="h150-0-75" class="d">-
</a><a href="#h150-0-76" id="h150-0-76" class="d">-            for (property in modifiedContainer.properties) {
</a><a href="#h150-0-77" id="h150-0-77" class="d">-                val modifiedValue = property.value.getNullable()
</a><a href="#h150-0-78" id="h150-0-78" class="d">-                val originalValue = originalContainer.properties.entries.firstOrNull {
</a><a href="#h150-0-79" id="h150-0-79" class="d">-                    it.key.name == property.key.name
</a><a href="#h150-0-80" id="h150-0-80" class="d">-                }?.value?.getNullable()
</a><a href="#h150-0-81" id="h150-0-81" class="d">-
</a><a href="#h150-0-82" id="h150-0-82" class="d">-                if (originalValue is ConfigContainer &amp;&amp; modifiedValue is ConfigContainer) {
</a><a href="#h150-0-83" id="h150-0-83" class="d">-                    compareDiff(originalValue, modifiedValue)
</a><a href="#h150-0-84" id="h150-0-84" class="d">-                    continue
</a><a href="#h150-0-85" id="h150-0-85" class="d">-                }
</a><a href="#h150-0-86" id="h150-0-86" class="d">-
</a><a href="#h150-0-87" id="h150-0-87" class="d">-                if (modifiedValue != originalValue) {
</a><a href="#h150-0-88" id="h150-0-88" class="d">-                    val flags = property.key.params.flags + parentContainerFlags
</a><a href="#h150-0-89" id="h150-0-89" class="d">-                    configChanged = true
</a><a href="#h150-0-90" id="h150-0-90" class="d">-                    if (flags.contains(ConfigFlag.REQUIRE_RESTART)) shouldRestart = true
</a><a href="#h150-0-91" id="h150-0-91" class="d">-                    if (flags.contains(ConfigFlag.REQUIRE_CLEAN_CACHE)) shouldCleanCache = true
</a><a href="#h150-0-92" id="h150-0-92" class="d">-                }
</a><a href="#h150-0-93" id="h150-0-93" class="d">-            }
</a><a href="#h150-0-94" id="h150-0-94" class="d">-        }
</a><a href="#h150-0-95" id="h150-0-95" class="d">-
</a><a href="#h150-0-96" id="h150-0-96" class="d">-        configStateListener?.also {
</a><a href="#h150-0-97" id="h150-0-97" class="d">-            runCatching {
</a><a href="#h150-0-98" id="h150-0-98" class="d">-                compareDiff(RootConfig().apply {
</a><a href="#h150-0-99" id="h150-0-99" class="d">-                    fromJson(gson.fromJson(file.read().toString(Charsets.UTF_8), JsonObject::class.java))
</a><a href="#h150-0-100" id="h150-0-100" class="d">-                }, root)
</a><a href="#h150-0-101" id="h150-0-101" class="d">-
</a><a href="#h150-0-102" id="h150-0-102" class="d">-                if (configChanged) {
</a><a href="#h150-0-103" id="h150-0-103" class="d">-                    it.onConfigChanged()
</a><a href="#h150-0-104" id="h150-0-104" class="d">-                    if (shouldCleanCache) it.onCleanCacheRequired()
</a><a href="#h150-0-105" id="h150-0-105" class="d">-                    else if (shouldRestart) it.onRestartRequired()
</a><a href="#h150-0-106" id="h150-0-106" class="d">-                }
</a><a href="#h150-0-107" id="h150-0-107" class="d">-            }.onFailure {
</a><a href="#h150-0-108" id="h150-0-108" class="d">-                Logger.directError(&quot;Error while calling config state listener&quot;, it, &quot;ConfigStateListener&quot;)
</a><a href="#h150-0-109" id="h150-0-109" class="d">-            }
</a><a href="#h150-0-110" id="h150-0-110" class="d">-        }
</a><a href="#h150-0-111" id="h150-0-111" class="d">-
</a><a href="#h150-0-112" id="h150-0-112" class="d">-        file.write(exportToString().toByteArray(Charsets.UTF_8))
</a><a href="#h150-0-113" id="h150-0-113" class="d">-    }
</a><a href="#h150-0-114" id="h150-0-114" class="d">-
</a><a href="#h150-0-115" id="h150-0-115" class="d">-    fun loadFromString(string: String) {
</a><a href="#h150-0-116" id="h150-0-116" class="d">-        val configObject = gson.fromJson(string, JsonObject::class.java)
</a><a href="#h150-0-117" id="h150-0-117" class="d">-        locale = configObject.get(&quot;_locale&quot;)?.asString ?: LocaleWrapper.DEFAULT_LOCALE
</a><a href="#h150-0-118" id="h150-0-118" class="d">-        root.fromJson(configObject)
</a><a href="#h150-0-119" id="h150-0-119" class="d">-        writeConfig()
</a><a href="#h150-0-120" id="h150-0-120" class="d">-    }
</a><a href="#h150-0-121" id="h150-0-121" class="d">-
</a><a href="#h150-0-122" id="h150-0-122" class="d">-    fun loadFromContext(context: Context) {
</a><a href="#h150-0-123" id="h150-0-123" class="d">-        file.loadFromContext(context)
</a><a href="#h150-0-124" id="h150-0-124" class="d">-        load()
</a><a href="#h150-0-125" id="h150-0-125" class="d">-    }
</a><a href="#h150-0-126" id="h150-0-126" class="d">-
</a><a href="#h150-0-127" id="h150-0-127" class="d">-    fun loadFromBridge(bridgeClient: BridgeClient) {
</a><a href="#h150-0-128" id="h150-0-128" class="d">-        file.loadFromBridge(bridgeClient)
</a><a href="#h150-0-129" id="h150-0-129" class="d">-        load()
</a><a href="#h150-0-130" id="h150-0-130" class="d">-    }
</a><a href="#h150-0-131" id="h150-0-131" class="d">-}</a><a href="#h150-0-132" id="h150-0-132" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h151" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/Camera.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/Camera.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/Camera.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/Camera.kt</a></b>
<a href="#h151-0" id="h151-0" class="h">@@ -1,19 +0,0 @@
</a><a href="#h151-0-0" id="h151-0-0" class="d">-package me.rhunk.snapenhance.core.config.impl
</a><a href="#h151-0-1" id="h151-0-1" class="d">-
</a><a href="#h151-0-2" id="h151-0-2" class="d">-import me.rhunk.snapenhance.core.config.ConfigContainer
</a><a href="#h151-0-3" id="h151-0-3" class="d">-import me.rhunk.snapenhance.core.config.ConfigFlag
</a><a href="#h151-0-4" id="h151-0-4" class="d">-import me.rhunk.snapenhance.core.config.FeatureNotice
</a><a href="#h151-0-5" id="h151-0-5" class="d">-import me.rhunk.snapenhance.features.impl.tweaks.CameraTweaks
</a><a href="#h151-0-6" id="h151-0-6" class="d">-
</a><a href="#h151-0-7" id="h151-0-7" class="d">-class Camera : ConfigContainer() {
</a><a href="#h151-0-8" id="h151-0-8" class="d">-    val disable = boolean(&quot;disable_camera&quot;)
</a><a href="#h151-0-9" id="h151-0-9" class="d">-    val immersiveCameraPreview = boolean(&quot;immersive_camera_preview&quot;) { addNotices(FeatureNotice.UNSTABLE) }
</a><a href="#h151-0-10" id="h151-0-10" class="d">-    val overridePreviewResolution = unique(&quot;override_preview_resolution&quot;, *CameraTweaks.resolutions.toTypedArray())
</a><a href="#h151-0-11" id="h151-0-11" class="d">-        { addFlags(ConfigFlag.NO_TRANSLATE) }
</a><a href="#h151-0-12" id="h151-0-12" class="d">-    val overridePictureResolution = unique(&quot;override_picture_resolution&quot;, *CameraTweaks.resolutions.toTypedArray())
</a><a href="#h151-0-13" id="h151-0-13" class="d">-        { addFlags(ConfigFlag.NO_TRANSLATE) }
</a><a href="#h151-0-14" id="h151-0-14" class="d">-    val customFrameRate = unique(&quot;custom_frame_rate&quot;,
</a><a href="#h151-0-15" id="h151-0-15" class="d">-        &quot;5&quot;, &quot;10&quot;, &quot;20&quot;, &quot;25&quot;, &quot;30&quot;, &quot;48&quot;, &quot;60&quot;, &quot;90&quot;, &quot;120&quot;
</a><a href="#h151-0-16" id="h151-0-16" class="d">-    ) { addNotices(FeatureNotice.UNSTABLE); addFlags(ConfigFlag.NO_TRANSLATE) }
</a><a href="#h151-0-17" id="h151-0-17" class="d">-    val forceCameraSourceEncoding = boolean(&quot;force_camera_source_encoding&quot;)
</a><a href="#h151-0-18" id="h151-0-18" class="d">-}
</a><b>diff --git a/<a id="h152" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/DownloaderConfig.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/DownloaderConfig.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/DownloaderConfig.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/DownloaderConfig.kt</a></b>
<a href="#h152-0" id="h152-0" class="h">@@ -1,50 +0,0 @@
</a><a href="#h152-0-0" id="h152-0-0" class="d">-package me.rhunk.snapenhance.core.config.impl
</a><a href="#h152-0-1" id="h152-0-1" class="d">-
</a><a href="#h152-0-2" id="h152-0-2" class="d">-import me.rhunk.snapenhance.core.config.ConfigContainer
</a><a href="#h152-0-3" id="h152-0-3" class="d">-import me.rhunk.snapenhance.core.config.ConfigFlag
</a><a href="#h152-0-4" id="h152-0-4" class="d">-import me.rhunk.snapenhance.core.config.FeatureNotice
</a><a href="#h152-0-5" id="h152-0-5" class="d">-
</a><a href="#h152-0-6" id="h152-0-6" class="d">-class DownloaderConfig : ConfigContainer() {
</a><a href="#h152-0-7" id="h152-0-7" class="d">-    inner class FFMpegOptions : ConfigContainer() {
</a><a href="#h152-0-8" id="h152-0-8" class="d">-        val threads = integer(&quot;threads&quot;, 1)
</a><a href="#h152-0-9" id="h152-0-9" class="d">-        val preset = unique(&quot;preset&quot;, &quot;ultrafast&quot;, &quot;superfast&quot;, &quot;veryfast&quot;, &quot;faster&quot;, &quot;fast&quot;, &quot;medium&quot;, &quot;slow&quot;, &quot;slower&quot;, &quot;veryslow&quot;) {
</a><a href="#h152-0-10" id="h152-0-10" class="d">-            addFlags(ConfigFlag.NO_TRANSLATE)
</a><a href="#h152-0-11" id="h152-0-11" class="d">-        }
</a><a href="#h152-0-12" id="h152-0-12" class="d">-        val constantRateFactor = integer(&quot;constant_rate_factor&quot;, 30)
</a><a href="#h152-0-13" id="h152-0-13" class="d">-        val videoBitrate = integer(&quot;video_bitrate&quot;, 5000)
</a><a href="#h152-0-14" id="h152-0-14" class="d">-        val audioBitrate = integer(&quot;audio_bitrate&quot;, 128)
</a><a href="#h152-0-15" id="h152-0-15" class="d">-        val customVideoCodec = string(&quot;custom_video_codec&quot;) { addFlags(ConfigFlag.NO_TRANSLATE) }
</a><a href="#h152-0-16" id="h152-0-16" class="d">-        val customAudioCodec = string(&quot;custom_audio_codec&quot;) { addFlags(ConfigFlag.NO_TRANSLATE) }
</a><a href="#h152-0-17" id="h152-0-17" class="d">-    }
</a><a href="#h152-0-18" id="h152-0-18" class="d">-
</a><a href="#h152-0-19" id="h152-0-19" class="d">-    val saveFolder = string(&quot;save_folder&quot;) { addFlags(ConfigFlag.FOLDER); requireRestart() }
</a><a href="#h152-0-20" id="h152-0-20" class="d">-    val autoDownloadSources = multiple(&quot;auto_download_sources&quot;,
</a><a href="#h152-0-21" id="h152-0-21" class="d">-        &quot;friend_snaps&quot;,
</a><a href="#h152-0-22" id="h152-0-22" class="d">-        &quot;friend_stories&quot;,
</a><a href="#h152-0-23" id="h152-0-23" class="d">-        &quot;public_stories&quot;,
</a><a href="#h152-0-24" id="h152-0-24" class="d">-        &quot;spotlight&quot;
</a><a href="#h152-0-25" id="h152-0-25" class="d">-    )
</a><a href="#h152-0-26" id="h152-0-26" class="d">-    val preventSelfAutoDownload = boolean(&quot;prevent_self_auto_download&quot;)
</a><a href="#h152-0-27" id="h152-0-27" class="d">-    val pathFormat = multiple(&quot;path_format&quot;,
</a><a href="#h152-0-28" id="h152-0-28" class="d">-        &quot;create_author_folder&quot;,
</a><a href="#h152-0-29" id="h152-0-29" class="d">-        &quot;create_source_folder&quot;,
</a><a href="#h152-0-30" id="h152-0-30" class="d">-        &quot;append_hash&quot;,
</a><a href="#h152-0-31" id="h152-0-31" class="d">-        &quot;append_source&quot;,
</a><a href="#h152-0-32" id="h152-0-32" class="d">-        &quot;append_username&quot;,
</a><a href="#h152-0-33" id="h152-0-33" class="d">-        &quot;append_date_time&quot;,
</a><a href="#h152-0-34" id="h152-0-34" class="d">-    ).apply { set(mutableListOf(&quot;append_hash&quot;, &quot;append_date_time&quot;, &quot;append_type&quot;, &quot;append_username&quot;)) }
</a><a href="#h152-0-35" id="h152-0-35" class="d">-    val allowDuplicate = boolean(&quot;allow_duplicate&quot;)
</a><a href="#h152-0-36" id="h152-0-36" class="d">-    val mergeOverlays = boolean(&quot;merge_overlays&quot;) { addNotices(FeatureNotice.UNSTABLE) }
</a><a href="#h152-0-37" id="h152-0-37" class="d">-    val forceImageFormat = unique(&quot;force_image_format&quot;, &quot;jpg&quot;, &quot;png&quot;, &quot;webp&quot;) {
</a><a href="#h152-0-38" id="h152-0-38" class="d">-        addFlags(ConfigFlag.NO_TRANSLATE)
</a><a href="#h152-0-39" id="h152-0-39" class="d">-    }
</a><a href="#h152-0-40" id="h152-0-40" class="d">-    val forceVoiceNoteFormat = unique(&quot;force_voice_note_format&quot;, &quot;aac&quot;, &quot;mp3&quot;, &quot;opus&quot;) {
</a><a href="#h152-0-41" id="h152-0-41" class="d">-        addFlags(ConfigFlag.NO_TRANSLATE)
</a><a href="#h152-0-42" id="h152-0-42" class="d">-    }
</a><a href="#h152-0-43" id="h152-0-43" class="d">-    val downloadProfilePictures = boolean(&quot;download_profile_pictures&quot;) { requireRestart() }
</a><a href="#h152-0-44" id="h152-0-44" class="d">-    val chatDownloadContextMenu = boolean(&quot;chat_download_context_menu&quot;)
</a><a href="#h152-0-45" id="h152-0-45" class="d">-    val ffmpegOptions = container(&quot;ffmpeg_options&quot;, FFMpegOptions()) { addNotices(FeatureNotice.UNSTABLE) }
</a><a href="#h152-0-46" id="h152-0-46" class="d">-    val logging = multiple(&quot;logging&quot;, &quot;started&quot;, &quot;success&quot;, &quot;progress&quot;, &quot;failure&quot;).apply {
</a><a href="#h152-0-47" id="h152-0-47" class="d">-        set(mutableListOf(&quot;started&quot;, &quot;success&quot;))
</a><a href="#h152-0-48" id="h152-0-48" class="d">-    }
</a><a href="#h152-0-49" id="h152-0-49" class="d">-}</a><a href="#h152-0-50" id="h152-0-50" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h153" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/E2EEConfig.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/E2EEConfig.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/E2EEConfig.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/E2EEConfig.kt</a></b>
<a href="#h153-0" id="h153-0" class="h">@@ -1,8 +0,0 @@
</a><a href="#h153-0-0" id="h153-0-0" class="d">-package me.rhunk.snapenhance.core.config.impl
</a><a href="#h153-0-1" id="h153-0-1" class="d">-
</a><a href="#h153-0-2" id="h153-0-2" class="d">-import me.rhunk.snapenhance.core.config.ConfigContainer
</a><a href="#h153-0-3" id="h153-0-3" class="d">-
</a><a href="#h153-0-4" id="h153-0-4" class="d">-class E2EEConfig : ConfigContainer(hasGlobalState = true) {
</a><a href="#h153-0-5" id="h153-0-5" class="d">-    val encryptedMessageIndicator = boolean(&quot;encrypted_message_indicator&quot;)
</a><a href="#h153-0-6" id="h153-0-6" class="d">-    val forceMessageEncryption = boolean(&quot;force_message_encryption&quot;)
</a><a href="#h153-0-7" id="h153-0-7" class="d">-}</a><a href="#h153-0-8" id="h153-0-8" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h154" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/Experimental.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/Experimental.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/Experimental.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/Experimental.kt</a></b>
<a href="#h154-0" id="h154-0" class="h">@@ -1,27 +0,0 @@
</a><a href="#h154-0-0" id="h154-0-0" class="d">-package me.rhunk.snapenhance.core.config.impl
</a><a href="#h154-0-1" id="h154-0-1" class="d">-
</a><a href="#h154-0-2" id="h154-0-2" class="d">-import me.rhunk.snapenhance.core.config.ConfigContainer
</a><a href="#h154-0-3" id="h154-0-3" class="d">-import me.rhunk.snapenhance.core.config.FeatureNotice
</a><a href="#h154-0-4" id="h154-0-4" class="d">-
</a><a href="#h154-0-5" id="h154-0-5" class="d">-class Experimental : ConfigContainer() {
</a><a href="#h154-0-6" id="h154-0-6" class="d">-    val nativeHooks = container(&quot;native_hooks&quot;, NativeHooks()) { icon = &quot;Memory&quot;; requireRestart() }
</a><a href="#h154-0-7" id="h154-0-7" class="d">-    val spoof = container(&quot;spoof&quot;, Spoof()) { icon = &quot;Fingerprint&quot; }
</a><a href="#h154-0-8" id="h154-0-8" class="d">-    val appPasscode = string(&quot;app_passcode&quot;)
</a><a href="#h154-0-9" id="h154-0-9" class="d">-    val appLockOnResume = boolean(&quot;app_lock_on_resume&quot;)
</a><a href="#h154-0-10" id="h154-0-10" class="d">-    val infiniteStoryBoost = boolean(&quot;infinite_story_boost&quot;)
</a><a href="#h154-0-11" id="h154-0-11" class="d">-    val meoPasscodeBypass = boolean(&quot;meo_passcode_bypass&quot;)
</a><a href="#h154-0-12" id="h154-0-12" class="d">-    val unlimitedMultiSnap = boolean(&quot;unlimited_multi_snap&quot;) { addNotices(FeatureNotice.BAN_RISK)}
</a><a href="#h154-0-13" id="h154-0-13" class="d">-    val noFriendScoreDelay = boolean(&quot;no_friend_score_delay&quot;) { requireRestart()}
</a><a href="#h154-0-14" id="h154-0-14" class="d">-    val e2eEncryption = container(&quot;e2ee&quot;, E2EEConfig()) { requireRestart()}
</a><a href="#h154-0-15" id="h154-0-15" class="d">-    val hiddenSnapchatPlusFeatures = boolean(&quot;hidden_snapchat_plus_features&quot;) {
</a><a href="#h154-0-16" id="h154-0-16" class="d">-        addNotices(FeatureNotice.BAN_RISK, FeatureNotice.UNSTABLE)
</a><a href="#h154-0-17" id="h154-0-17" class="d">-        requireRestart()
</a><a href="#h154-0-18" id="h154-0-18" class="d">-    }
</a><a href="#h154-0-19" id="h154-0-19" class="d">-    val addFriendSourceSpoof = unique(&quot;add_friend_source_spoof&quot;,
</a><a href="#h154-0-20" id="h154-0-20" class="d">-        &quot;added_by_username&quot;,
</a><a href="#h154-0-21" id="h154-0-21" class="d">-        &quot;added_by_mention&quot;,
</a><a href="#h154-0-22" id="h154-0-22" class="d">-        &quot;added_by_group_chat&quot;,
</a><a href="#h154-0-23" id="h154-0-23" class="d">-        &quot;added_by_qr_code&quot;,
</a><a href="#h154-0-24" id="h154-0-24" class="d">-        &quot;added_by_community&quot;,
</a><a href="#h154-0-25" id="h154-0-25" class="d">-    ) { addNotices(FeatureNotice.BAN_RISK) }
</a><a href="#h154-0-26" id="h154-0-26" class="d">-}</a><a href="#h154-0-27" id="h154-0-27" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h155" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/Global.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/Global.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/Global.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/Global.kt</a></b>
<a href="#h155-0" id="h155-0" class="h">@@ -1,14 +0,0 @@
</a><a href="#h155-0-0" id="h155-0-0" class="d">-package me.rhunk.snapenhance.core.config.impl
</a><a href="#h155-0-1" id="h155-0-1" class="d">-
</a><a href="#h155-0-2" id="h155-0-2" class="d">-import me.rhunk.snapenhance.core.config.ConfigContainer
</a><a href="#h155-0-3" id="h155-0-3" class="d">-import me.rhunk.snapenhance.core.config.FeatureNotice
</a><a href="#h155-0-4" id="h155-0-4" class="d">-
</a><a href="#h155-0-5" id="h155-0-5" class="d">-class Global : ConfigContainer() {
</a><a href="#h155-0-6" id="h155-0-6" class="d">-    val snapchatPlus = boolean(&quot;snapchat_plus&quot;) { addNotices(FeatureNotice.BAN_RISK); requireRestart() }
</a><a href="#h155-0-7" id="h155-0-7" class="d">-    val disableMetrics = boolean(&quot;disable_metrics&quot;)
</a><a href="#h155-0-8" id="h155-0-8" class="d">-    val blockAds = boolean(&quot;block_ads&quot;)
</a><a href="#h155-0-9" id="h155-0-9" class="d">-    val bypassVideoLengthRestriction = unique(&quot;bypass_video_length_restriction&quot;, &quot;split&quot;, &quot;single&quot;) { addNotices(FeatureNotice.BAN_RISK); requireRestart() }
</a><a href="#h155-0-10" id="h155-0-10" class="d">-    val disableGooglePlayDialogs = boolean(&quot;disable_google_play_dialogs&quot;) { requireRestart() }
</a><a href="#h155-0-11" id="h155-0-11" class="d">-    val forceMediaSourceQuality = boolean(&quot;force_media_source_quality&quot;)
</a><a href="#h155-0-12" id="h155-0-12" class="d">-    val disableSnapSplitting = boolean(&quot;disable_snap_splitting&quot;) { addNotices(FeatureNotice.INTERNAL_BEHAVIOR) }
</a><a href="#h155-0-13" id="h155-0-13" class="d">-}</a><a href="#h155-0-14" id="h155-0-14" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h156" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/MessagingTweaks.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/MessagingTweaks.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/MessagingTweaks.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/MessagingTweaks.kt</a></b>
<a href="#h156-0" id="h156-0" class="h">@@ -1,31 +0,0 @@
</a><a href="#h156-0-0" id="h156-0-0" class="d">-package me.rhunk.snapenhance.core.config.impl
</a><a href="#h156-0-1" id="h156-0-1" class="d">-
</a><a href="#h156-0-2" id="h156-0-2" class="d">-import me.rhunk.snapenhance.core.config.ConfigContainer
</a><a href="#h156-0-3" id="h156-0-3" class="d">-import me.rhunk.snapenhance.core.config.FeatureNotice
</a><a href="#h156-0-4" id="h156-0-4" class="d">-import me.rhunk.snapenhance.data.NotificationType
</a><a href="#h156-0-5" id="h156-0-5" class="d">-
</a><a href="#h156-0-6" id="h156-0-6" class="d">-class MessagingTweaks : ConfigContainer() {
</a><a href="#h156-0-7" id="h156-0-7" class="d">-    val anonymousStoryViewing = boolean(&quot;anonymous_story_viewing&quot;)
</a><a href="#h156-0-8" id="h156-0-8" class="d">-    val hideBitmojiPresence = boolean(&quot;hide_bitmoji_presence&quot;)
</a><a href="#h156-0-9" id="h156-0-9" class="d">-    val hideTypingNotifications = boolean(&quot;hide_typing_notifications&quot;)
</a><a href="#h156-0-10" id="h156-0-10" class="d">-    val unlimitedSnapViewTime = boolean(&quot;unlimited_snap_view_time&quot;)
</a><a href="#h156-0-11" id="h156-0-11" class="d">-    val disableReplayInFF = boolean(&quot;disable_replay_in_ff&quot;)
</a><a href="#h156-0-12" id="h156-0-12" class="d">-    val autoSaveMessagesInConversations = multiple(&quot;auto_save_messages_in_conversations&quot;,
</a><a href="#h156-0-13" id="h156-0-13" class="d">-        &quot;CHAT&quot;,
</a><a href="#h156-0-14" id="h156-0-14" class="d">-        &quot;SNAP&quot;,
</a><a href="#h156-0-15" id="h156-0-15" class="d">-        &quot;NOTE&quot;,
</a><a href="#h156-0-16" id="h156-0-16" class="d">-        &quot;EXTERNAL_MEDIA&quot;,
</a><a href="#h156-0-17" id="h156-0-17" class="d">-        &quot;STICKER&quot;
</a><a href="#h156-0-18" id="h156-0-18" class="d">-    ) { requireRestart() }
</a><a href="#h156-0-19" id="h156-0-19" class="d">-    val snapToChatMedia = boolean(&quot;snap_to_chat_media&quot;) { requireRestart() }
</a><a href="#h156-0-20" id="h156-0-20" class="d">-    val preventMessageSending = multiple(&quot;prevent_message_sending&quot;, *NotificationType.getOutgoingValues().map { it.key }.toTypedArray()) {
</a><a href="#h156-0-21" id="h156-0-21" class="d">-        customOptionTranslationPath = &quot;features.options.notifications&quot;
</a><a href="#h156-0-22" id="h156-0-22" class="d">-    }
</a><a href="#h156-0-23" id="h156-0-23" class="d">-    val betterNotifications = multiple(&quot;better_notifications&quot;, &quot;snap&quot;, &quot;chat&quot;, &quot;reply_button&quot;, &quot;download_button&quot;, &quot;group&quot;) { requireRestart() }
</a><a href="#h156-0-24" id="h156-0-24" class="d">-    val notificationBlacklist = multiple(&quot;notification_blacklist&quot;, *NotificationType.getIncomingValues().map { it.key }.toTypedArray()) {
</a><a href="#h156-0-25" id="h156-0-25" class="d">-        customOptionTranslationPath = &quot;features.options.notifications&quot;
</a><a href="#h156-0-26" id="h156-0-26" class="d">-    }
</a><a href="#h156-0-27" id="h156-0-27" class="d">-    val messageLogger = boolean(&quot;message_logger&quot;) { addNotices(FeatureNotice.UNSTABLE); requireRestart() }
</a><a href="#h156-0-28" id="h156-0-28" class="d">-    val galleryMediaSendOverride = boolean(&quot;gallery_media_send_override&quot;)
</a><a href="#h156-0-29" id="h156-0-29" class="d">-    val messagePreviewLength = integer(&quot;message_preview_length&quot;, defaultValue = 20)
</a><a href="#h156-0-30" id="h156-0-30" class="d">-}</a><a href="#h156-0-31" id="h156-0-31" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h157" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/NativeHooks.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/NativeHooks.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/NativeHooks.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/NativeHooks.kt</a></b>
<a href="#h157-0" id="h157-0" class="h">@@ -1,8 +0,0 @@
</a><a href="#h157-0-0" id="h157-0-0" class="d">-package me.rhunk.snapenhance.core.config.impl
</a><a href="#h157-0-1" id="h157-0-1" class="d">-
</a><a href="#h157-0-2" id="h157-0-2" class="d">-import me.rhunk.snapenhance.core.config.ConfigContainer
</a><a href="#h157-0-3" id="h157-0-3" class="d">-
</a><a href="#h157-0-4" id="h157-0-4" class="d">-class NativeHooks: ConfigContainer(hasGlobalState = true) {
</a><a href="#h157-0-5" id="h157-0-5" class="d">-    val disableBitmoji = boolean(&quot;disable_bitmoji&quot;)
</a><a href="#h157-0-6" id="h157-0-6" class="d">-    val fixGalleryMediaOverride = boolean(&quot;fix_gallery_media_override&quot;)
</a><a href="#h157-0-7" id="h157-0-7" class="d">-}</a><a href="#h157-0-8" id="h157-0-8" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h158" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/RootConfig.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/RootConfig.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/RootConfig.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/RootConfig.kt</a></b>
<a href="#h158-0" id="h158-0" class="h">@@ -1,18 +0,0 @@
</a><a href="#h158-0-0" id="h158-0-0" class="d">-package me.rhunk.snapenhance.core.config.impl
</a><a href="#h158-0-1" id="h158-0-1" class="d">-
</a><a href="#h158-0-2" id="h158-0-2" class="d">-import me.rhunk.snapenhance.core.config.ConfigContainer
</a><a href="#h158-0-3" id="h158-0-3" class="d">-import me.rhunk.snapenhance.core.config.FeatureNotice
</a><a href="#h158-0-4" id="h158-0-4" class="d">-
</a><a href="#h158-0-5" id="h158-0-5" class="d">-class RootConfig : ConfigContainer() {
</a><a href="#h158-0-6" id="h158-0-6" class="d">-    val downloader = container(&quot;downloader&quot;, DownloaderConfig()) { icon = &quot;Download&quot;}
</a><a href="#h158-0-7" id="h158-0-7" class="d">-    val userInterface = container(&quot;user_interface&quot;, UserInterfaceTweaks()) { icon = &quot;RemoveRedEye&quot;}
</a><a href="#h158-0-8" id="h158-0-8" class="d">-    val messaging = container(&quot;messaging&quot;, MessagingTweaks()) { icon = &quot;Send&quot; }
</a><a href="#h158-0-9" id="h158-0-9" class="d">-    val global = container(&quot;global&quot;, Global()) { icon = &quot;MiscellaneousServices&quot; }
</a><a href="#h158-0-10" id="h158-0-10" class="d">-    val rules = container(&quot;rules&quot;, Rules()) { icon = &quot;Rule&quot; }
</a><a href="#h158-0-11" id="h158-0-11" class="d">-    val camera = container(&quot;camera&quot;, Camera()) { icon = &quot;Camera&quot;; requireRestart() }
</a><a href="#h158-0-12" id="h158-0-12" class="d">-    val streaksReminder = container(&quot;streaks_reminder&quot;, StreaksReminderConfig()) { icon = &quot;Alarm&quot; }
</a><a href="#h158-0-13" id="h158-0-13" class="d">-    val experimental = container(&quot;experimental&quot;, Experimental()) {
</a><a href="#h158-0-14" id="h158-0-14" class="d">-        icon = &quot;Science&quot;; addNotices(FeatureNotice.UNSTABLE)
</a><a href="#h158-0-15" id="h158-0-15" class="d">-    }
</a><a href="#h158-0-16" id="h158-0-16" class="d">-    val scripting = container(&quot;scripting&quot;, Scripting()) { icon = &quot;DataObject&quot; }
</a><a href="#h158-0-17" id="h158-0-17" class="d">-}</a><a href="#h158-0-18" id="h158-0-18" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h159" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/Rules.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/Rules.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/Rules.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/Rules.kt</a></b>
<a href="#h159-0" id="h159-0" class="h">@@ -1,26 +0,0 @@
</a><a href="#h159-0-0" id="h159-0-0" class="d">-package me.rhunk.snapenhance.core.config.impl
</a><a href="#h159-0-1" id="h159-0-1" class="d">-
</a><a href="#h159-0-2" id="h159-0-2" class="d">-import me.rhunk.snapenhance.core.config.ConfigContainer
</a><a href="#h159-0-3" id="h159-0-3" class="d">-import me.rhunk.snapenhance.core.config.PropertyValue
</a><a href="#h159-0-4" id="h159-0-4" class="d">-import me.rhunk.snapenhance.core.messaging.MessagingRuleType
</a><a href="#h159-0-5" id="h159-0-5" class="d">-import me.rhunk.snapenhance.core.messaging.RuleState
</a><a href="#h159-0-6" id="h159-0-6" class="d">-
</a><a href="#h159-0-7" id="h159-0-7" class="d">-
</a><a href="#h159-0-8" id="h159-0-8" class="d">-class Rules : ConfigContainer() {
</a><a href="#h159-0-9" id="h159-0-9" class="d">-    private val rules = mutableMapOf&lt;MessagingRuleType, PropertyValue&lt;String&gt;&gt;()
</a><a href="#h159-0-10" id="h159-0-10" class="d">-
</a><a href="#h159-0-11" id="h159-0-11" class="d">-    fun getRuleState(ruleType: MessagingRuleType): RuleState? {
</a><a href="#h159-0-12" id="h159-0-12" class="d">-        return rules[ruleType]?.getNullable()?.let { RuleState.getByName(it) }
</a><a href="#h159-0-13" id="h159-0-13" class="d">-    }
</a><a href="#h159-0-14" id="h159-0-14" class="d">-
</a><a href="#h159-0-15" id="h159-0-15" class="d">-    init {
</a><a href="#h159-0-16" id="h159-0-16" class="d">-        MessagingRuleType.entries.filter { it.listMode }.forEach { ruleType -&gt;
</a><a href="#h159-0-17" id="h159-0-17" class="d">-            rules[ruleType] = unique(ruleType.key,&quot;whitelist&quot;, &quot;blacklist&quot;) {
</a><a href="#h159-0-18" id="h159-0-18" class="d">-                customTranslationPath = &quot;rules.properties.${ruleType.key}&quot;
</a><a href="#h159-0-19" id="h159-0-19" class="d">-                customOptionTranslationPath = &quot;rules.modes&quot;
</a><a href="#h159-0-20" id="h159-0-20" class="d">-            }.apply {
</a><a href="#h159-0-21" id="h159-0-21" class="d">-                set(&quot;whitelist&quot;)
</a><a href="#h159-0-22" id="h159-0-22" class="d">-            }
</a><a href="#h159-0-23" id="h159-0-23" class="d">-        }
</a><a href="#h159-0-24" id="h159-0-24" class="d">-    }
</a><a href="#h159-0-25" id="h159-0-25" class="d">-}</a><a href="#h159-0-26" id="h159-0-26" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h160" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/Scripting.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/Scripting.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/Scripting.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/Scripting.kt</a></b>
<a href="#h160-0" id="h160-0" class="h">@@ -1,10 +0,0 @@
</a><a href="#h160-0-0" id="h160-0-0" class="d">-package me.rhunk.snapenhance.core.config.impl
</a><a href="#h160-0-1" id="h160-0-1" class="d">-
</a><a href="#h160-0-2" id="h160-0-2" class="d">-import me.rhunk.snapenhance.core.config.ConfigContainer
</a><a href="#h160-0-3" id="h160-0-3" class="d">-import me.rhunk.snapenhance.core.config.ConfigFlag
</a><a href="#h160-0-4" id="h160-0-4" class="d">-
</a><a href="#h160-0-5" id="h160-0-5" class="d">-class Scripting : ConfigContainer() {
</a><a href="#h160-0-6" id="h160-0-6" class="d">-    val developerMode = boolean(&quot;developer_mode&quot;, false) { requireRestart() }
</a><a href="#h160-0-7" id="h160-0-7" class="d">-    val moduleFolder = string(&quot;module_folder&quot;, &quot;modules&quot;) { addFlags(ConfigFlag.FOLDER); requireRestart()  }
</a><a href="#h160-0-8" id="h160-0-8" class="d">-    val hotReload = boolean(&quot;hot_reload&quot;, false)
</a><a href="#h160-0-9" id="h160-0-9" class="d">-}</a><a href="#h160-0-10" id="h160-0-10" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h161" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/Spoof.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/Spoof.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/Spoof.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/Spoof.kt</a></b>
<a href="#h161-0" id="h161-0" class="h">@@ -1,24 +0,0 @@
</a><a href="#h161-0-0" id="h161-0-0" class="d">-package me.rhunk.snapenhance.core.config.impl
</a><a href="#h161-0-1" id="h161-0-1" class="d">-
</a><a href="#h161-0-2" id="h161-0-2" class="d">-import me.rhunk.snapenhance.core.config.ConfigContainer
</a><a href="#h161-0-3" id="h161-0-3" class="d">-import me.rhunk.snapenhance.core.config.FeatureNotice
</a><a href="#h161-0-4" id="h161-0-4" class="d">-
</a><a href="#h161-0-5" id="h161-0-5" class="d">-class Spoof : ConfigContainer() {
</a><a href="#h161-0-6" id="h161-0-6" class="d">-    inner class Location : ConfigContainer(hasGlobalState = true) {
</a><a href="#h161-0-7" id="h161-0-7" class="d">-        val latitude = float(&quot;location_latitude&quot;)
</a><a href="#h161-0-8" id="h161-0-8" class="d">-        val longitude = float(&quot;location_longitude&quot;)
</a><a href="#h161-0-9" id="h161-0-9" class="d">-    }
</a><a href="#h161-0-10" id="h161-0-10" class="d">-    val location = container(&quot;location&quot;, Location())
</a><a href="#h161-0-11" id="h161-0-11" class="d">-
</a><a href="#h161-0-12" id="h161-0-12" class="d">-    inner class Device : ConfigContainer(hasGlobalState = true) {
</a><a href="#h161-0-13" id="h161-0-13" class="d">-        val fingerprint = string(&quot;fingerprint&quot;)
</a><a href="#h161-0-14" id="h161-0-14" class="d">-        val androidId = string(&quot;android_id&quot;)
</a><a href="#h161-0-15" id="h161-0-15" class="d">-        val getInstallerPackageName = string(&quot;installer_package_name&quot;)
</a><a href="#h161-0-16" id="h161-0-16" class="d">-        val debugFlag = boolean(&quot;debug_flag&quot;)
</a><a href="#h161-0-17" id="h161-0-17" class="d">-        val mockLocationState = boolean(&quot;mock_location&quot;)
</a><a href="#h161-0-18" id="h161-0-18" class="d">-        val splitClassLoader = string(&quot;split_classloader&quot;)
</a><a href="#h161-0-19" id="h161-0-19" class="d">-        val isLowEndDevice = string(&quot;low_end_device&quot;)
</a><a href="#h161-0-20" id="h161-0-20" class="d">-        val getDataDirectory = string(&quot;get_data_directory&quot;)
</a><a href="#h161-0-21" id="h161-0-21" class="d">-    }
</a><a href="#h161-0-22" id="h161-0-22" class="d">-    val device = container(&quot;device&quot;, Device()) { addNotices(FeatureNotice.BAN_RISK) }
</a><a href="#h161-0-23" id="h161-0-23" class="d">-}</a><a href="#h161-0-24" id="h161-0-24" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h162" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/StreaksReminderConfig.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/StreaksReminderConfig.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/StreaksReminderConfig.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/StreaksReminderConfig.kt</a></b>
<a href="#h162-0" id="h162-0" class="h">@@ -1,9 +0,0 @@
</a><a href="#h162-0-0" id="h162-0-0" class="d">-package me.rhunk.snapenhance.core.config.impl
</a><a href="#h162-0-1" id="h162-0-1" class="d">-
</a><a href="#h162-0-2" id="h162-0-2" class="d">-import me.rhunk.snapenhance.core.config.ConfigContainer
</a><a href="#h162-0-3" id="h162-0-3" class="d">-
</a><a href="#h162-0-4" id="h162-0-4" class="d">-class StreaksReminderConfig : ConfigContainer(hasGlobalState = true) {
</a><a href="#h162-0-5" id="h162-0-5" class="d">-    val interval = integer(&quot;interval&quot;, 2)
</a><a href="#h162-0-6" id="h162-0-6" class="d">-    val remainingHours = integer(&quot;remaining_hours&quot;, 13)
</a><a href="#h162-0-7" id="h162-0-7" class="d">-    val groupNotifications = boolean(&quot;group_notifications&quot;, true)
</a><a href="#h162-0-8" id="h162-0-8" class="d">-}</a><a href="#h162-0-9" id="h162-0-9" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h163" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/UserInterfaceTweaks.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/UserInterfaceTweaks.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/UserInterfaceTweaks.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/UserInterfaceTweaks.kt</a></b>
<a href="#h163-0" id="h163-0" class="h">@@ -1,42 +0,0 @@
</a><a href="#h163-0-0" id="h163-0-0" class="d">-package me.rhunk.snapenhance.core.config.impl
</a><a href="#h163-0-1" id="h163-0-1" class="d">-
</a><a href="#h163-0-2" id="h163-0-2" class="d">-import me.rhunk.snapenhance.core.config.ConfigContainer
</a><a href="#h163-0-3" id="h163-0-3" class="d">-import me.rhunk.snapenhance.core.config.FeatureNotice
</a><a href="#h163-0-4" id="h163-0-4" class="d">-import me.rhunk.snapenhance.core.messaging.MessagingRuleType
</a><a href="#h163-0-5" id="h163-0-5" class="d">-import me.rhunk.snapenhance.features.impl.ui.ClientBootstrapOverride
</a><a href="#h163-0-6" id="h163-0-6" class="d">-
</a><a href="#h163-0-7" id="h163-0-7" class="d">-class UserInterfaceTweaks : ConfigContainer() {
</a><a href="#h163-0-8" id="h163-0-8" class="d">-    inner class BootstrapOverride : ConfigContainer() {
</a><a href="#h163-0-9" id="h163-0-9" class="d">-        val appAppearance = unique(&quot;app_appearance&quot;, &quot;always_light&quot;, &quot;always_dark&quot;)
</a><a href="#h163-0-10" id="h163-0-10" class="d">-        val homeTab = unique(&quot;home_tab&quot;, *ClientBootstrapOverride.tabs) { addNotices(FeatureNotice.UNSTABLE) }
</a><a href="#h163-0-11" id="h163-0-11" class="d">-    }
</a><a href="#h163-0-12" id="h163-0-12" class="d">-
</a><a href="#h163-0-13" id="h163-0-13" class="d">-    inner class FriendFeedMessagePreview : ConfigContainer(hasGlobalState = true) {
</a><a href="#h163-0-14" id="h163-0-14" class="d">-        val amount = integer(&quot;amount&quot;, defaultValue = 1)
</a><a href="#h163-0-15" id="h163-0-15" class="d">-    }
</a><a href="#h163-0-16" id="h163-0-16" class="d">-
</a><a href="#h163-0-17" id="h163-0-17" class="d">-    val friendFeedMenuButtons = multiple(
</a><a href="#h163-0-18" id="h163-0-18" class="d">-        &quot;friend_feed_menu_buttons&quot;,&quot;conversation_info&quot;, *MessagingRuleType.entries.filter { it.showInFriendMenu }.map { it.key }.toTypedArray()
</a><a href="#h163-0-19" id="h163-0-19" class="d">-    ).apply {
</a><a href="#h163-0-20" id="h163-0-20" class="d">-        set(mutableListOf(&quot;conversation_info&quot;, MessagingRuleType.STEALTH.key))
</a><a href="#h163-0-21" id="h163-0-21" class="d">-    }
</a><a href="#h163-0-22" id="h163-0-22" class="d">-    val friendFeedMenuPosition = integer(&quot;friend_feed_menu_position&quot;, defaultValue = 1)
</a><a href="#h163-0-23" id="h163-0-23" class="d">-    val amoledDarkMode = boolean(&quot;amoled_dark_mode&quot;) { addNotices(FeatureNotice.UNSTABLE); requireRestart() }
</a><a href="#h163-0-24" id="h163-0-24" class="d">-    val friendFeedMessagePreview = container(&quot;friend_feed_message_preview&quot;, FriendFeedMessagePreview()) { requireRestart() }
</a><a href="#h163-0-25" id="h163-0-25" class="d">-    val bootstrapOverride = container(&quot;bootstrap_override&quot;, BootstrapOverride()) { requireRestart() }
</a><a href="#h163-0-26" id="h163-0-26" class="d">-    val mapFriendNameTags = boolean(&quot;map_friend_nametags&quot;) { requireRestart() }
</a><a href="#h163-0-27" id="h163-0-27" class="d">-    val streakExpirationInfo = boolean(&quot;streak_expiration_info&quot;) { requireRestart() }
</a><a href="#h163-0-28" id="h163-0-28" class="d">-    val hideStreakRestore = boolean(&quot;hide_streak_restore&quot;) { requireRestart() }
</a><a href="#h163-0-29" id="h163-0-29" class="d">-    val hideStorySections = multiple(&quot;hide_story_sections&quot;,
</a><a href="#h163-0-30" id="h163-0-30" class="d">-        &quot;hide_friend_suggestions&quot;, &quot;hide_friends&quot;, &quot;hide_suggested&quot;, &quot;hide_for_you&quot;) { requireRestart() }
</a><a href="#h163-0-31" id="h163-0-31" class="d">-    val hideUiComponents = multiple(&quot;hide_ui_components&quot;,
</a><a href="#h163-0-32" id="h163-0-32" class="d">-        &quot;hide_voice_record_button&quot;,
</a><a href="#h163-0-33" id="h163-0-33" class="d">-        &quot;hide_stickers_button&quot;,
</a><a href="#h163-0-34" id="h163-0-34" class="d">-        &quot;hide_live_location_share_button&quot;,
</a><a href="#h163-0-35" id="h163-0-35" class="d">-        &quot;hide_chat_call_buttons&quot;,
</a><a href="#h163-0-36" id="h163-0-36" class="d">-        &quot;hide_profile_call_buttons&quot;
</a><a href="#h163-0-37" id="h163-0-37" class="d">-    ) { requireRestart() }
</a><a href="#h163-0-38" id="h163-0-38" class="d">-    val ddBitmojiSelfie = boolean(&quot;2d_bitmoji_selfie&quot;) { requireCleanCache() }
</a><a href="#h163-0-39" id="h163-0-39" class="d">-    val disableSpotlight = boolean(&quot;disable_spotlight&quot;) { requireRestart() }
</a><a href="#h163-0-40" id="h163-0-40" class="d">-    val storyViewerOverride = unique(&quot;story_viewer_override&quot;, &quot;DISCOVER_PLAYBACK_SEEKBAR&quot;, &quot;VERTICAL_STORY_VIEWER&quot;) { requireRestart() }
</a><a href="#h163-0-41" id="h163-0-41" class="d">-}
</a><b>diff --git a/<a id="h164" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/data/SnapClassCache.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/data/SnapClassCache.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/data/SnapClassCache.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/data/SnapClassCache.kt</a></b>
<a href="#h164-0" id="h164-0" class="h">@@ -0,0 +1,30 @@
</a><a href="#h164-0-0" id="h164-0-0" class="i">+package me.rhunk.snapenhance.core.data
</a><a href="#h164-0-1" id="h164-0-1" class="i">+
</a><a href="#h164-0-2" id="h164-0-2" class="i">+class SnapClassCache (
</a><a href="#h164-0-3" id="h164-0-3" class="i">+    private val classLoader: ClassLoader
</a><a href="#h164-0-4" id="h164-0-4" class="i">+) {
</a><a href="#h164-0-5" id="h164-0-5" class="i">+    val snapUUID by lazy { findClass(&quot;com.snapchat.client.messaging.UUID&quot;) }
</a><a href="#h164-0-6" id="h164-0-6" class="i">+    val snapManager by lazy { findClass(&quot;com.snapchat.client.messaging.SnapManager\$CppProxy&quot;) }
</a><a href="#h164-0-7" id="h164-0-7" class="i">+    val conversationManager by lazy { findClass(&quot;com.snapchat.client.messaging.ConversationManager\$CppProxy&quot;) }
</a><a href="#h164-0-8" id="h164-0-8" class="i">+    val presenceSession by lazy { findClass(&quot;com.snapchat.talkcorev3.PresenceSession\$CppProxy&quot;) }
</a><a href="#h164-0-9" id="h164-0-9" class="i">+    val message by lazy { findClass(&quot;com.snapchat.client.messaging.Message&quot;) }
</a><a href="#h164-0-10" id="h164-0-10" class="i">+    val messageUpdateEnum by lazy { findClass(&quot;com.snapchat.client.messaging.MessageUpdate&quot;) }
</a><a href="#h164-0-11" id="h164-0-11" class="i">+    val unifiedGrpcService by lazy { findClass(&quot;com.snapchat.client.grpc.UnifiedGrpcService\$CppProxy&quot;) }
</a><a href="#h164-0-12" id="h164-0-12" class="i">+    val networkApi by lazy { findClass(&quot;com.snapchat.client.network_api.NetworkApi\$CppProxy&quot;) }
</a><a href="#h164-0-13" id="h164-0-13" class="i">+    val messageDestinations by lazy { findClass(&quot;com.snapchat.client.messaging.MessageDestinations&quot;) }
</a><a href="#h164-0-14" id="h164-0-14" class="i">+    val localMessageContent by lazy { findClass(&quot;com.snapchat.client.messaging.LocalMessageContent&quot;) }
</a><a href="#h164-0-15" id="h164-0-15" class="i">+    val feedEntry by lazy { findClass(&quot;com.snapchat.client.messaging.FeedEntry&quot;) }
</a><a href="#h164-0-16" id="h164-0-16" class="i">+    val conversation by lazy { findClass(&quot;com.snapchat.client.messaging.Conversation&quot;) }
</a><a href="#h164-0-17" id="h164-0-17" class="i">+    val feedManager by lazy { findClass(&quot;com.snapchat.client.messaging.FeedManager\$CppProxy&quot;) }
</a><a href="#h164-0-18" id="h164-0-18" class="i">+    val chromiumJNIUtils by lazy { findClass(&quot;org.chromium.base.JNIUtils&quot;)}
</a><a href="#h164-0-19" id="h164-0-19" class="i">+    val chromiumBuildInfo by lazy { findClass(&quot;org.chromium.base.BuildInfo&quot;)}
</a><a href="#h164-0-20" id="h164-0-20" class="i">+    val chromiumPathUtils by lazy { findClass(&quot;org.chromium.base.PathUtils&quot;)}
</a><a href="#h164-0-21" id="h164-0-21" class="i">+
</a><a href="#h164-0-22" id="h164-0-22" class="i">+    private fun findClass(className: String): Class&lt;*&gt; {
</a><a href="#h164-0-23" id="h164-0-23" class="i">+        return try {
</a><a href="#h164-0-24" id="h164-0-24" class="i">+            classLoader.loadClass(className)
</a><a href="#h164-0-25" id="h164-0-25" class="i">+        } catch (e: ClassNotFoundException) {
</a><a href="#h164-0-26" id="h164-0-26" class="i">+            throw RuntimeException(&quot;Failed to find class $className&quot;, e)
</a><a href="#h164-0-27" id="h164-0-27" class="i">+        }
</a><a href="#h164-0-28" id="h164-0-28" class="i">+    }
</a><a href="#h164-0-29" id="h164-0-29" class="i">+}</a><a href="#h164-0-30" id="h164-0-30" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h165" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/database/DatabaseAccess.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/database/DatabaseAccess.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/database/DatabaseAccess.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/database/DatabaseAccess.kt</a></b>
<a href="#h165-0" id="h165-0" class="h">@@ -2,15 +2,16 @@ package me.rhunk.snapenhance.core.database
</a> 
 import android.annotation.SuppressLint
 import android.database.sqlite.SQLiteDatabase
<a href="#h165-0-3" id="h165-0-3" class="d">-import me.rhunk.snapenhance.ModContext
</a><a href="#h165-0-4" id="h165-0-4" class="d">-import me.rhunk.snapenhance.core.Logger
</a><a href="#h165-0-5" id="h165-0-5" class="d">-import me.rhunk.snapenhance.core.database.objects.ConversationMessage
</a><a href="#h165-0-6" id="h165-0-6" class="d">-import me.rhunk.snapenhance.core.database.objects.FriendFeedEntry
</a><a href="#h165-0-7" id="h165-0-7" class="d">-import me.rhunk.snapenhance.core.database.objects.FriendInfo
</a><a href="#h165-0-8" id="h165-0-8" class="d">-import me.rhunk.snapenhance.core.database.objects.StoryEntry
</a><a href="#h165-0-9" id="h165-0-9" class="d">-import me.rhunk.snapenhance.core.database.objects.UserConversationLink
</a><a href="#h165-0-10" id="h165-0-10" class="d">-import me.rhunk.snapenhance.core.util.ktx.getStringOrNull
</a><a href="#h165-0-11" id="h165-0-11" class="d">-import me.rhunk.snapenhance.manager.Manager
</a><a href="#h165-0-12" id="h165-0-12" class="i">+import me.rhunk.snapenhance.common.database.DatabaseObject
</a><a href="#h165-0-13" id="h165-0-13" class="i">+import me.rhunk.snapenhance.common.database.impl.ConversationMessage
</a><a href="#h165-0-14" id="h165-0-14" class="i">+import me.rhunk.snapenhance.common.database.impl.FriendFeedEntry
</a><a href="#h165-0-15" id="h165-0-15" class="i">+import me.rhunk.snapenhance.common.database.impl.FriendInfo
</a><a href="#h165-0-16" id="h165-0-16" class="i">+import me.rhunk.snapenhance.common.database.impl.StoryEntry
</a><a href="#h165-0-17" id="h165-0-17" class="i">+import me.rhunk.snapenhance.common.database.impl.UserConversationLink
</a><a href="#h165-0-18" id="h165-0-18" class="i">+import me.rhunk.snapenhance.common.util.ktx.getStringOrNull
</a><a href="#h165-0-19" id="h165-0-19" class="i">+import me.rhunk.snapenhance.core.ModContext
</a><a href="#h165-0-20" id="h165-0-20" class="i">+import me.rhunk.snapenhance.core.logger.CoreLogger
</a><a href="#h165-0-21" id="h165-0-21" class="i">+import me.rhunk.snapenhance.core.manager.Manager
</a> import java.io.File
 
 @SuppressLint(&quot;Range&quot;)
<a href="#h165-1" id="h165-1" class="h">@@ -56,7 +57,7 @@ class DatabaseAccess(private val context: ModContext) : Manager {
</a>             return runCatching {
                 query(database)
             }.onFailure {
<a href="#h165-1-3" id="h165-1-3" class="d">-                Logger.xposedLog(&quot;Database operation failed&quot;, it)
</a><a href="#h165-1-4" id="h165-1-4" class="i">+                CoreLogger.xposedLog(&quot;Database operation failed&quot;, it)
</a>             }.getOrNull()
         }
     }
<b>diff --git a/<a id="h166" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/database/DatabaseObject.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/database/DatabaseObject.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/database/DatabaseObject.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/database/DatabaseObject.kt</a></b>
<a href="#h166-0" id="h166-0" class="h">@@ -1,7 +0,0 @@
</a><a href="#h166-0-0" id="h166-0-0" class="d">-package me.rhunk.snapenhance.core.database
</a><a href="#h166-0-1" id="h166-0-1" class="d">-
</a><a href="#h166-0-2" id="h166-0-2" class="d">-import android.database.Cursor
</a><a href="#h166-0-3" id="h166-0-3" class="d">-
</a><a href="#h166-0-4" id="h166-0-4" class="d">-interface DatabaseObject {
</a><a href="#h166-0-5" id="h166-0-5" class="d">-    fun write(cursor: Cursor)
</a><a href="#h166-0-6" id="h166-0-6" class="d">-}
</a><b>diff --git a/<a id="h167" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/database/objects/ConversationMessage.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/database/objects/ConversationMessage.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/database/objects/ConversationMessage.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/database/objects/ConversationMessage.kt</a></b>
<a href="#h167-0" id="h167-0" class="h">@@ -1,43 +0,0 @@
</a><a href="#h167-0-0" id="h167-0-0" class="d">-package me.rhunk.snapenhance.core.database.objects
</a><a href="#h167-0-1" id="h167-0-1" class="d">-
</a><a href="#h167-0-2" id="h167-0-2" class="d">-import android.annotation.SuppressLint
</a><a href="#h167-0-3" id="h167-0-3" class="d">-import android.database.Cursor
</a><a href="#h167-0-4" id="h167-0-4" class="d">-import me.rhunk.snapenhance.Constants
</a><a href="#h167-0-5" id="h167-0-5" class="d">-import me.rhunk.snapenhance.core.database.DatabaseObject
</a><a href="#h167-0-6" id="h167-0-6" class="d">-import me.rhunk.snapenhance.core.util.ktx.getBlobOrNull
</a><a href="#h167-0-7" id="h167-0-7" class="d">-import me.rhunk.snapenhance.core.util.ktx.getInteger
</a><a href="#h167-0-8" id="h167-0-8" class="d">-import me.rhunk.snapenhance.core.util.ktx.getLong
</a><a href="#h167-0-9" id="h167-0-9" class="d">-import me.rhunk.snapenhance.core.util.ktx.getStringOrNull
</a><a href="#h167-0-10" id="h167-0-10" class="d">-import me.rhunk.snapenhance.core.util.protobuf.ProtoReader
</a><a href="#h167-0-11" id="h167-0-11" class="d">-import me.rhunk.snapenhance.data.ContentType
</a><a href="#h167-0-12" id="h167-0-12" class="d">-
</a><a href="#h167-0-13" id="h167-0-13" class="d">-@Suppress(&quot;ArrayInDataClass&quot;)
</a><a href="#h167-0-14" id="h167-0-14" class="d">-data class ConversationMessage(
</a><a href="#h167-0-15" id="h167-0-15" class="d">-    var clientConversationId: String? = null,
</a><a href="#h167-0-16" id="h167-0-16" class="d">-    var clientMessageId: Int = 0,
</a><a href="#h167-0-17" id="h167-0-17" class="d">-    var serverMessageId: Int = 0,
</a><a href="#h167-0-18" id="h167-0-18" class="d">-    var messageContent: ByteArray? = null,
</a><a href="#h167-0-19" id="h167-0-19" class="d">-    var isSaved: Int = 0,
</a><a href="#h167-0-20" id="h167-0-20" class="d">-    var isViewedByUser: Int = 0,
</a><a href="#h167-0-21" id="h167-0-21" class="d">-    var contentType: Int = 0,
</a><a href="#h167-0-22" id="h167-0-22" class="d">-    var creationTimestamp: Long = 0,
</a><a href="#h167-0-23" id="h167-0-23" class="d">-    var readTimestamp: Long = 0,
</a><a href="#h167-0-24" id="h167-0-24" class="d">-    var senderId: String? = null
</a><a href="#h167-0-25" id="h167-0-25" class="d">-) : DatabaseObject {
</a><a href="#h167-0-26" id="h167-0-26" class="d">-
</a><a href="#h167-0-27" id="h167-0-27" class="d">-    @SuppressLint(&quot;Range&quot;)
</a><a href="#h167-0-28" id="h167-0-28" class="d">-    override fun write(cursor: Cursor) {
</a><a href="#h167-0-29" id="h167-0-29" class="d">-        with(cursor) {
</a><a href="#h167-0-30" id="h167-0-30" class="d">-            clientConversationId = getStringOrNull(&quot;client_conversation_id&quot;)
</a><a href="#h167-0-31" id="h167-0-31" class="d">-            clientMessageId = getInteger(&quot;client_message_id&quot;)
</a><a href="#h167-0-32" id="h167-0-32" class="d">-            serverMessageId = getInteger(&quot;server_message_id&quot;)
</a><a href="#h167-0-33" id="h167-0-33" class="d">-            messageContent = getBlobOrNull(&quot;message_content&quot;)
</a><a href="#h167-0-34" id="h167-0-34" class="d">-            isSaved = getInteger(&quot;is_saved&quot;)
</a><a href="#h167-0-35" id="h167-0-35" class="d">-            isViewedByUser = getInteger(&quot;is_viewed_by_user&quot;)
</a><a href="#h167-0-36" id="h167-0-36" class="d">-            contentType = getInteger(&quot;content_type&quot;)
</a><a href="#h167-0-37" id="h167-0-37" class="d">-            creationTimestamp = getLong(&quot;creation_timestamp&quot;)
</a><a href="#h167-0-38" id="h167-0-38" class="d">-            readTimestamp = getLong(&quot;read_timestamp&quot;)
</a><a href="#h167-0-39" id="h167-0-39" class="d">-            senderId = getStringOrNull(&quot;sender_id&quot;)
</a><a href="#h167-0-40" id="h167-0-40" class="d">-        }
</a><a href="#h167-0-41" id="h167-0-41" class="d">-    }
</a><a href="#h167-0-42" id="h167-0-42" class="d">-}
</a><b>diff --git a/<a id="h168" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/database/objects/FriendFeedEntry.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/database/objects/FriendFeedEntry.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/database/objects/FriendFeedEntry.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/database/objects/FriendFeedEntry.kt</a></b>
<a href="#h168-0" id="h168-0" class="h">@@ -1,47 +0,0 @@
</a><a href="#h168-0-0" id="h168-0-0" class="d">-package me.rhunk.snapenhance.core.database.objects
</a><a href="#h168-0-1" id="h168-0-1" class="d">-
</a><a href="#h168-0-2" id="h168-0-2" class="d">-import android.annotation.SuppressLint
</a><a href="#h168-0-3" id="h168-0-3" class="d">-import android.database.Cursor
</a><a href="#h168-0-4" id="h168-0-4" class="d">-import me.rhunk.snapenhance.core.database.DatabaseObject
</a><a href="#h168-0-5" id="h168-0-5" class="d">-import me.rhunk.snapenhance.core.util.ktx.getIntOrNull
</a><a href="#h168-0-6" id="h168-0-6" class="d">-import me.rhunk.snapenhance.core.util.ktx.getInteger
</a><a href="#h168-0-7" id="h168-0-7" class="d">-import me.rhunk.snapenhance.core.util.ktx.getLong
</a><a href="#h168-0-8" id="h168-0-8" class="d">-import me.rhunk.snapenhance.core.util.ktx.getStringOrNull
</a><a href="#h168-0-9" id="h168-0-9" class="d">-
</a><a href="#h168-0-10" id="h168-0-10" class="d">-data class FriendFeedEntry(
</a><a href="#h168-0-11" id="h168-0-11" class="d">-    var id: Int = 0,
</a><a href="#h168-0-12" id="h168-0-12" class="d">-    var feedDisplayName: String? = null,
</a><a href="#h168-0-13" id="h168-0-13" class="d">-    var participantsSize: Int = 0,
</a><a href="#h168-0-14" id="h168-0-14" class="d">-    var lastInteractionTimestamp: Long = 0,
</a><a href="#h168-0-15" id="h168-0-15" class="d">-    var displayTimestamp: Long = 0,
</a><a href="#h168-0-16" id="h168-0-16" class="d">-    var displayInteractionType: String? = null,
</a><a href="#h168-0-17" id="h168-0-17" class="d">-    var lastInteractionUserId: Int? = null,
</a><a href="#h168-0-18" id="h168-0-18" class="d">-    var key: String? = null,
</a><a href="#h168-0-19" id="h168-0-19" class="d">-    var friendUserId: String? = null,
</a><a href="#h168-0-20" id="h168-0-20" class="d">-    var friendDisplayName: String? = null,
</a><a href="#h168-0-21" id="h168-0-21" class="d">-    var friendDisplayUsername: String? = null,
</a><a href="#h168-0-22" id="h168-0-22" class="d">-    var friendLinkType: Int? = null,
</a><a href="#h168-0-23" id="h168-0-23" class="d">-    var bitmojiAvatarId: String? = null,
</a><a href="#h168-0-24" id="h168-0-24" class="d">-    var bitmojiSelfieId: String? = null,
</a><a href="#h168-0-25" id="h168-0-25" class="d">-) : DatabaseObject {
</a><a href="#h168-0-26" id="h168-0-26" class="d">-
</a><a href="#h168-0-27" id="h168-0-27" class="d">-    @SuppressLint(&quot;Range&quot;)
</a><a href="#h168-0-28" id="h168-0-28" class="d">-    override fun write(cursor: Cursor) {
</a><a href="#h168-0-29" id="h168-0-29" class="d">-        with(cursor) {
</a><a href="#h168-0-30" id="h168-0-30" class="d">-            id = getInteger(&quot;_id&quot;)
</a><a href="#h168-0-31" id="h168-0-31" class="d">-            feedDisplayName = getStringOrNull(&quot;feedDisplayName&quot;)
</a><a href="#h168-0-32" id="h168-0-32" class="d">-            participantsSize = getInteger(&quot;participantsSize&quot;)
</a><a href="#h168-0-33" id="h168-0-33" class="d">-            lastInteractionTimestamp = getLong(&quot;lastInteractionTimestamp&quot;)
</a><a href="#h168-0-34" id="h168-0-34" class="d">-            displayTimestamp = getLong(&quot;displayTimestamp&quot;)
</a><a href="#h168-0-35" id="h168-0-35" class="d">-            displayInteractionType = getStringOrNull(&quot;displayInteractionType&quot;)
</a><a href="#h168-0-36" id="h168-0-36" class="d">-            lastInteractionUserId = getIntOrNull(&quot;lastInteractionUserId&quot;)
</a><a href="#h168-0-37" id="h168-0-37" class="d">-            key = getStringOrNull(&quot;key&quot;)
</a><a href="#h168-0-38" id="h168-0-38" class="d">-            friendUserId = getStringOrNull(&quot;friendUserId&quot;)
</a><a href="#h168-0-39" id="h168-0-39" class="d">-            friendDisplayName = getStringOrNull(&quot;friendDisplayName&quot;)
</a><a href="#h168-0-40" id="h168-0-40" class="d">-            friendDisplayUsername = getStringOrNull(&quot;friendDisplayUsername&quot;)
</a><a href="#h168-0-41" id="h168-0-41" class="d">-            friendLinkType = getIntOrNull(&quot;friendLinkType&quot;)
</a><a href="#h168-0-42" id="h168-0-42" class="d">-            bitmojiAvatarId = getStringOrNull(&quot;bitmojiAvatarId&quot;)
</a><a href="#h168-0-43" id="h168-0-43" class="d">-            bitmojiSelfieId = getStringOrNull(&quot;bitmojiSelfieId&quot;)
</a><a href="#h168-0-44" id="h168-0-44" class="d">-        }
</a><a href="#h168-0-45" id="h168-0-45" class="d">-    }
</a><a href="#h168-0-46" id="h168-0-46" class="d">-}
</a><b>diff --git a/<a id="h169" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/database/objects/FriendInfo.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/database/objects/FriendInfo.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/database/objects/FriendInfo.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/database/objects/FriendInfo.kt</a></b>
<a href="#h169-0" id="h169-0" class="h">@@ -1,72 +0,0 @@
</a><a href="#h169-0-0" id="h169-0-0" class="d">-package me.rhunk.snapenhance.core.database.objects
</a><a href="#h169-0-1" id="h169-0-1" class="d">-
</a><a href="#h169-0-2" id="h169-0-2" class="d">-import android.annotation.SuppressLint
</a><a href="#h169-0-3" id="h169-0-3" class="d">-import android.database.Cursor
</a><a href="#h169-0-4" id="h169-0-4" class="d">-import me.rhunk.snapenhance.core.database.DatabaseObject
</a><a href="#h169-0-5" id="h169-0-5" class="d">-import me.rhunk.snapenhance.core.util.SerializableDataObject
</a><a href="#h169-0-6" id="h169-0-6" class="d">-import me.rhunk.snapenhance.core.util.ktx.getInteger
</a><a href="#h169-0-7" id="h169-0-7" class="d">-import me.rhunk.snapenhance.core.util.ktx.getLong
</a><a href="#h169-0-8" id="h169-0-8" class="d">-import me.rhunk.snapenhance.core.util.ktx.getStringOrNull
</a><a href="#h169-0-9" id="h169-0-9" class="d">-
</a><a href="#h169-0-10" id="h169-0-10" class="d">-data class FriendInfo(
</a><a href="#h169-0-11" id="h169-0-11" class="d">-    var id: Int = 0,
</a><a href="#h169-0-12" id="h169-0-12" class="d">-    var lastModifiedTimestamp: Long = 0,
</a><a href="#h169-0-13" id="h169-0-13" class="d">-    var username: String? = null,
</a><a href="#h169-0-14" id="h169-0-14" class="d">-    var userId: String? = null,
</a><a href="#h169-0-15" id="h169-0-15" class="d">-    var displayName: String? = null,
</a><a href="#h169-0-16" id="h169-0-16" class="d">-    var bitmojiAvatarId: String? = null,
</a><a href="#h169-0-17" id="h169-0-17" class="d">-    var bitmojiSelfieId: String? = null,
</a><a href="#h169-0-18" id="h169-0-18" class="d">-    var bitmojiSceneId: String? = null,
</a><a href="#h169-0-19" id="h169-0-19" class="d">-    var bitmojiBackgroundId: String? = null,
</a><a href="#h169-0-20" id="h169-0-20" class="d">-    var friendmojis: String? = null,
</a><a href="#h169-0-21" id="h169-0-21" class="d">-    var friendmojiCategories: String? = null,
</a><a href="#h169-0-22" id="h169-0-22" class="d">-    var snapScore: Int = 0,
</a><a href="#h169-0-23" id="h169-0-23" class="d">-    var birthday: Long = 0,
</a><a href="#h169-0-24" id="h169-0-24" class="d">-    var addedTimestamp: Long = 0,
</a><a href="#h169-0-25" id="h169-0-25" class="d">-    var reverseAddedTimestamp: Long = 0,
</a><a href="#h169-0-26" id="h169-0-26" class="d">-    var serverDisplayName: String? = null,
</a><a href="#h169-0-27" id="h169-0-27" class="d">-    var streakLength: Int = 0,
</a><a href="#h169-0-28" id="h169-0-28" class="d">-    var streakExpirationTimestamp: Long = 0,
</a><a href="#h169-0-29" id="h169-0-29" class="d">-    var reverseBestFriendRanking: Int = 0,
</a><a href="#h169-0-30" id="h169-0-30" class="d">-    var isPinnedBestFriend: Int = 0,
</a><a href="#h169-0-31" id="h169-0-31" class="d">-    var plusBadgeVisibility: Int = 0,
</a><a href="#h169-0-32" id="h169-0-32" class="d">-    var usernameForSorting: String? = null,
</a><a href="#h169-0-33" id="h169-0-33" class="d">-    var friendLinkType: Int = 0,
</a><a href="#h169-0-34" id="h169-0-34" class="d">-    var postViewEmoji: String? = null,
</a><a href="#h169-0-35" id="h169-0-35" class="d">-) : DatabaseObject, SerializableDataObject() {
</a><a href="#h169-0-36" id="h169-0-36" class="d">-    val mutableUsername get() = username?.split(&quot;|&quot;)?.last()
</a><a href="#h169-0-37" id="h169-0-37" class="d">-    val firstCreatedUsername get() = username?.split(&quot;|&quot;)?.first()
</a><a href="#h169-0-38" id="h169-0-38" class="d">-
</a><a href="#h169-0-39" id="h169-0-39" class="d">-    @SuppressLint(&quot;Range&quot;)
</a><a href="#h169-0-40" id="h169-0-40" class="d">-    override fun write(cursor: Cursor) {
</a><a href="#h169-0-41" id="h169-0-41" class="d">-        with(cursor) {
</a><a href="#h169-0-42" id="h169-0-42" class="d">-            id = getInteger(&quot;_id&quot;)
</a><a href="#h169-0-43" id="h169-0-43" class="d">-            lastModifiedTimestamp = getLong(&quot;_lastModifiedTimestamp&quot;)
</a><a href="#h169-0-44" id="h169-0-44" class="d">-            username = getStringOrNull(&quot;username&quot;)
</a><a href="#h169-0-45" id="h169-0-45" class="d">-            userId = getStringOrNull(&quot;userId&quot;)
</a><a href="#h169-0-46" id="h169-0-46" class="d">-            displayName = getStringOrNull(&quot;displayName&quot;)
</a><a href="#h169-0-47" id="h169-0-47" class="d">-            bitmojiAvatarId = getStringOrNull(&quot;bitmojiAvatarId&quot;)
</a><a href="#h169-0-48" id="h169-0-48" class="d">-            bitmojiSelfieId = getStringOrNull(&quot;bitmojiSelfieId&quot;)
</a><a href="#h169-0-49" id="h169-0-49" class="d">-            bitmojiSceneId = getStringOrNull(&quot;bitmojiSceneId&quot;)
</a><a href="#h169-0-50" id="h169-0-50" class="d">-            bitmojiBackgroundId = getStringOrNull(&quot;bitmojiBackgroundId&quot;)
</a><a href="#h169-0-51" id="h169-0-51" class="d">-            friendmojis = getStringOrNull(&quot;friendmojis&quot;)
</a><a href="#h169-0-52" id="h169-0-52" class="d">-            friendmojiCategories = getStringOrNull(&quot;friendmojiCategories&quot;)
</a><a href="#h169-0-53" id="h169-0-53" class="d">-            snapScore = getInteger(&quot;score&quot;)
</a><a href="#h169-0-54" id="h169-0-54" class="d">-            birthday = getLong(&quot;birthday&quot;)
</a><a href="#h169-0-55" id="h169-0-55" class="d">-            addedTimestamp = getLong(&quot;addedTimestamp&quot;)
</a><a href="#h169-0-56" id="h169-0-56" class="d">-            reverseAddedTimestamp = getLong(&quot;reverseAddedTimestamp&quot;)
</a><a href="#h169-0-57" id="h169-0-57" class="d">-            serverDisplayName = getStringOrNull(&quot;serverDisplayName&quot;)
</a><a href="#h169-0-58" id="h169-0-58" class="d">-            streakLength = getInteger(&quot;streakLength&quot;)
</a><a href="#h169-0-59" id="h169-0-59" class="d">-            streakExpirationTimestamp = getLong(&quot;streakExpiration&quot;)
</a><a href="#h169-0-60" id="h169-0-60" class="d">-            reverseBestFriendRanking = getInteger(&quot;reverseBestFriendRanking&quot;)
</a><a href="#h169-0-61" id="h169-0-61" class="d">-            usernameForSorting = getStringOrNull(&quot;usernameForSorting&quot;)
</a><a href="#h169-0-62" id="h169-0-62" class="d">-            friendLinkType = getInteger(&quot;friendLinkType&quot;)
</a><a href="#h169-0-63" id="h169-0-63" class="d">-            postViewEmoji = getStringOrNull(&quot;postViewEmoji&quot;)
</a><a href="#h169-0-64" id="h169-0-64" class="d">-            if (getColumnIndex(&quot;isPinnedBestFriend&quot;) != -1) isPinnedBestFriend =
</a><a href="#h169-0-65" id="h169-0-65" class="d">-                getInteger(&quot;isPinnedBestFriend&quot;)
</a><a href="#h169-0-66" id="h169-0-66" class="d">-            if (getColumnIndex(&quot;plusBadgeVisibility&quot;) != -1) plusBadgeVisibility =
</a><a href="#h169-0-67" id="h169-0-67" class="d">-                getInteger(&quot;plusBadgeVisibility&quot;)
</a><a href="#h169-0-68" id="h169-0-68" class="d">-        }
</a><a href="#h169-0-69" id="h169-0-69" class="d">-    }
</a><a href="#h169-0-70" id="h169-0-70" class="d">-
</a><a href="#h169-0-71" id="h169-0-71" class="d">-}
</a><b>diff --git a/<a id="h170" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/database/objects/StoryEntry.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/database/objects/StoryEntry.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/database/objects/StoryEntry.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/database/objects/StoryEntry.kt</a></b>
<a href="#h170-0" id="h170-0" class="h">@@ -1,27 +0,0 @@
</a><a href="#h170-0-0" id="h170-0-0" class="d">-package me.rhunk.snapenhance.core.database.objects
</a><a href="#h170-0-1" id="h170-0-1" class="d">-
</a><a href="#h170-0-2" id="h170-0-2" class="d">-import android.annotation.SuppressLint
</a><a href="#h170-0-3" id="h170-0-3" class="d">-import android.database.Cursor
</a><a href="#h170-0-4" id="h170-0-4" class="d">-import me.rhunk.snapenhance.core.database.DatabaseObject
</a><a href="#h170-0-5" id="h170-0-5" class="d">-import me.rhunk.snapenhance.core.util.ktx.getInteger
</a><a href="#h170-0-6" id="h170-0-6" class="d">-import me.rhunk.snapenhance.core.util.ktx.getStringOrNull
</a><a href="#h170-0-7" id="h170-0-7" class="d">-
</a><a href="#h170-0-8" id="h170-0-8" class="d">-data class StoryEntry(
</a><a href="#h170-0-9" id="h170-0-9" class="d">-    var id: Int = 0,
</a><a href="#h170-0-10" id="h170-0-10" class="d">-    var storyId: String? = null,
</a><a href="#h170-0-11" id="h170-0-11" class="d">-    var displayName: String? = null,
</a><a href="#h170-0-12" id="h170-0-12" class="d">-    var isLocal: Boolean? = null,
</a><a href="#h170-0-13" id="h170-0-13" class="d">-    var userId: String? = null
</a><a href="#h170-0-14" id="h170-0-14" class="d">-) : DatabaseObject {
</a><a href="#h170-0-15" id="h170-0-15" class="d">-
</a><a href="#h170-0-16" id="h170-0-16" class="d">-    @SuppressLint(&quot;Range&quot;)
</a><a href="#h170-0-17" id="h170-0-17" class="d">-    override fun write(cursor: Cursor) {
</a><a href="#h170-0-18" id="h170-0-18" class="d">-        with(cursor) {
</a><a href="#h170-0-19" id="h170-0-19" class="d">-            id = getInteger(&quot;_id&quot;)
</a><a href="#h170-0-20" id="h170-0-20" class="d">-            storyId = getStringOrNull(&quot;storyId&quot;)
</a><a href="#h170-0-21" id="h170-0-21" class="d">-            displayName = getStringOrNull(&quot;displayName&quot;)
</a><a href="#h170-0-22" id="h170-0-22" class="d">-            isLocal = getInteger(&quot;isLocal&quot;) == 1
</a><a href="#h170-0-23" id="h170-0-23" class="d">-            userId = getStringOrNull(&quot;userId&quot;)
</a><a href="#h170-0-24" id="h170-0-24" class="d">-        }
</a><a href="#h170-0-25" id="h170-0-25" class="d">-    }
</a><a href="#h170-0-26" id="h170-0-26" class="d">-}
</a><b>diff --git a/<a id="h171" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/database/objects/UserConversationLink.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/database/objects/UserConversationLink.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/database/objects/UserConversationLink.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/database/objects/UserConversationLink.kt</a></b>
<a href="#h171-0" id="h171-0" class="h">@@ -1,23 +0,0 @@
</a><a href="#h171-0-0" id="h171-0-0" class="d">-package me.rhunk.snapenhance.core.database.objects
</a><a href="#h171-0-1" id="h171-0-1" class="d">-
</a><a href="#h171-0-2" id="h171-0-2" class="d">-import android.annotation.SuppressLint
</a><a href="#h171-0-3" id="h171-0-3" class="d">-import android.database.Cursor
</a><a href="#h171-0-4" id="h171-0-4" class="d">-import me.rhunk.snapenhance.core.database.DatabaseObject
</a><a href="#h171-0-5" id="h171-0-5" class="d">-import me.rhunk.snapenhance.core.util.ktx.getInteger
</a><a href="#h171-0-6" id="h171-0-6" class="d">-import me.rhunk.snapenhance.core.util.ktx.getStringOrNull
</a><a href="#h171-0-7" id="h171-0-7" class="d">-
</a><a href="#h171-0-8" id="h171-0-8" class="d">-class UserConversationLink(
</a><a href="#h171-0-9" id="h171-0-9" class="d">-    var userId: String? = null,
</a><a href="#h171-0-10" id="h171-0-10" class="d">-    var clientConversationId: String? = null,
</a><a href="#h171-0-11" id="h171-0-11" class="d">-    var conversationType: Int = 0
</a><a href="#h171-0-12" id="h171-0-12" class="d">-) : DatabaseObject {
</a><a href="#h171-0-13" id="h171-0-13" class="d">-
</a><a href="#h171-0-14" id="h171-0-14" class="d">-    @SuppressLint(&quot;Range&quot;)
</a><a href="#h171-0-15" id="h171-0-15" class="d">-    override fun write(cursor: Cursor) {
</a><a href="#h171-0-16" id="h171-0-16" class="d">-        with(cursor) {
</a><a href="#h171-0-17" id="h171-0-17" class="d">-            userId = getStringOrNull(&quot;user_id&quot;)
</a><a href="#h171-0-18" id="h171-0-18" class="d">-            clientConversationId = getStringOrNull(&quot;client_conversation_id&quot;)
</a><a href="#h171-0-19" id="h171-0-19" class="d">-            conversationType = getInteger(&quot;conversation_type&quot;)
</a><a href="#h171-0-20" id="h171-0-20" class="d">-        }
</a><a href="#h171-0-21" id="h171-0-21" class="d">-    }
</a><a href="#h171-0-22" id="h171-0-22" class="d">-}
</a><b>diff --git a/<a id="h172" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/download/DownloadManagerClient.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/download/DownloadManagerClient.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/download/DownloadManagerClient.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/download/DownloadManagerClient.kt</a></b>
<a href="#h172-0" id="h172-0" class="h">@@ -1,80 +0,0 @@
</a><a href="#h172-0-0" id="h172-0-0" class="d">-package me.rhunk.snapenhance.core.download
</a><a href="#h172-0-1" id="h172-0-1" class="d">-
</a><a href="#h172-0-2" id="h172-0-2" class="d">-import android.content.Intent
</a><a href="#h172-0-3" id="h172-0-3" class="d">-import android.os.Bundle
</a><a href="#h172-0-4" id="h172-0-4" class="d">-import me.rhunk.snapenhance.ModContext
</a><a href="#h172-0-5" id="h172-0-5" class="d">-import me.rhunk.snapenhance.bridge.DownloadCallback
</a><a href="#h172-0-6" id="h172-0-6" class="d">-import me.rhunk.snapenhance.core.download.data.DashOptions
</a><a href="#h172-0-7" id="h172-0-7" class="d">-import me.rhunk.snapenhance.core.download.data.DownloadMediaType
</a><a href="#h172-0-8" id="h172-0-8" class="d">-import me.rhunk.snapenhance.core.download.data.DownloadMetadata
</a><a href="#h172-0-9" id="h172-0-9" class="d">-import me.rhunk.snapenhance.core.download.data.DownloadRequest
</a><a href="#h172-0-10" id="h172-0-10" class="d">-import me.rhunk.snapenhance.core.download.data.InputMedia
</a><a href="#h172-0-11" id="h172-0-11" class="d">-import me.rhunk.snapenhance.core.download.data.MediaEncryptionKeyPair
</a><a href="#h172-0-12" id="h172-0-12" class="d">-import me.rhunk.snapenhance.features.impl.downloader.decoder.AttachmentType
</a><a href="#h172-0-13" id="h172-0-13" class="d">-
</a><a href="#h172-0-14" id="h172-0-14" class="d">-class DownloadManagerClient (
</a><a href="#h172-0-15" id="h172-0-15" class="d">-    private val context: ModContext,
</a><a href="#h172-0-16" id="h172-0-16" class="d">-    private val metadata: DownloadMetadata,
</a><a href="#h172-0-17" id="h172-0-17" class="d">-    private val callback: DownloadCallback
</a><a href="#h172-0-18" id="h172-0-18" class="d">-) {
</a><a href="#h172-0-19" id="h172-0-19" class="d">-    companion object {
</a><a href="#h172-0-20" id="h172-0-20" class="d">-        const val DOWNLOAD_REQUEST_EXTRA = &quot;request&quot;
</a><a href="#h172-0-21" id="h172-0-21" class="d">-        const val DOWNLOAD_METADATA_EXTRA = &quot;metadata&quot;
</a><a href="#h172-0-22" id="h172-0-22" class="d">-    }
</a><a href="#h172-0-23" id="h172-0-23" class="d">-
</a><a href="#h172-0-24" id="h172-0-24" class="d">-    private fun enqueueDownloadRequest(request: DownloadRequest) {
</a><a href="#h172-0-25" id="h172-0-25" class="d">-        context.bridgeClient.enqueueDownload(Intent().apply {
</a><a href="#h172-0-26" id="h172-0-26" class="d">-            putExtras(Bundle().apply {
</a><a href="#h172-0-27" id="h172-0-27" class="d">-                putString(DOWNLOAD_REQUEST_EXTRA, context.gson.toJson(request))
</a><a href="#h172-0-28" id="h172-0-28" class="d">-                putString(DOWNLOAD_METADATA_EXTRA, context.gson.toJson(metadata))
</a><a href="#h172-0-29" id="h172-0-29" class="d">-            })
</a><a href="#h172-0-30" id="h172-0-30" class="d">-        }, callback)
</a><a href="#h172-0-31" id="h172-0-31" class="d">-    }
</a><a href="#h172-0-32" id="h172-0-32" class="d">-
</a><a href="#h172-0-33" id="h172-0-33" class="d">-    fun downloadDashMedia(playlistUrl: String, offsetTime: Long, duration: Long?) {
</a><a href="#h172-0-34" id="h172-0-34" class="d">-        enqueueDownloadRequest(
</a><a href="#h172-0-35" id="h172-0-35" class="d">-            DownloadRequest(
</a><a href="#h172-0-36" id="h172-0-36" class="d">-                inputMedias = arrayOf(
</a><a href="#h172-0-37" id="h172-0-37" class="d">-                    InputMedia(
</a><a href="#h172-0-38" id="h172-0-38" class="d">-                    content = playlistUrl,
</a><a href="#h172-0-39" id="h172-0-39" class="d">-                    type = DownloadMediaType.REMOTE_MEDIA
</a><a href="#h172-0-40" id="h172-0-40" class="d">-                )
</a><a href="#h172-0-41" id="h172-0-41" class="d">-                ),
</a><a href="#h172-0-42" id="h172-0-42" class="d">-                dashOptions = DashOptions(offsetTime, duration),
</a><a href="#h172-0-43" id="h172-0-43" class="d">-                flags = DownloadRequest.Flags.IS_DASH_PLAYLIST
</a><a href="#h172-0-44" id="h172-0-44" class="d">-            )
</a><a href="#h172-0-45" id="h172-0-45" class="d">-        )
</a><a href="#h172-0-46" id="h172-0-46" class="d">-    }
</a><a href="#h172-0-47" id="h172-0-47" class="d">-
</a><a href="#h172-0-48" id="h172-0-48" class="d">-    fun downloadSingleMedia(
</a><a href="#h172-0-49" id="h172-0-49" class="d">-        mediaData: String,
</a><a href="#h172-0-50" id="h172-0-50" class="d">-        mediaType: DownloadMediaType,
</a><a href="#h172-0-51" id="h172-0-51" class="d">-        encryption: MediaEncryptionKeyPair? = null,
</a><a href="#h172-0-52" id="h172-0-52" class="d">-        attachmentType: AttachmentType? = null
</a><a href="#h172-0-53" id="h172-0-53" class="d">-    ) {
</a><a href="#h172-0-54" id="h172-0-54" class="d">-        enqueueDownloadRequest(
</a><a href="#h172-0-55" id="h172-0-55" class="d">-            DownloadRequest(
</a><a href="#h172-0-56" id="h172-0-56" class="d">-                inputMedias = arrayOf(
</a><a href="#h172-0-57" id="h172-0-57" class="d">-                    InputMedia(
</a><a href="#h172-0-58" id="h172-0-58" class="d">-                        content = mediaData,
</a><a href="#h172-0-59" id="h172-0-59" class="d">-                        type = mediaType,
</a><a href="#h172-0-60" id="h172-0-60" class="d">-                        encryption = encryption,
</a><a href="#h172-0-61" id="h172-0-61" class="d">-                        attachmentType = attachmentType?.name
</a><a href="#h172-0-62" id="h172-0-62" class="d">-                    )
</a><a href="#h172-0-63" id="h172-0-63" class="d">-                )
</a><a href="#h172-0-64" id="h172-0-64" class="d">-            )
</a><a href="#h172-0-65" id="h172-0-65" class="d">-        )
</a><a href="#h172-0-66" id="h172-0-66" class="d">-    }
</a><a href="#h172-0-67" id="h172-0-67" class="d">-
</a><a href="#h172-0-68" id="h172-0-68" class="d">-    fun downloadMediaWithOverlay(
</a><a href="#h172-0-69" id="h172-0-69" class="d">-        original: InputMedia,
</a><a href="#h172-0-70" id="h172-0-70" class="d">-        overlay: InputMedia,
</a><a href="#h172-0-71" id="h172-0-71" class="d">-    ) {
</a><a href="#h172-0-72" id="h172-0-72" class="d">-        enqueueDownloadRequest(
</a><a href="#h172-0-73" id="h172-0-73" class="d">-            DownloadRequest(
</a><a href="#h172-0-74" id="h172-0-74" class="d">-                inputMedias = arrayOf(original, overlay),
</a><a href="#h172-0-75" id="h172-0-75" class="d">-                flags = DownloadRequest.Flags.MERGE_OVERLAY
</a><a href="#h172-0-76" id="h172-0-76" class="d">-            )
</a><a href="#h172-0-77" id="h172-0-77" class="d">-        )
</a><a href="#h172-0-78" id="h172-0-78" class="d">-    }
</a><a href="#h172-0-79" id="h172-0-79" class="d">-}</a><a href="#h172-0-80" id="h172-0-80" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h173" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/download/data/DownloadMediaType.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/download/data/DownloadMediaType.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/download/data/DownloadMediaType.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/download/data/DownloadMediaType.kt</a></b>
<a href="#h173-0" id="h173-0" class="h">@@ -1,22 +0,0 @@
</a><a href="#h173-0-0" id="h173-0-0" class="d">-package me.rhunk.snapenhance.core.download.data
</a><a href="#h173-0-1" id="h173-0-1" class="d">-
</a><a href="#h173-0-2" id="h173-0-2" class="d">-import android.net.Uri
</a><a href="#h173-0-3" id="h173-0-3" class="d">-
</a><a href="#h173-0-4" id="h173-0-4" class="d">-enum class DownloadMediaType {
</a><a href="#h173-0-5" id="h173-0-5" class="d">-    PROTO_MEDIA,
</a><a href="#h173-0-6" id="h173-0-6" class="d">-    DIRECT_MEDIA,
</a><a href="#h173-0-7" id="h173-0-7" class="d">-    REMOTE_MEDIA,
</a><a href="#h173-0-8" id="h173-0-8" class="d">-    LOCAL_MEDIA;
</a><a href="#h173-0-9" id="h173-0-9" class="d">-
</a><a href="#h173-0-10" id="h173-0-10" class="d">-    companion object {
</a><a href="#h173-0-11" id="h173-0-11" class="d">-        fun fromUri(uri: Uri): DownloadMediaType {
</a><a href="#h173-0-12" id="h173-0-12" class="d">-            return when (uri.scheme) {
</a><a href="#h173-0-13" id="h173-0-13" class="d">-                &quot;proto&quot; -&gt; PROTO_MEDIA
</a><a href="#h173-0-14" id="h173-0-14" class="d">-                &quot;direct&quot; -&gt; DIRECT_MEDIA
</a><a href="#h173-0-15" id="h173-0-15" class="d">-                &quot;http&quot;, &quot;https&quot; -&gt; REMOTE_MEDIA
</a><a href="#h173-0-16" id="h173-0-16" class="d">-                &quot;file&quot; -&gt; LOCAL_MEDIA
</a><a href="#h173-0-17" id="h173-0-17" class="d">-                else -&gt; throw IllegalArgumentException(&quot;Unknown uri scheme: ${uri.scheme}&quot;)
</a><a href="#h173-0-18" id="h173-0-18" class="d">-            }
</a><a href="#h173-0-19" id="h173-0-19" class="d">-        }
</a><a href="#h173-0-20" id="h173-0-20" class="d">-    }
</a><a href="#h173-0-21" id="h173-0-21" class="d">-}</a><a href="#h173-0-22" id="h173-0-22" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h174" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/download/data/DownloadMetadata.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/download/data/DownloadMetadata.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/download/data/DownloadMetadata.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/download/data/DownloadMetadata.kt</a></b>
<a href="#h174-0" id="h174-0" class="h">@@ -1,9 +0,0 @@
</a><a href="#h174-0-0" id="h174-0-0" class="d">-package me.rhunk.snapenhance.core.download.data
</a><a href="#h174-0-1" id="h174-0-1" class="d">-
</a><a href="#h174-0-2" id="h174-0-2" class="d">-data class DownloadMetadata(
</a><a href="#h174-0-3" id="h174-0-3" class="d">-    val mediaIdentifier: String?,
</a><a href="#h174-0-4" id="h174-0-4" class="d">-    val outputPath: String,
</a><a href="#h174-0-5" id="h174-0-5" class="d">-    val mediaAuthor: String?,
</a><a href="#h174-0-6" id="h174-0-6" class="d">-    val downloadSource: String,
</a><a href="#h174-0-7" id="h174-0-7" class="d">-    val iconUrl: String?
</a><a href="#h174-0-8" id="h174-0-8" class="d">-)</a><a href="#h174-0-9" id="h174-0-9" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h175" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/download/data/DownloadRequest.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/download/data/DownloadRequest.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/download/data/DownloadRequest.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/download/data/DownloadRequest.kt</a></b>
<a href="#h175-0" id="h175-0" class="h">@@ -1,28 +0,0 @@
</a><a href="#h175-0-0" id="h175-0-0" class="d">-package me.rhunk.snapenhance.core.download.data
</a><a href="#h175-0-1" id="h175-0-1" class="d">-
</a><a href="#h175-0-2" id="h175-0-2" class="d">-
</a><a href="#h175-0-3" id="h175-0-3" class="d">-data class DashOptions(val offsetTime: Long, val duration: Long?)
</a><a href="#h175-0-4" id="h175-0-4" class="d">-data class InputMedia(
</a><a href="#h175-0-5" id="h175-0-5" class="d">-    val content: String,
</a><a href="#h175-0-6" id="h175-0-6" class="d">-    val type: DownloadMediaType,
</a><a href="#h175-0-7" id="h175-0-7" class="d">-    val encryption: MediaEncryptionKeyPair? = null,
</a><a href="#h175-0-8" id="h175-0-8" class="d">-    val attachmentType: String? = null,
</a><a href="#h175-0-9" id="h175-0-9" class="d">-    val isOverlay: Boolean = false,
</a><a href="#h175-0-10" id="h175-0-10" class="d">-)
</a><a href="#h175-0-11" id="h175-0-11" class="d">-
</a><a href="#h175-0-12" id="h175-0-12" class="d">-class DownloadRequest(
</a><a href="#h175-0-13" id="h175-0-13" class="d">-    val inputMedias: Array&lt;InputMedia&gt;,
</a><a href="#h175-0-14" id="h175-0-14" class="d">-    val dashOptions: DashOptions? = null,
</a><a href="#h175-0-15" id="h175-0-15" class="d">-    private val flags: Int = 0,
</a><a href="#h175-0-16" id="h175-0-16" class="d">-) {
</a><a href="#h175-0-17" id="h175-0-17" class="d">-    object Flags {
</a><a href="#h175-0-18" id="h175-0-18" class="d">-        const val MERGE_OVERLAY = 1
</a><a href="#h175-0-19" id="h175-0-19" class="d">-        const val IS_DASH_PLAYLIST = 2
</a><a href="#h175-0-20" id="h175-0-20" class="d">-    }
</a><a href="#h175-0-21" id="h175-0-21" class="d">-
</a><a href="#h175-0-22" id="h175-0-22" class="d">-    val isDashPlaylist: Boolean
</a><a href="#h175-0-23" id="h175-0-23" class="d">-        get() = flags and Flags.IS_DASH_PLAYLIST != 0
</a><a href="#h175-0-24" id="h175-0-24" class="d">-
</a><a href="#h175-0-25" id="h175-0-25" class="d">-    val shouldMergeOverlay: Boolean
</a><a href="#h175-0-26" id="h175-0-26" class="d">-        get() = flags and Flags.MERGE_OVERLAY != 0
</a><a href="#h175-0-27" id="h175-0-27" class="d">-}</a><a href="#h175-0-28" id="h175-0-28" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h176" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/download/data/DownloadStage.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/download/data/DownloadStage.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/download/data/DownloadStage.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/download/data/DownloadStage.kt</a></b>
<a href="#h176-0" id="h176-0" class="h">@@ -1,14 +0,0 @@
</a><a href="#h176-0-0" id="h176-0-0" class="d">-package me.rhunk.snapenhance.core.download.data
</a><a href="#h176-0-1" id="h176-0-1" class="d">-
</a><a href="#h176-0-2" id="h176-0-2" class="d">-enum class DownloadStage(
</a><a href="#h176-0-3" id="h176-0-3" class="d">-    val isFinalStage: Boolean = false,
</a><a href="#h176-0-4" id="h176-0-4" class="d">-) {
</a><a href="#h176-0-5" id="h176-0-5" class="d">-    PENDING(false),
</a><a href="#h176-0-6" id="h176-0-6" class="d">-    DOWNLOADING(false),
</a><a href="#h176-0-7" id="h176-0-7" class="d">-    MERGING(false),
</a><a href="#h176-0-8" id="h176-0-8" class="d">-    DOWNLOADED(true),
</a><a href="#h176-0-9" id="h176-0-9" class="d">-    SAVED(true),
</a><a href="#h176-0-10" id="h176-0-10" class="d">-    MERGE_FAILED(true),
</a><a href="#h176-0-11" id="h176-0-11" class="d">-    FAILED(true),
</a><a href="#h176-0-12" id="h176-0-12" class="d">-    CANCELLED(true)
</a><a href="#h176-0-13" id="h176-0-13" class="d">-}</a><a href="#h176-0-14" id="h176-0-14" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h177" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/download/data/MediaDownloadSource.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/download/data/MediaDownloadSource.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/download/data/MediaDownloadSource.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/download/data/MediaDownloadSource.kt</a></b>
<a href="#h177-0" id="h177-0" class="h">@@ -1,28 +0,0 @@
</a><a href="#h177-0-0" id="h177-0-0" class="d">-package me.rhunk.snapenhance.core.download.data
</a><a href="#h177-0-1" id="h177-0-1" class="d">-
</a><a href="#h177-0-2" id="h177-0-2" class="d">-enum class MediaDownloadSource(
</a><a href="#h177-0-3" id="h177-0-3" class="d">-    val key: String,
</a><a href="#h177-0-4" id="h177-0-4" class="d">-    val displayName: String = key,
</a><a href="#h177-0-5" id="h177-0-5" class="d">-    val pathName: String = key,
</a><a href="#h177-0-6" id="h177-0-6" class="d">-    val ignoreFilter: Boolean = false
</a><a href="#h177-0-7" id="h177-0-7" class="d">-) {
</a><a href="#h177-0-8" id="h177-0-8" class="d">-    NONE(&quot;none&quot;, &quot;None&quot;, ignoreFilter = true),
</a><a href="#h177-0-9" id="h177-0-9" class="d">-    PENDING(&quot;pending&quot;, &quot;Pending&quot;, ignoreFilter = true),
</a><a href="#h177-0-10" id="h177-0-10" class="d">-    CHAT_MEDIA(&quot;chat_media&quot;, &quot;Chat Media&quot;, &quot;chat_media&quot;),
</a><a href="#h177-0-11" id="h177-0-11" class="d">-    STORY(&quot;story&quot;, &quot;Story&quot;, &quot;story&quot;),
</a><a href="#h177-0-12" id="h177-0-12" class="d">-    PUBLIC_STORY(&quot;public_story&quot;, &quot;Public Story&quot;, &quot;public_story&quot;),
</a><a href="#h177-0-13" id="h177-0-13" class="d">-    SPOTLIGHT(&quot;spotlight&quot;, &quot;Spotlight&quot;, &quot;spotlight&quot;),
</a><a href="#h177-0-14" id="h177-0-14" class="d">-    PROFILE_PICTURE(&quot;profile_picture&quot;, &quot;Profile Picture&quot;, &quot;profile_picture&quot;);
</a><a href="#h177-0-15" id="h177-0-15" class="d">-
</a><a href="#h177-0-16" id="h177-0-16" class="d">-    fun matches(source: String?): Boolean {
</a><a href="#h177-0-17" id="h177-0-17" class="d">-        if (source == null) return false
</a><a href="#h177-0-18" id="h177-0-18" class="d">-        return source.contains(key, ignoreCase = true)
</a><a href="#h177-0-19" id="h177-0-19" class="d">-    }
</a><a href="#h177-0-20" id="h177-0-20" class="d">-
</a><a href="#h177-0-21" id="h177-0-21" class="d">-    companion object {
</a><a href="#h177-0-22" id="h177-0-22" class="d">-        fun fromKey(key: String?): MediaDownloadSource {
</a><a href="#h177-0-23" id="h177-0-23" class="d">-            if (key == null) return NONE
</a><a href="#h177-0-24" id="h177-0-24" class="d">-            return entries.find { it.key == key } ?: NONE
</a><a href="#h177-0-25" id="h177-0-25" class="d">-        }
</a><a href="#h177-0-26" id="h177-0-26" class="d">-    }
</a><a href="#h177-0-27" id="h177-0-27" class="d">-}</a><a href="#h177-0-28" id="h177-0-28" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h178" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/download/data/MediaEncryptionKeyPair.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/download/data/MediaEncryptionKeyPair.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/download/data/MediaEncryptionKeyPair.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/download/data/MediaEncryptionKeyPair.kt</a></b>
<a href="#h178-0" id="h178-0" class="h">@@ -1,30 +0,0 @@
</a><a href="#h178-0-0" id="h178-0-0" class="d">-@file:OptIn(ExperimentalEncodingApi::class)
</a><a href="#h178-0-1" id="h178-0-1" class="d">-
</a><a href="#h178-0-2" id="h178-0-2" class="d">-package me.rhunk.snapenhance.core.download.data
</a><a href="#h178-0-3" id="h178-0-3" class="d">-
</a><a href="#h178-0-4" id="h178-0-4" class="d">-import me.rhunk.snapenhance.data.wrapper.impl.media.EncryptionWrapper
</a><a href="#h178-0-5" id="h178-0-5" class="d">-import java.io.InputStream
</a><a href="#h178-0-6" id="h178-0-6" class="d">-import javax.crypto.Cipher
</a><a href="#h178-0-7" id="h178-0-7" class="d">-import javax.crypto.CipherInputStream
</a><a href="#h178-0-8" id="h178-0-8" class="d">-import javax.crypto.spec.IvParameterSpec
</a><a href="#h178-0-9" id="h178-0-9" class="d">-import javax.crypto.spec.SecretKeySpec
</a><a href="#h178-0-10" id="h178-0-10" class="d">-import kotlin.io.encoding.Base64
</a><a href="#h178-0-11" id="h178-0-11" class="d">-import kotlin.io.encoding.ExperimentalEncodingApi
</a><a href="#h178-0-12" id="h178-0-12" class="d">-
</a><a href="#h178-0-13" id="h178-0-13" class="d">-// key and iv are base64 encoded into url safe strings
</a><a href="#h178-0-14" id="h178-0-14" class="d">-data class MediaEncryptionKeyPair(
</a><a href="#h178-0-15" id="h178-0-15" class="d">-    val key: String,
</a><a href="#h178-0-16" id="h178-0-16" class="d">-    val iv: String
</a><a href="#h178-0-17" id="h178-0-17" class="d">-) {
</a><a href="#h178-0-18" id="h178-0-18" class="d">-    fun decryptInputStream(inputStream: InputStream): InputStream {
</a><a href="#h178-0-19" id="h178-0-19" class="d">-        val cipher = Cipher.getInstance(&quot;AES/CBC/PKCS5Padding&quot;)
</a><a href="#h178-0-20" id="h178-0-20" class="d">-        cipher.init(Cipher.DECRYPT_MODE, SecretKeySpec(Base64.UrlSafe.decode(key), &quot;AES&quot;), IvParameterSpec(Base64.UrlSafe.decode(iv)))
</a><a href="#h178-0-21" id="h178-0-21" class="d">-        return CipherInputStream(inputStream, cipher)
</a><a href="#h178-0-22" id="h178-0-22" class="d">-    }
</a><a href="#h178-0-23" id="h178-0-23" class="d">-}
</a><a href="#h178-0-24" id="h178-0-24" class="d">-
</a><a href="#h178-0-25" id="h178-0-25" class="d">-fun Pair&lt;ByteArray, ByteArray&gt;.toKeyPair()
</a><a href="#h178-0-26" id="h178-0-26" class="d">-    = MediaEncryptionKeyPair(Base64.UrlSafe.encode(this.first), Base64.UrlSafe.encode(this.second))
</a><a href="#h178-0-27" id="h178-0-27" class="d">-
</a><a href="#h178-0-28" id="h178-0-28" class="d">-fun EncryptionWrapper.toKeyPair()
</a><a href="#h178-0-29" id="h178-0-29" class="d">-    = MediaEncryptionKeyPair(Base64.UrlSafe.encode(this.keySpec), Base64.UrlSafe.encode(this.ivKeyParameterSpec))</a><a href="#h178-0-30" id="h178-0-30" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h179" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/download/data/SplitMediaAssetType.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/download/data/SplitMediaAssetType.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/download/data/SplitMediaAssetType.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/download/data/SplitMediaAssetType.kt</a></b>
<a href="#h179-0" id="h179-0" class="h">@@ -1,5 +0,0 @@
</a><a href="#h179-0-0" id="h179-0-0" class="d">-package me.rhunk.snapenhance.core.download.data
</a><a href="#h179-0-1" id="h179-0-1" class="d">-
</a><a href="#h179-0-2" id="h179-0-2" class="d">-enum class SplitMediaAssetType {
</a><a href="#h179-0-3" id="h179-0-3" class="d">-    ORIGINAL, OVERLAY
</a><a href="#h179-0-4" id="h179-0-4" class="d">-}
</a><b>diff --git a/<a id="h180" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/event/EventBus.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/event/EventBus.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/event/EventBus.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/event/EventBus.kt</a></b>
<a href="#h180-0" id="h180-0" class="h">@@ -1,6 +1,6 @@
</a> package me.rhunk.snapenhance.core.event
 
<a href="#h180-0-2" id="h180-0-2" class="d">-import me.rhunk.snapenhance.ModContext
</a><a href="#h180-0-3" id="h180-0-3" class="i">+import me.rhunk.snapenhance.core.ModContext
</a> import kotlin.reflect.KClass
 
 abstract class Event {
<b>diff --git a/<a id="h181" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/event/EventDispatcher.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/event/EventDispatcher.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/event/EventDispatcher.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/event/EventDispatcher.kt</a></b>
<a href="#h181-0" id="h181-0" class="h">@@ -4,19 +4,19 @@ import android.content.Intent
</a> import android.view.View
 import android.view.ViewGroup
 import android.view.ViewGroup.LayoutParams
<a href="#h181-0-3" id="h181-0-3" class="d">-import me.rhunk.snapenhance.ModContext
</a><a href="#h181-0-4" id="h181-0-4" class="i">+import me.rhunk.snapenhance.common.util.snap.SnapWidgetBroadcastReceiverHelper
</a><a href="#h181-0-5" id="h181-0-5" class="i">+import me.rhunk.snapenhance.core.ModContext
</a> import me.rhunk.snapenhance.core.event.events.impl.*
<a href="#h181-0-7" id="h181-0-7" class="i">+import me.rhunk.snapenhance.core.manager.Manager
</a><a href="#h181-0-8" id="h181-0-8" class="i">+import me.rhunk.snapenhance.core.util.hook.HookStage
</a><a href="#h181-0-9" id="h181-0-9" class="i">+import me.rhunk.snapenhance.core.util.hook.hook
</a><a href="#h181-0-10" id="h181-0-10" class="i">+import me.rhunk.snapenhance.core.util.hook.hookConstructor
</a> import me.rhunk.snapenhance.core.util.ktx.getObjectField
 import me.rhunk.snapenhance.core.util.ktx.setObjectField
<a href="#h181-0-13" id="h181-0-13" class="d">-import me.rhunk.snapenhance.core.util.snap.SnapWidgetBroadcastReceiverHelper
</a><a href="#h181-0-14" id="h181-0-14" class="d">-import me.rhunk.snapenhance.data.wrapper.impl.Message
</a><a href="#h181-0-15" id="h181-0-15" class="d">-import me.rhunk.snapenhance.data.wrapper.impl.MessageContent
</a><a href="#h181-0-16" id="h181-0-16" class="d">-import me.rhunk.snapenhance.data.wrapper.impl.MessageDestinations
</a><a href="#h181-0-17" id="h181-0-17" class="d">-import me.rhunk.snapenhance.data.wrapper.impl.SnapUUID
</a><a href="#h181-0-18" id="h181-0-18" class="d">-import me.rhunk.snapenhance.hook.HookStage
</a><a href="#h181-0-19" id="h181-0-19" class="d">-import me.rhunk.snapenhance.hook.hook
</a><a href="#h181-0-20" id="h181-0-20" class="d">-import me.rhunk.snapenhance.hook.hookConstructor
</a><a href="#h181-0-21" id="h181-0-21" class="d">-import me.rhunk.snapenhance.manager.Manager
</a><a href="#h181-0-22" id="h181-0-22" class="i">+import me.rhunk.snapenhance.core.wrapper.impl.Message
</a><a href="#h181-0-23" id="h181-0-23" class="i">+import me.rhunk.snapenhance.core.wrapper.impl.MessageContent
</a><a href="#h181-0-24" id="h181-0-24" class="i">+import me.rhunk.snapenhance.core.wrapper.impl.MessageDestinations
</a><a href="#h181-0-25" id="h181-0-25" class="i">+import me.rhunk.snapenhance.core.wrapper.impl.SnapUUID
</a> 
 class EventDispatcher(
     private val context: ModContext
<a href="#h181-1" id="h181-1" class="h">@@ -96,7 +96,9 @@ class EventDispatcher(
</a>                     androidContext = context.androidContext,
                     intent = intent,
                     action = action
<a href="#h181-1-3" id="h181-1-3" class="d">-                )
</a><a href="#h181-1-4" id="h181-1-4" class="i">+                ).apply {
</a><a href="#h181-1-5" id="h181-1-5" class="i">+                    adapter = param
</a><a href="#h181-1-6" id="h181-1-6" class="i">+                }
</a>             ) {
                 postHookEvent()
             }
<b>diff --git a/<a id="h182" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/event/events/AbstractHookEvent.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/event/events/AbstractHookEvent.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/event/events/AbstractHookEvent.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/event/events/AbstractHookEvent.kt</a></b>
<a href="#h182-0" id="h182-0" class="h">@@ -1,7 +1,7 @@
</a> package me.rhunk.snapenhance.core.event.events
 
 import me.rhunk.snapenhance.core.event.Event
<a href="#h182-0-3" id="h182-0-3" class="d">-import me.rhunk.snapenhance.hook.HookAdapter
</a><a href="#h182-0-4" id="h182-0-4" class="i">+import me.rhunk.snapenhance.core.util.hook.HookAdapter
</a> 
 abstract class AbstractHookEvent : Event() {
     lateinit var adapter: HookAdapter
<b>diff --git a/<a id="h183" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/event/events/impl/BuildMessageEvent.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/event/events/impl/BuildMessageEvent.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/event/events/impl/BuildMessageEvent.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/event/events/impl/BuildMessageEvent.kt</a></b>
<a href="#h183-0" id="h183-0" class="h">@@ -1,7 +1,7 @@
</a> package me.rhunk.snapenhance.core.event.events.impl
 
 import me.rhunk.snapenhance.core.event.Event
<a href="#h183-0-3" id="h183-0-3" class="d">-import me.rhunk.snapenhance.data.wrapper.impl.Message
</a><a href="#h183-0-4" id="h183-0-4" class="i">+import me.rhunk.snapenhance.core.wrapper.impl.Message
</a> 
 class BuildMessageEvent(
     val message: Message
<b>diff --git a/<a id="h184" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/event/events/impl/OnSnapInteractionEvent.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/event/events/impl/OnSnapInteractionEvent.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/event/events/impl/OnSnapInteractionEvent.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/event/events/impl/OnSnapInteractionEvent.kt</a></b>
<a href="#h184-0" id="h184-0" class="h">@@ -1,7 +1,7 @@
</a> package me.rhunk.snapenhance.core.event.events.impl
 
 import me.rhunk.snapenhance.core.event.events.AbstractHookEvent
<a href="#h184-0-3" id="h184-0-3" class="d">-import me.rhunk.snapenhance.data.wrapper.impl.SnapUUID
</a><a href="#h184-0-4" id="h184-0-4" class="i">+import me.rhunk.snapenhance.core.wrapper.impl.SnapUUID
</a> 
 class OnSnapInteractionEvent(
     val interactionType: String,
<b>diff --git a/<a id="h185" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/event/events/impl/SendMessageWithContentEvent.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/event/events/impl/SendMessageWithContentEvent.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/event/events/impl/SendMessageWithContentEvent.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/event/events/impl/SendMessageWithContentEvent.kt</a></b>
<a href="#h185-0" id="h185-0" class="h">@@ -1,10 +1,10 @@
</a> package me.rhunk.snapenhance.core.event.events.impl
 
 import me.rhunk.snapenhance.core.event.events.AbstractHookEvent
<a href="#h185-0-3" id="h185-0-3" class="d">-import me.rhunk.snapenhance.data.wrapper.impl.MessageContent
</a><a href="#h185-0-4" id="h185-0-4" class="d">-import me.rhunk.snapenhance.data.wrapper.impl.MessageDestinations
</a><a href="#h185-0-5" id="h185-0-5" class="d">-import me.rhunk.snapenhance.hook.HookStage
</a><a href="#h185-0-6" id="h185-0-6" class="d">-import me.rhunk.snapenhance.hook.Hooker
</a><a href="#h185-0-7" id="h185-0-7" class="i">+import me.rhunk.snapenhance.core.util.hook.HookStage
</a><a href="#h185-0-8" id="h185-0-8" class="i">+import me.rhunk.snapenhance.core.util.hook.Hooker
</a><a href="#h185-0-9" id="h185-0-9" class="i">+import me.rhunk.snapenhance.core.wrapper.impl.MessageContent
</a><a href="#h185-0-10" id="h185-0-10" class="i">+import me.rhunk.snapenhance.core.wrapper.impl.MessageDestinations
</a> 
 class SendMessageWithContentEvent(
     val destinations: MessageDestinations,
<b>diff --git a/<a id="h186" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/BridgeFileFeature.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/BridgeFileFeature.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/BridgeFileFeature.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/BridgeFileFeature.kt</a></b>
<a href="#h186-0" id="h186-0" class="h">@@ -0,0 +1,54 @@
</a><a href="#h186-0-0" id="h186-0-0" class="i">+package me.rhunk.snapenhance.core.features
</a><a href="#h186-0-1" id="h186-0-1" class="i">+
</a><a href="#h186-0-2" id="h186-0-2" class="i">+import me.rhunk.snapenhance.common.bridge.types.BridgeFileType
</a><a href="#h186-0-3" id="h186-0-3" class="i">+import java.io.BufferedReader
</a><a href="#h186-0-4" id="h186-0-4" class="i">+import java.io.ByteArrayInputStream
</a><a href="#h186-0-5" id="h186-0-5" class="i">+import java.io.InputStreamReader
</a><a href="#h186-0-6" id="h186-0-6" class="i">+import java.nio.charset.StandardCharsets
</a><a href="#h186-0-7" id="h186-0-7" class="i">+
</a><a href="#h186-0-8" id="h186-0-8" class="i">+abstract class BridgeFileFeature(name: String, private val bridgeFileType: BridgeFileType, loadParams: Int) : Feature(name, loadParams) {
</a><a href="#h186-0-9" id="h186-0-9" class="i">+    private val fileLines = mutableListOf&lt;String&gt;()
</a><a href="#h186-0-10" id="h186-0-10" class="i">+
</a><a href="#h186-0-11" id="h186-0-11" class="i">+    protected fun readFile() {
</a><a href="#h186-0-12" id="h186-0-12" class="i">+        val temporaryLines = mutableListOf&lt;String&gt;()
</a><a href="#h186-0-13" id="h186-0-13" class="i">+        val fileData: ByteArray = context.bridgeClient.createAndReadFile(bridgeFileType, ByteArray(0))
</a><a href="#h186-0-14" id="h186-0-14" class="i">+        with(BufferedReader(InputStreamReader(ByteArrayInputStream(fileData), StandardCharsets.UTF_8))) {
</a><a href="#h186-0-15" id="h186-0-15" class="i">+            var line = &quot;&quot;
</a><a href="#h186-0-16" id="h186-0-16" class="i">+            while (readLine()?.also { line = it } != null) temporaryLines.add(line)
</a><a href="#h186-0-17" id="h186-0-17" class="i">+            close()
</a><a href="#h186-0-18" id="h186-0-18" class="i">+        }
</a><a href="#h186-0-19" id="h186-0-19" class="i">+        fileLines.clear()
</a><a href="#h186-0-20" id="h186-0-20" class="i">+        fileLines.addAll(temporaryLines)
</a><a href="#h186-0-21" id="h186-0-21" class="i">+    }
</a><a href="#h186-0-22" id="h186-0-22" class="i">+
</a><a href="#h186-0-23" id="h186-0-23" class="i">+    private fun updateFile() {
</a><a href="#h186-0-24" id="h186-0-24" class="i">+        val sb = StringBuilder()
</a><a href="#h186-0-25" id="h186-0-25" class="i">+        fileLines.forEach {
</a><a href="#h186-0-26" id="h186-0-26" class="i">+            sb.append(it).append(&quot;\n&quot;)
</a><a href="#h186-0-27" id="h186-0-27" class="i">+        }
</a><a href="#h186-0-28" id="h186-0-28" class="i">+        context.bridgeClient.writeFile(bridgeFileType, sb.toString().toByteArray(Charsets.UTF_8))
</a><a href="#h186-0-29" id="h186-0-29" class="i">+    }
</a><a href="#h186-0-30" id="h186-0-30" class="i">+
</a><a href="#h186-0-31" id="h186-0-31" class="i">+    protected fun exists(line: String) = fileLines.contains(line)
</a><a href="#h186-0-32" id="h186-0-32" class="i">+
</a><a href="#h186-0-33" id="h186-0-33" class="i">+    protected fun toggle(line: String) {
</a><a href="#h186-0-34" id="h186-0-34" class="i">+        if (exists(line)) fileLines.remove(line) else fileLines.add(line)
</a><a href="#h186-0-35" id="h186-0-35" class="i">+        updateFile()
</a><a href="#h186-0-36" id="h186-0-36" class="i">+    }
</a><a href="#h186-0-37" id="h186-0-37" class="i">+
</a><a href="#h186-0-38" id="h186-0-38" class="i">+    protected fun setState(line: String, state: Boolean) {
</a><a href="#h186-0-39" id="h186-0-39" class="i">+        if (state) {
</a><a href="#h186-0-40" id="h186-0-40" class="i">+            if (!exists(line)) fileLines.add(line)
</a><a href="#h186-0-41" id="h186-0-41" class="i">+        } else {
</a><a href="#h186-0-42" id="h186-0-42" class="i">+            if (exists(line)) fileLines.remove(line)
</a><a href="#h186-0-43" id="h186-0-43" class="i">+        }
</a><a href="#h186-0-44" id="h186-0-44" class="i">+        updateFile()
</a><a href="#h186-0-45" id="h186-0-45" class="i">+    }
</a><a href="#h186-0-46" id="h186-0-46" class="i">+
</a><a href="#h186-0-47" id="h186-0-47" class="i">+    protected fun reload() = readFile()
</a><a href="#h186-0-48" id="h186-0-48" class="i">+
</a><a href="#h186-0-49" id="h186-0-49" class="i">+    protected fun put(line: String) {
</a><a href="#h186-0-50" id="h186-0-50" class="i">+        fileLines.add(line)
</a><a href="#h186-0-51" id="h186-0-51" class="i">+        updateFile()
</a><a href="#h186-0-52" id="h186-0-52" class="i">+    }
</a><a href="#h186-0-53" id="h186-0-53" class="i">+}</a><a href="#h186-0-54" id="h186-0-54" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h187" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/Feature.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/Feature.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/Feature.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/Feature.kt</a></b>
<a href="#h187-0" id="h187-0" class="h">@@ -0,0 +1,39 @@
</a><a href="#h187-0-0" id="h187-0-0" class="i">+package me.rhunk.snapenhance.core.features
</a><a href="#h187-0-1" id="h187-0-1" class="i">+
</a><a href="#h187-0-2" id="h187-0-2" class="i">+import me.rhunk.snapenhance.core.ModContext
</a><a href="#h187-0-3" id="h187-0-3" class="i">+
</a><a href="#h187-0-4" id="h187-0-4" class="i">+abstract class Feature(
</a><a href="#h187-0-5" id="h187-0-5" class="i">+    val featureKey: String,
</a><a href="#h187-0-6" id="h187-0-6" class="i">+    val loadParams: Int = FeatureLoadParams.INIT_SYNC
</a><a href="#h187-0-7" id="h187-0-7" class="i">+) {
</a><a href="#h187-0-8" id="h187-0-8" class="i">+    lateinit var context: ModContext
</a><a href="#h187-0-9" id="h187-0-9" class="i">+
</a><a href="#h187-0-10" id="h187-0-10" class="i">+    /**
</a><a href="#h187-0-11" id="h187-0-11" class="i">+     * called on the main thread when the mod initialize
</a><a href="#h187-0-12" id="h187-0-12" class="i">+     */
</a><a href="#h187-0-13" id="h187-0-13" class="i">+    open fun init() {}
</a><a href="#h187-0-14" id="h187-0-14" class="i">+
</a><a href="#h187-0-15" id="h187-0-15" class="i">+    /**
</a><a href="#h187-0-16" id="h187-0-16" class="i">+     * called on a dedicated thread when the mod initialize
</a><a href="#h187-0-17" id="h187-0-17" class="i">+     */
</a><a href="#h187-0-18" id="h187-0-18" class="i">+    open fun asyncInit() {}
</a><a href="#h187-0-19" id="h187-0-19" class="i">+
</a><a href="#h187-0-20" id="h187-0-20" class="i">+    /**
</a><a href="#h187-0-21" id="h187-0-21" class="i">+     * called when the Snapchat Activity is created
</a><a href="#h187-0-22" id="h187-0-22" class="i">+     */
</a><a href="#h187-0-23" id="h187-0-23" class="i">+    open fun onActivityCreate() {}
</a><a href="#h187-0-24" id="h187-0-24" class="i">+
</a><a href="#h187-0-25" id="h187-0-25" class="i">+
</a><a href="#h187-0-26" id="h187-0-26" class="i">+    /**
</a><a href="#h187-0-27" id="h187-0-27" class="i">+     * called on a dedicated thread when the Snapchat Activity is created
</a><a href="#h187-0-28" id="h187-0-28" class="i">+     */
</a><a href="#h187-0-29" id="h187-0-29" class="i">+    open fun asyncOnActivityCreate() {}
</a><a href="#h187-0-30" id="h187-0-30" class="i">+
</a><a href="#h187-0-31" id="h187-0-31" class="i">+    protected fun findClass(name: String): Class&lt;*&gt; {
</a><a href="#h187-0-32" id="h187-0-32" class="i">+        return context.androidContext.classLoader.loadClass(name)
</a><a href="#h187-0-33" id="h187-0-33" class="i">+    }
</a><a href="#h187-0-34" id="h187-0-34" class="i">+
</a><a href="#h187-0-35" id="h187-0-35" class="i">+    protected fun runOnUiThread(block: () -&gt; Unit) {
</a><a href="#h187-0-36" id="h187-0-36" class="i">+        context.runOnUiThread(block)
</a><a href="#h187-0-37" id="h187-0-37" class="i">+    }
</a><a href="#h187-0-38" id="h187-0-38" class="i">+}</a><a href="#h187-0-39" id="h187-0-39" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h188" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/FeatureLoadParams.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/FeatureLoadParams.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/FeatureLoadParams.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/FeatureLoadParams.kt</a></b>
<a href="#h188-0" id="h188-0" class="h">@@ -0,0 +1,11 @@
</a><a href="#h188-0-0" id="h188-0-0" class="i">+package me.rhunk.snapenhance.core.features
</a><a href="#h188-0-1" id="h188-0-1" class="i">+
</a><a href="#h188-0-2" id="h188-0-2" class="i">+object FeatureLoadParams {
</a><a href="#h188-0-3" id="h188-0-3" class="i">+    const val NO_INIT = 0
</a><a href="#h188-0-4" id="h188-0-4" class="i">+
</a><a href="#h188-0-5" id="h188-0-5" class="i">+    const val INIT_SYNC = 0b0001
</a><a href="#h188-0-6" id="h188-0-6" class="i">+    const val ACTIVITY_CREATE_SYNC = 0b0010
</a><a href="#h188-0-7" id="h188-0-7" class="i">+
</a><a href="#h188-0-8" id="h188-0-8" class="i">+    const val INIT_ASYNC = 0b0100
</a><a href="#h188-0-9" id="h188-0-9" class="i">+    const val ACTIVITY_CREATE_ASYNC = 0b1000
</a><a href="#h188-0-10" id="h188-0-10" class="i">+}</a><a href="#h188-0-11" id="h188-0-11" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h189" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/MessagingRuleFeature.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/MessagingRuleFeature.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/MessagingRuleFeature.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/MessagingRuleFeature.kt</a></b>
<a href="#h189-0" id="h189-0" class="h">@@ -0,0 +1,30 @@
</a><a href="#h189-0-0" id="h189-0-0" class="i">+package me.rhunk.snapenhance.core.features
</a><a href="#h189-0-1" id="h189-0-1" class="i">+
</a><a href="#h189-0-2" id="h189-0-2" class="i">+import me.rhunk.snapenhance.common.data.MessagingRuleType
</a><a href="#h189-0-3" id="h189-0-3" class="i">+import me.rhunk.snapenhance.common.data.RuleState
</a><a href="#h189-0-4" id="h189-0-4" class="i">+
</a><a href="#h189-0-5" id="h189-0-5" class="i">+abstract class MessagingRuleFeature(name: String, val ruleType: MessagingRuleType, loadParams: Int = 0) : Feature(name, loadParams) {
</a><a href="#h189-0-6" id="h189-0-6" class="i">+
</a><a href="#h189-0-7" id="h189-0-7" class="i">+    open fun getRuleState() = context.config.rules.getRuleState(ruleType)
</a><a href="#h189-0-8" id="h189-0-8" class="i">+
</a><a href="#h189-0-9" id="h189-0-9" class="i">+    fun setState(conversationId: String, state: Boolean) {
</a><a href="#h189-0-10" id="h189-0-10" class="i">+        context.bridgeClient.setRule(
</a><a href="#h189-0-11" id="h189-0-11" class="i">+            context.database.getDMOtherParticipant(conversationId) ?: conversationId,
</a><a href="#h189-0-12" id="h189-0-12" class="i">+            ruleType,
</a><a href="#h189-0-13" id="h189-0-13" class="i">+            state
</a><a href="#h189-0-14" id="h189-0-14" class="i">+        )
</a><a href="#h189-0-15" id="h189-0-15" class="i">+    }
</a><a href="#h189-0-16" id="h189-0-16" class="i">+
</a><a href="#h189-0-17" id="h189-0-17" class="i">+    fun getState(conversationId: String) =
</a><a href="#h189-0-18" id="h189-0-18" class="i">+        context.bridgeClient.getRules(
</a><a href="#h189-0-19" id="h189-0-19" class="i">+            context.database.getDMOtherParticipant(conversationId) ?: conversationId
</a><a href="#h189-0-20" id="h189-0-20" class="i">+        ).contains(ruleType) &amp;&amp; getRuleState() != null
</a><a href="#h189-0-21" id="h189-0-21" class="i">+
</a><a href="#h189-0-22" id="h189-0-22" class="i">+    fun canUseRule(conversationId: String): Boolean {
</a><a href="#h189-0-23" id="h189-0-23" class="i">+        val state = getState(conversationId)
</a><a href="#h189-0-24" id="h189-0-24" class="i">+        if (context.config.rules.getRuleState(ruleType) == RuleState.BLACKLIST) {
</a><a href="#h189-0-25" id="h189-0-25" class="i">+            return !state
</a><a href="#h189-0-26" id="h189-0-26" class="i">+        }
</a><a href="#h189-0-27" id="h189-0-27" class="i">+        return state
</a><a href="#h189-0-28" id="h189-0-28" class="i">+    }
</a><a href="#h189-0-29" id="h189-0-29" class="i">+}</a><a href="#h189-0-30" id="h189-0-30" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h190" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ConfigurationOverride.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ConfigurationOverride.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ConfigurationOverride.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ConfigurationOverride.kt</a></b>
<a href="#h190-0" id="h190-0" class="h">@@ -0,0 +1,81 @@
</a><a href="#h190-0-0" id="h190-0-0" class="i">+package me.rhunk.snapenhance.core.features.impl
</a><a href="#h190-0-1" id="h190-0-1" class="i">+
</a><a href="#h190-0-2" id="h190-0-2" class="i">+import de.robv.android.xposed.XposedHelpers
</a><a href="#h190-0-3" id="h190-0-3" class="i">+import me.rhunk.snapenhance.core.features.Feature
</a><a href="#h190-0-4" id="h190-0-4" class="i">+import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a><a href="#h190-0-5" id="h190-0-5" class="i">+import me.rhunk.snapenhance.core.util.hook.HookStage
</a><a href="#h190-0-6" id="h190-0-6" class="i">+import me.rhunk.snapenhance.core.util.hook.hook
</a><a href="#h190-0-7" id="h190-0-7" class="i">+import me.rhunk.snapenhance.core.util.ktx.setObjectField
</a><a href="#h190-0-8" id="h190-0-8" class="i">+
</a><a href="#h190-0-9" id="h190-0-9" class="i">+class ConfigurationOverride : Feature(&quot;Configuration Override&quot;, loadParams = FeatureLoadParams.INIT_SYNC) {
</a><a href="#h190-0-10" id="h190-0-10" class="i">+    override fun init() {
</a><a href="#h190-0-11" id="h190-0-11" class="i">+        val propertyOverrides = mutableMapOf&lt;String, Pair&lt;(() -&gt; Boolean), Any&gt;&gt;()
</a><a href="#h190-0-12" id="h190-0-12" class="i">+
</a><a href="#h190-0-13" id="h190-0-13" class="i">+        fun overrideProperty(key: String, filter: () -&gt; Boolean, value: Any) {
</a><a href="#h190-0-14" id="h190-0-14" class="i">+            propertyOverrides[key] = Pair(filter, value)
</a><a href="#h190-0-15" id="h190-0-15" class="i">+        }
</a><a href="#h190-0-16" id="h190-0-16" class="i">+
</a><a href="#h190-0-17" id="h190-0-17" class="i">+        overrideProperty(&quot;STREAK_EXPIRATION_INFO&quot;, { context.config.userInterface.streakExpirationInfo.get() }, true)
</a><a href="#h190-0-18" id="h190-0-18" class="i">+
</a><a href="#h190-0-19" id="h190-0-19" class="i">+        overrideProperty(&quot;MEDIA_RECORDER_MAX_QUALITY_LEVEL&quot;, { context.config.camera.forceCameraSourceEncoding.get() }, true)
</a><a href="#h190-0-20" id="h190-0-20" class="i">+        overrideProperty(&quot;REDUCE_MY_PROFILE_UI_COMPLEXITY&quot;, { context.config.userInterface.mapFriendNameTags.get() }, true)
</a><a href="#h190-0-21" id="h190-0-21" class="i">+        overrideProperty(&quot;ENABLE_LONG_SNAP_SENDING&quot;, { context.config.global.disableSnapSplitting.get() }, true)
</a><a href="#h190-0-22" id="h190-0-22" class="i">+
</a><a href="#h190-0-23" id="h190-0-23" class="i">+        context.config.userInterface.storyViewerOverride.getNullable()?.let { state -&gt;
</a><a href="#h190-0-24" id="h190-0-24" class="i">+            overrideProperty(&quot;DF_ENABLE_SHOWS_PAGE_CONTROLS&quot;, { state == &quot;DISCOVER_PLAYBACK_SEEKBAR&quot; }, true)
</a><a href="#h190-0-25" id="h190-0-25" class="i">+            overrideProperty(&quot;DF_VOPERA_FOR_STORIES&quot;, { state == &quot;VERTICAL_STORY_VIEWER&quot; }, true)
</a><a href="#h190-0-26" id="h190-0-26" class="i">+        }
</a><a href="#h190-0-27" id="h190-0-27" class="i">+
</a><a href="#h190-0-28" id="h190-0-28" class="i">+        overrideProperty(&quot;SPOTLIGHT_5TH_TAB_ENABLED&quot;, { context.config.userInterface.disableSpotlight.get() }, false)
</a><a href="#h190-0-29" id="h190-0-29" class="i">+
</a><a href="#h190-0-30" id="h190-0-30" class="i">+        overrideProperty(&quot;BYPASS_AD_FEATURE_GATE&quot;, { context.config.global.blockAds.get() }, true)
</a><a href="#h190-0-31" id="h190-0-31" class="i">+        arrayOf(&quot;CUSTOM_AD_TRACKER_URL&quot;, &quot;CUSTOM_AD_INIT_SERVER_URL&quot;, &quot;CUSTOM_AD_SERVER_URL&quot;).forEach {
</a><a href="#h190-0-32" id="h190-0-32" class="i">+            overrideProperty(it, { context.config.global.blockAds.get() }, &quot;http://127.0.0.1&quot;)
</a><a href="#h190-0-33" id="h190-0-33" class="i">+        }
</a><a href="#h190-0-34" id="h190-0-34" class="i">+
</a><a href="#h190-0-35" id="h190-0-35" class="i">+        val compositeConfigurationProviderMappings = context.mappings.getMappedMap(&quot;CompositeConfigurationProvider&quot;)
</a><a href="#h190-0-36" id="h190-0-36" class="i">+        val enumMappings = compositeConfigurationProviderMappings[&quot;enum&quot;] as Map&lt;*, *&gt;
</a><a href="#h190-0-37" id="h190-0-37" class="i">+
</a><a href="#h190-0-38" id="h190-0-38" class="i">+        findClass(compositeConfigurationProviderMappings[&quot;class&quot;].toString()).hook(
</a><a href="#h190-0-39" id="h190-0-39" class="i">+            compositeConfigurationProviderMappings[&quot;observeProperty&quot;].toString(),
</a><a href="#h190-0-40" id="h190-0-40" class="i">+            HookStage.BEFORE
</a><a href="#h190-0-41" id="h190-0-41" class="i">+        ) { param -&gt;
</a><a href="#h190-0-42" id="h190-0-42" class="i">+            val enumData = param.arg&lt;Any&gt;(0)
</a><a href="#h190-0-43" id="h190-0-43" class="i">+            val key = enumData.toString()
</a><a href="#h190-0-44" id="h190-0-44" class="i">+            val setValue: (Any?) -&gt; Unit = { value -&gt;
</a><a href="#h190-0-45" id="h190-0-45" class="i">+                val valueHolder = XposedHelpers.callMethod(enumData, enumMappings[&quot;getValue&quot;].toString())
</a><a href="#h190-0-46" id="h190-0-46" class="i">+                valueHolder.setObjectField(enumMappings[&quot;defaultValueField&quot;].toString(), value)
</a><a href="#h190-0-47" id="h190-0-47" class="i">+            }
</a><a href="#h190-0-48" id="h190-0-48" class="i">+
</a><a href="#h190-0-49" id="h190-0-49" class="i">+            propertyOverrides[key]?.let { (filter, value) -&gt;
</a><a href="#h190-0-50" id="h190-0-50" class="i">+                if (!filter()) return@let
</a><a href="#h190-0-51" id="h190-0-51" class="i">+                setValue(value)
</a><a href="#h190-0-52" id="h190-0-52" class="i">+            }
</a><a href="#h190-0-53" id="h190-0-53" class="i">+        }
</a><a href="#h190-0-54" id="h190-0-54" class="i">+
</a><a href="#h190-0-55" id="h190-0-55" class="i">+        findClass(compositeConfigurationProviderMappings[&quot;class&quot;].toString()).hook(
</a><a href="#h190-0-56" id="h190-0-56" class="i">+            compositeConfigurationProviderMappings[&quot;getProperty&quot;].toString(),
</a><a href="#h190-0-57" id="h190-0-57" class="i">+            HookStage.AFTER
</a><a href="#h190-0-58" id="h190-0-58" class="i">+        ) { param -&gt;
</a><a href="#h190-0-59" id="h190-0-59" class="i">+            val propertyKey = param.arg&lt;Any&gt;(0).toString()
</a><a href="#h190-0-60" id="h190-0-60" class="i">+
</a><a href="#h190-0-61" id="h190-0-61" class="i">+            propertyOverrides[propertyKey]?.let { (filter, value) -&gt;
</a><a href="#h190-0-62" id="h190-0-62" class="i">+                if (!filter()) return@let
</a><a href="#h190-0-63" id="h190-0-63" class="i">+                param.setResult(value)
</a><a href="#h190-0-64" id="h190-0-64" class="i">+            }
</a><a href="#h190-0-65" id="h190-0-65" class="i">+        }
</a><a href="#h190-0-66" id="h190-0-66" class="i">+
</a><a href="#h190-0-67" id="h190-0-67" class="i">+        arrayOf(&quot;getBoolean&quot;, &quot;getInt&quot;, &quot;getLong&quot;, &quot;getFloat&quot;, &quot;getString&quot;).forEach { methodName -&gt;
</a><a href="#h190-0-68" id="h190-0-68" class="i">+            findClass(&quot;android.app.SharedPreferencesImpl&quot;).hook(
</a><a href="#h190-0-69" id="h190-0-69" class="i">+                methodName,
</a><a href="#h190-0-70" id="h190-0-70" class="i">+                HookStage.BEFORE
</a><a href="#h190-0-71" id="h190-0-71" class="i">+            ) { param -&gt;
</a><a href="#h190-0-72" id="h190-0-72" class="i">+                val key = param.argNullable&lt;Any&gt;(0).toString()
</a><a href="#h190-0-73" id="h190-0-73" class="i">+                propertyOverrides[key]?.let { (filter, value) -&gt;
</a><a href="#h190-0-74" id="h190-0-74" class="i">+                    if (!filter()) return@let
</a><a href="#h190-0-75" id="h190-0-75" class="i">+                    param.setResult(value)
</a><a href="#h190-0-76" id="h190-0-76" class="i">+                }
</a><a href="#h190-0-77" id="h190-0-77" class="i">+            }
</a><a href="#h190-0-78" id="h190-0-78" class="i">+        }
</a><a href="#h190-0-79" id="h190-0-79" class="i">+    }
</a><a href="#h190-0-80" id="h190-0-80" class="i">+}</a><a href="#h190-0-81" id="h190-0-81" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h191" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ScopeSync.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ScopeSync.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ScopeSync.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ScopeSync.kt</a></b>
<a href="#h191-0" id="h191-0" class="h">@@ -0,0 +1,43 @@
</a><a href="#h191-0-0" id="h191-0-0" class="i">+package me.rhunk.snapenhance.core.features.impl
</a><a href="#h191-0-1" id="h191-0-1" class="i">+
</a><a href="#h191-0-2" id="h191-0-2" class="i">+import kotlinx.coroutines.Job
</a><a href="#h191-0-3" id="h191-0-3" class="i">+import kotlinx.coroutines.delay
</a><a href="#h191-0-4" id="h191-0-4" class="i">+import kotlinx.coroutines.launch
</a><a href="#h191-0-5" id="h191-0-5" class="i">+import me.rhunk.snapenhance.common.data.ContentType
</a><a href="#h191-0-6" id="h191-0-6" class="i">+import me.rhunk.snapenhance.common.data.SocialScope
</a><a href="#h191-0-7" id="h191-0-7" class="i">+import me.rhunk.snapenhance.core.event.events.impl.SendMessageWithContentEvent
</a><a href="#h191-0-8" id="h191-0-8" class="i">+import me.rhunk.snapenhance.core.features.Feature
</a><a href="#h191-0-9" id="h191-0-9" class="i">+import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a><a href="#h191-0-10" id="h191-0-10" class="i">+
</a><a href="#h191-0-11" id="h191-0-11" class="i">+class ScopeSync : Feature(&quot;Scope Sync&quot;, loadParams = FeatureLoadParams.INIT_SYNC) {
</a><a href="#h191-0-12" id="h191-0-12" class="i">+    companion object {
</a><a href="#h191-0-13" id="h191-0-13" class="i">+        private const val DELAY_BEFORE_SYNC = 2000L
</a><a href="#h191-0-14" id="h191-0-14" class="i">+    }
</a><a href="#h191-0-15" id="h191-0-15" class="i">+
</a><a href="#h191-0-16" id="h191-0-16" class="i">+    private val updateJobs = mutableMapOf&lt;String, Job&gt;()
</a><a href="#h191-0-17" id="h191-0-17" class="i">+
</a><a href="#h191-0-18" id="h191-0-18" class="i">+    private fun sync(conversationId: String) {
</a><a href="#h191-0-19" id="h191-0-19" class="i">+        context.database.getDMOtherParticipant(conversationId)?.also { participant -&gt;
</a><a href="#h191-0-20" id="h191-0-20" class="i">+            context.bridgeClient.triggerSync(SocialScope.FRIEND, participant)
</a><a href="#h191-0-21" id="h191-0-21" class="i">+        } ?: run {
</a><a href="#h191-0-22" id="h191-0-22" class="i">+            context.bridgeClient.triggerSync(SocialScope.GROUP, conversationId)
</a><a href="#h191-0-23" id="h191-0-23" class="i">+        }
</a><a href="#h191-0-24" id="h191-0-24" class="i">+    }
</a><a href="#h191-0-25" id="h191-0-25" class="i">+
</a><a href="#h191-0-26" id="h191-0-26" class="i">+    override fun init() {
</a><a href="#h191-0-27" id="h191-0-27" class="i">+        context.event.subscribe(SendMessageWithContentEvent::class) { event -&gt;
</a><a href="#h191-0-28" id="h191-0-28" class="i">+            if (event.messageContent.contentType != ContentType.SNAP) return@subscribe
</a><a href="#h191-0-29" id="h191-0-29" class="i">+
</a><a href="#h191-0-30" id="h191-0-30" class="i">+            event.addCallbackResult(&quot;onSuccess&quot;) {
</a><a href="#h191-0-31" id="h191-0-31" class="i">+                event.destinations.conversations.map { it.toString() }.forEach { conversationId -&gt;
</a><a href="#h191-0-32" id="h191-0-32" class="i">+                    updateJobs[conversationId]?.also { it.cancel() }
</a><a href="#h191-0-33" id="h191-0-33" class="i">+
</a><a href="#h191-0-34" id="h191-0-34" class="i">+                    updateJobs[conversationId] = (context.coroutineScope.launch {
</a><a href="#h191-0-35" id="h191-0-35" class="i">+                        delay(DELAY_BEFORE_SYNC)
</a><a href="#h191-0-36" id="h191-0-36" class="i">+                        sync(conversationId)
</a><a href="#h191-0-37" id="h191-0-37" class="i">+                    })
</a><a href="#h191-0-38" id="h191-0-38" class="i">+                }
</a><a href="#h191-0-39" id="h191-0-39" class="i">+            }
</a><a href="#h191-0-40" id="h191-0-40" class="i">+        }
</a><a href="#h191-0-41" id="h191-0-41" class="i">+    }
</a><a href="#h191-0-42" id="h191-0-42" class="i">+}</a><a href="#h191-0-43" id="h191-0-43" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h192" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/downloader/MediaDownloader.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/downloader/MediaDownloader.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/downloader/MediaDownloader.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/downloader/MediaDownloader.kt</a></b>
<a href="#h192-0" id="h192-0" class="h">@@ -0,0 +1,719 @@
</a><a href="#h192-0-0" id="h192-0-0" class="i">+package me.rhunk.snapenhance.core.features.impl.downloader
</a><a href="#h192-0-1" id="h192-0-1" class="i">+
</a><a href="#h192-0-2" id="h192-0-2" class="i">+import android.annotation.SuppressLint
</a><a href="#h192-0-3" id="h192-0-3" class="i">+import android.graphics.Bitmap
</a><a href="#h192-0-4" id="h192-0-4" class="i">+import android.graphics.BitmapFactory
</a><a href="#h192-0-5" id="h192-0-5" class="i">+import android.net.Uri
</a><a href="#h192-0-6" id="h192-0-6" class="i">+import android.text.InputType
</a><a href="#h192-0-7" id="h192-0-7" class="i">+import android.view.Gravity
</a><a href="#h192-0-8" id="h192-0-8" class="i">+import android.view.ViewGroup.MarginLayoutParams
</a><a href="#h192-0-9" id="h192-0-9" class="i">+import android.widget.EditText
</a><a href="#h192-0-10" id="h192-0-10" class="i">+import android.widget.ImageView
</a><a href="#h192-0-11" id="h192-0-11" class="i">+import android.widget.LinearLayout
</a><a href="#h192-0-12" id="h192-0-12" class="i">+import android.widget.ProgressBar
</a><a href="#h192-0-13" id="h192-0-13" class="i">+import android.widget.TextView
</a><a href="#h192-0-14" id="h192-0-14" class="i">+import kotlinx.coroutines.ExperimentalCoroutinesApi
</a><a href="#h192-0-15" id="h192-0-15" class="i">+import kotlinx.coroutines.async
</a><a href="#h192-0-16" id="h192-0-16" class="i">+import kotlinx.coroutines.runBlocking
</a><a href="#h192-0-17" id="h192-0-17" class="i">+import me.rhunk.snapenhance.bridge.DownloadCallback
</a><a href="#h192-0-18" id="h192-0-18" class="i">+import me.rhunk.snapenhance.common.data.FileType
</a><a href="#h192-0-19" id="h192-0-19" class="i">+import me.rhunk.snapenhance.common.data.MessagingRuleType
</a><a href="#h192-0-20" id="h192-0-20" class="i">+import me.rhunk.snapenhance.common.data.download.DownloadMediaType
</a><a href="#h192-0-21" id="h192-0-21" class="i">+import me.rhunk.snapenhance.common.data.download.DownloadMetadata
</a><a href="#h192-0-22" id="h192-0-22" class="i">+import me.rhunk.snapenhance.common.data.download.InputMedia
</a><a href="#h192-0-23" id="h192-0-23" class="i">+import me.rhunk.snapenhance.common.data.download.MediaDownloadSource
</a><a href="#h192-0-24" id="h192-0-24" class="i">+import me.rhunk.snapenhance.common.data.download.SplitMediaAssetType
</a><a href="#h192-0-25" id="h192-0-25" class="i">+import me.rhunk.snapenhance.common.database.impl.ConversationMessage
</a><a href="#h192-0-26" id="h192-0-26" class="i">+import me.rhunk.snapenhance.common.database.impl.FriendInfo
</a><a href="#h192-0-27" id="h192-0-27" class="i">+import me.rhunk.snapenhance.common.util.protobuf.ProtoReader
</a><a href="#h192-0-28" id="h192-0-28" class="i">+import me.rhunk.snapenhance.common.util.snap.BitmojiSelfie
</a><a href="#h192-0-29" id="h192-0-29" class="i">+import me.rhunk.snapenhance.common.util.snap.MediaDownloaderHelper
</a><a href="#h192-0-30" id="h192-0-30" class="i">+import me.rhunk.snapenhance.common.util.snap.RemoteMediaResolver
</a><a href="#h192-0-31" id="h192-0-31" class="i">+import me.rhunk.snapenhance.core.DownloadManagerClient
</a><a href="#h192-0-32" id="h192-0-32" class="i">+import me.rhunk.snapenhance.core.SnapEnhance
</a><a href="#h192-0-33" id="h192-0-33" class="i">+import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a><a href="#h192-0-34" id="h192-0-34" class="i">+import me.rhunk.snapenhance.core.features.MessagingRuleFeature
</a><a href="#h192-0-35" id="h192-0-35" class="i">+import me.rhunk.snapenhance.core.features.impl.downloader.decoder.DecodedAttachment
</a><a href="#h192-0-36" id="h192-0-36" class="i">+import me.rhunk.snapenhance.core.features.impl.downloader.decoder.MessageDecoder
</a><a href="#h192-0-37" id="h192-0-37" class="i">+import me.rhunk.snapenhance.core.features.impl.messaging.Messaging
</a><a href="#h192-0-38" id="h192-0-38" class="i">+import me.rhunk.snapenhance.core.features.impl.spying.MessageLogger
</a><a href="#h192-0-39" id="h192-0-39" class="i">+import me.rhunk.snapenhance.core.ui.ViewAppearanceHelper
</a><a href="#h192-0-40" id="h192-0-40" class="i">+import me.rhunk.snapenhance.core.util.hook.HookAdapter
</a><a href="#h192-0-41" id="h192-0-41" class="i">+import me.rhunk.snapenhance.core.util.hook.HookStage
</a><a href="#h192-0-42" id="h192-0-42" class="i">+import me.rhunk.snapenhance.core.util.hook.Hooker
</a><a href="#h192-0-43" id="h192-0-43" class="i">+import me.rhunk.snapenhance.core.util.ktx.getObjectField
</a><a href="#h192-0-44" id="h192-0-44" class="i">+import me.rhunk.snapenhance.core.util.media.PreviewUtils
</a><a href="#h192-0-45" id="h192-0-45" class="i">+import me.rhunk.snapenhance.core.wrapper.impl.SnapUUID
</a><a href="#h192-0-46" id="h192-0-46" class="i">+import me.rhunk.snapenhance.core.wrapper.impl.media.MediaInfo
</a><a href="#h192-0-47" id="h192-0-47" class="i">+import me.rhunk.snapenhance.core.wrapper.impl.media.dash.LongformVideoPlaylistItem
</a><a href="#h192-0-48" id="h192-0-48" class="i">+import me.rhunk.snapenhance.core.wrapper.impl.media.dash.SnapPlaylistItem
</a><a href="#h192-0-49" id="h192-0-49" class="i">+import me.rhunk.snapenhance.core.wrapper.impl.media.opera.Layer
</a><a href="#h192-0-50" id="h192-0-50" class="i">+import me.rhunk.snapenhance.core.wrapper.impl.media.opera.ParamMap
</a><a href="#h192-0-51" id="h192-0-51" class="i">+import me.rhunk.snapenhance.core.wrapper.impl.media.toKeyPair
</a><a href="#h192-0-52" id="h192-0-52" class="i">+import java.io.ByteArrayInputStream
</a><a href="#h192-0-53" id="h192-0-53" class="i">+import java.nio.file.Paths
</a><a href="#h192-0-54" id="h192-0-54" class="i">+import java.text.SimpleDateFormat
</a><a href="#h192-0-55" id="h192-0-55" class="i">+import java.util.Locale
</a><a href="#h192-0-56" id="h192-0-56" class="i">+import kotlin.coroutines.suspendCoroutine
</a><a href="#h192-0-57" id="h192-0-57" class="i">+import kotlin.io.encoding.Base64
</a><a href="#h192-0-58" id="h192-0-58" class="i">+import kotlin.io.encoding.ExperimentalEncodingApi
</a><a href="#h192-0-59" id="h192-0-59" class="i">+
</a><a href="#h192-0-60" id="h192-0-60" class="i">+private fun String.sanitizeForPath(): String {
</a><a href="#h192-0-61" id="h192-0-61" class="i">+    return this.replace(&quot; &quot;, &quot;_&quot;)
</a><a href="#h192-0-62" id="h192-0-62" class="i">+        .replace(Regex(&quot;\\p{Cntrl}&quot;), &quot;&quot;)
</a><a href="#h192-0-63" id="h192-0-63" class="i">+}
</a><a href="#h192-0-64" id="h192-0-64" class="i">+
</a><a href="#h192-0-65" id="h192-0-65" class="i">+class SnapChapterInfo(
</a><a href="#h192-0-66" id="h192-0-66" class="i">+    val offset: Long,
</a><a href="#h192-0-67" id="h192-0-67" class="i">+    val duration: Long?
</a><a href="#h192-0-68" id="h192-0-68" class="i">+)
</a><a href="#h192-0-69" id="h192-0-69" class="i">+
</a><a href="#h192-0-70" id="h192-0-70" class="i">+
</a><a href="#h192-0-71" id="h192-0-71" class="i">+@OptIn(ExperimentalEncodingApi::class)
</a><a href="#h192-0-72" id="h192-0-72" class="i">+class MediaDownloader : MessagingRuleFeature(&quot;MediaDownloader&quot;, MessagingRuleType.AUTO_DOWNLOAD, loadParams = FeatureLoadParams.ACTIVITY_CREATE_ASYNC) {
</a><a href="#h192-0-73" id="h192-0-73" class="i">+    private var lastSeenMediaInfoMap: MutableMap&lt;SplitMediaAssetType, MediaInfo&gt;? = null
</a><a href="#h192-0-74" id="h192-0-74" class="i">+    private var lastSeenMapParams: ParamMap? = null
</a><a href="#h192-0-75" id="h192-0-75" class="i">+
</a><a href="#h192-0-76" id="h192-0-76" class="i">+    private val translations by lazy {
</a><a href="#h192-0-77" id="h192-0-77" class="i">+        context.translation.getCategory(&quot;download_processor&quot;)
</a><a href="#h192-0-78" id="h192-0-78" class="i">+    }
</a><a href="#h192-0-79" id="h192-0-79" class="i">+
</a><a href="#h192-0-80" id="h192-0-80" class="i">+    private fun provideDownloadManagerClient(
</a><a href="#h192-0-81" id="h192-0-81" class="i">+        mediaIdentifier: String,
</a><a href="#h192-0-82" id="h192-0-82" class="i">+        mediaAuthor: String,
</a><a href="#h192-0-83" id="h192-0-83" class="i">+        downloadSource: MediaDownloadSource,
</a><a href="#h192-0-84" id="h192-0-84" class="i">+        friendInfo: FriendInfo? = null
</a><a href="#h192-0-85" id="h192-0-85" class="i">+    ): DownloadManagerClient {
</a><a href="#h192-0-86" id="h192-0-86" class="i">+        val generatedHash = mediaIdentifier.hashCode().toString(16).replaceFirst(&quot;-&quot;, &quot;&quot;)
</a><a href="#h192-0-87" id="h192-0-87" class="i">+
</a><a href="#h192-0-88" id="h192-0-88" class="i">+        val iconUrl = BitmojiSelfie.getBitmojiSelfie(friendInfo?.bitmojiSelfieId, friendInfo?.bitmojiAvatarId, BitmojiSelfie.BitmojiSelfieType.THREE_D)
</a><a href="#h192-0-89" id="h192-0-89" class="i">+
</a><a href="#h192-0-90" id="h192-0-90" class="i">+        val downloadLogging by context.config.downloader.logging
</a><a href="#h192-0-91" id="h192-0-91" class="i">+        if (downloadLogging.contains(&quot;started&quot;)) {
</a><a href="#h192-0-92" id="h192-0-92" class="i">+            context.shortToast(translations[&quot;download_started_toast&quot;])
</a><a href="#h192-0-93" id="h192-0-93" class="i">+        }
</a><a href="#h192-0-94" id="h192-0-94" class="i">+
</a><a href="#h192-0-95" id="h192-0-95" class="i">+        val outputPath = createNewFilePath(generatedHash, downloadSource, mediaAuthor)
</a><a href="#h192-0-96" id="h192-0-96" class="i">+
</a><a href="#h192-0-97" id="h192-0-97" class="i">+        return DownloadManagerClient(
</a><a href="#h192-0-98" id="h192-0-98" class="i">+            context = context,
</a><a href="#h192-0-99" id="h192-0-99" class="i">+            metadata = DownloadMetadata(
</a><a href="#h192-0-100" id="h192-0-100" class="i">+                mediaIdentifier = if (!context.config.downloader.allowDuplicate.get()) {
</a><a href="#h192-0-101" id="h192-0-101" class="i">+                    generatedHash
</a><a href="#h192-0-102" id="h192-0-102" class="i">+                } else null,
</a><a href="#h192-0-103" id="h192-0-103" class="i">+                mediaAuthor = mediaAuthor,
</a><a href="#h192-0-104" id="h192-0-104" class="i">+                downloadSource = downloadSource.key,
</a><a href="#h192-0-105" id="h192-0-105" class="i">+                iconUrl = iconUrl,
</a><a href="#h192-0-106" id="h192-0-106" class="i">+                outputPath = outputPath
</a><a href="#h192-0-107" id="h192-0-107" class="i">+            ),
</a><a href="#h192-0-108" id="h192-0-108" class="i">+            callback = object: DownloadCallback.Stub() {
</a><a href="#h192-0-109" id="h192-0-109" class="i">+                override fun onSuccess(outputFile: String) {
</a><a href="#h192-0-110" id="h192-0-110" class="i">+                    if (!downloadLogging.contains(&quot;success&quot;)) return
</a><a href="#h192-0-111" id="h192-0-111" class="i">+                    context.log.verbose(&quot;onSuccess: outputFile=$outputFile&quot;)
</a><a href="#h192-0-112" id="h192-0-112" class="i">+                    context.shortToast(translations.format(&quot;saved_toast&quot;, &quot;path&quot; to outputFile.split(&quot;/&quot;).takeLast(2).joinToString(&quot;/&quot;)))
</a><a href="#h192-0-113" id="h192-0-113" class="i">+                }
</a><a href="#h192-0-114" id="h192-0-114" class="i">+
</a><a href="#h192-0-115" id="h192-0-115" class="i">+                override fun onProgress(message: String) {
</a><a href="#h192-0-116" id="h192-0-116" class="i">+                    if (!downloadLogging.contains(&quot;progress&quot;)) return
</a><a href="#h192-0-117" id="h192-0-117" class="i">+                    context.log.verbose(&quot;onProgress: message=$message&quot;)
</a><a href="#h192-0-118" id="h192-0-118" class="i">+                    context.shortToast(message)
</a><a href="#h192-0-119" id="h192-0-119" class="i">+                }
</a><a href="#h192-0-120" id="h192-0-120" class="i">+
</a><a href="#h192-0-121" id="h192-0-121" class="i">+                override fun onFailure(message: String, throwable: String?) {
</a><a href="#h192-0-122" id="h192-0-122" class="i">+                    if (!downloadLogging.contains(&quot;failure&quot;)) return
</a><a href="#h192-0-123" id="h192-0-123" class="i">+                    context.log.verbose(&quot;onFailure: message=$message, throwable=$throwable&quot;)
</a><a href="#h192-0-124" id="h192-0-124" class="i">+                    throwable?.let {
</a><a href="#h192-0-125" id="h192-0-125" class="i">+                        context.longToast((message + it.takeIf { it.isNotEmpty() }.orEmpty()))
</a><a href="#h192-0-126" id="h192-0-126" class="i">+                        return
</a><a href="#h192-0-127" id="h192-0-127" class="i">+                    }
</a><a href="#h192-0-128" id="h192-0-128" class="i">+                    context.shortToast(message)
</a><a href="#h192-0-129" id="h192-0-129" class="i">+                }
</a><a href="#h192-0-130" id="h192-0-130" class="i">+            }
</a><a href="#h192-0-131" id="h192-0-131" class="i">+        )
</a><a href="#h192-0-132" id="h192-0-132" class="i">+    }
</a><a href="#h192-0-133" id="h192-0-133" class="i">+
</a><a href="#h192-0-134" id="h192-0-134" class="i">+
</a><a href="#h192-0-135" id="h192-0-135" class="i">+    private fun createNewFilePath(hexHash: String, downloadSource: MediaDownloadSource, mediaAuthor: String): String {
</a><a href="#h192-0-136" id="h192-0-136" class="i">+        val pathFormat by context.config.downloader.pathFormat
</a><a href="#h192-0-137" id="h192-0-137" class="i">+        val sanitizedMediaAuthor = mediaAuthor.sanitizeForPath().ifEmpty { hexHash }
</a><a href="#h192-0-138" id="h192-0-138" class="i">+
</a><a href="#h192-0-139" id="h192-0-139" class="i">+        val currentDateTime = SimpleDateFormat(&quot;yyyy-MM-dd_HH-mm-ss&quot;, Locale.ENGLISH).format(System.currentTimeMillis())
</a><a href="#h192-0-140" id="h192-0-140" class="i">+
</a><a href="#h192-0-141" id="h192-0-141" class="i">+        val finalPath = StringBuilder()
</a><a href="#h192-0-142" id="h192-0-142" class="i">+
</a><a href="#h192-0-143" id="h192-0-143" class="i">+        fun appendFileName(string: String) {
</a><a href="#h192-0-144" id="h192-0-144" class="i">+            if (finalPath.isEmpty() || finalPath.endsWith(&quot;/&quot;)) {
</a><a href="#h192-0-145" id="h192-0-145" class="i">+                finalPath.append(string)
</a><a href="#h192-0-146" id="h192-0-146" class="i">+            } else {
</a><a href="#h192-0-147" id="h192-0-147" class="i">+                finalPath.append(&quot;_&quot;).append(string)
</a><a href="#h192-0-148" id="h192-0-148" class="i">+            }
</a><a href="#h192-0-149" id="h192-0-149" class="i">+        }
</a><a href="#h192-0-150" id="h192-0-150" class="i">+
</a><a href="#h192-0-151" id="h192-0-151" class="i">+        if (pathFormat.contains(&quot;create_author_folder&quot;)) {
</a><a href="#h192-0-152" id="h192-0-152" class="i">+            finalPath.append(sanitizedMediaAuthor).append(&quot;/&quot;)
</a><a href="#h192-0-153" id="h192-0-153" class="i">+        }
</a><a href="#h192-0-154" id="h192-0-154" class="i">+        if (pathFormat.contains(&quot;create_source_folder&quot;)) {
</a><a href="#h192-0-155" id="h192-0-155" class="i">+            finalPath.append(downloadSource.pathName).append(&quot;/&quot;)
</a><a href="#h192-0-156" id="h192-0-156" class="i">+        }
</a><a href="#h192-0-157" id="h192-0-157" class="i">+        if (pathFormat.contains(&quot;append_hash&quot;)) {
</a><a href="#h192-0-158" id="h192-0-158" class="i">+            appendFileName(hexHash)
</a><a href="#h192-0-159" id="h192-0-159" class="i">+        }
</a><a href="#h192-0-160" id="h192-0-160" class="i">+        if (pathFormat.contains(&quot;append_source&quot;)) {
</a><a href="#h192-0-161" id="h192-0-161" class="i">+            appendFileName(downloadSource.pathName)
</a><a href="#h192-0-162" id="h192-0-162" class="i">+        }
</a><a href="#h192-0-163" id="h192-0-163" class="i">+        if (pathFormat.contains(&quot;append_username&quot;)) {
</a><a href="#h192-0-164" id="h192-0-164" class="i">+            appendFileName(sanitizedMediaAuthor)
</a><a href="#h192-0-165" id="h192-0-165" class="i">+        }
</a><a href="#h192-0-166" id="h192-0-166" class="i">+        if (pathFormat.contains(&quot;append_date_time&quot;)) {
</a><a href="#h192-0-167" id="h192-0-167" class="i">+            appendFileName(currentDateTime)
</a><a href="#h192-0-168" id="h192-0-168" class="i">+        }
</a><a href="#h192-0-169" id="h192-0-169" class="i">+
</a><a href="#h192-0-170" id="h192-0-170" class="i">+        if (finalPath.isEmpty()) finalPath.append(hexHash)
</a><a href="#h192-0-171" id="h192-0-171" class="i">+
</a><a href="#h192-0-172" id="h192-0-172" class="i">+        return finalPath.toString()
</a><a href="#h192-0-173" id="h192-0-173" class="i">+    }
</a><a href="#h192-0-174" id="h192-0-174" class="i">+
</a><a href="#h192-0-175" id="h192-0-175" class="i">+    /*
</a><a href="#h192-0-176" id="h192-0-176" class="i">+     * Download the last seen media
</a><a href="#h192-0-177" id="h192-0-177" class="i">+     */
</a><a href="#h192-0-178" id="h192-0-178" class="i">+    fun downloadLastOperaMediaAsync() {
</a><a href="#h192-0-179" id="h192-0-179" class="i">+        if (lastSeenMapParams == null || lastSeenMediaInfoMap == null) return
</a><a href="#h192-0-180" id="h192-0-180" class="i">+        context.executeAsync {
</a><a href="#h192-0-181" id="h192-0-181" class="i">+            handleOperaMedia(lastSeenMapParams!!, lastSeenMediaInfoMap!!, true)
</a><a href="#h192-0-182" id="h192-0-182" class="i">+        }
</a><a href="#h192-0-183" id="h192-0-183" class="i">+    }
</a><a href="#h192-0-184" id="h192-0-184" class="i">+
</a><a href="#h192-0-185" id="h192-0-185" class="i">+    fun showLastOperaDebugMediaInfo() {
</a><a href="#h192-0-186" id="h192-0-186" class="i">+        if (lastSeenMapParams == null || lastSeenMediaInfoMap == null) return
</a><a href="#h192-0-187" id="h192-0-187" class="i">+
</a><a href="#h192-0-188" id="h192-0-188" class="i">+        context.runOnUiThread {
</a><a href="#h192-0-189" id="h192-0-189" class="i">+            val mediaInfoText = lastSeenMapParams?.concurrentHashMap?.map { (key, value) -&gt;
</a><a href="#h192-0-190" id="h192-0-190" class="i">+                val transformedValue = value.let {
</a><a href="#h192-0-191" id="h192-0-191" class="i">+                    if (it::class.java == SnapEnhance.classCache.snapUUID) {
</a><a href="#h192-0-192" id="h192-0-192" class="i">+                        SnapUUID(it).toString()
</a><a href="#h192-0-193" id="h192-0-193" class="i">+                    }
</a><a href="#h192-0-194" id="h192-0-194" class="i">+                    it
</a><a href="#h192-0-195" id="h192-0-195" class="i">+                }
</a><a href="#h192-0-196" id="h192-0-196" class="i">+                &quot;- $key: $transformedValue&quot;
</a><a href="#h192-0-197" id="h192-0-197" class="i">+            }?.joinToString(&quot;\n&quot;) ?: &quot;No media info found&quot;
</a><a href="#h192-0-198" id="h192-0-198" class="i">+
</a><a href="#h192-0-199" id="h192-0-199" class="i">+            ViewAppearanceHelper.newAlertDialogBuilder(context.mainActivity!!).apply {
</a><a href="#h192-0-200" id="h192-0-200" class="i">+                setTitle(&quot;Debug Media Info&quot;)
</a><a href="#h192-0-201" id="h192-0-201" class="i">+                setView(EditText(context).apply {
</a><a href="#h192-0-202" id="h192-0-202" class="i">+                    inputType = InputType.TYPE_NULL
</a><a href="#h192-0-203" id="h192-0-203" class="i">+                    setTextIsSelectable(true)
</a><a href="#h192-0-204" id="h192-0-204" class="i">+                    isSingleLine = false
</a><a href="#h192-0-205" id="h192-0-205" class="i">+                    textSize = 12f
</a><a href="#h192-0-206" id="h192-0-206" class="i">+                    setPadding(20, 20, 20, 20)
</a><a href="#h192-0-207" id="h192-0-207" class="i">+                    setText(mediaInfoText)
</a><a href="#h192-0-208" id="h192-0-208" class="i">+                    setTextColor(context.resources.getColor(android.R.color.white, context.theme))
</a><a href="#h192-0-209" id="h192-0-209" class="i">+                })
</a><a href="#h192-0-210" id="h192-0-210" class="i">+                setNeutralButton(&quot;Copy&quot;) { _, _ -&gt;
</a><a href="#h192-0-211" id="h192-0-211" class="i">+                    this@MediaDownloader.context.copyToClipboard(mediaInfoText)
</a><a href="#h192-0-212" id="h192-0-212" class="i">+                }
</a><a href="#h192-0-213" id="h192-0-213" class="i">+                setPositiveButton(&quot;Download&quot;) { _, _ -&gt;
</a><a href="#h192-0-214" id="h192-0-214" class="i">+                    downloadLastOperaMediaAsync()
</a><a href="#h192-0-215" id="h192-0-215" class="i">+                }
</a><a href="#h192-0-216" id="h192-0-216" class="i">+                setNegativeButton(&quot;Cancel&quot;) { dialog, _ -&gt; dialog.dismiss() }
</a><a href="#h192-0-217" id="h192-0-217" class="i">+            }.show()
</a><a href="#h192-0-218" id="h192-0-218" class="i">+        }
</a><a href="#h192-0-219" id="h192-0-219" class="i">+    }
</a><a href="#h192-0-220" id="h192-0-220" class="i">+
</a><a href="#h192-0-221" id="h192-0-221" class="i">+    private fun handleLocalReferences(path: String) = runBlocking {
</a><a href="#h192-0-222" id="h192-0-222" class="i">+        Uri.parse(path).let { uri -&gt;
</a><a href="#h192-0-223" id="h192-0-223" class="i">+            if (uri.scheme == &quot;file&quot;) {
</a><a href="#h192-0-224" id="h192-0-224" class="i">+                return@let suspendCoroutine&lt;String&gt; { continuation -&gt;
</a><a href="#h192-0-225" id="h192-0-225" class="i">+                    context.httpServer.ensureServerStarted {
</a><a href="#h192-0-226" id="h192-0-226" class="i">+                        val file = Paths.get(uri.path).toFile()
</a><a href="#h192-0-227" id="h192-0-227" class="i">+                        val url = putDownloadableContent(file.inputStream(), file.length())
</a><a href="#h192-0-228" id="h192-0-228" class="i">+                        continuation.resumeWith(Result.success(url))
</a><a href="#h192-0-229" id="h192-0-229" class="i">+                    }
</a><a href="#h192-0-230" id="h192-0-230" class="i">+                }
</a><a href="#h192-0-231" id="h192-0-231" class="i">+            }
</a><a href="#h192-0-232" id="h192-0-232" class="i">+            path
</a><a href="#h192-0-233" id="h192-0-233" class="i">+        }
</a><a href="#h192-0-234" id="h192-0-234" class="i">+    }
</a><a href="#h192-0-235" id="h192-0-235" class="i">+
</a><a href="#h192-0-236" id="h192-0-236" class="i">+    private fun downloadOperaMedia(downloadManagerClient: DownloadManagerClient, mediaInfoMap: Map&lt;SplitMediaAssetType, MediaInfo&gt;) {
</a><a href="#h192-0-237" id="h192-0-237" class="i">+        if (mediaInfoMap.isEmpty()) return
</a><a href="#h192-0-238" id="h192-0-238" class="i">+
</a><a href="#h192-0-239" id="h192-0-239" class="i">+        val originalMediaInfo = mediaInfoMap[SplitMediaAssetType.ORIGINAL]!!
</a><a href="#h192-0-240" id="h192-0-240" class="i">+        val originalMediaInfoReference = handleLocalReferences(originalMediaInfo.uri)
</a><a href="#h192-0-241" id="h192-0-241" class="i">+
</a><a href="#h192-0-242" id="h192-0-242" class="i">+        mediaInfoMap[SplitMediaAssetType.OVERLAY]?.let { overlay -&gt;
</a><a href="#h192-0-243" id="h192-0-243" class="i">+            val overlayReference = handleLocalReferences(overlay.uri)
</a><a href="#h192-0-244" id="h192-0-244" class="i">+
</a><a href="#h192-0-245" id="h192-0-245" class="i">+            downloadManagerClient.downloadMediaWithOverlay(
</a><a href="#h192-0-246" id="h192-0-246" class="i">+                original = InputMedia(
</a><a href="#h192-0-247" id="h192-0-247" class="i">+                    originalMediaInfoReference,
</a><a href="#h192-0-248" id="h192-0-248" class="i">+                    DownloadMediaType.fromUri(Uri.parse(originalMediaInfoReference)),
</a><a href="#h192-0-249" id="h192-0-249" class="i">+                    originalMediaInfo.encryption?.toKeyPair()
</a><a href="#h192-0-250" id="h192-0-250" class="i">+                ),
</a><a href="#h192-0-251" id="h192-0-251" class="i">+                overlay = InputMedia(
</a><a href="#h192-0-252" id="h192-0-252" class="i">+                    overlayReference,
</a><a href="#h192-0-253" id="h192-0-253" class="i">+                    DownloadMediaType.fromUri(Uri.parse(overlayReference)),
</a><a href="#h192-0-254" id="h192-0-254" class="i">+                    overlay.encryption?.toKeyPair(),
</a><a href="#h192-0-255" id="h192-0-255" class="i">+                    isOverlay = true
</a><a href="#h192-0-256" id="h192-0-256" class="i">+                )
</a><a href="#h192-0-257" id="h192-0-257" class="i">+            )
</a><a href="#h192-0-258" id="h192-0-258" class="i">+            return
</a><a href="#h192-0-259" id="h192-0-259" class="i">+        }
</a><a href="#h192-0-260" id="h192-0-260" class="i">+
</a><a href="#h192-0-261" id="h192-0-261" class="i">+        downloadManagerClient.downloadSingleMedia(
</a><a href="#h192-0-262" id="h192-0-262" class="i">+            originalMediaInfoReference,
</a><a href="#h192-0-263" id="h192-0-263" class="i">+            DownloadMediaType.fromUri(Uri.parse(originalMediaInfoReference)),
</a><a href="#h192-0-264" id="h192-0-264" class="i">+            originalMediaInfo.encryption?.toKeyPair()
</a><a href="#h192-0-265" id="h192-0-265" class="i">+        )
</a><a href="#h192-0-266" id="h192-0-266" class="i">+    }
</a><a href="#h192-0-267" id="h192-0-267" class="i">+
</a><a href="#h192-0-268" id="h192-0-268" class="i">+    /**
</a><a href="#h192-0-269" id="h192-0-269" class="i">+     * Handles the media from the opera viewer
</a><a href="#h192-0-270" id="h192-0-270" class="i">+     *
</a><a href="#h192-0-271" id="h192-0-271" class="i">+     * @param paramMap      the parameters from the opera viewer
</a><a href="#h192-0-272" id="h192-0-272" class="i">+     * @param mediaInfoMap  the media info map
</a><a href="#h192-0-273" id="h192-0-273" class="i">+     * @param forceDownload if the media should be downloaded
</a><a href="#h192-0-274" id="h192-0-274" class="i">+     */
</a><a href="#h192-0-275" id="h192-0-275" class="i">+    private fun handleOperaMedia(
</a><a href="#h192-0-276" id="h192-0-276" class="i">+        paramMap: ParamMap,
</a><a href="#h192-0-277" id="h192-0-277" class="i">+        mediaInfoMap: Map&lt;SplitMediaAssetType, MediaInfo&gt;,
</a><a href="#h192-0-278" id="h192-0-278" class="i">+        forceDownload: Boolean
</a><a href="#h192-0-279" id="h192-0-279" class="i">+    ) {
</a><a href="#h192-0-280" id="h192-0-280" class="i">+        //messages
</a><a href="#h192-0-281" id="h192-0-281" class="i">+        paramMap[&quot;MESSAGE_ID&quot;]?.toString()?.takeIf { forceDownload || canAutoDownload(&quot;friend_snaps&quot;) }?.let { id -&gt;
</a><a href="#h192-0-282" id="h192-0-282" class="i">+            val messageId = id.substring(id.lastIndexOf(&quot;:&quot;) + 1).toLong()
</a><a href="#h192-0-283" id="h192-0-283" class="i">+            val conversationMessage = context.database.getConversationMessageFromId(messageId)!!
</a><a href="#h192-0-284" id="h192-0-284" class="i">+
</a><a href="#h192-0-285" id="h192-0-285" class="i">+            val senderId = conversationMessage.senderId!!
</a><a href="#h192-0-286" id="h192-0-286" class="i">+            val conversationId = conversationMessage.clientConversationId!!
</a><a href="#h192-0-287" id="h192-0-287" class="i">+
</a><a href="#h192-0-288" id="h192-0-288" class="i">+            if (!forceDownload &amp;&amp; !canUseRule(senderId)) {
</a><a href="#h192-0-289" id="h192-0-289" class="i">+                return
</a><a href="#h192-0-290" id="h192-0-290" class="i">+            }
</a><a href="#h192-0-291" id="h192-0-291" class="i">+
</a><a href="#h192-0-292" id="h192-0-292" class="i">+            if (!forceDownload &amp;&amp; context.config.downloader.preventSelfAutoDownload.get() &amp;&amp; senderId == context.database.myUserId) return
</a><a href="#h192-0-293" id="h192-0-293" class="i">+
</a><a href="#h192-0-294" id="h192-0-294" class="i">+            val author = context.database.getFriendInfo(senderId) ?: return
</a><a href="#h192-0-295" id="h192-0-295" class="i">+            val authorUsername = author.usernameForSorting!!
</a><a href="#h192-0-296" id="h192-0-296" class="i">+            val mediaId = paramMap[&quot;MEDIA_ID&quot;]?.toString()?.split(&quot;-&quot;)?.getOrNull(1) ?: &quot;&quot;
</a><a href="#h192-0-297" id="h192-0-297" class="i">+
</a><a href="#h192-0-298" id="h192-0-298" class="i">+            downloadOperaMedia(provideDownloadManagerClient(
</a><a href="#h192-0-299" id="h192-0-299" class="i">+                mediaIdentifier = &quot;$conversationId$senderId${conversationMessage.serverMessageId}$mediaId&quot;,
</a><a href="#h192-0-300" id="h192-0-300" class="i">+                mediaAuthor = authorUsername,
</a><a href="#h192-0-301" id="h192-0-301" class="i">+                downloadSource = MediaDownloadSource.CHAT_MEDIA,
</a><a href="#h192-0-302" id="h192-0-302" class="i">+                friendInfo = author
</a><a href="#h192-0-303" id="h192-0-303" class="i">+            ), mediaInfoMap)
</a><a href="#h192-0-304" id="h192-0-304" class="i">+
</a><a href="#h192-0-305" id="h192-0-305" class="i">+            return
</a><a href="#h192-0-306" id="h192-0-306" class="i">+        }
</a><a href="#h192-0-307" id="h192-0-307" class="i">+
</a><a href="#h192-0-308" id="h192-0-308" class="i">+        //private stories
</a><a href="#h192-0-309" id="h192-0-309" class="i">+        paramMap[&quot;PLAYLIST_V2_GROUP&quot;]?.takeIf {
</a><a href="#h192-0-310" id="h192-0-310" class="i">+            forceDownload || canAutoDownload(&quot;friend_stories&quot;)
</a><a href="#h192-0-311" id="h192-0-311" class="i">+        }?.let { playlistGroup -&gt;
</a><a href="#h192-0-312" id="h192-0-312" class="i">+            val playlistGroupString = playlistGroup.toString()
</a><a href="#h192-0-313" id="h192-0-313" class="i">+
</a><a href="#h192-0-314" id="h192-0-314" class="i">+            val storyUserId = paramMap[&quot;TOPIC_SNAP_CREATOR_USER_ID&quot;]?.toString() ?: if (playlistGroupString.contains(&quot;storyUserId=&quot;)) {
</a><a href="#h192-0-315" id="h192-0-315" class="i">+                (playlistGroupString.indexOf(&quot;storyUserId=&quot;) + 12).let {
</a><a href="#h192-0-316" id="h192-0-316" class="i">+                    playlistGroupString.substring(it, playlistGroupString.indexOf(&quot;,&quot;, it))
</a><a href="#h192-0-317" id="h192-0-317" class="i">+                }
</a><a href="#h192-0-318" id="h192-0-318" class="i">+            } else {
</a><a href="#h192-0-319" id="h192-0-319" class="i">+                //story replies
</a><a href="#h192-0-320" id="h192-0-320" class="i">+                val arroyoMessageId = playlistGroup::class.java.methods.firstOrNull { it.name == &quot;getId&quot; }
</a><a href="#h192-0-321" id="h192-0-321" class="i">+                    ?.invoke(playlistGroup)?.toString()
</a><a href="#h192-0-322" id="h192-0-322" class="i">+                    ?.split(&quot;:&quot;)?.getOrNull(2) ?: return@let
</a><a href="#h192-0-323" id="h192-0-323" class="i">+
</a><a href="#h192-0-324" id="h192-0-324" class="i">+                val conversationMessage = context.database.getConversationMessageFromId(arroyoMessageId.toLong()) ?: return@let
</a><a href="#h192-0-325" id="h192-0-325" class="i">+                val conversationParticipants = context.database.getConversationParticipants(conversationMessage.clientConversationId.toString()) ?: return@let
</a><a href="#h192-0-326" id="h192-0-326" class="i">+
</a><a href="#h192-0-327" id="h192-0-327" class="i">+                conversationParticipants.firstOrNull { it != conversationMessage.senderId }
</a><a href="#h192-0-328" id="h192-0-328" class="i">+            }
</a><a href="#h192-0-329" id="h192-0-329" class="i">+
</a><a href="#h192-0-330" id="h192-0-330" class="i">+            val author = context.database.getFriendInfo(
</a><a href="#h192-0-331" id="h192-0-331" class="i">+                if (storyUserId == null || storyUserId == &quot;null&quot;)
</a><a href="#h192-0-332" id="h192-0-332" class="i">+                    context.database.myUserId
</a><a href="#h192-0-333" id="h192-0-333" class="i">+                else storyUserId
</a><a href="#h192-0-334" id="h192-0-334" class="i">+            ) ?: throw Exception(&quot;Friend not found in database&quot;)
</a><a href="#h192-0-335" id="h192-0-335" class="i">+            val authorName = author.usernameForSorting!!
</a><a href="#h192-0-336" id="h192-0-336" class="i">+
</a><a href="#h192-0-337" id="h192-0-337" class="i">+            if (!forceDownload) {
</a><a href="#h192-0-338" id="h192-0-338" class="i">+                if (context.config.downloader.preventSelfAutoDownload.get() &amp;&amp; author.userId == context.database.myUserId) return
</a><a href="#h192-0-339" id="h192-0-339" class="i">+                if (!canUseRule(author.userId!!)) return
</a><a href="#h192-0-340" id="h192-0-340" class="i">+            }
</a><a href="#h192-0-341" id="h192-0-341" class="i">+
</a><a href="#h192-0-342" id="h192-0-342" class="i">+            downloadOperaMedia(provideDownloadManagerClient(
</a><a href="#h192-0-343" id="h192-0-343" class="i">+                mediaIdentifier = paramMap[&quot;MEDIA_ID&quot;].toString(),
</a><a href="#h192-0-344" id="h192-0-344" class="i">+                mediaAuthor = authorName,
</a><a href="#h192-0-345" id="h192-0-345" class="i">+                downloadSource = MediaDownloadSource.STORY,
</a><a href="#h192-0-346" id="h192-0-346" class="i">+                friendInfo = author
</a><a href="#h192-0-347" id="h192-0-347" class="i">+            ), mediaInfoMap)
</a><a href="#h192-0-348" id="h192-0-348" class="i">+            return
</a><a href="#h192-0-349" id="h192-0-349" class="i">+        }
</a><a href="#h192-0-350" id="h192-0-350" class="i">+
</a><a href="#h192-0-351" id="h192-0-351" class="i">+        val snapSource = paramMap[&quot;SNAP_SOURCE&quot;].toString()
</a><a href="#h192-0-352" id="h192-0-352" class="i">+
</a><a href="#h192-0-353" id="h192-0-353" class="i">+        //public stories
</a><a href="#h192-0-354" id="h192-0-354" class="i">+        if ((snapSource == &quot;PUBLIC_USER&quot; || snapSource == &quot;SAVED_STORY&quot;) &amp;&amp;
</a><a href="#h192-0-355" id="h192-0-355" class="i">+            (forceDownload || canAutoDownload(&quot;public_stories&quot;))) {
</a><a href="#h192-0-356" id="h192-0-356" class="i">+            val userDisplayName = (if (paramMap.containsKey(&quot;USER_DISPLAY_NAME&quot;)) paramMap[&quot;USER_DISPLAY_NAME&quot;].toString() else &quot;&quot;).sanitizeForPath()
</a><a href="#h192-0-357" id="h192-0-357" class="i">+
</a><a href="#h192-0-358" id="h192-0-358" class="i">+            downloadOperaMedia(provideDownloadManagerClient(
</a><a href="#h192-0-359" id="h192-0-359" class="i">+                mediaIdentifier = paramMap[&quot;SNAP_ID&quot;].toString(),
</a><a href="#h192-0-360" id="h192-0-360" class="i">+                mediaAuthor = userDisplayName,
</a><a href="#h192-0-361" id="h192-0-361" class="i">+                downloadSource = MediaDownloadSource.PUBLIC_STORY,
</a><a href="#h192-0-362" id="h192-0-362" class="i">+            ), mediaInfoMap)
</a><a href="#h192-0-363" id="h192-0-363" class="i">+            return
</a><a href="#h192-0-364" id="h192-0-364" class="i">+        }
</a><a href="#h192-0-365" id="h192-0-365" class="i">+
</a><a href="#h192-0-366" id="h192-0-366" class="i">+        //spotlight
</a><a href="#h192-0-367" id="h192-0-367" class="i">+        if (snapSource == &quot;SINGLE_SNAP_STORY&quot; &amp;&amp; (forceDownload || canAutoDownload(&quot;spotlight&quot;))) {
</a><a href="#h192-0-368" id="h192-0-368" class="i">+            downloadOperaMedia(provideDownloadManagerClient(
</a><a href="#h192-0-369" id="h192-0-369" class="i">+                mediaIdentifier = paramMap[&quot;SNAP_ID&quot;].toString(),
</a><a href="#h192-0-370" id="h192-0-370" class="i">+                downloadSource = MediaDownloadSource.SPOTLIGHT,
</a><a href="#h192-0-371" id="h192-0-371" class="i">+                mediaAuthor = paramMap[&quot;TIME_STAMP&quot;].toString()
</a><a href="#h192-0-372" id="h192-0-372" class="i">+            ), mediaInfoMap)
</a><a href="#h192-0-373" id="h192-0-373" class="i">+            return
</a><a href="#h192-0-374" id="h192-0-374" class="i">+        }
</a><a href="#h192-0-375" id="h192-0-375" class="i">+
</a><a href="#h192-0-376" id="h192-0-376" class="i">+        //stories with mpeg dash media
</a><a href="#h192-0-377" id="h192-0-377" class="i">+        if (paramMap.containsKey(&quot;LONGFORM_VIDEO_PLAYLIST_ITEM&quot;) &amp;&amp; forceDownload) {
</a><a href="#h192-0-378" id="h192-0-378" class="i">+            val storyName = paramMap[&quot;STORY_NAME&quot;].toString().sanitizeForPath()
</a><a href="#h192-0-379" id="h192-0-379" class="i">+            //get the position of the media in the playlist and the duration
</a><a href="#h192-0-380" id="h192-0-380" class="i">+            val snapItem = SnapPlaylistItem(paramMap[&quot;SNAP_PLAYLIST_ITEM&quot;]!!)
</a><a href="#h192-0-381" id="h192-0-381" class="i">+            val snapChapterList = LongformVideoPlaylistItem(paramMap[&quot;LONGFORM_VIDEO_PLAYLIST_ITEM&quot;]!!).chapters
</a><a href="#h192-0-382" id="h192-0-382" class="i">+            val currentChapterIndex = snapChapterList.indexOfFirst { it.snapId == snapItem.snapId }
</a><a href="#h192-0-383" id="h192-0-383" class="i">+
</a><a href="#h192-0-384" id="h192-0-384" class="i">+            if (snapChapterList.isEmpty()) {
</a><a href="#h192-0-385" id="h192-0-385" class="i">+                context.shortToast(&quot;No chapters found&quot;)
</a><a href="#h192-0-386" id="h192-0-386" class="i">+                return
</a><a href="#h192-0-387" id="h192-0-387" class="i">+            }
</a><a href="#h192-0-388" id="h192-0-388" class="i">+
</a><a href="#h192-0-389" id="h192-0-389" class="i">+            fun prettyPrintTime(time: Long): String {
</a><a href="#h192-0-390" id="h192-0-390" class="i">+                val seconds = time / 1000
</a><a href="#h192-0-391" id="h192-0-391" class="i">+                val minutes = seconds / 60
</a><a href="#h192-0-392" id="h192-0-392" class="i">+                val hours = minutes / 60
</a><a href="#h192-0-393" id="h192-0-393" class="i">+                return &quot;${hours % 24}:${minutes % 60}:${seconds % 60}&quot;
</a><a href="#h192-0-394" id="h192-0-394" class="i">+            }
</a><a href="#h192-0-395" id="h192-0-395" class="i">+
</a><a href="#h192-0-396" id="h192-0-396" class="i">+            val playlistUrl = paramMap[&quot;MEDIA_ID&quot;].toString().let {
</a><a href="#h192-0-397" id="h192-0-397" class="i">+                val urlIndexes = arrayOf(it.indexOf(&quot;https://cf-st.sc-cdn.net&quot;), it.indexOf(&quot;https://bolt-gcdn.sc-cdn.net&quot;))
</a><a href="#h192-0-398" id="h192-0-398" class="i">+
</a><a href="#h192-0-399" id="h192-0-399" class="i">+                urlIndexes.firstOrNull { index -&gt; index != -1 }?.let { validIndex -&gt;
</a><a href="#h192-0-400" id="h192-0-400" class="i">+                    it.substring(validIndex)
</a><a href="#h192-0-401" id="h192-0-401" class="i">+                } ?: &quot;${RemoteMediaResolver.CF_ST_CDN_D}$it&quot;
</a><a href="#h192-0-402" id="h192-0-402" class="i">+            }
</a><a href="#h192-0-403" id="h192-0-403" class="i">+
</a><a href="#h192-0-404" id="h192-0-404" class="i">+            context.runOnUiThread {
</a><a href="#h192-0-405" id="h192-0-405" class="i">+                val selectedChapters = mutableListOf&lt;Int&gt;()
</a><a href="#h192-0-406" id="h192-0-406" class="i">+                val chapters = snapChapterList.mapIndexed { index, snapChapter -&gt;
</a><a href="#h192-0-407" id="h192-0-407" class="i">+                    val nextChapter = snapChapterList.getOrNull(index + 1)
</a><a href="#h192-0-408" id="h192-0-408" class="i">+                    val duration = nextChapter?.startTimeMs?.minus(snapChapter.startTimeMs)
</a><a href="#h192-0-409" id="h192-0-409" class="i">+                    SnapChapterInfo(snapChapter.startTimeMs, duration)
</a><a href="#h192-0-410" id="h192-0-410" class="i">+                }
</a><a href="#h192-0-411" id="h192-0-411" class="i">+                ViewAppearanceHelper.newAlertDialogBuilder(context.mainActivity!!).apply {
</a><a href="#h192-0-412" id="h192-0-412" class="i">+                    setTitle(&quot;Download dash media&quot;)
</a><a href="#h192-0-413" id="h192-0-413" class="i">+                    setMultiChoiceItems(
</a><a href="#h192-0-414" id="h192-0-414" class="i">+                        chapters.map { &quot;Segment ${prettyPrintTime(it.offset)} - ${prettyPrintTime(it.offset + (it.duration ?: 0))}&quot; }.toTypedArray(),
</a><a href="#h192-0-415" id="h192-0-415" class="i">+                        List(chapters.size) { index -&gt; currentChapterIndex == index }.toBooleanArray()
</a><a href="#h192-0-416" id="h192-0-416" class="i">+                    ) { _, which, isChecked -&gt;
</a><a href="#h192-0-417" id="h192-0-417" class="i">+                        if (isChecked) {
</a><a href="#h192-0-418" id="h192-0-418" class="i">+                            selectedChapters.add(which)
</a><a href="#h192-0-419" id="h192-0-419" class="i">+                        } else if (selectedChapters.contains(which)) {
</a><a href="#h192-0-420" id="h192-0-420" class="i">+                            selectedChapters.remove(which)
</a><a href="#h192-0-421" id="h192-0-421" class="i">+                        }
</a><a href="#h192-0-422" id="h192-0-422" class="i">+                    }
</a><a href="#h192-0-423" id="h192-0-423" class="i">+                    setNegativeButton(&quot;Cancel&quot;) { dialog, _ -&gt; dialog.dismiss() }
</a><a href="#h192-0-424" id="h192-0-424" class="i">+                    setNeutralButton(&quot;Download all&quot;) { _, _ -&gt;
</a><a href="#h192-0-425" id="h192-0-425" class="i">+                        provideDownloadManagerClient(
</a><a href="#h192-0-426" id="h192-0-426" class="i">+                            mediaIdentifier = paramMap[&quot;STORY_ID&quot;].toString(),
</a><a href="#h192-0-427" id="h192-0-427" class="i">+                            downloadSource = MediaDownloadSource.PUBLIC_STORY,
</a><a href="#h192-0-428" id="h192-0-428" class="i">+                            mediaAuthor = storyName
</a><a href="#h192-0-429" id="h192-0-429" class="i">+                        ).downloadDashMedia(playlistUrl, 0, null)
</a><a href="#h192-0-430" id="h192-0-430" class="i">+                    }
</a><a href="#h192-0-431" id="h192-0-431" class="i">+                    setPositiveButton(&quot;Download&quot;) { _, _ -&gt;
</a><a href="#h192-0-432" id="h192-0-432" class="i">+                        val groups = mutableListOf&lt;MutableList&lt;SnapChapterInfo&gt;&gt;()
</a><a href="#h192-0-433" id="h192-0-433" class="i">+                        var currentGroup = mutableListOf&lt;SnapChapterInfo&gt;()
</a><a href="#h192-0-434" id="h192-0-434" class="i">+                        var lastChapterIndex = -1
</a><a href="#h192-0-435" id="h192-0-435" class="i">+
</a><a href="#h192-0-436" id="h192-0-436" class="i">+                        //check for consecutive chapters
</a><a href="#h192-0-437" id="h192-0-437" class="i">+                        chapters.filterIndexed { index, _ -&gt; selectedChapters.contains(index) }
</a><a href="#h192-0-438" id="h192-0-438" class="i">+                            .forEachIndexed { index, pair -&gt;
</a><a href="#h192-0-439" id="h192-0-439" class="i">+                                if (lastChapterIndex != -1 &amp;&amp; index != lastChapterIndex + 1) {
</a><a href="#h192-0-440" id="h192-0-440" class="i">+                                    groups.add(currentGroup)
</a><a href="#h192-0-441" id="h192-0-441" class="i">+                                    currentGroup = mutableListOf()
</a><a href="#h192-0-442" id="h192-0-442" class="i">+                                }
</a><a href="#h192-0-443" id="h192-0-443" class="i">+                                currentGroup.add(pair)
</a><a href="#h192-0-444" id="h192-0-444" class="i">+                                lastChapterIndex = index
</a><a href="#h192-0-445" id="h192-0-445" class="i">+                        }
</a><a href="#h192-0-446" id="h192-0-446" class="i">+
</a><a href="#h192-0-447" id="h192-0-447" class="i">+                        if (currentGroup.isNotEmpty()) {
</a><a href="#h192-0-448" id="h192-0-448" class="i">+                            groups.add(currentGroup)
</a><a href="#h192-0-449" id="h192-0-449" class="i">+                        }
</a><a href="#h192-0-450" id="h192-0-450" class="i">+
</a><a href="#h192-0-451" id="h192-0-451" class="i">+                        groups.forEach { group -&gt;
</a><a href="#h192-0-452" id="h192-0-452" class="i">+                            val firstChapter = group.first()
</a><a href="#h192-0-453" id="h192-0-453" class="i">+                            val lastChapter = group.last()
</a><a href="#h192-0-454" id="h192-0-454" class="i">+                            val duration = if (firstChapter == lastChapter) {
</a><a href="#h192-0-455" id="h192-0-455" class="i">+                                firstChapter.duration
</a><a href="#h192-0-456" id="h192-0-456" class="i">+                            } else {
</a><a href="#h192-0-457" id="h192-0-457" class="i">+                                lastChapter.duration?.let { lastChapter.offset - firstChapter.offset + it }
</a><a href="#h192-0-458" id="h192-0-458" class="i">+                            }
</a><a href="#h192-0-459" id="h192-0-459" class="i">+
</a><a href="#h192-0-460" id="h192-0-460" class="i">+                            provideDownloadManagerClient(
</a><a href="#h192-0-461" id="h192-0-461" class="i">+                                mediaIdentifier = &quot;${paramMap[&quot;STORY_ID&quot;]}-${firstChapter.offset}-${lastChapter.offset}&quot;,
</a><a href="#h192-0-462" id="h192-0-462" class="i">+                                downloadSource = MediaDownloadSource.PUBLIC_STORY,
</a><a href="#h192-0-463" id="h192-0-463" class="i">+                                mediaAuthor = storyName
</a><a href="#h192-0-464" id="h192-0-464" class="i">+                            ).downloadDashMedia(
</a><a href="#h192-0-465" id="h192-0-465" class="i">+                                playlistUrl,
</a><a href="#h192-0-466" id="h192-0-466" class="i">+                                firstChapter.offset.plus(100),
</a><a href="#h192-0-467" id="h192-0-467" class="i">+                                duration
</a><a href="#h192-0-468" id="h192-0-468" class="i">+                            )
</a><a href="#h192-0-469" id="h192-0-469" class="i">+                        }
</a><a href="#h192-0-470" id="h192-0-470" class="i">+                    }
</a><a href="#h192-0-471" id="h192-0-471" class="i">+                }.show()
</a><a href="#h192-0-472" id="h192-0-472" class="i">+            }
</a><a href="#h192-0-473" id="h192-0-473" class="i">+        }
</a><a href="#h192-0-474" id="h192-0-474" class="i">+    }
</a><a href="#h192-0-475" id="h192-0-475" class="i">+
</a><a href="#h192-0-476" id="h192-0-476" class="i">+    private fun canAutoDownload(keyFilter: String? = null): Boolean {
</a><a href="#h192-0-477" id="h192-0-477" class="i">+        val options by context.config.downloader.autoDownloadSources
</a><a href="#h192-0-478" id="h192-0-478" class="i">+        return options.any { keyFilter == null || it.contains(keyFilter, true) }
</a><a href="#h192-0-479" id="h192-0-479" class="i">+    }
</a><a href="#h192-0-480" id="h192-0-480" class="i">+
</a><a href="#h192-0-481" id="h192-0-481" class="i">+    override fun asyncOnActivityCreate() {
</a><a href="#h192-0-482" id="h192-0-482" class="i">+        val operaViewerControllerClass: Class&lt;*&gt; = context.mappings.getMappedClass(&quot;OperaPageViewController&quot;, &quot;class&quot;)
</a><a href="#h192-0-483" id="h192-0-483" class="i">+
</a><a href="#h192-0-484" id="h192-0-484" class="i">+        val onOperaViewStateCallback: (HookAdapter) -&gt; Unit = onOperaViewStateCallback@{ param -&gt;
</a><a href="#h192-0-485" id="h192-0-485" class="i">+
</a><a href="#h192-0-486" id="h192-0-486" class="i">+            val viewState = (param.thisObject() as Any).getObjectField(context.mappings.getMappedValue(&quot;OperaPageViewController&quot;, &quot;viewStateField&quot;)).toString()
</a><a href="#h192-0-487" id="h192-0-487" class="i">+            if (viewState != &quot;FULLY_DISPLAYED&quot;) {
</a><a href="#h192-0-488" id="h192-0-488" class="i">+                return@onOperaViewStateCallback
</a><a href="#h192-0-489" id="h192-0-489" class="i">+            }
</a><a href="#h192-0-490" id="h192-0-490" class="i">+            val operaLayerList = (param.thisObject() as Any).getObjectField(context.mappings.getMappedValue(&quot;OperaPageViewController&quot;, &quot;layerListField&quot;)) as ArrayList&lt;*&gt;
</a><a href="#h192-0-491" id="h192-0-491" class="i">+            val mediaParamMap: ParamMap = operaLayerList.map { Layer(it) }.first().paramMap
</a><a href="#h192-0-492" id="h192-0-492" class="i">+
</a><a href="#h192-0-493" id="h192-0-493" class="i">+            if (!mediaParamMap.containsKey(&quot;image_media_info&quot;) &amp;&amp; !mediaParamMap.containsKey(&quot;video_media_info_list&quot;))
</a><a href="#h192-0-494" id="h192-0-494" class="i">+                return@onOperaViewStateCallback
</a><a href="#h192-0-495" id="h192-0-495" class="i">+
</a><a href="#h192-0-496" id="h192-0-496" class="i">+            val mediaInfoMap = mutableMapOf&lt;SplitMediaAssetType, MediaInfo&gt;()
</a><a href="#h192-0-497" id="h192-0-497" class="i">+            val isVideo = mediaParamMap.containsKey(&quot;video_media_info_list&quot;)
</a><a href="#h192-0-498" id="h192-0-498" class="i">+
</a><a href="#h192-0-499" id="h192-0-499" class="i">+            mediaInfoMap[SplitMediaAssetType.ORIGINAL] = MediaInfo(
</a><a href="#h192-0-500" id="h192-0-500" class="i">+                (if (isVideo) mediaParamMap[&quot;video_media_info_list&quot;] else mediaParamMap[&quot;image_media_info&quot;])!!
</a><a href="#h192-0-501" id="h192-0-501" class="i">+            )
</a><a href="#h192-0-502" id="h192-0-502" class="i">+
</a><a href="#h192-0-503" id="h192-0-503" class="i">+            if (context.config.downloader.mergeOverlays.get() &amp;&amp; mediaParamMap.containsKey(&quot;overlay_image_media_info&quot;)) {
</a><a href="#h192-0-504" id="h192-0-504" class="i">+                mediaInfoMap[SplitMediaAssetType.OVERLAY] =
</a><a href="#h192-0-505" id="h192-0-505" class="i">+                    MediaInfo(mediaParamMap[&quot;overlay_image_media_info&quot;]!!)
</a><a href="#h192-0-506" id="h192-0-506" class="i">+            }
</a><a href="#h192-0-507" id="h192-0-507" class="i">+            lastSeenMapParams = mediaParamMap
</a><a href="#h192-0-508" id="h192-0-508" class="i">+            lastSeenMediaInfoMap = mediaInfoMap
</a><a href="#h192-0-509" id="h192-0-509" class="i">+
</a><a href="#h192-0-510" id="h192-0-510" class="i">+            if (!canAutoDownload()) return@onOperaViewStateCallback
</a><a href="#h192-0-511" id="h192-0-511" class="i">+
</a><a href="#h192-0-512" id="h192-0-512" class="i">+            context.executeAsync {
</a><a href="#h192-0-513" id="h192-0-513" class="i">+                runCatching {
</a><a href="#h192-0-514" id="h192-0-514" class="i">+                    handleOperaMedia(mediaParamMap, mediaInfoMap, false)
</a><a href="#h192-0-515" id="h192-0-515" class="i">+                }.onFailure {
</a><a href="#h192-0-516" id="h192-0-516" class="i">+                    context.log.error(&quot;Failed to handle opera media&quot;, it)
</a><a href="#h192-0-517" id="h192-0-517" class="i">+                    context.longToast(it.message)
</a><a href="#h192-0-518" id="h192-0-518" class="i">+                }
</a><a href="#h192-0-519" id="h192-0-519" class="i">+            }
</a><a href="#h192-0-520" id="h192-0-520" class="i">+        }
</a><a href="#h192-0-521" id="h192-0-521" class="i">+
</a><a href="#h192-0-522" id="h192-0-522" class="i">+        arrayOf(&quot;onDisplayStateChange&quot;, &quot;onDisplayStateChangeGesture&quot;).forEach { methodName -&gt;
</a><a href="#h192-0-523" id="h192-0-523" class="i">+            Hooker.hook(
</a><a href="#h192-0-524" id="h192-0-524" class="i">+                operaViewerControllerClass,
</a><a href="#h192-0-525" id="h192-0-525" class="i">+                context.mappings.getMappedValue(&quot;OperaPageViewController&quot;, methodName),
</a><a href="#h192-0-526" id="h192-0-526" class="i">+                HookStage.AFTER, onOperaViewStateCallback
</a><a href="#h192-0-527" id="h192-0-527" class="i">+            )
</a><a href="#h192-0-528" id="h192-0-528" class="i">+        }
</a><a href="#h192-0-529" id="h192-0-529" class="i">+    }
</a><a href="#h192-0-530" id="h192-0-530" class="i">+
</a><a href="#h192-0-531" id="h192-0-531" class="i">+    private fun downloadMessageAttachments(
</a><a href="#h192-0-532" id="h192-0-532" class="i">+        friendInfo: FriendInfo,
</a><a href="#h192-0-533" id="h192-0-533" class="i">+        message: ConversationMessage,
</a><a href="#h192-0-534" id="h192-0-534" class="i">+        authorName: String,
</a><a href="#h192-0-535" id="h192-0-535" class="i">+        attachments: List&lt;DecodedAttachment&gt;
</a><a href="#h192-0-536" id="h192-0-536" class="i">+    ) {
</a><a href="#h192-0-537" id="h192-0-537" class="i">+        //TODO: stickers
</a><a href="#h192-0-538" id="h192-0-538" class="i">+        attachments.forEach { attachment -&gt;
</a><a href="#h192-0-539" id="h192-0-539" class="i">+            runCatching {
</a><a href="#h192-0-540" id="h192-0-540" class="i">+                provideDownloadManagerClient(
</a><a href="#h192-0-541" id="h192-0-541" class="i">+                    mediaIdentifier = &quot;${message.clientConversationId}${message.senderId}${message.serverMessageId}${attachment.mediaUniqueId}&quot;,
</a><a href="#h192-0-542" id="h192-0-542" class="i">+                    downloadSource = MediaDownloadSource.CHAT_MEDIA,
</a><a href="#h192-0-543" id="h192-0-543" class="i">+                    mediaAuthor = authorName,
</a><a href="#h192-0-544" id="h192-0-544" class="i">+                    friendInfo = friendInfo
</a><a href="#h192-0-545" id="h192-0-545" class="i">+                ).downloadSingleMedia(
</a><a href="#h192-0-546" id="h192-0-546" class="i">+                    mediaData = attachment.mediaUrlKey!!,
</a><a href="#h192-0-547" id="h192-0-547" class="i">+                    mediaType = DownloadMediaType.PROTO_MEDIA,
</a><a href="#h192-0-548" id="h192-0-548" class="i">+                    encryption = attachment.attachmentInfo?.encryption,
</a><a href="#h192-0-549" id="h192-0-549" class="i">+                    attachmentType = attachment.type
</a><a href="#h192-0-550" id="h192-0-550" class="i">+                )
</a><a href="#h192-0-551" id="h192-0-551" class="i">+            }.onFailure {
</a><a href="#h192-0-552" id="h192-0-552" class="i">+                context.longToast(translations[&quot;failed_generic_toast&quot;])
</a><a href="#h192-0-553" id="h192-0-553" class="i">+                context.log.error(&quot;Failed to download&quot;, it)
</a><a href="#h192-0-554" id="h192-0-554" class="i">+            }
</a><a href="#h192-0-555" id="h192-0-555" class="i">+        }
</a><a href="#h192-0-556" id="h192-0-556" class="i">+    }
</a><a href="#h192-0-557" id="h192-0-557" class="i">+
</a><a href="#h192-0-558" id="h192-0-558" class="i">+
</a><a href="#h192-0-559" id="h192-0-559" class="i">+    @SuppressLint(&quot;SetTextI18n&quot;)
</a><a href="#h192-0-560" id="h192-0-560" class="i">+    @OptIn(ExperimentalCoroutinesApi::class)
</a><a href="#h192-0-561" id="h192-0-561" class="i">+    fun downloadMessageId(messageId: Long, isPreview: Boolean = false) {
</a><a href="#h192-0-562" id="h192-0-562" class="i">+        val messageLogger = context.feature(MessageLogger::class)
</a><a href="#h192-0-563" id="h192-0-563" class="i">+        val message = context.database.getConversationMessageFromId(messageId) ?: throw Exception(&quot;Message not found in database&quot;)
</a><a href="#h192-0-564" id="h192-0-564" class="i">+
</a><a href="#h192-0-565" id="h192-0-565" class="i">+        //get the message author
</a><a href="#h192-0-566" id="h192-0-566" class="i">+        val friendInfo: FriendInfo = context.database.getFriendInfo(message.senderId!!) ?: throw Exception(&quot;Friend not found in database&quot;)
</a><a href="#h192-0-567" id="h192-0-567" class="i">+        val authorName = friendInfo.usernameForSorting!!
</a><a href="#h192-0-568" id="h192-0-568" class="i">+
</a><a href="#h192-0-569" id="h192-0-569" class="i">+        val decodedAttachments = messageLogger.takeIf { it.isEnabled }?.getMessageObject(message.clientConversationId!!, message.clientMessageId.toLong())?.let {
</a><a href="#h192-0-570" id="h192-0-570" class="i">+            MessageDecoder.decode(it.getAsJsonObject(&quot;mMessageContent&quot;))
</a><a href="#h192-0-571" id="h192-0-571" class="i">+        } ?: MessageDecoder.decode(
</a><a href="#h192-0-572" id="h192-0-572" class="i">+            protoReader = ProtoReader(message.messageContent!!)
</a><a href="#h192-0-573" id="h192-0-573" class="i">+        )
</a><a href="#h192-0-574" id="h192-0-574" class="i">+
</a><a href="#h192-0-575" id="h192-0-575" class="i">+        if (decodedAttachments.isEmpty()) {
</a><a href="#h192-0-576" id="h192-0-576" class="i">+            context.shortToast(translations[&quot;no_attachments_toast&quot;])
</a><a href="#h192-0-577" id="h192-0-577" class="i">+            return
</a><a href="#h192-0-578" id="h192-0-578" class="i">+        }
</a><a href="#h192-0-579" id="h192-0-579" class="i">+
</a><a href="#h192-0-580" id="h192-0-580" class="i">+        if (!isPreview) {
</a><a href="#h192-0-581" id="h192-0-581" class="i">+            if (decodedAttachments.size == 1 ||
</a><a href="#h192-0-582" id="h192-0-582" class="i">+                context.mainActivity == null // we can&#39;t show alert dialogs when it downloads from a notification, so it downloads the first one
</a><a href="#h192-0-583" id="h192-0-583" class="i">+            ) {
</a><a href="#h192-0-584" id="h192-0-584" class="i">+                downloadMessageAttachments(friendInfo, message, authorName,
</a><a href="#h192-0-585" id="h192-0-585" class="i">+                    listOf(decodedAttachments.first())
</a><a href="#h192-0-586" id="h192-0-586" class="i">+                )
</a><a href="#h192-0-587" id="h192-0-587" class="i">+                return
</a><a href="#h192-0-588" id="h192-0-588" class="i">+            }
</a><a href="#h192-0-589" id="h192-0-589" class="i">+
</a><a href="#h192-0-590" id="h192-0-590" class="i">+            runOnUiThread {
</a><a href="#h192-0-591" id="h192-0-591" class="i">+                ViewAppearanceHelper.newAlertDialogBuilder(context.mainActivity).apply {
</a><a href="#h192-0-592" id="h192-0-592" class="i">+                    val selectedAttachments = mutableListOf&lt;Int&gt;().apply {
</a><a href="#h192-0-593" id="h192-0-593" class="i">+                        addAll(decodedAttachments.indices)
</a><a href="#h192-0-594" id="h192-0-594" class="i">+                    }
</a><a href="#h192-0-595" id="h192-0-595" class="i">+                    setMultiChoiceItems(
</a><a href="#h192-0-596" id="h192-0-596" class="i">+                        decodedAttachments.mapIndexed { index, decodedAttachment -&gt;
</a><a href="#h192-0-597" id="h192-0-597" class="i">+                            &quot;${index + 1}: ${translations[&quot;attachment_type.${decodedAttachment.type.key}&quot;]} ${decodedAttachment.attachmentInfo?.resolution?.let { &quot;(${it.first}x${it.second})&quot; } ?: &quot;&quot;}&quot;
</a><a href="#h192-0-598" id="h192-0-598" class="i">+                        }.toTypedArray(),
</a><a href="#h192-0-599" id="h192-0-599" class="i">+                        decodedAttachments.map { true }.toBooleanArray()
</a><a href="#h192-0-600" id="h192-0-600" class="i">+                    ) { _, which, isChecked -&gt;
</a><a href="#h192-0-601" id="h192-0-601" class="i">+                        if (isChecked) {
</a><a href="#h192-0-602" id="h192-0-602" class="i">+                            selectedAttachments.add(which)
</a><a href="#h192-0-603" id="h192-0-603" class="i">+                        } else if (selectedAttachments.contains(which)) {
</a><a href="#h192-0-604" id="h192-0-604" class="i">+                            selectedAttachments.remove(which)
</a><a href="#h192-0-605" id="h192-0-605" class="i">+                        }
</a><a href="#h192-0-606" id="h192-0-606" class="i">+                    }
</a><a href="#h192-0-607" id="h192-0-607" class="i">+                    setTitle(translations[&quot;select_attachments_title&quot;])
</a><a href="#h192-0-608" id="h192-0-608" class="i">+                    setNegativeButton(this@MediaDownloader.context.translation[&quot;button.cancel&quot;]) { dialog, _ -&gt; dialog.dismiss() }
</a><a href="#h192-0-609" id="h192-0-609" class="i">+                    setPositiveButton(this@MediaDownloader.context.translation[&quot;button.download&quot;]) { _, _ -&gt;
</a><a href="#h192-0-610" id="h192-0-610" class="i">+                        downloadMessageAttachments(friendInfo, message, authorName, selectedAttachments.map { decodedAttachments[it] })
</a><a href="#h192-0-611" id="h192-0-611" class="i">+                    }
</a><a href="#h192-0-612" id="h192-0-612" class="i">+                }.show()
</a><a href="#h192-0-613" id="h192-0-613" class="i">+            }
</a><a href="#h192-0-614" id="h192-0-614" class="i">+
</a><a href="#h192-0-615" id="h192-0-615" class="i">+            return
</a><a href="#h192-0-616" id="h192-0-616" class="i">+        }
</a><a href="#h192-0-617" id="h192-0-617" class="i">+
</a><a href="#h192-0-618" id="h192-0-618" class="i">+        runBlocking {
</a><a href="#h192-0-619" id="h192-0-619" class="i">+            val firstAttachment = decodedAttachments.first()
</a><a href="#h192-0-620" id="h192-0-620" class="i">+
</a><a href="#h192-0-621" id="h192-0-621" class="i">+            val previewCoroutine = async {
</a><a href="#h192-0-622" id="h192-0-622" class="i">+                val downloadedMedia = RemoteMediaResolver.downloadBoltMedia(Base64.decode(firstAttachment.mediaUrlKey!!), decryptionCallback = {
</a><a href="#h192-0-623" id="h192-0-623" class="i">+                    firstAttachment.attachmentInfo?.encryption?.decryptInputStream(it) ?: it
</a><a href="#h192-0-624" id="h192-0-624" class="i">+                }) ?: return@async null
</a><a href="#h192-0-625" id="h192-0-625" class="i">+
</a><a href="#h192-0-626" id="h192-0-626" class="i">+                val downloadedMediaList = mutableMapOf&lt;SplitMediaAssetType, ByteArray&gt;()
</a><a href="#h192-0-627" id="h192-0-627" class="i">+
</a><a href="#h192-0-628" id="h192-0-628" class="i">+                MediaDownloaderHelper.getSplitElements(ByteArrayInputStream(downloadedMedia)) {
</a><a href="#h192-0-629" id="h192-0-629" class="i">+                    type, inputStream -&gt;
</a><a href="#h192-0-630" id="h192-0-630" class="i">+                    downloadedMediaList[type] = inputStream.readBytes()
</a><a href="#h192-0-631" id="h192-0-631" class="i">+                }
</a><a href="#h192-0-632" id="h192-0-632" class="i">+
</a><a href="#h192-0-633" id="h192-0-633" class="i">+                val originalMedia = downloadedMediaList[SplitMediaAssetType.ORIGINAL] ?: return@async null
</a><a href="#h192-0-634" id="h192-0-634" class="i">+                val overlay = downloadedMediaList[SplitMediaAssetType.OVERLAY]
</a><a href="#h192-0-635" id="h192-0-635" class="i">+
</a><a href="#h192-0-636" id="h192-0-636" class="i">+                var bitmap: Bitmap? = PreviewUtils.createPreview(originalMedia, isVideo = FileType.fromByteArray(originalMedia).isVideo)
</a><a href="#h192-0-637" id="h192-0-637" class="i">+
</a><a href="#h192-0-638" id="h192-0-638" class="i">+                if (bitmap == null) {
</a><a href="#h192-0-639" id="h192-0-639" class="i">+                    context.shortToast(translations[&quot;failed_to_create_preview_toast&quot;])
</a><a href="#h192-0-640" id="h192-0-640" class="i">+                    return@async null
</a><a href="#h192-0-641" id="h192-0-641" class="i">+                }
</a><a href="#h192-0-642" id="h192-0-642" class="i">+
</a><a href="#h192-0-643" id="h192-0-643" class="i">+                overlay?.also {
</a><a href="#h192-0-644" id="h192-0-644" class="i">+                    bitmap = PreviewUtils.mergeBitmapOverlay(bitmap!!, BitmapFactory.decodeByteArray(it, 0, it.size))
</a><a href="#h192-0-645" id="h192-0-645" class="i">+                }
</a><a href="#h192-0-646" id="h192-0-646" class="i">+
</a><a href="#h192-0-647" id="h192-0-647" class="i">+                bitmap
</a><a href="#h192-0-648" id="h192-0-648" class="i">+            }
</a><a href="#h192-0-649" id="h192-0-649" class="i">+
</a><a href="#h192-0-650" id="h192-0-650" class="i">+            with(ViewAppearanceHelper.newAlertDialogBuilder(context.mainActivity)) {
</a><a href="#h192-0-651" id="h192-0-651" class="i">+                val viewGroup = LinearLayout(context).apply {
</a><a href="#h192-0-652" id="h192-0-652" class="i">+                    layoutParams = MarginLayoutParams(MarginLayoutParams.MATCH_PARENT, MarginLayoutParams.MATCH_PARENT)
</a><a href="#h192-0-653" id="h192-0-653" class="i">+                    gravity = Gravity.CENTER_HORIZONTAL or Gravity.CENTER_VERTICAL
</a><a href="#h192-0-654" id="h192-0-654" class="i">+                    addView(ProgressBar(context).apply {
</a><a href="#h192-0-655" id="h192-0-655" class="i">+                        isIndeterminate = true
</a><a href="#h192-0-656" id="h192-0-656" class="i">+                    })
</a><a href="#h192-0-657" id="h192-0-657" class="i">+                }
</a><a href="#h192-0-658" id="h192-0-658" class="i">+
</a><a href="#h192-0-659" id="h192-0-659" class="i">+                setOnDismissListener {
</a><a href="#h192-0-660" id="h192-0-660" class="i">+                    previewCoroutine.cancel()
</a><a href="#h192-0-661" id="h192-0-661" class="i">+                }
</a><a href="#h192-0-662" id="h192-0-662" class="i">+
</a><a href="#h192-0-663" id="h192-0-663" class="i">+                previewCoroutine.invokeOnCompletion { cause -&gt;
</a><a href="#h192-0-664" id="h192-0-664" class="i">+                    runOnUiThread {
</a><a href="#h192-0-665" id="h192-0-665" class="i">+                        viewGroup.removeAllViews()
</a><a href="#h192-0-666" id="h192-0-666" class="i">+                        if (cause != null) {
</a><a href="#h192-0-667" id="h192-0-667" class="i">+                            viewGroup.addView(TextView(context).apply {
</a><a href="#h192-0-668" id="h192-0-668" class="i">+                                text = translations[&quot;failed_to_create_preview_toast&quot;] + &quot;\n&quot; + cause.message
</a><a href="#h192-0-669" id="h192-0-669" class="i">+                                setPadding(30, 30, 30, 30)
</a><a href="#h192-0-670" id="h192-0-670" class="i">+                            })
</a><a href="#h192-0-671" id="h192-0-671" class="i">+                            return@runOnUiThread
</a><a href="#h192-0-672" id="h192-0-672" class="i">+                        }
</a><a href="#h192-0-673" id="h192-0-673" class="i">+
</a><a href="#h192-0-674" id="h192-0-674" class="i">+                        viewGroup.addView(ImageView(context).apply {
</a><a href="#h192-0-675" id="h192-0-675" class="i">+                            setImageBitmap(previewCoroutine.getCompleted())
</a><a href="#h192-0-676" id="h192-0-676" class="i">+                            layoutParams = LinearLayout.LayoutParams(
</a><a href="#h192-0-677" id="h192-0-677" class="i">+                                LinearLayout.LayoutParams.MATCH_PARENT,
</a><a href="#h192-0-678" id="h192-0-678" class="i">+                                LinearLayout.LayoutParams.MATCH_PARENT
</a><a href="#h192-0-679" id="h192-0-679" class="i">+                            )
</a><a href="#h192-0-680" id="h192-0-680" class="i">+                            adjustViewBounds = true
</a><a href="#h192-0-681" id="h192-0-681" class="i">+                        })
</a><a href="#h192-0-682" id="h192-0-682" class="i">+                    }
</a><a href="#h192-0-683" id="h192-0-683" class="i">+                }
</a><a href="#h192-0-684" id="h192-0-684" class="i">+
</a><a href="#h192-0-685" id="h192-0-685" class="i">+                runOnUiThread {
</a><a href="#h192-0-686" id="h192-0-686" class="i">+                    show().apply {
</a><a href="#h192-0-687" id="h192-0-687" class="i">+                        setContentView(viewGroup)
</a><a href="#h192-0-688" id="h192-0-688" class="i">+                        window?.setLayout(
</a><a href="#h192-0-689" id="h192-0-689" class="i">+                            context.resources.displayMetrics.widthPixels,
</a><a href="#h192-0-690" id="h192-0-690" class="i">+                            context.resources.displayMetrics.heightPixels
</a><a href="#h192-0-691" id="h192-0-691" class="i">+                        )
</a><a href="#h192-0-692" id="h192-0-692" class="i">+                    }
</a><a href="#h192-0-693" id="h192-0-693" class="i">+                    previewCoroutine.start()
</a><a href="#h192-0-694" id="h192-0-694" class="i">+                }
</a><a href="#h192-0-695" id="h192-0-695" class="i">+            }
</a><a href="#h192-0-696" id="h192-0-696" class="i">+        }
</a><a href="#h192-0-697" id="h192-0-697" class="i">+    }
</a><a href="#h192-0-698" id="h192-0-698" class="i">+
</a><a href="#h192-0-699" id="h192-0-699" class="i">+    fun downloadProfilePicture(url: String, author: String) {
</a><a href="#h192-0-700" id="h192-0-700" class="i">+        provideDownloadManagerClient(
</a><a href="#h192-0-701" id="h192-0-701" class="i">+            mediaIdentifier = url.hashCode().toString(16).replaceFirst(&quot;-&quot;, &quot;&quot;),
</a><a href="#h192-0-702" id="h192-0-702" class="i">+            mediaAuthor = author,
</a><a href="#h192-0-703" id="h192-0-703" class="i">+            downloadSource = MediaDownloadSource.PROFILE_PICTURE
</a><a href="#h192-0-704" id="h192-0-704" class="i">+        ).downloadSingleMedia(
</a><a href="#h192-0-705" id="h192-0-705" class="i">+            url,
</a><a href="#h192-0-706" id="h192-0-706" class="i">+            DownloadMediaType.REMOTE_MEDIA
</a><a href="#h192-0-707" id="h192-0-707" class="i">+        )
</a><a href="#h192-0-708" id="h192-0-708" class="i">+    }
</a><a href="#h192-0-709" id="h192-0-709" class="i">+
</a><a href="#h192-0-710" id="h192-0-710" class="i">+    /**
</a><a href="#h192-0-711" id="h192-0-711" class="i">+     * Called when a message is focused in chat
</a><a href="#h192-0-712" id="h192-0-712" class="i">+     */
</a><a href="#h192-0-713" id="h192-0-713" class="i">+    fun onMessageActionMenu(isPreviewMode: Boolean) {
</a><a href="#h192-0-714" id="h192-0-714" class="i">+        val messaging = context.feature(Messaging::class)
</a><a href="#h192-0-715" id="h192-0-715" class="i">+        if (messaging.openedConversationUUID == null) return
</a><a href="#h192-0-716" id="h192-0-716" class="i">+        downloadMessageId(messaging.lastFocusedMessageId, isPreviewMode)
</a><a href="#h192-0-717" id="h192-0-717" class="i">+    }
</a><a href="#h192-0-718" id="h192-0-718" class="i">+}
</a><b>diff --git a/<a id="h193" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/downloader/ProfilePictureDownloader.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/downloader/ProfilePictureDownloader.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/downloader/ProfilePictureDownloader.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/downloader/ProfilePictureDownloader.kt</a></b>
<a href="#h193-0" id="h193-0" class="h">@@ -0,0 +1,80 @@
</a><a href="#h193-0-0" id="h193-0-0" class="i">+package me.rhunk.snapenhance.core.features.impl.downloader
</a><a href="#h193-0-1" id="h193-0-1" class="i">+
</a><a href="#h193-0-2" id="h193-0-2" class="i">+import android.annotation.SuppressLint
</a><a href="#h193-0-3" id="h193-0-3" class="i">+import android.widget.Button
</a><a href="#h193-0-4" id="h193-0-4" class="i">+import android.widget.RelativeLayout
</a><a href="#h193-0-5" id="h193-0-5" class="i">+import me.rhunk.snapenhance.common.util.protobuf.ProtoReader
</a><a href="#h193-0-6" id="h193-0-6" class="i">+import me.rhunk.snapenhance.core.event.events.impl.AddViewEvent
</a><a href="#h193-0-7" id="h193-0-7" class="i">+import me.rhunk.snapenhance.core.event.events.impl.NetworkApiRequestEvent
</a><a href="#h193-0-8" id="h193-0-8" class="i">+import me.rhunk.snapenhance.core.features.Feature
</a><a href="#h193-0-9" id="h193-0-9" class="i">+import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a><a href="#h193-0-10" id="h193-0-10" class="i">+import me.rhunk.snapenhance.core.ui.ViewAppearanceHelper
</a><a href="#h193-0-11" id="h193-0-11" class="i">+import me.rhunk.snapenhance.core.util.hook.HookStage
</a><a href="#h193-0-12" id="h193-0-12" class="i">+import me.rhunk.snapenhance.core.util.hook.Hooker
</a><a href="#h193-0-13" id="h193-0-13" class="i">+import java.nio.ByteBuffer
</a><a href="#h193-0-14" id="h193-0-14" class="i">+
</a><a href="#h193-0-15" id="h193-0-15" class="i">+class ProfilePictureDownloader : Feature(&quot;ProfilePictureDownloader&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_ASYNC) {
</a><a href="#h193-0-16" id="h193-0-16" class="i">+    @SuppressLint(&quot;SetTextI18n&quot;)
</a><a href="#h193-0-17" id="h193-0-17" class="i">+    override fun asyncOnActivityCreate() {
</a><a href="#h193-0-18" id="h193-0-18" class="i">+        if (!context.config.downloader.downloadProfilePictures.get()) return
</a><a href="#h193-0-19" id="h193-0-19" class="i">+
</a><a href="#h193-0-20" id="h193-0-20" class="i">+        var friendUsername: String? = null
</a><a href="#h193-0-21" id="h193-0-21" class="i">+        var backgroundUrl: String? = null
</a><a href="#h193-0-22" id="h193-0-22" class="i">+        var avatarUrl: String? = null
</a><a href="#h193-0-23" id="h193-0-23" class="i">+
</a><a href="#h193-0-24" id="h193-0-24" class="i">+        context.event.subscribe(AddViewEvent::class) { event -&gt;
</a><a href="#h193-0-25" id="h193-0-25" class="i">+            if (event.view::class.java.name != &quot;com.snap.unifiedpublicprofile.UnifiedPublicProfileView&quot;) return@subscribe
</a><a href="#h193-0-26" id="h193-0-26" class="i">+
</a><a href="#h193-0-27" id="h193-0-27" class="i">+            event.parent.addView(Button(event.parent.context).apply {
</a><a href="#h193-0-28" id="h193-0-28" class="i">+                text = this@ProfilePictureDownloader.context.translation[&quot;profile_picture_downloader.button&quot;]
</a><a href="#h193-0-29" id="h193-0-29" class="i">+                layoutParams = RelativeLayout.LayoutParams(RelativeLayout.LayoutParams.WRAP_CONTENT, RelativeLayout.LayoutParams.WRAP_CONTENT).apply {
</a><a href="#h193-0-30" id="h193-0-30" class="i">+                    setMargins(0, 200, 0, 0)
</a><a href="#h193-0-31" id="h193-0-31" class="i">+                }
</a><a href="#h193-0-32" id="h193-0-32" class="i">+                setOnClickListener {
</a><a href="#h193-0-33" id="h193-0-33" class="i">+                    ViewAppearanceHelper.newAlertDialogBuilder(
</a><a href="#h193-0-34" id="h193-0-34" class="i">+                        this@ProfilePictureDownloader.context.mainActivity!!
</a><a href="#h193-0-35" id="h193-0-35" class="i">+                    ).apply {
</a><a href="#h193-0-36" id="h193-0-36" class="i">+                        setTitle(this@ProfilePictureDownloader.context.translation[&quot;profile_picture_downloader.title&quot;])
</a><a href="#h193-0-37" id="h193-0-37" class="i">+                        val choices = mutableMapOf&lt;String, String&gt;()
</a><a href="#h193-0-38" id="h193-0-38" class="i">+                        backgroundUrl?.let { choices[&quot;avatar_option&quot;] = it }
</a><a href="#h193-0-39" id="h193-0-39" class="i">+                        avatarUrl?.let { choices[&quot;background_option&quot;] = it }
</a><a href="#h193-0-40" id="h193-0-40" class="i">+
</a><a href="#h193-0-41" id="h193-0-41" class="i">+                        setItems(choices.keys.map {
</a><a href="#h193-0-42" id="h193-0-42" class="i">+                            this@ProfilePictureDownloader.context.translation[&quot;profile_picture_downloader.$it&quot;]
</a><a href="#h193-0-43" id="h193-0-43" class="i">+                        }.toTypedArray()) { _, which -&gt;
</a><a href="#h193-0-44" id="h193-0-44" class="i">+                            runCatching {
</a><a href="#h193-0-45" id="h193-0-45" class="i">+                                this@ProfilePictureDownloader.context.feature(MediaDownloader::class).downloadProfilePicture(
</a><a href="#h193-0-46" id="h193-0-46" class="i">+                                    choices.values.elementAt(which),
</a><a href="#h193-0-47" id="h193-0-47" class="i">+                                    friendUsername!!
</a><a href="#h193-0-48" id="h193-0-48" class="i">+                                )
</a><a href="#h193-0-49" id="h193-0-49" class="i">+                            }.onFailure {
</a><a href="#h193-0-50" id="h193-0-50" class="i">+                                this@ProfilePictureDownloader.context.log.error(&quot;Failed to download profile picture&quot;, it)
</a><a href="#h193-0-51" id="h193-0-51" class="i">+                            }
</a><a href="#h193-0-52" id="h193-0-52" class="i">+                        }
</a><a href="#h193-0-53" id="h193-0-53" class="i">+                    }.show()
</a><a href="#h193-0-54" id="h193-0-54" class="i">+                }
</a><a href="#h193-0-55" id="h193-0-55" class="i">+            })
</a><a href="#h193-0-56" id="h193-0-56" class="i">+        }
</a><a href="#h193-0-57" id="h193-0-57" class="i">+
</a><a href="#h193-0-58" id="h193-0-58" class="i">+
</a><a href="#h193-0-59" id="h193-0-59" class="i">+        context.event.subscribe(NetworkApiRequestEvent::class) { event -&gt;
</a><a href="#h193-0-60" id="h193-0-60" class="i">+            if (!event.url.endsWith(&quot;/rpc/getPublicProfile&quot;)) return@subscribe
</a><a href="#h193-0-61" id="h193-0-61" class="i">+            Hooker.ephemeralHookObjectMethod(event.callback::class.java, event.callback, &quot;onSucceeded&quot;, HookStage.BEFORE) { methodParams -&gt;
</a><a href="#h193-0-62" id="h193-0-62" class="i">+                val content = methodParams.arg&lt;ByteBuffer&gt;(2).run {
</a><a href="#h193-0-63" id="h193-0-63" class="i">+                    ByteArray(capacity()).also {
</a><a href="#h193-0-64" id="h193-0-64" class="i">+                        get(it)
</a><a href="#h193-0-65" id="h193-0-65" class="i">+                        position(0)
</a><a href="#h193-0-66" id="h193-0-66" class="i">+                    }
</a><a href="#h193-0-67" id="h193-0-67" class="i">+                }
</a><a href="#h193-0-68" id="h193-0-68" class="i">+
</a><a href="#h193-0-69" id="h193-0-69" class="i">+                ProtoReader(content).followPath(1, 1, 2) {
</a><a href="#h193-0-70" id="h193-0-70" class="i">+                    friendUsername = getString(2) ?: return@followPath
</a><a href="#h193-0-71" id="h193-0-71" class="i">+                    followPath(4) {
</a><a href="#h193-0-72" id="h193-0-72" class="i">+                        backgroundUrl = getString(2)
</a><a href="#h193-0-73" id="h193-0-73" class="i">+                        avatarUrl = getString(100)
</a><a href="#h193-0-74" id="h193-0-74" class="i">+                    }
</a><a href="#h193-0-75" id="h193-0-75" class="i">+                }
</a><a href="#h193-0-76" id="h193-0-76" class="i">+            }
</a><a href="#h193-0-77" id="h193-0-77" class="i">+        }
</a><a href="#h193-0-78" id="h193-0-78" class="i">+    }
</a><a href="#h193-0-79" id="h193-0-79" class="i">+}</a><a href="#h193-0-80" id="h193-0-80" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h194" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/downloader/decoder/AttachmentInfo.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/downloader/decoder/AttachmentInfo.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/downloader/decoder/AttachmentInfo.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/downloader/decoder/AttachmentInfo.kt</a></b>
<a href="#h194-0" id="h194-0" class="h">@@ -0,0 +1,15 @@
</a><a href="#h194-0-0" id="h194-0-0" class="i">+package me.rhunk.snapenhance.core.features.impl.downloader.decoder
</a><a href="#h194-0-1" id="h194-0-1" class="i">+
</a><a href="#h194-0-2" id="h194-0-2" class="i">+import me.rhunk.snapenhance.common.data.download.MediaEncryptionKeyPair
</a><a href="#h194-0-3" id="h194-0-3" class="i">+
</a><a href="#h194-0-4" id="h194-0-4" class="i">+data class BitmojiSticker(
</a><a href="#h194-0-5" id="h194-0-5" class="i">+    val reference: String,
</a><a href="#h194-0-6" id="h194-0-6" class="i">+) : AttachmentInfo()
</a><a href="#h194-0-7" id="h194-0-7" class="i">+
</a><a href="#h194-0-8" id="h194-0-8" class="i">+open class AttachmentInfo(
</a><a href="#h194-0-9" id="h194-0-9" class="i">+    val encryption: MediaEncryptionKeyPair? = null,
</a><a href="#h194-0-10" id="h194-0-10" class="i">+    val resolution: Pair&lt;Int, Int&gt;? = null,
</a><a href="#h194-0-11" id="h194-0-11" class="i">+    val duration: Long? = null
</a><a href="#h194-0-12" id="h194-0-12" class="i">+) {
</a><a href="#h194-0-13" id="h194-0-13" class="i">+    override fun toString() = &quot;AttachmentInfo(encryption=$encryption, resolution=$resolution, duration=$duration)&quot;
</a><a href="#h194-0-14" id="h194-0-14" class="i">+}</a><a href="#h194-0-15" id="h194-0-15" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h195" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/downloader/decoder/AttachmentType.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/downloader/decoder/AttachmentType.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/downloader/decoder/AttachmentType.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/downloader/decoder/AttachmentType.kt</a></b>
<a href="#h195-0" id="h195-0" class="h">@@ -0,0 +1,11 @@
</a><a href="#h195-0-0" id="h195-0-0" class="i">+package me.rhunk.snapenhance.core.features.impl.downloader.decoder
</a><a href="#h195-0-1" id="h195-0-1" class="i">+
</a><a href="#h195-0-2" id="h195-0-2" class="i">+enum class AttachmentType(
</a><a href="#h195-0-3" id="h195-0-3" class="i">+    val key: String,
</a><a href="#h195-0-4" id="h195-0-4" class="i">+) {
</a><a href="#h195-0-5" id="h195-0-5" class="i">+    SNAP(&quot;snap&quot;),
</a><a href="#h195-0-6" id="h195-0-6" class="i">+    STICKER(&quot;sticker&quot;),
</a><a href="#h195-0-7" id="h195-0-7" class="i">+    EXTERNAL_MEDIA(&quot;external_media&quot;),
</a><a href="#h195-0-8" id="h195-0-8" class="i">+    NOTE(&quot;note&quot;),
</a><a href="#h195-0-9" id="h195-0-9" class="i">+    ORIGINAL_STORY(&quot;original_story&quot;),
</a><a href="#h195-0-10" id="h195-0-10" class="i">+}</a><a href="#h195-0-11" id="h195-0-11" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h196" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/downloader/decoder/MessageDecoder.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/downloader/decoder/MessageDecoder.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/downloader/decoder/MessageDecoder.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/downloader/decoder/MessageDecoder.kt</a></b>
<a href="#h196-0" id="h196-0" class="h">@@ -0,0 +1,191 @@
</a><a href="#h196-0-0" id="h196-0-0" class="i">+package me.rhunk.snapenhance.core.features.impl.downloader.decoder
</a><a href="#h196-0-1" id="h196-0-1" class="i">+
</a><a href="#h196-0-2" id="h196-0-2" class="i">+import com.google.gson.GsonBuilder
</a><a href="#h196-0-3" id="h196-0-3" class="i">+import com.google.gson.JsonElement
</a><a href="#h196-0-4" id="h196-0-4" class="i">+import com.google.gson.JsonObject
</a><a href="#h196-0-5" id="h196-0-5" class="i">+import me.rhunk.snapenhance.common.data.download.toKeyPair
</a><a href="#h196-0-6" id="h196-0-6" class="i">+import me.rhunk.snapenhance.common.util.protobuf.ProtoReader
</a><a href="#h196-0-7" id="h196-0-7" class="i">+import me.rhunk.snapenhance.core.wrapper.impl.MessageContent
</a><a href="#h196-0-8" id="h196-0-8" class="i">+import kotlin.io.encoding.Base64
</a><a href="#h196-0-9" id="h196-0-9" class="i">+import kotlin.io.encoding.ExperimentalEncodingApi
</a><a href="#h196-0-10" id="h196-0-10" class="i">+
</a><a href="#h196-0-11" id="h196-0-11" class="i">+data class DecodedAttachment(
</a><a href="#h196-0-12" id="h196-0-12" class="i">+    val mediaUrlKey: String?,
</a><a href="#h196-0-13" id="h196-0-13" class="i">+    val type: AttachmentType,
</a><a href="#h196-0-14" id="h196-0-14" class="i">+    val attachmentInfo: AttachmentInfo?
</a><a href="#h196-0-15" id="h196-0-15" class="i">+) {
</a><a href="#h196-0-16" id="h196-0-16" class="i">+    @OptIn(ExperimentalEncodingApi::class)
</a><a href="#h196-0-17" id="h196-0-17" class="i">+    val mediaUniqueId: String? by lazy {
</a><a href="#h196-0-18" id="h196-0-18" class="i">+        runCatching { Base64.UrlSafe.decode(mediaUrlKey.toString()) }.getOrNull()?.let { ProtoReader(it).getString(2, 2) }
</a><a href="#h196-0-19" id="h196-0-19" class="i">+    }
</a><a href="#h196-0-20" id="h196-0-20" class="i">+}
</a><a href="#h196-0-21" id="h196-0-21" class="i">+
</a><a href="#h196-0-22" id="h196-0-22" class="i">+@OptIn(ExperimentalEncodingApi::class)
</a><a href="#h196-0-23" id="h196-0-23" class="i">+object MessageDecoder {
</a><a href="#h196-0-24" id="h196-0-24" class="i">+    private val gson = GsonBuilder().create()
</a><a href="#h196-0-25" id="h196-0-25" class="i">+
</a><a href="#h196-0-26" id="h196-0-26" class="i">+    private fun decodeAttachment(protoReader: ProtoReader): AttachmentInfo? {
</a><a href="#h196-0-27" id="h196-0-27" class="i">+        val mediaInfo = protoReader.followPath(1, 1) ?: return null
</a><a href="#h196-0-28" id="h196-0-28" class="i">+
</a><a href="#h196-0-29" id="h196-0-29" class="i">+        return AttachmentInfo(
</a><a href="#h196-0-30" id="h196-0-30" class="i">+            encryption = run {
</a><a href="#h196-0-31" id="h196-0-31" class="i">+                val encryptionProtoIndex = if (mediaInfo.contains(19)) 19 else 4
</a><a href="#h196-0-32" id="h196-0-32" class="i">+                val encryptionProto = mediaInfo.followPath(encryptionProtoIndex) ?: return@run null
</a><a href="#h196-0-33" id="h196-0-33" class="i">+
</a><a href="#h196-0-34" id="h196-0-34" class="i">+                var key = encryptionProto.getByteArray(1) ?: return@run null
</a><a href="#h196-0-35" id="h196-0-35" class="i">+                var iv = encryptionProto.getByteArray(2) ?: return@run null
</a><a href="#h196-0-36" id="h196-0-36" class="i">+
</a><a href="#h196-0-37" id="h196-0-37" class="i">+                if (encryptionProtoIndex == 4) {
</a><a href="#h196-0-38" id="h196-0-38" class="i">+                    key = Base64.decode(encryptionProto.getString(1)?.replace(&quot;\n&quot;,&quot;&quot;) ?: return@run null)
</a><a href="#h196-0-39" id="h196-0-39" class="i">+                    iv = Base64.decode(encryptionProto.getString(2)?.replace(&quot;\n&quot;,&quot;&quot;) ?: return@run null)
</a><a href="#h196-0-40" id="h196-0-40" class="i">+                }
</a><a href="#h196-0-41" id="h196-0-41" class="i">+
</a><a href="#h196-0-42" id="h196-0-42" class="i">+                Pair(key, iv).toKeyPair()
</a><a href="#h196-0-43" id="h196-0-43" class="i">+            },
</a><a href="#h196-0-44" id="h196-0-44" class="i">+            resolution = mediaInfo.followPath(5)?.let {
</a><a href="#h196-0-45" id="h196-0-45" class="i">+                (it.getVarInt(1)?.toInt() ?: 0) to (it.getVarInt(2)?.toInt() ?: 0)
</a><a href="#h196-0-46" id="h196-0-46" class="i">+            },
</a><a href="#h196-0-47" id="h196-0-47" class="i">+            duration = mediaInfo.getVarInt(15)   // external medias
</a><a href="#h196-0-48" id="h196-0-48" class="i">+                ?: mediaInfo.getVarInt(13) // audio notes
</a><a href="#h196-0-49" id="h196-0-49" class="i">+        )
</a><a href="#h196-0-50" id="h196-0-50" class="i">+    }
</a><a href="#h196-0-51" id="h196-0-51" class="i">+
</a><a href="#h196-0-52" id="h196-0-52" class="i">+    @OptIn(ExperimentalEncodingApi::class)
</a><a href="#h196-0-53" id="h196-0-53" class="i">+    fun getEncodedMediaReferences(messageContent: JsonElement): List&lt;String&gt; {
</a><a href="#h196-0-54" id="h196-0-54" class="i">+        return getMediaReferences(messageContent).map { reference -&gt;
</a><a href="#h196-0-55" id="h196-0-55" class="i">+                Base64.UrlSafe.encode(
</a><a href="#h196-0-56" id="h196-0-56" class="i">+                    reference.asJsonObject.getAsJsonArray(&quot;mContentObject&quot;).map { it.asByte }.toByteArray()
</a><a href="#h196-0-57" id="h196-0-57" class="i">+                )
</a><a href="#h196-0-58" id="h196-0-58" class="i">+            }
</a><a href="#h196-0-59" id="h196-0-59" class="i">+            .toList()
</a><a href="#h196-0-60" id="h196-0-60" class="i">+    }
</a><a href="#h196-0-61" id="h196-0-61" class="i">+
</a><a href="#h196-0-62" id="h196-0-62" class="i">+    fun getMediaReferences(messageContent: JsonElement): List&lt;JsonElement&gt; {
</a><a href="#h196-0-63" id="h196-0-63" class="i">+        return messageContent.asJsonObject.getAsJsonArray(&quot;mRemoteMediaReferences&quot;)
</a><a href="#h196-0-64" id="h196-0-64" class="i">+            .asSequence()
</a><a href="#h196-0-65" id="h196-0-65" class="i">+            .map { it.asJsonObject.getAsJsonArray(&quot;mMediaReferences&quot;) }
</a><a href="#h196-0-66" id="h196-0-66" class="i">+            .flatten()
</a><a href="#h196-0-67" id="h196-0-67" class="i">+            .sortedBy {
</a><a href="#h196-0-68" id="h196-0-68" class="i">+                it.asJsonObject[&quot;mMediaListId&quot;].asLong
</a><a href="#h196-0-69" id="h196-0-69" class="i">+            }.toList()
</a><a href="#h196-0-70" id="h196-0-70" class="i">+    }
</a><a href="#h196-0-71" id="h196-0-71" class="i">+
</a><a href="#h196-0-72" id="h196-0-72" class="i">+
</a><a href="#h196-0-73" id="h196-0-73" class="i">+    fun decode(messageContent: MessageContent): List&lt;DecodedAttachment&gt; {
</a><a href="#h196-0-74" id="h196-0-74" class="i">+        return decode(
</a><a href="#h196-0-75" id="h196-0-75" class="i">+            ProtoReader(messageContent.content),
</a><a href="#h196-0-76" id="h196-0-76" class="i">+            customMediaReferences = getEncodedMediaReferences(gson.toJsonTree(messageContent.instanceNonNull()))
</a><a href="#h196-0-77" id="h196-0-77" class="i">+        )
</a><a href="#h196-0-78" id="h196-0-78" class="i">+    }
</a><a href="#h196-0-79" id="h196-0-79" class="i">+
</a><a href="#h196-0-80" id="h196-0-80" class="i">+    fun decode(messageContent: JsonObject): List&lt;DecodedAttachment&gt; {
</a><a href="#h196-0-81" id="h196-0-81" class="i">+        return decode(
</a><a href="#h196-0-82" id="h196-0-82" class="i">+            ProtoReader(messageContent.getAsJsonArray(&quot;mContent&quot;)
</a><a href="#h196-0-83" id="h196-0-83" class="i">+                .map { it.asByte }
</a><a href="#h196-0-84" id="h196-0-84" class="i">+                .toByteArray()),
</a><a href="#h196-0-85" id="h196-0-85" class="i">+            customMediaReferences = getEncodedMediaReferences(messageContent)
</a><a href="#h196-0-86" id="h196-0-86" class="i">+        )
</a><a href="#h196-0-87" id="h196-0-87" class="i">+    }
</a><a href="#h196-0-88" id="h196-0-88" class="i">+
</a><a href="#h196-0-89" id="h196-0-89" class="i">+    fun decode(
</a><a href="#h196-0-90" id="h196-0-90" class="i">+        protoReader: ProtoReader,
</a><a href="#h196-0-91" id="h196-0-91" class="i">+        customMediaReferences: List&lt;String&gt;? = null // when customReferences is null it means that the message is from arroyo database
</a><a href="#h196-0-92" id="h196-0-92" class="i">+    ): List&lt;DecodedAttachment&gt; {
</a><a href="#h196-0-93" id="h196-0-93" class="i">+        val decodedAttachment = mutableListOf&lt;DecodedAttachment&gt;()
</a><a href="#h196-0-94" id="h196-0-94" class="i">+        val mediaReferences = mutableListOf&lt;String&gt;()
</a><a href="#h196-0-95" id="h196-0-95" class="i">+        customMediaReferences?.let { mediaReferences.addAll(it) }
</a><a href="#h196-0-96" id="h196-0-96" class="i">+        var mediaKeyIndex = 0
</a><a href="#h196-0-97" id="h196-0-97" class="i">+
</a><a href="#h196-0-98" id="h196-0-98" class="i">+        fun decodeMedia(type: AttachmentType, protoReader: ProtoReader) {
</a><a href="#h196-0-99" id="h196-0-99" class="i">+            decodedAttachment.add(
</a><a href="#h196-0-100" id="h196-0-100" class="i">+                DecodedAttachment(
</a><a href="#h196-0-101" id="h196-0-101" class="i">+                    mediaUrlKey = mediaReferences.getOrNull(mediaKeyIndex++),
</a><a href="#h196-0-102" id="h196-0-102" class="i">+                    type = type,
</a><a href="#h196-0-103" id="h196-0-103" class="i">+                    attachmentInfo = decodeAttachment(protoReader) ?: return
</a><a href="#h196-0-104" id="h196-0-104" class="i">+                )
</a><a href="#h196-0-105" id="h196-0-105" class="i">+            )
</a><a href="#h196-0-106" id="h196-0-106" class="i">+        }
</a><a href="#h196-0-107" id="h196-0-107" class="i">+
</a><a href="#h196-0-108" id="h196-0-108" class="i">+        // for snaps, external media, and original story replies
</a><a href="#h196-0-109" id="h196-0-109" class="i">+        fun decodeDirectMedia(type: AttachmentType, protoReader: ProtoReader) {
</a><a href="#h196-0-110" id="h196-0-110" class="i">+            protoReader.followPath(5) { decodeMedia(type,this) }
</a><a href="#h196-0-111" id="h196-0-111" class="i">+        }
</a><a href="#h196-0-112" id="h196-0-112" class="i">+
</a><a href="#h196-0-113" id="h196-0-113" class="i">+        fun decodeSticker(protoReader: ProtoReader) {
</a><a href="#h196-0-114" id="h196-0-114" class="i">+            protoReader.followPath(1) {
</a><a href="#h196-0-115" id="h196-0-115" class="i">+                decodedAttachment.add(
</a><a href="#h196-0-116" id="h196-0-116" class="i">+                    DecodedAttachment(
</a><a href="#h196-0-117" id="h196-0-117" class="i">+                        mediaUrlKey = null,
</a><a href="#h196-0-118" id="h196-0-118" class="i">+                        type = AttachmentType.STICKER,
</a><a href="#h196-0-119" id="h196-0-119" class="i">+                        attachmentInfo = BitmojiSticker(
</a><a href="#h196-0-120" id="h196-0-120" class="i">+                            reference = getString(2) ?: return@followPath
</a><a href="#h196-0-121" id="h196-0-121" class="i">+                        )
</a><a href="#h196-0-122" id="h196-0-122" class="i">+                    )
</a><a href="#h196-0-123" id="h196-0-123" class="i">+                )
</a><a href="#h196-0-124" id="h196-0-124" class="i">+            }
</a><a href="#h196-0-125" id="h196-0-125" class="i">+        }
</a><a href="#h196-0-126" id="h196-0-126" class="i">+
</a><a href="#h196-0-127" id="h196-0-127" class="i">+        // media keys
</a><a href="#h196-0-128" id="h196-0-128" class="i">+        protoReader.eachBuffer(4, 5) {
</a><a href="#h196-0-129" id="h196-0-129" class="i">+            getByteArray(1, 3)?.also { mediaKey -&gt;
</a><a href="#h196-0-130" id="h196-0-130" class="i">+                mediaReferences.add(Base64.UrlSafe.encode(mediaKey))
</a><a href="#h196-0-131" id="h196-0-131" class="i">+            }
</a><a href="#h196-0-132" id="h196-0-132" class="i">+        }
</a><a href="#h196-0-133" id="h196-0-133" class="i">+
</a><a href="#h196-0-134" id="h196-0-134" class="i">+        val mediaReader = customMediaReferences?.let { protoReader } ?: protoReader.followPath(4, 4) ?: return emptyList()
</a><a href="#h196-0-135" id="h196-0-135" class="i">+
</a><a href="#h196-0-136" id="h196-0-136" class="i">+        mediaReader.apply {
</a><a href="#h196-0-137" id="h196-0-137" class="i">+            // external media
</a><a href="#h196-0-138" id="h196-0-138" class="i">+            eachBuffer(3, 3) {
</a><a href="#h196-0-139" id="h196-0-139" class="i">+                decodeDirectMedia(AttachmentType.EXTERNAL_MEDIA, this)
</a><a href="#h196-0-140" id="h196-0-140" class="i">+            }
</a><a href="#h196-0-141" id="h196-0-141" class="i">+
</a><a href="#h196-0-142" id="h196-0-142" class="i">+            // stickers
</a><a href="#h196-0-143" id="h196-0-143" class="i">+            followPath(4) { decodeSticker(this) }
</a><a href="#h196-0-144" id="h196-0-144" class="i">+
</a><a href="#h196-0-145" id="h196-0-145" class="i">+            // shares
</a><a href="#h196-0-146" id="h196-0-146" class="i">+            followPath(5, 24, 2) {
</a><a href="#h196-0-147" id="h196-0-147" class="i">+                decodeDirectMedia(AttachmentType.EXTERNAL_MEDIA, this)
</a><a href="#h196-0-148" id="h196-0-148" class="i">+            }
</a><a href="#h196-0-149" id="h196-0-149" class="i">+
</a><a href="#h196-0-150" id="h196-0-150" class="i">+            // audio notes
</a><a href="#h196-0-151" id="h196-0-151" class="i">+            followPath(6) note@{
</a><a href="#h196-0-152" id="h196-0-152" class="i">+                val audioNote = decodeAttachment(this) ?: return@note
</a><a href="#h196-0-153" id="h196-0-153" class="i">+
</a><a href="#h196-0-154" id="h196-0-154" class="i">+                decodedAttachment.add(
</a><a href="#h196-0-155" id="h196-0-155" class="i">+                    DecodedAttachment(
</a><a href="#h196-0-156" id="h196-0-156" class="i">+                        mediaUrlKey = mediaReferences.getOrNull(mediaKeyIndex++),
</a><a href="#h196-0-157" id="h196-0-157" class="i">+                        type = AttachmentType.NOTE,
</a><a href="#h196-0-158" id="h196-0-158" class="i">+                        attachmentInfo = audioNote
</a><a href="#h196-0-159" id="h196-0-159" class="i">+                    )
</a><a href="#h196-0-160" id="h196-0-160" class="i">+                )
</a><a href="#h196-0-161" id="h196-0-161" class="i">+            }
</a><a href="#h196-0-162" id="h196-0-162" class="i">+
</a><a href="#h196-0-163" id="h196-0-163" class="i">+            // story replies
</a><a href="#h196-0-164" id="h196-0-164" class="i">+            followPath(7) {
</a><a href="#h196-0-165" id="h196-0-165" class="i">+                // original story reply
</a><a href="#h196-0-166" id="h196-0-166" class="i">+                followPath(3) {
</a><a href="#h196-0-167" id="h196-0-167" class="i">+                    decodeDirectMedia(AttachmentType.ORIGINAL_STORY, this)
</a><a href="#h196-0-168" id="h196-0-168" class="i">+                }
</a><a href="#h196-0-169" id="h196-0-169" class="i">+
</a><a href="#h196-0-170" id="h196-0-170" class="i">+                // external medias
</a><a href="#h196-0-171" id="h196-0-171" class="i">+                followPath(12) {
</a><a href="#h196-0-172" id="h196-0-172" class="i">+                    eachBuffer(3) { decodeDirectMedia(AttachmentType.EXTERNAL_MEDIA, this) }
</a><a href="#h196-0-173" id="h196-0-173" class="i">+                }
</a><a href="#h196-0-174" id="h196-0-174" class="i">+
</a><a href="#h196-0-175" id="h196-0-175" class="i">+                // attached sticker
</a><a href="#h196-0-176" id="h196-0-176" class="i">+                followPath(13) { decodeSticker(this) }
</a><a href="#h196-0-177" id="h196-0-177" class="i">+
</a><a href="#h196-0-178" id="h196-0-178" class="i">+                // attached audio note
</a><a href="#h196-0-179" id="h196-0-179" class="i">+                followPath(15) { decodeMedia(AttachmentType.NOTE, this) }
</a><a href="#h196-0-180" id="h196-0-180" class="i">+            }
</a><a href="#h196-0-181" id="h196-0-181" class="i">+
</a><a href="#h196-0-182" id="h196-0-182" class="i">+            // snaps
</a><a href="#h196-0-183" id="h196-0-183" class="i">+            followPath(11) {
</a><a href="#h196-0-184" id="h196-0-184" class="i">+                decodeDirectMedia(AttachmentType.SNAP, this)
</a><a href="#h196-0-185" id="h196-0-185" class="i">+            }
</a><a href="#h196-0-186" id="h196-0-186" class="i">+        }
</a><a href="#h196-0-187" id="h196-0-187" class="i">+
</a><a href="#h196-0-188" id="h196-0-188" class="i">+        return decodedAttachment
</a><a href="#h196-0-189" id="h196-0-189" class="i">+    }
</a><a href="#h196-0-190" id="h196-0-190" class="i">+}</a><a href="#h196-0-191" id="h196-0-191" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h197" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/AddFriendSourceSpoof.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/AddFriendSourceSpoof.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/AddFriendSourceSpoof.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/AddFriendSourceSpoof.kt</a></b>
<a href="#h197-0" id="h197-0" class="h">@@ -0,0 +1,55 @@
</a><a href="#h197-0-0" id="h197-0-0" class="i">+package me.rhunk.snapenhance.core.features.impl.experiments
</a><a href="#h197-0-1" id="h197-0-1" class="i">+
</a><a href="#h197-0-2" id="h197-0-2" class="i">+import me.rhunk.snapenhance.core.features.Feature
</a><a href="#h197-0-3" id="h197-0-3" class="i">+import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a><a href="#h197-0-4" id="h197-0-4" class="i">+import me.rhunk.snapenhance.core.util.hook.HookStage
</a><a href="#h197-0-5" id="h197-0-5" class="i">+import me.rhunk.snapenhance.core.util.hook.hook
</a><a href="#h197-0-6" id="h197-0-6" class="i">+
</a><a href="#h197-0-7" id="h197-0-7" class="i">+class AddFriendSourceSpoof : Feature(&quot;AddFriendSourceSpoof&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_ASYNC) {
</a><a href="#h197-0-8" id="h197-0-8" class="i">+    override fun asyncOnActivityCreate() {
</a><a href="#h197-0-9" id="h197-0-9" class="i">+        val friendRelationshipChangerMapping = context.mappings.getMappedMap(&quot;FriendRelationshipChanger&quot;)
</a><a href="#h197-0-10" id="h197-0-10" class="i">+
</a><a href="#h197-0-11" id="h197-0-11" class="i">+        findClass(friendRelationshipChangerMapping[&quot;class&quot;].toString())
</a><a href="#h197-0-12" id="h197-0-12" class="i">+            .hook(friendRelationshipChangerMapping[&quot;addFriendMethod&quot;].toString(), HookStage.BEFORE) { param -&gt;
</a><a href="#h197-0-13" id="h197-0-13" class="i">+            val spoofedSource = context.config.experimental.addFriendSourceSpoof.getNullable() ?: return@hook
</a><a href="#h197-0-14" id="h197-0-14" class="i">+
</a><a href="#h197-0-15" id="h197-0-15" class="i">+            context.log.verbose(&quot;addFriendMethod: ${param.args().toList()}&quot;, featureKey)
</a><a href="#h197-0-16" id="h197-0-16" class="i">+
</a><a href="#h197-0-17" id="h197-0-17" class="i">+            fun setEnum(index: Int, value: String) {
</a><a href="#h197-0-18" id="h197-0-18" class="i">+                val enumData = param.arg&lt;Any&gt;(index)
</a><a href="#h197-0-19" id="h197-0-19" class="i">+                enumData::class.java.enumConstants.first { it.toString() == value }.let {
</a><a href="#h197-0-20" id="h197-0-20" class="i">+                    param.setArg(index, it)
</a><a href="#h197-0-21" id="h197-0-21" class="i">+                }
</a><a href="#h197-0-22" id="h197-0-22" class="i">+            }
</a><a href="#h197-0-23" id="h197-0-23" class="i">+
</a><a href="#h197-0-24" id="h197-0-24" class="i">+            when (spoofedSource) {
</a><a href="#h197-0-25" id="h197-0-25" class="i">+                &quot;added_by_group_chat&quot; -&gt; {
</a><a href="#h197-0-26" id="h197-0-26" class="i">+                    setEnum(1, &quot;PROFILE&quot;)
</a><a href="#h197-0-27" id="h197-0-27" class="i">+                    setEnum(2, &quot;GROUP_PROFILE&quot;)
</a><a href="#h197-0-28" id="h197-0-28" class="i">+                    setEnum(3, &quot;ADDED_BY_GROUP_CHAT&quot;)
</a><a href="#h197-0-29" id="h197-0-29" class="i">+                }
</a><a href="#h197-0-30" id="h197-0-30" class="i">+                &quot;added_by_username&quot; -&gt; {
</a><a href="#h197-0-31" id="h197-0-31" class="i">+                    setEnum(1, &quot;SEARCH&quot;)
</a><a href="#h197-0-32" id="h197-0-32" class="i">+                    setEnum(2, &quot;SEARCH&quot;)
</a><a href="#h197-0-33" id="h197-0-33" class="i">+                    setEnum(3, &quot;ADDED_BY_USERNAME&quot;)
</a><a href="#h197-0-34" id="h197-0-34" class="i">+                }
</a><a href="#h197-0-35" id="h197-0-35" class="i">+                &quot;added_by_qr_code&quot; -&gt; {
</a><a href="#h197-0-36" id="h197-0-36" class="i">+                    setEnum(1, &quot;PROFILE&quot;)
</a><a href="#h197-0-37" id="h197-0-37" class="i">+                    setEnum(2, &quot;PROFILE&quot;)
</a><a href="#h197-0-38" id="h197-0-38" class="i">+                    setEnum(3, &quot;ADDED_BY_QR_CODE&quot;)
</a><a href="#h197-0-39" id="h197-0-39" class="i">+                }
</a><a href="#h197-0-40" id="h197-0-40" class="i">+                &quot;added_by_mention&quot; -&gt; {
</a><a href="#h197-0-41" id="h197-0-41" class="i">+                    setEnum(1, &quot;CONTEXT_CARDS&quot;)
</a><a href="#h197-0-42" id="h197-0-42" class="i">+                    setEnum(2, &quot;CONTEXT_CARD&quot;)
</a><a href="#h197-0-43" id="h197-0-43" class="i">+                    setEnum(3, &quot;ADDED_BY_MENTION&quot;)
</a><a href="#h197-0-44" id="h197-0-44" class="i">+                }
</a><a href="#h197-0-45" id="h197-0-45" class="i">+                &quot;added_by_community&quot; -&gt; {
</a><a href="#h197-0-46" id="h197-0-46" class="i">+                    setEnum(1, &quot;PROFILE&quot;)
</a><a href="#h197-0-47" id="h197-0-47" class="i">+                    setEnum(2, &quot;PROFILE&quot;)
</a><a href="#h197-0-48" id="h197-0-48" class="i">+                    setEnum(3, &quot;ADDED_BY_COMMUNITY&quot;)
</a><a href="#h197-0-49" id="h197-0-49" class="i">+                }
</a><a href="#h197-0-50" id="h197-0-50" class="i">+                else -&gt; return@hook
</a><a href="#h197-0-51" id="h197-0-51" class="i">+            }
</a><a href="#h197-0-52" id="h197-0-52" class="i">+        }
</a><a href="#h197-0-53" id="h197-0-53" class="i">+    }
</a><a href="#h197-0-54" id="h197-0-54" class="i">+}</a><a href="#h197-0-55" id="h197-0-55" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h198" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/AmoledDarkMode.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/AmoledDarkMode.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/AmoledDarkMode.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/AmoledDarkMode.kt</a></b>
<a href="#h198-0" id="h198-0" class="h">@@ -0,0 +1,50 @@
</a><a href="#h198-0-0" id="h198-0-0" class="i">+package me.rhunk.snapenhance.core.features.impl.experiments
</a><a href="#h198-0-1" id="h198-0-1" class="i">+
</a><a href="#h198-0-2" id="h198-0-2" class="i">+import android.annotation.SuppressLint
</a><a href="#h198-0-3" id="h198-0-3" class="i">+import android.content.res.TypedArray
</a><a href="#h198-0-4" id="h198-0-4" class="i">+import android.graphics.drawable.ColorDrawable
</a><a href="#h198-0-5" id="h198-0-5" class="i">+import me.rhunk.snapenhance.common.Constants
</a><a href="#h198-0-6" id="h198-0-6" class="i">+import me.rhunk.snapenhance.core.features.Feature
</a><a href="#h198-0-7" id="h198-0-7" class="i">+import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a><a href="#h198-0-8" id="h198-0-8" class="i">+import me.rhunk.snapenhance.core.util.hook.HookStage
</a><a href="#h198-0-9" id="h198-0-9" class="i">+import me.rhunk.snapenhance.core.util.hook.Hooker
</a><a href="#h198-0-10" id="h198-0-10" class="i">+import me.rhunk.snapenhance.core.util.hook.hook
</a><a href="#h198-0-11" id="h198-0-11" class="i">+
</a><a href="#h198-0-12" id="h198-0-12" class="i">+class AmoledDarkMode : Feature(&quot;Amoled Dark Mode&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_SYNC) {
</a><a href="#h198-0-13" id="h198-0-13" class="i">+    @SuppressLint(&quot;DiscouragedApi&quot;)
</a><a href="#h198-0-14" id="h198-0-14" class="i">+    override fun onActivityCreate() {
</a><a href="#h198-0-15" id="h198-0-15" class="i">+        if (!context.config.userInterface.amoledDarkMode.get()) return
</a><a href="#h198-0-16" id="h198-0-16" class="i">+        val attributeCache = mutableMapOf&lt;String, Int&gt;()
</a><a href="#h198-0-17" id="h198-0-17" class="i">+
</a><a href="#h198-0-18" id="h198-0-18" class="i">+        fun getAttribute(name: String): Int {
</a><a href="#h198-0-19" id="h198-0-19" class="i">+            if (attributeCache.containsKey(name)) return attributeCache[name]!!
</a><a href="#h198-0-20" id="h198-0-20" class="i">+            return context.resources.getIdentifier(name, &quot;attr&quot;, Constants.SNAPCHAT_PACKAGE_NAME).also { attributeCache[name] = it }
</a><a href="#h198-0-21" id="h198-0-21" class="i">+        }
</a><a href="#h198-0-22" id="h198-0-22" class="i">+
</a><a href="#h198-0-23" id="h198-0-23" class="i">+        context.androidContext.theme.javaClass.getMethod(&quot;obtainStyledAttributes&quot;, IntArray::class.java).hook(
</a><a href="#h198-0-24" id="h198-0-24" class="i">+            HookStage.AFTER) { param -&gt;
</a><a href="#h198-0-25" id="h198-0-25" class="i">+            val array = param.arg&lt;IntArray&gt;(0)
</a><a href="#h198-0-26" id="h198-0-26" class="i">+            val result = param.getResult() as TypedArray
</a><a href="#h198-0-27" id="h198-0-27" class="i">+
</a><a href="#h198-0-28" id="h198-0-28" class="i">+            fun ephemeralHook(methodName: String, content: Any) {
</a><a href="#h198-0-29" id="h198-0-29" class="i">+                Hooker.ephemeralHookObjectMethod(result::class.java, result, methodName, HookStage.BEFORE) {
</a><a href="#h198-0-30" id="h198-0-30" class="i">+                    it.setResult(content)
</a><a href="#h198-0-31" id="h198-0-31" class="i">+                }
</a><a href="#h198-0-32" id="h198-0-32" class="i">+            }
</a><a href="#h198-0-33" id="h198-0-33" class="i">+
</a><a href="#h198-0-34" id="h198-0-34" class="i">+            when (array[0]) {
</a><a href="#h198-0-35" id="h198-0-35" class="i">+                getAttribute(&quot;sigColorTextPrimary&quot;) -&gt; {
</a><a href="#h198-0-36" id="h198-0-36" class="i">+                    ephemeralHook(&quot;getColor&quot;, 0xFFFFFFFF.toInt())
</a><a href="#h198-0-37" id="h198-0-37" class="i">+                }
</a><a href="#h198-0-38" id="h198-0-38" class="i">+                getAttribute(&quot;sigColorBackgroundMain&quot;),
</a><a href="#h198-0-39" id="h198-0-39" class="i">+                getAttribute(&quot;sigColorBackgroundSurface&quot;) -&gt; {
</a><a href="#h198-0-40" id="h198-0-40" class="i">+                    ephemeralHook(&quot;getColor&quot;, 0xFF000000.toInt())
</a><a href="#h198-0-41" id="h198-0-41" class="i">+                }
</a><a href="#h198-0-42" id="h198-0-42" class="i">+                getAttribute(&quot;actionSheetBackgroundDrawable&quot;),
</a><a href="#h198-0-43" id="h198-0-43" class="i">+                getAttribute(&quot;actionSheetRoundedBackgroundDrawable&quot;) -&gt; {
</a><a href="#h198-0-44" id="h198-0-44" class="i">+                    ephemeralHook(&quot;getDrawable&quot;, ColorDrawable(0xFF000000.toInt()))
</a><a href="#h198-0-45" id="h198-0-45" class="i">+                }
</a><a href="#h198-0-46" id="h198-0-46" class="i">+            }
</a><a href="#h198-0-47" id="h198-0-47" class="i">+        }
</a><a href="#h198-0-48" id="h198-0-48" class="i">+    }
</a><a href="#h198-0-49" id="h198-0-49" class="i">+}</a><a href="#h198-0-50" id="h198-0-50" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h199" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/AppPasscode.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/AppPasscode.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/AppPasscode.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/AppPasscode.kt</a></b>
<a href="#h199-0" id="h199-0" class="h">@@ -0,0 +1,106 @@
</a><a href="#h199-0-0" id="h199-0-0" class="i">+package me.rhunk.snapenhance.core.features.impl.experiments
</a><a href="#h199-0-1" id="h199-0-1" class="i">+
</a><a href="#h199-0-2" id="h199-0-2" class="i">+import android.annotation.SuppressLint
</a><a href="#h199-0-3" id="h199-0-3" class="i">+import android.content.Context
</a><a href="#h199-0-4" id="h199-0-4" class="i">+import android.os.Build
</a><a href="#h199-0-5" id="h199-0-5" class="i">+import android.text.Editable
</a><a href="#h199-0-6" id="h199-0-6" class="i">+import android.text.InputType
</a><a href="#h199-0-7" id="h199-0-7" class="i">+import android.text.TextWatcher
</a><a href="#h199-0-8" id="h199-0-8" class="i">+import android.view.inputmethod.InputMethodManager
</a><a href="#h199-0-9" id="h199-0-9" class="i">+import android.widget.EditText
</a><a href="#h199-0-10" id="h199-0-10" class="i">+import me.rhunk.snapenhance.core.features.Feature
</a><a href="#h199-0-11" id="h199-0-11" class="i">+import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a><a href="#h199-0-12" id="h199-0-12" class="i">+import me.rhunk.snapenhance.core.ui.ViewAppearanceHelper
</a><a href="#h199-0-13" id="h199-0-13" class="i">+
</a><a href="#h199-0-14" id="h199-0-14" class="i">+//TODO: fingerprint unlock
</a><a href="#h199-0-15" id="h199-0-15" class="i">+class AppPasscode : Feature(&quot;App Passcode&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_SYNC) {
</a><a href="#h199-0-16" id="h199-0-16" class="i">+    private var isLocked = false
</a><a href="#h199-0-17" id="h199-0-17" class="i">+
</a><a href="#h199-0-18" id="h199-0-18" class="i">+    private fun setActivityVisibility(isVisible: Boolean) {
</a><a href="#h199-0-19" id="h199-0-19" class="i">+        context.mainActivity?.let {
</a><a href="#h199-0-20" id="h199-0-20" class="i">+            it.window.attributes = it.window.attributes.apply { alpha = if (isVisible) 1.0F else 0.0F }
</a><a href="#h199-0-21" id="h199-0-21" class="i">+        }
</a><a href="#h199-0-22" id="h199-0-22" class="i">+    }
</a><a href="#h199-0-23" id="h199-0-23" class="i">+
</a><a href="#h199-0-24" id="h199-0-24" class="i">+    fun lock() {
</a><a href="#h199-0-25" id="h199-0-25" class="i">+        if (isLocked) return
</a><a href="#h199-0-26" id="h199-0-26" class="i">+        isLocked = true
</a><a href="#h199-0-27" id="h199-0-27" class="i">+        val passcode by context.config.experimental.appPasscode.also {
</a><a href="#h199-0-28" id="h199-0-28" class="i">+            if (it.getNullable()?.isEmpty() != false) return
</a><a href="#h199-0-29" id="h199-0-29" class="i">+        }
</a><a href="#h199-0-30" id="h199-0-30" class="i">+        val isDigitPasscode = passcode.all { it.isDigit() }
</a><a href="#h199-0-31" id="h199-0-31" class="i">+
</a><a href="#h199-0-32" id="h199-0-32" class="i">+        val mainActivity = context.mainActivity!!
</a><a href="#h199-0-33" id="h199-0-33" class="i">+        setActivityVisibility(false)
</a><a href="#h199-0-34" id="h199-0-34" class="i">+
</a><a href="#h199-0-35" id="h199-0-35" class="i">+        val prompt = ViewAppearanceHelper.newAlertDialogBuilder(mainActivity)
</a><a href="#h199-0-36" id="h199-0-36" class="i">+        val createPrompt  = {
</a><a href="#h199-0-37" id="h199-0-37" class="i">+            val alertDialog = prompt.create()
</a><a href="#h199-0-38" id="h199-0-38" class="i">+            val textView = EditText(mainActivity)
</a><a href="#h199-0-39" id="h199-0-39" class="i">+            textView.setSingleLine()
</a><a href="#h199-0-40" id="h199-0-40" class="i">+            textView.inputType = if (isDigitPasscode) {
</a><a href="#h199-0-41" id="h199-0-41" class="i">+                (InputType.TYPE_CLASS_NUMBER or InputType.TYPE_NUMBER_VARIATION_PASSWORD)
</a><a href="#h199-0-42" id="h199-0-42" class="i">+            } else {
</a><a href="#h199-0-43" id="h199-0-43" class="i">+                (InputType.TYPE_CLASS_TEXT or InputType.TYPE_TEXT_VARIATION_PASSWORD)
</a><a href="#h199-0-44" id="h199-0-44" class="i">+            }
</a><a href="#h199-0-45" id="h199-0-45" class="i">+            textView.hint = &quot;Code :&quot;
</a><a href="#h199-0-46" id="h199-0-46" class="i">+            textView.setPadding(100, 100, 100, 100)
</a><a href="#h199-0-47" id="h199-0-47" class="i">+
</a><a href="#h199-0-48" id="h199-0-48" class="i">+            textView.addTextChangedListener(object: TextWatcher {
</a><a href="#h199-0-49" id="h199-0-49" class="i">+                override fun onTextChanged(s: CharSequence?, start: Int, before: Int, count: Int) {
</a><a href="#h199-0-50" id="h199-0-50" class="i">+                    if (s.contentEquals(passcode)) {
</a><a href="#h199-0-51" id="h199-0-51" class="i">+                        alertDialog.dismiss()
</a><a href="#h199-0-52" id="h199-0-52" class="i">+                        isLocked = false
</a><a href="#h199-0-53" id="h199-0-53" class="i">+                        setActivityVisibility(true)
</a><a href="#h199-0-54" id="h199-0-54" class="i">+                    }
</a><a href="#h199-0-55" id="h199-0-55" class="i">+                }
</a><a href="#h199-0-56" id="h199-0-56" class="i">+                override fun beforeTextChanged(s: CharSequence?, start: Int, count: Int, after: Int) {}
</a><a href="#h199-0-57" id="h199-0-57" class="i">+                override fun afterTextChanged(s: Editable?) {}
</a><a href="#h199-0-58" id="h199-0-58" class="i">+            })
</a><a href="#h199-0-59" id="h199-0-59" class="i">+
</a><a href="#h199-0-60" id="h199-0-60" class="i">+            alertDialog.setView(textView)
</a><a href="#h199-0-61" id="h199-0-61" class="i">+
</a><a href="#h199-0-62" id="h199-0-62" class="i">+            textView.viewTreeObserver.addOnWindowFocusChangeListener { hasFocus -&gt;
</a><a href="#h199-0-63" id="h199-0-63" class="i">+                if (!hasFocus) return@addOnWindowFocusChangeListener
</a><a href="#h199-0-64" id="h199-0-64" class="i">+                val imm = mainActivity.getSystemService(Context.INPUT_METHOD_SERVICE) as InputMethodManager
</a><a href="#h199-0-65" id="h199-0-65" class="i">+                imm.showSoftInput(textView, InputMethodManager.SHOW_IMPLICIT)
</a><a href="#h199-0-66" id="h199-0-66" class="i">+            }
</a><a href="#h199-0-67" id="h199-0-67" class="i">+
</a><a href="#h199-0-68" id="h199-0-68" class="i">+            alertDialog.window?.let {
</a><a href="#h199-0-69" id="h199-0-69" class="i">+                it.attributes.verticalMargin = -0.18F
</a><a href="#h199-0-70" id="h199-0-70" class="i">+            }
</a><a href="#h199-0-71" id="h199-0-71" class="i">+
</a><a href="#h199-0-72" id="h199-0-72" class="i">+            alertDialog.show()
</a><a href="#h199-0-73" id="h199-0-73" class="i">+            textView.requestFocus()
</a><a href="#h199-0-74" id="h199-0-74" class="i">+        }
</a><a href="#h199-0-75" id="h199-0-75" class="i">+
</a><a href="#h199-0-76" id="h199-0-76" class="i">+        prompt.setOnCancelListener {
</a><a href="#h199-0-77" id="h199-0-77" class="i">+            createPrompt()
</a><a href="#h199-0-78" id="h199-0-78" class="i">+        }
</a><a href="#h199-0-79" id="h199-0-79" class="i">+
</a><a href="#h199-0-80" id="h199-0-80" class="i">+        createPrompt()
</a><a href="#h199-0-81" id="h199-0-81" class="i">+    }
</a><a href="#h199-0-82" id="h199-0-82" class="i">+
</a><a href="#h199-0-83" id="h199-0-83" class="i">+    @SuppressLint(&quot;MissingPermission&quot;)
</a><a href="#h199-0-84" id="h199-0-84" class="i">+    override fun onActivityCreate() {
</a><a href="#h199-0-85" id="h199-0-85" class="i">+        if (!context.database.hasArroyo()) return
</a><a href="#h199-0-86" id="h199-0-86" class="i">+
</a><a href="#h199-0-87" id="h199-0-87" class="i">+        context.runOnUiThread {
</a><a href="#h199-0-88" id="h199-0-88" class="i">+            lock()
</a><a href="#h199-0-89" id="h199-0-89" class="i">+        }
</a><a href="#h199-0-90" id="h199-0-90" class="i">+
</a><a href="#h199-0-91" id="h199-0-91" class="i">+        if (!context.config.experimental.appLockOnResume.get()) return
</a><a href="#h199-0-92" id="h199-0-92" class="i">+
</a><a href="#h199-0-93" id="h199-0-93" class="i">+        if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.Q) {
</a><a href="#h199-0-94" id="h199-0-94" class="i">+            context.mainActivity?.registerActivityLifecycleCallbacks(object: android.app.Application.ActivityLifecycleCallbacks {
</a><a href="#h199-0-95" id="h199-0-95" class="i">+                override fun onActivityPaused(activity: android.app.Activity) { lock() }
</a><a href="#h199-0-96" id="h199-0-96" class="i">+                override fun onActivityResumed(activity: android.app.Activity) {}
</a><a href="#h199-0-97" id="h199-0-97" class="i">+                override fun onActivityStarted(activity: android.app.Activity) {}
</a><a href="#h199-0-98" id="h199-0-98" class="i">+                override fun onActivityDestroyed(activity: android.app.Activity) {}
</a><a href="#h199-0-99" id="h199-0-99" class="i">+                override fun onActivitySaveInstanceState(activity: android.app.Activity, outState: android.os.Bundle) {}
</a><a href="#h199-0-100" id="h199-0-100" class="i">+                override fun onActivityStopped(activity: android.app.Activity) {}
</a><a href="#h199-0-101" id="h199-0-101" class="i">+                override fun onActivityCreated(activity: android.app.Activity, savedInstanceState: android.os.Bundle?) {}
</a><a href="#h199-0-102" id="h199-0-102" class="i">+            })
</a><a href="#h199-0-103" id="h199-0-103" class="i">+        }
</a><a href="#h199-0-104" id="h199-0-104" class="i">+    }
</a><a href="#h199-0-105" id="h199-0-105" class="i">+}</a><a href="#h199-0-106" id="h199-0-106" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h200" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/DeviceSpooferHook.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/DeviceSpooferHook.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/DeviceSpooferHook.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/DeviceSpooferHook.kt</a></b>
<a href="#h200-0" id="h200-0" class="h">@@ -0,0 +1,93 @@
</a><a href="#h200-0-0" id="h200-0-0" class="i">+package me.rhunk.snapenhance.core.features.impl.experiments
</a><a href="#h200-0-1" id="h200-0-1" class="i">+
</a><a href="#h200-0-2" id="h200-0-2" class="i">+import me.rhunk.snapenhance.core.features.Feature
</a><a href="#h200-0-3" id="h200-0-3" class="i">+import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a><a href="#h200-0-4" id="h200-0-4" class="i">+import me.rhunk.snapenhance.core.util.hook.HookStage
</a><a href="#h200-0-5" id="h200-0-5" class="i">+import me.rhunk.snapenhance.core.util.hook.Hooker
</a><a href="#h200-0-6" id="h200-0-6" class="i">+
</a><a href="#h200-0-7" id="h200-0-7" class="i">+class DeviceSpooferHook: Feature(&quot;device_spoofer&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_ASYNC)  {
</a><a href="#h200-0-8" id="h200-0-8" class="i">+	override fun asyncOnActivityCreate() {
</a><a href="#h200-0-9" id="h200-0-9" class="i">+		if (context.config.experimental.spoof.globalState != true) return
</a><a href="#h200-0-10" id="h200-0-10" class="i">+
</a><a href="#h200-0-11" id="h200-0-11" class="i">+		val fingerprint by context.config.experimental.spoof.device.fingerprint
</a><a href="#h200-0-12" id="h200-0-12" class="i">+		val androidId by context.config.experimental.spoof.device.androidId
</a><a href="#h200-0-13" id="h200-0-13" class="i">+		val getInstallerPackageName by context.config.experimental.spoof.device.getInstallerPackageName
</a><a href="#h200-0-14" id="h200-0-14" class="i">+		val debugFlag by context.config.experimental.spoof.device.debugFlag
</a><a href="#h200-0-15" id="h200-0-15" class="i">+		val mockLocationState by context.config.experimental.spoof.device.mockLocationState
</a><a href="#h200-0-16" id="h200-0-16" class="i">+		val splitClassLoader by context.config.experimental.spoof.device.splitClassLoader
</a><a href="#h200-0-17" id="h200-0-17" class="i">+		val isLowEndDevice by context.config.experimental.spoof.device.isLowEndDevice
</a><a href="#h200-0-18" id="h200-0-18" class="i">+		val getDataDirectory by context.config.experimental.spoof.device.getDataDirectory
</a><a href="#h200-0-19" id="h200-0-19" class="i">+
</a><a href="#h200-0-20" id="h200-0-20" class="i">+		val settingsSecureClass = android.provider.Settings.Secure::class.java
</a><a href="#h200-0-21" id="h200-0-21" class="i">+		val fingerprintClass = android.os.Build::class.java
</a><a href="#h200-0-22" id="h200-0-22" class="i">+		val packageManagerClass = android.content.pm.PackageManager::class.java
</a><a href="#h200-0-23" id="h200-0-23" class="i">+		val applicationInfoClass = android.content.pm.ApplicationInfo::class.java
</a><a href="#h200-0-24" id="h200-0-24" class="i">+
</a><a href="#h200-0-25" id="h200-0-25" class="i">+		//FINGERPRINT
</a><a href="#h200-0-26" id="h200-0-26" class="i">+		if (fingerprint.isNotEmpty()) {
</a><a href="#h200-0-27" id="h200-0-27" class="i">+			Hooker.hook(fingerprintClass, &quot;FINGERPRINT&quot;, HookStage.BEFORE) { hookAdapter -&gt;
</a><a href="#h200-0-28" id="h200-0-28" class="i">+				hookAdapter.setResult(fingerprint)
</a><a href="#h200-0-29" id="h200-0-29" class="i">+				context.log.verbose(&quot;Fingerprint spoofed to $fingerprint&quot;)
</a><a href="#h200-0-30" id="h200-0-30" class="i">+			}
</a><a href="#h200-0-31" id="h200-0-31" class="i">+			Hooker.hook(fingerprintClass, &quot;deriveFingerprint&quot;, HookStage.BEFORE) { hookAdapter -&gt;
</a><a href="#h200-0-32" id="h200-0-32" class="i">+				hookAdapter.setResult(fingerprint)
</a><a href="#h200-0-33" id="h200-0-33" class="i">+				context.log.verbose(&quot;Fingerprint spoofed to $fingerprint&quot;)
</a><a href="#h200-0-34" id="h200-0-34" class="i">+			}
</a><a href="#h200-0-35" id="h200-0-35" class="i">+		}
</a><a href="#h200-0-36" id="h200-0-36" class="i">+
</a><a href="#h200-0-37" id="h200-0-37" class="i">+		//ANDROID ID
</a><a href="#h200-0-38" id="h200-0-38" class="i">+		if (androidId.isNotEmpty()) {
</a><a href="#h200-0-39" id="h200-0-39" class="i">+			Hooker.hook(settingsSecureClass, &quot;getString&quot;, HookStage.BEFORE) { hookAdapter -&gt;
</a><a href="#h200-0-40" id="h200-0-40" class="i">+				if(hookAdapter.args()[1] == &quot;android_id&quot;) {
</a><a href="#h200-0-41" id="h200-0-41" class="i">+					hookAdapter.setResult(androidId)
</a><a href="#h200-0-42" id="h200-0-42" class="i">+					context.log.verbose(&quot;Android ID spoofed to $androidId&quot;)
</a><a href="#h200-0-43" id="h200-0-43" class="i">+				}
</a><a href="#h200-0-44" id="h200-0-44" class="i">+			}
</a><a href="#h200-0-45" id="h200-0-45" class="i">+		}
</a><a href="#h200-0-46" id="h200-0-46" class="i">+
</a><a href="#h200-0-47" id="h200-0-47" class="i">+		//TODO: org.chromium.base.BuildInfo, org.chromium.base.PathUtils getDataDirectory, MushroomDeviceTokenManager(?), TRANSPORT_VPN FLAG, isFromMockProvider, nativeLibraryDir, sourceDir, network capabilities, query all jvm properties
</a><a href="#h200-0-48" id="h200-0-48" class="i">+
</a><a href="#h200-0-49" id="h200-0-49" class="i">+		//INSTALLER PACKAGE NAME
</a><a href="#h200-0-50" id="h200-0-50" class="i">+		if(getInstallerPackageName.isNotEmpty()) {
</a><a href="#h200-0-51" id="h200-0-51" class="i">+			Hooker.hook(packageManagerClass, &quot;getInstallerPackageName&quot;, HookStage.BEFORE) { hookAdapter -&gt;
</a><a href="#h200-0-52" id="h200-0-52" class="i">+				hookAdapter.setResult(getInstallerPackageName)
</a><a href="#h200-0-53" id="h200-0-53" class="i">+			}
</a><a href="#h200-0-54" id="h200-0-54" class="i">+		}
</a><a href="#h200-0-55" id="h200-0-55" class="i">+
</a><a href="#h200-0-56" id="h200-0-56" class="i">+		//DEBUG FLAG
</a><a href="#h200-0-57" id="h200-0-57" class="i">+		Hooker.hook(applicationInfoClass, &quot;FLAG_DEBUGGABLE&quot;, HookStage.BEFORE) { hookAdapter -&gt;
</a><a href="#h200-0-58" id="h200-0-58" class="i">+			hookAdapter.setResult(debugFlag)
</a><a href="#h200-0-59" id="h200-0-59" class="i">+		}
</a><a href="#h200-0-60" id="h200-0-60" class="i">+
</a><a href="#h200-0-61" id="h200-0-61" class="i">+		//MOCK LOCATION
</a><a href="#h200-0-62" id="h200-0-62" class="i">+		Hooker.hook(settingsSecureClass, &quot;getString&quot;, HookStage.BEFORE) { hookAdapter -&gt;
</a><a href="#h200-0-63" id="h200-0-63" class="i">+			if(hookAdapter.args()[1] == &quot;ALLOW_MOCK_LOCATION&quot;) {
</a><a href="#h200-0-64" id="h200-0-64" class="i">+				hookAdapter.setResult(mockLocationState)
</a><a href="#h200-0-65" id="h200-0-65" class="i">+			}
</a><a href="#h200-0-66" id="h200-0-66" class="i">+		}
</a><a href="#h200-0-67" id="h200-0-67" class="i">+
</a><a href="#h200-0-68" id="h200-0-68" class="i">+		//GET SPLIT CLASSLOADER
</a><a href="#h200-0-69" id="h200-0-69" class="i">+		if(splitClassLoader.isNotEmpty()) {
</a><a href="#h200-0-70" id="h200-0-70" class="i">+			Hooker.hook(context.classCache.chromiumJNIUtils, &quot;getSplitClassLoader&quot;, HookStage.BEFORE) { hookAdapter -&gt;
</a><a href="#h200-0-71" id="h200-0-71" class="i">+				hookAdapter.setResult(splitClassLoader)
</a><a href="#h200-0-72" id="h200-0-72" class="i">+			}
</a><a href="#h200-0-73" id="h200-0-73" class="i">+		}
</a><a href="#h200-0-74" id="h200-0-74" class="i">+
</a><a href="#h200-0-75" id="h200-0-75" class="i">+		//ISLOWENDDEVICE
</a><a href="#h200-0-76" id="h200-0-76" class="i">+		if(isLowEndDevice.isNotEmpty()) {
</a><a href="#h200-0-77" id="h200-0-77" class="i">+			Hooker.hook(context.classCache.chromiumBuildInfo, &quot;getAll&quot;, HookStage.BEFORE) { hookAdapter -&gt;
</a><a href="#h200-0-78" id="h200-0-78" class="i">+				hookAdapter.setResult(isLowEndDevice)
</a><a href="#h200-0-79" id="h200-0-79" class="i">+			}
</a><a href="#h200-0-80" id="h200-0-80" class="i">+		}
</a><a href="#h200-0-81" id="h200-0-81" class="i">+
</a><a href="#h200-0-82" id="h200-0-82" class="i">+		//GETDATADIRECTORY
</a><a href="#h200-0-83" id="h200-0-83" class="i">+		if(getDataDirectory.isNotEmpty()) {
</a><a href="#h200-0-84" id="h200-0-84" class="i">+			Hooker.hook(context.classCache.chromiumPathUtils, &quot;getDataDirectory&quot;, HookStage.BEFORE) { hookAdapter -&gt;
</a><a href="#h200-0-85" id="h200-0-85" class="i">+				hookAdapter.setResult(getDataDirectory)
</a><a href="#h200-0-86" id="h200-0-86" class="i">+			}
</a><a href="#h200-0-87" id="h200-0-87" class="i">+		}
</a><a href="#h200-0-88" id="h200-0-88" class="i">+
</a><a href="#h200-0-89" id="h200-0-89" class="i">+		//accessibility_enabled
</a><a href="#h200-0-90" id="h200-0-90" class="i">+		
</a><a href="#h200-0-91" id="h200-0-91" class="i">+	}
</a><a href="#h200-0-92" id="h200-0-92" class="i">+}</a><a href="#h200-0-93" id="h200-0-93" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h201" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/EndToEndEncryption.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/EndToEndEncryption.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/EndToEndEncryption.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/EndToEndEncryption.kt</a></b>
<a href="#h201-0" id="h201-0" class="h">@@ -0,0 +1,500 @@
</a><a href="#h201-0-0" id="h201-0-0" class="i">+package me.rhunk.snapenhance.core.features.impl.experiments
</a><a href="#h201-0-1" id="h201-0-1" class="i">+
</a><a href="#h201-0-2" id="h201-0-2" class="i">+import android.annotation.SuppressLint
</a><a href="#h201-0-3" id="h201-0-3" class="i">+import android.graphics.Canvas
</a><a href="#h201-0-4" id="h201-0-4" class="i">+import android.graphics.Paint
</a><a href="#h201-0-5" id="h201-0-5" class="i">+import android.graphics.drawable.ShapeDrawable
</a><a href="#h201-0-6" id="h201-0-6" class="i">+import android.graphics.drawable.shapes.Shape
</a><a href="#h201-0-7" id="h201-0-7" class="i">+import android.view.View
</a><a href="#h201-0-8" id="h201-0-8" class="i">+import android.view.ViewGroup
</a><a href="#h201-0-9" id="h201-0-9" class="i">+import android.view.ViewGroup.LayoutParams
</a><a href="#h201-0-10" id="h201-0-10" class="i">+import android.view.ViewGroup.MarginLayoutParams
</a><a href="#h201-0-11" id="h201-0-11" class="i">+import android.widget.Button
</a><a href="#h201-0-12" id="h201-0-12" class="i">+import android.widget.TextView
</a><a href="#h201-0-13" id="h201-0-13" class="i">+import me.rhunk.snapenhance.common.data.ContentType
</a><a href="#h201-0-14" id="h201-0-14" class="i">+import me.rhunk.snapenhance.common.data.MessagingRuleType
</a><a href="#h201-0-15" id="h201-0-15" class="i">+import me.rhunk.snapenhance.common.data.RuleState
</a><a href="#h201-0-16" id="h201-0-16" class="i">+import me.rhunk.snapenhance.common.util.protobuf.ProtoEditor
</a><a href="#h201-0-17" id="h201-0-17" class="i">+import me.rhunk.snapenhance.common.util.protobuf.ProtoReader
</a><a href="#h201-0-18" id="h201-0-18" class="i">+import me.rhunk.snapenhance.common.util.protobuf.ProtoWriter
</a><a href="#h201-0-19" id="h201-0-19" class="i">+import me.rhunk.snapenhance.core.event.events.impl.AddViewEvent
</a><a href="#h201-0-20" id="h201-0-20" class="i">+import me.rhunk.snapenhance.core.event.events.impl.BindViewEvent
</a><a href="#h201-0-21" id="h201-0-21" class="i">+import me.rhunk.snapenhance.core.event.events.impl.BuildMessageEvent
</a><a href="#h201-0-22" id="h201-0-22" class="i">+import me.rhunk.snapenhance.core.event.events.impl.SendMessageWithContentEvent
</a><a href="#h201-0-23" id="h201-0-23" class="i">+import me.rhunk.snapenhance.core.event.events.impl.UnaryCallEvent
</a><a href="#h201-0-24" id="h201-0-24" class="i">+import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a><a href="#h201-0-25" id="h201-0-25" class="i">+import me.rhunk.snapenhance.core.features.MessagingRuleFeature
</a><a href="#h201-0-26" id="h201-0-26" class="i">+import me.rhunk.snapenhance.core.features.impl.messaging.Messaging
</a><a href="#h201-0-27" id="h201-0-27" class="i">+import me.rhunk.snapenhance.core.ui.ViewAppearanceHelper
</a><a href="#h201-0-28" id="h201-0-28" class="i">+import me.rhunk.snapenhance.core.ui.addForegroundDrawable
</a><a href="#h201-0-29" id="h201-0-29" class="i">+import me.rhunk.snapenhance.core.ui.removeForegroundDrawable
</a><a href="#h201-0-30" id="h201-0-30" class="i">+import me.rhunk.snapenhance.core.util.EvictingMap
</a><a href="#h201-0-31" id="h201-0-31" class="i">+import me.rhunk.snapenhance.core.util.ktx.getObjectField
</a><a href="#h201-0-32" id="h201-0-32" class="i">+import me.rhunk.snapenhance.core.wrapper.impl.MessageContent
</a><a href="#h201-0-33" id="h201-0-33" class="i">+import me.rhunk.snapenhance.core.wrapper.impl.SnapUUID
</a><a href="#h201-0-34" id="h201-0-34" class="i">+import java.security.MessageDigest
</a><a href="#h201-0-35" id="h201-0-35" class="i">+import kotlin.random.Random
</a><a href="#h201-0-36" id="h201-0-36" class="i">+
</a><a href="#h201-0-37" id="h201-0-37" class="i">+class EndToEndEncryption : MessagingRuleFeature(
</a><a href="#h201-0-38" id="h201-0-38" class="i">+    &quot;EndToEndEncryption&quot;,
</a><a href="#h201-0-39" id="h201-0-39" class="i">+    MessagingRuleType.E2E_ENCRYPTION,
</a><a href="#h201-0-40" id="h201-0-40" class="i">+    loadParams = FeatureLoadParams.ACTIVITY_CREATE_SYNC or FeatureLoadParams.INIT_SYNC or FeatureLoadParams.INIT_ASYNC
</a><a href="#h201-0-41" id="h201-0-41" class="i">+) {
</a><a href="#h201-0-42" id="h201-0-42" class="i">+    private val isEnabled get() = context.config.experimental.e2eEncryption.globalState == true
</a><a href="#h201-0-43" id="h201-0-43" class="i">+    private val e2eeInterface by lazy { context.bridgeClient.getE2eeInterface() }
</a><a href="#h201-0-44" id="h201-0-44" class="i">+
</a><a href="#h201-0-45" id="h201-0-45" class="i">+    companion object {
</a><a href="#h201-0-46" id="h201-0-46" class="i">+        const val REQUEST_PK_MESSAGE_ID = 1
</a><a href="#h201-0-47" id="h201-0-47" class="i">+        const val RESPONSE_SK_MESSAGE_ID = 2
</a><a href="#h201-0-48" id="h201-0-48" class="i">+        const val ENCRYPTED_MESSAGE_ID = 3
</a><a href="#h201-0-49" id="h201-0-49" class="i">+    }
</a><a href="#h201-0-50" id="h201-0-50" class="i">+
</a><a href="#h201-0-51" id="h201-0-51" class="i">+    private val decryptedMessageCache = EvictingMap&lt;Long, Pair&lt;ContentType, ByteArray&gt;&gt;(100)
</a><a href="#h201-0-52" id="h201-0-52" class="i">+
</a><a href="#h201-0-53" id="h201-0-53" class="i">+    private val pkRequests = mutableMapOf&lt;Long, ByteArray&gt;()
</a><a href="#h201-0-54" id="h201-0-54" class="i">+    private val secretResponses = mutableMapOf&lt;Long, ByteArray&gt;()
</a><a href="#h201-0-55" id="h201-0-55" class="i">+    private val encryptedMessages = mutableListOf&lt;Long&gt;()
</a><a href="#h201-0-56" id="h201-0-56" class="i">+
</a><a href="#h201-0-57" id="h201-0-57" class="i">+    private fun getE2EParticipants(conversationId: String): List&lt;String&gt; {
</a><a href="#h201-0-58" id="h201-0-58" class="i">+        return context.database.getConversationParticipants(conversationId)?.filter { friendId -&gt; e2eeInterface.friendKeyExists(friendId) } ?: emptyList()
</a><a href="#h201-0-59" id="h201-0-59" class="i">+    }
</a><a href="#h201-0-60" id="h201-0-60" class="i">+
</a><a href="#h201-0-61" id="h201-0-61" class="i">+    private fun askForKeys(conversationId: String) {
</a><a href="#h201-0-62" id="h201-0-62" class="i">+        val friendId = context.database.getDMOtherParticipant(conversationId) ?: run {
</a><a href="#h201-0-63" id="h201-0-63" class="i">+            context.longToast(&quot;Can&#39;t find friendId for conversationId $conversationId&quot;)
</a><a href="#h201-0-64" id="h201-0-64" class="i">+            return
</a><a href="#h201-0-65" id="h201-0-65" class="i">+        }
</a><a href="#h201-0-66" id="h201-0-66" class="i">+
</a><a href="#h201-0-67" id="h201-0-67" class="i">+        val publicKey = e2eeInterface.createKeyExchange(friendId) ?: run {
</a><a href="#h201-0-68" id="h201-0-68" class="i">+            context.longToast(&quot;Can&#39;t create key exchange for friendId $friendId&quot;)
</a><a href="#h201-0-69" id="h201-0-69" class="i">+            return
</a><a href="#h201-0-70" id="h201-0-70" class="i">+        }
</a><a href="#h201-0-71" id="h201-0-71" class="i">+
</a><a href="#h201-0-72" id="h201-0-72" class="i">+        context.log.verbose(&quot;created publicKey: ${publicKey.contentToString()}&quot;)
</a><a href="#h201-0-73" id="h201-0-73" class="i">+
</a><a href="#h201-0-74" id="h201-0-74" class="i">+        sendCustomMessage(conversationId, REQUEST_PK_MESSAGE_ID) {
</a><a href="#h201-0-75" id="h201-0-75" class="i">+            addBuffer(2, publicKey)
</a><a href="#h201-0-76" id="h201-0-76" class="i">+        }
</a><a href="#h201-0-77" id="h201-0-77" class="i">+    }
</a><a href="#h201-0-78" id="h201-0-78" class="i">+
</a><a href="#h201-0-79" id="h201-0-79" class="i">+    private fun sendCustomMessage(conversationId: String, messageId: Int, message: ProtoWriter.() -&gt; Unit) {
</a><a href="#h201-0-80" id="h201-0-80" class="i">+        context.messageSender.sendCustomChatMessage(
</a><a href="#h201-0-81" id="h201-0-81" class="i">+            listOf(SnapUUID.fromString(conversationId)),
</a><a href="#h201-0-82" id="h201-0-82" class="i">+            ContentType.CHAT,
</a><a href="#h201-0-83" id="h201-0-83" class="i">+            message = {
</a><a href="#h201-0-84" id="h201-0-84" class="i">+                from(2) {
</a><a href="#h201-0-85" id="h201-0-85" class="i">+                    from(1) {
</a><a href="#h201-0-86" id="h201-0-86" class="i">+                        addVarInt(1, messageId)
</a><a href="#h201-0-87" id="h201-0-87" class="i">+                        addBuffer(2, ProtoWriter().apply(message).toByteArray())
</a><a href="#h201-0-88" id="h201-0-88" class="i">+                    }
</a><a href="#h201-0-89" id="h201-0-89" class="i">+                }
</a><a href="#h201-0-90" id="h201-0-90" class="i">+            }
</a><a href="#h201-0-91" id="h201-0-91" class="i">+        )
</a><a href="#h201-0-92" id="h201-0-92" class="i">+    }
</a><a href="#h201-0-93" id="h201-0-93" class="i">+
</a><a href="#h201-0-94" id="h201-0-94" class="i">+    private fun warnKeyOverwrite(friendId: String, block: () -&gt; Unit) {
</a><a href="#h201-0-95" id="h201-0-95" class="i">+        if (!e2eeInterface.friendKeyExists(friendId)) {
</a><a href="#h201-0-96" id="h201-0-96" class="i">+            block()
</a><a href="#h201-0-97" id="h201-0-97" class="i">+            return
</a><a href="#h201-0-98" id="h201-0-98" class="i">+        }
</a><a href="#h201-0-99" id="h201-0-99" class="i">+
</a><a href="#h201-0-100" id="h201-0-100" class="i">+        context.mainActivity?.runOnUiThread {
</a><a href="#h201-0-101" id="h201-0-101" class="i">+            val mainActivity = context.mainActivity ?: return@runOnUiThread
</a><a href="#h201-0-102" id="h201-0-102" class="i">+            ViewAppearanceHelper.newAlertDialogBuilder(mainActivity).apply {
</a><a href="#h201-0-103" id="h201-0-103" class="i">+                setTitle(&quot;End-to-end encryption&quot;)
</a><a href="#h201-0-104" id="h201-0-104" class="i">+                setMessage(&quot;WARNING: This will overwrite your existing key. You will loose access to all encrypted messages from this friend. Are you sure you want to continue?&quot;)
</a><a href="#h201-0-105" id="h201-0-105" class="i">+                setPositiveButton(&quot;Yes&quot;) { _, _ -&gt;
</a><a href="#h201-0-106" id="h201-0-106" class="i">+                    ViewAppearanceHelper.newAlertDialogBuilder(mainActivity).apply {
</a><a href="#h201-0-107" id="h201-0-107" class="i">+                        setTitle(&quot;End-to-end encryption&quot;)
</a><a href="#h201-0-108" id="h201-0-108" class="i">+                        setMessage(&quot;Are you REALLY sure you want to continue? This is your last chance to back out.&quot;)
</a><a href="#h201-0-109" id="h201-0-109" class="i">+                        setNeutralButton(&quot;Yes&quot;) { _, _ -&gt; block() }
</a><a href="#h201-0-110" id="h201-0-110" class="i">+                        setPositiveButton(&quot;No&quot;) { _, _ -&gt; }
</a><a href="#h201-0-111" id="h201-0-111" class="i">+                    }.show()
</a><a href="#h201-0-112" id="h201-0-112" class="i">+                }
</a><a href="#h201-0-113" id="h201-0-113" class="i">+                setNegativeButton(&quot;No&quot;) { _, _ -&gt; }
</a><a href="#h201-0-114" id="h201-0-114" class="i">+            }.show()
</a><a href="#h201-0-115" id="h201-0-115" class="i">+        }
</a><a href="#h201-0-116" id="h201-0-116" class="i">+    }
</a><a href="#h201-0-117" id="h201-0-117" class="i">+
</a><a href="#h201-0-118" id="h201-0-118" class="i">+    private fun handlePublicKeyRequest(conversationId: String, publicKey: ByteArray) {
</a><a href="#h201-0-119" id="h201-0-119" class="i">+        val friendId = context.database.getDMOtherParticipant(conversationId) ?: run {
</a><a href="#h201-0-120" id="h201-0-120" class="i">+            context.longToast(&quot;Can&#39;t find friendId for conversationId $conversationId&quot;)
</a><a href="#h201-0-121" id="h201-0-121" class="i">+            return
</a><a href="#h201-0-122" id="h201-0-122" class="i">+        }
</a><a href="#h201-0-123" id="h201-0-123" class="i">+        warnKeyOverwrite(friendId) {
</a><a href="#h201-0-124" id="h201-0-124" class="i">+            val encapsulatedSecret = e2eeInterface.acceptPairingRequest(friendId, publicKey)
</a><a href="#h201-0-125" id="h201-0-125" class="i">+            if (encapsulatedSecret == null) {
</a><a href="#h201-0-126" id="h201-0-126" class="i">+                context.longToast(&quot;Failed to accept public key&quot;)
</a><a href="#h201-0-127" id="h201-0-127" class="i">+                return@warnKeyOverwrite
</a><a href="#h201-0-128" id="h201-0-128" class="i">+            }
</a><a href="#h201-0-129" id="h201-0-129" class="i">+            context.longToast(&quot;Public key successfully accepted&quot;)
</a><a href="#h201-0-130" id="h201-0-130" class="i">+
</a><a href="#h201-0-131" id="h201-0-131" class="i">+            sendCustomMessage(conversationId, RESPONSE_SK_MESSAGE_ID) {
</a><a href="#h201-0-132" id="h201-0-132" class="i">+                addBuffer(2, encapsulatedSecret)
</a><a href="#h201-0-133" id="h201-0-133" class="i">+            }
</a><a href="#h201-0-134" id="h201-0-134" class="i">+        }
</a><a href="#h201-0-135" id="h201-0-135" class="i">+    }
</a><a href="#h201-0-136" id="h201-0-136" class="i">+
</a><a href="#h201-0-137" id="h201-0-137" class="i">+    private fun handleSecretResponse(conversationId: String, secret: ByteArray) {
</a><a href="#h201-0-138" id="h201-0-138" class="i">+        val friendId = context.database.getDMOtherParticipant(conversationId) ?: run {
</a><a href="#h201-0-139" id="h201-0-139" class="i">+            context.longToast(&quot;Can&#39;t find friendId for conversationId $conversationId&quot;)
</a><a href="#h201-0-140" id="h201-0-140" class="i">+            return
</a><a href="#h201-0-141" id="h201-0-141" class="i">+        }
</a><a href="#h201-0-142" id="h201-0-142" class="i">+        warnKeyOverwrite(friendId) {
</a><a href="#h201-0-143" id="h201-0-143" class="i">+            context.log.verbose(&quot;handleSecretResponse, secret = $secret&quot;)
</a><a href="#h201-0-144" id="h201-0-144" class="i">+            val result = e2eeInterface.acceptPairingResponse(friendId, secret)
</a><a href="#h201-0-145" id="h201-0-145" class="i">+            if (!result) {
</a><a href="#h201-0-146" id="h201-0-146" class="i">+                context.longToast(&quot;Failed to accept secret&quot;)
</a><a href="#h201-0-147" id="h201-0-147" class="i">+                return@warnKeyOverwrite
</a><a href="#h201-0-148" id="h201-0-148" class="i">+            }
</a><a href="#h201-0-149" id="h201-0-149" class="i">+            context.longToast(&quot;Done! You can now exchange encrypted messages with this friend.&quot;)
</a><a href="#h201-0-150" id="h201-0-150" class="i">+        }
</a><a href="#h201-0-151" id="h201-0-151" class="i">+    }
</a><a href="#h201-0-152" id="h201-0-152" class="i">+
</a><a href="#h201-0-153" id="h201-0-153" class="i">+    private fun openManagementPopup() {
</a><a href="#h201-0-154" id="h201-0-154" class="i">+        val conversationId = context.feature(Messaging::class).openedConversationUUID?.toString() ?: return
</a><a href="#h201-0-155" id="h201-0-155" class="i">+        val friendId = context.database.getDMOtherParticipant(conversationId)
</a><a href="#h201-0-156" id="h201-0-156" class="i">+
</a><a href="#h201-0-157" id="h201-0-157" class="i">+        if (friendId == null) {
</a><a href="#h201-0-158" id="h201-0-158" class="i">+            context.shortToast(&quot;This menu is only available in direct messages.&quot;)
</a><a href="#h201-0-159" id="h201-0-159" class="i">+            return
</a><a href="#h201-0-160" id="h201-0-160" class="i">+        }
</a><a href="#h201-0-161" id="h201-0-161" class="i">+
</a><a href="#h201-0-162" id="h201-0-162" class="i">+        val actions = listOf(
</a><a href="#h201-0-163" id="h201-0-163" class="i">+            &quot;Initiate a new shared secret&quot;,
</a><a href="#h201-0-164" id="h201-0-164" class="i">+            &quot;Show shared key fingerprint&quot;
</a><a href="#h201-0-165" id="h201-0-165" class="i">+        )
</a><a href="#h201-0-166" id="h201-0-166" class="i">+
</a><a href="#h201-0-167" id="h201-0-167" class="i">+        ViewAppearanceHelper.newAlertDialogBuilder(context.mainActivity!!).apply {
</a><a href="#h201-0-168" id="h201-0-168" class="i">+            setTitle(&quot;End-to-end encryption&quot;)
</a><a href="#h201-0-169" id="h201-0-169" class="i">+            setItems(actions.toTypedArray()) { _, which -&gt;
</a><a href="#h201-0-170" id="h201-0-170" class="i">+                when (which) {
</a><a href="#h201-0-171" id="h201-0-171" class="i">+                    0 -&gt; {
</a><a href="#h201-0-172" id="h201-0-172" class="i">+                        warnKeyOverwrite(friendId) {
</a><a href="#h201-0-173" id="h201-0-173" class="i">+                            askForKeys(conversationId)
</a><a href="#h201-0-174" id="h201-0-174" class="i">+                        }
</a><a href="#h201-0-175" id="h201-0-175" class="i">+                    }
</a><a href="#h201-0-176" id="h201-0-176" class="i">+                    1 -&gt; {
</a><a href="#h201-0-177" id="h201-0-177" class="i">+                        val fingerprint = e2eeInterface.getSecretFingerprint(friendId)
</a><a href="#h201-0-178" id="h201-0-178" class="i">+                        ViewAppearanceHelper.newAlertDialogBuilder(context).apply {
</a><a href="#h201-0-179" id="h201-0-179" class="i">+                            setTitle(&quot;End-to-end encryption&quot;)
</a><a href="#h201-0-180" id="h201-0-180" class="i">+                            setMessage(&quot;Your fingerprint is:\n\n$fingerprint\n\nMake sure to check if it matches your friend&#39;s fingerprint!&quot;)
</a><a href="#h201-0-181" id="h201-0-181" class="i">+                            setPositiveButton(&quot;OK&quot;) { _, _ -&gt; }
</a><a href="#h201-0-182" id="h201-0-182" class="i">+                        }.show()
</a><a href="#h201-0-183" id="h201-0-183" class="i">+                    }
</a><a href="#h201-0-184" id="h201-0-184" class="i">+                }
</a><a href="#h201-0-185" id="h201-0-185" class="i">+            }
</a><a href="#h201-0-186" id="h201-0-186" class="i">+            setPositiveButton(&quot;OK&quot;) { _, _ -&gt; }
</a><a href="#h201-0-187" id="h201-0-187" class="i">+        }.show()
</a><a href="#h201-0-188" id="h201-0-188" class="i">+    }
</a><a href="#h201-0-189" id="h201-0-189" class="i">+
</a><a href="#h201-0-190" id="h201-0-190" class="i">+    @SuppressLint(&quot;SetTextI18n&quot;, &quot;DiscouragedApi&quot;)
</a><a href="#h201-0-191" id="h201-0-191" class="i">+    override fun onActivityCreate() {
</a><a href="#h201-0-192" id="h201-0-192" class="i">+        if (!isEnabled) return
</a><a href="#h201-0-193" id="h201-0-193" class="i">+        // add button to input bar
</a><a href="#h201-0-194" id="h201-0-194" class="i">+        context.event.subscribe(AddViewEvent::class) { param -&gt;
</a><a href="#h201-0-195" id="h201-0-195" class="i">+            if (param.view.toString().contains(&quot;default_input_bar&quot;)) {
</a><a href="#h201-0-196" id="h201-0-196" class="i">+                (param.view as ViewGroup).addView(TextView(param.view.context).apply {
</a><a href="#h201-0-197" id="h201-0-197" class="i">+                    layoutParams = MarginLayoutParams(LayoutParams.WRAP_CONTENT, LayoutParams.MATCH_PARENT)
</a><a href="#h201-0-198" id="h201-0-198" class="i">+                    setOnClickListener { openManagementPopup() }
</a><a href="#h201-0-199" id="h201-0-199" class="i">+                    setPadding(20, 20, 20, 20)
</a><a href="#h201-0-200" id="h201-0-200" class="i">+                    textSize = 23f
</a><a href="#h201-0-201" id="h201-0-201" class="i">+                    text = &quot;\uD83D\uDD12&quot;
</a><a href="#h201-0-202" id="h201-0-202" class="i">+                })
</a><a href="#h201-0-203" id="h201-0-203" class="i">+            }
</a><a href="#h201-0-204" id="h201-0-204" class="i">+        }
</a><a href="#h201-0-205" id="h201-0-205" class="i">+
</a><a href="#h201-0-206" id="h201-0-206" class="i">+        val encryptedMessageIndicator by context.config.experimental.e2eEncryption.encryptedMessageIndicator
</a><a href="#h201-0-207" id="h201-0-207" class="i">+
</a><a href="#h201-0-208" id="h201-0-208" class="i">+        // hook view binder to add special buttons
</a><a href="#h201-0-209" id="h201-0-209" class="i">+        val receivePublicKeyTag = Random.nextLong().toString(16)
</a><a href="#h201-0-210" id="h201-0-210" class="i">+        val receiveSecretTag = Random.nextLong().toString(16)
</a><a href="#h201-0-211" id="h201-0-211" class="i">+
</a><a href="#h201-0-212" id="h201-0-212" class="i">+        context.event.subscribe(BindViewEvent::class) { event -&gt;
</a><a href="#h201-0-213" id="h201-0-213" class="i">+            event.chatMessage { conversationId, messageId -&gt;
</a><a href="#h201-0-214" id="h201-0-214" class="i">+                val viewGroup = event.view as ViewGroup
</a><a href="#h201-0-215" id="h201-0-215" class="i">+
</a><a href="#h201-0-216" id="h201-0-216" class="i">+                viewGroup.findViewWithTag&lt;View&gt;(receiveSecretTag)?.also {
</a><a href="#h201-0-217" id="h201-0-217" class="i">+                    viewGroup.removeView(it)
</a><a href="#h201-0-218" id="h201-0-218" class="i">+                }
</a><a href="#h201-0-219" id="h201-0-219" class="i">+
</a><a href="#h201-0-220" id="h201-0-220" class="i">+                viewGroup.findViewWithTag&lt;View&gt;(receivePublicKeyTag)?.also {
</a><a href="#h201-0-221" id="h201-0-221" class="i">+                    viewGroup.removeView(it)
</a><a href="#h201-0-222" id="h201-0-222" class="i">+                }
</a><a href="#h201-0-223" id="h201-0-223" class="i">+
</a><a href="#h201-0-224" id="h201-0-224" class="i">+                if (encryptedMessageIndicator) {
</a><a href="#h201-0-225" id="h201-0-225" class="i">+                    viewGroup.removeForegroundDrawable(&quot;encryptedMessage&quot;)
</a><a href="#h201-0-226" id="h201-0-226" class="i">+
</a><a href="#h201-0-227" id="h201-0-227" class="i">+                    if (encryptedMessages.contains(messageId.toLong())) {
</a><a href="#h201-0-228" id="h201-0-228" class="i">+                        viewGroup.addForegroundDrawable(&quot;encryptedMessage&quot;, ShapeDrawable(object: Shape() {
</a><a href="#h201-0-229" id="h201-0-229" class="i">+                            override fun draw(canvas: Canvas, paint: Paint) {
</a><a href="#h201-0-230" id="h201-0-230" class="i">+                                paint.textSize = 20f
</a><a href="#h201-0-231" id="h201-0-231" class="i">+                                canvas.drawText(&quot;\uD83D\uDD12&quot;, 0f, canvas.height / 2f, paint)
</a><a href="#h201-0-232" id="h201-0-232" class="i">+                            }
</a><a href="#h201-0-233" id="h201-0-233" class="i">+                        }))
</a><a href="#h201-0-234" id="h201-0-234" class="i">+                    }
</a><a href="#h201-0-235" id="h201-0-235" class="i">+                }
</a><a href="#h201-0-236" id="h201-0-236" class="i">+
</a><a href="#h201-0-237" id="h201-0-237" class="i">+                secretResponses[messageId.toLong()]?.also { secret -&gt;
</a><a href="#h201-0-238" id="h201-0-238" class="i">+                    viewGroup.addView(Button(context.mainActivity!!).apply {
</a><a href="#h201-0-239" id="h201-0-239" class="i">+                        text = &quot;Accept secret&quot;
</a><a href="#h201-0-240" id="h201-0-240" class="i">+                        tag = receiveSecretTag
</a><a href="#h201-0-241" id="h201-0-241" class="i">+                        setOnClickListener {
</a><a href="#h201-0-242" id="h201-0-242" class="i">+                            handleSecretResponse(conversationId, secret)
</a><a href="#h201-0-243" id="h201-0-243" class="i">+                        }
</a><a href="#h201-0-244" id="h201-0-244" class="i">+                    })
</a><a href="#h201-0-245" id="h201-0-245" class="i">+                }
</a><a href="#h201-0-246" id="h201-0-246" class="i">+
</a><a href="#h201-0-247" id="h201-0-247" class="i">+                pkRequests[messageId.toLong()]?.also { publicKey -&gt;
</a><a href="#h201-0-248" id="h201-0-248" class="i">+                    viewGroup.addView(Button(context.mainActivity!!).apply {
</a><a href="#h201-0-249" id="h201-0-249" class="i">+                        text = &quot;Receive public key&quot;
</a><a href="#h201-0-250" id="h201-0-250" class="i">+                        tag = receivePublicKeyTag
</a><a href="#h201-0-251" id="h201-0-251" class="i">+                        setOnClickListener {
</a><a href="#h201-0-252" id="h201-0-252" class="i">+                            handlePublicKeyRequest(conversationId, publicKey)
</a><a href="#h201-0-253" id="h201-0-253" class="i">+                        }
</a><a href="#h201-0-254" id="h201-0-254" class="i">+                    })
</a><a href="#h201-0-255" id="h201-0-255" class="i">+                }
</a><a href="#h201-0-256" id="h201-0-256" class="i">+            }
</a><a href="#h201-0-257" id="h201-0-257" class="i">+        }
</a><a href="#h201-0-258" id="h201-0-258" class="i">+    }
</a><a href="#h201-0-259" id="h201-0-259" class="i">+
</a><a href="#h201-0-260" id="h201-0-260" class="i">+    private fun fixContentType(contentType: ContentType?, message: ProtoReader)
</a><a href="#h201-0-261" id="h201-0-261" class="i">+        = ContentType.fromMessageContainer(message) ?: contentType
</a><a href="#h201-0-262" id="h201-0-262" class="i">+
</a><a href="#h201-0-263" id="h201-0-263" class="i">+    private fun hashParticipantId(participantId: String, salt: ByteArray): ByteArray {
</a><a href="#h201-0-264" id="h201-0-264" class="i">+        return MessageDigest.getInstance(&quot;SHA-256&quot;).apply {
</a><a href="#h201-0-265" id="h201-0-265" class="i">+            update(participantId.toByteArray())
</a><a href="#h201-0-266" id="h201-0-266" class="i">+            update(salt)
</a><a href="#h201-0-267" id="h201-0-267" class="i">+        }.digest()
</a><a href="#h201-0-268" id="h201-0-268" class="i">+    }
</a><a href="#h201-0-269" id="h201-0-269" class="i">+
</a><a href="#h201-0-270" id="h201-0-270" class="i">+    private fun messageHook(conversationId: String, messageId: Long, senderId: String, messageContent: MessageContent) {
</a><a href="#h201-0-271" id="h201-0-271" class="i">+        if (messageContent.contentType != ContentType.STATUS &amp;&amp; decryptedMessageCache.containsKey(messageId)) {
</a><a href="#h201-0-272" id="h201-0-272" class="i">+            val (contentType, buffer) = decryptedMessageCache[messageId]!!
</a><a href="#h201-0-273" id="h201-0-273" class="i">+            messageContent.contentType = contentType
</a><a href="#h201-0-274" id="h201-0-274" class="i">+            messageContent.content = buffer
</a><a href="#h201-0-275" id="h201-0-275" class="i">+            return
</a><a href="#h201-0-276" id="h201-0-276" class="i">+        }
</a><a href="#h201-0-277" id="h201-0-277" class="i">+
</a><a href="#h201-0-278" id="h201-0-278" class="i">+        val reader = ProtoReader(messageContent.content)
</a><a href="#h201-0-279" id="h201-0-279" class="i">+        messageContent.contentType = fixContentType(messageContent.contentType!!, reader)
</a><a href="#h201-0-280" id="h201-0-280" class="i">+
</a><a href="#h201-0-281" id="h201-0-281" class="i">+        fun setMessageContent(buffer: ByteArray) {
</a><a href="#h201-0-282" id="h201-0-282" class="i">+            messageContent.content = buffer
</a><a href="#h201-0-283" id="h201-0-283" class="i">+            messageContent.contentType = fixContentType(messageContent.contentType, ProtoReader(buffer))
</a><a href="#h201-0-284" id="h201-0-284" class="i">+            decryptedMessageCache[messageId] = messageContent.contentType!! to buffer
</a><a href="#h201-0-285" id="h201-0-285" class="i">+        }
</a><a href="#h201-0-286" id="h201-0-286" class="i">+
</a><a href="#h201-0-287" id="h201-0-287" class="i">+        fun replaceMessageText(text: String) {
</a><a href="#h201-0-288" id="h201-0-288" class="i">+            messageContent.content = ProtoWriter().apply {
</a><a href="#h201-0-289" id="h201-0-289" class="i">+                from(2) {
</a><a href="#h201-0-290" id="h201-0-290" class="i">+                    addString(1, text)
</a><a href="#h201-0-291" id="h201-0-291" class="i">+                }
</a><a href="#h201-0-292" id="h201-0-292" class="i">+            }.toByteArray()
</a><a href="#h201-0-293" id="h201-0-293" class="i">+        }
</a><a href="#h201-0-294" id="h201-0-294" class="i">+
</a><a href="#h201-0-295" id="h201-0-295" class="i">+        // decrypt messages
</a><a href="#h201-0-296" id="h201-0-296" class="i">+        reader.followPath(2, 1) {
</a><a href="#h201-0-297" id="h201-0-297" class="i">+            val messageTypeId = getVarInt(1)?.toInt() ?: return@followPath
</a><a href="#h201-0-298" id="h201-0-298" class="i">+            val isMe = context.database.myUserId == senderId
</a><a href="#h201-0-299" id="h201-0-299" class="i">+            val conversationParticipants by lazy {
</a><a href="#h201-0-300" id="h201-0-300" class="i">+                getE2EParticipants(conversationId)
</a><a href="#h201-0-301" id="h201-0-301" class="i">+            }
</a><a href="#h201-0-302" id="h201-0-302" class="i">+
</a><a href="#h201-0-303" id="h201-0-303" class="i">+            if (messageTypeId == ENCRYPTED_MESSAGE_ID) {
</a><a href="#h201-0-304" id="h201-0-304" class="i">+                runCatching {
</a><a href="#h201-0-305" id="h201-0-305" class="i">+                    eachBuffer(2) {
</a><a href="#h201-0-306" id="h201-0-306" class="i">+                        val participantIdHash = getByteArray(1) ?: return@eachBuffer
</a><a href="#h201-0-307" id="h201-0-307" class="i">+                        val iv = getByteArray(2) ?: return@eachBuffer
</a><a href="#h201-0-308" id="h201-0-308" class="i">+                        val ciphertext = getByteArray(3) ?: return@eachBuffer
</a><a href="#h201-0-309" id="h201-0-309" class="i">+
</a><a href="#h201-0-310" id="h201-0-310" class="i">+                        if (isMe) {
</a><a href="#h201-0-311" id="h201-0-311" class="i">+                            if (conversationParticipants.isEmpty()) return@eachBuffer
</a><a href="#h201-0-312" id="h201-0-312" class="i">+                            val participantId = conversationParticipants.firstOrNull { participantIdHash.contentEquals(hashParticipantId(it, iv)) } ?: return@eachBuffer
</a><a href="#h201-0-313" id="h201-0-313" class="i">+                            setMessageContent(
</a><a href="#h201-0-314" id="h201-0-314" class="i">+                                e2eeInterface.decryptMessage(participantId, ciphertext, iv)
</a><a href="#h201-0-315" id="h201-0-315" class="i">+                            )
</a><a href="#h201-0-316" id="h201-0-316" class="i">+                            encryptedMessages.add(messageId)
</a><a href="#h201-0-317" id="h201-0-317" class="i">+                            return@eachBuffer
</a><a href="#h201-0-318" id="h201-0-318" class="i">+                        }
</a><a href="#h201-0-319" id="h201-0-319" class="i">+
</a><a href="#h201-0-320" id="h201-0-320" class="i">+                        if (!participantIdHash.contentEquals(hashParticipantId(context.database.myUserId, iv))) return@eachBuffer
</a><a href="#h201-0-321" id="h201-0-321" class="i">+
</a><a href="#h201-0-322" id="h201-0-322" class="i">+                        setMessageContent(
</a><a href="#h201-0-323" id="h201-0-323" class="i">+                            e2eeInterface.decryptMessage(senderId, ciphertext, iv)
</a><a href="#h201-0-324" id="h201-0-324" class="i">+                        )
</a><a href="#h201-0-325" id="h201-0-325" class="i">+                        encryptedMessages.add(messageId)
</a><a href="#h201-0-326" id="h201-0-326" class="i">+                    }
</a><a href="#h201-0-327" id="h201-0-327" class="i">+                }.onFailure {
</a><a href="#h201-0-328" id="h201-0-328" class="i">+                    context.log.error(&quot;Failed to decrypt message id: $messageId&quot;, it)
</a><a href="#h201-0-329" id="h201-0-329" class="i">+                    messageContent.contentType = ContentType.CHAT
</a><a href="#h201-0-330" id="h201-0-330" class="i">+                    messageContent.content = ProtoWriter().apply {
</a><a href="#h201-0-331" id="h201-0-331" class="i">+                        from(2) {
</a><a href="#h201-0-332" id="h201-0-332" class="i">+                            addString(1, &quot;Failed to decrypt message, id=$messageId. Check logcat for more details.&quot;)
</a><a href="#h201-0-333" id="h201-0-333" class="i">+                        }
</a><a href="#h201-0-334" id="h201-0-334" class="i">+                    }.toByteArray()
</a><a href="#h201-0-335" id="h201-0-335" class="i">+                }
</a><a href="#h201-0-336" id="h201-0-336" class="i">+
</a><a href="#h201-0-337" id="h201-0-337" class="i">+                return@followPath
</a><a href="#h201-0-338" id="h201-0-338" class="i">+            }
</a><a href="#h201-0-339" id="h201-0-339" class="i">+
</a><a href="#h201-0-340" id="h201-0-340" class="i">+            val payload = getByteArray(2, 2) ?: return@followPath
</a><a href="#h201-0-341" id="h201-0-341" class="i">+
</a><a href="#h201-0-342" id="h201-0-342" class="i">+            if (senderId == context.database.myUserId) {
</a><a href="#h201-0-343" id="h201-0-343" class="i">+                when (messageTypeId) {
</a><a href="#h201-0-344" id="h201-0-344" class="i">+                    REQUEST_PK_MESSAGE_ID -&gt; {
</a><a href="#h201-0-345" id="h201-0-345" class="i">+                        replaceMessageText(&quot;[Key exchange request]&quot;)
</a><a href="#h201-0-346" id="h201-0-346" class="i">+                    }
</a><a href="#h201-0-347" id="h201-0-347" class="i">+                    RESPONSE_SK_MESSAGE_ID -&gt; {
</a><a href="#h201-0-348" id="h201-0-348" class="i">+                        replaceMessageText(&quot;[Key exchange response]&quot;)
</a><a href="#h201-0-349" id="h201-0-349" class="i">+                    }
</a><a href="#h201-0-350" id="h201-0-350" class="i">+                }
</a><a href="#h201-0-351" id="h201-0-351" class="i">+                return@followPath
</a><a href="#h201-0-352" id="h201-0-352" class="i">+            }
</a><a href="#h201-0-353" id="h201-0-353" class="i">+
</a><a href="#h201-0-354" id="h201-0-354" class="i">+            when (messageTypeId) {
</a><a href="#h201-0-355" id="h201-0-355" class="i">+                REQUEST_PK_MESSAGE_ID -&gt; {
</a><a href="#h201-0-356" id="h201-0-356" class="i">+                    pkRequests[messageId] = payload
</a><a href="#h201-0-357" id="h201-0-357" class="i">+                    replaceMessageText(&quot;You just received a public key request. Click below to accept it.&quot;)
</a><a href="#h201-0-358" id="h201-0-358" class="i">+                }
</a><a href="#h201-0-359" id="h201-0-359" class="i">+                RESPONSE_SK_MESSAGE_ID -&gt; {
</a><a href="#h201-0-360" id="h201-0-360" class="i">+                    secretResponses[messageId] = payload
</a><a href="#h201-0-361" id="h201-0-361" class="i">+                    replaceMessageText(&quot;Your friend just accepted your public key. Click below to accept the secret.&quot;)
</a><a href="#h201-0-362" id="h201-0-362" class="i">+                }
</a><a href="#h201-0-363" id="h201-0-363" class="i">+            }
</a><a href="#h201-0-364" id="h201-0-364" class="i">+        }
</a><a href="#h201-0-365" id="h201-0-365" class="i">+    }
</a><a href="#h201-0-366" id="h201-0-366" class="i">+
</a><a href="#h201-0-367" id="h201-0-367" class="i">+    override fun asyncInit() {
</a><a href="#h201-0-368" id="h201-0-368" class="i">+        if (!isEnabled) return
</a><a href="#h201-0-369" id="h201-0-369" class="i">+        val forceMessageEncryption by context.config.experimental.e2eEncryption.forceMessageEncryption
</a><a href="#h201-0-370" id="h201-0-370" class="i">+
</a><a href="#h201-0-371" id="h201-0-371" class="i">+        // trick to disable fidelius encryption
</a><a href="#h201-0-372" id="h201-0-372" class="i">+        context.event.subscribe(SendMessageWithContentEvent::class) { event -&gt;
</a><a href="#h201-0-373" id="h201-0-373" class="i">+            val messageContent = event.messageContent
</a><a href="#h201-0-374" id="h201-0-374" class="i">+            val destinations = event.destinations
</a><a href="#h201-0-375" id="h201-0-375" class="i">+
</a><a href="#h201-0-376" id="h201-0-376" class="i">+            val e2eeConversations = destinations.conversations.filter { getState(it.toString()) }
</a><a href="#h201-0-377" id="h201-0-377" class="i">+
</a><a href="#h201-0-378" id="h201-0-378" class="i">+            if (e2eeConversations.isEmpty()) return@subscribe
</a><a href="#h201-0-379" id="h201-0-379" class="i">+
</a><a href="#h201-0-380" id="h201-0-380" class="i">+            if (e2eeConversations.size != destinations.conversations.size) {
</a><a href="#h201-0-381" id="h201-0-381" class="i">+                if (!forceMessageEncryption) return@subscribe
</a><a href="#h201-0-382" id="h201-0-382" class="i">+                context.longToast(&quot;You can&#39;t send encrypted content to both encrypted and unencrypted conversations!&quot;)
</a><a href="#h201-0-383" id="h201-0-383" class="i">+                event.canceled = true
</a><a href="#h201-0-384" id="h201-0-384" class="i">+                return@subscribe
</a><a href="#h201-0-385" id="h201-0-385" class="i">+            }
</a><a href="#h201-0-386" id="h201-0-386" class="i">+
</a><a href="#h201-0-387" id="h201-0-387" class="i">+            event.addInvokeLater {
</a><a href="#h201-0-388" id="h201-0-388" class="i">+                if (messageContent.contentType == ContentType.SNAP) {
</a><a href="#h201-0-389" id="h201-0-389" class="i">+                    messageContent.contentType = ContentType.EXTERNAL_MEDIA
</a><a href="#h201-0-390" id="h201-0-390" class="i">+                }
</a><a href="#h201-0-391" id="h201-0-391" class="i">+
</a><a href="#h201-0-392" id="h201-0-392" class="i">+                if (messageContent.contentType == ContentType.CHAT) {
</a><a href="#h201-0-393" id="h201-0-393" class="i">+                    messageContent.contentType = ContentType.SHARE
</a><a href="#h201-0-394" id="h201-0-394" class="i">+                }
</a><a href="#h201-0-395" id="h201-0-395" class="i">+            }
</a><a href="#h201-0-396" id="h201-0-396" class="i">+        }
</a><a href="#h201-0-397" id="h201-0-397" class="i">+
</a><a href="#h201-0-398" id="h201-0-398" class="i">+        context.event.subscribe(UnaryCallEvent::class) { event -&gt;
</a><a href="#h201-0-399" id="h201-0-399" class="i">+            if (event.uri != &quot;/messagingcoreservice.MessagingCoreService/CreateContentMessage&quot;) return@subscribe
</a><a href="#h201-0-400" id="h201-0-400" class="i">+            val protoReader = ProtoReader(event.buffer)
</a><a href="#h201-0-401" id="h201-0-401" class="i">+
</a><a href="#h201-0-402" id="h201-0-402" class="i">+            val conversationIds = mutableListOf&lt;SnapUUID&gt;()
</a><a href="#h201-0-403" id="h201-0-403" class="i">+            protoReader.eachBuffer(3) {
</a><a href="#h201-0-404" id="h201-0-404" class="i">+                conversationIds.add(SnapUUID.fromBytes(getByteArray(1, 1, 1) ?: return@eachBuffer))
</a><a href="#h201-0-405" id="h201-0-405" class="i">+            }
</a><a href="#h201-0-406" id="h201-0-406" class="i">+
</a><a href="#h201-0-407" id="h201-0-407" class="i">+            if (conversationIds.any { !getState(it.toString()) }) {
</a><a href="#h201-0-408" id="h201-0-408" class="i">+                context.log.debug(&quot;Skipping encryption for conversation ids: ${conversationIds.joinToString(&quot;, &quot;)}&quot;)
</a><a href="#h201-0-409" id="h201-0-409" class="i">+                return@subscribe
</a><a href="#h201-0-410" id="h201-0-410" class="i">+            }
</a><a href="#h201-0-411" id="h201-0-411" class="i">+
</a><a href="#h201-0-412" id="h201-0-412" class="i">+            val participantsIds = conversationIds.map { getE2EParticipants(it.toString()) }.flatten().distinct()
</a><a href="#h201-0-413" id="h201-0-413" class="i">+
</a><a href="#h201-0-414" id="h201-0-414" class="i">+            if (participantsIds.isEmpty()) {
</a><a href="#h201-0-415" id="h201-0-415" class="i">+                context.longToast(&quot;You don&#39;t have any friends in this conversation to encrypt messages with!&quot;)
</a><a href="#h201-0-416" id="h201-0-416" class="i">+                return@subscribe
</a><a href="#h201-0-417" id="h201-0-417" class="i">+            }
</a><a href="#h201-0-418" id="h201-0-418" class="i">+            val messageReader = protoReader.followPath(4) ?: return@subscribe
</a><a href="#h201-0-419" id="h201-0-419" class="i">+
</a><a href="#h201-0-420" id="h201-0-420" class="i">+            if (messageReader.getVarInt(4, 2, 1, 1) != null) {
</a><a href="#h201-0-421" id="h201-0-421" class="i">+                return@subscribe
</a><a href="#h201-0-422" id="h201-0-422" class="i">+            }
</a><a href="#h201-0-423" id="h201-0-423" class="i">+
</a><a href="#h201-0-424" id="h201-0-424" class="i">+            event.buffer = ProtoEditor(event.buffer).apply {
</a><a href="#h201-0-425" id="h201-0-425" class="i">+                val contentType = fixContentType(
</a><a href="#h201-0-426" id="h201-0-426" class="i">+                    ContentType.fromId(messageReader.getVarInt(2)?.toInt() ?: -1),
</a><a href="#h201-0-427" id="h201-0-427" class="i">+                    messageReader.followPath(4) ?: return@apply
</a><a href="#h201-0-428" id="h201-0-428" class="i">+                ) ?: return@apply
</a><a href="#h201-0-429" id="h201-0-429" class="i">+                val messageContent = messageReader.getByteArray(4) ?: return@apply
</a><a href="#h201-0-430" id="h201-0-430" class="i">+
</a><a href="#h201-0-431" id="h201-0-431" class="i">+                runCatching {
</a><a href="#h201-0-432" id="h201-0-432" class="i">+                    edit(4) {
</a><a href="#h201-0-433" id="h201-0-433" class="i">+                        //set message content type
</a><a href="#h201-0-434" id="h201-0-434" class="i">+                        remove(2)
</a><a href="#h201-0-435" id="h201-0-435" class="i">+                        addVarInt(2, contentType.id)
</a><a href="#h201-0-436" id="h201-0-436" class="i">+
</a><a href="#h201-0-437" id="h201-0-437" class="i">+                        //set encrypted content
</a><a href="#h201-0-438" id="h201-0-438" class="i">+                        remove(4)
</a><a href="#h201-0-439" id="h201-0-439" class="i">+                        add(4) {
</a><a href="#h201-0-440" id="h201-0-440" class="i">+                            from(2) {
</a><a href="#h201-0-441" id="h201-0-441" class="i">+                                from(1) {
</a><a href="#h201-0-442" id="h201-0-442" class="i">+                                    addVarInt(1, ENCRYPTED_MESSAGE_ID)
</a><a href="#h201-0-443" id="h201-0-443" class="i">+                                    participantsIds.forEach { participantId -&gt;
</a><a href="#h201-0-444" id="h201-0-444" class="i">+                                        val encryptedMessage = e2eeInterface.encryptMessage(participantId,
</a><a href="#h201-0-445" id="h201-0-445" class="i">+                                            messageContent
</a><a href="#h201-0-446" id="h201-0-446" class="i">+                                        ) ?: run {
</a><a href="#h201-0-447" id="h201-0-447" class="i">+                                            context.log.error(&quot;Failed to encrypt message for $participantId&quot;)
</a><a href="#h201-0-448" id="h201-0-448" class="i">+                                            return@forEach
</a><a href="#h201-0-449" id="h201-0-449" class="i">+                                        }
</a><a href="#h201-0-450" id="h201-0-450" class="i">+                                        context.log.debug(&quot;encrypted message size = ${encryptedMessage.ciphertext.size} for $participantId&quot;)
</a><a href="#h201-0-451" id="h201-0-451" class="i">+                                        from(2) {
</a><a href="#h201-0-452" id="h201-0-452" class="i">+                                            // participantId is hashed with iv to prevent leaking it when sending to multiple conversations
</a><a href="#h201-0-453" id="h201-0-453" class="i">+                                            addBuffer(1, hashParticipantId(participantId, encryptedMessage.iv))
</a><a href="#h201-0-454" id="h201-0-454" class="i">+                                            addBuffer(2, encryptedMessage.iv)
</a><a href="#h201-0-455" id="h201-0-455" class="i">+                                            addBuffer(3, encryptedMessage.ciphertext)
</a><a href="#h201-0-456" id="h201-0-456" class="i">+                                        }
</a><a href="#h201-0-457" id="h201-0-457" class="i">+                                    }
</a><a href="#h201-0-458" id="h201-0-458" class="i">+                                }
</a><a href="#h201-0-459" id="h201-0-459" class="i">+                            }
</a><a href="#h201-0-460" id="h201-0-460" class="i">+                        }
</a><a href="#h201-0-461" id="h201-0-461" class="i">+                    }
</a><a href="#h201-0-462" id="h201-0-462" class="i">+                }.onFailure {
</a><a href="#h201-0-463" id="h201-0-463" class="i">+                    event.canceled = true
</a><a href="#h201-0-464" id="h201-0-464" class="i">+                    context.log.error(&quot;Failed to encrypt message&quot;, it)
</a><a href="#h201-0-465" id="h201-0-465" class="i">+                    context.longToast(&quot;Failed to encrypt message! Check logcat for more details.&quot;)
</a><a href="#h201-0-466" id="h201-0-466" class="i">+                }
</a><a href="#h201-0-467" id="h201-0-467" class="i">+            }.toByteArray()
</a><a href="#h201-0-468" id="h201-0-468" class="i">+        }
</a><a href="#h201-0-469" id="h201-0-469" class="i">+    }
</a><a href="#h201-0-470" id="h201-0-470" class="i">+
</a><a href="#h201-0-471" id="h201-0-471" class="i">+    override fun init() {
</a><a href="#h201-0-472" id="h201-0-472" class="i">+        if (!isEnabled) return
</a><a href="#h201-0-473" id="h201-0-473" class="i">+
</a><a href="#h201-0-474" id="h201-0-474" class="i">+        context.event.subscribe(BuildMessageEvent::class, priority = 0) { event -&gt;
</a><a href="#h201-0-475" id="h201-0-475" class="i">+            val message = event.message
</a><a href="#h201-0-476" id="h201-0-476" class="i">+            val conversationId = message.messageDescriptor.conversationId.toString()
</a><a href="#h201-0-477" id="h201-0-477" class="i">+            messageHook(
</a><a href="#h201-0-478" id="h201-0-478" class="i">+                conversationId = conversationId,
</a><a href="#h201-0-479" id="h201-0-479" class="i">+                messageId = message.messageDescriptor.messageId,
</a><a href="#h201-0-480" id="h201-0-480" class="i">+                senderId = message.senderId.toString(),
</a><a href="#h201-0-481" id="h201-0-481" class="i">+                messageContent = message.messageContent
</a><a href="#h201-0-482" id="h201-0-482" class="i">+            )
</a><a href="#h201-0-483" id="h201-0-483" class="i">+
</a><a href="#h201-0-484" id="h201-0-484" class="i">+            message.messageContent.instanceNonNull()
</a><a href="#h201-0-485" id="h201-0-485" class="i">+                .getObjectField(&quot;mQuotedMessage&quot;)
</a><a href="#h201-0-486" id="h201-0-486" class="i">+                ?.getObjectField(&quot;mContent&quot;)
</a><a href="#h201-0-487" id="h201-0-487" class="i">+                ?.also { quotedMessage -&gt;
</a><a href="#h201-0-488" id="h201-0-488" class="i">+                messageHook(
</a><a href="#h201-0-489" id="h201-0-489" class="i">+                    conversationId = conversationId,
</a><a href="#h201-0-490" id="h201-0-490" class="i">+                    messageId = quotedMessage.getObjectField(&quot;mMessageId&quot;)?.toString()?.toLong() ?: return@also,
</a><a href="#h201-0-491" id="h201-0-491" class="i">+                    senderId = SnapUUID(quotedMessage.getObjectField(&quot;mSenderId&quot;)).toString(),
</a><a href="#h201-0-492" id="h201-0-492" class="i">+                    messageContent = MessageContent(quotedMessage)
</a><a href="#h201-0-493" id="h201-0-493" class="i">+                )
</a><a href="#h201-0-494" id="h201-0-494" class="i">+            }
</a><a href="#h201-0-495" id="h201-0-495" class="i">+        }
</a><a href="#h201-0-496" id="h201-0-496" class="i">+    }
</a><a href="#h201-0-497" id="h201-0-497" class="i">+
</a><a href="#h201-0-498" id="h201-0-498" class="i">+    override fun getRuleState() = RuleState.WHITELIST
</a><a href="#h201-0-499" id="h201-0-499" class="i">+}</a><a href="#h201-0-500" id="h201-0-500" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h202" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/InfiniteStoryBoost.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/InfiniteStoryBoost.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/InfiniteStoryBoost.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/InfiniteStoryBoost.kt</a></b>
<a href="#h202-0" id="h202-0" class="h">@@ -0,0 +1,23 @@
</a><a href="#h202-0-0" id="h202-0-0" class="i">+package me.rhunk.snapenhance.core.features.impl.experiments
</a><a href="#h202-0-1" id="h202-0-1" class="i">+
</a><a href="#h202-0-2" id="h202-0-2" class="i">+import me.rhunk.snapenhance.core.features.Feature
</a><a href="#h202-0-3" id="h202-0-3" class="i">+import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a><a href="#h202-0-4" id="h202-0-4" class="i">+import me.rhunk.snapenhance.core.util.hook.HookStage
</a><a href="#h202-0-5" id="h202-0-5" class="i">+import me.rhunk.snapenhance.core.util.hook.hookConstructor
</a><a href="#h202-0-6" id="h202-0-6" class="i">+
</a><a href="#h202-0-7" id="h202-0-7" class="i">+class InfiniteStoryBoost : Feature(&quot;InfiniteStoryBoost&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_ASYNC) {
</a><a href="#h202-0-8" id="h202-0-8" class="i">+    override fun asyncOnActivityCreate() {
</a><a href="#h202-0-9" id="h202-0-9" class="i">+        val storyBoostStateClass = context.mappings.getMappedClass(&quot;StoryBoostStateClass&quot;)
</a><a href="#h202-0-10" id="h202-0-10" class="i">+
</a><a href="#h202-0-11" id="h202-0-11" class="i">+        storyBoostStateClass.hookConstructor(HookStage.BEFORE, {
</a><a href="#h202-0-12" id="h202-0-12" class="i">+            context.config.experimental.infiniteStoryBoost.get()
</a><a href="#h202-0-13" id="h202-0-13" class="i">+        }) { param -&gt;
</a><a href="#h202-0-14" id="h202-0-14" class="i">+            val startTimeMillis = param.arg&lt;Long&gt;(1)
</a><a href="#h202-0-15" id="h202-0-15" class="i">+            //reset timestamp if it&#39;s more than 24 hours
</a><a href="#h202-0-16" id="h202-0-16" class="i">+            if (System.currentTimeMillis() - startTimeMillis &gt; 86400000) {
</a><a href="#h202-0-17" id="h202-0-17" class="i">+                param.setArg(1, 0)
</a><a href="#h202-0-18" id="h202-0-18" class="i">+                param.setArg(2, 0)
</a><a href="#h202-0-19" id="h202-0-19" class="i">+            }
</a><a href="#h202-0-20" id="h202-0-20" class="i">+        }
</a><a href="#h202-0-21" id="h202-0-21" class="i">+    }
</a><a href="#h202-0-22" id="h202-0-22" class="i">+}</a><a href="#h202-0-23" id="h202-0-23" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h203" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/MeoPasscodeBypass.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/MeoPasscodeBypass.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/MeoPasscodeBypass.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/MeoPasscodeBypass.kt</a></b>
<a href="#h203-0" id="h203-0" class="h">@@ -0,0 +1,22 @@
</a><a href="#h203-0-0" id="h203-0-0" class="i">+package me.rhunk.snapenhance.core.features.impl.experiments
</a><a href="#h203-0-1" id="h203-0-1" class="i">+
</a><a href="#h203-0-2" id="h203-0-2" class="i">+import me.rhunk.snapenhance.core.features.Feature
</a><a href="#h203-0-3" id="h203-0-3" class="i">+import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a><a href="#h203-0-4" id="h203-0-4" class="i">+import me.rhunk.snapenhance.core.util.hook.HookStage
</a><a href="#h203-0-5" id="h203-0-5" class="i">+import me.rhunk.snapenhance.core.util.hook.Hooker
</a><a href="#h203-0-6" id="h203-0-6" class="i">+
</a><a href="#h203-0-7" id="h203-0-7" class="i">+class MeoPasscodeBypass : Feature(&quot;Meo Passcode Bypass&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_ASYNC) {
</a><a href="#h203-0-8" id="h203-0-8" class="i">+    override fun asyncOnActivityCreate() {
</a><a href="#h203-0-9" id="h203-0-9" class="i">+        val bcrypt = context.mappings.getMappedMap(&quot;BCrypt&quot;)
</a><a href="#h203-0-10" id="h203-0-10" class="i">+
</a><a href="#h203-0-11" id="h203-0-11" class="i">+        Hooker.hook(
</a><a href="#h203-0-12" id="h203-0-12" class="i">+            context.androidContext.classLoader.loadClass(bcrypt[&quot;class&quot;].toString()),
</a><a href="#h203-0-13" id="h203-0-13" class="i">+            bcrypt[&quot;hashMethod&quot;].toString(),
</a><a href="#h203-0-14" id="h203-0-14" class="i">+            HookStage.BEFORE,
</a><a href="#h203-0-15" id="h203-0-15" class="i">+            { context.config.experimental.meoPasscodeBypass.get() },
</a><a href="#h203-0-16" id="h203-0-16" class="i">+        ) { param -&gt;
</a><a href="#h203-0-17" id="h203-0-17" class="i">+            //set the hash to the result of the method
</a><a href="#h203-0-18" id="h203-0-18" class="i">+            param.setResult(param.arg(1))
</a><a href="#h203-0-19" id="h203-0-19" class="i">+        }
</a><a href="#h203-0-20" id="h203-0-20" class="i">+    }
</a><a href="#h203-0-21" id="h203-0-21" class="i">+}</a><a href="#h203-0-22" id="h203-0-22" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h204" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/NoFriendScoreDelay.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/NoFriendScoreDelay.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/NoFriendScoreDelay.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/NoFriendScoreDelay.kt</a></b>
<a href="#h204-0" id="h204-0" class="h">@@ -0,0 +1,20 @@
</a><a href="#h204-0-0" id="h204-0-0" class="i">+package me.rhunk.snapenhance.core.features.impl.experiments
</a><a href="#h204-0-1" id="h204-0-1" class="i">+
</a><a href="#h204-0-2" id="h204-0-2" class="i">+import me.rhunk.snapenhance.core.features.Feature
</a><a href="#h204-0-3" id="h204-0-3" class="i">+import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a><a href="#h204-0-4" id="h204-0-4" class="i">+import me.rhunk.snapenhance.core.util.hook.HookStage
</a><a href="#h204-0-5" id="h204-0-5" class="i">+import me.rhunk.snapenhance.core.util.hook.hookConstructor
</a><a href="#h204-0-6" id="h204-0-6" class="i">+import java.lang.reflect.Constructor
</a><a href="#h204-0-7" id="h204-0-7" class="i">+
</a><a href="#h204-0-8" id="h204-0-8" class="i">+class NoFriendScoreDelay : Feature(&quot;NoFriendScoreDelay&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_SYNC) {
</a><a href="#h204-0-9" id="h204-0-9" class="i">+    override fun onActivityCreate() {
</a><a href="#h204-0-10" id="h204-0-10" class="i">+        if (!context.config.experimental.noFriendScoreDelay.get()) return
</a><a href="#h204-0-11" id="h204-0-11" class="i">+        val scoreUpdateClass = context.mappings.getMappedClass(&quot;ScoreUpdate&quot;)
</a><a href="#h204-0-12" id="h204-0-12" class="i">+
</a><a href="#h204-0-13" id="h204-0-13" class="i">+        scoreUpdateClass.hookConstructor(HookStage.BEFORE) { param -&gt;
</a><a href="#h204-0-14" id="h204-0-14" class="i">+            val constructor = param.method() as Constructor&lt;*&gt;
</a><a href="#h204-0-15" id="h204-0-15" class="i">+            if (constructor.parameterTypes.size &lt; 3 || constructor.parameterTypes[3] != java.util.Collection::class.java) return@hookConstructor
</a><a href="#h204-0-16" id="h204-0-16" class="i">+            param.setArg(2, 0L)
</a><a href="#h204-0-17" id="h204-0-17" class="i">+        }
</a><a href="#h204-0-18" id="h204-0-18" class="i">+    }
</a><a href="#h204-0-19" id="h204-0-19" class="i">+}</a><a href="#h204-0-20" id="h204-0-20" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h205" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/UnlimitedMultiSnap.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/UnlimitedMultiSnap.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/UnlimitedMultiSnap.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/UnlimitedMultiSnap.kt</a></b>
<a href="#h205-0" id="h205-0" class="h">@@ -0,0 +1,24 @@
</a><a href="#h205-0-0" id="h205-0-0" class="i">+package me.rhunk.snapenhance.core.features.impl.experiments
</a><a href="#h205-0-1" id="h205-0-1" class="i">+
</a><a href="#h205-0-2" id="h205-0-2" class="i">+import me.rhunk.snapenhance.core.features.Feature
</a><a href="#h205-0-3" id="h205-0-3" class="i">+import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a><a href="#h205-0-4" id="h205-0-4" class="i">+import me.rhunk.snapenhance.core.util.hook.HookStage
</a><a href="#h205-0-5" id="h205-0-5" class="i">+import me.rhunk.snapenhance.core.util.hook.hookConstructor
</a><a href="#h205-0-6" id="h205-0-6" class="i">+import me.rhunk.snapenhance.core.util.ktx.setObjectField
</a><a href="#h205-0-7" id="h205-0-7" class="i">+
</a><a href="#h205-0-8" id="h205-0-8" class="i">+class UnlimitedMultiSnap : Feature(&quot;UnlimitedMultiSnap&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_ASYNC) {
</a><a href="#h205-0-9" id="h205-0-9" class="i">+    override fun asyncOnActivityCreate() {
</a><a href="#h205-0-10" id="h205-0-10" class="i">+        android.util.Pair::class.java.hookConstructor(HookStage.AFTER, {
</a><a href="#h205-0-11" id="h205-0-11" class="i">+            context.config.experimental.unlimitedMultiSnap.get()
</a><a href="#h205-0-12" id="h205-0-12" class="i">+        }) { param -&gt;
</a><a href="#h205-0-13" id="h205-0-13" class="i">+            val first = param.arg&lt;Any&gt;(0)
</a><a href="#h205-0-14" id="h205-0-14" class="i">+            val second = param.arg&lt;Any&gt;(1)
</a><a href="#h205-0-15" id="h205-0-15" class="i">+            if (
</a><a href="#h205-0-16" id="h205-0-16" class="i">+                first == true &amp;&amp; // isOverTheLimit
</a><a href="#h205-0-17" id="h205-0-17" class="i">+                second == 8 // limit
</a><a href="#h205-0-18" id="h205-0-18" class="i">+            ) {
</a><a href="#h205-0-19" id="h205-0-19" class="i">+                param.thisObject&lt;Any&gt;().setObjectField(&quot;first&quot;, false)
</a><a href="#h205-0-20" id="h205-0-20" class="i">+            }
</a><a href="#h205-0-21" id="h205-0-21" class="i">+        }
</a><a href="#h205-0-22" id="h205-0-22" class="i">+    }
</a><a href="#h205-0-23" id="h205-0-23" class="i">+}</a><a href="#h205-0-24" id="h205-0-24" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h206" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/BypassVideoLengthRestriction.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/BypassVideoLengthRestriction.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/BypassVideoLengthRestriction.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/BypassVideoLengthRestriction.kt</a></b>
<a href="#h206-0" id="h206-0" class="h">@@ -0,0 +1,72 @@
</a><a href="#h206-0-0" id="h206-0-0" class="i">+package me.rhunk.snapenhance.core.features.impl.global
</a><a href="#h206-0-1" id="h206-0-1" class="i">+
</a><a href="#h206-0-2" id="h206-0-2" class="i">+import android.os.Build
</a><a href="#h206-0-3" id="h206-0-3" class="i">+import android.os.FileObserver
</a><a href="#h206-0-4" id="h206-0-4" class="i">+import com.google.gson.JsonParser
</a><a href="#h206-0-5" id="h206-0-5" class="i">+import me.rhunk.snapenhance.core.event.events.impl.SendMessageWithContentEvent
</a><a href="#h206-0-6" id="h206-0-6" class="i">+import me.rhunk.snapenhance.core.features.Feature
</a><a href="#h206-0-7" id="h206-0-7" class="i">+import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a><a href="#h206-0-8" id="h206-0-8" class="i">+import me.rhunk.snapenhance.core.util.hook.HookStage
</a><a href="#h206-0-9" id="h206-0-9" class="i">+import me.rhunk.snapenhance.core.util.hook.hookConstructor
</a><a href="#h206-0-10" id="h206-0-10" class="i">+import me.rhunk.snapenhance.core.util.ktx.setObjectField
</a><a href="#h206-0-11" id="h206-0-11" class="i">+import java.io.File
</a><a href="#h206-0-12" id="h206-0-12" class="i">+
</a><a href="#h206-0-13" id="h206-0-13" class="i">+class BypassVideoLengthRestriction :
</a><a href="#h206-0-14" id="h206-0-14" class="i">+    Feature(&quot;BypassVideoLengthRestriction&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_ASYNC) {
</a><a href="#h206-0-15" id="h206-0-15" class="i">+    private lateinit var fileObserver: FileObserver
</a><a href="#h206-0-16" id="h206-0-16" class="i">+
</a><a href="#h206-0-17" id="h206-0-17" class="i">+    override fun asyncOnActivityCreate() {
</a><a href="#h206-0-18" id="h206-0-18" class="i">+        val mode = context.config.global.bypassVideoLengthRestriction.getNullable()
</a><a href="#h206-0-19" id="h206-0-19" class="i">+
</a><a href="#h206-0-20" id="h206-0-20" class="i">+        if (mode == &quot;single&quot;) {
</a><a href="#h206-0-21" id="h206-0-21" class="i">+            //fix black videos when story is posted
</a><a href="#h206-0-22" id="h206-0-22" class="i">+            if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.Q) {
</a><a href="#h206-0-23" id="h206-0-23" class="i">+                val postedStorySnapFolder =
</a><a href="#h206-0-24" id="h206-0-24" class="i">+                    File(context.androidContext.filesDir, &quot;file_manager/posted_story_snap&quot;)
</a><a href="#h206-0-25" id="h206-0-25" class="i">+
</a><a href="#h206-0-26" id="h206-0-26" class="i">+                fileObserver = (object : FileObserver(postedStorySnapFolder, MOVED_TO) {
</a><a href="#h206-0-27" id="h206-0-27" class="i">+                    override fun onEvent(event: Int, path: String?) {
</a><a href="#h206-0-28" id="h206-0-28" class="i">+                        if (event != MOVED_TO || path?.endsWith(&quot;posted_story_snap.2&quot;) != true) return
</a><a href="#h206-0-29" id="h206-0-29" class="i">+                        fileObserver.stopWatching()
</a><a href="#h206-0-30" id="h206-0-30" class="i">+
</a><a href="#h206-0-31" id="h206-0-31" class="i">+                        val file = File(postedStorySnapFolder, path)
</a><a href="#h206-0-32" id="h206-0-32" class="i">+                        runCatching {
</a><a href="#h206-0-33" id="h206-0-33" class="i">+                            val fileContent = JsonParser.parseReader(file.reader()).asJsonObject
</a><a href="#h206-0-34" id="h206-0-34" class="i">+                            if (fileContent[&quot;timerOrDuration&quot;].asLong &lt; 0) file.delete()
</a><a href="#h206-0-35" id="h206-0-35" class="i">+                        }.onFailure {
</a><a href="#h206-0-36" id="h206-0-36" class="i">+                            context.log.error(&quot;Failed to read story metadata file&quot;, it)
</a><a href="#h206-0-37" id="h206-0-37" class="i">+                        }
</a><a href="#h206-0-38" id="h206-0-38" class="i">+                    }
</a><a href="#h206-0-39" id="h206-0-39" class="i">+                })
</a><a href="#h206-0-40" id="h206-0-40" class="i">+
</a><a href="#h206-0-41" id="h206-0-41" class="i">+                context.event.subscribe(SendMessageWithContentEvent::class) { event -&gt;
</a><a href="#h206-0-42" id="h206-0-42" class="i">+                    if (event.destinations.stories.isEmpty()) return@subscribe
</a><a href="#h206-0-43" id="h206-0-43" class="i">+                    fileObserver.startWatching()
</a><a href="#h206-0-44" id="h206-0-44" class="i">+                }
</a><a href="#h206-0-45" id="h206-0-45" class="i">+            }
</a><a href="#h206-0-46" id="h206-0-46" class="i">+
</a><a href="#h206-0-47" id="h206-0-47" class="i">+            context.mappings.getMappedClass(&quot;DefaultMediaItem&quot;)
</a><a href="#h206-0-48" id="h206-0-48" class="i">+                .hookConstructor(HookStage.BEFORE) { param -&gt;
</a><a href="#h206-0-49" id="h206-0-49" class="i">+                    //set the video length argument
</a><a href="#h206-0-50" id="h206-0-50" class="i">+                    param.setArg(5, -1L)
</a><a href="#h206-0-51" id="h206-0-51" class="i">+                }
</a><a href="#h206-0-52" id="h206-0-52" class="i">+        }
</a><a href="#h206-0-53" id="h206-0-53" class="i">+
</a><a href="#h206-0-54" id="h206-0-54" class="i">+        //TODO: allow split from any source
</a><a href="#h206-0-55" id="h206-0-55" class="i">+        if (mode == &quot;split&quot;) {
</a><a href="#h206-0-56" id="h206-0-56" class="i">+            val cameraRollId = context.mappings.getMappedMap(&quot;CameraRollMediaId&quot;)
</a><a href="#h206-0-57" id="h206-0-57" class="i">+            // memories grid
</a><a href="#h206-0-58" id="h206-0-58" class="i">+            findClass(cameraRollId[&quot;class&quot;].toString()).hookConstructor(HookStage.AFTER) { param -&gt;
</a><a href="#h206-0-59" id="h206-0-59" class="i">+                //set the durationMs field
</a><a href="#h206-0-60" id="h206-0-60" class="i">+                param.thisObject&lt;Any&gt;()
</a><a href="#h206-0-61" id="h206-0-61" class="i">+                    .setObjectField(cameraRollId[&quot;durationMsField&quot;].toString(), -1L)
</a><a href="#h206-0-62" id="h206-0-62" class="i">+            }
</a><a href="#h206-0-63" id="h206-0-63" class="i">+
</a><a href="#h206-0-64" id="h206-0-64" class="i">+            // chat camera roll grid
</a><a href="#h206-0-65" id="h206-0-65" class="i">+            findClass(&quot;com.snap.impala.common.media.MediaLibraryItem&quot;).hookConstructor(HookStage.BEFORE) { param -&gt;
</a><a href="#h206-0-66" id="h206-0-66" class="i">+                //set the video length argument
</a><a href="#h206-0-67" id="h206-0-67" class="i">+                param.setArg(3, -1L)
</a><a href="#h206-0-68" id="h206-0-68" class="i">+            }
</a><a href="#h206-0-69" id="h206-0-69" class="i">+        }
</a><a href="#h206-0-70" id="h206-0-70" class="i">+    }
</a><a href="#h206-0-71" id="h206-0-71" class="i">+}</a><a href="#h206-0-72" id="h206-0-72" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h207" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/DisableMetrics.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/DisableMetrics.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/DisableMetrics.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/DisableMetrics.kt</a></b>
<a href="#h207-0" id="h207-0" class="h">@@ -0,0 +1,30 @@
</a><a href="#h207-0-0" id="h207-0-0" class="i">+package me.rhunk.snapenhance.core.features.impl.global
</a><a href="#h207-0-1" id="h207-0-1" class="i">+
</a><a href="#h207-0-2" id="h207-0-2" class="i">+import me.rhunk.snapenhance.core.event.events.impl.NetworkApiRequestEvent
</a><a href="#h207-0-3" id="h207-0-3" class="i">+import me.rhunk.snapenhance.core.features.Feature
</a><a href="#h207-0-4" id="h207-0-4" class="i">+import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a><a href="#h207-0-5" id="h207-0-5" class="i">+import me.rhunk.snapenhance.core.util.hook.HookStage
</a><a href="#h207-0-6" id="h207-0-6" class="i">+import me.rhunk.snapenhance.core.util.hook.Hooker
</a><a href="#h207-0-7" id="h207-0-7" class="i">+
</a><a href="#h207-0-8" id="h207-0-8" class="i">+class DisableMetrics : Feature(&quot;DisableMetrics&quot;, loadParams = FeatureLoadParams.INIT_SYNC) {
</a><a href="#h207-0-9" id="h207-0-9" class="i">+    override fun init() {
</a><a href="#h207-0-10" id="h207-0-10" class="i">+        val disableMetrics by context.config.global.disableMetrics
</a><a href="#h207-0-11" id="h207-0-11" class="i">+
</a><a href="#h207-0-12" id="h207-0-12" class="i">+        Hooker.hook(context.classCache.unifiedGrpcService, &quot;unaryCall&quot;, HookStage.BEFORE,
</a><a href="#h207-0-13" id="h207-0-13" class="i">+            {  disableMetrics }) { param -&gt;
</a><a href="#h207-0-14" id="h207-0-14" class="i">+            val url: String = param.arg(0)
</a><a href="#h207-0-15" id="h207-0-15" class="i">+            if (url.endsWith(&quot;snapchat.valis.Valis/SendClientUpdate&quot;) ||
</a><a href="#h207-0-16" id="h207-0-16" class="i">+                url.endsWith(&quot;targetingQuery&quot;)
</a><a href="#h207-0-17" id="h207-0-17" class="i">+            ) {
</a><a href="#h207-0-18" id="h207-0-18" class="i">+                param.setResult(null)
</a><a href="#h207-0-19" id="h207-0-19" class="i">+            }
</a><a href="#h207-0-20" id="h207-0-20" class="i">+        }
</a><a href="#h207-0-21" id="h207-0-21" class="i">+
</a><a href="#h207-0-22" id="h207-0-22" class="i">+        context.event.subscribe(NetworkApiRequestEvent::class, { disableMetrics }) { param -&gt;
</a><a href="#h207-0-23" id="h207-0-23" class="i">+            val url = param.url
</a><a href="#h207-0-24" id="h207-0-24" class="i">+            if (url.contains(&quot;app-analytics&quot;) || url.endsWith(&quot;v1/metrics&quot;)) {
</a><a href="#h207-0-25" id="h207-0-25" class="i">+                param.canceled = true
</a><a href="#h207-0-26" id="h207-0-26" class="i">+            }
</a><a href="#h207-0-27" id="h207-0-27" class="i">+        }
</a><a href="#h207-0-28" id="h207-0-28" class="i">+    }
</a><a href="#h207-0-29" id="h207-0-29" class="i">+}</a><a href="#h207-0-30" id="h207-0-30" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h208" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/GooglePlayServicesDialogs.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/GooglePlayServicesDialogs.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/GooglePlayServicesDialogs.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/GooglePlayServicesDialogs.kt</a></b>
<a href="#h208-0" id="h208-0" class="h">@@ -0,0 +1,22 @@
</a><a href="#h208-0-0" id="h208-0-0" class="i">+package me.rhunk.snapenhance.core.features.impl.global
</a><a href="#h208-0-1" id="h208-0-1" class="i">+
</a><a href="#h208-0-2" id="h208-0-2" class="i">+import android.app.AlertDialog
</a><a href="#h208-0-3" id="h208-0-3" class="i">+import me.rhunk.snapenhance.core.features.Feature
</a><a href="#h208-0-4" id="h208-0-4" class="i">+import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a><a href="#h208-0-5" id="h208-0-5" class="i">+import me.rhunk.snapenhance.core.util.hook.HookStage
</a><a href="#h208-0-6" id="h208-0-6" class="i">+import me.rhunk.snapenhance.core.util.hook.hook
</a><a href="#h208-0-7" id="h208-0-7" class="i">+import java.lang.reflect.Modifier
</a><a href="#h208-0-8" id="h208-0-8" class="i">+
</a><a href="#h208-0-9" id="h208-0-9" class="i">+class GooglePlayServicesDialogs : Feature(&quot;Disable GMS Dialogs&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_ASYNC) {
</a><a href="#h208-0-10" id="h208-0-10" class="i">+    override fun asyncOnActivityCreate() {
</a><a href="#h208-0-11" id="h208-0-11" class="i">+        if (!context.config.global.disableGooglePlayDialogs.get()) return
</a><a href="#h208-0-12" id="h208-0-12" class="i">+
</a><a href="#h208-0-13" id="h208-0-13" class="i">+        findClass(&quot;com.google.android.gms.common.GoogleApiAvailability&quot;).methods
</a><a href="#h208-0-14" id="h208-0-14" class="i">+            .first { Modifier.isStatic(it.modifiers) &amp;&amp; it.returnType == AlertDialog::class.java }.let { method -&gt;
</a><a href="#h208-0-15" id="h208-0-15" class="i">+            method.hook(HookStage.BEFORE) { param -&gt;
</a><a href="#h208-0-16" id="h208-0-16" class="i">+                context.log.verbose(&quot;GoogleApiAvailability.showErrorDialogFragment() called, returning null&quot;)
</a><a href="#h208-0-17" id="h208-0-17" class="i">+                param.setResult(null)
</a><a href="#h208-0-18" id="h208-0-18" class="i">+            }
</a><a href="#h208-0-19" id="h208-0-19" class="i">+        }
</a><a href="#h208-0-20" id="h208-0-20" class="i">+    }
</a><a href="#h208-0-21" id="h208-0-21" class="i">+}</a><a href="#h208-0-22" id="h208-0-22" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h209" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/LocationSpoofer.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/LocationSpoofer.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/LocationSpoofer.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/LocationSpoofer.kt</a></b>
<a href="#h209-0" id="h209-0" class="h">@@ -0,0 +1,41 @@
</a><a href="#h209-0-0" id="h209-0-0" class="i">+package me.rhunk.snapenhance.core.features.impl.global
</a><a href="#h209-0-1" id="h209-0-1" class="i">+
</a><a href="#h209-0-2" id="h209-0-2" class="i">+import android.content.Intent
</a><a href="#h209-0-3" id="h209-0-3" class="i">+import me.rhunk.snapenhance.core.features.Feature
</a><a href="#h209-0-4" id="h209-0-4" class="i">+import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a><a href="#h209-0-5" id="h209-0-5" class="i">+import me.rhunk.snapenhance.core.util.hook.HookStage
</a><a href="#h209-0-6" id="h209-0-6" class="i">+import me.rhunk.snapenhance.core.util.hook.Hooker
</a><a href="#h209-0-7" id="h209-0-7" class="i">+import me.rhunk.snapenhance.core.util.hook.hook
</a><a href="#h209-0-8" id="h209-0-8" class="i">+
</a><a href="#h209-0-9" id="h209-0-9" class="i">+class LocationSpoofer: Feature(&quot;LocationSpoof&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_ASYNC) {
</a><a href="#h209-0-10" id="h209-0-10" class="i">+    override fun asyncOnActivityCreate() {
</a><a href="#h209-0-11" id="h209-0-11" class="i">+        Hooker.hook(context.mainActivity!!.javaClass, &quot;onActivityResult&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h209-0-12" id="h209-0-12" class="i">+            val intent = param.argNullable&lt;Intent&gt;(2) ?: return@hook
</a><a href="#h209-0-13" id="h209-0-13" class="i">+            val bundle = intent.getBundleExtra(&quot;location&quot;) ?: return@hook
</a><a href="#h209-0-14" id="h209-0-14" class="i">+            param.setResult(null)
</a><a href="#h209-0-15" id="h209-0-15" class="i">+
</a><a href="#h209-0-16" id="h209-0-16" class="i">+            with(context.config.experimental.spoof.location) {
</a><a href="#h209-0-17" id="h209-0-17" class="i">+                latitude.set(bundle.getFloat(&quot;latitude&quot;))
</a><a href="#h209-0-18" id="h209-0-18" class="i">+                longitude.set(bundle.getFloat(&quot;longitude&quot;))
</a><a href="#h209-0-19" id="h209-0-19" class="i">+
</a><a href="#h209-0-20" id="h209-0-20" class="i">+                context.longToast(&quot;Location set to $latitude, $longitude&quot;)
</a><a href="#h209-0-21" id="h209-0-21" class="i">+            }
</a><a href="#h209-0-22" id="h209-0-22" class="i">+        }
</a><a href="#h209-0-23" id="h209-0-23" class="i">+
</a><a href="#h209-0-24" id="h209-0-24" class="i">+        if (context.config.experimental.spoof.location.globalState != true) return
</a><a href="#h209-0-25" id="h209-0-25" class="i">+
</a><a href="#h209-0-26" id="h209-0-26" class="i">+        val latitude by context.config.experimental.spoof.location.latitude
</a><a href="#h209-0-27" id="h209-0-27" class="i">+        val longitude by context.config.experimental.spoof.location.longitude
</a><a href="#h209-0-28" id="h209-0-28" class="i">+
</a><a href="#h209-0-29" id="h209-0-29" class="i">+        val locationClass = android.location.Location::class.java
</a><a href="#h209-0-30" id="h209-0-30" class="i">+        val locationManagerClass = android.location.LocationManager::class.java
</a><a href="#h209-0-31" id="h209-0-31" class="i">+
</a><a href="#h209-0-32" id="h209-0-32" class="i">+        locationClass.hook(&quot;getLatitude&quot;, HookStage.BEFORE) { it.setResult(latitude.toDouble()) }
</a><a href="#h209-0-33" id="h209-0-33" class="i">+        locationClass.hook(&quot;getLongitude&quot;, HookStage.BEFORE) { it.setResult(longitude.toDouble()) }
</a><a href="#h209-0-34" id="h209-0-34" class="i">+        locationClass.hook(&quot;getAccuracy&quot;, HookStage.BEFORE) { it.setResult(0.0F) }
</a><a href="#h209-0-35" id="h209-0-35" class="i">+
</a><a href="#h209-0-36" id="h209-0-36" class="i">+        //Might be redundant because it calls isProviderEnabledForUser which we also hook, meaning if isProviderEnabledForUser returns true this will also return true
</a><a href="#h209-0-37" id="h209-0-37" class="i">+        locationManagerClass.hook(&quot;isProviderEnabled&quot;, HookStage.BEFORE) { it.setResult(true) }
</a><a href="#h209-0-38" id="h209-0-38" class="i">+        locationManagerClass.hook(&quot;isProviderEnabledForUser&quot;, HookStage.BEFORE) { it.setResult(true) }
</a><a href="#h209-0-39" id="h209-0-39" class="i">+    }
</a><a href="#h209-0-40" id="h209-0-40" class="i">+}</a><a href="#h209-0-41" id="h209-0-41" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h210" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/MediaQualityLevelOverride.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/MediaQualityLevelOverride.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/MediaQualityLevelOverride.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/MediaQualityLevelOverride.kt</a></b>
<a href="#h210-0" id="h210-0" class="h">@@ -0,0 +1,23 @@
</a><a href="#h210-0-0" id="h210-0-0" class="i">+package me.rhunk.snapenhance.core.features.impl.global
</a><a href="#h210-0-1" id="h210-0-1" class="i">+
</a><a href="#h210-0-2" id="h210-0-2" class="i">+import me.rhunk.snapenhance.core.features.Feature
</a><a href="#h210-0-3" id="h210-0-3" class="i">+import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a><a href="#h210-0-4" id="h210-0-4" class="i">+import me.rhunk.snapenhance.core.util.hook.HookStage
</a><a href="#h210-0-5" id="h210-0-5" class="i">+import me.rhunk.snapenhance.core.util.hook.hook
</a><a href="#h210-0-6" id="h210-0-6" class="i">+
</a><a href="#h210-0-7" id="h210-0-7" class="i">+class MediaQualityLevelOverride : Feature(&quot;MediaQualityLevelOverride&quot;, loadParams = FeatureLoadParams.INIT_SYNC) {
</a><a href="#h210-0-8" id="h210-0-8" class="i">+    override fun init() {
</a><a href="#h210-0-9" id="h210-0-9" class="i">+        val enumQualityLevel = context.mappings.getMappedClass(&quot;EnumQualityLevel&quot;)
</a><a href="#h210-0-10" id="h210-0-10" class="i">+        val mediaQualityLevelProvider = context.mappings.getMappedMap(&quot;MediaQualityLevelProvider&quot;)
</a><a href="#h210-0-11" id="h210-0-11" class="i">+
</a><a href="#h210-0-12" id="h210-0-12" class="i">+        val forceMediaSourceQuality by context.config.global.forceMediaSourceQuality
</a><a href="#h210-0-13" id="h210-0-13" class="i">+
</a><a href="#h210-0-14" id="h210-0-14" class="i">+        context.androidContext.classLoader.loadClass(mediaQualityLevelProvider[&quot;class&quot;].toString()).hook(
</a><a href="#h210-0-15" id="h210-0-15" class="i">+            mediaQualityLevelProvider[&quot;method&quot;].toString(),
</a><a href="#h210-0-16" id="h210-0-16" class="i">+            HookStage.BEFORE,
</a><a href="#h210-0-17" id="h210-0-17" class="i">+            { forceMediaSourceQuality }
</a><a href="#h210-0-18" id="h210-0-18" class="i">+        ) { param -&gt;
</a><a href="#h210-0-19" id="h210-0-19" class="i">+            param.setResult(enumQualityLevel.enumConstants.firstOrNull { it.toString() == &quot;LEVEL_MAX&quot; } )
</a><a href="#h210-0-20" id="h210-0-20" class="i">+        }
</a><a href="#h210-0-21" id="h210-0-21" class="i">+    }
</a><a href="#h210-0-22" id="h210-0-22" class="i">+}</a><a href="#h210-0-23" id="h210-0-23" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h211" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/SnapchatPlus.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/SnapchatPlus.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/SnapchatPlus.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/SnapchatPlus.kt</a></b>
<a href="#h211-0" id="h211-0" class="h">@@ -0,0 +1,45 @@
</a><a href="#h211-0-0" id="h211-0-0" class="i">+package me.rhunk.snapenhance.core.features.impl.global
</a><a href="#h211-0-1" id="h211-0-1" class="i">+
</a><a href="#h211-0-2" id="h211-0-2" class="i">+import me.rhunk.snapenhance.core.features.Feature
</a><a href="#h211-0-3" id="h211-0-3" class="i">+import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a><a href="#h211-0-4" id="h211-0-4" class="i">+import me.rhunk.snapenhance.core.util.hook.HookStage
</a><a href="#h211-0-5" id="h211-0-5" class="i">+import me.rhunk.snapenhance.core.util.hook.Hooker
</a><a href="#h211-0-6" id="h211-0-6" class="i">+import me.rhunk.snapenhance.core.util.hook.hook
</a><a href="#h211-0-7" id="h211-0-7" class="i">+
</a><a href="#h211-0-8" id="h211-0-8" class="i">+class SnapchatPlus: Feature(&quot;SnapchatPlus&quot;, loadParams = FeatureLoadParams.INIT_SYNC) {
</a><a href="#h211-0-9" id="h211-0-9" class="i">+    private val originalSubscriptionTime = (System.currentTimeMillis() - 7776000000L)
</a><a href="#h211-0-10" id="h211-0-10" class="i">+    private val expirationTimeMillis = (System.currentTimeMillis() + 15552000000L)
</a><a href="#h211-0-11" id="h211-0-11" class="i">+
</a><a href="#h211-0-12" id="h211-0-12" class="i">+    override fun init() {
</a><a href="#h211-0-13" id="h211-0-13" class="i">+        if (!context.config.global.snapchatPlus.get()) return
</a><a href="#h211-0-14" id="h211-0-14" class="i">+
</a><a href="#h211-0-15" id="h211-0-15" class="i">+        val subscriptionInfoClass = context.mappings.getMappedClass(&quot;SubscriptionInfoClass&quot;)
</a><a href="#h211-0-16" id="h211-0-16" class="i">+
</a><a href="#h211-0-17" id="h211-0-17" class="i">+        Hooker.hookConstructor(subscriptionInfoClass, HookStage.BEFORE) { param -&gt;
</a><a href="#h211-0-18" id="h211-0-18" class="i">+            if (param.arg&lt;Int&gt;(0) == 2) return@hookConstructor
</a><a href="#h211-0-19" id="h211-0-19" class="i">+            //subscription tier
</a><a href="#h211-0-20" id="h211-0-20" class="i">+            param.setArg(0, 2)
</a><a href="#h211-0-21" id="h211-0-21" class="i">+            //subscription status
</a><a href="#h211-0-22" id="h211-0-22" class="i">+            param.setArg(1, 2)
</a><a href="#h211-0-23" id="h211-0-23" class="i">+
</a><a href="#h211-0-24" id="h211-0-24" class="i">+            param.setArg(2, originalSubscriptionTime)
</a><a href="#h211-0-25" id="h211-0-25" class="i">+            param.setArg(3, expirationTimeMillis)
</a><a href="#h211-0-26" id="h211-0-26" class="i">+        }
</a><a href="#h211-0-27" id="h211-0-27" class="i">+
</a><a href="#h211-0-28" id="h211-0-28" class="i">+        if (context.config.experimental.hiddenSnapchatPlusFeatures.get()) {
</a><a href="#h211-0-29" id="h211-0-29" class="i">+            findClass(&quot;com.snap.plus.FeatureCatalog&quot;).methods.last {
</a><a href="#h211-0-30" id="h211-0-30" class="i">+                !it.name.contains(&quot;init&quot;) &amp;&amp;
</a><a href="#h211-0-31" id="h211-0-31" class="i">+                it.parameterTypes.isNotEmpty() &amp;&amp;
</a><a href="#h211-0-32" id="h211-0-32" class="i">+                it.parameterTypes[0].name != &quot;java.lang.Boolean&quot;
</a><a href="#h211-0-33" id="h211-0-33" class="i">+            }.hook(HookStage.BEFORE) { param -&gt;
</a><a href="#h211-0-34" id="h211-0-34" class="i">+                val instance = param.thisObject&lt;Any&gt;()
</a><a href="#h211-0-35" id="h211-0-35" class="i">+                val firstArg = param.arg&lt;Any&gt;(0)
</a><a href="#h211-0-36" id="h211-0-36" class="i">+
</a><a href="#h211-0-37" id="h211-0-37" class="i">+                instance::class.java.declaredFields.filter { it.type == firstArg::class.java }.forEach {
</a><a href="#h211-0-38" id="h211-0-38" class="i">+                    it.isAccessible = true
</a><a href="#h211-0-39" id="h211-0-39" class="i">+                    it.set(instance, firstArg)
</a><a href="#h211-0-40" id="h211-0-40" class="i">+                }
</a><a href="#h211-0-41" id="h211-0-41" class="i">+            }
</a><a href="#h211-0-42" id="h211-0-42" class="i">+        }
</a><a href="#h211-0-43" id="h211-0-43" class="i">+    }
</a><a href="#h211-0-44" id="h211-0-44" class="i">+}</a><a href="#h211-0-45" id="h211-0-45" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h212" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/AnonymousStoryViewing.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/AnonymousStoryViewing.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/AnonymousStoryViewing.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/AnonymousStoryViewing.kt</a></b>
<a href="#h212-0" id="h212-0" class="h">@@ -0,0 +1,27 @@
</a><a href="#h212-0-0" id="h212-0-0" class="i">+package me.rhunk.snapenhance.core.features.impl.messaging
</a><a href="#h212-0-1" id="h212-0-1" class="i">+
</a><a href="#h212-0-2" id="h212-0-2" class="i">+import kotlinx.coroutines.runBlocking
</a><a href="#h212-0-3" id="h212-0-3" class="i">+import me.rhunk.snapenhance.core.event.events.impl.NetworkApiRequestEvent
</a><a href="#h212-0-4" id="h212-0-4" class="i">+import me.rhunk.snapenhance.core.features.Feature
</a><a href="#h212-0-5" id="h212-0-5" class="i">+import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a><a href="#h212-0-6" id="h212-0-6" class="i">+import me.rhunk.snapenhance.core.util.media.HttpServer
</a><a href="#h212-0-7" id="h212-0-7" class="i">+import kotlin.coroutines.suspendCoroutine
</a><a href="#h212-0-8" id="h212-0-8" class="i">+
</a><a href="#h212-0-9" id="h212-0-9" class="i">+class AnonymousStoryViewing : Feature(&quot;Anonymous Story Viewing&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_ASYNC) {
</a><a href="#h212-0-10" id="h212-0-10" class="i">+    override fun asyncOnActivityCreate() {
</a><a href="#h212-0-11" id="h212-0-11" class="i">+        val anonymousStoryViewProperty by context.config.messaging.anonymousStoryViewing
</a><a href="#h212-0-12" id="h212-0-12" class="i">+        val httpServer = HttpServer()
</a><a href="#h212-0-13" id="h212-0-13" class="i">+
</a><a href="#h212-0-14" id="h212-0-14" class="i">+        context.event.subscribe(NetworkApiRequestEvent::class, { anonymousStoryViewProperty }) { event -&gt;
</a><a href="#h212-0-15" id="h212-0-15" class="i">+            if (!event.url.endsWith(&quot;readreceipt-indexer/batchuploadreadreceipts&quot;)) return@subscribe
</a><a href="#h212-0-16" id="h212-0-16" class="i">+            runBlocking {
</a><a href="#h212-0-17" id="h212-0-17" class="i">+                suspendCoroutine {
</a><a href="#h212-0-18" id="h212-0-18" class="i">+                    httpServer.ensureServerStarted {
</a><a href="#h212-0-19" id="h212-0-19" class="i">+                        event.url = &quot;http://127.0.0.1:${httpServer.port}&quot;
</a><a href="#h212-0-20" id="h212-0-20" class="i">+                        it.resumeWith(Result.success(Unit))
</a><a href="#h212-0-21" id="h212-0-21" class="i">+                    }
</a><a href="#h212-0-22" id="h212-0-22" class="i">+                }
</a><a href="#h212-0-23" id="h212-0-23" class="i">+            }
</a><a href="#h212-0-24" id="h212-0-24" class="i">+        }
</a><a href="#h212-0-25" id="h212-0-25" class="i">+    }
</a><a href="#h212-0-26" id="h212-0-26" class="i">+}
</a><b>diff --git a/<a id="h213" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/AutoSave.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/AutoSave.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/AutoSave.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/AutoSave.kt</a></b>
<a href="#h213-0" id="h213-0" class="h">@@ -0,0 +1,138 @@
</a><a href="#h213-0-0" id="h213-0-0" class="i">+package me.rhunk.snapenhance.core.features.impl.messaging
</a><a href="#h213-0-1" id="h213-0-1" class="i">+
</a><a href="#h213-0-2" id="h213-0-2" class="i">+import me.rhunk.snapenhance.common.data.MessageState
</a><a href="#h213-0-3" id="h213-0-3" class="i">+import me.rhunk.snapenhance.common.data.MessagingRuleType
</a><a href="#h213-0-4" id="h213-0-4" class="i">+import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a><a href="#h213-0-5" id="h213-0-5" class="i">+import me.rhunk.snapenhance.core.features.MessagingRuleFeature
</a><a href="#h213-0-6" id="h213-0-6" class="i">+import me.rhunk.snapenhance.core.features.impl.spying.MessageLogger
</a><a href="#h213-0-7" id="h213-0-7" class="i">+import me.rhunk.snapenhance.core.features.impl.spying.StealthMode
</a><a href="#h213-0-8" id="h213-0-8" class="i">+import me.rhunk.snapenhance.core.logger.CoreLogger
</a><a href="#h213-0-9" id="h213-0-9" class="i">+import me.rhunk.snapenhance.core.util.CallbackBuilder
</a><a href="#h213-0-10" id="h213-0-10" class="i">+import me.rhunk.snapenhance.core.util.hook.HookStage
</a><a href="#h213-0-11" id="h213-0-11" class="i">+import me.rhunk.snapenhance.core.util.hook.Hooker
</a><a href="#h213-0-12" id="h213-0-12" class="i">+import me.rhunk.snapenhance.core.util.ktx.getObjectField
</a><a href="#h213-0-13" id="h213-0-13" class="i">+import me.rhunk.snapenhance.core.wrapper.impl.Message
</a><a href="#h213-0-14" id="h213-0-14" class="i">+import me.rhunk.snapenhance.core.wrapper.impl.SnapUUID
</a><a href="#h213-0-15" id="h213-0-15" class="i">+import java.util.concurrent.Executors
</a><a href="#h213-0-16" id="h213-0-16" class="i">+
</a><a href="#h213-0-17" id="h213-0-17" class="i">+class AutoSave : MessagingRuleFeature(&quot;Auto Save&quot;, MessagingRuleType.AUTO_SAVE, loadParams = FeatureLoadParams.ACTIVITY_CREATE_ASYNC) {
</a><a href="#h213-0-18" id="h213-0-18" class="i">+    private val asyncSaveExecutorService = Executors.newSingleThreadExecutor()
</a><a href="#h213-0-19" id="h213-0-19" class="i">+
</a><a href="#h213-0-20" id="h213-0-20" class="i">+    private val messageLogger by lazy { context.feature(MessageLogger::class) }
</a><a href="#h213-0-21" id="h213-0-21" class="i">+    private val messaging by lazy { context.feature(Messaging::class) }
</a><a href="#h213-0-22" id="h213-0-22" class="i">+
</a><a href="#h213-0-23" id="h213-0-23" class="i">+    private val fetchConversationWithMessagesCallbackClass by lazy {  context.mappings.getMappedClass(&quot;callbacks&quot;, &quot;FetchConversationWithMessagesCallback&quot;) }
</a><a href="#h213-0-24" id="h213-0-24" class="i">+    private val callbackClass by lazy {  context.mappings.getMappedClass(&quot;callbacks&quot;, &quot;Callback&quot;) }
</a><a href="#h213-0-25" id="h213-0-25" class="i">+
</a><a href="#h213-0-26" id="h213-0-26" class="i">+    private val updateMessageMethod by lazy { context.classCache.conversationManager.methods.first { it.name == &quot;updateMessage&quot; } }
</a><a href="#h213-0-27" id="h213-0-27" class="i">+    private val fetchConversationWithMessagesPaginatedMethod by lazy {
</a><a href="#h213-0-28" id="h213-0-28" class="i">+        context.classCache.conversationManager.methods.first { it.name == &quot;fetchConversationWithMessagesPaginated&quot; }
</a><a href="#h213-0-29" id="h213-0-29" class="i">+    }
</a><a href="#h213-0-30" id="h213-0-30" class="i">+
</a><a href="#h213-0-31" id="h213-0-31" class="i">+    private val autoSaveFilter by lazy {
</a><a href="#h213-0-32" id="h213-0-32" class="i">+        context.config.messaging.autoSaveMessagesInConversations.get()
</a><a href="#h213-0-33" id="h213-0-33" class="i">+    }
</a><a href="#h213-0-34" id="h213-0-34" class="i">+
</a><a href="#h213-0-35" id="h213-0-35" class="i">+    private fun saveMessage(conversationId: SnapUUID, message: Message) {
</a><a href="#h213-0-36" id="h213-0-36" class="i">+        val messageId = message.messageDescriptor.messageId
</a><a href="#h213-0-37" id="h213-0-37" class="i">+        if (messageLogger.takeIf { it.isEnabled }?.isMessageDeleted(conversationId.toString(), message.messageDescriptor.messageId) == true) return
</a><a href="#h213-0-38" id="h213-0-38" class="i">+        if (message.messageState != MessageState.COMMITTED) return
</a><a href="#h213-0-39" id="h213-0-39" class="i">+
</a><a href="#h213-0-40" id="h213-0-40" class="i">+        runCatching {
</a><a href="#h213-0-41" id="h213-0-41" class="i">+            val callback = CallbackBuilder(callbackClass)
</a><a href="#h213-0-42" id="h213-0-42" class="i">+                .override(&quot;onError&quot;) {
</a><a href="#h213-0-43" id="h213-0-43" class="i">+                    context.log.warn(&quot;Error saving message $messageId&quot;)
</a><a href="#h213-0-44" id="h213-0-44" class="i">+                }.build()
</a><a href="#h213-0-45" id="h213-0-45" class="i">+
</a><a href="#h213-0-46" id="h213-0-46" class="i">+            updateMessageMethod.invoke(
</a><a href="#h213-0-47" id="h213-0-47" class="i">+                context.feature(Messaging::class).conversationManager,
</a><a href="#h213-0-48" id="h213-0-48" class="i">+                conversationId.instanceNonNull(),
</a><a href="#h213-0-49" id="h213-0-49" class="i">+                messageId,
</a><a href="#h213-0-50" id="h213-0-50" class="i">+                context.classCache.messageUpdateEnum.enumConstants.first { it.toString() == &quot;SAVE&quot; },
</a><a href="#h213-0-51" id="h213-0-51" class="i">+                callback
</a><a href="#h213-0-52" id="h213-0-52" class="i">+            )
</a><a href="#h213-0-53" id="h213-0-53" class="i">+        }.onFailure {
</a><a href="#h213-0-54" id="h213-0-54" class="i">+            CoreLogger.xposedLog(&quot;Error saving message $messageId&quot;, it)
</a><a href="#h213-0-55" id="h213-0-55" class="i">+        }
</a><a href="#h213-0-56" id="h213-0-56" class="i">+
</a><a href="#h213-0-57" id="h213-0-57" class="i">+        //delay between saves
</a><a href="#h213-0-58" id="h213-0-58" class="i">+        Thread.sleep(100L)
</a><a href="#h213-0-59" id="h213-0-59" class="i">+    }
</a><a href="#h213-0-60" id="h213-0-60" class="i">+
</a><a href="#h213-0-61" id="h213-0-61" class="i">+    private fun canSaveMessage(message: Message): Boolean {
</a><a href="#h213-0-62" id="h213-0-62" class="i">+        if (message.messageMetadata.savedBy.any { uuid -&gt; uuid.toString() == context.database.myUserId }) return false
</a><a href="#h213-0-63" id="h213-0-63" class="i">+        val contentType = message.messageContent.contentType.toString()
</a><a href="#h213-0-64" id="h213-0-64" class="i">+
</a><a href="#h213-0-65" id="h213-0-65" class="i">+        return autoSaveFilter.any { it == contentType }
</a><a href="#h213-0-66" id="h213-0-66" class="i">+    }
</a><a href="#h213-0-67" id="h213-0-67" class="i">+
</a><a href="#h213-0-68" id="h213-0-68" class="i">+    private fun canSaveInConversation(targetConversationId: String): Boolean {
</a><a href="#h213-0-69" id="h213-0-69" class="i">+        val messaging = context.feature(Messaging::class)
</a><a href="#h213-0-70" id="h213-0-70" class="i">+        val openedConversationId = messaging.openedConversationUUID?.toString() ?: return false
</a><a href="#h213-0-71" id="h213-0-71" class="i">+
</a><a href="#h213-0-72" id="h213-0-72" class="i">+        if (openedConversationId != targetConversationId) return false
</a><a href="#h213-0-73" id="h213-0-73" class="i">+
</a><a href="#h213-0-74" id="h213-0-74" class="i">+        if (context.feature(StealthMode::class).canUseRule(openedConversationId)) return false
</a><a href="#h213-0-75" id="h213-0-75" class="i">+        if (!canUseRule(openedConversationId)) return false
</a><a href="#h213-0-76" id="h213-0-76" class="i">+
</a><a href="#h213-0-77" id="h213-0-77" class="i">+        return true
</a><a href="#h213-0-78" id="h213-0-78" class="i">+    }
</a><a href="#h213-0-79" id="h213-0-79" class="i">+
</a><a href="#h213-0-80" id="h213-0-80" class="i">+    override fun asyncOnActivityCreate() {
</a><a href="#h213-0-81" id="h213-0-81" class="i">+        //called when enter in a conversation (or when a message is sent)
</a><a href="#h213-0-82" id="h213-0-82" class="i">+        Hooker.hook(
</a><a href="#h213-0-83" id="h213-0-83" class="i">+            context.mappings.getMappedClass(&quot;callbacks&quot;, &quot;FetchConversationWithMessagesCallback&quot;),
</a><a href="#h213-0-84" id="h213-0-84" class="i">+            &quot;onFetchConversationWithMessagesComplete&quot;,
</a><a href="#h213-0-85" id="h213-0-85" class="i">+            HookStage.BEFORE,
</a><a href="#h213-0-86" id="h213-0-86" class="i">+            { autoSaveFilter.isNotEmpty() }
</a><a href="#h213-0-87" id="h213-0-87" class="i">+        ) { param -&gt;
</a><a href="#h213-0-88" id="h213-0-88" class="i">+            val conversationId = SnapUUID(param.arg&lt;Any&gt;(0).getObjectField(&quot;mConversationId&quot;)!!)
</a><a href="#h213-0-89" id="h213-0-89" class="i">+            if (!canSaveInConversation(conversationId.toString())) return@hook
</a><a href="#h213-0-90" id="h213-0-90" class="i">+
</a><a href="#h213-0-91" id="h213-0-91" class="i">+            val messages = param.arg&lt;List&lt;Any&gt;&gt;(1).map { Message(it) }
</a><a href="#h213-0-92" id="h213-0-92" class="i">+            messages.forEach {
</a><a href="#h213-0-93" id="h213-0-93" class="i">+                if (!canSaveMessage(it)) return@forEach
</a><a href="#h213-0-94" id="h213-0-94" class="i">+                asyncSaveExecutorService.submit {
</a><a href="#h213-0-95" id="h213-0-95" class="i">+                    saveMessage(conversationId, it)
</a><a href="#h213-0-96" id="h213-0-96" class="i">+                }
</a><a href="#h213-0-97" id="h213-0-97" class="i">+            }
</a><a href="#h213-0-98" id="h213-0-98" class="i">+        }
</a><a href="#h213-0-99" id="h213-0-99" class="i">+
</a><a href="#h213-0-100" id="h213-0-100" class="i">+        //called when a message is received
</a><a href="#h213-0-101" id="h213-0-101" class="i">+        Hooker.hook(
</a><a href="#h213-0-102" id="h213-0-102" class="i">+            context.mappings.getMappedClass(&quot;callbacks&quot;, &quot;FetchMessageCallback&quot;),
</a><a href="#h213-0-103" id="h213-0-103" class="i">+            &quot;onFetchMessageComplete&quot;,
</a><a href="#h213-0-104" id="h213-0-104" class="i">+            HookStage.BEFORE,
</a><a href="#h213-0-105" id="h213-0-105" class="i">+            { autoSaveFilter.isNotEmpty() }
</a><a href="#h213-0-106" id="h213-0-106" class="i">+        ) { param -&gt;
</a><a href="#h213-0-107" id="h213-0-107" class="i">+            val message = Message(param.arg(0))
</a><a href="#h213-0-108" id="h213-0-108" class="i">+            val conversationId = message.messageDescriptor.conversationId
</a><a href="#h213-0-109" id="h213-0-109" class="i">+            if (!canSaveInConversation(conversationId.toString())) return@hook
</a><a href="#h213-0-110" id="h213-0-110" class="i">+            if (!canSaveMessage(message)) return@hook
</a><a href="#h213-0-111" id="h213-0-111" class="i">+
</a><a href="#h213-0-112" id="h213-0-112" class="i">+            asyncSaveExecutorService.submit {
</a><a href="#h213-0-113" id="h213-0-113" class="i">+                saveMessage(conversationId, message)
</a><a href="#h213-0-114" id="h213-0-114" class="i">+            }
</a><a href="#h213-0-115" id="h213-0-115" class="i">+        }
</a><a href="#h213-0-116" id="h213-0-116" class="i">+
</a><a href="#h213-0-117" id="h213-0-117" class="i">+        Hooker.hook(
</a><a href="#h213-0-118" id="h213-0-118" class="i">+            context.mappings.getMappedClass(&quot;callbacks&quot;, &quot;SendMessageCallback&quot;),
</a><a href="#h213-0-119" id="h213-0-119" class="i">+            &quot;onSuccess&quot;,
</a><a href="#h213-0-120" id="h213-0-120" class="i">+            HookStage.BEFORE,
</a><a href="#h213-0-121" id="h213-0-121" class="i">+            { autoSaveFilter.isNotEmpty() }
</a><a href="#h213-0-122" id="h213-0-122" class="i">+        ) {
</a><a href="#h213-0-123" id="h213-0-123" class="i">+            val callback = CallbackBuilder(fetchConversationWithMessagesCallbackClass).build()
</a><a href="#h213-0-124" id="h213-0-124" class="i">+            val conversationUUID = messaging.openedConversationUUID ?: return@hook
</a><a href="#h213-0-125" id="h213-0-125" class="i">+            runCatching {
</a><a href="#h213-0-126" id="h213-0-126" class="i">+                fetchConversationWithMessagesPaginatedMethod.invoke(
</a><a href="#h213-0-127" id="h213-0-127" class="i">+                    messaging.conversationManager, conversationUUID.instanceNonNull(),
</a><a href="#h213-0-128" id="h213-0-128" class="i">+                    Long.MAX_VALUE,
</a><a href="#h213-0-129" id="h213-0-129" class="i">+                    10,
</a><a href="#h213-0-130" id="h213-0-130" class="i">+                    callback
</a><a href="#h213-0-131" id="h213-0-131" class="i">+                )
</a><a href="#h213-0-132" id="h213-0-132" class="i">+            }.onFailure {
</a><a href="#h213-0-133" id="h213-0-133" class="i">+                CoreLogger.xposedLog(&quot;failed to save message&quot;, it)
</a><a href="#h213-0-134" id="h213-0-134" class="i">+            }
</a><a href="#h213-0-135" id="h213-0-135" class="i">+        }
</a><a href="#h213-0-136" id="h213-0-136" class="i">+    }
</a><a href="#h213-0-137" id="h213-0-137" class="i">+}</a><a href="#h213-0-138" id="h213-0-138" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h214" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/DisableReplayInFF.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/DisableReplayInFF.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/DisableReplayInFF.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/DisableReplayInFF.kt</a></b>
<a href="#h214-0" id="h214-0" class="h">@@ -0,0 +1,22 @@
</a><a href="#h214-0-0" id="h214-0-0" class="i">+package me.rhunk.snapenhance.core.features.impl.messaging
</a><a href="#h214-0-1" id="h214-0-1" class="i">+
</a><a href="#h214-0-2" id="h214-0-2" class="i">+import me.rhunk.snapenhance.core.features.Feature
</a><a href="#h214-0-3" id="h214-0-3" class="i">+import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a><a href="#h214-0-4" id="h214-0-4" class="i">+import me.rhunk.snapenhance.core.util.hook.HookStage
</a><a href="#h214-0-5" id="h214-0-5" class="i">+import me.rhunk.snapenhance.core.util.hook.hookConstructor
</a><a href="#h214-0-6" id="h214-0-6" class="i">+import me.rhunk.snapenhance.core.util.ktx.getObjectField
</a><a href="#h214-0-7" id="h214-0-7" class="i">+import me.rhunk.snapenhance.core.util.ktx.setEnumField
</a><a href="#h214-0-8" id="h214-0-8" class="i">+
</a><a href="#h214-0-9" id="h214-0-9" class="i">+class DisableReplayInFF : Feature(&quot;DisableReplayInFF&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_ASYNC) {
</a><a href="#h214-0-10" id="h214-0-10" class="i">+    override fun asyncOnActivityCreate() {
</a><a href="#h214-0-11" id="h214-0-11" class="i">+        val state by context.config.messaging.disableReplayInFF
</a><a href="#h214-0-12" id="h214-0-12" class="i">+
</a><a href="#h214-0-13" id="h214-0-13" class="i">+        findClass(&quot;com.snapchat.client.messaging.InteractionInfo&quot;)
</a><a href="#h214-0-14" id="h214-0-14" class="i">+            .hookConstructor(HookStage.AFTER, { state }) { param -&gt;
</a><a href="#h214-0-15" id="h214-0-15" class="i">+            val instance = param.thisObject&lt;Any&gt;()
</a><a href="#h214-0-16" id="h214-0-16" class="i">+            if (instance.getObjectField(&quot;mLongPressActionState&quot;).toString() == &quot;REQUEST_SNAP_REPLAY&quot;) {
</a><a href="#h214-0-17" id="h214-0-17" class="i">+                instance.setEnumField(&quot;mLongPressActionState&quot;, &quot;SHOW_CONVERSATION_ACTION_MENU&quot;)
</a><a href="#h214-0-18" id="h214-0-18" class="i">+            }
</a><a href="#h214-0-19" id="h214-0-19" class="i">+        }
</a><a href="#h214-0-20" id="h214-0-20" class="i">+    }
</a><a href="#h214-0-21" id="h214-0-21" class="i">+}</a><a href="#h214-0-22" id="h214-0-22" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h215" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/Messaging.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/Messaging.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/Messaging.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/Messaging.kt</a></b>
<a href="#h215-0" id="h215-0" class="h">@@ -0,0 +1,94 @@
</a><a href="#h215-0-0" id="h215-0-0" class="i">+package me.rhunk.snapenhance.core.features.impl.messaging
</a><a href="#h215-0-1" id="h215-0-1" class="i">+
</a><a href="#h215-0-2" id="h215-0-2" class="i">+import me.rhunk.snapenhance.core.event.events.impl.OnSnapInteractionEvent
</a><a href="#h215-0-3" id="h215-0-3" class="i">+import me.rhunk.snapenhance.core.features.Feature
</a><a href="#h215-0-4" id="h215-0-4" class="i">+import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a><a href="#h215-0-5" id="h215-0-5" class="i">+import me.rhunk.snapenhance.core.features.impl.spying.StealthMode
</a><a href="#h215-0-6" id="h215-0-6" class="i">+import me.rhunk.snapenhance.core.util.hook.HookStage
</a><a href="#h215-0-7" id="h215-0-7" class="i">+import me.rhunk.snapenhance.core.util.hook.Hooker
</a><a href="#h215-0-8" id="h215-0-8" class="i">+import me.rhunk.snapenhance.core.util.hook.hook
</a><a href="#h215-0-9" id="h215-0-9" class="i">+import me.rhunk.snapenhance.core.util.ktx.getObjectField
</a><a href="#h215-0-10" id="h215-0-10" class="i">+import me.rhunk.snapenhance.core.wrapper.impl.SnapUUID
</a><a href="#h215-0-11" id="h215-0-11" class="i">+
</a><a href="#h215-0-12" id="h215-0-12" class="i">+class Messaging : Feature(&quot;Messaging&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_SYNC or FeatureLoadParams.INIT_ASYNC or FeatureLoadParams.INIT_SYNC) {
</a><a href="#h215-0-13" id="h215-0-13" class="i">+    lateinit var conversationManager: Any
</a><a href="#h215-0-14" id="h215-0-14" class="i">+
</a><a href="#h215-0-15" id="h215-0-15" class="i">+    var openedConversationUUID: SnapUUID? = null
</a><a href="#h215-0-16" id="h215-0-16" class="i">+    var lastFetchConversationUserUUID: SnapUUID? = null
</a><a href="#h215-0-17" id="h215-0-17" class="i">+    var lastFetchConversationUUID: SnapUUID? = null
</a><a href="#h215-0-18" id="h215-0-18" class="i">+    var lastFetchGroupConversationUUID: SnapUUID? = null
</a><a href="#h215-0-19" id="h215-0-19" class="i">+    var lastFocusedMessageId: Long = -1
</a><a href="#h215-0-20" id="h215-0-20" class="i">+
</a><a href="#h215-0-21" id="h215-0-21" class="i">+    override fun init() {
</a><a href="#h215-0-22" id="h215-0-22" class="i">+        Hooker.hookConstructor(context.classCache.conversationManager, HookStage.BEFORE) {
</a><a href="#h215-0-23" id="h215-0-23" class="i">+            conversationManager = it.thisObject()
</a><a href="#h215-0-24" id="h215-0-24" class="i">+        }
</a><a href="#h215-0-25" id="h215-0-25" class="i">+    }
</a><a href="#h215-0-26" id="h215-0-26" class="i">+
</a><a href="#h215-0-27" id="h215-0-27" class="i">+    override fun onActivityCreate() {
</a><a href="#h215-0-28" id="h215-0-28" class="i">+        context.mappings.getMappedObjectNullable(&quot;FriendsFeedEventDispatcher&quot;).let { it as? Map&lt;*, *&gt; }?.let { mappings -&gt;
</a><a href="#h215-0-29" id="h215-0-29" class="i">+            findClass(mappings[&quot;class&quot;].toString()).hook(&quot;onItemLongPress&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h215-0-30" id="h215-0-30" class="i">+                val viewItemContainer = param.arg&lt;Any&gt;(0)
</a><a href="#h215-0-31" id="h215-0-31" class="i">+                val viewItem = viewItemContainer.getObjectField(mappings[&quot;viewModelField&quot;].toString()).toString()
</a><a href="#h215-0-32" id="h215-0-32" class="i">+                val conversationId = viewItem.substringAfter(&quot;conversationId: &quot;).substring(0, 36).also {
</a><a href="#h215-0-33" id="h215-0-33" class="i">+                    if (it.startsWith(&quot;null&quot;)) return@hook
</a><a href="#h215-0-34" id="h215-0-34" class="i">+                }
</a><a href="#h215-0-35" id="h215-0-35" class="i">+                context.database.getConversationType(conversationId)?.takeIf { it == 1 }?.run {
</a><a href="#h215-0-36" id="h215-0-36" class="i">+                    lastFetchGroupConversationUUID = SnapUUID.fromString(conversationId)
</a><a href="#h215-0-37" id="h215-0-37" class="i">+                }
</a><a href="#h215-0-38" id="h215-0-38" class="i">+            }
</a><a href="#h215-0-39" id="h215-0-39" class="i">+        }
</a><a href="#h215-0-40" id="h215-0-40" class="i">+
</a><a href="#h215-0-41" id="h215-0-41" class="i">+        context.mappings.getMappedClass(&quot;callbacks&quot;, &quot;GetOneOnOneConversationIdsCallback&quot;).hook(&quot;onSuccess&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h215-0-42" id="h215-0-42" class="i">+            val userIdToConversation = (param.arg&lt;ArrayList&lt;*&gt;&gt;(0))
</a><a href="#h215-0-43" id="h215-0-43" class="i">+                .takeIf { it.isNotEmpty() }
</a><a href="#h215-0-44" id="h215-0-44" class="i">+                ?.get(0) ?: return@hook
</a><a href="#h215-0-45" id="h215-0-45" class="i">+
</a><a href="#h215-0-46" id="h215-0-46" class="i">+            lastFetchConversationUUID = SnapUUID(userIdToConversation.getObjectField(&quot;mConversationId&quot;))
</a><a href="#h215-0-47" id="h215-0-47" class="i">+            lastFetchConversationUserUUID = SnapUUID(userIdToConversation.getObjectField(&quot;mUserId&quot;))
</a><a href="#h215-0-48" id="h215-0-48" class="i">+        }
</a><a href="#h215-0-49" id="h215-0-49" class="i">+
</a><a href="#h215-0-50" id="h215-0-50" class="i">+        with(context.classCache.conversationManager) {
</a><a href="#h215-0-51" id="h215-0-51" class="i">+            Hooker.hook(this, &quot;enterConversation&quot;, HookStage.BEFORE) {
</a><a href="#h215-0-52" id="h215-0-52" class="i">+                openedConversationUUID = SnapUUID(it.arg(0))
</a><a href="#h215-0-53" id="h215-0-53" class="i">+            }
</a><a href="#h215-0-54" id="h215-0-54" class="i">+
</a><a href="#h215-0-55" id="h215-0-55" class="i">+            Hooker.hook(this, &quot;exitConversation&quot;, HookStage.BEFORE) {
</a><a href="#h215-0-56" id="h215-0-56" class="i">+                openedConversationUUID = null
</a><a href="#h215-0-57" id="h215-0-57" class="i">+            }
</a><a href="#h215-0-58" id="h215-0-58" class="i">+        }
</a><a href="#h215-0-59" id="h215-0-59" class="i">+
</a><a href="#h215-0-60" id="h215-0-60" class="i">+    }
</a><a href="#h215-0-61" id="h215-0-61" class="i">+
</a><a href="#h215-0-62" id="h215-0-62" class="i">+    override fun asyncInit() {
</a><a href="#h215-0-63" id="h215-0-63" class="i">+        val stealthMode = context.feature(StealthMode::class)
</a><a href="#h215-0-64" id="h215-0-64" class="i">+
</a><a href="#h215-0-65" id="h215-0-65" class="i">+        val hideBitmojiPresence by context.config.messaging.hideBitmojiPresence
</a><a href="#h215-0-66" id="h215-0-66" class="i">+        val hideTypingNotification by context.config.messaging.hideTypingNotifications
</a><a href="#h215-0-67" id="h215-0-67" class="i">+
</a><a href="#h215-0-68" id="h215-0-68" class="i">+        arrayOf(&quot;activate&quot;, &quot;deactivate&quot;, &quot;processTypingActivity&quot;).forEach { hook -&gt;
</a><a href="#h215-0-69" id="h215-0-69" class="i">+            Hooker.hook(context.classCache.presenceSession, hook, HookStage.BEFORE, {
</a><a href="#h215-0-70" id="h215-0-70" class="i">+                hideBitmojiPresence || stealthMode.canUseRule(openedConversationUUID.toString())
</a><a href="#h215-0-71" id="h215-0-71" class="i">+            }) {
</a><a href="#h215-0-72" id="h215-0-72" class="i">+                it.setResult(null)
</a><a href="#h215-0-73" id="h215-0-73" class="i">+            }
</a><a href="#h215-0-74" id="h215-0-74" class="i">+        }
</a><a href="#h215-0-75" id="h215-0-75" class="i">+
</a><a href="#h215-0-76" id="h215-0-76" class="i">+        //get last opened snap for media downloader
</a><a href="#h215-0-77" id="h215-0-77" class="i">+        context.event.subscribe(OnSnapInteractionEvent::class) { event -&gt;
</a><a href="#h215-0-78" id="h215-0-78" class="i">+            openedConversationUUID = event.conversationId
</a><a href="#h215-0-79" id="h215-0-79" class="i">+            lastFocusedMessageId = event.messageId
</a><a href="#h215-0-80" id="h215-0-80" class="i">+        }
</a><a href="#h215-0-81" id="h215-0-81" class="i">+
</a><a href="#h215-0-82" id="h215-0-82" class="i">+        Hooker.hook(context.classCache.conversationManager, &quot;fetchMessage&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h215-0-83" id="h215-0-83" class="i">+            lastFetchConversationUserUUID = SnapUUID((param.arg(0) as Any))
</a><a href="#h215-0-84" id="h215-0-84" class="i">+            lastFocusedMessageId = param.arg(1)
</a><a href="#h215-0-85" id="h215-0-85" class="i">+        }
</a><a href="#h215-0-86" id="h215-0-86" class="i">+
</a><a href="#h215-0-87" id="h215-0-87" class="i">+        Hooker.hook(context.classCache.conversationManager, &quot;sendTypingNotification&quot;, HookStage.BEFORE, {
</a><a href="#h215-0-88" id="h215-0-88" class="i">+            hideTypingNotification || stealthMode.canUseRule(openedConversationUUID.toString())
</a><a href="#h215-0-89" id="h215-0-89" class="i">+        }) {
</a><a href="#h215-0-90" id="h215-0-90" class="i">+            it.setResult(null)
</a><a href="#h215-0-91" id="h215-0-91" class="i">+        }
</a><a href="#h215-0-92" id="h215-0-92" class="i">+    }
</a><a href="#h215-0-93" id="h215-0-93" class="i">+}</a><a href="#h215-0-94" id="h215-0-94" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h216" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/Notifications.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/Notifications.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/Notifications.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/Notifications.kt</a></b>
<a href="#h216-0" id="h216-0" class="h">@@ -0,0 +1,370 @@
</a><a href="#h216-0-0" id="h216-0-0" class="i">+package me.rhunk.snapenhance.core.features.impl.messaging
</a><a href="#h216-0-1" id="h216-0-1" class="i">+
</a><a href="#h216-0-2" id="h216-0-2" class="i">+import android.app.Notification
</a><a href="#h216-0-3" id="h216-0-3" class="i">+import android.app.NotificationManager
</a><a href="#h216-0-4" id="h216-0-4" class="i">+import android.app.PendingIntent
</a><a href="#h216-0-5" id="h216-0-5" class="i">+import android.app.RemoteInput
</a><a href="#h216-0-6" id="h216-0-6" class="i">+import android.content.Context
</a><a href="#h216-0-7" id="h216-0-7" class="i">+import android.content.Intent
</a><a href="#h216-0-8" id="h216-0-8" class="i">+import android.graphics.Bitmap
</a><a href="#h216-0-9" id="h216-0-9" class="i">+import android.graphics.BitmapFactory
</a><a href="#h216-0-10" id="h216-0-10" class="i">+import android.os.Bundle
</a><a href="#h216-0-11" id="h216-0-11" class="i">+import android.os.UserHandle
</a><a href="#h216-0-12" id="h216-0-12" class="i">+import de.robv.android.xposed.XposedBridge
</a><a href="#h216-0-13" id="h216-0-13" class="i">+import de.robv.android.xposed.XposedHelpers
</a><a href="#h216-0-14" id="h216-0-14" class="i">+import me.rhunk.snapenhance.common.data.ContentType
</a><a href="#h216-0-15" id="h216-0-15" class="i">+import me.rhunk.snapenhance.common.data.MediaReferenceType
</a><a href="#h216-0-16" id="h216-0-16" class="i">+import me.rhunk.snapenhance.common.data.download.SplitMediaAssetType
</a><a href="#h216-0-17" id="h216-0-17" class="i">+import me.rhunk.snapenhance.common.util.protobuf.ProtoReader
</a><a href="#h216-0-18" id="h216-0-18" class="i">+import me.rhunk.snapenhance.common.util.snap.MediaDownloaderHelper
</a><a href="#h216-0-19" id="h216-0-19" class="i">+import me.rhunk.snapenhance.common.util.snap.RemoteMediaResolver
</a><a href="#h216-0-20" id="h216-0-20" class="i">+import me.rhunk.snapenhance.common.util.snap.SnapWidgetBroadcastReceiverHelper
</a><a href="#h216-0-21" id="h216-0-21" class="i">+import me.rhunk.snapenhance.core.event.events.impl.SnapWidgetBroadcastReceiveEvent
</a><a href="#h216-0-22" id="h216-0-22" class="i">+import me.rhunk.snapenhance.core.features.Feature
</a><a href="#h216-0-23" id="h216-0-23" class="i">+import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a><a href="#h216-0-24" id="h216-0-24" class="i">+import me.rhunk.snapenhance.core.features.impl.downloader.MediaDownloader
</a><a href="#h216-0-25" id="h216-0-25" class="i">+import me.rhunk.snapenhance.core.features.impl.downloader.decoder.MessageDecoder
</a><a href="#h216-0-26" id="h216-0-26" class="i">+import me.rhunk.snapenhance.core.logger.CoreLogger
</a><a href="#h216-0-27" id="h216-0-27" class="i">+import me.rhunk.snapenhance.core.util.CallbackBuilder
</a><a href="#h216-0-28" id="h216-0-28" class="i">+import me.rhunk.snapenhance.core.util.hook.HookStage
</a><a href="#h216-0-29" id="h216-0-29" class="i">+import me.rhunk.snapenhance.core.util.hook.Hooker
</a><a href="#h216-0-30" id="h216-0-30" class="i">+import me.rhunk.snapenhance.core.util.hook.hook
</a><a href="#h216-0-31" id="h216-0-31" class="i">+import me.rhunk.snapenhance.core.util.ktx.setObjectField
</a><a href="#h216-0-32" id="h216-0-32" class="i">+import me.rhunk.snapenhance.core.util.media.PreviewUtils
</a><a href="#h216-0-33" id="h216-0-33" class="i">+import me.rhunk.snapenhance.core.wrapper.impl.Message
</a><a href="#h216-0-34" id="h216-0-34" class="i">+import me.rhunk.snapenhance.core.wrapper.impl.SnapUUID
</a><a href="#h216-0-35" id="h216-0-35" class="i">+
</a><a href="#h216-0-36" id="h216-0-36" class="i">+class Notifications : Feature(&quot;Notifications&quot;, loadParams = FeatureLoadParams.INIT_SYNC) {
</a><a href="#h216-0-37" id="h216-0-37" class="i">+    companion object{
</a><a href="#h216-0-38" id="h216-0-38" class="i">+        const val ACTION_REPLY = &quot;me.rhunk.snapenhance.action.notification.REPLY&quot;
</a><a href="#h216-0-39" id="h216-0-39" class="i">+        const val ACTION_DOWNLOAD = &quot;me.rhunk.snapenhance.action.notification.DOWNLOAD&quot;
</a><a href="#h216-0-40" id="h216-0-40" class="i">+        const val SNAPCHAT_NOTIFICATION_GROUP = &quot;snapchat_notification_group&quot;
</a><a href="#h216-0-41" id="h216-0-41" class="i">+    }
</a><a href="#h216-0-42" id="h216-0-42" class="i">+
</a><a href="#h216-0-43" id="h216-0-43" class="i">+    private val notificationDataQueue = mutableMapOf&lt;Long, NotificationData&gt;() // messageId =&gt; notification
</a><a href="#h216-0-44" id="h216-0-44" class="i">+    private val cachedMessages = mutableMapOf&lt;String, MutableList&lt;String&gt;&gt;() // conversationId =&gt; cached messages
</a><a href="#h216-0-45" id="h216-0-45" class="i">+    private val notificationIdMap = mutableMapOf&lt;Int, String&gt;() // notificationId =&gt; conversationId
</a><a href="#h216-0-46" id="h216-0-46" class="i">+
</a><a href="#h216-0-47" id="h216-0-47" class="i">+    private val notifyAsUserMethod by lazy {
</a><a href="#h216-0-48" id="h216-0-48" class="i">+        XposedHelpers.findMethodExact(
</a><a href="#h216-0-49" id="h216-0-49" class="i">+            NotificationManager::class.java, &quot;notifyAsUser&quot;,
</a><a href="#h216-0-50" id="h216-0-50" class="i">+            String::class.java,
</a><a href="#h216-0-51" id="h216-0-51" class="i">+            Int::class.javaPrimitiveType,
</a><a href="#h216-0-52" id="h216-0-52" class="i">+            Notification::class.java,
</a><a href="#h216-0-53" id="h216-0-53" class="i">+            UserHandle::class.java
</a><a href="#h216-0-54" id="h216-0-54" class="i">+        )
</a><a href="#h216-0-55" id="h216-0-55" class="i">+    }
</a><a href="#h216-0-56" id="h216-0-56" class="i">+
</a><a href="#h216-0-57" id="h216-0-57" class="i">+    private val fetchConversationWithMessagesMethod by lazy {
</a><a href="#h216-0-58" id="h216-0-58" class="i">+        context.classCache.conversationManager.methods.first { it.name == &quot;fetchConversationWithMessages&quot;}
</a><a href="#h216-0-59" id="h216-0-59" class="i">+    }
</a><a href="#h216-0-60" id="h216-0-60" class="i">+
</a><a href="#h216-0-61" id="h216-0-61" class="i">+    private val notificationManager by lazy {
</a><a href="#h216-0-62" id="h216-0-62" class="i">+        context.androidContext.getSystemService(Context.NOTIFICATION_SERVICE) as NotificationManager
</a><a href="#h216-0-63" id="h216-0-63" class="i">+    }
</a><a href="#h216-0-64" id="h216-0-64" class="i">+
</a><a href="#h216-0-65" id="h216-0-65" class="i">+    private val betterNotificationFilter by lazy {
</a><a href="#h216-0-66" id="h216-0-66" class="i">+        context.config.messaging.betterNotifications.get()
</a><a href="#h216-0-67" id="h216-0-67" class="i">+    }
</a><a href="#h216-0-68" id="h216-0-68" class="i">+
</a><a href="#h216-0-69" id="h216-0-69" class="i">+    private fun setNotificationText(notification: Notification, conversationId: String) {
</a><a href="#h216-0-70" id="h216-0-70" class="i">+        val messageText = StringBuilder().apply {
</a><a href="#h216-0-71" id="h216-0-71" class="i">+            cachedMessages.computeIfAbsent(conversationId) { mutableListOf() }.forEach {
</a><a href="#h216-0-72" id="h216-0-72" class="i">+                if (isNotEmpty()) append(&quot;\n&quot;)
</a><a href="#h216-0-73" id="h216-0-73" class="i">+                append(it)
</a><a href="#h216-0-74" id="h216-0-74" class="i">+            }
</a><a href="#h216-0-75" id="h216-0-75" class="i">+        }.toString()
</a><a href="#h216-0-76" id="h216-0-76" class="i">+
</a><a href="#h216-0-77" id="h216-0-77" class="i">+        with(notification.extras) {
</a><a href="#h216-0-78" id="h216-0-78" class="i">+            putString(&quot;android.text&quot;, messageText)
</a><a href="#h216-0-79" id="h216-0-79" class="i">+            putString(&quot;android.bigText&quot;, messageText)
</a><a href="#h216-0-80" id="h216-0-80" class="i">+            putParcelableArray(&quot;android.messages&quot;, messageText.split(&quot;\n&quot;).map {
</a><a href="#h216-0-81" id="h216-0-81" class="i">+                Bundle().apply {
</a><a href="#h216-0-82" id="h216-0-82" class="i">+                    putBundle(&quot;extras&quot;, Bundle())
</a><a href="#h216-0-83" id="h216-0-83" class="i">+                    putString(&quot;text&quot;, it)
</a><a href="#h216-0-84" id="h216-0-84" class="i">+                    putLong(&quot;time&quot;, System.currentTimeMillis())
</a><a href="#h216-0-85" id="h216-0-85" class="i">+                }
</a><a href="#h216-0-86" id="h216-0-86" class="i">+            }.toTypedArray())
</a><a href="#h216-0-87" id="h216-0-87" class="i">+        }
</a><a href="#h216-0-88" id="h216-0-88" class="i">+    }
</a><a href="#h216-0-89" id="h216-0-89" class="i">+
</a><a href="#h216-0-90" id="h216-0-90" class="i">+    private fun setupNotificationActionButtons(contentType: ContentType, conversationId: String, messageId: Long, notificationData: NotificationData) {
</a><a href="#h216-0-91" id="h216-0-91" class="i">+
</a><a href="#h216-0-92" id="h216-0-92" class="i">+        val notificationBuilder = XposedHelpers.newInstance(
</a><a href="#h216-0-93" id="h216-0-93" class="i">+            Notification.Builder::class.java,
</a><a href="#h216-0-94" id="h216-0-94" class="i">+            context.androidContext,
</a><a href="#h216-0-95" id="h216-0-95" class="i">+            notificationData.notification
</a><a href="#h216-0-96" id="h216-0-96" class="i">+        ) as Notification.Builder
</a><a href="#h216-0-97" id="h216-0-97" class="i">+
</a><a href="#h216-0-98" id="h216-0-98" class="i">+        val actions = mutableListOf&lt;Notification.Action&gt;()
</a><a href="#h216-0-99" id="h216-0-99" class="i">+        actions.addAll(notificationData.notification.actions)
</a><a href="#h216-0-100" id="h216-0-100" class="i">+
</a><a href="#h216-0-101" id="h216-0-101" class="i">+        fun newAction(title: String, remoteAction: String, filter: (() -&gt; Boolean), builder: (Notification.Action.Builder) -&gt; Unit) {
</a><a href="#h216-0-102" id="h216-0-102" class="i">+            if (!filter()) return
</a><a href="#h216-0-103" id="h216-0-103" class="i">+
</a><a href="#h216-0-104" id="h216-0-104" class="i">+            val intent = SnapWidgetBroadcastReceiverHelper.create(remoteAction) {
</a><a href="#h216-0-105" id="h216-0-105" class="i">+                putExtra(&quot;conversation_id&quot;, conversationId)
</a><a href="#h216-0-106" id="h216-0-106" class="i">+                putExtra(&quot;notification_id&quot;, notificationData.id)
</a><a href="#h216-0-107" id="h216-0-107" class="i">+                putExtra(&quot;message_id&quot;, messageId)
</a><a href="#h216-0-108" id="h216-0-108" class="i">+            }
</a><a href="#h216-0-109" id="h216-0-109" class="i">+
</a><a href="#h216-0-110" id="h216-0-110" class="i">+            val action = Notification.Action.Builder(null, title, PendingIntent.getBroadcast(
</a><a href="#h216-0-111" id="h216-0-111" class="i">+                context.androidContext,
</a><a href="#h216-0-112" id="h216-0-112" class="i">+                System.nanoTime().toInt(),
</a><a href="#h216-0-113" id="h216-0-113" class="i">+                intent,
</a><a href="#h216-0-114" id="h216-0-114" class="i">+                PendingIntent.FLAG_MUTABLE
</a><a href="#h216-0-115" id="h216-0-115" class="i">+            )).apply(builder).build()
</a><a href="#h216-0-116" id="h216-0-116" class="i">+            actions.add(action)
</a><a href="#h216-0-117" id="h216-0-117" class="i">+        }
</a><a href="#h216-0-118" id="h216-0-118" class="i">+
</a><a href="#h216-0-119" id="h216-0-119" class="i">+        newAction(&quot;Reply&quot;, ACTION_REPLY, {
</a><a href="#h216-0-120" id="h216-0-120" class="i">+            betterNotificationFilter.contains(&quot;reply_button&quot;) &amp;&amp; contentType == ContentType.CHAT
</a><a href="#h216-0-121" id="h216-0-121" class="i">+        }) {
</a><a href="#h216-0-122" id="h216-0-122" class="i">+            val chatReplyInput = RemoteInput.Builder(&quot;chat_reply_input&quot;)
</a><a href="#h216-0-123" id="h216-0-123" class="i">+                .setLabel(&quot;Reply&quot;)
</a><a href="#h216-0-124" id="h216-0-124" class="i">+                .build()
</a><a href="#h216-0-125" id="h216-0-125" class="i">+            it.addRemoteInput(chatReplyInput)
</a><a href="#h216-0-126" id="h216-0-126" class="i">+        }
</a><a href="#h216-0-127" id="h216-0-127" class="i">+
</a><a href="#h216-0-128" id="h216-0-128" class="i">+        newAction(&quot;Download&quot;, ACTION_DOWNLOAD, {
</a><a href="#h216-0-129" id="h216-0-129" class="i">+            betterNotificationFilter.contains(&quot;download_button&quot;) &amp;&amp; (contentType == ContentType.EXTERNAL_MEDIA || contentType == ContentType.SNAP)
</a><a href="#h216-0-130" id="h216-0-130" class="i">+        }) {}
</a><a href="#h216-0-131" id="h216-0-131" class="i">+
</a><a href="#h216-0-132" id="h216-0-132" class="i">+        notificationBuilder.setActions(*actions.toTypedArray())
</a><a href="#h216-0-133" id="h216-0-133" class="i">+        notificationData.notification = notificationBuilder.build()
</a><a href="#h216-0-134" id="h216-0-134" class="i">+    }
</a><a href="#h216-0-135" id="h216-0-135" class="i">+
</a><a href="#h216-0-136" id="h216-0-136" class="i">+    private fun setupBroadcastReceiverHook() {
</a><a href="#h216-0-137" id="h216-0-137" class="i">+        context.event.subscribe(SnapWidgetBroadcastReceiveEvent::class) { event -&gt;
</a><a href="#h216-0-138" id="h216-0-138" class="i">+            val intent = event.intent ?: return@subscribe
</a><a href="#h216-0-139" id="h216-0-139" class="i">+            val conversationId = intent.getStringExtra(&quot;conversation_id&quot;) ?: return@subscribe
</a><a href="#h216-0-140" id="h216-0-140" class="i">+            val messageId = intent.getLongExtra(&quot;message_id&quot;, -1)
</a><a href="#h216-0-141" id="h216-0-141" class="i">+            val notificationId = intent.getIntExtra(&quot;notification_id&quot;, -1)
</a><a href="#h216-0-142" id="h216-0-142" class="i">+            val notificationManager = event.androidContext.getSystemService(Context.NOTIFICATION_SERVICE) as NotificationManager
</a><a href="#h216-0-143" id="h216-0-143" class="i">+
</a><a href="#h216-0-144" id="h216-0-144" class="i">+            val updateNotification: (Int, (Notification) -&gt; Unit) -&gt; Unit = { id, notificationBuilder -&gt;
</a><a href="#h216-0-145" id="h216-0-145" class="i">+                notificationManager.activeNotifications.firstOrNull { it.id == id }?.let {
</a><a href="#h216-0-146" id="h216-0-146" class="i">+                    notificationBuilder(it.notification)
</a><a href="#h216-0-147" id="h216-0-147" class="i">+                    XposedBridge.invokeOriginalMethod(notifyAsUserMethod, notificationManager, arrayOf(
</a><a href="#h216-0-148" id="h216-0-148" class="i">+                        it.tag, it.id, it.notification, it.user
</a><a href="#h216-0-149" id="h216-0-149" class="i">+                    ))
</a><a href="#h216-0-150" id="h216-0-150" class="i">+                }
</a><a href="#h216-0-151" id="h216-0-151" class="i">+            }
</a><a href="#h216-0-152" id="h216-0-152" class="i">+
</a><a href="#h216-0-153" id="h216-0-153" class="i">+            when (event.action) {
</a><a href="#h216-0-154" id="h216-0-154" class="i">+                ACTION_REPLY -&gt; {
</a><a href="#h216-0-155" id="h216-0-155" class="i">+                    val input = RemoteInput.getResultsFromIntent(intent).getCharSequence(&quot;chat_reply_input&quot;)
</a><a href="#h216-0-156" id="h216-0-156" class="i">+                        .toString()
</a><a href="#h216-0-157" id="h216-0-157" class="i">+
</a><a href="#h216-0-158" id="h216-0-158" class="i">+                    context.database.myUserId.let { context.database.getFriendInfo(it) }?.let { myUser -&gt;
</a><a href="#h216-0-159" id="h216-0-159" class="i">+                        cachedMessages.computeIfAbsent(conversationId) { mutableListOf() }.add(&quot;${myUser.displayName}: $input&quot;)
</a><a href="#h216-0-160" id="h216-0-160" class="i">+
</a><a href="#h216-0-161" id="h216-0-161" class="i">+                        updateNotification(notificationId) { notification -&gt;
</a><a href="#h216-0-162" id="h216-0-162" class="i">+                            notification.flags = notification.flags or Notification.FLAG_ONLY_ALERT_ONCE
</a><a href="#h216-0-163" id="h216-0-163" class="i">+                            setNotificationText(notification, conversationId)
</a><a href="#h216-0-164" id="h216-0-164" class="i">+                        }
</a><a href="#h216-0-165" id="h216-0-165" class="i">+
</a><a href="#h216-0-166" id="h216-0-166" class="i">+                        context.messageSender.sendChatMessage(listOf(SnapUUID.fromString(conversationId)), input, onError = {
</a><a href="#h216-0-167" id="h216-0-167" class="i">+                            context.longToast(&quot;Failed to send message: $it&quot;)
</a><a href="#h216-0-168" id="h216-0-168" class="i">+                        })
</a><a href="#h216-0-169" id="h216-0-169" class="i">+                    }
</a><a href="#h216-0-170" id="h216-0-170" class="i">+                }
</a><a href="#h216-0-171" id="h216-0-171" class="i">+                ACTION_DOWNLOAD -&gt; {
</a><a href="#h216-0-172" id="h216-0-172" class="i">+                    runCatching {
</a><a href="#h216-0-173" id="h216-0-173" class="i">+                        context.feature(MediaDownloader::class).downloadMessageId(messageId, isPreview = false)
</a><a href="#h216-0-174" id="h216-0-174" class="i">+                    }.onFailure {
</a><a href="#h216-0-175" id="h216-0-175" class="i">+                        context.longToast(it)
</a><a href="#h216-0-176" id="h216-0-176" class="i">+                    }
</a><a href="#h216-0-177" id="h216-0-177" class="i">+                }
</a><a href="#h216-0-178" id="h216-0-178" class="i">+                else -&gt; return@subscribe
</a><a href="#h216-0-179" id="h216-0-179" class="i">+            }
</a><a href="#h216-0-180" id="h216-0-180" class="i">+
</a><a href="#h216-0-181" id="h216-0-181" class="i">+            event.canceled = true
</a><a href="#h216-0-182" id="h216-0-182" class="i">+        }
</a><a href="#h216-0-183" id="h216-0-183" class="i">+    }
</a><a href="#h216-0-184" id="h216-0-184" class="i">+
</a><a href="#h216-0-185" id="h216-0-185" class="i">+    private fun fetchMessagesResult(conversationId: String, messages: List&lt;Message&gt;) {
</a><a href="#h216-0-186" id="h216-0-186" class="i">+        val sendNotificationData = { notificationData: NotificationData, forceCreate: Boolean  -&gt;
</a><a href="#h216-0-187" id="h216-0-187" class="i">+            val notificationId = if (forceCreate) System.nanoTime().toInt() else notificationData.id
</a><a href="#h216-0-188" id="h216-0-188" class="i">+            notificationIdMap.computeIfAbsent(notificationId) { conversationId }
</a><a href="#h216-0-189" id="h216-0-189" class="i">+            if (betterNotificationFilter.contains(&quot;group&quot;)) {
</a><a href="#h216-0-190" id="h216-0-190" class="i">+                runCatching {
</a><a href="#h216-0-191" id="h216-0-191" class="i">+                    notificationData.notification.setObjectField(&quot;mGroupKey&quot;, SNAPCHAT_NOTIFICATION_GROUP)
</a><a href="#h216-0-192" id="h216-0-192" class="i">+
</a><a href="#h216-0-193" id="h216-0-193" class="i">+                    val summaryNotification = Notification.Builder(context.androidContext, notificationData.notification.channelId)
</a><a href="#h216-0-194" id="h216-0-194" class="i">+                        .setSmallIcon(notificationData.notification.smallIcon)
</a><a href="#h216-0-195" id="h216-0-195" class="i">+                        .setGroup(SNAPCHAT_NOTIFICATION_GROUP)
</a><a href="#h216-0-196" id="h216-0-196" class="i">+                        .setGroupSummary(true)
</a><a href="#h216-0-197" id="h216-0-197" class="i">+                        .setAutoCancel(true)
</a><a href="#h216-0-198" id="h216-0-198" class="i">+                        .setOnlyAlertOnce(true)
</a><a href="#h216-0-199" id="h216-0-199" class="i">+                        .build()
</a><a href="#h216-0-200" id="h216-0-200" class="i">+
</a><a href="#h216-0-201" id="h216-0-201" class="i">+                    if (notificationManager.activeNotifications.firstOrNull { it.notification.flags and Notification.FLAG_GROUP_SUMMARY != 0 } == null) {
</a><a href="#h216-0-202" id="h216-0-202" class="i">+                        notificationManager.notify(notificationData.tag, notificationData.id, summaryNotification)
</a><a href="#h216-0-203" id="h216-0-203" class="i">+                    }
</a><a href="#h216-0-204" id="h216-0-204" class="i">+                }.onFailure {
</a><a href="#h216-0-205" id="h216-0-205" class="i">+                    context.log.warn(&quot;Failed to set notification group key: ${it.stackTraceToString()}&quot;, featureKey)
</a><a href="#h216-0-206" id="h216-0-206" class="i">+                }
</a><a href="#h216-0-207" id="h216-0-207" class="i">+            }
</a><a href="#h216-0-208" id="h216-0-208" class="i">+
</a><a href="#h216-0-209" id="h216-0-209" class="i">+            XposedBridge.invokeOriginalMethod(notifyAsUserMethod, notificationManager, arrayOf(
</a><a href="#h216-0-210" id="h216-0-210" class="i">+                notificationData.tag, if (forceCreate) System.nanoTime().toInt() else notificationData.id, notificationData.notification, notificationData.userHandle
</a><a href="#h216-0-211" id="h216-0-211" class="i">+            ))
</a><a href="#h216-0-212" id="h216-0-212" class="i">+        }
</a><a href="#h216-0-213" id="h216-0-213" class="i">+
</a><a href="#h216-0-214" id="h216-0-214" class="i">+        synchronized(notificationDataQueue) {
</a><a href="#h216-0-215" id="h216-0-215" class="i">+            notificationDataQueue.entries.onEach { (messageId, notificationData) -&gt;
</a><a href="#h216-0-216" id="h216-0-216" class="i">+                val snapMessage = messages.firstOrNull { message -&gt; message.orderKey == messageId } ?: return
</a><a href="#h216-0-217" id="h216-0-217" class="i">+                val senderUsername by lazy {
</a><a href="#h216-0-218" id="h216-0-218" class="i">+                    context.database.getFriendInfo(snapMessage.senderId.toString())?.let {
</a><a href="#h216-0-219" id="h216-0-219" class="i">+                        it.displayName ?: it.mutableUsername
</a><a href="#h216-0-220" id="h216-0-220" class="i">+                    }
</a><a href="#h216-0-221" id="h216-0-221" class="i">+                }
</a><a href="#h216-0-222" id="h216-0-222" class="i">+
</a><a href="#h216-0-223" id="h216-0-223" class="i">+                val contentType = snapMessage.messageContent.contentType ?: return@onEach
</a><a href="#h216-0-224" id="h216-0-224" class="i">+                val contentData = snapMessage.messageContent.content
</a><a href="#h216-0-225" id="h216-0-225" class="i">+
</a><a href="#h216-0-226" id="h216-0-226" class="i">+                val formatUsername: (String) -&gt; String = { &quot;$senderUsername: $it&quot; }
</a><a href="#h216-0-227" id="h216-0-227" class="i">+                val notificationCache = cachedMessages.let { it.computeIfAbsent(conversationId) { mutableListOf() } }
</a><a href="#h216-0-228" id="h216-0-228" class="i">+                val appendNotifications: () -&gt; Unit = { setNotificationText(notificationData.notification, conversationId)}
</a><a href="#h216-0-229" id="h216-0-229" class="i">+
</a><a href="#h216-0-230" id="h216-0-230" class="i">+                setupNotificationActionButtons(contentType, conversationId, snapMessage.messageDescriptor.messageId, notificationData)
</a><a href="#h216-0-231" id="h216-0-231" class="i">+
</a><a href="#h216-0-232" id="h216-0-232" class="i">+                when (contentType) {
</a><a href="#h216-0-233" id="h216-0-233" class="i">+                    ContentType.NOTE -&gt; {
</a><a href="#h216-0-234" id="h216-0-234" class="i">+                        notificationCache.add(formatUsername(&quot;sent audio note&quot;))
</a><a href="#h216-0-235" id="h216-0-235" class="i">+                        appendNotifications()
</a><a href="#h216-0-236" id="h216-0-236" class="i">+                    }
</a><a href="#h216-0-237" id="h216-0-237" class="i">+                    ContentType.CHAT -&gt; {
</a><a href="#h216-0-238" id="h216-0-238" class="i">+                        ProtoReader(contentData).getString(2, 1)?.trim()?.let {
</a><a href="#h216-0-239" id="h216-0-239" class="i">+                            notificationCache.add(formatUsername(it))
</a><a href="#h216-0-240" id="h216-0-240" class="i">+                        }
</a><a href="#h216-0-241" id="h216-0-241" class="i">+                        appendNotifications()
</a><a href="#h216-0-242" id="h216-0-242" class="i">+                    }
</a><a href="#h216-0-243" id="h216-0-243" class="i">+                    ContentType.SNAP, ContentType.EXTERNAL_MEDIA -&gt; {
</a><a href="#h216-0-244" id="h216-0-244" class="i">+                        val mediaReferences = MessageDecoder.getMediaReferences(
</a><a href="#h216-0-245" id="h216-0-245" class="i">+                            messageContent = context.gson.toJsonTree(snapMessage.messageContent.instanceNonNull())
</a><a href="#h216-0-246" id="h216-0-246" class="i">+                        )
</a><a href="#h216-0-247" id="h216-0-247" class="i">+
</a><a href="#h216-0-248" id="h216-0-248" class="i">+                        val mediaReferenceKeys = mediaReferences.map { reference -&gt;
</a><a href="#h216-0-249" id="h216-0-249" class="i">+                            reference.asJsonObject.getAsJsonArray(&quot;mContentObject&quot;).map { it.asByte }.toByteArray()
</a><a href="#h216-0-250" id="h216-0-250" class="i">+                        }
</a><a href="#h216-0-251" id="h216-0-251" class="i">+
</a><a href="#h216-0-252" id="h216-0-252" class="i">+                        MessageDecoder.decode(snapMessage.messageContent).firstOrNull()?.also { media -&gt;
</a><a href="#h216-0-253" id="h216-0-253" class="i">+                            val mediaType = MediaReferenceType.valueOf(mediaReferences.first().asJsonObject[&quot;mMediaType&quot;].asString)
</a><a href="#h216-0-254" id="h216-0-254" class="i">+
</a><a href="#h216-0-255" id="h216-0-255" class="i">+                            runCatching {
</a><a href="#h216-0-256" id="h216-0-256" class="i">+                                val downloadedMedia = RemoteMediaResolver.downloadBoltMedia(mediaReferenceKeys.first(), decryptionCallback =  {
</a><a href="#h216-0-257" id="h216-0-257" class="i">+                                    media.attachmentInfo?.encryption?.decryptInputStream(it) ?: it
</a><a href="#h216-0-258" id="h216-0-258" class="i">+                                }) ?: throw Throwable(&quot;Unable to download media&quot;)
</a><a href="#h216-0-259" id="h216-0-259" class="i">+
</a><a href="#h216-0-260" id="h216-0-260" class="i">+                                val downloadedMedias = mutableMapOf&lt;SplitMediaAssetType, ByteArray&gt;()
</a><a href="#h216-0-261" id="h216-0-261" class="i">+
</a><a href="#h216-0-262" id="h216-0-262" class="i">+                                MediaDownloaderHelper.getSplitElements(downloadedMedia.inputStream()) { type, inputStream -&gt;
</a><a href="#h216-0-263" id="h216-0-263" class="i">+                                    downloadedMedias[type] = inputStream.readBytes()
</a><a href="#h216-0-264" id="h216-0-264" class="i">+                                }
</a><a href="#h216-0-265" id="h216-0-265" class="i">+
</a><a href="#h216-0-266" id="h216-0-266" class="i">+                                var bitmapPreview = PreviewUtils.createPreview(downloadedMedias[SplitMediaAssetType.ORIGINAL]!!, mediaType.name.contains(&quot;VIDEO&quot;))!!
</a><a href="#h216-0-267" id="h216-0-267" class="i">+
</a><a href="#h216-0-268" id="h216-0-268" class="i">+                                downloadedMedias[SplitMediaAssetType.OVERLAY]?.let {
</a><a href="#h216-0-269" id="h216-0-269" class="i">+                                    bitmapPreview = PreviewUtils.mergeBitmapOverlay(bitmapPreview, BitmapFactory.decodeByteArray(it, 0, it.size))
</a><a href="#h216-0-270" id="h216-0-270" class="i">+                                }
</a><a href="#h216-0-271" id="h216-0-271" class="i">+
</a><a href="#h216-0-272" id="h216-0-272" class="i">+                                val notificationBuilder = XposedHelpers.newInstance(
</a><a href="#h216-0-273" id="h216-0-273" class="i">+                                    Notification.Builder::class.java,
</a><a href="#h216-0-274" id="h216-0-274" class="i">+                                    context.androidContext,
</a><a href="#h216-0-275" id="h216-0-275" class="i">+                                    notificationData.notification
</a><a href="#h216-0-276" id="h216-0-276" class="i">+                                ) as Notification.Builder
</a><a href="#h216-0-277" id="h216-0-277" class="i">+                                notificationBuilder.setLargeIcon(bitmapPreview)
</a><a href="#h216-0-278" id="h216-0-278" class="i">+                                notificationBuilder.style = Notification.BigPictureStyle().bigPicture(bitmapPreview).bigLargeIcon(null as Bitmap?)
</a><a href="#h216-0-279" id="h216-0-279" class="i">+
</a><a href="#h216-0-280" id="h216-0-280" class="i">+                                sendNotificationData(notificationData.copy(notification = notificationBuilder.build()), true)
</a><a href="#h216-0-281" id="h216-0-281" class="i">+                                return@onEach
</a><a href="#h216-0-282" id="h216-0-282" class="i">+                            }.onFailure {
</a><a href="#h216-0-283" id="h216-0-283" class="i">+                                CoreLogger.xposedLog(&quot;Failed to send preview notification&quot;, it)
</a><a href="#h216-0-284" id="h216-0-284" class="i">+                            }
</a><a href="#h216-0-285" id="h216-0-285" class="i">+                        }
</a><a href="#h216-0-286" id="h216-0-286" class="i">+                    }
</a><a href="#h216-0-287" id="h216-0-287" class="i">+                    else -&gt; {
</a><a href="#h216-0-288" id="h216-0-288" class="i">+                        notificationCache.add(formatUsername(&quot;sent ${contentType.name.lowercase()}&quot;))
</a><a href="#h216-0-289" id="h216-0-289" class="i">+                        appendNotifications()
</a><a href="#h216-0-290" id="h216-0-290" class="i">+                    }
</a><a href="#h216-0-291" id="h216-0-291" class="i">+                }
</a><a href="#h216-0-292" id="h216-0-292" class="i">+
</a><a href="#h216-0-293" id="h216-0-293" class="i">+                sendNotificationData(notificationData, false)
</a><a href="#h216-0-294" id="h216-0-294" class="i">+            }.clear()
</a><a href="#h216-0-295" id="h216-0-295" class="i">+        }
</a><a href="#h216-0-296" id="h216-0-296" class="i">+    }
</a><a href="#h216-0-297" id="h216-0-297" class="i">+
</a><a href="#h216-0-298" id="h216-0-298" class="i">+    override fun init() {
</a><a href="#h216-0-299" id="h216-0-299" class="i">+        setupBroadcastReceiverHook()
</a><a href="#h216-0-300" id="h216-0-300" class="i">+
</a><a href="#h216-0-301" id="h216-0-301" class="i">+        val fetchConversationWithMessagesCallback = context.mappings.getMappedClass(&quot;callbacks&quot;, &quot;FetchConversationWithMessagesCallback&quot;)
</a><a href="#h216-0-302" id="h216-0-302" class="i">+
</a><a href="#h216-0-303" id="h216-0-303" class="i">+        Hooker.hook(notifyAsUserMethod, HookStage.BEFORE) { param -&gt;
</a><a href="#h216-0-304" id="h216-0-304" class="i">+            val notificationData = NotificationData(param.argNullable(0), param.arg(1), param.arg(2), param.arg(3))
</a><a href="#h216-0-305" id="h216-0-305" class="i">+
</a><a href="#h216-0-306" id="h216-0-306" class="i">+            val extras: Bundle = notificationData.notification.extras.getBundle(&quot;system_notification_extras&quot;)?: return@hook
</a><a href="#h216-0-307" id="h216-0-307" class="i">+
</a><a href="#h216-0-308" id="h216-0-308" class="i">+            val messageId = extras.getString(&quot;message_id&quot;) ?: return@hook
</a><a href="#h216-0-309" id="h216-0-309" class="i">+            val notificationType = extras.getString(&quot;notification_type&quot;) ?: return@hook
</a><a href="#h216-0-310" id="h216-0-310" class="i">+            val conversationId = extras.getString(&quot;conversation_id&quot;) ?: return@hook
</a><a href="#h216-0-311" id="h216-0-311" class="i">+
</a><a href="#h216-0-312" id="h216-0-312" class="i">+            if (betterNotificationFilter.map { it.uppercase() }.none {
</a><a href="#h216-0-313" id="h216-0-313" class="i">+                    notificationType.contains(it)
</a><a href="#h216-0-314" id="h216-0-314" class="i">+                }) return@hook
</a><a href="#h216-0-315" id="h216-0-315" class="i">+
</a><a href="#h216-0-316" id="h216-0-316" class="i">+            val conversationManager: Any = context.feature(Messaging::class).conversationManager
</a><a href="#h216-0-317" id="h216-0-317" class="i">+
</a><a href="#h216-0-318" id="h216-0-318" class="i">+            synchronized(notificationDataQueue) {
</a><a href="#h216-0-319" id="h216-0-319" class="i">+                notificationDataQueue[messageId.toLong()] = notificationData
</a><a href="#h216-0-320" id="h216-0-320" class="i">+            }
</a><a href="#h216-0-321" id="h216-0-321" class="i">+
</a><a href="#h216-0-322" id="h216-0-322" class="i">+            val callback = CallbackBuilder(fetchConversationWithMessagesCallback)
</a><a href="#h216-0-323" id="h216-0-323" class="i">+                .override(&quot;onFetchConversationWithMessagesComplete&quot;) { callbackParam -&gt;
</a><a href="#h216-0-324" id="h216-0-324" class="i">+                    val messageList = (callbackParam.arg(1) as List&lt;Any&gt;).map { msg -&gt; Message(msg) }
</a><a href="#h216-0-325" id="h216-0-325" class="i">+                    fetchMessagesResult(conversationId, messageList)
</a><a href="#h216-0-326" id="h216-0-326" class="i">+                }
</a><a href="#h216-0-327" id="h216-0-327" class="i">+                .override(&quot;onError&quot;) {
</a><a href="#h216-0-328" id="h216-0-328" class="i">+                    context.log.error(&quot;Failed to fetch message ${it.arg(0) as Any}&quot;)
</a><a href="#h216-0-329" id="h216-0-329" class="i">+                }.build()
</a><a href="#h216-0-330" id="h216-0-330" class="i">+
</a><a href="#h216-0-331" id="h216-0-331" class="i">+            fetchConversationWithMessagesMethod.invoke(conversationManager, SnapUUID.fromString(conversationId).instanceNonNull(), callback)
</a><a href="#h216-0-332" id="h216-0-332" class="i">+            param.setResult(null)
</a><a href="#h216-0-333" id="h216-0-333" class="i">+        }
</a><a href="#h216-0-334" id="h216-0-334" class="i">+
</a><a href="#h216-0-335" id="h216-0-335" class="i">+        XposedHelpers.findMethodExact(
</a><a href="#h216-0-336" id="h216-0-336" class="i">+            NotificationManager::class.java,
</a><a href="#h216-0-337" id="h216-0-337" class="i">+            &quot;cancelAsUser&quot;, String::class.java,
</a><a href="#h216-0-338" id="h216-0-338" class="i">+            Int::class.javaPrimitiveType,
</a><a href="#h216-0-339" id="h216-0-339" class="i">+            UserHandle::class.java
</a><a href="#h216-0-340" id="h216-0-340" class="i">+        ).hook(HookStage.BEFORE) { param -&gt;
</a><a href="#h216-0-341" id="h216-0-341" class="i">+            val notificationId = param.arg&lt;Int&gt;(1)
</a><a href="#h216-0-342" id="h216-0-342" class="i">+            notificationIdMap[notificationId]?.let {
</a><a href="#h216-0-343" id="h216-0-343" class="i">+                cachedMessages[it]?.clear()
</a><a href="#h216-0-344" id="h216-0-344" class="i">+            }
</a><a href="#h216-0-345" id="h216-0-345" class="i">+        }
</a><a href="#h216-0-346" id="h216-0-346" class="i">+
</a><a href="#h216-0-347" id="h216-0-347" class="i">+        findClass(&quot;com.google.firebase.messaging.FirebaseMessagingService&quot;).run {
</a><a href="#h216-0-348" id="h216-0-348" class="i">+            val states by context.config.messaging.notificationBlacklist
</a><a href="#h216-0-349" id="h216-0-349" class="i">+            methods.first { it.declaringClass == this &amp;&amp; it.returnType == Void::class.javaPrimitiveType &amp;&amp; it.parameterCount == 1 &amp;&amp; it.parameterTypes[0] == Intent::class.java }
</a><a href="#h216-0-350" id="h216-0-350" class="i">+                .hook(HookStage.BEFORE) { param -&gt;
</a><a href="#h216-0-351" id="h216-0-351" class="i">+                    val intent = param.argNullable&lt;Intent&gt;(0) ?: return@hook
</a><a href="#h216-0-352" id="h216-0-352" class="i">+                    val messageType = intent.getStringExtra(&quot;type&quot;) ?: return@hook
</a><a href="#h216-0-353" id="h216-0-353" class="i">+
</a><a href="#h216-0-354" id="h216-0-354" class="i">+                    context.log.debug(&quot;received message type: $messageType&quot;)
</a><a href="#h216-0-355" id="h216-0-355" class="i">+
</a><a href="#h216-0-356" id="h216-0-356" class="i">+                    if (states.contains(messageType.replaceFirst(&quot;mischief_&quot;, &quot;&quot;))) {
</a><a href="#h216-0-357" id="h216-0-357" class="i">+                        param.setResult(null)
</a><a href="#h216-0-358" id="h216-0-358" class="i">+                    }
</a><a href="#h216-0-359" id="h216-0-359" class="i">+                }
</a><a href="#h216-0-360" id="h216-0-360" class="i">+        }
</a><a href="#h216-0-361" id="h216-0-361" class="i">+    }
</a><a href="#h216-0-362" id="h216-0-362" class="i">+
</a><a href="#h216-0-363" id="h216-0-363" class="i">+    data class NotificationData(
</a><a href="#h216-0-364" id="h216-0-364" class="i">+        val tag: String?,
</a><a href="#h216-0-365" id="h216-0-365" class="i">+        val id: Int,
</a><a href="#h216-0-366" id="h216-0-366" class="i">+        var notification: Notification,
</a><a href="#h216-0-367" id="h216-0-367" class="i">+        val userHandle: UserHandle
</a><a href="#h216-0-368" id="h216-0-368" class="i">+    )
</a><a href="#h216-0-369" id="h216-0-369" class="i">+}</a><a href="#h216-0-370" id="h216-0-370" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h217" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/PreventMessageSending.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/PreventMessageSending.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/PreventMessageSending.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/PreventMessageSending.kt</a></b>
<a href="#h217-0" id="h217-0" class="h">@@ -0,0 +1,48 @@
</a><a href="#h217-0-0" id="h217-0-0" class="i">+package me.rhunk.snapenhance.core.features.impl.messaging
</a><a href="#h217-0-1" id="h217-0-1" class="i">+
</a><a href="#h217-0-2" id="h217-0-2" class="i">+import me.rhunk.snapenhance.common.data.NotificationType
</a><a href="#h217-0-3" id="h217-0-3" class="i">+import me.rhunk.snapenhance.common.util.protobuf.ProtoEditor
</a><a href="#h217-0-4" id="h217-0-4" class="i">+import me.rhunk.snapenhance.core.event.events.impl.SendMessageWithContentEvent
</a><a href="#h217-0-5" id="h217-0-5" class="i">+import me.rhunk.snapenhance.core.event.events.impl.UnaryCallEvent
</a><a href="#h217-0-6" id="h217-0-6" class="i">+import me.rhunk.snapenhance.core.features.Feature
</a><a href="#h217-0-7" id="h217-0-7" class="i">+import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a><a href="#h217-0-8" id="h217-0-8" class="i">+import me.rhunk.snapenhance.core.util.hook.HookStage
</a><a href="#h217-0-9" id="h217-0-9" class="i">+import me.rhunk.snapenhance.core.util.hook.hook
</a><a href="#h217-0-10" id="h217-0-10" class="i">+
</a><a href="#h217-0-11" id="h217-0-11" class="i">+class PreventMessageSending : Feature(&quot;Prevent message sending&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_ASYNC) {
</a><a href="#h217-0-12" id="h217-0-12" class="i">+    override fun asyncOnActivityCreate() {
</a><a href="#h217-0-13" id="h217-0-13" class="i">+        val preventMessageSending by context.config.messaging.preventMessageSending
</a><a href="#h217-0-14" id="h217-0-14" class="i">+
</a><a href="#h217-0-15" id="h217-0-15" class="i">+        context.event.subscribe(UnaryCallEvent::class, { preventMessageSending.contains(&quot;snap_replay&quot;) }) { event -&gt;
</a><a href="#h217-0-16" id="h217-0-16" class="i">+            if (event.uri != &quot;/messagingcoreservice.MessagingCoreService/UpdateContentMessage&quot;) return@subscribe
</a><a href="#h217-0-17" id="h217-0-17" class="i">+            event.buffer = ProtoEditor(event.buffer).apply {
</a><a href="#h217-0-18" id="h217-0-18" class="i">+                edit(3) {
</a><a href="#h217-0-19" id="h217-0-19" class="i">+                    // replace replayed to read receipt
</a><a href="#h217-0-20" id="h217-0-20" class="i">+                    remove(13)
</a><a href="#h217-0-21" id="h217-0-21" class="i">+                    addBuffer(4, byteArrayOf())
</a><a href="#h217-0-22" id="h217-0-22" class="i">+                }
</a><a href="#h217-0-23" id="h217-0-23" class="i">+            }.toByteArray()
</a><a href="#h217-0-24" id="h217-0-24" class="i">+        }
</a><a href="#h217-0-25" id="h217-0-25" class="i">+
</a><a href="#h217-0-26" id="h217-0-26" class="i">+        context.classCache.conversationManager.hook(&quot;updateMessage&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h217-0-27" id="h217-0-27" class="i">+            val messageUpdate = param.arg&lt;Any&gt;(2).toString()
</a><a href="#h217-0-28" id="h217-0-28" class="i">+            if (messageUpdate == &quot;SCREENSHOT&quot; &amp;&amp; preventMessageSending.contains(&quot;chat_screenshot&quot;)) {
</a><a href="#h217-0-29" id="h217-0-29" class="i">+                param.setResult(null)
</a><a href="#h217-0-30" id="h217-0-30" class="i">+            }
</a><a href="#h217-0-31" id="h217-0-31" class="i">+
</a><a href="#h217-0-32" id="h217-0-32" class="i">+            if (messageUpdate == &quot;SCREEN_RECORD&quot; &amp;&amp; preventMessageSending.contains(&quot;chat_screen_record&quot;)) {
</a><a href="#h217-0-33" id="h217-0-33" class="i">+                param.setResult(null)
</a><a href="#h217-0-34" id="h217-0-34" class="i">+            }
</a><a href="#h217-0-35" id="h217-0-35" class="i">+        }
</a><a href="#h217-0-36" id="h217-0-36" class="i">+
</a><a href="#h217-0-37" id="h217-0-37" class="i">+        context.event.subscribe(SendMessageWithContentEvent::class) { event -&gt;
</a><a href="#h217-0-38" id="h217-0-38" class="i">+            val contentType = event.messageContent.contentType
</a><a href="#h217-0-39" id="h217-0-39" class="i">+            val associatedType = NotificationType.fromContentType(contentType ?: return@subscribe) ?: return@subscribe
</a><a href="#h217-0-40" id="h217-0-40" class="i">+
</a><a href="#h217-0-41" id="h217-0-41" class="i">+            if (preventMessageSending.contains(associatedType.key)) {
</a><a href="#h217-0-42" id="h217-0-42" class="i">+                context.log.verbose(&quot;Preventing message sending for $associatedType&quot;)
</a><a href="#h217-0-43" id="h217-0-43" class="i">+                event.canceled = true
</a><a href="#h217-0-44" id="h217-0-44" class="i">+            }
</a><a href="#h217-0-45" id="h217-0-45" class="i">+        }
</a><a href="#h217-0-46" id="h217-0-46" class="i">+    }
</a><a href="#h217-0-47" id="h217-0-47" class="i">+}</a><a href="#h217-0-48" id="h217-0-48" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h218" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/PreventReadReceipts.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/PreventReadReceipts.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/PreventReadReceipts.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/PreventReadReceipts.kt</a></b>
<a href="#h218-0" id="h218-0" class="h">@@ -0,0 +1,31 @@
</a><a href="#h218-0-0" id="h218-0-0" class="i">+package me.rhunk.snapenhance.core.features.impl.messaging
</a><a href="#h218-0-1" id="h218-0-1" class="i">+
</a><a href="#h218-0-2" id="h218-0-2" class="i">+import me.rhunk.snapenhance.core.event.events.impl.OnSnapInteractionEvent
</a><a href="#h218-0-3" id="h218-0-3" class="i">+import me.rhunk.snapenhance.core.features.Feature
</a><a href="#h218-0-4" id="h218-0-4" class="i">+import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a><a href="#h218-0-5" id="h218-0-5" class="i">+import me.rhunk.snapenhance.core.features.impl.spying.StealthMode
</a><a href="#h218-0-6" id="h218-0-6" class="i">+import me.rhunk.snapenhance.core.util.hook.HookStage
</a><a href="#h218-0-7" id="h218-0-7" class="i">+import me.rhunk.snapenhance.core.util.hook.Hooker
</a><a href="#h218-0-8" id="h218-0-8" class="i">+import me.rhunk.snapenhance.core.wrapper.impl.SnapUUID
</a><a href="#h218-0-9" id="h218-0-9" class="i">+
</a><a href="#h218-0-10" id="h218-0-10" class="i">+class PreventReadReceipts : Feature(&quot;PreventReadReceipts&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_SYNC) {
</a><a href="#h218-0-11" id="h218-0-11" class="i">+    override fun onActivityCreate() {
</a><a href="#h218-0-12" id="h218-0-12" class="i">+        val isConversationInStealthMode: (SnapUUID) -&gt; Boolean = hook@{
</a><a href="#h218-0-13" id="h218-0-13" class="i">+            context.feature(StealthMode::class).canUseRule(it.toString())
</a><a href="#h218-0-14" id="h218-0-14" class="i">+        }
</a><a href="#h218-0-15" id="h218-0-15" class="i">+
</a><a href="#h218-0-16" id="h218-0-16" class="i">+        arrayOf(&quot;mediaMessagesDisplayed&quot;, &quot;displayedMessages&quot;).forEach { methodName: String -&gt;
</a><a href="#h218-0-17" id="h218-0-17" class="i">+            Hooker.hook(context.classCache.conversationManager, methodName, HookStage.BEFORE, { isConversationInStealthMode(
</a><a href="#h218-0-18" id="h218-0-18" class="i">+                SnapUUID(it.arg(0))
</a><a href="#h218-0-19" id="h218-0-19" class="i">+            ) }) {
</a><a href="#h218-0-20" id="h218-0-20" class="i">+                it.setResult(null)
</a><a href="#h218-0-21" id="h218-0-21" class="i">+            }
</a><a href="#h218-0-22" id="h218-0-22" class="i">+        }
</a><a href="#h218-0-23" id="h218-0-23" class="i">+
</a><a href="#h218-0-24" id="h218-0-24" class="i">+        context.event.subscribe(OnSnapInteractionEvent::class) { event -&gt;
</a><a href="#h218-0-25" id="h218-0-25" class="i">+            if (isConversationInStealthMode(event.conversationId)) {
</a><a href="#h218-0-26" id="h218-0-26" class="i">+                event.canceled = true
</a><a href="#h218-0-27" id="h218-0-27" class="i">+            }
</a><a href="#h218-0-28" id="h218-0-28" class="i">+        }
</a><a href="#h218-0-29" id="h218-0-29" class="i">+    }
</a><a href="#h218-0-30" id="h218-0-30" class="i">+}</a><a href="#h218-0-31" id="h218-0-31" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h219" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/SendOverride.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/SendOverride.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/SendOverride.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/SendOverride.kt</a></b>
<a href="#h219-0" id="h219-0" class="h">@@ -0,0 +1,116 @@
</a><a href="#h219-0-0" id="h219-0-0" class="i">+package me.rhunk.snapenhance.core.features.impl.messaging
</a><a href="#h219-0-1" id="h219-0-1" class="i">+
</a><a href="#h219-0-2" id="h219-0-2" class="i">+import me.rhunk.snapenhance.common.Constants
</a><a href="#h219-0-3" id="h219-0-3" class="i">+import me.rhunk.snapenhance.common.data.ContentType
</a><a href="#h219-0-4" id="h219-0-4" class="i">+import me.rhunk.snapenhance.common.util.protobuf.ProtoEditor
</a><a href="#h219-0-5" id="h219-0-5" class="i">+import me.rhunk.snapenhance.common.util.protobuf.ProtoReader
</a><a href="#h219-0-6" id="h219-0-6" class="i">+import me.rhunk.snapenhance.core.event.events.impl.SendMessageWithContentEvent
</a><a href="#h219-0-7" id="h219-0-7" class="i">+import me.rhunk.snapenhance.core.event.events.impl.UnaryCallEvent
</a><a href="#h219-0-8" id="h219-0-8" class="i">+import me.rhunk.snapenhance.core.features.Feature
</a><a href="#h219-0-9" id="h219-0-9" class="i">+import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a><a href="#h219-0-10" id="h219-0-10" class="i">+import me.rhunk.snapenhance.core.messaging.MessageSender
</a><a href="#h219-0-11" id="h219-0-11" class="i">+import me.rhunk.snapenhance.core.ui.ViewAppearanceHelper
</a><a href="#h219-0-12" id="h219-0-12" class="i">+
</a><a href="#h219-0-13" id="h219-0-13" class="i">+class SendOverride : Feature(&quot;Send Override&quot;, loadParams = FeatureLoadParams.INIT_SYNC) {
</a><a href="#h219-0-14" id="h219-0-14" class="i">+    private var isLastSnapSavable = false
</a><a href="#h219-0-15" id="h219-0-15" class="i">+
</a><a href="#h219-0-16" id="h219-0-16" class="i">+    override fun init() {
</a><a href="#h219-0-17" id="h219-0-17" class="i">+        val fixGalleryMediaSendOverride = context.config.experimental.nativeHooks.let {
</a><a href="#h219-0-18" id="h219-0-18" class="i">+            it.globalState == true &amp;&amp; it.fixGalleryMediaOverride.get()
</a><a href="#h219-0-19" id="h219-0-19" class="i">+        }
</a><a href="#h219-0-20" id="h219-0-20" class="i">+        val typeNames = mutableListOf(
</a><a href="#h219-0-21" id="h219-0-21" class="i">+            &quot;ORIGINAL&quot;,
</a><a href="#h219-0-22" id="h219-0-22" class="i">+            &quot;SNAP&quot;,
</a><a href="#h219-0-23" id="h219-0-23" class="i">+            &quot;NOTE&quot;
</a><a href="#h219-0-24" id="h219-0-24" class="i">+        ).also {
</a><a href="#h219-0-25" id="h219-0-25" class="i">+            if (fixGalleryMediaSendOverride) {
</a><a href="#h219-0-26" id="h219-0-26" class="i">+                it.add(&quot;SAVABLE_SNAP&quot;)
</a><a href="#h219-0-27" id="h219-0-27" class="i">+            }
</a><a href="#h219-0-28" id="h219-0-28" class="i">+        }.associateWith {
</a><a href="#h219-0-29" id="h219-0-29" class="i">+           it
</a><a href="#h219-0-30" id="h219-0-30" class="i">+        }
</a><a href="#h219-0-31" id="h219-0-31" class="i">+
</a><a href="#h219-0-32" id="h219-0-32" class="i">+        context.event.subscribe(UnaryCallEvent::class, { fixGalleryMediaSendOverride }) { event -&gt;
</a><a href="#h219-0-33" id="h219-0-33" class="i">+            if (event.uri != &quot;/messagingcoreservice.MessagingCoreService/CreateContentMessage&quot;) return@subscribe
</a><a href="#h219-0-34" id="h219-0-34" class="i">+            if (!isLastSnapSavable) return@subscribe
</a><a href="#h219-0-35" id="h219-0-35" class="i">+            ProtoReader(event.buffer).also {
</a><a href="#h219-0-36" id="h219-0-36" class="i">+                // only affect snaps
</a><a href="#h219-0-37" id="h219-0-37" class="i">+                if (!it.containsPath(*Constants.ARROYO_MEDIA_CONTAINER_PROTO_PATH, 11)) return@subscribe
</a><a href="#h219-0-38" id="h219-0-38" class="i">+            }
</a><a href="#h219-0-39" id="h219-0-39" class="i">+
</a><a href="#h219-0-40" id="h219-0-40" class="i">+            event.buffer = ProtoEditor(event.buffer).apply {
</a><a href="#h219-0-41" id="h219-0-41" class="i">+                //remove the max view time
</a><a href="#h219-0-42" id="h219-0-42" class="i">+                edit(*Constants.ARROYO_MEDIA_CONTAINER_PROTO_PATH, 11, 5, 2) {
</a><a href="#h219-0-43" id="h219-0-43" class="i">+                    remove(8)
</a><a href="#h219-0-44" id="h219-0-44" class="i">+                    addBuffer(6, byteArrayOf())
</a><a href="#h219-0-45" id="h219-0-45" class="i">+                }
</a><a href="#h219-0-46" id="h219-0-46" class="i">+                //make snaps savable in chat
</a><a href="#h219-0-47" id="h219-0-47" class="i">+                edit(4) {
</a><a href="#h219-0-48" id="h219-0-48" class="i">+                    val savableState = firstOrNull(7)?.value ?: return@edit
</a><a href="#h219-0-49" id="h219-0-49" class="i">+                    if (savableState == 2L) {
</a><a href="#h219-0-50" id="h219-0-50" class="i">+                        remove(7)
</a><a href="#h219-0-51" id="h219-0-51" class="i">+                        addVarInt(7, 3)
</a><a href="#h219-0-52" id="h219-0-52" class="i">+                    }
</a><a href="#h219-0-53" id="h219-0-53" class="i">+                }
</a><a href="#h219-0-54" id="h219-0-54" class="i">+            }.toByteArray()
</a><a href="#h219-0-55" id="h219-0-55" class="i">+        }
</a><a href="#h219-0-56" id="h219-0-56" class="i">+
</a><a href="#h219-0-57" id="h219-0-57" class="i">+        context.event.subscribe(SendMessageWithContentEvent::class, {
</a><a href="#h219-0-58" id="h219-0-58" class="i">+            context.config.messaging.galleryMediaSendOverride.get()
</a><a href="#h219-0-59" id="h219-0-59" class="i">+        }) { event -&gt;
</a><a href="#h219-0-60" id="h219-0-60" class="i">+            isLastSnapSavable = false
</a><a href="#h219-0-61" id="h219-0-61" class="i">+            val localMessageContent = event.messageContent
</a><a href="#h219-0-62" id="h219-0-62" class="i">+            if (localMessageContent.contentType != ContentType.EXTERNAL_MEDIA) return@subscribe
</a><a href="#h219-0-63" id="h219-0-63" class="i">+
</a><a href="#h219-0-64" id="h219-0-64" class="i">+            //prevent story replies
</a><a href="#h219-0-65" id="h219-0-65" class="i">+            val messageProtoReader = ProtoReader(localMessageContent.content)
</a><a href="#h219-0-66" id="h219-0-66" class="i">+            if (messageProtoReader.contains(7)) return@subscribe
</a><a href="#h219-0-67" id="h219-0-67" class="i">+
</a><a href="#h219-0-68" id="h219-0-68" class="i">+            event.canceled = true
</a><a href="#h219-0-69" id="h219-0-69" class="i">+
</a><a href="#h219-0-70" id="h219-0-70" class="i">+            context.runOnUiThread {
</a><a href="#h219-0-71" id="h219-0-71" class="i">+                ViewAppearanceHelper.newAlertDialogBuilder(context.mainActivity!!)
</a><a href="#h219-0-72" id="h219-0-72" class="i">+                    .setItems(typeNames.values.map {
</a><a href="#h219-0-73" id="h219-0-73" class="i">+                        context.translation[&quot;features.options.gallery_media_send_override.$it&quot;]
</a><a href="#h219-0-74" id="h219-0-74" class="i">+                    }.toTypedArray()) { dialog, which -&gt;
</a><a href="#h219-0-75" id="h219-0-75" class="i">+                        dialog.dismiss()
</a><a href="#h219-0-76" id="h219-0-76" class="i">+                        val overrideType = typeNames.keys.toTypedArray()[which]
</a><a href="#h219-0-77" id="h219-0-77" class="i">+
</a><a href="#h219-0-78" id="h219-0-78" class="i">+                        if (overrideType != &quot;ORIGINAL&quot; &amp;&amp; messageProtoReader.followPath(3)?.getCount(3) != 1) {
</a><a href="#h219-0-79" id="h219-0-79" class="i">+                            context.runOnUiThread {
</a><a href="#h219-0-80" id="h219-0-80" class="i">+                                ViewAppearanceHelper.newAlertDialogBuilder(context.mainActivity!!)
</a><a href="#h219-0-81" id="h219-0-81" class="i">+                                    .setMessage(context.translation[&quot;gallery_media_send_override.multiple_media_toast&quot;])
</a><a href="#h219-0-82" id="h219-0-82" class="i">+                                    .setPositiveButton(context.translation[&quot;button.ok&quot;], null)
</a><a href="#h219-0-83" id="h219-0-83" class="i">+                                    .show()
</a><a href="#h219-0-84" id="h219-0-84" class="i">+                            }
</a><a href="#h219-0-85" id="h219-0-85" class="i">+                            return@setItems
</a><a href="#h219-0-86" id="h219-0-86" class="i">+                        }
</a><a href="#h219-0-87" id="h219-0-87" class="i">+
</a><a href="#h219-0-88" id="h219-0-88" class="i">+                        when (overrideType) {
</a><a href="#h219-0-89" id="h219-0-89" class="i">+                            &quot;SNAP&quot;, &quot;SAVABLE_SNAP&quot; -&gt; {
</a><a href="#h219-0-90" id="h219-0-90" class="i">+                                val extras = messageProtoReader.followPath(3, 3, 13)?.getBuffer()
</a><a href="#h219-0-91" id="h219-0-91" class="i">+
</a><a href="#h219-0-92" id="h219-0-92" class="i">+                                localMessageContent.contentType = ContentType.SNAP
</a><a href="#h219-0-93" id="h219-0-93" class="i">+                                localMessageContent.content = MessageSender.redSnapProto(extras)
</a><a href="#h219-0-94" id="h219-0-94" class="i">+                                if (overrideType == &quot;SAVABLE_SNAP&quot;) {
</a><a href="#h219-0-95" id="h219-0-95" class="i">+                                    isLastSnapSavable = true
</a><a href="#h219-0-96" id="h219-0-96" class="i">+                                }
</a><a href="#h219-0-97" id="h219-0-97" class="i">+                            }
</a><a href="#h219-0-98" id="h219-0-98" class="i">+
</a><a href="#h219-0-99" id="h219-0-99" class="i">+                            &quot;NOTE&quot; -&gt; {
</a><a href="#h219-0-100" id="h219-0-100" class="i">+                                localMessageContent.contentType = ContentType.NOTE
</a><a href="#h219-0-101" id="h219-0-101" class="i">+                                val mediaDuration =
</a><a href="#h219-0-102" id="h219-0-102" class="i">+                                    messageProtoReader.getVarInt(3, 3, 5, 1, 1, 15) ?: 0
</a><a href="#h219-0-103" id="h219-0-103" class="i">+                                localMessageContent.content =
</a><a href="#h219-0-104" id="h219-0-104" class="i">+                                    MessageSender.audioNoteProto(mediaDuration)
</a><a href="#h219-0-105" id="h219-0-105" class="i">+                            }
</a><a href="#h219-0-106" id="h219-0-106" class="i">+                        }
</a><a href="#h219-0-107" id="h219-0-107" class="i">+
</a><a href="#h219-0-108" id="h219-0-108" class="i">+                        event.invokeOriginal()
</a><a href="#h219-0-109" id="h219-0-109" class="i">+                    }
</a><a href="#h219-0-110" id="h219-0-110" class="i">+                    .setNegativeButton(context.translation[&quot;button.cancel&quot;], null)
</a><a href="#h219-0-111" id="h219-0-111" class="i">+                    .show()
</a><a href="#h219-0-112" id="h219-0-112" class="i">+            }
</a><a href="#h219-0-113" id="h219-0-113" class="i">+        }
</a><a href="#h219-0-114" id="h219-0-114" class="i">+    }
</a><a href="#h219-0-115" id="h219-0-115" class="i">+}</a><a href="#h219-0-116" id="h219-0-116" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h220" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/UnlimitedSnapViewTime.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/UnlimitedSnapViewTime.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/UnlimitedSnapViewTime.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/UnlimitedSnapViewTime.kt</a></b>
<a href="#h220-0" id="h220-0" class="h">@@ -0,0 +1,32 @@
</a><a href="#h220-0-0" id="h220-0-0" class="i">+package me.rhunk.snapenhance.core.features.impl.messaging
</a><a href="#h220-0-1" id="h220-0-1" class="i">+
</a><a href="#h220-0-2" id="h220-0-2" class="i">+import me.rhunk.snapenhance.common.data.ContentType
</a><a href="#h220-0-3" id="h220-0-3" class="i">+import me.rhunk.snapenhance.common.data.MessageState
</a><a href="#h220-0-4" id="h220-0-4" class="i">+import me.rhunk.snapenhance.common.util.protobuf.ProtoEditor
</a><a href="#h220-0-5" id="h220-0-5" class="i">+import me.rhunk.snapenhance.common.util.protobuf.ProtoReader
</a><a href="#h220-0-6" id="h220-0-6" class="i">+import me.rhunk.snapenhance.core.event.events.impl.BuildMessageEvent
</a><a href="#h220-0-7" id="h220-0-7" class="i">+import me.rhunk.snapenhance.core.features.Feature
</a><a href="#h220-0-8" id="h220-0-8" class="i">+import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a><a href="#h220-0-9" id="h220-0-9" class="i">+
</a><a href="#h220-0-10" id="h220-0-10" class="i">+class UnlimitedSnapViewTime :
</a><a href="#h220-0-11" id="h220-0-11" class="i">+    Feature(&quot;UnlimitedSnapViewTime&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_SYNC) {
</a><a href="#h220-0-12" id="h220-0-12" class="i">+    override fun onActivityCreate() {
</a><a href="#h220-0-13" id="h220-0-13" class="i">+        val state by context.config.messaging.unlimitedSnapViewTime
</a><a href="#h220-0-14" id="h220-0-14" class="i">+
</a><a href="#h220-0-15" id="h220-0-15" class="i">+        context.event.subscribe(BuildMessageEvent::class, { state }, priority = 101) { event -&gt;
</a><a href="#h220-0-16" id="h220-0-16" class="i">+            if (event.message.messageState != MessageState.COMMITTED) return@subscribe
</a><a href="#h220-0-17" id="h220-0-17" class="i">+            if (event.message.messageContent.contentType != ContentType.SNAP) return@subscribe
</a><a href="#h220-0-18" id="h220-0-18" class="i">+
</a><a href="#h220-0-19" id="h220-0-19" class="i">+            val messageContent = event.message.messageContent
</a><a href="#h220-0-20" id="h220-0-20" class="i">+
</a><a href="#h220-0-21" id="h220-0-21" class="i">+            val mediaAttributes = ProtoReader(messageContent.content).followPath(11, 5, 2) ?: return@subscribe
</a><a href="#h220-0-22" id="h220-0-22" class="i">+            if (mediaAttributes.contains(6)) return@subscribe
</a><a href="#h220-0-23" id="h220-0-23" class="i">+            messageContent.content = ProtoEditor(messageContent.content).apply {
</a><a href="#h220-0-24" id="h220-0-24" class="i">+                edit(11, 5, 2) {
</a><a href="#h220-0-25" id="h220-0-25" class="i">+                    remove(8)
</a><a href="#h220-0-26" id="h220-0-26" class="i">+                    addBuffer(6, byteArrayOf())
</a><a href="#h220-0-27" id="h220-0-27" class="i">+                }
</a><a href="#h220-0-28" id="h220-0-28" class="i">+            }.toByteArray()
</a><a href="#h220-0-29" id="h220-0-29" class="i">+        }
</a><a href="#h220-0-30" id="h220-0-30" class="i">+    }
</a><a href="#h220-0-31" id="h220-0-31" class="i">+}
</a><b>diff --git a/<a id="h221" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/spying/MessageLogger.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/spying/MessageLogger.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/spying/MessageLogger.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/spying/MessageLogger.kt</a></b>
<a href="#h221-0" id="h221-0" class="h">@@ -0,0 +1,179 @@
</a><a href="#h221-0-0" id="h221-0-0" class="i">+package me.rhunk.snapenhance.core.features.impl.spying
</a><a href="#h221-0-1" id="h221-0-1" class="i">+
</a><a href="#h221-0-2" id="h221-0-2" class="i">+import android.graphics.Canvas
</a><a href="#h221-0-3" id="h221-0-3" class="i">+import android.graphics.Paint
</a><a href="#h221-0-4" id="h221-0-4" class="i">+import android.graphics.drawable.ShapeDrawable
</a><a href="#h221-0-5" id="h221-0-5" class="i">+import android.graphics.drawable.shapes.Shape
</a><a href="#h221-0-6" id="h221-0-6" class="i">+import android.os.DeadObjectException
</a><a href="#h221-0-7" id="h221-0-7" class="i">+import com.google.gson.JsonObject
</a><a href="#h221-0-8" id="h221-0-8" class="i">+import com.google.gson.JsonParser
</a><a href="#h221-0-9" id="h221-0-9" class="i">+import me.rhunk.snapenhance.common.data.ContentType
</a><a href="#h221-0-10" id="h221-0-10" class="i">+import me.rhunk.snapenhance.common.data.MessageState
</a><a href="#h221-0-11" id="h221-0-11" class="i">+import me.rhunk.snapenhance.common.util.protobuf.ProtoReader
</a><a href="#h221-0-12" id="h221-0-12" class="i">+import me.rhunk.snapenhance.core.event.events.impl.BindViewEvent
</a><a href="#h221-0-13" id="h221-0-13" class="i">+import me.rhunk.snapenhance.core.event.events.impl.BuildMessageEvent
</a><a href="#h221-0-14" id="h221-0-14" class="i">+import me.rhunk.snapenhance.core.features.Feature
</a><a href="#h221-0-15" id="h221-0-15" class="i">+import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a><a href="#h221-0-16" id="h221-0-16" class="i">+import me.rhunk.snapenhance.core.ui.addForegroundDrawable
</a><a href="#h221-0-17" id="h221-0-17" class="i">+import me.rhunk.snapenhance.core.ui.removeForegroundDrawable
</a><a href="#h221-0-18" id="h221-0-18" class="i">+import me.rhunk.snapenhance.core.util.EvictingMap
</a><a href="#h221-0-19" id="h221-0-19" class="i">+import java.util.concurrent.Executors
</a><a href="#h221-0-20" id="h221-0-20" class="i">+import kotlin.system.measureTimeMillis
</a><a href="#h221-0-21" id="h221-0-21" class="i">+
</a><a href="#h221-0-22" id="h221-0-22" class="i">+private fun Any.longHashCode(): Long {
</a><a href="#h221-0-23" id="h221-0-23" class="i">+    var h = 1125899906842597L
</a><a href="#h221-0-24" id="h221-0-24" class="i">+    val value = this.toString()
</a><a href="#h221-0-25" id="h221-0-25" class="i">+    for (element in value) h = 31 * h + element.code.toLong()
</a><a href="#h221-0-26" id="h221-0-26" class="i">+    return h
</a><a href="#h221-0-27" id="h221-0-27" class="i">+}
</a><a href="#h221-0-28" id="h221-0-28" class="i">+
</a><a href="#h221-0-29" id="h221-0-29" class="i">+class MessageLogger : Feature(&quot;MessageLogger&quot;,
</a><a href="#h221-0-30" id="h221-0-30" class="i">+    loadParams = FeatureLoadParams.INIT_SYNC or
</a><a href="#h221-0-31" id="h221-0-31" class="i">+        FeatureLoadParams.ACTIVITY_CREATE_SYNC or
</a><a href="#h221-0-32" id="h221-0-32" class="i">+        FeatureLoadParams.ACTIVITY_CREATE_ASYNC
</a><a href="#h221-0-33" id="h221-0-33" class="i">+) {
</a><a href="#h221-0-34" id="h221-0-34" class="i">+    companion object {
</a><a href="#h221-0-35" id="h221-0-35" class="i">+        const val PREFETCH_MESSAGE_COUNT = 20
</a><a href="#h221-0-36" id="h221-0-36" class="i">+        const val PREFETCH_FEED_COUNT = 20
</a><a href="#h221-0-37" id="h221-0-37" class="i">+        const val DELETED_MESSAGE_COLOR = 0x2Eb71c1c
</a><a href="#h221-0-38" id="h221-0-38" class="i">+    }
</a><a href="#h221-0-39" id="h221-0-39" class="i">+
</a><a href="#h221-0-40" id="h221-0-40" class="i">+    private val messageLoggerInterface by lazy { context.bridgeClient.getMessageLogger() }
</a><a href="#h221-0-41" id="h221-0-41" class="i">+
</a><a href="#h221-0-42" id="h221-0-42" class="i">+    val isEnabled get() = context.config.messaging.messageLogger.get()
</a><a href="#h221-0-43" id="h221-0-43" class="i">+
</a><a href="#h221-0-44" id="h221-0-44" class="i">+    private val threadPool = Executors.newFixedThreadPool(10)
</a><a href="#h221-0-45" id="h221-0-45" class="i">+
</a><a href="#h221-0-46" id="h221-0-46" class="i">+    private val cachedIdLinks = mutableMapOf&lt;Long, Long&gt;() // client id -&gt; server id
</a><a href="#h221-0-47" id="h221-0-47" class="i">+    private val fetchedMessages = mutableListOf&lt;Long&gt;() // list of unique message ids
</a><a href="#h221-0-48" id="h221-0-48" class="i">+    private val deletedMessageCache = EvictingMap&lt;Long, JsonObject&gt;(200) // unique message id -&gt; message json object
</a><a href="#h221-0-49" id="h221-0-49" class="i">+
</a><a href="#h221-0-50" id="h221-0-50" class="i">+    fun isMessageDeleted(conversationId: String, clientMessageId: Long)
</a><a href="#h221-0-51" id="h221-0-51" class="i">+        = makeUniqueIdentifier(conversationId, clientMessageId)?.let { deletedMessageCache.containsKey(it) } ?: false
</a><a href="#h221-0-52" id="h221-0-52" class="i">+
</a><a href="#h221-0-53" id="h221-0-53" class="i">+    fun deleteMessage(conversationId: String, clientMessageId: Long) {
</a><a href="#h221-0-54" id="h221-0-54" class="i">+        val uniqueMessageId = makeUniqueIdentifier(conversationId, clientMessageId) ?: return
</a><a href="#h221-0-55" id="h221-0-55" class="i">+        fetchedMessages.remove(uniqueMessageId)
</a><a href="#h221-0-56" id="h221-0-56" class="i">+        deletedMessageCache.remove(uniqueMessageId)
</a><a href="#h221-0-57" id="h221-0-57" class="i">+        messageLoggerInterface.deleteMessage(conversationId, uniqueMessageId)
</a><a href="#h221-0-58" id="h221-0-58" class="i">+    }
</a><a href="#h221-0-59" id="h221-0-59" class="i">+
</a><a href="#h221-0-60" id="h221-0-60" class="i">+    fun getMessageObject(conversationId: String, clientMessageId: Long): JsonObject? {
</a><a href="#h221-0-61" id="h221-0-61" class="i">+        val uniqueMessageId = makeUniqueIdentifier(conversationId, clientMessageId) ?: return null
</a><a href="#h221-0-62" id="h221-0-62" class="i">+        if (deletedMessageCache.containsKey(uniqueMessageId)) {
</a><a href="#h221-0-63" id="h221-0-63" class="i">+            return deletedMessageCache[uniqueMessageId]
</a><a href="#h221-0-64" id="h221-0-64" class="i">+        }
</a><a href="#h221-0-65" id="h221-0-65" class="i">+        return messageLoggerInterface.getMessage(conversationId, uniqueMessageId)?.let {
</a><a href="#h221-0-66" id="h221-0-66" class="i">+            JsonParser.parseString(it.toString(Charsets.UTF_8)).asJsonObject
</a><a href="#h221-0-67" id="h221-0-67" class="i">+        }
</a><a href="#h221-0-68" id="h221-0-68" class="i">+    }
</a><a href="#h221-0-69" id="h221-0-69" class="i">+
</a><a href="#h221-0-70" id="h221-0-70" class="i">+    fun getMessageProto(conversationId: String, clientMessageId: Long): ProtoReader? {
</a><a href="#h221-0-71" id="h221-0-71" class="i">+        return getMessageObject(conversationId, clientMessageId)?.let { message -&gt;
</a><a href="#h221-0-72" id="h221-0-72" class="i">+            ProtoReader(message.getAsJsonObject(&quot;mMessageContent&quot;).getAsJsonArray(&quot;mContent&quot;)
</a><a href="#h221-0-73" id="h221-0-73" class="i">+                .map { it.asByte }
</a><a href="#h221-0-74" id="h221-0-74" class="i">+                .toByteArray())
</a><a href="#h221-0-75" id="h221-0-75" class="i">+        }
</a><a href="#h221-0-76" id="h221-0-76" class="i">+    }
</a><a href="#h221-0-77" id="h221-0-77" class="i">+
</a><a href="#h221-0-78" id="h221-0-78" class="i">+    private fun computeMessageIdentifier(conversationId: String, orderKey: Long) = (orderKey.toString() + conversationId).longHashCode()
</a><a href="#h221-0-79" id="h221-0-79" class="i">+
</a><a href="#h221-0-80" id="h221-0-80" class="i">+    private fun makeUniqueIdentifier(conversationId: String, clientMessageId: Long): Long? {
</a><a href="#h221-0-81" id="h221-0-81" class="i">+        val serverMessageId = cachedIdLinks[clientMessageId] ?:
</a><a href="#h221-0-82" id="h221-0-82" class="i">+            context.database.getConversationMessageFromId(clientMessageId)?.serverMessageId?.toLong()?.also {
</a><a href="#h221-0-83" id="h221-0-83" class="i">+                cachedIdLinks[clientMessageId] = it
</a><a href="#h221-0-84" id="h221-0-84" class="i">+            }
</a><a href="#h221-0-85" id="h221-0-85" class="i">+            ?: return run {
</a><a href="#h221-0-86" id="h221-0-86" class="i">+                context.log.error(&quot;Failed to get server message id for $conversationId $clientMessageId&quot;)
</a><a href="#h221-0-87" id="h221-0-87" class="i">+                null
</a><a href="#h221-0-88" id="h221-0-88" class="i">+            }
</a><a href="#h221-0-89" id="h221-0-89" class="i">+        return computeMessageIdentifier(conversationId, serverMessageId)
</a><a href="#h221-0-90" id="h221-0-90" class="i">+    }
</a><a href="#h221-0-91" id="h221-0-91" class="i">+
</a><a href="#h221-0-92" id="h221-0-92" class="i">+    override fun asyncOnActivityCreate() {
</a><a href="#h221-0-93" id="h221-0-93" class="i">+        if (!isEnabled || !context.database.hasArroyo()) {
</a><a href="#h221-0-94" id="h221-0-94" class="i">+            return
</a><a href="#h221-0-95" id="h221-0-95" class="i">+        }
</a><a href="#h221-0-96" id="h221-0-96" class="i">+
</a><a href="#h221-0-97" id="h221-0-97" class="i">+        measureTimeMillis {
</a><a href="#h221-0-98" id="h221-0-98" class="i">+            val conversationIds = context.database.getFeedEntries(PREFETCH_FEED_COUNT).map { it.key!! }
</a><a href="#h221-0-99" id="h221-0-99" class="i">+            if (conversationIds.isEmpty()) return@measureTimeMillis
</a><a href="#h221-0-100" id="h221-0-100" class="i">+            fetchedMessages.addAll(messageLoggerInterface.getLoggedIds(conversationIds.toTypedArray(), PREFETCH_MESSAGE_COUNT).toList())
</a><a href="#h221-0-101" id="h221-0-101" class="i">+        }.also { context.log.verbose(&quot;Loaded ${fetchedMessages.size} cached messages in ${it}ms&quot;) }
</a><a href="#h221-0-102" id="h221-0-102" class="i">+    }
</a><a href="#h221-0-103" id="h221-0-103" class="i">+
</a><a href="#h221-0-104" id="h221-0-104" class="i">+    override fun init() {
</a><a href="#h221-0-105" id="h221-0-105" class="i">+        context.event.subscribe(BuildMessageEvent::class, { isEnabled }, priority = 1) { event -&gt;
</a><a href="#h221-0-106" id="h221-0-106" class="i">+            val messageInstance = event.message.instanceNonNull()
</a><a href="#h221-0-107" id="h221-0-107" class="i">+            if (event.message.messageState != MessageState.COMMITTED) return@subscribe
</a><a href="#h221-0-108" id="h221-0-108" class="i">+
</a><a href="#h221-0-109" id="h221-0-109" class="i">+            cachedIdLinks[event.message.messageDescriptor.messageId] = event.message.orderKey
</a><a href="#h221-0-110" id="h221-0-110" class="i">+            val conversationId = event.message.messageDescriptor.conversationId.toString()
</a><a href="#h221-0-111" id="h221-0-111" class="i">+            //exclude messages sent by me
</a><a href="#h221-0-112" id="h221-0-112" class="i">+            if (event.message.senderId.toString() == context.database.myUserId) return@subscribe
</a><a href="#h221-0-113" id="h221-0-113" class="i">+
</a><a href="#h221-0-114" id="h221-0-114" class="i">+            val uniqueMessageIdentifier = computeMessageIdentifier(conversationId, event.message.orderKey)
</a><a href="#h221-0-115" id="h221-0-115" class="i">+
</a><a href="#h221-0-116" id="h221-0-116" class="i">+            if (event.message.messageContent.contentType != ContentType.STATUS) {
</a><a href="#h221-0-117" id="h221-0-117" class="i">+                if (fetchedMessages.contains(uniqueMessageIdentifier)) return@subscribe
</a><a href="#h221-0-118" id="h221-0-118" class="i">+                fetchedMessages.add(uniqueMessageIdentifier)
</a><a href="#h221-0-119" id="h221-0-119" class="i">+
</a><a href="#h221-0-120" id="h221-0-120" class="i">+                threadPool.execute {
</a><a href="#h221-0-121" id="h221-0-121" class="i">+                    try {
</a><a href="#h221-0-122" id="h221-0-122" class="i">+                        messageLoggerInterface.addMessage(conversationId, uniqueMessageIdentifier, context.gson.toJson(messageInstance).toByteArray(Charsets.UTF_8))
</a><a href="#h221-0-123" id="h221-0-123" class="i">+                    } catch (ignored: DeadObjectException) {}
</a><a href="#h221-0-124" id="h221-0-124" class="i">+                }
</a><a href="#h221-0-125" id="h221-0-125" class="i">+
</a><a href="#h221-0-126" id="h221-0-126" class="i">+                return@subscribe
</a><a href="#h221-0-127" id="h221-0-127" class="i">+            }
</a><a href="#h221-0-128" id="h221-0-128" class="i">+
</a><a href="#h221-0-129" id="h221-0-129" class="i">+            //query the deleted message
</a><a href="#h221-0-130" id="h221-0-130" class="i">+            val deletedMessageObject: JsonObject = if (deletedMessageCache.containsKey(uniqueMessageIdentifier))
</a><a href="#h221-0-131" id="h221-0-131" class="i">+                deletedMessageCache[uniqueMessageIdentifier]
</a><a href="#h221-0-132" id="h221-0-132" class="i">+            else {
</a><a href="#h221-0-133" id="h221-0-133" class="i">+                messageLoggerInterface.getMessage(conversationId, uniqueMessageIdentifier)?.let {
</a><a href="#h221-0-134" id="h221-0-134" class="i">+                    JsonParser.parseString(it.toString(Charsets.UTF_8)).asJsonObject
</a><a href="#h221-0-135" id="h221-0-135" class="i">+                }
</a><a href="#h221-0-136" id="h221-0-136" class="i">+            } ?: return@subscribe
</a><a href="#h221-0-137" id="h221-0-137" class="i">+
</a><a href="#h221-0-138" id="h221-0-138" class="i">+            val messageJsonObject = deletedMessageObject.asJsonObject
</a><a href="#h221-0-139" id="h221-0-139" class="i">+
</a><a href="#h221-0-140" id="h221-0-140" class="i">+            //if the message is a snap make it playable
</a><a href="#h221-0-141" id="h221-0-141" class="i">+            if (messageJsonObject[&quot;mMessageContent&quot;]?.asJsonObject?.get(&quot;mContentType&quot;)?.asString == &quot;SNAP&quot;) {
</a><a href="#h221-0-142" id="h221-0-142" class="i">+                messageJsonObject[&quot;mMetadata&quot;].asJsonObject.addProperty(&quot;mPlayableSnapState&quot;, &quot;PLAYABLE&quot;)
</a><a href="#h221-0-143" id="h221-0-143" class="i">+            }
</a><a href="#h221-0-144" id="h221-0-144" class="i">+
</a><a href="#h221-0-145" id="h221-0-145" class="i">+            //serialize all properties of messageJsonObject and put in the message object
</a><a href="#h221-0-146" id="h221-0-146" class="i">+            messageInstance.javaClass.declaredFields.forEach { field -&gt;
</a><a href="#h221-0-147" id="h221-0-147" class="i">+                field.isAccessible = true
</a><a href="#h221-0-148" id="h221-0-148" class="i">+                if (field.name == &quot;mDescriptor&quot;) return@forEach // prevent the client message id from being overwritten
</a><a href="#h221-0-149" id="h221-0-149" class="i">+                messageJsonObject[field.name]?.let { fieldValue -&gt;
</a><a href="#h221-0-150" id="h221-0-150" class="i">+                    field.set(messageInstance, context.gson.fromJson(fieldValue, field.type))
</a><a href="#h221-0-151" id="h221-0-151" class="i">+                }
</a><a href="#h221-0-152" id="h221-0-152" class="i">+            }
</a><a href="#h221-0-153" id="h221-0-153" class="i">+
</a><a href="#h221-0-154" id="h221-0-154" class="i">+            deletedMessageCache[uniqueMessageIdentifier] = deletedMessageObject
</a><a href="#h221-0-155" id="h221-0-155" class="i">+        }
</a><a href="#h221-0-156" id="h221-0-156" class="i">+    }
</a><a href="#h221-0-157" id="h221-0-157" class="i">+
</a><a href="#h221-0-158" id="h221-0-158" class="i">+    override fun onActivityCreate() {
</a><a href="#h221-0-159" id="h221-0-159" class="i">+        if (!isEnabled) return
</a><a href="#h221-0-160" id="h221-0-160" class="i">+
</a><a href="#h221-0-161" id="h221-0-161" class="i">+        context.event.subscribe(BindViewEvent::class) { event -&gt;
</a><a href="#h221-0-162" id="h221-0-162" class="i">+            event.chatMessage { conversationId, messageId -&gt;
</a><a href="#h221-0-163" id="h221-0-163" class="i">+                event.view.removeForegroundDrawable(&quot;deletedMessage&quot;)
</a><a href="#h221-0-164" id="h221-0-164" class="i">+                makeUniqueIdentifier(conversationId, messageId.toLong())?.let { serverMessageId -&gt;
</a><a href="#h221-0-165" id="h221-0-165" class="i">+                    if (!deletedMessageCache.contains(serverMessageId)) return@chatMessage
</a><a href="#h221-0-166" id="h221-0-166" class="i">+                } ?: return@chatMessage
</a><a href="#h221-0-167" id="h221-0-167" class="i">+
</a><a href="#h221-0-168" id="h221-0-168" class="i">+                event.view.addForegroundDrawable(&quot;deletedMessage&quot;, ShapeDrawable(object: Shape() {
</a><a href="#h221-0-169" id="h221-0-169" class="i">+                    override fun draw(canvas: Canvas, paint: Paint) {
</a><a href="#h221-0-170" id="h221-0-170" class="i">+                        canvas.drawRect(0f, 0f, canvas.width.toFloat(), canvas.height.toFloat(), Paint().apply {
</a><a href="#h221-0-171" id="h221-0-171" class="i">+                            color = DELETED_MESSAGE_COLOR
</a><a href="#h221-0-172" id="h221-0-172" class="i">+                        })
</a><a href="#h221-0-173" id="h221-0-173" class="i">+                    }
</a><a href="#h221-0-174" id="h221-0-174" class="i">+                }))
</a><a href="#h221-0-175" id="h221-0-175" class="i">+            }
</a><a href="#h221-0-176" id="h221-0-176" class="i">+        }
</a><a href="#h221-0-177" id="h221-0-177" class="i">+    }
</a><a href="#h221-0-178" id="h221-0-178" class="i">+}</a><a href="#h221-0-179" id="h221-0-179" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h222" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/spying/SnapToChatMedia.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/spying/SnapToChatMedia.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/spying/SnapToChatMedia.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/spying/SnapToChatMedia.kt</a></b>
<a href="#h222-0" id="h222-0" class="h">@@ -0,0 +1,25 @@
</a><a href="#h222-0-0" id="h222-0-0" class="i">+package me.rhunk.snapenhance.core.features.impl.spying
</a><a href="#h222-0-1" id="h222-0-1" class="i">+
</a><a href="#h222-0-2" id="h222-0-2" class="i">+import me.rhunk.snapenhance.common.data.ContentType
</a><a href="#h222-0-3" id="h222-0-3" class="i">+import me.rhunk.snapenhance.common.util.protobuf.ProtoReader
</a><a href="#h222-0-4" id="h222-0-4" class="i">+import me.rhunk.snapenhance.common.util.protobuf.ProtoWriter
</a><a href="#h222-0-5" id="h222-0-5" class="i">+import me.rhunk.snapenhance.core.event.events.impl.BuildMessageEvent
</a><a href="#h222-0-6" id="h222-0-6" class="i">+import me.rhunk.snapenhance.core.features.Feature
</a><a href="#h222-0-7" id="h222-0-7" class="i">+import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a><a href="#h222-0-8" id="h222-0-8" class="i">+
</a><a href="#h222-0-9" id="h222-0-9" class="i">+class SnapToChatMedia : Feature(&quot;SnapToChatMedia&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_SYNC) {
</a><a href="#h222-0-10" id="h222-0-10" class="i">+    override fun onActivityCreate() {
</a><a href="#h222-0-11" id="h222-0-11" class="i">+        if (!context.config.messaging.snapToChatMedia.get()) return
</a><a href="#h222-0-12" id="h222-0-12" class="i">+
</a><a href="#h222-0-13" id="h222-0-13" class="i">+        context.event.subscribe(BuildMessageEvent::class, priority = 100) { event -&gt;
</a><a href="#h222-0-14" id="h222-0-14" class="i">+            if (event.message.messageContent.contentType != ContentType.SNAP) return@subscribe
</a><a href="#h222-0-15" id="h222-0-15" class="i">+
</a><a href="#h222-0-16" id="h222-0-16" class="i">+            val snapMessageContent = ProtoReader(event.message.messageContent.content).followPath(11)?.getBuffer() ?: return@subscribe
</a><a href="#h222-0-17" id="h222-0-17" class="i">+            event.message.messageContent.content = ProtoWriter().apply {
</a><a href="#h222-0-18" id="h222-0-18" class="i">+                from(3) {
</a><a href="#h222-0-19" id="h222-0-19" class="i">+                    addBuffer(3, snapMessageContent)
</a><a href="#h222-0-20" id="h222-0-20" class="i">+                }
</a><a href="#h222-0-21" id="h222-0-21" class="i">+            }.toByteArray()
</a><a href="#h222-0-22" id="h222-0-22" class="i">+        }
</a><a href="#h222-0-23" id="h222-0-23" class="i">+    }
</a><a href="#h222-0-24" id="h222-0-24" class="i">+}</a><a href="#h222-0-25" id="h222-0-25" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h223" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/spying/StealthMode.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/spying/StealthMode.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/spying/StealthMode.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/spying/StealthMode.kt</a></b>
<a href="#h223-0" id="h223-0" class="h">@@ -0,0 +1,6 @@
</a><a href="#h223-0-0" id="h223-0-0" class="i">+package me.rhunk.snapenhance.core.features.impl.spying
</a><a href="#h223-0-1" id="h223-0-1" class="i">+
</a><a href="#h223-0-2" id="h223-0-2" class="i">+import me.rhunk.snapenhance.common.data.MessagingRuleType
</a><a href="#h223-0-3" id="h223-0-3" class="i">+import me.rhunk.snapenhance.core.features.MessagingRuleFeature
</a><a href="#h223-0-4" id="h223-0-4" class="i">+
</a><a href="#h223-0-5" id="h223-0-5" class="i">+class StealthMode : MessagingRuleFeature(&quot;StealthMode&quot;, MessagingRuleType.STEALTH)</a><a href="#h223-0-6" id="h223-0-6" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h224" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/tweaks/CameraTweaks.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/tweaks/CameraTweaks.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/tweaks/CameraTweaks.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/tweaks/CameraTweaks.kt</a></b>
<a href="#h224-0" id="h224-0" class="h">@@ -0,0 +1,75 @@
</a><a href="#h224-0-0" id="h224-0-0" class="i">+package me.rhunk.snapenhance.core.features.impl.tweaks
</a><a href="#h224-0-1" id="h224-0-1" class="i">+
</a><a href="#h224-0-2" id="h224-0-2" class="i">+import android.Manifest
</a><a href="#h224-0-3" id="h224-0-3" class="i">+import android.annotation.SuppressLint
</a><a href="#h224-0-4" id="h224-0-4" class="i">+import android.content.ContextWrapper
</a><a href="#h224-0-5" id="h224-0-5" class="i">+import android.content.pm.PackageManager
</a><a href="#h224-0-6" id="h224-0-6" class="i">+import android.hardware.camera2.CameraCharacteristics
</a><a href="#h224-0-7" id="h224-0-7" class="i">+import android.hardware.camera2.CameraCharacteristics.Key
</a><a href="#h224-0-8" id="h224-0-8" class="i">+import android.hardware.camera2.CameraManager
</a><a href="#h224-0-9" id="h224-0-9" class="i">+import android.util.Range
</a><a href="#h224-0-10" id="h224-0-10" class="i">+import me.rhunk.snapenhance.core.features.Feature
</a><a href="#h224-0-11" id="h224-0-11" class="i">+import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a><a href="#h224-0-12" id="h224-0-12" class="i">+import me.rhunk.snapenhance.core.util.hook.HookStage
</a><a href="#h224-0-13" id="h224-0-13" class="i">+import me.rhunk.snapenhance.core.util.hook.hook
</a><a href="#h224-0-14" id="h224-0-14" class="i">+import me.rhunk.snapenhance.core.util.hook.hookConstructor
</a><a href="#h224-0-15" id="h224-0-15" class="i">+import me.rhunk.snapenhance.core.util.ktx.setObjectField
</a><a href="#h224-0-16" id="h224-0-16" class="i">+import me.rhunk.snapenhance.core.wrapper.impl.ScSize
</a><a href="#h224-0-17" id="h224-0-17" class="i">+
</a><a href="#h224-0-18" id="h224-0-18" class="i">+class CameraTweaks : Feature(&quot;Camera Tweaks&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_SYNC) {
</a><a href="#h224-0-19" id="h224-0-19" class="i">+
</a><a href="#h224-0-20" id="h224-0-20" class="i">+    private fun parseResolution(resolution: String): IntArray {
</a><a href="#h224-0-21" id="h224-0-21" class="i">+        return resolution.split(&quot;x&quot;).map { it.toInt() }.toIntArray()
</a><a href="#h224-0-22" id="h224-0-22" class="i">+    }
</a><a href="#h224-0-23" id="h224-0-23" class="i">+
</a><a href="#h224-0-24" id="h224-0-24" class="i">+    @SuppressLint(&quot;MissingPermission&quot;, &quot;DiscouragedApi&quot;)
</a><a href="#h224-0-25" id="h224-0-25" class="i">+    override fun onActivityCreate() {
</a><a href="#h224-0-26" id="h224-0-26" class="i">+        if (context.config.camera.disable.get()) {
</a><a href="#h224-0-27" id="h224-0-27" class="i">+            ContextWrapper::class.java.hook(&quot;checkPermission&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h224-0-28" id="h224-0-28" class="i">+                val permission = param.arg&lt;String&gt;(0)
</a><a href="#h224-0-29" id="h224-0-29" class="i">+                if (permission == Manifest.permission.CAMERA) {
</a><a href="#h224-0-30" id="h224-0-30" class="i">+                    param.setResult(PackageManager.PERMISSION_GRANTED)
</a><a href="#h224-0-31" id="h224-0-31" class="i">+                }
</a><a href="#h224-0-32" id="h224-0-32" class="i">+            }
</a><a href="#h224-0-33" id="h224-0-33" class="i">+
</a><a href="#h224-0-34" id="h224-0-34" class="i">+            CameraManager::class.java.hook(&quot;openCamera&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h224-0-35" id="h224-0-35" class="i">+                param.setResult(null)
</a><a href="#h224-0-36" id="h224-0-36" class="i">+            }
</a><a href="#h224-0-37" id="h224-0-37" class="i">+        }
</a><a href="#h224-0-38" id="h224-0-38" class="i">+
</a><a href="#h224-0-39" id="h224-0-39" class="i">+        val previewResolutionConfig = context.config.camera.overridePreviewResolution.getNullable()?.let { parseResolution(it) }
</a><a href="#h224-0-40" id="h224-0-40" class="i">+        val captureResolutionConfig = context.config.camera.overridePictureResolution.getNullable()?.let { parseResolution(it) }
</a><a href="#h224-0-41" id="h224-0-41" class="i">+
</a><a href="#h224-0-42" id="h224-0-42" class="i">+        context.config.camera.customFrameRate.getNullable()?.also { value -&gt;
</a><a href="#h224-0-43" id="h224-0-43" class="i">+            val customFrameRate = value.toInt()
</a><a href="#h224-0-44" id="h224-0-44" class="i">+            CameraCharacteristics::class.java.hook(&quot;get&quot;, HookStage.AFTER)  { param -&gt;
</a><a href="#h224-0-45" id="h224-0-45" class="i">+                val key = param.arg&lt;Key&lt;*&gt;&gt;(0)
</a><a href="#h224-0-46" id="h224-0-46" class="i">+                if (key == CameraCharacteristics.CONTROL_AE_AVAILABLE_TARGET_FPS_RANGES) {
</a><a href="#h224-0-47" id="h224-0-47" class="i">+                    val fpsRanges = param.getResult() as? Array&lt;*&gt; ?: return@hook
</a><a href="#h224-0-48" id="h224-0-48" class="i">+                    fpsRanges.forEach {
</a><a href="#h224-0-49" id="h224-0-49" class="i">+                        val range = it as? Range&lt;*&gt; ?: return@forEach
</a><a href="#h224-0-50" id="h224-0-50" class="i">+                        range.setObjectField(&quot;mUpper&quot;, customFrameRate)
</a><a href="#h224-0-51" id="h224-0-51" class="i">+                        range.setObjectField(&quot;mLower&quot;, customFrameRate)
</a><a href="#h224-0-52" id="h224-0-52" class="i">+                    }
</a><a href="#h224-0-53" id="h224-0-53" class="i">+                }
</a><a href="#h224-0-54" id="h224-0-54" class="i">+            }
</a><a href="#h224-0-55" id="h224-0-55" class="i">+        }
</a><a href="#h224-0-56" id="h224-0-56" class="i">+
</a><a href="#h224-0-57" id="h224-0-57" class="i">+        context.mappings.getMappedClass(&quot;ScCameraSettings&quot;).hookConstructor(HookStage.BEFORE) { param -&gt;
</a><a href="#h224-0-58" id="h224-0-58" class="i">+            val previewResolution = ScSize(param.argNullable(2))
</a><a href="#h224-0-59" id="h224-0-59" class="i">+            val captureResolution = ScSize(param.argNullable(3))
</a><a href="#h224-0-60" id="h224-0-60" class="i">+
</a><a href="#h224-0-61" id="h224-0-61" class="i">+            if (previewResolution.isPresent() &amp;&amp; captureResolution.isPresent()) {
</a><a href="#h224-0-62" id="h224-0-62" class="i">+                previewResolutionConfig?.let {
</a><a href="#h224-0-63" id="h224-0-63" class="i">+                    previewResolution.first = it[0]
</a><a href="#h224-0-64" id="h224-0-64" class="i">+                    previewResolution.second = it[1]
</a><a href="#h224-0-65" id="h224-0-65" class="i">+                }
</a><a href="#h224-0-66" id="h224-0-66" class="i">+
</a><a href="#h224-0-67" id="h224-0-67" class="i">+                captureResolutionConfig?.let {
</a><a href="#h224-0-68" id="h224-0-68" class="i">+                    captureResolution.first = it[0]
</a><a href="#h224-0-69" id="h224-0-69" class="i">+                    captureResolution.second = it[1]
</a><a href="#h224-0-70" id="h224-0-70" class="i">+                }
</a><a href="#h224-0-71" id="h224-0-71" class="i">+            }
</a><a href="#h224-0-72" id="h224-0-72" class="i">+        }
</a><a href="#h224-0-73" id="h224-0-73" class="i">+    }
</a><a href="#h224-0-74" id="h224-0-74" class="i">+}</a><a href="#h224-0-75" id="h224-0-75" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h225" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/ClientBootstrapOverride.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/ClientBootstrapOverride.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/ClientBootstrapOverride.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/ClientBootstrapOverride.kt</a></b>
<a href="#h225-0" id="h225-0" class="h">@@ -0,0 +1,32 @@
</a><a href="#h225-0-0" id="h225-0-0" class="i">+package me.rhunk.snapenhance.core.features.impl.ui
</a><a href="#h225-0-1" id="h225-0-1" class="i">+
</a><a href="#h225-0-2" id="h225-0-2" class="i">+import me.rhunk.snapenhance.common.config.impl.UserInterfaceTweaks
</a><a href="#h225-0-3" id="h225-0-3" class="i">+import me.rhunk.snapenhance.core.features.Feature
</a><a href="#h225-0-4" id="h225-0-4" class="i">+import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a><a href="#h225-0-5" id="h225-0-5" class="i">+import java.io.File
</a><a href="#h225-0-6" id="h225-0-6" class="i">+
</a><a href="#h225-0-7" id="h225-0-7" class="i">+
</a><a href="#h225-0-8" id="h225-0-8" class="i">+class ClientBootstrapOverride : Feature(&quot;ClientBootstrapOverride&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_SYNC) {
</a><a href="#h225-0-9" id="h225-0-9" class="i">+
</a><a href="#h225-0-10" id="h225-0-10" class="i">+    private val clientBootstrapFolder by lazy { File(context.androidContext.filesDir, &quot;client-bootstrap&quot;) }
</a><a href="#h225-0-11" id="h225-0-11" class="i">+
</a><a href="#h225-0-12" id="h225-0-12" class="i">+    private val appearanceStartupConfigFile by lazy { File(clientBootstrapFolder, &quot;appearancestartupconfig&quot;) }
</a><a href="#h225-0-13" id="h225-0-13" class="i">+    private val plusFile by lazy { File(clientBootstrapFolder, &quot;plus&quot;) }
</a><a href="#h225-0-14" id="h225-0-14" class="i">+
</a><a href="#h225-0-15" id="h225-0-15" class="i">+    override fun onActivityCreate() {
</a><a href="#h225-0-16" id="h225-0-16" class="i">+        val bootstrapOverrideConfig = context.config.userInterface.bootstrapOverride
</a><a href="#h225-0-17" id="h225-0-17" class="i">+
</a><a href="#h225-0-18" id="h225-0-18" class="i">+        bootstrapOverrideConfig.appAppearance.getNullable()?.also { appearance -&gt;
</a><a href="#h225-0-19" id="h225-0-19" class="i">+            val state = when (appearance) {
</a><a href="#h225-0-20" id="h225-0-20" class="i">+                &quot;always_light&quot; -&gt; 0
</a><a href="#h225-0-21" id="h225-0-21" class="i">+                &quot;always_dark&quot; -&gt; 1
</a><a href="#h225-0-22" id="h225-0-22" class="i">+                else -&gt; return@also
</a><a href="#h225-0-23" id="h225-0-23" class="i">+            }.toByte()
</a><a href="#h225-0-24" id="h225-0-24" class="i">+            appearanceStartupConfigFile.writeBytes(byteArrayOf(0, 0, 0, state))
</a><a href="#h225-0-25" id="h225-0-25" class="i">+        }
</a><a href="#h225-0-26" id="h225-0-26" class="i">+
</a><a href="#h225-0-27" id="h225-0-27" class="i">+        bootstrapOverrideConfig.homeTab.getNullable()?.also { currentTab -&gt;
</a><a href="#h225-0-28" id="h225-0-28" class="i">+            plusFile.writeBytes(byteArrayOf(8, (UserInterfaceTweaks.BootstrapOverride.tabs.indexOf(currentTab) + 1).toByte()))
</a><a href="#h225-0-29" id="h225-0-29" class="i">+        }
</a><a href="#h225-0-30" id="h225-0-30" class="i">+    }
</a><a href="#h225-0-31" id="h225-0-31" class="i">+}</a><a href="#h225-0-32" id="h225-0-32" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h226" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/FriendFeedMessagePreview.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/FriendFeedMessagePreview.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/FriendFeedMessagePreview.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/FriendFeedMessagePreview.kt</a></b>
<a href="#h226-0" id="h226-0" class="h">@@ -0,0 +1,106 @@
</a><a href="#h226-0-0" id="h226-0-0" class="i">+package me.rhunk.snapenhance.core.features.impl.ui
</a><a href="#h226-0-1" id="h226-0-1" class="i">+
</a><a href="#h226-0-2" id="h226-0-2" class="i">+import android.annotation.SuppressLint
</a><a href="#h226-0-3" id="h226-0-3" class="i">+import android.graphics.Canvas
</a><a href="#h226-0-4" id="h226-0-4" class="i">+import android.graphics.Paint
</a><a href="#h226-0-5" id="h226-0-5" class="i">+import android.graphics.Rect
</a><a href="#h226-0-6" id="h226-0-6" class="i">+import android.graphics.drawable.ShapeDrawable
</a><a href="#h226-0-7" id="h226-0-7" class="i">+import android.graphics.drawable.shapes.Shape
</a><a href="#h226-0-8" id="h226-0-8" class="i">+import android.text.TextPaint
</a><a href="#h226-0-9" id="h226-0-9" class="i">+import android.view.View
</a><a href="#h226-0-10" id="h226-0-10" class="i">+import android.view.ViewGroup
</a><a href="#h226-0-11" id="h226-0-11" class="i">+import me.rhunk.snapenhance.common.Constants
</a><a href="#h226-0-12" id="h226-0-12" class="i">+import me.rhunk.snapenhance.common.data.ContentType
</a><a href="#h226-0-13" id="h226-0-13" class="i">+import me.rhunk.snapenhance.common.util.protobuf.ProtoReader
</a><a href="#h226-0-14" id="h226-0-14" class="i">+import me.rhunk.snapenhance.core.event.events.impl.BindViewEvent
</a><a href="#h226-0-15" id="h226-0-15" class="i">+import me.rhunk.snapenhance.core.features.Feature
</a><a href="#h226-0-16" id="h226-0-16" class="i">+import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a><a href="#h226-0-17" id="h226-0-17" class="i">+import me.rhunk.snapenhance.core.ui.addForegroundDrawable
</a><a href="#h226-0-18" id="h226-0-18" class="i">+import me.rhunk.snapenhance.core.ui.removeForegroundDrawable
</a><a href="#h226-0-19" id="h226-0-19" class="i">+import kotlin.math.absoluteValue
</a><a href="#h226-0-20" id="h226-0-20" class="i">+
</a><a href="#h226-0-21" id="h226-0-21" class="i">+@SuppressLint(&quot;DiscouragedApi&quot;)
</a><a href="#h226-0-22" id="h226-0-22" class="i">+class FriendFeedMessagePreview : Feature(&quot;FriendFeedMessagePreview&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_SYNC) {
</a><a href="#h226-0-23" id="h226-0-23" class="i">+    private val sigColorTextPrimary by lazy {
</a><a href="#h226-0-24" id="h226-0-24" class="i">+        context.mainActivity!!.theme.obtainStyledAttributes(
</a><a href="#h226-0-25" id="h226-0-25" class="i">+            intArrayOf(context.resources.getIdentifier(&quot;sigColorTextPrimary&quot;, &quot;attr&quot;, Constants.SNAPCHAT_PACKAGE_NAME))
</a><a href="#h226-0-26" id="h226-0-26" class="i">+        ).getColor(0, 0)
</a><a href="#h226-0-27" id="h226-0-27" class="i">+    }
</a><a href="#h226-0-28" id="h226-0-28" class="i">+
</a><a href="#h226-0-29" id="h226-0-29" class="i">+    private fun getDimens(name: String) = context.resources.getDimensionPixelSize(context.resources.getIdentifier(name, &quot;dimen&quot;, Constants.SNAPCHAT_PACKAGE_NAME))
</a><a href="#h226-0-30" id="h226-0-30" class="i">+
</a><a href="#h226-0-31" id="h226-0-31" class="i">+    override fun onActivityCreate() {
</a><a href="#h226-0-32" id="h226-0-32" class="i">+        val setting = context.config.userInterface.friendFeedMessagePreview
</a><a href="#h226-0-33" id="h226-0-33" class="i">+        if (setting.globalState != true) return
</a><a href="#h226-0-34" id="h226-0-34" class="i">+
</a><a href="#h226-0-35" id="h226-0-35" class="i">+        val ffItemId = context.resources.getIdentifier(&quot;ff_item&quot;, &quot;id&quot;, Constants.SNAPCHAT_PACKAGE_NAME)
</a><a href="#h226-0-36" id="h226-0-36" class="i">+
</a><a href="#h226-0-37" id="h226-0-37" class="i">+        val secondaryTextSize = getDimens(&quot;ff_feed_cell_secondary_text_size&quot;).toFloat()
</a><a href="#h226-0-38" id="h226-0-38" class="i">+        val ffSdlAvatarMargin = getDimens(&quot;ff_sdl_avatar_margin&quot;)
</a><a href="#h226-0-39" id="h226-0-39" class="i">+        val ffSdlAvatarSize = getDimens(&quot;ff_sdl_avatar_size&quot;)
</a><a href="#h226-0-40" id="h226-0-40" class="i">+        val ffSdlAvatarStartMargin = getDimens(&quot;ff_sdl_avatar_start_margin&quot;)
</a><a href="#h226-0-41" id="h226-0-41" class="i">+        val ffSdlPrimaryTextStartMargin = getDimens(&quot;ff_sdl_primary_text_start_margin&quot;).toFloat()
</a><a href="#h226-0-42" id="h226-0-42" class="i">+
</a><a href="#h226-0-43" id="h226-0-43" class="i">+        val feedEntryHeight = ffSdlAvatarSize + ffSdlAvatarMargin * 2 + ffSdlAvatarStartMargin
</a><a href="#h226-0-44" id="h226-0-44" class="i">+        val separatorHeight = (context.resources.displayMetrics.density * 2).toInt()
</a><a href="#h226-0-45" id="h226-0-45" class="i">+        val textPaint = TextPaint().apply {
</a><a href="#h226-0-46" id="h226-0-46" class="i">+            textSize = secondaryTextSize
</a><a href="#h226-0-47" id="h226-0-47" class="i">+        }
</a><a href="#h226-0-48" id="h226-0-48" class="i">+
</a><a href="#h226-0-49" id="h226-0-49" class="i">+        context.event.subscribe(BindViewEvent::class) { param -&gt;
</a><a href="#h226-0-50" id="h226-0-50" class="i">+            param.friendFeedItem { conversationId -&gt;
</a><a href="#h226-0-51" id="h226-0-51" class="i">+                val frameLayout = param.view as ViewGroup
</a><a href="#h226-0-52" id="h226-0-52" class="i">+                val ffItem = frameLayout.findViewById&lt;View&gt;(ffItemId)
</a><a href="#h226-0-53" id="h226-0-53" class="i">+
</a><a href="#h226-0-54" id="h226-0-54" class="i">+                ffItem.layoutParams = ffItem.layoutParams.apply {
</a><a href="#h226-0-55" id="h226-0-55" class="i">+                    height = ViewGroup.LayoutParams.MATCH_PARENT
</a><a href="#h226-0-56" id="h226-0-56" class="i">+                }
</a><a href="#h226-0-57" id="h226-0-57" class="i">+                frameLayout.removeForegroundDrawable(&quot;ffItem&quot;)
</a><a href="#h226-0-58" id="h226-0-58" class="i">+
</a><a href="#h226-0-59" id="h226-0-59" class="i">+                val stringMessages = context.database.getMessagesFromConversationId(conversationId, setting.amount.get().absoluteValue)?.mapNotNull { message -&gt;
</a><a href="#h226-0-60" id="h226-0-60" class="i">+                    val messageContainer = message.messageContent
</a><a href="#h226-0-61" id="h226-0-61" class="i">+                        ?.let { ProtoReader(it) }
</a><a href="#h226-0-62" id="h226-0-62" class="i">+                        ?.followPath(4, 4)
</a><a href="#h226-0-63" id="h226-0-63" class="i">+                        ?: return@mapNotNull null
</a><a href="#h226-0-64" id="h226-0-64" class="i">+
</a><a href="#h226-0-65" id="h226-0-65" class="i">+                    val messageString = messageContainer.getString(2, 1)
</a><a href="#h226-0-66" id="h226-0-66" class="i">+                        ?: ContentType.fromMessageContainer(messageContainer)?.name
</a><a href="#h226-0-67" id="h226-0-67" class="i">+                        ?: return@mapNotNull null
</a><a href="#h226-0-68" id="h226-0-68" class="i">+
</a><a href="#h226-0-69" id="h226-0-69" class="i">+                    val friendName = context.database.getFriendInfo(message.senderId ?: return@mapNotNull null)?.let { it.displayName?: it.mutableUsername } ?: &quot;Unknown&quot;
</a><a href="#h226-0-70" id="h226-0-70" class="i">+
</a><a href="#h226-0-71" id="h226-0-71" class="i">+                    &quot;$friendName: $messageString&quot;
</a><a href="#h226-0-72" id="h226-0-72" class="i">+                }?.reversed() ?: return@friendFeedItem
</a><a href="#h226-0-73" id="h226-0-73" class="i">+
</a><a href="#h226-0-74" id="h226-0-74" class="i">+                var maxTextHeight = 0
</a><a href="#h226-0-75" id="h226-0-75" class="i">+                val previewContainerHeight = stringMessages.sumOf { msg -&gt;
</a><a href="#h226-0-76" id="h226-0-76" class="i">+                    val rect = Rect()
</a><a href="#h226-0-77" id="h226-0-77" class="i">+                    textPaint.getTextBounds(msg, 0, msg.length, rect)
</a><a href="#h226-0-78" id="h226-0-78" class="i">+                    rect.height().also {
</a><a href="#h226-0-79" id="h226-0-79" class="i">+                        if (it &gt; maxTextHeight) maxTextHeight = it
</a><a href="#h226-0-80" id="h226-0-80" class="i">+                    }.plus(separatorHeight)
</a><a href="#h226-0-81" id="h226-0-81" class="i">+                }
</a><a href="#h226-0-82" id="h226-0-82" class="i">+
</a><a href="#h226-0-83" id="h226-0-83" class="i">+                ffItem.layoutParams = ffItem.layoutParams.apply {
</a><a href="#h226-0-84" id="h226-0-84" class="i">+                    height = feedEntryHeight + previewContainerHeight + separatorHeight
</a><a href="#h226-0-85" id="h226-0-85" class="i">+                }
</a><a href="#h226-0-86" id="h226-0-86" class="i">+
</a><a href="#h226-0-87" id="h226-0-87" class="i">+                frameLayout.addForegroundDrawable(&quot;ffItem&quot;, ShapeDrawable(object: Shape() {
</a><a href="#h226-0-88" id="h226-0-88" class="i">+                    override fun draw(canvas: Canvas, paint: Paint) {
</a><a href="#h226-0-89" id="h226-0-89" class="i">+                        val offsetY = canvas.height.toFloat() - previewContainerHeight
</a><a href="#h226-0-90" id="h226-0-90" class="i">+
</a><a href="#h226-0-91" id="h226-0-91" class="i">+                        stringMessages.forEachIndexed { index, messageString -&gt;
</a><a href="#h226-0-92" id="h226-0-92" class="i">+                            paint.textSize = secondaryTextSize
</a><a href="#h226-0-93" id="h226-0-93" class="i">+                            paint.color = sigColorTextPrimary
</a><a href="#h226-0-94" id="h226-0-94" class="i">+                            canvas.drawText(messageString,
</a><a href="#h226-0-95" id="h226-0-95" class="i">+                                feedEntryHeight + ffSdlPrimaryTextStartMargin,
</a><a href="#h226-0-96" id="h226-0-96" class="i">+                                offsetY + index * maxTextHeight,
</a><a href="#h226-0-97" id="h226-0-97" class="i">+                                paint
</a><a href="#h226-0-98" id="h226-0-98" class="i">+                            )
</a><a href="#h226-0-99" id="h226-0-99" class="i">+                        }
</a><a href="#h226-0-100" id="h226-0-100" class="i">+                    }
</a><a href="#h226-0-101" id="h226-0-101" class="i">+                }))
</a><a href="#h226-0-102" id="h226-0-102" class="i">+            }
</a><a href="#h226-0-103" id="h226-0-103" class="i">+        }
</a><a href="#h226-0-104" id="h226-0-104" class="i">+    }
</a><a href="#h226-0-105" id="h226-0-105" class="i">+}</a><a href="#h226-0-106" id="h226-0-106" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h227" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/HideStreakRestore.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/HideStreakRestore.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/HideStreakRestore.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/HideStreakRestore.kt</a></b>
<a href="#h227-0" id="h227-0" class="h">@@ -0,0 +1,19 @@
</a><a href="#h227-0-0" id="h227-0-0" class="i">+package me.rhunk.snapenhance.core.features.impl.ui
</a><a href="#h227-0-1" id="h227-0-1" class="i">+
</a><a href="#h227-0-2" id="h227-0-2" class="i">+import me.rhunk.snapenhance.core.features.Feature
</a><a href="#h227-0-3" id="h227-0-3" class="i">+import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a><a href="#h227-0-4" id="h227-0-4" class="i">+import me.rhunk.snapenhance.core.util.hook.HookStage
</a><a href="#h227-0-5" id="h227-0-5" class="i">+import me.rhunk.snapenhance.core.util.hook.hookConstructor
</a><a href="#h227-0-6" id="h227-0-6" class="i">+import me.rhunk.snapenhance.core.util.ktx.getObjectField
</a><a href="#h227-0-7" id="h227-0-7" class="i">+import me.rhunk.snapenhance.core.util.ktx.setObjectField
</a><a href="#h227-0-8" id="h227-0-8" class="i">+
</a><a href="#h227-0-9" id="h227-0-9" class="i">+class HideStreakRestore : Feature(&quot;HideStreakRestore&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_SYNC) {
</a><a href="#h227-0-10" id="h227-0-10" class="i">+    override fun onActivityCreate() {
</a><a href="#h227-0-11" id="h227-0-11" class="i">+        if (!context.config.userInterface.hideStreakRestore.get()) return
</a><a href="#h227-0-12" id="h227-0-12" class="i">+
</a><a href="#h227-0-13" id="h227-0-13" class="i">+        context.classCache.feedEntry.hookConstructor(HookStage.AFTER) { param -&gt;
</a><a href="#h227-0-14" id="h227-0-14" class="i">+            val streakMetadata = param.thisObject&lt;Any&gt;().getObjectField(&quot;mStreakMetadata&quot;) ?: return@hookConstructor
</a><a href="#h227-0-15" id="h227-0-15" class="i">+            streakMetadata.setObjectField(&quot;mExpiredStreak&quot;, null)
</a><a href="#h227-0-16" id="h227-0-16" class="i">+        }
</a><a href="#h227-0-17" id="h227-0-17" class="i">+    }
</a><a href="#h227-0-18" id="h227-0-18" class="i">+}</a><a href="#h227-0-19" id="h227-0-19" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h228" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/OldBitmojiSelfie.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/OldBitmojiSelfie.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/OldBitmojiSelfie.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/OldBitmojiSelfie.kt</a></b>
<a href="#h228-0" id="h228-0" class="h">@@ -0,0 +1,22 @@
</a><a href="#h228-0-0" id="h228-0-0" class="i">+package me.rhunk.snapenhance.core.features.impl.ui
</a><a href="#h228-0-1" id="h228-0-1" class="i">+
</a><a href="#h228-0-2" id="h228-0-2" class="i">+import me.rhunk.snapenhance.common.util.snap.BitmojiSelfie
</a><a href="#h228-0-3" id="h228-0-3" class="i">+import me.rhunk.snapenhance.core.event.events.impl.NetworkApiRequestEvent
</a><a href="#h228-0-4" id="h228-0-4" class="i">+import me.rhunk.snapenhance.core.features.Feature
</a><a href="#h228-0-5" id="h228-0-5" class="i">+import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a><a href="#h228-0-6" id="h228-0-6" class="i">+
</a><a href="#h228-0-7" id="h228-0-7" class="i">+class OldBitmojiSelfie : Feature(&quot;OldBitmojiSelfie&quot;, loadParams = FeatureLoadParams.INIT_SYNC) {
</a><a href="#h228-0-8" id="h228-0-8" class="i">+    override fun init() {
</a><a href="#h228-0-9" id="h228-0-9" class="i">+        val urlPrefixes = arrayOf(&quot;https://images.bitmoji.com/3d/render/&quot;, &quot;https://cf-st.sc-cdn.net/3d/render/&quot;)
</a><a href="#h228-0-10" id="h228-0-10" class="i">+        val state by context.config.userInterface.ddBitmojiSelfie
</a><a href="#h228-0-11" id="h228-0-11" class="i">+
</a><a href="#h228-0-12" id="h228-0-12" class="i">+        context.event.subscribe(NetworkApiRequestEvent::class, { state }) { event -&gt;
</a><a href="#h228-0-13" id="h228-0-13" class="i">+            if (urlPrefixes.firstOrNull { event.url.startsWith(it) } == null) return@subscribe
</a><a href="#h228-0-14" id="h228-0-14" class="i">+            val bitmojiURI = event.url.substringAfterLast(&quot;/&quot;)
</a><a href="#h228-0-15" id="h228-0-15" class="i">+            event.url =
</a><a href="#h228-0-16" id="h228-0-16" class="i">+                BitmojiSelfie.BitmojiSelfieType.STANDARD.prefixUrl +
</a><a href="#h228-0-17" id="h228-0-17" class="i">+                bitmojiURI +
</a><a href="#h228-0-18" id="h228-0-18" class="i">+                (bitmojiURI.takeIf { !it.contains(&quot;?&quot;) }?.let { &quot;?&quot; } ?: &quot;&amp;&quot;) + &quot;transparent=1&quot;
</a><a href="#h228-0-19" id="h228-0-19" class="i">+        }
</a><a href="#h228-0-20" id="h228-0-20" class="i">+    }
</a><a href="#h228-0-21" id="h228-0-21" class="i">+}</a><a href="#h228-0-22" id="h228-0-22" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h229" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/PinConversations.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/PinConversations.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/PinConversations.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/PinConversations.kt</a></b>
<a href="#h229-0" id="h229-0" class="h">@@ -0,0 +1,41 @@
</a><a href="#h229-0-0" id="h229-0-0" class="i">+package me.rhunk.snapenhance.core.features.impl.ui
</a><a href="#h229-0-1" id="h229-0-1" class="i">+
</a><a href="#h229-0-2" id="h229-0-2" class="i">+import me.rhunk.snapenhance.common.data.MessagingRuleType
</a><a href="#h229-0-3" id="h229-0-3" class="i">+import me.rhunk.snapenhance.common.data.RuleState
</a><a href="#h229-0-4" id="h229-0-4" class="i">+import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a><a href="#h229-0-5" id="h229-0-5" class="i">+import me.rhunk.snapenhance.core.features.MessagingRuleFeature
</a><a href="#h229-0-6" id="h229-0-6" class="i">+import me.rhunk.snapenhance.core.util.hook.HookStage
</a><a href="#h229-0-7" id="h229-0-7" class="i">+import me.rhunk.snapenhance.core.util.hook.hook
</a><a href="#h229-0-8" id="h229-0-8" class="i">+import me.rhunk.snapenhance.core.util.hook.hookConstructor
</a><a href="#h229-0-9" id="h229-0-9" class="i">+import me.rhunk.snapenhance.core.util.ktx.getObjectField
</a><a href="#h229-0-10" id="h229-0-10" class="i">+import me.rhunk.snapenhance.core.util.ktx.setObjectField
</a><a href="#h229-0-11" id="h229-0-11" class="i">+import me.rhunk.snapenhance.core.wrapper.impl.SnapUUID
</a><a href="#h229-0-12" id="h229-0-12" class="i">+
</a><a href="#h229-0-13" id="h229-0-13" class="i">+class PinConversations : MessagingRuleFeature(&quot;PinConversations&quot;, MessagingRuleType.PIN_CONVERSATION, loadParams = FeatureLoadParams.ACTIVITY_CREATE_SYNC) {
</a><a href="#h229-0-14" id="h229-0-14" class="i">+    override fun onActivityCreate() {
</a><a href="#h229-0-15" id="h229-0-15" class="i">+        context.classCache.feedManager.hook(&quot;setPinnedConversationStatus&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h229-0-16" id="h229-0-16" class="i">+            val conversationUUID = SnapUUID(param.arg(0))
</a><a href="#h229-0-17" id="h229-0-17" class="i">+            val isPinned = param.arg&lt;Any&gt;(1).toString() == &quot;PINNED&quot;
</a><a href="#h229-0-18" id="h229-0-18" class="i">+            setState(conversationUUID.toString(), isPinned)
</a><a href="#h229-0-19" id="h229-0-19" class="i">+        }
</a><a href="#h229-0-20" id="h229-0-20" class="i">+
</a><a href="#h229-0-21" id="h229-0-21" class="i">+        context.classCache.conversation.hookConstructor(HookStage.AFTER) { param -&gt;
</a><a href="#h229-0-22" id="h229-0-22" class="i">+            val instance = param.thisObject&lt;Any&gt;()
</a><a href="#h229-0-23" id="h229-0-23" class="i">+            val conversationUUID = SnapUUID(instance.getObjectField(&quot;mConversationId&quot;))
</a><a href="#h229-0-24" id="h229-0-24" class="i">+            if (getState(conversationUUID.toString())) {
</a><a href="#h229-0-25" id="h229-0-25" class="i">+                instance.setObjectField(&quot;mPinnedTimestampMs&quot;, 1L)
</a><a href="#h229-0-26" id="h229-0-26" class="i">+            }
</a><a href="#h229-0-27" id="h229-0-27" class="i">+        }
</a><a href="#h229-0-28" id="h229-0-28" class="i">+
</a><a href="#h229-0-29" id="h229-0-29" class="i">+        context.classCache.feedEntry.hookConstructor(HookStage.AFTER) { param -&gt;
</a><a href="#h229-0-30" id="h229-0-30" class="i">+            val instance = param.thisObject&lt;Any&gt;()
</a><a href="#h229-0-31" id="h229-0-31" class="i">+            val conversationUUID = SnapUUID(instance.getObjectField(&quot;mConversationId&quot;) ?: return@hookConstructor)
</a><a href="#h229-0-32" id="h229-0-32" class="i">+            val isPinned = getState(conversationUUID.toString())
</a><a href="#h229-0-33" id="h229-0-33" class="i">+            if (isPinned) {
</a><a href="#h229-0-34" id="h229-0-34" class="i">+                instance.setObjectField(&quot;mPinnedTimestampMs&quot;, 1L)
</a><a href="#h229-0-35" id="h229-0-35" class="i">+            }
</a><a href="#h229-0-36" id="h229-0-36" class="i">+        }
</a><a href="#h229-0-37" id="h229-0-37" class="i">+    }
</a><a href="#h229-0-38" id="h229-0-38" class="i">+
</a><a href="#h229-0-39" id="h229-0-39" class="i">+    override fun getRuleState() = RuleState.WHITELIST
</a><a href="#h229-0-40" id="h229-0-40" class="i">+}</a><a href="#h229-0-41" id="h229-0-41" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h230" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/UITweaks.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/UITweaks.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/UITweaks.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/UITweaks.kt</a></b>
<a href="#h230-0" id="h230-0" class="h">@@ -0,0 +1,150 @@
</a><a href="#h230-0-0" id="h230-0-0" class="i">+package me.rhunk.snapenhance.core.features.impl.ui
</a><a href="#h230-0-1" id="h230-0-1" class="i">+
</a><a href="#h230-0-2" id="h230-0-2" class="i">+import android.annotation.SuppressLint
</a><a href="#h230-0-3" id="h230-0-3" class="i">+import android.content.Context
</a><a href="#h230-0-4" id="h230-0-4" class="i">+import android.content.res.Resources
</a><a href="#h230-0-5" id="h230-0-5" class="i">+import android.text.SpannableString
</a><a href="#h230-0-6" id="h230-0-6" class="i">+import android.view.View
</a><a href="#h230-0-7" id="h230-0-7" class="i">+import android.view.ViewGroup.MarginLayoutParams
</a><a href="#h230-0-8" id="h230-0-8" class="i">+import android.widget.FrameLayout
</a><a href="#h230-0-9" id="h230-0-9" class="i">+import me.rhunk.snapenhance.common.Constants
</a><a href="#h230-0-10" id="h230-0-10" class="i">+import me.rhunk.snapenhance.core.event.events.impl.AddViewEvent
</a><a href="#h230-0-11" id="h230-0-11" class="i">+import me.rhunk.snapenhance.core.features.Feature
</a><a href="#h230-0-12" id="h230-0-12" class="i">+import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a><a href="#h230-0-13" id="h230-0-13" class="i">+import me.rhunk.snapenhance.core.util.hook.HookStage
</a><a href="#h230-0-14" id="h230-0-14" class="i">+import me.rhunk.snapenhance.core.util.hook.Hooker
</a><a href="#h230-0-15" id="h230-0-15" class="i">+import me.rhunk.snapenhance.core.util.hook.hook
</a><a href="#h230-0-16" id="h230-0-16" class="i">+
</a><a href="#h230-0-17" id="h230-0-17" class="i">+class UITweaks : Feature(&quot;UITweaks&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_SYNC) {
</a><a href="#h230-0-18" id="h230-0-18" class="i">+    private val identifierCache = mutableMapOf&lt;String, Int&gt;()
</a><a href="#h230-0-19" id="h230-0-19" class="i">+
</a><a href="#h230-0-20" id="h230-0-20" class="i">+    @SuppressLint(&quot;DiscouragedApi&quot;)
</a><a href="#h230-0-21" id="h230-0-21" class="i">+    fun getIdentifier(name: String, defType: String): Int {
</a><a href="#h230-0-22" id="h230-0-22" class="i">+        return identifierCache.getOrPut(&quot;$name:$defType&quot;) {
</a><a href="#h230-0-23" id="h230-0-23" class="i">+            context.resources.getIdentifier(name, defType, Constants.SNAPCHAT_PACKAGE_NAME)
</a><a href="#h230-0-24" id="h230-0-24" class="i">+        }
</a><a href="#h230-0-25" id="h230-0-25" class="i">+    }
</a><a href="#h230-0-26" id="h230-0-26" class="i">+
</a><a href="#h230-0-27" id="h230-0-27" class="i">+    private fun hideStorySection(event: AddViewEvent) {
</a><a href="#h230-0-28" id="h230-0-28" class="i">+        val parent = event.parent
</a><a href="#h230-0-29" id="h230-0-29" class="i">+        parent.visibility = View.GONE
</a><a href="#h230-0-30" id="h230-0-30" class="i">+        val marginLayoutParams = parent.layoutParams as MarginLayoutParams
</a><a href="#h230-0-31" id="h230-0-31" class="i">+        marginLayoutParams.setMargins(-99999, -99999, -99999, -99999)
</a><a href="#h230-0-32" id="h230-0-32" class="i">+        event.canceled = true
</a><a href="#h230-0-33" id="h230-0-33" class="i">+    }
</a><a href="#h230-0-34" id="h230-0-34" class="i">+
</a><a href="#h230-0-35" id="h230-0-35" class="i">+    private var surfaceViewAspectRatio: Float = 0f
</a><a href="#h230-0-36" id="h230-0-36" class="i">+
</a><a href="#h230-0-37" id="h230-0-37" class="i">+    @SuppressLint(&quot;DiscouragedApi&quot;, &quot;InternalInsetResource&quot;)
</a><a href="#h230-0-38" id="h230-0-38" class="i">+    override fun onActivityCreate() {
</a><a href="#h230-0-39" id="h230-0-39" class="i">+        val blockAds by context.config.global.blockAds
</a><a href="#h230-0-40" id="h230-0-40" class="i">+        val hiddenElements by context.config.userInterface.hideUiComponents
</a><a href="#h230-0-41" id="h230-0-41" class="i">+        val hideStorySections by context.config.userInterface.hideStorySections
</a><a href="#h230-0-42" id="h230-0-42" class="i">+        val isImmersiveCamera by context.config.camera.immersiveCameraPreview
</a><a href="#h230-0-43" id="h230-0-43" class="i">+
</a><a href="#h230-0-44" id="h230-0-44" class="i">+        val displayMetrics = context.resources.displayMetrics
</a><a href="#h230-0-45" id="h230-0-45" class="i">+        val deviceAspectRatio = displayMetrics.widthPixels.toFloat() / displayMetrics.heightPixels.toFloat()
</a><a href="#h230-0-46" id="h230-0-46" class="i">+
</a><a href="#h230-0-47" id="h230-0-47" class="i">+        val callButtonsStub = getIdentifier(&quot;call_buttons_stub&quot;, &quot;id&quot;)
</a><a href="#h230-0-48" id="h230-0-48" class="i">+        val callButton1 = getIdentifier(&quot;friend_action_button3&quot;, &quot;id&quot;)
</a><a href="#h230-0-49" id="h230-0-49" class="i">+        val callButton2 = getIdentifier(&quot;friend_action_button4&quot;, &quot;id&quot;)
</a><a href="#h230-0-50" id="h230-0-50" class="i">+
</a><a href="#h230-0-51" id="h230-0-51" class="i">+        val chatNoteRecordButton = getIdentifier(&quot;chat_note_record_button&quot;, &quot;id&quot;)
</a><a href="#h230-0-52" id="h230-0-52" class="i">+
</a><a href="#h230-0-53" id="h230-0-53" class="i">+        View::class.java.hook(&quot;setVisibility&quot;, HookStage.BEFORE) { methodParam -&gt;
</a><a href="#h230-0-54" id="h230-0-54" class="i">+            val viewId = (methodParam.thisObject() as View).id
</a><a href="#h230-0-55" id="h230-0-55" class="i">+            if (viewId == callButton1 || viewId == callButton2) {
</a><a href="#h230-0-56" id="h230-0-56" class="i">+                if (!hiddenElements.contains(&quot;hide_profile_call_buttons&quot;)) return@hook
</a><a href="#h230-0-57" id="h230-0-57" class="i">+                methodParam.setArg(0, View.GONE)
</a><a href="#h230-0-58" id="h230-0-58" class="i">+            }
</a><a href="#h230-0-59" id="h230-0-59" class="i">+        }
</a><a href="#h230-0-60" id="h230-0-60" class="i">+
</a><a href="#h230-0-61" id="h230-0-61" class="i">+        Resources::class.java.methods.first { it.name == &quot;getDimensionPixelSize&quot;}.hook(
</a><a href="#h230-0-62" id="h230-0-62" class="i">+            HookStage.AFTER,
</a><a href="#h230-0-63" id="h230-0-63" class="i">+            { isImmersiveCamera }
</a><a href="#h230-0-64" id="h230-0-64" class="i">+        ) { param -&gt;
</a><a href="#h230-0-65" id="h230-0-65" class="i">+            val id = param.arg&lt;Int&gt;(0)
</a><a href="#h230-0-66" id="h230-0-66" class="i">+            if (id == getIdentifier(&quot;capri_viewfinder_default_corner_radius&quot;, &quot;dimen&quot;) ||
</a><a href="#h230-0-67" id="h230-0-67" class="i">+                id == getIdentifier(&quot;ngs_hova_nav_larger_camera_button_size&quot;, &quot;dimen&quot;)) {
</a><a href="#h230-0-68" id="h230-0-68" class="i">+                param.setResult(0)
</a><a href="#h230-0-69" id="h230-0-69" class="i">+            }
</a><a href="#h230-0-70" id="h230-0-70" class="i">+        }
</a><a href="#h230-0-71" id="h230-0-71" class="i">+
</a><a href="#h230-0-72" id="h230-0-72" class="i">+        context.event.subscribe(AddViewEvent::class) { event -&gt;
</a><a href="#h230-0-73" id="h230-0-73" class="i">+            val viewId = event.view.id
</a><a href="#h230-0-74" id="h230-0-74" class="i">+            val view = event.view
</a><a href="#h230-0-75" id="h230-0-75" class="i">+
</a><a href="#h230-0-76" id="h230-0-76" class="i">+            if (hideStorySections.contains(&quot;hide_for_you&quot;)) {
</a><a href="#h230-0-77" id="h230-0-77" class="i">+                if (viewId == getIdentifier(&quot;df_large_story&quot;, &quot;id&quot;) ||
</a><a href="#h230-0-78" id="h230-0-78" class="i">+                            viewId == getIdentifier(&quot;df_promoted_story&quot;, &quot;id&quot;)) {
</a><a href="#h230-0-79" id="h230-0-79" class="i">+                    hideStorySection(event)
</a><a href="#h230-0-80" id="h230-0-80" class="i">+                    return@subscribe
</a><a href="#h230-0-81" id="h230-0-81" class="i">+                }
</a><a href="#h230-0-82" id="h230-0-82" class="i">+                if (viewId == getIdentifier(&quot;stories_load_progress_layout&quot;, &quot;id&quot;)) {
</a><a href="#h230-0-83" id="h230-0-83" class="i">+                    event.canceled = true
</a><a href="#h230-0-84" id="h230-0-84" class="i">+                }
</a><a href="#h230-0-85" id="h230-0-85" class="i">+            }
</a><a href="#h230-0-86" id="h230-0-86" class="i">+
</a><a href="#h230-0-87" id="h230-0-87" class="i">+            if (hideStorySections.contains(&quot;hide_friends&quot;) &amp;&amp; viewId == getIdentifier(&quot;friend_card_frame&quot;, &quot;id&quot;)) {
</a><a href="#h230-0-88" id="h230-0-88" class="i">+                hideStorySection(event)
</a><a href="#h230-0-89" id="h230-0-89" class="i">+            }
</a><a href="#h230-0-90" id="h230-0-90" class="i">+
</a><a href="#h230-0-91" id="h230-0-91" class="i">+            //mappings?
</a><a href="#h230-0-92" id="h230-0-92" class="i">+            if (hideStorySections.contains(&quot;hide_friend_suggestions&quot;) &amp;&amp; view.javaClass.superclass?.name?.endsWith(&quot;StackDrawLayout&quot;) == true) {
</a><a href="#h230-0-93" id="h230-0-93" class="i">+                val layoutParams = view.layoutParams as? FrameLayout.LayoutParams ?: return@subscribe
</a><a href="#h230-0-94" id="h230-0-94" class="i">+                if (layoutParams.width == -1 &amp;&amp;
</a><a href="#h230-0-95" id="h230-0-95" class="i">+                    layoutParams.height == -2 &amp;&amp;
</a><a href="#h230-0-96" id="h230-0-96" class="i">+                    view.javaClass.let { clazz -&gt;
</a><a href="#h230-0-97" id="h230-0-97" class="i">+                        clazz.methods.any { it.returnType == SpannableString::class.java} &amp;&amp;
</a><a href="#h230-0-98" id="h230-0-98" class="i">+                        clazz.constructors.any { it.parameterCount == 1 &amp;&amp; it.parameterTypes[0] == Context::class.java }
</a><a href="#h230-0-99" id="h230-0-99" class="i">+                    }
</a><a href="#h230-0-100" id="h230-0-100" class="i">+                ) {
</a><a href="#h230-0-101" id="h230-0-101" class="i">+                    hideStorySection(event)
</a><a href="#h230-0-102" id="h230-0-102" class="i">+                }
</a><a href="#h230-0-103" id="h230-0-103" class="i">+            }
</a><a href="#h230-0-104" id="h230-0-104" class="i">+
</a><a href="#h230-0-105" id="h230-0-105" class="i">+            if (hideStorySections.contains(&quot;hide_suggested&quot;) &amp;&amp; (viewId == getIdentifier(&quot;df_small_story&quot;, &quot;id&quot;))
</a><a href="#h230-0-106" id="h230-0-106" class="i">+            ) {
</a><a href="#h230-0-107" id="h230-0-107" class="i">+                hideStorySection(event)
</a><a href="#h230-0-108" id="h230-0-108" class="i">+            }
</a><a href="#h230-0-109" id="h230-0-109" class="i">+
</a><a href="#h230-0-110" id="h230-0-110" class="i">+            if (blockAds &amp;&amp; viewId == getIdentifier(&quot;df_promoted_story&quot;, &quot;id&quot;)) {
</a><a href="#h230-0-111" id="h230-0-111" class="i">+                hideStorySection(event)
</a><a href="#h230-0-112" id="h230-0-112" class="i">+            }
</a><a href="#h230-0-113" id="h230-0-113" class="i">+
</a><a href="#h230-0-114" id="h230-0-114" class="i">+            if (isImmersiveCamera) {
</a><a href="#h230-0-115" id="h230-0-115" class="i">+                if (view.id == getIdentifier(&quot;edits_container&quot;, &quot;id&quot;)) {
</a><a href="#h230-0-116" id="h230-0-116" class="i">+                    Hooker.hookObjectMethod(View::class.java, view, &quot;layout&quot;, HookStage.BEFORE) {
</a><a href="#h230-0-117" id="h230-0-117" class="i">+                        val width = it.arg(2) as Int
</a><a href="#h230-0-118" id="h230-0-118" class="i">+                        val realHeight = (width / deviceAspectRatio).toInt()
</a><a href="#h230-0-119" id="h230-0-119" class="i">+                        it.setArg(3, realHeight)
</a><a href="#h230-0-120" id="h230-0-120" class="i">+                    }
</a><a href="#h230-0-121" id="h230-0-121" class="i">+                }
</a><a href="#h230-0-122" id="h230-0-122" class="i">+                if (view.id == getIdentifier(&quot;full_screen_surface_view&quot;, &quot;id&quot;)) {
</a><a href="#h230-0-123" id="h230-0-123" class="i">+                    Hooker.hookObjectMethod(View::class.java, view, &quot;layout&quot;, HookStage.BEFORE) {
</a><a href="#h230-0-124" id="h230-0-124" class="i">+                        it.setArg(1, 1)
</a><a href="#h230-0-125" id="h230-0-125" class="i">+                        it.setArg(3, displayMetrics.heightPixels)
</a><a href="#h230-0-126" id="h230-0-126" class="i">+                    }
</a><a href="#h230-0-127" id="h230-0-127" class="i">+                }
</a><a href="#h230-0-128" id="h230-0-128" class="i">+            }
</a><a href="#h230-0-129" id="h230-0-129" class="i">+
</a><a href="#h230-0-130" id="h230-0-130" class="i">+            if (
</a><a href="#h230-0-131" id="h230-0-131" class="i">+                (viewId == chatNoteRecordButton &amp;&amp; hiddenElements.contains(&quot;hide_voice_record_button&quot;)) ||
</a><a href="#h230-0-132" id="h230-0-132" class="i">+                (viewId == getIdentifier(&quot;chat_input_bar_sticker&quot;, &quot;id&quot;) &amp;&amp; hiddenElements.contains(&quot;hide_stickers_button&quot;)) ||
</a><a href="#h230-0-133" id="h230-0-133" class="i">+                (viewId == getIdentifier(&quot;chat_input_bar_sharing_drawer_button&quot;, &quot;id&quot;) &amp;&amp; hiddenElements.contains(&quot;hide_live_location_share_button&quot;)) ||
</a><a href="#h230-0-134" id="h230-0-134" class="i">+                (viewId == callButtonsStub &amp;&amp; hiddenElements.contains(&quot;hide_chat_call_buttons&quot;))
</a><a href="#h230-0-135" id="h230-0-135" class="i">+            ) {
</a><a href="#h230-0-136" id="h230-0-136" class="i">+                view.apply {
</a><a href="#h230-0-137" id="h230-0-137" class="i">+                    view.post {
</a><a href="#h230-0-138" id="h230-0-138" class="i">+                        isEnabled = false
</a><a href="#h230-0-139" id="h230-0-139" class="i">+                        setWillNotDraw(true)
</a><a href="#h230-0-140" id="h230-0-140" class="i">+                        view.visibility = View.GONE
</a><a href="#h230-0-141" id="h230-0-141" class="i">+                    }
</a><a href="#h230-0-142" id="h230-0-142" class="i">+                    addOnLayoutChangeListener { view, _, _, _, _, _, _, _, _ -&gt;
</a><a href="#h230-0-143" id="h230-0-143" class="i">+                        view.post { view.visibility = View.GONE }
</a><a href="#h230-0-144" id="h230-0-144" class="i">+                    }
</a><a href="#h230-0-145" id="h230-0-145" class="i">+                }
</a><a href="#h230-0-146" id="h230-0-146" class="i">+            }
</a><a href="#h230-0-147" id="h230-0-147" class="i">+        }
</a><a href="#h230-0-148" id="h230-0-148" class="i">+    }
</a><a href="#h230-0-149" id="h230-0-149" class="i">+}</a><a href="#h230-0-150" id="h230-0-150" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h231" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/logger/AbstractLogger.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/logger/AbstractLogger.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/logger/AbstractLogger.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/logger/AbstractLogger.kt</a></b>
<a href="#h231-0" id="h231-0" class="h">@@ -1,22 +0,0 @@
</a><a href="#h231-0-0" id="h231-0-0" class="d">-package me.rhunk.snapenhance.core.logger
</a><a href="#h231-0-1" id="h231-0-1" class="d">-
</a><a href="#h231-0-2" id="h231-0-2" class="d">-abstract class AbstractLogger(
</a><a href="#h231-0-3" id="h231-0-3" class="d">-    logChannel: LogChannel,
</a><a href="#h231-0-4" id="h231-0-4" class="d">-) {
</a><a href="#h231-0-5" id="h231-0-5" class="d">-    private val TAG = logChannel.shortName
</a><a href="#h231-0-6" id="h231-0-6" class="d">-
</a><a href="#h231-0-7" id="h231-0-7" class="d">-
</a><a href="#h231-0-8" id="h231-0-8" class="d">-    open fun debug(message: Any?, tag: String = TAG) {}
</a><a href="#h231-0-9" id="h231-0-9" class="d">-
</a><a href="#h231-0-10" id="h231-0-10" class="d">-    open fun error(message: Any?, tag: String = TAG) {}
</a><a href="#h231-0-11" id="h231-0-11" class="d">-
</a><a href="#h231-0-12" id="h231-0-12" class="d">-    open fun error(message: Any?, throwable: Throwable, tag: String = TAG) {}
</a><a href="#h231-0-13" id="h231-0-13" class="d">-
</a><a href="#h231-0-14" id="h231-0-14" class="d">-    open fun info(message: Any?, tag: String = TAG) {}
</a><a href="#h231-0-15" id="h231-0-15" class="d">-
</a><a href="#h231-0-16" id="h231-0-16" class="d">-    open fun verbose(message: Any?, tag: String = TAG) {}
</a><a href="#h231-0-17" id="h231-0-17" class="d">-
</a><a href="#h231-0-18" id="h231-0-18" class="d">-    open fun warn(message: Any?, tag: String = TAG) {}
</a><a href="#h231-0-19" id="h231-0-19" class="d">-
</a><a href="#h231-0-20" id="h231-0-20" class="d">-    open fun assert(message: Any?, tag: String = TAG) {}
</a><a href="#h231-0-21" id="h231-0-21" class="d">-}</a><a href="#h231-0-22" id="h231-0-22" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h232" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/logger/CoreLogger.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/logger/CoreLogger.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/logger/CoreLogger.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/logger/CoreLogger.kt</a></b>
<a href="#h232-0" id="h232-0" class="h">@@ -0,0 +1,77 @@
</a><a href="#h232-0-0" id="h232-0-0" class="i">+package me.rhunk.snapenhance.core.logger
</a><a href="#h232-0-1" id="h232-0-1" class="i">+
</a><a href="#h232-0-2" id="h232-0-2" class="i">+import android.annotation.SuppressLint
</a><a href="#h232-0-3" id="h232-0-3" class="i">+import android.util.Log
</a><a href="#h232-0-4" id="h232-0-4" class="i">+import de.robv.android.xposed.XposedBridge
</a><a href="#h232-0-5" id="h232-0-5" class="i">+import me.rhunk.snapenhance.common.logger.AbstractLogger
</a><a href="#h232-0-6" id="h232-0-6" class="i">+import me.rhunk.snapenhance.common.logger.LogChannel
</a><a href="#h232-0-7" id="h232-0-7" class="i">+import me.rhunk.snapenhance.common.logger.LogLevel
</a><a href="#h232-0-8" id="h232-0-8" class="i">+import me.rhunk.snapenhance.core.bridge.BridgeClient
</a><a href="#h232-0-9" id="h232-0-9" class="i">+import me.rhunk.snapenhance.core.util.hook.HookStage
</a><a href="#h232-0-10" id="h232-0-10" class="i">+import me.rhunk.snapenhance.core.util.hook.hook
</a><a href="#h232-0-11" id="h232-0-11" class="i">+
</a><a href="#h232-0-12" id="h232-0-12" class="i">+
</a><a href="#h232-0-13" id="h232-0-13" class="i">+@SuppressLint(&quot;PrivateApi&quot;)
</a><a href="#h232-0-14" id="h232-0-14" class="i">+class CoreLogger(
</a><a href="#h232-0-15" id="h232-0-15" class="i">+    private val bridgeClient: BridgeClient
</a><a href="#h232-0-16" id="h232-0-16" class="i">+): AbstractLogger(LogChannel.CORE) {
</a><a href="#h232-0-17" id="h232-0-17" class="i">+    companion object {
</a><a href="#h232-0-18" id="h232-0-18" class="i">+        private const val TAG = &quot;SnapEnhanceCore&quot;
</a><a href="#h232-0-19" id="h232-0-19" class="i">+
</a><a href="#h232-0-20" id="h232-0-20" class="i">+        fun xposedLog(message: Any?, tag: String = TAG) {
</a><a href="#h232-0-21" id="h232-0-21" class="i">+            Log.println(Log.INFO, tag, message.toString())
</a><a href="#h232-0-22" id="h232-0-22" class="i">+            XposedBridge.log(&quot;$tag: $message&quot;)
</a><a href="#h232-0-23" id="h232-0-23" class="i">+        }
</a><a href="#h232-0-24" id="h232-0-24" class="i">+
</a><a href="#h232-0-25" id="h232-0-25" class="i">+        fun xposedLog(message: Any?, throwable: Throwable, tag: String = TAG) {
</a><a href="#h232-0-26" id="h232-0-26" class="i">+            Log.println(Log.INFO, tag, message.toString())
</a><a href="#h232-0-27" id="h232-0-27" class="i">+            XposedBridge.log(&quot;$tag: $message&quot;)
</a><a href="#h232-0-28" id="h232-0-28" class="i">+            XposedBridge.log(throwable)
</a><a href="#h232-0-29" id="h232-0-29" class="i">+        }
</a><a href="#h232-0-30" id="h232-0-30" class="i">+    }
</a><a href="#h232-0-31" id="h232-0-31" class="i">+
</a><a href="#h232-0-32" id="h232-0-32" class="i">+    private var invokeOriginalPrintLog: (Int, String, String) -&gt; Unit
</a><a href="#h232-0-33" id="h232-0-33" class="i">+
</a><a href="#h232-0-34" id="h232-0-34" class="i">+    init {
</a><a href="#h232-0-35" id="h232-0-35" class="i">+        val printLnMethod = Log::class.java.getDeclaredMethod(&quot;println&quot;, Int::class.java, String::class.java, String::class.java)
</a><a href="#h232-0-36" id="h232-0-36" class="i">+        printLnMethod.hook(HookStage.BEFORE) { param -&gt;
</a><a href="#h232-0-37" id="h232-0-37" class="i">+            val priority = param.arg(0) as Int
</a><a href="#h232-0-38" id="h232-0-38" class="i">+            val tag = param.arg(1) as String
</a><a href="#h232-0-39" id="h232-0-39" class="i">+            val message = param.arg(2) as String
</a><a href="#h232-0-40" id="h232-0-40" class="i">+            internalLog(tag, LogLevel.fromPriority(priority) ?: LogLevel.INFO, message)
</a><a href="#h232-0-41" id="h232-0-41" class="i">+        }
</a><a href="#h232-0-42" id="h232-0-42" class="i">+
</a><a href="#h232-0-43" id="h232-0-43" class="i">+        invokeOriginalPrintLog = { priority, tag, message -&gt;
</a><a href="#h232-0-44" id="h232-0-44" class="i">+            XposedBridge.invokeOriginalMethod(
</a><a href="#h232-0-45" id="h232-0-45" class="i">+                printLnMethod,
</a><a href="#h232-0-46" id="h232-0-46" class="i">+                null,
</a><a href="#h232-0-47" id="h232-0-47" class="i">+                arrayOf(priority, tag, message)
</a><a href="#h232-0-48" id="h232-0-48" class="i">+            )
</a><a href="#h232-0-49" id="h232-0-49" class="i">+        }
</a><a href="#h232-0-50" id="h232-0-50" class="i">+    }
</a><a href="#h232-0-51" id="h232-0-51" class="i">+
</a><a href="#h232-0-52" id="h232-0-52" class="i">+    private fun internalLog(tag: String, logLevel: LogLevel, message: Any?) {
</a><a href="#h232-0-53" id="h232-0-53" class="i">+        runCatching {
</a><a href="#h232-0-54" id="h232-0-54" class="i">+            bridgeClient.broadcastLog(tag, logLevel.shortName, message.toString())
</a><a href="#h232-0-55" id="h232-0-55" class="i">+        }.onFailure {
</a><a href="#h232-0-56" id="h232-0-56" class="i">+            invokeOriginalPrintLog(logLevel.priority, tag, message.toString())
</a><a href="#h232-0-57" id="h232-0-57" class="i">+        }
</a><a href="#h232-0-58" id="h232-0-58" class="i">+    }
</a><a href="#h232-0-59" id="h232-0-59" class="i">+
</a><a href="#h232-0-60" id="h232-0-60" class="i">+    override fun debug(message: Any?, tag: String) = internalLog(tag, LogLevel.DEBUG, message)
</a><a href="#h232-0-61" id="h232-0-61" class="i">+
</a><a href="#h232-0-62" id="h232-0-62" class="i">+    override fun error(message: Any?, tag: String) = internalLog(tag, LogLevel.ERROR, message)
</a><a href="#h232-0-63" id="h232-0-63" class="i">+
</a><a href="#h232-0-64" id="h232-0-64" class="i">+    override fun error(message: Any?, throwable: Throwable, tag: String) {
</a><a href="#h232-0-65" id="h232-0-65" class="i">+        internalLog(tag, LogLevel.ERROR, message)
</a><a href="#h232-0-66" id="h232-0-66" class="i">+        internalLog(tag, LogLevel.ERROR, throwable.stackTraceToString())
</a><a href="#h232-0-67" id="h232-0-67" class="i">+    }
</a><a href="#h232-0-68" id="h232-0-68" class="i">+
</a><a href="#h232-0-69" id="h232-0-69" class="i">+    override fun info(message: Any?, tag: String) = internalLog(tag, LogLevel.INFO, message)
</a><a href="#h232-0-70" id="h232-0-70" class="i">+
</a><a href="#h232-0-71" id="h232-0-71" class="i">+    override fun verbose(message: Any?, tag: String) = internalLog(tag, LogLevel.VERBOSE, message)
</a><a href="#h232-0-72" id="h232-0-72" class="i">+
</a><a href="#h232-0-73" id="h232-0-73" class="i">+    override fun warn(message: Any?, tag: String) = internalLog(tag, LogLevel.WARN, message)
</a><a href="#h232-0-74" id="h232-0-74" class="i">+
</a><a href="#h232-0-75" id="h232-0-75" class="i">+    override fun assert(message: Any?, tag: String) = internalLog(tag, LogLevel.ASSERT, message)
</a><a href="#h232-0-76" id="h232-0-76" class="i">+}</a><a href="#h232-0-77" id="h232-0-77" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h233" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/logger/LogChannel.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/logger/LogChannel.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/logger/LogChannel.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/logger/LogChannel.kt</a></b>
<a href="#h233-0" id="h233-0" class="h">@@ -1,17 +0,0 @@
</a><a href="#h233-0-0" id="h233-0-0" class="d">-package me.rhunk.snapenhance.core.logger
</a><a href="#h233-0-1" id="h233-0-1" class="d">-
</a><a href="#h233-0-2" id="h233-0-2" class="d">-enum class LogChannel(
</a><a href="#h233-0-3" id="h233-0-3" class="d">-    val channel: String,
</a><a href="#h233-0-4" id="h233-0-4" class="d">-    val shortName: String
</a><a href="#h233-0-5" id="h233-0-5" class="d">-) {
</a><a href="#h233-0-6" id="h233-0-6" class="d">-    CORE(&quot;SnapEnhanceCore&quot;, &quot;core&quot;),
</a><a href="#h233-0-7" id="h233-0-7" class="d">-    NATIVE(&quot;SnapEnhanceNative&quot;, &quot;native&quot;),
</a><a href="#h233-0-8" id="h233-0-8" class="d">-    MANAGER(&quot;SnapEnhanceManager&quot;, &quot;manager&quot;),
</a><a href="#h233-0-9" id="h233-0-9" class="d">-    XPOSED(&quot;LSPosed-Bridge&quot;, &quot;xposed&quot;);
</a><a href="#h233-0-10" id="h233-0-10" class="d">-
</a><a href="#h233-0-11" id="h233-0-11" class="d">-    companion object {
</a><a href="#h233-0-12" id="h233-0-12" class="d">-        fun fromChannel(channel: String): LogChannel? {
</a><a href="#h233-0-13" id="h233-0-13" class="d">-            return entries.find { it.channel == channel }
</a><a href="#h233-0-14" id="h233-0-14" class="d">-        }
</a><a href="#h233-0-15" id="h233-0-15" class="d">-    }
</a><a href="#h233-0-16" id="h233-0-16" class="d">-}</a><a href="#h233-0-17" id="h233-0-17" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h234" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/logger/LogLevel.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/logger/LogLevel.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/logger/LogLevel.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/logger/LogLevel.kt</a></b>
<a href="#h234-0" id="h234-0" class="h">@@ -1,30 +0,0 @@
</a><a href="#h234-0-0" id="h234-0-0" class="d">-package me.rhunk.snapenhance.core.logger
</a><a href="#h234-0-1" id="h234-0-1" class="d">-
</a><a href="#h234-0-2" id="h234-0-2" class="d">-import android.util.Log
</a><a href="#h234-0-3" id="h234-0-3" class="d">-
</a><a href="#h234-0-4" id="h234-0-4" class="d">-enum class LogLevel(
</a><a href="#h234-0-5" id="h234-0-5" class="d">-    val letter: String,
</a><a href="#h234-0-6" id="h234-0-6" class="d">-    val shortName: String,
</a><a href="#h234-0-7" id="h234-0-7" class="d">-    val priority: Int = Log.INFO
</a><a href="#h234-0-8" id="h234-0-8" class="d">-) {
</a><a href="#h234-0-9" id="h234-0-9" class="d">-    VERBOSE(&quot;V&quot;, &quot;verbose&quot;, Log.VERBOSE),
</a><a href="#h234-0-10" id="h234-0-10" class="d">-    DEBUG(&quot;D&quot;, &quot;debug&quot;, Log.DEBUG),
</a><a href="#h234-0-11" id="h234-0-11" class="d">-    INFO(&quot;I&quot;, &quot;info&quot;, Log.INFO),
</a><a href="#h234-0-12" id="h234-0-12" class="d">-    WARN(&quot;W&quot;, &quot;warn&quot;, Log.WARN),
</a><a href="#h234-0-13" id="h234-0-13" class="d">-    ERROR(&quot;E&quot;, &quot;error&quot;, Log.ERROR),
</a><a href="#h234-0-14" id="h234-0-14" class="d">-    ASSERT(&quot;A&quot;, &quot;assert&quot;, Log.ASSERT);
</a><a href="#h234-0-15" id="h234-0-15" class="d">-
</a><a href="#h234-0-16" id="h234-0-16" class="d">-    companion object {
</a><a href="#h234-0-17" id="h234-0-17" class="d">-        fun fromLetter(letter: String): LogLevel? {
</a><a href="#h234-0-18" id="h234-0-18" class="d">-            return entries.find { it.letter == letter }
</a><a href="#h234-0-19" id="h234-0-19" class="d">-        }
</a><a href="#h234-0-20" id="h234-0-20" class="d">-
</a><a href="#h234-0-21" id="h234-0-21" class="d">-        fun fromShortName(shortName: String): LogLevel? {
</a><a href="#h234-0-22" id="h234-0-22" class="d">-            return entries.find { it.shortName == shortName }
</a><a href="#h234-0-23" id="h234-0-23" class="d">-        }
</a><a href="#h234-0-24" id="h234-0-24" class="d">-
</a><a href="#h234-0-25" id="h234-0-25" class="d">-        fun fromPriority(priority: Int): LogLevel? {
</a><a href="#h234-0-26" id="h234-0-26" class="d">-            return entries.find { it.priority == priority }
</a><a href="#h234-0-27" id="h234-0-27" class="d">-        }
</a><a href="#h234-0-28" id="h234-0-28" class="d">-    }
</a><a href="#h234-0-29" id="h234-0-29" class="d">-}</a><a href="#h234-0-30" id="h234-0-30" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h235" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/manager/Manager.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/manager/Manager.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/manager/Manager.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/manager/Manager.kt</a></b>
<a href="#h235-0" id="h235-0" class="h">@@ -0,0 +1,6 @@
</a><a href="#h235-0-0" id="h235-0-0" class="i">+package me.rhunk.snapenhance.core.manager
</a><a href="#h235-0-1" id="h235-0-1" class="i">+
</a><a href="#h235-0-2" id="h235-0-2" class="i">+interface Manager {
</a><a href="#h235-0-3" id="h235-0-3" class="i">+    fun init() {}
</a><a href="#h235-0-4" id="h235-0-4" class="i">+    fun onActivityCreate() {}
</a><a href="#h235-0-5" id="h235-0-5" class="i">+}</a><a href="#h235-0-6" id="h235-0-6" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h236" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/manager/impl/ActionManager.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/manager/impl/ActionManager.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/manager/impl/ActionManager.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/manager/impl/ActionManager.kt</a></b>
<a href="#h236-0" id="h236-0" class="h">@@ -0,0 +1,43 @@
</a><a href="#h236-0-0" id="h236-0-0" class="i">+package me.rhunk.snapenhance.core.manager.impl
</a><a href="#h236-0-1" id="h236-0-1" class="i">+
</a><a href="#h236-0-2" id="h236-0-2" class="i">+import android.content.Intent
</a><a href="#h236-0-3" id="h236-0-3" class="i">+import me.rhunk.snapenhance.common.action.EnumAction
</a><a href="#h236-0-4" id="h236-0-4" class="i">+import me.rhunk.snapenhance.core.ModContext
</a><a href="#h236-0-5" id="h236-0-5" class="i">+import me.rhunk.snapenhance.core.action.impl.CleanCache
</a><a href="#h236-0-6" id="h236-0-6" class="i">+import me.rhunk.snapenhance.core.action.impl.ExportChatMessages
</a><a href="#h236-0-7" id="h236-0-7" class="i">+import me.rhunk.snapenhance.core.action.impl.OpenMap
</a><a href="#h236-0-8" id="h236-0-8" class="i">+import me.rhunk.snapenhance.core.manager.Manager
</a><a href="#h236-0-9" id="h236-0-9" class="i">+
</a><a href="#h236-0-10" id="h236-0-10" class="i">+class ActionManager(
</a><a href="#h236-0-11" id="h236-0-11" class="i">+    private val modContext: ModContext,
</a><a href="#h236-0-12" id="h236-0-12" class="i">+) : Manager {
</a><a href="#h236-0-13" id="h236-0-13" class="i">+
</a><a href="#h236-0-14" id="h236-0-14" class="i">+    private val actions by lazy {
</a><a href="#h236-0-15" id="h236-0-15" class="i">+        mapOf(
</a><a href="#h236-0-16" id="h236-0-16" class="i">+            EnumAction.CLEAN_CACHE to CleanCache::class,
</a><a href="#h236-0-17" id="h236-0-17" class="i">+            EnumAction.EXPORT_CHAT_MESSAGES to ExportChatMessages::class,
</a><a href="#h236-0-18" id="h236-0-18" class="i">+            EnumAction.OPEN_MAP to OpenMap::class,
</a><a href="#h236-0-19" id="h236-0-19" class="i">+        ).map {
</a><a href="#h236-0-20" id="h236-0-20" class="i">+            it.key to it.value.java.getConstructor().newInstance().apply {
</a><a href="#h236-0-21" id="h236-0-21" class="i">+                this.context = modContext
</a><a href="#h236-0-22" id="h236-0-22" class="i">+            }
</a><a href="#h236-0-23" id="h236-0-23" class="i">+        }.toMap().toMutableMap()
</a><a href="#h236-0-24" id="h236-0-24" class="i">+    }
</a><a href="#h236-0-25" id="h236-0-25" class="i">+
</a><a href="#h236-0-26" id="h236-0-26" class="i">+    override fun init() {
</a><a href="#h236-0-27" id="h236-0-27" class="i">+    }
</a><a href="#h236-0-28" id="h236-0-28" class="i">+
</a><a href="#h236-0-29" id="h236-0-29" class="i">+    fun onNewIntent(intent: Intent?) {
</a><a href="#h236-0-30" id="h236-0-30" class="i">+        val action = intent?.getStringExtra(EnumAction.ACTION_PARAMETER) ?: return
</a><a href="#h236-0-31" id="h236-0-31" class="i">+        execute(EnumAction.entries.find { it.key == action } ?: return)
</a><a href="#h236-0-32" id="h236-0-32" class="i">+        intent.removeExtra(EnumAction.ACTION_PARAMETER)
</a><a href="#h236-0-33" id="h236-0-33" class="i">+    }
</a><a href="#h236-0-34" id="h236-0-34" class="i">+
</a><a href="#h236-0-35" id="h236-0-35" class="i">+    fun execute(enumAction: EnumAction) {
</a><a href="#h236-0-36" id="h236-0-36" class="i">+        val action = actions[enumAction] ?: return
</a><a href="#h236-0-37" id="h236-0-37" class="i">+        action.run()
</a><a href="#h236-0-38" id="h236-0-38" class="i">+        if (enumAction.exitOnFinish) {
</a><a href="#h236-0-39" id="h236-0-39" class="i">+            modContext.forceCloseApp()
</a><a href="#h236-0-40" id="h236-0-40" class="i">+        }
</a><a href="#h236-0-41" id="h236-0-41" class="i">+    }
</a><a href="#h236-0-42" id="h236-0-42" class="i">+}</a><a href="#h236-0-43" id="h236-0-43" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h237" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/manager/impl/FeatureManager.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/manager/impl/FeatureManager.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/manager/impl/FeatureManager.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/manager/impl/FeatureManager.kt</a></b>
<a href="#h237-0" id="h237-0" class="h">@@ -0,0 +1,164 @@
</a><a href="#h237-0-0" id="h237-0-0" class="i">+package me.rhunk.snapenhance.core.manager.impl
</a><a href="#h237-0-1" id="h237-0-1" class="i">+
</a><a href="#h237-0-2" id="h237-0-2" class="i">+import kotlinx.coroutines.Dispatchers
</a><a href="#h237-0-3" id="h237-0-3" class="i">+import kotlinx.coroutines.launch
</a><a href="#h237-0-4" id="h237-0-4" class="i">+import kotlinx.coroutines.runBlocking
</a><a href="#h237-0-5" id="h237-0-5" class="i">+import me.rhunk.snapenhance.core.ModContext
</a><a href="#h237-0-6" id="h237-0-6" class="i">+import me.rhunk.snapenhance.core.features.Feature
</a><a href="#h237-0-7" id="h237-0-7" class="i">+import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a><a href="#h237-0-8" id="h237-0-8" class="i">+import me.rhunk.snapenhance.core.features.MessagingRuleFeature
</a><a href="#h237-0-9" id="h237-0-9" class="i">+import me.rhunk.snapenhance.core.features.impl.ConfigurationOverride
</a><a href="#h237-0-10" id="h237-0-10" class="i">+import me.rhunk.snapenhance.core.features.impl.ScopeSync
</a><a href="#h237-0-11" id="h237-0-11" class="i">+import me.rhunk.snapenhance.core.features.impl.downloader.MediaDownloader
</a><a href="#h237-0-12" id="h237-0-12" class="i">+import me.rhunk.snapenhance.core.features.impl.downloader.ProfilePictureDownloader
</a><a href="#h237-0-13" id="h237-0-13" class="i">+import me.rhunk.snapenhance.core.features.impl.experiments.*
</a><a href="#h237-0-14" id="h237-0-14" class="i">+import me.rhunk.snapenhance.core.features.impl.global.*
</a><a href="#h237-0-15" id="h237-0-15" class="i">+import me.rhunk.snapenhance.core.features.impl.messaging.*
</a><a href="#h237-0-16" id="h237-0-16" class="i">+import me.rhunk.snapenhance.core.features.impl.spying.MessageLogger
</a><a href="#h237-0-17" id="h237-0-17" class="i">+import me.rhunk.snapenhance.core.features.impl.spying.SnapToChatMedia
</a><a href="#h237-0-18" id="h237-0-18" class="i">+import me.rhunk.snapenhance.core.features.impl.spying.StealthMode
</a><a href="#h237-0-19" id="h237-0-19" class="i">+import me.rhunk.snapenhance.core.features.impl.tweaks.CameraTweaks
</a><a href="#h237-0-20" id="h237-0-20" class="i">+import me.rhunk.snapenhance.core.features.impl.ui.*
</a><a href="#h237-0-21" id="h237-0-21" class="i">+import me.rhunk.snapenhance.core.logger.CoreLogger
</a><a href="#h237-0-22" id="h237-0-22" class="i">+import me.rhunk.snapenhance.core.manager.Manager
</a><a href="#h237-0-23" id="h237-0-23" class="i">+import me.rhunk.snapenhance.core.ui.menu.impl.MenuViewInjector
</a><a href="#h237-0-24" id="h237-0-24" class="i">+import kotlin.reflect.KClass
</a><a href="#h237-0-25" id="h237-0-25" class="i">+import kotlin.system.measureTimeMillis
</a><a href="#h237-0-26" id="h237-0-26" class="i">+
</a><a href="#h237-0-27" id="h237-0-27" class="i">+class FeatureManager(
</a><a href="#h237-0-28" id="h237-0-28" class="i">+    private val context: ModContext
</a><a href="#h237-0-29" id="h237-0-29" class="i">+) : Manager {
</a><a href="#h237-0-30" id="h237-0-30" class="i">+    private val features = mutableListOf&lt;Feature&gt;()
</a><a href="#h237-0-31" id="h237-0-31" class="i">+
</a><a href="#h237-0-32" id="h237-0-32" class="i">+    private fun register(vararg featureClasses: KClass&lt;out Feature&gt;) {
</a><a href="#h237-0-33" id="h237-0-33" class="i">+        runBlocking {
</a><a href="#h237-0-34" id="h237-0-34" class="i">+            featureClasses.forEach { clazz -&gt;
</a><a href="#h237-0-35" id="h237-0-35" class="i">+                launch(Dispatchers.IO) {
</a><a href="#h237-0-36" id="h237-0-36" class="i">+                    runCatching {
</a><a href="#h237-0-37" id="h237-0-37" class="i">+                        clazz.java.constructors.first().newInstance()
</a><a href="#h237-0-38" id="h237-0-38" class="i">+                            .let { it as Feature }
</a><a href="#h237-0-39" id="h237-0-39" class="i">+                            .also {
</a><a href="#h237-0-40" id="h237-0-40" class="i">+                                it.context = context
</a><a href="#h237-0-41" id="h237-0-41" class="i">+                                synchronized(features) {
</a><a href="#h237-0-42" id="h237-0-42" class="i">+                                    features.add(it)
</a><a href="#h237-0-43" id="h237-0-43" class="i">+                                }
</a><a href="#h237-0-44" id="h237-0-44" class="i">+                            }
</a><a href="#h237-0-45" id="h237-0-45" class="i">+                    }.onFailure {
</a><a href="#h237-0-46" id="h237-0-46" class="i">+                        CoreLogger.xposedLog(&quot;Failed to register feature ${clazz.simpleName}&quot;, it)
</a><a href="#h237-0-47" id="h237-0-47" class="i">+                    }
</a><a href="#h237-0-48" id="h237-0-48" class="i">+                }
</a><a href="#h237-0-49" id="h237-0-49" class="i">+            }
</a><a href="#h237-0-50" id="h237-0-50" class="i">+        }
</a><a href="#h237-0-51" id="h237-0-51" class="i">+    }
</a><a href="#h237-0-52" id="h237-0-52" class="i">+
</a><a href="#h237-0-53" id="h237-0-53" class="i">+    @Suppress(&quot;UNCHECKED_CAST&quot;)
</a><a href="#h237-0-54" id="h237-0-54" class="i">+    fun &lt;T : Feature&gt; get(featureClass: KClass&lt;T&gt;): T? {
</a><a href="#h237-0-55" id="h237-0-55" class="i">+        return features.find { it::class == featureClass } as? T
</a><a href="#h237-0-56" id="h237-0-56" class="i">+    }
</a><a href="#h237-0-57" id="h237-0-57" class="i">+
</a><a href="#h237-0-58" id="h237-0-58" class="i">+    fun getRuleFeatures() = features.filterIsInstance&lt;MessagingRuleFeature&gt;()
</a><a href="#h237-0-59" id="h237-0-59" class="i">+
</a><a href="#h237-0-60" id="h237-0-60" class="i">+    override fun init() {
</a><a href="#h237-0-61" id="h237-0-61" class="i">+        register(
</a><a href="#h237-0-62" id="h237-0-62" class="i">+            EndToEndEncryption::class,
</a><a href="#h237-0-63" id="h237-0-63" class="i">+            ScopeSync::class,
</a><a href="#h237-0-64" id="h237-0-64" class="i">+            Messaging::class,
</a><a href="#h237-0-65" id="h237-0-65" class="i">+            MediaDownloader::class,
</a><a href="#h237-0-66" id="h237-0-66" class="i">+            StealthMode::class,
</a><a href="#h237-0-67" id="h237-0-67" class="i">+            MenuViewInjector::class,
</a><a href="#h237-0-68" id="h237-0-68" class="i">+            PreventReadReceipts::class,
</a><a href="#h237-0-69" id="h237-0-69" class="i">+            AnonymousStoryViewing::class,
</a><a href="#h237-0-70" id="h237-0-70" class="i">+            MessageLogger::class,
</a><a href="#h237-0-71" id="h237-0-71" class="i">+            SnapchatPlus::class,
</a><a href="#h237-0-72" id="h237-0-72" class="i">+            DisableMetrics::class,
</a><a href="#h237-0-73" id="h237-0-73" class="i">+            PreventMessageSending::class,
</a><a href="#h237-0-74" id="h237-0-74" class="i">+            Notifications::class,
</a><a href="#h237-0-75" id="h237-0-75" class="i">+            AutoSave::class,
</a><a href="#h237-0-76" id="h237-0-76" class="i">+            UITweaks::class,
</a><a href="#h237-0-77" id="h237-0-77" class="i">+            ConfigurationOverride::class,
</a><a href="#h237-0-78" id="h237-0-78" class="i">+            SendOverride::class,
</a><a href="#h237-0-79" id="h237-0-79" class="i">+            UnlimitedSnapViewTime::class,
</a><a href="#h237-0-80" id="h237-0-80" class="i">+            BypassVideoLengthRestriction::class,
</a><a href="#h237-0-81" id="h237-0-81" class="i">+            MediaQualityLevelOverride::class,
</a><a href="#h237-0-82" id="h237-0-82" class="i">+            MeoPasscodeBypass::class,
</a><a href="#h237-0-83" id="h237-0-83" class="i">+            AppPasscode::class,
</a><a href="#h237-0-84" id="h237-0-84" class="i">+            LocationSpoofer::class,
</a><a href="#h237-0-85" id="h237-0-85" class="i">+            CameraTweaks::class,
</a><a href="#h237-0-86" id="h237-0-86" class="i">+            InfiniteStoryBoost::class,
</a><a href="#h237-0-87" id="h237-0-87" class="i">+            AmoledDarkMode::class,
</a><a href="#h237-0-88" id="h237-0-88" class="i">+            PinConversations::class,
</a><a href="#h237-0-89" id="h237-0-89" class="i">+            UnlimitedMultiSnap::class,
</a><a href="#h237-0-90" id="h237-0-90" class="i">+            DeviceSpooferHook::class,
</a><a href="#h237-0-91" id="h237-0-91" class="i">+            ClientBootstrapOverride::class,
</a><a href="#h237-0-92" id="h237-0-92" class="i">+            GooglePlayServicesDialogs::class,
</a><a href="#h237-0-93" id="h237-0-93" class="i">+            NoFriendScoreDelay::class,
</a><a href="#h237-0-94" id="h237-0-94" class="i">+            ProfilePictureDownloader::class,
</a><a href="#h237-0-95" id="h237-0-95" class="i">+            AddFriendSourceSpoof::class,
</a><a href="#h237-0-96" id="h237-0-96" class="i">+            DisableReplayInFF::class,
</a><a href="#h237-0-97" id="h237-0-97" class="i">+            OldBitmojiSelfie::class,
</a><a href="#h237-0-98" id="h237-0-98" class="i">+            SnapToChatMedia::class,
</a><a href="#h237-0-99" id="h237-0-99" class="i">+            FriendFeedMessagePreview::class,
</a><a href="#h237-0-100" id="h237-0-100" class="i">+            HideStreakRestore::class,
</a><a href="#h237-0-101" id="h237-0-101" class="i">+        )
</a><a href="#h237-0-102" id="h237-0-102" class="i">+
</a><a href="#h237-0-103" id="h237-0-103" class="i">+        initializeFeatures()
</a><a href="#h237-0-104" id="h237-0-104" class="i">+    }
</a><a href="#h237-0-105" id="h237-0-105" class="i">+
</a><a href="#h237-0-106" id="h237-0-106" class="i">+    private fun initFeatures(
</a><a href="#h237-0-107" id="h237-0-107" class="i">+        syncParam: Int,
</a><a href="#h237-0-108" id="h237-0-108" class="i">+        asyncParam: Int,
</a><a href="#h237-0-109" id="h237-0-109" class="i">+        syncAction: (Feature) -&gt; Unit,
</a><a href="#h237-0-110" id="h237-0-110" class="i">+        asyncAction: (Feature) -&gt; Unit
</a><a href="#h237-0-111" id="h237-0-111" class="i">+    ) {
</a><a href="#h237-0-112" id="h237-0-112" class="i">+        fun tryInit(feature: Feature, block: () -&gt; Unit) {
</a><a href="#h237-0-113" id="h237-0-113" class="i">+            runCatching {
</a><a href="#h237-0-114" id="h237-0-114" class="i">+                block()
</a><a href="#h237-0-115" id="h237-0-115" class="i">+            }.onFailure {
</a><a href="#h237-0-116" id="h237-0-116" class="i">+                context.log.error(&quot;Failed to init feature ${feature.featureKey}&quot;, it)
</a><a href="#h237-0-117" id="h237-0-117" class="i">+                context.longToast(&quot;Failed to init feature ${feature.featureKey}! Check logcat for more details.&quot;)
</a><a href="#h237-0-118" id="h237-0-118" class="i">+            }
</a><a href="#h237-0-119" id="h237-0-119" class="i">+        }
</a><a href="#h237-0-120" id="h237-0-120" class="i">+
</a><a href="#h237-0-121" id="h237-0-121" class="i">+        features.toList().forEach { feature -&gt;
</a><a href="#h237-0-122" id="h237-0-122" class="i">+            if (feature.loadParams and syncParam != 0) {
</a><a href="#h237-0-123" id="h237-0-123" class="i">+                tryInit(feature) {
</a><a href="#h237-0-124" id="h237-0-124" class="i">+                    syncAction(feature)
</a><a href="#h237-0-125" id="h237-0-125" class="i">+                }
</a><a href="#h237-0-126" id="h237-0-126" class="i">+            }
</a><a href="#h237-0-127" id="h237-0-127" class="i">+            if (feature.loadParams and asyncParam != 0) {
</a><a href="#h237-0-128" id="h237-0-128" class="i">+                context.coroutineScope.launch {
</a><a href="#h237-0-129" id="h237-0-129" class="i">+                    tryInit(feature) {
</a><a href="#h237-0-130" id="h237-0-130" class="i">+                        asyncAction(feature)
</a><a href="#h237-0-131" id="h237-0-131" class="i">+                    }
</a><a href="#h237-0-132" id="h237-0-132" class="i">+                }
</a><a href="#h237-0-133" id="h237-0-133" class="i">+            }
</a><a href="#h237-0-134" id="h237-0-134" class="i">+        }
</a><a href="#h237-0-135" id="h237-0-135" class="i">+    }
</a><a href="#h237-0-136" id="h237-0-136" class="i">+
</a><a href="#h237-0-137" id="h237-0-137" class="i">+    private fun initializeFeatures() {
</a><a href="#h237-0-138" id="h237-0-138" class="i">+        //TODO: async called when all features are initiated ?
</a><a href="#h237-0-139" id="h237-0-139" class="i">+        measureTimeMillis {
</a><a href="#h237-0-140" id="h237-0-140" class="i">+            initFeatures(
</a><a href="#h237-0-141" id="h237-0-141" class="i">+                FeatureLoadParams.INIT_SYNC,
</a><a href="#h237-0-142" id="h237-0-142" class="i">+                FeatureLoadParams.INIT_ASYNC,
</a><a href="#h237-0-143" id="h237-0-143" class="i">+                Feature::init,
</a><a href="#h237-0-144" id="h237-0-144" class="i">+                Feature::asyncInit
</a><a href="#h237-0-145" id="h237-0-145" class="i">+            )
</a><a href="#h237-0-146" id="h237-0-146" class="i">+        }.also {
</a><a href="#h237-0-147" id="h237-0-147" class="i">+            context.log.verbose(&quot;feature manager init took $it ms&quot;)
</a><a href="#h237-0-148" id="h237-0-148" class="i">+        }
</a><a href="#h237-0-149" id="h237-0-149" class="i">+    }
</a><a href="#h237-0-150" id="h237-0-150" class="i">+
</a><a href="#h237-0-151" id="h237-0-151" class="i">+    override fun onActivityCreate() {
</a><a href="#h237-0-152" id="h237-0-152" class="i">+        measureTimeMillis {
</a><a href="#h237-0-153" id="h237-0-153" class="i">+            initFeatures(
</a><a href="#h237-0-154" id="h237-0-154" class="i">+                FeatureLoadParams.ACTIVITY_CREATE_SYNC,
</a><a href="#h237-0-155" id="h237-0-155" class="i">+                FeatureLoadParams.ACTIVITY_CREATE_ASYNC,
</a><a href="#h237-0-156" id="h237-0-156" class="i">+                Feature::onActivityCreate,
</a><a href="#h237-0-157" id="h237-0-157" class="i">+                Feature::asyncOnActivityCreate
</a><a href="#h237-0-158" id="h237-0-158" class="i">+            )
</a><a href="#h237-0-159" id="h237-0-159" class="i">+        }.also {
</a><a href="#h237-0-160" id="h237-0-160" class="i">+            context.log.verbose(&quot;feature manager onActivityCreate took $it ms&quot;)
</a><a href="#h237-0-161" id="h237-0-161" class="i">+        }
</a><a href="#h237-0-162" id="h237-0-162" class="i">+    }
</a><a href="#h237-0-163" id="h237-0-163" class="i">+}</a><a href="#h237-0-164" id="h237-0-164" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h238" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/messaging/MessageExporter.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/messaging/MessageExporter.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/messaging/MessageExporter.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/messaging/MessageExporter.kt</a></b>
<a href="#h238-0" id="h238-0" class="h">@@ -0,0 +1,325 @@
</a><a href="#h238-0-0" id="h238-0-0" class="i">+package me.rhunk.snapenhance.core.messaging
</a><a href="#h238-0-1" id="h238-0-1" class="i">+
</a><a href="#h238-0-2" id="h238-0-2" class="i">+import android.os.Environment
</a><a href="#h238-0-3" id="h238-0-3" class="i">+import android.util.Base64InputStream
</a><a href="#h238-0-4" id="h238-0-4" class="i">+import com.google.gson.JsonArray
</a><a href="#h238-0-5" id="h238-0-5" class="i">+import com.google.gson.JsonNull
</a><a href="#h238-0-6" id="h238-0-6" class="i">+import com.google.gson.JsonObject
</a><a href="#h238-0-7" id="h238-0-7" class="i">+import de.robv.android.xposed.XposedHelpers
</a><a href="#h238-0-8" id="h238-0-8" class="i">+import kotlinx.coroutines.Dispatchers
</a><a href="#h238-0-9" id="h238-0-9" class="i">+import kotlinx.coroutines.withContext
</a><a href="#h238-0-10" id="h238-0-10" class="i">+import me.rhunk.snapenhance.common.BuildConfig
</a><a href="#h238-0-11" id="h238-0-11" class="i">+import me.rhunk.snapenhance.common.data.ContentType
</a><a href="#h238-0-12" id="h238-0-12" class="i">+import me.rhunk.snapenhance.common.data.FileType
</a><a href="#h238-0-13" id="h238-0-13" class="i">+import me.rhunk.snapenhance.common.database.impl.FriendFeedEntry
</a><a href="#h238-0-14" id="h238-0-14" class="i">+import me.rhunk.snapenhance.common.database.impl.FriendInfo
</a><a href="#h238-0-15" id="h238-0-15" class="i">+import me.rhunk.snapenhance.common.util.protobuf.ProtoReader
</a><a href="#h238-0-16" id="h238-0-16" class="i">+import me.rhunk.snapenhance.common.util.snap.MediaDownloaderHelper
</a><a href="#h238-0-17" id="h238-0-17" class="i">+import me.rhunk.snapenhance.common.util.snap.RemoteMediaResolver
</a><a href="#h238-0-18" id="h238-0-18" class="i">+import me.rhunk.snapenhance.core.ModContext
</a><a href="#h238-0-19" id="h238-0-19" class="i">+import me.rhunk.snapenhance.core.features.impl.downloader.decoder.AttachmentType
</a><a href="#h238-0-20" id="h238-0-20" class="i">+import me.rhunk.snapenhance.core.features.impl.downloader.decoder.MessageDecoder
</a><a href="#h238-0-21" id="h238-0-21" class="i">+import me.rhunk.snapenhance.core.wrapper.impl.Message
</a><a href="#h238-0-22" id="h238-0-22" class="i">+import me.rhunk.snapenhance.core.wrapper.impl.SnapUUID
</a><a href="#h238-0-23" id="h238-0-23" class="i">+import java.io.BufferedInputStream
</a><a href="#h238-0-24" id="h238-0-24" class="i">+import java.io.File
</a><a href="#h238-0-25" id="h238-0-25" class="i">+import java.io.FileOutputStream
</a><a href="#h238-0-26" id="h238-0-26" class="i">+import java.io.InputStream
</a><a href="#h238-0-27" id="h238-0-27" class="i">+import java.io.OutputStream
</a><a href="#h238-0-28" id="h238-0-28" class="i">+import java.text.SimpleDateFormat
</a><a href="#h238-0-29" id="h238-0-29" class="i">+import java.util.Collections
</a><a href="#h238-0-30" id="h238-0-30" class="i">+import java.util.Date
</a><a href="#h238-0-31" id="h238-0-31" class="i">+import java.util.Locale
</a><a href="#h238-0-32" id="h238-0-32" class="i">+import java.util.concurrent.Executors
</a><a href="#h238-0-33" id="h238-0-33" class="i">+import java.util.concurrent.TimeUnit
</a><a href="#h238-0-34" id="h238-0-34" class="i">+import java.util.zip.Deflater
</a><a href="#h238-0-35" id="h238-0-35" class="i">+import java.util.zip.DeflaterInputStream
</a><a href="#h238-0-36" id="h238-0-36" class="i">+import java.util.zip.ZipFile
</a><a href="#h238-0-37" id="h238-0-37" class="i">+import kotlin.io.encoding.Base64
</a><a href="#h238-0-38" id="h238-0-38" class="i">+import kotlin.io.encoding.ExperimentalEncodingApi
</a><a href="#h238-0-39" id="h238-0-39" class="i">+
</a><a href="#h238-0-40" id="h238-0-40" class="i">+
</a><a href="#h238-0-41" id="h238-0-41" class="i">+enum class ExportFormat(
</a><a href="#h238-0-42" id="h238-0-42" class="i">+    val extension: String,
</a><a href="#h238-0-43" id="h238-0-43" class="i">+){
</a><a href="#h238-0-44" id="h238-0-44" class="i">+    JSON(&quot;json&quot;),
</a><a href="#h238-0-45" id="h238-0-45" class="i">+    TEXT(&quot;txt&quot;),
</a><a href="#h238-0-46" id="h238-0-46" class="i">+    HTML(&quot;html&quot;);
</a><a href="#h238-0-47" id="h238-0-47" class="i">+}
</a><a href="#h238-0-48" id="h238-0-48" class="i">+
</a><a href="#h238-0-49" id="h238-0-49" class="i">+@OptIn(ExperimentalEncodingApi::class)
</a><a href="#h238-0-50" id="h238-0-50" class="i">+class MessageExporter(
</a><a href="#h238-0-51" id="h238-0-51" class="i">+    private val context: ModContext,
</a><a href="#h238-0-52" id="h238-0-52" class="i">+    private val outputFile: File,
</a><a href="#h238-0-53" id="h238-0-53" class="i">+    private val friendFeedEntry: FriendFeedEntry,
</a><a href="#h238-0-54" id="h238-0-54" class="i">+    private val mediaToDownload: List&lt;ContentType&gt;? = null,
</a><a href="#h238-0-55" id="h238-0-55" class="i">+    private val printLog: (String) -&gt; Unit = {},
</a><a href="#h238-0-56" id="h238-0-56" class="i">+) {
</a><a href="#h238-0-57" id="h238-0-57" class="i">+    private lateinit var conversationParticipants: Map&lt;String, FriendInfo&gt;
</a><a href="#h238-0-58" id="h238-0-58" class="i">+    private lateinit var messages: List&lt;Message&gt;
</a><a href="#h238-0-59" id="h238-0-59" class="i">+
</a><a href="#h238-0-60" id="h238-0-60" class="i">+    fun readMessages(messages: List&lt;Message&gt;) {
</a><a href="#h238-0-61" id="h238-0-61" class="i">+        conversationParticipants =
</a><a href="#h238-0-62" id="h238-0-62" class="i">+            context.database.getConversationParticipants(friendFeedEntry.key!!)
</a><a href="#h238-0-63" id="h238-0-63" class="i">+                ?.mapNotNull {
</a><a href="#h238-0-64" id="h238-0-64" class="i">+                    context.database.getFriendInfo(it)
</a><a href="#h238-0-65" id="h238-0-65" class="i">+                }?.associateBy { it.userId!! } ?: emptyMap()
</a><a href="#h238-0-66" id="h238-0-66" class="i">+
</a><a href="#h238-0-67" id="h238-0-67" class="i">+        if (conversationParticipants.isEmpty())
</a><a href="#h238-0-68" id="h238-0-68" class="i">+            throw Throwable(&quot;Failed to get conversation participants for ${friendFeedEntry.key}&quot;)
</a><a href="#h238-0-69" id="h238-0-69" class="i">+
</a><a href="#h238-0-70" id="h238-0-70" class="i">+        this.messages = messages.sortedBy { it.orderKey }
</a><a href="#h238-0-71" id="h238-0-71" class="i">+    }
</a><a href="#h238-0-72" id="h238-0-72" class="i">+
</a><a href="#h238-0-73" id="h238-0-73" class="i">+    private fun serializeMessageContent(message: Message): String? {
</a><a href="#h238-0-74" id="h238-0-74" class="i">+        return if (message.messageContent.contentType == ContentType.CHAT) {
</a><a href="#h238-0-75" id="h238-0-75" class="i">+            ProtoReader(message.messageContent.content).getString(2, 1) ?: &quot;Failed to parse message&quot;
</a><a href="#h238-0-76" id="h238-0-76" class="i">+        } else null
</a><a href="#h238-0-77" id="h238-0-77" class="i">+    }
</a><a href="#h238-0-78" id="h238-0-78" class="i">+
</a><a href="#h238-0-79" id="h238-0-79" class="i">+    private fun exportText(output: OutputStream) {
</a><a href="#h238-0-80" id="h238-0-80" class="i">+        val writer = output.bufferedWriter()
</a><a href="#h238-0-81" id="h238-0-81" class="i">+        writer.write(&quot;Conversation key: ${friendFeedEntry.key}\n&quot;)
</a><a href="#h238-0-82" id="h238-0-82" class="i">+        writer.write(&quot;Conversation Name: ${friendFeedEntry.feedDisplayName}\n&quot;)
</a><a href="#h238-0-83" id="h238-0-83" class="i">+        writer.write(&quot;Participants:\n&quot;)
</a><a href="#h238-0-84" id="h238-0-84" class="i">+        conversationParticipants.forEach { (userId, friendInfo) -&gt;
</a><a href="#h238-0-85" id="h238-0-85" class="i">+            writer.write(&quot;  $userId: ${friendInfo.displayName}\n&quot;)
</a><a href="#h238-0-86" id="h238-0-86" class="i">+        }
</a><a href="#h238-0-87" id="h238-0-87" class="i">+
</a><a href="#h238-0-88" id="h238-0-88" class="i">+        writer.write(&quot;\nMessages:\n&quot;)
</a><a href="#h238-0-89" id="h238-0-89" class="i">+        messages.forEach { message -&gt;
</a><a href="#h238-0-90" id="h238-0-90" class="i">+            val sender = conversationParticipants[message.senderId.toString()]
</a><a href="#h238-0-91" id="h238-0-91" class="i">+            val senderUsername = sender?.usernameForSorting ?: message.senderId.toString()
</a><a href="#h238-0-92" id="h238-0-92" class="i">+            val senderDisplayName = sender?.displayName ?: message.senderId.toString()
</a><a href="#h238-0-93" id="h238-0-93" class="i">+            val messageContent = serializeMessageContent(message) ?: message.messageContent.contentType?.name
</a><a href="#h238-0-94" id="h238-0-94" class="i">+            val date = SimpleDateFormat(&quot;yyyy-MM-dd HH:mm:ss&quot;, Locale.ENGLISH).format(Date(message.messageMetadata.createdAt))
</a><a href="#h238-0-95" id="h238-0-95" class="i">+            writer.write(&quot;[$date] - $senderDisplayName (${senderUsername}): $messageContent\n&quot;)
</a><a href="#h238-0-96" id="h238-0-96" class="i">+        }
</a><a href="#h238-0-97" id="h238-0-97" class="i">+        writer.flush()
</a><a href="#h238-0-98" id="h238-0-98" class="i">+    }
</a><a href="#h238-0-99" id="h238-0-99" class="i">+
</a><a href="#h238-0-100" id="h238-0-100" class="i">+    suspend fun exportHtml(output: OutputStream) {
</a><a href="#h238-0-101" id="h238-0-101" class="i">+        val downloadMediaCacheFolder = File(Environment.getExternalStoragePublicDirectory(Environment.DIRECTORY_DOWNLOADS), &quot;SnapEnhance/cache&quot;).also { it.mkdirs() }
</a><a href="#h238-0-102" id="h238-0-102" class="i">+        val mediaFiles = Collections.synchronizedMap(mutableMapOf&lt;String, Pair&lt;FileType, File&gt;&gt;())
</a><a href="#h238-0-103" id="h238-0-103" class="i">+        val threadPool = Executors.newFixedThreadPool(15)
</a><a href="#h238-0-104" id="h238-0-104" class="i">+
</a><a href="#h238-0-105" id="h238-0-105" class="i">+        withContext(Dispatchers.IO) {
</a><a href="#h238-0-106" id="h238-0-106" class="i">+            var processCount = 0
</a><a href="#h238-0-107" id="h238-0-107" class="i">+
</a><a href="#h238-0-108" id="h238-0-108" class="i">+            fun updateProgress(type: String) {
</a><a href="#h238-0-109" id="h238-0-109" class="i">+                val total = messages.filter {
</a><a href="#h238-0-110" id="h238-0-110" class="i">+                    mediaToDownload?.contains(it.messageContent.contentType) ?: false
</a><a href="#h238-0-111" id="h238-0-111" class="i">+                }.size
</a><a href="#h238-0-112" id="h238-0-112" class="i">+                processCount++
</a><a href="#h238-0-113" id="h238-0-113" class="i">+                printLog(&quot;$type $processCount/$total&quot;)
</a><a href="#h238-0-114" id="h238-0-114" class="i">+            }
</a><a href="#h238-0-115" id="h238-0-115" class="i">+
</a><a href="#h238-0-116" id="h238-0-116" class="i">+            messages.filter {
</a><a href="#h238-0-117" id="h238-0-117" class="i">+                mediaToDownload?.contains(it.messageContent.contentType) ?: false
</a><a href="#h238-0-118" id="h238-0-118" class="i">+            }.forEach { message -&gt;
</a><a href="#h238-0-119" id="h238-0-119" class="i">+                threadPool.execute {
</a><a href="#h238-0-120" id="h238-0-120" class="i">+                    MessageDecoder.decode(message.messageContent).forEach decode@{ attachment -&gt;
</a><a href="#h238-0-121" id="h238-0-121" class="i">+                        val protoMediaReference = Base64.UrlSafe.decode(attachment.mediaUrlKey ?: return@decode)
</a><a href="#h238-0-122" id="h238-0-122" class="i">+
</a><a href="#h238-0-123" id="h238-0-123" class="i">+                        runCatching {
</a><a href="#h238-0-124" id="h238-0-124" class="i">+                            RemoteMediaResolver.downloadBoltMedia(protoMediaReference, decryptionCallback = {
</a><a href="#h238-0-125" id="h238-0-125" class="i">+                                (attachment.attachmentInfo?.encryption?.decryptInputStream(it) ?: it)
</a><a href="#h238-0-126" id="h238-0-126" class="i">+                            }) {
</a><a href="#h238-0-127" id="h238-0-127" class="i">+                                it.use { inputStream -&gt;
</a><a href="#h238-0-128" id="h238-0-128" class="i">+                                    MediaDownloaderHelper.getSplitElements(inputStream) { type, splitInputStream -&gt;
</a><a href="#h238-0-129" id="h238-0-129" class="i">+                                        val fileName = &quot;${type}_${Base64.UrlSafe.encode(protoMediaReference).replace(&quot;=&quot;, &quot;&quot;)}&quot;
</a><a href="#h238-0-130" id="h238-0-130" class="i">+                                        val bufferedInputStream = BufferedInputStream(splitInputStream)
</a><a href="#h238-0-131" id="h238-0-131" class="i">+                                        val fileType = MediaDownloaderHelper.getFileType(bufferedInputStream)
</a><a href="#h238-0-132" id="h238-0-132" class="i">+                                        val mediaFile = File(downloadMediaCacheFolder, &quot;$fileName.${fileType.fileExtension}&quot;)
</a><a href="#h238-0-133" id="h238-0-133" class="i">+
</a><a href="#h238-0-134" id="h238-0-134" class="i">+                                        FileOutputStream(mediaFile).use { fos -&gt;
</a><a href="#h238-0-135" id="h238-0-135" class="i">+                                            bufferedInputStream.copyTo(fos)
</a><a href="#h238-0-136" id="h238-0-136" class="i">+                                        }
</a><a href="#h238-0-137" id="h238-0-137" class="i">+
</a><a href="#h238-0-138" id="h238-0-138" class="i">+                                        mediaFiles[fileName] = fileType to mediaFile
</a><a href="#h238-0-139" id="h238-0-139" class="i">+                                    }
</a><a href="#h238-0-140" id="h238-0-140" class="i">+                                }
</a><a href="#h238-0-141" id="h238-0-141" class="i">+                            }
</a><a href="#h238-0-142" id="h238-0-142" class="i">+
</a><a href="#h238-0-143" id="h238-0-143" class="i">+                            updateProgress(&quot;downloaded&quot;)
</a><a href="#h238-0-144" id="h238-0-144" class="i">+                        }.onFailure {
</a><a href="#h238-0-145" id="h238-0-145" class="i">+                            printLog(&quot;failed to download media for ${message.messageDescriptor.conversationId}_${message.orderKey}&quot;)
</a><a href="#h238-0-146" id="h238-0-146" class="i">+                            context.log.error(&quot;failed to download media for ${message.messageDescriptor.conversationId}_${message.orderKey}&quot;, it)
</a><a href="#h238-0-147" id="h238-0-147" class="i">+                        }
</a><a href="#h238-0-148" id="h238-0-148" class="i">+                    }
</a><a href="#h238-0-149" id="h238-0-149" class="i">+                }
</a><a href="#h238-0-150" id="h238-0-150" class="i">+            }
</a><a href="#h238-0-151" id="h238-0-151" class="i">+
</a><a href="#h238-0-152" id="h238-0-152" class="i">+            threadPool.shutdown()
</a><a href="#h238-0-153" id="h238-0-153" class="i">+            threadPool.awaitTermination(30, TimeUnit.DAYS)
</a><a href="#h238-0-154" id="h238-0-154" class="i">+            processCount = 0
</a><a href="#h238-0-155" id="h238-0-155" class="i">+
</a><a href="#h238-0-156" id="h238-0-156" class="i">+            printLog(&quot;writing downloaded medias...&quot;)
</a><a href="#h238-0-157" id="h238-0-157" class="i">+
</a><a href="#h238-0-158" id="h238-0-158" class="i">+            //write the head of the html file
</a><a href="#h238-0-159" id="h238-0-159" class="i">+            output.write(&quot;&quot;&quot;
</a><a href="#h238-0-160" id="h238-0-160" class="i">+                &lt;!DOCTYPE html&gt;
</a><a href="#h238-0-161" id="h238-0-161" class="i">+                &lt;html&gt;
</a><a href="#h238-0-162" id="h238-0-162" class="i">+                &lt;head&gt;
</a><a href="#h238-0-163" id="h238-0-163" class="i">+                    &lt;meta charset=&quot;UTF-8&quot;&gt;
</a><a href="#h238-0-164" id="h238-0-164" class="i">+                    &lt;meta http-equiv=&quot;X-UA-Compatible&quot; content=&quot;IE=edge&quot;&gt;
</a><a href="#h238-0-165" id="h238-0-165" class="i">+                    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot;&gt;
</a><a href="#h238-0-166" id="h238-0-166" class="i">+                    &lt;title&gt;&lt;/title&gt;
</a><a href="#h238-0-167" id="h238-0-167" class="i">+                &lt;/head&gt;
</a><a href="#h238-0-168" id="h238-0-168" class="i">+            &quot;&quot;&quot;.trimIndent().toByteArray())
</a><a href="#h238-0-169" id="h238-0-169" class="i">+
</a><a href="#h238-0-170" id="h238-0-170" class="i">+            output.write(&quot;&lt;!-- This file was generated by SnapEnhance ${BuildConfig.VERSION_NAME} --&gt;\n&quot;.toByteArray())
</a><a href="#h238-0-171" id="h238-0-171" class="i">+
</a><a href="#h238-0-172" id="h238-0-172" class="i">+            mediaFiles.forEach { (key, filePair) -&gt;
</a><a href="#h238-0-173" id="h238-0-173" class="i">+                output.write(&quot;&lt;div class=\&quot;media-$key\&quot;&gt;&lt;!-- &quot;.toByteArray())
</a><a href="#h238-0-174" id="h238-0-174" class="i">+
</a><a href="#h238-0-175" id="h238-0-175" class="i">+                val deflateInputStream = DeflaterInputStream(filePair.second.inputStream(), Deflater(Deflater.BEST_COMPRESSION, true))
</a><a href="#h238-0-176" id="h238-0-176" class="i">+                val base64InputStream = XposedHelpers.newInstance(
</a><a href="#h238-0-177" id="h238-0-177" class="i">+                    Base64InputStream::class.java,
</a><a href="#h238-0-178" id="h238-0-178" class="i">+                    deflateInputStream,
</a><a href="#h238-0-179" id="h238-0-179" class="i">+                    android.util.Base64.DEFAULT or android.util.Base64.NO_WRAP,
</a><a href="#h238-0-180" id="h238-0-180" class="i">+                    true
</a><a href="#h238-0-181" id="h238-0-181" class="i">+                ) as InputStream
</a><a href="#h238-0-182" id="h238-0-182" class="i">+                base64InputStream.copyTo(output)
</a><a href="#h238-0-183" id="h238-0-183" class="i">+                deflateInputStream.close()
</a><a href="#h238-0-184" id="h238-0-184" class="i">+
</a><a href="#h238-0-185" id="h238-0-185" class="i">+                output.write(&quot; --&gt;&lt;/div&gt;\n&quot;.toByteArray())
</a><a href="#h238-0-186" id="h238-0-186" class="i">+                output.flush()
</a><a href="#h238-0-187" id="h238-0-187" class="i">+                updateProgress(&quot;wrote&quot;)
</a><a href="#h238-0-188" id="h238-0-188" class="i">+            }
</a><a href="#h238-0-189" id="h238-0-189" class="i">+            printLog(&quot;writing json conversation data...&quot;)
</a><a href="#h238-0-190" id="h238-0-190" class="i">+
</a><a href="#h238-0-191" id="h238-0-191" class="i">+            //write the json file
</a><a href="#h238-0-192" id="h238-0-192" class="i">+            output.write(&quot;&lt;script type=\&quot;application/json\&quot; class=\&quot;exported_content\&quot;&gt;&quot;.toByteArray())
</a><a href="#h238-0-193" id="h238-0-193" class="i">+            exportJson(output)
</a><a href="#h238-0-194" id="h238-0-194" class="i">+            output.write(&quot;&lt;/script&gt;\n&quot;.toByteArray())
</a><a href="#h238-0-195" id="h238-0-195" class="i">+
</a><a href="#h238-0-196" id="h238-0-196" class="i">+            printLog(&quot;writing template...&quot;)
</a><a href="#h238-0-197" id="h238-0-197" class="i">+
</a><a href="#h238-0-198" id="h238-0-198" class="i">+            runCatching {
</a><a href="#h238-0-199" id="h238-0-199" class="i">+                ZipFile(context.bridgeClient.getApplicationApkPath()).use { apkFile -&gt;
</a><a href="#h238-0-200" id="h238-0-200" class="i">+                    //export rawinflate.js
</a><a href="#h238-0-201" id="h238-0-201" class="i">+                    apkFile.getEntry(&quot;assets/web/rawinflate.js&quot;).let { entry -&gt;
</a><a href="#h238-0-202" id="h238-0-202" class="i">+                        output.write(&quot;&lt;script&gt;&quot;.toByteArray())
</a><a href="#h238-0-203" id="h238-0-203" class="i">+                        apkFile.getInputStream(entry).copyTo(output)
</a><a href="#h238-0-204" id="h238-0-204" class="i">+                        output.write(&quot;&lt;/script&gt;\n&quot;.toByteArray())
</a><a href="#h238-0-205" id="h238-0-205" class="i">+                    }
</a><a href="#h238-0-206" id="h238-0-206" class="i">+
</a><a href="#h238-0-207" id="h238-0-207" class="i">+                    //export avenir next font
</a><a href="#h238-0-208" id="h238-0-208" class="i">+                    apkFile.getEntry(&quot;res/font/avenir_next_medium.ttf&quot;).let { entry -&gt;
</a><a href="#h238-0-209" id="h238-0-209" class="i">+                        val encodedFontData = Base64.Default.encode(apkFile.getInputStream(entry).readBytes())
</a><a href="#h238-0-210" id="h238-0-210" class="i">+                        output.write(&quot;&quot;&quot;
</a><a href="#h238-0-211" id="h238-0-211" class="i">+                        &lt;style&gt;
</a><a href="#h238-0-212" id="h238-0-212" class="i">+                            @font-face {
</a><a href="#h238-0-213" id="h238-0-213" class="i">+                                font-family: &#39;Avenir Next&#39;;
</a><a href="#h238-0-214" id="h238-0-214" class="i">+                                src: url(&#39;data:font/truetype;charset=utf-8;base64, $encodedFontData&#39;);
</a><a href="#h238-0-215" id="h238-0-215" class="i">+                                font-weight: normal;
</a><a href="#h238-0-216" id="h238-0-216" class="i">+                                font-style: normal;
</a><a href="#h238-0-217" id="h238-0-217" class="i">+                            }
</a><a href="#h238-0-218" id="h238-0-218" class="i">+                        &lt;/style&gt;
</a><a href="#h238-0-219" id="h238-0-219" class="i">+                    &quot;&quot;&quot;.trimIndent().toByteArray())
</a><a href="#h238-0-220" id="h238-0-220" class="i">+                    }
</a><a href="#h238-0-221" id="h238-0-221" class="i">+
</a><a href="#h238-0-222" id="h238-0-222" class="i">+                    apkFile.getEntry(&quot;assets/web/export_template.html&quot;).let { entry -&gt;
</a><a href="#h238-0-223" id="h238-0-223" class="i">+                        apkFile.getInputStream(entry).copyTo(output)
</a><a href="#h238-0-224" id="h238-0-224" class="i">+                    }
</a><a href="#h238-0-225" id="h238-0-225" class="i">+
</a><a href="#h238-0-226" id="h238-0-226" class="i">+                    apkFile.close()
</a><a href="#h238-0-227" id="h238-0-227" class="i">+                }
</a><a href="#h238-0-228" id="h238-0-228" class="i">+            }.onFailure {
</a><a href="#h238-0-229" id="h238-0-229" class="i">+                throw Throwable(&quot;Failed to read template from apk&quot;, it)
</a><a href="#h238-0-230" id="h238-0-230" class="i">+            }
</a><a href="#h238-0-231" id="h238-0-231" class="i">+
</a><a href="#h238-0-232" id="h238-0-232" class="i">+            output.write(&quot;&lt;/html&gt;&quot;.toByteArray())
</a><a href="#h238-0-233" id="h238-0-233" class="i">+            output.close()
</a><a href="#h238-0-234" id="h238-0-234" class="i">+        }
</a><a href="#h238-0-235" id="h238-0-235" class="i">+    }
</a><a href="#h238-0-236" id="h238-0-236" class="i">+
</a><a href="#h238-0-237" id="h238-0-237" class="i">+    private fun exportJson(output: OutputStream) {
</a><a href="#h238-0-238" id="h238-0-238" class="i">+        val rootObject = JsonObject().apply {
</a><a href="#h238-0-239" id="h238-0-239" class="i">+            addProperty(&quot;conversationId&quot;, friendFeedEntry.key)
</a><a href="#h238-0-240" id="h238-0-240" class="i">+            addProperty(&quot;conversationName&quot;, friendFeedEntry.feedDisplayName)
</a><a href="#h238-0-241" id="h238-0-241" class="i">+
</a><a href="#h238-0-242" id="h238-0-242" class="i">+            var index = 0
</a><a href="#h238-0-243" id="h238-0-243" class="i">+            val participants = mutableMapOf&lt;String, Int&gt;()
</a><a href="#h238-0-244" id="h238-0-244" class="i">+
</a><a href="#h238-0-245" id="h238-0-245" class="i">+            add(&quot;participants&quot;, JsonObject().apply {
</a><a href="#h238-0-246" id="h238-0-246" class="i">+                conversationParticipants.forEach { (userId, friendInfo) -&gt;
</a><a href="#h238-0-247" id="h238-0-247" class="i">+                    add(userId, JsonObject().apply {
</a><a href="#h238-0-248" id="h238-0-248" class="i">+                        addProperty(&quot;id&quot;, index)
</a><a href="#h238-0-249" id="h238-0-249" class="i">+                        addProperty(&quot;displayName&quot;, friendInfo.displayName)
</a><a href="#h238-0-250" id="h238-0-250" class="i">+                        addProperty(&quot;username&quot;, friendInfo.usernameForSorting)
</a><a href="#h238-0-251" id="h238-0-251" class="i">+                        addProperty(&quot;bitmojiSelfieId&quot;, friendInfo.bitmojiSelfieId)
</a><a href="#h238-0-252" id="h238-0-252" class="i">+                    })
</a><a href="#h238-0-253" id="h238-0-253" class="i">+                    participants[userId] = index++
</a><a href="#h238-0-254" id="h238-0-254" class="i">+                }
</a><a href="#h238-0-255" id="h238-0-255" class="i">+            })
</a><a href="#h238-0-256" id="h238-0-256" class="i">+            add(&quot;messages&quot;, JsonArray().apply {
</a><a href="#h238-0-257" id="h238-0-257" class="i">+                messages.forEach { message -&gt;
</a><a href="#h238-0-258" id="h238-0-258" class="i">+                    add(JsonObject().apply {
</a><a href="#h238-0-259" id="h238-0-259" class="i">+                        addProperty(&quot;orderKey&quot;, message.orderKey)
</a><a href="#h238-0-260" id="h238-0-260" class="i">+                        addProperty(&quot;senderId&quot;, participants.getOrDefault(message.senderId.toString(), -1))
</a><a href="#h238-0-261" id="h238-0-261" class="i">+                        addProperty(&quot;type&quot;, message.messageContent.contentType.toString())
</a><a href="#h238-0-262" id="h238-0-262" class="i">+
</a><a href="#h238-0-263" id="h238-0-263" class="i">+                        fun addUUIDList(name: String, list: List&lt;SnapUUID&gt;) {
</a><a href="#h238-0-264" id="h238-0-264" class="i">+                            add(name, JsonArray().apply {
</a><a href="#h238-0-265" id="h238-0-265" class="i">+                                list.map { participants.getOrDefault(it.toString(), -1) }.forEach { add(it) }
</a><a href="#h238-0-266" id="h238-0-266" class="i">+                            })
</a><a href="#h238-0-267" id="h238-0-267" class="i">+                        }
</a><a href="#h238-0-268" id="h238-0-268" class="i">+
</a><a href="#h238-0-269" id="h238-0-269" class="i">+                        addUUIDList(&quot;savedBy&quot;, message.messageMetadata.savedBy)
</a><a href="#h238-0-270" id="h238-0-270" class="i">+                        addUUIDList(&quot;seenBy&quot;, message.messageMetadata.seenBy)
</a><a href="#h238-0-271" id="h238-0-271" class="i">+                        addUUIDList(&quot;openedBy&quot;, message.messageMetadata.openedBy)
</a><a href="#h238-0-272" id="h238-0-272" class="i">+
</a><a href="#h238-0-273" id="h238-0-273" class="i">+                        add(&quot;reactions&quot;, JsonObject().apply {
</a><a href="#h238-0-274" id="h238-0-274" class="i">+                            message.messageMetadata.reactions.forEach { reaction -&gt;
</a><a href="#h238-0-275" id="h238-0-275" class="i">+                                addProperty(
</a><a href="#h238-0-276" id="h238-0-276" class="i">+                                    participants.getOrDefault(reaction.userId.toString(), -1L).toString(),
</a><a href="#h238-0-277" id="h238-0-277" class="i">+                                    reaction.reactionId
</a><a href="#h238-0-278" id="h238-0-278" class="i">+                                )
</a><a href="#h238-0-279" id="h238-0-279" class="i">+                            }
</a><a href="#h238-0-280" id="h238-0-280" class="i">+                        })
</a><a href="#h238-0-281" id="h238-0-281" class="i">+
</a><a href="#h238-0-282" id="h238-0-282" class="i">+                        addProperty(&quot;createdTimestamp&quot;, message.messageMetadata.createdAt)
</a><a href="#h238-0-283" id="h238-0-283" class="i">+                        addProperty(&quot;readTimestamp&quot;, message.messageMetadata.readAt)
</a><a href="#h238-0-284" id="h238-0-284" class="i">+                        addProperty(&quot;serializedContent&quot;, serializeMessageContent(message))
</a><a href="#h238-0-285" id="h238-0-285" class="i">+                        addProperty(&quot;rawContent&quot;, Base64.UrlSafe.encode(message.messageContent.content))
</a><a href="#h238-0-286" id="h238-0-286" class="i">+
</a><a href="#h238-0-287" id="h238-0-287" class="i">+                        add(&quot;attachments&quot;, JsonArray().apply {
</a><a href="#h238-0-288" id="h238-0-288" class="i">+                            MessageDecoder.decode(message.messageContent)
</a><a href="#h238-0-289" id="h238-0-289" class="i">+                                .forEach attachments@{ attachments -&gt;
</a><a href="#h238-0-290" id="h238-0-290" class="i">+                                if (attachments.type == AttachmentType.STICKER) //TODO: implement stickers
</a><a href="#h238-0-291" id="h238-0-291" class="i">+                                    return@attachments
</a><a href="#h238-0-292" id="h238-0-292" class="i">+                                add(JsonObject().apply {
</a><a href="#h238-0-293" id="h238-0-293" class="i">+                                    addProperty(&quot;key&quot;, attachments.mediaUrlKey?.replace(&quot;=&quot;, &quot;&quot;))
</a><a href="#h238-0-294" id="h238-0-294" class="i">+                                    addProperty(&quot;type&quot;, attachments.type.toString())
</a><a href="#h238-0-295" id="h238-0-295" class="i">+                                    add(&quot;encryption&quot;, attachments.attachmentInfo?.encryption?.let { encryption -&gt;
</a><a href="#h238-0-296" id="h238-0-296" class="i">+                                        JsonObject().apply {
</a><a href="#h238-0-297" id="h238-0-297" class="i">+                                            addProperty(&quot;key&quot;, encryption.key)
</a><a href="#h238-0-298" id="h238-0-298" class="i">+                                            addProperty(&quot;iv&quot;, encryption.iv)
</a><a href="#h238-0-299" id="h238-0-299" class="i">+                                        }
</a><a href="#h238-0-300" id="h238-0-300" class="i">+                                    } ?: JsonNull.INSTANCE)
</a><a href="#h238-0-301" id="h238-0-301" class="i">+                                })
</a><a href="#h238-0-302" id="h238-0-302" class="i">+                            }
</a><a href="#h238-0-303" id="h238-0-303" class="i">+                        })
</a><a href="#h238-0-304" id="h238-0-304" class="i">+                    })
</a><a href="#h238-0-305" id="h238-0-305" class="i">+                }
</a><a href="#h238-0-306" id="h238-0-306" class="i">+            })
</a><a href="#h238-0-307" id="h238-0-307" class="i">+        }
</a><a href="#h238-0-308" id="h238-0-308" class="i">+
</a><a href="#h238-0-309" id="h238-0-309" class="i">+        output.write(context.gson.toJson(rootObject).toByteArray())
</a><a href="#h238-0-310" id="h238-0-310" class="i">+        output.flush()
</a><a href="#h238-0-311" id="h238-0-311" class="i">+    }
</a><a href="#h238-0-312" id="h238-0-312" class="i">+
</a><a href="#h238-0-313" id="h238-0-313" class="i">+    suspend fun exportTo(exportFormat: ExportFormat) {
</a><a href="#h238-0-314" id="h238-0-314" class="i">+        val output = FileOutputStream(outputFile)
</a><a href="#h238-0-315" id="h238-0-315" class="i">+
</a><a href="#h238-0-316" id="h238-0-316" class="i">+        when (exportFormat) {
</a><a href="#h238-0-317" id="h238-0-317" class="i">+            ExportFormat.HTML -&gt; exportHtml(output)
</a><a href="#h238-0-318" id="h238-0-318" class="i">+            ExportFormat.JSON -&gt; exportJson(output)
</a><a href="#h238-0-319" id="h238-0-319" class="i">+            ExportFormat.TEXT -&gt; exportText(output)
</a><a href="#h238-0-320" id="h238-0-320" class="i">+        }
</a><a href="#h238-0-321" id="h238-0-321" class="i">+
</a><a href="#h238-0-322" id="h238-0-322" class="i">+        output.close()
</a><a href="#h238-0-323" id="h238-0-323" class="i">+    }
</a><a href="#h238-0-324" id="h238-0-324" class="i">+}</a><a href="#h238-0-325" id="h238-0-325" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h239" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/messaging/MessageSender.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/messaging/MessageSender.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/messaging/MessageSender.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/messaging/MessageSender.kt</a></b>
<a href="#h239-0" id="h239-0" class="h">@@ -0,0 +1,181 @@
</a><a href="#h239-0-0" id="h239-0-0" class="i">+package me.rhunk.snapenhance.core.messaging
</a><a href="#h239-0-1" id="h239-0-1" class="i">+
</a><a href="#h239-0-2" id="h239-0-2" class="i">+import me.rhunk.snapenhance.common.data.ContentType
</a><a href="#h239-0-3" id="h239-0-3" class="i">+import me.rhunk.snapenhance.common.data.MetricsMessageMediaType
</a><a href="#h239-0-4" id="h239-0-4" class="i">+import me.rhunk.snapenhance.common.data.MetricsMessageType
</a><a href="#h239-0-5" id="h239-0-5" class="i">+import me.rhunk.snapenhance.common.util.protobuf.ProtoWriter
</a><a href="#h239-0-6" id="h239-0-6" class="i">+import me.rhunk.snapenhance.core.ModContext
</a><a href="#h239-0-7" id="h239-0-7" class="i">+import me.rhunk.snapenhance.core.features.impl.messaging.Messaging
</a><a href="#h239-0-8" id="h239-0-8" class="i">+import me.rhunk.snapenhance.core.util.CallbackBuilder
</a><a href="#h239-0-9" id="h239-0-9" class="i">+import me.rhunk.snapenhance.core.wrapper.AbstractWrapper
</a><a href="#h239-0-10" id="h239-0-10" class="i">+import me.rhunk.snapenhance.core.wrapper.impl.MessageDestinations
</a><a href="#h239-0-11" id="h239-0-11" class="i">+import me.rhunk.snapenhance.core.wrapper.impl.SnapUUID
</a><a href="#h239-0-12" id="h239-0-12" class="i">+
</a><a href="#h239-0-13" id="h239-0-13" class="i">+class MessageSender(
</a><a href="#h239-0-14" id="h239-0-14" class="i">+    private val context: ModContext,
</a><a href="#h239-0-15" id="h239-0-15" class="i">+) {
</a><a href="#h239-0-16" id="h239-0-16" class="i">+    companion object {
</a><a href="#h239-0-17" id="h239-0-17" class="i">+        val redSnapProto: (ByteArray?) -&gt; ByteArray = { extras -&gt;
</a><a href="#h239-0-18" id="h239-0-18" class="i">+            ProtoWriter().apply {
</a><a href="#h239-0-19" id="h239-0-19" class="i">+                from(11) {
</a><a href="#h239-0-20" id="h239-0-20" class="i">+                    from(5) {
</a><a href="#h239-0-21" id="h239-0-21" class="i">+                        from(1) {
</a><a href="#h239-0-22" id="h239-0-22" class="i">+                            from(1) {
</a><a href="#h239-0-23" id="h239-0-23" class="i">+                                addVarInt(2, 0)
</a><a href="#h239-0-24" id="h239-0-24" class="i">+                                addVarInt(12, 0)
</a><a href="#h239-0-25" id="h239-0-25" class="i">+                                addVarInt(15, 0)
</a><a href="#h239-0-26" id="h239-0-26" class="i">+                            }
</a><a href="#h239-0-27" id="h239-0-27" class="i">+                            addVarInt(6, 0)
</a><a href="#h239-0-28" id="h239-0-28" class="i">+                        }
</a><a href="#h239-0-29" id="h239-0-29" class="i">+                        from(2) {
</a><a href="#h239-0-30" id="h239-0-30" class="i">+                            addVarInt(5, 1) // audio by default
</a><a href="#h239-0-31" id="h239-0-31" class="i">+                            addBuffer(6, byteArrayOf())
</a><a href="#h239-0-32" id="h239-0-32" class="i">+                        }
</a><a href="#h239-0-33" id="h239-0-33" class="i">+                    }
</a><a href="#h239-0-34" id="h239-0-34" class="i">+                    extras?.let {
</a><a href="#h239-0-35" id="h239-0-35" class="i">+                        addBuffer(13, it)
</a><a href="#h239-0-36" id="h239-0-36" class="i">+                    }
</a><a href="#h239-0-37" id="h239-0-37" class="i">+                }
</a><a href="#h239-0-38" id="h239-0-38" class="i">+            }.toByteArray()
</a><a href="#h239-0-39" id="h239-0-39" class="i">+        }
</a><a href="#h239-0-40" id="h239-0-40" class="i">+
</a><a href="#h239-0-41" id="h239-0-41" class="i">+        val audioNoteProto: (Long) -&gt; ByteArray = { duration -&gt;
</a><a href="#h239-0-42" id="h239-0-42" class="i">+            ProtoWriter().apply {
</a><a href="#h239-0-43" id="h239-0-43" class="i">+                from(6, 1) {
</a><a href="#h239-0-44" id="h239-0-44" class="i">+                    from(1) {
</a><a href="#h239-0-45" id="h239-0-45" class="i">+                        addVarInt(2, 4)
</a><a href="#h239-0-46" id="h239-0-46" class="i">+                        from(5) {
</a><a href="#h239-0-47" id="h239-0-47" class="i">+                            addVarInt(1, 0)
</a><a href="#h239-0-48" id="h239-0-48" class="i">+                            addVarInt(2, 0)
</a><a href="#h239-0-49" id="h239-0-49" class="i">+                        }
</a><a href="#h239-0-50" id="h239-0-50" class="i">+                        addVarInt(7, 0)
</a><a href="#h239-0-51" id="h239-0-51" class="i">+                        addVarInt(13, duration)
</a><a href="#h239-0-52" id="h239-0-52" class="i">+                    }
</a><a href="#h239-0-53" id="h239-0-53" class="i">+                }
</a><a href="#h239-0-54" id="h239-0-54" class="i">+            }.toByteArray()
</a><a href="#h239-0-55" id="h239-0-55" class="i">+        }
</a><a href="#h239-0-56" id="h239-0-56" class="i">+
</a><a href="#h239-0-57" id="h239-0-57" class="i">+    }
</a><a href="#h239-0-58" id="h239-0-58" class="i">+
</a><a href="#h239-0-59" id="h239-0-59" class="i">+    private val sendMessageCallback by lazy { context.mappings.getMappedClass(&quot;callbacks&quot;, &quot;SendMessageCallback&quot;) }
</a><a href="#h239-0-60" id="h239-0-60" class="i">+
</a><a href="#h239-0-61" id="h239-0-61" class="i">+    private val platformAnalyticsCreatorClass by lazy {
</a><a href="#h239-0-62" id="h239-0-62" class="i">+        context.mappings.getMappedClass(&quot;PlatformAnalyticsCreator&quot;)
</a><a href="#h239-0-63" id="h239-0-63" class="i">+    }
</a><a href="#h239-0-64" id="h239-0-64" class="i">+
</a><a href="#h239-0-65" id="h239-0-65" class="i">+    private fun defaultPlatformAnalytics(): ByteArray {
</a><a href="#h239-0-66" id="h239-0-66" class="i">+        val analyticsSource = platformAnalyticsCreatorClass.constructors[0].parameterTypes[0]
</a><a href="#h239-0-67" id="h239-0-67" class="i">+        val chatAnalyticsSource = analyticsSource.enumConstants.first { it.toString() == &quot;CHAT&quot; }
</a><a href="#h239-0-68" id="h239-0-68" class="i">+
</a><a href="#h239-0-69" id="h239-0-69" class="i">+        val platformAnalyticsDefaultArgs = arrayOf(chatAnalyticsSource, null, null, null, null, null, null, null, null, null, 0L, 0L,
</a><a href="#h239-0-70" id="h239-0-70" class="i">+            null, null, false, null, null, 0L, null, null, false, null, null,
</a><a href="#h239-0-71" id="h239-0-71" class="i">+            null, null, null, null, null, null, null, null, null, null, null,
</a><a href="#h239-0-72" id="h239-0-72" class="i">+            null, null, null, null, null, null, false, null, null, false, 0L, -2, 8191)
</a><a href="#h239-0-73" id="h239-0-73" class="i">+
</a><a href="#h239-0-74" id="h239-0-74" class="i">+        val platformAnalyticsInstance = platformAnalyticsCreatorClass.constructors[0].newInstance(
</a><a href="#h239-0-75" id="h239-0-75" class="i">+            *platformAnalyticsDefaultArgs
</a><a href="#h239-0-76" id="h239-0-76" class="i">+        ) ?: throw Exception(&quot;Failed to create platform analytics instance&quot;)
</a><a href="#h239-0-77" id="h239-0-77" class="i">+
</a><a href="#h239-0-78" id="h239-0-78" class="i">+        return platformAnalyticsInstance.javaClass.declaredMethods.first { it.returnType == ByteArray::class.java }
</a><a href="#h239-0-79" id="h239-0-79" class="i">+            .invoke(platformAnalyticsInstance) as ByteArray?
</a><a href="#h239-0-80" id="h239-0-80" class="i">+            ?: throw Exception(&quot;Failed to get platform analytics content&quot;)
</a><a href="#h239-0-81" id="h239-0-81" class="i">+    }
</a><a href="#h239-0-82" id="h239-0-82" class="i">+
</a><a href="#h239-0-83" id="h239-0-83" class="i">+    private fun createLocalMessageContentTemplate(
</a><a href="#h239-0-84" id="h239-0-84" class="i">+        contentType: ContentType,
</a><a href="#h239-0-85" id="h239-0-85" class="i">+        messageContent: ByteArray,
</a><a href="#h239-0-86" id="h239-0-86" class="i">+        localMediaReference: ByteArray? = null,
</a><a href="#h239-0-87" id="h239-0-87" class="i">+        metricMessageMediaType: MetricsMessageMediaType = MetricsMessageMediaType.DERIVED_FROM_MESSAGE_TYPE,
</a><a href="#h239-0-88" id="h239-0-88" class="i">+        metricsMediaType: MetricsMessageType = MetricsMessageType.TEXT,
</a><a href="#h239-0-89" id="h239-0-89" class="i">+        savePolicy: String = &quot;PROHIBITED&quot;,
</a><a href="#h239-0-90" id="h239-0-90" class="i">+    ): String {
</a><a href="#h239-0-91" id="h239-0-91" class="i">+        return &quot;&quot;&quot;
</a><a href="#h239-0-92" id="h239-0-92" class="i">+        {
</a><a href="#h239-0-93" id="h239-0-93" class="i">+            &quot;mAllowsTranscription&quot;: false,
</a><a href="#h239-0-94" id="h239-0-94" class="i">+            &quot;mBotMention&quot;: false,
</a><a href="#h239-0-95" id="h239-0-95" class="i">+            &quot;mContent&quot;: [${messageContent.joinToString(&quot;,&quot;)}],
</a><a href="#h239-0-96" id="h239-0-96" class="i">+            &quot;mContentType&quot;: &quot;${contentType.name}&quot;,
</a><a href="#h239-0-97" id="h239-0-97" class="i">+            &quot;mIncidentalAttachments&quot;: [],
</a><a href="#h239-0-98" id="h239-0-98" class="i">+            &quot;mLocalMediaReferences&quot;: [${
</a><a href="#h239-0-99" id="h239-0-99" class="i">+                if (localMediaReference != null) {
</a><a href="#h239-0-100" id="h239-0-100" class="i">+                    &quot;{\&quot;mId\&quot;: [${localMediaReference.joinToString(&quot;,&quot;)}]}&quot;
</a><a href="#h239-0-101" id="h239-0-101" class="i">+                } else {
</a><a href="#h239-0-102" id="h239-0-102" class="i">+                    &quot;&quot;
</a><a href="#h239-0-103" id="h239-0-103" class="i">+                }
</a><a href="#h239-0-104" id="h239-0-104" class="i">+            }],
</a><a href="#h239-0-105" id="h239-0-105" class="i">+            &quot;mPlatformAnalytics&quot;: {
</a><a href="#h239-0-106" id="h239-0-106" class="i">+                &quot;mAttemptId&quot;: {
</a><a href="#h239-0-107" id="h239-0-107" class="i">+                  &quot;mId&quot;: [${(1..16).map { (-127 ..127).random() }.joinToString(&quot;,&quot;)}]
</a><a href="#h239-0-108" id="h239-0-108" class="i">+                },
</a><a href="#h239-0-109" id="h239-0-109" class="i">+                &quot;mContent&quot;: [${defaultPlatformAnalytics().joinToString(&quot;,&quot;)}],
</a><a href="#h239-0-110" id="h239-0-110" class="i">+                &quot;mMetricsMessageMediaType&quot;: &quot;${metricMessageMediaType.name}&quot;,
</a><a href="#h239-0-111" id="h239-0-111" class="i">+                &quot;mMetricsMessageType&quot;: &quot;${metricsMediaType.name}&quot;,
</a><a href="#h239-0-112" id="h239-0-112" class="i">+                &quot;mReactionSource&quot;: &quot;NONE&quot;
</a><a href="#h239-0-113" id="h239-0-113" class="i">+            },
</a><a href="#h239-0-114" id="h239-0-114" class="i">+            &quot;mSavePolicy&quot;: &quot;$savePolicy&quot;
</a><a href="#h239-0-115" id="h239-0-115" class="i">+        }
</a><a href="#h239-0-116" id="h239-0-116" class="i">+        &quot;&quot;&quot;.trimIndent()
</a><a href="#h239-0-117" id="h239-0-117" class="i">+    }
</a><a href="#h239-0-118" id="h239-0-118" class="i">+
</a><a href="#h239-0-119" id="h239-0-119" class="i">+    private fun internalSendMessage(conversations: List&lt;SnapUUID&gt;, localMessageContentTemplate: String, callback: Any) {
</a><a href="#h239-0-120" id="h239-0-120" class="i">+        val sendMessageWithContentMethod = context.classCache.conversationManager.declaredMethods.first { it.name == &quot;sendMessageWithContent&quot; }
</a><a href="#h239-0-121" id="h239-0-121" class="i">+
</a><a href="#h239-0-122" id="h239-0-122" class="i">+        val localMessageContent = context.gson.fromJson(localMessageContentTemplate, context.classCache.localMessageContent)
</a><a href="#h239-0-123" id="h239-0-123" class="i">+        val messageDestinations = MessageDestinations(AbstractWrapper.newEmptyInstance(context.classCache.messageDestinations)).also {
</a><a href="#h239-0-124" id="h239-0-124" class="i">+            it.conversations = conversations
</a><a href="#h239-0-125" id="h239-0-125" class="i">+            it.mPhoneNumbers = arrayListOf()
</a><a href="#h239-0-126" id="h239-0-126" class="i">+            it.stories = arrayListOf()
</a><a href="#h239-0-127" id="h239-0-127" class="i">+        }
</a><a href="#h239-0-128" id="h239-0-128" class="i">+
</a><a href="#h239-0-129" id="h239-0-129" class="i">+        sendMessageWithContentMethod.invoke(context.feature(Messaging::class).conversationManager, messageDestinations.instanceNonNull(), localMessageContent, callback)
</a><a href="#h239-0-130" id="h239-0-130" class="i">+    }
</a><a href="#h239-0-131" id="h239-0-131" class="i">+
</a><a href="#h239-0-132" id="h239-0-132" class="i">+    //TODO: implement sendSnapMessage
</a><a href="#h239-0-133" id="h239-0-133" class="i">+    /*
</a><a href="#h239-0-134" id="h239-0-134" class="i">+    fun sendSnapMessage(conversations: List&lt;SnapUUID&gt;, chatMediaType: ChatMediaType, uri: Uri, onError: (Any) -&gt; Unit = {}, onSuccess: () -&gt; Unit = {}) {
</a><a href="#h239-0-135" id="h239-0-135" class="i">+        val mediaReferenceBuffer = FlatBufferBuilder(0).apply {
</a><a href="#h239-0-136" id="h239-0-136" class="i">+            val uriOffset = createString(uri.toString())
</a><a href="#h239-0-137" id="h239-0-137" class="i">+            forceDefaults(true)
</a><a href="#h239-0-138" id="h239-0-138" class="i">+            startTable(2)
</a><a href="#h239-0-139" id="h239-0-139" class="i">+            addOffset(1, uriOffset, 0)
</a><a href="#h239-0-140" id="h239-0-140" class="i">+            addInt(0, chatMediaType.value, 0)
</a><a href="#h239-0-141" id="h239-0-141" class="i">+            finish(endTable())
</a><a href="#h239-0-142" id="h239-0-142" class="i">+            finished()
</a><a href="#h239-0-143" id="h239-0-143" class="i">+        }.sizedByteArray()
</a><a href="#h239-0-144" id="h239-0-144" class="i">+
</a><a href="#h239-0-145" id="h239-0-145" class="i">+        internalSendMessage(conversations, createLocalMessageContentTemplate(
</a><a href="#h239-0-146" id="h239-0-146" class="i">+            contentType = ContentType.SNAP,
</a><a href="#h239-0-147" id="h239-0-147" class="i">+            messageContent = redSnapProto(chatMediaType == ChatMediaType.AUDIO || chatMediaType == ChatMediaType.VIDEO),
</a><a href="#h239-0-148" id="h239-0-148" class="i">+            localMediaReference = mediaReferenceBuffer,
</a><a href="#h239-0-149" id="h239-0-149" class="i">+            metricMessageMediaType = MetricsMessageMediaType.IMAGE,
</a><a href="#h239-0-150" id="h239-0-150" class="i">+            metricsMediaType = MetricsMessageType.SNAP
</a><a href="#h239-0-151" id="h239-0-151" class="i">+        ), CallbackBuilder(sendMessageCallback)
</a><a href="#h239-0-152" id="h239-0-152" class="i">+            .override(&quot;onSuccess&quot;) {
</a><a href="#h239-0-153" id="h239-0-153" class="i">+                onSuccess()
</a><a href="#h239-0-154" id="h239-0-154" class="i">+            }
</a><a href="#h239-0-155" id="h239-0-155" class="i">+            .override(&quot;onError&quot;) {
</a><a href="#h239-0-156" id="h239-0-156" class="i">+                onError(it.arg(0))
</a><a href="#h239-0-157" id="h239-0-157" class="i">+            }
</a><a href="#h239-0-158" id="h239-0-158" class="i">+            .build())
</a><a href="#h239-0-159" id="h239-0-159" class="i">+    }*/
</a><a href="#h239-0-160" id="h239-0-160" class="i">+
</a><a href="#h239-0-161" id="h239-0-161" class="i">+    fun sendChatMessage(conversations: List&lt;SnapUUID&gt;, message: String, onError: (Any) -&gt; Unit = {}, onSuccess: () -&gt; Unit = {}) {
</a><a href="#h239-0-162" id="h239-0-162" class="i">+        internalSendMessage(conversations, createLocalMessageContentTemplate(ContentType.CHAT, ProtoWriter().apply {
</a><a href="#h239-0-163" id="h239-0-163" class="i">+            from(2) {
</a><a href="#h239-0-164" id="h239-0-164" class="i">+                addString(1, message)
</a><a href="#h239-0-165" id="h239-0-165" class="i">+            }
</a><a href="#h239-0-166" id="h239-0-166" class="i">+        }.toByteArray(), savePolicy = &quot;LIFETIME&quot;), CallbackBuilder(sendMessageCallback)
</a><a href="#h239-0-167" id="h239-0-167" class="i">+            .override(&quot;onSuccess&quot;, callback = { onSuccess() })
</a><a href="#h239-0-168" id="h239-0-168" class="i">+            .override(&quot;onError&quot;, callback = { onError(it.arg(0)) })
</a><a href="#h239-0-169" id="h239-0-169" class="i">+            .build())
</a><a href="#h239-0-170" id="h239-0-170" class="i">+    }
</a><a href="#h239-0-171" id="h239-0-171" class="i">+
</a><a href="#h239-0-172" id="h239-0-172" class="i">+    fun sendCustomChatMessage(conversations: List&lt;SnapUUID&gt;, contentType: ContentType, message: ProtoWriter.() -&gt; Unit, onError: (Any) -&gt; Unit = {}, onSuccess: () -&gt; Unit = {}) {
</a><a href="#h239-0-173" id="h239-0-173" class="i">+        internalSendMessage(conversations, createLocalMessageContentTemplate(contentType, ProtoWriter().apply {
</a><a href="#h239-0-174" id="h239-0-174" class="i">+            message()
</a><a href="#h239-0-175" id="h239-0-175" class="i">+        }.toByteArray(), savePolicy = &quot;LIFETIME&quot;), CallbackBuilder(sendMessageCallback)
</a><a href="#h239-0-176" id="h239-0-176" class="i">+            .override(&quot;onSuccess&quot;, callback = { onSuccess() })
</a><a href="#h239-0-177" id="h239-0-177" class="i">+            .override(&quot;onError&quot;, callback = { onError(it.arg(0)) })
</a><a href="#h239-0-178" id="h239-0-178" class="i">+            .build())
</a><a href="#h239-0-179" id="h239-0-179" class="i">+    }
</a><a href="#h239-0-180" id="h239-0-180" class="i">+}</a><a href="#h239-0-181" id="h239-0-181" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h240" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/messaging/MessagingCoreObjects.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/messaging/MessagingCoreObjects.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/messaging/MessagingCoreObjects.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/messaging/MessagingCoreObjects.kt</a></b>
<a href="#h240-0" id="h240-0" class="h">@@ -1,73 +0,0 @@
</a><a href="#h240-0-0" id="h240-0-0" class="d">-package me.rhunk.snapenhance.core.messaging
</a><a href="#h240-0-1" id="h240-0-1" class="d">-
</a><a href="#h240-0-2" id="h240-0-2" class="d">-import me.rhunk.snapenhance.core.util.SerializableDataObject
</a><a href="#h240-0-3" id="h240-0-3" class="d">-
</a><a href="#h240-0-4" id="h240-0-4" class="d">-
</a><a href="#h240-0-5" id="h240-0-5" class="d">-enum class RuleState(
</a><a href="#h240-0-6" id="h240-0-6" class="d">-    val key: String
</a><a href="#h240-0-7" id="h240-0-7" class="d">-) {
</a><a href="#h240-0-8" id="h240-0-8" class="d">-    BLACKLIST(&quot;blacklist&quot;),
</a><a href="#h240-0-9" id="h240-0-9" class="d">-    WHITELIST(&quot;whitelist&quot;);
</a><a href="#h240-0-10" id="h240-0-10" class="d">-
</a><a href="#h240-0-11" id="h240-0-11" class="d">-    companion object {
</a><a href="#h240-0-12" id="h240-0-12" class="d">-        fun getByName(name: String) = entries.first { it.key == name }
</a><a href="#h240-0-13" id="h240-0-13" class="d">-    }
</a><a href="#h240-0-14" id="h240-0-14" class="d">-}
</a><a href="#h240-0-15" id="h240-0-15" class="d">-
</a><a href="#h240-0-16" id="h240-0-16" class="d">-enum class SocialScope(
</a><a href="#h240-0-17" id="h240-0-17" class="d">-    val key: String,
</a><a href="#h240-0-18" id="h240-0-18" class="d">-    val tabRoute: String,
</a><a href="#h240-0-19" id="h240-0-19" class="d">-) {
</a><a href="#h240-0-20" id="h240-0-20" class="d">-    FRIEND(&quot;friend&quot;, &quot;friend_info/{id}&quot;),
</a><a href="#h240-0-21" id="h240-0-21" class="d">-    GROUP(&quot;group&quot;, &quot;group_info/{id}&quot;);
</a><a href="#h240-0-22" id="h240-0-22" class="d">-
</a><a href="#h240-0-23" id="h240-0-23" class="d">-    companion object {
</a><a href="#h240-0-24" id="h240-0-24" class="d">-        fun getByName(name: String) = entries.first { it.key == name }
</a><a href="#h240-0-25" id="h240-0-25" class="d">-    }
</a><a href="#h240-0-26" id="h240-0-26" class="d">-}
</a><a href="#h240-0-27" id="h240-0-27" class="d">-
</a><a href="#h240-0-28" id="h240-0-28" class="d">-enum class MessagingRuleType(
</a><a href="#h240-0-29" id="h240-0-29" class="d">-    val key: String,
</a><a href="#h240-0-30" id="h240-0-30" class="d">-    val listMode: Boolean,
</a><a href="#h240-0-31" id="h240-0-31" class="d">-    val showInFriendMenu: Boolean = true
</a><a href="#h240-0-32" id="h240-0-32" class="d">-) {
</a><a href="#h240-0-33" id="h240-0-33" class="d">-    AUTO_DOWNLOAD(&quot;auto_download&quot;, true),
</a><a href="#h240-0-34" id="h240-0-34" class="d">-    STEALTH(&quot;stealth&quot;, true),
</a><a href="#h240-0-35" id="h240-0-35" class="d">-    AUTO_SAVE(&quot;auto_save&quot;, true),
</a><a href="#h240-0-36" id="h240-0-36" class="d">-    HIDE_CHAT_FEED(&quot;hide_chat_feed&quot;, false, showInFriendMenu = false),
</a><a href="#h240-0-37" id="h240-0-37" class="d">-    E2E_ENCRYPTION(&quot;e2e_encryption&quot;, false),
</a><a href="#h240-0-38" id="h240-0-38" class="d">-    PIN_CONVERSATION(&quot;pin_conversation&quot;, false, showInFriendMenu = false);
</a><a href="#h240-0-39" id="h240-0-39" class="d">-
</a><a href="#h240-0-40" id="h240-0-40" class="d">-    fun translateOptionKey(optionKey: String): String {
</a><a href="#h240-0-41" id="h240-0-41" class="d">-        return if (listMode) &quot;rules.properties.$key.options.$optionKey&quot; else &quot;rules.properties.$key.name&quot;
</a><a href="#h240-0-42" id="h240-0-42" class="d">-    }
</a><a href="#h240-0-43" id="h240-0-43" class="d">-
</a><a href="#h240-0-44" id="h240-0-44" class="d">-    companion object {
</a><a href="#h240-0-45" id="h240-0-45" class="d">-        fun getByName(name: String) = entries.firstOrNull { it.key == name }
</a><a href="#h240-0-46" id="h240-0-46" class="d">-    }
</a><a href="#h240-0-47" id="h240-0-47" class="d">-}
</a><a href="#h240-0-48" id="h240-0-48" class="d">-
</a><a href="#h240-0-49" id="h240-0-49" class="d">-data class FriendStreaks(
</a><a href="#h240-0-50" id="h240-0-50" class="d">-    val userId: String,
</a><a href="#h240-0-51" id="h240-0-51" class="d">-    val notify: Boolean,
</a><a href="#h240-0-52" id="h240-0-52" class="d">-    val expirationTimestamp: Long,
</a><a href="#h240-0-53" id="h240-0-53" class="d">-    val length: Int
</a><a href="#h240-0-54" id="h240-0-54" class="d">-) : SerializableDataObject() {
</a><a href="#h240-0-55" id="h240-0-55" class="d">-    fun hoursLeft() = (expirationTimestamp - System.currentTimeMillis()) / 1000 / 60 / 60
</a><a href="#h240-0-56" id="h240-0-56" class="d">-
</a><a href="#h240-0-57" id="h240-0-57" class="d">-    fun isAboutToExpire(expireHours: Int) = expirationTimestamp - System.currentTimeMillis() &lt; expireHours * 60 * 60 * 1000
</a><a href="#h240-0-58" id="h240-0-58" class="d">-}
</a><a href="#h240-0-59" id="h240-0-59" class="d">-
</a><a href="#h240-0-60" id="h240-0-60" class="d">-data class MessagingGroupInfo(
</a><a href="#h240-0-61" id="h240-0-61" class="d">-    val conversationId: String,
</a><a href="#h240-0-62" id="h240-0-62" class="d">-    val name: String,
</a><a href="#h240-0-63" id="h240-0-63" class="d">-    val participantsCount: Int
</a><a href="#h240-0-64" id="h240-0-64" class="d">-) : SerializableDataObject()
</a><a href="#h240-0-65" id="h240-0-65" class="d">-
</a><a href="#h240-0-66" id="h240-0-66" class="d">-data class MessagingFriendInfo(
</a><a href="#h240-0-67" id="h240-0-67" class="d">-    val userId: String,
</a><a href="#h240-0-68" id="h240-0-68" class="d">-    val displayName: String?,
</a><a href="#h240-0-69" id="h240-0-69" class="d">-    val mutableUsername: String,
</a><a href="#h240-0-70" id="h240-0-70" class="d">-    val bitmojiId: String?,
</a><a href="#h240-0-71" id="h240-0-71" class="d">-    val selfieId: String?
</a><a href="#h240-0-72" id="h240-0-72" class="d">-) : SerializableDataObject()
</a><b>diff --git a/<a id="h241" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/scripting/CoreScriptRuntime.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/scripting/CoreScriptRuntime.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/scripting/CoreScriptRuntime.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/scripting/CoreScriptRuntime.kt</a></b>
<a href="#h241-0" id="h241-0" class="h">@@ -0,0 +1,56 @@
</a><a href="#h241-0-0" id="h241-0-0" class="i">+package me.rhunk.snapenhance.core.scripting
</a><a href="#h241-0-1" id="h241-0-1" class="i">+
</a><a href="#h241-0-2" id="h241-0-2" class="i">+import android.content.Context
</a><a href="#h241-0-3" id="h241-0-3" class="i">+import me.rhunk.snapenhance.bridge.scripting.IPCListener
</a><a href="#h241-0-4" id="h241-0-4" class="i">+import me.rhunk.snapenhance.bridge.scripting.IScripting
</a><a href="#h241-0-5" id="h241-0-5" class="i">+import me.rhunk.snapenhance.common.logger.AbstractLogger
</a><a href="#h241-0-6" id="h241-0-6" class="i">+import me.rhunk.snapenhance.common.scripting.IPCInterface
</a><a href="#h241-0-7" id="h241-0-7" class="i">+import me.rhunk.snapenhance.common.scripting.Listener
</a><a href="#h241-0-8" id="h241-0-8" class="i">+import me.rhunk.snapenhance.common.scripting.ScriptRuntime
</a><a href="#h241-0-9" id="h241-0-9" class="i">+import me.rhunk.snapenhance.core.scripting.impl.ScriptHooker
</a><a href="#h241-0-10" id="h241-0-10" class="i">+
</a><a href="#h241-0-11" id="h241-0-11" class="i">+class CoreScriptRuntime(
</a><a href="#h241-0-12" id="h241-0-12" class="i">+    androidContext: Context,
</a><a href="#h241-0-13" id="h241-0-13" class="i">+    logger: AbstractLogger,
</a><a href="#h241-0-14" id="h241-0-14" class="i">+): ScriptRuntime(androidContext, logger) {
</a><a href="#h241-0-15" id="h241-0-15" class="i">+    private val scriptHookers = mutableListOf&lt;ScriptHooker&gt;()
</a><a href="#h241-0-16" id="h241-0-16" class="i">+
</a><a href="#h241-0-17" id="h241-0-17" class="i">+    fun connect(scriptingInterface: IScripting) {
</a><a href="#h241-0-18" id="h241-0-18" class="i">+        scriptingInterface.apply {
</a><a href="#h241-0-19" id="h241-0-19" class="i">+            buildModuleObject = { module -&gt;
</a><a href="#h241-0-20" id="h241-0-20" class="i">+                putConst(&quot;ipc&quot;, this, object: IPCInterface() {
</a><a href="#h241-0-21" id="h241-0-21" class="i">+                    override fun onBroadcast(channel: String, eventName: String, listener: Listener) {
</a><a href="#h241-0-22" id="h241-0-22" class="i">+                        registerIPCListener(channel, eventName, object: IPCListener.Stub() {
</a><a href="#h241-0-23" id="h241-0-23" class="i">+                            override fun onMessage(args: Array&lt;out String?&gt;) {
</a><a href="#h241-0-24" id="h241-0-24" class="i">+                                listener(args)
</a><a href="#h241-0-25" id="h241-0-25" class="i">+                            }
</a><a href="#h241-0-26" id="h241-0-26" class="i">+                        })
</a><a href="#h241-0-27" id="h241-0-27" class="i">+                    }
</a><a href="#h241-0-28" id="h241-0-28" class="i">+
</a><a href="#h241-0-29" id="h241-0-29" class="i">+                    override fun on(eventName: String, listener: Listener) {
</a><a href="#h241-0-30" id="h241-0-30" class="i">+                        onBroadcast(module.moduleInfo.name, eventName, listener)
</a><a href="#h241-0-31" id="h241-0-31" class="i">+                    }
</a><a href="#h241-0-32" id="h241-0-32" class="i">+
</a><a href="#h241-0-33" id="h241-0-33" class="i">+                    override fun emit(eventName: String, vararg args: String?) {
</a><a href="#h241-0-34" id="h241-0-34" class="i">+                        broadcast(module.moduleInfo.name, eventName, *args)
</a><a href="#h241-0-35" id="h241-0-35" class="i">+                    }
</a><a href="#h241-0-36" id="h241-0-36" class="i">+
</a><a href="#h241-0-37" id="h241-0-37" class="i">+                    override fun broadcast(channel: String, eventName: String, vararg args: String?) {
</a><a href="#h241-0-38" id="h241-0-38" class="i">+                        sendIPCMessage(channel, eventName, args)
</a><a href="#h241-0-39" id="h241-0-39" class="i">+                    }
</a><a href="#h241-0-40" id="h241-0-40" class="i">+                })
</a><a href="#h241-0-41" id="h241-0-41" class="i">+                putConst(&quot;hooker&quot;, this, ScriptHooker(module.moduleInfo, logger, androidContext.classLoader).also {
</a><a href="#h241-0-42" id="h241-0-42" class="i">+                    scriptHookers.add(it)
</a><a href="#h241-0-43" id="h241-0-43" class="i">+                })
</a><a href="#h241-0-44" id="h241-0-44" class="i">+            }
</a><a href="#h241-0-45" id="h241-0-45" class="i">+        }
</a><a href="#h241-0-46" id="h241-0-46" class="i">+
</a><a href="#h241-0-47" id="h241-0-47" class="i">+        scriptingInterface.enabledScripts.forEach { path -&gt;
</a><a href="#h241-0-48" id="h241-0-48" class="i">+            runCatching {
</a><a href="#h241-0-49" id="h241-0-49" class="i">+                load(path, scriptingInterface.getScriptContent(path))
</a><a href="#h241-0-50" id="h241-0-50" class="i">+            }.onFailure {
</a><a href="#h241-0-51" id="h241-0-51" class="i">+                logger.error(&quot;Failed to load script $path&quot;, it)
</a><a href="#h241-0-52" id="h241-0-52" class="i">+            }
</a><a href="#h241-0-53" id="h241-0-53" class="i">+        }
</a><a href="#h241-0-54" id="h241-0-54" class="i">+    }
</a><a href="#h241-0-55" id="h241-0-55" class="i">+}</a><a href="#h241-0-56" id="h241-0-56" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h242" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/scripting/impl/ScriptHooker.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/scripting/impl/ScriptHooker.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/scripting/impl/ScriptHooker.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/scripting/impl/ScriptHooker.kt</a></b>
<a href="#h242-0" id="h242-0" class="h">@@ -0,0 +1,161 @@
</a><a href="#h242-0-0" id="h242-0-0" class="i">+package me.rhunk.snapenhance.core.scripting.impl
</a><a href="#h242-0-1" id="h242-0-1" class="i">+
</a><a href="#h242-0-2" id="h242-0-2" class="i">+import me.rhunk.snapenhance.common.logger.AbstractLogger
</a><a href="#h242-0-3" id="h242-0-3" class="i">+import me.rhunk.snapenhance.common.scripting.toPrimitiveValue
</a><a href="#h242-0-4" id="h242-0-4" class="i">+import me.rhunk.snapenhance.common.scripting.type.ModuleInfo
</a><a href="#h242-0-5" id="h242-0-5" class="i">+import me.rhunk.snapenhance.core.util.hook.HookAdapter
</a><a href="#h242-0-6" id="h242-0-6" class="i">+import me.rhunk.snapenhance.core.util.hook.HookStage
</a><a href="#h242-0-7" id="h242-0-7" class="i">+import me.rhunk.snapenhance.core.util.hook.Hooker
</a><a href="#h242-0-8" id="h242-0-8" class="i">+import me.rhunk.snapenhance.core.util.hook.hook
</a><a href="#h242-0-9" id="h242-0-9" class="i">+import me.rhunk.snapenhance.core.util.hook.hookConstructor
</a><a href="#h242-0-10" id="h242-0-10" class="i">+import org.mozilla.javascript.annotations.JSGetter
</a><a href="#h242-0-11" id="h242-0-11" class="i">+import org.mozilla.javascript.annotations.JSSetter
</a><a href="#h242-0-12" id="h242-0-12" class="i">+import java.lang.reflect.Constructor
</a><a href="#h242-0-13" id="h242-0-13" class="i">+import java.lang.reflect.Member
</a><a href="#h242-0-14" id="h242-0-14" class="i">+import java.lang.reflect.Method
</a><a href="#h242-0-15" id="h242-0-15" class="i">+
</a><a href="#h242-0-16" id="h242-0-16" class="i">+
</a><a href="#h242-0-17" id="h242-0-17" class="i">+class ScriptHookCallback(
</a><a href="#h242-0-18" id="h242-0-18" class="i">+    private val hookAdapter: HookAdapter
</a><a href="#h242-0-19" id="h242-0-19" class="i">+) {
</a><a href="#h242-0-20" id="h242-0-20" class="i">+    var result
</a><a href="#h242-0-21" id="h242-0-21" class="i">+        @JSGetter(&quot;result&quot;) get() = hookAdapter.getResult()
</a><a href="#h242-0-22" id="h242-0-22" class="i">+        @JSSetter(&quot;result&quot;) set(result) = hookAdapter.setResult(result.toPrimitiveValue(lazy {
</a><a href="#h242-0-23" id="h242-0-23" class="i">+            when (val member = hookAdapter.method()) {
</a><a href="#h242-0-24" id="h242-0-24" class="i">+                is Method -&gt; member.returnType.name
</a><a href="#h242-0-25" id="h242-0-25" class="i">+                else -&gt; &quot;void&quot;
</a><a href="#h242-0-26" id="h242-0-26" class="i">+            }
</a><a href="#h242-0-27" id="h242-0-27" class="i">+        }))
</a><a href="#h242-0-28" id="h242-0-28" class="i">+
</a><a href="#h242-0-29" id="h242-0-29" class="i">+    val thisObject
</a><a href="#h242-0-30" id="h242-0-30" class="i">+        @JSGetter(&quot;thisObject&quot;) get() = hookAdapter.nullableThisObject&lt;Any&gt;()
</a><a href="#h242-0-31" id="h242-0-31" class="i">+
</a><a href="#h242-0-32" id="h242-0-32" class="i">+    val method
</a><a href="#h242-0-33" id="h242-0-33" class="i">+        @JSGetter(&quot;method&quot;) get() = hookAdapter.method()
</a><a href="#h242-0-34" id="h242-0-34" class="i">+
</a><a href="#h242-0-35" id="h242-0-35" class="i">+    val args
</a><a href="#h242-0-36" id="h242-0-36" class="i">+        @JSGetter(&quot;args&quot;) get() = hookAdapter.args().toList()
</a><a href="#h242-0-37" id="h242-0-37" class="i">+
</a><a href="#h242-0-38" id="h242-0-38" class="i">+    private val parameterTypes by lazy {
</a><a href="#h242-0-39" id="h242-0-39" class="i">+        when (val member = hookAdapter.method()) {
</a><a href="#h242-0-40" id="h242-0-40" class="i">+            is Method -&gt; member.parameterTypes
</a><a href="#h242-0-41" id="h242-0-41" class="i">+            is Constructor&lt;*&gt; -&gt; member.parameterTypes
</a><a href="#h242-0-42" id="h242-0-42" class="i">+            else -&gt; emptyArray()
</a><a href="#h242-0-43" id="h242-0-43" class="i">+        }.toList()
</a><a href="#h242-0-44" id="h242-0-44" class="i">+    }
</a><a href="#h242-0-45" id="h242-0-45" class="i">+
</a><a href="#h242-0-46" id="h242-0-46" class="i">+    fun cancel() = hookAdapter.setResult(null)
</a><a href="#h242-0-47" id="h242-0-47" class="i">+
</a><a href="#h242-0-48" id="h242-0-48" class="i">+    fun arg(index: Int) = hookAdapter.argNullable&lt;Any&gt;(index)
</a><a href="#h242-0-49" id="h242-0-49" class="i">+
</a><a href="#h242-0-50" id="h242-0-50" class="i">+    fun setArg(index: Int, value: Any) {
</a><a href="#h242-0-51" id="h242-0-51" class="i">+        hookAdapter.setArg(index, value.toPrimitiveValue(lazy { parameterTypes[index].name }))
</a><a href="#h242-0-52" id="h242-0-52" class="i">+    }
</a><a href="#h242-0-53" id="h242-0-53" class="i">+
</a><a href="#h242-0-54" id="h242-0-54" class="i">+    fun invokeOriginal() = hookAdapter.invokeOriginal()
</a><a href="#h242-0-55" id="h242-0-55" class="i">+
</a><a href="#h242-0-56" id="h242-0-56" class="i">+    fun invokeOriginal(args: Array&lt;Any&gt;) = hookAdapter.invokeOriginal(args.map {
</a><a href="#h242-0-57" id="h242-0-57" class="i">+        it.toPrimitiveValue(lazy { parameterTypes[args.indexOf(it)].name }) ?: it
</a><a href="#h242-0-58" id="h242-0-58" class="i">+    }.toTypedArray())
</a><a href="#h242-0-59" id="h242-0-59" class="i">+
</a><a href="#h242-0-60" id="h242-0-60" class="i">+    override fun toString(): String {
</a><a href="#h242-0-61" id="h242-0-61" class="i">+        return &quot;ScriptHookCallback(\n&quot; +
</a><a href="#h242-0-62" id="h242-0-62" class="i">+                &quot;  thisObject=${ runCatching { thisObject.toString() }.getOrNull() },\n&quot; +
</a><a href="#h242-0-63" id="h242-0-63" class="i">+                &quot;  args=${ runCatching { args.toString() }.getOrNull() }\n&quot; +
</a><a href="#h242-0-64" id="h242-0-64" class="i">+                &quot;  result=${ runCatching { result.toString() }.getOrNull() },\n&quot; +
</a><a href="#h242-0-65" id="h242-0-65" class="i">+                &quot;)&quot;
</a><a href="#h242-0-66" id="h242-0-66" class="i">+    }
</a><a href="#h242-0-67" id="h242-0-67" class="i">+}
</a><a href="#h242-0-68" id="h242-0-68" class="i">+
</a><a href="#h242-0-69" id="h242-0-69" class="i">+
</a><a href="#h242-0-70" id="h242-0-70" class="i">+typealias HookCallback = (ScriptHookCallback) -&gt; Unit
</a><a href="#h242-0-71" id="h242-0-71" class="i">+typealias HookUnhook = () -&gt; Unit
</a><a href="#h242-0-72" id="h242-0-72" class="i">+
</a><a href="#h242-0-73" id="h242-0-73" class="i">+@Suppress(&quot;unused&quot;, &quot;MemberVisibilityCanBePrivate&quot;)
</a><a href="#h242-0-74" id="h242-0-74" class="i">+class ScriptHooker(
</a><a href="#h242-0-75" id="h242-0-75" class="i">+    private val moduleInfo: ModuleInfo,
</a><a href="#h242-0-76" id="h242-0-76" class="i">+    private val logger: AbstractLogger,
</a><a href="#h242-0-77" id="h242-0-77" class="i">+    private val classLoader: ClassLoader
</a><a href="#h242-0-78" id="h242-0-78" class="i">+) {
</a><a href="#h242-0-79" id="h242-0-79" class="i">+    private val hooks = mutableListOf&lt;HookUnhook&gt;()
</a><a href="#h242-0-80" id="h242-0-80" class="i">+
</a><a href="#h242-0-81" id="h242-0-81" class="i">+    // -- search for class members
</a><a href="#h242-0-82" id="h242-0-82" class="i">+
</a><a href="#h242-0-83" id="h242-0-83" class="i">+    private fun findClassSafe(className: String): Class&lt;*&gt;? {
</a><a href="#h242-0-84" id="h242-0-84" class="i">+        return runCatching {
</a><a href="#h242-0-85" id="h242-0-85" class="i">+            classLoader.loadClass(className)
</a><a href="#h242-0-86" id="h242-0-86" class="i">+        }.onFailure {
</a><a href="#h242-0-87" id="h242-0-87" class="i">+            logger.warn(&quot;Failed to load class $className&quot;)
</a><a href="#h242-0-88" id="h242-0-88" class="i">+        }.getOrNull()
</a><a href="#h242-0-89" id="h242-0-89" class="i">+    }
</a><a href="#h242-0-90" id="h242-0-90" class="i">+
</a><a href="#h242-0-91" id="h242-0-91" class="i">+    private fun getHookStageFromString(stage: String): HookStage {
</a><a href="#h242-0-92" id="h242-0-92" class="i">+        return when (stage) {
</a><a href="#h242-0-93" id="h242-0-93" class="i">+            &quot;before&quot; -&gt; HookStage.BEFORE
</a><a href="#h242-0-94" id="h242-0-94" class="i">+            &quot;after&quot; -&gt; HookStage.AFTER
</a><a href="#h242-0-95" id="h242-0-95" class="i">+            else -&gt; throw IllegalArgumentException(&quot;Invalid stage: $stage&quot;)
</a><a href="#h242-0-96" id="h242-0-96" class="i">+        }
</a><a href="#h242-0-97" id="h242-0-97" class="i">+    }
</a><a href="#h242-0-98" id="h242-0-98" class="i">+
</a><a href="#h242-0-99" id="h242-0-99" class="i">+    fun findMethod(clazz: Class&lt;*&gt;, methodName: String): Member? {
</a><a href="#h242-0-100" id="h242-0-100" class="i">+        return clazz.declaredMethods.find { it.name == methodName }
</a><a href="#h242-0-101" id="h242-0-101" class="i">+    }
</a><a href="#h242-0-102" id="h242-0-102" class="i">+
</a><a href="#h242-0-103" id="h242-0-103" class="i">+    fun findMethodWithParameters(clazz: Class&lt;*&gt;, methodName: String, vararg types: String): Member? {
</a><a href="#h242-0-104" id="h242-0-104" class="i">+        return clazz.declaredMethods.find { method -&gt; method.name == methodName &amp;&amp; method.parameterTypes.map { it.name }.toTypedArray() contentEquals types }
</a><a href="#h242-0-105" id="h242-0-105" class="i">+    }
</a><a href="#h242-0-106" id="h242-0-106" class="i">+
</a><a href="#h242-0-107" id="h242-0-107" class="i">+    fun findMethod(className: String, methodName: String): Member? {
</a><a href="#h242-0-108" id="h242-0-108" class="i">+        return findClassSafe(className)?.let { findMethod(it, methodName) }
</a><a href="#h242-0-109" id="h242-0-109" class="i">+    }
</a><a href="#h242-0-110" id="h242-0-110" class="i">+
</a><a href="#h242-0-111" id="h242-0-111" class="i">+    fun findMethodWithParameters(className: String, methodName: String, vararg types: String): Member? {
</a><a href="#h242-0-112" id="h242-0-112" class="i">+        return findClassSafe(className)?.let { findMethodWithParameters(it, methodName, *types) }
</a><a href="#h242-0-113" id="h242-0-113" class="i">+    }
</a><a href="#h242-0-114" id="h242-0-114" class="i">+
</a><a href="#h242-0-115" id="h242-0-115" class="i">+    fun findConstructor(clazz: Class&lt;*&gt;, vararg types: String): Member? {
</a><a href="#h242-0-116" id="h242-0-116" class="i">+        return clazz.declaredConstructors.find { constructor -&gt;  constructor.parameterTypes.map { it.name }.toTypedArray() contentEquals types }
</a><a href="#h242-0-117" id="h242-0-117" class="i">+    }
</a><a href="#h242-0-118" id="h242-0-118" class="i">+
</a><a href="#h242-0-119" id="h242-0-119" class="i">+    fun findConstructorParameters(className: String, vararg types: String): Member? {
</a><a href="#h242-0-120" id="h242-0-120" class="i">+        return findClassSafe(className)?.let { findConstructor(it, *types) }
</a><a href="#h242-0-121" id="h242-0-121" class="i">+    }
</a><a href="#h242-0-122" id="h242-0-122" class="i">+
</a><a href="#h242-0-123" id="h242-0-123" class="i">+    // -- hooking
</a><a href="#h242-0-124" id="h242-0-124" class="i">+
</a><a href="#h242-0-125" id="h242-0-125" class="i">+    fun hook(method: Member, stage: String, callback: HookCallback): HookUnhook {
</a><a href="#h242-0-126" id="h242-0-126" class="i">+        val hookAdapter = Hooker.hook(method, getHookStageFromString(stage)) {
</a><a href="#h242-0-127" id="h242-0-127" class="i">+            callback(ScriptHookCallback(it))
</a><a href="#h242-0-128" id="h242-0-128" class="i">+        }
</a><a href="#h242-0-129" id="h242-0-129" class="i">+
</a><a href="#h242-0-130" id="h242-0-130" class="i">+        return {
</a><a href="#h242-0-131" id="h242-0-131" class="i">+            hookAdapter.unhook()
</a><a href="#h242-0-132" id="h242-0-132" class="i">+        }.also { hooks.add(it) }
</a><a href="#h242-0-133" id="h242-0-133" class="i">+    }
</a><a href="#h242-0-134" id="h242-0-134" class="i">+
</a><a href="#h242-0-135" id="h242-0-135" class="i">+    fun hookAllMethods(clazz: Class&lt;*&gt;, methodName: String, stage: String, callback: HookCallback): HookUnhook {
</a><a href="#h242-0-136" id="h242-0-136" class="i">+        val hookAdapter = clazz.hook(methodName, getHookStageFromString(stage)) {
</a><a href="#h242-0-137" id="h242-0-137" class="i">+            callback(ScriptHookCallback(it))
</a><a href="#h242-0-138" id="h242-0-138" class="i">+        }
</a><a href="#h242-0-139" id="h242-0-139" class="i">+
</a><a href="#h242-0-140" id="h242-0-140" class="i">+        return {
</a><a href="#h242-0-141" id="h242-0-141" class="i">+            hookAdapter.forEach { it.unhook() }
</a><a href="#h242-0-142" id="h242-0-142" class="i">+        }.also { hooks.add(it) }
</a><a href="#h242-0-143" id="h242-0-143" class="i">+    }
</a><a href="#h242-0-144" id="h242-0-144" class="i">+
</a><a href="#h242-0-145" id="h242-0-145" class="i">+    fun hookAllConstructors(clazz: Class&lt;*&gt;, stage: String, callback: HookCallback): HookUnhook {
</a><a href="#h242-0-146" id="h242-0-146" class="i">+        val hookAdapter = clazz.hookConstructor(getHookStageFromString(stage)) {
</a><a href="#h242-0-147" id="h242-0-147" class="i">+            callback(ScriptHookCallback(it))
</a><a href="#h242-0-148" id="h242-0-148" class="i">+        }
</a><a href="#h242-0-149" id="h242-0-149" class="i">+
</a><a href="#h242-0-150" id="h242-0-150" class="i">+        return {
</a><a href="#h242-0-151" id="h242-0-151" class="i">+            hookAdapter.forEach { it.unhook() }
</a><a href="#h242-0-152" id="h242-0-152" class="i">+        }.also { hooks.add(it) }
</a><a href="#h242-0-153" id="h242-0-153" class="i">+    }
</a><a href="#h242-0-154" id="h242-0-154" class="i">+
</a><a href="#h242-0-155" id="h242-0-155" class="i">+    fun hookAllMethods(className: String, methodName: String, stage: String, callback: HookCallback)
</a><a href="#h242-0-156" id="h242-0-156" class="i">+        = findClassSafe(className)?.let { hookAllMethods(it, methodName, stage, callback) }
</a><a href="#h242-0-157" id="h242-0-157" class="i">+
</a><a href="#h242-0-158" id="h242-0-158" class="i">+    fun hookAllConstructors(className: String, stage: String, callback: HookCallback)
</a><a href="#h242-0-159" id="h242-0-159" class="i">+        = findClassSafe(className)?.let { hookAllConstructors(it, stage, callback) }
</a><a href="#h242-0-160" id="h242-0-160" class="i">+}</a><a href="#h242-0-161" id="h242-0-161" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h243" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/ui/ViewAppearanceHelper.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/ViewAppearanceHelper.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/ui/ViewAppearanceHelper.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/ViewAppearanceHelper.kt</a></b>
<a href="#h243-0" id="h243-0" class="h">@@ -0,0 +1,141 @@
</a><a href="#h243-0-0" id="h243-0-0" class="i">+package me.rhunk.snapenhance.core.ui
</a><a href="#h243-0-1" id="h243-0-1" class="i">+
</a><a href="#h243-0-2" id="h243-0-2" class="i">+import android.annotation.SuppressLint
</a><a href="#h243-0-3" id="h243-0-3" class="i">+import android.app.AlertDialog
</a><a href="#h243-0-4" id="h243-0-4" class="i">+import android.content.Context
</a><a href="#h243-0-5" id="h243-0-5" class="i">+import android.content.res.ColorStateList
</a><a href="#h243-0-6" id="h243-0-6" class="i">+import android.graphics.Canvas
</a><a href="#h243-0-7" id="h243-0-7" class="i">+import android.graphics.Color
</a><a href="#h243-0-8" id="h243-0-8" class="i">+import android.graphics.Paint
</a><a href="#h243-0-9" id="h243-0-9" class="i">+import android.graphics.drawable.ColorDrawable
</a><a href="#h243-0-10" id="h243-0-10" class="i">+import android.graphics.drawable.Drawable
</a><a href="#h243-0-11" id="h243-0-11" class="i">+import android.graphics.drawable.ShapeDrawable
</a><a href="#h243-0-12" id="h243-0-12" class="i">+import android.graphics.drawable.StateListDrawable
</a><a href="#h243-0-13" id="h243-0-13" class="i">+import android.graphics.drawable.shapes.Shape
</a><a href="#h243-0-14" id="h243-0-14" class="i">+import android.view.Gravity
</a><a href="#h243-0-15" id="h243-0-15" class="i">+import android.view.View
</a><a href="#h243-0-16" id="h243-0-16" class="i">+import android.widget.Switch
</a><a href="#h243-0-17" id="h243-0-17" class="i">+import android.widget.TextView
</a><a href="#h243-0-18" id="h243-0-18" class="i">+import me.rhunk.snapenhance.common.Constants
</a><a href="#h243-0-19" id="h243-0-19" class="i">+import kotlin.random.Random
</a><a href="#h243-0-20" id="h243-0-20" class="i">+
</a><a href="#h243-0-21" id="h243-0-21" class="i">+fun View.applyTheme(componentWidth: Int? = null, hasRadius: Boolean = false, isAmoled: Boolean = true) {
</a><a href="#h243-0-22" id="h243-0-22" class="i">+    ViewAppearanceHelper.applyTheme(this, componentWidth, hasRadius, isAmoled)
</a><a href="#h243-0-23" id="h243-0-23" class="i">+}
</a><a href="#h243-0-24" id="h243-0-24" class="i">+
</a><a href="#h243-0-25" id="h243-0-25" class="i">+private val foregroundDrawableListTag = Random.nextInt(0x7000000, 0x7FFFFFFF)
</a><a href="#h243-0-26" id="h243-0-26" class="i">+
</a><a href="#h243-0-27" id="h243-0-27" class="i">+@Suppress(&quot;UNCHECKED_CAST&quot;)
</a><a href="#h243-0-28" id="h243-0-28" class="i">+private fun View.getForegroundDrawables(): MutableMap&lt;String, Drawable&gt; {
</a><a href="#h243-0-29" id="h243-0-29" class="i">+    return getTag(foregroundDrawableListTag) as? MutableMap&lt;String, Drawable&gt;
</a><a href="#h243-0-30" id="h243-0-30" class="i">+        ?: mutableMapOf&lt;String, Drawable&gt;().also {
</a><a href="#h243-0-31" id="h243-0-31" class="i">+        setTag(foregroundDrawableListTag, it)
</a><a href="#h243-0-32" id="h243-0-32" class="i">+    }
</a><a href="#h243-0-33" id="h243-0-33" class="i">+}
</a><a href="#h243-0-34" id="h243-0-34" class="i">+
</a><a href="#h243-0-35" id="h243-0-35" class="i">+private fun View.updateForegroundDrawable() {
</a><a href="#h243-0-36" id="h243-0-36" class="i">+    foreground = ShapeDrawable(object: Shape() {
</a><a href="#h243-0-37" id="h243-0-37" class="i">+        override fun draw(canvas: Canvas, paint: Paint) {
</a><a href="#h243-0-38" id="h243-0-38" class="i">+            getForegroundDrawables().forEach { (_, drawable) -&gt;
</a><a href="#h243-0-39" id="h243-0-39" class="i">+                drawable.draw(canvas)
</a><a href="#h243-0-40" id="h243-0-40" class="i">+            }
</a><a href="#h243-0-41" id="h243-0-41" class="i">+        }
</a><a href="#h243-0-42" id="h243-0-42" class="i">+    })
</a><a href="#h243-0-43" id="h243-0-43" class="i">+}
</a><a href="#h243-0-44" id="h243-0-44" class="i">+
</a><a href="#h243-0-45" id="h243-0-45" class="i">+fun View.removeForegroundDrawable(tag: String) {
</a><a href="#h243-0-46" id="h243-0-46" class="i">+    getForegroundDrawables().remove(tag)?.let {
</a><a href="#h243-0-47" id="h243-0-47" class="i">+        updateForegroundDrawable()
</a><a href="#h243-0-48" id="h243-0-48" class="i">+    }
</a><a href="#h243-0-49" id="h243-0-49" class="i">+}
</a><a href="#h243-0-50" id="h243-0-50" class="i">+
</a><a href="#h243-0-51" id="h243-0-51" class="i">+fun View.addForegroundDrawable(tag: String, drawable: Drawable) {
</a><a href="#h243-0-52" id="h243-0-52" class="i">+    getForegroundDrawables()[tag] = drawable
</a><a href="#h243-0-53" id="h243-0-53" class="i">+    updateForegroundDrawable()
</a><a href="#h243-0-54" id="h243-0-54" class="i">+}
</a><a href="#h243-0-55" id="h243-0-55" class="i">+
</a><a href="#h243-0-56" id="h243-0-56" class="i">+
</a><a href="#h243-0-57" id="h243-0-57" class="i">+object ViewAppearanceHelper {
</a><a href="#h243-0-58" id="h243-0-58" class="i">+    @SuppressLint(&quot;UseSwitchCompatOrMaterialCode&quot;, &quot;RtlHardcoded&quot;, &quot;DiscouragedApi&quot;,
</a><a href="#h243-0-59" id="h243-0-59" class="i">+        &quot;ClickableViewAccessibility&quot;
</a><a href="#h243-0-60" id="h243-0-60" class="i">+    )
</a><a href="#h243-0-61" id="h243-0-61" class="i">+    private var sigColorTextPrimary: Int = 0
</a><a href="#h243-0-62" id="h243-0-62" class="i">+    private var sigColorBackgroundSurface: Int = 0
</a><a href="#h243-0-63" id="h243-0-63" class="i">+
</a><a href="#h243-0-64" id="h243-0-64" class="i">+    private fun createRoundedBackground(color: Int, hasRadius: Boolean): Drawable {
</a><a href="#h243-0-65" id="h243-0-65" class="i">+        if (!hasRadius) return ColorDrawable(color)
</a><a href="#h243-0-66" id="h243-0-66" class="i">+        //FIXME: hardcoded radius
</a><a href="#h243-0-67" id="h243-0-67" class="i">+        return ShapeDrawable().apply {
</a><a href="#h243-0-68" id="h243-0-68" class="i">+            paint.color = color
</a><a href="#h243-0-69" id="h243-0-69" class="i">+            shape = android.graphics.drawable.shapes.RoundRectShape(
</a><a href="#h243-0-70" id="h243-0-70" class="i">+                floatArrayOf(20f, 20f, 20f, 20f, 20f, 20f, 20f, 20f),
</a><a href="#h243-0-71" id="h243-0-71" class="i">+                null,
</a><a href="#h243-0-72" id="h243-0-72" class="i">+                null
</a><a href="#h243-0-73" id="h243-0-73" class="i">+            )
</a><a href="#h243-0-74" id="h243-0-74" class="i">+        }
</a><a href="#h243-0-75" id="h243-0-75" class="i">+    }
</a><a href="#h243-0-76" id="h243-0-76" class="i">+
</a><a href="#h243-0-77" id="h243-0-77" class="i">+    @SuppressLint(&quot;DiscouragedApi&quot;)
</a><a href="#h243-0-78" id="h243-0-78" class="i">+    fun applyTheme(component: View, componentWidth: Int? = null, hasRadius: Boolean = false, isAmoled: Boolean = true) {
</a><a href="#h243-0-79" id="h243-0-79" class="i">+        val resources = component.context.resources
</a><a href="#h243-0-80" id="h243-0-80" class="i">+        if (sigColorBackgroundSurface == 0 || sigColorTextPrimary == 0) {
</a><a href="#h243-0-81" id="h243-0-81" class="i">+            with(component.context.theme) {
</a><a href="#h243-0-82" id="h243-0-82" class="i">+                sigColorTextPrimary = obtainStyledAttributes(
</a><a href="#h243-0-83" id="h243-0-83" class="i">+                    intArrayOf(resources.getIdentifier(&quot;sigColorTextPrimary&quot;, &quot;attr&quot;, Constants.SNAPCHAT_PACKAGE_NAME))
</a><a href="#h243-0-84" id="h243-0-84" class="i">+                ).getColor(0, 0)
</a><a href="#h243-0-85" id="h243-0-85" class="i">+
</a><a href="#h243-0-86" id="h243-0-86" class="i">+                sigColorBackgroundSurface = obtainStyledAttributes(
</a><a href="#h243-0-87" id="h243-0-87" class="i">+                    intArrayOf(resources.getIdentifier(&quot;sigColorBackgroundSurface&quot;, &quot;attr&quot;, Constants.SNAPCHAT_PACKAGE_NAME))
</a><a href="#h243-0-88" id="h243-0-88" class="i">+                ).getColor(0, 0)
</a><a href="#h243-0-89" id="h243-0-89" class="i">+            }
</a><a href="#h243-0-90" id="h243-0-90" class="i">+        }
</a><a href="#h243-0-91" id="h243-0-91" class="i">+
</a><a href="#h243-0-92" id="h243-0-92" class="i">+        val snapchatFontResId = resources.getIdentifier(&quot;avenir_next_medium&quot;, &quot;font&quot;, Constants.SNAPCHAT_PACKAGE_NAME)
</a><a href="#h243-0-93" id="h243-0-93" class="i">+        val scalingFactor = resources.displayMetrics.densityDpi.toDouble() / 400
</a><a href="#h243-0-94" id="h243-0-94" class="i">+
</a><a href="#h243-0-95" id="h243-0-95" class="i">+        with(component) {
</a><a href="#h243-0-96" id="h243-0-96" class="i">+            if (this is TextView) {
</a><a href="#h243-0-97" id="h243-0-97" class="i">+                setTextColor(sigColorTextPrimary)
</a><a href="#h243-0-98" id="h243-0-98" class="i">+                setShadowLayer(0F, 0F, 0F, 0)
</a><a href="#h243-0-99" id="h243-0-99" class="i">+                gravity = Gravity.CENTER_VERTICAL
</a><a href="#h243-0-100" id="h243-0-100" class="i">+                componentWidth?.let { width = it}
</a><a href="#h243-0-101" id="h243-0-101" class="i">+                height = (150 * scalingFactor).toInt()
</a><a href="#h243-0-102" id="h243-0-102" class="i">+                isAllCaps = false
</a><a href="#h243-0-103" id="h243-0-103" class="i">+                textSize = 16f
</a><a href="#h243-0-104" id="h243-0-104" class="i">+                typeface = resources.getFont(snapchatFontResId)
</a><a href="#h243-0-105" id="h243-0-105" class="i">+                outlineProvider = null
</a><a href="#h243-0-106" id="h243-0-106" class="i">+                setPadding((40 * scalingFactor).toInt(), 0, (40 * scalingFactor).toInt(), 0)
</a><a href="#h243-0-107" id="h243-0-107" class="i">+            }
</a><a href="#h243-0-108" id="h243-0-108" class="i">+            if (isAmoled) {
</a><a href="#h243-0-109" id="h243-0-109" class="i">+                background = StateListDrawable().apply {
</a><a href="#h243-0-110" id="h243-0-110" class="i">+                    addState(intArrayOf(), createRoundedBackground(color = sigColorBackgroundSurface, hasRadius))
</a><a href="#h243-0-111" id="h243-0-111" class="i">+                    addState(intArrayOf(android.R.attr.state_pressed), createRoundedBackground(color = 0x5395026, hasRadius))
</a><a href="#h243-0-112" id="h243-0-112" class="i">+                }
</a><a href="#h243-0-113" id="h243-0-113" class="i">+            } else {
</a><a href="#h243-0-114" id="h243-0-114" class="i">+                setBackgroundColor(0x0)
</a><a href="#h243-0-115" id="h243-0-115" class="i">+            }
</a><a href="#h243-0-116" id="h243-0-116" class="i">+        }
</a><a href="#h243-0-117" id="h243-0-117" class="i">+
</a><a href="#h243-0-118" id="h243-0-118" class="i">+        if (component is Switch) {
</a><a href="#h243-0-119" id="h243-0-119" class="i">+            with(resources) {
</a><a href="#h243-0-120" id="h243-0-120" class="i">+                component.switchMinWidth = getDimension(getIdentifier(&quot;v11_switch_min_width&quot;, &quot;dimen&quot;, Constants.SNAPCHAT_PACKAGE_NAME)).toInt()
</a><a href="#h243-0-121" id="h243-0-121" class="i">+            }
</a><a href="#h243-0-122" id="h243-0-122" class="i">+            component.trackTintList = ColorStateList(
</a><a href="#h243-0-123" id="h243-0-123" class="i">+                arrayOf(intArrayOf(-android.R.attr.state_checked), intArrayOf(android.R.attr.state_checked)
</a><a href="#h243-0-124" id="h243-0-124" class="i">+                ), intArrayOf(
</a><a href="#h243-0-125" id="h243-0-125" class="i">+                    Color.parseColor(&quot;#1d1d1d&quot;),
</a><a href="#h243-0-126" id="h243-0-126" class="i">+                    Color.parseColor(&quot;#26bd49&quot;)
</a><a href="#h243-0-127" id="h243-0-127" class="i">+                )
</a><a href="#h243-0-128" id="h243-0-128" class="i">+            )
</a><a href="#h243-0-129" id="h243-0-129" class="i">+            component.thumbTintList = ColorStateList(
</a><a href="#h243-0-130" id="h243-0-130" class="i">+                arrayOf(intArrayOf(-android.R.attr.state_checked), intArrayOf(android.R.attr.state_checked)
</a><a href="#h243-0-131" id="h243-0-131" class="i">+                ), intArrayOf(
</a><a href="#h243-0-132" id="h243-0-132" class="i">+                    Color.parseColor(&quot;#F5F5F5&quot;),
</a><a href="#h243-0-133" id="h243-0-133" class="i">+                    Color.parseColor(&quot;#26bd49&quot;)
</a><a href="#h243-0-134" id="h243-0-134" class="i">+                )
</a><a href="#h243-0-135" id="h243-0-135" class="i">+            )
</a><a href="#h243-0-136" id="h243-0-136" class="i">+        }
</a><a href="#h243-0-137" id="h243-0-137" class="i">+    }
</a><a href="#h243-0-138" id="h243-0-138" class="i">+
</a><a href="#h243-0-139" id="h243-0-139" class="i">+    fun newAlertDialogBuilder(context: Context?) = AlertDialog.Builder(context, android.R.style.Theme_DeviceDefault_Dialog_Alert)
</a><a href="#h243-0-140" id="h243-0-140" class="i">+}
</a><b>diff --git a/<a id="h244" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/ui/ViewTagState.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/ViewTagState.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/ui/ViewTagState.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/ViewTagState.kt</a></b>
<a href="#h244-0" id="h244-0" class="h">@@ -0,0 +1,20 @@
</a><a href="#h244-0-0" id="h244-0-0" class="i">+package me.rhunk.snapenhance.core.ui
</a><a href="#h244-0-1" id="h244-0-1" class="i">+
</a><a href="#h244-0-2" id="h244-0-2" class="i">+import android.view.View
</a><a href="#h244-0-3" id="h244-0-3" class="i">+import kotlin.random.Random
</a><a href="#h244-0-4" id="h244-0-4" class="i">+
</a><a href="#h244-0-5" id="h244-0-5" class="i">+class ViewTagState {
</a><a href="#h244-0-6" id="h244-0-6" class="i">+    private val tag = Random.nextInt(0x7000000, 0x7FFFFFFF)
</a><a href="#h244-0-7" id="h244-0-7" class="i">+
</a><a href="#h244-0-8" id="h244-0-8" class="i">+    operator fun get(view: View) = hasState(view)
</a><a href="#h244-0-9" id="h244-0-9" class="i">+
</a><a href="#h244-0-10" id="h244-0-10" class="i">+    private fun hasState(view: View): Boolean {
</a><a href="#h244-0-11" id="h244-0-11" class="i">+        if (view.getTag(tag) != null) return true
</a><a href="#h244-0-12" id="h244-0-12" class="i">+        view.setTag(tag, true)
</a><a href="#h244-0-13" id="h244-0-13" class="i">+        return false
</a><a href="#h244-0-14" id="h244-0-14" class="i">+    }
</a><a href="#h244-0-15" id="h244-0-15" class="i">+
</a><a href="#h244-0-16" id="h244-0-16" class="i">+    fun removeState(view: View) {
</a><a href="#h244-0-17" id="h244-0-17" class="i">+        view.setTag(tag, null)
</a><a href="#h244-0-18" id="h244-0-18" class="i">+    }
</a><a href="#h244-0-19" id="h244-0-19" class="i">+}</a><a href="#h244-0-20" id="h244-0-20" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h245" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/AbstractMenu.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/AbstractMenu.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/AbstractMenu.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/AbstractMenu.kt</a></b>
<a href="#h245-0" id="h245-0" class="h">@@ -0,0 +1,9 @@
</a><a href="#h245-0-0" id="h245-0-0" class="i">+package me.rhunk.snapenhance.core.ui.menu
</a><a href="#h245-0-1" id="h245-0-1" class="i">+
</a><a href="#h245-0-2" id="h245-0-2" class="i">+import me.rhunk.snapenhance.core.ModContext
</a><a href="#h245-0-3" id="h245-0-3" class="i">+
</a><a href="#h245-0-4" id="h245-0-4" class="i">+abstract class AbstractMenu {
</a><a href="#h245-0-5" id="h245-0-5" class="i">+    lateinit var context: ModContext
</a><a href="#h245-0-6" id="h245-0-6" class="i">+
</a><a href="#h245-0-7" id="h245-0-7" class="i">+    open fun init() {}
</a><a href="#h245-0-8" id="h245-0-8" class="i">+}</a><a href="#h245-0-9" id="h245-0-9" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h246" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/ChatActionMenu.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/ChatActionMenu.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/ChatActionMenu.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/ChatActionMenu.kt</a></b>
<a href="#h246-0" id="h246-0" class="h">@@ -0,0 +1,226 @@
</a><a href="#h246-0-0" id="h246-0-0" class="i">+package me.rhunk.snapenhance.core.ui.menu.impl
</a><a href="#h246-0-1" id="h246-0-1" class="i">+
</a><a href="#h246-0-2" id="h246-0-2" class="i">+import android.annotation.SuppressLint
</a><a href="#h246-0-3" id="h246-0-3" class="i">+import android.content.Context
</a><a href="#h246-0-4" id="h246-0-4" class="i">+import android.os.SystemClock
</a><a href="#h246-0-5" id="h246-0-5" class="i">+import android.view.MotionEvent
</a><a href="#h246-0-6" id="h246-0-6" class="i">+import android.view.View
</a><a href="#h246-0-7" id="h246-0-7" class="i">+import android.view.ViewGroup
</a><a href="#h246-0-8" id="h246-0-8" class="i">+import android.view.ViewGroup.MarginLayoutParams
</a><a href="#h246-0-9" id="h246-0-9" class="i">+import android.widget.Button
</a><a href="#h246-0-10" id="h246-0-10" class="i">+import android.widget.LinearLayout
</a><a href="#h246-0-11" id="h246-0-11" class="i">+import android.widget.TextView
</a><a href="#h246-0-12" id="h246-0-12" class="i">+import me.rhunk.snapenhance.common.Constants
</a><a href="#h246-0-13" id="h246-0-13" class="i">+import me.rhunk.snapenhance.common.data.ContentType
</a><a href="#h246-0-14" id="h246-0-14" class="i">+import me.rhunk.snapenhance.common.util.protobuf.ProtoReader
</a><a href="#h246-0-15" id="h246-0-15" class="i">+import me.rhunk.snapenhance.core.features.impl.downloader.MediaDownloader
</a><a href="#h246-0-16" id="h246-0-16" class="i">+import me.rhunk.snapenhance.core.features.impl.messaging.Messaging
</a><a href="#h246-0-17" id="h246-0-17" class="i">+import me.rhunk.snapenhance.core.features.impl.spying.MessageLogger
</a><a href="#h246-0-18" id="h246-0-18" class="i">+import me.rhunk.snapenhance.core.ui.ViewAppearanceHelper
</a><a href="#h246-0-19" id="h246-0-19" class="i">+import me.rhunk.snapenhance.core.ui.ViewTagState
</a><a href="#h246-0-20" id="h246-0-20" class="i">+import me.rhunk.snapenhance.core.ui.applyTheme
</a><a href="#h246-0-21" id="h246-0-21" class="i">+import me.rhunk.snapenhance.core.ui.menu.AbstractMenu
</a><a href="#h246-0-22" id="h246-0-22" class="i">+import java.time.Instant
</a><a href="#h246-0-23" id="h246-0-23" class="i">+
</a><a href="#h246-0-24" id="h246-0-24" class="i">+
</a><a href="#h246-0-25" id="h246-0-25" class="i">+@SuppressLint(&quot;DiscouragedApi&quot;)
</a><a href="#h246-0-26" id="h246-0-26" class="i">+class ChatActionMenu : AbstractMenu() {
</a><a href="#h246-0-27" id="h246-0-27" class="i">+    private val viewTagState = ViewTagState()
</a><a href="#h246-0-28" id="h246-0-28" class="i">+
</a><a href="#h246-0-29" id="h246-0-29" class="i">+    private val defaultGap by lazy {
</a><a href="#h246-0-30" id="h246-0-30" class="i">+        context.androidContext.resources.getDimensionPixelSize(
</a><a href="#h246-0-31" id="h246-0-31" class="i">+            context.androidContext.resources.getIdentifier(
</a><a href="#h246-0-32" id="h246-0-32" class="i">+                &quot;default_gap&quot;,
</a><a href="#h246-0-33" id="h246-0-33" class="i">+                &quot;dimen&quot;,
</a><a href="#h246-0-34" id="h246-0-34" class="i">+                Constants.SNAPCHAT_PACKAGE_NAME
</a><a href="#h246-0-35" id="h246-0-35" class="i">+            )
</a><a href="#h246-0-36" id="h246-0-36" class="i">+        )
</a><a href="#h246-0-37" id="h246-0-37" class="i">+    }
</a><a href="#h246-0-38" id="h246-0-38" class="i">+
</a><a href="#h246-0-39" id="h246-0-39" class="i">+    private val chatActionMenuItemMargin by lazy {
</a><a href="#h246-0-40" id="h246-0-40" class="i">+        context.androidContext.resources.getDimensionPixelSize(
</a><a href="#h246-0-41" id="h246-0-41" class="i">+            context.androidContext.resources.getIdentifier(
</a><a href="#h246-0-42" id="h246-0-42" class="i">+                &quot;chat_action_menu_item_margin&quot;,
</a><a href="#h246-0-43" id="h246-0-43" class="i">+                &quot;dimen&quot;,
</a><a href="#h246-0-44" id="h246-0-44" class="i">+                Constants.SNAPCHAT_PACKAGE_NAME
</a><a href="#h246-0-45" id="h246-0-45" class="i">+            )
</a><a href="#h246-0-46" id="h246-0-46" class="i">+        )
</a><a href="#h246-0-47" id="h246-0-47" class="i">+    }
</a><a href="#h246-0-48" id="h246-0-48" class="i">+
</a><a href="#h246-0-49" id="h246-0-49" class="i">+    private val actionMenuItemHeight by lazy {
</a><a href="#h246-0-50" id="h246-0-50" class="i">+        context.androidContext.resources.getDimensionPixelSize(
</a><a href="#h246-0-51" id="h246-0-51" class="i">+            context.androidContext.resources.getIdentifier(
</a><a href="#h246-0-52" id="h246-0-52" class="i">+                &quot;action_menu_item_height&quot;,
</a><a href="#h246-0-53" id="h246-0-53" class="i">+                &quot;dimen&quot;,
</a><a href="#h246-0-54" id="h246-0-54" class="i">+                Constants.SNAPCHAT_PACKAGE_NAME
</a><a href="#h246-0-55" id="h246-0-55" class="i">+            )
</a><a href="#h246-0-56" id="h246-0-56" class="i">+        )
</a><a href="#h246-0-57" id="h246-0-57" class="i">+    }
</a><a href="#h246-0-58" id="h246-0-58" class="i">+
</a><a href="#h246-0-59" id="h246-0-59" class="i">+    private fun createContainer(viewGroup: ViewGroup): LinearLayout {
</a><a href="#h246-0-60" id="h246-0-60" class="i">+        val parent = viewGroup.parent.parent as ViewGroup
</a><a href="#h246-0-61" id="h246-0-61" class="i">+
</a><a href="#h246-0-62" id="h246-0-62" class="i">+        return LinearLayout(viewGroup.context).apply layout@{
</a><a href="#h246-0-63" id="h246-0-63" class="i">+            orientation = LinearLayout.VERTICAL
</a><a href="#h246-0-64" id="h246-0-64" class="i">+            layoutParams = MarginLayoutParams(
</a><a href="#h246-0-65" id="h246-0-65" class="i">+                ViewGroup.LayoutParams.MATCH_PARENT,
</a><a href="#h246-0-66" id="h246-0-66" class="i">+                ViewGroup.LayoutParams.WRAP_CONTENT
</a><a href="#h246-0-67" id="h246-0-67" class="i">+            ).apply {
</a><a href="#h246-0-68" id="h246-0-68" class="i">+                applyTheme(parent.width, true)
</a><a href="#h246-0-69" id="h246-0-69" class="i">+                setMargins(chatActionMenuItemMargin, 0, chatActionMenuItemMargin, defaultGap)
</a><a href="#h246-0-70" id="h246-0-70" class="i">+            }
</a><a href="#h246-0-71" id="h246-0-71" class="i">+        }
</a><a href="#h246-0-72" id="h246-0-72" class="i">+    }
</a><a href="#h246-0-73" id="h246-0-73" class="i">+
</a><a href="#h246-0-74" id="h246-0-74" class="i">+    private fun copyAlertDialog(context: Context, title: String, text: String) {
</a><a href="#h246-0-75" id="h246-0-75" class="i">+        ViewAppearanceHelper.newAlertDialogBuilder(context).apply {
</a><a href="#h246-0-76" id="h246-0-76" class="i">+            setTitle(title)
</a><a href="#h246-0-77" id="h246-0-77" class="i">+            setMessage(text)
</a><a href="#h246-0-78" id="h246-0-78" class="i">+            setPositiveButton(&quot;OK&quot;) { dialog, _ -&gt; dialog.dismiss() }
</a><a href="#h246-0-79" id="h246-0-79" class="i">+            setNegativeButton(&quot;Copy&quot;) { _, _ -&gt;
</a><a href="#h246-0-80" id="h246-0-80" class="i">+                this@ChatActionMenu.context.copyToClipboard(text, title)
</a><a href="#h246-0-81" id="h246-0-81" class="i">+            }
</a><a href="#h246-0-82" id="h246-0-82" class="i">+        }.show()
</a><a href="#h246-0-83" id="h246-0-83" class="i">+    }
</a><a href="#h246-0-84" id="h246-0-84" class="i">+
</a><a href="#h246-0-85" id="h246-0-85" class="i">+    private val lastFocusedMessage
</a><a href="#h246-0-86" id="h246-0-86" class="i">+        get() = context.database.getConversationMessageFromId(context.feature(Messaging::class).lastFocusedMessageId)
</a><a href="#h246-0-87" id="h246-0-87" class="i">+
</a><a href="#h246-0-88" id="h246-0-88" class="i">+    @SuppressLint(&quot;SetTextI18n&quot;, &quot;DiscouragedApi&quot;, &quot;ClickableViewAccessibility&quot;)
</a><a href="#h246-0-89" id="h246-0-89" class="i">+    fun inject(viewGroup: ViewGroup) {
</a><a href="#h246-0-90" id="h246-0-90" class="i">+        val parent = viewGroup.parent.parent as? ViewGroup ?: return
</a><a href="#h246-0-91" id="h246-0-91" class="i">+        if (viewTagState[parent]) return
</a><a href="#h246-0-92" id="h246-0-92" class="i">+        //close the action menu using a touch event
</a><a href="#h246-0-93" id="h246-0-93" class="i">+        val closeActionMenu = {
</a><a href="#h246-0-94" id="h246-0-94" class="i">+            viewGroup.dispatchTouchEvent(
</a><a href="#h246-0-95" id="h246-0-95" class="i">+                MotionEvent.obtain(
</a><a href="#h246-0-96" id="h246-0-96" class="i">+                    SystemClock.uptimeMillis(),
</a><a href="#h246-0-97" id="h246-0-97" class="i">+                    SystemClock.uptimeMillis(),
</a><a href="#h246-0-98" id="h246-0-98" class="i">+                    MotionEvent.ACTION_DOWN,
</a><a href="#h246-0-99" id="h246-0-99" class="i">+                    0f,
</a><a href="#h246-0-100" id="h246-0-100" class="i">+                    0f,
</a><a href="#h246-0-101" id="h246-0-101" class="i">+                    0
</a><a href="#h246-0-102" id="h246-0-102" class="i">+                )
</a><a href="#h246-0-103" id="h246-0-103" class="i">+            )
</a><a href="#h246-0-104" id="h246-0-104" class="i">+        }
</a><a href="#h246-0-105" id="h246-0-105" class="i">+
</a><a href="#h246-0-106" id="h246-0-106" class="i">+        val messaging = context.feature(Messaging::class)
</a><a href="#h246-0-107" id="h246-0-107" class="i">+        val messageLogger = context.feature(MessageLogger::class)
</a><a href="#h246-0-108" id="h246-0-108" class="i">+
</a><a href="#h246-0-109" id="h246-0-109" class="i">+        val buttonContainer = createContainer(viewGroup)
</a><a href="#h246-0-110" id="h246-0-110" class="i">+
</a><a href="#h246-0-111" id="h246-0-111" class="i">+        val injectButton = { button: Button -&gt;
</a><a href="#h246-0-112" id="h246-0-112" class="i">+            if (buttonContainer.childCount &gt; 0) {
</a><a href="#h246-0-113" id="h246-0-113" class="i">+                buttonContainer.addView(View(viewGroup.context).apply {
</a><a href="#h246-0-114" id="h246-0-114" class="i">+                    layoutParams = MarginLayoutParams(
</a><a href="#h246-0-115" id="h246-0-115" class="i">+                        ViewGroup.LayoutParams.MATCH_PARENT,
</a><a href="#h246-0-116" id="h246-0-116" class="i">+                        ViewGroup.LayoutParams.WRAP_CONTENT
</a><a href="#h246-0-117" id="h246-0-117" class="i">+                    ).apply {
</a><a href="#h246-0-118" id="h246-0-118" class="i">+                        height = 1
</a><a href="#h246-0-119" id="h246-0-119" class="i">+                    }
</a><a href="#h246-0-120" id="h246-0-120" class="i">+                    setBackgroundColor(0x1A000000)
</a><a href="#h246-0-121" id="h246-0-121" class="i">+                })
</a><a href="#h246-0-122" id="h246-0-122" class="i">+            }
</a><a href="#h246-0-123" id="h246-0-123" class="i">+
</a><a href="#h246-0-124" id="h246-0-124" class="i">+            with(button) {
</a><a href="#h246-0-125" id="h246-0-125" class="i">+                applyTheme(parent.width, true)
</a><a href="#h246-0-126" id="h246-0-126" class="i">+                layoutParams = MarginLayoutParams(
</a><a href="#h246-0-127" id="h246-0-127" class="i">+                    ViewGroup.LayoutParams.MATCH_PARENT,
</a><a href="#h246-0-128" id="h246-0-128" class="i">+                    ViewGroup.LayoutParams.WRAP_CONTENT
</a><a href="#h246-0-129" id="h246-0-129" class="i">+                ).apply {
</a><a href="#h246-0-130" id="h246-0-130" class="i">+                    height = actionMenuItemHeight + defaultGap
</a><a href="#h246-0-131" id="h246-0-131" class="i">+                }
</a><a href="#h246-0-132" id="h246-0-132" class="i">+                buttonContainer.addView(this)
</a><a href="#h246-0-133" id="h246-0-133" class="i">+            }
</a><a href="#h246-0-134" id="h246-0-134" class="i">+        }
</a><a href="#h246-0-135" id="h246-0-135" class="i">+
</a><a href="#h246-0-136" id="h246-0-136" class="i">+        if (context.config.downloader.chatDownloadContextMenu.get()) {
</a><a href="#h246-0-137" id="h246-0-137" class="i">+            injectButton(Button(viewGroup.context).apply {
</a><a href="#h246-0-138" id="h246-0-138" class="i">+                text = this@ChatActionMenu.context.translation[&quot;chat_action_menu.preview_button&quot;]
</a><a href="#h246-0-139" id="h246-0-139" class="i">+                setOnClickListener {
</a><a href="#h246-0-140" id="h246-0-140" class="i">+                    closeActionMenu()
</a><a href="#h246-0-141" id="h246-0-141" class="i">+                    this@ChatActionMenu.context.executeAsync { feature(MediaDownloader::class).onMessageActionMenu(true) }
</a><a href="#h246-0-142" id="h246-0-142" class="i">+                }
</a><a href="#h246-0-143" id="h246-0-143" class="i">+            })
</a><a href="#h246-0-144" id="h246-0-144" class="i">+
</a><a href="#h246-0-145" id="h246-0-145" class="i">+            injectButton(Button(viewGroup.context).apply {
</a><a href="#h246-0-146" id="h246-0-146" class="i">+                text = this@ChatActionMenu.context.translation[&quot;chat_action_menu.download_button&quot;]
</a><a href="#h246-0-147" id="h246-0-147" class="i">+                setOnClickListener {
</a><a href="#h246-0-148" id="h246-0-148" class="i">+                    closeActionMenu()
</a><a href="#h246-0-149" id="h246-0-149" class="i">+                    this@ChatActionMenu.context.executeAsync {
</a><a href="#h246-0-150" id="h246-0-150" class="i">+                        feature(MediaDownloader::class).onMessageActionMenu(false)
</a><a href="#h246-0-151" id="h246-0-151" class="i">+                    }
</a><a href="#h246-0-152" id="h246-0-152" class="i">+                }
</a><a href="#h246-0-153" id="h246-0-153" class="i">+            })
</a><a href="#h246-0-154" id="h246-0-154" class="i">+        }
</a><a href="#h246-0-155" id="h246-0-155" class="i">+
</a><a href="#h246-0-156" id="h246-0-156" class="i">+        //delete logged message button
</a><a href="#h246-0-157" id="h246-0-157" class="i">+        if (context.config.messaging.messageLogger.get()) {
</a><a href="#h246-0-158" id="h246-0-158" class="i">+            injectButton(Button(viewGroup.context).apply {
</a><a href="#h246-0-159" id="h246-0-159" class="i">+                text = this@ChatActionMenu.context.translation[&quot;chat_action_menu.delete_logged_message_button&quot;]
</a><a href="#h246-0-160" id="h246-0-160" class="i">+                setOnClickListener {
</a><a href="#h246-0-161" id="h246-0-161" class="i">+                    closeActionMenu()
</a><a href="#h246-0-162" id="h246-0-162" class="i">+                    this@ChatActionMenu.context.executeAsync {
</a><a href="#h246-0-163" id="h246-0-163" class="i">+                        messageLogger.deleteMessage(messaging.openedConversationUUID.toString(), messaging.lastFocusedMessageId)
</a><a href="#h246-0-164" id="h246-0-164" class="i">+                    }
</a><a href="#h246-0-165" id="h246-0-165" class="i">+                }
</a><a href="#h246-0-166" id="h246-0-166" class="i">+            })
</a><a href="#h246-0-167" id="h246-0-167" class="i">+        }
</a><a href="#h246-0-168" id="h246-0-168" class="i">+
</a><a href="#h246-0-169" id="h246-0-169" class="i">+        if (context.isDeveloper) {
</a><a href="#h246-0-170" id="h246-0-170" class="i">+            parent.addView(createContainer(viewGroup).apply {
</a><a href="#h246-0-171" id="h246-0-171" class="i">+                val debugText = StringBuilder()
</a><a href="#h246-0-172" id="h246-0-172" class="i">+
</a><a href="#h246-0-173" id="h246-0-173" class="i">+                setOnClickListener {
</a><a href="#h246-0-174" id="h246-0-174" class="i">+                    this@ChatActionMenu.context.copyToClipboard(debugText.toString(), &quot;debug&quot;)
</a><a href="#h246-0-175" id="h246-0-175" class="i">+                }
</a><a href="#h246-0-176" id="h246-0-176" class="i">+
</a><a href="#h246-0-177" id="h246-0-177" class="i">+                addView(TextView(viewGroup.context).apply {
</a><a href="#h246-0-178" id="h246-0-178" class="i">+                    setPadding(20, 20, 20, 20)
</a><a href="#h246-0-179" id="h246-0-179" class="i">+                    textSize = 10f
</a><a href="#h246-0-180" id="h246-0-180" class="i">+                    addOnLayoutChangeListener { _, _, _, _, _, _, _, _, _ -&gt;
</a><a href="#h246-0-181" id="h246-0-181" class="i">+                        val arroyoMessage = lastFocusedMessage ?: return@addOnLayoutChangeListener
</a><a href="#h246-0-182" id="h246-0-182" class="i">+                        text = debugText.apply {
</a><a href="#h246-0-183" id="h246-0-183" class="i">+                            runCatching {
</a><a href="#h246-0-184" id="h246-0-184" class="i">+                                clear()
</a><a href="#h246-0-185" id="h246-0-185" class="i">+                                append(&quot;sender_id: ${arroyoMessage.senderId}\n&quot;)
</a><a href="#h246-0-186" id="h246-0-186" class="i">+                                append(&quot;client_id: ${arroyoMessage.clientMessageId}, server_id: ${arroyoMessage.serverMessageId}\n&quot;)
</a><a href="#h246-0-187" id="h246-0-187" class="i">+                                append(&quot;conversation_id: ${arroyoMessage.clientConversationId}\n&quot;)
</a><a href="#h246-0-188" id="h246-0-188" class="i">+                                append(&quot;arroyo_content_type: ${ContentType.fromId(arroyoMessage.contentType)} (${arroyoMessage.contentType})\n&quot;)
</a><a href="#h246-0-189" id="h246-0-189" class="i">+                                append(&quot;parsed_content_type: ${
</a><a href="#h246-0-190" id="h246-0-190" class="i">+                                    ContentType.fromMessageContainer(
</a><a href="#h246-0-191" id="h246-0-191" class="i">+                                    ProtoReader(arroyoMessage.messageContent!!).followPath(4, 4)
</a><a href="#h246-0-192" id="h246-0-192" class="i">+                                ).let { &quot;$it (${it?.id})&quot; }}\n&quot;)
</a><a href="#h246-0-193" id="h246-0-193" class="i">+                                append(&quot;creation_timestamp: ${arroyoMessage.creationTimestamp} (${Instant.ofEpochMilli(arroyoMessage.creationTimestamp)})\n&quot;)
</a><a href="#h246-0-194" id="h246-0-194" class="i">+                                append(&quot;read_timestamp: ${arroyoMessage.readTimestamp} (${Instant.ofEpochMilli(arroyoMessage.readTimestamp)})\n&quot;)
</a><a href="#h246-0-195" id="h246-0-195" class="i">+                                append(&quot;is_messagelogger_deleted: ${messageLogger.isMessageDeleted(arroyoMessage.clientConversationId!!, arroyoMessage.clientMessageId.toLong())}\n&quot;)
</a><a href="#h246-0-196" id="h246-0-196" class="i">+                                append(&quot;is_messagelogger_stored: ${messageLogger.getMessageObject(arroyoMessage.clientConversationId!!, arroyoMessage.clientMessageId.toLong()) != null}\n&quot;)
</a><a href="#h246-0-197" id="h246-0-197" class="i">+                            }.onFailure {
</a><a href="#h246-0-198" id="h246-0-198" class="i">+                                debugText.append(&quot;Error: $it\n&quot;)
</a><a href="#h246-0-199" id="h246-0-199" class="i">+                            }
</a><a href="#h246-0-200" id="h246-0-200" class="i">+                        }.toString().trimEnd()
</a><a href="#h246-0-201" id="h246-0-201" class="i">+                    }
</a><a href="#h246-0-202" id="h246-0-202" class="i">+                })
</a><a href="#h246-0-203" id="h246-0-203" class="i">+
</a><a href="#h246-0-204" id="h246-0-204" class="i">+                // action buttons
</a><a href="#h246-0-205" id="h246-0-205" class="i">+                addView(LinearLayout(viewGroup.context).apply {
</a><a href="#h246-0-206" id="h246-0-206" class="i">+                    orientation = LinearLayout.HORIZONTAL
</a><a href="#h246-0-207" id="h246-0-207" class="i">+                    addView(Button(viewGroup.context).apply {
</a><a href="#h246-0-208" id="h246-0-208" class="i">+                        text = &quot;Show Deleted Message Object&quot;
</a><a href="#h246-0-209" id="h246-0-209" class="i">+                        setOnClickListener {
</a><a href="#h246-0-210" id="h246-0-210" class="i">+                            val message = lastFocusedMessage ?: return@setOnClickListener
</a><a href="#h246-0-211" id="h246-0-211" class="i">+                            copyAlertDialog(
</a><a href="#h246-0-212" id="h246-0-212" class="i">+                                viewGroup.context,
</a><a href="#h246-0-213" id="h246-0-213" class="i">+                                &quot;Deleted Message Object&quot;,
</a><a href="#h246-0-214" id="h246-0-214" class="i">+                                messageLogger.getMessageObject(message.clientConversationId!!, message.clientMessageId.toLong())?.toString()
</a><a href="#h246-0-215" id="h246-0-215" class="i">+                                    ?: &quot;null&quot;
</a><a href="#h246-0-216" id="h246-0-216" class="i">+                            )
</a><a href="#h246-0-217" id="h246-0-217" class="i">+                        }
</a><a href="#h246-0-218" id="h246-0-218" class="i">+                    })
</a><a href="#h246-0-219" id="h246-0-219" class="i">+                })
</a><a href="#h246-0-220" id="h246-0-220" class="i">+            })
</a><a href="#h246-0-221" id="h246-0-221" class="i">+        }
</a><a href="#h246-0-222" id="h246-0-222" class="i">+
</a><a href="#h246-0-223" id="h246-0-223" class="i">+        parent.addView(buttonContainer)
</a><a href="#h246-0-224" id="h246-0-224" class="i">+    }
</a><a href="#h246-0-225" id="h246-0-225" class="i">+}
</a><b>diff --git a/<a id="h247" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/FriendFeedInfoMenu.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/FriendFeedInfoMenu.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/FriendFeedInfoMenu.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/FriendFeedInfoMenu.kt</a></b>
<a href="#h247-0" id="h247-0" class="h">@@ -0,0 +1,255 @@
</a><a href="#h247-0-0" id="h247-0-0" class="i">+package me.rhunk.snapenhance.core.ui.menu.impl
</a><a href="#h247-0-1" id="h247-0-1" class="i">+
</a><a href="#h247-0-2" id="h247-0-2" class="i">+import android.content.DialogInterface
</a><a href="#h247-0-3" id="h247-0-3" class="i">+import android.content.res.Resources
</a><a href="#h247-0-4" id="h247-0-4" class="i">+import android.graphics.BitmapFactory
</a><a href="#h247-0-5" id="h247-0-5" class="i">+import android.graphics.drawable.BitmapDrawable
</a><a href="#h247-0-6" id="h247-0-6" class="i">+import android.graphics.drawable.Drawable
</a><a href="#h247-0-7" id="h247-0-7" class="i">+import android.view.View
</a><a href="#h247-0-8" id="h247-0-8" class="i">+import android.widget.Button
</a><a href="#h247-0-9" id="h247-0-9" class="i">+import android.widget.CompoundButton
</a><a href="#h247-0-10" id="h247-0-10" class="i">+import android.widget.Switch
</a><a href="#h247-0-11" id="h247-0-11" class="i">+import me.rhunk.snapenhance.common.data.ContentType
</a><a href="#h247-0-12" id="h247-0-12" class="i">+import me.rhunk.snapenhance.common.data.FriendLinkType
</a><a href="#h247-0-13" id="h247-0-13" class="i">+import me.rhunk.snapenhance.common.database.impl.ConversationMessage
</a><a href="#h247-0-14" id="h247-0-14" class="i">+import me.rhunk.snapenhance.common.database.impl.FriendInfo
</a><a href="#h247-0-15" id="h247-0-15" class="i">+import me.rhunk.snapenhance.common.database.impl.UserConversationLink
</a><a href="#h247-0-16" id="h247-0-16" class="i">+import me.rhunk.snapenhance.common.util.protobuf.ProtoReader
</a><a href="#h247-0-17" id="h247-0-17" class="i">+import me.rhunk.snapenhance.common.util.snap.BitmojiSelfie
</a><a href="#h247-0-18" id="h247-0-18" class="i">+import me.rhunk.snapenhance.core.features.impl.messaging.Messaging
</a><a href="#h247-0-19" id="h247-0-19" class="i">+import me.rhunk.snapenhance.core.features.impl.spying.MessageLogger
</a><a href="#h247-0-20" id="h247-0-20" class="i">+import me.rhunk.snapenhance.core.ui.ViewAppearanceHelper
</a><a href="#h247-0-21" id="h247-0-21" class="i">+import me.rhunk.snapenhance.core.ui.applyTheme
</a><a href="#h247-0-22" id="h247-0-22" class="i">+import me.rhunk.snapenhance.core.ui.menu.AbstractMenu
</a><a href="#h247-0-23" id="h247-0-23" class="i">+import java.net.HttpURLConnection
</a><a href="#h247-0-24" id="h247-0-24" class="i">+import java.net.URL
</a><a href="#h247-0-25" id="h247-0-25" class="i">+import java.text.DateFormat
</a><a href="#h247-0-26" id="h247-0-26" class="i">+import java.text.SimpleDateFormat
</a><a href="#h247-0-27" id="h247-0-27" class="i">+import java.util.Calendar
</a><a href="#h247-0-28" id="h247-0-28" class="i">+import java.util.Date
</a><a href="#h247-0-29" id="h247-0-29" class="i">+import java.util.Locale
</a><a href="#h247-0-30" id="h247-0-30" class="i">+
</a><a href="#h247-0-31" id="h247-0-31" class="i">+class FriendFeedInfoMenu : AbstractMenu() {
</a><a href="#h247-0-32" id="h247-0-32" class="i">+    private fun getImageDrawable(url: String): Drawable {
</a><a href="#h247-0-33" id="h247-0-33" class="i">+        val connection = URL(url).openConnection() as HttpURLConnection
</a><a href="#h247-0-34" id="h247-0-34" class="i">+        connection.connect()
</a><a href="#h247-0-35" id="h247-0-35" class="i">+        val input = connection.inputStream
</a><a href="#h247-0-36" id="h247-0-36" class="i">+        return BitmapDrawable(Resources.getSystem(), BitmapFactory.decodeStream(input))
</a><a href="#h247-0-37" id="h247-0-37" class="i">+    }
</a><a href="#h247-0-38" id="h247-0-38" class="i">+
</a><a href="#h247-0-39" id="h247-0-39" class="i">+    private fun formatDate(timestamp: Long): String? {
</a><a href="#h247-0-40" id="h247-0-40" class="i">+        return SimpleDateFormat(&quot;yyyy-MM-dd HH:mm:ss&quot;, Locale.ENGLISH).format(Date(timestamp))
</a><a href="#h247-0-41" id="h247-0-41" class="i">+    }
</a><a href="#h247-0-42" id="h247-0-42" class="i">+
</a><a href="#h247-0-43" id="h247-0-43" class="i">+    private fun showProfileInfo(profile: FriendInfo) {
</a><a href="#h247-0-44" id="h247-0-44" class="i">+        var icon: Drawable? = null
</a><a href="#h247-0-45" id="h247-0-45" class="i">+        try {
</a><a href="#h247-0-46" id="h247-0-46" class="i">+            if (profile.bitmojiSelfieId != null &amp;&amp; profile.bitmojiAvatarId != null) {
</a><a href="#h247-0-47" id="h247-0-47" class="i">+                icon = getImageDrawable(
</a><a href="#h247-0-48" id="h247-0-48" class="i">+                    BitmojiSelfie.getBitmojiSelfie(
</a><a href="#h247-0-49" id="h247-0-49" class="i">+                        profile.bitmojiSelfieId.toString(),
</a><a href="#h247-0-50" id="h247-0-50" class="i">+                        profile.bitmojiAvatarId.toString(),
</a><a href="#h247-0-51" id="h247-0-51" class="i">+                        BitmojiSelfie.BitmojiSelfieType.THREE_D
</a><a href="#h247-0-52" id="h247-0-52" class="i">+                    )!!
</a><a href="#h247-0-53" id="h247-0-53" class="i">+                )
</a><a href="#h247-0-54" id="h247-0-54" class="i">+            }
</a><a href="#h247-0-55" id="h247-0-55" class="i">+        } catch (e: Throwable) {
</a><a href="#h247-0-56" id="h247-0-56" class="i">+            context.log.error(&quot;Error loading bitmoji selfie&quot;, e)
</a><a href="#h247-0-57" id="h247-0-57" class="i">+        }
</a><a href="#h247-0-58" id="h247-0-58" class="i">+        val finalIcon = icon
</a><a href="#h247-0-59" id="h247-0-59" class="i">+        val translation = context.translation.getCategory(&quot;profile_info&quot;)
</a><a href="#h247-0-60" id="h247-0-60" class="i">+
</a><a href="#h247-0-61" id="h247-0-61" class="i">+        context.runOnUiThread {
</a><a href="#h247-0-62" id="h247-0-62" class="i">+            val addedTimestamp: Long = profile.addedTimestamp.coerceAtLeast(profile.reverseAddedTimestamp)
</a><a href="#h247-0-63" id="h247-0-63" class="i">+            val builder = ViewAppearanceHelper.newAlertDialogBuilder(context.mainActivity)
</a><a href="#h247-0-64" id="h247-0-64" class="i">+            builder.setIcon(finalIcon)
</a><a href="#h247-0-65" id="h247-0-65" class="i">+            builder.setTitle(profile.displayName ?: profile.username)
</a><a href="#h247-0-66" id="h247-0-66" class="i">+
</a><a href="#h247-0-67" id="h247-0-67" class="i">+            val birthday = Calendar.getInstance()
</a><a href="#h247-0-68" id="h247-0-68" class="i">+            birthday[Calendar.MONTH] = (profile.birthday shr 32).toInt() - 1
</a><a href="#h247-0-69" id="h247-0-69" class="i">+
</a><a href="#h247-0-70" id="h247-0-70" class="i">+            builder.setMessage(mapOf(
</a><a href="#h247-0-71" id="h247-0-71" class="i">+                translation[&quot;first_created_username&quot;] to profile.firstCreatedUsername,
</a><a href="#h247-0-72" id="h247-0-72" class="i">+                translation[&quot;mutable_username&quot;] to profile.mutableUsername,
</a><a href="#h247-0-73" id="h247-0-73" class="i">+                translation[&quot;display_name&quot;] to profile.displayName,
</a><a href="#h247-0-74" id="h247-0-74" class="i">+                translation[&quot;added_date&quot;] to formatDate(addedTimestamp),
</a><a href="#h247-0-75" id="h247-0-75" class="i">+                null to birthday.getDisplayName(
</a><a href="#h247-0-76" id="h247-0-76" class="i">+                    Calendar.MONTH,
</a><a href="#h247-0-77" id="h247-0-77" class="i">+                    Calendar.LONG,
</a><a href="#h247-0-78" id="h247-0-78" class="i">+                    context.translation.loadedLocale
</a><a href="#h247-0-79" id="h247-0-79" class="i">+                )?.let {
</a><a href="#h247-0-80" id="h247-0-80" class="i">+                    context.translation.format(&quot;profile_info.birthday&quot;,
</a><a href="#h247-0-81" id="h247-0-81" class="i">+                        &quot;month&quot; to it,
</a><a href="#h247-0-82" id="h247-0-82" class="i">+                        &quot;day&quot; to profile.birthday.toInt().toString())
</a><a href="#h247-0-83" id="h247-0-83" class="i">+                },
</a><a href="#h247-0-84" id="h247-0-84" class="i">+                translation[&quot;friendship&quot;] to run {
</a><a href="#h247-0-85" id="h247-0-85" class="i">+                    translation.getCategory(&quot;friendship_link_type&quot;)[FriendLinkType.fromValue(profile.friendLinkType).shortName]
</a><a href="#h247-0-86" id="h247-0-86" class="i">+                },
</a><a href="#h247-0-87" id="h247-0-87" class="i">+                translation[&quot;add_source&quot;] to context.database.getAddSource(profile.userId!!)?.takeIf { it.isNotEmpty() },
</a><a href="#h247-0-88" id="h247-0-88" class="i">+                translation[&quot;snapchat_plus&quot;] to run {
</a><a href="#h247-0-89" id="h247-0-89" class="i">+                    translation.getCategory(&quot;snapchat_plus_state&quot;)[if (profile.postViewEmoji != null) &quot;subscribed&quot; else &quot;not_subscribed&quot;]
</a><a href="#h247-0-90" id="h247-0-90" class="i">+                }
</a><a href="#h247-0-91" id="h247-0-91" class="i">+            ).filterValues { it != null }.map {
</a><a href="#h247-0-92" id="h247-0-92" class="i">+                line -&gt; &quot;${line.key?.let { &quot;$it: &quot; } ?: &quot;&quot;}${line.value}&quot;
</a><a href="#h247-0-93" id="h247-0-93" class="i">+            }.joinToString(&quot;\n&quot;))
</a><a href="#h247-0-94" id="h247-0-94" class="i">+
</a><a href="#h247-0-95" id="h247-0-95" class="i">+            builder.setPositiveButton(
</a><a href="#h247-0-96" id="h247-0-96" class="i">+                &quot;OK&quot;
</a><a href="#h247-0-97" id="h247-0-97" class="i">+            ) { dialog: DialogInterface, _: Int -&gt; dialog.dismiss() }
</a><a href="#h247-0-98" id="h247-0-98" class="i">+            builder.show()
</a><a href="#h247-0-99" id="h247-0-99" class="i">+        }
</a><a href="#h247-0-100" id="h247-0-100" class="i">+    }
</a><a href="#h247-0-101" id="h247-0-101" class="i">+
</a><a href="#h247-0-102" id="h247-0-102" class="i">+    private fun showPreview(userId: String?, conversationId: String) {
</a><a href="#h247-0-103" id="h247-0-103" class="i">+        //query message
</a><a href="#h247-0-104" id="h247-0-104" class="i">+        val messageLogger = context.feature(MessageLogger::class)
</a><a href="#h247-0-105" id="h247-0-105" class="i">+        val messages: List&lt;ConversationMessage&gt; = context.database.getMessagesFromConversationId(
</a><a href="#h247-0-106" id="h247-0-106" class="i">+            conversationId,
</a><a href="#h247-0-107" id="h247-0-107" class="i">+            context.config.messaging.messagePreviewLength.get()
</a><a href="#h247-0-108" id="h247-0-108" class="i">+        )?.reversed() ?: emptyList()
</a><a href="#h247-0-109" id="h247-0-109" class="i">+
</a><a href="#h247-0-110" id="h247-0-110" class="i">+        val participants: Map&lt;String, FriendInfo&gt; = context.database.getConversationParticipants(conversationId)!!
</a><a href="#h247-0-111" id="h247-0-111" class="i">+            .map { context.database.getFriendInfo(it)!! }
</a><a href="#h247-0-112" id="h247-0-112" class="i">+            .associateBy { it.userId!! }
</a><a href="#h247-0-113" id="h247-0-113" class="i">+        
</a><a href="#h247-0-114" id="h247-0-114" class="i">+        val messageBuilder = StringBuilder()
</a><a href="#h247-0-115" id="h247-0-115" class="i">+
</a><a href="#h247-0-116" id="h247-0-116" class="i">+        messages.forEach { message -&gt;
</a><a href="#h247-0-117" id="h247-0-117" class="i">+            val sender = participants[message.senderId]
</a><a href="#h247-0-118" id="h247-0-118" class="i">+            val protoReader = (
</a><a href="#h247-0-119" id="h247-0-119" class="i">+                messageLogger.takeIf { it.isEnabled }?.getMessageProto(conversationId, message.clientMessageId.toLong()) ?: ProtoReader(message.messageContent ?: return@forEach).followPath(4, 4)
</a><a href="#h247-0-120" id="h247-0-120" class="i">+            ) ?: return@forEach
</a><a href="#h247-0-121" id="h247-0-121" class="i">+
</a><a href="#h247-0-122" id="h247-0-122" class="i">+            val contentType = ContentType.fromMessageContainer(protoReader) ?: ContentType.fromId(message.contentType)
</a><a href="#h247-0-123" id="h247-0-123" class="i">+            var messageString = if (contentType == ContentType.CHAT) {
</a><a href="#h247-0-124" id="h247-0-124" class="i">+                protoReader.getString(2, 1) ?: return@forEach
</a><a href="#h247-0-125" id="h247-0-125" class="i">+            } else {
</a><a href="#h247-0-126" id="h247-0-126" class="i">+                contentType.name
</a><a href="#h247-0-127" id="h247-0-127" class="i">+            }
</a><a href="#h247-0-128" id="h247-0-128" class="i">+
</a><a href="#h247-0-129" id="h247-0-129" class="i">+            if (contentType == ContentType.SNAP) {
</a><a href="#h247-0-130" id="h247-0-130" class="i">+                messageString = &quot;\uD83D\uDFE5&quot; //red square
</a><a href="#h247-0-131" id="h247-0-131" class="i">+                if (message.readTimestamp &gt; 0) {
</a><a href="#h247-0-132" id="h247-0-132" class="i">+                    messageString += &quot; \uD83D\uDC40 &quot; //eyes
</a><a href="#h247-0-133" id="h247-0-133" class="i">+                    messageString += DateFormat.getDateTimeInstance(
</a><a href="#h247-0-134" id="h247-0-134" class="i">+                        DateFormat.SHORT,
</a><a href="#h247-0-135" id="h247-0-135" class="i">+                        DateFormat.SHORT
</a><a href="#h247-0-136" id="h247-0-136" class="i">+                    ).format(Date(message.readTimestamp))
</a><a href="#h247-0-137" id="h247-0-137" class="i">+                }
</a><a href="#h247-0-138" id="h247-0-138" class="i">+            }
</a><a href="#h247-0-139" id="h247-0-139" class="i">+
</a><a href="#h247-0-140" id="h247-0-140" class="i">+            var displayUsername = sender?.displayName ?: sender?.usernameForSorting?: context.translation[&quot;conversation_preview.unknown_user&quot;]
</a><a href="#h247-0-141" id="h247-0-141" class="i">+
</a><a href="#h247-0-142" id="h247-0-142" class="i">+            if (displayUsername.length &gt; 12) {
</a><a href="#h247-0-143" id="h247-0-143" class="i">+                displayUsername = displayUsername.substring(0, 13) + &quot;... &quot;
</a><a href="#h247-0-144" id="h247-0-144" class="i">+            }
</a><a href="#h247-0-145" id="h247-0-145" class="i">+
</a><a href="#h247-0-146" id="h247-0-146" class="i">+            messageBuilder.append(displayUsername).append(&quot;: &quot;).append(messageString).append(&quot;\n&quot;)
</a><a href="#h247-0-147" id="h247-0-147" class="i">+        }
</a><a href="#h247-0-148" id="h247-0-148" class="i">+
</a><a href="#h247-0-149" id="h247-0-149" class="i">+        val targetPerson = if (userId == null) null else participants[userId]
</a><a href="#h247-0-150" id="h247-0-150" class="i">+
</a><a href="#h247-0-151" id="h247-0-151" class="i">+        targetPerson?.streakExpirationTimestamp?.takeIf { it &gt; 0 }?.let {
</a><a href="#h247-0-152" id="h247-0-152" class="i">+            val timeSecondDiff = ((it - System.currentTimeMillis()) / 1000 / 60).toInt()
</a><a href="#h247-0-153" id="h247-0-153" class="i">+            messageBuilder.append(&quot;\n&quot;)
</a><a href="#h247-0-154" id="h247-0-154" class="i">+                .append(&quot;\uD83D\uDD25 &quot;) //fire emoji
</a><a href="#h247-0-155" id="h247-0-155" class="i">+                .append(
</a><a href="#h247-0-156" id="h247-0-156" class="i">+                    context.translation.format(&quot;conversation_preview.streak_expiration&quot;,
</a><a href="#h247-0-157" id="h247-0-157" class="i">+                    &quot;day&quot; to (timeSecondDiff / 60 / 24).toString(),
</a><a href="#h247-0-158" id="h247-0-158" class="i">+                    &quot;hour&quot; to (timeSecondDiff / 60 % 24).toString(),
</a><a href="#h247-0-159" id="h247-0-159" class="i">+                    &quot;minute&quot; to (timeSecondDiff % 60).toString()
</a><a href="#h247-0-160" id="h247-0-160" class="i">+                ))
</a><a href="#h247-0-161" id="h247-0-161" class="i">+        }
</a><a href="#h247-0-162" id="h247-0-162" class="i">+
</a><a href="#h247-0-163" id="h247-0-163" class="i">+        messages.lastOrNull()?.let {
</a><a href="#h247-0-164" id="h247-0-164" class="i">+            messageBuilder
</a><a href="#h247-0-165" id="h247-0-165" class="i">+                .append(&quot;\n\n&quot;)
</a><a href="#h247-0-166" id="h247-0-166" class="i">+                .append(context.translation.format(&quot;conversation_preview.total_messages&quot;, &quot;count&quot; to it.serverMessageId.toString()))
</a><a href="#h247-0-167" id="h247-0-167" class="i">+                .append(&quot;\n&quot;)
</a><a href="#h247-0-168" id="h247-0-168" class="i">+        }
</a><a href="#h247-0-169" id="h247-0-169" class="i">+
</a><a href="#h247-0-170" id="h247-0-170" class="i">+        //alert dialog
</a><a href="#h247-0-171" id="h247-0-171" class="i">+        val builder = ViewAppearanceHelper.newAlertDialogBuilder(context.mainActivity)
</a><a href="#h247-0-172" id="h247-0-172" class="i">+        builder.setTitle(context.translation[&quot;conversation_preview.title&quot;])
</a><a href="#h247-0-173" id="h247-0-173" class="i">+        builder.setMessage(messageBuilder.toString())
</a><a href="#h247-0-174" id="h247-0-174" class="i">+        builder.setPositiveButton(
</a><a href="#h247-0-175" id="h247-0-175" class="i">+            &quot;OK&quot;
</a><a href="#h247-0-176" id="h247-0-176" class="i">+        ) { dialog: DialogInterface, _: Int -&gt; dialog.dismiss() }
</a><a href="#h247-0-177" id="h247-0-177" class="i">+        targetPerson?.let {
</a><a href="#h247-0-178" id="h247-0-178" class="i">+            builder.setNegativeButton(context.translation[&quot;modal_option.profile_info&quot;]) { _, _ -&gt;
</a><a href="#h247-0-179" id="h247-0-179" class="i">+                context.executeAsync { showProfileInfo(it) }
</a><a href="#h247-0-180" id="h247-0-180" class="i">+            }
</a><a href="#h247-0-181" id="h247-0-181" class="i">+        }
</a><a href="#h247-0-182" id="h247-0-182" class="i">+        builder.show()
</a><a href="#h247-0-183" id="h247-0-183" class="i">+    }
</a><a href="#h247-0-184" id="h247-0-184" class="i">+
</a><a href="#h247-0-185" id="h247-0-185" class="i">+    private fun getCurrentConversationInfo(): Pair&lt;String, String?&gt; {
</a><a href="#h247-0-186" id="h247-0-186" class="i">+        val messaging = context.feature(Messaging::class)
</a><a href="#h247-0-187" id="h247-0-187" class="i">+        val focusedConversationTargetUser: String? = messaging.lastFetchConversationUserUUID?.toString()
</a><a href="#h247-0-188" id="h247-0-188" class="i">+
</a><a href="#h247-0-189" id="h247-0-189" class="i">+        //mapped conversation fetch (may not work with legacy sc versions)
</a><a href="#h247-0-190" id="h247-0-190" class="i">+        messaging.lastFetchGroupConversationUUID?.let {
</a><a href="#h247-0-191" id="h247-0-191" class="i">+            context.database.getFeedEntryByConversationId(it.toString())?.let { friendFeedInfo -&gt;
</a><a href="#h247-0-192" id="h247-0-192" class="i">+                val participantSize = friendFeedInfo.participantsSize
</a><a href="#h247-0-193" id="h247-0-193" class="i">+                return it.toString() to if (participantSize == 1) focusedConversationTargetUser else null
</a><a href="#h247-0-194" id="h247-0-194" class="i">+            }
</a><a href="#h247-0-195" id="h247-0-195" class="i">+            throw IllegalStateException(&quot;No conversation found&quot;)
</a><a href="#h247-0-196" id="h247-0-196" class="i">+        }
</a><a href="#h247-0-197" id="h247-0-197" class="i">+
</a><a href="#h247-0-198" id="h247-0-198" class="i">+        //old conversation fetch
</a><a href="#h247-0-199" id="h247-0-199" class="i">+        val conversationId = if (messaging.lastFetchConversationUUID == null &amp;&amp; focusedConversationTargetUser != null) {
</a><a href="#h247-0-200" id="h247-0-200" class="i">+            val conversation: UserConversationLink = context.database.getConversationLinkFromUserId(focusedConversationTargetUser) ?: throw IllegalStateException(&quot;No conversation found&quot;)
</a><a href="#h247-0-201" id="h247-0-201" class="i">+            conversation.clientConversationId!!.trim().lowercase()
</a><a href="#h247-0-202" id="h247-0-202" class="i">+        } else {
</a><a href="#h247-0-203" id="h247-0-203" class="i">+            messaging.lastFetchConversationUUID.toString()
</a><a href="#h247-0-204" id="h247-0-204" class="i">+        }
</a><a href="#h247-0-205" id="h247-0-205" class="i">+
</a><a href="#h247-0-206" id="h247-0-206" class="i">+        return conversationId to focusedConversationTargetUser
</a><a href="#h247-0-207" id="h247-0-207" class="i">+    }
</a><a href="#h247-0-208" id="h247-0-208" class="i">+
</a><a href="#h247-0-209" id="h247-0-209" class="i">+    private fun createToggleFeature(viewConsumer: ((View) -&gt; Unit), text: String, isChecked: () -&gt; Boolean, toggle: (Boolean) -&gt; Unit) {
</a><a href="#h247-0-210" id="h247-0-210" class="i">+        val switch = Switch(context.androidContext)
</a><a href="#h247-0-211" id="h247-0-211" class="i">+        switch.text = context.translation[text]
</a><a href="#h247-0-212" id="h247-0-212" class="i">+        switch.isChecked = isChecked()
</a><a href="#h247-0-213" id="h247-0-213" class="i">+        switch.applyTheme(hasRadius = true)
</a><a href="#h247-0-214" id="h247-0-214" class="i">+        switch.setOnCheckedChangeListener { _: CompoundButton?, checked: Boolean -&gt;
</a><a href="#h247-0-215" id="h247-0-215" class="i">+            toggle(checked)
</a><a href="#h247-0-216" id="h247-0-216" class="i">+        }
</a><a href="#h247-0-217" id="h247-0-217" class="i">+        viewConsumer(switch)
</a><a href="#h247-0-218" id="h247-0-218" class="i">+    }
</a><a href="#h247-0-219" id="h247-0-219" class="i">+
</a><a href="#h247-0-220" id="h247-0-220" class="i">+    fun inject(viewModel: View, viewConsumer: ((View) -&gt; Unit)) {
</a><a href="#h247-0-221" id="h247-0-221" class="i">+        val modContext = context
</a><a href="#h247-0-222" id="h247-0-222" class="i">+
</a><a href="#h247-0-223" id="h247-0-223" class="i">+        val friendFeedMenuOptions by context.config.userInterface.friendFeedMenuButtons
</a><a href="#h247-0-224" id="h247-0-224" class="i">+        if (friendFeedMenuOptions.isEmpty()) return
</a><a href="#h247-0-225" id="h247-0-225" class="i">+
</a><a href="#h247-0-226" id="h247-0-226" class="i">+        val (conversationId, targetUser) = getCurrentConversationInfo()
</a><a href="#h247-0-227" id="h247-0-227" class="i">+
</a><a href="#h247-0-228" id="h247-0-228" class="i">+        val previewButton = Button(viewModel.context).apply {
</a><a href="#h247-0-229" id="h247-0-229" class="i">+            text = modContext.translation[&quot;friend_menu_option.preview&quot;]
</a><a href="#h247-0-230" id="h247-0-230" class="i">+            applyTheme(viewModel.width, hasRadius = true)
</a><a href="#h247-0-231" id="h247-0-231" class="i">+            setOnClickListener {
</a><a href="#h247-0-232" id="h247-0-232" class="i">+                showPreview(
</a><a href="#h247-0-233" id="h247-0-233" class="i">+                    targetUser,
</a><a href="#h247-0-234" id="h247-0-234" class="i">+                    conversationId
</a><a href="#h247-0-235" id="h247-0-235" class="i">+                )
</a><a href="#h247-0-236" id="h247-0-236" class="i">+            }
</a><a href="#h247-0-237" id="h247-0-237" class="i">+        }
</a><a href="#h247-0-238" id="h247-0-238" class="i">+
</a><a href="#h247-0-239" id="h247-0-239" class="i">+        if (friendFeedMenuOptions.contains(&quot;conversation_info&quot;)) {
</a><a href="#h247-0-240" id="h247-0-240" class="i">+            viewConsumer(previewButton)
</a><a href="#h247-0-241" id="h247-0-241" class="i">+        }
</a><a href="#h247-0-242" id="h247-0-242" class="i">+
</a><a href="#h247-0-243" id="h247-0-243" class="i">+        modContext.features.getRuleFeatures().forEach { ruleFeature -&gt;
</a><a href="#h247-0-244" id="h247-0-244" class="i">+            if (!friendFeedMenuOptions.contains(ruleFeature.ruleType.key)) return@forEach
</a><a href="#h247-0-245" id="h247-0-245" class="i">+
</a><a href="#h247-0-246" id="h247-0-246" class="i">+            val ruleState = ruleFeature.getRuleState() ?: return@forEach
</a><a href="#h247-0-247" id="h247-0-247" class="i">+            createToggleFeature(viewConsumer,
</a><a href="#h247-0-248" id="h247-0-248" class="i">+                ruleFeature.ruleType.translateOptionKey(ruleState.key),
</a><a href="#h247-0-249" id="h247-0-249" class="i">+                { ruleFeature.getState(conversationId) },
</a><a href="#h247-0-250" id="h247-0-250" class="i">+                { ruleFeature.setState(conversationId, it) }
</a><a href="#h247-0-251" id="h247-0-251" class="i">+            )
</a><a href="#h247-0-252" id="h247-0-252" class="i">+        }
</a><a href="#h247-0-253" id="h247-0-253" class="i">+    }
</a><a href="#h247-0-254" id="h247-0-254" class="i">+}</a><a href="#h247-0-255" id="h247-0-255" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h248" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/MenuViewInjector.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/MenuViewInjector.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/MenuViewInjector.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/MenuViewInjector.kt</a></b>
<a href="#h248-0" id="h248-0" class="h">@@ -0,0 +1,146 @@
</a><a href="#h248-0-0" id="h248-0-0" class="i">+package me.rhunk.snapenhance.core.ui.menu.impl
</a><a href="#h248-0-1" id="h248-0-1" class="i">+
</a><a href="#h248-0-2" id="h248-0-2" class="i">+import android.annotation.SuppressLint
</a><a href="#h248-0-3" id="h248-0-3" class="i">+import android.view.Gravity
</a><a href="#h248-0-4" id="h248-0-4" class="i">+import android.view.View
</a><a href="#h248-0-5" id="h248-0-5" class="i">+import android.view.ViewGroup
</a><a href="#h248-0-6" id="h248-0-6" class="i">+import android.widget.FrameLayout
</a><a href="#h248-0-7" id="h248-0-7" class="i">+import android.widget.LinearLayout
</a><a href="#h248-0-8" id="h248-0-8" class="i">+import me.rhunk.snapenhance.common.Constants
</a><a href="#h248-0-9" id="h248-0-9" class="i">+import me.rhunk.snapenhance.core.event.events.impl.AddViewEvent
</a><a href="#h248-0-10" id="h248-0-10" class="i">+import me.rhunk.snapenhance.core.features.Feature
</a><a href="#h248-0-11" id="h248-0-11" class="i">+import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a><a href="#h248-0-12" id="h248-0-12" class="i">+import me.rhunk.snapenhance.core.features.impl.messaging.Messaging
</a><a href="#h248-0-13" id="h248-0-13" class="i">+import me.rhunk.snapenhance.core.ui.ViewTagState
</a><a href="#h248-0-14" id="h248-0-14" class="i">+import java.lang.reflect.Modifier
</a><a href="#h248-0-15" id="h248-0-15" class="i">+
</a><a href="#h248-0-16" id="h248-0-16" class="i">+@SuppressLint(&quot;DiscouragedApi&quot;)
</a><a href="#h248-0-17" id="h248-0-17" class="i">+class MenuViewInjector : Feature(&quot;MenuViewInjector&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_ASYNC) {
</a><a href="#h248-0-18" id="h248-0-18" class="i">+    private val viewTagState = ViewTagState()
</a><a href="#h248-0-19" id="h248-0-19" class="i">+
</a><a href="#h248-0-20" id="h248-0-20" class="i">+    private val friendFeedInfoMenu = FriendFeedInfoMenu()
</a><a href="#h248-0-21" id="h248-0-21" class="i">+    private val operaContextActionMenu = OperaContextActionMenu()
</a><a href="#h248-0-22" id="h248-0-22" class="i">+    private val chatActionMenu = ChatActionMenu()
</a><a href="#h248-0-23" id="h248-0-23" class="i">+    private val settingMenu = SettingsMenu()
</a><a href="#h248-0-24" id="h248-0-24" class="i">+    private val settingsGearInjector = SettingsGearInjector()
</a><a href="#h248-0-25" id="h248-0-25" class="i">+
</a><a href="#h248-0-26" id="h248-0-26" class="i">+    private val newChatString by lazy {
</a><a href="#h248-0-27" id="h248-0-27" class="i">+        context.resources.getString(context.resources.getIdentifier(&quot;new_chat&quot;, &quot;string&quot;, Constants.SNAPCHAT_PACKAGE_NAME))
</a><a href="#h248-0-28" id="h248-0-28" class="i">+    }
</a><a href="#h248-0-29" id="h248-0-29" class="i">+
</a><a href="#h248-0-30" id="h248-0-30" class="i">+    @SuppressLint(&quot;ResourceType&quot;)
</a><a href="#h248-0-31" id="h248-0-31" class="i">+    override fun asyncOnActivityCreate() {
</a><a href="#h248-0-32" id="h248-0-32" class="i">+        friendFeedInfoMenu.context = context
</a><a href="#h248-0-33" id="h248-0-33" class="i">+        operaContextActionMenu.context = context
</a><a href="#h248-0-34" id="h248-0-34" class="i">+        chatActionMenu.context = context
</a><a href="#h248-0-35" id="h248-0-35" class="i">+        settingMenu.context = context
</a><a href="#h248-0-36" id="h248-0-36" class="i">+        settingsGearInjector.context = context
</a><a href="#h248-0-37" id="h248-0-37" class="i">+
</a><a href="#h248-0-38" id="h248-0-38" class="i">+        val messaging = context.feature(Messaging::class)
</a><a href="#h248-0-39" id="h248-0-39" class="i">+
</a><a href="#h248-0-40" id="h248-0-40" class="i">+        val actionSheetItemsContainerLayoutId = context.resources.getIdentifier(&quot;action_sheet_items_container&quot;, &quot;id&quot;, Constants.SNAPCHAT_PACKAGE_NAME)
</a><a href="#h248-0-41" id="h248-0-41" class="i">+        val actionSheetContainer = context.resources.getIdentifier(&quot;action_sheet_container&quot;, &quot;id&quot;, Constants.SNAPCHAT_PACKAGE_NAME)
</a><a href="#h248-0-42" id="h248-0-42" class="i">+        val actionMenu = context.resources.getIdentifier(&quot;action_menu&quot;, &quot;id&quot;, Constants.SNAPCHAT_PACKAGE_NAME)
</a><a href="#h248-0-43" id="h248-0-43" class="i">+        val componentsHolder = context.resources.getIdentifier(&quot;components_holder&quot;, &quot;id&quot;, Constants.SNAPCHAT_PACKAGE_NAME)
</a><a href="#h248-0-44" id="h248-0-44" class="i">+        val feedNewChat = context.resources.getIdentifier(&quot;feed_new_chat&quot;, &quot;id&quot;, Constants.SNAPCHAT_PACKAGE_NAME)
</a><a href="#h248-0-45" id="h248-0-45" class="i">+
</a><a href="#h248-0-46" id="h248-0-46" class="i">+        context.event.subscribe(AddViewEvent::class) { event -&gt;
</a><a href="#h248-0-47" id="h248-0-47" class="i">+            val originalAddView: (View) -&gt; Unit = {
</a><a href="#h248-0-48" id="h248-0-48" class="i">+                event.adapter.invokeOriginal(arrayOf(it, -1,
</a><a href="#h248-0-49" id="h248-0-49" class="i">+                    FrameLayout.LayoutParams(
</a><a href="#h248-0-50" id="h248-0-50" class="i">+                        ViewGroup.LayoutParams.MATCH_PARENT,
</a><a href="#h248-0-51" id="h248-0-51" class="i">+                        ViewGroup.LayoutParams.MATCH_PARENT
</a><a href="#h248-0-52" id="h248-0-52" class="i">+                    ))
</a><a href="#h248-0-53" id="h248-0-53" class="i">+                )
</a><a href="#h248-0-54" id="h248-0-54" class="i">+            }
</a><a href="#h248-0-55" id="h248-0-55" class="i">+
</a><a href="#h248-0-56" id="h248-0-56" class="i">+            val viewGroup: ViewGroup = event.parent
</a><a href="#h248-0-57" id="h248-0-57" class="i">+            val childView: View = event.view
</a><a href="#h248-0-58" id="h248-0-58" class="i">+            operaContextActionMenu.inject(event.parent, childView)
</a><a href="#h248-0-59" id="h248-0-59" class="i">+
</a><a href="#h248-0-60" id="h248-0-60" class="i">+            if (event.parent.id == componentsHolder &amp;&amp; childView.id == feedNewChat) {
</a><a href="#h248-0-61" id="h248-0-61" class="i">+                settingsGearInjector.inject(event.parent, childView)
</a><a href="#h248-0-62" id="h248-0-62" class="i">+                return@subscribe
</a><a href="#h248-0-63" id="h248-0-63" class="i">+            }
</a><a href="#h248-0-64" id="h248-0-64" class="i">+
</a><a href="#h248-0-65" id="h248-0-65" class="i">+            //download in chat snaps and notes from the chat action menu
</a><a href="#h248-0-66" id="h248-0-66" class="i">+            if (viewGroup.javaClass.name.endsWith(&quot;ActionMenuChatItemContainer&quot;)) {
</a><a href="#h248-0-67" id="h248-0-67" class="i">+                if (viewGroup.parent == null || viewGroup.parent.parent == null) return@subscribe
</a><a href="#h248-0-68" id="h248-0-68" class="i">+                chatActionMenu.inject(viewGroup)
</a><a href="#h248-0-69" id="h248-0-69" class="i">+                return@subscribe
</a><a href="#h248-0-70" id="h248-0-70" class="i">+            }
</a><a href="#h248-0-71" id="h248-0-71" class="i">+
</a><a href="#h248-0-72" id="h248-0-72" class="i">+            //TODO: inject in group chat menus
</a><a href="#h248-0-73" id="h248-0-73" class="i">+            if (viewGroup.id == actionSheetContainer &amp;&amp; childView.id == actionMenu &amp;&amp; messaging.lastFetchGroupConversationUUID != null) {
</a><a href="#h248-0-74" id="h248-0-74" class="i">+                val injectedLayout = LinearLayout(childView.context).apply {
</a><a href="#h248-0-75" id="h248-0-75" class="i">+                    orientation = LinearLayout.VERTICAL
</a><a href="#h248-0-76" id="h248-0-76" class="i">+                    gravity = Gravity.BOTTOM
</a><a href="#h248-0-77" id="h248-0-77" class="i">+                    layoutParams = ViewGroup.LayoutParams(ViewGroup.LayoutParams.MATCH_PARENT, ViewGroup.LayoutParams.MATCH_PARENT)
</a><a href="#h248-0-78" id="h248-0-78" class="i">+                    addView(childView)
</a><a href="#h248-0-79" id="h248-0-79" class="i">+                    addOnAttachStateChangeListener(object: View.OnAttachStateChangeListener {
</a><a href="#h248-0-80" id="h248-0-80" class="i">+                        override fun onViewAttachedToWindow(v: View) {}
</a><a href="#h248-0-81" id="h248-0-81" class="i">+                        override fun onViewDetachedFromWindow(v: View) {
</a><a href="#h248-0-82" id="h248-0-82" class="i">+                            messaging.lastFetchGroupConversationUUID = null
</a><a href="#h248-0-83" id="h248-0-83" class="i">+                        }
</a><a href="#h248-0-84" id="h248-0-84" class="i">+                    })
</a><a href="#h248-0-85" id="h248-0-85" class="i">+                }
</a><a href="#h248-0-86" id="h248-0-86" class="i">+
</a><a href="#h248-0-87" id="h248-0-87" class="i">+                val viewList = mutableListOf&lt;View&gt;()
</a><a href="#h248-0-88" id="h248-0-88" class="i">+                context.runOnUiThread {
</a><a href="#h248-0-89" id="h248-0-89" class="i">+                    friendFeedInfoMenu.inject(injectedLayout) { view -&gt;
</a><a href="#h248-0-90" id="h248-0-90" class="i">+                        view.layoutParams = LinearLayout.LayoutParams(
</a><a href="#h248-0-91" id="h248-0-91" class="i">+                            ViewGroup.LayoutParams.MATCH_PARENT,
</a><a href="#h248-0-92" id="h248-0-92" class="i">+                            ViewGroup.LayoutParams.WRAP_CONTENT
</a><a href="#h248-0-93" id="h248-0-93" class="i">+                        ).apply {
</a><a href="#h248-0-94" id="h248-0-94" class="i">+                            setMargins(0, 5, 0, 5)
</a><a href="#h248-0-95" id="h248-0-95" class="i">+                        }
</a><a href="#h248-0-96" id="h248-0-96" class="i">+                        viewList.add(view)
</a><a href="#h248-0-97" id="h248-0-97" class="i">+                    }
</a><a href="#h248-0-98" id="h248-0-98" class="i">+
</a><a href="#h248-0-99" id="h248-0-99" class="i">+                    viewList.add(View(injectedLayout.context).apply {
</a><a href="#h248-0-100" id="h248-0-100" class="i">+                        layoutParams = LinearLayout.LayoutParams(
</a><a href="#h248-0-101" id="h248-0-101" class="i">+                            ViewGroup.LayoutParams.MATCH_PARENT,
</a><a href="#h248-0-102" id="h248-0-102" class="i">+                            30
</a><a href="#h248-0-103" id="h248-0-103" class="i">+                        )
</a><a href="#h248-0-104" id="h248-0-104" class="i">+                    })
</a><a href="#h248-0-105" id="h248-0-105" class="i">+
</a><a href="#h248-0-106" id="h248-0-106" class="i">+                    viewList.reversed().forEach { injectedLayout.addView(it, 0) }
</a><a href="#h248-0-107" id="h248-0-107" class="i">+                }
</a><a href="#h248-0-108" id="h248-0-108" class="i">+
</a><a href="#h248-0-109" id="h248-0-109" class="i">+                event.view = injectedLayout
</a><a href="#h248-0-110" id="h248-0-110" class="i">+            }
</a><a href="#h248-0-111" id="h248-0-111" class="i">+
</a><a href="#h248-0-112" id="h248-0-112" class="i">+            if (viewGroup is LinearLayout &amp;&amp; viewGroup.id == actionSheetItemsContainerLayoutId) {
</a><a href="#h248-0-113" id="h248-0-113" class="i">+                val itemStringInterface by lazy {
</a><a href="#h248-0-114" id="h248-0-114" class="i">+                    childView.javaClass.declaredFields.filter {
</a><a href="#h248-0-115" id="h248-0-115" class="i">+                        !it.type.isPrimitive &amp;&amp; Modifier.isAbstract(it.type.modifiers)
</a><a href="#h248-0-116" id="h248-0-116" class="i">+                    }.map {
</a><a href="#h248-0-117" id="h248-0-117" class="i">+                        runCatching {
</a><a href="#h248-0-118" id="h248-0-118" class="i">+                            it.isAccessible = true
</a><a href="#h248-0-119" id="h248-0-119" class="i">+                            it[childView]
</a><a href="#h248-0-120" id="h248-0-120" class="i">+                        }.getOrNull()
</a><a href="#h248-0-121" id="h248-0-121" class="i">+                    }.firstOrNull()
</a><a href="#h248-0-122" id="h248-0-122" class="i">+                }
</a><a href="#h248-0-123" id="h248-0-123" class="i">+
</a><a href="#h248-0-124" id="h248-0-124" class="i">+                //the 3 dot button shows a menu which contains the first item as a Plain object
</a><a href="#h248-0-125" id="h248-0-125" class="i">+                if (viewGroup.getChildCount() == 0 &amp;&amp; itemStringInterface != null &amp;&amp; itemStringInterface.toString().startsWith(&quot;Plain(primaryText=$newChatString&quot;)) {
</a><a href="#h248-0-126" id="h248-0-126" class="i">+                    settingMenu.inject(viewGroup, originalAddView)
</a><a href="#h248-0-127" id="h248-0-127" class="i">+                    viewGroup.addOnAttachStateChangeListener(object: View.OnAttachStateChangeListener {
</a><a href="#h248-0-128" id="h248-0-128" class="i">+                        override fun onViewAttachedToWindow(v: View) {}
</a><a href="#h248-0-129" id="h248-0-129" class="i">+                        override fun onViewDetachedFromWindow(v: View) {
</a><a href="#h248-0-130" id="h248-0-130" class="i">+                            viewTagState.removeState(viewGroup)
</a><a href="#h248-0-131" id="h248-0-131" class="i">+                        }
</a><a href="#h248-0-132" id="h248-0-132" class="i">+                    })
</a><a href="#h248-0-133" id="h248-0-133" class="i">+                    viewTagState[viewGroup]
</a><a href="#h248-0-134" id="h248-0-134" class="i">+                    return@subscribe
</a><a href="#h248-0-135" id="h248-0-135" class="i">+                }
</a><a href="#h248-0-136" id="h248-0-136" class="i">+                if (messaging.lastFetchConversationUUID == null || messaging.lastFetchConversationUserUUID == null) return@subscribe
</a><a href="#h248-0-137" id="h248-0-137" class="i">+
</a><a href="#h248-0-138" id="h248-0-138" class="i">+                //filter by the slot index
</a><a href="#h248-0-139" id="h248-0-139" class="i">+                if (viewGroup.getChildCount() != context.config.userInterface.friendFeedMenuPosition.get()) return@subscribe
</a><a href="#h248-0-140" id="h248-0-140" class="i">+                if (viewTagState[viewGroup]) return@subscribe
</a><a href="#h248-0-141" id="h248-0-141" class="i">+                friendFeedInfoMenu.inject(viewGroup, originalAddView)
</a><a href="#h248-0-142" id="h248-0-142" class="i">+            }
</a><a href="#h248-0-143" id="h248-0-143" class="i">+        }
</a><a href="#h248-0-144" id="h248-0-144" class="i">+    }
</a><a href="#h248-0-145" id="h248-0-145" class="i">+}</a><a href="#h248-0-146" id="h248-0-146" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h249" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/OperaContextActionMenu.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/OperaContextActionMenu.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/OperaContextActionMenu.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/OperaContextActionMenu.kt</a></b>
<a href="#h249-0" id="h249-0" class="h">@@ -0,0 +1,93 @@
</a><a href="#h249-0-0" id="h249-0-0" class="i">+package me.rhunk.snapenhance.core.ui.menu.impl
</a><a href="#h249-0-1" id="h249-0-1" class="i">+
</a><a href="#h249-0-2" id="h249-0-2" class="i">+import android.annotation.SuppressLint
</a><a href="#h249-0-3" id="h249-0-3" class="i">+import android.view.Gravity
</a><a href="#h249-0-4" id="h249-0-4" class="i">+import android.view.View
</a><a href="#h249-0-5" id="h249-0-5" class="i">+import android.view.ViewGroup
</a><a href="#h249-0-6" id="h249-0-6" class="i">+import android.widget.Button
</a><a href="#h249-0-7" id="h249-0-7" class="i">+import android.widget.LinearLayout
</a><a href="#h249-0-8" id="h249-0-8" class="i">+import android.widget.ScrollView
</a><a href="#h249-0-9" id="h249-0-9" class="i">+import me.rhunk.snapenhance.common.Constants
</a><a href="#h249-0-10" id="h249-0-10" class="i">+import me.rhunk.snapenhance.core.features.impl.downloader.MediaDownloader
</a><a href="#h249-0-11" id="h249-0-11" class="i">+import me.rhunk.snapenhance.core.ui.applyTheme
</a><a href="#h249-0-12" id="h249-0-12" class="i">+import me.rhunk.snapenhance.core.ui.menu.AbstractMenu
</a><a href="#h249-0-13" id="h249-0-13" class="i">+
</a><a href="#h249-0-14" id="h249-0-14" class="i">+@SuppressLint(&quot;DiscouragedApi&quot;)
</a><a href="#h249-0-15" id="h249-0-15" class="i">+class OperaContextActionMenu : AbstractMenu() {
</a><a href="#h249-0-16" id="h249-0-16" class="i">+    private val contextCardsScrollView by lazy {
</a><a href="#h249-0-17" id="h249-0-17" class="i">+        context.resources.getIdentifier(&quot;context_cards_scroll_view&quot;, &quot;id&quot;, Constants.SNAPCHAT_PACKAGE_NAME)
</a><a href="#h249-0-18" id="h249-0-18" class="i">+    }
</a><a href="#h249-0-19" id="h249-0-19" class="i">+
</a><a href="#h249-0-20" id="h249-0-20" class="i">+    /*
</a><a href="#h249-0-21" id="h249-0-21" class="i">+    LinearLayout :
</a><a href="#h249-0-22" id="h249-0-22" class="i">+        - LinearLayout:
</a><a href="#h249-0-23" id="h249-0-23" class="i">+            - SnapFontTextView
</a><a href="#h249-0-24" id="h249-0-24" class="i">+            - ImageView
</a><a href="#h249-0-25" id="h249-0-25" class="i">+        - LinearLayout:
</a><a href="#h249-0-26" id="h249-0-26" class="i">+            - SnapFontTextView
</a><a href="#h249-0-27" id="h249-0-27" class="i">+            - ImageView
</a><a href="#h249-0-28" id="h249-0-28" class="i">+        - LinearLayout:
</a><a href="#h249-0-29" id="h249-0-29" class="i">+            - SnapFontTextView
</a><a href="#h249-0-30" id="h249-0-30" class="i">+            - ImageView
</a><a href="#h249-0-31" id="h249-0-31" class="i">+     */
</a><a href="#h249-0-32" id="h249-0-32" class="i">+    private fun isViewGroupButtonMenuContainer(viewGroup: ViewGroup): Boolean {
</a><a href="#h249-0-33" id="h249-0-33" class="i">+        if (viewGroup !is LinearLayout) return false
</a><a href="#h249-0-34" id="h249-0-34" class="i">+        val children = ArrayList&lt;View&gt;()
</a><a href="#h249-0-35" id="h249-0-35" class="i">+        for (i in 0 until viewGroup.getChildCount())
</a><a href="#h249-0-36" id="h249-0-36" class="i">+            children.add(viewGroup.getChildAt(i))
</a><a href="#h249-0-37" id="h249-0-37" class="i">+        return if (children.any { view: View? -&gt; view !is LinearLayout })
</a><a href="#h249-0-38" id="h249-0-38" class="i">+            false
</a><a href="#h249-0-39" id="h249-0-39" class="i">+        else children.map { view: View -&gt; view as LinearLayout }
</a><a href="#h249-0-40" id="h249-0-40" class="i">+            .any { linearLayout: LinearLayout -&gt;
</a><a href="#h249-0-41" id="h249-0-41" class="i">+                val viewChildren = ArrayList&lt;View&gt;()
</a><a href="#h249-0-42" id="h249-0-42" class="i">+                for (i in 0 until linearLayout.childCount) viewChildren.add(
</a><a href="#h249-0-43" id="h249-0-43" class="i">+                    linearLayout.getChildAt(
</a><a href="#h249-0-44" id="h249-0-44" class="i">+                        i
</a><a href="#h249-0-45" id="h249-0-45" class="i">+                    )
</a><a href="#h249-0-46" id="h249-0-46" class="i">+                )
</a><a href="#h249-0-47" id="h249-0-47" class="i">+                viewChildren.any { viewChild: View -&gt;
</a><a href="#h249-0-48" id="h249-0-48" class="i">+                    viewChild.javaClass.name.endsWith(&quot;SnapFontTextView&quot;)
</a><a href="#h249-0-49" id="h249-0-49" class="i">+                }
</a><a href="#h249-0-50" id="h249-0-50" class="i">+            }
</a><a href="#h249-0-51" id="h249-0-51" class="i">+    }
</a><a href="#h249-0-52" id="h249-0-52" class="i">+
</a><a href="#h249-0-53" id="h249-0-53" class="i">+    @SuppressLint(&quot;SetTextI18n&quot;)
</a><a href="#h249-0-54" id="h249-0-54" class="i">+    fun inject(viewGroup: ViewGroup, childView: View) {
</a><a href="#h249-0-55" id="h249-0-55" class="i">+        try {
</a><a href="#h249-0-56" id="h249-0-56" class="i">+            if (viewGroup.parent !is ScrollView) return
</a><a href="#h249-0-57" id="h249-0-57" class="i">+            val parent = viewGroup.parent as ScrollView
</a><a href="#h249-0-58" id="h249-0-58" class="i">+            if (parent.id != contextCardsScrollView) return
</a><a href="#h249-0-59" id="h249-0-59" class="i">+            if (childView !is LinearLayout) return
</a><a href="#h249-0-60" id="h249-0-60" class="i">+            if (!isViewGroupButtonMenuContainer(childView as ViewGroup)) return
</a><a href="#h249-0-61" id="h249-0-61" class="i">+
</a><a href="#h249-0-62" id="h249-0-62" class="i">+            val linearLayout = LinearLayout(childView.getContext())
</a><a href="#h249-0-63" id="h249-0-63" class="i">+            linearLayout.orientation = LinearLayout.VERTICAL
</a><a href="#h249-0-64" id="h249-0-64" class="i">+            linearLayout.gravity = Gravity.CENTER
</a><a href="#h249-0-65" id="h249-0-65" class="i">+            linearLayout.layoutParams =
</a><a href="#h249-0-66" id="h249-0-66" class="i">+                LinearLayout.LayoutParams(
</a><a href="#h249-0-67" id="h249-0-67" class="i">+                    ViewGroup.LayoutParams.MATCH_PARENT,
</a><a href="#h249-0-68" id="h249-0-68" class="i">+                    ViewGroup.LayoutParams.MATCH_PARENT
</a><a href="#h249-0-69" id="h249-0-69" class="i">+                )
</a><a href="#h249-0-70" id="h249-0-70" class="i">+            val translation = context.translation
</a><a href="#h249-0-71" id="h249-0-71" class="i">+            val mediaDownloader = context.feature(MediaDownloader::class)
</a><a href="#h249-0-72" id="h249-0-72" class="i">+
</a><a href="#h249-0-73" id="h249-0-73" class="i">+            linearLayout.addView(Button(childView.getContext()).apply {
</a><a href="#h249-0-74" id="h249-0-74" class="i">+                text = translation[&quot;opera_context_menu.download&quot;]
</a><a href="#h249-0-75" id="h249-0-75" class="i">+                setOnClickListener { mediaDownloader.downloadLastOperaMediaAsync() }
</a><a href="#h249-0-76" id="h249-0-76" class="i">+                applyTheme(isAmoled = false)
</a><a href="#h249-0-77" id="h249-0-77" class="i">+            })
</a><a href="#h249-0-78" id="h249-0-78" class="i">+
</a><a href="#h249-0-79" id="h249-0-79" class="i">+            if (context.isDeveloper) {
</a><a href="#h249-0-80" id="h249-0-80" class="i">+                linearLayout.addView(Button(childView.getContext()).apply {
</a><a href="#h249-0-81" id="h249-0-81" class="i">+                    text = &quot;Show debug info&quot;
</a><a href="#h249-0-82" id="h249-0-82" class="i">+                    setOnClickListener { mediaDownloader.showLastOperaDebugMediaInfo() }
</a><a href="#h249-0-83" id="h249-0-83" class="i">+                    applyTheme(isAmoled = false)
</a><a href="#h249-0-84" id="h249-0-84" class="i">+                })
</a><a href="#h249-0-85" id="h249-0-85" class="i">+            }
</a><a href="#h249-0-86" id="h249-0-86" class="i">+
</a><a href="#h249-0-87" id="h249-0-87" class="i">+            (childView as ViewGroup).addView(linearLayout, 0)
</a><a href="#h249-0-88" id="h249-0-88" class="i">+        } catch (e: Throwable) {
</a><a href="#h249-0-89" id="h249-0-89" class="i">+            context.log.error(&quot;Error while injecting OperaContextActionMenu&quot;, e)
</a><a href="#h249-0-90" id="h249-0-90" class="i">+        }
</a><a href="#h249-0-91" id="h249-0-91" class="i">+    }
</a><a href="#h249-0-92" id="h249-0-92" class="i">+}
</a><b>diff --git a/<a id="h250" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/SettingsGearInjector.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/SettingsGearInjector.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/SettingsGearInjector.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/SettingsGearInjector.kt</a></b>
<a href="#h250-0" id="h250-0" class="h">@@ -0,0 +1,83 @@
</a><a href="#h250-0-0" id="h250-0-0" class="i">+package me.rhunk.snapenhance.core.ui.menu.impl
</a><a href="#h250-0-1" id="h250-0-1" class="i">+
</a><a href="#h250-0-2" id="h250-0-2" class="i">+import android.annotation.SuppressLint
</a><a href="#h250-0-3" id="h250-0-3" class="i">+import android.view.View
</a><a href="#h250-0-4" id="h250-0-4" class="i">+import android.view.ViewGroup
</a><a href="#h250-0-5" id="h250-0-5" class="i">+import android.widget.FrameLayout
</a><a href="#h250-0-6" id="h250-0-6" class="i">+import android.widget.ImageView
</a><a href="#h250-0-7" id="h250-0-7" class="i">+import me.rhunk.snapenhance.common.Constants
</a><a href="#h250-0-8" id="h250-0-8" class="i">+import me.rhunk.snapenhance.core.ui.menu.AbstractMenu
</a><a href="#h250-0-9" id="h250-0-9" class="i">+
</a><a href="#h250-0-10" id="h250-0-10" class="i">+
</a><a href="#h250-0-11" id="h250-0-11" class="i">+@SuppressLint(&quot;DiscouragedApi&quot;)
</a><a href="#h250-0-12" id="h250-0-12" class="i">+class SettingsGearInjector : AbstractMenu() {
</a><a href="#h250-0-13" id="h250-0-13" class="i">+    private val headerButtonOpaqueIconTint by lazy {
</a><a href="#h250-0-14" id="h250-0-14" class="i">+        context.resources.getIdentifier(&quot;headerButtonOpaqueIconTint&quot;, &quot;attr&quot;, Constants.SNAPCHAT_PACKAGE_NAME).let {
</a><a href="#h250-0-15" id="h250-0-15" class="i">+            context.androidContext.theme.obtainStyledAttributes(intArrayOf(it)).getColorStateList(0)
</a><a href="#h250-0-16" id="h250-0-16" class="i">+        }
</a><a href="#h250-0-17" id="h250-0-17" class="i">+    }
</a><a href="#h250-0-18" id="h250-0-18" class="i">+
</a><a href="#h250-0-19" id="h250-0-19" class="i">+    private val settingsSvg by lazy {
</a><a href="#h250-0-20" id="h250-0-20" class="i">+        context.resources.getIdentifier(&quot;svg_settings_32x32&quot;, &quot;drawable&quot;, Constants.SNAPCHAT_PACKAGE_NAME).let {
</a><a href="#h250-0-21" id="h250-0-21" class="i">+            context.resources.getDrawable(it, context.androidContext.theme)
</a><a href="#h250-0-22" id="h250-0-22" class="i">+        }
</a><a href="#h250-0-23" id="h250-0-23" class="i">+    }
</a><a href="#h250-0-24" id="h250-0-24" class="i">+
</a><a href="#h250-0-25" id="h250-0-25" class="i">+    private val ngsHovaHeaderSearchIconBackgroundMarginLeft by lazy {
</a><a href="#h250-0-26" id="h250-0-26" class="i">+        context.resources.getIdentifier(&quot;ngs_hova_header_search_icon_background_margin_left&quot;, &quot;dimen&quot;, Constants.SNAPCHAT_PACKAGE_NAME).let {
</a><a href="#h250-0-27" id="h250-0-27" class="i">+            context.resources.getDimensionPixelSize(it)
</a><a href="#h250-0-28" id="h250-0-28" class="i">+        }
</a><a href="#h250-0-29" id="h250-0-29" class="i">+    }
</a><a href="#h250-0-30" id="h250-0-30" class="i">+
</a><a href="#h250-0-31" id="h250-0-31" class="i">+    @SuppressLint(&quot;SetTextI18n&quot;, &quot;ClickableViewAccessibility&quot;)
</a><a href="#h250-0-32" id="h250-0-32" class="i">+    fun inject(parent: ViewGroup, child: View) {
</a><a href="#h250-0-33" id="h250-0-33" class="i">+        val firstView = (child as ViewGroup).getChildAt(0)
</a><a href="#h250-0-34" id="h250-0-34" class="i">+
</a><a href="#h250-0-35" id="h250-0-35" class="i">+        child.clipChildren = false
</a><a href="#h250-0-36" id="h250-0-36" class="i">+        child.addView(FrameLayout(parent.context).apply {
</a><a href="#h250-0-37" id="h250-0-37" class="i">+            layoutParams = FrameLayout.LayoutParams(firstView.layoutParams.width, firstView.layoutParams.height).apply {
</a><a href="#h250-0-38" id="h250-0-38" class="i">+                y = 0f
</a><a href="#h250-0-39" id="h250-0-39" class="i">+                x = -(ngsHovaHeaderSearchIconBackgroundMarginLeft + firstView.layoutParams.width).toFloat()
</a><a href="#h250-0-40" id="h250-0-40" class="i">+            }
</a><a href="#h250-0-41" id="h250-0-41" class="i">+
</a><a href="#h250-0-42" id="h250-0-42" class="i">+            isClickable = true
</a><a href="#h250-0-43" id="h250-0-43" class="i">+
</a><a href="#h250-0-44" id="h250-0-44" class="i">+            setOnClickListener {
</a><a href="#h250-0-45" id="h250-0-45" class="i">+               /* val intent = Intent().apply {
</a><a href="#h250-0-46" id="h250-0-46" class="i">+                    setClassName(BuildConfig.APPLICATION_ID, &quot;me.rhunk.snapenhance.ui.manager.MainActivity&quot;)
</a><a href="#h250-0-47" id="h250-0-47" class="i">+                    putExtra(&quot;route&quot;, &quot;features&quot;)
</a><a href="#h250-0-48" id="h250-0-48" class="i">+                }
</a><a href="#h250-0-49" id="h250-0-49" class="i">+                context.startActivity(intent)*/
</a><a href="#h250-0-50" id="h250-0-50" class="i">+                this@SettingsGearInjector.context.bridgeClient.openSettingsOverlay()
</a><a href="#h250-0-51" id="h250-0-51" class="i">+            }
</a><a href="#h250-0-52" id="h250-0-52" class="i">+
</a><a href="#h250-0-53" id="h250-0-53" class="i">+            parent.setOnTouchListener { _, event -&gt;
</a><a href="#h250-0-54" id="h250-0-54" class="i">+                if (child.visibility == View.INVISIBLE || child.alpha == 0F) return@setOnTouchListener false
</a><a href="#h250-0-55" id="h250-0-55" class="i">+
</a><a href="#h250-0-56" id="h250-0-56" class="i">+                val viewLocation = IntArray(2)
</a><a href="#h250-0-57" id="h250-0-57" class="i">+                getLocationOnScreen(viewLocation)
</a><a href="#h250-0-58" id="h250-0-58" class="i">+
</a><a href="#h250-0-59" id="h250-0-59" class="i">+                val x = event.rawX - viewLocation[0]
</a><a href="#h250-0-60" id="h250-0-60" class="i">+                val y = event.rawY - viewLocation[1]
</a><a href="#h250-0-61" id="h250-0-61" class="i">+
</a><a href="#h250-0-62" id="h250-0-62" class="i">+                if (x &gt; 0 &amp;&amp; x &lt; width &amp;&amp; y &gt; 0 &amp;&amp; y &lt; height) {
</a><a href="#h250-0-63" id="h250-0-63" class="i">+                    performClick()
</a><a href="#h250-0-64" id="h250-0-64" class="i">+                }
</a><a href="#h250-0-65" id="h250-0-65" class="i">+
</a><a href="#h250-0-66" id="h250-0-66" class="i">+                false
</a><a href="#h250-0-67" id="h250-0-67" class="i">+            }
</a><a href="#h250-0-68" id="h250-0-68" class="i">+            backgroundTintList = firstView.backgroundTintList
</a><a href="#h250-0-69" id="h250-0-69" class="i">+            background = firstView.background
</a><a href="#h250-0-70" id="h250-0-70" class="i">+
</a><a href="#h250-0-71" id="h250-0-71" class="i">+            addView(ImageView(context).apply {
</a><a href="#h250-0-72" id="h250-0-72" class="i">+                layoutParams = FrameLayout.LayoutParams(ViewGroup.LayoutParams.WRAP_CONTENT, ViewGroup.LayoutParams.WRAP_CONTENT, 17).apply {
</a><a href="#h250-0-73" id="h250-0-73" class="i">+                    gravity = android.view.Gravity.CENTER
</a><a href="#h250-0-74" id="h250-0-74" class="i">+                }
</a><a href="#h250-0-75" id="h250-0-75" class="i">+                setImageDrawable(settingsSvg)
</a><a href="#h250-0-76" id="h250-0-76" class="i">+                headerButtonOpaqueIconTint?.let {
</a><a href="#h250-0-77" id="h250-0-77" class="i">+                    imageTintList = it
</a><a href="#h250-0-78" id="h250-0-78" class="i">+                }
</a><a href="#h250-0-79" id="h250-0-79" class="i">+            })
</a><a href="#h250-0-80" id="h250-0-80" class="i">+        })
</a><a href="#h250-0-81" id="h250-0-81" class="i">+    }
</a><a href="#h250-0-82" id="h250-0-82" class="i">+}</a><a href="#h250-0-83" id="h250-0-83" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h251" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/SettingsMenu.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/SettingsMenu.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/SettingsMenu.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/SettingsMenu.kt</a></b>
<a href="#h251-0" id="h251-0" class="h">@@ -0,0 +1,29 @@
</a><a href="#h251-0-0" id="h251-0-0" class="i">+package me.rhunk.snapenhance.core.ui.menu.impl
</a><a href="#h251-0-1" id="h251-0-1" class="i">+
</a><a href="#h251-0-2" id="h251-0-2" class="i">+import android.annotation.SuppressLint
</a><a href="#h251-0-3" id="h251-0-3" class="i">+import android.view.View
</a><a href="#h251-0-4" id="h251-0-4" class="i">+import me.rhunk.snapenhance.core.ui.menu.AbstractMenu
</a><a href="#h251-0-5" id="h251-0-5" class="i">+
</a><a href="#h251-0-6" id="h251-0-6" class="i">+class SettingsMenu : AbstractMenu() {
</a><a href="#h251-0-7" id="h251-0-7" class="i">+    //TODO: quick settings
</a><a href="#h251-0-8" id="h251-0-8" class="i">+    @SuppressLint(&quot;SetTextI18n&quot;)
</a><a href="#h251-0-9" id="h251-0-9" class="i">+    @Suppress(&quot;UNUSED_PARAMETER&quot;)
</a><a href="#h251-0-10" id="h251-0-10" class="i">+    fun inject(viewModel: View, addView: (View) -&gt; Unit) {
</a><a href="#h251-0-11" id="h251-0-11" class="i">+        /*val actions = context.actionManager.getActions().map {
</a><a href="#h251-0-12" id="h251-0-12" class="i">+            Pair(it) {
</a><a href="#h251-0-13" id="h251-0-13" class="i">+                val button = Button(viewModel.context)
</a><a href="#h251-0-14" id="h251-0-14" class="i">+                button.text = context.translation[it.nameKey]
</a><a href="#h251-0-15" id="h251-0-15" class="i">+
</a><a href="#h251-0-16" id="h251-0-16" class="i">+                button.setOnClickListener { _ -&gt;
</a><a href="#h251-0-17" id="h251-0-17" class="i">+                    it.run()
</a><a href="#h251-0-18" id="h251-0-18" class="i">+                }
</a><a href="#h251-0-19" id="h251-0-19" class="i">+                ViewAppearanceHelper.applyTheme(button)
</a><a href="#h251-0-20" id="h251-0-20" class="i">+                button
</a><a href="#h251-0-21" id="h251-0-21" class="i">+            }
</a><a href="#h251-0-22" id="h251-0-22" class="i">+        }
</a><a href="#h251-0-23" id="h251-0-23" class="i">+
</a><a href="#h251-0-24" id="h251-0-24" class="i">+        actions.forEach {
</a><a href="#h251-0-25" id="h251-0-25" class="i">+            addView(it.second())
</a><a href="#h251-0-26" id="h251-0-26" class="i">+        }*/
</a><a href="#h251-0-27" id="h251-0-27" class="i">+    }
</a><a href="#h251-0-28" id="h251-0-28" class="i">+}</a><a href="#h251-0-29" id="h251-0-29" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h252" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/util/CallbackBuilder.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/util/CallbackBuilder.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/util/CallbackBuilder.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/util/CallbackBuilder.kt</a></b>
<a href="#h252-0" id="h252-0" class="h">@@ -1,9 +1,9 @@
</a> package me.rhunk.snapenhance.core.util
 
 import de.robv.android.xposed.XC_MethodHook
<a href="#h252-0-3" id="h252-0-3" class="d">-import me.rhunk.snapenhance.hook.HookAdapter
</a><a href="#h252-0-4" id="h252-0-4" class="d">-import me.rhunk.snapenhance.hook.HookStage
</a><a href="#h252-0-5" id="h252-0-5" class="d">-import me.rhunk.snapenhance.hook.Hooker
</a><a href="#h252-0-6" id="h252-0-6" class="i">+import me.rhunk.snapenhance.core.util.hook.HookAdapter
</a><a href="#h252-0-7" id="h252-0-7" class="i">+import me.rhunk.snapenhance.core.util.hook.HookStage
</a><a href="#h252-0-8" id="h252-0-8" class="i">+import me.rhunk.snapenhance.core.util.hook.Hooker
</a> import java.lang.reflect.Constructor
 import java.lang.reflect.Field
 import java.lang.reflect.Modifier
<b>diff --git a/<a id="h253" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/util/SQLiteDatabaseHelper.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/util/SQLiteDatabaseHelper.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/util/SQLiteDatabaseHelper.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/util/SQLiteDatabaseHelper.kt</a></b>
<a href="#h253-0" id="h253-0" class="h">@@ -1,31 +0,0 @@
</a><a href="#h253-0-0" id="h253-0-0" class="d">-package me.rhunk.snapenhance.core.util
</a><a href="#h253-0-1" id="h253-0-1" class="d">-
</a><a href="#h253-0-2" id="h253-0-2" class="d">-import android.annotation.SuppressLint
</a><a href="#h253-0-3" id="h253-0-3" class="d">-import android.database.sqlite.SQLiteDatabase
</a><a href="#h253-0-4" id="h253-0-4" class="d">-import me.rhunk.snapenhance.core.Logger
</a><a href="#h253-0-5" id="h253-0-5" class="d">-
</a><a href="#h253-0-6" id="h253-0-6" class="d">-object SQLiteDatabaseHelper {
</a><a href="#h253-0-7" id="h253-0-7" class="d">-    @SuppressLint(&quot;Range&quot;)
</a><a href="#h253-0-8" id="h253-0-8" class="d">-    fun createTablesFromSchema(sqLiteDatabase: SQLiteDatabase, databaseSchema: Map&lt;String, List&lt;String&gt;&gt;) {
</a><a href="#h253-0-9" id="h253-0-9" class="d">-        databaseSchema.forEach { (tableName, columns) -&gt;
</a><a href="#h253-0-10" id="h253-0-10" class="d">-            sqLiteDatabase.execSQL(&quot;CREATE TABLE IF NOT EXISTS $tableName (${columns.joinToString(&quot;, &quot;)})&quot;)
</a><a href="#h253-0-11" id="h253-0-11" class="d">-
</a><a href="#h253-0-12" id="h253-0-12" class="d">-            val cursor = sqLiteDatabase.rawQuery(&quot;PRAGMA table_info($tableName)&quot;, null)
</a><a href="#h253-0-13" id="h253-0-13" class="d">-            val existingColumns = mutableListOf&lt;String&gt;()
</a><a href="#h253-0-14" id="h253-0-14" class="d">-            while (cursor.moveToNext()) {
</a><a href="#h253-0-15" id="h253-0-15" class="d">-                existingColumns.add(cursor.getString(cursor.getColumnIndex(&quot;name&quot;)) + &quot; &quot; + cursor.getString(cursor.getColumnIndex(&quot;type&quot;)))
</a><a href="#h253-0-16" id="h253-0-16" class="d">-            }
</a><a href="#h253-0-17" id="h253-0-17" class="d">-            cursor.close()
</a><a href="#h253-0-18" id="h253-0-18" class="d">-
</a><a href="#h253-0-19" id="h253-0-19" class="d">-            val newColumns = columns.filter {
</a><a href="#h253-0-20" id="h253-0-20" class="d">-                existingColumns.none { existingColumn -&gt; it.startsWith(existingColumn) }
</a><a href="#h253-0-21" id="h253-0-21" class="d">-            }
</a><a href="#h253-0-22" id="h253-0-22" class="d">-
</a><a href="#h253-0-23" id="h253-0-23" class="d">-            if (newColumns.isEmpty()) return@forEach
</a><a href="#h253-0-24" id="h253-0-24" class="d">-
</a><a href="#h253-0-25" id="h253-0-25" class="d">-            Logger.directDebug(&quot;Schema for table $tableName has changed&quot;)
</a><a href="#h253-0-26" id="h253-0-26" class="d">-            sqLiteDatabase.execSQL(&quot;DROP TABLE $tableName&quot;)
</a><a href="#h253-0-27" id="h253-0-27" class="d">-            sqLiteDatabase.execSQL(&quot;CREATE TABLE IF NOT EXISTS $tableName (${columns.joinToString(&quot;, &quot;)})&quot;)
</a><a href="#h253-0-28" id="h253-0-28" class="d">-        }
</a><a href="#h253-0-29" id="h253-0-29" class="d">-    }
</a><a href="#h253-0-30" id="h253-0-30" class="d">-}</a><a href="#h253-0-31" id="h253-0-31" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h254" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/util/SerializableDataObject.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/util/SerializableDataObject.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/util/SerializableDataObject.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/util/SerializableDataObject.kt</a></b>
<a href="#h254-0" id="h254-0" class="h">@@ -1,22 +0,0 @@
</a><a href="#h254-0-0" id="h254-0-0" class="d">-package me.rhunk.snapenhance.core.util
</a><a href="#h254-0-1" id="h254-0-1" class="d">-
</a><a href="#h254-0-2" id="h254-0-2" class="d">-import com.google.gson.Gson
</a><a href="#h254-0-3" id="h254-0-3" class="d">-import com.google.gson.GsonBuilder
</a><a href="#h254-0-4" id="h254-0-4" class="d">-
</a><a href="#h254-0-5" id="h254-0-5" class="d">-open class SerializableDataObject {
</a><a href="#h254-0-6" id="h254-0-6" class="d">-    companion object {
</a><a href="#h254-0-7" id="h254-0-7" class="d">-        val gson: Gson = GsonBuilder().create()
</a><a href="#h254-0-8" id="h254-0-8" class="d">-
</a><a href="#h254-0-9" id="h254-0-9" class="d">-        inline fun &lt;reified T : SerializableDataObject&gt; fromJson(json: String): T {
</a><a href="#h254-0-10" id="h254-0-10" class="d">-            return gson.fromJson(json, T::class.java)
</a><a href="#h254-0-11" id="h254-0-11" class="d">-        }
</a><a href="#h254-0-12" id="h254-0-12" class="d">-
</a><a href="#h254-0-13" id="h254-0-13" class="d">-        inline fun &lt;reified T : SerializableDataObject&gt; fromJson(json: String, type: Class&lt;T&gt;): T {
</a><a href="#h254-0-14" id="h254-0-14" class="d">-            return gson.fromJson(json, type)
</a><a href="#h254-0-15" id="h254-0-15" class="d">-        }
</a><a href="#h254-0-16" id="h254-0-16" class="d">-    }
</a><a href="#h254-0-17" id="h254-0-17" class="d">-
</a><a href="#h254-0-18" id="h254-0-18" class="d">-    fun toJson(): String {
</a><a href="#h254-0-19" id="h254-0-19" class="d">-        return gson.toJson(this)
</a><a href="#h254-0-20" id="h254-0-20" class="d">-    }
</a><a href="#h254-0-21" id="h254-0-21" class="d">-}</a><a href="#h254-0-22" id="h254-0-22" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h255" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/util/download/HttpServer.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/util/download/HttpServer.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/util/download/HttpServer.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/util/download/HttpServer.kt</a></b>
<a href="#h255-0" id="h255-0" class="h">@@ -1,139 +0,0 @@
</a><a href="#h255-0-0" id="h255-0-0" class="d">-package me.rhunk.snapenhance.core.util.download
</a><a href="#h255-0-1" id="h255-0-1" class="d">-
</a><a href="#h255-0-2" id="h255-0-2" class="d">-import kotlinx.coroutines.CoroutineScope
</a><a href="#h255-0-3" id="h255-0-3" class="d">-import kotlinx.coroutines.Dispatchers
</a><a href="#h255-0-4" id="h255-0-4" class="d">-import kotlinx.coroutines.Job
</a><a href="#h255-0-5" id="h255-0-5" class="d">-import kotlinx.coroutines.delay
</a><a href="#h255-0-6" id="h255-0-6" class="d">-import kotlinx.coroutines.launch
</a><a href="#h255-0-7" id="h255-0-7" class="d">-import me.rhunk.snapenhance.core.Logger
</a><a href="#h255-0-8" id="h255-0-8" class="d">-import java.io.BufferedReader
</a><a href="#h255-0-9" id="h255-0-9" class="d">-import java.io.InputStream
</a><a href="#h255-0-10" id="h255-0-10" class="d">-import java.io.InputStreamReader
</a><a href="#h255-0-11" id="h255-0-11" class="d">-import java.io.PrintWriter
</a><a href="#h255-0-12" id="h255-0-12" class="d">-import java.net.ServerSocket
</a><a href="#h255-0-13" id="h255-0-13" class="d">-import java.net.Socket
</a><a href="#h255-0-14" id="h255-0-14" class="d">-import java.net.SocketException
</a><a href="#h255-0-15" id="h255-0-15" class="d">-import java.util.Locale
</a><a href="#h255-0-16" id="h255-0-16" class="d">-import java.util.StringTokenizer
</a><a href="#h255-0-17" id="h255-0-17" class="d">-import java.util.concurrent.ConcurrentHashMap
</a><a href="#h255-0-18" id="h255-0-18" class="d">-import kotlin.random.Random
</a><a href="#h255-0-19" id="h255-0-19" class="d">-
</a><a href="#h255-0-20" id="h255-0-20" class="d">-class HttpServer(
</a><a href="#h255-0-21" id="h255-0-21" class="d">-    private val timeout: Int = 10000
</a><a href="#h255-0-22" id="h255-0-22" class="d">-) {
</a><a href="#h255-0-23" id="h255-0-23" class="d">-    val port = Random.nextInt(10000, 65535)
</a><a href="#h255-0-24" id="h255-0-24" class="d">-
</a><a href="#h255-0-25" id="h255-0-25" class="d">-    private val coroutineScope = CoroutineScope(Dispatchers.IO)
</a><a href="#h255-0-26" id="h255-0-26" class="d">-    private var timeoutJob: Job? = null
</a><a href="#h255-0-27" id="h255-0-27" class="d">-    private var socketJob: Job? = null
</a><a href="#h255-0-28" id="h255-0-28" class="d">-
</a><a href="#h255-0-29" id="h255-0-29" class="d">-    private val cachedData = ConcurrentHashMap&lt;String, Pair&lt;InputStream, Long&gt;&gt;()
</a><a href="#h255-0-30" id="h255-0-30" class="d">-    private var serverSocket: ServerSocket? = null
</a><a href="#h255-0-31" id="h255-0-31" class="d">-
</a><a href="#h255-0-32" id="h255-0-32" class="d">-    fun ensureServerStarted(callback: HttpServer.() -&gt; Unit) {
</a><a href="#h255-0-33" id="h255-0-33" class="d">-        if (serverSocket != null &amp;&amp; !serverSocket!!.isClosed) {
</a><a href="#h255-0-34" id="h255-0-34" class="d">-            callback(this)
</a><a href="#h255-0-35" id="h255-0-35" class="d">-            return
</a><a href="#h255-0-36" id="h255-0-36" class="d">-        }
</a><a href="#h255-0-37" id="h255-0-37" class="d">-
</a><a href="#h255-0-38" id="h255-0-38" class="d">-        coroutineScope.launch(Dispatchers.IO) {
</a><a href="#h255-0-39" id="h255-0-39" class="d">-            Logger.directDebug(&quot;starting http server on port $port&quot;)
</a><a href="#h255-0-40" id="h255-0-40" class="d">-            serverSocket = ServerSocket(port)
</a><a href="#h255-0-41" id="h255-0-41" class="d">-            callback(this@HttpServer)
</a><a href="#h255-0-42" id="h255-0-42" class="d">-            while (!serverSocket!!.isClosed) {
</a><a href="#h255-0-43" id="h255-0-43" class="d">-                try {
</a><a href="#h255-0-44" id="h255-0-44" class="d">-                    val socket = serverSocket!!.accept()
</a><a href="#h255-0-45" id="h255-0-45" class="d">-                    timeoutJob?.cancel()
</a><a href="#h255-0-46" id="h255-0-46" class="d">-                    launch {
</a><a href="#h255-0-47" id="h255-0-47" class="d">-                        handleRequest(socket)
</a><a href="#h255-0-48" id="h255-0-48" class="d">-                        timeoutJob = launch {
</a><a href="#h255-0-49" id="h255-0-49" class="d">-                            delay(timeout.toLong())
</a><a href="#h255-0-50" id="h255-0-50" class="d">-                            Logger.directDebug(&quot;http server closed due to timeout&quot;)
</a><a href="#h255-0-51" id="h255-0-51" class="d">-                            runCatching {
</a><a href="#h255-0-52" id="h255-0-52" class="d">-                                socketJob?.cancel()
</a><a href="#h255-0-53" id="h255-0-53" class="d">-                                socket.close()
</a><a href="#h255-0-54" id="h255-0-54" class="d">-                                serverSocket?.close()
</a><a href="#h255-0-55" id="h255-0-55" class="d">-                            }.onFailure {
</a><a href="#h255-0-56" id="h255-0-56" class="d">-                                Logger.directError(&quot;failed to close socket&quot;, it)
</a><a href="#h255-0-57" id="h255-0-57" class="d">-                            }
</a><a href="#h255-0-58" id="h255-0-58" class="d">-                        }
</a><a href="#h255-0-59" id="h255-0-59" class="d">-                    }
</a><a href="#h255-0-60" id="h255-0-60" class="d">-                } catch (e: SocketException) {
</a><a href="#h255-0-61" id="h255-0-61" class="d">-                    Logger.directDebug(&quot;http server timed out&quot;)
</a><a href="#h255-0-62" id="h255-0-62" class="d">-                    break;
</a><a href="#h255-0-63" id="h255-0-63" class="d">-                } catch (e: Throwable) {
</a><a href="#h255-0-64" id="h255-0-64" class="d">-                    Logger.directError(&quot;failed to handle request&quot;, e)
</a><a href="#h255-0-65" id="h255-0-65" class="d">-                }
</a><a href="#h255-0-66" id="h255-0-66" class="d">-            }
</a><a href="#h255-0-67" id="h255-0-67" class="d">-        }.also { socketJob = it }
</a><a href="#h255-0-68" id="h255-0-68" class="d">-    }
</a><a href="#h255-0-69" id="h255-0-69" class="d">-
</a><a href="#h255-0-70" id="h255-0-70" class="d">-    fun close() {
</a><a href="#h255-0-71" id="h255-0-71" class="d">-        serverSocket?.close()
</a><a href="#h255-0-72" id="h255-0-72" class="d">-    }
</a><a href="#h255-0-73" id="h255-0-73" class="d">-
</a><a href="#h255-0-74" id="h255-0-74" class="d">-    fun putDownloadableContent(inputStream: InputStream, size: Long): String {
</a><a href="#h255-0-75" id="h255-0-75" class="d">-        val key = System.nanoTime().toString(16)
</a><a href="#h255-0-76" id="h255-0-76" class="d">-        cachedData[key] = inputStream to size
</a><a href="#h255-0-77" id="h255-0-77" class="d">-        return &quot;http://127.0.0.1:$port/$key&quot;
</a><a href="#h255-0-78" id="h255-0-78" class="d">-    }
</a><a href="#h255-0-79" id="h255-0-79" class="d">-
</a><a href="#h255-0-80" id="h255-0-80" class="d">-    private fun handleRequest(socket: Socket) {
</a><a href="#h255-0-81" id="h255-0-81" class="d">-        val reader = BufferedReader(InputStreamReader(socket.getInputStream()))
</a><a href="#h255-0-82" id="h255-0-82" class="d">-        val outputStream = socket.getOutputStream()
</a><a href="#h255-0-83" id="h255-0-83" class="d">-        val writer = PrintWriter(outputStream)
</a><a href="#h255-0-84" id="h255-0-84" class="d">-        val line = reader.readLine() ?: return
</a><a href="#h255-0-85" id="h255-0-85" class="d">-        fun close() {
</a><a href="#h255-0-86" id="h255-0-86" class="d">-            runCatching {
</a><a href="#h255-0-87" id="h255-0-87" class="d">-                reader.close()
</a><a href="#h255-0-88" id="h255-0-88" class="d">-                writer.close()
</a><a href="#h255-0-89" id="h255-0-89" class="d">-                outputStream.close()
</a><a href="#h255-0-90" id="h255-0-90" class="d">-                socket.close()
</a><a href="#h255-0-91" id="h255-0-91" class="d">-            }.onFailure {
</a><a href="#h255-0-92" id="h255-0-92" class="d">-                Logger.directError(&quot;failed to close socket&quot;, it)
</a><a href="#h255-0-93" id="h255-0-93" class="d">-            }
</a><a href="#h255-0-94" id="h255-0-94" class="d">-        }
</a><a href="#h255-0-95" id="h255-0-95" class="d">-        val parse = StringTokenizer(line)
</a><a href="#h255-0-96" id="h255-0-96" class="d">-        val method = parse.nextToken().uppercase(Locale.getDefault())
</a><a href="#h255-0-97" id="h255-0-97" class="d">-        var fileRequested = parse.nextToken().lowercase(Locale.getDefault())
</a><a href="#h255-0-98" id="h255-0-98" class="d">-        Logger.directDebug(&quot;[http-server:${port}] $method $fileRequested&quot;)
</a><a href="#h255-0-99" id="h255-0-99" class="d">-
</a><a href="#h255-0-100" id="h255-0-100" class="d">-        if (method != &quot;GET&quot;) {
</a><a href="#h255-0-101" id="h255-0-101" class="d">-            with(writer) {
</a><a href="#h255-0-102" id="h255-0-102" class="d">-                println(&quot;HTTP/1.1 501 Not Implemented&quot;)
</a><a href="#h255-0-103" id="h255-0-103" class="d">-                println(&quot;Content-type: &quot; + &quot;application/octet-stream&quot;)
</a><a href="#h255-0-104" id="h255-0-104" class="d">-                println(&quot;Content-length: &quot; + 0)
</a><a href="#h255-0-105" id="h255-0-105" class="d">-                println()
</a><a href="#h255-0-106" id="h255-0-106" class="d">-                flush()
</a><a href="#h255-0-107" id="h255-0-107" class="d">-            }
</a><a href="#h255-0-108" id="h255-0-108" class="d">-            close()
</a><a href="#h255-0-109" id="h255-0-109" class="d">-            return
</a><a href="#h255-0-110" id="h255-0-110" class="d">-        }
</a><a href="#h255-0-111" id="h255-0-111" class="d">-        if (fileRequested.startsWith(&quot;/&quot;)) {
</a><a href="#h255-0-112" id="h255-0-112" class="d">-            fileRequested = fileRequested.substring(1)
</a><a href="#h255-0-113" id="h255-0-113" class="d">-        }
</a><a href="#h255-0-114" id="h255-0-114" class="d">-        if (!cachedData.containsKey(fileRequested)) {
</a><a href="#h255-0-115" id="h255-0-115" class="d">-            with(writer) {
</a><a href="#h255-0-116" id="h255-0-116" class="d">-                println(&quot;HTTP/1.1 404 Not Found&quot;)
</a><a href="#h255-0-117" id="h255-0-117" class="d">-                println(&quot;Content-type: &quot; + &quot;application/octet-stream&quot;)
</a><a href="#h255-0-118" id="h255-0-118" class="d">-                println(&quot;Content-length: &quot; + 0)
</a><a href="#h255-0-119" id="h255-0-119" class="d">-                println()
</a><a href="#h255-0-120" id="h255-0-120" class="d">-                flush()
</a><a href="#h255-0-121" id="h255-0-121" class="d">-            }
</a><a href="#h255-0-122" id="h255-0-122" class="d">-            close()
</a><a href="#h255-0-123" id="h255-0-123" class="d">-            return
</a><a href="#h255-0-124" id="h255-0-124" class="d">-        }
</a><a href="#h255-0-125" id="h255-0-125" class="d">-        val requestedData = cachedData[fileRequested]!!
</a><a href="#h255-0-126" id="h255-0-126" class="d">-        with(writer) {
</a><a href="#h255-0-127" id="h255-0-127" class="d">-            println(&quot;HTTP/1.1 200 OK&quot;)
</a><a href="#h255-0-128" id="h255-0-128" class="d">-            println(&quot;Content-type: &quot; + &quot;application/octet-stream&quot;)
</a><a href="#h255-0-129" id="h255-0-129" class="d">-            println(&quot;Content-length: &quot; + requestedData.second)
</a><a href="#h255-0-130" id="h255-0-130" class="d">-            println()
</a><a href="#h255-0-131" id="h255-0-131" class="d">-            flush()
</a><a href="#h255-0-132" id="h255-0-132" class="d">-        }
</a><a href="#h255-0-133" id="h255-0-133" class="d">-        requestedData.first.copyTo(outputStream)
</a><a href="#h255-0-134" id="h255-0-134" class="d">-        outputStream.flush()
</a><a href="#h255-0-135" id="h255-0-135" class="d">-        cachedData.remove(fileRequested)
</a><a href="#h255-0-136" id="h255-0-136" class="d">-        close()
</a><a href="#h255-0-137" id="h255-0-137" class="d">-    }
</a><a href="#h255-0-138" id="h255-0-138" class="d">-}</a><a href="#h255-0-139" id="h255-0-139" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h256" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/util/download/RemoteMediaResolver.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/util/download/RemoteMediaResolver.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/util/download/RemoteMediaResolver.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/util/download/RemoteMediaResolver.kt</a></b>
<a href="#h256-0" id="h256-0" class="h">@@ -1,68 +0,0 @@
</a><a href="#h256-0-0" id="h256-0-0" class="d">-package me.rhunk.snapenhance.core.util.download
</a><a href="#h256-0-1" id="h256-0-1" class="d">-
</a><a href="#h256-0-2" id="h256-0-2" class="d">-import me.rhunk.snapenhance.Constants
</a><a href="#h256-0-3" id="h256-0-3" class="d">-import me.rhunk.snapenhance.core.Logger
</a><a href="#h256-0-4" id="h256-0-4" class="d">-import okhttp3.OkHttpClient
</a><a href="#h256-0-5" id="h256-0-5" class="d">-import okhttp3.Request
</a><a href="#h256-0-6" id="h256-0-6" class="d">-import java.io.InputStream
</a><a href="#h256-0-7" id="h256-0-7" class="d">-import java.util.Base64
</a><a href="#h256-0-8" id="h256-0-8" class="d">-
</a><a href="#h256-0-9" id="h256-0-9" class="d">-object RemoteMediaResolver {
</a><a href="#h256-0-10" id="h256-0-10" class="d">-    private const val BOLT_HTTP_RESOLVER_URL = &quot;https://web.snapchat.com/bolt-http&quot;
</a><a href="#h256-0-11" id="h256-0-11" class="d">-    const val CF_ST_CDN_D = &quot;https://cf-st.sc-cdn.net/d/&quot;
</a><a href="#h256-0-12" id="h256-0-12" class="d">-
</a><a href="#h256-0-13" id="h256-0-13" class="d">-    private val urlCache = mutableMapOf&lt;String, String&gt;()
</a><a href="#h256-0-14" id="h256-0-14" class="d">-
</a><a href="#h256-0-15" id="h256-0-15" class="d">-    private val okHttpClient = OkHttpClient.Builder()
</a><a href="#h256-0-16" id="h256-0-16" class="d">-        .followRedirects(true)
</a><a href="#h256-0-17" id="h256-0-17" class="d">-        .retryOnConnectionFailure(true)
</a><a href="#h256-0-18" id="h256-0-18" class="d">-        .readTimeout(20, java.util.concurrent.TimeUnit.SECONDS)
</a><a href="#h256-0-19" id="h256-0-19" class="d">-        .addInterceptor { chain -&gt;
</a><a href="#h256-0-20" id="h256-0-20" class="d">-            val request = chain.request()
</a><a href="#h256-0-21" id="h256-0-21" class="d">-            val requestUrl = request.url.toString()
</a><a href="#h256-0-22" id="h256-0-22" class="d">-
</a><a href="#h256-0-23" id="h256-0-23" class="d">-            if (urlCache.containsKey(requestUrl)) {
</a><a href="#h256-0-24" id="h256-0-24" class="d">-                val cachedUrl = urlCache[requestUrl]!!
</a><a href="#h256-0-25" id="h256-0-25" class="d">-                return@addInterceptor chain.proceed(request.newBuilder().url(cachedUrl).build())
</a><a href="#h256-0-26" id="h256-0-26" class="d">-            }
</a><a href="#h256-0-27" id="h256-0-27" class="d">-
</a><a href="#h256-0-28" id="h256-0-28" class="d">-            chain.proceed(request).apply {
</a><a href="#h256-0-29" id="h256-0-29" class="d">-                val responseUrl = this.request.url.toString()
</a><a href="#h256-0-30" id="h256-0-30" class="d">-                if (responseUrl.startsWith(&quot;https://cf-st.sc-cdn.net&quot;)) {
</a><a href="#h256-0-31" id="h256-0-31" class="d">-                    urlCache[requestUrl] = responseUrl
</a><a href="#h256-0-32" id="h256-0-32" class="d">-                }
</a><a href="#h256-0-33" id="h256-0-33" class="d">-            }
</a><a href="#h256-0-34" id="h256-0-34" class="d">-        }
</a><a href="#h256-0-35" id="h256-0-35" class="d">-        .build()
</a><a href="#h256-0-36" id="h256-0-36" class="d">-
</a><a href="#h256-0-37" id="h256-0-37" class="d">-    private fun newResolveRequest(protoKey: ByteArray) = Request.Builder()
</a><a href="#h256-0-38" id="h256-0-38" class="d">-        .url(BOLT_HTTP_RESOLVER_URL + &quot;/resolve?co=&quot; + Base64.getUrlEncoder().encodeToString(protoKey))
</a><a href="#h256-0-39" id="h256-0-39" class="d">-        .addHeader(&quot;User-Agent&quot;, Constants.USER_AGENT)
</a><a href="#h256-0-40" id="h256-0-40" class="d">-        .build()
</a><a href="#h256-0-41" id="h256-0-41" class="d">-
</a><a href="#h256-0-42" id="h256-0-42" class="d">-    /**
</a><a href="#h256-0-43" id="h256-0-43" class="d">-     * Download bolt media with memory allocation
</a><a href="#h256-0-44" id="h256-0-44" class="d">-     */
</a><a href="#h256-0-45" id="h256-0-45" class="d">-    fun downloadBoltMedia(protoKey: ByteArray, decryptionCallback: (InputStream) -&gt; InputStream = { it }): ByteArray? {
</a><a href="#h256-0-46" id="h256-0-46" class="d">-        okHttpClient.newCall(newResolveRequest(protoKey)).execute().use { response -&gt;
</a><a href="#h256-0-47" id="h256-0-47" class="d">-            if (!response.isSuccessful) {
</a><a href="#h256-0-48" id="h256-0-48" class="d">-                Logger.directDebug(&quot;Unexpected code $response&quot;)
</a><a href="#h256-0-49" id="h256-0-49" class="d">-                return null
</a><a href="#h256-0-50" id="h256-0-50" class="d">-            }
</a><a href="#h256-0-51" id="h256-0-51" class="d">-            return decryptionCallback(response.body.byteStream()).readBytes()
</a><a href="#h256-0-52" id="h256-0-52" class="d">-        }
</a><a href="#h256-0-53" id="h256-0-53" class="d">-    }
</a><a href="#h256-0-54" id="h256-0-54" class="d">-    
</a><a href="#h256-0-55" id="h256-0-55" class="d">-    fun downloadBoltMedia(protoKey: ByteArray, decryptionCallback: (InputStream) -&gt; InputStream = { it }, resultCallback: (InputStream) -&gt; Unit) {
</a><a href="#h256-0-56" id="h256-0-56" class="d">-        okHttpClient.newCall(newResolveRequest(protoKey)).execute().use { response -&gt;
</a><a href="#h256-0-57" id="h256-0-57" class="d">-            if (!response.isSuccessful) {
</a><a href="#h256-0-58" id="h256-0-58" class="d">-                throw Throwable(&quot;invalid response ${response.code}&quot;)
</a><a href="#h256-0-59" id="h256-0-59" class="d">-            }
</a><a href="#h256-0-60" id="h256-0-60" class="d">-            resultCallback(
</a><a href="#h256-0-61" id="h256-0-61" class="d">-                decryptionCallback(
</a><a href="#h256-0-62" id="h256-0-62" class="d">-                    response.body.byteStream()
</a><a href="#h256-0-63" id="h256-0-63" class="d">-                )
</a><a href="#h256-0-64" id="h256-0-64" class="d">-            )
</a><a href="#h256-0-65" id="h256-0-65" class="d">-        }
</a><a href="#h256-0-66" id="h256-0-66" class="d">-    }
</a><a href="#h256-0-67" id="h256-0-67" class="d">-}
</a><b>diff --git a/<a id="h257" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/util/export/MessageExporter.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/util/export/MessageExporter.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/util/export/MessageExporter.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/util/export/MessageExporter.kt</a></b>
<a href="#h257-0" id="h257-0" class="h">@@ -1,325 +0,0 @@
</a><a href="#h257-0-0" id="h257-0-0" class="d">-package me.rhunk.snapenhance.core.util.export
</a><a href="#h257-0-1" id="h257-0-1" class="d">-
</a><a href="#h257-0-2" id="h257-0-2" class="d">-import android.os.Environment
</a><a href="#h257-0-3" id="h257-0-3" class="d">-import android.util.Base64InputStream
</a><a href="#h257-0-4" id="h257-0-4" class="d">-import com.google.gson.JsonArray
</a><a href="#h257-0-5" id="h257-0-5" class="d">-import com.google.gson.JsonNull
</a><a href="#h257-0-6" id="h257-0-6" class="d">-import com.google.gson.JsonObject
</a><a href="#h257-0-7" id="h257-0-7" class="d">-import de.robv.android.xposed.XposedHelpers
</a><a href="#h257-0-8" id="h257-0-8" class="d">-import kotlinx.coroutines.Dispatchers
</a><a href="#h257-0-9" id="h257-0-9" class="d">-import kotlinx.coroutines.withContext
</a><a href="#h257-0-10" id="h257-0-10" class="d">-import me.rhunk.snapenhance.ModContext
</a><a href="#h257-0-11" id="h257-0-11" class="d">-import me.rhunk.snapenhance.core.BuildConfig
</a><a href="#h257-0-12" id="h257-0-12" class="d">-import me.rhunk.snapenhance.core.database.objects.FriendFeedEntry
</a><a href="#h257-0-13" id="h257-0-13" class="d">-import me.rhunk.snapenhance.core.database.objects.FriendInfo
</a><a href="#h257-0-14" id="h257-0-14" class="d">-import me.rhunk.snapenhance.core.util.download.RemoteMediaResolver
</a><a href="#h257-0-15" id="h257-0-15" class="d">-import me.rhunk.snapenhance.core.util.protobuf.ProtoReader
</a><a href="#h257-0-16" id="h257-0-16" class="d">-import me.rhunk.snapenhance.core.util.snap.MediaDownloaderHelper
</a><a href="#h257-0-17" id="h257-0-17" class="d">-import me.rhunk.snapenhance.data.ContentType
</a><a href="#h257-0-18" id="h257-0-18" class="d">-import me.rhunk.snapenhance.data.FileType
</a><a href="#h257-0-19" id="h257-0-19" class="d">-import me.rhunk.snapenhance.data.wrapper.impl.Message
</a><a href="#h257-0-20" id="h257-0-20" class="d">-import me.rhunk.snapenhance.data.wrapper.impl.SnapUUID
</a><a href="#h257-0-21" id="h257-0-21" class="d">-import me.rhunk.snapenhance.features.impl.downloader.decoder.AttachmentType
</a><a href="#h257-0-22" id="h257-0-22" class="d">-import me.rhunk.snapenhance.features.impl.downloader.decoder.MessageDecoder
</a><a href="#h257-0-23" id="h257-0-23" class="d">-import java.io.BufferedInputStream
</a><a href="#h257-0-24" id="h257-0-24" class="d">-import java.io.File
</a><a href="#h257-0-25" id="h257-0-25" class="d">-import java.io.FileOutputStream
</a><a href="#h257-0-26" id="h257-0-26" class="d">-import java.io.InputStream
</a><a href="#h257-0-27" id="h257-0-27" class="d">-import java.io.OutputStream
</a><a href="#h257-0-28" id="h257-0-28" class="d">-import java.text.SimpleDateFormat
</a><a href="#h257-0-29" id="h257-0-29" class="d">-import java.util.Collections
</a><a href="#h257-0-30" id="h257-0-30" class="d">-import java.util.Date
</a><a href="#h257-0-31" id="h257-0-31" class="d">-import java.util.Locale
</a><a href="#h257-0-32" id="h257-0-32" class="d">-import java.util.concurrent.Executors
</a><a href="#h257-0-33" id="h257-0-33" class="d">-import java.util.concurrent.TimeUnit
</a><a href="#h257-0-34" id="h257-0-34" class="d">-import java.util.zip.Deflater
</a><a href="#h257-0-35" id="h257-0-35" class="d">-import java.util.zip.DeflaterInputStream
</a><a href="#h257-0-36" id="h257-0-36" class="d">-import java.util.zip.ZipFile
</a><a href="#h257-0-37" id="h257-0-37" class="d">-import kotlin.io.encoding.Base64
</a><a href="#h257-0-38" id="h257-0-38" class="d">-import kotlin.io.encoding.ExperimentalEncodingApi
</a><a href="#h257-0-39" id="h257-0-39" class="d">-
</a><a href="#h257-0-40" id="h257-0-40" class="d">-
</a><a href="#h257-0-41" id="h257-0-41" class="d">-enum class ExportFormat(
</a><a href="#h257-0-42" id="h257-0-42" class="d">-    val extension: String,
</a><a href="#h257-0-43" id="h257-0-43" class="d">-){
</a><a href="#h257-0-44" id="h257-0-44" class="d">-    JSON(&quot;json&quot;),
</a><a href="#h257-0-45" id="h257-0-45" class="d">-    TEXT(&quot;txt&quot;),
</a><a href="#h257-0-46" id="h257-0-46" class="d">-    HTML(&quot;html&quot;);
</a><a href="#h257-0-47" id="h257-0-47" class="d">-}
</a><a href="#h257-0-48" id="h257-0-48" class="d">-
</a><a href="#h257-0-49" id="h257-0-49" class="d">-@OptIn(ExperimentalEncodingApi::class)
</a><a href="#h257-0-50" id="h257-0-50" class="d">-class MessageExporter(
</a><a href="#h257-0-51" id="h257-0-51" class="d">-    private val context: ModContext,
</a><a href="#h257-0-52" id="h257-0-52" class="d">-    private val outputFile: File,
</a><a href="#h257-0-53" id="h257-0-53" class="d">-    private val friendFeedEntry: FriendFeedEntry,
</a><a href="#h257-0-54" id="h257-0-54" class="d">-    private val mediaToDownload: List&lt;ContentType&gt;? = null,
</a><a href="#h257-0-55" id="h257-0-55" class="d">-    private val printLog: (String) -&gt; Unit = {},
</a><a href="#h257-0-56" id="h257-0-56" class="d">-) {
</a><a href="#h257-0-57" id="h257-0-57" class="d">-    private lateinit var conversationParticipants: Map&lt;String, FriendInfo&gt;
</a><a href="#h257-0-58" id="h257-0-58" class="d">-    private lateinit var messages: List&lt;Message&gt;
</a><a href="#h257-0-59" id="h257-0-59" class="d">-
</a><a href="#h257-0-60" id="h257-0-60" class="d">-    fun readMessages(messages: List&lt;Message&gt;) {
</a><a href="#h257-0-61" id="h257-0-61" class="d">-        conversationParticipants =
</a><a href="#h257-0-62" id="h257-0-62" class="d">-            context.database.getConversationParticipants(friendFeedEntry.key!!)
</a><a href="#h257-0-63" id="h257-0-63" class="d">-                ?.mapNotNull {
</a><a href="#h257-0-64" id="h257-0-64" class="d">-                    context.database.getFriendInfo(it)
</a><a href="#h257-0-65" id="h257-0-65" class="d">-                }?.associateBy { it.userId!! } ?: emptyMap()
</a><a href="#h257-0-66" id="h257-0-66" class="d">-
</a><a href="#h257-0-67" id="h257-0-67" class="d">-        if (conversationParticipants.isEmpty())
</a><a href="#h257-0-68" id="h257-0-68" class="d">-            throw Throwable(&quot;Failed to get conversation participants for ${friendFeedEntry.key}&quot;)
</a><a href="#h257-0-69" id="h257-0-69" class="d">-
</a><a href="#h257-0-70" id="h257-0-70" class="d">-        this.messages = messages.sortedBy { it.orderKey }
</a><a href="#h257-0-71" id="h257-0-71" class="d">-    }
</a><a href="#h257-0-72" id="h257-0-72" class="d">-
</a><a href="#h257-0-73" id="h257-0-73" class="d">-    private fun serializeMessageContent(message: Message): String? {
</a><a href="#h257-0-74" id="h257-0-74" class="d">-        return if (message.messageContent.contentType == ContentType.CHAT) {
</a><a href="#h257-0-75" id="h257-0-75" class="d">-            ProtoReader(message.messageContent.content).getString(2, 1) ?: &quot;Failed to parse message&quot;
</a><a href="#h257-0-76" id="h257-0-76" class="d">-        } else null
</a><a href="#h257-0-77" id="h257-0-77" class="d">-    }
</a><a href="#h257-0-78" id="h257-0-78" class="d">-
</a><a href="#h257-0-79" id="h257-0-79" class="d">-    private fun exportText(output: OutputStream) {
</a><a href="#h257-0-80" id="h257-0-80" class="d">-        val writer = output.bufferedWriter()
</a><a href="#h257-0-81" id="h257-0-81" class="d">-        writer.write(&quot;Conversation key: ${friendFeedEntry.key}\n&quot;)
</a><a href="#h257-0-82" id="h257-0-82" class="d">-        writer.write(&quot;Conversation Name: ${friendFeedEntry.feedDisplayName}\n&quot;)
</a><a href="#h257-0-83" id="h257-0-83" class="d">-        writer.write(&quot;Participants:\n&quot;)
</a><a href="#h257-0-84" id="h257-0-84" class="d">-        conversationParticipants.forEach { (userId, friendInfo) -&gt;
</a><a href="#h257-0-85" id="h257-0-85" class="d">-            writer.write(&quot;  $userId: ${friendInfo.displayName}\n&quot;)
</a><a href="#h257-0-86" id="h257-0-86" class="d">-        }
</a><a href="#h257-0-87" id="h257-0-87" class="d">-
</a><a href="#h257-0-88" id="h257-0-88" class="d">-        writer.write(&quot;\nMessages:\n&quot;)
</a><a href="#h257-0-89" id="h257-0-89" class="d">-        messages.forEach { message -&gt;
</a><a href="#h257-0-90" id="h257-0-90" class="d">-            val sender = conversationParticipants[message.senderId.toString()]
</a><a href="#h257-0-91" id="h257-0-91" class="d">-            val senderUsername = sender?.usernameForSorting ?: message.senderId.toString()
</a><a href="#h257-0-92" id="h257-0-92" class="d">-            val senderDisplayName = sender?.displayName ?: message.senderId.toString()
</a><a href="#h257-0-93" id="h257-0-93" class="d">-            val messageContent = serializeMessageContent(message) ?: message.messageContent.contentType?.name
</a><a href="#h257-0-94" id="h257-0-94" class="d">-            val date = SimpleDateFormat(&quot;yyyy-MM-dd HH:mm:ss&quot;, Locale.ENGLISH).format(Date(message.messageMetadata.createdAt))
</a><a href="#h257-0-95" id="h257-0-95" class="d">-            writer.write(&quot;[$date] - $senderDisplayName (${senderUsername}): $messageContent\n&quot;)
</a><a href="#h257-0-96" id="h257-0-96" class="d">-        }
</a><a href="#h257-0-97" id="h257-0-97" class="d">-        writer.flush()
</a><a href="#h257-0-98" id="h257-0-98" class="d">-    }
</a><a href="#h257-0-99" id="h257-0-99" class="d">-
</a><a href="#h257-0-100" id="h257-0-100" class="d">-    suspend fun exportHtml(output: OutputStream) {
</a><a href="#h257-0-101" id="h257-0-101" class="d">-        val downloadMediaCacheFolder = File(Environment.getExternalStoragePublicDirectory(Environment.DIRECTORY_DOWNLOADS), &quot;SnapEnhance/cache&quot;).also { it.mkdirs() }
</a><a href="#h257-0-102" id="h257-0-102" class="d">-        val mediaFiles = Collections.synchronizedMap(mutableMapOf&lt;String, Pair&lt;FileType, File&gt;&gt;())
</a><a href="#h257-0-103" id="h257-0-103" class="d">-        val threadPool = Executors.newFixedThreadPool(15)
</a><a href="#h257-0-104" id="h257-0-104" class="d">-
</a><a href="#h257-0-105" id="h257-0-105" class="d">-        withContext(Dispatchers.IO) {
</a><a href="#h257-0-106" id="h257-0-106" class="d">-            var processCount = 0
</a><a href="#h257-0-107" id="h257-0-107" class="d">-
</a><a href="#h257-0-108" id="h257-0-108" class="d">-            fun updateProgress(type: String) {
</a><a href="#h257-0-109" id="h257-0-109" class="d">-                val total = messages.filter {
</a><a href="#h257-0-110" id="h257-0-110" class="d">-                    mediaToDownload?.contains(it.messageContent.contentType) ?: false
</a><a href="#h257-0-111" id="h257-0-111" class="d">-                }.size
</a><a href="#h257-0-112" id="h257-0-112" class="d">-                processCount++
</a><a href="#h257-0-113" id="h257-0-113" class="d">-                printLog(&quot;$type $processCount/$total&quot;)
</a><a href="#h257-0-114" id="h257-0-114" class="d">-            }
</a><a href="#h257-0-115" id="h257-0-115" class="d">-
</a><a href="#h257-0-116" id="h257-0-116" class="d">-            messages.filter {
</a><a href="#h257-0-117" id="h257-0-117" class="d">-                mediaToDownload?.contains(it.messageContent.contentType) ?: false
</a><a href="#h257-0-118" id="h257-0-118" class="d">-            }.forEach { message -&gt;
</a><a href="#h257-0-119" id="h257-0-119" class="d">-                threadPool.execute {
</a><a href="#h257-0-120" id="h257-0-120" class="d">-                    MessageDecoder.decode(message.messageContent).forEach decode@{ attachment -&gt;
</a><a href="#h257-0-121" id="h257-0-121" class="d">-                        val protoMediaReference = Base64.UrlSafe.decode(attachment.mediaUrlKey ?: return@decode)
</a><a href="#h257-0-122" id="h257-0-122" class="d">-
</a><a href="#h257-0-123" id="h257-0-123" class="d">-                        runCatching {
</a><a href="#h257-0-124" id="h257-0-124" class="d">-                            RemoteMediaResolver.downloadBoltMedia(protoMediaReference, decryptionCallback = {
</a><a href="#h257-0-125" id="h257-0-125" class="d">-                                (attachment.attachmentInfo?.encryption?.decryptInputStream(it) ?: it)
</a><a href="#h257-0-126" id="h257-0-126" class="d">-                            }) {
</a><a href="#h257-0-127" id="h257-0-127" class="d">-                                it.use { inputStream -&gt;
</a><a href="#h257-0-128" id="h257-0-128" class="d">-                                    MediaDownloaderHelper.getSplitElements(inputStream) { type, splitInputStream -&gt;
</a><a href="#h257-0-129" id="h257-0-129" class="d">-                                        val fileName = &quot;${type}_${Base64.UrlSafe.encode(protoMediaReference).replace(&quot;=&quot;, &quot;&quot;)}&quot;
</a><a href="#h257-0-130" id="h257-0-130" class="d">-                                        val bufferedInputStream = BufferedInputStream(splitInputStream)
</a><a href="#h257-0-131" id="h257-0-131" class="d">-                                        val fileType = MediaDownloaderHelper.getFileType(bufferedInputStream)
</a><a href="#h257-0-132" id="h257-0-132" class="d">-                                        val mediaFile = File(downloadMediaCacheFolder, &quot;$fileName.${fileType.fileExtension}&quot;)
</a><a href="#h257-0-133" id="h257-0-133" class="d">-
</a><a href="#h257-0-134" id="h257-0-134" class="d">-                                        FileOutputStream(mediaFile).use { fos -&gt;
</a><a href="#h257-0-135" id="h257-0-135" class="d">-                                            bufferedInputStream.copyTo(fos)
</a><a href="#h257-0-136" id="h257-0-136" class="d">-                                        }
</a><a href="#h257-0-137" id="h257-0-137" class="d">-
</a><a href="#h257-0-138" id="h257-0-138" class="d">-                                        mediaFiles[fileName] = fileType to mediaFile
</a><a href="#h257-0-139" id="h257-0-139" class="d">-                                    }
</a><a href="#h257-0-140" id="h257-0-140" class="d">-                                }
</a><a href="#h257-0-141" id="h257-0-141" class="d">-                            }
</a><a href="#h257-0-142" id="h257-0-142" class="d">-
</a><a href="#h257-0-143" id="h257-0-143" class="d">-                            updateProgress(&quot;downloaded&quot;)
</a><a href="#h257-0-144" id="h257-0-144" class="d">-                        }.onFailure {
</a><a href="#h257-0-145" id="h257-0-145" class="d">-                            printLog(&quot;failed to download media for ${message.messageDescriptor.conversationId}_${message.orderKey}&quot;)
</a><a href="#h257-0-146" id="h257-0-146" class="d">-                            context.log.error(&quot;failed to download media for ${message.messageDescriptor.conversationId}_${message.orderKey}&quot;, it)
</a><a href="#h257-0-147" id="h257-0-147" class="d">-                        }
</a><a href="#h257-0-148" id="h257-0-148" class="d">-                    }
</a><a href="#h257-0-149" id="h257-0-149" class="d">-                }
</a><a href="#h257-0-150" id="h257-0-150" class="d">-            }
</a><a href="#h257-0-151" id="h257-0-151" class="d">-
</a><a href="#h257-0-152" id="h257-0-152" class="d">-            threadPool.shutdown()
</a><a href="#h257-0-153" id="h257-0-153" class="d">-            threadPool.awaitTermination(30, TimeUnit.DAYS)
</a><a href="#h257-0-154" id="h257-0-154" class="d">-            processCount = 0
</a><a href="#h257-0-155" id="h257-0-155" class="d">-
</a><a href="#h257-0-156" id="h257-0-156" class="d">-            printLog(&quot;writing downloaded medias...&quot;)
</a><a href="#h257-0-157" id="h257-0-157" class="d">-
</a><a href="#h257-0-158" id="h257-0-158" class="d">-            //write the head of the html file
</a><a href="#h257-0-159" id="h257-0-159" class="d">-            output.write(&quot;&quot;&quot;
</a><a href="#h257-0-160" id="h257-0-160" class="d">-                &lt;!DOCTYPE html&gt;
</a><a href="#h257-0-161" id="h257-0-161" class="d">-                &lt;html&gt;
</a><a href="#h257-0-162" id="h257-0-162" class="d">-                &lt;head&gt;
</a><a href="#h257-0-163" id="h257-0-163" class="d">-                    &lt;meta charset=&quot;UTF-8&quot;&gt;
</a><a href="#h257-0-164" id="h257-0-164" class="d">-                    &lt;meta http-equiv=&quot;X-UA-Compatible&quot; content=&quot;IE=edge&quot;&gt;
</a><a href="#h257-0-165" id="h257-0-165" class="d">-                    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot;&gt;
</a><a href="#h257-0-166" id="h257-0-166" class="d">-                    &lt;title&gt;&lt;/title&gt;
</a><a href="#h257-0-167" id="h257-0-167" class="d">-                &lt;/head&gt;
</a><a href="#h257-0-168" id="h257-0-168" class="d">-            &quot;&quot;&quot;.trimIndent().toByteArray())
</a><a href="#h257-0-169" id="h257-0-169" class="d">-
</a><a href="#h257-0-170" id="h257-0-170" class="d">-            output.write(&quot;&lt;!-- This file was generated by SnapEnhance ${BuildConfig.VERSION_NAME} --&gt;\n&quot;.toByteArray())
</a><a href="#h257-0-171" id="h257-0-171" class="d">-
</a><a href="#h257-0-172" id="h257-0-172" class="d">-            mediaFiles.forEach { (key, filePair) -&gt;
</a><a href="#h257-0-173" id="h257-0-173" class="d">-                output.write(&quot;&lt;div class=\&quot;media-$key\&quot;&gt;&lt;!-- &quot;.toByteArray())
</a><a href="#h257-0-174" id="h257-0-174" class="d">-
</a><a href="#h257-0-175" id="h257-0-175" class="d">-                val deflateInputStream = DeflaterInputStream(filePair.second.inputStream(), Deflater(Deflater.BEST_COMPRESSION, true))
</a><a href="#h257-0-176" id="h257-0-176" class="d">-                val base64InputStream = XposedHelpers.newInstance(
</a><a href="#h257-0-177" id="h257-0-177" class="d">-                    Base64InputStream::class.java,
</a><a href="#h257-0-178" id="h257-0-178" class="d">-                    deflateInputStream,
</a><a href="#h257-0-179" id="h257-0-179" class="d">-                    android.util.Base64.DEFAULT or android.util.Base64.NO_WRAP,
</a><a href="#h257-0-180" id="h257-0-180" class="d">-                    true
</a><a href="#h257-0-181" id="h257-0-181" class="d">-                ) as InputStream
</a><a href="#h257-0-182" id="h257-0-182" class="d">-                base64InputStream.copyTo(output)
</a><a href="#h257-0-183" id="h257-0-183" class="d">-                deflateInputStream.close()
</a><a href="#h257-0-184" id="h257-0-184" class="d">-
</a><a href="#h257-0-185" id="h257-0-185" class="d">-                output.write(&quot; --&gt;&lt;/div&gt;\n&quot;.toByteArray())
</a><a href="#h257-0-186" id="h257-0-186" class="d">-                output.flush()
</a><a href="#h257-0-187" id="h257-0-187" class="d">-                updateProgress(&quot;wrote&quot;)
</a><a href="#h257-0-188" id="h257-0-188" class="d">-            }
</a><a href="#h257-0-189" id="h257-0-189" class="d">-            printLog(&quot;writing json conversation data...&quot;)
</a><a href="#h257-0-190" id="h257-0-190" class="d">-
</a><a href="#h257-0-191" id="h257-0-191" class="d">-            //write the json file
</a><a href="#h257-0-192" id="h257-0-192" class="d">-            output.write(&quot;&lt;script type=\&quot;application/json\&quot; class=\&quot;exported_content\&quot;&gt;&quot;.toByteArray())
</a><a href="#h257-0-193" id="h257-0-193" class="d">-            exportJson(output)
</a><a href="#h257-0-194" id="h257-0-194" class="d">-            output.write(&quot;&lt;/script&gt;\n&quot;.toByteArray())
</a><a href="#h257-0-195" id="h257-0-195" class="d">-
</a><a href="#h257-0-196" id="h257-0-196" class="d">-            printLog(&quot;writing template...&quot;)
</a><a href="#h257-0-197" id="h257-0-197" class="d">-
</a><a href="#h257-0-198" id="h257-0-198" class="d">-            runCatching {
</a><a href="#h257-0-199" id="h257-0-199" class="d">-                ZipFile(context.bridgeClient.getApplicationApkPath()).use { apkFile -&gt;
</a><a href="#h257-0-200" id="h257-0-200" class="d">-                    //export rawinflate.js
</a><a href="#h257-0-201" id="h257-0-201" class="d">-                    apkFile.getEntry(&quot;assets/web/rawinflate.js&quot;).let { entry -&gt;
</a><a href="#h257-0-202" id="h257-0-202" class="d">-                        output.write(&quot;&lt;script&gt;&quot;.toByteArray())
</a><a href="#h257-0-203" id="h257-0-203" class="d">-                        apkFile.getInputStream(entry).copyTo(output)
</a><a href="#h257-0-204" id="h257-0-204" class="d">-                        output.write(&quot;&lt;/script&gt;\n&quot;.toByteArray())
</a><a href="#h257-0-205" id="h257-0-205" class="d">-                    }
</a><a href="#h257-0-206" id="h257-0-206" class="d">-
</a><a href="#h257-0-207" id="h257-0-207" class="d">-                    //export avenir next font
</a><a href="#h257-0-208" id="h257-0-208" class="d">-                    apkFile.getEntry(&quot;res/font/avenir_next_medium.ttf&quot;).let { entry -&gt;
</a><a href="#h257-0-209" id="h257-0-209" class="d">-                        val encodedFontData = Base64.Default.encode(apkFile.getInputStream(entry).readBytes())
</a><a href="#h257-0-210" id="h257-0-210" class="d">-                        output.write(&quot;&quot;&quot;
</a><a href="#h257-0-211" id="h257-0-211" class="d">-                        &lt;style&gt;
</a><a href="#h257-0-212" id="h257-0-212" class="d">-                            @font-face {
</a><a href="#h257-0-213" id="h257-0-213" class="d">-                                font-family: &#39;Avenir Next&#39;;
</a><a href="#h257-0-214" id="h257-0-214" class="d">-                                src: url(&#39;data:font/truetype;charset=utf-8;base64, $encodedFontData&#39;);
</a><a href="#h257-0-215" id="h257-0-215" class="d">-                                font-weight: normal;
</a><a href="#h257-0-216" id="h257-0-216" class="d">-                                font-style: normal;
</a><a href="#h257-0-217" id="h257-0-217" class="d">-                            }
</a><a href="#h257-0-218" id="h257-0-218" class="d">-                        &lt;/style&gt;
</a><a href="#h257-0-219" id="h257-0-219" class="d">-                    &quot;&quot;&quot;.trimIndent().toByteArray())
</a><a href="#h257-0-220" id="h257-0-220" class="d">-                    }
</a><a href="#h257-0-221" id="h257-0-221" class="d">-
</a><a href="#h257-0-222" id="h257-0-222" class="d">-                    apkFile.getEntry(&quot;assets/web/export_template.html&quot;).let { entry -&gt;
</a><a href="#h257-0-223" id="h257-0-223" class="d">-                        apkFile.getInputStream(entry).copyTo(output)
</a><a href="#h257-0-224" id="h257-0-224" class="d">-                    }
</a><a href="#h257-0-225" id="h257-0-225" class="d">-
</a><a href="#h257-0-226" id="h257-0-226" class="d">-                    apkFile.close()
</a><a href="#h257-0-227" id="h257-0-227" class="d">-                }
</a><a href="#h257-0-228" id="h257-0-228" class="d">-            }.onFailure {
</a><a href="#h257-0-229" id="h257-0-229" class="d">-                throw Throwable(&quot;Failed to read template from apk&quot;, it)
</a><a href="#h257-0-230" id="h257-0-230" class="d">-            }
</a><a href="#h257-0-231" id="h257-0-231" class="d">-
</a><a href="#h257-0-232" id="h257-0-232" class="d">-            output.write(&quot;&lt;/html&gt;&quot;.toByteArray())
</a><a href="#h257-0-233" id="h257-0-233" class="d">-            output.close()
</a><a href="#h257-0-234" id="h257-0-234" class="d">-        }
</a><a href="#h257-0-235" id="h257-0-235" class="d">-    }
</a><a href="#h257-0-236" id="h257-0-236" class="d">-
</a><a href="#h257-0-237" id="h257-0-237" class="d">-    private fun exportJson(output: OutputStream) {
</a><a href="#h257-0-238" id="h257-0-238" class="d">-        val rootObject = JsonObject().apply {
</a><a href="#h257-0-239" id="h257-0-239" class="d">-            addProperty(&quot;conversationId&quot;, friendFeedEntry.key)
</a><a href="#h257-0-240" id="h257-0-240" class="d">-            addProperty(&quot;conversationName&quot;, friendFeedEntry.feedDisplayName)
</a><a href="#h257-0-241" id="h257-0-241" class="d">-
</a><a href="#h257-0-242" id="h257-0-242" class="d">-            var index = 0
</a><a href="#h257-0-243" id="h257-0-243" class="d">-            val participants = mutableMapOf&lt;String, Int&gt;()
</a><a href="#h257-0-244" id="h257-0-244" class="d">-
</a><a href="#h257-0-245" id="h257-0-245" class="d">-            add(&quot;participants&quot;, JsonObject().apply {
</a><a href="#h257-0-246" id="h257-0-246" class="d">-                conversationParticipants.forEach { (userId, friendInfo) -&gt;
</a><a href="#h257-0-247" id="h257-0-247" class="d">-                    add(userId, JsonObject().apply {
</a><a href="#h257-0-248" id="h257-0-248" class="d">-                        addProperty(&quot;id&quot;, index)
</a><a href="#h257-0-249" id="h257-0-249" class="d">-                        addProperty(&quot;displayName&quot;, friendInfo.displayName)
</a><a href="#h257-0-250" id="h257-0-250" class="d">-                        addProperty(&quot;username&quot;, friendInfo.usernameForSorting)
</a><a href="#h257-0-251" id="h257-0-251" class="d">-                        addProperty(&quot;bitmojiSelfieId&quot;, friendInfo.bitmojiSelfieId)
</a><a href="#h257-0-252" id="h257-0-252" class="d">-                    })
</a><a href="#h257-0-253" id="h257-0-253" class="d">-                    participants[userId] = index++
</a><a href="#h257-0-254" id="h257-0-254" class="d">-                }
</a><a href="#h257-0-255" id="h257-0-255" class="d">-            })
</a><a href="#h257-0-256" id="h257-0-256" class="d">-            add(&quot;messages&quot;, JsonArray().apply {
</a><a href="#h257-0-257" id="h257-0-257" class="d">-                messages.forEach { message -&gt;
</a><a href="#h257-0-258" id="h257-0-258" class="d">-                    add(JsonObject().apply {
</a><a href="#h257-0-259" id="h257-0-259" class="d">-                        addProperty(&quot;orderKey&quot;, message.orderKey)
</a><a href="#h257-0-260" id="h257-0-260" class="d">-                        addProperty(&quot;senderId&quot;, participants.getOrDefault(message.senderId.toString(), -1))
</a><a href="#h257-0-261" id="h257-0-261" class="d">-                        addProperty(&quot;type&quot;, message.messageContent.contentType.toString())
</a><a href="#h257-0-262" id="h257-0-262" class="d">-
</a><a href="#h257-0-263" id="h257-0-263" class="d">-                        fun addUUIDList(name: String, list: List&lt;SnapUUID&gt;) {
</a><a href="#h257-0-264" id="h257-0-264" class="d">-                            add(name, JsonArray().apply {
</a><a href="#h257-0-265" id="h257-0-265" class="d">-                                list.map { participants.getOrDefault(it.toString(), -1) }.forEach { add(it) }
</a><a href="#h257-0-266" id="h257-0-266" class="d">-                            })
</a><a href="#h257-0-267" id="h257-0-267" class="d">-                        }
</a><a href="#h257-0-268" id="h257-0-268" class="d">-
</a><a href="#h257-0-269" id="h257-0-269" class="d">-                        addUUIDList(&quot;savedBy&quot;, message.messageMetadata.savedBy)
</a><a href="#h257-0-270" id="h257-0-270" class="d">-                        addUUIDList(&quot;seenBy&quot;, message.messageMetadata.seenBy)
</a><a href="#h257-0-271" id="h257-0-271" class="d">-                        addUUIDList(&quot;openedBy&quot;, message.messageMetadata.openedBy)
</a><a href="#h257-0-272" id="h257-0-272" class="d">-
</a><a href="#h257-0-273" id="h257-0-273" class="d">-                        add(&quot;reactions&quot;, JsonObject().apply {
</a><a href="#h257-0-274" id="h257-0-274" class="d">-                            message.messageMetadata.reactions.forEach { reaction -&gt;
</a><a href="#h257-0-275" id="h257-0-275" class="d">-                                addProperty(
</a><a href="#h257-0-276" id="h257-0-276" class="d">-                                    participants.getOrDefault(reaction.userId.toString(), -1L).toString(),
</a><a href="#h257-0-277" id="h257-0-277" class="d">-                                    reaction.reactionId
</a><a href="#h257-0-278" id="h257-0-278" class="d">-                                )
</a><a href="#h257-0-279" id="h257-0-279" class="d">-                            }
</a><a href="#h257-0-280" id="h257-0-280" class="d">-                        })
</a><a href="#h257-0-281" id="h257-0-281" class="d">-
</a><a href="#h257-0-282" id="h257-0-282" class="d">-                        addProperty(&quot;createdTimestamp&quot;, message.messageMetadata.createdAt)
</a><a href="#h257-0-283" id="h257-0-283" class="d">-                        addProperty(&quot;readTimestamp&quot;, message.messageMetadata.readAt)
</a><a href="#h257-0-284" id="h257-0-284" class="d">-                        addProperty(&quot;serializedContent&quot;, serializeMessageContent(message))
</a><a href="#h257-0-285" id="h257-0-285" class="d">-                        addProperty(&quot;rawContent&quot;, Base64.UrlSafe.encode(message.messageContent.content))
</a><a href="#h257-0-286" id="h257-0-286" class="d">-
</a><a href="#h257-0-287" id="h257-0-287" class="d">-                        add(&quot;attachments&quot;, JsonArray().apply {
</a><a href="#h257-0-288" id="h257-0-288" class="d">-                            MessageDecoder.decode(message.messageContent)
</a><a href="#h257-0-289" id="h257-0-289" class="d">-                                .forEach attachments@{ attachments -&gt;
</a><a href="#h257-0-290" id="h257-0-290" class="d">-                                if (attachments.type == AttachmentType.STICKER) //TODO: implement stickers
</a><a href="#h257-0-291" id="h257-0-291" class="d">-                                    return@attachments
</a><a href="#h257-0-292" id="h257-0-292" class="d">-                                add(JsonObject().apply {
</a><a href="#h257-0-293" id="h257-0-293" class="d">-                                    addProperty(&quot;key&quot;, attachments.mediaUrlKey?.replace(&quot;=&quot;, &quot;&quot;))
</a><a href="#h257-0-294" id="h257-0-294" class="d">-                                    addProperty(&quot;type&quot;, attachments.type.toString())
</a><a href="#h257-0-295" id="h257-0-295" class="d">-                                    add(&quot;encryption&quot;, attachments.attachmentInfo?.encryption?.let { encryption -&gt;
</a><a href="#h257-0-296" id="h257-0-296" class="d">-                                        JsonObject().apply {
</a><a href="#h257-0-297" id="h257-0-297" class="d">-                                            addProperty(&quot;key&quot;, encryption.key)
</a><a href="#h257-0-298" id="h257-0-298" class="d">-                                            addProperty(&quot;iv&quot;, encryption.iv)
</a><a href="#h257-0-299" id="h257-0-299" class="d">-                                        }
</a><a href="#h257-0-300" id="h257-0-300" class="d">-                                    } ?: JsonNull.INSTANCE)
</a><a href="#h257-0-301" id="h257-0-301" class="d">-                                })
</a><a href="#h257-0-302" id="h257-0-302" class="d">-                            }
</a><a href="#h257-0-303" id="h257-0-303" class="d">-                        })
</a><a href="#h257-0-304" id="h257-0-304" class="d">-                    })
</a><a href="#h257-0-305" id="h257-0-305" class="d">-                }
</a><a href="#h257-0-306" id="h257-0-306" class="d">-            })
</a><a href="#h257-0-307" id="h257-0-307" class="d">-        }
</a><a href="#h257-0-308" id="h257-0-308" class="d">-
</a><a href="#h257-0-309" id="h257-0-309" class="d">-        output.write(context.gson.toJson(rootObject).toByteArray())
</a><a href="#h257-0-310" id="h257-0-310" class="d">-        output.flush()
</a><a href="#h257-0-311" id="h257-0-311" class="d">-    }
</a><a href="#h257-0-312" id="h257-0-312" class="d">-
</a><a href="#h257-0-313" id="h257-0-313" class="d">-    suspend fun exportTo(exportFormat: ExportFormat) {
</a><a href="#h257-0-314" id="h257-0-314" class="d">-        val output = FileOutputStream(outputFile)
</a><a href="#h257-0-315" id="h257-0-315" class="d">-
</a><a href="#h257-0-316" id="h257-0-316" class="d">-        when (exportFormat) {
</a><a href="#h257-0-317" id="h257-0-317" class="d">-            ExportFormat.HTML -&gt; exportHtml(output)
</a><a href="#h257-0-318" id="h257-0-318" class="d">-            ExportFormat.JSON -&gt; exportJson(output)
</a><a href="#h257-0-319" id="h257-0-319" class="d">-            ExportFormat.TEXT -&gt; exportText(output)
</a><a href="#h257-0-320" id="h257-0-320" class="d">-        }
</a><a href="#h257-0-321" id="h257-0-321" class="d">-
</a><a href="#h257-0-322" id="h257-0-322" class="d">-        output.close()
</a><a href="#h257-0-323" id="h257-0-323" class="d">-    }
</a><a href="#h257-0-324" id="h257-0-324" class="d">-}</a><a href="#h257-0-325" id="h257-0-325" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h258" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/util/hook/HookAdapter.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/util/hook/HookAdapter.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/util/hook/HookAdapter.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/util/hook/HookAdapter.kt</a></b>
<a href="#h258-0" id="h258-0" class="h">@@ -0,0 +1,76 @@
</a><a href="#h258-0-0" id="h258-0-0" class="i">+package me.rhunk.snapenhance.core.util.hook
</a><a href="#h258-0-1" id="h258-0-1" class="i">+
</a><a href="#h258-0-2" id="h258-0-2" class="i">+import de.robv.android.xposed.XC_MethodHook
</a><a href="#h258-0-3" id="h258-0-3" class="i">+import de.robv.android.xposed.XposedBridge
</a><a href="#h258-0-4" id="h258-0-4" class="i">+import java.lang.reflect.Member
</a><a href="#h258-0-5" id="h258-0-5" class="i">+import java.util.function.Consumer
</a><a href="#h258-0-6" id="h258-0-6" class="i">+
</a><a href="#h258-0-7" id="h258-0-7" class="i">+@Suppress(&quot;UNCHECKED_CAST&quot;)
</a><a href="#h258-0-8" id="h258-0-8" class="i">+class HookAdapter(
</a><a href="#h258-0-9" id="h258-0-9" class="i">+    private val methodHookParam: XC_MethodHook.MethodHookParam&lt;*&gt;
</a><a href="#h258-0-10" id="h258-0-10" class="i">+) {
</a><a href="#h258-0-11" id="h258-0-11" class="i">+    fun &lt;T : Any&gt; thisObject(): T {
</a><a href="#h258-0-12" id="h258-0-12" class="i">+        return methodHookParam.thisObject as T
</a><a href="#h258-0-13" id="h258-0-13" class="i">+    }
</a><a href="#h258-0-14" id="h258-0-14" class="i">+
</a><a href="#h258-0-15" id="h258-0-15" class="i">+    fun &lt;T : Any&gt; nullableThisObject(): T? {
</a><a href="#h258-0-16" id="h258-0-16" class="i">+        return methodHookParam.thisObject as T?
</a><a href="#h258-0-17" id="h258-0-17" class="i">+    }
</a><a href="#h258-0-18" id="h258-0-18" class="i">+
</a><a href="#h258-0-19" id="h258-0-19" class="i">+    fun method(): Member {
</a><a href="#h258-0-20" id="h258-0-20" class="i">+        return methodHookParam.method
</a><a href="#h258-0-21" id="h258-0-21" class="i">+    }
</a><a href="#h258-0-22" id="h258-0-22" class="i">+
</a><a href="#h258-0-23" id="h258-0-23" class="i">+    fun &lt;T : Any&gt; arg(index: Int): T {
</a><a href="#h258-0-24" id="h258-0-24" class="i">+        return methodHookParam.args[index] as T
</a><a href="#h258-0-25" id="h258-0-25" class="i">+    }
</a><a href="#h258-0-26" id="h258-0-26" class="i">+
</a><a href="#h258-0-27" id="h258-0-27" class="i">+    fun &lt;T : Any&gt; argNullable(index: Int): T? {
</a><a href="#h258-0-28" id="h258-0-28" class="i">+        return methodHookParam.args.getOrNull(index) as T?
</a><a href="#h258-0-29" id="h258-0-29" class="i">+    }
</a><a href="#h258-0-30" id="h258-0-30" class="i">+
</a><a href="#h258-0-31" id="h258-0-31" class="i">+    fun setArg(index: Int, value: Any?) {
</a><a href="#h258-0-32" id="h258-0-32" class="i">+        if (index &lt; 0 || index &gt;= methodHookParam.args.size) return
</a><a href="#h258-0-33" id="h258-0-33" class="i">+        methodHookParam.args[index] = value
</a><a href="#h258-0-34" id="h258-0-34" class="i">+    }
</a><a href="#h258-0-35" id="h258-0-35" class="i">+
</a><a href="#h258-0-36" id="h258-0-36" class="i">+    fun args(): Array&lt;Any?&gt; {
</a><a href="#h258-0-37" id="h258-0-37" class="i">+        return methodHookParam.args
</a><a href="#h258-0-38" id="h258-0-38" class="i">+    }
</a><a href="#h258-0-39" id="h258-0-39" class="i">+
</a><a href="#h258-0-40" id="h258-0-40" class="i">+    fun getResult(): Any? {
</a><a href="#h258-0-41" id="h258-0-41" class="i">+        return methodHookParam.result
</a><a href="#h258-0-42" id="h258-0-42" class="i">+    }
</a><a href="#h258-0-43" id="h258-0-43" class="i">+
</a><a href="#h258-0-44" id="h258-0-44" class="i">+    fun setResult(result: Any?) {
</a><a href="#h258-0-45" id="h258-0-45" class="i">+        methodHookParam.result = result
</a><a href="#h258-0-46" id="h258-0-46" class="i">+    }
</a><a href="#h258-0-47" id="h258-0-47" class="i">+
</a><a href="#h258-0-48" id="h258-0-48" class="i">+    fun setThrowable(throwable: Throwable) {
</a><a href="#h258-0-49" id="h258-0-49" class="i">+        methodHookParam.throwable = throwable
</a><a href="#h258-0-50" id="h258-0-50" class="i">+    }
</a><a href="#h258-0-51" id="h258-0-51" class="i">+
</a><a href="#h258-0-52" id="h258-0-52" class="i">+    fun throwable(): Throwable? {
</a><a href="#h258-0-53" id="h258-0-53" class="i">+        return methodHookParam.throwable
</a><a href="#h258-0-54" id="h258-0-54" class="i">+    }
</a><a href="#h258-0-55" id="h258-0-55" class="i">+
</a><a href="#h258-0-56" id="h258-0-56" class="i">+    fun invokeOriginal(): Any? {
</a><a href="#h258-0-57" id="h258-0-57" class="i">+        return XposedBridge.invokeOriginalMethod(method(), thisObject(), args())
</a><a href="#h258-0-58" id="h258-0-58" class="i">+    }
</a><a href="#h258-0-59" id="h258-0-59" class="i">+
</a><a href="#h258-0-60" id="h258-0-60" class="i">+    fun invokeOriginal(args: Array&lt;Any&gt;): Any? {
</a><a href="#h258-0-61" id="h258-0-61" class="i">+        return XposedBridge.invokeOriginalMethod(method(), thisObject(), args)
</a><a href="#h258-0-62" id="h258-0-62" class="i">+    }
</a><a href="#h258-0-63" id="h258-0-63" class="i">+
</a><a href="#h258-0-64" id="h258-0-64" class="i">+    fun invokeOriginalSafe(errorCallback: Consumer&lt;Throwable&gt;) {
</a><a href="#h258-0-65" id="h258-0-65" class="i">+        invokeOriginalSafe(args(), errorCallback)
</a><a href="#h258-0-66" id="h258-0-66" class="i">+    }
</a><a href="#h258-0-67" id="h258-0-67" class="i">+
</a><a href="#h258-0-68" id="h258-0-68" class="i">+    fun invokeOriginalSafe(args: Array&lt;Any?&gt;, errorCallback: Consumer&lt;Throwable&gt;) {
</a><a href="#h258-0-69" id="h258-0-69" class="i">+        runCatching {
</a><a href="#h258-0-70" id="h258-0-70" class="i">+            setResult(XposedBridge.invokeOriginalMethod(method(), thisObject(), args))
</a><a href="#h258-0-71" id="h258-0-71" class="i">+        }.onFailure {
</a><a href="#h258-0-72" id="h258-0-72" class="i">+            errorCallback.accept(it)
</a><a href="#h258-0-73" id="h258-0-73" class="i">+        }
</a><a href="#h258-0-74" id="h258-0-74" class="i">+    }
</a><a href="#h258-0-75" id="h258-0-75" class="i">+}</a><a href="#h258-0-76" id="h258-0-76" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h259" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/util/hook/HookStage.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/util/hook/HookStage.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/util/hook/HookStage.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/util/hook/HookStage.kt</a></b>
<a href="#h259-0" id="h259-0" class="h">@@ -0,0 +1,6 @@
</a><a href="#h259-0-0" id="h259-0-0" class="i">+package me.rhunk.snapenhance.core.util.hook
</a><a href="#h259-0-1" id="h259-0-1" class="i">+
</a><a href="#h259-0-2" id="h259-0-2" class="i">+enum class HookStage {
</a><a href="#h259-0-3" id="h259-0-3" class="i">+    BEFORE,
</a><a href="#h259-0-4" id="h259-0-4" class="i">+    AFTER
</a><a href="#h259-0-5" id="h259-0-5" class="i">+}</a><a href="#h259-0-6" id="h259-0-6" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h260" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/util/hook/Hooker.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/util/hook/Hooker.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/util/hook/Hooker.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/util/hook/Hooker.kt</a></b>
<a href="#h260-0" id="h260-0" class="h">@@ -0,0 +1,157 @@
</a><a href="#h260-0-0" id="h260-0-0" class="i">+package me.rhunk.snapenhance.core.util.hook
</a><a href="#h260-0-1" id="h260-0-1" class="i">+
</a><a href="#h260-0-2" id="h260-0-2" class="i">+import de.robv.android.xposed.XC_MethodHook
</a><a href="#h260-0-3" id="h260-0-3" class="i">+import de.robv.android.xposed.XposedBridge
</a><a href="#h260-0-4" id="h260-0-4" class="i">+import java.lang.reflect.Member
</a><a href="#h260-0-5" id="h260-0-5" class="i">+import java.lang.reflect.Method
</a><a href="#h260-0-6" id="h260-0-6" class="i">+
</a><a href="#h260-0-7" id="h260-0-7" class="i">+object Hooker {
</a><a href="#h260-0-8" id="h260-0-8" class="i">+    inline fun newMethodHook(
</a><a href="#h260-0-9" id="h260-0-9" class="i">+        stage: HookStage,
</a><a href="#h260-0-10" id="h260-0-10" class="i">+        crossinline consumer: (HookAdapter) -&gt; Unit,
</a><a href="#h260-0-11" id="h260-0-11" class="i">+        crossinline filter: ((HookAdapter) -&gt; Boolean) = { true }
</a><a href="#h260-0-12" id="h260-0-12" class="i">+    ): XC_MethodHook {
</a><a href="#h260-0-13" id="h260-0-13" class="i">+        return if (stage == HookStage.BEFORE) object : XC_MethodHook() {
</a><a href="#h260-0-14" id="h260-0-14" class="i">+            override fun beforeHookedMethod(param: MethodHookParam&lt;*&gt;) {
</a><a href="#h260-0-15" id="h260-0-15" class="i">+                HookAdapter(param).takeIf(filter)?.also(consumer)
</a><a href="#h260-0-16" id="h260-0-16" class="i">+            }
</a><a href="#h260-0-17" id="h260-0-17" class="i">+        } else object : XC_MethodHook() {
</a><a href="#h260-0-18" id="h260-0-18" class="i">+            override fun afterHookedMethod(param: MethodHookParam&lt;*&gt;) {
</a><a href="#h260-0-19" id="h260-0-19" class="i">+                HookAdapter(param).takeIf(filter)?.also(consumer)
</a><a href="#h260-0-20" id="h260-0-20" class="i">+            }
</a><a href="#h260-0-21" id="h260-0-21" class="i">+        }
</a><a href="#h260-0-22" id="h260-0-22" class="i">+    }
</a><a href="#h260-0-23" id="h260-0-23" class="i">+
</a><a href="#h260-0-24" id="h260-0-24" class="i">+    inline fun hook(
</a><a href="#h260-0-25" id="h260-0-25" class="i">+        clazz: Class&lt;*&gt;,
</a><a href="#h260-0-26" id="h260-0-26" class="i">+        methodName: String,
</a><a href="#h260-0-27" id="h260-0-27" class="i">+        stage: HookStage,
</a><a href="#h260-0-28" id="h260-0-28" class="i">+        crossinline filter: (HookAdapter) -&gt; Boolean,
</a><a href="#h260-0-29" id="h260-0-29" class="i">+        noinline consumer: (HookAdapter) -&gt; Unit
</a><a href="#h260-0-30" id="h260-0-30" class="i">+    ): Set&lt;XC_MethodHook.Unhook&gt; = XposedBridge.hookAllMethods(clazz, methodName, newMethodHook(stage, consumer, filter))
</a><a href="#h260-0-31" id="h260-0-31" class="i">+
</a><a href="#h260-0-32" id="h260-0-32" class="i">+    inline fun hook(
</a><a href="#h260-0-33" id="h260-0-33" class="i">+        member: Member,
</a><a href="#h260-0-34" id="h260-0-34" class="i">+        stage: HookStage,
</a><a href="#h260-0-35" id="h260-0-35" class="i">+        crossinline filter: ((HookAdapter) -&gt; Boolean),
</a><a href="#h260-0-36" id="h260-0-36" class="i">+        crossinline consumer: (HookAdapter) -&gt; Unit
</a><a href="#h260-0-37" id="h260-0-37" class="i">+    ): XC_MethodHook.Unhook {
</a><a href="#h260-0-38" id="h260-0-38" class="i">+        return XposedBridge.hookMethod(member, newMethodHook(stage, consumer, filter))
</a><a href="#h260-0-39" id="h260-0-39" class="i">+    }
</a><a href="#h260-0-40" id="h260-0-40" class="i">+
</a><a href="#h260-0-41" id="h260-0-41" class="i">+    fun hook(
</a><a href="#h260-0-42" id="h260-0-42" class="i">+        clazz: Class&lt;*&gt;,
</a><a href="#h260-0-43" id="h260-0-43" class="i">+        methodName: String,
</a><a href="#h260-0-44" id="h260-0-44" class="i">+        stage: HookStage,
</a><a href="#h260-0-45" id="h260-0-45" class="i">+        consumer: (HookAdapter) -&gt; Unit
</a><a href="#h260-0-46" id="h260-0-46" class="i">+    ): Set&lt;XC_MethodHook.Unhook&gt; = hook(clazz, methodName, stage, { true }, consumer)
</a><a href="#h260-0-47" id="h260-0-47" class="i">+
</a><a href="#h260-0-48" id="h260-0-48" class="i">+    fun hook(
</a><a href="#h260-0-49" id="h260-0-49" class="i">+        member: Member,
</a><a href="#h260-0-50" id="h260-0-50" class="i">+        stage: HookStage,
</a><a href="#h260-0-51" id="h260-0-51" class="i">+        consumer: (HookAdapter) -&gt; Unit
</a><a href="#h260-0-52" id="h260-0-52" class="i">+    ): XC_MethodHook.Unhook {
</a><a href="#h260-0-53" id="h260-0-53" class="i">+        return hook(member, stage, { true }, consumer)
</a><a href="#h260-0-54" id="h260-0-54" class="i">+    }
</a><a href="#h260-0-55" id="h260-0-55" class="i">+
</a><a href="#h260-0-56" id="h260-0-56" class="i">+    fun hookConstructor(
</a><a href="#h260-0-57" id="h260-0-57" class="i">+        clazz: Class&lt;*&gt;,
</a><a href="#h260-0-58" id="h260-0-58" class="i">+        stage: HookStage,
</a><a href="#h260-0-59" id="h260-0-59" class="i">+        consumer: (HookAdapter) -&gt; Unit
</a><a href="#h260-0-60" id="h260-0-60" class="i">+    ): Set&lt;XC_MethodHook.Unhook&gt; = XposedBridge.hookAllConstructors(clazz, newMethodHook(stage, consumer))
</a><a href="#h260-0-61" id="h260-0-61" class="i">+
</a><a href="#h260-0-62" id="h260-0-62" class="i">+    fun hookConstructor(
</a><a href="#h260-0-63" id="h260-0-63" class="i">+        clazz: Class&lt;*&gt;,
</a><a href="#h260-0-64" id="h260-0-64" class="i">+        stage: HookStage,
</a><a href="#h260-0-65" id="h260-0-65" class="i">+        filter: ((HookAdapter) -&gt; Boolean),
</a><a href="#h260-0-66" id="h260-0-66" class="i">+        consumer: (HookAdapter) -&gt; Unit
</a><a href="#h260-0-67" id="h260-0-67" class="i">+    ) {
</a><a href="#h260-0-68" id="h260-0-68" class="i">+        XposedBridge.hookAllConstructors(clazz, newMethodHook(stage, consumer, filter))
</a><a href="#h260-0-69" id="h260-0-69" class="i">+    }
</a><a href="#h260-0-70" id="h260-0-70" class="i">+
</a><a href="#h260-0-71" id="h260-0-71" class="i">+    inline fun hookObjectMethod(
</a><a href="#h260-0-72" id="h260-0-72" class="i">+        clazz: Class&lt;*&gt;,
</a><a href="#h260-0-73" id="h260-0-73" class="i">+        instance: Any,
</a><a href="#h260-0-74" id="h260-0-74" class="i">+        methodName: String,
</a><a href="#h260-0-75" id="h260-0-75" class="i">+        stage: HookStage,
</a><a href="#h260-0-76" id="h260-0-76" class="i">+        crossinline hookConsumer: (HookAdapter) -&gt; Unit
</a><a href="#h260-0-77" id="h260-0-77" class="i">+    ) {
</a><a href="#h260-0-78" id="h260-0-78" class="i">+        val unhooks: MutableSet&lt;XC_MethodHook.Unhook&gt; = HashSet()
</a><a href="#h260-0-79" id="h260-0-79" class="i">+        hook(clazz, methodName, stage) { param-&gt;
</a><a href="#h260-0-80" id="h260-0-80" class="i">+            if (param.nullableThisObject&lt;Any&gt;().let {
</a><a href="#h260-0-81" id="h260-0-81" class="i">+                if (it == null) unhooks.forEach { u -&gt; u.unhook() }
</a><a href="#h260-0-82" id="h260-0-82" class="i">+                it != instance
</a><a href="#h260-0-83" id="h260-0-83" class="i">+            }) return@hook
</a><a href="#h260-0-84" id="h260-0-84" class="i">+            hookConsumer(param)
</a><a href="#h260-0-85" id="h260-0-85" class="i">+        }.also { unhooks.addAll(it) }
</a><a href="#h260-0-86" id="h260-0-86" class="i">+    }
</a><a href="#h260-0-87" id="h260-0-87" class="i">+
</a><a href="#h260-0-88" id="h260-0-88" class="i">+    inline fun ephemeralHook(
</a><a href="#h260-0-89" id="h260-0-89" class="i">+        clazz: Class&lt;*&gt;,
</a><a href="#h260-0-90" id="h260-0-90" class="i">+        methodName: String,
</a><a href="#h260-0-91" id="h260-0-91" class="i">+        stage: HookStage,
</a><a href="#h260-0-92" id="h260-0-92" class="i">+        crossinline hookConsumer: (HookAdapter) -&gt; Unit
</a><a href="#h260-0-93" id="h260-0-93" class="i">+    ) {
</a><a href="#h260-0-94" id="h260-0-94" class="i">+        val unhooks: MutableSet&lt;XC_MethodHook.Unhook&gt; = HashSet()
</a><a href="#h260-0-95" id="h260-0-95" class="i">+        hook(clazz, methodName, stage) { param-&gt;
</a><a href="#h260-0-96" id="h260-0-96" class="i">+            hookConsumer(param)
</a><a href="#h260-0-97" id="h260-0-97" class="i">+            unhooks.forEach{ it.unhook() }
</a><a href="#h260-0-98" id="h260-0-98" class="i">+        }.also { unhooks.addAll(it) }
</a><a href="#h260-0-99" id="h260-0-99" class="i">+    }
</a><a href="#h260-0-100" id="h260-0-100" class="i">+
</a><a href="#h260-0-101" id="h260-0-101" class="i">+    inline fun ephemeralHookObjectMethod(
</a><a href="#h260-0-102" id="h260-0-102" class="i">+        clazz: Class&lt;*&gt;,
</a><a href="#h260-0-103" id="h260-0-103" class="i">+        instance: Any,
</a><a href="#h260-0-104" id="h260-0-104" class="i">+        methodName: String,
</a><a href="#h260-0-105" id="h260-0-105" class="i">+        stage: HookStage,
</a><a href="#h260-0-106" id="h260-0-106" class="i">+        crossinline hookConsumer: (HookAdapter) -&gt; Unit
</a><a href="#h260-0-107" id="h260-0-107" class="i">+    ) {
</a><a href="#h260-0-108" id="h260-0-108" class="i">+        val unhooks: MutableSet&lt;XC_MethodHook.Unhook&gt; = HashSet()
</a><a href="#h260-0-109" id="h260-0-109" class="i">+        hook(clazz, methodName, stage) { param-&gt;
</a><a href="#h260-0-110" id="h260-0-110" class="i">+            if (param.nullableThisObject&lt;Any&gt;() != instance) return@hook
</a><a href="#h260-0-111" id="h260-0-111" class="i">+            unhooks.forEach { it.unhook() }
</a><a href="#h260-0-112" id="h260-0-112" class="i">+            hookConsumer(param)
</a><a href="#h260-0-113" id="h260-0-113" class="i">+        }.also { unhooks.addAll(it) }
</a><a href="#h260-0-114" id="h260-0-114" class="i">+    }
</a><a href="#h260-0-115" id="h260-0-115" class="i">+}
</a><a href="#h260-0-116" id="h260-0-116" class="i">+
</a><a href="#h260-0-117" id="h260-0-117" class="i">+fun Class&lt;*&gt;.hookConstructor(
</a><a href="#h260-0-118" id="h260-0-118" class="i">+    stage: HookStage,
</a><a href="#h260-0-119" id="h260-0-119" class="i">+    consumer: (HookAdapter) -&gt; Unit
</a><a href="#h260-0-120" id="h260-0-120" class="i">+) = Hooker.hookConstructor(this, stage, consumer)
</a><a href="#h260-0-121" id="h260-0-121" class="i">+
</a><a href="#h260-0-122" id="h260-0-122" class="i">+fun Class&lt;*&gt;.hookConstructor(
</a><a href="#h260-0-123" id="h260-0-123" class="i">+    stage: HookStage,
</a><a href="#h260-0-124" id="h260-0-124" class="i">+    filter: ((HookAdapter) -&gt; Boolean),
</a><a href="#h260-0-125" id="h260-0-125" class="i">+    consumer: (HookAdapter) -&gt; Unit
</a><a href="#h260-0-126" id="h260-0-126" class="i">+) = Hooker.hookConstructor(this, stage, filter, consumer)
</a><a href="#h260-0-127" id="h260-0-127" class="i">+
</a><a href="#h260-0-128" id="h260-0-128" class="i">+fun Class&lt;*&gt;.hook(
</a><a href="#h260-0-129" id="h260-0-129" class="i">+    methodName: String,
</a><a href="#h260-0-130" id="h260-0-130" class="i">+    stage: HookStage,
</a><a href="#h260-0-131" id="h260-0-131" class="i">+    consumer: (HookAdapter) -&gt; Unit
</a><a href="#h260-0-132" id="h260-0-132" class="i">+): Set&lt;XC_MethodHook.Unhook&gt; = Hooker.hook(this, methodName, stage, consumer)
</a><a href="#h260-0-133" id="h260-0-133" class="i">+
</a><a href="#h260-0-134" id="h260-0-134" class="i">+fun Class&lt;*&gt;.hook(
</a><a href="#h260-0-135" id="h260-0-135" class="i">+    methodName: String,
</a><a href="#h260-0-136" id="h260-0-136" class="i">+    stage: HookStage,
</a><a href="#h260-0-137" id="h260-0-137" class="i">+    filter: (HookAdapter) -&gt; Boolean,
</a><a href="#h260-0-138" id="h260-0-138" class="i">+    consumer: (HookAdapter) -&gt; Unit
</a><a href="#h260-0-139" id="h260-0-139" class="i">+): Set&lt;XC_MethodHook.Unhook&gt; = Hooker.hook(this, methodName, stage, filter, consumer)
</a><a href="#h260-0-140" id="h260-0-140" class="i">+
</a><a href="#h260-0-141" id="h260-0-141" class="i">+fun Member.hook(
</a><a href="#h260-0-142" id="h260-0-142" class="i">+    stage: HookStage,
</a><a href="#h260-0-143" id="h260-0-143" class="i">+    consumer: (HookAdapter) -&gt; Unit
</a><a href="#h260-0-144" id="h260-0-144" class="i">+): XC_MethodHook.Unhook = Hooker.hook(this, stage, consumer)
</a><a href="#h260-0-145" id="h260-0-145" class="i">+
</a><a href="#h260-0-146" id="h260-0-146" class="i">+fun Member.hook(
</a><a href="#h260-0-147" id="h260-0-147" class="i">+    stage: HookStage,
</a><a href="#h260-0-148" id="h260-0-148" class="i">+    filter: ((HookAdapter) -&gt; Boolean),
</a><a href="#h260-0-149" id="h260-0-149" class="i">+    consumer: (HookAdapter) -&gt; Unit
</a><a href="#h260-0-150" id="h260-0-150" class="i">+): XC_MethodHook.Unhook = Hooker.hook(this, stage, filter, consumer)
</a><a href="#h260-0-151" id="h260-0-151" class="i">+
</a><a href="#h260-0-152" id="h260-0-152" class="i">+fun Array&lt;Method&gt;.hookAll(stage: HookStage, param: (HookAdapter) -&gt; Unit) {
</a><a href="#h260-0-153" id="h260-0-153" class="i">+    filter { it.declaringClass != Object::class.java }.forEach {
</a><a href="#h260-0-154" id="h260-0-154" class="i">+        it.hook(stage, param)
</a><a href="#h260-0-155" id="h260-0-155" class="i">+    }
</a><a href="#h260-0-156" id="h260-0-156" class="i">+}
</a><b>diff --git a/<a id="h261" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/util/ktx/AndroidCompatExtensions.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/util/ktx/AndroidCompatExtensions.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/util/ktx/AndroidCompatExtensions.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/util/ktx/AndroidCompatExtensions.kt</a></b>
<a href="#h261-0" id="h261-0" class="h">@@ -1,13 +0,0 @@
</a><a href="#h261-0-0" id="h261-0-0" class="d">-package me.rhunk.snapenhance.core.util.ktx
</a><a href="#h261-0-1" id="h261-0-1" class="d">-
</a><a href="#h261-0-2" id="h261-0-2" class="d">-import android.content.pm.PackageManager
</a><a href="#h261-0-3" id="h261-0-3" class="d">-import android.content.pm.PackageManager.ApplicationInfoFlags
</a><a href="#h261-0-4" id="h261-0-4" class="d">-import android.os.Build
</a><a href="#h261-0-5" id="h261-0-5" class="d">-
</a><a href="#h261-0-6" id="h261-0-6" class="d">-fun PackageManager.getApplicationInfoCompat(packageName: String, flags: Int) =
</a><a href="#h261-0-7" id="h261-0-7" class="d">-    if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.TIRAMISU) {
</a><a href="#h261-0-8" id="h261-0-8" class="d">-        getApplicationInfo(packageName, ApplicationInfoFlags.of(flags.toLong()))
</a><a href="#h261-0-9" id="h261-0-9" class="d">-    } else {
</a><a href="#h261-0-10" id="h261-0-10" class="d">-        @Suppress(&quot;DEPRECATION&quot;)
</a><a href="#h261-0-11" id="h261-0-11" class="d">-        getApplicationInfo(packageName, flags)
</a><a href="#h261-0-12" id="h261-0-12" class="d">-    }
</a><b>diff --git a/<a id="h262" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/util/ktx/DbCursorExt.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/util/ktx/DbCursorExt.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/util/ktx/DbCursorExt.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/util/ktx/DbCursorExt.kt</a></b>
<a href="#h262-0" id="h262-0" class="h">@@ -1,37 +0,0 @@
</a><a href="#h262-0-0" id="h262-0-0" class="d">-package me.rhunk.snapenhance.core.util.ktx
</a><a href="#h262-0-1" id="h262-0-1" class="d">-
</a><a href="#h262-0-2" id="h262-0-2" class="d">-import android.database.Cursor
</a><a href="#h262-0-3" id="h262-0-3" class="d">-
</a><a href="#h262-0-4" id="h262-0-4" class="d">-fun Cursor.getStringOrNull(columnName: String): String? {
</a><a href="#h262-0-5" id="h262-0-5" class="d">-    val columnIndex = getColumnIndex(columnName)
</a><a href="#h262-0-6" id="h262-0-6" class="d">-    return if (columnIndex == -1) null else getString(columnIndex)
</a><a href="#h262-0-7" id="h262-0-7" class="d">-}
</a><a href="#h262-0-8" id="h262-0-8" class="d">-
</a><a href="#h262-0-9" id="h262-0-9" class="d">-fun Cursor.getIntOrNull(columnName: String): Int? {
</a><a href="#h262-0-10" id="h262-0-10" class="d">-    val columnIndex = getColumnIndex(columnName)
</a><a href="#h262-0-11" id="h262-0-11" class="d">-    return if (columnIndex == -1) null else getInt(columnIndex)
</a><a href="#h262-0-12" id="h262-0-12" class="d">-}
</a><a href="#h262-0-13" id="h262-0-13" class="d">-
</a><a href="#h262-0-14" id="h262-0-14" class="d">-fun Cursor.getInteger(columnName: String) = getIntOrNull(columnName) ?: throw NullPointerException(&quot;Column $columnName is null&quot;)
</a><a href="#h262-0-15" id="h262-0-15" class="d">-fun Cursor.getLong(columnName: String) = getLongOrNull(columnName) ?: throw NullPointerException(&quot;Column $columnName is null&quot;)
</a><a href="#h262-0-16" id="h262-0-16" class="d">-
</a><a href="#h262-0-17" id="h262-0-17" class="d">-fun Cursor.getBlobOrNull(columnName: String): ByteArray? {
</a><a href="#h262-0-18" id="h262-0-18" class="d">-    val columnIndex = getColumnIndex(columnName)
</a><a href="#h262-0-19" id="h262-0-19" class="d">-    return if (columnIndex == -1) null else getBlob(columnIndex)
</a><a href="#h262-0-20" id="h262-0-20" class="d">-}
</a><a href="#h262-0-21" id="h262-0-21" class="d">-
</a><a href="#h262-0-22" id="h262-0-22" class="d">-
</a><a href="#h262-0-23" id="h262-0-23" class="d">-fun Cursor.getLongOrNull(columnName: String): Long? {
</a><a href="#h262-0-24" id="h262-0-24" class="d">-    val columnIndex = getColumnIndex(columnName)
</a><a href="#h262-0-25" id="h262-0-25" class="d">-    return if (columnIndex == -1) null else getLong(columnIndex)
</a><a href="#h262-0-26" id="h262-0-26" class="d">-}
</a><a href="#h262-0-27" id="h262-0-27" class="d">-
</a><a href="#h262-0-28" id="h262-0-28" class="d">-fun Cursor.getDoubleOrNull(columnName: String): Double? {
</a><a href="#h262-0-29" id="h262-0-29" class="d">-    val columnIndex = getColumnIndex(columnName)
</a><a href="#h262-0-30" id="h262-0-30" class="d">-    return if (columnIndex == -1) null else getDouble(columnIndex)
</a><a href="#h262-0-31" id="h262-0-31" class="d">-}
</a><a href="#h262-0-32" id="h262-0-32" class="d">-
</a><a href="#h262-0-33" id="h262-0-33" class="d">-fun Cursor.getFloatOrNull(columnName: String): Float? {
</a><a href="#h262-0-34" id="h262-0-34" class="d">-    val columnIndex = getColumnIndex(columnName)
</a><a href="#h262-0-35" id="h262-0-35" class="d">-    return if (columnIndex == -1) null else getFloat(columnIndex)
</a><a href="#h262-0-36" id="h262-0-36" class="d">-}</a><a href="#h262-0-37" id="h262-0-37" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h263" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/util/media/HttpServer.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/util/media/HttpServer.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/util/media/HttpServer.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/util/media/HttpServer.kt</a></b>
<a href="#h263-0" id="h263-0" class="h">@@ -0,0 +1,139 @@
</a><a href="#h263-0-0" id="h263-0-0" class="i">+package me.rhunk.snapenhance.core.util.media
</a><a href="#h263-0-1" id="h263-0-1" class="i">+
</a><a href="#h263-0-2" id="h263-0-2" class="i">+import kotlinx.coroutines.CoroutineScope
</a><a href="#h263-0-3" id="h263-0-3" class="i">+import kotlinx.coroutines.Dispatchers
</a><a href="#h263-0-4" id="h263-0-4" class="i">+import kotlinx.coroutines.Job
</a><a href="#h263-0-5" id="h263-0-5" class="i">+import kotlinx.coroutines.delay
</a><a href="#h263-0-6" id="h263-0-6" class="i">+import kotlinx.coroutines.launch
</a><a href="#h263-0-7" id="h263-0-7" class="i">+import me.rhunk.snapenhance.common.logger.AbstractLogger
</a><a href="#h263-0-8" id="h263-0-8" class="i">+import java.io.BufferedReader
</a><a href="#h263-0-9" id="h263-0-9" class="i">+import java.io.InputStream
</a><a href="#h263-0-10" id="h263-0-10" class="i">+import java.io.InputStreamReader
</a><a href="#h263-0-11" id="h263-0-11" class="i">+import java.io.PrintWriter
</a><a href="#h263-0-12" id="h263-0-12" class="i">+import java.net.ServerSocket
</a><a href="#h263-0-13" id="h263-0-13" class="i">+import java.net.Socket
</a><a href="#h263-0-14" id="h263-0-14" class="i">+import java.net.SocketException
</a><a href="#h263-0-15" id="h263-0-15" class="i">+import java.util.Locale
</a><a href="#h263-0-16" id="h263-0-16" class="i">+import java.util.StringTokenizer
</a><a href="#h263-0-17" id="h263-0-17" class="i">+import java.util.concurrent.ConcurrentHashMap
</a><a href="#h263-0-18" id="h263-0-18" class="i">+import kotlin.random.Random
</a><a href="#h263-0-19" id="h263-0-19" class="i">+
</a><a href="#h263-0-20" id="h263-0-20" class="i">+class HttpServer(
</a><a href="#h263-0-21" id="h263-0-21" class="i">+    private val timeout: Int = 10000
</a><a href="#h263-0-22" id="h263-0-22" class="i">+) {
</a><a href="#h263-0-23" id="h263-0-23" class="i">+    val port = Random.nextInt(10000, 65535)
</a><a href="#h263-0-24" id="h263-0-24" class="i">+
</a><a href="#h263-0-25" id="h263-0-25" class="i">+    private val coroutineScope = CoroutineScope(Dispatchers.IO)
</a><a href="#h263-0-26" id="h263-0-26" class="i">+    private var timeoutJob: Job? = null
</a><a href="#h263-0-27" id="h263-0-27" class="i">+    private var socketJob: Job? = null
</a><a href="#h263-0-28" id="h263-0-28" class="i">+
</a><a href="#h263-0-29" id="h263-0-29" class="i">+    private val cachedData = ConcurrentHashMap&lt;String, Pair&lt;InputStream, Long&gt;&gt;()
</a><a href="#h263-0-30" id="h263-0-30" class="i">+    private var serverSocket: ServerSocket? = null
</a><a href="#h263-0-31" id="h263-0-31" class="i">+
</a><a href="#h263-0-32" id="h263-0-32" class="i">+    fun ensureServerStarted(callback: HttpServer.() -&gt; Unit) {
</a><a href="#h263-0-33" id="h263-0-33" class="i">+        if (serverSocket != null &amp;&amp; !serverSocket!!.isClosed) {
</a><a href="#h263-0-34" id="h263-0-34" class="i">+            callback(this)
</a><a href="#h263-0-35" id="h263-0-35" class="i">+            return
</a><a href="#h263-0-36" id="h263-0-36" class="i">+        }
</a><a href="#h263-0-37" id="h263-0-37" class="i">+
</a><a href="#h263-0-38" id="h263-0-38" class="i">+        coroutineScope.launch(Dispatchers.IO) {
</a><a href="#h263-0-39" id="h263-0-39" class="i">+            AbstractLogger.directDebug(&quot;starting http server on port $port&quot;)
</a><a href="#h263-0-40" id="h263-0-40" class="i">+            serverSocket = ServerSocket(port)
</a><a href="#h263-0-41" id="h263-0-41" class="i">+            callback(this@HttpServer)
</a><a href="#h263-0-42" id="h263-0-42" class="i">+            while (!serverSocket!!.isClosed) {
</a><a href="#h263-0-43" id="h263-0-43" class="i">+                try {
</a><a href="#h263-0-44" id="h263-0-44" class="i">+                    val socket = serverSocket!!.accept()
</a><a href="#h263-0-45" id="h263-0-45" class="i">+                    timeoutJob?.cancel()
</a><a href="#h263-0-46" id="h263-0-46" class="i">+                    launch {
</a><a href="#h263-0-47" id="h263-0-47" class="i">+                        handleRequest(socket)
</a><a href="#h263-0-48" id="h263-0-48" class="i">+                        timeoutJob = launch {
</a><a href="#h263-0-49" id="h263-0-49" class="i">+                            delay(timeout.toLong())
</a><a href="#h263-0-50" id="h263-0-50" class="i">+                            AbstractLogger.directDebug(&quot;http server closed due to timeout&quot;)
</a><a href="#h263-0-51" id="h263-0-51" class="i">+                            runCatching {
</a><a href="#h263-0-52" id="h263-0-52" class="i">+                                socketJob?.cancel()
</a><a href="#h263-0-53" id="h263-0-53" class="i">+                                socket.close()
</a><a href="#h263-0-54" id="h263-0-54" class="i">+                                serverSocket?.close()
</a><a href="#h263-0-55" id="h263-0-55" class="i">+                            }.onFailure {
</a><a href="#h263-0-56" id="h263-0-56" class="i">+                                AbstractLogger.directError(&quot;failed to close socket&quot;, it)
</a><a href="#h263-0-57" id="h263-0-57" class="i">+                            }
</a><a href="#h263-0-58" id="h263-0-58" class="i">+                        }
</a><a href="#h263-0-59" id="h263-0-59" class="i">+                    }
</a><a href="#h263-0-60" id="h263-0-60" class="i">+                } catch (e: SocketException) {
</a><a href="#h263-0-61" id="h263-0-61" class="i">+                    AbstractLogger.directDebug(&quot;http server timed out&quot;)
</a><a href="#h263-0-62" id="h263-0-62" class="i">+                    break;
</a><a href="#h263-0-63" id="h263-0-63" class="i">+                } catch (e: Throwable) {
</a><a href="#h263-0-64" id="h263-0-64" class="i">+                    AbstractLogger.directError(&quot;failed to handle request&quot;, e)
</a><a href="#h263-0-65" id="h263-0-65" class="i">+                }
</a><a href="#h263-0-66" id="h263-0-66" class="i">+            }
</a><a href="#h263-0-67" id="h263-0-67" class="i">+        }.also { socketJob = it }
</a><a href="#h263-0-68" id="h263-0-68" class="i">+    }
</a><a href="#h263-0-69" id="h263-0-69" class="i">+
</a><a href="#h263-0-70" id="h263-0-70" class="i">+    fun close() {
</a><a href="#h263-0-71" id="h263-0-71" class="i">+        serverSocket?.close()
</a><a href="#h263-0-72" id="h263-0-72" class="i">+    }
</a><a href="#h263-0-73" id="h263-0-73" class="i">+
</a><a href="#h263-0-74" id="h263-0-74" class="i">+    fun putDownloadableContent(inputStream: InputStream, size: Long): String {
</a><a href="#h263-0-75" id="h263-0-75" class="i">+        val key = System.nanoTime().toString(16)
</a><a href="#h263-0-76" id="h263-0-76" class="i">+        cachedData[key] = inputStream to size
</a><a href="#h263-0-77" id="h263-0-77" class="i">+        return &quot;http://127.0.0.1:$port/$key&quot;
</a><a href="#h263-0-78" id="h263-0-78" class="i">+    }
</a><a href="#h263-0-79" id="h263-0-79" class="i">+
</a><a href="#h263-0-80" id="h263-0-80" class="i">+    private fun handleRequest(socket: Socket) {
</a><a href="#h263-0-81" id="h263-0-81" class="i">+        val reader = BufferedReader(InputStreamReader(socket.getInputStream()))
</a><a href="#h263-0-82" id="h263-0-82" class="i">+        val outputStream = socket.getOutputStream()
</a><a href="#h263-0-83" id="h263-0-83" class="i">+        val writer = PrintWriter(outputStream)
</a><a href="#h263-0-84" id="h263-0-84" class="i">+        val line = reader.readLine() ?: return
</a><a href="#h263-0-85" id="h263-0-85" class="i">+        fun close() {
</a><a href="#h263-0-86" id="h263-0-86" class="i">+            runCatching {
</a><a href="#h263-0-87" id="h263-0-87" class="i">+                reader.close()
</a><a href="#h263-0-88" id="h263-0-88" class="i">+                writer.close()
</a><a href="#h263-0-89" id="h263-0-89" class="i">+                outputStream.close()
</a><a href="#h263-0-90" id="h263-0-90" class="i">+                socket.close()
</a><a href="#h263-0-91" id="h263-0-91" class="i">+            }.onFailure {
</a><a href="#h263-0-92" id="h263-0-92" class="i">+                AbstractLogger.directError(&quot;failed to close socket&quot;, it)
</a><a href="#h263-0-93" id="h263-0-93" class="i">+            }
</a><a href="#h263-0-94" id="h263-0-94" class="i">+        }
</a><a href="#h263-0-95" id="h263-0-95" class="i">+        val parse = StringTokenizer(line)
</a><a href="#h263-0-96" id="h263-0-96" class="i">+        val method = parse.nextToken().uppercase(Locale.getDefault())
</a><a href="#h263-0-97" id="h263-0-97" class="i">+        var fileRequested = parse.nextToken().lowercase(Locale.getDefault())
</a><a href="#h263-0-98" id="h263-0-98" class="i">+        AbstractLogger.directDebug(&quot;[http-server:${port}] $method $fileRequested&quot;)
</a><a href="#h263-0-99" id="h263-0-99" class="i">+
</a><a href="#h263-0-100" id="h263-0-100" class="i">+        if (method != &quot;GET&quot;) {
</a><a href="#h263-0-101" id="h263-0-101" class="i">+            with(writer) {
</a><a href="#h263-0-102" id="h263-0-102" class="i">+                println(&quot;HTTP/1.1 501 Not Implemented&quot;)
</a><a href="#h263-0-103" id="h263-0-103" class="i">+                println(&quot;Content-type: &quot; + &quot;application/octet-stream&quot;)
</a><a href="#h263-0-104" id="h263-0-104" class="i">+                println(&quot;Content-length: &quot; + 0)
</a><a href="#h263-0-105" id="h263-0-105" class="i">+                println()
</a><a href="#h263-0-106" id="h263-0-106" class="i">+                flush()
</a><a href="#h263-0-107" id="h263-0-107" class="i">+            }
</a><a href="#h263-0-108" id="h263-0-108" class="i">+            close()
</a><a href="#h263-0-109" id="h263-0-109" class="i">+            return
</a><a href="#h263-0-110" id="h263-0-110" class="i">+        }
</a><a href="#h263-0-111" id="h263-0-111" class="i">+        if (fileRequested.startsWith(&quot;/&quot;)) {
</a><a href="#h263-0-112" id="h263-0-112" class="i">+            fileRequested = fileRequested.substring(1)
</a><a href="#h263-0-113" id="h263-0-113" class="i">+        }
</a><a href="#h263-0-114" id="h263-0-114" class="i">+        if (!cachedData.containsKey(fileRequested)) {
</a><a href="#h263-0-115" id="h263-0-115" class="i">+            with(writer) {
</a><a href="#h263-0-116" id="h263-0-116" class="i">+                println(&quot;HTTP/1.1 404 Not Found&quot;)
</a><a href="#h263-0-117" id="h263-0-117" class="i">+                println(&quot;Content-type: &quot; + &quot;application/octet-stream&quot;)
</a><a href="#h263-0-118" id="h263-0-118" class="i">+                println(&quot;Content-length: &quot; + 0)
</a><a href="#h263-0-119" id="h263-0-119" class="i">+                println()
</a><a href="#h263-0-120" id="h263-0-120" class="i">+                flush()
</a><a href="#h263-0-121" id="h263-0-121" class="i">+            }
</a><a href="#h263-0-122" id="h263-0-122" class="i">+            close()
</a><a href="#h263-0-123" id="h263-0-123" class="i">+            return
</a><a href="#h263-0-124" id="h263-0-124" class="i">+        }
</a><a href="#h263-0-125" id="h263-0-125" class="i">+        val requestedData = cachedData[fileRequested]!!
</a><a href="#h263-0-126" id="h263-0-126" class="i">+        with(writer) {
</a><a href="#h263-0-127" id="h263-0-127" class="i">+            println(&quot;HTTP/1.1 200 OK&quot;)
</a><a href="#h263-0-128" id="h263-0-128" class="i">+            println(&quot;Content-type: &quot; + &quot;application/octet-stream&quot;)
</a><a href="#h263-0-129" id="h263-0-129" class="i">+            println(&quot;Content-length: &quot; + requestedData.second)
</a><a href="#h263-0-130" id="h263-0-130" class="i">+            println()
</a><a href="#h263-0-131" id="h263-0-131" class="i">+            flush()
</a><a href="#h263-0-132" id="h263-0-132" class="i">+        }
</a><a href="#h263-0-133" id="h263-0-133" class="i">+        requestedData.first.copyTo(outputStream)
</a><a href="#h263-0-134" id="h263-0-134" class="i">+        outputStream.flush()
</a><a href="#h263-0-135" id="h263-0-135" class="i">+        cachedData.remove(fileRequested)
</a><a href="#h263-0-136" id="h263-0-136" class="i">+        close()
</a><a href="#h263-0-137" id="h263-0-137" class="i">+    }
</a><a href="#h263-0-138" id="h263-0-138" class="i">+}</a><a href="#h263-0-139" id="h263-0-139" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h264" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/util/media/PreviewUtils.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/util/media/PreviewUtils.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/util/media/PreviewUtils.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/util/media/PreviewUtils.kt</a></b>
<a href="#h264-0" id="h264-0" class="h">@@ -0,0 +1,87 @@
</a><a href="#h264-0-0" id="h264-0-0" class="i">+package me.rhunk.snapenhance.core.util.media
</a><a href="#h264-0-1" id="h264-0-1" class="i">+
</a><a href="#h264-0-2" id="h264-0-2" class="i">+import android.graphics.Bitmap
</a><a href="#h264-0-3" id="h264-0-3" class="i">+import android.graphics.BitmapFactory
</a><a href="#h264-0-4" id="h264-0-4" class="i">+import android.graphics.Canvas
</a><a href="#h264-0-5" id="h264-0-5" class="i">+import android.graphics.Matrix
</a><a href="#h264-0-6" id="h264-0-6" class="i">+import android.media.MediaDataSource
</a><a href="#h264-0-7" id="h264-0-7" class="i">+import android.media.MediaMetadataRetriever
</a><a href="#h264-0-8" id="h264-0-8" class="i">+import me.rhunk.snapenhance.common.data.FileType
</a><a href="#h264-0-9" id="h264-0-9" class="i">+import java.io.File
</a><a href="#h264-0-10" id="h264-0-10" class="i">+
</a><a href="#h264-0-11" id="h264-0-11" class="i">+object PreviewUtils {
</a><a href="#h264-0-12" id="h264-0-12" class="i">+    fun createPreview(data: ByteArray, isVideo: Boolean): Bitmap? {
</a><a href="#h264-0-13" id="h264-0-13" class="i">+        if (!isVideo) {
</a><a href="#h264-0-14" id="h264-0-14" class="i">+            return BitmapFactory.decodeByteArray(data, 0, data.size)
</a><a href="#h264-0-15" id="h264-0-15" class="i">+        }
</a><a href="#h264-0-16" id="h264-0-16" class="i">+        return MediaMetadataRetriever().apply {
</a><a href="#h264-0-17" id="h264-0-17" class="i">+            setDataSource(object : MediaDataSource() {
</a><a href="#h264-0-18" id="h264-0-18" class="i">+                override fun readAt(
</a><a href="#h264-0-19" id="h264-0-19" class="i">+                    position: Long,
</a><a href="#h264-0-20" id="h264-0-20" class="i">+                    buffer: ByteArray,
</a><a href="#h264-0-21" id="h264-0-21" class="i">+                    offset: Int,
</a><a href="#h264-0-22" id="h264-0-22" class="i">+                    size: Int
</a><a href="#h264-0-23" id="h264-0-23" class="i">+                ): Int {
</a><a href="#h264-0-24" id="h264-0-24" class="i">+                    var newSize = size
</a><a href="#h264-0-25" id="h264-0-25" class="i">+                    val length = data.size
</a><a href="#h264-0-26" id="h264-0-26" class="i">+                    if (position &gt;= length) {
</a><a href="#h264-0-27" id="h264-0-27" class="i">+                        return -1
</a><a href="#h264-0-28" id="h264-0-28" class="i">+                    }
</a><a href="#h264-0-29" id="h264-0-29" class="i">+                    if (position + newSize &gt; length) {
</a><a href="#h264-0-30" id="h264-0-30" class="i">+                        newSize = length - position.toInt()
</a><a href="#h264-0-31" id="h264-0-31" class="i">+                    }
</a><a href="#h264-0-32" id="h264-0-32" class="i">+                    System.arraycopy(data, position.toInt(), buffer, offset, newSize)
</a><a href="#h264-0-33" id="h264-0-33" class="i">+                    return newSize
</a><a href="#h264-0-34" id="h264-0-34" class="i">+                }
</a><a href="#h264-0-35" id="h264-0-35" class="i">+
</a><a href="#h264-0-36" id="h264-0-36" class="i">+                override fun getSize(): Long {
</a><a href="#h264-0-37" id="h264-0-37" class="i">+                    return data.size.toLong()
</a><a href="#h264-0-38" id="h264-0-38" class="i">+                }
</a><a href="#h264-0-39" id="h264-0-39" class="i">+                override fun close() {}
</a><a href="#h264-0-40" id="h264-0-40" class="i">+            })
</a><a href="#h264-0-41" id="h264-0-41" class="i">+        }.getFrameAtTime(0, MediaMetadataRetriever.OPTION_CLOSEST_SYNC)
</a><a href="#h264-0-42" id="h264-0-42" class="i">+    }
</a><a href="#h264-0-43" id="h264-0-43" class="i">+
</a><a href="#h264-0-44" id="h264-0-44" class="i">+    fun createPreviewFromFile(file: File): Bitmap? {
</a><a href="#h264-0-45" id="h264-0-45" class="i">+        return if (FileType.fromFile(file).isVideo) {
</a><a href="#h264-0-46" id="h264-0-46" class="i">+            MediaMetadataRetriever().apply {
</a><a href="#h264-0-47" id="h264-0-47" class="i">+                setDataSource(file.absolutePath)
</a><a href="#h264-0-48" id="h264-0-48" class="i">+            }.getFrameAtTime(0, MediaMetadataRetriever.OPTION_CLOSEST_SYNC)
</a><a href="#h264-0-49" id="h264-0-49" class="i">+        } else {
</a><a href="#h264-0-50" id="h264-0-50" class="i">+            BitmapFactory.decodeFile(file.absolutePath, BitmapFactory.Options())
</a><a href="#h264-0-51" id="h264-0-51" class="i">+        }
</a><a href="#h264-0-52" id="h264-0-52" class="i">+    }
</a><a href="#h264-0-53" id="h264-0-53" class="i">+
</a><a href="#h264-0-54" id="h264-0-54" class="i">+    private fun resizeBitmap(bitmap: Bitmap, outWidth: Int, outHeight: Int): Bitmap? {
</a><a href="#h264-0-55" id="h264-0-55" class="i">+        val scaleWidth = outWidth.toFloat() / bitmap.width
</a><a href="#h264-0-56" id="h264-0-56" class="i">+        val scaleHeight = outHeight.toFloat() / bitmap.height
</a><a href="#h264-0-57" id="h264-0-57" class="i">+        val matrix = Matrix()
</a><a href="#h264-0-58" id="h264-0-58" class="i">+        matrix.postScale(scaleWidth, scaleHeight)
</a><a href="#h264-0-59" id="h264-0-59" class="i">+        val resizedBitmap = Bitmap.createBitmap(bitmap, 0, 0, bitmap.width, bitmap.height, matrix, false)
</a><a href="#h264-0-60" id="h264-0-60" class="i">+        bitmap.recycle()
</a><a href="#h264-0-61" id="h264-0-61" class="i">+        return resizedBitmap
</a><a href="#h264-0-62" id="h264-0-62" class="i">+    }
</a><a href="#h264-0-63" id="h264-0-63" class="i">+
</a><a href="#h264-0-64" id="h264-0-64" class="i">+    fun mergeBitmapOverlay(originalMedia: Bitmap, overlayLayer: Bitmap): Bitmap {
</a><a href="#h264-0-65" id="h264-0-65" class="i">+        val biggestBitmap = if (originalMedia.width * originalMedia.height &gt; overlayLayer.width * overlayLayer.height) originalMedia else overlayLayer
</a><a href="#h264-0-66" id="h264-0-66" class="i">+        val smallestBitmap = if (biggestBitmap == originalMedia) overlayLayer else originalMedia
</a><a href="#h264-0-67" id="h264-0-67" class="i">+
</a><a href="#h264-0-68" id="h264-0-68" class="i">+        val mergedBitmap = Bitmap.createBitmap(biggestBitmap.width, biggestBitmap.height, biggestBitmap.config)
</a><a href="#h264-0-69" id="h264-0-69" class="i">+
</a><a href="#h264-0-70" id="h264-0-70" class="i">+        with(Canvas(mergedBitmap)) {
</a><a href="#h264-0-71" id="h264-0-71" class="i">+            val scaleMatrix = Matrix().apply {
</a><a href="#h264-0-72" id="h264-0-72" class="i">+                postScale(biggestBitmap.width.toFloat() / smallestBitmap.width.toFloat(), biggestBitmap.height.toFloat() / smallestBitmap.height.toFloat())
</a><a href="#h264-0-73" id="h264-0-73" class="i">+            }
</a><a href="#h264-0-74" id="h264-0-74" class="i">+
</a><a href="#h264-0-75" id="h264-0-75" class="i">+            if (biggestBitmap == originalMedia) {
</a><a href="#h264-0-76" id="h264-0-76" class="i">+                drawBitmap(originalMedia, 0f, 0f, null)
</a><a href="#h264-0-77" id="h264-0-77" class="i">+                drawBitmap(overlayLayer, scaleMatrix, null)
</a><a href="#h264-0-78" id="h264-0-78" class="i">+            } else {
</a><a href="#h264-0-79" id="h264-0-79" class="i">+                drawBitmap(originalMedia, scaleMatrix, null)
</a><a href="#h264-0-80" id="h264-0-80" class="i">+                drawBitmap(overlayLayer, 0f, 0f, null)
</a><a href="#h264-0-81" id="h264-0-81" class="i">+            }
</a><a href="#h264-0-82" id="h264-0-82" class="i">+        }
</a><a href="#h264-0-83" id="h264-0-83" class="i">+
</a><a href="#h264-0-84" id="h264-0-84" class="i">+        return mergedBitmap
</a><a href="#h264-0-85" id="h264-0-85" class="i">+    }
</a><a href="#h264-0-86" id="h264-0-86" class="i">+}
</a><b>diff --git a/<a id="h265" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/util/protobuf/ProtoEditor.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/util/protobuf/ProtoEditor.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/util/protobuf/ProtoEditor.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/util/protobuf/ProtoEditor.kt</a></b>
<a href="#h265-0" id="h265-0" class="h">@@ -1,67 +0,0 @@
</a><a href="#h265-0-0" id="h265-0-0" class="d">-package me.rhunk.snapenhance.core.util.protobuf
</a><a href="#h265-0-1" id="h265-0-1" class="d">-
</a><a href="#h265-0-2" id="h265-0-2" class="d">-
</a><a href="#h265-0-3" id="h265-0-3" class="d">-typealias WireCallback = EditorContext.() -&gt; Unit
</a><a href="#h265-0-4" id="h265-0-4" class="d">-
</a><a href="#h265-0-5" id="h265-0-5" class="d">-class EditorContext(
</a><a href="#h265-0-6" id="h265-0-6" class="d">-    private val wires: MutableMap&lt;Int, MutableList&lt;Wire&gt;&gt;
</a><a href="#h265-0-7" id="h265-0-7" class="d">-) {
</a><a href="#h265-0-8" id="h265-0-8" class="d">-    fun clear() {
</a><a href="#h265-0-9" id="h265-0-9" class="d">-        wires.clear()
</a><a href="#h265-0-10" id="h265-0-10" class="d">-    }
</a><a href="#h265-0-11" id="h265-0-11" class="d">-    fun addWire(wire: Wire) {
</a><a href="#h265-0-12" id="h265-0-12" class="d">-        wires.getOrPut(wire.id) { mutableListOf() }.add(wire)
</a><a href="#h265-0-13" id="h265-0-13" class="d">-    }
</a><a href="#h265-0-14" id="h265-0-14" class="d">-    fun addVarInt(id: Int, value: Int) = addVarInt(id, value.toLong())
</a><a href="#h265-0-15" id="h265-0-15" class="d">-    fun addVarInt(id: Int, value: Long) = addWire(Wire(id, WireType.VARINT, value))
</a><a href="#h265-0-16" id="h265-0-16" class="d">-    fun addBuffer(id: Int, value: ByteArray) = addWire(Wire(id, WireType.CHUNK, value))
</a><a href="#h265-0-17" id="h265-0-17" class="d">-    fun add(id: Int, content: ProtoWriter.() -&gt; Unit) = addBuffer(id, ProtoWriter().apply(content).toByteArray())
</a><a href="#h265-0-18" id="h265-0-18" class="d">-    fun addString(id: Int, value: String) = addBuffer(id, value.toByteArray())
</a><a href="#h265-0-19" id="h265-0-19" class="d">-    fun addFixed64(id: Int, value: Long) = addWire(Wire(id, WireType.FIXED64, value))
</a><a href="#h265-0-20" id="h265-0-20" class="d">-    fun addFixed32(id: Int, value: Int) = addWire(Wire(id, WireType.FIXED32, value))
</a><a href="#h265-0-21" id="h265-0-21" class="d">-
</a><a href="#h265-0-22" id="h265-0-22" class="d">-    fun firstOrNull(id: Int) = wires[id]?.firstOrNull()
</a><a href="#h265-0-23" id="h265-0-23" class="d">-    fun getOrNull(id: Int) = wires[id]
</a><a href="#h265-0-24" id="h265-0-24" class="d">-    fun get(id: Int) = wires[id]!!
</a><a href="#h265-0-25" id="h265-0-25" class="d">-
</a><a href="#h265-0-26" id="h265-0-26" class="d">-    fun remove(id: Int) = wires.remove(id)
</a><a href="#h265-0-27" id="h265-0-27" class="d">-    fun remove(id: Int, index: Int) = wires[id]?.removeAt(index)
</a><a href="#h265-0-28" id="h265-0-28" class="d">-}
</a><a href="#h265-0-29" id="h265-0-29" class="d">-
</a><a href="#h265-0-30" id="h265-0-30" class="d">-class ProtoEditor(
</a><a href="#h265-0-31" id="h265-0-31" class="d">-    private var buffer: ByteArray
</a><a href="#h265-0-32" id="h265-0-32" class="d">-) {
</a><a href="#h265-0-33" id="h265-0-33" class="d">-    fun edit(vararg path: Int, callback: WireCallback) {
</a><a href="#h265-0-34" id="h265-0-34" class="d">-        buffer = writeAtPath(path, 0, ProtoReader(buffer), callback)
</a><a href="#h265-0-35" id="h265-0-35" class="d">-    }
</a><a href="#h265-0-36" id="h265-0-36" class="d">-
</a><a href="#h265-0-37" id="h265-0-37" class="d">-    private fun writeAtPath(path: IntArray, currentIndex: Int, rootReader: ProtoReader, wireToWriteCallback: WireCallback): ByteArray {
</a><a href="#h265-0-38" id="h265-0-38" class="d">-        val id = path.getOrNull(currentIndex)
</a><a href="#h265-0-39" id="h265-0-39" class="d">-        val output = ProtoWriter()
</a><a href="#h265-0-40" id="h265-0-40" class="d">-        val wires = sortedMapOf&lt;Int, MutableList&lt;Wire&gt;&gt;()
</a><a href="#h265-0-41" id="h265-0-41" class="d">-
</a><a href="#h265-0-42" id="h265-0-42" class="d">-        rootReader.forEach { wireId, value -&gt;
</a><a href="#h265-0-43" id="h265-0-43" class="d">-            wires.putIfAbsent(wireId, mutableListOf())
</a><a href="#h265-0-44" id="h265-0-44" class="d">-            if (id != null &amp;&amp; wireId == id) {
</a><a href="#h265-0-45" id="h265-0-45" class="d">-                val childReader = rootReader.followPath(id)
</a><a href="#h265-0-46" id="h265-0-46" class="d">-                if (childReader == null) {
</a><a href="#h265-0-47" id="h265-0-47" class="d">-                    wires.getOrPut(wireId) { mutableListOf() }.add(value)
</a><a href="#h265-0-48" id="h265-0-48" class="d">-                    return@forEach
</a><a href="#h265-0-49" id="h265-0-49" class="d">-                }
</a><a href="#h265-0-50" id="h265-0-50" class="d">-                wires[wireId]!!.add(Wire(wireId, WireType.CHUNK, writeAtPath(path, currentIndex + 1, childReader, wireToWriteCallback)))
</a><a href="#h265-0-51" id="h265-0-51" class="d">-                return@forEach
</a><a href="#h265-0-52" id="h265-0-52" class="d">-            }
</a><a href="#h265-0-53" id="h265-0-53" class="d">-            wires[wireId]!!.add(value)
</a><a href="#h265-0-54" id="h265-0-54" class="d">-        }
</a><a href="#h265-0-55" id="h265-0-55" class="d">-
</a><a href="#h265-0-56" id="h265-0-56" class="d">-        if (currentIndex == path.size) {
</a><a href="#h265-0-57" id="h265-0-57" class="d">-            wireToWriteCallback(EditorContext(wires))
</a><a href="#h265-0-58" id="h265-0-58" class="d">-        }
</a><a href="#h265-0-59" id="h265-0-59" class="d">-
</a><a href="#h265-0-60" id="h265-0-60" class="d">-        wires.values.flatten().forEach(output::addWire)
</a><a href="#h265-0-61" id="h265-0-61" class="d">-
</a><a href="#h265-0-62" id="h265-0-62" class="d">-        return output.toByteArray()
</a><a href="#h265-0-63" id="h265-0-63" class="d">-    }
</a><a href="#h265-0-64" id="h265-0-64" class="d">-
</a><a href="#h265-0-65" id="h265-0-65" class="d">-    fun toByteArray() = buffer
</a><a href="#h265-0-66" id="h265-0-66" class="d">-}</a><a href="#h265-0-67" id="h265-0-67" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h266" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/util/protobuf/ProtoReader.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/util/protobuf/ProtoReader.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/util/protobuf/ProtoReader.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/util/protobuf/ProtoReader.kt</a></b>
<a href="#h266-0" id="h266-0" class="h">@@ -1,255 +0,0 @@
</a><a href="#h266-0-0" id="h266-0-0" class="d">-package me.rhunk.snapenhance.core.util.protobuf
</a><a href="#h266-0-1" id="h266-0-1" class="d">-
</a><a href="#h266-0-2" id="h266-0-2" class="d">-import java.util.UUID
</a><a href="#h266-0-3" id="h266-0-3" class="d">-
</a><a href="#h266-0-4" id="h266-0-4" class="d">-data class Wire(val id: Int, val type: WireType, val value: Any)
</a><a href="#h266-0-5" id="h266-0-5" class="d">-
</a><a href="#h266-0-6" id="h266-0-6" class="d">-class ProtoReader(private val buffer: ByteArray) {
</a><a href="#h266-0-7" id="h266-0-7" class="d">-    private var offset: Int = 0
</a><a href="#h266-0-8" id="h266-0-8" class="d">-    private val values = mutableMapOf&lt;Int, MutableList&lt;Wire&gt;&gt;()
</a><a href="#h266-0-9" id="h266-0-9" class="d">-
</a><a href="#h266-0-10" id="h266-0-10" class="d">-    init {
</a><a href="#h266-0-11" id="h266-0-11" class="d">-        read()
</a><a href="#h266-0-12" id="h266-0-12" class="d">-    }
</a><a href="#h266-0-13" id="h266-0-13" class="d">-
</a><a href="#h266-0-14" id="h266-0-14" class="d">-    fun getBuffer() = buffer
</a><a href="#h266-0-15" id="h266-0-15" class="d">-
</a><a href="#h266-0-16" id="h266-0-16" class="d">-    private fun readByte() = buffer[offset++]
</a><a href="#h266-0-17" id="h266-0-17" class="d">-
</a><a href="#h266-0-18" id="h266-0-18" class="d">-    private fun readVarInt(): Long {
</a><a href="#h266-0-19" id="h266-0-19" class="d">-        var result = 0L
</a><a href="#h266-0-20" id="h266-0-20" class="d">-        var shift = 0
</a><a href="#h266-0-21" id="h266-0-21" class="d">-        while (true) {
</a><a href="#h266-0-22" id="h266-0-22" class="d">-            val b = readByte()
</a><a href="#h266-0-23" id="h266-0-23" class="d">-            result = result or ((b.toLong() and 0x7F) shl shift)
</a><a href="#h266-0-24" id="h266-0-24" class="d">-            if (b.toInt() and 0x80 == 0) {
</a><a href="#h266-0-25" id="h266-0-25" class="d">-                break
</a><a href="#h266-0-26" id="h266-0-26" class="d">-            }
</a><a href="#h266-0-27" id="h266-0-27" class="d">-            shift += 7
</a><a href="#h266-0-28" id="h266-0-28" class="d">-        }
</a><a href="#h266-0-29" id="h266-0-29" class="d">-        return result
</a><a href="#h266-0-30" id="h266-0-30" class="d">-    }
</a><a href="#h266-0-31" id="h266-0-31" class="d">-
</a><a href="#h266-0-32" id="h266-0-32" class="d">-    private fun read() {
</a><a href="#h266-0-33" id="h266-0-33" class="d">-        while (offset &lt; buffer.size) {
</a><a href="#h266-0-34" id="h266-0-34" class="d">-            try {
</a><a href="#h266-0-35" id="h266-0-35" class="d">-                val tag = readVarInt().toInt()
</a><a href="#h266-0-36" id="h266-0-36" class="d">-                val id = tag ushr 3
</a><a href="#h266-0-37" id="h266-0-37" class="d">-                val type = WireType.fromValue(tag and 0x7) ?: break
</a><a href="#h266-0-38" id="h266-0-38" class="d">-                val value = when (type) {
</a><a href="#h266-0-39" id="h266-0-39" class="d">-                    WireType.VARINT -&gt; readVarInt()
</a><a href="#h266-0-40" id="h266-0-40" class="d">-                    WireType.FIXED64 -&gt; {
</a><a href="#h266-0-41" id="h266-0-41" class="d">-                        val bytes = ByteArray(8)
</a><a href="#h266-0-42" id="h266-0-42" class="d">-                        for (i in 0..7) {
</a><a href="#h266-0-43" id="h266-0-43" class="d">-                            bytes[i] = readByte()
</a><a href="#h266-0-44" id="h266-0-44" class="d">-                        }
</a><a href="#h266-0-45" id="h266-0-45" class="d">-                        bytes
</a><a href="#h266-0-46" id="h266-0-46" class="d">-                    }
</a><a href="#h266-0-47" id="h266-0-47" class="d">-                    WireType.CHUNK -&gt; {
</a><a href="#h266-0-48" id="h266-0-48" class="d">-                        val length = readVarInt().toInt()
</a><a href="#h266-0-49" id="h266-0-49" class="d">-                        val bytes = ByteArray(length)
</a><a href="#h266-0-50" id="h266-0-50" class="d">-                        for (i in 0 until length) {
</a><a href="#h266-0-51" id="h266-0-51" class="d">-                            bytes[i] = readByte()
</a><a href="#h266-0-52" id="h266-0-52" class="d">-                        }
</a><a href="#h266-0-53" id="h266-0-53" class="d">-                        bytes
</a><a href="#h266-0-54" id="h266-0-54" class="d">-                    }
</a><a href="#h266-0-55" id="h266-0-55" class="d">-                    WireType.START_GROUP -&gt; {
</a><a href="#h266-0-56" id="h266-0-56" class="d">-                        val bytes = mutableListOf&lt;Byte&gt;()
</a><a href="#h266-0-57" id="h266-0-57" class="d">-                        while (true) {
</a><a href="#h266-0-58" id="h266-0-58" class="d">-                            val b = readByte()
</a><a href="#h266-0-59" id="h266-0-59" class="d">-                            if (b.toInt() == WireType.END_GROUP.value) {
</a><a href="#h266-0-60" id="h266-0-60" class="d">-                                break
</a><a href="#h266-0-61" id="h266-0-61" class="d">-                            }
</a><a href="#h266-0-62" id="h266-0-62" class="d">-                            bytes.add(b)
</a><a href="#h266-0-63" id="h266-0-63" class="d">-                        }
</a><a href="#h266-0-64" id="h266-0-64" class="d">-                        bytes.toByteArray()
</a><a href="#h266-0-65" id="h266-0-65" class="d">-                    }
</a><a href="#h266-0-66" id="h266-0-66" class="d">-                    WireType.FIXED32 -&gt; {
</a><a href="#h266-0-67" id="h266-0-67" class="d">-                        val bytes = ByteArray(4)
</a><a href="#h266-0-68" id="h266-0-68" class="d">-                        for (i in 0..3) {
</a><a href="#h266-0-69" id="h266-0-69" class="d">-                            bytes[i] = readByte()
</a><a href="#h266-0-70" id="h266-0-70" class="d">-                        }
</a><a href="#h266-0-71" id="h266-0-71" class="d">-                        bytes
</a><a href="#h266-0-72" id="h266-0-72" class="d">-                    }
</a><a href="#h266-0-73" id="h266-0-73" class="d">-                    WireType.END_GROUP -&gt; continue
</a><a href="#h266-0-74" id="h266-0-74" class="d">-                }
</a><a href="#h266-0-75" id="h266-0-75" class="d">-                values.getOrPut(id) { mutableListOf() }.add(Wire(id, type, value))
</a><a href="#h266-0-76" id="h266-0-76" class="d">-            } catch (t: Throwable) {
</a><a href="#h266-0-77" id="h266-0-77" class="d">-                values.clear()
</a><a href="#h266-0-78" id="h266-0-78" class="d">-                break
</a><a href="#h266-0-79" id="h266-0-79" class="d">-            }
</a><a href="#h266-0-80" id="h266-0-80" class="d">-        }
</a><a href="#h266-0-81" id="h266-0-81" class="d">-    }
</a><a href="#h266-0-82" id="h266-0-82" class="d">-
</a><a href="#h266-0-83" id="h266-0-83" class="d">-    fun followPath(vararg ids: Int, excludeLast: Boolean = false, reader: (ProtoReader.() -&gt; Unit)? = null): ProtoReader? {
</a><a href="#h266-0-84" id="h266-0-84" class="d">-        var thisReader = this
</a><a href="#h266-0-85" id="h266-0-85" class="d">-        ids.let {
</a><a href="#h266-0-86" id="h266-0-86" class="d">-            if (excludeLast) {
</a><a href="#h266-0-87" id="h266-0-87" class="d">-                it.sliceArray(0 until it.size - 1)
</a><a href="#h266-0-88" id="h266-0-88" class="d">-            } else {
</a><a href="#h266-0-89" id="h266-0-89" class="d">-                it
</a><a href="#h266-0-90" id="h266-0-90" class="d">-            }
</a><a href="#h266-0-91" id="h266-0-91" class="d">-        }.forEach { id -&gt;
</a><a href="#h266-0-92" id="h266-0-92" class="d">-            if (!thisReader.contains(id)) {
</a><a href="#h266-0-93" id="h266-0-93" class="d">-                return null
</a><a href="#h266-0-94" id="h266-0-94" class="d">-            }
</a><a href="#h266-0-95" id="h266-0-95" class="d">-            thisReader = ProtoReader(thisReader.getByteArray(id) ?: return null)
</a><a href="#h266-0-96" id="h266-0-96" class="d">-        }
</a><a href="#h266-0-97" id="h266-0-97" class="d">-        if (reader != null) {
</a><a href="#h266-0-98" id="h266-0-98" class="d">-            thisReader.reader()
</a><a href="#h266-0-99" id="h266-0-99" class="d">-        }
</a><a href="#h266-0-100" id="h266-0-100" class="d">-        return thisReader
</a><a href="#h266-0-101" id="h266-0-101" class="d">-    }
</a><a href="#h266-0-102" id="h266-0-102" class="d">-
</a><a href="#h266-0-103" id="h266-0-103" class="d">-    fun containsPath(vararg ids: Int): Boolean {
</a><a href="#h266-0-104" id="h266-0-104" class="d">-        var thisReader = this
</a><a href="#h266-0-105" id="h266-0-105" class="d">-        ids.forEach { id -&gt;
</a><a href="#h266-0-106" id="h266-0-106" class="d">-            if (!thisReader.contains(id)) {
</a><a href="#h266-0-107" id="h266-0-107" class="d">-                return false
</a><a href="#h266-0-108" id="h266-0-108" class="d">-            }
</a><a href="#h266-0-109" id="h266-0-109" class="d">-            thisReader = ProtoReader(thisReader.getByteArray(id) ?: return false)
</a><a href="#h266-0-110" id="h266-0-110" class="d">-        }
</a><a href="#h266-0-111" id="h266-0-111" class="d">-        return true
</a><a href="#h266-0-112" id="h266-0-112" class="d">-    }
</a><a href="#h266-0-113" id="h266-0-113" class="d">-
</a><a href="#h266-0-114" id="h266-0-114" class="d">-    fun forEach(reader: (Int, Wire) -&gt; Unit) {
</a><a href="#h266-0-115" id="h266-0-115" class="d">-        values.forEach { (id, wires) -&gt;
</a><a href="#h266-0-116" id="h266-0-116" class="d">-            wires.forEach { wire -&gt;
</a><a href="#h266-0-117" id="h266-0-117" class="d">-                reader(id, wire)
</a><a href="#h266-0-118" id="h266-0-118" class="d">-            }
</a><a href="#h266-0-119" id="h266-0-119" class="d">-        }
</a><a href="#h266-0-120" id="h266-0-120" class="d">-    }
</a><a href="#h266-0-121" id="h266-0-121" class="d">-
</a><a href="#h266-0-122" id="h266-0-122" class="d">-    fun forEach(vararg id: Int, reader: ProtoReader.() -&gt; Unit) {
</a><a href="#h266-0-123" id="h266-0-123" class="d">-        followPath(*id)?.eachBuffer { _, buffer -&gt;
</a><a href="#h266-0-124" id="h266-0-124" class="d">-            ProtoReader(buffer).reader()
</a><a href="#h266-0-125" id="h266-0-125" class="d">-        }
</a><a href="#h266-0-126" id="h266-0-126" class="d">-    }
</a><a href="#h266-0-127" id="h266-0-127" class="d">-
</a><a href="#h266-0-128" id="h266-0-128" class="d">-    fun eachBuffer(vararg ids: Int, reader: ProtoReader.() -&gt; Unit) {
</a><a href="#h266-0-129" id="h266-0-129" class="d">-        followPath(*ids, excludeLast = true)?.eachBuffer { id, buffer -&gt;
</a><a href="#h266-0-130" id="h266-0-130" class="d">-            if (id == ids.last()) {
</a><a href="#h266-0-131" id="h266-0-131" class="d">-                ProtoReader(buffer).reader()
</a><a href="#h266-0-132" id="h266-0-132" class="d">-            }
</a><a href="#h266-0-133" id="h266-0-133" class="d">-        }
</a><a href="#h266-0-134" id="h266-0-134" class="d">-    }
</a><a href="#h266-0-135" id="h266-0-135" class="d">-
</a><a href="#h266-0-136" id="h266-0-136" class="d">-    fun eachBuffer(reader: (Int, ByteArray) -&gt; Unit) {
</a><a href="#h266-0-137" id="h266-0-137" class="d">-        values.forEach { (id, wires) -&gt;
</a><a href="#h266-0-138" id="h266-0-138" class="d">-            wires.forEach { wire -&gt;
</a><a href="#h266-0-139" id="h266-0-139" class="d">-                if (wire.type == WireType.CHUNK) {
</a><a href="#h266-0-140" id="h266-0-140" class="d">-                    reader(id, wire.value as ByteArray)
</a><a href="#h266-0-141" id="h266-0-141" class="d">-                }
</a><a href="#h266-0-142" id="h266-0-142" class="d">-            }
</a><a href="#h266-0-143" id="h266-0-143" class="d">-        }
</a><a href="#h266-0-144" id="h266-0-144" class="d">-    }
</a><a href="#h266-0-145" id="h266-0-145" class="d">-
</a><a href="#h266-0-146" id="h266-0-146" class="d">-    fun contains(id: Int) = values.containsKey(id)
</a><a href="#h266-0-147" id="h266-0-147" class="d">-
</a><a href="#h266-0-148" id="h266-0-148" class="d">-    fun getWire(id: Int) = values[id]?.firstOrNull()
</a><a href="#h266-0-149" id="h266-0-149" class="d">-    fun getRawValue(id: Int) = getWire(id)?.value
</a><a href="#h266-0-150" id="h266-0-150" class="d">-    fun getByteArray(id: Int) = getRawValue(id) as? ByteArray
</a><a href="#h266-0-151" id="h266-0-151" class="d">-    fun getByteArray(vararg ids: Int) = followPath(*ids, excludeLast = true)?.getByteArray(ids.last())
</a><a href="#h266-0-152" id="h266-0-152" class="d">-    fun getString(id: Int) = getByteArray(id)?.toString(Charsets.UTF_8)
</a><a href="#h266-0-153" id="h266-0-153" class="d">-    fun getString(vararg ids: Int) = followPath(*ids, excludeLast = true)?.getString(ids.last())
</a><a href="#h266-0-154" id="h266-0-154" class="d">-    fun getVarInt(id: Int) = getRawValue(id) as? Long
</a><a href="#h266-0-155" id="h266-0-155" class="d">-    fun getVarInt(vararg ids: Int) = followPath(*ids, excludeLast = true)?.getVarInt(ids.last())
</a><a href="#h266-0-156" id="h266-0-156" class="d">-    fun getCount(id: Int) = values[id]?.size ?: 0
</a><a href="#h266-0-157" id="h266-0-157" class="d">-
</a><a href="#h266-0-158" id="h266-0-158" class="d">-    fun getFixed64(id: Int): Long {
</a><a href="#h266-0-159" id="h266-0-159" class="d">-        val bytes = getByteArray(id) ?: return 0L
</a><a href="#h266-0-160" id="h266-0-160" class="d">-        var value = 0L
</a><a href="#h266-0-161" id="h266-0-161" class="d">-        for (i in 0..7) {
</a><a href="#h266-0-162" id="h266-0-162" class="d">-            value = value or ((bytes[i].toLong() and 0xFF) shl (i * 8))
</a><a href="#h266-0-163" id="h266-0-163" class="d">-        }
</a><a href="#h266-0-164" id="h266-0-164" class="d">-        return value
</a><a href="#h266-0-165" id="h266-0-165" class="d">-    }
</a><a href="#h266-0-166" id="h266-0-166" class="d">-
</a><a href="#h266-0-167" id="h266-0-167" class="d">-
</a><a href="#h266-0-168" id="h266-0-168" class="d">-    fun getFixed32(id: Int): Int {
</a><a href="#h266-0-169" id="h266-0-169" class="d">-        val bytes = getByteArray(id) ?: return 0
</a><a href="#h266-0-170" id="h266-0-170" class="d">-        var value = 0
</a><a href="#h266-0-171" id="h266-0-171" class="d">-        for (i in 0..3) {
</a><a href="#h266-0-172" id="h266-0-172" class="d">-            value = value or ((bytes[i].toInt() and 0xFF) shl (i * 8))
</a><a href="#h266-0-173" id="h266-0-173" class="d">-        }
</a><a href="#h266-0-174" id="h266-0-174" class="d">-        return value
</a><a href="#h266-0-175" id="h266-0-175" class="d">-    }
</a><a href="#h266-0-176" id="h266-0-176" class="d">-
</a><a href="#h266-0-177" id="h266-0-177" class="d">-    private fun prettyPrint(tabSize: Int): String {
</a><a href="#h266-0-178" id="h266-0-178" class="d">-        val tabLine = &quot;    &quot;.repeat(tabSize)
</a><a href="#h266-0-179" id="h266-0-179" class="d">-        val stringBuilder = StringBuilder()
</a><a href="#h266-0-180" id="h266-0-180" class="d">-        values.forEach { (id, wires) -&gt;
</a><a href="#h266-0-181" id="h266-0-181" class="d">-            wires.forEach { wire -&gt;
</a><a href="#h266-0-182" id="h266-0-182" class="d">-                stringBuilder.append(tabLine)
</a><a href="#h266-0-183" id="h266-0-183" class="d">-                stringBuilder.append(&quot;$id &lt;${wire.type.name.lowercase()}&gt; = &quot;)
</a><a href="#h266-0-184" id="h266-0-184" class="d">-                when (wire.type) {
</a><a href="#h266-0-185" id="h266-0-185" class="d">-                    WireType.VARINT -&gt; stringBuilder.append(&quot;${wire.value}\n&quot;)
</a><a href="#h266-0-186" id="h266-0-186" class="d">-                    WireType.FIXED64, WireType.FIXED32 -&gt; {
</a><a href="#h266-0-187" id="h266-0-187" class="d">-                        //print as double, int, floating point
</a><a href="#h266-0-188" id="h266-0-188" class="d">-                        val doubleValue = run {
</a><a href="#h266-0-189" id="h266-0-189" class="d">-                            val bytes = wire.value as ByteArray
</a><a href="#h266-0-190" id="h266-0-190" class="d">-                            var value = 0L
</a><a href="#h266-0-191" id="h266-0-191" class="d">-                            for (i in bytes.indices) {
</a><a href="#h266-0-192" id="h266-0-192" class="d">-                                value = value or ((bytes[i].toLong() and 0xFF) shl (i * 8))
</a><a href="#h266-0-193" id="h266-0-193" class="d">-                            }
</a><a href="#h266-0-194" id="h266-0-194" class="d">-                            value
</a><a href="#h266-0-195" id="h266-0-195" class="d">-                        }.let {
</a><a href="#h266-0-196" id="h266-0-196" class="d">-                            if (wire.type == WireType.FIXED32) {
</a><a href="#h266-0-197" id="h266-0-197" class="d">-                                it.toInt()
</a><a href="#h266-0-198" id="h266-0-198" class="d">-                            } else {
</a><a href="#h266-0-199" id="h266-0-199" class="d">-                                it
</a><a href="#h266-0-200" id="h266-0-200" class="d">-                            }
</a><a href="#h266-0-201" id="h266-0-201" class="d">-                        }
</a><a href="#h266-0-202" id="h266-0-202" class="d">-
</a><a href="#h266-0-203" id="h266-0-203" class="d">-                        stringBuilder.append(&quot;$doubleValue/${doubleValue.toDouble().toBits().toString(16)}\n&quot;)
</a><a href="#h266-0-204" id="h266-0-204" class="d">-                    }
</a><a href="#h266-0-205" id="h266-0-205" class="d">-                    WireType.CHUNK -&gt; {
</a><a href="#h266-0-206" id="h266-0-206" class="d">-                        fun printArray() {
</a><a href="#h266-0-207" id="h266-0-207" class="d">-                            stringBuilder.append(&quot;\n&quot;)
</a><a href="#h266-0-208" id="h266-0-208" class="d">-                            stringBuilder.append(&quot;$tabLine    &quot;)
</a><a href="#h266-0-209" id="h266-0-209" class="d">-                            stringBuilder.append((wire.value as ByteArray).joinToString(&quot; &quot;) { byte -&gt; &quot;%02x&quot;.format(byte) })
</a><a href="#h266-0-210" id="h266-0-210" class="d">-                            stringBuilder.append(&quot;\n&quot;)
</a><a href="#h266-0-211" id="h266-0-211" class="d">-                        }
</a><a href="#h266-0-212" id="h266-0-212" class="d">-                        runCatching {
</a><a href="#h266-0-213" id="h266-0-213" class="d">-                            val array = (wire.value as ByteArray)
</a><a href="#h266-0-214" id="h266-0-214" class="d">-                            if (array.isEmpty()) {
</a><a href="#h266-0-215" id="h266-0-215" class="d">-                                stringBuilder.append(&quot;empty\n&quot;)
</a><a href="#h266-0-216" id="h266-0-216" class="d">-                                return@runCatching
</a><a href="#h266-0-217" id="h266-0-217" class="d">-                            }
</a><a href="#h266-0-218" id="h266-0-218" class="d">-                            //auto detect ascii strings
</a><a href="#h266-0-219" id="h266-0-219" class="d">-                            if (array.all { it in 0x20..0x7E }) {
</a><a href="#h266-0-220" id="h266-0-220" class="d">-                                stringBuilder.append(&quot;string: ${array.toString(Charsets.UTF_8)}\n&quot;)
</a><a href="#h266-0-221" id="h266-0-221" class="d">-                                return@runCatching
</a><a href="#h266-0-222" id="h266-0-222" class="d">-                            }
</a><a href="#h266-0-223" id="h266-0-223" class="d">-
</a><a href="#h266-0-224" id="h266-0-224" class="d">-                            // auto detect uuids
</a><a href="#h266-0-225" id="h266-0-225" class="d">-                            if (array.size == 16) {
</a><a href="#h266-0-226" id="h266-0-226" class="d">-                                val longs = LongArray(2)
</a><a href="#h266-0-227" id="h266-0-227" class="d">-                                for (i in 0 .. 7) {
</a><a href="#h266-0-228" id="h266-0-228" class="d">-                                    longs[0] = longs[0] or ((array[i].toLong() and 0xFF) shl ((7 - i) * 8))
</a><a href="#h266-0-229" id="h266-0-229" class="d">-                                }
</a><a href="#h266-0-230" id="h266-0-230" class="d">-                                for (i in 8 .. 15) {
</a><a href="#h266-0-231" id="h266-0-231" class="d">-                                    longs[1] = longs[1] or ((array[i].toLong() and 0xFF) shl ((15 - i) * 8))
</a><a href="#h266-0-232" id="h266-0-232" class="d">-                                }
</a><a href="#h266-0-233" id="h266-0-233" class="d">-                                stringBuilder.append(&quot;uuid: ${UUID(longs[0], longs[1])}\n&quot;)
</a><a href="#h266-0-234" id="h266-0-234" class="d">-                                return@runCatching
</a><a href="#h266-0-235" id="h266-0-235" class="d">-                            }
</a><a href="#h266-0-236" id="h266-0-236" class="d">-
</a><a href="#h266-0-237" id="h266-0-237" class="d">-                            ProtoReader(array).prettyPrint(tabSize + 1).takeIf { it.isNotEmpty() }?.let {
</a><a href="#h266-0-238" id="h266-0-238" class="d">-                                stringBuilder.append(&quot;message:\n&quot;)
</a><a href="#h266-0-239" id="h266-0-239" class="d">-                                stringBuilder.append(it)
</a><a href="#h266-0-240" id="h266-0-240" class="d">-                            } ?: printArray()
</a><a href="#h266-0-241" id="h266-0-241" class="d">-                        }.onFailure {
</a><a href="#h266-0-242" id="h266-0-242" class="d">-                            printArray()
</a><a href="#h266-0-243" id="h266-0-243" class="d">-                        }
</a><a href="#h266-0-244" id="h266-0-244" class="d">-                    }
</a><a href="#h266-0-245" id="h266-0-245" class="d">-                    else -&gt; stringBuilder.append(&quot;unknown\n&quot;)
</a><a href="#h266-0-246" id="h266-0-246" class="d">-                }
</a><a href="#h266-0-247" id="h266-0-247" class="d">-            }
</a><a href="#h266-0-248" id="h266-0-248" class="d">-        }
</a><a href="#h266-0-249" id="h266-0-249" class="d">-
</a><a href="#h266-0-250" id="h266-0-250" class="d">-        return stringBuilder.toString()
</a><a href="#h266-0-251" id="h266-0-251" class="d">-    }
</a><a href="#h266-0-252" id="h266-0-252" class="d">-
</a><a href="#h266-0-253" id="h266-0-253" class="d">-    override fun toString() = prettyPrint(0)
</a><a href="#h266-0-254" id="h266-0-254" class="d">-}</a><a href="#h266-0-255" id="h266-0-255" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h267" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/util/protobuf/ProtoWriter.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/util/protobuf/ProtoWriter.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/util/protobuf/ProtoWriter.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/util/protobuf/ProtoWriter.kt</a></b>
<a href="#h267-0" id="h267-0" class="h">@@ -1,117 +0,0 @@
</a><a href="#h267-0-0" id="h267-0-0" class="d">-package me.rhunk.snapenhance.core.util.protobuf
</a><a href="#h267-0-1" id="h267-0-1" class="d">-
</a><a href="#h267-0-2" id="h267-0-2" class="d">-import java.io.ByteArrayOutputStream
</a><a href="#h267-0-3" id="h267-0-3" class="d">-
</a><a href="#h267-0-4" id="h267-0-4" class="d">-class ProtoWriter {
</a><a href="#h267-0-5" id="h267-0-5" class="d">-    private val stream: ByteArrayOutputStream = ByteArrayOutputStream()
</a><a href="#h267-0-6" id="h267-0-6" class="d">-
</a><a href="#h267-0-7" id="h267-0-7" class="d">-    private fun writeVarInt(value: Int) {
</a><a href="#h267-0-8" id="h267-0-8" class="d">-        var v = value
</a><a href="#h267-0-9" id="h267-0-9" class="d">-        while (v and -0x80 != 0) {
</a><a href="#h267-0-10" id="h267-0-10" class="d">-            stream.write(v and 0x7F or 0x80)
</a><a href="#h267-0-11" id="h267-0-11" class="d">-            v = v ushr 7
</a><a href="#h267-0-12" id="h267-0-12" class="d">-        }
</a><a href="#h267-0-13" id="h267-0-13" class="d">-        stream.write(v)
</a><a href="#h267-0-14" id="h267-0-14" class="d">-    }
</a><a href="#h267-0-15" id="h267-0-15" class="d">-
</a><a href="#h267-0-16" id="h267-0-16" class="d">-    private fun writeVarLong(value: Long) {
</a><a href="#h267-0-17" id="h267-0-17" class="d">-        var v = value
</a><a href="#h267-0-18" id="h267-0-18" class="d">-        while (v and -0x80L != 0L) {
</a><a href="#h267-0-19" id="h267-0-19" class="d">-            stream.write((v and 0x7FL or 0x80L).toInt())
</a><a href="#h267-0-20" id="h267-0-20" class="d">-            v = v ushr 7
</a><a href="#h267-0-21" id="h267-0-21" class="d">-        }
</a><a href="#h267-0-22" id="h267-0-22" class="d">-        stream.write(v.toInt())
</a><a href="#h267-0-23" id="h267-0-23" class="d">-    }
</a><a href="#h267-0-24" id="h267-0-24" class="d">-
</a><a href="#h267-0-25" id="h267-0-25" class="d">-    fun addBuffer(id: Int, value: ByteArray) {
</a><a href="#h267-0-26" id="h267-0-26" class="d">-        writeVarInt(id shl 3 or WireType.CHUNK.value)
</a><a href="#h267-0-27" id="h267-0-27" class="d">-        writeVarInt(value.size)
</a><a href="#h267-0-28" id="h267-0-28" class="d">-        stream.write(value)
</a><a href="#h267-0-29" id="h267-0-29" class="d">-    }
</a><a href="#h267-0-30" id="h267-0-30" class="d">-
</a><a href="#h267-0-31" id="h267-0-31" class="d">-    fun addVarInt(id: Int, value: Int) = addVarInt(id, value.toLong())
</a><a href="#h267-0-32" id="h267-0-32" class="d">-
</a><a href="#h267-0-33" id="h267-0-33" class="d">-    fun addVarInt(id: Int, value: Long) {
</a><a href="#h267-0-34" id="h267-0-34" class="d">-        writeVarInt(id shl 3)
</a><a href="#h267-0-35" id="h267-0-35" class="d">-        writeVarLong(value)
</a><a href="#h267-0-36" id="h267-0-36" class="d">-    }
</a><a href="#h267-0-37" id="h267-0-37" class="d">-
</a><a href="#h267-0-38" id="h267-0-38" class="d">-    fun addString(id: Int, value: String) = addBuffer(id, value.toByteArray())
</a><a href="#h267-0-39" id="h267-0-39" class="d">-
</a><a href="#h267-0-40" id="h267-0-40" class="d">-    fun addFixed32(id: Int, value: Int) {
</a><a href="#h267-0-41" id="h267-0-41" class="d">-        writeVarInt(id shl 3 or WireType.FIXED32.value)
</a><a href="#h267-0-42" id="h267-0-42" class="d">-        val bytes = ByteArray(4)
</a><a href="#h267-0-43" id="h267-0-43" class="d">-        for (i in 0..3) {
</a><a href="#h267-0-44" id="h267-0-44" class="d">-            bytes[i] = (value shr (i * 8)).toByte()
</a><a href="#h267-0-45" id="h267-0-45" class="d">-        }
</a><a href="#h267-0-46" id="h267-0-46" class="d">-        stream.write(bytes)
</a><a href="#h267-0-47" id="h267-0-47" class="d">-    }
</a><a href="#h267-0-48" id="h267-0-48" class="d">-
</a><a href="#h267-0-49" id="h267-0-49" class="d">-    fun addFixed64(id: Int, value: Long) {
</a><a href="#h267-0-50" id="h267-0-50" class="d">-        writeVarInt(id shl 3 or WireType.FIXED64.value)
</a><a href="#h267-0-51" id="h267-0-51" class="d">-        val bytes = ByteArray(8)
</a><a href="#h267-0-52" id="h267-0-52" class="d">-        for (i in 0..7) {
</a><a href="#h267-0-53" id="h267-0-53" class="d">-            bytes[i] = (value shr (i * 8)).toByte()
</a><a href="#h267-0-54" id="h267-0-54" class="d">-        }
</a><a href="#h267-0-55" id="h267-0-55" class="d">-        stream.write(bytes)
</a><a href="#h267-0-56" id="h267-0-56" class="d">-    }
</a><a href="#h267-0-57" id="h267-0-57" class="d">-
</a><a href="#h267-0-58" id="h267-0-58" class="d">-    fun from(id: Int, writer: ProtoWriter.() -&gt; Unit) {
</a><a href="#h267-0-59" id="h267-0-59" class="d">-        val writerStream = ProtoWriter()
</a><a href="#h267-0-60" id="h267-0-60" class="d">-        writer(writerStream)
</a><a href="#h267-0-61" id="h267-0-61" class="d">-        addBuffer(id, writerStream.stream.toByteArray())
</a><a href="#h267-0-62" id="h267-0-62" class="d">-    }
</a><a href="#h267-0-63" id="h267-0-63" class="d">-
</a><a href="#h267-0-64" id="h267-0-64" class="d">-    fun from(vararg ids: Int, writer: ProtoWriter.() -&gt; Unit) {
</a><a href="#h267-0-65" id="h267-0-65" class="d">-        val writerStream = ProtoWriter()
</a><a href="#h267-0-66" id="h267-0-66" class="d">-        writer(writerStream)
</a><a href="#h267-0-67" id="h267-0-67" class="d">-        var stream = writerStream.stream.toByteArray()
</a><a href="#h267-0-68" id="h267-0-68" class="d">-        ids.reversed().forEach { id -&gt;
</a><a href="#h267-0-69" id="h267-0-69" class="d">-            with(ProtoWriter()) {
</a><a href="#h267-0-70" id="h267-0-70" class="d">-                addBuffer(id, stream)
</a><a href="#h267-0-71" id="h267-0-71" class="d">-                stream = this.stream.toByteArray()
</a><a href="#h267-0-72" id="h267-0-72" class="d">-            }
</a><a href="#h267-0-73" id="h267-0-73" class="d">-        }
</a><a href="#h267-0-74" id="h267-0-74" class="d">-        stream.let(this.stream::write)
</a><a href="#h267-0-75" id="h267-0-75" class="d">-    }
</a><a href="#h267-0-76" id="h267-0-76" class="d">-
</a><a href="#h267-0-77" id="h267-0-77" class="d">-    fun addWire(wire: Wire) {
</a><a href="#h267-0-78" id="h267-0-78" class="d">-        writeVarInt(wire.id shl 3 or wire.type.value)
</a><a href="#h267-0-79" id="h267-0-79" class="d">-        when (wire.type) {
</a><a href="#h267-0-80" id="h267-0-80" class="d">-            WireType.VARINT -&gt; writeVarLong(wire.value as Long)
</a><a href="#h267-0-81" id="h267-0-81" class="d">-            WireType.FIXED64, WireType.FIXED32 -&gt; {
</a><a href="#h267-0-82" id="h267-0-82" class="d">-                when (wire.value) {
</a><a href="#h267-0-83" id="h267-0-83" class="d">-                    is Int -&gt; {
</a><a href="#h267-0-84" id="h267-0-84" class="d">-                        val bytes = ByteArray(4)
</a><a href="#h267-0-85" id="h267-0-85" class="d">-                        for (i in 0..3) {
</a><a href="#h267-0-86" id="h267-0-86" class="d">-                            bytes[i] = (wire.value shr (i * 8)).toByte()
</a><a href="#h267-0-87" id="h267-0-87" class="d">-                        }
</a><a href="#h267-0-88" id="h267-0-88" class="d">-                        stream.write(bytes)
</a><a href="#h267-0-89" id="h267-0-89" class="d">-                    }
</a><a href="#h267-0-90" id="h267-0-90" class="d">-                    is Long -&gt; {
</a><a href="#h267-0-91" id="h267-0-91" class="d">-                        val bytes = ByteArray(8)
</a><a href="#h267-0-92" id="h267-0-92" class="d">-                        for (i in 0..7) {
</a><a href="#h267-0-93" id="h267-0-93" class="d">-                            bytes[i] = (wire.value shr (i * 8)).toByte()
</a><a href="#h267-0-94" id="h267-0-94" class="d">-                        }
</a><a href="#h267-0-95" id="h267-0-95" class="d">-                        stream.write(bytes)
</a><a href="#h267-0-96" id="h267-0-96" class="d">-                    }
</a><a href="#h267-0-97" id="h267-0-97" class="d">-                    is ByteArray -&gt; stream.write(wire.value)
</a><a href="#h267-0-98" id="h267-0-98" class="d">-                }
</a><a href="#h267-0-99" id="h267-0-99" class="d">-            }
</a><a href="#h267-0-100" id="h267-0-100" class="d">-            WireType.CHUNK -&gt; {
</a><a href="#h267-0-101" id="h267-0-101" class="d">-                val value = wire.value as ByteArray
</a><a href="#h267-0-102" id="h267-0-102" class="d">-                writeVarInt(value.size)
</a><a href="#h267-0-103" id="h267-0-103" class="d">-                stream.write(value)
</a><a href="#h267-0-104" id="h267-0-104" class="d">-            }
</a><a href="#h267-0-105" id="h267-0-105" class="d">-            WireType.START_GROUP -&gt; {
</a><a href="#h267-0-106" id="h267-0-106" class="d">-                val value = wire.value as ByteArray
</a><a href="#h267-0-107" id="h267-0-107" class="d">-                stream.write(value)
</a><a href="#h267-0-108" id="h267-0-108" class="d">-            }
</a><a href="#h267-0-109" id="h267-0-109" class="d">-            WireType.END_GROUP -&gt; return
</a><a href="#h267-0-110" id="h267-0-110" class="d">-        }
</a><a href="#h267-0-111" id="h267-0-111" class="d">-    }
</a><a href="#h267-0-112" id="h267-0-112" class="d">-
</a><a href="#h267-0-113" id="h267-0-113" class="d">-    fun toByteArray(): ByteArray {
</a><a href="#h267-0-114" id="h267-0-114" class="d">-        return stream.toByteArray()
</a><a href="#h267-0-115" id="h267-0-115" class="d">-    }
</a><a href="#h267-0-116" id="h267-0-116" class="d">-}</a><a href="#h267-0-117" id="h267-0-117" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h268" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/util/protobuf/WireType.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/util/protobuf/WireType.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/util/protobuf/WireType.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/util/protobuf/WireType.kt</a></b>
<a href="#h268-0" id="h268-0" class="h">@@ -1,14 +0,0 @@
</a><a href="#h268-0-0" id="h268-0-0" class="d">-package me.rhunk.snapenhance.core.util.protobuf;
</a><a href="#h268-0-1" id="h268-0-1" class="d">-
</a><a href="#h268-0-2" id="h268-0-2" class="d">-enum class WireType(val value: Int) {
</a><a href="#h268-0-3" id="h268-0-3" class="d">-    VARINT(0),
</a><a href="#h268-0-4" id="h268-0-4" class="d">-    FIXED64(1),
</a><a href="#h268-0-5" id="h268-0-5" class="d">-    CHUNK(2),
</a><a href="#h268-0-6" id="h268-0-6" class="d">-    START_GROUP(3),
</a><a href="#h268-0-7" id="h268-0-7" class="d">-    END_GROUP(4),
</a><a href="#h268-0-8" id="h268-0-8" class="d">-    FIXED32(5);
</a><a href="#h268-0-9" id="h268-0-9" class="d">-
</a><a href="#h268-0-10" id="h268-0-10" class="d">-    companion object {
</a><a href="#h268-0-11" id="h268-0-11" class="d">-        fun fromValue(value: Int) = entries.firstOrNull { it.value == value }
</a><a href="#h268-0-12" id="h268-0-12" class="d">-    }
</a><a href="#h268-0-13" id="h268-0-13" class="d">-}
</a><b>diff --git a/<a id="h269" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/util/snap/BitmojiSelfie.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/util/snap/BitmojiSelfie.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/util/snap/BitmojiSelfie.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/util/snap/BitmojiSelfie.kt</a></b>
<a href="#h269-0" id="h269-0" class="h">@@ -1,20 +0,0 @@
</a><a href="#h269-0-0" id="h269-0-0" class="d">-package me.rhunk.snapenhance.core.util.snap
</a><a href="#h269-0-1" id="h269-0-1" class="d">-
</a><a href="#h269-0-2" id="h269-0-2" class="d">-object BitmojiSelfie {
</a><a href="#h269-0-3" id="h269-0-3" class="d">-    enum class BitmojiSelfieType(
</a><a href="#h269-0-4" id="h269-0-4" class="d">-        val prefixUrl: String,
</a><a href="#h269-0-5" id="h269-0-5" class="d">-    ) {
</a><a href="#h269-0-6" id="h269-0-6" class="d">-        STANDARD(&quot;https://sdk.bitmoji.com/render/panel/&quot;),
</a><a href="#h269-0-7" id="h269-0-7" class="d">-        THREE_D(&quot;https://images.bitmoji.com/3d/render/&quot;)
</a><a href="#h269-0-8" id="h269-0-8" class="d">-    }
</a><a href="#h269-0-9" id="h269-0-9" class="d">-
</a><a href="#h269-0-10" id="h269-0-10" class="d">-    fun getBitmojiSelfie(selfieId: String?, avatarId: String?, type: BitmojiSelfieType): String? {
</a><a href="#h269-0-11" id="h269-0-11" class="d">-        if (selfieId.isNullOrEmpty() || avatarId.isNullOrEmpty()) {
</a><a href="#h269-0-12" id="h269-0-12" class="d">-            return null
</a><a href="#h269-0-13" id="h269-0-13" class="d">-        }
</a><a href="#h269-0-14" id="h269-0-14" class="d">-        return when (type) {
</a><a href="#h269-0-15" id="h269-0-15" class="d">-            BitmojiSelfieType.STANDARD -&gt; &quot;${type.prefixUrl}$selfieId-$avatarId-v1.webp?transparent=1&quot;
</a><a href="#h269-0-16" id="h269-0-16" class="d">-            BitmojiSelfieType.THREE_D -&gt; &quot;${type.prefixUrl}$selfieId-$avatarId-v1.webp?trim=circle&quot;
</a><a href="#h269-0-17" id="h269-0-17" class="d">-        }
</a><a href="#h269-0-18" id="h269-0-18" class="d">-    }
</a><a href="#h269-0-19" id="h269-0-19" class="d">-}</a><a href="#h269-0-20" id="h269-0-20" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h270" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/util/snap/MediaDownloaderHelper.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/util/snap/MediaDownloaderHelper.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/util/snap/MediaDownloaderHelper.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/util/snap/MediaDownloaderHelper.kt</a></b>
<a href="#h270-0" id="h270-0" class="h">@@ -1,45 +0,0 @@
</a><a href="#h270-0-0" id="h270-0-0" class="d">-package me.rhunk.snapenhance.core.util.snap
</a><a href="#h270-0-1" id="h270-0-1" class="d">-
</a><a href="#h270-0-2" id="h270-0-2" class="d">-import me.rhunk.snapenhance.core.download.data.SplitMediaAssetType
</a><a href="#h270-0-3" id="h270-0-3" class="d">-import me.rhunk.snapenhance.data.FileType
</a><a href="#h270-0-4" id="h270-0-4" class="d">-import java.io.BufferedInputStream
</a><a href="#h270-0-5" id="h270-0-5" class="d">-import java.io.InputStream
</a><a href="#h270-0-6" id="h270-0-6" class="d">-import java.util.zip.ZipEntry
</a><a href="#h270-0-7" id="h270-0-7" class="d">-import java.util.zip.ZipInputStream
</a><a href="#h270-0-8" id="h270-0-8" class="d">-
</a><a href="#h270-0-9" id="h270-0-9" class="d">-
</a><a href="#h270-0-10" id="h270-0-10" class="d">-object MediaDownloaderHelper {
</a><a href="#h270-0-11" id="h270-0-11" class="d">-    fun getFileType(bufferedInputStream: BufferedInputStream): FileType {
</a><a href="#h270-0-12" id="h270-0-12" class="d">-        val buffer = ByteArray(16)
</a><a href="#h270-0-13" id="h270-0-13" class="d">-        bufferedInputStream.mark(16)
</a><a href="#h270-0-14" id="h270-0-14" class="d">-        bufferedInputStream.read(buffer)
</a><a href="#h270-0-15" id="h270-0-15" class="d">-        bufferedInputStream.reset()
</a><a href="#h270-0-16" id="h270-0-16" class="d">-        return FileType.fromByteArray(buffer)
</a><a href="#h270-0-17" id="h270-0-17" class="d">-    }
</a><a href="#h270-0-18" id="h270-0-18" class="d">-
</a><a href="#h270-0-19" id="h270-0-19" class="d">-
</a><a href="#h270-0-20" id="h270-0-20" class="d">-    fun getSplitElements(
</a><a href="#h270-0-21" id="h270-0-21" class="d">-        inputStream: InputStream,
</a><a href="#h270-0-22" id="h270-0-22" class="d">-        callback: (SplitMediaAssetType, InputStream) -&gt; Unit
</a><a href="#h270-0-23" id="h270-0-23" class="d">-    ) {
</a><a href="#h270-0-24" id="h270-0-24" class="d">-        val bufferedInputStream = BufferedInputStream(inputStream)
</a><a href="#h270-0-25" id="h270-0-25" class="d">-        val fileType = getFileType(bufferedInputStream)
</a><a href="#h270-0-26" id="h270-0-26" class="d">-
</a><a href="#h270-0-27" id="h270-0-27" class="d">-        if (fileType != FileType.ZIP) {
</a><a href="#h270-0-28" id="h270-0-28" class="d">-            callback(SplitMediaAssetType.ORIGINAL, bufferedInputStream)
</a><a href="#h270-0-29" id="h270-0-29" class="d">-            return
</a><a href="#h270-0-30" id="h270-0-30" class="d">-        }
</a><a href="#h270-0-31" id="h270-0-31" class="d">-
</a><a href="#h270-0-32" id="h270-0-32" class="d">-        val zipInputStream = ZipInputStream(bufferedInputStream)
</a><a href="#h270-0-33" id="h270-0-33" class="d">-
</a><a href="#h270-0-34" id="h270-0-34" class="d">-        var entry: ZipEntry? = zipInputStream.nextEntry
</a><a href="#h270-0-35" id="h270-0-35" class="d">-        while (entry != null) {
</a><a href="#h270-0-36" id="h270-0-36" class="d">-            if (entry.name.startsWith(&quot;overlay&quot;)) {
</a><a href="#h270-0-37" id="h270-0-37" class="d">-                callback(SplitMediaAssetType.OVERLAY, zipInputStream)
</a><a href="#h270-0-38" id="h270-0-38" class="d">-            } else if (entry.name.startsWith(&quot;media&quot;)) {
</a><a href="#h270-0-39" id="h270-0-39" class="d">-                callback(SplitMediaAssetType.ORIGINAL, zipInputStream)
</a><a href="#h270-0-40" id="h270-0-40" class="d">-            }
</a><a href="#h270-0-41" id="h270-0-41" class="d">-            entry = zipInputStream.nextEntry
</a><a href="#h270-0-42" id="h270-0-42" class="d">-        }
</a><a href="#h270-0-43" id="h270-0-43" class="d">-    }
</a><a href="#h270-0-44" id="h270-0-44" class="d">-}</a><a href="#h270-0-45" id="h270-0-45" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h271" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/util/snap/PreviewUtils.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/util/snap/PreviewUtils.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/util/snap/PreviewUtils.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/util/snap/PreviewUtils.kt</a></b>
<a href="#h271-0" id="h271-0" class="h">@@ -1,87 +0,0 @@
</a><a href="#h271-0-0" id="h271-0-0" class="d">-package me.rhunk.snapenhance.core.util.snap
</a><a href="#h271-0-1" id="h271-0-1" class="d">-
</a><a href="#h271-0-2" id="h271-0-2" class="d">-import android.graphics.Bitmap
</a><a href="#h271-0-3" id="h271-0-3" class="d">-import android.graphics.BitmapFactory
</a><a href="#h271-0-4" id="h271-0-4" class="d">-import android.graphics.Canvas
</a><a href="#h271-0-5" id="h271-0-5" class="d">-import android.graphics.Matrix
</a><a href="#h271-0-6" id="h271-0-6" class="d">-import android.media.MediaDataSource
</a><a href="#h271-0-7" id="h271-0-7" class="d">-import android.media.MediaMetadataRetriever
</a><a href="#h271-0-8" id="h271-0-8" class="d">-import me.rhunk.snapenhance.data.FileType
</a><a href="#h271-0-9" id="h271-0-9" class="d">-import java.io.File
</a><a href="#h271-0-10" id="h271-0-10" class="d">-
</a><a href="#h271-0-11" id="h271-0-11" class="d">-object PreviewUtils {
</a><a href="#h271-0-12" id="h271-0-12" class="d">-    fun createPreview(data: ByteArray, isVideo: Boolean): Bitmap? {
</a><a href="#h271-0-13" id="h271-0-13" class="d">-        if (!isVideo) {
</a><a href="#h271-0-14" id="h271-0-14" class="d">-            return BitmapFactory.decodeByteArray(data, 0, data.size)
</a><a href="#h271-0-15" id="h271-0-15" class="d">-        }
</a><a href="#h271-0-16" id="h271-0-16" class="d">-        return MediaMetadataRetriever().apply {
</a><a href="#h271-0-17" id="h271-0-17" class="d">-            setDataSource(object : MediaDataSource() {
</a><a href="#h271-0-18" id="h271-0-18" class="d">-                override fun readAt(
</a><a href="#h271-0-19" id="h271-0-19" class="d">-                    position: Long,
</a><a href="#h271-0-20" id="h271-0-20" class="d">-                    buffer: ByteArray,
</a><a href="#h271-0-21" id="h271-0-21" class="d">-                    offset: Int,
</a><a href="#h271-0-22" id="h271-0-22" class="d">-                    size: Int
</a><a href="#h271-0-23" id="h271-0-23" class="d">-                ): Int {
</a><a href="#h271-0-24" id="h271-0-24" class="d">-                    var newSize = size
</a><a href="#h271-0-25" id="h271-0-25" class="d">-                    val length = data.size
</a><a href="#h271-0-26" id="h271-0-26" class="d">-                    if (position &gt;= length) {
</a><a href="#h271-0-27" id="h271-0-27" class="d">-                        return -1
</a><a href="#h271-0-28" id="h271-0-28" class="d">-                    }
</a><a href="#h271-0-29" id="h271-0-29" class="d">-                    if (position + newSize &gt; length) {
</a><a href="#h271-0-30" id="h271-0-30" class="d">-                        newSize = length - position.toInt()
</a><a href="#h271-0-31" id="h271-0-31" class="d">-                    }
</a><a href="#h271-0-32" id="h271-0-32" class="d">-                    System.arraycopy(data, position.toInt(), buffer, offset, newSize)
</a><a href="#h271-0-33" id="h271-0-33" class="d">-                    return newSize
</a><a href="#h271-0-34" id="h271-0-34" class="d">-                }
</a><a href="#h271-0-35" id="h271-0-35" class="d">-
</a><a href="#h271-0-36" id="h271-0-36" class="d">-                override fun getSize(): Long {
</a><a href="#h271-0-37" id="h271-0-37" class="d">-                    return data.size.toLong()
</a><a href="#h271-0-38" id="h271-0-38" class="d">-                }
</a><a href="#h271-0-39" id="h271-0-39" class="d">-                override fun close() {}
</a><a href="#h271-0-40" id="h271-0-40" class="d">-            })
</a><a href="#h271-0-41" id="h271-0-41" class="d">-        }.getFrameAtTime(0, MediaMetadataRetriever.OPTION_CLOSEST_SYNC)
</a><a href="#h271-0-42" id="h271-0-42" class="d">-    }
</a><a href="#h271-0-43" id="h271-0-43" class="d">-
</a><a href="#h271-0-44" id="h271-0-44" class="d">-    fun createPreviewFromFile(file: File): Bitmap? {
</a><a href="#h271-0-45" id="h271-0-45" class="d">-        return if (FileType.fromFile(file).isVideo) {
</a><a href="#h271-0-46" id="h271-0-46" class="d">-            MediaMetadataRetriever().apply {
</a><a href="#h271-0-47" id="h271-0-47" class="d">-                setDataSource(file.absolutePath)
</a><a href="#h271-0-48" id="h271-0-48" class="d">-            }.getFrameAtTime(0, MediaMetadataRetriever.OPTION_CLOSEST_SYNC)
</a><a href="#h271-0-49" id="h271-0-49" class="d">-        } else {
</a><a href="#h271-0-50" id="h271-0-50" class="d">-            BitmapFactory.decodeFile(file.absolutePath, BitmapFactory.Options())
</a><a href="#h271-0-51" id="h271-0-51" class="d">-        }
</a><a href="#h271-0-52" id="h271-0-52" class="d">-    }
</a><a href="#h271-0-53" id="h271-0-53" class="d">-
</a><a href="#h271-0-54" id="h271-0-54" class="d">-    private fun resizeBitmap(bitmap: Bitmap, outWidth: Int, outHeight: Int): Bitmap? {
</a><a href="#h271-0-55" id="h271-0-55" class="d">-        val scaleWidth = outWidth.toFloat() / bitmap.width
</a><a href="#h271-0-56" id="h271-0-56" class="d">-        val scaleHeight = outHeight.toFloat() / bitmap.height
</a><a href="#h271-0-57" id="h271-0-57" class="d">-        val matrix = Matrix()
</a><a href="#h271-0-58" id="h271-0-58" class="d">-        matrix.postScale(scaleWidth, scaleHeight)
</a><a href="#h271-0-59" id="h271-0-59" class="d">-        val resizedBitmap = Bitmap.createBitmap(bitmap, 0, 0, bitmap.width, bitmap.height, matrix, false)
</a><a href="#h271-0-60" id="h271-0-60" class="d">-        bitmap.recycle()
</a><a href="#h271-0-61" id="h271-0-61" class="d">-        return resizedBitmap
</a><a href="#h271-0-62" id="h271-0-62" class="d">-    }
</a><a href="#h271-0-63" id="h271-0-63" class="d">-
</a><a href="#h271-0-64" id="h271-0-64" class="d">-    fun mergeBitmapOverlay(originalMedia: Bitmap, overlayLayer: Bitmap): Bitmap {
</a><a href="#h271-0-65" id="h271-0-65" class="d">-        val biggestBitmap = if (originalMedia.width * originalMedia.height &gt; overlayLayer.width * overlayLayer.height) originalMedia else overlayLayer
</a><a href="#h271-0-66" id="h271-0-66" class="d">-        val smallestBitmap = if (biggestBitmap == originalMedia) overlayLayer else originalMedia
</a><a href="#h271-0-67" id="h271-0-67" class="d">-
</a><a href="#h271-0-68" id="h271-0-68" class="d">-        val mergedBitmap = Bitmap.createBitmap(biggestBitmap.width, biggestBitmap.height, biggestBitmap.config)
</a><a href="#h271-0-69" id="h271-0-69" class="d">-
</a><a href="#h271-0-70" id="h271-0-70" class="d">-        with(Canvas(mergedBitmap)) {
</a><a href="#h271-0-71" id="h271-0-71" class="d">-            val scaleMatrix = Matrix().apply {
</a><a href="#h271-0-72" id="h271-0-72" class="d">-                postScale(biggestBitmap.width.toFloat() / smallestBitmap.width.toFloat(), biggestBitmap.height.toFloat() / smallestBitmap.height.toFloat())
</a><a href="#h271-0-73" id="h271-0-73" class="d">-            }
</a><a href="#h271-0-74" id="h271-0-74" class="d">-
</a><a href="#h271-0-75" id="h271-0-75" class="d">-            if (biggestBitmap == originalMedia) {
</a><a href="#h271-0-76" id="h271-0-76" class="d">-                drawBitmap(originalMedia, 0f, 0f, null)
</a><a href="#h271-0-77" id="h271-0-77" class="d">-                drawBitmap(overlayLayer, scaleMatrix, null)
</a><a href="#h271-0-78" id="h271-0-78" class="d">-            } else {
</a><a href="#h271-0-79" id="h271-0-79" class="d">-                drawBitmap(originalMedia, scaleMatrix, null)
</a><a href="#h271-0-80" id="h271-0-80" class="d">-                drawBitmap(overlayLayer, 0f, 0f, null)
</a><a href="#h271-0-81" id="h271-0-81" class="d">-            }
</a><a href="#h271-0-82" id="h271-0-82" class="d">-        }
</a><a href="#h271-0-83" id="h271-0-83" class="d">-
</a><a href="#h271-0-84" id="h271-0-84" class="d">-        return mergedBitmap
</a><a href="#h271-0-85" id="h271-0-85" class="d">-    }
</a><a href="#h271-0-86" id="h271-0-86" class="d">-}
</a><b>diff --git a/<a id="h272" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/util/snap/SnapWidgetBroadcastReceiverHelper.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/util/snap/SnapWidgetBroadcastReceiverHelper.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/util/snap/SnapWidgetBroadcastReceiverHelper.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/util/snap/SnapWidgetBroadcastReceiverHelper.kt</a></b>
<a href="#h272-0" id="h272-0" class="h">@@ -1,24 +0,0 @@
</a><a href="#h272-0-0" id="h272-0-0" class="d">-package me.rhunk.snapenhance.core.util.snap
</a><a href="#h272-0-1" id="h272-0-1" class="d">-
</a><a href="#h272-0-2" id="h272-0-2" class="d">-import android.content.Intent
</a><a href="#h272-0-3" id="h272-0-3" class="d">-import me.rhunk.snapenhance.Constants
</a><a href="#h272-0-4" id="h272-0-4" class="d">-
</a><a href="#h272-0-5" id="h272-0-5" class="d">-object SnapWidgetBroadcastReceiverHelper {
</a><a href="#h272-0-6" id="h272-0-6" class="d">-    private const val ACTION_WIDGET_UPDATE = &quot;com.snap.android.WIDGET_APP_START_UPDATE_ACTION&quot;
</a><a href="#h272-0-7" id="h272-0-7" class="d">-    const val CLASS_NAME = &quot;com.snap.widgets.core.BestFriendsWidgetProvider&quot;
</a><a href="#h272-0-8" id="h272-0-8" class="d">-
</a><a href="#h272-0-9" id="h272-0-9" class="d">-    fun create(targetAction: String, callback: Intent.() -&gt; Unit): Intent {
</a><a href="#h272-0-10" id="h272-0-10" class="d">-        with(Intent()) {
</a><a href="#h272-0-11" id="h272-0-11" class="d">-            callback(this)
</a><a href="#h272-0-12" id="h272-0-12" class="d">-            action = ACTION_WIDGET_UPDATE
</a><a href="#h272-0-13" id="h272-0-13" class="d">-            putExtra(&quot;:)&quot;, true)
</a><a href="#h272-0-14" id="h272-0-14" class="d">-            putExtra(&quot;action&quot;, targetAction)
</a><a href="#h272-0-15" id="h272-0-15" class="d">-            setClassName(Constants.SNAPCHAT_PACKAGE_NAME, CLASS_NAME)
</a><a href="#h272-0-16" id="h272-0-16" class="d">-            return this
</a><a href="#h272-0-17" id="h272-0-17" class="d">-        }
</a><a href="#h272-0-18" id="h272-0-18" class="d">-    }
</a><a href="#h272-0-19" id="h272-0-19" class="d">-
</a><a href="#h272-0-20" id="h272-0-20" class="d">-    fun isIncomingIntentValid(intent: Intent): Boolean {
</a><a href="#h272-0-21" id="h272-0-21" class="d">-        return intent.action == ACTION_WIDGET_UPDATE &amp;&amp; intent.getBooleanExtra(&quot;:)&quot;, false)
</a><a href="#h272-0-22" id="h272-0-22" class="d">-    }
</a><a href="#h272-0-23" id="h272-0-23" class="d">-}</a><a href="#h272-0-24" id="h272-0-24" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h273" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/wrapper/AbstractWrapper.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/wrapper/AbstractWrapper.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/wrapper/AbstractWrapper.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/wrapper/AbstractWrapper.kt</a></b>
<a href="#h273-0" id="h273-0" class="h">@@ -0,0 +1,46 @@
</a><a href="#h273-0-0" id="h273-0-0" class="i">+package me.rhunk.snapenhance.core.wrapper
</a><a href="#h273-0-1" id="h273-0-1" class="i">+
</a><a href="#h273-0-2" id="h273-0-2" class="i">+import de.robv.android.xposed.XposedHelpers
</a><a href="#h273-0-3" id="h273-0-3" class="i">+import me.rhunk.snapenhance.core.util.CallbackBuilder
</a><a href="#h273-0-4" id="h273-0-4" class="i">+import kotlin.reflect.KProperty
</a><a href="#h273-0-5" id="h273-0-5" class="i">+
</a><a href="#h273-0-6" id="h273-0-6" class="i">+abstract class AbstractWrapper(
</a><a href="#h273-0-7" id="h273-0-7" class="i">+    protected var instance: Any?
</a><a href="#h273-0-8" id="h273-0-8" class="i">+) {
</a><a href="#h273-0-9" id="h273-0-9" class="i">+    @Suppress(&quot;UNCHECKED_CAST&quot;)
</a><a href="#h273-0-10" id="h273-0-10" class="i">+    inner class EnumAccessor&lt;T&gt;(private val fieldName: String, private val defaultValue: T) {
</a><a href="#h273-0-11" id="h273-0-11" class="i">+        operator fun getValue(obj: Any, property: KProperty&lt;*&gt;): T? = getEnumValue(fieldName, defaultValue as Enum&lt;*&gt;) as? T
</a><a href="#h273-0-12" id="h273-0-12" class="i">+        operator fun setValue(obj: Any, property: KProperty&lt;*&gt;, value: Any?) = setEnumValue(fieldName, value as Enum&lt;*&gt;)
</a><a href="#h273-0-13" id="h273-0-13" class="i">+    }
</a><a href="#h273-0-14" id="h273-0-14" class="i">+
</a><a href="#h273-0-15" id="h273-0-15" class="i">+    companion object {
</a><a href="#h273-0-16" id="h273-0-16" class="i">+        fun newEmptyInstance(clazz: Class&lt;*&gt;): Any {
</a><a href="#h273-0-17" id="h273-0-17" class="i">+            return CallbackBuilder.createEmptyObject(clazz.constructors[0]) ?: throw NullPointerException()
</a><a href="#h273-0-18" id="h273-0-18" class="i">+        }
</a><a href="#h273-0-19" id="h273-0-19" class="i">+    }
</a><a href="#h273-0-20" id="h273-0-20" class="i">+
</a><a href="#h273-0-21" id="h273-0-21" class="i">+    fun instanceNonNull(): Any = instance!!
</a><a href="#h273-0-22" id="h273-0-22" class="i">+    fun isPresent(): Boolean = instance != null
</a><a href="#h273-0-23" id="h273-0-23" class="i">+
</a><a href="#h273-0-24" id="h273-0-24" class="i">+    override fun hashCode(): Int {
</a><a href="#h273-0-25" id="h273-0-25" class="i">+        return instance.hashCode()
</a><a href="#h273-0-26" id="h273-0-26" class="i">+    }
</a><a href="#h273-0-27" id="h273-0-27" class="i">+
</a><a href="#h273-0-28" id="h273-0-28" class="i">+    override fun toString(): String {
</a><a href="#h273-0-29" id="h273-0-29" class="i">+        return instance.toString()
</a><a href="#h273-0-30" id="h273-0-30" class="i">+    }
</a><a href="#h273-0-31" id="h273-0-31" class="i">+
</a><a href="#h273-0-32" id="h273-0-32" class="i">+    protected fun &lt;T&gt; enum(fieldName: String, defaultValue: T) = EnumAccessor(fieldName, defaultValue)
</a><a href="#h273-0-33" id="h273-0-33" class="i">+
</a><a href="#h273-0-34" id="h273-0-34" class="i">+    fun &lt;T : Enum&lt;*&gt;&gt; getEnumValue(fieldName: String, defaultValue: T?): T? {
</a><a href="#h273-0-35" id="h273-0-35" class="i">+        if (defaultValue == null) return null
</a><a href="#h273-0-36" id="h273-0-36" class="i">+        val mContentType = XposedHelpers.getObjectField(instance, fieldName) as? Enum&lt;*&gt; ?: return null
</a><a href="#h273-0-37" id="h273-0-37" class="i">+        return java.lang.Enum.valueOf(defaultValue::class.java, mContentType.name)
</a><a href="#h273-0-38" id="h273-0-38" class="i">+    }
</a><a href="#h273-0-39" id="h273-0-39" class="i">+
</a><a href="#h273-0-40" id="h273-0-40" class="i">+    @Suppress(&quot;UNCHECKED_CAST&quot;)
</a><a href="#h273-0-41" id="h273-0-41" class="i">+    fun setEnumValue(fieldName: String, value: Enum&lt;*&gt;) {
</a><a href="#h273-0-42" id="h273-0-42" class="i">+        val type = instance!!.javaClass.declaredFields.find { it.name == fieldName }?.type as Class&lt;out Enum&lt;*&gt;&gt;
</a><a href="#h273-0-43" id="h273-0-43" class="i">+        XposedHelpers.setObjectField(instance, fieldName, java.lang.Enum.valueOf(type, value.name))
</a><a href="#h273-0-44" id="h273-0-44" class="i">+    }
</a><a href="#h273-0-45" id="h273-0-45" class="i">+}</a><a href="#h273-0-46" id="h273-0-46" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h274" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/wrapper/impl/FriendActionButton.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/wrapper/impl/FriendActionButton.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/wrapper/impl/FriendActionButton.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/wrapper/impl/FriendActionButton.kt</a></b>
<a href="#h274-0" id="h274-0" class="h">@@ -0,0 +1,38 @@
</a><a href="#h274-0-0" id="h274-0-0" class="i">+package me.rhunk.snapenhance.core.wrapper.impl
</a><a href="#h274-0-1" id="h274-0-1" class="i">+
</a><a href="#h274-0-2" id="h274-0-2" class="i">+import android.content.Context
</a><a href="#h274-0-3" id="h274-0-3" class="i">+import android.graphics.drawable.Drawable
</a><a href="#h274-0-4" id="h274-0-4" class="i">+import android.util.AttributeSet
</a><a href="#h274-0-5" id="h274-0-5" class="i">+import android.view.View
</a><a href="#h274-0-6" id="h274-0-6" class="i">+import me.rhunk.snapenhance.core.SnapEnhance
</a><a href="#h274-0-7" id="h274-0-7" class="i">+import me.rhunk.snapenhance.core.wrapper.AbstractWrapper
</a><a href="#h274-0-8" id="h274-0-8" class="i">+
</a><a href="#h274-0-9" id="h274-0-9" class="i">+class FriendActionButton(
</a><a href="#h274-0-10" id="h274-0-10" class="i">+    obj: View
</a><a href="#h274-0-11" id="h274-0-11" class="i">+) : AbstractWrapper(obj) {
</a><a href="#h274-0-12" id="h274-0-12" class="i">+    private val iconDrawableContainer by lazy {
</a><a href="#h274-0-13" id="h274-0-13" class="i">+        instanceNonNull().javaClass.declaredFields.first { it.type != Int::class.javaPrimitiveType }[instanceNonNull()]
</a><a href="#h274-0-14" id="h274-0-14" class="i">+    }
</a><a href="#h274-0-15" id="h274-0-15" class="i">+
</a><a href="#h274-0-16" id="h274-0-16" class="i">+    private val setIconDrawableMethod by lazy {
</a><a href="#h274-0-17" id="h274-0-17" class="i">+        iconDrawableContainer.javaClass.declaredMethods.first {
</a><a href="#h274-0-18" id="h274-0-18" class="i">+            it.parameterTypes.size == 1 &amp;&amp;
</a><a href="#h274-0-19" id="h274-0-19" class="i">+                    it.parameterTypes[0] == Drawable::class.java &amp;&amp;
</a><a href="#h274-0-20" id="h274-0-20" class="i">+                    it.name != &quot;invalidateDrawable&quot; &amp;&amp;
</a><a href="#h274-0-21" id="h274-0-21" class="i">+                    it.returnType == Void::class.javaPrimitiveType
</a><a href="#h274-0-22" id="h274-0-22" class="i">+        }
</a><a href="#h274-0-23" id="h274-0-23" class="i">+    }
</a><a href="#h274-0-24" id="h274-0-24" class="i">+
</a><a href="#h274-0-25" id="h274-0-25" class="i">+    fun setIconDrawable(drawable: Drawable) {
</a><a href="#h274-0-26" id="h274-0-26" class="i">+        setIconDrawableMethod.invoke(iconDrawableContainer, drawable)
</a><a href="#h274-0-27" id="h274-0-27" class="i">+    }
</a><a href="#h274-0-28" id="h274-0-28" class="i">+
</a><a href="#h274-0-29" id="h274-0-29" class="i">+    companion object {
</a><a href="#h274-0-30" id="h274-0-30" class="i">+        fun new(context: Context): FriendActionButton {
</a><a href="#h274-0-31" id="h274-0-31" class="i">+            val instance = SnapEnhance.classLoader.loadClass(&quot;com.snap.profile.shared.view.FriendActionButton&quot;)
</a><a href="#h274-0-32" id="h274-0-32" class="i">+                .getConstructor(Context::class.java, AttributeSet::class.java)
</a><a href="#h274-0-33" id="h274-0-33" class="i">+                .newInstance(context, null) as View
</a><a href="#h274-0-34" id="h274-0-34" class="i">+            return FriendActionButton(instance)
</a><a href="#h274-0-35" id="h274-0-35" class="i">+        }
</a><a href="#h274-0-36" id="h274-0-36" class="i">+    }
</a><a href="#h274-0-37" id="h274-0-37" class="i">+}</a><a href="#h274-0-38" id="h274-0-38" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h275" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/wrapper/impl/Message.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/wrapper/impl/Message.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/wrapper/impl/Message.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/wrapper/impl/Message.kt</a></b>
<a href="#h275-0" id="h275-0" class="h">@@ -0,0 +1,14 @@
</a><a href="#h275-0-0" id="h275-0-0" class="i">+package me.rhunk.snapenhance.core.wrapper.impl
</a><a href="#h275-0-1" id="h275-0-1" class="i">+
</a><a href="#h275-0-2" id="h275-0-2" class="i">+import me.rhunk.snapenhance.common.data.MessageState
</a><a href="#h275-0-3" id="h275-0-3" class="i">+import me.rhunk.snapenhance.core.util.ktx.getObjectField
</a><a href="#h275-0-4" id="h275-0-4" class="i">+import me.rhunk.snapenhance.core.wrapper.AbstractWrapper
</a><a href="#h275-0-5" id="h275-0-5" class="i">+
</a><a href="#h275-0-6" id="h275-0-6" class="i">+class Message(obj: Any?) : AbstractWrapper(obj) {
</a><a href="#h275-0-7" id="h275-0-7" class="i">+    val orderKey get() = instanceNonNull().getObjectField(&quot;mOrderKey&quot;) as Long
</a><a href="#h275-0-8" id="h275-0-8" class="i">+    val senderId get() = SnapUUID(instanceNonNull().getObjectField(&quot;mSenderId&quot;))
</a><a href="#h275-0-9" id="h275-0-9" class="i">+    val messageContent get() = MessageContent(instanceNonNull().getObjectField(&quot;mMessageContent&quot;))
</a><a href="#h275-0-10" id="h275-0-10" class="i">+    val messageDescriptor get() = MessageDescriptor(instanceNonNull().getObjectField(&quot;mDescriptor&quot;))
</a><a href="#h275-0-11" id="h275-0-11" class="i">+    val messageMetadata get() = MessageMetadata(instanceNonNull().getObjectField(&quot;mMetadata&quot;))
</a><a href="#h275-0-12" id="h275-0-12" class="i">+    var messageState by enum(&quot;mState&quot;, MessageState.COMMITTED)
</a><a href="#h275-0-13" id="h275-0-13" class="i">+}</a><a href="#h275-0-14" id="h275-0-14" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h276" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/wrapper/impl/MessageContent.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/wrapper/impl/MessageContent.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/wrapper/impl/MessageContent.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/wrapper/impl/MessageContent.kt</a></b>
<a href="#h276-0" id="h276-0" class="h">@@ -0,0 +1,13 @@
</a><a href="#h276-0-0" id="h276-0-0" class="i">+package me.rhunk.snapenhance.core.wrapper.impl
</a><a href="#h276-0-1" id="h276-0-1" class="i">+
</a><a href="#h276-0-2" id="h276-0-2" class="i">+import me.rhunk.snapenhance.common.data.ContentType
</a><a href="#h276-0-3" id="h276-0-3" class="i">+import me.rhunk.snapenhance.core.util.ktx.getObjectField
</a><a href="#h276-0-4" id="h276-0-4" class="i">+import me.rhunk.snapenhance.core.util.ktx.setObjectField
</a><a href="#h276-0-5" id="h276-0-5" class="i">+import me.rhunk.snapenhance.core.wrapper.AbstractWrapper
</a><a href="#h276-0-6" id="h276-0-6" class="i">+
</a><a href="#h276-0-7" id="h276-0-7" class="i">+class MessageContent(obj: Any?) : AbstractWrapper(obj) {
</a><a href="#h276-0-8" id="h276-0-8" class="i">+    var content
</a><a href="#h276-0-9" id="h276-0-9" class="i">+        get() = instanceNonNull().getObjectField(&quot;mContent&quot;) as ByteArray
</a><a href="#h276-0-10" id="h276-0-10" class="i">+        set(value) = instanceNonNull().setObjectField(&quot;mContent&quot;, value)
</a><a href="#h276-0-11" id="h276-0-11" class="i">+    var contentType by enum(&quot;mContentType&quot;, ContentType.UNKNOWN)
</a><a href="#h276-0-12" id="h276-0-12" class="i">+}</a><a href="#h276-0-13" id="h276-0-13" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h277" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/wrapper/impl/MessageDescriptor.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/wrapper/impl/MessageDescriptor.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/wrapper/impl/MessageDescriptor.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/wrapper/impl/MessageDescriptor.kt</a></b>
<a href="#h277-0" id="h277-0" class="h">@@ -0,0 +1,9 @@
</a><a href="#h277-0-0" id="h277-0-0" class="i">+package me.rhunk.snapenhance.core.wrapper.impl
</a><a href="#h277-0-1" id="h277-0-1" class="i">+
</a><a href="#h277-0-2" id="h277-0-2" class="i">+import me.rhunk.snapenhance.core.util.ktx.getObjectField
</a><a href="#h277-0-3" id="h277-0-3" class="i">+import me.rhunk.snapenhance.core.wrapper.AbstractWrapper
</a><a href="#h277-0-4" id="h277-0-4" class="i">+
</a><a href="#h277-0-5" id="h277-0-5" class="i">+class MessageDescriptor(obj: Any?) : AbstractWrapper(obj) {
</a><a href="#h277-0-6" id="h277-0-6" class="i">+    val messageId: Long get() = instanceNonNull().getObjectField(&quot;mMessageId&quot;) as Long
</a><a href="#h277-0-7" id="h277-0-7" class="i">+    val conversationId: SnapUUID get() = SnapUUID(instanceNonNull().getObjectField(&quot;mConversationId&quot;)!!)
</a><a href="#h277-0-8" id="h277-0-8" class="i">+}</a><a href="#h277-0-9" id="h277-0-9" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h278" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/wrapper/impl/MessageDestinations.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/wrapper/impl/MessageDestinations.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/wrapper/impl/MessageDestinations.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/wrapper/impl/MessageDestinations.kt</a></b>
<a href="#h278-0" id="h278-0" class="h">@@ -0,0 +1,15 @@
</a><a href="#h278-0-0" id="h278-0-0" class="i">+package me.rhunk.snapenhance.core.wrapper.impl
</a><a href="#h278-0-1" id="h278-0-1" class="i">+
</a><a href="#h278-0-2" id="h278-0-2" class="i">+import me.rhunk.snapenhance.core.util.ktx.getObjectField
</a><a href="#h278-0-3" id="h278-0-3" class="i">+import me.rhunk.snapenhance.core.util.ktx.setObjectField
</a><a href="#h278-0-4" id="h278-0-4" class="i">+import me.rhunk.snapenhance.core.wrapper.AbstractWrapper
</a><a href="#h278-0-5" id="h278-0-5" class="i">+
</a><a href="#h278-0-6" id="h278-0-6" class="i">+@Suppress(&quot;UNCHECKED_CAST&quot;)
</a><a href="#h278-0-7" id="h278-0-7" class="i">+class MessageDestinations(obj: Any) : AbstractWrapper(obj){
</a><a href="#h278-0-8" id="h278-0-8" class="i">+    var conversations get() = (instanceNonNull().getObjectField(&quot;mConversations&quot;) as ArrayList&lt;*&gt;).map { SnapUUID(it) }
</a><a href="#h278-0-9" id="h278-0-9" class="i">+        set(value) = instanceNonNull().setObjectField(&quot;mConversations&quot;, value.map { it.instanceNonNull() }.toCollection(ArrayList()))
</a><a href="#h278-0-10" id="h278-0-10" class="i">+    var stories get() = instanceNonNull().getObjectField(&quot;mStories&quot;) as ArrayList&lt;Any&gt;
</a><a href="#h278-0-11" id="h278-0-11" class="i">+        set(value) = instanceNonNull().setObjectField(&quot;mStories&quot;, value)
</a><a href="#h278-0-12" id="h278-0-12" class="i">+    var mPhoneNumbers get() = instanceNonNull().getObjectField(&quot;mPhoneNumbers&quot;) as ArrayList&lt;Any&gt;
</a><a href="#h278-0-13" id="h278-0-13" class="i">+        set(value) = instanceNonNull().setObjectField(&quot;mPhoneNumbers&quot;, value)
</a><a href="#h278-0-14" id="h278-0-14" class="i">+}</a><a href="#h278-0-15" id="h278-0-15" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h279" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/wrapper/impl/MessageMetadata.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/wrapper/impl/MessageMetadata.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/wrapper/impl/MessageMetadata.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/wrapper/impl/MessageMetadata.kt</a></b>
<a href="#h279-0" id="h279-0" class="h">@@ -0,0 +1,28 @@
</a><a href="#h279-0-0" id="h279-0-0" class="i">+package me.rhunk.snapenhance.core.wrapper.impl
</a><a href="#h279-0-1" id="h279-0-1" class="i">+
</a><a href="#h279-0-2" id="h279-0-2" class="i">+import me.rhunk.snapenhance.common.data.PlayableSnapState
</a><a href="#h279-0-3" id="h279-0-3" class="i">+import me.rhunk.snapenhance.core.util.ktx.getObjectField
</a><a href="#h279-0-4" id="h279-0-4" class="i">+import me.rhunk.snapenhance.core.wrapper.AbstractWrapper
</a><a href="#h279-0-5" id="h279-0-5" class="i">+
</a><a href="#h279-0-6" id="h279-0-6" class="i">+class MessageMetadata(obj: Any?) : AbstractWrapper(obj){
</a><a href="#h279-0-7" id="h279-0-7" class="i">+    val createdAt: Long get() = instanceNonNull().getObjectField(&quot;mCreatedAt&quot;) as Long
</a><a href="#h279-0-8" id="h279-0-8" class="i">+    val readAt: Long get() = instanceNonNull().getObjectField(&quot;mReadAt&quot;) as Long
</a><a href="#h279-0-9" id="h279-0-9" class="i">+    var playableSnapState by enum(&quot;mPlayableSnapState&quot;, PlayableSnapState.PLAYABLE)
</a><a href="#h279-0-10" id="h279-0-10" class="i">+
</a><a href="#h279-0-11" id="h279-0-11" class="i">+    private fun getUUIDList(name: String): List&lt;SnapUUID&gt; {
</a><a href="#h279-0-12" id="h279-0-12" class="i">+        return (instanceNonNull().getObjectField(name) as List&lt;*&gt;).map { SnapUUID(it!!) }
</a><a href="#h279-0-13" id="h279-0-13" class="i">+    }
</a><a href="#h279-0-14" id="h279-0-14" class="i">+
</a><a href="#h279-0-15" id="h279-0-15" class="i">+    val savedBy: List&lt;SnapUUID&gt; by lazy {
</a><a href="#h279-0-16" id="h279-0-16" class="i">+        getUUIDList(&quot;mSavedBy&quot;)
</a><a href="#h279-0-17" id="h279-0-17" class="i">+    }
</a><a href="#h279-0-18" id="h279-0-18" class="i">+    val openedBy: List&lt;SnapUUID&gt; by lazy {
</a><a href="#h279-0-19" id="h279-0-19" class="i">+        getUUIDList(&quot;mOpenedBy&quot;)
</a><a href="#h279-0-20" id="h279-0-20" class="i">+    }
</a><a href="#h279-0-21" id="h279-0-21" class="i">+    val seenBy: List&lt;SnapUUID&gt; by lazy {
</a><a href="#h279-0-22" id="h279-0-22" class="i">+        getUUIDList(&quot;mSeenBy&quot;)
</a><a href="#h279-0-23" id="h279-0-23" class="i">+    }
</a><a href="#h279-0-24" id="h279-0-24" class="i">+    val reactions: List&lt;UserIdToReaction&gt; by lazy {
</a><a href="#h279-0-25" id="h279-0-25" class="i">+        (instanceNonNull().getObjectField(&quot;mReactions&quot;) as List&lt;*&gt;).map { UserIdToReaction(it!!) }
</a><a href="#h279-0-26" id="h279-0-26" class="i">+    }
</a><a href="#h279-0-27" id="h279-0-27" class="i">+}</a><a href="#h279-0-28" id="h279-0-28" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h280" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/wrapper/impl/ScSize.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/wrapper/impl/ScSize.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/wrapper/impl/ScSize.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/wrapper/impl/ScSize.kt</a></b>
<a href="#h280-0" id="h280-0" class="h">@@ -0,0 +1,26 @@
</a><a href="#h280-0-0" id="h280-0-0" class="i">+package me.rhunk.snapenhance.core.wrapper.impl
</a><a href="#h280-0-1" id="h280-0-1" class="i">+
</a><a href="#h280-0-2" id="h280-0-2" class="i">+import me.rhunk.snapenhance.core.wrapper.AbstractWrapper
</a><a href="#h280-0-3" id="h280-0-3" class="i">+
</a><a href="#h280-0-4" id="h280-0-4" class="i">+class ScSize(
</a><a href="#h280-0-5" id="h280-0-5" class="i">+    obj: Any?
</a><a href="#h280-0-6" id="h280-0-6" class="i">+) : AbstractWrapper(obj) {
</a><a href="#h280-0-7" id="h280-0-7" class="i">+    private val firstField by lazy {
</a><a href="#h280-0-8" id="h280-0-8" class="i">+        instanceNonNull().javaClass.declaredFields.first { it.type == Int::class.javaPrimitiveType }.also { it.isAccessible = true }
</a><a href="#h280-0-9" id="h280-0-9" class="i">+    }
</a><a href="#h280-0-10" id="h280-0-10" class="i">+
</a><a href="#h280-0-11" id="h280-0-11" class="i">+    private val secondField by lazy {
</a><a href="#h280-0-12" id="h280-0-12" class="i">+        instanceNonNull().javaClass.declaredFields.last { it.type == Int::class.javaPrimitiveType }.also { it.isAccessible = true }
</a><a href="#h280-0-13" id="h280-0-13" class="i">+    }
</a><a href="#h280-0-14" id="h280-0-14" class="i">+
</a><a href="#h280-0-15" id="h280-0-15" class="i">+
</a><a href="#h280-0-16" id="h280-0-16" class="i">+    var first: Int get() = firstField.getInt(instanceNonNull())
</a><a href="#h280-0-17" id="h280-0-17" class="i">+        set(value) {
</a><a href="#h280-0-18" id="h280-0-18" class="i">+            firstField.setInt(instanceNonNull(), value)
</a><a href="#h280-0-19" id="h280-0-19" class="i">+        }
</a><a href="#h280-0-20" id="h280-0-20" class="i">+
</a><a href="#h280-0-21" id="h280-0-21" class="i">+    var second: Int get() = secondField.getInt(instanceNonNull())
</a><a href="#h280-0-22" id="h280-0-22" class="i">+        set(value) {
</a><a href="#h280-0-23" id="h280-0-23" class="i">+            secondField.setInt(instanceNonNull(), value)
</a><a href="#h280-0-24" id="h280-0-24" class="i">+        }
</a><a href="#h280-0-25" id="h280-0-25" class="i">+}</a><a href="#h280-0-26" id="h280-0-26" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h281" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/wrapper/impl/SnapUUID.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/wrapper/impl/SnapUUID.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/wrapper/impl/SnapUUID.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/wrapper/impl/SnapUUID.kt</a></b>
<a href="#h281-0" id="h281-0" class="h">@@ -0,0 +1,44 @@
</a><a href="#h281-0-0" id="h281-0-0" class="i">+package me.rhunk.snapenhance.core.wrapper.impl
</a><a href="#h281-0-1" id="h281-0-1" class="i">+
</a><a href="#h281-0-2" id="h281-0-2" class="i">+import me.rhunk.snapenhance.core.SnapEnhance
</a><a href="#h281-0-3" id="h281-0-3" class="i">+import me.rhunk.snapenhance.core.util.ktx.getObjectField
</a><a href="#h281-0-4" id="h281-0-4" class="i">+import me.rhunk.snapenhance.core.wrapper.AbstractWrapper
</a><a href="#h281-0-5" id="h281-0-5" class="i">+import java.nio.ByteBuffer
</a><a href="#h281-0-6" id="h281-0-6" class="i">+import java.util.UUID
</a><a href="#h281-0-7" id="h281-0-7" class="i">+
</a><a href="#h281-0-8" id="h281-0-8" class="i">+class SnapUUID(obj: Any?) : AbstractWrapper(obj) {
</a><a href="#h281-0-9" id="h281-0-9" class="i">+    private val uuidString by lazy { toUUID().toString() }
</a><a href="#h281-0-10" id="h281-0-10" class="i">+
</a><a href="#h281-0-11" id="h281-0-11" class="i">+    private val bytes: ByteArray get() = instanceNonNull().getObjectField(&quot;mId&quot;) as ByteArray
</a><a href="#h281-0-12" id="h281-0-12" class="i">+
</a><a href="#h281-0-13" id="h281-0-13" class="i">+    private fun toUUID(): UUID {
</a><a href="#h281-0-14" id="h281-0-14" class="i">+        val buffer = ByteBuffer.wrap(bytes)
</a><a href="#h281-0-15" id="h281-0-15" class="i">+        return UUID(buffer.long, buffer.long)
</a><a href="#h281-0-16" id="h281-0-16" class="i">+    }
</a><a href="#h281-0-17" id="h281-0-17" class="i">+
</a><a href="#h281-0-18" id="h281-0-18" class="i">+    override fun toString(): String {
</a><a href="#h281-0-19" id="h281-0-19" class="i">+        return uuidString
</a><a href="#h281-0-20" id="h281-0-20" class="i">+    }
</a><a href="#h281-0-21" id="h281-0-21" class="i">+
</a><a href="#h281-0-22" id="h281-0-22" class="i">+    fun toBytes() = bytes
</a><a href="#h281-0-23" id="h281-0-23" class="i">+
</a><a href="#h281-0-24" id="h281-0-24" class="i">+    override fun equals(other: Any?): Boolean {
</a><a href="#h281-0-25" id="h281-0-25" class="i">+        return other is SnapUUID &amp;&amp; other.uuidString == uuidString
</a><a href="#h281-0-26" id="h281-0-26" class="i">+    }
</a><a href="#h281-0-27" id="h281-0-27" class="i">+
</a><a href="#h281-0-28" id="h281-0-28" class="i">+    companion object {
</a><a href="#h281-0-29" id="h281-0-29" class="i">+        fun fromString(uuid: String): SnapUUID {
</a><a href="#h281-0-30" id="h281-0-30" class="i">+            return fromUUID(UUID.fromString(uuid))
</a><a href="#h281-0-31" id="h281-0-31" class="i">+        }
</a><a href="#h281-0-32" id="h281-0-32" class="i">+        fun fromBytes(bytes: ByteArray): SnapUUID {
</a><a href="#h281-0-33" id="h281-0-33" class="i">+            val constructor = SnapEnhance.classCache.snapUUID.getConstructor(ByteArray::class.java)
</a><a href="#h281-0-34" id="h281-0-34" class="i">+            return SnapUUID(constructor.newInstance(bytes))
</a><a href="#h281-0-35" id="h281-0-35" class="i">+        }
</a><a href="#h281-0-36" id="h281-0-36" class="i">+        fun fromUUID(uuid: UUID): SnapUUID {
</a><a href="#h281-0-37" id="h281-0-37" class="i">+            val buffer = ByteBuffer.allocate(16)
</a><a href="#h281-0-38" id="h281-0-38" class="i">+            buffer.putLong(uuid.mostSignificantBits)
</a><a href="#h281-0-39" id="h281-0-39" class="i">+            buffer.putLong(uuid.leastSignificantBits)
</a><a href="#h281-0-40" id="h281-0-40" class="i">+            return fromBytes(buffer.array())
</a><a href="#h281-0-41" id="h281-0-41" class="i">+        }
</a><a href="#h281-0-42" id="h281-0-42" class="i">+    }
</a><a href="#h281-0-43" id="h281-0-43" class="i">+}
</a><b>diff --git a/<a id="h282" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/wrapper/impl/UserIdToReaction.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/wrapper/impl/UserIdToReaction.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/wrapper/impl/UserIdToReaction.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/wrapper/impl/UserIdToReaction.kt</a></b>
<a href="#h282-0" id="h282-0" class="h">@@ -0,0 +1,11 @@
</a><a href="#h282-0-0" id="h282-0-0" class="i">+package me.rhunk.snapenhance.core.wrapper.impl
</a><a href="#h282-0-1" id="h282-0-1" class="i">+
</a><a href="#h282-0-2" id="h282-0-2" class="i">+import me.rhunk.snapenhance.core.util.ktx.getObjectField
</a><a href="#h282-0-3" id="h282-0-3" class="i">+import me.rhunk.snapenhance.core.wrapper.AbstractWrapper
</a><a href="#h282-0-4" id="h282-0-4" class="i">+
</a><a href="#h282-0-5" id="h282-0-5" class="i">+class UserIdToReaction(obj: Any?) : AbstractWrapper(obj) {
</a><a href="#h282-0-6" id="h282-0-6" class="i">+    val userId = SnapUUID(instanceNonNull().getObjectField(&quot;mUserId&quot;))
</a><a href="#h282-0-7" id="h282-0-7" class="i">+    val reactionId = (instanceNonNull().getObjectField(&quot;mReaction&quot;)
</a><a href="#h282-0-8" id="h282-0-8" class="i">+        ?.getObjectField(&quot;mReactionContent&quot;)
</a><a href="#h282-0-9" id="h282-0-9" class="i">+        ?.getObjectField(&quot;mIntentionType&quot;) as Long?) ?: 0
</a><a href="#h282-0-10" id="h282-0-10" class="i">+}</a><a href="#h282-0-11" id="h282-0-11" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h283" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/wrapper/impl/media/EncryptionWrapper.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/wrapper/impl/media/EncryptionWrapper.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/wrapper/impl/media/EncryptionWrapper.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/wrapper/impl/media/EncryptionWrapper.kt</a></b>
<a href="#h283-0" id="h283-0" class="h">@@ -0,0 +1,81 @@
</a><a href="#h283-0-0" id="h283-0-0" class="i">+package me.rhunk.snapenhance.core.wrapper.impl.media
</a><a href="#h283-0-1" id="h283-0-1" class="i">+
</a><a href="#h283-0-2" id="h283-0-2" class="i">+import me.rhunk.snapenhance.common.data.download.MediaEncryptionKeyPair
</a><a href="#h283-0-3" id="h283-0-3" class="i">+import me.rhunk.snapenhance.core.wrapper.AbstractWrapper
</a><a href="#h283-0-4" id="h283-0-4" class="i">+import java.io.InputStream
</a><a href="#h283-0-5" id="h283-0-5" class="i">+import java.io.OutputStream
</a><a href="#h283-0-6" id="h283-0-6" class="i">+import java.lang.reflect.Field
</a><a href="#h283-0-7" id="h283-0-7" class="i">+import javax.crypto.Cipher
</a><a href="#h283-0-8" id="h283-0-8" class="i">+import javax.crypto.CipherInputStream
</a><a href="#h283-0-9" id="h283-0-9" class="i">+import javax.crypto.CipherOutputStream
</a><a href="#h283-0-10" id="h283-0-10" class="i">+import javax.crypto.spec.IvParameterSpec
</a><a href="#h283-0-11" id="h283-0-11" class="i">+import javax.crypto.spec.SecretKeySpec
</a><a href="#h283-0-12" id="h283-0-12" class="i">+import kotlin.io.encoding.Base64
</a><a href="#h283-0-13" id="h283-0-13" class="i">+import kotlin.io.encoding.ExperimentalEncodingApi
</a><a href="#h283-0-14" id="h283-0-14" class="i">+
</a><a href="#h283-0-15" id="h283-0-15" class="i">+class EncryptionWrapper(instance: Any?) : AbstractWrapper(instance) {
</a><a href="#h283-0-16" id="h283-0-16" class="i">+    fun decrypt(data: ByteArray?): ByteArray {
</a><a href="#h283-0-17" id="h283-0-17" class="i">+        return newCipher(Cipher.DECRYPT_MODE).doFinal(data)
</a><a href="#h283-0-18" id="h283-0-18" class="i">+    }
</a><a href="#h283-0-19" id="h283-0-19" class="i">+
</a><a href="#h283-0-20" id="h283-0-20" class="i">+    fun decrypt(inputStream: InputStream?): InputStream {
</a><a href="#h283-0-21" id="h283-0-21" class="i">+        return CipherInputStream(inputStream, newCipher(Cipher.DECRYPT_MODE))
</a><a href="#h283-0-22" id="h283-0-22" class="i">+    }
</a><a href="#h283-0-23" id="h283-0-23" class="i">+
</a><a href="#h283-0-24" id="h283-0-24" class="i">+    fun decrypt(outputStream: OutputStream?): OutputStream {
</a><a href="#h283-0-25" id="h283-0-25" class="i">+        return CipherOutputStream(outputStream, newCipher(Cipher.DECRYPT_MODE))
</a><a href="#h283-0-26" id="h283-0-26" class="i">+    }
</a><a href="#h283-0-27" id="h283-0-27" class="i">+
</a><a href="#h283-0-28" id="h283-0-28" class="i">+    /**
</a><a href="#h283-0-29" id="h283-0-29" class="i">+     * Search for a byte[] field with the specified length
</a><a href="#h283-0-30" id="h283-0-30" class="i">+     *
</a><a href="#h283-0-31" id="h283-0-31" class="i">+     * @param arrayLength the length of the byte[] field
</a><a href="#h283-0-32" id="h283-0-32" class="i">+     * @return the field
</a><a href="#h283-0-33" id="h283-0-33" class="i">+     */
</a><a href="#h283-0-34" id="h283-0-34" class="i">+    private fun searchByteArrayField(arrayLength: Int): Field {
</a><a href="#h283-0-35" id="h283-0-35" class="i">+        return instanceNonNull()::class.java.fields.first { f -&gt;
</a><a href="#h283-0-36" id="h283-0-36" class="i">+            try {
</a><a href="#h283-0-37" id="h283-0-37" class="i">+                if (!f.type.isArray || f.type
</a><a href="#h283-0-38" id="h283-0-38" class="i">+                        .componentType != Byte::class.javaPrimitiveType
</a><a href="#h283-0-39" id="h283-0-39" class="i">+                ) return@first false
</a><a href="#h283-0-40" id="h283-0-40" class="i">+                return@first (f.get(instanceNonNull()) as ByteArray).size == arrayLength
</a><a href="#h283-0-41" id="h283-0-41" class="i">+            } catch (e: Exception) {
</a><a href="#h283-0-42" id="h283-0-42" class="i">+                return@first false
</a><a href="#h283-0-43" id="h283-0-43" class="i">+            }
</a><a href="#h283-0-44" id="h283-0-44" class="i">+        }
</a><a href="#h283-0-45" id="h283-0-45" class="i">+    }
</a><a href="#h283-0-46" id="h283-0-46" class="i">+
</a><a href="#h283-0-47" id="h283-0-47" class="i">+    /**
</a><a href="#h283-0-48" id="h283-0-48" class="i">+     * Create a new cipher with the specified mode
</a><a href="#h283-0-49" id="h283-0-49" class="i">+     */
</a><a href="#h283-0-50" id="h283-0-50" class="i">+    fun newCipher(mode: Int): Cipher {
</a><a href="#h283-0-51" id="h283-0-51" class="i">+        val cipher = cipher
</a><a href="#h283-0-52" id="h283-0-52" class="i">+        cipher.init(mode, SecretKeySpec(keySpec, &quot;AES&quot;), IvParameterSpec(ivKeyParameterSpec))
</a><a href="#h283-0-53" id="h283-0-53" class="i">+        return cipher
</a><a href="#h283-0-54" id="h283-0-54" class="i">+    }
</a><a href="#h283-0-55" id="h283-0-55" class="i">+
</a><a href="#h283-0-56" id="h283-0-56" class="i">+    /**
</a><a href="#h283-0-57" id="h283-0-57" class="i">+     * Get the cipher from the encryption wrapper
</a><a href="#h283-0-58" id="h283-0-58" class="i">+     */
</a><a href="#h283-0-59" id="h283-0-59" class="i">+    private val cipher: Cipher
</a><a href="#h283-0-60" id="h283-0-60" class="i">+        get() = Cipher.getInstance(&quot;AES/CBC/PKCS5Padding&quot;)
</a><a href="#h283-0-61" id="h283-0-61" class="i">+
</a><a href="#h283-0-62" id="h283-0-62" class="i">+    /**
</a><a href="#h283-0-63" id="h283-0-63" class="i">+     * Get the key spec from the encryption wrapper
</a><a href="#h283-0-64" id="h283-0-64" class="i">+     */
</a><a href="#h283-0-65" id="h283-0-65" class="i">+    val keySpec: ByteArray by lazy {
</a><a href="#h283-0-66" id="h283-0-66" class="i">+        searchByteArrayField(32)[instance] as ByteArray
</a><a href="#h283-0-67" id="h283-0-67" class="i">+    }
</a><a href="#h283-0-68" id="h283-0-68" class="i">+
</a><a href="#h283-0-69" id="h283-0-69" class="i">+    /**
</a><a href="#h283-0-70" id="h283-0-70" class="i">+     * Get the iv key parameter spec from the encryption wrapper
</a><a href="#h283-0-71" id="h283-0-71" class="i">+     */
</a><a href="#h283-0-72" id="h283-0-72" class="i">+    val ivKeyParameterSpec: ByteArray by lazy {
</a><a href="#h283-0-73" id="h283-0-73" class="i">+        searchByteArrayField(16)[instance] as ByteArray
</a><a href="#h283-0-74" id="h283-0-74" class="i">+    }
</a><a href="#h283-0-75" id="h283-0-75" class="i">+}
</a><a href="#h283-0-76" id="h283-0-76" class="i">+
</a><a href="#h283-0-77" id="h283-0-77" class="i">+
</a><a href="#h283-0-78" id="h283-0-78" class="i">+@OptIn(ExperimentalEncodingApi::class)
</a><a href="#h283-0-79" id="h283-0-79" class="i">+fun EncryptionWrapper.toKeyPair()
</a><a href="#h283-0-80" id="h283-0-80" class="i">+        = MediaEncryptionKeyPair(Base64.UrlSafe.encode(this.keySpec), Base64.UrlSafe.encode(this.ivKeyParameterSpec))
</a><b>diff --git a/<a id="h284" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/wrapper/impl/media/MediaInfo.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/wrapper/impl/media/MediaInfo.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/wrapper/impl/media/MediaInfo.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/wrapper/impl/media/MediaInfo.kt</a></b>
<a href="#h284-0" id="h284-0" class="h">@@ -0,0 +1,34 @@
</a><a href="#h284-0-0" id="h284-0-0" class="i">+package me.rhunk.snapenhance.core.wrapper.impl.media
</a><a href="#h284-0-1" id="h284-0-1" class="i">+
</a><a href="#h284-0-2" id="h284-0-2" class="i">+import android.os.Parcelable
</a><a href="#h284-0-3" id="h284-0-3" class="i">+import me.rhunk.snapenhance.core.util.ktx.getObjectField
</a><a href="#h284-0-4" id="h284-0-4" class="i">+import me.rhunk.snapenhance.core.wrapper.AbstractWrapper
</a><a href="#h284-0-5" id="h284-0-5" class="i">+import java.lang.reflect.Field
</a><a href="#h284-0-6" id="h284-0-6" class="i">+
</a><a href="#h284-0-7" id="h284-0-7" class="i">+
</a><a href="#h284-0-8" id="h284-0-8" class="i">+class MediaInfo(obj: Any?) : AbstractWrapper(obj) {
</a><a href="#h284-0-9" id="h284-0-9" class="i">+    val uri: String
</a><a href="#h284-0-10" id="h284-0-10" class="i">+        get() {
</a><a href="#h284-0-11" id="h284-0-11" class="i">+            val firstStringUriField = instanceNonNull().javaClass.fields.first { f: Field -&gt; f.type == String::class.java }
</a><a href="#h284-0-12" id="h284-0-12" class="i">+            return instanceNonNull().getObjectField(firstStringUriField.name) as String
</a><a href="#h284-0-13" id="h284-0-13" class="i">+        }
</a><a href="#h284-0-14" id="h284-0-14" class="i">+
</a><a href="#h284-0-15" id="h284-0-15" class="i">+    init {
</a><a href="#h284-0-16" id="h284-0-16" class="i">+        instance?.let {
</a><a href="#h284-0-17" id="h284-0-17" class="i">+            if (it is List&lt;*&gt;) {
</a><a href="#h284-0-18" id="h284-0-18" class="i">+                if (it.size == 0) {
</a><a href="#h284-0-19" id="h284-0-19" class="i">+                    throw RuntimeException(&quot;MediaInfo is empty&quot;)
</a><a href="#h284-0-20" id="h284-0-20" class="i">+                }
</a><a href="#h284-0-21" id="h284-0-21" class="i">+                instance = it[0]!!
</a><a href="#h284-0-22" id="h284-0-22" class="i">+            }
</a><a href="#h284-0-23" id="h284-0-23" class="i">+        }
</a><a href="#h284-0-24" id="h284-0-24" class="i">+    }
</a><a href="#h284-0-25" id="h284-0-25" class="i">+
</a><a href="#h284-0-26" id="h284-0-26" class="i">+    val encryption: EncryptionWrapper?
</a><a href="#h284-0-27" id="h284-0-27" class="i">+        get() {
</a><a href="#h284-0-28" id="h284-0-28" class="i">+            val encryptionAlgorithmField = instanceNonNull().javaClass.fields.first { f: Field -&gt;
</a><a href="#h284-0-29" id="h284-0-29" class="i">+                f.type.isInterface &amp;&amp; Parcelable::class.java.isAssignableFrom(f.type)
</a><a href="#h284-0-30" id="h284-0-30" class="i">+            }
</a><a href="#h284-0-31" id="h284-0-31" class="i">+            return encryptionAlgorithmField[instance]?.let { EncryptionWrapper(it) }
</a><a href="#h284-0-32" id="h284-0-32" class="i">+        }
</a><a href="#h284-0-33" id="h284-0-33" class="i">+}
</a><b>diff --git a/<a id="h285" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/wrapper/impl/media/dash/LongformVideoPlaylistItem.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/wrapper/impl/media/dash/LongformVideoPlaylistItem.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/wrapper/impl/media/dash/LongformVideoPlaylistItem.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/wrapper/impl/media/dash/LongformVideoPlaylistItem.kt</a></b>
<a href="#h285-0" id="h285-0" class="h">@@ -0,0 +1,11 @@
</a><a href="#h285-0-0" id="h285-0-0" class="i">+package me.rhunk.snapenhance.core.wrapper.impl.media.dash
</a><a href="#h285-0-1" id="h285-0-1" class="i">+
</a><a href="#h285-0-2" id="h285-0-2" class="i">+import me.rhunk.snapenhance.core.wrapper.AbstractWrapper
</a><a href="#h285-0-3" id="h285-0-3" class="i">+
</a><a href="#h285-0-4" id="h285-0-4" class="i">+class LongformVideoPlaylistItem(obj: Any?) : AbstractWrapper(obj) {
</a><a href="#h285-0-5" id="h285-0-5" class="i">+    private val chapterList by lazy {
</a><a href="#h285-0-6" id="h285-0-6" class="i">+        instanceNonNull().javaClass.declaredFields.first { it.type == List::class.java }
</a><a href="#h285-0-7" id="h285-0-7" class="i">+    }
</a><a href="#h285-0-8" id="h285-0-8" class="i">+    val chapters: List&lt;SnapChapter&gt;
</a><a href="#h285-0-9" id="h285-0-9" class="i">+        get() = (chapterList.get(instanceNonNull()) as List&lt;*&gt;).map { SnapChapter(it) }
</a><a href="#h285-0-10" id="h285-0-10" class="i">+}</a><a href="#h285-0-11" id="h285-0-11" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h286" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/wrapper/impl/media/dash/SnapChapter.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/wrapper/impl/media/dash/SnapChapter.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/wrapper/impl/media/dash/SnapChapter.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/wrapper/impl/media/dash/SnapChapter.kt</a></b>
<a href="#h286-0" id="h286-0" class="h">@@ -0,0 +1,12 @@
</a><a href="#h286-0-0" id="h286-0-0" class="i">+package me.rhunk.snapenhance.core.wrapper.impl.media.dash
</a><a href="#h286-0-1" id="h286-0-1" class="i">+
</a><a href="#h286-0-2" id="h286-0-2" class="i">+import me.rhunk.snapenhance.core.wrapper.AbstractWrapper
</a><a href="#h286-0-3" id="h286-0-3" class="i">+
</a><a href="#h286-0-4" id="h286-0-4" class="i">+class SnapChapter (obj: Any?) : AbstractWrapper(obj) {
</a><a href="#h286-0-5" id="h286-0-5" class="i">+    val snapId by lazy {
</a><a href="#h286-0-6" id="h286-0-6" class="i">+        instanceNonNull().javaClass.declaredFields.first { it.type == Long::class.javaPrimitiveType }.get(instanceNonNull()) as Long
</a><a href="#h286-0-7" id="h286-0-7" class="i">+    }
</a><a href="#h286-0-8" id="h286-0-8" class="i">+    val startTimeMs by lazy {
</a><a href="#h286-0-9" id="h286-0-9" class="i">+        instanceNonNull().javaClass.declaredFields.filter { it.type == Long::class.javaPrimitiveType }[1].get(instanceNonNull()) as Long
</a><a href="#h286-0-10" id="h286-0-10" class="i">+    }
</a><a href="#h286-0-11" id="h286-0-11" class="i">+}</a><a href="#h286-0-12" id="h286-0-12" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h287" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/wrapper/impl/media/dash/SnapPlaylistItem.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/wrapper/impl/media/dash/SnapPlaylistItem.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/wrapper/impl/media/dash/SnapPlaylistItem.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/wrapper/impl/media/dash/SnapPlaylistItem.kt</a></b>
<a href="#h287-0" id="h287-0" class="h">@@ -0,0 +1,9 @@
</a><a href="#h287-0-0" id="h287-0-0" class="i">+package me.rhunk.snapenhance.core.wrapper.impl.media.dash
</a><a href="#h287-0-1" id="h287-0-1" class="i">+
</a><a href="#h287-0-2" id="h287-0-2" class="i">+import me.rhunk.snapenhance.core.wrapper.AbstractWrapper
</a><a href="#h287-0-3" id="h287-0-3" class="i">+
</a><a href="#h287-0-4" id="h287-0-4" class="i">+class SnapPlaylistItem (obj: Any?) : AbstractWrapper(obj) {
</a><a href="#h287-0-5" id="h287-0-5" class="i">+    val snapId by lazy {
</a><a href="#h287-0-6" id="h287-0-6" class="i">+        instanceNonNull().javaClass.declaredFields.first { it.type == Long::class.javaPrimitiveType }.get(instanceNonNull()) as Long
</a><a href="#h287-0-7" id="h287-0-7" class="i">+    }
</a><a href="#h287-0-8" id="h287-0-8" class="i">+}</a><a href="#h287-0-9" id="h287-0-9" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h288" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/wrapper/impl/media/opera/Layer.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/wrapper/impl/media/opera/Layer.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/wrapper/impl/media/opera/Layer.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/wrapper/impl/media/opera/Layer.kt</a></b>
<a href="#h288-0" id="h288-0" class="h">@@ -0,0 +1,21 @@
</a><a href="#h288-0-0" id="h288-0-0" class="i">+package me.rhunk.snapenhance.core.wrapper.impl.media.opera
</a><a href="#h288-0-1" id="h288-0-1" class="i">+
</a><a href="#h288-0-2" id="h288-0-2" class="i">+import me.rhunk.snapenhance.core.util.ReflectionHelper
</a><a href="#h288-0-3" id="h288-0-3" class="i">+import me.rhunk.snapenhance.core.wrapper.AbstractWrapper
</a><a href="#h288-0-4" id="h288-0-4" class="i">+
</a><a href="#h288-0-5" id="h288-0-5" class="i">+class Layer(obj: Any?) : AbstractWrapper(obj) {
</a><a href="#h288-0-6" id="h288-0-6" class="i">+    val paramMap: ParamMap
</a><a href="#h288-0-7" id="h288-0-7" class="i">+        get() {
</a><a href="#h288-0-8" id="h288-0-8" class="i">+            val layerControllerField = ReflectionHelper.searchFieldContainsToString(
</a><a href="#h288-0-9" id="h288-0-9" class="i">+                instanceNonNull()::class.java,
</a><a href="#h288-0-10" id="h288-0-10" class="i">+                instance,
</a><a href="#h288-0-11" id="h288-0-11" class="i">+                &quot;OperaPageModel&quot;
</a><a href="#h288-0-12" id="h288-0-12" class="i">+            )!!
</a><a href="#h288-0-13" id="h288-0-13" class="i">+
</a><a href="#h288-0-14" id="h288-0-14" class="i">+            val paramsMapHashMap = ReflectionHelper.searchFieldStartsWithToString(
</a><a href="#h288-0-15" id="h288-0-15" class="i">+                layerControllerField.type,
</a><a href="#h288-0-16" id="h288-0-16" class="i">+                layerControllerField[instance] as Any, &quot;OperaPageModel&quot;
</a><a href="#h288-0-17" id="h288-0-17" class="i">+            )!!
</a><a href="#h288-0-18" id="h288-0-18" class="i">+            return ParamMap(paramsMapHashMap[layerControllerField[instance]]!!)
</a><a href="#h288-0-19" id="h288-0-19" class="i">+        }
</a><a href="#h288-0-20" id="h288-0-20" class="i">+}
</a><b>diff --git a/<a id="h289" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/wrapper/impl/media/opera/LayerController.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/wrapper/impl/media/opera/LayerController.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/wrapper/impl/media/opera/LayerController.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/wrapper/impl/media/opera/LayerController.kt</a></b>
<a href="#h289-0" id="h289-0" class="h">@@ -0,0 +1,18 @@
</a><a href="#h289-0-0" id="h289-0-0" class="i">+package me.rhunk.snapenhance.core.wrapper.impl.media.opera
</a><a href="#h289-0-1" id="h289-0-1" class="i">+
</a><a href="#h289-0-2" id="h289-0-2" class="i">+import de.robv.android.xposed.XposedHelpers
</a><a href="#h289-0-3" id="h289-0-3" class="i">+import me.rhunk.snapenhance.core.util.ReflectionHelper
</a><a href="#h289-0-4" id="h289-0-4" class="i">+import me.rhunk.snapenhance.core.wrapper.AbstractWrapper
</a><a href="#h289-0-5" id="h289-0-5" class="i">+import java.lang.reflect.Field
</a><a href="#h289-0-6" id="h289-0-6" class="i">+import java.util.concurrent.ConcurrentHashMap
</a><a href="#h289-0-7" id="h289-0-7" class="i">+
</a><a href="#h289-0-8" id="h289-0-8" class="i">+class LayerController(obj: Any?) : AbstractWrapper(obj) {
</a><a href="#h289-0-9" id="h289-0-9" class="i">+    val paramMap: ParamMap
</a><a href="#h289-0-10" id="h289-0-10" class="i">+        get() {
</a><a href="#h289-0-11" id="h289-0-11" class="i">+            val paramMapField: Field = ReflectionHelper.searchFieldTypeInSuperClasses(
</a><a href="#h289-0-12" id="h289-0-12" class="i">+                instanceNonNull()::class.java,
</a><a href="#h289-0-13" id="h289-0-13" class="i">+                ConcurrentHashMap::class.java
</a><a href="#h289-0-14" id="h289-0-14" class="i">+            ) ?: throw RuntimeException(&quot;Could not find paramMap field&quot;)
</a><a href="#h289-0-15" id="h289-0-15" class="i">+            return ParamMap(XposedHelpers.getObjectField(instance, paramMapField.name))
</a><a href="#h289-0-16" id="h289-0-16" class="i">+        }
</a><a href="#h289-0-17" id="h289-0-17" class="i">+}
</a><b>diff --git a/<a id="h290" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/wrapper/impl/media/opera/ParamMap.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/wrapper/impl/media/opera/ParamMap.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/wrapper/impl/media/opera/ParamMap.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/wrapper/impl/media/opera/ParamMap.kt</a></b>
<a href="#h290-0" id="h290-0" class="h">@@ -0,0 +1,37 @@
</a><a href="#h290-0-0" id="h290-0-0" class="i">+package me.rhunk.snapenhance.core.wrapper.impl.media.opera
</a><a href="#h290-0-1" id="h290-0-1" class="i">+
</a><a href="#h290-0-2" id="h290-0-2" class="i">+import me.rhunk.snapenhance.core.util.ReflectionHelper
</a><a href="#h290-0-3" id="h290-0-3" class="i">+import me.rhunk.snapenhance.core.util.ktx.getObjectField
</a><a href="#h290-0-4" id="h290-0-4" class="i">+import me.rhunk.snapenhance.core.wrapper.AbstractWrapper
</a><a href="#h290-0-5" id="h290-0-5" class="i">+import java.lang.reflect.Field
</a><a href="#h290-0-6" id="h290-0-6" class="i">+import java.util.concurrent.ConcurrentHashMap
</a><a href="#h290-0-7" id="h290-0-7" class="i">+
</a><a href="#h290-0-8" id="h290-0-8" class="i">+@Suppress(&quot;UNCHECKED_CAST&quot;)
</a><a href="#h290-0-9" id="h290-0-9" class="i">+class ParamMap(obj: Any?) : AbstractWrapper(obj) {
</a><a href="#h290-0-10" id="h290-0-10" class="i">+    private val paramMapField: Field by lazy {
</a><a href="#h290-0-11" id="h290-0-11" class="i">+        ReflectionHelper.searchFieldTypeInSuperClasses(
</a><a href="#h290-0-12" id="h290-0-12" class="i">+            instanceNonNull().javaClass,
</a><a href="#h290-0-13" id="h290-0-13" class="i">+            ConcurrentHashMap::class.java
</a><a href="#h290-0-14" id="h290-0-14" class="i">+        )!!
</a><a href="#h290-0-15" id="h290-0-15" class="i">+    }
</a><a href="#h290-0-16" id="h290-0-16" class="i">+
</a><a href="#h290-0-17" id="h290-0-17" class="i">+    val concurrentHashMap: ConcurrentHashMap&lt;Any, Any&gt;
</a><a href="#h290-0-18" id="h290-0-18" class="i">+        get() = instanceNonNull().getObjectField(paramMapField.name) as ConcurrentHashMap&lt;Any, Any&gt;
</a><a href="#h290-0-19" id="h290-0-19" class="i">+
</a><a href="#h290-0-20" id="h290-0-20" class="i">+    operator fun get(key: String): Any? {
</a><a href="#h290-0-21" id="h290-0-21" class="i">+        return concurrentHashMap.keys.firstOrNull{ k: Any -&gt; k.toString() == key }?.let { concurrentHashMap[it] }
</a><a href="#h290-0-22" id="h290-0-22" class="i">+    }
</a><a href="#h290-0-23" id="h290-0-23" class="i">+
</a><a href="#h290-0-24" id="h290-0-24" class="i">+    fun put(key: String, value: Any) {
</a><a href="#h290-0-25" id="h290-0-25" class="i">+        val keyObject = concurrentHashMap.keys.firstOrNull { k: Any -&gt; k.toString() == key } ?: key
</a><a href="#h290-0-26" id="h290-0-26" class="i">+        concurrentHashMap[keyObject] = value
</a><a href="#h290-0-27" id="h290-0-27" class="i">+    }
</a><a href="#h290-0-28" id="h290-0-28" class="i">+
</a><a href="#h290-0-29" id="h290-0-29" class="i">+    fun containsKey(key: String): Boolean {
</a><a href="#h290-0-30" id="h290-0-30" class="i">+        return concurrentHashMap.keys.any { k: Any -&gt; k.toString() == key }
</a><a href="#h290-0-31" id="h290-0-31" class="i">+    }
</a><a href="#h290-0-32" id="h290-0-32" class="i">+
</a><a href="#h290-0-33" id="h290-0-33" class="i">+    override fun toString(): String {
</a><a href="#h290-0-34" id="h290-0-34" class="i">+        return concurrentHashMap.toString()
</a><a href="#h290-0-35" id="h290-0-35" class="i">+    }
</a><a href="#h290-0-36" id="h290-0-36" class="i">+}
</a><b>diff --git a/<a id="h291" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/data/FileType.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/data/FileType.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/data/FileType.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/data/FileType.kt</a></b>
<a href="#h291-0" id="h291-0" class="h">@@ -1,75 +0,0 @@
</a><a href="#h291-0-0" id="h291-0-0" class="d">-package me.rhunk.snapenhance.data
</a><a href="#h291-0-1" id="h291-0-1" class="d">-
</a><a href="#h291-0-2" id="h291-0-2" class="d">-import me.rhunk.snapenhance.core.Logger
</a><a href="#h291-0-3" id="h291-0-3" class="d">-import java.io.File
</a><a href="#h291-0-4" id="h291-0-4" class="d">-import java.io.InputStream
</a><a href="#h291-0-5" id="h291-0-5" class="d">-
</a><a href="#h291-0-6" id="h291-0-6" class="d">-enum class FileType(
</a><a href="#h291-0-7" id="h291-0-7" class="d">-    val fileExtension: String? = null,
</a><a href="#h291-0-8" id="h291-0-8" class="d">-    val mimeType: String,
</a><a href="#h291-0-9" id="h291-0-9" class="d">-    val isVideo: Boolean = false,
</a><a href="#h291-0-10" id="h291-0-10" class="d">-    val isImage: Boolean = false,
</a><a href="#h291-0-11" id="h291-0-11" class="d">-    val isAudio: Boolean = false
</a><a href="#h291-0-12" id="h291-0-12" class="d">-) {
</a><a href="#h291-0-13" id="h291-0-13" class="d">-    GIF(&quot;gif&quot;, &quot;image/gif&quot;, false, false, false),
</a><a href="#h291-0-14" id="h291-0-14" class="d">-    PNG(&quot;png&quot;, &quot;image/png&quot;, false, true, false),
</a><a href="#h291-0-15" id="h291-0-15" class="d">-    MP4(&quot;mp4&quot;, &quot;video/mp4&quot;, true, false, false),
</a><a href="#h291-0-16" id="h291-0-16" class="d">-    MP3(&quot;mp3&quot;, &quot;audio/mp3&quot;,false, false, true),
</a><a href="#h291-0-17" id="h291-0-17" class="d">-    OPUS(&quot;opus&quot;, &quot;audio/opus&quot;, false, false, true),
</a><a href="#h291-0-18" id="h291-0-18" class="d">-    AAC(&quot;aac&quot;, &quot;audio/aac&quot;, false, false, true),
</a><a href="#h291-0-19" id="h291-0-19" class="d">-    JPG(&quot;jpg&quot;, &quot;image/jpg&quot;,false, true, false),
</a><a href="#h291-0-20" id="h291-0-20" class="d">-    ZIP(&quot;zip&quot;, &quot;application/zip&quot;, false, false, false),
</a><a href="#h291-0-21" id="h291-0-21" class="d">-    WEBP(&quot;webp&quot;, &quot;image/webp&quot;, false, true, false),
</a><a href="#h291-0-22" id="h291-0-22" class="d">-    MPD(&quot;mpd&quot;, &quot;text/xml&quot;, false, false, false),
</a><a href="#h291-0-23" id="h291-0-23" class="d">-    UNKNOWN(&quot;dat&quot;, &quot;application/octet-stream&quot;, false, false, false);
</a><a href="#h291-0-24" id="h291-0-24" class="d">-
</a><a href="#h291-0-25" id="h291-0-25" class="d">-    companion object {
</a><a href="#h291-0-26" id="h291-0-26" class="d">-        private val fileSignatures = mapOf(
</a><a href="#h291-0-27" id="h291-0-27" class="d">-            &quot;52494646&quot; to WEBP,
</a><a href="#h291-0-28" id="h291-0-28" class="d">-            &quot;504b0304&quot; to ZIP,
</a><a href="#h291-0-29" id="h291-0-29" class="d">-            &quot;89504e47&quot; to PNG,
</a><a href="#h291-0-30" id="h291-0-30" class="d">-            &quot;00000020&quot; to MP4,
</a><a href="#h291-0-31" id="h291-0-31" class="d">-            &quot;00000018&quot; to MP4,
</a><a href="#h291-0-32" id="h291-0-32" class="d">-            &quot;0000001c&quot; to MP4,
</a><a href="#h291-0-33" id="h291-0-33" class="d">-            &quot;494433&quot; to MP3,
</a><a href="#h291-0-34" id="h291-0-34" class="d">-            &quot;4f676753&quot; to OPUS,
</a><a href="#h291-0-35" id="h291-0-35" class="d">-            &quot;fff15&quot; to AAC,
</a><a href="#h291-0-36" id="h291-0-36" class="d">-            &quot;ffd8ff&quot; to JPG,
</a><a href="#h291-0-37" id="h291-0-37" class="d">-        )
</a><a href="#h291-0-38" id="h291-0-38" class="d">-
</a><a href="#h291-0-39" id="h291-0-39" class="d">-        fun fromString(string: String?): FileType {
</a><a href="#h291-0-40" id="h291-0-40" class="d">-            return entries.firstOrNull { it.fileExtension.equals(string, ignoreCase = true) } ?: UNKNOWN
</a><a href="#h291-0-41" id="h291-0-41" class="d">-        }
</a><a href="#h291-0-42" id="h291-0-42" class="d">-
</a><a href="#h291-0-43" id="h291-0-43" class="d">-        private fun bytesToHex(bytes: ByteArray): String {
</a><a href="#h291-0-44" id="h291-0-44" class="d">-            val result = StringBuilder()
</a><a href="#h291-0-45" id="h291-0-45" class="d">-            for (b in bytes) {
</a><a href="#h291-0-46" id="h291-0-46" class="d">-                result.append(String.format(&quot;%02x&quot;, b))
</a><a href="#h291-0-47" id="h291-0-47" class="d">-            }
</a><a href="#h291-0-48" id="h291-0-48" class="d">-            return result.toString()
</a><a href="#h291-0-49" id="h291-0-49" class="d">-        }
</a><a href="#h291-0-50" id="h291-0-50" class="d">-
</a><a href="#h291-0-51" id="h291-0-51" class="d">-        fun fromFile(file: File): FileType {
</a><a href="#h291-0-52" id="h291-0-52" class="d">-            file.inputStream().use { inputStream -&gt;
</a><a href="#h291-0-53" id="h291-0-53" class="d">-                val buffer = ByteArray(16)
</a><a href="#h291-0-54" id="h291-0-54" class="d">-                inputStream.read(buffer)
</a><a href="#h291-0-55" id="h291-0-55" class="d">-                return fromByteArray(buffer)
</a><a href="#h291-0-56" id="h291-0-56" class="d">-            }
</a><a href="#h291-0-57" id="h291-0-57" class="d">-        }
</a><a href="#h291-0-58" id="h291-0-58" class="d">-
</a><a href="#h291-0-59" id="h291-0-59" class="d">-        fun fromByteArray(array: ByteArray): FileType {
</a><a href="#h291-0-60" id="h291-0-60" class="d">-            val headerBytes = ByteArray(16)
</a><a href="#h291-0-61" id="h291-0-61" class="d">-            System.arraycopy(array, 0, headerBytes, 0, 16)
</a><a href="#h291-0-62" id="h291-0-62" class="d">-            val hex = bytesToHex(headerBytes)
</a><a href="#h291-0-63" id="h291-0-63" class="d">-            return fileSignatures.entries.firstOrNull { hex.startsWith(it.key) }?.value ?: UNKNOWN.also {
</a><a href="#h291-0-64" id="h291-0-64" class="d">-                Logger.directDebug(&quot;unknown file type, header: $hex&quot;, &quot;FileType&quot;)
</a><a href="#h291-0-65" id="h291-0-65" class="d">-            }
</a><a href="#h291-0-66" id="h291-0-66" class="d">-        }
</a><a href="#h291-0-67" id="h291-0-67" class="d">-
</a><a href="#h291-0-68" id="h291-0-68" class="d">-        fun fromInputStream(inputStream: InputStream): FileType {
</a><a href="#h291-0-69" id="h291-0-69" class="d">-            val buffer = ByteArray(16)
</a><a href="#h291-0-70" id="h291-0-70" class="d">-            inputStream.read(buffer)
</a><a href="#h291-0-71" id="h291-0-71" class="d">-            return fromByteArray(buffer)
</a><a href="#h291-0-72" id="h291-0-72" class="d">-        }
</a><a href="#h291-0-73" id="h291-0-73" class="d">-    }
</a><a href="#h291-0-74" id="h291-0-74" class="d">-}
</a><b>diff --git a/<a id="h292" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/data/LocalePair.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/data/LocalePair.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/data/LocalePair.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/data/LocalePair.kt</a></b>
<a href="#h292-0" id="h292-0" class="h">@@ -1,3 +0,0 @@
</a><a href="#h292-0-0" id="h292-0-0" class="d">-package me.rhunk.snapenhance.data
</a><a href="#h292-0-1" id="h292-0-1" class="d">-
</a><a href="#h292-0-2" id="h292-0-2" class="d">-data class LocalePair(val locale: String, val content: String)</a><a href="#h292-0-3" id="h292-0-3" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h293" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/data/MessageSender.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/data/MessageSender.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/data/MessageSender.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/data/MessageSender.kt</a></b>
<a href="#h293-0" id="h293-0" class="h">@@ -1,178 +0,0 @@
</a><a href="#h293-0-0" id="h293-0-0" class="d">-package me.rhunk.snapenhance.data
</a><a href="#h293-0-1" id="h293-0-1" class="d">-
</a><a href="#h293-0-2" id="h293-0-2" class="d">-import me.rhunk.snapenhance.ModContext
</a><a href="#h293-0-3" id="h293-0-3" class="d">-import me.rhunk.snapenhance.core.util.CallbackBuilder
</a><a href="#h293-0-4" id="h293-0-4" class="d">-import me.rhunk.snapenhance.core.util.protobuf.ProtoWriter
</a><a href="#h293-0-5" id="h293-0-5" class="d">-import me.rhunk.snapenhance.data.wrapper.AbstractWrapper
</a><a href="#h293-0-6" id="h293-0-6" class="d">-import me.rhunk.snapenhance.data.wrapper.impl.MessageDestinations
</a><a href="#h293-0-7" id="h293-0-7" class="d">-import me.rhunk.snapenhance.data.wrapper.impl.SnapUUID
</a><a href="#h293-0-8" id="h293-0-8" class="d">-import me.rhunk.snapenhance.features.impl.Messaging
</a><a href="#h293-0-9" id="h293-0-9" class="d">-
</a><a href="#h293-0-10" id="h293-0-10" class="d">-class MessageSender(
</a><a href="#h293-0-11" id="h293-0-11" class="d">-    private val context: ModContext,
</a><a href="#h293-0-12" id="h293-0-12" class="d">-) {
</a><a href="#h293-0-13" id="h293-0-13" class="d">-    companion object {
</a><a href="#h293-0-14" id="h293-0-14" class="d">-        val redSnapProto: (ByteArray?) -&gt; ByteArray = { extras -&gt;
</a><a href="#h293-0-15" id="h293-0-15" class="d">-            ProtoWriter().apply {
</a><a href="#h293-0-16" id="h293-0-16" class="d">-                from(11) {
</a><a href="#h293-0-17" id="h293-0-17" class="d">-                    from(5) {
</a><a href="#h293-0-18" id="h293-0-18" class="d">-                        from(1) {
</a><a href="#h293-0-19" id="h293-0-19" class="d">-                            from(1) {
</a><a href="#h293-0-20" id="h293-0-20" class="d">-                                addVarInt(2, 0)
</a><a href="#h293-0-21" id="h293-0-21" class="d">-                                addVarInt(12, 0)
</a><a href="#h293-0-22" id="h293-0-22" class="d">-                                addVarInt(15, 0)
</a><a href="#h293-0-23" id="h293-0-23" class="d">-                            }
</a><a href="#h293-0-24" id="h293-0-24" class="d">-                            addVarInt(6, 0)
</a><a href="#h293-0-25" id="h293-0-25" class="d">-                        }
</a><a href="#h293-0-26" id="h293-0-26" class="d">-                        from(2) {
</a><a href="#h293-0-27" id="h293-0-27" class="d">-                            addVarInt(5, 1) // audio by default
</a><a href="#h293-0-28" id="h293-0-28" class="d">-                            addBuffer(6, byteArrayOf())
</a><a href="#h293-0-29" id="h293-0-29" class="d">-                        }
</a><a href="#h293-0-30" id="h293-0-30" class="d">-                    }
</a><a href="#h293-0-31" id="h293-0-31" class="d">-                    extras?.let {
</a><a href="#h293-0-32" id="h293-0-32" class="d">-                        addBuffer(13, it)
</a><a href="#h293-0-33" id="h293-0-33" class="d">-                    }
</a><a href="#h293-0-34" id="h293-0-34" class="d">-                }
</a><a href="#h293-0-35" id="h293-0-35" class="d">-            }.toByteArray()
</a><a href="#h293-0-36" id="h293-0-36" class="d">-        }
</a><a href="#h293-0-37" id="h293-0-37" class="d">-
</a><a href="#h293-0-38" id="h293-0-38" class="d">-        val audioNoteProto: (Long) -&gt; ByteArray = { duration -&gt;
</a><a href="#h293-0-39" id="h293-0-39" class="d">-            ProtoWriter().apply {
</a><a href="#h293-0-40" id="h293-0-40" class="d">-                from(6, 1) {
</a><a href="#h293-0-41" id="h293-0-41" class="d">-                    from(1) {
</a><a href="#h293-0-42" id="h293-0-42" class="d">-                        addVarInt(2, 4)
</a><a href="#h293-0-43" id="h293-0-43" class="d">-                        from(5) {
</a><a href="#h293-0-44" id="h293-0-44" class="d">-                            addVarInt(1, 0)
</a><a href="#h293-0-45" id="h293-0-45" class="d">-                            addVarInt(2, 0)
</a><a href="#h293-0-46" id="h293-0-46" class="d">-                        }
</a><a href="#h293-0-47" id="h293-0-47" class="d">-                        addVarInt(7, 0)
</a><a href="#h293-0-48" id="h293-0-48" class="d">-                        addVarInt(13, duration)
</a><a href="#h293-0-49" id="h293-0-49" class="d">-                    }
</a><a href="#h293-0-50" id="h293-0-50" class="d">-                }
</a><a href="#h293-0-51" id="h293-0-51" class="d">-            }.toByteArray()
</a><a href="#h293-0-52" id="h293-0-52" class="d">-        }
</a><a href="#h293-0-53" id="h293-0-53" class="d">-
</a><a href="#h293-0-54" id="h293-0-54" class="d">-    }
</a><a href="#h293-0-55" id="h293-0-55" class="d">-
</a><a href="#h293-0-56" id="h293-0-56" class="d">-    private val sendMessageCallback by lazy { context.mappings.getMappedClass(&quot;callbacks&quot;, &quot;SendMessageCallback&quot;) }
</a><a href="#h293-0-57" id="h293-0-57" class="d">-
</a><a href="#h293-0-58" id="h293-0-58" class="d">-    private val platformAnalyticsCreatorClass by lazy {
</a><a href="#h293-0-59" id="h293-0-59" class="d">-        context.mappings.getMappedClass(&quot;PlatformAnalyticsCreator&quot;)
</a><a href="#h293-0-60" id="h293-0-60" class="d">-    }
</a><a href="#h293-0-61" id="h293-0-61" class="d">-
</a><a href="#h293-0-62" id="h293-0-62" class="d">-    private fun defaultPlatformAnalytics(): ByteArray {
</a><a href="#h293-0-63" id="h293-0-63" class="d">-        val analyticsSource = platformAnalyticsCreatorClass.constructors[0].parameterTypes[0]
</a><a href="#h293-0-64" id="h293-0-64" class="d">-        val chatAnalyticsSource = analyticsSource.enumConstants.first { it.toString() == &quot;CHAT&quot; }
</a><a href="#h293-0-65" id="h293-0-65" class="d">-
</a><a href="#h293-0-66" id="h293-0-66" class="d">-        val platformAnalyticsDefaultArgs = arrayOf(chatAnalyticsSource, null, null, null, null, null, null, null, null, null, 0L, 0L,
</a><a href="#h293-0-67" id="h293-0-67" class="d">-            null, null, false, null, null, 0L, null, null, false, null, null,
</a><a href="#h293-0-68" id="h293-0-68" class="d">-            null, null, null, null, null, null, null, null, null, null, null,
</a><a href="#h293-0-69" id="h293-0-69" class="d">-            null, null, null, null, null, null, false, null, null, false, 0L, -2, 8191)
</a><a href="#h293-0-70" id="h293-0-70" class="d">-
</a><a href="#h293-0-71" id="h293-0-71" class="d">-        val platformAnalyticsInstance = platformAnalyticsCreatorClass.constructors[0].newInstance(
</a><a href="#h293-0-72" id="h293-0-72" class="d">-            *platformAnalyticsDefaultArgs
</a><a href="#h293-0-73" id="h293-0-73" class="d">-        ) ?: throw Exception(&quot;Failed to create platform analytics instance&quot;)
</a><a href="#h293-0-74" id="h293-0-74" class="d">-
</a><a href="#h293-0-75" id="h293-0-75" class="d">-        return platformAnalyticsInstance.javaClass.declaredMethods.first { it.returnType == ByteArray::class.java }
</a><a href="#h293-0-76" id="h293-0-76" class="d">-            .invoke(platformAnalyticsInstance) as ByteArray?
</a><a href="#h293-0-77" id="h293-0-77" class="d">-            ?: throw Exception(&quot;Failed to get platform analytics content&quot;)
</a><a href="#h293-0-78" id="h293-0-78" class="d">-    }
</a><a href="#h293-0-79" id="h293-0-79" class="d">-
</a><a href="#h293-0-80" id="h293-0-80" class="d">-    private fun createLocalMessageContentTemplate(
</a><a href="#h293-0-81" id="h293-0-81" class="d">-        contentType: ContentType,
</a><a href="#h293-0-82" id="h293-0-82" class="d">-        messageContent: ByteArray,
</a><a href="#h293-0-83" id="h293-0-83" class="d">-        localMediaReference: ByteArray? = null,
</a><a href="#h293-0-84" id="h293-0-84" class="d">-        metricMessageMediaType: MetricsMessageMediaType = MetricsMessageMediaType.DERIVED_FROM_MESSAGE_TYPE,
</a><a href="#h293-0-85" id="h293-0-85" class="d">-        metricsMediaType: MetricsMessageType = MetricsMessageType.TEXT,
</a><a href="#h293-0-86" id="h293-0-86" class="d">-        savePolicy: String = &quot;PROHIBITED&quot;,
</a><a href="#h293-0-87" id="h293-0-87" class="d">-    ): String {
</a><a href="#h293-0-88" id="h293-0-88" class="d">-        return &quot;&quot;&quot;
</a><a href="#h293-0-89" id="h293-0-89" class="d">-        {
</a><a href="#h293-0-90" id="h293-0-90" class="d">-            &quot;mAllowsTranscription&quot;: false,
</a><a href="#h293-0-91" id="h293-0-91" class="d">-            &quot;mBotMention&quot;: false,
</a><a href="#h293-0-92" id="h293-0-92" class="d">-            &quot;mContent&quot;: [${messageContent.joinToString(&quot;,&quot;)}],
</a><a href="#h293-0-93" id="h293-0-93" class="d">-            &quot;mContentType&quot;: &quot;${contentType.name}&quot;,
</a><a href="#h293-0-94" id="h293-0-94" class="d">-            &quot;mIncidentalAttachments&quot;: [],
</a><a href="#h293-0-95" id="h293-0-95" class="d">-            &quot;mLocalMediaReferences&quot;: [${
</a><a href="#h293-0-96" id="h293-0-96" class="d">-                if (localMediaReference != null) {
</a><a href="#h293-0-97" id="h293-0-97" class="d">-                    &quot;{\&quot;mId\&quot;: [${localMediaReference.joinToString(&quot;,&quot;)}]}&quot;
</a><a href="#h293-0-98" id="h293-0-98" class="d">-                } else {
</a><a href="#h293-0-99" id="h293-0-99" class="d">-                    &quot;&quot;
</a><a href="#h293-0-100" id="h293-0-100" class="d">-                }
</a><a href="#h293-0-101" id="h293-0-101" class="d">-            }],
</a><a href="#h293-0-102" id="h293-0-102" class="d">-            &quot;mPlatformAnalytics&quot;: {
</a><a href="#h293-0-103" id="h293-0-103" class="d">-                &quot;mAttemptId&quot;: {
</a><a href="#h293-0-104" id="h293-0-104" class="d">-                  &quot;mId&quot;: [${(1..16).map { (-127 ..127).random() }.joinToString(&quot;,&quot;)}]
</a><a href="#h293-0-105" id="h293-0-105" class="d">-                },
</a><a href="#h293-0-106" id="h293-0-106" class="d">-                &quot;mContent&quot;: [${defaultPlatformAnalytics().joinToString(&quot;,&quot;)}],
</a><a href="#h293-0-107" id="h293-0-107" class="d">-                &quot;mMetricsMessageMediaType&quot;: &quot;${metricMessageMediaType.name}&quot;,
</a><a href="#h293-0-108" id="h293-0-108" class="d">-                &quot;mMetricsMessageType&quot;: &quot;${metricsMediaType.name}&quot;,
</a><a href="#h293-0-109" id="h293-0-109" class="d">-                &quot;mReactionSource&quot;: &quot;NONE&quot;
</a><a href="#h293-0-110" id="h293-0-110" class="d">-            },
</a><a href="#h293-0-111" id="h293-0-111" class="d">-            &quot;mSavePolicy&quot;: &quot;$savePolicy&quot;
</a><a href="#h293-0-112" id="h293-0-112" class="d">-        }
</a><a href="#h293-0-113" id="h293-0-113" class="d">-        &quot;&quot;&quot;.trimIndent()
</a><a href="#h293-0-114" id="h293-0-114" class="d">-    }
</a><a href="#h293-0-115" id="h293-0-115" class="d">-
</a><a href="#h293-0-116" id="h293-0-116" class="d">-    private fun internalSendMessage(conversations: List&lt;SnapUUID&gt;, localMessageContentTemplate: String, callback: Any) {
</a><a href="#h293-0-117" id="h293-0-117" class="d">-        val sendMessageWithContentMethod = context.classCache.conversationManager.declaredMethods.first { it.name == &quot;sendMessageWithContent&quot; }
</a><a href="#h293-0-118" id="h293-0-118" class="d">-
</a><a href="#h293-0-119" id="h293-0-119" class="d">-        val localMessageContent = context.gson.fromJson(localMessageContentTemplate, context.classCache.localMessageContent)
</a><a href="#h293-0-120" id="h293-0-120" class="d">-        val messageDestinations = MessageDestinations(AbstractWrapper.newEmptyInstance(context.classCache.messageDestinations)).also {
</a><a href="#h293-0-121" id="h293-0-121" class="d">-            it.conversations = conversations
</a><a href="#h293-0-122" id="h293-0-122" class="d">-            it.mPhoneNumbers = arrayListOf()
</a><a href="#h293-0-123" id="h293-0-123" class="d">-            it.stories = arrayListOf()
</a><a href="#h293-0-124" id="h293-0-124" class="d">-        }
</a><a href="#h293-0-125" id="h293-0-125" class="d">-
</a><a href="#h293-0-126" id="h293-0-126" class="d">-        sendMessageWithContentMethod.invoke(context.feature(Messaging::class).conversationManager, messageDestinations.instanceNonNull(), localMessageContent, callback)
</a><a href="#h293-0-127" id="h293-0-127" class="d">-    }
</a><a href="#h293-0-128" id="h293-0-128" class="d">-
</a><a href="#h293-0-129" id="h293-0-129" class="d">-    //TODO: implement sendSnapMessage
</a><a href="#h293-0-130" id="h293-0-130" class="d">-    /*
</a><a href="#h293-0-131" id="h293-0-131" class="d">-    fun sendSnapMessage(conversations: List&lt;SnapUUID&gt;, chatMediaType: ChatMediaType, uri: Uri, onError: (Any) -&gt; Unit = {}, onSuccess: () -&gt; Unit = {}) {
</a><a href="#h293-0-132" id="h293-0-132" class="d">-        val mediaReferenceBuffer = FlatBufferBuilder(0).apply {
</a><a href="#h293-0-133" id="h293-0-133" class="d">-            val uriOffset = createString(uri.toString())
</a><a href="#h293-0-134" id="h293-0-134" class="d">-            forceDefaults(true)
</a><a href="#h293-0-135" id="h293-0-135" class="d">-            startTable(2)
</a><a href="#h293-0-136" id="h293-0-136" class="d">-            addOffset(1, uriOffset, 0)
</a><a href="#h293-0-137" id="h293-0-137" class="d">-            addInt(0, chatMediaType.value, 0)
</a><a href="#h293-0-138" id="h293-0-138" class="d">-            finish(endTable())
</a><a href="#h293-0-139" id="h293-0-139" class="d">-            finished()
</a><a href="#h293-0-140" id="h293-0-140" class="d">-        }.sizedByteArray()
</a><a href="#h293-0-141" id="h293-0-141" class="d">-
</a><a href="#h293-0-142" id="h293-0-142" class="d">-        internalSendMessage(conversations, createLocalMessageContentTemplate(
</a><a href="#h293-0-143" id="h293-0-143" class="d">-            contentType = ContentType.SNAP,
</a><a href="#h293-0-144" id="h293-0-144" class="d">-            messageContent = redSnapProto(chatMediaType == ChatMediaType.AUDIO || chatMediaType == ChatMediaType.VIDEO),
</a><a href="#h293-0-145" id="h293-0-145" class="d">-            localMediaReference = mediaReferenceBuffer,
</a><a href="#h293-0-146" id="h293-0-146" class="d">-            metricMessageMediaType = MetricsMessageMediaType.IMAGE,
</a><a href="#h293-0-147" id="h293-0-147" class="d">-            metricsMediaType = MetricsMessageType.SNAP
</a><a href="#h293-0-148" id="h293-0-148" class="d">-        ), CallbackBuilder(sendMessageCallback)
</a><a href="#h293-0-149" id="h293-0-149" class="d">-            .override(&quot;onSuccess&quot;) {
</a><a href="#h293-0-150" id="h293-0-150" class="d">-                onSuccess()
</a><a href="#h293-0-151" id="h293-0-151" class="d">-            }
</a><a href="#h293-0-152" id="h293-0-152" class="d">-            .override(&quot;onError&quot;) {
</a><a href="#h293-0-153" id="h293-0-153" class="d">-                onError(it.arg(0))
</a><a href="#h293-0-154" id="h293-0-154" class="d">-            }
</a><a href="#h293-0-155" id="h293-0-155" class="d">-            .build())
</a><a href="#h293-0-156" id="h293-0-156" class="d">-    }*/
</a><a href="#h293-0-157" id="h293-0-157" class="d">-
</a><a href="#h293-0-158" id="h293-0-158" class="d">-    fun sendChatMessage(conversations: List&lt;SnapUUID&gt;, message: String, onError: (Any) -&gt; Unit = {}, onSuccess: () -&gt; Unit = {}) {
</a><a href="#h293-0-159" id="h293-0-159" class="d">-        internalSendMessage(conversations, createLocalMessageContentTemplate(ContentType.CHAT, ProtoWriter().apply {
</a><a href="#h293-0-160" id="h293-0-160" class="d">-            from(2) {
</a><a href="#h293-0-161" id="h293-0-161" class="d">-                addString(1, message)
</a><a href="#h293-0-162" id="h293-0-162" class="d">-            }
</a><a href="#h293-0-163" id="h293-0-163" class="d">-        }.toByteArray(), savePolicy = &quot;LIFETIME&quot;), CallbackBuilder(sendMessageCallback)
</a><a href="#h293-0-164" id="h293-0-164" class="d">-            .override(&quot;onSuccess&quot;, callback = { onSuccess() })
</a><a href="#h293-0-165" id="h293-0-165" class="d">-            .override(&quot;onError&quot;, callback = { onError(it.arg(0)) })
</a><a href="#h293-0-166" id="h293-0-166" class="d">-            .build())
</a><a href="#h293-0-167" id="h293-0-167" class="d">-    }
</a><a href="#h293-0-168" id="h293-0-168" class="d">-
</a><a href="#h293-0-169" id="h293-0-169" class="d">-    fun sendCustomChatMessage(conversations: List&lt;SnapUUID&gt;, contentType: ContentType,  message: ProtoWriter.() -&gt; Unit, onError: (Any) -&gt; Unit = {}, onSuccess: () -&gt; Unit = {}) {
</a><a href="#h293-0-170" id="h293-0-170" class="d">-        internalSendMessage(conversations, createLocalMessageContentTemplate(contentType, ProtoWriter().apply {
</a><a href="#h293-0-171" id="h293-0-171" class="d">-            message()
</a><a href="#h293-0-172" id="h293-0-172" class="d">-        }.toByteArray(), savePolicy = &quot;LIFETIME&quot;), CallbackBuilder(sendMessageCallback)
</a><a href="#h293-0-173" id="h293-0-173" class="d">-            .override(&quot;onSuccess&quot;, callback = { onSuccess() })
</a><a href="#h293-0-174" id="h293-0-174" class="d">-            .override(&quot;onError&quot;, callback = { onError(it.arg(0)) })
</a><a href="#h293-0-175" id="h293-0-175" class="d">-            .build())
</a><a href="#h293-0-176" id="h293-0-176" class="d">-    }
</a><a href="#h293-0-177" id="h293-0-177" class="d">-}</a><a href="#h293-0-178" id="h293-0-178" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h294" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/data/SnapClassCache.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/data/SnapClassCache.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/data/SnapClassCache.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/data/SnapClassCache.kt</a></b>
<a href="#h294-0" id="h294-0" class="h">@@ -1,30 +0,0 @@
</a><a href="#h294-0-0" id="h294-0-0" class="d">-package me.rhunk.snapenhance.data
</a><a href="#h294-0-1" id="h294-0-1" class="d">-
</a><a href="#h294-0-2" id="h294-0-2" class="d">-class SnapClassCache (
</a><a href="#h294-0-3" id="h294-0-3" class="d">-    private val classLoader: ClassLoader
</a><a href="#h294-0-4" id="h294-0-4" class="d">-) {
</a><a href="#h294-0-5" id="h294-0-5" class="d">-    val snapUUID by lazy { findClass(&quot;com.snapchat.client.messaging.UUID&quot;) }
</a><a href="#h294-0-6" id="h294-0-6" class="d">-    val snapManager by lazy { findClass(&quot;com.snapchat.client.messaging.SnapManager\$CppProxy&quot;) }
</a><a href="#h294-0-7" id="h294-0-7" class="d">-    val conversationManager by lazy { findClass(&quot;com.snapchat.client.messaging.ConversationManager\$CppProxy&quot;) }
</a><a href="#h294-0-8" id="h294-0-8" class="d">-    val presenceSession by lazy { findClass(&quot;com.snapchat.talkcorev3.PresenceSession\$CppProxy&quot;) }
</a><a href="#h294-0-9" id="h294-0-9" class="d">-    val message by lazy { findClass(&quot;com.snapchat.client.messaging.Message&quot;) }
</a><a href="#h294-0-10" id="h294-0-10" class="d">-    val messageUpdateEnum by lazy { findClass(&quot;com.snapchat.client.messaging.MessageUpdate&quot;) }
</a><a href="#h294-0-11" id="h294-0-11" class="d">-    val unifiedGrpcService by lazy { findClass(&quot;com.snapchat.client.grpc.UnifiedGrpcService\$CppProxy&quot;) }
</a><a href="#h294-0-12" id="h294-0-12" class="d">-    val networkApi by lazy { findClass(&quot;com.snapchat.client.network_api.NetworkApi\$CppProxy&quot;) }
</a><a href="#h294-0-13" id="h294-0-13" class="d">-    val messageDestinations by lazy { findClass(&quot;com.snapchat.client.messaging.MessageDestinations&quot;) }
</a><a href="#h294-0-14" id="h294-0-14" class="d">-    val localMessageContent by lazy { findClass(&quot;com.snapchat.client.messaging.LocalMessageContent&quot;) }
</a><a href="#h294-0-15" id="h294-0-15" class="d">-    val feedEntry by lazy { findClass(&quot;com.snapchat.client.messaging.FeedEntry&quot;) }
</a><a href="#h294-0-16" id="h294-0-16" class="d">-    val conversation by lazy { findClass(&quot;com.snapchat.client.messaging.Conversation&quot;) }
</a><a href="#h294-0-17" id="h294-0-17" class="d">-    val feedManager by lazy { findClass(&quot;com.snapchat.client.messaging.FeedManager\$CppProxy&quot;) }
</a><a href="#h294-0-18" id="h294-0-18" class="d">-    val chromiumJNIUtils by lazy { findClass(&quot;org.chromium.base.JNIUtils&quot;)}
</a><a href="#h294-0-19" id="h294-0-19" class="d">-    val chromiumBuildInfo by lazy { findClass(&quot;org.chromium.base.BuildInfo&quot;)}
</a><a href="#h294-0-20" id="h294-0-20" class="d">-    val chromiumPathUtils by lazy { findClass(&quot;org.chromium.base.PathUtils&quot;)}
</a><a href="#h294-0-21" id="h294-0-21" class="d">-
</a><a href="#h294-0-22" id="h294-0-22" class="d">-    private fun findClass(className: String): Class&lt;*&gt; {
</a><a href="#h294-0-23" id="h294-0-23" class="d">-        return try {
</a><a href="#h294-0-24" id="h294-0-24" class="d">-            classLoader.loadClass(className)
</a><a href="#h294-0-25" id="h294-0-25" class="d">-        } catch (e: ClassNotFoundException) {
</a><a href="#h294-0-26" id="h294-0-26" class="d">-            throw RuntimeException(&quot;Failed to find class $className&quot;, e)
</a><a href="#h294-0-27" id="h294-0-27" class="d">-        }
</a><a href="#h294-0-28" id="h294-0-28" class="d">-    }
</a><a href="#h294-0-29" id="h294-0-29" class="d">-}</a><a href="#h294-0-30" id="h294-0-30" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h295" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/data/SnapEnums.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/data/SnapEnums.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/data/SnapEnums.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/data/SnapEnums.kt</a></b>
<a href="#h295-0" id="h295-0" class="h">@@ -1,172 +0,0 @@
</a><a href="#h295-0-0" id="h295-0-0" class="d">-package me.rhunk.snapenhance.data
</a><a href="#h295-0-1" id="h295-0-1" class="d">-
</a><a href="#h295-0-2" id="h295-0-2" class="d">-import me.rhunk.snapenhance.core.util.protobuf.ProtoReader
</a><a href="#h295-0-3" id="h295-0-3" class="d">-
</a><a href="#h295-0-4" id="h295-0-4" class="d">-enum class MessageState {
</a><a href="#h295-0-5" id="h295-0-5" class="d">-    PREPARING, SENDING, COMMITTED, FAILED, CANCELING
</a><a href="#h295-0-6" id="h295-0-6" class="d">-}
</a><a href="#h295-0-7" id="h295-0-7" class="d">-
</a><a href="#h295-0-8" id="h295-0-8" class="d">-enum class NotificationType (
</a><a href="#h295-0-9" id="h295-0-9" class="d">-    val key: String,
</a><a href="#h295-0-10" id="h295-0-10" class="d">-    val isIncoming: Boolean = false,
</a><a href="#h295-0-11" id="h295-0-11" class="d">-    val associatedOutgoingContentType: ContentType? = null,
</a><a href="#h295-0-12" id="h295-0-12" class="d">-) {
</a><a href="#h295-0-13" id="h295-0-13" class="d">-    SCREENSHOT(&quot;chat_screenshot&quot;, true, ContentType.STATUS_CONVERSATION_CAPTURE_SCREENSHOT),
</a><a href="#h295-0-14" id="h295-0-14" class="d">-    SCREEN_RECORD(&quot;chat_screen_record&quot;, true, ContentType.STATUS_CONVERSATION_CAPTURE_RECORD),
</a><a href="#h295-0-15" id="h295-0-15" class="d">-    CAMERA_ROLL_SAVE(&quot;camera_roll_save&quot;, true, ContentType.STATUS_SAVE_TO_CAMERA_ROLL),
</a><a href="#h295-0-16" id="h295-0-16" class="d">-    SNAP_REPLAY(&quot;snap_replay&quot;, true, ContentType.STATUS),
</a><a href="#h295-0-17" id="h295-0-17" class="d">-    SNAP(&quot;snap&quot;,true),
</a><a href="#h295-0-18" id="h295-0-18" class="d">-    CHAT(&quot;chat&quot;,true),
</a><a href="#h295-0-19" id="h295-0-19" class="d">-    CHAT_REPLY(&quot;chat_reply&quot;,true),
</a><a href="#h295-0-20" id="h295-0-20" class="d">-    TYPING(&quot;typing&quot;, true),
</a><a href="#h295-0-21" id="h295-0-21" class="d">-    STORIES(&quot;stories&quot;,true),
</a><a href="#h295-0-22" id="h295-0-22" class="d">-    INITIATE_AUDIO(&quot;initiate_audio&quot;,true),
</a><a href="#h295-0-23" id="h295-0-23" class="d">-    ABANDON_AUDIO(&quot;abandon_audio&quot;, false, ContentType.STATUS_CALL_MISSED_AUDIO),
</a><a href="#h295-0-24" id="h295-0-24" class="d">-    INITIATE_VIDEO(&quot;initiate_video&quot;,true),
</a><a href="#h295-0-25" id="h295-0-25" class="d">-    ABANDON_VIDEO(&quot;abandon_video&quot;, false, ContentType.STATUS_CALL_MISSED_VIDEO);
</a><a href="#h295-0-26" id="h295-0-26" class="d">-
</a><a href="#h295-0-27" id="h295-0-27" class="d">-    companion object {
</a><a href="#h295-0-28" id="h295-0-28" class="d">-        fun getIncomingValues(): List&lt;NotificationType&gt; {
</a><a href="#h295-0-29" id="h295-0-29" class="d">-            return entries.filter { it.isIncoming }.toList()
</a><a href="#h295-0-30" id="h295-0-30" class="d">-        }
</a><a href="#h295-0-31" id="h295-0-31" class="d">-
</a><a href="#h295-0-32" id="h295-0-32" class="d">-        fun getOutgoingValues(): List&lt;NotificationType&gt; {
</a><a href="#h295-0-33" id="h295-0-33" class="d">-            return entries.filter { it.associatedOutgoingContentType != null }.toList()
</a><a href="#h295-0-34" id="h295-0-34" class="d">-        }
</a><a href="#h295-0-35" id="h295-0-35" class="d">-
</a><a href="#h295-0-36" id="h295-0-36" class="d">-        fun fromContentType(contentType: ContentType): NotificationType? {
</a><a href="#h295-0-37" id="h295-0-37" class="d">-            return entries.firstOrNull { it.associatedOutgoingContentType == contentType }
</a><a href="#h295-0-38" id="h295-0-38" class="d">-        }
</a><a href="#h295-0-39" id="h295-0-39" class="d">-    }
</a><a href="#h295-0-40" id="h295-0-40" class="d">-}
</a><a href="#h295-0-41" id="h295-0-41" class="d">-
</a><a href="#h295-0-42" id="h295-0-42" class="d">-enum class ContentType(val id: Int) {
</a><a href="#h295-0-43" id="h295-0-43" class="d">-    UNKNOWN(-1),
</a><a href="#h295-0-44" id="h295-0-44" class="d">-    SNAP(0),
</a><a href="#h295-0-45" id="h295-0-45" class="d">-    CHAT(1),
</a><a href="#h295-0-46" id="h295-0-46" class="d">-    EXTERNAL_MEDIA(2),
</a><a href="#h295-0-47" id="h295-0-47" class="d">-    SHARE(3),
</a><a href="#h295-0-48" id="h295-0-48" class="d">-    NOTE(4),
</a><a href="#h295-0-49" id="h295-0-49" class="d">-    STICKER(5),
</a><a href="#h295-0-50" id="h295-0-50" class="d">-    STATUS(6),
</a><a href="#h295-0-51" id="h295-0-51" class="d">-    LOCATION(7),
</a><a href="#h295-0-52" id="h295-0-52" class="d">-    STATUS_SAVE_TO_CAMERA_ROLL(8),
</a><a href="#h295-0-53" id="h295-0-53" class="d">-    STATUS_CONVERSATION_CAPTURE_SCREENSHOT(9),
</a><a href="#h295-0-54" id="h295-0-54" class="d">-    STATUS_CONVERSATION_CAPTURE_RECORD(10),
</a><a href="#h295-0-55" id="h295-0-55" class="d">-    STATUS_CALL_MISSED_VIDEO(11),
</a><a href="#h295-0-56" id="h295-0-56" class="d">-    STATUS_CALL_MISSED_AUDIO(12),
</a><a href="#h295-0-57" id="h295-0-57" class="d">-    LIVE_LOCATION_SHARE(13),
</a><a href="#h295-0-58" id="h295-0-58" class="d">-    CREATIVE_TOOL_ITEM(14),
</a><a href="#h295-0-59" id="h295-0-59" class="d">-    FAMILY_CENTER_INVITE(15),
</a><a href="#h295-0-60" id="h295-0-60" class="d">-    FAMILY_CENTER_ACCEPT(16),
</a><a href="#h295-0-61" id="h295-0-61" class="d">-    FAMILY_CENTER_LEAVE(17),
</a><a href="#h295-0-62" id="h295-0-62" class="d">-    STATUS_PLUS_GIFT(18);
</a><a href="#h295-0-63" id="h295-0-63" class="d">-
</a><a href="#h295-0-64" id="h295-0-64" class="d">-    companion object {
</a><a href="#h295-0-65" id="h295-0-65" class="d">-        fun fromId(i: Int): ContentType {
</a><a href="#h295-0-66" id="h295-0-66" class="d">-            return entries.firstOrNull { it.id == i } ?: UNKNOWN
</a><a href="#h295-0-67" id="h295-0-67" class="d">-        }
</a><a href="#h295-0-68" id="h295-0-68" class="d">-
</a><a href="#h295-0-69" id="h295-0-69" class="d">-        fun fromMessageContainer(protoReader: ProtoReader?): ContentType? {
</a><a href="#h295-0-70" id="h295-0-70" class="d">-            if (protoReader == null) return null
</a><a href="#h295-0-71" id="h295-0-71" class="d">-            return protoReader.run {
</a><a href="#h295-0-72" id="h295-0-72" class="d">-                when {
</a><a href="#h295-0-73" id="h295-0-73" class="d">-                    contains(8) -&gt; STATUS
</a><a href="#h295-0-74" id="h295-0-74" class="d">-                    contains(2) -&gt; CHAT
</a><a href="#h295-0-75" id="h295-0-75" class="d">-                    contains(11) -&gt; SNAP
</a><a href="#h295-0-76" id="h295-0-76" class="d">-                    contains(6) -&gt; NOTE
</a><a href="#h295-0-77" id="h295-0-77" class="d">-                    contains(3) -&gt; EXTERNAL_MEDIA
</a><a href="#h295-0-78" id="h295-0-78" class="d">-                    contains(4) -&gt; STICKER
</a><a href="#h295-0-79" id="h295-0-79" class="d">-                    contains(5) -&gt; SHARE
</a><a href="#h295-0-80" id="h295-0-80" class="d">-                    contains(7) -&gt; EXTERNAL_MEDIA // story replies
</a><a href="#h295-0-81" id="h295-0-81" class="d">-                    else -&gt; null
</a><a href="#h295-0-82" id="h295-0-82" class="d">-                }
</a><a href="#h295-0-83" id="h295-0-83" class="d">-            }
</a><a href="#h295-0-84" id="h295-0-84" class="d">-        }
</a><a href="#h295-0-85" id="h295-0-85" class="d">-    }
</a><a href="#h295-0-86" id="h295-0-86" class="d">-}
</a><a href="#h295-0-87" id="h295-0-87" class="d">-
</a><a href="#h295-0-88" id="h295-0-88" class="d">-enum class PlayableSnapState {
</a><a href="#h295-0-89" id="h295-0-89" class="d">-    NOTDOWNLOADED, DOWNLOADING, DOWNLOADFAILED, PLAYABLE, VIEWEDREPLAYABLE, PLAYING, VIEWEDNOTREPLAYABLE
</a><a href="#h295-0-90" id="h295-0-90" class="d">-}
</a><a href="#h295-0-91" id="h295-0-91" class="d">-
</a><a href="#h295-0-92" id="h295-0-92" class="d">-enum class MetricsMessageMediaType {
</a><a href="#h295-0-93" id="h295-0-93" class="d">-    NO_MEDIA,
</a><a href="#h295-0-94" id="h295-0-94" class="d">-    IMAGE,
</a><a href="#h295-0-95" id="h295-0-95" class="d">-    VIDEO,
</a><a href="#h295-0-96" id="h295-0-96" class="d">-    VIDEO_NO_SOUND,
</a><a href="#h295-0-97" id="h295-0-97" class="d">-    GIF,
</a><a href="#h295-0-98" id="h295-0-98" class="d">-    DERIVED_FROM_MESSAGE_TYPE,
</a><a href="#h295-0-99" id="h295-0-99" class="d">-    REACTION
</a><a href="#h295-0-100" id="h295-0-100" class="d">-}
</a><a href="#h295-0-101" id="h295-0-101" class="d">-
</a><a href="#h295-0-102" id="h295-0-102" class="d">-enum class MetricsMessageType {
</a><a href="#h295-0-103" id="h295-0-103" class="d">-    TEXT,
</a><a href="#h295-0-104" id="h295-0-104" class="d">-    STICKER,
</a><a href="#h295-0-105" id="h295-0-105" class="d">-    CUSTOM_STICKER,
</a><a href="#h295-0-106" id="h295-0-106" class="d">-    SNAP,
</a><a href="#h295-0-107" id="h295-0-107" class="d">-    AUDIO_NOTE,
</a><a href="#h295-0-108" id="h295-0-108" class="d">-    MEDIA,
</a><a href="#h295-0-109" id="h295-0-109" class="d">-    BATCHED_MEDIA,
</a><a href="#h295-0-110" id="h295-0-110" class="d">-    MISSED_AUDIO_CALL,
</a><a href="#h295-0-111" id="h295-0-111" class="d">-    MISSED_VIDEO_CALL,
</a><a href="#h295-0-112" id="h295-0-112" class="d">-    JOINED_CALL,
</a><a href="#h295-0-113" id="h295-0-113" class="d">-    LEFT_CALL,
</a><a href="#h295-0-114" id="h295-0-114" class="d">-    SNAPCHATTER,
</a><a href="#h295-0-115" id="h295-0-115" class="d">-    LOCATION_SHARE,
</a><a href="#h295-0-116" id="h295-0-116" class="d">-    LOCATION_REQUEST,
</a><a href="#h295-0-117" id="h295-0-117" class="d">-    SCREENSHOT,
</a><a href="#h295-0-118" id="h295-0-118" class="d">-    SCREEN_RECORDING,
</a><a href="#h295-0-119" id="h295-0-119" class="d">-    GAME_CLOSED,
</a><a href="#h295-0-120" id="h295-0-120" class="d">-    STORY_SHARE,
</a><a href="#h295-0-121" id="h295-0-121" class="d">-    MAP_DROP_SHARE,
</a><a href="#h295-0-122" id="h295-0-122" class="d">-    MAP_STORY_SHARE,
</a><a href="#h295-0-123" id="h295-0-123" class="d">-    MAP_STORY_SNAP_SHARE,
</a><a href="#h295-0-124" id="h295-0-124" class="d">-    MAP_HEAT_SNAP_SHARE,
</a><a href="#h295-0-125" id="h295-0-125" class="d">-    MAP_SCREENSHOT_SHARE,
</a><a href="#h295-0-126" id="h295-0-126" class="d">-    MEMORIES_STORY,
</a><a href="#h295-0-127" id="h295-0-127" class="d">-    SEARCH_STORY_SHARE,
</a><a href="#h295-0-128" id="h295-0-128" class="d">-    SEARCH_STORY_SNAP_SHARE,
</a><a href="#h295-0-129" id="h295-0-129" class="d">-    DISCOVER_SHARE,
</a><a href="#h295-0-130" id="h295-0-130" class="d">-    SHAZAM_SHARE,
</a><a href="#h295-0-131" id="h295-0-131" class="d">-    SAVE_TO_CAMERA_ROLL,
</a><a href="#h295-0-132" id="h295-0-132" class="d">-    GAME_SCORE_SHARE,
</a><a href="#h295-0-133" id="h295-0-133" class="d">-    SNAP_PRO_PROFILE_SHARE,
</a><a href="#h295-0-134" id="h295-0-134" class="d">-    SNAP_PRO_SNAP_SHARE,
</a><a href="#h295-0-135" id="h295-0-135" class="d">-    CANVAS_APP_SHARE,
</a><a href="#h295-0-136" id="h295-0-136" class="d">-    AD_SHARE,
</a><a href="#h295-0-137" id="h295-0-137" class="d">-    STORY_REPLY,
</a><a href="#h295-0-138" id="h295-0-138" class="d">-    SPOTLIGHT_STORY_SHARE,
</a><a href="#h295-0-139" id="h295-0-139" class="d">-    CAMEO,
</a><a href="#h295-0-140" id="h295-0-140" class="d">-    MEMOJI,
</a><a href="#h295-0-141" id="h295-0-141" class="d">-    BITMOJI_OUTFIT_SHARE,
</a><a href="#h295-0-142" id="h295-0-142" class="d">-    LIVE_LOCATION_SHARE,
</a><a href="#h295-0-143" id="h295-0-143" class="d">-    CREATIVE_TOOL_ITEM,
</a><a href="#h295-0-144" id="h295-0-144" class="d">-    SNAP_KIT_INVITE_SHARE,
</a><a href="#h295-0-145" id="h295-0-145" class="d">-    QUOTE_REPLY_SHARE,
</a><a href="#h295-0-146" id="h295-0-146" class="d">-    BLOOPS_STORY_SHARE,
</a><a href="#h295-0-147" id="h295-0-147" class="d">-    SNAP_PRO_SAVED_STORY_SHARE,
</a><a href="#h295-0-148" id="h295-0-148" class="d">-    PLACE_PROFILE_SHARE,
</a><a href="#h295-0-149" id="h295-0-149" class="d">-    PLACE_STORY_SHARE,
</a><a href="#h295-0-150" id="h295-0-150" class="d">-    SAVED_STORY_SHARE
</a><a href="#h295-0-151" id="h295-0-151" class="d">-}
</a><a href="#h295-0-152" id="h295-0-152" class="d">-enum class MediaReferenceType {
</a><a href="#h295-0-153" id="h295-0-153" class="d">-    UNASSIGNED, OVERLAY, IMAGE, VIDEO, ASSET_BUNDLE, AUDIO, ANIMATED_IMAGE, FONT, WEB_VIEW_CONTENT, VIDEO_NO_AUDIO
</a><a href="#h295-0-154" id="h295-0-154" class="d">-}
</a><a href="#h295-0-155" id="h295-0-155" class="d">-
</a><a href="#h295-0-156" id="h295-0-156" class="d">-enum class FriendLinkType(val value: Int, val shortName: String) {
</a><a href="#h295-0-157" id="h295-0-157" class="d">-    MUTUAL(0, &quot;mutual&quot;),
</a><a href="#h295-0-158" id="h295-0-158" class="d">-    OUTGOING(1, &quot;outgoing&quot;),
</a><a href="#h295-0-159" id="h295-0-159" class="d">-    BLOCKED(2, &quot;blocked&quot;),
</a><a href="#h295-0-160" id="h295-0-160" class="d">-    DELETED(3, &quot;deleted&quot;),
</a><a href="#h295-0-161" id="h295-0-161" class="d">-    FOLLOWING(4, &quot;following&quot;),
</a><a href="#h295-0-162" id="h295-0-162" class="d">-    SUGGESTED(5, &quot;suggested&quot;),
</a><a href="#h295-0-163" id="h295-0-163" class="d">-    INCOMING(6, &quot;incoming&quot;),
</a><a href="#h295-0-164" id="h295-0-164" class="d">-    INCOMING_FOLLOWER(7, &quot;incoming_follower&quot;);
</a><a href="#h295-0-165" id="h295-0-165" class="d">-
</a><a href="#h295-0-166" id="h295-0-166" class="d">-    companion object {
</a><a href="#h295-0-167" id="h295-0-167" class="d">-        fun fromValue(value: Int): FriendLinkType {
</a><a href="#h295-0-168" id="h295-0-168" class="d">-            return entries.firstOrNull { it.value == value } ?: MUTUAL
</a><a href="#h295-0-169" id="h295-0-169" class="d">-        }
</a><a href="#h295-0-170" id="h295-0-170" class="d">-    }
</a><a href="#h295-0-171" id="h295-0-171" class="d">-}</a><a href="#h295-0-172" id="h295-0-172" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h296" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/AbstractWrapper.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/AbstractWrapper.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/AbstractWrapper.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/AbstractWrapper.kt</a></b>
<a href="#h296-0" id="h296-0" class="h">@@ -1,46 +0,0 @@
</a><a href="#h296-0-0" id="h296-0-0" class="d">-package me.rhunk.snapenhance.data.wrapper
</a><a href="#h296-0-1" id="h296-0-1" class="d">-
</a><a href="#h296-0-2" id="h296-0-2" class="d">-import de.robv.android.xposed.XposedHelpers
</a><a href="#h296-0-3" id="h296-0-3" class="d">-import me.rhunk.snapenhance.core.util.CallbackBuilder
</a><a href="#h296-0-4" id="h296-0-4" class="d">-import kotlin.reflect.KProperty
</a><a href="#h296-0-5" id="h296-0-5" class="d">-
</a><a href="#h296-0-6" id="h296-0-6" class="d">-abstract class AbstractWrapper(
</a><a href="#h296-0-7" id="h296-0-7" class="d">-    protected var instance: Any?
</a><a href="#h296-0-8" id="h296-0-8" class="d">-) {
</a><a href="#h296-0-9" id="h296-0-9" class="d">-    @Suppress(&quot;UNCHECKED_CAST&quot;)
</a><a href="#h296-0-10" id="h296-0-10" class="d">-    inner class EnumAccessor&lt;T&gt;(private val fieldName: String, private val defaultValue: T) {
</a><a href="#h296-0-11" id="h296-0-11" class="d">-        operator fun getValue(obj: Any, property: KProperty&lt;*&gt;): T? = getEnumValue(fieldName, defaultValue as Enum&lt;*&gt;) as? T
</a><a href="#h296-0-12" id="h296-0-12" class="d">-        operator fun setValue(obj: Any, property: KProperty&lt;*&gt;, value: Any?) = setEnumValue(fieldName, value as Enum&lt;*&gt;)
</a><a href="#h296-0-13" id="h296-0-13" class="d">-    }
</a><a href="#h296-0-14" id="h296-0-14" class="d">-
</a><a href="#h296-0-15" id="h296-0-15" class="d">-    companion object {
</a><a href="#h296-0-16" id="h296-0-16" class="d">-        fun newEmptyInstance(clazz: Class&lt;*&gt;): Any {
</a><a href="#h296-0-17" id="h296-0-17" class="d">-            return CallbackBuilder.createEmptyObject(clazz.constructors[0]) ?: throw NullPointerException()
</a><a href="#h296-0-18" id="h296-0-18" class="d">-        }
</a><a href="#h296-0-19" id="h296-0-19" class="d">-    }
</a><a href="#h296-0-20" id="h296-0-20" class="d">-
</a><a href="#h296-0-21" id="h296-0-21" class="d">-    fun instanceNonNull(): Any = instance!!
</a><a href="#h296-0-22" id="h296-0-22" class="d">-    fun isPresent(): Boolean = instance != null
</a><a href="#h296-0-23" id="h296-0-23" class="d">-
</a><a href="#h296-0-24" id="h296-0-24" class="d">-    override fun hashCode(): Int {
</a><a href="#h296-0-25" id="h296-0-25" class="d">-        return instance.hashCode()
</a><a href="#h296-0-26" id="h296-0-26" class="d">-    }
</a><a href="#h296-0-27" id="h296-0-27" class="d">-
</a><a href="#h296-0-28" id="h296-0-28" class="d">-    override fun toString(): String {
</a><a href="#h296-0-29" id="h296-0-29" class="d">-        return instance.toString()
</a><a href="#h296-0-30" id="h296-0-30" class="d">-    }
</a><a href="#h296-0-31" id="h296-0-31" class="d">-
</a><a href="#h296-0-32" id="h296-0-32" class="d">-    protected fun &lt;T&gt; enum(fieldName: String, defaultValue: T) = EnumAccessor(fieldName, defaultValue)
</a><a href="#h296-0-33" id="h296-0-33" class="d">-
</a><a href="#h296-0-34" id="h296-0-34" class="d">-    fun &lt;T : Enum&lt;*&gt;&gt; getEnumValue(fieldName: String, defaultValue: T?): T? {
</a><a href="#h296-0-35" id="h296-0-35" class="d">-        if (defaultValue == null) return null
</a><a href="#h296-0-36" id="h296-0-36" class="d">-        val mContentType = XposedHelpers.getObjectField(instance, fieldName) as? Enum&lt;*&gt; ?: return null
</a><a href="#h296-0-37" id="h296-0-37" class="d">-        return java.lang.Enum.valueOf(defaultValue::class.java, mContentType.name)
</a><a href="#h296-0-38" id="h296-0-38" class="d">-    }
</a><a href="#h296-0-39" id="h296-0-39" class="d">-
</a><a href="#h296-0-40" id="h296-0-40" class="d">-    @Suppress(&quot;UNCHECKED_CAST&quot;)
</a><a href="#h296-0-41" id="h296-0-41" class="d">-    fun setEnumValue(fieldName: String, value: Enum&lt;*&gt;) {
</a><a href="#h296-0-42" id="h296-0-42" class="d">-        val type = instance!!.javaClass.declaredFields.find { it.name == fieldName }?.type as Class&lt;out Enum&lt;*&gt;&gt;
</a><a href="#h296-0-43" id="h296-0-43" class="d">-        XposedHelpers.setObjectField(instance, fieldName, java.lang.Enum.valueOf(type, value.name))
</a><a href="#h296-0-44" id="h296-0-44" class="d">-    }
</a><a href="#h296-0-45" id="h296-0-45" class="d">-}</a><a href="#h296-0-46" id="h296-0-46" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h297" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/FriendActionButton.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/FriendActionButton.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/FriendActionButton.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/FriendActionButton.kt</a></b>
<a href="#h297-0" id="h297-0" class="h">@@ -1,38 +0,0 @@
</a><a href="#h297-0-0" id="h297-0-0" class="d">-package me.rhunk.snapenhance.data.wrapper.impl
</a><a href="#h297-0-1" id="h297-0-1" class="d">-
</a><a href="#h297-0-2" id="h297-0-2" class="d">-import android.content.Context
</a><a href="#h297-0-3" id="h297-0-3" class="d">-import android.graphics.drawable.Drawable
</a><a href="#h297-0-4" id="h297-0-4" class="d">-import android.util.AttributeSet
</a><a href="#h297-0-5" id="h297-0-5" class="d">-import android.view.View
</a><a href="#h297-0-6" id="h297-0-6" class="d">-import me.rhunk.snapenhance.SnapEnhance
</a><a href="#h297-0-7" id="h297-0-7" class="d">-import me.rhunk.snapenhance.data.wrapper.AbstractWrapper
</a><a href="#h297-0-8" id="h297-0-8" class="d">-
</a><a href="#h297-0-9" id="h297-0-9" class="d">-class FriendActionButton(
</a><a href="#h297-0-10" id="h297-0-10" class="d">-    obj: View
</a><a href="#h297-0-11" id="h297-0-11" class="d">-) : AbstractWrapper(obj) {
</a><a href="#h297-0-12" id="h297-0-12" class="d">-    private val iconDrawableContainer by lazy {
</a><a href="#h297-0-13" id="h297-0-13" class="d">-        instanceNonNull().javaClass.declaredFields.first { it.type != Int::class.javaPrimitiveType }[instanceNonNull()]
</a><a href="#h297-0-14" id="h297-0-14" class="d">-    }
</a><a href="#h297-0-15" id="h297-0-15" class="d">-
</a><a href="#h297-0-16" id="h297-0-16" class="d">-    private val setIconDrawableMethod by lazy {
</a><a href="#h297-0-17" id="h297-0-17" class="d">-        iconDrawableContainer.javaClass.declaredMethods.first {
</a><a href="#h297-0-18" id="h297-0-18" class="d">-            it.parameterTypes.size == 1 &amp;&amp;
</a><a href="#h297-0-19" id="h297-0-19" class="d">-                    it.parameterTypes[0] == Drawable::class.java &amp;&amp;
</a><a href="#h297-0-20" id="h297-0-20" class="d">-                    it.name != &quot;invalidateDrawable&quot; &amp;&amp;
</a><a href="#h297-0-21" id="h297-0-21" class="d">-                    it.returnType == Void::class.javaPrimitiveType
</a><a href="#h297-0-22" id="h297-0-22" class="d">-        }
</a><a href="#h297-0-23" id="h297-0-23" class="d">-    }
</a><a href="#h297-0-24" id="h297-0-24" class="d">-
</a><a href="#h297-0-25" id="h297-0-25" class="d">-    fun setIconDrawable(drawable: Drawable) {
</a><a href="#h297-0-26" id="h297-0-26" class="d">-        setIconDrawableMethod.invoke(iconDrawableContainer, drawable)
</a><a href="#h297-0-27" id="h297-0-27" class="d">-    }
</a><a href="#h297-0-28" id="h297-0-28" class="d">-
</a><a href="#h297-0-29" id="h297-0-29" class="d">-    companion object {
</a><a href="#h297-0-30" id="h297-0-30" class="d">-        fun new(context: Context): FriendActionButton {
</a><a href="#h297-0-31" id="h297-0-31" class="d">-            val instance = SnapEnhance.classLoader.loadClass(&quot;com.snap.profile.shared.view.FriendActionButton&quot;)
</a><a href="#h297-0-32" id="h297-0-32" class="d">-                .getConstructor(Context::class.java, AttributeSet::class.java)
</a><a href="#h297-0-33" id="h297-0-33" class="d">-                .newInstance(context, null) as View
</a><a href="#h297-0-34" id="h297-0-34" class="d">-            return FriendActionButton(instance)
</a><a href="#h297-0-35" id="h297-0-35" class="d">-        }
</a><a href="#h297-0-36" id="h297-0-36" class="d">-    }
</a><a href="#h297-0-37" id="h297-0-37" class="d">-}</a><a href="#h297-0-38" id="h297-0-38" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h298" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/Message.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/Message.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/Message.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/Message.kt</a></b>
<a href="#h298-0" id="h298-0" class="h">@@ -1,14 +0,0 @@
</a><a href="#h298-0-0" id="h298-0-0" class="d">-package me.rhunk.snapenhance.data.wrapper.impl
</a><a href="#h298-0-1" id="h298-0-1" class="d">-
</a><a href="#h298-0-2" id="h298-0-2" class="d">-import me.rhunk.snapenhance.core.util.ktx.getObjectField
</a><a href="#h298-0-3" id="h298-0-3" class="d">-import me.rhunk.snapenhance.data.MessageState
</a><a href="#h298-0-4" id="h298-0-4" class="d">-import me.rhunk.snapenhance.data.wrapper.AbstractWrapper
</a><a href="#h298-0-5" id="h298-0-5" class="d">-
</a><a href="#h298-0-6" id="h298-0-6" class="d">-class Message(obj: Any?) : AbstractWrapper(obj) {
</a><a href="#h298-0-7" id="h298-0-7" class="d">-    val orderKey get() = instanceNonNull().getObjectField(&quot;mOrderKey&quot;) as Long
</a><a href="#h298-0-8" id="h298-0-8" class="d">-    val senderId get() = SnapUUID(instanceNonNull().getObjectField(&quot;mSenderId&quot;))
</a><a href="#h298-0-9" id="h298-0-9" class="d">-    val messageContent get() = MessageContent(instanceNonNull().getObjectField(&quot;mMessageContent&quot;))
</a><a href="#h298-0-10" id="h298-0-10" class="d">-    val messageDescriptor get() = MessageDescriptor(instanceNonNull().getObjectField(&quot;mDescriptor&quot;))
</a><a href="#h298-0-11" id="h298-0-11" class="d">-    val messageMetadata get() = MessageMetadata(instanceNonNull().getObjectField(&quot;mMetadata&quot;))
</a><a href="#h298-0-12" id="h298-0-12" class="d">-    var messageState by enum(&quot;mState&quot;, MessageState.COMMITTED)
</a><a href="#h298-0-13" id="h298-0-13" class="d">-}</a><a href="#h298-0-14" id="h298-0-14" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h299" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/MessageContent.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/MessageContent.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/MessageContent.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/MessageContent.kt</a></b>
<a href="#h299-0" id="h299-0" class="h">@@ -1,13 +0,0 @@
</a><a href="#h299-0-0" id="h299-0-0" class="d">-package me.rhunk.snapenhance.data.wrapper.impl
</a><a href="#h299-0-1" id="h299-0-1" class="d">-
</a><a href="#h299-0-2" id="h299-0-2" class="d">-import me.rhunk.snapenhance.core.util.ktx.getObjectField
</a><a href="#h299-0-3" id="h299-0-3" class="d">-import me.rhunk.snapenhance.core.util.ktx.setObjectField
</a><a href="#h299-0-4" id="h299-0-4" class="d">-import me.rhunk.snapenhance.data.ContentType
</a><a href="#h299-0-5" id="h299-0-5" class="d">-import me.rhunk.snapenhance.data.wrapper.AbstractWrapper
</a><a href="#h299-0-6" id="h299-0-6" class="d">-
</a><a href="#h299-0-7" id="h299-0-7" class="d">-class MessageContent(obj: Any?) : AbstractWrapper(obj) {
</a><a href="#h299-0-8" id="h299-0-8" class="d">-    var content
</a><a href="#h299-0-9" id="h299-0-9" class="d">-        get() = instanceNonNull().getObjectField(&quot;mContent&quot;) as ByteArray
</a><a href="#h299-0-10" id="h299-0-10" class="d">-        set(value) = instanceNonNull().setObjectField(&quot;mContent&quot;, value)
</a><a href="#h299-0-11" id="h299-0-11" class="d">-    var contentType by enum(&quot;mContentType&quot;, ContentType.UNKNOWN)
</a><a href="#h299-0-12" id="h299-0-12" class="d">-}</a><a href="#h299-0-13" id="h299-0-13" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h300" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/MessageDescriptor.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/MessageDescriptor.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/MessageDescriptor.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/MessageDescriptor.kt</a></b>
<a href="#h300-0" id="h300-0" class="h">@@ -1,9 +0,0 @@
</a><a href="#h300-0-0" id="h300-0-0" class="d">-package me.rhunk.snapenhance.data.wrapper.impl
</a><a href="#h300-0-1" id="h300-0-1" class="d">-
</a><a href="#h300-0-2" id="h300-0-2" class="d">-import me.rhunk.snapenhance.core.util.ktx.getObjectField
</a><a href="#h300-0-3" id="h300-0-3" class="d">-import me.rhunk.snapenhance.data.wrapper.AbstractWrapper
</a><a href="#h300-0-4" id="h300-0-4" class="d">-
</a><a href="#h300-0-5" id="h300-0-5" class="d">-class MessageDescriptor(obj: Any?) : AbstractWrapper(obj) {
</a><a href="#h300-0-6" id="h300-0-6" class="d">-    val messageId: Long get() = instanceNonNull().getObjectField(&quot;mMessageId&quot;) as Long
</a><a href="#h300-0-7" id="h300-0-7" class="d">-    val conversationId: SnapUUID get() = SnapUUID(instanceNonNull().getObjectField(&quot;mConversationId&quot;)!!)
</a><a href="#h300-0-8" id="h300-0-8" class="d">-}</a><a href="#h300-0-9" id="h300-0-9" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h301" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/MessageDestinations.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/MessageDestinations.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/MessageDestinations.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/MessageDestinations.kt</a></b>
<a href="#h301-0" id="h301-0" class="h">@@ -1,15 +0,0 @@
</a><a href="#h301-0-0" id="h301-0-0" class="d">-package me.rhunk.snapenhance.data.wrapper.impl
</a><a href="#h301-0-1" id="h301-0-1" class="d">-
</a><a href="#h301-0-2" id="h301-0-2" class="d">-import me.rhunk.snapenhance.core.util.ktx.getObjectField
</a><a href="#h301-0-3" id="h301-0-3" class="d">-import me.rhunk.snapenhance.core.util.ktx.setObjectField
</a><a href="#h301-0-4" id="h301-0-4" class="d">-import me.rhunk.snapenhance.data.wrapper.AbstractWrapper
</a><a href="#h301-0-5" id="h301-0-5" class="d">-
</a><a href="#h301-0-6" id="h301-0-6" class="d">-@Suppress(&quot;UNCHECKED_CAST&quot;)
</a><a href="#h301-0-7" id="h301-0-7" class="d">-class MessageDestinations(obj: Any) : AbstractWrapper(obj){
</a><a href="#h301-0-8" id="h301-0-8" class="d">-    var conversations get() = (instanceNonNull().getObjectField(&quot;mConversations&quot;) as ArrayList&lt;*&gt;).map { SnapUUID(it) }
</a><a href="#h301-0-9" id="h301-0-9" class="d">-        set(value) = instanceNonNull().setObjectField(&quot;mConversations&quot;, value.map { it.instanceNonNull() }.toCollection(ArrayList()))
</a><a href="#h301-0-10" id="h301-0-10" class="d">-    var stories get() = instanceNonNull().getObjectField(&quot;mStories&quot;) as ArrayList&lt;Any&gt;
</a><a href="#h301-0-11" id="h301-0-11" class="d">-        set(value) = instanceNonNull().setObjectField(&quot;mStories&quot;, value)
</a><a href="#h301-0-12" id="h301-0-12" class="d">-    var mPhoneNumbers get() = instanceNonNull().getObjectField(&quot;mPhoneNumbers&quot;) as ArrayList&lt;Any&gt;
</a><a href="#h301-0-13" id="h301-0-13" class="d">-        set(value) = instanceNonNull().setObjectField(&quot;mPhoneNumbers&quot;, value)
</a><a href="#h301-0-14" id="h301-0-14" class="d">-}</a><a href="#h301-0-15" id="h301-0-15" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h302" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/MessageMetadata.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/MessageMetadata.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/MessageMetadata.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/MessageMetadata.kt</a></b>
<a href="#h302-0" id="h302-0" class="h">@@ -1,28 +0,0 @@
</a><a href="#h302-0-0" id="h302-0-0" class="d">-package me.rhunk.snapenhance.data.wrapper.impl
</a><a href="#h302-0-1" id="h302-0-1" class="d">-
</a><a href="#h302-0-2" id="h302-0-2" class="d">-import me.rhunk.snapenhance.core.util.ktx.getObjectField
</a><a href="#h302-0-3" id="h302-0-3" class="d">-import me.rhunk.snapenhance.data.PlayableSnapState
</a><a href="#h302-0-4" id="h302-0-4" class="d">-import me.rhunk.snapenhance.data.wrapper.AbstractWrapper
</a><a href="#h302-0-5" id="h302-0-5" class="d">-
</a><a href="#h302-0-6" id="h302-0-6" class="d">-class MessageMetadata(obj: Any?) : AbstractWrapper(obj){
</a><a href="#h302-0-7" id="h302-0-7" class="d">-    val createdAt: Long get() = instanceNonNull().getObjectField(&quot;mCreatedAt&quot;) as Long
</a><a href="#h302-0-8" id="h302-0-8" class="d">-    val readAt: Long get() = instanceNonNull().getObjectField(&quot;mReadAt&quot;) as Long
</a><a href="#h302-0-9" id="h302-0-9" class="d">-    var playableSnapState by enum(&quot;mPlayableSnapState&quot;, PlayableSnapState.PLAYABLE)
</a><a href="#h302-0-10" id="h302-0-10" class="d">-
</a><a href="#h302-0-11" id="h302-0-11" class="d">-    private fun getUUIDList(name: String): List&lt;SnapUUID&gt; {
</a><a href="#h302-0-12" id="h302-0-12" class="d">-        return (instanceNonNull().getObjectField(name) as List&lt;*&gt;).map { SnapUUID(it!!) }
</a><a href="#h302-0-13" id="h302-0-13" class="d">-    }
</a><a href="#h302-0-14" id="h302-0-14" class="d">-
</a><a href="#h302-0-15" id="h302-0-15" class="d">-    val savedBy: List&lt;SnapUUID&gt; by lazy {
</a><a href="#h302-0-16" id="h302-0-16" class="d">-        getUUIDList(&quot;mSavedBy&quot;)
</a><a href="#h302-0-17" id="h302-0-17" class="d">-    }
</a><a href="#h302-0-18" id="h302-0-18" class="d">-    val openedBy: List&lt;SnapUUID&gt; by lazy {
</a><a href="#h302-0-19" id="h302-0-19" class="d">-        getUUIDList(&quot;mOpenedBy&quot;)
</a><a href="#h302-0-20" id="h302-0-20" class="d">-    }
</a><a href="#h302-0-21" id="h302-0-21" class="d">-    val seenBy: List&lt;SnapUUID&gt; by lazy {
</a><a href="#h302-0-22" id="h302-0-22" class="d">-        getUUIDList(&quot;mSeenBy&quot;)
</a><a href="#h302-0-23" id="h302-0-23" class="d">-    }
</a><a href="#h302-0-24" id="h302-0-24" class="d">-    val reactions: List&lt;UserIdToReaction&gt; by lazy {
</a><a href="#h302-0-25" id="h302-0-25" class="d">-        (instanceNonNull().getObjectField(&quot;mReactions&quot;) as List&lt;*&gt;).map { UserIdToReaction(it!!) }
</a><a href="#h302-0-26" id="h302-0-26" class="d">-    }
</a><a href="#h302-0-27" id="h302-0-27" class="d">-}</a><a href="#h302-0-28" id="h302-0-28" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h303" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/ScSize.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/ScSize.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/ScSize.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/ScSize.kt</a></b>
<a href="#h303-0" id="h303-0" class="h">@@ -1,26 +0,0 @@
</a><a href="#h303-0-0" id="h303-0-0" class="d">-package me.rhunk.snapenhance.data.wrapper.impl
</a><a href="#h303-0-1" id="h303-0-1" class="d">-
</a><a href="#h303-0-2" id="h303-0-2" class="d">-import me.rhunk.snapenhance.data.wrapper.AbstractWrapper
</a><a href="#h303-0-3" id="h303-0-3" class="d">-
</a><a href="#h303-0-4" id="h303-0-4" class="d">-class ScSize(
</a><a href="#h303-0-5" id="h303-0-5" class="d">-    obj: Any?
</a><a href="#h303-0-6" id="h303-0-6" class="d">-) : AbstractWrapper(obj) {
</a><a href="#h303-0-7" id="h303-0-7" class="d">-    private val firstField by lazy {
</a><a href="#h303-0-8" id="h303-0-8" class="d">-        instanceNonNull().javaClass.declaredFields.first { it.type == Int::class.javaPrimitiveType }.also { it.isAccessible = true }
</a><a href="#h303-0-9" id="h303-0-9" class="d">-    }
</a><a href="#h303-0-10" id="h303-0-10" class="d">-
</a><a href="#h303-0-11" id="h303-0-11" class="d">-    private val secondField by lazy {
</a><a href="#h303-0-12" id="h303-0-12" class="d">-        instanceNonNull().javaClass.declaredFields.last { it.type == Int::class.javaPrimitiveType }.also { it.isAccessible = true }
</a><a href="#h303-0-13" id="h303-0-13" class="d">-    }
</a><a href="#h303-0-14" id="h303-0-14" class="d">-
</a><a href="#h303-0-15" id="h303-0-15" class="d">-
</a><a href="#h303-0-16" id="h303-0-16" class="d">-    var first: Int get() = firstField.getInt(instanceNonNull())
</a><a href="#h303-0-17" id="h303-0-17" class="d">-        set(value) {
</a><a href="#h303-0-18" id="h303-0-18" class="d">-            firstField.setInt(instanceNonNull(), value)
</a><a href="#h303-0-19" id="h303-0-19" class="d">-        }
</a><a href="#h303-0-20" id="h303-0-20" class="d">-
</a><a href="#h303-0-21" id="h303-0-21" class="d">-    var second: Int get() = secondField.getInt(instanceNonNull())
</a><a href="#h303-0-22" id="h303-0-22" class="d">-        set(value) {
</a><a href="#h303-0-23" id="h303-0-23" class="d">-            secondField.setInt(instanceNonNull(), value)
</a><a href="#h303-0-24" id="h303-0-24" class="d">-        }
</a><a href="#h303-0-25" id="h303-0-25" class="d">-}</a><a href="#h303-0-26" id="h303-0-26" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h304" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/SnapUUID.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/SnapUUID.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/SnapUUID.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/SnapUUID.kt</a></b>
<a href="#h304-0" id="h304-0" class="h">@@ -1,44 +0,0 @@
</a><a href="#h304-0-0" id="h304-0-0" class="d">-package me.rhunk.snapenhance.data.wrapper.impl
</a><a href="#h304-0-1" id="h304-0-1" class="d">-
</a><a href="#h304-0-2" id="h304-0-2" class="d">-import me.rhunk.snapenhance.SnapEnhance
</a><a href="#h304-0-3" id="h304-0-3" class="d">-import me.rhunk.snapenhance.core.util.ktx.getObjectField
</a><a href="#h304-0-4" id="h304-0-4" class="d">-import me.rhunk.snapenhance.data.wrapper.AbstractWrapper
</a><a href="#h304-0-5" id="h304-0-5" class="d">-import java.nio.ByteBuffer
</a><a href="#h304-0-6" id="h304-0-6" class="d">-import java.util.UUID
</a><a href="#h304-0-7" id="h304-0-7" class="d">-
</a><a href="#h304-0-8" id="h304-0-8" class="d">-class SnapUUID(obj: Any?) : AbstractWrapper(obj) {
</a><a href="#h304-0-9" id="h304-0-9" class="d">-    private val uuidString by lazy { toUUID().toString() }
</a><a href="#h304-0-10" id="h304-0-10" class="d">-
</a><a href="#h304-0-11" id="h304-0-11" class="d">-    private val bytes: ByteArray get() = instanceNonNull().getObjectField(&quot;mId&quot;) as ByteArray
</a><a href="#h304-0-12" id="h304-0-12" class="d">-
</a><a href="#h304-0-13" id="h304-0-13" class="d">-    private fun toUUID(): UUID {
</a><a href="#h304-0-14" id="h304-0-14" class="d">-        val buffer = ByteBuffer.wrap(bytes)
</a><a href="#h304-0-15" id="h304-0-15" class="d">-        return UUID(buffer.long, buffer.long)
</a><a href="#h304-0-16" id="h304-0-16" class="d">-    }
</a><a href="#h304-0-17" id="h304-0-17" class="d">-
</a><a href="#h304-0-18" id="h304-0-18" class="d">-    override fun toString(): String {
</a><a href="#h304-0-19" id="h304-0-19" class="d">-        return uuidString
</a><a href="#h304-0-20" id="h304-0-20" class="d">-    }
</a><a href="#h304-0-21" id="h304-0-21" class="d">-
</a><a href="#h304-0-22" id="h304-0-22" class="d">-    fun toBytes() = bytes
</a><a href="#h304-0-23" id="h304-0-23" class="d">-
</a><a href="#h304-0-24" id="h304-0-24" class="d">-    override fun equals(other: Any?): Boolean {
</a><a href="#h304-0-25" id="h304-0-25" class="d">-        return other is SnapUUID &amp;&amp; other.uuidString == uuidString
</a><a href="#h304-0-26" id="h304-0-26" class="d">-    }
</a><a href="#h304-0-27" id="h304-0-27" class="d">-
</a><a href="#h304-0-28" id="h304-0-28" class="d">-    companion object {
</a><a href="#h304-0-29" id="h304-0-29" class="d">-        fun fromString(uuid: String): SnapUUID {
</a><a href="#h304-0-30" id="h304-0-30" class="d">-            return fromUUID(UUID.fromString(uuid))
</a><a href="#h304-0-31" id="h304-0-31" class="d">-        }
</a><a href="#h304-0-32" id="h304-0-32" class="d">-        fun fromBytes(bytes: ByteArray): SnapUUID {
</a><a href="#h304-0-33" id="h304-0-33" class="d">-            val constructor = SnapEnhance.classCache.snapUUID.getConstructor(ByteArray::class.java)
</a><a href="#h304-0-34" id="h304-0-34" class="d">-            return SnapUUID(constructor.newInstance(bytes))
</a><a href="#h304-0-35" id="h304-0-35" class="d">-        }
</a><a href="#h304-0-36" id="h304-0-36" class="d">-        fun fromUUID(uuid: UUID): SnapUUID {
</a><a href="#h304-0-37" id="h304-0-37" class="d">-            val buffer = ByteBuffer.allocate(16)
</a><a href="#h304-0-38" id="h304-0-38" class="d">-            buffer.putLong(uuid.mostSignificantBits)
</a><a href="#h304-0-39" id="h304-0-39" class="d">-            buffer.putLong(uuid.leastSignificantBits)
</a><a href="#h304-0-40" id="h304-0-40" class="d">-            return fromBytes(buffer.array())
</a><a href="#h304-0-41" id="h304-0-41" class="d">-        }
</a><a href="#h304-0-42" id="h304-0-42" class="d">-    }
</a><a href="#h304-0-43" id="h304-0-43" class="d">-}
</a><b>diff --git a/<a id="h305" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/UserIdToReaction.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/UserIdToReaction.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/UserIdToReaction.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/UserIdToReaction.kt</a></b>
<a href="#h305-0" id="h305-0" class="h">@@ -1,11 +0,0 @@
</a><a href="#h305-0-0" id="h305-0-0" class="d">-package me.rhunk.snapenhance.data.wrapper.impl
</a><a href="#h305-0-1" id="h305-0-1" class="d">-
</a><a href="#h305-0-2" id="h305-0-2" class="d">-import me.rhunk.snapenhance.core.util.ktx.getObjectField
</a><a href="#h305-0-3" id="h305-0-3" class="d">-import me.rhunk.snapenhance.data.wrapper.AbstractWrapper
</a><a href="#h305-0-4" id="h305-0-4" class="d">-
</a><a href="#h305-0-5" id="h305-0-5" class="d">-class UserIdToReaction(obj: Any?) : AbstractWrapper(obj) {
</a><a href="#h305-0-6" id="h305-0-6" class="d">-    val userId = SnapUUID(instanceNonNull().getObjectField(&quot;mUserId&quot;))
</a><a href="#h305-0-7" id="h305-0-7" class="d">-    val reactionId = (instanceNonNull().getObjectField(&quot;mReaction&quot;)
</a><a href="#h305-0-8" id="h305-0-8" class="d">-        ?.getObjectField(&quot;mReactionContent&quot;)
</a><a href="#h305-0-9" id="h305-0-9" class="d">-        ?.getObjectField(&quot;mIntentionType&quot;) as Long?) ?: 0
</a><a href="#h305-0-10" id="h305-0-10" class="d">-}</a><a href="#h305-0-11" id="h305-0-11" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h306" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/media/EncryptionWrapper.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/media/EncryptionWrapper.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/media/EncryptionWrapper.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/media/EncryptionWrapper.kt</a></b>
<a href="#h306-0" id="h306-0" class="h">@@ -1,73 +0,0 @@
</a><a href="#h306-0-0" id="h306-0-0" class="d">-package me.rhunk.snapenhance.data.wrapper.impl.media
</a><a href="#h306-0-1" id="h306-0-1" class="d">-
</a><a href="#h306-0-2" id="h306-0-2" class="d">-import me.rhunk.snapenhance.data.wrapper.AbstractWrapper
</a><a href="#h306-0-3" id="h306-0-3" class="d">-import java.io.InputStream
</a><a href="#h306-0-4" id="h306-0-4" class="d">-import java.io.OutputStream
</a><a href="#h306-0-5" id="h306-0-5" class="d">-import java.lang.reflect.Field
</a><a href="#h306-0-6" id="h306-0-6" class="d">-import javax.crypto.Cipher
</a><a href="#h306-0-7" id="h306-0-7" class="d">-import javax.crypto.CipherInputStream
</a><a href="#h306-0-8" id="h306-0-8" class="d">-import javax.crypto.CipherOutputStream
</a><a href="#h306-0-9" id="h306-0-9" class="d">-import javax.crypto.spec.IvParameterSpec
</a><a href="#h306-0-10" id="h306-0-10" class="d">-import javax.crypto.spec.SecretKeySpec
</a><a href="#h306-0-11" id="h306-0-11" class="d">-
</a><a href="#h306-0-12" id="h306-0-12" class="d">-class EncryptionWrapper(instance: Any?) : AbstractWrapper(instance) {
</a><a href="#h306-0-13" id="h306-0-13" class="d">-    fun decrypt(data: ByteArray?): ByteArray {
</a><a href="#h306-0-14" id="h306-0-14" class="d">-        return newCipher(Cipher.DECRYPT_MODE).doFinal(data)
</a><a href="#h306-0-15" id="h306-0-15" class="d">-    }
</a><a href="#h306-0-16" id="h306-0-16" class="d">-
</a><a href="#h306-0-17" id="h306-0-17" class="d">-    fun decrypt(inputStream: InputStream?): InputStream {
</a><a href="#h306-0-18" id="h306-0-18" class="d">-        return CipherInputStream(inputStream, newCipher(Cipher.DECRYPT_MODE))
</a><a href="#h306-0-19" id="h306-0-19" class="d">-    }
</a><a href="#h306-0-20" id="h306-0-20" class="d">-
</a><a href="#h306-0-21" id="h306-0-21" class="d">-    fun decrypt(outputStream: OutputStream?): OutputStream {
</a><a href="#h306-0-22" id="h306-0-22" class="d">-        return CipherOutputStream(outputStream, newCipher(Cipher.DECRYPT_MODE))
</a><a href="#h306-0-23" id="h306-0-23" class="d">-    }
</a><a href="#h306-0-24" id="h306-0-24" class="d">-
</a><a href="#h306-0-25" id="h306-0-25" class="d">-    /**
</a><a href="#h306-0-26" id="h306-0-26" class="d">-     * Search for a byte[] field with the specified length
</a><a href="#h306-0-27" id="h306-0-27" class="d">-     *
</a><a href="#h306-0-28" id="h306-0-28" class="d">-     * @param arrayLength the length of the byte[] field
</a><a href="#h306-0-29" id="h306-0-29" class="d">-     * @return the field
</a><a href="#h306-0-30" id="h306-0-30" class="d">-     */
</a><a href="#h306-0-31" id="h306-0-31" class="d">-    private fun searchByteArrayField(arrayLength: Int): Field {
</a><a href="#h306-0-32" id="h306-0-32" class="d">-        return instanceNonNull()::class.java.fields.first { f -&gt;
</a><a href="#h306-0-33" id="h306-0-33" class="d">-            try {
</a><a href="#h306-0-34" id="h306-0-34" class="d">-                if (!f.type.isArray || f.type
</a><a href="#h306-0-35" id="h306-0-35" class="d">-                        .componentType != Byte::class.javaPrimitiveType
</a><a href="#h306-0-36" id="h306-0-36" class="d">-                ) return@first false
</a><a href="#h306-0-37" id="h306-0-37" class="d">-                return@first (f.get(instanceNonNull()) as ByteArray).size == arrayLength
</a><a href="#h306-0-38" id="h306-0-38" class="d">-            } catch (e: Exception) {
</a><a href="#h306-0-39" id="h306-0-39" class="d">-                return@first false
</a><a href="#h306-0-40" id="h306-0-40" class="d">-            }
</a><a href="#h306-0-41" id="h306-0-41" class="d">-        }
</a><a href="#h306-0-42" id="h306-0-42" class="d">-    }
</a><a href="#h306-0-43" id="h306-0-43" class="d">-
</a><a href="#h306-0-44" id="h306-0-44" class="d">-    /**
</a><a href="#h306-0-45" id="h306-0-45" class="d">-     * Create a new cipher with the specified mode
</a><a href="#h306-0-46" id="h306-0-46" class="d">-     */
</a><a href="#h306-0-47" id="h306-0-47" class="d">-    fun newCipher(mode: Int): Cipher {
</a><a href="#h306-0-48" id="h306-0-48" class="d">-        val cipher = cipher
</a><a href="#h306-0-49" id="h306-0-49" class="d">-        cipher.init(mode, SecretKeySpec(keySpec, &quot;AES&quot;), IvParameterSpec(ivKeyParameterSpec))
</a><a href="#h306-0-50" id="h306-0-50" class="d">-        return cipher
</a><a href="#h306-0-51" id="h306-0-51" class="d">-    }
</a><a href="#h306-0-52" id="h306-0-52" class="d">-
</a><a href="#h306-0-53" id="h306-0-53" class="d">-    /**
</a><a href="#h306-0-54" id="h306-0-54" class="d">-     * Get the cipher from the encryption wrapper
</a><a href="#h306-0-55" id="h306-0-55" class="d">-     */
</a><a href="#h306-0-56" id="h306-0-56" class="d">-    private val cipher: Cipher
</a><a href="#h306-0-57" id="h306-0-57" class="d">-        get() = Cipher.getInstance(&quot;AES/CBC/PKCS5Padding&quot;)
</a><a href="#h306-0-58" id="h306-0-58" class="d">-
</a><a href="#h306-0-59" id="h306-0-59" class="d">-    /**
</a><a href="#h306-0-60" id="h306-0-60" class="d">-     * Get the key spec from the encryption wrapper
</a><a href="#h306-0-61" id="h306-0-61" class="d">-     */
</a><a href="#h306-0-62" id="h306-0-62" class="d">-    val keySpec: ByteArray by lazy {
</a><a href="#h306-0-63" id="h306-0-63" class="d">-        searchByteArrayField(32)[instance] as ByteArray
</a><a href="#h306-0-64" id="h306-0-64" class="d">-    }
</a><a href="#h306-0-65" id="h306-0-65" class="d">-
</a><a href="#h306-0-66" id="h306-0-66" class="d">-    /**
</a><a href="#h306-0-67" id="h306-0-67" class="d">-     * Get the iv key parameter spec from the encryption wrapper
</a><a href="#h306-0-68" id="h306-0-68" class="d">-     */
</a><a href="#h306-0-69" id="h306-0-69" class="d">-    val ivKeyParameterSpec: ByteArray by lazy {
</a><a href="#h306-0-70" id="h306-0-70" class="d">-        searchByteArrayField(16)[instance] as ByteArray
</a><a href="#h306-0-71" id="h306-0-71" class="d">-    }
</a><a href="#h306-0-72" id="h306-0-72" class="d">-}
</a><b>diff --git a/<a id="h307" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/media/MediaInfo.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/media/MediaInfo.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/media/MediaInfo.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/media/MediaInfo.kt</a></b>
<a href="#h307-0" id="h307-0" class="h">@@ -1,34 +0,0 @@
</a><a href="#h307-0-0" id="h307-0-0" class="d">-package me.rhunk.snapenhance.data.wrapper.impl.media
</a><a href="#h307-0-1" id="h307-0-1" class="d">-
</a><a href="#h307-0-2" id="h307-0-2" class="d">-import android.os.Parcelable
</a><a href="#h307-0-3" id="h307-0-3" class="d">-import me.rhunk.snapenhance.core.util.ktx.getObjectField
</a><a href="#h307-0-4" id="h307-0-4" class="d">-import me.rhunk.snapenhance.data.wrapper.AbstractWrapper
</a><a href="#h307-0-5" id="h307-0-5" class="d">-import java.lang.reflect.Field
</a><a href="#h307-0-6" id="h307-0-6" class="d">-
</a><a href="#h307-0-7" id="h307-0-7" class="d">-
</a><a href="#h307-0-8" id="h307-0-8" class="d">-class MediaInfo(obj: Any?) : AbstractWrapper(obj) {
</a><a href="#h307-0-9" id="h307-0-9" class="d">-    val uri: String
</a><a href="#h307-0-10" id="h307-0-10" class="d">-        get() {
</a><a href="#h307-0-11" id="h307-0-11" class="d">-            val firstStringUriField = instanceNonNull().javaClass.fields.first { f: Field -&gt; f.type == String::class.java }
</a><a href="#h307-0-12" id="h307-0-12" class="d">-            return instanceNonNull().getObjectField(firstStringUriField.name) as String
</a><a href="#h307-0-13" id="h307-0-13" class="d">-        }
</a><a href="#h307-0-14" id="h307-0-14" class="d">-
</a><a href="#h307-0-15" id="h307-0-15" class="d">-    init {
</a><a href="#h307-0-16" id="h307-0-16" class="d">-        instance?.let {
</a><a href="#h307-0-17" id="h307-0-17" class="d">-            if (it is List&lt;*&gt;) {
</a><a href="#h307-0-18" id="h307-0-18" class="d">-                if (it.size == 0) {
</a><a href="#h307-0-19" id="h307-0-19" class="d">-                    throw RuntimeException(&quot;MediaInfo is empty&quot;)
</a><a href="#h307-0-20" id="h307-0-20" class="d">-                }
</a><a href="#h307-0-21" id="h307-0-21" class="d">-                instance = it[0]!!
</a><a href="#h307-0-22" id="h307-0-22" class="d">-            }
</a><a href="#h307-0-23" id="h307-0-23" class="d">-        }
</a><a href="#h307-0-24" id="h307-0-24" class="d">-    }
</a><a href="#h307-0-25" id="h307-0-25" class="d">-
</a><a href="#h307-0-26" id="h307-0-26" class="d">-    val encryption: EncryptionWrapper?
</a><a href="#h307-0-27" id="h307-0-27" class="d">-        get() {
</a><a href="#h307-0-28" id="h307-0-28" class="d">-            val encryptionAlgorithmField = instanceNonNull().javaClass.fields.first { f: Field -&gt;
</a><a href="#h307-0-29" id="h307-0-29" class="d">-                f.type.isInterface &amp;&amp; Parcelable::class.java.isAssignableFrom(f.type)
</a><a href="#h307-0-30" id="h307-0-30" class="d">-            }
</a><a href="#h307-0-31" id="h307-0-31" class="d">-            return encryptionAlgorithmField[instance]?.let { EncryptionWrapper(it) }
</a><a href="#h307-0-32" id="h307-0-32" class="d">-        }
</a><a href="#h307-0-33" id="h307-0-33" class="d">-}
</a><b>diff --git a/<a id="h308" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/media/dash/LongformVideoPlaylistItem.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/media/dash/LongformVideoPlaylistItem.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/media/dash/LongformVideoPlaylistItem.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/media/dash/LongformVideoPlaylistItem.kt</a></b>
<a href="#h308-0" id="h308-0" class="h">@@ -1,11 +0,0 @@
</a><a href="#h308-0-0" id="h308-0-0" class="d">-package me.rhunk.snapenhance.data.wrapper.impl.media.dash
</a><a href="#h308-0-1" id="h308-0-1" class="d">-
</a><a href="#h308-0-2" id="h308-0-2" class="d">-import me.rhunk.snapenhance.data.wrapper.AbstractWrapper
</a><a href="#h308-0-3" id="h308-0-3" class="d">-
</a><a href="#h308-0-4" id="h308-0-4" class="d">-class LongformVideoPlaylistItem(obj: Any?) : AbstractWrapper(obj) {
</a><a href="#h308-0-5" id="h308-0-5" class="d">-    private val chapterList by lazy {
</a><a href="#h308-0-6" id="h308-0-6" class="d">-        instanceNonNull().javaClass.declaredFields.first { it.type == List::class.java }
</a><a href="#h308-0-7" id="h308-0-7" class="d">-    }
</a><a href="#h308-0-8" id="h308-0-8" class="d">-    val chapters: List&lt;SnapChapter&gt;
</a><a href="#h308-0-9" id="h308-0-9" class="d">-        get() = (chapterList.get(instanceNonNull()) as List&lt;*&gt;).map { SnapChapter(it) }
</a><a href="#h308-0-10" id="h308-0-10" class="d">-}</a><a href="#h308-0-11" id="h308-0-11" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h309" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/media/dash/SnapChapter.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/media/dash/SnapChapter.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/media/dash/SnapChapter.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/media/dash/SnapChapter.kt</a></b>
<a href="#h309-0" id="h309-0" class="h">@@ -1,12 +0,0 @@
</a><a href="#h309-0-0" id="h309-0-0" class="d">-package me.rhunk.snapenhance.data.wrapper.impl.media.dash
</a><a href="#h309-0-1" id="h309-0-1" class="d">-
</a><a href="#h309-0-2" id="h309-0-2" class="d">-import me.rhunk.snapenhance.data.wrapper.AbstractWrapper
</a><a href="#h309-0-3" id="h309-0-3" class="d">-
</a><a href="#h309-0-4" id="h309-0-4" class="d">-class SnapChapter (obj: Any?) : AbstractWrapper(obj) {
</a><a href="#h309-0-5" id="h309-0-5" class="d">-    val snapId by lazy {
</a><a href="#h309-0-6" id="h309-0-6" class="d">-        instanceNonNull().javaClass.declaredFields.first { it.type == Long::class.javaPrimitiveType }.get(instanceNonNull()) as Long
</a><a href="#h309-0-7" id="h309-0-7" class="d">-    }
</a><a href="#h309-0-8" id="h309-0-8" class="d">-    val startTimeMs by lazy {
</a><a href="#h309-0-9" id="h309-0-9" class="d">-        instanceNonNull().javaClass.declaredFields.filter { it.type == Long::class.javaPrimitiveType }[1].get(instanceNonNull()) as Long
</a><a href="#h309-0-10" id="h309-0-10" class="d">-    }
</a><a href="#h309-0-11" id="h309-0-11" class="d">-}</a><a href="#h309-0-12" id="h309-0-12" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h310" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/media/dash/SnapPlaylistItem.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/media/dash/SnapPlaylistItem.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/media/dash/SnapPlaylistItem.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/media/dash/SnapPlaylistItem.kt</a></b>
<a href="#h310-0" id="h310-0" class="h">@@ -1,9 +0,0 @@
</a><a href="#h310-0-0" id="h310-0-0" class="d">-package me.rhunk.snapenhance.data.wrapper.impl.media.dash
</a><a href="#h310-0-1" id="h310-0-1" class="d">-
</a><a href="#h310-0-2" id="h310-0-2" class="d">-import me.rhunk.snapenhance.data.wrapper.AbstractWrapper
</a><a href="#h310-0-3" id="h310-0-3" class="d">-
</a><a href="#h310-0-4" id="h310-0-4" class="d">-class SnapPlaylistItem (obj: Any?) : AbstractWrapper(obj) {
</a><a href="#h310-0-5" id="h310-0-5" class="d">-    val snapId by lazy {
</a><a href="#h310-0-6" id="h310-0-6" class="d">-        instanceNonNull().javaClass.declaredFields.first { it.type == Long::class.javaPrimitiveType }.get(instanceNonNull()) as Long
</a><a href="#h310-0-7" id="h310-0-7" class="d">-    }
</a><a href="#h310-0-8" id="h310-0-8" class="d">-}</a><a href="#h310-0-9" id="h310-0-9" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h311" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/media/opera/Layer.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/media/opera/Layer.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/media/opera/Layer.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/media/opera/Layer.kt</a></b>
<a href="#h311-0" id="h311-0" class="h">@@ -1,21 +0,0 @@
</a><a href="#h311-0-0" id="h311-0-0" class="d">-package me.rhunk.snapenhance.data.wrapper.impl.media.opera
</a><a href="#h311-0-1" id="h311-0-1" class="d">-
</a><a href="#h311-0-2" id="h311-0-2" class="d">-import me.rhunk.snapenhance.core.util.ReflectionHelper
</a><a href="#h311-0-3" id="h311-0-3" class="d">-import me.rhunk.snapenhance.data.wrapper.AbstractWrapper
</a><a href="#h311-0-4" id="h311-0-4" class="d">-
</a><a href="#h311-0-5" id="h311-0-5" class="d">-class Layer(obj: Any?) : AbstractWrapper(obj) {
</a><a href="#h311-0-6" id="h311-0-6" class="d">-    val paramMap: ParamMap
</a><a href="#h311-0-7" id="h311-0-7" class="d">-        get() {
</a><a href="#h311-0-8" id="h311-0-8" class="d">-            val layerControllerField = ReflectionHelper.searchFieldContainsToString(
</a><a href="#h311-0-9" id="h311-0-9" class="d">-                instanceNonNull()::class.java,
</a><a href="#h311-0-10" id="h311-0-10" class="d">-                instance,
</a><a href="#h311-0-11" id="h311-0-11" class="d">-                &quot;OperaPageModel&quot;
</a><a href="#h311-0-12" id="h311-0-12" class="d">-            )!!
</a><a href="#h311-0-13" id="h311-0-13" class="d">-
</a><a href="#h311-0-14" id="h311-0-14" class="d">-            val paramsMapHashMap = ReflectionHelper.searchFieldStartsWithToString(
</a><a href="#h311-0-15" id="h311-0-15" class="d">-                layerControllerField.type,
</a><a href="#h311-0-16" id="h311-0-16" class="d">-                layerControllerField[instance] as Any, &quot;OperaPageModel&quot;
</a><a href="#h311-0-17" id="h311-0-17" class="d">-            )!!
</a><a href="#h311-0-18" id="h311-0-18" class="d">-            return ParamMap(paramsMapHashMap[layerControllerField[instance]]!!)
</a><a href="#h311-0-19" id="h311-0-19" class="d">-        }
</a><a href="#h311-0-20" id="h311-0-20" class="d">-}
</a><b>diff --git a/<a id="h312" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/media/opera/LayerController.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/media/opera/LayerController.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/media/opera/LayerController.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/media/opera/LayerController.kt</a></b>
<a href="#h312-0" id="h312-0" class="h">@@ -1,18 +0,0 @@
</a><a href="#h312-0-0" id="h312-0-0" class="d">-package me.rhunk.snapenhance.data.wrapper.impl.media.opera
</a><a href="#h312-0-1" id="h312-0-1" class="d">-
</a><a href="#h312-0-2" id="h312-0-2" class="d">-import de.robv.android.xposed.XposedHelpers
</a><a href="#h312-0-3" id="h312-0-3" class="d">-import me.rhunk.snapenhance.core.util.ReflectionHelper
</a><a href="#h312-0-4" id="h312-0-4" class="d">-import me.rhunk.snapenhance.data.wrapper.AbstractWrapper
</a><a href="#h312-0-5" id="h312-0-5" class="d">-import java.lang.reflect.Field
</a><a href="#h312-0-6" id="h312-0-6" class="d">-import java.util.concurrent.ConcurrentHashMap
</a><a href="#h312-0-7" id="h312-0-7" class="d">-
</a><a href="#h312-0-8" id="h312-0-8" class="d">-class LayerController(obj: Any?) : AbstractWrapper(obj) {
</a><a href="#h312-0-9" id="h312-0-9" class="d">-    val paramMap: ParamMap
</a><a href="#h312-0-10" id="h312-0-10" class="d">-        get() {
</a><a href="#h312-0-11" id="h312-0-11" class="d">-            val paramMapField: Field = ReflectionHelper.searchFieldTypeInSuperClasses(
</a><a href="#h312-0-12" id="h312-0-12" class="d">-                instanceNonNull()::class.java,
</a><a href="#h312-0-13" id="h312-0-13" class="d">-                ConcurrentHashMap::class.java
</a><a href="#h312-0-14" id="h312-0-14" class="d">-            ) ?: throw RuntimeException(&quot;Could not find paramMap field&quot;)
</a><a href="#h312-0-15" id="h312-0-15" class="d">-            return ParamMap(XposedHelpers.getObjectField(instance, paramMapField.name))
</a><a href="#h312-0-16" id="h312-0-16" class="d">-        }
</a><a href="#h312-0-17" id="h312-0-17" class="d">-}
</a><b>diff --git a/<a id="h313" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/media/opera/ParamMap.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/media/opera/ParamMap.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/media/opera/ParamMap.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/media/opera/ParamMap.kt</a></b>
<a href="#h313-0" id="h313-0" class="h">@@ -1,37 +0,0 @@
</a><a href="#h313-0-0" id="h313-0-0" class="d">-package me.rhunk.snapenhance.data.wrapper.impl.media.opera
</a><a href="#h313-0-1" id="h313-0-1" class="d">-
</a><a href="#h313-0-2" id="h313-0-2" class="d">-import me.rhunk.snapenhance.core.util.ReflectionHelper
</a><a href="#h313-0-3" id="h313-0-3" class="d">-import me.rhunk.snapenhance.core.util.ktx.getObjectField
</a><a href="#h313-0-4" id="h313-0-4" class="d">-import me.rhunk.snapenhance.data.wrapper.AbstractWrapper
</a><a href="#h313-0-5" id="h313-0-5" class="d">-import java.lang.reflect.Field
</a><a href="#h313-0-6" id="h313-0-6" class="d">-import java.util.concurrent.ConcurrentHashMap
</a><a href="#h313-0-7" id="h313-0-7" class="d">-
</a><a href="#h313-0-8" id="h313-0-8" class="d">-@Suppress(&quot;UNCHECKED_CAST&quot;)
</a><a href="#h313-0-9" id="h313-0-9" class="d">-class ParamMap(obj: Any?) : AbstractWrapper(obj) {
</a><a href="#h313-0-10" id="h313-0-10" class="d">-    private val paramMapField: Field by lazy {
</a><a href="#h313-0-11" id="h313-0-11" class="d">-        ReflectionHelper.searchFieldTypeInSuperClasses(
</a><a href="#h313-0-12" id="h313-0-12" class="d">-            instanceNonNull().javaClass,
</a><a href="#h313-0-13" id="h313-0-13" class="d">-            ConcurrentHashMap::class.java
</a><a href="#h313-0-14" id="h313-0-14" class="d">-        )!!
</a><a href="#h313-0-15" id="h313-0-15" class="d">-    }
</a><a href="#h313-0-16" id="h313-0-16" class="d">-
</a><a href="#h313-0-17" id="h313-0-17" class="d">-    val concurrentHashMap: ConcurrentHashMap&lt;Any, Any&gt;
</a><a href="#h313-0-18" id="h313-0-18" class="d">-        get() = instanceNonNull().getObjectField(paramMapField.name) as ConcurrentHashMap&lt;Any, Any&gt;
</a><a href="#h313-0-19" id="h313-0-19" class="d">-
</a><a href="#h313-0-20" id="h313-0-20" class="d">-    operator fun get(key: String): Any? {
</a><a href="#h313-0-21" id="h313-0-21" class="d">-        return concurrentHashMap.keys.firstOrNull{ k: Any -&gt; k.toString() == key }?.let { concurrentHashMap[it] }
</a><a href="#h313-0-22" id="h313-0-22" class="d">-    }
</a><a href="#h313-0-23" id="h313-0-23" class="d">-
</a><a href="#h313-0-24" id="h313-0-24" class="d">-    fun put(key: String, value: Any) {
</a><a href="#h313-0-25" id="h313-0-25" class="d">-        val keyObject = concurrentHashMap.keys.firstOrNull { k: Any -&gt; k.toString() == key } ?: key
</a><a href="#h313-0-26" id="h313-0-26" class="d">-        concurrentHashMap[keyObject] = value
</a><a href="#h313-0-27" id="h313-0-27" class="d">-    }
</a><a href="#h313-0-28" id="h313-0-28" class="d">-
</a><a href="#h313-0-29" id="h313-0-29" class="d">-    fun containsKey(key: String): Boolean {
</a><a href="#h313-0-30" id="h313-0-30" class="d">-        return concurrentHashMap.keys.any { k: Any -&gt; k.toString() == key }
</a><a href="#h313-0-31" id="h313-0-31" class="d">-    }
</a><a href="#h313-0-32" id="h313-0-32" class="d">-
</a><a href="#h313-0-33" id="h313-0-33" class="d">-    override fun toString(): String {
</a><a href="#h313-0-34" id="h313-0-34" class="d">-        return concurrentHashMap.toString()
</a><a href="#h313-0-35" id="h313-0-35" class="d">-    }
</a><a href="#h313-0-36" id="h313-0-36" class="d">-}
</a><b>diff --git a/<a id="h314" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/BridgeFileFeature.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/BridgeFileFeature.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/BridgeFileFeature.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/BridgeFileFeature.kt</a></b>
<a href="#h314-0" id="h314-0" class="h">@@ -1,54 +0,0 @@
</a><a href="#h314-0-0" id="h314-0-0" class="d">-package me.rhunk.snapenhance.features
</a><a href="#h314-0-1" id="h314-0-1" class="d">-
</a><a href="#h314-0-2" id="h314-0-2" class="d">-import me.rhunk.snapenhance.core.bridge.types.BridgeFileType
</a><a href="#h314-0-3" id="h314-0-3" class="d">-import java.io.BufferedReader
</a><a href="#h314-0-4" id="h314-0-4" class="d">-import java.io.ByteArrayInputStream
</a><a href="#h314-0-5" id="h314-0-5" class="d">-import java.io.InputStreamReader
</a><a href="#h314-0-6" id="h314-0-6" class="d">-import java.nio.charset.StandardCharsets
</a><a href="#h314-0-7" id="h314-0-7" class="d">-
</a><a href="#h314-0-8" id="h314-0-8" class="d">-abstract class BridgeFileFeature(name: String, private val bridgeFileType: BridgeFileType, loadParams: Int) : Feature(name, loadParams) {
</a><a href="#h314-0-9" id="h314-0-9" class="d">-    private val fileLines = mutableListOf&lt;String&gt;()
</a><a href="#h314-0-10" id="h314-0-10" class="d">-
</a><a href="#h314-0-11" id="h314-0-11" class="d">-    protected fun readFile() {
</a><a href="#h314-0-12" id="h314-0-12" class="d">-        val temporaryLines = mutableListOf&lt;String&gt;()
</a><a href="#h314-0-13" id="h314-0-13" class="d">-        val fileData: ByteArray = context.bridgeClient.createAndReadFile(bridgeFileType, ByteArray(0))
</a><a href="#h314-0-14" id="h314-0-14" class="d">-        with(BufferedReader(InputStreamReader(ByteArrayInputStream(fileData), StandardCharsets.UTF_8))) {
</a><a href="#h314-0-15" id="h314-0-15" class="d">-            var line = &quot;&quot;
</a><a href="#h314-0-16" id="h314-0-16" class="d">-            while (readLine()?.also { line = it } != null) temporaryLines.add(line)
</a><a href="#h314-0-17" id="h314-0-17" class="d">-            close()
</a><a href="#h314-0-18" id="h314-0-18" class="d">-        }
</a><a href="#h314-0-19" id="h314-0-19" class="d">-        fileLines.clear()
</a><a href="#h314-0-20" id="h314-0-20" class="d">-        fileLines.addAll(temporaryLines)
</a><a href="#h314-0-21" id="h314-0-21" class="d">-    }
</a><a href="#h314-0-22" id="h314-0-22" class="d">-
</a><a href="#h314-0-23" id="h314-0-23" class="d">-    private fun updateFile() {
</a><a href="#h314-0-24" id="h314-0-24" class="d">-        val sb = StringBuilder()
</a><a href="#h314-0-25" id="h314-0-25" class="d">-        fileLines.forEach {
</a><a href="#h314-0-26" id="h314-0-26" class="d">-            sb.append(it).append(&quot;\n&quot;)
</a><a href="#h314-0-27" id="h314-0-27" class="d">-        }
</a><a href="#h314-0-28" id="h314-0-28" class="d">-        context.bridgeClient.writeFile(bridgeFileType, sb.toString().toByteArray(Charsets.UTF_8))
</a><a href="#h314-0-29" id="h314-0-29" class="d">-    }
</a><a href="#h314-0-30" id="h314-0-30" class="d">-
</a><a href="#h314-0-31" id="h314-0-31" class="d">-    protected fun exists(line: String) = fileLines.contains(line)
</a><a href="#h314-0-32" id="h314-0-32" class="d">-
</a><a href="#h314-0-33" id="h314-0-33" class="d">-    protected fun toggle(line: String) {
</a><a href="#h314-0-34" id="h314-0-34" class="d">-        if (exists(line)) fileLines.remove(line) else fileLines.add(line)
</a><a href="#h314-0-35" id="h314-0-35" class="d">-        updateFile()
</a><a href="#h314-0-36" id="h314-0-36" class="d">-    }
</a><a href="#h314-0-37" id="h314-0-37" class="d">-
</a><a href="#h314-0-38" id="h314-0-38" class="d">-    protected fun setState(line: String, state: Boolean) {
</a><a href="#h314-0-39" id="h314-0-39" class="d">-        if (state) {
</a><a href="#h314-0-40" id="h314-0-40" class="d">-            if (!exists(line)) fileLines.add(line)
</a><a href="#h314-0-41" id="h314-0-41" class="d">-        } else {
</a><a href="#h314-0-42" id="h314-0-42" class="d">-            if (exists(line)) fileLines.remove(line)
</a><a href="#h314-0-43" id="h314-0-43" class="d">-        }
</a><a href="#h314-0-44" id="h314-0-44" class="d">-        updateFile()
</a><a href="#h314-0-45" id="h314-0-45" class="d">-    }
</a><a href="#h314-0-46" id="h314-0-46" class="d">-
</a><a href="#h314-0-47" id="h314-0-47" class="d">-    protected fun reload() = readFile()
</a><a href="#h314-0-48" id="h314-0-48" class="d">-
</a><a href="#h314-0-49" id="h314-0-49" class="d">-    protected fun put(line: String) {
</a><a href="#h314-0-50" id="h314-0-50" class="d">-        fileLines.add(line)
</a><a href="#h314-0-51" id="h314-0-51" class="d">-        updateFile()
</a><a href="#h314-0-52" id="h314-0-52" class="d">-    }
</a><a href="#h314-0-53" id="h314-0-53" class="d">-}</a><a href="#h314-0-54" id="h314-0-54" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h315" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/Feature.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/Feature.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/Feature.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/Feature.kt</a></b>
<a href="#h315-0" id="h315-0" class="h">@@ -1,39 +0,0 @@
</a><a href="#h315-0-0" id="h315-0-0" class="d">-package me.rhunk.snapenhance.features
</a><a href="#h315-0-1" id="h315-0-1" class="d">-
</a><a href="#h315-0-2" id="h315-0-2" class="d">-import me.rhunk.snapenhance.ModContext
</a><a href="#h315-0-3" id="h315-0-3" class="d">-
</a><a href="#h315-0-4" id="h315-0-4" class="d">-abstract class Feature(
</a><a href="#h315-0-5" id="h315-0-5" class="d">-    val featureKey: String,
</a><a href="#h315-0-6" id="h315-0-6" class="d">-    val loadParams: Int = FeatureLoadParams.INIT_SYNC
</a><a href="#h315-0-7" id="h315-0-7" class="d">-) {
</a><a href="#h315-0-8" id="h315-0-8" class="d">-    lateinit var context: ModContext
</a><a href="#h315-0-9" id="h315-0-9" class="d">-
</a><a href="#h315-0-10" id="h315-0-10" class="d">-    /**
</a><a href="#h315-0-11" id="h315-0-11" class="d">-     * called on the main thread when the mod initialize
</a><a href="#h315-0-12" id="h315-0-12" class="d">-     */
</a><a href="#h315-0-13" id="h315-0-13" class="d">-    open fun init() {}
</a><a href="#h315-0-14" id="h315-0-14" class="d">-
</a><a href="#h315-0-15" id="h315-0-15" class="d">-    /**
</a><a href="#h315-0-16" id="h315-0-16" class="d">-     * called on a dedicated thread when the mod initialize
</a><a href="#h315-0-17" id="h315-0-17" class="d">-     */
</a><a href="#h315-0-18" id="h315-0-18" class="d">-    open fun asyncInit() {}
</a><a href="#h315-0-19" id="h315-0-19" class="d">-
</a><a href="#h315-0-20" id="h315-0-20" class="d">-    /**
</a><a href="#h315-0-21" id="h315-0-21" class="d">-     * called when the Snapchat Activity is created
</a><a href="#h315-0-22" id="h315-0-22" class="d">-     */
</a><a href="#h315-0-23" id="h315-0-23" class="d">-    open fun onActivityCreate() {}
</a><a href="#h315-0-24" id="h315-0-24" class="d">-
</a><a href="#h315-0-25" id="h315-0-25" class="d">-
</a><a href="#h315-0-26" id="h315-0-26" class="d">-    /**
</a><a href="#h315-0-27" id="h315-0-27" class="d">-     * called on a dedicated thread when the Snapchat Activity is created
</a><a href="#h315-0-28" id="h315-0-28" class="d">-     */
</a><a href="#h315-0-29" id="h315-0-29" class="d">-    open fun asyncOnActivityCreate() {}
</a><a href="#h315-0-30" id="h315-0-30" class="d">-
</a><a href="#h315-0-31" id="h315-0-31" class="d">-    protected fun findClass(name: String): Class&lt;*&gt; {
</a><a href="#h315-0-32" id="h315-0-32" class="d">-        return context.androidContext.classLoader.loadClass(name)
</a><a href="#h315-0-33" id="h315-0-33" class="d">-    }
</a><a href="#h315-0-34" id="h315-0-34" class="d">-
</a><a href="#h315-0-35" id="h315-0-35" class="d">-    protected fun runOnUiThread(block: () -&gt; Unit) {
</a><a href="#h315-0-36" id="h315-0-36" class="d">-        context.runOnUiThread(block)
</a><a href="#h315-0-37" id="h315-0-37" class="d">-    }
</a><a href="#h315-0-38" id="h315-0-38" class="d">-}</a><a href="#h315-0-39" id="h315-0-39" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h316" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/FeatureLoadParams.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/FeatureLoadParams.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/FeatureLoadParams.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/FeatureLoadParams.kt</a></b>
<a href="#h316-0" id="h316-0" class="h">@@ -1,11 +0,0 @@
</a><a href="#h316-0-0" id="h316-0-0" class="d">-package me.rhunk.snapenhance.features
</a><a href="#h316-0-1" id="h316-0-1" class="d">-
</a><a href="#h316-0-2" id="h316-0-2" class="d">-object FeatureLoadParams {
</a><a href="#h316-0-3" id="h316-0-3" class="d">-    const val NO_INIT = 0
</a><a href="#h316-0-4" id="h316-0-4" class="d">-
</a><a href="#h316-0-5" id="h316-0-5" class="d">-    const val INIT_SYNC = 0b0001
</a><a href="#h316-0-6" id="h316-0-6" class="d">-    const val ACTIVITY_CREATE_SYNC = 0b0010
</a><a href="#h316-0-7" id="h316-0-7" class="d">-
</a><a href="#h316-0-8" id="h316-0-8" class="d">-    const val INIT_ASYNC = 0b0100
</a><a href="#h316-0-9" id="h316-0-9" class="d">-    const val ACTIVITY_CREATE_ASYNC = 0b1000
</a><a href="#h316-0-10" id="h316-0-10" class="d">-}</a><a href="#h316-0-11" id="h316-0-11" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h317" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/MessagingRuleFeature.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/MessagingRuleFeature.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/MessagingRuleFeature.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/MessagingRuleFeature.kt</a></b>
<a href="#h317-0" id="h317-0" class="h">@@ -1,30 +0,0 @@
</a><a href="#h317-0-0" id="h317-0-0" class="d">-package me.rhunk.snapenhance.features
</a><a href="#h317-0-1" id="h317-0-1" class="d">-
</a><a href="#h317-0-2" id="h317-0-2" class="d">-import me.rhunk.snapenhance.core.messaging.MessagingRuleType
</a><a href="#h317-0-3" id="h317-0-3" class="d">-import me.rhunk.snapenhance.core.messaging.RuleState
</a><a href="#h317-0-4" id="h317-0-4" class="d">-
</a><a href="#h317-0-5" id="h317-0-5" class="d">-abstract class MessagingRuleFeature(name: String, val ruleType: MessagingRuleType, loadParams: Int = 0) : Feature(name, loadParams) {
</a><a href="#h317-0-6" id="h317-0-6" class="d">-
</a><a href="#h317-0-7" id="h317-0-7" class="d">-    open fun getRuleState() = context.config.rules.getRuleState(ruleType)
</a><a href="#h317-0-8" id="h317-0-8" class="d">-
</a><a href="#h317-0-9" id="h317-0-9" class="d">-    fun setState(conversationId: String, state: Boolean) {
</a><a href="#h317-0-10" id="h317-0-10" class="d">-        context.bridgeClient.setRule(
</a><a href="#h317-0-11" id="h317-0-11" class="d">-            context.database.getDMOtherParticipant(conversationId) ?: conversationId,
</a><a href="#h317-0-12" id="h317-0-12" class="d">-            ruleType,
</a><a href="#h317-0-13" id="h317-0-13" class="d">-            state
</a><a href="#h317-0-14" id="h317-0-14" class="d">-        )
</a><a href="#h317-0-15" id="h317-0-15" class="d">-    }
</a><a href="#h317-0-16" id="h317-0-16" class="d">-
</a><a href="#h317-0-17" id="h317-0-17" class="d">-    fun getState(conversationId: String) =
</a><a href="#h317-0-18" id="h317-0-18" class="d">-        context.bridgeClient.getRules(
</a><a href="#h317-0-19" id="h317-0-19" class="d">-            context.database.getDMOtherParticipant(conversationId) ?: conversationId
</a><a href="#h317-0-20" id="h317-0-20" class="d">-        ).contains(ruleType) &amp;&amp; getRuleState() != null
</a><a href="#h317-0-21" id="h317-0-21" class="d">-
</a><a href="#h317-0-22" id="h317-0-22" class="d">-    fun canUseRule(conversationId: String): Boolean {
</a><a href="#h317-0-23" id="h317-0-23" class="d">-        val state = getState(conversationId)
</a><a href="#h317-0-24" id="h317-0-24" class="d">-        if (context.config.rules.getRuleState(ruleType) == RuleState.BLACKLIST) {
</a><a href="#h317-0-25" id="h317-0-25" class="d">-            return !state
</a><a href="#h317-0-26" id="h317-0-26" class="d">-        }
</a><a href="#h317-0-27" id="h317-0-27" class="d">-        return state
</a><a href="#h317-0-28" id="h317-0-28" class="d">-    }
</a><a href="#h317-0-29" id="h317-0-29" class="d">-}</a><a href="#h317-0-30" id="h317-0-30" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h318" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/ConfigurationOverride.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/ConfigurationOverride.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/ConfigurationOverride.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/ConfigurationOverride.kt</a></b>
<a href="#h318-0" id="h318-0" class="h">@@ -1,81 +0,0 @@
</a><a href="#h318-0-0" id="h318-0-0" class="d">-package me.rhunk.snapenhance.features.impl
</a><a href="#h318-0-1" id="h318-0-1" class="d">-
</a><a href="#h318-0-2" id="h318-0-2" class="d">-import de.robv.android.xposed.XposedHelpers
</a><a href="#h318-0-3" id="h318-0-3" class="d">-import me.rhunk.snapenhance.core.util.ktx.setObjectField
</a><a href="#h318-0-4" id="h318-0-4" class="d">-import me.rhunk.snapenhance.features.Feature
</a><a href="#h318-0-5" id="h318-0-5" class="d">-import me.rhunk.snapenhance.features.FeatureLoadParams
</a><a href="#h318-0-6" id="h318-0-6" class="d">-import me.rhunk.snapenhance.hook.HookStage
</a><a href="#h318-0-7" id="h318-0-7" class="d">-import me.rhunk.snapenhance.hook.hook
</a><a href="#h318-0-8" id="h318-0-8" class="d">-
</a><a href="#h318-0-9" id="h318-0-9" class="d">-class ConfigurationOverride : Feature(&quot;Configuration Override&quot;, loadParams = FeatureLoadParams.INIT_SYNC) {
</a><a href="#h318-0-10" id="h318-0-10" class="d">-    override fun init() {
</a><a href="#h318-0-11" id="h318-0-11" class="d">-        val propertyOverrides = mutableMapOf&lt;String, Pair&lt;(() -&gt; Boolean), Any&gt;&gt;()
</a><a href="#h318-0-12" id="h318-0-12" class="d">-
</a><a href="#h318-0-13" id="h318-0-13" class="d">-        fun overrideProperty(key: String, filter: () -&gt; Boolean, value: Any) {
</a><a href="#h318-0-14" id="h318-0-14" class="d">-            propertyOverrides[key] = Pair(filter, value)
</a><a href="#h318-0-15" id="h318-0-15" class="d">-        }
</a><a href="#h318-0-16" id="h318-0-16" class="d">-
</a><a href="#h318-0-17" id="h318-0-17" class="d">-        overrideProperty(&quot;STREAK_EXPIRATION_INFO&quot;, { context.config.userInterface.streakExpirationInfo.get() }, true)
</a><a href="#h318-0-18" id="h318-0-18" class="d">-
</a><a href="#h318-0-19" id="h318-0-19" class="d">-        overrideProperty(&quot;MEDIA_RECORDER_MAX_QUALITY_LEVEL&quot;, { context.config.camera.forceCameraSourceEncoding.get() }, true)
</a><a href="#h318-0-20" id="h318-0-20" class="d">-        overrideProperty(&quot;REDUCE_MY_PROFILE_UI_COMPLEXITY&quot;, { context.config.userInterface.mapFriendNameTags.get() }, true)
</a><a href="#h318-0-21" id="h318-0-21" class="d">-        overrideProperty(&quot;ENABLE_LONG_SNAP_SENDING&quot;, { context.config.global.disableSnapSplitting.get() }, true)
</a><a href="#h318-0-22" id="h318-0-22" class="d">-
</a><a href="#h318-0-23" id="h318-0-23" class="d">-        context.config.userInterface.storyViewerOverride.getNullable()?.let { state -&gt;
</a><a href="#h318-0-24" id="h318-0-24" class="d">-            overrideProperty(&quot;DF_ENABLE_SHOWS_PAGE_CONTROLS&quot;, { state == &quot;DISCOVER_PLAYBACK_SEEKBAR&quot; }, true)
</a><a href="#h318-0-25" id="h318-0-25" class="d">-            overrideProperty(&quot;DF_VOPERA_FOR_STORIES&quot;, { state == &quot;VERTICAL_STORY_VIEWER&quot; }, true)
</a><a href="#h318-0-26" id="h318-0-26" class="d">-        }
</a><a href="#h318-0-27" id="h318-0-27" class="d">-
</a><a href="#h318-0-28" id="h318-0-28" class="d">-        overrideProperty(&quot;SPOTLIGHT_5TH_TAB_ENABLED&quot;, { context.config.userInterface.disableSpotlight.get() }, false)
</a><a href="#h318-0-29" id="h318-0-29" class="d">-
</a><a href="#h318-0-30" id="h318-0-30" class="d">-        overrideProperty(&quot;BYPASS_AD_FEATURE_GATE&quot;, { context.config.global.blockAds.get() }, true)
</a><a href="#h318-0-31" id="h318-0-31" class="d">-        arrayOf(&quot;CUSTOM_AD_TRACKER_URL&quot;, &quot;CUSTOM_AD_INIT_SERVER_URL&quot;, &quot;CUSTOM_AD_SERVER_URL&quot;).forEach {
</a><a href="#h318-0-32" id="h318-0-32" class="d">-            overrideProperty(it, { context.config.global.blockAds.get() }, &quot;http://127.0.0.1&quot;)
</a><a href="#h318-0-33" id="h318-0-33" class="d">-        }
</a><a href="#h318-0-34" id="h318-0-34" class="d">-
</a><a href="#h318-0-35" id="h318-0-35" class="d">-        val compositeConfigurationProviderMappings = context.mappings.getMappedMap(&quot;CompositeConfigurationProvider&quot;)
</a><a href="#h318-0-36" id="h318-0-36" class="d">-        val enumMappings = compositeConfigurationProviderMappings[&quot;enum&quot;] as Map&lt;*, *&gt;
</a><a href="#h318-0-37" id="h318-0-37" class="d">-
</a><a href="#h318-0-38" id="h318-0-38" class="d">-        findClass(compositeConfigurationProviderMappings[&quot;class&quot;].toString()).hook(
</a><a href="#h318-0-39" id="h318-0-39" class="d">-            compositeConfigurationProviderMappings[&quot;observeProperty&quot;].toString(),
</a><a href="#h318-0-40" id="h318-0-40" class="d">-            HookStage.BEFORE
</a><a href="#h318-0-41" id="h318-0-41" class="d">-        ) { param -&gt;
</a><a href="#h318-0-42" id="h318-0-42" class="d">-            val enumData = param.arg&lt;Any&gt;(0)
</a><a href="#h318-0-43" id="h318-0-43" class="d">-            val key = enumData.toString()
</a><a href="#h318-0-44" id="h318-0-44" class="d">-            val setValue: (Any?) -&gt; Unit = { value -&gt;
</a><a href="#h318-0-45" id="h318-0-45" class="d">-                val valueHolder = XposedHelpers.callMethod(enumData, enumMappings[&quot;getValue&quot;].toString())
</a><a href="#h318-0-46" id="h318-0-46" class="d">-                valueHolder.setObjectField(enumMappings[&quot;defaultValueField&quot;].toString(), value)
</a><a href="#h318-0-47" id="h318-0-47" class="d">-            }
</a><a href="#h318-0-48" id="h318-0-48" class="d">-
</a><a href="#h318-0-49" id="h318-0-49" class="d">-            propertyOverrides[key]?.let { (filter, value) -&gt;
</a><a href="#h318-0-50" id="h318-0-50" class="d">-                if (!filter()) return@let
</a><a href="#h318-0-51" id="h318-0-51" class="d">-                setValue(value)
</a><a href="#h318-0-52" id="h318-0-52" class="d">-            }
</a><a href="#h318-0-53" id="h318-0-53" class="d">-        }
</a><a href="#h318-0-54" id="h318-0-54" class="d">-
</a><a href="#h318-0-55" id="h318-0-55" class="d">-        findClass(compositeConfigurationProviderMappings[&quot;class&quot;].toString()).hook(
</a><a href="#h318-0-56" id="h318-0-56" class="d">-            compositeConfigurationProviderMappings[&quot;getProperty&quot;].toString(),
</a><a href="#h318-0-57" id="h318-0-57" class="d">-            HookStage.AFTER
</a><a href="#h318-0-58" id="h318-0-58" class="d">-        ) { param -&gt;
</a><a href="#h318-0-59" id="h318-0-59" class="d">-            val propertyKey = param.arg&lt;Any&gt;(0).toString()
</a><a href="#h318-0-60" id="h318-0-60" class="d">-
</a><a href="#h318-0-61" id="h318-0-61" class="d">-            propertyOverrides[propertyKey]?.let { (filter, value) -&gt;
</a><a href="#h318-0-62" id="h318-0-62" class="d">-                if (!filter()) return@let
</a><a href="#h318-0-63" id="h318-0-63" class="d">-                param.setResult(value)
</a><a href="#h318-0-64" id="h318-0-64" class="d">-            }
</a><a href="#h318-0-65" id="h318-0-65" class="d">-        }
</a><a href="#h318-0-66" id="h318-0-66" class="d">-
</a><a href="#h318-0-67" id="h318-0-67" class="d">-        arrayOf(&quot;getBoolean&quot;, &quot;getInt&quot;, &quot;getLong&quot;, &quot;getFloat&quot;, &quot;getString&quot;).forEach { methodName -&gt;
</a><a href="#h318-0-68" id="h318-0-68" class="d">-            findClass(&quot;android.app.SharedPreferencesImpl&quot;).hook(
</a><a href="#h318-0-69" id="h318-0-69" class="d">-                methodName,
</a><a href="#h318-0-70" id="h318-0-70" class="d">-                HookStage.BEFORE
</a><a href="#h318-0-71" id="h318-0-71" class="d">-            ) { param -&gt;
</a><a href="#h318-0-72" id="h318-0-72" class="d">-                val key = param.argNullable&lt;Any&gt;(0).toString()
</a><a href="#h318-0-73" id="h318-0-73" class="d">-                propertyOverrides[key]?.let { (filter, value) -&gt;
</a><a href="#h318-0-74" id="h318-0-74" class="d">-                    if (!filter()) return@let
</a><a href="#h318-0-75" id="h318-0-75" class="d">-                    param.setResult(value)
</a><a href="#h318-0-76" id="h318-0-76" class="d">-                }
</a><a href="#h318-0-77" id="h318-0-77" class="d">-            }
</a><a href="#h318-0-78" id="h318-0-78" class="d">-        }
</a><a href="#h318-0-79" id="h318-0-79" class="d">-    }
</a><a href="#h318-0-80" id="h318-0-80" class="d">-}</a><a href="#h318-0-81" id="h318-0-81" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h319" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/Messaging.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/Messaging.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/Messaging.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/Messaging.kt</a></b>
<a href="#h319-0" id="h319-0" class="h">@@ -1,94 +0,0 @@
</a><a href="#h319-0-0" id="h319-0-0" class="d">-package me.rhunk.snapenhance.features.impl
</a><a href="#h319-0-1" id="h319-0-1" class="d">-
</a><a href="#h319-0-2" id="h319-0-2" class="d">-import me.rhunk.snapenhance.core.event.events.impl.OnSnapInteractionEvent
</a><a href="#h319-0-3" id="h319-0-3" class="d">-import me.rhunk.snapenhance.core.util.ktx.getObjectField
</a><a href="#h319-0-4" id="h319-0-4" class="d">-import me.rhunk.snapenhance.data.wrapper.impl.SnapUUID
</a><a href="#h319-0-5" id="h319-0-5" class="d">-import me.rhunk.snapenhance.features.Feature
</a><a href="#h319-0-6" id="h319-0-6" class="d">-import me.rhunk.snapenhance.features.FeatureLoadParams
</a><a href="#h319-0-7" id="h319-0-7" class="d">-import me.rhunk.snapenhance.features.impl.spying.StealthMode
</a><a href="#h319-0-8" id="h319-0-8" class="d">-import me.rhunk.snapenhance.hook.HookStage
</a><a href="#h319-0-9" id="h319-0-9" class="d">-import me.rhunk.snapenhance.hook.Hooker
</a><a href="#h319-0-10" id="h319-0-10" class="d">-import me.rhunk.snapenhance.hook.hook
</a><a href="#h319-0-11" id="h319-0-11" class="d">-
</a><a href="#h319-0-12" id="h319-0-12" class="d">-class Messaging : Feature(&quot;Messaging&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_SYNC or FeatureLoadParams.INIT_ASYNC or FeatureLoadParams.INIT_SYNC) {
</a><a href="#h319-0-13" id="h319-0-13" class="d">-    lateinit var conversationManager: Any
</a><a href="#h319-0-14" id="h319-0-14" class="d">-
</a><a href="#h319-0-15" id="h319-0-15" class="d">-    var openedConversationUUID: SnapUUID? = null
</a><a href="#h319-0-16" id="h319-0-16" class="d">-    var lastFetchConversationUserUUID: SnapUUID? = null
</a><a href="#h319-0-17" id="h319-0-17" class="d">-    var lastFetchConversationUUID: SnapUUID? = null
</a><a href="#h319-0-18" id="h319-0-18" class="d">-    var lastFetchGroupConversationUUID: SnapUUID? = null
</a><a href="#h319-0-19" id="h319-0-19" class="d">-    var lastFocusedMessageId: Long = -1
</a><a href="#h319-0-20" id="h319-0-20" class="d">-
</a><a href="#h319-0-21" id="h319-0-21" class="d">-    override fun init() {
</a><a href="#h319-0-22" id="h319-0-22" class="d">-        Hooker.hookConstructor(context.classCache.conversationManager, HookStage.BEFORE) {
</a><a href="#h319-0-23" id="h319-0-23" class="d">-            conversationManager = it.thisObject()
</a><a href="#h319-0-24" id="h319-0-24" class="d">-        }
</a><a href="#h319-0-25" id="h319-0-25" class="d">-    }
</a><a href="#h319-0-26" id="h319-0-26" class="d">-
</a><a href="#h319-0-27" id="h319-0-27" class="d">-    override fun onActivityCreate() {
</a><a href="#h319-0-28" id="h319-0-28" class="d">-        context.mappings.getMappedObjectNullable(&quot;FriendsFeedEventDispatcher&quot;).let { it as? Map&lt;*, *&gt; }?.let { mappings -&gt;
</a><a href="#h319-0-29" id="h319-0-29" class="d">-            findClass(mappings[&quot;class&quot;].toString()).hook(&quot;onItemLongPress&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h319-0-30" id="h319-0-30" class="d">-                val viewItemContainer = param.arg&lt;Any&gt;(0)
</a><a href="#h319-0-31" id="h319-0-31" class="d">-                val viewItem = viewItemContainer.getObjectField(mappings[&quot;viewModelField&quot;].toString()).toString()
</a><a href="#h319-0-32" id="h319-0-32" class="d">-                val conversationId = viewItem.substringAfter(&quot;conversationId: &quot;).substring(0, 36).also {
</a><a href="#h319-0-33" id="h319-0-33" class="d">-                    if (it.startsWith(&quot;null&quot;)) return@hook
</a><a href="#h319-0-34" id="h319-0-34" class="d">-                }
</a><a href="#h319-0-35" id="h319-0-35" class="d">-                context.database.getConversationType(conversationId)?.takeIf { it == 1 }?.run {
</a><a href="#h319-0-36" id="h319-0-36" class="d">-                    lastFetchGroupConversationUUID = SnapUUID.fromString(conversationId)
</a><a href="#h319-0-37" id="h319-0-37" class="d">-                }
</a><a href="#h319-0-38" id="h319-0-38" class="d">-            }
</a><a href="#h319-0-39" id="h319-0-39" class="d">-        }
</a><a href="#h319-0-40" id="h319-0-40" class="d">-
</a><a href="#h319-0-41" id="h319-0-41" class="d">-        context.mappings.getMappedClass(&quot;callbacks&quot;, &quot;GetOneOnOneConversationIdsCallback&quot;).hook(&quot;onSuccess&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h319-0-42" id="h319-0-42" class="d">-            val userIdToConversation = (param.arg&lt;ArrayList&lt;*&gt;&gt;(0))
</a><a href="#h319-0-43" id="h319-0-43" class="d">-                .takeIf { it.isNotEmpty() }
</a><a href="#h319-0-44" id="h319-0-44" class="d">-                ?.get(0) ?: return@hook
</a><a href="#h319-0-45" id="h319-0-45" class="d">-
</a><a href="#h319-0-46" id="h319-0-46" class="d">-            lastFetchConversationUUID = SnapUUID(userIdToConversation.getObjectField(&quot;mConversationId&quot;))
</a><a href="#h319-0-47" id="h319-0-47" class="d">-            lastFetchConversationUserUUID = SnapUUID(userIdToConversation.getObjectField(&quot;mUserId&quot;))
</a><a href="#h319-0-48" id="h319-0-48" class="d">-        }
</a><a href="#h319-0-49" id="h319-0-49" class="d">-
</a><a href="#h319-0-50" id="h319-0-50" class="d">-        with(context.classCache.conversationManager) {
</a><a href="#h319-0-51" id="h319-0-51" class="d">-            Hooker.hook(this, &quot;enterConversation&quot;, HookStage.BEFORE) {
</a><a href="#h319-0-52" id="h319-0-52" class="d">-                openedConversationUUID = SnapUUID(it.arg(0))
</a><a href="#h319-0-53" id="h319-0-53" class="d">-            }
</a><a href="#h319-0-54" id="h319-0-54" class="d">-
</a><a href="#h319-0-55" id="h319-0-55" class="d">-            Hooker.hook(this, &quot;exitConversation&quot;, HookStage.BEFORE) {
</a><a href="#h319-0-56" id="h319-0-56" class="d">-                openedConversationUUID = null
</a><a href="#h319-0-57" id="h319-0-57" class="d">-            }
</a><a href="#h319-0-58" id="h319-0-58" class="d">-        }
</a><a href="#h319-0-59" id="h319-0-59" class="d">-
</a><a href="#h319-0-60" id="h319-0-60" class="d">-    }
</a><a href="#h319-0-61" id="h319-0-61" class="d">-
</a><a href="#h319-0-62" id="h319-0-62" class="d">-    override fun asyncInit() {
</a><a href="#h319-0-63" id="h319-0-63" class="d">-        val stealthMode = context.feature(StealthMode::class)
</a><a href="#h319-0-64" id="h319-0-64" class="d">-
</a><a href="#h319-0-65" id="h319-0-65" class="d">-        val hideBitmojiPresence by context.config.messaging.hideBitmojiPresence
</a><a href="#h319-0-66" id="h319-0-66" class="d">-        val hideTypingNotification by context.config.messaging.hideTypingNotifications
</a><a href="#h319-0-67" id="h319-0-67" class="d">-
</a><a href="#h319-0-68" id="h319-0-68" class="d">-        arrayOf(&quot;activate&quot;, &quot;deactivate&quot;, &quot;processTypingActivity&quot;).forEach { hook -&gt;
</a><a href="#h319-0-69" id="h319-0-69" class="d">-            Hooker.hook(context.classCache.presenceSession, hook, HookStage.BEFORE, {
</a><a href="#h319-0-70" id="h319-0-70" class="d">-                hideBitmojiPresence || stealthMode.canUseRule(openedConversationUUID.toString())
</a><a href="#h319-0-71" id="h319-0-71" class="d">-            }) {
</a><a href="#h319-0-72" id="h319-0-72" class="d">-                it.setResult(null)
</a><a href="#h319-0-73" id="h319-0-73" class="d">-            }
</a><a href="#h319-0-74" id="h319-0-74" class="d">-        }
</a><a href="#h319-0-75" id="h319-0-75" class="d">-
</a><a href="#h319-0-76" id="h319-0-76" class="d">-        //get last opened snap for media downloader
</a><a href="#h319-0-77" id="h319-0-77" class="d">-        context.event.subscribe(OnSnapInteractionEvent::class) { event -&gt;
</a><a href="#h319-0-78" id="h319-0-78" class="d">-            openedConversationUUID = event.conversationId
</a><a href="#h319-0-79" id="h319-0-79" class="d">-            lastFocusedMessageId = event.messageId
</a><a href="#h319-0-80" id="h319-0-80" class="d">-        }
</a><a href="#h319-0-81" id="h319-0-81" class="d">-
</a><a href="#h319-0-82" id="h319-0-82" class="d">-        Hooker.hook(context.classCache.conversationManager, &quot;fetchMessage&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h319-0-83" id="h319-0-83" class="d">-            lastFetchConversationUserUUID = SnapUUID((param.arg(0) as Any))
</a><a href="#h319-0-84" id="h319-0-84" class="d">-            lastFocusedMessageId = param.arg(1)
</a><a href="#h319-0-85" id="h319-0-85" class="d">-        }
</a><a href="#h319-0-86" id="h319-0-86" class="d">-
</a><a href="#h319-0-87" id="h319-0-87" class="d">-        Hooker.hook(context.classCache.conversationManager, &quot;sendTypingNotification&quot;, HookStage.BEFORE, {
</a><a href="#h319-0-88" id="h319-0-88" class="d">-            hideTypingNotification || stealthMode.canUseRule(openedConversationUUID.toString())
</a><a href="#h319-0-89" id="h319-0-89" class="d">-        }) {
</a><a href="#h319-0-90" id="h319-0-90" class="d">-            it.setResult(null)
</a><a href="#h319-0-91" id="h319-0-91" class="d">-        }
</a><a href="#h319-0-92" id="h319-0-92" class="d">-    }
</a><a href="#h319-0-93" id="h319-0-93" class="d">-}</a><a href="#h319-0-94" id="h319-0-94" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h320" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/ScopeSync.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/ScopeSync.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/ScopeSync.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/ScopeSync.kt</a></b>
<a href="#h320-0" id="h320-0" class="h">@@ -1,43 +0,0 @@
</a><a href="#h320-0-0" id="h320-0-0" class="d">-package me.rhunk.snapenhance.features.impl
</a><a href="#h320-0-1" id="h320-0-1" class="d">-
</a><a href="#h320-0-2" id="h320-0-2" class="d">-import kotlinx.coroutines.Job
</a><a href="#h320-0-3" id="h320-0-3" class="d">-import kotlinx.coroutines.delay
</a><a href="#h320-0-4" id="h320-0-4" class="d">-import kotlinx.coroutines.launch
</a><a href="#h320-0-5" id="h320-0-5" class="d">-import me.rhunk.snapenhance.core.event.events.impl.SendMessageWithContentEvent
</a><a href="#h320-0-6" id="h320-0-6" class="d">-import me.rhunk.snapenhance.core.messaging.SocialScope
</a><a href="#h320-0-7" id="h320-0-7" class="d">-import me.rhunk.snapenhance.data.ContentType
</a><a href="#h320-0-8" id="h320-0-8" class="d">-import me.rhunk.snapenhance.features.Feature
</a><a href="#h320-0-9" id="h320-0-9" class="d">-import me.rhunk.snapenhance.features.FeatureLoadParams
</a><a href="#h320-0-10" id="h320-0-10" class="d">-
</a><a href="#h320-0-11" id="h320-0-11" class="d">-class ScopeSync : Feature(&quot;Scope Sync&quot;, loadParams = FeatureLoadParams.INIT_SYNC) {
</a><a href="#h320-0-12" id="h320-0-12" class="d">-    companion object {
</a><a href="#h320-0-13" id="h320-0-13" class="d">-        private const val DELAY_BEFORE_SYNC = 2000L
</a><a href="#h320-0-14" id="h320-0-14" class="d">-    }
</a><a href="#h320-0-15" id="h320-0-15" class="d">-
</a><a href="#h320-0-16" id="h320-0-16" class="d">-    private val updateJobs = mutableMapOf&lt;String, Job&gt;()
</a><a href="#h320-0-17" id="h320-0-17" class="d">-
</a><a href="#h320-0-18" id="h320-0-18" class="d">-    private fun sync(conversationId: String) {
</a><a href="#h320-0-19" id="h320-0-19" class="d">-        context.database.getDMOtherParticipant(conversationId)?.also { participant -&gt;
</a><a href="#h320-0-20" id="h320-0-20" class="d">-            context.bridgeClient.triggerSync(SocialScope.FRIEND, participant)
</a><a href="#h320-0-21" id="h320-0-21" class="d">-        } ?: run {
</a><a href="#h320-0-22" id="h320-0-22" class="d">-            context.bridgeClient.triggerSync(SocialScope.GROUP, conversationId)
</a><a href="#h320-0-23" id="h320-0-23" class="d">-        }
</a><a href="#h320-0-24" id="h320-0-24" class="d">-    }
</a><a href="#h320-0-25" id="h320-0-25" class="d">-
</a><a href="#h320-0-26" id="h320-0-26" class="d">-    override fun init() {
</a><a href="#h320-0-27" id="h320-0-27" class="d">-        context.event.subscribe(SendMessageWithContentEvent::class) { event -&gt;
</a><a href="#h320-0-28" id="h320-0-28" class="d">-            if (event.messageContent.contentType != ContentType.SNAP) return@subscribe
</a><a href="#h320-0-29" id="h320-0-29" class="d">-
</a><a href="#h320-0-30" id="h320-0-30" class="d">-            event.addCallbackResult(&quot;onSuccess&quot;) {
</a><a href="#h320-0-31" id="h320-0-31" class="d">-                event.destinations.conversations.map { it.toString() }.forEach { conversationId -&gt;
</a><a href="#h320-0-32" id="h320-0-32" class="d">-                    updateJobs[conversationId]?.also { it.cancel() }
</a><a href="#h320-0-33" id="h320-0-33" class="d">-
</a><a href="#h320-0-34" id="h320-0-34" class="d">-                    updateJobs[conversationId] = (context.coroutineScope.launch {
</a><a href="#h320-0-35" id="h320-0-35" class="d">-                        delay(DELAY_BEFORE_SYNC)
</a><a href="#h320-0-36" id="h320-0-36" class="d">-                        sync(conversationId)
</a><a href="#h320-0-37" id="h320-0-37" class="d">-                    })
</a><a href="#h320-0-38" id="h320-0-38" class="d">-                }
</a><a href="#h320-0-39" id="h320-0-39" class="d">-            }
</a><a href="#h320-0-40" id="h320-0-40" class="d">-        }
</a><a href="#h320-0-41" id="h320-0-41" class="d">-    }
</a><a href="#h320-0-42" id="h320-0-42" class="d">-}</a><a href="#h320-0-43" id="h320-0-43" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h321" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/MediaDownloader.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/MediaDownloader.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/MediaDownloader.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/MediaDownloader.kt</a></b>
<a href="#h321-0" id="h321-0" class="h">@@ -1,714 +0,0 @@
</a><a href="#h321-0-0" id="h321-0-0" class="d">-package me.rhunk.snapenhance.features.impl.downloader
</a><a href="#h321-0-1" id="h321-0-1" class="d">-
</a><a href="#h321-0-2" id="h321-0-2" class="d">-import android.annotation.SuppressLint
</a><a href="#h321-0-3" id="h321-0-3" class="d">-import android.graphics.Bitmap
</a><a href="#h321-0-4" id="h321-0-4" class="d">-import android.graphics.BitmapFactory
</a><a href="#h321-0-5" id="h321-0-5" class="d">-import android.net.Uri
</a><a href="#h321-0-6" id="h321-0-6" class="d">-import android.text.InputType
</a><a href="#h321-0-7" id="h321-0-7" class="d">-import android.view.Gravity
</a><a href="#h321-0-8" id="h321-0-8" class="d">-import android.view.ViewGroup.MarginLayoutParams
</a><a href="#h321-0-9" id="h321-0-9" class="d">-import android.widget.EditText
</a><a href="#h321-0-10" id="h321-0-10" class="d">-import android.widget.ImageView
</a><a href="#h321-0-11" id="h321-0-11" class="d">-import android.widget.LinearLayout
</a><a href="#h321-0-12" id="h321-0-12" class="d">-import android.widget.ProgressBar
</a><a href="#h321-0-13" id="h321-0-13" class="d">-import android.widget.TextView
</a><a href="#h321-0-14" id="h321-0-14" class="d">-import kotlinx.coroutines.ExperimentalCoroutinesApi
</a><a href="#h321-0-15" id="h321-0-15" class="d">-import kotlinx.coroutines.async
</a><a href="#h321-0-16" id="h321-0-16" class="d">-import kotlinx.coroutines.runBlocking
</a><a href="#h321-0-17" id="h321-0-17" class="d">-import me.rhunk.snapenhance.SnapEnhance
</a><a href="#h321-0-18" id="h321-0-18" class="d">-import me.rhunk.snapenhance.bridge.DownloadCallback
</a><a href="#h321-0-19" id="h321-0-19" class="d">-import me.rhunk.snapenhance.core.database.objects.ConversationMessage
</a><a href="#h321-0-20" id="h321-0-20" class="d">-import me.rhunk.snapenhance.core.database.objects.FriendInfo
</a><a href="#h321-0-21" id="h321-0-21" class="d">-import me.rhunk.snapenhance.core.download.DownloadManagerClient
</a><a href="#h321-0-22" id="h321-0-22" class="d">-import me.rhunk.snapenhance.core.download.data.*
</a><a href="#h321-0-23" id="h321-0-23" class="d">-import me.rhunk.snapenhance.core.messaging.MessagingRuleType
</a><a href="#h321-0-24" id="h321-0-24" class="d">-import me.rhunk.snapenhance.core.util.download.RemoteMediaResolver
</a><a href="#h321-0-25" id="h321-0-25" class="d">-import me.rhunk.snapenhance.core.util.ktx.getObjectField
</a><a href="#h321-0-26" id="h321-0-26" class="d">-import me.rhunk.snapenhance.core.util.protobuf.ProtoReader
</a><a href="#h321-0-27" id="h321-0-27" class="d">-import me.rhunk.snapenhance.core.util.snap.BitmojiSelfie
</a><a href="#h321-0-28" id="h321-0-28" class="d">-import me.rhunk.snapenhance.core.util.snap.MediaDownloaderHelper
</a><a href="#h321-0-29" id="h321-0-29" class="d">-import me.rhunk.snapenhance.core.util.snap.PreviewUtils
</a><a href="#h321-0-30" id="h321-0-30" class="d">-import me.rhunk.snapenhance.data.FileType
</a><a href="#h321-0-31" id="h321-0-31" class="d">-import me.rhunk.snapenhance.data.wrapper.impl.SnapUUID
</a><a href="#h321-0-32" id="h321-0-32" class="d">-import me.rhunk.snapenhance.data.wrapper.impl.media.MediaInfo
</a><a href="#h321-0-33" id="h321-0-33" class="d">-import me.rhunk.snapenhance.data.wrapper.impl.media.dash.LongformVideoPlaylistItem
</a><a href="#h321-0-34" id="h321-0-34" class="d">-import me.rhunk.snapenhance.data.wrapper.impl.media.dash.SnapPlaylistItem
</a><a href="#h321-0-35" id="h321-0-35" class="d">-import me.rhunk.snapenhance.data.wrapper.impl.media.opera.Layer
</a><a href="#h321-0-36" id="h321-0-36" class="d">-import me.rhunk.snapenhance.data.wrapper.impl.media.opera.ParamMap
</a><a href="#h321-0-37" id="h321-0-37" class="d">-import me.rhunk.snapenhance.features.FeatureLoadParams
</a><a href="#h321-0-38" id="h321-0-38" class="d">-import me.rhunk.snapenhance.features.MessagingRuleFeature
</a><a href="#h321-0-39" id="h321-0-39" class="d">-import me.rhunk.snapenhance.features.impl.Messaging
</a><a href="#h321-0-40" id="h321-0-40" class="d">-import me.rhunk.snapenhance.features.impl.downloader.decoder.DecodedAttachment
</a><a href="#h321-0-41" id="h321-0-41" class="d">-import me.rhunk.snapenhance.features.impl.downloader.decoder.MessageDecoder
</a><a href="#h321-0-42" id="h321-0-42" class="d">-import me.rhunk.snapenhance.features.impl.spying.MessageLogger
</a><a href="#h321-0-43" id="h321-0-43" class="d">-import me.rhunk.snapenhance.hook.HookAdapter
</a><a href="#h321-0-44" id="h321-0-44" class="d">-import me.rhunk.snapenhance.hook.HookStage
</a><a href="#h321-0-45" id="h321-0-45" class="d">-import me.rhunk.snapenhance.hook.Hooker
</a><a href="#h321-0-46" id="h321-0-46" class="d">-import me.rhunk.snapenhance.ui.ViewAppearanceHelper
</a><a href="#h321-0-47" id="h321-0-47" class="d">-import java.io.ByteArrayInputStream
</a><a href="#h321-0-48" id="h321-0-48" class="d">-import java.nio.file.Paths
</a><a href="#h321-0-49" id="h321-0-49" class="d">-import java.text.SimpleDateFormat
</a><a href="#h321-0-50" id="h321-0-50" class="d">-import java.util.Locale
</a><a href="#h321-0-51" id="h321-0-51" class="d">-import kotlin.coroutines.suspendCoroutine
</a><a href="#h321-0-52" id="h321-0-52" class="d">-import kotlin.io.encoding.Base64
</a><a href="#h321-0-53" id="h321-0-53" class="d">-import kotlin.io.encoding.ExperimentalEncodingApi
</a><a href="#h321-0-54" id="h321-0-54" class="d">-
</a><a href="#h321-0-55" id="h321-0-55" class="d">-private fun String.sanitizeForPath(): String {
</a><a href="#h321-0-56" id="h321-0-56" class="d">-    return this.replace(&quot; &quot;, &quot;_&quot;)
</a><a href="#h321-0-57" id="h321-0-57" class="d">-        .replace(Regex(&quot;\\p{Cntrl}&quot;), &quot;&quot;)
</a><a href="#h321-0-58" id="h321-0-58" class="d">-}
</a><a href="#h321-0-59" id="h321-0-59" class="d">-
</a><a href="#h321-0-60" id="h321-0-60" class="d">-class SnapChapterInfo(
</a><a href="#h321-0-61" id="h321-0-61" class="d">-    val offset: Long,
</a><a href="#h321-0-62" id="h321-0-62" class="d">-    val duration: Long?
</a><a href="#h321-0-63" id="h321-0-63" class="d">-)
</a><a href="#h321-0-64" id="h321-0-64" class="d">-
</a><a href="#h321-0-65" id="h321-0-65" class="d">-
</a><a href="#h321-0-66" id="h321-0-66" class="d">-@OptIn(ExperimentalEncodingApi::class)
</a><a href="#h321-0-67" id="h321-0-67" class="d">-class MediaDownloader : MessagingRuleFeature(&quot;MediaDownloader&quot;, MessagingRuleType.AUTO_DOWNLOAD, loadParams = FeatureLoadParams.ACTIVITY_CREATE_ASYNC) {
</a><a href="#h321-0-68" id="h321-0-68" class="d">-    private var lastSeenMediaInfoMap: MutableMap&lt;SplitMediaAssetType, MediaInfo&gt;? = null
</a><a href="#h321-0-69" id="h321-0-69" class="d">-    private var lastSeenMapParams: ParamMap? = null
</a><a href="#h321-0-70" id="h321-0-70" class="d">-
</a><a href="#h321-0-71" id="h321-0-71" class="d">-    private val translations by lazy {
</a><a href="#h321-0-72" id="h321-0-72" class="d">-        context.translation.getCategory(&quot;download_processor&quot;)
</a><a href="#h321-0-73" id="h321-0-73" class="d">-    }
</a><a href="#h321-0-74" id="h321-0-74" class="d">-
</a><a href="#h321-0-75" id="h321-0-75" class="d">-    private fun provideDownloadManagerClient(
</a><a href="#h321-0-76" id="h321-0-76" class="d">-        mediaIdentifier: String,
</a><a href="#h321-0-77" id="h321-0-77" class="d">-        mediaAuthor: String,
</a><a href="#h321-0-78" id="h321-0-78" class="d">-        downloadSource: MediaDownloadSource,
</a><a href="#h321-0-79" id="h321-0-79" class="d">-        friendInfo: FriendInfo? = null
</a><a href="#h321-0-80" id="h321-0-80" class="d">-    ): DownloadManagerClient {
</a><a href="#h321-0-81" id="h321-0-81" class="d">-        val generatedHash = mediaIdentifier.hashCode().toString(16).replaceFirst(&quot;-&quot;, &quot;&quot;)
</a><a href="#h321-0-82" id="h321-0-82" class="d">-
</a><a href="#h321-0-83" id="h321-0-83" class="d">-        val iconUrl = BitmojiSelfie.getBitmojiSelfie(friendInfo?.bitmojiSelfieId, friendInfo?.bitmojiAvatarId, BitmojiSelfie.BitmojiSelfieType.THREE_D)
</a><a href="#h321-0-84" id="h321-0-84" class="d">-
</a><a href="#h321-0-85" id="h321-0-85" class="d">-        val downloadLogging by context.config.downloader.logging
</a><a href="#h321-0-86" id="h321-0-86" class="d">-        if (downloadLogging.contains(&quot;started&quot;)) {
</a><a href="#h321-0-87" id="h321-0-87" class="d">-            context.shortToast(translations[&quot;download_started_toast&quot;])
</a><a href="#h321-0-88" id="h321-0-88" class="d">-        }
</a><a href="#h321-0-89" id="h321-0-89" class="d">-
</a><a href="#h321-0-90" id="h321-0-90" class="d">-        val outputPath = createNewFilePath(generatedHash, downloadSource, mediaAuthor)
</a><a href="#h321-0-91" id="h321-0-91" class="d">-
</a><a href="#h321-0-92" id="h321-0-92" class="d">-        return DownloadManagerClient(
</a><a href="#h321-0-93" id="h321-0-93" class="d">-            context = context,
</a><a href="#h321-0-94" id="h321-0-94" class="d">-            metadata = DownloadMetadata(
</a><a href="#h321-0-95" id="h321-0-95" class="d">-                mediaIdentifier = if (!context.config.downloader.allowDuplicate.get()) {
</a><a href="#h321-0-96" id="h321-0-96" class="d">-                    generatedHash
</a><a href="#h321-0-97" id="h321-0-97" class="d">-                } else null,
</a><a href="#h321-0-98" id="h321-0-98" class="d">-                mediaAuthor = mediaAuthor,
</a><a href="#h321-0-99" id="h321-0-99" class="d">-                downloadSource = downloadSource.key,
</a><a href="#h321-0-100" id="h321-0-100" class="d">-                iconUrl = iconUrl,
</a><a href="#h321-0-101" id="h321-0-101" class="d">-                outputPath = outputPath
</a><a href="#h321-0-102" id="h321-0-102" class="d">-            ),
</a><a href="#h321-0-103" id="h321-0-103" class="d">-            callback = object: DownloadCallback.Stub() {
</a><a href="#h321-0-104" id="h321-0-104" class="d">-                override fun onSuccess(outputFile: String) {
</a><a href="#h321-0-105" id="h321-0-105" class="d">-                    if (!downloadLogging.contains(&quot;success&quot;)) return
</a><a href="#h321-0-106" id="h321-0-106" class="d">-                    context.log.verbose(&quot;onSuccess: outputFile=$outputFile&quot;)
</a><a href="#h321-0-107" id="h321-0-107" class="d">-                    context.shortToast(translations.format(&quot;saved_toast&quot;, &quot;path&quot; to outputFile.split(&quot;/&quot;).takeLast(2).joinToString(&quot;/&quot;)))
</a><a href="#h321-0-108" id="h321-0-108" class="d">-                }
</a><a href="#h321-0-109" id="h321-0-109" class="d">-
</a><a href="#h321-0-110" id="h321-0-110" class="d">-                override fun onProgress(message: String) {
</a><a href="#h321-0-111" id="h321-0-111" class="d">-                    if (!downloadLogging.contains(&quot;progress&quot;)) return
</a><a href="#h321-0-112" id="h321-0-112" class="d">-                    context.log.verbose(&quot;onProgress: message=$message&quot;)
</a><a href="#h321-0-113" id="h321-0-113" class="d">-                    context.shortToast(message)
</a><a href="#h321-0-114" id="h321-0-114" class="d">-                }
</a><a href="#h321-0-115" id="h321-0-115" class="d">-
</a><a href="#h321-0-116" id="h321-0-116" class="d">-                override fun onFailure(message: String, throwable: String?) {
</a><a href="#h321-0-117" id="h321-0-117" class="d">-                    if (!downloadLogging.contains(&quot;failure&quot;)) return
</a><a href="#h321-0-118" id="h321-0-118" class="d">-                    context.log.verbose(&quot;onFailure: message=$message, throwable=$throwable&quot;)
</a><a href="#h321-0-119" id="h321-0-119" class="d">-                    throwable?.let {
</a><a href="#h321-0-120" id="h321-0-120" class="d">-                        context.longToast((message + it.takeIf { it.isNotEmpty() }.orEmpty()))
</a><a href="#h321-0-121" id="h321-0-121" class="d">-                        return
</a><a href="#h321-0-122" id="h321-0-122" class="d">-                    }
</a><a href="#h321-0-123" id="h321-0-123" class="d">-                    context.shortToast(message)
</a><a href="#h321-0-124" id="h321-0-124" class="d">-                }
</a><a href="#h321-0-125" id="h321-0-125" class="d">-            }
</a><a href="#h321-0-126" id="h321-0-126" class="d">-        )
</a><a href="#h321-0-127" id="h321-0-127" class="d">-    }
</a><a href="#h321-0-128" id="h321-0-128" class="d">-
</a><a href="#h321-0-129" id="h321-0-129" class="d">-
</a><a href="#h321-0-130" id="h321-0-130" class="d">-    private fun createNewFilePath(hexHash: String, downloadSource: MediaDownloadSource, mediaAuthor: String): String {
</a><a href="#h321-0-131" id="h321-0-131" class="d">-        val pathFormat by context.config.downloader.pathFormat
</a><a href="#h321-0-132" id="h321-0-132" class="d">-        val sanitizedMediaAuthor = mediaAuthor.sanitizeForPath().ifEmpty { hexHash }
</a><a href="#h321-0-133" id="h321-0-133" class="d">-
</a><a href="#h321-0-134" id="h321-0-134" class="d">-        val currentDateTime = SimpleDateFormat(&quot;yyyy-MM-dd_HH-mm-ss&quot;, Locale.ENGLISH).format(System.currentTimeMillis())
</a><a href="#h321-0-135" id="h321-0-135" class="d">-
</a><a href="#h321-0-136" id="h321-0-136" class="d">-        val finalPath = StringBuilder()
</a><a href="#h321-0-137" id="h321-0-137" class="d">-
</a><a href="#h321-0-138" id="h321-0-138" class="d">-        fun appendFileName(string: String) {
</a><a href="#h321-0-139" id="h321-0-139" class="d">-            if (finalPath.isEmpty() || finalPath.endsWith(&quot;/&quot;)) {
</a><a href="#h321-0-140" id="h321-0-140" class="d">-                finalPath.append(string)
</a><a href="#h321-0-141" id="h321-0-141" class="d">-            } else {
</a><a href="#h321-0-142" id="h321-0-142" class="d">-                finalPath.append(&quot;_&quot;).append(string)
</a><a href="#h321-0-143" id="h321-0-143" class="d">-            }
</a><a href="#h321-0-144" id="h321-0-144" class="d">-        }
</a><a href="#h321-0-145" id="h321-0-145" class="d">-
</a><a href="#h321-0-146" id="h321-0-146" class="d">-        if (pathFormat.contains(&quot;create_author_folder&quot;)) {
</a><a href="#h321-0-147" id="h321-0-147" class="d">-            finalPath.append(sanitizedMediaAuthor).append(&quot;/&quot;)
</a><a href="#h321-0-148" id="h321-0-148" class="d">-        }
</a><a href="#h321-0-149" id="h321-0-149" class="d">-        if (pathFormat.contains(&quot;create_source_folder&quot;)) {
</a><a href="#h321-0-150" id="h321-0-150" class="d">-            finalPath.append(downloadSource.pathName).append(&quot;/&quot;)
</a><a href="#h321-0-151" id="h321-0-151" class="d">-        }
</a><a href="#h321-0-152" id="h321-0-152" class="d">-        if (pathFormat.contains(&quot;append_hash&quot;)) {
</a><a href="#h321-0-153" id="h321-0-153" class="d">-            appendFileName(hexHash)
</a><a href="#h321-0-154" id="h321-0-154" class="d">-        }
</a><a href="#h321-0-155" id="h321-0-155" class="d">-        if (pathFormat.contains(&quot;append_source&quot;)) {
</a><a href="#h321-0-156" id="h321-0-156" class="d">-            appendFileName(downloadSource.pathName)
</a><a href="#h321-0-157" id="h321-0-157" class="d">-        }
</a><a href="#h321-0-158" id="h321-0-158" class="d">-        if (pathFormat.contains(&quot;append_username&quot;)) {
</a><a href="#h321-0-159" id="h321-0-159" class="d">-            appendFileName(sanitizedMediaAuthor)
</a><a href="#h321-0-160" id="h321-0-160" class="d">-        }
</a><a href="#h321-0-161" id="h321-0-161" class="d">-        if (pathFormat.contains(&quot;append_date_time&quot;)) {
</a><a href="#h321-0-162" id="h321-0-162" class="d">-            appendFileName(currentDateTime)
</a><a href="#h321-0-163" id="h321-0-163" class="d">-        }
</a><a href="#h321-0-164" id="h321-0-164" class="d">-
</a><a href="#h321-0-165" id="h321-0-165" class="d">-        if (finalPath.isEmpty()) finalPath.append(hexHash)
</a><a href="#h321-0-166" id="h321-0-166" class="d">-
</a><a href="#h321-0-167" id="h321-0-167" class="d">-        return finalPath.toString()
</a><a href="#h321-0-168" id="h321-0-168" class="d">-    }
</a><a href="#h321-0-169" id="h321-0-169" class="d">-
</a><a href="#h321-0-170" id="h321-0-170" class="d">-    /*
</a><a href="#h321-0-171" id="h321-0-171" class="d">-     * Download the last seen media
</a><a href="#h321-0-172" id="h321-0-172" class="d">-     */
</a><a href="#h321-0-173" id="h321-0-173" class="d">-    fun downloadLastOperaMediaAsync() {
</a><a href="#h321-0-174" id="h321-0-174" class="d">-        if (lastSeenMapParams == null || lastSeenMediaInfoMap == null) return
</a><a href="#h321-0-175" id="h321-0-175" class="d">-        context.executeAsync {
</a><a href="#h321-0-176" id="h321-0-176" class="d">-            handleOperaMedia(lastSeenMapParams!!, lastSeenMediaInfoMap!!, true)
</a><a href="#h321-0-177" id="h321-0-177" class="d">-        }
</a><a href="#h321-0-178" id="h321-0-178" class="d">-    }
</a><a href="#h321-0-179" id="h321-0-179" class="d">-
</a><a href="#h321-0-180" id="h321-0-180" class="d">-    fun showLastOperaDebugMediaInfo() {
</a><a href="#h321-0-181" id="h321-0-181" class="d">-        if (lastSeenMapParams == null || lastSeenMediaInfoMap == null) return
</a><a href="#h321-0-182" id="h321-0-182" class="d">-
</a><a href="#h321-0-183" id="h321-0-183" class="d">-        context.runOnUiThread {
</a><a href="#h321-0-184" id="h321-0-184" class="d">-            val mediaInfoText = lastSeenMapParams?.concurrentHashMap?.map { (key, value) -&gt;
</a><a href="#h321-0-185" id="h321-0-185" class="d">-                val transformedValue = value.let {
</a><a href="#h321-0-186" id="h321-0-186" class="d">-                    if (it::class.java == SnapEnhance.classCache.snapUUID) {
</a><a href="#h321-0-187" id="h321-0-187" class="d">-                        SnapUUID(it).toString()
</a><a href="#h321-0-188" id="h321-0-188" class="d">-                    }
</a><a href="#h321-0-189" id="h321-0-189" class="d">-                    it
</a><a href="#h321-0-190" id="h321-0-190" class="d">-                }
</a><a href="#h321-0-191" id="h321-0-191" class="d">-                &quot;- $key: $transformedValue&quot;
</a><a href="#h321-0-192" id="h321-0-192" class="d">-            }?.joinToString(&quot;\n&quot;) ?: &quot;No media info found&quot;
</a><a href="#h321-0-193" id="h321-0-193" class="d">-
</a><a href="#h321-0-194" id="h321-0-194" class="d">-            ViewAppearanceHelper.newAlertDialogBuilder(context.mainActivity!!).apply {
</a><a href="#h321-0-195" id="h321-0-195" class="d">-                setTitle(&quot;Debug Media Info&quot;)
</a><a href="#h321-0-196" id="h321-0-196" class="d">-                setView(EditText(context).apply {
</a><a href="#h321-0-197" id="h321-0-197" class="d">-                    inputType = InputType.TYPE_NULL
</a><a href="#h321-0-198" id="h321-0-198" class="d">-                    setTextIsSelectable(true)
</a><a href="#h321-0-199" id="h321-0-199" class="d">-                    isSingleLine = false
</a><a href="#h321-0-200" id="h321-0-200" class="d">-                    textSize = 12f
</a><a href="#h321-0-201" id="h321-0-201" class="d">-                    setPadding(20, 20, 20, 20)
</a><a href="#h321-0-202" id="h321-0-202" class="d">-                    setText(mediaInfoText)
</a><a href="#h321-0-203" id="h321-0-203" class="d">-                    setTextColor(context.resources.getColor(android.R.color.white, context.theme))
</a><a href="#h321-0-204" id="h321-0-204" class="d">-                })
</a><a href="#h321-0-205" id="h321-0-205" class="d">-                setNeutralButton(&quot;Copy&quot;) { _, _ -&gt;
</a><a href="#h321-0-206" id="h321-0-206" class="d">-                    this@MediaDownloader.context.copyToClipboard(mediaInfoText)
</a><a href="#h321-0-207" id="h321-0-207" class="d">-                }
</a><a href="#h321-0-208" id="h321-0-208" class="d">-                setPositiveButton(&quot;Download&quot;) { _, _ -&gt;
</a><a href="#h321-0-209" id="h321-0-209" class="d">-                    downloadLastOperaMediaAsync()
</a><a href="#h321-0-210" id="h321-0-210" class="d">-                }
</a><a href="#h321-0-211" id="h321-0-211" class="d">-                setNegativeButton(&quot;Cancel&quot;) { dialog, _ -&gt; dialog.dismiss() }
</a><a href="#h321-0-212" id="h321-0-212" class="d">-            }.show()
</a><a href="#h321-0-213" id="h321-0-213" class="d">-        }
</a><a href="#h321-0-214" id="h321-0-214" class="d">-    }
</a><a href="#h321-0-215" id="h321-0-215" class="d">-
</a><a href="#h321-0-216" id="h321-0-216" class="d">-    private fun handleLocalReferences(path: String) = runBlocking {
</a><a href="#h321-0-217" id="h321-0-217" class="d">-        Uri.parse(path).let { uri -&gt;
</a><a href="#h321-0-218" id="h321-0-218" class="d">-            if (uri.scheme == &quot;file&quot;) {
</a><a href="#h321-0-219" id="h321-0-219" class="d">-                return@let suspendCoroutine&lt;String&gt; { continuation -&gt;
</a><a href="#h321-0-220" id="h321-0-220" class="d">-                    context.httpServer.ensureServerStarted {
</a><a href="#h321-0-221" id="h321-0-221" class="d">-                        val file = Paths.get(uri.path).toFile()
</a><a href="#h321-0-222" id="h321-0-222" class="d">-                        val url = putDownloadableContent(file.inputStream(), file.length())
</a><a href="#h321-0-223" id="h321-0-223" class="d">-                        continuation.resumeWith(Result.success(url))
</a><a href="#h321-0-224" id="h321-0-224" class="d">-                    }
</a><a href="#h321-0-225" id="h321-0-225" class="d">-                }
</a><a href="#h321-0-226" id="h321-0-226" class="d">-            }
</a><a href="#h321-0-227" id="h321-0-227" class="d">-            path
</a><a href="#h321-0-228" id="h321-0-228" class="d">-        }
</a><a href="#h321-0-229" id="h321-0-229" class="d">-    }
</a><a href="#h321-0-230" id="h321-0-230" class="d">-
</a><a href="#h321-0-231" id="h321-0-231" class="d">-    private fun downloadOperaMedia(downloadManagerClient: DownloadManagerClient, mediaInfoMap: Map&lt;SplitMediaAssetType, MediaInfo&gt;) {
</a><a href="#h321-0-232" id="h321-0-232" class="d">-        if (mediaInfoMap.isEmpty()) return
</a><a href="#h321-0-233" id="h321-0-233" class="d">-
</a><a href="#h321-0-234" id="h321-0-234" class="d">-        val originalMediaInfo = mediaInfoMap[SplitMediaAssetType.ORIGINAL]!!
</a><a href="#h321-0-235" id="h321-0-235" class="d">-        val originalMediaInfoReference = handleLocalReferences(originalMediaInfo.uri)
</a><a href="#h321-0-236" id="h321-0-236" class="d">-
</a><a href="#h321-0-237" id="h321-0-237" class="d">-        mediaInfoMap[SplitMediaAssetType.OVERLAY]?.let { overlay -&gt;
</a><a href="#h321-0-238" id="h321-0-238" class="d">-            val overlayReference = handleLocalReferences(overlay.uri)
</a><a href="#h321-0-239" id="h321-0-239" class="d">-
</a><a href="#h321-0-240" id="h321-0-240" class="d">-            downloadManagerClient.downloadMediaWithOverlay(
</a><a href="#h321-0-241" id="h321-0-241" class="d">-                original = InputMedia(
</a><a href="#h321-0-242" id="h321-0-242" class="d">-                    originalMediaInfoReference,
</a><a href="#h321-0-243" id="h321-0-243" class="d">-                    DownloadMediaType.fromUri(Uri.parse(originalMediaInfoReference)),
</a><a href="#h321-0-244" id="h321-0-244" class="d">-                    originalMediaInfo.encryption?.toKeyPair()
</a><a href="#h321-0-245" id="h321-0-245" class="d">-                ),
</a><a href="#h321-0-246" id="h321-0-246" class="d">-                overlay = InputMedia(
</a><a href="#h321-0-247" id="h321-0-247" class="d">-                    overlayReference,
</a><a href="#h321-0-248" id="h321-0-248" class="d">-                    DownloadMediaType.fromUri(Uri.parse(overlayReference)),
</a><a href="#h321-0-249" id="h321-0-249" class="d">-                    overlay.encryption?.toKeyPair(),
</a><a href="#h321-0-250" id="h321-0-250" class="d">-                    isOverlay = true
</a><a href="#h321-0-251" id="h321-0-251" class="d">-                )
</a><a href="#h321-0-252" id="h321-0-252" class="d">-            )
</a><a href="#h321-0-253" id="h321-0-253" class="d">-            return
</a><a href="#h321-0-254" id="h321-0-254" class="d">-        }
</a><a href="#h321-0-255" id="h321-0-255" class="d">-
</a><a href="#h321-0-256" id="h321-0-256" class="d">-        downloadManagerClient.downloadSingleMedia(
</a><a href="#h321-0-257" id="h321-0-257" class="d">-            originalMediaInfoReference,
</a><a href="#h321-0-258" id="h321-0-258" class="d">-            DownloadMediaType.fromUri(Uri.parse(originalMediaInfoReference)),
</a><a href="#h321-0-259" id="h321-0-259" class="d">-            originalMediaInfo.encryption?.toKeyPair()
</a><a href="#h321-0-260" id="h321-0-260" class="d">-        )
</a><a href="#h321-0-261" id="h321-0-261" class="d">-    }
</a><a href="#h321-0-262" id="h321-0-262" class="d">-
</a><a href="#h321-0-263" id="h321-0-263" class="d">-    /**
</a><a href="#h321-0-264" id="h321-0-264" class="d">-     * Handles the media from the opera viewer
</a><a href="#h321-0-265" id="h321-0-265" class="d">-     *
</a><a href="#h321-0-266" id="h321-0-266" class="d">-     * @param paramMap      the parameters from the opera viewer
</a><a href="#h321-0-267" id="h321-0-267" class="d">-     * @param mediaInfoMap  the media info map
</a><a href="#h321-0-268" id="h321-0-268" class="d">-     * @param forceDownload if the media should be downloaded
</a><a href="#h321-0-269" id="h321-0-269" class="d">-     */
</a><a href="#h321-0-270" id="h321-0-270" class="d">-    private fun handleOperaMedia(
</a><a href="#h321-0-271" id="h321-0-271" class="d">-        paramMap: ParamMap,
</a><a href="#h321-0-272" id="h321-0-272" class="d">-        mediaInfoMap: Map&lt;SplitMediaAssetType, MediaInfo&gt;,
</a><a href="#h321-0-273" id="h321-0-273" class="d">-        forceDownload: Boolean
</a><a href="#h321-0-274" id="h321-0-274" class="d">-    ) {
</a><a href="#h321-0-275" id="h321-0-275" class="d">-        //messages
</a><a href="#h321-0-276" id="h321-0-276" class="d">-        paramMap[&quot;MESSAGE_ID&quot;]?.toString()?.takeIf { forceDownload || canAutoDownload(&quot;friend_snaps&quot;) }?.let { id -&gt;
</a><a href="#h321-0-277" id="h321-0-277" class="d">-            val messageId = id.substring(id.lastIndexOf(&quot;:&quot;) + 1).toLong()
</a><a href="#h321-0-278" id="h321-0-278" class="d">-            val conversationMessage = context.database.getConversationMessageFromId(messageId)!!
</a><a href="#h321-0-279" id="h321-0-279" class="d">-
</a><a href="#h321-0-280" id="h321-0-280" class="d">-            val senderId = conversationMessage.senderId!!
</a><a href="#h321-0-281" id="h321-0-281" class="d">-            val conversationId = conversationMessage.clientConversationId!!
</a><a href="#h321-0-282" id="h321-0-282" class="d">-
</a><a href="#h321-0-283" id="h321-0-283" class="d">-            if (!forceDownload &amp;&amp; !canUseRule(senderId)) {
</a><a href="#h321-0-284" id="h321-0-284" class="d">-                return
</a><a href="#h321-0-285" id="h321-0-285" class="d">-            }
</a><a href="#h321-0-286" id="h321-0-286" class="d">-
</a><a href="#h321-0-287" id="h321-0-287" class="d">-            if (!forceDownload &amp;&amp; context.config.downloader.preventSelfAutoDownload.get() &amp;&amp; senderId == context.database.myUserId) return
</a><a href="#h321-0-288" id="h321-0-288" class="d">-
</a><a href="#h321-0-289" id="h321-0-289" class="d">-            val author = context.database.getFriendInfo(senderId) ?: return
</a><a href="#h321-0-290" id="h321-0-290" class="d">-            val authorUsername = author.usernameForSorting!!
</a><a href="#h321-0-291" id="h321-0-291" class="d">-            val mediaId = paramMap[&quot;MEDIA_ID&quot;]?.toString()?.split(&quot;-&quot;)?.getOrNull(1) ?: &quot;&quot;
</a><a href="#h321-0-292" id="h321-0-292" class="d">-
</a><a href="#h321-0-293" id="h321-0-293" class="d">-            downloadOperaMedia(provideDownloadManagerClient(
</a><a href="#h321-0-294" id="h321-0-294" class="d">-                mediaIdentifier = &quot;$conversationId$senderId${conversationMessage.serverMessageId}$mediaId&quot;,
</a><a href="#h321-0-295" id="h321-0-295" class="d">-                mediaAuthor = authorUsername,
</a><a href="#h321-0-296" id="h321-0-296" class="d">-                downloadSource = MediaDownloadSource.CHAT_MEDIA,
</a><a href="#h321-0-297" id="h321-0-297" class="d">-                friendInfo = author
</a><a href="#h321-0-298" id="h321-0-298" class="d">-            ), mediaInfoMap)
</a><a href="#h321-0-299" id="h321-0-299" class="d">-
</a><a href="#h321-0-300" id="h321-0-300" class="d">-            return
</a><a href="#h321-0-301" id="h321-0-301" class="d">-        }
</a><a href="#h321-0-302" id="h321-0-302" class="d">-
</a><a href="#h321-0-303" id="h321-0-303" class="d">-        //private stories
</a><a href="#h321-0-304" id="h321-0-304" class="d">-        paramMap[&quot;PLAYLIST_V2_GROUP&quot;]?.takeIf {
</a><a href="#h321-0-305" id="h321-0-305" class="d">-            forceDownload || canAutoDownload(&quot;friend_stories&quot;)
</a><a href="#h321-0-306" id="h321-0-306" class="d">-        }?.let { playlistGroup -&gt;
</a><a href="#h321-0-307" id="h321-0-307" class="d">-            val playlistGroupString = playlistGroup.toString()
</a><a href="#h321-0-308" id="h321-0-308" class="d">-
</a><a href="#h321-0-309" id="h321-0-309" class="d">-            val storyUserId = paramMap[&quot;TOPIC_SNAP_CREATOR_USER_ID&quot;]?.toString() ?: if (playlistGroupString.contains(&quot;storyUserId=&quot;)) {
</a><a href="#h321-0-310" id="h321-0-310" class="d">-                (playlistGroupString.indexOf(&quot;storyUserId=&quot;) + 12).let {
</a><a href="#h321-0-311" id="h321-0-311" class="d">-                    playlistGroupString.substring(it, playlistGroupString.indexOf(&quot;,&quot;, it))
</a><a href="#h321-0-312" id="h321-0-312" class="d">-                }
</a><a href="#h321-0-313" id="h321-0-313" class="d">-            } else {
</a><a href="#h321-0-314" id="h321-0-314" class="d">-                //story replies
</a><a href="#h321-0-315" id="h321-0-315" class="d">-                val arroyoMessageId = playlistGroup::class.java.methods.firstOrNull { it.name == &quot;getId&quot; }
</a><a href="#h321-0-316" id="h321-0-316" class="d">-                    ?.invoke(playlistGroup)?.toString()
</a><a href="#h321-0-317" id="h321-0-317" class="d">-                    ?.split(&quot;:&quot;)?.getOrNull(2) ?: return@let
</a><a href="#h321-0-318" id="h321-0-318" class="d">-
</a><a href="#h321-0-319" id="h321-0-319" class="d">-                val conversationMessage = context.database.getConversationMessageFromId(arroyoMessageId.toLong()) ?: return@let
</a><a href="#h321-0-320" id="h321-0-320" class="d">-                val conversationParticipants = context.database.getConversationParticipants(conversationMessage.clientConversationId.toString()) ?: return@let
</a><a href="#h321-0-321" id="h321-0-321" class="d">-
</a><a href="#h321-0-322" id="h321-0-322" class="d">-                conversationParticipants.firstOrNull { it != conversationMessage.senderId }
</a><a href="#h321-0-323" id="h321-0-323" class="d">-            }
</a><a href="#h321-0-324" id="h321-0-324" class="d">-
</a><a href="#h321-0-325" id="h321-0-325" class="d">-            val author = context.database.getFriendInfo(
</a><a href="#h321-0-326" id="h321-0-326" class="d">-                if (storyUserId == null || storyUserId == &quot;null&quot;)
</a><a href="#h321-0-327" id="h321-0-327" class="d">-                    context.database.myUserId
</a><a href="#h321-0-328" id="h321-0-328" class="d">-                else storyUserId
</a><a href="#h321-0-329" id="h321-0-329" class="d">-            ) ?: throw Exception(&quot;Friend not found in database&quot;)
</a><a href="#h321-0-330" id="h321-0-330" class="d">-            val authorName = author.usernameForSorting!!
</a><a href="#h321-0-331" id="h321-0-331" class="d">-
</a><a href="#h321-0-332" id="h321-0-332" class="d">-            if (!forceDownload) {
</a><a href="#h321-0-333" id="h321-0-333" class="d">-                if (context.config.downloader.preventSelfAutoDownload.get() &amp;&amp; author.userId == context.database.myUserId) return
</a><a href="#h321-0-334" id="h321-0-334" class="d">-                if (!canUseRule(author.userId!!)) return
</a><a href="#h321-0-335" id="h321-0-335" class="d">-            }
</a><a href="#h321-0-336" id="h321-0-336" class="d">-
</a><a href="#h321-0-337" id="h321-0-337" class="d">-            downloadOperaMedia(provideDownloadManagerClient(
</a><a href="#h321-0-338" id="h321-0-338" class="d">-                mediaIdentifier = paramMap[&quot;MEDIA_ID&quot;].toString(),
</a><a href="#h321-0-339" id="h321-0-339" class="d">-                mediaAuthor = authorName,
</a><a href="#h321-0-340" id="h321-0-340" class="d">-                downloadSource = MediaDownloadSource.STORY,
</a><a href="#h321-0-341" id="h321-0-341" class="d">-                friendInfo = author
</a><a href="#h321-0-342" id="h321-0-342" class="d">-            ), mediaInfoMap)
</a><a href="#h321-0-343" id="h321-0-343" class="d">-            return
</a><a href="#h321-0-344" id="h321-0-344" class="d">-        }
</a><a href="#h321-0-345" id="h321-0-345" class="d">-
</a><a href="#h321-0-346" id="h321-0-346" class="d">-        val snapSource = paramMap[&quot;SNAP_SOURCE&quot;].toString()
</a><a href="#h321-0-347" id="h321-0-347" class="d">-
</a><a href="#h321-0-348" id="h321-0-348" class="d">-        //public stories
</a><a href="#h321-0-349" id="h321-0-349" class="d">-        if ((snapSource == &quot;PUBLIC_USER&quot; || snapSource == &quot;SAVED_STORY&quot;) &amp;&amp;
</a><a href="#h321-0-350" id="h321-0-350" class="d">-            (forceDownload || canAutoDownload(&quot;public_stories&quot;))) {
</a><a href="#h321-0-351" id="h321-0-351" class="d">-            val userDisplayName = (if (paramMap.containsKey(&quot;USER_DISPLAY_NAME&quot;)) paramMap[&quot;USER_DISPLAY_NAME&quot;].toString() else &quot;&quot;).sanitizeForPath()
</a><a href="#h321-0-352" id="h321-0-352" class="d">-
</a><a href="#h321-0-353" id="h321-0-353" class="d">-            downloadOperaMedia(provideDownloadManagerClient(
</a><a href="#h321-0-354" id="h321-0-354" class="d">-                mediaIdentifier = paramMap[&quot;SNAP_ID&quot;].toString(),
</a><a href="#h321-0-355" id="h321-0-355" class="d">-                mediaAuthor = userDisplayName,
</a><a href="#h321-0-356" id="h321-0-356" class="d">-                downloadSource = MediaDownloadSource.PUBLIC_STORY,
</a><a href="#h321-0-357" id="h321-0-357" class="d">-            ), mediaInfoMap)
</a><a href="#h321-0-358" id="h321-0-358" class="d">-            return
</a><a href="#h321-0-359" id="h321-0-359" class="d">-        }
</a><a href="#h321-0-360" id="h321-0-360" class="d">-
</a><a href="#h321-0-361" id="h321-0-361" class="d">-        //spotlight
</a><a href="#h321-0-362" id="h321-0-362" class="d">-        if (snapSource == &quot;SINGLE_SNAP_STORY&quot; &amp;&amp; (forceDownload || canAutoDownload(&quot;spotlight&quot;))) {
</a><a href="#h321-0-363" id="h321-0-363" class="d">-            downloadOperaMedia(provideDownloadManagerClient(
</a><a href="#h321-0-364" id="h321-0-364" class="d">-                mediaIdentifier = paramMap[&quot;SNAP_ID&quot;].toString(),
</a><a href="#h321-0-365" id="h321-0-365" class="d">-                downloadSource = MediaDownloadSource.SPOTLIGHT,
</a><a href="#h321-0-366" id="h321-0-366" class="d">-                mediaAuthor = paramMap[&quot;TIME_STAMP&quot;].toString()
</a><a href="#h321-0-367" id="h321-0-367" class="d">-            ), mediaInfoMap)
</a><a href="#h321-0-368" id="h321-0-368" class="d">-            return
</a><a href="#h321-0-369" id="h321-0-369" class="d">-        }
</a><a href="#h321-0-370" id="h321-0-370" class="d">-
</a><a href="#h321-0-371" id="h321-0-371" class="d">-        //stories with mpeg dash media
</a><a href="#h321-0-372" id="h321-0-372" class="d">-        if (paramMap.containsKey(&quot;LONGFORM_VIDEO_PLAYLIST_ITEM&quot;) &amp;&amp; forceDownload) {
</a><a href="#h321-0-373" id="h321-0-373" class="d">-            val storyName = paramMap[&quot;STORY_NAME&quot;].toString().sanitizeForPath()
</a><a href="#h321-0-374" id="h321-0-374" class="d">-            //get the position of the media in the playlist and the duration
</a><a href="#h321-0-375" id="h321-0-375" class="d">-            val snapItem = SnapPlaylistItem(paramMap[&quot;SNAP_PLAYLIST_ITEM&quot;]!!)
</a><a href="#h321-0-376" id="h321-0-376" class="d">-            val snapChapterList = LongformVideoPlaylistItem(paramMap[&quot;LONGFORM_VIDEO_PLAYLIST_ITEM&quot;]!!).chapters
</a><a href="#h321-0-377" id="h321-0-377" class="d">-            val currentChapterIndex = snapChapterList.indexOfFirst { it.snapId == snapItem.snapId }
</a><a href="#h321-0-378" id="h321-0-378" class="d">-
</a><a href="#h321-0-379" id="h321-0-379" class="d">-            if (snapChapterList.isEmpty()) {
</a><a href="#h321-0-380" id="h321-0-380" class="d">-                context.shortToast(&quot;No chapters found&quot;)
</a><a href="#h321-0-381" id="h321-0-381" class="d">-                return
</a><a href="#h321-0-382" id="h321-0-382" class="d">-            }
</a><a href="#h321-0-383" id="h321-0-383" class="d">-
</a><a href="#h321-0-384" id="h321-0-384" class="d">-            fun prettyPrintTime(time: Long): String {
</a><a href="#h321-0-385" id="h321-0-385" class="d">-                val seconds = time / 1000
</a><a href="#h321-0-386" id="h321-0-386" class="d">-                val minutes = seconds / 60
</a><a href="#h321-0-387" id="h321-0-387" class="d">-                val hours = minutes / 60
</a><a href="#h321-0-388" id="h321-0-388" class="d">-                return &quot;${hours % 24}:${minutes % 60}:${seconds % 60}&quot;
</a><a href="#h321-0-389" id="h321-0-389" class="d">-            }
</a><a href="#h321-0-390" id="h321-0-390" class="d">-
</a><a href="#h321-0-391" id="h321-0-391" class="d">-            val playlistUrl = paramMap[&quot;MEDIA_ID&quot;].toString().let {
</a><a href="#h321-0-392" id="h321-0-392" class="d">-                val urlIndexes = arrayOf(it.indexOf(&quot;https://cf-st.sc-cdn.net&quot;), it.indexOf(&quot;https://bolt-gcdn.sc-cdn.net&quot;))
</a><a href="#h321-0-393" id="h321-0-393" class="d">-
</a><a href="#h321-0-394" id="h321-0-394" class="d">-                urlIndexes.firstOrNull { index -&gt; index != -1 }?.let { validIndex -&gt;
</a><a href="#h321-0-395" id="h321-0-395" class="d">-                    it.substring(validIndex)
</a><a href="#h321-0-396" id="h321-0-396" class="d">-                } ?: &quot;${RemoteMediaResolver.CF_ST_CDN_D}$it&quot;
</a><a href="#h321-0-397" id="h321-0-397" class="d">-            }
</a><a href="#h321-0-398" id="h321-0-398" class="d">-
</a><a href="#h321-0-399" id="h321-0-399" class="d">-            context.runOnUiThread {
</a><a href="#h321-0-400" id="h321-0-400" class="d">-                val selectedChapters = mutableListOf&lt;Int&gt;()
</a><a href="#h321-0-401" id="h321-0-401" class="d">-                val chapters = snapChapterList.mapIndexed { index, snapChapter -&gt;
</a><a href="#h321-0-402" id="h321-0-402" class="d">-                    val nextChapter = snapChapterList.getOrNull(index + 1)
</a><a href="#h321-0-403" id="h321-0-403" class="d">-                    val duration = nextChapter?.startTimeMs?.minus(snapChapter.startTimeMs)
</a><a href="#h321-0-404" id="h321-0-404" class="d">-                    SnapChapterInfo(snapChapter.startTimeMs, duration)
</a><a href="#h321-0-405" id="h321-0-405" class="d">-                }
</a><a href="#h321-0-406" id="h321-0-406" class="d">-                ViewAppearanceHelper.newAlertDialogBuilder(context.mainActivity!!).apply {
</a><a href="#h321-0-407" id="h321-0-407" class="d">-                    setTitle(&quot;Download dash media&quot;)
</a><a href="#h321-0-408" id="h321-0-408" class="d">-                    setMultiChoiceItems(
</a><a href="#h321-0-409" id="h321-0-409" class="d">-                        chapters.map { &quot;Segment ${prettyPrintTime(it.offset)} - ${prettyPrintTime(it.offset + (it.duration ?: 0))}&quot; }.toTypedArray(),
</a><a href="#h321-0-410" id="h321-0-410" class="d">-                        List(chapters.size) { index -&gt; currentChapterIndex == index }.toBooleanArray()
</a><a href="#h321-0-411" id="h321-0-411" class="d">-                    ) { _, which, isChecked -&gt;
</a><a href="#h321-0-412" id="h321-0-412" class="d">-                        if (isChecked) {
</a><a href="#h321-0-413" id="h321-0-413" class="d">-                            selectedChapters.add(which)
</a><a href="#h321-0-414" id="h321-0-414" class="d">-                        } else if (selectedChapters.contains(which)) {
</a><a href="#h321-0-415" id="h321-0-415" class="d">-                            selectedChapters.remove(which)
</a><a href="#h321-0-416" id="h321-0-416" class="d">-                        }
</a><a href="#h321-0-417" id="h321-0-417" class="d">-                    }
</a><a href="#h321-0-418" id="h321-0-418" class="d">-                    setNegativeButton(&quot;Cancel&quot;) { dialog, _ -&gt; dialog.dismiss() }
</a><a href="#h321-0-419" id="h321-0-419" class="d">-                    setNeutralButton(&quot;Download all&quot;) { _, _ -&gt;
</a><a href="#h321-0-420" id="h321-0-420" class="d">-                        provideDownloadManagerClient(
</a><a href="#h321-0-421" id="h321-0-421" class="d">-                            mediaIdentifier = paramMap[&quot;STORY_ID&quot;].toString(),
</a><a href="#h321-0-422" id="h321-0-422" class="d">-                            downloadSource = MediaDownloadSource.PUBLIC_STORY,
</a><a href="#h321-0-423" id="h321-0-423" class="d">-                            mediaAuthor = storyName
</a><a href="#h321-0-424" id="h321-0-424" class="d">-                        ).downloadDashMedia(playlistUrl, 0, null)
</a><a href="#h321-0-425" id="h321-0-425" class="d">-                    }
</a><a href="#h321-0-426" id="h321-0-426" class="d">-                    setPositiveButton(&quot;Download&quot;) { _, _ -&gt;
</a><a href="#h321-0-427" id="h321-0-427" class="d">-                        val groups = mutableListOf&lt;MutableList&lt;SnapChapterInfo&gt;&gt;()
</a><a href="#h321-0-428" id="h321-0-428" class="d">-                        var currentGroup = mutableListOf&lt;SnapChapterInfo&gt;()
</a><a href="#h321-0-429" id="h321-0-429" class="d">-                        var lastChapterIndex = -1
</a><a href="#h321-0-430" id="h321-0-430" class="d">-
</a><a href="#h321-0-431" id="h321-0-431" class="d">-                        //check for consecutive chapters
</a><a href="#h321-0-432" id="h321-0-432" class="d">-                        chapters.filterIndexed { index, _ -&gt; selectedChapters.contains(index) }
</a><a href="#h321-0-433" id="h321-0-433" class="d">-                            .forEachIndexed { index, pair -&gt;
</a><a href="#h321-0-434" id="h321-0-434" class="d">-                                if (lastChapterIndex != -1 &amp;&amp; index != lastChapterIndex + 1) {
</a><a href="#h321-0-435" id="h321-0-435" class="d">-                                    groups.add(currentGroup)
</a><a href="#h321-0-436" id="h321-0-436" class="d">-                                    currentGroup = mutableListOf()
</a><a href="#h321-0-437" id="h321-0-437" class="d">-                                }
</a><a href="#h321-0-438" id="h321-0-438" class="d">-                                currentGroup.add(pair)
</a><a href="#h321-0-439" id="h321-0-439" class="d">-                                lastChapterIndex = index
</a><a href="#h321-0-440" id="h321-0-440" class="d">-                        }
</a><a href="#h321-0-441" id="h321-0-441" class="d">-
</a><a href="#h321-0-442" id="h321-0-442" class="d">-                        if (currentGroup.isNotEmpty()) {
</a><a href="#h321-0-443" id="h321-0-443" class="d">-                            groups.add(currentGroup)
</a><a href="#h321-0-444" id="h321-0-444" class="d">-                        }
</a><a href="#h321-0-445" id="h321-0-445" class="d">-
</a><a href="#h321-0-446" id="h321-0-446" class="d">-                        groups.forEach { group -&gt;
</a><a href="#h321-0-447" id="h321-0-447" class="d">-                            val firstChapter = group.first()
</a><a href="#h321-0-448" id="h321-0-448" class="d">-                            val lastChapter = group.last()
</a><a href="#h321-0-449" id="h321-0-449" class="d">-                            val duration = if (firstChapter == lastChapter) {
</a><a href="#h321-0-450" id="h321-0-450" class="d">-                                firstChapter.duration
</a><a href="#h321-0-451" id="h321-0-451" class="d">-                            } else {
</a><a href="#h321-0-452" id="h321-0-452" class="d">-                                lastChapter.duration?.let { lastChapter.offset - firstChapter.offset + it }
</a><a href="#h321-0-453" id="h321-0-453" class="d">-                            }
</a><a href="#h321-0-454" id="h321-0-454" class="d">-
</a><a href="#h321-0-455" id="h321-0-455" class="d">-                            provideDownloadManagerClient(
</a><a href="#h321-0-456" id="h321-0-456" class="d">-                                mediaIdentifier = &quot;${paramMap[&quot;STORY_ID&quot;]}-${firstChapter.offset}-${lastChapter.offset}&quot;,
</a><a href="#h321-0-457" id="h321-0-457" class="d">-                                downloadSource = MediaDownloadSource.PUBLIC_STORY,
</a><a href="#h321-0-458" id="h321-0-458" class="d">-                                mediaAuthor = storyName
</a><a href="#h321-0-459" id="h321-0-459" class="d">-                            ).downloadDashMedia(
</a><a href="#h321-0-460" id="h321-0-460" class="d">-                                playlistUrl,
</a><a href="#h321-0-461" id="h321-0-461" class="d">-                                firstChapter.offset.plus(100),
</a><a href="#h321-0-462" id="h321-0-462" class="d">-                                duration
</a><a href="#h321-0-463" id="h321-0-463" class="d">-                            )
</a><a href="#h321-0-464" id="h321-0-464" class="d">-                        }
</a><a href="#h321-0-465" id="h321-0-465" class="d">-                    }
</a><a href="#h321-0-466" id="h321-0-466" class="d">-                }.show()
</a><a href="#h321-0-467" id="h321-0-467" class="d">-            }
</a><a href="#h321-0-468" id="h321-0-468" class="d">-        }
</a><a href="#h321-0-469" id="h321-0-469" class="d">-    }
</a><a href="#h321-0-470" id="h321-0-470" class="d">-
</a><a href="#h321-0-471" id="h321-0-471" class="d">-    private fun canAutoDownload(keyFilter: String? = null): Boolean {
</a><a href="#h321-0-472" id="h321-0-472" class="d">-        val options by context.config.downloader.autoDownloadSources
</a><a href="#h321-0-473" id="h321-0-473" class="d">-        return options.any { keyFilter == null || it.contains(keyFilter, true) }
</a><a href="#h321-0-474" id="h321-0-474" class="d">-    }
</a><a href="#h321-0-475" id="h321-0-475" class="d">-
</a><a href="#h321-0-476" id="h321-0-476" class="d">-    override fun asyncOnActivityCreate() {
</a><a href="#h321-0-477" id="h321-0-477" class="d">-        val operaViewerControllerClass: Class&lt;*&gt; = context.mappings.getMappedClass(&quot;OperaPageViewController&quot;, &quot;class&quot;)
</a><a href="#h321-0-478" id="h321-0-478" class="d">-
</a><a href="#h321-0-479" id="h321-0-479" class="d">-        val onOperaViewStateCallback: (HookAdapter) -&gt; Unit = onOperaViewStateCallback@{ param -&gt;
</a><a href="#h321-0-480" id="h321-0-480" class="d">-
</a><a href="#h321-0-481" id="h321-0-481" class="d">-            val viewState = (param.thisObject() as Any).getObjectField(context.mappings.getMappedValue(&quot;OperaPageViewController&quot;, &quot;viewStateField&quot;)).toString()
</a><a href="#h321-0-482" id="h321-0-482" class="d">-            if (viewState != &quot;FULLY_DISPLAYED&quot;) {
</a><a href="#h321-0-483" id="h321-0-483" class="d">-                return@onOperaViewStateCallback
</a><a href="#h321-0-484" id="h321-0-484" class="d">-            }
</a><a href="#h321-0-485" id="h321-0-485" class="d">-            val operaLayerList = (param.thisObject() as Any).getObjectField(context.mappings.getMappedValue(&quot;OperaPageViewController&quot;, &quot;layerListField&quot;)) as ArrayList&lt;*&gt;
</a><a href="#h321-0-486" id="h321-0-486" class="d">-            val mediaParamMap: ParamMap = operaLayerList.map { Layer(it) }.first().paramMap
</a><a href="#h321-0-487" id="h321-0-487" class="d">-
</a><a href="#h321-0-488" id="h321-0-488" class="d">-            if (!mediaParamMap.containsKey(&quot;image_media_info&quot;) &amp;&amp; !mediaParamMap.containsKey(&quot;video_media_info_list&quot;))
</a><a href="#h321-0-489" id="h321-0-489" class="d">-                return@onOperaViewStateCallback
</a><a href="#h321-0-490" id="h321-0-490" class="d">-
</a><a href="#h321-0-491" id="h321-0-491" class="d">-            val mediaInfoMap = mutableMapOf&lt;SplitMediaAssetType, MediaInfo&gt;()
</a><a href="#h321-0-492" id="h321-0-492" class="d">-            val isVideo = mediaParamMap.containsKey(&quot;video_media_info_list&quot;)
</a><a href="#h321-0-493" id="h321-0-493" class="d">-
</a><a href="#h321-0-494" id="h321-0-494" class="d">-            mediaInfoMap[SplitMediaAssetType.ORIGINAL] = MediaInfo(
</a><a href="#h321-0-495" id="h321-0-495" class="d">-                (if (isVideo) mediaParamMap[&quot;video_media_info_list&quot;] else mediaParamMap[&quot;image_media_info&quot;])!!
</a><a href="#h321-0-496" id="h321-0-496" class="d">-            )
</a><a href="#h321-0-497" id="h321-0-497" class="d">-
</a><a href="#h321-0-498" id="h321-0-498" class="d">-            if (context.config.downloader.mergeOverlays.get() &amp;&amp; mediaParamMap.containsKey(&quot;overlay_image_media_info&quot;)) {
</a><a href="#h321-0-499" id="h321-0-499" class="d">-                mediaInfoMap[SplitMediaAssetType.OVERLAY] =
</a><a href="#h321-0-500" id="h321-0-500" class="d">-                    MediaInfo(mediaParamMap[&quot;overlay_image_media_info&quot;]!!)
</a><a href="#h321-0-501" id="h321-0-501" class="d">-            }
</a><a href="#h321-0-502" id="h321-0-502" class="d">-            lastSeenMapParams = mediaParamMap
</a><a href="#h321-0-503" id="h321-0-503" class="d">-            lastSeenMediaInfoMap = mediaInfoMap
</a><a href="#h321-0-504" id="h321-0-504" class="d">-
</a><a href="#h321-0-505" id="h321-0-505" class="d">-            if (!canAutoDownload()) return@onOperaViewStateCallback
</a><a href="#h321-0-506" id="h321-0-506" class="d">-
</a><a href="#h321-0-507" id="h321-0-507" class="d">-            context.executeAsync {
</a><a href="#h321-0-508" id="h321-0-508" class="d">-                runCatching {
</a><a href="#h321-0-509" id="h321-0-509" class="d">-                    handleOperaMedia(mediaParamMap, mediaInfoMap, false)
</a><a href="#h321-0-510" id="h321-0-510" class="d">-                }.onFailure {
</a><a href="#h321-0-511" id="h321-0-511" class="d">-                    context.log.error(&quot;Failed to handle opera media&quot;, it)
</a><a href="#h321-0-512" id="h321-0-512" class="d">-                    context.longToast(it.message)
</a><a href="#h321-0-513" id="h321-0-513" class="d">-                }
</a><a href="#h321-0-514" id="h321-0-514" class="d">-            }
</a><a href="#h321-0-515" id="h321-0-515" class="d">-        }
</a><a href="#h321-0-516" id="h321-0-516" class="d">-
</a><a href="#h321-0-517" id="h321-0-517" class="d">-        arrayOf(&quot;onDisplayStateChange&quot;, &quot;onDisplayStateChangeGesture&quot;).forEach { methodName -&gt;
</a><a href="#h321-0-518" id="h321-0-518" class="d">-            Hooker.hook(
</a><a href="#h321-0-519" id="h321-0-519" class="d">-                operaViewerControllerClass,
</a><a href="#h321-0-520" id="h321-0-520" class="d">-                context.mappings.getMappedValue(&quot;OperaPageViewController&quot;, methodName),
</a><a href="#h321-0-521" id="h321-0-521" class="d">-                HookStage.AFTER, onOperaViewStateCallback
</a><a href="#h321-0-522" id="h321-0-522" class="d">-            )
</a><a href="#h321-0-523" id="h321-0-523" class="d">-        }
</a><a href="#h321-0-524" id="h321-0-524" class="d">-    }
</a><a href="#h321-0-525" id="h321-0-525" class="d">-
</a><a href="#h321-0-526" id="h321-0-526" class="d">-    private fun downloadMessageAttachments(
</a><a href="#h321-0-527" id="h321-0-527" class="d">-        friendInfo: FriendInfo,
</a><a href="#h321-0-528" id="h321-0-528" class="d">-        message: ConversationMessage,
</a><a href="#h321-0-529" id="h321-0-529" class="d">-        authorName: String,
</a><a href="#h321-0-530" id="h321-0-530" class="d">-        attachments: List&lt;DecodedAttachment&gt;
</a><a href="#h321-0-531" id="h321-0-531" class="d">-    ) {
</a><a href="#h321-0-532" id="h321-0-532" class="d">-        //TODO: stickers
</a><a href="#h321-0-533" id="h321-0-533" class="d">-        attachments.forEach { attachment -&gt;
</a><a href="#h321-0-534" id="h321-0-534" class="d">-            runCatching {
</a><a href="#h321-0-535" id="h321-0-535" class="d">-                provideDownloadManagerClient(
</a><a href="#h321-0-536" id="h321-0-536" class="d">-                    mediaIdentifier = &quot;${message.clientConversationId}${message.senderId}${message.serverMessageId}${attachment.mediaUniqueId}&quot;,
</a><a href="#h321-0-537" id="h321-0-537" class="d">-                    downloadSource = MediaDownloadSource.CHAT_MEDIA,
</a><a href="#h321-0-538" id="h321-0-538" class="d">-                    mediaAuthor = authorName,
</a><a href="#h321-0-539" id="h321-0-539" class="d">-                    friendInfo = friendInfo
</a><a href="#h321-0-540" id="h321-0-540" class="d">-                ).downloadSingleMedia(
</a><a href="#h321-0-541" id="h321-0-541" class="d">-                    mediaData = attachment.mediaUrlKey!!,
</a><a href="#h321-0-542" id="h321-0-542" class="d">-                    mediaType = DownloadMediaType.PROTO_MEDIA,
</a><a href="#h321-0-543" id="h321-0-543" class="d">-                    encryption = attachment.attachmentInfo?.encryption,
</a><a href="#h321-0-544" id="h321-0-544" class="d">-                    attachmentType = attachment.type
</a><a href="#h321-0-545" id="h321-0-545" class="d">-                )
</a><a href="#h321-0-546" id="h321-0-546" class="d">-            }.onFailure {
</a><a href="#h321-0-547" id="h321-0-547" class="d">-                context.longToast(translations[&quot;failed_generic_toast&quot;])
</a><a href="#h321-0-548" id="h321-0-548" class="d">-                context.log.error(&quot;Failed to download&quot;, it)
</a><a href="#h321-0-549" id="h321-0-549" class="d">-            }
</a><a href="#h321-0-550" id="h321-0-550" class="d">-        }
</a><a href="#h321-0-551" id="h321-0-551" class="d">-    }
</a><a href="#h321-0-552" id="h321-0-552" class="d">-
</a><a href="#h321-0-553" id="h321-0-553" class="d">-
</a><a href="#h321-0-554" id="h321-0-554" class="d">-    @SuppressLint(&quot;SetTextI18n&quot;)
</a><a href="#h321-0-555" id="h321-0-555" class="d">-    @OptIn(ExperimentalCoroutinesApi::class)
</a><a href="#h321-0-556" id="h321-0-556" class="d">-    fun downloadMessageId(messageId: Long, isPreview: Boolean = false) {
</a><a href="#h321-0-557" id="h321-0-557" class="d">-        val messageLogger = context.feature(MessageLogger::class)
</a><a href="#h321-0-558" id="h321-0-558" class="d">-        val message = context.database.getConversationMessageFromId(messageId) ?: throw Exception(&quot;Message not found in database&quot;)
</a><a href="#h321-0-559" id="h321-0-559" class="d">-
</a><a href="#h321-0-560" id="h321-0-560" class="d">-        //get the message author
</a><a href="#h321-0-561" id="h321-0-561" class="d">-        val friendInfo: FriendInfo = context.database.getFriendInfo(message.senderId!!) ?: throw Exception(&quot;Friend not found in database&quot;)
</a><a href="#h321-0-562" id="h321-0-562" class="d">-        val authorName = friendInfo.usernameForSorting!!
</a><a href="#h321-0-563" id="h321-0-563" class="d">-
</a><a href="#h321-0-564" id="h321-0-564" class="d">-        val decodedAttachments = messageLogger.takeIf { it.isEnabled }?.getMessageObject(message.clientConversationId!!, message.clientMessageId.toLong())?.let {
</a><a href="#h321-0-565" id="h321-0-565" class="d">-            MessageDecoder.decode(it.getAsJsonObject(&quot;mMessageContent&quot;))
</a><a href="#h321-0-566" id="h321-0-566" class="d">-        } ?: MessageDecoder.decode(
</a><a href="#h321-0-567" id="h321-0-567" class="d">-            protoReader = ProtoReader(message.messageContent!!)
</a><a href="#h321-0-568" id="h321-0-568" class="d">-        )
</a><a href="#h321-0-569" id="h321-0-569" class="d">-
</a><a href="#h321-0-570" id="h321-0-570" class="d">-        if (decodedAttachments.isEmpty()) {
</a><a href="#h321-0-571" id="h321-0-571" class="d">-            context.shortToast(translations[&quot;no_attachments_toast&quot;])
</a><a href="#h321-0-572" id="h321-0-572" class="d">-            return
</a><a href="#h321-0-573" id="h321-0-573" class="d">-        }
</a><a href="#h321-0-574" id="h321-0-574" class="d">-
</a><a href="#h321-0-575" id="h321-0-575" class="d">-        if (!isPreview) {
</a><a href="#h321-0-576" id="h321-0-576" class="d">-            if (decodedAttachments.size == 1 ||
</a><a href="#h321-0-577" id="h321-0-577" class="d">-                context.mainActivity == null // we can&#39;t show alert dialogs when it downloads from a notification, so it downloads the first one
</a><a href="#h321-0-578" id="h321-0-578" class="d">-            ) {
</a><a href="#h321-0-579" id="h321-0-579" class="d">-                downloadMessageAttachments(friendInfo, message, authorName,
</a><a href="#h321-0-580" id="h321-0-580" class="d">-                    listOf(decodedAttachments.first())
</a><a href="#h321-0-581" id="h321-0-581" class="d">-                )
</a><a href="#h321-0-582" id="h321-0-582" class="d">-                return
</a><a href="#h321-0-583" id="h321-0-583" class="d">-            }
</a><a href="#h321-0-584" id="h321-0-584" class="d">-
</a><a href="#h321-0-585" id="h321-0-585" class="d">-            runOnUiThread {
</a><a href="#h321-0-586" id="h321-0-586" class="d">-                ViewAppearanceHelper.newAlertDialogBuilder(context.mainActivity).apply {
</a><a href="#h321-0-587" id="h321-0-587" class="d">-                    val selectedAttachments = mutableListOf&lt;Int&gt;().apply {
</a><a href="#h321-0-588" id="h321-0-588" class="d">-                        addAll(decodedAttachments.indices)
</a><a href="#h321-0-589" id="h321-0-589" class="d">-                    }
</a><a href="#h321-0-590" id="h321-0-590" class="d">-                    setMultiChoiceItems(
</a><a href="#h321-0-591" id="h321-0-591" class="d">-                        decodedAttachments.mapIndexed { index, decodedAttachment -&gt;
</a><a href="#h321-0-592" id="h321-0-592" class="d">-                            &quot;${index + 1}: ${translations[&quot;attachment_type.${decodedAttachment.type.key}&quot;]} ${decodedAttachment.attachmentInfo?.resolution?.let { &quot;(${it.first}x${it.second})&quot; } ?: &quot;&quot;}&quot;
</a><a href="#h321-0-593" id="h321-0-593" class="d">-                        }.toTypedArray(),
</a><a href="#h321-0-594" id="h321-0-594" class="d">-                        decodedAttachments.map { true }.toBooleanArray()
</a><a href="#h321-0-595" id="h321-0-595" class="d">-                    ) { _, which, isChecked -&gt;
</a><a href="#h321-0-596" id="h321-0-596" class="d">-                        if (isChecked) {
</a><a href="#h321-0-597" id="h321-0-597" class="d">-                            selectedAttachments.add(which)
</a><a href="#h321-0-598" id="h321-0-598" class="d">-                        } else if (selectedAttachments.contains(which)) {
</a><a href="#h321-0-599" id="h321-0-599" class="d">-                            selectedAttachments.remove(which)
</a><a href="#h321-0-600" id="h321-0-600" class="d">-                        }
</a><a href="#h321-0-601" id="h321-0-601" class="d">-                    }
</a><a href="#h321-0-602" id="h321-0-602" class="d">-                    setTitle(translations[&quot;select_attachments_title&quot;])
</a><a href="#h321-0-603" id="h321-0-603" class="d">-                    setNegativeButton(this@MediaDownloader.context.translation[&quot;button.cancel&quot;]) { dialog, _ -&gt; dialog.dismiss() }
</a><a href="#h321-0-604" id="h321-0-604" class="d">-                    setPositiveButton(this@MediaDownloader.context.translation[&quot;button.download&quot;]) { _, _ -&gt;
</a><a href="#h321-0-605" id="h321-0-605" class="d">-                        downloadMessageAttachments(friendInfo, message, authorName, selectedAttachments.map { decodedAttachments[it] })
</a><a href="#h321-0-606" id="h321-0-606" class="d">-                    }
</a><a href="#h321-0-607" id="h321-0-607" class="d">-                }.show()
</a><a href="#h321-0-608" id="h321-0-608" class="d">-            }
</a><a href="#h321-0-609" id="h321-0-609" class="d">-
</a><a href="#h321-0-610" id="h321-0-610" class="d">-            return
</a><a href="#h321-0-611" id="h321-0-611" class="d">-        }
</a><a href="#h321-0-612" id="h321-0-612" class="d">-
</a><a href="#h321-0-613" id="h321-0-613" class="d">-        runBlocking {
</a><a href="#h321-0-614" id="h321-0-614" class="d">-            val firstAttachment = decodedAttachments.first()
</a><a href="#h321-0-615" id="h321-0-615" class="d">-
</a><a href="#h321-0-616" id="h321-0-616" class="d">-            val previewCoroutine = async {
</a><a href="#h321-0-617" id="h321-0-617" class="d">-                val downloadedMedia = RemoteMediaResolver.downloadBoltMedia(Base64.decode(firstAttachment.mediaUrlKey!!), decryptionCallback = {
</a><a href="#h321-0-618" id="h321-0-618" class="d">-                    firstAttachment.attachmentInfo?.encryption?.decryptInputStream(it) ?: it
</a><a href="#h321-0-619" id="h321-0-619" class="d">-                }) ?: return@async null
</a><a href="#h321-0-620" id="h321-0-620" class="d">-
</a><a href="#h321-0-621" id="h321-0-621" class="d">-                val downloadedMediaList = mutableMapOf&lt;SplitMediaAssetType, ByteArray&gt;()
</a><a href="#h321-0-622" id="h321-0-622" class="d">-
</a><a href="#h321-0-623" id="h321-0-623" class="d">-                MediaDownloaderHelper.getSplitElements(ByteArrayInputStream(downloadedMedia)) {
</a><a href="#h321-0-624" id="h321-0-624" class="d">-                    type, inputStream -&gt;
</a><a href="#h321-0-625" id="h321-0-625" class="d">-                    downloadedMediaList[type] = inputStream.readBytes()
</a><a href="#h321-0-626" id="h321-0-626" class="d">-                }
</a><a href="#h321-0-627" id="h321-0-627" class="d">-
</a><a href="#h321-0-628" id="h321-0-628" class="d">-                val originalMedia = downloadedMediaList[SplitMediaAssetType.ORIGINAL] ?: return@async null
</a><a href="#h321-0-629" id="h321-0-629" class="d">-                val overlay = downloadedMediaList[SplitMediaAssetType.OVERLAY]
</a><a href="#h321-0-630" id="h321-0-630" class="d">-
</a><a href="#h321-0-631" id="h321-0-631" class="d">-                var bitmap: Bitmap? = PreviewUtils.createPreview(originalMedia, isVideo = FileType.fromByteArray(originalMedia).isVideo)
</a><a href="#h321-0-632" id="h321-0-632" class="d">-
</a><a href="#h321-0-633" id="h321-0-633" class="d">-                if (bitmap == null) {
</a><a href="#h321-0-634" id="h321-0-634" class="d">-                    context.shortToast(translations[&quot;failed_to_create_preview_toast&quot;])
</a><a href="#h321-0-635" id="h321-0-635" class="d">-                    return@async null
</a><a href="#h321-0-636" id="h321-0-636" class="d">-                }
</a><a href="#h321-0-637" id="h321-0-637" class="d">-
</a><a href="#h321-0-638" id="h321-0-638" class="d">-                overlay?.also {
</a><a href="#h321-0-639" id="h321-0-639" class="d">-                    bitmap = PreviewUtils.mergeBitmapOverlay(bitmap!!, BitmapFactory.decodeByteArray(it, 0, it.size))
</a><a href="#h321-0-640" id="h321-0-640" class="d">-                }
</a><a href="#h321-0-641" id="h321-0-641" class="d">-
</a><a href="#h321-0-642" id="h321-0-642" class="d">-                bitmap
</a><a href="#h321-0-643" id="h321-0-643" class="d">-            }
</a><a href="#h321-0-644" id="h321-0-644" class="d">-
</a><a href="#h321-0-645" id="h321-0-645" class="d">-            with(ViewAppearanceHelper.newAlertDialogBuilder(context.mainActivity)) {
</a><a href="#h321-0-646" id="h321-0-646" class="d">-                val viewGroup = LinearLayout(context).apply {
</a><a href="#h321-0-647" id="h321-0-647" class="d">-                    layoutParams = MarginLayoutParams(MarginLayoutParams.MATCH_PARENT, MarginLayoutParams.MATCH_PARENT)
</a><a href="#h321-0-648" id="h321-0-648" class="d">-                    gravity = Gravity.CENTER_HORIZONTAL or Gravity.CENTER_VERTICAL
</a><a href="#h321-0-649" id="h321-0-649" class="d">-                    addView(ProgressBar(context).apply {
</a><a href="#h321-0-650" id="h321-0-650" class="d">-                        isIndeterminate = true
</a><a href="#h321-0-651" id="h321-0-651" class="d">-                    })
</a><a href="#h321-0-652" id="h321-0-652" class="d">-                }
</a><a href="#h321-0-653" id="h321-0-653" class="d">-
</a><a href="#h321-0-654" id="h321-0-654" class="d">-                setOnDismissListener {
</a><a href="#h321-0-655" id="h321-0-655" class="d">-                    previewCoroutine.cancel()
</a><a href="#h321-0-656" id="h321-0-656" class="d">-                }
</a><a href="#h321-0-657" id="h321-0-657" class="d">-
</a><a href="#h321-0-658" id="h321-0-658" class="d">-                previewCoroutine.invokeOnCompletion { cause -&gt;
</a><a href="#h321-0-659" id="h321-0-659" class="d">-                    runOnUiThread {
</a><a href="#h321-0-660" id="h321-0-660" class="d">-                        viewGroup.removeAllViews()
</a><a href="#h321-0-661" id="h321-0-661" class="d">-                        if (cause != null) {
</a><a href="#h321-0-662" id="h321-0-662" class="d">-                            viewGroup.addView(TextView(context).apply {
</a><a href="#h321-0-663" id="h321-0-663" class="d">-                                text = translations[&quot;failed_to_create_preview_toast&quot;] + &quot;\n&quot; + cause.message
</a><a href="#h321-0-664" id="h321-0-664" class="d">-                                setPadding(30, 30, 30, 30)
</a><a href="#h321-0-665" id="h321-0-665" class="d">-                            })
</a><a href="#h321-0-666" id="h321-0-666" class="d">-                            return@runOnUiThread
</a><a href="#h321-0-667" id="h321-0-667" class="d">-                        }
</a><a href="#h321-0-668" id="h321-0-668" class="d">-
</a><a href="#h321-0-669" id="h321-0-669" class="d">-                        viewGroup.addView(ImageView(context).apply {
</a><a href="#h321-0-670" id="h321-0-670" class="d">-                            setImageBitmap(previewCoroutine.getCompleted())
</a><a href="#h321-0-671" id="h321-0-671" class="d">-                            layoutParams = LinearLayout.LayoutParams(
</a><a href="#h321-0-672" id="h321-0-672" class="d">-                                LinearLayout.LayoutParams.MATCH_PARENT,
</a><a href="#h321-0-673" id="h321-0-673" class="d">-                                LinearLayout.LayoutParams.MATCH_PARENT
</a><a href="#h321-0-674" id="h321-0-674" class="d">-                            )
</a><a href="#h321-0-675" id="h321-0-675" class="d">-                            adjustViewBounds = true
</a><a href="#h321-0-676" id="h321-0-676" class="d">-                        })
</a><a href="#h321-0-677" id="h321-0-677" class="d">-                    }
</a><a href="#h321-0-678" id="h321-0-678" class="d">-                }
</a><a href="#h321-0-679" id="h321-0-679" class="d">-
</a><a href="#h321-0-680" id="h321-0-680" class="d">-                runOnUiThread {
</a><a href="#h321-0-681" id="h321-0-681" class="d">-                    show().apply {
</a><a href="#h321-0-682" id="h321-0-682" class="d">-                        setContentView(viewGroup)
</a><a href="#h321-0-683" id="h321-0-683" class="d">-                        window?.setLayout(
</a><a href="#h321-0-684" id="h321-0-684" class="d">-                            context.resources.displayMetrics.widthPixels,
</a><a href="#h321-0-685" id="h321-0-685" class="d">-                            context.resources.displayMetrics.heightPixels
</a><a href="#h321-0-686" id="h321-0-686" class="d">-                        )
</a><a href="#h321-0-687" id="h321-0-687" class="d">-                    }
</a><a href="#h321-0-688" id="h321-0-688" class="d">-                    previewCoroutine.start()
</a><a href="#h321-0-689" id="h321-0-689" class="d">-                }
</a><a href="#h321-0-690" id="h321-0-690" class="d">-            }
</a><a href="#h321-0-691" id="h321-0-691" class="d">-        }
</a><a href="#h321-0-692" id="h321-0-692" class="d">-    }
</a><a href="#h321-0-693" id="h321-0-693" class="d">-
</a><a href="#h321-0-694" id="h321-0-694" class="d">-    fun downloadProfilePicture(url: String, author: String) {
</a><a href="#h321-0-695" id="h321-0-695" class="d">-        provideDownloadManagerClient(
</a><a href="#h321-0-696" id="h321-0-696" class="d">-            mediaIdentifier = url.hashCode().toString(16).replaceFirst(&quot;-&quot;, &quot;&quot;),
</a><a href="#h321-0-697" id="h321-0-697" class="d">-            mediaAuthor = author,
</a><a href="#h321-0-698" id="h321-0-698" class="d">-            downloadSource = MediaDownloadSource.PROFILE_PICTURE
</a><a href="#h321-0-699" id="h321-0-699" class="d">-        ).downloadSingleMedia(
</a><a href="#h321-0-700" id="h321-0-700" class="d">-            url,
</a><a href="#h321-0-701" id="h321-0-701" class="d">-            DownloadMediaType.REMOTE_MEDIA
</a><a href="#h321-0-702" id="h321-0-702" class="d">-        )
</a><a href="#h321-0-703" id="h321-0-703" class="d">-    }
</a><a href="#h321-0-704" id="h321-0-704" class="d">-
</a><a href="#h321-0-705" id="h321-0-705" class="d">-    /**
</a><a href="#h321-0-706" id="h321-0-706" class="d">-     * Called when a message is focused in chat
</a><a href="#h321-0-707" id="h321-0-707" class="d">-     */
</a><a href="#h321-0-708" id="h321-0-708" class="d">-    fun onMessageActionMenu(isPreviewMode: Boolean) {
</a><a href="#h321-0-709" id="h321-0-709" class="d">-        val messaging = context.feature(Messaging::class)
</a><a href="#h321-0-710" id="h321-0-710" class="d">-        if (messaging.openedConversationUUID == null) return
</a><a href="#h321-0-711" id="h321-0-711" class="d">-        downloadMessageId(messaging.lastFocusedMessageId, isPreviewMode)
</a><a href="#h321-0-712" id="h321-0-712" class="d">-    }
</a><a href="#h321-0-713" id="h321-0-713" class="d">-}
</a><b>diff --git a/<a id="h322" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/ProfilePictureDownloader.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/ProfilePictureDownloader.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/ProfilePictureDownloader.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/ProfilePictureDownloader.kt</a></b>
<a href="#h322-0" id="h322-0" class="h">@@ -1,80 +0,0 @@
</a><a href="#h322-0-0" id="h322-0-0" class="d">-package me.rhunk.snapenhance.features.impl.downloader
</a><a href="#h322-0-1" id="h322-0-1" class="d">-
</a><a href="#h322-0-2" id="h322-0-2" class="d">-import android.annotation.SuppressLint
</a><a href="#h322-0-3" id="h322-0-3" class="d">-import android.widget.Button
</a><a href="#h322-0-4" id="h322-0-4" class="d">-import android.widget.RelativeLayout
</a><a href="#h322-0-5" id="h322-0-5" class="d">-import me.rhunk.snapenhance.core.event.events.impl.AddViewEvent
</a><a href="#h322-0-6" id="h322-0-6" class="d">-import me.rhunk.snapenhance.core.event.events.impl.NetworkApiRequestEvent
</a><a href="#h322-0-7" id="h322-0-7" class="d">-import me.rhunk.snapenhance.core.util.protobuf.ProtoReader
</a><a href="#h322-0-8" id="h322-0-8" class="d">-import me.rhunk.snapenhance.features.Feature
</a><a href="#h322-0-9" id="h322-0-9" class="d">-import me.rhunk.snapenhance.features.FeatureLoadParams
</a><a href="#h322-0-10" id="h322-0-10" class="d">-import me.rhunk.snapenhance.hook.HookStage
</a><a href="#h322-0-11" id="h322-0-11" class="d">-import me.rhunk.snapenhance.hook.Hooker
</a><a href="#h322-0-12" id="h322-0-12" class="d">-import me.rhunk.snapenhance.ui.ViewAppearanceHelper
</a><a href="#h322-0-13" id="h322-0-13" class="d">-import java.nio.ByteBuffer
</a><a href="#h322-0-14" id="h322-0-14" class="d">-
</a><a href="#h322-0-15" id="h322-0-15" class="d">-class ProfilePictureDownloader : Feature(&quot;ProfilePictureDownloader&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_ASYNC) {
</a><a href="#h322-0-16" id="h322-0-16" class="d">-    @SuppressLint(&quot;SetTextI18n&quot;)
</a><a href="#h322-0-17" id="h322-0-17" class="d">-    override fun asyncOnActivityCreate() {
</a><a href="#h322-0-18" id="h322-0-18" class="d">-        if (!context.config.downloader.downloadProfilePictures.get()) return
</a><a href="#h322-0-19" id="h322-0-19" class="d">-
</a><a href="#h322-0-20" id="h322-0-20" class="d">-        var friendUsername: String? = null
</a><a href="#h322-0-21" id="h322-0-21" class="d">-        var backgroundUrl: String? = null
</a><a href="#h322-0-22" id="h322-0-22" class="d">-        var avatarUrl: String? = null
</a><a href="#h322-0-23" id="h322-0-23" class="d">-
</a><a href="#h322-0-24" id="h322-0-24" class="d">-        context.event.subscribe(AddViewEvent::class) { event -&gt;
</a><a href="#h322-0-25" id="h322-0-25" class="d">-            if (event.view::class.java.name != &quot;com.snap.unifiedpublicprofile.UnifiedPublicProfileView&quot;) return@subscribe
</a><a href="#h322-0-26" id="h322-0-26" class="d">-
</a><a href="#h322-0-27" id="h322-0-27" class="d">-            event.parent.addView(Button(event.parent.context).apply {
</a><a href="#h322-0-28" id="h322-0-28" class="d">-                text = this@ProfilePictureDownloader.context.translation[&quot;profile_picture_downloader.button&quot;]
</a><a href="#h322-0-29" id="h322-0-29" class="d">-                layoutParams = RelativeLayout.LayoutParams(RelativeLayout.LayoutParams.WRAP_CONTENT, RelativeLayout.LayoutParams.WRAP_CONTENT).apply {
</a><a href="#h322-0-30" id="h322-0-30" class="d">-                    setMargins(0, 200, 0, 0)
</a><a href="#h322-0-31" id="h322-0-31" class="d">-                }
</a><a href="#h322-0-32" id="h322-0-32" class="d">-                setOnClickListener {
</a><a href="#h322-0-33" id="h322-0-33" class="d">-                    ViewAppearanceHelper.newAlertDialogBuilder(
</a><a href="#h322-0-34" id="h322-0-34" class="d">-                        this@ProfilePictureDownloader.context.mainActivity!!
</a><a href="#h322-0-35" id="h322-0-35" class="d">-                    ).apply {
</a><a href="#h322-0-36" id="h322-0-36" class="d">-                        setTitle(this@ProfilePictureDownloader.context.translation[&quot;profile_picture_downloader.title&quot;])
</a><a href="#h322-0-37" id="h322-0-37" class="d">-                        val choices = mutableMapOf&lt;String, String&gt;()
</a><a href="#h322-0-38" id="h322-0-38" class="d">-                        backgroundUrl?.let { choices[&quot;avatar_option&quot;] = it }
</a><a href="#h322-0-39" id="h322-0-39" class="d">-                        avatarUrl?.let { choices[&quot;background_option&quot;] = it }
</a><a href="#h322-0-40" id="h322-0-40" class="d">-
</a><a href="#h322-0-41" id="h322-0-41" class="d">-                        setItems(choices.keys.map {
</a><a href="#h322-0-42" id="h322-0-42" class="d">-                            this@ProfilePictureDownloader.context.translation[&quot;profile_picture_downloader.$it&quot;]
</a><a href="#h322-0-43" id="h322-0-43" class="d">-                        }.toTypedArray()) { _, which -&gt;
</a><a href="#h322-0-44" id="h322-0-44" class="d">-                            runCatching {
</a><a href="#h322-0-45" id="h322-0-45" class="d">-                                this@ProfilePictureDownloader.context.feature(MediaDownloader::class).downloadProfilePicture(
</a><a href="#h322-0-46" id="h322-0-46" class="d">-                                    choices.values.elementAt(which),
</a><a href="#h322-0-47" id="h322-0-47" class="d">-                                    friendUsername!!
</a><a href="#h322-0-48" id="h322-0-48" class="d">-                                )
</a><a href="#h322-0-49" id="h322-0-49" class="d">-                            }.onFailure {
</a><a href="#h322-0-50" id="h322-0-50" class="d">-                                this@ProfilePictureDownloader.context.log.error(&quot;Failed to download profile picture&quot;, it)
</a><a href="#h322-0-51" id="h322-0-51" class="d">-                            }
</a><a href="#h322-0-52" id="h322-0-52" class="d">-                        }
</a><a href="#h322-0-53" id="h322-0-53" class="d">-                    }.show()
</a><a href="#h322-0-54" id="h322-0-54" class="d">-                }
</a><a href="#h322-0-55" id="h322-0-55" class="d">-            })
</a><a href="#h322-0-56" id="h322-0-56" class="d">-        }
</a><a href="#h322-0-57" id="h322-0-57" class="d">-
</a><a href="#h322-0-58" id="h322-0-58" class="d">-
</a><a href="#h322-0-59" id="h322-0-59" class="d">-        context.event.subscribe(NetworkApiRequestEvent::class) { event -&gt;
</a><a href="#h322-0-60" id="h322-0-60" class="d">-            if (!event.url.endsWith(&quot;/rpc/getPublicProfile&quot;)) return@subscribe
</a><a href="#h322-0-61" id="h322-0-61" class="d">-            Hooker.ephemeralHookObjectMethod(event.callback::class.java, event.callback, &quot;onSucceeded&quot;, HookStage.BEFORE) { methodParams -&gt;
</a><a href="#h322-0-62" id="h322-0-62" class="d">-                val content = methodParams.arg&lt;ByteBuffer&gt;(2).run {
</a><a href="#h322-0-63" id="h322-0-63" class="d">-                    ByteArray(capacity()).also {
</a><a href="#h322-0-64" id="h322-0-64" class="d">-                        get(it)
</a><a href="#h322-0-65" id="h322-0-65" class="d">-                        position(0)
</a><a href="#h322-0-66" id="h322-0-66" class="d">-                    }
</a><a href="#h322-0-67" id="h322-0-67" class="d">-                }
</a><a href="#h322-0-68" id="h322-0-68" class="d">-
</a><a href="#h322-0-69" id="h322-0-69" class="d">-                ProtoReader(content).followPath(1, 1, 2) {
</a><a href="#h322-0-70" id="h322-0-70" class="d">-                    friendUsername = getString(2) ?: return@followPath
</a><a href="#h322-0-71" id="h322-0-71" class="d">-                    followPath(4) {
</a><a href="#h322-0-72" id="h322-0-72" class="d">-                        backgroundUrl = getString(2)
</a><a href="#h322-0-73" id="h322-0-73" class="d">-                        avatarUrl = getString(100)
</a><a href="#h322-0-74" id="h322-0-74" class="d">-                    }
</a><a href="#h322-0-75" id="h322-0-75" class="d">-                }
</a><a href="#h322-0-76" id="h322-0-76" class="d">-            }
</a><a href="#h322-0-77" id="h322-0-77" class="d">-        }
</a><a href="#h322-0-78" id="h322-0-78" class="d">-    }
</a><a href="#h322-0-79" id="h322-0-79" class="d">-}</a><a href="#h322-0-80" id="h322-0-80" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h323" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/decoder/AttachmentInfo.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/decoder/AttachmentInfo.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/decoder/AttachmentInfo.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/decoder/AttachmentInfo.kt</a></b>
<a href="#h323-0" id="h323-0" class="h">@@ -1,15 +0,0 @@
</a><a href="#h323-0-0" id="h323-0-0" class="d">-package me.rhunk.snapenhance.features.impl.downloader.decoder
</a><a href="#h323-0-1" id="h323-0-1" class="d">-
</a><a href="#h323-0-2" id="h323-0-2" class="d">-import me.rhunk.snapenhance.core.download.data.MediaEncryptionKeyPair
</a><a href="#h323-0-3" id="h323-0-3" class="d">-
</a><a href="#h323-0-4" id="h323-0-4" class="d">-data class BitmojiSticker(
</a><a href="#h323-0-5" id="h323-0-5" class="d">-    val reference: String,
</a><a href="#h323-0-6" id="h323-0-6" class="d">-) : AttachmentInfo()
</a><a href="#h323-0-7" id="h323-0-7" class="d">-
</a><a href="#h323-0-8" id="h323-0-8" class="d">-open class AttachmentInfo(
</a><a href="#h323-0-9" id="h323-0-9" class="d">-    val encryption: MediaEncryptionKeyPair? = null,
</a><a href="#h323-0-10" id="h323-0-10" class="d">-    val resolution: Pair&lt;Int, Int&gt;? = null,
</a><a href="#h323-0-11" id="h323-0-11" class="d">-    val duration: Long? = null
</a><a href="#h323-0-12" id="h323-0-12" class="d">-) {
</a><a href="#h323-0-13" id="h323-0-13" class="d">-    override fun toString() = &quot;AttachmentInfo(encryption=$encryption, resolution=$resolution, duration=$duration)&quot;
</a><a href="#h323-0-14" id="h323-0-14" class="d">-}</a><a href="#h323-0-15" id="h323-0-15" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h324" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/decoder/AttachmentType.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/decoder/AttachmentType.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/decoder/AttachmentType.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/decoder/AttachmentType.kt</a></b>
<a href="#h324-0" id="h324-0" class="h">@@ -1,11 +0,0 @@
</a><a href="#h324-0-0" id="h324-0-0" class="d">-package me.rhunk.snapenhance.features.impl.downloader.decoder
</a><a href="#h324-0-1" id="h324-0-1" class="d">-
</a><a href="#h324-0-2" id="h324-0-2" class="d">-enum class AttachmentType(
</a><a href="#h324-0-3" id="h324-0-3" class="d">-    val key: String,
</a><a href="#h324-0-4" id="h324-0-4" class="d">-) {
</a><a href="#h324-0-5" id="h324-0-5" class="d">-    SNAP(&quot;snap&quot;),
</a><a href="#h324-0-6" id="h324-0-6" class="d">-    STICKER(&quot;sticker&quot;),
</a><a href="#h324-0-7" id="h324-0-7" class="d">-    EXTERNAL_MEDIA(&quot;external_media&quot;),
</a><a href="#h324-0-8" id="h324-0-8" class="d">-    NOTE(&quot;note&quot;),
</a><a href="#h324-0-9" id="h324-0-9" class="d">-    ORIGINAL_STORY(&quot;original_story&quot;),
</a><a href="#h324-0-10" id="h324-0-10" class="d">-}</a><a href="#h324-0-11" id="h324-0-11" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h325" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/decoder/MessageDecoder.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/decoder/MessageDecoder.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/decoder/MessageDecoder.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/decoder/MessageDecoder.kt</a></b>
<a href="#h325-0" id="h325-0" class="h">@@ -1,191 +0,0 @@
</a><a href="#h325-0-0" id="h325-0-0" class="d">-package me.rhunk.snapenhance.features.impl.downloader.decoder
</a><a href="#h325-0-1" id="h325-0-1" class="d">-
</a><a href="#h325-0-2" id="h325-0-2" class="d">-import com.google.gson.GsonBuilder
</a><a href="#h325-0-3" id="h325-0-3" class="d">-import com.google.gson.JsonElement
</a><a href="#h325-0-4" id="h325-0-4" class="d">-import com.google.gson.JsonObject
</a><a href="#h325-0-5" id="h325-0-5" class="d">-import me.rhunk.snapenhance.core.download.data.toKeyPair
</a><a href="#h325-0-6" id="h325-0-6" class="d">-import me.rhunk.snapenhance.core.util.protobuf.ProtoReader
</a><a href="#h325-0-7" id="h325-0-7" class="d">-import me.rhunk.snapenhance.data.wrapper.impl.MessageContent
</a><a href="#h325-0-8" id="h325-0-8" class="d">-import kotlin.io.encoding.Base64
</a><a href="#h325-0-9" id="h325-0-9" class="d">-import kotlin.io.encoding.ExperimentalEncodingApi
</a><a href="#h325-0-10" id="h325-0-10" class="d">-
</a><a href="#h325-0-11" id="h325-0-11" class="d">-data class DecodedAttachment(
</a><a href="#h325-0-12" id="h325-0-12" class="d">-    val mediaUrlKey: String?,
</a><a href="#h325-0-13" id="h325-0-13" class="d">-    val type: AttachmentType,
</a><a href="#h325-0-14" id="h325-0-14" class="d">-    val attachmentInfo: AttachmentInfo?
</a><a href="#h325-0-15" id="h325-0-15" class="d">-) {
</a><a href="#h325-0-16" id="h325-0-16" class="d">-    @OptIn(ExperimentalEncodingApi::class)
</a><a href="#h325-0-17" id="h325-0-17" class="d">-    val mediaUniqueId: String? by lazy {
</a><a href="#h325-0-18" id="h325-0-18" class="d">-        runCatching { Base64.UrlSafe.decode(mediaUrlKey.toString()) }.getOrNull()?.let { ProtoReader(it).getString(2, 2) }
</a><a href="#h325-0-19" id="h325-0-19" class="d">-    }
</a><a href="#h325-0-20" id="h325-0-20" class="d">-}
</a><a href="#h325-0-21" id="h325-0-21" class="d">-
</a><a href="#h325-0-22" id="h325-0-22" class="d">-@OptIn(ExperimentalEncodingApi::class)
</a><a href="#h325-0-23" id="h325-0-23" class="d">-object MessageDecoder {
</a><a href="#h325-0-24" id="h325-0-24" class="d">-    private val gson = GsonBuilder().create()
</a><a href="#h325-0-25" id="h325-0-25" class="d">-
</a><a href="#h325-0-26" id="h325-0-26" class="d">-    private fun decodeAttachment(protoReader: ProtoReader): AttachmentInfo? {
</a><a href="#h325-0-27" id="h325-0-27" class="d">-        val mediaInfo = protoReader.followPath(1, 1) ?: return null
</a><a href="#h325-0-28" id="h325-0-28" class="d">-
</a><a href="#h325-0-29" id="h325-0-29" class="d">-        return AttachmentInfo(
</a><a href="#h325-0-30" id="h325-0-30" class="d">-            encryption = run {
</a><a href="#h325-0-31" id="h325-0-31" class="d">-                val encryptionProtoIndex = if (mediaInfo.contains(19)) 19 else 4
</a><a href="#h325-0-32" id="h325-0-32" class="d">-                val encryptionProto = mediaInfo.followPath(encryptionProtoIndex) ?: return@run null
</a><a href="#h325-0-33" id="h325-0-33" class="d">-
</a><a href="#h325-0-34" id="h325-0-34" class="d">-                var key = encryptionProto.getByteArray(1) ?: return@run null
</a><a href="#h325-0-35" id="h325-0-35" class="d">-                var iv = encryptionProto.getByteArray(2) ?: return@run null
</a><a href="#h325-0-36" id="h325-0-36" class="d">-
</a><a href="#h325-0-37" id="h325-0-37" class="d">-                if (encryptionProtoIndex == 4) {
</a><a href="#h325-0-38" id="h325-0-38" class="d">-                    key = Base64.decode(encryptionProto.getString(1)?.replace(&quot;\n&quot;,&quot;&quot;) ?: return@run null)
</a><a href="#h325-0-39" id="h325-0-39" class="d">-                    iv = Base64.decode(encryptionProto.getString(2)?.replace(&quot;\n&quot;,&quot;&quot;) ?: return@run null)
</a><a href="#h325-0-40" id="h325-0-40" class="d">-                }
</a><a href="#h325-0-41" id="h325-0-41" class="d">-
</a><a href="#h325-0-42" id="h325-0-42" class="d">-                Pair(key, iv).toKeyPair()
</a><a href="#h325-0-43" id="h325-0-43" class="d">-            },
</a><a href="#h325-0-44" id="h325-0-44" class="d">-            resolution = mediaInfo.followPath(5)?.let {
</a><a href="#h325-0-45" id="h325-0-45" class="d">-                (it.getVarInt(1)?.toInt() ?: 0) to (it.getVarInt(2)?.toInt() ?: 0)
</a><a href="#h325-0-46" id="h325-0-46" class="d">-            },
</a><a href="#h325-0-47" id="h325-0-47" class="d">-            duration = mediaInfo.getVarInt(15)   // external medias
</a><a href="#h325-0-48" id="h325-0-48" class="d">-                ?: mediaInfo.getVarInt(13) // audio notes
</a><a href="#h325-0-49" id="h325-0-49" class="d">-        )
</a><a href="#h325-0-50" id="h325-0-50" class="d">-    }
</a><a href="#h325-0-51" id="h325-0-51" class="d">-
</a><a href="#h325-0-52" id="h325-0-52" class="d">-    @OptIn(ExperimentalEncodingApi::class)
</a><a href="#h325-0-53" id="h325-0-53" class="d">-    fun getEncodedMediaReferences(messageContent: JsonElement): List&lt;String&gt; {
</a><a href="#h325-0-54" id="h325-0-54" class="d">-        return getMediaReferences(messageContent).map { reference -&gt;
</a><a href="#h325-0-55" id="h325-0-55" class="d">-                Base64.UrlSafe.encode(
</a><a href="#h325-0-56" id="h325-0-56" class="d">-                    reference.asJsonObject.getAsJsonArray(&quot;mContentObject&quot;).map { it.asByte }.toByteArray()
</a><a href="#h325-0-57" id="h325-0-57" class="d">-                )
</a><a href="#h325-0-58" id="h325-0-58" class="d">-            }
</a><a href="#h325-0-59" id="h325-0-59" class="d">-            .toList()
</a><a href="#h325-0-60" id="h325-0-60" class="d">-    }
</a><a href="#h325-0-61" id="h325-0-61" class="d">-
</a><a href="#h325-0-62" id="h325-0-62" class="d">-    fun getMediaReferences(messageContent: JsonElement): List&lt;JsonElement&gt; {
</a><a href="#h325-0-63" id="h325-0-63" class="d">-        return messageContent.asJsonObject.getAsJsonArray(&quot;mRemoteMediaReferences&quot;)
</a><a href="#h325-0-64" id="h325-0-64" class="d">-            .asSequence()
</a><a href="#h325-0-65" id="h325-0-65" class="d">-            .map { it.asJsonObject.getAsJsonArray(&quot;mMediaReferences&quot;) }
</a><a href="#h325-0-66" id="h325-0-66" class="d">-            .flatten()
</a><a href="#h325-0-67" id="h325-0-67" class="d">-            .sortedBy {
</a><a href="#h325-0-68" id="h325-0-68" class="d">-                it.asJsonObject[&quot;mMediaListId&quot;].asLong
</a><a href="#h325-0-69" id="h325-0-69" class="d">-            }.toList()
</a><a href="#h325-0-70" id="h325-0-70" class="d">-    }
</a><a href="#h325-0-71" id="h325-0-71" class="d">-
</a><a href="#h325-0-72" id="h325-0-72" class="d">-
</a><a href="#h325-0-73" id="h325-0-73" class="d">-    fun decode(messageContent: MessageContent): List&lt;DecodedAttachment&gt; {
</a><a href="#h325-0-74" id="h325-0-74" class="d">-        return decode(
</a><a href="#h325-0-75" id="h325-0-75" class="d">-            ProtoReader(messageContent.content),
</a><a href="#h325-0-76" id="h325-0-76" class="d">-            customMediaReferences = getEncodedMediaReferences(gson.toJsonTree(messageContent.instanceNonNull()))
</a><a href="#h325-0-77" id="h325-0-77" class="d">-        )
</a><a href="#h325-0-78" id="h325-0-78" class="d">-    }
</a><a href="#h325-0-79" id="h325-0-79" class="d">-
</a><a href="#h325-0-80" id="h325-0-80" class="d">-    fun decode(messageContent: JsonObject): List&lt;DecodedAttachment&gt; {
</a><a href="#h325-0-81" id="h325-0-81" class="d">-        return decode(
</a><a href="#h325-0-82" id="h325-0-82" class="d">-            ProtoReader(messageContent.getAsJsonArray(&quot;mContent&quot;)
</a><a href="#h325-0-83" id="h325-0-83" class="d">-                .map { it.asByte }
</a><a href="#h325-0-84" id="h325-0-84" class="d">-                .toByteArray()),
</a><a href="#h325-0-85" id="h325-0-85" class="d">-            customMediaReferences = getEncodedMediaReferences(messageContent)
</a><a href="#h325-0-86" id="h325-0-86" class="d">-        )
</a><a href="#h325-0-87" id="h325-0-87" class="d">-    }
</a><a href="#h325-0-88" id="h325-0-88" class="d">-
</a><a href="#h325-0-89" id="h325-0-89" class="d">-    fun decode(
</a><a href="#h325-0-90" id="h325-0-90" class="d">-        protoReader: ProtoReader,
</a><a href="#h325-0-91" id="h325-0-91" class="d">-        customMediaReferences: List&lt;String&gt;? = null // when customReferences is null it means that the message is from arroyo database
</a><a href="#h325-0-92" id="h325-0-92" class="d">-    ): List&lt;DecodedAttachment&gt; {
</a><a href="#h325-0-93" id="h325-0-93" class="d">-        val decodedAttachment = mutableListOf&lt;DecodedAttachment&gt;()
</a><a href="#h325-0-94" id="h325-0-94" class="d">-        val mediaReferences = mutableListOf&lt;String&gt;()
</a><a href="#h325-0-95" id="h325-0-95" class="d">-        customMediaReferences?.let { mediaReferences.addAll(it) }
</a><a href="#h325-0-96" id="h325-0-96" class="d">-        var mediaKeyIndex = 0
</a><a href="#h325-0-97" id="h325-0-97" class="d">-
</a><a href="#h325-0-98" id="h325-0-98" class="d">-        fun decodeMedia(type: AttachmentType, protoReader: ProtoReader) {
</a><a href="#h325-0-99" id="h325-0-99" class="d">-            decodedAttachment.add(
</a><a href="#h325-0-100" id="h325-0-100" class="d">-                DecodedAttachment(
</a><a href="#h325-0-101" id="h325-0-101" class="d">-                    mediaUrlKey = mediaReferences.getOrNull(mediaKeyIndex++),
</a><a href="#h325-0-102" id="h325-0-102" class="d">-                    type = type,
</a><a href="#h325-0-103" id="h325-0-103" class="d">-                    attachmentInfo = decodeAttachment(protoReader) ?: return
</a><a href="#h325-0-104" id="h325-0-104" class="d">-                )
</a><a href="#h325-0-105" id="h325-0-105" class="d">-            )
</a><a href="#h325-0-106" id="h325-0-106" class="d">-        }
</a><a href="#h325-0-107" id="h325-0-107" class="d">-
</a><a href="#h325-0-108" id="h325-0-108" class="d">-        // for snaps, external media, and original story replies
</a><a href="#h325-0-109" id="h325-0-109" class="d">-        fun decodeDirectMedia(type: AttachmentType, protoReader: ProtoReader) {
</a><a href="#h325-0-110" id="h325-0-110" class="d">-            protoReader.followPath(5) { decodeMedia(type,this) }
</a><a href="#h325-0-111" id="h325-0-111" class="d">-        }
</a><a href="#h325-0-112" id="h325-0-112" class="d">-
</a><a href="#h325-0-113" id="h325-0-113" class="d">-        fun decodeSticker(protoReader: ProtoReader) {
</a><a href="#h325-0-114" id="h325-0-114" class="d">-            protoReader.followPath(1) {
</a><a href="#h325-0-115" id="h325-0-115" class="d">-                decodedAttachment.add(
</a><a href="#h325-0-116" id="h325-0-116" class="d">-                    DecodedAttachment(
</a><a href="#h325-0-117" id="h325-0-117" class="d">-                        mediaUrlKey = null,
</a><a href="#h325-0-118" id="h325-0-118" class="d">-                        type = AttachmentType.STICKER,
</a><a href="#h325-0-119" id="h325-0-119" class="d">-                        attachmentInfo = BitmojiSticker(
</a><a href="#h325-0-120" id="h325-0-120" class="d">-                            reference = getString(2) ?: return@followPath
</a><a href="#h325-0-121" id="h325-0-121" class="d">-                        )
</a><a href="#h325-0-122" id="h325-0-122" class="d">-                    )
</a><a href="#h325-0-123" id="h325-0-123" class="d">-                )
</a><a href="#h325-0-124" id="h325-0-124" class="d">-            }
</a><a href="#h325-0-125" id="h325-0-125" class="d">-        }
</a><a href="#h325-0-126" id="h325-0-126" class="d">-
</a><a href="#h325-0-127" id="h325-0-127" class="d">-        // media keys
</a><a href="#h325-0-128" id="h325-0-128" class="d">-        protoReader.eachBuffer(4, 5) {
</a><a href="#h325-0-129" id="h325-0-129" class="d">-            getByteArray(1, 3)?.also { mediaKey -&gt;
</a><a href="#h325-0-130" id="h325-0-130" class="d">-                mediaReferences.add(Base64.UrlSafe.encode(mediaKey))
</a><a href="#h325-0-131" id="h325-0-131" class="d">-            }
</a><a href="#h325-0-132" id="h325-0-132" class="d">-        }
</a><a href="#h325-0-133" id="h325-0-133" class="d">-
</a><a href="#h325-0-134" id="h325-0-134" class="d">-        val mediaReader = customMediaReferences?.let { protoReader } ?: protoReader.followPath(4, 4) ?: return emptyList()
</a><a href="#h325-0-135" id="h325-0-135" class="d">-
</a><a href="#h325-0-136" id="h325-0-136" class="d">-        mediaReader.apply {
</a><a href="#h325-0-137" id="h325-0-137" class="d">-            // external media
</a><a href="#h325-0-138" id="h325-0-138" class="d">-            eachBuffer(3, 3) {
</a><a href="#h325-0-139" id="h325-0-139" class="d">-                decodeDirectMedia(AttachmentType.EXTERNAL_MEDIA, this)
</a><a href="#h325-0-140" id="h325-0-140" class="d">-            }
</a><a href="#h325-0-141" id="h325-0-141" class="d">-
</a><a href="#h325-0-142" id="h325-0-142" class="d">-            // stickers
</a><a href="#h325-0-143" id="h325-0-143" class="d">-            followPath(4) { decodeSticker(this) }
</a><a href="#h325-0-144" id="h325-0-144" class="d">-
</a><a href="#h325-0-145" id="h325-0-145" class="d">-            // shares
</a><a href="#h325-0-146" id="h325-0-146" class="d">-            followPath(5, 24, 2) {
</a><a href="#h325-0-147" id="h325-0-147" class="d">-                decodeDirectMedia(AttachmentType.EXTERNAL_MEDIA, this)
</a><a href="#h325-0-148" id="h325-0-148" class="d">-            }
</a><a href="#h325-0-149" id="h325-0-149" class="d">-
</a><a href="#h325-0-150" id="h325-0-150" class="d">-            // audio notes
</a><a href="#h325-0-151" id="h325-0-151" class="d">-            followPath(6) note@{
</a><a href="#h325-0-152" id="h325-0-152" class="d">-                val audioNote = decodeAttachment(this) ?: return@note
</a><a href="#h325-0-153" id="h325-0-153" class="d">-
</a><a href="#h325-0-154" id="h325-0-154" class="d">-                decodedAttachment.add(
</a><a href="#h325-0-155" id="h325-0-155" class="d">-                    DecodedAttachment(
</a><a href="#h325-0-156" id="h325-0-156" class="d">-                        mediaUrlKey = mediaReferences.getOrNull(mediaKeyIndex++),
</a><a href="#h325-0-157" id="h325-0-157" class="d">-                        type = AttachmentType.NOTE,
</a><a href="#h325-0-158" id="h325-0-158" class="d">-                        attachmentInfo = audioNote
</a><a href="#h325-0-159" id="h325-0-159" class="d">-                    )
</a><a href="#h325-0-160" id="h325-0-160" class="d">-                )
</a><a href="#h325-0-161" id="h325-0-161" class="d">-            }
</a><a href="#h325-0-162" id="h325-0-162" class="d">-
</a><a href="#h325-0-163" id="h325-0-163" class="d">-            // story replies
</a><a href="#h325-0-164" id="h325-0-164" class="d">-            followPath(7) {
</a><a href="#h325-0-165" id="h325-0-165" class="d">-                // original story reply
</a><a href="#h325-0-166" id="h325-0-166" class="d">-                followPath(3) {
</a><a href="#h325-0-167" id="h325-0-167" class="d">-                    decodeDirectMedia(AttachmentType.ORIGINAL_STORY, this)
</a><a href="#h325-0-168" id="h325-0-168" class="d">-                }
</a><a href="#h325-0-169" id="h325-0-169" class="d">-
</a><a href="#h325-0-170" id="h325-0-170" class="d">-                // external medias
</a><a href="#h325-0-171" id="h325-0-171" class="d">-                followPath(12) {
</a><a href="#h325-0-172" id="h325-0-172" class="d">-                    eachBuffer(3) { decodeDirectMedia(AttachmentType.EXTERNAL_MEDIA, this) }
</a><a href="#h325-0-173" id="h325-0-173" class="d">-                }
</a><a href="#h325-0-174" id="h325-0-174" class="d">-
</a><a href="#h325-0-175" id="h325-0-175" class="d">-                // attached sticker
</a><a href="#h325-0-176" id="h325-0-176" class="d">-                followPath(13) { decodeSticker(this) }
</a><a href="#h325-0-177" id="h325-0-177" class="d">-
</a><a href="#h325-0-178" id="h325-0-178" class="d">-                // attached audio note
</a><a href="#h325-0-179" id="h325-0-179" class="d">-                followPath(15) { decodeMedia(AttachmentType.NOTE, this) }
</a><a href="#h325-0-180" id="h325-0-180" class="d">-            }
</a><a href="#h325-0-181" id="h325-0-181" class="d">-
</a><a href="#h325-0-182" id="h325-0-182" class="d">-            // snaps
</a><a href="#h325-0-183" id="h325-0-183" class="d">-            followPath(11) {
</a><a href="#h325-0-184" id="h325-0-184" class="d">-                decodeDirectMedia(AttachmentType.SNAP, this)
</a><a href="#h325-0-185" id="h325-0-185" class="d">-            }
</a><a href="#h325-0-186" id="h325-0-186" class="d">-        }
</a><a href="#h325-0-187" id="h325-0-187" class="d">-
</a><a href="#h325-0-188" id="h325-0-188" class="d">-        return decodedAttachment
</a><a href="#h325-0-189" id="h325-0-189" class="d">-    }
</a><a href="#h325-0-190" id="h325-0-190" class="d">-}</a><a href="#h325-0-191" id="h325-0-191" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h326" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/experiments/AddFriendSourceSpoof.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/experiments/AddFriendSourceSpoof.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/experiments/AddFriendSourceSpoof.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/experiments/AddFriendSourceSpoof.kt</a></b>
<a href="#h326-0" id="h326-0" class="h">@@ -1,55 +0,0 @@
</a><a href="#h326-0-0" id="h326-0-0" class="d">-package me.rhunk.snapenhance.features.impl.experiments
</a><a href="#h326-0-1" id="h326-0-1" class="d">-
</a><a href="#h326-0-2" id="h326-0-2" class="d">-import me.rhunk.snapenhance.features.Feature
</a><a href="#h326-0-3" id="h326-0-3" class="d">-import me.rhunk.snapenhance.features.FeatureLoadParams
</a><a href="#h326-0-4" id="h326-0-4" class="d">-import me.rhunk.snapenhance.hook.HookStage
</a><a href="#h326-0-5" id="h326-0-5" class="d">-import me.rhunk.snapenhance.hook.hook
</a><a href="#h326-0-6" id="h326-0-6" class="d">-
</a><a href="#h326-0-7" id="h326-0-7" class="d">-class AddFriendSourceSpoof : Feature(&quot;AddFriendSourceSpoof&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_ASYNC) {
</a><a href="#h326-0-8" id="h326-0-8" class="d">-    override fun asyncOnActivityCreate() {
</a><a href="#h326-0-9" id="h326-0-9" class="d">-        val friendRelationshipChangerMapping = context.mappings.getMappedMap(&quot;FriendRelationshipChanger&quot;)
</a><a href="#h326-0-10" id="h326-0-10" class="d">-
</a><a href="#h326-0-11" id="h326-0-11" class="d">-        findClass(friendRelationshipChangerMapping[&quot;class&quot;].toString())
</a><a href="#h326-0-12" id="h326-0-12" class="d">-            .hook(friendRelationshipChangerMapping[&quot;addFriendMethod&quot;].toString(), HookStage.BEFORE) { param -&gt;
</a><a href="#h326-0-13" id="h326-0-13" class="d">-            val spoofedSource = context.config.experimental.addFriendSourceSpoof.getNullable() ?: return@hook
</a><a href="#h326-0-14" id="h326-0-14" class="d">-
</a><a href="#h326-0-15" id="h326-0-15" class="d">-            context.log.verbose(&quot;addFriendMethod: ${param.args().toList()}&quot;, featureKey)
</a><a href="#h326-0-16" id="h326-0-16" class="d">-
</a><a href="#h326-0-17" id="h326-0-17" class="d">-            fun setEnum(index: Int, value: String) {
</a><a href="#h326-0-18" id="h326-0-18" class="d">-                val enumData = param.arg&lt;Any&gt;(index)
</a><a href="#h326-0-19" id="h326-0-19" class="d">-                enumData::class.java.enumConstants.first { it.toString() == value }.let {
</a><a href="#h326-0-20" id="h326-0-20" class="d">-                    param.setArg(index, it)
</a><a href="#h326-0-21" id="h326-0-21" class="d">-                }
</a><a href="#h326-0-22" id="h326-0-22" class="d">-            }
</a><a href="#h326-0-23" id="h326-0-23" class="d">-
</a><a href="#h326-0-24" id="h326-0-24" class="d">-            when (spoofedSource) {
</a><a href="#h326-0-25" id="h326-0-25" class="d">-                &quot;added_by_group_chat&quot; -&gt; {
</a><a href="#h326-0-26" id="h326-0-26" class="d">-                    setEnum(1, &quot;PROFILE&quot;)
</a><a href="#h326-0-27" id="h326-0-27" class="d">-                    setEnum(2, &quot;GROUP_PROFILE&quot;)
</a><a href="#h326-0-28" id="h326-0-28" class="d">-                    setEnum(3, &quot;ADDED_BY_GROUP_CHAT&quot;)
</a><a href="#h326-0-29" id="h326-0-29" class="d">-                }
</a><a href="#h326-0-30" id="h326-0-30" class="d">-                &quot;added_by_username&quot; -&gt; {
</a><a href="#h326-0-31" id="h326-0-31" class="d">-                    setEnum(1, &quot;SEARCH&quot;)
</a><a href="#h326-0-32" id="h326-0-32" class="d">-                    setEnum(2, &quot;SEARCH&quot;)
</a><a href="#h326-0-33" id="h326-0-33" class="d">-                    setEnum(3, &quot;ADDED_BY_USERNAME&quot;)
</a><a href="#h326-0-34" id="h326-0-34" class="d">-                }
</a><a href="#h326-0-35" id="h326-0-35" class="d">-                &quot;added_by_qr_code&quot; -&gt; {
</a><a href="#h326-0-36" id="h326-0-36" class="d">-                    setEnum(1, &quot;PROFILE&quot;)
</a><a href="#h326-0-37" id="h326-0-37" class="d">-                    setEnum(2, &quot;PROFILE&quot;)
</a><a href="#h326-0-38" id="h326-0-38" class="d">-                    setEnum(3, &quot;ADDED_BY_QR_CODE&quot;)
</a><a href="#h326-0-39" id="h326-0-39" class="d">-                }
</a><a href="#h326-0-40" id="h326-0-40" class="d">-                &quot;added_by_mention&quot; -&gt; {
</a><a href="#h326-0-41" id="h326-0-41" class="d">-                    setEnum(1, &quot;CONTEXT_CARDS&quot;)
</a><a href="#h326-0-42" id="h326-0-42" class="d">-                    setEnum(2, &quot;CONTEXT_CARD&quot;)
</a><a href="#h326-0-43" id="h326-0-43" class="d">-                    setEnum(3, &quot;ADDED_BY_MENTION&quot;)
</a><a href="#h326-0-44" id="h326-0-44" class="d">-                }
</a><a href="#h326-0-45" id="h326-0-45" class="d">-                &quot;added_by_community&quot; -&gt; {
</a><a href="#h326-0-46" id="h326-0-46" class="d">-                    setEnum(1, &quot;PROFILE&quot;)
</a><a href="#h326-0-47" id="h326-0-47" class="d">-                    setEnum(2, &quot;PROFILE&quot;)
</a><a href="#h326-0-48" id="h326-0-48" class="d">-                    setEnum(3, &quot;ADDED_BY_COMMUNITY&quot;)
</a><a href="#h326-0-49" id="h326-0-49" class="d">-                }
</a><a href="#h326-0-50" id="h326-0-50" class="d">-                else -&gt; return@hook
</a><a href="#h326-0-51" id="h326-0-51" class="d">-            }
</a><a href="#h326-0-52" id="h326-0-52" class="d">-        }
</a><a href="#h326-0-53" id="h326-0-53" class="d">-    }
</a><a href="#h326-0-54" id="h326-0-54" class="d">-}</a><a href="#h326-0-55" id="h326-0-55" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h327" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/experiments/AmoledDarkMode.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/experiments/AmoledDarkMode.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/experiments/AmoledDarkMode.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/experiments/AmoledDarkMode.kt</a></b>
<a href="#h327-0" id="h327-0" class="h">@@ -1,49 +0,0 @@
</a><a href="#h327-0-0" id="h327-0-0" class="d">-package me.rhunk.snapenhance.features.impl.experiments
</a><a href="#h327-0-1" id="h327-0-1" class="d">-
</a><a href="#h327-0-2" id="h327-0-2" class="d">-import android.annotation.SuppressLint
</a><a href="#h327-0-3" id="h327-0-3" class="d">-import android.content.res.TypedArray
</a><a href="#h327-0-4" id="h327-0-4" class="d">-import android.graphics.drawable.ColorDrawable
</a><a href="#h327-0-5" id="h327-0-5" class="d">-import me.rhunk.snapenhance.Constants
</a><a href="#h327-0-6" id="h327-0-6" class="d">-import me.rhunk.snapenhance.features.Feature
</a><a href="#h327-0-7" id="h327-0-7" class="d">-import me.rhunk.snapenhance.features.FeatureLoadParams
</a><a href="#h327-0-8" id="h327-0-8" class="d">-import me.rhunk.snapenhance.hook.HookStage
</a><a href="#h327-0-9" id="h327-0-9" class="d">-import me.rhunk.snapenhance.hook.Hooker
</a><a href="#h327-0-10" id="h327-0-10" class="d">-import me.rhunk.snapenhance.hook.hook
</a><a href="#h327-0-11" id="h327-0-11" class="d">-
</a><a href="#h327-0-12" id="h327-0-12" class="d">-class AmoledDarkMode : Feature(&quot;Amoled Dark Mode&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_SYNC) {
</a><a href="#h327-0-13" id="h327-0-13" class="d">-    @SuppressLint(&quot;DiscouragedApi&quot;)
</a><a href="#h327-0-14" id="h327-0-14" class="d">-    override fun onActivityCreate() {
</a><a href="#h327-0-15" id="h327-0-15" class="d">-        if (!context.config.userInterface.amoledDarkMode.get()) return
</a><a href="#h327-0-16" id="h327-0-16" class="d">-        val attributeCache = mutableMapOf&lt;String, Int&gt;()
</a><a href="#h327-0-17" id="h327-0-17" class="d">-
</a><a href="#h327-0-18" id="h327-0-18" class="d">-        fun getAttribute(name: String): Int {
</a><a href="#h327-0-19" id="h327-0-19" class="d">-            if (attributeCache.containsKey(name)) return attributeCache[name]!!
</a><a href="#h327-0-20" id="h327-0-20" class="d">-            return context.resources.getIdentifier(name, &quot;attr&quot;, Constants.SNAPCHAT_PACKAGE_NAME).also { attributeCache[name] = it }
</a><a href="#h327-0-21" id="h327-0-21" class="d">-        }
</a><a href="#h327-0-22" id="h327-0-22" class="d">-
</a><a href="#h327-0-23" id="h327-0-23" class="d">-        context.androidContext.theme.javaClass.getMethod(&quot;obtainStyledAttributes&quot;, IntArray::class.java).hook(HookStage.AFTER) { param -&gt;
</a><a href="#h327-0-24" id="h327-0-24" class="d">-            val array = param.arg&lt;IntArray&gt;(0)
</a><a href="#h327-0-25" id="h327-0-25" class="d">-            val result = param.getResult() as TypedArray
</a><a href="#h327-0-26" id="h327-0-26" class="d">-
</a><a href="#h327-0-27" id="h327-0-27" class="d">-            fun ephemeralHook(methodName: String, content: Any) {
</a><a href="#h327-0-28" id="h327-0-28" class="d">-                Hooker.ephemeralHookObjectMethod(result::class.java, result, methodName, HookStage.BEFORE) {
</a><a href="#h327-0-29" id="h327-0-29" class="d">-                    it.setResult(content)
</a><a href="#h327-0-30" id="h327-0-30" class="d">-                }
</a><a href="#h327-0-31" id="h327-0-31" class="d">-            }
</a><a href="#h327-0-32" id="h327-0-32" class="d">-
</a><a href="#h327-0-33" id="h327-0-33" class="d">-            when (array[0]) {
</a><a href="#h327-0-34" id="h327-0-34" class="d">-                getAttribute(&quot;sigColorTextPrimary&quot;) -&gt; {
</a><a href="#h327-0-35" id="h327-0-35" class="d">-                    ephemeralHook(&quot;getColor&quot;, 0xFFFFFFFF.toInt())
</a><a href="#h327-0-36" id="h327-0-36" class="d">-                }
</a><a href="#h327-0-37" id="h327-0-37" class="d">-                getAttribute(&quot;sigColorBackgroundMain&quot;),
</a><a href="#h327-0-38" id="h327-0-38" class="d">-                getAttribute(&quot;sigColorBackgroundSurface&quot;) -&gt; {
</a><a href="#h327-0-39" id="h327-0-39" class="d">-                    ephemeralHook(&quot;getColor&quot;, 0xFF000000.toInt())
</a><a href="#h327-0-40" id="h327-0-40" class="d">-                }
</a><a href="#h327-0-41" id="h327-0-41" class="d">-                getAttribute(&quot;actionSheetBackgroundDrawable&quot;),
</a><a href="#h327-0-42" id="h327-0-42" class="d">-                getAttribute(&quot;actionSheetRoundedBackgroundDrawable&quot;) -&gt; {
</a><a href="#h327-0-43" id="h327-0-43" class="d">-                    ephemeralHook(&quot;getDrawable&quot;, ColorDrawable(0xFF000000.toInt()))
</a><a href="#h327-0-44" id="h327-0-44" class="d">-                }
</a><a href="#h327-0-45" id="h327-0-45" class="d">-            }
</a><a href="#h327-0-46" id="h327-0-46" class="d">-        }
</a><a href="#h327-0-47" id="h327-0-47" class="d">-    }
</a><a href="#h327-0-48" id="h327-0-48" class="d">-}</a><a href="#h327-0-49" id="h327-0-49" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h328" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/experiments/AppPasscode.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/experiments/AppPasscode.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/experiments/AppPasscode.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/experiments/AppPasscode.kt</a></b>
<a href="#h328-0" id="h328-0" class="h">@@ -1,106 +0,0 @@
</a><a href="#h328-0-0" id="h328-0-0" class="d">-package me.rhunk.snapenhance.features.impl.experiments
</a><a href="#h328-0-1" id="h328-0-1" class="d">-
</a><a href="#h328-0-2" id="h328-0-2" class="d">-import android.annotation.SuppressLint
</a><a href="#h328-0-3" id="h328-0-3" class="d">-import android.content.Context
</a><a href="#h328-0-4" id="h328-0-4" class="d">-import android.os.Build
</a><a href="#h328-0-5" id="h328-0-5" class="d">-import android.text.Editable
</a><a href="#h328-0-6" id="h328-0-6" class="d">-import android.text.InputType
</a><a href="#h328-0-7" id="h328-0-7" class="d">-import android.text.TextWatcher
</a><a href="#h328-0-8" id="h328-0-8" class="d">-import android.view.inputmethod.InputMethodManager
</a><a href="#h328-0-9" id="h328-0-9" class="d">-import android.widget.EditText
</a><a href="#h328-0-10" id="h328-0-10" class="d">-import me.rhunk.snapenhance.features.Feature
</a><a href="#h328-0-11" id="h328-0-11" class="d">-import me.rhunk.snapenhance.features.FeatureLoadParams
</a><a href="#h328-0-12" id="h328-0-12" class="d">-import me.rhunk.snapenhance.ui.ViewAppearanceHelper
</a><a href="#h328-0-13" id="h328-0-13" class="d">-
</a><a href="#h328-0-14" id="h328-0-14" class="d">-//TODO: fingerprint unlock
</a><a href="#h328-0-15" id="h328-0-15" class="d">-class AppPasscode : Feature(&quot;App Passcode&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_SYNC) {
</a><a href="#h328-0-16" id="h328-0-16" class="d">-    private var isLocked = false
</a><a href="#h328-0-17" id="h328-0-17" class="d">-
</a><a href="#h328-0-18" id="h328-0-18" class="d">-    private fun setActivityVisibility(isVisible: Boolean) {
</a><a href="#h328-0-19" id="h328-0-19" class="d">-        context.mainActivity?.let {
</a><a href="#h328-0-20" id="h328-0-20" class="d">-            it.window.attributes = it.window.attributes.apply { alpha = if (isVisible) 1.0F else 0.0F }
</a><a href="#h328-0-21" id="h328-0-21" class="d">-        }
</a><a href="#h328-0-22" id="h328-0-22" class="d">-    }
</a><a href="#h328-0-23" id="h328-0-23" class="d">-
</a><a href="#h328-0-24" id="h328-0-24" class="d">-    fun lock() {
</a><a href="#h328-0-25" id="h328-0-25" class="d">-        if (isLocked) return
</a><a href="#h328-0-26" id="h328-0-26" class="d">-        isLocked = true
</a><a href="#h328-0-27" id="h328-0-27" class="d">-        val passcode by context.config.experimental.appPasscode.also {
</a><a href="#h328-0-28" id="h328-0-28" class="d">-            if (it.getNullable()?.isEmpty() != false) return
</a><a href="#h328-0-29" id="h328-0-29" class="d">-        }
</a><a href="#h328-0-30" id="h328-0-30" class="d">-        val isDigitPasscode = passcode.all { it.isDigit() }
</a><a href="#h328-0-31" id="h328-0-31" class="d">-
</a><a href="#h328-0-32" id="h328-0-32" class="d">-        val mainActivity = context.mainActivity!!
</a><a href="#h328-0-33" id="h328-0-33" class="d">-        setActivityVisibility(false)
</a><a href="#h328-0-34" id="h328-0-34" class="d">-
</a><a href="#h328-0-35" id="h328-0-35" class="d">-        val prompt = ViewAppearanceHelper.newAlertDialogBuilder(mainActivity)
</a><a href="#h328-0-36" id="h328-0-36" class="d">-        val createPrompt  = {
</a><a href="#h328-0-37" id="h328-0-37" class="d">-            val alertDialog = prompt.create()
</a><a href="#h328-0-38" id="h328-0-38" class="d">-            val textView = EditText(mainActivity)
</a><a href="#h328-0-39" id="h328-0-39" class="d">-            textView.setSingleLine()
</a><a href="#h328-0-40" id="h328-0-40" class="d">-            textView.inputType = if (isDigitPasscode) {
</a><a href="#h328-0-41" id="h328-0-41" class="d">-                (InputType.TYPE_CLASS_NUMBER or InputType.TYPE_NUMBER_VARIATION_PASSWORD)
</a><a href="#h328-0-42" id="h328-0-42" class="d">-            } else {
</a><a href="#h328-0-43" id="h328-0-43" class="d">-                (InputType.TYPE_CLASS_TEXT or InputType.TYPE_TEXT_VARIATION_PASSWORD)
</a><a href="#h328-0-44" id="h328-0-44" class="d">-            }
</a><a href="#h328-0-45" id="h328-0-45" class="d">-            textView.hint = &quot;Code :&quot;
</a><a href="#h328-0-46" id="h328-0-46" class="d">-            textView.setPadding(100, 100, 100, 100)
</a><a href="#h328-0-47" id="h328-0-47" class="d">-
</a><a href="#h328-0-48" id="h328-0-48" class="d">-            textView.addTextChangedListener(object: TextWatcher {
</a><a href="#h328-0-49" id="h328-0-49" class="d">-                override fun onTextChanged(s: CharSequence?, start: Int, before: Int, count: Int) {
</a><a href="#h328-0-50" id="h328-0-50" class="d">-                    if (s.contentEquals(passcode)) {
</a><a href="#h328-0-51" id="h328-0-51" class="d">-                        alertDialog.dismiss()
</a><a href="#h328-0-52" id="h328-0-52" class="d">-                        isLocked = false
</a><a href="#h328-0-53" id="h328-0-53" class="d">-                        setActivityVisibility(true)
</a><a href="#h328-0-54" id="h328-0-54" class="d">-                    }
</a><a href="#h328-0-55" id="h328-0-55" class="d">-                }
</a><a href="#h328-0-56" id="h328-0-56" class="d">-                override fun beforeTextChanged(s: CharSequence?, start: Int, count: Int, after: Int) {}
</a><a href="#h328-0-57" id="h328-0-57" class="d">-                override fun afterTextChanged(s: Editable?) {}
</a><a href="#h328-0-58" id="h328-0-58" class="d">-            })
</a><a href="#h328-0-59" id="h328-0-59" class="d">-
</a><a href="#h328-0-60" id="h328-0-60" class="d">-            alertDialog.setView(textView)
</a><a href="#h328-0-61" id="h328-0-61" class="d">-
</a><a href="#h328-0-62" id="h328-0-62" class="d">-            textView.viewTreeObserver.addOnWindowFocusChangeListener { hasFocus -&gt;
</a><a href="#h328-0-63" id="h328-0-63" class="d">-                if (!hasFocus) return@addOnWindowFocusChangeListener
</a><a href="#h328-0-64" id="h328-0-64" class="d">-                val imm = mainActivity.getSystemService(Context.INPUT_METHOD_SERVICE) as InputMethodManager
</a><a href="#h328-0-65" id="h328-0-65" class="d">-                imm.showSoftInput(textView, InputMethodManager.SHOW_IMPLICIT)
</a><a href="#h328-0-66" id="h328-0-66" class="d">-            }
</a><a href="#h328-0-67" id="h328-0-67" class="d">-
</a><a href="#h328-0-68" id="h328-0-68" class="d">-            alertDialog.window?.let {
</a><a href="#h328-0-69" id="h328-0-69" class="d">-                it.attributes.verticalMargin = -0.18F
</a><a href="#h328-0-70" id="h328-0-70" class="d">-            }
</a><a href="#h328-0-71" id="h328-0-71" class="d">-
</a><a href="#h328-0-72" id="h328-0-72" class="d">-            alertDialog.show()
</a><a href="#h328-0-73" id="h328-0-73" class="d">-            textView.requestFocus()
</a><a href="#h328-0-74" id="h328-0-74" class="d">-        }
</a><a href="#h328-0-75" id="h328-0-75" class="d">-
</a><a href="#h328-0-76" id="h328-0-76" class="d">-        prompt.setOnCancelListener {
</a><a href="#h328-0-77" id="h328-0-77" class="d">-            createPrompt()
</a><a href="#h328-0-78" id="h328-0-78" class="d">-        }
</a><a href="#h328-0-79" id="h328-0-79" class="d">-
</a><a href="#h328-0-80" id="h328-0-80" class="d">-        createPrompt()
</a><a href="#h328-0-81" id="h328-0-81" class="d">-    }
</a><a href="#h328-0-82" id="h328-0-82" class="d">-
</a><a href="#h328-0-83" id="h328-0-83" class="d">-    @SuppressLint(&quot;MissingPermission&quot;)
</a><a href="#h328-0-84" id="h328-0-84" class="d">-    override fun onActivityCreate() {
</a><a href="#h328-0-85" id="h328-0-85" class="d">-        if (!context.database.hasArroyo()) return
</a><a href="#h328-0-86" id="h328-0-86" class="d">-
</a><a href="#h328-0-87" id="h328-0-87" class="d">-        context.runOnUiThread {
</a><a href="#h328-0-88" id="h328-0-88" class="d">-            lock()
</a><a href="#h328-0-89" id="h328-0-89" class="d">-        }
</a><a href="#h328-0-90" id="h328-0-90" class="d">-
</a><a href="#h328-0-91" id="h328-0-91" class="d">-        if (!context.config.experimental.appLockOnResume.get()) return
</a><a href="#h328-0-92" id="h328-0-92" class="d">-
</a><a href="#h328-0-93" id="h328-0-93" class="d">-        if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.Q) {
</a><a href="#h328-0-94" id="h328-0-94" class="d">-            context.mainActivity?.registerActivityLifecycleCallbacks(object: android.app.Application.ActivityLifecycleCallbacks {
</a><a href="#h328-0-95" id="h328-0-95" class="d">-                override fun onActivityPaused(activity: android.app.Activity) { lock() }
</a><a href="#h328-0-96" id="h328-0-96" class="d">-                override fun onActivityResumed(activity: android.app.Activity) {}
</a><a href="#h328-0-97" id="h328-0-97" class="d">-                override fun onActivityStarted(activity: android.app.Activity) {}
</a><a href="#h328-0-98" id="h328-0-98" class="d">-                override fun onActivityDestroyed(activity: android.app.Activity) {}
</a><a href="#h328-0-99" id="h328-0-99" class="d">-                override fun onActivitySaveInstanceState(activity: android.app.Activity, outState: android.os.Bundle) {}
</a><a href="#h328-0-100" id="h328-0-100" class="d">-                override fun onActivityStopped(activity: android.app.Activity) {}
</a><a href="#h328-0-101" id="h328-0-101" class="d">-                override fun onActivityCreated(activity: android.app.Activity, savedInstanceState: android.os.Bundle?) {}
</a><a href="#h328-0-102" id="h328-0-102" class="d">-            })
</a><a href="#h328-0-103" id="h328-0-103" class="d">-        }
</a><a href="#h328-0-104" id="h328-0-104" class="d">-    }
</a><a href="#h328-0-105" id="h328-0-105" class="d">-}</a><a href="#h328-0-106" id="h328-0-106" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h329" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/experiments/DeviceSpooferHook.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/experiments/DeviceSpooferHook.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/experiments/DeviceSpooferHook.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/experiments/DeviceSpooferHook.kt</a></b>
<a href="#h329-0" id="h329-0" class="h">@@ -1,93 +0,0 @@
</a><a href="#h329-0-0" id="h329-0-0" class="d">-package me.rhunk.snapenhance.features.impl.experiments
</a><a href="#h329-0-1" id="h329-0-1" class="d">-
</a><a href="#h329-0-2" id="h329-0-2" class="d">-import me.rhunk.snapenhance.features.Feature
</a><a href="#h329-0-3" id="h329-0-3" class="d">-import me.rhunk.snapenhance.features.FeatureLoadParams
</a><a href="#h329-0-4" id="h329-0-4" class="d">-import me.rhunk.snapenhance.hook.HookStage
</a><a href="#h329-0-5" id="h329-0-5" class="d">-import me.rhunk.snapenhance.hook.Hooker
</a><a href="#h329-0-6" id="h329-0-6" class="d">-
</a><a href="#h329-0-7" id="h329-0-7" class="d">-class DeviceSpooferHook: Feature(&quot;device_spoofer&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_ASYNC)  {
</a><a href="#h329-0-8" id="h329-0-8" class="d">-	override fun asyncOnActivityCreate() {
</a><a href="#h329-0-9" id="h329-0-9" class="d">-		if (context.config.experimental.spoof.globalState != true) return
</a><a href="#h329-0-10" id="h329-0-10" class="d">-
</a><a href="#h329-0-11" id="h329-0-11" class="d">-		val fingerprint by context.config.experimental.spoof.device.fingerprint
</a><a href="#h329-0-12" id="h329-0-12" class="d">-		val androidId by context.config.experimental.spoof.device.androidId
</a><a href="#h329-0-13" id="h329-0-13" class="d">-		val getInstallerPackageName by context.config.experimental.spoof.device.getInstallerPackageName
</a><a href="#h329-0-14" id="h329-0-14" class="d">-		val debugFlag by context.config.experimental.spoof.device.debugFlag
</a><a href="#h329-0-15" id="h329-0-15" class="d">-		val mockLocationState by context.config.experimental.spoof.device.mockLocationState
</a><a href="#h329-0-16" id="h329-0-16" class="d">-		val splitClassLoader by context.config.experimental.spoof.device.splitClassLoader
</a><a href="#h329-0-17" id="h329-0-17" class="d">-		val isLowEndDevice by context.config.experimental.spoof.device.isLowEndDevice
</a><a href="#h329-0-18" id="h329-0-18" class="d">-		val getDataDirectory by context.config.experimental.spoof.device.getDataDirectory
</a><a href="#h329-0-19" id="h329-0-19" class="d">-
</a><a href="#h329-0-20" id="h329-0-20" class="d">-		val settingsSecureClass = android.provider.Settings.Secure::class.java
</a><a href="#h329-0-21" id="h329-0-21" class="d">-		val fingerprintClass = android.os.Build::class.java
</a><a href="#h329-0-22" id="h329-0-22" class="d">-		val packageManagerClass = android.content.pm.PackageManager::class.java
</a><a href="#h329-0-23" id="h329-0-23" class="d">-		val applicationInfoClass = android.content.pm.ApplicationInfo::class.java
</a><a href="#h329-0-24" id="h329-0-24" class="d">-
</a><a href="#h329-0-25" id="h329-0-25" class="d">-		//FINGERPRINT
</a><a href="#h329-0-26" id="h329-0-26" class="d">-		if (fingerprint.isNotEmpty()) {
</a><a href="#h329-0-27" id="h329-0-27" class="d">-			Hooker.hook(fingerprintClass, &quot;FINGERPRINT&quot;, HookStage.BEFORE) { hookAdapter -&gt;
</a><a href="#h329-0-28" id="h329-0-28" class="d">-				hookAdapter.setResult(fingerprint)
</a><a href="#h329-0-29" id="h329-0-29" class="d">-				context.log.verbose(&quot;Fingerprint spoofed to $fingerprint&quot;)
</a><a href="#h329-0-30" id="h329-0-30" class="d">-			}
</a><a href="#h329-0-31" id="h329-0-31" class="d">-			Hooker.hook(fingerprintClass, &quot;deriveFingerprint&quot;, HookStage.BEFORE) { hookAdapter -&gt;
</a><a href="#h329-0-32" id="h329-0-32" class="d">-				hookAdapter.setResult(fingerprint)
</a><a href="#h329-0-33" id="h329-0-33" class="d">-				context.log.verbose(&quot;Fingerprint spoofed to $fingerprint&quot;)
</a><a href="#h329-0-34" id="h329-0-34" class="d">-			}
</a><a href="#h329-0-35" id="h329-0-35" class="d">-		}
</a><a href="#h329-0-36" id="h329-0-36" class="d">-
</a><a href="#h329-0-37" id="h329-0-37" class="d">-		//ANDROID ID
</a><a href="#h329-0-38" id="h329-0-38" class="d">-		if (androidId.isNotEmpty()) {
</a><a href="#h329-0-39" id="h329-0-39" class="d">-			Hooker.hook(settingsSecureClass, &quot;getString&quot;, HookStage.BEFORE) { hookAdapter -&gt;
</a><a href="#h329-0-40" id="h329-0-40" class="d">-				if(hookAdapter.args()[1] == &quot;android_id&quot;) {
</a><a href="#h329-0-41" id="h329-0-41" class="d">-					hookAdapter.setResult(androidId)
</a><a href="#h329-0-42" id="h329-0-42" class="d">-					context.log.verbose(&quot;Android ID spoofed to $androidId&quot;)
</a><a href="#h329-0-43" id="h329-0-43" class="d">-				}
</a><a href="#h329-0-44" id="h329-0-44" class="d">-			}
</a><a href="#h329-0-45" id="h329-0-45" class="d">-		}
</a><a href="#h329-0-46" id="h329-0-46" class="d">-
</a><a href="#h329-0-47" id="h329-0-47" class="d">-		//TODO: org.chromium.base.BuildInfo, org.chromium.base.PathUtils getDataDirectory, MushroomDeviceTokenManager(?), TRANSPORT_VPN FLAG, isFromMockProvider, nativeLibraryDir, sourceDir, network capabilities, query all jvm properties
</a><a href="#h329-0-48" id="h329-0-48" class="d">-
</a><a href="#h329-0-49" id="h329-0-49" class="d">-		//INSTALLER PACKAGE NAME
</a><a href="#h329-0-50" id="h329-0-50" class="d">-		if(getInstallerPackageName.isNotEmpty()) {
</a><a href="#h329-0-51" id="h329-0-51" class="d">-			Hooker.hook(packageManagerClass, &quot;getInstallerPackageName&quot;, HookStage.BEFORE) { hookAdapter -&gt;
</a><a href="#h329-0-52" id="h329-0-52" class="d">-				hookAdapter.setResult(getInstallerPackageName)
</a><a href="#h329-0-53" id="h329-0-53" class="d">-			}
</a><a href="#h329-0-54" id="h329-0-54" class="d">-		}
</a><a href="#h329-0-55" id="h329-0-55" class="d">-
</a><a href="#h329-0-56" id="h329-0-56" class="d">-		//DEBUG FLAG
</a><a href="#h329-0-57" id="h329-0-57" class="d">-		Hooker.hook(applicationInfoClass, &quot;FLAG_DEBUGGABLE&quot;, HookStage.BEFORE) { hookAdapter -&gt;
</a><a href="#h329-0-58" id="h329-0-58" class="d">-			hookAdapter.setResult(debugFlag)
</a><a href="#h329-0-59" id="h329-0-59" class="d">-		}
</a><a href="#h329-0-60" id="h329-0-60" class="d">-
</a><a href="#h329-0-61" id="h329-0-61" class="d">-		//MOCK LOCATION
</a><a href="#h329-0-62" id="h329-0-62" class="d">-		Hooker.hook(settingsSecureClass, &quot;getString&quot;, HookStage.BEFORE) { hookAdapter -&gt;
</a><a href="#h329-0-63" id="h329-0-63" class="d">-			if(hookAdapter.args()[1] == &quot;ALLOW_MOCK_LOCATION&quot;) {
</a><a href="#h329-0-64" id="h329-0-64" class="d">-				hookAdapter.setResult(mockLocationState)
</a><a href="#h329-0-65" id="h329-0-65" class="d">-			}
</a><a href="#h329-0-66" id="h329-0-66" class="d">-		}
</a><a href="#h329-0-67" id="h329-0-67" class="d">-
</a><a href="#h329-0-68" id="h329-0-68" class="d">-		//GET SPLIT CLASSLOADER
</a><a href="#h329-0-69" id="h329-0-69" class="d">-		if(splitClassLoader.isNotEmpty()) {
</a><a href="#h329-0-70" id="h329-0-70" class="d">-			Hooker.hook(context.classCache.chromiumJNIUtils, &quot;getSplitClassLoader&quot;, HookStage.BEFORE) { hookAdapter -&gt;
</a><a href="#h329-0-71" id="h329-0-71" class="d">-				hookAdapter.setResult(splitClassLoader)
</a><a href="#h329-0-72" id="h329-0-72" class="d">-			}
</a><a href="#h329-0-73" id="h329-0-73" class="d">-		}
</a><a href="#h329-0-74" id="h329-0-74" class="d">-
</a><a href="#h329-0-75" id="h329-0-75" class="d">-		//ISLOWENDDEVICE
</a><a href="#h329-0-76" id="h329-0-76" class="d">-		if(isLowEndDevice.isNotEmpty()) {
</a><a href="#h329-0-77" id="h329-0-77" class="d">-			Hooker.hook(context.classCache.chromiumBuildInfo, &quot;getAll&quot;, HookStage.BEFORE) { hookAdapter -&gt;
</a><a href="#h329-0-78" id="h329-0-78" class="d">-				hookAdapter.setResult(isLowEndDevice)
</a><a href="#h329-0-79" id="h329-0-79" class="d">-			}
</a><a href="#h329-0-80" id="h329-0-80" class="d">-		}
</a><a href="#h329-0-81" id="h329-0-81" class="d">-
</a><a href="#h329-0-82" id="h329-0-82" class="d">-		//GETDATADIRECTORY
</a><a href="#h329-0-83" id="h329-0-83" class="d">-		if(getDataDirectory.isNotEmpty()) {
</a><a href="#h329-0-84" id="h329-0-84" class="d">-			Hooker.hook(context.classCache.chromiumPathUtils, &quot;getDataDirectory&quot;, HookStage.BEFORE) {hookAdapter -&gt;
</a><a href="#h329-0-85" id="h329-0-85" class="d">-				hookAdapter.setResult(getDataDirectory)
</a><a href="#h329-0-86" id="h329-0-86" class="d">-			}
</a><a href="#h329-0-87" id="h329-0-87" class="d">-		}
</a><a href="#h329-0-88" id="h329-0-88" class="d">-
</a><a href="#h329-0-89" id="h329-0-89" class="d">-		//accessibility_enabled
</a><a href="#h329-0-90" id="h329-0-90" class="d">-		
</a><a href="#h329-0-91" id="h329-0-91" class="d">-	}
</a><a href="#h329-0-92" id="h329-0-92" class="d">-}</a><a href="#h329-0-93" id="h329-0-93" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h330" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/experiments/EndToEndEncryption.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/experiments/EndToEndEncryption.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/experiments/EndToEndEncryption.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/experiments/EndToEndEncryption.kt</a></b>
<a href="#h330-0" id="h330-0" class="h">@@ -1,500 +0,0 @@
</a><a href="#h330-0-0" id="h330-0-0" class="d">-package me.rhunk.snapenhance.features.impl.experiments
</a><a href="#h330-0-1" id="h330-0-1" class="d">-
</a><a href="#h330-0-2" id="h330-0-2" class="d">-import android.annotation.SuppressLint
</a><a href="#h330-0-3" id="h330-0-3" class="d">-import android.graphics.Canvas
</a><a href="#h330-0-4" id="h330-0-4" class="d">-import android.graphics.Paint
</a><a href="#h330-0-5" id="h330-0-5" class="d">-import android.graphics.drawable.ShapeDrawable
</a><a href="#h330-0-6" id="h330-0-6" class="d">-import android.graphics.drawable.shapes.Shape
</a><a href="#h330-0-7" id="h330-0-7" class="d">-import android.view.View
</a><a href="#h330-0-8" id="h330-0-8" class="d">-import android.view.ViewGroup
</a><a href="#h330-0-9" id="h330-0-9" class="d">-import android.view.ViewGroup.LayoutParams
</a><a href="#h330-0-10" id="h330-0-10" class="d">-import android.view.ViewGroup.MarginLayoutParams
</a><a href="#h330-0-11" id="h330-0-11" class="d">-import android.widget.Button
</a><a href="#h330-0-12" id="h330-0-12" class="d">-import android.widget.TextView
</a><a href="#h330-0-13" id="h330-0-13" class="d">-import me.rhunk.snapenhance.core.event.events.impl.AddViewEvent
</a><a href="#h330-0-14" id="h330-0-14" class="d">-import me.rhunk.snapenhance.core.event.events.impl.BindViewEvent
</a><a href="#h330-0-15" id="h330-0-15" class="d">-import me.rhunk.snapenhance.core.event.events.impl.BuildMessageEvent
</a><a href="#h330-0-16" id="h330-0-16" class="d">-import me.rhunk.snapenhance.core.event.events.impl.SendMessageWithContentEvent
</a><a href="#h330-0-17" id="h330-0-17" class="d">-import me.rhunk.snapenhance.core.event.events.impl.UnaryCallEvent
</a><a href="#h330-0-18" id="h330-0-18" class="d">-import me.rhunk.snapenhance.core.messaging.MessagingRuleType
</a><a href="#h330-0-19" id="h330-0-19" class="d">-import me.rhunk.snapenhance.core.messaging.RuleState
</a><a href="#h330-0-20" id="h330-0-20" class="d">-import me.rhunk.snapenhance.core.util.EvictingMap
</a><a href="#h330-0-21" id="h330-0-21" class="d">-import me.rhunk.snapenhance.core.util.ktx.getObjectField
</a><a href="#h330-0-22" id="h330-0-22" class="d">-import me.rhunk.snapenhance.core.util.protobuf.ProtoEditor
</a><a href="#h330-0-23" id="h330-0-23" class="d">-import me.rhunk.snapenhance.core.util.protobuf.ProtoReader
</a><a href="#h330-0-24" id="h330-0-24" class="d">-import me.rhunk.snapenhance.core.util.protobuf.ProtoWriter
</a><a href="#h330-0-25" id="h330-0-25" class="d">-import me.rhunk.snapenhance.data.ContentType
</a><a href="#h330-0-26" id="h330-0-26" class="d">-import me.rhunk.snapenhance.data.wrapper.impl.MessageContent
</a><a href="#h330-0-27" id="h330-0-27" class="d">-import me.rhunk.snapenhance.data.wrapper.impl.SnapUUID
</a><a href="#h330-0-28" id="h330-0-28" class="d">-import me.rhunk.snapenhance.features.FeatureLoadParams
</a><a href="#h330-0-29" id="h330-0-29" class="d">-import me.rhunk.snapenhance.features.MessagingRuleFeature
</a><a href="#h330-0-30" id="h330-0-30" class="d">-import me.rhunk.snapenhance.features.impl.Messaging
</a><a href="#h330-0-31" id="h330-0-31" class="d">-import me.rhunk.snapenhance.ui.ViewAppearanceHelper
</a><a href="#h330-0-32" id="h330-0-32" class="d">-import me.rhunk.snapenhance.ui.addForegroundDrawable
</a><a href="#h330-0-33" id="h330-0-33" class="d">-import me.rhunk.snapenhance.ui.removeForegroundDrawable
</a><a href="#h330-0-34" id="h330-0-34" class="d">-import java.security.MessageDigest
</a><a href="#h330-0-35" id="h330-0-35" class="d">-import kotlin.random.Random
</a><a href="#h330-0-36" id="h330-0-36" class="d">-
</a><a href="#h330-0-37" id="h330-0-37" class="d">-class EndToEndEncryption : MessagingRuleFeature(
</a><a href="#h330-0-38" id="h330-0-38" class="d">-    &quot;EndToEndEncryption&quot;,
</a><a href="#h330-0-39" id="h330-0-39" class="d">-    MessagingRuleType.E2E_ENCRYPTION,
</a><a href="#h330-0-40" id="h330-0-40" class="d">-    loadParams = FeatureLoadParams.ACTIVITY_CREATE_SYNC or FeatureLoadParams.INIT_SYNC or FeatureLoadParams.INIT_ASYNC
</a><a href="#h330-0-41" id="h330-0-41" class="d">-) {
</a><a href="#h330-0-42" id="h330-0-42" class="d">-    private val isEnabled get() = context.config.experimental.e2eEncryption.globalState == true
</a><a href="#h330-0-43" id="h330-0-43" class="d">-    private val e2eeInterface by lazy { context.bridgeClient.getE2eeInterface() }
</a><a href="#h330-0-44" id="h330-0-44" class="d">-
</a><a href="#h330-0-45" id="h330-0-45" class="d">-    companion object {
</a><a href="#h330-0-46" id="h330-0-46" class="d">-        const val REQUEST_PK_MESSAGE_ID = 1
</a><a href="#h330-0-47" id="h330-0-47" class="d">-        const val RESPONSE_SK_MESSAGE_ID = 2
</a><a href="#h330-0-48" id="h330-0-48" class="d">-        const val ENCRYPTED_MESSAGE_ID = 3
</a><a href="#h330-0-49" id="h330-0-49" class="d">-    }
</a><a href="#h330-0-50" id="h330-0-50" class="d">-
</a><a href="#h330-0-51" id="h330-0-51" class="d">-    private val decryptedMessageCache = EvictingMap&lt;Long, Pair&lt;ContentType, ByteArray&gt;&gt;(100)
</a><a href="#h330-0-52" id="h330-0-52" class="d">-
</a><a href="#h330-0-53" id="h330-0-53" class="d">-    private val pkRequests = mutableMapOf&lt;Long, ByteArray&gt;()
</a><a href="#h330-0-54" id="h330-0-54" class="d">-    private val secretResponses = mutableMapOf&lt;Long, ByteArray&gt;()
</a><a href="#h330-0-55" id="h330-0-55" class="d">-    private val encryptedMessages = mutableListOf&lt;Long&gt;()
</a><a href="#h330-0-56" id="h330-0-56" class="d">-
</a><a href="#h330-0-57" id="h330-0-57" class="d">-    private fun getE2EParticipants(conversationId: String): List&lt;String&gt; {
</a><a href="#h330-0-58" id="h330-0-58" class="d">-        return context.database.getConversationParticipants(conversationId)?.filter { friendId -&gt; e2eeInterface.friendKeyExists(friendId) } ?: emptyList()
</a><a href="#h330-0-59" id="h330-0-59" class="d">-    }
</a><a href="#h330-0-60" id="h330-0-60" class="d">-
</a><a href="#h330-0-61" id="h330-0-61" class="d">-    private fun askForKeys(conversationId: String) {
</a><a href="#h330-0-62" id="h330-0-62" class="d">-        val friendId = context.database.getDMOtherParticipant(conversationId) ?: run {
</a><a href="#h330-0-63" id="h330-0-63" class="d">-            context.longToast(&quot;Can&#39;t find friendId for conversationId $conversationId&quot;)
</a><a href="#h330-0-64" id="h330-0-64" class="d">-            return
</a><a href="#h330-0-65" id="h330-0-65" class="d">-        }
</a><a href="#h330-0-66" id="h330-0-66" class="d">-
</a><a href="#h330-0-67" id="h330-0-67" class="d">-        val publicKey = e2eeInterface.createKeyExchange(friendId) ?: run {
</a><a href="#h330-0-68" id="h330-0-68" class="d">-            context.longToast(&quot;Can&#39;t create key exchange for friendId $friendId&quot;)
</a><a href="#h330-0-69" id="h330-0-69" class="d">-            return
</a><a href="#h330-0-70" id="h330-0-70" class="d">-        }
</a><a href="#h330-0-71" id="h330-0-71" class="d">-
</a><a href="#h330-0-72" id="h330-0-72" class="d">-        context.log.verbose(&quot;created publicKey: ${publicKey.contentToString()}&quot;)
</a><a href="#h330-0-73" id="h330-0-73" class="d">-
</a><a href="#h330-0-74" id="h330-0-74" class="d">-        sendCustomMessage(conversationId, REQUEST_PK_MESSAGE_ID) {
</a><a href="#h330-0-75" id="h330-0-75" class="d">-            addBuffer(2, publicKey)
</a><a href="#h330-0-76" id="h330-0-76" class="d">-        }
</a><a href="#h330-0-77" id="h330-0-77" class="d">-    }
</a><a href="#h330-0-78" id="h330-0-78" class="d">-
</a><a href="#h330-0-79" id="h330-0-79" class="d">-    private fun sendCustomMessage(conversationId: String, messageId: Int, message: ProtoWriter.() -&gt; Unit) {
</a><a href="#h330-0-80" id="h330-0-80" class="d">-        context.messageSender.sendCustomChatMessage(
</a><a href="#h330-0-81" id="h330-0-81" class="d">-            listOf(SnapUUID.fromString(conversationId)),
</a><a href="#h330-0-82" id="h330-0-82" class="d">-            ContentType.CHAT,
</a><a href="#h330-0-83" id="h330-0-83" class="d">-            message = {
</a><a href="#h330-0-84" id="h330-0-84" class="d">-                from(2) {
</a><a href="#h330-0-85" id="h330-0-85" class="d">-                    from(1) {
</a><a href="#h330-0-86" id="h330-0-86" class="d">-                        addVarInt(1, messageId)
</a><a href="#h330-0-87" id="h330-0-87" class="d">-                        addBuffer(2, ProtoWriter().apply(message).toByteArray())
</a><a href="#h330-0-88" id="h330-0-88" class="d">-                    }
</a><a href="#h330-0-89" id="h330-0-89" class="d">-                }
</a><a href="#h330-0-90" id="h330-0-90" class="d">-            }
</a><a href="#h330-0-91" id="h330-0-91" class="d">-        )
</a><a href="#h330-0-92" id="h330-0-92" class="d">-    }
</a><a href="#h330-0-93" id="h330-0-93" class="d">-
</a><a href="#h330-0-94" id="h330-0-94" class="d">-    private fun warnKeyOverwrite(friendId: String, block: () -&gt; Unit) {
</a><a href="#h330-0-95" id="h330-0-95" class="d">-        if (!e2eeInterface.friendKeyExists(friendId)) {
</a><a href="#h330-0-96" id="h330-0-96" class="d">-            block()
</a><a href="#h330-0-97" id="h330-0-97" class="d">-            return
</a><a href="#h330-0-98" id="h330-0-98" class="d">-        }
</a><a href="#h330-0-99" id="h330-0-99" class="d">-
</a><a href="#h330-0-100" id="h330-0-100" class="d">-        context.mainActivity?.runOnUiThread {
</a><a href="#h330-0-101" id="h330-0-101" class="d">-            val mainActivity = context.mainActivity ?: return@runOnUiThread
</a><a href="#h330-0-102" id="h330-0-102" class="d">-            ViewAppearanceHelper.newAlertDialogBuilder(mainActivity).apply {
</a><a href="#h330-0-103" id="h330-0-103" class="d">-                setTitle(&quot;End-to-end encryption&quot;)
</a><a href="#h330-0-104" id="h330-0-104" class="d">-                setMessage(&quot;WARNING: This will overwrite your existing key. You will loose access to all encrypted messages from this friend. Are you sure you want to continue?&quot;)
</a><a href="#h330-0-105" id="h330-0-105" class="d">-                setPositiveButton(&quot;Yes&quot;) { _, _ -&gt;
</a><a href="#h330-0-106" id="h330-0-106" class="d">-                    ViewAppearanceHelper.newAlertDialogBuilder(mainActivity).apply {
</a><a href="#h330-0-107" id="h330-0-107" class="d">-                        setTitle(&quot;End-to-end encryption&quot;)
</a><a href="#h330-0-108" id="h330-0-108" class="d">-                        setMessage(&quot;Are you REALLY sure you want to continue? This is your last chance to back out.&quot;)
</a><a href="#h330-0-109" id="h330-0-109" class="d">-                        setNeutralButton(&quot;Yes&quot;) { _, _ -&gt; block() }
</a><a href="#h330-0-110" id="h330-0-110" class="d">-                        setPositiveButton(&quot;No&quot;) { _, _ -&gt; }
</a><a href="#h330-0-111" id="h330-0-111" class="d">-                    }.show()
</a><a href="#h330-0-112" id="h330-0-112" class="d">-                }
</a><a href="#h330-0-113" id="h330-0-113" class="d">-                setNegativeButton(&quot;No&quot;) { _, _ -&gt; }
</a><a href="#h330-0-114" id="h330-0-114" class="d">-            }.show()
</a><a href="#h330-0-115" id="h330-0-115" class="d">-        }
</a><a href="#h330-0-116" id="h330-0-116" class="d">-    }
</a><a href="#h330-0-117" id="h330-0-117" class="d">-
</a><a href="#h330-0-118" id="h330-0-118" class="d">-    private fun handlePublicKeyRequest(conversationId: String, publicKey: ByteArray) {
</a><a href="#h330-0-119" id="h330-0-119" class="d">-        val friendId = context.database.getDMOtherParticipant(conversationId) ?: run {
</a><a href="#h330-0-120" id="h330-0-120" class="d">-            context.longToast(&quot;Can&#39;t find friendId for conversationId $conversationId&quot;)
</a><a href="#h330-0-121" id="h330-0-121" class="d">-            return
</a><a href="#h330-0-122" id="h330-0-122" class="d">-        }
</a><a href="#h330-0-123" id="h330-0-123" class="d">-        warnKeyOverwrite(friendId) {
</a><a href="#h330-0-124" id="h330-0-124" class="d">-            val encapsulatedSecret = e2eeInterface.acceptPairingRequest(friendId, publicKey)
</a><a href="#h330-0-125" id="h330-0-125" class="d">-            if (encapsulatedSecret == null) {
</a><a href="#h330-0-126" id="h330-0-126" class="d">-                context.longToast(&quot;Failed to accept public key&quot;)
</a><a href="#h330-0-127" id="h330-0-127" class="d">-                return@warnKeyOverwrite
</a><a href="#h330-0-128" id="h330-0-128" class="d">-            }
</a><a href="#h330-0-129" id="h330-0-129" class="d">-            context.longToast(&quot;Public key successfully accepted&quot;)
</a><a href="#h330-0-130" id="h330-0-130" class="d">-
</a><a href="#h330-0-131" id="h330-0-131" class="d">-            sendCustomMessage(conversationId, RESPONSE_SK_MESSAGE_ID) {
</a><a href="#h330-0-132" id="h330-0-132" class="d">-                addBuffer(2, encapsulatedSecret)
</a><a href="#h330-0-133" id="h330-0-133" class="d">-            }
</a><a href="#h330-0-134" id="h330-0-134" class="d">-        }
</a><a href="#h330-0-135" id="h330-0-135" class="d">-    }
</a><a href="#h330-0-136" id="h330-0-136" class="d">-
</a><a href="#h330-0-137" id="h330-0-137" class="d">-    private fun handleSecretResponse(conversationId: String, secret: ByteArray) {
</a><a href="#h330-0-138" id="h330-0-138" class="d">-        val friendId = context.database.getDMOtherParticipant(conversationId) ?: run {
</a><a href="#h330-0-139" id="h330-0-139" class="d">-            context.longToast(&quot;Can&#39;t find friendId for conversationId $conversationId&quot;)
</a><a href="#h330-0-140" id="h330-0-140" class="d">-            return
</a><a href="#h330-0-141" id="h330-0-141" class="d">-        }
</a><a href="#h330-0-142" id="h330-0-142" class="d">-        warnKeyOverwrite(friendId) {
</a><a href="#h330-0-143" id="h330-0-143" class="d">-            context.log.verbose(&quot;handleSecretResponse, secret = $secret&quot;)
</a><a href="#h330-0-144" id="h330-0-144" class="d">-            val result = e2eeInterface.acceptPairingResponse(friendId, secret)
</a><a href="#h330-0-145" id="h330-0-145" class="d">-            if (!result) {
</a><a href="#h330-0-146" id="h330-0-146" class="d">-                context.longToast(&quot;Failed to accept secret&quot;)
</a><a href="#h330-0-147" id="h330-0-147" class="d">-                return@warnKeyOverwrite
</a><a href="#h330-0-148" id="h330-0-148" class="d">-            }
</a><a href="#h330-0-149" id="h330-0-149" class="d">-            context.longToast(&quot;Done! You can now exchange encrypted messages with this friend.&quot;)
</a><a href="#h330-0-150" id="h330-0-150" class="d">-        }
</a><a href="#h330-0-151" id="h330-0-151" class="d">-    }
</a><a href="#h330-0-152" id="h330-0-152" class="d">-
</a><a href="#h330-0-153" id="h330-0-153" class="d">-    private fun openManagementPopup() {
</a><a href="#h330-0-154" id="h330-0-154" class="d">-        val conversationId = context.feature(Messaging::class).openedConversationUUID?.toString() ?: return
</a><a href="#h330-0-155" id="h330-0-155" class="d">-        val friendId = context.database.getDMOtherParticipant(conversationId)
</a><a href="#h330-0-156" id="h330-0-156" class="d">-
</a><a href="#h330-0-157" id="h330-0-157" class="d">-        if (friendId == null) {
</a><a href="#h330-0-158" id="h330-0-158" class="d">-            context.shortToast(&quot;This menu is only available in direct messages.&quot;)
</a><a href="#h330-0-159" id="h330-0-159" class="d">-            return
</a><a href="#h330-0-160" id="h330-0-160" class="d">-        }
</a><a href="#h330-0-161" id="h330-0-161" class="d">-
</a><a href="#h330-0-162" id="h330-0-162" class="d">-        val actions = listOf(
</a><a href="#h330-0-163" id="h330-0-163" class="d">-            &quot;Initiate a new shared secret&quot;,
</a><a href="#h330-0-164" id="h330-0-164" class="d">-            &quot;Show shared key fingerprint&quot;
</a><a href="#h330-0-165" id="h330-0-165" class="d">-        )
</a><a href="#h330-0-166" id="h330-0-166" class="d">-
</a><a href="#h330-0-167" id="h330-0-167" class="d">-        ViewAppearanceHelper.newAlertDialogBuilder(context.mainActivity!!).apply {
</a><a href="#h330-0-168" id="h330-0-168" class="d">-            setTitle(&quot;End-to-end encryption&quot;)
</a><a href="#h330-0-169" id="h330-0-169" class="d">-            setItems(actions.toTypedArray()) { _, which -&gt;
</a><a href="#h330-0-170" id="h330-0-170" class="d">-                when (which) {
</a><a href="#h330-0-171" id="h330-0-171" class="d">-                    0 -&gt; {
</a><a href="#h330-0-172" id="h330-0-172" class="d">-                        warnKeyOverwrite(friendId) {
</a><a href="#h330-0-173" id="h330-0-173" class="d">-                            askForKeys(conversationId)
</a><a href="#h330-0-174" id="h330-0-174" class="d">-                        }
</a><a href="#h330-0-175" id="h330-0-175" class="d">-                    }
</a><a href="#h330-0-176" id="h330-0-176" class="d">-                    1 -&gt; {
</a><a href="#h330-0-177" id="h330-0-177" class="d">-                        val fingerprint = e2eeInterface.getSecretFingerprint(friendId)
</a><a href="#h330-0-178" id="h330-0-178" class="d">-                        ViewAppearanceHelper.newAlertDialogBuilder(context).apply {
</a><a href="#h330-0-179" id="h330-0-179" class="d">-                            setTitle(&quot;End-to-end encryption&quot;)
</a><a href="#h330-0-180" id="h330-0-180" class="d">-                            setMessage(&quot;Your fingerprint is:\n\n$fingerprint\n\nMake sure to check if it matches your friend&#39;s fingerprint!&quot;)
</a><a href="#h330-0-181" id="h330-0-181" class="d">-                            setPositiveButton(&quot;OK&quot;) { _, _ -&gt; }
</a><a href="#h330-0-182" id="h330-0-182" class="d">-                        }.show()
</a><a href="#h330-0-183" id="h330-0-183" class="d">-                    }
</a><a href="#h330-0-184" id="h330-0-184" class="d">-                }
</a><a href="#h330-0-185" id="h330-0-185" class="d">-            }
</a><a href="#h330-0-186" id="h330-0-186" class="d">-            setPositiveButton(&quot;OK&quot;) { _, _ -&gt; }
</a><a href="#h330-0-187" id="h330-0-187" class="d">-        }.show()
</a><a href="#h330-0-188" id="h330-0-188" class="d">-    }
</a><a href="#h330-0-189" id="h330-0-189" class="d">-
</a><a href="#h330-0-190" id="h330-0-190" class="d">-    @SuppressLint(&quot;SetTextI18n&quot;, &quot;DiscouragedApi&quot;)
</a><a href="#h330-0-191" id="h330-0-191" class="d">-    override fun onActivityCreate() {
</a><a href="#h330-0-192" id="h330-0-192" class="d">-        if (!isEnabled) return
</a><a href="#h330-0-193" id="h330-0-193" class="d">-        // add button to input bar
</a><a href="#h330-0-194" id="h330-0-194" class="d">-        context.event.subscribe(AddViewEvent::class) { param -&gt;
</a><a href="#h330-0-195" id="h330-0-195" class="d">-            if (param.view.toString().contains(&quot;default_input_bar&quot;)) {
</a><a href="#h330-0-196" id="h330-0-196" class="d">-                (param.view as ViewGroup).addView(TextView(param.view.context).apply {
</a><a href="#h330-0-197" id="h330-0-197" class="d">-                    layoutParams = MarginLayoutParams(LayoutParams.WRAP_CONTENT, LayoutParams.MATCH_PARENT)
</a><a href="#h330-0-198" id="h330-0-198" class="d">-                    setOnClickListener { openManagementPopup() }
</a><a href="#h330-0-199" id="h330-0-199" class="d">-                    setPadding(20, 20, 20, 20)
</a><a href="#h330-0-200" id="h330-0-200" class="d">-                    textSize = 23f
</a><a href="#h330-0-201" id="h330-0-201" class="d">-                    text = &quot;\uD83D\uDD12&quot;
</a><a href="#h330-0-202" id="h330-0-202" class="d">-                })
</a><a href="#h330-0-203" id="h330-0-203" class="d">-            }
</a><a href="#h330-0-204" id="h330-0-204" class="d">-        }
</a><a href="#h330-0-205" id="h330-0-205" class="d">-
</a><a href="#h330-0-206" id="h330-0-206" class="d">-        val encryptedMessageIndicator by context.config.experimental.e2eEncryption.encryptedMessageIndicator
</a><a href="#h330-0-207" id="h330-0-207" class="d">-
</a><a href="#h330-0-208" id="h330-0-208" class="d">-        // hook view binder to add special buttons
</a><a href="#h330-0-209" id="h330-0-209" class="d">-        val receivePublicKeyTag = Random.nextLong().toString(16)
</a><a href="#h330-0-210" id="h330-0-210" class="d">-        val receiveSecretTag = Random.nextLong().toString(16)
</a><a href="#h330-0-211" id="h330-0-211" class="d">-
</a><a href="#h330-0-212" id="h330-0-212" class="d">-        context.event.subscribe(BindViewEvent::class) { event -&gt;
</a><a href="#h330-0-213" id="h330-0-213" class="d">-            event.chatMessage { conversationId, messageId -&gt;
</a><a href="#h330-0-214" id="h330-0-214" class="d">-                val viewGroup = event.view as ViewGroup
</a><a href="#h330-0-215" id="h330-0-215" class="d">-
</a><a href="#h330-0-216" id="h330-0-216" class="d">-                viewGroup.findViewWithTag&lt;View&gt;(receiveSecretTag)?.also {
</a><a href="#h330-0-217" id="h330-0-217" class="d">-                    viewGroup.removeView(it)
</a><a href="#h330-0-218" id="h330-0-218" class="d">-                }
</a><a href="#h330-0-219" id="h330-0-219" class="d">-
</a><a href="#h330-0-220" id="h330-0-220" class="d">-                viewGroup.findViewWithTag&lt;View&gt;(receivePublicKeyTag)?.also {
</a><a href="#h330-0-221" id="h330-0-221" class="d">-                    viewGroup.removeView(it)
</a><a href="#h330-0-222" id="h330-0-222" class="d">-                }
</a><a href="#h330-0-223" id="h330-0-223" class="d">-
</a><a href="#h330-0-224" id="h330-0-224" class="d">-                if (encryptedMessageIndicator) {
</a><a href="#h330-0-225" id="h330-0-225" class="d">-                    viewGroup.removeForegroundDrawable(&quot;encryptedMessage&quot;)
</a><a href="#h330-0-226" id="h330-0-226" class="d">-
</a><a href="#h330-0-227" id="h330-0-227" class="d">-                    if (encryptedMessages.contains(messageId.toLong())) {
</a><a href="#h330-0-228" id="h330-0-228" class="d">-                        viewGroup.addForegroundDrawable(&quot;encryptedMessage&quot;, ShapeDrawable(object: Shape() {
</a><a href="#h330-0-229" id="h330-0-229" class="d">-                            override fun draw(canvas: Canvas, paint: Paint) {
</a><a href="#h330-0-230" id="h330-0-230" class="d">-                                paint.textSize = 20f
</a><a href="#h330-0-231" id="h330-0-231" class="d">-                                canvas.drawText(&quot;\uD83D\uDD12&quot;, 0f, canvas.height / 2f, paint)
</a><a href="#h330-0-232" id="h330-0-232" class="d">-                            }
</a><a href="#h330-0-233" id="h330-0-233" class="d">-                        }))
</a><a href="#h330-0-234" id="h330-0-234" class="d">-                    }
</a><a href="#h330-0-235" id="h330-0-235" class="d">-                }
</a><a href="#h330-0-236" id="h330-0-236" class="d">-
</a><a href="#h330-0-237" id="h330-0-237" class="d">-                secretResponses[messageId.toLong()]?.also { secret -&gt;
</a><a href="#h330-0-238" id="h330-0-238" class="d">-                    viewGroup.addView(Button(context.mainActivity!!).apply {
</a><a href="#h330-0-239" id="h330-0-239" class="d">-                        text = &quot;Accept secret&quot;
</a><a href="#h330-0-240" id="h330-0-240" class="d">-                        tag = receiveSecretTag
</a><a href="#h330-0-241" id="h330-0-241" class="d">-                        setOnClickListener {
</a><a href="#h330-0-242" id="h330-0-242" class="d">-                            handleSecretResponse(conversationId, secret)
</a><a href="#h330-0-243" id="h330-0-243" class="d">-                        }
</a><a href="#h330-0-244" id="h330-0-244" class="d">-                    })
</a><a href="#h330-0-245" id="h330-0-245" class="d">-                }
</a><a href="#h330-0-246" id="h330-0-246" class="d">-
</a><a href="#h330-0-247" id="h330-0-247" class="d">-                pkRequests[messageId.toLong()]?.also { publicKey -&gt;
</a><a href="#h330-0-248" id="h330-0-248" class="d">-                    viewGroup.addView(Button(context.mainActivity!!).apply {
</a><a href="#h330-0-249" id="h330-0-249" class="d">-                        text = &quot;Receive public key&quot;
</a><a href="#h330-0-250" id="h330-0-250" class="d">-                        tag = receivePublicKeyTag
</a><a href="#h330-0-251" id="h330-0-251" class="d">-                        setOnClickListener {
</a><a href="#h330-0-252" id="h330-0-252" class="d">-                            handlePublicKeyRequest(conversationId, publicKey)
</a><a href="#h330-0-253" id="h330-0-253" class="d">-                        }
</a><a href="#h330-0-254" id="h330-0-254" class="d">-                    })
</a><a href="#h330-0-255" id="h330-0-255" class="d">-                }
</a><a href="#h330-0-256" id="h330-0-256" class="d">-            }
</a><a href="#h330-0-257" id="h330-0-257" class="d">-        }
</a><a href="#h330-0-258" id="h330-0-258" class="d">-    }
</a><a href="#h330-0-259" id="h330-0-259" class="d">-
</a><a href="#h330-0-260" id="h330-0-260" class="d">-    private fun fixContentType(contentType: ContentType?, message: ProtoReader)
</a><a href="#h330-0-261" id="h330-0-261" class="d">-        = ContentType.fromMessageContainer(message) ?: contentType
</a><a href="#h330-0-262" id="h330-0-262" class="d">-
</a><a href="#h330-0-263" id="h330-0-263" class="d">-    private fun hashParticipantId(participantId: String, salt: ByteArray): ByteArray {
</a><a href="#h330-0-264" id="h330-0-264" class="d">-        return MessageDigest.getInstance(&quot;SHA-256&quot;).apply {
</a><a href="#h330-0-265" id="h330-0-265" class="d">-            update(participantId.toByteArray())
</a><a href="#h330-0-266" id="h330-0-266" class="d">-            update(salt)
</a><a href="#h330-0-267" id="h330-0-267" class="d">-        }.digest()
</a><a href="#h330-0-268" id="h330-0-268" class="d">-    }
</a><a href="#h330-0-269" id="h330-0-269" class="d">-
</a><a href="#h330-0-270" id="h330-0-270" class="d">-    private fun messageHook(conversationId: String, messageId: Long, senderId: String, messageContent: MessageContent) {
</a><a href="#h330-0-271" id="h330-0-271" class="d">-        if (messageContent.contentType != ContentType.STATUS &amp;&amp; decryptedMessageCache.containsKey(messageId)) {
</a><a href="#h330-0-272" id="h330-0-272" class="d">-            val (contentType, buffer) = decryptedMessageCache[messageId]!!
</a><a href="#h330-0-273" id="h330-0-273" class="d">-            messageContent.contentType = contentType
</a><a href="#h330-0-274" id="h330-0-274" class="d">-            messageContent.content = buffer
</a><a href="#h330-0-275" id="h330-0-275" class="d">-            return
</a><a href="#h330-0-276" id="h330-0-276" class="d">-        }
</a><a href="#h330-0-277" id="h330-0-277" class="d">-
</a><a href="#h330-0-278" id="h330-0-278" class="d">-        val reader = ProtoReader(messageContent.content)
</a><a href="#h330-0-279" id="h330-0-279" class="d">-        messageContent.contentType = fixContentType(messageContent.contentType!!, reader)
</a><a href="#h330-0-280" id="h330-0-280" class="d">-
</a><a href="#h330-0-281" id="h330-0-281" class="d">-        fun setMessageContent(buffer: ByteArray) {
</a><a href="#h330-0-282" id="h330-0-282" class="d">-            messageContent.content = buffer
</a><a href="#h330-0-283" id="h330-0-283" class="d">-            messageContent.contentType = fixContentType(messageContent.contentType, ProtoReader(buffer))
</a><a href="#h330-0-284" id="h330-0-284" class="d">-            decryptedMessageCache[messageId] = messageContent.contentType!! to buffer
</a><a href="#h330-0-285" id="h330-0-285" class="d">-        }
</a><a href="#h330-0-286" id="h330-0-286" class="d">-
</a><a href="#h330-0-287" id="h330-0-287" class="d">-        fun replaceMessageText(text: String) {
</a><a href="#h330-0-288" id="h330-0-288" class="d">-            messageContent.content = ProtoWriter().apply {
</a><a href="#h330-0-289" id="h330-0-289" class="d">-                from(2) {
</a><a href="#h330-0-290" id="h330-0-290" class="d">-                    addString(1, text)
</a><a href="#h330-0-291" id="h330-0-291" class="d">-                }
</a><a href="#h330-0-292" id="h330-0-292" class="d">-            }.toByteArray()
</a><a href="#h330-0-293" id="h330-0-293" class="d">-        }
</a><a href="#h330-0-294" id="h330-0-294" class="d">-
</a><a href="#h330-0-295" id="h330-0-295" class="d">-        // decrypt messages
</a><a href="#h330-0-296" id="h330-0-296" class="d">-        reader.followPath(2, 1) {
</a><a href="#h330-0-297" id="h330-0-297" class="d">-            val messageTypeId = getVarInt(1)?.toInt() ?: return@followPath
</a><a href="#h330-0-298" id="h330-0-298" class="d">-            val isMe = context.database.myUserId == senderId
</a><a href="#h330-0-299" id="h330-0-299" class="d">-            val conversationParticipants by lazy {
</a><a href="#h330-0-300" id="h330-0-300" class="d">-                getE2EParticipants(conversationId)
</a><a href="#h330-0-301" id="h330-0-301" class="d">-            }
</a><a href="#h330-0-302" id="h330-0-302" class="d">-
</a><a href="#h330-0-303" id="h330-0-303" class="d">-            if (messageTypeId == ENCRYPTED_MESSAGE_ID) {
</a><a href="#h330-0-304" id="h330-0-304" class="d">-                runCatching {
</a><a href="#h330-0-305" id="h330-0-305" class="d">-                    eachBuffer(2) {
</a><a href="#h330-0-306" id="h330-0-306" class="d">-                        val participantIdHash = getByteArray(1) ?: return@eachBuffer
</a><a href="#h330-0-307" id="h330-0-307" class="d">-                        val iv = getByteArray(2) ?: return@eachBuffer
</a><a href="#h330-0-308" id="h330-0-308" class="d">-                        val ciphertext = getByteArray(3) ?: return@eachBuffer
</a><a href="#h330-0-309" id="h330-0-309" class="d">-
</a><a href="#h330-0-310" id="h330-0-310" class="d">-                        if (isMe) {
</a><a href="#h330-0-311" id="h330-0-311" class="d">-                            if (conversationParticipants.isEmpty()) return@eachBuffer
</a><a href="#h330-0-312" id="h330-0-312" class="d">-                            val participantId = conversationParticipants.firstOrNull { participantIdHash.contentEquals(hashParticipantId(it, iv)) } ?: return@eachBuffer
</a><a href="#h330-0-313" id="h330-0-313" class="d">-                            setMessageContent(
</a><a href="#h330-0-314" id="h330-0-314" class="d">-                                e2eeInterface.decryptMessage(participantId, ciphertext, iv)
</a><a href="#h330-0-315" id="h330-0-315" class="d">-                            )
</a><a href="#h330-0-316" id="h330-0-316" class="d">-                            encryptedMessages.add(messageId)
</a><a href="#h330-0-317" id="h330-0-317" class="d">-                            return@eachBuffer
</a><a href="#h330-0-318" id="h330-0-318" class="d">-                        }
</a><a href="#h330-0-319" id="h330-0-319" class="d">-
</a><a href="#h330-0-320" id="h330-0-320" class="d">-                        if (!participantIdHash.contentEquals(hashParticipantId(context.database.myUserId, iv))) return@eachBuffer
</a><a href="#h330-0-321" id="h330-0-321" class="d">-
</a><a href="#h330-0-322" id="h330-0-322" class="d">-                        setMessageContent(
</a><a href="#h330-0-323" id="h330-0-323" class="d">-                            e2eeInterface.decryptMessage(senderId, ciphertext, iv)
</a><a href="#h330-0-324" id="h330-0-324" class="d">-                        )
</a><a href="#h330-0-325" id="h330-0-325" class="d">-                        encryptedMessages.add(messageId)
</a><a href="#h330-0-326" id="h330-0-326" class="d">-                    }
</a><a href="#h330-0-327" id="h330-0-327" class="d">-                }.onFailure {
</a><a href="#h330-0-328" id="h330-0-328" class="d">-                    context.log.error(&quot;Failed to decrypt message id: $messageId&quot;, it)
</a><a href="#h330-0-329" id="h330-0-329" class="d">-                    messageContent.contentType = ContentType.CHAT
</a><a href="#h330-0-330" id="h330-0-330" class="d">-                    messageContent.content = ProtoWriter().apply {
</a><a href="#h330-0-331" id="h330-0-331" class="d">-                        from(2) {
</a><a href="#h330-0-332" id="h330-0-332" class="d">-                            addString(1, &quot;Failed to decrypt message, id=$messageId. Check logcat for more details.&quot;)
</a><a href="#h330-0-333" id="h330-0-333" class="d">-                        }
</a><a href="#h330-0-334" id="h330-0-334" class="d">-                    }.toByteArray()
</a><a href="#h330-0-335" id="h330-0-335" class="d">-                }
</a><a href="#h330-0-336" id="h330-0-336" class="d">-
</a><a href="#h330-0-337" id="h330-0-337" class="d">-                return@followPath
</a><a href="#h330-0-338" id="h330-0-338" class="d">-            }
</a><a href="#h330-0-339" id="h330-0-339" class="d">-
</a><a href="#h330-0-340" id="h330-0-340" class="d">-            val payload = getByteArray(2, 2) ?: return@followPath
</a><a href="#h330-0-341" id="h330-0-341" class="d">-
</a><a href="#h330-0-342" id="h330-0-342" class="d">-            if (senderId == context.database.myUserId) {
</a><a href="#h330-0-343" id="h330-0-343" class="d">-                when (messageTypeId) {
</a><a href="#h330-0-344" id="h330-0-344" class="d">-                    REQUEST_PK_MESSAGE_ID -&gt; {
</a><a href="#h330-0-345" id="h330-0-345" class="d">-                        replaceMessageText(&quot;[Key exchange request]&quot;)
</a><a href="#h330-0-346" id="h330-0-346" class="d">-                    }
</a><a href="#h330-0-347" id="h330-0-347" class="d">-                    RESPONSE_SK_MESSAGE_ID -&gt; {
</a><a href="#h330-0-348" id="h330-0-348" class="d">-                        replaceMessageText(&quot;[Key exchange response]&quot;)
</a><a href="#h330-0-349" id="h330-0-349" class="d">-                    }
</a><a href="#h330-0-350" id="h330-0-350" class="d">-                }
</a><a href="#h330-0-351" id="h330-0-351" class="d">-                return@followPath
</a><a href="#h330-0-352" id="h330-0-352" class="d">-            }
</a><a href="#h330-0-353" id="h330-0-353" class="d">-
</a><a href="#h330-0-354" id="h330-0-354" class="d">-            when (messageTypeId) {
</a><a href="#h330-0-355" id="h330-0-355" class="d">-                REQUEST_PK_MESSAGE_ID -&gt; {
</a><a href="#h330-0-356" id="h330-0-356" class="d">-                    pkRequests[messageId] = payload
</a><a href="#h330-0-357" id="h330-0-357" class="d">-                    replaceMessageText(&quot;You just received a public key request. Click below to accept it.&quot;)
</a><a href="#h330-0-358" id="h330-0-358" class="d">-                }
</a><a href="#h330-0-359" id="h330-0-359" class="d">-                RESPONSE_SK_MESSAGE_ID -&gt; {
</a><a href="#h330-0-360" id="h330-0-360" class="d">-                    secretResponses[messageId] = payload
</a><a href="#h330-0-361" id="h330-0-361" class="d">-                    replaceMessageText(&quot;Your friend just accepted your public key. Click below to accept the secret.&quot;)
</a><a href="#h330-0-362" id="h330-0-362" class="d">-                }
</a><a href="#h330-0-363" id="h330-0-363" class="d">-            }
</a><a href="#h330-0-364" id="h330-0-364" class="d">-        }
</a><a href="#h330-0-365" id="h330-0-365" class="d">-    }
</a><a href="#h330-0-366" id="h330-0-366" class="d">-
</a><a href="#h330-0-367" id="h330-0-367" class="d">-    override fun asyncInit() {
</a><a href="#h330-0-368" id="h330-0-368" class="d">-        if (!isEnabled) return
</a><a href="#h330-0-369" id="h330-0-369" class="d">-        val forceMessageEncryption by context.config.experimental.e2eEncryption.forceMessageEncryption
</a><a href="#h330-0-370" id="h330-0-370" class="d">-
</a><a href="#h330-0-371" id="h330-0-371" class="d">-        // trick to disable fidelius encryption
</a><a href="#h330-0-372" id="h330-0-372" class="d">-        context.event.subscribe(SendMessageWithContentEvent::class) { event -&gt;
</a><a href="#h330-0-373" id="h330-0-373" class="d">-            val messageContent = event.messageContent
</a><a href="#h330-0-374" id="h330-0-374" class="d">-            val destinations = event.destinations
</a><a href="#h330-0-375" id="h330-0-375" class="d">-
</a><a href="#h330-0-376" id="h330-0-376" class="d">-            val e2eeConversations = destinations.conversations.filter { getState(it.toString()) }
</a><a href="#h330-0-377" id="h330-0-377" class="d">-
</a><a href="#h330-0-378" id="h330-0-378" class="d">-            if (e2eeConversations.isEmpty()) return@subscribe
</a><a href="#h330-0-379" id="h330-0-379" class="d">-
</a><a href="#h330-0-380" id="h330-0-380" class="d">-            if (e2eeConversations.size != destinations.conversations.size) {
</a><a href="#h330-0-381" id="h330-0-381" class="d">-                if (!forceMessageEncryption) return@subscribe
</a><a href="#h330-0-382" id="h330-0-382" class="d">-                context.longToast(&quot;You can&#39;t send encrypted content to both encrypted and unencrypted conversations!&quot;)
</a><a href="#h330-0-383" id="h330-0-383" class="d">-                event.canceled = true
</a><a href="#h330-0-384" id="h330-0-384" class="d">-                return@subscribe
</a><a href="#h330-0-385" id="h330-0-385" class="d">-            }
</a><a href="#h330-0-386" id="h330-0-386" class="d">-
</a><a href="#h330-0-387" id="h330-0-387" class="d">-            event.addInvokeLater {
</a><a href="#h330-0-388" id="h330-0-388" class="d">-                if (messageContent.contentType == ContentType.SNAP) {
</a><a href="#h330-0-389" id="h330-0-389" class="d">-                    messageContent.contentType = ContentType.EXTERNAL_MEDIA
</a><a href="#h330-0-390" id="h330-0-390" class="d">-                }
</a><a href="#h330-0-391" id="h330-0-391" class="d">-
</a><a href="#h330-0-392" id="h330-0-392" class="d">-                if (messageContent.contentType == ContentType.CHAT) {
</a><a href="#h330-0-393" id="h330-0-393" class="d">-                    messageContent.contentType = ContentType.SHARE
</a><a href="#h330-0-394" id="h330-0-394" class="d">-                }
</a><a href="#h330-0-395" id="h330-0-395" class="d">-            }
</a><a href="#h330-0-396" id="h330-0-396" class="d">-        }
</a><a href="#h330-0-397" id="h330-0-397" class="d">-
</a><a href="#h330-0-398" id="h330-0-398" class="d">-        context.event.subscribe(UnaryCallEvent::class) { event -&gt;
</a><a href="#h330-0-399" id="h330-0-399" class="d">-            if (event.uri != &quot;/messagingcoreservice.MessagingCoreService/CreateContentMessage&quot;) return@subscribe
</a><a href="#h330-0-400" id="h330-0-400" class="d">-            val protoReader = ProtoReader(event.buffer)
</a><a href="#h330-0-401" id="h330-0-401" class="d">-
</a><a href="#h330-0-402" id="h330-0-402" class="d">-            val conversationIds = mutableListOf&lt;SnapUUID&gt;()
</a><a href="#h330-0-403" id="h330-0-403" class="d">-            protoReader.eachBuffer(3) {
</a><a href="#h330-0-404" id="h330-0-404" class="d">-                conversationIds.add(SnapUUID.fromBytes(getByteArray(1, 1, 1) ?: return@eachBuffer))
</a><a href="#h330-0-405" id="h330-0-405" class="d">-            }
</a><a href="#h330-0-406" id="h330-0-406" class="d">-
</a><a href="#h330-0-407" id="h330-0-407" class="d">-            if (conversationIds.any { !getState(it.toString()) }) {
</a><a href="#h330-0-408" id="h330-0-408" class="d">-                context.log.debug(&quot;Skipping encryption for conversation ids: ${conversationIds.joinToString(&quot;, &quot;)}&quot;)
</a><a href="#h330-0-409" id="h330-0-409" class="d">-                return@subscribe
</a><a href="#h330-0-410" id="h330-0-410" class="d">-            }
</a><a href="#h330-0-411" id="h330-0-411" class="d">-
</a><a href="#h330-0-412" id="h330-0-412" class="d">-            val participantsIds = conversationIds.map { getE2EParticipants(it.toString()) }.flatten().distinct()
</a><a href="#h330-0-413" id="h330-0-413" class="d">-
</a><a href="#h330-0-414" id="h330-0-414" class="d">-            if (participantsIds.isEmpty()) {
</a><a href="#h330-0-415" id="h330-0-415" class="d">-                context.longToast(&quot;You don&#39;t have any friends in this conversation to encrypt messages with!&quot;)
</a><a href="#h330-0-416" id="h330-0-416" class="d">-                return@subscribe
</a><a href="#h330-0-417" id="h330-0-417" class="d">-            }
</a><a href="#h330-0-418" id="h330-0-418" class="d">-            val messageReader = protoReader.followPath(4) ?: return@subscribe
</a><a href="#h330-0-419" id="h330-0-419" class="d">-
</a><a href="#h330-0-420" id="h330-0-420" class="d">-            if (messageReader.getVarInt(4, 2, 1, 1) != null) {
</a><a href="#h330-0-421" id="h330-0-421" class="d">-                return@subscribe
</a><a href="#h330-0-422" id="h330-0-422" class="d">-            }
</a><a href="#h330-0-423" id="h330-0-423" class="d">-
</a><a href="#h330-0-424" id="h330-0-424" class="d">-            event.buffer = ProtoEditor(event.buffer).apply {
</a><a href="#h330-0-425" id="h330-0-425" class="d">-                val contentType = fixContentType(
</a><a href="#h330-0-426" id="h330-0-426" class="d">-                    ContentType.fromId(messageReader.getVarInt(2)?.toInt() ?: -1),
</a><a href="#h330-0-427" id="h330-0-427" class="d">-                    messageReader.followPath(4) ?: return@apply
</a><a href="#h330-0-428" id="h330-0-428" class="d">-                ) ?: return@apply
</a><a href="#h330-0-429" id="h330-0-429" class="d">-                val messageContent = messageReader.getByteArray(4) ?: return@apply
</a><a href="#h330-0-430" id="h330-0-430" class="d">-
</a><a href="#h330-0-431" id="h330-0-431" class="d">-                runCatching {
</a><a href="#h330-0-432" id="h330-0-432" class="d">-                    edit(4) {
</a><a href="#h330-0-433" id="h330-0-433" class="d">-                        //set message content type
</a><a href="#h330-0-434" id="h330-0-434" class="d">-                        remove(2)
</a><a href="#h330-0-435" id="h330-0-435" class="d">-                        addVarInt(2, contentType.id)
</a><a href="#h330-0-436" id="h330-0-436" class="d">-
</a><a href="#h330-0-437" id="h330-0-437" class="d">-                        //set encrypted content
</a><a href="#h330-0-438" id="h330-0-438" class="d">-                        remove(4)
</a><a href="#h330-0-439" id="h330-0-439" class="d">-                        add(4) {
</a><a href="#h330-0-440" id="h330-0-440" class="d">-                            from(2) {
</a><a href="#h330-0-441" id="h330-0-441" class="d">-                                from(1) {
</a><a href="#h330-0-442" id="h330-0-442" class="d">-                                    addVarInt(1, ENCRYPTED_MESSAGE_ID)
</a><a href="#h330-0-443" id="h330-0-443" class="d">-                                    participantsIds.forEach { participantId -&gt;
</a><a href="#h330-0-444" id="h330-0-444" class="d">-                                        val encryptedMessage = e2eeInterface.encryptMessage(participantId,
</a><a href="#h330-0-445" id="h330-0-445" class="d">-                                            messageContent
</a><a href="#h330-0-446" id="h330-0-446" class="d">-                                        ) ?: run {
</a><a href="#h330-0-447" id="h330-0-447" class="d">-                                            context.log.error(&quot;Failed to encrypt message for $participantId&quot;)
</a><a href="#h330-0-448" id="h330-0-448" class="d">-                                            return@forEach
</a><a href="#h330-0-449" id="h330-0-449" class="d">-                                        }
</a><a href="#h330-0-450" id="h330-0-450" class="d">-                                        context.log.debug(&quot;encrypted message size = ${encryptedMessage.ciphertext.size} for $participantId&quot;)
</a><a href="#h330-0-451" id="h330-0-451" class="d">-                                        from(2) {
</a><a href="#h330-0-452" id="h330-0-452" class="d">-                                            // participantId is hashed with iv to prevent leaking it when sending to multiple conversations
</a><a href="#h330-0-453" id="h330-0-453" class="d">-                                            addBuffer(1, hashParticipantId(participantId, encryptedMessage.iv))
</a><a href="#h330-0-454" id="h330-0-454" class="d">-                                            addBuffer(2, encryptedMessage.iv)
</a><a href="#h330-0-455" id="h330-0-455" class="d">-                                            addBuffer(3, encryptedMessage.ciphertext)
</a><a href="#h330-0-456" id="h330-0-456" class="d">-                                        }
</a><a href="#h330-0-457" id="h330-0-457" class="d">-                                    }
</a><a href="#h330-0-458" id="h330-0-458" class="d">-                                }
</a><a href="#h330-0-459" id="h330-0-459" class="d">-                            }
</a><a href="#h330-0-460" id="h330-0-460" class="d">-                        }
</a><a href="#h330-0-461" id="h330-0-461" class="d">-                    }
</a><a href="#h330-0-462" id="h330-0-462" class="d">-                }.onFailure {
</a><a href="#h330-0-463" id="h330-0-463" class="d">-                    event.canceled = true
</a><a href="#h330-0-464" id="h330-0-464" class="d">-                    context.log.error(&quot;Failed to encrypt message&quot;, it)
</a><a href="#h330-0-465" id="h330-0-465" class="d">-                    context.longToast(&quot;Failed to encrypt message! Check logcat for more details.&quot;)
</a><a href="#h330-0-466" id="h330-0-466" class="d">-                }
</a><a href="#h330-0-467" id="h330-0-467" class="d">-            }.toByteArray()
</a><a href="#h330-0-468" id="h330-0-468" class="d">-        }
</a><a href="#h330-0-469" id="h330-0-469" class="d">-    }
</a><a href="#h330-0-470" id="h330-0-470" class="d">-
</a><a href="#h330-0-471" id="h330-0-471" class="d">-    override fun init() {
</a><a href="#h330-0-472" id="h330-0-472" class="d">-        if (!isEnabled) return
</a><a href="#h330-0-473" id="h330-0-473" class="d">-
</a><a href="#h330-0-474" id="h330-0-474" class="d">-        context.event.subscribe(BuildMessageEvent::class, priority = 0) { event -&gt;
</a><a href="#h330-0-475" id="h330-0-475" class="d">-            val message = event.message
</a><a href="#h330-0-476" id="h330-0-476" class="d">-            val conversationId = message.messageDescriptor.conversationId.toString()
</a><a href="#h330-0-477" id="h330-0-477" class="d">-            messageHook(
</a><a href="#h330-0-478" id="h330-0-478" class="d">-                conversationId = conversationId,
</a><a href="#h330-0-479" id="h330-0-479" class="d">-                messageId = message.messageDescriptor.messageId,
</a><a href="#h330-0-480" id="h330-0-480" class="d">-                senderId = message.senderId.toString(),
</a><a href="#h330-0-481" id="h330-0-481" class="d">-                messageContent = message.messageContent
</a><a href="#h330-0-482" id="h330-0-482" class="d">-            )
</a><a href="#h330-0-483" id="h330-0-483" class="d">-
</a><a href="#h330-0-484" id="h330-0-484" class="d">-            message.messageContent.instanceNonNull()
</a><a href="#h330-0-485" id="h330-0-485" class="d">-                .getObjectField(&quot;mQuotedMessage&quot;)
</a><a href="#h330-0-486" id="h330-0-486" class="d">-                ?.getObjectField(&quot;mContent&quot;)
</a><a href="#h330-0-487" id="h330-0-487" class="d">-                ?.also { quotedMessage -&gt;
</a><a href="#h330-0-488" id="h330-0-488" class="d">-                messageHook(
</a><a href="#h330-0-489" id="h330-0-489" class="d">-                    conversationId = conversationId,
</a><a href="#h330-0-490" id="h330-0-490" class="d">-                    messageId = quotedMessage.getObjectField(&quot;mMessageId&quot;)?.toString()?.toLong() ?: return@also,
</a><a href="#h330-0-491" id="h330-0-491" class="d">-                    senderId = SnapUUID(quotedMessage.getObjectField(&quot;mSenderId&quot;)).toString(),
</a><a href="#h330-0-492" id="h330-0-492" class="d">-                    messageContent = MessageContent(quotedMessage)
</a><a href="#h330-0-493" id="h330-0-493" class="d">-                )
</a><a href="#h330-0-494" id="h330-0-494" class="d">-            }
</a><a href="#h330-0-495" id="h330-0-495" class="d">-        }
</a><a href="#h330-0-496" id="h330-0-496" class="d">-    }
</a><a href="#h330-0-497" id="h330-0-497" class="d">-
</a><a href="#h330-0-498" id="h330-0-498" class="d">-    override fun getRuleState() = RuleState.WHITELIST
</a><a href="#h330-0-499" id="h330-0-499" class="d">-}</a><a href="#h330-0-500" id="h330-0-500" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h331" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/experiments/InfiniteStoryBoost.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/experiments/InfiniteStoryBoost.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/experiments/InfiniteStoryBoost.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/experiments/InfiniteStoryBoost.kt</a></b>
<a href="#h331-0" id="h331-0" class="h">@@ -1,23 +0,0 @@
</a><a href="#h331-0-0" id="h331-0-0" class="d">-package me.rhunk.snapenhance.features.impl.experiments
</a><a href="#h331-0-1" id="h331-0-1" class="d">-
</a><a href="#h331-0-2" id="h331-0-2" class="d">-import me.rhunk.snapenhance.features.Feature
</a><a href="#h331-0-3" id="h331-0-3" class="d">-import me.rhunk.snapenhance.features.FeatureLoadParams
</a><a href="#h331-0-4" id="h331-0-4" class="d">-import me.rhunk.snapenhance.hook.HookStage
</a><a href="#h331-0-5" id="h331-0-5" class="d">-import me.rhunk.snapenhance.hook.hookConstructor
</a><a href="#h331-0-6" id="h331-0-6" class="d">-
</a><a href="#h331-0-7" id="h331-0-7" class="d">-class InfiniteStoryBoost : Feature(&quot;InfiniteStoryBoost&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_ASYNC) {
</a><a href="#h331-0-8" id="h331-0-8" class="d">-    override fun asyncOnActivityCreate() {
</a><a href="#h331-0-9" id="h331-0-9" class="d">-        val storyBoostStateClass = context.mappings.getMappedClass(&quot;StoryBoostStateClass&quot;)
</a><a href="#h331-0-10" id="h331-0-10" class="d">-
</a><a href="#h331-0-11" id="h331-0-11" class="d">-        storyBoostStateClass.hookConstructor(HookStage.BEFORE, {
</a><a href="#h331-0-12" id="h331-0-12" class="d">-            context.config.experimental.infiniteStoryBoost.get()
</a><a href="#h331-0-13" id="h331-0-13" class="d">-        }) { param -&gt;
</a><a href="#h331-0-14" id="h331-0-14" class="d">-            val startTimeMillis = param.arg&lt;Long&gt;(1)
</a><a href="#h331-0-15" id="h331-0-15" class="d">-            //reset timestamp if it&#39;s more than 24 hours
</a><a href="#h331-0-16" id="h331-0-16" class="d">-            if (System.currentTimeMillis() - startTimeMillis &gt; 86400000) {
</a><a href="#h331-0-17" id="h331-0-17" class="d">-                param.setArg(1, 0)
</a><a href="#h331-0-18" id="h331-0-18" class="d">-                param.setArg(2, 0)
</a><a href="#h331-0-19" id="h331-0-19" class="d">-            }
</a><a href="#h331-0-20" id="h331-0-20" class="d">-        }
</a><a href="#h331-0-21" id="h331-0-21" class="d">-    }
</a><a href="#h331-0-22" id="h331-0-22" class="d">-}</a><a href="#h331-0-23" id="h331-0-23" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h332" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/experiments/MeoPasscodeBypass.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/experiments/MeoPasscodeBypass.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/experiments/MeoPasscodeBypass.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/experiments/MeoPasscodeBypass.kt</a></b>
<a href="#h332-0" id="h332-0" class="h">@@ -1,22 +0,0 @@
</a><a href="#h332-0-0" id="h332-0-0" class="d">-package me.rhunk.snapenhance.features.impl.experiments
</a><a href="#h332-0-1" id="h332-0-1" class="d">-
</a><a href="#h332-0-2" id="h332-0-2" class="d">-import me.rhunk.snapenhance.features.Feature
</a><a href="#h332-0-3" id="h332-0-3" class="d">-import me.rhunk.snapenhance.features.FeatureLoadParams
</a><a href="#h332-0-4" id="h332-0-4" class="d">-import me.rhunk.snapenhance.hook.HookStage
</a><a href="#h332-0-5" id="h332-0-5" class="d">-import me.rhunk.snapenhance.hook.Hooker
</a><a href="#h332-0-6" id="h332-0-6" class="d">-
</a><a href="#h332-0-7" id="h332-0-7" class="d">-class MeoPasscodeBypass : Feature(&quot;Meo Passcode Bypass&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_ASYNC) {
</a><a href="#h332-0-8" id="h332-0-8" class="d">-    override fun asyncOnActivityCreate() {
</a><a href="#h332-0-9" id="h332-0-9" class="d">-        val bcrypt = context.mappings.getMappedMap(&quot;BCrypt&quot;)
</a><a href="#h332-0-10" id="h332-0-10" class="d">-
</a><a href="#h332-0-11" id="h332-0-11" class="d">-        Hooker.hook(
</a><a href="#h332-0-12" id="h332-0-12" class="d">-            context.androidContext.classLoader.loadClass(bcrypt[&quot;class&quot;].toString()),
</a><a href="#h332-0-13" id="h332-0-13" class="d">-            bcrypt[&quot;hashMethod&quot;].toString(),
</a><a href="#h332-0-14" id="h332-0-14" class="d">-            HookStage.BEFORE,
</a><a href="#h332-0-15" id="h332-0-15" class="d">-            { context.config.experimental.meoPasscodeBypass.get() },
</a><a href="#h332-0-16" id="h332-0-16" class="d">-        ) { param -&gt;
</a><a href="#h332-0-17" id="h332-0-17" class="d">-            //set the hash to the result of the method
</a><a href="#h332-0-18" id="h332-0-18" class="d">-            param.setResult(param.arg(1))
</a><a href="#h332-0-19" id="h332-0-19" class="d">-        }
</a><a href="#h332-0-20" id="h332-0-20" class="d">-    }
</a><a href="#h332-0-21" id="h332-0-21" class="d">-}</a><a href="#h332-0-22" id="h332-0-22" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h333" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/experiments/NoFriendScoreDelay.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/experiments/NoFriendScoreDelay.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/experiments/NoFriendScoreDelay.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/experiments/NoFriendScoreDelay.kt</a></b>
<a href="#h333-0" id="h333-0" class="h">@@ -1,20 +0,0 @@
</a><a href="#h333-0-0" id="h333-0-0" class="d">-package me.rhunk.snapenhance.features.impl.experiments
</a><a href="#h333-0-1" id="h333-0-1" class="d">-
</a><a href="#h333-0-2" id="h333-0-2" class="d">-import me.rhunk.snapenhance.features.Feature
</a><a href="#h333-0-3" id="h333-0-3" class="d">-import me.rhunk.snapenhance.features.FeatureLoadParams
</a><a href="#h333-0-4" id="h333-0-4" class="d">-import me.rhunk.snapenhance.hook.HookStage
</a><a href="#h333-0-5" id="h333-0-5" class="d">-import me.rhunk.snapenhance.hook.hookConstructor
</a><a href="#h333-0-6" id="h333-0-6" class="d">-import java.lang.reflect.Constructor
</a><a href="#h333-0-7" id="h333-0-7" class="d">-
</a><a href="#h333-0-8" id="h333-0-8" class="d">-class NoFriendScoreDelay : Feature(&quot;NoFriendScoreDelay&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_SYNC) {
</a><a href="#h333-0-9" id="h333-0-9" class="d">-    override fun onActivityCreate() {
</a><a href="#h333-0-10" id="h333-0-10" class="d">-        if (!context.config.experimental.noFriendScoreDelay.get()) return
</a><a href="#h333-0-11" id="h333-0-11" class="d">-        val scoreUpdateClass = context.mappings.getMappedClass(&quot;ScoreUpdate&quot;)
</a><a href="#h333-0-12" id="h333-0-12" class="d">-
</a><a href="#h333-0-13" id="h333-0-13" class="d">-        scoreUpdateClass.hookConstructor(HookStage.BEFORE) { param -&gt;
</a><a href="#h333-0-14" id="h333-0-14" class="d">-            val constructor = param.method() as Constructor&lt;*&gt;
</a><a href="#h333-0-15" id="h333-0-15" class="d">-            if (constructor.parameterTypes.size &lt; 3 || constructor.parameterTypes[3] != java.util.Collection::class.java) return@hookConstructor
</a><a href="#h333-0-16" id="h333-0-16" class="d">-            param.setArg(2, 0L)
</a><a href="#h333-0-17" id="h333-0-17" class="d">-        }
</a><a href="#h333-0-18" id="h333-0-18" class="d">-    }
</a><a href="#h333-0-19" id="h333-0-19" class="d">-}</a><a href="#h333-0-20" id="h333-0-20" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h334" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/experiments/UnlimitedMultiSnap.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/experiments/UnlimitedMultiSnap.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/experiments/UnlimitedMultiSnap.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/experiments/UnlimitedMultiSnap.kt</a></b>
<a href="#h334-0" id="h334-0" class="h">@@ -1,24 +0,0 @@
</a><a href="#h334-0-0" id="h334-0-0" class="d">-package me.rhunk.snapenhance.features.impl.experiments
</a><a href="#h334-0-1" id="h334-0-1" class="d">-
</a><a href="#h334-0-2" id="h334-0-2" class="d">-import me.rhunk.snapenhance.core.util.ktx.setObjectField
</a><a href="#h334-0-3" id="h334-0-3" class="d">-import me.rhunk.snapenhance.features.Feature
</a><a href="#h334-0-4" id="h334-0-4" class="d">-import me.rhunk.snapenhance.features.FeatureLoadParams
</a><a href="#h334-0-5" id="h334-0-5" class="d">-import me.rhunk.snapenhance.hook.HookStage
</a><a href="#h334-0-6" id="h334-0-6" class="d">-import me.rhunk.snapenhance.hook.hookConstructor
</a><a href="#h334-0-7" id="h334-0-7" class="d">-
</a><a href="#h334-0-8" id="h334-0-8" class="d">-class UnlimitedMultiSnap : Feature(&quot;UnlimitedMultiSnap&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_ASYNC) {
</a><a href="#h334-0-9" id="h334-0-9" class="d">-    override fun asyncOnActivityCreate() {
</a><a href="#h334-0-10" id="h334-0-10" class="d">-        android.util.Pair::class.java.hookConstructor(HookStage.AFTER, {
</a><a href="#h334-0-11" id="h334-0-11" class="d">-            context.config.experimental.unlimitedMultiSnap.get()
</a><a href="#h334-0-12" id="h334-0-12" class="d">-        }) { param -&gt;
</a><a href="#h334-0-13" id="h334-0-13" class="d">-            val first = param.arg&lt;Any&gt;(0)
</a><a href="#h334-0-14" id="h334-0-14" class="d">-            val second = param.arg&lt;Any&gt;(1)
</a><a href="#h334-0-15" id="h334-0-15" class="d">-            if (
</a><a href="#h334-0-16" id="h334-0-16" class="d">-                first == true &amp;&amp; // isOverTheLimit
</a><a href="#h334-0-17" id="h334-0-17" class="d">-                second == 8 // limit
</a><a href="#h334-0-18" id="h334-0-18" class="d">-            ) {
</a><a href="#h334-0-19" id="h334-0-19" class="d">-                param.thisObject&lt;Any&gt;().setObjectField(&quot;first&quot;, false)
</a><a href="#h334-0-20" id="h334-0-20" class="d">-            }
</a><a href="#h334-0-21" id="h334-0-21" class="d">-        }
</a><a href="#h334-0-22" id="h334-0-22" class="d">-    }
</a><a href="#h334-0-23" id="h334-0-23" class="d">-}</a><a href="#h334-0-24" id="h334-0-24" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h335" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/privacy/DisableMetrics.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/privacy/DisableMetrics.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/privacy/DisableMetrics.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/privacy/DisableMetrics.kt</a></b>
<a href="#h335-0" id="h335-0" class="h">@@ -1,30 +0,0 @@
</a><a href="#h335-0-0" id="h335-0-0" class="d">-package me.rhunk.snapenhance.features.impl.privacy
</a><a href="#h335-0-1" id="h335-0-1" class="d">-
</a><a href="#h335-0-2" id="h335-0-2" class="d">-import me.rhunk.snapenhance.core.event.events.impl.NetworkApiRequestEvent
</a><a href="#h335-0-3" id="h335-0-3" class="d">-import me.rhunk.snapenhance.features.Feature
</a><a href="#h335-0-4" id="h335-0-4" class="d">-import me.rhunk.snapenhance.features.FeatureLoadParams
</a><a href="#h335-0-5" id="h335-0-5" class="d">-import me.rhunk.snapenhance.hook.HookStage
</a><a href="#h335-0-6" id="h335-0-6" class="d">-import me.rhunk.snapenhance.hook.Hooker
</a><a href="#h335-0-7" id="h335-0-7" class="d">-
</a><a href="#h335-0-8" id="h335-0-8" class="d">-class DisableMetrics : Feature(&quot;DisableMetrics&quot;, loadParams = FeatureLoadParams.INIT_SYNC) {
</a><a href="#h335-0-9" id="h335-0-9" class="d">-    override fun init() {
</a><a href="#h335-0-10" id="h335-0-10" class="d">-        val disableMetrics by context.config.global.disableMetrics
</a><a href="#h335-0-11" id="h335-0-11" class="d">-
</a><a href="#h335-0-12" id="h335-0-12" class="d">-        Hooker.hook(context.classCache.unifiedGrpcService, &quot;unaryCall&quot;, HookStage.BEFORE,
</a><a href="#h335-0-13" id="h335-0-13" class="d">-            {  disableMetrics }) { param -&gt;
</a><a href="#h335-0-14" id="h335-0-14" class="d">-            val url: String = param.arg(0)
</a><a href="#h335-0-15" id="h335-0-15" class="d">-            if (url.endsWith(&quot;snapchat.valis.Valis/SendClientUpdate&quot;) ||
</a><a href="#h335-0-16" id="h335-0-16" class="d">-                url.endsWith(&quot;targetingQuery&quot;)
</a><a href="#h335-0-17" id="h335-0-17" class="d">-            ) {
</a><a href="#h335-0-18" id="h335-0-18" class="d">-                param.setResult(null)
</a><a href="#h335-0-19" id="h335-0-19" class="d">-            }
</a><a href="#h335-0-20" id="h335-0-20" class="d">-        }
</a><a href="#h335-0-21" id="h335-0-21" class="d">-
</a><a href="#h335-0-22" id="h335-0-22" class="d">-        context.event.subscribe(NetworkApiRequestEvent::class, { disableMetrics }) { param -&gt;
</a><a href="#h335-0-23" id="h335-0-23" class="d">-            val url = param.url
</a><a href="#h335-0-24" id="h335-0-24" class="d">-            if (url.contains(&quot;app-analytics&quot;) || url.endsWith(&quot;v1/metrics&quot;)) {
</a><a href="#h335-0-25" id="h335-0-25" class="d">-                param.canceled = true
</a><a href="#h335-0-26" id="h335-0-26" class="d">-            }
</a><a href="#h335-0-27" id="h335-0-27" class="d">-        }
</a><a href="#h335-0-28" id="h335-0-28" class="d">-    }
</a><a href="#h335-0-29" id="h335-0-29" class="d">-}</a><a href="#h335-0-30" id="h335-0-30" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h336" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/privacy/PreventMessageSending.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/privacy/PreventMessageSending.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/privacy/PreventMessageSending.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/privacy/PreventMessageSending.kt</a></b>
<a href="#h336-0" id="h336-0" class="h">@@ -1,48 +0,0 @@
</a><a href="#h336-0-0" id="h336-0-0" class="d">-package me.rhunk.snapenhance.features.impl.privacy
</a><a href="#h336-0-1" id="h336-0-1" class="d">-
</a><a href="#h336-0-2" id="h336-0-2" class="d">-import me.rhunk.snapenhance.core.event.events.impl.SendMessageWithContentEvent
</a><a href="#h336-0-3" id="h336-0-3" class="d">-import me.rhunk.snapenhance.core.event.events.impl.UnaryCallEvent
</a><a href="#h336-0-4" id="h336-0-4" class="d">-import me.rhunk.snapenhance.core.util.protobuf.ProtoEditor
</a><a href="#h336-0-5" id="h336-0-5" class="d">-import me.rhunk.snapenhance.data.NotificationType
</a><a href="#h336-0-6" id="h336-0-6" class="d">-import me.rhunk.snapenhance.features.Feature
</a><a href="#h336-0-7" id="h336-0-7" class="d">-import me.rhunk.snapenhance.features.FeatureLoadParams
</a><a href="#h336-0-8" id="h336-0-8" class="d">-import me.rhunk.snapenhance.hook.HookStage
</a><a href="#h336-0-9" id="h336-0-9" class="d">-import me.rhunk.snapenhance.hook.hook
</a><a href="#h336-0-10" id="h336-0-10" class="d">-
</a><a href="#h336-0-11" id="h336-0-11" class="d">-class PreventMessageSending : Feature(&quot;Prevent message sending&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_ASYNC) {
</a><a href="#h336-0-12" id="h336-0-12" class="d">-    override fun asyncOnActivityCreate() {
</a><a href="#h336-0-13" id="h336-0-13" class="d">-        val preventMessageSending by context.config.messaging.preventMessageSending
</a><a href="#h336-0-14" id="h336-0-14" class="d">-
</a><a href="#h336-0-15" id="h336-0-15" class="d">-        context.event.subscribe(UnaryCallEvent::class, { preventMessageSending.contains(&quot;snap_replay&quot;) }) { event -&gt;
</a><a href="#h336-0-16" id="h336-0-16" class="d">-            if (event.uri != &quot;/messagingcoreservice.MessagingCoreService/UpdateContentMessage&quot;) return@subscribe
</a><a href="#h336-0-17" id="h336-0-17" class="d">-            event.buffer = ProtoEditor(event.buffer).apply {
</a><a href="#h336-0-18" id="h336-0-18" class="d">-                edit(3) {
</a><a href="#h336-0-19" id="h336-0-19" class="d">-                    // replace replayed to read receipt
</a><a href="#h336-0-20" id="h336-0-20" class="d">-                    remove(13)
</a><a href="#h336-0-21" id="h336-0-21" class="d">-                    addBuffer(4, byteArrayOf())
</a><a href="#h336-0-22" id="h336-0-22" class="d">-                }
</a><a href="#h336-0-23" id="h336-0-23" class="d">-            }.toByteArray()
</a><a href="#h336-0-24" id="h336-0-24" class="d">-        }
</a><a href="#h336-0-25" id="h336-0-25" class="d">-
</a><a href="#h336-0-26" id="h336-0-26" class="d">-        context.classCache.conversationManager.hook(&quot;updateMessage&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h336-0-27" id="h336-0-27" class="d">-            val messageUpdate = param.arg&lt;Any&gt;(2).toString()
</a><a href="#h336-0-28" id="h336-0-28" class="d">-            if (messageUpdate == &quot;SCREENSHOT&quot; &amp;&amp; preventMessageSending.contains(&quot;chat_screenshot&quot;)) {
</a><a href="#h336-0-29" id="h336-0-29" class="d">-                param.setResult(null)
</a><a href="#h336-0-30" id="h336-0-30" class="d">-            }
</a><a href="#h336-0-31" id="h336-0-31" class="d">-
</a><a href="#h336-0-32" id="h336-0-32" class="d">-            if (messageUpdate == &quot;SCREEN_RECORD&quot; &amp;&amp; preventMessageSending.contains(&quot;chat_screen_record&quot;)) {
</a><a href="#h336-0-33" id="h336-0-33" class="d">-                param.setResult(null)
</a><a href="#h336-0-34" id="h336-0-34" class="d">-            }
</a><a href="#h336-0-35" id="h336-0-35" class="d">-        }
</a><a href="#h336-0-36" id="h336-0-36" class="d">-
</a><a href="#h336-0-37" id="h336-0-37" class="d">-        context.event.subscribe(SendMessageWithContentEvent::class) { event -&gt;
</a><a href="#h336-0-38" id="h336-0-38" class="d">-            val contentType = event.messageContent.contentType
</a><a href="#h336-0-39" id="h336-0-39" class="d">-            val associatedType = NotificationType.fromContentType(contentType ?: return@subscribe) ?: return@subscribe
</a><a href="#h336-0-40" id="h336-0-40" class="d">-
</a><a href="#h336-0-41" id="h336-0-41" class="d">-            if (preventMessageSending.contains(associatedType.key)) {
</a><a href="#h336-0-42" id="h336-0-42" class="d">-                context.log.verbose(&quot;Preventing message sending for $associatedType&quot;)
</a><a href="#h336-0-43" id="h336-0-43" class="d">-                event.canceled = true
</a><a href="#h336-0-44" id="h336-0-44" class="d">-            }
</a><a href="#h336-0-45" id="h336-0-45" class="d">-        }
</a><a href="#h336-0-46" id="h336-0-46" class="d">-    }
</a><a href="#h336-0-47" id="h336-0-47" class="d">-}</a><a href="#h336-0-48" id="h336-0-48" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h337" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/spying/AnonymousStoryViewing.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/spying/AnonymousStoryViewing.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/spying/AnonymousStoryViewing.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/spying/AnonymousStoryViewing.kt</a></b>
<a href="#h337-0" id="h337-0" class="h">@@ -1,27 +0,0 @@
</a><a href="#h337-0-0" id="h337-0-0" class="d">-package me.rhunk.snapenhance.features.impl.spying
</a><a href="#h337-0-1" id="h337-0-1" class="d">-
</a><a href="#h337-0-2" id="h337-0-2" class="d">-import kotlinx.coroutines.runBlocking
</a><a href="#h337-0-3" id="h337-0-3" class="d">-import me.rhunk.snapenhance.core.event.events.impl.NetworkApiRequestEvent
</a><a href="#h337-0-4" id="h337-0-4" class="d">-import me.rhunk.snapenhance.core.util.download.HttpServer
</a><a href="#h337-0-5" id="h337-0-5" class="d">-import me.rhunk.snapenhance.features.Feature
</a><a href="#h337-0-6" id="h337-0-6" class="d">-import me.rhunk.snapenhance.features.FeatureLoadParams
</a><a href="#h337-0-7" id="h337-0-7" class="d">-import kotlin.coroutines.suspendCoroutine
</a><a href="#h337-0-8" id="h337-0-8" class="d">-
</a><a href="#h337-0-9" id="h337-0-9" class="d">-class AnonymousStoryViewing : Feature(&quot;Anonymous Story Viewing&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_ASYNC) {
</a><a href="#h337-0-10" id="h337-0-10" class="d">-    override fun asyncOnActivityCreate() {
</a><a href="#h337-0-11" id="h337-0-11" class="d">-        val anonymousStoryViewProperty by context.config.messaging.anonymousStoryViewing
</a><a href="#h337-0-12" id="h337-0-12" class="d">-        val httpServer = HttpServer()
</a><a href="#h337-0-13" id="h337-0-13" class="d">-
</a><a href="#h337-0-14" id="h337-0-14" class="d">-        context.event.subscribe(NetworkApiRequestEvent::class, { anonymousStoryViewProperty }) { event -&gt;
</a><a href="#h337-0-15" id="h337-0-15" class="d">-            if (!event.url.endsWith(&quot;readreceipt-indexer/batchuploadreadreceipts&quot;)) return@subscribe
</a><a href="#h337-0-16" id="h337-0-16" class="d">-            runBlocking {
</a><a href="#h337-0-17" id="h337-0-17" class="d">-                suspendCoroutine {
</a><a href="#h337-0-18" id="h337-0-18" class="d">-                    httpServer.ensureServerStarted {
</a><a href="#h337-0-19" id="h337-0-19" class="d">-                        event.url = &quot;http://127.0.0.1:${httpServer.port}&quot;
</a><a href="#h337-0-20" id="h337-0-20" class="d">-                        it.resumeWith(Result.success(Unit))
</a><a href="#h337-0-21" id="h337-0-21" class="d">-                    }
</a><a href="#h337-0-22" id="h337-0-22" class="d">-                }
</a><a href="#h337-0-23" id="h337-0-23" class="d">-            }
</a><a href="#h337-0-24" id="h337-0-24" class="d">-        }
</a><a href="#h337-0-25" id="h337-0-25" class="d">-    }
</a><a href="#h337-0-26" id="h337-0-26" class="d">-}
</a><b>diff --git a/<a id="h338" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/spying/MessageLogger.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/spying/MessageLogger.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/spying/MessageLogger.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/spying/MessageLogger.kt</a></b>
<a href="#h338-0" id="h338-0" class="h">@@ -1,179 +0,0 @@
</a><a href="#h338-0-0" id="h338-0-0" class="d">-package me.rhunk.snapenhance.features.impl.spying
</a><a href="#h338-0-1" id="h338-0-1" class="d">-
</a><a href="#h338-0-2" id="h338-0-2" class="d">-import android.graphics.Canvas
</a><a href="#h338-0-3" id="h338-0-3" class="d">-import android.graphics.Paint
</a><a href="#h338-0-4" id="h338-0-4" class="d">-import android.graphics.drawable.ShapeDrawable
</a><a href="#h338-0-5" id="h338-0-5" class="d">-import android.graphics.drawable.shapes.Shape
</a><a href="#h338-0-6" id="h338-0-6" class="d">-import android.os.DeadObjectException
</a><a href="#h338-0-7" id="h338-0-7" class="d">-import com.google.gson.JsonObject
</a><a href="#h338-0-8" id="h338-0-8" class="d">-import com.google.gson.JsonParser
</a><a href="#h338-0-9" id="h338-0-9" class="d">-import me.rhunk.snapenhance.core.event.events.impl.BindViewEvent
</a><a href="#h338-0-10" id="h338-0-10" class="d">-import me.rhunk.snapenhance.core.event.events.impl.BuildMessageEvent
</a><a href="#h338-0-11" id="h338-0-11" class="d">-import me.rhunk.snapenhance.core.util.EvictingMap
</a><a href="#h338-0-12" id="h338-0-12" class="d">-import me.rhunk.snapenhance.core.util.protobuf.ProtoReader
</a><a href="#h338-0-13" id="h338-0-13" class="d">-import me.rhunk.snapenhance.data.ContentType
</a><a href="#h338-0-14" id="h338-0-14" class="d">-import me.rhunk.snapenhance.data.MessageState
</a><a href="#h338-0-15" id="h338-0-15" class="d">-import me.rhunk.snapenhance.features.Feature
</a><a href="#h338-0-16" id="h338-0-16" class="d">-import me.rhunk.snapenhance.features.FeatureLoadParams
</a><a href="#h338-0-17" id="h338-0-17" class="d">-import me.rhunk.snapenhance.ui.addForegroundDrawable
</a><a href="#h338-0-18" id="h338-0-18" class="d">-import me.rhunk.snapenhance.ui.removeForegroundDrawable
</a><a href="#h338-0-19" id="h338-0-19" class="d">-import java.util.concurrent.Executors
</a><a href="#h338-0-20" id="h338-0-20" class="d">-import kotlin.system.measureTimeMillis
</a><a href="#h338-0-21" id="h338-0-21" class="d">-
</a><a href="#h338-0-22" id="h338-0-22" class="d">-private fun Any.longHashCode(): Long {
</a><a href="#h338-0-23" id="h338-0-23" class="d">-    var h = 1125899906842597L
</a><a href="#h338-0-24" id="h338-0-24" class="d">-    val value = this.toString()
</a><a href="#h338-0-25" id="h338-0-25" class="d">-    for (element in value) h = 31 * h + element.code.toLong()
</a><a href="#h338-0-26" id="h338-0-26" class="d">-    return h
</a><a href="#h338-0-27" id="h338-0-27" class="d">-}
</a><a href="#h338-0-28" id="h338-0-28" class="d">-
</a><a href="#h338-0-29" id="h338-0-29" class="d">-class MessageLogger : Feature(&quot;MessageLogger&quot;,
</a><a href="#h338-0-30" id="h338-0-30" class="d">-    loadParams = FeatureLoadParams.INIT_SYNC or
</a><a href="#h338-0-31" id="h338-0-31" class="d">-        FeatureLoadParams.ACTIVITY_CREATE_SYNC or
</a><a href="#h338-0-32" id="h338-0-32" class="d">-        FeatureLoadParams.ACTIVITY_CREATE_ASYNC
</a><a href="#h338-0-33" id="h338-0-33" class="d">-) {
</a><a href="#h338-0-34" id="h338-0-34" class="d">-    companion object {
</a><a href="#h338-0-35" id="h338-0-35" class="d">-        const val PREFETCH_MESSAGE_COUNT = 20
</a><a href="#h338-0-36" id="h338-0-36" class="d">-        const val PREFETCH_FEED_COUNT = 20
</a><a href="#h338-0-37" id="h338-0-37" class="d">-        const val DELETED_MESSAGE_COLOR = 0x2Eb71c1c
</a><a href="#h338-0-38" id="h338-0-38" class="d">-    }
</a><a href="#h338-0-39" id="h338-0-39" class="d">-
</a><a href="#h338-0-40" id="h338-0-40" class="d">-    private val messageLoggerInterface by lazy { context.bridgeClient.getMessageLogger() }
</a><a href="#h338-0-41" id="h338-0-41" class="d">-
</a><a href="#h338-0-42" id="h338-0-42" class="d">-    val isEnabled get() = context.config.messaging.messageLogger.get()
</a><a href="#h338-0-43" id="h338-0-43" class="d">-
</a><a href="#h338-0-44" id="h338-0-44" class="d">-    private val threadPool = Executors.newFixedThreadPool(10)
</a><a href="#h338-0-45" id="h338-0-45" class="d">-
</a><a href="#h338-0-46" id="h338-0-46" class="d">-    private val cachedIdLinks = mutableMapOf&lt;Long, Long&gt;() // client id -&gt; server id
</a><a href="#h338-0-47" id="h338-0-47" class="d">-    private val fetchedMessages = mutableListOf&lt;Long&gt;() // list of unique message ids
</a><a href="#h338-0-48" id="h338-0-48" class="d">-    private val deletedMessageCache = EvictingMap&lt;Long, JsonObject&gt;(200) // unique message id -&gt; message json object
</a><a href="#h338-0-49" id="h338-0-49" class="d">-
</a><a href="#h338-0-50" id="h338-0-50" class="d">-    fun isMessageDeleted(conversationId: String, clientMessageId: Long)
</a><a href="#h338-0-51" id="h338-0-51" class="d">-        = makeUniqueIdentifier(conversationId, clientMessageId)?.let { deletedMessageCache.containsKey(it) } ?: false
</a><a href="#h338-0-52" id="h338-0-52" class="d">-
</a><a href="#h338-0-53" id="h338-0-53" class="d">-    fun deleteMessage(conversationId: String, clientMessageId: Long) {
</a><a href="#h338-0-54" id="h338-0-54" class="d">-        val uniqueMessageId = makeUniqueIdentifier(conversationId, clientMessageId) ?: return
</a><a href="#h338-0-55" id="h338-0-55" class="d">-        fetchedMessages.remove(uniqueMessageId)
</a><a href="#h338-0-56" id="h338-0-56" class="d">-        deletedMessageCache.remove(uniqueMessageId)
</a><a href="#h338-0-57" id="h338-0-57" class="d">-        messageLoggerInterface.deleteMessage(conversationId, uniqueMessageId)
</a><a href="#h338-0-58" id="h338-0-58" class="d">-    }
</a><a href="#h338-0-59" id="h338-0-59" class="d">-
</a><a href="#h338-0-60" id="h338-0-60" class="d">-    fun getMessageObject(conversationId: String, clientMessageId: Long): JsonObject? {
</a><a href="#h338-0-61" id="h338-0-61" class="d">-        val uniqueMessageId = makeUniqueIdentifier(conversationId, clientMessageId) ?: return null
</a><a href="#h338-0-62" id="h338-0-62" class="d">-        if (deletedMessageCache.containsKey(uniqueMessageId)) {
</a><a href="#h338-0-63" id="h338-0-63" class="d">-            return deletedMessageCache[uniqueMessageId]
</a><a href="#h338-0-64" id="h338-0-64" class="d">-        }
</a><a href="#h338-0-65" id="h338-0-65" class="d">-        return messageLoggerInterface.getMessage(conversationId, uniqueMessageId)?.let {
</a><a href="#h338-0-66" id="h338-0-66" class="d">-            JsonParser.parseString(it.toString(Charsets.UTF_8)).asJsonObject
</a><a href="#h338-0-67" id="h338-0-67" class="d">-        }
</a><a href="#h338-0-68" id="h338-0-68" class="d">-    }
</a><a href="#h338-0-69" id="h338-0-69" class="d">-
</a><a href="#h338-0-70" id="h338-0-70" class="d">-    fun getMessageProto(conversationId: String, clientMessageId: Long): ProtoReader? {
</a><a href="#h338-0-71" id="h338-0-71" class="d">-        return getMessageObject(conversationId, clientMessageId)?.let { message -&gt;
</a><a href="#h338-0-72" id="h338-0-72" class="d">-            ProtoReader(message.getAsJsonObject(&quot;mMessageContent&quot;).getAsJsonArray(&quot;mContent&quot;)
</a><a href="#h338-0-73" id="h338-0-73" class="d">-                .map { it.asByte }
</a><a href="#h338-0-74" id="h338-0-74" class="d">-                .toByteArray())
</a><a href="#h338-0-75" id="h338-0-75" class="d">-        }
</a><a href="#h338-0-76" id="h338-0-76" class="d">-    }
</a><a href="#h338-0-77" id="h338-0-77" class="d">-
</a><a href="#h338-0-78" id="h338-0-78" class="d">-    private fun computeMessageIdentifier(conversationId: String, orderKey: Long) = (orderKey.toString() + conversationId).longHashCode()
</a><a href="#h338-0-79" id="h338-0-79" class="d">-
</a><a href="#h338-0-80" id="h338-0-80" class="d">-    private fun makeUniqueIdentifier(conversationId: String, clientMessageId: Long): Long? {
</a><a href="#h338-0-81" id="h338-0-81" class="d">-        val serverMessageId = cachedIdLinks[clientMessageId] ?:
</a><a href="#h338-0-82" id="h338-0-82" class="d">-            context.database.getConversationMessageFromId(clientMessageId)?.serverMessageId?.toLong()?.also {
</a><a href="#h338-0-83" id="h338-0-83" class="d">-                cachedIdLinks[clientMessageId] = it
</a><a href="#h338-0-84" id="h338-0-84" class="d">-            }
</a><a href="#h338-0-85" id="h338-0-85" class="d">-            ?: return run {
</a><a href="#h338-0-86" id="h338-0-86" class="d">-                context.log.error(&quot;Failed to get server message id for $conversationId $clientMessageId&quot;)
</a><a href="#h338-0-87" id="h338-0-87" class="d">-                null
</a><a href="#h338-0-88" id="h338-0-88" class="d">-            }
</a><a href="#h338-0-89" id="h338-0-89" class="d">-        return computeMessageIdentifier(conversationId, serverMessageId)
</a><a href="#h338-0-90" id="h338-0-90" class="d">-    }
</a><a href="#h338-0-91" id="h338-0-91" class="d">-
</a><a href="#h338-0-92" id="h338-0-92" class="d">-    override fun asyncOnActivityCreate() {
</a><a href="#h338-0-93" id="h338-0-93" class="d">-        if (!isEnabled || !context.database.hasArroyo()) {
</a><a href="#h338-0-94" id="h338-0-94" class="d">-            return
</a><a href="#h338-0-95" id="h338-0-95" class="d">-        }
</a><a href="#h338-0-96" id="h338-0-96" class="d">-
</a><a href="#h338-0-97" id="h338-0-97" class="d">-        measureTimeMillis {
</a><a href="#h338-0-98" id="h338-0-98" class="d">-            val conversationIds = context.database.getFeedEntries(PREFETCH_FEED_COUNT).map { it.key!! }
</a><a href="#h338-0-99" id="h338-0-99" class="d">-            if (conversationIds.isEmpty()) return@measureTimeMillis
</a><a href="#h338-0-100" id="h338-0-100" class="d">-            fetchedMessages.addAll(messageLoggerInterface.getLoggedIds(conversationIds.toTypedArray(), PREFETCH_MESSAGE_COUNT).toList())
</a><a href="#h338-0-101" id="h338-0-101" class="d">-        }.also { context.log.verbose(&quot;Loaded ${fetchedMessages.size} cached messages in ${it}ms&quot;) }
</a><a href="#h338-0-102" id="h338-0-102" class="d">-    }
</a><a href="#h338-0-103" id="h338-0-103" class="d">-
</a><a href="#h338-0-104" id="h338-0-104" class="d">-    override fun init() {
</a><a href="#h338-0-105" id="h338-0-105" class="d">-        context.event.subscribe(BuildMessageEvent::class, { isEnabled }, priority = 1) { event -&gt;
</a><a href="#h338-0-106" id="h338-0-106" class="d">-            val messageInstance = event.message.instanceNonNull()
</a><a href="#h338-0-107" id="h338-0-107" class="d">-            if (event.message.messageState != MessageState.COMMITTED) return@subscribe
</a><a href="#h338-0-108" id="h338-0-108" class="d">-
</a><a href="#h338-0-109" id="h338-0-109" class="d">-            cachedIdLinks[event.message.messageDescriptor.messageId] = event.message.orderKey
</a><a href="#h338-0-110" id="h338-0-110" class="d">-            val conversationId = event.message.messageDescriptor.conversationId.toString()
</a><a href="#h338-0-111" id="h338-0-111" class="d">-            //exclude messages sent by me
</a><a href="#h338-0-112" id="h338-0-112" class="d">-            if (event.message.senderId.toString() == context.database.myUserId) return@subscribe
</a><a href="#h338-0-113" id="h338-0-113" class="d">-
</a><a href="#h338-0-114" id="h338-0-114" class="d">-            val uniqueMessageIdentifier = computeMessageIdentifier(conversationId, event.message.orderKey)
</a><a href="#h338-0-115" id="h338-0-115" class="d">-
</a><a href="#h338-0-116" id="h338-0-116" class="d">-            if (event.message.messageContent.contentType != ContentType.STATUS) {
</a><a href="#h338-0-117" id="h338-0-117" class="d">-                if (fetchedMessages.contains(uniqueMessageIdentifier)) return@subscribe
</a><a href="#h338-0-118" id="h338-0-118" class="d">-                fetchedMessages.add(uniqueMessageIdentifier)
</a><a href="#h338-0-119" id="h338-0-119" class="d">-
</a><a href="#h338-0-120" id="h338-0-120" class="d">-                threadPool.execute {
</a><a href="#h338-0-121" id="h338-0-121" class="d">-                    try {
</a><a href="#h338-0-122" id="h338-0-122" class="d">-                        messageLoggerInterface.addMessage(conversationId, uniqueMessageIdentifier, context.gson.toJson(messageInstance).toByteArray(Charsets.UTF_8))
</a><a href="#h338-0-123" id="h338-0-123" class="d">-                    } catch (ignored: DeadObjectException) {}
</a><a href="#h338-0-124" id="h338-0-124" class="d">-                }
</a><a href="#h338-0-125" id="h338-0-125" class="d">-
</a><a href="#h338-0-126" id="h338-0-126" class="d">-                return@subscribe
</a><a href="#h338-0-127" id="h338-0-127" class="d">-            }
</a><a href="#h338-0-128" id="h338-0-128" class="d">-
</a><a href="#h338-0-129" id="h338-0-129" class="d">-            //query the deleted message
</a><a href="#h338-0-130" id="h338-0-130" class="d">-            val deletedMessageObject: JsonObject = if (deletedMessageCache.containsKey(uniqueMessageIdentifier))
</a><a href="#h338-0-131" id="h338-0-131" class="d">-                deletedMessageCache[uniqueMessageIdentifier]
</a><a href="#h338-0-132" id="h338-0-132" class="d">-            else {
</a><a href="#h338-0-133" id="h338-0-133" class="d">-                messageLoggerInterface.getMessage(conversationId, uniqueMessageIdentifier)?.let {
</a><a href="#h338-0-134" id="h338-0-134" class="d">-                    JsonParser.parseString(it.toString(Charsets.UTF_8)).asJsonObject
</a><a href="#h338-0-135" id="h338-0-135" class="d">-                }
</a><a href="#h338-0-136" id="h338-0-136" class="d">-            } ?: return@subscribe
</a><a href="#h338-0-137" id="h338-0-137" class="d">-
</a><a href="#h338-0-138" id="h338-0-138" class="d">-            val messageJsonObject = deletedMessageObject.asJsonObject
</a><a href="#h338-0-139" id="h338-0-139" class="d">-
</a><a href="#h338-0-140" id="h338-0-140" class="d">-            //if the message is a snap make it playable
</a><a href="#h338-0-141" id="h338-0-141" class="d">-            if (messageJsonObject[&quot;mMessageContent&quot;]?.asJsonObject?.get(&quot;mContentType&quot;)?.asString == &quot;SNAP&quot;) {
</a><a href="#h338-0-142" id="h338-0-142" class="d">-                messageJsonObject[&quot;mMetadata&quot;].asJsonObject.addProperty(&quot;mPlayableSnapState&quot;, &quot;PLAYABLE&quot;)
</a><a href="#h338-0-143" id="h338-0-143" class="d">-            }
</a><a href="#h338-0-144" id="h338-0-144" class="d">-
</a><a href="#h338-0-145" id="h338-0-145" class="d">-            //serialize all properties of messageJsonObject and put in the message object
</a><a href="#h338-0-146" id="h338-0-146" class="d">-            messageInstance.javaClass.declaredFields.forEach { field -&gt;
</a><a href="#h338-0-147" id="h338-0-147" class="d">-                field.isAccessible = true
</a><a href="#h338-0-148" id="h338-0-148" class="d">-                if (field.name == &quot;mDescriptor&quot;) return@forEach // prevent the client message id from being overwritten
</a><a href="#h338-0-149" id="h338-0-149" class="d">-                messageJsonObject[field.name]?.let { fieldValue -&gt;
</a><a href="#h338-0-150" id="h338-0-150" class="d">-                    field.set(messageInstance, context.gson.fromJson(fieldValue, field.type))
</a><a href="#h338-0-151" id="h338-0-151" class="d">-                }
</a><a href="#h338-0-152" id="h338-0-152" class="d">-            }
</a><a href="#h338-0-153" id="h338-0-153" class="d">-
</a><a href="#h338-0-154" id="h338-0-154" class="d">-            deletedMessageCache[uniqueMessageIdentifier] = deletedMessageObject
</a><a href="#h338-0-155" id="h338-0-155" class="d">-        }
</a><a href="#h338-0-156" id="h338-0-156" class="d">-    }
</a><a href="#h338-0-157" id="h338-0-157" class="d">-
</a><a href="#h338-0-158" id="h338-0-158" class="d">-    override fun onActivityCreate() {
</a><a href="#h338-0-159" id="h338-0-159" class="d">-        if (!isEnabled) return
</a><a href="#h338-0-160" id="h338-0-160" class="d">-
</a><a href="#h338-0-161" id="h338-0-161" class="d">-        context.event.subscribe(BindViewEvent::class) { event -&gt;
</a><a href="#h338-0-162" id="h338-0-162" class="d">-            event.chatMessage { conversationId, messageId -&gt;
</a><a href="#h338-0-163" id="h338-0-163" class="d">-                event.view.removeForegroundDrawable(&quot;deletedMessage&quot;)
</a><a href="#h338-0-164" id="h338-0-164" class="d">-                makeUniqueIdentifier(conversationId, messageId.toLong())?.let { serverMessageId -&gt;
</a><a href="#h338-0-165" id="h338-0-165" class="d">-                    if (!deletedMessageCache.contains(serverMessageId)) return@chatMessage
</a><a href="#h338-0-166" id="h338-0-166" class="d">-                } ?: return@chatMessage
</a><a href="#h338-0-167" id="h338-0-167" class="d">-
</a><a href="#h338-0-168" id="h338-0-168" class="d">-                event.view.addForegroundDrawable(&quot;deletedMessage&quot;, ShapeDrawable(object: Shape() {
</a><a href="#h338-0-169" id="h338-0-169" class="d">-                    override fun draw(canvas: Canvas, paint: Paint) {
</a><a href="#h338-0-170" id="h338-0-170" class="d">-                        canvas.drawRect(0f, 0f, canvas.width.toFloat(), canvas.height.toFloat(), Paint().apply {
</a><a href="#h338-0-171" id="h338-0-171" class="d">-                            color = DELETED_MESSAGE_COLOR
</a><a href="#h338-0-172" id="h338-0-172" class="d">-                        })
</a><a href="#h338-0-173" id="h338-0-173" class="d">-                    }
</a><a href="#h338-0-174" id="h338-0-174" class="d">-                }))
</a><a href="#h338-0-175" id="h338-0-175" class="d">-            }
</a><a href="#h338-0-176" id="h338-0-176" class="d">-        }
</a><a href="#h338-0-177" id="h338-0-177" class="d">-    }
</a><a href="#h338-0-178" id="h338-0-178" class="d">-}</a><a href="#h338-0-179" id="h338-0-179" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h339" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/spying/PreventReadReceipts.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/spying/PreventReadReceipts.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/spying/PreventReadReceipts.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/spying/PreventReadReceipts.kt</a></b>
<a href="#h339-0" id="h339-0" class="h">@@ -1,28 +0,0 @@
</a><a href="#h339-0-0" id="h339-0-0" class="d">-package me.rhunk.snapenhance.features.impl.spying
</a><a href="#h339-0-1" id="h339-0-1" class="d">-
</a><a href="#h339-0-2" id="h339-0-2" class="d">-import me.rhunk.snapenhance.core.event.events.impl.OnSnapInteractionEvent
</a><a href="#h339-0-3" id="h339-0-3" class="d">-import me.rhunk.snapenhance.data.wrapper.impl.SnapUUID
</a><a href="#h339-0-4" id="h339-0-4" class="d">-import me.rhunk.snapenhance.features.Feature
</a><a href="#h339-0-5" id="h339-0-5" class="d">-import me.rhunk.snapenhance.features.FeatureLoadParams
</a><a href="#h339-0-6" id="h339-0-6" class="d">-import me.rhunk.snapenhance.hook.HookStage
</a><a href="#h339-0-7" id="h339-0-7" class="d">-import me.rhunk.snapenhance.hook.Hooker
</a><a href="#h339-0-8" id="h339-0-8" class="d">-
</a><a href="#h339-0-9" id="h339-0-9" class="d">-class PreventReadReceipts : Feature(&quot;PreventReadReceipts&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_SYNC) {
</a><a href="#h339-0-10" id="h339-0-10" class="d">-    override fun onActivityCreate() {
</a><a href="#h339-0-11" id="h339-0-11" class="d">-        val isConversationInStealthMode: (SnapUUID) -&gt; Boolean = hook@{
</a><a href="#h339-0-12" id="h339-0-12" class="d">-            context.feature(StealthMode::class).canUseRule(it.toString())
</a><a href="#h339-0-13" id="h339-0-13" class="d">-        }
</a><a href="#h339-0-14" id="h339-0-14" class="d">-
</a><a href="#h339-0-15" id="h339-0-15" class="d">-        arrayOf(&quot;mediaMessagesDisplayed&quot;, &quot;displayedMessages&quot;).forEach { methodName: String -&gt;
</a><a href="#h339-0-16" id="h339-0-16" class="d">-            Hooker.hook(context.classCache.conversationManager, methodName, HookStage.BEFORE, { isConversationInStealthMode(SnapUUID(it.arg(0))) }) {
</a><a href="#h339-0-17" id="h339-0-17" class="d">-                it.setResult(null)
</a><a href="#h339-0-18" id="h339-0-18" class="d">-            }
</a><a href="#h339-0-19" id="h339-0-19" class="d">-        }
</a><a href="#h339-0-20" id="h339-0-20" class="d">-
</a><a href="#h339-0-21" id="h339-0-21" class="d">-        context.event.subscribe(OnSnapInteractionEvent::class) { event -&gt;
</a><a href="#h339-0-22" id="h339-0-22" class="d">-            if (isConversationInStealthMode(event.conversationId)) {
</a><a href="#h339-0-23" id="h339-0-23" class="d">-                event.canceled = true
</a><a href="#h339-0-24" id="h339-0-24" class="d">-            }
</a><a href="#h339-0-25" id="h339-0-25" class="d">-        }
</a><a href="#h339-0-26" id="h339-0-26" class="d">-    }
</a><a href="#h339-0-27" id="h339-0-27" class="d">-}</a><a href="#h339-0-28" id="h339-0-28" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h340" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/spying/SnapToChatMedia.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/spying/SnapToChatMedia.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/spying/SnapToChatMedia.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/spying/SnapToChatMedia.kt</a></b>
<a href="#h340-0" id="h340-0" class="h">@@ -1,25 +0,0 @@
</a><a href="#h340-0-0" id="h340-0-0" class="d">-package me.rhunk.snapenhance.features.impl.spying
</a><a href="#h340-0-1" id="h340-0-1" class="d">-
</a><a href="#h340-0-2" id="h340-0-2" class="d">-import me.rhunk.snapenhance.core.event.events.impl.BuildMessageEvent
</a><a href="#h340-0-3" id="h340-0-3" class="d">-import me.rhunk.snapenhance.core.util.protobuf.ProtoReader
</a><a href="#h340-0-4" id="h340-0-4" class="d">-import me.rhunk.snapenhance.core.util.protobuf.ProtoWriter
</a><a href="#h340-0-5" id="h340-0-5" class="d">-import me.rhunk.snapenhance.data.ContentType
</a><a href="#h340-0-6" id="h340-0-6" class="d">-import me.rhunk.snapenhance.features.Feature
</a><a href="#h340-0-7" id="h340-0-7" class="d">-import me.rhunk.snapenhance.features.FeatureLoadParams
</a><a href="#h340-0-8" id="h340-0-8" class="d">-
</a><a href="#h340-0-9" id="h340-0-9" class="d">-class SnapToChatMedia : Feature(&quot;SnapToChatMedia&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_SYNC) {
</a><a href="#h340-0-10" id="h340-0-10" class="d">-    override fun onActivityCreate() {
</a><a href="#h340-0-11" id="h340-0-11" class="d">-        if (!context.config.messaging.snapToChatMedia.get()) return
</a><a href="#h340-0-12" id="h340-0-12" class="d">-
</a><a href="#h340-0-13" id="h340-0-13" class="d">-        context.event.subscribe(BuildMessageEvent::class, priority = 100) { event -&gt;
</a><a href="#h340-0-14" id="h340-0-14" class="d">-            if (event.message.messageContent.contentType != ContentType.SNAP) return@subscribe
</a><a href="#h340-0-15" id="h340-0-15" class="d">-
</a><a href="#h340-0-16" id="h340-0-16" class="d">-            val snapMessageContent = ProtoReader(event.message.messageContent.content).followPath(11)?.getBuffer() ?: return@subscribe
</a><a href="#h340-0-17" id="h340-0-17" class="d">-            event.message.messageContent.content = ProtoWriter().apply {
</a><a href="#h340-0-18" id="h340-0-18" class="d">-                from(3) {
</a><a href="#h340-0-19" id="h340-0-19" class="d">-                    addBuffer(3, snapMessageContent)
</a><a href="#h340-0-20" id="h340-0-20" class="d">-                }
</a><a href="#h340-0-21" id="h340-0-21" class="d">-            }.toByteArray()
</a><a href="#h340-0-22" id="h340-0-22" class="d">-        }
</a><a href="#h340-0-23" id="h340-0-23" class="d">-    }
</a><a href="#h340-0-24" id="h340-0-24" class="d">-}</a><a href="#h340-0-25" id="h340-0-25" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h341" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/spying/StealthMode.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/spying/StealthMode.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/spying/StealthMode.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/spying/StealthMode.kt</a></b>
<a href="#h341-0" id="h341-0" class="h">@@ -1,6 +0,0 @@
</a><a href="#h341-0-0" id="h341-0-0" class="d">-package me.rhunk.snapenhance.features.impl.spying
</a><a href="#h341-0-1" id="h341-0-1" class="d">-
</a><a href="#h341-0-2" id="h341-0-2" class="d">-import me.rhunk.snapenhance.core.messaging.MessagingRuleType
</a><a href="#h341-0-3" id="h341-0-3" class="d">-import me.rhunk.snapenhance.features.MessagingRuleFeature
</a><a href="#h341-0-4" id="h341-0-4" class="d">-
</a><a href="#h341-0-5" id="h341-0-5" class="d">-class StealthMode : MessagingRuleFeature(&quot;StealthMode&quot;, MessagingRuleType.STEALTH)</a><a href="#h341-0-6" id="h341-0-6" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h342" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/AutoSave.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/AutoSave.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/AutoSave.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/AutoSave.kt</a></b>
<a href="#h342-0" id="h342-0" class="h">@@ -1,139 +0,0 @@
</a><a href="#h342-0-0" id="h342-0-0" class="d">-package me.rhunk.snapenhance.features.impl.tweaks
</a><a href="#h342-0-1" id="h342-0-1" class="d">-
</a><a href="#h342-0-2" id="h342-0-2" class="d">-import me.rhunk.snapenhance.core.Logger
</a><a href="#h342-0-3" id="h342-0-3" class="d">-import me.rhunk.snapenhance.core.messaging.MessagingRuleType
</a><a href="#h342-0-4" id="h342-0-4" class="d">-import me.rhunk.snapenhance.core.util.CallbackBuilder
</a><a href="#h342-0-5" id="h342-0-5" class="d">-import me.rhunk.snapenhance.core.util.ktx.getObjectField
</a><a href="#h342-0-6" id="h342-0-6" class="d">-import me.rhunk.snapenhance.data.MessageState
</a><a href="#h342-0-7" id="h342-0-7" class="d">-import me.rhunk.snapenhance.data.wrapper.impl.Message
</a><a href="#h342-0-8" id="h342-0-8" class="d">-import me.rhunk.snapenhance.data.wrapper.impl.SnapUUID
</a><a href="#h342-0-9" id="h342-0-9" class="d">-import me.rhunk.snapenhance.features.FeatureLoadParams
</a><a href="#h342-0-10" id="h342-0-10" class="d">-import me.rhunk.snapenhance.features.MessagingRuleFeature
</a><a href="#h342-0-11" id="h342-0-11" class="d">-import me.rhunk.snapenhance.features.impl.Messaging
</a><a href="#h342-0-12" id="h342-0-12" class="d">-import me.rhunk.snapenhance.features.impl.spying.MessageLogger
</a><a href="#h342-0-13" id="h342-0-13" class="d">-import me.rhunk.snapenhance.features.impl.spying.StealthMode
</a><a href="#h342-0-14" id="h342-0-14" class="d">-import me.rhunk.snapenhance.hook.HookStage
</a><a href="#h342-0-15" id="h342-0-15" class="d">-import me.rhunk.snapenhance.hook.Hooker
</a><a href="#h342-0-16" id="h342-0-16" class="d">-import java.util.concurrent.Executors
</a><a href="#h342-0-17" id="h342-0-17" class="d">-
</a><a href="#h342-0-18" id="h342-0-18" class="d">-class AutoSave : MessagingRuleFeature(&quot;Auto Save&quot;, MessagingRuleType.AUTO_SAVE, loadParams = FeatureLoadParams.ACTIVITY_CREATE_ASYNC) {
</a><a href="#h342-0-19" id="h342-0-19" class="d">-    private val asyncSaveExecutorService = Executors.newSingleThreadExecutor()
</a><a href="#h342-0-20" id="h342-0-20" class="d">-
</a><a href="#h342-0-21" id="h342-0-21" class="d">-    private val messageLogger by lazy { context.feature(MessageLogger::class) }
</a><a href="#h342-0-22" id="h342-0-22" class="d">-    private val messaging by lazy { context.feature(Messaging::class) }
</a><a href="#h342-0-23" id="h342-0-23" class="d">-
</a><a href="#h342-0-24" id="h342-0-24" class="d">-    private val fetchConversationWithMessagesCallbackClass by lazy {  context.mappings.getMappedClass(&quot;callbacks&quot;, &quot;FetchConversationWithMessagesCallback&quot;) }
</a><a href="#h342-0-25" id="h342-0-25" class="d">-    private val callbackClass by lazy {  context.mappings.getMappedClass(&quot;callbacks&quot;, &quot;Callback&quot;) }
</a><a href="#h342-0-26" id="h342-0-26" class="d">-
</a><a href="#h342-0-27" id="h342-0-27" class="d">-    private val updateMessageMethod by lazy { context.classCache.conversationManager.methods.first { it.name == &quot;updateMessage&quot; } }
</a><a href="#h342-0-28" id="h342-0-28" class="d">-    private val fetchConversationWithMessagesPaginatedMethod by lazy {
</a><a href="#h342-0-29" id="h342-0-29" class="d">-        context.classCache.conversationManager.methods.first { it.name == &quot;fetchConversationWithMessagesPaginated&quot; }
</a><a href="#h342-0-30" id="h342-0-30" class="d">-    }
</a><a href="#h342-0-31" id="h342-0-31" class="d">-
</a><a href="#h342-0-32" id="h342-0-32" class="d">-    private val autoSaveFilter by lazy {
</a><a href="#h342-0-33" id="h342-0-33" class="d">-        context.config.messaging.autoSaveMessagesInConversations.get()
</a><a href="#h342-0-34" id="h342-0-34" class="d">-    }
</a><a href="#h342-0-35" id="h342-0-35" class="d">-
</a><a href="#h342-0-36" id="h342-0-36" class="d">-    private fun saveMessage(conversationId: SnapUUID, message: Message) {
</a><a href="#h342-0-37" id="h342-0-37" class="d">-        val messageId = message.messageDescriptor.messageId
</a><a href="#h342-0-38" id="h342-0-38" class="d">-        if (messageLogger.takeIf { it.isEnabled }?.isMessageDeleted(conversationId.toString(), message.messageDescriptor.messageId) == true) return
</a><a href="#h342-0-39" id="h342-0-39" class="d">-        if (message.messageState != MessageState.COMMITTED) return
</a><a href="#h342-0-40" id="h342-0-40" class="d">-
</a><a href="#h342-0-41" id="h342-0-41" class="d">-        runCatching {
</a><a href="#h342-0-42" id="h342-0-42" class="d">-            val callback = CallbackBuilder(callbackClass)
</a><a href="#h342-0-43" id="h342-0-43" class="d">-                .override(&quot;onError&quot;) {
</a><a href="#h342-0-44" id="h342-0-44" class="d">-                    context.log.warn(&quot;Error saving message $messageId&quot;)
</a><a href="#h342-0-45" id="h342-0-45" class="d">-                }.build()
</a><a href="#h342-0-46" id="h342-0-46" class="d">-
</a><a href="#h342-0-47" id="h342-0-47" class="d">-            updateMessageMethod.invoke(
</a><a href="#h342-0-48" id="h342-0-48" class="d">-                context.feature(Messaging::class).conversationManager,
</a><a href="#h342-0-49" id="h342-0-49" class="d">-                conversationId.instanceNonNull(),
</a><a href="#h342-0-50" id="h342-0-50" class="d">-                messageId,
</a><a href="#h342-0-51" id="h342-0-51" class="d">-                context.classCache.messageUpdateEnum.enumConstants.first { it.toString() == &quot;SAVE&quot; },
</a><a href="#h342-0-52" id="h342-0-52" class="d">-                callback
</a><a href="#h342-0-53" id="h342-0-53" class="d">-            )
</a><a href="#h342-0-54" id="h342-0-54" class="d">-        }.onFailure {
</a><a href="#h342-0-55" id="h342-0-55" class="d">-            Logger.xposedLog(&quot;Error saving message $messageId&quot;, it)
</a><a href="#h342-0-56" id="h342-0-56" class="d">-        }
</a><a href="#h342-0-57" id="h342-0-57" class="d">-
</a><a href="#h342-0-58" id="h342-0-58" class="d">-        //delay between saves
</a><a href="#h342-0-59" id="h342-0-59" class="d">-        Thread.sleep(100L)
</a><a href="#h342-0-60" id="h342-0-60" class="d">-    }
</a><a href="#h342-0-61" id="h342-0-61" class="d">-
</a><a href="#h342-0-62" id="h342-0-62" class="d">-    private fun canSaveMessage(message: Message): Boolean {
</a><a href="#h342-0-63" id="h342-0-63" class="d">-        if (message.messageMetadata.savedBy.any { uuid -&gt; uuid.toString() == context.database.myUserId }) return false
</a><a href="#h342-0-64" id="h342-0-64" class="d">-        val contentType = message.messageContent.contentType.toString()
</a><a href="#h342-0-65" id="h342-0-65" class="d">-
</a><a href="#h342-0-66" id="h342-0-66" class="d">-        return autoSaveFilter.any { it == contentType }
</a><a href="#h342-0-67" id="h342-0-67" class="d">-    }
</a><a href="#h342-0-68" id="h342-0-68" class="d">-
</a><a href="#h342-0-69" id="h342-0-69" class="d">-    private fun canSaveInConversation(targetConversationId: String): Boolean {
</a><a href="#h342-0-70" id="h342-0-70" class="d">-        val messaging = context.feature(Messaging::class)
</a><a href="#h342-0-71" id="h342-0-71" class="d">-        val openedConversationId = messaging.openedConversationUUID?.toString() ?: return false
</a><a href="#h342-0-72" id="h342-0-72" class="d">-
</a><a href="#h342-0-73" id="h342-0-73" class="d">-        if (openedConversationId != targetConversationId) return false
</a><a href="#h342-0-74" id="h342-0-74" class="d">-
</a><a href="#h342-0-75" id="h342-0-75" class="d">-        if (context.feature(StealthMode::class).canUseRule(openedConversationId)) return false
</a><a href="#h342-0-76" id="h342-0-76" class="d">-        if (!canUseRule(openedConversationId)) return false
</a><a href="#h342-0-77" id="h342-0-77" class="d">-
</a><a href="#h342-0-78" id="h342-0-78" class="d">-        return true
</a><a href="#h342-0-79" id="h342-0-79" class="d">-    }
</a><a href="#h342-0-80" id="h342-0-80" class="d">-
</a><a href="#h342-0-81" id="h342-0-81" class="d">-    override fun asyncOnActivityCreate() {
</a><a href="#h342-0-82" id="h342-0-82" class="d">-        //called when enter in a conversation (or when a message is sent)
</a><a href="#h342-0-83" id="h342-0-83" class="d">-        Hooker.hook(
</a><a href="#h342-0-84" id="h342-0-84" class="d">-            context.mappings.getMappedClass(&quot;callbacks&quot;, &quot;FetchConversationWithMessagesCallback&quot;),
</a><a href="#h342-0-85" id="h342-0-85" class="d">-            &quot;onFetchConversationWithMessagesComplete&quot;,
</a><a href="#h342-0-86" id="h342-0-86" class="d">-            HookStage.BEFORE,
</a><a href="#h342-0-87" id="h342-0-87" class="d">-            { autoSaveFilter.isNotEmpty() }
</a><a href="#h342-0-88" id="h342-0-88" class="d">-        ) { param -&gt;
</a><a href="#h342-0-89" id="h342-0-89" class="d">-            val conversationId = SnapUUID(param.arg&lt;Any&gt;(0).getObjectField(&quot;mConversationId&quot;)!!)
</a><a href="#h342-0-90" id="h342-0-90" class="d">-            if (!canSaveInConversation(conversationId.toString())) return@hook
</a><a href="#h342-0-91" id="h342-0-91" class="d">-
</a><a href="#h342-0-92" id="h342-0-92" class="d">-            val messages = param.arg&lt;List&lt;Any&gt;&gt;(1).map { Message(it) }
</a><a href="#h342-0-93" id="h342-0-93" class="d">-            messages.forEach {
</a><a href="#h342-0-94" id="h342-0-94" class="d">-                if (!canSaveMessage(it)) return@forEach
</a><a href="#h342-0-95" id="h342-0-95" class="d">-                asyncSaveExecutorService.submit {
</a><a href="#h342-0-96" id="h342-0-96" class="d">-                    saveMessage(conversationId, it)
</a><a href="#h342-0-97" id="h342-0-97" class="d">-                }
</a><a href="#h342-0-98" id="h342-0-98" class="d">-            }
</a><a href="#h342-0-99" id="h342-0-99" class="d">-        }
</a><a href="#h342-0-100" id="h342-0-100" class="d">-
</a><a href="#h342-0-101" id="h342-0-101" class="d">-        //called when a message is received
</a><a href="#h342-0-102" id="h342-0-102" class="d">-        Hooker.hook(
</a><a href="#h342-0-103" id="h342-0-103" class="d">-            context.mappings.getMappedClass(&quot;callbacks&quot;, &quot;FetchMessageCallback&quot;),
</a><a href="#h342-0-104" id="h342-0-104" class="d">-            &quot;onFetchMessageComplete&quot;,
</a><a href="#h342-0-105" id="h342-0-105" class="d">-            HookStage.BEFORE,
</a><a href="#h342-0-106" id="h342-0-106" class="d">-            { autoSaveFilter.isNotEmpty() }
</a><a href="#h342-0-107" id="h342-0-107" class="d">-        ) { param -&gt;
</a><a href="#h342-0-108" id="h342-0-108" class="d">-            val message = Message(param.arg(0))
</a><a href="#h342-0-109" id="h342-0-109" class="d">-            val conversationId = message.messageDescriptor.conversationId
</a><a href="#h342-0-110" id="h342-0-110" class="d">-            if (!canSaveInConversation(conversationId.toString())) return@hook
</a><a href="#h342-0-111" id="h342-0-111" class="d">-            if (!canSaveMessage(message)) return@hook
</a><a href="#h342-0-112" id="h342-0-112" class="d">-
</a><a href="#h342-0-113" id="h342-0-113" class="d">-            asyncSaveExecutorService.submit {
</a><a href="#h342-0-114" id="h342-0-114" class="d">-                saveMessage(conversationId, message)
</a><a href="#h342-0-115" id="h342-0-115" class="d">-            }
</a><a href="#h342-0-116" id="h342-0-116" class="d">-        }
</a><a href="#h342-0-117" id="h342-0-117" class="d">-
</a><a href="#h342-0-118" id="h342-0-118" class="d">-        Hooker.hook(
</a><a href="#h342-0-119" id="h342-0-119" class="d">-            context.mappings.getMappedClass(&quot;callbacks&quot;, &quot;SendMessageCallback&quot;),
</a><a href="#h342-0-120" id="h342-0-120" class="d">-            &quot;onSuccess&quot;,
</a><a href="#h342-0-121" id="h342-0-121" class="d">-            HookStage.BEFORE,
</a><a href="#h342-0-122" id="h342-0-122" class="d">-            { autoSaveFilter.isNotEmpty() }
</a><a href="#h342-0-123" id="h342-0-123" class="d">-        ) {
</a><a href="#h342-0-124" id="h342-0-124" class="d">-            val callback = CallbackBuilder(fetchConversationWithMessagesCallbackClass).build()
</a><a href="#h342-0-125" id="h342-0-125" class="d">-            val conversationUUID = messaging.openedConversationUUID ?: return@hook
</a><a href="#h342-0-126" id="h342-0-126" class="d">-            runCatching {
</a><a href="#h342-0-127" id="h342-0-127" class="d">-                fetchConversationWithMessagesPaginatedMethod.invoke(
</a><a href="#h342-0-128" id="h342-0-128" class="d">-                    messaging.conversationManager, conversationUUID.instanceNonNull(),
</a><a href="#h342-0-129" id="h342-0-129" class="d">-                    Long.MAX_VALUE,
</a><a href="#h342-0-130" id="h342-0-130" class="d">-                    10,
</a><a href="#h342-0-131" id="h342-0-131" class="d">-                    callback
</a><a href="#h342-0-132" id="h342-0-132" class="d">-                )
</a><a href="#h342-0-133" id="h342-0-133" class="d">-            }.onFailure {
</a><a href="#h342-0-134" id="h342-0-134" class="d">-                Logger.xposedLog(&quot;failed to save message&quot;, it)
</a><a href="#h342-0-135" id="h342-0-135" class="d">-            }
</a><a href="#h342-0-136" id="h342-0-136" class="d">-        }
</a><a href="#h342-0-137" id="h342-0-137" class="d">-    }
</a><a href="#h342-0-138" id="h342-0-138" class="d">-}</a><a href="#h342-0-139" id="h342-0-139" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h343" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/BypassVideoLengthRestriction.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/BypassVideoLengthRestriction.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/BypassVideoLengthRestriction.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/BypassVideoLengthRestriction.kt</a></b>
<a href="#h343-0" id="h343-0" class="h">@@ -1,72 +0,0 @@
</a><a href="#h343-0-0" id="h343-0-0" class="d">-package me.rhunk.snapenhance.features.impl.tweaks
</a><a href="#h343-0-1" id="h343-0-1" class="d">-
</a><a href="#h343-0-2" id="h343-0-2" class="d">-import android.os.Build
</a><a href="#h343-0-3" id="h343-0-3" class="d">-import android.os.FileObserver
</a><a href="#h343-0-4" id="h343-0-4" class="d">-import com.google.gson.JsonParser
</a><a href="#h343-0-5" id="h343-0-5" class="d">-import me.rhunk.snapenhance.core.event.events.impl.SendMessageWithContentEvent
</a><a href="#h343-0-6" id="h343-0-6" class="d">-import me.rhunk.snapenhance.core.util.ktx.setObjectField
</a><a href="#h343-0-7" id="h343-0-7" class="d">-import me.rhunk.snapenhance.features.Feature
</a><a href="#h343-0-8" id="h343-0-8" class="d">-import me.rhunk.snapenhance.features.FeatureLoadParams
</a><a href="#h343-0-9" id="h343-0-9" class="d">-import me.rhunk.snapenhance.hook.HookStage
</a><a href="#h343-0-10" id="h343-0-10" class="d">-import me.rhunk.snapenhance.hook.hookConstructor
</a><a href="#h343-0-11" id="h343-0-11" class="d">-import java.io.File
</a><a href="#h343-0-12" id="h343-0-12" class="d">-
</a><a href="#h343-0-13" id="h343-0-13" class="d">-class BypassVideoLengthRestriction :
</a><a href="#h343-0-14" id="h343-0-14" class="d">-    Feature(&quot;BypassVideoLengthRestriction&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_ASYNC) {
</a><a href="#h343-0-15" id="h343-0-15" class="d">-    private lateinit var fileObserver: FileObserver
</a><a href="#h343-0-16" id="h343-0-16" class="d">-
</a><a href="#h343-0-17" id="h343-0-17" class="d">-    override fun asyncOnActivityCreate() {
</a><a href="#h343-0-18" id="h343-0-18" class="d">-        val mode = context.config.global.bypassVideoLengthRestriction.getNullable()
</a><a href="#h343-0-19" id="h343-0-19" class="d">-
</a><a href="#h343-0-20" id="h343-0-20" class="d">-        if (mode == &quot;single&quot;) {
</a><a href="#h343-0-21" id="h343-0-21" class="d">-            //fix black videos when story is posted
</a><a href="#h343-0-22" id="h343-0-22" class="d">-            if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.Q) {
</a><a href="#h343-0-23" id="h343-0-23" class="d">-                val postedStorySnapFolder =
</a><a href="#h343-0-24" id="h343-0-24" class="d">-                    File(context.androidContext.filesDir, &quot;file_manager/posted_story_snap&quot;)
</a><a href="#h343-0-25" id="h343-0-25" class="d">-
</a><a href="#h343-0-26" id="h343-0-26" class="d">-                fileObserver = (object : FileObserver(postedStorySnapFolder, MOVED_TO) {
</a><a href="#h343-0-27" id="h343-0-27" class="d">-                    override fun onEvent(event: Int, path: String?) {
</a><a href="#h343-0-28" id="h343-0-28" class="d">-                        if (event != MOVED_TO || path?.endsWith(&quot;posted_story_snap.2&quot;) != true) return
</a><a href="#h343-0-29" id="h343-0-29" class="d">-                        fileObserver.stopWatching()
</a><a href="#h343-0-30" id="h343-0-30" class="d">-
</a><a href="#h343-0-31" id="h343-0-31" class="d">-                        val file = File(postedStorySnapFolder, path)
</a><a href="#h343-0-32" id="h343-0-32" class="d">-                        runCatching {
</a><a href="#h343-0-33" id="h343-0-33" class="d">-                            val fileContent = JsonParser.parseReader(file.reader()).asJsonObject
</a><a href="#h343-0-34" id="h343-0-34" class="d">-                            if (fileContent[&quot;timerOrDuration&quot;].asLong &lt; 0) file.delete()
</a><a href="#h343-0-35" id="h343-0-35" class="d">-                        }.onFailure {
</a><a href="#h343-0-36" id="h343-0-36" class="d">-                            context.log.error(&quot;Failed to read story metadata file&quot;, it)
</a><a href="#h343-0-37" id="h343-0-37" class="d">-                        }
</a><a href="#h343-0-38" id="h343-0-38" class="d">-                    }
</a><a href="#h343-0-39" id="h343-0-39" class="d">-                })
</a><a href="#h343-0-40" id="h343-0-40" class="d">-
</a><a href="#h343-0-41" id="h343-0-41" class="d">-                context.event.subscribe(SendMessageWithContentEvent::class) { event -&gt;
</a><a href="#h343-0-42" id="h343-0-42" class="d">-                    if (event.destinations.stories.isEmpty()) return@subscribe
</a><a href="#h343-0-43" id="h343-0-43" class="d">-                    fileObserver.startWatching()
</a><a href="#h343-0-44" id="h343-0-44" class="d">-                }
</a><a href="#h343-0-45" id="h343-0-45" class="d">-            }
</a><a href="#h343-0-46" id="h343-0-46" class="d">-
</a><a href="#h343-0-47" id="h343-0-47" class="d">-            context.mappings.getMappedClass(&quot;DefaultMediaItem&quot;)
</a><a href="#h343-0-48" id="h343-0-48" class="d">-                .hookConstructor(HookStage.BEFORE) { param -&gt;
</a><a href="#h343-0-49" id="h343-0-49" class="d">-                    //set the video length argument
</a><a href="#h343-0-50" id="h343-0-50" class="d">-                    param.setArg(5, -1L)
</a><a href="#h343-0-51" id="h343-0-51" class="d">-                }
</a><a href="#h343-0-52" id="h343-0-52" class="d">-        }
</a><a href="#h343-0-53" id="h343-0-53" class="d">-
</a><a href="#h343-0-54" id="h343-0-54" class="d">-        //TODO: allow split from any source
</a><a href="#h343-0-55" id="h343-0-55" class="d">-        if (mode == &quot;split&quot;) {
</a><a href="#h343-0-56" id="h343-0-56" class="d">-            val cameraRollId = context.mappings.getMappedMap(&quot;CameraRollMediaId&quot;)
</a><a href="#h343-0-57" id="h343-0-57" class="d">-            // memories grid
</a><a href="#h343-0-58" id="h343-0-58" class="d">-            findClass(cameraRollId[&quot;class&quot;].toString()).hookConstructor(HookStage.AFTER) { param -&gt;
</a><a href="#h343-0-59" id="h343-0-59" class="d">-                //set the durationMs field
</a><a href="#h343-0-60" id="h343-0-60" class="d">-                param.thisObject&lt;Any&gt;()
</a><a href="#h343-0-61" id="h343-0-61" class="d">-                    .setObjectField(cameraRollId[&quot;durationMsField&quot;].toString(), -1L)
</a><a href="#h343-0-62" id="h343-0-62" class="d">-            }
</a><a href="#h343-0-63" id="h343-0-63" class="d">-
</a><a href="#h343-0-64" id="h343-0-64" class="d">-            // chat camera roll grid
</a><a href="#h343-0-65" id="h343-0-65" class="d">-            findClass(&quot;com.snap.impala.common.media.MediaLibraryItem&quot;).hookConstructor(HookStage.BEFORE) { param -&gt;
</a><a href="#h343-0-66" id="h343-0-66" class="d">-                //set the video length argument
</a><a href="#h343-0-67" id="h343-0-67" class="d">-                param.setArg(3, -1L)
</a><a href="#h343-0-68" id="h343-0-68" class="d">-            }
</a><a href="#h343-0-69" id="h343-0-69" class="d">-        }
</a><a href="#h343-0-70" id="h343-0-70" class="d">-    }
</a><a href="#h343-0-71" id="h343-0-71" class="d">-}</a><a href="#h343-0-72" id="h343-0-72" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h344" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/CameraTweaks.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/CameraTweaks.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/CameraTweaks.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/CameraTweaks.kt</a></b>
<a href="#h344-0" id="h344-0" class="h">@@ -1,78 +0,0 @@
</a><a href="#h344-0-0" id="h344-0-0" class="d">-package me.rhunk.snapenhance.features.impl.tweaks
</a><a href="#h344-0-1" id="h344-0-1" class="d">-
</a><a href="#h344-0-2" id="h344-0-2" class="d">-import android.Manifest
</a><a href="#h344-0-3" id="h344-0-3" class="d">-import android.annotation.SuppressLint
</a><a href="#h344-0-4" id="h344-0-4" class="d">-import android.content.ContextWrapper
</a><a href="#h344-0-5" id="h344-0-5" class="d">-import android.content.pm.PackageManager
</a><a href="#h344-0-6" id="h344-0-6" class="d">-import android.hardware.camera2.CameraCharacteristics
</a><a href="#h344-0-7" id="h344-0-7" class="d">-import android.hardware.camera2.CameraCharacteristics.Key
</a><a href="#h344-0-8" id="h344-0-8" class="d">-import android.hardware.camera2.CameraManager
</a><a href="#h344-0-9" id="h344-0-9" class="d">-import android.util.Range
</a><a href="#h344-0-10" id="h344-0-10" class="d">-import me.rhunk.snapenhance.core.util.ktx.setObjectField
</a><a href="#h344-0-11" id="h344-0-11" class="d">-import me.rhunk.snapenhance.data.wrapper.impl.ScSize
</a><a href="#h344-0-12" id="h344-0-12" class="d">-import me.rhunk.snapenhance.features.Feature
</a><a href="#h344-0-13" id="h344-0-13" class="d">-import me.rhunk.snapenhance.features.FeatureLoadParams
</a><a href="#h344-0-14" id="h344-0-14" class="d">-import me.rhunk.snapenhance.hook.HookStage
</a><a href="#h344-0-15" id="h344-0-15" class="d">-import me.rhunk.snapenhance.hook.hook
</a><a href="#h344-0-16" id="h344-0-16" class="d">-import me.rhunk.snapenhance.hook.hookConstructor
</a><a href="#h344-0-17" id="h344-0-17" class="d">-
</a><a href="#h344-0-18" id="h344-0-18" class="d">-class CameraTweaks : Feature(&quot;Camera Tweaks&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_SYNC) {
</a><a href="#h344-0-19" id="h344-0-19" class="d">-    companion object {
</a><a href="#h344-0-20" id="h344-0-20" class="d">-        val resolutions = listOf(&quot;3264x2448&quot;, &quot;3264x1840&quot;, &quot;3264x1504&quot;, &quot;2688x1512&quot;, &quot;2560x1920&quot;, &quot;2448x2448&quot;, &quot;2340x1080&quot;, &quot;2160x1080&quot;, &quot;1920x1440&quot;, &quot;1920x1080&quot;, &quot;1600x1200&quot;, &quot;1600x960&quot;, &quot;1600x900&quot;, &quot;1600x736&quot;, &quot;1600x720&quot;, &quot;1560x720&quot;, &quot;1520x720&quot;, &quot;1440x1080&quot;, &quot;1440x720&quot;, &quot;1280x720&quot;, &quot;1080x1080&quot;, &quot;1080x720&quot;, &quot;960x720&quot;, &quot;720x720&quot;, &quot;720x480&quot;, &quot;640x480&quot;, &quot;352x288&quot;, &quot;320x240&quot;, &quot;176x144&quot;)
</a><a href="#h344-0-21" id="h344-0-21" class="d">-    }
</a><a href="#h344-0-22" id="h344-0-22" class="d">-
</a><a href="#h344-0-23" id="h344-0-23" class="d">-    private fun parseResolution(resolution: String): IntArray {
</a><a href="#h344-0-24" id="h344-0-24" class="d">-        return resolution.split(&quot;x&quot;).map { it.toInt() }.toIntArray()
</a><a href="#h344-0-25" id="h344-0-25" class="d">-    }
</a><a href="#h344-0-26" id="h344-0-26" class="d">-
</a><a href="#h344-0-27" id="h344-0-27" class="d">-    @SuppressLint(&quot;MissingPermission&quot;, &quot;DiscouragedApi&quot;)
</a><a href="#h344-0-28" id="h344-0-28" class="d">-    override fun onActivityCreate() {
</a><a href="#h344-0-29" id="h344-0-29" class="d">-        if (context.config.camera.disable.get()) {
</a><a href="#h344-0-30" id="h344-0-30" class="d">-            ContextWrapper::class.java.hook(&quot;checkPermission&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h344-0-31" id="h344-0-31" class="d">-                val permission = param.arg&lt;String&gt;(0)
</a><a href="#h344-0-32" id="h344-0-32" class="d">-                if (permission == Manifest.permission.CAMERA) {
</a><a href="#h344-0-33" id="h344-0-33" class="d">-                    param.setResult(PackageManager.PERMISSION_GRANTED)
</a><a href="#h344-0-34" id="h344-0-34" class="d">-                }
</a><a href="#h344-0-35" id="h344-0-35" class="d">-            }
</a><a href="#h344-0-36" id="h344-0-36" class="d">-
</a><a href="#h344-0-37" id="h344-0-37" class="d">-            CameraManager::class.java.hook(&quot;openCamera&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h344-0-38" id="h344-0-38" class="d">-                param.setResult(null)
</a><a href="#h344-0-39" id="h344-0-39" class="d">-            }
</a><a href="#h344-0-40" id="h344-0-40" class="d">-        }
</a><a href="#h344-0-41" id="h344-0-41" class="d">-
</a><a href="#h344-0-42" id="h344-0-42" class="d">-        val previewResolutionConfig = context.config.camera.overridePreviewResolution.getNullable()?.let { parseResolution(it) }
</a><a href="#h344-0-43" id="h344-0-43" class="d">-        val captureResolutionConfig = context.config.camera.overridePictureResolution.getNullable()?.let { parseResolution(it) }
</a><a href="#h344-0-44" id="h344-0-44" class="d">-
</a><a href="#h344-0-45" id="h344-0-45" class="d">-        context.config.camera.customFrameRate.getNullable()?.also { value -&gt;
</a><a href="#h344-0-46" id="h344-0-46" class="d">-            val customFrameRate = value.toInt()
</a><a href="#h344-0-47" id="h344-0-47" class="d">-            CameraCharacteristics::class.java.hook(&quot;get&quot;, HookStage.AFTER)  { param -&gt;
</a><a href="#h344-0-48" id="h344-0-48" class="d">-                val key = param.arg&lt;Key&lt;*&gt;&gt;(0)
</a><a href="#h344-0-49" id="h344-0-49" class="d">-                if (key == CameraCharacteristics.CONTROL_AE_AVAILABLE_TARGET_FPS_RANGES) {
</a><a href="#h344-0-50" id="h344-0-50" class="d">-                    val fpsRanges = param.getResult() as? Array&lt;*&gt; ?: return@hook
</a><a href="#h344-0-51" id="h344-0-51" class="d">-                    fpsRanges.forEach {
</a><a href="#h344-0-52" id="h344-0-52" class="d">-                        val range = it as? Range&lt;*&gt; ?: return@forEach
</a><a href="#h344-0-53" id="h344-0-53" class="d">-                        range.setObjectField(&quot;mUpper&quot;, customFrameRate)
</a><a href="#h344-0-54" id="h344-0-54" class="d">-                        range.setObjectField(&quot;mLower&quot;, customFrameRate)
</a><a href="#h344-0-55" id="h344-0-55" class="d">-                    }
</a><a href="#h344-0-56" id="h344-0-56" class="d">-                }
</a><a href="#h344-0-57" id="h344-0-57" class="d">-            }
</a><a href="#h344-0-58" id="h344-0-58" class="d">-        }
</a><a href="#h344-0-59" id="h344-0-59" class="d">-
</a><a href="#h344-0-60" id="h344-0-60" class="d">-        context.mappings.getMappedClass(&quot;ScCameraSettings&quot;).hookConstructor(HookStage.BEFORE) { param -&gt;
</a><a href="#h344-0-61" id="h344-0-61" class="d">-            val previewResolution = ScSize(param.argNullable(2))
</a><a href="#h344-0-62" id="h344-0-62" class="d">-            val captureResolution = ScSize(param.argNullable(3))
</a><a href="#h344-0-63" id="h344-0-63" class="d">-
</a><a href="#h344-0-64" id="h344-0-64" class="d">-            if (previewResolution.isPresent() &amp;&amp; captureResolution.isPresent()) {
</a><a href="#h344-0-65" id="h344-0-65" class="d">-                previewResolutionConfig?.let {
</a><a href="#h344-0-66" id="h344-0-66" class="d">-                    previewResolution.first = it[0]
</a><a href="#h344-0-67" id="h344-0-67" class="d">-                    previewResolution.second = it[1]
</a><a href="#h344-0-68" id="h344-0-68" class="d">-                }
</a><a href="#h344-0-69" id="h344-0-69" class="d">-
</a><a href="#h344-0-70" id="h344-0-70" class="d">-                captureResolutionConfig?.let {
</a><a href="#h344-0-71" id="h344-0-71" class="d">-                    captureResolution.first = it[0]
</a><a href="#h344-0-72" id="h344-0-72" class="d">-                    captureResolution.second = it[1]
</a><a href="#h344-0-73" id="h344-0-73" class="d">-                }
</a><a href="#h344-0-74" id="h344-0-74" class="d">-            }
</a><a href="#h344-0-75" id="h344-0-75" class="d">-        }
</a><a href="#h344-0-76" id="h344-0-76" class="d">-    }
</a><a href="#h344-0-77" id="h344-0-77" class="d">-}</a><a href="#h344-0-78" id="h344-0-78" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h345" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/DisableReplayInFF.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/DisableReplayInFF.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/DisableReplayInFF.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/DisableReplayInFF.kt</a></b>
<a href="#h345-0" id="h345-0" class="h">@@ -1,22 +0,0 @@
</a><a href="#h345-0-0" id="h345-0-0" class="d">-package me.rhunk.snapenhance.features.impl.tweaks
</a><a href="#h345-0-1" id="h345-0-1" class="d">-
</a><a href="#h345-0-2" id="h345-0-2" class="d">-import me.rhunk.snapenhance.core.util.ktx.getObjectField
</a><a href="#h345-0-3" id="h345-0-3" class="d">-import me.rhunk.snapenhance.core.util.ktx.setEnumField
</a><a href="#h345-0-4" id="h345-0-4" class="d">-import me.rhunk.snapenhance.features.Feature
</a><a href="#h345-0-5" id="h345-0-5" class="d">-import me.rhunk.snapenhance.features.FeatureLoadParams
</a><a href="#h345-0-6" id="h345-0-6" class="d">-import me.rhunk.snapenhance.hook.HookStage
</a><a href="#h345-0-7" id="h345-0-7" class="d">-import me.rhunk.snapenhance.hook.hookConstructor
</a><a href="#h345-0-8" id="h345-0-8" class="d">-
</a><a href="#h345-0-9" id="h345-0-9" class="d">-class DisableReplayInFF : Feature(&quot;DisableReplayInFF&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_ASYNC) {
</a><a href="#h345-0-10" id="h345-0-10" class="d">-    override fun asyncOnActivityCreate() {
</a><a href="#h345-0-11" id="h345-0-11" class="d">-        val state by context.config.messaging.disableReplayInFF
</a><a href="#h345-0-12" id="h345-0-12" class="d">-
</a><a href="#h345-0-13" id="h345-0-13" class="d">-        findClass(&quot;com.snapchat.client.messaging.InteractionInfo&quot;)
</a><a href="#h345-0-14" id="h345-0-14" class="d">-            .hookConstructor(HookStage.AFTER, { state }) { param -&gt;
</a><a href="#h345-0-15" id="h345-0-15" class="d">-            val instance = param.thisObject&lt;Any&gt;()
</a><a href="#h345-0-16" id="h345-0-16" class="d">-            if (instance.getObjectField(&quot;mLongPressActionState&quot;).toString() == &quot;REQUEST_SNAP_REPLAY&quot;) {
</a><a href="#h345-0-17" id="h345-0-17" class="d">-                instance.setEnumField(&quot;mLongPressActionState&quot;, &quot;SHOW_CONVERSATION_ACTION_MENU&quot;)
</a><a href="#h345-0-18" id="h345-0-18" class="d">-            }
</a><a href="#h345-0-19" id="h345-0-19" class="d">-        }
</a><a href="#h345-0-20" id="h345-0-20" class="d">-    }
</a><a href="#h345-0-21" id="h345-0-21" class="d">-}</a><a href="#h345-0-22" id="h345-0-22" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h346" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/GooglePlayServicesDialogs.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/GooglePlayServicesDialogs.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/GooglePlayServicesDialogs.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/GooglePlayServicesDialogs.kt</a></b>
<a href="#h346-0" id="h346-0" class="h">@@ -1,22 +0,0 @@
</a><a href="#h346-0-0" id="h346-0-0" class="d">-package me.rhunk.snapenhance.features.impl.tweaks
</a><a href="#h346-0-1" id="h346-0-1" class="d">-
</a><a href="#h346-0-2" id="h346-0-2" class="d">-import android.app.AlertDialog
</a><a href="#h346-0-3" id="h346-0-3" class="d">-import me.rhunk.snapenhance.features.Feature
</a><a href="#h346-0-4" id="h346-0-4" class="d">-import me.rhunk.snapenhance.features.FeatureLoadParams
</a><a href="#h346-0-5" id="h346-0-5" class="d">-import me.rhunk.snapenhance.hook.HookStage
</a><a href="#h346-0-6" id="h346-0-6" class="d">-import me.rhunk.snapenhance.hook.hook
</a><a href="#h346-0-7" id="h346-0-7" class="d">-import java.lang.reflect.Modifier
</a><a href="#h346-0-8" id="h346-0-8" class="d">-
</a><a href="#h346-0-9" id="h346-0-9" class="d">-class GooglePlayServicesDialogs : Feature(&quot;Disable GMS Dialogs&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_ASYNC) {
</a><a href="#h346-0-10" id="h346-0-10" class="d">-    override fun asyncOnActivityCreate() {
</a><a href="#h346-0-11" id="h346-0-11" class="d">-        if (!context.config.global.disableGooglePlayDialogs.get()) return
</a><a href="#h346-0-12" id="h346-0-12" class="d">-
</a><a href="#h346-0-13" id="h346-0-13" class="d">-        findClass(&quot;com.google.android.gms.common.GoogleApiAvailability&quot;).methods
</a><a href="#h346-0-14" id="h346-0-14" class="d">-            .first { Modifier.isStatic(it.modifiers) &amp;&amp; it.returnType == AlertDialog::class.java }.let { method -&gt;
</a><a href="#h346-0-15" id="h346-0-15" class="d">-            method.hook(HookStage.BEFORE) { param -&gt;
</a><a href="#h346-0-16" id="h346-0-16" class="d">-                context.log.verbose(&quot;GoogleApiAvailability.showErrorDialogFragment() called, returning null&quot;)
</a><a href="#h346-0-17" id="h346-0-17" class="d">-                param.setResult(null)
</a><a href="#h346-0-18" id="h346-0-18" class="d">-            }
</a><a href="#h346-0-19" id="h346-0-19" class="d">-        }
</a><a href="#h346-0-20" id="h346-0-20" class="d">-    }
</a><a href="#h346-0-21" id="h346-0-21" class="d">-}</a><a href="#h346-0-22" id="h346-0-22" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h347" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/LocationSpoofer.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/LocationSpoofer.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/LocationSpoofer.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/LocationSpoofer.kt</a></b>
<a href="#h347-0" id="h347-0" class="h">@@ -1,41 +0,0 @@
</a><a href="#h347-0-0" id="h347-0-0" class="d">-package me.rhunk.snapenhance.features.impl.tweaks
</a><a href="#h347-0-1" id="h347-0-1" class="d">-
</a><a href="#h347-0-2" id="h347-0-2" class="d">-import android.content.Intent
</a><a href="#h347-0-3" id="h347-0-3" class="d">-import me.rhunk.snapenhance.features.Feature
</a><a href="#h347-0-4" id="h347-0-4" class="d">-import me.rhunk.snapenhance.features.FeatureLoadParams
</a><a href="#h347-0-5" id="h347-0-5" class="d">-import me.rhunk.snapenhance.hook.HookStage
</a><a href="#h347-0-6" id="h347-0-6" class="d">-import me.rhunk.snapenhance.hook.Hooker
</a><a href="#h347-0-7" id="h347-0-7" class="d">-import me.rhunk.snapenhance.hook.hook
</a><a href="#h347-0-8" id="h347-0-8" class="d">-
</a><a href="#h347-0-9" id="h347-0-9" class="d">-class LocationSpoofer: Feature(&quot;LocationSpoof&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_ASYNC) {
</a><a href="#h347-0-10" id="h347-0-10" class="d">-    override fun asyncOnActivityCreate() {
</a><a href="#h347-0-11" id="h347-0-11" class="d">-        Hooker.hook(context.mainActivity!!.javaClass, &quot;onActivityResult&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h347-0-12" id="h347-0-12" class="d">-            val intent = param.argNullable&lt;Intent&gt;(2) ?: return@hook
</a><a href="#h347-0-13" id="h347-0-13" class="d">-            val bundle = intent.getBundleExtra(&quot;location&quot;) ?: return@hook
</a><a href="#h347-0-14" id="h347-0-14" class="d">-            param.setResult(null)
</a><a href="#h347-0-15" id="h347-0-15" class="d">-
</a><a href="#h347-0-16" id="h347-0-16" class="d">-            with(context.config.experimental.spoof.location) {
</a><a href="#h347-0-17" id="h347-0-17" class="d">-                latitude.set(bundle.getFloat(&quot;latitude&quot;))
</a><a href="#h347-0-18" id="h347-0-18" class="d">-                longitude.set(bundle.getFloat(&quot;longitude&quot;))
</a><a href="#h347-0-19" id="h347-0-19" class="d">-
</a><a href="#h347-0-20" id="h347-0-20" class="d">-                context.longToast(&quot;Location set to $latitude, $longitude&quot;)
</a><a href="#h347-0-21" id="h347-0-21" class="d">-            }
</a><a href="#h347-0-22" id="h347-0-22" class="d">-        }
</a><a href="#h347-0-23" id="h347-0-23" class="d">-
</a><a href="#h347-0-24" id="h347-0-24" class="d">-        if (context.config.experimental.spoof.location.globalState != true) return
</a><a href="#h347-0-25" id="h347-0-25" class="d">-
</a><a href="#h347-0-26" id="h347-0-26" class="d">-        val latitude by context.config.experimental.spoof.location.latitude
</a><a href="#h347-0-27" id="h347-0-27" class="d">-        val longitude by context.config.experimental.spoof.location.longitude
</a><a href="#h347-0-28" id="h347-0-28" class="d">-
</a><a href="#h347-0-29" id="h347-0-29" class="d">-        val locationClass = android.location.Location::class.java
</a><a href="#h347-0-30" id="h347-0-30" class="d">-        val locationManagerClass = android.location.LocationManager::class.java
</a><a href="#h347-0-31" id="h347-0-31" class="d">-
</a><a href="#h347-0-32" id="h347-0-32" class="d">-        locationClass.hook(&quot;getLatitude&quot;, HookStage.BEFORE) { it.setResult(latitude.toDouble()) }
</a><a href="#h347-0-33" id="h347-0-33" class="d">-        locationClass.hook(&quot;getLongitude&quot;, HookStage.BEFORE) { it.setResult(longitude.toDouble()) }
</a><a href="#h347-0-34" id="h347-0-34" class="d">-        locationClass.hook(&quot;getAccuracy&quot;, HookStage.BEFORE) { it.setResult(0.0F) }
</a><a href="#h347-0-35" id="h347-0-35" class="d">-
</a><a href="#h347-0-36" id="h347-0-36" class="d">-        //Might be redundant because it calls isProviderEnabledForUser which we also hook, meaning if isProviderEnabledForUser returns true this will also return true
</a><a href="#h347-0-37" id="h347-0-37" class="d">-        locationManagerClass.hook(&quot;isProviderEnabled&quot;, HookStage.BEFORE) { it.setResult(true) }
</a><a href="#h347-0-38" id="h347-0-38" class="d">-        locationManagerClass.hook(&quot;isProviderEnabledForUser&quot;, HookStage.BEFORE) { it.setResult(true) }
</a><a href="#h347-0-39" id="h347-0-39" class="d">-    }
</a><a href="#h347-0-40" id="h347-0-40" class="d">-}</a><a href="#h347-0-41" id="h347-0-41" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h348" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/MediaQualityLevelOverride.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/MediaQualityLevelOverride.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/MediaQualityLevelOverride.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/MediaQualityLevelOverride.kt</a></b>
<a href="#h348-0" id="h348-0" class="h">@@ -1,23 +0,0 @@
</a><a href="#h348-0-0" id="h348-0-0" class="d">-package me.rhunk.snapenhance.features.impl.tweaks
</a><a href="#h348-0-1" id="h348-0-1" class="d">-
</a><a href="#h348-0-2" id="h348-0-2" class="d">-import me.rhunk.snapenhance.features.Feature
</a><a href="#h348-0-3" id="h348-0-3" class="d">-import me.rhunk.snapenhance.features.FeatureLoadParams
</a><a href="#h348-0-4" id="h348-0-4" class="d">-import me.rhunk.snapenhance.hook.HookStage
</a><a href="#h348-0-5" id="h348-0-5" class="d">-import me.rhunk.snapenhance.hook.hook
</a><a href="#h348-0-6" id="h348-0-6" class="d">-
</a><a href="#h348-0-7" id="h348-0-7" class="d">-class MediaQualityLevelOverride : Feature(&quot;MediaQualityLevelOverride&quot;, loadParams = FeatureLoadParams.INIT_SYNC) {
</a><a href="#h348-0-8" id="h348-0-8" class="d">-    override fun init() {
</a><a href="#h348-0-9" id="h348-0-9" class="d">-        val enumQualityLevel = context.mappings.getMappedClass(&quot;EnumQualityLevel&quot;)
</a><a href="#h348-0-10" id="h348-0-10" class="d">-        val mediaQualityLevelProvider = context.mappings.getMappedMap(&quot;MediaQualityLevelProvider&quot;)
</a><a href="#h348-0-11" id="h348-0-11" class="d">-
</a><a href="#h348-0-12" id="h348-0-12" class="d">-        val forceMediaSourceQuality by context.config.global.forceMediaSourceQuality
</a><a href="#h348-0-13" id="h348-0-13" class="d">-
</a><a href="#h348-0-14" id="h348-0-14" class="d">-        context.androidContext.classLoader.loadClass(mediaQualityLevelProvider[&quot;class&quot;].toString()).hook(
</a><a href="#h348-0-15" id="h348-0-15" class="d">-            mediaQualityLevelProvider[&quot;method&quot;].toString(),
</a><a href="#h348-0-16" id="h348-0-16" class="d">-            HookStage.BEFORE,
</a><a href="#h348-0-17" id="h348-0-17" class="d">-            { forceMediaSourceQuality }
</a><a href="#h348-0-18" id="h348-0-18" class="d">-        ) { param -&gt;
</a><a href="#h348-0-19" id="h348-0-19" class="d">-            param.setResult(enumQualityLevel.enumConstants.firstOrNull { it.toString() == &quot;LEVEL_MAX&quot; } )
</a><a href="#h348-0-20" id="h348-0-20" class="d">-        }
</a><a href="#h348-0-21" id="h348-0-21" class="d">-    }
</a><a href="#h348-0-22" id="h348-0-22" class="d">-}</a><a href="#h348-0-23" id="h348-0-23" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h349" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/Notifications.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/Notifications.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/Notifications.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/Notifications.kt</a></b>
<a href="#h349-0" id="h349-0" class="h">@@ -1,372 +0,0 @@
</a><a href="#h349-0-0" id="h349-0-0" class="d">-package me.rhunk.snapenhance.features.impl.tweaks
</a><a href="#h349-0-1" id="h349-0-1" class="d">-
</a><a href="#h349-0-2" id="h349-0-2" class="d">-import android.app.Notification
</a><a href="#h349-0-3" id="h349-0-3" class="d">-import android.app.NotificationManager
</a><a href="#h349-0-4" id="h349-0-4" class="d">-import android.app.PendingIntent
</a><a href="#h349-0-5" id="h349-0-5" class="d">-import android.app.RemoteInput
</a><a href="#h349-0-6" id="h349-0-6" class="d">-import android.content.Context
</a><a href="#h349-0-7" id="h349-0-7" class="d">-import android.content.Intent
</a><a href="#h349-0-8" id="h349-0-8" class="d">-import android.graphics.Bitmap
</a><a href="#h349-0-9" id="h349-0-9" class="d">-import android.graphics.BitmapFactory
</a><a href="#h349-0-10" id="h349-0-10" class="d">-import android.os.Bundle
</a><a href="#h349-0-11" id="h349-0-11" class="d">-import android.os.UserHandle
</a><a href="#h349-0-12" id="h349-0-12" class="d">-import de.robv.android.xposed.XposedBridge
</a><a href="#h349-0-13" id="h349-0-13" class="d">-import de.robv.android.xposed.XposedHelpers
</a><a href="#h349-0-14" id="h349-0-14" class="d">-import me.rhunk.snapenhance.core.Logger
</a><a href="#h349-0-15" id="h349-0-15" class="d">-import me.rhunk.snapenhance.core.download.data.SplitMediaAssetType
</a><a href="#h349-0-16" id="h349-0-16" class="d">-import me.rhunk.snapenhance.core.event.events.impl.SnapWidgetBroadcastReceiveEvent
</a><a href="#h349-0-17" id="h349-0-17" class="d">-import me.rhunk.snapenhance.core.util.CallbackBuilder
</a><a href="#h349-0-18" id="h349-0-18" class="d">-import me.rhunk.snapenhance.core.util.download.RemoteMediaResolver
</a><a href="#h349-0-19" id="h349-0-19" class="d">-import me.rhunk.snapenhance.core.util.ktx.setObjectField
</a><a href="#h349-0-20" id="h349-0-20" class="d">-import me.rhunk.snapenhance.core.util.protobuf.ProtoReader
</a><a href="#h349-0-21" id="h349-0-21" class="d">-import me.rhunk.snapenhance.core.util.snap.MediaDownloaderHelper
</a><a href="#h349-0-22" id="h349-0-22" class="d">-import me.rhunk.snapenhance.core.util.snap.PreviewUtils
</a><a href="#h349-0-23" id="h349-0-23" class="d">-import me.rhunk.snapenhance.core.util.snap.SnapWidgetBroadcastReceiverHelper
</a><a href="#h349-0-24" id="h349-0-24" class="d">-import me.rhunk.snapenhance.data.ContentType
</a><a href="#h349-0-25" id="h349-0-25" class="d">-import me.rhunk.snapenhance.data.MediaReferenceType
</a><a href="#h349-0-26" id="h349-0-26" class="d">-import me.rhunk.snapenhance.data.wrapper.impl.Message
</a><a href="#h349-0-27" id="h349-0-27" class="d">-import me.rhunk.snapenhance.data.wrapper.impl.SnapUUID
</a><a href="#h349-0-28" id="h349-0-28" class="d">-import me.rhunk.snapenhance.features.Feature
</a><a href="#h349-0-29" id="h349-0-29" class="d">-import me.rhunk.snapenhance.features.FeatureLoadParams
</a><a href="#h349-0-30" id="h349-0-30" class="d">-import me.rhunk.snapenhance.features.impl.Messaging
</a><a href="#h349-0-31" id="h349-0-31" class="d">-import me.rhunk.snapenhance.features.impl.downloader.MediaDownloader
</a><a href="#h349-0-32" id="h349-0-32" class="d">-import me.rhunk.snapenhance.features.impl.downloader.decoder.MessageDecoder
</a><a href="#h349-0-33" id="h349-0-33" class="d">-import me.rhunk.snapenhance.hook.HookStage
</a><a href="#h349-0-34" id="h349-0-34" class="d">-import me.rhunk.snapenhance.hook.Hooker
</a><a href="#h349-0-35" id="h349-0-35" class="d">-import me.rhunk.snapenhance.hook.hook
</a><a href="#h349-0-36" id="h349-0-36" class="d">-import kotlin.io.encoding.ExperimentalEncodingApi
</a><a href="#h349-0-37" id="h349-0-37" class="d">-
</a><a href="#h349-0-38" id="h349-0-38" class="d">-class Notifications : Feature(&quot;Notifications&quot;, loadParams = FeatureLoadParams.INIT_SYNC) {
</a><a href="#h349-0-39" id="h349-0-39" class="d">-    companion object{
</a><a href="#h349-0-40" id="h349-0-40" class="d">-        const val ACTION_REPLY = &quot;me.rhunk.snapenhance.action.notification.REPLY&quot;
</a><a href="#h349-0-41" id="h349-0-41" class="d">-        const val ACTION_DOWNLOAD = &quot;me.rhunk.snapenhance.action.notification.DOWNLOAD&quot;
</a><a href="#h349-0-42" id="h349-0-42" class="d">-        const val SNAPCHAT_NOTIFICATION_GROUP = &quot;snapchat_notification_group&quot;
</a><a href="#h349-0-43" id="h349-0-43" class="d">-    }
</a><a href="#h349-0-44" id="h349-0-44" class="d">-
</a><a href="#h349-0-45" id="h349-0-45" class="d">-    private val notificationDataQueue = mutableMapOf&lt;Long, NotificationData&gt;() // messageId =&gt; notification
</a><a href="#h349-0-46" id="h349-0-46" class="d">-    private val cachedMessages = mutableMapOf&lt;String, MutableList&lt;String&gt;&gt;() // conversationId =&gt; cached messages
</a><a href="#h349-0-47" id="h349-0-47" class="d">-    private val notificationIdMap = mutableMapOf&lt;Int, String&gt;() // notificationId =&gt; conversationId
</a><a href="#h349-0-48" id="h349-0-48" class="d">-
</a><a href="#h349-0-49" id="h349-0-49" class="d">-    private val notifyAsUserMethod by lazy {
</a><a href="#h349-0-50" id="h349-0-50" class="d">-        XposedHelpers.findMethodExact(
</a><a href="#h349-0-51" id="h349-0-51" class="d">-            NotificationManager::class.java, &quot;notifyAsUser&quot;,
</a><a href="#h349-0-52" id="h349-0-52" class="d">-            String::class.java,
</a><a href="#h349-0-53" id="h349-0-53" class="d">-            Int::class.javaPrimitiveType,
</a><a href="#h349-0-54" id="h349-0-54" class="d">-            Notification::class.java,
</a><a href="#h349-0-55" id="h349-0-55" class="d">-            UserHandle::class.java
</a><a href="#h349-0-56" id="h349-0-56" class="d">-        )
</a><a href="#h349-0-57" id="h349-0-57" class="d">-    }
</a><a href="#h349-0-58" id="h349-0-58" class="d">-
</a><a href="#h349-0-59" id="h349-0-59" class="d">-    private val fetchConversationWithMessagesMethod by lazy {
</a><a href="#h349-0-60" id="h349-0-60" class="d">-        context.classCache.conversationManager.methods.first { it.name == &quot;fetchConversationWithMessages&quot;}
</a><a href="#h349-0-61" id="h349-0-61" class="d">-    }
</a><a href="#h349-0-62" id="h349-0-62" class="d">-
</a><a href="#h349-0-63" id="h349-0-63" class="d">-    private val notificationManager by lazy {
</a><a href="#h349-0-64" id="h349-0-64" class="d">-        context.androidContext.getSystemService(Context.NOTIFICATION_SERVICE) as NotificationManager
</a><a href="#h349-0-65" id="h349-0-65" class="d">-    }
</a><a href="#h349-0-66" id="h349-0-66" class="d">-
</a><a href="#h349-0-67" id="h349-0-67" class="d">-    private val betterNotificationFilter by lazy {
</a><a href="#h349-0-68" id="h349-0-68" class="d">-        context.config.messaging.betterNotifications.get()
</a><a href="#h349-0-69" id="h349-0-69" class="d">-    }
</a><a href="#h349-0-70" id="h349-0-70" class="d">-
</a><a href="#h349-0-71" id="h349-0-71" class="d">-    private fun setNotificationText(notification: Notification, conversationId: String) {
</a><a href="#h349-0-72" id="h349-0-72" class="d">-        val messageText = StringBuilder().apply {
</a><a href="#h349-0-73" id="h349-0-73" class="d">-            cachedMessages.computeIfAbsent(conversationId) { mutableListOf() }.forEach {
</a><a href="#h349-0-74" id="h349-0-74" class="d">-                if (isNotEmpty()) append(&quot;\n&quot;)
</a><a href="#h349-0-75" id="h349-0-75" class="d">-                append(it)
</a><a href="#h349-0-76" id="h349-0-76" class="d">-            }
</a><a href="#h349-0-77" id="h349-0-77" class="d">-        }.toString()
</a><a href="#h349-0-78" id="h349-0-78" class="d">-
</a><a href="#h349-0-79" id="h349-0-79" class="d">-        with(notification.extras) {
</a><a href="#h349-0-80" id="h349-0-80" class="d">-            putString(&quot;android.text&quot;, messageText)
</a><a href="#h349-0-81" id="h349-0-81" class="d">-            putString(&quot;android.bigText&quot;, messageText)
</a><a href="#h349-0-82" id="h349-0-82" class="d">-            putParcelableArray(&quot;android.messages&quot;, messageText.split(&quot;\n&quot;).map {
</a><a href="#h349-0-83" id="h349-0-83" class="d">-                Bundle().apply {
</a><a href="#h349-0-84" id="h349-0-84" class="d">-                    putBundle(&quot;extras&quot;, Bundle())
</a><a href="#h349-0-85" id="h349-0-85" class="d">-                    putString(&quot;text&quot;, it)
</a><a href="#h349-0-86" id="h349-0-86" class="d">-                    putLong(&quot;time&quot;, System.currentTimeMillis())
</a><a href="#h349-0-87" id="h349-0-87" class="d">-                }
</a><a href="#h349-0-88" id="h349-0-88" class="d">-            }.toTypedArray())
</a><a href="#h349-0-89" id="h349-0-89" class="d">-        }
</a><a href="#h349-0-90" id="h349-0-90" class="d">-    }
</a><a href="#h349-0-91" id="h349-0-91" class="d">-
</a><a href="#h349-0-92" id="h349-0-92" class="d">-    private fun setupNotificationActionButtons(contentType: ContentType, conversationId: String, messageId: Long, notificationData: NotificationData) {
</a><a href="#h349-0-93" id="h349-0-93" class="d">-
</a><a href="#h349-0-94" id="h349-0-94" class="d">-        val notificationBuilder = XposedHelpers.newInstance(
</a><a href="#h349-0-95" id="h349-0-95" class="d">-            Notification.Builder::class.java,
</a><a href="#h349-0-96" id="h349-0-96" class="d">-            context.androidContext,
</a><a href="#h349-0-97" id="h349-0-97" class="d">-            notificationData.notification
</a><a href="#h349-0-98" id="h349-0-98" class="d">-        ) as Notification.Builder
</a><a href="#h349-0-99" id="h349-0-99" class="d">-
</a><a href="#h349-0-100" id="h349-0-100" class="d">-        val actions = mutableListOf&lt;Notification.Action&gt;()
</a><a href="#h349-0-101" id="h349-0-101" class="d">-        actions.addAll(notificationData.notification.actions)
</a><a href="#h349-0-102" id="h349-0-102" class="d">-
</a><a href="#h349-0-103" id="h349-0-103" class="d">-        fun newAction(title: String, remoteAction: String, filter: (() -&gt; Boolean), builder: (Notification.Action.Builder) -&gt; Unit) {
</a><a href="#h349-0-104" id="h349-0-104" class="d">-            if (!filter()) return
</a><a href="#h349-0-105" id="h349-0-105" class="d">-
</a><a href="#h349-0-106" id="h349-0-106" class="d">-            val intent = SnapWidgetBroadcastReceiverHelper.create(remoteAction) {
</a><a href="#h349-0-107" id="h349-0-107" class="d">-                putExtra(&quot;conversation_id&quot;, conversationId)
</a><a href="#h349-0-108" id="h349-0-108" class="d">-                putExtra(&quot;notification_id&quot;, notificationData.id)
</a><a href="#h349-0-109" id="h349-0-109" class="d">-                putExtra(&quot;message_id&quot;, messageId)
</a><a href="#h349-0-110" id="h349-0-110" class="d">-            }
</a><a href="#h349-0-111" id="h349-0-111" class="d">-
</a><a href="#h349-0-112" id="h349-0-112" class="d">-            val action = Notification.Action.Builder(null, title, PendingIntent.getBroadcast(
</a><a href="#h349-0-113" id="h349-0-113" class="d">-                context.androidContext,
</a><a href="#h349-0-114" id="h349-0-114" class="d">-                System.nanoTime().toInt(),
</a><a href="#h349-0-115" id="h349-0-115" class="d">-                intent,
</a><a href="#h349-0-116" id="h349-0-116" class="d">-                PendingIntent.FLAG_MUTABLE
</a><a href="#h349-0-117" id="h349-0-117" class="d">-            )).apply(builder).build()
</a><a href="#h349-0-118" id="h349-0-118" class="d">-            actions.add(action)
</a><a href="#h349-0-119" id="h349-0-119" class="d">-        }
</a><a href="#h349-0-120" id="h349-0-120" class="d">-
</a><a href="#h349-0-121" id="h349-0-121" class="d">-        newAction(&quot;Reply&quot;, ACTION_REPLY, {
</a><a href="#h349-0-122" id="h349-0-122" class="d">-            betterNotificationFilter.contains(&quot;reply_button&quot;) &amp;&amp; contentType == ContentType.CHAT
</a><a href="#h349-0-123" id="h349-0-123" class="d">-        }) {
</a><a href="#h349-0-124" id="h349-0-124" class="d">-            val chatReplyInput = RemoteInput.Builder(&quot;chat_reply_input&quot;)
</a><a href="#h349-0-125" id="h349-0-125" class="d">-                .setLabel(&quot;Reply&quot;)
</a><a href="#h349-0-126" id="h349-0-126" class="d">-                .build()
</a><a href="#h349-0-127" id="h349-0-127" class="d">-            it.addRemoteInput(chatReplyInput)
</a><a href="#h349-0-128" id="h349-0-128" class="d">-        }
</a><a href="#h349-0-129" id="h349-0-129" class="d">-
</a><a href="#h349-0-130" id="h349-0-130" class="d">-        newAction(&quot;Download&quot;, ACTION_DOWNLOAD, {
</a><a href="#h349-0-131" id="h349-0-131" class="d">-            betterNotificationFilter.contains(&quot;download_button&quot;) &amp;&amp; (contentType == ContentType.EXTERNAL_MEDIA || contentType == ContentType.SNAP)
</a><a href="#h349-0-132" id="h349-0-132" class="d">-        }) {}
</a><a href="#h349-0-133" id="h349-0-133" class="d">-
</a><a href="#h349-0-134" id="h349-0-134" class="d">-        notificationBuilder.setActions(*actions.toTypedArray())
</a><a href="#h349-0-135" id="h349-0-135" class="d">-        notificationData.notification = notificationBuilder.build()
</a><a href="#h349-0-136" id="h349-0-136" class="d">-    }
</a><a href="#h349-0-137" id="h349-0-137" class="d">-
</a><a href="#h349-0-138" id="h349-0-138" class="d">-    private fun setupBroadcastReceiverHook() {
</a><a href="#h349-0-139" id="h349-0-139" class="d">-        context.event.subscribe(SnapWidgetBroadcastReceiveEvent::class) { event -&gt;
</a><a href="#h349-0-140" id="h349-0-140" class="d">-            val intent = event.intent ?: return@subscribe
</a><a href="#h349-0-141" id="h349-0-141" class="d">-            val conversationId = intent.getStringExtra(&quot;conversation_id&quot;) ?: return@subscribe
</a><a href="#h349-0-142" id="h349-0-142" class="d">-            val messageId = intent.getLongExtra(&quot;message_id&quot;, -1)
</a><a href="#h349-0-143" id="h349-0-143" class="d">-            val notificationId = intent.getIntExtra(&quot;notification_id&quot;, -1)
</a><a href="#h349-0-144" id="h349-0-144" class="d">-            val notificationManager = event.androidContext.getSystemService(Context.NOTIFICATION_SERVICE) as NotificationManager
</a><a href="#h349-0-145" id="h349-0-145" class="d">-
</a><a href="#h349-0-146" id="h349-0-146" class="d">-            val updateNotification: (Int, (Notification) -&gt; Unit) -&gt; Unit = { id, notificationBuilder -&gt;
</a><a href="#h349-0-147" id="h349-0-147" class="d">-                notificationManager.activeNotifications.firstOrNull { it.id == id }?.let {
</a><a href="#h349-0-148" id="h349-0-148" class="d">-                    notificationBuilder(it.notification)
</a><a href="#h349-0-149" id="h349-0-149" class="d">-                    XposedBridge.invokeOriginalMethod(notifyAsUserMethod, notificationManager, arrayOf(
</a><a href="#h349-0-150" id="h349-0-150" class="d">-                        it.tag, it.id, it.notification, it.user
</a><a href="#h349-0-151" id="h349-0-151" class="d">-                    ))
</a><a href="#h349-0-152" id="h349-0-152" class="d">-                }
</a><a href="#h349-0-153" id="h349-0-153" class="d">-            }
</a><a href="#h349-0-154" id="h349-0-154" class="d">-
</a><a href="#h349-0-155" id="h349-0-155" class="d">-            when (event.action) {
</a><a href="#h349-0-156" id="h349-0-156" class="d">-                ACTION_REPLY -&gt; {
</a><a href="#h349-0-157" id="h349-0-157" class="d">-                    val input = RemoteInput.getResultsFromIntent(intent).getCharSequence(&quot;chat_reply_input&quot;)
</a><a href="#h349-0-158" id="h349-0-158" class="d">-                        .toString()
</a><a href="#h349-0-159" id="h349-0-159" class="d">-
</a><a href="#h349-0-160" id="h349-0-160" class="d">-                    context.database.myUserId.let { context.database.getFriendInfo(it) }?.let { myUser -&gt;
</a><a href="#h349-0-161" id="h349-0-161" class="d">-                        cachedMessages.computeIfAbsent(conversationId) { mutableListOf() }.add(&quot;${myUser.displayName}: $input&quot;)
</a><a href="#h349-0-162" id="h349-0-162" class="d">-
</a><a href="#h349-0-163" id="h349-0-163" class="d">-                        updateNotification(notificationId) { notification -&gt;
</a><a href="#h349-0-164" id="h349-0-164" class="d">-                            notification.flags = notification.flags or Notification.FLAG_ONLY_ALERT_ONCE
</a><a href="#h349-0-165" id="h349-0-165" class="d">-                            setNotificationText(notification, conversationId)
</a><a href="#h349-0-166" id="h349-0-166" class="d">-                        }
</a><a href="#h349-0-167" id="h349-0-167" class="d">-
</a><a href="#h349-0-168" id="h349-0-168" class="d">-                        context.messageSender.sendChatMessage(listOf(SnapUUID.fromString(conversationId)), input, onError = {
</a><a href="#h349-0-169" id="h349-0-169" class="d">-                            context.longToast(&quot;Failed to send message: $it&quot;)
</a><a href="#h349-0-170" id="h349-0-170" class="d">-                        })
</a><a href="#h349-0-171" id="h349-0-171" class="d">-                    }
</a><a href="#h349-0-172" id="h349-0-172" class="d">-                }
</a><a href="#h349-0-173" id="h349-0-173" class="d">-                ACTION_DOWNLOAD -&gt; {
</a><a href="#h349-0-174" id="h349-0-174" class="d">-                    runCatching {
</a><a href="#h349-0-175" id="h349-0-175" class="d">-                        context.feature(MediaDownloader::class).downloadMessageId(messageId, isPreview = false)
</a><a href="#h349-0-176" id="h349-0-176" class="d">-                    }.onFailure {
</a><a href="#h349-0-177" id="h349-0-177" class="d">-                        context.longToast(it)
</a><a href="#h349-0-178" id="h349-0-178" class="d">-                    }
</a><a href="#h349-0-179" id="h349-0-179" class="d">-                }
</a><a href="#h349-0-180" id="h349-0-180" class="d">-                else -&gt; return@subscribe
</a><a href="#h349-0-181" id="h349-0-181" class="d">-            }
</a><a href="#h349-0-182" id="h349-0-182" class="d">-
</a><a href="#h349-0-183" id="h349-0-183" class="d">-            event.canceled = true
</a><a href="#h349-0-184" id="h349-0-184" class="d">-        }
</a><a href="#h349-0-185" id="h349-0-185" class="d">-    }
</a><a href="#h349-0-186" id="h349-0-186" class="d">-
</a><a href="#h349-0-187" id="h349-0-187" class="d">-    private fun fetchMessagesResult(conversationId: String, messages: List&lt;Message&gt;) {
</a><a href="#h349-0-188" id="h349-0-188" class="d">-        val sendNotificationData = { notificationData: NotificationData, forceCreate: Boolean  -&gt;
</a><a href="#h349-0-189" id="h349-0-189" class="d">-            val notificationId = if (forceCreate) System.nanoTime().toInt() else notificationData.id
</a><a href="#h349-0-190" id="h349-0-190" class="d">-            notificationIdMap.computeIfAbsent(notificationId) { conversationId }
</a><a href="#h349-0-191" id="h349-0-191" class="d">-            if (betterNotificationFilter.contains(&quot;group&quot;)) {
</a><a href="#h349-0-192" id="h349-0-192" class="d">-                runCatching {
</a><a href="#h349-0-193" id="h349-0-193" class="d">-                    notificationData.notification.setObjectField(&quot;mGroupKey&quot;, SNAPCHAT_NOTIFICATION_GROUP)
</a><a href="#h349-0-194" id="h349-0-194" class="d">-
</a><a href="#h349-0-195" id="h349-0-195" class="d">-                    val summaryNotification = Notification.Builder(context.androidContext, notificationData.notification.channelId)
</a><a href="#h349-0-196" id="h349-0-196" class="d">-                        .setSmallIcon(notificationData.notification.smallIcon)
</a><a href="#h349-0-197" id="h349-0-197" class="d">-                        .setGroup(SNAPCHAT_NOTIFICATION_GROUP)
</a><a href="#h349-0-198" id="h349-0-198" class="d">-                        .setGroupSummary(true)
</a><a href="#h349-0-199" id="h349-0-199" class="d">-                        .setAutoCancel(true)
</a><a href="#h349-0-200" id="h349-0-200" class="d">-                        .setOnlyAlertOnce(true)
</a><a href="#h349-0-201" id="h349-0-201" class="d">-                        .build()
</a><a href="#h349-0-202" id="h349-0-202" class="d">-
</a><a href="#h349-0-203" id="h349-0-203" class="d">-                    if (notificationManager.activeNotifications.firstOrNull { it.notification.flags and Notification.FLAG_GROUP_SUMMARY != 0 } == null) {
</a><a href="#h349-0-204" id="h349-0-204" class="d">-                        notificationManager.notify(notificationData.tag, notificationData.id, summaryNotification)
</a><a href="#h349-0-205" id="h349-0-205" class="d">-                    }
</a><a href="#h349-0-206" id="h349-0-206" class="d">-                }.onFailure {
</a><a href="#h349-0-207" id="h349-0-207" class="d">-                    context.log.warn(&quot;Failed to set notification group key: ${it.stackTraceToString()}&quot;, featureKey)
</a><a href="#h349-0-208" id="h349-0-208" class="d">-                }
</a><a href="#h349-0-209" id="h349-0-209" class="d">-            }
</a><a href="#h349-0-210" id="h349-0-210" class="d">-
</a><a href="#h349-0-211" id="h349-0-211" class="d">-            XposedBridge.invokeOriginalMethod(notifyAsUserMethod, notificationManager, arrayOf(
</a><a href="#h349-0-212" id="h349-0-212" class="d">-                notificationData.tag, if (forceCreate) System.nanoTime().toInt() else notificationData.id, notificationData.notification, notificationData.userHandle
</a><a href="#h349-0-213" id="h349-0-213" class="d">-            ))
</a><a href="#h349-0-214" id="h349-0-214" class="d">-        }
</a><a href="#h349-0-215" id="h349-0-215" class="d">-
</a><a href="#h349-0-216" id="h349-0-216" class="d">-        synchronized(notificationDataQueue) {
</a><a href="#h349-0-217" id="h349-0-217" class="d">-            notificationDataQueue.entries.onEach { (messageId, notificationData) -&gt;
</a><a href="#h349-0-218" id="h349-0-218" class="d">-                val snapMessage = messages.firstOrNull { message -&gt; message.orderKey == messageId } ?: return
</a><a href="#h349-0-219" id="h349-0-219" class="d">-                val senderUsername by lazy {
</a><a href="#h349-0-220" id="h349-0-220" class="d">-                    context.database.getFriendInfo(snapMessage.senderId.toString())?.let {
</a><a href="#h349-0-221" id="h349-0-221" class="d">-                        it.displayName ?: it.mutableUsername
</a><a href="#h349-0-222" id="h349-0-222" class="d">-                    }
</a><a href="#h349-0-223" id="h349-0-223" class="d">-                }
</a><a href="#h349-0-224" id="h349-0-224" class="d">-
</a><a href="#h349-0-225" id="h349-0-225" class="d">-                val contentType = snapMessage.messageContent.contentType ?: return@onEach
</a><a href="#h349-0-226" id="h349-0-226" class="d">-                val contentData = snapMessage.messageContent.content
</a><a href="#h349-0-227" id="h349-0-227" class="d">-
</a><a href="#h349-0-228" id="h349-0-228" class="d">-                val formatUsername: (String) -&gt; String = { &quot;$senderUsername: $it&quot; }
</a><a href="#h349-0-229" id="h349-0-229" class="d">-                val notificationCache = cachedMessages.let { it.computeIfAbsent(conversationId) { mutableListOf() } }
</a><a href="#h349-0-230" id="h349-0-230" class="d">-                val appendNotifications: () -&gt; Unit = { setNotificationText(notificationData.notification, conversationId)}
</a><a href="#h349-0-231" id="h349-0-231" class="d">-
</a><a href="#h349-0-232" id="h349-0-232" class="d">-                setupNotificationActionButtons(contentType, conversationId, snapMessage.messageDescriptor.messageId, notificationData)
</a><a href="#h349-0-233" id="h349-0-233" class="d">-
</a><a href="#h349-0-234" id="h349-0-234" class="d">-                when (contentType) {
</a><a href="#h349-0-235" id="h349-0-235" class="d">-                    ContentType.NOTE -&gt; {
</a><a href="#h349-0-236" id="h349-0-236" class="d">-                        notificationCache.add(formatUsername(&quot;sent audio note&quot;))
</a><a href="#h349-0-237" id="h349-0-237" class="d">-                        appendNotifications()
</a><a href="#h349-0-238" id="h349-0-238" class="d">-                    }
</a><a href="#h349-0-239" id="h349-0-239" class="d">-                    ContentType.CHAT -&gt; {
</a><a href="#h349-0-240" id="h349-0-240" class="d">-                        ProtoReader(contentData).getString(2, 1)?.trim()?.let {
</a><a href="#h349-0-241" id="h349-0-241" class="d">-                            notificationCache.add(formatUsername(it))
</a><a href="#h349-0-242" id="h349-0-242" class="d">-                        }
</a><a href="#h349-0-243" id="h349-0-243" class="d">-                        appendNotifications()
</a><a href="#h349-0-244" id="h349-0-244" class="d">-                    }
</a><a href="#h349-0-245" id="h349-0-245" class="d">-                    ContentType.SNAP, ContentType.EXTERNAL_MEDIA -&gt; {
</a><a href="#h349-0-246" id="h349-0-246" class="d">-                        val mediaReferences = MessageDecoder.getMediaReferences(
</a><a href="#h349-0-247" id="h349-0-247" class="d">-                            messageContent = context.gson.toJsonTree(snapMessage.messageContent.instanceNonNull())
</a><a href="#h349-0-248" id="h349-0-248" class="d">-                        )
</a><a href="#h349-0-249" id="h349-0-249" class="d">-
</a><a href="#h349-0-250" id="h349-0-250" class="d">-                        val mediaReferenceKeys = mediaReferences.map { reference -&gt;
</a><a href="#h349-0-251" id="h349-0-251" class="d">-                            reference.asJsonObject.getAsJsonArray(&quot;mContentObject&quot;).map { it.asByte }.toByteArray()
</a><a href="#h349-0-252" id="h349-0-252" class="d">-                        }
</a><a href="#h349-0-253" id="h349-0-253" class="d">-
</a><a href="#h349-0-254" id="h349-0-254" class="d">-                        MessageDecoder.decode(snapMessage.messageContent).firstOrNull()?.also { media -&gt;
</a><a href="#h349-0-255" id="h349-0-255" class="d">-                            val mediaType = MediaReferenceType.valueOf(mediaReferences.first().asJsonObject[&quot;mMediaType&quot;].asString)
</a><a href="#h349-0-256" id="h349-0-256" class="d">-
</a><a href="#h349-0-257" id="h349-0-257" class="d">-                            runCatching {
</a><a href="#h349-0-258" id="h349-0-258" class="d">-                                val downloadedMedia = RemoteMediaResolver.downloadBoltMedia(mediaReferenceKeys.first(), decryptionCallback =  {
</a><a href="#h349-0-259" id="h349-0-259" class="d">-                                    media.attachmentInfo?.encryption?.decryptInputStream(it) ?: it
</a><a href="#h349-0-260" id="h349-0-260" class="d">-                                }) ?: throw Throwable(&quot;Unable to download media&quot;)
</a><a href="#h349-0-261" id="h349-0-261" class="d">-
</a><a href="#h349-0-262" id="h349-0-262" class="d">-                                val downloadedMedias = mutableMapOf&lt;SplitMediaAssetType, ByteArray&gt;()
</a><a href="#h349-0-263" id="h349-0-263" class="d">-
</a><a href="#h349-0-264" id="h349-0-264" class="d">-                                MediaDownloaderHelper.getSplitElements(downloadedMedia.inputStream()) { type, inputStream -&gt;
</a><a href="#h349-0-265" id="h349-0-265" class="d">-                                    downloadedMedias[type] = inputStream.readBytes()
</a><a href="#h349-0-266" id="h349-0-266" class="d">-                                }
</a><a href="#h349-0-267" id="h349-0-267" class="d">-
</a><a href="#h349-0-268" id="h349-0-268" class="d">-                                var bitmapPreview = PreviewUtils.createPreview(downloadedMedias[SplitMediaAssetType.ORIGINAL]!!, mediaType.name.contains(&quot;VIDEO&quot;))!!
</a><a href="#h349-0-269" id="h349-0-269" class="d">-
</a><a href="#h349-0-270" id="h349-0-270" class="d">-                                downloadedMedias[SplitMediaAssetType.OVERLAY]?.let {
</a><a href="#h349-0-271" id="h349-0-271" class="d">-                                    bitmapPreview = PreviewUtils.mergeBitmapOverlay(bitmapPreview, BitmapFactory.decodeByteArray(it, 0, it.size))
</a><a href="#h349-0-272" id="h349-0-272" class="d">-                                }
</a><a href="#h349-0-273" id="h349-0-273" class="d">-
</a><a href="#h349-0-274" id="h349-0-274" class="d">-                                val notificationBuilder = XposedHelpers.newInstance(
</a><a href="#h349-0-275" id="h349-0-275" class="d">-                                    Notification.Builder::class.java,
</a><a href="#h349-0-276" id="h349-0-276" class="d">-                                    context.androidContext,
</a><a href="#h349-0-277" id="h349-0-277" class="d">-                                    notificationData.notification
</a><a href="#h349-0-278" id="h349-0-278" class="d">-                                ) as Notification.Builder
</a><a href="#h349-0-279" id="h349-0-279" class="d">-                                notificationBuilder.setLargeIcon(bitmapPreview)
</a><a href="#h349-0-280" id="h349-0-280" class="d">-                                notificationBuilder.style = Notification.BigPictureStyle().bigPicture(bitmapPreview).bigLargeIcon(null as Bitmap?)
</a><a href="#h349-0-281" id="h349-0-281" class="d">-
</a><a href="#h349-0-282" id="h349-0-282" class="d">-                                sendNotificationData(notificationData.copy(notification = notificationBuilder.build()), true)
</a><a href="#h349-0-283" id="h349-0-283" class="d">-                                return@onEach
</a><a href="#h349-0-284" id="h349-0-284" class="d">-                            }.onFailure {
</a><a href="#h349-0-285" id="h349-0-285" class="d">-                                Logger.xposedLog(&quot;Failed to send preview notification&quot;, it)
</a><a href="#h349-0-286" id="h349-0-286" class="d">-                            }
</a><a href="#h349-0-287" id="h349-0-287" class="d">-                        }
</a><a href="#h349-0-288" id="h349-0-288" class="d">-                    }
</a><a href="#h349-0-289" id="h349-0-289" class="d">-                    else -&gt; {
</a><a href="#h349-0-290" id="h349-0-290" class="d">-                        notificationCache.add(formatUsername(&quot;sent ${contentType.name.lowercase()}&quot;))
</a><a href="#h349-0-291" id="h349-0-291" class="d">-                        appendNotifications()
</a><a href="#h349-0-292" id="h349-0-292" class="d">-                    }
</a><a href="#h349-0-293" id="h349-0-293" class="d">-                }
</a><a href="#h349-0-294" id="h349-0-294" class="d">-
</a><a href="#h349-0-295" id="h349-0-295" class="d">-                sendNotificationData(notificationData, false)
</a><a href="#h349-0-296" id="h349-0-296" class="d">-            }.clear()
</a><a href="#h349-0-297" id="h349-0-297" class="d">-        }
</a><a href="#h349-0-298" id="h349-0-298" class="d">-    }
</a><a href="#h349-0-299" id="h349-0-299" class="d">-
</a><a href="#h349-0-300" id="h349-0-300" class="d">-    override fun init() {
</a><a href="#h349-0-301" id="h349-0-301" class="d">-        setupBroadcastReceiverHook()
</a><a href="#h349-0-302" id="h349-0-302" class="d">-
</a><a href="#h349-0-303" id="h349-0-303" class="d">-        val fetchConversationWithMessagesCallback = context.mappings.getMappedClass(&quot;callbacks&quot;, &quot;FetchConversationWithMessagesCallback&quot;)
</a><a href="#h349-0-304" id="h349-0-304" class="d">-
</a><a href="#h349-0-305" id="h349-0-305" class="d">-        Hooker.hook(notifyAsUserMethod, HookStage.BEFORE) { param -&gt;
</a><a href="#h349-0-306" id="h349-0-306" class="d">-            val notificationData = NotificationData(param.argNullable(0), param.arg(1), param.arg(2), param.arg(3))
</a><a href="#h349-0-307" id="h349-0-307" class="d">-
</a><a href="#h349-0-308" id="h349-0-308" class="d">-            val extras: Bundle = notificationData.notification.extras.getBundle(&quot;system_notification_extras&quot;)?: return@hook
</a><a href="#h349-0-309" id="h349-0-309" class="d">-
</a><a href="#h349-0-310" id="h349-0-310" class="d">-            val messageId = extras.getString(&quot;message_id&quot;) ?: return@hook
</a><a href="#h349-0-311" id="h349-0-311" class="d">-            val notificationType = extras.getString(&quot;notification_type&quot;) ?: return@hook
</a><a href="#h349-0-312" id="h349-0-312" class="d">-            val conversationId = extras.getString(&quot;conversation_id&quot;) ?: return@hook
</a><a href="#h349-0-313" id="h349-0-313" class="d">-
</a><a href="#h349-0-314" id="h349-0-314" class="d">-            if (betterNotificationFilter.map { it.uppercase() }.none {
</a><a href="#h349-0-315" id="h349-0-315" class="d">-                    notificationType.contains(it)
</a><a href="#h349-0-316" id="h349-0-316" class="d">-                }) return@hook
</a><a href="#h349-0-317" id="h349-0-317" class="d">-
</a><a href="#h349-0-318" id="h349-0-318" class="d">-            val conversationManager: Any = context.feature(Messaging::class).conversationManager
</a><a href="#h349-0-319" id="h349-0-319" class="d">-
</a><a href="#h349-0-320" id="h349-0-320" class="d">-            synchronized(notificationDataQueue) {
</a><a href="#h349-0-321" id="h349-0-321" class="d">-                notificationDataQueue[messageId.toLong()] = notificationData
</a><a href="#h349-0-322" id="h349-0-322" class="d">-            }
</a><a href="#h349-0-323" id="h349-0-323" class="d">-
</a><a href="#h349-0-324" id="h349-0-324" class="d">-            val callback = CallbackBuilder(fetchConversationWithMessagesCallback)
</a><a href="#h349-0-325" id="h349-0-325" class="d">-                .override(&quot;onFetchConversationWithMessagesComplete&quot;) { callbackParam -&gt;
</a><a href="#h349-0-326" id="h349-0-326" class="d">-                    val messageList = (callbackParam.arg(1) as List&lt;Any&gt;).map { msg -&gt; Message(msg) }
</a><a href="#h349-0-327" id="h349-0-327" class="d">-                    fetchMessagesResult(conversationId, messageList)
</a><a href="#h349-0-328" id="h349-0-328" class="d">-                }
</a><a href="#h349-0-329" id="h349-0-329" class="d">-                .override(&quot;onError&quot;) {
</a><a href="#h349-0-330" id="h349-0-330" class="d">-                    context.log.error(&quot;Failed to fetch message ${it.arg(0) as Any}&quot;)
</a><a href="#h349-0-331" id="h349-0-331" class="d">-                }.build()
</a><a href="#h349-0-332" id="h349-0-332" class="d">-
</a><a href="#h349-0-333" id="h349-0-333" class="d">-            fetchConversationWithMessagesMethod.invoke(conversationManager, SnapUUID.fromString(conversationId).instanceNonNull(), callback)
</a><a href="#h349-0-334" id="h349-0-334" class="d">-            param.setResult(null)
</a><a href="#h349-0-335" id="h349-0-335" class="d">-        }
</a><a href="#h349-0-336" id="h349-0-336" class="d">-
</a><a href="#h349-0-337" id="h349-0-337" class="d">-        XposedHelpers.findMethodExact(
</a><a href="#h349-0-338" id="h349-0-338" class="d">-            NotificationManager::class.java,
</a><a href="#h349-0-339" id="h349-0-339" class="d">-            &quot;cancelAsUser&quot;, String::class.java,
</a><a href="#h349-0-340" id="h349-0-340" class="d">-            Int::class.javaPrimitiveType,
</a><a href="#h349-0-341" id="h349-0-341" class="d">-            UserHandle::class.java
</a><a href="#h349-0-342" id="h349-0-342" class="d">-        ).hook(HookStage.BEFORE) { param -&gt;
</a><a href="#h349-0-343" id="h349-0-343" class="d">-            val notificationId = param.arg&lt;Int&gt;(1)
</a><a href="#h349-0-344" id="h349-0-344" class="d">-            notificationIdMap[notificationId]?.let {
</a><a href="#h349-0-345" id="h349-0-345" class="d">-                cachedMessages[it]?.clear()
</a><a href="#h349-0-346" id="h349-0-346" class="d">-            }
</a><a href="#h349-0-347" id="h349-0-347" class="d">-        }
</a><a href="#h349-0-348" id="h349-0-348" class="d">-
</a><a href="#h349-0-349" id="h349-0-349" class="d">-        findClass(&quot;com.google.firebase.messaging.FirebaseMessagingService&quot;).run {
</a><a href="#h349-0-350" id="h349-0-350" class="d">-            val states by context.config.messaging.notificationBlacklist
</a><a href="#h349-0-351" id="h349-0-351" class="d">-            methods.first { it.declaringClass == this &amp;&amp; it.returnType == Void::class.javaPrimitiveType &amp;&amp; it.parameterCount == 1 &amp;&amp; it.parameterTypes[0] == Intent::class.java }
</a><a href="#h349-0-352" id="h349-0-352" class="d">-                .hook(HookStage.BEFORE) { param -&gt;
</a><a href="#h349-0-353" id="h349-0-353" class="d">-                    val intent = param.argNullable&lt;Intent&gt;(0) ?: return@hook
</a><a href="#h349-0-354" id="h349-0-354" class="d">-                    val messageType = intent.getStringExtra(&quot;type&quot;) ?: return@hook
</a><a href="#h349-0-355" id="h349-0-355" class="d">-
</a><a href="#h349-0-356" id="h349-0-356" class="d">-                    context.log.debug(&quot;received message type: $messageType&quot;)
</a><a href="#h349-0-357" id="h349-0-357" class="d">-
</a><a href="#h349-0-358" id="h349-0-358" class="d">-                    if (states.contains(messageType.replaceFirst(&quot;mischief_&quot;, &quot;&quot;))) {
</a><a href="#h349-0-359" id="h349-0-359" class="d">-                        param.setResult(null)
</a><a href="#h349-0-360" id="h349-0-360" class="d">-                    }
</a><a href="#h349-0-361" id="h349-0-361" class="d">-                }
</a><a href="#h349-0-362" id="h349-0-362" class="d">-        }
</a><a href="#h349-0-363" id="h349-0-363" class="d">-    }
</a><a href="#h349-0-364" id="h349-0-364" class="d">-
</a><a href="#h349-0-365" id="h349-0-365" class="d">-    data class NotificationData(
</a><a href="#h349-0-366" id="h349-0-366" class="d">-        val tag: String?,
</a><a href="#h349-0-367" id="h349-0-367" class="d">-        val id: Int,
</a><a href="#h349-0-368" id="h349-0-368" class="d">-        var notification: Notification,
</a><a href="#h349-0-369" id="h349-0-369" class="d">-        val userHandle: UserHandle
</a><a href="#h349-0-370" id="h349-0-370" class="d">-    )
</a><a href="#h349-0-371" id="h349-0-371" class="d">-}</a><a href="#h349-0-372" id="h349-0-372" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h350" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/OldBitmojiSelfie.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/OldBitmojiSelfie.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/OldBitmojiSelfie.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/OldBitmojiSelfie.kt</a></b>
<a href="#h350-0" id="h350-0" class="h">@@ -1,22 +0,0 @@
</a><a href="#h350-0-0" id="h350-0-0" class="d">-package me.rhunk.snapenhance.features.impl.tweaks
</a><a href="#h350-0-1" id="h350-0-1" class="d">-
</a><a href="#h350-0-2" id="h350-0-2" class="d">-import me.rhunk.snapenhance.core.event.events.impl.NetworkApiRequestEvent
</a><a href="#h350-0-3" id="h350-0-3" class="d">-import me.rhunk.snapenhance.core.util.snap.BitmojiSelfie
</a><a href="#h350-0-4" id="h350-0-4" class="d">-import me.rhunk.snapenhance.features.Feature
</a><a href="#h350-0-5" id="h350-0-5" class="d">-import me.rhunk.snapenhance.features.FeatureLoadParams
</a><a href="#h350-0-6" id="h350-0-6" class="d">-
</a><a href="#h350-0-7" id="h350-0-7" class="d">-class OldBitmojiSelfie : Feature(&quot;OldBitmojiSelfie&quot;, loadParams = FeatureLoadParams.INIT_SYNC) {
</a><a href="#h350-0-8" id="h350-0-8" class="d">-    override fun init() {
</a><a href="#h350-0-9" id="h350-0-9" class="d">-        val urlPrefixes = arrayOf(&quot;https://images.bitmoji.com/3d/render/&quot;, &quot;https://cf-st.sc-cdn.net/3d/render/&quot;)
</a><a href="#h350-0-10" id="h350-0-10" class="d">-        val state by context.config.userInterface.ddBitmojiSelfie
</a><a href="#h350-0-11" id="h350-0-11" class="d">-
</a><a href="#h350-0-12" id="h350-0-12" class="d">-        context.event.subscribe(NetworkApiRequestEvent::class, { state }) { event -&gt;
</a><a href="#h350-0-13" id="h350-0-13" class="d">-            if (urlPrefixes.firstOrNull { event.url.startsWith(it) } == null) return@subscribe
</a><a href="#h350-0-14" id="h350-0-14" class="d">-            val bitmojiURI = event.url.substringAfterLast(&quot;/&quot;)
</a><a href="#h350-0-15" id="h350-0-15" class="d">-            event.url =
</a><a href="#h350-0-16" id="h350-0-16" class="d">-                BitmojiSelfie.BitmojiSelfieType.STANDARD.prefixUrl +
</a><a href="#h350-0-17" id="h350-0-17" class="d">-                bitmojiURI +
</a><a href="#h350-0-18" id="h350-0-18" class="d">-                (bitmojiURI.takeIf { !it.contains(&quot;?&quot;) }?.let { &quot;?&quot; } ?: &quot;&amp;&quot;) + &quot;transparent=1&quot;
</a><a href="#h350-0-19" id="h350-0-19" class="d">-        }
</a><a href="#h350-0-20" id="h350-0-20" class="d">-    }
</a><a href="#h350-0-21" id="h350-0-21" class="d">-}</a><a href="#h350-0-22" id="h350-0-22" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h351" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/SendOverride.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/SendOverride.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/SendOverride.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/SendOverride.kt</a></b>
<a href="#h351-0" id="h351-0" class="h">@@ -1,116 +0,0 @@
</a><a href="#h351-0-0" id="h351-0-0" class="d">-package me.rhunk.snapenhance.features.impl.tweaks
</a><a href="#h351-0-1" id="h351-0-1" class="d">-
</a><a href="#h351-0-2" id="h351-0-2" class="d">-import me.rhunk.snapenhance.Constants
</a><a href="#h351-0-3" id="h351-0-3" class="d">-import me.rhunk.snapenhance.core.event.events.impl.SendMessageWithContentEvent
</a><a href="#h351-0-4" id="h351-0-4" class="d">-import me.rhunk.snapenhance.core.event.events.impl.UnaryCallEvent
</a><a href="#h351-0-5" id="h351-0-5" class="d">-import me.rhunk.snapenhance.core.util.protobuf.ProtoEditor
</a><a href="#h351-0-6" id="h351-0-6" class="d">-import me.rhunk.snapenhance.core.util.protobuf.ProtoReader
</a><a href="#h351-0-7" id="h351-0-7" class="d">-import me.rhunk.snapenhance.data.ContentType
</a><a href="#h351-0-8" id="h351-0-8" class="d">-import me.rhunk.snapenhance.data.MessageSender
</a><a href="#h351-0-9" id="h351-0-9" class="d">-import me.rhunk.snapenhance.features.Feature
</a><a href="#h351-0-10" id="h351-0-10" class="d">-import me.rhunk.snapenhance.features.FeatureLoadParams
</a><a href="#h351-0-11" id="h351-0-11" class="d">-import me.rhunk.snapenhance.ui.ViewAppearanceHelper
</a><a href="#h351-0-12" id="h351-0-12" class="d">-
</a><a href="#h351-0-13" id="h351-0-13" class="d">-class SendOverride : Feature(&quot;Send Override&quot;, loadParams = FeatureLoadParams.INIT_SYNC) {
</a><a href="#h351-0-14" id="h351-0-14" class="d">-    private var isLastSnapSavable = false
</a><a href="#h351-0-15" id="h351-0-15" class="d">-
</a><a href="#h351-0-16" id="h351-0-16" class="d">-    override fun init() {
</a><a href="#h351-0-17" id="h351-0-17" class="d">-        val fixGalleryMediaSendOverride = context.config.experimental.nativeHooks.let {
</a><a href="#h351-0-18" id="h351-0-18" class="d">-            it.globalState == true &amp;&amp; it.fixGalleryMediaOverride.get()
</a><a href="#h351-0-19" id="h351-0-19" class="d">-        }
</a><a href="#h351-0-20" id="h351-0-20" class="d">-        val typeNames = mutableListOf(
</a><a href="#h351-0-21" id="h351-0-21" class="d">-            &quot;ORIGINAL&quot;,
</a><a href="#h351-0-22" id="h351-0-22" class="d">-            &quot;SNAP&quot;,
</a><a href="#h351-0-23" id="h351-0-23" class="d">-            &quot;NOTE&quot;
</a><a href="#h351-0-24" id="h351-0-24" class="d">-        ).also {
</a><a href="#h351-0-25" id="h351-0-25" class="d">-            if (fixGalleryMediaSendOverride) {
</a><a href="#h351-0-26" id="h351-0-26" class="d">-                it.add(&quot;SAVABLE_SNAP&quot;)
</a><a href="#h351-0-27" id="h351-0-27" class="d">-            }
</a><a href="#h351-0-28" id="h351-0-28" class="d">-        }.associateWith {
</a><a href="#h351-0-29" id="h351-0-29" class="d">-           it
</a><a href="#h351-0-30" id="h351-0-30" class="d">-        }
</a><a href="#h351-0-31" id="h351-0-31" class="d">-
</a><a href="#h351-0-32" id="h351-0-32" class="d">-        context.event.subscribe(UnaryCallEvent::class, { fixGalleryMediaSendOverride }) { event -&gt;
</a><a href="#h351-0-33" id="h351-0-33" class="d">-            if (event.uri != &quot;/messagingcoreservice.MessagingCoreService/CreateContentMessage&quot;) return@subscribe
</a><a href="#h351-0-34" id="h351-0-34" class="d">-            if (!isLastSnapSavable) return@subscribe
</a><a href="#h351-0-35" id="h351-0-35" class="d">-            ProtoReader(event.buffer).also {
</a><a href="#h351-0-36" id="h351-0-36" class="d">-                // only affect snaps
</a><a href="#h351-0-37" id="h351-0-37" class="d">-                if (!it.containsPath(*Constants.ARROYO_MEDIA_CONTAINER_PROTO_PATH, 11)) return@subscribe
</a><a href="#h351-0-38" id="h351-0-38" class="d">-            }
</a><a href="#h351-0-39" id="h351-0-39" class="d">-
</a><a href="#h351-0-40" id="h351-0-40" class="d">-            event.buffer = ProtoEditor(event.buffer).apply {
</a><a href="#h351-0-41" id="h351-0-41" class="d">-                //remove the max view time
</a><a href="#h351-0-42" id="h351-0-42" class="d">-                edit(*Constants.ARROYO_MEDIA_CONTAINER_PROTO_PATH, 11, 5, 2) {
</a><a href="#h351-0-43" id="h351-0-43" class="d">-                    remove(8)
</a><a href="#h351-0-44" id="h351-0-44" class="d">-                    addBuffer(6, byteArrayOf())
</a><a href="#h351-0-45" id="h351-0-45" class="d">-                }
</a><a href="#h351-0-46" id="h351-0-46" class="d">-                //make snaps savable in chat
</a><a href="#h351-0-47" id="h351-0-47" class="d">-                edit(4) {
</a><a href="#h351-0-48" id="h351-0-48" class="d">-                    val savableState = firstOrNull(7)?.value ?: return@edit
</a><a href="#h351-0-49" id="h351-0-49" class="d">-                    if (savableState == 2L) {
</a><a href="#h351-0-50" id="h351-0-50" class="d">-                        remove(7)
</a><a href="#h351-0-51" id="h351-0-51" class="d">-                        addVarInt(7, 3)
</a><a href="#h351-0-52" id="h351-0-52" class="d">-                    }
</a><a href="#h351-0-53" id="h351-0-53" class="d">-                }
</a><a href="#h351-0-54" id="h351-0-54" class="d">-            }.toByteArray()
</a><a href="#h351-0-55" id="h351-0-55" class="d">-        }
</a><a href="#h351-0-56" id="h351-0-56" class="d">-
</a><a href="#h351-0-57" id="h351-0-57" class="d">-        context.event.subscribe(SendMessageWithContentEvent::class, {
</a><a href="#h351-0-58" id="h351-0-58" class="d">-            context.config.messaging.galleryMediaSendOverride.get()
</a><a href="#h351-0-59" id="h351-0-59" class="d">-        }) { event -&gt;
</a><a href="#h351-0-60" id="h351-0-60" class="d">-            isLastSnapSavable = false
</a><a href="#h351-0-61" id="h351-0-61" class="d">-            val localMessageContent = event.messageContent
</a><a href="#h351-0-62" id="h351-0-62" class="d">-            if (localMessageContent.contentType != ContentType.EXTERNAL_MEDIA) return@subscribe
</a><a href="#h351-0-63" id="h351-0-63" class="d">-
</a><a href="#h351-0-64" id="h351-0-64" class="d">-            //prevent story replies
</a><a href="#h351-0-65" id="h351-0-65" class="d">-            val messageProtoReader = ProtoReader(localMessageContent.content)
</a><a href="#h351-0-66" id="h351-0-66" class="d">-            if (messageProtoReader.contains(7)) return@subscribe
</a><a href="#h351-0-67" id="h351-0-67" class="d">-
</a><a href="#h351-0-68" id="h351-0-68" class="d">-            event.canceled = true
</a><a href="#h351-0-69" id="h351-0-69" class="d">-
</a><a href="#h351-0-70" id="h351-0-70" class="d">-            context.runOnUiThread {
</a><a href="#h351-0-71" id="h351-0-71" class="d">-                ViewAppearanceHelper.newAlertDialogBuilder(context.mainActivity!!)
</a><a href="#h351-0-72" id="h351-0-72" class="d">-                    .setItems(typeNames.values.map {
</a><a href="#h351-0-73" id="h351-0-73" class="d">-                        context.translation[&quot;features.options.gallery_media_send_override.$it&quot;]
</a><a href="#h351-0-74" id="h351-0-74" class="d">-                    }.toTypedArray()) { dialog, which -&gt;
</a><a href="#h351-0-75" id="h351-0-75" class="d">-                        dialog.dismiss()
</a><a href="#h351-0-76" id="h351-0-76" class="d">-                        val overrideType = typeNames.keys.toTypedArray()[which]
</a><a href="#h351-0-77" id="h351-0-77" class="d">-
</a><a href="#h351-0-78" id="h351-0-78" class="d">-                        if (overrideType != &quot;ORIGINAL&quot; &amp;&amp; messageProtoReader.followPath(3)?.getCount(3) != 1) {
</a><a href="#h351-0-79" id="h351-0-79" class="d">-                            context.runOnUiThread {
</a><a href="#h351-0-80" id="h351-0-80" class="d">-                                ViewAppearanceHelper.newAlertDialogBuilder(context.mainActivity!!)
</a><a href="#h351-0-81" id="h351-0-81" class="d">-                                    .setMessage(context.translation[&quot;gallery_media_send_override.multiple_media_toast&quot;])
</a><a href="#h351-0-82" id="h351-0-82" class="d">-                                    .setPositiveButton(context.translation[&quot;button.ok&quot;], null)
</a><a href="#h351-0-83" id="h351-0-83" class="d">-                                    .show()
</a><a href="#h351-0-84" id="h351-0-84" class="d">-                            }
</a><a href="#h351-0-85" id="h351-0-85" class="d">-                            return@setItems
</a><a href="#h351-0-86" id="h351-0-86" class="d">-                        }
</a><a href="#h351-0-87" id="h351-0-87" class="d">-
</a><a href="#h351-0-88" id="h351-0-88" class="d">-                        when (overrideType) {
</a><a href="#h351-0-89" id="h351-0-89" class="d">-                            &quot;SNAP&quot;, &quot;SAVABLE_SNAP&quot; -&gt; {
</a><a href="#h351-0-90" id="h351-0-90" class="d">-                                val extras = messageProtoReader.followPath(3, 3, 13)?.getBuffer()
</a><a href="#h351-0-91" id="h351-0-91" class="d">-
</a><a href="#h351-0-92" id="h351-0-92" class="d">-                                localMessageContent.contentType = ContentType.SNAP
</a><a href="#h351-0-93" id="h351-0-93" class="d">-                                localMessageContent.content = MessageSender.redSnapProto(extras)
</a><a href="#h351-0-94" id="h351-0-94" class="d">-                                if (overrideType == &quot;SAVABLE_SNAP&quot;) {
</a><a href="#h351-0-95" id="h351-0-95" class="d">-                                    isLastSnapSavable = true
</a><a href="#h351-0-96" id="h351-0-96" class="d">-                                }
</a><a href="#h351-0-97" id="h351-0-97" class="d">-                            }
</a><a href="#h351-0-98" id="h351-0-98" class="d">-
</a><a href="#h351-0-99" id="h351-0-99" class="d">-                            &quot;NOTE&quot; -&gt; {
</a><a href="#h351-0-100" id="h351-0-100" class="d">-                                localMessageContent.contentType = ContentType.NOTE
</a><a href="#h351-0-101" id="h351-0-101" class="d">-                                val mediaDuration =
</a><a href="#h351-0-102" id="h351-0-102" class="d">-                                    messageProtoReader.getVarInt(3, 3, 5, 1, 1, 15) ?: 0
</a><a href="#h351-0-103" id="h351-0-103" class="d">-                                localMessageContent.content =
</a><a href="#h351-0-104" id="h351-0-104" class="d">-                                    MessageSender.audioNoteProto(mediaDuration)
</a><a href="#h351-0-105" id="h351-0-105" class="d">-                            }
</a><a href="#h351-0-106" id="h351-0-106" class="d">-                        }
</a><a href="#h351-0-107" id="h351-0-107" class="d">-
</a><a href="#h351-0-108" id="h351-0-108" class="d">-                        event.invokeOriginal()
</a><a href="#h351-0-109" id="h351-0-109" class="d">-                    }
</a><a href="#h351-0-110" id="h351-0-110" class="d">-                    .setNegativeButton(context.translation[&quot;button.cancel&quot;], null)
</a><a href="#h351-0-111" id="h351-0-111" class="d">-                    .show()
</a><a href="#h351-0-112" id="h351-0-112" class="d">-            }
</a><a href="#h351-0-113" id="h351-0-113" class="d">-        }
</a><a href="#h351-0-114" id="h351-0-114" class="d">-    }
</a><a href="#h351-0-115" id="h351-0-115" class="d">-}</a><a href="#h351-0-116" id="h351-0-116" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h352" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/SnapchatPlus.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/SnapchatPlus.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/SnapchatPlus.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/SnapchatPlus.kt</a></b>
<a href="#h352-0" id="h352-0" class="h">@@ -1,45 +0,0 @@
</a><a href="#h352-0-0" id="h352-0-0" class="d">-package me.rhunk.snapenhance.features.impl.tweaks
</a><a href="#h352-0-1" id="h352-0-1" class="d">-
</a><a href="#h352-0-2" id="h352-0-2" class="d">-import me.rhunk.snapenhance.features.Feature
</a><a href="#h352-0-3" id="h352-0-3" class="d">-import me.rhunk.snapenhance.features.FeatureLoadParams
</a><a href="#h352-0-4" id="h352-0-4" class="d">-import me.rhunk.snapenhance.hook.HookStage
</a><a href="#h352-0-5" id="h352-0-5" class="d">-import me.rhunk.snapenhance.hook.Hooker
</a><a href="#h352-0-6" id="h352-0-6" class="d">-import me.rhunk.snapenhance.hook.hook
</a><a href="#h352-0-7" id="h352-0-7" class="d">-
</a><a href="#h352-0-8" id="h352-0-8" class="d">-class SnapchatPlus: Feature(&quot;SnapchatPlus&quot;, loadParams = FeatureLoadParams.INIT_SYNC) {
</a><a href="#h352-0-9" id="h352-0-9" class="d">-    private val originalSubscriptionTime = (System.currentTimeMillis() - 7776000000L)
</a><a href="#h352-0-10" id="h352-0-10" class="d">-    private val expirationTimeMillis = (System.currentTimeMillis() + 15552000000L)
</a><a href="#h352-0-11" id="h352-0-11" class="d">-
</a><a href="#h352-0-12" id="h352-0-12" class="d">-    override fun init() {
</a><a href="#h352-0-13" id="h352-0-13" class="d">-        if (!context.config.global.snapchatPlus.get()) return
</a><a href="#h352-0-14" id="h352-0-14" class="d">-
</a><a href="#h352-0-15" id="h352-0-15" class="d">-        val subscriptionInfoClass = context.mappings.getMappedClass(&quot;SubscriptionInfoClass&quot;)
</a><a href="#h352-0-16" id="h352-0-16" class="d">-
</a><a href="#h352-0-17" id="h352-0-17" class="d">-        Hooker.hookConstructor(subscriptionInfoClass, HookStage.BEFORE) { param -&gt;
</a><a href="#h352-0-18" id="h352-0-18" class="d">-            if (param.arg&lt;Int&gt;(0) == 2) return@hookConstructor
</a><a href="#h352-0-19" id="h352-0-19" class="d">-            //subscription tier
</a><a href="#h352-0-20" id="h352-0-20" class="d">-            param.setArg(0, 2)
</a><a href="#h352-0-21" id="h352-0-21" class="d">-            //subscription status
</a><a href="#h352-0-22" id="h352-0-22" class="d">-            param.setArg(1, 2)
</a><a href="#h352-0-23" id="h352-0-23" class="d">-
</a><a href="#h352-0-24" id="h352-0-24" class="d">-            param.setArg(2, originalSubscriptionTime)
</a><a href="#h352-0-25" id="h352-0-25" class="d">-            param.setArg(3, expirationTimeMillis)
</a><a href="#h352-0-26" id="h352-0-26" class="d">-        }
</a><a href="#h352-0-27" id="h352-0-27" class="d">-
</a><a href="#h352-0-28" id="h352-0-28" class="d">-        if (context.config.experimental.hiddenSnapchatPlusFeatures.get()) {
</a><a href="#h352-0-29" id="h352-0-29" class="d">-            findClass(&quot;com.snap.plus.FeatureCatalog&quot;).methods.last {
</a><a href="#h352-0-30" id="h352-0-30" class="d">-                !it.name.contains(&quot;init&quot;) &amp;&amp;
</a><a href="#h352-0-31" id="h352-0-31" class="d">-                it.parameterTypes.isNotEmpty() &amp;&amp;
</a><a href="#h352-0-32" id="h352-0-32" class="d">-                it.parameterTypes[0].name != &quot;java.lang.Boolean&quot;
</a><a href="#h352-0-33" id="h352-0-33" class="d">-            }.hook(HookStage.BEFORE) { param -&gt;
</a><a href="#h352-0-34" id="h352-0-34" class="d">-                val instance = param.thisObject&lt;Any&gt;()
</a><a href="#h352-0-35" id="h352-0-35" class="d">-                val firstArg = param.arg&lt;Any&gt;(0)
</a><a href="#h352-0-36" id="h352-0-36" class="d">-
</a><a href="#h352-0-37" id="h352-0-37" class="d">-                instance::class.java.declaredFields.filter { it.type == firstArg::class.java }.forEach {
</a><a href="#h352-0-38" id="h352-0-38" class="d">-                    it.isAccessible = true
</a><a href="#h352-0-39" id="h352-0-39" class="d">-                    it.set(instance, firstArg)
</a><a href="#h352-0-40" id="h352-0-40" class="d">-                }
</a><a href="#h352-0-41" id="h352-0-41" class="d">-            }
</a><a href="#h352-0-42" id="h352-0-42" class="d">-        }
</a><a href="#h352-0-43" id="h352-0-43" class="d">-    }
</a><a href="#h352-0-44" id="h352-0-44" class="d">-}</a><a href="#h352-0-45" id="h352-0-45" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h353" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/UnlimitedSnapViewTime.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/UnlimitedSnapViewTime.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/UnlimitedSnapViewTime.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/UnlimitedSnapViewTime.kt</a></b>
<a href="#h353-0" id="h353-0" class="h">@@ -1,32 +0,0 @@
</a><a href="#h353-0-0" id="h353-0-0" class="d">-package me.rhunk.snapenhance.features.impl.tweaks
</a><a href="#h353-0-1" id="h353-0-1" class="d">-
</a><a href="#h353-0-2" id="h353-0-2" class="d">-import me.rhunk.snapenhance.core.event.events.impl.BuildMessageEvent
</a><a href="#h353-0-3" id="h353-0-3" class="d">-import me.rhunk.snapenhance.core.util.protobuf.ProtoEditor
</a><a href="#h353-0-4" id="h353-0-4" class="d">-import me.rhunk.snapenhance.core.util.protobuf.ProtoReader
</a><a href="#h353-0-5" id="h353-0-5" class="d">-import me.rhunk.snapenhance.data.ContentType
</a><a href="#h353-0-6" id="h353-0-6" class="d">-import me.rhunk.snapenhance.data.MessageState
</a><a href="#h353-0-7" id="h353-0-7" class="d">-import me.rhunk.snapenhance.features.Feature
</a><a href="#h353-0-8" id="h353-0-8" class="d">-import me.rhunk.snapenhance.features.FeatureLoadParams
</a><a href="#h353-0-9" id="h353-0-9" class="d">-
</a><a href="#h353-0-10" id="h353-0-10" class="d">-class UnlimitedSnapViewTime :
</a><a href="#h353-0-11" id="h353-0-11" class="d">-    Feature(&quot;UnlimitedSnapViewTime&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_SYNC) {
</a><a href="#h353-0-12" id="h353-0-12" class="d">-    override fun onActivityCreate() {
</a><a href="#h353-0-13" id="h353-0-13" class="d">-        val state by context.config.messaging.unlimitedSnapViewTime
</a><a href="#h353-0-14" id="h353-0-14" class="d">-
</a><a href="#h353-0-15" id="h353-0-15" class="d">-        context.event.subscribe(BuildMessageEvent::class, { state }, priority = 101) { event -&gt;
</a><a href="#h353-0-16" id="h353-0-16" class="d">-            if (event.message.messageState != MessageState.COMMITTED) return@subscribe
</a><a href="#h353-0-17" id="h353-0-17" class="d">-            if (event.message.messageContent.contentType != ContentType.SNAP) return@subscribe
</a><a href="#h353-0-18" id="h353-0-18" class="d">-
</a><a href="#h353-0-19" id="h353-0-19" class="d">-            val messageContent = event.message.messageContent
</a><a href="#h353-0-20" id="h353-0-20" class="d">-
</a><a href="#h353-0-21" id="h353-0-21" class="d">-            val mediaAttributes = ProtoReader(messageContent.content).followPath(11, 5, 2) ?: return@subscribe
</a><a href="#h353-0-22" id="h353-0-22" class="d">-            if (mediaAttributes.contains(6)) return@subscribe
</a><a href="#h353-0-23" id="h353-0-23" class="d">-            messageContent.content = ProtoEditor(messageContent.content).apply {
</a><a href="#h353-0-24" id="h353-0-24" class="d">-                edit(11, 5, 2) {
</a><a href="#h353-0-25" id="h353-0-25" class="d">-                    remove(8)
</a><a href="#h353-0-26" id="h353-0-26" class="d">-                    addBuffer(6, byteArrayOf())
</a><a href="#h353-0-27" id="h353-0-27" class="d">-                }
</a><a href="#h353-0-28" id="h353-0-28" class="d">-            }.toByteArray()
</a><a href="#h353-0-29" id="h353-0-29" class="d">-        }
</a><a href="#h353-0-30" id="h353-0-30" class="d">-    }
</a><a href="#h353-0-31" id="h353-0-31" class="d">-}
</a><b>diff --git a/<a id="h354" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/ClientBootstrapOverride.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/ClientBootstrapOverride.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/ClientBootstrapOverride.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/ClientBootstrapOverride.kt</a></b>
<a href="#h354-0" id="h354-0" class="h">@@ -1,34 +0,0 @@
</a><a href="#h354-0-0" id="h354-0-0" class="d">-package me.rhunk.snapenhance.features.impl.ui
</a><a href="#h354-0-1" id="h354-0-1" class="d">-
</a><a href="#h354-0-2" id="h354-0-2" class="d">-import me.rhunk.snapenhance.features.Feature
</a><a href="#h354-0-3" id="h354-0-3" class="d">-import me.rhunk.snapenhance.features.FeatureLoadParams
</a><a href="#h354-0-4" id="h354-0-4" class="d">-import java.io.File
</a><a href="#h354-0-5" id="h354-0-5" class="d">-
</a><a href="#h354-0-6" id="h354-0-6" class="d">-
</a><a href="#h354-0-7" id="h354-0-7" class="d">-class ClientBootstrapOverride : Feature(&quot;ClientBootstrapOverride&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_SYNC) {
</a><a href="#h354-0-8" id="h354-0-8" class="d">-    companion object {
</a><a href="#h354-0-9" id="h354-0-9" class="d">-        val tabs = arrayOf(&quot;map&quot;, &quot;chat&quot;, &quot;camera&quot;, &quot;discover&quot;, &quot;spotlight&quot;)
</a><a href="#h354-0-10" id="h354-0-10" class="d">-    }
</a><a href="#h354-0-11" id="h354-0-11" class="d">-
</a><a href="#h354-0-12" id="h354-0-12" class="d">-    private val clientBootstrapFolder by lazy { File(context.androidContext.filesDir, &quot;client-bootstrap&quot;) }
</a><a href="#h354-0-13" id="h354-0-13" class="d">-
</a><a href="#h354-0-14" id="h354-0-14" class="d">-    private val appearanceStartupConfigFile by lazy { File(clientBootstrapFolder, &quot;appearancestartupconfig&quot;) }
</a><a href="#h354-0-15" id="h354-0-15" class="d">-    private val plusFile by lazy { File(clientBootstrapFolder, &quot;plus&quot;) }
</a><a href="#h354-0-16" id="h354-0-16" class="d">-
</a><a href="#h354-0-17" id="h354-0-17" class="d">-    override fun onActivityCreate() {
</a><a href="#h354-0-18" id="h354-0-18" class="d">-        val bootstrapOverrideConfig = context.config.userInterface.bootstrapOverride
</a><a href="#h354-0-19" id="h354-0-19" class="d">-
</a><a href="#h354-0-20" id="h354-0-20" class="d">-        bootstrapOverrideConfig.appAppearance.getNullable()?.also { appearance -&gt;
</a><a href="#h354-0-21" id="h354-0-21" class="d">-            val state = when (appearance) {
</a><a href="#h354-0-22" id="h354-0-22" class="d">-                &quot;always_light&quot; -&gt; 0
</a><a href="#h354-0-23" id="h354-0-23" class="d">-                &quot;always_dark&quot; -&gt; 1
</a><a href="#h354-0-24" id="h354-0-24" class="d">-                else -&gt; return@also
</a><a href="#h354-0-25" id="h354-0-25" class="d">-            }.toByte()
</a><a href="#h354-0-26" id="h354-0-26" class="d">-            appearanceStartupConfigFile.writeBytes(byteArrayOf(0, 0, 0, state))
</a><a href="#h354-0-27" id="h354-0-27" class="d">-        }
</a><a href="#h354-0-28" id="h354-0-28" class="d">-
</a><a href="#h354-0-29" id="h354-0-29" class="d">-        bootstrapOverrideConfig.homeTab.getNullable()?.also { currentTab -&gt;
</a><a href="#h354-0-30" id="h354-0-30" class="d">-            plusFile.writeBytes(byteArrayOf(8, (tabs.indexOf(currentTab) + 1).toByte()))
</a><a href="#h354-0-31" id="h354-0-31" class="d">-        }
</a><a href="#h354-0-32" id="h354-0-32" class="d">-    }
</a><a href="#h354-0-33" id="h354-0-33" class="d">-}</a><a href="#h354-0-34" id="h354-0-34" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h355" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/FriendFeedMessagePreview.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/FriendFeedMessagePreview.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/FriendFeedMessagePreview.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/FriendFeedMessagePreview.kt</a></b>
<a href="#h355-0" id="h355-0" class="h">@@ -1,106 +0,0 @@
</a><a href="#h355-0-0" id="h355-0-0" class="d">-package me.rhunk.snapenhance.features.impl.ui
</a><a href="#h355-0-1" id="h355-0-1" class="d">-
</a><a href="#h355-0-2" id="h355-0-2" class="d">-import android.annotation.SuppressLint
</a><a href="#h355-0-3" id="h355-0-3" class="d">-import android.graphics.Canvas
</a><a href="#h355-0-4" id="h355-0-4" class="d">-import android.graphics.Paint
</a><a href="#h355-0-5" id="h355-0-5" class="d">-import android.graphics.Rect
</a><a href="#h355-0-6" id="h355-0-6" class="d">-import android.graphics.drawable.ShapeDrawable
</a><a href="#h355-0-7" id="h355-0-7" class="d">-import android.graphics.drawable.shapes.Shape
</a><a href="#h355-0-8" id="h355-0-8" class="d">-import android.text.TextPaint
</a><a href="#h355-0-9" id="h355-0-9" class="d">-import android.view.View
</a><a href="#h355-0-10" id="h355-0-10" class="d">-import android.view.ViewGroup
</a><a href="#h355-0-11" id="h355-0-11" class="d">-import me.rhunk.snapenhance.Constants
</a><a href="#h355-0-12" id="h355-0-12" class="d">-import me.rhunk.snapenhance.core.event.events.impl.BindViewEvent
</a><a href="#h355-0-13" id="h355-0-13" class="d">-import me.rhunk.snapenhance.core.util.protobuf.ProtoReader
</a><a href="#h355-0-14" id="h355-0-14" class="d">-import me.rhunk.snapenhance.data.ContentType
</a><a href="#h355-0-15" id="h355-0-15" class="d">-import me.rhunk.snapenhance.features.Feature
</a><a href="#h355-0-16" id="h355-0-16" class="d">-import me.rhunk.snapenhance.features.FeatureLoadParams
</a><a href="#h355-0-17" id="h355-0-17" class="d">-import me.rhunk.snapenhance.ui.addForegroundDrawable
</a><a href="#h355-0-18" id="h355-0-18" class="d">-import me.rhunk.snapenhance.ui.removeForegroundDrawable
</a><a href="#h355-0-19" id="h355-0-19" class="d">-import kotlin.math.absoluteValue
</a><a href="#h355-0-20" id="h355-0-20" class="d">-
</a><a href="#h355-0-21" id="h355-0-21" class="d">-@SuppressLint(&quot;DiscouragedApi&quot;)
</a><a href="#h355-0-22" id="h355-0-22" class="d">-class FriendFeedMessagePreview : Feature(&quot;FriendFeedMessagePreview&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_SYNC) {
</a><a href="#h355-0-23" id="h355-0-23" class="d">-    private val sigColorTextPrimary by lazy {
</a><a href="#h355-0-24" id="h355-0-24" class="d">-        context.mainActivity!!.theme.obtainStyledAttributes(
</a><a href="#h355-0-25" id="h355-0-25" class="d">-            intArrayOf(context.resources.getIdentifier(&quot;sigColorTextPrimary&quot;, &quot;attr&quot;, Constants.SNAPCHAT_PACKAGE_NAME))
</a><a href="#h355-0-26" id="h355-0-26" class="d">-        ).getColor(0, 0)
</a><a href="#h355-0-27" id="h355-0-27" class="d">-    }
</a><a href="#h355-0-28" id="h355-0-28" class="d">-
</a><a href="#h355-0-29" id="h355-0-29" class="d">-    private fun getDimens(name: String) = context.resources.getDimensionPixelSize(context.resources.getIdentifier(name, &quot;dimen&quot;, Constants.SNAPCHAT_PACKAGE_NAME))
</a><a href="#h355-0-30" id="h355-0-30" class="d">-
</a><a href="#h355-0-31" id="h355-0-31" class="d">-    override fun onActivityCreate() {
</a><a href="#h355-0-32" id="h355-0-32" class="d">-        val setting = context.config.userInterface.friendFeedMessagePreview
</a><a href="#h355-0-33" id="h355-0-33" class="d">-        if (setting.globalState != true) return
</a><a href="#h355-0-34" id="h355-0-34" class="d">-
</a><a href="#h355-0-35" id="h355-0-35" class="d">-        val ffItemId = context.resources.getIdentifier(&quot;ff_item&quot;, &quot;id&quot;, Constants.SNAPCHAT_PACKAGE_NAME)
</a><a href="#h355-0-36" id="h355-0-36" class="d">-
</a><a href="#h355-0-37" id="h355-0-37" class="d">-        val secondaryTextSize = getDimens(&quot;ff_feed_cell_secondary_text_size&quot;).toFloat()
</a><a href="#h355-0-38" id="h355-0-38" class="d">-        val ffSdlAvatarMargin = getDimens(&quot;ff_sdl_avatar_margin&quot;)
</a><a href="#h355-0-39" id="h355-0-39" class="d">-        val ffSdlAvatarSize = getDimens(&quot;ff_sdl_avatar_size&quot;)
</a><a href="#h355-0-40" id="h355-0-40" class="d">-        val ffSdlAvatarStartMargin = getDimens(&quot;ff_sdl_avatar_start_margin&quot;)
</a><a href="#h355-0-41" id="h355-0-41" class="d">-        val ffSdlPrimaryTextStartMargin = getDimens(&quot;ff_sdl_primary_text_start_margin&quot;).toFloat()
</a><a href="#h355-0-42" id="h355-0-42" class="d">-
</a><a href="#h355-0-43" id="h355-0-43" class="d">-        val feedEntryHeight = ffSdlAvatarSize + ffSdlAvatarMargin * 2 + ffSdlAvatarStartMargin
</a><a href="#h355-0-44" id="h355-0-44" class="d">-        val separatorHeight = (context.resources.displayMetrics.density * 2).toInt()
</a><a href="#h355-0-45" id="h355-0-45" class="d">-        val textPaint = TextPaint().apply {
</a><a href="#h355-0-46" id="h355-0-46" class="d">-            textSize = secondaryTextSize
</a><a href="#h355-0-47" id="h355-0-47" class="d">-        }
</a><a href="#h355-0-48" id="h355-0-48" class="d">-
</a><a href="#h355-0-49" id="h355-0-49" class="d">-        context.event.subscribe(BindViewEvent::class) { param -&gt;
</a><a href="#h355-0-50" id="h355-0-50" class="d">-            param.friendFeedItem { conversationId -&gt;
</a><a href="#h355-0-51" id="h355-0-51" class="d">-                val frameLayout = param.view as ViewGroup
</a><a href="#h355-0-52" id="h355-0-52" class="d">-                val ffItem = frameLayout.findViewById&lt;View&gt;(ffItemId)
</a><a href="#h355-0-53" id="h355-0-53" class="d">-
</a><a href="#h355-0-54" id="h355-0-54" class="d">-                ffItem.layoutParams = ffItem.layoutParams.apply {
</a><a href="#h355-0-55" id="h355-0-55" class="d">-                    height = ViewGroup.LayoutParams.MATCH_PARENT
</a><a href="#h355-0-56" id="h355-0-56" class="d">-                }
</a><a href="#h355-0-57" id="h355-0-57" class="d">-                frameLayout.removeForegroundDrawable(&quot;ffItem&quot;)
</a><a href="#h355-0-58" id="h355-0-58" class="d">-
</a><a href="#h355-0-59" id="h355-0-59" class="d">-                val stringMessages = context.database.getMessagesFromConversationId(conversationId, setting.amount.get().absoluteValue)?.mapNotNull { message -&gt;
</a><a href="#h355-0-60" id="h355-0-60" class="d">-                    val messageContainer = message.messageContent
</a><a href="#h355-0-61" id="h355-0-61" class="d">-                        ?.let { ProtoReader(it) }
</a><a href="#h355-0-62" id="h355-0-62" class="d">-                        ?.followPath(4, 4)
</a><a href="#h355-0-63" id="h355-0-63" class="d">-                        ?: return@mapNotNull null
</a><a href="#h355-0-64" id="h355-0-64" class="d">-
</a><a href="#h355-0-65" id="h355-0-65" class="d">-                    val messageString = messageContainer.getString(2, 1)
</a><a href="#h355-0-66" id="h355-0-66" class="d">-                        ?: ContentType.fromMessageContainer(messageContainer)?.name
</a><a href="#h355-0-67" id="h355-0-67" class="d">-                        ?: return@mapNotNull null
</a><a href="#h355-0-68" id="h355-0-68" class="d">-
</a><a href="#h355-0-69" id="h355-0-69" class="d">-                    val friendName = context.database.getFriendInfo(message.senderId ?: return@mapNotNull null)?.let { it.displayName?: it.mutableUsername } ?: &quot;Unknown&quot;
</a><a href="#h355-0-70" id="h355-0-70" class="d">-
</a><a href="#h355-0-71" id="h355-0-71" class="d">-                    &quot;$friendName: $messageString&quot;
</a><a href="#h355-0-72" id="h355-0-72" class="d">-                }?.reversed() ?: return@friendFeedItem
</a><a href="#h355-0-73" id="h355-0-73" class="d">-
</a><a href="#h355-0-74" id="h355-0-74" class="d">-                var maxTextHeight = 0
</a><a href="#h355-0-75" id="h355-0-75" class="d">-                val previewContainerHeight = stringMessages.sumOf { msg -&gt;
</a><a href="#h355-0-76" id="h355-0-76" class="d">-                    val rect = Rect()
</a><a href="#h355-0-77" id="h355-0-77" class="d">-                    textPaint.getTextBounds(msg, 0, msg.length, rect)
</a><a href="#h355-0-78" id="h355-0-78" class="d">-                    rect.height().also {
</a><a href="#h355-0-79" id="h355-0-79" class="d">-                        if (it &gt; maxTextHeight) maxTextHeight = it
</a><a href="#h355-0-80" id="h355-0-80" class="d">-                    }.plus(separatorHeight)
</a><a href="#h355-0-81" id="h355-0-81" class="d">-                }
</a><a href="#h355-0-82" id="h355-0-82" class="d">-
</a><a href="#h355-0-83" id="h355-0-83" class="d">-                ffItem.layoutParams = ffItem.layoutParams.apply {
</a><a href="#h355-0-84" id="h355-0-84" class="d">-                    height = feedEntryHeight + previewContainerHeight + separatorHeight
</a><a href="#h355-0-85" id="h355-0-85" class="d">-                }
</a><a href="#h355-0-86" id="h355-0-86" class="d">-
</a><a href="#h355-0-87" id="h355-0-87" class="d">-                frameLayout.addForegroundDrawable(&quot;ffItem&quot;, ShapeDrawable(object: Shape() {
</a><a href="#h355-0-88" id="h355-0-88" class="d">-                    override fun draw(canvas: Canvas, paint: Paint) {
</a><a href="#h355-0-89" id="h355-0-89" class="d">-                        val offsetY = canvas.height.toFloat() - previewContainerHeight
</a><a href="#h355-0-90" id="h355-0-90" class="d">-
</a><a href="#h355-0-91" id="h355-0-91" class="d">-                        stringMessages.forEachIndexed { index, messageString -&gt;
</a><a href="#h355-0-92" id="h355-0-92" class="d">-                            paint.textSize = secondaryTextSize
</a><a href="#h355-0-93" id="h355-0-93" class="d">-                            paint.color = sigColorTextPrimary
</a><a href="#h355-0-94" id="h355-0-94" class="d">-                            canvas.drawText(messageString,
</a><a href="#h355-0-95" id="h355-0-95" class="d">-                                feedEntryHeight + ffSdlPrimaryTextStartMargin,
</a><a href="#h355-0-96" id="h355-0-96" class="d">-                                offsetY + index * maxTextHeight,
</a><a href="#h355-0-97" id="h355-0-97" class="d">-                                paint
</a><a href="#h355-0-98" id="h355-0-98" class="d">-                            )
</a><a href="#h355-0-99" id="h355-0-99" class="d">-                        }
</a><a href="#h355-0-100" id="h355-0-100" class="d">-                    }
</a><a href="#h355-0-101" id="h355-0-101" class="d">-                }))
</a><a href="#h355-0-102" id="h355-0-102" class="d">-            }
</a><a href="#h355-0-103" id="h355-0-103" class="d">-        }
</a><a href="#h355-0-104" id="h355-0-104" class="d">-    }
</a><a href="#h355-0-105" id="h355-0-105" class="d">-}</a><a href="#h355-0-106" id="h355-0-106" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h356" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/HideStreakRestore.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/HideStreakRestore.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/HideStreakRestore.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/HideStreakRestore.kt</a></b>
<a href="#h356-0" id="h356-0" class="h">@@ -1,19 +0,0 @@
</a><a href="#h356-0-0" id="h356-0-0" class="d">-package me.rhunk.snapenhance.features.impl.ui
</a><a href="#h356-0-1" id="h356-0-1" class="d">-
</a><a href="#h356-0-2" id="h356-0-2" class="d">-import me.rhunk.snapenhance.core.util.ktx.getObjectField
</a><a href="#h356-0-3" id="h356-0-3" class="d">-import me.rhunk.snapenhance.core.util.ktx.setObjectField
</a><a href="#h356-0-4" id="h356-0-4" class="d">-import me.rhunk.snapenhance.features.Feature
</a><a href="#h356-0-5" id="h356-0-5" class="d">-import me.rhunk.snapenhance.features.FeatureLoadParams
</a><a href="#h356-0-6" id="h356-0-6" class="d">-import me.rhunk.snapenhance.hook.HookStage
</a><a href="#h356-0-7" id="h356-0-7" class="d">-import me.rhunk.snapenhance.hook.hookConstructor
</a><a href="#h356-0-8" id="h356-0-8" class="d">-
</a><a href="#h356-0-9" id="h356-0-9" class="d">-class HideStreakRestore : Feature(&quot;HideStreakRestore&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_SYNC) {
</a><a href="#h356-0-10" id="h356-0-10" class="d">-    override fun onActivityCreate() {
</a><a href="#h356-0-11" id="h356-0-11" class="d">-        if (!context.config.userInterface.hideStreakRestore.get()) return
</a><a href="#h356-0-12" id="h356-0-12" class="d">-
</a><a href="#h356-0-13" id="h356-0-13" class="d">-        context.classCache.feedEntry.hookConstructor(HookStage.AFTER) { param -&gt;
</a><a href="#h356-0-14" id="h356-0-14" class="d">-            val streakMetadata = param.thisObject&lt;Any&gt;().getObjectField(&quot;mStreakMetadata&quot;) ?: return@hookConstructor
</a><a href="#h356-0-15" id="h356-0-15" class="d">-            streakMetadata.setObjectField(&quot;mExpiredStreak&quot;, null)
</a><a href="#h356-0-16" id="h356-0-16" class="d">-        }
</a><a href="#h356-0-17" id="h356-0-17" class="d">-    }
</a><a href="#h356-0-18" id="h356-0-18" class="d">-}</a><a href="#h356-0-19" id="h356-0-19" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h357" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/PinConversations.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/PinConversations.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/PinConversations.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/PinConversations.kt</a></b>
<a href="#h357-0" id="h357-0" class="h">@@ -1,41 +0,0 @@
</a><a href="#h357-0-0" id="h357-0-0" class="d">-package me.rhunk.snapenhance.features.impl.ui
</a><a href="#h357-0-1" id="h357-0-1" class="d">-
</a><a href="#h357-0-2" id="h357-0-2" class="d">-import me.rhunk.snapenhance.core.messaging.MessagingRuleType
</a><a href="#h357-0-3" id="h357-0-3" class="d">-import me.rhunk.snapenhance.core.messaging.RuleState
</a><a href="#h357-0-4" id="h357-0-4" class="d">-import me.rhunk.snapenhance.core.util.ktx.getObjectField
</a><a href="#h357-0-5" id="h357-0-5" class="d">-import me.rhunk.snapenhance.core.util.ktx.setObjectField
</a><a href="#h357-0-6" id="h357-0-6" class="d">-import me.rhunk.snapenhance.data.wrapper.impl.SnapUUID
</a><a href="#h357-0-7" id="h357-0-7" class="d">-import me.rhunk.snapenhance.features.FeatureLoadParams
</a><a href="#h357-0-8" id="h357-0-8" class="d">-import me.rhunk.snapenhance.features.MessagingRuleFeature
</a><a href="#h357-0-9" id="h357-0-9" class="d">-import me.rhunk.snapenhance.hook.HookStage
</a><a href="#h357-0-10" id="h357-0-10" class="d">-import me.rhunk.snapenhance.hook.hook
</a><a href="#h357-0-11" id="h357-0-11" class="d">-import me.rhunk.snapenhance.hook.hookConstructor
</a><a href="#h357-0-12" id="h357-0-12" class="d">-
</a><a href="#h357-0-13" id="h357-0-13" class="d">-class PinConversations : MessagingRuleFeature(&quot;PinConversations&quot;, MessagingRuleType.PIN_CONVERSATION, loadParams = FeatureLoadParams.ACTIVITY_CREATE_SYNC) {
</a><a href="#h357-0-14" id="h357-0-14" class="d">-    override fun onActivityCreate() {
</a><a href="#h357-0-15" id="h357-0-15" class="d">-        context.classCache.feedManager.hook(&quot;setPinnedConversationStatus&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h357-0-16" id="h357-0-16" class="d">-            val conversationUUID = SnapUUID(param.arg(0))
</a><a href="#h357-0-17" id="h357-0-17" class="d">-            val isPinned = param.arg&lt;Any&gt;(1).toString() == &quot;PINNED&quot;
</a><a href="#h357-0-18" id="h357-0-18" class="d">-            setState(conversationUUID.toString(), isPinned)
</a><a href="#h357-0-19" id="h357-0-19" class="d">-        }
</a><a href="#h357-0-20" id="h357-0-20" class="d">-
</a><a href="#h357-0-21" id="h357-0-21" class="d">-        context.classCache.conversation.hookConstructor(HookStage.AFTER) { param -&gt;
</a><a href="#h357-0-22" id="h357-0-22" class="d">-            val instance = param.thisObject&lt;Any&gt;()
</a><a href="#h357-0-23" id="h357-0-23" class="d">-            val conversationUUID = SnapUUID(instance.getObjectField(&quot;mConversationId&quot;))
</a><a href="#h357-0-24" id="h357-0-24" class="d">-            if (getState(conversationUUID.toString())) {
</a><a href="#h357-0-25" id="h357-0-25" class="d">-                instance.setObjectField(&quot;mPinnedTimestampMs&quot;, 1L)
</a><a href="#h357-0-26" id="h357-0-26" class="d">-            }
</a><a href="#h357-0-27" id="h357-0-27" class="d">-        }
</a><a href="#h357-0-28" id="h357-0-28" class="d">-
</a><a href="#h357-0-29" id="h357-0-29" class="d">-        context.classCache.feedEntry.hookConstructor(HookStage.AFTER) { param -&gt;
</a><a href="#h357-0-30" id="h357-0-30" class="d">-            val instance = param.thisObject&lt;Any&gt;()
</a><a href="#h357-0-31" id="h357-0-31" class="d">-            val conversationUUID = SnapUUID(instance.getObjectField(&quot;mConversationId&quot;) ?: return@hookConstructor)
</a><a href="#h357-0-32" id="h357-0-32" class="d">-            val isPinned = getState(conversationUUID.toString())
</a><a href="#h357-0-33" id="h357-0-33" class="d">-            if (isPinned) {
</a><a href="#h357-0-34" id="h357-0-34" class="d">-                instance.setObjectField(&quot;mPinnedTimestampMs&quot;, 1L)
</a><a href="#h357-0-35" id="h357-0-35" class="d">-            }
</a><a href="#h357-0-36" id="h357-0-36" class="d">-        }
</a><a href="#h357-0-37" id="h357-0-37" class="d">-    }
</a><a href="#h357-0-38" id="h357-0-38" class="d">-
</a><a href="#h357-0-39" id="h357-0-39" class="d">-    override fun getRuleState() = RuleState.WHITELIST
</a><a href="#h357-0-40" id="h357-0-40" class="d">-}</a><a href="#h357-0-41" id="h357-0-41" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h358" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/UITweaks.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/UITweaks.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/UITweaks.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/UITweaks.kt</a></b>
<a href="#h358-0" id="h358-0" class="h">@@ -1,150 +0,0 @@
</a><a href="#h358-0-0" id="h358-0-0" class="d">-package me.rhunk.snapenhance.features.impl.ui
</a><a href="#h358-0-1" id="h358-0-1" class="d">-
</a><a href="#h358-0-2" id="h358-0-2" class="d">-import android.annotation.SuppressLint
</a><a href="#h358-0-3" id="h358-0-3" class="d">-import android.content.Context
</a><a href="#h358-0-4" id="h358-0-4" class="d">-import android.content.res.Resources
</a><a href="#h358-0-5" id="h358-0-5" class="d">-import android.graphics.Rect
</a><a href="#h358-0-6" id="h358-0-6" class="d">-import android.text.SpannableString
</a><a href="#h358-0-7" id="h358-0-7" class="d">-import android.view.View
</a><a href="#h358-0-8" id="h358-0-8" class="d">-import android.view.ViewGroup.MarginLayoutParams
</a><a href="#h358-0-9" id="h358-0-9" class="d">-import android.widget.FrameLayout
</a><a href="#h358-0-10" id="h358-0-10" class="d">-import me.rhunk.snapenhance.Constants
</a><a href="#h358-0-11" id="h358-0-11" class="d">-import me.rhunk.snapenhance.core.event.events.impl.AddViewEvent
</a><a href="#h358-0-12" id="h358-0-12" class="d">-import me.rhunk.snapenhance.features.Feature
</a><a href="#h358-0-13" id="h358-0-13" class="d">-import me.rhunk.snapenhance.features.FeatureLoadParams
</a><a href="#h358-0-14" id="h358-0-14" class="d">-import me.rhunk.snapenhance.hook.HookStage
</a><a href="#h358-0-15" id="h358-0-15" class="d">-import me.rhunk.snapenhance.hook.Hooker
</a><a href="#h358-0-16" id="h358-0-16" class="d">-import me.rhunk.snapenhance.hook.hook
</a><a href="#h358-0-17" id="h358-0-17" class="d">-
</a><a href="#h358-0-18" id="h358-0-18" class="d">-class UITweaks : Feature(&quot;UITweaks&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_SYNC) {
</a><a href="#h358-0-19" id="h358-0-19" class="d">-    private val identifierCache = mutableMapOf&lt;String, Int&gt;()
</a><a href="#h358-0-20" id="h358-0-20" class="d">-
</a><a href="#h358-0-21" id="h358-0-21" class="d">-    @SuppressLint(&quot;DiscouragedApi&quot;)
</a><a href="#h358-0-22" id="h358-0-22" class="d">-    fun getIdentifier(name: String, defType: String): Int {
</a><a href="#h358-0-23" id="h358-0-23" class="d">-        return identifierCache.getOrPut(&quot;$name:$defType&quot;) {
</a><a href="#h358-0-24" id="h358-0-24" class="d">-            context.resources.getIdentifier(name, defType, Constants.SNAPCHAT_PACKAGE_NAME)
</a><a href="#h358-0-25" id="h358-0-25" class="d">-        }
</a><a href="#h358-0-26" id="h358-0-26" class="d">-    }
</a><a href="#h358-0-27" id="h358-0-27" class="d">-
</a><a href="#h358-0-28" id="h358-0-28" class="d">-    private fun hideStorySection(event: AddViewEvent) {
</a><a href="#h358-0-29" id="h358-0-29" class="d">-        val parent = event.parent
</a><a href="#h358-0-30" id="h358-0-30" class="d">-        parent.visibility = View.GONE
</a><a href="#h358-0-31" id="h358-0-31" class="d">-        val marginLayoutParams = parent.layoutParams as MarginLayoutParams
</a><a href="#h358-0-32" id="h358-0-32" class="d">-        marginLayoutParams.setMargins(-99999, -99999, -99999, -99999)
</a><a href="#h358-0-33" id="h358-0-33" class="d">-        event.canceled = true
</a><a href="#h358-0-34" id="h358-0-34" class="d">-    }
</a><a href="#h358-0-35" id="h358-0-35" class="d">-
</a><a href="#h358-0-36" id="h358-0-36" class="d">-    private var surfaceViewAspectRatio: Float = 0f
</a><a href="#h358-0-37" id="h358-0-37" class="d">-
</a><a href="#h358-0-38" id="h358-0-38" class="d">-    @SuppressLint(&quot;DiscouragedApi&quot;, &quot;InternalInsetResource&quot;)
</a><a href="#h358-0-39" id="h358-0-39" class="d">-    override fun onActivityCreate() {
</a><a href="#h358-0-40" id="h358-0-40" class="d">-        val blockAds by context.config.global.blockAds
</a><a href="#h358-0-41" id="h358-0-41" class="d">-        val hiddenElements by context.config.userInterface.hideUiComponents
</a><a href="#h358-0-42" id="h358-0-42" class="d">-        val hideStorySections by context.config.userInterface.hideStorySections
</a><a href="#h358-0-43" id="h358-0-43" class="d">-        val isImmersiveCamera by context.config.camera.immersiveCameraPreview
</a><a href="#h358-0-44" id="h358-0-44" class="d">-
</a><a href="#h358-0-45" id="h358-0-45" class="d">-        val displayMetrics = context.resources.displayMetrics
</a><a href="#h358-0-46" id="h358-0-46" class="d">-        val deviceAspectRatio = displayMetrics.widthPixels.toFloat() / displayMetrics.heightPixels.toFloat()
</a><a href="#h358-0-47" id="h358-0-47" class="d">-
</a><a href="#h358-0-48" id="h358-0-48" class="d">-        val callButtonsStub = getIdentifier(&quot;call_buttons_stub&quot;, &quot;id&quot;)
</a><a href="#h358-0-49" id="h358-0-49" class="d">-        val callButton1 = getIdentifier(&quot;friend_action_button3&quot;, &quot;id&quot;)
</a><a href="#h358-0-50" id="h358-0-50" class="d">-        val callButton2 = getIdentifier(&quot;friend_action_button4&quot;, &quot;id&quot;)
</a><a href="#h358-0-51" id="h358-0-51" class="d">-
</a><a href="#h358-0-52" id="h358-0-52" class="d">-        val chatNoteRecordButton = getIdentifier(&quot;chat_note_record_button&quot;, &quot;id&quot;)
</a><a href="#h358-0-53" id="h358-0-53" class="d">-
</a><a href="#h358-0-54" id="h358-0-54" class="d">-        View::class.java.hook(&quot;setVisibility&quot;, HookStage.BEFORE) { methodParam -&gt;
</a><a href="#h358-0-55" id="h358-0-55" class="d">-            val viewId = (methodParam.thisObject() as View).id
</a><a href="#h358-0-56" id="h358-0-56" class="d">-            if (viewId == callButton1 || viewId == callButton2) {
</a><a href="#h358-0-57" id="h358-0-57" class="d">-                if (!hiddenElements.contains(&quot;hide_profile_call_buttons&quot;)) return@hook
</a><a href="#h358-0-58" id="h358-0-58" class="d">-                methodParam.setArg(0, View.GONE)
</a><a href="#h358-0-59" id="h358-0-59" class="d">-            }
</a><a href="#h358-0-60" id="h358-0-60" class="d">-        }
</a><a href="#h358-0-61" id="h358-0-61" class="d">-
</a><a href="#h358-0-62" id="h358-0-62" class="d">-        Resources::class.java.methods.first { it.name == &quot;getDimensionPixelSize&quot;}.hook(HookStage.AFTER,
</a><a href="#h358-0-63" id="h358-0-63" class="d">-            { isImmersiveCamera }
</a><a href="#h358-0-64" id="h358-0-64" class="d">-        ) { param -&gt;
</a><a href="#h358-0-65" id="h358-0-65" class="d">-            val id = param.arg&lt;Int&gt;(0)
</a><a href="#h358-0-66" id="h358-0-66" class="d">-            if (id == getIdentifier(&quot;capri_viewfinder_default_corner_radius&quot;, &quot;dimen&quot;) ||
</a><a href="#h358-0-67" id="h358-0-67" class="d">-                id == getIdentifier(&quot;ngs_hova_nav_larger_camera_button_size&quot;, &quot;dimen&quot;)) {
</a><a href="#h358-0-68" id="h358-0-68" class="d">-                param.setResult(0)
</a><a href="#h358-0-69" id="h358-0-69" class="d">-            }
</a><a href="#h358-0-70" id="h358-0-70" class="d">-        }
</a><a href="#h358-0-71" id="h358-0-71" class="d">-
</a><a href="#h358-0-72" id="h358-0-72" class="d">-        context.event.subscribe(AddViewEvent::class) { event -&gt;
</a><a href="#h358-0-73" id="h358-0-73" class="d">-            val viewId = event.view.id
</a><a href="#h358-0-74" id="h358-0-74" class="d">-            val view = event.view
</a><a href="#h358-0-75" id="h358-0-75" class="d">-
</a><a href="#h358-0-76" id="h358-0-76" class="d">-            if (hideStorySections.contains(&quot;hide_for_you&quot;)) {
</a><a href="#h358-0-77" id="h358-0-77" class="d">-                if (viewId == getIdentifier(&quot;df_large_story&quot;, &quot;id&quot;) ||
</a><a href="#h358-0-78" id="h358-0-78" class="d">-                            viewId == getIdentifier(&quot;df_promoted_story&quot;, &quot;id&quot;)) {
</a><a href="#h358-0-79" id="h358-0-79" class="d">-                    hideStorySection(event)
</a><a href="#h358-0-80" id="h358-0-80" class="d">-                    return@subscribe
</a><a href="#h358-0-81" id="h358-0-81" class="d">-                }
</a><a href="#h358-0-82" id="h358-0-82" class="d">-                if (viewId == getIdentifier(&quot;stories_load_progress_layout&quot;, &quot;id&quot;)) {
</a><a href="#h358-0-83" id="h358-0-83" class="d">-                    event.canceled = true
</a><a href="#h358-0-84" id="h358-0-84" class="d">-                }
</a><a href="#h358-0-85" id="h358-0-85" class="d">-            }
</a><a href="#h358-0-86" id="h358-0-86" class="d">-
</a><a href="#h358-0-87" id="h358-0-87" class="d">-            if (hideStorySections.contains(&quot;hide_friends&quot;) &amp;&amp; viewId == getIdentifier(&quot;friend_card_frame&quot;, &quot;id&quot;)) {
</a><a href="#h358-0-88" id="h358-0-88" class="d">-                hideStorySection(event)
</a><a href="#h358-0-89" id="h358-0-89" class="d">-            }
</a><a href="#h358-0-90" id="h358-0-90" class="d">-
</a><a href="#h358-0-91" id="h358-0-91" class="d">-            //mappings?
</a><a href="#h358-0-92" id="h358-0-92" class="d">-            if (hideStorySections.contains(&quot;hide_friend_suggestions&quot;) &amp;&amp; view.javaClass.superclass?.name?.endsWith(&quot;StackDrawLayout&quot;) == true) {
</a><a href="#h358-0-93" id="h358-0-93" class="d">-                val layoutParams = view.layoutParams as? FrameLayout.LayoutParams ?: return@subscribe
</a><a href="#h358-0-94" id="h358-0-94" class="d">-                if (layoutParams.width == -1 &amp;&amp;
</a><a href="#h358-0-95" id="h358-0-95" class="d">-                    layoutParams.height == -2 &amp;&amp;
</a><a href="#h358-0-96" id="h358-0-96" class="d">-                    view.javaClass.let { clazz -&gt;
</a><a href="#h358-0-97" id="h358-0-97" class="d">-                        clazz.methods.any { it.returnType == SpannableString::class.java} &amp;&amp;
</a><a href="#h358-0-98" id="h358-0-98" class="d">-                        clazz.constructors.any { it.parameterCount == 1 &amp;&amp; it.parameterTypes[0] == Context::class.java }
</a><a href="#h358-0-99" id="h358-0-99" class="d">-                    }
</a><a href="#h358-0-100" id="h358-0-100" class="d">-                ) {
</a><a href="#h358-0-101" id="h358-0-101" class="d">-                    hideStorySection(event)
</a><a href="#h358-0-102" id="h358-0-102" class="d">-                }
</a><a href="#h358-0-103" id="h358-0-103" class="d">-            }
</a><a href="#h358-0-104" id="h358-0-104" class="d">-
</a><a href="#h358-0-105" id="h358-0-105" class="d">-            if (hideStorySections.contains(&quot;hide_suggested&quot;) &amp;&amp; (viewId == getIdentifier(&quot;df_small_story&quot;, &quot;id&quot;))
</a><a href="#h358-0-106" id="h358-0-106" class="d">-            ) {
</a><a href="#h358-0-107" id="h358-0-107" class="d">-                hideStorySection(event)
</a><a href="#h358-0-108" id="h358-0-108" class="d">-            }
</a><a href="#h358-0-109" id="h358-0-109" class="d">-
</a><a href="#h358-0-110" id="h358-0-110" class="d">-            if (blockAds &amp;&amp; viewId == getIdentifier(&quot;df_promoted_story&quot;, &quot;id&quot;)) {
</a><a href="#h358-0-111" id="h358-0-111" class="d">-                hideStorySection(event)
</a><a href="#h358-0-112" id="h358-0-112" class="d">-            }
</a><a href="#h358-0-113" id="h358-0-113" class="d">-
</a><a href="#h358-0-114" id="h358-0-114" class="d">-            if (isImmersiveCamera) {
</a><a href="#h358-0-115" id="h358-0-115" class="d">-                if (view.id == getIdentifier(&quot;edits_container&quot;, &quot;id&quot;)) {
</a><a href="#h358-0-116" id="h358-0-116" class="d">-                    Hooker.hookObjectMethod(View::class.java, view, &quot;layout&quot;, HookStage.BEFORE) {
</a><a href="#h358-0-117" id="h358-0-117" class="d">-                        val width = it.arg(2) as Int
</a><a href="#h358-0-118" id="h358-0-118" class="d">-                        val realHeight = (width / deviceAspectRatio).toInt()
</a><a href="#h358-0-119" id="h358-0-119" class="d">-                        it.setArg(3, realHeight)
</a><a href="#h358-0-120" id="h358-0-120" class="d">-                    }
</a><a href="#h358-0-121" id="h358-0-121" class="d">-                }
</a><a href="#h358-0-122" id="h358-0-122" class="d">-                if (view.id == getIdentifier(&quot;full_screen_surface_view&quot;, &quot;id&quot;)) {
</a><a href="#h358-0-123" id="h358-0-123" class="d">-                    Hooker.hookObjectMethod(View::class.java, view, &quot;layout&quot;, HookStage.BEFORE) {
</a><a href="#h358-0-124" id="h358-0-124" class="d">-                        it.setArg(1, 1)
</a><a href="#h358-0-125" id="h358-0-125" class="d">-                        it.setArg(3, displayMetrics.heightPixels)
</a><a href="#h358-0-126" id="h358-0-126" class="d">-                    }
</a><a href="#h358-0-127" id="h358-0-127" class="d">-                }
</a><a href="#h358-0-128" id="h358-0-128" class="d">-            }
</a><a href="#h358-0-129" id="h358-0-129" class="d">-
</a><a href="#h358-0-130" id="h358-0-130" class="d">-            if (
</a><a href="#h358-0-131" id="h358-0-131" class="d">-                (viewId == chatNoteRecordButton &amp;&amp; hiddenElements.contains(&quot;hide_voice_record_button&quot;)) ||
</a><a href="#h358-0-132" id="h358-0-132" class="d">-                (viewId == getIdentifier(&quot;chat_input_bar_sticker&quot;, &quot;id&quot;) &amp;&amp; hiddenElements.contains(&quot;hide_stickers_button&quot;)) ||
</a><a href="#h358-0-133" id="h358-0-133" class="d">-                (viewId == getIdentifier(&quot;chat_input_bar_sharing_drawer_button&quot;, &quot;id&quot;) &amp;&amp; hiddenElements.contains(&quot;hide_live_location_share_button&quot;)) ||
</a><a href="#h358-0-134" id="h358-0-134" class="d">-                (viewId == callButtonsStub &amp;&amp; hiddenElements.contains(&quot;hide_chat_call_buttons&quot;))
</a><a href="#h358-0-135" id="h358-0-135" class="d">-            ) {
</a><a href="#h358-0-136" id="h358-0-136" class="d">-                view.apply {
</a><a href="#h358-0-137" id="h358-0-137" class="d">-                    view.post {
</a><a href="#h358-0-138" id="h358-0-138" class="d">-                        isEnabled = false
</a><a href="#h358-0-139" id="h358-0-139" class="d">-                        setWillNotDraw(true)
</a><a href="#h358-0-140" id="h358-0-140" class="d">-                        view.visibility = View.GONE
</a><a href="#h358-0-141" id="h358-0-141" class="d">-                    }
</a><a href="#h358-0-142" id="h358-0-142" class="d">-                    addOnLayoutChangeListener { view, _, _, _, _, _, _, _, _ -&gt;
</a><a href="#h358-0-143" id="h358-0-143" class="d">-                        view.post { view.visibility = View.GONE }
</a><a href="#h358-0-144" id="h358-0-144" class="d">-                    }
</a><a href="#h358-0-145" id="h358-0-145" class="d">-                }
</a><a href="#h358-0-146" id="h358-0-146" class="d">-            }
</a><a href="#h358-0-147" id="h358-0-147" class="d">-        }
</a><a href="#h358-0-148" id="h358-0-148" class="d">-    }
</a><a href="#h358-0-149" id="h358-0-149" class="d">-}</a><a href="#h358-0-150" id="h358-0-150" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h359" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/hook/HookAdapter.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/hook/HookAdapter.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/hook/HookAdapter.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/hook/HookAdapter.kt</a></b>
<a href="#h359-0" id="h359-0" class="h">@@ -1,76 +0,0 @@
</a><a href="#h359-0-0" id="h359-0-0" class="d">-package me.rhunk.snapenhance.hook
</a><a href="#h359-0-1" id="h359-0-1" class="d">-
</a><a href="#h359-0-2" id="h359-0-2" class="d">-import de.robv.android.xposed.XC_MethodHook
</a><a href="#h359-0-3" id="h359-0-3" class="d">-import de.robv.android.xposed.XposedBridge
</a><a href="#h359-0-4" id="h359-0-4" class="d">-import java.lang.reflect.Member
</a><a href="#h359-0-5" id="h359-0-5" class="d">-import java.util.function.Consumer
</a><a href="#h359-0-6" id="h359-0-6" class="d">-
</a><a href="#h359-0-7" id="h359-0-7" class="d">-@Suppress(&quot;UNCHECKED_CAST&quot;)
</a><a href="#h359-0-8" id="h359-0-8" class="d">-class HookAdapter(
</a><a href="#h359-0-9" id="h359-0-9" class="d">-    private val methodHookParam: XC_MethodHook.MethodHookParam&lt;*&gt;
</a><a href="#h359-0-10" id="h359-0-10" class="d">-) {
</a><a href="#h359-0-11" id="h359-0-11" class="d">-    fun &lt;T : Any&gt; thisObject(): T {
</a><a href="#h359-0-12" id="h359-0-12" class="d">-        return methodHookParam.thisObject as T
</a><a href="#h359-0-13" id="h359-0-13" class="d">-    }
</a><a href="#h359-0-14" id="h359-0-14" class="d">-
</a><a href="#h359-0-15" id="h359-0-15" class="d">-    fun &lt;T : Any&gt; nullableThisObject(): T? {
</a><a href="#h359-0-16" id="h359-0-16" class="d">-        return methodHookParam.thisObject as T?
</a><a href="#h359-0-17" id="h359-0-17" class="d">-    }
</a><a href="#h359-0-18" id="h359-0-18" class="d">-
</a><a href="#h359-0-19" id="h359-0-19" class="d">-    fun method(): Member {
</a><a href="#h359-0-20" id="h359-0-20" class="d">-        return methodHookParam.method
</a><a href="#h359-0-21" id="h359-0-21" class="d">-    }
</a><a href="#h359-0-22" id="h359-0-22" class="d">-
</a><a href="#h359-0-23" id="h359-0-23" class="d">-    fun &lt;T : Any&gt; arg(index: Int): T {
</a><a href="#h359-0-24" id="h359-0-24" class="d">-        return methodHookParam.args[index] as T
</a><a href="#h359-0-25" id="h359-0-25" class="d">-    }
</a><a href="#h359-0-26" id="h359-0-26" class="d">-
</a><a href="#h359-0-27" id="h359-0-27" class="d">-    fun &lt;T : Any&gt; argNullable(index: Int): T? {
</a><a href="#h359-0-28" id="h359-0-28" class="d">-        return methodHookParam.args.getOrNull(index) as T?
</a><a href="#h359-0-29" id="h359-0-29" class="d">-    }
</a><a href="#h359-0-30" id="h359-0-30" class="d">-
</a><a href="#h359-0-31" id="h359-0-31" class="d">-    fun setArg(index: Int, value: Any?) {
</a><a href="#h359-0-32" id="h359-0-32" class="d">-        if (index &lt; 0 || index &gt;= methodHookParam.args.size) return
</a><a href="#h359-0-33" id="h359-0-33" class="d">-        methodHookParam.args[index] = value
</a><a href="#h359-0-34" id="h359-0-34" class="d">-    }
</a><a href="#h359-0-35" id="h359-0-35" class="d">-
</a><a href="#h359-0-36" id="h359-0-36" class="d">-    fun args(): Array&lt;Any?&gt; {
</a><a href="#h359-0-37" id="h359-0-37" class="d">-        return methodHookParam.args
</a><a href="#h359-0-38" id="h359-0-38" class="d">-    }
</a><a href="#h359-0-39" id="h359-0-39" class="d">-
</a><a href="#h359-0-40" id="h359-0-40" class="d">-    fun getResult(): Any? {
</a><a href="#h359-0-41" id="h359-0-41" class="d">-        return methodHookParam.result
</a><a href="#h359-0-42" id="h359-0-42" class="d">-    }
</a><a href="#h359-0-43" id="h359-0-43" class="d">-
</a><a href="#h359-0-44" id="h359-0-44" class="d">-    fun setResult(result: Any?) {
</a><a href="#h359-0-45" id="h359-0-45" class="d">-        methodHookParam.result = result
</a><a href="#h359-0-46" id="h359-0-46" class="d">-    }
</a><a href="#h359-0-47" id="h359-0-47" class="d">-
</a><a href="#h359-0-48" id="h359-0-48" class="d">-    fun setThrowable(throwable: Throwable) {
</a><a href="#h359-0-49" id="h359-0-49" class="d">-        methodHookParam.throwable = throwable
</a><a href="#h359-0-50" id="h359-0-50" class="d">-    }
</a><a href="#h359-0-51" id="h359-0-51" class="d">-
</a><a href="#h359-0-52" id="h359-0-52" class="d">-    fun throwable(): Throwable? {
</a><a href="#h359-0-53" id="h359-0-53" class="d">-        return methodHookParam.throwable
</a><a href="#h359-0-54" id="h359-0-54" class="d">-    }
</a><a href="#h359-0-55" id="h359-0-55" class="d">-
</a><a href="#h359-0-56" id="h359-0-56" class="d">-    fun invokeOriginal(): Any? {
</a><a href="#h359-0-57" id="h359-0-57" class="d">-        return XposedBridge.invokeOriginalMethod(method(), thisObject(), args())
</a><a href="#h359-0-58" id="h359-0-58" class="d">-    }
</a><a href="#h359-0-59" id="h359-0-59" class="d">-
</a><a href="#h359-0-60" id="h359-0-60" class="d">-    fun invokeOriginal(args: Array&lt;Any&gt;): Any? {
</a><a href="#h359-0-61" id="h359-0-61" class="d">-        return XposedBridge.invokeOriginalMethod(method(), thisObject(), args)
</a><a href="#h359-0-62" id="h359-0-62" class="d">-    }
</a><a href="#h359-0-63" id="h359-0-63" class="d">-
</a><a href="#h359-0-64" id="h359-0-64" class="d">-    fun invokeOriginalSafe(errorCallback: Consumer&lt;Throwable&gt;) {
</a><a href="#h359-0-65" id="h359-0-65" class="d">-        invokeOriginalSafe(args(), errorCallback)
</a><a href="#h359-0-66" id="h359-0-66" class="d">-    }
</a><a href="#h359-0-67" id="h359-0-67" class="d">-
</a><a href="#h359-0-68" id="h359-0-68" class="d">-    fun invokeOriginalSafe(args: Array&lt;Any?&gt;, errorCallback: Consumer&lt;Throwable&gt;) {
</a><a href="#h359-0-69" id="h359-0-69" class="d">-        runCatching {
</a><a href="#h359-0-70" id="h359-0-70" class="d">-            setResult(XposedBridge.invokeOriginalMethod(method(), thisObject(), args))
</a><a href="#h359-0-71" id="h359-0-71" class="d">-        }.onFailure {
</a><a href="#h359-0-72" id="h359-0-72" class="d">-            errorCallback.accept(it)
</a><a href="#h359-0-73" id="h359-0-73" class="d">-        }
</a><a href="#h359-0-74" id="h359-0-74" class="d">-    }
</a><a href="#h359-0-75" id="h359-0-75" class="d">-}</a><a href="#h359-0-76" id="h359-0-76" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h360" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/hook/HookStage.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/hook/HookStage.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/hook/HookStage.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/hook/HookStage.kt</a></b>
<a href="#h360-0" id="h360-0" class="h">@@ -1,6 +0,0 @@
</a><a href="#h360-0-0" id="h360-0-0" class="d">-package me.rhunk.snapenhance.hook
</a><a href="#h360-0-1" id="h360-0-1" class="d">-
</a><a href="#h360-0-2" id="h360-0-2" class="d">-enum class HookStage {
</a><a href="#h360-0-3" id="h360-0-3" class="d">-    BEFORE,
</a><a href="#h360-0-4" id="h360-0-4" class="d">-    AFTER
</a><a href="#h360-0-5" id="h360-0-5" class="d">-}</a><a href="#h360-0-6" id="h360-0-6" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h361" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/hook/Hooker.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/hook/Hooker.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/hook/Hooker.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/hook/Hooker.kt</a></b>
<a href="#h361-0" id="h361-0" class="h">@@ -1,157 +0,0 @@
</a><a href="#h361-0-0" id="h361-0-0" class="d">-package me.rhunk.snapenhance.hook
</a><a href="#h361-0-1" id="h361-0-1" class="d">-
</a><a href="#h361-0-2" id="h361-0-2" class="d">-import de.robv.android.xposed.XC_MethodHook
</a><a href="#h361-0-3" id="h361-0-3" class="d">-import de.robv.android.xposed.XposedBridge
</a><a href="#h361-0-4" id="h361-0-4" class="d">-import java.lang.reflect.Member
</a><a href="#h361-0-5" id="h361-0-5" class="d">-import java.lang.reflect.Method
</a><a href="#h361-0-6" id="h361-0-6" class="d">-
</a><a href="#h361-0-7" id="h361-0-7" class="d">-object Hooker {
</a><a href="#h361-0-8" id="h361-0-8" class="d">-    inline fun newMethodHook(
</a><a href="#h361-0-9" id="h361-0-9" class="d">-        stage: HookStage,
</a><a href="#h361-0-10" id="h361-0-10" class="d">-        crossinline consumer: (HookAdapter) -&gt; Unit,
</a><a href="#h361-0-11" id="h361-0-11" class="d">-        crossinline filter: ((HookAdapter) -&gt; Boolean) = { true }
</a><a href="#h361-0-12" id="h361-0-12" class="d">-    ): XC_MethodHook {
</a><a href="#h361-0-13" id="h361-0-13" class="d">-        return if (stage == HookStage.BEFORE) object : XC_MethodHook() {
</a><a href="#h361-0-14" id="h361-0-14" class="d">-            override fun beforeHookedMethod(param: MethodHookParam&lt;*&gt;) {
</a><a href="#h361-0-15" id="h361-0-15" class="d">-                HookAdapter(param).takeIf(filter)?.also(consumer)
</a><a href="#h361-0-16" id="h361-0-16" class="d">-            }
</a><a href="#h361-0-17" id="h361-0-17" class="d">-        } else object : XC_MethodHook() {
</a><a href="#h361-0-18" id="h361-0-18" class="d">-            override fun afterHookedMethod(param: MethodHookParam&lt;*&gt;) {
</a><a href="#h361-0-19" id="h361-0-19" class="d">-                HookAdapter(param).takeIf(filter)?.also(consumer)
</a><a href="#h361-0-20" id="h361-0-20" class="d">-            }
</a><a href="#h361-0-21" id="h361-0-21" class="d">-        }
</a><a href="#h361-0-22" id="h361-0-22" class="d">-    }
</a><a href="#h361-0-23" id="h361-0-23" class="d">-
</a><a href="#h361-0-24" id="h361-0-24" class="d">-    inline fun hook(
</a><a href="#h361-0-25" id="h361-0-25" class="d">-        clazz: Class&lt;*&gt;,
</a><a href="#h361-0-26" id="h361-0-26" class="d">-        methodName: String,
</a><a href="#h361-0-27" id="h361-0-27" class="d">-        stage: HookStage,
</a><a href="#h361-0-28" id="h361-0-28" class="d">-        crossinline filter: (HookAdapter) -&gt; Boolean,
</a><a href="#h361-0-29" id="h361-0-29" class="d">-        noinline consumer: (HookAdapter) -&gt; Unit
</a><a href="#h361-0-30" id="h361-0-30" class="d">-    ): Set&lt;XC_MethodHook.Unhook&gt; = XposedBridge.hookAllMethods(clazz, methodName, newMethodHook(stage, consumer, filter))
</a><a href="#h361-0-31" id="h361-0-31" class="d">-
</a><a href="#h361-0-32" id="h361-0-32" class="d">-    inline fun hook(
</a><a href="#h361-0-33" id="h361-0-33" class="d">-        member: Member,
</a><a href="#h361-0-34" id="h361-0-34" class="d">-        stage: HookStage,
</a><a href="#h361-0-35" id="h361-0-35" class="d">-        crossinline filter: ((HookAdapter) -&gt; Boolean),
</a><a href="#h361-0-36" id="h361-0-36" class="d">-        crossinline consumer: (HookAdapter) -&gt; Unit
</a><a href="#h361-0-37" id="h361-0-37" class="d">-    ): XC_MethodHook.Unhook {
</a><a href="#h361-0-38" id="h361-0-38" class="d">-        return XposedBridge.hookMethod(member, newMethodHook(stage, consumer, filter))
</a><a href="#h361-0-39" id="h361-0-39" class="d">-    }
</a><a href="#h361-0-40" id="h361-0-40" class="d">-
</a><a href="#h361-0-41" id="h361-0-41" class="d">-    fun hook(
</a><a href="#h361-0-42" id="h361-0-42" class="d">-        clazz: Class&lt;*&gt;,
</a><a href="#h361-0-43" id="h361-0-43" class="d">-        methodName: String,
</a><a href="#h361-0-44" id="h361-0-44" class="d">-        stage: HookStage,
</a><a href="#h361-0-45" id="h361-0-45" class="d">-        consumer: (HookAdapter) -&gt; Unit
</a><a href="#h361-0-46" id="h361-0-46" class="d">-    ): Set&lt;XC_MethodHook.Unhook&gt; = hook(clazz, methodName, stage, { true }, consumer)
</a><a href="#h361-0-47" id="h361-0-47" class="d">-
</a><a href="#h361-0-48" id="h361-0-48" class="d">-    fun hook(
</a><a href="#h361-0-49" id="h361-0-49" class="d">-        member: Member,
</a><a href="#h361-0-50" id="h361-0-50" class="d">-        stage: HookStage,
</a><a href="#h361-0-51" id="h361-0-51" class="d">-        consumer: (HookAdapter) -&gt; Unit
</a><a href="#h361-0-52" id="h361-0-52" class="d">-    ): XC_MethodHook.Unhook {
</a><a href="#h361-0-53" id="h361-0-53" class="d">-        return hook(member, stage, { true }, consumer)
</a><a href="#h361-0-54" id="h361-0-54" class="d">-    }
</a><a href="#h361-0-55" id="h361-0-55" class="d">-
</a><a href="#h361-0-56" id="h361-0-56" class="d">-    fun hookConstructor(
</a><a href="#h361-0-57" id="h361-0-57" class="d">-        clazz: Class&lt;*&gt;,
</a><a href="#h361-0-58" id="h361-0-58" class="d">-        stage: HookStage,
</a><a href="#h361-0-59" id="h361-0-59" class="d">-        consumer: (HookAdapter) -&gt; Unit
</a><a href="#h361-0-60" id="h361-0-60" class="d">-    ): Set&lt;XC_MethodHook.Unhook&gt; = XposedBridge.hookAllConstructors(clazz, newMethodHook(stage, consumer))
</a><a href="#h361-0-61" id="h361-0-61" class="d">-
</a><a href="#h361-0-62" id="h361-0-62" class="d">-    fun hookConstructor(
</a><a href="#h361-0-63" id="h361-0-63" class="d">-        clazz: Class&lt;*&gt;,
</a><a href="#h361-0-64" id="h361-0-64" class="d">-        stage: HookStage,
</a><a href="#h361-0-65" id="h361-0-65" class="d">-        filter: ((HookAdapter) -&gt; Boolean),
</a><a href="#h361-0-66" id="h361-0-66" class="d">-        consumer: (HookAdapter) -&gt; Unit
</a><a href="#h361-0-67" id="h361-0-67" class="d">-    ) {
</a><a href="#h361-0-68" id="h361-0-68" class="d">-        XposedBridge.hookAllConstructors(clazz, newMethodHook(stage, consumer, filter))
</a><a href="#h361-0-69" id="h361-0-69" class="d">-    }
</a><a href="#h361-0-70" id="h361-0-70" class="d">-
</a><a href="#h361-0-71" id="h361-0-71" class="d">-    inline fun hookObjectMethod(
</a><a href="#h361-0-72" id="h361-0-72" class="d">-        clazz: Class&lt;*&gt;,
</a><a href="#h361-0-73" id="h361-0-73" class="d">-        instance: Any,
</a><a href="#h361-0-74" id="h361-0-74" class="d">-        methodName: String,
</a><a href="#h361-0-75" id="h361-0-75" class="d">-        stage: HookStage,
</a><a href="#h361-0-76" id="h361-0-76" class="d">-        crossinline hookConsumer: (HookAdapter) -&gt; Unit
</a><a href="#h361-0-77" id="h361-0-77" class="d">-    ) {
</a><a href="#h361-0-78" id="h361-0-78" class="d">-        val unhooks: MutableSet&lt;XC_MethodHook.Unhook&gt; = HashSet()
</a><a href="#h361-0-79" id="h361-0-79" class="d">-        hook(clazz, methodName, stage) { param-&gt;
</a><a href="#h361-0-80" id="h361-0-80" class="d">-            if (param.nullableThisObject&lt;Any&gt;().let {
</a><a href="#h361-0-81" id="h361-0-81" class="d">-                if (it == null) unhooks.forEach { u -&gt; u.unhook() }
</a><a href="#h361-0-82" id="h361-0-82" class="d">-                it != instance
</a><a href="#h361-0-83" id="h361-0-83" class="d">-            }) return@hook
</a><a href="#h361-0-84" id="h361-0-84" class="d">-            hookConsumer(param)
</a><a href="#h361-0-85" id="h361-0-85" class="d">-        }.also { unhooks.addAll(it) }
</a><a href="#h361-0-86" id="h361-0-86" class="d">-    }
</a><a href="#h361-0-87" id="h361-0-87" class="d">-
</a><a href="#h361-0-88" id="h361-0-88" class="d">-    inline fun ephemeralHook(
</a><a href="#h361-0-89" id="h361-0-89" class="d">-        clazz: Class&lt;*&gt;,
</a><a href="#h361-0-90" id="h361-0-90" class="d">-        methodName: String,
</a><a href="#h361-0-91" id="h361-0-91" class="d">-        stage: HookStage,
</a><a href="#h361-0-92" id="h361-0-92" class="d">-        crossinline hookConsumer: (HookAdapter) -&gt; Unit
</a><a href="#h361-0-93" id="h361-0-93" class="d">-    ) {
</a><a href="#h361-0-94" id="h361-0-94" class="d">-        val unhooks: MutableSet&lt;XC_MethodHook.Unhook&gt; = HashSet()
</a><a href="#h361-0-95" id="h361-0-95" class="d">-        hook(clazz, methodName, stage) { param-&gt;
</a><a href="#h361-0-96" id="h361-0-96" class="d">-            hookConsumer(param)
</a><a href="#h361-0-97" id="h361-0-97" class="d">-            unhooks.forEach{ it.unhook() }
</a><a href="#h361-0-98" id="h361-0-98" class="d">-        }.also { unhooks.addAll(it) }
</a><a href="#h361-0-99" id="h361-0-99" class="d">-    }
</a><a href="#h361-0-100" id="h361-0-100" class="d">-
</a><a href="#h361-0-101" id="h361-0-101" class="d">-    inline fun ephemeralHookObjectMethod(
</a><a href="#h361-0-102" id="h361-0-102" class="d">-        clazz: Class&lt;*&gt;,
</a><a href="#h361-0-103" id="h361-0-103" class="d">-        instance: Any,
</a><a href="#h361-0-104" id="h361-0-104" class="d">-        methodName: String,
</a><a href="#h361-0-105" id="h361-0-105" class="d">-        stage: HookStage,
</a><a href="#h361-0-106" id="h361-0-106" class="d">-        crossinline hookConsumer: (HookAdapter) -&gt; Unit
</a><a href="#h361-0-107" id="h361-0-107" class="d">-    ) {
</a><a href="#h361-0-108" id="h361-0-108" class="d">-        val unhooks: MutableSet&lt;XC_MethodHook.Unhook&gt; = HashSet()
</a><a href="#h361-0-109" id="h361-0-109" class="d">-        hook(clazz, methodName, stage) { param-&gt;
</a><a href="#h361-0-110" id="h361-0-110" class="d">-            if (param.nullableThisObject&lt;Any&gt;() != instance) return@hook
</a><a href="#h361-0-111" id="h361-0-111" class="d">-            unhooks.forEach { it.unhook() }
</a><a href="#h361-0-112" id="h361-0-112" class="d">-            hookConsumer(param)
</a><a href="#h361-0-113" id="h361-0-113" class="d">-        }.also { unhooks.addAll(it) }
</a><a href="#h361-0-114" id="h361-0-114" class="d">-    }
</a><a href="#h361-0-115" id="h361-0-115" class="d">-}
</a><a href="#h361-0-116" id="h361-0-116" class="d">-
</a><a href="#h361-0-117" id="h361-0-117" class="d">-fun Class&lt;*&gt;.hookConstructor(
</a><a href="#h361-0-118" id="h361-0-118" class="d">-    stage: HookStage,
</a><a href="#h361-0-119" id="h361-0-119" class="d">-    consumer: (HookAdapter) -&gt; Unit
</a><a href="#h361-0-120" id="h361-0-120" class="d">-) = Hooker.hookConstructor(this, stage, consumer)
</a><a href="#h361-0-121" id="h361-0-121" class="d">-
</a><a href="#h361-0-122" id="h361-0-122" class="d">-fun Class&lt;*&gt;.hookConstructor(
</a><a href="#h361-0-123" id="h361-0-123" class="d">-    stage: HookStage,
</a><a href="#h361-0-124" id="h361-0-124" class="d">-    filter: ((HookAdapter) -&gt; Boolean),
</a><a href="#h361-0-125" id="h361-0-125" class="d">-    consumer: (HookAdapter) -&gt; Unit
</a><a href="#h361-0-126" id="h361-0-126" class="d">-) = Hooker.hookConstructor(this, stage, filter, consumer)
</a><a href="#h361-0-127" id="h361-0-127" class="d">-
</a><a href="#h361-0-128" id="h361-0-128" class="d">-fun Class&lt;*&gt;.hook(
</a><a href="#h361-0-129" id="h361-0-129" class="d">-    methodName: String,
</a><a href="#h361-0-130" id="h361-0-130" class="d">-    stage: HookStage,
</a><a href="#h361-0-131" id="h361-0-131" class="d">-    consumer: (HookAdapter) -&gt; Unit
</a><a href="#h361-0-132" id="h361-0-132" class="d">-): Set&lt;XC_MethodHook.Unhook&gt; = Hooker.hook(this, methodName, stage, consumer)
</a><a href="#h361-0-133" id="h361-0-133" class="d">-
</a><a href="#h361-0-134" id="h361-0-134" class="d">-fun Class&lt;*&gt;.hook(
</a><a href="#h361-0-135" id="h361-0-135" class="d">-    methodName: String,
</a><a href="#h361-0-136" id="h361-0-136" class="d">-    stage: HookStage,
</a><a href="#h361-0-137" id="h361-0-137" class="d">-    filter: (HookAdapter) -&gt; Boolean,
</a><a href="#h361-0-138" id="h361-0-138" class="d">-    consumer: (HookAdapter) -&gt; Unit
</a><a href="#h361-0-139" id="h361-0-139" class="d">-): Set&lt;XC_MethodHook.Unhook&gt; = Hooker.hook(this, methodName, stage, filter, consumer)
</a><a href="#h361-0-140" id="h361-0-140" class="d">-
</a><a href="#h361-0-141" id="h361-0-141" class="d">-fun Member.hook(
</a><a href="#h361-0-142" id="h361-0-142" class="d">-    stage: HookStage,
</a><a href="#h361-0-143" id="h361-0-143" class="d">-    consumer: (HookAdapter) -&gt; Unit
</a><a href="#h361-0-144" id="h361-0-144" class="d">-): XC_MethodHook.Unhook = Hooker.hook(this, stage, consumer)
</a><a href="#h361-0-145" id="h361-0-145" class="d">-
</a><a href="#h361-0-146" id="h361-0-146" class="d">-fun Member.hook(
</a><a href="#h361-0-147" id="h361-0-147" class="d">-    stage: HookStage,
</a><a href="#h361-0-148" id="h361-0-148" class="d">-    filter: ((HookAdapter) -&gt; Boolean),
</a><a href="#h361-0-149" id="h361-0-149" class="d">-    consumer: (HookAdapter) -&gt; Unit
</a><a href="#h361-0-150" id="h361-0-150" class="d">-): XC_MethodHook.Unhook = Hooker.hook(this, stage, filter, consumer)
</a><a href="#h361-0-151" id="h361-0-151" class="d">-
</a><a href="#h361-0-152" id="h361-0-152" class="d">-fun Array&lt;Method&gt;.hookAll(stage: HookStage, param: (HookAdapter) -&gt; Unit) {
</a><a href="#h361-0-153" id="h361-0-153" class="d">-    filter { it.declaringClass != Object::class.java }.forEach {
</a><a href="#h361-0-154" id="h361-0-154" class="d">-        it.hook(stage, param)
</a><a href="#h361-0-155" id="h361-0-155" class="d">-    }
</a><a href="#h361-0-156" id="h361-0-156" class="d">-}
</a><b>diff --git a/<a id="h362" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/manager/Manager.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/manager/Manager.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/manager/Manager.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/manager/Manager.kt</a></b>
<a href="#h362-0" id="h362-0" class="h">@@ -1,6 +0,0 @@
</a><a href="#h362-0-0" id="h362-0-0" class="d">-package me.rhunk.snapenhance.manager
</a><a href="#h362-0-1" id="h362-0-1" class="d">-
</a><a href="#h362-0-2" id="h362-0-2" class="d">-interface Manager {
</a><a href="#h362-0-3" id="h362-0-3" class="d">-    fun init() {}
</a><a href="#h362-0-4" id="h362-0-4" class="d">-    fun onActivityCreate() {}
</a><a href="#h362-0-5" id="h362-0-5" class="d">-}</a><a href="#h362-0-6" id="h362-0-6" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h363" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/manager/impl/ActionManager.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/manager/impl/ActionManager.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/manager/impl/ActionManager.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/manager/impl/ActionManager.kt</a></b>
<a href="#h363-0" id="h363-0" class="h">@@ -1,37 +0,0 @@
</a><a href="#h363-0-0" id="h363-0-0" class="d">-package me.rhunk.snapenhance.manager.impl
</a><a href="#h363-0-1" id="h363-0-1" class="d">-
</a><a href="#h363-0-2" id="h363-0-2" class="d">-import android.content.Intent
</a><a href="#h363-0-3" id="h363-0-3" class="d">-import me.rhunk.snapenhance.ModContext
</a><a href="#h363-0-4" id="h363-0-4" class="d">-import me.rhunk.snapenhance.action.AbstractAction
</a><a href="#h363-0-5" id="h363-0-5" class="d">-import me.rhunk.snapenhance.action.EnumAction
</a><a href="#h363-0-6" id="h363-0-6" class="d">-import me.rhunk.snapenhance.manager.Manager
</a><a href="#h363-0-7" id="h363-0-7" class="d">-
</a><a href="#h363-0-8" id="h363-0-8" class="d">-class ActionManager(
</a><a href="#h363-0-9" id="h363-0-9" class="d">-    private val modContext: ModContext,
</a><a href="#h363-0-10" id="h363-0-10" class="d">-) : Manager {
</a><a href="#h363-0-11" id="h363-0-11" class="d">-    companion object {
</a><a href="#h363-0-12" id="h363-0-12" class="d">-        const val ACTION_PARAMETER = &quot;se_action&quot;
</a><a href="#h363-0-13" id="h363-0-13" class="d">-    }
</a><a href="#h363-0-14" id="h363-0-14" class="d">-    private val actions = mutableMapOf&lt;String, AbstractAction&gt;()
</a><a href="#h363-0-15" id="h363-0-15" class="d">-
</a><a href="#h363-0-16" id="h363-0-16" class="d">-    override fun init() {
</a><a href="#h363-0-17" id="h363-0-17" class="d">-        EnumAction.entries.forEach { enumAction -&gt;
</a><a href="#h363-0-18" id="h363-0-18" class="d">-            actions[enumAction.key] = enumAction.clazz.java.getConstructor().newInstance().apply {
</a><a href="#h363-0-19" id="h363-0-19" class="d">-                this.context = modContext
</a><a href="#h363-0-20" id="h363-0-20" class="d">-            }
</a><a href="#h363-0-21" id="h363-0-21" class="d">-        }
</a><a href="#h363-0-22" id="h363-0-22" class="d">-    }
</a><a href="#h363-0-23" id="h363-0-23" class="d">-
</a><a href="#h363-0-24" id="h363-0-24" class="d">-    fun onNewIntent(intent: Intent?) {
</a><a href="#h363-0-25" id="h363-0-25" class="d">-        val action = intent?.getStringExtra(ACTION_PARAMETER) ?: return
</a><a href="#h363-0-26" id="h363-0-26" class="d">-        execute(EnumAction.entries.find { it.key == action } ?: return)
</a><a href="#h363-0-27" id="h363-0-27" class="d">-        intent.removeExtra(ACTION_PARAMETER)
</a><a href="#h363-0-28" id="h363-0-28" class="d">-    }
</a><a href="#h363-0-29" id="h363-0-29" class="d">-
</a><a href="#h363-0-30" id="h363-0-30" class="d">-    fun execute(action: EnumAction) {
</a><a href="#h363-0-31" id="h363-0-31" class="d">-        actions[action.key]?.run()
</a><a href="#h363-0-32" id="h363-0-32" class="d">-        if (action.exitOnFinish) {
</a><a href="#h363-0-33" id="h363-0-33" class="d">-            modContext.forceCloseApp()
</a><a href="#h363-0-34" id="h363-0-34" class="d">-        }
</a><a href="#h363-0-35" id="h363-0-35" class="d">-    }
</a><a href="#h363-0-36" id="h363-0-36" class="d">-}</a><a href="#h363-0-37" id="h363-0-37" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h364" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/manager/impl/FeatureManager.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/manager/impl/FeatureManager.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/manager/impl/FeatureManager.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/manager/impl/FeatureManager.kt</a></b>
<a href="#h364-0" id="h364-0" class="h">@@ -1,171 +0,0 @@
</a><a href="#h364-0-0" id="h364-0-0" class="d">-package me.rhunk.snapenhance.manager.impl
</a><a href="#h364-0-1" id="h364-0-1" class="d">-
</a><a href="#h364-0-2" id="h364-0-2" class="d">-import kotlinx.coroutines.Dispatchers
</a><a href="#h364-0-3" id="h364-0-3" class="d">-import kotlinx.coroutines.launch
</a><a href="#h364-0-4" id="h364-0-4" class="d">-import kotlinx.coroutines.runBlocking
</a><a href="#h364-0-5" id="h364-0-5" class="d">-import me.rhunk.snapenhance.ModContext
</a><a href="#h364-0-6" id="h364-0-6" class="d">-import me.rhunk.snapenhance.core.Logger
</a><a href="#h364-0-7" id="h364-0-7" class="d">-import me.rhunk.snapenhance.features.Feature
</a><a href="#h364-0-8" id="h364-0-8" class="d">-import me.rhunk.snapenhance.features.FeatureLoadParams
</a><a href="#h364-0-9" id="h364-0-9" class="d">-import me.rhunk.snapenhance.features.MessagingRuleFeature
</a><a href="#h364-0-10" id="h364-0-10" class="d">-import me.rhunk.snapenhance.features.impl.ConfigurationOverride
</a><a href="#h364-0-11" id="h364-0-11" class="d">-import me.rhunk.snapenhance.features.impl.Messaging
</a><a href="#h364-0-12" id="h364-0-12" class="d">-import me.rhunk.snapenhance.features.impl.ScopeSync
</a><a href="#h364-0-13" id="h364-0-13" class="d">-import me.rhunk.snapenhance.features.impl.downloader.MediaDownloader
</a><a href="#h364-0-14" id="h364-0-14" class="d">-import me.rhunk.snapenhance.features.impl.downloader.ProfilePictureDownloader
</a><a href="#h364-0-15" id="h364-0-15" class="d">-import me.rhunk.snapenhance.features.impl.experiments.*
</a><a href="#h364-0-16" id="h364-0-16" class="d">-import me.rhunk.snapenhance.features.impl.privacy.DisableMetrics
</a><a href="#h364-0-17" id="h364-0-17" class="d">-import me.rhunk.snapenhance.features.impl.privacy.PreventMessageSending
</a><a href="#h364-0-18" id="h364-0-18" class="d">-import me.rhunk.snapenhance.features.impl.spying.AnonymousStoryViewing
</a><a href="#h364-0-19" id="h364-0-19" class="d">-import me.rhunk.snapenhance.features.impl.spying.MessageLogger
</a><a href="#h364-0-20" id="h364-0-20" class="d">-import me.rhunk.snapenhance.features.impl.spying.PreventReadReceipts
</a><a href="#h364-0-21" id="h364-0-21" class="d">-import me.rhunk.snapenhance.features.impl.spying.SnapToChatMedia
</a><a href="#h364-0-22" id="h364-0-22" class="d">-import me.rhunk.snapenhance.features.impl.spying.StealthMode
</a><a href="#h364-0-23" id="h364-0-23" class="d">-import me.rhunk.snapenhance.features.impl.tweaks.*
</a><a href="#h364-0-24" id="h364-0-24" class="d">-import me.rhunk.snapenhance.features.impl.ui.ClientBootstrapOverride
</a><a href="#h364-0-25" id="h364-0-25" class="d">-import me.rhunk.snapenhance.features.impl.ui.FriendFeedMessagePreview
</a><a href="#h364-0-26" id="h364-0-26" class="d">-import me.rhunk.snapenhance.features.impl.ui.HideStreakRestore
</a><a href="#h364-0-27" id="h364-0-27" class="d">-import me.rhunk.snapenhance.features.impl.ui.PinConversations
</a><a href="#h364-0-28" id="h364-0-28" class="d">-import me.rhunk.snapenhance.features.impl.ui.UITweaks
</a><a href="#h364-0-29" id="h364-0-29" class="d">-import me.rhunk.snapenhance.manager.Manager
</a><a href="#h364-0-30" id="h364-0-30" class="d">-import me.rhunk.snapenhance.ui.menu.impl.MenuViewInjector
</a><a href="#h364-0-31" id="h364-0-31" class="d">-import kotlin.reflect.KClass
</a><a href="#h364-0-32" id="h364-0-32" class="d">-import kotlin.system.measureTimeMillis
</a><a href="#h364-0-33" id="h364-0-33" class="d">-
</a><a href="#h364-0-34" id="h364-0-34" class="d">-class FeatureManager(
</a><a href="#h364-0-35" id="h364-0-35" class="d">-    private val context: ModContext
</a><a href="#h364-0-36" id="h364-0-36" class="d">-) : Manager {
</a><a href="#h364-0-37" id="h364-0-37" class="d">-    private val features = mutableListOf&lt;Feature&gt;()
</a><a href="#h364-0-38" id="h364-0-38" class="d">-
</a><a href="#h364-0-39" id="h364-0-39" class="d">-    private fun register(vararg featureClasses: KClass&lt;out Feature&gt;) {
</a><a href="#h364-0-40" id="h364-0-40" class="d">-        runBlocking {
</a><a href="#h364-0-41" id="h364-0-41" class="d">-            featureClasses.forEach { clazz -&gt;
</a><a href="#h364-0-42" id="h364-0-42" class="d">-                launch(Dispatchers.IO) {
</a><a href="#h364-0-43" id="h364-0-43" class="d">-                    runCatching {
</a><a href="#h364-0-44" id="h364-0-44" class="d">-                        clazz.java.constructors.first().newInstance()
</a><a href="#h364-0-45" id="h364-0-45" class="d">-                            .let { it as Feature }
</a><a href="#h364-0-46" id="h364-0-46" class="d">-                            .also {
</a><a href="#h364-0-47" id="h364-0-47" class="d">-                                it.context = context
</a><a href="#h364-0-48" id="h364-0-48" class="d">-                                synchronized(features) {
</a><a href="#h364-0-49" id="h364-0-49" class="d">-                                    features.add(it)
</a><a href="#h364-0-50" id="h364-0-50" class="d">-                                }
</a><a href="#h364-0-51" id="h364-0-51" class="d">-                            }
</a><a href="#h364-0-52" id="h364-0-52" class="d">-                    }.onFailure {
</a><a href="#h364-0-53" id="h364-0-53" class="d">-                        Logger.xposedLog(&quot;Failed to register feature ${clazz.simpleName}&quot;, it)
</a><a href="#h364-0-54" id="h364-0-54" class="d">-                    }
</a><a href="#h364-0-55" id="h364-0-55" class="d">-                }
</a><a href="#h364-0-56" id="h364-0-56" class="d">-            }
</a><a href="#h364-0-57" id="h364-0-57" class="d">-        }
</a><a href="#h364-0-58" id="h364-0-58" class="d">-    }
</a><a href="#h364-0-59" id="h364-0-59" class="d">-
</a><a href="#h364-0-60" id="h364-0-60" class="d">-    @Suppress(&quot;UNCHECKED_CAST&quot;)
</a><a href="#h364-0-61" id="h364-0-61" class="d">-    fun &lt;T : Feature&gt; get(featureClass: KClass&lt;T&gt;): T? {
</a><a href="#h364-0-62" id="h364-0-62" class="d">-        return features.find { it::class == featureClass } as? T
</a><a href="#h364-0-63" id="h364-0-63" class="d">-    }
</a><a href="#h364-0-64" id="h364-0-64" class="d">-
</a><a href="#h364-0-65" id="h364-0-65" class="d">-    fun getRuleFeatures() = features.filterIsInstance&lt;MessagingRuleFeature&gt;()
</a><a href="#h364-0-66" id="h364-0-66" class="d">-
</a><a href="#h364-0-67" id="h364-0-67" class="d">-    override fun init() {
</a><a href="#h364-0-68" id="h364-0-68" class="d">-        register(
</a><a href="#h364-0-69" id="h364-0-69" class="d">-            EndToEndEncryption::class,
</a><a href="#h364-0-70" id="h364-0-70" class="d">-            ScopeSync::class,
</a><a href="#h364-0-71" id="h364-0-71" class="d">-            Messaging::class,
</a><a href="#h364-0-72" id="h364-0-72" class="d">-            MediaDownloader::class,
</a><a href="#h364-0-73" id="h364-0-73" class="d">-            StealthMode::class,
</a><a href="#h364-0-74" id="h364-0-74" class="d">-            MenuViewInjector::class,
</a><a href="#h364-0-75" id="h364-0-75" class="d">-            PreventReadReceipts::class,
</a><a href="#h364-0-76" id="h364-0-76" class="d">-            AnonymousStoryViewing::class,
</a><a href="#h364-0-77" id="h364-0-77" class="d">-            MessageLogger::class,
</a><a href="#h364-0-78" id="h364-0-78" class="d">-            SnapchatPlus::class,
</a><a href="#h364-0-79" id="h364-0-79" class="d">-            DisableMetrics::class,
</a><a href="#h364-0-80" id="h364-0-80" class="d">-            PreventMessageSending::class,
</a><a href="#h364-0-81" id="h364-0-81" class="d">-            Notifications::class,
</a><a href="#h364-0-82" id="h364-0-82" class="d">-            AutoSave::class,
</a><a href="#h364-0-83" id="h364-0-83" class="d">-            UITweaks::class,
</a><a href="#h364-0-84" id="h364-0-84" class="d">-            ConfigurationOverride::class,
</a><a href="#h364-0-85" id="h364-0-85" class="d">-            SendOverride::class,
</a><a href="#h364-0-86" id="h364-0-86" class="d">-            UnlimitedSnapViewTime::class,
</a><a href="#h364-0-87" id="h364-0-87" class="d">-            BypassVideoLengthRestriction::class,
</a><a href="#h364-0-88" id="h364-0-88" class="d">-            MediaQualityLevelOverride::class,
</a><a href="#h364-0-89" id="h364-0-89" class="d">-            MeoPasscodeBypass::class,
</a><a href="#h364-0-90" id="h364-0-90" class="d">-            AppPasscode::class,
</a><a href="#h364-0-91" id="h364-0-91" class="d">-            LocationSpoofer::class,
</a><a href="#h364-0-92" id="h364-0-92" class="d">-            CameraTweaks::class,
</a><a href="#h364-0-93" id="h364-0-93" class="d">-            InfiniteStoryBoost::class,
</a><a href="#h364-0-94" id="h364-0-94" class="d">-            AmoledDarkMode::class,
</a><a href="#h364-0-95" id="h364-0-95" class="d">-            PinConversations::class,
</a><a href="#h364-0-96" id="h364-0-96" class="d">-            UnlimitedMultiSnap::class,
</a><a href="#h364-0-97" id="h364-0-97" class="d">-            DeviceSpooferHook::class,
</a><a href="#h364-0-98" id="h364-0-98" class="d">-            ClientBootstrapOverride::class,
</a><a href="#h364-0-99" id="h364-0-99" class="d">-            GooglePlayServicesDialogs::class,
</a><a href="#h364-0-100" id="h364-0-100" class="d">-            NoFriendScoreDelay::class,
</a><a href="#h364-0-101" id="h364-0-101" class="d">-            ProfilePictureDownloader::class,
</a><a href="#h364-0-102" id="h364-0-102" class="d">-            AddFriendSourceSpoof::class,
</a><a href="#h364-0-103" id="h364-0-103" class="d">-            DisableReplayInFF::class,
</a><a href="#h364-0-104" id="h364-0-104" class="d">-            OldBitmojiSelfie::class,
</a><a href="#h364-0-105" id="h364-0-105" class="d">-            SnapToChatMedia::class,
</a><a href="#h364-0-106" id="h364-0-106" class="d">-            FriendFeedMessagePreview::class,
</a><a href="#h364-0-107" id="h364-0-107" class="d">-            HideStreakRestore::class,
</a><a href="#h364-0-108" id="h364-0-108" class="d">-        )
</a><a href="#h364-0-109" id="h364-0-109" class="d">-
</a><a href="#h364-0-110" id="h364-0-110" class="d">-        initializeFeatures()
</a><a href="#h364-0-111" id="h364-0-111" class="d">-    }
</a><a href="#h364-0-112" id="h364-0-112" class="d">-
</a><a href="#h364-0-113" id="h364-0-113" class="d">-    private fun initFeatures(
</a><a href="#h364-0-114" id="h364-0-114" class="d">-        syncParam: Int,
</a><a href="#h364-0-115" id="h364-0-115" class="d">-        asyncParam: Int,
</a><a href="#h364-0-116" id="h364-0-116" class="d">-        syncAction: (Feature) -&gt; Unit,
</a><a href="#h364-0-117" id="h364-0-117" class="d">-        asyncAction: (Feature) -&gt; Unit
</a><a href="#h364-0-118" id="h364-0-118" class="d">-    ) {
</a><a href="#h364-0-119" id="h364-0-119" class="d">-        fun tryInit(feature: Feature, block: () -&gt; Unit) {
</a><a href="#h364-0-120" id="h364-0-120" class="d">-            runCatching {
</a><a href="#h364-0-121" id="h364-0-121" class="d">-                block()
</a><a href="#h364-0-122" id="h364-0-122" class="d">-            }.onFailure {
</a><a href="#h364-0-123" id="h364-0-123" class="d">-                context.log.error(&quot;Failed to init feature ${feature.featureKey}&quot;, it)
</a><a href="#h364-0-124" id="h364-0-124" class="d">-                context.longToast(&quot;Failed to init feature ${feature.featureKey}! Check logcat for more details.&quot;)
</a><a href="#h364-0-125" id="h364-0-125" class="d">-            }
</a><a href="#h364-0-126" id="h364-0-126" class="d">-        }
</a><a href="#h364-0-127" id="h364-0-127" class="d">-
</a><a href="#h364-0-128" id="h364-0-128" class="d">-        features.toList().forEach { feature -&gt;
</a><a href="#h364-0-129" id="h364-0-129" class="d">-            if (feature.loadParams and syncParam != 0) {
</a><a href="#h364-0-130" id="h364-0-130" class="d">-                tryInit(feature) {
</a><a href="#h364-0-131" id="h364-0-131" class="d">-                    syncAction(feature)
</a><a href="#h364-0-132" id="h364-0-132" class="d">-                }
</a><a href="#h364-0-133" id="h364-0-133" class="d">-            }
</a><a href="#h364-0-134" id="h364-0-134" class="d">-            if (feature.loadParams and asyncParam != 0) {
</a><a href="#h364-0-135" id="h364-0-135" class="d">-                context.coroutineScope.launch {
</a><a href="#h364-0-136" id="h364-0-136" class="d">-                    tryInit(feature) {
</a><a href="#h364-0-137" id="h364-0-137" class="d">-                        asyncAction(feature)
</a><a href="#h364-0-138" id="h364-0-138" class="d">-                    }
</a><a href="#h364-0-139" id="h364-0-139" class="d">-                }
</a><a href="#h364-0-140" id="h364-0-140" class="d">-            }
</a><a href="#h364-0-141" id="h364-0-141" class="d">-        }
</a><a href="#h364-0-142" id="h364-0-142" class="d">-    }
</a><a href="#h364-0-143" id="h364-0-143" class="d">-
</a><a href="#h364-0-144" id="h364-0-144" class="d">-    private fun initializeFeatures() {
</a><a href="#h364-0-145" id="h364-0-145" class="d">-        //TODO: async called when all features are initiated ?
</a><a href="#h364-0-146" id="h364-0-146" class="d">-        measureTimeMillis {
</a><a href="#h364-0-147" id="h364-0-147" class="d">-            initFeatures(
</a><a href="#h364-0-148" id="h364-0-148" class="d">-                FeatureLoadParams.INIT_SYNC,
</a><a href="#h364-0-149" id="h364-0-149" class="d">-                FeatureLoadParams.INIT_ASYNC,
</a><a href="#h364-0-150" id="h364-0-150" class="d">-                Feature::init,
</a><a href="#h364-0-151" id="h364-0-151" class="d">-                Feature::asyncInit
</a><a href="#h364-0-152" id="h364-0-152" class="d">-            )
</a><a href="#h364-0-153" id="h364-0-153" class="d">-        }.also {
</a><a href="#h364-0-154" id="h364-0-154" class="d">-            context.log.verbose(&quot;feature manager init took $it ms&quot;)
</a><a href="#h364-0-155" id="h364-0-155" class="d">-        }
</a><a href="#h364-0-156" id="h364-0-156" class="d">-    }
</a><a href="#h364-0-157" id="h364-0-157" class="d">-
</a><a href="#h364-0-158" id="h364-0-158" class="d">-    override fun onActivityCreate() {
</a><a href="#h364-0-159" id="h364-0-159" class="d">-        measureTimeMillis {
</a><a href="#h364-0-160" id="h364-0-160" class="d">-            initFeatures(
</a><a href="#h364-0-161" id="h364-0-161" class="d">-                FeatureLoadParams.ACTIVITY_CREATE_SYNC,
</a><a href="#h364-0-162" id="h364-0-162" class="d">-                FeatureLoadParams.ACTIVITY_CREATE_ASYNC,
</a><a href="#h364-0-163" id="h364-0-163" class="d">-                Feature::onActivityCreate,
</a><a href="#h364-0-164" id="h364-0-164" class="d">-                Feature::asyncOnActivityCreate
</a><a href="#h364-0-165" id="h364-0-165" class="d">-            )
</a><a href="#h364-0-166" id="h364-0-166" class="d">-        }.also {
</a><a href="#h364-0-167" id="h364-0-167" class="d">-            context.log.verbose(&quot;feature manager onActivityCreate took $it ms&quot;)
</a><a href="#h364-0-168" id="h364-0-168" class="d">-        }
</a><a href="#h364-0-169" id="h364-0-169" class="d">-    }
</a><a href="#h364-0-170" id="h364-0-170" class="d">-}</a><a href="#h364-0-171" id="h364-0-171" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h365" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/scripting/IPCInterface.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/scripting/IPCInterface.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/scripting/IPCInterface.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/scripting/IPCInterface.kt</a></b>
<a href="#h365-0" id="h365-0" class="h">@@ -1,17 +0,0 @@
</a><a href="#h365-0-0" id="h365-0-0" class="d">-package me.rhunk.snapenhance.scripting
</a><a href="#h365-0-1" id="h365-0-1" class="d">-
</a><a href="#h365-0-2" id="h365-0-2" class="d">-typealias Listener = (Array&lt;out String?&gt;) -&gt; Unit
</a><a href="#h365-0-3" id="h365-0-3" class="d">-
</a><a href="#h365-0-4" id="h365-0-4" class="d">-abstract class IPCInterface {
</a><a href="#h365-0-5" id="h365-0-5" class="d">-    abstract fun on(eventName: String, listener: Listener)
</a><a href="#h365-0-6" id="h365-0-6" class="d">-
</a><a href="#h365-0-7" id="h365-0-7" class="d">-    abstract fun onBroadcast(channel: String, eventName: String, listener: Listener)
</a><a href="#h365-0-8" id="h365-0-8" class="d">-
</a><a href="#h365-0-9" id="h365-0-9" class="d">-    abstract fun emit(eventName: String, vararg args: String?)
</a><a href="#h365-0-10" id="h365-0-10" class="d">-    abstract fun broadcast(channel: String, eventName: String, vararg args: String?)
</a><a href="#h365-0-11" id="h365-0-11" class="d">-
</a><a href="#h365-0-12" id="h365-0-12" class="d">-    @Suppress(&quot;unused&quot;)
</a><a href="#h365-0-13" id="h365-0-13" class="d">-    fun emit(eventName: String) = emit(eventName, *emptyArray())
</a><a href="#h365-0-14" id="h365-0-14" class="d">-    @Suppress(&quot;unused&quot;)
</a><a href="#h365-0-15" id="h365-0-15" class="d">-    fun emit(channel: String, eventName: String) = broadcast(channel, eventName)
</a><a href="#h365-0-16" id="h365-0-16" class="d">-}</a><a href="#h365-0-17" id="h365-0-17" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h366" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/scripting/JSModule.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/scripting/JSModule.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/scripting/JSModule.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/scripting/JSModule.kt</a></b>
<a href="#h366-0" id="h366-0" class="h">@@ -1,134 +0,0 @@
</a><a href="#h366-0-0" id="h366-0-0" class="d">-package me.rhunk.snapenhance.scripting
</a><a href="#h366-0-1" id="h366-0-1" class="d">-
</a><a href="#h366-0-2" id="h366-0-2" class="d">-import android.os.Handler
</a><a href="#h366-0-3" id="h366-0-3" class="d">-import android.widget.Toast
</a><a href="#h366-0-4" id="h366-0-4" class="d">-import me.rhunk.snapenhance.scripting.ktx.contextScope
</a><a href="#h366-0-5" id="h366-0-5" class="d">-import me.rhunk.snapenhance.scripting.ktx.putFunction
</a><a href="#h366-0-6" id="h366-0-6" class="d">-import me.rhunk.snapenhance.scripting.ktx.scriptableObject
</a><a href="#h366-0-7" id="h366-0-7" class="d">-import me.rhunk.snapenhance.scripting.type.ModuleInfo
</a><a href="#h366-0-8" id="h366-0-8" class="d">-import org.mozilla.javascript.Function
</a><a href="#h366-0-9" id="h366-0-9" class="d">-import org.mozilla.javascript.NativeJavaObject
</a><a href="#h366-0-10" id="h366-0-10" class="d">-import org.mozilla.javascript.ScriptableObject
</a><a href="#h366-0-11" id="h366-0-11" class="d">-import org.mozilla.javascript.Undefined
</a><a href="#h366-0-12" id="h366-0-12" class="d">-import org.mozilla.javascript.Wrapper
</a><a href="#h366-0-13" id="h366-0-13" class="d">-import java.lang.reflect.Modifier
</a><a href="#h366-0-14" id="h366-0-14" class="d">-
</a><a href="#h366-0-15" id="h366-0-15" class="d">-class JSModule(
</a><a href="#h366-0-16" id="h366-0-16" class="d">-    val scriptRuntime: ScriptRuntime,
</a><a href="#h366-0-17" id="h366-0-17" class="d">-    val moduleInfo: ModuleInfo,
</a><a href="#h366-0-18" id="h366-0-18" class="d">-    val content: String,
</a><a href="#h366-0-19" id="h366-0-19" class="d">-) {
</a><a href="#h366-0-20" id="h366-0-20" class="d">-    private lateinit var moduleObject: ScriptableObject
</a><a href="#h366-0-21" id="h366-0-21" class="d">-
</a><a href="#h366-0-22" id="h366-0-22" class="d">-    fun load(block: ScriptableObject.() -&gt; Unit) {
</a><a href="#h366-0-23" id="h366-0-23" class="d">-        contextScope {
</a><a href="#h366-0-24" id="h366-0-24" class="d">-            val classLoader = scriptRuntime.androidContext.classLoader
</a><a href="#h366-0-25" id="h366-0-25" class="d">-            moduleObject = initSafeStandardObjects()
</a><a href="#h366-0-26" id="h366-0-26" class="d">-            moduleObject.putConst(&quot;module&quot;, moduleObject, scriptableObject {
</a><a href="#h366-0-27" id="h366-0-27" class="d">-                putConst(&quot;info&quot;, this, scriptableObject {
</a><a href="#h366-0-28" id="h366-0-28" class="d">-                    putConst(&quot;name&quot;, this, moduleInfo.name)
</a><a href="#h366-0-29" id="h366-0-29" class="d">-                    putConst(&quot;version&quot;, this, moduleInfo.version)
</a><a href="#h366-0-30" id="h366-0-30" class="d">-                    putConst(&quot;description&quot;, this, moduleInfo.description)
</a><a href="#h366-0-31" id="h366-0-31" class="d">-                    putConst(&quot;author&quot;, this, moduleInfo.author)
</a><a href="#h366-0-32" id="h366-0-32" class="d">-                    putConst(&quot;minSnapchatVersion&quot;, this, moduleInfo.minSnapchatVersion)
</a><a href="#h366-0-33" id="h366-0-33" class="d">-                    putConst(&quot;minSEVersion&quot;, this, moduleInfo.minSEVersion)
</a><a href="#h366-0-34" id="h366-0-34" class="d">-                    putConst(&quot;grantPermissions&quot;, this, moduleInfo.grantPermissions)
</a><a href="#h366-0-35" id="h366-0-35" class="d">-                })
</a><a href="#h366-0-36" id="h366-0-36" class="d">-            })
</a><a href="#h366-0-37" id="h366-0-37" class="d">-
</a><a href="#h366-0-38" id="h366-0-38" class="d">-            moduleObject.putFunction(&quot;setField&quot;) { args -&gt;
</a><a href="#h366-0-39" id="h366-0-39" class="d">-                val obj = args?.get(0) as? NativeJavaObject ?: return@putFunction Undefined.instance
</a><a href="#h366-0-40" id="h366-0-40" class="d">-                val name = args[1].toString()
</a><a href="#h366-0-41" id="h366-0-41" class="d">-                val value = args[2]
</a><a href="#h366-0-42" id="h366-0-42" class="d">-                val field = obj.unwrap().javaClass.declaredFields.find { it.name == name } ?: return@putFunction Undefined.instance
</a><a href="#h366-0-43" id="h366-0-43" class="d">-                field.isAccessible = true
</a><a href="#h366-0-44" id="h366-0-44" class="d">-                field.set(obj.unwrap(), value.toPrimitiveValue(lazy { field.type.name }))
</a><a href="#h366-0-45" id="h366-0-45" class="d">-                Undefined.instance
</a><a href="#h366-0-46" id="h366-0-46" class="d">-            }
</a><a href="#h366-0-47" id="h366-0-47" class="d">-
</a><a href="#h366-0-48" id="h366-0-48" class="d">-            moduleObject.putFunction(&quot;getField&quot;) { args -&gt;
</a><a href="#h366-0-49" id="h366-0-49" class="d">-                val obj = args?.get(0) as? NativeJavaObject ?: return@putFunction Undefined.instance
</a><a href="#h366-0-50" id="h366-0-50" class="d">-                val name = args[1].toString()
</a><a href="#h366-0-51" id="h366-0-51" class="d">-                val field = obj.unwrap().javaClass.declaredFields.find { it.name == name } ?: return@putFunction Undefined.instance
</a><a href="#h366-0-52" id="h366-0-52" class="d">-                field.isAccessible = true
</a><a href="#h366-0-53" id="h366-0-53" class="d">-                field.get(obj.unwrap())
</a><a href="#h366-0-54" id="h366-0-54" class="d">-            }
</a><a href="#h366-0-55" id="h366-0-55" class="d">-
</a><a href="#h366-0-56" id="h366-0-56" class="d">-            moduleObject.putFunction(&quot;findClass&quot;) {
</a><a href="#h366-0-57" id="h366-0-57" class="d">-                val className = it?.get(0).toString()
</a><a href="#h366-0-58" id="h366-0-58" class="d">-                classLoader.loadClass(className)
</a><a href="#h366-0-59" id="h366-0-59" class="d">-            }
</a><a href="#h366-0-60" id="h366-0-60" class="d">-
</a><a href="#h366-0-61" id="h366-0-61" class="d">-            moduleObject.putFunction(&quot;type&quot;) { args -&gt;
</a><a href="#h366-0-62" id="h366-0-62" class="d">-                val className = args?.get(0).toString()
</a><a href="#h366-0-63" id="h366-0-63" class="d">-                val clazz = classLoader.loadClass(className)
</a><a href="#h366-0-64" id="h366-0-64" class="d">-
</a><a href="#h366-0-65" id="h366-0-65" class="d">-                scriptableObject(&quot;JavaClassWrapper&quot;) {
</a><a href="#h366-0-66" id="h366-0-66" class="d">-                    putFunction(&quot;newInstance&quot;) newInstance@{ args -&gt;
</a><a href="#h366-0-67" id="h366-0-67" class="d">-                        val constructor = clazz.declaredConstructors.find {
</a><a href="#h366-0-68" id="h366-0-68" class="d">-                            it.parameterCount == (args?.size ?: 0)
</a><a href="#h366-0-69" id="h366-0-69" class="d">-                        } ?: return@newInstance Undefined.instance
</a><a href="#h366-0-70" id="h366-0-70" class="d">-                        constructor.newInstance(*args ?: emptyArray())
</a><a href="#h366-0-71" id="h366-0-71" class="d">-                    }
</a><a href="#h366-0-72" id="h366-0-72" class="d">-
</a><a href="#h366-0-73" id="h366-0-73" class="d">-                    clazz.declaredMethods.filter { Modifier.isStatic(it.modifiers) }.forEach { method -&gt;
</a><a href="#h366-0-74" id="h366-0-74" class="d">-                        putFunction(method.name) { args -&gt;
</a><a href="#h366-0-75" id="h366-0-75" class="d">-                            clazz.declaredMethods.find {
</a><a href="#h366-0-76" id="h366-0-76" class="d">-                                it.name == method.name &amp;&amp; it.parameterTypes.zip(args ?: emptyArray()).all { (type, arg) -&gt;
</a><a href="#h366-0-77" id="h366-0-77" class="d">-                                    type.isAssignableFrom(arg.javaClass)
</a><a href="#h366-0-78" id="h366-0-78" class="d">-                                }
</a><a href="#h366-0-79" id="h366-0-79" class="d">-                            }?.invoke(null, *args ?: emptyArray())
</a><a href="#h366-0-80" id="h366-0-80" class="d">-                        }
</a><a href="#h366-0-81" id="h366-0-81" class="d">-                    }
</a><a href="#h366-0-82" id="h366-0-82" class="d">-
</a><a href="#h366-0-83" id="h366-0-83" class="d">-                    clazz.declaredFields.filter { Modifier.isStatic(it.modifiers) }.forEach { field -&gt;
</a><a href="#h366-0-84" id="h366-0-84" class="d">-                        field.isAccessible = true
</a><a href="#h366-0-85" id="h366-0-85" class="d">-                        defineProperty(field.name, { field.get(null)}, { value -&gt; field.set(null, value) }, 0)
</a><a href="#h366-0-86" id="h366-0-86" class="d">-                    }
</a><a href="#h366-0-87" id="h366-0-87" class="d">-                }
</a><a href="#h366-0-88" id="h366-0-88" class="d">-            }
</a><a href="#h366-0-89" id="h366-0-89" class="d">-
</a><a href="#h366-0-90" id="h366-0-90" class="d">-            moduleObject.putFunction(&quot;logInfo&quot;) { args -&gt;
</a><a href="#h366-0-91" id="h366-0-91" class="d">-                scriptRuntime.logger.info(args?.joinToString(&quot; &quot;) {
</a><a href="#h366-0-92" id="h366-0-92" class="d">-                    when (it) {
</a><a href="#h366-0-93" id="h366-0-93" class="d">-                        is Wrapper -&gt; it.unwrap().toString()
</a><a href="#h366-0-94" id="h366-0-94" class="d">-                        else -&gt; it.toString()
</a><a href="#h366-0-95" id="h366-0-95" class="d">-                    }
</a><a href="#h366-0-96" id="h366-0-96" class="d">-                } ?: &quot;null&quot;)
</a><a href="#h366-0-97" id="h366-0-97" class="d">-                Undefined.instance
</a><a href="#h366-0-98" id="h366-0-98" class="d">-            }
</a><a href="#h366-0-99" id="h366-0-99" class="d">-
</a><a href="#h366-0-100" id="h366-0-100" class="d">-            for (toastFunc in listOf(&quot;longToast&quot;, &quot;shortToast&quot;)) {
</a><a href="#h366-0-101" id="h366-0-101" class="d">-                moduleObject.putFunction(toastFunc) { args -&gt;
</a><a href="#h366-0-102" id="h366-0-102" class="d">-                    Handler(scriptRuntime.androidContext.mainLooper).post {
</a><a href="#h366-0-103" id="h366-0-103" class="d">-                        Toast.makeText(
</a><a href="#h366-0-104" id="h366-0-104" class="d">-                            scriptRuntime.androidContext,
</a><a href="#h366-0-105" id="h366-0-105" class="d">-                            args?.joinToString(&quot; &quot;) ?: &quot;&quot;,
</a><a href="#h366-0-106" id="h366-0-106" class="d">-                            if (toastFunc == &quot;longToast&quot;) Toast.LENGTH_LONG else Toast.LENGTH_SHORT
</a><a href="#h366-0-107" id="h366-0-107" class="d">-                        ).show()
</a><a href="#h366-0-108" id="h366-0-108" class="d">-                    }
</a><a href="#h366-0-109" id="h366-0-109" class="d">-                    Undefined.instance
</a><a href="#h366-0-110" id="h366-0-110" class="d">-                }
</a><a href="#h366-0-111" id="h366-0-111" class="d">-            }
</a><a href="#h366-0-112" id="h366-0-112" class="d">-
</a><a href="#h366-0-113" id="h366-0-113" class="d">-            block(moduleObject)
</a><a href="#h366-0-114" id="h366-0-114" class="d">-            evaluateString(moduleObject, content, moduleInfo.name, 1, null)
</a><a href="#h366-0-115" id="h366-0-115" class="d">-        }
</a><a href="#h366-0-116" id="h366-0-116" class="d">-    }
</a><a href="#h366-0-117" id="h366-0-117" class="d">-
</a><a href="#h366-0-118" id="h366-0-118" class="d">-    fun unload() {
</a><a href="#h366-0-119" id="h366-0-119" class="d">-        callFunction(&quot;module.onUnload&quot;)
</a><a href="#h366-0-120" id="h366-0-120" class="d">-    }
</a><a href="#h366-0-121" id="h366-0-121" class="d">-
</a><a href="#h366-0-122" id="h366-0-122" class="d">-    fun callFunction(name: String, vararg args: Any?) {
</a><a href="#h366-0-123" id="h366-0-123" class="d">-        contextScope {
</a><a href="#h366-0-124" id="h366-0-124" class="d">-            name.split(&quot;.&quot;).also { split -&gt;
</a><a href="#h366-0-125" id="h366-0-125" class="d">-                val function = split.dropLast(1).fold(moduleObject) { obj, key -&gt;
</a><a href="#h366-0-126" id="h366-0-126" class="d">-                    obj.get(key, obj) as? ScriptableObject ?: return@contextScope
</a><a href="#h366-0-127" id="h366-0-127" class="d">-                }.get(split.last(), moduleObject) as? Function ?: return@contextScope
</a><a href="#h366-0-128" id="h366-0-128" class="d">-
</a><a href="#h366-0-129" id="h366-0-129" class="d">-                function.call(this, moduleObject, moduleObject, args)
</a><a href="#h366-0-130" id="h366-0-130" class="d">-            }
</a><a href="#h366-0-131" id="h366-0-131" class="d">-        }
</a><a href="#h366-0-132" id="h366-0-132" class="d">-    }
</a><a href="#h366-0-133" id="h366-0-133" class="d">-}</a><a href="#h366-0-134" id="h366-0-134" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h367" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/scripting/PrimitiveUtil.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/scripting/PrimitiveUtil.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/scripting/PrimitiveUtil.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/scripting/PrimitiveUtil.kt</a></b>
<a href="#h367-0" id="h367-0" class="h">@@ -1,17 +0,0 @@
</a><a href="#h367-0-0" id="h367-0-0" class="d">-package me.rhunk.snapenhance.scripting
</a><a href="#h367-0-1" id="h367-0-1" class="d">-
</a><a href="#h367-0-2" id="h367-0-2" class="d">-fun Any?.toPrimitiveValue(type: Lazy&lt;String&gt;) = when (this) {
</a><a href="#h367-0-3" id="h367-0-3" class="d">-    is Number -&gt; when (type.value) {
</a><a href="#h367-0-4" id="h367-0-4" class="d">-        &quot;byte&quot; -&gt; this.toByte()
</a><a href="#h367-0-5" id="h367-0-5" class="d">-        &quot;short&quot; -&gt; this.toShort()
</a><a href="#h367-0-6" id="h367-0-6" class="d">-        &quot;int&quot; -&gt; this.toInt()
</a><a href="#h367-0-7" id="h367-0-7" class="d">-        &quot;long&quot; -&gt; this.toLong()
</a><a href="#h367-0-8" id="h367-0-8" class="d">-        &quot;float&quot; -&gt; this.toFloat()
</a><a href="#h367-0-9" id="h367-0-9" class="d">-        &quot;double&quot; -&gt; this.toDouble()
</a><a href="#h367-0-10" id="h367-0-10" class="d">-        &quot;boolean&quot; -&gt; this.toByte() != 0.toByte()
</a><a href="#h367-0-11" id="h367-0-11" class="d">-        &quot;char&quot; -&gt; this.toInt().toChar()
</a><a href="#h367-0-12" id="h367-0-12" class="d">-        else -&gt; this
</a><a href="#h367-0-13" id="h367-0-13" class="d">-    }
</a><a href="#h367-0-14" id="h367-0-14" class="d">-    is Boolean -&gt; if (type.value == &quot;boolean&quot;) this.toString().toBoolean() else this
</a><a href="#h367-0-15" id="h367-0-15" class="d">-    else -&gt; this
</a><a href="#h367-0-16" id="h367-0-16" class="d">-}</a><a href="#h367-0-17" id="h367-0-17" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h368" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/scripting/ScriptRuntime.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/scripting/ScriptRuntime.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/scripting/ScriptRuntime.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/scripting/ScriptRuntime.kt</a></b>
<a href="#h368-0" id="h368-0" class="h">@@ -1,90 +0,0 @@
</a><a href="#h368-0-0" id="h368-0-0" class="d">-package me.rhunk.snapenhance.scripting
</a><a href="#h368-0-1" id="h368-0-1" class="d">-
</a><a href="#h368-0-2" id="h368-0-2" class="d">-import android.content.Context
</a><a href="#h368-0-3" id="h368-0-3" class="d">-import me.rhunk.snapenhance.core.logger.AbstractLogger
</a><a href="#h368-0-4" id="h368-0-4" class="d">-import me.rhunk.snapenhance.scripting.type.ModuleInfo
</a><a href="#h368-0-5" id="h368-0-5" class="d">-import org.mozilla.javascript.ScriptableObject
</a><a href="#h368-0-6" id="h368-0-6" class="d">-import java.io.BufferedReader
</a><a href="#h368-0-7" id="h368-0-7" class="d">-import java.io.ByteArrayInputStream
</a><a href="#h368-0-8" id="h368-0-8" class="d">-import java.io.InputStream
</a><a href="#h368-0-9" id="h368-0-9" class="d">-
</a><a href="#h368-0-10" id="h368-0-10" class="d">-open class ScriptRuntime(
</a><a href="#h368-0-11" id="h368-0-11" class="d">-    val androidContext: Context,
</a><a href="#h368-0-12" id="h368-0-12" class="d">-    val logger: AbstractLogger,
</a><a href="#h368-0-13" id="h368-0-13" class="d">-) {
</a><a href="#h368-0-14" id="h368-0-14" class="d">-    var buildModuleObject: ScriptableObject.(JSModule) -&gt; Unit = {}
</a><a href="#h368-0-15" id="h368-0-15" class="d">-    private val modules = mutableMapOf&lt;String, JSModule&gt;()
</a><a href="#h368-0-16" id="h368-0-16" class="d">-
</a><a href="#h368-0-17" id="h368-0-17" class="d">-    fun eachModule(f: JSModule.() -&gt; Unit) {
</a><a href="#h368-0-18" id="h368-0-18" class="d">-        modules.values.forEach { module -&gt;
</a><a href="#h368-0-19" id="h368-0-19" class="d">-            runCatching {
</a><a href="#h368-0-20" id="h368-0-20" class="d">-                module.f()
</a><a href="#h368-0-21" id="h368-0-21" class="d">-            }.onFailure {
</a><a href="#h368-0-22" id="h368-0-22" class="d">-                logger.error(&quot;Failed to run module function in ${module.moduleInfo.name}&quot;, it)
</a><a href="#h368-0-23" id="h368-0-23" class="d">-            }
</a><a href="#h368-0-24" id="h368-0-24" class="d">-        }
</a><a href="#h368-0-25" id="h368-0-25" class="d">-    }
</a><a href="#h368-0-26" id="h368-0-26" class="d">-
</a><a href="#h368-0-27" id="h368-0-27" class="d">-    private fun readModuleInfo(reader: BufferedReader): ModuleInfo {
</a><a href="#h368-0-28" id="h368-0-28" class="d">-        val header = reader.readLine()
</a><a href="#h368-0-29" id="h368-0-29" class="d">-        if (!header.startsWith(&quot;// ==SE_module==&quot;)) {
</a><a href="#h368-0-30" id="h368-0-30" class="d">-            throw Exception(&quot;Invalid module header&quot;)
</a><a href="#h368-0-31" id="h368-0-31" class="d">-        }
</a><a href="#h368-0-32" id="h368-0-32" class="d">-
</a><a href="#h368-0-33" id="h368-0-33" class="d">-        val properties = mutableMapOf&lt;String, String&gt;()
</a><a href="#h368-0-34" id="h368-0-34" class="d">-        while (true) {
</a><a href="#h368-0-35" id="h368-0-35" class="d">-            val line = reader.readLine()
</a><a href="#h368-0-36" id="h368-0-36" class="d">-            if (line.startsWith(&quot;// ==/SE_module==&quot;)) {
</a><a href="#h368-0-37" id="h368-0-37" class="d">-                break
</a><a href="#h368-0-38" id="h368-0-38" class="d">-            }
</a><a href="#h368-0-39" id="h368-0-39" class="d">-            val split = line.replaceFirst(&quot;//&quot;, &quot;&quot;).split(&quot;:&quot;)
</a><a href="#h368-0-40" id="h368-0-40" class="d">-            if (split.size != 2) {
</a><a href="#h368-0-41" id="h368-0-41" class="d">-                throw Exception(&quot;Invalid module property&quot;)
</a><a href="#h368-0-42" id="h368-0-42" class="d">-            }
</a><a href="#h368-0-43" id="h368-0-43" class="d">-            properties[split[0].trim()] = split[1].trim()
</a><a href="#h368-0-44" id="h368-0-44" class="d">-        }
</a><a href="#h368-0-45" id="h368-0-45" class="d">-
</a><a href="#h368-0-46" id="h368-0-46" class="d">-        return ModuleInfo(
</a><a href="#h368-0-47" id="h368-0-47" class="d">-            name = properties[&quot;name&quot;] ?: throw Exception(&quot;Missing module name&quot;),
</a><a href="#h368-0-48" id="h368-0-48" class="d">-            version = properties[&quot;version&quot;] ?: throw Exception(&quot;Missing module version&quot;),
</a><a href="#h368-0-49" id="h368-0-49" class="d">-            description = properties[&quot;description&quot;],
</a><a href="#h368-0-50" id="h368-0-50" class="d">-            author = properties[&quot;author&quot;],
</a><a href="#h368-0-51" id="h368-0-51" class="d">-            minSnapchatVersion = properties[&quot;minSnapchatVersion&quot;]?.toLong(),
</a><a href="#h368-0-52" id="h368-0-52" class="d">-            minSEVersion = properties[&quot;minSEVersion&quot;]?.toLong(),
</a><a href="#h368-0-53" id="h368-0-53" class="d">-            grantPermissions = properties[&quot;permissions&quot;]?.split(&quot;,&quot;)?.map { it.trim() },
</a><a href="#h368-0-54" id="h368-0-54" class="d">-        )
</a><a href="#h368-0-55" id="h368-0-55" class="d">-    }
</a><a href="#h368-0-56" id="h368-0-56" class="d">-
</a><a href="#h368-0-57" id="h368-0-57" class="d">-    fun getModuleInfo(inputStream: InputStream): ModuleInfo {
</a><a href="#h368-0-58" id="h368-0-58" class="d">-        return readModuleInfo(inputStream.bufferedReader())
</a><a href="#h368-0-59" id="h368-0-59" class="d">-    }
</a><a href="#h368-0-60" id="h368-0-60" class="d">-
</a><a href="#h368-0-61" id="h368-0-61" class="d">-    fun reload(path: String, content: String) {
</a><a href="#h368-0-62" id="h368-0-62" class="d">-        unload(path)
</a><a href="#h368-0-63" id="h368-0-63" class="d">-        load(path, content)
</a><a href="#h368-0-64" id="h368-0-64" class="d">-    }
</a><a href="#h368-0-65" id="h368-0-65" class="d">-
</a><a href="#h368-0-66" id="h368-0-66" class="d">-    private fun unload(path: String) {
</a><a href="#h368-0-67" id="h368-0-67" class="d">-        val module = modules[path] ?: return
</a><a href="#h368-0-68" id="h368-0-68" class="d">-        module.unload()
</a><a href="#h368-0-69" id="h368-0-69" class="d">-        modules.remove(path)
</a><a href="#h368-0-70" id="h368-0-70" class="d">-    }
</a><a href="#h368-0-71" id="h368-0-71" class="d">-
</a><a href="#h368-0-72" id="h368-0-72" class="d">-    fun load(path: String, content: String): JSModule? {
</a><a href="#h368-0-73" id="h368-0-73" class="d">-        logger.info(&quot;Loading module $path&quot;)
</a><a href="#h368-0-74" id="h368-0-74" class="d">-        return runCatching {
</a><a href="#h368-0-75" id="h368-0-75" class="d">-            JSModule(
</a><a href="#h368-0-76" id="h368-0-76" class="d">-                scriptRuntime = this,
</a><a href="#h368-0-77" id="h368-0-77" class="d">-                moduleInfo = readModuleInfo(ByteArrayInputStream(content.toByteArray(Charsets.UTF_8)).bufferedReader()),
</a><a href="#h368-0-78" id="h368-0-78" class="d">-                content = content,
</a><a href="#h368-0-79" id="h368-0-79" class="d">-            ).apply {
</a><a href="#h368-0-80" id="h368-0-80" class="d">-                load {
</a><a href="#h368-0-81" id="h368-0-81" class="d">-                    buildModuleObject(this, this@apply)
</a><a href="#h368-0-82" id="h368-0-82" class="d">-                }
</a><a href="#h368-0-83" id="h368-0-83" class="d">-                modules[path] = this
</a><a href="#h368-0-84" id="h368-0-84" class="d">-            }
</a><a href="#h368-0-85" id="h368-0-85" class="d">-        }.onFailure {
</a><a href="#h368-0-86" id="h368-0-86" class="d">-            logger.error(&quot;Failed to load module $path&quot;, it)
</a><a href="#h368-0-87" id="h368-0-87" class="d">-        }.getOrNull()
</a><a href="#h368-0-88" id="h368-0-88" class="d">-    }
</a><a href="#h368-0-89" id="h368-0-89" class="d">-}</a><a href="#h368-0-90" id="h368-0-90" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h369" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/scripting/core/CoreScriptRuntime.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/scripting/core/CoreScriptRuntime.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/scripting/core/CoreScriptRuntime.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/scripting/core/CoreScriptRuntime.kt</a></b>
<a href="#h369-0" id="h369-0" class="h">@@ -1,56 +0,0 @@
</a><a href="#h369-0-0" id="h369-0-0" class="d">-package me.rhunk.snapenhance.scripting.core
</a><a href="#h369-0-1" id="h369-0-1" class="d">-
</a><a href="#h369-0-2" id="h369-0-2" class="d">-import android.content.Context
</a><a href="#h369-0-3" id="h369-0-3" class="d">-import me.rhunk.snapenhance.bridge.scripting.IPCListener
</a><a href="#h369-0-4" id="h369-0-4" class="d">-import me.rhunk.snapenhance.bridge.scripting.IScripting
</a><a href="#h369-0-5" id="h369-0-5" class="d">-import me.rhunk.snapenhance.core.logger.AbstractLogger
</a><a href="#h369-0-6" id="h369-0-6" class="d">-import me.rhunk.snapenhance.scripting.IPCInterface
</a><a href="#h369-0-7" id="h369-0-7" class="d">-import me.rhunk.snapenhance.scripting.Listener
</a><a href="#h369-0-8" id="h369-0-8" class="d">-import me.rhunk.snapenhance.scripting.ScriptRuntime
</a><a href="#h369-0-9" id="h369-0-9" class="d">-import me.rhunk.snapenhance.scripting.core.impl.ScriptHooker
</a><a href="#h369-0-10" id="h369-0-10" class="d">-
</a><a href="#h369-0-11" id="h369-0-11" class="d">-class CoreScriptRuntime(
</a><a href="#h369-0-12" id="h369-0-12" class="d">-    androidContext: Context,
</a><a href="#h369-0-13" id="h369-0-13" class="d">-    logger: AbstractLogger,
</a><a href="#h369-0-14" id="h369-0-14" class="d">-): ScriptRuntime(androidContext, logger) {
</a><a href="#h369-0-15" id="h369-0-15" class="d">-    private val scriptHookers = mutableListOf&lt;ScriptHooker&gt;()
</a><a href="#h369-0-16" id="h369-0-16" class="d">-
</a><a href="#h369-0-17" id="h369-0-17" class="d">-    fun connect(scriptingInterface: IScripting) {
</a><a href="#h369-0-18" id="h369-0-18" class="d">-        scriptingInterface.apply {
</a><a href="#h369-0-19" id="h369-0-19" class="d">-            buildModuleObject = { module -&gt;
</a><a href="#h369-0-20" id="h369-0-20" class="d">-                putConst(&quot;ipc&quot;, this, object: IPCInterface() {
</a><a href="#h369-0-21" id="h369-0-21" class="d">-                    override fun onBroadcast(channel: String, eventName: String, listener: Listener) {
</a><a href="#h369-0-22" id="h369-0-22" class="d">-                        registerIPCListener(channel, eventName, object: IPCListener.Stub() {
</a><a href="#h369-0-23" id="h369-0-23" class="d">-                            override fun onMessage(args: Array&lt;out String?&gt;) {
</a><a href="#h369-0-24" id="h369-0-24" class="d">-                                listener(args)
</a><a href="#h369-0-25" id="h369-0-25" class="d">-                            }
</a><a href="#h369-0-26" id="h369-0-26" class="d">-                        })
</a><a href="#h369-0-27" id="h369-0-27" class="d">-                    }
</a><a href="#h369-0-28" id="h369-0-28" class="d">-
</a><a href="#h369-0-29" id="h369-0-29" class="d">-                    override fun on(eventName: String, listener: Listener) {
</a><a href="#h369-0-30" id="h369-0-30" class="d">-                        onBroadcast(module.moduleInfo.name, eventName, listener)
</a><a href="#h369-0-31" id="h369-0-31" class="d">-                    }
</a><a href="#h369-0-32" id="h369-0-32" class="d">-
</a><a href="#h369-0-33" id="h369-0-33" class="d">-                    override fun emit(eventName: String, vararg args: String?) {
</a><a href="#h369-0-34" id="h369-0-34" class="d">-                        broadcast(module.moduleInfo.name, eventName, *args)
</a><a href="#h369-0-35" id="h369-0-35" class="d">-                    }
</a><a href="#h369-0-36" id="h369-0-36" class="d">-
</a><a href="#h369-0-37" id="h369-0-37" class="d">-                    override fun broadcast(channel: String, eventName: String, vararg args: String?) {
</a><a href="#h369-0-38" id="h369-0-38" class="d">-                        sendIPCMessage(channel, eventName, args)
</a><a href="#h369-0-39" id="h369-0-39" class="d">-                    }
</a><a href="#h369-0-40" id="h369-0-40" class="d">-                })
</a><a href="#h369-0-41" id="h369-0-41" class="d">-                putConst(&quot;hooker&quot;, this, ScriptHooker(module.moduleInfo, logger, androidContext.classLoader).also {
</a><a href="#h369-0-42" id="h369-0-42" class="d">-                    scriptHookers.add(it)
</a><a href="#h369-0-43" id="h369-0-43" class="d">-                })
</a><a href="#h369-0-44" id="h369-0-44" class="d">-            }
</a><a href="#h369-0-45" id="h369-0-45" class="d">-        }
</a><a href="#h369-0-46" id="h369-0-46" class="d">-
</a><a href="#h369-0-47" id="h369-0-47" class="d">-        scriptingInterface.enabledScripts.forEach { path -&gt;
</a><a href="#h369-0-48" id="h369-0-48" class="d">-            runCatching {
</a><a href="#h369-0-49" id="h369-0-49" class="d">-                load(path, scriptingInterface.getScriptContent(path))
</a><a href="#h369-0-50" id="h369-0-50" class="d">-            }.onFailure {
</a><a href="#h369-0-51" id="h369-0-51" class="d">-                logger.error(&quot;Failed to load script $path&quot;, it)
</a><a href="#h369-0-52" id="h369-0-52" class="d">-            }
</a><a href="#h369-0-53" id="h369-0-53" class="d">-        }
</a><a href="#h369-0-54" id="h369-0-54" class="d">-    }
</a><a href="#h369-0-55" id="h369-0-55" class="d">-}</a><a href="#h369-0-56" id="h369-0-56" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h370" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/scripting/core/impl/ScriptHooker.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/scripting/core/impl/ScriptHooker.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/scripting/core/impl/ScriptHooker.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/scripting/core/impl/ScriptHooker.kt</a></b>
<a href="#h370-0" id="h370-0" class="h">@@ -1,161 +0,0 @@
</a><a href="#h370-0-0" id="h370-0-0" class="d">-package me.rhunk.snapenhance.scripting.core.impl
</a><a href="#h370-0-1" id="h370-0-1" class="d">-
</a><a href="#h370-0-2" id="h370-0-2" class="d">-import me.rhunk.snapenhance.core.logger.AbstractLogger
</a><a href="#h370-0-3" id="h370-0-3" class="d">-import me.rhunk.snapenhance.hook.HookAdapter
</a><a href="#h370-0-4" id="h370-0-4" class="d">-import me.rhunk.snapenhance.hook.HookStage
</a><a href="#h370-0-5" id="h370-0-5" class="d">-import me.rhunk.snapenhance.hook.Hooker
</a><a href="#h370-0-6" id="h370-0-6" class="d">-import me.rhunk.snapenhance.hook.hook
</a><a href="#h370-0-7" id="h370-0-7" class="d">-import me.rhunk.snapenhance.hook.hookConstructor
</a><a href="#h370-0-8" id="h370-0-8" class="d">-import me.rhunk.snapenhance.scripting.toPrimitiveValue
</a><a href="#h370-0-9" id="h370-0-9" class="d">-import me.rhunk.snapenhance.scripting.type.ModuleInfo
</a><a href="#h370-0-10" id="h370-0-10" class="d">-import org.mozilla.javascript.annotations.JSGetter
</a><a href="#h370-0-11" id="h370-0-11" class="d">-import org.mozilla.javascript.annotations.JSSetter
</a><a href="#h370-0-12" id="h370-0-12" class="d">-import java.lang.reflect.Constructor
</a><a href="#h370-0-13" id="h370-0-13" class="d">-import java.lang.reflect.Member
</a><a href="#h370-0-14" id="h370-0-14" class="d">-import java.lang.reflect.Method
</a><a href="#h370-0-15" id="h370-0-15" class="d">-
</a><a href="#h370-0-16" id="h370-0-16" class="d">-
</a><a href="#h370-0-17" id="h370-0-17" class="d">-class ScriptHookCallback(
</a><a href="#h370-0-18" id="h370-0-18" class="d">-    private val hookAdapter: HookAdapter
</a><a href="#h370-0-19" id="h370-0-19" class="d">-) {
</a><a href="#h370-0-20" id="h370-0-20" class="d">-    var result
</a><a href="#h370-0-21" id="h370-0-21" class="d">-        @JSGetter(&quot;result&quot;) get() = hookAdapter.getResult()
</a><a href="#h370-0-22" id="h370-0-22" class="d">-        @JSSetter(&quot;result&quot;) set(result) = hookAdapter.setResult(result.toPrimitiveValue(lazy {
</a><a href="#h370-0-23" id="h370-0-23" class="d">-            when (val member = hookAdapter.method()) {
</a><a href="#h370-0-24" id="h370-0-24" class="d">-                is Method -&gt; member.returnType.name
</a><a href="#h370-0-25" id="h370-0-25" class="d">-                else -&gt; &quot;void&quot;
</a><a href="#h370-0-26" id="h370-0-26" class="d">-            }
</a><a href="#h370-0-27" id="h370-0-27" class="d">-        }))
</a><a href="#h370-0-28" id="h370-0-28" class="d">-
</a><a href="#h370-0-29" id="h370-0-29" class="d">-    val thisObject
</a><a href="#h370-0-30" id="h370-0-30" class="d">-        @JSGetter(&quot;thisObject&quot;) get() = hookAdapter.nullableThisObject&lt;Any&gt;()
</a><a href="#h370-0-31" id="h370-0-31" class="d">-
</a><a href="#h370-0-32" id="h370-0-32" class="d">-    val method
</a><a href="#h370-0-33" id="h370-0-33" class="d">-        @JSGetter(&quot;method&quot;) get() = hookAdapter.method()
</a><a href="#h370-0-34" id="h370-0-34" class="d">-
</a><a href="#h370-0-35" id="h370-0-35" class="d">-    val args
</a><a href="#h370-0-36" id="h370-0-36" class="d">-        @JSGetter(&quot;args&quot;) get() = hookAdapter.args().toList()
</a><a href="#h370-0-37" id="h370-0-37" class="d">-
</a><a href="#h370-0-38" id="h370-0-38" class="d">-    private val parameterTypes by lazy {
</a><a href="#h370-0-39" id="h370-0-39" class="d">-        when (val member = hookAdapter.method()) {
</a><a href="#h370-0-40" id="h370-0-40" class="d">-            is Method -&gt; member.parameterTypes
</a><a href="#h370-0-41" id="h370-0-41" class="d">-            is Constructor&lt;*&gt; -&gt; member.parameterTypes
</a><a href="#h370-0-42" id="h370-0-42" class="d">-            else -&gt; emptyArray()
</a><a href="#h370-0-43" id="h370-0-43" class="d">-        }.toList()
</a><a href="#h370-0-44" id="h370-0-44" class="d">-    }
</a><a href="#h370-0-45" id="h370-0-45" class="d">-
</a><a href="#h370-0-46" id="h370-0-46" class="d">-    fun cancel() = hookAdapter.setResult(null)
</a><a href="#h370-0-47" id="h370-0-47" class="d">-
</a><a href="#h370-0-48" id="h370-0-48" class="d">-    fun arg(index: Int) = hookAdapter.argNullable&lt;Any&gt;(index)
</a><a href="#h370-0-49" id="h370-0-49" class="d">-
</a><a href="#h370-0-50" id="h370-0-50" class="d">-    fun setArg(index: Int, value: Any) {
</a><a href="#h370-0-51" id="h370-0-51" class="d">-        hookAdapter.setArg(index, value.toPrimitiveValue(lazy { parameterTypes[index].name }))
</a><a href="#h370-0-52" id="h370-0-52" class="d">-    }
</a><a href="#h370-0-53" id="h370-0-53" class="d">-
</a><a href="#h370-0-54" id="h370-0-54" class="d">-    fun invokeOriginal() = hookAdapter.invokeOriginal()
</a><a href="#h370-0-55" id="h370-0-55" class="d">-
</a><a href="#h370-0-56" id="h370-0-56" class="d">-    fun invokeOriginal(args: Array&lt;Any&gt;) = hookAdapter.invokeOriginal(args.map {
</a><a href="#h370-0-57" id="h370-0-57" class="d">-        it.toPrimitiveValue(lazy { parameterTypes[args.indexOf(it)].name }) ?: it
</a><a href="#h370-0-58" id="h370-0-58" class="d">-    }.toTypedArray())
</a><a href="#h370-0-59" id="h370-0-59" class="d">-
</a><a href="#h370-0-60" id="h370-0-60" class="d">-    override fun toString(): String {
</a><a href="#h370-0-61" id="h370-0-61" class="d">-        return &quot;ScriptHookCallback(\n&quot; +
</a><a href="#h370-0-62" id="h370-0-62" class="d">-                &quot;  thisObject=${ runCatching { thisObject.toString() }.getOrNull() },\n&quot; +
</a><a href="#h370-0-63" id="h370-0-63" class="d">-                &quot;  args=${ runCatching { args.toString() }.getOrNull() }\n&quot; +
</a><a href="#h370-0-64" id="h370-0-64" class="d">-                &quot;  result=${ runCatching { result.toString() }.getOrNull() },\n&quot; +
</a><a href="#h370-0-65" id="h370-0-65" class="d">-                &quot;)&quot;
</a><a href="#h370-0-66" id="h370-0-66" class="d">-    }
</a><a href="#h370-0-67" id="h370-0-67" class="d">-}
</a><a href="#h370-0-68" id="h370-0-68" class="d">-
</a><a href="#h370-0-69" id="h370-0-69" class="d">-
</a><a href="#h370-0-70" id="h370-0-70" class="d">-typealias HookCallback = (ScriptHookCallback) -&gt; Unit
</a><a href="#h370-0-71" id="h370-0-71" class="d">-typealias HookUnhook = () -&gt; Unit
</a><a href="#h370-0-72" id="h370-0-72" class="d">-
</a><a href="#h370-0-73" id="h370-0-73" class="d">-@Suppress(&quot;unused&quot;, &quot;MemberVisibilityCanBePrivate&quot;)
</a><a href="#h370-0-74" id="h370-0-74" class="d">-class ScriptHooker(
</a><a href="#h370-0-75" id="h370-0-75" class="d">-    private val moduleInfo: ModuleInfo,
</a><a href="#h370-0-76" id="h370-0-76" class="d">-    private val logger: AbstractLogger,
</a><a href="#h370-0-77" id="h370-0-77" class="d">-    private val classLoader: ClassLoader
</a><a href="#h370-0-78" id="h370-0-78" class="d">-) {
</a><a href="#h370-0-79" id="h370-0-79" class="d">-    private val hooks = mutableListOf&lt;HookUnhook&gt;()
</a><a href="#h370-0-80" id="h370-0-80" class="d">-
</a><a href="#h370-0-81" id="h370-0-81" class="d">-    // -- search for class members
</a><a href="#h370-0-82" id="h370-0-82" class="d">-
</a><a href="#h370-0-83" id="h370-0-83" class="d">-    private fun findClassSafe(className: String): Class&lt;*&gt;? {
</a><a href="#h370-0-84" id="h370-0-84" class="d">-        return runCatching {
</a><a href="#h370-0-85" id="h370-0-85" class="d">-            classLoader.loadClass(className)
</a><a href="#h370-0-86" id="h370-0-86" class="d">-        }.onFailure {
</a><a href="#h370-0-87" id="h370-0-87" class="d">-            logger.warn(&quot;Failed to load class $className&quot;)
</a><a href="#h370-0-88" id="h370-0-88" class="d">-        }.getOrNull()
</a><a href="#h370-0-89" id="h370-0-89" class="d">-    }
</a><a href="#h370-0-90" id="h370-0-90" class="d">-
</a><a href="#h370-0-91" id="h370-0-91" class="d">-    private fun getHookStageFromString(stage: String): HookStage {
</a><a href="#h370-0-92" id="h370-0-92" class="d">-        return when (stage) {
</a><a href="#h370-0-93" id="h370-0-93" class="d">-            &quot;before&quot; -&gt; HookStage.BEFORE
</a><a href="#h370-0-94" id="h370-0-94" class="d">-            &quot;after&quot; -&gt; HookStage.AFTER
</a><a href="#h370-0-95" id="h370-0-95" class="d">-            else -&gt; throw IllegalArgumentException(&quot;Invalid stage: $stage&quot;)
</a><a href="#h370-0-96" id="h370-0-96" class="d">-        }
</a><a href="#h370-0-97" id="h370-0-97" class="d">-    }
</a><a href="#h370-0-98" id="h370-0-98" class="d">-
</a><a href="#h370-0-99" id="h370-0-99" class="d">-    fun findMethod(clazz: Class&lt;*&gt;, methodName: String): Member? {
</a><a href="#h370-0-100" id="h370-0-100" class="d">-        return clazz.declaredMethods.find { it.name == methodName }
</a><a href="#h370-0-101" id="h370-0-101" class="d">-    }
</a><a href="#h370-0-102" id="h370-0-102" class="d">-
</a><a href="#h370-0-103" id="h370-0-103" class="d">-    fun findMethodWithParameters(clazz: Class&lt;*&gt;, methodName: String, vararg types: String): Member? {
</a><a href="#h370-0-104" id="h370-0-104" class="d">-        return clazz.declaredMethods.find { method -&gt; method.name == methodName &amp;&amp; method.parameterTypes.map { it.name }.toTypedArray() contentEquals types }
</a><a href="#h370-0-105" id="h370-0-105" class="d">-    }
</a><a href="#h370-0-106" id="h370-0-106" class="d">-
</a><a href="#h370-0-107" id="h370-0-107" class="d">-    fun findMethod(className: String, methodName: String): Member? {
</a><a href="#h370-0-108" id="h370-0-108" class="d">-        return findClassSafe(className)?.let { findMethod(it, methodName) }
</a><a href="#h370-0-109" id="h370-0-109" class="d">-    }
</a><a href="#h370-0-110" id="h370-0-110" class="d">-
</a><a href="#h370-0-111" id="h370-0-111" class="d">-    fun findMethodWithParameters(className: String, methodName: String, vararg types: String): Member? {
</a><a href="#h370-0-112" id="h370-0-112" class="d">-        return findClassSafe(className)?.let { findMethodWithParameters(it, methodName, *types) }
</a><a href="#h370-0-113" id="h370-0-113" class="d">-    }
</a><a href="#h370-0-114" id="h370-0-114" class="d">-
</a><a href="#h370-0-115" id="h370-0-115" class="d">-    fun findConstructor(clazz: Class&lt;*&gt;, vararg types: String): Member? {
</a><a href="#h370-0-116" id="h370-0-116" class="d">-        return clazz.declaredConstructors.find { constructor -&gt;  constructor.parameterTypes.map { it.name }.toTypedArray() contentEquals types }
</a><a href="#h370-0-117" id="h370-0-117" class="d">-    }
</a><a href="#h370-0-118" id="h370-0-118" class="d">-
</a><a href="#h370-0-119" id="h370-0-119" class="d">-    fun findConstructorParameters(className: String, vararg types: String): Member? {
</a><a href="#h370-0-120" id="h370-0-120" class="d">-        return findClassSafe(className)?.let { findConstructor(it, *types) }
</a><a href="#h370-0-121" id="h370-0-121" class="d">-    }
</a><a href="#h370-0-122" id="h370-0-122" class="d">-
</a><a href="#h370-0-123" id="h370-0-123" class="d">-    // -- hooking
</a><a href="#h370-0-124" id="h370-0-124" class="d">-
</a><a href="#h370-0-125" id="h370-0-125" class="d">-    fun hook(method: Member, stage: String, callback: HookCallback): HookUnhook {
</a><a href="#h370-0-126" id="h370-0-126" class="d">-        val hookAdapter = Hooker.hook(method, getHookStageFromString(stage)) {
</a><a href="#h370-0-127" id="h370-0-127" class="d">-            callback(ScriptHookCallback(it))
</a><a href="#h370-0-128" id="h370-0-128" class="d">-        }
</a><a href="#h370-0-129" id="h370-0-129" class="d">-
</a><a href="#h370-0-130" id="h370-0-130" class="d">-        return {
</a><a href="#h370-0-131" id="h370-0-131" class="d">-            hookAdapter.unhook()
</a><a href="#h370-0-132" id="h370-0-132" class="d">-        }.also { hooks.add(it) }
</a><a href="#h370-0-133" id="h370-0-133" class="d">-    }
</a><a href="#h370-0-134" id="h370-0-134" class="d">-
</a><a href="#h370-0-135" id="h370-0-135" class="d">-    fun hookAllMethods(clazz: Class&lt;*&gt;, methodName: String, stage: String, callback: HookCallback): HookUnhook {
</a><a href="#h370-0-136" id="h370-0-136" class="d">-        val hookAdapter = clazz.hook(methodName, getHookStageFromString(stage)) {
</a><a href="#h370-0-137" id="h370-0-137" class="d">-            callback(ScriptHookCallback(it))
</a><a href="#h370-0-138" id="h370-0-138" class="d">-        }
</a><a href="#h370-0-139" id="h370-0-139" class="d">-
</a><a href="#h370-0-140" id="h370-0-140" class="d">-        return {
</a><a href="#h370-0-141" id="h370-0-141" class="d">-            hookAdapter.forEach { it.unhook() }
</a><a href="#h370-0-142" id="h370-0-142" class="d">-        }.also { hooks.add(it) }
</a><a href="#h370-0-143" id="h370-0-143" class="d">-    }
</a><a href="#h370-0-144" id="h370-0-144" class="d">-
</a><a href="#h370-0-145" id="h370-0-145" class="d">-    fun hookAllConstructors(clazz: Class&lt;*&gt;, stage: String, callback: HookCallback): HookUnhook {
</a><a href="#h370-0-146" id="h370-0-146" class="d">-        val hookAdapter = clazz.hookConstructor(getHookStageFromString(stage)) {
</a><a href="#h370-0-147" id="h370-0-147" class="d">-            callback(ScriptHookCallback(it))
</a><a href="#h370-0-148" id="h370-0-148" class="d">-        }
</a><a href="#h370-0-149" id="h370-0-149" class="d">-
</a><a href="#h370-0-150" id="h370-0-150" class="d">-        return {
</a><a href="#h370-0-151" id="h370-0-151" class="d">-            hookAdapter.forEach { it.unhook() }
</a><a href="#h370-0-152" id="h370-0-152" class="d">-        }.also { hooks.add(it) }
</a><a href="#h370-0-153" id="h370-0-153" class="d">-    }
</a><a href="#h370-0-154" id="h370-0-154" class="d">-
</a><a href="#h370-0-155" id="h370-0-155" class="d">-    fun hookAllMethods(className: String, methodName: String, stage: String, callback: HookCallback)
</a><a href="#h370-0-156" id="h370-0-156" class="d">-        = findClassSafe(className)?.let { hookAllMethods(it, methodName, stage, callback) }
</a><a href="#h370-0-157" id="h370-0-157" class="d">-
</a><a href="#h370-0-158" id="h370-0-158" class="d">-    fun hookAllConstructors(className: String, stage: String, callback: HookCallback)
</a><a href="#h370-0-159" id="h370-0-159" class="d">-        = findClassSafe(className)?.let { hookAllConstructors(it, stage, callback) }
</a><a href="#h370-0-160" id="h370-0-160" class="d">-}</a><a href="#h370-0-161" id="h370-0-161" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h371" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/scripting/ktx/RhinoKtx.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/scripting/ktx/RhinoKtx.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/scripting/ktx/RhinoKtx.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/scripting/ktx/RhinoKtx.kt</a></b>
<a href="#h371-0" id="h371-0" class="h">@@ -1,43 +0,0 @@
</a><a href="#h371-0-0" id="h371-0-0" class="d">-package me.rhunk.snapenhance.scripting.ktx
</a><a href="#h371-0-1" id="h371-0-1" class="d">-
</a><a href="#h371-0-2" id="h371-0-2" class="d">-import org.mozilla.javascript.Context
</a><a href="#h371-0-3" id="h371-0-3" class="d">-import org.mozilla.javascript.Function
</a><a href="#h371-0-4" id="h371-0-4" class="d">-import org.mozilla.javascript.Scriptable
</a><a href="#h371-0-5" id="h371-0-5" class="d">-import org.mozilla.javascript.ScriptableObject
</a><a href="#h371-0-6" id="h371-0-6" class="d">-
</a><a href="#h371-0-7" id="h371-0-7" class="d">-fun contextScope(f: Context.() -&gt; Unit) {
</a><a href="#h371-0-8" id="h371-0-8" class="d">-    val context = Context.enter()
</a><a href="#h371-0-9" id="h371-0-9" class="d">-    context.optimizationLevel = -1
</a><a href="#h371-0-10" id="h371-0-10" class="d">-    try {
</a><a href="#h371-0-11" id="h371-0-11" class="d">-        context.f()
</a><a href="#h371-0-12" id="h371-0-12" class="d">-    } finally {
</a><a href="#h371-0-13" id="h371-0-13" class="d">-        Context.exit()
</a><a href="#h371-0-14" id="h371-0-14" class="d">-    }
</a><a href="#h371-0-15" id="h371-0-15" class="d">-}
</a><a href="#h371-0-16" id="h371-0-16" class="d">-
</a><a href="#h371-0-17" id="h371-0-17" class="d">-fun Scriptable.scriptable(name: String): Scriptable? {
</a><a href="#h371-0-18" id="h371-0-18" class="d">-    return this.get(name, this) as? Scriptable
</a><a href="#h371-0-19" id="h371-0-19" class="d">-}
</a><a href="#h371-0-20" id="h371-0-20" class="d">-
</a><a href="#h371-0-21" id="h371-0-21" class="d">-fun Scriptable.function(name: String): Function? {
</a><a href="#h371-0-22" id="h371-0-22" class="d">-    return this.get(name, this) as? Function
</a><a href="#h371-0-23" id="h371-0-23" class="d">-}
</a><a href="#h371-0-24" id="h371-0-24" class="d">-
</a><a href="#h371-0-25" id="h371-0-25" class="d">-fun ScriptableObject.putFunction(name: String, proxy: Scriptable.(Array&lt;out Any&gt;?) -&gt; Any?) {
</a><a href="#h371-0-26" id="h371-0-26" class="d">-    this.putConst(name, this, object: org.mozilla.javascript.BaseFunction() {
</a><a href="#h371-0-27" id="h371-0-27" class="d">-        override fun call(
</a><a href="#h371-0-28" id="h371-0-28" class="d">-            cx: Context?,
</a><a href="#h371-0-29" id="h371-0-29" class="d">-            scope: Scriptable,
</a><a href="#h371-0-30" id="h371-0-30" class="d">-            thisObj: Scriptable,
</a><a href="#h371-0-31" id="h371-0-31" class="d">-            args: Array&lt;out Any&gt;?
</a><a href="#h371-0-32" id="h371-0-32" class="d">-        ): Any? {
</a><a href="#h371-0-33" id="h371-0-33" class="d">-            return thisObj.proxy(args)
</a><a href="#h371-0-34" id="h371-0-34" class="d">-        }
</a><a href="#h371-0-35" id="h371-0-35" class="d">-    })
</a><a href="#h371-0-36" id="h371-0-36" class="d">-}
</a><a href="#h371-0-37" id="h371-0-37" class="d">-
</a><a href="#h371-0-38" id="h371-0-38" class="d">-fun scriptableObject(name: String? = &quot;ScriptableObject&quot;, f: ScriptableObject.() -&gt; Unit): ScriptableObject {
</a><a href="#h371-0-39" id="h371-0-39" class="d">-    return object: ScriptableObject() {
</a><a href="#h371-0-40" id="h371-0-40" class="d">-        override fun getClassName() = name
</a><a href="#h371-0-41" id="h371-0-41" class="d">-    }.apply(f)
</a><a href="#h371-0-42" id="h371-0-42" class="d">-}</a><a href="#h371-0-43" id="h371-0-43" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h372" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/scripting/type/ModuleInfo.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/scripting/type/ModuleInfo.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/scripting/type/ModuleInfo.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/scripting/type/ModuleInfo.kt</a></b>
<a href="#h372-0" id="h372-0" class="h">@@ -1,11 +0,0 @@
</a><a href="#h372-0-0" id="h372-0-0" class="d">-package me.rhunk.snapenhance.scripting.type
</a><a href="#h372-0-1" id="h372-0-1" class="d">-
</a><a href="#h372-0-2" id="h372-0-2" class="d">-data class ModuleInfo(
</a><a href="#h372-0-3" id="h372-0-3" class="d">-    val name: String,
</a><a href="#h372-0-4" id="h372-0-4" class="d">-    val version: String,
</a><a href="#h372-0-5" id="h372-0-5" class="d">-    val description: String? = null,
</a><a href="#h372-0-6" id="h372-0-6" class="d">-    val author: String? = null,
</a><a href="#h372-0-7" id="h372-0-7" class="d">-    val minSnapchatVersion: Long? = null,
</a><a href="#h372-0-8" id="h372-0-8" class="d">-    val minSEVersion: Long? = null,
</a><a href="#h372-0-9" id="h372-0-9" class="d">-    val grantPermissions: List&lt;String&gt;? = null,
</a><a href="#h372-0-10" id="h372-0-10" class="d">-)</a><a href="#h372-0-11" id="h372-0-11" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h373" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/ui/ViewAppearanceHelper.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/ui/ViewAppearanceHelper.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/ui/ViewAppearanceHelper.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/ui/ViewAppearanceHelper.kt</a></b>
<a href="#h373-0" id="h373-0" class="h">@@ -1,141 +0,0 @@
</a><a href="#h373-0-0" id="h373-0-0" class="d">-package me.rhunk.snapenhance.ui
</a><a href="#h373-0-1" id="h373-0-1" class="d">-
</a><a href="#h373-0-2" id="h373-0-2" class="d">-import android.annotation.SuppressLint
</a><a href="#h373-0-3" id="h373-0-3" class="d">-import android.app.AlertDialog
</a><a href="#h373-0-4" id="h373-0-4" class="d">-import android.content.Context
</a><a href="#h373-0-5" id="h373-0-5" class="d">-import android.content.res.ColorStateList
</a><a href="#h373-0-6" id="h373-0-6" class="d">-import android.graphics.Canvas
</a><a href="#h373-0-7" id="h373-0-7" class="d">-import android.graphics.Color
</a><a href="#h373-0-8" id="h373-0-8" class="d">-import android.graphics.Paint
</a><a href="#h373-0-9" id="h373-0-9" class="d">-import android.graphics.drawable.ColorDrawable
</a><a href="#h373-0-10" id="h373-0-10" class="d">-import android.graphics.drawable.Drawable
</a><a href="#h373-0-11" id="h373-0-11" class="d">-import android.graphics.drawable.ShapeDrawable
</a><a href="#h373-0-12" id="h373-0-12" class="d">-import android.graphics.drawable.StateListDrawable
</a><a href="#h373-0-13" id="h373-0-13" class="d">-import android.graphics.drawable.shapes.Shape
</a><a href="#h373-0-14" id="h373-0-14" class="d">-import android.view.Gravity
</a><a href="#h373-0-15" id="h373-0-15" class="d">-import android.view.View
</a><a href="#h373-0-16" id="h373-0-16" class="d">-import android.widget.Switch
</a><a href="#h373-0-17" id="h373-0-17" class="d">-import android.widget.TextView
</a><a href="#h373-0-18" id="h373-0-18" class="d">-import me.rhunk.snapenhance.Constants
</a><a href="#h373-0-19" id="h373-0-19" class="d">-import kotlin.random.Random
</a><a href="#h373-0-20" id="h373-0-20" class="d">-
</a><a href="#h373-0-21" id="h373-0-21" class="d">-fun View.applyTheme(componentWidth: Int? = null, hasRadius: Boolean = false, isAmoled: Boolean = true) {
</a><a href="#h373-0-22" id="h373-0-22" class="d">-    ViewAppearanceHelper.applyTheme(this, componentWidth, hasRadius, isAmoled)
</a><a href="#h373-0-23" id="h373-0-23" class="d">-}
</a><a href="#h373-0-24" id="h373-0-24" class="d">-
</a><a href="#h373-0-25" id="h373-0-25" class="d">-private val foregroundDrawableListTag = Random.nextInt(0x7000000, 0x7FFFFFFF)
</a><a href="#h373-0-26" id="h373-0-26" class="d">-
</a><a href="#h373-0-27" id="h373-0-27" class="d">-@Suppress(&quot;UNCHECKED_CAST&quot;)
</a><a href="#h373-0-28" id="h373-0-28" class="d">-private fun View.getForegroundDrawables(): MutableMap&lt;String, Drawable&gt; {
</a><a href="#h373-0-29" id="h373-0-29" class="d">-    return getTag(foregroundDrawableListTag) as? MutableMap&lt;String, Drawable&gt;
</a><a href="#h373-0-30" id="h373-0-30" class="d">-        ?: mutableMapOf&lt;String, Drawable&gt;().also {
</a><a href="#h373-0-31" id="h373-0-31" class="d">-        setTag(foregroundDrawableListTag, it)
</a><a href="#h373-0-32" id="h373-0-32" class="d">-    }
</a><a href="#h373-0-33" id="h373-0-33" class="d">-}
</a><a href="#h373-0-34" id="h373-0-34" class="d">-
</a><a href="#h373-0-35" id="h373-0-35" class="d">-private fun View.updateForegroundDrawable() {
</a><a href="#h373-0-36" id="h373-0-36" class="d">-    foreground = ShapeDrawable(object: Shape() {
</a><a href="#h373-0-37" id="h373-0-37" class="d">-        override fun draw(canvas: Canvas, paint: Paint) {
</a><a href="#h373-0-38" id="h373-0-38" class="d">-            getForegroundDrawables().forEach { (_, drawable) -&gt;
</a><a href="#h373-0-39" id="h373-0-39" class="d">-                drawable.draw(canvas)
</a><a href="#h373-0-40" id="h373-0-40" class="d">-            }
</a><a href="#h373-0-41" id="h373-0-41" class="d">-        }
</a><a href="#h373-0-42" id="h373-0-42" class="d">-    })
</a><a href="#h373-0-43" id="h373-0-43" class="d">-}
</a><a href="#h373-0-44" id="h373-0-44" class="d">-
</a><a href="#h373-0-45" id="h373-0-45" class="d">-fun View.removeForegroundDrawable(tag: String) {
</a><a href="#h373-0-46" id="h373-0-46" class="d">-    getForegroundDrawables().remove(tag)?.let {
</a><a href="#h373-0-47" id="h373-0-47" class="d">-        updateForegroundDrawable()
</a><a href="#h373-0-48" id="h373-0-48" class="d">-    }
</a><a href="#h373-0-49" id="h373-0-49" class="d">-}
</a><a href="#h373-0-50" id="h373-0-50" class="d">-
</a><a href="#h373-0-51" id="h373-0-51" class="d">-fun View.addForegroundDrawable(tag: String, drawable: Drawable) {
</a><a href="#h373-0-52" id="h373-0-52" class="d">-    getForegroundDrawables()[tag] = drawable
</a><a href="#h373-0-53" id="h373-0-53" class="d">-    updateForegroundDrawable()
</a><a href="#h373-0-54" id="h373-0-54" class="d">-}
</a><a href="#h373-0-55" id="h373-0-55" class="d">-
</a><a href="#h373-0-56" id="h373-0-56" class="d">-
</a><a href="#h373-0-57" id="h373-0-57" class="d">-object ViewAppearanceHelper {
</a><a href="#h373-0-58" id="h373-0-58" class="d">-    @SuppressLint(&quot;UseSwitchCompatOrMaterialCode&quot;, &quot;RtlHardcoded&quot;, &quot;DiscouragedApi&quot;,
</a><a href="#h373-0-59" id="h373-0-59" class="d">-        &quot;ClickableViewAccessibility&quot;
</a><a href="#h373-0-60" id="h373-0-60" class="d">-    )
</a><a href="#h373-0-61" id="h373-0-61" class="d">-    private var sigColorTextPrimary: Int = 0
</a><a href="#h373-0-62" id="h373-0-62" class="d">-    private var sigColorBackgroundSurface: Int = 0
</a><a href="#h373-0-63" id="h373-0-63" class="d">-
</a><a href="#h373-0-64" id="h373-0-64" class="d">-    private fun createRoundedBackground(color: Int, hasRadius: Boolean): Drawable {
</a><a href="#h373-0-65" id="h373-0-65" class="d">-        if (!hasRadius) return ColorDrawable(color)
</a><a href="#h373-0-66" id="h373-0-66" class="d">-        //FIXME: hardcoded radius
</a><a href="#h373-0-67" id="h373-0-67" class="d">-        return ShapeDrawable().apply {
</a><a href="#h373-0-68" id="h373-0-68" class="d">-            paint.color = color
</a><a href="#h373-0-69" id="h373-0-69" class="d">-            shape = android.graphics.drawable.shapes.RoundRectShape(
</a><a href="#h373-0-70" id="h373-0-70" class="d">-                floatArrayOf(20f, 20f, 20f, 20f, 20f, 20f, 20f, 20f),
</a><a href="#h373-0-71" id="h373-0-71" class="d">-                null,
</a><a href="#h373-0-72" id="h373-0-72" class="d">-                null
</a><a href="#h373-0-73" id="h373-0-73" class="d">-            )
</a><a href="#h373-0-74" id="h373-0-74" class="d">-        }
</a><a href="#h373-0-75" id="h373-0-75" class="d">-    }
</a><a href="#h373-0-76" id="h373-0-76" class="d">-
</a><a href="#h373-0-77" id="h373-0-77" class="d">-    @SuppressLint(&quot;DiscouragedApi&quot;)
</a><a href="#h373-0-78" id="h373-0-78" class="d">-    fun applyTheme(component: View, componentWidth: Int? = null, hasRadius: Boolean = false, isAmoled: Boolean = true) {
</a><a href="#h373-0-79" id="h373-0-79" class="d">-        val resources = component.context.resources
</a><a href="#h373-0-80" id="h373-0-80" class="d">-        if (sigColorBackgroundSurface == 0 || sigColorTextPrimary == 0) {
</a><a href="#h373-0-81" id="h373-0-81" class="d">-            with(component.context.theme) {
</a><a href="#h373-0-82" id="h373-0-82" class="d">-                sigColorTextPrimary = obtainStyledAttributes(
</a><a href="#h373-0-83" id="h373-0-83" class="d">-                    intArrayOf(resources.getIdentifier(&quot;sigColorTextPrimary&quot;, &quot;attr&quot;, Constants.SNAPCHAT_PACKAGE_NAME))
</a><a href="#h373-0-84" id="h373-0-84" class="d">-                ).getColor(0, 0)
</a><a href="#h373-0-85" id="h373-0-85" class="d">-
</a><a href="#h373-0-86" id="h373-0-86" class="d">-                sigColorBackgroundSurface = obtainStyledAttributes(
</a><a href="#h373-0-87" id="h373-0-87" class="d">-                    intArrayOf(resources.getIdentifier(&quot;sigColorBackgroundSurface&quot;, &quot;attr&quot;, Constants.SNAPCHAT_PACKAGE_NAME))
</a><a href="#h373-0-88" id="h373-0-88" class="d">-                ).getColor(0, 0)
</a><a href="#h373-0-89" id="h373-0-89" class="d">-            }
</a><a href="#h373-0-90" id="h373-0-90" class="d">-        }
</a><a href="#h373-0-91" id="h373-0-91" class="d">-
</a><a href="#h373-0-92" id="h373-0-92" class="d">-        val snapchatFontResId = resources.getIdentifier(&quot;avenir_next_medium&quot;, &quot;font&quot;, Constants.SNAPCHAT_PACKAGE_NAME)
</a><a href="#h373-0-93" id="h373-0-93" class="d">-        val scalingFactor = resources.displayMetrics.densityDpi.toDouble() / 400
</a><a href="#h373-0-94" id="h373-0-94" class="d">-
</a><a href="#h373-0-95" id="h373-0-95" class="d">-        with(component) {
</a><a href="#h373-0-96" id="h373-0-96" class="d">-            if (this is TextView) {
</a><a href="#h373-0-97" id="h373-0-97" class="d">-                setTextColor(sigColorTextPrimary)
</a><a href="#h373-0-98" id="h373-0-98" class="d">-                setShadowLayer(0F, 0F, 0F, 0)
</a><a href="#h373-0-99" id="h373-0-99" class="d">-                gravity = Gravity.CENTER_VERTICAL
</a><a href="#h373-0-100" id="h373-0-100" class="d">-                componentWidth?.let { width = it}
</a><a href="#h373-0-101" id="h373-0-101" class="d">-                height = (150 * scalingFactor).toInt()
</a><a href="#h373-0-102" id="h373-0-102" class="d">-                isAllCaps = false
</a><a href="#h373-0-103" id="h373-0-103" class="d">-                textSize = 16f
</a><a href="#h373-0-104" id="h373-0-104" class="d">-                typeface = resources.getFont(snapchatFontResId)
</a><a href="#h373-0-105" id="h373-0-105" class="d">-                outlineProvider = null
</a><a href="#h373-0-106" id="h373-0-106" class="d">-                setPadding((40 * scalingFactor).toInt(), 0, (40 * scalingFactor).toInt(), 0)
</a><a href="#h373-0-107" id="h373-0-107" class="d">-            }
</a><a href="#h373-0-108" id="h373-0-108" class="d">-            if (isAmoled) {
</a><a href="#h373-0-109" id="h373-0-109" class="d">-                background = StateListDrawable().apply {
</a><a href="#h373-0-110" id="h373-0-110" class="d">-                    addState(intArrayOf(), createRoundedBackground(color = sigColorBackgroundSurface, hasRadius))
</a><a href="#h373-0-111" id="h373-0-111" class="d">-                    addState(intArrayOf(android.R.attr.state_pressed), createRoundedBackground(color = 0x5395026, hasRadius))
</a><a href="#h373-0-112" id="h373-0-112" class="d">-                }
</a><a href="#h373-0-113" id="h373-0-113" class="d">-            } else {
</a><a href="#h373-0-114" id="h373-0-114" class="d">-                setBackgroundColor(0x0)
</a><a href="#h373-0-115" id="h373-0-115" class="d">-            }
</a><a href="#h373-0-116" id="h373-0-116" class="d">-        }
</a><a href="#h373-0-117" id="h373-0-117" class="d">-
</a><a href="#h373-0-118" id="h373-0-118" class="d">-        if (component is Switch) {
</a><a href="#h373-0-119" id="h373-0-119" class="d">-            with(resources) {
</a><a href="#h373-0-120" id="h373-0-120" class="d">-                component.switchMinWidth = getDimension(getIdentifier(&quot;v11_switch_min_width&quot;, &quot;dimen&quot;, Constants.SNAPCHAT_PACKAGE_NAME)).toInt()
</a><a href="#h373-0-121" id="h373-0-121" class="d">-            }
</a><a href="#h373-0-122" id="h373-0-122" class="d">-            component.trackTintList = ColorStateList(
</a><a href="#h373-0-123" id="h373-0-123" class="d">-                arrayOf(intArrayOf(-android.R.attr.state_checked), intArrayOf(android.R.attr.state_checked)
</a><a href="#h373-0-124" id="h373-0-124" class="d">-                ), intArrayOf(
</a><a href="#h373-0-125" id="h373-0-125" class="d">-                    Color.parseColor(&quot;#1d1d1d&quot;),
</a><a href="#h373-0-126" id="h373-0-126" class="d">-                    Color.parseColor(&quot;#26bd49&quot;)
</a><a href="#h373-0-127" id="h373-0-127" class="d">-                )
</a><a href="#h373-0-128" id="h373-0-128" class="d">-            )
</a><a href="#h373-0-129" id="h373-0-129" class="d">-            component.thumbTintList = ColorStateList(
</a><a href="#h373-0-130" id="h373-0-130" class="d">-                arrayOf(intArrayOf(-android.R.attr.state_checked), intArrayOf(android.R.attr.state_checked)
</a><a href="#h373-0-131" id="h373-0-131" class="d">-                ), intArrayOf(
</a><a href="#h373-0-132" id="h373-0-132" class="d">-                    Color.parseColor(&quot;#F5F5F5&quot;),
</a><a href="#h373-0-133" id="h373-0-133" class="d">-                    Color.parseColor(&quot;#26bd49&quot;)
</a><a href="#h373-0-134" id="h373-0-134" class="d">-                )
</a><a href="#h373-0-135" id="h373-0-135" class="d">-            )
</a><a href="#h373-0-136" id="h373-0-136" class="d">-        }
</a><a href="#h373-0-137" id="h373-0-137" class="d">-    }
</a><a href="#h373-0-138" id="h373-0-138" class="d">-
</a><a href="#h373-0-139" id="h373-0-139" class="d">-    fun newAlertDialogBuilder(context: Context?) = AlertDialog.Builder(context, android.R.style.Theme_DeviceDefault_Dialog_Alert)
</a><a href="#h373-0-140" id="h373-0-140" class="d">-}
</a><b>diff --git a/<a id="h374" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/ui/ViewTagState.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/ui/ViewTagState.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/ui/ViewTagState.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/ui/ViewTagState.kt</a></b>
<a href="#h374-0" id="h374-0" class="h">@@ -1,20 +0,0 @@
</a><a href="#h374-0-0" id="h374-0-0" class="d">-package me.rhunk.snapenhance.ui
</a><a href="#h374-0-1" id="h374-0-1" class="d">-
</a><a href="#h374-0-2" id="h374-0-2" class="d">-import android.view.View
</a><a href="#h374-0-3" id="h374-0-3" class="d">-import kotlin.random.Random
</a><a href="#h374-0-4" id="h374-0-4" class="d">-
</a><a href="#h374-0-5" id="h374-0-5" class="d">-class ViewTagState {
</a><a href="#h374-0-6" id="h374-0-6" class="d">-    private val tag = Random.nextInt(0x7000000, 0x7FFFFFFF)
</a><a href="#h374-0-7" id="h374-0-7" class="d">-
</a><a href="#h374-0-8" id="h374-0-8" class="d">-    operator fun get(view: View) = hasState(view)
</a><a href="#h374-0-9" id="h374-0-9" class="d">-
</a><a href="#h374-0-10" id="h374-0-10" class="d">-    private fun hasState(view: View): Boolean {
</a><a href="#h374-0-11" id="h374-0-11" class="d">-        if (view.getTag(tag) != null) return true
</a><a href="#h374-0-12" id="h374-0-12" class="d">-        view.setTag(tag, true)
</a><a href="#h374-0-13" id="h374-0-13" class="d">-        return false
</a><a href="#h374-0-14" id="h374-0-14" class="d">-    }
</a><a href="#h374-0-15" id="h374-0-15" class="d">-
</a><a href="#h374-0-16" id="h374-0-16" class="d">-    fun removeState(view: View) {
</a><a href="#h374-0-17" id="h374-0-17" class="d">-        view.setTag(tag, null)
</a><a href="#h374-0-18" id="h374-0-18" class="d">-    }
</a><a href="#h374-0-19" id="h374-0-19" class="d">-}</a><a href="#h374-0-20" id="h374-0-20" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h375" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/ui/menu/AbstractMenu.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/ui/menu/AbstractMenu.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/ui/menu/AbstractMenu.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/ui/menu/AbstractMenu.kt</a></b>
<a href="#h375-0" id="h375-0" class="h">@@ -1,9 +0,0 @@
</a><a href="#h375-0-0" id="h375-0-0" class="d">-package me.rhunk.snapenhance.ui.menu
</a><a href="#h375-0-1" id="h375-0-1" class="d">-
</a><a href="#h375-0-2" id="h375-0-2" class="d">-import me.rhunk.snapenhance.ModContext
</a><a href="#h375-0-3" id="h375-0-3" class="d">-
</a><a href="#h375-0-4" id="h375-0-4" class="d">-abstract class AbstractMenu {
</a><a href="#h375-0-5" id="h375-0-5" class="d">-    lateinit var context: ModContext
</a><a href="#h375-0-6" id="h375-0-6" class="d">-
</a><a href="#h375-0-7" id="h375-0-7" class="d">-    open fun init() {}
</a><a href="#h375-0-8" id="h375-0-8" class="d">-}</a><a href="#h375-0-9" id="h375-0-9" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h376" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/ChatActionMenu.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/ChatActionMenu.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/ChatActionMenu.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/ChatActionMenu.kt</a></b>
<a href="#h376-0" id="h376-0" class="h">@@ -1,225 +0,0 @@
</a><a href="#h376-0-0" id="h376-0-0" class="d">-package me.rhunk.snapenhance.ui.menu.impl
</a><a href="#h376-0-1" id="h376-0-1" class="d">-
</a><a href="#h376-0-2" id="h376-0-2" class="d">-import android.annotation.SuppressLint
</a><a href="#h376-0-3" id="h376-0-3" class="d">-import android.content.Context
</a><a href="#h376-0-4" id="h376-0-4" class="d">-import android.os.SystemClock
</a><a href="#h376-0-5" id="h376-0-5" class="d">-import android.view.MotionEvent
</a><a href="#h376-0-6" id="h376-0-6" class="d">-import android.view.View
</a><a href="#h376-0-7" id="h376-0-7" class="d">-import android.view.ViewGroup
</a><a href="#h376-0-8" id="h376-0-8" class="d">-import android.view.ViewGroup.MarginLayoutParams
</a><a href="#h376-0-9" id="h376-0-9" class="d">-import android.widget.Button
</a><a href="#h376-0-10" id="h376-0-10" class="d">-import android.widget.LinearLayout
</a><a href="#h376-0-11" id="h376-0-11" class="d">-import android.widget.TextView
</a><a href="#h376-0-12" id="h376-0-12" class="d">-import me.rhunk.snapenhance.Constants
</a><a href="#h376-0-13" id="h376-0-13" class="d">-import me.rhunk.snapenhance.core.util.protobuf.ProtoReader
</a><a href="#h376-0-14" id="h376-0-14" class="d">-import me.rhunk.snapenhance.data.ContentType
</a><a href="#h376-0-15" id="h376-0-15" class="d">-import me.rhunk.snapenhance.features.impl.Messaging
</a><a href="#h376-0-16" id="h376-0-16" class="d">-import me.rhunk.snapenhance.features.impl.downloader.MediaDownloader
</a><a href="#h376-0-17" id="h376-0-17" class="d">-import me.rhunk.snapenhance.features.impl.spying.MessageLogger
</a><a href="#h376-0-18" id="h376-0-18" class="d">-import me.rhunk.snapenhance.ui.ViewAppearanceHelper
</a><a href="#h376-0-19" id="h376-0-19" class="d">-import me.rhunk.snapenhance.ui.ViewTagState
</a><a href="#h376-0-20" id="h376-0-20" class="d">-import me.rhunk.snapenhance.ui.applyTheme
</a><a href="#h376-0-21" id="h376-0-21" class="d">-import me.rhunk.snapenhance.ui.menu.AbstractMenu
</a><a href="#h376-0-22" id="h376-0-22" class="d">-import java.time.Instant
</a><a href="#h376-0-23" id="h376-0-23" class="d">-
</a><a href="#h376-0-24" id="h376-0-24" class="d">-
</a><a href="#h376-0-25" id="h376-0-25" class="d">-@SuppressLint(&quot;DiscouragedApi&quot;)
</a><a href="#h376-0-26" id="h376-0-26" class="d">-class ChatActionMenu : AbstractMenu() {
</a><a href="#h376-0-27" id="h376-0-27" class="d">-    private val viewTagState = ViewTagState()
</a><a href="#h376-0-28" id="h376-0-28" class="d">-
</a><a href="#h376-0-29" id="h376-0-29" class="d">-    private val defaultGap by lazy {
</a><a href="#h376-0-30" id="h376-0-30" class="d">-        context.androidContext.resources.getDimensionPixelSize(
</a><a href="#h376-0-31" id="h376-0-31" class="d">-            context.androidContext.resources.getIdentifier(
</a><a href="#h376-0-32" id="h376-0-32" class="d">-                &quot;default_gap&quot;,
</a><a href="#h376-0-33" id="h376-0-33" class="d">-                &quot;dimen&quot;,
</a><a href="#h376-0-34" id="h376-0-34" class="d">-                Constants.SNAPCHAT_PACKAGE_NAME
</a><a href="#h376-0-35" id="h376-0-35" class="d">-            )
</a><a href="#h376-0-36" id="h376-0-36" class="d">-        )
</a><a href="#h376-0-37" id="h376-0-37" class="d">-    }
</a><a href="#h376-0-38" id="h376-0-38" class="d">-
</a><a href="#h376-0-39" id="h376-0-39" class="d">-    private val chatActionMenuItemMargin by lazy {
</a><a href="#h376-0-40" id="h376-0-40" class="d">-        context.androidContext.resources.getDimensionPixelSize(
</a><a href="#h376-0-41" id="h376-0-41" class="d">-            context.androidContext.resources.getIdentifier(
</a><a href="#h376-0-42" id="h376-0-42" class="d">-                &quot;chat_action_menu_item_margin&quot;,
</a><a href="#h376-0-43" id="h376-0-43" class="d">-                &quot;dimen&quot;,
</a><a href="#h376-0-44" id="h376-0-44" class="d">-                Constants.SNAPCHAT_PACKAGE_NAME
</a><a href="#h376-0-45" id="h376-0-45" class="d">-            )
</a><a href="#h376-0-46" id="h376-0-46" class="d">-        )
</a><a href="#h376-0-47" id="h376-0-47" class="d">-    }
</a><a href="#h376-0-48" id="h376-0-48" class="d">-
</a><a href="#h376-0-49" id="h376-0-49" class="d">-    private val actionMenuItemHeight by lazy {
</a><a href="#h376-0-50" id="h376-0-50" class="d">-        context.androidContext.resources.getDimensionPixelSize(
</a><a href="#h376-0-51" id="h376-0-51" class="d">-            context.androidContext.resources.getIdentifier(
</a><a href="#h376-0-52" id="h376-0-52" class="d">-                &quot;action_menu_item_height&quot;,
</a><a href="#h376-0-53" id="h376-0-53" class="d">-                &quot;dimen&quot;,
</a><a href="#h376-0-54" id="h376-0-54" class="d">-                Constants.SNAPCHAT_PACKAGE_NAME
</a><a href="#h376-0-55" id="h376-0-55" class="d">-            )
</a><a href="#h376-0-56" id="h376-0-56" class="d">-        )
</a><a href="#h376-0-57" id="h376-0-57" class="d">-    }
</a><a href="#h376-0-58" id="h376-0-58" class="d">-
</a><a href="#h376-0-59" id="h376-0-59" class="d">-    private fun createContainer(viewGroup: ViewGroup): LinearLayout {
</a><a href="#h376-0-60" id="h376-0-60" class="d">-        val parent = viewGroup.parent.parent as ViewGroup
</a><a href="#h376-0-61" id="h376-0-61" class="d">-
</a><a href="#h376-0-62" id="h376-0-62" class="d">-        return LinearLayout(viewGroup.context).apply layout@{
</a><a href="#h376-0-63" id="h376-0-63" class="d">-            orientation = LinearLayout.VERTICAL
</a><a href="#h376-0-64" id="h376-0-64" class="d">-            layoutParams = MarginLayoutParams(
</a><a href="#h376-0-65" id="h376-0-65" class="d">-                ViewGroup.LayoutParams.MATCH_PARENT,
</a><a href="#h376-0-66" id="h376-0-66" class="d">-                ViewGroup.LayoutParams.WRAP_CONTENT
</a><a href="#h376-0-67" id="h376-0-67" class="d">-            ).apply {
</a><a href="#h376-0-68" id="h376-0-68" class="d">-                applyTheme(parent.width, true)
</a><a href="#h376-0-69" id="h376-0-69" class="d">-                setMargins(chatActionMenuItemMargin, 0, chatActionMenuItemMargin, defaultGap)
</a><a href="#h376-0-70" id="h376-0-70" class="d">-            }
</a><a href="#h376-0-71" id="h376-0-71" class="d">-        }
</a><a href="#h376-0-72" id="h376-0-72" class="d">-    }
</a><a href="#h376-0-73" id="h376-0-73" class="d">-
</a><a href="#h376-0-74" id="h376-0-74" class="d">-    private fun copyAlertDialog(context: Context, title: String, text: String) {
</a><a href="#h376-0-75" id="h376-0-75" class="d">-        ViewAppearanceHelper.newAlertDialogBuilder(context).apply {
</a><a href="#h376-0-76" id="h376-0-76" class="d">-            setTitle(title)
</a><a href="#h376-0-77" id="h376-0-77" class="d">-            setMessage(text)
</a><a href="#h376-0-78" id="h376-0-78" class="d">-            setPositiveButton(&quot;OK&quot;) { dialog, _ -&gt; dialog.dismiss() }
</a><a href="#h376-0-79" id="h376-0-79" class="d">-            setNegativeButton(&quot;Copy&quot;) { _, _ -&gt;
</a><a href="#h376-0-80" id="h376-0-80" class="d">-                this@ChatActionMenu.context.copyToClipboard(text, title)
</a><a href="#h376-0-81" id="h376-0-81" class="d">-            }
</a><a href="#h376-0-82" id="h376-0-82" class="d">-        }.show()
</a><a href="#h376-0-83" id="h376-0-83" class="d">-    }
</a><a href="#h376-0-84" id="h376-0-84" class="d">-
</a><a href="#h376-0-85" id="h376-0-85" class="d">-    private val lastFocusedMessage
</a><a href="#h376-0-86" id="h376-0-86" class="d">-        get() = context.database.getConversationMessageFromId(context.feature(Messaging::class).lastFocusedMessageId)
</a><a href="#h376-0-87" id="h376-0-87" class="d">-
</a><a href="#h376-0-88" id="h376-0-88" class="d">-    @SuppressLint(&quot;SetTextI18n&quot;, &quot;DiscouragedApi&quot;, &quot;ClickableViewAccessibility&quot;)
</a><a href="#h376-0-89" id="h376-0-89" class="d">-    fun inject(viewGroup: ViewGroup) {
</a><a href="#h376-0-90" id="h376-0-90" class="d">-        val parent = viewGroup.parent.parent as? ViewGroup ?: return
</a><a href="#h376-0-91" id="h376-0-91" class="d">-        if (viewTagState[parent]) return
</a><a href="#h376-0-92" id="h376-0-92" class="d">-        //close the action menu using a touch event
</a><a href="#h376-0-93" id="h376-0-93" class="d">-        val closeActionMenu = {
</a><a href="#h376-0-94" id="h376-0-94" class="d">-            viewGroup.dispatchTouchEvent(
</a><a href="#h376-0-95" id="h376-0-95" class="d">-                MotionEvent.obtain(
</a><a href="#h376-0-96" id="h376-0-96" class="d">-                    SystemClock.uptimeMillis(),
</a><a href="#h376-0-97" id="h376-0-97" class="d">-                    SystemClock.uptimeMillis(),
</a><a href="#h376-0-98" id="h376-0-98" class="d">-                    MotionEvent.ACTION_DOWN,
</a><a href="#h376-0-99" id="h376-0-99" class="d">-                    0f,
</a><a href="#h376-0-100" id="h376-0-100" class="d">-                    0f,
</a><a href="#h376-0-101" id="h376-0-101" class="d">-                    0
</a><a href="#h376-0-102" id="h376-0-102" class="d">-                )
</a><a href="#h376-0-103" id="h376-0-103" class="d">-            )
</a><a href="#h376-0-104" id="h376-0-104" class="d">-        }
</a><a href="#h376-0-105" id="h376-0-105" class="d">-
</a><a href="#h376-0-106" id="h376-0-106" class="d">-        val messaging = context.feature(Messaging::class)
</a><a href="#h376-0-107" id="h376-0-107" class="d">-        val messageLogger = context.feature(MessageLogger::class)
</a><a href="#h376-0-108" id="h376-0-108" class="d">-
</a><a href="#h376-0-109" id="h376-0-109" class="d">-        val buttonContainer = createContainer(viewGroup)
</a><a href="#h376-0-110" id="h376-0-110" class="d">-
</a><a href="#h376-0-111" id="h376-0-111" class="d">-        val injectButton = { button: Button -&gt;
</a><a href="#h376-0-112" id="h376-0-112" class="d">-            if (buttonContainer.childCount &gt; 0) {
</a><a href="#h376-0-113" id="h376-0-113" class="d">-                buttonContainer.addView(View(viewGroup.context).apply {
</a><a href="#h376-0-114" id="h376-0-114" class="d">-                    layoutParams = MarginLayoutParams(
</a><a href="#h376-0-115" id="h376-0-115" class="d">-                        ViewGroup.LayoutParams.MATCH_PARENT,
</a><a href="#h376-0-116" id="h376-0-116" class="d">-                        ViewGroup.LayoutParams.WRAP_CONTENT
</a><a href="#h376-0-117" id="h376-0-117" class="d">-                    ).apply {
</a><a href="#h376-0-118" id="h376-0-118" class="d">-                        height = 1
</a><a href="#h376-0-119" id="h376-0-119" class="d">-                    }
</a><a href="#h376-0-120" id="h376-0-120" class="d">-                    setBackgroundColor(0x1A000000)
</a><a href="#h376-0-121" id="h376-0-121" class="d">-                })
</a><a href="#h376-0-122" id="h376-0-122" class="d">-            }
</a><a href="#h376-0-123" id="h376-0-123" class="d">-
</a><a href="#h376-0-124" id="h376-0-124" class="d">-            with(button) {
</a><a href="#h376-0-125" id="h376-0-125" class="d">-                applyTheme(parent.width, true)
</a><a href="#h376-0-126" id="h376-0-126" class="d">-                layoutParams = MarginLayoutParams(
</a><a href="#h376-0-127" id="h376-0-127" class="d">-                    ViewGroup.LayoutParams.MATCH_PARENT,
</a><a href="#h376-0-128" id="h376-0-128" class="d">-                    ViewGroup.LayoutParams.WRAP_CONTENT
</a><a href="#h376-0-129" id="h376-0-129" class="d">-                ).apply {
</a><a href="#h376-0-130" id="h376-0-130" class="d">-                    height = actionMenuItemHeight + defaultGap
</a><a href="#h376-0-131" id="h376-0-131" class="d">-                }
</a><a href="#h376-0-132" id="h376-0-132" class="d">-                buttonContainer.addView(this)
</a><a href="#h376-0-133" id="h376-0-133" class="d">-            }
</a><a href="#h376-0-134" id="h376-0-134" class="d">-        }
</a><a href="#h376-0-135" id="h376-0-135" class="d">-
</a><a href="#h376-0-136" id="h376-0-136" class="d">-        if (context.config.downloader.chatDownloadContextMenu.get()) {
</a><a href="#h376-0-137" id="h376-0-137" class="d">-            injectButton(Button(viewGroup.context).apply {
</a><a href="#h376-0-138" id="h376-0-138" class="d">-                text = this@ChatActionMenu.context.translation[&quot;chat_action_menu.preview_button&quot;]
</a><a href="#h376-0-139" id="h376-0-139" class="d">-                setOnClickListener {
</a><a href="#h376-0-140" id="h376-0-140" class="d">-                    closeActionMenu()
</a><a href="#h376-0-141" id="h376-0-141" class="d">-                    this@ChatActionMenu.context.executeAsync { feature(MediaDownloader::class).onMessageActionMenu(true) }
</a><a href="#h376-0-142" id="h376-0-142" class="d">-                }
</a><a href="#h376-0-143" id="h376-0-143" class="d">-            })
</a><a href="#h376-0-144" id="h376-0-144" class="d">-
</a><a href="#h376-0-145" id="h376-0-145" class="d">-            injectButton(Button(viewGroup.context).apply {
</a><a href="#h376-0-146" id="h376-0-146" class="d">-                text = this@ChatActionMenu.context.translation[&quot;chat_action_menu.download_button&quot;]
</a><a href="#h376-0-147" id="h376-0-147" class="d">-                setOnClickListener {
</a><a href="#h376-0-148" id="h376-0-148" class="d">-                    closeActionMenu()
</a><a href="#h376-0-149" id="h376-0-149" class="d">-                    this@ChatActionMenu.context.executeAsync {
</a><a href="#h376-0-150" id="h376-0-150" class="d">-                        feature(MediaDownloader::class).onMessageActionMenu(false)
</a><a href="#h376-0-151" id="h376-0-151" class="d">-                    }
</a><a href="#h376-0-152" id="h376-0-152" class="d">-                }
</a><a href="#h376-0-153" id="h376-0-153" class="d">-            })
</a><a href="#h376-0-154" id="h376-0-154" class="d">-        }
</a><a href="#h376-0-155" id="h376-0-155" class="d">-
</a><a href="#h376-0-156" id="h376-0-156" class="d">-        //delete logged message button
</a><a href="#h376-0-157" id="h376-0-157" class="d">-        if (context.config.messaging.messageLogger.get()) {
</a><a href="#h376-0-158" id="h376-0-158" class="d">-            injectButton(Button(viewGroup.context).apply {
</a><a href="#h376-0-159" id="h376-0-159" class="d">-                text = this@ChatActionMenu.context.translation[&quot;chat_action_menu.delete_logged_message_button&quot;]
</a><a href="#h376-0-160" id="h376-0-160" class="d">-                setOnClickListener {
</a><a href="#h376-0-161" id="h376-0-161" class="d">-                    closeActionMenu()
</a><a href="#h376-0-162" id="h376-0-162" class="d">-                    this@ChatActionMenu.context.executeAsync {
</a><a href="#h376-0-163" id="h376-0-163" class="d">-                        messageLogger.deleteMessage(messaging.openedConversationUUID.toString(), messaging.lastFocusedMessageId)
</a><a href="#h376-0-164" id="h376-0-164" class="d">-                    }
</a><a href="#h376-0-165" id="h376-0-165" class="d">-                }
</a><a href="#h376-0-166" id="h376-0-166" class="d">-            })
</a><a href="#h376-0-167" id="h376-0-167" class="d">-        }
</a><a href="#h376-0-168" id="h376-0-168" class="d">-
</a><a href="#h376-0-169" id="h376-0-169" class="d">-        if (context.isDeveloper) {
</a><a href="#h376-0-170" id="h376-0-170" class="d">-            parent.addView(createContainer(viewGroup).apply {
</a><a href="#h376-0-171" id="h376-0-171" class="d">-                val debugText = StringBuilder()
</a><a href="#h376-0-172" id="h376-0-172" class="d">-
</a><a href="#h376-0-173" id="h376-0-173" class="d">-                setOnClickListener {
</a><a href="#h376-0-174" id="h376-0-174" class="d">-                    this@ChatActionMenu.context.copyToClipboard(debugText.toString(), &quot;debug&quot;)
</a><a href="#h376-0-175" id="h376-0-175" class="d">-                }
</a><a href="#h376-0-176" id="h376-0-176" class="d">-
</a><a href="#h376-0-177" id="h376-0-177" class="d">-                addView(TextView(viewGroup.context).apply {
</a><a href="#h376-0-178" id="h376-0-178" class="d">-                    setPadding(20, 20, 20, 20)
</a><a href="#h376-0-179" id="h376-0-179" class="d">-                    textSize = 10f
</a><a href="#h376-0-180" id="h376-0-180" class="d">-                    addOnLayoutChangeListener { _, _, _, _, _, _, _, _, _ -&gt;
</a><a href="#h376-0-181" id="h376-0-181" class="d">-                        val arroyoMessage = lastFocusedMessage ?: return@addOnLayoutChangeListener
</a><a href="#h376-0-182" id="h376-0-182" class="d">-                        text = debugText.apply {
</a><a href="#h376-0-183" id="h376-0-183" class="d">-                            runCatching {
</a><a href="#h376-0-184" id="h376-0-184" class="d">-                                clear()
</a><a href="#h376-0-185" id="h376-0-185" class="d">-                                append(&quot;sender_id: ${arroyoMessage.senderId}\n&quot;)
</a><a href="#h376-0-186" id="h376-0-186" class="d">-                                append(&quot;client_id: ${arroyoMessage.clientMessageId}, server_id: ${arroyoMessage.serverMessageId}\n&quot;)
</a><a href="#h376-0-187" id="h376-0-187" class="d">-                                append(&quot;conversation_id: ${arroyoMessage.clientConversationId}\n&quot;)
</a><a href="#h376-0-188" id="h376-0-188" class="d">-                                append(&quot;arroyo_content_type: ${ContentType.fromId(arroyoMessage.contentType)} (${arroyoMessage.contentType})\n&quot;)
</a><a href="#h376-0-189" id="h376-0-189" class="d">-                                append(&quot;parsed_content_type: ${ContentType.fromMessageContainer(
</a><a href="#h376-0-190" id="h376-0-190" class="d">-                                    ProtoReader(arroyoMessage.messageContent!!).followPath(4, 4)
</a><a href="#h376-0-191" id="h376-0-191" class="d">-                                ).let { &quot;$it (${it?.id})&quot; }}\n&quot;)
</a><a href="#h376-0-192" id="h376-0-192" class="d">-                                append(&quot;creation_timestamp: ${arroyoMessage.creationTimestamp} (${Instant.ofEpochMilli(arroyoMessage.creationTimestamp)})\n&quot;)
</a><a href="#h376-0-193" id="h376-0-193" class="d">-                                append(&quot;read_timestamp: ${arroyoMessage.readTimestamp} (${Instant.ofEpochMilli(arroyoMessage.readTimestamp)})\n&quot;)
</a><a href="#h376-0-194" id="h376-0-194" class="d">-                                append(&quot;is_messagelogger_deleted: ${messageLogger.isMessageDeleted(arroyoMessage.clientConversationId!!, arroyoMessage.clientMessageId.toLong())}\n&quot;)
</a><a href="#h376-0-195" id="h376-0-195" class="d">-                                append(&quot;is_messagelogger_stored: ${messageLogger.getMessageObject(arroyoMessage.clientConversationId!!, arroyoMessage.clientMessageId.toLong()) != null}\n&quot;)
</a><a href="#h376-0-196" id="h376-0-196" class="d">-                            }.onFailure {
</a><a href="#h376-0-197" id="h376-0-197" class="d">-                                debugText.append(&quot;Error: $it\n&quot;)
</a><a href="#h376-0-198" id="h376-0-198" class="d">-                            }
</a><a href="#h376-0-199" id="h376-0-199" class="d">-                        }.toString().trimEnd()
</a><a href="#h376-0-200" id="h376-0-200" class="d">-                    }
</a><a href="#h376-0-201" id="h376-0-201" class="d">-                })
</a><a href="#h376-0-202" id="h376-0-202" class="d">-
</a><a href="#h376-0-203" id="h376-0-203" class="d">-                // action buttons
</a><a href="#h376-0-204" id="h376-0-204" class="d">-                addView(LinearLayout(viewGroup.context).apply {
</a><a href="#h376-0-205" id="h376-0-205" class="d">-                    orientation = LinearLayout.HORIZONTAL
</a><a href="#h376-0-206" id="h376-0-206" class="d">-                    addView(Button(viewGroup.context).apply {
</a><a href="#h376-0-207" id="h376-0-207" class="d">-                        text = &quot;Show Deleted Message Object&quot;
</a><a href="#h376-0-208" id="h376-0-208" class="d">-                        setOnClickListener {
</a><a href="#h376-0-209" id="h376-0-209" class="d">-                            val message = lastFocusedMessage ?: return@setOnClickListener
</a><a href="#h376-0-210" id="h376-0-210" class="d">-                            copyAlertDialog(
</a><a href="#h376-0-211" id="h376-0-211" class="d">-                                viewGroup.context,
</a><a href="#h376-0-212" id="h376-0-212" class="d">-                                &quot;Deleted Message Object&quot;,
</a><a href="#h376-0-213" id="h376-0-213" class="d">-                                messageLogger.getMessageObject(message.clientConversationId!!, message.clientMessageId.toLong())?.toString()
</a><a href="#h376-0-214" id="h376-0-214" class="d">-                                    ?: &quot;null&quot;
</a><a href="#h376-0-215" id="h376-0-215" class="d">-                            )
</a><a href="#h376-0-216" id="h376-0-216" class="d">-                        }
</a><a href="#h376-0-217" id="h376-0-217" class="d">-                    })
</a><a href="#h376-0-218" id="h376-0-218" class="d">-                })
</a><a href="#h376-0-219" id="h376-0-219" class="d">-            })
</a><a href="#h376-0-220" id="h376-0-220" class="d">-        }
</a><a href="#h376-0-221" id="h376-0-221" class="d">-
</a><a href="#h376-0-222" id="h376-0-222" class="d">-        parent.addView(buttonContainer)
</a><a href="#h376-0-223" id="h376-0-223" class="d">-    }
</a><a href="#h376-0-224" id="h376-0-224" class="d">-}
</a><b>diff --git a/<a id="h377" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/FriendFeedInfoMenu.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/FriendFeedInfoMenu.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/FriendFeedInfoMenu.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/FriendFeedInfoMenu.kt</a></b>
<a href="#h377-0" id="h377-0" class="h">@@ -1,255 +0,0 @@
</a><a href="#h377-0-0" id="h377-0-0" class="d">-package me.rhunk.snapenhance.ui.menu.impl
</a><a href="#h377-0-1" id="h377-0-1" class="d">-
</a><a href="#h377-0-2" id="h377-0-2" class="d">-import android.content.DialogInterface
</a><a href="#h377-0-3" id="h377-0-3" class="d">-import android.content.res.Resources
</a><a href="#h377-0-4" id="h377-0-4" class="d">-import android.graphics.BitmapFactory
</a><a href="#h377-0-5" id="h377-0-5" class="d">-import android.graphics.drawable.BitmapDrawable
</a><a href="#h377-0-6" id="h377-0-6" class="d">-import android.graphics.drawable.Drawable
</a><a href="#h377-0-7" id="h377-0-7" class="d">-import android.view.View
</a><a href="#h377-0-8" id="h377-0-8" class="d">-import android.widget.Button
</a><a href="#h377-0-9" id="h377-0-9" class="d">-import android.widget.CompoundButton
</a><a href="#h377-0-10" id="h377-0-10" class="d">-import android.widget.Switch
</a><a href="#h377-0-11" id="h377-0-11" class="d">-import me.rhunk.snapenhance.core.database.objects.ConversationMessage
</a><a href="#h377-0-12" id="h377-0-12" class="d">-import me.rhunk.snapenhance.core.database.objects.FriendInfo
</a><a href="#h377-0-13" id="h377-0-13" class="d">-import me.rhunk.snapenhance.core.database.objects.UserConversationLink
</a><a href="#h377-0-14" id="h377-0-14" class="d">-import me.rhunk.snapenhance.core.util.protobuf.ProtoReader
</a><a href="#h377-0-15" id="h377-0-15" class="d">-import me.rhunk.snapenhance.core.util.snap.BitmojiSelfie
</a><a href="#h377-0-16" id="h377-0-16" class="d">-import me.rhunk.snapenhance.data.ContentType
</a><a href="#h377-0-17" id="h377-0-17" class="d">-import me.rhunk.snapenhance.data.FriendLinkType
</a><a href="#h377-0-18" id="h377-0-18" class="d">-import me.rhunk.snapenhance.features.impl.Messaging
</a><a href="#h377-0-19" id="h377-0-19" class="d">-import me.rhunk.snapenhance.features.impl.spying.MessageLogger
</a><a href="#h377-0-20" id="h377-0-20" class="d">-import me.rhunk.snapenhance.ui.ViewAppearanceHelper
</a><a href="#h377-0-21" id="h377-0-21" class="d">-import me.rhunk.snapenhance.ui.applyTheme
</a><a href="#h377-0-22" id="h377-0-22" class="d">-import me.rhunk.snapenhance.ui.menu.AbstractMenu
</a><a href="#h377-0-23" id="h377-0-23" class="d">-import java.net.HttpURLConnection
</a><a href="#h377-0-24" id="h377-0-24" class="d">-import java.net.URL
</a><a href="#h377-0-25" id="h377-0-25" class="d">-import java.text.DateFormat
</a><a href="#h377-0-26" id="h377-0-26" class="d">-import java.text.SimpleDateFormat
</a><a href="#h377-0-27" id="h377-0-27" class="d">-import java.util.Calendar
</a><a href="#h377-0-28" id="h377-0-28" class="d">-import java.util.Date
</a><a href="#h377-0-29" id="h377-0-29" class="d">-import java.util.Locale
</a><a href="#h377-0-30" id="h377-0-30" class="d">-
</a><a href="#h377-0-31" id="h377-0-31" class="d">-class FriendFeedInfoMenu : AbstractMenu() {
</a><a href="#h377-0-32" id="h377-0-32" class="d">-    private fun getImageDrawable(url: String): Drawable {
</a><a href="#h377-0-33" id="h377-0-33" class="d">-        val connection = URL(url).openConnection() as HttpURLConnection
</a><a href="#h377-0-34" id="h377-0-34" class="d">-        connection.connect()
</a><a href="#h377-0-35" id="h377-0-35" class="d">-        val input = connection.inputStream
</a><a href="#h377-0-36" id="h377-0-36" class="d">-        return BitmapDrawable(Resources.getSystem(), BitmapFactory.decodeStream(input))
</a><a href="#h377-0-37" id="h377-0-37" class="d">-    }
</a><a href="#h377-0-38" id="h377-0-38" class="d">-
</a><a href="#h377-0-39" id="h377-0-39" class="d">-    private fun formatDate(timestamp: Long): String? {
</a><a href="#h377-0-40" id="h377-0-40" class="d">-        return SimpleDateFormat(&quot;yyyy-MM-dd HH:mm:ss&quot;, Locale.ENGLISH).format(Date(timestamp))
</a><a href="#h377-0-41" id="h377-0-41" class="d">-    }
</a><a href="#h377-0-42" id="h377-0-42" class="d">-
</a><a href="#h377-0-43" id="h377-0-43" class="d">-    private fun showProfileInfo(profile: FriendInfo) {
</a><a href="#h377-0-44" id="h377-0-44" class="d">-        var icon: Drawable? = null
</a><a href="#h377-0-45" id="h377-0-45" class="d">-        try {
</a><a href="#h377-0-46" id="h377-0-46" class="d">-            if (profile.bitmojiSelfieId != null &amp;&amp; profile.bitmojiAvatarId != null) {
</a><a href="#h377-0-47" id="h377-0-47" class="d">-                icon = getImageDrawable(
</a><a href="#h377-0-48" id="h377-0-48" class="d">-                    BitmojiSelfie.getBitmojiSelfie(
</a><a href="#h377-0-49" id="h377-0-49" class="d">-                        profile.bitmojiSelfieId.toString(),
</a><a href="#h377-0-50" id="h377-0-50" class="d">-                        profile.bitmojiAvatarId.toString(),
</a><a href="#h377-0-51" id="h377-0-51" class="d">-                        BitmojiSelfie.BitmojiSelfieType.THREE_D
</a><a href="#h377-0-52" id="h377-0-52" class="d">-                    )!!
</a><a href="#h377-0-53" id="h377-0-53" class="d">-                )
</a><a href="#h377-0-54" id="h377-0-54" class="d">-            }
</a><a href="#h377-0-55" id="h377-0-55" class="d">-        } catch (e: Throwable) {
</a><a href="#h377-0-56" id="h377-0-56" class="d">-            context.log.error(&quot;Error loading bitmoji selfie&quot;, e)
</a><a href="#h377-0-57" id="h377-0-57" class="d">-        }
</a><a href="#h377-0-58" id="h377-0-58" class="d">-        val finalIcon = icon
</a><a href="#h377-0-59" id="h377-0-59" class="d">-        val translation = context.translation.getCategory(&quot;profile_info&quot;)
</a><a href="#h377-0-60" id="h377-0-60" class="d">-
</a><a href="#h377-0-61" id="h377-0-61" class="d">-        context.runOnUiThread {
</a><a href="#h377-0-62" id="h377-0-62" class="d">-            val addedTimestamp: Long = profile.addedTimestamp.coerceAtLeast(profile.reverseAddedTimestamp)
</a><a href="#h377-0-63" id="h377-0-63" class="d">-            val builder = ViewAppearanceHelper.newAlertDialogBuilder(context.mainActivity)
</a><a href="#h377-0-64" id="h377-0-64" class="d">-            builder.setIcon(finalIcon)
</a><a href="#h377-0-65" id="h377-0-65" class="d">-            builder.setTitle(profile.displayName ?: profile.username)
</a><a href="#h377-0-66" id="h377-0-66" class="d">-
</a><a href="#h377-0-67" id="h377-0-67" class="d">-            val birthday = Calendar.getInstance()
</a><a href="#h377-0-68" id="h377-0-68" class="d">-            birthday[Calendar.MONTH] = (profile.birthday shr 32).toInt() - 1
</a><a href="#h377-0-69" id="h377-0-69" class="d">-
</a><a href="#h377-0-70" id="h377-0-70" class="d">-            builder.setMessage(mapOf(
</a><a href="#h377-0-71" id="h377-0-71" class="d">-                translation[&quot;first_created_username&quot;] to profile.firstCreatedUsername,
</a><a href="#h377-0-72" id="h377-0-72" class="d">-                translation[&quot;mutable_username&quot;] to profile.mutableUsername,
</a><a href="#h377-0-73" id="h377-0-73" class="d">-                translation[&quot;display_name&quot;] to profile.displayName,
</a><a href="#h377-0-74" id="h377-0-74" class="d">-                translation[&quot;added_date&quot;] to formatDate(addedTimestamp),
</a><a href="#h377-0-75" id="h377-0-75" class="d">-                null to birthday.getDisplayName(
</a><a href="#h377-0-76" id="h377-0-76" class="d">-                    Calendar.MONTH,
</a><a href="#h377-0-77" id="h377-0-77" class="d">-                    Calendar.LONG,
</a><a href="#h377-0-78" id="h377-0-78" class="d">-                    context.translation.loadedLocale
</a><a href="#h377-0-79" id="h377-0-79" class="d">-                )?.let {
</a><a href="#h377-0-80" id="h377-0-80" class="d">-                    context.translation.format(&quot;profile_info.birthday&quot;,
</a><a href="#h377-0-81" id="h377-0-81" class="d">-                        &quot;month&quot; to it,
</a><a href="#h377-0-82" id="h377-0-82" class="d">-                        &quot;day&quot; to profile.birthday.toInt().toString())
</a><a href="#h377-0-83" id="h377-0-83" class="d">-                },
</a><a href="#h377-0-84" id="h377-0-84" class="d">-                translation[&quot;friendship&quot;] to run {
</a><a href="#h377-0-85" id="h377-0-85" class="d">-                    translation.getCategory(&quot;friendship_link_type&quot;)[FriendLinkType.fromValue(profile.friendLinkType).shortName]
</a><a href="#h377-0-86" id="h377-0-86" class="d">-                },
</a><a href="#h377-0-87" id="h377-0-87" class="d">-                translation[&quot;add_source&quot;] to context.database.getAddSource(profile.userId!!)?.takeIf { it.isNotEmpty() },
</a><a href="#h377-0-88" id="h377-0-88" class="d">-                translation[&quot;snapchat_plus&quot;] to run {
</a><a href="#h377-0-89" id="h377-0-89" class="d">-                    translation.getCategory(&quot;snapchat_plus_state&quot;)[if (profile.postViewEmoji != null) &quot;subscribed&quot; else &quot;not_subscribed&quot;]
</a><a href="#h377-0-90" id="h377-0-90" class="d">-                }
</a><a href="#h377-0-91" id="h377-0-91" class="d">-            ).filterValues { it != null }.map {
</a><a href="#h377-0-92" id="h377-0-92" class="d">-                line -&gt; &quot;${line.key?.let { &quot;$it: &quot; } ?: &quot;&quot;}${line.value}&quot;
</a><a href="#h377-0-93" id="h377-0-93" class="d">-            }.joinToString(&quot;\n&quot;))
</a><a href="#h377-0-94" id="h377-0-94" class="d">-
</a><a href="#h377-0-95" id="h377-0-95" class="d">-            builder.setPositiveButton(
</a><a href="#h377-0-96" id="h377-0-96" class="d">-                &quot;OK&quot;
</a><a href="#h377-0-97" id="h377-0-97" class="d">-            ) { dialog: DialogInterface, _: Int -&gt; dialog.dismiss() }
</a><a href="#h377-0-98" id="h377-0-98" class="d">-            builder.show()
</a><a href="#h377-0-99" id="h377-0-99" class="d">-        }
</a><a href="#h377-0-100" id="h377-0-100" class="d">-    }
</a><a href="#h377-0-101" id="h377-0-101" class="d">-
</a><a href="#h377-0-102" id="h377-0-102" class="d">-    private fun showPreview(userId: String?, conversationId: String) {
</a><a href="#h377-0-103" id="h377-0-103" class="d">-        //query message
</a><a href="#h377-0-104" id="h377-0-104" class="d">-        val messageLogger = context.feature(MessageLogger::class)
</a><a href="#h377-0-105" id="h377-0-105" class="d">-        val messages: List&lt;ConversationMessage&gt; = context.database.getMessagesFromConversationId(
</a><a href="#h377-0-106" id="h377-0-106" class="d">-            conversationId,
</a><a href="#h377-0-107" id="h377-0-107" class="d">-            context.config.messaging.messagePreviewLength.get()
</a><a href="#h377-0-108" id="h377-0-108" class="d">-        )?.reversed() ?: emptyList()
</a><a href="#h377-0-109" id="h377-0-109" class="d">-
</a><a href="#h377-0-110" id="h377-0-110" class="d">-        val participants: Map&lt;String, FriendInfo&gt; = context.database.getConversationParticipants(conversationId)!!
</a><a href="#h377-0-111" id="h377-0-111" class="d">-            .map { context.database.getFriendInfo(it)!! }
</a><a href="#h377-0-112" id="h377-0-112" class="d">-            .associateBy { it.userId!! }
</a><a href="#h377-0-113" id="h377-0-113" class="d">-        
</a><a href="#h377-0-114" id="h377-0-114" class="d">-        val messageBuilder = StringBuilder()
</a><a href="#h377-0-115" id="h377-0-115" class="d">-
</a><a href="#h377-0-116" id="h377-0-116" class="d">-        messages.forEach { message -&gt;
</a><a href="#h377-0-117" id="h377-0-117" class="d">-            val sender = participants[message.senderId]
</a><a href="#h377-0-118" id="h377-0-118" class="d">-            val protoReader = (
</a><a href="#h377-0-119" id="h377-0-119" class="d">-                messageLogger.takeIf { it.isEnabled }?.getMessageProto(conversationId, message.clientMessageId.toLong()) ?: ProtoReader(message.messageContent ?: return@forEach).followPath(4, 4)
</a><a href="#h377-0-120" id="h377-0-120" class="d">-            ) ?: return@forEach
</a><a href="#h377-0-121" id="h377-0-121" class="d">-
</a><a href="#h377-0-122" id="h377-0-122" class="d">-            val contentType = ContentType.fromMessageContainer(protoReader) ?: ContentType.fromId(message.contentType)
</a><a href="#h377-0-123" id="h377-0-123" class="d">-            var messageString = if (contentType == ContentType.CHAT) {
</a><a href="#h377-0-124" id="h377-0-124" class="d">-                protoReader.getString(2, 1) ?: return@forEach
</a><a href="#h377-0-125" id="h377-0-125" class="d">-            } else {
</a><a href="#h377-0-126" id="h377-0-126" class="d">-                contentType.name
</a><a href="#h377-0-127" id="h377-0-127" class="d">-            }
</a><a href="#h377-0-128" id="h377-0-128" class="d">-
</a><a href="#h377-0-129" id="h377-0-129" class="d">-            if (contentType == ContentType.SNAP) {
</a><a href="#h377-0-130" id="h377-0-130" class="d">-                messageString = &quot;\uD83D\uDFE5&quot; //red square
</a><a href="#h377-0-131" id="h377-0-131" class="d">-                if (message.readTimestamp &gt; 0) {
</a><a href="#h377-0-132" id="h377-0-132" class="d">-                    messageString += &quot; \uD83D\uDC40 &quot; //eyes
</a><a href="#h377-0-133" id="h377-0-133" class="d">-                    messageString += DateFormat.getDateTimeInstance(
</a><a href="#h377-0-134" id="h377-0-134" class="d">-                        DateFormat.SHORT,
</a><a href="#h377-0-135" id="h377-0-135" class="d">-                        DateFormat.SHORT
</a><a href="#h377-0-136" id="h377-0-136" class="d">-                    ).format(Date(message.readTimestamp))
</a><a href="#h377-0-137" id="h377-0-137" class="d">-                }
</a><a href="#h377-0-138" id="h377-0-138" class="d">-            }
</a><a href="#h377-0-139" id="h377-0-139" class="d">-
</a><a href="#h377-0-140" id="h377-0-140" class="d">-            var displayUsername = sender?.displayName ?: sender?.usernameForSorting?: context.translation[&quot;conversation_preview.unknown_user&quot;]
</a><a href="#h377-0-141" id="h377-0-141" class="d">-
</a><a href="#h377-0-142" id="h377-0-142" class="d">-            if (displayUsername.length &gt; 12) {
</a><a href="#h377-0-143" id="h377-0-143" class="d">-                displayUsername = displayUsername.substring(0, 13) + &quot;... &quot;
</a><a href="#h377-0-144" id="h377-0-144" class="d">-            }
</a><a href="#h377-0-145" id="h377-0-145" class="d">-
</a><a href="#h377-0-146" id="h377-0-146" class="d">-            messageBuilder.append(displayUsername).append(&quot;: &quot;).append(messageString).append(&quot;\n&quot;)
</a><a href="#h377-0-147" id="h377-0-147" class="d">-        }
</a><a href="#h377-0-148" id="h377-0-148" class="d">-
</a><a href="#h377-0-149" id="h377-0-149" class="d">-        val targetPerson = if (userId == null) null else participants[userId]
</a><a href="#h377-0-150" id="h377-0-150" class="d">-
</a><a href="#h377-0-151" id="h377-0-151" class="d">-        targetPerson?.streakExpirationTimestamp?.takeIf { it &gt; 0 }?.let {
</a><a href="#h377-0-152" id="h377-0-152" class="d">-            val timeSecondDiff = ((it - System.currentTimeMillis()) / 1000 / 60).toInt()
</a><a href="#h377-0-153" id="h377-0-153" class="d">-            messageBuilder.append(&quot;\n&quot;)
</a><a href="#h377-0-154" id="h377-0-154" class="d">-                .append(&quot;\uD83D\uDD25 &quot;) //fire emoji
</a><a href="#h377-0-155" id="h377-0-155" class="d">-                .append(
</a><a href="#h377-0-156" id="h377-0-156" class="d">-                    context.translation.format(&quot;conversation_preview.streak_expiration&quot;,
</a><a href="#h377-0-157" id="h377-0-157" class="d">-                    &quot;day&quot; to (timeSecondDiff / 60 / 24).toString(),
</a><a href="#h377-0-158" id="h377-0-158" class="d">-                    &quot;hour&quot; to (timeSecondDiff / 60 % 24).toString(),
</a><a href="#h377-0-159" id="h377-0-159" class="d">-                    &quot;minute&quot; to (timeSecondDiff % 60).toString()
</a><a href="#h377-0-160" id="h377-0-160" class="d">-                ))
</a><a href="#h377-0-161" id="h377-0-161" class="d">-        }
</a><a href="#h377-0-162" id="h377-0-162" class="d">-
</a><a href="#h377-0-163" id="h377-0-163" class="d">-        messages.lastOrNull()?.let {
</a><a href="#h377-0-164" id="h377-0-164" class="d">-            messageBuilder
</a><a href="#h377-0-165" id="h377-0-165" class="d">-                .append(&quot;\n\n&quot;)
</a><a href="#h377-0-166" id="h377-0-166" class="d">-                .append(context.translation.format(&quot;conversation_preview.total_messages&quot;, &quot;count&quot; to it.serverMessageId.toString()))
</a><a href="#h377-0-167" id="h377-0-167" class="d">-                .append(&quot;\n&quot;)
</a><a href="#h377-0-168" id="h377-0-168" class="d">-        }
</a><a href="#h377-0-169" id="h377-0-169" class="d">-
</a><a href="#h377-0-170" id="h377-0-170" class="d">-        //alert dialog
</a><a href="#h377-0-171" id="h377-0-171" class="d">-        val builder = ViewAppearanceHelper.newAlertDialogBuilder(context.mainActivity)
</a><a href="#h377-0-172" id="h377-0-172" class="d">-        builder.setTitle(context.translation[&quot;conversation_preview.title&quot;])
</a><a href="#h377-0-173" id="h377-0-173" class="d">-        builder.setMessage(messageBuilder.toString())
</a><a href="#h377-0-174" id="h377-0-174" class="d">-        builder.setPositiveButton(
</a><a href="#h377-0-175" id="h377-0-175" class="d">-            &quot;OK&quot;
</a><a href="#h377-0-176" id="h377-0-176" class="d">-        ) { dialog: DialogInterface, _: Int -&gt; dialog.dismiss() }
</a><a href="#h377-0-177" id="h377-0-177" class="d">-        targetPerson?.let {
</a><a href="#h377-0-178" id="h377-0-178" class="d">-            builder.setNegativeButton(context.translation[&quot;modal_option.profile_info&quot;]) { _, _ -&gt;
</a><a href="#h377-0-179" id="h377-0-179" class="d">-                context.executeAsync { showProfileInfo(it) }
</a><a href="#h377-0-180" id="h377-0-180" class="d">-            }
</a><a href="#h377-0-181" id="h377-0-181" class="d">-        }
</a><a href="#h377-0-182" id="h377-0-182" class="d">-        builder.show()
</a><a href="#h377-0-183" id="h377-0-183" class="d">-    }
</a><a href="#h377-0-184" id="h377-0-184" class="d">-
</a><a href="#h377-0-185" id="h377-0-185" class="d">-    private fun getCurrentConversationInfo(): Pair&lt;String, String?&gt; {
</a><a href="#h377-0-186" id="h377-0-186" class="d">-        val messaging = context.feature(Messaging::class)
</a><a href="#h377-0-187" id="h377-0-187" class="d">-        val focusedConversationTargetUser: String? = messaging.lastFetchConversationUserUUID?.toString()
</a><a href="#h377-0-188" id="h377-0-188" class="d">-
</a><a href="#h377-0-189" id="h377-0-189" class="d">-        //mapped conversation fetch (may not work with legacy sc versions)
</a><a href="#h377-0-190" id="h377-0-190" class="d">-        messaging.lastFetchGroupConversationUUID?.let {
</a><a href="#h377-0-191" id="h377-0-191" class="d">-            context.database.getFeedEntryByConversationId(it.toString())?.let { friendFeedInfo -&gt;
</a><a href="#h377-0-192" id="h377-0-192" class="d">-                val participantSize = friendFeedInfo.participantsSize
</a><a href="#h377-0-193" id="h377-0-193" class="d">-                return it.toString() to if (participantSize == 1) focusedConversationTargetUser else null
</a><a href="#h377-0-194" id="h377-0-194" class="d">-            }
</a><a href="#h377-0-195" id="h377-0-195" class="d">-            throw IllegalStateException(&quot;No conversation found&quot;)
</a><a href="#h377-0-196" id="h377-0-196" class="d">-        }
</a><a href="#h377-0-197" id="h377-0-197" class="d">-
</a><a href="#h377-0-198" id="h377-0-198" class="d">-        //old conversation fetch
</a><a href="#h377-0-199" id="h377-0-199" class="d">-        val conversationId = if (messaging.lastFetchConversationUUID == null &amp;&amp; focusedConversationTargetUser != null) {
</a><a href="#h377-0-200" id="h377-0-200" class="d">-            val conversation: UserConversationLink = context.database.getConversationLinkFromUserId(focusedConversationTargetUser) ?: throw IllegalStateException(&quot;No conversation found&quot;)
</a><a href="#h377-0-201" id="h377-0-201" class="d">-            conversation.clientConversationId!!.trim().lowercase()
</a><a href="#h377-0-202" id="h377-0-202" class="d">-        } else {
</a><a href="#h377-0-203" id="h377-0-203" class="d">-            messaging.lastFetchConversationUUID.toString()
</a><a href="#h377-0-204" id="h377-0-204" class="d">-        }
</a><a href="#h377-0-205" id="h377-0-205" class="d">-
</a><a href="#h377-0-206" id="h377-0-206" class="d">-        return conversationId to focusedConversationTargetUser
</a><a href="#h377-0-207" id="h377-0-207" class="d">-    }
</a><a href="#h377-0-208" id="h377-0-208" class="d">-
</a><a href="#h377-0-209" id="h377-0-209" class="d">-    private fun createToggleFeature(viewConsumer: ((View) -&gt; Unit), text: String, isChecked: () -&gt; Boolean, toggle: (Boolean) -&gt; Unit) {
</a><a href="#h377-0-210" id="h377-0-210" class="d">-        val switch = Switch(context.androidContext)
</a><a href="#h377-0-211" id="h377-0-211" class="d">-        switch.text = context.translation[text]
</a><a href="#h377-0-212" id="h377-0-212" class="d">-        switch.isChecked = isChecked()
</a><a href="#h377-0-213" id="h377-0-213" class="d">-        switch.applyTheme(hasRadius = true)
</a><a href="#h377-0-214" id="h377-0-214" class="d">-        switch.setOnCheckedChangeListener { _: CompoundButton?, checked: Boolean -&gt;
</a><a href="#h377-0-215" id="h377-0-215" class="d">-            toggle(checked)
</a><a href="#h377-0-216" id="h377-0-216" class="d">-        }
</a><a href="#h377-0-217" id="h377-0-217" class="d">-        viewConsumer(switch)
</a><a href="#h377-0-218" id="h377-0-218" class="d">-    }
</a><a href="#h377-0-219" id="h377-0-219" class="d">-
</a><a href="#h377-0-220" id="h377-0-220" class="d">-    fun inject(viewModel: View, viewConsumer: ((View) -&gt; Unit)) {
</a><a href="#h377-0-221" id="h377-0-221" class="d">-        val modContext = context
</a><a href="#h377-0-222" id="h377-0-222" class="d">-
</a><a href="#h377-0-223" id="h377-0-223" class="d">-        val friendFeedMenuOptions by context.config.userInterface.friendFeedMenuButtons
</a><a href="#h377-0-224" id="h377-0-224" class="d">-        if (friendFeedMenuOptions.isEmpty()) return
</a><a href="#h377-0-225" id="h377-0-225" class="d">-
</a><a href="#h377-0-226" id="h377-0-226" class="d">-        val (conversationId, targetUser) = getCurrentConversationInfo()
</a><a href="#h377-0-227" id="h377-0-227" class="d">-
</a><a href="#h377-0-228" id="h377-0-228" class="d">-        val previewButton = Button(viewModel.context).apply {
</a><a href="#h377-0-229" id="h377-0-229" class="d">-            text = modContext.translation[&quot;friend_menu_option.preview&quot;]
</a><a href="#h377-0-230" id="h377-0-230" class="d">-            applyTheme(viewModel.width, hasRadius = true)
</a><a href="#h377-0-231" id="h377-0-231" class="d">-            setOnClickListener {
</a><a href="#h377-0-232" id="h377-0-232" class="d">-                showPreview(
</a><a href="#h377-0-233" id="h377-0-233" class="d">-                    targetUser,
</a><a href="#h377-0-234" id="h377-0-234" class="d">-                    conversationId
</a><a href="#h377-0-235" id="h377-0-235" class="d">-                )
</a><a href="#h377-0-236" id="h377-0-236" class="d">-            }
</a><a href="#h377-0-237" id="h377-0-237" class="d">-        }
</a><a href="#h377-0-238" id="h377-0-238" class="d">-
</a><a href="#h377-0-239" id="h377-0-239" class="d">-        if (friendFeedMenuOptions.contains(&quot;conversation_info&quot;)) {
</a><a href="#h377-0-240" id="h377-0-240" class="d">-            viewConsumer(previewButton)
</a><a href="#h377-0-241" id="h377-0-241" class="d">-        }
</a><a href="#h377-0-242" id="h377-0-242" class="d">-
</a><a href="#h377-0-243" id="h377-0-243" class="d">-        modContext.features.getRuleFeatures().forEach { ruleFeature -&gt;
</a><a href="#h377-0-244" id="h377-0-244" class="d">-            if (!friendFeedMenuOptions.contains(ruleFeature.ruleType.key)) return@forEach
</a><a href="#h377-0-245" id="h377-0-245" class="d">-
</a><a href="#h377-0-246" id="h377-0-246" class="d">-            val ruleState = ruleFeature.getRuleState() ?: return@forEach
</a><a href="#h377-0-247" id="h377-0-247" class="d">-            createToggleFeature(viewConsumer,
</a><a href="#h377-0-248" id="h377-0-248" class="d">-                ruleFeature.ruleType.translateOptionKey(ruleState.key),
</a><a href="#h377-0-249" id="h377-0-249" class="d">-                { ruleFeature.getState(conversationId) },
</a><a href="#h377-0-250" id="h377-0-250" class="d">-                { ruleFeature.setState(conversationId, it) }
</a><a href="#h377-0-251" id="h377-0-251" class="d">-            )
</a><a href="#h377-0-252" id="h377-0-252" class="d">-        }
</a><a href="#h377-0-253" id="h377-0-253" class="d">-    }
</a><a href="#h377-0-254" id="h377-0-254" class="d">-}</a><a href="#h377-0-255" id="h377-0-255" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h378" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/MenuViewInjector.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/MenuViewInjector.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/MenuViewInjector.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/MenuViewInjector.kt</a></b>
<a href="#h378-0" id="h378-0" class="h">@@ -1,146 +0,0 @@
</a><a href="#h378-0-0" id="h378-0-0" class="d">-package me.rhunk.snapenhance.ui.menu.impl
</a><a href="#h378-0-1" id="h378-0-1" class="d">-
</a><a href="#h378-0-2" id="h378-0-2" class="d">-import android.annotation.SuppressLint
</a><a href="#h378-0-3" id="h378-0-3" class="d">-import android.view.Gravity
</a><a href="#h378-0-4" id="h378-0-4" class="d">-import android.view.View
</a><a href="#h378-0-5" id="h378-0-5" class="d">-import android.view.ViewGroup
</a><a href="#h378-0-6" id="h378-0-6" class="d">-import android.widget.FrameLayout
</a><a href="#h378-0-7" id="h378-0-7" class="d">-import android.widget.LinearLayout
</a><a href="#h378-0-8" id="h378-0-8" class="d">-import me.rhunk.snapenhance.Constants
</a><a href="#h378-0-9" id="h378-0-9" class="d">-import me.rhunk.snapenhance.core.event.events.impl.AddViewEvent
</a><a href="#h378-0-10" id="h378-0-10" class="d">-import me.rhunk.snapenhance.features.Feature
</a><a href="#h378-0-11" id="h378-0-11" class="d">-import me.rhunk.snapenhance.features.FeatureLoadParams
</a><a href="#h378-0-12" id="h378-0-12" class="d">-import me.rhunk.snapenhance.features.impl.Messaging
</a><a href="#h378-0-13" id="h378-0-13" class="d">-import me.rhunk.snapenhance.ui.ViewTagState
</a><a href="#h378-0-14" id="h378-0-14" class="d">-import java.lang.reflect.Modifier
</a><a href="#h378-0-15" id="h378-0-15" class="d">-
</a><a href="#h378-0-16" id="h378-0-16" class="d">-@SuppressLint(&quot;DiscouragedApi&quot;)
</a><a href="#h378-0-17" id="h378-0-17" class="d">-class MenuViewInjector : Feature(&quot;MenuViewInjector&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_ASYNC) {
</a><a href="#h378-0-18" id="h378-0-18" class="d">-    private val viewTagState = ViewTagState()
</a><a href="#h378-0-19" id="h378-0-19" class="d">-
</a><a href="#h378-0-20" id="h378-0-20" class="d">-    private val friendFeedInfoMenu = FriendFeedInfoMenu()
</a><a href="#h378-0-21" id="h378-0-21" class="d">-    private val operaContextActionMenu = OperaContextActionMenu()
</a><a href="#h378-0-22" id="h378-0-22" class="d">-    private val chatActionMenu = ChatActionMenu()
</a><a href="#h378-0-23" id="h378-0-23" class="d">-    private val settingMenu = SettingsMenu()
</a><a href="#h378-0-24" id="h378-0-24" class="d">-    private val settingsGearInjector = SettingsGearInjector()
</a><a href="#h378-0-25" id="h378-0-25" class="d">-
</a><a href="#h378-0-26" id="h378-0-26" class="d">-    private val newChatString by lazy {
</a><a href="#h378-0-27" id="h378-0-27" class="d">-        context.resources.getString(context.resources.getIdentifier(&quot;new_chat&quot;, &quot;string&quot;, Constants.SNAPCHAT_PACKAGE_NAME))
</a><a href="#h378-0-28" id="h378-0-28" class="d">-    }
</a><a href="#h378-0-29" id="h378-0-29" class="d">-
</a><a href="#h378-0-30" id="h378-0-30" class="d">-    @SuppressLint(&quot;ResourceType&quot;)
</a><a href="#h378-0-31" id="h378-0-31" class="d">-    override fun asyncOnActivityCreate() {
</a><a href="#h378-0-32" id="h378-0-32" class="d">-        friendFeedInfoMenu.context = context
</a><a href="#h378-0-33" id="h378-0-33" class="d">-        operaContextActionMenu.context = context
</a><a href="#h378-0-34" id="h378-0-34" class="d">-        chatActionMenu.context = context
</a><a href="#h378-0-35" id="h378-0-35" class="d">-        settingMenu.context = context
</a><a href="#h378-0-36" id="h378-0-36" class="d">-        settingsGearInjector.context = context
</a><a href="#h378-0-37" id="h378-0-37" class="d">-
</a><a href="#h378-0-38" id="h378-0-38" class="d">-        val messaging = context.feature(Messaging::class)
</a><a href="#h378-0-39" id="h378-0-39" class="d">-
</a><a href="#h378-0-40" id="h378-0-40" class="d">-        val actionSheetItemsContainerLayoutId = context.resources.getIdentifier(&quot;action_sheet_items_container&quot;, &quot;id&quot;, Constants.SNAPCHAT_PACKAGE_NAME)
</a><a href="#h378-0-41" id="h378-0-41" class="d">-        val actionSheetContainer = context.resources.getIdentifier(&quot;action_sheet_container&quot;, &quot;id&quot;, Constants.SNAPCHAT_PACKAGE_NAME)
</a><a href="#h378-0-42" id="h378-0-42" class="d">-        val actionMenu = context.resources.getIdentifier(&quot;action_menu&quot;, &quot;id&quot;, Constants.SNAPCHAT_PACKAGE_NAME)
</a><a href="#h378-0-43" id="h378-0-43" class="d">-        val componentsHolder = context.resources.getIdentifier(&quot;components_holder&quot;, &quot;id&quot;, Constants.SNAPCHAT_PACKAGE_NAME)
</a><a href="#h378-0-44" id="h378-0-44" class="d">-        val feedNewChat = context.resources.getIdentifier(&quot;feed_new_chat&quot;, &quot;id&quot;, Constants.SNAPCHAT_PACKAGE_NAME)
</a><a href="#h378-0-45" id="h378-0-45" class="d">-
</a><a href="#h378-0-46" id="h378-0-46" class="d">-        context.event.subscribe(AddViewEvent::class) { event -&gt;
</a><a href="#h378-0-47" id="h378-0-47" class="d">-            val originalAddView: (View) -&gt; Unit = {
</a><a href="#h378-0-48" id="h378-0-48" class="d">-                event.adapter.invokeOriginal(arrayOf(it, -1,
</a><a href="#h378-0-49" id="h378-0-49" class="d">-                    FrameLayout.LayoutParams(
</a><a href="#h378-0-50" id="h378-0-50" class="d">-                        ViewGroup.LayoutParams.MATCH_PARENT,
</a><a href="#h378-0-51" id="h378-0-51" class="d">-                        ViewGroup.LayoutParams.MATCH_PARENT
</a><a href="#h378-0-52" id="h378-0-52" class="d">-                    ))
</a><a href="#h378-0-53" id="h378-0-53" class="d">-                )
</a><a href="#h378-0-54" id="h378-0-54" class="d">-            }
</a><a href="#h378-0-55" id="h378-0-55" class="d">-
</a><a href="#h378-0-56" id="h378-0-56" class="d">-            val viewGroup: ViewGroup = event.parent
</a><a href="#h378-0-57" id="h378-0-57" class="d">-            val childView: View = event.view
</a><a href="#h378-0-58" id="h378-0-58" class="d">-            operaContextActionMenu.inject(event.parent, childView)
</a><a href="#h378-0-59" id="h378-0-59" class="d">-
</a><a href="#h378-0-60" id="h378-0-60" class="d">-            if (event.parent.id == componentsHolder &amp;&amp; childView.id == feedNewChat) {
</a><a href="#h378-0-61" id="h378-0-61" class="d">-                settingsGearInjector.inject(event.parent, childView)
</a><a href="#h378-0-62" id="h378-0-62" class="d">-                return@subscribe
</a><a href="#h378-0-63" id="h378-0-63" class="d">-            }
</a><a href="#h378-0-64" id="h378-0-64" class="d">-
</a><a href="#h378-0-65" id="h378-0-65" class="d">-            //download in chat snaps and notes from the chat action menu
</a><a href="#h378-0-66" id="h378-0-66" class="d">-            if (viewGroup.javaClass.name.endsWith(&quot;ActionMenuChatItemContainer&quot;)) {
</a><a href="#h378-0-67" id="h378-0-67" class="d">-                if (viewGroup.parent == null || viewGroup.parent.parent == null) return@subscribe
</a><a href="#h378-0-68" id="h378-0-68" class="d">-                chatActionMenu.inject(viewGroup)
</a><a href="#h378-0-69" id="h378-0-69" class="d">-                return@subscribe
</a><a href="#h378-0-70" id="h378-0-70" class="d">-            }
</a><a href="#h378-0-71" id="h378-0-71" class="d">-
</a><a href="#h378-0-72" id="h378-0-72" class="d">-            //TODO: inject in group chat menus
</a><a href="#h378-0-73" id="h378-0-73" class="d">-            if (viewGroup.id == actionSheetContainer &amp;&amp; childView.id == actionMenu &amp;&amp; messaging.lastFetchGroupConversationUUID != null) {
</a><a href="#h378-0-74" id="h378-0-74" class="d">-                val injectedLayout = LinearLayout(childView.context).apply {
</a><a href="#h378-0-75" id="h378-0-75" class="d">-                    orientation = LinearLayout.VERTICAL
</a><a href="#h378-0-76" id="h378-0-76" class="d">-                    gravity = Gravity.BOTTOM
</a><a href="#h378-0-77" id="h378-0-77" class="d">-                    layoutParams = ViewGroup.LayoutParams(ViewGroup.LayoutParams.MATCH_PARENT, ViewGroup.LayoutParams.MATCH_PARENT)
</a><a href="#h378-0-78" id="h378-0-78" class="d">-                    addView(childView)
</a><a href="#h378-0-79" id="h378-0-79" class="d">-                    addOnAttachStateChangeListener(object: View.OnAttachStateChangeListener {
</a><a href="#h378-0-80" id="h378-0-80" class="d">-                        override fun onViewAttachedToWindow(v: View) {}
</a><a href="#h378-0-81" id="h378-0-81" class="d">-                        override fun onViewDetachedFromWindow(v: View) {
</a><a href="#h378-0-82" id="h378-0-82" class="d">-                            messaging.lastFetchGroupConversationUUID = null
</a><a href="#h378-0-83" id="h378-0-83" class="d">-                        }
</a><a href="#h378-0-84" id="h378-0-84" class="d">-                    })
</a><a href="#h378-0-85" id="h378-0-85" class="d">-                }
</a><a href="#h378-0-86" id="h378-0-86" class="d">-
</a><a href="#h378-0-87" id="h378-0-87" class="d">-                val viewList = mutableListOf&lt;View&gt;()
</a><a href="#h378-0-88" id="h378-0-88" class="d">-                context.runOnUiThread {
</a><a href="#h378-0-89" id="h378-0-89" class="d">-                    friendFeedInfoMenu.inject(injectedLayout) { view -&gt;
</a><a href="#h378-0-90" id="h378-0-90" class="d">-                        view.layoutParams = LinearLayout.LayoutParams(
</a><a href="#h378-0-91" id="h378-0-91" class="d">-                            ViewGroup.LayoutParams.MATCH_PARENT,
</a><a href="#h378-0-92" id="h378-0-92" class="d">-                            ViewGroup.LayoutParams.WRAP_CONTENT
</a><a href="#h378-0-93" id="h378-0-93" class="d">-                        ).apply {
</a><a href="#h378-0-94" id="h378-0-94" class="d">-                            setMargins(0, 5, 0, 5)
</a><a href="#h378-0-95" id="h378-0-95" class="d">-                        }
</a><a href="#h378-0-96" id="h378-0-96" class="d">-                        viewList.add(view)
</a><a href="#h378-0-97" id="h378-0-97" class="d">-                    }
</a><a href="#h378-0-98" id="h378-0-98" class="d">-
</a><a href="#h378-0-99" id="h378-0-99" class="d">-                    viewList.add(View(injectedLayout.context).apply {
</a><a href="#h378-0-100" id="h378-0-100" class="d">-                        layoutParams = LinearLayout.LayoutParams(
</a><a href="#h378-0-101" id="h378-0-101" class="d">-                            ViewGroup.LayoutParams.MATCH_PARENT,
</a><a href="#h378-0-102" id="h378-0-102" class="d">-                            30
</a><a href="#h378-0-103" id="h378-0-103" class="d">-                        )
</a><a href="#h378-0-104" id="h378-0-104" class="d">-                    })
</a><a href="#h378-0-105" id="h378-0-105" class="d">-
</a><a href="#h378-0-106" id="h378-0-106" class="d">-                    viewList.reversed().forEach { injectedLayout.addView(it, 0) }
</a><a href="#h378-0-107" id="h378-0-107" class="d">-                }
</a><a href="#h378-0-108" id="h378-0-108" class="d">-
</a><a href="#h378-0-109" id="h378-0-109" class="d">-                event.view = injectedLayout
</a><a href="#h378-0-110" id="h378-0-110" class="d">-            }
</a><a href="#h378-0-111" id="h378-0-111" class="d">-
</a><a href="#h378-0-112" id="h378-0-112" class="d">-            if (viewGroup is LinearLayout &amp;&amp; viewGroup.id == actionSheetItemsContainerLayoutId) {
</a><a href="#h378-0-113" id="h378-0-113" class="d">-                val itemStringInterface by lazy {
</a><a href="#h378-0-114" id="h378-0-114" class="d">-                    childView.javaClass.declaredFields.filter {
</a><a href="#h378-0-115" id="h378-0-115" class="d">-                        !it.type.isPrimitive &amp;&amp; Modifier.isAbstract(it.type.modifiers)
</a><a href="#h378-0-116" id="h378-0-116" class="d">-                    }.map {
</a><a href="#h378-0-117" id="h378-0-117" class="d">-                        runCatching {
</a><a href="#h378-0-118" id="h378-0-118" class="d">-                            it.isAccessible = true
</a><a href="#h378-0-119" id="h378-0-119" class="d">-                            it[childView]
</a><a href="#h378-0-120" id="h378-0-120" class="d">-                        }.getOrNull()
</a><a href="#h378-0-121" id="h378-0-121" class="d">-                    }.firstOrNull()
</a><a href="#h378-0-122" id="h378-0-122" class="d">-                }
</a><a href="#h378-0-123" id="h378-0-123" class="d">-
</a><a href="#h378-0-124" id="h378-0-124" class="d">-                //the 3 dot button shows a menu which contains the first item as a Plain object
</a><a href="#h378-0-125" id="h378-0-125" class="d">-                if (viewGroup.getChildCount() == 0 &amp;&amp; itemStringInterface != null &amp;&amp; itemStringInterface.toString().startsWith(&quot;Plain(primaryText=$newChatString&quot;)) {
</a><a href="#h378-0-126" id="h378-0-126" class="d">-                    settingMenu.inject(viewGroup, originalAddView)
</a><a href="#h378-0-127" id="h378-0-127" class="d">-                    viewGroup.addOnAttachStateChangeListener(object: View.OnAttachStateChangeListener {
</a><a href="#h378-0-128" id="h378-0-128" class="d">-                        override fun onViewAttachedToWindow(v: View) {}
</a><a href="#h378-0-129" id="h378-0-129" class="d">-                        override fun onViewDetachedFromWindow(v: View) {
</a><a href="#h378-0-130" id="h378-0-130" class="d">-                            viewTagState.removeState(viewGroup)
</a><a href="#h378-0-131" id="h378-0-131" class="d">-                        }
</a><a href="#h378-0-132" id="h378-0-132" class="d">-                    })
</a><a href="#h378-0-133" id="h378-0-133" class="d">-                    viewTagState[viewGroup]
</a><a href="#h378-0-134" id="h378-0-134" class="d">-                    return@subscribe
</a><a href="#h378-0-135" id="h378-0-135" class="d">-                }
</a><a href="#h378-0-136" id="h378-0-136" class="d">-                if (messaging.lastFetchConversationUUID == null || messaging.lastFetchConversationUserUUID == null) return@subscribe
</a><a href="#h378-0-137" id="h378-0-137" class="d">-
</a><a href="#h378-0-138" id="h378-0-138" class="d">-                //filter by the slot index
</a><a href="#h378-0-139" id="h378-0-139" class="d">-                if (viewGroup.getChildCount() != context.config.userInterface.friendFeedMenuPosition.get()) return@subscribe
</a><a href="#h378-0-140" id="h378-0-140" class="d">-                if (viewTagState[viewGroup]) return@subscribe
</a><a href="#h378-0-141" id="h378-0-141" class="d">-                friendFeedInfoMenu.inject(viewGroup, originalAddView)
</a><a href="#h378-0-142" id="h378-0-142" class="d">-            }
</a><a href="#h378-0-143" id="h378-0-143" class="d">-        }
</a><a href="#h378-0-144" id="h378-0-144" class="d">-    }
</a><a href="#h378-0-145" id="h378-0-145" class="d">-}</a><a href="#h378-0-146" id="h378-0-146" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h379" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/OperaContextActionMenu.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/OperaContextActionMenu.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/OperaContextActionMenu.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/OperaContextActionMenu.kt</a></b>
<a href="#h379-0" id="h379-0" class="h">@@ -1,93 +0,0 @@
</a><a href="#h379-0-0" id="h379-0-0" class="d">-package me.rhunk.snapenhance.ui.menu.impl
</a><a href="#h379-0-1" id="h379-0-1" class="d">-
</a><a href="#h379-0-2" id="h379-0-2" class="d">-import android.annotation.SuppressLint
</a><a href="#h379-0-3" id="h379-0-3" class="d">-import android.view.Gravity
</a><a href="#h379-0-4" id="h379-0-4" class="d">-import android.view.View
</a><a href="#h379-0-5" id="h379-0-5" class="d">-import android.view.ViewGroup
</a><a href="#h379-0-6" id="h379-0-6" class="d">-import android.widget.Button
</a><a href="#h379-0-7" id="h379-0-7" class="d">-import android.widget.LinearLayout
</a><a href="#h379-0-8" id="h379-0-8" class="d">-import android.widget.ScrollView
</a><a href="#h379-0-9" id="h379-0-9" class="d">-import me.rhunk.snapenhance.Constants
</a><a href="#h379-0-10" id="h379-0-10" class="d">-import me.rhunk.snapenhance.features.impl.downloader.MediaDownloader
</a><a href="#h379-0-11" id="h379-0-11" class="d">-import me.rhunk.snapenhance.ui.applyTheme
</a><a href="#h379-0-12" id="h379-0-12" class="d">-import me.rhunk.snapenhance.ui.menu.AbstractMenu
</a><a href="#h379-0-13" id="h379-0-13" class="d">-
</a><a href="#h379-0-14" id="h379-0-14" class="d">-@SuppressLint(&quot;DiscouragedApi&quot;)
</a><a href="#h379-0-15" id="h379-0-15" class="d">-class OperaContextActionMenu : AbstractMenu() {
</a><a href="#h379-0-16" id="h379-0-16" class="d">-    private val contextCardsScrollView by lazy {
</a><a href="#h379-0-17" id="h379-0-17" class="d">-        context.resources.getIdentifier(&quot;context_cards_scroll_view&quot;, &quot;id&quot;, Constants.SNAPCHAT_PACKAGE_NAME)
</a><a href="#h379-0-18" id="h379-0-18" class="d">-    }
</a><a href="#h379-0-19" id="h379-0-19" class="d">-
</a><a href="#h379-0-20" id="h379-0-20" class="d">-    /*
</a><a href="#h379-0-21" id="h379-0-21" class="d">-    LinearLayout :
</a><a href="#h379-0-22" id="h379-0-22" class="d">-        - LinearLayout:
</a><a href="#h379-0-23" id="h379-0-23" class="d">-            - SnapFontTextView
</a><a href="#h379-0-24" id="h379-0-24" class="d">-            - ImageView
</a><a href="#h379-0-25" id="h379-0-25" class="d">-        - LinearLayout:
</a><a href="#h379-0-26" id="h379-0-26" class="d">-            - SnapFontTextView
</a><a href="#h379-0-27" id="h379-0-27" class="d">-            - ImageView
</a><a href="#h379-0-28" id="h379-0-28" class="d">-        - LinearLayout:
</a><a href="#h379-0-29" id="h379-0-29" class="d">-            - SnapFontTextView
</a><a href="#h379-0-30" id="h379-0-30" class="d">-            - ImageView
</a><a href="#h379-0-31" id="h379-0-31" class="d">-     */
</a><a href="#h379-0-32" id="h379-0-32" class="d">-    private fun isViewGroupButtonMenuContainer(viewGroup: ViewGroup): Boolean {
</a><a href="#h379-0-33" id="h379-0-33" class="d">-        if (viewGroup !is LinearLayout) return false
</a><a href="#h379-0-34" id="h379-0-34" class="d">-        val children = ArrayList&lt;View&gt;()
</a><a href="#h379-0-35" id="h379-0-35" class="d">-        for (i in 0 until viewGroup.getChildCount())
</a><a href="#h379-0-36" id="h379-0-36" class="d">-            children.add(viewGroup.getChildAt(i))
</a><a href="#h379-0-37" id="h379-0-37" class="d">-        return if (children.any { view: View? -&gt; view !is LinearLayout })
</a><a href="#h379-0-38" id="h379-0-38" class="d">-            false
</a><a href="#h379-0-39" id="h379-0-39" class="d">-        else children.map { view: View -&gt; view as LinearLayout }
</a><a href="#h379-0-40" id="h379-0-40" class="d">-            .any { linearLayout: LinearLayout -&gt;
</a><a href="#h379-0-41" id="h379-0-41" class="d">-                val viewChildren = ArrayList&lt;View&gt;()
</a><a href="#h379-0-42" id="h379-0-42" class="d">-                for (i in 0 until linearLayout.childCount) viewChildren.add(
</a><a href="#h379-0-43" id="h379-0-43" class="d">-                    linearLayout.getChildAt(
</a><a href="#h379-0-44" id="h379-0-44" class="d">-                        i
</a><a href="#h379-0-45" id="h379-0-45" class="d">-                    )
</a><a href="#h379-0-46" id="h379-0-46" class="d">-                )
</a><a href="#h379-0-47" id="h379-0-47" class="d">-                viewChildren.any { viewChild: View -&gt;
</a><a href="#h379-0-48" id="h379-0-48" class="d">-                    viewChild.javaClass.name.endsWith(&quot;SnapFontTextView&quot;)
</a><a href="#h379-0-49" id="h379-0-49" class="d">-                }
</a><a href="#h379-0-50" id="h379-0-50" class="d">-            }
</a><a href="#h379-0-51" id="h379-0-51" class="d">-    }
</a><a href="#h379-0-52" id="h379-0-52" class="d">-
</a><a href="#h379-0-53" id="h379-0-53" class="d">-    @SuppressLint(&quot;SetTextI18n&quot;)
</a><a href="#h379-0-54" id="h379-0-54" class="d">-    fun inject(viewGroup: ViewGroup, childView: View) {
</a><a href="#h379-0-55" id="h379-0-55" class="d">-        try {
</a><a href="#h379-0-56" id="h379-0-56" class="d">-            if (viewGroup.parent !is ScrollView) return
</a><a href="#h379-0-57" id="h379-0-57" class="d">-            val parent = viewGroup.parent as ScrollView
</a><a href="#h379-0-58" id="h379-0-58" class="d">-            if (parent.id != contextCardsScrollView) return
</a><a href="#h379-0-59" id="h379-0-59" class="d">-            if (childView !is LinearLayout) return
</a><a href="#h379-0-60" id="h379-0-60" class="d">-            if (!isViewGroupButtonMenuContainer(childView as ViewGroup)) return
</a><a href="#h379-0-61" id="h379-0-61" class="d">-
</a><a href="#h379-0-62" id="h379-0-62" class="d">-            val linearLayout = LinearLayout(childView.getContext())
</a><a href="#h379-0-63" id="h379-0-63" class="d">-            linearLayout.orientation = LinearLayout.VERTICAL
</a><a href="#h379-0-64" id="h379-0-64" class="d">-            linearLayout.gravity = Gravity.CENTER
</a><a href="#h379-0-65" id="h379-0-65" class="d">-            linearLayout.layoutParams =
</a><a href="#h379-0-66" id="h379-0-66" class="d">-                LinearLayout.LayoutParams(
</a><a href="#h379-0-67" id="h379-0-67" class="d">-                    ViewGroup.LayoutParams.MATCH_PARENT,
</a><a href="#h379-0-68" id="h379-0-68" class="d">-                    ViewGroup.LayoutParams.MATCH_PARENT
</a><a href="#h379-0-69" id="h379-0-69" class="d">-                )
</a><a href="#h379-0-70" id="h379-0-70" class="d">-            val translation = context.translation
</a><a href="#h379-0-71" id="h379-0-71" class="d">-            val mediaDownloader = context.feature(MediaDownloader::class)
</a><a href="#h379-0-72" id="h379-0-72" class="d">-
</a><a href="#h379-0-73" id="h379-0-73" class="d">-            linearLayout.addView(Button(childView.getContext()).apply {
</a><a href="#h379-0-74" id="h379-0-74" class="d">-                text = translation[&quot;opera_context_menu.download&quot;]
</a><a href="#h379-0-75" id="h379-0-75" class="d">-                setOnClickListener { mediaDownloader.downloadLastOperaMediaAsync() }
</a><a href="#h379-0-76" id="h379-0-76" class="d">-                applyTheme(isAmoled = false)
</a><a href="#h379-0-77" id="h379-0-77" class="d">-            })
</a><a href="#h379-0-78" id="h379-0-78" class="d">-
</a><a href="#h379-0-79" id="h379-0-79" class="d">-            if (context.isDeveloper) {
</a><a href="#h379-0-80" id="h379-0-80" class="d">-                linearLayout.addView(Button(childView.getContext()).apply {
</a><a href="#h379-0-81" id="h379-0-81" class="d">-                    text = &quot;Show debug info&quot;
</a><a href="#h379-0-82" id="h379-0-82" class="d">-                    setOnClickListener { mediaDownloader.showLastOperaDebugMediaInfo() }
</a><a href="#h379-0-83" id="h379-0-83" class="d">-                    applyTheme(isAmoled = false)
</a><a href="#h379-0-84" id="h379-0-84" class="d">-                })
</a><a href="#h379-0-85" id="h379-0-85" class="d">-            }
</a><a href="#h379-0-86" id="h379-0-86" class="d">-
</a><a href="#h379-0-87" id="h379-0-87" class="d">-            (childView as ViewGroup).addView(linearLayout, 0)
</a><a href="#h379-0-88" id="h379-0-88" class="d">-        } catch (e: Throwable) {
</a><a href="#h379-0-89" id="h379-0-89" class="d">-            context.log.error(&quot;Error while injecting OperaContextActionMenu&quot;, e)
</a><a href="#h379-0-90" id="h379-0-90" class="d">-        }
</a><a href="#h379-0-91" id="h379-0-91" class="d">-    }
</a><a href="#h379-0-92" id="h379-0-92" class="d">-}
</a><b>diff --git a/<a id="h380" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/SettingsGearInjector.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/SettingsGearInjector.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/SettingsGearInjector.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/SettingsGearInjector.kt</a></b>
<a href="#h380-0" id="h380-0" class="h">@@ -1,85 +0,0 @@
</a><a href="#h380-0-0" id="h380-0-0" class="d">-package me.rhunk.snapenhance.ui.menu.impl
</a><a href="#h380-0-1" id="h380-0-1" class="d">-
</a><a href="#h380-0-2" id="h380-0-2" class="d">-import android.annotation.SuppressLint
</a><a href="#h380-0-3" id="h380-0-3" class="d">-import android.content.Intent
</a><a href="#h380-0-4" id="h380-0-4" class="d">-import android.view.View
</a><a href="#h380-0-5" id="h380-0-5" class="d">-import android.view.ViewGroup
</a><a href="#h380-0-6" id="h380-0-6" class="d">-import android.widget.FrameLayout
</a><a href="#h380-0-7" id="h380-0-7" class="d">-import android.widget.ImageView
</a><a href="#h380-0-8" id="h380-0-8" class="d">-import me.rhunk.snapenhance.Constants
</a><a href="#h380-0-9" id="h380-0-9" class="d">-import me.rhunk.snapenhance.core.BuildConfig
</a><a href="#h380-0-10" id="h380-0-10" class="d">-import me.rhunk.snapenhance.ui.menu.AbstractMenu
</a><a href="#h380-0-11" id="h380-0-11" class="d">-
</a><a href="#h380-0-12" id="h380-0-12" class="d">-
</a><a href="#h380-0-13" id="h380-0-13" class="d">-@SuppressLint(&quot;DiscouragedApi&quot;)
</a><a href="#h380-0-14" id="h380-0-14" class="d">-class SettingsGearInjector : AbstractMenu() {
</a><a href="#h380-0-15" id="h380-0-15" class="d">-    private val headerButtonOpaqueIconTint by lazy {
</a><a href="#h380-0-16" id="h380-0-16" class="d">-        context.resources.getIdentifier(&quot;headerButtonOpaqueIconTint&quot;, &quot;attr&quot;, Constants.SNAPCHAT_PACKAGE_NAME).let {
</a><a href="#h380-0-17" id="h380-0-17" class="d">-            context.androidContext.theme.obtainStyledAttributes(intArrayOf(it)).getColorStateList(0)
</a><a href="#h380-0-18" id="h380-0-18" class="d">-        }
</a><a href="#h380-0-19" id="h380-0-19" class="d">-    }
</a><a href="#h380-0-20" id="h380-0-20" class="d">-
</a><a href="#h380-0-21" id="h380-0-21" class="d">-    private val settingsSvg by lazy {
</a><a href="#h380-0-22" id="h380-0-22" class="d">-        context.resources.getIdentifier(&quot;svg_settings_32x32&quot;, &quot;drawable&quot;, Constants.SNAPCHAT_PACKAGE_NAME).let {
</a><a href="#h380-0-23" id="h380-0-23" class="d">-            context.resources.getDrawable(it, context.androidContext.theme)
</a><a href="#h380-0-24" id="h380-0-24" class="d">-        }
</a><a href="#h380-0-25" id="h380-0-25" class="d">-    }
</a><a href="#h380-0-26" id="h380-0-26" class="d">-
</a><a href="#h380-0-27" id="h380-0-27" class="d">-    private val ngsHovaHeaderSearchIconBackgroundMarginLeft by lazy {
</a><a href="#h380-0-28" id="h380-0-28" class="d">-        context.resources.getIdentifier(&quot;ngs_hova_header_search_icon_background_margin_left&quot;, &quot;dimen&quot;, Constants.SNAPCHAT_PACKAGE_NAME).let {
</a><a href="#h380-0-29" id="h380-0-29" class="d">-            context.resources.getDimensionPixelSize(it)
</a><a href="#h380-0-30" id="h380-0-30" class="d">-        }
</a><a href="#h380-0-31" id="h380-0-31" class="d">-    }
</a><a href="#h380-0-32" id="h380-0-32" class="d">-
</a><a href="#h380-0-33" id="h380-0-33" class="d">-    @SuppressLint(&quot;SetTextI18n&quot;, &quot;ClickableViewAccessibility&quot;)
</a><a href="#h380-0-34" id="h380-0-34" class="d">-    fun inject(parent: ViewGroup, child: View) {
</a><a href="#h380-0-35" id="h380-0-35" class="d">-        val firstView = (child as ViewGroup).getChildAt(0)
</a><a href="#h380-0-36" id="h380-0-36" class="d">-
</a><a href="#h380-0-37" id="h380-0-37" class="d">-        child.clipChildren = false
</a><a href="#h380-0-38" id="h380-0-38" class="d">-        child.addView(FrameLayout(parent.context).apply {
</a><a href="#h380-0-39" id="h380-0-39" class="d">-            layoutParams = FrameLayout.LayoutParams(firstView.layoutParams.width, firstView.layoutParams.height).apply {
</a><a href="#h380-0-40" id="h380-0-40" class="d">-                y = 0f
</a><a href="#h380-0-41" id="h380-0-41" class="d">-                x = -(ngsHovaHeaderSearchIconBackgroundMarginLeft + firstView.layoutParams.width).toFloat()
</a><a href="#h380-0-42" id="h380-0-42" class="d">-            }
</a><a href="#h380-0-43" id="h380-0-43" class="d">-
</a><a href="#h380-0-44" id="h380-0-44" class="d">-            isClickable = true
</a><a href="#h380-0-45" id="h380-0-45" class="d">-
</a><a href="#h380-0-46" id="h380-0-46" class="d">-            setOnClickListener {
</a><a href="#h380-0-47" id="h380-0-47" class="d">-               /* val intent = Intent().apply {
</a><a href="#h380-0-48" id="h380-0-48" class="d">-                    setClassName(BuildConfig.APPLICATION_ID, &quot;me.rhunk.snapenhance.ui.manager.MainActivity&quot;)
</a><a href="#h380-0-49" id="h380-0-49" class="d">-                    putExtra(&quot;route&quot;, &quot;features&quot;)
</a><a href="#h380-0-50" id="h380-0-50" class="d">-                }
</a><a href="#h380-0-51" id="h380-0-51" class="d">-                context.startActivity(intent)*/
</a><a href="#h380-0-52" id="h380-0-52" class="d">-                this@SettingsGearInjector.context.bridgeClient.openSettingsOverlay()
</a><a href="#h380-0-53" id="h380-0-53" class="d">-            }
</a><a href="#h380-0-54" id="h380-0-54" class="d">-
</a><a href="#h380-0-55" id="h380-0-55" class="d">-            parent.setOnTouchListener { _, event -&gt;
</a><a href="#h380-0-56" id="h380-0-56" class="d">-                if (child.visibility == View.INVISIBLE || child.alpha == 0F) return@setOnTouchListener false
</a><a href="#h380-0-57" id="h380-0-57" class="d">-
</a><a href="#h380-0-58" id="h380-0-58" class="d">-                val viewLocation = IntArray(2)
</a><a href="#h380-0-59" id="h380-0-59" class="d">-                getLocationOnScreen(viewLocation)
</a><a href="#h380-0-60" id="h380-0-60" class="d">-
</a><a href="#h380-0-61" id="h380-0-61" class="d">-                val x = event.rawX - viewLocation[0]
</a><a href="#h380-0-62" id="h380-0-62" class="d">-                val y = event.rawY - viewLocation[1]
</a><a href="#h380-0-63" id="h380-0-63" class="d">-
</a><a href="#h380-0-64" id="h380-0-64" class="d">-                if (x &gt; 0 &amp;&amp; x &lt; width &amp;&amp; y &gt; 0 &amp;&amp; y &lt; height) {
</a><a href="#h380-0-65" id="h380-0-65" class="d">-                    performClick()
</a><a href="#h380-0-66" id="h380-0-66" class="d">-                }
</a><a href="#h380-0-67" id="h380-0-67" class="d">-
</a><a href="#h380-0-68" id="h380-0-68" class="d">-                false
</a><a href="#h380-0-69" id="h380-0-69" class="d">-            }
</a><a href="#h380-0-70" id="h380-0-70" class="d">-            backgroundTintList = firstView.backgroundTintList
</a><a href="#h380-0-71" id="h380-0-71" class="d">-            background = firstView.background
</a><a href="#h380-0-72" id="h380-0-72" class="d">-
</a><a href="#h380-0-73" id="h380-0-73" class="d">-            addView(ImageView(context).apply {
</a><a href="#h380-0-74" id="h380-0-74" class="d">-                layoutParams = FrameLayout.LayoutParams(ViewGroup.LayoutParams.WRAP_CONTENT, ViewGroup.LayoutParams.WRAP_CONTENT, 17).apply {
</a><a href="#h380-0-75" id="h380-0-75" class="d">-                    gravity = android.view.Gravity.CENTER
</a><a href="#h380-0-76" id="h380-0-76" class="d">-                }
</a><a href="#h380-0-77" id="h380-0-77" class="d">-                setImageDrawable(settingsSvg)
</a><a href="#h380-0-78" id="h380-0-78" class="d">-                headerButtonOpaqueIconTint?.let {
</a><a href="#h380-0-79" id="h380-0-79" class="d">-                    imageTintList = it
</a><a href="#h380-0-80" id="h380-0-80" class="d">-                }
</a><a href="#h380-0-81" id="h380-0-81" class="d">-            })
</a><a href="#h380-0-82" id="h380-0-82" class="d">-        })
</a><a href="#h380-0-83" id="h380-0-83" class="d">-    }
</a><a href="#h380-0-84" id="h380-0-84" class="d">-}</a><a href="#h380-0-85" id="h380-0-85" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h381" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/SettingsMenu.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/SettingsMenu.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/SettingsMenu.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/SettingsMenu.kt</a></b>
<a href="#h381-0" id="h381-0" class="h">@@ -1,29 +0,0 @@
</a><a href="#h381-0-0" id="h381-0-0" class="d">-package me.rhunk.snapenhance.ui.menu.impl
</a><a href="#h381-0-1" id="h381-0-1" class="d">-
</a><a href="#h381-0-2" id="h381-0-2" class="d">-import android.annotation.SuppressLint
</a><a href="#h381-0-3" id="h381-0-3" class="d">-import android.view.View
</a><a href="#h381-0-4" id="h381-0-4" class="d">-import me.rhunk.snapenhance.ui.menu.AbstractMenu
</a><a href="#h381-0-5" id="h381-0-5" class="d">-
</a><a href="#h381-0-6" id="h381-0-6" class="d">-class SettingsMenu : AbstractMenu() {
</a><a href="#h381-0-7" id="h381-0-7" class="d">-    //TODO: quick settings
</a><a href="#h381-0-8" id="h381-0-8" class="d">-    @SuppressLint(&quot;SetTextI18n&quot;)
</a><a href="#h381-0-9" id="h381-0-9" class="d">-    @Suppress(&quot;UNUSED_PARAMETER&quot;)
</a><a href="#h381-0-10" id="h381-0-10" class="d">-    fun inject(viewModel: View, addView: (View) -&gt; Unit) {
</a><a href="#h381-0-11" id="h381-0-11" class="d">-        /*val actions = context.actionManager.getActions().map {
</a><a href="#h381-0-12" id="h381-0-12" class="d">-            Pair(it) {
</a><a href="#h381-0-13" id="h381-0-13" class="d">-                val button = Button(viewModel.context)
</a><a href="#h381-0-14" id="h381-0-14" class="d">-                button.text = context.translation[it.nameKey]
</a><a href="#h381-0-15" id="h381-0-15" class="d">-
</a><a href="#h381-0-16" id="h381-0-16" class="d">-                button.setOnClickListener { _ -&gt;
</a><a href="#h381-0-17" id="h381-0-17" class="d">-                    it.run()
</a><a href="#h381-0-18" id="h381-0-18" class="d">-                }
</a><a href="#h381-0-19" id="h381-0-19" class="d">-                ViewAppearanceHelper.applyTheme(button)
</a><a href="#h381-0-20" id="h381-0-20" class="d">-                button
</a><a href="#h381-0-21" id="h381-0-21" class="d">-            }
</a><a href="#h381-0-22" id="h381-0-22" class="d">-        }
</a><a href="#h381-0-23" id="h381-0-23" class="d">-
</a><a href="#h381-0-24" id="h381-0-24" class="d">-        actions.forEach {
</a><a href="#h381-0-25" id="h381-0-25" class="d">-            addView(it.second())
</a><a href="#h381-0-26" id="h381-0-26" class="d">-        }*/
</a><a href="#h381-0-27" id="h381-0-27" class="d">-    }
</a><a href="#h381-0-28" id="h381-0-28" class="d">-}</a><a href="#h381-0-29" id="h381-0-29" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h382" href="../file/core/src/main/res/drawable/back_arrow.xml.html">core/src/main/res/drawable/back_arrow.xml</a> b/<a href="../file/core/src/main/res/drawable/back_arrow.xml.html">core/src/main/res/drawable/back_arrow.xml</a></b>
<a href="#h382-0" id="h382-0" class="h">@@ -1,11 +0,0 @@
</a><a href="#h382-0-0" id="h382-0-0" class="d">-&lt;vector android:height=&quot;25dp&quot; android:viewportHeight=&quot;512&quot;
</a><a href="#h382-0-1" id="h382-0-1" class="d">-    android:viewportWidth=&quot;512&quot; android:width=&quot;25dp&quot; xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;&gt;
</a><a href="#h382-0-2" id="h382-0-2" class="d">-    &lt;path android:fillColor=&quot;#00000000&quot;
</a><a href="#h382-0-3" id="h382-0-3" class="d">-        android:pathData=&quot;M244,400l-144,-144l144,-144&quot;
</a><a href="#h382-0-4" id="h382-0-4" class="d">-        android:strokeColor=&quot;#FFFFFF&quot; android:strokeLineCap=&quot;round&quot;
</a><a href="#h382-0-5" id="h382-0-5" class="d">-        android:strokeLineJoin=&quot;round&quot; android:strokeWidth=&quot;48&quot;/&gt;
</a><a href="#h382-0-6" id="h382-0-6" class="d">-    &lt;path android:fillColor=&quot;#00000000&quot;
</a><a href="#h382-0-7" id="h382-0-7" class="d">-        android:pathData=&quot;M120,256L412,256&quot;
</a><a href="#h382-0-8" id="h382-0-8" class="d">-        android:strokeColor=&quot;#FFFFFF&quot; android:strokeLineCap=&quot;round&quot;
</a><a href="#h382-0-9" id="h382-0-9" class="d">-        android:strokeLineJoin=&quot;round&quot; android:strokeWidth=&quot;48&quot;/&gt;
</a><a href="#h382-0-10" id="h382-0-10" class="d">-&lt;/vector&gt;
</a><b>diff --git a/<a id="h383" href="../file/core/src/main/res/font/avenir_next_bold.ttf.html">core/src/main/res/font/avenir_next_bold.ttf</a> b/<a href="../file/core/src/main/res/font/avenir_next_bold.ttf.html">core/src/main/res/font/avenir_next_bold.ttf</a></b>
Binary files differ.
<b>diff --git a/<a id="h384" href="../file/core/src/main/res/font/avenir_next_medium.ttf.html">core/src/main/res/font/avenir_next_medium.ttf</a> b/<a href="../file/core/src/main/res/font/avenir_next_medium.ttf.html">core/src/main/res/font/avenir_next_medium.ttf</a></b>
Binary files differ.
<b>diff --git a/<a id="h385" href="../file/core/src/main/res/layout/activity_default_header.xml.html">core/src/main/res/layout/activity_default_header.xml</a> b/<a href="../file/core/src/main/res/layout/activity_default_header.xml.html">core/src/main/res/layout/activity_default_header.xml</a></b>
<a href="#h385-0" id="h385-0" class="h">@@ -1,36 +0,0 @@
</a><a href="#h385-0-0" id="h385-0-0" class="d">-&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
</a><a href="#h385-0-1" id="h385-0-1" class="d">-&lt;FrameLayout
</a><a href="#h385-0-2" id="h385-0-2" class="d">-    xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;
</a><a href="#h385-0-3" id="h385-0-3" class="d">-    xmlns:tools=&quot;http://schemas.android.com/tools&quot;
</a><a href="#h385-0-4" id="h385-0-4" class="d">-    android:id=&quot;@+id/title_bar&quot;
</a><a href="#h385-0-5" id="h385-0-5" class="d">-    android:layout_width=&quot;match_parent&quot;
</a><a href="#h385-0-6" id="h385-0-6" class="d">-    android:layout_height=&quot;50dp&quot;
</a><a href="#h385-0-7" id="h385-0-7" class="d">-    tools:ignore=&quot;UselessParent&quot;&gt;
</a><a href="#h385-0-8" id="h385-0-8" class="d">-
</a><a href="#h385-0-9" id="h385-0-9" class="d">-    &lt;ImageButton
</a><a href="#h385-0-10" id="h385-0-10" class="d">-        android:id=&quot;@+id/back_button&quot;
</a><a href="#h385-0-11" id="h385-0-11" class="d">-        android:layout_width=&quot;45dp&quot;
</a><a href="#h385-0-12" id="h385-0-12" class="d">-        android:layout_height=&quot;match_parent&quot;
</a><a href="#h385-0-13" id="h385-0-13" class="d">-        android:background=&quot;@null&quot;
</a><a href="#h385-0-14" id="h385-0-14" class="d">-        android:src=&quot;@drawable/back_arrow&quot;
</a><a href="#h385-0-15" id="h385-0-15" class="d">-        android:layout_gravity=&quot;center_vertical|start&quot;
</a><a href="#h385-0-16" id="h385-0-16" class="d">-        android:padding=&quot;8dp&quot;
</a><a href="#h385-0-17" id="h385-0-17" class="d">-        tools:ignore=&quot;ContentDescription&quot; /&gt;
</a><a href="#h385-0-18" id="h385-0-18" class="d">-
</a><a href="#h385-0-19" id="h385-0-19" class="d">-    &lt;View
</a><a href="#h385-0-20" id="h385-0-20" class="d">-        android:layout_width=&quot;match_parent&quot;
</a><a href="#h385-0-21" id="h385-0-21" class="d">-        android:layout_height=&quot;1dp&quot;
</a><a href="#h385-0-22" id="h385-0-22" class="d">-        android:background=&quot;@color/borderColor&quot;
</a><a href="#h385-0-23" id="h385-0-23" class="d">-        android:layout_gravity=&quot;bottom&quot; /&gt;
</a><a href="#h385-0-24" id="h385-0-24" class="d">-
</a><a href="#h385-0-25" id="h385-0-25" class="d">-    &lt;TextView
</a><a href="#h385-0-26" id="h385-0-26" class="d">-        android:id=&quot;@+id/title&quot;
</a><a href="#h385-0-27" id="h385-0-27" class="d">-        android:layout_width=&quot;match_parent&quot;
</a><a href="#h385-0-28" id="h385-0-28" class="d">-        android:layout_height=&quot;match_parent&quot;
</a><a href="#h385-0-29" id="h385-0-29" class="d">-        android:gravity=&quot;center&quot;
</a><a href="#h385-0-30" id="h385-0-30" class="d">-        android:text=&quot;&quot;
</a><a href="#h385-0-31" id="h385-0-31" class="d">-        android:textColor=&quot;@color/primaryText&quot;
</a><a href="#h385-0-32" id="h385-0-32" class="d">-        android:textSize=&quot;23sp&quot;
</a><a href="#h385-0-33" id="h385-0-33" class="d">-        android:fontFamily=&quot;@font/avenir_next_bold&quot; /&gt;
</a><a href="#h385-0-34" id="h385-0-34" class="d">-
</a><a href="#h385-0-35" id="h385-0-35" class="d">-&lt;/FrameLayout&gt;</a><a href="#h385-0-36" id="h385-0-36" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h386" href="../file/core/src/main/res/layout/debug_setting_item.xml.html">core/src/main/res/layout/debug_setting_item.xml</a> b/<a href="../file/core/src/main/res/layout/debug_setting_item.xml.html">core/src/main/res/layout/debug_setting_item.xml</a></b>
<a href="#h386-0" id="h386-0" class="h">@@ -1,18 +0,0 @@
</a><a href="#h386-0-0" id="h386-0-0" class="d">-&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
</a><a href="#h386-0-1" id="h386-0-1" class="d">-&lt;LinearLayout xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;
</a><a href="#h386-0-2" id="h386-0-2" class="d">-        android:layout_width=&quot;match_parent&quot;
</a><a href="#h386-0-3" id="h386-0-3" class="d">-        android:layout_height=&quot;60dp&quot;
</a><a href="#h386-0-4" id="h386-0-4" class="d">-        android:orientation=&quot;horizontal&quot;
</a><a href="#h386-0-5" id="h386-0-5" class="d">-        android:padding=&quot;16dp&quot;&gt;
</a><a href="#h386-0-6" id="h386-0-6" class="d">-
</a><a href="#h386-0-7" id="h386-0-7" class="d">-        &lt;TextView
</a><a href="#h386-0-8" id="h386-0-8" class="d">-            android:id=&quot;@+id/feature_text&quot;
</a><a href="#h386-0-9" id="h386-0-9" class="d">-            android:layout_width=&quot;0dp&quot;
</a><a href="#h386-0-10" id="h386-0-10" class="d">-            android:layout_height=&quot;wrap_content&quot;
</a><a href="#h386-0-11" id="h386-0-11" class="d">-            android:layout_gravity=&quot;center_vertical&quot;
</a><a href="#h386-0-12" id="h386-0-12" class="d">-            android:layout_weight=&quot;1&quot;
</a><a href="#h386-0-13" id="h386-0-13" class="d">-            android:text=&quot;&quot;
</a><a href="#h386-0-14" id="h386-0-14" class="d">-            android:textColor=&quot;@color/primaryText&quot;
</a><a href="#h386-0-15" id="h386-0-15" class="d">-            android:textSize=&quot;16sp&quot; /&gt;
</a><a href="#h386-0-16" id="h386-0-16" class="d">-
</a><a href="#h386-0-17" id="h386-0-17" class="d">-&lt;/LinearLayout&gt;</a><a href="#h386-0-18" id="h386-0-18" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h387" href="../file/core/src/main/res/layout/debug_settings_page.xml.html">core/src/main/res/layout/debug_settings_page.xml</a> b/<a href="../file/core/src/main/res/layout/debug_settings_page.xml.html">core/src/main/res/layout/debug_settings_page.xml</a></b>
<a href="#h387-0" id="h387-0" class="h">@@ -1,21 +0,0 @@
</a><a href="#h387-0-0" id="h387-0-0" class="d">-&lt;LinearLayout xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;
</a><a href="#h387-0-1" id="h387-0-1" class="d">-    android:id=&quot;@+id/setting_page&quot;
</a><a href="#h387-0-2" id="h387-0-2" class="d">-    android:clickable=&quot;true&quot;
</a><a href="#h387-0-3" id="h387-0-3" class="d">-    android:layout_width=&quot;match_parent&quot;
</a><a href="#h387-0-4" id="h387-0-4" class="d">-    android:layout_height=&quot;match_parent&quot;
</a><a href="#h387-0-5" id="h387-0-5" class="d">-    android:background=&quot;@color/primaryBackground&quot;
</a><a href="#h387-0-6" id="h387-0-6" class="d">-    android:orientation=&quot;vertical&quot;&gt;
</a><a href="#h387-0-7" id="h387-0-7" class="d">-
</a><a href="#h387-0-8" id="h387-0-8" class="d">-    &lt;include
</a><a href="#h387-0-9" id="h387-0-9" class="d">-        android:id=&quot;@+id/title_bar&quot;
</a><a href="#h387-0-10" id="h387-0-10" class="d">-        layout=&quot;@layout/activity_default_header&quot; /&gt;
</a><a href="#h387-0-11" id="h387-0-11" class="d">-
</a><a href="#h387-0-12" id="h387-0-12" class="d">-    &lt;ListView
</a><a href="#h387-0-13" id="h387-0-13" class="d">-        android:id=&quot;@+id/setting_page_list&quot;
</a><a href="#h387-0-14" id="h387-0-14" class="d">-        android:layout_width=&quot;match_parent&quot;
</a><a href="#h387-0-15" id="h387-0-15" class="d">-        android:layout_height=&quot;match_parent&quot;
</a><a href="#h387-0-16" id="h387-0-16" class="d">-        android:listSelector=&quot;@android:color/transparent&quot;
</a><a href="#h387-0-17" id="h387-0-17" class="d">-        android:orientation=&quot;vertical&quot;&gt;
</a><a href="#h387-0-18" id="h387-0-18" class="d">-    &lt;/ListView&gt;
</a><a href="#h387-0-19" id="h387-0-19" class="d">-
</a><a href="#h387-0-20" id="h387-0-20" class="d">-&lt;/LinearLayout&gt;
</a><b>diff --git a/<a id="h388" href="../file/core/src/main/res/layout/device_spoofer_activity.xml.html">core/src/main/res/layout/device_spoofer_activity.xml</a> b/<a href="../file/core/src/main/res/layout/device_spoofer_activity.xml.html">core/src/main/res/layout/device_spoofer_activity.xml</a></b>
<a href="#h388-0" id="h388-0" class="h">@@ -1,27 +0,0 @@
</a><a href="#h388-0-0" id="h388-0-0" class="d">-&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
</a><a href="#h388-0-1" id="h388-0-1" class="d">-&lt;LinearLayout xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;
</a><a href="#h388-0-2" id="h388-0-2" class="d">-    xmlns:tools=&quot;http://schemas.android.com/tools&quot;
</a><a href="#h388-0-3" id="h388-0-3" class="d">-    android:orientation=&quot;vertical&quot;
</a><a href="#h388-0-4" id="h388-0-4" class="d">-    android:background=&quot;@color/primaryBackground&quot;
</a><a href="#h388-0-5" id="h388-0-5" class="d">-    android:layout_width=&quot;match_parent&quot;
</a><a href="#h388-0-6" id="h388-0-6" class="d">-    android:layout_height=&quot;match_parent&quot;&gt;
</a><a href="#h388-0-7" id="h388-0-7" class="d">-
</a><a href="#h388-0-8" id="h388-0-8" class="d">-    &lt;include
</a><a href="#h388-0-9" id="h388-0-9" class="d">-        android:id=&quot;@+id/title_bar&quot;
</a><a href="#h388-0-10" id="h388-0-10" class="d">-        layout=&quot;@layout/activity_default_header&quot; /&gt;
</a><a href="#h388-0-11" id="h388-0-11" class="d">-
</a><a href="#h388-0-12" id="h388-0-12" class="d">-    &lt;ScrollView
</a><a href="#h388-0-13" id="h388-0-13" class="d">-        android:layout_width=&quot;match_parent&quot;
</a><a href="#h388-0-14" id="h388-0-14" class="d">-        android:layout_height=&quot;match_parent&quot;
</a><a href="#h388-0-15" id="h388-0-15" class="d">-        android:fillViewport=&quot;true&quot;&gt;
</a><a href="#h388-0-16" id="h388-0-16" class="d">-
</a><a href="#h388-0-17" id="h388-0-17" class="d">-        &lt;LinearLayout
</a><a href="#h388-0-18" id="h388-0-18" class="d">-            android:id=&quot;@+id/spoof_property_list&quot;
</a><a href="#h388-0-19" id="h388-0-19" class="d">-            android:layout_width=&quot;match_parent&quot;
</a><a href="#h388-0-20" id="h388-0-20" class="d">-            android:layout_height=&quot;wrap_content&quot;
</a><a href="#h388-0-21" id="h388-0-21" class="d">-            android:orientation=&quot;vertical&quot;&gt;
</a><a href="#h388-0-22" id="h388-0-22" class="d">-        &lt;/LinearLayout&gt;
</a><a href="#h388-0-23" id="h388-0-23" class="d">-
</a><a href="#h388-0-24" id="h388-0-24" class="d">-    &lt;/ScrollView&gt;
</a><a href="#h388-0-25" id="h388-0-25" class="d">-
</a><a href="#h388-0-26" id="h388-0-26" class="d">-&lt;/LinearLayout&gt;</a><a href="#h388-0-27" id="h388-0-27" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h389" href="../file/core/src/main/res/layout/map.xml.html">core/src/main/res/layout/map.xml</a> b/<a href="../file/core/src/main/res/layout/map.xml.html">core/src/main/res/layout/map.xml</a></b>
<a href="#h389-0" id="h389-0" class="h">@@ -1,44 +0,0 @@
</a><a href="#h389-0-0" id="h389-0-0" class="d">-&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
</a><a href="#h389-0-1" id="h389-0-1" class="d">-&lt;FrameLayout xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;
</a><a href="#h389-0-2" id="h389-0-2" class="d">-    xmlns:tools=&quot;http://schemas.android.com/tools&quot;
</a><a href="#h389-0-3" id="h389-0-3" class="d">-    android:layout_width=&quot;match_parent&quot;
</a><a href="#h389-0-4" id="h389-0-4" class="d">-    android:layout_height=&quot;match_parent&quot;&gt;
</a><a href="#h389-0-5" id="h389-0-5" class="d">-
</a><a href="#h389-0-6" id="h389-0-6" class="d">-    &lt;org.osmdroid.views.MapView
</a><a href="#h389-0-7" id="h389-0-7" class="d">-        android:id=&quot;@+id/mapView&quot;
</a><a href="#h389-0-8" id="h389-0-8" class="d">-        android:layout_width=&quot;match_parent&quot;
</a><a href="#h389-0-9" id="h389-0-9" class="d">-        android:layout_height=&quot;match_parent&quot; &gt;
</a><a href="#h389-0-10" id="h389-0-10" class="d">-
</a><a href="#h389-0-11" id="h389-0-11" class="d">-    &lt;/org.osmdroid.views.MapView&gt;
</a><a href="#h389-0-12" id="h389-0-12" class="d">-
</a><a href="#h389-0-13" id="h389-0-13" class="d">-    &lt;FrameLayout
</a><a href="#h389-0-14" id="h389-0-14" class="d">-        android:layout_width=&quot;match_parent&quot;
</a><a href="#h389-0-15" id="h389-0-15" class="d">-        android:layout_height=&quot;wrap_content&quot;&gt;
</a><a href="#h389-0-16" id="h389-0-16" class="d">-
</a><a href="#h389-0-17" id="h389-0-17" class="d">-        &lt;Button
</a><a href="#h389-0-18" id="h389-0-18" class="d">-            android:id=&quot;@+id/set_precise_location_button&quot;
</a><a href="#h389-0-19" id="h389-0-19" class="d">-            android:layout_width=&quot;wrap_content&quot;
</a><a href="#h389-0-20" id="h389-0-20" class="d">-            android:layout_height=&quot;match_parent&quot;
</a><a href="#h389-0-21" id="h389-0-21" class="d">-            android:layout_gravity=&quot;left&quot;
</a><a href="#h389-0-22" id="h389-0-22" class="d">-            android:layout_marginStart=&quot;20dp&quot;
</a><a href="#h389-0-23" id="h389-0-23" class="d">-            android:layout_marginTop=&quot;20dp&quot;
</a><a href="#h389-0-24" id="h389-0-24" class="d">-            android:padding=&quot;10dp&quot;
</a><a href="#h389-0-25" id="h389-0-25" class="d">-            android:background=&quot;@android:color/white&quot;
</a><a href="#h389-0-26" id="h389-0-26" class="d">-            android:text=&quot;Set Precise Location&quot;
</a><a href="#h389-0-27" id="h389-0-27" class="d">-            android:textSize=&quot;20sp&quot;
</a><a href="#h389-0-28" id="h389-0-28" class="d">-            tools:ignore=&quot;HardcodedText,RtlHardcoded&quot; /&gt;
</a><a href="#h389-0-29" id="h389-0-29" class="d">-
</a><a href="#h389-0-30" id="h389-0-30" class="d">-        &lt;Button
</a><a href="#h389-0-31" id="h389-0-31" class="d">-            android:id=&quot;@+id/apply_location_button&quot;
</a><a href="#h389-0-32" id="h389-0-32" class="d">-            android:layout_width=&quot;wrap_content&quot;
</a><a href="#h389-0-33" id="h389-0-33" class="d">-            android:layout_height=&quot;wrap_content&quot;
</a><a href="#h389-0-34" id="h389-0-34" class="d">-            android:layout_gravity=&quot;right&quot;
</a><a href="#h389-0-35" id="h389-0-35" class="d">-            android:layout_marginTop=&quot;20dp&quot;
</a><a href="#h389-0-36" id="h389-0-36" class="d">-            android:layout_marginRight=&quot;20dp&quot;
</a><a href="#h389-0-37" id="h389-0-37" class="d">-            android:background=&quot;@android:color/white&quot;
</a><a href="#h389-0-38" id="h389-0-38" class="d">-            android:text=&quot;Apply&quot;
</a><a href="#h389-0-39" id="h389-0-39" class="d">-            android:textSize=&quot;20sp&quot;
</a><a href="#h389-0-40" id="h389-0-40" class="d">-            tools:ignore=&quot;HardcodedText,RtlHardcoded&quot; /&gt;
</a><a href="#h389-0-41" id="h389-0-41" class="d">-    &lt;/FrameLayout&gt;
</a><a href="#h389-0-42" id="h389-0-42" class="d">-
</a><a href="#h389-0-43" id="h389-0-43" class="d">-&lt;/FrameLayout&gt;
</a><b>diff --git a/<a id="h390" href="../file/core/src/main/res/layout/precise_location_dialog.xml.html">core/src/main/res/layout/precise_location_dialog.xml</a> b/<a href="../file/core/src/main/res/layout/precise_location_dialog.xml.html">core/src/main/res/layout/precise_location_dialog.xml</a></b>
<a href="#h390-0" id="h390-0" class="h">@@ -1,28 +0,0 @@
</a><a href="#h390-0-0" id="h390-0-0" class="d">-&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
</a><a href="#h390-0-1" id="h390-0-1" class="d">-&lt;LinearLayout xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;
</a><a href="#h390-0-2" id="h390-0-2" class="d">-    xmlns:tools=&quot;http://schemas.android.com/tools&quot;
</a><a href="#h390-0-3" id="h390-0-3" class="d">-    android:layout_width=&quot;match_parent&quot;
</a><a href="#h390-0-4" id="h390-0-4" class="d">-    android:layout_height=&quot;match_parent&quot;
</a><a href="#h390-0-5" id="h390-0-5" class="d">-    android:padding=&quot;20dp&quot;
</a><a href="#h390-0-6" id="h390-0-6" class="d">-    android:orientation=&quot;vertical&quot;
</a><a href="#h390-0-7" id="h390-0-7" class="d">-    tools:ignore=&quot;HardcodedText&quot;&gt;
</a><a href="#h390-0-8" id="h390-0-8" class="d">-
</a><a href="#h390-0-9" id="h390-0-9" class="d">-    &lt;EditText
</a><a href="#h390-0-10" id="h390-0-10" class="d">-        android:id=&quot;@+id/dialog_latitude&quot;
</a><a href="#h390-0-11" id="h390-0-11" class="d">-        android:layout_width=&quot;match_parent&quot;
</a><a href="#h390-0-12" id="h390-0-12" class="d">-        android:layout_height=&quot;wrap_content&quot;
</a><a href="#h390-0-13" id="h390-0-13" class="d">-        android:autofillHints=&quot;&quot;
</a><a href="#h390-0-14" id="h390-0-14" class="d">-        android:ems=&quot;10&quot;
</a><a href="#h390-0-15" id="h390-0-15" class="d">-        android:hint=&quot;Latitude&quot;
</a><a href="#h390-0-16" id="h390-0-16" class="d">-        android:inputType=&quot;number|numberDecimal|numberSigned&quot; /&gt;
</a><a href="#h390-0-17" id="h390-0-17" class="d">-
</a><a href="#h390-0-18" id="h390-0-18" class="d">-    &lt;EditText
</a><a href="#h390-0-19" id="h390-0-19" class="d">-        android:id=&quot;@+id/dialog_longitude&quot;
</a><a href="#h390-0-20" id="h390-0-20" class="d">-        android:layout_width=&quot;match_parent&quot;
</a><a href="#h390-0-21" id="h390-0-21" class="d">-        android:layout_height=&quot;wrap_content&quot;
</a><a href="#h390-0-22" id="h390-0-22" class="d">-        android:autofillHints=&quot;&quot;
</a><a href="#h390-0-23" id="h390-0-23" class="d">-        android:ems=&quot;10&quot;
</a><a href="#h390-0-24" id="h390-0-24" class="d">-        android:hint=&quot;Longitude&quot;
</a><a href="#h390-0-25" id="h390-0-25" class="d">-        android:inputType=&quot;number|numberDecimal|numberSigned&quot; /&gt;
</a><a href="#h390-0-26" id="h390-0-26" class="d">-
</a><a href="#h390-0-27" id="h390-0-27" class="d">-&lt;/LinearLayout&gt;</a><a href="#h390-0-28" id="h390-0-28" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h391" href="../file/core/src/main/res/values/arrays.xml.html">core/src/main/res/values/arrays.xml</a> b/<a href="../file/core/src/main/res/values/arrays.xml.html">core/src/main/res/values/arrays.xml</a></b>
<a href="#h391-0" id="h391-0" class="h">@@ -1,6 +0,0 @@
</a><a href="#h391-0-0" id="h391-0-0" class="d">-&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
</a><a href="#h391-0-1" id="h391-0-1" class="d">-&lt;resources&gt;
</a><a href="#h391-0-2" id="h391-0-2" class="d">-    &lt;string-array name=&quot;xposed_scope&quot;&gt;
</a><a href="#h391-0-3" id="h391-0-3" class="d">-        &lt;item&gt;com.snapchat.android&lt;/item&gt;
</a><a href="#h391-0-4" id="h391-0-4" class="d">-    &lt;/string-array&gt;
</a><a href="#h391-0-5" id="h391-0-5" class="d">-&lt;/resources&gt;</a><a href="#h391-0-6" id="h391-0-6" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h392" href="../file/core/src/main/res/values/colors.xml.html">core/src/main/res/values/colors.xml</a> b/<a href="../file/core/src/main/res/values/colors.xml.html">core/src/main/res/values/colors.xml</a></b>
<a href="#h392-0" id="h392-0" class="h">@@ -1,6 +0,0 @@
</a><a href="#h392-0-0" id="h392-0-0" class="d">-&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
</a><a href="#h392-0-1" id="h392-0-1" class="d">-&lt;resources&gt;
</a><a href="#h392-0-2" id="h392-0-2" class="d">-    &lt;color name=&quot;primaryText&quot;&gt;#DEDEDE&lt;/color&gt;
</a><a href="#h392-0-3" id="h392-0-3" class="d">-    &lt;color name=&quot;primaryBackground&quot;&gt;#121212&lt;/color&gt;
</a><a href="#h392-0-4" id="h392-0-4" class="d">-    &lt;color name=&quot;borderColor&quot;&gt;#424242&lt;/color&gt;
</a><a href="#h392-0-5" id="h392-0-5" class="d">-&lt;/resources&gt;</a><a href="#h392-0-6" id="h392-0-6" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h393" href="../file/core/src/main/res/values/launcher_icon_background.xml.html">core/src/main/res/values/launcher_icon_background.xml</a> b/<a href="../file/core/src/main/res/values/launcher_icon_background.xml.html">core/src/main/res/values/launcher_icon_background.xml</a></b>
<a href="#h393-0" id="h393-0" class="h">@@ -1,4 +0,0 @@
</a><a href="#h393-0-0" id="h393-0-0" class="d">-&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
</a><a href="#h393-0-1" id="h393-0-1" class="d">-&lt;resources&gt;
</a><a href="#h393-0-2" id="h393-0-2" class="d">-    &lt;color name=&quot;launcher_icon_background&quot;&gt;#FDFA00&lt;/color&gt;
</a><a href="#h393-0-3" id="h393-0-3" class="d">-&lt;/resources&gt;</a><a href="#h393-0-4" id="h393-0-4" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h394" href="../file/core/src/main/res/values/strings.xml.html">core/src/main/res/values/strings.xml</a> b/<a href="../file/core/src/main/res/values/strings.xml.html">core/src/main/res/values/strings.xml</a></b>
<a href="#h394-0" id="h394-0" class="h">@@ -1,3 +0,0 @@
</a><a href="#h394-0-0" id="h394-0-0" class="d">-&lt;resources&gt;
</a><a href="#h394-0-1" id="h394-0-1" class="d">-    &lt;string name=&quot;app_name&quot; translatable=&quot;false&quot;&gt;SnapEnhance&lt;/string&gt;
</a><a href="#h394-0-2" id="h394-0-2" class="d">-&lt;/resources&gt;</a><a href="#h394-0-3" id="h394-0-3" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h395" href="../file/core/src/main/res/values/themes.xml.html">core/src/main/res/values/themes.xml</a> b/<a href="../file/core/src/main/res/values/themes.xml.html">core/src/main/res/values/themes.xml</a></b>
<a href="#h395-0" id="h395-0" class="h">@@ -1,12 +0,0 @@
</a><a href="#h395-0-0" id="h395-0-0" class="d">-&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;
</a><a href="#h395-0-1" id="h395-0-1" class="d">-&lt;resources&gt;
</a><a href="#h395-0-2" id="h395-0-2" class="d">-    &lt;style name=&quot;AppTheme&quot;&gt;
</a><a href="#h395-0-3" id="h395-0-3" class="d">-        &lt;item name=&quot;android:fontFamily&quot;&gt;@font/avenir_next_medium&lt;/item&gt;
</a><a href="#h395-0-4" id="h395-0-4" class="d">-        &lt;item name=&quot;android:windowNoTitle&quot;&gt;true&lt;/item&gt;
</a><a href="#h395-0-5" id="h395-0-5" class="d">-        &lt;item name=&quot;android:windowContentOverlay&quot;&gt;@null&lt;/item&gt;
</a><a href="#h395-0-6" id="h395-0-6" class="d">-        &lt;item name=&quot;android:navigationBarColor&quot;&gt;@color/primaryBackground&lt;/item&gt;
</a><a href="#h395-0-7" id="h395-0-7" class="d">-        &lt;item name=&quot;android:textColor&quot;&gt;@color/primaryText&lt;/item&gt;
</a><a href="#h395-0-8" id="h395-0-8" class="d">-        &lt;item name=&quot;android:editTextColor&quot;&gt;@color/primaryText&lt;/item&gt;
</a><a href="#h395-0-9" id="h395-0-9" class="d">-        &lt;item name=&quot;android:alertDialogTheme&quot;&gt;@android:style/Theme.DeviceDefault.Dialog.Alert&lt;/item&gt;
</a><a href="#h395-0-10" id="h395-0-10" class="d">-    &lt;/style&gt;
</a><a href="#h395-0-11" id="h395-0-11" class="d">-&lt;/resources&gt;</a><a href="#h395-0-12" id="h395-0-12" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h396" href="../file/settings.gradle.kts.html">settings.gradle.kts</a> b/<a href="../file/settings.gradle.kts.html">settings.gradle.kts</a></b>
<a href="#h396-0" id="h396-0" class="h">@@ -17,6 +17,7 @@ dependencyResolutionManagement {
</a> 
 
 rootProject.name = &quot;SnapEnhance&quot;
<a href="#h396-0-3" id="h396-0-3" class="i">+include(&quot;:common&quot;)
</a> include(&quot;:core&quot;)
 include(&quot;:app&quot;)
 include(&quot;:mapper&quot;)
</pre>
</div>
</body>
</html>
