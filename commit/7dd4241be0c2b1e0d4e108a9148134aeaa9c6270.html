<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>perf(core): chat exporter - feat compose ui - SnapEnhance - An Xposed module offering an enhanced Snapchat experience
</title>
<link rel="icon" type="image/svg+xml" href="../../logo.png"/>
<link rel="alternate icon" href="../../favicon.png"/>
<link rel="alternate" type="application/atom+xml" title="SnapEnhance Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="SnapEnhance Atom Feed (tags)" href="../tags.xml" />
<link rel="stylesheet" type="text/css" href="../../style.css" />
<link rel="stylesheet" type="text/css" href="../../fonts.css" />
</head>
<body>
<div id="head"><table><tr><td><a class="logo" href="../../"><img src="../../logo.png" alt="" width="32" height="32" /></a></td><td><strong>SnapEnhance</strong><span class="desc"> - An Xposed module offering an enhanced Snapchat experience
</span>
</td></tr></table>
<p><a href="../about.html">About</a> | <a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/LICENSE.html">License</a></p>
</div>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/7dd4241be0c2b1e0d4e108a9148134aeaa9c6270.html">7dd4241be0c2b1e0d4e108a9148134aeaa9c6270</a>
<b>parent</b> <a href="../commit/c420d22c04567bdbd70ff5e9b259326c70367d85.html">c420d22c04567bdbd70ff5e9b259326c70367d85</a>
<b>Author:</b> rhunk &lt;<a href="mailto:101876869+rhunk@users.noreply.github.com">101876869+rhunk@users.noreply.github.com</a>&gt;
<b>Date:</b>   Sat, 16 Dec 2023 16:52:00 +0100

perf(core): chat exporter
- feat compose ui

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">common/src/main/assets/lang/en_US.json</a></td><td> | </td><td class="num">14</td><td><span class="i">+++++++++</span><span class="d">-----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">core/src/main/kotlin/me/rhunk/snapenhance/core/action/impl/ExportChatMessages.kt</a></td><td> | </td><td class="num">434</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">--------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h2">core/src/main/kotlin/me/rhunk/snapenhance/core/messaging/ConversationExporter.kt</a></td><td> | </td><td class="num">37</td><td><span class="i">++++++++++++++++++</span><span class="d">-------------------</span></td></tr>
<tr><td class="A">A</td><td><a href="#h3">core/src/main/kotlin/me/rhunk/snapenhance/core/messaging/ExportParams.kt</a></td><td> | </td><td class="num">10</td><td><span class="i">++++++++++</span><span class="d"></span></td></tr>
</table></pre><pre>4 files changed, 330 insertions(+), 165 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/common/src/main/assets/lang/en_US.json.html">common/src/main/assets/lang/en_US.json</a> b/<a href="../file/common/src/main/assets/lang/en_US.json.html">common/src/main/assets/lang/en_US.json</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -910,12 +910,16 @@
</a>     },
 
     &quot;chat_export&quot;: {
<a href="#h0-0-3" id="h0-0-3" class="d">-        &quot;select_export_format&quot;: &quot;Select the Export Format&quot;,
</a><a href="#h0-0-4" id="h0-0-4" class="d">-        &quot;select_media_type&quot;: &quot;Select Media Types to export&quot;,
</a><a href="#h0-0-5" id="h0-0-5" class="d">-        &quot;select_amount_of_messages&quot;: &quot;Select the amount of messages to export (leave empty for all)&quot;,
</a><a href="#h0-0-6" id="h0-0-6" class="d">-        &quot;select_conversation&quot;: &quot;Select a Conversation to export&quot;,
</a><a href="#h0-0-7" id="h0-0-7" class="i">+        &quot;exporter_dialog&quot;: {
</a><a href="#h0-0-8" id="h0-0-8" class="i">+            &quot;select_conversations_title&quot;: &quot;Select Conversations&quot;,
</a><a href="#h0-0-9" id="h0-0-9" class="i">+            &quot;text_field_selection&quot;: &quot;{amount} selected&quot;,
</a><a href="#h0-0-10" id="h0-0-10" class="i">+            &quot;text_field_selection_all&quot;: &quot;All&quot;,
</a><a href="#h0-0-11" id="h0-0-11" class="i">+            &quot;export_file_format_title&quot;: &quot;Export File Format&quot;,
</a><a href="#h0-0-12" id="h0-0-12" class="i">+            &quot;message_type_filter_title&quot;: &quot;Filter Messages by Type&quot;,
</a><a href="#h0-0-13" id="h0-0-13" class="i">+            &quot;amount_of_messages_title&quot;: &quot;Amount of Messages (leave it blank for all)&quot;,
</a><a href="#h0-0-14" id="h0-0-14" class="i">+            &quot;download_medias_title&quot;: &quot;Download Medias&quot;
</a><a href="#h0-0-15" id="h0-0-15" class="i">+        },
</a>         &quot;dialog_negative_button&quot;: &quot;Cancel&quot;,
<a href="#h0-0-17" id="h0-0-17" class="d">-        &quot;dialog_neutral_button&quot;: &quot;Export All&quot;,
</a>         &quot;dialog_positive_button&quot;: &quot;Export&quot;,
         &quot;exported_to&quot;: &quot;Exported to {path}&quot;,
         &quot;exporting_chats&quot;: &quot;Exporting Chats...&quot;,
<b>diff --git a/<a id="h1" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/action/impl/ExportChatMessages.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/action/impl/ExportChatMessages.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/action/impl/ExportChatMessages.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/action/impl/ExportChatMessages.kt</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -3,29 +3,46 @@ package me.rhunk.snapenhance.core.action.impl
</a> import android.app.AlertDialog
 import android.content.DialogInterface
 import android.os.Environment
<a href="#h1-0-3" id="h1-0-3" class="d">-import android.text.InputType
</a><a href="#h1-0-4" id="h1-0-4" class="d">-import android.widget.EditText
</a><a href="#h1-0-5" id="h1-0-5" class="i">+import android.view.WindowManager
</a><a href="#h1-0-6" id="h1-0-6" class="i">+import androidx.compose.foundation.ScrollState
</a><a href="#h1-0-7" id="h1-0-7" class="i">+import androidx.compose.foundation.layout.*
</a><a href="#h1-0-8" id="h1-0-8" class="i">+import androidx.compose.foundation.lazy.LazyColumn
</a><a href="#h1-0-9" id="h1-0-9" class="i">+import androidx.compose.foundation.lazy.items
</a><a href="#h1-0-10" id="h1-0-10" class="i">+import androidx.compose.foundation.text.KeyboardActions
</a><a href="#h1-0-11" id="h1-0-11" class="i">+import androidx.compose.foundation.text.KeyboardOptions
</a><a href="#h1-0-12" id="h1-0-12" class="i">+import androidx.compose.foundation.verticalScroll
</a><a href="#h1-0-13" id="h1-0-13" class="i">+import androidx.compose.material3.*
</a><a href="#h1-0-14" id="h1-0-14" class="i">+import androidx.compose.runtime.*
</a><a href="#h1-0-15" id="h1-0-15" class="i">+import androidx.compose.ui.Alignment
</a><a href="#h1-0-16" id="h1-0-16" class="i">+import androidx.compose.ui.ExperimentalComposeUiApi
</a><a href="#h1-0-17" id="h1-0-17" class="i">+import androidx.compose.ui.Modifier
</a><a href="#h1-0-18" id="h1-0-18" class="i">+import androidx.compose.ui.platform.LocalConfiguration
</a><a href="#h1-0-19" id="h1-0-19" class="i">+import androidx.compose.ui.platform.LocalFocusManager
</a><a href="#h1-0-20" id="h1-0-20" class="i">+import androidx.compose.ui.platform.LocalSoftwareKeyboardController
</a><a href="#h1-0-21" id="h1-0-21" class="i">+import androidx.compose.ui.text.input.ImeAction
</a><a href="#h1-0-22" id="h1-0-22" class="i">+import androidx.compose.ui.text.input.KeyboardType
</a><a href="#h1-0-23" id="h1-0-23" class="i">+import androidx.compose.ui.text.style.TextOverflow
</a><a href="#h1-0-24" id="h1-0-24" class="i">+import androidx.compose.ui.unit.dp
</a> import kotlinx.coroutines.*
 import me.rhunk.snapenhance.common.data.ContentType
 import me.rhunk.snapenhance.common.database.impl.FriendFeedEntry
<a href="#h1-0-28" id="h1-0-28" class="i">+import me.rhunk.snapenhance.common.ui.createComposeView
</a> import me.rhunk.snapenhance.core.action.AbstractAction
 import me.rhunk.snapenhance.core.features.impl.messaging.Messaging
 import me.rhunk.snapenhance.core.logger.CoreLogger
 import me.rhunk.snapenhance.core.messaging.ConversationExporter
 import me.rhunk.snapenhance.core.messaging.ExportFormat
<a href="#h1-0-34" id="h1-0-34" class="i">+import me.rhunk.snapenhance.core.messaging.ExportParams
</a> import me.rhunk.snapenhance.core.ui.ViewAppearanceHelper
 import me.rhunk.snapenhance.core.wrapper.impl.Message
 import java.io.File
 import kotlin.math.absoluteValue
 
 class ExportChatMessages : AbstractAction() {
<a href="#h1-0-41" id="h1-0-41" class="i">+    private val translation by lazy { context.translation.getCategory(&quot;chat_export&quot;) }
</a>     private val dialogLogs = mutableListOf&lt;String&gt;()
     private var currentActionDialog: AlertDialog? = null
 
<a href="#h1-0-45" id="h1-0-45" class="d">-    private var exportType: ExportFormat? = null
</a><a href="#h1-0-46" id="h1-0-46" class="d">-    private var mediaToDownload: List&lt;ContentType&gt;? = null
</a><a href="#h1-0-47" id="h1-0-47" class="d">-    private var amountOfMessages: Int? = null
</a><a href="#h1-0-48" id="h1-0-48" class="d">-
</a>     private fun logDialog(message: String) {
         context.runOnUiThread {
             if (dialogLogs.size &gt; 10) dialogLogs.removeAt(0)
<a href="#h1-1" id="h1-1" class="h">@@ -41,101 +58,221 @@ class ExportChatMessages : AbstractAction() {
</a>         }
     }
 
<a href="#h1-1-3" id="h1-1-3" class="d">-    private suspend fun askExportType() = suspendCancellableCoroutine { cont -&gt;
</a><a href="#h1-1-4" id="h1-1-4" class="d">-        context.runOnUiThread {
</a><a href="#h1-1-5" id="h1-1-5" class="d">-            ViewAppearanceHelper.newAlertDialogBuilder(context.mainActivity)
</a><a href="#h1-1-6" id="h1-1-6" class="d">-                .setTitle(context.translation[&quot;chat_export.select_export_format&quot;])
</a><a href="#h1-1-7" id="h1-1-7" class="d">-                .setItems(ExportFormat.entries.map { it.name }.toTypedArray()) { _, which -&gt;
</a><a href="#h1-1-8" id="h1-1-8" class="d">-                    cont.resumeWith(Result.success(ExportFormat.entries[which]))
</a><a href="#h1-1-9" id="h1-1-9" class="d">-                }
</a><a href="#h1-1-10" id="h1-1-10" class="d">-                .setOnCancelListener {
</a><a href="#h1-1-11" id="h1-1-11" class="d">-                    cont.resumeWith(Result.success(null))
</a><a href="#h1-1-12" id="h1-1-12" class="d">-                }
</a><a href="#h1-1-13" id="h1-1-13" class="d">-                .show()
</a><a href="#h1-1-14" id="h1-1-14" class="i">+    @OptIn(ExperimentalMaterial3Api::class, ExperimentalComposeUiApi::class)
</a><a href="#h1-1-15" id="h1-1-15" class="i">+    @Composable
</a><a href="#h1-1-16" id="h1-1-16" class="i">+    private fun ExporterDialog(
</a><a href="#h1-1-17" id="h1-1-17" class="i">+        getDialog: () -&gt; AlertDialog? = { null }
</a><a href="#h1-1-18" id="h1-1-18" class="i">+    ) {
</a><a href="#h1-1-19" id="h1-1-19" class="i">+        val exporterTranslation = remember {
</a><a href="#h1-1-20" id="h1-1-20" class="i">+            translation.getCategory(&quot;exporter_dialog&quot;)
</a>         }
<a href="#h1-1-22" id="h1-1-22" class="d">-    }
</a> 
<a href="#h1-1-24" id="h1-1-24" class="d">-    private suspend fun askAmountOfMessages() = suspendCancellableCoroutine { cont -&gt;
</a><a href="#h1-1-25" id="h1-1-25" class="d">-        context.coroutineScope.launch(Dispatchers.Main) {
</a><a href="#h1-1-26" id="h1-1-26" class="d">-            val input = EditText(context.mainActivity)
</a><a href="#h1-1-27" id="h1-1-27" class="d">-            input.inputType = InputType.TYPE_CLASS_NUMBER
</a><a href="#h1-1-28" id="h1-1-28" class="d">-            input.setSingleLine()
</a><a href="#h1-1-29" id="h1-1-29" class="d">-            input.maxLines = 1
</a><a href="#h1-1-30" id="h1-1-30" class="i">+        var feedEntries by remember { mutableStateOf(emptyList&lt;FriendFeedEntry&gt;()) }
</a><a href="#h1-1-31" id="h1-1-31" class="i">+        var exportType by remember { mutableStateOf(ExportFormat.HTML) }
</a><a href="#h1-1-32" id="h1-1-32" class="i">+        val selectedFeedEntries = remember { mutableStateListOf&lt;FriendFeedEntry&gt;() }
</a><a href="#h1-1-33" id="h1-1-33" class="i">+        val messageTypeFilter = remember { mutableStateListOf&lt;ContentType&gt;() }
</a><a href="#h1-1-34" id="h1-1-34" class="i">+        var amountOfMessages by remember { mutableIntStateOf(-1) }
</a><a href="#h1-1-35" id="h1-1-35" class="i">+        var downloadMedias by remember { mutableStateOf(false) }
</a> 
<a href="#h1-1-37" id="h1-1-37" class="d">-            ViewAppearanceHelper.newAlertDialogBuilder(context.mainActivity)
</a><a href="#h1-1-38" id="h1-1-38" class="d">-                .setTitle(context.translation[&quot;chat_export.select_amount_of_messages&quot;])
</a><a href="#h1-1-39" id="h1-1-39" class="d">-                .setView(input)
</a><a href="#h1-1-40" id="h1-1-40" class="d">-                .setPositiveButton(context.translation[&quot;button.ok&quot;]) { _, _ -&gt;
</a><a href="#h1-1-41" id="h1-1-41" class="d">-                    cont.resumeWith(Result.success(input.text.takeIf { it.isNotEmpty() }?.toString()?.toIntOrNull()?.absoluteValue))
</a><a href="#h1-1-42" id="h1-1-42" class="i">+        Column(
</a><a href="#h1-1-43" id="h1-1-43" class="i">+            modifier = Modifier
</a><a href="#h1-1-44" id="h1-1-44" class="i">+                .fillMaxWidth()
</a><a href="#h1-1-45" id="h1-1-45" class="i">+                .verticalScroll(remember { ScrollState(0) })
</a><a href="#h1-1-46" id="h1-1-46" class="i">+                .padding(16.dp),
</a><a href="#h1-1-47" id="h1-1-47" class="i">+            verticalArrangement = Arrangement.spacedBy(10.dp)
</a><a href="#h1-1-48" id="h1-1-48" class="i">+        ) {
</a><a href="#h1-1-49" id="h1-1-49" class="i">+            Text(exporterTranslation[&quot;select_conversations_title&quot;])
</a><a href="#h1-1-50" id="h1-1-50" class="i">+            run {
</a><a href="#h1-1-51" id="h1-1-51" class="i">+                var expanded by remember { mutableStateOf(false) }
</a><a href="#h1-1-52" id="h1-1-52" class="i">+
</a><a href="#h1-1-53" id="h1-1-53" class="i">+                ExposedDropdownMenuBox(
</a><a href="#h1-1-54" id="h1-1-54" class="i">+                    expanded = expanded,
</a><a href="#h1-1-55" id="h1-1-55" class="i">+                    onExpandedChange = { expanded = it },
</a><a href="#h1-1-56" id="h1-1-56" class="i">+                ) {
</a><a href="#h1-1-57" id="h1-1-57" class="i">+                    TextField(
</a><a href="#h1-1-58" id="h1-1-58" class="i">+                        value = selectedFeedEntries.let {
</a><a href="#h1-1-59" id="h1-1-59" class="i">+                            exporterTranslation.format(&quot;text_field_selection&quot;, &quot;amount&quot; to it.size.toString())
</a><a href="#h1-1-60" id="h1-1-60" class="i">+                        },
</a><a href="#h1-1-61" id="h1-1-61" class="i">+                        onValueChange = {},
</a><a href="#h1-1-62" id="h1-1-62" class="i">+                        readOnly = true,
</a><a href="#h1-1-63" id="h1-1-63" class="i">+                        singleLine = true,
</a><a href="#h1-1-64" id="h1-1-64" class="i">+                        modifier = Modifier.menuAnchor()
</a><a href="#h1-1-65" id="h1-1-65" class="i">+                    )
</a><a href="#h1-1-66" id="h1-1-66" class="i">+
</a><a href="#h1-1-67" id="h1-1-67" class="i">+                    ExposedDropdownMenu(expanded = expanded, onDismissRequest = { expanded = false }) {
</a><a href="#h1-1-68" id="h1-1-68" class="i">+                        LazyColumn(
</a><a href="#h1-1-69" id="h1-1-69" class="i">+                            modifier = Modifier.size(LocalConfiguration.current.screenWidthDp.dp, 300.dp)
</a><a href="#h1-1-70" id="h1-1-70" class="i">+                        ) {
</a><a href="#h1-1-71" id="h1-1-71" class="i">+                            items(feedEntries) { feedEntry -&gt;
</a><a href="#h1-1-72" id="h1-1-72" class="i">+                                DropdownMenuItem(
</a><a href="#h1-1-73" id="h1-1-73" class="i">+                                    modifier = Modifier.fillMaxWidth(),
</a><a href="#h1-1-74" id="h1-1-74" class="i">+                                    onClick = {
</a><a href="#h1-1-75" id="h1-1-75" class="i">+                                        if (selectedFeedEntries.contains(feedEntry)) selectedFeedEntries -= feedEntry
</a><a href="#h1-1-76" id="h1-1-76" class="i">+                                        else selectedFeedEntries += feedEntry
</a><a href="#h1-1-77" id="h1-1-77" class="i">+                                    },
</a><a href="#h1-1-78" id="h1-1-78" class="i">+                                    text = {
</a><a href="#h1-1-79" id="h1-1-79" class="i">+                                        Row(
</a><a href="#h1-1-80" id="h1-1-80" class="i">+                                            verticalAlignment = Alignment.CenterVertically
</a><a href="#h1-1-81" id="h1-1-81" class="i">+                                        ) {
</a><a href="#h1-1-82" id="h1-1-82" class="i">+                                            Checkbox(checked = selectedFeedEntries.contains(feedEntry), onCheckedChange = null)
</a><a href="#h1-1-83" id="h1-1-83" class="i">+                                            Text(
</a><a href="#h1-1-84" id="h1-1-84" class="i">+                                                text = feedEntry.feedDisplayName ?: feedEntry.friendDisplayName ?: &quot;unknown&quot;,
</a><a href="#h1-1-85" id="h1-1-85" class="i">+                                                overflow = TextOverflow.Ellipsis,
</a><a href="#h1-1-86" id="h1-1-86" class="i">+                                                maxLines = 1
</a><a href="#h1-1-87" id="h1-1-87" class="i">+                                            )
</a><a href="#h1-1-88" id="h1-1-88" class="i">+                                        }
</a><a href="#h1-1-89" id="h1-1-89" class="i">+                                    }
</a><a href="#h1-1-90" id="h1-1-90" class="i">+                                )
</a><a href="#h1-1-91" id="h1-1-91" class="i">+                            }
</a><a href="#h1-1-92" id="h1-1-92" class="i">+                        }
</a><a href="#h1-1-93" id="h1-1-93" class="i">+                    }
</a><a href="#h1-1-94" id="h1-1-94" class="i">+                }
</a><a href="#h1-1-95" id="h1-1-95" class="i">+            }
</a><a href="#h1-1-96" id="h1-1-96" class="i">+
</a><a href="#h1-1-97" id="h1-1-97" class="i">+            Text(exporterTranslation[&quot;export_file_format_title&quot;])
</a><a href="#h1-1-98" id="h1-1-98" class="i">+            run {
</a><a href="#h1-1-99" id="h1-1-99" class="i">+                var expanded by remember { mutableStateOf(false) }
</a><a href="#h1-1-100" id="h1-1-100" class="i">+
</a><a href="#h1-1-101" id="h1-1-101" class="i">+                ExposedDropdownMenuBox(
</a><a href="#h1-1-102" id="h1-1-102" class="i">+                    expanded = expanded,
</a><a href="#h1-1-103" id="h1-1-103" class="i">+                    onExpandedChange = { expanded = it },
</a><a href="#h1-1-104" id="h1-1-104" class="i">+                ) {
</a><a href="#h1-1-105" id="h1-1-105" class="i">+                    TextField(
</a><a href="#h1-1-106" id="h1-1-106" class="i">+                        value = exportType.extension,
</a><a href="#h1-1-107" id="h1-1-107" class="i">+                        onValueChange = {},
</a><a href="#h1-1-108" id="h1-1-108" class="i">+                        readOnly = true,
</a><a href="#h1-1-109" id="h1-1-109" class="i">+                        modifier = Modifier.menuAnchor()
</a><a href="#h1-1-110" id="h1-1-110" class="i">+                    )
</a><a href="#h1-1-111" id="h1-1-111" class="i">+
</a><a href="#h1-1-112" id="h1-1-112" class="i">+                    ExposedDropdownMenu(expanded = expanded, onDismissRequest = { expanded = false }) {
</a><a href="#h1-1-113" id="h1-1-113" class="i">+                        ExportFormat.entries.forEach { exportFormat -&gt;
</a><a href="#h1-1-114" id="h1-1-114" class="i">+                            DropdownMenuItem(onClick = {
</a><a href="#h1-1-115" id="h1-1-115" class="i">+                                exportType = exportFormat
</a><a href="#h1-1-116" id="h1-1-116" class="i">+                                expanded = false
</a><a href="#h1-1-117" id="h1-1-117" class="i">+                            }, text = {
</a><a href="#h1-1-118" id="h1-1-118" class="i">+                                Text(text = exportFormat.name)
</a><a href="#h1-1-119" id="h1-1-119" class="i">+                            })
</a><a href="#h1-1-120" id="h1-1-120" class="i">+                        }
</a><a href="#h1-1-121" id="h1-1-121" class="i">+                    }
</a>                 }
<a href="#h1-1-123" id="h1-1-123" class="d">-                .setOnCancelListener {
</a><a href="#h1-1-124" id="h1-1-124" class="d">-                    cont.resumeWith(Result.success(null))
</a><a href="#h1-1-125" id="h1-1-125" class="i">+            }
</a><a href="#h1-1-126" id="h1-1-126" class="i">+            Text(exporterTranslation[&quot;message_type_filter_title&quot;])
</a><a href="#h1-1-127" id="h1-1-127" class="i">+            run {
</a><a href="#h1-1-128" id="h1-1-128" class="i">+                var expanded by remember { mutableStateOf(false) }
</a><a href="#h1-1-129" id="h1-1-129" class="i">+
</a><a href="#h1-1-130" id="h1-1-130" class="i">+                ExposedDropdownMenuBox(
</a><a href="#h1-1-131" id="h1-1-131" class="i">+                    expanded = expanded,
</a><a href="#h1-1-132" id="h1-1-132" class="i">+                    onExpandedChange = { expanded = it },
</a><a href="#h1-1-133" id="h1-1-133" class="i">+                ) {
</a><a href="#h1-1-134" id="h1-1-134" class="i">+                    TextField(
</a><a href="#h1-1-135" id="h1-1-135" class="i">+                        value = messageTypeFilter.takeIf { it.isNotEmpty() }?.let {
</a><a href="#h1-1-136" id="h1-1-136" class="i">+                            exporterTranslation.format(&quot;text_field_selection&quot;, &quot;amount&quot; to it.size.toString())
</a><a href="#h1-1-137" id="h1-1-137" class="i">+                        } ?: exporterTranslation[&quot;text_field_selection_all&quot;],
</a><a href="#h1-1-138" id="h1-1-138" class="i">+                        onValueChange = {},
</a><a href="#h1-1-139" id="h1-1-139" class="i">+                        readOnly = true,
</a><a href="#h1-1-140" id="h1-1-140" class="i">+                        modifier = Modifier.menuAnchor()
</a><a href="#h1-1-141" id="h1-1-141" class="i">+                    )
</a><a href="#h1-1-142" id="h1-1-142" class="i">+
</a><a href="#h1-1-143" id="h1-1-143" class="i">+                    ExposedDropdownMenu(expanded = expanded, onDismissRequest = { expanded = false }) {
</a><a href="#h1-1-144" id="h1-1-144" class="i">+                        arrayOf(
</a><a href="#h1-1-145" id="h1-1-145" class="i">+                            ContentType.CHAT,
</a><a href="#h1-1-146" id="h1-1-146" class="i">+                            ContentType.SNAP,
</a><a href="#h1-1-147" id="h1-1-147" class="i">+                            ContentType.EXTERNAL_MEDIA,
</a><a href="#h1-1-148" id="h1-1-148" class="i">+                            ContentType.NOTE,
</a><a href="#h1-1-149" id="h1-1-149" class="i">+                            ContentType.STICKER
</a><a href="#h1-1-150" id="h1-1-150" class="i">+                        ).forEach { contentType -&gt;
</a><a href="#h1-1-151" id="h1-1-151" class="i">+                            DropdownMenuItem(onClick = {
</a><a href="#h1-1-152" id="h1-1-152" class="i">+                                if (messageTypeFilter.contains(contentType)) messageTypeFilter -= contentType
</a><a href="#h1-1-153" id="h1-1-153" class="i">+                                else messageTypeFilter += contentType
</a><a href="#h1-1-154" id="h1-1-154" class="i">+                            }, text = {
</a><a href="#h1-1-155" id="h1-1-155" class="i">+                                Row(
</a><a href="#h1-1-156" id="h1-1-156" class="i">+                                    verticalAlignment = Alignment.CenterVertically
</a><a href="#h1-1-157" id="h1-1-157" class="i">+                                ) {
</a><a href="#h1-1-158" id="h1-1-158" class="i">+                                    Checkbox(checked = messageTypeFilter.contains(contentType), onCheckedChange = null)
</a><a href="#h1-1-159" id="h1-1-159" class="i">+                                    Text(text = contentType.name)
</a><a href="#h1-1-160" id="h1-1-160" class="i">+                                }
</a><a href="#h1-1-161" id="h1-1-161" class="i">+                            })
</a><a href="#h1-1-162" id="h1-1-162" class="i">+                        }
</a><a href="#h1-1-163" id="h1-1-163" class="i">+                    }
</a>                 }
<a href="#h1-1-165" id="h1-1-165" class="d">-                .show()
</a><a href="#h1-1-166" id="h1-1-166" class="d">-        }
</a><a href="#h1-1-167" id="h1-1-167" class="d">-    }
</a><a href="#h1-1-168" id="h1-1-168" class="i">+            }
</a> 
<a href="#h1-1-170" id="h1-1-170" class="d">-    private suspend fun askMediaToDownload() = suspendCancellableCoroutine { cont -&gt;
</a><a href="#h1-1-171" id="h1-1-171" class="d">-        context.runOnUiThread {
</a><a href="#h1-1-172" id="h1-1-172" class="d">-            val mediasToDownload = mutableListOf&lt;ContentType&gt;()
</a><a href="#h1-1-173" id="h1-1-173" class="d">-            val contentTypes = arrayOf(
</a><a href="#h1-1-174" id="h1-1-174" class="d">-                ContentType.CHAT,
</a><a href="#h1-1-175" id="h1-1-175" class="d">-                ContentType.SNAP,
</a><a href="#h1-1-176" id="h1-1-176" class="d">-                ContentType.EXTERNAL_MEDIA,
</a><a href="#h1-1-177" id="h1-1-177" class="d">-                ContentType.NOTE,
</a><a href="#h1-1-178" id="h1-1-178" class="d">-                ContentType.STICKER
</a><a href="#h1-1-179" id="h1-1-179" class="i">+            Text(exporterTranslation[&quot;amount_of_messages_title&quot;])
</a><a href="#h1-1-180" id="h1-1-180" class="i">+            val focusManager = LocalFocusManager.current
</a><a href="#h1-1-181" id="h1-1-181" class="i">+            val keyboard = LocalSoftwareKeyboardController.current
</a><a href="#h1-1-182" id="h1-1-182" class="i">+            TextField(
</a><a href="#h1-1-183" id="h1-1-183" class="i">+                value = amountOfMessages.takeIf { it != -1 }?.toString() ?: &quot;&quot;,
</a><a href="#h1-1-184" id="h1-1-184" class="i">+                onValueChange = { amountOfMessages = it.toIntOrNull()?.absoluteValue ?: -1 },
</a><a href="#h1-1-185" id="h1-1-185" class="i">+                singleLine = true,
</a><a href="#h1-1-186" id="h1-1-186" class="i">+                keyboardOptions = KeyboardOptions(imeAction = ImeAction.Done, keyboardType = KeyboardType.Number),
</a><a href="#h1-1-187" id="h1-1-187" class="i">+                keyboardActions = KeyboardActions(
</a><a href="#h1-1-188" id="h1-1-188" class="i">+                    onDone = {
</a><a href="#h1-1-189" id="h1-1-189" class="i">+                        focusManager.clearFocus()
</a><a href="#h1-1-190" id="h1-1-190" class="i">+                        keyboard?.hide()
</a><a href="#h1-1-191" id="h1-1-191" class="i">+                    })
</a>             )
<a href="#h1-1-193" id="h1-1-193" class="d">-            ViewAppearanceHelper.newAlertDialogBuilder(context.mainActivity)
</a><a href="#h1-1-194" id="h1-1-194" class="d">-                .setTitle(context.translation[&quot;chat_export.select_media_type&quot;])
</a><a href="#h1-1-195" id="h1-1-195" class="d">-                .setMultiChoiceItems(contentTypes.map { it.name }.toTypedArray(), BooleanArray(contentTypes.size) { false }) { _, which, isChecked -&gt;
</a><a href="#h1-1-196" id="h1-1-196" class="d">-                    val media = contentTypes[which]
</a><a href="#h1-1-197" id="h1-1-197" class="d">-                    if (isChecked) {
</a><a href="#h1-1-198" id="h1-1-198" class="d">-                        mediasToDownload.add(media)
</a><a href="#h1-1-199" id="h1-1-199" class="d">-                    } else if (mediasToDownload.contains(media)) {
</a><a href="#h1-1-200" id="h1-1-200" class="d">-                        mediasToDownload.remove(media)
</a><a href="#h1-1-201" id="h1-1-201" class="d">-                    }
</a><a href="#h1-1-202" id="h1-1-202" class="i">+
</a><a href="#h1-1-203" id="h1-1-203" class="i">+            Row(
</a><a href="#h1-1-204" id="h1-1-204" class="i">+                modifier = Modifier.fillMaxWidth(),
</a><a href="#h1-1-205" id="h1-1-205" class="i">+                horizontalArrangement = Arrangement.spacedBy(10.dp),
</a><a href="#h1-1-206" id="h1-1-206" class="i">+                verticalAlignment = Alignment.CenterVertically
</a><a href="#h1-1-207" id="h1-1-207" class="i">+            ) {
</a><a href="#h1-1-208" id="h1-1-208" class="i">+                Checkbox(checked = downloadMedias, onCheckedChange = { downloadMedias = it })
</a><a href="#h1-1-209" id="h1-1-209" class="i">+                Text(exporterTranslation[&quot;download_medias_title&quot;])
</a><a href="#h1-1-210" id="h1-1-210" class="i">+            }
</a><a href="#h1-1-211" id="h1-1-211" class="i">+
</a><a href="#h1-1-212" id="h1-1-212" class="i">+            Row(
</a><a href="#h1-1-213" id="h1-1-213" class="i">+                modifier = Modifier.fillMaxWidth(),
</a><a href="#h1-1-214" id="h1-1-214" class="i">+                horizontalArrangement = Arrangement.SpaceEvenly,
</a><a href="#h1-1-215" id="h1-1-215" class="i">+            ) {
</a><a href="#h1-1-216" id="h1-1-216" class="i">+                Button(
</a><a href="#h1-1-217" id="h1-1-217" class="i">+                    onClick = { getDialog()?.dismiss() }
</a><a href="#h1-1-218" id="h1-1-218" class="i">+                ) {
</a><a href="#h1-1-219" id="h1-1-219" class="i">+                    Text(text = translation[&quot;dialog_negative_button&quot;])
</a>                 }
<a href="#h1-1-221" id="h1-1-221" class="d">-                .setOnCancelListener {
</a><a href="#h1-1-222" id="h1-1-222" class="d">-                    cont.resumeWith(Result.success(null))
</a><a href="#h1-1-223" id="h1-1-223" class="i">+                Button(
</a><a href="#h1-1-224" id="h1-1-224" class="i">+                    enabled = selectedFeedEntries.isNotEmpty(),
</a><a href="#h1-1-225" id="h1-1-225" class="i">+                    onClick = {
</a><a href="#h1-1-226" id="h1-1-226" class="i">+                        exportChatForConversations(selectedFeedEntries, ExportParams(
</a><a href="#h1-1-227" id="h1-1-227" class="i">+                            exportFormat = exportType,
</a><a href="#h1-1-228" id="h1-1-228" class="i">+                            messageTypeFilter = messageTypeFilter.takeIf { it.isNotEmpty() },
</a><a href="#h1-1-229" id="h1-1-229" class="i">+                            amountOfMessages = amountOfMessages.takeIf { it != -1 },
</a><a href="#h1-1-230" id="h1-1-230" class="i">+                            downloadMedias = downloadMedias
</a><a href="#h1-1-231" id="h1-1-231" class="i">+                        ))
</a><a href="#h1-1-232" id="h1-1-232" class="i">+                    }
</a><a href="#h1-1-233" id="h1-1-233" class="i">+                ) {
</a><a href="#h1-1-234" id="h1-1-234" class="i">+                    Text(text = translation[&quot;dialog_positive_button&quot;])
</a>                 }
<a href="#h1-1-236" id="h1-1-236" class="d">-                .setPositiveButton(context.translation[&quot;button.ok&quot;]) { _, _ -&gt;
</a><a href="#h1-1-237" id="h1-1-237" class="d">-                    cont.resumeWith(Result.success(mediasToDownload))
</a><a href="#h1-1-238" id="h1-1-238" class="i">+            }
</a><a href="#h1-1-239" id="h1-1-239" class="i">+
</a><a href="#h1-1-240" id="h1-1-240" class="i">+            LaunchedEffect(Unit) {
</a><a href="#h1-1-241" id="h1-1-241" class="i">+                withContext(Dispatchers.IO) {
</a><a href="#h1-1-242" id="h1-1-242" class="i">+                    feedEntries = context.database.getFeedEntries(500)
</a>                 }
<a href="#h1-1-244" id="h1-1-244" class="d">-                .show()
</a><a href="#h1-1-245" id="h1-1-245" class="i">+            }
</a>         }
     }
 
     override fun run() {
         context.coroutineScope.launch(Dispatchers.Main) {
<a href="#h1-1-251" id="h1-1-251" class="d">-            exportType = askExportType() ?: return@launch
</a><a href="#h1-1-252" id="h1-1-252" class="d">-            mediaToDownload = if (exportType == ExportFormat.HTML) askMediaToDownload() else null
</a><a href="#h1-1-253" id="h1-1-253" class="d">-            amountOfMessages = askAmountOfMessages()
</a><a href="#h1-1-254" id="h1-1-254" class="d">-
</a><a href="#h1-1-255" id="h1-1-255" class="d">-            val friendFeedEntries = context.database.getFeedEntries(500)
</a><a href="#h1-1-256" id="h1-1-256" class="d">-            val selectedConversations = mutableListOf&lt;FriendFeedEntry&gt;()
</a><a href="#h1-1-257" id="h1-1-257" class="d">-
</a><a href="#h1-1-258" id="h1-1-258" class="i">+            lateinit var exporterDialog: AlertDialog
</a>             ViewAppearanceHelper.newAlertDialogBuilder(context.mainActivity)
<a href="#h1-1-260" id="h1-1-260" class="d">-                .setTitle(context.translation[&quot;chat_export.select_conversation&quot;])
</a><a href="#h1-1-261" id="h1-1-261" class="d">-                .setMultiChoiceItems(
</a><a href="#h1-1-262" id="h1-1-262" class="d">-                    friendFeedEntries.map { it.feedDisplayName ?: it.friendDisplayUsername!!.split(&quot;|&quot;).firstOrNull() }.toTypedArray(),
</a><a href="#h1-1-263" id="h1-1-263" class="d">-                    BooleanArray(friendFeedEntries.size) { false }
</a><a href="#h1-1-264" id="h1-1-264" class="d">-                ) { _, which, isChecked -&gt;
</a><a href="#h1-1-265" id="h1-1-265" class="d">-                    if (isChecked) {
</a><a href="#h1-1-266" id="h1-1-266" class="d">-                        selectedConversations.add(friendFeedEntries[which])
</a><a href="#h1-1-267" id="h1-1-267" class="d">-                    } else if (selectedConversations.contains(friendFeedEntries[which])) {
</a><a href="#h1-1-268" id="h1-1-268" class="d">-                        selectedConversations.remove(friendFeedEntries[which])
</a><a href="#h1-1-269" id="h1-1-269" class="i">+                .setTitle(translation[&quot;select_conversation&quot;])
</a><a href="#h1-1-270" id="h1-1-270" class="i">+                .setView(createComposeView(context.mainActivity!!) {
</a><a href="#h1-1-271" id="h1-1-271" class="i">+                    Surface(
</a><a href="#h1-1-272" id="h1-1-272" class="i">+                        modifier = Modifier.fillMaxWidth(),
</a><a href="#h1-1-273" id="h1-1-273" class="i">+                        color = MaterialTheme.colorScheme.surface
</a><a href="#h1-1-274" id="h1-1-274" class="i">+                    ) {
</a><a href="#h1-1-275" id="h1-1-275" class="i">+                        ExporterDialog { exporterDialog }
</a>                     }
<a href="#h1-1-277" id="h1-1-277" class="i">+                })
</a><a href="#h1-1-278" id="h1-1-278" class="i">+                .create().apply {
</a><a href="#h1-1-279" id="h1-1-279" class="i">+                    exporterDialog = this
</a><a href="#h1-1-280" id="h1-1-280" class="i">+                    setCanceledOnTouchOutside(false)
</a><a href="#h1-1-281" id="h1-1-281" class="i">+                    show()
</a><a href="#h1-1-282" id="h1-1-282" class="i">+                    window?.clearFlags(WindowManager.LayoutParams.FLAG_NOT_FOCUSABLE or WindowManager.LayoutParams.FLAG_ALT_FOCUSABLE_IM)
</a><a href="#h1-1-283" id="h1-1-283" class="i">+                    window?.setSoftInputMode(WindowManager.LayoutParams.SOFT_INPUT_STATE_ALWAYS_VISIBLE)
</a>                 }
<a href="#h1-1-285" id="h1-1-285" class="d">-                .setNegativeButton(context.translation[&quot;chat_export.dialog_negative_button&quot;]) { dialog, _ -&gt;
</a><a href="#h1-1-286" id="h1-1-286" class="d">-                    dialog.dismiss()
</a><a href="#h1-1-287" id="h1-1-287" class="d">-                }
</a><a href="#h1-1-288" id="h1-1-288" class="d">-                .setNeutralButton(context.translation[&quot;chat_export.dialog_neutral_button&quot;]) { _, _ -&gt;
</a><a href="#h1-1-289" id="h1-1-289" class="d">-                    exportChatForConversations(friendFeedEntries)
</a><a href="#h1-1-290" id="h1-1-290" class="d">-                }
</a><a href="#h1-1-291" id="h1-1-291" class="d">-                .setPositiveButton(context.translation[&quot;chat_export.dialog_positive_button&quot;]) { _, _ -&gt;
</a><a href="#h1-1-292" id="h1-1-292" class="d">-                    exportChatForConversations(selectedConversations)
</a><a href="#h1-1-293" id="h1-1-293" class="d">-                }
</a><a href="#h1-1-294" id="h1-1-294" class="d">-                .show()
</a>         }
     }
 
<a href="#h1-2" id="h1-2" class="h">@@ -158,26 +295,72 @@ class ExportChatMessages : AbstractAction() {
</a>         emptyList()
     }
 
<a href="#h1-2-3" id="h1-2-3" class="d">-    private suspend fun exportFullConversation(friendFeedEntry: FriendFeedEntry) {
</a><a href="#h1-2-4" id="h1-2-4" class="i">+    private fun exportChatForConversations(
</a><a href="#h1-2-5" id="h1-2-5" class="i">+        conversations: List&lt;FriendFeedEntry&gt;,
</a><a href="#h1-2-6" id="h1-2-6" class="i">+        exportParams: ExportParams,
</a><a href="#h1-2-7" id="h1-2-7" class="i">+    ) {
</a><a href="#h1-2-8" id="h1-2-8" class="i">+        dialogLogs.clear()
</a><a href="#h1-2-9" id="h1-2-9" class="i">+        val jobs = mutableListOf&lt;Job&gt;()
</a><a href="#h1-2-10" id="h1-2-10" class="i">+
</a><a href="#h1-2-11" id="h1-2-11" class="i">+        currentActionDialog = ViewAppearanceHelper.newAlertDialogBuilder(context.mainActivity)
</a><a href="#h1-2-12" id="h1-2-12" class="i">+            .setTitle(translation[&quot;exporting_chats&quot;])
</a><a href="#h1-2-13" id="h1-2-13" class="i">+            .setCancelable(false)
</a><a href="#h1-2-14" id="h1-2-14" class="i">+            .setMessage(&quot;&quot;)
</a><a href="#h1-2-15" id="h1-2-15" class="i">+            .create()
</a><a href="#h1-2-16" id="h1-2-16" class="i">+        
</a><a href="#h1-2-17" id="h1-2-17" class="i">+        val conversationSize = translation.format(&quot;processing_chats&quot;, &quot;amount&quot; to conversations.size.toString())
</a><a href="#h1-2-18" id="h1-2-18" class="i">+        
</a><a href="#h1-2-19" id="h1-2-19" class="i">+        logDialog(conversationSize)
</a><a href="#h1-2-20" id="h1-2-20" class="i">+
</a><a href="#h1-2-21" id="h1-2-21" class="i">+        context.coroutineScope.launch {
</a><a href="#h1-2-22" id="h1-2-22" class="i">+            conversations.forEach { conversation -&gt;
</a><a href="#h1-2-23" id="h1-2-23" class="i">+                launch {
</a><a href="#h1-2-24" id="h1-2-24" class="i">+                    runCatching {
</a><a href="#h1-2-25" id="h1-2-25" class="i">+                        exportFullConversation(conversation, exportParams)
</a><a href="#h1-2-26" id="h1-2-26" class="i">+                    }.onFailure {
</a><a href="#h1-2-27" id="h1-2-27" class="i">+                        logDialog(translation.format(&quot;export_fail&quot;, &quot;conversation&quot; to conversation.key.toString()))
</a><a href="#h1-2-28" id="h1-2-28" class="i">+                        logDialog(it.stackTraceToString())
</a><a href="#h1-2-29" id="h1-2-29" class="i">+                        CoreLogger.xposedLog(it)
</a><a href="#h1-2-30" id="h1-2-30" class="i">+                    }
</a><a href="#h1-2-31" id="h1-2-31" class="i">+                }.also { jobs.add(it) }
</a><a href="#h1-2-32" id="h1-2-32" class="i">+            }
</a><a href="#h1-2-33" id="h1-2-33" class="i">+            jobs.joinAll()
</a><a href="#h1-2-34" id="h1-2-34" class="i">+            logDialog(translation[&quot;finished&quot;])
</a><a href="#h1-2-35" id="h1-2-35" class="i">+        }.also {
</a><a href="#h1-2-36" id="h1-2-36" class="i">+            currentActionDialog?.setButton(DialogInterface.BUTTON_POSITIVE, translation[&quot;dialog_negative_button&quot;]) { dialog, _ -&gt;
</a><a href="#h1-2-37" id="h1-2-37" class="i">+                it.cancel()
</a><a href="#h1-2-38" id="h1-2-38" class="i">+                jobs.forEach { it.cancel() }
</a><a href="#h1-2-39" id="h1-2-39" class="i">+                dialog.dismiss()
</a><a href="#h1-2-40" id="h1-2-40" class="i">+            }
</a><a href="#h1-2-41" id="h1-2-41" class="i">+        }
</a><a href="#h1-2-42" id="h1-2-42" class="i">+
</a><a href="#h1-2-43" id="h1-2-43" class="i">+        currentActionDialog!!.also {
</a><a href="#h1-2-44" id="h1-2-44" class="i">+            it.setCanceledOnTouchOutside(false)
</a><a href="#h1-2-45" id="h1-2-45" class="i">+        }.show()
</a><a href="#h1-2-46" id="h1-2-46" class="i">+    }
</a><a href="#h1-2-47" id="h1-2-47" class="i">+
</a><a href="#h1-2-48" id="h1-2-48" class="i">+    private suspend fun exportFullConversation(
</a><a href="#h1-2-49" id="h1-2-49" class="i">+        feedEntry: FriendFeedEntry,
</a><a href="#h1-2-50" id="h1-2-50" class="i">+        exportParams: ExportParams,
</a><a href="#h1-2-51" id="h1-2-51" class="i">+    ) {
</a>         //first fetch the first message
<a href="#h1-2-53" id="h1-2-53" class="d">-        val conversationId = friendFeedEntry.key!!
</a><a href="#h1-2-54" id="h1-2-54" class="d">-        val conversationName = friendFeedEntry.feedDisplayName ?: friendFeedEntry.friendDisplayName!!.split(&quot;|&quot;).lastOrNull() ?: &quot;unknown&quot;
</a><a href="#h1-2-55" id="h1-2-55" class="d">-        val conversationParticipants = context.database.getConversationParticipants(friendFeedEntry.key!!)
</a><a href="#h1-2-56" id="h1-2-56" class="i">+        val conversationId = feedEntry.key!!
</a><a href="#h1-2-57" id="h1-2-57" class="i">+        val conversationName = feedEntry.feedDisplayName ?: feedEntry.friendDisplayName!!.split(&quot;|&quot;).lastOrNull() ?: &quot;unknown&quot;
</a><a href="#h1-2-58" id="h1-2-58" class="i">+        val conversationParticipants = context.database.getConversationParticipants(feedEntry.key!!)
</a>             ?.mapNotNull {
                 context.database.getFriendInfo(it)
             }?.associateBy { it.userId!! } ?: emptyMap()
 
         val publicFolder = File(Environment.getExternalStoragePublicDirectory(Environment.DIRECTORY_DOWNLOADS), &quot;SnapEnhance&quot;).also { if (!it.exists()) it.mkdirs() }
<a href="#h1-2-64" id="h1-2-64" class="d">-        val outputFile = publicFolder.resolve(&quot;conversation_${conversationName}_${System.currentTimeMillis()}.${exportType!!.extension}&quot;)
</a><a href="#h1-2-65" id="h1-2-65" class="i">+        val outputFile = publicFolder.resolve(&quot;conversation_${conversationName}_${System.currentTimeMillis()}.${exportParams.exportFormat.extension}&quot;)
</a> 
<a href="#h1-2-67" id="h1-2-67" class="d">-        logDialog(context.translation.format(&quot;chat_export.exporting_message&quot;, &quot;conversation&quot; to conversationName))
</a><a href="#h1-2-68" id="h1-2-68" class="i">+        logDialog(translation.format(&quot;exporting_message&quot;, &quot;conversation&quot; to conversationName))
</a> 
         val conversationExporter = ConversationExporter(
             context = context,
<a href="#h1-2-72" id="h1-2-72" class="d">-            friendFeedEntry = friendFeedEntry,
</a><a href="#h1-2-73" id="h1-2-73" class="i">+            friendFeedEntry = feedEntry,
</a>             conversationParticipants = conversationParticipants,
<a href="#h1-2-75" id="h1-2-75" class="d">-            exportFormat = exportType!!,
</a><a href="#h1-2-76" id="h1-2-76" class="d">-            messageTypeFilter = mediaToDownload,
</a><a href="#h1-2-77" id="h1-2-77" class="i">+            exportParams = exportParams,
</a>             cacheFolder = publicFolder.resolve(&quot;cache&quot;).also { if (!it.exists()) it.mkdirs() },
             outputFile = outputFile,
         ).apply { init(); printLog = {
<a href="#h1-3" id="h1-3" class="h">@@ -187,17 +370,28 @@ class ExportChatMessages : AbstractAction() {
</a>         var foundMessageCount = 0
 
         var lastMessageId = fetchMessagesPaginated(conversationId, Long.MAX_VALUE, amount = 1).firstOrNull()?.messageDescriptor?.messageId ?: run {
<a href="#h1-3-3" id="h1-3-3" class="d">-            logDialog(context.translation[&quot;chat_export.no_messages_found&quot;])
</a><a href="#h1-3-4" id="h1-3-4" class="i">+            logDialog(translation[&quot;no_messages_found&quot;])
</a>             return
         }
 
         while (true) {
<a href="#h1-3-9" id="h1-3-9" class="d">-            val fetchedMessages = fetchMessagesPaginated(conversationId, lastMessageId, amount = 500)
</a><a href="#h1-3-10" id="h1-3-10" class="i">+            val fetchedMessages = fetchMessagesPaginated(conversationId, lastMessageId, amount = 500).toMutableList()
</a>             if (fetchedMessages.isEmpty()) break
<a href="#h1-3-12" id="h1-3-12" class="i">+
</a><a href="#h1-3-13" id="h1-3-13" class="i">+            fetchedMessages.firstOrNull()?.let {
</a><a href="#h1-3-14" id="h1-3-14" class="i">+                lastMessageId = it.messageDescriptor!!.messageId!!
</a><a href="#h1-3-15" id="h1-3-15" class="i">+            }
</a><a href="#h1-3-16" id="h1-3-16" class="i">+
</a><a href="#h1-3-17" id="h1-3-17" class="i">+            exportParams.messageTypeFilter?.let { filter -&gt;
</a><a href="#h1-3-18" id="h1-3-18" class="i">+                fetchedMessages.removeIf { message -&gt;
</a><a href="#h1-3-19" id="h1-3-19" class="i">+                    !filter.contains(message.messageContent?.contentType ?: return@removeIf false)
</a><a href="#h1-3-20" id="h1-3-20" class="i">+                }
</a><a href="#h1-3-21" id="h1-3-21" class="i">+            }
</a><a href="#h1-3-22" id="h1-3-22" class="i">+
</a>             foundMessageCount += fetchedMessages.size
 
<a href="#h1-3-25" id="h1-3-25" class="d">-            if (amountOfMessages != null &amp;&amp; foundMessageCount &gt;= amountOfMessages!!) {
</a><a href="#h1-3-26" id="h1-3-26" class="d">-                fetchedMessages.subList(0, amountOfMessages!! - foundMessageCount).reversed().forEach { message -&gt;
</a><a href="#h1-3-27" id="h1-3-27" class="i">+            if (exportParams.amountOfMessages != null &amp;&amp; foundMessageCount &gt;= exportParams.amountOfMessages) {
</a><a href="#h1-3-28" id="h1-3-28" class="i">+                fetchedMessages.reversed().subList(0, exportParams.amountOfMessages - (foundMessageCount - fetchedMessages.size)).forEach { message -&gt;
</a>                     conversationExporter.readMessage(message)
                 }
                 break
<a href="#h1-4" id="h1-4" class="h">@@ -207,57 +401,15 @@ class ExportChatMessages : AbstractAction() {
</a>                 conversationExporter.readMessage(message)
             }
 
<a href="#h1-4-3" id="h1-4-3" class="d">-            fetchedMessages.firstOrNull()?.let {
</a><a href="#h1-4-4" id="h1-4-4" class="d">-                lastMessageId = it.messageDescriptor!!.messageId!!
</a><a href="#h1-4-5" id="h1-4-5" class="d">-            }
</a>             setStatus(&quot;Exporting (found ${foundMessageCount})&quot;)
         }
 
<a href="#h1-4-9" id="h1-4-9" class="d">-        if (exportType == ExportFormat.HTML) conversationExporter.awaitDownload()
</a><a href="#h1-4-10" id="h1-4-10" class="i">+        if (exportParams.exportFormat == ExportFormat.HTML) conversationExporter.awaitDownload()
</a>         conversationExporter.close()
<a href="#h1-4-12" id="h1-4-12" class="d">-        logDialog(context.translation[&quot;chat_export.writing_output&quot;])
</a><a href="#h1-4-13" id="h1-4-13" class="i">+        logDialog(translation[&quot;writing_output&quot;])
</a>         dialogLogs.clear()
<a href="#h1-4-15" id="h1-4-15" class="d">-        logDialog(&quot;\n&quot; + context.translation.format(&quot;chat_export.exported_to&quot;,
</a><a href="#h1-4-16" id="h1-4-16" class="i">+        logDialog(&quot;\n&quot; + translation.format(&quot;exported_to&quot;,
</a>             &quot;path&quot; to outputFile.absolutePath.toString()
         ) + &quot;\n&quot;)
     }
<a href="#h1-4-20" id="h1-4-20" class="d">-
</a><a href="#h1-4-21" id="h1-4-21" class="d">-    private fun exportChatForConversations(conversations: List&lt;FriendFeedEntry&gt;) {
</a><a href="#h1-4-22" id="h1-4-22" class="d">-        dialogLogs.clear()
</a><a href="#h1-4-23" id="h1-4-23" class="d">-        val jobs = mutableListOf&lt;Job&gt;()
</a><a href="#h1-4-24" id="h1-4-24" class="d">-
</a><a href="#h1-4-25" id="h1-4-25" class="d">-        currentActionDialog = ViewAppearanceHelper.newAlertDialogBuilder(context.mainActivity)
</a><a href="#h1-4-26" id="h1-4-26" class="d">-            .setTitle(context.translation[&quot;chat_export.exporting_chats&quot;])
</a><a href="#h1-4-27" id="h1-4-27" class="d">-            .setCancelable(false)
</a><a href="#h1-4-28" id="h1-4-28" class="d">-            .setMessage(&quot;&quot;)
</a><a href="#h1-4-29" id="h1-4-29" class="d">-            .create()
</a><a href="#h1-4-30" id="h1-4-30" class="d">-        
</a><a href="#h1-4-31" id="h1-4-31" class="d">-        val conversationSize = context.translation.format(&quot;chat_export.processing_chats&quot;, &quot;amount&quot; to conversations.size.toString())
</a><a href="#h1-4-32" id="h1-4-32" class="d">-        
</a><a href="#h1-4-33" id="h1-4-33" class="d">-        logDialog(conversationSize)
</a><a href="#h1-4-34" id="h1-4-34" class="d">-
</a><a href="#h1-4-35" id="h1-4-35" class="d">-        context.coroutineScope.launch {
</a><a href="#h1-4-36" id="h1-4-36" class="d">-            conversations.forEach { conversation -&gt;
</a><a href="#h1-4-37" id="h1-4-37" class="d">-                launch {
</a><a href="#h1-4-38" id="h1-4-38" class="d">-                    runCatching {
</a><a href="#h1-4-39" id="h1-4-39" class="d">-                        exportFullConversation(conversation)
</a><a href="#h1-4-40" id="h1-4-40" class="d">-                    }.onFailure {
</a><a href="#h1-4-41" id="h1-4-41" class="d">-                        logDialog(context.translation.format(&quot;chat_export.export_fail&quot;, &quot;conversation&quot; to conversation.key.toString()))
</a><a href="#h1-4-42" id="h1-4-42" class="d">-                        logDialog(it.stackTraceToString())
</a><a href="#h1-4-43" id="h1-4-43" class="d">-                        CoreLogger.xposedLog(it)
</a><a href="#h1-4-44" id="h1-4-44" class="d">-                    }
</a><a href="#h1-4-45" id="h1-4-45" class="d">-                }.also { jobs.add(it) }
</a><a href="#h1-4-46" id="h1-4-46" class="d">-            }
</a><a href="#h1-4-47" id="h1-4-47" class="d">-            jobs.joinAll()
</a><a href="#h1-4-48" id="h1-4-48" class="d">-            logDialog(context.translation[&quot;chat_export.finished&quot;])
</a><a href="#h1-4-49" id="h1-4-49" class="d">-        }.also {
</a><a href="#h1-4-50" id="h1-4-50" class="d">-            currentActionDialog?.setButton(DialogInterface.BUTTON_POSITIVE, context.translation[&quot;chat_export.dialog_negative_button&quot;]) { dialog, _ -&gt;
</a><a href="#h1-4-51" id="h1-4-51" class="d">-                it.cancel()
</a><a href="#h1-4-52" id="h1-4-52" class="d">-                jobs.forEach { it.cancel() }
</a><a href="#h1-4-53" id="h1-4-53" class="d">-                dialog.dismiss()
</a><a href="#h1-4-54" id="h1-4-54" class="d">-            }
</a><a href="#h1-4-55" id="h1-4-55" class="d">-        }
</a><a href="#h1-4-56" id="h1-4-56" class="d">-
</a><a href="#h1-4-57" id="h1-4-57" class="d">-        currentActionDialog!!.show()
</a><a href="#h1-4-58" id="h1-4-58" class="d">-    }
</a> } 
\ No newline at end of file
<b>diff --git a/<a id="h2" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/messaging/ConversationExporter.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/messaging/ConversationExporter.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/messaging/ConversationExporter.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/messaging/ConversationExporter.kt</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -34,8 +34,7 @@ class ConversationExporter(
</a>     private val context: ModContext,
     private val friendFeedEntry: FriendFeedEntry,
     private val conversationParticipants: Map&lt;String, FriendInfo&gt;,
<a href="#h2-0-3" id="h2-0-3" class="d">-    private val exportFormat: ExportFormat,
</a><a href="#h2-0-4" id="h2-0-4" class="d">-    private val messageTypeFilter: List&lt;ContentType&gt;? = null,
</a><a href="#h2-0-5" id="h2-0-5" class="i">+    private val exportParams: ExportParams,
</a>     private val cacheFolder: File,
     private val outputFile: File
 ) {
<a href="#h2-1" id="h2-1" class="h">@@ -44,13 +43,13 @@ class ConversationExporter(
</a>     private val downloadThreadExecutor = Executors.newFixedThreadPool(4)
     private val writeThreadExecutor = Executors.newSingleThreadExecutor()
 
<a href="#h2-1-3" id="h2-1-3" class="d">-    private val conversationJsonDataFile by lazy { cacheFolder.resolve(&quot;messages.json&quot;) }
</a><a href="#h2-1-4" id="h2-1-4" class="i">+    private val conversationJsonDataFile by lazy { cacheFolder.resolve(&quot;messages_${friendFeedEntry.key}.json&quot;) }
</a>     private val jsonDataWriter by lazy { JsonWriter(conversationJsonDataFile.writer()) }
     private val outputFileStream by lazy { outputFile.outputStream() }
     private val participants = mutableMapOf&lt;String, Int&gt;()
 
     fun init() {
<a href="#h2-1-10" id="h2-1-10" class="d">-        when (exportFormat) {
</a><a href="#h2-1-11" id="h2-1-11" class="i">+        when (exportParams.exportFormat) {
</a>             ExportFormat.TEXT -&gt; {
                 outputFileStream.write(&quot;Conversation id: ${friendFeedEntry.key}\n&quot;.toByteArray())
                 outputFileStream.write(&quot;Conversation name: ${friendFeedEntry.feedDisplayName}\n&quot;.toByteArray())
<a href="#h2-2" id="h2-2" class="h">@@ -86,7 +85,7 @@ class ConversationExporter(
</a> 
                 jsonDataWriter.name(&quot;messages&quot;).beginArray()
 
<a href="#h2-2-3" id="h2-2-3" class="d">-                if (exportFormat != ExportFormat.HTML) return
</a><a href="#h2-2-4" id="h2-2-4" class="i">+                if (exportParams.exportFormat != ExportFormat.HTML) return
</a>                 outputFileStream.write(&quot;&quot;&quot;
                     &lt;!DOCTYPE html&gt;
                     &lt;html&gt;
<a href="#h2-3" id="h2-3" class="h">@@ -158,7 +157,7 @@ class ConversationExporter(
</a>     }
 
     fun readMessage(message: Message) {
<a href="#h2-3-3" id="h2-3-3" class="d">-        if (exportFormat == ExportFormat.TEXT) {
</a><a href="#h2-3-4" id="h2-3-4" class="i">+        if (exportParams.exportFormat == ExportFormat.TEXT) {
</a>             val (displayName, senderUsername) = conversationParticipants[message.senderId.toString()]?.let {
                 it.displayName to it.mutableUsername
             } ?: (&quot;&quot; to message.senderId.toString())
<a href="#h2-4" id="h2-4" class="h">@@ -169,15 +168,10 @@ class ConversationExporter(
</a>         }
         val contentType = message.messageContent?.contentType ?: return
 
<a href="#h2-4-3" id="h2-4-3" class="d">-        if (messageTypeFilter != null) {
</a><a href="#h2-4-4" id="h2-4-4" class="d">-            if (!messageTypeFilter.contains(contentType))  return
</a><a href="#h2-4-5" id="h2-4-5" class="d">-
</a><a href="#h2-4-6" id="h2-4-6" class="d">-            if (contentType == ContentType.NOTE || contentType == ContentType.SNAP || contentType == ContentType.EXTERNAL_MEDIA) {
</a><a href="#h2-4-7" id="h2-4-7" class="d">-                downloadMedia(message)
</a><a href="#h2-4-8" id="h2-4-8" class="d">-            }
</a><a href="#h2-4-9" id="h2-4-9" class="i">+        if (exportParams.downloadMedias &amp;&amp; (contentType == ContentType.NOTE || contentType == ContentType.SNAP || contentType == ContentType.EXTERNAL_MEDIA)) {
</a><a href="#h2-4-10" id="h2-4-10" class="i">+            downloadMedia(message)
</a>         }
 
<a href="#h2-4-13" id="h2-4-13" class="d">-
</a>         jsonDataWriter.apply {
             beginObject()
             name(&quot;orderKey&quot;).value(message.orderKey)
<a href="#h2-5" id="h2-5" class="h">@@ -236,20 +230,20 @@ class ConversationExporter(
</a>     }
 
     fun close() {
<a href="#h2-5-3" id="h2-5-3" class="d">-        if (exportFormat != ExportFormat.TEXT) {
</a><a href="#h2-5-4" id="h2-5-4" class="i">+        if (exportParams.exportFormat != ExportFormat.TEXT) {
</a>             jsonDataWriter.endArray()
             jsonDataWriter.endObject()
             jsonDataWriter.flush()
             jsonDataWriter.close()
         }
 
<a href="#h2-5-11" id="h2-5-11" class="d">-        if (exportFormat == ExportFormat.JSON) {
</a><a href="#h2-5-12" id="h2-5-12" class="i">+        if (exportParams.exportFormat == ExportFormat.JSON) {
</a>             conversationJsonDataFile.inputStream().use {
                 it.copyTo(outputFileStream)
             }
         }
 
<a href="#h2-5-18" id="h2-5-18" class="d">-        if (exportFormat == ExportFormat.HTML) {
</a><a href="#h2-5-19" id="h2-5-19" class="i">+        if (exportParams.exportFormat == ExportFormat.HTML) {
</a>             //write the json file
             outputFileStream.write(&quot;&lt;script type=\&quot;application/json\&quot; class=\&quot;exported_content\&quot;&gt;&quot;.toByteArray())
 
<a href="#h2-6" id="h2-6" class="h">@@ -259,9 +253,14 @@ class ConversationExporter(
</a>                 android.util.Base64.DEFAULT or android.util.Base64.NO_WRAP,
                 true
             ) as OutputStream).let { outputStream -&gt;
<a href="#h2-6-3" id="h2-6-3" class="d">-                val deflateOutputStream = DeflaterOutputStream(outputStream, Deflater(Deflater.BEST_COMPRESSION, true), true)
</a><a href="#h2-6-4" id="h2-6-4" class="d">-                conversationJsonDataFile.inputStream().use {
</a><a href="#h2-6-5" id="h2-6-5" class="d">-                    it.copyTo(deflateOutputStream)
</a><a href="#h2-6-6" id="h2-6-6" class="i">+                val deflateOutputStream = DeflaterOutputStream(outputStream, Deflater(Deflater.BEST_SPEED, true), true)
</a><a href="#h2-6-7" id="h2-6-7" class="i">+                conversationJsonDataFile.inputStream().use { fileInputStream -&gt;
</a><a href="#h2-6-8" id="h2-6-8" class="i">+                    val buffer = ByteArray(4096)
</a><a href="#h2-6-9" id="h2-6-9" class="i">+                    var length: Int
</a><a href="#h2-6-10" id="h2-6-10" class="i">+                    while (fileInputStream.read(buffer).also { length = it } &gt; 0) {
</a><a href="#h2-6-11" id="h2-6-11" class="i">+                        deflateOutputStream.write(buffer, 0, length)
</a><a href="#h2-6-12" id="h2-6-12" class="i">+                        deflateOutputStream.flush()
</a><a href="#h2-6-13" id="h2-6-13" class="i">+                    }
</a>                 }
                 deflateOutputStream.finish()
                 outputStream.flush()
<b>diff --git a/<a id="h3" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/messaging/ExportParams.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/messaging/ExportParams.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/messaging/ExportParams.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/messaging/ExportParams.kt</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -0,0 +1,10 @@
</a><a href="#h3-0-0" id="h3-0-0" class="i">+package me.rhunk.snapenhance.core.messaging
</a><a href="#h3-0-1" id="h3-0-1" class="i">+
</a><a href="#h3-0-2" id="h3-0-2" class="i">+import me.rhunk.snapenhance.common.data.ContentType
</a><a href="#h3-0-3" id="h3-0-3" class="i">+
</a><a href="#h3-0-4" id="h3-0-4" class="i">+class ExportParams(
</a><a href="#h3-0-5" id="h3-0-5" class="i">+    val exportFormat: ExportFormat = ExportFormat.HTML,
</a><a href="#h3-0-6" id="h3-0-6" class="i">+    val messageTypeFilter: List&lt;ContentType&gt;? = null,
</a><a href="#h3-0-7" id="h3-0-7" class="i">+    val amountOfMessages: Int? = null,
</a><a href="#h3-0-8" id="h3-0-8" class="i">+    val downloadMedias: Boolean = false,
</a><a href="#h3-0-9" id="h3-0-9" class="i">+)
</a></pre>
</div>
</body>
</html>
