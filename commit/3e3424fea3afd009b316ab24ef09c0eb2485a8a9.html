<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>refactor(app): navigation - SnapEnhance - An Xposed module offering an enhanced Snapchat experience
</title>
<link rel="icon" type="image/svg+xml" href="../../logo.png"/>
<link rel="alternate icon" href="../../favicon.png"/>
<link rel="alternate" type="application/atom+xml" title="SnapEnhance Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="SnapEnhance Atom Feed (tags)" href="../tags.xml" />
<link rel="stylesheet" type="text/css" href="../../style.css" />
<link rel="stylesheet" type="text/css" href="../../fonts.css" />
</head>
<body>
<div id="head"><table><tr><td><a class="logo" href="../../"><img src="../../logo.png" alt="" width="32" height="32" /></a></td><td><strong>SnapEnhance</strong><span class="desc"> - An Xposed module offering an enhanced Snapchat experience
</span>
</td></tr></table>
<p><a href="../about.html">About</a> | <a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/LICENSE.html">License</a></p>
</div>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/3e3424fea3afd009b316ab24ef09c0eb2485a8a9.html">3e3424fea3afd009b316ab24ef09c0eb2485a8a9</a>
<b>parent</b> <a href="../commit/d6128a8849f3df3cc1af0a72e2846303786a3c73.html">d6128a8849f3df3cc1af0a72e2846303786a3c73</a>
<b>Author:</b> rhunk &lt;<a href="mailto:101876869+rhunk@users.noreply.github.com">101876869+rhunk@users.noreply.github.com</a>&gt;
<b>Date:</b>   Sat, 10 Feb 2024 19:00:58 +0100

refactor(app): navigation

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/MainActivity.kt</a></td><td> | </td><td class="num">37</td><td><span class="i">++++++++++++</span><span class="d">-------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/Navigation.kt</a></td><td> | </td><td class="num">139</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++</span><span class="d">----------------------------------------</span></td></tr>
<tr><td class="A">A</td><td><a href="#h2">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/Routes.kt</a></td><td> | </td><td class="num">135</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="D">D</td><td><a href="#h3">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/Section.kt</a></td><td> | </td><td class="num">92</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="A">A</td><td><a href="#h4">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/TasksRoot.kt</a></td><td> | </td><td class="num">453</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h5">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/features/CallbackAlias.kt</a></td><td> | </td><td class="num">5</td><td><span class="i">+++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h6">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/features/FeaturesRoot.kt</a></td><td> | </td><td class="num">576</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h7">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/home/HomeLogs.kt</a></td><td> | </td><td class="num">253</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h8">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/home/HomeRoot.kt</a></td><td> | </td><td class="num">278</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h9">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/home/HomeSettings.kt</a></td><td> | </td><td class="num">243</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h10">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/scripting/ScriptingRoot.kt</a></td><td> | </td><td class="num">302</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h11">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/social/AddFriendDialog.kt</a></td><td> | </td><td class="num">260</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h12">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/social/LoggedStories.kt</a></td><td> | </td><td class="num">278</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h13">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/social/ManageScope.kt</a></td><td> | </td><td class="num">384</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h14">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/social/MessagingPreview.kt</a></td><td> | </td><td class="num">537</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h15">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/social/SocialRoot.kt</a></td><td> | </td><td class="num">270</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="D">D</td><td><a href="#h16">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/DebugSection.kt</a></td><td> | </td><td class="num">5</td><td><span class="i"></span><span class="d">-----</span></td></tr>
<tr><td class="D">D</td><td><a href="#h17">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/NotImplemented.kt</a></td><td> | </td><td class="num">24</td><td><span class="i"></span><span class="d">------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h18">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/TasksSection.kt</a></td><td> | </td><td class="num">457</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h19">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/features/CallbackAlias.kt</a></td><td> | </td><td class="num">5</td><td><span class="i"></span><span class="d">-----</span></td></tr>
<tr><td class="D">D</td><td><a href="#h20">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/features/FeaturesSection.kt</a></td><td> | </td><td class="num">590</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h21">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/features/PickLocation.kt</a></td><td> | </td><td class="num">5</td><td><span class="i"></span><span class="d">-----</span></td></tr>
<tr><td class="D">D</td><td><a href="#h22">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/home/HomeSection.kt</a></td><td> | </td><td class="num">319</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h23">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/home/HomeSubSection.kt</a></td><td> | </td><td class="num">255</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h24">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/home/SettingsSection.kt</a></td><td> | </td><td class="num">241</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h25">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/scripting/ScriptsSection.kt</a></td><td> | </td><td class="num">306</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h26">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/social/AddFriendDialog.kt</a></td><td> | </td><td class="num">264</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h27">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/social/LoggedStories.kt</a></td><td> | </td><td class="num">277</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h28">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/social/MessagingPreview.kt</a></td><td> | </td><td class="num">523</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h29">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/social/ScopeContent.kt</a></td><td> | </td><td class="num">360</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h30">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/social/SocialSection.kt</a></td><td> | </td><td class="num">364</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h31">app/src/main/kotlin/me/rhunk/snapenhance/ui/overlay/SettingsOverlay.kt</a></td><td> | </td><td class="num">21</td><td><span class="i">++++</span><span class="d">-----------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h32">common/src/main/assets/lang/en_US.json</a></td><td> | </td><td class="num">2</td><td><span class="i">++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h33">core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/BridgeClient.kt</a></td><td> | </td><td class="num">1</td><td><span class="i"></span><span class="d">-</span></td></tr>
</table></pre><pre>34 files changed, 4061 insertions(+), 4200 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/MainActivity.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/MainActivity.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/MainActivity.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/MainActivity.kt</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -15,15 +15,9 @@ import me.rhunk.snapenhance.SharedContextHolder
</a> import me.rhunk.snapenhance.common.ui.AppMaterialTheme
 
 class MainActivity : ComponentActivity() {
<a href="#h0-0-3" id="h0-0-3" class="d">-    private lateinit var sections: Map&lt;EnumSection, Section&gt;
</a>     private lateinit var navController: NavHostController
     private lateinit var managerContext: RemoteSideContext
 
<a href="#h0-0-7" id="h0-0-7" class="d">-    override fun onPostResume() {
</a><a href="#h0-0-8" id="h0-0-8" class="d">-        super.onPostResume()
</a><a href="#h0-0-9" id="h0-0-9" class="d">-        sections.values.forEach { it.onResumed() }
</a><a href="#h0-0-10" id="h0-0-10" class="d">-    }
</a><a href="#h0-0-11" id="h0-0-11" class="d">-
</a>     override fun onNewIntent(intent: Intent) {
         super.onNewIntent(intent)
         if (::navController.isInitialized.not()) return
<a href="#h0-1" id="h0-1" class="h">@@ -40,37 +34,30 @@ class MainActivity : ComponentActivity() {
</a>     override fun onCreate(savedInstanceState: Bundle?) {
         super.onCreate(savedInstanceState)
 
<a href="#h0-1-3" id="h0-1-3" class="d">-        val startDestination = intent.getStringExtra(&quot;route&quot;)?.let { EnumSection.fromRoute(it) } ?: EnumSection.HOME
</a>         managerContext = SharedContextHolder.remote(this).apply {
             activity = this@MainActivity
             checkForRequirements()
         }
 
<a href="#h0-1-9" id="h0-1-9" class="d">-        sections = EnumSection.entries.associateWith {
</a><a href="#h0-1-10" id="h0-1-10" class="d">-            it.section.java.constructors.first().newInstance() as Section
</a><a href="#h0-1-11" id="h0-1-11" class="d">-        }.onEach { (section, instance) -&gt;
</a><a href="#h0-1-12" id="h0-1-12" class="d">-            with(instance) {
</a><a href="#h0-1-13" id="h0-1-13" class="d">-                enumSection = section
</a><a href="#h0-1-14" id="h0-1-14" class="d">-                context = managerContext
</a><a href="#h0-1-15" id="h0-1-15" class="d">-                init()
</a><a href="#h0-1-16" id="h0-1-16" class="d">-            }
</a><a href="#h0-1-17" id="h0-1-17" class="d">-        }
</a><a href="#h0-1-18" id="h0-1-18" class="i">+        val routes = Routes(managerContext)
</a><a href="#h0-1-19" id="h0-1-19" class="i">+        routes.getRoutes().forEach { it.init() }
</a> 
         setContent {
             navController = rememberNavController()
<a href="#h0-1-23" id="h0-1-23" class="d">-            val navigation = remember { Navigation(managerContext, sections, navController) }
</a><a href="#h0-1-24" id="h0-1-24" class="i">+            val navigation = remember {
</a><a href="#h0-1-25" id="h0-1-25" class="i">+                Navigation(managerContext, navController, routes.also {
</a><a href="#h0-1-26" id="h0-1-26" class="i">+                    it.navController = navController
</a><a href="#h0-1-27" id="h0-1-27" class="i">+                })
</a><a href="#h0-1-28" id="h0-1-28" class="i">+            }
</a><a href="#h0-1-29" id="h0-1-29" class="i">+            val startDestination = remember { intent.getStringExtra(&quot;route&quot;) ?: routes.home.routeInfo.id }
</a><a href="#h0-1-30" id="h0-1-30" class="i">+
</a>             AppMaterialTheme {
                 Scaffold(
                     containerColor = MaterialTheme.colorScheme.background,
                     topBar = { navigation.TopBar() },
<a href="#h0-1-35" id="h0-1-35" class="d">-                    bottomBar = { navigation.NavBar() },
</a><a href="#h0-1-36" id="h0-1-36" class="d">-                    floatingActionButton = { navigation.Fab() }
</a><a href="#h0-1-37" id="h0-1-37" class="d">-                ) { innerPadding -&gt;
</a><a href="#h0-1-38" id="h0-1-38" class="d">-                    navigation.NavigationHost(
</a><a href="#h0-1-39" id="h0-1-39" class="d">-                        innerPadding = innerPadding,
</a><a href="#h0-1-40" id="h0-1-40" class="d">-                        startDestination = startDestination
</a><a href="#h0-1-41" id="h0-1-41" class="d">-                    )
</a><a href="#h0-1-42" id="h0-1-42" class="d">-                }
</a><a href="#h0-1-43" id="h0-1-43" class="i">+                    bottomBar = { navigation.BottomBar() },
</a><a href="#h0-1-44" id="h0-1-44" class="i">+                    floatingActionButton = { navigation.FloatingActionButton() }
</a><a href="#h0-1-45" id="h0-1-45" class="i">+                ) { innerPadding -&gt; navigation.Content(innerPadding, startDestination) }
</a>             }
         }
     }
<b>diff --git a/<a id="h1" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/Navigation.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/Navigation.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/Navigation.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/Navigation.kt</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -10,64 +10,40 @@ import androidx.compose.material.icons.filled.ArrowBack
</a> import androidx.compose.material3.*
 import androidx.compose.runtime.Composable
 import androidx.compose.runtime.getValue
<a href="#h1-0-3" id="h1-0-3" class="i">+import androidx.compose.runtime.remember
</a> import androidx.compose.ui.Modifier
 import androidx.compose.ui.graphics.graphicsLayer
 import androidx.compose.ui.text.style.TextAlign
 import androidx.compose.ui.unit.dp
 import androidx.compose.ui.unit.lerp
 import androidx.compose.ui.unit.sp
<a href="#h1-0-10" id="h1-0-10" class="d">-import androidx.navigation.NavDestination
</a><a href="#h1-0-11" id="h1-0-11" class="d">-import androidx.navigation.NavDestination.Companion.hierarchy
</a><a href="#h1-0-12" id="h1-0-12" class="d">-import androidx.navigation.NavGraph.Companion.findStartDestination
</a> import androidx.navigation.NavHostController
 import androidx.navigation.compose.NavHost
<a href="#h1-0-15" id="h1-0-15" class="i">+import androidx.navigation.compose.composable
</a> import androidx.navigation.compose.currentBackStackEntryAsState
<a href="#h1-0-17" id="h1-0-17" class="i">+import androidx.navigation.navigation
</a> import me.rhunk.snapenhance.RemoteSideContext
 
<a href="#h1-0-20" id="h1-0-20" class="d">-
</a><a href="#h1-0-21" id="h1-0-21" class="i">+@OptIn(ExperimentalMaterial3Api::class)
</a> class Navigation(
     private val context: RemoteSideContext,
<a href="#h1-0-24" id="h1-0-24" class="d">-    private val sections: Map&lt;EnumSection, Section&gt;,
</a><a href="#h1-0-25" id="h1-0-25" class="d">-    private val navHostController: NavHostController
</a><a href="#h1-0-26" id="h1-0-26" class="d">-){
</a><a href="#h1-0-27" id="h1-0-27" class="d">-    @Composable
</a><a href="#h1-0-28" id="h1-0-28" class="d">-    fun NavigationHost(
</a><a href="#h1-0-29" id="h1-0-29" class="d">-        startDestination: EnumSection,
</a><a href="#h1-0-30" id="h1-0-30" class="d">-        innerPadding: PaddingValues
</a><a href="#h1-0-31" id="h1-0-31" class="d">-    ) {
</a><a href="#h1-0-32" id="h1-0-32" class="d">-        NavHost(
</a><a href="#h1-0-33" id="h1-0-33" class="d">-            navHostController,
</a><a href="#h1-0-34" id="h1-0-34" class="d">-            startDestination = startDestination.route,
</a><a href="#h1-0-35" id="h1-0-35" class="d">-            Modifier.padding(innerPadding),
</a><a href="#h1-0-36" id="h1-0-36" class="d">-            enterTransition = { fadeIn(tween(100)) },
</a><a href="#h1-0-37" id="h1-0-37" class="d">-            exitTransition = { fadeOut(tween(100)) }
</a><a href="#h1-0-38" id="h1-0-38" class="d">-        ) {
</a><a href="#h1-0-39" id="h1-0-39" class="d">-            sections.forEach { (_, instance) -&gt;
</a><a href="#h1-0-40" id="h1-0-40" class="d">-                instance.navController = navHostController
</a><a href="#h1-0-41" id="h1-0-41" class="d">-                instance.build(this)
</a><a href="#h1-0-42" id="h1-0-42" class="d">-            }
</a><a href="#h1-0-43" id="h1-0-43" class="d">-        }
</a><a href="#h1-0-44" id="h1-0-44" class="i">+    private val navController: NavHostController,
</a><a href="#h1-0-45" id="h1-0-45" class="i">+    val routes: Routes = Routes(context).also {
</a><a href="#h1-0-46" id="h1-0-46" class="i">+        it.navController = navController
</a>     }
<a href="#h1-0-48" id="h1-0-48" class="d">-
</a><a href="#h1-0-49" id="h1-0-49" class="d">-    private fun getCurrentSection(navDestination: NavDestination) = sections.firstNotNullOf { (section, instance) -&gt;
</a><a href="#h1-0-50" id="h1-0-50" class="d">-        if (navDestination.hierarchy.any { it.route == section.route }) {
</a><a href="#h1-0-51" id="h1-0-51" class="d">-            instance
</a><a href="#h1-0-52" id="h1-0-52" class="d">-        } else {
</a><a href="#h1-0-53" id="h1-0-53" class="d">-            null
</a><a href="#h1-0-54" id="h1-0-54" class="d">-        }
</a><a href="#h1-0-55" id="h1-0-55" class="d">-    }
</a><a href="#h1-0-56" id="h1-0-56" class="d">-
</a><a href="#h1-0-57" id="h1-0-57" class="d">-    @OptIn(ExperimentalMaterial3Api::class)
</a><a href="#h1-0-58" id="h1-0-58" class="i">+){
</a>     @Composable
     fun TopBar() {
<a href="#h1-0-61" id="h1-0-61" class="d">-        val navBackStackEntry by navHostController.currentBackStackEntryAsState()
</a><a href="#h1-0-62" id="h1-0-62" class="d">-        val currentDestination = navBackStackEntry?.destination ?: return
</a><a href="#h1-0-63" id="h1-0-63" class="d">-        val currentSection = getCurrentSection(currentDestination)
</a><a href="#h1-0-64" id="h1-0-64" class="i">+        val navBackStackEntry by navController.currentBackStackEntryAsState()
</a><a href="#h1-0-65" id="h1-0-65" class="i">+
</a><a href="#h1-0-66" id="h1-0-66" class="i">+        val canGoBack = remember (navBackStackEntry) { routes.getCurrentRoute(navBackStackEntry)?.let {
</a><a href="#h1-0-67" id="h1-0-67" class="i">+            !it.routeInfo.primary || it.routeInfo.childIds.contains(routes.currentDestination)
</a><a href="#h1-0-68" id="h1-0-68" class="i">+        } == true }
</a> 
         TopAppBar(title = {
<a href="#h1-0-71" id="h1-0-71" class="d">-            currentSection.Title()
</a><a href="#h1-0-72" id="h1-0-72" class="i">+            routes.getCurrentRoute(navBackStackEntry)?.title?.invoke() ?: Text(text = routes.getCurrentRoute(navBackStackEntry)?.routeInfo?.translatedKey ?: &quot;Unknown Page&quot;)
</a>         }, navigationIcon =  {
<a href="#h1-0-74" id="h1-0-74" class="d">-            val backButtonAnimation by animateFloatAsState(if (currentSection.canGoBack()) 1f else 0f,
</a><a href="#h1-0-75" id="h1-0-75" class="i">+            val backButtonAnimation by animateFloatAsState(if (canGoBack) 1f else 0f,
</a>                 label = &quot;backButtonAnimation&quot;
             )
 
<a href="#h1-1" id="h1-1" class="h">@@ -78,64 +54,87 @@ class Navigation(
</a>                     .height(48.dp)
             ) {
                 IconButton(
<a href="#h1-1-3" id="h1-1-3" class="d">-                    onClick = { navHostController.popBackStack() }
</a><a href="#h1-1-4" id="h1-1-4" class="i">+                    onClick = {
</a><a href="#h1-1-5" id="h1-1-5" class="i">+                        if (canGoBack) {
</a><a href="#h1-1-6" id="h1-1-6" class="i">+                            navController.popBackStack()
</a><a href="#h1-1-7" id="h1-1-7" class="i">+                        }
</a><a href="#h1-1-8" id="h1-1-8" class="i">+                    }
</a>                 ) {
                     Icon(Icons.Filled.ArrowBack, contentDescription = null)
                 }
             }
         }, actions = {
<a href="#h1-1-14" id="h1-1-14" class="d">-            currentSection.TopBarActions(this)
</a><a href="#h1-1-15" id="h1-1-15" class="i">+            routes.getCurrentRoute(navBackStackEntry)?.topBarActions?.invoke(this)
</a>         })
     }
 
     @Composable
<a href="#h1-1-20" id="h1-1-20" class="d">-    fun Fab() {
</a><a href="#h1-1-21" id="h1-1-21" class="d">-        val navBackStackEntry by navHostController.currentBackStackEntryAsState()
</a><a href="#h1-1-22" id="h1-1-22" class="d">-        val currentDestination = navBackStackEntry?.destination ?: return
</a><a href="#h1-1-23" id="h1-1-23" class="d">-        val currentSection = getCurrentSection(currentDestination)
</a><a href="#h1-1-24" id="h1-1-24" class="i">+    fun BottomBar() {
</a><a href="#h1-1-25" id="h1-1-25" class="i">+        val navBackStackEntry by navController.currentBackStackEntryAsState()
</a><a href="#h1-1-26" id="h1-1-26" class="i">+        val primaryRoutes = remember { routes.getRoutes().filter { it.routeInfo.primary } }
</a> 
<a href="#h1-1-28" id="h1-1-28" class="d">-        currentSection.FloatingActionButton()
</a><a href="#h1-1-29" id="h1-1-29" class="d">-    }
</a><a href="#h1-1-30" id="h1-1-30" class="d">-
</a><a href="#h1-1-31" id="h1-1-31" class="d">-    @Composable
</a><a href="#h1-1-32" id="h1-1-32" class="d">-    fun NavBar() {
</a>         NavigationBar {
<a href="#h1-1-34" id="h1-1-34" class="d">-            val navBackStackEntry by navHostController.currentBackStackEntryAsState()
</a><a href="#h1-1-35" id="h1-1-35" class="d">-            val currentDestination = navBackStackEntry?.destination
</a><a href="#h1-1-36" id="h1-1-36" class="d">-            sections.keys.forEach { section -&gt;
</a><a href="#h1-1-37" id="h1-1-37" class="d">-                fun selected() = currentDestination?.hierarchy?.any { it.route == section.route } == true
</a><a href="#h1-1-38" id="h1-1-38" class="d">-
</a><a href="#h1-1-39" id="h1-1-39" class="i">+            val currentRoute = routes.getCurrentRoute(navBackStackEntry)
</a><a href="#h1-1-40" id="h1-1-40" class="i">+            primaryRoutes.forEach { route -&gt;
</a>                 NavigationBarItem(
                     alwaysShowLabel = false,
<a href="#h1-1-43" id="h1-1-43" class="d">-                    modifier = Modifier
</a><a href="#h1-1-44" id="h1-1-44" class="d">-                        .fillMaxHeight(),
</a><a href="#h1-1-45" id="h1-1-45" class="i">+                    modifier = Modifier.fillMaxHeight(),
</a>                     icon = {
<a href="#h1-1-47" id="h1-1-47" class="d">-                        Icon(
</a><a href="#h1-1-48" id="h1-1-48" class="d">-                            imageVector = section.icon,
</a><a href="#h1-1-49" id="h1-1-49" class="d">-                            contentDescription = null
</a><a href="#h1-1-50" id="h1-1-50" class="d">-                        )
</a><a href="#h1-1-51" id="h1-1-51" class="i">+                        Icon(imageVector = route.routeInfo.icon, contentDescription = null)
</a>                     },
<a href="#h1-1-53" id="h1-1-53" class="d">-
</a>                     label = {
                         Text(
                             textAlign = TextAlign.Center,
                             softWrap = false,
                             fontSize = 12.sp,
                             modifier = Modifier.wrapContentWidth(unbounded = true),
<a href="#h1-1-60" id="h1-1-60" class="d">-                            text = if (selected()) context.translation[&quot;manager.routes.${section.route}&quot;] else &quot;&quot;,
</a><a href="#h1-1-61" id="h1-1-61" class="i">+                            text = if (currentRoute == route) context.translation[&quot;manager.routes.${route.routeInfo.key.substringBefore(&quot;/&quot;)}&quot;] else &quot;&quot;,
</a>                         )
                     },
<a href="#h1-1-64" id="h1-1-64" class="d">-                    selected = selected(),
</a><a href="#h1-1-65" id="h1-1-65" class="i">+                    selected = currentRoute == route,
</a>                     onClick = {
<a href="#h1-1-67" id="h1-1-67" class="d">-                        navHostController.navigate(section.route) {
</a><a href="#h1-1-68" id="h1-1-68" class="d">-                            popUpTo(navHostController.graph.findStartDestination().id) {
</a><a href="#h1-1-69" id="h1-1-69" class="d">-                                saveState = true
</a><a href="#h1-1-70" id="h1-1-70" class="i">+                        route.navigateReset()
</a><a href="#h1-1-71" id="h1-1-71" class="i">+                    }
</a><a href="#h1-1-72" id="h1-1-72" class="i">+                )
</a><a href="#h1-1-73" id="h1-1-73" class="i">+            }
</a><a href="#h1-1-74" id="h1-1-74" class="i">+        }
</a><a href="#h1-1-75" id="h1-1-75" class="i">+    }
</a><a href="#h1-1-76" id="h1-1-76" class="i">+
</a><a href="#h1-1-77" id="h1-1-77" class="i">+    @Composable
</a><a href="#h1-1-78" id="h1-1-78" class="i">+    fun FloatingActionButton() {
</a><a href="#h1-1-79" id="h1-1-79" class="i">+        val navBackStackEntry by navController.currentBackStackEntryAsState()
</a><a href="#h1-1-80" id="h1-1-80" class="i">+        routes.getCurrentRoute(navBackStackEntry)?.floatingActionButton?.invoke()
</a><a href="#h1-1-81" id="h1-1-81" class="i">+    }
</a><a href="#h1-1-82" id="h1-1-82" class="i">+
</a><a href="#h1-1-83" id="h1-1-83" class="i">+    @Composable
</a><a href="#h1-1-84" id="h1-1-84" class="i">+    fun Content(paddingValues: PaddingValues, startDestination: String) {
</a><a href="#h1-1-85" id="h1-1-85" class="i">+        NavHost(
</a><a href="#h1-1-86" id="h1-1-86" class="i">+            navController = navController,
</a><a href="#h1-1-87" id="h1-1-87" class="i">+            startDestination = startDestination,
</a><a href="#h1-1-88" id="h1-1-88" class="i">+            Modifier.padding(paddingValues),
</a><a href="#h1-1-89" id="h1-1-89" class="i">+            enterTransition = { fadeIn(tween(100)) },
</a><a href="#h1-1-90" id="h1-1-90" class="i">+            exitTransition = { fadeOut(tween(100)) }
</a><a href="#h1-1-91" id="h1-1-91" class="i">+        ) {
</a><a href="#h1-1-92" id="h1-1-92" class="i">+            routes.getRoutes().filter { it.parentRoute == null }.forEach { route -&gt;
</a><a href="#h1-1-93" id="h1-1-93" class="i">+                val children = routes.getRoutes().filter { it.parentRoute == route }
</a><a href="#h1-1-94" id="h1-1-94" class="i">+                if (children.isEmpty()) {
</a><a href="#h1-1-95" id="h1-1-95" class="i">+                    composable(route.routeInfo.id) {
</a><a href="#h1-1-96" id="h1-1-96" class="i">+                        route.content.invoke(it)
</a><a href="#h1-1-97" id="h1-1-97" class="i">+                    }
</a><a href="#h1-1-98" id="h1-1-98" class="i">+                    route.customComposables.invoke(this)
</a><a href="#h1-1-99" id="h1-1-99" class="i">+                } else {
</a><a href="#h1-1-100" id="h1-1-100" class="i">+                    navigation(&quot;main_&quot; + route.routeInfo.id, route.routeInfo.id) {
</a><a href="#h1-1-101" id="h1-1-101" class="i">+                        composable(&quot;main_&quot; + route.routeInfo.id) {
</a><a href="#h1-1-102" id="h1-1-102" class="i">+                            route.content.invoke(it)
</a><a href="#h1-1-103" id="h1-1-103" class="i">+                        }
</a><a href="#h1-1-104" id="h1-1-104" class="i">+                        children.forEach { child -&gt;
</a><a href="#h1-1-105" id="h1-1-105" class="i">+                            composable(child.routeInfo.id) {
</a><a href="#h1-1-106" id="h1-1-106" class="i">+                                child.content.invoke(it)
</a>                             }
<a href="#h1-1-108" id="h1-1-108" class="d">-                            launchSingleTop = true
</a><a href="#h1-1-109" id="h1-1-109" class="d">-                            restoreState = true
</a>                         }
<a href="#h1-1-111" id="h1-1-111" class="i">+                        route.customComposables.invoke(this)
</a>                     }
<a href="#h1-1-113" id="h1-1-113" class="d">-                )
</a><a href="#h1-1-114" id="h1-1-114" class="i">+                }
</a>             }
         }
     }
<b>diff --git a/<a id="h2" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/Routes.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/Routes.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/Routes.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/Routes.kt</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -0,0 +1,134 @@
</a><a href="#h2-0-0" id="h2-0-0" class="i">+package me.rhunk.snapenhance.ui.manager
</a><a href="#h2-0-1" id="h2-0-1" class="i">+
</a><a href="#h2-0-2" id="h2-0-2" class="i">+import androidx.compose.foundation.layout.RowScope
</a><a href="#h2-0-3" id="h2-0-3" class="i">+import androidx.compose.material.icons.Icons
</a><a href="#h2-0-4" id="h2-0-4" class="i">+import androidx.compose.material.icons.filled.DataObject
</a><a href="#h2-0-5" id="h2-0-5" class="i">+import androidx.compose.material.icons.filled.Group
</a><a href="#h2-0-6" id="h2-0-6" class="i">+import androidx.compose.material.icons.filled.Home
</a><a href="#h2-0-7" id="h2-0-7" class="i">+import androidx.compose.material.icons.filled.Stars
</a><a href="#h2-0-8" id="h2-0-8" class="i">+import androidx.compose.material.icons.filled.TaskAlt
</a><a href="#h2-0-9" id="h2-0-9" class="i">+import androidx.compose.runtime.Composable
</a><a href="#h2-0-10" id="h2-0-10" class="i">+import androidx.compose.ui.graphics.vector.ImageVector
</a><a href="#h2-0-11" id="h2-0-11" class="i">+import androidx.navigation.NavBackStackEntry
</a><a href="#h2-0-12" id="h2-0-12" class="i">+import androidx.navigation.NavController
</a><a href="#h2-0-13" id="h2-0-13" class="i">+import androidx.navigation.NavDestination.Companion.hierarchy
</a><a href="#h2-0-14" id="h2-0-14" class="i">+import androidx.navigation.NavGraph.Companion.findStartDestination
</a><a href="#h2-0-15" id="h2-0-15" class="i">+import androidx.navigation.NavGraphBuilder
</a><a href="#h2-0-16" id="h2-0-16" class="i">+import me.rhunk.snapenhance.RemoteSideContext
</a><a href="#h2-0-17" id="h2-0-17" class="i">+import me.rhunk.snapenhance.ui.manager.pages.TasksRoot
</a><a href="#h2-0-18" id="h2-0-18" class="i">+import me.rhunk.snapenhance.ui.manager.pages.features.FeaturesRoot
</a><a href="#h2-0-19" id="h2-0-19" class="i">+import me.rhunk.snapenhance.ui.manager.pages.home.HomeLogs
</a><a href="#h2-0-20" id="h2-0-20" class="i">+import me.rhunk.snapenhance.ui.manager.pages.home.HomeRoot
</a><a href="#h2-0-21" id="h2-0-21" class="i">+import me.rhunk.snapenhance.ui.manager.pages.home.HomeSettings
</a><a href="#h2-0-22" id="h2-0-22" class="i">+import me.rhunk.snapenhance.ui.manager.pages.scripting.ScriptingRoot
</a><a href="#h2-0-23" id="h2-0-23" class="i">+import me.rhunk.snapenhance.ui.manager.pages.social.LoggedStories
</a><a href="#h2-0-24" id="h2-0-24" class="i">+import me.rhunk.snapenhance.ui.manager.pages.social.ManageScope
</a><a href="#h2-0-25" id="h2-0-25" class="i">+import me.rhunk.snapenhance.ui.manager.pages.social.MessagingPreview
</a><a href="#h2-0-26" id="h2-0-26" class="i">+import me.rhunk.snapenhance.ui.manager.pages.social.SocialRoot
</a><a href="#h2-0-27" id="h2-0-27" class="i">+
</a><a href="#h2-0-28" id="h2-0-28" class="i">+
</a><a href="#h2-0-29" id="h2-0-29" class="i">+data class RouteInfo(
</a><a href="#h2-0-30" id="h2-0-30" class="i">+    val id: String,
</a><a href="#h2-0-31" id="h2-0-31" class="i">+    val key: String = id,
</a><a href="#h2-0-32" id="h2-0-32" class="i">+    val icon: ImageVector = Icons.Default.Home,
</a><a href="#h2-0-33" id="h2-0-33" class="i">+    val primary: Boolean = false,
</a><a href="#h2-0-34" id="h2-0-34" class="i">+) {
</a><a href="#h2-0-35" id="h2-0-35" class="i">+    var translatedKey: String? = null
</a><a href="#h2-0-36" id="h2-0-36" class="i">+    val childIds = mutableListOf&lt;String&gt;()
</a><a href="#h2-0-37" id="h2-0-37" class="i">+}
</a><a href="#h2-0-38" id="h2-0-38" class="i">+
</a><a href="#h2-0-39" id="h2-0-39" class="i">+@Suppress(&quot;unused&quot;, &quot;MemberVisibilityCanBePrivate&quot;)
</a><a href="#h2-0-40" id="h2-0-40" class="i">+class Routes(
</a><a href="#h2-0-41" id="h2-0-41" class="i">+    private val context: RemoteSideContext,
</a><a href="#h2-0-42" id="h2-0-42" class="i">+) {
</a><a href="#h2-0-43" id="h2-0-43" class="i">+    lateinit var navController: NavController
</a><a href="#h2-0-44" id="h2-0-44" class="i">+    private val routes = mutableListOf&lt;Route&gt;()
</a><a href="#h2-0-45" id="h2-0-45" class="i">+
</a><a href="#h2-0-46" id="h2-0-46" class="i">+    val tasks = route(RouteInfo(&quot;tasks&quot;, icon = Icons.Default.TaskAlt, primary = true), TasksRoot())
</a><a href="#h2-0-47" id="h2-0-47" class="i">+
</a><a href="#h2-0-48" id="h2-0-48" class="i">+    val features = route(RouteInfo(&quot;features&quot;, icon = Icons.Default.Stars, primary = true), FeaturesRoot())
</a><a href="#h2-0-49" id="h2-0-49" class="i">+
</a><a href="#h2-0-50" id="h2-0-50" class="i">+    val home = route(RouteInfo(&quot;home&quot;, icon = Icons.Default.Home, primary = true), HomeRoot())
</a><a href="#h2-0-51" id="h2-0-51" class="i">+    val settings = route(RouteInfo(&quot;home_settings&quot;), HomeSettings()).parent(home)
</a><a href="#h2-0-52" id="h2-0-52" class="i">+    val homeLogs = route(RouteInfo(&quot;home_logs&quot;), HomeLogs()).parent(home)
</a><a href="#h2-0-53" id="h2-0-53" class="i">+
</a><a href="#h2-0-54" id="h2-0-54" class="i">+    val social = route(RouteInfo(&quot;social&quot;, icon = Icons.Default.Group, primary = true), SocialRoot())
</a><a href="#h2-0-55" id="h2-0-55" class="i">+    val manageScope = route(RouteInfo(&quot;manage_scope/?scope={scope}&amp;id={id}&quot;), ManageScope()).parent(social)
</a><a href="#h2-0-56" id="h2-0-56" class="i">+    val messagingPreview = route(RouteInfo(&quot;messaging_preview/?scope={scope}&amp;id={id}&quot;), MessagingPreview()).parent(social)
</a><a href="#h2-0-57" id="h2-0-57" class="i">+    val loggedStories = route(RouteInfo(&quot;logged_stories/?id={id}&quot;), LoggedStories()).parent(social)
</a><a href="#h2-0-58" id="h2-0-58" class="i">+
</a><a href="#h2-0-59" id="h2-0-59" class="i">+    val scripting = route(RouteInfo(&quot;scripts&quot;, icon = Icons.Filled.DataObject, primary = true), ScriptingRoot())
</a><a href="#h2-0-60" id="h2-0-60" class="i">+
</a><a href="#h2-0-61" id="h2-0-61" class="i">+    open class Route {
</a><a href="#h2-0-62" id="h2-0-62" class="i">+        open val init: () -&gt; Unit = { }
</a><a href="#h2-0-63" id="h2-0-63" class="i">+        open val title: @Composable (() -&gt; Unit)? = null
</a><a href="#h2-0-64" id="h2-0-64" class="i">+        open val topBarActions: @Composable RowScope.() -&gt; Unit = {}
</a><a href="#h2-0-65" id="h2-0-65" class="i">+        open val floatingActionButton: @Composable () -&gt; Unit = {}
</a><a href="#h2-0-66" id="h2-0-66" class="i">+        open val content: @Composable (NavBackStackEntry) -&gt; Unit = {}
</a><a href="#h2-0-67" id="h2-0-67" class="i">+        open val customComposables: NavGraphBuilder.() -&gt; Unit = {}
</a><a href="#h2-0-68" id="h2-0-68" class="i">+
</a><a href="#h2-0-69" id="h2-0-69" class="i">+        var parentRoute: Route? = null
</a><a href="#h2-0-70" id="h2-0-70" class="i">+            private set
</a><a href="#h2-0-71" id="h2-0-71" class="i">+
</a><a href="#h2-0-72" id="h2-0-72" class="i">+        lateinit var context: RemoteSideContext
</a><a href="#h2-0-73" id="h2-0-73" class="i">+        lateinit var routeInfo: RouteInfo
</a><a href="#h2-0-74" id="h2-0-74" class="i">+        lateinit var routes: Routes
</a><a href="#h2-0-75" id="h2-0-75" class="i">+
</a><a href="#h2-0-76" id="h2-0-76" class="i">+        private fun replaceArguments(id: String, args: Map&lt;String, String&gt;) = args.takeIf { it.isNotEmpty() }?.let {
</a><a href="#h2-0-77" id="h2-0-77" class="i">+            args.entries.fold(id) { acc, (key, value) -&gt;
</a><a href="#h2-0-78" id="h2-0-78" class="i">+                acc.replace(&quot;{$key}&quot;, value)
</a><a href="#h2-0-79" id="h2-0-79" class="i">+            }
</a><a href="#h2-0-80" id="h2-0-80" class="i">+        } ?: id
</a><a href="#h2-0-81" id="h2-0-81" class="i">+
</a><a href="#h2-0-82" id="h2-0-82" class="i">+        fun navigate(args: MutableMap&lt;String, String&gt;.() -&gt; Unit = {}) {
</a><a href="#h2-0-83" id="h2-0-83" class="i">+            routes.navController.navigate(replaceArguments(routeInfo.id, HashMap&lt;String, String&gt;().apply { args() }))
</a><a href="#h2-0-84" id="h2-0-84" class="i">+        }
</a><a href="#h2-0-85" id="h2-0-85" class="i">+
</a><a href="#h2-0-86" id="h2-0-86" class="i">+        fun navigateReset(args: MutableMap&lt;String, String&gt;.() -&gt; Unit = {}) {
</a><a href="#h2-0-87" id="h2-0-87" class="i">+            routes.navController.navigate(replaceArguments(routeInfo.id, HashMap&lt;String, String&gt;().apply { args() })) {
</a><a href="#h2-0-88" id="h2-0-88" class="i">+                popUpTo(routes.navController.graph.findStartDestination().id) {
</a><a href="#h2-0-89" id="h2-0-89" class="i">+                    saveState = true
</a><a href="#h2-0-90" id="h2-0-90" class="i">+                }
</a><a href="#h2-0-91" id="h2-0-91" class="i">+                launchSingleTop = true
</a><a href="#h2-0-92" id="h2-0-92" class="i">+                restoreState = true
</a><a href="#h2-0-93" id="h2-0-93" class="i">+            }
</a><a href="#h2-0-94" id="h2-0-94" class="i">+        }
</a><a href="#h2-0-95" id="h2-0-95" class="i">+
</a><a href="#h2-0-96" id="h2-0-96" class="i">+        fun parent(route: Route): Route {
</a><a href="#h2-0-97" id="h2-0-97" class="i">+            assert(route.routeInfo.primary) { &quot;Parent route must be a primary route&quot; }
</a><a href="#h2-0-98" id="h2-0-98" class="i">+            parentRoute = route
</a><a href="#h2-0-99" id="h2-0-99" class="i">+            return this
</a><a href="#h2-0-100" id="h2-0-100" class="i">+        }
</a><a href="#h2-0-101" id="h2-0-101" class="i">+    }
</a><a href="#h2-0-102" id="h2-0-102" class="i">+
</a><a href="#h2-0-103" id="h2-0-103" class="i">+    val currentRoute: Route?
</a><a href="#h2-0-104" id="h2-0-104" class="i">+        get() = routes.firstOrNull { route -&gt;
</a><a href="#h2-0-105" id="h2-0-105" class="i">+            navController.currentBackStackEntry?.destination?.hierarchy?.any { it.route == route.routeInfo.id } ?: false
</a><a href="#h2-0-106" id="h2-0-106" class="i">+        }
</a><a href="#h2-0-107" id="h2-0-107" class="i">+
</a><a href="#h2-0-108" id="h2-0-108" class="i">+    val currentDestination: String?
</a><a href="#h2-0-109" id="h2-0-109" class="i">+        get() = navController.currentBackStackEntry?.destination?.route
</a><a href="#h2-0-110" id="h2-0-110" class="i">+
</a><a href="#h2-0-111" id="h2-0-111" class="i">+    fun getCurrentRoute(navBackStackEntry: NavBackStackEntry?): Route? {
</a><a href="#h2-0-112" id="h2-0-112" class="i">+        if (navBackStackEntry == null) return null
</a><a href="#h2-0-113" id="h2-0-113" class="i">+
</a><a href="#h2-0-114" id="h2-0-114" class="i">+        return navBackStackEntry.destination.hierarchy.firstNotNullOfOrNull { destination -&gt;
</a><a href="#h2-0-115" id="h2-0-115" class="i">+            routes.firstOrNull { route -&gt;
</a><a href="#h2-0-116" id="h2-0-116" class="i">+                route.routeInfo.id == destination.route || route.routeInfo.childIds.contains(destination.route)
</a><a href="#h2-0-117" id="h2-0-117" class="i">+            }
</a><a href="#h2-0-118" id="h2-0-118" class="i">+        }
</a><a href="#h2-0-119" id="h2-0-119" class="i">+    }
</a><a href="#h2-0-120" id="h2-0-120" class="i">+
</a><a href="#h2-0-121" id="h2-0-121" class="i">+    fun getRoutes(): List&lt;Route&gt; = routes
</a><a href="#h2-0-122" id="h2-0-122" class="i">+
</a><a href="#h2-0-123" id="h2-0-123" class="i">+    private fun route(routeInfo: RouteInfo, route: Route): Route {
</a><a href="#h2-0-124" id="h2-0-124" class="i">+        route.apply {
</a><a href="#h2-0-125" id="h2-0-125" class="i">+            this.routeInfo = routeInfo
</a><a href="#h2-0-126" id="h2-0-126" class="i">+            routes = this@Routes
</a><a href="#h2-0-127" id="h2-0-127" class="i">+            context = this@Routes.context
</a><a href="#h2-0-128" id="h2-0-128" class="i">+            this.routeInfo.translatedKey = context.translation.getOrNull(&quot;manager.routes.${route.routeInfo.key.substringBefore(&quot;/&quot;)}&quot;)
</a><a href="#h2-0-129" id="h2-0-129" class="i">+        }
</a><a href="#h2-0-130" id="h2-0-130" class="i">+        routes.add(route)
</a><a href="#h2-0-131" id="h2-0-131" class="i">+        return route
</a><a href="#h2-0-132" id="h2-0-132" class="i">+    }
</a><a href="#h2-0-133" id="h2-0-133" class="i">+}</a><a href="#h2-0-134" id="h2-0-134" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h3" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/Section.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/Section.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/Section.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/Section.kt</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -1,91 +0,0 @@
</a><a href="#h3-0-0" id="h3-0-0" class="d">-package me.rhunk.snapenhance.ui.manager
</a><a href="#h3-0-1" id="h3-0-1" class="d">-
</a><a href="#h3-0-2" id="h3-0-2" class="d">-import androidx.compose.foundation.layout.RowScope
</a><a href="#h3-0-3" id="h3-0-3" class="d">-import androidx.compose.material.icons.Icons
</a><a href="#h3-0-4" id="h3-0-4" class="d">-import androidx.compose.material.icons.filled.*
</a><a href="#h3-0-5" id="h3-0-5" class="d">-import androidx.compose.material3.Text
</a><a href="#h3-0-6" id="h3-0-6" class="d">-import androidx.compose.runtime.Composable
</a><a href="#h3-0-7" id="h3-0-7" class="d">-import androidx.compose.ui.graphics.vector.ImageVector
</a><a href="#h3-0-8" id="h3-0-8" class="d">-import androidx.navigation.NavController
</a><a href="#h3-0-9" id="h3-0-9" class="d">-import androidx.navigation.NavGraphBuilder
</a><a href="#h3-0-10" id="h3-0-10" class="d">-import androidx.navigation.compose.composable
</a><a href="#h3-0-11" id="h3-0-11" class="d">-import me.rhunk.snapenhance.RemoteSideContext
</a><a href="#h3-0-12" id="h3-0-12" class="d">-import me.rhunk.snapenhance.ui.manager.sections.NotImplemented
</a><a href="#h3-0-13" id="h3-0-13" class="d">-import me.rhunk.snapenhance.ui.manager.sections.TasksSection
</a><a href="#h3-0-14" id="h3-0-14" class="d">-import me.rhunk.snapenhance.ui.manager.sections.features.FeaturesSection
</a><a href="#h3-0-15" id="h3-0-15" class="d">-import me.rhunk.snapenhance.ui.manager.sections.home.HomeSection
</a><a href="#h3-0-16" id="h3-0-16" class="d">-import me.rhunk.snapenhance.ui.manager.sections.scripting.ScriptsSection
</a><a href="#h3-0-17" id="h3-0-17" class="d">-import me.rhunk.snapenhance.ui.manager.sections.social.SocialSection
</a><a href="#h3-0-18" id="h3-0-18" class="d">-import kotlin.reflect.KClass
</a><a href="#h3-0-19" id="h3-0-19" class="d">-
</a><a href="#h3-0-20" id="h3-0-20" class="d">-enum class EnumSection(
</a><a href="#h3-0-21" id="h3-0-21" class="d">-    val route: String,
</a><a href="#h3-0-22" id="h3-0-22" class="d">-    val icon: ImageVector,
</a><a href="#h3-0-23" id="h3-0-23" class="d">-    val section: KClass&lt;out Section&gt; = NotImplemented::class
</a><a href="#h3-0-24" id="h3-0-24" class="d">-) {
</a><a href="#h3-0-25" id="h3-0-25" class="d">-    TASKS(
</a><a href="#h3-0-26" id="h3-0-26" class="d">-        route = &quot;tasks&quot;,
</a><a href="#h3-0-27" id="h3-0-27" class="d">-        icon = Icons.Filled.TaskAlt,
</a><a href="#h3-0-28" id="h3-0-28" class="d">-        section = TasksSection::class
</a><a href="#h3-0-29" id="h3-0-29" class="d">-    ),
</a><a href="#h3-0-30" id="h3-0-30" class="d">-    FEATURES(
</a><a href="#h3-0-31" id="h3-0-31" class="d">-        route = &quot;features&quot;,
</a><a href="#h3-0-32" id="h3-0-32" class="d">-        icon = Icons.Filled.Stars,
</a><a href="#h3-0-33" id="h3-0-33" class="d">-        section = FeaturesSection::class
</a><a href="#h3-0-34" id="h3-0-34" class="d">-    ),
</a><a href="#h3-0-35" id="h3-0-35" class="d">-    HOME(
</a><a href="#h3-0-36" id="h3-0-36" class="d">-        route = &quot;home&quot;,
</a><a href="#h3-0-37" id="h3-0-37" class="d">-        icon = Icons.Filled.Home,
</a><a href="#h3-0-38" id="h3-0-38" class="d">-        section = HomeSection::class
</a><a href="#h3-0-39" id="h3-0-39" class="d">-    ),
</a><a href="#h3-0-40" id="h3-0-40" class="d">-    SOCIAL(
</a><a href="#h3-0-41" id="h3-0-41" class="d">-        route = &quot;social&quot;,
</a><a href="#h3-0-42" id="h3-0-42" class="d">-        icon = Icons.Filled.Group,
</a><a href="#h3-0-43" id="h3-0-43" class="d">-        section = SocialSection::class
</a><a href="#h3-0-44" id="h3-0-44" class="d">-    ),
</a><a href="#h3-0-45" id="h3-0-45" class="d">-    SCRIPTS(
</a><a href="#h3-0-46" id="h3-0-46" class="d">-        route = &quot;scripts&quot;,
</a><a href="#h3-0-47" id="h3-0-47" class="d">-        icon = Icons.Filled.DataObject,
</a><a href="#h3-0-48" id="h3-0-48" class="d">-        section = ScriptsSection::class
</a><a href="#h3-0-49" id="h3-0-49" class="d">-    );
</a><a href="#h3-0-50" id="h3-0-50" class="d">-
</a><a href="#h3-0-51" id="h3-0-51" class="d">-    companion object {
</a><a href="#h3-0-52" id="h3-0-52" class="d">-        fun fromRoute(route: String): EnumSection {
</a><a href="#h3-0-53" id="h3-0-53" class="d">-            return entries.first { it.route == route }
</a><a href="#h3-0-54" id="h3-0-54" class="d">-        }
</a><a href="#h3-0-55" id="h3-0-55" class="d">-    }
</a><a href="#h3-0-56" id="h3-0-56" class="d">-}
</a><a href="#h3-0-57" id="h3-0-57" class="d">-
</a><a href="#h3-0-58" id="h3-0-58" class="d">-
</a><a href="#h3-0-59" id="h3-0-59" class="d">-
</a><a href="#h3-0-60" id="h3-0-60" class="d">-open class Section {
</a><a href="#h3-0-61" id="h3-0-61" class="d">-    lateinit var enumSection: EnumSection
</a><a href="#h3-0-62" id="h3-0-62" class="d">-    lateinit var context: RemoteSideContext
</a><a href="#h3-0-63" id="h3-0-63" class="d">-    lateinit var navController: NavController
</a><a href="#h3-0-64" id="h3-0-64" class="d">-
</a><a href="#h3-0-65" id="h3-0-65" class="d">-    val currentRoute get() = navController.currentBackStackEntry?.destination?.route
</a><a href="#h3-0-66" id="h3-0-66" class="d">-
</a><a href="#h3-0-67" id="h3-0-67" class="d">-    open fun init() {}
</a><a href="#h3-0-68" id="h3-0-68" class="d">-    open fun onResumed() {}
</a><a href="#h3-0-69" id="h3-0-69" class="d">-
</a><a href="#h3-0-70" id="h3-0-70" class="d">-    open fun sectionTopBarName(): String = context.translation[&quot;manager.routes.${enumSection.route}&quot;]
</a><a href="#h3-0-71" id="h3-0-71" class="d">-    open fun canGoBack(): Boolean = false
</a><a href="#h3-0-72" id="h3-0-72" class="d">-
</a><a href="#h3-0-73" id="h3-0-73" class="d">-    @Composable
</a><a href="#h3-0-74" id="h3-0-74" class="d">-    open fun Title() { Text(text = sectionTopBarName()) }
</a><a href="#h3-0-75" id="h3-0-75" class="d">-
</a><a href="#h3-0-76" id="h3-0-76" class="d">-    @Composable
</a><a href="#h3-0-77" id="h3-0-77" class="d">-    open fun Content() { NotImplemented() }
</a><a href="#h3-0-78" id="h3-0-78" class="d">-
</a><a href="#h3-0-79" id="h3-0-79" class="d">-    @Composable
</a><a href="#h3-0-80" id="h3-0-80" class="d">-    open fun TopBarActions(rowScope: RowScope) {}
</a><a href="#h3-0-81" id="h3-0-81" class="d">-
</a><a href="#h3-0-82" id="h3-0-82" class="d">-    @Composable
</a><a href="#h3-0-83" id="h3-0-83" class="d">-    open fun FloatingActionButton() {}
</a><a href="#h3-0-84" id="h3-0-84" class="d">-
</a><a href="#h3-0-85" id="h3-0-85" class="d">-    open fun build(navGraphBuilder: NavGraphBuilder) {
</a><a href="#h3-0-86" id="h3-0-86" class="d">-        navGraphBuilder.composable(enumSection.route) {
</a><a href="#h3-0-87" id="h3-0-87" class="d">-            Content()
</a><a href="#h3-0-88" id="h3-0-88" class="d">-        }
</a><a href="#h3-0-89" id="h3-0-89" class="d">-    }
</a><a href="#h3-0-90" id="h3-0-90" class="d">-}</a><a href="#h3-0-91" id="h3-0-91" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h4" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/TasksRoot.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/TasksRoot.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/TasksRoot.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/TasksRoot.kt</a></b>
<a href="#h4-0" id="h4-0" class="h">@@ -0,0 +1,452 @@
</a><a href="#h4-0-0" id="h4-0-0" class="i">+package me.rhunk.snapenhance.ui.manager.pages
</a><a href="#h4-0-1" id="h4-0-1" class="i">+
</a><a href="#h4-0-2" id="h4-0-2" class="i">+ import android.content.Intent
</a><a href="#h4-0-3" id="h4-0-3" class="i">+import androidx.compose.foundation.border
</a><a href="#h4-0-4" id="h4-0-4" class="i">+import androidx.compose.foundation.clickable
</a><a href="#h4-0-5" id="h4-0-5" class="i">+import androidx.compose.foundation.layout.*
</a><a href="#h4-0-6" id="h4-0-6" class="i">+import androidx.compose.foundation.lazy.LazyColumn
</a><a href="#h4-0-7" id="h4-0-7" class="i">+import androidx.compose.foundation.lazy.items
</a><a href="#h4-0-8" id="h4-0-8" class="i">+import androidx.compose.foundation.lazy.rememberLazyListState
</a><a href="#h4-0-9" id="h4-0-9" class="i">+import androidx.compose.material.icons.Icons
</a><a href="#h4-0-10" id="h4-0-10" class="i">+import androidx.compose.material.icons.filled.*
</a><a href="#h4-0-11" id="h4-0-11" class="i">+import androidx.compose.material3.*
</a><a href="#h4-0-12" id="h4-0-12" class="i">+import androidx.compose.runtime.*
</a><a href="#h4-0-13" id="h4-0-13" class="i">+import androidx.compose.ui.Alignment
</a><a href="#h4-0-14" id="h4-0-14" class="i">+import androidx.compose.ui.Modifier
</a><a href="#h4-0-15" id="h4-0-15" class="i">+import androidx.compose.ui.draw.clip
</a><a href="#h4-0-16" id="h4-0-16" class="i">+import androidx.compose.ui.graphics.StrokeCap
</a><a href="#h4-0-17" id="h4-0-17" class="i">+ import androidx.compose.ui.unit.dp
</a><a href="#h4-0-18" id="h4-0-18" class="i">+import androidx.core.net.toUri
</a><a href="#h4-0-19" id="h4-0-19" class="i">+import androidx.documentfile.provider.DocumentFile
</a><a href="#h4-0-20" id="h4-0-20" class="i">+import androidx.lifecycle.Lifecycle
</a><a href="#h4-0-21" id="h4-0-21" class="i">+ import androidx.navigation.NavBackStackEntry
</a><a href="#h4-0-22" id="h4-0-22" class="i">+ import kotlinx.coroutines.CoroutineScope
</a><a href="#h4-0-23" id="h4-0-23" class="i">+import kotlinx.coroutines.Dispatchers
</a><a href="#h4-0-24" id="h4-0-24" class="i">+import kotlinx.coroutines.launch
</a><a href="#h4-0-25" id="h4-0-25" class="i">+import me.rhunk.snapenhance.bridge.DownloadCallback
</a><a href="#h4-0-26" id="h4-0-26" class="i">+import me.rhunk.snapenhance.common.data.download.DownloadMetadata
</a><a href="#h4-0-27" id="h4-0-27" class="i">+import me.rhunk.snapenhance.common.data.download.MediaDownloadSource
</a><a href="#h4-0-28" id="h4-0-28" class="i">+import me.rhunk.snapenhance.common.data.download.createNewFilePath
</a><a href="#h4-0-29" id="h4-0-29" class="i">+import me.rhunk.snapenhance.common.util.ktx.longHashCode
</a><a href="#h4-0-30" id="h4-0-30" class="i">+import me.rhunk.snapenhance.download.DownloadProcessor
</a><a href="#h4-0-31" id="h4-0-31" class="i">+import me.rhunk.snapenhance.download.FFMpegProcessor
</a><a href="#h4-0-32" id="h4-0-32" class="i">+import me.rhunk.snapenhance.task.PendingTask
</a><a href="#h4-0-33" id="h4-0-33" class="i">+import me.rhunk.snapenhance.task.PendingTaskListener
</a><a href="#h4-0-34" id="h4-0-34" class="i">+import me.rhunk.snapenhance.task.Task
</a><a href="#h4-0-35" id="h4-0-35" class="i">+import me.rhunk.snapenhance.task.TaskStatus
</a><a href="#h4-0-36" id="h4-0-36" class="i">+import me.rhunk.snapenhance.task.TaskType
</a><a href="#h4-0-37" id="h4-0-37" class="i">+ import me.rhunk.snapenhance.ui.manager.Routes
</a><a href="#h4-0-38" id="h4-0-38" class="i">+ import me.rhunk.snapenhance.ui.util.OnLifecycleEvent
</a><a href="#h4-0-39" id="h4-0-39" class="i">+import java.io.File
</a><a href="#h4-0-40" id="h4-0-40" class="i">+import java.util.UUID
</a><a href="#h4-0-41" id="h4-0-41" class="i">+import kotlin.math.absoluteValue
</a><a href="#h4-0-42" id="h4-0-42" class="i">+
</a><a href="#h4-0-43" id="h4-0-43" class="i">+class TasksRoot : Routes.Route() {
</a><a href="#h4-0-44" id="h4-0-44" class="i">+    private var activeTasks by mutableStateOf(listOf&lt;PendingTask&gt;())
</a><a href="#h4-0-45" id="h4-0-45" class="i">+    private lateinit var recentTasks: MutableList&lt;Task&gt;
</a><a href="#h4-0-46" id="h4-0-46" class="i">+    private val taskSelection = mutableStateListOf&lt;Pair&lt;Task, DocumentFile?&gt;&gt;()
</a><a href="#h4-0-47" id="h4-0-47" class="i">+
</a><a href="#h4-0-48" id="h4-0-48" class="i">+    private fun fetchActiveTasks(scope: CoroutineScope = context.coroutineScope) {
</a><a href="#h4-0-49" id="h4-0-49" class="i">+        scope.launch(Dispatchers.IO) {
</a><a href="#h4-0-50" id="h4-0-50" class="i">+            activeTasks = context.taskManager.getActiveTasks().values.sortedByDescending { it.taskId }.toMutableList()
</a><a href="#h4-0-51" id="h4-0-51" class="i">+        }
</a><a href="#h4-0-52" id="h4-0-52" class="i">+    }
</a><a href="#h4-0-53" id="h4-0-53" class="i">+
</a><a href="#h4-0-54" id="h4-0-54" class="i">+    private fun mergeSelection(selection: List&lt;Pair&lt;Task, DocumentFile&gt;&gt;) {
</a><a href="#h4-0-55" id="h4-0-55" class="i">+        val firstTask = selection.first().first
</a><a href="#h4-0-56" id="h4-0-56" class="i">+
</a><a href="#h4-0-57" id="h4-0-57" class="i">+        val taskHash = UUID.randomUUID().toString().longHashCode().absoluteValue.toString(16)
</a><a href="#h4-0-58" id="h4-0-58" class="i">+        val pendingTask = context.taskManager.createPendingTask(
</a><a href="#h4-0-59" id="h4-0-59" class="i">+            Task(TaskType.DOWNLOAD, &quot;Merge ${selection.size} files&quot;, firstTask.author, taskHash)
</a><a href="#h4-0-60" id="h4-0-60" class="i">+        )
</a><a href="#h4-0-61" id="h4-0-61" class="i">+        pendingTask.status = TaskStatus.RUNNING
</a><a href="#h4-0-62" id="h4-0-62" class="i">+        fetchActiveTasks()
</a><a href="#h4-0-63" id="h4-0-63" class="i">+
</a><a href="#h4-0-64" id="h4-0-64" class="i">+        context.coroutineScope.launch {
</a><a href="#h4-0-65" id="h4-0-65" class="i">+            val filesToMerge = mutableListOf&lt;File&gt;()
</a><a href="#h4-0-66" id="h4-0-66" class="i">+
</a><a href="#h4-0-67" id="h4-0-67" class="i">+            selection.forEach { (task, documentFile) -&gt;
</a><a href="#h4-0-68" id="h4-0-68" class="i">+                val tempFile = File.createTempFile(task.hash, &quot;.&quot; + documentFile.name?.substringAfterLast(&quot;.&quot;), context.androidContext.cacheDir).also {
</a><a href="#h4-0-69" id="h4-0-69" class="i">+                    it.deleteOnExit()
</a><a href="#h4-0-70" id="h4-0-70" class="i">+                }
</a><a href="#h4-0-71" id="h4-0-71" class="i">+
</a><a href="#h4-0-72" id="h4-0-72" class="i">+                runCatching {
</a><a href="#h4-0-73" id="h4-0-73" class="i">+                    pendingTask.updateProgress(&quot;Copying ${documentFile.name}&quot;)
</a><a href="#h4-0-74" id="h4-0-74" class="i">+                    context.androidContext.contentResolver.openInputStream(documentFile.uri)?.use { inputStream -&gt;
</a><a href="#h4-0-75" id="h4-0-75" class="i">+                        //copy with progress
</a><a href="#h4-0-76" id="h4-0-76" class="i">+                        val length = documentFile.length().toFloat()
</a><a href="#h4-0-77" id="h4-0-77" class="i">+                        tempFile.outputStream().use { outputStream -&gt;
</a><a href="#h4-0-78" id="h4-0-78" class="i">+                            val buffer = ByteArray(16 * 1024)
</a><a href="#h4-0-79" id="h4-0-79" class="i">+                            var read: Int
</a><a href="#h4-0-80" id="h4-0-80" class="i">+                            while (inputStream.read(buffer).also { read = it } != -1) {
</a><a href="#h4-0-81" id="h4-0-81" class="i">+                                outputStream.write(buffer, 0, read)
</a><a href="#h4-0-82" id="h4-0-82" class="i">+                                pendingTask.updateProgress(&quot;Copying ${documentFile.name}&quot;, (outputStream.channel.position().toFloat() / length * 100f).toInt())
</a><a href="#h4-0-83" id="h4-0-83" class="i">+                            }
</a><a href="#h4-0-84" id="h4-0-84" class="i">+                            outputStream.flush()
</a><a href="#h4-0-85" id="h4-0-85" class="i">+                            filesToMerge.add(tempFile)
</a><a href="#h4-0-86" id="h4-0-86" class="i">+                        }
</a><a href="#h4-0-87" id="h4-0-87" class="i">+                    }
</a><a href="#h4-0-88" id="h4-0-88" class="i">+                }.onFailure {
</a><a href="#h4-0-89" id="h4-0-89" class="i">+                    pendingTask.fail(&quot;Failed to copy file $documentFile to $tempFile&quot;)
</a><a href="#h4-0-90" id="h4-0-90" class="i">+                    filesToMerge.forEach { it.delete() }
</a><a href="#h4-0-91" id="h4-0-91" class="i">+                    return@launch
</a><a href="#h4-0-92" id="h4-0-92" class="i">+                }
</a><a href="#h4-0-93" id="h4-0-93" class="i">+            }
</a><a href="#h4-0-94" id="h4-0-94" class="i">+
</a><a href="#h4-0-95" id="h4-0-95" class="i">+            val mergedFile = File.createTempFile(&quot;merged&quot;, &quot;.mp4&quot;, context.androidContext.cacheDir).also {
</a><a href="#h4-0-96" id="h4-0-96" class="i">+                it.deleteOnExit()
</a><a href="#h4-0-97" id="h4-0-97" class="i">+            }
</a><a href="#h4-0-98" id="h4-0-98" class="i">+
</a><a href="#h4-0-99" id="h4-0-99" class="i">+            runCatching {
</a><a href="#h4-0-100" id="h4-0-100" class="i">+                context.shortToast(&quot;Merging ${filesToMerge.size} files&quot;)
</a><a href="#h4-0-101" id="h4-0-101" class="i">+                FFMpegProcessor.newFFMpegProcessor(context, pendingTask).execute(
</a><a href="#h4-0-102" id="h4-0-102" class="i">+                    FFMpegProcessor.Request(FFMpegProcessor.Action.MERGE_MEDIA, filesToMerge, mergedFile)
</a><a href="#h4-0-103" id="h4-0-103" class="i">+                )
</a><a href="#h4-0-104" id="h4-0-104" class="i">+                DownloadProcessor(context, object: DownloadCallback.Default() {
</a><a href="#h4-0-105" id="h4-0-105" class="i">+                    override fun onSuccess(outputPath: String) {
</a><a href="#h4-0-106" id="h4-0-106" class="i">+                        context.log.verbose(&quot;Merged files to $outputPath&quot;)
</a><a href="#h4-0-107" id="h4-0-107" class="i">+                    }
</a><a href="#h4-0-108" id="h4-0-108" class="i">+                }).saveMediaToGallery(pendingTask, mergedFile, DownloadMetadata(
</a><a href="#h4-0-109" id="h4-0-109" class="i">+                    mediaIdentifier = taskHash,
</a><a href="#h4-0-110" id="h4-0-110" class="i">+                    outputPath = createNewFilePath(
</a><a href="#h4-0-111" id="h4-0-111" class="i">+                        context.config.root,
</a><a href="#h4-0-112" id="h4-0-112" class="i">+                        taskHash,
</a><a href="#h4-0-113" id="h4-0-113" class="i">+                        downloadSource = MediaDownloadSource.MERGED,
</a><a href="#h4-0-114" id="h4-0-114" class="i">+                        mediaAuthor = firstTask.author,
</a><a href="#h4-0-115" id="h4-0-115" class="i">+                        creationTimestamp = System.currentTimeMillis()
</a><a href="#h4-0-116" id="h4-0-116" class="i">+                    ),
</a><a href="#h4-0-117" id="h4-0-117" class="i">+                    mediaAuthor = firstTask.author,
</a><a href="#h4-0-118" id="h4-0-118" class="i">+                    downloadSource = MediaDownloadSource.MERGED.translate(context.translation),
</a><a href="#h4-0-119" id="h4-0-119" class="i">+                    iconUrl = null
</a><a href="#h4-0-120" id="h4-0-120" class="i">+                ))
</a><a href="#h4-0-121" id="h4-0-121" class="i">+            }.onFailure {
</a><a href="#h4-0-122" id="h4-0-122" class="i">+                context.log.error(&quot;Failed to merge files&quot;, it)
</a><a href="#h4-0-123" id="h4-0-123" class="i">+                pendingTask.fail(it.message ?: &quot;Failed to merge files&quot;)
</a><a href="#h4-0-124" id="h4-0-124" class="i">+            }.onSuccess {
</a><a href="#h4-0-125" id="h4-0-125" class="i">+                pendingTask.success()
</a><a href="#h4-0-126" id="h4-0-126" class="i">+            }
</a><a href="#h4-0-127" id="h4-0-127" class="i">+            filesToMerge.forEach { it.delete() }
</a><a href="#h4-0-128" id="h4-0-128" class="i">+            mergedFile.delete()
</a><a href="#h4-0-129" id="h4-0-129" class="i">+        }.also {
</a><a href="#h4-0-130" id="h4-0-130" class="i">+            pendingTask.addListener(PendingTaskListener(onCancel = { it.cancel() }))
</a><a href="#h4-0-131" id="h4-0-131" class="i">+        }
</a><a href="#h4-0-132" id="h4-0-132" class="i">+    }
</a><a href="#h4-0-133" id="h4-0-133" class="i">+
</a><a href="#h4-0-134" id="h4-0-134" class="i">+    override val topBarActions: @Composable() (RowScope.() -&gt; Unit) = {
</a><a href="#h4-0-135" id="h4-0-135" class="i">+        var showConfirmDialog by remember { mutableStateOf(false) }
</a><a href="#h4-0-136" id="h4-0-136" class="i">+
</a><a href="#h4-0-137" id="h4-0-137" class="i">+        if (taskSelection.size == 1 &amp;&amp; taskSelection.firstOrNull()?.second?.exists() == true) {
</a><a href="#h4-0-138" id="h4-0-138" class="i">+            taskSelection.firstOrNull()?.second?.takeIf { it.exists() }?.let { documentFile -&gt;
</a><a href="#h4-0-139" id="h4-0-139" class="i">+                IconButton(onClick = {
</a><a href="#h4-0-140" id="h4-0-140" class="i">+                    runCatching {
</a><a href="#h4-0-141" id="h4-0-141" class="i">+                        context.androidContext.startActivity(Intent(Intent.ACTION_VIEW).apply {
</a><a href="#h4-0-142" id="h4-0-142" class="i">+                            setDataAndType(documentFile.uri, documentFile.type)
</a><a href="#h4-0-143" id="h4-0-143" class="i">+                            flags = Intent.FLAG_GRANT_READ_URI_PERMISSION or Intent.FLAG_ACTIVITY_NEW_TASK
</a><a href="#h4-0-144" id="h4-0-144" class="i">+                        })
</a><a href="#h4-0-145" id="h4-0-145" class="i">+                        taskSelection.clear()
</a><a href="#h4-0-146" id="h4-0-146" class="i">+                    }.onFailure {
</a><a href="#h4-0-147" id="h4-0-147" class="i">+                        context.log.error(&quot;Failed to open file ${taskSelection.first().second}&quot;, it)
</a><a href="#h4-0-148" id="h4-0-148" class="i">+                    }
</a><a href="#h4-0-149" id="h4-0-149" class="i">+                }) {
</a><a href="#h4-0-150" id="h4-0-150" class="i">+                    Icon(Icons.Filled.OpenInNew, contentDescription = &quot;Open&quot;)
</a><a href="#h4-0-151" id="h4-0-151" class="i">+                }
</a><a href="#h4-0-152" id="h4-0-152" class="i">+            }
</a><a href="#h4-0-153" id="h4-0-153" class="i">+        }
</a><a href="#h4-0-154" id="h4-0-154" class="i">+
</a><a href="#h4-0-155" id="h4-0-155" class="i">+        if (taskSelection.size &gt; 1 &amp;&amp; taskSelection.all { it.second?.type?.contains(&quot;video&quot;) == true }) {
</a><a href="#h4-0-156" id="h4-0-156" class="i">+            IconButton(onClick = {
</a><a href="#h4-0-157" id="h4-0-157" class="i">+                mergeSelection(taskSelection.toList().also {
</a><a href="#h4-0-158" id="h4-0-158" class="i">+                    taskSelection.clear()
</a><a href="#h4-0-159" id="h4-0-159" class="i">+                }.map { it.first to it.second!! })
</a><a href="#h4-0-160" id="h4-0-160" class="i">+            }) {
</a><a href="#h4-0-161" id="h4-0-161" class="i">+                Icon(Icons.Filled.Merge, contentDescription = &quot;Merge&quot;)
</a><a href="#h4-0-162" id="h4-0-162" class="i">+            }
</a><a href="#h4-0-163" id="h4-0-163" class="i">+        }
</a><a href="#h4-0-164" id="h4-0-164" class="i">+
</a><a href="#h4-0-165" id="h4-0-165" class="i">+        IconButton(onClick = {
</a><a href="#h4-0-166" id="h4-0-166" class="i">+            showConfirmDialog = true
</a><a href="#h4-0-167" id="h4-0-167" class="i">+        }) {
</a><a href="#h4-0-168" id="h4-0-168" class="i">+            Icon(Icons.Filled.Delete, contentDescription = &quot;Clear tasks&quot;)
</a><a href="#h4-0-169" id="h4-0-169" class="i">+        }
</a><a href="#h4-0-170" id="h4-0-170" class="i">+
</a><a href="#h4-0-171" id="h4-0-171" class="i">+        if (showConfirmDialog) {
</a><a href="#h4-0-172" id="h4-0-172" class="i">+            var alsoDeleteFiles by remember { mutableStateOf(false) }
</a><a href="#h4-0-173" id="h4-0-173" class="i">+
</a><a href="#h4-0-174" id="h4-0-174" class="i">+            AlertDialog(
</a><a href="#h4-0-175" id="h4-0-175" class="i">+                onDismissRequest = { showConfirmDialog = false },
</a><a href="#h4-0-176" id="h4-0-176" class="i">+                title = {
</a><a href="#h4-0-177" id="h4-0-177" class="i">+                    if (taskSelection.isNotEmpty()) {
</a><a href="#h4-0-178" id="h4-0-178" class="i">+                        Text(&quot;Remove ${taskSelection.size} tasks?&quot;)
</a><a href="#h4-0-179" id="h4-0-179" class="i">+                    } else {
</a><a href="#h4-0-180" id="h4-0-180" class="i">+                        Text(&quot;Remove all tasks?&quot;)
</a><a href="#h4-0-181" id="h4-0-181" class="i">+                    }
</a><a href="#h4-0-182" id="h4-0-182" class="i">+                },
</a><a href="#h4-0-183" id="h4-0-183" class="i">+                text = {
</a><a href="#h4-0-184" id="h4-0-184" class="i">+                    Column {
</a><a href="#h4-0-185" id="h4-0-185" class="i">+                        if (taskSelection.isNotEmpty()) {
</a><a href="#h4-0-186" id="h4-0-186" class="i">+                            Text(&quot;Are you sure you want to remove selected tasks?&quot;)
</a><a href="#h4-0-187" id="h4-0-187" class="i">+                            Row (
</a><a href="#h4-0-188" id="h4-0-188" class="i">+                                modifier = Modifier.padding(top = 10.dp).fillMaxWidth().clickable {
</a><a href="#h4-0-189" id="h4-0-189" class="i">+                                    alsoDeleteFiles = !alsoDeleteFiles
</a><a href="#h4-0-190" id="h4-0-190" class="i">+                                },
</a><a href="#h4-0-191" id="h4-0-191" class="i">+                                horizontalArrangement = Arrangement.spacedBy(5.dp),
</a><a href="#h4-0-192" id="h4-0-192" class="i">+                                verticalAlignment = Alignment.CenterVertically
</a><a href="#h4-0-193" id="h4-0-193" class="i">+                            ) {
</a><a href="#h4-0-194" id="h4-0-194" class="i">+                                Checkbox(checked = alsoDeleteFiles, onCheckedChange = {
</a><a href="#h4-0-195" id="h4-0-195" class="i">+                                    alsoDeleteFiles = it
</a><a href="#h4-0-196" id="h4-0-196" class="i">+                                })
</a><a href="#h4-0-197" id="h4-0-197" class="i">+                                Text(&quot;Also delete files&quot;)
</a><a href="#h4-0-198" id="h4-0-198" class="i">+                            }
</a><a href="#h4-0-199" id="h4-0-199" class="i">+                        } else {
</a><a href="#h4-0-200" id="h4-0-200" class="i">+                            Text(&quot;Are you sure you want to remove all tasks?&quot;)
</a><a href="#h4-0-201" id="h4-0-201" class="i">+                        }
</a><a href="#h4-0-202" id="h4-0-202" class="i">+                    }
</a><a href="#h4-0-203" id="h4-0-203" class="i">+                },
</a><a href="#h4-0-204" id="h4-0-204" class="i">+                confirmButton = {
</a><a href="#h4-0-205" id="h4-0-205" class="i">+                    Button(
</a><a href="#h4-0-206" id="h4-0-206" class="i">+                        onClick = {
</a><a href="#h4-0-207" id="h4-0-207" class="i">+                            showConfirmDialog = false
</a><a href="#h4-0-208" id="h4-0-208" class="i">+
</a><a href="#h4-0-209" id="h4-0-209" class="i">+                            if (taskSelection.isNotEmpty()) {
</a><a href="#h4-0-210" id="h4-0-210" class="i">+                                taskSelection.forEach { (task, documentFile) -&gt;
</a><a href="#h4-0-211" id="h4-0-211" class="i">+                                    context.taskManager.removeTask(task)
</a><a href="#h4-0-212" id="h4-0-212" class="i">+                                    recentTasks.remove(task)
</a><a href="#h4-0-213" id="h4-0-213" class="i">+                                    if (alsoDeleteFiles) {
</a><a href="#h4-0-214" id="h4-0-214" class="i">+                                        documentFile?.delete()
</a><a href="#h4-0-215" id="h4-0-215" class="i">+                                    }
</a><a href="#h4-0-216" id="h4-0-216" class="i">+                                }
</a><a href="#h4-0-217" id="h4-0-217" class="i">+                                activeTasks = activeTasks.filter { task -&gt; !taskSelection.map { it.first }.contains(task.task) }
</a><a href="#h4-0-218" id="h4-0-218" class="i">+                                taskSelection.clear()
</a><a href="#h4-0-219" id="h4-0-219" class="i">+                            } else {
</a><a href="#h4-0-220" id="h4-0-220" class="i">+                                context.taskManager.clearAllTasks()
</a><a href="#h4-0-221" id="h4-0-221" class="i">+                                recentTasks.clear()
</a><a href="#h4-0-222" id="h4-0-222" class="i">+                                activeTasks.forEach {
</a><a href="#h4-0-223" id="h4-0-223" class="i">+                                    runCatching {
</a><a href="#h4-0-224" id="h4-0-224" class="i">+                                        it.cancel()
</a><a href="#h4-0-225" id="h4-0-225" class="i">+                                    }.onFailure { throwable -&gt;
</a><a href="#h4-0-226" id="h4-0-226" class="i">+                                        context.log.error(&quot;Failed to cancel task $it&quot;, throwable)
</a><a href="#h4-0-227" id="h4-0-227" class="i">+                                    }
</a><a href="#h4-0-228" id="h4-0-228" class="i">+                                }
</a><a href="#h4-0-229" id="h4-0-229" class="i">+                                activeTasks = listOf()
</a><a href="#h4-0-230" id="h4-0-230" class="i">+                                context.taskManager.getActiveTasks().clear()
</a><a href="#h4-0-231" id="h4-0-231" class="i">+                            }
</a><a href="#h4-0-232" id="h4-0-232" class="i">+                        }
</a><a href="#h4-0-233" id="h4-0-233" class="i">+                    ) {
</a><a href="#h4-0-234" id="h4-0-234" class="i">+                        Text(&quot;Yes&quot;)
</a><a href="#h4-0-235" id="h4-0-235" class="i">+                    }
</a><a href="#h4-0-236" id="h4-0-236" class="i">+                },
</a><a href="#h4-0-237" id="h4-0-237" class="i">+                dismissButton = {
</a><a href="#h4-0-238" id="h4-0-238" class="i">+                    Button(
</a><a href="#h4-0-239" id="h4-0-239" class="i">+                        onClick = {
</a><a href="#h4-0-240" id="h4-0-240" class="i">+                            showConfirmDialog = false
</a><a href="#h4-0-241" id="h4-0-241" class="i">+                        }
</a><a href="#h4-0-242" id="h4-0-242" class="i">+                    ) {
</a><a href="#h4-0-243" id="h4-0-243" class="i">+                        Text(&quot;No&quot;)
</a><a href="#h4-0-244" id="h4-0-244" class="i">+                    }
</a><a href="#h4-0-245" id="h4-0-245" class="i">+                }
</a><a href="#h4-0-246" id="h4-0-246" class="i">+            )
</a><a href="#h4-0-247" id="h4-0-247" class="i">+        }
</a><a href="#h4-0-248" id="h4-0-248" class="i">+    }
</a><a href="#h4-0-249" id="h4-0-249" class="i">+
</a><a href="#h4-0-250" id="h4-0-250" class="i">+    @Composable
</a><a href="#h4-0-251" id="h4-0-251" class="i">+    private fun TaskCard(modifier: Modifier, task: Task, pendingTask: PendingTask? = null) {
</a><a href="#h4-0-252" id="h4-0-252" class="i">+        var taskStatus by remember { mutableStateOf(task.status) }
</a><a href="#h4-0-253" id="h4-0-253" class="i">+        var taskProgressLabel by remember { mutableStateOf&lt;String?&gt;(null) }
</a><a href="#h4-0-254" id="h4-0-254" class="i">+        var taskProgress by remember { mutableIntStateOf(-1) }
</a><a href="#h4-0-255" id="h4-0-255" class="i">+        val isSelected by remember { derivedStateOf { taskSelection.any { it.first == task } } }
</a><a href="#h4-0-256" id="h4-0-256" class="i">+        var documentFile by remember { mutableStateOf&lt;DocumentFile?&gt;(null) }
</a><a href="#h4-0-257" id="h4-0-257" class="i">+        var isDocumentFileReadable by remember { mutableStateOf(true) }
</a><a href="#h4-0-258" id="h4-0-258" class="i">+
</a><a href="#h4-0-259" id="h4-0-259" class="i">+        LaunchedEffect(taskStatus.key) {
</a><a href="#h4-0-260" id="h4-0-260" class="i">+            launch(Dispatchers.IO) {
</a><a href="#h4-0-261" id="h4-0-261" class="i">+                documentFile = DocumentFile.fromSingleUri(context.androidContext, task.extra?.toUri() ?: return@launch)
</a><a href="#h4-0-262" id="h4-0-262" class="i">+                isDocumentFileReadable = documentFile?.canRead() ?: false
</a><a href="#h4-0-263" id="h4-0-263" class="i">+            }
</a><a href="#h4-0-264" id="h4-0-264" class="i">+        }
</a><a href="#h4-0-265" id="h4-0-265" class="i">+
</a><a href="#h4-0-266" id="h4-0-266" class="i">+        val listener = remember { PendingTaskListener(
</a><a href="#h4-0-267" id="h4-0-267" class="i">+            onStateChange = {
</a><a href="#h4-0-268" id="h4-0-268" class="i">+                taskStatus = it
</a><a href="#h4-0-269" id="h4-0-269" class="i">+            },
</a><a href="#h4-0-270" id="h4-0-270" class="i">+            onProgress = { label, progress -&gt;
</a><a href="#h4-0-271" id="h4-0-271" class="i">+                taskProgressLabel = label
</a><a href="#h4-0-272" id="h4-0-272" class="i">+                taskProgress = progress
</a><a href="#h4-0-273" id="h4-0-273" class="i">+            }
</a><a href="#h4-0-274" id="h4-0-274" class="i">+        ) }
</a><a href="#h4-0-275" id="h4-0-275" class="i">+
</a><a href="#h4-0-276" id="h4-0-276" class="i">+        LaunchedEffect(Unit) {
</a><a href="#h4-0-277" id="h4-0-277" class="i">+            pendingTask?.addListener(listener)
</a><a href="#h4-0-278" id="h4-0-278" class="i">+        }
</a><a href="#h4-0-279" id="h4-0-279" class="i">+
</a><a href="#h4-0-280" id="h4-0-280" class="i">+        DisposableEffect(Unit) {
</a><a href="#h4-0-281" id="h4-0-281" class="i">+            onDispose {
</a><a href="#h4-0-282" id="h4-0-282" class="i">+                pendingTask?.removeListener(listener)
</a><a href="#h4-0-283" id="h4-0-283" class="i">+            }
</a><a href="#h4-0-284" id="h4-0-284" class="i">+        }
</a><a href="#h4-0-285" id="h4-0-285" class="i">+
</a><a href="#h4-0-286" id="h4-0-286" class="i">+        OutlinedCard(modifier = modifier.clickable {
</a><a href="#h4-0-287" id="h4-0-287" class="i">+            if (isSelected) {
</a><a href="#h4-0-288" id="h4-0-288" class="i">+                taskSelection.removeIf { it.first == task }
</a><a href="#h4-0-289" id="h4-0-289" class="i">+                return@clickable
</a><a href="#h4-0-290" id="h4-0-290" class="i">+            }
</a><a href="#h4-0-291" id="h4-0-291" class="i">+            taskSelection.add(task to documentFile)
</a><a href="#h4-0-292" id="h4-0-292" class="i">+        }.let {
</a><a href="#h4-0-293" id="h4-0-293" class="i">+            if (isSelected) {
</a><a href="#h4-0-294" id="h4-0-294" class="i">+                it
</a><a href="#h4-0-295" id="h4-0-295" class="i">+                    .border(2.dp, MaterialTheme.colorScheme.primary)
</a><a href="#h4-0-296" id="h4-0-296" class="i">+                    .clip(MaterialTheme.shapes.medium)
</a><a href="#h4-0-297" id="h4-0-297" class="i">+            } else it
</a><a href="#h4-0-298" id="h4-0-298" class="i">+        }) {
</a><a href="#h4-0-299" id="h4-0-299" class="i">+            Row(
</a><a href="#h4-0-300" id="h4-0-300" class="i">+                modifier = Modifier.padding(15.dp),
</a><a href="#h4-0-301" id="h4-0-301" class="i">+                verticalAlignment = Alignment.CenterVertically
</a><a href="#h4-0-302" id="h4-0-302" class="i">+            ) {
</a><a href="#h4-0-303" id="h4-0-303" class="i">+                Column(
</a><a href="#h4-0-304" id="h4-0-304" class="i">+                    modifier = Modifier.padding(end = 15.dp)
</a><a href="#h4-0-305" id="h4-0-305" class="i">+                ) {
</a><a href="#h4-0-306" id="h4-0-306" class="i">+                    documentFile?.let { file -&gt;
</a><a href="#h4-0-307" id="h4-0-307" class="i">+                        val mimeType = file.type ?: &quot;&quot;
</a><a href="#h4-0-308" id="h4-0-308" class="i">+                        when {
</a><a href="#h4-0-309" id="h4-0-309" class="i">+                            !isDocumentFileReadable -&gt; Icon(Icons.Filled.DeleteOutline, contentDescription = &quot;File not found&quot;)
</a><a href="#h4-0-310" id="h4-0-310" class="i">+                            mimeType.contains(&quot;image&quot;) -&gt; Icon(Icons.Filled.Image, contentDescription = &quot;Image&quot;)
</a><a href="#h4-0-311" id="h4-0-311" class="i">+                            mimeType.contains(&quot;video&quot;) -&gt; Icon(Icons.Filled.Videocam, contentDescription = &quot;Video&quot;)
</a><a href="#h4-0-312" id="h4-0-312" class="i">+                            mimeType.contains(&quot;audio&quot;) -&gt; Icon(Icons.Filled.MusicNote, contentDescription = &quot;Audio&quot;)
</a><a href="#h4-0-313" id="h4-0-313" class="i">+                            else -&gt; Icon(Icons.Filled.FileCopy, contentDescription = &quot;File&quot;)
</a><a href="#h4-0-314" id="h4-0-314" class="i">+                        }
</a><a href="#h4-0-315" id="h4-0-315" class="i">+                    } ?: run {
</a><a href="#h4-0-316" id="h4-0-316" class="i">+                        when (task.type) {
</a><a href="#h4-0-317" id="h4-0-317" class="i">+                            TaskType.DOWNLOAD -&gt; Icon(Icons.Filled.Download, contentDescription = &quot;Download&quot;)
</a><a href="#h4-0-318" id="h4-0-318" class="i">+                            TaskType.CHAT_ACTION -&gt; Icon(Icons.Filled.ChatBubble, contentDescription = &quot;Chat Action&quot;)
</a><a href="#h4-0-319" id="h4-0-319" class="i">+                        }
</a><a href="#h4-0-320" id="h4-0-320" class="i">+                    }
</a><a href="#h4-0-321" id="h4-0-321" class="i">+                }
</a><a href="#h4-0-322" id="h4-0-322" class="i">+                Column(
</a><a href="#h4-0-323" id="h4-0-323" class="i">+                    modifier = Modifier.weight(1f),
</a><a href="#h4-0-324" id="h4-0-324" class="i">+                ) {
</a><a href="#h4-0-325" id="h4-0-325" class="i">+                    Row(
</a><a href="#h4-0-326" id="h4-0-326" class="i">+                        modifier = Modifier.fillMaxWidth(),
</a><a href="#h4-0-327" id="h4-0-327" class="i">+                        verticalAlignment = Alignment.CenterVertically
</a><a href="#h4-0-328" id="h4-0-328" class="i">+                    ) {
</a><a href="#h4-0-329" id="h4-0-329" class="i">+                        Text(task.title, style = MaterialTheme.typography.bodyMedium)
</a><a href="#h4-0-330" id="h4-0-330" class="i">+                        task.author?.takeIf { it != &quot;null&quot; }?.let {
</a><a href="#h4-0-331" id="h4-0-331" class="i">+                            Spacer(modifier = Modifier.width(5.dp))
</a><a href="#h4-0-332" id="h4-0-332" class="i">+                            Text(it, style = MaterialTheme.typography.bodySmall, color = MaterialTheme.colorScheme.onSurfaceVariant)
</a><a href="#h4-0-333" id="h4-0-333" class="i">+                        }
</a><a href="#h4-0-334" id="h4-0-334" class="i">+                    }
</a><a href="#h4-0-335" id="h4-0-335" class="i">+                    Text(task.hash, style = MaterialTheme.typography.labelSmall)
</a><a href="#h4-0-336" id="h4-0-336" class="i">+                    Column(
</a><a href="#h4-0-337" id="h4-0-337" class="i">+                        modifier = Modifier.padding(top = 5.dp),
</a><a href="#h4-0-338" id="h4-0-338" class="i">+                        verticalArrangement = Arrangement.spacedBy(5.dp)
</a><a href="#h4-0-339" id="h4-0-339" class="i">+                    ) {
</a><a href="#h4-0-340" id="h4-0-340" class="i">+                        if (taskStatus.isFinalStage()) {
</a><a href="#h4-0-341" id="h4-0-341" class="i">+                            if (taskStatus != TaskStatus.SUCCESS) {
</a><a href="#h4-0-342" id="h4-0-342" class="i">+                                Text(&quot;$taskStatus&quot;, style = MaterialTheme.typography.bodySmall)
</a><a href="#h4-0-343" id="h4-0-343" class="i">+                            }
</a><a href="#h4-0-344" id="h4-0-344" class="i">+                        } else {
</a><a href="#h4-0-345" id="h4-0-345" class="i">+                            taskProgressLabel?.let {
</a><a href="#h4-0-346" id="h4-0-346" class="i">+                                Text(it, style = MaterialTheme.typography.bodySmall)
</a><a href="#h4-0-347" id="h4-0-347" class="i">+                            }
</a><a href="#h4-0-348" id="h4-0-348" class="i">+                            if (taskProgress != -1) {
</a><a href="#h4-0-349" id="h4-0-349" class="i">+                                LinearProgressIndicator(
</a><a href="#h4-0-350" id="h4-0-350" class="i">+                                    progress = taskProgress.toFloat() / 100f,
</a><a href="#h4-0-351" id="h4-0-351" class="i">+                                    strokeCap = StrokeCap.Round
</a><a href="#h4-0-352" id="h4-0-352" class="i">+                                )
</a><a href="#h4-0-353" id="h4-0-353" class="i">+                            } else {
</a><a href="#h4-0-354" id="h4-0-354" class="i">+                                task.extra?.let {
</a><a href="#h4-0-355" id="h4-0-355" class="i">+                                    Text(it, style = MaterialTheme.typography.bodySmall)
</a><a href="#h4-0-356" id="h4-0-356" class="i">+                                }
</a><a href="#h4-0-357" id="h4-0-357" class="i">+                            }
</a><a href="#h4-0-358" id="h4-0-358" class="i">+                        }
</a><a href="#h4-0-359" id="h4-0-359" class="i">+                    }
</a><a href="#h4-0-360" id="h4-0-360" class="i">+                }
</a><a href="#h4-0-361" id="h4-0-361" class="i">+
</a><a href="#h4-0-362" id="h4-0-362" class="i">+                Column {
</a><a href="#h4-0-363" id="h4-0-363" class="i">+                    if (pendingTask != null &amp;&amp; !taskStatus.isFinalStage()) {
</a><a href="#h4-0-364" id="h4-0-364" class="i">+                        FilledIconButton(onClick = {
</a><a href="#h4-0-365" id="h4-0-365" class="i">+                            runCatching {
</a><a href="#h4-0-366" id="h4-0-366" class="i">+                                pendingTask.cancel()
</a><a href="#h4-0-367" id="h4-0-367" class="i">+                            }.onFailure { throwable -&gt;
</a><a href="#h4-0-368" id="h4-0-368" class="i">+                                context.log.error(&quot;Failed to cancel task $pendingTask&quot;, throwable)
</a><a href="#h4-0-369" id="h4-0-369" class="i">+                            }
</a><a href="#h4-0-370" id="h4-0-370" class="i">+                        }) {
</a><a href="#h4-0-371" id="h4-0-371" class="i">+                            Icon(Icons.Filled.Close, contentDescription = &quot;Cancel&quot;)
</a><a href="#h4-0-372" id="h4-0-372" class="i">+                        }
</a><a href="#h4-0-373" id="h4-0-373" class="i">+                    } else {
</a><a href="#h4-0-374" id="h4-0-374" class="i">+                        when (taskStatus) {
</a><a href="#h4-0-375" id="h4-0-375" class="i">+                            TaskStatus.SUCCESS -&gt; Icon(Icons.Filled.Check, contentDescription = &quot;Success&quot;, tint = MaterialTheme.colorScheme.primary)
</a><a href="#h4-0-376" id="h4-0-376" class="i">+                            TaskStatus.FAILURE -&gt; Icon(Icons.Filled.Error, contentDescription = &quot;Failure&quot;, tint = MaterialTheme.colorScheme.error)
</a><a href="#h4-0-377" id="h4-0-377" class="i">+                            TaskStatus.CANCELLED -&gt; Icon(Icons.Filled.Cancel, contentDescription = &quot;Cancelled&quot;, tint = MaterialTheme.colorScheme.error)
</a><a href="#h4-0-378" id="h4-0-378" class="i">+                            else -&gt; {}
</a><a href="#h4-0-379" id="h4-0-379" class="i">+                        }
</a><a href="#h4-0-380" id="h4-0-380" class="i">+                    }
</a><a href="#h4-0-381" id="h4-0-381" class="i">+                }
</a><a href="#h4-0-382" id="h4-0-382" class="i">+            }
</a><a href="#h4-0-383" id="h4-0-383" class="i">+        }
</a><a href="#h4-0-384" id="h4-0-384" class="i">+    }
</a><a href="#h4-0-385" id="h4-0-385" class="i">+
</a><a href="#h4-0-386" id="h4-0-386" class="i">+    override val content: @Composable (NavBackStackEntry) -&gt; Unit = {
</a><a href="#h4-0-387" id="h4-0-387" class="i">+        val scrollState = rememberLazyListState()
</a><a href="#h4-0-388" id="h4-0-388" class="i">+        val scope = rememberCoroutineScope()
</a><a href="#h4-0-389" id="h4-0-389" class="i">+        recentTasks = remember { mutableStateListOf() }
</a><a href="#h4-0-390" id="h4-0-390" class="i">+        var lastFetchedTaskId: Long? by remember { mutableStateOf(null) }
</a><a href="#h4-0-391" id="h4-0-391" class="i">+
</a><a href="#h4-0-392" id="h4-0-392" class="i">+        fun fetchNewRecentTasks() {
</a><a href="#h4-0-393" id="h4-0-393" class="i">+            scope.launch(Dispatchers.IO) {
</a><a href="#h4-0-394" id="h4-0-394" class="i">+                val tasks = context.taskManager.fetchStoredTasks(lastFetchedTaskId ?: Long.MAX_VALUE)
</a><a href="#h4-0-395" id="h4-0-395" class="i">+                if (tasks.isNotEmpty()) {
</a><a href="#h4-0-396" id="h4-0-396" class="i">+                    lastFetchedTaskId = tasks.keys.last()
</a><a href="#h4-0-397" id="h4-0-397" class="i">+                    val activeTaskIds = activeTasks.map { it.taskId }
</a><a href="#h4-0-398" id="h4-0-398" class="i">+                    recentTasks.addAll(tasks.filter { it.key !in activeTaskIds }.values)
</a><a href="#h4-0-399" id="h4-0-399" class="i">+                }
</a><a href="#h4-0-400" id="h4-0-400" class="i">+            }
</a><a href="#h4-0-401" id="h4-0-401" class="i">+        }
</a><a href="#h4-0-402" id="h4-0-402" class="i">+
</a><a href="#h4-0-403" id="h4-0-403" class="i">+        LaunchedEffect(Unit) {
</a><a href="#h4-0-404" id="h4-0-404" class="i">+            fetchActiveTasks(this)
</a><a href="#h4-0-405" id="h4-0-405" class="i">+        }
</a><a href="#h4-0-406" id="h4-0-406" class="i">+
</a><a href="#h4-0-407" id="h4-0-407" class="i">+        DisposableEffect(Unit) {
</a><a href="#h4-0-408" id="h4-0-408" class="i">+            onDispose {
</a><a href="#h4-0-409" id="h4-0-409" class="i">+                taskSelection.clear()
</a><a href="#h4-0-410" id="h4-0-410" class="i">+            }
</a><a href="#h4-0-411" id="h4-0-411" class="i">+        }
</a><a href="#h4-0-412" id="h4-0-412" class="i">+
</a><a href="#h4-0-413" id="h4-0-413" class="i">+        OnLifecycleEvent { _, event -&gt;
</a><a href="#h4-0-414" id="h4-0-414" class="i">+            if (event == Lifecycle.Event.ON_RESUME) {
</a><a href="#h4-0-415" id="h4-0-415" class="i">+                fetchActiveTasks(scope)
</a><a href="#h4-0-416" id="h4-0-416" class="i">+            }
</a><a href="#h4-0-417" id="h4-0-417" class="i">+        }
</a><a href="#h4-0-418" id="h4-0-418" class="i">+
</a><a href="#h4-0-419" id="h4-0-419" class="i">+        LazyColumn(
</a><a href="#h4-0-420" id="h4-0-420" class="i">+            state = scrollState,
</a><a href="#h4-0-421" id="h4-0-421" class="i">+            modifier = Modifier.fillMaxSize()
</a><a href="#h4-0-422" id="h4-0-422" class="i">+        ) {
</a><a href="#h4-0-423" id="h4-0-423" class="i">+            item {
</a><a href="#h4-0-424" id="h4-0-424" class="i">+                if (activeTasks.isEmpty() &amp;&amp; recentTasks.isEmpty()) {
</a><a href="#h4-0-425" id="h4-0-425" class="i">+                    Column(
</a><a href="#h4-0-426" id="h4-0-426" class="i">+                        modifier = Modifier.fillMaxSize(),
</a><a href="#h4-0-427" id="h4-0-427" class="i">+                        horizontalAlignment = Alignment.CenterHorizontally,
</a><a href="#h4-0-428" id="h4-0-428" class="i">+                        verticalArrangement = Arrangement.Center
</a><a href="#h4-0-429" id="h4-0-429" class="i">+                    ) {
</a><a href="#h4-0-430" id="h4-0-430" class="i">+                        context.translation[&quot;manager.sections.tasks.no_tasks&quot;].let {
</a><a href="#h4-0-431" id="h4-0-431" class="i">+                            Icon(Icons.Filled.CheckCircle, contentDescription = it, tint = MaterialTheme.colorScheme.primary)
</a><a href="#h4-0-432" id="h4-0-432" class="i">+                            Text(it, style = MaterialTheme.typography.bodyLarge)
</a><a href="#h4-0-433" id="h4-0-433" class="i">+                        }
</a><a href="#h4-0-434" id="h4-0-434" class="i">+                    }
</a><a href="#h4-0-435" id="h4-0-435" class="i">+                }
</a><a href="#h4-0-436" id="h4-0-436" class="i">+            }
</a><a href="#h4-0-437" id="h4-0-437" class="i">+            items(activeTasks, key = { it.taskId }) {pendingTask -&gt;
</a><a href="#h4-0-438" id="h4-0-438" class="i">+                TaskCard(modifier = Modifier.padding(8.dp), pendingTask.task, pendingTask = pendingTask)
</a><a href="#h4-0-439" id="h4-0-439" class="i">+            }
</a><a href="#h4-0-440" id="h4-0-440" class="i">+            items(recentTasks, key = { it.hash }) { task -&gt;
</a><a href="#h4-0-441" id="h4-0-441" class="i">+                TaskCard(modifier = Modifier.padding(8.dp), task)
</a><a href="#h4-0-442" id="h4-0-442" class="i">+            }
</a><a href="#h4-0-443" id="h4-0-443" class="i">+            item {
</a><a href="#h4-0-444" id="h4-0-444" class="i">+                Spacer(modifier = Modifier.height(20.dp))
</a><a href="#h4-0-445" id="h4-0-445" class="i">+                LaunchedEffect(remember { derivedStateOf { scrollState.firstVisibleItemIndex } }) {
</a><a href="#h4-0-446" id="h4-0-446" class="i">+                    fetchNewRecentTasks()
</a><a href="#h4-0-447" id="h4-0-447" class="i">+                }
</a><a href="#h4-0-448" id="h4-0-448" class="i">+            }
</a><a href="#h4-0-449" id="h4-0-449" class="i">+        }
</a><a href="#h4-0-450" id="h4-0-450" class="i">+    }
</a><a href="#h4-0-451" id="h4-0-451" class="i">+}</a><a href="#h4-0-452" id="h4-0-452" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h5" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/features/CallbackAlias.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/features/CallbackAlias.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/features/CallbackAlias.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/features/CallbackAlias.kt</a></b>
<a href="#h5-0" id="h5-0" class="h">@@ -0,0 +1,4 @@
</a><a href="#h5-0-0" id="h5-0-0" class="i">+package me.rhunk.snapenhance.ui.manager.pages.features
</a><a href="#h5-0-1" id="h5-0-1" class="i">+
</a><a href="#h5-0-2" id="h5-0-2" class="i">+typealias ClickCallback = (Boolean) -&gt; Unit
</a><a href="#h5-0-3" id="h5-0-3" class="i">+typealias RegisterClickCallback = (ClickCallback) -&gt; ClickCallback</a><a href="#h5-0-4" id="h5-0-4" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h6" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/features/FeaturesRoot.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/features/FeaturesRoot.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/features/FeaturesRoot.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/features/FeaturesRoot.kt</a></b>
<a href="#h6-0" id="h6-0" class="h">@@ -0,0 +1,575 @@
</a><a href="#h6-0-0" id="h6-0-0" class="i">+package me.rhunk.snapenhance.ui.manager.pages.features
</a><a href="#h6-0-1" id="h6-0-1" class="i">+
</a><a href="#h6-0-2" id="h6-0-2" class="i">+import android.content.Intent
</a><a href="#h6-0-3" id="h6-0-3" class="i">+import android.net.Uri
</a><a href="#h6-0-4" id="h6-0-4" class="i">+import androidx.compose.animation.AnimatedContentTransitionScope
</a><a href="#h6-0-5" id="h6-0-5" class="i">+import androidx.compose.animation.core.tween
</a><a href="#h6-0-6" id="h6-0-6" class="i">+import androidx.compose.foundation.background
</a><a href="#h6-0-7" id="h6-0-7" class="i">+import androidx.compose.foundation.clickable
</a><a href="#h6-0-8" id="h6-0-8" class="i">+import androidx.compose.foundation.layout.*
</a><a href="#h6-0-9" id="h6-0-9" class="i">+import androidx.compose.foundation.lazy.LazyColumn
</a><a href="#h6-0-10" id="h6-0-10" class="i">+import androidx.compose.foundation.lazy.items
</a><a href="#h6-0-11" id="h6-0-11" class="i">+import androidx.compose.foundation.shape.RoundedCornerShape
</a><a href="#h6-0-12" id="h6-0-12" class="i">+import androidx.compose.foundation.text.KeyboardActions
</a><a href="#h6-0-13" id="h6-0-13" class="i">+import androidx.compose.material.icons.Icons
</a><a href="#h6-0-14" id="h6-0-14" class="i">+import androidx.compose.material.icons.filled.Close
</a><a href="#h6-0-15" id="h6-0-15" class="i">+import androidx.compose.material.icons.filled.FolderOpen
</a><a href="#h6-0-16" id="h6-0-16" class="i">+import androidx.compose.material.icons.filled.MoreVert
</a><a href="#h6-0-17" id="h6-0-17" class="i">+import androidx.compose.material.icons.filled.OpenInNew
</a><a href="#h6-0-18" id="h6-0-18" class="i">+import androidx.compose.material.icons.filled.Search
</a><a href="#h6-0-19" id="h6-0-19" class="i">+import androidx.compose.material.icons.rounded.Save
</a><a href="#h6-0-20" id="h6-0-20" class="i">+import androidx.compose.material3.*
</a><a href="#h6-0-21" id="h6-0-21" class="i">+import androidx.compose.runtime.*
</a><a href="#h6-0-22" id="h6-0-22" class="i">+import androidx.compose.ui.Alignment
</a><a href="#h6-0-23" id="h6-0-23" class="i">+import androidx.compose.ui.Modifier
</a><a href="#h6-0-24" id="h6-0-24" class="i">+import androidx.compose.ui.focus.FocusRequester
</a><a href="#h6-0-25" id="h6-0-25" class="i">+import androidx.compose.ui.focus.focusRequester
</a><a href="#h6-0-26" id="h6-0-26" class="i">+import androidx.compose.ui.graphics.Color
</a><a href="#h6-0-27" id="h6-0-27" class="i">+import androidx.compose.ui.graphics.vector.ImageVector
</a><a href="#h6-0-28" id="h6-0-28" class="i">+import androidx.compose.ui.text.font.FontWeight
</a><a href="#h6-0-29" id="h6-0-29" class="i">+import androidx.compose.ui.text.style.TextOverflow
</a><a href="#h6-0-30" id="h6-0-30" class="i">+import androidx.compose.ui.unit.dp
</a><a href="#h6-0-31" id="h6-0-31" class="i">+import androidx.compose.ui.unit.sp
</a><a href="#h6-0-32" id="h6-0-32" class="i">+import androidx.navigation.NavBackStackEntry
</a><a href="#h6-0-33" id="h6-0-33" class="i">+import androidx.navigation.NavGraph.Companion.findStartDestination
</a><a href="#h6-0-34" id="h6-0-34" class="i">+import androidx.navigation.NavGraphBuilder
</a><a href="#h6-0-35" id="h6-0-35" class="i">+import androidx.navigation.NavOptions
</a><a href="#h6-0-36" id="h6-0-36" class="i">+import androidx.navigation.compose.composable
</a><a href="#h6-0-37" id="h6-0-37" class="i">+import kotlinx.coroutines.Job
</a><a href="#h6-0-38" id="h6-0-38" class="i">+import kotlinx.coroutines.delay
</a><a href="#h6-0-39" id="h6-0-39" class="i">+import kotlinx.coroutines.launch
</a><a href="#h6-0-40" id="h6-0-40" class="i">+import me.rhunk.snapenhance.common.config.*
</a><a href="#h6-0-41" id="h6-0-41" class="i">+import me.rhunk.snapenhance.ui.manager.MainActivity
</a><a href="#h6-0-42" id="h6-0-42" class="i">+import me.rhunk.snapenhance.ui.manager.Routes
</a><a href="#h6-0-43" id="h6-0-43" class="i">+import me.rhunk.snapenhance.ui.util.*
</a><a href="#h6-0-44" id="h6-0-44" class="i">+
</a><a href="#h6-0-45" id="h6-0-45" class="i">+@OptIn(ExperimentalMaterial3Api::class)
</a><a href="#h6-0-46" id="h6-0-46" class="i">+class FeaturesRoot : Routes.Route() {
</a><a href="#h6-0-47" id="h6-0-47" class="i">+    private val alertDialogs by lazy { AlertDialogs(context.translation) }
</a><a href="#h6-0-48" id="h6-0-48" class="i">+
</a><a href="#h6-0-49" id="h6-0-49" class="i">+    companion object {
</a><a href="#h6-0-50" id="h6-0-50" class="i">+        const val FEATURE_CONTAINER_ROUTE = &quot;feature_container/{name}&quot;
</a><a href="#h6-0-51" id="h6-0-51" class="i">+        const val SEARCH_FEATURE_ROUTE = &quot;search_feature/{keyword}&quot;
</a><a href="#h6-0-52" id="h6-0-52" class="i">+    }
</a><a href="#h6-0-53" id="h6-0-53" class="i">+
</a><a href="#h6-0-54" id="h6-0-54" class="i">+    private var activityLauncherHelper: ActivityLauncherHelper? = null
</a><a href="#h6-0-55" id="h6-0-55" class="i">+    private lateinit var rememberScaffoldState: BottomSheetScaffoldState
</a><a href="#h6-0-56" id="h6-0-56" class="i">+
</a><a href="#h6-0-57" id="h6-0-57" class="i">+    private val allContainers by lazy {
</a><a href="#h6-0-58" id="h6-0-58" class="i">+        val containers = mutableMapOf&lt;String, PropertyPair&lt;*&gt;&gt;()
</a><a href="#h6-0-59" id="h6-0-59" class="i">+        fun queryContainerRecursive(container: ConfigContainer) {
</a><a href="#h6-0-60" id="h6-0-60" class="i">+            container.properties.forEach {
</a><a href="#h6-0-61" id="h6-0-61" class="i">+                if (it.key.dataType.type == DataProcessors.Type.CONTAINER) {
</a><a href="#h6-0-62" id="h6-0-62" class="i">+                    containers[it.key.name] = PropertyPair(it.key, it.value)
</a><a href="#h6-0-63" id="h6-0-63" class="i">+                    queryContainerRecursive(it.value.get() as ConfigContainer)
</a><a href="#h6-0-64" id="h6-0-64" class="i">+                }
</a><a href="#h6-0-65" id="h6-0-65" class="i">+            }
</a><a href="#h6-0-66" id="h6-0-66" class="i">+        }
</a><a href="#h6-0-67" id="h6-0-67" class="i">+        queryContainerRecursive(context.config.root)
</a><a href="#h6-0-68" id="h6-0-68" class="i">+        containers
</a><a href="#h6-0-69" id="h6-0-69" class="i">+    }
</a><a href="#h6-0-70" id="h6-0-70" class="i">+
</a><a href="#h6-0-71" id="h6-0-71" class="i">+    private val allProperties by lazy {
</a><a href="#h6-0-72" id="h6-0-72" class="i">+        val properties = mutableMapOf&lt;PropertyKey&lt;*&gt;, PropertyValue&lt;*&gt;&gt;()
</a><a href="#h6-0-73" id="h6-0-73" class="i">+        allContainers.values.forEach {
</a><a href="#h6-0-74" id="h6-0-74" class="i">+            val container = it.value.get() as ConfigContainer
</a><a href="#h6-0-75" id="h6-0-75" class="i">+            container.properties.forEach { property -&gt;
</a><a href="#h6-0-76" id="h6-0-76" class="i">+                properties[property.key] = property.value
</a><a href="#h6-0-77" id="h6-0-77" class="i">+            }
</a><a href="#h6-0-78" id="h6-0-78" class="i">+        }
</a><a href="#h6-0-79" id="h6-0-79" class="i">+        properties
</a><a href="#h6-0-80" id="h6-0-80" class="i">+    }
</a><a href="#h6-0-81" id="h6-0-81" class="i">+
</a><a href="#h6-0-82" id="h6-0-82" class="i">+    private fun navigateToMainRoot() {
</a><a href="#h6-0-83" id="h6-0-83" class="i">+        routes.navController.navigate(routeInfo.id, NavOptions.Builder()
</a><a href="#h6-0-84" id="h6-0-84" class="i">+            .setPopUpTo(routes.navController.graph.findStartDestination().id, false)
</a><a href="#h6-0-85" id="h6-0-85" class="i">+            .setLaunchSingleTop(true)
</a><a href="#h6-0-86" id="h6-0-86" class="i">+            .build()
</a><a href="#h6-0-87" id="h6-0-87" class="i">+        )
</a><a href="#h6-0-88" id="h6-0-88" class="i">+    }
</a><a href="#h6-0-89" id="h6-0-89" class="i">+
</a><a href="#h6-0-90" id="h6-0-90" class="i">+    override val init: () -&gt; Unit = {
</a><a href="#h6-0-91" id="h6-0-91" class="i">+        activityLauncherHelper = ActivityLauncherHelper(context.activity!!)
</a><a href="#h6-0-92" id="h6-0-92" class="i">+    }
</a><a href="#h6-0-93" id="h6-0-93" class="i">+
</a><a href="#h6-0-94" id="h6-0-94" class="i">+    private fun activityLauncher(block: ActivityLauncherHelper.() -&gt; Unit) {
</a><a href="#h6-0-95" id="h6-0-95" class="i">+        activityLauncherHelper?.let(block) ?: run {
</a><a href="#h6-0-96" id="h6-0-96" class="i">+            //open manager if activity launcher is null
</a><a href="#h6-0-97" id="h6-0-97" class="i">+            val intent = Intent(context.androidContext, MainActivity::class.java)
</a><a href="#h6-0-98" id="h6-0-98" class="i">+            intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK)
</a><a href="#h6-0-99" id="h6-0-99" class="i">+            intent.putExtra(&quot;route&quot;, routeInfo.id)
</a><a href="#h6-0-100" id="h6-0-100" class="i">+            context.androidContext.startActivity(intent)
</a><a href="#h6-0-101" id="h6-0-101" class="i">+        }
</a><a href="#h6-0-102" id="h6-0-102" class="i">+    }
</a><a href="#h6-0-103" id="h6-0-103" class="i">+
</a><a href="#h6-0-104" id="h6-0-104" class="i">+    override val content: @Composable (NavBackStackEntry) -&gt; Unit = {
</a><a href="#h6-0-105" id="h6-0-105" class="i">+        Container(context.config.root)
</a><a href="#h6-0-106" id="h6-0-106" class="i">+    }
</a><a href="#h6-0-107" id="h6-0-107" class="i">+
</a><a href="#h6-0-108" id="h6-0-108" class="i">+    override val customComposables: NavGraphBuilder.() -&gt; Unit = {
</a><a href="#h6-0-109" id="h6-0-109" class="i">+        routeInfo.childIds.addAll(listOf(FEATURE_CONTAINER_ROUTE, SEARCH_FEATURE_ROUTE))
</a><a href="#h6-0-110" id="h6-0-110" class="i">+
</a><a href="#h6-0-111" id="h6-0-111" class="i">+        composable(FEATURE_CONTAINER_ROUTE, enterTransition = {
</a><a href="#h6-0-112" id="h6-0-112" class="i">+            slideIntoContainer(AnimatedContentTransitionScope.SlideDirection.Left, animationSpec = tween(100))
</a><a href="#h6-0-113" id="h6-0-113" class="i">+        }, exitTransition = {
</a><a href="#h6-0-114" id="h6-0-114" class="i">+            slideOutOfContainer(AnimatedContentTransitionScope.SlideDirection.Right, animationSpec = tween(300))
</a><a href="#h6-0-115" id="h6-0-115" class="i">+        }) { backStackEntry -&gt;
</a><a href="#h6-0-116" id="h6-0-116" class="i">+            backStackEntry.arguments?.getString(&quot;name&quot;)?.let { containerName -&gt;
</a><a href="#h6-0-117" id="h6-0-117" class="i">+                allContainers[containerName]?.let {
</a><a href="#h6-0-118" id="h6-0-118" class="i">+                    Container(it.value.get() as ConfigContainer)
</a><a href="#h6-0-119" id="h6-0-119" class="i">+                }
</a><a href="#h6-0-120" id="h6-0-120" class="i">+            }
</a><a href="#h6-0-121" id="h6-0-121" class="i">+        }
</a><a href="#h6-0-122" id="h6-0-122" class="i">+
</a><a href="#h6-0-123" id="h6-0-123" class="i">+        composable(SEARCH_FEATURE_ROUTE) { backStackEntry -&gt;
</a><a href="#h6-0-124" id="h6-0-124" class="i">+            backStackEntry.arguments?.getString(&quot;keyword&quot;)?.let { keyword -&gt;
</a><a href="#h6-0-125" id="h6-0-125" class="i">+                val properties = allProperties.filter {
</a><a href="#h6-0-126" id="h6-0-126" class="i">+                    it.key.name.contains(keyword, ignoreCase = true) ||
</a><a href="#h6-0-127" id="h6-0-127" class="i">+                            context.translation[it.key.propertyName()].contains(keyword, ignoreCase = true) ||
</a><a href="#h6-0-128" id="h6-0-128" class="i">+                            context.translation[it.key.propertyDescription()].contains(keyword, ignoreCase = true)
</a><a href="#h6-0-129" id="h6-0-129" class="i">+                }.map { PropertyPair(it.key, it.value) }
</a><a href="#h6-0-130" id="h6-0-130" class="i">+
</a><a href="#h6-0-131" id="h6-0-131" class="i">+                PropertiesView(properties)
</a><a href="#h6-0-132" id="h6-0-132" class="i">+            }
</a><a href="#h6-0-133" id="h6-0-133" class="i">+        }
</a><a href="#h6-0-134" id="h6-0-134" class="i">+    }
</a><a href="#h6-0-135" id="h6-0-135" class="i">+
</a><a href="#h6-0-136" id="h6-0-136" class="i">+    @Composable
</a><a href="#h6-0-137" id="h6-0-137" class="i">+    private fun PropertyAction(property: PropertyPair&lt;*&gt;, registerClickCallback: RegisterClickCallback) {
</a><a href="#h6-0-138" id="h6-0-138" class="i">+        var showDialog by remember { mutableStateOf(false) }
</a><a href="#h6-0-139" id="h6-0-139" class="i">+        var dialogComposable by remember { mutableStateOf&lt;@Composable () -&gt; Unit&gt;({}) }
</a><a href="#h6-0-140" id="h6-0-140" class="i">+
</a><a href="#h6-0-141" id="h6-0-141" class="i">+        fun registerDialogOnClickCallback() = registerClickCallback { showDialog = true }
</a><a href="#h6-0-142" id="h6-0-142" class="i">+
</a><a href="#h6-0-143" id="h6-0-143" class="i">+        if (showDialog) {
</a><a href="#h6-0-144" id="h6-0-144" class="i">+            Dialog(
</a><a href="#h6-0-145" id="h6-0-145" class="i">+                properties = DialogProperties(
</a><a href="#h6-0-146" id="h6-0-146" class="i">+                    usePlatformDefaultWidth = false
</a><a href="#h6-0-147" id="h6-0-147" class="i">+                ),
</a><a href="#h6-0-148" id="h6-0-148" class="i">+                onDismissRequest = { showDialog = false },
</a><a href="#h6-0-149" id="h6-0-149" class="i">+            ) {
</a><a href="#h6-0-150" id="h6-0-150" class="i">+                dialogComposable()
</a><a href="#h6-0-151" id="h6-0-151" class="i">+            }
</a><a href="#h6-0-152" id="h6-0-152" class="i">+        }
</a><a href="#h6-0-153" id="h6-0-153" class="i">+
</a><a href="#h6-0-154" id="h6-0-154" class="i">+        val propertyValue = property.value
</a><a href="#h6-0-155" id="h6-0-155" class="i">+
</a><a href="#h6-0-156" id="h6-0-156" class="i">+        if (property.key.params.flags.contains(ConfigFlag.FOLDER)) {
</a><a href="#h6-0-157" id="h6-0-157" class="i">+            IconButton(onClick = registerClickCallback {
</a><a href="#h6-0-158" id="h6-0-158" class="i">+                activityLauncher {
</a><a href="#h6-0-159" id="h6-0-159" class="i">+                    chooseFolder { uri -&gt;
</a><a href="#h6-0-160" id="h6-0-160" class="i">+                        propertyValue.setAny(uri)
</a><a href="#h6-0-161" id="h6-0-161" class="i">+                    }
</a><a href="#h6-0-162" id="h6-0-162" class="i">+                }
</a><a href="#h6-0-163" id="h6-0-163" class="i">+            }.let { { it.invoke(true) } }) {
</a><a href="#h6-0-164" id="h6-0-164" class="i">+                Icon(Icons.Filled.FolderOpen, contentDescription = null)
</a><a href="#h6-0-165" id="h6-0-165" class="i">+            }
</a><a href="#h6-0-166" id="h6-0-166" class="i">+            return
</a><a href="#h6-0-167" id="h6-0-167" class="i">+        }
</a><a href="#h6-0-168" id="h6-0-168" class="i">+
</a><a href="#h6-0-169" id="h6-0-169" class="i">+        when (val dataType = remember { property.key.dataType.type }) {
</a><a href="#h6-0-170" id="h6-0-170" class="i">+            DataProcessors.Type.BOOLEAN -&gt; {
</a><a href="#h6-0-171" id="h6-0-171" class="i">+                var state by remember { mutableStateOf(propertyValue.get() as Boolean) }
</a><a href="#h6-0-172" id="h6-0-172" class="i">+                Switch(
</a><a href="#h6-0-173" id="h6-0-173" class="i">+                    checked = state,
</a><a href="#h6-0-174" id="h6-0-174" class="i">+                    onCheckedChange = registerClickCallback {
</a><a href="#h6-0-175" id="h6-0-175" class="i">+                        state = state.not()
</a><a href="#h6-0-176" id="h6-0-176" class="i">+                        propertyValue.setAny(state)
</a><a href="#h6-0-177" id="h6-0-177" class="i">+                    }
</a><a href="#h6-0-178" id="h6-0-178" class="i">+                )
</a><a href="#h6-0-179" id="h6-0-179" class="i">+            }
</a><a href="#h6-0-180" id="h6-0-180" class="i">+
</a><a href="#h6-0-181" id="h6-0-181" class="i">+            DataProcessors.Type.MAP_COORDINATES -&gt; {
</a><a href="#h6-0-182" id="h6-0-182" class="i">+                registerDialogOnClickCallback()
</a><a href="#h6-0-183" id="h6-0-183" class="i">+                dialogComposable = {
</a><a href="#h6-0-184" id="h6-0-184" class="i">+                    alertDialogs.ChooseLocationDialog(property) {
</a><a href="#h6-0-185" id="h6-0-185" class="i">+                        showDialog = false
</a><a href="#h6-0-186" id="h6-0-186" class="i">+                    }
</a><a href="#h6-0-187" id="h6-0-187" class="i">+                }
</a><a href="#h6-0-188" id="h6-0-188" class="i">+
</a><a href="#h6-0-189" id="h6-0-189" class="i">+                Text(
</a><a href="#h6-0-190" id="h6-0-190" class="i">+                    overflow = TextOverflow.Ellipsis,
</a><a href="#h6-0-191" id="h6-0-191" class="i">+                    maxLines = 1,
</a><a href="#h6-0-192" id="h6-0-192" class="i">+                    modifier = Modifier.widthIn(0.dp, 120.dp),
</a><a href="#h6-0-193" id="h6-0-193" class="i">+                    text = (propertyValue.get() as Pair&lt;*, *&gt;).let {
</a><a href="#h6-0-194" id="h6-0-194" class="i">+                        &quot;${it.first.toString().toFloatOrNull() ?: 0F}, ${it.second.toString().toFloatOrNull() ?: 0F}&quot;
</a><a href="#h6-0-195" id="h6-0-195" class="i">+                    }
</a><a href="#h6-0-196" id="h6-0-196" class="i">+                )
</a><a href="#h6-0-197" id="h6-0-197" class="i">+            }
</a><a href="#h6-0-198" id="h6-0-198" class="i">+
</a><a href="#h6-0-199" id="h6-0-199" class="i">+            DataProcessors.Type.STRING_UNIQUE_SELECTION -&gt; {
</a><a href="#h6-0-200" id="h6-0-200" class="i">+                registerDialogOnClickCallback()
</a><a href="#h6-0-201" id="h6-0-201" class="i">+
</a><a href="#h6-0-202" id="h6-0-202" class="i">+                dialogComposable = {
</a><a href="#h6-0-203" id="h6-0-203" class="i">+                    alertDialogs.UniqueSelectionDialog(property)
</a><a href="#h6-0-204" id="h6-0-204" class="i">+                }
</a><a href="#h6-0-205" id="h6-0-205" class="i">+
</a><a href="#h6-0-206" id="h6-0-206" class="i">+                Text(
</a><a href="#h6-0-207" id="h6-0-207" class="i">+                    overflow = TextOverflow.Ellipsis,
</a><a href="#h6-0-208" id="h6-0-208" class="i">+                    maxLines = 1,
</a><a href="#h6-0-209" id="h6-0-209" class="i">+                    modifier = Modifier.widthIn(0.dp, 120.dp),
</a><a href="#h6-0-210" id="h6-0-210" class="i">+                    text = (propertyValue.getNullable() as? String ?: &quot;null&quot;).let {
</a><a href="#h6-0-211" id="h6-0-211" class="i">+                        property.key.propertyOption(context.translation, it)
</a><a href="#h6-0-212" id="h6-0-212" class="i">+                    }
</a><a href="#h6-0-213" id="h6-0-213" class="i">+                )
</a><a href="#h6-0-214" id="h6-0-214" class="i">+            }
</a><a href="#h6-0-215" id="h6-0-215" class="i">+
</a><a href="#h6-0-216" id="h6-0-216" class="i">+            DataProcessors.Type.STRING_MULTIPLE_SELECTION, DataProcessors.Type.STRING, DataProcessors.Type.INTEGER, DataProcessors.Type.FLOAT -&gt; {
</a><a href="#h6-0-217" id="h6-0-217" class="i">+                dialogComposable = {
</a><a href="#h6-0-218" id="h6-0-218" class="i">+                    when (dataType) {
</a><a href="#h6-0-219" id="h6-0-219" class="i">+                        DataProcessors.Type.STRING_MULTIPLE_SELECTION -&gt; {
</a><a href="#h6-0-220" id="h6-0-220" class="i">+                            alertDialogs.MultipleSelectionDialog(property)
</a><a href="#h6-0-221" id="h6-0-221" class="i">+                        }
</a><a href="#h6-0-222" id="h6-0-222" class="i">+                        DataProcessors.Type.STRING, DataProcessors.Type.INTEGER, DataProcessors.Type.FLOAT -&gt; {
</a><a href="#h6-0-223" id="h6-0-223" class="i">+                            alertDialogs.KeyboardInputDialog(property) { showDialog = false }
</a><a href="#h6-0-224" id="h6-0-224" class="i">+                        }
</a><a href="#h6-0-225" id="h6-0-225" class="i">+                        else -&gt; {}
</a><a href="#h6-0-226" id="h6-0-226" class="i">+                    }
</a><a href="#h6-0-227" id="h6-0-227" class="i">+                }
</a><a href="#h6-0-228" id="h6-0-228" class="i">+
</a><a href="#h6-0-229" id="h6-0-229" class="i">+                registerDialogOnClickCallback().let { { it.invoke(true) } }.also {
</a><a href="#h6-0-230" id="h6-0-230" class="i">+                    if (dataType == DataProcessors.Type.INTEGER ||
</a><a href="#h6-0-231" id="h6-0-231" class="i">+                        dataType == DataProcessors.Type.FLOAT) {
</a><a href="#h6-0-232" id="h6-0-232" class="i">+                        FilledIconButton(onClick = it) {
</a><a href="#h6-0-233" id="h6-0-233" class="i">+                            Text(
</a><a href="#h6-0-234" id="h6-0-234" class="i">+                                text = propertyValue.get().toString(),
</a><a href="#h6-0-235" id="h6-0-235" class="i">+                                modifier = Modifier.wrapContentWidth(),
</a><a href="#h6-0-236" id="h6-0-236" class="i">+                                overflow = TextOverflow.Ellipsis
</a><a href="#h6-0-237" id="h6-0-237" class="i">+                            )
</a><a href="#h6-0-238" id="h6-0-238" class="i">+                        }
</a><a href="#h6-0-239" id="h6-0-239" class="i">+                    } else {
</a><a href="#h6-0-240" id="h6-0-240" class="i">+                        IconButton(onClick = it) {
</a><a href="#h6-0-241" id="h6-0-241" class="i">+                            Icon(Icons.Filled.OpenInNew, contentDescription = null)
</a><a href="#h6-0-242" id="h6-0-242" class="i">+                        }
</a><a href="#h6-0-243" id="h6-0-243" class="i">+                    }
</a><a href="#h6-0-244" id="h6-0-244" class="i">+                }
</a><a href="#h6-0-245" id="h6-0-245" class="i">+            }
</a><a href="#h6-0-246" id="h6-0-246" class="i">+            DataProcessors.Type.CONTAINER -&gt; {
</a><a href="#h6-0-247" id="h6-0-247" class="i">+                val container = propertyValue.get() as ConfigContainer
</a><a href="#h6-0-248" id="h6-0-248" class="i">+
</a><a href="#h6-0-249" id="h6-0-249" class="i">+                registerClickCallback {
</a><a href="#h6-0-250" id="h6-0-250" class="i">+                    routes.navController.navigate(FEATURE_CONTAINER_ROUTE.replace(&quot;{name}&quot;, property.name))
</a><a href="#h6-0-251" id="h6-0-251" class="i">+                }
</a><a href="#h6-0-252" id="h6-0-252" class="i">+
</a><a href="#h6-0-253" id="h6-0-253" class="i">+                if (!container.hasGlobalState) return
</a><a href="#h6-0-254" id="h6-0-254" class="i">+
</a><a href="#h6-0-255" id="h6-0-255" class="i">+                var state by remember { mutableStateOf(container.globalState ?: false) }
</a><a href="#h6-0-256" id="h6-0-256" class="i">+
</a><a href="#h6-0-257" id="h6-0-257" class="i">+                Box(
</a><a href="#h6-0-258" id="h6-0-258" class="i">+                    modifier = Modifier
</a><a href="#h6-0-259" id="h6-0-259" class="i">+                        .padding(end = 15.dp),
</a><a href="#h6-0-260" id="h6-0-260" class="i">+                ) {
</a><a href="#h6-0-261" id="h6-0-261" class="i">+
</a><a href="#h6-0-262" id="h6-0-262" class="i">+                    Box(modifier = Modifier
</a><a href="#h6-0-263" id="h6-0-263" class="i">+                        .height(50.dp)
</a><a href="#h6-0-264" id="h6-0-264" class="i">+                        .width(1.dp)
</a><a href="#h6-0-265" id="h6-0-265" class="i">+                        .background(
</a><a href="#h6-0-266" id="h6-0-266" class="i">+                            color = MaterialTheme.colorScheme.primary.copy(alpha = 0.12f),
</a><a href="#h6-0-267" id="h6-0-267" class="i">+                            shape = RoundedCornerShape(5.dp)
</a><a href="#h6-0-268" id="h6-0-268" class="i">+                        ))
</a><a href="#h6-0-269" id="h6-0-269" class="i">+                }
</a><a href="#h6-0-270" id="h6-0-270" class="i">+
</a><a href="#h6-0-271" id="h6-0-271" class="i">+                Switch(
</a><a href="#h6-0-272" id="h6-0-272" class="i">+                    checked = state,
</a><a href="#h6-0-273" id="h6-0-273" class="i">+                    onCheckedChange = {
</a><a href="#h6-0-274" id="h6-0-274" class="i">+                        state = state.not()
</a><a href="#h6-0-275" id="h6-0-275" class="i">+                        container.globalState = state
</a><a href="#h6-0-276" id="h6-0-276" class="i">+                    }
</a><a href="#h6-0-277" id="h6-0-277" class="i">+                )
</a><a href="#h6-0-278" id="h6-0-278" class="i">+            }
</a><a href="#h6-0-279" id="h6-0-279" class="i">+        }
</a><a href="#h6-0-280" id="h6-0-280" class="i">+
</a><a href="#h6-0-281" id="h6-0-281" class="i">+    }
</a><a href="#h6-0-282" id="h6-0-282" class="i">+
</a><a href="#h6-0-283" id="h6-0-283" class="i">+    @Composable
</a><a href="#h6-0-284" id="h6-0-284" class="i">+    private fun PropertyCard(property: PropertyPair&lt;*&gt;) {
</a><a href="#h6-0-285" id="h6-0-285" class="i">+        var clickCallback by remember { mutableStateOf&lt;ClickCallback?&gt;(null) }
</a><a href="#h6-0-286" id="h6-0-286" class="i">+        val noticeColorMap = mapOf(
</a><a href="#h6-0-287" id="h6-0-287" class="i">+            FeatureNotice.UNSTABLE.key to Color(0xFFFFFB87),
</a><a href="#h6-0-288" id="h6-0-288" class="i">+            FeatureNotice.BAN_RISK.key to Color(0xFFFF8585),
</a><a href="#h6-0-289" id="h6-0-289" class="i">+            FeatureNotice.INTERNAL_BEHAVIOR.key to Color(0xFFFFFB87),
</a><a href="#h6-0-290" id="h6-0-290" class="i">+            FeatureNotice.REQUIRE_NATIVE_HOOKS.key to Color(0xFFFF5722),
</a><a href="#h6-0-291" id="h6-0-291" class="i">+        )
</a><a href="#h6-0-292" id="h6-0-292" class="i">+
</a><a href="#h6-0-293" id="h6-0-293" class="i">+        Card(
</a><a href="#h6-0-294" id="h6-0-294" class="i">+            modifier = Modifier
</a><a href="#h6-0-295" id="h6-0-295" class="i">+                .fillMaxWidth()
</a><a href="#h6-0-296" id="h6-0-296" class="i">+                .padding(start = 10.dp, end = 10.dp, top = 5.dp, bottom = 5.dp)
</a><a href="#h6-0-297" id="h6-0-297" class="i">+        ) {
</a><a href="#h6-0-298" id="h6-0-298" class="i">+            Row(
</a><a href="#h6-0-299" id="h6-0-299" class="i">+                modifier = Modifier
</a><a href="#h6-0-300" id="h6-0-300" class="i">+                    .fillMaxSize()
</a><a href="#h6-0-301" id="h6-0-301" class="i">+                    .clickable {
</a><a href="#h6-0-302" id="h6-0-302" class="i">+                        clickCallback?.invoke(true)
</a><a href="#h6-0-303" id="h6-0-303" class="i">+                    }
</a><a href="#h6-0-304" id="h6-0-304" class="i">+                    .padding(all = 4.dp),
</a><a href="#h6-0-305" id="h6-0-305" class="i">+                horizontalArrangement = Arrangement.SpaceBetween
</a><a href="#h6-0-306" id="h6-0-306" class="i">+            ) {
</a><a href="#h6-0-307" id="h6-0-307" class="i">+                property.key.params.icon?.let { iconName -&gt;
</a><a href="#h6-0-308" id="h6-0-308" class="i">+                    //TODO: find a better way to load icons
</a><a href="#h6-0-309" id="h6-0-309" class="i">+                    val icon: ImageVector? = remember(iconName) {
</a><a href="#h6-0-310" id="h6-0-310" class="i">+                        runCatching {
</a><a href="#h6-0-311" id="h6-0-311" class="i">+                            val cl = Class.forName(&quot;androidx.compose.material.icons.filled.${iconName}Kt&quot;)
</a><a href="#h6-0-312" id="h6-0-312" class="i">+                            val method = cl.declaredMethods.first()
</a><a href="#h6-0-313" id="h6-0-313" class="i">+                            method.invoke(null, Icons.Filled) as ImageVector
</a><a href="#h6-0-314" id="h6-0-314" class="i">+                        }.getOrNull()
</a><a href="#h6-0-315" id="h6-0-315" class="i">+                    }
</a><a href="#h6-0-316" id="h6-0-316" class="i">+                    if (icon != null) {
</a><a href="#h6-0-317" id="h6-0-317" class="i">+                        Icon(
</a><a href="#h6-0-318" id="h6-0-318" class="i">+                            imageVector = icon,
</a><a href="#h6-0-319" id="h6-0-319" class="i">+                            contentDescription = null,
</a><a href="#h6-0-320" id="h6-0-320" class="i">+                            modifier = Modifier
</a><a href="#h6-0-321" id="h6-0-321" class="i">+                                .align(Alignment.CenterVertically)
</a><a href="#h6-0-322" id="h6-0-322" class="i">+                                .padding(start = 10.dp)
</a><a href="#h6-0-323" id="h6-0-323" class="i">+                        )
</a><a href="#h6-0-324" id="h6-0-324" class="i">+                    }
</a><a href="#h6-0-325" id="h6-0-325" class="i">+                }
</a><a href="#h6-0-326" id="h6-0-326" class="i">+
</a><a href="#h6-0-327" id="h6-0-327" class="i">+                Column(
</a><a href="#h6-0-328" id="h6-0-328" class="i">+                    modifier = Modifier
</a><a href="#h6-0-329" id="h6-0-329" class="i">+                        .align(Alignment.CenterVertically)
</a><a href="#h6-0-330" id="h6-0-330" class="i">+                        .weight(1f, fill = true)
</a><a href="#h6-0-331" id="h6-0-331" class="i">+                        .padding(all = 10.dp)
</a><a href="#h6-0-332" id="h6-0-332" class="i">+                ) {
</a><a href="#h6-0-333" id="h6-0-333" class="i">+                    Text(
</a><a href="#h6-0-334" id="h6-0-334" class="i">+                        text = context.translation[property.key.propertyName()],
</a><a href="#h6-0-335" id="h6-0-335" class="i">+                        fontSize = 16.sp,
</a><a href="#h6-0-336" id="h6-0-336" class="i">+                        fontWeight = FontWeight.Bold
</a><a href="#h6-0-337" id="h6-0-337" class="i">+                    )
</a><a href="#h6-0-338" id="h6-0-338" class="i">+                    Text(
</a><a href="#h6-0-339" id="h6-0-339" class="i">+                        text = context.translation[property.key.propertyDescription()],
</a><a href="#h6-0-340" id="h6-0-340" class="i">+                        fontSize = 12.sp,
</a><a href="#h6-0-341" id="h6-0-341" class="i">+                        lineHeight = 15.sp
</a><a href="#h6-0-342" id="h6-0-342" class="i">+                    )
</a><a href="#h6-0-343" id="h6-0-343" class="i">+                    property.key.params.notices.also {
</a><a href="#h6-0-344" id="h6-0-344" class="i">+                        if (it.isNotEmpty()) Spacer(modifier = Modifier.height(5.dp))
</a><a href="#h6-0-345" id="h6-0-345" class="i">+                    }.forEach {
</a><a href="#h6-0-346" id="h6-0-346" class="i">+                        Text(
</a><a href="#h6-0-347" id="h6-0-347" class="i">+                            text = context.translation[&quot;features.notices.${it.key}&quot;],
</a><a href="#h6-0-348" id="h6-0-348" class="i">+                            color = noticeColorMap[it.key] ?: Color(0xFFFFFB87),
</a><a href="#h6-0-349" id="h6-0-349" class="i">+                            fontSize = 12.sp,
</a><a href="#h6-0-350" id="h6-0-350" class="i">+                            lineHeight = 15.sp
</a><a href="#h6-0-351" id="h6-0-351" class="i">+                        )
</a><a href="#h6-0-352" id="h6-0-352" class="i">+                    }
</a><a href="#h6-0-353" id="h6-0-353" class="i">+                }
</a><a href="#h6-0-354" id="h6-0-354" class="i">+                Row(
</a><a href="#h6-0-355" id="h6-0-355" class="i">+                    modifier = Modifier
</a><a href="#h6-0-356" id="h6-0-356" class="i">+                        .align(Alignment.CenterVertically)
</a><a href="#h6-0-357" id="h6-0-357" class="i">+                        .padding(all = 10.dp),
</a><a href="#h6-0-358" id="h6-0-358" class="i">+                    verticalAlignment = Alignment.CenterVertically
</a><a href="#h6-0-359" id="h6-0-359" class="i">+                ) {
</a><a href="#h6-0-360" id="h6-0-360" class="i">+                    PropertyAction(property, registerClickCallback = { callback -&gt;
</a><a href="#h6-0-361" id="h6-0-361" class="i">+                        clickCallback = callback
</a><a href="#h6-0-362" id="h6-0-362" class="i">+                        callback
</a><a href="#h6-0-363" id="h6-0-363" class="i">+                    })
</a><a href="#h6-0-364" id="h6-0-364" class="i">+                }
</a><a href="#h6-0-365" id="h6-0-365" class="i">+            }
</a><a href="#h6-0-366" id="h6-0-366" class="i">+        }
</a><a href="#h6-0-367" id="h6-0-367" class="i">+    }
</a><a href="#h6-0-368" id="h6-0-368" class="i">+
</a><a href="#h6-0-369" id="h6-0-369" class="i">+    @Composable
</a><a href="#h6-0-370" id="h6-0-370" class="i">+    private fun FeatureSearchBar(rowScope: RowScope, focusRequester: FocusRequester) {
</a><a href="#h6-0-371" id="h6-0-371" class="i">+        var searchValue by remember { mutableStateOf(&quot;&quot;) }
</a><a href="#h6-0-372" id="h6-0-372" class="i">+        val scope = rememberCoroutineScope()
</a><a href="#h6-0-373" id="h6-0-373" class="i">+        var currentSearchJob by remember { mutableStateOf&lt;Job?&gt;(null) }
</a><a href="#h6-0-374" id="h6-0-374" class="i">+
</a><a href="#h6-0-375" id="h6-0-375" class="i">+        rowScope.apply {
</a><a href="#h6-0-376" id="h6-0-376" class="i">+            TextField(
</a><a href="#h6-0-377" id="h6-0-377" class="i">+                value = searchValue,
</a><a href="#h6-0-378" id="h6-0-378" class="i">+                onValueChange = { keyword -&gt;
</a><a href="#h6-0-379" id="h6-0-379" class="i">+                    searchValue = keyword
</a><a href="#h6-0-380" id="h6-0-380" class="i">+                    if (keyword.isEmpty()) {
</a><a href="#h6-0-381" id="h6-0-381" class="i">+                        navigateToMainRoot()
</a><a href="#h6-0-382" id="h6-0-382" class="i">+                        return@TextField
</a><a href="#h6-0-383" id="h6-0-383" class="i">+                    }
</a><a href="#h6-0-384" id="h6-0-384" class="i">+                    currentSearchJob?.cancel()
</a><a href="#h6-0-385" id="h6-0-385" class="i">+                    scope.launch {
</a><a href="#h6-0-386" id="h6-0-386" class="i">+                        delay(150)
</a><a href="#h6-0-387" id="h6-0-387" class="i">+                        routes.navController.navigate(SEARCH_FEATURE_ROUTE.replace(&quot;{keyword}&quot;, keyword), NavOptions.Builder()
</a><a href="#h6-0-388" id="h6-0-388" class="i">+                            .setLaunchSingleTop(true)
</a><a href="#h6-0-389" id="h6-0-389" class="i">+                            .setPopUpTo(routeInfo.id, false)
</a><a href="#h6-0-390" id="h6-0-390" class="i">+                            .build()
</a><a href="#h6-0-391" id="h6-0-391" class="i">+                        )
</a><a href="#h6-0-392" id="h6-0-392" class="i">+                    }.also { currentSearchJob = it }
</a><a href="#h6-0-393" id="h6-0-393" class="i">+                },
</a><a href="#h6-0-394" id="h6-0-394" class="i">+
</a><a href="#h6-0-395" id="h6-0-395" class="i">+                keyboardActions = KeyboardActions(onDone = {
</a><a href="#h6-0-396" id="h6-0-396" class="i">+                    focusRequester.freeFocus()
</a><a href="#h6-0-397" id="h6-0-397" class="i">+                }),
</a><a href="#h6-0-398" id="h6-0-398" class="i">+                modifier = Modifier
</a><a href="#h6-0-399" id="h6-0-399" class="i">+                    .focusRequester(focusRequester)
</a><a href="#h6-0-400" id="h6-0-400" class="i">+                    .weight(1f, fill = true)
</a><a href="#h6-0-401" id="h6-0-401" class="i">+                    .padding(end = 10.dp)
</a><a href="#h6-0-402" id="h6-0-402" class="i">+                    .height(70.dp),
</a><a href="#h6-0-403" id="h6-0-403" class="i">+                singleLine = true,
</a><a href="#h6-0-404" id="h6-0-404" class="i">+                colors = TextFieldDefaults.colors(
</a><a href="#h6-0-405" id="h6-0-405" class="i">+                    unfocusedContainerColor = MaterialTheme.colorScheme.surface,
</a><a href="#h6-0-406" id="h6-0-406" class="i">+                    focusedContainerColor = MaterialTheme.colorScheme.surface,
</a><a href="#h6-0-407" id="h6-0-407" class="i">+                    focusedIndicatorColor = Color.Transparent,
</a><a href="#h6-0-408" id="h6-0-408" class="i">+                    unfocusedIndicatorColor = Color.Transparent,
</a><a href="#h6-0-409" id="h6-0-409" class="i">+                    disabledIndicatorColor = Color.Transparent,
</a><a href="#h6-0-410" id="h6-0-410" class="i">+                    cursorColor = MaterialTheme.colorScheme.primary
</a><a href="#h6-0-411" id="h6-0-411" class="i">+                )
</a><a href="#h6-0-412" id="h6-0-412" class="i">+            )
</a><a href="#h6-0-413" id="h6-0-413" class="i">+        }
</a><a href="#h6-0-414" id="h6-0-414" class="i">+    }
</a><a href="#h6-0-415" id="h6-0-415" class="i">+
</a><a href="#h6-0-416" id="h6-0-416" class="i">+    override val topBarActions: @Composable (RowScope.() -&gt; Unit) = topBarActions@{
</a><a href="#h6-0-417" id="h6-0-417" class="i">+        var showSearchBar by remember { mutableStateOf(false) }
</a><a href="#h6-0-418" id="h6-0-418" class="i">+        val focusRequester = remember { FocusRequester() }
</a><a href="#h6-0-419" id="h6-0-419" class="i">+
</a><a href="#h6-0-420" id="h6-0-420" class="i">+        if (showSearchBar) {
</a><a href="#h6-0-421" id="h6-0-421" class="i">+            FeatureSearchBar(this, focusRequester)
</a><a href="#h6-0-422" id="h6-0-422" class="i">+            LaunchedEffect(true) {
</a><a href="#h6-0-423" id="h6-0-423" class="i">+                focusRequester.requestFocus()
</a><a href="#h6-0-424" id="h6-0-424" class="i">+            }
</a><a href="#h6-0-425" id="h6-0-425" class="i">+        }
</a><a href="#h6-0-426" id="h6-0-426" class="i">+
</a><a href="#h6-0-427" id="h6-0-427" class="i">+        IconButton(onClick = {
</a><a href="#h6-0-428" id="h6-0-428" class="i">+            showSearchBar = showSearchBar.not()
</a><a href="#h6-0-429" id="h6-0-429" class="i">+            if (!showSearchBar &amp;&amp; routes.currentDestination == SEARCH_FEATURE_ROUTE) {
</a><a href="#h6-0-430" id="h6-0-430" class="i">+                navigateToMainRoot()
</a><a href="#h6-0-431" id="h6-0-431" class="i">+            }
</a><a href="#h6-0-432" id="h6-0-432" class="i">+        }) {
</a><a href="#h6-0-433" id="h6-0-433" class="i">+            Icon(
</a><a href="#h6-0-434" id="h6-0-434" class="i">+                imageVector = if (showSearchBar) Icons.Filled.Close
</a><a href="#h6-0-435" id="h6-0-435" class="i">+                else Icons.Filled.Search,
</a><a href="#h6-0-436" id="h6-0-436" class="i">+                contentDescription = null
</a><a href="#h6-0-437" id="h6-0-437" class="i">+            )
</a><a href="#h6-0-438" id="h6-0-438" class="i">+        }
</a><a href="#h6-0-439" id="h6-0-439" class="i">+
</a><a href="#h6-0-440" id="h6-0-440" class="i">+        if (showSearchBar) return@topBarActions
</a><a href="#h6-0-441" id="h6-0-441" class="i">+
</a><a href="#h6-0-442" id="h6-0-442" class="i">+        var showExportDropdownMenu by remember { mutableStateOf(false) }
</a><a href="#h6-0-443" id="h6-0-443" class="i">+        var showResetConfirmationDialog by remember { mutableStateOf(false) }
</a><a href="#h6-0-444" id="h6-0-444" class="i">+
</a><a href="#h6-0-445" id="h6-0-445" class="i">+        if (showResetConfirmationDialog) {
</a><a href="#h6-0-446" id="h6-0-446" class="i">+            Dialog(onDismissRequest = { showResetConfirmationDialog = false }) {
</a><a href="#h6-0-447" id="h6-0-447" class="i">+                alertDialogs.ConfirmDialog(
</a><a href="#h6-0-448" id="h6-0-448" class="i">+                    title = &quot;Reset config&quot;,
</a><a href="#h6-0-449" id="h6-0-449" class="i">+                    message = &quot;Are you sure you want to reset the config?&quot;,
</a><a href="#h6-0-450" id="h6-0-450" class="i">+                    onConfirm = {
</a><a href="#h6-0-451" id="h6-0-451" class="i">+                        context.config.reset()
</a><a href="#h6-0-452" id="h6-0-452" class="i">+                        context.shortToast(&quot;Config successfully reset!&quot;)
</a><a href="#h6-0-453" id="h6-0-453" class="i">+                    },
</a><a href="#h6-0-454" id="h6-0-454" class="i">+                    onDismiss = { showResetConfirmationDialog = false }
</a><a href="#h6-0-455" id="h6-0-455" class="i">+                )
</a><a href="#h6-0-456" id="h6-0-456" class="i">+            }
</a><a href="#h6-0-457" id="h6-0-457" class="i">+        }
</a><a href="#h6-0-458" id="h6-0-458" class="i">+
</a><a href="#h6-0-459" id="h6-0-459" class="i">+        val actions = remember {
</a><a href="#h6-0-460" id="h6-0-460" class="i">+            mapOf(
</a><a href="#h6-0-461" id="h6-0-461" class="i">+                &quot;Export&quot; to {
</a><a href="#h6-0-462" id="h6-0-462" class="i">+                    activityLauncher {
</a><a href="#h6-0-463" id="h6-0-463" class="i">+                        saveFile(&quot;config.json&quot;, &quot;application/json&quot;) { uri -&gt;
</a><a href="#h6-0-464" id="h6-0-464" class="i">+                            context.androidContext.contentResolver.openOutputStream(Uri.parse(uri))?.use {
</a><a href="#h6-0-465" id="h6-0-465" class="i">+                                context.config.writeConfig()
</a><a href="#h6-0-466" id="h6-0-466" class="i">+                                context.config.exportToString().byteInputStream().copyTo(it)
</a><a href="#h6-0-467" id="h6-0-467" class="i">+                                context.shortToast(&quot;Config exported successfully!&quot;)
</a><a href="#h6-0-468" id="h6-0-468" class="i">+                            }
</a><a href="#h6-0-469" id="h6-0-469" class="i">+                        }
</a><a href="#h6-0-470" id="h6-0-470" class="i">+                    }
</a><a href="#h6-0-471" id="h6-0-471" class="i">+                },
</a><a href="#h6-0-472" id="h6-0-472" class="i">+                &quot;Import&quot; to {
</a><a href="#h6-0-473" id="h6-0-473" class="i">+                    activityLauncher {
</a><a href="#h6-0-474" id="h6-0-474" class="i">+                        openFile(&quot;application/json&quot;) { uri -&gt;
</a><a href="#h6-0-475" id="h6-0-475" class="i">+                            context.androidContext.contentResolver.openInputStream(Uri.parse(uri))?.use {
</a><a href="#h6-0-476" id="h6-0-476" class="i">+                                runCatching {
</a><a href="#h6-0-477" id="h6-0-477" class="i">+                                    context.config.loadFromString(it.readBytes().toString(Charsets.UTF_8))
</a><a href="#h6-0-478" id="h6-0-478" class="i">+                                }.onFailure {
</a><a href="#h6-0-479" id="h6-0-479" class="i">+                                    context.longToast(&quot;Failed to import config ${it.message}&quot;)
</a><a href="#h6-0-480" id="h6-0-480" class="i">+                                    return@use
</a><a href="#h6-0-481" id="h6-0-481" class="i">+                                }
</a><a href="#h6-0-482" id="h6-0-482" class="i">+                                context.shortToast(&quot;Config successfully loaded!&quot;)
</a><a href="#h6-0-483" id="h6-0-483" class="i">+                            }
</a><a href="#h6-0-484" id="h6-0-484" class="i">+                        }
</a><a href="#h6-0-485" id="h6-0-485" class="i">+                    }
</a><a href="#h6-0-486" id="h6-0-486" class="i">+                },
</a><a href="#h6-0-487" id="h6-0-487" class="i">+                &quot;Reset&quot; to { showResetConfirmationDialog = true }
</a><a href="#h6-0-488" id="h6-0-488" class="i">+            )
</a><a href="#h6-0-489" id="h6-0-489" class="i">+        }
</a><a href="#h6-0-490" id="h6-0-490" class="i">+
</a><a href="#h6-0-491" id="h6-0-491" class="i">+        if (context.activity != null) {
</a><a href="#h6-0-492" id="h6-0-492" class="i">+            IconButton(onClick = { showExportDropdownMenu = !showExportDropdownMenu}) {
</a><a href="#h6-0-493" id="h6-0-493" class="i">+                Icon(
</a><a href="#h6-0-494" id="h6-0-494" class="i">+                    imageVector = Icons.Filled.MoreVert,
</a><a href="#h6-0-495" id="h6-0-495" class="i">+                    contentDescription = null
</a><a href="#h6-0-496" id="h6-0-496" class="i">+                )
</a><a href="#h6-0-497" id="h6-0-497" class="i">+            }
</a><a href="#h6-0-498" id="h6-0-498" class="i">+        }
</a><a href="#h6-0-499" id="h6-0-499" class="i">+
</a><a href="#h6-0-500" id="h6-0-500" class="i">+        if (showExportDropdownMenu) {
</a><a href="#h6-0-501" id="h6-0-501" class="i">+            DropdownMenu(expanded = true, onDismissRequest = { showExportDropdownMenu = false }) {
</a><a href="#h6-0-502" id="h6-0-502" class="i">+                actions.forEach { (name, action) -&gt;
</a><a href="#h6-0-503" id="h6-0-503" class="i">+                    DropdownMenuItem(
</a><a href="#h6-0-504" id="h6-0-504" class="i">+                        text = {
</a><a href="#h6-0-505" id="h6-0-505" class="i">+                            Text(text = name)
</a><a href="#h6-0-506" id="h6-0-506" class="i">+                        },
</a><a href="#h6-0-507" id="h6-0-507" class="i">+                        onClick = {
</a><a href="#h6-0-508" id="h6-0-508" class="i">+                            action()
</a><a href="#h6-0-509" id="h6-0-509" class="i">+                            showExportDropdownMenu = false
</a><a href="#h6-0-510" id="h6-0-510" class="i">+                        }
</a><a href="#h6-0-511" id="h6-0-511" class="i">+                    )
</a><a href="#h6-0-512" id="h6-0-512" class="i">+                }
</a><a href="#h6-0-513" id="h6-0-513" class="i">+            }
</a><a href="#h6-0-514" id="h6-0-514" class="i">+        }
</a><a href="#h6-0-515" id="h6-0-515" class="i">+    }
</a><a href="#h6-0-516" id="h6-0-516" class="i">+
</a><a href="#h6-0-517" id="h6-0-517" class="i">+    @Composable
</a><a href="#h6-0-518" id="h6-0-518" class="i">+    private fun PropertiesView(
</a><a href="#h6-0-519" id="h6-0-519" class="i">+        properties: List&lt;PropertyPair&lt;*&gt;&gt;
</a><a href="#h6-0-520" id="h6-0-520" class="i">+    ) {
</a><a href="#h6-0-521" id="h6-0-521" class="i">+        rememberScaffoldState = rememberBottomSheetScaffoldState()
</a><a href="#h6-0-522" id="h6-0-522" class="i">+        Scaffold(
</a><a href="#h6-0-523" id="h6-0-523" class="i">+            snackbarHost = { SnackbarHost(rememberScaffoldState.snackbarHostState) },
</a><a href="#h6-0-524" id="h6-0-524" class="i">+            modifier = Modifier.fillMaxSize(),
</a><a href="#h6-0-525" id="h6-0-525" class="i">+            content = { innerPadding -&gt;
</a><a href="#h6-0-526" id="h6-0-526" class="i">+                LazyColumn(
</a><a href="#h6-0-527" id="h6-0-527" class="i">+                    modifier = Modifier
</a><a href="#h6-0-528" id="h6-0-528" class="i">+                        .fillMaxHeight()
</a><a href="#h6-0-529" id="h6-0-529" class="i">+                        .padding(innerPadding),
</a><a href="#h6-0-530" id="h6-0-530" class="i">+                    //save button space
</a><a href="#h6-0-531" id="h6-0-531" class="i">+                    contentPadding = PaddingValues(top = 10.dp, bottom = 110.dp),
</a><a href="#h6-0-532" id="h6-0-532" class="i">+                    verticalArrangement = Arrangement.Top
</a><a href="#h6-0-533" id="h6-0-533" class="i">+                ) {
</a><a href="#h6-0-534" id="h6-0-534" class="i">+                    items(properties) {
</a><a href="#h6-0-535" id="h6-0-535" class="i">+                        PropertyCard(it)
</a><a href="#h6-0-536" id="h6-0-536" class="i">+                    }
</a><a href="#h6-0-537" id="h6-0-537" class="i">+                }
</a><a href="#h6-0-538" id="h6-0-538" class="i">+            }
</a><a href="#h6-0-539" id="h6-0-539" class="i">+        )
</a><a href="#h6-0-540" id="h6-0-540" class="i">+    }
</a><a href="#h6-0-541" id="h6-0-541" class="i">+
</a><a href="#h6-0-542" id="h6-0-542" class="i">+    override val floatingActionButton: @Composable () -&gt; Unit = {
</a><a href="#h6-0-543" id="h6-0-543" class="i">+        val scope = rememberCoroutineScope()
</a><a href="#h6-0-544" id="h6-0-544" class="i">+        FloatingActionButton(
</a><a href="#h6-0-545" id="h6-0-545" class="i">+            onClick = {
</a><a href="#h6-0-546" id="h6-0-546" class="i">+                context.config.writeConfig()
</a><a href="#h6-0-547" id="h6-0-547" class="i">+                scope.launch {
</a><a href="#h6-0-548" id="h6-0-548" class="i">+                    rememberScaffoldState.snackbarHostState.showSnackbar(&quot;Saved&quot;)
</a><a href="#h6-0-549" id="h6-0-549" class="i">+                }
</a><a href="#h6-0-550" id="h6-0-550" class="i">+            },
</a><a href="#h6-0-551" id="h6-0-551" class="i">+            modifier = Modifier.padding(10.dp),
</a><a href="#h6-0-552" id="h6-0-552" class="i">+            containerColor = MaterialTheme.colorScheme.primary,
</a><a href="#h6-0-553" id="h6-0-553" class="i">+            contentColor = MaterialTheme.colorScheme.onPrimary,
</a><a href="#h6-0-554" id="h6-0-554" class="i">+            shape = RoundedCornerShape(16.dp),
</a><a href="#h6-0-555" id="h6-0-555" class="i">+        ) {
</a><a href="#h6-0-556" id="h6-0-556" class="i">+            Icon(
</a><a href="#h6-0-557" id="h6-0-557" class="i">+                imageVector = Icons.Rounded.Save,
</a><a href="#h6-0-558" id="h6-0-558" class="i">+                contentDescription = null
</a><a href="#h6-0-559" id="h6-0-559" class="i">+            )
</a><a href="#h6-0-560" id="h6-0-560" class="i">+        }
</a><a href="#h6-0-561" id="h6-0-561" class="i">+    }
</a><a href="#h6-0-562" id="h6-0-562" class="i">+
</a><a href="#h6-0-563" id="h6-0-563" class="i">+
</a><a href="#h6-0-564" id="h6-0-564" class="i">+    @Composable
</a><a href="#h6-0-565" id="h6-0-565" class="i">+    private fun Container(
</a><a href="#h6-0-566" id="h6-0-566" class="i">+        configContainer: ConfigContainer
</a><a href="#h6-0-567" id="h6-0-567" class="i">+    ) {
</a><a href="#h6-0-568" id="h6-0-568" class="i">+        val properties = remember {
</a><a href="#h6-0-569" id="h6-0-569" class="i">+            configContainer.properties.map { PropertyPair(it.key, it.value) }
</a><a href="#h6-0-570" id="h6-0-570" class="i">+        }
</a><a href="#h6-0-571" id="h6-0-571" class="i">+
</a><a href="#h6-0-572" id="h6-0-572" class="i">+        PropertiesView(properties)
</a><a href="#h6-0-573" id="h6-0-573" class="i">+    }
</a><a href="#h6-0-574" id="h6-0-574" class="i">+}</a><a href="#h6-0-575" id="h6-0-575" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h7" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/home/HomeLogs.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/home/HomeLogs.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/home/HomeLogs.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/home/HomeLogs.kt</a></b>
<a href="#h7-0" id="h7-0" class="h">@@ -0,0 +1,252 @@
</a><a href="#h7-0-0" id="h7-0-0" class="i">+package me.rhunk.snapenhance.ui.manager.pages.home
</a><a href="#h7-0-1" id="h7-0-1" class="i">+
</a><a href="#h7-0-2" id="h7-0-2" class="i">+import android.net.Uri
</a><a href="#h7-0-3" id="h7-0-3" class="i">+import androidx.compose.foundation.ScrollState
</a><a href="#h7-0-4" id="h7-0-4" class="i">+import androidx.compose.foundation.background
</a><a href="#h7-0-5" id="h7-0-5" class="i">+import androidx.compose.foundation.gestures.detectTapGestures
</a><a href="#h7-0-6" id="h7-0-6" class="i">+import androidx.compose.foundation.horizontalScroll
</a><a href="#h7-0-7" id="h7-0-7" class="i">+import androidx.compose.foundation.layout.*
</a><a href="#h7-0-8" id="h7-0-8" class="i">+import androidx.compose.foundation.lazy.LazyColumn
</a><a href="#h7-0-9" id="h7-0-9" class="i">+import androidx.compose.foundation.lazy.LazyListState
</a><a href="#h7-0-10" id="h7-0-10" class="i">+import androidx.compose.material.icons.Icons
</a><a href="#h7-0-11" id="h7-0-11" class="i">+import androidx.compose.material.icons.filled.KeyboardDoubleArrowDown
</a><a href="#h7-0-12" id="h7-0-12" class="i">+import androidx.compose.material.icons.filled.KeyboardDoubleArrowUp
</a><a href="#h7-0-13" id="h7-0-13" class="i">+import androidx.compose.material.icons.filled.MoreVert
</a><a href="#h7-0-14" id="h7-0-14" class="i">+import androidx.compose.material.icons.outlined.BugReport
</a><a href="#h7-0-15" id="h7-0-15" class="i">+import androidx.compose.material.icons.outlined.Info
</a><a href="#h7-0-16" id="h7-0-16" class="i">+import androidx.compose.material.icons.outlined.Report
</a><a href="#h7-0-17" id="h7-0-17" class="i">+import androidx.compose.material.icons.outlined.Warning
</a><a href="#h7-0-18" id="h7-0-18" class="i">+import androidx.compose.material3.*
</a><a href="#h7-0-19" id="h7-0-19" class="i">+import androidx.compose.runtime.*
</a><a href="#h7-0-20" id="h7-0-20" class="i">+import androidx.compose.ui.Alignment
</a><a href="#h7-0-21" id="h7-0-21" class="i">+import androidx.compose.ui.Modifier
</a><a href="#h7-0-22" id="h7-0-22" class="i">+import androidx.compose.ui.input.pointer.pointerInput
</a><a href="#h7-0-23" id="h7-0-23" class="i">+import androidx.compose.ui.platform.LocalClipboardManager
</a><a href="#h7-0-24" id="h7-0-24" class="i">+import androidx.compose.ui.text.AnnotatedString
</a><a href="#h7-0-25" id="h7-0-25" class="i">+import androidx.compose.ui.text.font.FontWeight
</a><a href="#h7-0-26" id="h7-0-26" class="i">+import androidx.compose.ui.text.style.TextOverflow
</a><a href="#h7-0-27" id="h7-0-27" class="i">+import androidx.compose.ui.unit.dp
</a><a href="#h7-0-28" id="h7-0-28" class="i">+import androidx.compose.ui.unit.sp
</a><a href="#h7-0-29" id="h7-0-29" class="i">+import androidx.navigation.NavBackStackEntry
</a><a href="#h7-0-30" id="h7-0-30" class="i">+import kotlinx.coroutines.Dispatchers
</a><a href="#h7-0-31" id="h7-0-31" class="i">+import kotlinx.coroutines.delay
</a><a href="#h7-0-32" id="h7-0-32" class="i">+import kotlinx.coroutines.launch
</a><a href="#h7-0-33" id="h7-0-33" class="i">+import kotlinx.coroutines.withContext
</a><a href="#h7-0-34" id="h7-0-34" class="i">+import me.rhunk.snapenhance.LogReader
</a><a href="#h7-0-35" id="h7-0-35" class="i">+import me.rhunk.snapenhance.common.logger.LogChannel
</a><a href="#h7-0-36" id="h7-0-36" class="i">+import me.rhunk.snapenhance.common.logger.LogLevel
</a><a href="#h7-0-37" id="h7-0-37" class="i">+import me.rhunk.snapenhance.ui.manager.Routes
</a><a href="#h7-0-38" id="h7-0-38" class="i">+import me.rhunk.snapenhance.ui.util.ActivityLauncherHelper
</a><a href="#h7-0-39" id="h7-0-39" class="i">+import me.rhunk.snapenhance.ui.util.pullrefresh.PullRefreshIndicator
</a><a href="#h7-0-40" id="h7-0-40" class="i">+import me.rhunk.snapenhance.ui.util.pullrefresh.rememberPullRefreshState
</a><a href="#h7-0-41" id="h7-0-41" class="i">+import me.rhunk.snapenhance.ui.util.saveFile
</a><a href="#h7-0-42" id="h7-0-42" class="i">+
</a><a href="#h7-0-43" id="h7-0-43" class="i">+class HomeLogs : Routes.Route() {
</a><a href="#h7-0-44" id="h7-0-44" class="i">+    private val logListState by lazy { LazyListState(0) }
</a><a href="#h7-0-45" id="h7-0-45" class="i">+    private lateinit var activityLauncherHelper: ActivityLauncherHelper
</a><a href="#h7-0-46" id="h7-0-46" class="i">+
</a><a href="#h7-0-47" id="h7-0-47" class="i">+    override val init: () -&gt; Unit = {
</a><a href="#h7-0-48" id="h7-0-48" class="i">+        activityLauncherHelper = ActivityLauncherHelper(context.activity!!)
</a><a href="#h7-0-49" id="h7-0-49" class="i">+    }
</a><a href="#h7-0-50" id="h7-0-50" class="i">+
</a><a href="#h7-0-51" id="h7-0-51" class="i">+    override val topBarActions: @Composable (RowScope.() -&gt; Unit) = {
</a><a href="#h7-0-52" id="h7-0-52" class="i">+        var showDropDown by remember { mutableStateOf(false) }
</a><a href="#h7-0-53" id="h7-0-53" class="i">+
</a><a href="#h7-0-54" id="h7-0-54" class="i">+        IconButton(onClick = {
</a><a href="#h7-0-55" id="h7-0-55" class="i">+            showDropDown = true
</a><a href="#h7-0-56" id="h7-0-56" class="i">+        }) {
</a><a href="#h7-0-57" id="h7-0-57" class="i">+            Icon(Icons.Filled.MoreVert, contentDescription = null)
</a><a href="#h7-0-58" id="h7-0-58" class="i">+        }
</a><a href="#h7-0-59" id="h7-0-59" class="i">+
</a><a href="#h7-0-60" id="h7-0-60" class="i">+        DropdownMenu(
</a><a href="#h7-0-61" id="h7-0-61" class="i">+            expanded = showDropDown,
</a><a href="#h7-0-62" id="h7-0-62" class="i">+            onDismissRequest = { showDropDown = false },
</a><a href="#h7-0-63" id="h7-0-63" class="i">+            modifier = Modifier.align(Alignment.CenterVertically)
</a><a href="#h7-0-64" id="h7-0-64" class="i">+        ) {
</a><a href="#h7-0-65" id="h7-0-65" class="i">+            DropdownMenuItem(onClick = {
</a><a href="#h7-0-66" id="h7-0-66" class="i">+                context.log.clearLogs()
</a><a href="#h7-0-67" id="h7-0-67" class="i">+                navigate()
</a><a href="#h7-0-68" id="h7-0-68" class="i">+                showDropDown = false
</a><a href="#h7-0-69" id="h7-0-69" class="i">+            }, text = {
</a><a href="#h7-0-70" id="h7-0-70" class="i">+                Text(
</a><a href="#h7-0-71" id="h7-0-71" class="i">+                    text = context.translation[&quot;manager.sections.home.logs.clear_logs_button&quot;]
</a><a href="#h7-0-72" id="h7-0-72" class="i">+                )
</a><a href="#h7-0-73" id="h7-0-73" class="i">+            })
</a><a href="#h7-0-74" id="h7-0-74" class="i">+
</a><a href="#h7-0-75" id="h7-0-75" class="i">+            DropdownMenuItem(onClick = {
</a><a href="#h7-0-76" id="h7-0-76" class="i">+                activityLauncherHelper.saveFile(&quot;snapenhance-logs-${System.currentTimeMillis()}.zip&quot;, &quot;application/zip&quot;) { uri -&gt;
</a><a href="#h7-0-77" id="h7-0-77" class="i">+                    context.androidContext.contentResolver.openOutputStream(Uri.parse(uri))?.use {
</a><a href="#h7-0-78" id="h7-0-78" class="i">+                        runCatching {
</a><a href="#h7-0-79" id="h7-0-79" class="i">+                            context.log.exportLogsToZip(it)
</a><a href="#h7-0-80" id="h7-0-80" class="i">+                            context.longToast(&quot;Saved logs to $uri&quot;)
</a><a href="#h7-0-81" id="h7-0-81" class="i">+                        }.onFailure {
</a><a href="#h7-0-82" id="h7-0-82" class="i">+                            context.longToast(&quot;Failed to save logs to $uri!&quot;)
</a><a href="#h7-0-83" id="h7-0-83" class="i">+                            context.log.error(&quot;Failed to save logs to $uri!&quot;, it)
</a><a href="#h7-0-84" id="h7-0-84" class="i">+                        }
</a><a href="#h7-0-85" id="h7-0-85" class="i">+                    }
</a><a href="#h7-0-86" id="h7-0-86" class="i">+                }
</a><a href="#h7-0-87" id="h7-0-87" class="i">+                showDropDown = false
</a><a href="#h7-0-88" id="h7-0-88" class="i">+            }, text = {
</a><a href="#h7-0-89" id="h7-0-89" class="i">+                Text(
</a><a href="#h7-0-90" id="h7-0-90" class="i">+                    text = context.translation[&quot;manager.sections.home.logs.export_logs_button&quot;]
</a><a href="#h7-0-91" id="h7-0-91" class="i">+                )
</a><a href="#h7-0-92" id="h7-0-92" class="i">+            })
</a><a href="#h7-0-93" id="h7-0-93" class="i">+        }
</a><a href="#h7-0-94" id="h7-0-94" class="i">+    }
</a><a href="#h7-0-95" id="h7-0-95" class="i">+
</a><a href="#h7-0-96" id="h7-0-96" class="i">+    override val content: @Composable (NavBackStackEntry) -&gt; Unit = {
</a><a href="#h7-0-97" id="h7-0-97" class="i">+        val coroutineScope = rememberCoroutineScope()
</a><a href="#h7-0-98" id="h7-0-98" class="i">+        val clipboardManager = LocalClipboardManager.current
</a><a href="#h7-0-99" id="h7-0-99" class="i">+        var lineCount by remember { mutableIntStateOf(0) }
</a><a href="#h7-0-100" id="h7-0-100" class="i">+        var logReader by remember { mutableStateOf&lt;LogReader?&gt;(null) }
</a><a href="#h7-0-101" id="h7-0-101" class="i">+        var isRefreshing by remember { mutableStateOf(false) }
</a><a href="#h7-0-102" id="h7-0-102" class="i">+
</a><a href="#h7-0-103" id="h7-0-103" class="i">+        fun refreshLogs() {
</a><a href="#h7-0-104" id="h7-0-104" class="i">+            coroutineScope.launch(Dispatchers.IO) {
</a><a href="#h7-0-105" id="h7-0-105" class="i">+                runCatching {
</a><a href="#h7-0-106" id="h7-0-106" class="i">+                    logReader = context.log.newReader {
</a><a href="#h7-0-107" id="h7-0-107" class="i">+                        lineCount++
</a><a href="#h7-0-108" id="h7-0-108" class="i">+                    }
</a><a href="#h7-0-109" id="h7-0-109" class="i">+                    lineCount = logReader!!.lineCount
</a><a href="#h7-0-110" id="h7-0-110" class="i">+                }.onFailure {
</a><a href="#h7-0-111" id="h7-0-111" class="i">+                    context.longToast(&quot;Failed to read logs!&quot;)
</a><a href="#h7-0-112" id="h7-0-112" class="i">+                }
</a><a href="#h7-0-113" id="h7-0-113" class="i">+                delay(300)
</a><a href="#h7-0-114" id="h7-0-114" class="i">+                isRefreshing = false
</a><a href="#h7-0-115" id="h7-0-115" class="i">+                withContext(Dispatchers.Main) {
</a><a href="#h7-0-116" id="h7-0-116" class="i">+                    logListState.scrollToItem((logListState.layoutInfo.totalItemsCount - 1).takeIf { it &gt;= 0 } ?: return@withContext)
</a><a href="#h7-0-117" id="h7-0-117" class="i">+                }
</a><a href="#h7-0-118" id="h7-0-118" class="i">+            }
</a><a href="#h7-0-119" id="h7-0-119" class="i">+        }
</a><a href="#h7-0-120" id="h7-0-120" class="i">+
</a><a href="#h7-0-121" id="h7-0-121" class="i">+        val pullRefreshState = rememberPullRefreshState(isRefreshing, onRefresh = {
</a><a href="#h7-0-122" id="h7-0-122" class="i">+            refreshLogs()
</a><a href="#h7-0-123" id="h7-0-123" class="i">+        })
</a><a href="#h7-0-124" id="h7-0-124" class="i">+
</a><a href="#h7-0-125" id="h7-0-125" class="i">+        LaunchedEffect(Unit) {
</a><a href="#h7-0-126" id="h7-0-126" class="i">+            isRefreshing = true
</a><a href="#h7-0-127" id="h7-0-127" class="i">+            refreshLogs()
</a><a href="#h7-0-128" id="h7-0-128" class="i">+        }
</a><a href="#h7-0-129" id="h7-0-129" class="i">+
</a><a href="#h7-0-130" id="h7-0-130" class="i">+        Box(
</a><a href="#h7-0-131" id="h7-0-131" class="i">+            modifier = Modifier
</a><a href="#h7-0-132" id="h7-0-132" class="i">+                .fillMaxSize()
</a><a href="#h7-0-133" id="h7-0-133" class="i">+        ) {
</a><a href="#h7-0-134" id="h7-0-134" class="i">+            LazyColumn(
</a><a href="#h7-0-135" id="h7-0-135" class="i">+                modifier = Modifier
</a><a href="#h7-0-136" id="h7-0-136" class="i">+                    .background(MaterialTheme.colorScheme.surface)
</a><a href="#h7-0-137" id="h7-0-137" class="i">+                    .horizontalScroll(ScrollState(0)),
</a><a href="#h7-0-138" id="h7-0-138" class="i">+                state = logListState
</a><a href="#h7-0-139" id="h7-0-139" class="i">+            ) {
</a><a href="#h7-0-140" id="h7-0-140" class="i">+                item {
</a><a href="#h7-0-141" id="h7-0-141" class="i">+                    if (lineCount == 0 &amp;&amp; logReader != null) {
</a><a href="#h7-0-142" id="h7-0-142" class="i">+                        Text(
</a><a href="#h7-0-143" id="h7-0-143" class="i">+                            text = &quot;No logs found!&quot;,
</a><a href="#h7-0-144" id="h7-0-144" class="i">+                            modifier = Modifier.padding(16.dp),
</a><a href="#h7-0-145" id="h7-0-145" class="i">+                            fontSize = 12.sp,
</a><a href="#h7-0-146" id="h7-0-146" class="i">+                            fontWeight = FontWeight.Light
</a><a href="#h7-0-147" id="h7-0-147" class="i">+                        )
</a><a href="#h7-0-148" id="h7-0-148" class="i">+                    }
</a><a href="#h7-0-149" id="h7-0-149" class="i">+                }
</a><a href="#h7-0-150" id="h7-0-150" class="i">+                items(lineCount) { index -&gt;
</a><a href="#h7-0-151" id="h7-0-151" class="i">+                    val logLine = remember(index) { logReader?.getLogLine(index) } ?: return@items
</a><a href="#h7-0-152" id="h7-0-152" class="i">+                    var expand by remember { mutableStateOf(false) }
</a><a href="#h7-0-153" id="h7-0-153" class="i">+
</a><a href="#h7-0-154" id="h7-0-154" class="i">+                    Box(modifier = Modifier
</a><a href="#h7-0-155" id="h7-0-155" class="i">+                        .fillMaxWidth()
</a><a href="#h7-0-156" id="h7-0-156" class="i">+                        .pointerInput(Unit) {
</a><a href="#h7-0-157" id="h7-0-157" class="i">+                            detectTapGestures(
</a><a href="#h7-0-158" id="h7-0-158" class="i">+                                onLongPress = {
</a><a href="#h7-0-159" id="h7-0-159" class="i">+                                    coroutineScope.launch {
</a><a href="#h7-0-160" id="h7-0-160" class="i">+                                        clipboardManager.setText(AnnotatedString(logLine.message))
</a><a href="#h7-0-161" id="h7-0-161" class="i">+                                    }
</a><a href="#h7-0-162" id="h7-0-162" class="i">+                                },
</a><a href="#h7-0-163" id="h7-0-163" class="i">+                                onTap = {
</a><a href="#h7-0-164" id="h7-0-164" class="i">+                                    expand = !expand
</a><a href="#h7-0-165" id="h7-0-165" class="i">+                                }
</a><a href="#h7-0-166" id="h7-0-166" class="i">+                            )
</a><a href="#h7-0-167" id="h7-0-167" class="i">+                        }) {
</a><a href="#h7-0-168" id="h7-0-168" class="i">+
</a><a href="#h7-0-169" id="h7-0-169" class="i">+                        Row(
</a><a href="#h7-0-170" id="h7-0-170" class="i">+                            modifier = Modifier
</a><a href="#h7-0-171" id="h7-0-171" class="i">+                                .padding(4.dp)
</a><a href="#h7-0-172" id="h7-0-172" class="i">+                                .fillMaxWidth()
</a><a href="#h7-0-173" id="h7-0-173" class="i">+                                .defaultMinSize(minHeight = 30.dp),
</a><a href="#h7-0-174" id="h7-0-174" class="i">+                            verticalAlignment = Alignment.CenterVertically
</a><a href="#h7-0-175" id="h7-0-175" class="i">+                        ) {
</a><a href="#h7-0-176" id="h7-0-176" class="i">+                            if (!expand) {
</a><a href="#h7-0-177" id="h7-0-177" class="i">+                                Icon(
</a><a href="#h7-0-178" id="h7-0-178" class="i">+                                    imageVector = when (logLine.logLevel) {
</a><a href="#h7-0-179" id="h7-0-179" class="i">+                                        LogLevel.DEBUG -&gt; Icons.Outlined.BugReport
</a><a href="#h7-0-180" id="h7-0-180" class="i">+                                        LogLevel.ERROR, LogLevel.ASSERT -&gt; Icons.Outlined.Report
</a><a href="#h7-0-181" id="h7-0-181" class="i">+                                        LogLevel.INFO, LogLevel.VERBOSE -&gt; Icons.Outlined.Info
</a><a href="#h7-0-182" id="h7-0-182" class="i">+                                        LogLevel.WARN -&gt; Icons.Outlined.Warning
</a><a href="#h7-0-183" id="h7-0-183" class="i">+                                    },
</a><a href="#h7-0-184" id="h7-0-184" class="i">+                                    contentDescription = null,
</a><a href="#h7-0-185" id="h7-0-185" class="i">+                                )
</a><a href="#h7-0-186" id="h7-0-186" class="i">+
</a><a href="#h7-0-187" id="h7-0-187" class="i">+                                Text(
</a><a href="#h7-0-188" id="h7-0-188" class="i">+                                    text = LogChannel.fromChannel(logLine.tag)?.shortName ?: logLine.tag,
</a><a href="#h7-0-189" id="h7-0-189" class="i">+                                    modifier = Modifier.padding(start = 4.dp),
</a><a href="#h7-0-190" id="h7-0-190" class="i">+                                    fontWeight = FontWeight.Light,
</a><a href="#h7-0-191" id="h7-0-191" class="i">+                                    fontSize = 10.sp,
</a><a href="#h7-0-192" id="h7-0-192" class="i">+                                )
</a><a href="#h7-0-193" id="h7-0-193" class="i">+
</a><a href="#h7-0-194" id="h7-0-194" class="i">+                                Text(
</a><a href="#h7-0-195" id="h7-0-195" class="i">+                                    text = logLine.dateTime,
</a><a href="#h7-0-196" id="h7-0-196" class="i">+                                    modifier = Modifier.padding(start = 4.dp, end = 4.dp),
</a><a href="#h7-0-197" id="h7-0-197" class="i">+                                    fontSize = 10.sp
</a><a href="#h7-0-198" id="h7-0-198" class="i">+                                )
</a><a href="#h7-0-199" id="h7-0-199" class="i">+                            }
</a><a href="#h7-0-200" id="h7-0-200" class="i">+
</a><a href="#h7-0-201" id="h7-0-201" class="i">+                            Text(
</a><a href="#h7-0-202" id="h7-0-202" class="i">+                                text = logLine.message.trimIndent(),
</a><a href="#h7-0-203" id="h7-0-203" class="i">+                                fontSize = 10.sp,
</a><a href="#h7-0-204" id="h7-0-204" class="i">+                                maxLines = if (expand) Int.MAX_VALUE else 6,
</a><a href="#h7-0-205" id="h7-0-205" class="i">+                                overflow = if (expand) TextOverflow.Visible else TextOverflow.Ellipsis,
</a><a href="#h7-0-206" id="h7-0-206" class="i">+                                softWrap = !expand,
</a><a href="#h7-0-207" id="h7-0-207" class="i">+                            )
</a><a href="#h7-0-208" id="h7-0-208" class="i">+                        }
</a><a href="#h7-0-209" id="h7-0-209" class="i">+                    }
</a><a href="#h7-0-210" id="h7-0-210" class="i">+                }
</a><a href="#h7-0-211" id="h7-0-211" class="i">+            }
</a><a href="#h7-0-212" id="h7-0-212" class="i">+
</a><a href="#h7-0-213" id="h7-0-213" class="i">+            PullRefreshIndicator(
</a><a href="#h7-0-214" id="h7-0-214" class="i">+                refreshing = isRefreshing,
</a><a href="#h7-0-215" id="h7-0-215" class="i">+                state = pullRefreshState,
</a><a href="#h7-0-216" id="h7-0-216" class="i">+                modifier = Modifier.align(Alignment.TopCenter)
</a><a href="#h7-0-217" id="h7-0-217" class="i">+            )
</a><a href="#h7-0-218" id="h7-0-218" class="i">+        }
</a><a href="#h7-0-219" id="h7-0-219" class="i">+    }
</a><a href="#h7-0-220" id="h7-0-220" class="i">+
</a><a href="#h7-0-221" id="h7-0-221" class="i">+    override val floatingActionButton: @Composable () -&gt; Unit = {
</a><a href="#h7-0-222" id="h7-0-222" class="i">+        val coroutineScope = rememberCoroutineScope()
</a><a href="#h7-0-223" id="h7-0-223" class="i">+        Column(
</a><a href="#h7-0-224" id="h7-0-224" class="i">+            verticalArrangement = Arrangement.spacedBy(5.dp),
</a><a href="#h7-0-225" id="h7-0-225" class="i">+        ) {
</a><a href="#h7-0-226" id="h7-0-226" class="i">+            val firstVisibleItem by remember { derivedStateOf { logListState.firstVisibleItemIndex } }
</a><a href="#h7-0-227" id="h7-0-227" class="i">+            val layoutInfo by remember { derivedStateOf { logListState.layoutInfo } }
</a><a href="#h7-0-228" id="h7-0-228" class="i">+            FilledIconButton(
</a><a href="#h7-0-229" id="h7-0-229" class="i">+                onClick = {
</a><a href="#h7-0-230" id="h7-0-230" class="i">+                    coroutineScope.launch {
</a><a href="#h7-0-231" id="h7-0-231" class="i">+                        logListState.scrollToItem(0)
</a><a href="#h7-0-232" id="h7-0-232" class="i">+                    }
</a><a href="#h7-0-233" id="h7-0-233" class="i">+                },
</a><a href="#h7-0-234" id="h7-0-234" class="i">+                enabled = firstVisibleItem != 0
</a><a href="#h7-0-235" id="h7-0-235" class="i">+            ) {
</a><a href="#h7-0-236" id="h7-0-236" class="i">+                Icon(Icons.Filled.KeyboardDoubleArrowUp, contentDescription = null)
</a><a href="#h7-0-237" id="h7-0-237" class="i">+            }
</a><a href="#h7-0-238" id="h7-0-238" class="i">+
</a><a href="#h7-0-239" id="h7-0-239" class="i">+            FilledIconButton(
</a><a href="#h7-0-240" id="h7-0-240" class="i">+                onClick = {
</a><a href="#h7-0-241" id="h7-0-241" class="i">+                    coroutineScope.launch {
</a><a href="#h7-0-242" id="h7-0-242" class="i">+                        logListState.scrollToItem((logListState.layoutInfo.totalItemsCount - 1).takeIf { it &gt;= 0 } ?: return@launch)
</a><a href="#h7-0-243" id="h7-0-243" class="i">+                    }
</a><a href="#h7-0-244" id="h7-0-244" class="i">+                },
</a><a href="#h7-0-245" id="h7-0-245" class="i">+                enabled = layoutInfo.visibleItemsInfo.lastOrNull()?.index != layoutInfo.totalItemsCount - 1
</a><a href="#h7-0-246" id="h7-0-246" class="i">+            ) {
</a><a href="#h7-0-247" id="h7-0-247" class="i">+                Icon(Icons.Filled.KeyboardDoubleArrowDown, contentDescription = null)
</a><a href="#h7-0-248" id="h7-0-248" class="i">+            }
</a><a href="#h7-0-249" id="h7-0-249" class="i">+        }
</a><a href="#h7-0-250" id="h7-0-250" class="i">+    }
</a><a href="#h7-0-251" id="h7-0-251" class="i">+}</a><a href="#h7-0-252" id="h7-0-252" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h8" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/home/HomeRoot.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/home/HomeRoot.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/home/HomeRoot.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/home/HomeRoot.kt</a></b>
<a href="#h8-0" id="h8-0" class="h">@@ -0,0 +1,277 @@
</a><a href="#h8-0-0" id="h8-0-0" class="i">+package me.rhunk.snapenhance.ui.manager.pages.home
</a><a href="#h8-0-1" id="h8-0-1" class="i">+
</a><a href="#h8-0-2" id="h8-0-2" class="i">+import android.content.Intent
</a><a href="#h8-0-3" id="h8-0-3" class="i">+import android.net.Uri
</a><a href="#h8-0-4" id="h8-0-4" class="i">+import androidx.compose.foundation.Image
</a><a href="#h8-0-5" id="h8-0-5" class="i">+import androidx.compose.foundation.ScrollState
</a><a href="#h8-0-6" id="h8-0-6" class="i">+import androidx.compose.foundation.clickable
</a><a href="#h8-0-7" id="h8-0-7" class="i">+import androidx.compose.foundation.layout.*
</a><a href="#h8-0-8" id="h8-0-8" class="i">+import androidx.compose.foundation.verticalScroll
</a><a href="#h8-0-9" id="h8-0-9" class="i">+import androidx.compose.material.icons.Icons
</a><a href="#h8-0-10" id="h8-0-10" class="i">+import androidx.compose.material.icons.filled.BugReport
</a><a href="#h8-0-11" id="h8-0-11" class="i">+import androidx.compose.material.icons.filled.Settings
</a><a href="#h8-0-12" id="h8-0-12" class="i">+import androidx.compose.material3.*
</a><a href="#h8-0-13" id="h8-0-13" class="i">+import androidx.compose.runtime.*
</a><a href="#h8-0-14" id="h8-0-14" class="i">+import androidx.compose.ui.Alignment
</a><a href="#h8-0-15" id="h8-0-15" class="i">+import androidx.compose.ui.Modifier
</a><a href="#h8-0-16" id="h8-0-16" class="i">+import androidx.compose.ui.draw.scale
</a><a href="#h8-0-17" id="h8-0-17" class="i">+import androidx.compose.ui.graphics.ColorFilter
</a><a href="#h8-0-18" id="h8-0-18" class="i">+import androidx.compose.ui.graphics.vector.ImageVector
</a><a href="#h8-0-19" id="h8-0-19" class="i">+import androidx.compose.ui.layout.ContentScale
</a><a href="#h8-0-20" id="h8-0-20" class="i">+import androidx.compose.ui.res.painterResource
</a><a href="#h8-0-21" id="h8-0-21" class="i">+import androidx.compose.ui.res.vectorResource
</a><a href="#h8-0-22" id="h8-0-22" class="i">+import androidx.compose.ui.text.font.Font
</a><a href="#h8-0-23" id="h8-0-23" class="i">+import androidx.compose.ui.text.font.FontFamily
</a><a href="#h8-0-24" id="h8-0-24" class="i">+import androidx.compose.ui.text.font.FontWeight
</a><a href="#h8-0-25" id="h8-0-25" class="i">+import androidx.compose.ui.text.style.TextAlign
</a><a href="#h8-0-26" id="h8-0-26" class="i">+import androidx.compose.ui.unit.dp
</a><a href="#h8-0-27" id="h8-0-27" class="i">+import androidx.compose.ui.unit.sp
</a><a href="#h8-0-28" id="h8-0-28" class="i">+import androidx.lifecycle.Lifecycle
</a><a href="#h8-0-29" id="h8-0-29" class="i">+import androidx.navigation.NavBackStackEntry
</a><a href="#h8-0-30" id="h8-0-30" class="i">+import kotlinx.coroutines.CoroutineScope
</a><a href="#h8-0-31" id="h8-0-31" class="i">+import kotlinx.coroutines.Dispatchers
</a><a href="#h8-0-32" id="h8-0-32" class="i">+import kotlinx.coroutines.launch
</a><a href="#h8-0-33" id="h8-0-33" class="i">+import me.rhunk.snapenhance.R
</a><a href="#h8-0-34" id="h8-0-34" class="i">+import me.rhunk.snapenhance.common.BuildConfig
</a><a href="#h8-0-35" id="h8-0-35" class="i">+import me.rhunk.snapenhance.ui.manager.Routes
</a><a href="#h8-0-36" id="h8-0-36" class="i">+import me.rhunk.snapenhance.ui.manager.data.InstallationSummary
</a><a href="#h8-0-37" id="h8-0-37" class="i">+import me.rhunk.snapenhance.ui.manager.data.Updater
</a><a href="#h8-0-38" id="h8-0-38" class="i">+import me.rhunk.snapenhance.ui.util.ActivityLauncherHelper
</a><a href="#h8-0-39" id="h8-0-39" class="i">+import me.rhunk.snapenhance.ui.util.OnLifecycleEvent
</a><a href="#h8-0-40" id="h8-0-40" class="i">+
</a><a href="#h8-0-41" id="h8-0-41" class="i">+class HomeRoot : Routes.Route() {
</a><a href="#h8-0-42" id="h8-0-42" class="i">+    companion object {
</a><a href="#h8-0-43" id="h8-0-43" class="i">+        val cardMargin = 10.dp
</a><a href="#h8-0-44" id="h8-0-44" class="i">+    }
</a><a href="#h8-0-45" id="h8-0-45" class="i">+
</a><a href="#h8-0-46" id="h8-0-46" class="i">+    private lateinit var activityLauncherHelper: ActivityLauncherHelper
</a><a href="#h8-0-47" id="h8-0-47" class="i">+
</a><a href="#h8-0-48" id="h8-0-48" class="i">+    override val init: () -&gt; Unit = {
</a><a href="#h8-0-49" id="h8-0-49" class="i">+        activityLauncherHelper = ActivityLauncherHelper(context.activity!!)
</a><a href="#h8-0-50" id="h8-0-50" class="i">+    }
</a><a href="#h8-0-51" id="h8-0-51" class="i">+
</a><a href="#h8-0-52" id="h8-0-52" class="i">+    @Composable
</a><a href="#h8-0-53" id="h8-0-53" class="i">+    private fun SummaryCards(installationSummary: InstallationSummary) {
</a><a href="#h8-0-54" id="h8-0-54" class="i">+        val summaryInfo = remember {
</a><a href="#h8-0-55" id="h8-0-55" class="i">+            mapOf(
</a><a href="#h8-0-56" id="h8-0-56" class="i">+                &quot;Build Issuer&quot; to (installationSummary.modInfo?.buildIssuer ?: &quot;Unknown&quot;),
</a><a href="#h8-0-57" id="h8-0-57" class="i">+                &quot;Build Type&quot; to (if (installationSummary.modInfo?.isDebugBuild == true) &quot;debug&quot; else &quot;release&quot;),
</a><a href="#h8-0-58" id="h8-0-58" class="i">+                &quot;Build Version&quot; to (installationSummary.modInfo?.buildVersion ?: &quot;Unknown&quot;),
</a><a href="#h8-0-59" id="h8-0-59" class="i">+                &quot;Build Package&quot; to (installationSummary.modInfo?.buildPackageName ?: &quot;Unknown&quot;),
</a><a href="#h8-0-60" id="h8-0-60" class="i">+                &quot;Activity Package&quot; to (installationSummary.modInfo?.loaderPackageName ?: &quot;Unknown&quot;),
</a><a href="#h8-0-61" id="h8-0-61" class="i">+                &quot;Device&quot; to installationSummary.platformInfo.device,
</a><a href="#h8-0-62" id="h8-0-62" class="i">+                &quot;Android Version&quot; to installationSummary.platformInfo.androidVersion,
</a><a href="#h8-0-63" id="h8-0-63" class="i">+                &quot;System ABI&quot; to installationSummary.platformInfo.systemAbi
</a><a href="#h8-0-64" id="h8-0-64" class="i">+            )
</a><a href="#h8-0-65" id="h8-0-65" class="i">+        }
</a><a href="#h8-0-66" id="h8-0-66" class="i">+
</a><a href="#h8-0-67" id="h8-0-67" class="i">+        Card(
</a><a href="#h8-0-68" id="h8-0-68" class="i">+            modifier = Modifier
</a><a href="#h8-0-69" id="h8-0-69" class="i">+                .padding(all = cardMargin)
</a><a href="#h8-0-70" id="h8-0-70" class="i">+                .fillMaxWidth(),
</a><a href="#h8-0-71" id="h8-0-71" class="i">+            colors = CardDefaults.cardColors(
</a><a href="#h8-0-72" id="h8-0-72" class="i">+                containerColor = MaterialTheme.colorScheme.surfaceVariant,
</a><a href="#h8-0-73" id="h8-0-73" class="i">+                contentColor = MaterialTheme.colorScheme.onSurfaceVariant
</a><a href="#h8-0-74" id="h8-0-74" class="i">+            )
</a><a href="#h8-0-75" id="h8-0-75" class="i">+        ) {
</a><a href="#h8-0-76" id="h8-0-76" class="i">+            Column(
</a><a href="#h8-0-77" id="h8-0-77" class="i">+                modifier = Modifier
</a><a href="#h8-0-78" id="h8-0-78" class="i">+                    .fillMaxWidth()
</a><a href="#h8-0-79" id="h8-0-79" class="i">+                    .padding(all = 10.dp),
</a><a href="#h8-0-80" id="h8-0-80" class="i">+            ) {
</a><a href="#h8-0-81" id="h8-0-81" class="i">+                summaryInfo.forEach { (title, value) -&gt;
</a><a href="#h8-0-82" id="h8-0-82" class="i">+                    Column(
</a><a href="#h8-0-83" id="h8-0-83" class="i">+                        modifier = Modifier
</a><a href="#h8-0-84" id="h8-0-84" class="i">+                            .fillMaxWidth()
</a><a href="#h8-0-85" id="h8-0-85" class="i">+                            .padding(all = 5.dp),
</a><a href="#h8-0-86" id="h8-0-86" class="i">+                    ) {
</a><a href="#h8-0-87" id="h8-0-87" class="i">+                        Text(
</a><a href="#h8-0-88" id="h8-0-88" class="i">+                            text = title,
</a><a href="#h8-0-89" id="h8-0-89" class="i">+                            fontSize = 12.sp,
</a><a href="#h8-0-90" id="h8-0-90" class="i">+                            fontWeight = FontWeight.Light,
</a><a href="#h8-0-91" id="h8-0-91" class="i">+                        )
</a><a href="#h8-0-92" id="h8-0-92" class="i">+                        Text(
</a><a href="#h8-0-93" id="h8-0-93" class="i">+                            fontSize = 14.sp,
</a><a href="#h8-0-94" id="h8-0-94" class="i">+                            text = value,
</a><a href="#h8-0-95" id="h8-0-95" class="i">+                            lineHeight = 20.sp
</a><a href="#h8-0-96" id="h8-0-96" class="i">+                        )
</a><a href="#h8-0-97" id="h8-0-97" class="i">+                    }
</a><a href="#h8-0-98" id="h8-0-98" class="i">+                }
</a><a href="#h8-0-99" id="h8-0-99" class="i">+            }
</a><a href="#h8-0-100" id="h8-0-100" class="i">+        }
</a><a href="#h8-0-101" id="h8-0-101" class="i">+    }
</a><a href="#h8-0-102" id="h8-0-102" class="i">+
</a><a href="#h8-0-103" id="h8-0-103" class="i">+    override val topBarActions: @Composable (RowScope.() -&gt; Unit) = {
</a><a href="#h8-0-104" id="h8-0-104" class="i">+        IconButton(onClick = {
</a><a href="#h8-0-105" id="h8-0-105" class="i">+            routes.homeLogs.navigate()
</a><a href="#h8-0-106" id="h8-0-106" class="i">+        }) {
</a><a href="#h8-0-107" id="h8-0-107" class="i">+            Icon(Icons.Filled.BugReport, contentDescription = null)
</a><a href="#h8-0-108" id="h8-0-108" class="i">+        }
</a><a href="#h8-0-109" id="h8-0-109" class="i">+        IconButton(onClick = {
</a><a href="#h8-0-110" id="h8-0-110" class="i">+            routes.settings.navigate()
</a><a href="#h8-0-111" id="h8-0-111" class="i">+        }) {
</a><a href="#h8-0-112" id="h8-0-112" class="i">+            Icon(Icons.Filled.Settings, contentDescription = null)
</a><a href="#h8-0-113" id="h8-0-113" class="i">+        }
</a><a href="#h8-0-114" id="h8-0-114" class="i">+    }
</a><a href="#h8-0-115" id="h8-0-115" class="i">+
</a><a href="#h8-0-116" id="h8-0-116" class="i">+    override val content: @Composable (NavBackStackEntry) -&gt; Unit = {
</a><a href="#h8-0-117" id="h8-0-117" class="i">+        val avenirNextFontFamily = remember {
</a><a href="#h8-0-118" id="h8-0-118" class="i">+            FontFamily(
</a><a href="#h8-0-119" id="h8-0-119" class="i">+                Font(R.font.avenir_next_medium, FontWeight.Medium)
</a><a href="#h8-0-120" id="h8-0-120" class="i">+            )
</a><a href="#h8-0-121" id="h8-0-121" class="i">+        }
</a><a href="#h8-0-122" id="h8-0-122" class="i">+
</a><a href="#h8-0-123" id="h8-0-123" class="i">+        var latestUpdate by remember { mutableStateOf&lt;Updater.LatestRelease?&gt;(null) }
</a><a href="#h8-0-124" id="h8-0-124" class="i">+
</a><a href="#h8-0-125" id="h8-0-125" class="i">+        Column(
</a><a href="#h8-0-126" id="h8-0-126" class="i">+            modifier = Modifier
</a><a href="#h8-0-127" id="h8-0-127" class="i">+                .verticalScroll(ScrollState(0))
</a><a href="#h8-0-128" id="h8-0-128" class="i">+        ) {
</a><a href="#h8-0-129" id="h8-0-129" class="i">+
</a><a href="#h8-0-130" id="h8-0-130" class="i">+            Image(
</a><a href="#h8-0-131" id="h8-0-131" class="i">+                painter = painterResource(id = R.drawable.launcher_icon_monochrome),
</a><a href="#h8-0-132" id="h8-0-132" class="i">+                contentDescription = null,
</a><a href="#h8-0-133" id="h8-0-133" class="i">+                colorFilter = ColorFilter.tint(MaterialTheme.colorScheme.primary),
</a><a href="#h8-0-134" id="h8-0-134" class="i">+                contentScale = ContentScale.FillHeight,
</a><a href="#h8-0-135" id="h8-0-135" class="i">+                modifier = Modifier
</a><a href="#h8-0-136" id="h8-0-136" class="i">+                    .fillMaxWidth()
</a><a href="#h8-0-137" id="h8-0-137" class="i">+                    .scale(1.8f)
</a><a href="#h8-0-138" id="h8-0-138" class="i">+                    .height(90.dp)
</a><a href="#h8-0-139" id="h8-0-139" class="i">+            )
</a><a href="#h8-0-140" id="h8-0-140" class="i">+
</a><a href="#h8-0-141" id="h8-0-141" class="i">+            Text(
</a><a href="#h8-0-142" id="h8-0-142" class="i">+                text = remember { intArrayOf(101,99,110,97,104,110,69,112,97,110,83).map { it.toChar() }.joinToString(&quot;&quot;).reversed() },
</a><a href="#h8-0-143" id="h8-0-143" class="i">+                fontSize = 30.sp,
</a><a href="#h8-0-144" id="h8-0-144" class="i">+                fontFamily = avenirNextFontFamily,
</a><a href="#h8-0-145" id="h8-0-145" class="i">+                modifier = Modifier.align(Alignment.CenterHorizontally),
</a><a href="#h8-0-146" id="h8-0-146" class="i">+            )
</a><a href="#h8-0-147" id="h8-0-147" class="i">+
</a><a href="#h8-0-148" id="h8-0-148" class="i">+            Text(
</a><a href="#h8-0-149" id="h8-0-149" class="i">+                text = &quot;v&quot; + BuildConfig.VERSION_NAME + &quot; \u00b7 by rhunk&quot;,
</a><a href="#h8-0-150" id="h8-0-150" class="i">+                fontSize = 12.sp,
</a><a href="#h8-0-151" id="h8-0-151" class="i">+                fontFamily = avenirNextFontFamily,
</a><a href="#h8-0-152" id="h8-0-152" class="i">+                modifier = Modifier.align(Alignment.CenterHorizontally),
</a><a href="#h8-0-153" id="h8-0-153" class="i">+            )
</a><a href="#h8-0-154" id="h8-0-154" class="i">+
</a><a href="#h8-0-155" id="h8-0-155" class="i">+            Text(
</a><a href="#h8-0-156" id="h8-0-156" class="i">+                text = &quot;An xposed module made to enhance your Snapchat experience&quot;,
</a><a href="#h8-0-157" id="h8-0-157" class="i">+                modifier = Modifier
</a><a href="#h8-0-158" id="h8-0-158" class="i">+                    .padding(16.dp)
</a><a href="#h8-0-159" id="h8-0-159" class="i">+                    .fillMaxWidth(),
</a><a href="#h8-0-160" id="h8-0-160" class="i">+                textAlign = TextAlign.Center,
</a><a href="#h8-0-161" id="h8-0-161" class="i">+            )
</a><a href="#h8-0-162" id="h8-0-162" class="i">+
</a><a href="#h8-0-163" id="h8-0-163" class="i">+            Row(
</a><a href="#h8-0-164" id="h8-0-164" class="i">+                horizontalArrangement = Arrangement.spacedBy(15.dp, Alignment.CenterHorizontally),
</a><a href="#h8-0-165" id="h8-0-165" class="i">+                modifier = Modifier
</a><a href="#h8-0-166" id="h8-0-166" class="i">+                    .fillMaxWidth()
</a><a href="#h8-0-167" id="h8-0-167" class="i">+                    .padding(all = 10.dp)
</a><a href="#h8-0-168" id="h8-0-168" class="i">+            ) {
</a><a href="#h8-0-169" id="h8-0-169" class="i">+                Icon(
</a><a href="#h8-0-170" id="h8-0-170" class="i">+                    imageVector = ImageVector.vectorResource(id = R.drawable.ic_github),
</a><a href="#h8-0-171" id="h8-0-171" class="i">+                    contentDescription = null,
</a><a href="#h8-0-172" id="h8-0-172" class="i">+                    tint = MaterialTheme.colorScheme.onSurfaceVariant,
</a><a href="#h8-0-173" id="h8-0-173" class="i">+                    modifier = Modifier.size(32.dp).clickable {
</a><a href="#h8-0-174" id="h8-0-174" class="i">+                        context.activity?.startActivity(
</a><a href="#h8-0-175" id="h8-0-175" class="i">+                            Intent(Intent.ACTION_VIEW).apply {
</a><a href="#h8-0-176" id="h8-0-176" class="i">+                                data = Uri.parse(
</a><a href="#h8-0-177" id="h8-0-177" class="i">+                                    intArrayOf(101,99,110,97,104,110,69,112,97,110,83,47,107,110,117,104,114,47,109,111,99,46,98,117,104,116,105,103,47,47,58,115,112,116,116,104).map { it.toChar() }.joinToString(&quot;&quot;).reversed()
</a><a href="#h8-0-178" id="h8-0-178" class="i">+                                )
</a><a href="#h8-0-179" id="h8-0-179" class="i">+                                flags = Intent.FLAG_ACTIVITY_NEW_TASK
</a><a href="#h8-0-180" id="h8-0-180" class="i">+                            }
</a><a href="#h8-0-181" id="h8-0-181" class="i">+                        )
</a><a href="#h8-0-182" id="h8-0-182" class="i">+                    }
</a><a href="#h8-0-183" id="h8-0-183" class="i">+                )
</a><a href="#h8-0-184" id="h8-0-184" class="i">+                Icon(
</a><a href="#h8-0-185" id="h8-0-185" class="i">+                    imageVector = ImageVector.vectorResource(id = R.drawable.ic_telegram),
</a><a href="#h8-0-186" id="h8-0-186" class="i">+                    contentDescription = null,
</a><a href="#h8-0-187" id="h8-0-187" class="i">+                    tint = MaterialTheme.colorScheme.onSurfaceVariant,
</a><a href="#h8-0-188" id="h8-0-188" class="i">+                    modifier = Modifier.size(32.dp).clickable {
</a><a href="#h8-0-189" id="h8-0-189" class="i">+                        context.activity?.startActivity(
</a><a href="#h8-0-190" id="h8-0-190" class="i">+                            Intent(Intent.ACTION_VIEW).apply {
</a><a href="#h8-0-191" id="h8-0-191" class="i">+                                data = Uri.parse(
</a><a href="#h8-0-192" id="h8-0-192" class="i">+                                    intArrayOf(101,99,110,97,104,110,101,112,97,110,115,47,101,109,46,116,47,47,58,115,112,116,116,104).map { it.toChar() }.joinToString(&quot;&quot;).reversed()
</a><a href="#h8-0-193" id="h8-0-193" class="i">+                                )
</a><a href="#h8-0-194" id="h8-0-194" class="i">+                                flags = Intent.FLAG_ACTIVITY_NEW_TASK
</a><a href="#h8-0-195" id="h8-0-195" class="i">+                            }
</a><a href="#h8-0-196" id="h8-0-196" class="i">+                        )
</a><a href="#h8-0-197" id="h8-0-197" class="i">+                    }
</a><a href="#h8-0-198" id="h8-0-198" class="i">+                )
</a><a href="#h8-0-199" id="h8-0-199" class="i">+            }
</a><a href="#h8-0-200" id="h8-0-200" class="i">+            Spacer(modifier = Modifier.height(20.dp))
</a><a href="#h8-0-201" id="h8-0-201" class="i">+
</a><a href="#h8-0-202" id="h8-0-202" class="i">+            if (latestUpdate != null) {
</a><a href="#h8-0-203" id="h8-0-203" class="i">+                OutlinedCard(
</a><a href="#h8-0-204" id="h8-0-204" class="i">+                    modifier = Modifier
</a><a href="#h8-0-205" id="h8-0-205" class="i">+                        .padding(all = cardMargin)
</a><a href="#h8-0-206" id="h8-0-206" class="i">+                        .fillMaxWidth(),
</a><a href="#h8-0-207" id="h8-0-207" class="i">+                    colors = CardDefaults.cardColors(
</a><a href="#h8-0-208" id="h8-0-208" class="i">+                        containerColor = MaterialTheme.colorScheme.surfaceVariant,
</a><a href="#h8-0-209" id="h8-0-209" class="i">+                        contentColor = MaterialTheme.colorScheme.onSurfaceVariant
</a><a href="#h8-0-210" id="h8-0-210" class="i">+                    )
</a><a href="#h8-0-211" id="h8-0-211" class="i">+                ){
</a><a href="#h8-0-212" id="h8-0-212" class="i">+                    Row(
</a><a href="#h8-0-213" id="h8-0-213" class="i">+                        modifier = Modifier
</a><a href="#h8-0-214" id="h8-0-214" class="i">+                            .fillMaxWidth()
</a><a href="#h8-0-215" id="h8-0-215" class="i">+                            .padding(all = 15.dp),
</a><a href="#h8-0-216" id="h8-0-216" class="i">+                        horizontalArrangement = Arrangement.SpaceBetween
</a><a href="#h8-0-217" id="h8-0-217" class="i">+                    ) {
</a><a href="#h8-0-218" id="h8-0-218" class="i">+                        Column {
</a><a href="#h8-0-219" id="h8-0-219" class="i">+                            Text(
</a><a href="#h8-0-220" id="h8-0-220" class="i">+                                text = &quot;SnapEnhance Update&quot;,
</a><a href="#h8-0-221" id="h8-0-221" class="i">+                                fontSize = 14.sp,
</a><a href="#h8-0-222" id="h8-0-222" class="i">+                                fontWeight = FontWeight.Bold,
</a><a href="#h8-0-223" id="h8-0-223" class="i">+                            )
</a><a href="#h8-0-224" id="h8-0-224" class="i">+                            Text(
</a><a href="#h8-0-225" id="h8-0-225" class="i">+                                fontSize = 12.sp,
</a><a href="#h8-0-226" id="h8-0-226" class="i">+                                text = &quot;Version ${latestUpdate?.versionName} is available!&quot;,
</a><a href="#h8-0-227" id="h8-0-227" class="i">+                                lineHeight = 20.sp
</a><a href="#h8-0-228" id="h8-0-228" class="i">+                            )
</a><a href="#h8-0-229" id="h8-0-229" class="i">+                        }
</a><a href="#h8-0-230" id="h8-0-230" class="i">+                        Button(onClick = {
</a><a href="#h8-0-231" id="h8-0-231" class="i">+                            context.activity?.startActivity(
</a><a href="#h8-0-232" id="h8-0-232" class="i">+                                Intent(Intent.ACTION_VIEW).apply {
</a><a href="#h8-0-233" id="h8-0-233" class="i">+                                    data = Uri.parse(latestUpdate?.releaseUrl)
</a><a href="#h8-0-234" id="h8-0-234" class="i">+                                }
</a><a href="#h8-0-235" id="h8-0-235" class="i">+                            )
</a><a href="#h8-0-236" id="h8-0-236" class="i">+                        }, modifier = Modifier.height(40.dp)) {
</a><a href="#h8-0-237" id="h8-0-237" class="i">+                            Text(text = &quot;Download&quot;)
</a><a href="#h8-0-238" id="h8-0-238" class="i">+                        }
</a><a href="#h8-0-239" id="h8-0-239" class="i">+                    }
</a><a href="#h8-0-240" id="h8-0-240" class="i">+                }
</a><a href="#h8-0-241" id="h8-0-241" class="i">+            }
</a><a href="#h8-0-242" id="h8-0-242" class="i">+
</a><a href="#h8-0-243" id="h8-0-243" class="i">+            val coroutineScope = rememberCoroutineScope()
</a><a href="#h8-0-244" id="h8-0-244" class="i">+            var installationSummary by remember { mutableStateOf(null as InstallationSummary?) }
</a><a href="#h8-0-245" id="h8-0-245" class="i">+
</a><a href="#h8-0-246" id="h8-0-246" class="i">+            fun updateInstallationSummary(scope: CoroutineScope) {
</a><a href="#h8-0-247" id="h8-0-247" class="i">+                scope.launch(Dispatchers.IO) {
</a><a href="#h8-0-248" id="h8-0-248" class="i">+                    runCatching {
</a><a href="#h8-0-249" id="h8-0-249" class="i">+                        installationSummary = context.installationSummary
</a><a href="#h8-0-250" id="h8-0-250" class="i">+                    }.onFailure {
</a><a href="#h8-0-251" id="h8-0-251" class="i">+                        context.longToast(&quot;SnapEnhance failed to load installation summary: ${it.message}&quot;)
</a><a href="#h8-0-252" id="h8-0-252" class="i">+                    }
</a><a href="#h8-0-253" id="h8-0-253" class="i">+                    runCatching {
</a><a href="#h8-0-254" id="h8-0-254" class="i">+                        if (!BuildConfig.DEBUG) {
</a><a href="#h8-0-255" id="h8-0-255" class="i">+                            latestUpdate = Updater.checkForLatestRelease()
</a><a href="#h8-0-256" id="h8-0-256" class="i">+                        }
</a><a href="#h8-0-257" id="h8-0-257" class="i">+                    }.onFailure {
</a><a href="#h8-0-258" id="h8-0-258" class="i">+                        context.longToast(&quot;SnapEnhance failed to check for updates: ${it.message}&quot;)
</a><a href="#h8-0-259" id="h8-0-259" class="i">+                    }
</a><a href="#h8-0-260" id="h8-0-260" class="i">+                }
</a><a href="#h8-0-261" id="h8-0-261" class="i">+            }
</a><a href="#h8-0-262" id="h8-0-262" class="i">+
</a><a href="#h8-0-263" id="h8-0-263" class="i">+            OnLifecycleEvent { _, event -&gt;
</a><a href="#h8-0-264" id="h8-0-264" class="i">+                if (event == Lifecycle.Event.ON_RESUME) {
</a><a href="#h8-0-265" id="h8-0-265" class="i">+                    updateInstallationSummary(coroutineScope)
</a><a href="#h8-0-266" id="h8-0-266" class="i">+                }
</a><a href="#h8-0-267" id="h8-0-267" class="i">+            }
</a><a href="#h8-0-268" id="h8-0-268" class="i">+
</a><a href="#h8-0-269" id="h8-0-269" class="i">+            LaunchedEffect(Unit) {
</a><a href="#h8-0-270" id="h8-0-270" class="i">+                updateInstallationSummary(coroutineScope)
</a><a href="#h8-0-271" id="h8-0-271" class="i">+            }
</a><a href="#h8-0-272" id="h8-0-272" class="i">+
</a><a href="#h8-0-273" id="h8-0-273" class="i">+            installationSummary?.let { SummaryCards(installationSummary = it) }
</a><a href="#h8-0-274" id="h8-0-274" class="i">+        }
</a><a href="#h8-0-275" id="h8-0-275" class="i">+    }
</a><a href="#h8-0-276" id="h8-0-276" class="i">+}</a><a href="#h8-0-277" id="h8-0-277" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h9" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/home/HomeSettings.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/home/HomeSettings.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/home/HomeSettings.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/home/HomeSettings.kt</a></b>
<a href="#h9-0" id="h9-0" class="h">@@ -0,0 +1,242 @@
</a><a href="#h9-0-0" id="h9-0-0" class="i">+package me.rhunk.snapenhance.ui.manager.pages.home
</a><a href="#h9-0-1" id="h9-0-1" class="i">+
</a><a href="#h9-0-2" id="h9-0-2" class="i">+import androidx.compose.foundation.ScrollState
</a><a href="#h9-0-3" id="h9-0-3" class="i">+import androidx.compose.foundation.clickable
</a><a href="#h9-0-4" id="h9-0-4" class="i">+import androidx.compose.foundation.layout.*
</a><a href="#h9-0-5" id="h9-0-5" class="i">+import androidx.compose.foundation.verticalScroll
</a><a href="#h9-0-6" id="h9-0-6" class="i">+import androidx.compose.material.icons.Icons
</a><a href="#h9-0-7" id="h9-0-7" class="i">+import androidx.compose.material.icons.filled.OpenInNew
</a><a href="#h9-0-8" id="h9-0-8" class="i">+import androidx.compose.material3.*
</a><a href="#h9-0-9" id="h9-0-9" class="i">+import androidx.compose.runtime.*
</a><a href="#h9-0-10" id="h9-0-10" class="i">+import androidx.compose.ui.Alignment
</a><a href="#h9-0-11" id="h9-0-11" class="i">+import androidx.compose.ui.Modifier
</a><a href="#h9-0-12" id="h9-0-12" class="i">+import androidx.compose.ui.text.font.FontWeight
</a><a href="#h9-0-13" id="h9-0-13" class="i">+import androidx.compose.ui.unit.dp
</a><a href="#h9-0-14" id="h9-0-14" class="i">+import androidx.compose.ui.unit.sp
</a><a href="#h9-0-15" id="h9-0-15" class="i">+import androidx.compose.ui.window.Dialog
</a><a href="#h9-0-16" id="h9-0-16" class="i">+import androidx.core.net.toUri
</a><a href="#h9-0-17" id="h9-0-17" class="i">+import androidx.navigation.NavBackStackEntry
</a><a href="#h9-0-18" id="h9-0-18" class="i">+import kotlinx.coroutines.Dispatchers
</a><a href="#h9-0-19" id="h9-0-19" class="i">+import kotlinx.coroutines.withContext
</a><a href="#h9-0-20" id="h9-0-20" class="i">+import me.rhunk.snapenhance.common.Constants
</a><a href="#h9-0-21" id="h9-0-21" class="i">+import me.rhunk.snapenhance.common.action.EnumAction
</a><a href="#h9-0-22" id="h9-0-22" class="i">+import me.rhunk.snapenhance.common.bridge.types.BridgeFileType
</a><a href="#h9-0-23" id="h9-0-23" class="i">+import me.rhunk.snapenhance.ui.manager.Routes
</a><a href="#h9-0-24" id="h9-0-24" class="i">+import me.rhunk.snapenhance.ui.setup.Requirements
</a><a href="#h9-0-25" id="h9-0-25" class="i">+import me.rhunk.snapenhance.ui.util.ActivityLauncherHelper
</a><a href="#h9-0-26" id="h9-0-26" class="i">+import me.rhunk.snapenhance.ui.util.AlertDialogs
</a><a href="#h9-0-27" id="h9-0-27" class="i">+import me.rhunk.snapenhance.ui.util.saveFile
</a><a href="#h9-0-28" id="h9-0-28" class="i">+
</a><a href="#h9-0-29" id="h9-0-29" class="i">+class HomeSettings : Routes.Route() {
</a><a href="#h9-0-30" id="h9-0-30" class="i">+    private lateinit var activityLauncherHelper: ActivityLauncherHelper
</a><a href="#h9-0-31" id="h9-0-31" class="i">+    private val dialogs by lazy { AlertDialogs(context.translation) }
</a><a href="#h9-0-32" id="h9-0-32" class="i">+
</a><a href="#h9-0-33" id="h9-0-33" class="i">+    override val init: () -&gt; Unit = {
</a><a href="#h9-0-34" id="h9-0-34" class="i">+        activityLauncherHelper = ActivityLauncherHelper(context.activity!!)
</a><a href="#h9-0-35" id="h9-0-35" class="i">+    }
</a><a href="#h9-0-36" id="h9-0-36" class="i">+
</a><a href="#h9-0-37" id="h9-0-37" class="i">+    @Composable
</a><a href="#h9-0-38" id="h9-0-38" class="i">+    private fun RowTitle(title: String) {
</a><a href="#h9-0-39" id="h9-0-39" class="i">+        Text(text = title, modifier = Modifier.padding(16.dp), fontSize = 20.sp, fontWeight = FontWeight.Bold)
</a><a href="#h9-0-40" id="h9-0-40" class="i">+    }
</a><a href="#h9-0-41" id="h9-0-41" class="i">+
</a><a href="#h9-0-42" id="h9-0-42" class="i">+    @Composable
</a><a href="#h9-0-43" id="h9-0-43" class="i">+    private fun RowAction(title: String, requireConfirmation: Boolean = false, action: () -&gt; Unit) {
</a><a href="#h9-0-44" id="h9-0-44" class="i">+        var confirmationDialog by remember {
</a><a href="#h9-0-45" id="h9-0-45" class="i">+            mutableStateOf(false)
</a><a href="#h9-0-46" id="h9-0-46" class="i">+        }
</a><a href="#h9-0-47" id="h9-0-47" class="i">+
</a><a href="#h9-0-48" id="h9-0-48" class="i">+        fun takeAction() {
</a><a href="#h9-0-49" id="h9-0-49" class="i">+            if (requireConfirmation) {
</a><a href="#h9-0-50" id="h9-0-50" class="i">+                confirmationDialog = true
</a><a href="#h9-0-51" id="h9-0-51" class="i">+            } else {
</a><a href="#h9-0-52" id="h9-0-52" class="i">+                action()
</a><a href="#h9-0-53" id="h9-0-53" class="i">+            }
</a><a href="#h9-0-54" id="h9-0-54" class="i">+        }
</a><a href="#h9-0-55" id="h9-0-55" class="i">+
</a><a href="#h9-0-56" id="h9-0-56" class="i">+        if (requireConfirmation &amp;&amp; confirmationDialog) {
</a><a href="#h9-0-57" id="h9-0-57" class="i">+            Dialog(onDismissRequest = { confirmationDialog = false }) {
</a><a href="#h9-0-58" id="h9-0-58" class="i">+                dialogs.ConfirmDialog(title = &quot;Are you sure?&quot;, onConfirm = {
</a><a href="#h9-0-59" id="h9-0-59" class="i">+                    action()
</a><a href="#h9-0-60" id="h9-0-60" class="i">+                    confirmationDialog = false
</a><a href="#h9-0-61" id="h9-0-61" class="i">+                }, onDismiss = {
</a><a href="#h9-0-62" id="h9-0-62" class="i">+                    confirmationDialog = false
</a><a href="#h9-0-63" id="h9-0-63" class="i">+                })
</a><a href="#h9-0-64" id="h9-0-64" class="i">+            }
</a><a href="#h9-0-65" id="h9-0-65" class="i">+        }
</a><a href="#h9-0-66" id="h9-0-66" class="i">+
</a><a href="#h9-0-67" id="h9-0-67" class="i">+        ShiftedRow(
</a><a href="#h9-0-68" id="h9-0-68" class="i">+            modifier = Modifier
</a><a href="#h9-0-69" id="h9-0-69" class="i">+                .fillMaxWidth()
</a><a href="#h9-0-70" id="h9-0-70" class="i">+                .height(55.dp)
</a><a href="#h9-0-71" id="h9-0-71" class="i">+                .clickable {
</a><a href="#h9-0-72" id="h9-0-72" class="i">+                    takeAction()
</a><a href="#h9-0-73" id="h9-0-73" class="i">+                },
</a><a href="#h9-0-74" id="h9-0-74" class="i">+            horizontalArrangement = Arrangement.SpaceBetween,
</a><a href="#h9-0-75" id="h9-0-75" class="i">+            verticalAlignment = Alignment.CenterVertically
</a><a href="#h9-0-76" id="h9-0-76" class="i">+        ) {
</a><a href="#h9-0-77" id="h9-0-77" class="i">+            Text(text = title, modifier = Modifier.padding(start = 26.dp))
</a><a href="#h9-0-78" id="h9-0-78" class="i">+            IconButton(onClick = { takeAction() }) {
</a><a href="#h9-0-79" id="h9-0-79" class="i">+                Icon(
</a><a href="#h9-0-80" id="h9-0-80" class="i">+                    imageVector = Icons.Filled.OpenInNew,
</a><a href="#h9-0-81" id="h9-0-81" class="i">+                    contentDescription = null,
</a><a href="#h9-0-82" id="h9-0-82" class="i">+                    modifier = Modifier.size(24.dp)
</a><a href="#h9-0-83" id="h9-0-83" class="i">+                )
</a><a href="#h9-0-84" id="h9-0-84" class="i">+            }
</a><a href="#h9-0-85" id="h9-0-85" class="i">+        }
</a><a href="#h9-0-86" id="h9-0-86" class="i">+    }
</a><a href="#h9-0-87" id="h9-0-87" class="i">+
</a><a href="#h9-0-88" id="h9-0-88" class="i">+    private fun launchActionIntent(action: EnumAction) {
</a><a href="#h9-0-89" id="h9-0-89" class="i">+        val intent = context.androidContext.packageManager.getLaunchIntentForPackage(Constants.SNAPCHAT_PACKAGE_NAME)
</a><a href="#h9-0-90" id="h9-0-90" class="i">+        intent?.putExtra(EnumAction.ACTION_PARAMETER, action.key)
</a><a href="#h9-0-91" id="h9-0-91" class="i">+        context.androidContext.startActivity(intent)
</a><a href="#h9-0-92" id="h9-0-92" class="i">+    }
</a><a href="#h9-0-93" id="h9-0-93" class="i">+
</a><a href="#h9-0-94" id="h9-0-94" class="i">+    @Composable
</a><a href="#h9-0-95" id="h9-0-95" class="i">+    private fun ShiftedRow(
</a><a href="#h9-0-96" id="h9-0-96" class="i">+        modifier: Modifier = Modifier,
</a><a href="#h9-0-97" id="h9-0-97" class="i">+        horizontalArrangement: Arrangement.Horizontal = Arrangement.Start,
</a><a href="#h9-0-98" id="h9-0-98" class="i">+        verticalAlignment: Alignment.Vertical = Alignment.Top,
</a><a href="#h9-0-99" id="h9-0-99" class="i">+        content: @Composable RowScope.() -&gt; Unit
</a><a href="#h9-0-100" id="h9-0-100" class="i">+    ) {
</a><a href="#h9-0-101" id="h9-0-101" class="i">+        Row(
</a><a href="#h9-0-102" id="h9-0-102" class="i">+            modifier = modifier.padding(start = 26.dp),
</a><a href="#h9-0-103" id="h9-0-103" class="i">+            horizontalArrangement = horizontalArrangement,
</a><a href="#h9-0-104" id="h9-0-104" class="i">+            verticalAlignment = verticalAlignment
</a><a href="#h9-0-105" id="h9-0-105" class="i">+        ) { content(this) }
</a><a href="#h9-0-106" id="h9-0-106" class="i">+    }
</a><a href="#h9-0-107" id="h9-0-107" class="i">+
</a><a href="#h9-0-108" id="h9-0-108" class="i">+    @OptIn(ExperimentalMaterial3Api::class)
</a><a href="#h9-0-109" id="h9-0-109" class="i">+    override val content: @Composable (NavBackStackEntry) -&gt; Unit = {
</a><a href="#h9-0-110" id="h9-0-110" class="i">+        Column(
</a><a href="#h9-0-111" id="h9-0-111" class="i">+            modifier = Modifier
</a><a href="#h9-0-112" id="h9-0-112" class="i">+                .fillMaxSize()
</a><a href="#h9-0-113" id="h9-0-113" class="i">+                .verticalScroll(ScrollState(0))
</a><a href="#h9-0-114" id="h9-0-114" class="i">+        ) {
</a><a href="#h9-0-115" id="h9-0-115" class="i">+            RowTitle(title = &quot;Actions&quot;)
</a><a href="#h9-0-116" id="h9-0-116" class="i">+            EnumAction.entries.forEach { enumAction -&gt;
</a><a href="#h9-0-117" id="h9-0-117" class="i">+                RowAction(title = context.translation[&quot;actions.${enumAction.key}&quot;]) {
</a><a href="#h9-0-118" id="h9-0-118" class="i">+                    launchActionIntent(enumAction)
</a><a href="#h9-0-119" id="h9-0-119" class="i">+                }
</a><a href="#h9-0-120" id="h9-0-120" class="i">+            }
</a><a href="#h9-0-121" id="h9-0-121" class="i">+            RowAction(title = &quot;Regenerate Mappings&quot;) {
</a><a href="#h9-0-122" id="h9-0-122" class="i">+                context.checkForRequirements(Requirements.MAPPINGS)
</a><a href="#h9-0-123" id="h9-0-123" class="i">+            }
</a><a href="#h9-0-124" id="h9-0-124" class="i">+            RowAction(title = &quot;Change Language&quot;) {
</a><a href="#h9-0-125" id="h9-0-125" class="i">+                context.checkForRequirements(Requirements.LANGUAGE)
</a><a href="#h9-0-126" id="h9-0-126" class="i">+            }
</a><a href="#h9-0-127" id="h9-0-127" class="i">+            RowTitle(title = &quot;Message Logger&quot;)
</a><a href="#h9-0-128" id="h9-0-128" class="i">+            ShiftedRow {
</a><a href="#h9-0-129" id="h9-0-129" class="i">+                Column(
</a><a href="#h9-0-130" id="h9-0-130" class="i">+                    verticalArrangement = Arrangement.spacedBy(4.dp),
</a><a href="#h9-0-131" id="h9-0-131" class="i">+                ) {
</a><a href="#h9-0-132" id="h9-0-132" class="i">+                    var storedMessagesCount by remember { mutableIntStateOf(0) }
</a><a href="#h9-0-133" id="h9-0-133" class="i">+                    var storedStoriesCount by remember { mutableIntStateOf(0) }
</a><a href="#h9-0-134" id="h9-0-134" class="i">+                    LaunchedEffect(Unit) {
</a><a href="#h9-0-135" id="h9-0-135" class="i">+                        withContext(Dispatchers.IO) {
</a><a href="#h9-0-136" id="h9-0-136" class="i">+                            storedMessagesCount = context.messageLogger.getStoredMessageCount()
</a><a href="#h9-0-137" id="h9-0-137" class="i">+                            storedStoriesCount = context.messageLogger.getStoredStoriesCount()
</a><a href="#h9-0-138" id="h9-0-138" class="i">+                        }
</a><a href="#h9-0-139" id="h9-0-139" class="i">+                    }
</a><a href="#h9-0-140" id="h9-0-140" class="i">+                    Row(
</a><a href="#h9-0-141" id="h9-0-141" class="i">+                        horizontalArrangement = Arrangement.spacedBy(10.dp),
</a><a href="#h9-0-142" id="h9-0-142" class="i">+                        verticalAlignment = Alignment.CenterVertically,
</a><a href="#h9-0-143" id="h9-0-143" class="i">+                        modifier = Modifier
</a><a href="#h9-0-144" id="h9-0-144" class="i">+                            .fillMaxWidth()
</a><a href="#h9-0-145" id="h9-0-145" class="i">+                            .padding(5.dp)
</a><a href="#h9-0-146" id="h9-0-146" class="i">+                    ) {
</a><a href="#h9-0-147" id="h9-0-147" class="i">+                        Column(
</a><a href="#h9-0-148" id="h9-0-148" class="i">+                            modifier = Modifier.weight(1f),
</a><a href="#h9-0-149" id="h9-0-149" class="i">+                            verticalArrangement = Arrangement.spacedBy(2.dp),
</a><a href="#h9-0-150" id="h9-0-150" class="i">+                        ) {
</a><a href="#h9-0-151" id="h9-0-151" class="i">+                            Text(text = &quot;$storedMessagesCount messages&quot;)
</a><a href="#h9-0-152" id="h9-0-152" class="i">+                            Text(text = &quot;$storedStoriesCount stories&quot;)
</a><a href="#h9-0-153" id="h9-0-153" class="i">+                        }
</a><a href="#h9-0-154" id="h9-0-154" class="i">+                        Button(onClick = {
</a><a href="#h9-0-155" id="h9-0-155" class="i">+                            runCatching {
</a><a href="#h9-0-156" id="h9-0-156" class="i">+                                activityLauncherHelper.saveFile(&quot;message_logger.db&quot;, &quot;application/octet-stream&quot;) { uri -&gt;
</a><a href="#h9-0-157" id="h9-0-157" class="i">+                                    context.androidContext.contentResolver.openOutputStream(uri.toUri())?.use { outputStream -&gt;
</a><a href="#h9-0-158" id="h9-0-158" class="i">+                                        context.messageLogger.databaseFile.inputStream().use { inputStream -&gt;
</a><a href="#h9-0-159" id="h9-0-159" class="i">+                                            inputStream.copyTo(outputStream)
</a><a href="#h9-0-160" id="h9-0-160" class="i">+                                        }
</a><a href="#h9-0-161" id="h9-0-161" class="i">+                                    }
</a><a href="#h9-0-162" id="h9-0-162" class="i">+                                }
</a><a href="#h9-0-163" id="h9-0-163" class="i">+                            }.onFailure {
</a><a href="#h9-0-164" id="h9-0-164" class="i">+                                context.log.error(&quot;Failed to export database&quot;, it)
</a><a href="#h9-0-165" id="h9-0-165" class="i">+                                context.longToast(&quot;Failed to export database! ${it.localizedMessage}&quot;)
</a><a href="#h9-0-166" id="h9-0-166" class="i">+                            }
</a><a href="#h9-0-167" id="h9-0-167" class="i">+                        }) {
</a><a href="#h9-0-168" id="h9-0-168" class="i">+                            Text(text = &quot;Export&quot;)
</a><a href="#h9-0-169" id="h9-0-169" class="i">+                        }
</a><a href="#h9-0-170" id="h9-0-170" class="i">+                        Button(onClick = {
</a><a href="#h9-0-171" id="h9-0-171" class="i">+                            runCatching {
</a><a href="#h9-0-172" id="h9-0-172" class="i">+                                context.messageLogger.purgeAll()
</a><a href="#h9-0-173" id="h9-0-173" class="i">+                                storedMessagesCount = 0
</a><a href="#h9-0-174" id="h9-0-174" class="i">+                                storedStoriesCount = 0
</a><a href="#h9-0-175" id="h9-0-175" class="i">+                            }.onFailure {
</a><a href="#h9-0-176" id="h9-0-176" class="i">+                                context.log.error(&quot;Failed to clear messages&quot;, it)
</a><a href="#h9-0-177" id="h9-0-177" class="i">+                                context.longToast(&quot;Failed to clear messages! ${it.localizedMessage}&quot;)
</a><a href="#h9-0-178" id="h9-0-178" class="i">+                            }.onSuccess {
</a><a href="#h9-0-179" id="h9-0-179" class="i">+                                context.shortToast(&quot;Done!&quot;)
</a><a href="#h9-0-180" id="h9-0-180" class="i">+                            }
</a><a href="#h9-0-181" id="h9-0-181" class="i">+                        }) {
</a><a href="#h9-0-182" id="h9-0-182" class="i">+                            Text(text = &quot;Clear&quot;)
</a><a href="#h9-0-183" id="h9-0-183" class="i">+                        }
</a><a href="#h9-0-184" id="h9-0-184" class="i">+                    }
</a><a href="#h9-0-185" id="h9-0-185" class="i">+                }
</a><a href="#h9-0-186" id="h9-0-186" class="i">+            }
</a><a href="#h9-0-187" id="h9-0-187" class="i">+
</a><a href="#h9-0-188" id="h9-0-188" class="i">+            RowTitle(title = &quot;Clear App Files&quot;)
</a><a href="#h9-0-189" id="h9-0-189" class="i">+            Row(
</a><a href="#h9-0-190" id="h9-0-190" class="i">+                horizontalArrangement = Arrangement.SpaceBetween,
</a><a href="#h9-0-191" id="h9-0-191" class="i">+                verticalAlignment = Alignment.CenterVertically,
</a><a href="#h9-0-192" id="h9-0-192" class="i">+            ) {
</a><a href="#h9-0-193" id="h9-0-193" class="i">+                var selectedFileType by remember { mutableStateOf(BridgeFileType.entries.first()) }
</a><a href="#h9-0-194" id="h9-0-194" class="i">+                Box(
</a><a href="#h9-0-195" id="h9-0-195" class="i">+                    modifier = Modifier
</a><a href="#h9-0-196" id="h9-0-196" class="i">+                        .weight(1f)
</a><a href="#h9-0-197" id="h9-0-197" class="i">+                        .padding(start = 26.dp)
</a><a href="#h9-0-198" id="h9-0-198" class="i">+                ) {
</a><a href="#h9-0-199" id="h9-0-199" class="i">+                    var expanded by remember { mutableStateOf(false) }
</a><a href="#h9-0-200" id="h9-0-200" class="i">+
</a><a href="#h9-0-201" id="h9-0-201" class="i">+                    ExposedDropdownMenuBox(
</a><a href="#h9-0-202" id="h9-0-202" class="i">+                        expanded = expanded,
</a><a href="#h9-0-203" id="h9-0-203" class="i">+                        onExpandedChange = { expanded = it },
</a><a href="#h9-0-204" id="h9-0-204" class="i">+                        modifier = Modifier.fillMaxWidth(0.8f)
</a><a href="#h9-0-205" id="h9-0-205" class="i">+                    ) {
</a><a href="#h9-0-206" id="h9-0-206" class="i">+                        TextField(
</a><a href="#h9-0-207" id="h9-0-207" class="i">+                            value = selectedFileType.displayName,
</a><a href="#h9-0-208" id="h9-0-208" class="i">+                            onValueChange = {},
</a><a href="#h9-0-209" id="h9-0-209" class="i">+                            readOnly = true,
</a><a href="#h9-0-210" id="h9-0-210" class="i">+                            modifier = Modifier.menuAnchor()
</a><a href="#h9-0-211" id="h9-0-211" class="i">+                        )
</a><a href="#h9-0-212" id="h9-0-212" class="i">+
</a><a href="#h9-0-213" id="h9-0-213" class="i">+                        ExposedDropdownMenu(expanded = expanded, onDismissRequest = { expanded = false }) {
</a><a href="#h9-0-214" id="h9-0-214" class="i">+                            BridgeFileType.entries.forEach { fileType -&gt;
</a><a href="#h9-0-215" id="h9-0-215" class="i">+                                DropdownMenuItem(onClick = {
</a><a href="#h9-0-216" id="h9-0-216" class="i">+                                    expanded = false
</a><a href="#h9-0-217" id="h9-0-217" class="i">+                                    selectedFileType = fileType
</a><a href="#h9-0-218" id="h9-0-218" class="i">+                                }, text = {
</a><a href="#h9-0-219" id="h9-0-219" class="i">+                                    Text(text = fileType.displayName)
</a><a href="#h9-0-220" id="h9-0-220" class="i">+                                })
</a><a href="#h9-0-221" id="h9-0-221" class="i">+                            }
</a><a href="#h9-0-222" id="h9-0-222" class="i">+                        }
</a><a href="#h9-0-223" id="h9-0-223" class="i">+                    }
</a><a href="#h9-0-224" id="h9-0-224" class="i">+                }
</a><a href="#h9-0-225" id="h9-0-225" class="i">+                Button(onClick = {
</a><a href="#h9-0-226" id="h9-0-226" class="i">+                    runCatching {
</a><a href="#h9-0-227" id="h9-0-227" class="i">+                        selectedFileType.resolve(context.androidContext).delete()
</a><a href="#h9-0-228" id="h9-0-228" class="i">+                    }.onFailure {
</a><a href="#h9-0-229" id="h9-0-229" class="i">+                        context.log.error(&quot;Failed to clear file&quot;, it)
</a><a href="#h9-0-230" id="h9-0-230" class="i">+                        context.longToast(&quot;Failed to clear file! ${it.localizedMessage}&quot;)
</a><a href="#h9-0-231" id="h9-0-231" class="i">+                    }.onSuccess {
</a><a href="#h9-0-232" id="h9-0-232" class="i">+                        context.shortToast(&quot;Done!&quot;)
</a><a href="#h9-0-233" id="h9-0-233" class="i">+                    }
</a><a href="#h9-0-234" id="h9-0-234" class="i">+                }) {
</a><a href="#h9-0-235" id="h9-0-235" class="i">+                    Text(text = &quot;Clear&quot;)
</a><a href="#h9-0-236" id="h9-0-236" class="i">+                }
</a><a href="#h9-0-237" id="h9-0-237" class="i">+            }
</a><a href="#h9-0-238" id="h9-0-238" class="i">+            Spacer(modifier = Modifier.height(50.dp))
</a><a href="#h9-0-239" id="h9-0-239" class="i">+        }
</a><a href="#h9-0-240" id="h9-0-240" class="i">+    }
</a><a href="#h9-0-241" id="h9-0-241" class="i">+}</a><a href="#h9-0-242" id="h9-0-242" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h10" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/scripting/ScriptingRoot.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/scripting/ScriptingRoot.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/scripting/ScriptingRoot.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/scripting/ScriptingRoot.kt</a></b>
<a href="#h10-0" id="h10-0" class="h">@@ -0,0 +1,301 @@
</a><a href="#h10-0-0" id="h10-0-0" class="i">+package me.rhunk.snapenhance.ui.manager.pages.scripting
</a><a href="#h10-0-1" id="h10-0-1" class="i">+
</a><a href="#h10-0-2" id="h10-0-2" class="i">+import android.content.Intent
</a><a href="#h10-0-3" id="h10-0-3" class="i">+import androidx.compose.foundation.clickable
</a><a href="#h10-0-4" id="h10-0-4" class="i">+import androidx.compose.foundation.layout.*
</a><a href="#h10-0-5" id="h10-0-5" class="i">+import androidx.compose.foundation.lazy.LazyColumn
</a><a href="#h10-0-6" id="h10-0-6" class="i">+import androidx.compose.material.icons.Icons
</a><a href="#h10-0-7" id="h10-0-7" class="i">+import androidx.compose.material.icons.filled.FolderOpen
</a><a href="#h10-0-8" id="h10-0-8" class="i">+import androidx.compose.material.icons.filled.LibraryBooks
</a><a href="#h10-0-9" id="h10-0-9" class="i">+import androidx.compose.material.icons.filled.Link
</a><a href="#h10-0-10" id="h10-0-10" class="i">+import androidx.compose.material.icons.filled.Settings
</a><a href="#h10-0-11" id="h10-0-11" class="i">+import androidx.compose.material3.*
</a><a href="#h10-0-12" id="h10-0-12" class="i">+import androidx.compose.runtime.*
</a><a href="#h10-0-13" id="h10-0-13" class="i">+import androidx.compose.ui.Alignment
</a><a href="#h10-0-14" id="h10-0-14" class="i">+import androidx.compose.ui.Modifier
</a><a href="#h10-0-15" id="h10-0-15" class="i">+import androidx.compose.ui.unit.dp
</a><a href="#h10-0-16" id="h10-0-16" class="i">+import androidx.compose.ui.unit.sp
</a><a href="#h10-0-17" id="h10-0-17" class="i">+import androidx.core.net.toUri
</a><a href="#h10-0-18" id="h10-0-18" class="i">+import androidx.documentfile.provider.DocumentFile
</a><a href="#h10-0-19" id="h10-0-19" class="i">+import androidx.navigation.NavBackStackEntry
</a><a href="#h10-0-20" id="h10-0-20" class="i">+import kotlinx.coroutines.Dispatchers
</a><a href="#h10-0-21" id="h10-0-21" class="i">+import kotlinx.coroutines.delay
</a><a href="#h10-0-22" id="h10-0-22" class="i">+import kotlinx.coroutines.launch
</a><a href="#h10-0-23" id="h10-0-23" class="i">+import kotlinx.coroutines.withContext
</a><a href="#h10-0-24" id="h10-0-24" class="i">+import me.rhunk.snapenhance.common.scripting.type.ModuleInfo
</a><a href="#h10-0-25" id="h10-0-25" class="i">+import me.rhunk.snapenhance.common.scripting.ui.EnumScriptInterface
</a><a href="#h10-0-26" id="h10-0-26" class="i">+import me.rhunk.snapenhance.common.scripting.ui.InterfaceManager
</a><a href="#h10-0-27" id="h10-0-27" class="i">+import me.rhunk.snapenhance.common.scripting.ui.ScriptInterface
</a><a href="#h10-0-28" id="h10-0-28" class="i">+import me.rhunk.snapenhance.ui.manager.Routes
</a><a href="#h10-0-29" id="h10-0-29" class="i">+import me.rhunk.snapenhance.ui.util.ActivityLauncherHelper
</a><a href="#h10-0-30" id="h10-0-30" class="i">+import me.rhunk.snapenhance.ui.util.chooseFolder
</a><a href="#h10-0-31" id="h10-0-31" class="i">+import me.rhunk.snapenhance.ui.util.pullrefresh.PullRefreshIndicator
</a><a href="#h10-0-32" id="h10-0-32" class="i">+import me.rhunk.snapenhance.ui.util.pullrefresh.pullRefresh
</a><a href="#h10-0-33" id="h10-0-33" class="i">+import me.rhunk.snapenhance.ui.util.pullrefresh.rememberPullRefreshState
</a><a href="#h10-0-34" id="h10-0-34" class="i">+
</a><a href="#h10-0-35" id="h10-0-35" class="i">+class ScriptingRoot : Routes.Route() {
</a><a href="#h10-0-36" id="h10-0-36" class="i">+    private lateinit var activityLauncherHelper: ActivityLauncherHelper
</a><a href="#h10-0-37" id="h10-0-37" class="i">+
</a><a href="#h10-0-38" id="h10-0-38" class="i">+    override val init: () -&gt; Unit = {
</a><a href="#h10-0-39" id="h10-0-39" class="i">+        activityLauncherHelper = ActivityLauncherHelper(context.activity!!)
</a><a href="#h10-0-40" id="h10-0-40" class="i">+    }
</a><a href="#h10-0-41" id="h10-0-41" class="i">+
</a><a href="#h10-0-42" id="h10-0-42" class="i">+    @Composable
</a><a href="#h10-0-43" id="h10-0-43" class="i">+    fun ModuleItem(script: ModuleInfo) {
</a><a href="#h10-0-44" id="h10-0-44" class="i">+        var enabled by remember {
</a><a href="#h10-0-45" id="h10-0-45" class="i">+            mutableStateOf(context.modDatabase.isScriptEnabled(script.name))
</a><a href="#h10-0-46" id="h10-0-46" class="i">+        }
</a><a href="#h10-0-47" id="h10-0-47" class="i">+        var openSettings by remember {
</a><a href="#h10-0-48" id="h10-0-48" class="i">+            mutableStateOf(false)
</a><a href="#h10-0-49" id="h10-0-49" class="i">+        }
</a><a href="#h10-0-50" id="h10-0-50" class="i">+
</a><a href="#h10-0-51" id="h10-0-51" class="i">+        Card(
</a><a href="#h10-0-52" id="h10-0-52" class="i">+            modifier = Modifier
</a><a href="#h10-0-53" id="h10-0-53" class="i">+                .fillMaxWidth()
</a><a href="#h10-0-54" id="h10-0-54" class="i">+                .padding(8.dp),
</a><a href="#h10-0-55" id="h10-0-55" class="i">+            elevation = CardDefaults.cardElevation()
</a><a href="#h10-0-56" id="h10-0-56" class="i">+        ) {
</a><a href="#h10-0-57" id="h10-0-57" class="i">+            Row(
</a><a href="#h10-0-58" id="h10-0-58" class="i">+                modifier = Modifier
</a><a href="#h10-0-59" id="h10-0-59" class="i">+                    .fillMaxWidth()
</a><a href="#h10-0-60" id="h10-0-60" class="i">+                    .clickable {
</a><a href="#h10-0-61" id="h10-0-61" class="i">+                        openSettings = !openSettings
</a><a href="#h10-0-62" id="h10-0-62" class="i">+                    }
</a><a href="#h10-0-63" id="h10-0-63" class="i">+                    .padding(8.dp),
</a><a href="#h10-0-64" id="h10-0-64" class="i">+                verticalAlignment = Alignment.CenterVertically
</a><a href="#h10-0-65" id="h10-0-65" class="i">+            ) {
</a><a href="#h10-0-66" id="h10-0-66" class="i">+                Column(
</a><a href="#h10-0-67" id="h10-0-67" class="i">+                    modifier = Modifier
</a><a href="#h10-0-68" id="h10-0-68" class="i">+                        .weight(1f)
</a><a href="#h10-0-69" id="h10-0-69" class="i">+                        .padding(end = 8.dp)
</a><a href="#h10-0-70" id="h10-0-70" class="i">+                ) {
</a><a href="#h10-0-71" id="h10-0-71" class="i">+                    Text(text = script.displayName ?: script.name, fontSize = 20.sp,)
</a><a href="#h10-0-72" id="h10-0-72" class="i">+                    Text(text = script.description ?: &quot;No description&quot;, fontSize = 14.sp,)
</a><a href="#h10-0-73" id="h10-0-73" class="i">+                }
</a><a href="#h10-0-74" id="h10-0-74" class="i">+                IconButton(onClick = { openSettings = !openSettings }) {
</a><a href="#h10-0-75" id="h10-0-75" class="i">+                    Icon(imageVector = Icons.Default.Settings, contentDescription = &quot;Settings&quot;,)
</a><a href="#h10-0-76" id="h10-0-76" class="i">+                }
</a><a href="#h10-0-77" id="h10-0-77" class="i">+                Switch(
</a><a href="#h10-0-78" id="h10-0-78" class="i">+                    checked = enabled,
</a><a href="#h10-0-79" id="h10-0-79" class="i">+                    onCheckedChange = { isChecked -&gt;
</a><a href="#h10-0-80" id="h10-0-80" class="i">+                        context.modDatabase.setScriptEnabled(script.name, isChecked)
</a><a href="#h10-0-81" id="h10-0-81" class="i">+                        enabled = isChecked
</a><a href="#h10-0-82" id="h10-0-82" class="i">+                        runCatching {
</a><a href="#h10-0-83" id="h10-0-83" class="i">+                            val modulePath = context.scriptManager.getModulePath(script.name)!!
</a><a href="#h10-0-84" id="h10-0-84" class="i">+                            context.scriptManager.unloadScript(modulePath)
</a><a href="#h10-0-85" id="h10-0-85" class="i">+                            if (isChecked) {
</a><a href="#h10-0-86" id="h10-0-86" class="i">+                                context.scriptManager.loadScript(modulePath)
</a><a href="#h10-0-87" id="h10-0-87" class="i">+                                context.scriptManager.runtime.getModuleByName(script.name)
</a><a href="#h10-0-88" id="h10-0-88" class="i">+                                    ?.callFunction(&quot;module.onSnapEnhanceLoad&quot;)
</a><a href="#h10-0-89" id="h10-0-89" class="i">+                                context.shortToast(&quot;Loaded script ${script.name}&quot;)
</a><a href="#h10-0-90" id="h10-0-90" class="i">+                            } else {
</a><a href="#h10-0-91" id="h10-0-91" class="i">+                                context.shortToast(&quot;Unloaded script ${script.name}&quot;)
</a><a href="#h10-0-92" id="h10-0-92" class="i">+                            }
</a><a href="#h10-0-93" id="h10-0-93" class="i">+                        }.onFailure { throwable -&gt;
</a><a href="#h10-0-94" id="h10-0-94" class="i">+                            enabled = !isChecked
</a><a href="#h10-0-95" id="h10-0-95" class="i">+                            (&quot;Failed to ${if (isChecked) &quot;enable&quot; else &quot;disable&quot;} script&quot;).let {
</a><a href="#h10-0-96" id="h10-0-96" class="i">+                                context.log.error(it, throwable)
</a><a href="#h10-0-97" id="h10-0-97" class="i">+                                context.shortToast(it)
</a><a href="#h10-0-98" id="h10-0-98" class="i">+                            }
</a><a href="#h10-0-99" id="h10-0-99" class="i">+                        }
</a><a href="#h10-0-100" id="h10-0-100" class="i">+                    }
</a><a href="#h10-0-101" id="h10-0-101" class="i">+                )
</a><a href="#h10-0-102" id="h10-0-102" class="i">+            }
</a><a href="#h10-0-103" id="h10-0-103" class="i">+
</a><a href="#h10-0-104" id="h10-0-104" class="i">+            if (openSettings) {
</a><a href="#h10-0-105" id="h10-0-105" class="i">+                ScriptSettings(script)
</a><a href="#h10-0-106" id="h10-0-106" class="i">+            }
</a><a href="#h10-0-107" id="h10-0-107" class="i">+        }
</a><a href="#h10-0-108" id="h10-0-108" class="i">+    }
</a><a href="#h10-0-109" id="h10-0-109" class="i">+
</a><a href="#h10-0-110" id="h10-0-110" class="i">+    override val floatingActionButton: @Composable () -&gt; Unit = {
</a><a href="#h10-0-111" id="h10-0-111" class="i">+        Column(
</a><a href="#h10-0-112" id="h10-0-112" class="i">+            verticalArrangement = Arrangement.spacedBy(8.dp),
</a><a href="#h10-0-113" id="h10-0-113" class="i">+            horizontalAlignment = Alignment.End,
</a><a href="#h10-0-114" id="h10-0-114" class="i">+        ) {
</a><a href="#h10-0-115" id="h10-0-115" class="i">+            ExtendedFloatingActionButton(
</a><a href="#h10-0-116" id="h10-0-116" class="i">+                onClick = {
</a><a href="#h10-0-117" id="h10-0-117" class="i">+
</a><a href="#h10-0-118" id="h10-0-118" class="i">+                },
</a><a href="#h10-0-119" id="h10-0-119" class="i">+                icon= { Icon(imageVector = Icons.Default.Link, contentDescription = &quot;Link&quot;) },
</a><a href="#h10-0-120" id="h10-0-120" class="i">+                text = {
</a><a href="#h10-0-121" id="h10-0-121" class="i">+                    Text(text = &quot;Import from URL&quot;)
</a><a href="#h10-0-122" id="h10-0-122" class="i">+                },
</a><a href="#h10-0-123" id="h10-0-123" class="i">+            )
</a><a href="#h10-0-124" id="h10-0-124" class="i">+            ExtendedFloatingActionButton(
</a><a href="#h10-0-125" id="h10-0-125" class="i">+                onClick = {
</a><a href="#h10-0-126" id="h10-0-126" class="i">+                    context.scriptManager.getScriptsFolder()?.let {
</a><a href="#h10-0-127" id="h10-0-127" class="i">+                        context.androidContext.startActivity(
</a><a href="#h10-0-128" id="h10-0-128" class="i">+                            Intent(Intent.ACTION_VIEW).apply {
</a><a href="#h10-0-129" id="h10-0-129" class="i">+                                data = it.uri
</a><a href="#h10-0-130" id="h10-0-130" class="i">+                                flags = Intent.FLAG_ACTIVITY_NEW_TASK
</a><a href="#h10-0-131" id="h10-0-131" class="i">+                            }
</a><a href="#h10-0-132" id="h10-0-132" class="i">+                        )
</a><a href="#h10-0-133" id="h10-0-133" class="i">+                    }
</a><a href="#h10-0-134" id="h10-0-134" class="i">+                },
</a><a href="#h10-0-135" id="h10-0-135" class="i">+                icon= { Icon(imageVector = Icons.Default.FolderOpen, contentDescription = &quot;Folder&quot;) },
</a><a href="#h10-0-136" id="h10-0-136" class="i">+                text = {
</a><a href="#h10-0-137" id="h10-0-137" class="i">+                    Text(text = &quot;Open Scripts Folder&quot;)
</a><a href="#h10-0-138" id="h10-0-138" class="i">+                },
</a><a href="#h10-0-139" id="h10-0-139" class="i">+            )
</a><a href="#h10-0-140" id="h10-0-140" class="i">+        }
</a><a href="#h10-0-141" id="h10-0-141" class="i">+    }
</a><a href="#h10-0-142" id="h10-0-142" class="i">+
</a><a href="#h10-0-143" id="h10-0-143" class="i">+
</a><a href="#h10-0-144" id="h10-0-144" class="i">+    @Composable
</a><a href="#h10-0-145" id="h10-0-145" class="i">+    fun ScriptSettings(script: ModuleInfo) {
</a><a href="#h10-0-146" id="h10-0-146" class="i">+       val settingsInterface = remember {
</a><a href="#h10-0-147" id="h10-0-147" class="i">+            val module = context.scriptManager.runtime.getModuleByName(script.name) ?: return@remember null
</a><a href="#h10-0-148" id="h10-0-148" class="i">+            (module.getBinding(InterfaceManager::class))?.buildInterface(EnumScriptInterface.SETTINGS)
</a><a href="#h10-0-149" id="h10-0-149" class="i">+        }
</a><a href="#h10-0-150" id="h10-0-150" class="i">+
</a><a href="#h10-0-151" id="h10-0-151" class="i">+        if (settingsInterface == null) {
</a><a href="#h10-0-152" id="h10-0-152" class="i">+            Text(
</a><a href="#h10-0-153" id="h10-0-153" class="i">+                text = &quot;This module does not have any settings&quot;,
</a><a href="#h10-0-154" id="h10-0-154" class="i">+                style = MaterialTheme.typography.bodySmall,
</a><a href="#h10-0-155" id="h10-0-155" class="i">+                modifier = Modifier.padding(8.dp)
</a><a href="#h10-0-156" id="h10-0-156" class="i">+            )
</a><a href="#h10-0-157" id="h10-0-157" class="i">+        } else  {
</a><a href="#h10-0-158" id="h10-0-158" class="i">+            ScriptInterface(interfaceBuilder = settingsInterface)
</a><a href="#h10-0-159" id="h10-0-159" class="i">+        }
</a><a href="#h10-0-160" id="h10-0-160" class="i">+    }
</a><a href="#h10-0-161" id="h10-0-161" class="i">+
</a><a href="#h10-0-162" id="h10-0-162" class="i">+    override val content: @Composable (NavBackStackEntry) -&gt; Unit = {
</a><a href="#h10-0-163" id="h10-0-163" class="i">+        var scriptModules by remember { mutableStateOf(listOf&lt;ModuleInfo&gt;()) }
</a><a href="#h10-0-164" id="h10-0-164" class="i">+        var scriptingFolder by remember { mutableStateOf(null as DocumentFile?) }
</a><a href="#h10-0-165" id="h10-0-165" class="i">+        val coroutineScope = rememberCoroutineScope()
</a><a href="#h10-0-166" id="h10-0-166" class="i">+
</a><a href="#h10-0-167" id="h10-0-167" class="i">+        var refreshing by remember {
</a><a href="#h10-0-168" id="h10-0-168" class="i">+            mutableStateOf(false)
</a><a href="#h10-0-169" id="h10-0-169" class="i">+        }
</a><a href="#h10-0-170" id="h10-0-170" class="i">+
</a><a href="#h10-0-171" id="h10-0-171" class="i">+        fun syncScripts() {
</a><a href="#h10-0-172" id="h10-0-172" class="i">+            runCatching {
</a><a href="#h10-0-173" id="h10-0-173" class="i">+                scriptingFolder = context.scriptManager.getScriptsFolder()
</a><a href="#h10-0-174" id="h10-0-174" class="i">+                context.scriptManager.sync()
</a><a href="#h10-0-175" id="h10-0-175" class="i">+                scriptModules = context.modDatabase.getScripts()
</a><a href="#h10-0-176" id="h10-0-176" class="i">+            }.onFailure {
</a><a href="#h10-0-177" id="h10-0-177" class="i">+                context.log.error(&quot;Failed to sync scripts&quot;, it)
</a><a href="#h10-0-178" id="h10-0-178" class="i">+            }
</a><a href="#h10-0-179" id="h10-0-179" class="i">+        }
</a><a href="#h10-0-180" id="h10-0-180" class="i">+
</a><a href="#h10-0-181" id="h10-0-181" class="i">+        LaunchedEffect(Unit) {
</a><a href="#h10-0-182" id="h10-0-182" class="i">+            refreshing = true
</a><a href="#h10-0-183" id="h10-0-183" class="i">+            withContext(Dispatchers.IO) {
</a><a href="#h10-0-184" id="h10-0-184" class="i">+                syncScripts()
</a><a href="#h10-0-185" id="h10-0-185" class="i">+                refreshing = false
</a><a href="#h10-0-186" id="h10-0-186" class="i">+            }
</a><a href="#h10-0-187" id="h10-0-187" class="i">+        }
</a><a href="#h10-0-188" id="h10-0-188" class="i">+
</a><a href="#h10-0-189" id="h10-0-189" class="i">+        val pullRefreshState = rememberPullRefreshState(refreshing, onRefresh = {
</a><a href="#h10-0-190" id="h10-0-190" class="i">+            refreshing = true
</a><a href="#h10-0-191" id="h10-0-191" class="i">+            syncScripts()
</a><a href="#h10-0-192" id="h10-0-192" class="i">+            coroutineScope.launch {
</a><a href="#h10-0-193" id="h10-0-193" class="i">+                delay(300)
</a><a href="#h10-0-194" id="h10-0-194" class="i">+                refreshing = false
</a><a href="#h10-0-195" id="h10-0-195" class="i">+            }
</a><a href="#h10-0-196" id="h10-0-196" class="i">+        })
</a><a href="#h10-0-197" id="h10-0-197" class="i">+
</a><a href="#h10-0-198" id="h10-0-198" class="i">+        Box(
</a><a href="#h10-0-199" id="h10-0-199" class="i">+            modifier = Modifier.fillMaxSize()
</a><a href="#h10-0-200" id="h10-0-200" class="i">+        ) {
</a><a href="#h10-0-201" id="h10-0-201" class="i">+            LazyColumn(
</a><a href="#h10-0-202" id="h10-0-202" class="i">+                modifier = Modifier
</a><a href="#h10-0-203" id="h10-0-203" class="i">+                    .fillMaxSize()
</a><a href="#h10-0-204" id="h10-0-204" class="i">+                    .pullRefresh(pullRefreshState),
</a><a href="#h10-0-205" id="h10-0-205" class="i">+                horizontalAlignment = Alignment.CenterHorizontally
</a><a href="#h10-0-206" id="h10-0-206" class="i">+            ) {
</a><a href="#h10-0-207" id="h10-0-207" class="i">+                item {
</a><a href="#h10-0-208" id="h10-0-208" class="i">+                    if (scriptingFolder == null) {
</a><a href="#h10-0-209" id="h10-0-209" class="i">+                        Text(
</a><a href="#h10-0-210" id="h10-0-210" class="i">+                            text = &quot;No scripts folder selected&quot;,
</a><a href="#h10-0-211" id="h10-0-211" class="i">+                            style = MaterialTheme.typography.bodySmall,
</a><a href="#h10-0-212" id="h10-0-212" class="i">+                            modifier = Modifier.padding(8.dp)
</a><a href="#h10-0-213" id="h10-0-213" class="i">+                        )
</a><a href="#h10-0-214" id="h10-0-214" class="i">+                        Spacer(modifier = Modifier.height(8.dp))
</a><a href="#h10-0-215" id="h10-0-215" class="i">+                        Button(onClick = {
</a><a href="#h10-0-216" id="h10-0-216" class="i">+                            activityLauncherHelper.chooseFolder {
</a><a href="#h10-0-217" id="h10-0-217" class="i">+                                context.config.root.scripting.moduleFolder.set(it)
</a><a href="#h10-0-218" id="h10-0-218" class="i">+                                context.config.writeConfig()
</a><a href="#h10-0-219" id="h10-0-219" class="i">+                                coroutineScope.launch {
</a><a href="#h10-0-220" id="h10-0-220" class="i">+                                    syncScripts()
</a><a href="#h10-0-221" id="h10-0-221" class="i">+                                }
</a><a href="#h10-0-222" id="h10-0-222" class="i">+                            }
</a><a href="#h10-0-223" id="h10-0-223" class="i">+                        }) {
</a><a href="#h10-0-224" id="h10-0-224" class="i">+                            Text(text = &quot;Select folder&quot;)
</a><a href="#h10-0-225" id="h10-0-225" class="i">+                        }
</a><a href="#h10-0-226" id="h10-0-226" class="i">+                    } else if (scriptModules.isEmpty()) {
</a><a href="#h10-0-227" id="h10-0-227" class="i">+                        Text(
</a><a href="#h10-0-228" id="h10-0-228" class="i">+                            text = &quot;No scripts found&quot;,
</a><a href="#h10-0-229" id="h10-0-229" class="i">+                            style = MaterialTheme.typography.bodySmall,
</a><a href="#h10-0-230" id="h10-0-230" class="i">+                            modifier = Modifier.padding(8.dp)
</a><a href="#h10-0-231" id="h10-0-231" class="i">+                        )
</a><a href="#h10-0-232" id="h10-0-232" class="i">+                    }
</a><a href="#h10-0-233" id="h10-0-233" class="i">+                }
</a><a href="#h10-0-234" id="h10-0-234" class="i">+                items(scriptModules.size) { index -&gt;
</a><a href="#h10-0-235" id="h10-0-235" class="i">+                    ModuleItem(scriptModules[index])
</a><a href="#h10-0-236" id="h10-0-236" class="i">+                }
</a><a href="#h10-0-237" id="h10-0-237" class="i">+                item {
</a><a href="#h10-0-238" id="h10-0-238" class="i">+                    Spacer(modifier = Modifier.height(200.dp))
</a><a href="#h10-0-239" id="h10-0-239" class="i">+                }
</a><a href="#h10-0-240" id="h10-0-240" class="i">+            }
</a><a href="#h10-0-241" id="h10-0-241" class="i">+
</a><a href="#h10-0-242" id="h10-0-242" class="i">+            PullRefreshIndicator(
</a><a href="#h10-0-243" id="h10-0-243" class="i">+                refreshing = refreshing,
</a><a href="#h10-0-244" id="h10-0-244" class="i">+                state = pullRefreshState,
</a><a href="#h10-0-245" id="h10-0-245" class="i">+                modifier = Modifier.align(Alignment.TopCenter)
</a><a href="#h10-0-246" id="h10-0-246" class="i">+            )
</a><a href="#h10-0-247" id="h10-0-247" class="i">+        }
</a><a href="#h10-0-248" id="h10-0-248" class="i">+
</a><a href="#h10-0-249" id="h10-0-249" class="i">+        var scriptingWarning by remember {
</a><a href="#h10-0-250" id="h10-0-250" class="i">+            mutableStateOf(context.sharedPreferences.run {
</a><a href="#h10-0-251" id="h10-0-251" class="i">+                getBoolean(&quot;scripting_warning&quot;, true).also {
</a><a href="#h10-0-252" id="h10-0-252" class="i">+                    edit().putBoolean(&quot;scripting_warning&quot;, false).apply()
</a><a href="#h10-0-253" id="h10-0-253" class="i">+                }
</a><a href="#h10-0-254" id="h10-0-254" class="i">+            })
</a><a href="#h10-0-255" id="h10-0-255" class="i">+        }
</a><a href="#h10-0-256" id="h10-0-256" class="i">+
</a><a href="#h10-0-257" id="h10-0-257" class="i">+        if (scriptingWarning) {
</a><a href="#h10-0-258" id="h10-0-258" class="i">+            var timeout by remember {
</a><a href="#h10-0-259" id="h10-0-259" class="i">+                mutableIntStateOf(10)
</a><a href="#h10-0-260" id="h10-0-260" class="i">+            }
</a><a href="#h10-0-261" id="h10-0-261" class="i">+
</a><a href="#h10-0-262" id="h10-0-262" class="i">+            LaunchedEffect(Unit) {
</a><a href="#h10-0-263" id="h10-0-263" class="i">+                while (timeout &gt; 0) {
</a><a href="#h10-0-264" id="h10-0-264" class="i">+                    delay(1000)
</a><a href="#h10-0-265" id="h10-0-265" class="i">+                    timeout--
</a><a href="#h10-0-266" id="h10-0-266" class="i">+                }
</a><a href="#h10-0-267" id="h10-0-267" class="i">+            }
</a><a href="#h10-0-268" id="h10-0-268" class="i">+
</a><a href="#h10-0-269" id="h10-0-269" class="i">+            AlertDialog(onDismissRequest = {
</a><a href="#h10-0-270" id="h10-0-270" class="i">+                if (timeout == 0) {
</a><a href="#h10-0-271" id="h10-0-271" class="i">+                    scriptingWarning = false
</a><a href="#h10-0-272" id="h10-0-272" class="i">+                }
</a><a href="#h10-0-273" id="h10-0-273" class="i">+            }, title = {
</a><a href="#h10-0-274" id="h10-0-274" class="i">+                Text(text = context.translation[&quot;manager.dialogs.scripting_warning.title&quot;])
</a><a href="#h10-0-275" id="h10-0-275" class="i">+            }, text = {
</a><a href="#h10-0-276" id="h10-0-276" class="i">+                Text(text = context.translation[&quot;manager.dialogs.scripting_warning.content&quot;])
</a><a href="#h10-0-277" id="h10-0-277" class="i">+            }, confirmButton = {
</a><a href="#h10-0-278" id="h10-0-278" class="i">+                TextButton(
</a><a href="#h10-0-279" id="h10-0-279" class="i">+                    onClick = {
</a><a href="#h10-0-280" id="h10-0-280" class="i">+                        scriptingWarning = false
</a><a href="#h10-0-281" id="h10-0-281" class="i">+                    },
</a><a href="#h10-0-282" id="h10-0-282" class="i">+                    enabled = timeout == 0
</a><a href="#h10-0-283" id="h10-0-283" class="i">+                ) {
</a><a href="#h10-0-284" id="h10-0-284" class="i">+                    Text(text = &quot;OK &quot; + if (timeout &gt; 0) &quot;($timeout)&quot; else &quot;&quot;)
</a><a href="#h10-0-285" id="h10-0-285" class="i">+                }
</a><a href="#h10-0-286" id="h10-0-286" class="i">+            })
</a><a href="#h10-0-287" id="h10-0-287" class="i">+        }
</a><a href="#h10-0-288" id="h10-0-288" class="i">+    }
</a><a href="#h10-0-289" id="h10-0-289" class="i">+
</a><a href="#h10-0-290" id="h10-0-290" class="i">+    override val topBarActions: @Composable() (RowScope.() -&gt; Unit) = {
</a><a href="#h10-0-291" id="h10-0-291" class="i">+        IconButton(onClick = {
</a><a href="#h10-0-292" id="h10-0-292" class="i">+            context.androidContext.startActivity(Intent(Intent.ACTION_VIEW).apply {
</a><a href="#h10-0-293" id="h10-0-293" class="i">+                data = &quot;https://github.com/SnapEnhance/docs&quot;.toUri()
</a><a href="#h10-0-294" id="h10-0-294" class="i">+                flags = Intent.FLAG_ACTIVITY_NEW_TASK
</a><a href="#h10-0-295" id="h10-0-295" class="i">+            })
</a><a href="#h10-0-296" id="h10-0-296" class="i">+        }) {
</a><a href="#h10-0-297" id="h10-0-297" class="i">+            Icon(imageVector = Icons.Default.LibraryBooks, contentDescription = &quot;Documentation&quot;)
</a><a href="#h10-0-298" id="h10-0-298" class="i">+        }
</a><a href="#h10-0-299" id="h10-0-299" class="i">+    }
</a><a href="#h10-0-300" id="h10-0-300" class="i">+}</a><a href="#h10-0-301" id="h10-0-301" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h11" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/social/AddFriendDialog.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/social/AddFriendDialog.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/social/AddFriendDialog.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/social/AddFriendDialog.kt</a></b>
<a href="#h11-0" id="h11-0" class="h">@@ -0,0 +1,259 @@
</a><a href="#h11-0-0" id="h11-0-0" class="i">+package me.rhunk.snapenhance.ui.manager.pages.social
</a><a href="#h11-0-1" id="h11-0-1" class="i">+
</a><a href="#h11-0-2" id="h11-0-2" class="i">+import androidx.compose.foundation.clickable
</a><a href="#h11-0-3" id="h11-0-3" class="i">+import androidx.compose.foundation.layout.*
</a><a href="#h11-0-4" id="h11-0-4" class="i">+import androidx.compose.foundation.lazy.LazyColumn
</a><a href="#h11-0-5" id="h11-0-5" class="i">+import androidx.compose.foundation.text.KeyboardOptions
</a><a href="#h11-0-6" id="h11-0-6" class="i">+import androidx.compose.material.icons.Icons
</a><a href="#h11-0-7" id="h11-0-7" class="i">+import androidx.compose.material.icons.filled.Search
</a><a href="#h11-0-8" id="h11-0-8" class="i">+import androidx.compose.material3.*
</a><a href="#h11-0-9" id="h11-0-9" class="i">+import androidx.compose.runtime.*
</a><a href="#h11-0-10" id="h11-0-10" class="i">+import androidx.compose.ui.Alignment
</a><a href="#h11-0-11" id="h11-0-11" class="i">+import androidx.compose.ui.Modifier
</a><a href="#h11-0-12" id="h11-0-12" class="i">+import androidx.compose.ui.layout.onGloballyPositioned
</a><a href="#h11-0-13" id="h11-0-13" class="i">+import androidx.compose.ui.text.font.FontWeight
</a><a href="#h11-0-14" id="h11-0-14" class="i">+import androidx.compose.ui.text.input.ImeAction
</a><a href="#h11-0-15" id="h11-0-15" class="i">+import androidx.compose.ui.text.input.KeyboardType
</a><a href="#h11-0-16" id="h11-0-16" class="i">+import androidx.compose.ui.unit.dp
</a><a href="#h11-0-17" id="h11-0-17" class="i">+import androidx.compose.ui.unit.sp
</a><a href="#h11-0-18" id="h11-0-18" class="i">+import androidx.compose.ui.window.Dialog
</a><a href="#h11-0-19" id="h11-0-19" class="i">+import androidx.compose.ui.window.DialogProperties
</a><a href="#h11-0-20" id="h11-0-20" class="i">+import kotlinx.coroutines.Dispatchers
</a><a href="#h11-0-21" id="h11-0-21" class="i">+import kotlinx.coroutines.Job
</a><a href="#h11-0-22" id="h11-0-22" class="i">+import kotlinx.coroutines.delay
</a><a href="#h11-0-23" id="h11-0-23" class="i">+import kotlinx.coroutines.launch
</a><a href="#h11-0-24" id="h11-0-24" class="i">+import kotlinx.coroutines.withContext
</a><a href="#h11-0-25" id="h11-0-25" class="i">+import me.rhunk.snapenhance.RemoteSideContext
</a><a href="#h11-0-26" id="h11-0-26" class="i">+import me.rhunk.snapenhance.common.ReceiversConfig
</a><a href="#h11-0-27" id="h11-0-27" class="i">+import me.rhunk.snapenhance.common.data.MessagingFriendInfo
</a><a href="#h11-0-28" id="h11-0-28" class="i">+import me.rhunk.snapenhance.common.data.MessagingGroupInfo
</a><a href="#h11-0-29" id="h11-0-29" class="i">+import me.rhunk.snapenhance.common.data.SocialScope
</a><a href="#h11-0-30" id="h11-0-30" class="i">+import me.rhunk.snapenhance.common.util.snap.SnapWidgetBroadcastReceiverHelper
</a><a href="#h11-0-31" id="h11-0-31" class="i">+
</a><a href="#h11-0-32" id="h11-0-32" class="i">+class AddFriendDialog(
</a><a href="#h11-0-33" id="h11-0-33" class="i">+    private val context: RemoteSideContext,
</a><a href="#h11-0-34" id="h11-0-34" class="i">+    private val socialRoot: SocialRoot,
</a><a href="#h11-0-35" id="h11-0-35" class="i">+) {
</a><a href="#h11-0-36" id="h11-0-36" class="i">+
</a><a href="#h11-0-37" id="h11-0-37" class="i">+    private val translation by lazy { context.translation.getCategory(&quot;manager.dialogs.add_friend&quot;)}
</a><a href="#h11-0-38" id="h11-0-38" class="i">+
</a><a href="#h11-0-39" id="h11-0-39" class="i">+    @Composable
</a><a href="#h11-0-40" id="h11-0-40" class="i">+    private fun ListCardEntry(name: String, getCurrentState: () -&gt; Boolean, onState: (Boolean) -&gt; Unit = {}) {
</a><a href="#h11-0-41" id="h11-0-41" class="i">+        var currentState by remember { mutableStateOf(getCurrentState()) }
</a><a href="#h11-0-42" id="h11-0-42" class="i">+
</a><a href="#h11-0-43" id="h11-0-43" class="i">+        Row(
</a><a href="#h11-0-44" id="h11-0-44" class="i">+            modifier = Modifier
</a><a href="#h11-0-45" id="h11-0-45" class="i">+                .fillMaxWidth()
</a><a href="#h11-0-46" id="h11-0-46" class="i">+                .clickable {
</a><a href="#h11-0-47" id="h11-0-47" class="i">+                    currentState = !currentState
</a><a href="#h11-0-48" id="h11-0-48" class="i">+                    onState(currentState)
</a><a href="#h11-0-49" id="h11-0-49" class="i">+                }
</a><a href="#h11-0-50" id="h11-0-50" class="i">+                .padding(4.dp),
</a><a href="#h11-0-51" id="h11-0-51" class="i">+            verticalAlignment = Alignment.CenterVertically
</a><a href="#h11-0-52" id="h11-0-52" class="i">+        ) {
</a><a href="#h11-0-53" id="h11-0-53" class="i">+            Text(
</a><a href="#h11-0-54" id="h11-0-54" class="i">+                text = name,
</a><a href="#h11-0-55" id="h11-0-55" class="i">+                fontSize = 15.sp,
</a><a href="#h11-0-56" id="h11-0-56" class="i">+                modifier = Modifier
</a><a href="#h11-0-57" id="h11-0-57" class="i">+                    .weight(1f)
</a><a href="#h11-0-58" id="h11-0-58" class="i">+                    .onGloballyPositioned {
</a><a href="#h11-0-59" id="h11-0-59" class="i">+                        currentState = getCurrentState()
</a><a href="#h11-0-60" id="h11-0-60" class="i">+                    }
</a><a href="#h11-0-61" id="h11-0-61" class="i">+            )
</a><a href="#h11-0-62" id="h11-0-62" class="i">+
</a><a href="#h11-0-63" id="h11-0-63" class="i">+            Checkbox(
</a><a href="#h11-0-64" id="h11-0-64" class="i">+                checked = currentState,
</a><a href="#h11-0-65" id="h11-0-65" class="i">+                onCheckedChange = {
</a><a href="#h11-0-66" id="h11-0-66" class="i">+                    currentState = it
</a><a href="#h11-0-67" id="h11-0-67" class="i">+                    onState(currentState)
</a><a href="#h11-0-68" id="h11-0-68" class="i">+                }
</a><a href="#h11-0-69" id="h11-0-69" class="i">+            )
</a><a href="#h11-0-70" id="h11-0-70" class="i">+        }
</a><a href="#h11-0-71" id="h11-0-71" class="i">+    }
</a><a href="#h11-0-72" id="h11-0-72" class="i">+
</a><a href="#h11-0-73" id="h11-0-73" class="i">+    @Composable
</a><a href="#h11-0-74" id="h11-0-74" class="i">+    private fun DialogHeader(searchKeyword: MutableState&lt;String&gt;) {
</a><a href="#h11-0-75" id="h11-0-75" class="i">+        Column(
</a><a href="#h11-0-76" id="h11-0-76" class="i">+            modifier = Modifier
</a><a href="#h11-0-77" id="h11-0-77" class="i">+                .fillMaxWidth()
</a><a href="#h11-0-78" id="h11-0-78" class="i">+                .padding(10.dp),
</a><a href="#h11-0-79" id="h11-0-79" class="i">+        ) {
</a><a href="#h11-0-80" id="h11-0-80" class="i">+            Text(
</a><a href="#h11-0-81" id="h11-0-81" class="i">+                text = translation[&quot;title&quot;],
</a><a href="#h11-0-82" id="h11-0-82" class="i">+                fontSize = 23.sp,
</a><a href="#h11-0-83" id="h11-0-83" class="i">+                fontWeight = FontWeight.ExtraBold,
</a><a href="#h11-0-84" id="h11-0-84" class="i">+                modifier = Modifier
</a><a href="#h11-0-85" id="h11-0-85" class="i">+                    .align(alignment = Alignment.CenterHorizontally)
</a><a href="#h11-0-86" id="h11-0-86" class="i">+            )
</a><a href="#h11-0-87" id="h11-0-87" class="i">+        }
</a><a href="#h11-0-88" id="h11-0-88" class="i">+
</a><a href="#h11-0-89" id="h11-0-89" class="i">+        Row(
</a><a href="#h11-0-90" id="h11-0-90" class="i">+            modifier = Modifier
</a><a href="#h11-0-91" id="h11-0-91" class="i">+                .fillMaxWidth()
</a><a href="#h11-0-92" id="h11-0-92" class="i">+                .padding(10.dp),
</a><a href="#h11-0-93" id="h11-0-93" class="i">+            verticalAlignment = Alignment.CenterVertically
</a><a href="#h11-0-94" id="h11-0-94" class="i">+        ) {
</a><a href="#h11-0-95" id="h11-0-95" class="i">+            TextField(
</a><a href="#h11-0-96" id="h11-0-96" class="i">+                value = searchKeyword.value,
</a><a href="#h11-0-97" id="h11-0-97" class="i">+                onValueChange = { searchKeyword.value = it },
</a><a href="#h11-0-98" id="h11-0-98" class="i">+                label = {
</a><a href="#h11-0-99" id="h11-0-99" class="i">+                    Text(text = translation[&quot;search_hint&quot;])
</a><a href="#h11-0-100" id="h11-0-100" class="i">+                },
</a><a href="#h11-0-101" id="h11-0-101" class="i">+                modifier = Modifier
</a><a href="#h11-0-102" id="h11-0-102" class="i">+                    .weight(1f)
</a><a href="#h11-0-103" id="h11-0-103" class="i">+                    .padding(end = 10.dp),
</a><a href="#h11-0-104" id="h11-0-104" class="i">+                keyboardOptions = KeyboardOptions(keyboardType = KeyboardType.Text, imeAction = ImeAction.Done),
</a><a href="#h11-0-105" id="h11-0-105" class="i">+                leadingIcon = {
</a><a href="#h11-0-106" id="h11-0-106" class="i">+                    Icon(Icons.Filled.Search, contentDescription = &quot;Search&quot;)
</a><a href="#h11-0-107" id="h11-0-107" class="i">+                }
</a><a href="#h11-0-108" id="h11-0-108" class="i">+            )
</a><a href="#h11-0-109" id="h11-0-109" class="i">+        }
</a><a href="#h11-0-110" id="h11-0-110" class="i">+    }
</a><a href="#h11-0-111" id="h11-0-111" class="i">+
</a><a href="#h11-0-112" id="h11-0-112" class="i">+
</a><a href="#h11-0-113" id="h11-0-113" class="i">+    @Composable
</a><a href="#h11-0-114" id="h11-0-114" class="i">+    fun Content(dismiss: () -&gt; Unit = { }) {
</a><a href="#h11-0-115" id="h11-0-115" class="i">+        var cachedFriends by remember { mutableStateOf(null as List&lt;MessagingFriendInfo&gt;?) }
</a><a href="#h11-0-116" id="h11-0-116" class="i">+        var cachedGroups by remember { mutableStateOf(null as List&lt;MessagingGroupInfo&gt;?) }
</a><a href="#h11-0-117" id="h11-0-117" class="i">+
</a><a href="#h11-0-118" id="h11-0-118" class="i">+        val coroutineScope = rememberCoroutineScope()
</a><a href="#h11-0-119" id="h11-0-119" class="i">+
</a><a href="#h11-0-120" id="h11-0-120" class="i">+        var timeoutJob: Job? = null
</a><a href="#h11-0-121" id="h11-0-121" class="i">+        var hasFetchError by remember { mutableStateOf(false) }
</a><a href="#h11-0-122" id="h11-0-122" class="i">+
</a><a href="#h11-0-123" id="h11-0-123" class="i">+        LaunchedEffect(Unit) {
</a><a href="#h11-0-124" id="h11-0-124" class="i">+            context.modDatabase.receiveMessagingDataCallback = { friends, groups -&gt;
</a><a href="#h11-0-125" id="h11-0-125" class="i">+                cachedFriends = friends
</a><a href="#h11-0-126" id="h11-0-126" class="i">+                cachedGroups = groups
</a><a href="#h11-0-127" id="h11-0-127" class="i">+                timeoutJob?.cancel()
</a><a href="#h11-0-128" id="h11-0-128" class="i">+                hasFetchError = false
</a><a href="#h11-0-129" id="h11-0-129" class="i">+            }
</a><a href="#h11-0-130" id="h11-0-130" class="i">+            SnapWidgetBroadcastReceiverHelper.create(ReceiversConfig.BRIDGE_SYNC_ACTION) {}.also {
</a><a href="#h11-0-131" id="h11-0-131" class="i">+                runCatching {
</a><a href="#h11-0-132" id="h11-0-132" class="i">+                    context.androidContext.sendBroadcast(it)
</a><a href="#h11-0-133" id="h11-0-133" class="i">+                }.onFailure {
</a><a href="#h11-0-134" id="h11-0-134" class="i">+                    context.log.error(&quot;Failed to send broadcast&quot;, it)
</a><a href="#h11-0-135" id="h11-0-135" class="i">+                    hasFetchError = true
</a><a href="#h11-0-136" id="h11-0-136" class="i">+                }
</a><a href="#h11-0-137" id="h11-0-137" class="i">+            }
</a><a href="#h11-0-138" id="h11-0-138" class="i">+            timeoutJob = coroutineScope.launch {
</a><a href="#h11-0-139" id="h11-0-139" class="i">+                withContext(Dispatchers.IO) {
</a><a href="#h11-0-140" id="h11-0-140" class="i">+                    delay(10000)
</a><a href="#h11-0-141" id="h11-0-141" class="i">+                    hasFetchError = true
</a><a href="#h11-0-142" id="h11-0-142" class="i">+                }
</a><a href="#h11-0-143" id="h11-0-143" class="i">+            }
</a><a href="#h11-0-144" id="h11-0-144" class="i">+        }
</a><a href="#h11-0-145" id="h11-0-145" class="i">+
</a><a href="#h11-0-146" id="h11-0-146" class="i">+        Dialog(
</a><a href="#h11-0-147" id="h11-0-147" class="i">+            onDismissRequest = {
</a><a href="#h11-0-148" id="h11-0-148" class="i">+                timeoutJob?.cancel()
</a><a href="#h11-0-149" id="h11-0-149" class="i">+                dismiss()
</a><a href="#h11-0-150" id="h11-0-150" class="i">+            },
</a><a href="#h11-0-151" id="h11-0-151" class="i">+            properties = DialogProperties(usePlatformDefaultWidth = false)
</a><a href="#h11-0-152" id="h11-0-152" class="i">+        ) {
</a><a href="#h11-0-153" id="h11-0-153" class="i">+            Card(
</a><a href="#h11-0-154" id="h11-0-154" class="i">+                colors = CardDefaults.elevatedCardColors(),
</a><a href="#h11-0-155" id="h11-0-155" class="i">+                modifier = Modifier
</a><a href="#h11-0-156" id="h11-0-156" class="i">+                    .fillMaxSize()
</a><a href="#h11-0-157" id="h11-0-157" class="i">+                    .fillMaxWidth()
</a><a href="#h11-0-158" id="h11-0-158" class="i">+                    .padding(all = 20.dp)
</a><a href="#h11-0-159" id="h11-0-159" class="i">+            ) {
</a><a href="#h11-0-160" id="h11-0-160" class="i">+                if (cachedGroups == null || cachedFriends == null) {
</a><a href="#h11-0-161" id="h11-0-161" class="i">+                    Column(
</a><a href="#h11-0-162" id="h11-0-162" class="i">+                        modifier = Modifier
</a><a href="#h11-0-163" id="h11-0-163" class="i">+                            .fillMaxSize()
</a><a href="#h11-0-164" id="h11-0-164" class="i">+                            .padding(10.dp),
</a><a href="#h11-0-165" id="h11-0-165" class="i">+                        verticalArrangement = Arrangement.Center,
</a><a href="#h11-0-166" id="h11-0-166" class="i">+                        horizontalAlignment = Alignment.CenterHorizontally
</a><a href="#h11-0-167" id="h11-0-167" class="i">+                    ) {
</a><a href="#h11-0-168" id="h11-0-168" class="i">+                        if (hasFetchError) {
</a><a href="#h11-0-169" id="h11-0-169" class="i">+                            Text(
</a><a href="#h11-0-170" id="h11-0-170" class="i">+                                text = translation[&quot;fetch_error&quot;],
</a><a href="#h11-0-171" id="h11-0-171" class="i">+                                fontSize = 20.sp,
</a><a href="#h11-0-172" id="h11-0-172" class="i">+                                fontWeight = FontWeight.Bold,
</a><a href="#h11-0-173" id="h11-0-173" class="i">+                                modifier = Modifier.padding(bottom = 10.dp, top = 10.dp)
</a><a href="#h11-0-174" id="h11-0-174" class="i">+                            )
</a><a href="#h11-0-175" id="h11-0-175" class="i">+                            return@Card
</a><a href="#h11-0-176" id="h11-0-176" class="i">+                        }
</a><a href="#h11-0-177" id="h11-0-177" class="i">+                        CircularProgressIndicator(
</a><a href="#h11-0-178" id="h11-0-178" class="i">+                            modifier = Modifier
</a><a href="#h11-0-179" id="h11-0-179" class="i">+                                .padding()
</a><a href="#h11-0-180" id="h11-0-180" class="i">+                                .size(30.dp),
</a><a href="#h11-0-181" id="h11-0-181" class="i">+                            strokeWidth = 3.dp,
</a><a href="#h11-0-182" id="h11-0-182" class="i">+                            color = MaterialTheme.colorScheme.primary
</a><a href="#h11-0-183" id="h11-0-183" class="i">+                        )
</a><a href="#h11-0-184" id="h11-0-184" class="i">+                    }
</a><a href="#h11-0-185" id="h11-0-185" class="i">+                    return@Card
</a><a href="#h11-0-186" id="h11-0-186" class="i">+                }
</a><a href="#h11-0-187" id="h11-0-187" class="i">+
</a><a href="#h11-0-188" id="h11-0-188" class="i">+                val searchKeyword = remember { mutableStateOf(&quot;&quot;) }
</a><a href="#h11-0-189" id="h11-0-189" class="i">+
</a><a href="#h11-0-190" id="h11-0-190" class="i">+                val filteredGroups = cachedGroups!!.takeIf { searchKeyword.value.isNotBlank() }?.filter {
</a><a href="#h11-0-191" id="h11-0-191" class="i">+                    it.name.contains(searchKeyword.value, ignoreCase = true)
</a><a href="#h11-0-192" id="h11-0-192" class="i">+                } ?: cachedGroups!!
</a><a href="#h11-0-193" id="h11-0-193" class="i">+
</a><a href="#h11-0-194" id="h11-0-194" class="i">+                val filteredFriends = cachedFriends!!.takeIf { searchKeyword.value.isNotBlank() }?.filter {
</a><a href="#h11-0-195" id="h11-0-195" class="i">+                    it.mutableUsername.contains(searchKeyword.value, ignoreCase = true) ||
</a><a href="#h11-0-196" id="h11-0-196" class="i">+                    it.displayName?.contains(searchKeyword.value, ignoreCase = true) == true
</a><a href="#h11-0-197" id="h11-0-197" class="i">+                } ?: cachedFriends!!
</a><a href="#h11-0-198" id="h11-0-198" class="i">+
</a><a href="#h11-0-199" id="h11-0-199" class="i">+                DialogHeader(searchKeyword)
</a><a href="#h11-0-200" id="h11-0-200" class="i">+
</a><a href="#h11-0-201" id="h11-0-201" class="i">+                LazyColumn(
</a><a href="#h11-0-202" id="h11-0-202" class="i">+                    modifier = Modifier
</a><a href="#h11-0-203" id="h11-0-203" class="i">+                        .fillMaxSize()
</a><a href="#h11-0-204" id="h11-0-204" class="i">+                        .padding(10.dp)
</a><a href="#h11-0-205" id="h11-0-205" class="i">+                ) {
</a><a href="#h11-0-206" id="h11-0-206" class="i">+                    item {
</a><a href="#h11-0-207" id="h11-0-207" class="i">+                        if (filteredGroups.isEmpty()) return@item
</a><a href="#h11-0-208" id="h11-0-208" class="i">+                        Text(text = translation[&quot;category_groups&quot;],
</a><a href="#h11-0-209" id="h11-0-209" class="i">+                            fontSize = 20.sp,
</a><a href="#h11-0-210" id="h11-0-210" class="i">+                            fontWeight = FontWeight.Bold,
</a><a href="#h11-0-211" id="h11-0-211" class="i">+                            modifier = Modifier.padding(bottom = 10.dp, top = 10.dp)
</a><a href="#h11-0-212" id="h11-0-212" class="i">+                        )
</a><a href="#h11-0-213" id="h11-0-213" class="i">+                    }
</a><a href="#h11-0-214" id="h11-0-214" class="i">+
</a><a href="#h11-0-215" id="h11-0-215" class="i">+                    items(filteredGroups.size) {
</a><a href="#h11-0-216" id="h11-0-216" class="i">+                        val group = filteredGroups[it]
</a><a href="#h11-0-217" id="h11-0-217" class="i">+                        ListCardEntry(
</a><a href="#h11-0-218" id="h11-0-218" class="i">+                            name = group.name,
</a><a href="#h11-0-219" id="h11-0-219" class="i">+                            getCurrentState = { context.modDatabase.getGroupInfo(group.conversationId) != null }
</a><a href="#h11-0-220" id="h11-0-220" class="i">+                        ) { state -&gt;
</a><a href="#h11-0-221" id="h11-0-221" class="i">+                            if (state) {
</a><a href="#h11-0-222" id="h11-0-222" class="i">+                                context.bridgeService?.triggerScopeSync(SocialScope.GROUP, group.conversationId)
</a><a href="#h11-0-223" id="h11-0-223" class="i">+                            } else {
</a><a href="#h11-0-224" id="h11-0-224" class="i">+                                context.modDatabase.deleteGroup(group.conversationId)
</a><a href="#h11-0-225" id="h11-0-225" class="i">+                            }
</a><a href="#h11-0-226" id="h11-0-226" class="i">+                            socialRoot.updateScopeLists()
</a><a href="#h11-0-227" id="h11-0-227" class="i">+                        }
</a><a href="#h11-0-228" id="h11-0-228" class="i">+                    }
</a><a href="#h11-0-229" id="h11-0-229" class="i">+
</a><a href="#h11-0-230" id="h11-0-230" class="i">+                    item {
</a><a href="#h11-0-231" id="h11-0-231" class="i">+                        if (filteredFriends.isEmpty()) return@item
</a><a href="#h11-0-232" id="h11-0-232" class="i">+                        Text(text = translation[&quot;category_friends&quot;],
</a><a href="#h11-0-233" id="h11-0-233" class="i">+                            fontSize = 20.sp,
</a><a href="#h11-0-234" id="h11-0-234" class="i">+                            fontWeight = FontWeight.Bold,
</a><a href="#h11-0-235" id="h11-0-235" class="i">+                            modifier = Modifier.padding(bottom = 10.dp, top = 10.dp)
</a><a href="#h11-0-236" id="h11-0-236" class="i">+                        )
</a><a href="#h11-0-237" id="h11-0-237" class="i">+                    }
</a><a href="#h11-0-238" id="h11-0-238" class="i">+
</a><a href="#h11-0-239" id="h11-0-239" class="i">+                    items(filteredFriends.size) {
</a><a href="#h11-0-240" id="h11-0-240" class="i">+                        val friend = filteredFriends[it]
</a><a href="#h11-0-241" id="h11-0-241" class="i">+
</a><a href="#h11-0-242" id="h11-0-242" class="i">+                        ListCardEntry(
</a><a href="#h11-0-243" id="h11-0-243" class="i">+                            name = friend.displayName?.takeIf { name -&gt; name.isNotBlank() } ?: friend.mutableUsername,
</a><a href="#h11-0-244" id="h11-0-244" class="i">+                            getCurrentState = { context.modDatabase.getFriendInfo(friend.userId) != null }
</a><a href="#h11-0-245" id="h11-0-245" class="i">+                        ) { state -&gt;
</a><a href="#h11-0-246" id="h11-0-246" class="i">+                            if (state) {
</a><a href="#h11-0-247" id="h11-0-247" class="i">+                                context.bridgeService?.triggerScopeSync(SocialScope.FRIEND, friend.userId)
</a><a href="#h11-0-248" id="h11-0-248" class="i">+                            } else {
</a><a href="#h11-0-249" id="h11-0-249" class="i">+                                context.modDatabase.deleteFriend(friend.userId)
</a><a href="#h11-0-250" id="h11-0-250" class="i">+                            }
</a><a href="#h11-0-251" id="h11-0-251" class="i">+                            socialRoot.updateScopeLists()
</a><a href="#h11-0-252" id="h11-0-252" class="i">+                        }
</a><a href="#h11-0-253" id="h11-0-253" class="i">+                    }
</a><a href="#h11-0-254" id="h11-0-254" class="i">+                }
</a><a href="#h11-0-255" id="h11-0-255" class="i">+            }
</a><a href="#h11-0-256" id="h11-0-256" class="i">+        }
</a><a href="#h11-0-257" id="h11-0-257" class="i">+    }
</a><a href="#h11-0-258" id="h11-0-258" class="i">+}</a><a href="#h11-0-259" id="h11-0-259" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h12" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/social/LoggedStories.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/social/LoggedStories.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/social/LoggedStories.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/social/LoggedStories.kt</a></b>
<a href="#h12-0" id="h12-0" class="h">@@ -0,0 +1,277 @@
</a><a href="#h12-0-0" id="h12-0-0" class="i">+package me.rhunk.snapenhance.ui.manager.pages.social
</a><a href="#h12-0-1" id="h12-0-1" class="i">+
</a><a href="#h12-0-2" id="h12-0-2" class="i">+import android.content.Intent
</a><a href="#h12-0-3" id="h12-0-3" class="i">+import android.graphics.Bitmap
</a><a href="#h12-0-4" id="h12-0-4" class="i">+import android.graphics.BitmapFactory
</a><a href="#h12-0-5" id="h12-0-5" class="i">+import androidx.compose.foundation.Image
</a><a href="#h12-0-6" id="h12-0-6" class="i">+import androidx.compose.foundation.clickable
</a><a href="#h12-0-7" id="h12-0-7" class="i">+import androidx.compose.foundation.layout.*
</a><a href="#h12-0-8" id="h12-0-8" class="i">+import androidx.compose.foundation.lazy.grid.GridCells
</a><a href="#h12-0-9" id="h12-0-9" class="i">+import androidx.compose.foundation.lazy.grid.LazyVerticalGrid
</a><a href="#h12-0-10" id="h12-0-10" class="i">+import androidx.compose.foundation.lazy.grid.items
</a><a href="#h12-0-11" id="h12-0-11" class="i">+import androidx.compose.material3.Button
</a><a href="#h12-0-12" id="h12-0-12" class="i">+import androidx.compose.material3.Card
</a><a href="#h12-0-13" id="h12-0-13" class="i">+import androidx.compose.material3.CircularProgressIndicator
</a><a href="#h12-0-14" id="h12-0-14" class="i">+import androidx.compose.material3.Text
</a><a href="#h12-0-15" id="h12-0-15" class="i">+import androidx.compose.runtime.*
</a><a href="#h12-0-16" id="h12-0-16" class="i">+import androidx.compose.ui.Alignment
</a><a href="#h12-0-17" id="h12-0-17" class="i">+import androidx.compose.ui.Modifier
</a><a href="#h12-0-18" id="h12-0-18" class="i">+import androidx.compose.ui.graphics.ImageBitmap
</a><a href="#h12-0-19" id="h12-0-19" class="i">+import androidx.compose.ui.graphics.asImageBitmap
</a><a href="#h12-0-20" id="h12-0-20" class="i">+import androidx.compose.ui.text.style.TextAlign
</a><a href="#h12-0-21" id="h12-0-21" class="i">+import androidx.compose.ui.unit.dp
</a><a href="#h12-0-22" id="h12-0-22" class="i">+import androidx.core.content.FileProvider
</a><a href="#h12-0-23" id="h12-0-23" class="i">+import androidx.navigation.NavBackStackEntry
</a><a href="#h12-0-24" id="h12-0-24" class="i">+import coil.annotation.ExperimentalCoilApi
</a><a href="#h12-0-25" id="h12-0-25" class="i">+import coil.disk.DiskCache
</a><a href="#h12-0-26" id="h12-0-26" class="i">+import kotlinx.coroutines.Dispatchers
</a><a href="#h12-0-27" id="h12-0-27" class="i">+import kotlinx.coroutines.withContext
</a><a href="#h12-0-28" id="h12-0-28" class="i">+import kotlinx.coroutines.withTimeout
</a><a href="#h12-0-29" id="h12-0-29" class="i">+import me.rhunk.snapenhance.bridge.DownloadCallback
</a><a href="#h12-0-30" id="h12-0-30" class="i">+import me.rhunk.snapenhance.common.data.FileType
</a><a href="#h12-0-31" id="h12-0-31" class="i">+import me.rhunk.snapenhance.common.data.StoryData
</a><a href="#h12-0-32" id="h12-0-32" class="i">+import me.rhunk.snapenhance.common.data.download.*
</a><a href="#h12-0-33" id="h12-0-33" class="i">+import me.rhunk.snapenhance.common.util.ktx.longHashCode
</a><a href="#h12-0-34" id="h12-0-34" class="i">+import me.rhunk.snapenhance.common.util.snap.MediaDownloaderHelper
</a><a href="#h12-0-35" id="h12-0-35" class="i">+import me.rhunk.snapenhance.core.util.media.PreviewUtils
</a><a href="#h12-0-36" id="h12-0-36" class="i">+import me.rhunk.snapenhance.download.DownloadProcessor
</a><a href="#h12-0-37" id="h12-0-37" class="i">+import me.rhunk.snapenhance.ui.manager.Routes
</a><a href="#h12-0-38" id="h12-0-38" class="i">+import me.rhunk.snapenhance.ui.util.Dialog
</a><a href="#h12-0-39" id="h12-0-39" class="i">+import okhttp3.HttpUrl.Companion.toHttpUrl
</a><a href="#h12-0-40" id="h12-0-40" class="i">+import okhttp3.OkHttpClient
</a><a href="#h12-0-41" id="h12-0-41" class="i">+import okhttp3.Request
</a><a href="#h12-0-42" id="h12-0-42" class="i">+import java.io.File
</a><a href="#h12-0-43" id="h12-0-43" class="i">+import java.text.DateFormat
</a><a href="#h12-0-44" id="h12-0-44" class="i">+import java.util.Date
</a><a href="#h12-0-45" id="h12-0-45" class="i">+import java.util.UUID
</a><a href="#h12-0-46" id="h12-0-46" class="i">+import javax.crypto.Cipher
</a><a href="#h12-0-47" id="h12-0-47" class="i">+import javax.crypto.CipherInputStream
</a><a href="#h12-0-48" id="h12-0-48" class="i">+import javax.crypto.spec.IvParameterSpec
</a><a href="#h12-0-49" id="h12-0-49" class="i">+import javax.crypto.spec.SecretKeySpec
</a><a href="#h12-0-50" id="h12-0-50" class="i">+import kotlin.math.absoluteValue
</a><a href="#h12-0-51" id="h12-0-51" class="i">+
</a><a href="#h12-0-52" id="h12-0-52" class="i">+class LoggedStories : Routes.Route() {
</a><a href="#h12-0-53" id="h12-0-53" class="i">+    @OptIn(ExperimentalCoilApi::class)
</a><a href="#h12-0-54" id="h12-0-54" class="i">+    override val content: @Composable (NavBackStackEntry) -&gt; Unit = content@{ navBackStackEntry -&gt;
</a><a href="#h12-0-55" id="h12-0-55" class="i">+        val userId = navBackStackEntry.arguments?.getString(&quot;id&quot;) ?: return@content
</a><a href="#h12-0-56" id="h12-0-56" class="i">+
</a><a href="#h12-0-57" id="h12-0-57" class="i">+        val stories = remember {
</a><a href="#h12-0-58" id="h12-0-58" class="i">+            mutableStateListOf&lt;StoryData&gt;()
</a><a href="#h12-0-59" id="h12-0-59" class="i">+        }
</a><a href="#h12-0-60" id="h12-0-60" class="i">+        val friendInfo = remember {
</a><a href="#h12-0-61" id="h12-0-61" class="i">+            context.modDatabase.getFriendInfo(userId)
</a><a href="#h12-0-62" id="h12-0-62" class="i">+        }
</a><a href="#h12-0-63" id="h12-0-63" class="i">+        val httpClient = remember { OkHttpClient() }
</a><a href="#h12-0-64" id="h12-0-64" class="i">+        var lastStoryTimestamp by remember { mutableLongStateOf(Long.MAX_VALUE) }
</a><a href="#h12-0-65" id="h12-0-65" class="i">+
</a><a href="#h12-0-66" id="h12-0-66" class="i">+        var selectedStory by remember { mutableStateOf&lt;StoryData?&gt;(null) }
</a><a href="#h12-0-67" id="h12-0-67" class="i">+        var coilCacheFile by remember { mutableStateOf&lt;File?&gt;(null) }
</a><a href="#h12-0-68" id="h12-0-68" class="i">+
</a><a href="#h12-0-69" id="h12-0-69" class="i">+        selectedStory?.let { story -&gt;
</a><a href="#h12-0-70" id="h12-0-70" class="i">+            Dialog(onDismissRequest = {
</a><a href="#h12-0-71" id="h12-0-71" class="i">+                selectedStory = null
</a><a href="#h12-0-72" id="h12-0-72" class="i">+            }) {
</a><a href="#h12-0-73" id="h12-0-73" class="i">+                Card(
</a><a href="#h12-0-74" id="h12-0-74" class="i">+                    modifier = Modifier
</a><a href="#h12-0-75" id="h12-0-75" class="i">+                        .padding(4.dp)
</a><a href="#h12-0-76" id="h12-0-76" class="i">+                ) {
</a><a href="#h12-0-77" id="h12-0-77" class="i">+                    Column(
</a><a href="#h12-0-78" id="h12-0-78" class="i">+                        modifier = Modifier
</a><a href="#h12-0-79" id="h12-0-79" class="i">+                            .padding(16.dp)
</a><a href="#h12-0-80" id="h12-0-80" class="i">+                            .fillMaxWidth(),
</a><a href="#h12-0-81" id="h12-0-81" class="i">+                        verticalArrangement = Arrangement.spacedBy(8.dp),
</a><a href="#h12-0-82" id="h12-0-82" class="i">+                    ) {
</a><a href="#h12-0-83" id="h12-0-83" class="i">+                        Text(text = &quot;Posted on ${story.postedAt.let {
</a><a href="#h12-0-84" id="h12-0-84" class="i">+                            DateFormat.getDateTimeInstance().format(Date(it))
</a><a href="#h12-0-85" id="h12-0-85" class="i">+                        }}&quot;)
</a><a href="#h12-0-86" id="h12-0-86" class="i">+                        Text(text = &quot;Created at ${story.createdAt.let {
</a><a href="#h12-0-87" id="h12-0-87" class="i">+                            DateFormat.getDateTimeInstance().format(Date(it))
</a><a href="#h12-0-88" id="h12-0-88" class="i">+                        }}&quot;)
</a><a href="#h12-0-89" id="h12-0-89" class="i">+
</a><a href="#h12-0-90" id="h12-0-90" class="i">+                        Row(
</a><a href="#h12-0-91" id="h12-0-91" class="i">+                            modifier = Modifier.fillMaxWidth(),
</a><a href="#h12-0-92" id="h12-0-92" class="i">+                            horizontalArrangement = Arrangement.SpaceEvenly,
</a><a href="#h12-0-93" id="h12-0-93" class="i">+                        ) {
</a><a href="#h12-0-94" id="h12-0-94" class="i">+                            Button(onClick = {
</a><a href="#h12-0-95" id="h12-0-95" class="i">+                                context.androidContext.externalCacheDir?.let { cacheDir -&gt;
</a><a href="#h12-0-96" id="h12-0-96" class="i">+                                    val cacheFile = coilCacheFile ?: run {
</a><a href="#h12-0-97" id="h12-0-97" class="i">+                                        context.shortToast(&quot;Failed to get file&quot;)
</a><a href="#h12-0-98" id="h12-0-98" class="i">+                                        return@Button
</a><a href="#h12-0-99" id="h12-0-99" class="i">+                                    }
</a><a href="#h12-0-100" id="h12-0-100" class="i">+                                    val targetFile = File(cacheDir, cacheFile.name)
</a><a href="#h12-0-101" id="h12-0-101" class="i">+                                    cacheFile.copyTo(targetFile, overwrite = true)
</a><a href="#h12-0-102" id="h12-0-102" class="i">+                                    context.androidContext.startActivity(Intent().apply {
</a><a href="#h12-0-103" id="h12-0-103" class="i">+                                        action = Intent.ACTION_VIEW
</a><a href="#h12-0-104" id="h12-0-104" class="i">+                                        setDataAndType(
</a><a href="#h12-0-105" id="h12-0-105" class="i">+                                            FileProvider.getUriForFile(
</a><a href="#h12-0-106" id="h12-0-106" class="i">+                                                context.androidContext,
</a><a href="#h12-0-107" id="h12-0-107" class="i">+                                                &quot;me.rhunk.snapenhance.fileprovider&quot;,
</a><a href="#h12-0-108" id="h12-0-108" class="i">+                                                targetFile
</a><a href="#h12-0-109" id="h12-0-109" class="i">+                                            ),
</a><a href="#h12-0-110" id="h12-0-110" class="i">+                                            FileType.fromFile(targetFile).mimeType
</a><a href="#h12-0-111" id="h12-0-111" class="i">+                                        )
</a><a href="#h12-0-112" id="h12-0-112" class="i">+                                        addFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION or Intent.FLAG_ACTIVITY_NEW_TASK)
</a><a href="#h12-0-113" id="h12-0-113" class="i">+                                    })
</a><a href="#h12-0-114" id="h12-0-114" class="i">+                                }
</a><a href="#h12-0-115" id="h12-0-115" class="i">+                            }) {
</a><a href="#h12-0-116" id="h12-0-116" class="i">+                                Text(text = &quot;Open&quot;)
</a><a href="#h12-0-117" id="h12-0-117" class="i">+                            }
</a><a href="#h12-0-118" id="h12-0-118" class="i">+
</a><a href="#h12-0-119" id="h12-0-119" class="i">+                            Button(onClick = {
</a><a href="#h12-0-120" id="h12-0-120" class="i">+                                val mediaAuthor = friendInfo?.mutableUsername ?: userId
</a><a href="#h12-0-121" id="h12-0-121" class="i">+                                val uniqueHash = (selectedStory?.url ?: UUID.randomUUID().toString()).longHashCode().absoluteValue.toString(16)
</a><a href="#h12-0-122" id="h12-0-122" class="i">+
</a><a href="#h12-0-123" id="h12-0-123" class="i">+                                DownloadProcessor(
</a><a href="#h12-0-124" id="h12-0-124" class="i">+                                    remoteSideContext = context,
</a><a href="#h12-0-125" id="h12-0-125" class="i">+                                    callback = object: DownloadCallback.Default() {
</a><a href="#h12-0-126" id="h12-0-126" class="i">+                                        override fun onSuccess(outputPath: String?) {
</a><a href="#h12-0-127" id="h12-0-127" class="i">+                                            context.shortToast(&quot;Downloaded to $outputPath&quot;)
</a><a href="#h12-0-128" id="h12-0-128" class="i">+                                        }
</a><a href="#h12-0-129" id="h12-0-129" class="i">+
</a><a href="#h12-0-130" id="h12-0-130" class="i">+                                        override fun onFailure(message: String?, throwable: String?) {
</a><a href="#h12-0-131" id="h12-0-131" class="i">+                                            context.shortToast(&quot;Failed to download $message&quot;)
</a><a href="#h12-0-132" id="h12-0-132" class="i">+                                        }
</a><a href="#h12-0-133" id="h12-0-133" class="i">+                                    }
</a><a href="#h12-0-134" id="h12-0-134" class="i">+                                ).enqueue(DownloadRequest(
</a><a href="#h12-0-135" id="h12-0-135" class="i">+                                    inputMedias = arrayOf(
</a><a href="#h12-0-136" id="h12-0-136" class="i">+                                        InputMedia(
</a><a href="#h12-0-137" id="h12-0-137" class="i">+                                            content = story.url,
</a><a href="#h12-0-138" id="h12-0-138" class="i">+                                            type = DownloadMediaType.REMOTE_MEDIA,
</a><a href="#h12-0-139" id="h12-0-139" class="i">+                                            encryption = story.key?.let { it to story.iv!! }?.toKeyPair()
</a><a href="#h12-0-140" id="h12-0-140" class="i">+                                        )
</a><a href="#h12-0-141" id="h12-0-141" class="i">+                                    )
</a><a href="#h12-0-142" id="h12-0-142" class="i">+                                ), DownloadMetadata(
</a><a href="#h12-0-143" id="h12-0-143" class="i">+                                    mediaIdentifier = uniqueHash,
</a><a href="#h12-0-144" id="h12-0-144" class="i">+                                    outputPath = createNewFilePath(
</a><a href="#h12-0-145" id="h12-0-145" class="i">+                                        context.config.root,
</a><a href="#h12-0-146" id="h12-0-146" class="i">+                                        uniqueHash,
</a><a href="#h12-0-147" id="h12-0-147" class="i">+                                        MediaDownloadSource.STORY_LOGGER,
</a><a href="#h12-0-148" id="h12-0-148" class="i">+                                        mediaAuthor,
</a><a href="#h12-0-149" id="h12-0-149" class="i">+                                        story.createdAt
</a><a href="#h12-0-150" id="h12-0-150" class="i">+                                    ),
</a><a href="#h12-0-151" id="h12-0-151" class="i">+                                    iconUrl = null,
</a><a href="#h12-0-152" id="h12-0-152" class="i">+                                    mediaAuthor = friendInfo?.mutableUsername ?: userId,
</a><a href="#h12-0-153" id="h12-0-153" class="i">+                                    downloadSource = MediaDownloadSource.STORY_LOGGER.translate(context.translation),
</a><a href="#h12-0-154" id="h12-0-154" class="i">+                                ))
</a><a href="#h12-0-155" id="h12-0-155" class="i">+                            }) {
</a><a href="#h12-0-156" id="h12-0-156" class="i">+                                Text(text = &quot;Download&quot;)
</a><a href="#h12-0-157" id="h12-0-157" class="i">+                            }
</a><a href="#h12-0-158" id="h12-0-158" class="i">+                        }
</a><a href="#h12-0-159" id="h12-0-159" class="i">+                    }
</a><a href="#h12-0-160" id="h12-0-160" class="i">+                }
</a><a href="#h12-0-161" id="h12-0-161" class="i">+            }
</a><a href="#h12-0-162" id="h12-0-162" class="i">+        }
</a><a href="#h12-0-163" id="h12-0-163" class="i">+
</a><a href="#h12-0-164" id="h12-0-164" class="i">+        if (stories.isEmpty()) {
</a><a href="#h12-0-165" id="h12-0-165" class="i">+            Text(text = &quot;No stories found&quot;, Modifier.fillMaxWidth(), textAlign = TextAlign.Center)
</a><a href="#h12-0-166" id="h12-0-166" class="i">+        }
</a><a href="#h12-0-167" id="h12-0-167" class="i">+
</a><a href="#h12-0-168" id="h12-0-168" class="i">+        LazyVerticalGrid(
</a><a href="#h12-0-169" id="h12-0-169" class="i">+            columns = GridCells.Adaptive(100.dp),
</a><a href="#h12-0-170" id="h12-0-170" class="i">+            contentPadding = PaddingValues(8.dp),
</a><a href="#h12-0-171" id="h12-0-171" class="i">+        ) {
</a><a href="#h12-0-172" id="h12-0-172" class="i">+            items(stories) { story -&gt;
</a><a href="#h12-0-173" id="h12-0-173" class="i">+                var imageBitmap by remember { mutableStateOf&lt;ImageBitmap?&gt;(null) }
</a><a href="#h12-0-174" id="h12-0-174" class="i">+                val uniqueHash = remember { story.url.hashCode().absoluteValue.toString(16) }
</a><a href="#h12-0-175" id="h12-0-175" class="i">+
</a><a href="#h12-0-176" id="h12-0-176" class="i">+                fun openDiskCacheSnapshot(snapshot: DiskCache.Snapshot): Boolean {
</a><a href="#h12-0-177" id="h12-0-177" class="i">+                    runCatching {
</a><a href="#h12-0-178" id="h12-0-178" class="i">+                        val mediaList = mutableMapOf&lt;SplitMediaAssetType, ByteArray&gt;()
</a><a href="#h12-0-179" id="h12-0-179" class="i">+
</a><a href="#h12-0-180" id="h12-0-180" class="i">+                        snapshot.data.toFile().inputStream().use { inputStream -&gt;
</a><a href="#h12-0-181" id="h12-0-181" class="i">+                            MediaDownloaderHelper.getSplitElements(inputStream) { type, splitInputStream -&gt;
</a><a href="#h12-0-182" id="h12-0-182" class="i">+                                mediaList[type] = splitInputStream.readBytes()
</a><a href="#h12-0-183" id="h12-0-183" class="i">+                            }
</a><a href="#h12-0-184" id="h12-0-184" class="i">+                        }
</a><a href="#h12-0-185" id="h12-0-185" class="i">+
</a><a href="#h12-0-186" id="h12-0-186" class="i">+                        val originalMedia = mediaList[SplitMediaAssetType.ORIGINAL] ?: return@runCatching false
</a><a href="#h12-0-187" id="h12-0-187" class="i">+                        val overlay = mediaList[SplitMediaAssetType.OVERLAY]
</a><a href="#h12-0-188" id="h12-0-188" class="i">+
</a><a href="#h12-0-189" id="h12-0-189" class="i">+                        var bitmap: Bitmap? = PreviewUtils.createPreview(originalMedia, isVideo = FileType.fromByteArray(originalMedia).isVideo)
</a><a href="#h12-0-190" id="h12-0-190" class="i">+
</a><a href="#h12-0-191" id="h12-0-191" class="i">+                        overlay?.also {
</a><a href="#h12-0-192" id="h12-0-192" class="i">+                            bitmap = PreviewUtils.mergeBitmapOverlay(bitmap!!, BitmapFactory.decodeByteArray(it, 0, it.size))
</a><a href="#h12-0-193" id="h12-0-193" class="i">+                        }
</a><a href="#h12-0-194" id="h12-0-194" class="i">+
</a><a href="#h12-0-195" id="h12-0-195" class="i">+                        imageBitmap = bitmap?.asImageBitmap()
</a><a href="#h12-0-196" id="h12-0-196" class="i">+                        return true
</a><a href="#h12-0-197" id="h12-0-197" class="i">+                    }
</a><a href="#h12-0-198" id="h12-0-198" class="i">+                    return false
</a><a href="#h12-0-199" id="h12-0-199" class="i">+                }
</a><a href="#h12-0-200" id="h12-0-200" class="i">+
</a><a href="#h12-0-201" id="h12-0-201" class="i">+                LaunchedEffect(Unit) {
</a><a href="#h12-0-202" id="h12-0-202" class="i">+                    withContext(Dispatchers.IO) {
</a><a href="#h12-0-203" id="h12-0-203" class="i">+                        withTimeout(10000L) {
</a><a href="#h12-0-204" id="h12-0-204" class="i">+                            context.imageLoader.diskCache?.openSnapshot(uniqueHash)?.let {
</a><a href="#h12-0-205" id="h12-0-205" class="i">+                                openDiskCacheSnapshot(it)
</a><a href="#h12-0-206" id="h12-0-206" class="i">+                                it.close()
</a><a href="#h12-0-207" id="h12-0-207" class="i">+                                return@withTimeout
</a><a href="#h12-0-208" id="h12-0-208" class="i">+                            }
</a><a href="#h12-0-209" id="h12-0-209" class="i">+
</a><a href="#h12-0-210" id="h12-0-210" class="i">+                            runCatching {
</a><a href="#h12-0-211" id="h12-0-211" class="i">+                                val response = httpClient.newCall(Request(
</a><a href="#h12-0-212" id="h12-0-212" class="i">+                                    url = story.url.toHttpUrl()
</a><a href="#h12-0-213" id="h12-0-213" class="i">+                                )).execute()
</a><a href="#h12-0-214" id="h12-0-214" class="i">+                                response.body.byteStream().use {
</a><a href="#h12-0-215" id="h12-0-215" class="i">+                                    val decrypted = story.key?.let { _ -&gt;
</a><a href="#h12-0-216" id="h12-0-216" class="i">+                                        val cipher = Cipher.getInstance(&quot;AES/CBC/PKCS5Padding&quot;)
</a><a href="#h12-0-217" id="h12-0-217" class="i">+                                        cipher.init(Cipher.DECRYPT_MODE, SecretKeySpec(story.key, &quot;AES&quot;), IvParameterSpec(story.iv))
</a><a href="#h12-0-218" id="h12-0-218" class="i">+                                        CipherInputStream(it, cipher)
</a><a href="#h12-0-219" id="h12-0-219" class="i">+                                    } ?: it
</a><a href="#h12-0-220" id="h12-0-220" class="i">+
</a><a href="#h12-0-221" id="h12-0-221" class="i">+                                    context.imageLoader.diskCache?.openEditor(uniqueHash)?.apply {
</a><a href="#h12-0-222" id="h12-0-222" class="i">+                                        data.toFile().outputStream().use { fos -&gt;
</a><a href="#h12-0-223" id="h12-0-223" class="i">+                                            decrypted.copyTo(fos)
</a><a href="#h12-0-224" id="h12-0-224" class="i">+                                        }
</a><a href="#h12-0-225" id="h12-0-225" class="i">+                                        commitAndOpenSnapshot()?.use { snapshot -&gt;
</a><a href="#h12-0-226" id="h12-0-226" class="i">+                                            openDiskCacheSnapshot(snapshot)
</a><a href="#h12-0-227" id="h12-0-227" class="i">+                                            snapshot.close()
</a><a href="#h12-0-228" id="h12-0-228" class="i">+                                        }
</a><a href="#h12-0-229" id="h12-0-229" class="i">+                                    }
</a><a href="#h12-0-230" id="h12-0-230" class="i">+                                }
</a><a href="#h12-0-231" id="h12-0-231" class="i">+                            }.onFailure {
</a><a href="#h12-0-232" id="h12-0-232" class="i">+                                context.log.error(&quot;Failed to load story&quot;, it)
</a><a href="#h12-0-233" id="h12-0-233" class="i">+                            }
</a><a href="#h12-0-234" id="h12-0-234" class="i">+                        }
</a><a href="#h12-0-235" id="h12-0-235" class="i">+                    }
</a><a href="#h12-0-236" id="h12-0-236" class="i">+                }
</a><a href="#h12-0-237" id="h12-0-237" class="i">+
</a><a href="#h12-0-238" id="h12-0-238" class="i">+                Column(
</a><a href="#h12-0-239" id="h12-0-239" class="i">+                    modifier = Modifier
</a><a href="#h12-0-240" id="h12-0-240" class="i">+                        .padding(8.dp)
</a><a href="#h12-0-241" id="h12-0-241" class="i">+                        .clickable {
</a><a href="#h12-0-242" id="h12-0-242" class="i">+                            selectedStory = story
</a><a href="#h12-0-243" id="h12-0-243" class="i">+                            coilCacheFile = context.imageLoader.diskCache?.openSnapshot(uniqueHash).use {
</a><a href="#h12-0-244" id="h12-0-244" class="i">+                                it?.data?.toFile()
</a><a href="#h12-0-245" id="h12-0-245" class="i">+                            }
</a><a href="#h12-0-246" id="h12-0-246" class="i">+                        }
</a><a href="#h12-0-247" id="h12-0-247" class="i">+                        .heightIn(min = 128.dp),
</a><a href="#h12-0-248" id="h12-0-248" class="i">+                    horizontalAlignment = Alignment.CenterHorizontally,
</a><a href="#h12-0-249" id="h12-0-249" class="i">+                    verticalArrangement = Arrangement.Center,
</a><a href="#h12-0-250" id="h12-0-250" class="i">+                ) {
</a><a href="#h12-0-251" id="h12-0-251" class="i">+                    imageBitmap?.let {
</a><a href="#h12-0-252" id="h12-0-252" class="i">+                        Card {
</a><a href="#h12-0-253" id="h12-0-253" class="i">+                            Image(
</a><a href="#h12-0-254" id="h12-0-254" class="i">+                                bitmap = it,
</a><a href="#h12-0-255" id="h12-0-255" class="i">+                                modifier = Modifier.fillMaxSize(),
</a><a href="#h12-0-256" id="h12-0-256" class="i">+                                contentDescription = null,
</a><a href="#h12-0-257" id="h12-0-257" class="i">+                            )
</a><a href="#h12-0-258" id="h12-0-258" class="i">+                        }
</a><a href="#h12-0-259" id="h12-0-259" class="i">+                    } ?: run {
</a><a href="#h12-0-260" id="h12-0-260" class="i">+                        CircularProgressIndicator()
</a><a href="#h12-0-261" id="h12-0-261" class="i">+                    }
</a><a href="#h12-0-262" id="h12-0-262" class="i">+                }
</a><a href="#h12-0-263" id="h12-0-263" class="i">+            }
</a><a href="#h12-0-264" id="h12-0-264" class="i">+            item {
</a><a href="#h12-0-265" id="h12-0-265" class="i">+                LaunchedEffect(Unit) {
</a><a href="#h12-0-266" id="h12-0-266" class="i">+                    context.messageLogger.getStories(userId, lastStoryTimestamp, 20).also { result -&gt;
</a><a href="#h12-0-267" id="h12-0-267" class="i">+                        stories.addAll(result.values)
</a><a href="#h12-0-268" id="h12-0-268" class="i">+                        result.keys.minOrNull()?.let {
</a><a href="#h12-0-269" id="h12-0-269" class="i">+                            lastStoryTimestamp = it
</a><a href="#h12-0-270" id="h12-0-270" class="i">+                        }
</a><a href="#h12-0-271" id="h12-0-271" class="i">+                    }
</a><a href="#h12-0-272" id="h12-0-272" class="i">+                }
</a><a href="#h12-0-273" id="h12-0-273" class="i">+            }
</a><a href="#h12-0-274" id="h12-0-274" class="i">+        }
</a><a href="#h12-0-275" id="h12-0-275" class="i">+    }
</a><a href="#h12-0-276" id="h12-0-276" class="i">+}</a><a href="#h12-0-277" id="h12-0-277" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h13" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/social/ManageScope.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/social/ManageScope.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/social/ManageScope.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/social/ManageScope.kt</a></b>
<a href="#h13-0" id="h13-0" class="h">@@ -0,0 +1,383 @@
</a><a href="#h13-0-0" id="h13-0-0" class="i">+package me.rhunk.snapenhance.ui.manager.pages.social
</a><a href="#h13-0-1" id="h13-0-1" class="i">+
</a><a href="#h13-0-2" id="h13-0-2" class="i">+import android.content.Intent
</a><a href="#h13-0-3" id="h13-0-3" class="i">+import androidx.compose.foundation.layout.*
</a><a href="#h13-0-4" id="h13-0-4" class="i">+import androidx.compose.foundation.rememberScrollState
</a><a href="#h13-0-5" id="h13-0-5" class="i">+import androidx.compose.foundation.verticalScroll
</a><a href="#h13-0-6" id="h13-0-6" class="i">+import androidx.compose.material.icons.Icons
</a><a href="#h13-0-7" id="h13-0-7" class="i">+import androidx.compose.material.icons.rounded.DeleteForever
</a><a href="#h13-0-8" id="h13-0-8" class="i">+import androidx.compose.material3.*
</a><a href="#h13-0-9" id="h13-0-9" class="i">+import androidx.compose.runtime.*
</a><a href="#h13-0-10" id="h13-0-10" class="i">+import androidx.compose.ui.Alignment
</a><a href="#h13-0-11" id="h13-0-11" class="i">+import androidx.compose.ui.Modifier
</a><a href="#h13-0-12" id="h13-0-12" class="i">+import androidx.compose.ui.text.font.FontWeight
</a><a href="#h13-0-13" id="h13-0-13" class="i">+import androidx.compose.ui.unit.dp
</a><a href="#h13-0-14" id="h13-0-14" class="i">+import androidx.compose.ui.unit.sp
</a><a href="#h13-0-15" id="h13-0-15" class="i">+import androidx.navigation.NavBackStackEntry
</a><a href="#h13-0-16" id="h13-0-16" class="i">+import androidx.navigation.compose.currentBackStackEntryAsState
</a><a href="#h13-0-17" id="h13-0-17" class="i">+import kotlinx.coroutines.CoroutineScope
</a><a href="#h13-0-18" id="h13-0-18" class="i">+import kotlinx.coroutines.launch
</a><a href="#h13-0-19" id="h13-0-19" class="i">+import me.rhunk.snapenhance.common.data.MessagingRuleType
</a><a href="#h13-0-20" id="h13-0-20" class="i">+import me.rhunk.snapenhance.common.data.SocialScope
</a><a href="#h13-0-21" id="h13-0-21" class="i">+import me.rhunk.snapenhance.common.util.snap.BitmojiSelfie
</a><a href="#h13-0-22" id="h13-0-22" class="i">+import me.rhunk.snapenhance.ui.manager.Routes
</a><a href="#h13-0-23" id="h13-0-23" class="i">+import me.rhunk.snapenhance.ui.util.AlertDialogs
</a><a href="#h13-0-24" id="h13-0-24" class="i">+import me.rhunk.snapenhance.ui.util.BitmojiImage
</a><a href="#h13-0-25" id="h13-0-25" class="i">+import me.rhunk.snapenhance.ui.util.Dialog
</a><a href="#h13-0-26" id="h13-0-26" class="i">+import kotlin.io.encoding.Base64
</a><a href="#h13-0-27" id="h13-0-27" class="i">+import kotlin.io.encoding.ExperimentalEncodingApi
</a><a href="#h13-0-28" id="h13-0-28" class="i">+
</a><a href="#h13-0-29" id="h13-0-29" class="i">+class ManageScope: Routes.Route() {
</a><a href="#h13-0-30" id="h13-0-30" class="i">+    private val dialogs by lazy { AlertDialogs(context.translation) }
</a><a href="#h13-0-31" id="h13-0-31" class="i">+    private val translation by lazy { context.translation.getCategory(&quot;manager.sections.social&quot;) }
</a><a href="#h13-0-32" id="h13-0-32" class="i">+
</a><a href="#h13-0-33" id="h13-0-33" class="i">+    private fun deleteScope(scope: SocialScope, id: String, coroutineScope: CoroutineScope) {
</a><a href="#h13-0-34" id="h13-0-34" class="i">+        when (scope) {
</a><a href="#h13-0-35" id="h13-0-35" class="i">+            SocialScope.FRIEND -&gt; context.modDatabase.deleteFriend(id)
</a><a href="#h13-0-36" id="h13-0-36" class="i">+            SocialScope.GROUP -&gt; context.modDatabase.deleteGroup(id)
</a><a href="#h13-0-37" id="h13-0-37" class="i">+        }
</a><a href="#h13-0-38" id="h13-0-38" class="i">+        context.modDatabase.executeAsync {
</a><a href="#h13-0-39" id="h13-0-39" class="i">+            coroutineScope.launch {
</a><a href="#h13-0-40" id="h13-0-40" class="i">+                routes.navController.popBackStack()
</a><a href="#h13-0-41" id="h13-0-41" class="i">+            }
</a><a href="#h13-0-42" id="h13-0-42" class="i">+        }
</a><a href="#h13-0-43" id="h13-0-43" class="i">+    }
</a><a href="#h13-0-44" id="h13-0-44" class="i">+
</a><a href="#h13-0-45" id="h13-0-45" class="i">+    override val topBarActions: @Composable (RowScope.() -&gt; Unit) = topBarActions@{
</a><a href="#h13-0-46" id="h13-0-46" class="i">+        val navBackStackEntry by routes.navController.currentBackStackEntryAsState()
</a><a href="#h13-0-47" id="h13-0-47" class="i">+        var deleteConfirmDialog by remember { mutableStateOf(false) }
</a><a href="#h13-0-48" id="h13-0-48" class="i">+        val coroutineScope = rememberCoroutineScope()
</a><a href="#h13-0-49" id="h13-0-49" class="i">+
</a><a href="#h13-0-50" id="h13-0-50" class="i">+        if (deleteConfirmDialog) {
</a><a href="#h13-0-51" id="h13-0-51" class="i">+            val scope = navBackStackEntry?.arguments?.getString(&quot;scope&quot;)?.let { SocialScope.getByName(it) } ?: return@topBarActions
</a><a href="#h13-0-52" id="h13-0-52" class="i">+            val id = navBackStackEntry?.arguments?.getString(&quot;id&quot;)!!
</a><a href="#h13-0-53" id="h13-0-53" class="i">+
</a><a href="#h13-0-54" id="h13-0-54" class="i">+            Dialog(onDismissRequest = {
</a><a href="#h13-0-55" id="h13-0-55" class="i">+                deleteConfirmDialog = false
</a><a href="#h13-0-56" id="h13-0-56" class="i">+            }) {
</a><a href="#h13-0-57" id="h13-0-57" class="i">+                remember { AlertDialogs(context.translation) }.ConfirmDialog(
</a><a href="#h13-0-58" id="h13-0-58" class="i">+                    title = &quot;Are you sure you want to delete this ${scope.key.lowercase()}?&quot;,
</a><a href="#h13-0-59" id="h13-0-59" class="i">+                    onDismiss = { deleteConfirmDialog = false },
</a><a href="#h13-0-60" id="h13-0-60" class="i">+                    onConfirm = {
</a><a href="#h13-0-61" id="h13-0-61" class="i">+                        deleteScope(scope, id, coroutineScope); deleteConfirmDialog = false
</a><a href="#h13-0-62" id="h13-0-62" class="i">+                    }
</a><a href="#h13-0-63" id="h13-0-63" class="i">+                )
</a><a href="#h13-0-64" id="h13-0-64" class="i">+            }
</a><a href="#h13-0-65" id="h13-0-65" class="i">+        }
</a><a href="#h13-0-66" id="h13-0-66" class="i">+
</a><a href="#h13-0-67" id="h13-0-67" class="i">+        IconButton(
</a><a href="#h13-0-68" id="h13-0-68" class="i">+            onClick = { deleteConfirmDialog = true },
</a><a href="#h13-0-69" id="h13-0-69" class="i">+        ) {
</a><a href="#h13-0-70" id="h13-0-70" class="i">+            Icon(
</a><a href="#h13-0-71" id="h13-0-71" class="i">+                imageVector = Icons.Rounded.DeleteForever,
</a><a href="#h13-0-72" id="h13-0-72" class="i">+                contentDescription = null
</a><a href="#h13-0-73" id="h13-0-73" class="i">+            )
</a><a href="#h13-0-74" id="h13-0-74" class="i">+        }
</a><a href="#h13-0-75" id="h13-0-75" class="i">+    }
</a><a href="#h13-0-76" id="h13-0-76" class="i">+
</a><a href="#h13-0-77" id="h13-0-77" class="i">+    override val content: @Composable (NavBackStackEntry) -&gt; Unit = content@{ navBackStackEntry -&gt;
</a><a href="#h13-0-78" id="h13-0-78" class="i">+        val scope = SocialScope.getByName(navBackStackEntry.arguments?.getString(&quot;scope&quot;)!!)
</a><a href="#h13-0-79" id="h13-0-79" class="i">+        val id = navBackStackEntry.arguments?.getString(&quot;id&quot;)!!
</a><a href="#h13-0-80" id="h13-0-80" class="i">+
</a><a href="#h13-0-81" id="h13-0-81" class="i">+        Column(
</a><a href="#h13-0-82" id="h13-0-82" class="i">+            modifier = Modifier.verticalScroll(rememberScrollState())
</a><a href="#h13-0-83" id="h13-0-83" class="i">+        ) {
</a><a href="#h13-0-84" id="h13-0-84" class="i">+            when (scope) {
</a><a href="#h13-0-85" id="h13-0-85" class="i">+                SocialScope.FRIEND -&gt; Friend(id)
</a><a href="#h13-0-86" id="h13-0-86" class="i">+                SocialScope.GROUP -&gt; Group(id)
</a><a href="#h13-0-87" id="h13-0-87" class="i">+            }
</a><a href="#h13-0-88" id="h13-0-88" class="i">+
</a><a href="#h13-0-89" id="h13-0-89" class="i">+            Spacer(modifier = Modifier.height(16.dp))
</a><a href="#h13-0-90" id="h13-0-90" class="i">+
</a><a href="#h13-0-91" id="h13-0-91" class="i">+            val rules = context.modDatabase.getRules(id)
</a><a href="#h13-0-92" id="h13-0-92" class="i">+
</a><a href="#h13-0-93" id="h13-0-93" class="i">+            SectionTitle(translation[&quot;rules_title&quot;])
</a><a href="#h13-0-94" id="h13-0-94" class="i">+
</a><a href="#h13-0-95" id="h13-0-95" class="i">+            ContentCard {
</a><a href="#h13-0-96" id="h13-0-96" class="i">+                //manager anti features etc
</a><a href="#h13-0-97" id="h13-0-97" class="i">+                MessagingRuleType.entries.forEach { ruleType -&gt;
</a><a href="#h13-0-98" id="h13-0-98" class="i">+                    var ruleEnabled by remember {
</a><a href="#h13-0-99" id="h13-0-99" class="i">+                        mutableStateOf(rules.any { it.key == ruleType.key })
</a><a href="#h13-0-100" id="h13-0-100" class="i">+                    }
</a><a href="#h13-0-101" id="h13-0-101" class="i">+
</a><a href="#h13-0-102" id="h13-0-102" class="i">+                    val ruleState = context.config.root.rules.getRuleState(ruleType)
</a><a href="#h13-0-103" id="h13-0-103" class="i">+
</a><a href="#h13-0-104" id="h13-0-104" class="i">+                    Row(
</a><a href="#h13-0-105" id="h13-0-105" class="i">+                        verticalAlignment = Alignment.CenterVertically,
</a><a href="#h13-0-106" id="h13-0-106" class="i">+                        modifier = Modifier.padding(all = 4.dp)
</a><a href="#h13-0-107" id="h13-0-107" class="i">+                    ) {
</a><a href="#h13-0-108" id="h13-0-108" class="i">+                        Text(
</a><a href="#h13-0-109" id="h13-0-109" class="i">+                            text = if (ruleType.listMode &amp;&amp; ruleState != null) {
</a><a href="#h13-0-110" id="h13-0-110" class="i">+                                context.translation[&quot;rules.properties.${ruleType.key}.options.${ruleState.key}&quot;]
</a><a href="#h13-0-111" id="h13-0-111" class="i">+                            } else context.translation[&quot;rules.properties.${ruleType.key}.name&quot;],
</a><a href="#h13-0-112" id="h13-0-112" class="i">+                            modifier = Modifier.weight(1f).padding(start = 5.dp, end = 5.dp)
</a><a href="#h13-0-113" id="h13-0-113" class="i">+                        )
</a><a href="#h13-0-114" id="h13-0-114" class="i">+                        Switch(checked = ruleEnabled,
</a><a href="#h13-0-115" id="h13-0-115" class="i">+                            enabled = if (ruleType.listMode) ruleState != null else true,
</a><a href="#h13-0-116" id="h13-0-116" class="i">+                            onCheckedChange = {
</a><a href="#h13-0-117" id="h13-0-117" class="i">+                                context.modDatabase.setRule(id, ruleType.key, it)
</a><a href="#h13-0-118" id="h13-0-118" class="i">+                                ruleEnabled = it
</a><a href="#h13-0-119" id="h13-0-119" class="i">+                            })
</a><a href="#h13-0-120" id="h13-0-120" class="i">+                    }
</a><a href="#h13-0-121" id="h13-0-121" class="i">+                }
</a><a href="#h13-0-122" id="h13-0-122" class="i">+            }
</a><a href="#h13-0-123" id="h13-0-123" class="i">+        }
</a><a href="#h13-0-124" id="h13-0-124" class="i">+    }
</a><a href="#h13-0-125" id="h13-0-125" class="i">+
</a><a href="#h13-0-126" id="h13-0-126" class="i">+    @Composable
</a><a href="#h13-0-127" id="h13-0-127" class="i">+    private fun ContentCard(modifier: Modifier = Modifier, content: @Composable () -&gt; Unit) {
</a><a href="#h13-0-128" id="h13-0-128" class="i">+        Card(
</a><a href="#h13-0-129" id="h13-0-129" class="i">+            modifier = Modifier
</a><a href="#h13-0-130" id="h13-0-130" class="i">+                .padding(10.dp)
</a><a href="#h13-0-131" id="h13-0-131" class="i">+                .fillMaxWidth()
</a><a href="#h13-0-132" id="h13-0-132" class="i">+        ) {
</a><a href="#h13-0-133" id="h13-0-133" class="i">+            Column(
</a><a href="#h13-0-134" id="h13-0-134" class="i">+                modifier = Modifier
</a><a href="#h13-0-135" id="h13-0-135" class="i">+                    .padding(10.dp)
</a><a href="#h13-0-136" id="h13-0-136" class="i">+                    .fillMaxWidth()
</a><a href="#h13-0-137" id="h13-0-137" class="i">+                    .then(modifier)
</a><a href="#h13-0-138" id="h13-0-138" class="i">+            ) {
</a><a href="#h13-0-139" id="h13-0-139" class="i">+                content()
</a><a href="#h13-0-140" id="h13-0-140" class="i">+            }
</a><a href="#h13-0-141" id="h13-0-141" class="i">+        }
</a><a href="#h13-0-142" id="h13-0-142" class="i">+    }
</a><a href="#h13-0-143" id="h13-0-143" class="i">+
</a><a href="#h13-0-144" id="h13-0-144" class="i">+    @Composable
</a><a href="#h13-0-145" id="h13-0-145" class="i">+    private fun SectionTitle(title: String) {
</a><a href="#h13-0-146" id="h13-0-146" class="i">+        Text(
</a><a href="#h13-0-147" id="h13-0-147" class="i">+            text = title,
</a><a href="#h13-0-148" id="h13-0-148" class="i">+            maxLines = 1,
</a><a href="#h13-0-149" id="h13-0-149" class="i">+            fontSize = 20.sp,
</a><a href="#h13-0-150" id="h13-0-150" class="i">+            fontWeight = FontWeight.Bold,
</a><a href="#h13-0-151" id="h13-0-151" class="i">+            modifier = Modifier
</a><a href="#h13-0-152" id="h13-0-152" class="i">+                .offset(x = 20.dp)
</a><a href="#h13-0-153" id="h13-0-153" class="i">+                .padding(bottom = 10.dp)
</a><a href="#h13-0-154" id="h13-0-154" class="i">+        )
</a><a href="#h13-0-155" id="h13-0-155" class="i">+    }
</a><a href="#h13-0-156" id="h13-0-156" class="i">+
</a><a href="#h13-0-157" id="h13-0-157" class="i">+    //need to display all units?
</a><a href="#h13-0-158" id="h13-0-158" class="i">+    private fun computeStreakETA(timestamp: Long): String {
</a><a href="#h13-0-159" id="h13-0-159" class="i">+        val now = System.currentTimeMillis()
</a><a href="#h13-0-160" id="h13-0-160" class="i">+        val stringBuilder = StringBuilder()
</a><a href="#h13-0-161" id="h13-0-161" class="i">+        val diff = timestamp - now
</a><a href="#h13-0-162" id="h13-0-162" class="i">+        val seconds = diff / 1000
</a><a href="#h13-0-163" id="h13-0-163" class="i">+        val minutes = seconds / 60
</a><a href="#h13-0-164" id="h13-0-164" class="i">+        val hours = minutes / 60
</a><a href="#h13-0-165" id="h13-0-165" class="i">+        val days = hours / 24
</a><a href="#h13-0-166" id="h13-0-166" class="i">+        if (days &gt; 0) {
</a><a href="#h13-0-167" id="h13-0-167" class="i">+            stringBuilder.append(&quot;$days day &quot;)
</a><a href="#h13-0-168" id="h13-0-168" class="i">+            return stringBuilder.toString()
</a><a href="#h13-0-169" id="h13-0-169" class="i">+        }
</a><a href="#h13-0-170" id="h13-0-170" class="i">+        if (hours &gt; 0) {
</a><a href="#h13-0-171" id="h13-0-171" class="i">+            stringBuilder.append(&quot;$hours hours &quot;)
</a><a href="#h13-0-172" id="h13-0-172" class="i">+            return stringBuilder.toString()
</a><a href="#h13-0-173" id="h13-0-173" class="i">+        }
</a><a href="#h13-0-174" id="h13-0-174" class="i">+        if (minutes &gt; 0) {
</a><a href="#h13-0-175" id="h13-0-175" class="i">+            stringBuilder.append(&quot;$minutes minutes &quot;)
</a><a href="#h13-0-176" id="h13-0-176" class="i">+            return stringBuilder.toString()
</a><a href="#h13-0-177" id="h13-0-177" class="i">+        }
</a><a href="#h13-0-178" id="h13-0-178" class="i">+        if (seconds &gt; 0) {
</a><a href="#h13-0-179" id="h13-0-179" class="i">+            stringBuilder.append(&quot;$seconds seconds &quot;)
</a><a href="#h13-0-180" id="h13-0-180" class="i">+            return stringBuilder.toString()
</a><a href="#h13-0-181" id="h13-0-181" class="i">+        }
</a><a href="#h13-0-182" id="h13-0-182" class="i">+        return &quot;Expired&quot;
</a><a href="#h13-0-183" id="h13-0-183" class="i">+    }
</a><a href="#h13-0-184" id="h13-0-184" class="i">+
</a><a href="#h13-0-185" id="h13-0-185" class="i">+    @OptIn(ExperimentalEncodingApi::class)
</a><a href="#h13-0-186" id="h13-0-186" class="i">+    @Composable
</a><a href="#h13-0-187" id="h13-0-187" class="i">+    private fun Friend(id: String) {
</a><a href="#h13-0-188" id="h13-0-188" class="i">+        //fetch the friend from the database
</a><a href="#h13-0-189" id="h13-0-189" class="i">+        val friend = remember { context.modDatabase.getFriendInfo(id) } ?: run {
</a><a href="#h13-0-190" id="h13-0-190" class="i">+            Text(text = translation[&quot;not_found&quot;])
</a><a href="#h13-0-191" id="h13-0-191" class="i">+            return
</a><a href="#h13-0-192" id="h13-0-192" class="i">+        }
</a><a href="#h13-0-193" id="h13-0-193" class="i">+
</a><a href="#h13-0-194" id="h13-0-194" class="i">+        val streaks = remember {
</a><a href="#h13-0-195" id="h13-0-195" class="i">+            context.modDatabase.getFriendStreaks(id)
</a><a href="#h13-0-196" id="h13-0-196" class="i">+        }
</a><a href="#h13-0-197" id="h13-0-197" class="i">+
</a><a href="#h13-0-198" id="h13-0-198" class="i">+        Column(
</a><a href="#h13-0-199" id="h13-0-199" class="i">+            modifier = Modifier
</a><a href="#h13-0-200" id="h13-0-200" class="i">+                .padding(10.dp)
</a><a href="#h13-0-201" id="h13-0-201" class="i">+                .fillMaxWidth(),
</a><a href="#h13-0-202" id="h13-0-202" class="i">+            horizontalAlignment = Alignment.CenterHorizontally
</a><a href="#h13-0-203" id="h13-0-203" class="i">+        ) {
</a><a href="#h13-0-204" id="h13-0-204" class="i">+            val bitmojiUrl = BitmojiSelfie.getBitmojiSelfie(
</a><a href="#h13-0-205" id="h13-0-205" class="i">+                friend.selfieId, friend.bitmojiId, BitmojiSelfie.BitmojiSelfieType.THREE_D
</a><a href="#h13-0-206" id="h13-0-206" class="i">+            )
</a><a href="#h13-0-207" id="h13-0-207" class="i">+            BitmojiImage(context = context, url = bitmojiUrl, size = 100)
</a><a href="#h13-0-208" id="h13-0-208" class="i">+            Spacer(modifier = Modifier.height(16.dp))
</a><a href="#h13-0-209" id="h13-0-209" class="i">+            Text(
</a><a href="#h13-0-210" id="h13-0-210" class="i">+                text = friend.displayName ?: friend.mutableUsername,
</a><a href="#h13-0-211" id="h13-0-211" class="i">+                maxLines = 1,
</a><a href="#h13-0-212" id="h13-0-212" class="i">+                fontSize = 20.sp,
</a><a href="#h13-0-213" id="h13-0-213" class="i">+                fontWeight = FontWeight.Bold
</a><a href="#h13-0-214" id="h13-0-214" class="i">+            )
</a><a href="#h13-0-215" id="h13-0-215" class="i">+            Spacer(modifier = Modifier.height(5.dp))
</a><a href="#h13-0-216" id="h13-0-216" class="i">+            Text(
</a><a href="#h13-0-217" id="h13-0-217" class="i">+                text = friend.mutableUsername,
</a><a href="#h13-0-218" id="h13-0-218" class="i">+                maxLines = 1,
</a><a href="#h13-0-219" id="h13-0-219" class="i">+                fontSize = 12.sp,
</a><a href="#h13-0-220" id="h13-0-220" class="i">+                fontWeight = FontWeight.Light
</a><a href="#h13-0-221" id="h13-0-221" class="i">+            )
</a><a href="#h13-0-222" id="h13-0-222" class="i">+        }
</a><a href="#h13-0-223" id="h13-0-223" class="i">+
</a><a href="#h13-0-224" id="h13-0-224" class="i">+        Spacer(modifier = Modifier.height(16.dp))
</a><a href="#h13-0-225" id="h13-0-225" class="i">+
</a><a href="#h13-0-226" id="h13-0-226" class="i">+        if (context.config.root.experimental.storyLogger.get()) {
</a><a href="#h13-0-227" id="h13-0-227" class="i">+            Row(
</a><a href="#h13-0-228" id="h13-0-228" class="i">+                modifier = Modifier.fillMaxWidth(),
</a><a href="#h13-0-229" id="h13-0-229" class="i">+                horizontalArrangement = Arrangement.spacedBy(10.dp, Alignment.CenterHorizontally),
</a><a href="#h13-0-230" id="h13-0-230" class="i">+            ) {
</a><a href="#h13-0-231" id="h13-0-231" class="i">+                Button(onClick = {
</a><a href="#h13-0-232" id="h13-0-232" class="i">+                    routes.loggedStories.navigate {
</a><a href="#h13-0-233" id="h13-0-233" class="i">+                        put(&quot;id&quot;, id)
</a><a href="#h13-0-234" id="h13-0-234" class="i">+                    }
</a><a href="#h13-0-235" id="h13-0-235" class="i">+                }) {
</a><a href="#h13-0-236" id="h13-0-236" class="i">+                    Text(&quot;Show Logged Stories&quot;)
</a><a href="#h13-0-237" id="h13-0-237" class="i">+                }
</a><a href="#h13-0-238" id="h13-0-238" class="i">+            }
</a><a href="#h13-0-239" id="h13-0-239" class="i">+
</a><a href="#h13-0-240" id="h13-0-240" class="i">+            Spacer(modifier = Modifier.height(16.dp))
</a><a href="#h13-0-241" id="h13-0-241" class="i">+        }
</a><a href="#h13-0-242" id="h13-0-242" class="i">+
</a><a href="#h13-0-243" id="h13-0-243" class="i">+        Column {
</a><a href="#h13-0-244" id="h13-0-244" class="i">+            //streaks
</a><a href="#h13-0-245" id="h13-0-245" class="i">+            streaks?.let {
</a><a href="#h13-0-246" id="h13-0-246" class="i">+                var shouldNotify by remember { mutableStateOf(it.notify) }
</a><a href="#h13-0-247" id="h13-0-247" class="i">+                SectionTitle(translation[&quot;streaks_title&quot;])
</a><a href="#h13-0-248" id="h13-0-248" class="i">+                ContentCard {
</a><a href="#h13-0-249" id="h13-0-249" class="i">+                    Row(
</a><a href="#h13-0-250" id="h13-0-250" class="i">+                        verticalAlignment = Alignment.CenterVertically
</a><a href="#h13-0-251" id="h13-0-251" class="i">+                    ) {
</a><a href="#h13-0-252" id="h13-0-252" class="i">+                        Column(
</a><a href="#h13-0-253" id="h13-0-253" class="i">+                            modifier = Modifier.weight(1f),
</a><a href="#h13-0-254" id="h13-0-254" class="i">+                        ) {
</a><a href="#h13-0-255" id="h13-0-255" class="i">+                            Text(
</a><a href="#h13-0-256" id="h13-0-256" class="i">+                                text = translation.format(
</a><a href="#h13-0-257" id="h13-0-257" class="i">+                                    &quot;streaks_length_text&quot;, &quot;length&quot; to streaks.length.toString()
</a><a href="#h13-0-258" id="h13-0-258" class="i">+                                ), maxLines = 1
</a><a href="#h13-0-259" id="h13-0-259" class="i">+                            )
</a><a href="#h13-0-260" id="h13-0-260" class="i">+                            Text(
</a><a href="#h13-0-261" id="h13-0-261" class="i">+                                text = translation.format(
</a><a href="#h13-0-262" id="h13-0-262" class="i">+                                    &quot;streaks_expiration_text&quot;,
</a><a href="#h13-0-263" id="h13-0-263" class="i">+                                    &quot;eta&quot; to computeStreakETA(streaks.expirationTimestamp)
</a><a href="#h13-0-264" id="h13-0-264" class="i">+                                ), maxLines = 1
</a><a href="#h13-0-265" id="h13-0-265" class="i">+                            )
</a><a href="#h13-0-266" id="h13-0-266" class="i">+                        }
</a><a href="#h13-0-267" id="h13-0-267" class="i">+                        Row(
</a><a href="#h13-0-268" id="h13-0-268" class="i">+                            verticalAlignment = Alignment.CenterVertically
</a><a href="#h13-0-269" id="h13-0-269" class="i">+                        ) {
</a><a href="#h13-0-270" id="h13-0-270" class="i">+                            Text(
</a><a href="#h13-0-271" id="h13-0-271" class="i">+                                text = translation[&quot;reminder_button&quot;],
</a><a href="#h13-0-272" id="h13-0-272" class="i">+                                maxLines = 1,
</a><a href="#h13-0-273" id="h13-0-273" class="i">+                                modifier = Modifier.padding(end = 10.dp)
</a><a href="#h13-0-274" id="h13-0-274" class="i">+                            )
</a><a href="#h13-0-275" id="h13-0-275" class="i">+                            Switch(checked = shouldNotify, onCheckedChange = {
</a><a href="#h13-0-276" id="h13-0-276" class="i">+                                context.modDatabase.setFriendStreaksNotify(id, it)
</a><a href="#h13-0-277" id="h13-0-277" class="i">+                                shouldNotify = it
</a><a href="#h13-0-278" id="h13-0-278" class="i">+                            })
</a><a href="#h13-0-279" id="h13-0-279" class="i">+                        }
</a><a href="#h13-0-280" id="h13-0-280" class="i">+                    }
</a><a href="#h13-0-281" id="h13-0-281" class="i">+                }
</a><a href="#h13-0-282" id="h13-0-282" class="i">+            }
</a><a href="#h13-0-283" id="h13-0-283" class="i">+            Spacer(modifier = Modifier.height(16.dp))
</a><a href="#h13-0-284" id="h13-0-284" class="i">+            // e2ee section
</a><a href="#h13-0-285" id="h13-0-285" class="i">+
</a><a href="#h13-0-286" id="h13-0-286" class="i">+            if (context.config.root.experimental.e2eEncryption.globalState == true) {
</a><a href="#h13-0-287" id="h13-0-287" class="i">+                SectionTitle(translation[&quot;e2ee_title&quot;])
</a><a href="#h13-0-288" id="h13-0-288" class="i">+                var hasSecretKey by remember { mutableStateOf(context.e2eeImplementation.friendKeyExists(friend.userId))}
</a><a href="#h13-0-289" id="h13-0-289" class="i">+                var importDialog by remember { mutableStateOf(false) }
</a><a href="#h13-0-290" id="h13-0-290" class="i">+
</a><a href="#h13-0-291" id="h13-0-291" class="i">+                if (importDialog) {
</a><a href="#h13-0-292" id="h13-0-292" class="i">+                    Dialog(
</a><a href="#h13-0-293" id="h13-0-293" class="i">+                        onDismissRequest = { importDialog = false }
</a><a href="#h13-0-294" id="h13-0-294" class="i">+                    ) {
</a><a href="#h13-0-295" id="h13-0-295" class="i">+                        dialogs.RawInputDialog(onDismiss = { importDialog = false  }, onConfirm = { newKey -&gt;
</a><a href="#h13-0-296" id="h13-0-296" class="i">+                            importDialog = false
</a><a href="#h13-0-297" id="h13-0-297" class="i">+                            runCatching {
</a><a href="#h13-0-298" id="h13-0-298" class="i">+                                val key = Base64.decode(newKey)
</a><a href="#h13-0-299" id="h13-0-299" class="i">+                                if (key.size != 32) {
</a><a href="#h13-0-300" id="h13-0-300" class="i">+                                    context.longToast(&quot;Invalid key size (must be 32 bytes)&quot;)
</a><a href="#h13-0-301" id="h13-0-301" class="i">+                                    return@runCatching
</a><a href="#h13-0-302" id="h13-0-302" class="i">+                                }
</a><a href="#h13-0-303" id="h13-0-303" class="i">+
</a><a href="#h13-0-304" id="h13-0-304" class="i">+                                context.e2eeImplementation.storeSharedSecretKey(friend.userId, key)
</a><a href="#h13-0-305" id="h13-0-305" class="i">+                                context.longToast(&quot;Successfully imported key&quot;)
</a><a href="#h13-0-306" id="h13-0-306" class="i">+                                hasSecretKey = true
</a><a href="#h13-0-307" id="h13-0-307" class="i">+                            }.onFailure {
</a><a href="#h13-0-308" id="h13-0-308" class="i">+                                context.longToast(&quot;Failed to import key: ${it.message}&quot;)
</a><a href="#h13-0-309" id="h13-0-309" class="i">+                                context.log.error(&quot;Failed to import key&quot;, it)
</a><a href="#h13-0-310" id="h13-0-310" class="i">+                            }
</a><a href="#h13-0-311" id="h13-0-311" class="i">+                        })
</a><a href="#h13-0-312" id="h13-0-312" class="i">+                    }
</a><a href="#h13-0-313" id="h13-0-313" class="i">+                }
</a><a href="#h13-0-314" id="h13-0-314" class="i">+
</a><a href="#h13-0-315" id="h13-0-315" class="i">+                ContentCard {
</a><a href="#h13-0-316" id="h13-0-316" class="i">+                    Row(
</a><a href="#h13-0-317" id="h13-0-317" class="i">+                        verticalAlignment = Alignment.CenterVertically,
</a><a href="#h13-0-318" id="h13-0-318" class="i">+                        horizontalArrangement = Arrangement.spacedBy(10.dp)
</a><a href="#h13-0-319" id="h13-0-319" class="i">+                    ) {
</a><a href="#h13-0-320" id="h13-0-320" class="i">+                        if (hasSecretKey) {
</a><a href="#h13-0-321" id="h13-0-321" class="i">+                            OutlinedButton(onClick = {
</a><a href="#h13-0-322" id="h13-0-322" class="i">+                                val secretKey = Base64.encode(context.e2eeImplementation.getSharedSecretKey(friend.userId) ?: return@OutlinedButton)
</a><a href="#h13-0-323" id="h13-0-323" class="i">+                                //TODO: fingerprint auth
</a><a href="#h13-0-324" id="h13-0-324" class="i">+                                context.activity!!.startActivity(Intent.createChooser(Intent().apply {
</a><a href="#h13-0-325" id="h13-0-325" class="i">+                                    action = Intent.ACTION_SEND
</a><a href="#h13-0-326" id="h13-0-326" class="i">+                                    putExtra(Intent.EXTRA_TEXT, secretKey)
</a><a href="#h13-0-327" id="h13-0-327" class="i">+                                    type = &quot;text/plain&quot;
</a><a href="#h13-0-328" id="h13-0-328" class="i">+                                }, &quot;&quot;).apply {
</a><a href="#h13-0-329" id="h13-0-329" class="i">+                                    putExtra(Intent.EXTRA_INITIAL_INTENTS, arrayOf(
</a><a href="#h13-0-330" id="h13-0-330" class="i">+                                        Intent().apply {
</a><a href="#h13-0-331" id="h13-0-331" class="i">+                                            putExtra(Intent.EXTRA_TEXT, secretKey)
</a><a href="#h13-0-332" id="h13-0-332" class="i">+                                            putExtra(Intent.EXTRA_SUBJECT, secretKey)
</a><a href="#h13-0-333" id="h13-0-333" class="i">+                                        })
</a><a href="#h13-0-334" id="h13-0-334" class="i">+                                    )
</a><a href="#h13-0-335" id="h13-0-335" class="i">+                                })
</a><a href="#h13-0-336" id="h13-0-336" class="i">+                            }) {
</a><a href="#h13-0-337" id="h13-0-337" class="i">+                                Text(
</a><a href="#h13-0-338" id="h13-0-338" class="i">+                                    text = &quot;Export Base64&quot;,
</a><a href="#h13-0-339" id="h13-0-339" class="i">+                                    maxLines = 1
</a><a href="#h13-0-340" id="h13-0-340" class="i">+                                )
</a><a href="#h13-0-341" id="h13-0-341" class="i">+                            }
</a><a href="#h13-0-342" id="h13-0-342" class="i">+                        }
</a><a href="#h13-0-343" id="h13-0-343" class="i">+
</a><a href="#h13-0-344" id="h13-0-344" class="i">+                        OutlinedButton(onClick = { importDialog = true }) {
</a><a href="#h13-0-345" id="h13-0-345" class="i">+                            Text(
</a><a href="#h13-0-346" id="h13-0-346" class="i">+                                text = &quot;Import Base64&quot;,
</a><a href="#h13-0-347" id="h13-0-347" class="i">+                                maxLines = 1
</a><a href="#h13-0-348" id="h13-0-348" class="i">+                            )
</a><a href="#h13-0-349" id="h13-0-349" class="i">+                        }
</a><a href="#h13-0-350" id="h13-0-350" class="i">+                    }
</a><a href="#h13-0-351" id="h13-0-351" class="i">+                }
</a><a href="#h13-0-352" id="h13-0-352" class="i">+            }
</a><a href="#h13-0-353" id="h13-0-353" class="i">+        }
</a><a href="#h13-0-354" id="h13-0-354" class="i">+    }
</a><a href="#h13-0-355" id="h13-0-355" class="i">+
</a><a href="#h13-0-356" id="h13-0-356" class="i">+    @Composable
</a><a href="#h13-0-357" id="h13-0-357" class="i">+    private fun Group(id: String) {
</a><a href="#h13-0-358" id="h13-0-358" class="i">+        //fetch the group from the database
</a><a href="#h13-0-359" id="h13-0-359" class="i">+        val group = remember { context.modDatabase.getGroupInfo(id) } ?: run {
</a><a href="#h13-0-360" id="h13-0-360" class="i">+            Text(text = translation[&quot;not_found&quot;])
</a><a href="#h13-0-361" id="h13-0-361" class="i">+            return
</a><a href="#h13-0-362" id="h13-0-362" class="i">+        }
</a><a href="#h13-0-363" id="h13-0-363" class="i">+
</a><a href="#h13-0-364" id="h13-0-364" class="i">+
</a><a href="#h13-0-365" id="h13-0-365" class="i">+        Column(
</a><a href="#h13-0-366" id="h13-0-366" class="i">+            modifier = Modifier
</a><a href="#h13-0-367" id="h13-0-367" class="i">+                .padding(10.dp)
</a><a href="#h13-0-368" id="h13-0-368" class="i">+                .fillMaxWidth(),
</a><a href="#h13-0-369" id="h13-0-369" class="i">+            horizontalAlignment = Alignment.CenterHorizontally
</a><a href="#h13-0-370" id="h13-0-370" class="i">+        ) {
</a><a href="#h13-0-371" id="h13-0-371" class="i">+            Text(
</a><a href="#h13-0-372" id="h13-0-372" class="i">+                text = group.name, maxLines = 1, fontSize = 20.sp, fontWeight = FontWeight.Bold
</a><a href="#h13-0-373" id="h13-0-373" class="i">+            )
</a><a href="#h13-0-374" id="h13-0-374" class="i">+            Spacer(modifier = Modifier.height(5.dp))
</a><a href="#h13-0-375" id="h13-0-375" class="i">+            Text(
</a><a href="#h13-0-376" id="h13-0-376" class="i">+                text = translation.format(
</a><a href="#h13-0-377" id="h13-0-377" class="i">+                    &quot;participants_text&quot;, &quot;count&quot; to group.participantsCount.toString()
</a><a href="#h13-0-378" id="h13-0-378" class="i">+                ), maxLines = 1, fontSize = 12.sp, fontWeight = FontWeight.Light
</a><a href="#h13-0-379" id="h13-0-379" class="i">+            )
</a><a href="#h13-0-380" id="h13-0-380" class="i">+        }
</a><a href="#h13-0-381" id="h13-0-381" class="i">+    }
</a><a href="#h13-0-382" id="h13-0-382" class="i">+}</a><a href="#h13-0-383" id="h13-0-383" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h14" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/social/MessagingPreview.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/social/MessagingPreview.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/social/MessagingPreview.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/social/MessagingPreview.kt</a></b>
<a href="#h14-0" id="h14-0" class="h">@@ -0,0 +1,536 @@
</a><a href="#h14-0-0" id="h14-0-0" class="i">+package me.rhunk.snapenhance.ui.manager.pages.social
</a><a href="#h14-0-1" id="h14-0-1" class="i">+
</a><a href="#h14-0-2" id="h14-0-2" class="i">+import android.content.Intent
</a><a href="#h14-0-3" id="h14-0-3" class="i">+import androidx.compose.foundation.background
</a><a href="#h14-0-4" id="h14-0-4" class="i">+import androidx.compose.foundation.border
</a><a href="#h14-0-5" id="h14-0-5" class="i">+import androidx.compose.foundation.gestures.detectTapGestures
</a><a href="#h14-0-6" id="h14-0-6" class="i">+import androidx.compose.foundation.layout.*
</a><a href="#h14-0-7" id="h14-0-7" class="i">+import androidx.compose.foundation.lazy.LazyColumn
</a><a href="#h14-0-8" id="h14-0-8" class="i">+import androidx.compose.foundation.lazy.LazyListState
</a><a href="#h14-0-9" id="h14-0-9" class="i">+import androidx.compose.foundation.lazy.rememberLazyListState
</a><a href="#h14-0-10" id="h14-0-10" class="i">+import androidx.compose.foundation.shape.RoundedCornerShape
</a><a href="#h14-0-11" id="h14-0-11" class="i">+import androidx.compose.material.icons.Icons
</a><a href="#h14-0-12" id="h14-0-12" class="i">+import androidx.compose.material.icons.filled.Close
</a><a href="#h14-0-13" id="h14-0-13" class="i">+import androidx.compose.material.icons.filled.MoreVert
</a><a href="#h14-0-14" id="h14-0-14" class="i">+import androidx.compose.material.icons.rounded.BookmarkAdded
</a><a href="#h14-0-15" id="h14-0-15" class="i">+import androidx.compose.material.icons.rounded.BookmarkBorder
</a><a href="#h14-0-16" id="h14-0-16" class="i">+import androidx.compose.material.icons.rounded.DeleteForever
</a><a href="#h14-0-17" id="h14-0-17" class="i">+import androidx.compose.material.icons.rounded.RemoveRedEye
</a><a href="#h14-0-18" id="h14-0-18" class="i">+import androidx.compose.material3.*
</a><a href="#h14-0-19" id="h14-0-19" class="i">+import androidx.compose.runtime.*
</a><a href="#h14-0-20" id="h14-0-20" class="i">+import androidx.compose.ui.Alignment
</a><a href="#h14-0-21" id="h14-0-21" class="i">+import androidx.compose.ui.Modifier
</a><a href="#h14-0-22" id="h14-0-22" class="i">+import androidx.compose.ui.graphics.vector.ImageVector
</a><a href="#h14-0-23" id="h14-0-23" class="i">+import androidx.compose.ui.input.pointer.pointerInput
</a><a href="#h14-0-24" id="h14-0-24" class="i">+import androidx.compose.ui.unit.dp
</a><a href="#h14-0-25" id="h14-0-25" class="i">+import androidx.navigation.NavBackStackEntry
</a><a href="#h14-0-26" id="h14-0-26" class="i">+import kotlinx.coroutines.*
</a><a href="#h14-0-27" id="h14-0-27" class="i">+import me.rhunk.snapenhance.bridge.snapclient.MessagingBridge
</a><a href="#h14-0-28" id="h14-0-28" class="i">+import me.rhunk.snapenhance.bridge.snapclient.SessionStartListener
</a><a href="#h14-0-29" id="h14-0-29" class="i">+import me.rhunk.snapenhance.bridge.snapclient.types.Message
</a><a href="#h14-0-30" id="h14-0-30" class="i">+import me.rhunk.snapenhance.common.Constants
</a><a href="#h14-0-31" id="h14-0-31" class="i">+import me.rhunk.snapenhance.common.ReceiversConfig
</a><a href="#h14-0-32" id="h14-0-32" class="i">+import me.rhunk.snapenhance.common.data.ContentType
</a><a href="#h14-0-33" id="h14-0-33" class="i">+import me.rhunk.snapenhance.common.data.SocialScope
</a><a href="#h14-0-34" id="h14-0-34" class="i">+import me.rhunk.snapenhance.common.util.protobuf.ProtoReader
</a><a href="#h14-0-35" id="h14-0-35" class="i">+import me.rhunk.snapenhance.common.util.snap.SnapWidgetBroadcastReceiverHelper
</a><a href="#h14-0-36" id="h14-0-36" class="i">+import me.rhunk.snapenhance.messaging.MessagingConstraints
</a><a href="#h14-0-37" id="h14-0-37" class="i">+import me.rhunk.snapenhance.messaging.MessagingTask
</a><a href="#h14-0-38" id="h14-0-38" class="i">+import me.rhunk.snapenhance.messaging.MessagingTaskConstraint
</a><a href="#h14-0-39" id="h14-0-39" class="i">+import me.rhunk.snapenhance.messaging.MessagingTaskType
</a><a href="#h14-0-40" id="h14-0-40" class="i">+import me.rhunk.snapenhance.ui.manager.Routes
</a><a href="#h14-0-41" id="h14-0-41" class="i">+import me.rhunk.snapenhance.ui.util.Dialog
</a><a href="#h14-0-42" id="h14-0-42" class="i">+import java.util.SortedMap
</a><a href="#h14-0-43" id="h14-0-43" class="i">+
</a><a href="#h14-0-44" id="h14-0-44" class="i">+class MessagingPreview: Routes.Route() {
</a><a href="#h14-0-45" id="h14-0-45" class="i">+    private lateinit var coroutineScope: CoroutineScope
</a><a href="#h14-0-46" id="h14-0-46" class="i">+    private lateinit var messagingBridge: MessagingBridge
</a><a href="#h14-0-47" id="h14-0-47" class="i">+    private lateinit var previewScrollState: LazyListState
</a><a href="#h14-0-48" id="h14-0-48" class="i">+
</a><a href="#h14-0-49" id="h14-0-49" class="i">+    private val myUserId by lazy { messagingBridge.myUserId }
</a><a href="#h14-0-50" id="h14-0-50" class="i">+    private val contentTypeTranslation by lazy { context.translation.getCategory(&quot;content_type&quot;) }
</a><a href="#h14-0-51" id="h14-0-51" class="i">+
</a><a href="#h14-0-52" id="h14-0-52" class="i">+    private var messages = sortedMapOf&lt;Long, Message&gt;()
</a><a href="#h14-0-53" id="h14-0-53" class="i">+    private var messageSize by mutableIntStateOf(0)
</a><a href="#h14-0-54" id="h14-0-54" class="i">+    private var conversationId by mutableStateOf&lt;String?&gt;(null)
</a><a href="#h14-0-55" id="h14-0-55" class="i">+    private val selectedMessages = mutableStateListOf&lt;Long&gt;() // client message id
</a><a href="#h14-0-56" id="h14-0-56" class="i">+
</a><a href="#h14-0-57" id="h14-0-57" class="i">+    private fun toggleSelectedMessage(messageId: Long) {
</a><a href="#h14-0-58" id="h14-0-58" class="i">+        if (selectedMessages.contains(messageId)) selectedMessages.remove(messageId)
</a><a href="#h14-0-59" id="h14-0-59" class="i">+        else selectedMessages.add(messageId)
</a><a href="#h14-0-60" id="h14-0-60" class="i">+    }
</a><a href="#h14-0-61" id="h14-0-61" class="i">+
</a><a href="#h14-0-62" id="h14-0-62" class="i">+    @Composable
</a><a href="#h14-0-63" id="h14-0-63" class="i">+    private fun ActionButton(
</a><a href="#h14-0-64" id="h14-0-64" class="i">+        text: String,
</a><a href="#h14-0-65" id="h14-0-65" class="i">+        icon: ImageVector,
</a><a href="#h14-0-66" id="h14-0-66" class="i">+        onClick: () -&gt; Unit,
</a><a href="#h14-0-67" id="h14-0-67" class="i">+    ) {
</a><a href="#h14-0-68" id="h14-0-68" class="i">+        DropdownMenuItem(
</a><a href="#h14-0-69" id="h14-0-69" class="i">+            onClick = onClick,
</a><a href="#h14-0-70" id="h14-0-70" class="i">+            text = {
</a><a href="#h14-0-71" id="h14-0-71" class="i">+                Row(
</a><a href="#h14-0-72" id="h14-0-72" class="i">+                    modifier = Modifier.padding(5.dp),
</a><a href="#h14-0-73" id="h14-0-73" class="i">+                    horizontalArrangement = Arrangement.spacedBy(8.dp),
</a><a href="#h14-0-74" id="h14-0-74" class="i">+                    verticalAlignment = Alignment.CenterVertically
</a><a href="#h14-0-75" id="h14-0-75" class="i">+                ) {
</a><a href="#h14-0-76" id="h14-0-76" class="i">+                    Icon(
</a><a href="#h14-0-77" id="h14-0-77" class="i">+                        imageVector = icon,
</a><a href="#h14-0-78" id="h14-0-78" class="i">+                        contentDescription = null
</a><a href="#h14-0-79" id="h14-0-79" class="i">+                    )
</a><a href="#h14-0-80" id="h14-0-80" class="i">+                    Text(text = text)
</a><a href="#h14-0-81" id="h14-0-81" class="i">+                }
</a><a href="#h14-0-82" id="h14-0-82" class="i">+            }
</a><a href="#h14-0-83" id="h14-0-83" class="i">+        )
</a><a href="#h14-0-84" id="h14-0-84" class="i">+    }
</a><a href="#h14-0-85" id="h14-0-85" class="i">+
</a><a href="#h14-0-86" id="h14-0-86" class="i">+    @Composable
</a><a href="#h14-0-87" id="h14-0-87" class="i">+    private fun ConstraintsSelectionDialog(
</a><a href="#h14-0-88" id="h14-0-88" class="i">+        onChoose: (Array&lt;ContentType&gt;) -&gt; Unit,
</a><a href="#h14-0-89" id="h14-0-89" class="i">+        onDismiss: () -&gt; Unit
</a><a href="#h14-0-90" id="h14-0-90" class="i">+    ) {
</a><a href="#h14-0-91" id="h14-0-91" class="i">+        val selectedTypes = remember { mutableStateListOf&lt;ContentType&gt;() }
</a><a href="#h14-0-92" id="h14-0-92" class="i">+        var selectAllState by remember { mutableStateOf(false) }
</a><a href="#h14-0-93" id="h14-0-93" class="i">+        val availableTypes = remember { arrayOf(
</a><a href="#h14-0-94" id="h14-0-94" class="i">+            ContentType.CHAT,
</a><a href="#h14-0-95" id="h14-0-95" class="i">+            ContentType.NOTE,
</a><a href="#h14-0-96" id="h14-0-96" class="i">+            ContentType.SNAP,
</a><a href="#h14-0-97" id="h14-0-97" class="i">+            ContentType.STICKER,
</a><a href="#h14-0-98" id="h14-0-98" class="i">+            ContentType.EXTERNAL_MEDIA
</a><a href="#h14-0-99" id="h14-0-99" class="i">+        ) }
</a><a href="#h14-0-100" id="h14-0-100" class="i">+
</a><a href="#h14-0-101" id="h14-0-101" class="i">+        fun toggleContentType(contentType: ContentType) {
</a><a href="#h14-0-102" id="h14-0-102" class="i">+            if (selectAllState) return
</a><a href="#h14-0-103" id="h14-0-103" class="i">+            if (selectedTypes.contains(contentType)) {
</a><a href="#h14-0-104" id="h14-0-104" class="i">+                selectedTypes.remove(contentType)
</a><a href="#h14-0-105" id="h14-0-105" class="i">+            } else {
</a><a href="#h14-0-106" id="h14-0-106" class="i">+                selectedTypes.add(contentType)
</a><a href="#h14-0-107" id="h14-0-107" class="i">+            }
</a><a href="#h14-0-108" id="h14-0-108" class="i">+        }
</a><a href="#h14-0-109" id="h14-0-109" class="i">+
</a><a href="#h14-0-110" id="h14-0-110" class="i">+        Surface(
</a><a href="#h14-0-111" id="h14-0-111" class="i">+            modifier = Modifier
</a><a href="#h14-0-112" id="h14-0-112" class="i">+                .fillMaxWidth()
</a><a href="#h14-0-113" id="h14-0-113" class="i">+                .background(MaterialTheme.colorScheme.surface)
</a><a href="#h14-0-114" id="h14-0-114" class="i">+        ) {
</a><a href="#h14-0-115" id="h14-0-115" class="i">+            Column(
</a><a href="#h14-0-116" id="h14-0-116" class="i">+                modifier = Modifier.padding(15.dp),
</a><a href="#h14-0-117" id="h14-0-117" class="i">+                horizontalAlignment = Alignment.CenterHorizontally,
</a><a href="#h14-0-118" id="h14-0-118" class="i">+                verticalArrangement = Arrangement.spacedBy(5.dp)
</a><a href="#h14-0-119" id="h14-0-119" class="i">+            ) {
</a><a href="#h14-0-120" id="h14-0-120" class="i">+                Text(&quot;Choose content types to process&quot;)
</a><a href="#h14-0-121" id="h14-0-121" class="i">+                Spacer(modifier = Modifier.height(5.dp))
</a><a href="#h14-0-122" id="h14-0-122" class="i">+                availableTypes.forEach { contentType -&gt;
</a><a href="#h14-0-123" id="h14-0-123" class="i">+                    Row(
</a><a href="#h14-0-124" id="h14-0-124" class="i">+                        modifier = Modifier
</a><a href="#h14-0-125" id="h14-0-125" class="i">+                            .fillMaxWidth()
</a><a href="#h14-0-126" id="h14-0-126" class="i">+                            .padding(2.dp)
</a><a href="#h14-0-127" id="h14-0-127" class="i">+                            .pointerInput(Unit) {
</a><a href="#h14-0-128" id="h14-0-128" class="i">+                                detectTapGestures(onTap = { toggleContentType(contentType) })
</a><a href="#h14-0-129" id="h14-0-129" class="i">+                            },
</a><a href="#h14-0-130" id="h14-0-130" class="i">+                        horizontalArrangement = Arrangement.spacedBy(8.dp),
</a><a href="#h14-0-131" id="h14-0-131" class="i">+                        verticalAlignment = Alignment.CenterVertically
</a><a href="#h14-0-132" id="h14-0-132" class="i">+                    ) {
</a><a href="#h14-0-133" id="h14-0-133" class="i">+                        Checkbox(
</a><a href="#h14-0-134" id="h14-0-134" class="i">+                            checked = selectedTypes.contains(contentType),
</a><a href="#h14-0-135" id="h14-0-135" class="i">+                            enabled = !selectAllState,
</a><a href="#h14-0-136" id="h14-0-136" class="i">+                            onCheckedChange = { toggleContentType(contentType) }
</a><a href="#h14-0-137" id="h14-0-137" class="i">+                        )
</a><a href="#h14-0-138" id="h14-0-138" class="i">+                        Text(text = contentType.toString())
</a><a href="#h14-0-139" id="h14-0-139" class="i">+                    }
</a><a href="#h14-0-140" id="h14-0-140" class="i">+                }
</a><a href="#h14-0-141" id="h14-0-141" class="i">+                Row(
</a><a href="#h14-0-142" id="h14-0-142" class="i">+                    modifier = Modifier
</a><a href="#h14-0-143" id="h14-0-143" class="i">+                        .fillMaxWidth()
</a><a href="#h14-0-144" id="h14-0-144" class="i">+                        .padding(5.dp),
</a><a href="#h14-0-145" id="h14-0-145" class="i">+                    horizontalArrangement = Arrangement.spacedBy(10.dp),
</a><a href="#h14-0-146" id="h14-0-146" class="i">+                    verticalAlignment = Alignment.CenterVertically
</a><a href="#h14-0-147" id="h14-0-147" class="i">+                ) {
</a><a href="#h14-0-148" id="h14-0-148" class="i">+                    Switch(checked = selectAllState, onCheckedChange = {
</a><a href="#h14-0-149" id="h14-0-149" class="i">+                        selectAllState = it
</a><a href="#h14-0-150" id="h14-0-150" class="i">+                    })
</a><a href="#h14-0-151" id="h14-0-151" class="i">+                    Text(text = &quot;Select all&quot;)
</a><a href="#h14-0-152" id="h14-0-152" class="i">+                }
</a><a href="#h14-0-153" id="h14-0-153" class="i">+                Row(
</a><a href="#h14-0-154" id="h14-0-154" class="i">+                    modifier = Modifier
</a><a href="#h14-0-155" id="h14-0-155" class="i">+                        .fillMaxWidth(),
</a><a href="#h14-0-156" id="h14-0-156" class="i">+                    horizontalArrangement = Arrangement.SpaceEvenly,
</a><a href="#h14-0-157" id="h14-0-157" class="i">+                ) {
</a><a href="#h14-0-158" id="h14-0-158" class="i">+                    Button(onClick = { onDismiss() }) {
</a><a href="#h14-0-159" id="h14-0-159" class="i">+                        Text(&quot;Cancel&quot;)
</a><a href="#h14-0-160" id="h14-0-160" class="i">+                    }
</a><a href="#h14-0-161" id="h14-0-161" class="i">+                    Button(onClick = {
</a><a href="#h14-0-162" id="h14-0-162" class="i">+                        onChoose(if (selectAllState) ContentType.entries.toTypedArray()
</a><a href="#h14-0-163" id="h14-0-163" class="i">+                         else selectedTypes.toTypedArray())
</a><a href="#h14-0-164" id="h14-0-164" class="i">+                    }) {
</a><a href="#h14-0-165" id="h14-0-165" class="i">+                        Text(&quot;Continue&quot;)
</a><a href="#h14-0-166" id="h14-0-166" class="i">+                    }
</a><a href="#h14-0-167" id="h14-0-167" class="i">+                }
</a><a href="#h14-0-168" id="h14-0-168" class="i">+            }
</a><a href="#h14-0-169" id="h14-0-169" class="i">+        }
</a><a href="#h14-0-170" id="h14-0-170" class="i">+    }
</a><a href="#h14-0-171" id="h14-0-171" class="i">+
</a><a href="#h14-0-172" id="h14-0-172" class="i">+    override val topBarActions: @Composable (RowScope.() -&gt; Unit) = {
</a><a href="#h14-0-173" id="h14-0-173" class="i">+        var taskSelectionDropdown by remember { mutableStateOf(false) }
</a><a href="#h14-0-174" id="h14-0-174" class="i">+        var selectConstraintsDialog by remember { mutableStateOf(false) }
</a><a href="#h14-0-175" id="h14-0-175" class="i">+        var activeTask by remember { mutableStateOf(null as MessagingTask?) }
</a><a href="#h14-0-176" id="h14-0-176" class="i">+        var activeJob by remember { mutableStateOf(null as Job?) }
</a><a href="#h14-0-177" id="h14-0-177" class="i">+        val processMessageCount = remember { mutableIntStateOf(0) }
</a><a href="#h14-0-178" id="h14-0-178" class="i">+
</a><a href="#h14-0-179" id="h14-0-179" class="i">+        fun runCurrentTask() {
</a><a href="#h14-0-180" id="h14-0-180" class="i">+            activeJob = coroutineScope.launch(Dispatchers.IO) {
</a><a href="#h14-0-181" id="h14-0-181" class="i">+                activeTask?.run()
</a><a href="#h14-0-182" id="h14-0-182" class="i">+                withContext(Dispatchers.Main) {
</a><a href="#h14-0-183" id="h14-0-183" class="i">+                    activeTask = null
</a><a href="#h14-0-184" id="h14-0-184" class="i">+                    activeJob = null
</a><a href="#h14-0-185" id="h14-0-185" class="i">+                }
</a><a href="#h14-0-186" id="h14-0-186" class="i">+            }.also { job -&gt;
</a><a href="#h14-0-187" id="h14-0-187" class="i">+                job.invokeOnCompletion {
</a><a href="#h14-0-188" id="h14-0-188" class="i">+                    if (it != null) {
</a><a href="#h14-0-189" id="h14-0-189" class="i">+                        context.log.verbose(&quot;Failed to process messages: ${it.message}&quot;)
</a><a href="#h14-0-190" id="h14-0-190" class="i">+                        return@invokeOnCompletion
</a><a href="#h14-0-191" id="h14-0-191" class="i">+                    }
</a><a href="#h14-0-192" id="h14-0-192" class="i">+                    context.longToast(&quot;Processed ${processMessageCount.intValue} messages&quot;)
</a><a href="#h14-0-193" id="h14-0-193" class="i">+                }
</a><a href="#h14-0-194" id="h14-0-194" class="i">+            }
</a><a href="#h14-0-195" id="h14-0-195" class="i">+        }
</a><a href="#h14-0-196" id="h14-0-196" class="i">+
</a><a href="#h14-0-197" id="h14-0-197" class="i">+        fun launchMessagingTask(taskType: MessagingTaskType, constraints: List&lt;MessagingTaskConstraint&gt; = listOf(), onSuccess: (Message) -&gt; Unit = {}) {
</a><a href="#h14-0-198" id="h14-0-198" class="i">+            taskSelectionDropdown = false
</a><a href="#h14-0-199" id="h14-0-199" class="i">+            processMessageCount.intValue = 0
</a><a href="#h14-0-200" id="h14-0-200" class="i">+            activeTask = MessagingTask(
</a><a href="#h14-0-201" id="h14-0-201" class="i">+                messagingBridge, conversationId!!, taskType, constraints,
</a><a href="#h14-0-202" id="h14-0-202" class="i">+                overrideClientMessageIds = selectedMessages.takeIf { it.isNotEmpty() }?.toList(),
</a><a href="#h14-0-203" id="h14-0-203" class="i">+                processedMessageCount = processMessageCount,
</a><a href="#h14-0-204" id="h14-0-204" class="i">+                onSuccess = onSuccess,
</a><a href="#h14-0-205" id="h14-0-205" class="i">+                onFailure = { message, reason -&gt;
</a><a href="#h14-0-206" id="h14-0-206" class="i">+                    context.log.verbose(&quot;Failed to process message ${message.clientMessageId}: $reason&quot;)
</a><a href="#h14-0-207" id="h14-0-207" class="i">+                }
</a><a href="#h14-0-208" id="h14-0-208" class="i">+            )
</a><a href="#h14-0-209" id="h14-0-209" class="i">+            selectedMessages.clear()
</a><a href="#h14-0-210" id="h14-0-210" class="i">+        }
</a><a href="#h14-0-211" id="h14-0-211" class="i">+
</a><a href="#h14-0-212" id="h14-0-212" class="i">+        if (selectConstraintsDialog &amp;&amp; activeTask != null) {
</a><a href="#h14-0-213" id="h14-0-213" class="i">+            Dialog(onDismissRequest = {
</a><a href="#h14-0-214" id="h14-0-214" class="i">+                selectConstraintsDialog = false
</a><a href="#h14-0-215" id="h14-0-215" class="i">+                activeTask = null
</a><a href="#h14-0-216" id="h14-0-216" class="i">+            }) {
</a><a href="#h14-0-217" id="h14-0-217" class="i">+                ConstraintsSelectionDialog(
</a><a href="#h14-0-218" id="h14-0-218" class="i">+                    onChoose = { contentTypes -&gt;
</a><a href="#h14-0-219" id="h14-0-219" class="i">+                        launchMessagingTask(
</a><a href="#h14-0-220" id="h14-0-220" class="i">+                            taskType = activeTask!!.taskType,
</a><a href="#h14-0-221" id="h14-0-221" class="i">+                            constraints = activeTask!!.constraints + MessagingConstraints.CONTENT_TYPE(contentTypes),
</a><a href="#h14-0-222" id="h14-0-222" class="i">+                            onSuccess = activeTask!!.onSuccess
</a><a href="#h14-0-223" id="h14-0-223" class="i">+                        )
</a><a href="#h14-0-224" id="h14-0-224" class="i">+                        runCurrentTask()
</a><a href="#h14-0-225" id="h14-0-225" class="i">+                        selectConstraintsDialog = false
</a><a href="#h14-0-226" id="h14-0-226" class="i">+                    },
</a><a href="#h14-0-227" id="h14-0-227" class="i">+                    onDismiss = {
</a><a href="#h14-0-228" id="h14-0-228" class="i">+                        selectConstraintsDialog = false
</a><a href="#h14-0-229" id="h14-0-229" class="i">+                        activeTask = null
</a><a href="#h14-0-230" id="h14-0-230" class="i">+                    }
</a><a href="#h14-0-231" id="h14-0-231" class="i">+                )
</a><a href="#h14-0-232" id="h14-0-232" class="i">+            }
</a><a href="#h14-0-233" id="h14-0-233" class="i">+        }
</a><a href="#h14-0-234" id="h14-0-234" class="i">+
</a><a href="#h14-0-235" id="h14-0-235" class="i">+        if (activeJob != null) {
</a><a href="#h14-0-236" id="h14-0-236" class="i">+            Dialog(onDismissRequest = {
</a><a href="#h14-0-237" id="h14-0-237" class="i">+                activeJob?.cancel()
</a><a href="#h14-0-238" id="h14-0-238" class="i">+                activeJob = null
</a><a href="#h14-0-239" id="h14-0-239" class="i">+                activeTask = null
</a><a href="#h14-0-240" id="h14-0-240" class="i">+            }) {
</a><a href="#h14-0-241" id="h14-0-241" class="i">+                Column(modifier = Modifier
</a><a href="#h14-0-242" id="h14-0-242" class="i">+                    .fillMaxWidth()
</a><a href="#h14-0-243" id="h14-0-243" class="i">+                    .background(MaterialTheme.colorScheme.surface)
</a><a href="#h14-0-244" id="h14-0-244" class="i">+                    .padding(15.dp)
</a><a href="#h14-0-245" id="h14-0-245" class="i">+                    .border(1.dp, MaterialTheme.colorScheme.onSurface, RoundedCornerShape(20.dp)),
</a><a href="#h14-0-246" id="h14-0-246" class="i">+                    horizontalAlignment = Alignment.CenterHorizontally,
</a><a href="#h14-0-247" id="h14-0-247" class="i">+                    verticalArrangement = Arrangement.spacedBy(5.dp))
</a><a href="#h14-0-248" id="h14-0-248" class="i">+                {
</a><a href="#h14-0-249" id="h14-0-249" class="i">+                    Text(&quot;Processed ${processMessageCount.intValue} messages&quot;)
</a><a href="#h14-0-250" id="h14-0-250" class="i">+                    if (activeTask?.hasFixedGoal() == true) {
</a><a href="#h14-0-251" id="h14-0-251" class="i">+                        LinearProgressIndicator(
</a><a href="#h14-0-252" id="h14-0-252" class="i">+                            modifier = Modifier
</a><a href="#h14-0-253" id="h14-0-253" class="i">+                                .fillMaxWidth()
</a><a href="#h14-0-254" id="h14-0-254" class="i">+                                .padding(5.dp),
</a><a href="#h14-0-255" id="h14-0-255" class="i">+                            progress = processMessageCount.intValue.toFloat() / selectedMessages.size.toFloat(),
</a><a href="#h14-0-256" id="h14-0-256" class="i">+                            color = MaterialTheme.colorScheme.primary
</a><a href="#h14-0-257" id="h14-0-257" class="i">+                        )
</a><a href="#h14-0-258" id="h14-0-258" class="i">+                    } else {
</a><a href="#h14-0-259" id="h14-0-259" class="i">+                        CircularProgressIndicator(
</a><a href="#h14-0-260" id="h14-0-260" class="i">+                            modifier = Modifier
</a><a href="#h14-0-261" id="h14-0-261" class="i">+                                .padding()
</a><a href="#h14-0-262" id="h14-0-262" class="i">+                                .size(30.dp),
</a><a href="#h14-0-263" id="h14-0-263" class="i">+                            strokeWidth = 3.dp,
</a><a href="#h14-0-264" id="h14-0-264" class="i">+                            color = MaterialTheme.colorScheme.primary
</a><a href="#h14-0-265" id="h14-0-265" class="i">+                        )
</a><a href="#h14-0-266" id="h14-0-266" class="i">+                    }
</a><a href="#h14-0-267" id="h14-0-267" class="i">+                }
</a><a href="#h14-0-268" id="h14-0-268" class="i">+            }
</a><a href="#h14-0-269" id="h14-0-269" class="i">+        }
</a><a href="#h14-0-270" id="h14-0-270" class="i">+
</a><a href="#h14-0-271" id="h14-0-271" class="i">+        IconButton(onClick = { taskSelectionDropdown = !taskSelectionDropdown }) {
</a><a href="#h14-0-272" id="h14-0-272" class="i">+            Icon(imageVector = Icons.Filled.MoreVert, contentDescription = null)
</a><a href="#h14-0-273" id="h14-0-273" class="i">+        }
</a><a href="#h14-0-274" id="h14-0-274" class="i">+
</a><a href="#h14-0-275" id="h14-0-275" class="i">+        if (selectedMessages.isNotEmpty()) {
</a><a href="#h14-0-276" id="h14-0-276" class="i">+            IconButton(onClick = { selectedMessages.clear() }) {
</a><a href="#h14-0-277" id="h14-0-277" class="i">+                Icon(imageVector = Icons.Filled.Close, contentDescription = &quot;Close&quot;)
</a><a href="#h14-0-278" id="h14-0-278" class="i">+            }
</a><a href="#h14-0-279" id="h14-0-279" class="i">+        }
</a><a href="#h14-0-280" id="h14-0-280" class="i">+
</a><a href="#h14-0-281" id="h14-0-281" class="i">+        MaterialTheme(
</a><a href="#h14-0-282" id="h14-0-282" class="i">+            colorScheme = MaterialTheme.colorScheme.copy(
</a><a href="#h14-0-283" id="h14-0-283" class="i">+                surface = MaterialTheme.colorScheme.inverseSurface,
</a><a href="#h14-0-284" id="h14-0-284" class="i">+                onSurface = MaterialTheme.colorScheme.inverseOnSurface
</a><a href="#h14-0-285" id="h14-0-285" class="i">+            ),
</a><a href="#h14-0-286" id="h14-0-286" class="i">+            shapes = MaterialTheme.shapes.copy(medium = RoundedCornerShape(50.dp))
</a><a href="#h14-0-287" id="h14-0-287" class="i">+        ) {
</a><a href="#h14-0-288" id="h14-0-288" class="i">+            DropdownMenu(
</a><a href="#h14-0-289" id="h14-0-289" class="i">+                expanded = taskSelectionDropdown, onDismissRequest = { taskSelectionDropdown = false }
</a><a href="#h14-0-290" id="h14-0-290" class="i">+            ) {
</a><a href="#h14-0-291" id="h14-0-291" class="i">+                val hasSelection = selectedMessages.isNotEmpty()
</a><a href="#h14-0-292" id="h14-0-292" class="i">+                ActionButton(text = if (hasSelection) &quot;Save selection&quot; else &quot;Save all&quot;, icon = Icons.Rounded.BookmarkAdded) {
</a><a href="#h14-0-293" id="h14-0-293" class="i">+                    launchMessagingTask(MessagingTaskType.SAVE)
</a><a href="#h14-0-294" id="h14-0-294" class="i">+                    if (hasSelection) runCurrentTask()
</a><a href="#h14-0-295" id="h14-0-295" class="i">+                    else selectConstraintsDialog = true
</a><a href="#h14-0-296" id="h14-0-296" class="i">+                }
</a><a href="#h14-0-297" id="h14-0-297" class="i">+                ActionButton(text = if (hasSelection) &quot;Unsave selection&quot; else &quot;Unsave all&quot;, icon = Icons.Rounded.BookmarkBorder) {
</a><a href="#h14-0-298" id="h14-0-298" class="i">+                    launchMessagingTask(MessagingTaskType.UNSAVE)
</a><a href="#h14-0-299" id="h14-0-299" class="i">+                    if (hasSelection) runCurrentTask()
</a><a href="#h14-0-300" id="h14-0-300" class="i">+                    else selectConstraintsDialog = true
</a><a href="#h14-0-301" id="h14-0-301" class="i">+                }
</a><a href="#h14-0-302" id="h14-0-302" class="i">+                ActionButton(text = if (hasSelection) &quot;Mark selected Snap as seen&quot; else &quot;Mark all Snaps as seen&quot;, icon = Icons.Rounded.RemoveRedEye) {
</a><a href="#h14-0-303" id="h14-0-303" class="i">+                    launchMessagingTask(MessagingTaskType.READ, listOf(
</a><a href="#h14-0-304" id="h14-0-304" class="i">+                        MessagingConstraints.NO_USER_ID(myUserId),
</a><a href="#h14-0-305" id="h14-0-305" class="i">+                        MessagingConstraints.CONTENT_TYPE(arrayOf(ContentType.SNAP))
</a><a href="#h14-0-306" id="h14-0-306" class="i">+                    ))
</a><a href="#h14-0-307" id="h14-0-307" class="i">+                    runCurrentTask()
</a><a href="#h14-0-308" id="h14-0-308" class="i">+                }
</a><a href="#h14-0-309" id="h14-0-309" class="i">+                ActionButton(text = if (hasSelection) &quot;Delete selected&quot; else &quot;Delete all&quot;, icon = Icons.Rounded.DeleteForever) {
</a><a href="#h14-0-310" id="h14-0-310" class="i">+                    launchMessagingTask(MessagingTaskType.DELETE, listOf(MessagingConstraints.USER_ID(myUserId))) { message -&gt;
</a><a href="#h14-0-311" id="h14-0-311" class="i">+                        coroutineScope.launch {
</a><a href="#h14-0-312" id="h14-0-312" class="i">+                            messages.remove(message.serverMessageId)
</a><a href="#h14-0-313" id="h14-0-313" class="i">+                            messageSize = messages.size
</a><a href="#h14-0-314" id="h14-0-314" class="i">+                        }
</a><a href="#h14-0-315" id="h14-0-315" class="i">+                    }
</a><a href="#h14-0-316" id="h14-0-316" class="i">+                    if (hasSelection) runCurrentTask()
</a><a href="#h14-0-317" id="h14-0-317" class="i">+                    else selectConstraintsDialog = true
</a><a href="#h14-0-318" id="h14-0-318" class="i">+                }
</a><a href="#h14-0-319" id="h14-0-319" class="i">+            }
</a><a href="#h14-0-320" id="h14-0-320" class="i">+        }
</a><a href="#h14-0-321" id="h14-0-321" class="i">+    }
</a><a href="#h14-0-322" id="h14-0-322" class="i">+
</a><a href="#h14-0-323" id="h14-0-323" class="i">+    @Composable
</a><a href="#h14-0-324" id="h14-0-324" class="i">+    private fun ConversationPreview(
</a><a href="#h14-0-325" id="h14-0-325" class="i">+        messages: SortedMap&lt;Long, Message&gt;,
</a><a href="#h14-0-326" id="h14-0-326" class="i">+        messageSize: Int,
</a><a href="#h14-0-327" id="h14-0-327" class="i">+        fetchNewMessages: () -&gt; Unit
</a><a href="#h14-0-328" id="h14-0-328" class="i">+    ) {
</a><a href="#h14-0-329" id="h14-0-329" class="i">+        DisposableEffect(Unit) {
</a><a href="#h14-0-330" id="h14-0-330" class="i">+            onDispose {
</a><a href="#h14-0-331" id="h14-0-331" class="i">+                selectedMessages.clear()
</a><a href="#h14-0-332" id="h14-0-332" class="i">+            }
</a><a href="#h14-0-333" id="h14-0-333" class="i">+        }
</a><a href="#h14-0-334" id="h14-0-334" class="i">+
</a><a href="#h14-0-335" id="h14-0-335" class="i">+        LazyColumn(
</a><a href="#h14-0-336" id="h14-0-336" class="i">+            modifier = Modifier
</a><a href="#h14-0-337" id="h14-0-337" class="i">+                .fillMaxSize(),
</a><a href="#h14-0-338" id="h14-0-338" class="i">+            state = previewScrollState,
</a><a href="#h14-0-339" id="h14-0-339" class="i">+        ) {
</a><a href="#h14-0-340" id="h14-0-340" class="i">+            item {
</a><a href="#h14-0-341" id="h14-0-341" class="i">+                if (messages.isEmpty()) {
</a><a href="#h14-0-342" id="h14-0-342" class="i">+                    Row(
</a><a href="#h14-0-343" id="h14-0-343" class="i">+                        modifier = Modifier
</a><a href="#h14-0-344" id="h14-0-344" class="i">+                            .fillMaxWidth()
</a><a href="#h14-0-345" id="h14-0-345" class="i">+                            .padding(40.dp),
</a><a href="#h14-0-346" id="h14-0-346" class="i">+                        horizontalArrangement = Arrangement.Center
</a><a href="#h14-0-347" id="h14-0-347" class="i">+                    ) {
</a><a href="#h14-0-348" id="h14-0-348" class="i">+                        Text(&quot;No messages&quot;)
</a><a href="#h14-0-349" id="h14-0-349" class="i">+                    }
</a><a href="#h14-0-350" id="h14-0-350" class="i">+                }
</a><a href="#h14-0-351" id="h14-0-351" class="i">+                Spacer(modifier = Modifier.height(20.dp))
</a><a href="#h14-0-352" id="h14-0-352" class="i">+
</a><a href="#h14-0-353" id="h14-0-353" class="i">+                LaunchedEffect(Unit) {
</a><a href="#h14-0-354" id="h14-0-354" class="i">+                    if (messages.size &gt; 0) {
</a><a href="#h14-0-355" id="h14-0-355" class="i">+                        fetchNewMessages()
</a><a href="#h14-0-356" id="h14-0-356" class="i">+                    }
</a><a href="#h14-0-357" id="h14-0-357" class="i">+                }
</a><a href="#h14-0-358" id="h14-0-358" class="i">+            }
</a><a href="#h14-0-359" id="h14-0-359" class="i">+            items(messageSize) {index -&gt;
</a><a href="#h14-0-360" id="h14-0-360" class="i">+                val elementKey = remember(index) { messages.entries.elementAt(index).value.clientMessageId }
</a><a href="#h14-0-361" id="h14-0-361" class="i">+                val messageReader = ProtoReader(messages.entries.elementAt(index).value.content)
</a><a href="#h14-0-362" id="h14-0-362" class="i">+                val contentType = ContentType.fromMessageContainer(messageReader)
</a><a href="#h14-0-363" id="h14-0-363" class="i">+
</a><a href="#h14-0-364" id="h14-0-364" class="i">+                Card(
</a><a href="#h14-0-365" id="h14-0-365" class="i">+                    modifier = Modifier
</a><a href="#h14-0-366" id="h14-0-366" class="i">+                        .padding(5.dp)
</a><a href="#h14-0-367" id="h14-0-367" class="i">+                        .pointerInput(Unit) {
</a><a href="#h14-0-368" id="h14-0-368" class="i">+                            if (contentType == ContentType.STATUS) return@pointerInput
</a><a href="#h14-0-369" id="h14-0-369" class="i">+                            detectTapGestures(
</a><a href="#h14-0-370" id="h14-0-370" class="i">+                                onLongPress = {
</a><a href="#h14-0-371" id="h14-0-371" class="i">+                                    toggleSelectedMessage(elementKey)
</a><a href="#h14-0-372" id="h14-0-372" class="i">+                                },
</a><a href="#h14-0-373" id="h14-0-373" class="i">+                                onTap = {
</a><a href="#h14-0-374" id="h14-0-374" class="i">+                                    if (selectedMessages.isNotEmpty()) {
</a><a href="#h14-0-375" id="h14-0-375" class="i">+                                        toggleSelectedMessage(elementKey)
</a><a href="#h14-0-376" id="h14-0-376" class="i">+                                    }
</a><a href="#h14-0-377" id="h14-0-377" class="i">+                                }
</a><a href="#h14-0-378" id="h14-0-378" class="i">+                            )
</a><a href="#h14-0-379" id="h14-0-379" class="i">+                        },
</a><a href="#h14-0-380" id="h14-0-380" class="i">+                    colors = CardDefaults.cardColors(
</a><a href="#h14-0-381" id="h14-0-381" class="i">+                        containerColor = if (selectedMessages.contains(elementKey)) MaterialTheme.colorScheme.primaryContainer else MaterialTheme.colorScheme.surfaceVariant
</a><a href="#h14-0-382" id="h14-0-382" class="i">+                    ),
</a><a href="#h14-0-383" id="h14-0-383" class="i">+                ) {
</a><a href="#h14-0-384" id="h14-0-384" class="i">+                    Row(
</a><a href="#h14-0-385" id="h14-0-385" class="i">+                        modifier = Modifier
</a><a href="#h14-0-386" id="h14-0-386" class="i">+                            .padding(5.dp)
</a><a href="#h14-0-387" id="h14-0-387" class="i">+                    ) {
</a><a href="#h14-0-388" id="h14-0-388" class="i">+
</a><a href="#h14-0-389" id="h14-0-389" class="i">+                        Text(&quot;[${contentType?.let { contentTypeTranslation.getOrNull(it.name) ?: it.name } }] ${messageReader.getString(2, 1) ?: &quot;&quot;}&quot;)
</a><a href="#h14-0-390" id="h14-0-390" class="i">+                    }
</a><a href="#h14-0-391" id="h14-0-391" class="i">+                }
</a><a href="#h14-0-392" id="h14-0-392" class="i">+            }
</a><a href="#h14-0-393" id="h14-0-393" class="i">+        }
</a><a href="#h14-0-394" id="h14-0-394" class="i">+    }
</a><a href="#h14-0-395" id="h14-0-395" class="i">+
</a><a href="#h14-0-396" id="h14-0-396" class="i">+
</a><a href="#h14-0-397" id="h14-0-397" class="i">+    @Composable
</a><a href="#h14-0-398" id="h14-0-398" class="i">+    private fun LoadingRow() {
</a><a href="#h14-0-399" id="h14-0-399" class="i">+        Row(
</a><a href="#h14-0-400" id="h14-0-400" class="i">+            modifier = Modifier
</a><a href="#h14-0-401" id="h14-0-401" class="i">+                .fillMaxWidth()
</a><a href="#h14-0-402" id="h14-0-402" class="i">+                .padding(40.dp),
</a><a href="#h14-0-403" id="h14-0-403" class="i">+            horizontalArrangement = Arrangement.Center
</a><a href="#h14-0-404" id="h14-0-404" class="i">+        ) {
</a><a href="#h14-0-405" id="h14-0-405" class="i">+            CircularProgressIndicator(
</a><a href="#h14-0-406" id="h14-0-406" class="i">+                modifier = Modifier
</a><a href="#h14-0-407" id="h14-0-407" class="i">+                    .padding()
</a><a href="#h14-0-408" id="h14-0-408" class="i">+                    .size(30.dp),
</a><a href="#h14-0-409" id="h14-0-409" class="i">+                strokeWidth = 3.dp,
</a><a href="#h14-0-410" id="h14-0-410" class="i">+                color = MaterialTheme.colorScheme.primary
</a><a href="#h14-0-411" id="h14-0-411" class="i">+            )
</a><a href="#h14-0-412" id="h14-0-412" class="i">+        }
</a><a href="#h14-0-413" id="h14-0-413" class="i">+    }
</a><a href="#h14-0-414" id="h14-0-414" class="i">+
</a><a href="#h14-0-415" id="h14-0-415" class="i">+    override val content: @Composable (NavBackStackEntry) -&gt; Unit = { navBackStackEntry -&gt;
</a><a href="#h14-0-416" id="h14-0-416" class="i">+        val scope = remember { SocialScope.getByName(navBackStackEntry.arguments?.getString(&quot;scope&quot;)!!) }
</a><a href="#h14-0-417" id="h14-0-417" class="i">+        val id = remember { navBackStackEntry.arguments?.getString(&quot;id&quot;)!! }
</a><a href="#h14-0-418" id="h14-0-418" class="i">+
</a><a href="#h14-0-419" id="h14-0-419" class="i">+        previewScrollState = rememberLazyListState()
</a><a href="#h14-0-420" id="h14-0-420" class="i">+        coroutineScope = rememberCoroutineScope()
</a><a href="#h14-0-421" id="h14-0-421" class="i">+
</a><a href="#h14-0-422" id="h14-0-422" class="i">+        var lastMessageId by remember { mutableLongStateOf(Long.MAX_VALUE) }
</a><a href="#h14-0-423" id="h14-0-423" class="i">+        var isBridgeConnected by remember { mutableStateOf(false) }
</a><a href="#h14-0-424" id="h14-0-424" class="i">+        var hasBridgeError by remember { mutableStateOf(false) }
</a><a href="#h14-0-425" id="h14-0-425" class="i">+
</a><a href="#h14-0-426" id="h14-0-426" class="i">+        fun fetchNewMessages() {
</a><a href="#h14-0-427" id="h14-0-427" class="i">+            coroutineScope.launch(Dispatchers.IO) cs@{
</a><a href="#h14-0-428" id="h14-0-428" class="i">+                runCatching {
</a><a href="#h14-0-429" id="h14-0-429" class="i">+                    val queriedMessages = messagingBridge.fetchConversationWithMessagesPaginated(
</a><a href="#h14-0-430" id="h14-0-430" class="i">+                        conversationId!!,
</a><a href="#h14-0-431" id="h14-0-431" class="i">+                        20,
</a><a href="#h14-0-432" id="h14-0-432" class="i">+                        lastMessageId
</a><a href="#h14-0-433" id="h14-0-433" class="i">+                    )
</a><a href="#h14-0-434" id="h14-0-434" class="i">+
</a><a href="#h14-0-435" id="h14-0-435" class="i">+                    if (queriedMessages == null) {
</a><a href="#h14-0-436" id="h14-0-436" class="i">+                        context.shortToast(&quot;Failed to fetch messages&quot;)
</a><a href="#h14-0-437" id="h14-0-437" class="i">+                        return@cs
</a><a href="#h14-0-438" id="h14-0-438" class="i">+                    }
</a><a href="#h14-0-439" id="h14-0-439" class="i">+
</a><a href="#h14-0-440" id="h14-0-440" class="i">+                    withContext(Dispatchers.Main) {
</a><a href="#h14-0-441" id="h14-0-441" class="i">+                        messages.putAll(queriedMessages.map { it.serverMessageId to it })
</a><a href="#h14-0-442" id="h14-0-442" class="i">+                        messageSize = messages.size
</a><a href="#h14-0-443" id="h14-0-443" class="i">+                        if (queriedMessages.isNotEmpty()) {
</a><a href="#h14-0-444" id="h14-0-444" class="i">+                            lastMessageId = queriedMessages.first().clientMessageId
</a><a href="#h14-0-445" id="h14-0-445" class="i">+                            delay(20)
</a><a href="#h14-0-446" id="h14-0-446" class="i">+                            previewScrollState.scrollToItem(queriedMessages.size - 1)
</a><a href="#h14-0-447" id="h14-0-447" class="i">+                        }
</a><a href="#h14-0-448" id="h14-0-448" class="i">+                    }
</a><a href="#h14-0-449" id="h14-0-449" class="i">+                }.onFailure {
</a><a href="#h14-0-450" id="h14-0-450" class="i">+                    context.log.error(&quot;Failed to fetch messages&quot;, it)
</a><a href="#h14-0-451" id="h14-0-451" class="i">+                    context.shortToast(&quot;Failed to fetch messages: ${it.message}&quot;)
</a><a href="#h14-0-452" id="h14-0-452" class="i">+                }
</a><a href="#h14-0-453" id="h14-0-453" class="i">+                context.log.verbose(&quot;fetched ${messages.size} messages&quot;)
</a><a href="#h14-0-454" id="h14-0-454" class="i">+            }
</a><a href="#h14-0-455" id="h14-0-455" class="i">+        }
</a><a href="#h14-0-456" id="h14-0-456" class="i">+
</a><a href="#h14-0-457" id="h14-0-457" class="i">+        fun onMessagingBridgeReady(scope: SocialScope, scopeId: String) {
</a><a href="#h14-0-458" id="h14-0-458" class="i">+            context.log.verbose(&quot;onMessagingBridgeReady: $scope $scopeId&quot;)
</a><a href="#h14-0-459" id="h14-0-459" class="i">+
</a><a href="#h14-0-460" id="h14-0-460" class="i">+            runCatching {
</a><a href="#h14-0-461" id="h14-0-461" class="i">+                messagingBridge = context.bridgeService!!.messagingBridge!!
</a><a href="#h14-0-462" id="h14-0-462" class="i">+                conversationId = if (scope == SocialScope.FRIEND) messagingBridge.getOneToOneConversationId(scopeId) else scopeId
</a><a href="#h14-0-463" id="h14-0-463" class="i">+                if (conversationId == null) {
</a><a href="#h14-0-464" id="h14-0-464" class="i">+                    context.longToast(&quot;Failed to fetch conversation id&quot;)
</a><a href="#h14-0-465" id="h14-0-465" class="i">+                    return
</a><a href="#h14-0-466" id="h14-0-466" class="i">+                }
</a><a href="#h14-0-467" id="h14-0-467" class="i">+                if (runCatching { !messagingBridge.isSessionStarted }.getOrDefault(true)) {
</a><a href="#h14-0-468" id="h14-0-468" class="i">+                    context.androidContext.packageManager.getLaunchIntentForPackage(
</a><a href="#h14-0-469" id="h14-0-469" class="i">+                        Constants.SNAPCHAT_PACKAGE_NAME
</a><a href="#h14-0-470" id="h14-0-470" class="i">+                    )?.let {
</a><a href="#h14-0-471" id="h14-0-471" class="i">+                        val mainIntent = Intent.makeRestartActivityTask(it.component).apply {
</a><a href="#h14-0-472" id="h14-0-472" class="i">+                            putExtra(ReceiversConfig.MESSAGING_PREVIEW_EXTRA, true)
</a><a href="#h14-0-473" id="h14-0-473" class="i">+                        }
</a><a href="#h14-0-474" id="h14-0-474" class="i">+                        context.androidContext.startActivity(mainIntent)
</a><a href="#h14-0-475" id="h14-0-475" class="i">+                    }
</a><a href="#h14-0-476" id="h14-0-476" class="i">+                    messagingBridge.registerSessionStartListener(object: SessionStartListener.Stub() {
</a><a href="#h14-0-477" id="h14-0-477" class="i">+                        override fun onConnected() {
</a><a href="#h14-0-478" id="h14-0-478" class="i">+                            fetchNewMessages()
</a><a href="#h14-0-479" id="h14-0-479" class="i">+                        }
</a><a href="#h14-0-480" id="h14-0-480" class="i">+                    })
</a><a href="#h14-0-481" id="h14-0-481" class="i">+                    return
</a><a href="#h14-0-482" id="h14-0-482" class="i">+                }
</a><a href="#h14-0-483" id="h14-0-483" class="i">+                fetchNewMessages()
</a><a href="#h14-0-484" id="h14-0-484" class="i">+            }.onFailure {
</a><a href="#h14-0-485" id="h14-0-485" class="i">+                context.longToast(&quot;Failed to initialize messaging bridge&quot;)
</a><a href="#h14-0-486" id="h14-0-486" class="i">+                context.log.error(&quot;Failed to initialize messaging bridge&quot;, it)
</a><a href="#h14-0-487" id="h14-0-487" class="i">+            }
</a><a href="#h14-0-488" id="h14-0-488" class="i">+        }
</a><a href="#h14-0-489" id="h14-0-489" class="i">+
</a><a href="#h14-0-490" id="h14-0-490" class="i">+        LaunchedEffect(Unit) {
</a><a href="#h14-0-491" id="h14-0-491" class="i">+            messages.clear()
</a><a href="#h14-0-492" id="h14-0-492" class="i">+            messageSize = 0
</a><a href="#h14-0-493" id="h14-0-493" class="i">+            conversationId = null
</a><a href="#h14-0-494" id="h14-0-494" class="i">+
</a><a href="#h14-0-495" id="h14-0-495" class="i">+            isBridgeConnected = context.hasMessagingBridge()
</a><a href="#h14-0-496" id="h14-0-496" class="i">+            if (isBridgeConnected) {
</a><a href="#h14-0-497" id="h14-0-497" class="i">+                onMessagingBridgeReady(scope, id)
</a><a href="#h14-0-498" id="h14-0-498" class="i">+            } else {
</a><a href="#h14-0-499" id="h14-0-499" class="i">+                SnapWidgetBroadcastReceiverHelper.create(&quot;wakeup&quot;) {}.also {
</a><a href="#h14-0-500" id="h14-0-500" class="i">+                    context.androidContext.sendBroadcast(it)
</a><a href="#h14-0-501" id="h14-0-501" class="i">+                }
</a><a href="#h14-0-502" id="h14-0-502" class="i">+                coroutineScope.launch(Dispatchers.IO) {
</a><a href="#h14-0-503" id="h14-0-503" class="i">+                    withTimeout(10000) {
</a><a href="#h14-0-504" id="h14-0-504" class="i">+                        while (!context.hasMessagingBridge()) {
</a><a href="#h14-0-505" id="h14-0-505" class="i">+                            delay(100)
</a><a href="#h14-0-506" id="h14-0-506" class="i">+                        }
</a><a href="#h14-0-507" id="h14-0-507" class="i">+                        isBridgeConnected = true
</a><a href="#h14-0-508" id="h14-0-508" class="i">+                        onMessagingBridgeReady(scope, id)
</a><a href="#h14-0-509" id="h14-0-509" class="i">+                    }
</a><a href="#h14-0-510" id="h14-0-510" class="i">+                }.invokeOnCompletion {
</a><a href="#h14-0-511" id="h14-0-511" class="i">+                    if (it != null) {
</a><a href="#h14-0-512" id="h14-0-512" class="i">+                        hasBridgeError = true
</a><a href="#h14-0-513" id="h14-0-513" class="i">+                    }
</a><a href="#h14-0-514" id="h14-0-514" class="i">+                }
</a><a href="#h14-0-515" id="h14-0-515" class="i">+            }
</a><a href="#h14-0-516" id="h14-0-516" class="i">+        }
</a><a href="#h14-0-517" id="h14-0-517" class="i">+
</a><a href="#h14-0-518" id="h14-0-518" class="i">+        Column(
</a><a href="#h14-0-519" id="h14-0-519" class="i">+            modifier = Modifier
</a><a href="#h14-0-520" id="h14-0-520" class="i">+                .fillMaxSize()
</a><a href="#h14-0-521" id="h14-0-521" class="i">+        ) {
</a><a href="#h14-0-522" id="h14-0-522" class="i">+            if (hasBridgeError) {
</a><a href="#h14-0-523" id="h14-0-523" class="i">+                Text(&quot;Failed to connect to Snapchat through bridge service&quot;)
</a><a href="#h14-0-524" id="h14-0-524" class="i">+            }
</a><a href="#h14-0-525" id="h14-0-525" class="i">+
</a><a href="#h14-0-526" id="h14-0-526" class="i">+            if (!isBridgeConnected &amp;&amp; !hasBridgeError) {
</a><a href="#h14-0-527" id="h14-0-527" class="i">+                LoadingRow()
</a><a href="#h14-0-528" id="h14-0-528" class="i">+            }
</a><a href="#h14-0-529" id="h14-0-529" class="i">+
</a><a href="#h14-0-530" id="h14-0-530" class="i">+            if (isBridgeConnected &amp;&amp; !hasBridgeError) {
</a><a href="#h14-0-531" id="h14-0-531" class="i">+                ConversationPreview(messages, messageSize, ::fetchNewMessages)
</a><a href="#h14-0-532" id="h14-0-532" class="i">+            }
</a><a href="#h14-0-533" id="h14-0-533" class="i">+        }
</a><a href="#h14-0-534" id="h14-0-534" class="i">+    }
</a><a href="#h14-0-535" id="h14-0-535" class="i">+}</a><a href="#h14-0-536" id="h14-0-536" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h15" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/social/SocialRoot.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/social/SocialRoot.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/social/SocialRoot.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/social/SocialRoot.kt</a></b>
<a href="#h15-0" id="h15-0" class="h">@@ -0,0 +1,269 @@
</a><a href="#h15-0-0" id="h15-0-0" class="i">+package me.rhunk.snapenhance.ui.manager.pages.social
</a><a href="#h15-0-1" id="h15-0-1" class="i">+
</a><a href="#h15-0-2" id="h15-0-2" class="i">+import androidx.compose.foundation.ExperimentalFoundationApi
</a><a href="#h15-0-3" id="h15-0-3" class="i">+import androidx.compose.foundation.clickable
</a><a href="#h15-0-4" id="h15-0-4" class="i">+import androidx.compose.foundation.layout.*
</a><a href="#h15-0-5" id="h15-0-5" class="i">+import androidx.compose.foundation.lazy.LazyColumn
</a><a href="#h15-0-6" id="h15-0-6" class="i">+import androidx.compose.foundation.pager.HorizontalPager
</a><a href="#h15-0-7" id="h15-0-7" class="i">+import androidx.compose.foundation.pager.rememberPagerState
</a><a href="#h15-0-8" id="h15-0-8" class="i">+import androidx.compose.foundation.shape.RoundedCornerShape
</a><a href="#h15-0-9" id="h15-0-9" class="i">+import androidx.compose.material.icons.Icons
</a><a href="#h15-0-10" id="h15-0-10" class="i">+import androidx.compose.material.icons.filled.RemoveRedEye
</a><a href="#h15-0-11" id="h15-0-11" class="i">+import androidx.compose.material.icons.rounded.Add
</a><a href="#h15-0-12" id="h15-0-12" class="i">+import androidx.compose.material3.*
</a><a href="#h15-0-13" id="h15-0-13" class="i">+import androidx.compose.runtime.*
</a><a href="#h15-0-14" id="h15-0-14" class="i">+import androidx.compose.ui.Alignment
</a><a href="#h15-0-15" id="h15-0-15" class="i">+import androidx.compose.ui.Modifier
</a><a href="#h15-0-16" id="h15-0-16" class="i">+import androidx.compose.ui.graphics.vector.ImageVector
</a><a href="#h15-0-17" id="h15-0-17" class="i">+import androidx.compose.ui.res.vectorResource
</a><a href="#h15-0-18" id="h15-0-18" class="i">+import androidx.compose.ui.text.font.FontWeight
</a><a href="#h15-0-19" id="h15-0-19" class="i">+import androidx.compose.ui.text.style.TextAlign
</a><a href="#h15-0-20" id="h15-0-20" class="i">+import androidx.compose.ui.text.style.TextOverflow
</a><a href="#h15-0-21" id="h15-0-21" class="i">+import androidx.compose.ui.unit.dp
</a><a href="#h15-0-22" id="h15-0-22" class="i">+import androidx.compose.ui.unit.sp
</a><a href="#h15-0-23" id="h15-0-23" class="i">+import androidx.navigation.NavBackStackEntry
</a><a href="#h15-0-24" id="h15-0-24" class="i">+import kotlinx.coroutines.Dispatchers
</a><a href="#h15-0-25" id="h15-0-25" class="i">+import kotlinx.coroutines.launch
</a><a href="#h15-0-26" id="h15-0-26" class="i">+import kotlinx.coroutines.withContext
</a><a href="#h15-0-27" id="h15-0-27" class="i">+import me.rhunk.snapenhance.R
</a><a href="#h15-0-28" id="h15-0-28" class="i">+import me.rhunk.snapenhance.common.data.MessagingFriendInfo
</a><a href="#h15-0-29" id="h15-0-29" class="i">+import me.rhunk.snapenhance.common.data.MessagingGroupInfo
</a><a href="#h15-0-30" id="h15-0-30" class="i">+import me.rhunk.snapenhance.common.data.SocialScope
</a><a href="#h15-0-31" id="h15-0-31" class="i">+import me.rhunk.snapenhance.common.util.snap.BitmojiSelfie
</a><a href="#h15-0-32" id="h15-0-32" class="i">+import me.rhunk.snapenhance.ui.manager.Routes
</a><a href="#h15-0-33" id="h15-0-33" class="i">+import me.rhunk.snapenhance.ui.util.BitmojiImage
</a><a href="#h15-0-34" id="h15-0-34" class="i">+import me.rhunk.snapenhance.ui.util.pagerTabIndicatorOffset
</a><a href="#h15-0-35" id="h15-0-35" class="i">+
</a><a href="#h15-0-36" id="h15-0-36" class="i">+class SocialRoot : Routes.Route() {
</a><a href="#h15-0-37" id="h15-0-37" class="i">+    private var friendList: List&lt;MessagingFriendInfo&gt; by mutableStateOf(emptyList())
</a><a href="#h15-0-38" id="h15-0-38" class="i">+    private var groupList: List&lt;MessagingGroupInfo&gt; by mutableStateOf(emptyList())
</a><a href="#h15-0-39" id="h15-0-39" class="i">+
</a><a href="#h15-0-40" id="h15-0-40" class="i">+    fun updateScopeLists() {
</a><a href="#h15-0-41" id="h15-0-41" class="i">+        context.coroutineScope.launch(Dispatchers.IO) {
</a><a href="#h15-0-42" id="h15-0-42" class="i">+            friendList = context.modDatabase.getFriends(descOrder = true)
</a><a href="#h15-0-43" id="h15-0-43" class="i">+            groupList = context.modDatabase.getGroups()
</a><a href="#h15-0-44" id="h15-0-44" class="i">+        }
</a><a href="#h15-0-45" id="h15-0-45" class="i">+    }
</a><a href="#h15-0-46" id="h15-0-46" class="i">+
</a><a href="#h15-0-47" id="h15-0-47" class="i">+    private val addFriendDialog by lazy {
</a><a href="#h15-0-48" id="h15-0-48" class="i">+        AddFriendDialog(context, this)
</a><a href="#h15-0-49" id="h15-0-49" class="i">+    }
</a><a href="#h15-0-50" id="h15-0-50" class="i">+
</a><a href="#h15-0-51" id="h15-0-51" class="i">+    @Composable
</a><a href="#h15-0-52" id="h15-0-52" class="i">+    private fun ScopeList(scope: SocialScope) {
</a><a href="#h15-0-53" id="h15-0-53" class="i">+        val remainingHours = remember { context.config.root.streaksReminder.remainingHours.get() }
</a><a href="#h15-0-54" id="h15-0-54" class="i">+
</a><a href="#h15-0-55" id="h15-0-55" class="i">+        LazyColumn(
</a><a href="#h15-0-56" id="h15-0-56" class="i">+            modifier = Modifier
</a><a href="#h15-0-57" id="h15-0-57" class="i">+                .padding(2.dp)
</a><a href="#h15-0-58" id="h15-0-58" class="i">+                .fillMaxWidth()
</a><a href="#h15-0-59" id="h15-0-59" class="i">+                .fillMaxHeight(),
</a><a href="#h15-0-60" id="h15-0-60" class="i">+            contentPadding = PaddingValues(bottom = 110.dp),
</a><a href="#h15-0-61" id="h15-0-61" class="i">+        ) {
</a><a href="#h15-0-62" id="h15-0-62" class="i">+            //check if scope list is empty
</a><a href="#h15-0-63" id="h15-0-63" class="i">+            val listSize = when (scope) {
</a><a href="#h15-0-64" id="h15-0-64" class="i">+                SocialScope.GROUP -&gt; groupList.size
</a><a href="#h15-0-65" id="h15-0-65" class="i">+                SocialScope.FRIEND -&gt; friendList.size
</a><a href="#h15-0-66" id="h15-0-66" class="i">+            }
</a><a href="#h15-0-67" id="h15-0-67" class="i">+
</a><a href="#h15-0-68" id="h15-0-68" class="i">+            if (listSize == 0) {
</a><a href="#h15-0-69" id="h15-0-69" class="i">+                item {
</a><a href="#h15-0-70" id="h15-0-70" class="i">+                    Text(
</a><a href="#h15-0-71" id="h15-0-71" class="i">+                        text = &quot;(empty)&quot;, modifier = Modifier
</a><a href="#h15-0-72" id="h15-0-72" class="i">+                            .fillMaxWidth()
</a><a href="#h15-0-73" id="h15-0-73" class="i">+                            .padding(10.dp), textAlign = TextAlign.Center
</a><a href="#h15-0-74" id="h15-0-74" class="i">+                    )
</a><a href="#h15-0-75" id="h15-0-75" class="i">+                }
</a><a href="#h15-0-76" id="h15-0-76" class="i">+            }
</a><a href="#h15-0-77" id="h15-0-77" class="i">+
</a><a href="#h15-0-78" id="h15-0-78" class="i">+            items(listSize) { index -&gt;
</a><a href="#h15-0-79" id="h15-0-79" class="i">+                val id = when (scope) {
</a><a href="#h15-0-80" id="h15-0-80" class="i">+                    SocialScope.GROUP -&gt; groupList[index].conversationId
</a><a href="#h15-0-81" id="h15-0-81" class="i">+                    SocialScope.FRIEND -&gt; friendList[index].userId
</a><a href="#h15-0-82" id="h15-0-82" class="i">+                }
</a><a href="#h15-0-83" id="h15-0-83" class="i">+
</a><a href="#h15-0-84" id="h15-0-84" class="i">+                Card(
</a><a href="#h15-0-85" id="h15-0-85" class="i">+                    modifier = Modifier
</a><a href="#h15-0-86" id="h15-0-86" class="i">+                        .padding(10.dp)
</a><a href="#h15-0-87" id="h15-0-87" class="i">+                        .fillMaxWidth()
</a><a href="#h15-0-88" id="h15-0-88" class="i">+                        .height(80.dp)
</a><a href="#h15-0-89" id="h15-0-89" class="i">+                        .clickable {
</a><a href="#h15-0-90" id="h15-0-90" class="i">+                            routes.manageScope.navigate {
</a><a href="#h15-0-91" id="h15-0-91" class="i">+                                put(&quot;id&quot;, id)
</a><a href="#h15-0-92" id="h15-0-92" class="i">+                                put(&quot;scope&quot;, scope.key)
</a><a href="#h15-0-93" id="h15-0-93" class="i">+                            }
</a><a href="#h15-0-94" id="h15-0-94" class="i">+                        },
</a><a href="#h15-0-95" id="h15-0-95" class="i">+                ) {
</a><a href="#h15-0-96" id="h15-0-96" class="i">+                    Row(
</a><a href="#h15-0-97" id="h15-0-97" class="i">+                        modifier = Modifier
</a><a href="#h15-0-98" id="h15-0-98" class="i">+                            .padding(10.dp)
</a><a href="#h15-0-99" id="h15-0-99" class="i">+                            .fillMaxSize(),
</a><a href="#h15-0-100" id="h15-0-100" class="i">+                        verticalAlignment = Alignment.CenterVertically
</a><a href="#h15-0-101" id="h15-0-101" class="i">+                    ) {
</a><a href="#h15-0-102" id="h15-0-102" class="i">+                        when (scope) {
</a><a href="#h15-0-103" id="h15-0-103" class="i">+                            SocialScope.GROUP -&gt; {
</a><a href="#h15-0-104" id="h15-0-104" class="i">+                                val group = groupList[index]
</a><a href="#h15-0-105" id="h15-0-105" class="i">+                                Column(
</a><a href="#h15-0-106" id="h15-0-106" class="i">+                                    modifier = Modifier
</a><a href="#h15-0-107" id="h15-0-107" class="i">+                                        .padding(10.dp)
</a><a href="#h15-0-108" id="h15-0-108" class="i">+                                        .fillMaxWidth()
</a><a href="#h15-0-109" id="h15-0-109" class="i">+                                        .weight(1f)
</a><a href="#h15-0-110" id="h15-0-110" class="i">+                                ) {
</a><a href="#h15-0-111" id="h15-0-111" class="i">+                                    Text(
</a><a href="#h15-0-112" id="h15-0-112" class="i">+                                        text = group.name,
</a><a href="#h15-0-113" id="h15-0-113" class="i">+                                        maxLines = 1,
</a><a href="#h15-0-114" id="h15-0-114" class="i">+                                        fontWeight = FontWeight.Bold
</a><a href="#h15-0-115" id="h15-0-115" class="i">+                                    )
</a><a href="#h15-0-116" id="h15-0-116" class="i">+                                }
</a><a href="#h15-0-117" id="h15-0-117" class="i">+                            }
</a><a href="#h15-0-118" id="h15-0-118" class="i">+
</a><a href="#h15-0-119" id="h15-0-119" class="i">+                            SocialScope.FRIEND -&gt; {
</a><a href="#h15-0-120" id="h15-0-120" class="i">+                                val friend = friendList[index]
</a><a href="#h15-0-121" id="h15-0-121" class="i">+                                var streaks by remember { mutableStateOf(friend.streaks) }
</a><a href="#h15-0-122" id="h15-0-122" class="i">+
</a><a href="#h15-0-123" id="h15-0-123" class="i">+                                LaunchedEffect(friend.userId) {
</a><a href="#h15-0-124" id="h15-0-124" class="i">+                                    withContext(Dispatchers.IO) {
</a><a href="#h15-0-125" id="h15-0-125" class="i">+                                        streaks = context.modDatabase.getFriendStreaks(friend.userId)
</a><a href="#h15-0-126" id="h15-0-126" class="i">+                                    }
</a><a href="#h15-0-127" id="h15-0-127" class="i">+                                }
</a><a href="#h15-0-128" id="h15-0-128" class="i">+
</a><a href="#h15-0-129" id="h15-0-129" class="i">+                                BitmojiImage(
</a><a href="#h15-0-130" id="h15-0-130" class="i">+                                    context = context,
</a><a href="#h15-0-131" id="h15-0-131" class="i">+                                    url = BitmojiSelfie.getBitmojiSelfie(
</a><a href="#h15-0-132" id="h15-0-132" class="i">+                                        friend.selfieId,
</a><a href="#h15-0-133" id="h15-0-133" class="i">+                                        friend.bitmojiId,
</a><a href="#h15-0-134" id="h15-0-134" class="i">+                                        BitmojiSelfie.BitmojiSelfieType.THREE_D
</a><a href="#h15-0-135" id="h15-0-135" class="i">+                                    )
</a><a href="#h15-0-136" id="h15-0-136" class="i">+                                )
</a><a href="#h15-0-137" id="h15-0-137" class="i">+                                Column(
</a><a href="#h15-0-138" id="h15-0-138" class="i">+                                    modifier = Modifier
</a><a href="#h15-0-139" id="h15-0-139" class="i">+                                        .padding(10.dp)
</a><a href="#h15-0-140" id="h15-0-140" class="i">+                                        .fillMaxWidth()
</a><a href="#h15-0-141" id="h15-0-141" class="i">+                                        .weight(1f)
</a><a href="#h15-0-142" id="h15-0-142" class="i">+                                ) {
</a><a href="#h15-0-143" id="h15-0-143" class="i">+                                    Text(
</a><a href="#h15-0-144" id="h15-0-144" class="i">+                                        text = friend.displayName ?: friend.mutableUsername,
</a><a href="#h15-0-145" id="h15-0-145" class="i">+                                        maxLines = 1,
</a><a href="#h15-0-146" id="h15-0-146" class="i">+                                        fontWeight = FontWeight.Bold
</a><a href="#h15-0-147" id="h15-0-147" class="i">+                                    )
</a><a href="#h15-0-148" id="h15-0-148" class="i">+                                    Text(
</a><a href="#h15-0-149" id="h15-0-149" class="i">+                                        text = friend.mutableUsername,
</a><a href="#h15-0-150" id="h15-0-150" class="i">+                                        maxLines = 1,
</a><a href="#h15-0-151" id="h15-0-151" class="i">+                                        fontSize = 12.sp,
</a><a href="#h15-0-152" id="h15-0-152" class="i">+                                        fontWeight = FontWeight.Light
</a><a href="#h15-0-153" id="h15-0-153" class="i">+                                    )
</a><a href="#h15-0-154" id="h15-0-154" class="i">+                                }
</a><a href="#h15-0-155" id="h15-0-155" class="i">+                                Row(verticalAlignment = Alignment.CenterVertically) {
</a><a href="#h15-0-156" id="h15-0-156" class="i">+                                    streaks?.takeIf { it.notify }?.let { streaks -&gt;
</a><a href="#h15-0-157" id="h15-0-157" class="i">+                                        Icon(
</a><a href="#h15-0-158" id="h15-0-158" class="i">+                                            imageVector = ImageVector.vectorResource(id = R.drawable.streak_icon),
</a><a href="#h15-0-159" id="h15-0-159" class="i">+                                            contentDescription = null,
</a><a href="#h15-0-160" id="h15-0-160" class="i">+                                            modifier = Modifier.height(40.dp),
</a><a href="#h15-0-161" id="h15-0-161" class="i">+                                            tint = if (streaks.isAboutToExpire(remainingHours))
</a><a href="#h15-0-162" id="h15-0-162" class="i">+                                                MaterialTheme.colorScheme.error
</a><a href="#h15-0-163" id="h15-0-163" class="i">+                                            else MaterialTheme.colorScheme.primary
</a><a href="#h15-0-164" id="h15-0-164" class="i">+                                        )
</a><a href="#h15-0-165" id="h15-0-165" class="i">+                                        Text(
</a><a href="#h15-0-166" id="h15-0-166" class="i">+                                            text = context.translation.format(
</a><a href="#h15-0-167" id="h15-0-167" class="i">+                                                &quot;manager.sections.social.streaks_expiration_short&quot;,
</a><a href="#h15-0-168" id="h15-0-168" class="i">+                                                &quot;hours&quot; to (((streaks.expirationTimestamp - System.currentTimeMillis()) / 3600000).toInt().takeIf { it &gt; 0 } ?: 0)
</a><a href="#h15-0-169" id="h15-0-169" class="i">+                                                    .toString()
</a><a href="#h15-0-170" id="h15-0-170" class="i">+                                            ),
</a><a href="#h15-0-171" id="h15-0-171" class="i">+                                            maxLines = 1,
</a><a href="#h15-0-172" id="h15-0-172" class="i">+                                            fontWeight = FontWeight.Bold
</a><a href="#h15-0-173" id="h15-0-173" class="i">+                                        )
</a><a href="#h15-0-174" id="h15-0-174" class="i">+                                    }
</a><a href="#h15-0-175" id="h15-0-175" class="i">+                                }
</a><a href="#h15-0-176" id="h15-0-176" class="i">+                            }
</a><a href="#h15-0-177" id="h15-0-177" class="i">+                        }
</a><a href="#h15-0-178" id="h15-0-178" class="i">+
</a><a href="#h15-0-179" id="h15-0-179" class="i">+                        FilledIconButton(onClick = {
</a><a href="#h15-0-180" id="h15-0-180" class="i">+                            routes.messagingPreview.navigate {
</a><a href="#h15-0-181" id="h15-0-181" class="i">+                                put(&quot;id&quot;, id)
</a><a href="#h15-0-182" id="h15-0-182" class="i">+                                put(&quot;scope&quot;, scope.key)
</a><a href="#h15-0-183" id="h15-0-183" class="i">+                            }
</a><a href="#h15-0-184" id="h15-0-184" class="i">+                        }) {
</a><a href="#h15-0-185" id="h15-0-185" class="i">+                            Icon(imageVector = Icons.Filled.RemoveRedEye, contentDescription = null)
</a><a href="#h15-0-186" id="h15-0-186" class="i">+                        }
</a><a href="#h15-0-187" id="h15-0-187" class="i">+                    }
</a><a href="#h15-0-188" id="h15-0-188" class="i">+                }
</a><a href="#h15-0-189" id="h15-0-189" class="i">+            }
</a><a href="#h15-0-190" id="h15-0-190" class="i">+        }
</a><a href="#h15-0-191" id="h15-0-191" class="i">+    }
</a><a href="#h15-0-192" id="h15-0-192" class="i">+
</a><a href="#h15-0-193" id="h15-0-193" class="i">+    @OptIn(ExperimentalFoundationApi::class)
</a><a href="#h15-0-194" id="h15-0-194" class="i">+    override val content: @Composable (NavBackStackEntry) -&gt; Unit = {
</a><a href="#h15-0-195" id="h15-0-195" class="i">+        val titles = listOf(&quot;Friends&quot;, &quot;Groups&quot;)
</a><a href="#h15-0-196" id="h15-0-196" class="i">+        val coroutineScope = rememberCoroutineScope()
</a><a href="#h15-0-197" id="h15-0-197" class="i">+        val pagerState = rememberPagerState { titles.size }
</a><a href="#h15-0-198" id="h15-0-198" class="i">+        var showAddFriendDialog by remember { mutableStateOf(false) }
</a><a href="#h15-0-199" id="h15-0-199" class="i">+
</a><a href="#h15-0-200" id="h15-0-200" class="i">+        if (showAddFriendDialog) {
</a><a href="#h15-0-201" id="h15-0-201" class="i">+            addFriendDialog.Content {
</a><a href="#h15-0-202" id="h15-0-202" class="i">+                showAddFriendDialog = false
</a><a href="#h15-0-203" id="h15-0-203" class="i">+            }
</a><a href="#h15-0-204" id="h15-0-204" class="i">+        }
</a><a href="#h15-0-205" id="h15-0-205" class="i">+
</a><a href="#h15-0-206" id="h15-0-206" class="i">+        LaunchedEffect(Unit) {
</a><a href="#h15-0-207" id="h15-0-207" class="i">+            updateScopeLists()
</a><a href="#h15-0-208" id="h15-0-208" class="i">+        }
</a><a href="#h15-0-209" id="h15-0-209" class="i">+
</a><a href="#h15-0-210" id="h15-0-210" class="i">+        Scaffold(
</a><a href="#h15-0-211" id="h15-0-211" class="i">+            floatingActionButton = {
</a><a href="#h15-0-212" id="h15-0-212" class="i">+                FloatingActionButton(
</a><a href="#h15-0-213" id="h15-0-213" class="i">+                    onClick = {
</a><a href="#h15-0-214" id="h15-0-214" class="i">+                        showAddFriendDialog = true
</a><a href="#h15-0-215" id="h15-0-215" class="i">+                    },
</a><a href="#h15-0-216" id="h15-0-216" class="i">+                    modifier = Modifier.padding(10.dp),
</a><a href="#h15-0-217" id="h15-0-217" class="i">+                    containerColor = MaterialTheme.colorScheme.primary,
</a><a href="#h15-0-218" id="h15-0-218" class="i">+                    contentColor = MaterialTheme.colorScheme.onPrimary,
</a><a href="#h15-0-219" id="h15-0-219" class="i">+                    shape = RoundedCornerShape(16.dp),
</a><a href="#h15-0-220" id="h15-0-220" class="i">+                ) {
</a><a href="#h15-0-221" id="h15-0-221" class="i">+                    Icon(
</a><a href="#h15-0-222" id="h15-0-222" class="i">+                        imageVector = Icons.Rounded.Add,
</a><a href="#h15-0-223" id="h15-0-223" class="i">+                        contentDescription = null
</a><a href="#h15-0-224" id="h15-0-224" class="i">+                    )
</a><a href="#h15-0-225" id="h15-0-225" class="i">+                }
</a><a href="#h15-0-226" id="h15-0-226" class="i">+            }
</a><a href="#h15-0-227" id="h15-0-227" class="i">+        ) { paddingValues -&gt;
</a><a href="#h15-0-228" id="h15-0-228" class="i">+            Column(modifier = Modifier.padding(paddingValues)) {
</a><a href="#h15-0-229" id="h15-0-229" class="i">+                TabRow(selectedTabIndex = pagerState.currentPage, indicator = { tabPositions -&gt;
</a><a href="#h15-0-230" id="h15-0-230" class="i">+                    TabRowDefaults.Indicator(
</a><a href="#h15-0-231" id="h15-0-231" class="i">+                        Modifier.pagerTabIndicatorOffset(
</a><a href="#h15-0-232" id="h15-0-232" class="i">+                            pagerState = pagerState,
</a><a href="#h15-0-233" id="h15-0-233" class="i">+                            tabPositions = tabPositions
</a><a href="#h15-0-234" id="h15-0-234" class="i">+                        )
</a><a href="#h15-0-235" id="h15-0-235" class="i">+                    )
</a><a href="#h15-0-236" id="h15-0-236" class="i">+                }) {
</a><a href="#h15-0-237" id="h15-0-237" class="i">+                    titles.forEachIndexed { index, title -&gt;
</a><a href="#h15-0-238" id="h15-0-238" class="i">+                        Tab(
</a><a href="#h15-0-239" id="h15-0-239" class="i">+                            selected = pagerState.currentPage == index,
</a><a href="#h15-0-240" id="h15-0-240" class="i">+                            onClick = {
</a><a href="#h15-0-241" id="h15-0-241" class="i">+                                coroutineScope.launch {
</a><a href="#h15-0-242" id="h15-0-242" class="i">+                                    pagerState.animateScrollToPage(index)
</a><a href="#h15-0-243" id="h15-0-243" class="i">+                                }
</a><a href="#h15-0-244" id="h15-0-244" class="i">+                            },
</a><a href="#h15-0-245" id="h15-0-245" class="i">+                            text = {
</a><a href="#h15-0-246" id="h15-0-246" class="i">+                                Text(
</a><a href="#h15-0-247" id="h15-0-247" class="i">+                                    text = title,
</a><a href="#h15-0-248" id="h15-0-248" class="i">+                                    maxLines = 2,
</a><a href="#h15-0-249" id="h15-0-249" class="i">+                                    overflow = TextOverflow.Ellipsis
</a><a href="#h15-0-250" id="h15-0-250" class="i">+                                )
</a><a href="#h15-0-251" id="h15-0-251" class="i">+                            }
</a><a href="#h15-0-252" id="h15-0-252" class="i">+                        )
</a><a href="#h15-0-253" id="h15-0-253" class="i">+                    }
</a><a href="#h15-0-254" id="h15-0-254" class="i">+                }
</a><a href="#h15-0-255" id="h15-0-255" class="i">+
</a><a href="#h15-0-256" id="h15-0-256" class="i">+                HorizontalPager(
</a><a href="#h15-0-257" id="h15-0-257" class="i">+                    modifier = Modifier.padding(paddingValues),
</a><a href="#h15-0-258" id="h15-0-258" class="i">+                    state = pagerState
</a><a href="#h15-0-259" id="h15-0-259" class="i">+                ) { page -&gt;
</a><a href="#h15-0-260" id="h15-0-260" class="i">+                    when (page) {
</a><a href="#h15-0-261" id="h15-0-261" class="i">+                        0 -&gt; ScopeList(SocialScope.FRIEND)
</a><a href="#h15-0-262" id="h15-0-262" class="i">+                        1 -&gt; ScopeList(SocialScope.GROUP)
</a><a href="#h15-0-263" id="h15-0-263" class="i">+                    }
</a><a href="#h15-0-264" id="h15-0-264" class="i">+                }
</a><a href="#h15-0-265" id="h15-0-265" class="i">+            }
</a><a href="#h15-0-266" id="h15-0-266" class="i">+        }
</a><a href="#h15-0-267" id="h15-0-267" class="i">+    }
</a><a href="#h15-0-268" id="h15-0-268" class="i">+}</a><a href="#h15-0-269" id="h15-0-269" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h16" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/DebugSection.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/DebugSection.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/DebugSection.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/DebugSection.kt</a></b>
<a href="#h16-0" id="h16-0" class="h">@@ -1,4 +0,0 @@
</a><a href="#h16-0-0" id="h16-0-0" class="d">-package me.rhunk.snapenhance.ui.manager.sections
</a><a href="#h16-0-1" id="h16-0-1" class="d">-
</a><a href="#h16-0-2" id="h16-0-2" class="d">-class DebugSection {
</a><a href="#h16-0-3" id="h16-0-3" class="d">-}</a><a href="#h16-0-4" id="h16-0-4" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h17" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/NotImplemented.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/NotImplemented.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/NotImplemented.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/NotImplemented.kt</a></b>
<a href="#h17-0" id="h17-0" class="h">@@ -1,23 +0,0 @@
</a><a href="#h17-0-0" id="h17-0-0" class="d">-package me.rhunk.snapenhance.ui.manager.sections
</a><a href="#h17-0-1" id="h17-0-1" class="d">-
</a><a href="#h17-0-2" id="h17-0-2" class="d">-import androidx.compose.foundation.layout.Arrangement
</a><a href="#h17-0-3" id="h17-0-3" class="d">-import androidx.compose.foundation.layout.Column
</a><a href="#h17-0-4" id="h17-0-4" class="d">-import androidx.compose.foundation.layout.fillMaxSize
</a><a href="#h17-0-5" id="h17-0-5" class="d">-import androidx.compose.material3.Text
</a><a href="#h17-0-6" id="h17-0-6" class="d">-import androidx.compose.runtime.Composable
</a><a href="#h17-0-7" id="h17-0-7" class="d">-import androidx.compose.ui.Alignment
</a><a href="#h17-0-8" id="h17-0-8" class="d">-import androidx.compose.ui.Modifier
</a><a href="#h17-0-9" id="h17-0-9" class="d">-import me.rhunk.snapenhance.ui.manager.Section
</a><a href="#h17-0-10" id="h17-0-10" class="d">-
</a><a href="#h17-0-11" id="h17-0-11" class="d">-class NotImplemented : Section() {
</a><a href="#h17-0-12" id="h17-0-12" class="d">-    @Composable
</a><a href="#h17-0-13" id="h17-0-13" class="d">-    override fun Content() {
</a><a href="#h17-0-14" id="h17-0-14" class="d">-        Column(
</a><a href="#h17-0-15" id="h17-0-15" class="d">-            modifier = Modifier.fillMaxSize(),
</a><a href="#h17-0-16" id="h17-0-16" class="d">-            verticalArrangement = Arrangement.Center,
</a><a href="#h17-0-17" id="h17-0-17" class="d">-            horizontalAlignment = Alignment.CenterHorizontally,
</a><a href="#h17-0-18" id="h17-0-18" class="d">-        ) {
</a><a href="#h17-0-19" id="h17-0-19" class="d">-            Text(text = &quot;Not implemented yet!&quot;)
</a><a href="#h17-0-20" id="h17-0-20" class="d">-        }
</a><a href="#h17-0-21" id="h17-0-21" class="d">-    }
</a><a href="#h17-0-22" id="h17-0-22" class="d">-}</a><a href="#h17-0-23" id="h17-0-23" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h18" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/TasksSection.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/TasksSection.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/TasksSection.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/TasksSection.kt</a></b>
<a href="#h18-0" id="h18-0" class="h">@@ -1,456 +0,0 @@
</a><a href="#h18-0-0" id="h18-0-0" class="d">-package me.rhunk.snapenhance.ui.manager.sections
</a><a href="#h18-0-1" id="h18-0-1" class="d">-
</a><a href="#h18-0-2" id="h18-0-2" class="d">- import android.content.Intent
</a><a href="#h18-0-3" id="h18-0-3" class="d">-import androidx.compose.foundation.border
</a><a href="#h18-0-4" id="h18-0-4" class="d">-import androidx.compose.foundation.clickable
</a><a href="#h18-0-5" id="h18-0-5" class="d">-import androidx.compose.foundation.layout.*
</a><a href="#h18-0-6" id="h18-0-6" class="d">-import androidx.compose.foundation.lazy.LazyColumn
</a><a href="#h18-0-7" id="h18-0-7" class="d">-import androidx.compose.foundation.lazy.items
</a><a href="#h18-0-8" id="h18-0-8" class="d">-import androidx.compose.foundation.lazy.rememberLazyListState
</a><a href="#h18-0-9" id="h18-0-9" class="d">-import androidx.compose.material.icons.Icons
</a><a href="#h18-0-10" id="h18-0-10" class="d">-import androidx.compose.material.icons.filled.*
</a><a href="#h18-0-11" id="h18-0-11" class="d">-import androidx.compose.material3.*
</a><a href="#h18-0-12" id="h18-0-12" class="d">-import androidx.compose.runtime.*
</a><a href="#h18-0-13" id="h18-0-13" class="d">-import androidx.compose.ui.Alignment
</a><a href="#h18-0-14" id="h18-0-14" class="d">-import androidx.compose.ui.Modifier
</a><a href="#h18-0-15" id="h18-0-15" class="d">-import androidx.compose.ui.draw.clip
</a><a href="#h18-0-16" id="h18-0-16" class="d">-import androidx.compose.ui.graphics.StrokeCap
</a><a href="#h18-0-17" id="h18-0-17" class="d">-import androidx.compose.ui.tooling.preview.Preview
</a><a href="#h18-0-18" id="h18-0-18" class="d">-import androidx.compose.ui.unit.dp
</a><a href="#h18-0-19" id="h18-0-19" class="d">-import androidx.core.net.toUri
</a><a href="#h18-0-20" id="h18-0-20" class="d">-import androidx.documentfile.provider.DocumentFile
</a><a href="#h18-0-21" id="h18-0-21" class="d">-import androidx.lifecycle.Lifecycle
</a><a href="#h18-0-22" id="h18-0-22" class="d">-import kotlinx.coroutines.CoroutineScope
</a><a href="#h18-0-23" id="h18-0-23" class="d">-import kotlinx.coroutines.Dispatchers
</a><a href="#h18-0-24" id="h18-0-24" class="d">-import kotlinx.coroutines.launch
</a><a href="#h18-0-25" id="h18-0-25" class="d">-import me.rhunk.snapenhance.bridge.DownloadCallback
</a><a href="#h18-0-26" id="h18-0-26" class="d">-import me.rhunk.snapenhance.common.data.download.DownloadMetadata
</a><a href="#h18-0-27" id="h18-0-27" class="d">-import me.rhunk.snapenhance.common.data.download.MediaDownloadSource
</a><a href="#h18-0-28" id="h18-0-28" class="d">-import me.rhunk.snapenhance.common.data.download.createNewFilePath
</a><a href="#h18-0-29" id="h18-0-29" class="d">-import me.rhunk.snapenhance.common.util.ktx.longHashCode
</a><a href="#h18-0-30" id="h18-0-30" class="d">-import me.rhunk.snapenhance.download.DownloadProcessor
</a><a href="#h18-0-31" id="h18-0-31" class="d">-import me.rhunk.snapenhance.download.FFMpegProcessor
</a><a href="#h18-0-32" id="h18-0-32" class="d">-import me.rhunk.snapenhance.task.PendingTask
</a><a href="#h18-0-33" id="h18-0-33" class="d">-import me.rhunk.snapenhance.task.PendingTaskListener
</a><a href="#h18-0-34" id="h18-0-34" class="d">-import me.rhunk.snapenhance.task.Task
</a><a href="#h18-0-35" id="h18-0-35" class="d">-import me.rhunk.snapenhance.task.TaskStatus
</a><a href="#h18-0-36" id="h18-0-36" class="d">-import me.rhunk.snapenhance.task.TaskType
</a><a href="#h18-0-37" id="h18-0-37" class="d">-import me.rhunk.snapenhance.ui.manager.Section
</a><a href="#h18-0-38" id="h18-0-38" class="d">-import me.rhunk.snapenhance.ui.util.OnLifecycleEvent
</a><a href="#h18-0-39" id="h18-0-39" class="d">-import java.io.File
</a><a href="#h18-0-40" id="h18-0-40" class="d">-import java.util.UUID
</a><a href="#h18-0-41" id="h18-0-41" class="d">-import kotlin.math.absoluteValue
</a><a href="#h18-0-42" id="h18-0-42" class="d">-
</a><a href="#h18-0-43" id="h18-0-43" class="d">-class TasksSection : Section() {
</a><a href="#h18-0-44" id="h18-0-44" class="d">-    private var activeTasks by mutableStateOf(listOf&lt;PendingTask&gt;())
</a><a href="#h18-0-45" id="h18-0-45" class="d">-    private lateinit var recentTasks: MutableList&lt;Task&gt;
</a><a href="#h18-0-46" id="h18-0-46" class="d">-    private val taskSelection = mutableStateListOf&lt;Pair&lt;Task, DocumentFile?&gt;&gt;()
</a><a href="#h18-0-47" id="h18-0-47" class="d">-
</a><a href="#h18-0-48" id="h18-0-48" class="d">-    private fun fetchActiveTasks(scope: CoroutineScope = context.coroutineScope) {
</a><a href="#h18-0-49" id="h18-0-49" class="d">-        scope.launch(Dispatchers.IO) {
</a><a href="#h18-0-50" id="h18-0-50" class="d">-            activeTasks = context.taskManager.getActiveTasks().values.sortedByDescending { it.taskId }.toMutableList()
</a><a href="#h18-0-51" id="h18-0-51" class="d">-        }
</a><a href="#h18-0-52" id="h18-0-52" class="d">-    }
</a><a href="#h18-0-53" id="h18-0-53" class="d">-
</a><a href="#h18-0-54" id="h18-0-54" class="d">-    private fun mergeSelection(selection: List&lt;Pair&lt;Task, DocumentFile&gt;&gt;) {
</a><a href="#h18-0-55" id="h18-0-55" class="d">-        val firstTask = selection.first().first
</a><a href="#h18-0-56" id="h18-0-56" class="d">-
</a><a href="#h18-0-57" id="h18-0-57" class="d">-        val taskHash = UUID.randomUUID().toString().longHashCode().absoluteValue.toString(16)
</a><a href="#h18-0-58" id="h18-0-58" class="d">-        val pendingTask = context.taskManager.createPendingTask(
</a><a href="#h18-0-59" id="h18-0-59" class="d">-            Task(TaskType.DOWNLOAD, &quot;Merge ${selection.size} files&quot;, firstTask.author, taskHash)
</a><a href="#h18-0-60" id="h18-0-60" class="d">-        )
</a><a href="#h18-0-61" id="h18-0-61" class="d">-        pendingTask.status = TaskStatus.RUNNING
</a><a href="#h18-0-62" id="h18-0-62" class="d">-        fetchActiveTasks()
</a><a href="#h18-0-63" id="h18-0-63" class="d">-
</a><a href="#h18-0-64" id="h18-0-64" class="d">-        context.coroutineScope.launch {
</a><a href="#h18-0-65" id="h18-0-65" class="d">-            val filesToMerge = mutableListOf&lt;File&gt;()
</a><a href="#h18-0-66" id="h18-0-66" class="d">-
</a><a href="#h18-0-67" id="h18-0-67" class="d">-            selection.forEach { (task, documentFile) -&gt;
</a><a href="#h18-0-68" id="h18-0-68" class="d">-                val tempFile = File.createTempFile(task.hash, &quot;.&quot; + documentFile.name?.substringAfterLast(&quot;.&quot;), context.androidContext.cacheDir).also {
</a><a href="#h18-0-69" id="h18-0-69" class="d">-                    it.deleteOnExit()
</a><a href="#h18-0-70" id="h18-0-70" class="d">-                }
</a><a href="#h18-0-71" id="h18-0-71" class="d">-
</a><a href="#h18-0-72" id="h18-0-72" class="d">-                runCatching {
</a><a href="#h18-0-73" id="h18-0-73" class="d">-                    pendingTask.updateProgress(&quot;Copying ${documentFile.name}&quot;)
</a><a href="#h18-0-74" id="h18-0-74" class="d">-                    context.androidContext.contentResolver.openInputStream(documentFile.uri)?.use { inputStream -&gt;
</a><a href="#h18-0-75" id="h18-0-75" class="d">-                        //copy with progress
</a><a href="#h18-0-76" id="h18-0-76" class="d">-                        val length = documentFile.length().toFloat()
</a><a href="#h18-0-77" id="h18-0-77" class="d">-                        tempFile.outputStream().use { outputStream -&gt;
</a><a href="#h18-0-78" id="h18-0-78" class="d">-                            val buffer = ByteArray(16 * 1024)
</a><a href="#h18-0-79" id="h18-0-79" class="d">-                            var read: Int
</a><a href="#h18-0-80" id="h18-0-80" class="d">-                            while (inputStream.read(buffer).also { read = it } != -1) {
</a><a href="#h18-0-81" id="h18-0-81" class="d">-                                outputStream.write(buffer, 0, read)
</a><a href="#h18-0-82" id="h18-0-82" class="d">-                                pendingTask.updateProgress(&quot;Copying ${documentFile.name}&quot;, (outputStream.channel.position().toFloat() / length * 100f).toInt())
</a><a href="#h18-0-83" id="h18-0-83" class="d">-                            }
</a><a href="#h18-0-84" id="h18-0-84" class="d">-                            outputStream.flush()
</a><a href="#h18-0-85" id="h18-0-85" class="d">-                            filesToMerge.add(tempFile)
</a><a href="#h18-0-86" id="h18-0-86" class="d">-                        }
</a><a href="#h18-0-87" id="h18-0-87" class="d">-                    }
</a><a href="#h18-0-88" id="h18-0-88" class="d">-                }.onFailure {
</a><a href="#h18-0-89" id="h18-0-89" class="d">-                    pendingTask.fail(&quot;Failed to copy file $documentFile to $tempFile&quot;)
</a><a href="#h18-0-90" id="h18-0-90" class="d">-                    filesToMerge.forEach { it.delete() }
</a><a href="#h18-0-91" id="h18-0-91" class="d">-                    return@launch
</a><a href="#h18-0-92" id="h18-0-92" class="d">-                }
</a><a href="#h18-0-93" id="h18-0-93" class="d">-            }
</a><a href="#h18-0-94" id="h18-0-94" class="d">-
</a><a href="#h18-0-95" id="h18-0-95" class="d">-            val mergedFile = File.createTempFile(&quot;merged&quot;, &quot;.mp4&quot;, context.androidContext.cacheDir).also {
</a><a href="#h18-0-96" id="h18-0-96" class="d">-                it.deleteOnExit()
</a><a href="#h18-0-97" id="h18-0-97" class="d">-            }
</a><a href="#h18-0-98" id="h18-0-98" class="d">-
</a><a href="#h18-0-99" id="h18-0-99" class="d">-            runCatching {
</a><a href="#h18-0-100" id="h18-0-100" class="d">-                context.shortToast(&quot;Merging ${filesToMerge.size} files&quot;)
</a><a href="#h18-0-101" id="h18-0-101" class="d">-                FFMpegProcessor.newFFMpegProcessor(context, pendingTask).execute(
</a><a href="#h18-0-102" id="h18-0-102" class="d">-                    FFMpegProcessor.Request(FFMpegProcessor.Action.MERGE_MEDIA, filesToMerge, mergedFile)
</a><a href="#h18-0-103" id="h18-0-103" class="d">-                )
</a><a href="#h18-0-104" id="h18-0-104" class="d">-                DownloadProcessor(context, object: DownloadCallback.Default() {
</a><a href="#h18-0-105" id="h18-0-105" class="d">-                    override fun onSuccess(outputPath: String) {
</a><a href="#h18-0-106" id="h18-0-106" class="d">-                        context.log.verbose(&quot;Merged files to $outputPath&quot;)
</a><a href="#h18-0-107" id="h18-0-107" class="d">-                    }
</a><a href="#h18-0-108" id="h18-0-108" class="d">-                }).saveMediaToGallery(pendingTask, mergedFile, DownloadMetadata(
</a><a href="#h18-0-109" id="h18-0-109" class="d">-                    mediaIdentifier = taskHash,
</a><a href="#h18-0-110" id="h18-0-110" class="d">-                    outputPath = createNewFilePath(
</a><a href="#h18-0-111" id="h18-0-111" class="d">-                        context.config.root,
</a><a href="#h18-0-112" id="h18-0-112" class="d">-                        taskHash,
</a><a href="#h18-0-113" id="h18-0-113" class="d">-                        downloadSource = MediaDownloadSource.MERGED,
</a><a href="#h18-0-114" id="h18-0-114" class="d">-                        mediaAuthor = firstTask.author,
</a><a href="#h18-0-115" id="h18-0-115" class="d">-                        creationTimestamp = System.currentTimeMillis()
</a><a href="#h18-0-116" id="h18-0-116" class="d">-                    ),
</a><a href="#h18-0-117" id="h18-0-117" class="d">-                    mediaAuthor = firstTask.author,
</a><a href="#h18-0-118" id="h18-0-118" class="d">-                    downloadSource = MediaDownloadSource.MERGED.translate(context.translation),
</a><a href="#h18-0-119" id="h18-0-119" class="d">-                    iconUrl = null
</a><a href="#h18-0-120" id="h18-0-120" class="d">-                ))
</a><a href="#h18-0-121" id="h18-0-121" class="d">-            }.onFailure {
</a><a href="#h18-0-122" id="h18-0-122" class="d">-                context.log.error(&quot;Failed to merge files&quot;, it)
</a><a href="#h18-0-123" id="h18-0-123" class="d">-                pendingTask.fail(it.message ?: &quot;Failed to merge files&quot;)
</a><a href="#h18-0-124" id="h18-0-124" class="d">-            }.onSuccess {
</a><a href="#h18-0-125" id="h18-0-125" class="d">-                pendingTask.success()
</a><a href="#h18-0-126" id="h18-0-126" class="d">-            }
</a><a href="#h18-0-127" id="h18-0-127" class="d">-            filesToMerge.forEach { it.delete() }
</a><a href="#h18-0-128" id="h18-0-128" class="d">-            mergedFile.delete()
</a><a href="#h18-0-129" id="h18-0-129" class="d">-        }.also {
</a><a href="#h18-0-130" id="h18-0-130" class="d">-            pendingTask.addListener(PendingTaskListener(onCancel = { it.cancel() }))
</a><a href="#h18-0-131" id="h18-0-131" class="d">-        }
</a><a href="#h18-0-132" id="h18-0-132" class="d">-    }
</a><a href="#h18-0-133" id="h18-0-133" class="d">-
</a><a href="#h18-0-134" id="h18-0-134" class="d">-
</a><a href="#h18-0-135" id="h18-0-135" class="d">-    @Composable
</a><a href="#h18-0-136" id="h18-0-136" class="d">-    override fun TopBarActions(rowScope: RowScope) {
</a><a href="#h18-0-137" id="h18-0-137" class="d">-        var showConfirmDialog by remember { mutableStateOf(false) }
</a><a href="#h18-0-138" id="h18-0-138" class="d">-
</a><a href="#h18-0-139" id="h18-0-139" class="d">-        if (taskSelection.size == 1 &amp;&amp; taskSelection.firstOrNull()?.second?.exists() == true) {
</a><a href="#h18-0-140" id="h18-0-140" class="d">-            taskSelection.firstOrNull()?.second?.takeIf { it.exists() }?.let { documentFile -&gt;
</a><a href="#h18-0-141" id="h18-0-141" class="d">-                IconButton(onClick = {
</a><a href="#h18-0-142" id="h18-0-142" class="d">-                    runCatching {
</a><a href="#h18-0-143" id="h18-0-143" class="d">-                        context.androidContext.startActivity(Intent(Intent.ACTION_VIEW).apply {
</a><a href="#h18-0-144" id="h18-0-144" class="d">-                            setDataAndType(documentFile.uri, documentFile.type)
</a><a href="#h18-0-145" id="h18-0-145" class="d">-                            flags = Intent.FLAG_GRANT_READ_URI_PERMISSION or Intent.FLAG_ACTIVITY_NEW_TASK
</a><a href="#h18-0-146" id="h18-0-146" class="d">-                        })
</a><a href="#h18-0-147" id="h18-0-147" class="d">-                        taskSelection.clear()
</a><a href="#h18-0-148" id="h18-0-148" class="d">-                    }.onFailure {
</a><a href="#h18-0-149" id="h18-0-149" class="d">-                        context.log.error(&quot;Failed to open file ${taskSelection.first().second}&quot;, it)
</a><a href="#h18-0-150" id="h18-0-150" class="d">-                    }
</a><a href="#h18-0-151" id="h18-0-151" class="d">-                }) {
</a><a href="#h18-0-152" id="h18-0-152" class="d">-                    Icon(Icons.Filled.OpenInNew, contentDescription = &quot;Open&quot;)
</a><a href="#h18-0-153" id="h18-0-153" class="d">-                }
</a><a href="#h18-0-154" id="h18-0-154" class="d">-            }
</a><a href="#h18-0-155" id="h18-0-155" class="d">-        }
</a><a href="#h18-0-156" id="h18-0-156" class="d">-
</a><a href="#h18-0-157" id="h18-0-157" class="d">-        if (taskSelection.size &gt; 1 &amp;&amp; taskSelection.all { it.second?.type?.contains(&quot;video&quot;) == true }) {
</a><a href="#h18-0-158" id="h18-0-158" class="d">-            IconButton(onClick = {
</a><a href="#h18-0-159" id="h18-0-159" class="d">-                mergeSelection(taskSelection.toList().also {
</a><a href="#h18-0-160" id="h18-0-160" class="d">-                    taskSelection.clear()
</a><a href="#h18-0-161" id="h18-0-161" class="d">-                }.map { it.first to it.second!! })
</a><a href="#h18-0-162" id="h18-0-162" class="d">-            }) {
</a><a href="#h18-0-163" id="h18-0-163" class="d">-                Icon(Icons.Filled.Merge, contentDescription = &quot;Merge&quot;)
</a><a href="#h18-0-164" id="h18-0-164" class="d">-            }
</a><a href="#h18-0-165" id="h18-0-165" class="d">-        }
</a><a href="#h18-0-166" id="h18-0-166" class="d">-
</a><a href="#h18-0-167" id="h18-0-167" class="d">-        IconButton(onClick = {
</a><a href="#h18-0-168" id="h18-0-168" class="d">-            showConfirmDialog = true
</a><a href="#h18-0-169" id="h18-0-169" class="d">-        }) {
</a><a href="#h18-0-170" id="h18-0-170" class="d">-            Icon(Icons.Filled.Delete, contentDescription = &quot;Clear tasks&quot;)
</a><a href="#h18-0-171" id="h18-0-171" class="d">-        }
</a><a href="#h18-0-172" id="h18-0-172" class="d">-
</a><a href="#h18-0-173" id="h18-0-173" class="d">-        if (showConfirmDialog) {
</a><a href="#h18-0-174" id="h18-0-174" class="d">-            var alsoDeleteFiles by remember { mutableStateOf(false) }
</a><a href="#h18-0-175" id="h18-0-175" class="d">-
</a><a href="#h18-0-176" id="h18-0-176" class="d">-            AlertDialog(
</a><a href="#h18-0-177" id="h18-0-177" class="d">-                onDismissRequest = { showConfirmDialog = false },
</a><a href="#h18-0-178" id="h18-0-178" class="d">-                title = {
</a><a href="#h18-0-179" id="h18-0-179" class="d">-                    if (taskSelection.isNotEmpty()) {
</a><a href="#h18-0-180" id="h18-0-180" class="d">-                        Text(&quot;Remove ${taskSelection.size} tasks?&quot;)
</a><a href="#h18-0-181" id="h18-0-181" class="d">-                    } else {
</a><a href="#h18-0-182" id="h18-0-182" class="d">-                        Text(&quot;Remove all tasks?&quot;)
</a><a href="#h18-0-183" id="h18-0-183" class="d">-                    }
</a><a href="#h18-0-184" id="h18-0-184" class="d">-                },
</a><a href="#h18-0-185" id="h18-0-185" class="d">-                text = {
</a><a href="#h18-0-186" id="h18-0-186" class="d">-                    Column {
</a><a href="#h18-0-187" id="h18-0-187" class="d">-                        if (taskSelection.isNotEmpty()) {
</a><a href="#h18-0-188" id="h18-0-188" class="d">-                            Text(&quot;Are you sure you want to remove selected tasks?&quot;)
</a><a href="#h18-0-189" id="h18-0-189" class="d">-                            Row (
</a><a href="#h18-0-190" id="h18-0-190" class="d">-                                modifier = Modifier.padding(top = 10.dp).fillMaxWidth().clickable {
</a><a href="#h18-0-191" id="h18-0-191" class="d">-                                    alsoDeleteFiles = !alsoDeleteFiles
</a><a href="#h18-0-192" id="h18-0-192" class="d">-                                },
</a><a href="#h18-0-193" id="h18-0-193" class="d">-                                horizontalArrangement = Arrangement.spacedBy(5.dp),
</a><a href="#h18-0-194" id="h18-0-194" class="d">-                                verticalAlignment = Alignment.CenterVertically
</a><a href="#h18-0-195" id="h18-0-195" class="d">-                            ) {
</a><a href="#h18-0-196" id="h18-0-196" class="d">-                                Checkbox(checked = alsoDeleteFiles, onCheckedChange = {
</a><a href="#h18-0-197" id="h18-0-197" class="d">-                                    alsoDeleteFiles = it
</a><a href="#h18-0-198" id="h18-0-198" class="d">-                                })
</a><a href="#h18-0-199" id="h18-0-199" class="d">-                                Text(&quot;Also delete files&quot;)
</a><a href="#h18-0-200" id="h18-0-200" class="d">-                            }
</a><a href="#h18-0-201" id="h18-0-201" class="d">-                        } else {
</a><a href="#h18-0-202" id="h18-0-202" class="d">-                            Text(&quot;Are you sure you want to remove all tasks?&quot;)
</a><a href="#h18-0-203" id="h18-0-203" class="d">-                        }
</a><a href="#h18-0-204" id="h18-0-204" class="d">-                    }
</a><a href="#h18-0-205" id="h18-0-205" class="d">-                },
</a><a href="#h18-0-206" id="h18-0-206" class="d">-                confirmButton = {
</a><a href="#h18-0-207" id="h18-0-207" class="d">-                    Button(
</a><a href="#h18-0-208" id="h18-0-208" class="d">-                        onClick = {
</a><a href="#h18-0-209" id="h18-0-209" class="d">-                            showConfirmDialog = false
</a><a href="#h18-0-210" id="h18-0-210" class="d">-
</a><a href="#h18-0-211" id="h18-0-211" class="d">-                            if (taskSelection.isNotEmpty()) {
</a><a href="#h18-0-212" id="h18-0-212" class="d">-                                taskSelection.forEach { (task, documentFile) -&gt;
</a><a href="#h18-0-213" id="h18-0-213" class="d">-                                    context.taskManager.removeTask(task)
</a><a href="#h18-0-214" id="h18-0-214" class="d">-                                    recentTasks.remove(task)
</a><a href="#h18-0-215" id="h18-0-215" class="d">-                                    if (alsoDeleteFiles) {
</a><a href="#h18-0-216" id="h18-0-216" class="d">-                                        documentFile?.delete()
</a><a href="#h18-0-217" id="h18-0-217" class="d">-                                    }
</a><a href="#h18-0-218" id="h18-0-218" class="d">-                                }
</a><a href="#h18-0-219" id="h18-0-219" class="d">-                                activeTasks = activeTasks.filter { task -&gt; !taskSelection.map { it.first }.contains(task.task) }
</a><a href="#h18-0-220" id="h18-0-220" class="d">-                                taskSelection.clear()
</a><a href="#h18-0-221" id="h18-0-221" class="d">-                            } else {
</a><a href="#h18-0-222" id="h18-0-222" class="d">-                                context.taskManager.clearAllTasks()
</a><a href="#h18-0-223" id="h18-0-223" class="d">-                                recentTasks.clear()
</a><a href="#h18-0-224" id="h18-0-224" class="d">-                                activeTasks.forEach {
</a><a href="#h18-0-225" id="h18-0-225" class="d">-                                    runCatching {
</a><a href="#h18-0-226" id="h18-0-226" class="d">-                                        it.cancel()
</a><a href="#h18-0-227" id="h18-0-227" class="d">-                                    }.onFailure { throwable -&gt;
</a><a href="#h18-0-228" id="h18-0-228" class="d">-                                        context.log.error(&quot;Failed to cancel task $it&quot;, throwable)
</a><a href="#h18-0-229" id="h18-0-229" class="d">-                                    }
</a><a href="#h18-0-230" id="h18-0-230" class="d">-                                }
</a><a href="#h18-0-231" id="h18-0-231" class="d">-                                activeTasks = listOf()
</a><a href="#h18-0-232" id="h18-0-232" class="d">-                                context.taskManager.getActiveTasks().clear()
</a><a href="#h18-0-233" id="h18-0-233" class="d">-                            }
</a><a href="#h18-0-234" id="h18-0-234" class="d">-                        }
</a><a href="#h18-0-235" id="h18-0-235" class="d">-                    ) {
</a><a href="#h18-0-236" id="h18-0-236" class="d">-                        Text(&quot;Yes&quot;)
</a><a href="#h18-0-237" id="h18-0-237" class="d">-                    }
</a><a href="#h18-0-238" id="h18-0-238" class="d">-                },
</a><a href="#h18-0-239" id="h18-0-239" class="d">-                dismissButton = {
</a><a href="#h18-0-240" id="h18-0-240" class="d">-                    Button(
</a><a href="#h18-0-241" id="h18-0-241" class="d">-                        onClick = {
</a><a href="#h18-0-242" id="h18-0-242" class="d">-                            showConfirmDialog = false
</a><a href="#h18-0-243" id="h18-0-243" class="d">-                        }
</a><a href="#h18-0-244" id="h18-0-244" class="d">-                    ) {
</a><a href="#h18-0-245" id="h18-0-245" class="d">-                        Text(&quot;No&quot;)
</a><a href="#h18-0-246" id="h18-0-246" class="d">-                    }
</a><a href="#h18-0-247" id="h18-0-247" class="d">-                }
</a><a href="#h18-0-248" id="h18-0-248" class="d">-            )
</a><a href="#h18-0-249" id="h18-0-249" class="d">-        }
</a><a href="#h18-0-250" id="h18-0-250" class="d">-    }
</a><a href="#h18-0-251" id="h18-0-251" class="d">-
</a><a href="#h18-0-252" id="h18-0-252" class="d">-    @Composable
</a><a href="#h18-0-253" id="h18-0-253" class="d">-    private fun TaskCard(modifier: Modifier, task: Task, pendingTask: PendingTask? = null) {
</a><a href="#h18-0-254" id="h18-0-254" class="d">-        var taskStatus by remember { mutableStateOf(task.status) }
</a><a href="#h18-0-255" id="h18-0-255" class="d">-        var taskProgressLabel by remember { mutableStateOf&lt;String?&gt;(null) }
</a><a href="#h18-0-256" id="h18-0-256" class="d">-        var taskProgress by remember { mutableIntStateOf(-1) }
</a><a href="#h18-0-257" id="h18-0-257" class="d">-        val isSelected by remember { derivedStateOf { taskSelection.any { it.first == task } } }
</a><a href="#h18-0-258" id="h18-0-258" class="d">-        var documentFile by remember { mutableStateOf&lt;DocumentFile?&gt;(null) }
</a><a href="#h18-0-259" id="h18-0-259" class="d">-        var isDocumentFileReadable by remember { mutableStateOf(true) }
</a><a href="#h18-0-260" id="h18-0-260" class="d">-
</a><a href="#h18-0-261" id="h18-0-261" class="d">-        LaunchedEffect(taskStatus.key) {
</a><a href="#h18-0-262" id="h18-0-262" class="d">-            launch(Dispatchers.IO) {
</a><a href="#h18-0-263" id="h18-0-263" class="d">-                documentFile = DocumentFile.fromSingleUri(context.androidContext, task.extra?.toUri() ?: return@launch)
</a><a href="#h18-0-264" id="h18-0-264" class="d">-                isDocumentFileReadable = documentFile?.canRead() ?: false
</a><a href="#h18-0-265" id="h18-0-265" class="d">-            }
</a><a href="#h18-0-266" id="h18-0-266" class="d">-        }
</a><a href="#h18-0-267" id="h18-0-267" class="d">-
</a><a href="#h18-0-268" id="h18-0-268" class="d">-        val listener = remember { PendingTaskListener(
</a><a href="#h18-0-269" id="h18-0-269" class="d">-            onStateChange = {
</a><a href="#h18-0-270" id="h18-0-270" class="d">-                taskStatus = it
</a><a href="#h18-0-271" id="h18-0-271" class="d">-            },
</a><a href="#h18-0-272" id="h18-0-272" class="d">-            onProgress = { label, progress -&gt;
</a><a href="#h18-0-273" id="h18-0-273" class="d">-                taskProgressLabel = label
</a><a href="#h18-0-274" id="h18-0-274" class="d">-                taskProgress = progress
</a><a href="#h18-0-275" id="h18-0-275" class="d">-            }
</a><a href="#h18-0-276" id="h18-0-276" class="d">-        ) }
</a><a href="#h18-0-277" id="h18-0-277" class="d">-
</a><a href="#h18-0-278" id="h18-0-278" class="d">-        LaunchedEffect(Unit) {
</a><a href="#h18-0-279" id="h18-0-279" class="d">-            pendingTask?.addListener(listener)
</a><a href="#h18-0-280" id="h18-0-280" class="d">-        }
</a><a href="#h18-0-281" id="h18-0-281" class="d">-
</a><a href="#h18-0-282" id="h18-0-282" class="d">-        DisposableEffect(Unit) {
</a><a href="#h18-0-283" id="h18-0-283" class="d">-            onDispose {
</a><a href="#h18-0-284" id="h18-0-284" class="d">-                pendingTask?.removeListener(listener)
</a><a href="#h18-0-285" id="h18-0-285" class="d">-            }
</a><a href="#h18-0-286" id="h18-0-286" class="d">-        }
</a><a href="#h18-0-287" id="h18-0-287" class="d">-
</a><a href="#h18-0-288" id="h18-0-288" class="d">-        OutlinedCard(modifier = modifier.clickable {
</a><a href="#h18-0-289" id="h18-0-289" class="d">-            if (isSelected) {
</a><a href="#h18-0-290" id="h18-0-290" class="d">-                taskSelection.removeIf { it.first == task }
</a><a href="#h18-0-291" id="h18-0-291" class="d">-                return@clickable
</a><a href="#h18-0-292" id="h18-0-292" class="d">-            }
</a><a href="#h18-0-293" id="h18-0-293" class="d">-            taskSelection.add(task to documentFile)
</a><a href="#h18-0-294" id="h18-0-294" class="d">-        }.let {
</a><a href="#h18-0-295" id="h18-0-295" class="d">-            if (isSelected) {
</a><a href="#h18-0-296" id="h18-0-296" class="d">-                it
</a><a href="#h18-0-297" id="h18-0-297" class="d">-                    .border(2.dp, MaterialTheme.colorScheme.primary)
</a><a href="#h18-0-298" id="h18-0-298" class="d">-                    .clip(MaterialTheme.shapes.medium)
</a><a href="#h18-0-299" id="h18-0-299" class="d">-            } else it
</a><a href="#h18-0-300" id="h18-0-300" class="d">-        }) {
</a><a href="#h18-0-301" id="h18-0-301" class="d">-            Row(
</a><a href="#h18-0-302" id="h18-0-302" class="d">-                modifier = Modifier.padding(15.dp),
</a><a href="#h18-0-303" id="h18-0-303" class="d">-                verticalAlignment = Alignment.CenterVertically
</a><a href="#h18-0-304" id="h18-0-304" class="d">-            ) {
</a><a href="#h18-0-305" id="h18-0-305" class="d">-                Column(
</a><a href="#h18-0-306" id="h18-0-306" class="d">-                    modifier = Modifier.padding(end = 15.dp)
</a><a href="#h18-0-307" id="h18-0-307" class="d">-                ) {
</a><a href="#h18-0-308" id="h18-0-308" class="d">-                    documentFile?.let { file -&gt;
</a><a href="#h18-0-309" id="h18-0-309" class="d">-                        val mimeType = file.type ?: &quot;&quot;
</a><a href="#h18-0-310" id="h18-0-310" class="d">-                        when {
</a><a href="#h18-0-311" id="h18-0-311" class="d">-                            !isDocumentFileReadable -&gt; Icon(Icons.Filled.DeleteOutline, contentDescription = &quot;File not found&quot;)
</a><a href="#h18-0-312" id="h18-0-312" class="d">-                            mimeType.contains(&quot;image&quot;) -&gt; Icon(Icons.Filled.Image, contentDescription = &quot;Image&quot;)
</a><a href="#h18-0-313" id="h18-0-313" class="d">-                            mimeType.contains(&quot;video&quot;) -&gt; Icon(Icons.Filled.Videocam, contentDescription = &quot;Video&quot;)
</a><a href="#h18-0-314" id="h18-0-314" class="d">-                            mimeType.contains(&quot;audio&quot;) -&gt; Icon(Icons.Filled.MusicNote, contentDescription = &quot;Audio&quot;)
</a><a href="#h18-0-315" id="h18-0-315" class="d">-                            else -&gt; Icon(Icons.Filled.FileCopy, contentDescription = &quot;File&quot;)
</a><a href="#h18-0-316" id="h18-0-316" class="d">-                        }
</a><a href="#h18-0-317" id="h18-0-317" class="d">-                    } ?: run {
</a><a href="#h18-0-318" id="h18-0-318" class="d">-                        when (task.type) {
</a><a href="#h18-0-319" id="h18-0-319" class="d">-                            TaskType.DOWNLOAD -&gt; Icon(Icons.Filled.Download, contentDescription = &quot;Download&quot;)
</a><a href="#h18-0-320" id="h18-0-320" class="d">-                            TaskType.CHAT_ACTION -&gt; Icon(Icons.Filled.ChatBubble, contentDescription = &quot;Chat Action&quot;)
</a><a href="#h18-0-321" id="h18-0-321" class="d">-                        }
</a><a href="#h18-0-322" id="h18-0-322" class="d">-                    }
</a><a href="#h18-0-323" id="h18-0-323" class="d">-                }
</a><a href="#h18-0-324" id="h18-0-324" class="d">-                Column(
</a><a href="#h18-0-325" id="h18-0-325" class="d">-                    modifier = Modifier.weight(1f),
</a><a href="#h18-0-326" id="h18-0-326" class="d">-                ) {
</a><a href="#h18-0-327" id="h18-0-327" class="d">-                    Row(
</a><a href="#h18-0-328" id="h18-0-328" class="d">-                        modifier = Modifier.fillMaxWidth(),
</a><a href="#h18-0-329" id="h18-0-329" class="d">-                        verticalAlignment = Alignment.CenterVertically
</a><a href="#h18-0-330" id="h18-0-330" class="d">-                    ) {
</a><a href="#h18-0-331" id="h18-0-331" class="d">-                        Text(task.title, style = MaterialTheme.typography.bodyMedium)
</a><a href="#h18-0-332" id="h18-0-332" class="d">-                        task.author?.takeIf { it != &quot;null&quot; }?.let {
</a><a href="#h18-0-333" id="h18-0-333" class="d">-                            Spacer(modifier = Modifier.width(5.dp))
</a><a href="#h18-0-334" id="h18-0-334" class="d">-                            Text(it, style = MaterialTheme.typography.bodySmall, color = MaterialTheme.colorScheme.onSurfaceVariant)
</a><a href="#h18-0-335" id="h18-0-335" class="d">-                        }
</a><a href="#h18-0-336" id="h18-0-336" class="d">-                    }
</a><a href="#h18-0-337" id="h18-0-337" class="d">-                    Text(task.hash, style = MaterialTheme.typography.labelSmall)
</a><a href="#h18-0-338" id="h18-0-338" class="d">-                    Column(
</a><a href="#h18-0-339" id="h18-0-339" class="d">-                        modifier = Modifier.padding(top = 5.dp),
</a><a href="#h18-0-340" id="h18-0-340" class="d">-                        verticalArrangement = Arrangement.spacedBy(5.dp)
</a><a href="#h18-0-341" id="h18-0-341" class="d">-                    ) {
</a><a href="#h18-0-342" id="h18-0-342" class="d">-                        if (taskStatus.isFinalStage()) {
</a><a href="#h18-0-343" id="h18-0-343" class="d">-                            if (taskStatus != TaskStatus.SUCCESS) {
</a><a href="#h18-0-344" id="h18-0-344" class="d">-                                Text(&quot;$taskStatus&quot;, style = MaterialTheme.typography.bodySmall)
</a><a href="#h18-0-345" id="h18-0-345" class="d">-                            }
</a><a href="#h18-0-346" id="h18-0-346" class="d">-                        } else {
</a><a href="#h18-0-347" id="h18-0-347" class="d">-                            taskProgressLabel?.let {
</a><a href="#h18-0-348" id="h18-0-348" class="d">-                                Text(it, style = MaterialTheme.typography.bodySmall)
</a><a href="#h18-0-349" id="h18-0-349" class="d">-                            }
</a><a href="#h18-0-350" id="h18-0-350" class="d">-                            if (taskProgress != -1) {
</a><a href="#h18-0-351" id="h18-0-351" class="d">-                                LinearProgressIndicator(
</a><a href="#h18-0-352" id="h18-0-352" class="d">-                                    progress = taskProgress.toFloat() / 100f,
</a><a href="#h18-0-353" id="h18-0-353" class="d">-                                    strokeCap = StrokeCap.Round
</a><a href="#h18-0-354" id="h18-0-354" class="d">-                                )
</a><a href="#h18-0-355" id="h18-0-355" class="d">-                            } else {
</a><a href="#h18-0-356" id="h18-0-356" class="d">-                                task.extra?.let {
</a><a href="#h18-0-357" id="h18-0-357" class="d">-                                    Text(it, style = MaterialTheme.typography.bodySmall)
</a><a href="#h18-0-358" id="h18-0-358" class="d">-                                }
</a><a href="#h18-0-359" id="h18-0-359" class="d">-                            }
</a><a href="#h18-0-360" id="h18-0-360" class="d">-                        }
</a><a href="#h18-0-361" id="h18-0-361" class="d">-                    }
</a><a href="#h18-0-362" id="h18-0-362" class="d">-                }
</a><a href="#h18-0-363" id="h18-0-363" class="d">-
</a><a href="#h18-0-364" id="h18-0-364" class="d">-                Column {
</a><a href="#h18-0-365" id="h18-0-365" class="d">-                    if (pendingTask != null &amp;&amp; !taskStatus.isFinalStage()) {
</a><a href="#h18-0-366" id="h18-0-366" class="d">-                        FilledIconButton(onClick = {
</a><a href="#h18-0-367" id="h18-0-367" class="d">-                            runCatching {
</a><a href="#h18-0-368" id="h18-0-368" class="d">-                                pendingTask.cancel()
</a><a href="#h18-0-369" id="h18-0-369" class="d">-                            }.onFailure { throwable -&gt;
</a><a href="#h18-0-370" id="h18-0-370" class="d">-                                context.log.error(&quot;Failed to cancel task $pendingTask&quot;, throwable)
</a><a href="#h18-0-371" id="h18-0-371" class="d">-                            }
</a><a href="#h18-0-372" id="h18-0-372" class="d">-                        }) {
</a><a href="#h18-0-373" id="h18-0-373" class="d">-                            Icon(Icons.Filled.Close, contentDescription = &quot;Cancel&quot;)
</a><a href="#h18-0-374" id="h18-0-374" class="d">-                        }
</a><a href="#h18-0-375" id="h18-0-375" class="d">-                    } else {
</a><a href="#h18-0-376" id="h18-0-376" class="d">-                        when (taskStatus) {
</a><a href="#h18-0-377" id="h18-0-377" class="d">-                            TaskStatus.SUCCESS -&gt; Icon(Icons.Filled.Check, contentDescription = &quot;Success&quot;, tint = MaterialTheme.colorScheme.primary)
</a><a href="#h18-0-378" id="h18-0-378" class="d">-                            TaskStatus.FAILURE -&gt; Icon(Icons.Filled.Error, contentDescription = &quot;Failure&quot;, tint = MaterialTheme.colorScheme.error)
</a><a href="#h18-0-379" id="h18-0-379" class="d">-                            TaskStatus.CANCELLED -&gt; Icon(Icons.Filled.Cancel, contentDescription = &quot;Cancelled&quot;, tint = MaterialTheme.colorScheme.error)
</a><a href="#h18-0-380" id="h18-0-380" class="d">-                            else -&gt; {}
</a><a href="#h18-0-381" id="h18-0-381" class="d">-                        }
</a><a href="#h18-0-382" id="h18-0-382" class="d">-                    }
</a><a href="#h18-0-383" id="h18-0-383" class="d">-                }
</a><a href="#h18-0-384" id="h18-0-384" class="d">-            }
</a><a href="#h18-0-385" id="h18-0-385" class="d">-        }
</a><a href="#h18-0-386" id="h18-0-386" class="d">-    }
</a><a href="#h18-0-387" id="h18-0-387" class="d">-
</a><a href="#h18-0-388" id="h18-0-388" class="d">-    @Preview
</a><a href="#h18-0-389" id="h18-0-389" class="d">-    @Composable
</a><a href="#h18-0-390" id="h18-0-390" class="d">-    override fun Content() {
</a><a href="#h18-0-391" id="h18-0-391" class="d">-        val scrollState = rememberLazyListState()
</a><a href="#h18-0-392" id="h18-0-392" class="d">-        val scope = rememberCoroutineScope()
</a><a href="#h18-0-393" id="h18-0-393" class="d">-        recentTasks = remember { mutableStateListOf() }
</a><a href="#h18-0-394" id="h18-0-394" class="d">-        var lastFetchedTaskId: Long? by remember { mutableStateOf(null) }
</a><a href="#h18-0-395" id="h18-0-395" class="d">-
</a><a href="#h18-0-396" id="h18-0-396" class="d">-        fun fetchNewRecentTasks() {
</a><a href="#h18-0-397" id="h18-0-397" class="d">-            scope.launch(Dispatchers.IO) {
</a><a href="#h18-0-398" id="h18-0-398" class="d">-                val tasks = context.taskManager.fetchStoredTasks(lastFetchedTaskId ?: Long.MAX_VALUE)
</a><a href="#h18-0-399" id="h18-0-399" class="d">-                if (tasks.isNotEmpty()) {
</a><a href="#h18-0-400" id="h18-0-400" class="d">-                    lastFetchedTaskId = tasks.keys.last()
</a><a href="#h18-0-401" id="h18-0-401" class="d">-                    val activeTaskIds = activeTasks.map { it.taskId }
</a><a href="#h18-0-402" id="h18-0-402" class="d">-                    recentTasks.addAll(tasks.filter { it.key !in activeTaskIds }.values)
</a><a href="#h18-0-403" id="h18-0-403" class="d">-                }
</a><a href="#h18-0-404" id="h18-0-404" class="d">-            }
</a><a href="#h18-0-405" id="h18-0-405" class="d">-        }
</a><a href="#h18-0-406" id="h18-0-406" class="d">-
</a><a href="#h18-0-407" id="h18-0-407" class="d">-        LaunchedEffect(Unit) {
</a><a href="#h18-0-408" id="h18-0-408" class="d">-            fetchActiveTasks(this)
</a><a href="#h18-0-409" id="h18-0-409" class="d">-        }
</a><a href="#h18-0-410" id="h18-0-410" class="d">-
</a><a href="#h18-0-411" id="h18-0-411" class="d">-        DisposableEffect(Unit) {
</a><a href="#h18-0-412" id="h18-0-412" class="d">-            onDispose {
</a><a href="#h18-0-413" id="h18-0-413" class="d">-                taskSelection.clear()
</a><a href="#h18-0-414" id="h18-0-414" class="d">-            }
</a><a href="#h18-0-415" id="h18-0-415" class="d">-        }
</a><a href="#h18-0-416" id="h18-0-416" class="d">-
</a><a href="#h18-0-417" id="h18-0-417" class="d">-        OnLifecycleEvent { _, event -&gt;
</a><a href="#h18-0-418" id="h18-0-418" class="d">-            if (event == Lifecycle.Event.ON_RESUME) {
</a><a href="#h18-0-419" id="h18-0-419" class="d">-                fetchActiveTasks(scope)
</a><a href="#h18-0-420" id="h18-0-420" class="d">-            }
</a><a href="#h18-0-421" id="h18-0-421" class="d">-        }
</a><a href="#h18-0-422" id="h18-0-422" class="d">-
</a><a href="#h18-0-423" id="h18-0-423" class="d">-        LazyColumn(
</a><a href="#h18-0-424" id="h18-0-424" class="d">-            state = scrollState,
</a><a href="#h18-0-425" id="h18-0-425" class="d">-            modifier = Modifier.fillMaxSize()
</a><a href="#h18-0-426" id="h18-0-426" class="d">-        ) {
</a><a href="#h18-0-427" id="h18-0-427" class="d">-            item {
</a><a href="#h18-0-428" id="h18-0-428" class="d">-                if (activeTasks.isEmpty() &amp;&amp; recentTasks.isEmpty()) {
</a><a href="#h18-0-429" id="h18-0-429" class="d">-                    Column(
</a><a href="#h18-0-430" id="h18-0-430" class="d">-                        modifier = Modifier.fillMaxSize(),
</a><a href="#h18-0-431" id="h18-0-431" class="d">-                        horizontalAlignment = Alignment.CenterHorizontally,
</a><a href="#h18-0-432" id="h18-0-432" class="d">-                        verticalArrangement = Arrangement.Center
</a><a href="#h18-0-433" id="h18-0-433" class="d">-                    ) {
</a><a href="#h18-0-434" id="h18-0-434" class="d">-                        context.translation[&quot;manager.sections.tasks.no_tasks&quot;].let {
</a><a href="#h18-0-435" id="h18-0-435" class="d">-                            Icon(Icons.Filled.CheckCircle, contentDescription = it, tint = MaterialTheme.colorScheme.primary)
</a><a href="#h18-0-436" id="h18-0-436" class="d">-                            Text(it, style = MaterialTheme.typography.bodyLarge)
</a><a href="#h18-0-437" id="h18-0-437" class="d">-                        }
</a><a href="#h18-0-438" id="h18-0-438" class="d">-                    }
</a><a href="#h18-0-439" id="h18-0-439" class="d">-                }
</a><a href="#h18-0-440" id="h18-0-440" class="d">-            }
</a><a href="#h18-0-441" id="h18-0-441" class="d">-            items(activeTasks, key = { it.taskId }) {pendingTask -&gt;
</a><a href="#h18-0-442" id="h18-0-442" class="d">-                TaskCard(modifier = Modifier.padding(8.dp), pendingTask.task, pendingTask = pendingTask)
</a><a href="#h18-0-443" id="h18-0-443" class="d">-            }
</a><a href="#h18-0-444" id="h18-0-444" class="d">-            items(recentTasks, key = { it.hash }) { task -&gt;
</a><a href="#h18-0-445" id="h18-0-445" class="d">-                TaskCard(modifier = Modifier.padding(8.dp), task)
</a><a href="#h18-0-446" id="h18-0-446" class="d">-            }
</a><a href="#h18-0-447" id="h18-0-447" class="d">-            item {
</a><a href="#h18-0-448" id="h18-0-448" class="d">-                Spacer(modifier = Modifier.height(20.dp))
</a><a href="#h18-0-449" id="h18-0-449" class="d">-                LaunchedEffect(remember { derivedStateOf { scrollState.firstVisibleItemIndex } }) {
</a><a href="#h18-0-450" id="h18-0-450" class="d">-                    fetchNewRecentTasks()
</a><a href="#h18-0-451" id="h18-0-451" class="d">-                }
</a><a href="#h18-0-452" id="h18-0-452" class="d">-            }
</a><a href="#h18-0-453" id="h18-0-453" class="d">-        }
</a><a href="#h18-0-454" id="h18-0-454" class="d">-    }
</a><a href="#h18-0-455" id="h18-0-455" class="d">-}</a><a href="#h18-0-456" id="h18-0-456" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h19" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/features/CallbackAlias.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/features/CallbackAlias.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/features/CallbackAlias.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/features/CallbackAlias.kt</a></b>
<a href="#h19-0" id="h19-0" class="h">@@ -1,4 +0,0 @@
</a><a href="#h19-0-0" id="h19-0-0" class="d">-package me.rhunk.snapenhance.ui.manager.sections.features
</a><a href="#h19-0-1" id="h19-0-1" class="d">-
</a><a href="#h19-0-2" id="h19-0-2" class="d">-typealias ClickCallback = (Boolean) -&gt; Unit
</a><a href="#h19-0-3" id="h19-0-3" class="d">-typealias RegisterClickCallback = (ClickCallback) -&gt; ClickCallback</a><a href="#h19-0-4" id="h19-0-4" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h20" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/features/FeaturesSection.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/features/FeaturesSection.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/features/FeaturesSection.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/features/FeaturesSection.kt</a></b>
<a href="#h20-0" id="h20-0" class="h">@@ -1,589 +0,0 @@
</a><a href="#h20-0-0" id="h20-0-0" class="d">-package me.rhunk.snapenhance.ui.manager.sections.features
</a><a href="#h20-0-1" id="h20-0-1" class="d">-
</a><a href="#h20-0-2" id="h20-0-2" class="d">-import android.content.Intent
</a><a href="#h20-0-3" id="h20-0-3" class="d">-import android.net.Uri
</a><a href="#h20-0-4" id="h20-0-4" class="d">-import androidx.compose.animation.AnimatedContentTransitionScope
</a><a href="#h20-0-5" id="h20-0-5" class="d">-import androidx.compose.animation.core.tween
</a><a href="#h20-0-6" id="h20-0-6" class="d">-import androidx.compose.foundation.background
</a><a href="#h20-0-7" id="h20-0-7" class="d">-import androidx.compose.foundation.clickable
</a><a href="#h20-0-8" id="h20-0-8" class="d">-import androidx.compose.foundation.layout.*
</a><a href="#h20-0-9" id="h20-0-9" class="d">-import androidx.compose.foundation.lazy.LazyColumn
</a><a href="#h20-0-10" id="h20-0-10" class="d">-import androidx.compose.foundation.lazy.items
</a><a href="#h20-0-11" id="h20-0-11" class="d">-import androidx.compose.foundation.shape.RoundedCornerShape
</a><a href="#h20-0-12" id="h20-0-12" class="d">-import androidx.compose.foundation.text.KeyboardActions
</a><a href="#h20-0-13" id="h20-0-13" class="d">-import androidx.compose.material.icons.Icons
</a><a href="#h20-0-14" id="h20-0-14" class="d">-import androidx.compose.material.icons.filled.Close
</a><a href="#h20-0-15" id="h20-0-15" class="d">-import androidx.compose.material.icons.filled.FolderOpen
</a><a href="#h20-0-16" id="h20-0-16" class="d">-import androidx.compose.material.icons.filled.MoreVert
</a><a href="#h20-0-17" id="h20-0-17" class="d">-import androidx.compose.material.icons.filled.OpenInNew
</a><a href="#h20-0-18" id="h20-0-18" class="d">-import androidx.compose.material.icons.filled.Search
</a><a href="#h20-0-19" id="h20-0-19" class="d">-import androidx.compose.material.icons.rounded.Save
</a><a href="#h20-0-20" id="h20-0-20" class="d">-import androidx.compose.material3.*
</a><a href="#h20-0-21" id="h20-0-21" class="d">-import androidx.compose.runtime.*
</a><a href="#h20-0-22" id="h20-0-22" class="d">-import androidx.compose.ui.Alignment
</a><a href="#h20-0-23" id="h20-0-23" class="d">-import androidx.compose.ui.Modifier
</a><a href="#h20-0-24" id="h20-0-24" class="d">-import androidx.compose.ui.focus.FocusRequester
</a><a href="#h20-0-25" id="h20-0-25" class="d">-import androidx.compose.ui.focus.focusRequester
</a><a href="#h20-0-26" id="h20-0-26" class="d">-import androidx.compose.ui.graphics.Color
</a><a href="#h20-0-27" id="h20-0-27" class="d">-import androidx.compose.ui.graphics.vector.ImageVector
</a><a href="#h20-0-28" id="h20-0-28" class="d">-import androidx.compose.ui.text.font.FontWeight
</a><a href="#h20-0-29" id="h20-0-29" class="d">-import androidx.compose.ui.text.style.TextOverflow
</a><a href="#h20-0-30" id="h20-0-30" class="d">-import androidx.compose.ui.unit.dp
</a><a href="#h20-0-31" id="h20-0-31" class="d">-import androidx.compose.ui.unit.sp
</a><a href="#h20-0-32" id="h20-0-32" class="d">-import androidx.navigation.NavGraph.Companion.findStartDestination
</a><a href="#h20-0-33" id="h20-0-33" class="d">-import androidx.navigation.NavGraphBuilder
</a><a href="#h20-0-34" id="h20-0-34" class="d">-import androidx.navigation.NavOptions
</a><a href="#h20-0-35" id="h20-0-35" class="d">-import androidx.navigation.compose.composable
</a><a href="#h20-0-36" id="h20-0-36" class="d">-import androidx.navigation.navigation
</a><a href="#h20-0-37" id="h20-0-37" class="d">-import kotlinx.coroutines.Job
</a><a href="#h20-0-38" id="h20-0-38" class="d">-import kotlinx.coroutines.delay
</a><a href="#h20-0-39" id="h20-0-39" class="d">-import kotlinx.coroutines.launch
</a><a href="#h20-0-40" id="h20-0-40" class="d">-import me.rhunk.snapenhance.common.config.*
</a><a href="#h20-0-41" id="h20-0-41" class="d">-import me.rhunk.snapenhance.ui.manager.MainActivity
</a><a href="#h20-0-42" id="h20-0-42" class="d">-import me.rhunk.snapenhance.ui.manager.Section
</a><a href="#h20-0-43" id="h20-0-43" class="d">-import me.rhunk.snapenhance.ui.util.*
</a><a href="#h20-0-44" id="h20-0-44" class="d">-
</a><a href="#h20-0-45" id="h20-0-45" class="d">-@OptIn(ExperimentalMaterial3Api::class)
</a><a href="#h20-0-46" id="h20-0-46" class="d">-class FeaturesSection : Section() {
</a><a href="#h20-0-47" id="h20-0-47" class="d">-    private val alertDialogs by lazy { AlertDialogs(context.translation) }
</a><a href="#h20-0-48" id="h20-0-48" class="d">-
</a><a href="#h20-0-49" id="h20-0-49" class="d">-    companion object {
</a><a href="#h20-0-50" id="h20-0-50" class="d">-        const val MAIN_ROUTE = &quot;feature_root&quot;
</a><a href="#h20-0-51" id="h20-0-51" class="d">-        const val FEATURE_CONTAINER_ROUTE = &quot;feature_container/{name}&quot;
</a><a href="#h20-0-52" id="h20-0-52" class="d">-        const val SEARCH_FEATURE_ROUTE = &quot;search_feature/{keyword}&quot;
</a><a href="#h20-0-53" id="h20-0-53" class="d">-    }
</a><a href="#h20-0-54" id="h20-0-54" class="d">-
</a><a href="#h20-0-55" id="h20-0-55" class="d">-
</a><a href="#h20-0-56" id="h20-0-56" class="d">-    private var activityLauncherHelper: ActivityLauncherHelper? = null
</a><a href="#h20-0-57" id="h20-0-57" class="d">-    private val featuresRouteName by lazy { context.translation[&quot;manager.routes.features&quot;] }
</a><a href="#h20-0-58" id="h20-0-58" class="d">-
</a><a href="#h20-0-59" id="h20-0-59" class="d">-    private lateinit var rememberScaffoldState: BottomSheetScaffoldState
</a><a href="#h20-0-60" id="h20-0-60" class="d">-
</a><a href="#h20-0-61" id="h20-0-61" class="d">-    private val allContainers by lazy {
</a><a href="#h20-0-62" id="h20-0-62" class="d">-        val containers = mutableMapOf&lt;String, PropertyPair&lt;*&gt;&gt;()
</a><a href="#h20-0-63" id="h20-0-63" class="d">-        fun queryContainerRecursive(container: ConfigContainer) {
</a><a href="#h20-0-64" id="h20-0-64" class="d">-            container.properties.forEach {
</a><a href="#h20-0-65" id="h20-0-65" class="d">-                if (it.key.dataType.type == DataProcessors.Type.CONTAINER) {
</a><a href="#h20-0-66" id="h20-0-66" class="d">-                    containers[it.key.name] = PropertyPair(it.key, it.value)
</a><a href="#h20-0-67" id="h20-0-67" class="d">-                    queryContainerRecursive(it.value.get() as ConfigContainer)
</a><a href="#h20-0-68" id="h20-0-68" class="d">-                }
</a><a href="#h20-0-69" id="h20-0-69" class="d">-            }
</a><a href="#h20-0-70" id="h20-0-70" class="d">-        }
</a><a href="#h20-0-71" id="h20-0-71" class="d">-        queryContainerRecursive(context.config.root)
</a><a href="#h20-0-72" id="h20-0-72" class="d">-        containers
</a><a href="#h20-0-73" id="h20-0-73" class="d">-    }
</a><a href="#h20-0-74" id="h20-0-74" class="d">-
</a><a href="#h20-0-75" id="h20-0-75" class="d">-    private val allProperties by lazy {
</a><a href="#h20-0-76" id="h20-0-76" class="d">-        val properties = mutableMapOf&lt;PropertyKey&lt;*&gt;, PropertyValue&lt;*&gt;&gt;()
</a><a href="#h20-0-77" id="h20-0-77" class="d">-        allContainers.values.forEach {
</a><a href="#h20-0-78" id="h20-0-78" class="d">-            val container = it.value.get() as ConfigContainer
</a><a href="#h20-0-79" id="h20-0-79" class="d">-            container.properties.forEach { property -&gt;
</a><a href="#h20-0-80" id="h20-0-80" class="d">-                properties[property.key] = property.value
</a><a href="#h20-0-81" id="h20-0-81" class="d">-            }
</a><a href="#h20-0-82" id="h20-0-82" class="d">-        }
</a><a href="#h20-0-83" id="h20-0-83" class="d">-        properties
</a><a href="#h20-0-84" id="h20-0-84" class="d">-    }
</a><a href="#h20-0-85" id="h20-0-85" class="d">-
</a><a href="#h20-0-86" id="h20-0-86" class="d">-    private fun navigateToMainRoot() {
</a><a href="#h20-0-87" id="h20-0-87" class="d">-        navController.navigate(MAIN_ROUTE, NavOptions.Builder()
</a><a href="#h20-0-88" id="h20-0-88" class="d">-            .setPopUpTo(navController.graph.findStartDestination().id, false)
</a><a href="#h20-0-89" id="h20-0-89" class="d">-            .setLaunchSingleTop(true)
</a><a href="#h20-0-90" id="h20-0-90" class="d">-            .build()
</a><a href="#h20-0-91" id="h20-0-91" class="d">-        )
</a><a href="#h20-0-92" id="h20-0-92" class="d">-    }
</a><a href="#h20-0-93" id="h20-0-93" class="d">-
</a><a href="#h20-0-94" id="h20-0-94" class="d">-    override fun canGoBack() = sectionTopBarName() != featuresRouteName
</a><a href="#h20-0-95" id="h20-0-95" class="d">-
</a><a href="#h20-0-96" id="h20-0-96" class="d">-    override fun sectionTopBarName(): String {
</a><a href="#h20-0-97" id="h20-0-97" class="d">-        navController.currentBackStackEntry?.arguments?.getString(&quot;name&quot;)?.let { routeName -&gt;
</a><a href="#h20-0-98" id="h20-0-98" class="d">-            val currentContainerPair = allContainers[routeName]
</a><a href="#h20-0-99" id="h20-0-99" class="d">-            return context.translation[&quot;${currentContainerPair?.key?.propertyTranslationPath()}.name&quot;]
</a><a href="#h20-0-100" id="h20-0-100" class="d">-        }
</a><a href="#h20-0-101" id="h20-0-101" class="d">-        return featuresRouteName
</a><a href="#h20-0-102" id="h20-0-102" class="d">-    }
</a><a href="#h20-0-103" id="h20-0-103" class="d">-
</a><a href="#h20-0-104" id="h20-0-104" class="d">-    override fun init() {
</a><a href="#h20-0-105" id="h20-0-105" class="d">-        activityLauncherHelper = ActivityLauncherHelper(context.activity!!)
</a><a href="#h20-0-106" id="h20-0-106" class="d">-    }
</a><a href="#h20-0-107" id="h20-0-107" class="d">-
</a><a href="#h20-0-108" id="h20-0-108" class="d">-    private fun activityLauncher(block: ActivityLauncherHelper.() -&gt; Unit) {
</a><a href="#h20-0-109" id="h20-0-109" class="d">-        activityLauncherHelper?.let(block) ?: run {
</a><a href="#h20-0-110" id="h20-0-110" class="d">-            //open manager if activity launcher is null
</a><a href="#h20-0-111" id="h20-0-111" class="d">-            val intent = Intent(context.androidContext, MainActivity::class.java)
</a><a href="#h20-0-112" id="h20-0-112" class="d">-            intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK)
</a><a href="#h20-0-113" id="h20-0-113" class="d">-            intent.putExtra(&quot;route&quot;, enumSection.route)
</a><a href="#h20-0-114" id="h20-0-114" class="d">-            context.androidContext.startActivity(intent)
</a><a href="#h20-0-115" id="h20-0-115" class="d">-        }
</a><a href="#h20-0-116" id="h20-0-116" class="d">-    }
</a><a href="#h20-0-117" id="h20-0-117" class="d">-
</a><a href="#h20-0-118" id="h20-0-118" class="d">-    override fun build(navGraphBuilder: NavGraphBuilder) {
</a><a href="#h20-0-119" id="h20-0-119" class="d">-        navGraphBuilder.navigation(route = enumSection.route, startDestination = MAIN_ROUTE) {
</a><a href="#h20-0-120" id="h20-0-120" class="d">-            composable(MAIN_ROUTE) {
</a><a href="#h20-0-121" id="h20-0-121" class="d">-                Container(context.config.root)
</a><a href="#h20-0-122" id="h20-0-122" class="d">-            }
</a><a href="#h20-0-123" id="h20-0-123" class="d">-
</a><a href="#h20-0-124" id="h20-0-124" class="d">-            composable(FEATURE_CONTAINER_ROUTE, enterTransition = {
</a><a href="#h20-0-125" id="h20-0-125" class="d">-                slideIntoContainer(AnimatedContentTransitionScope.SlideDirection.Left, animationSpec = tween(100))
</a><a href="#h20-0-126" id="h20-0-126" class="d">-            }, exitTransition = {
</a><a href="#h20-0-127" id="h20-0-127" class="d">-                slideOutOfContainer(AnimatedContentTransitionScope.SlideDirection.Right, animationSpec = tween(300))
</a><a href="#h20-0-128" id="h20-0-128" class="d">-            }) { backStackEntry -&gt;
</a><a href="#h20-0-129" id="h20-0-129" class="d">-                backStackEntry.arguments?.getString(&quot;name&quot;)?.let { containerName -&gt;
</a><a href="#h20-0-130" id="h20-0-130" class="d">-                    allContainers[containerName]?.let {
</a><a href="#h20-0-131" id="h20-0-131" class="d">-                        Container(it.value.get() as ConfigContainer)
</a><a href="#h20-0-132" id="h20-0-132" class="d">-                    }
</a><a href="#h20-0-133" id="h20-0-133" class="d">-                }
</a><a href="#h20-0-134" id="h20-0-134" class="d">-            }
</a><a href="#h20-0-135" id="h20-0-135" class="d">-
</a><a href="#h20-0-136" id="h20-0-136" class="d">-            composable(SEARCH_FEATURE_ROUTE) { backStackEntry -&gt;
</a><a href="#h20-0-137" id="h20-0-137" class="d">-                backStackEntry.arguments?.getString(&quot;keyword&quot;)?.let { keyword -&gt;
</a><a href="#h20-0-138" id="h20-0-138" class="d">-                    val properties = allProperties.filter {
</a><a href="#h20-0-139" id="h20-0-139" class="d">-                        it.key.name.contains(keyword, ignoreCase = true) ||
</a><a href="#h20-0-140" id="h20-0-140" class="d">-                                context.translation[it.key.propertyName()].contains(keyword, ignoreCase = true) ||
</a><a href="#h20-0-141" id="h20-0-141" class="d">-                                context.translation[it.key.propertyDescription()].contains(keyword, ignoreCase = true)
</a><a href="#h20-0-142" id="h20-0-142" class="d">-                    }.map { PropertyPair(it.key, it.value) }
</a><a href="#h20-0-143" id="h20-0-143" class="d">-
</a><a href="#h20-0-144" id="h20-0-144" class="d">-                    PropertiesView(properties)
</a><a href="#h20-0-145" id="h20-0-145" class="d">-                }
</a><a href="#h20-0-146" id="h20-0-146" class="d">-            }
</a><a href="#h20-0-147" id="h20-0-147" class="d">-        }
</a><a href="#h20-0-148" id="h20-0-148" class="d">-    }
</a><a href="#h20-0-149" id="h20-0-149" class="d">-
</a><a href="#h20-0-150" id="h20-0-150" class="d">-    @Composable
</a><a href="#h20-0-151" id="h20-0-151" class="d">-    private fun PropertyAction(property: PropertyPair&lt;*&gt;, registerClickCallback: RegisterClickCallback) {
</a><a href="#h20-0-152" id="h20-0-152" class="d">-        var showDialog by remember { mutableStateOf(false) }
</a><a href="#h20-0-153" id="h20-0-153" class="d">-        var dialogComposable by remember { mutableStateOf&lt;@Composable () -&gt; Unit&gt;({}) }
</a><a href="#h20-0-154" id="h20-0-154" class="d">-
</a><a href="#h20-0-155" id="h20-0-155" class="d">-        fun registerDialogOnClickCallback() = registerClickCallback { showDialog = true }
</a><a href="#h20-0-156" id="h20-0-156" class="d">-
</a><a href="#h20-0-157" id="h20-0-157" class="d">-        if (showDialog) {
</a><a href="#h20-0-158" id="h20-0-158" class="d">-            Dialog(
</a><a href="#h20-0-159" id="h20-0-159" class="d">-                properties = DialogProperties(
</a><a href="#h20-0-160" id="h20-0-160" class="d">-                    usePlatformDefaultWidth = false
</a><a href="#h20-0-161" id="h20-0-161" class="d">-                ),
</a><a href="#h20-0-162" id="h20-0-162" class="d">-                onDismissRequest = { showDialog = false },
</a><a href="#h20-0-163" id="h20-0-163" class="d">-            ) {
</a><a href="#h20-0-164" id="h20-0-164" class="d">-                dialogComposable()
</a><a href="#h20-0-165" id="h20-0-165" class="d">-            }
</a><a href="#h20-0-166" id="h20-0-166" class="d">-        }
</a><a href="#h20-0-167" id="h20-0-167" class="d">-
</a><a href="#h20-0-168" id="h20-0-168" class="d">-        val propertyValue = property.value
</a><a href="#h20-0-169" id="h20-0-169" class="d">-
</a><a href="#h20-0-170" id="h20-0-170" class="d">-        if (property.key.params.flags.contains(ConfigFlag.FOLDER)) {
</a><a href="#h20-0-171" id="h20-0-171" class="d">-            IconButton(onClick = registerClickCallback {
</a><a href="#h20-0-172" id="h20-0-172" class="d">-                activityLauncher {
</a><a href="#h20-0-173" id="h20-0-173" class="d">-                    chooseFolder { uri -&gt;
</a><a href="#h20-0-174" id="h20-0-174" class="d">-                        propertyValue.setAny(uri)
</a><a href="#h20-0-175" id="h20-0-175" class="d">-                    }
</a><a href="#h20-0-176" id="h20-0-176" class="d">-                }
</a><a href="#h20-0-177" id="h20-0-177" class="d">-            }.let { { it.invoke(true) } }) {
</a><a href="#h20-0-178" id="h20-0-178" class="d">-                Icon(Icons.Filled.FolderOpen, contentDescription = null)
</a><a href="#h20-0-179" id="h20-0-179" class="d">-            }
</a><a href="#h20-0-180" id="h20-0-180" class="d">-            return
</a><a href="#h20-0-181" id="h20-0-181" class="d">-        }
</a><a href="#h20-0-182" id="h20-0-182" class="d">-
</a><a href="#h20-0-183" id="h20-0-183" class="d">-        when (val dataType = remember { property.key.dataType.type }) {
</a><a href="#h20-0-184" id="h20-0-184" class="d">-            DataProcessors.Type.BOOLEAN -&gt; {
</a><a href="#h20-0-185" id="h20-0-185" class="d">-                var state by remember { mutableStateOf(propertyValue.get() as Boolean) }
</a><a href="#h20-0-186" id="h20-0-186" class="d">-                Switch(
</a><a href="#h20-0-187" id="h20-0-187" class="d">-                    checked = state,
</a><a href="#h20-0-188" id="h20-0-188" class="d">-                    onCheckedChange = registerClickCallback {
</a><a href="#h20-0-189" id="h20-0-189" class="d">-                        state = state.not()
</a><a href="#h20-0-190" id="h20-0-190" class="d">-                        propertyValue.setAny(state)
</a><a href="#h20-0-191" id="h20-0-191" class="d">-                    }
</a><a href="#h20-0-192" id="h20-0-192" class="d">-                )
</a><a href="#h20-0-193" id="h20-0-193" class="d">-            }
</a><a href="#h20-0-194" id="h20-0-194" class="d">-
</a><a href="#h20-0-195" id="h20-0-195" class="d">-            DataProcessors.Type.MAP_COORDINATES -&gt; {
</a><a href="#h20-0-196" id="h20-0-196" class="d">-                registerDialogOnClickCallback()
</a><a href="#h20-0-197" id="h20-0-197" class="d">-                dialogComposable = {
</a><a href="#h20-0-198" id="h20-0-198" class="d">-                    alertDialogs.ChooseLocationDialog(property) {
</a><a href="#h20-0-199" id="h20-0-199" class="d">-                        showDialog = false
</a><a href="#h20-0-200" id="h20-0-200" class="d">-                    }
</a><a href="#h20-0-201" id="h20-0-201" class="d">-                }
</a><a href="#h20-0-202" id="h20-0-202" class="d">-
</a><a href="#h20-0-203" id="h20-0-203" class="d">-                Text(
</a><a href="#h20-0-204" id="h20-0-204" class="d">-                    overflow = TextOverflow.Ellipsis,
</a><a href="#h20-0-205" id="h20-0-205" class="d">-                    maxLines = 1,
</a><a href="#h20-0-206" id="h20-0-206" class="d">-                    modifier = Modifier.widthIn(0.dp, 120.dp),
</a><a href="#h20-0-207" id="h20-0-207" class="d">-                    text = (propertyValue.get() as Pair&lt;*, *&gt;).let {
</a><a href="#h20-0-208" id="h20-0-208" class="d">-                        &quot;${it.first.toString().toFloatOrNull() ?: 0F}, ${it.second.toString().toFloatOrNull() ?: 0F}&quot;
</a><a href="#h20-0-209" id="h20-0-209" class="d">-                    }
</a><a href="#h20-0-210" id="h20-0-210" class="d">-                )
</a><a href="#h20-0-211" id="h20-0-211" class="d">-            }
</a><a href="#h20-0-212" id="h20-0-212" class="d">-
</a><a href="#h20-0-213" id="h20-0-213" class="d">-            DataProcessors.Type.STRING_UNIQUE_SELECTION -&gt; {
</a><a href="#h20-0-214" id="h20-0-214" class="d">-                registerDialogOnClickCallback()
</a><a href="#h20-0-215" id="h20-0-215" class="d">-
</a><a href="#h20-0-216" id="h20-0-216" class="d">-                dialogComposable = {
</a><a href="#h20-0-217" id="h20-0-217" class="d">-                    alertDialogs.UniqueSelectionDialog(property)
</a><a href="#h20-0-218" id="h20-0-218" class="d">-                }
</a><a href="#h20-0-219" id="h20-0-219" class="d">-
</a><a href="#h20-0-220" id="h20-0-220" class="d">-                Text(
</a><a href="#h20-0-221" id="h20-0-221" class="d">-                    overflow = TextOverflow.Ellipsis,
</a><a href="#h20-0-222" id="h20-0-222" class="d">-                    maxLines = 1,
</a><a href="#h20-0-223" id="h20-0-223" class="d">-                    modifier = Modifier.widthIn(0.dp, 120.dp),
</a><a href="#h20-0-224" id="h20-0-224" class="d">-                    text = (propertyValue.getNullable() as? String ?: &quot;null&quot;).let {
</a><a href="#h20-0-225" id="h20-0-225" class="d">-                        property.key.propertyOption(context.translation, it)
</a><a href="#h20-0-226" id="h20-0-226" class="d">-                    }
</a><a href="#h20-0-227" id="h20-0-227" class="d">-                )
</a><a href="#h20-0-228" id="h20-0-228" class="d">-            }
</a><a href="#h20-0-229" id="h20-0-229" class="d">-
</a><a href="#h20-0-230" id="h20-0-230" class="d">-            DataProcessors.Type.STRING_MULTIPLE_SELECTION, DataProcessors.Type.STRING, DataProcessors.Type.INTEGER, DataProcessors.Type.FLOAT -&gt; {
</a><a href="#h20-0-231" id="h20-0-231" class="d">-                dialogComposable = {
</a><a href="#h20-0-232" id="h20-0-232" class="d">-                    when (dataType) {
</a><a href="#h20-0-233" id="h20-0-233" class="d">-                        DataProcessors.Type.STRING_MULTIPLE_SELECTION -&gt; {
</a><a href="#h20-0-234" id="h20-0-234" class="d">-                            alertDialogs.MultipleSelectionDialog(property)
</a><a href="#h20-0-235" id="h20-0-235" class="d">-                        }
</a><a href="#h20-0-236" id="h20-0-236" class="d">-                        DataProcessors.Type.STRING, DataProcessors.Type.INTEGER, DataProcessors.Type.FLOAT -&gt; {
</a><a href="#h20-0-237" id="h20-0-237" class="d">-                            alertDialogs.KeyboardInputDialog(property) { showDialog = false }
</a><a href="#h20-0-238" id="h20-0-238" class="d">-                        }
</a><a href="#h20-0-239" id="h20-0-239" class="d">-                        else -&gt; {}
</a><a href="#h20-0-240" id="h20-0-240" class="d">-                    }
</a><a href="#h20-0-241" id="h20-0-241" class="d">-                }
</a><a href="#h20-0-242" id="h20-0-242" class="d">-
</a><a href="#h20-0-243" id="h20-0-243" class="d">-                registerDialogOnClickCallback().let { { it.invoke(true) } }.also {
</a><a href="#h20-0-244" id="h20-0-244" class="d">-                    if (dataType == DataProcessors.Type.INTEGER ||
</a><a href="#h20-0-245" id="h20-0-245" class="d">-                        dataType == DataProcessors.Type.FLOAT) {
</a><a href="#h20-0-246" id="h20-0-246" class="d">-                        FilledIconButton(onClick = it) {
</a><a href="#h20-0-247" id="h20-0-247" class="d">-                            Text(
</a><a href="#h20-0-248" id="h20-0-248" class="d">-                                text = propertyValue.get().toString(),
</a><a href="#h20-0-249" id="h20-0-249" class="d">-                                modifier = Modifier.wrapContentWidth(),
</a><a href="#h20-0-250" id="h20-0-250" class="d">-                                overflow = TextOverflow.Ellipsis
</a><a href="#h20-0-251" id="h20-0-251" class="d">-                            )
</a><a href="#h20-0-252" id="h20-0-252" class="d">-                        }
</a><a href="#h20-0-253" id="h20-0-253" class="d">-                    } else {
</a><a href="#h20-0-254" id="h20-0-254" class="d">-                        IconButton(onClick = it) {
</a><a href="#h20-0-255" id="h20-0-255" class="d">-                            Icon(Icons.Filled.OpenInNew, contentDescription = null)
</a><a href="#h20-0-256" id="h20-0-256" class="d">-                        }
</a><a href="#h20-0-257" id="h20-0-257" class="d">-                    }
</a><a href="#h20-0-258" id="h20-0-258" class="d">-                }
</a><a href="#h20-0-259" id="h20-0-259" class="d">-            }
</a><a href="#h20-0-260" id="h20-0-260" class="d">-            DataProcessors.Type.CONTAINER -&gt; {
</a><a href="#h20-0-261" id="h20-0-261" class="d">-                val container = propertyValue.get() as ConfigContainer
</a><a href="#h20-0-262" id="h20-0-262" class="d">-
</a><a href="#h20-0-263" id="h20-0-263" class="d">-                registerClickCallback {
</a><a href="#h20-0-264" id="h20-0-264" class="d">-                    navController.navigate(FEATURE_CONTAINER_ROUTE.replace(&quot;{name}&quot;, property.name))
</a><a href="#h20-0-265" id="h20-0-265" class="d">-                }
</a><a href="#h20-0-266" id="h20-0-266" class="d">-
</a><a href="#h20-0-267" id="h20-0-267" class="d">-                if (!container.hasGlobalState) return
</a><a href="#h20-0-268" id="h20-0-268" class="d">-
</a><a href="#h20-0-269" id="h20-0-269" class="d">-                var state by remember { mutableStateOf(container.globalState ?: false) }
</a><a href="#h20-0-270" id="h20-0-270" class="d">-
</a><a href="#h20-0-271" id="h20-0-271" class="d">-                Box(
</a><a href="#h20-0-272" id="h20-0-272" class="d">-                    modifier = Modifier
</a><a href="#h20-0-273" id="h20-0-273" class="d">-                        .padding(end = 15.dp),
</a><a href="#h20-0-274" id="h20-0-274" class="d">-                ) {
</a><a href="#h20-0-275" id="h20-0-275" class="d">-
</a><a href="#h20-0-276" id="h20-0-276" class="d">-                    Box(modifier = Modifier
</a><a href="#h20-0-277" id="h20-0-277" class="d">-                        .height(50.dp)
</a><a href="#h20-0-278" id="h20-0-278" class="d">-                        .width(1.dp)
</a><a href="#h20-0-279" id="h20-0-279" class="d">-                        .background(
</a><a href="#h20-0-280" id="h20-0-280" class="d">-                            color = MaterialTheme.colorScheme.primary.copy(alpha = 0.12f),
</a><a href="#h20-0-281" id="h20-0-281" class="d">-                            shape = RoundedCornerShape(5.dp)
</a><a href="#h20-0-282" id="h20-0-282" class="d">-                        ))
</a><a href="#h20-0-283" id="h20-0-283" class="d">-                }
</a><a href="#h20-0-284" id="h20-0-284" class="d">-
</a><a href="#h20-0-285" id="h20-0-285" class="d">-                Switch(
</a><a href="#h20-0-286" id="h20-0-286" class="d">-                    checked = state,
</a><a href="#h20-0-287" id="h20-0-287" class="d">-                    onCheckedChange = {
</a><a href="#h20-0-288" id="h20-0-288" class="d">-                        state = state.not()
</a><a href="#h20-0-289" id="h20-0-289" class="d">-                        container.globalState = state
</a><a href="#h20-0-290" id="h20-0-290" class="d">-                    }
</a><a href="#h20-0-291" id="h20-0-291" class="d">-                )
</a><a href="#h20-0-292" id="h20-0-292" class="d">-            }
</a><a href="#h20-0-293" id="h20-0-293" class="d">-        }
</a><a href="#h20-0-294" id="h20-0-294" class="d">-
</a><a href="#h20-0-295" id="h20-0-295" class="d">-    }
</a><a href="#h20-0-296" id="h20-0-296" class="d">-
</a><a href="#h20-0-297" id="h20-0-297" class="d">-    @Composable
</a><a href="#h20-0-298" id="h20-0-298" class="d">-    private fun PropertyCard(property: PropertyPair&lt;*&gt;) {
</a><a href="#h20-0-299" id="h20-0-299" class="d">-        var clickCallback by remember { mutableStateOf&lt;ClickCallback?&gt;(null) }
</a><a href="#h20-0-300" id="h20-0-300" class="d">-        val noticeColorMap = mapOf(
</a><a href="#h20-0-301" id="h20-0-301" class="d">-            FeatureNotice.UNSTABLE.key to Color(0xFFFFFB87),
</a><a href="#h20-0-302" id="h20-0-302" class="d">-            FeatureNotice.BAN_RISK.key to Color(0xFFFF8585),
</a><a href="#h20-0-303" id="h20-0-303" class="d">-            FeatureNotice.INTERNAL_BEHAVIOR.key to Color(0xFFFFFB87),
</a><a href="#h20-0-304" id="h20-0-304" class="d">-            FeatureNotice.REQUIRE_NATIVE_HOOKS.key to Color(0xFFFF5722),
</a><a href="#h20-0-305" id="h20-0-305" class="d">-        )
</a><a href="#h20-0-306" id="h20-0-306" class="d">-
</a><a href="#h20-0-307" id="h20-0-307" class="d">-        Card(
</a><a href="#h20-0-308" id="h20-0-308" class="d">-            modifier = Modifier
</a><a href="#h20-0-309" id="h20-0-309" class="d">-                .fillMaxWidth()
</a><a href="#h20-0-310" id="h20-0-310" class="d">-                .padding(start = 10.dp, end = 10.dp, top = 5.dp, bottom = 5.dp)
</a><a href="#h20-0-311" id="h20-0-311" class="d">-        ) {
</a><a href="#h20-0-312" id="h20-0-312" class="d">-            Row(
</a><a href="#h20-0-313" id="h20-0-313" class="d">-                modifier = Modifier
</a><a href="#h20-0-314" id="h20-0-314" class="d">-                    .fillMaxSize()
</a><a href="#h20-0-315" id="h20-0-315" class="d">-                    .clickable {
</a><a href="#h20-0-316" id="h20-0-316" class="d">-                        clickCallback?.invoke(true)
</a><a href="#h20-0-317" id="h20-0-317" class="d">-                    }
</a><a href="#h20-0-318" id="h20-0-318" class="d">-                    .padding(all = 4.dp),
</a><a href="#h20-0-319" id="h20-0-319" class="d">-                horizontalArrangement = Arrangement.SpaceBetween
</a><a href="#h20-0-320" id="h20-0-320" class="d">-            ) {
</a><a href="#h20-0-321" id="h20-0-321" class="d">-                property.key.params.icon?.let { iconName -&gt;
</a><a href="#h20-0-322" id="h20-0-322" class="d">-                    //TODO: find a better way to load icons
</a><a href="#h20-0-323" id="h20-0-323" class="d">-                    val icon: ImageVector? = remember(iconName) {
</a><a href="#h20-0-324" id="h20-0-324" class="d">-                        runCatching {
</a><a href="#h20-0-325" id="h20-0-325" class="d">-                            val cl = Class.forName(&quot;androidx.compose.material.icons.filled.${iconName}Kt&quot;)
</a><a href="#h20-0-326" id="h20-0-326" class="d">-                            val method = cl.declaredMethods.first()
</a><a href="#h20-0-327" id="h20-0-327" class="d">-                            method.invoke(null, Icons.Filled) as ImageVector
</a><a href="#h20-0-328" id="h20-0-328" class="d">-                        }.getOrNull()
</a><a href="#h20-0-329" id="h20-0-329" class="d">-                    }
</a><a href="#h20-0-330" id="h20-0-330" class="d">-                    if (icon != null) {
</a><a href="#h20-0-331" id="h20-0-331" class="d">-                        Icon(
</a><a href="#h20-0-332" id="h20-0-332" class="d">-                            imageVector = icon,
</a><a href="#h20-0-333" id="h20-0-333" class="d">-                            contentDescription = null,
</a><a href="#h20-0-334" id="h20-0-334" class="d">-                            modifier = Modifier
</a><a href="#h20-0-335" id="h20-0-335" class="d">-                                .align(Alignment.CenterVertically)
</a><a href="#h20-0-336" id="h20-0-336" class="d">-                                .padding(start = 10.dp)
</a><a href="#h20-0-337" id="h20-0-337" class="d">-                        )
</a><a href="#h20-0-338" id="h20-0-338" class="d">-                    }
</a><a href="#h20-0-339" id="h20-0-339" class="d">-                }
</a><a href="#h20-0-340" id="h20-0-340" class="d">-
</a><a href="#h20-0-341" id="h20-0-341" class="d">-                Column(
</a><a href="#h20-0-342" id="h20-0-342" class="d">-                    modifier = Modifier
</a><a href="#h20-0-343" id="h20-0-343" class="d">-                        .align(Alignment.CenterVertically)
</a><a href="#h20-0-344" id="h20-0-344" class="d">-                        .weight(1f, fill = true)
</a><a href="#h20-0-345" id="h20-0-345" class="d">-                        .padding(all = 10.dp)
</a><a href="#h20-0-346" id="h20-0-346" class="d">-                ) {
</a><a href="#h20-0-347" id="h20-0-347" class="d">-                    Text(
</a><a href="#h20-0-348" id="h20-0-348" class="d">-                        text = context.translation[property.key.propertyName()],
</a><a href="#h20-0-349" id="h20-0-349" class="d">-                        fontSize = 16.sp,
</a><a href="#h20-0-350" id="h20-0-350" class="d">-                        fontWeight = FontWeight.Bold
</a><a href="#h20-0-351" id="h20-0-351" class="d">-                    )
</a><a href="#h20-0-352" id="h20-0-352" class="d">-                    Text(
</a><a href="#h20-0-353" id="h20-0-353" class="d">-                        text = context.translation[property.key.propertyDescription()],
</a><a href="#h20-0-354" id="h20-0-354" class="d">-                        fontSize = 12.sp,
</a><a href="#h20-0-355" id="h20-0-355" class="d">-                        lineHeight = 15.sp
</a><a href="#h20-0-356" id="h20-0-356" class="d">-                    )
</a><a href="#h20-0-357" id="h20-0-357" class="d">-                    property.key.params.notices.also {
</a><a href="#h20-0-358" id="h20-0-358" class="d">-                        if (it.isNotEmpty()) Spacer(modifier = Modifier.height(5.dp))
</a><a href="#h20-0-359" id="h20-0-359" class="d">-                    }.forEach {
</a><a href="#h20-0-360" id="h20-0-360" class="d">-                        Text(
</a><a href="#h20-0-361" id="h20-0-361" class="d">-                            text = context.translation[&quot;features.notices.${it.key}&quot;],
</a><a href="#h20-0-362" id="h20-0-362" class="d">-                            color = noticeColorMap[it.key] ?: Color(0xFFFFFB87),
</a><a href="#h20-0-363" id="h20-0-363" class="d">-                            fontSize = 12.sp,
</a><a href="#h20-0-364" id="h20-0-364" class="d">-                            lineHeight = 15.sp
</a><a href="#h20-0-365" id="h20-0-365" class="d">-                        )
</a><a href="#h20-0-366" id="h20-0-366" class="d">-                    }
</a><a href="#h20-0-367" id="h20-0-367" class="d">-                }
</a><a href="#h20-0-368" id="h20-0-368" class="d">-                Row(
</a><a href="#h20-0-369" id="h20-0-369" class="d">-                    modifier = Modifier
</a><a href="#h20-0-370" id="h20-0-370" class="d">-                        .align(Alignment.CenterVertically)
</a><a href="#h20-0-371" id="h20-0-371" class="d">-                        .padding(all = 10.dp),
</a><a href="#h20-0-372" id="h20-0-372" class="d">-                    verticalAlignment = Alignment.CenterVertically
</a><a href="#h20-0-373" id="h20-0-373" class="d">-                ) {
</a><a href="#h20-0-374" id="h20-0-374" class="d">-                    PropertyAction(property, registerClickCallback = { callback -&gt;
</a><a href="#h20-0-375" id="h20-0-375" class="d">-                        clickCallback = callback
</a><a href="#h20-0-376" id="h20-0-376" class="d">-                        callback
</a><a href="#h20-0-377" id="h20-0-377" class="d">-                    })
</a><a href="#h20-0-378" id="h20-0-378" class="d">-                }
</a><a href="#h20-0-379" id="h20-0-379" class="d">-            }
</a><a href="#h20-0-380" id="h20-0-380" class="d">-        }
</a><a href="#h20-0-381" id="h20-0-381" class="d">-    }
</a><a href="#h20-0-382" id="h20-0-382" class="d">-
</a><a href="#h20-0-383" id="h20-0-383" class="d">-    @Composable
</a><a href="#h20-0-384" id="h20-0-384" class="d">-    private fun FeatureSearchBar(rowScope: RowScope, focusRequester: FocusRequester) {
</a><a href="#h20-0-385" id="h20-0-385" class="d">-        var searchValue by remember { mutableStateOf(&quot;&quot;) }
</a><a href="#h20-0-386" id="h20-0-386" class="d">-        val scope = rememberCoroutineScope()
</a><a href="#h20-0-387" id="h20-0-387" class="d">-        var currentSearchJob by remember { mutableStateOf&lt;Job?&gt;(null) }
</a><a href="#h20-0-388" id="h20-0-388" class="d">-
</a><a href="#h20-0-389" id="h20-0-389" class="d">-        rowScope.apply {
</a><a href="#h20-0-390" id="h20-0-390" class="d">-            TextField(
</a><a href="#h20-0-391" id="h20-0-391" class="d">-                value = searchValue,
</a><a href="#h20-0-392" id="h20-0-392" class="d">-                onValueChange = { keyword -&gt;
</a><a href="#h20-0-393" id="h20-0-393" class="d">-                    searchValue = keyword
</a><a href="#h20-0-394" id="h20-0-394" class="d">-                    if (keyword.isEmpty()) {
</a><a href="#h20-0-395" id="h20-0-395" class="d">-                        navigateToMainRoot()
</a><a href="#h20-0-396" id="h20-0-396" class="d">-                        return@TextField
</a><a href="#h20-0-397" id="h20-0-397" class="d">-                    }
</a><a href="#h20-0-398" id="h20-0-398" class="d">-                    currentSearchJob?.cancel()
</a><a href="#h20-0-399" id="h20-0-399" class="d">-                    scope.launch {
</a><a href="#h20-0-400" id="h20-0-400" class="d">-                        delay(300)
</a><a href="#h20-0-401" id="h20-0-401" class="d">-                        navController.navigate(SEARCH_FEATURE_ROUTE.replace(&quot;{keyword}&quot;, keyword), NavOptions.Builder()
</a><a href="#h20-0-402" id="h20-0-402" class="d">-                            .setLaunchSingleTop(true)
</a><a href="#h20-0-403" id="h20-0-403" class="d">-                            .setPopUpTo(MAIN_ROUTE, false)
</a><a href="#h20-0-404" id="h20-0-404" class="d">-                            .build()
</a><a href="#h20-0-405" id="h20-0-405" class="d">-                        )
</a><a href="#h20-0-406" id="h20-0-406" class="d">-                    }.also { currentSearchJob = it }
</a><a href="#h20-0-407" id="h20-0-407" class="d">-                },
</a><a href="#h20-0-408" id="h20-0-408" class="d">-
</a><a href="#h20-0-409" id="h20-0-409" class="d">-                keyboardActions = KeyboardActions(onDone = {
</a><a href="#h20-0-410" id="h20-0-410" class="d">-                    focusRequester.freeFocus()
</a><a href="#h20-0-411" id="h20-0-411" class="d">-                }),
</a><a href="#h20-0-412" id="h20-0-412" class="d">-                modifier = Modifier
</a><a href="#h20-0-413" id="h20-0-413" class="d">-                    .focusRequester(focusRequester)
</a><a href="#h20-0-414" id="h20-0-414" class="d">-                    .weight(1f, fill = true)
</a><a href="#h20-0-415" id="h20-0-415" class="d">-                    .padding(end = 10.dp)
</a><a href="#h20-0-416" id="h20-0-416" class="d">-                    .height(70.dp),
</a><a href="#h20-0-417" id="h20-0-417" class="d">-                singleLine = true,
</a><a href="#h20-0-418" id="h20-0-418" class="d">-                colors = TextFieldDefaults.colors(
</a><a href="#h20-0-419" id="h20-0-419" class="d">-                    unfocusedContainerColor = MaterialTheme.colorScheme.surface,
</a><a href="#h20-0-420" id="h20-0-420" class="d">-                    focusedContainerColor = MaterialTheme.colorScheme.surface,
</a><a href="#h20-0-421" id="h20-0-421" class="d">-                    focusedIndicatorColor = Color.Transparent,
</a><a href="#h20-0-422" id="h20-0-422" class="d">-                    unfocusedIndicatorColor = Color.Transparent,
</a><a href="#h20-0-423" id="h20-0-423" class="d">-                    disabledIndicatorColor = Color.Transparent,
</a><a href="#h20-0-424" id="h20-0-424" class="d">-                    cursorColor = MaterialTheme.colorScheme.primary
</a><a href="#h20-0-425" id="h20-0-425" class="d">-                )
</a><a href="#h20-0-426" id="h20-0-426" class="d">-            )
</a><a href="#h20-0-427" id="h20-0-427" class="d">-        }
</a><a href="#h20-0-428" id="h20-0-428" class="d">-    }
</a><a href="#h20-0-429" id="h20-0-429" class="d">-
</a><a href="#h20-0-430" id="h20-0-430" class="d">-    @Composable
</a><a href="#h20-0-431" id="h20-0-431" class="d">-    override fun TopBarActions(rowScope: RowScope) {
</a><a href="#h20-0-432" id="h20-0-432" class="d">-        var showSearchBar by remember { mutableStateOf(false) }
</a><a href="#h20-0-433" id="h20-0-433" class="d">-        val focusRequester = remember { FocusRequester() }
</a><a href="#h20-0-434" id="h20-0-434" class="d">-
</a><a href="#h20-0-435" id="h20-0-435" class="d">-        if (showSearchBar) {
</a><a href="#h20-0-436" id="h20-0-436" class="d">-            FeatureSearchBar(rowScope, focusRequester)
</a><a href="#h20-0-437" id="h20-0-437" class="d">-            LaunchedEffect(true) {
</a><a href="#h20-0-438" id="h20-0-438" class="d">-                focusRequester.requestFocus()
</a><a href="#h20-0-439" id="h20-0-439" class="d">-            }
</a><a href="#h20-0-440" id="h20-0-440" class="d">-        }
</a><a href="#h20-0-441" id="h20-0-441" class="d">-
</a><a href="#h20-0-442" id="h20-0-442" class="d">-        IconButton(onClick = {
</a><a href="#h20-0-443" id="h20-0-443" class="d">-            showSearchBar = showSearchBar.not()
</a><a href="#h20-0-444" id="h20-0-444" class="d">-            if (!showSearchBar &amp;&amp; currentRoute == SEARCH_FEATURE_ROUTE) {
</a><a href="#h20-0-445" id="h20-0-445" class="d">-                navigateToMainRoot()
</a><a href="#h20-0-446" id="h20-0-446" class="d">-            }
</a><a href="#h20-0-447" id="h20-0-447" class="d">-        }) {
</a><a href="#h20-0-448" id="h20-0-448" class="d">-            Icon(
</a><a href="#h20-0-449" id="h20-0-449" class="d">-                imageVector = if (showSearchBar) Icons.Filled.Close
</a><a href="#h20-0-450" id="h20-0-450" class="d">-                    else Icons.Filled.Search,
</a><a href="#h20-0-451" id="h20-0-451" class="d">-                contentDescription = null
</a><a href="#h20-0-452" id="h20-0-452" class="d">-            )
</a><a href="#h20-0-453" id="h20-0-453" class="d">-        }
</a><a href="#h20-0-454" id="h20-0-454" class="d">-
</a><a href="#h20-0-455" id="h20-0-455" class="d">-        if (showSearchBar) return
</a><a href="#h20-0-456" id="h20-0-456" class="d">-
</a><a href="#h20-0-457" id="h20-0-457" class="d">-        var showExportDropdownMenu by remember { mutableStateOf(false) }
</a><a href="#h20-0-458" id="h20-0-458" class="d">-        var showResetConfirmationDialog by remember { mutableStateOf(false) }
</a><a href="#h20-0-459" id="h20-0-459" class="d">-
</a><a href="#h20-0-460" id="h20-0-460" class="d">-        if (showResetConfirmationDialog) {
</a><a href="#h20-0-461" id="h20-0-461" class="d">-            Dialog(onDismissRequest = { showResetConfirmationDialog = false }) {
</a><a href="#h20-0-462" id="h20-0-462" class="d">-                alertDialogs.ConfirmDialog(
</a><a href="#h20-0-463" id="h20-0-463" class="d">-                    title = &quot;Reset config&quot;,
</a><a href="#h20-0-464" id="h20-0-464" class="d">-                    message = &quot;Are you sure you want to reset the config?&quot;,
</a><a href="#h20-0-465" id="h20-0-465" class="d">-                    onConfirm = {
</a><a href="#h20-0-466" id="h20-0-466" class="d">-                        context.config.reset()
</a><a href="#h20-0-467" id="h20-0-467" class="d">-                        context.shortToast(&quot;Config successfully reset!&quot;)
</a><a href="#h20-0-468" id="h20-0-468" class="d">-                    },
</a><a href="#h20-0-469" id="h20-0-469" class="d">-                    onDismiss = { showResetConfirmationDialog = false }
</a><a href="#h20-0-470" id="h20-0-470" class="d">-                )
</a><a href="#h20-0-471" id="h20-0-471" class="d">-            }
</a><a href="#h20-0-472" id="h20-0-472" class="d">-        }
</a><a href="#h20-0-473" id="h20-0-473" class="d">-
</a><a href="#h20-0-474" id="h20-0-474" class="d">-        val actions = remember {
</a><a href="#h20-0-475" id="h20-0-475" class="d">-            mapOf(
</a><a href="#h20-0-476" id="h20-0-476" class="d">-                &quot;Export&quot; to {
</a><a href="#h20-0-477" id="h20-0-477" class="d">-                    activityLauncher {
</a><a href="#h20-0-478" id="h20-0-478" class="d">-                        saveFile(&quot;config.json&quot;, &quot;application/json&quot;) { uri -&gt;
</a><a href="#h20-0-479" id="h20-0-479" class="d">-                            context.androidContext.contentResolver.openOutputStream(Uri.parse(uri))?.use {
</a><a href="#h20-0-480" id="h20-0-480" class="d">-                                context.config.writeConfig()
</a><a href="#h20-0-481" id="h20-0-481" class="d">-                                context.config.exportToString().byteInputStream().copyTo(it)
</a><a href="#h20-0-482" id="h20-0-482" class="d">-                                context.shortToast(&quot;Config exported successfully!&quot;)
</a><a href="#h20-0-483" id="h20-0-483" class="d">-                            }
</a><a href="#h20-0-484" id="h20-0-484" class="d">-                        }
</a><a href="#h20-0-485" id="h20-0-485" class="d">-                    }
</a><a href="#h20-0-486" id="h20-0-486" class="d">-                },
</a><a href="#h20-0-487" id="h20-0-487" class="d">-                &quot;Import&quot; to {
</a><a href="#h20-0-488" id="h20-0-488" class="d">-                    activityLauncher {
</a><a href="#h20-0-489" id="h20-0-489" class="d">-                        openFile(&quot;application/json&quot;) { uri -&gt;
</a><a href="#h20-0-490" id="h20-0-490" class="d">-                            context.androidContext.contentResolver.openInputStream(Uri.parse(uri))?.use {
</a><a href="#h20-0-491" id="h20-0-491" class="d">-                                runCatching {
</a><a href="#h20-0-492" id="h20-0-492" class="d">-                                    context.config.loadFromString(it.readBytes().toString(Charsets.UTF_8))
</a><a href="#h20-0-493" id="h20-0-493" class="d">-                                }.onFailure {
</a><a href="#h20-0-494" id="h20-0-494" class="d">-                                    context.longToast(&quot;Failed to import config ${it.message}&quot;)
</a><a href="#h20-0-495" id="h20-0-495" class="d">-                                    return@use
</a><a href="#h20-0-496" id="h20-0-496" class="d">-                                }
</a><a href="#h20-0-497" id="h20-0-497" class="d">-                                context.shortToast(&quot;Config successfully loaded!&quot;)
</a><a href="#h20-0-498" id="h20-0-498" class="d">-                            }
</a><a href="#h20-0-499" id="h20-0-499" class="d">-                        }
</a><a href="#h20-0-500" id="h20-0-500" class="d">-                    }
</a><a href="#h20-0-501" id="h20-0-501" class="d">-                },
</a><a href="#h20-0-502" id="h20-0-502" class="d">-                &quot;Reset&quot; to { showResetConfirmationDialog = true }
</a><a href="#h20-0-503" id="h20-0-503" class="d">-            )
</a><a href="#h20-0-504" id="h20-0-504" class="d">-        }
</a><a href="#h20-0-505" id="h20-0-505" class="d">-
</a><a href="#h20-0-506" id="h20-0-506" class="d">-        IconButton(onClick = { showExportDropdownMenu = !showExportDropdownMenu}) {
</a><a href="#h20-0-507" id="h20-0-507" class="d">-            Icon(
</a><a href="#h20-0-508" id="h20-0-508" class="d">-                imageVector = Icons.Filled.MoreVert,
</a><a href="#h20-0-509" id="h20-0-509" class="d">-                contentDescription = null
</a><a href="#h20-0-510" id="h20-0-510" class="d">-            )
</a><a href="#h20-0-511" id="h20-0-511" class="d">-        }
</a><a href="#h20-0-512" id="h20-0-512" class="d">-
</a><a href="#h20-0-513" id="h20-0-513" class="d">-        if (showExportDropdownMenu) {
</a><a href="#h20-0-514" id="h20-0-514" class="d">-            DropdownMenu(expanded = true, onDismissRequest = { showExportDropdownMenu = false }) {
</a><a href="#h20-0-515" id="h20-0-515" class="d">-                actions.forEach { (name, action) -&gt;
</a><a href="#h20-0-516" id="h20-0-516" class="d">-                    DropdownMenuItem(
</a><a href="#h20-0-517" id="h20-0-517" class="d">-                        text = {
</a><a href="#h20-0-518" id="h20-0-518" class="d">-                            Text(text = name)
</a><a href="#h20-0-519" id="h20-0-519" class="d">-                        },
</a><a href="#h20-0-520" id="h20-0-520" class="d">-                        onClick = {
</a><a href="#h20-0-521" id="h20-0-521" class="d">-                            action()
</a><a href="#h20-0-522" id="h20-0-522" class="d">-                            showExportDropdownMenu = false
</a><a href="#h20-0-523" id="h20-0-523" class="d">-                        }
</a><a href="#h20-0-524" id="h20-0-524" class="d">-                    )
</a><a href="#h20-0-525" id="h20-0-525" class="d">-                }
</a><a href="#h20-0-526" id="h20-0-526" class="d">-            }
</a><a href="#h20-0-527" id="h20-0-527" class="d">-        }
</a><a href="#h20-0-528" id="h20-0-528" class="d">-    }
</a><a href="#h20-0-529" id="h20-0-529" class="d">-
</a><a href="#h20-0-530" id="h20-0-530" class="d">-    @Composable
</a><a href="#h20-0-531" id="h20-0-531" class="d">-    private fun PropertiesView(
</a><a href="#h20-0-532" id="h20-0-532" class="d">-        properties: List&lt;PropertyPair&lt;*&gt;&gt;
</a><a href="#h20-0-533" id="h20-0-533" class="d">-    ) {
</a><a href="#h20-0-534" id="h20-0-534" class="d">-        rememberScaffoldState = rememberBottomSheetScaffoldState()
</a><a href="#h20-0-535" id="h20-0-535" class="d">-        Scaffold(
</a><a href="#h20-0-536" id="h20-0-536" class="d">-            snackbarHost = { SnackbarHost(rememberScaffoldState.snackbarHostState) },
</a><a href="#h20-0-537" id="h20-0-537" class="d">-            modifier = Modifier.fillMaxSize(),
</a><a href="#h20-0-538" id="h20-0-538" class="d">-            content = { innerPadding -&gt;
</a><a href="#h20-0-539" id="h20-0-539" class="d">-                LazyColumn(
</a><a href="#h20-0-540" id="h20-0-540" class="d">-                    modifier = Modifier
</a><a href="#h20-0-541" id="h20-0-541" class="d">-                        .fillMaxHeight()
</a><a href="#h20-0-542" id="h20-0-542" class="d">-                        .padding(innerPadding),
</a><a href="#h20-0-543" id="h20-0-543" class="d">-                    //save button space
</a><a href="#h20-0-544" id="h20-0-544" class="d">-                    contentPadding = PaddingValues(top = 10.dp, bottom = 110.dp),
</a><a href="#h20-0-545" id="h20-0-545" class="d">-                    verticalArrangement = Arrangement.Top
</a><a href="#h20-0-546" id="h20-0-546" class="d">-                ) {
</a><a href="#h20-0-547" id="h20-0-547" class="d">-                    items(properties) {
</a><a href="#h20-0-548" id="h20-0-548" class="d">-                        PropertyCard(it)
</a><a href="#h20-0-549" id="h20-0-549" class="d">-                    }
</a><a href="#h20-0-550" id="h20-0-550" class="d">-                }
</a><a href="#h20-0-551" id="h20-0-551" class="d">-            }
</a><a href="#h20-0-552" id="h20-0-552" class="d">-        )
</a><a href="#h20-0-553" id="h20-0-553" class="d">-    }
</a><a href="#h20-0-554" id="h20-0-554" class="d">-
</a><a href="#h20-0-555" id="h20-0-555" class="d">-    @Composable
</a><a href="#h20-0-556" id="h20-0-556" class="d">-    override fun FloatingActionButton() {
</a><a href="#h20-0-557" id="h20-0-557" class="d">-        val scope = rememberCoroutineScope()
</a><a href="#h20-0-558" id="h20-0-558" class="d">-        FloatingActionButton(
</a><a href="#h20-0-559" id="h20-0-559" class="d">-            onClick = {
</a><a href="#h20-0-560" id="h20-0-560" class="d">-                context.config.writeConfig()
</a><a href="#h20-0-561" id="h20-0-561" class="d">-                scope.launch {
</a><a href="#h20-0-562" id="h20-0-562" class="d">-                    rememberScaffoldState.snackbarHostState.showSnackbar(&quot;Saved&quot;)
</a><a href="#h20-0-563" id="h20-0-563" class="d">-                }
</a><a href="#h20-0-564" id="h20-0-564" class="d">-            },
</a><a href="#h20-0-565" id="h20-0-565" class="d">-            modifier = Modifier.padding(10.dp),
</a><a href="#h20-0-566" id="h20-0-566" class="d">-            containerColor = MaterialTheme.colorScheme.primary,
</a><a href="#h20-0-567" id="h20-0-567" class="d">-            contentColor = MaterialTheme.colorScheme.onPrimary,
</a><a href="#h20-0-568" id="h20-0-568" class="d">-            shape = RoundedCornerShape(16.dp),
</a><a href="#h20-0-569" id="h20-0-569" class="d">-        ) {
</a><a href="#h20-0-570" id="h20-0-570" class="d">-            Icon(
</a><a href="#h20-0-571" id="h20-0-571" class="d">-                imageVector = Icons.Rounded.Save,
</a><a href="#h20-0-572" id="h20-0-572" class="d">-                contentDescription = null
</a><a href="#h20-0-573" id="h20-0-573" class="d">-            )
</a><a href="#h20-0-574" id="h20-0-574" class="d">-        }
</a><a href="#h20-0-575" id="h20-0-575" class="d">-    }
</a><a href="#h20-0-576" id="h20-0-576" class="d">-
</a><a href="#h20-0-577" id="h20-0-577" class="d">-
</a><a href="#h20-0-578" id="h20-0-578" class="d">-    @Composable
</a><a href="#h20-0-579" id="h20-0-579" class="d">-    private fun Container(
</a><a href="#h20-0-580" id="h20-0-580" class="d">-        configContainer: ConfigContainer
</a><a href="#h20-0-581" id="h20-0-581" class="d">-    ) {
</a><a href="#h20-0-582" id="h20-0-582" class="d">-        val properties = remember {
</a><a href="#h20-0-583" id="h20-0-583" class="d">-            configContainer.properties.map { PropertyPair(it.key, it.value) }
</a><a href="#h20-0-584" id="h20-0-584" class="d">-        }
</a><a href="#h20-0-585" id="h20-0-585" class="d">-
</a><a href="#h20-0-586" id="h20-0-586" class="d">-        PropertiesView(properties)
</a><a href="#h20-0-587" id="h20-0-587" class="d">-    }
</a><a href="#h20-0-588" id="h20-0-588" class="d">-}</a><a href="#h20-0-589" id="h20-0-589" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h21" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/features/PickLocation.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/features/PickLocation.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/features/PickLocation.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/features/PickLocation.kt</a></b>
<a href="#h21-0" id="h21-0" class="h">@@ -1,4 +0,0 @@
</a><a href="#h21-0-0" id="h21-0-0" class="d">-package me.rhunk.snapenhance.ui.manager.sections.features
</a><a href="#h21-0-1" id="h21-0-1" class="d">-
</a><a href="#h21-0-2" id="h21-0-2" class="d">-class PickLocation {
</a><a href="#h21-0-3" id="h21-0-3" class="d">-}</a><a href="#h21-0-4" id="h21-0-4" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h22" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/home/HomeSection.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/home/HomeSection.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/home/HomeSection.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/home/HomeSection.kt</a></b>
<a href="#h22-0" id="h22-0" class="h">@@ -1,318 +0,0 @@
</a><a href="#h22-0-0" id="h22-0-0" class="d">-package me.rhunk.snapenhance.ui.manager.sections.home
</a><a href="#h22-0-1" id="h22-0-1" class="d">-
</a><a href="#h22-0-2" id="h22-0-2" class="d">-import android.content.Intent
</a><a href="#h22-0-3" id="h22-0-3" class="d">-import android.net.Uri
</a><a href="#h22-0-4" id="h22-0-4" class="d">-import androidx.compose.foundation.Image
</a><a href="#h22-0-5" id="h22-0-5" class="d">-import androidx.compose.foundation.ScrollState
</a><a href="#h22-0-6" id="h22-0-6" class="d">-import androidx.compose.foundation.clickable
</a><a href="#h22-0-7" id="h22-0-7" class="d">-import androidx.compose.foundation.layout.*
</a><a href="#h22-0-8" id="h22-0-8" class="d">-import androidx.compose.foundation.verticalScroll
</a><a href="#h22-0-9" id="h22-0-9" class="d">-import androidx.compose.material.icons.Icons
</a><a href="#h22-0-10" id="h22-0-10" class="d">-import androidx.compose.material.icons.filled.BugReport
</a><a href="#h22-0-11" id="h22-0-11" class="d">-import androidx.compose.material.icons.filled.Settings
</a><a href="#h22-0-12" id="h22-0-12" class="d">-import androidx.compose.material3.*
</a><a href="#h22-0-13" id="h22-0-13" class="d">-import androidx.compose.runtime.Composable
</a><a href="#h22-0-14" id="h22-0-14" class="d">-import androidx.compose.runtime.remember
</a><a href="#h22-0-15" id="h22-0-15" class="d">-import androidx.compose.ui.Alignment
</a><a href="#h22-0-16" id="h22-0-16" class="d">-import androidx.compose.ui.Modifier
</a><a href="#h22-0-17" id="h22-0-17" class="d">-import androidx.compose.ui.draw.scale
</a><a href="#h22-0-18" id="h22-0-18" class="d">-import androidx.compose.ui.graphics.ColorFilter
</a><a href="#h22-0-19" id="h22-0-19" class="d">-import androidx.compose.ui.graphics.vector.ImageVector
</a><a href="#h22-0-20" id="h22-0-20" class="d">-import androidx.compose.ui.layout.ContentScale
</a><a href="#h22-0-21" id="h22-0-21" class="d">-import androidx.compose.ui.res.painterResource
</a><a href="#h22-0-22" id="h22-0-22" class="d">-import androidx.compose.ui.res.vectorResource
</a><a href="#h22-0-23" id="h22-0-23" class="d">-import androidx.compose.ui.text.font.Font
</a><a href="#h22-0-24" id="h22-0-24" class="d">-import androidx.compose.ui.text.font.FontFamily
</a><a href="#h22-0-25" id="h22-0-25" class="d">-import androidx.compose.ui.text.font.FontWeight
</a><a href="#h22-0-26" id="h22-0-26" class="d">-import androidx.compose.ui.text.style.TextAlign
</a><a href="#h22-0-27" id="h22-0-27" class="d">-import androidx.compose.ui.tooling.preview.Preview
</a><a href="#h22-0-28" id="h22-0-28" class="d">-import androidx.compose.ui.unit.dp
</a><a href="#h22-0-29" id="h22-0-29" class="d">-import androidx.compose.ui.unit.sp
</a><a href="#h22-0-30" id="h22-0-30" class="d">-import androidx.navigation.NavGraphBuilder
</a><a href="#h22-0-31" id="h22-0-31" class="d">-import androidx.navigation.compose.composable
</a><a href="#h22-0-32" id="h22-0-32" class="d">-import androidx.navigation.navigation
</a><a href="#h22-0-33" id="h22-0-33" class="d">-import kotlinx.coroutines.launch
</a><a href="#h22-0-34" id="h22-0-34" class="d">-import me.rhunk.snapenhance.R
</a><a href="#h22-0-35" id="h22-0-35" class="d">-import me.rhunk.snapenhance.common.BuildConfig
</a><a href="#h22-0-36" id="h22-0-36" class="d">-import me.rhunk.snapenhance.ui.manager.Section
</a><a href="#h22-0-37" id="h22-0-37" class="d">-import me.rhunk.snapenhance.ui.manager.data.InstallationSummary
</a><a href="#h22-0-38" id="h22-0-38" class="d">-import me.rhunk.snapenhance.ui.manager.data.Updater
</a><a href="#h22-0-39" id="h22-0-39" class="d">-import me.rhunk.snapenhance.ui.util.ActivityLauncherHelper
</a><a href="#h22-0-40" id="h22-0-40" class="d">-import java.util.Locale
</a><a href="#h22-0-41" id="h22-0-41" class="d">-
</a><a href="#h22-0-42" id="h22-0-42" class="d">-class HomeSection : Section() {
</a><a href="#h22-0-43" id="h22-0-43" class="d">-    companion object {
</a><a href="#h22-0-44" id="h22-0-44" class="d">-        val cardMargin = 10.dp
</a><a href="#h22-0-45" id="h22-0-45" class="d">-        const val HOME_ROOT = &quot;home_root&quot;
</a><a href="#h22-0-46" id="h22-0-46" class="d">-        const val LOGS_SECTION_ROUTE = &quot;home_logs&quot;
</a><a href="#h22-0-47" id="h22-0-47" class="d">-        const val SETTINGS_SECTION_ROUTE = &quot;home_settings&quot;
</a><a href="#h22-0-48" id="h22-0-48" class="d">-    }
</a><a href="#h22-0-49" id="h22-0-49" class="d">-
</a><a href="#h22-0-50" id="h22-0-50" class="d">-    private var installationSummary: InstallationSummary? = null
</a><a href="#h22-0-51" id="h22-0-51" class="d">-    private var userLocale: String? = null
</a><a href="#h22-0-52" id="h22-0-52" class="d">-    private val homeSubSection by lazy { HomeSubSection(context) }
</a><a href="#h22-0-53" id="h22-0-53" class="d">-    private var latestUpdate: Updater.LatestRelease? = null
</a><a href="#h22-0-54" id="h22-0-54" class="d">-    private lateinit var activityLauncherHelper: ActivityLauncherHelper
</a><a href="#h22-0-55" id="h22-0-55" class="d">-
</a><a href="#h22-0-56" id="h22-0-56" class="d">-    override fun init() {
</a><a href="#h22-0-57" id="h22-0-57" class="d">-        activityLauncherHelper = ActivityLauncherHelper(context.activity!!)
</a><a href="#h22-0-58" id="h22-0-58" class="d">-    }
</a><a href="#h22-0-59" id="h22-0-59" class="d">-
</a><a href="#h22-0-60" id="h22-0-60" class="d">-    @Composable
</a><a href="#h22-0-61" id="h22-0-61" class="d">-    private fun SummaryCards(installationSummary: InstallationSummary) {
</a><a href="#h22-0-62" id="h22-0-62" class="d">-        val summaryInfo = remember {
</a><a href="#h22-0-63" id="h22-0-63" class="d">-            mapOf(
</a><a href="#h22-0-64" id="h22-0-64" class="d">-                &quot;Build Issuer&quot; to (installationSummary.modInfo?.buildIssuer ?: &quot;Unknown&quot;),
</a><a href="#h22-0-65" id="h22-0-65" class="d">-                &quot;Build Type&quot; to (if (installationSummary.modInfo?.isDebugBuild == true) &quot;debug&quot; else &quot;release&quot;),
</a><a href="#h22-0-66" id="h22-0-66" class="d">-                &quot;Build Version&quot; to (installationSummary.modInfo?.buildVersion ?: &quot;Unknown&quot;),
</a><a href="#h22-0-67" id="h22-0-67" class="d">-                &quot;Build Package&quot; to (installationSummary.modInfo?.buildPackageName ?: &quot;Unknown&quot;),
</a><a href="#h22-0-68" id="h22-0-68" class="d">-                &quot;Activity Package&quot; to (installationSummary.modInfo?.loaderPackageName ?: &quot;Unknown&quot;),
</a><a href="#h22-0-69" id="h22-0-69" class="d">-                &quot;Device&quot; to installationSummary.platformInfo.device,
</a><a href="#h22-0-70" id="h22-0-70" class="d">-                &quot;Android Version&quot; to installationSummary.platformInfo.androidVersion,
</a><a href="#h22-0-71" id="h22-0-71" class="d">-                &quot;System ABI&quot; to installationSummary.platformInfo.systemAbi
</a><a href="#h22-0-72" id="h22-0-72" class="d">-            )
</a><a href="#h22-0-73" id="h22-0-73" class="d">-        }
</a><a href="#h22-0-74" id="h22-0-74" class="d">-
</a><a href="#h22-0-75" id="h22-0-75" class="d">-        Card(
</a><a href="#h22-0-76" id="h22-0-76" class="d">-            modifier = Modifier
</a><a href="#h22-0-77" id="h22-0-77" class="d">-                .padding(all = cardMargin)
</a><a href="#h22-0-78" id="h22-0-78" class="d">-                .fillMaxWidth(),
</a><a href="#h22-0-79" id="h22-0-79" class="d">-            colors = CardDefaults.cardColors(
</a><a href="#h22-0-80" id="h22-0-80" class="d">-                containerColor = MaterialTheme.colorScheme.surfaceVariant,
</a><a href="#h22-0-81" id="h22-0-81" class="d">-                contentColor = MaterialTheme.colorScheme.onSurfaceVariant
</a><a href="#h22-0-82" id="h22-0-82" class="d">-            )
</a><a href="#h22-0-83" id="h22-0-83" class="d">-        ) {
</a><a href="#h22-0-84" id="h22-0-84" class="d">-            Column(
</a><a href="#h22-0-85" id="h22-0-85" class="d">-                modifier = Modifier
</a><a href="#h22-0-86" id="h22-0-86" class="d">-                    .fillMaxWidth()
</a><a href="#h22-0-87" id="h22-0-87" class="d">-                    .padding(all = 10.dp),
</a><a href="#h22-0-88" id="h22-0-88" class="d">-            ) {
</a><a href="#h22-0-89" id="h22-0-89" class="d">-                summaryInfo.forEach { (title, value) -&gt;
</a><a href="#h22-0-90" id="h22-0-90" class="d">-                    Column(
</a><a href="#h22-0-91" id="h22-0-91" class="d">-                        modifier = Modifier
</a><a href="#h22-0-92" id="h22-0-92" class="d">-                            .fillMaxWidth()
</a><a href="#h22-0-93" id="h22-0-93" class="d">-                            .padding(all = 5.dp),
</a><a href="#h22-0-94" id="h22-0-94" class="d">-                    ) {
</a><a href="#h22-0-95" id="h22-0-95" class="d">-                        Text(
</a><a href="#h22-0-96" id="h22-0-96" class="d">-                            text = title,
</a><a href="#h22-0-97" id="h22-0-97" class="d">-                            fontSize = 12.sp,
</a><a href="#h22-0-98" id="h22-0-98" class="d">-                            fontWeight = FontWeight.Light,
</a><a href="#h22-0-99" id="h22-0-99" class="d">-                        )
</a><a href="#h22-0-100" id="h22-0-100" class="d">-                        Text(
</a><a href="#h22-0-101" id="h22-0-101" class="d">-                            fontSize = 14.sp,
</a><a href="#h22-0-102" id="h22-0-102" class="d">-                            text = value,
</a><a href="#h22-0-103" id="h22-0-103" class="d">-                            lineHeight = 20.sp
</a><a href="#h22-0-104" id="h22-0-104" class="d">-                        )
</a><a href="#h22-0-105" id="h22-0-105" class="d">-                    }
</a><a href="#h22-0-106" id="h22-0-106" class="d">-                }
</a><a href="#h22-0-107" id="h22-0-107" class="d">-            }
</a><a href="#h22-0-108" id="h22-0-108" class="d">-        }
</a><a href="#h22-0-109" id="h22-0-109" class="d">-    }
</a><a href="#h22-0-110" id="h22-0-110" class="d">-
</a><a href="#h22-0-111" id="h22-0-111" class="d">-    override fun onResumed() {
</a><a href="#h22-0-112" id="h22-0-112" class="d">-        if (!context.mappings.isMappingsLoaded) {
</a><a href="#h22-0-113" id="h22-0-113" class="d">-            context.mappings.init(context.androidContext)
</a><a href="#h22-0-114" id="h22-0-114" class="d">-        }
</a><a href="#h22-0-115" id="h22-0-115" class="d">-        context.coroutineScope.launch {
</a><a href="#h22-0-116" id="h22-0-116" class="d">-            userLocale = context.translation.loadedLocale.getDisplayName(Locale.getDefault())
</a><a href="#h22-0-117" id="h22-0-117" class="d">-            runCatching {
</a><a href="#h22-0-118" id="h22-0-118" class="d">-                installationSummary = context.installationSummary
</a><a href="#h22-0-119" id="h22-0-119" class="d">-            }.onFailure {
</a><a href="#h22-0-120" id="h22-0-120" class="d">-                context.longToast(&quot;SnapEnhance failed to load installation summary: ${it.message}&quot;)
</a><a href="#h22-0-121" id="h22-0-121" class="d">-            }
</a><a href="#h22-0-122" id="h22-0-122" class="d">-            runCatching {
</a><a href="#h22-0-123" id="h22-0-123" class="d">-                if (!BuildConfig.DEBUG) {
</a><a href="#h22-0-124" id="h22-0-124" class="d">-                    latestUpdate = Updater.checkForLatestRelease()
</a><a href="#h22-0-125" id="h22-0-125" class="d">-                }
</a><a href="#h22-0-126" id="h22-0-126" class="d">-            }.onFailure {
</a><a href="#h22-0-127" id="h22-0-127" class="d">-                context.longToast(&quot;SnapEnhance failed to check for updates: ${it.message}&quot;)
</a><a href="#h22-0-128" id="h22-0-128" class="d">-            }
</a><a href="#h22-0-129" id="h22-0-129" class="d">-        }
</a><a href="#h22-0-130" id="h22-0-130" class="d">-    }
</a><a href="#h22-0-131" id="h22-0-131" class="d">-
</a><a href="#h22-0-132" id="h22-0-132" class="d">-    override fun sectionTopBarName(): String {
</a><a href="#h22-0-133" id="h22-0-133" class="d">-        if (currentRoute == HOME_ROOT) {
</a><a href="#h22-0-134" id="h22-0-134" class="d">-            return &quot;&quot;
</a><a href="#h22-0-135" id="h22-0-135" class="d">-        }
</a><a href="#h22-0-136" id="h22-0-136" class="d">-        return context.translation[&quot;manager.routes.$currentRoute&quot;]
</a><a href="#h22-0-137" id="h22-0-137" class="d">-    }
</a><a href="#h22-0-138" id="h22-0-138" class="d">-
</a><a href="#h22-0-139" id="h22-0-139" class="d">-    @Composable
</a><a href="#h22-0-140" id="h22-0-140" class="d">-    override fun FloatingActionButton() {
</a><a href="#h22-0-141" id="h22-0-141" class="d">-        if (currentRoute == LOGS_SECTION_ROUTE) {
</a><a href="#h22-0-142" id="h22-0-142" class="d">-            homeSubSection.LogsActionButtons()
</a><a href="#h22-0-143" id="h22-0-143" class="d">-        }
</a><a href="#h22-0-144" id="h22-0-144" class="d">-    }
</a><a href="#h22-0-145" id="h22-0-145" class="d">-
</a><a href="#h22-0-146" id="h22-0-146" class="d">-    @Composable
</a><a href="#h22-0-147" id="h22-0-147" class="d">-    override fun TopBarActions(rowScope: RowScope) {
</a><a href="#h22-0-148" id="h22-0-148" class="d">-        rowScope.apply {
</a><a href="#h22-0-149" id="h22-0-149" class="d">-            when (currentRoute) {
</a><a href="#h22-0-150" id="h22-0-150" class="d">-                HOME_ROOT -&gt; {
</a><a href="#h22-0-151" id="h22-0-151" class="d">-                    IconButton(onClick = {
</a><a href="#h22-0-152" id="h22-0-152" class="d">-                        navController.navigate(LOGS_SECTION_ROUTE)
</a><a href="#h22-0-153" id="h22-0-153" class="d">-                    }) {
</a><a href="#h22-0-154" id="h22-0-154" class="d">-                        Icon(Icons.Filled.BugReport, contentDescription = null)
</a><a href="#h22-0-155" id="h22-0-155" class="d">-                    }
</a><a href="#h22-0-156" id="h22-0-156" class="d">-                    IconButton(onClick = {
</a><a href="#h22-0-157" id="h22-0-157" class="d">-                        navController.navigate(SETTINGS_SECTION_ROUTE)
</a><a href="#h22-0-158" id="h22-0-158" class="d">-                    }) {
</a><a href="#h22-0-159" id="h22-0-159" class="d">-                        Icon(Icons.Filled.Settings, contentDescription = null)
</a><a href="#h22-0-160" id="h22-0-160" class="d">-                    }
</a><a href="#h22-0-161" id="h22-0-161" class="d">-                }
</a><a href="#h22-0-162" id="h22-0-162" class="d">-                LOGS_SECTION_ROUTE -&gt; {
</a><a href="#h22-0-163" id="h22-0-163" class="d">-                    homeSubSection.LogsTopBarButtons(activityLauncherHelper, navController, this)
</a><a href="#h22-0-164" id="h22-0-164" class="d">-                }
</a><a href="#h22-0-165" id="h22-0-165" class="d">-            }
</a><a href="#h22-0-166" id="h22-0-166" class="d">-        }
</a><a href="#h22-0-167" id="h22-0-167" class="d">-    }
</a><a href="#h22-0-168" id="h22-0-168" class="d">-
</a><a href="#h22-0-169" id="h22-0-169" class="d">-    override fun build(navGraphBuilder: NavGraphBuilder) {
</a><a href="#h22-0-170" id="h22-0-170" class="d">-        navGraphBuilder.navigation(
</a><a href="#h22-0-171" id="h22-0-171" class="d">-            route = enumSection.route,
</a><a href="#h22-0-172" id="h22-0-172" class="d">-            startDestination = HOME_ROOT
</a><a href="#h22-0-173" id="h22-0-173" class="d">-        ) {
</a><a href="#h22-0-174" id="h22-0-174" class="d">-            composable(HOME_ROOT) {
</a><a href="#h22-0-175" id="h22-0-175" class="d">-                Content()
</a><a href="#h22-0-176" id="h22-0-176" class="d">-            }
</a><a href="#h22-0-177" id="h22-0-177" class="d">-            composable(LOGS_SECTION_ROUTE) {
</a><a href="#h22-0-178" id="h22-0-178" class="d">-                homeSubSection.LogsSection()
</a><a href="#h22-0-179" id="h22-0-179" class="d">-            }
</a><a href="#h22-0-180" id="h22-0-180" class="d">-            composable(SETTINGS_SECTION_ROUTE) {
</a><a href="#h22-0-181" id="h22-0-181" class="d">-                SettingsSection(activityLauncherHelper).also { it.context = context }.Content()
</a><a href="#h22-0-182" id="h22-0-182" class="d">-            }
</a><a href="#h22-0-183" id="h22-0-183" class="d">-        }
</a><a href="#h22-0-184" id="h22-0-184" class="d">-    }
</a><a href="#h22-0-185" id="h22-0-185" class="d">-
</a><a href="#h22-0-186" id="h22-0-186" class="d">-
</a><a href="#h22-0-187" id="h22-0-187" class="d">-    @Composable
</a><a href="#h22-0-188" id="h22-0-188" class="d">-    @Preview
</a><a href="#h22-0-189" id="h22-0-189" class="d">-    override fun Content() {
</a><a href="#h22-0-190" id="h22-0-190" class="d">-        val avenirNextFontFamily = remember {
</a><a href="#h22-0-191" id="h22-0-191" class="d">-            FontFamily(
</a><a href="#h22-0-192" id="h22-0-192" class="d">-                Font(R.font.avenir_next_medium, FontWeight.Medium)
</a><a href="#h22-0-193" id="h22-0-193" class="d">-            )
</a><a href="#h22-0-194" id="h22-0-194" class="d">-        }
</a><a href="#h22-0-195" id="h22-0-195" class="d">-
</a><a href="#h22-0-196" id="h22-0-196" class="d">-        Column(
</a><a href="#h22-0-197" id="h22-0-197" class="d">-            modifier = Modifier
</a><a href="#h22-0-198" id="h22-0-198" class="d">-                .verticalScroll(ScrollState(0))
</a><a href="#h22-0-199" id="h22-0-199" class="d">-        ) {
</a><a href="#h22-0-200" id="h22-0-200" class="d">-
</a><a href="#h22-0-201" id="h22-0-201" class="d">-            Image(
</a><a href="#h22-0-202" id="h22-0-202" class="d">-                painter = painterResource(id = R.drawable.launcher_icon_monochrome),
</a><a href="#h22-0-203" id="h22-0-203" class="d">-                contentDescription = null,
</a><a href="#h22-0-204" id="h22-0-204" class="d">-                colorFilter = ColorFilter.tint(MaterialTheme.colorScheme.primary),
</a><a href="#h22-0-205" id="h22-0-205" class="d">-                contentScale = ContentScale.FillHeight,
</a><a href="#h22-0-206" id="h22-0-206" class="d">-                modifier = Modifier
</a><a href="#h22-0-207" id="h22-0-207" class="d">-                    .fillMaxWidth()
</a><a href="#h22-0-208" id="h22-0-208" class="d">-                    .scale(1.8f)
</a><a href="#h22-0-209" id="h22-0-209" class="d">-                    .height(90.dp)
</a><a href="#h22-0-210" id="h22-0-210" class="d">-            )
</a><a href="#h22-0-211" id="h22-0-211" class="d">-
</a><a href="#h22-0-212" id="h22-0-212" class="d">-            Text(
</a><a href="#h22-0-213" id="h22-0-213" class="d">-                text = remember { intArrayOf(101,99,110,97,104,110,69,112,97,110,83).map { it.toChar() }.joinToString(&quot;&quot;).reversed() },
</a><a href="#h22-0-214" id="h22-0-214" class="d">-                fontSize = 30.sp,
</a><a href="#h22-0-215" id="h22-0-215" class="d">-                fontFamily = avenirNextFontFamily,
</a><a href="#h22-0-216" id="h22-0-216" class="d">-                modifier = Modifier.align(Alignment.CenterHorizontally),
</a><a href="#h22-0-217" id="h22-0-217" class="d">-            )
</a><a href="#h22-0-218" id="h22-0-218" class="d">-
</a><a href="#h22-0-219" id="h22-0-219" class="d">-            Text(
</a><a href="#h22-0-220" id="h22-0-220" class="d">-                text = &quot;v&quot; + BuildConfig.VERSION_NAME + &quot; \u00b7 by rhunk&quot;,
</a><a href="#h22-0-221" id="h22-0-221" class="d">-                fontSize = 12.sp,
</a><a href="#h22-0-222" id="h22-0-222" class="d">-                fontFamily = avenirNextFontFamily,
</a><a href="#h22-0-223" id="h22-0-223" class="d">-                modifier = Modifier.align(Alignment.CenterHorizontally),
</a><a href="#h22-0-224" id="h22-0-224" class="d">-            )
</a><a href="#h22-0-225" id="h22-0-225" class="d">-
</a><a href="#h22-0-226" id="h22-0-226" class="d">-            Text(
</a><a href="#h22-0-227" id="h22-0-227" class="d">-                text = &quot;An xposed module made to enhance your Snapchat experience&quot;,
</a><a href="#h22-0-228" id="h22-0-228" class="d">-                modifier = Modifier
</a><a href="#h22-0-229" id="h22-0-229" class="d">-                    .padding(16.dp)
</a><a href="#h22-0-230" id="h22-0-230" class="d">-                    .fillMaxWidth(),
</a><a href="#h22-0-231" id="h22-0-231" class="d">-                textAlign = TextAlign.Center,
</a><a href="#h22-0-232" id="h22-0-232" class="d">-            )
</a><a href="#h22-0-233" id="h22-0-233" class="d">-
</a><a href="#h22-0-234" id="h22-0-234" class="d">-            Row(
</a><a href="#h22-0-235" id="h22-0-235" class="d">-                horizontalArrangement = Arrangement.spacedBy(15.dp, Alignment.CenterHorizontally),
</a><a href="#h22-0-236" id="h22-0-236" class="d">-                modifier = Modifier
</a><a href="#h22-0-237" id="h22-0-237" class="d">-                    .fillMaxWidth()
</a><a href="#h22-0-238" id="h22-0-238" class="d">-                    .padding(all = 10.dp)
</a><a href="#h22-0-239" id="h22-0-239" class="d">-            ) {
</a><a href="#h22-0-240" id="h22-0-240" class="d">-                Icon(
</a><a href="#h22-0-241" id="h22-0-241" class="d">-                    imageVector = ImageVector.vectorResource(id = R.drawable.ic_github),
</a><a href="#h22-0-242" id="h22-0-242" class="d">-                    contentDescription = null,
</a><a href="#h22-0-243" id="h22-0-243" class="d">-                    tint = MaterialTheme.colorScheme.onSurfaceVariant,
</a><a href="#h22-0-244" id="h22-0-244" class="d">-                    modifier = Modifier.size(32.dp).clickable {
</a><a href="#h22-0-245" id="h22-0-245" class="d">-                        context.activity?.startActivity(
</a><a href="#h22-0-246" id="h22-0-246" class="d">-                            Intent(Intent.ACTION_VIEW).apply {
</a><a href="#h22-0-247" id="h22-0-247" class="d">-                                data = Uri.parse(
</a><a href="#h22-0-248" id="h22-0-248" class="d">-                                    intArrayOf(101,99,110,97,104,110,69,112,97,110,83,47,107,110,117,104,114,47,109,111,99,46,98,117,104,116,105,103,47,47,58,115,112,116,116,104).map { it.toChar() }.joinToString(&quot;&quot;).reversed()
</a><a href="#h22-0-249" id="h22-0-249" class="d">-                                )
</a><a href="#h22-0-250" id="h22-0-250" class="d">-                                flags = Intent.FLAG_ACTIVITY_NEW_TASK
</a><a href="#h22-0-251" id="h22-0-251" class="d">-                            }
</a><a href="#h22-0-252" id="h22-0-252" class="d">-                        )
</a><a href="#h22-0-253" id="h22-0-253" class="d">-                    }
</a><a href="#h22-0-254" id="h22-0-254" class="d">-                )
</a><a href="#h22-0-255" id="h22-0-255" class="d">-                Icon(
</a><a href="#h22-0-256" id="h22-0-256" class="d">-                    imageVector = ImageVector.vectorResource(id = R.drawable.ic_telegram),
</a><a href="#h22-0-257" id="h22-0-257" class="d">-                    contentDescription = null,
</a><a href="#h22-0-258" id="h22-0-258" class="d">-                    tint = MaterialTheme.colorScheme.onSurfaceVariant,
</a><a href="#h22-0-259" id="h22-0-259" class="d">-                    modifier = Modifier.size(32.dp).clickable {
</a><a href="#h22-0-260" id="h22-0-260" class="d">-                        context.activity?.startActivity(
</a><a href="#h22-0-261" id="h22-0-261" class="d">-                            Intent(Intent.ACTION_VIEW).apply {
</a><a href="#h22-0-262" id="h22-0-262" class="d">-                                data = Uri.parse(
</a><a href="#h22-0-263" id="h22-0-263" class="d">-                                    intArrayOf(101,99,110,97,104,110,101,112,97,110,115,47,101,109,46,116,47,47,58,115,112,116,116,104).map { it.toChar() }.joinToString(&quot;&quot;).reversed()
</a><a href="#h22-0-264" id="h22-0-264" class="d">-                                )
</a><a href="#h22-0-265" id="h22-0-265" class="d">-                                flags = Intent.FLAG_ACTIVITY_NEW_TASK
</a><a href="#h22-0-266" id="h22-0-266" class="d">-                            }
</a><a href="#h22-0-267" id="h22-0-267" class="d">-                        )
</a><a href="#h22-0-268" id="h22-0-268" class="d">-                    }
</a><a href="#h22-0-269" id="h22-0-269" class="d">-                )
</a><a href="#h22-0-270" id="h22-0-270" class="d">-            }
</a><a href="#h22-0-271" id="h22-0-271" class="d">-            Spacer(modifier = Modifier.height(20.dp))
</a><a href="#h22-0-272" id="h22-0-272" class="d">-
</a><a href="#h22-0-273" id="h22-0-273" class="d">-            if (latestUpdate != null) {
</a><a href="#h22-0-274" id="h22-0-274" class="d">-                OutlinedCard(
</a><a href="#h22-0-275" id="h22-0-275" class="d">-                    modifier = Modifier
</a><a href="#h22-0-276" id="h22-0-276" class="d">-                        .padding(all = cardMargin)
</a><a href="#h22-0-277" id="h22-0-277" class="d">-                        .fillMaxWidth(),
</a><a href="#h22-0-278" id="h22-0-278" class="d">-                    colors = CardDefaults.cardColors(
</a><a href="#h22-0-279" id="h22-0-279" class="d">-                        containerColor = MaterialTheme.colorScheme.surfaceVariant,
</a><a href="#h22-0-280" id="h22-0-280" class="d">-                        contentColor = MaterialTheme.colorScheme.onSurfaceVariant
</a><a href="#h22-0-281" id="h22-0-281" class="d">-                    )
</a><a href="#h22-0-282" id="h22-0-282" class="d">-                ){
</a><a href="#h22-0-283" id="h22-0-283" class="d">-                    Row(
</a><a href="#h22-0-284" id="h22-0-284" class="d">-                        modifier = Modifier
</a><a href="#h22-0-285" id="h22-0-285" class="d">-                            .fillMaxWidth()
</a><a href="#h22-0-286" id="h22-0-286" class="d">-                            .padding(all = 15.dp),
</a><a href="#h22-0-287" id="h22-0-287" class="d">-                        horizontalArrangement = Arrangement.SpaceBetween
</a><a href="#h22-0-288" id="h22-0-288" class="d">-                    ) {
</a><a href="#h22-0-289" id="h22-0-289" class="d">-                        Column {
</a><a href="#h22-0-290" id="h22-0-290" class="d">-                            Text(
</a><a href="#h22-0-291" id="h22-0-291" class="d">-                                text = &quot;SnapEnhance Update&quot;,
</a><a href="#h22-0-292" id="h22-0-292" class="d">-                                fontSize = 14.sp,
</a><a href="#h22-0-293" id="h22-0-293" class="d">-                                fontWeight = FontWeight.Bold,
</a><a href="#h22-0-294" id="h22-0-294" class="d">-                            )
</a><a href="#h22-0-295" id="h22-0-295" class="d">-                            Text(
</a><a href="#h22-0-296" id="h22-0-296" class="d">-                                fontSize = 12.sp,
</a><a href="#h22-0-297" id="h22-0-297" class="d">-                                text = &quot;Version ${latestUpdate?.versionName} is available!&quot;,
</a><a href="#h22-0-298" id="h22-0-298" class="d">-                                lineHeight = 20.sp
</a><a href="#h22-0-299" id="h22-0-299" class="d">-                            )
</a><a href="#h22-0-300" id="h22-0-300" class="d">-                        }
</a><a href="#h22-0-301" id="h22-0-301" class="d">-                        Button(onClick = {
</a><a href="#h22-0-302" id="h22-0-302" class="d">-                            context.activity?.startActivity(
</a><a href="#h22-0-303" id="h22-0-303" class="d">-                                Intent(Intent.ACTION_VIEW).apply {
</a><a href="#h22-0-304" id="h22-0-304" class="d">-                                    data = Uri.parse(latestUpdate?.releaseUrl)
</a><a href="#h22-0-305" id="h22-0-305" class="d">-                                }
</a><a href="#h22-0-306" id="h22-0-306" class="d">-                            )
</a><a href="#h22-0-307" id="h22-0-307" class="d">-                        }, modifier = Modifier.height(40.dp)) {
</a><a href="#h22-0-308" id="h22-0-308" class="d">-                            Text(text = &quot;Download&quot;)
</a><a href="#h22-0-309" id="h22-0-309" class="d">-                        }
</a><a href="#h22-0-310" id="h22-0-310" class="d">-                    }
</a><a href="#h22-0-311" id="h22-0-311" class="d">-                }
</a><a href="#h22-0-312" id="h22-0-312" class="d">-            }
</a><a href="#h22-0-313" id="h22-0-313" class="d">-
</a><a href="#h22-0-314" id="h22-0-314" class="d">-            SummaryCards(installationSummary = installationSummary ?: return)
</a><a href="#h22-0-315" id="h22-0-315" class="d">-        }
</a><a href="#h22-0-316" id="h22-0-316" class="d">-    }
</a><a href="#h22-0-317" id="h22-0-317" class="d">-}</a><a href="#h22-0-318" id="h22-0-318" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h23" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/home/HomeSubSection.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/home/HomeSubSection.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/home/HomeSubSection.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/home/HomeSubSection.kt</a></b>
<a href="#h23-0" id="h23-0" class="h">@@ -1,254 +0,0 @@
</a><a href="#h23-0-0" id="h23-0-0" class="d">-package me.rhunk.snapenhance.ui.manager.sections.home
</a><a href="#h23-0-1" id="h23-0-1" class="d">-
</a><a href="#h23-0-2" id="h23-0-2" class="d">-import android.net.Uri
</a><a href="#h23-0-3" id="h23-0-3" class="d">-import androidx.compose.foundation.ScrollState
</a><a href="#h23-0-4" id="h23-0-4" class="d">-import androidx.compose.foundation.background
</a><a href="#h23-0-5" id="h23-0-5" class="d">-import androidx.compose.foundation.gestures.detectTapGestures
</a><a href="#h23-0-6" id="h23-0-6" class="d">-import androidx.compose.foundation.horizontalScroll
</a><a href="#h23-0-7" id="h23-0-7" class="d">-import androidx.compose.foundation.layout.*
</a><a href="#h23-0-8" id="h23-0-8" class="d">-import androidx.compose.foundation.lazy.LazyColumn
</a><a href="#h23-0-9" id="h23-0-9" class="d">-import androidx.compose.foundation.lazy.LazyListState
</a><a href="#h23-0-10" id="h23-0-10" class="d">-import androidx.compose.material.icons.Icons
</a><a href="#h23-0-11" id="h23-0-11" class="d">-import androidx.compose.material.icons.filled.KeyboardDoubleArrowDown
</a><a href="#h23-0-12" id="h23-0-12" class="d">-import androidx.compose.material.icons.filled.KeyboardDoubleArrowUp
</a><a href="#h23-0-13" id="h23-0-13" class="d">-import androidx.compose.material.icons.filled.MoreVert
</a><a href="#h23-0-14" id="h23-0-14" class="d">-import androidx.compose.material.icons.outlined.BugReport
</a><a href="#h23-0-15" id="h23-0-15" class="d">-import androidx.compose.material.icons.outlined.Info
</a><a href="#h23-0-16" id="h23-0-16" class="d">-import androidx.compose.material.icons.outlined.Report
</a><a href="#h23-0-17" id="h23-0-17" class="d">-import androidx.compose.material.icons.outlined.Warning
</a><a href="#h23-0-18" id="h23-0-18" class="d">-import androidx.compose.material3.*
</a><a href="#h23-0-19" id="h23-0-19" class="d">-import androidx.compose.runtime.*
</a><a href="#h23-0-20" id="h23-0-20" class="d">-import androidx.compose.ui.Alignment
</a><a href="#h23-0-21" id="h23-0-21" class="d">-import androidx.compose.ui.Modifier
</a><a href="#h23-0-22" id="h23-0-22" class="d">-import androidx.compose.ui.input.pointer.pointerInput
</a><a href="#h23-0-23" id="h23-0-23" class="d">-import androidx.compose.ui.platform.LocalClipboardManager
</a><a href="#h23-0-24" id="h23-0-24" class="d">-import androidx.compose.ui.text.AnnotatedString
</a><a href="#h23-0-25" id="h23-0-25" class="d">-import androidx.compose.ui.text.font.FontWeight
</a><a href="#h23-0-26" id="h23-0-26" class="d">-import androidx.compose.ui.text.style.TextOverflow
</a><a href="#h23-0-27" id="h23-0-27" class="d">-import androidx.compose.ui.unit.dp
</a><a href="#h23-0-28" id="h23-0-28" class="d">-import androidx.compose.ui.unit.sp
</a><a href="#h23-0-29" id="h23-0-29" class="d">-import androidx.navigation.NavController
</a><a href="#h23-0-30" id="h23-0-30" class="d">-import kotlinx.coroutines.Dispatchers
</a><a href="#h23-0-31" id="h23-0-31" class="d">-import kotlinx.coroutines.delay
</a><a href="#h23-0-32" id="h23-0-32" class="d">-import kotlinx.coroutines.launch
</a><a href="#h23-0-33" id="h23-0-33" class="d">-import kotlinx.coroutines.withContext
</a><a href="#h23-0-34" id="h23-0-34" class="d">-import me.rhunk.snapenhance.LogReader
</a><a href="#h23-0-35" id="h23-0-35" class="d">-import me.rhunk.snapenhance.RemoteSideContext
</a><a href="#h23-0-36" id="h23-0-36" class="d">-import me.rhunk.snapenhance.common.logger.LogChannel
</a><a href="#h23-0-37" id="h23-0-37" class="d">-import me.rhunk.snapenhance.common.logger.LogLevel
</a><a href="#h23-0-38" id="h23-0-38" class="d">-import me.rhunk.snapenhance.ui.util.ActivityLauncherHelper
</a><a href="#h23-0-39" id="h23-0-39" class="d">-import me.rhunk.snapenhance.ui.util.pullrefresh.PullRefreshIndicator
</a><a href="#h23-0-40" id="h23-0-40" class="d">-import me.rhunk.snapenhance.ui.util.pullrefresh.rememberPullRefreshState
</a><a href="#h23-0-41" id="h23-0-41" class="d">-import me.rhunk.snapenhance.ui.util.saveFile
</a><a href="#h23-0-42" id="h23-0-42" class="d">-
</a><a href="#h23-0-43" id="h23-0-43" class="d">-class HomeSubSection(
</a><a href="#h23-0-44" id="h23-0-44" class="d">-    private val context: RemoteSideContext
</a><a href="#h23-0-45" id="h23-0-45" class="d">-) {
</a><a href="#h23-0-46" id="h23-0-46" class="d">-    private val logListState by lazy { LazyListState(0) }
</a><a href="#h23-0-47" id="h23-0-47" class="d">-
</a><a href="#h23-0-48" id="h23-0-48" class="d">-    @Composable
</a><a href="#h23-0-49" id="h23-0-49" class="d">-    fun LogsSection() {
</a><a href="#h23-0-50" id="h23-0-50" class="d">-        val coroutineScope = rememberCoroutineScope()
</a><a href="#h23-0-51" id="h23-0-51" class="d">-        val clipboardManager = LocalClipboardManager.current
</a><a href="#h23-0-52" id="h23-0-52" class="d">-        var lineCount by remember { mutableIntStateOf(0) }
</a><a href="#h23-0-53" id="h23-0-53" class="d">-        var logReader by remember { mutableStateOf&lt;LogReader?&gt;(null) }
</a><a href="#h23-0-54" id="h23-0-54" class="d">-        var isRefreshing by remember { mutableStateOf(false) }
</a><a href="#h23-0-55" id="h23-0-55" class="d">-
</a><a href="#h23-0-56" id="h23-0-56" class="d">-        fun refreshLogs() {
</a><a href="#h23-0-57" id="h23-0-57" class="d">-            coroutineScope.launch(Dispatchers.IO) {
</a><a href="#h23-0-58" id="h23-0-58" class="d">-                runCatching {
</a><a href="#h23-0-59" id="h23-0-59" class="d">-                    logReader = context.log.newReader {
</a><a href="#h23-0-60" id="h23-0-60" class="d">-                        lineCount++
</a><a href="#h23-0-61" id="h23-0-61" class="d">-                    }
</a><a href="#h23-0-62" id="h23-0-62" class="d">-                    lineCount = logReader!!.lineCount
</a><a href="#h23-0-63" id="h23-0-63" class="d">-                }.onFailure {
</a><a href="#h23-0-64" id="h23-0-64" class="d">-                    context.longToast(&quot;Failed to read logs!&quot;)
</a><a href="#h23-0-65" id="h23-0-65" class="d">-                }
</a><a href="#h23-0-66" id="h23-0-66" class="d">-                delay(300)
</a><a href="#h23-0-67" id="h23-0-67" class="d">-                isRefreshing = false
</a><a href="#h23-0-68" id="h23-0-68" class="d">-                withContext(Dispatchers.Main) {
</a><a href="#h23-0-69" id="h23-0-69" class="d">-                    logListState.scrollToItem((logListState.layoutInfo.totalItemsCount - 1).takeIf { it &gt;= 0 } ?: return@withContext)
</a><a href="#h23-0-70" id="h23-0-70" class="d">-                }
</a><a href="#h23-0-71" id="h23-0-71" class="d">-            }
</a><a href="#h23-0-72" id="h23-0-72" class="d">-        }
</a><a href="#h23-0-73" id="h23-0-73" class="d">-
</a><a href="#h23-0-74" id="h23-0-74" class="d">-        val pullRefreshState = rememberPullRefreshState(isRefreshing, onRefresh = {
</a><a href="#h23-0-75" id="h23-0-75" class="d">-            refreshLogs()
</a><a href="#h23-0-76" id="h23-0-76" class="d">-        })
</a><a href="#h23-0-77" id="h23-0-77" class="d">-
</a><a href="#h23-0-78" id="h23-0-78" class="d">-        LaunchedEffect(Unit) {
</a><a href="#h23-0-79" id="h23-0-79" class="d">-            isRefreshing = true
</a><a href="#h23-0-80" id="h23-0-80" class="d">-            refreshLogs()
</a><a href="#h23-0-81" id="h23-0-81" class="d">-        }
</a><a href="#h23-0-82" id="h23-0-82" class="d">-
</a><a href="#h23-0-83" id="h23-0-83" class="d">-        Box(
</a><a href="#h23-0-84" id="h23-0-84" class="d">-            modifier = Modifier
</a><a href="#h23-0-85" id="h23-0-85" class="d">-                .fillMaxSize()
</a><a href="#h23-0-86" id="h23-0-86" class="d">-        ) {
</a><a href="#h23-0-87" id="h23-0-87" class="d">-            LazyColumn(
</a><a href="#h23-0-88" id="h23-0-88" class="d">-                modifier = Modifier
</a><a href="#h23-0-89" id="h23-0-89" class="d">-                    .background(MaterialTheme.colorScheme.surface)
</a><a href="#h23-0-90" id="h23-0-90" class="d">-                    .horizontalScroll(ScrollState(0)),
</a><a href="#h23-0-91" id="h23-0-91" class="d">-                state = logListState
</a><a href="#h23-0-92" id="h23-0-92" class="d">-            ) {
</a><a href="#h23-0-93" id="h23-0-93" class="d">-                item {
</a><a href="#h23-0-94" id="h23-0-94" class="d">-                    if (lineCount == 0 &amp;&amp; logReader != null) {
</a><a href="#h23-0-95" id="h23-0-95" class="d">-                        Text(
</a><a href="#h23-0-96" id="h23-0-96" class="d">-                            text = &quot;No logs found!&quot;,
</a><a href="#h23-0-97" id="h23-0-97" class="d">-                            modifier = Modifier.padding(16.dp),
</a><a href="#h23-0-98" id="h23-0-98" class="d">-                            fontSize = 12.sp,
</a><a href="#h23-0-99" id="h23-0-99" class="d">-                            fontWeight = FontWeight.Light
</a><a href="#h23-0-100" id="h23-0-100" class="d">-                        )
</a><a href="#h23-0-101" id="h23-0-101" class="d">-                    }
</a><a href="#h23-0-102" id="h23-0-102" class="d">-                }
</a><a href="#h23-0-103" id="h23-0-103" class="d">-                items(lineCount) { index -&gt;
</a><a href="#h23-0-104" id="h23-0-104" class="d">-                    val logLine = remember(index) { logReader?.getLogLine(index) } ?: return@items
</a><a href="#h23-0-105" id="h23-0-105" class="d">-                    var expand by remember { mutableStateOf(false) }
</a><a href="#h23-0-106" id="h23-0-106" class="d">-
</a><a href="#h23-0-107" id="h23-0-107" class="d">-                    Box(modifier = Modifier
</a><a href="#h23-0-108" id="h23-0-108" class="d">-                        .fillMaxWidth()
</a><a href="#h23-0-109" id="h23-0-109" class="d">-                        .pointerInput(Unit) {
</a><a href="#h23-0-110" id="h23-0-110" class="d">-                            detectTapGestures(
</a><a href="#h23-0-111" id="h23-0-111" class="d">-                                onLongPress = {
</a><a href="#h23-0-112" id="h23-0-112" class="d">-                                    coroutineScope.launch {
</a><a href="#h23-0-113" id="h23-0-113" class="d">-                                        clipboardManager.setText(AnnotatedString(logLine.message))
</a><a href="#h23-0-114" id="h23-0-114" class="d">-                                    }
</a><a href="#h23-0-115" id="h23-0-115" class="d">-                                },
</a><a href="#h23-0-116" id="h23-0-116" class="d">-                                onTap = {
</a><a href="#h23-0-117" id="h23-0-117" class="d">-                                    expand = !expand
</a><a href="#h23-0-118" id="h23-0-118" class="d">-                                }
</a><a href="#h23-0-119" id="h23-0-119" class="d">-                            )
</a><a href="#h23-0-120" id="h23-0-120" class="d">-                        }) {
</a><a href="#h23-0-121" id="h23-0-121" class="d">-
</a><a href="#h23-0-122" id="h23-0-122" class="d">-                        Row(
</a><a href="#h23-0-123" id="h23-0-123" class="d">-                            modifier = Modifier
</a><a href="#h23-0-124" id="h23-0-124" class="d">-                                .padding(4.dp)
</a><a href="#h23-0-125" id="h23-0-125" class="d">-                                .fillMaxWidth()
</a><a href="#h23-0-126" id="h23-0-126" class="d">-                                .defaultMinSize(minHeight = 30.dp),
</a><a href="#h23-0-127" id="h23-0-127" class="d">-                            verticalAlignment = Alignment.CenterVertically
</a><a href="#h23-0-128" id="h23-0-128" class="d">-                        ) {
</a><a href="#h23-0-129" id="h23-0-129" class="d">-                            if (!expand) {
</a><a href="#h23-0-130" id="h23-0-130" class="d">-                                Icon(
</a><a href="#h23-0-131" id="h23-0-131" class="d">-                                    imageVector = when (logLine.logLevel) {
</a><a href="#h23-0-132" id="h23-0-132" class="d">-                                        LogLevel.DEBUG -&gt; Icons.Outlined.BugReport
</a><a href="#h23-0-133" id="h23-0-133" class="d">-                                        LogLevel.ERROR, LogLevel.ASSERT -&gt; Icons.Outlined.Report
</a><a href="#h23-0-134" id="h23-0-134" class="d">-                                        LogLevel.INFO, LogLevel.VERBOSE -&gt; Icons.Outlined.Info
</a><a href="#h23-0-135" id="h23-0-135" class="d">-                                        LogLevel.WARN -&gt; Icons.Outlined.Warning
</a><a href="#h23-0-136" id="h23-0-136" class="d">-                                    },
</a><a href="#h23-0-137" id="h23-0-137" class="d">-                                    contentDescription = null,
</a><a href="#h23-0-138" id="h23-0-138" class="d">-                                )
</a><a href="#h23-0-139" id="h23-0-139" class="d">-
</a><a href="#h23-0-140" id="h23-0-140" class="d">-                                Text(
</a><a href="#h23-0-141" id="h23-0-141" class="d">-                                    text = LogChannel.fromChannel(logLine.tag)?.shortName ?: logLine.tag,
</a><a href="#h23-0-142" id="h23-0-142" class="d">-                                    modifier = Modifier.padding(start = 4.dp),
</a><a href="#h23-0-143" id="h23-0-143" class="d">-                                    fontWeight = FontWeight.Light,
</a><a href="#h23-0-144" id="h23-0-144" class="d">-                                    fontSize = 10.sp,
</a><a href="#h23-0-145" id="h23-0-145" class="d">-                                )
</a><a href="#h23-0-146" id="h23-0-146" class="d">-
</a><a href="#h23-0-147" id="h23-0-147" class="d">-                                Text(
</a><a href="#h23-0-148" id="h23-0-148" class="d">-                                    text = logLine.dateTime,
</a><a href="#h23-0-149" id="h23-0-149" class="d">-                                    modifier = Modifier.padding(start = 4.dp, end = 4.dp),
</a><a href="#h23-0-150" id="h23-0-150" class="d">-                                    fontSize = 10.sp
</a><a href="#h23-0-151" id="h23-0-151" class="d">-                                )
</a><a href="#h23-0-152" id="h23-0-152" class="d">-                            }
</a><a href="#h23-0-153" id="h23-0-153" class="d">-
</a><a href="#h23-0-154" id="h23-0-154" class="d">-                            Text(
</a><a href="#h23-0-155" id="h23-0-155" class="d">-                                text = logLine.message.trimIndent(),
</a><a href="#h23-0-156" id="h23-0-156" class="d">-                                fontSize = 10.sp,
</a><a href="#h23-0-157" id="h23-0-157" class="d">-                                maxLines = if (expand) Int.MAX_VALUE else 6,
</a><a href="#h23-0-158" id="h23-0-158" class="d">-                                overflow = if (expand) TextOverflow.Visible else TextOverflow.Ellipsis,
</a><a href="#h23-0-159" id="h23-0-159" class="d">-                                softWrap = !expand,
</a><a href="#h23-0-160" id="h23-0-160" class="d">-                            )
</a><a href="#h23-0-161" id="h23-0-161" class="d">-                        }
</a><a href="#h23-0-162" id="h23-0-162" class="d">-                    }
</a><a href="#h23-0-163" id="h23-0-163" class="d">-                }
</a><a href="#h23-0-164" id="h23-0-164" class="d">-            }
</a><a href="#h23-0-165" id="h23-0-165" class="d">-
</a><a href="#h23-0-166" id="h23-0-166" class="d">-            PullRefreshIndicator(
</a><a href="#h23-0-167" id="h23-0-167" class="d">-                refreshing = isRefreshing,
</a><a href="#h23-0-168" id="h23-0-168" class="d">-                state = pullRefreshState,
</a><a href="#h23-0-169" id="h23-0-169" class="d">-                modifier = Modifier.align(Alignment.TopCenter)
</a><a href="#h23-0-170" id="h23-0-170" class="d">-            )
</a><a href="#h23-0-171" id="h23-0-171" class="d">-        }
</a><a href="#h23-0-172" id="h23-0-172" class="d">-    }
</a><a href="#h23-0-173" id="h23-0-173" class="d">-
</a><a href="#h23-0-174" id="h23-0-174" class="d">-    @Composable
</a><a href="#h23-0-175" id="h23-0-175" class="d">-    fun LogsTopBarButtons(activityLauncherHelper: ActivityLauncherHelper, navController: NavController, rowScope: RowScope) {
</a><a href="#h23-0-176" id="h23-0-176" class="d">-        var showDropDown by remember { mutableStateOf(false) }
</a><a href="#h23-0-177" id="h23-0-177" class="d">-
</a><a href="#h23-0-178" id="h23-0-178" class="d">-        IconButton(onClick = {
</a><a href="#h23-0-179" id="h23-0-179" class="d">-            showDropDown = true
</a><a href="#h23-0-180" id="h23-0-180" class="d">-        }) {
</a><a href="#h23-0-181" id="h23-0-181" class="d">-            Icon(Icons.Filled.MoreVert, contentDescription = null)
</a><a href="#h23-0-182" id="h23-0-182" class="d">-        }
</a><a href="#h23-0-183" id="h23-0-183" class="d">-
</a><a href="#h23-0-184" id="h23-0-184" class="d">-        rowScope.apply {
</a><a href="#h23-0-185" id="h23-0-185" class="d">-            DropdownMenu(
</a><a href="#h23-0-186" id="h23-0-186" class="d">-                expanded = showDropDown,
</a><a href="#h23-0-187" id="h23-0-187" class="d">-                onDismissRequest = { showDropDown = false },
</a><a href="#h23-0-188" id="h23-0-188" class="d">-                modifier = Modifier.align(Alignment.CenterVertically)
</a><a href="#h23-0-189" id="h23-0-189" class="d">-            ) {
</a><a href="#h23-0-190" id="h23-0-190" class="d">-                DropdownMenuItem(onClick = {
</a><a href="#h23-0-191" id="h23-0-191" class="d">-                    context.log.clearLogs()
</a><a href="#h23-0-192" id="h23-0-192" class="d">-                    navController.navigate(HomeSection.LOGS_SECTION_ROUTE)
</a><a href="#h23-0-193" id="h23-0-193" class="d">-                    showDropDown = false
</a><a href="#h23-0-194" id="h23-0-194" class="d">-                }, text = {
</a><a href="#h23-0-195" id="h23-0-195" class="d">-                    Text(
</a><a href="#h23-0-196" id="h23-0-196" class="d">-                        text = context.translation[&quot;manager.sections.home.logs.clear_logs_button&quot;]
</a><a href="#h23-0-197" id="h23-0-197" class="d">-                    )
</a><a href="#h23-0-198" id="h23-0-198" class="d">-                })
</a><a href="#h23-0-199" id="h23-0-199" class="d">-
</a><a href="#h23-0-200" id="h23-0-200" class="d">-                DropdownMenuItem(onClick = {
</a><a href="#h23-0-201" id="h23-0-201" class="d">-                    activityLauncherHelper.saveFile(&quot;snapenhance-logs-${System.currentTimeMillis()}.zip&quot;, &quot;application/zip&quot;) { uri -&gt;
</a><a href="#h23-0-202" id="h23-0-202" class="d">-                        context.androidContext.contentResolver.openOutputStream(Uri.parse(uri))?.use {
</a><a href="#h23-0-203" id="h23-0-203" class="d">-                            runCatching {
</a><a href="#h23-0-204" id="h23-0-204" class="d">-                                context.log.exportLogsToZip(it)
</a><a href="#h23-0-205" id="h23-0-205" class="d">-                                context.longToast(&quot;Saved logs to $uri&quot;)
</a><a href="#h23-0-206" id="h23-0-206" class="d">-                            }.onFailure {
</a><a href="#h23-0-207" id="h23-0-207" class="d">-                                context.longToast(&quot;Failed to save logs to $uri!&quot;)
</a><a href="#h23-0-208" id="h23-0-208" class="d">-                                context.log.error(&quot;Failed to save logs to $uri!&quot;, it)
</a><a href="#h23-0-209" id="h23-0-209" class="d">-                            }
</a><a href="#h23-0-210" id="h23-0-210" class="d">-                        }
</a><a href="#h23-0-211" id="h23-0-211" class="d">-                    }
</a><a href="#h23-0-212" id="h23-0-212" class="d">-                    showDropDown = false
</a><a href="#h23-0-213" id="h23-0-213" class="d">-                }, text = {
</a><a href="#h23-0-214" id="h23-0-214" class="d">-                    Text(
</a><a href="#h23-0-215" id="h23-0-215" class="d">-                        text = context.translation[&quot;manager.sections.home.logs.export_logs_button&quot;]
</a><a href="#h23-0-216" id="h23-0-216" class="d">-                    )
</a><a href="#h23-0-217" id="h23-0-217" class="d">-                })
</a><a href="#h23-0-218" id="h23-0-218" class="d">-            }
</a><a href="#h23-0-219" id="h23-0-219" class="d">-        }
</a><a href="#h23-0-220" id="h23-0-220" class="d">-    }
</a><a href="#h23-0-221" id="h23-0-221" class="d">-
</a><a href="#h23-0-222" id="h23-0-222" class="d">-    @Composable
</a><a href="#h23-0-223" id="h23-0-223" class="d">-    fun LogsActionButtons() {
</a><a href="#h23-0-224" id="h23-0-224" class="d">-        val coroutineScope = rememberCoroutineScope()
</a><a href="#h23-0-225" id="h23-0-225" class="d">-        Column(
</a><a href="#h23-0-226" id="h23-0-226" class="d">-            verticalArrangement = Arrangement.spacedBy(5.dp),
</a><a href="#h23-0-227" id="h23-0-227" class="d">-        ) {
</a><a href="#h23-0-228" id="h23-0-228" class="d">-            val firstVisibleItem by remember { derivedStateOf { logListState.firstVisibleItemIndex } }
</a><a href="#h23-0-229" id="h23-0-229" class="d">-            val layoutInfo by remember { derivedStateOf { logListState.layoutInfo } }
</a><a href="#h23-0-230" id="h23-0-230" class="d">-            FilledIconButton(
</a><a href="#h23-0-231" id="h23-0-231" class="d">-                onClick = {
</a><a href="#h23-0-232" id="h23-0-232" class="d">-                    coroutineScope.launch {
</a><a href="#h23-0-233" id="h23-0-233" class="d">-                        logListState.scrollToItem(0)
</a><a href="#h23-0-234" id="h23-0-234" class="d">-                    }
</a><a href="#h23-0-235" id="h23-0-235" class="d">-                },
</a><a href="#h23-0-236" id="h23-0-236" class="d">-                enabled = firstVisibleItem != 0
</a><a href="#h23-0-237" id="h23-0-237" class="d">-            ) {
</a><a href="#h23-0-238" id="h23-0-238" class="d">-                Icon(Icons.Filled.KeyboardDoubleArrowUp, contentDescription = null)
</a><a href="#h23-0-239" id="h23-0-239" class="d">-            }
</a><a href="#h23-0-240" id="h23-0-240" class="d">-
</a><a href="#h23-0-241" id="h23-0-241" class="d">-            FilledIconButton(
</a><a href="#h23-0-242" id="h23-0-242" class="d">-                onClick = {
</a><a href="#h23-0-243" id="h23-0-243" class="d">-                    coroutineScope.launch {
</a><a href="#h23-0-244" id="h23-0-244" class="d">-                        logListState.scrollToItem((logListState.layoutInfo.totalItemsCount - 1).takeIf { it &gt;= 0 } ?: return@launch)
</a><a href="#h23-0-245" id="h23-0-245" class="d">-                    }
</a><a href="#h23-0-246" id="h23-0-246" class="d">-                },
</a><a href="#h23-0-247" id="h23-0-247" class="d">-                enabled = layoutInfo.visibleItemsInfo.lastOrNull()?.index != layoutInfo.totalItemsCount - 1
</a><a href="#h23-0-248" id="h23-0-248" class="d">-            ) {
</a><a href="#h23-0-249" id="h23-0-249" class="d">-                Icon(Icons.Filled.KeyboardDoubleArrowDown, contentDescription = null)
</a><a href="#h23-0-250" id="h23-0-250" class="d">-            }
</a><a href="#h23-0-251" id="h23-0-251" class="d">-        }
</a><a href="#h23-0-252" id="h23-0-252" class="d">-    }
</a><a href="#h23-0-253" id="h23-0-253" class="d">-}</a><a href="#h23-0-254" id="h23-0-254" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h24" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/home/SettingsSection.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/home/SettingsSection.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/home/SettingsSection.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/home/SettingsSection.kt</a></b>
<a href="#h24-0" id="h24-0" class="h">@@ -1,240 +0,0 @@
</a><a href="#h24-0-0" id="h24-0-0" class="d">-package me.rhunk.snapenhance.ui.manager.sections.home
</a><a href="#h24-0-1" id="h24-0-1" class="d">-
</a><a href="#h24-0-2" id="h24-0-2" class="d">-import androidx.compose.foundation.ScrollState
</a><a href="#h24-0-3" id="h24-0-3" class="d">-import androidx.compose.foundation.clickable
</a><a href="#h24-0-4" id="h24-0-4" class="d">-import androidx.compose.foundation.layout.*
</a><a href="#h24-0-5" id="h24-0-5" class="d">-import androidx.compose.foundation.verticalScroll
</a><a href="#h24-0-6" id="h24-0-6" class="d">-import androidx.compose.material.icons.Icons
</a><a href="#h24-0-7" id="h24-0-7" class="d">-import androidx.compose.material.icons.filled.OpenInNew
</a><a href="#h24-0-8" id="h24-0-8" class="d">-import androidx.compose.material3.*
</a><a href="#h24-0-9" id="h24-0-9" class="d">-import androidx.compose.runtime.*
</a><a href="#h24-0-10" id="h24-0-10" class="d">-import androidx.compose.ui.Alignment
</a><a href="#h24-0-11" id="h24-0-11" class="d">-import androidx.compose.ui.Modifier
</a><a href="#h24-0-12" id="h24-0-12" class="d">-import androidx.compose.ui.text.font.FontWeight
</a><a href="#h24-0-13" id="h24-0-13" class="d">-import androidx.compose.ui.unit.dp
</a><a href="#h24-0-14" id="h24-0-14" class="d">-import androidx.compose.ui.unit.sp
</a><a href="#h24-0-15" id="h24-0-15" class="d">-import androidx.compose.ui.window.Dialog
</a><a href="#h24-0-16" id="h24-0-16" class="d">-import androidx.core.net.toUri
</a><a href="#h24-0-17" id="h24-0-17" class="d">-import kotlinx.coroutines.Dispatchers
</a><a href="#h24-0-18" id="h24-0-18" class="d">-import kotlinx.coroutines.withContext
</a><a href="#h24-0-19" id="h24-0-19" class="d">-import me.rhunk.snapenhance.common.Constants
</a><a href="#h24-0-20" id="h24-0-20" class="d">-import me.rhunk.snapenhance.common.action.EnumAction
</a><a href="#h24-0-21" id="h24-0-21" class="d">-import me.rhunk.snapenhance.common.bridge.types.BridgeFileType
</a><a href="#h24-0-22" id="h24-0-22" class="d">-import me.rhunk.snapenhance.ui.manager.Section
</a><a href="#h24-0-23" id="h24-0-23" class="d">-import me.rhunk.snapenhance.ui.setup.Requirements
</a><a href="#h24-0-24" id="h24-0-24" class="d">-import me.rhunk.snapenhance.ui.util.ActivityLauncherHelper
</a><a href="#h24-0-25" id="h24-0-25" class="d">-import me.rhunk.snapenhance.ui.util.AlertDialogs
</a><a href="#h24-0-26" id="h24-0-26" class="d">-import me.rhunk.snapenhance.ui.util.saveFile
</a><a href="#h24-0-27" id="h24-0-27" class="d">-
</a><a href="#h24-0-28" id="h24-0-28" class="d">-class SettingsSection(
</a><a href="#h24-0-29" id="h24-0-29" class="d">-    private val activityLauncherHelper: ActivityLauncherHelper
</a><a href="#h24-0-30" id="h24-0-30" class="d">-) : Section() {
</a><a href="#h24-0-31" id="h24-0-31" class="d">-    private val dialogs by lazy { AlertDialogs(context.translation) }
</a><a href="#h24-0-32" id="h24-0-32" class="d">-
</a><a href="#h24-0-33" id="h24-0-33" class="d">-    @Composable
</a><a href="#h24-0-34" id="h24-0-34" class="d">-    private fun RowTitle(title: String) {
</a><a href="#h24-0-35" id="h24-0-35" class="d">-        Text(text = title, modifier = Modifier.padding(16.dp), fontSize = 20.sp, fontWeight = FontWeight.Bold)
</a><a href="#h24-0-36" id="h24-0-36" class="d">-    }
</a><a href="#h24-0-37" id="h24-0-37" class="d">-
</a><a href="#h24-0-38" id="h24-0-38" class="d">-    @Composable
</a><a href="#h24-0-39" id="h24-0-39" class="d">-    private fun RowAction(title: String, requireConfirmation: Boolean = false, action: () -&gt; Unit) {
</a><a href="#h24-0-40" id="h24-0-40" class="d">-        var confirmationDialog by remember {
</a><a href="#h24-0-41" id="h24-0-41" class="d">-            mutableStateOf(false)
</a><a href="#h24-0-42" id="h24-0-42" class="d">-        }
</a><a href="#h24-0-43" id="h24-0-43" class="d">-
</a><a href="#h24-0-44" id="h24-0-44" class="d">-        fun takeAction() {
</a><a href="#h24-0-45" id="h24-0-45" class="d">-            if (requireConfirmation) {
</a><a href="#h24-0-46" id="h24-0-46" class="d">-                confirmationDialog = true
</a><a href="#h24-0-47" id="h24-0-47" class="d">-            } else {
</a><a href="#h24-0-48" id="h24-0-48" class="d">-                action()
</a><a href="#h24-0-49" id="h24-0-49" class="d">-            }
</a><a href="#h24-0-50" id="h24-0-50" class="d">-        }
</a><a href="#h24-0-51" id="h24-0-51" class="d">-
</a><a href="#h24-0-52" id="h24-0-52" class="d">-        if (requireConfirmation &amp;&amp; confirmationDialog) {
</a><a href="#h24-0-53" id="h24-0-53" class="d">-            Dialog(onDismissRequest = { confirmationDialog = false }) {
</a><a href="#h24-0-54" id="h24-0-54" class="d">-                dialogs.ConfirmDialog(title = &quot;Are you sure?&quot;, onConfirm = {
</a><a href="#h24-0-55" id="h24-0-55" class="d">-                    action()
</a><a href="#h24-0-56" id="h24-0-56" class="d">-                    confirmationDialog = false
</a><a href="#h24-0-57" id="h24-0-57" class="d">-                }, onDismiss = {
</a><a href="#h24-0-58" id="h24-0-58" class="d">-                    confirmationDialog = false
</a><a href="#h24-0-59" id="h24-0-59" class="d">-                })
</a><a href="#h24-0-60" id="h24-0-60" class="d">-            }
</a><a href="#h24-0-61" id="h24-0-61" class="d">-        }
</a><a href="#h24-0-62" id="h24-0-62" class="d">-
</a><a href="#h24-0-63" id="h24-0-63" class="d">-        ShiftedRow(
</a><a href="#h24-0-64" id="h24-0-64" class="d">-            modifier = Modifier
</a><a href="#h24-0-65" id="h24-0-65" class="d">-                .fillMaxWidth()
</a><a href="#h24-0-66" id="h24-0-66" class="d">-                .height(55.dp)
</a><a href="#h24-0-67" id="h24-0-67" class="d">-                .clickable {
</a><a href="#h24-0-68" id="h24-0-68" class="d">-                    takeAction()
</a><a href="#h24-0-69" id="h24-0-69" class="d">-                },
</a><a href="#h24-0-70" id="h24-0-70" class="d">-            horizontalArrangement = Arrangement.SpaceBetween,
</a><a href="#h24-0-71" id="h24-0-71" class="d">-            verticalAlignment = Alignment.CenterVertically
</a><a href="#h24-0-72" id="h24-0-72" class="d">-        ) {
</a><a href="#h24-0-73" id="h24-0-73" class="d">-            Text(text = title, modifier = Modifier.padding(start = 26.dp))
</a><a href="#h24-0-74" id="h24-0-74" class="d">-            IconButton(onClick = { takeAction() }) {
</a><a href="#h24-0-75" id="h24-0-75" class="d">-                Icon(
</a><a href="#h24-0-76" id="h24-0-76" class="d">-                    imageVector = Icons.Filled.OpenInNew,
</a><a href="#h24-0-77" id="h24-0-77" class="d">-                    contentDescription = null,
</a><a href="#h24-0-78" id="h24-0-78" class="d">-                    modifier = Modifier.size(24.dp)
</a><a href="#h24-0-79" id="h24-0-79" class="d">-                )
</a><a href="#h24-0-80" id="h24-0-80" class="d">-            }
</a><a href="#h24-0-81" id="h24-0-81" class="d">-        }
</a><a href="#h24-0-82" id="h24-0-82" class="d">-    }
</a><a href="#h24-0-83" id="h24-0-83" class="d">-
</a><a href="#h24-0-84" id="h24-0-84" class="d">-    private fun launchActionIntent(action: EnumAction) {
</a><a href="#h24-0-85" id="h24-0-85" class="d">-        val intent = context.androidContext.packageManager.getLaunchIntentForPackage(Constants.SNAPCHAT_PACKAGE_NAME)
</a><a href="#h24-0-86" id="h24-0-86" class="d">-        intent?.putExtra(EnumAction.ACTION_PARAMETER, action.key)
</a><a href="#h24-0-87" id="h24-0-87" class="d">-        context.androidContext.startActivity(intent)
</a><a href="#h24-0-88" id="h24-0-88" class="d">-    }
</a><a href="#h24-0-89" id="h24-0-89" class="d">-
</a><a href="#h24-0-90" id="h24-0-90" class="d">-    @Composable
</a><a href="#h24-0-91" id="h24-0-91" class="d">-    private fun ShiftedRow(
</a><a href="#h24-0-92" id="h24-0-92" class="d">-        modifier: Modifier = Modifier,
</a><a href="#h24-0-93" id="h24-0-93" class="d">-        horizontalArrangement: Arrangement.Horizontal = Arrangement.Start,
</a><a href="#h24-0-94" id="h24-0-94" class="d">-        verticalAlignment: Alignment.Vertical = Alignment.Top,
</a><a href="#h24-0-95" id="h24-0-95" class="d">-        content: @Composable RowScope.() -&gt; Unit
</a><a href="#h24-0-96" id="h24-0-96" class="d">-    ) {
</a><a href="#h24-0-97" id="h24-0-97" class="d">-        Row(
</a><a href="#h24-0-98" id="h24-0-98" class="d">-            modifier = modifier.padding(start = 26.dp),
</a><a href="#h24-0-99" id="h24-0-99" class="d">-            horizontalArrangement = horizontalArrangement,
</a><a href="#h24-0-100" id="h24-0-100" class="d">-            verticalAlignment = verticalAlignment
</a><a href="#h24-0-101" id="h24-0-101" class="d">-        ) { content(this) }
</a><a href="#h24-0-102" id="h24-0-102" class="d">-    }
</a><a href="#h24-0-103" id="h24-0-103" class="d">-
</a><a href="#h24-0-104" id="h24-0-104" class="d">-
</a><a href="#h24-0-105" id="h24-0-105" class="d">-    @OptIn(ExperimentalMaterial3Api::class)
</a><a href="#h24-0-106" id="h24-0-106" class="d">-    @Composable
</a><a href="#h24-0-107" id="h24-0-107" class="d">-    override fun Content() {
</a><a href="#h24-0-108" id="h24-0-108" class="d">-        Column(
</a><a href="#h24-0-109" id="h24-0-109" class="d">-            modifier = Modifier
</a><a href="#h24-0-110" id="h24-0-110" class="d">-                .fillMaxSize()
</a><a href="#h24-0-111" id="h24-0-111" class="d">-                .verticalScroll(ScrollState(0))
</a><a href="#h24-0-112" id="h24-0-112" class="d">-        ) {
</a><a href="#h24-0-113" id="h24-0-113" class="d">-            RowTitle(title = &quot;Actions&quot;)
</a><a href="#h24-0-114" id="h24-0-114" class="d">-            EnumAction.entries.forEach { enumAction -&gt;
</a><a href="#h24-0-115" id="h24-0-115" class="d">-                RowAction(title = context.translation[&quot;actions.${enumAction.key}&quot;]) {
</a><a href="#h24-0-116" id="h24-0-116" class="d">-                    launchActionIntent(enumAction)
</a><a href="#h24-0-117" id="h24-0-117" class="d">-                }
</a><a href="#h24-0-118" id="h24-0-118" class="d">-            }
</a><a href="#h24-0-119" id="h24-0-119" class="d">-            RowAction(title = &quot;Regenerate Mappings&quot;) {
</a><a href="#h24-0-120" id="h24-0-120" class="d">-                context.checkForRequirements(Requirements.MAPPINGS)
</a><a href="#h24-0-121" id="h24-0-121" class="d">-            }
</a><a href="#h24-0-122" id="h24-0-122" class="d">-            RowAction(title = &quot;Change Language&quot;) {
</a><a href="#h24-0-123" id="h24-0-123" class="d">-                context.checkForRequirements(Requirements.LANGUAGE)
</a><a href="#h24-0-124" id="h24-0-124" class="d">-            }
</a><a href="#h24-0-125" id="h24-0-125" class="d">-            RowTitle(title = &quot;Message Logger&quot;)
</a><a href="#h24-0-126" id="h24-0-126" class="d">-            ShiftedRow {
</a><a href="#h24-0-127" id="h24-0-127" class="d">-                Column(
</a><a href="#h24-0-128" id="h24-0-128" class="d">-                    verticalArrangement = Arrangement.spacedBy(4.dp),
</a><a href="#h24-0-129" id="h24-0-129" class="d">-                ) {
</a><a href="#h24-0-130" id="h24-0-130" class="d">-                    var storedMessagesCount by remember { mutableIntStateOf(0) }
</a><a href="#h24-0-131" id="h24-0-131" class="d">-                    var storedStoriesCount by remember { mutableIntStateOf(0) }
</a><a href="#h24-0-132" id="h24-0-132" class="d">-                    LaunchedEffect(Unit) {
</a><a href="#h24-0-133" id="h24-0-133" class="d">-                        withContext(Dispatchers.IO) {
</a><a href="#h24-0-134" id="h24-0-134" class="d">-                            storedMessagesCount = context.messageLogger.getStoredMessageCount()
</a><a href="#h24-0-135" id="h24-0-135" class="d">-                            storedStoriesCount = context.messageLogger.getStoredStoriesCount()
</a><a href="#h24-0-136" id="h24-0-136" class="d">-                        }
</a><a href="#h24-0-137" id="h24-0-137" class="d">-                    }
</a><a href="#h24-0-138" id="h24-0-138" class="d">-                    Row(
</a><a href="#h24-0-139" id="h24-0-139" class="d">-                        horizontalArrangement = Arrangement.spacedBy(10.dp),
</a><a href="#h24-0-140" id="h24-0-140" class="d">-                        verticalAlignment = Alignment.CenterVertically,
</a><a href="#h24-0-141" id="h24-0-141" class="d">-                        modifier = Modifier
</a><a href="#h24-0-142" id="h24-0-142" class="d">-                            .fillMaxWidth()
</a><a href="#h24-0-143" id="h24-0-143" class="d">-                            .padding(5.dp)
</a><a href="#h24-0-144" id="h24-0-144" class="d">-                    ) {
</a><a href="#h24-0-145" id="h24-0-145" class="d">-                        Column(
</a><a href="#h24-0-146" id="h24-0-146" class="d">-                            modifier = Modifier.weight(1f),
</a><a href="#h24-0-147" id="h24-0-147" class="d">-                            verticalArrangement = Arrangement.spacedBy(2.dp),
</a><a href="#h24-0-148" id="h24-0-148" class="d">-                        ) {
</a><a href="#h24-0-149" id="h24-0-149" class="d">-                            Text(text = &quot;$storedMessagesCount messages&quot;)
</a><a href="#h24-0-150" id="h24-0-150" class="d">-                            Text(text = &quot;$storedStoriesCount stories&quot;)
</a><a href="#h24-0-151" id="h24-0-151" class="d">-                        }
</a><a href="#h24-0-152" id="h24-0-152" class="d">-                        Button(onClick = {
</a><a href="#h24-0-153" id="h24-0-153" class="d">-                            runCatching {
</a><a href="#h24-0-154" id="h24-0-154" class="d">-                                activityLauncherHelper.saveFile(&quot;message_logger.db&quot;, &quot;application/octet-stream&quot;) { uri -&gt;
</a><a href="#h24-0-155" id="h24-0-155" class="d">-                                    context.androidContext.contentResolver.openOutputStream(uri.toUri())?.use { outputStream -&gt;
</a><a href="#h24-0-156" id="h24-0-156" class="d">-                                        context.messageLogger.databaseFile.inputStream().use { inputStream -&gt;
</a><a href="#h24-0-157" id="h24-0-157" class="d">-                                            inputStream.copyTo(outputStream)
</a><a href="#h24-0-158" id="h24-0-158" class="d">-                                        }
</a><a href="#h24-0-159" id="h24-0-159" class="d">-                                    }
</a><a href="#h24-0-160" id="h24-0-160" class="d">-                                }
</a><a href="#h24-0-161" id="h24-0-161" class="d">-                            }.onFailure {
</a><a href="#h24-0-162" id="h24-0-162" class="d">-                                context.log.error(&quot;Failed to export database&quot;, it)
</a><a href="#h24-0-163" id="h24-0-163" class="d">-                                context.longToast(&quot;Failed to export database! ${it.localizedMessage}&quot;)
</a><a href="#h24-0-164" id="h24-0-164" class="d">-                            }
</a><a href="#h24-0-165" id="h24-0-165" class="d">-                        }) {
</a><a href="#h24-0-166" id="h24-0-166" class="d">-                            Text(text = &quot;Export&quot;)
</a><a href="#h24-0-167" id="h24-0-167" class="d">-                        }
</a><a href="#h24-0-168" id="h24-0-168" class="d">-                        Button(onClick = {
</a><a href="#h24-0-169" id="h24-0-169" class="d">-                            runCatching {
</a><a href="#h24-0-170" id="h24-0-170" class="d">-                                context.messageLogger.purgeAll()
</a><a href="#h24-0-171" id="h24-0-171" class="d">-                                storedMessagesCount = 0
</a><a href="#h24-0-172" id="h24-0-172" class="d">-                                storedStoriesCount = 0
</a><a href="#h24-0-173" id="h24-0-173" class="d">-                            }.onFailure {
</a><a href="#h24-0-174" id="h24-0-174" class="d">-                                context.log.error(&quot;Failed to clear messages&quot;, it)
</a><a href="#h24-0-175" id="h24-0-175" class="d">-                                context.longToast(&quot;Failed to clear messages! ${it.localizedMessage}&quot;)
</a><a href="#h24-0-176" id="h24-0-176" class="d">-                            }.onSuccess {
</a><a href="#h24-0-177" id="h24-0-177" class="d">-                                context.shortToast(&quot;Done!&quot;)
</a><a href="#h24-0-178" id="h24-0-178" class="d">-                            }
</a><a href="#h24-0-179" id="h24-0-179" class="d">-                        }) {
</a><a href="#h24-0-180" id="h24-0-180" class="d">-                            Text(text = &quot;Clear&quot;)
</a><a href="#h24-0-181" id="h24-0-181" class="d">-                        }
</a><a href="#h24-0-182" id="h24-0-182" class="d">-                    }
</a><a href="#h24-0-183" id="h24-0-183" class="d">-                }
</a><a href="#h24-0-184" id="h24-0-184" class="d">-            }
</a><a href="#h24-0-185" id="h24-0-185" class="d">-
</a><a href="#h24-0-186" id="h24-0-186" class="d">-            RowTitle(title = &quot;Clear App Files&quot;)
</a><a href="#h24-0-187" id="h24-0-187" class="d">-            Row(
</a><a href="#h24-0-188" id="h24-0-188" class="d">-                horizontalArrangement = Arrangement.SpaceBetween,
</a><a href="#h24-0-189" id="h24-0-189" class="d">-                verticalAlignment = Alignment.CenterVertically,
</a><a href="#h24-0-190" id="h24-0-190" class="d">-            ) {
</a><a href="#h24-0-191" id="h24-0-191" class="d">-                var selectedFileType by remember { mutableStateOf(BridgeFileType.entries.first()) }
</a><a href="#h24-0-192" id="h24-0-192" class="d">-                Box(
</a><a href="#h24-0-193" id="h24-0-193" class="d">-                    modifier = Modifier
</a><a href="#h24-0-194" id="h24-0-194" class="d">-                        .weight(1f)
</a><a href="#h24-0-195" id="h24-0-195" class="d">-                        .padding(start = 26.dp)
</a><a href="#h24-0-196" id="h24-0-196" class="d">-                ) {
</a><a href="#h24-0-197" id="h24-0-197" class="d">-                    var expanded by remember { mutableStateOf(false) }
</a><a href="#h24-0-198" id="h24-0-198" class="d">-
</a><a href="#h24-0-199" id="h24-0-199" class="d">-                    ExposedDropdownMenuBox(
</a><a href="#h24-0-200" id="h24-0-200" class="d">-                        expanded = expanded,
</a><a href="#h24-0-201" id="h24-0-201" class="d">-                        onExpandedChange = { expanded = it },
</a><a href="#h24-0-202" id="h24-0-202" class="d">-                        modifier = Modifier.fillMaxWidth(0.8f)
</a><a href="#h24-0-203" id="h24-0-203" class="d">-                    ) {
</a><a href="#h24-0-204" id="h24-0-204" class="d">-                        TextField(
</a><a href="#h24-0-205" id="h24-0-205" class="d">-                            value = selectedFileType.displayName,
</a><a href="#h24-0-206" id="h24-0-206" class="d">-                            onValueChange = {},
</a><a href="#h24-0-207" id="h24-0-207" class="d">-                            readOnly = true,
</a><a href="#h24-0-208" id="h24-0-208" class="d">-                            modifier = Modifier.menuAnchor()
</a><a href="#h24-0-209" id="h24-0-209" class="d">-                        )
</a><a href="#h24-0-210" id="h24-0-210" class="d">-                        
</a><a href="#h24-0-211" id="h24-0-211" class="d">-                        ExposedDropdownMenu(expanded = expanded, onDismissRequest = { expanded = false }) {
</a><a href="#h24-0-212" id="h24-0-212" class="d">-                            BridgeFileType.entries.forEach { fileType -&gt;
</a><a href="#h24-0-213" id="h24-0-213" class="d">-                                DropdownMenuItem(onClick = {
</a><a href="#h24-0-214" id="h24-0-214" class="d">-                                    expanded = false
</a><a href="#h24-0-215" id="h24-0-215" class="d">-                                    selectedFileType = fileType
</a><a href="#h24-0-216" id="h24-0-216" class="d">-                                }, text = {
</a><a href="#h24-0-217" id="h24-0-217" class="d">-                                    Text(text = fileType.displayName)
</a><a href="#h24-0-218" id="h24-0-218" class="d">-                                })
</a><a href="#h24-0-219" id="h24-0-219" class="d">-                            }
</a><a href="#h24-0-220" id="h24-0-220" class="d">-                        }
</a><a href="#h24-0-221" id="h24-0-221" class="d">-                    }
</a><a href="#h24-0-222" id="h24-0-222" class="d">-                }
</a><a href="#h24-0-223" id="h24-0-223" class="d">-                Button(onClick = {
</a><a href="#h24-0-224" id="h24-0-224" class="d">-                    runCatching {
</a><a href="#h24-0-225" id="h24-0-225" class="d">-                        selectedFileType.resolve(context.androidContext).delete()
</a><a href="#h24-0-226" id="h24-0-226" class="d">-                    }.onFailure {
</a><a href="#h24-0-227" id="h24-0-227" class="d">-                        context.log.error(&quot;Failed to clear file&quot;, it)
</a><a href="#h24-0-228" id="h24-0-228" class="d">-                        context.longToast(&quot;Failed to clear file! ${it.localizedMessage}&quot;)
</a><a href="#h24-0-229" id="h24-0-229" class="d">-                    }.onSuccess {
</a><a href="#h24-0-230" id="h24-0-230" class="d">-                        context.shortToast(&quot;Done!&quot;)
</a><a href="#h24-0-231" id="h24-0-231" class="d">-                    }
</a><a href="#h24-0-232" id="h24-0-232" class="d">-                }) {
</a><a href="#h24-0-233" id="h24-0-233" class="d">-                    Text(text = &quot;Clear&quot;)
</a><a href="#h24-0-234" id="h24-0-234" class="d">-                }
</a><a href="#h24-0-235" id="h24-0-235" class="d">-            }
</a><a href="#h24-0-236" id="h24-0-236" class="d">-            Spacer(modifier = Modifier.height(50.dp))
</a><a href="#h24-0-237" id="h24-0-237" class="d">-        }
</a><a href="#h24-0-238" id="h24-0-238" class="d">-    }
</a><a href="#h24-0-239" id="h24-0-239" class="d">-}</a><a href="#h24-0-240" id="h24-0-240" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h25" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/scripting/ScriptsSection.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/scripting/ScriptsSection.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/scripting/ScriptsSection.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/scripting/ScriptsSection.kt</a></b>
<a href="#h25-0" id="h25-0" class="h">@@ -1,305 +0,0 @@
</a><a href="#h25-0-0" id="h25-0-0" class="d">-package me.rhunk.snapenhance.ui.manager.sections.scripting
</a><a href="#h25-0-1" id="h25-0-1" class="d">-
</a><a href="#h25-0-2" id="h25-0-2" class="d">-import android.content.Intent
</a><a href="#h25-0-3" id="h25-0-3" class="d">-import androidx.compose.foundation.clickable
</a><a href="#h25-0-4" id="h25-0-4" class="d">-import androidx.compose.foundation.layout.*
</a><a href="#h25-0-5" id="h25-0-5" class="d">-import androidx.compose.foundation.lazy.LazyColumn
</a><a href="#h25-0-6" id="h25-0-6" class="d">-import androidx.compose.material.icons.Icons
</a><a href="#h25-0-7" id="h25-0-7" class="d">-import androidx.compose.material.icons.filled.FolderOpen
</a><a href="#h25-0-8" id="h25-0-8" class="d">-import androidx.compose.material.icons.filled.LibraryBooks
</a><a href="#h25-0-9" id="h25-0-9" class="d">-import androidx.compose.material.icons.filled.Link
</a><a href="#h25-0-10" id="h25-0-10" class="d">-import androidx.compose.material.icons.filled.Settings
</a><a href="#h25-0-11" id="h25-0-11" class="d">-import androidx.compose.material3.*
</a><a href="#h25-0-12" id="h25-0-12" class="d">-import androidx.compose.runtime.*
</a><a href="#h25-0-13" id="h25-0-13" class="d">-import androidx.compose.ui.Alignment
</a><a href="#h25-0-14" id="h25-0-14" class="d">-import androidx.compose.ui.Modifier
</a><a href="#h25-0-15" id="h25-0-15" class="d">-import androidx.compose.ui.unit.dp
</a><a href="#h25-0-16" id="h25-0-16" class="d">-import androidx.compose.ui.unit.sp
</a><a href="#h25-0-17" id="h25-0-17" class="d">-import androidx.core.net.toUri
</a><a href="#h25-0-18" id="h25-0-18" class="d">-import androidx.documentfile.provider.DocumentFile
</a><a href="#h25-0-19" id="h25-0-19" class="d">-import kotlinx.coroutines.Dispatchers
</a><a href="#h25-0-20" id="h25-0-20" class="d">-import kotlinx.coroutines.delay
</a><a href="#h25-0-21" id="h25-0-21" class="d">-import kotlinx.coroutines.launch
</a><a href="#h25-0-22" id="h25-0-22" class="d">-import kotlinx.coroutines.withContext
</a><a href="#h25-0-23" id="h25-0-23" class="d">-import me.rhunk.snapenhance.common.scripting.type.ModuleInfo
</a><a href="#h25-0-24" id="h25-0-24" class="d">-import me.rhunk.snapenhance.common.scripting.ui.EnumScriptInterface
</a><a href="#h25-0-25" id="h25-0-25" class="d">-import me.rhunk.snapenhance.common.scripting.ui.InterfaceManager
</a><a href="#h25-0-26" id="h25-0-26" class="d">-import me.rhunk.snapenhance.common.scripting.ui.ScriptInterface
</a><a href="#h25-0-27" id="h25-0-27" class="d">-import me.rhunk.snapenhance.ui.manager.Section
</a><a href="#h25-0-28" id="h25-0-28" class="d">-import me.rhunk.snapenhance.ui.util.ActivityLauncherHelper
</a><a href="#h25-0-29" id="h25-0-29" class="d">-import me.rhunk.snapenhance.ui.util.chooseFolder
</a><a href="#h25-0-30" id="h25-0-30" class="d">-import me.rhunk.snapenhance.ui.util.pullrefresh.PullRefreshIndicator
</a><a href="#h25-0-31" id="h25-0-31" class="d">-import me.rhunk.snapenhance.ui.util.pullrefresh.pullRefresh
</a><a href="#h25-0-32" id="h25-0-32" class="d">-import me.rhunk.snapenhance.ui.util.pullrefresh.rememberPullRefreshState
</a><a href="#h25-0-33" id="h25-0-33" class="d">-
</a><a href="#h25-0-34" id="h25-0-34" class="d">-class ScriptsSection : Section() {
</a><a href="#h25-0-35" id="h25-0-35" class="d">-    private lateinit var activityLauncherHelper: ActivityLauncherHelper
</a><a href="#h25-0-36" id="h25-0-36" class="d">-
</a><a href="#h25-0-37" id="h25-0-37" class="d">-    override fun init() {
</a><a href="#h25-0-38" id="h25-0-38" class="d">-        activityLauncherHelper = ActivityLauncherHelper(context.activity!!)
</a><a href="#h25-0-39" id="h25-0-39" class="d">-    }
</a><a href="#h25-0-40" id="h25-0-40" class="d">-
</a><a href="#h25-0-41" id="h25-0-41" class="d">-    @Composable
</a><a href="#h25-0-42" id="h25-0-42" class="d">-    fun ModuleItem(script: ModuleInfo) {
</a><a href="#h25-0-43" id="h25-0-43" class="d">-        var enabled by remember {
</a><a href="#h25-0-44" id="h25-0-44" class="d">-            mutableStateOf(context.modDatabase.isScriptEnabled(script.name))
</a><a href="#h25-0-45" id="h25-0-45" class="d">-        }
</a><a href="#h25-0-46" id="h25-0-46" class="d">-        var openSettings by remember {
</a><a href="#h25-0-47" id="h25-0-47" class="d">-            mutableStateOf(false)
</a><a href="#h25-0-48" id="h25-0-48" class="d">-        }
</a><a href="#h25-0-49" id="h25-0-49" class="d">-
</a><a href="#h25-0-50" id="h25-0-50" class="d">-        Card(
</a><a href="#h25-0-51" id="h25-0-51" class="d">-            modifier = Modifier
</a><a href="#h25-0-52" id="h25-0-52" class="d">-                .fillMaxWidth()
</a><a href="#h25-0-53" id="h25-0-53" class="d">-                .padding(8.dp),
</a><a href="#h25-0-54" id="h25-0-54" class="d">-            elevation = CardDefaults.cardElevation()
</a><a href="#h25-0-55" id="h25-0-55" class="d">-        ) {
</a><a href="#h25-0-56" id="h25-0-56" class="d">-            Row(
</a><a href="#h25-0-57" id="h25-0-57" class="d">-                modifier = Modifier
</a><a href="#h25-0-58" id="h25-0-58" class="d">-                    .fillMaxWidth()
</a><a href="#h25-0-59" id="h25-0-59" class="d">-                    .clickable {
</a><a href="#h25-0-60" id="h25-0-60" class="d">-                        openSettings = !openSettings
</a><a href="#h25-0-61" id="h25-0-61" class="d">-                    }
</a><a href="#h25-0-62" id="h25-0-62" class="d">-                    .padding(8.dp),
</a><a href="#h25-0-63" id="h25-0-63" class="d">-                verticalAlignment = Alignment.CenterVertically
</a><a href="#h25-0-64" id="h25-0-64" class="d">-            ) {
</a><a href="#h25-0-65" id="h25-0-65" class="d">-                Column(
</a><a href="#h25-0-66" id="h25-0-66" class="d">-                    modifier = Modifier
</a><a href="#h25-0-67" id="h25-0-67" class="d">-                        .weight(1f)
</a><a href="#h25-0-68" id="h25-0-68" class="d">-                        .padding(end = 8.dp)
</a><a href="#h25-0-69" id="h25-0-69" class="d">-                ) {
</a><a href="#h25-0-70" id="h25-0-70" class="d">-                    Text(text = script.displayName ?: script.name, fontSize = 20.sp,)
</a><a href="#h25-0-71" id="h25-0-71" class="d">-                    Text(text = script.description ?: &quot;No description&quot;, fontSize = 14.sp,)
</a><a href="#h25-0-72" id="h25-0-72" class="d">-                }
</a><a href="#h25-0-73" id="h25-0-73" class="d">-                IconButton(onClick = { openSettings = !openSettings }) {
</a><a href="#h25-0-74" id="h25-0-74" class="d">-                    Icon(imageVector = Icons.Default.Settings, contentDescription = &quot;Settings&quot;,)
</a><a href="#h25-0-75" id="h25-0-75" class="d">-                }
</a><a href="#h25-0-76" id="h25-0-76" class="d">-                Switch(
</a><a href="#h25-0-77" id="h25-0-77" class="d">-                    checked = enabled,
</a><a href="#h25-0-78" id="h25-0-78" class="d">-                    onCheckedChange = { isChecked -&gt;
</a><a href="#h25-0-79" id="h25-0-79" class="d">-                        context.modDatabase.setScriptEnabled(script.name, isChecked)
</a><a href="#h25-0-80" id="h25-0-80" class="d">-                        enabled = isChecked
</a><a href="#h25-0-81" id="h25-0-81" class="d">-                        runCatching {
</a><a href="#h25-0-82" id="h25-0-82" class="d">-                            val modulePath = context.scriptManager.getModulePath(script.name)!!
</a><a href="#h25-0-83" id="h25-0-83" class="d">-                            context.scriptManager.unloadScript(modulePath)
</a><a href="#h25-0-84" id="h25-0-84" class="d">-                            if (isChecked) {
</a><a href="#h25-0-85" id="h25-0-85" class="d">-                                context.scriptManager.loadScript(modulePath)
</a><a href="#h25-0-86" id="h25-0-86" class="d">-                                context.scriptManager.runtime.getModuleByName(script.name)
</a><a href="#h25-0-87" id="h25-0-87" class="d">-                                    ?.callFunction(&quot;module.onSnapEnhanceLoad&quot;)
</a><a href="#h25-0-88" id="h25-0-88" class="d">-                                context.shortToast(&quot;Loaded script ${script.name}&quot;)
</a><a href="#h25-0-89" id="h25-0-89" class="d">-                            } else {
</a><a href="#h25-0-90" id="h25-0-90" class="d">-                                context.shortToast(&quot;Unloaded script ${script.name}&quot;)
</a><a href="#h25-0-91" id="h25-0-91" class="d">-                            }
</a><a href="#h25-0-92" id="h25-0-92" class="d">-                        }.onFailure { throwable -&gt;
</a><a href="#h25-0-93" id="h25-0-93" class="d">-                            enabled = !isChecked
</a><a href="#h25-0-94" id="h25-0-94" class="d">-                            (&quot;Failed to ${if (isChecked) &quot;enable&quot; else &quot;disable&quot;} script&quot;).let {
</a><a href="#h25-0-95" id="h25-0-95" class="d">-                                context.log.error(it, throwable)
</a><a href="#h25-0-96" id="h25-0-96" class="d">-                                context.shortToast(it)
</a><a href="#h25-0-97" id="h25-0-97" class="d">-                            }
</a><a href="#h25-0-98" id="h25-0-98" class="d">-                        }
</a><a href="#h25-0-99" id="h25-0-99" class="d">-                    }
</a><a href="#h25-0-100" id="h25-0-100" class="d">-                )
</a><a href="#h25-0-101" id="h25-0-101" class="d">-            }
</a><a href="#h25-0-102" id="h25-0-102" class="d">-
</a><a href="#h25-0-103" id="h25-0-103" class="d">-            if (openSettings) {
</a><a href="#h25-0-104" id="h25-0-104" class="d">-                ScriptSettings(script)
</a><a href="#h25-0-105" id="h25-0-105" class="d">-            }
</a><a href="#h25-0-106" id="h25-0-106" class="d">-        }
</a><a href="#h25-0-107" id="h25-0-107" class="d">-    }
</a><a href="#h25-0-108" id="h25-0-108" class="d">-
</a><a href="#h25-0-109" id="h25-0-109" class="d">-    @Composable
</a><a href="#h25-0-110" id="h25-0-110" class="d">-    override fun FloatingActionButton() {
</a><a href="#h25-0-111" id="h25-0-111" class="d">-        Column(
</a><a href="#h25-0-112" id="h25-0-112" class="d">-            verticalArrangement = Arrangement.spacedBy(8.dp),
</a><a href="#h25-0-113" id="h25-0-113" class="d">-            horizontalAlignment = Alignment.End,
</a><a href="#h25-0-114" id="h25-0-114" class="d">-        ) {
</a><a href="#h25-0-115" id="h25-0-115" class="d">-            ExtendedFloatingActionButton(
</a><a href="#h25-0-116" id="h25-0-116" class="d">-                onClick = {
</a><a href="#h25-0-117" id="h25-0-117" class="d">-
</a><a href="#h25-0-118" id="h25-0-118" class="d">-                },
</a><a href="#h25-0-119" id="h25-0-119" class="d">-                icon= { Icon(imageVector = Icons.Default.Link, contentDescription = &quot;Link&quot;) },
</a><a href="#h25-0-120" id="h25-0-120" class="d">-                text = {
</a><a href="#h25-0-121" id="h25-0-121" class="d">-                    Text(text = &quot;Import from URL&quot;)
</a><a href="#h25-0-122" id="h25-0-122" class="d">-                },
</a><a href="#h25-0-123" id="h25-0-123" class="d">-            )
</a><a href="#h25-0-124" id="h25-0-124" class="d">-            ExtendedFloatingActionButton(
</a><a href="#h25-0-125" id="h25-0-125" class="d">-                onClick = {
</a><a href="#h25-0-126" id="h25-0-126" class="d">-                    context.scriptManager.getScriptsFolder()?.let {
</a><a href="#h25-0-127" id="h25-0-127" class="d">-                        context.androidContext.startActivity(
</a><a href="#h25-0-128" id="h25-0-128" class="d">-                            Intent(Intent.ACTION_VIEW).apply {
</a><a href="#h25-0-129" id="h25-0-129" class="d">-                                data = it.uri
</a><a href="#h25-0-130" id="h25-0-130" class="d">-                                flags = Intent.FLAG_ACTIVITY_NEW_TASK
</a><a href="#h25-0-131" id="h25-0-131" class="d">-                            }
</a><a href="#h25-0-132" id="h25-0-132" class="d">-                        )
</a><a href="#h25-0-133" id="h25-0-133" class="d">-                    }
</a><a href="#h25-0-134" id="h25-0-134" class="d">-                },
</a><a href="#h25-0-135" id="h25-0-135" class="d">-                icon= { Icon(imageVector = Icons.Default.FolderOpen, contentDescription = &quot;Folder&quot;) },
</a><a href="#h25-0-136" id="h25-0-136" class="d">-                text = {
</a><a href="#h25-0-137" id="h25-0-137" class="d">-                    Text(text = &quot;Open Scripts Folder&quot;)
</a><a href="#h25-0-138" id="h25-0-138" class="d">-                },
</a><a href="#h25-0-139" id="h25-0-139" class="d">-            )
</a><a href="#h25-0-140" id="h25-0-140" class="d">-        }
</a><a href="#h25-0-141" id="h25-0-141" class="d">-    }
</a><a href="#h25-0-142" id="h25-0-142" class="d">-
</a><a href="#h25-0-143" id="h25-0-143" class="d">-
</a><a href="#h25-0-144" id="h25-0-144" class="d">-    @Composable
</a><a href="#h25-0-145" id="h25-0-145" class="d">-    fun ScriptSettings(script: ModuleInfo) {
</a><a href="#h25-0-146" id="h25-0-146" class="d">-       val settingsInterface = remember {
</a><a href="#h25-0-147" id="h25-0-147" class="d">-            val module = context.scriptManager.runtime.getModuleByName(script.name) ?: return@remember null
</a><a href="#h25-0-148" id="h25-0-148" class="d">-            (module.getBinding(InterfaceManager::class))?.buildInterface(EnumScriptInterface.SETTINGS)
</a><a href="#h25-0-149" id="h25-0-149" class="d">-        }
</a><a href="#h25-0-150" id="h25-0-150" class="d">-
</a><a href="#h25-0-151" id="h25-0-151" class="d">-        if (settingsInterface == null) {
</a><a href="#h25-0-152" id="h25-0-152" class="d">-            Text(
</a><a href="#h25-0-153" id="h25-0-153" class="d">-                text = &quot;This module does not have any settings&quot;,
</a><a href="#h25-0-154" id="h25-0-154" class="d">-                style = MaterialTheme.typography.bodySmall,
</a><a href="#h25-0-155" id="h25-0-155" class="d">-                modifier = Modifier.padding(8.dp)
</a><a href="#h25-0-156" id="h25-0-156" class="d">-            )
</a><a href="#h25-0-157" id="h25-0-157" class="d">-        } else  {
</a><a href="#h25-0-158" id="h25-0-158" class="d">-            ScriptInterface(interfaceBuilder = settingsInterface)
</a><a href="#h25-0-159" id="h25-0-159" class="d">-        }
</a><a href="#h25-0-160" id="h25-0-160" class="d">-    }
</a><a href="#h25-0-161" id="h25-0-161" class="d">-
</a><a href="#h25-0-162" id="h25-0-162" class="d">-    @Composable
</a><a href="#h25-0-163" id="h25-0-163" class="d">-    override fun Content() {
</a><a href="#h25-0-164" id="h25-0-164" class="d">-        var scriptModules by remember { mutableStateOf(listOf&lt;ModuleInfo&gt;()) }
</a><a href="#h25-0-165" id="h25-0-165" class="d">-        var scriptingFolder by remember { mutableStateOf(null as DocumentFile?) }
</a><a href="#h25-0-166" id="h25-0-166" class="d">-        val coroutineScope = rememberCoroutineScope()
</a><a href="#h25-0-167" id="h25-0-167" class="d">-
</a><a href="#h25-0-168" id="h25-0-168" class="d">-        var refreshing by remember {
</a><a href="#h25-0-169" id="h25-0-169" class="d">-            mutableStateOf(false)
</a><a href="#h25-0-170" id="h25-0-170" class="d">-        }
</a><a href="#h25-0-171" id="h25-0-171" class="d">-
</a><a href="#h25-0-172" id="h25-0-172" class="d">-        fun syncScripts() {
</a><a href="#h25-0-173" id="h25-0-173" class="d">-            runCatching {
</a><a href="#h25-0-174" id="h25-0-174" class="d">-                scriptingFolder = context.scriptManager.getScriptsFolder()
</a><a href="#h25-0-175" id="h25-0-175" class="d">-                context.scriptManager.sync()
</a><a href="#h25-0-176" id="h25-0-176" class="d">-                scriptModules = context.modDatabase.getScripts()
</a><a href="#h25-0-177" id="h25-0-177" class="d">-            }.onFailure {
</a><a href="#h25-0-178" id="h25-0-178" class="d">-                context.log.error(&quot;Failed to sync scripts&quot;, it)
</a><a href="#h25-0-179" id="h25-0-179" class="d">-            }
</a><a href="#h25-0-180" id="h25-0-180" class="d">-        }
</a><a href="#h25-0-181" id="h25-0-181" class="d">-
</a><a href="#h25-0-182" id="h25-0-182" class="d">-        LaunchedEffect(Unit) {
</a><a href="#h25-0-183" id="h25-0-183" class="d">-            refreshing = true
</a><a href="#h25-0-184" id="h25-0-184" class="d">-            withContext(Dispatchers.IO) {
</a><a href="#h25-0-185" id="h25-0-185" class="d">-                syncScripts()
</a><a href="#h25-0-186" id="h25-0-186" class="d">-                refreshing = false
</a><a href="#h25-0-187" id="h25-0-187" class="d">-            }
</a><a href="#h25-0-188" id="h25-0-188" class="d">-        }
</a><a href="#h25-0-189" id="h25-0-189" class="d">-
</a><a href="#h25-0-190" id="h25-0-190" class="d">-        val pullRefreshState = rememberPullRefreshState(refreshing, onRefresh = {
</a><a href="#h25-0-191" id="h25-0-191" class="d">-            refreshing = true
</a><a href="#h25-0-192" id="h25-0-192" class="d">-            syncScripts()
</a><a href="#h25-0-193" id="h25-0-193" class="d">-            coroutineScope.launch {
</a><a href="#h25-0-194" id="h25-0-194" class="d">-                delay(300)
</a><a href="#h25-0-195" id="h25-0-195" class="d">-                refreshing = false
</a><a href="#h25-0-196" id="h25-0-196" class="d">-            }
</a><a href="#h25-0-197" id="h25-0-197" class="d">-        })
</a><a href="#h25-0-198" id="h25-0-198" class="d">-
</a><a href="#h25-0-199" id="h25-0-199" class="d">-        Box(
</a><a href="#h25-0-200" id="h25-0-200" class="d">-            modifier = Modifier.fillMaxSize()
</a><a href="#h25-0-201" id="h25-0-201" class="d">-        ) {
</a><a href="#h25-0-202" id="h25-0-202" class="d">-            LazyColumn(
</a><a href="#h25-0-203" id="h25-0-203" class="d">-                modifier = Modifier
</a><a href="#h25-0-204" id="h25-0-204" class="d">-                    .fillMaxSize()
</a><a href="#h25-0-205" id="h25-0-205" class="d">-                    .pullRefresh(pullRefreshState),
</a><a href="#h25-0-206" id="h25-0-206" class="d">-                horizontalAlignment = Alignment.CenterHorizontally
</a><a href="#h25-0-207" id="h25-0-207" class="d">-            ) {
</a><a href="#h25-0-208" id="h25-0-208" class="d">-                item {
</a><a href="#h25-0-209" id="h25-0-209" class="d">-                    if (scriptingFolder == null) {
</a><a href="#h25-0-210" id="h25-0-210" class="d">-                        Text(
</a><a href="#h25-0-211" id="h25-0-211" class="d">-                            text = &quot;No scripts folder selected&quot;,
</a><a href="#h25-0-212" id="h25-0-212" class="d">-                            style = MaterialTheme.typography.bodySmall,
</a><a href="#h25-0-213" id="h25-0-213" class="d">-                            modifier = Modifier.padding(8.dp)
</a><a href="#h25-0-214" id="h25-0-214" class="d">-                        )
</a><a href="#h25-0-215" id="h25-0-215" class="d">-                        Spacer(modifier = Modifier.height(8.dp))
</a><a href="#h25-0-216" id="h25-0-216" class="d">-                        Button(onClick = {
</a><a href="#h25-0-217" id="h25-0-217" class="d">-                            activityLauncherHelper.chooseFolder {
</a><a href="#h25-0-218" id="h25-0-218" class="d">-                                context.config.root.scripting.moduleFolder.set(it)
</a><a href="#h25-0-219" id="h25-0-219" class="d">-                                context.config.writeConfig()
</a><a href="#h25-0-220" id="h25-0-220" class="d">-                                coroutineScope.launch {
</a><a href="#h25-0-221" id="h25-0-221" class="d">-                                    syncScripts()
</a><a href="#h25-0-222" id="h25-0-222" class="d">-                                }
</a><a href="#h25-0-223" id="h25-0-223" class="d">-                            }
</a><a href="#h25-0-224" id="h25-0-224" class="d">-                        }) {
</a><a href="#h25-0-225" id="h25-0-225" class="d">-                            Text(text = &quot;Select folder&quot;)
</a><a href="#h25-0-226" id="h25-0-226" class="d">-                        }
</a><a href="#h25-0-227" id="h25-0-227" class="d">-                    } else if (scriptModules.isEmpty()) {
</a><a href="#h25-0-228" id="h25-0-228" class="d">-                        Text(
</a><a href="#h25-0-229" id="h25-0-229" class="d">-                            text = &quot;No scripts found&quot;,
</a><a href="#h25-0-230" id="h25-0-230" class="d">-                            style = MaterialTheme.typography.bodySmall,
</a><a href="#h25-0-231" id="h25-0-231" class="d">-                            modifier = Modifier.padding(8.dp)
</a><a href="#h25-0-232" id="h25-0-232" class="d">-                        )
</a><a href="#h25-0-233" id="h25-0-233" class="d">-                    }
</a><a href="#h25-0-234" id="h25-0-234" class="d">-                }
</a><a href="#h25-0-235" id="h25-0-235" class="d">-                items(scriptModules.size) { index -&gt;
</a><a href="#h25-0-236" id="h25-0-236" class="d">-                    ModuleItem(scriptModules[index])
</a><a href="#h25-0-237" id="h25-0-237" class="d">-                }
</a><a href="#h25-0-238" id="h25-0-238" class="d">-                item {
</a><a href="#h25-0-239" id="h25-0-239" class="d">-                    Spacer(modifier = Modifier.height(200.dp))
</a><a href="#h25-0-240" id="h25-0-240" class="d">-                }
</a><a href="#h25-0-241" id="h25-0-241" class="d">-            }
</a><a href="#h25-0-242" id="h25-0-242" class="d">-
</a><a href="#h25-0-243" id="h25-0-243" class="d">-            PullRefreshIndicator(
</a><a href="#h25-0-244" id="h25-0-244" class="d">-                refreshing = refreshing,
</a><a href="#h25-0-245" id="h25-0-245" class="d">-                state = pullRefreshState,
</a><a href="#h25-0-246" id="h25-0-246" class="d">-                modifier = Modifier.align(Alignment.TopCenter)
</a><a href="#h25-0-247" id="h25-0-247" class="d">-            )
</a><a href="#h25-0-248" id="h25-0-248" class="d">-        }
</a><a href="#h25-0-249" id="h25-0-249" class="d">-
</a><a href="#h25-0-250" id="h25-0-250" class="d">-        var scriptingWarning by remember {
</a><a href="#h25-0-251" id="h25-0-251" class="d">-            mutableStateOf(context.sharedPreferences.run {
</a><a href="#h25-0-252" id="h25-0-252" class="d">-                getBoolean(&quot;scripting_warning&quot;, true).also {
</a><a href="#h25-0-253" id="h25-0-253" class="d">-                    edit().putBoolean(&quot;scripting_warning&quot;, false).apply()
</a><a href="#h25-0-254" id="h25-0-254" class="d">-                }
</a><a href="#h25-0-255" id="h25-0-255" class="d">-            })
</a><a href="#h25-0-256" id="h25-0-256" class="d">-        }
</a><a href="#h25-0-257" id="h25-0-257" class="d">-
</a><a href="#h25-0-258" id="h25-0-258" class="d">-        if (scriptingWarning) {
</a><a href="#h25-0-259" id="h25-0-259" class="d">-            var timeout by remember {
</a><a href="#h25-0-260" id="h25-0-260" class="d">-                mutableIntStateOf(10)
</a><a href="#h25-0-261" id="h25-0-261" class="d">-            }
</a><a href="#h25-0-262" id="h25-0-262" class="d">-
</a><a href="#h25-0-263" id="h25-0-263" class="d">-            LaunchedEffect(Unit) {
</a><a href="#h25-0-264" id="h25-0-264" class="d">-                while (timeout &gt; 0) {
</a><a href="#h25-0-265" id="h25-0-265" class="d">-                    delay(1000)
</a><a href="#h25-0-266" id="h25-0-266" class="d">-                    timeout--
</a><a href="#h25-0-267" id="h25-0-267" class="d">-                }
</a><a href="#h25-0-268" id="h25-0-268" class="d">-            }
</a><a href="#h25-0-269" id="h25-0-269" class="d">-
</a><a href="#h25-0-270" id="h25-0-270" class="d">-            AlertDialog(onDismissRequest = {
</a><a href="#h25-0-271" id="h25-0-271" class="d">-                if (timeout == 0) {
</a><a href="#h25-0-272" id="h25-0-272" class="d">-                    scriptingWarning = false
</a><a href="#h25-0-273" id="h25-0-273" class="d">-                }
</a><a href="#h25-0-274" id="h25-0-274" class="d">-            }, title = {
</a><a href="#h25-0-275" id="h25-0-275" class="d">-                Text(text = context.translation[&quot;manager.dialogs.scripting_warning.title&quot;])
</a><a href="#h25-0-276" id="h25-0-276" class="d">-            }, text = {
</a><a href="#h25-0-277" id="h25-0-277" class="d">-                Text(text = context.translation[&quot;manager.dialogs.scripting_warning.content&quot;])
</a><a href="#h25-0-278" id="h25-0-278" class="d">-            }, confirmButton = {
</a><a href="#h25-0-279" id="h25-0-279" class="d">-                TextButton(
</a><a href="#h25-0-280" id="h25-0-280" class="d">-                    onClick = {
</a><a href="#h25-0-281" id="h25-0-281" class="d">-                        scriptingWarning = false
</a><a href="#h25-0-282" id="h25-0-282" class="d">-                    },
</a><a href="#h25-0-283" id="h25-0-283" class="d">-                    enabled = timeout == 0
</a><a href="#h25-0-284" id="h25-0-284" class="d">-                ) {
</a><a href="#h25-0-285" id="h25-0-285" class="d">-                    Text(text = &quot;OK &quot; + if (timeout &gt; 0) &quot;($timeout)&quot; else &quot;&quot;)
</a><a href="#h25-0-286" id="h25-0-286" class="d">-                }
</a><a href="#h25-0-287" id="h25-0-287" class="d">-            })
</a><a href="#h25-0-288" id="h25-0-288" class="d">-        }
</a><a href="#h25-0-289" id="h25-0-289" class="d">-    }
</a><a href="#h25-0-290" id="h25-0-290" class="d">-
</a><a href="#h25-0-291" id="h25-0-291" class="d">-    @Composable
</a><a href="#h25-0-292" id="h25-0-292" class="d">-    override fun TopBarActions(rowScope: RowScope) {
</a><a href="#h25-0-293" id="h25-0-293" class="d">-        rowScope.apply {
</a><a href="#h25-0-294" id="h25-0-294" class="d">-            IconButton(onClick = {
</a><a href="#h25-0-295" id="h25-0-295" class="d">-                context.androidContext.startActivity(Intent(Intent.ACTION_VIEW).apply {
</a><a href="#h25-0-296" id="h25-0-296" class="d">-                    data = &quot;https://github.com/SnapEnhance/docs&quot;.toUri()
</a><a href="#h25-0-297" id="h25-0-297" class="d">-                    flags = Intent.FLAG_ACTIVITY_NEW_TASK
</a><a href="#h25-0-298" id="h25-0-298" class="d">-                })
</a><a href="#h25-0-299" id="h25-0-299" class="d">-            }) {
</a><a href="#h25-0-300" id="h25-0-300" class="d">-                Icon(imageVector = Icons.Default.LibraryBooks, contentDescription = &quot;Documentation&quot;)
</a><a href="#h25-0-301" id="h25-0-301" class="d">-            }
</a><a href="#h25-0-302" id="h25-0-302" class="d">-        }
</a><a href="#h25-0-303" id="h25-0-303" class="d">-    }
</a><a href="#h25-0-304" id="h25-0-304" class="d">-}</a><a href="#h25-0-305" id="h25-0-305" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h26" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/social/AddFriendDialog.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/social/AddFriendDialog.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/social/AddFriendDialog.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/social/AddFriendDialog.kt</a></b>
<a href="#h26-0" id="h26-0" class="h">@@ -1,263 +0,0 @@
</a><a href="#h26-0-0" id="h26-0-0" class="d">-package me.rhunk.snapenhance.ui.manager.sections.social
</a><a href="#h26-0-1" id="h26-0-1" class="d">-
</a><a href="#h26-0-2" id="h26-0-2" class="d">-import androidx.compose.foundation.clickable
</a><a href="#h26-0-3" id="h26-0-3" class="d">-import androidx.compose.foundation.layout.*
</a><a href="#h26-0-4" id="h26-0-4" class="d">-import androidx.compose.foundation.lazy.LazyColumn
</a><a href="#h26-0-5" id="h26-0-5" class="d">-import androidx.compose.foundation.text.KeyboardOptions
</a><a href="#h26-0-6" id="h26-0-6" class="d">-import androidx.compose.material.icons.Icons
</a><a href="#h26-0-7" id="h26-0-7" class="d">-import androidx.compose.material.icons.filled.Search
</a><a href="#h26-0-8" id="h26-0-8" class="d">-import androidx.compose.material3.*
</a><a href="#h26-0-9" id="h26-0-9" class="d">-import androidx.compose.runtime.*
</a><a href="#h26-0-10" id="h26-0-10" class="d">-import androidx.compose.ui.Alignment
</a><a href="#h26-0-11" id="h26-0-11" class="d">-import androidx.compose.ui.Modifier
</a><a href="#h26-0-12" id="h26-0-12" class="d">-import androidx.compose.ui.layout.onGloballyPositioned
</a><a href="#h26-0-13" id="h26-0-13" class="d">-import androidx.compose.ui.text.font.FontWeight
</a><a href="#h26-0-14" id="h26-0-14" class="d">-import androidx.compose.ui.text.input.ImeAction
</a><a href="#h26-0-15" id="h26-0-15" class="d">-import androidx.compose.ui.text.input.KeyboardType
</a><a href="#h26-0-16" id="h26-0-16" class="d">-import androidx.compose.ui.unit.dp
</a><a href="#h26-0-17" id="h26-0-17" class="d">-import androidx.compose.ui.unit.sp
</a><a href="#h26-0-18" id="h26-0-18" class="d">-import androidx.compose.ui.window.Dialog
</a><a href="#h26-0-19" id="h26-0-19" class="d">-import androidx.compose.ui.window.DialogProperties
</a><a href="#h26-0-20" id="h26-0-20" class="d">-import kotlinx.coroutines.Dispatchers
</a><a href="#h26-0-21" id="h26-0-21" class="d">-import kotlinx.coroutines.Job
</a><a href="#h26-0-22" id="h26-0-22" class="d">-import kotlinx.coroutines.delay
</a><a href="#h26-0-23" id="h26-0-23" class="d">-import kotlinx.coroutines.launch
</a><a href="#h26-0-24" id="h26-0-24" class="d">-import kotlinx.coroutines.withContext
</a><a href="#h26-0-25" id="h26-0-25" class="d">-import me.rhunk.snapenhance.RemoteSideContext
</a><a href="#h26-0-26" id="h26-0-26" class="d">-import me.rhunk.snapenhance.common.ReceiversConfig
</a><a href="#h26-0-27" id="h26-0-27" class="d">-import me.rhunk.snapenhance.common.data.MessagingFriendInfo
</a><a href="#h26-0-28" id="h26-0-28" class="d">-import me.rhunk.snapenhance.common.data.MessagingGroupInfo
</a><a href="#h26-0-29" id="h26-0-29" class="d">-import me.rhunk.snapenhance.common.data.SocialScope
</a><a href="#h26-0-30" id="h26-0-30" class="d">-import me.rhunk.snapenhance.common.util.snap.SnapWidgetBroadcastReceiverHelper
</a><a href="#h26-0-31" id="h26-0-31" class="d">-
</a><a href="#h26-0-32" id="h26-0-32" class="d">-class AddFriendDialog(
</a><a href="#h26-0-33" id="h26-0-33" class="d">-    private val context: RemoteSideContext,
</a><a href="#h26-0-34" id="h26-0-34" class="d">-    private val section: SocialSection,
</a><a href="#h26-0-35" id="h26-0-35" class="d">-) {
</a><a href="#h26-0-36" id="h26-0-36" class="d">-
</a><a href="#h26-0-37" id="h26-0-37" class="d">-    private val translation by lazy { context.translation.getCategory(&quot;manager.dialogs.add_friend&quot;)}
</a><a href="#h26-0-38" id="h26-0-38" class="d">-
</a><a href="#h26-0-39" id="h26-0-39" class="d">-    @Composable
</a><a href="#h26-0-40" id="h26-0-40" class="d">-    private fun ListCardEntry(name: String, getCurrentState: () -&gt; Boolean, onState: (Boolean) -&gt; Unit = {}) {
</a><a href="#h26-0-41" id="h26-0-41" class="d">-        var currentState by remember { mutableStateOf(getCurrentState()) }
</a><a href="#h26-0-42" id="h26-0-42" class="d">-
</a><a href="#h26-0-43" id="h26-0-43" class="d">-        Row(
</a><a href="#h26-0-44" id="h26-0-44" class="d">-            modifier = Modifier
</a><a href="#h26-0-45" id="h26-0-45" class="d">-                .fillMaxWidth()
</a><a href="#h26-0-46" id="h26-0-46" class="d">-                .clickable {
</a><a href="#h26-0-47" id="h26-0-47" class="d">-                    currentState = !currentState
</a><a href="#h26-0-48" id="h26-0-48" class="d">-                    onState(currentState)
</a><a href="#h26-0-49" id="h26-0-49" class="d">-                }
</a><a href="#h26-0-50" id="h26-0-50" class="d">-                .padding(4.dp),
</a><a href="#h26-0-51" id="h26-0-51" class="d">-            verticalAlignment = Alignment.CenterVertically
</a><a href="#h26-0-52" id="h26-0-52" class="d">-        ) {
</a><a href="#h26-0-53" id="h26-0-53" class="d">-            Text(
</a><a href="#h26-0-54" id="h26-0-54" class="d">-                text = name,
</a><a href="#h26-0-55" id="h26-0-55" class="d">-                fontSize = 15.sp,
</a><a href="#h26-0-56" id="h26-0-56" class="d">-                modifier = Modifier
</a><a href="#h26-0-57" id="h26-0-57" class="d">-                    .weight(1f)
</a><a href="#h26-0-58" id="h26-0-58" class="d">-                    .onGloballyPositioned {
</a><a href="#h26-0-59" id="h26-0-59" class="d">-                        currentState = getCurrentState()
</a><a href="#h26-0-60" id="h26-0-60" class="d">-                    }
</a><a href="#h26-0-61" id="h26-0-61" class="d">-            )
</a><a href="#h26-0-62" id="h26-0-62" class="d">-
</a><a href="#h26-0-63" id="h26-0-63" class="d">-            Checkbox(
</a><a href="#h26-0-64" id="h26-0-64" class="d">-                checked = currentState,
</a><a href="#h26-0-65" id="h26-0-65" class="d">-                onCheckedChange = {
</a><a href="#h26-0-66" id="h26-0-66" class="d">-                    currentState = it
</a><a href="#h26-0-67" id="h26-0-67" class="d">-                    onState(currentState)
</a><a href="#h26-0-68" id="h26-0-68" class="d">-                }
</a><a href="#h26-0-69" id="h26-0-69" class="d">-            )
</a><a href="#h26-0-70" id="h26-0-70" class="d">-        }
</a><a href="#h26-0-71" id="h26-0-71" class="d">-    }
</a><a href="#h26-0-72" id="h26-0-72" class="d">-
</a><a href="#h26-0-73" id="h26-0-73" class="d">-    @Composable
</a><a href="#h26-0-74" id="h26-0-74" class="d">-    private fun DialogHeader(searchKeyword: MutableState&lt;String&gt;) {
</a><a href="#h26-0-75" id="h26-0-75" class="d">-        Column(
</a><a href="#h26-0-76" id="h26-0-76" class="d">-            modifier = Modifier
</a><a href="#h26-0-77" id="h26-0-77" class="d">-                .fillMaxWidth()
</a><a href="#h26-0-78" id="h26-0-78" class="d">-                .padding(10.dp),
</a><a href="#h26-0-79" id="h26-0-79" class="d">-        ) {
</a><a href="#h26-0-80" id="h26-0-80" class="d">-            Text(
</a><a href="#h26-0-81" id="h26-0-81" class="d">-                text = translation[&quot;title&quot;],
</a><a href="#h26-0-82" id="h26-0-82" class="d">-                fontSize = 23.sp,
</a><a href="#h26-0-83" id="h26-0-83" class="d">-                fontWeight = FontWeight.ExtraBold,
</a><a href="#h26-0-84" id="h26-0-84" class="d">-                modifier = Modifier
</a><a href="#h26-0-85" id="h26-0-85" class="d">-                    .align(alignment = Alignment.CenterHorizontally)
</a><a href="#h26-0-86" id="h26-0-86" class="d">-            )
</a><a href="#h26-0-87" id="h26-0-87" class="d">-        }
</a><a href="#h26-0-88" id="h26-0-88" class="d">-
</a><a href="#h26-0-89" id="h26-0-89" class="d">-        Row(
</a><a href="#h26-0-90" id="h26-0-90" class="d">-            modifier = Modifier
</a><a href="#h26-0-91" id="h26-0-91" class="d">-                .fillMaxWidth()
</a><a href="#h26-0-92" id="h26-0-92" class="d">-                .padding(10.dp),
</a><a href="#h26-0-93" id="h26-0-93" class="d">-            verticalAlignment = Alignment.CenterVertically
</a><a href="#h26-0-94" id="h26-0-94" class="d">-        ) {
</a><a href="#h26-0-95" id="h26-0-95" class="d">-            TextField(
</a><a href="#h26-0-96" id="h26-0-96" class="d">-                value = searchKeyword.value,
</a><a href="#h26-0-97" id="h26-0-97" class="d">-                onValueChange = { searchKeyword.value = it },
</a><a href="#h26-0-98" id="h26-0-98" class="d">-                label = {
</a><a href="#h26-0-99" id="h26-0-99" class="d">-                    Text(text = translation[&quot;search_hint&quot;])
</a><a href="#h26-0-100" id="h26-0-100" class="d">-                },
</a><a href="#h26-0-101" id="h26-0-101" class="d">-                modifier = Modifier
</a><a href="#h26-0-102" id="h26-0-102" class="d">-                    .weight(1f)
</a><a href="#h26-0-103" id="h26-0-103" class="d">-                    .padding(end = 10.dp),
</a><a href="#h26-0-104" id="h26-0-104" class="d">-                keyboardOptions = KeyboardOptions(keyboardType = KeyboardType.Text, imeAction = ImeAction.Done),
</a><a href="#h26-0-105" id="h26-0-105" class="d">-                leadingIcon = {
</a><a href="#h26-0-106" id="h26-0-106" class="d">-                    Icon(Icons.Filled.Search, contentDescription = &quot;Search&quot;)
</a><a href="#h26-0-107" id="h26-0-107" class="d">-                }
</a><a href="#h26-0-108" id="h26-0-108" class="d">-            )
</a><a href="#h26-0-109" id="h26-0-109" class="d">-        }
</a><a href="#h26-0-110" id="h26-0-110" class="d">-    }
</a><a href="#h26-0-111" id="h26-0-111" class="d">-
</a><a href="#h26-0-112" id="h26-0-112" class="d">-
</a><a href="#h26-0-113" id="h26-0-113" class="d">-    @Composable
</a><a href="#h26-0-114" id="h26-0-114" class="d">-    fun Content(dismiss: () -&gt; Unit = { }) {
</a><a href="#h26-0-115" id="h26-0-115" class="d">-        var cachedFriends by remember { mutableStateOf(null as List&lt;MessagingFriendInfo&gt;?) }
</a><a href="#h26-0-116" id="h26-0-116" class="d">-        var cachedGroups by remember { mutableStateOf(null as List&lt;MessagingGroupInfo&gt;?) }
</a><a href="#h26-0-117" id="h26-0-117" class="d">-
</a><a href="#h26-0-118" id="h26-0-118" class="d">-        val coroutineScope = rememberCoroutineScope()
</a><a href="#h26-0-119" id="h26-0-119" class="d">-
</a><a href="#h26-0-120" id="h26-0-120" class="d">-        var timeoutJob: Job? = null
</a><a href="#h26-0-121" id="h26-0-121" class="d">-        var hasFetchError by remember { mutableStateOf(false) }
</a><a href="#h26-0-122" id="h26-0-122" class="d">-
</a><a href="#h26-0-123" id="h26-0-123" class="d">-        LaunchedEffect(Unit) {
</a><a href="#h26-0-124" id="h26-0-124" class="d">-            context.modDatabase.receiveMessagingDataCallback = { friends, groups -&gt;
</a><a href="#h26-0-125" id="h26-0-125" class="d">-                cachedFriends = friends
</a><a href="#h26-0-126" id="h26-0-126" class="d">-                cachedGroups = groups
</a><a href="#h26-0-127" id="h26-0-127" class="d">-                timeoutJob?.cancel()
</a><a href="#h26-0-128" id="h26-0-128" class="d">-                hasFetchError = false
</a><a href="#h26-0-129" id="h26-0-129" class="d">-            }
</a><a href="#h26-0-130" id="h26-0-130" class="d">-            SnapWidgetBroadcastReceiverHelper.create(ReceiversConfig.BRIDGE_SYNC_ACTION) {}.also {
</a><a href="#h26-0-131" id="h26-0-131" class="d">-                runCatching {
</a><a href="#h26-0-132" id="h26-0-132" class="d">-                    context.androidContext.sendBroadcast(it)
</a><a href="#h26-0-133" id="h26-0-133" class="d">-                }.onFailure {
</a><a href="#h26-0-134" id="h26-0-134" class="d">-                    context.log.error(&quot;Failed to send broadcast&quot;, it)
</a><a href="#h26-0-135" id="h26-0-135" class="d">-                    hasFetchError = true
</a><a href="#h26-0-136" id="h26-0-136" class="d">-                }
</a><a href="#h26-0-137" id="h26-0-137" class="d">-            }
</a><a href="#h26-0-138" id="h26-0-138" class="d">-            timeoutJob = coroutineScope.launch {
</a><a href="#h26-0-139" id="h26-0-139" class="d">-                withContext(Dispatchers.IO) {
</a><a href="#h26-0-140" id="h26-0-140" class="d">-                    delay(10000)
</a><a href="#h26-0-141" id="h26-0-141" class="d">-                    hasFetchError = true
</a><a href="#h26-0-142" id="h26-0-142" class="d">-                }
</a><a href="#h26-0-143" id="h26-0-143" class="d">-            }
</a><a href="#h26-0-144" id="h26-0-144" class="d">-        }
</a><a href="#h26-0-145" id="h26-0-145" class="d">-
</a><a href="#h26-0-146" id="h26-0-146" class="d">-        Dialog(
</a><a href="#h26-0-147" id="h26-0-147" class="d">-            onDismissRequest = {
</a><a href="#h26-0-148" id="h26-0-148" class="d">-                timeoutJob?.cancel()
</a><a href="#h26-0-149" id="h26-0-149" class="d">-                dismiss()
</a><a href="#h26-0-150" id="h26-0-150" class="d">-            },
</a><a href="#h26-0-151" id="h26-0-151" class="d">-            properties = DialogProperties(usePlatformDefaultWidth = false)
</a><a href="#h26-0-152" id="h26-0-152" class="d">-        ) {
</a><a href="#h26-0-153" id="h26-0-153" class="d">-            Card(
</a><a href="#h26-0-154" id="h26-0-154" class="d">-                colors = CardDefaults.elevatedCardColors(),
</a><a href="#h26-0-155" id="h26-0-155" class="d">-                modifier = Modifier
</a><a href="#h26-0-156" id="h26-0-156" class="d">-                    .fillMaxSize()
</a><a href="#h26-0-157" id="h26-0-157" class="d">-                    .fillMaxWidth()
</a><a href="#h26-0-158" id="h26-0-158" class="d">-                    .padding(all = 20.dp)
</a><a href="#h26-0-159" id="h26-0-159" class="d">-            ) {
</a><a href="#h26-0-160" id="h26-0-160" class="d">-                if (cachedGroups == null || cachedFriends == null) {
</a><a href="#h26-0-161" id="h26-0-161" class="d">-                    Column(
</a><a href="#h26-0-162" id="h26-0-162" class="d">-                        modifier = Modifier
</a><a href="#h26-0-163" id="h26-0-163" class="d">-                            .fillMaxSize()
</a><a href="#h26-0-164" id="h26-0-164" class="d">-                            .padding(10.dp),
</a><a href="#h26-0-165" id="h26-0-165" class="d">-                        verticalArrangement = Arrangement.Center,
</a><a href="#h26-0-166" id="h26-0-166" class="d">-                        horizontalAlignment = Alignment.CenterHorizontally
</a><a href="#h26-0-167" id="h26-0-167" class="d">-                    ) {
</a><a href="#h26-0-168" id="h26-0-168" class="d">-                        if (hasFetchError) {
</a><a href="#h26-0-169" id="h26-0-169" class="d">-                            Text(
</a><a href="#h26-0-170" id="h26-0-170" class="d">-                                text = translation[&quot;fetch_error&quot;],
</a><a href="#h26-0-171" id="h26-0-171" class="d">-                                fontSize = 20.sp,
</a><a href="#h26-0-172" id="h26-0-172" class="d">-                                fontWeight = FontWeight.Bold,
</a><a href="#h26-0-173" id="h26-0-173" class="d">-                                modifier = Modifier.padding(bottom = 10.dp, top = 10.dp)
</a><a href="#h26-0-174" id="h26-0-174" class="d">-                            )
</a><a href="#h26-0-175" id="h26-0-175" class="d">-                            return@Card
</a><a href="#h26-0-176" id="h26-0-176" class="d">-                        }
</a><a href="#h26-0-177" id="h26-0-177" class="d">-                        CircularProgressIndicator(
</a><a href="#h26-0-178" id="h26-0-178" class="d">-                            modifier = Modifier
</a><a href="#h26-0-179" id="h26-0-179" class="d">-                                .padding()
</a><a href="#h26-0-180" id="h26-0-180" class="d">-                                .size(30.dp),
</a><a href="#h26-0-181" id="h26-0-181" class="d">-                            strokeWidth = 3.dp,
</a><a href="#h26-0-182" id="h26-0-182" class="d">-                            color = MaterialTheme.colorScheme.primary
</a><a href="#h26-0-183" id="h26-0-183" class="d">-                        )
</a><a href="#h26-0-184" id="h26-0-184" class="d">-                    }
</a><a href="#h26-0-185" id="h26-0-185" class="d">-                    return@Card
</a><a href="#h26-0-186" id="h26-0-186" class="d">-                }
</a><a href="#h26-0-187" id="h26-0-187" class="d">-
</a><a href="#h26-0-188" id="h26-0-188" class="d">-                val searchKeyword = remember { mutableStateOf(&quot;&quot;) }
</a><a href="#h26-0-189" id="h26-0-189" class="d">-
</a><a href="#h26-0-190" id="h26-0-190" class="d">-                val filteredGroups = cachedGroups!!.takeIf { searchKeyword.value.isNotBlank() }?.filter {
</a><a href="#h26-0-191" id="h26-0-191" class="d">-                    it.name.contains(searchKeyword.value, ignoreCase = true)
</a><a href="#h26-0-192" id="h26-0-192" class="d">-                } ?: cachedGroups!!
</a><a href="#h26-0-193" id="h26-0-193" class="d">-
</a><a href="#h26-0-194" id="h26-0-194" class="d">-                val filteredFriends = cachedFriends!!.takeIf { searchKeyword.value.isNotBlank() }?.filter {
</a><a href="#h26-0-195" id="h26-0-195" class="d">-                    it.mutableUsername.contains(searchKeyword.value, ignoreCase = true) ||
</a><a href="#h26-0-196" id="h26-0-196" class="d">-                    it.displayName?.contains(searchKeyword.value, ignoreCase = true) == true
</a><a href="#h26-0-197" id="h26-0-197" class="d">-                } ?: cachedFriends!!
</a><a href="#h26-0-198" id="h26-0-198" class="d">-
</a><a href="#h26-0-199" id="h26-0-199" class="d">-                DialogHeader(searchKeyword)
</a><a href="#h26-0-200" id="h26-0-200" class="d">-
</a><a href="#h26-0-201" id="h26-0-201" class="d">-                LazyColumn(
</a><a href="#h26-0-202" id="h26-0-202" class="d">-                    modifier = Modifier
</a><a href="#h26-0-203" id="h26-0-203" class="d">-                        .fillMaxSize()
</a><a href="#h26-0-204" id="h26-0-204" class="d">-                        .padding(10.dp)
</a><a href="#h26-0-205" id="h26-0-205" class="d">-                ) {
</a><a href="#h26-0-206" id="h26-0-206" class="d">-                    item {
</a><a href="#h26-0-207" id="h26-0-207" class="d">-                        if (filteredGroups.isEmpty()) return@item
</a><a href="#h26-0-208" id="h26-0-208" class="d">-                        Text(text = translation[&quot;category_groups&quot;],
</a><a href="#h26-0-209" id="h26-0-209" class="d">-                            fontSize = 20.sp,
</a><a href="#h26-0-210" id="h26-0-210" class="d">-                            fontWeight = FontWeight.Bold,
</a><a href="#h26-0-211" id="h26-0-211" class="d">-                            modifier = Modifier.padding(bottom = 10.dp, top = 10.dp)
</a><a href="#h26-0-212" id="h26-0-212" class="d">-                        )
</a><a href="#h26-0-213" id="h26-0-213" class="d">-                    }
</a><a href="#h26-0-214" id="h26-0-214" class="d">-
</a><a href="#h26-0-215" id="h26-0-215" class="d">-                    items(filteredGroups.size) {
</a><a href="#h26-0-216" id="h26-0-216" class="d">-                        val group = filteredGroups[it]
</a><a href="#h26-0-217" id="h26-0-217" class="d">-                        ListCardEntry(
</a><a href="#h26-0-218" id="h26-0-218" class="d">-                            name = group.name,
</a><a href="#h26-0-219" id="h26-0-219" class="d">-                            getCurrentState = { context.modDatabase.getGroupInfo(group.conversationId) != null }
</a><a href="#h26-0-220" id="h26-0-220" class="d">-                        ) { state -&gt;
</a><a href="#h26-0-221" id="h26-0-221" class="d">-                            if (state) {
</a><a href="#h26-0-222" id="h26-0-222" class="d">-                                context.bridgeService?.triggerScopeSync(SocialScope.GROUP, group.conversationId)
</a><a href="#h26-0-223" id="h26-0-223" class="d">-                            } else {
</a><a href="#h26-0-224" id="h26-0-224" class="d">-                                context.modDatabase.deleteGroup(group.conversationId)
</a><a href="#h26-0-225" id="h26-0-225" class="d">-                            }
</a><a href="#h26-0-226" id="h26-0-226" class="d">-                            context.modDatabase.executeAsync {
</a><a href="#h26-0-227" id="h26-0-227" class="d">-                                section.onResumed()
</a><a href="#h26-0-228" id="h26-0-228" class="d">-                            }
</a><a href="#h26-0-229" id="h26-0-229" class="d">-                        }
</a><a href="#h26-0-230" id="h26-0-230" class="d">-                    }
</a><a href="#h26-0-231" id="h26-0-231" class="d">-
</a><a href="#h26-0-232" id="h26-0-232" class="d">-                    item {
</a><a href="#h26-0-233" id="h26-0-233" class="d">-                        if (filteredFriends.isEmpty()) return@item
</a><a href="#h26-0-234" id="h26-0-234" class="d">-                        Text(text = translation[&quot;category_friends&quot;],
</a><a href="#h26-0-235" id="h26-0-235" class="d">-                            fontSize = 20.sp,
</a><a href="#h26-0-236" id="h26-0-236" class="d">-                            fontWeight = FontWeight.Bold,
</a><a href="#h26-0-237" id="h26-0-237" class="d">-                            modifier = Modifier.padding(bottom = 10.dp, top = 10.dp)
</a><a href="#h26-0-238" id="h26-0-238" class="d">-                        )
</a><a href="#h26-0-239" id="h26-0-239" class="d">-                    }
</a><a href="#h26-0-240" id="h26-0-240" class="d">-
</a><a href="#h26-0-241" id="h26-0-241" class="d">-                    items(filteredFriends.size) {
</a><a href="#h26-0-242" id="h26-0-242" class="d">-                        val friend = filteredFriends[it]
</a><a href="#h26-0-243" id="h26-0-243" class="d">-
</a><a href="#h26-0-244" id="h26-0-244" class="d">-                        ListCardEntry(
</a><a href="#h26-0-245" id="h26-0-245" class="d">-                            name = friend.displayName?.takeIf { name -&gt; name.isNotBlank() } ?: friend.mutableUsername,
</a><a href="#h26-0-246" id="h26-0-246" class="d">-                            getCurrentState = { context.modDatabase.getFriendInfo(friend.userId) != null }
</a><a href="#h26-0-247" id="h26-0-247" class="d">-                        ) { state -&gt;
</a><a href="#h26-0-248" id="h26-0-248" class="d">-                            if (state) {
</a><a href="#h26-0-249" id="h26-0-249" class="d">-                                context.bridgeService?.triggerScopeSync(SocialScope.FRIEND, friend.userId)
</a><a href="#h26-0-250" id="h26-0-250" class="d">-                            } else {
</a><a href="#h26-0-251" id="h26-0-251" class="d">-                                context.modDatabase.deleteFriend(friend.userId)
</a><a href="#h26-0-252" id="h26-0-252" class="d">-                            }
</a><a href="#h26-0-253" id="h26-0-253" class="d">-                            context.modDatabase.executeAsync {
</a><a href="#h26-0-254" id="h26-0-254" class="d">-                                section.onResumed()
</a><a href="#h26-0-255" id="h26-0-255" class="d">-                            }
</a><a href="#h26-0-256" id="h26-0-256" class="d">-                        }
</a><a href="#h26-0-257" id="h26-0-257" class="d">-                    }
</a><a href="#h26-0-258" id="h26-0-258" class="d">-                }
</a><a href="#h26-0-259" id="h26-0-259" class="d">-            }
</a><a href="#h26-0-260" id="h26-0-260" class="d">-        }
</a><a href="#h26-0-261" id="h26-0-261" class="d">-    }
</a><a href="#h26-0-262" id="h26-0-262" class="d">-}</a><a href="#h26-0-263" id="h26-0-263" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h27" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/social/LoggedStories.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/social/LoggedStories.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/social/LoggedStories.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/social/LoggedStories.kt</a></b>
<a href="#h27-0" id="h27-0" class="h">@@ -1,276 +0,0 @@
</a><a href="#h27-0-0" id="h27-0-0" class="d">-package me.rhunk.snapenhance.ui.manager.sections.social
</a><a href="#h27-0-1" id="h27-0-1" class="d">-
</a><a href="#h27-0-2" id="h27-0-2" class="d">-import android.content.Intent
</a><a href="#h27-0-3" id="h27-0-3" class="d">-import android.graphics.Bitmap
</a><a href="#h27-0-4" id="h27-0-4" class="d">-import android.graphics.BitmapFactory
</a><a href="#h27-0-5" id="h27-0-5" class="d">-import androidx.compose.foundation.Image
</a><a href="#h27-0-6" id="h27-0-6" class="d">-import androidx.compose.foundation.clickable
</a><a href="#h27-0-7" id="h27-0-7" class="d">-import androidx.compose.foundation.layout.*
</a><a href="#h27-0-8" id="h27-0-8" class="d">-import androidx.compose.foundation.lazy.grid.GridCells
</a><a href="#h27-0-9" id="h27-0-9" class="d">-import androidx.compose.foundation.lazy.grid.LazyVerticalGrid
</a><a href="#h27-0-10" id="h27-0-10" class="d">-import androidx.compose.foundation.lazy.grid.items
</a><a href="#h27-0-11" id="h27-0-11" class="d">-import androidx.compose.material3.Button
</a><a href="#h27-0-12" id="h27-0-12" class="d">-import androidx.compose.material3.Card
</a><a href="#h27-0-13" id="h27-0-13" class="d">-import androidx.compose.material3.CircularProgressIndicator
</a><a href="#h27-0-14" id="h27-0-14" class="d">-import androidx.compose.material3.Text
</a><a href="#h27-0-15" id="h27-0-15" class="d">-import androidx.compose.runtime.*
</a><a href="#h27-0-16" id="h27-0-16" class="d">-import androidx.compose.ui.Alignment
</a><a href="#h27-0-17" id="h27-0-17" class="d">-import androidx.compose.ui.Modifier
</a><a href="#h27-0-18" id="h27-0-18" class="d">-import androidx.compose.ui.graphics.ImageBitmap
</a><a href="#h27-0-19" id="h27-0-19" class="d">-import androidx.compose.ui.graphics.asImageBitmap
</a><a href="#h27-0-20" id="h27-0-20" class="d">-import androidx.compose.ui.text.style.TextAlign
</a><a href="#h27-0-21" id="h27-0-21" class="d">-import androidx.compose.ui.unit.dp
</a><a href="#h27-0-22" id="h27-0-22" class="d">-import androidx.core.content.FileProvider
</a><a href="#h27-0-23" id="h27-0-23" class="d">-import coil.annotation.ExperimentalCoilApi
</a><a href="#h27-0-24" id="h27-0-24" class="d">-import coil.disk.DiskCache
</a><a href="#h27-0-25" id="h27-0-25" class="d">-import kotlinx.coroutines.Dispatchers
</a><a href="#h27-0-26" id="h27-0-26" class="d">-import kotlinx.coroutines.withContext
</a><a href="#h27-0-27" id="h27-0-27" class="d">-import kotlinx.coroutines.withTimeout
</a><a href="#h27-0-28" id="h27-0-28" class="d">-import me.rhunk.snapenhance.RemoteSideContext
</a><a href="#h27-0-29" id="h27-0-29" class="d">-import me.rhunk.snapenhance.bridge.DownloadCallback
</a><a href="#h27-0-30" id="h27-0-30" class="d">-import me.rhunk.snapenhance.common.data.FileType
</a><a href="#h27-0-31" id="h27-0-31" class="d">-import me.rhunk.snapenhance.common.data.StoryData
</a><a href="#h27-0-32" id="h27-0-32" class="d">-import me.rhunk.snapenhance.common.data.download.*
</a><a href="#h27-0-33" id="h27-0-33" class="d">-import me.rhunk.snapenhance.common.util.ktx.longHashCode
</a><a href="#h27-0-34" id="h27-0-34" class="d">-import me.rhunk.snapenhance.common.util.snap.MediaDownloaderHelper
</a><a href="#h27-0-35" id="h27-0-35" class="d">-import me.rhunk.snapenhance.core.util.media.PreviewUtils
</a><a href="#h27-0-36" id="h27-0-36" class="d">-import me.rhunk.snapenhance.download.DownloadProcessor
</a><a href="#h27-0-37" id="h27-0-37" class="d">-import me.rhunk.snapenhance.ui.util.Dialog
</a><a href="#h27-0-38" id="h27-0-38" class="d">-import okhttp3.HttpUrl.Companion.toHttpUrl
</a><a href="#h27-0-39" id="h27-0-39" class="d">-import okhttp3.OkHttpClient
</a><a href="#h27-0-40" id="h27-0-40" class="d">-import okhttp3.Request
</a><a href="#h27-0-41" id="h27-0-41" class="d">-import java.io.File
</a><a href="#h27-0-42" id="h27-0-42" class="d">-import java.text.DateFormat
</a><a href="#h27-0-43" id="h27-0-43" class="d">-import java.util.Date
</a><a href="#h27-0-44" id="h27-0-44" class="d">-import java.util.UUID
</a><a href="#h27-0-45" id="h27-0-45" class="d">-import javax.crypto.Cipher
</a><a href="#h27-0-46" id="h27-0-46" class="d">-import javax.crypto.CipherInputStream
</a><a href="#h27-0-47" id="h27-0-47" class="d">-import javax.crypto.spec.IvParameterSpec
</a><a href="#h27-0-48" id="h27-0-48" class="d">-import javax.crypto.spec.SecretKeySpec
</a><a href="#h27-0-49" id="h27-0-49" class="d">-import kotlin.math.absoluteValue
</a><a href="#h27-0-50" id="h27-0-50" class="d">-
</a><a href="#h27-0-51" id="h27-0-51" class="d">-@OptIn(ExperimentalCoilApi::class)
</a><a href="#h27-0-52" id="h27-0-52" class="d">-@Composable
</a><a href="#h27-0-53" id="h27-0-53" class="d">-fun LoggedStories(
</a><a href="#h27-0-54" id="h27-0-54" class="d">-    context: RemoteSideContext,
</a><a href="#h27-0-55" id="h27-0-55" class="d">-    userId: String
</a><a href="#h27-0-56" id="h27-0-56" class="d">-) {
</a><a href="#h27-0-57" id="h27-0-57" class="d">-    val stories = remember {
</a><a href="#h27-0-58" id="h27-0-58" class="d">-        mutableStateListOf&lt;StoryData&gt;()
</a><a href="#h27-0-59" id="h27-0-59" class="d">-    }
</a><a href="#h27-0-60" id="h27-0-60" class="d">-    val friendInfo = remember {
</a><a href="#h27-0-61" id="h27-0-61" class="d">-        context.modDatabase.getFriendInfo(userId)
</a><a href="#h27-0-62" id="h27-0-62" class="d">-    }
</a><a href="#h27-0-63" id="h27-0-63" class="d">-    val httpClient = remember { OkHttpClient() }
</a><a href="#h27-0-64" id="h27-0-64" class="d">-    var lastStoryTimestamp by remember { mutableLongStateOf(Long.MAX_VALUE) }
</a><a href="#h27-0-65" id="h27-0-65" class="d">-
</a><a href="#h27-0-66" id="h27-0-66" class="d">-    var selectedStory by remember { mutableStateOf&lt;StoryData?&gt;(null) }
</a><a href="#h27-0-67" id="h27-0-67" class="d">-    var coilCacheFile by remember { mutableStateOf&lt;File?&gt;(null) }
</a><a href="#h27-0-68" id="h27-0-68" class="d">-
</a><a href="#h27-0-69" id="h27-0-69" class="d">-    selectedStory?.let { story -&gt;
</a><a href="#h27-0-70" id="h27-0-70" class="d">-        Dialog(onDismissRequest = {
</a><a href="#h27-0-71" id="h27-0-71" class="d">-            selectedStory = null
</a><a href="#h27-0-72" id="h27-0-72" class="d">-        }) {
</a><a href="#h27-0-73" id="h27-0-73" class="d">-            Card(
</a><a href="#h27-0-74" id="h27-0-74" class="d">-                modifier = Modifier
</a><a href="#h27-0-75" id="h27-0-75" class="d">-                    .padding(4.dp)
</a><a href="#h27-0-76" id="h27-0-76" class="d">-            ) {
</a><a href="#h27-0-77" id="h27-0-77" class="d">-                Column(
</a><a href="#h27-0-78" id="h27-0-78" class="d">-                    modifier = Modifier
</a><a href="#h27-0-79" id="h27-0-79" class="d">-                        .padding(16.dp)
</a><a href="#h27-0-80" id="h27-0-80" class="d">-                        .fillMaxWidth(),
</a><a href="#h27-0-81" id="h27-0-81" class="d">-                    verticalArrangement = Arrangement.spacedBy(8.dp),
</a><a href="#h27-0-82" id="h27-0-82" class="d">-                ) {
</a><a href="#h27-0-83" id="h27-0-83" class="d">-                    Text(text = &quot;Posted on ${story.postedAt.let {
</a><a href="#h27-0-84" id="h27-0-84" class="d">-                        DateFormat.getDateTimeInstance().format(Date(it))
</a><a href="#h27-0-85" id="h27-0-85" class="d">-                    }}&quot;)
</a><a href="#h27-0-86" id="h27-0-86" class="d">-                    Text(text = &quot;Created at ${story.createdAt.let {
</a><a href="#h27-0-87" id="h27-0-87" class="d">-                        DateFormat.getDateTimeInstance().format(Date(it))
</a><a href="#h27-0-88" id="h27-0-88" class="d">-                    }}&quot;)
</a><a href="#h27-0-89" id="h27-0-89" class="d">-
</a><a href="#h27-0-90" id="h27-0-90" class="d">-                    Row(
</a><a href="#h27-0-91" id="h27-0-91" class="d">-                        modifier = Modifier.fillMaxWidth(),
</a><a href="#h27-0-92" id="h27-0-92" class="d">-                        horizontalArrangement = Arrangement.SpaceEvenly,
</a><a href="#h27-0-93" id="h27-0-93" class="d">-                    ) {
</a><a href="#h27-0-94" id="h27-0-94" class="d">-                        Button(onClick = {
</a><a href="#h27-0-95" id="h27-0-95" class="d">-                            context.androidContext.externalCacheDir?.let { cacheDir -&gt;
</a><a href="#h27-0-96" id="h27-0-96" class="d">-                                val cacheFile = coilCacheFile ?: run {
</a><a href="#h27-0-97" id="h27-0-97" class="d">-                                    context.shortToast(&quot;Failed to get file&quot;)
</a><a href="#h27-0-98" id="h27-0-98" class="d">-                                    return@Button
</a><a href="#h27-0-99" id="h27-0-99" class="d">-                                }
</a><a href="#h27-0-100" id="h27-0-100" class="d">-                                val targetFile = File(cacheDir, cacheFile.name)
</a><a href="#h27-0-101" id="h27-0-101" class="d">-                                cacheFile.copyTo(targetFile, overwrite = true)
</a><a href="#h27-0-102" id="h27-0-102" class="d">-                                context.androidContext.startActivity(Intent().apply {
</a><a href="#h27-0-103" id="h27-0-103" class="d">-                                    action = Intent.ACTION_VIEW
</a><a href="#h27-0-104" id="h27-0-104" class="d">-                                    setDataAndType(
</a><a href="#h27-0-105" id="h27-0-105" class="d">-                                        FileProvider.getUriForFile(
</a><a href="#h27-0-106" id="h27-0-106" class="d">-                                            context.androidContext,
</a><a href="#h27-0-107" id="h27-0-107" class="d">-                                            &quot;me.rhunk.snapenhance.fileprovider&quot;,
</a><a href="#h27-0-108" id="h27-0-108" class="d">-                                            targetFile
</a><a href="#h27-0-109" id="h27-0-109" class="d">-                                        ),
</a><a href="#h27-0-110" id="h27-0-110" class="d">-                                        FileType.fromFile(targetFile).mimeType
</a><a href="#h27-0-111" id="h27-0-111" class="d">-                                    )
</a><a href="#h27-0-112" id="h27-0-112" class="d">-                                    addFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION or Intent.FLAG_ACTIVITY_NEW_TASK)
</a><a href="#h27-0-113" id="h27-0-113" class="d">-                                })
</a><a href="#h27-0-114" id="h27-0-114" class="d">-                            }
</a><a href="#h27-0-115" id="h27-0-115" class="d">-                        }) {
</a><a href="#h27-0-116" id="h27-0-116" class="d">-                            Text(text = &quot;Open&quot;)
</a><a href="#h27-0-117" id="h27-0-117" class="d">-                        }
</a><a href="#h27-0-118" id="h27-0-118" class="d">-
</a><a href="#h27-0-119" id="h27-0-119" class="d">-                        Button(onClick = {
</a><a href="#h27-0-120" id="h27-0-120" class="d">-                            val mediaAuthor = friendInfo?.mutableUsername ?: userId
</a><a href="#h27-0-121" id="h27-0-121" class="d">-                            val uniqueHash = (selectedStory?.url ?: UUID.randomUUID().toString()).longHashCode().absoluteValue.toString(16)
</a><a href="#h27-0-122" id="h27-0-122" class="d">-
</a><a href="#h27-0-123" id="h27-0-123" class="d">-                            DownloadProcessor(
</a><a href="#h27-0-124" id="h27-0-124" class="d">-                                remoteSideContext = context,
</a><a href="#h27-0-125" id="h27-0-125" class="d">-                                callback = object: DownloadCallback.Default() {
</a><a href="#h27-0-126" id="h27-0-126" class="d">-                                    override fun onSuccess(outputPath: String?) {
</a><a href="#h27-0-127" id="h27-0-127" class="d">-                                        context.shortToast(&quot;Downloaded to $outputPath&quot;)
</a><a href="#h27-0-128" id="h27-0-128" class="d">-                                    }
</a><a href="#h27-0-129" id="h27-0-129" class="d">-
</a><a href="#h27-0-130" id="h27-0-130" class="d">-                                    override fun onFailure(message: String?, throwable: String?) {
</a><a href="#h27-0-131" id="h27-0-131" class="d">-                                        context.shortToast(&quot;Failed to download $message&quot;)
</a><a href="#h27-0-132" id="h27-0-132" class="d">-                                    }
</a><a href="#h27-0-133" id="h27-0-133" class="d">-                                }
</a><a href="#h27-0-134" id="h27-0-134" class="d">-                            ).enqueue(DownloadRequest(
</a><a href="#h27-0-135" id="h27-0-135" class="d">-                                inputMedias = arrayOf(
</a><a href="#h27-0-136" id="h27-0-136" class="d">-                                    InputMedia(
</a><a href="#h27-0-137" id="h27-0-137" class="d">-                                        content = story.url,
</a><a href="#h27-0-138" id="h27-0-138" class="d">-                                        type = DownloadMediaType.REMOTE_MEDIA,
</a><a href="#h27-0-139" id="h27-0-139" class="d">-                                        encryption = story.key?.let { it to story.iv!! }?.toKeyPair()
</a><a href="#h27-0-140" id="h27-0-140" class="d">-                                    )
</a><a href="#h27-0-141" id="h27-0-141" class="d">-                                )
</a><a href="#h27-0-142" id="h27-0-142" class="d">-                            ), DownloadMetadata(
</a><a href="#h27-0-143" id="h27-0-143" class="d">-                                mediaIdentifier = uniqueHash,
</a><a href="#h27-0-144" id="h27-0-144" class="d">-                                outputPath = createNewFilePath(
</a><a href="#h27-0-145" id="h27-0-145" class="d">-                                    context.config.root,
</a><a href="#h27-0-146" id="h27-0-146" class="d">-                                    uniqueHash,
</a><a href="#h27-0-147" id="h27-0-147" class="d">-                                    MediaDownloadSource.STORY_LOGGER,
</a><a href="#h27-0-148" id="h27-0-148" class="d">-                                    mediaAuthor,
</a><a href="#h27-0-149" id="h27-0-149" class="d">-                                    story.createdAt
</a><a href="#h27-0-150" id="h27-0-150" class="d">-                                ),
</a><a href="#h27-0-151" id="h27-0-151" class="d">-                                iconUrl = null,
</a><a href="#h27-0-152" id="h27-0-152" class="d">-                                mediaAuthor = friendInfo?.mutableUsername ?: userId,
</a><a href="#h27-0-153" id="h27-0-153" class="d">-                                downloadSource = MediaDownloadSource.STORY_LOGGER.translate(context.translation),
</a><a href="#h27-0-154" id="h27-0-154" class="d">-                            ))
</a><a href="#h27-0-155" id="h27-0-155" class="d">-                        }) {
</a><a href="#h27-0-156" id="h27-0-156" class="d">-                            Text(text = &quot;Download&quot;)
</a><a href="#h27-0-157" id="h27-0-157" class="d">-                        }
</a><a href="#h27-0-158" id="h27-0-158" class="d">-                    }
</a><a href="#h27-0-159" id="h27-0-159" class="d">-                }
</a><a href="#h27-0-160" id="h27-0-160" class="d">-            }
</a><a href="#h27-0-161" id="h27-0-161" class="d">-        }
</a><a href="#h27-0-162" id="h27-0-162" class="d">-    }
</a><a href="#h27-0-163" id="h27-0-163" class="d">-
</a><a href="#h27-0-164" id="h27-0-164" class="d">-    if (stories.isEmpty()) {
</a><a href="#h27-0-165" id="h27-0-165" class="d">-        Text(text = &quot;No stories found&quot;, Modifier.fillMaxWidth(), textAlign = TextAlign.Center)
</a><a href="#h27-0-166" id="h27-0-166" class="d">-    }
</a><a href="#h27-0-167" id="h27-0-167" class="d">-
</a><a href="#h27-0-168" id="h27-0-168" class="d">-    LazyVerticalGrid(
</a><a href="#h27-0-169" id="h27-0-169" class="d">-        columns = GridCells.Adaptive(100.dp),
</a><a href="#h27-0-170" id="h27-0-170" class="d">-        contentPadding = PaddingValues(8.dp),
</a><a href="#h27-0-171" id="h27-0-171" class="d">-    ) {
</a><a href="#h27-0-172" id="h27-0-172" class="d">-        items(stories) { story -&gt;
</a><a href="#h27-0-173" id="h27-0-173" class="d">-            var imageBitmap by remember { mutableStateOf&lt;ImageBitmap?&gt;(null) }
</a><a href="#h27-0-174" id="h27-0-174" class="d">-            val uniqueHash = remember { story.url.hashCode().absoluteValue.toString(16) }
</a><a href="#h27-0-175" id="h27-0-175" class="d">-
</a><a href="#h27-0-176" id="h27-0-176" class="d">-            fun openDiskCacheSnapshot(snapshot: DiskCache.Snapshot): Boolean {
</a><a href="#h27-0-177" id="h27-0-177" class="d">-                runCatching {
</a><a href="#h27-0-178" id="h27-0-178" class="d">-                    val mediaList = mutableMapOf&lt;SplitMediaAssetType, ByteArray&gt;()
</a><a href="#h27-0-179" id="h27-0-179" class="d">-
</a><a href="#h27-0-180" id="h27-0-180" class="d">-                    snapshot.data.toFile().inputStream().use { inputStream -&gt;
</a><a href="#h27-0-181" id="h27-0-181" class="d">-                        MediaDownloaderHelper.getSplitElements(inputStream) { type, splitInputStream -&gt;
</a><a href="#h27-0-182" id="h27-0-182" class="d">-                            mediaList[type] = splitInputStream.readBytes()
</a><a href="#h27-0-183" id="h27-0-183" class="d">-                        }
</a><a href="#h27-0-184" id="h27-0-184" class="d">-                    }
</a><a href="#h27-0-185" id="h27-0-185" class="d">-
</a><a href="#h27-0-186" id="h27-0-186" class="d">-                    val originalMedia = mediaList[SplitMediaAssetType.ORIGINAL] ?: return@runCatching false
</a><a href="#h27-0-187" id="h27-0-187" class="d">-                    val overlay = mediaList[SplitMediaAssetType.OVERLAY]
</a><a href="#h27-0-188" id="h27-0-188" class="d">-
</a><a href="#h27-0-189" id="h27-0-189" class="d">-                    var bitmap: Bitmap? = PreviewUtils.createPreview(originalMedia, isVideo = FileType.fromByteArray(originalMedia).isVideo)
</a><a href="#h27-0-190" id="h27-0-190" class="d">-
</a><a href="#h27-0-191" id="h27-0-191" class="d">-                    overlay?.also {
</a><a href="#h27-0-192" id="h27-0-192" class="d">-                        bitmap = PreviewUtils.mergeBitmapOverlay(bitmap!!, BitmapFactory.decodeByteArray(it, 0, it.size))
</a><a href="#h27-0-193" id="h27-0-193" class="d">-                    }
</a><a href="#h27-0-194" id="h27-0-194" class="d">-
</a><a href="#h27-0-195" id="h27-0-195" class="d">-                    imageBitmap = bitmap?.asImageBitmap()
</a><a href="#h27-0-196" id="h27-0-196" class="d">-                    return true
</a><a href="#h27-0-197" id="h27-0-197" class="d">-                }
</a><a href="#h27-0-198" id="h27-0-198" class="d">-                return false
</a><a href="#h27-0-199" id="h27-0-199" class="d">-            }
</a><a href="#h27-0-200" id="h27-0-200" class="d">-
</a><a href="#h27-0-201" id="h27-0-201" class="d">-            LaunchedEffect(Unit) {
</a><a href="#h27-0-202" id="h27-0-202" class="d">-                withContext(Dispatchers.IO) {
</a><a href="#h27-0-203" id="h27-0-203" class="d">-                    withTimeout(10000L) {
</a><a href="#h27-0-204" id="h27-0-204" class="d">-                        context.imageLoader.diskCache?.openSnapshot(uniqueHash)?.let {
</a><a href="#h27-0-205" id="h27-0-205" class="d">-                            openDiskCacheSnapshot(it)
</a><a href="#h27-0-206" id="h27-0-206" class="d">-                            it.close()
</a><a href="#h27-0-207" id="h27-0-207" class="d">-                            return@withTimeout
</a><a href="#h27-0-208" id="h27-0-208" class="d">-                        }
</a><a href="#h27-0-209" id="h27-0-209" class="d">-
</a><a href="#h27-0-210" id="h27-0-210" class="d">-                        runCatching {
</a><a href="#h27-0-211" id="h27-0-211" class="d">-                            val response = httpClient.newCall(Request(
</a><a href="#h27-0-212" id="h27-0-212" class="d">-                                url = story.url.toHttpUrl()
</a><a href="#h27-0-213" id="h27-0-213" class="d">-                            )).execute()
</a><a href="#h27-0-214" id="h27-0-214" class="d">-                            response.body.byteStream().use {
</a><a href="#h27-0-215" id="h27-0-215" class="d">-                                val decrypted = story.key?.let { _ -&gt;
</a><a href="#h27-0-216" id="h27-0-216" class="d">-                                    val cipher = Cipher.getInstance(&quot;AES/CBC/PKCS5Padding&quot;)
</a><a href="#h27-0-217" id="h27-0-217" class="d">-                                    cipher.init(Cipher.DECRYPT_MODE, SecretKeySpec(story.key, &quot;AES&quot;), IvParameterSpec(story.iv))
</a><a href="#h27-0-218" id="h27-0-218" class="d">-                                    CipherInputStream(it, cipher)
</a><a href="#h27-0-219" id="h27-0-219" class="d">-                                } ?: it
</a><a href="#h27-0-220" id="h27-0-220" class="d">-
</a><a href="#h27-0-221" id="h27-0-221" class="d">-                                context.imageLoader.diskCache?.openEditor(uniqueHash)?.apply {
</a><a href="#h27-0-222" id="h27-0-222" class="d">-                                    data.toFile().outputStream().use { fos -&gt;
</a><a href="#h27-0-223" id="h27-0-223" class="d">-                                        decrypted.copyTo(fos)
</a><a href="#h27-0-224" id="h27-0-224" class="d">-                                    }
</a><a href="#h27-0-225" id="h27-0-225" class="d">-                                    commitAndOpenSnapshot()?.use { snapshot -&gt;
</a><a href="#h27-0-226" id="h27-0-226" class="d">-                                        openDiskCacheSnapshot(snapshot)
</a><a href="#h27-0-227" id="h27-0-227" class="d">-                                        snapshot.close()
</a><a href="#h27-0-228" id="h27-0-228" class="d">-                                    }
</a><a href="#h27-0-229" id="h27-0-229" class="d">-                                }
</a><a href="#h27-0-230" id="h27-0-230" class="d">-                            }
</a><a href="#h27-0-231" id="h27-0-231" class="d">-                        }.onFailure {
</a><a href="#h27-0-232" id="h27-0-232" class="d">-                            context.log.error(&quot;Failed to load story&quot;, it)
</a><a href="#h27-0-233" id="h27-0-233" class="d">-                        }
</a><a href="#h27-0-234" id="h27-0-234" class="d">-                    }
</a><a href="#h27-0-235" id="h27-0-235" class="d">-                }
</a><a href="#h27-0-236" id="h27-0-236" class="d">-            }
</a><a href="#h27-0-237" id="h27-0-237" class="d">-
</a><a href="#h27-0-238" id="h27-0-238" class="d">-            Column(
</a><a href="#h27-0-239" id="h27-0-239" class="d">-                modifier = Modifier
</a><a href="#h27-0-240" id="h27-0-240" class="d">-                    .padding(8.dp)
</a><a href="#h27-0-241" id="h27-0-241" class="d">-                    .clickable {
</a><a href="#h27-0-242" id="h27-0-242" class="d">-                        selectedStory = story
</a><a href="#h27-0-243" id="h27-0-243" class="d">-                        coilCacheFile = context.imageLoader.diskCache?.openSnapshot(uniqueHash).use {
</a><a href="#h27-0-244" id="h27-0-244" class="d">-                            it?.data?.toFile()
</a><a href="#h27-0-245" id="h27-0-245" class="d">-                        }
</a><a href="#h27-0-246" id="h27-0-246" class="d">-                    }
</a><a href="#h27-0-247" id="h27-0-247" class="d">-                    .heightIn(min = 128.dp),
</a><a href="#h27-0-248" id="h27-0-248" class="d">-                horizontalAlignment = Alignment.CenterHorizontally,
</a><a href="#h27-0-249" id="h27-0-249" class="d">-                verticalArrangement = Arrangement.Center,
</a><a href="#h27-0-250" id="h27-0-250" class="d">-            ) {
</a><a href="#h27-0-251" id="h27-0-251" class="d">-                imageBitmap?.let {
</a><a href="#h27-0-252" id="h27-0-252" class="d">-                    Card {
</a><a href="#h27-0-253" id="h27-0-253" class="d">-                        Image(
</a><a href="#h27-0-254" id="h27-0-254" class="d">-                            bitmap = it,
</a><a href="#h27-0-255" id="h27-0-255" class="d">-                            modifier = Modifier.fillMaxSize(),
</a><a href="#h27-0-256" id="h27-0-256" class="d">-                            contentDescription = null,
</a><a href="#h27-0-257" id="h27-0-257" class="d">-                        )
</a><a href="#h27-0-258" id="h27-0-258" class="d">-                    }
</a><a href="#h27-0-259" id="h27-0-259" class="d">-                } ?: run {
</a><a href="#h27-0-260" id="h27-0-260" class="d">-                    CircularProgressIndicator()
</a><a href="#h27-0-261" id="h27-0-261" class="d">-                }
</a><a href="#h27-0-262" id="h27-0-262" class="d">-            }
</a><a href="#h27-0-263" id="h27-0-263" class="d">-        }
</a><a href="#h27-0-264" id="h27-0-264" class="d">-        item {
</a><a href="#h27-0-265" id="h27-0-265" class="d">-            LaunchedEffect(Unit) {
</a><a href="#h27-0-266" id="h27-0-266" class="d">-                context.messageLogger.getStories(userId, lastStoryTimestamp, 20).also { result -&gt;
</a><a href="#h27-0-267" id="h27-0-267" class="d">-                    stories.addAll(result.values)
</a><a href="#h27-0-268" id="h27-0-268" class="d">-                    result.keys.minOrNull()?.let {
</a><a href="#h27-0-269" id="h27-0-269" class="d">-                        lastStoryTimestamp = it
</a><a href="#h27-0-270" id="h27-0-270" class="d">-                    }
</a><a href="#h27-0-271" id="h27-0-271" class="d">-                }
</a><a href="#h27-0-272" id="h27-0-272" class="d">-            }
</a><a href="#h27-0-273" id="h27-0-273" class="d">-        }
</a><a href="#h27-0-274" id="h27-0-274" class="d">-    }
</a><a href="#h27-0-275" id="h27-0-275" class="d">-}</a><a href="#h27-0-276" id="h27-0-276" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h28" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/social/MessagingPreview.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/social/MessagingPreview.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/social/MessagingPreview.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/social/MessagingPreview.kt</a></b>
<a href="#h28-0" id="h28-0" class="h">@@ -1,522 +0,0 @@
</a><a href="#h28-0-0" id="h28-0-0" class="d">-package me.rhunk.snapenhance.ui.manager.sections.social
</a><a href="#h28-0-1" id="h28-0-1" class="d">-
</a><a href="#h28-0-2" id="h28-0-2" class="d">-import android.content.Intent
</a><a href="#h28-0-3" id="h28-0-3" class="d">-import androidx.compose.foundation.background
</a><a href="#h28-0-4" id="h28-0-4" class="d">-import androidx.compose.foundation.border
</a><a href="#h28-0-5" id="h28-0-5" class="d">-import androidx.compose.foundation.gestures.detectTapGestures
</a><a href="#h28-0-6" id="h28-0-6" class="d">-import androidx.compose.foundation.layout.*
</a><a href="#h28-0-7" id="h28-0-7" class="d">-import androidx.compose.foundation.lazy.LazyColumn
</a><a href="#h28-0-8" id="h28-0-8" class="d">-import androidx.compose.foundation.lazy.LazyListState
</a><a href="#h28-0-9" id="h28-0-9" class="d">-import androidx.compose.foundation.lazy.rememberLazyListState
</a><a href="#h28-0-10" id="h28-0-10" class="d">-import androidx.compose.foundation.shape.RoundedCornerShape
</a><a href="#h28-0-11" id="h28-0-11" class="d">-import androidx.compose.material.icons.Icons
</a><a href="#h28-0-12" id="h28-0-12" class="d">-import androidx.compose.material.icons.filled.Close
</a><a href="#h28-0-13" id="h28-0-13" class="d">-import androidx.compose.material.icons.filled.MoreVert
</a><a href="#h28-0-14" id="h28-0-14" class="d">-import androidx.compose.material.icons.rounded.BookmarkAdded
</a><a href="#h28-0-15" id="h28-0-15" class="d">-import androidx.compose.material.icons.rounded.BookmarkBorder
</a><a href="#h28-0-16" id="h28-0-16" class="d">-import androidx.compose.material.icons.rounded.DeleteForever
</a><a href="#h28-0-17" id="h28-0-17" class="d">-import androidx.compose.material.icons.rounded.RemoveRedEye
</a><a href="#h28-0-18" id="h28-0-18" class="d">-import androidx.compose.material3.*
</a><a href="#h28-0-19" id="h28-0-19" class="d">-import androidx.compose.runtime.*
</a><a href="#h28-0-20" id="h28-0-20" class="d">-import androidx.compose.ui.Alignment
</a><a href="#h28-0-21" id="h28-0-21" class="d">-import androidx.compose.ui.Modifier
</a><a href="#h28-0-22" id="h28-0-22" class="d">-import androidx.compose.ui.graphics.vector.ImageVector
</a><a href="#h28-0-23" id="h28-0-23" class="d">-import androidx.compose.ui.input.pointer.pointerInput
</a><a href="#h28-0-24" id="h28-0-24" class="d">-import androidx.compose.ui.unit.dp
</a><a href="#h28-0-25" id="h28-0-25" class="d">-import kotlinx.coroutines.*
</a><a href="#h28-0-26" id="h28-0-26" class="d">-import me.rhunk.snapenhance.RemoteSideContext
</a><a href="#h28-0-27" id="h28-0-27" class="d">-import me.rhunk.snapenhance.bridge.snapclient.MessagingBridge
</a><a href="#h28-0-28" id="h28-0-28" class="d">-import me.rhunk.snapenhance.bridge.snapclient.SessionStartListener
</a><a href="#h28-0-29" id="h28-0-29" class="d">-import me.rhunk.snapenhance.bridge.snapclient.types.Message
</a><a href="#h28-0-30" id="h28-0-30" class="d">-import me.rhunk.snapenhance.common.Constants
</a><a href="#h28-0-31" id="h28-0-31" class="d">-import me.rhunk.snapenhance.common.ReceiversConfig
</a><a href="#h28-0-32" id="h28-0-32" class="d">-import me.rhunk.snapenhance.common.data.ContentType
</a><a href="#h28-0-33" id="h28-0-33" class="d">-import me.rhunk.snapenhance.common.data.SocialScope
</a><a href="#h28-0-34" id="h28-0-34" class="d">-import me.rhunk.snapenhance.common.util.protobuf.ProtoReader
</a><a href="#h28-0-35" id="h28-0-35" class="d">-import me.rhunk.snapenhance.common.util.snap.SnapWidgetBroadcastReceiverHelper
</a><a href="#h28-0-36" id="h28-0-36" class="d">-import me.rhunk.snapenhance.messaging.MessagingConstraints
</a><a href="#h28-0-37" id="h28-0-37" class="d">-import me.rhunk.snapenhance.messaging.MessagingTask
</a><a href="#h28-0-38" id="h28-0-38" class="d">-import me.rhunk.snapenhance.messaging.MessagingTaskConstraint
</a><a href="#h28-0-39" id="h28-0-39" class="d">-import me.rhunk.snapenhance.messaging.MessagingTaskType
</a><a href="#h28-0-40" id="h28-0-40" class="d">-import me.rhunk.snapenhance.ui.util.Dialog
</a><a href="#h28-0-41" id="h28-0-41" class="d">-
</a><a href="#h28-0-42" id="h28-0-42" class="d">-class MessagingPreview(
</a><a href="#h28-0-43" id="h28-0-43" class="d">-    private val context: RemoteSideContext,
</a><a href="#h28-0-44" id="h28-0-44" class="d">-    private val scope: SocialScope,
</a><a href="#h28-0-45" id="h28-0-45" class="d">-    private val scopeId: String
</a><a href="#h28-0-46" id="h28-0-46" class="d">-) {
</a><a href="#h28-0-47" id="h28-0-47" class="d">-    private lateinit var coroutineScope: CoroutineScope
</a><a href="#h28-0-48" id="h28-0-48" class="d">-    private lateinit var messagingBridge: MessagingBridge
</a><a href="#h28-0-49" id="h28-0-49" class="d">-    private lateinit var previewScrollState: LazyListState
</a><a href="#h28-0-50" id="h28-0-50" class="d">-    private val myUserId by lazy { messagingBridge.myUserId }
</a><a href="#h28-0-51" id="h28-0-51" class="d">-    private val contentTypeTranslation by lazy { context.translation.getCategory(&quot;content_type&quot;) }
</a><a href="#h28-0-52" id="h28-0-52" class="d">-
</a><a href="#h28-0-53" id="h28-0-53" class="d">-    private var conversationId: String? = null
</a><a href="#h28-0-54" id="h28-0-54" class="d">-    private val messages = sortedMapOf&lt;Long, Message&gt;() // server message id =&gt; message
</a><a href="#h28-0-55" id="h28-0-55" class="d">-    private var messageSize by mutableIntStateOf(0)
</a><a href="#h28-0-56" id="h28-0-56" class="d">-    private var lastMessageId = Long.MAX_VALUE
</a><a href="#h28-0-57" id="h28-0-57" class="d">-    private val selectedMessages = mutableStateListOf&lt;Long&gt;() // client message id
</a><a href="#h28-0-58" id="h28-0-58" class="d">-
</a><a href="#h28-0-59" id="h28-0-59" class="d">-    private fun toggleSelectedMessage(messageId: Long) {
</a><a href="#h28-0-60" id="h28-0-60" class="d">-        if (selectedMessages.contains(messageId)) selectedMessages.remove(messageId)
</a><a href="#h28-0-61" id="h28-0-61" class="d">-        else selectedMessages.add(messageId)
</a><a href="#h28-0-62" id="h28-0-62" class="d">-    }
</a><a href="#h28-0-63" id="h28-0-63" class="d">-
</a><a href="#h28-0-64" id="h28-0-64" class="d">-    @Composable
</a><a href="#h28-0-65" id="h28-0-65" class="d">-    private fun ActionButton(
</a><a href="#h28-0-66" id="h28-0-66" class="d">-        text: String,
</a><a href="#h28-0-67" id="h28-0-67" class="d">-        icon: ImageVector,
</a><a href="#h28-0-68" id="h28-0-68" class="d">-        onClick: () -&gt; Unit,
</a><a href="#h28-0-69" id="h28-0-69" class="d">-    ) {
</a><a href="#h28-0-70" id="h28-0-70" class="d">-        DropdownMenuItem(
</a><a href="#h28-0-71" id="h28-0-71" class="d">-            onClick = onClick,
</a><a href="#h28-0-72" id="h28-0-72" class="d">-            text = {
</a><a href="#h28-0-73" id="h28-0-73" class="d">-                Row(
</a><a href="#h28-0-74" id="h28-0-74" class="d">-                    modifier = Modifier.padding(5.dp),
</a><a href="#h28-0-75" id="h28-0-75" class="d">-                    horizontalArrangement = Arrangement.spacedBy(8.dp),
</a><a href="#h28-0-76" id="h28-0-76" class="d">-                    verticalAlignment = Alignment.CenterVertically
</a><a href="#h28-0-77" id="h28-0-77" class="d">-                ) {
</a><a href="#h28-0-78" id="h28-0-78" class="d">-                    Icon(
</a><a href="#h28-0-79" id="h28-0-79" class="d">-                        imageVector = icon,
</a><a href="#h28-0-80" id="h28-0-80" class="d">-                        contentDescription = null
</a><a href="#h28-0-81" id="h28-0-81" class="d">-                    )
</a><a href="#h28-0-82" id="h28-0-82" class="d">-                    Text(text = text)
</a><a href="#h28-0-83" id="h28-0-83" class="d">-                }
</a><a href="#h28-0-84" id="h28-0-84" class="d">-            }
</a><a href="#h28-0-85" id="h28-0-85" class="d">-        )
</a><a href="#h28-0-86" id="h28-0-86" class="d">-    }
</a><a href="#h28-0-87" id="h28-0-87" class="d">-
</a><a href="#h28-0-88" id="h28-0-88" class="d">-    @Composable
</a><a href="#h28-0-89" id="h28-0-89" class="d">-    private fun ConstraintsSelectionDialog(
</a><a href="#h28-0-90" id="h28-0-90" class="d">-        onChoose: (Array&lt;ContentType&gt;) -&gt; Unit,
</a><a href="#h28-0-91" id="h28-0-91" class="d">-        onDismiss: () -&gt; Unit
</a><a href="#h28-0-92" id="h28-0-92" class="d">-    ) {
</a><a href="#h28-0-93" id="h28-0-93" class="d">-        val selectedTypes = remember { mutableStateListOf&lt;ContentType&gt;() }
</a><a href="#h28-0-94" id="h28-0-94" class="d">-        var selectAllState by remember { mutableStateOf(false) }
</a><a href="#h28-0-95" id="h28-0-95" class="d">-        val availableTypes = remember { arrayOf(
</a><a href="#h28-0-96" id="h28-0-96" class="d">-            ContentType.CHAT,
</a><a href="#h28-0-97" id="h28-0-97" class="d">-            ContentType.NOTE,
</a><a href="#h28-0-98" id="h28-0-98" class="d">-            ContentType.SNAP,
</a><a href="#h28-0-99" id="h28-0-99" class="d">-            ContentType.STICKER,
</a><a href="#h28-0-100" id="h28-0-100" class="d">-            ContentType.EXTERNAL_MEDIA
</a><a href="#h28-0-101" id="h28-0-101" class="d">-        ) }
</a><a href="#h28-0-102" id="h28-0-102" class="d">-
</a><a href="#h28-0-103" id="h28-0-103" class="d">-        fun toggleContentType(contentType: ContentType) {
</a><a href="#h28-0-104" id="h28-0-104" class="d">-            if (selectAllState) return
</a><a href="#h28-0-105" id="h28-0-105" class="d">-            if (selectedTypes.contains(contentType)) {
</a><a href="#h28-0-106" id="h28-0-106" class="d">-                selectedTypes.remove(contentType)
</a><a href="#h28-0-107" id="h28-0-107" class="d">-            } else {
</a><a href="#h28-0-108" id="h28-0-108" class="d">-                selectedTypes.add(contentType)
</a><a href="#h28-0-109" id="h28-0-109" class="d">-            }
</a><a href="#h28-0-110" id="h28-0-110" class="d">-        }
</a><a href="#h28-0-111" id="h28-0-111" class="d">-
</a><a href="#h28-0-112" id="h28-0-112" class="d">-        Surface(
</a><a href="#h28-0-113" id="h28-0-113" class="d">-            modifier = Modifier
</a><a href="#h28-0-114" id="h28-0-114" class="d">-                .fillMaxWidth()
</a><a href="#h28-0-115" id="h28-0-115" class="d">-                .background(MaterialTheme.colorScheme.surface)
</a><a href="#h28-0-116" id="h28-0-116" class="d">-        ) {
</a><a href="#h28-0-117" id="h28-0-117" class="d">-            Column(
</a><a href="#h28-0-118" id="h28-0-118" class="d">-                modifier = Modifier.padding(15.dp),
</a><a href="#h28-0-119" id="h28-0-119" class="d">-                horizontalAlignment = Alignment.CenterHorizontally,
</a><a href="#h28-0-120" id="h28-0-120" class="d">-                verticalArrangement = Arrangement.spacedBy(5.dp)
</a><a href="#h28-0-121" id="h28-0-121" class="d">-            ) {
</a><a href="#h28-0-122" id="h28-0-122" class="d">-                Text(&quot;Choose content types to process&quot;)
</a><a href="#h28-0-123" id="h28-0-123" class="d">-                Spacer(modifier = Modifier.height(5.dp))
</a><a href="#h28-0-124" id="h28-0-124" class="d">-                availableTypes.forEach { contentType -&gt;
</a><a href="#h28-0-125" id="h28-0-125" class="d">-                    Row(
</a><a href="#h28-0-126" id="h28-0-126" class="d">-                        modifier = Modifier
</a><a href="#h28-0-127" id="h28-0-127" class="d">-                            .fillMaxWidth()
</a><a href="#h28-0-128" id="h28-0-128" class="d">-                            .padding(2.dp)
</a><a href="#h28-0-129" id="h28-0-129" class="d">-                            .pointerInput(Unit) {
</a><a href="#h28-0-130" id="h28-0-130" class="d">-                                detectTapGestures(onTap = { toggleContentType(contentType) })
</a><a href="#h28-0-131" id="h28-0-131" class="d">-                            },
</a><a href="#h28-0-132" id="h28-0-132" class="d">-                        horizontalArrangement = Arrangement.spacedBy(8.dp),
</a><a href="#h28-0-133" id="h28-0-133" class="d">-                        verticalAlignment = Alignment.CenterVertically
</a><a href="#h28-0-134" id="h28-0-134" class="d">-                    ) {
</a><a href="#h28-0-135" id="h28-0-135" class="d">-                        Checkbox(
</a><a href="#h28-0-136" id="h28-0-136" class="d">-                            checked = selectedTypes.contains(contentType),
</a><a href="#h28-0-137" id="h28-0-137" class="d">-                            enabled = !selectAllState,
</a><a href="#h28-0-138" id="h28-0-138" class="d">-                            onCheckedChange = { toggleContentType(contentType) }
</a><a href="#h28-0-139" id="h28-0-139" class="d">-                        )
</a><a href="#h28-0-140" id="h28-0-140" class="d">-                        Text(text = contentType.toString())
</a><a href="#h28-0-141" id="h28-0-141" class="d">-                    }
</a><a href="#h28-0-142" id="h28-0-142" class="d">-                }
</a><a href="#h28-0-143" id="h28-0-143" class="d">-                Row(
</a><a href="#h28-0-144" id="h28-0-144" class="d">-                    modifier = Modifier
</a><a href="#h28-0-145" id="h28-0-145" class="d">-                        .fillMaxWidth()
</a><a href="#h28-0-146" id="h28-0-146" class="d">-                        .padding(5.dp),
</a><a href="#h28-0-147" id="h28-0-147" class="d">-                    horizontalArrangement = Arrangement.spacedBy(10.dp),
</a><a href="#h28-0-148" id="h28-0-148" class="d">-                    verticalAlignment = Alignment.CenterVertically
</a><a href="#h28-0-149" id="h28-0-149" class="d">-                ) {
</a><a href="#h28-0-150" id="h28-0-150" class="d">-                    Switch(checked = selectAllState, onCheckedChange = {
</a><a href="#h28-0-151" id="h28-0-151" class="d">-                        selectAllState = it
</a><a href="#h28-0-152" id="h28-0-152" class="d">-                    })
</a><a href="#h28-0-153" id="h28-0-153" class="d">-                    Text(text = &quot;Select all&quot;)
</a><a href="#h28-0-154" id="h28-0-154" class="d">-                }
</a><a href="#h28-0-155" id="h28-0-155" class="d">-                Row(
</a><a href="#h28-0-156" id="h28-0-156" class="d">-                    modifier = Modifier
</a><a href="#h28-0-157" id="h28-0-157" class="d">-                        .fillMaxWidth(),
</a><a href="#h28-0-158" id="h28-0-158" class="d">-                    horizontalArrangement = Arrangement.SpaceEvenly,
</a><a href="#h28-0-159" id="h28-0-159" class="d">-                ) {
</a><a href="#h28-0-160" id="h28-0-160" class="d">-                    Button(onClick = { onDismiss() }) {
</a><a href="#h28-0-161" id="h28-0-161" class="d">-                        Text(&quot;Cancel&quot;)
</a><a href="#h28-0-162" id="h28-0-162" class="d">-                    }
</a><a href="#h28-0-163" id="h28-0-163" class="d">-                    Button(onClick = {
</a><a href="#h28-0-164" id="h28-0-164" class="d">-                        onChoose(if (selectAllState) ContentType.entries.toTypedArray()
</a><a href="#h28-0-165" id="h28-0-165" class="d">-                         else selectedTypes.toTypedArray())
</a><a href="#h28-0-166" id="h28-0-166" class="d">-                    }) {
</a><a href="#h28-0-167" id="h28-0-167" class="d">-                        Text(&quot;Continue&quot;)
</a><a href="#h28-0-168" id="h28-0-168" class="d">-                    }
</a><a href="#h28-0-169" id="h28-0-169" class="d">-                }
</a><a href="#h28-0-170" id="h28-0-170" class="d">-            }
</a><a href="#h28-0-171" id="h28-0-171" class="d">-        }
</a><a href="#h28-0-172" id="h28-0-172" class="d">-    }
</a><a href="#h28-0-173" id="h28-0-173" class="d">-
</a><a href="#h28-0-174" id="h28-0-174" class="d">-    @Composable
</a><a href="#h28-0-175" id="h28-0-175" class="d">-    fun TopBarAction() {
</a><a href="#h28-0-176" id="h28-0-176" class="d">-        var taskSelectionDropdown by remember { mutableStateOf(false) }
</a><a href="#h28-0-177" id="h28-0-177" class="d">-        var selectConstraintsDialog by remember { mutableStateOf(false) }
</a><a href="#h28-0-178" id="h28-0-178" class="d">-        var activeTask by remember { mutableStateOf(null as MessagingTask?) }
</a><a href="#h28-0-179" id="h28-0-179" class="d">-        var activeJob by remember { mutableStateOf(null as Job?) }
</a><a href="#h28-0-180" id="h28-0-180" class="d">-        val processMessageCount = remember { mutableIntStateOf(0) }
</a><a href="#h28-0-181" id="h28-0-181" class="d">-
</a><a href="#h28-0-182" id="h28-0-182" class="d">-        fun runCurrentTask() {
</a><a href="#h28-0-183" id="h28-0-183" class="d">-            activeJob = coroutineScope.launch(Dispatchers.IO) {
</a><a href="#h28-0-184" id="h28-0-184" class="d">-                activeTask?.run()
</a><a href="#h28-0-185" id="h28-0-185" class="d">-                withContext(Dispatchers.Main) {
</a><a href="#h28-0-186" id="h28-0-186" class="d">-                    activeTask = null
</a><a href="#h28-0-187" id="h28-0-187" class="d">-                    activeJob = null
</a><a href="#h28-0-188" id="h28-0-188" class="d">-                }
</a><a href="#h28-0-189" id="h28-0-189" class="d">-            }.also { job -&gt;
</a><a href="#h28-0-190" id="h28-0-190" class="d">-                job.invokeOnCompletion {
</a><a href="#h28-0-191" id="h28-0-191" class="d">-                    if (it != null) {
</a><a href="#h28-0-192" id="h28-0-192" class="d">-                        context.log.verbose(&quot;Failed to process messages: ${it.message}&quot;)
</a><a href="#h28-0-193" id="h28-0-193" class="d">-                        return@invokeOnCompletion
</a><a href="#h28-0-194" id="h28-0-194" class="d">-                    }
</a><a href="#h28-0-195" id="h28-0-195" class="d">-                    context.longToast(&quot;Processed ${processMessageCount.intValue} messages&quot;)
</a><a href="#h28-0-196" id="h28-0-196" class="d">-                }
</a><a href="#h28-0-197" id="h28-0-197" class="d">-            }
</a><a href="#h28-0-198" id="h28-0-198" class="d">-        }
</a><a href="#h28-0-199" id="h28-0-199" class="d">-
</a><a href="#h28-0-200" id="h28-0-200" class="d">-        fun launchMessagingTask(taskType: MessagingTaskType, constraints: List&lt;MessagingTaskConstraint&gt; = listOf(), onSuccess: (Message) -&gt; Unit = {}) {
</a><a href="#h28-0-201" id="h28-0-201" class="d">-            taskSelectionDropdown = false
</a><a href="#h28-0-202" id="h28-0-202" class="d">-            processMessageCount.intValue = 0
</a><a href="#h28-0-203" id="h28-0-203" class="d">-            activeTask = MessagingTask(
</a><a href="#h28-0-204" id="h28-0-204" class="d">-                messagingBridge, conversationId!!, taskType, constraints,
</a><a href="#h28-0-205" id="h28-0-205" class="d">-                overrideClientMessageIds = selectedMessages.takeIf { it.isNotEmpty() }?.toList(),
</a><a href="#h28-0-206" id="h28-0-206" class="d">-                processedMessageCount = processMessageCount,
</a><a href="#h28-0-207" id="h28-0-207" class="d">-                onSuccess = onSuccess,
</a><a href="#h28-0-208" id="h28-0-208" class="d">-                onFailure = { message, reason -&gt;
</a><a href="#h28-0-209" id="h28-0-209" class="d">-                    context.log.verbose(&quot;Failed to process message ${message.clientMessageId}: $reason&quot;)
</a><a href="#h28-0-210" id="h28-0-210" class="d">-                }
</a><a href="#h28-0-211" id="h28-0-211" class="d">-            )
</a><a href="#h28-0-212" id="h28-0-212" class="d">-            selectedMessages.clear()
</a><a href="#h28-0-213" id="h28-0-213" class="d">-        }
</a><a href="#h28-0-214" id="h28-0-214" class="d">-
</a><a href="#h28-0-215" id="h28-0-215" class="d">-        if (selectConstraintsDialog &amp;&amp; activeTask != null) {
</a><a href="#h28-0-216" id="h28-0-216" class="d">-            Dialog(onDismissRequest = {
</a><a href="#h28-0-217" id="h28-0-217" class="d">-                selectConstraintsDialog = false
</a><a href="#h28-0-218" id="h28-0-218" class="d">-                activeTask = null
</a><a href="#h28-0-219" id="h28-0-219" class="d">-            }) {
</a><a href="#h28-0-220" id="h28-0-220" class="d">-                ConstraintsSelectionDialog(
</a><a href="#h28-0-221" id="h28-0-221" class="d">-                    onChoose = { contentTypes -&gt;
</a><a href="#h28-0-222" id="h28-0-222" class="d">-                        launchMessagingTask(
</a><a href="#h28-0-223" id="h28-0-223" class="d">-                            taskType = activeTask!!.taskType,
</a><a href="#h28-0-224" id="h28-0-224" class="d">-                            constraints = activeTask!!.constraints + MessagingConstraints.CONTENT_TYPE(contentTypes),
</a><a href="#h28-0-225" id="h28-0-225" class="d">-                            onSuccess = activeTask!!.onSuccess
</a><a href="#h28-0-226" id="h28-0-226" class="d">-                        )
</a><a href="#h28-0-227" id="h28-0-227" class="d">-                        runCurrentTask()
</a><a href="#h28-0-228" id="h28-0-228" class="d">-                        selectConstraintsDialog = false
</a><a href="#h28-0-229" id="h28-0-229" class="d">-                    },
</a><a href="#h28-0-230" id="h28-0-230" class="d">-                    onDismiss = {
</a><a href="#h28-0-231" id="h28-0-231" class="d">-                        selectConstraintsDialog = false
</a><a href="#h28-0-232" id="h28-0-232" class="d">-                        activeTask = null
</a><a href="#h28-0-233" id="h28-0-233" class="d">-                    }
</a><a href="#h28-0-234" id="h28-0-234" class="d">-                )
</a><a href="#h28-0-235" id="h28-0-235" class="d">-            }
</a><a href="#h28-0-236" id="h28-0-236" class="d">-        }
</a><a href="#h28-0-237" id="h28-0-237" class="d">-
</a><a href="#h28-0-238" id="h28-0-238" class="d">-        if (activeJob != null) {
</a><a href="#h28-0-239" id="h28-0-239" class="d">-            Dialog(onDismissRequest = {
</a><a href="#h28-0-240" id="h28-0-240" class="d">-                activeJob?.cancel()
</a><a href="#h28-0-241" id="h28-0-241" class="d">-                activeJob = null
</a><a href="#h28-0-242" id="h28-0-242" class="d">-                activeTask = null
</a><a href="#h28-0-243" id="h28-0-243" class="d">-            }) {
</a><a href="#h28-0-244" id="h28-0-244" class="d">-                Column(modifier = Modifier
</a><a href="#h28-0-245" id="h28-0-245" class="d">-                    .fillMaxWidth()
</a><a href="#h28-0-246" id="h28-0-246" class="d">-                    .background(MaterialTheme.colorScheme.surface)
</a><a href="#h28-0-247" id="h28-0-247" class="d">-                    .padding(15.dp)
</a><a href="#h28-0-248" id="h28-0-248" class="d">-                    .border(1.dp, MaterialTheme.colorScheme.onSurface, RoundedCornerShape(20.dp)),
</a><a href="#h28-0-249" id="h28-0-249" class="d">-                    horizontalAlignment = Alignment.CenterHorizontally,
</a><a href="#h28-0-250" id="h28-0-250" class="d">-                    verticalArrangement = Arrangement.spacedBy(5.dp))
</a><a href="#h28-0-251" id="h28-0-251" class="d">-                {
</a><a href="#h28-0-252" id="h28-0-252" class="d">-                    Text(&quot;Processed ${processMessageCount.intValue} messages&quot;)
</a><a href="#h28-0-253" id="h28-0-253" class="d">-                    if (activeTask?.hasFixedGoal() == true) {
</a><a href="#h28-0-254" id="h28-0-254" class="d">-                        LinearProgressIndicator(
</a><a href="#h28-0-255" id="h28-0-255" class="d">-                            modifier = Modifier
</a><a href="#h28-0-256" id="h28-0-256" class="d">-                                .fillMaxWidth()
</a><a href="#h28-0-257" id="h28-0-257" class="d">-                                .padding(5.dp),
</a><a href="#h28-0-258" id="h28-0-258" class="d">-                            progress = processMessageCount.intValue.toFloat() / selectedMessages.size.toFloat(),
</a><a href="#h28-0-259" id="h28-0-259" class="d">-                            color = MaterialTheme.colorScheme.primary
</a><a href="#h28-0-260" id="h28-0-260" class="d">-                        )
</a><a href="#h28-0-261" id="h28-0-261" class="d">-                    } else {
</a><a href="#h28-0-262" id="h28-0-262" class="d">-                        CircularProgressIndicator(
</a><a href="#h28-0-263" id="h28-0-263" class="d">-                            modifier = Modifier
</a><a href="#h28-0-264" id="h28-0-264" class="d">-                                .padding()
</a><a href="#h28-0-265" id="h28-0-265" class="d">-                                .size(30.dp),
</a><a href="#h28-0-266" id="h28-0-266" class="d">-                            strokeWidth = 3.dp,
</a><a href="#h28-0-267" id="h28-0-267" class="d">-                            color = MaterialTheme.colorScheme.primary
</a><a href="#h28-0-268" id="h28-0-268" class="d">-                        )
</a><a href="#h28-0-269" id="h28-0-269" class="d">-                    }
</a><a href="#h28-0-270" id="h28-0-270" class="d">-                }
</a><a href="#h28-0-271" id="h28-0-271" class="d">-            }
</a><a href="#h28-0-272" id="h28-0-272" class="d">-        }
</a><a href="#h28-0-273" id="h28-0-273" class="d">-
</a><a href="#h28-0-274" id="h28-0-274" class="d">-        IconButton(onClick = { taskSelectionDropdown = !taskSelectionDropdown }) {
</a><a href="#h28-0-275" id="h28-0-275" class="d">-            Icon(imageVector = Icons.Filled.MoreVert, contentDescription = null)
</a><a href="#h28-0-276" id="h28-0-276" class="d">-        }
</a><a href="#h28-0-277" id="h28-0-277" class="d">-
</a><a href="#h28-0-278" id="h28-0-278" class="d">-        if (selectedMessages.isNotEmpty()) {
</a><a href="#h28-0-279" id="h28-0-279" class="d">-            IconButton(onClick = { selectedMessages.clear() }) {
</a><a href="#h28-0-280" id="h28-0-280" class="d">-                Icon(imageVector = Icons.Filled.Close, contentDescription = &quot;Close&quot;)
</a><a href="#h28-0-281" id="h28-0-281" class="d">-            }
</a><a href="#h28-0-282" id="h28-0-282" class="d">-        }
</a><a href="#h28-0-283" id="h28-0-283" class="d">-
</a><a href="#h28-0-284" id="h28-0-284" class="d">-        MaterialTheme(
</a><a href="#h28-0-285" id="h28-0-285" class="d">-            colorScheme = MaterialTheme.colorScheme.copy(
</a><a href="#h28-0-286" id="h28-0-286" class="d">-                surface = MaterialTheme.colorScheme.inverseSurface,
</a><a href="#h28-0-287" id="h28-0-287" class="d">-                onSurface = MaterialTheme.colorScheme.inverseOnSurface
</a><a href="#h28-0-288" id="h28-0-288" class="d">-            ),
</a><a href="#h28-0-289" id="h28-0-289" class="d">-            shapes = MaterialTheme.shapes.copy(medium = RoundedCornerShape(50.dp))
</a><a href="#h28-0-290" id="h28-0-290" class="d">-        ) {
</a><a href="#h28-0-291" id="h28-0-291" class="d">-            DropdownMenu(
</a><a href="#h28-0-292" id="h28-0-292" class="d">-                expanded = taskSelectionDropdown, onDismissRequest = { taskSelectionDropdown = false }
</a><a href="#h28-0-293" id="h28-0-293" class="d">-            ) {
</a><a href="#h28-0-294" id="h28-0-294" class="d">-                val hasSelection = selectedMessages.isNotEmpty()
</a><a href="#h28-0-295" id="h28-0-295" class="d">-                ActionButton(text = if (hasSelection) &quot;Save selection&quot; else &quot;Save all&quot;, icon = Icons.Rounded.BookmarkAdded) {
</a><a href="#h28-0-296" id="h28-0-296" class="d">-                    launchMessagingTask(MessagingTaskType.SAVE)
</a><a href="#h28-0-297" id="h28-0-297" class="d">-                    if (hasSelection) runCurrentTask()
</a><a href="#h28-0-298" id="h28-0-298" class="d">-                    else selectConstraintsDialog = true
</a><a href="#h28-0-299" id="h28-0-299" class="d">-                }
</a><a href="#h28-0-300" id="h28-0-300" class="d">-                ActionButton(text = if (hasSelection) &quot;Unsave selection&quot; else &quot;Unsave all&quot;, icon = Icons.Rounded.BookmarkBorder) {
</a><a href="#h28-0-301" id="h28-0-301" class="d">-                    launchMessagingTask(MessagingTaskType.UNSAVE)
</a><a href="#h28-0-302" id="h28-0-302" class="d">-                    if (hasSelection) runCurrentTask()
</a><a href="#h28-0-303" id="h28-0-303" class="d">-                    else selectConstraintsDialog = true
</a><a href="#h28-0-304" id="h28-0-304" class="d">-                }
</a><a href="#h28-0-305" id="h28-0-305" class="d">-                ActionButton(text = if (hasSelection) &quot;Mark selected Snap as seen&quot; else &quot;Mark all Snaps as seen&quot;, icon = Icons.Rounded.RemoveRedEye) {
</a><a href="#h28-0-306" id="h28-0-306" class="d">-                    launchMessagingTask(MessagingTaskType.READ, listOf(
</a><a href="#h28-0-307" id="h28-0-307" class="d">-                        MessagingConstraints.NO_USER_ID(myUserId),
</a><a href="#h28-0-308" id="h28-0-308" class="d">-                        MessagingConstraints.CONTENT_TYPE(arrayOf(ContentType.SNAP))
</a><a href="#h28-0-309" id="h28-0-309" class="d">-                    ))
</a><a href="#h28-0-310" id="h28-0-310" class="d">-                    runCurrentTask()
</a><a href="#h28-0-311" id="h28-0-311" class="d">-                }
</a><a href="#h28-0-312" id="h28-0-312" class="d">-                ActionButton(text = if (hasSelection) &quot;Delete selected&quot; else &quot;Delete all&quot;, icon = Icons.Rounded.DeleteForever) {
</a><a href="#h28-0-313" id="h28-0-313" class="d">-                    launchMessagingTask(MessagingTaskType.DELETE, listOf(MessagingConstraints.USER_ID(myUserId))) { message -&gt;
</a><a href="#h28-0-314" id="h28-0-314" class="d">-                        coroutineScope.launch {
</a><a href="#h28-0-315" id="h28-0-315" class="d">-                            messages.remove(message.serverMessageId)
</a><a href="#h28-0-316" id="h28-0-316" class="d">-                            messageSize = messages.size
</a><a href="#h28-0-317" id="h28-0-317" class="d">-                        }
</a><a href="#h28-0-318" id="h28-0-318" class="d">-                    }
</a><a href="#h28-0-319" id="h28-0-319" class="d">-                    if (hasSelection) runCurrentTask()
</a><a href="#h28-0-320" id="h28-0-320" class="d">-                    else selectConstraintsDialog = true
</a><a href="#h28-0-321" id="h28-0-321" class="d">-                }
</a><a href="#h28-0-322" id="h28-0-322" class="d">-            }
</a><a href="#h28-0-323" id="h28-0-323" class="d">-        }
</a><a href="#h28-0-324" id="h28-0-324" class="d">-    }
</a><a href="#h28-0-325" id="h28-0-325" class="d">-
</a><a href="#h28-0-326" id="h28-0-326" class="d">-    @Composable
</a><a href="#h28-0-327" id="h28-0-327" class="d">-    private fun ConversationPreview() {
</a><a href="#h28-0-328" id="h28-0-328" class="d">-        DisposableEffect(Unit) {
</a><a href="#h28-0-329" id="h28-0-329" class="d">-            onDispose {
</a><a href="#h28-0-330" id="h28-0-330" class="d">-                selectedMessages.clear()
</a><a href="#h28-0-331" id="h28-0-331" class="d">-            }
</a><a href="#h28-0-332" id="h28-0-332" class="d">-        }
</a><a href="#h28-0-333" id="h28-0-333" class="d">-
</a><a href="#h28-0-334" id="h28-0-334" class="d">-        LazyColumn(
</a><a href="#h28-0-335" id="h28-0-335" class="d">-            modifier = Modifier
</a><a href="#h28-0-336" id="h28-0-336" class="d">-                .fillMaxSize(),
</a><a href="#h28-0-337" id="h28-0-337" class="d">-            state = previewScrollState,
</a><a href="#h28-0-338" id="h28-0-338" class="d">-        ) {
</a><a href="#h28-0-339" id="h28-0-339" class="d">-            item {
</a><a href="#h28-0-340" id="h28-0-340" class="d">-                if (messages.isEmpty()) {
</a><a href="#h28-0-341" id="h28-0-341" class="d">-                    Row(
</a><a href="#h28-0-342" id="h28-0-342" class="d">-                        modifier = Modifier
</a><a href="#h28-0-343" id="h28-0-343" class="d">-                            .fillMaxWidth()
</a><a href="#h28-0-344" id="h28-0-344" class="d">-                            .padding(40.dp),
</a><a href="#h28-0-345" id="h28-0-345" class="d">-                        horizontalArrangement = Arrangement.Center
</a><a href="#h28-0-346" id="h28-0-346" class="d">-                    ) {
</a><a href="#h28-0-347" id="h28-0-347" class="d">-                        Text(&quot;No messages&quot;)
</a><a href="#h28-0-348" id="h28-0-348" class="d">-                    }
</a><a href="#h28-0-349" id="h28-0-349" class="d">-                }
</a><a href="#h28-0-350" id="h28-0-350" class="d">-                Spacer(modifier = Modifier.height(20.dp))
</a><a href="#h28-0-351" id="h28-0-351" class="d">-
</a><a href="#h28-0-352" id="h28-0-352" class="d">-                LaunchedEffect(Unit) {
</a><a href="#h28-0-353" id="h28-0-353" class="d">-                    if (messages.size &gt; 0) {
</a><a href="#h28-0-354" id="h28-0-354" class="d">-                        fetchNewMessages()
</a><a href="#h28-0-355" id="h28-0-355" class="d">-                    }
</a><a href="#h28-0-356" id="h28-0-356" class="d">-                }
</a><a href="#h28-0-357" id="h28-0-357" class="d">-            }
</a><a href="#h28-0-358" id="h28-0-358" class="d">-            items(messageSize) {index -&gt;
</a><a href="#h28-0-359" id="h28-0-359" class="d">-                val elementKey = remember(index) { messages.entries.elementAt(index).value.clientMessageId }
</a><a href="#h28-0-360" id="h28-0-360" class="d">-                val messageReader = ProtoReader(messages.entries.elementAt(index).value.content)
</a><a href="#h28-0-361" id="h28-0-361" class="d">-                val contentType = ContentType.fromMessageContainer(messageReader)
</a><a href="#h28-0-362" id="h28-0-362" class="d">-
</a><a href="#h28-0-363" id="h28-0-363" class="d">-                Card(
</a><a href="#h28-0-364" id="h28-0-364" class="d">-                    modifier = Modifier
</a><a href="#h28-0-365" id="h28-0-365" class="d">-                        .padding(5.dp)
</a><a href="#h28-0-366" id="h28-0-366" class="d">-                        .pointerInput(Unit) {
</a><a href="#h28-0-367" id="h28-0-367" class="d">-                            if (contentType == ContentType.STATUS) return@pointerInput
</a><a href="#h28-0-368" id="h28-0-368" class="d">-                            detectTapGestures(
</a><a href="#h28-0-369" id="h28-0-369" class="d">-                                onLongPress = {
</a><a href="#h28-0-370" id="h28-0-370" class="d">-                                    toggleSelectedMessage(elementKey)
</a><a href="#h28-0-371" id="h28-0-371" class="d">-                                },
</a><a href="#h28-0-372" id="h28-0-372" class="d">-                                onTap = {
</a><a href="#h28-0-373" id="h28-0-373" class="d">-                                    if (selectedMessages.isNotEmpty()) {
</a><a href="#h28-0-374" id="h28-0-374" class="d">-                                        toggleSelectedMessage(elementKey)
</a><a href="#h28-0-375" id="h28-0-375" class="d">-                                    }
</a><a href="#h28-0-376" id="h28-0-376" class="d">-                                }
</a><a href="#h28-0-377" id="h28-0-377" class="d">-                            )
</a><a href="#h28-0-378" id="h28-0-378" class="d">-                        },
</a><a href="#h28-0-379" id="h28-0-379" class="d">-                    colors = CardDefaults.cardColors(
</a><a href="#h28-0-380" id="h28-0-380" class="d">-                        containerColor = if (selectedMessages.contains(elementKey)) MaterialTheme.colorScheme.primaryContainer else MaterialTheme.colorScheme.surfaceVariant
</a><a href="#h28-0-381" id="h28-0-381" class="d">-                    ),
</a><a href="#h28-0-382" id="h28-0-382" class="d">-                ) {
</a><a href="#h28-0-383" id="h28-0-383" class="d">-                    Row(
</a><a href="#h28-0-384" id="h28-0-384" class="d">-                        modifier = Modifier
</a><a href="#h28-0-385" id="h28-0-385" class="d">-                            .padding(5.dp)
</a><a href="#h28-0-386" id="h28-0-386" class="d">-                    ) {
</a><a href="#h28-0-387" id="h28-0-387" class="d">-
</a><a href="#h28-0-388" id="h28-0-388" class="d">-                        Text(&quot;[${contentType?.let { contentTypeTranslation.getOrNull(it.name) ?: it.name } }] ${messageReader.getString(2, 1) ?: &quot;&quot;}&quot;)
</a><a href="#h28-0-389" id="h28-0-389" class="d">-                    }
</a><a href="#h28-0-390" id="h28-0-390" class="d">-                }
</a><a href="#h28-0-391" id="h28-0-391" class="d">-            }
</a><a href="#h28-0-392" id="h28-0-392" class="d">-        }
</a><a href="#h28-0-393" id="h28-0-393" class="d">-    }
</a><a href="#h28-0-394" id="h28-0-394" class="d">-
</a><a href="#h28-0-395" id="h28-0-395" class="d">-    private fun fetchNewMessages() {
</a><a href="#h28-0-396" id="h28-0-396" class="d">-        coroutineScope.launch(Dispatchers.IO) cs@{
</a><a href="#h28-0-397" id="h28-0-397" class="d">-            runCatching {
</a><a href="#h28-0-398" id="h28-0-398" class="d">-                val queriedMessages = messagingBridge.fetchConversationWithMessagesPaginated(
</a><a href="#h28-0-399" id="h28-0-399" class="d">-                    conversationId!!,
</a><a href="#h28-0-400" id="h28-0-400" class="d">-                    100,
</a><a href="#h28-0-401" id="h28-0-401" class="d">-                    lastMessageId
</a><a href="#h28-0-402" id="h28-0-402" class="d">-                )
</a><a href="#h28-0-403" id="h28-0-403" class="d">-
</a><a href="#h28-0-404" id="h28-0-404" class="d">-                if (queriedMessages == null) {
</a><a href="#h28-0-405" id="h28-0-405" class="d">-                    context.shortToast(&quot;Failed to fetch messages&quot;)
</a><a href="#h28-0-406" id="h28-0-406" class="d">-                    return@cs
</a><a href="#h28-0-407" id="h28-0-407" class="d">-                }
</a><a href="#h28-0-408" id="h28-0-408" class="d">-
</a><a href="#h28-0-409" id="h28-0-409" class="d">-                coroutineScope.launch {
</a><a href="#h28-0-410" id="h28-0-410" class="d">-                    messages.putAll(queriedMessages.map { it.serverMessageId to it })
</a><a href="#h28-0-411" id="h28-0-411" class="d">-                    messageSize = messages.size
</a><a href="#h28-0-412" id="h28-0-412" class="d">-                    if (queriedMessages.isNotEmpty()) {
</a><a href="#h28-0-413" id="h28-0-413" class="d">-                        lastMessageId = queriedMessages.first().clientMessageId
</a><a href="#h28-0-414" id="h28-0-414" class="d">-                        previewScrollState.scrollToItem(queriedMessages.size - 1)
</a><a href="#h28-0-415" id="h28-0-415" class="d">-                    }
</a><a href="#h28-0-416" id="h28-0-416" class="d">-                }
</a><a href="#h28-0-417" id="h28-0-417" class="d">-            }.onFailure {
</a><a href="#h28-0-418" id="h28-0-418" class="d">-                context.shortToast(&quot;Failed to fetch messages: ${it.message}&quot;)
</a><a href="#h28-0-419" id="h28-0-419" class="d">-            }
</a><a href="#h28-0-420" id="h28-0-420" class="d">-            context.log.verbose(&quot;fetched ${messages.size} messages&quot;)
</a><a href="#h28-0-421" id="h28-0-421" class="d">-        }
</a><a href="#h28-0-422" id="h28-0-422" class="d">-    }
</a><a href="#h28-0-423" id="h28-0-423" class="d">-
</a><a href="#h28-0-424" id="h28-0-424" class="d">-    private fun onMessagingBridgeReady() {
</a><a href="#h28-0-425" id="h28-0-425" class="d">-        runCatching {
</a><a href="#h28-0-426" id="h28-0-426" class="d">-            messagingBridge = context.bridgeService!!.messagingBridge!!
</a><a href="#h28-0-427" id="h28-0-427" class="d">-            conversationId = if (scope == SocialScope.FRIEND) messagingBridge.getOneToOneConversationId(scopeId) else scopeId
</a><a href="#h28-0-428" id="h28-0-428" class="d">-            if (conversationId == null) {
</a><a href="#h28-0-429" id="h28-0-429" class="d">-                context.longToast(&quot;Failed to fetch conversation id&quot;)
</a><a href="#h28-0-430" id="h28-0-430" class="d">-                return
</a><a href="#h28-0-431" id="h28-0-431" class="d">-            }
</a><a href="#h28-0-432" id="h28-0-432" class="d">-            if (!messagingBridge.isSessionStarted) {
</a><a href="#h28-0-433" id="h28-0-433" class="d">-                context.androidContext.packageManager.getLaunchIntentForPackage(
</a><a href="#h28-0-434" id="h28-0-434" class="d">-                    Constants.SNAPCHAT_PACKAGE_NAME
</a><a href="#h28-0-435" id="h28-0-435" class="d">-                )?.let {
</a><a href="#h28-0-436" id="h28-0-436" class="d">-                    val mainIntent = Intent.makeRestartActivityTask(it.component).apply {
</a><a href="#h28-0-437" id="h28-0-437" class="d">-                        putExtra(ReceiversConfig.MESSAGING_PREVIEW_EXTRA, true)
</a><a href="#h28-0-438" id="h28-0-438" class="d">-                    }
</a><a href="#h28-0-439" id="h28-0-439" class="d">-                    context.androidContext.startActivity(mainIntent)
</a><a href="#h28-0-440" id="h28-0-440" class="d">-                }
</a><a href="#h28-0-441" id="h28-0-441" class="d">-                messagingBridge.registerSessionStartListener(object: SessionStartListener.Stub() {
</a><a href="#h28-0-442" id="h28-0-442" class="d">-                    override fun onConnected() {
</a><a href="#h28-0-443" id="h28-0-443" class="d">-                        fetchNewMessages()
</a><a href="#h28-0-444" id="h28-0-444" class="d">-                    }
</a><a href="#h28-0-445" id="h28-0-445" class="d">-                })
</a><a href="#h28-0-446" id="h28-0-446" class="d">-                return
</a><a href="#h28-0-447" id="h28-0-447" class="d">-            }
</a><a href="#h28-0-448" id="h28-0-448" class="d">-            fetchNewMessages()
</a><a href="#h28-0-449" id="h28-0-449" class="d">-        }.onFailure {
</a><a href="#h28-0-450" id="h28-0-450" class="d">-            context.longToast(&quot;Failed to initialize messaging bridge&quot;)
</a><a href="#h28-0-451" id="h28-0-451" class="d">-            context.log.error(&quot;Failed to initialize messaging bridge&quot;, it)
</a><a href="#h28-0-452" id="h28-0-452" class="d">-        }
</a><a href="#h28-0-453" id="h28-0-453" class="d">-    }
</a><a href="#h28-0-454" id="h28-0-454" class="d">-
</a><a href="#h28-0-455" id="h28-0-455" class="d">-    @Composable
</a><a href="#h28-0-456" id="h28-0-456" class="d">-    private fun LoadingRow() {
</a><a href="#h28-0-457" id="h28-0-457" class="d">-        Row(
</a><a href="#h28-0-458" id="h28-0-458" class="d">-            modifier = Modifier
</a><a href="#h28-0-459" id="h28-0-459" class="d">-                .fillMaxWidth()
</a><a href="#h28-0-460" id="h28-0-460" class="d">-                .padding(40.dp),
</a><a href="#h28-0-461" id="h28-0-461" class="d">-            horizontalArrangement = Arrangement.Center
</a><a href="#h28-0-462" id="h28-0-462" class="d">-        ) {
</a><a href="#h28-0-463" id="h28-0-463" class="d">-            CircularProgressIndicator(
</a><a href="#h28-0-464" id="h28-0-464" class="d">-                modifier = Modifier
</a><a href="#h28-0-465" id="h28-0-465" class="d">-                    .padding()
</a><a href="#h28-0-466" id="h28-0-466" class="d">-                    .size(30.dp),
</a><a href="#h28-0-467" id="h28-0-467" class="d">-                strokeWidth = 3.dp,
</a><a href="#h28-0-468" id="h28-0-468" class="d">-                color = MaterialTheme.colorScheme.primary
</a><a href="#h28-0-469" id="h28-0-469" class="d">-            )
</a><a href="#h28-0-470" id="h28-0-470" class="d">-        }
</a><a href="#h28-0-471" id="h28-0-471" class="d">-    }
</a><a href="#h28-0-472" id="h28-0-472" class="d">-
</a><a href="#h28-0-473" id="h28-0-473" class="d">-    @Composable
</a><a href="#h28-0-474" id="h28-0-474" class="d">-    fun Content() {
</a><a href="#h28-0-475" id="h28-0-475" class="d">-        previewScrollState = rememberLazyListState()
</a><a href="#h28-0-476" id="h28-0-476" class="d">-        coroutineScope = rememberCoroutineScope()
</a><a href="#h28-0-477" id="h28-0-477" class="d">-        var isBridgeConnected by remember { mutableStateOf(false) }
</a><a href="#h28-0-478" id="h28-0-478" class="d">-        var hasBridgeError by remember { mutableStateOf(false) }
</a><a href="#h28-0-479" id="h28-0-479" class="d">-
</a><a href="#h28-0-480" id="h28-0-480" class="d">-        Column(
</a><a href="#h28-0-481" id="h28-0-481" class="d">-            modifier = Modifier
</a><a href="#h28-0-482" id="h28-0-482" class="d">-                .fillMaxSize()
</a><a href="#h28-0-483" id="h28-0-483" class="d">-        ) {
</a><a href="#h28-0-484" id="h28-0-484" class="d">-            LaunchedEffect(Unit) {
</a><a href="#h28-0-485" id="h28-0-485" class="d">-                isBridgeConnected = context.hasMessagingBridge()
</a><a href="#h28-0-486" id="h28-0-486" class="d">-                if (isBridgeConnected) {
</a><a href="#h28-0-487" id="h28-0-487" class="d">-                    onMessagingBridgeReady()
</a><a href="#h28-0-488" id="h28-0-488" class="d">-                } else {
</a><a href="#h28-0-489" id="h28-0-489" class="d">-                    SnapWidgetBroadcastReceiverHelper.create(&quot;wakeup&quot;) {}.also {
</a><a href="#h28-0-490" id="h28-0-490" class="d">-                        context.androidContext.sendBroadcast(it)
</a><a href="#h28-0-491" id="h28-0-491" class="d">-                    }
</a><a href="#h28-0-492" id="h28-0-492" class="d">-                    coroutineScope.launch(Dispatchers.IO) {
</a><a href="#h28-0-493" id="h28-0-493" class="d">-                        withTimeout(10000) {
</a><a href="#h28-0-494" id="h28-0-494" class="d">-                            while (!context.hasMessagingBridge()) {
</a><a href="#h28-0-495" id="h28-0-495" class="d">-                                delay(100)
</a><a href="#h28-0-496" id="h28-0-496" class="d">-                            }
</a><a href="#h28-0-497" id="h28-0-497" class="d">-                            isBridgeConnected = true
</a><a href="#h28-0-498" id="h28-0-498" class="d">-                            onMessagingBridgeReady()
</a><a href="#h28-0-499" id="h28-0-499" class="d">-                        }
</a><a href="#h28-0-500" id="h28-0-500" class="d">-                    }.invokeOnCompletion {
</a><a href="#h28-0-501" id="h28-0-501" class="d">-                        if (it != null) {
</a><a href="#h28-0-502" id="h28-0-502" class="d">-                            hasBridgeError = true
</a><a href="#h28-0-503" id="h28-0-503" class="d">-                        }
</a><a href="#h28-0-504" id="h28-0-504" class="d">-                    }
</a><a href="#h28-0-505" id="h28-0-505" class="d">-                }
</a><a href="#h28-0-506" id="h28-0-506" class="d">-            }
</a><a href="#h28-0-507" id="h28-0-507" class="d">-
</a><a href="#h28-0-508" id="h28-0-508" class="d">-            if (hasBridgeError) {
</a><a href="#h28-0-509" id="h28-0-509" class="d">-                Text(&quot;Failed to connect to Snapchat through bridge service&quot;)
</a><a href="#h28-0-510" id="h28-0-510" class="d">-            }
</a><a href="#h28-0-511" id="h28-0-511" class="d">-
</a><a href="#h28-0-512" id="h28-0-512" class="d">-            if (!isBridgeConnected &amp;&amp; !hasBridgeError) {
</a><a href="#h28-0-513" id="h28-0-513" class="d">-                LoadingRow()
</a><a href="#h28-0-514" id="h28-0-514" class="d">-            }
</a><a href="#h28-0-515" id="h28-0-515" class="d">-
</a><a href="#h28-0-516" id="h28-0-516" class="d">-            if (isBridgeConnected &amp;&amp; !hasBridgeError) {
</a><a href="#h28-0-517" id="h28-0-517" class="d">-                ConversationPreview()
</a><a href="#h28-0-518" id="h28-0-518" class="d">-            }
</a><a href="#h28-0-519" id="h28-0-519" class="d">-        }
</a><a href="#h28-0-520" id="h28-0-520" class="d">-    }
</a><a href="#h28-0-521" id="h28-0-521" class="d">-}</a><a href="#h28-0-522" id="h28-0-522" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h29" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/social/ScopeContent.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/social/ScopeContent.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/social/ScopeContent.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/social/ScopeContent.kt</a></b>
<a href="#h29-0" id="h29-0" class="h">@@ -1,359 +0,0 @@
</a><a href="#h29-0-0" id="h29-0-0" class="d">-package me.rhunk.snapenhance.ui.manager.sections.social
</a><a href="#h29-0-1" id="h29-0-1" class="d">-
</a><a href="#h29-0-2" id="h29-0-2" class="d">-import android.content.Intent
</a><a href="#h29-0-3" id="h29-0-3" class="d">-import androidx.compose.foundation.layout.*
</a><a href="#h29-0-4" id="h29-0-4" class="d">-import androidx.compose.foundation.rememberScrollState
</a><a href="#h29-0-5" id="h29-0-5" class="d">-import androidx.compose.foundation.verticalScroll
</a><a href="#h29-0-6" id="h29-0-6" class="d">-import androidx.compose.material3.Button
</a><a href="#h29-0-7" id="h29-0-7" class="d">-import androidx.compose.material3.Card
</a><a href="#h29-0-8" id="h29-0-8" class="d">-import androidx.compose.material3.OutlinedButton
</a><a href="#h29-0-9" id="h29-0-9" class="d">-import androidx.compose.material3.Switch
</a><a href="#h29-0-10" id="h29-0-10" class="d">-import androidx.compose.material3.Text
</a><a href="#h29-0-11" id="h29-0-11" class="d">-import androidx.compose.runtime.Composable
</a><a href="#h29-0-12" id="h29-0-12" class="d">-import androidx.compose.runtime.getValue
</a><a href="#h29-0-13" id="h29-0-13" class="d">-import androidx.compose.runtime.mutableStateOf
</a><a href="#h29-0-14" id="h29-0-14" class="d">-import androidx.compose.runtime.remember
</a><a href="#h29-0-15" id="h29-0-15" class="d">-import androidx.compose.runtime.setValue
</a><a href="#h29-0-16" id="h29-0-16" class="d">-import androidx.compose.ui.Alignment
</a><a href="#h29-0-17" id="h29-0-17" class="d">-import androidx.compose.ui.Modifier
</a><a href="#h29-0-18" id="h29-0-18" class="d">-import androidx.compose.ui.text.font.FontWeight
</a><a href="#h29-0-19" id="h29-0-19" class="d">-import androidx.compose.ui.unit.dp
</a><a href="#h29-0-20" id="h29-0-20" class="d">-import androidx.compose.ui.unit.sp
</a><a href="#h29-0-21" id="h29-0-21" class="d">-import androidx.navigation.NavController
</a><a href="#h29-0-22" id="h29-0-22" class="d">-import kotlinx.coroutines.CoroutineScope
</a><a href="#h29-0-23" id="h29-0-23" class="d">-import kotlinx.coroutines.launch
</a><a href="#h29-0-24" id="h29-0-24" class="d">-import me.rhunk.snapenhance.RemoteSideContext
</a><a href="#h29-0-25" id="h29-0-25" class="d">-import me.rhunk.snapenhance.common.data.MessagingRuleType
</a><a href="#h29-0-26" id="h29-0-26" class="d">-import me.rhunk.snapenhance.common.data.SocialScope
</a><a href="#h29-0-27" id="h29-0-27" class="d">-import me.rhunk.snapenhance.common.util.snap.BitmojiSelfie
</a><a href="#h29-0-28" id="h29-0-28" class="d">-import me.rhunk.snapenhance.ui.util.AlertDialogs
</a><a href="#h29-0-29" id="h29-0-29" class="d">-import me.rhunk.snapenhance.ui.util.BitmojiImage
</a><a href="#h29-0-30" id="h29-0-30" class="d">-import me.rhunk.snapenhance.ui.util.Dialog
</a><a href="#h29-0-31" id="h29-0-31" class="d">-import kotlin.io.encoding.Base64
</a><a href="#h29-0-32" id="h29-0-32" class="d">-import kotlin.io.encoding.ExperimentalEncodingApi
</a><a href="#h29-0-33" id="h29-0-33" class="d">-
</a><a href="#h29-0-34" id="h29-0-34" class="d">-class ScopeContent(
</a><a href="#h29-0-35" id="h29-0-35" class="d">-    private val context: RemoteSideContext,
</a><a href="#h29-0-36" id="h29-0-36" class="d">-    private val section: SocialSection,
</a><a href="#h29-0-37" id="h29-0-37" class="d">-    private val navController: NavController,
</a><a href="#h29-0-38" id="h29-0-38" class="d">-    val scope: SocialScope,
</a><a href="#h29-0-39" id="h29-0-39" class="d">-    private val id: String
</a><a href="#h29-0-40" id="h29-0-40" class="d">-) {
</a><a href="#h29-0-41" id="h29-0-41" class="d">-    private val dialogs by lazy { AlertDialogs(context.translation) }
</a><a href="#h29-0-42" id="h29-0-42" class="d">-    private val translation by lazy { context.translation.getCategory(&quot;manager.sections.social&quot;) }
</a><a href="#h29-0-43" id="h29-0-43" class="d">-
</a><a href="#h29-0-44" id="h29-0-44" class="d">-    fun deleteScope(coroutineScope: CoroutineScope) {
</a><a href="#h29-0-45" id="h29-0-45" class="d">-        when (scope) {
</a><a href="#h29-0-46" id="h29-0-46" class="d">-            SocialScope.FRIEND -&gt; context.modDatabase.deleteFriend(id)
</a><a href="#h29-0-47" id="h29-0-47" class="d">-            SocialScope.GROUP -&gt; context.modDatabase.deleteGroup(id)
</a><a href="#h29-0-48" id="h29-0-48" class="d">-        }
</a><a href="#h29-0-49" id="h29-0-49" class="d">-        context.modDatabase.executeAsync {
</a><a href="#h29-0-50" id="h29-0-50" class="d">-            coroutineScope.launch {
</a><a href="#h29-0-51" id="h29-0-51" class="d">-                section.onResumed()
</a><a href="#h29-0-52" id="h29-0-52" class="d">-                navController.popBackStack()
</a><a href="#h29-0-53" id="h29-0-53" class="d">-            }
</a><a href="#h29-0-54" id="h29-0-54" class="d">-        }
</a><a href="#h29-0-55" id="h29-0-55" class="d">-    }
</a><a href="#h29-0-56" id="h29-0-56" class="d">-
</a><a href="#h29-0-57" id="h29-0-57" class="d">-    @Composable
</a><a href="#h29-0-58" id="h29-0-58" class="d">-    fun Content() {
</a><a href="#h29-0-59" id="h29-0-59" class="d">-        Column(
</a><a href="#h29-0-60" id="h29-0-60" class="d">-            modifier = Modifier.verticalScroll(rememberScrollState())
</a><a href="#h29-0-61" id="h29-0-61" class="d">-        ) {
</a><a href="#h29-0-62" id="h29-0-62" class="d">-            when (scope) {
</a><a href="#h29-0-63" id="h29-0-63" class="d">-                SocialScope.FRIEND -&gt; Friend()
</a><a href="#h29-0-64" id="h29-0-64" class="d">-                SocialScope.GROUP -&gt; Group()
</a><a href="#h29-0-65" id="h29-0-65" class="d">-            }
</a><a href="#h29-0-66" id="h29-0-66" class="d">-
</a><a href="#h29-0-67" id="h29-0-67" class="d">-            Spacer(modifier = Modifier.height(16.dp))
</a><a href="#h29-0-68" id="h29-0-68" class="d">-
</a><a href="#h29-0-69" id="h29-0-69" class="d">-            val rules = context.modDatabase.getRules(id)
</a><a href="#h29-0-70" id="h29-0-70" class="d">-
</a><a href="#h29-0-71" id="h29-0-71" class="d">-            SectionTitle(translation[&quot;rules_title&quot;])
</a><a href="#h29-0-72" id="h29-0-72" class="d">-
</a><a href="#h29-0-73" id="h29-0-73" class="d">-            ContentCard {
</a><a href="#h29-0-74" id="h29-0-74" class="d">-                //manager anti features etc
</a><a href="#h29-0-75" id="h29-0-75" class="d">-                MessagingRuleType.entries.forEach { ruleType -&gt;
</a><a href="#h29-0-76" id="h29-0-76" class="d">-                    var ruleEnabled by remember {
</a><a href="#h29-0-77" id="h29-0-77" class="d">-                        mutableStateOf(rules.any { it.key == ruleType.key })
</a><a href="#h29-0-78" id="h29-0-78" class="d">-                    }
</a><a href="#h29-0-79" id="h29-0-79" class="d">-
</a><a href="#h29-0-80" id="h29-0-80" class="d">-                    val ruleState = context.config.root.rules.getRuleState(ruleType)
</a><a href="#h29-0-81" id="h29-0-81" class="d">-
</a><a href="#h29-0-82" id="h29-0-82" class="d">-                    Row(
</a><a href="#h29-0-83" id="h29-0-83" class="d">-                        verticalAlignment = Alignment.CenterVertically,
</a><a href="#h29-0-84" id="h29-0-84" class="d">-                        modifier = Modifier.padding(all = 4.dp)
</a><a href="#h29-0-85" id="h29-0-85" class="d">-                    ) {
</a><a href="#h29-0-86" id="h29-0-86" class="d">-                        Text(
</a><a href="#h29-0-87" id="h29-0-87" class="d">-                            text = if (ruleType.listMode &amp;&amp; ruleState != null) {
</a><a href="#h29-0-88" id="h29-0-88" class="d">-                                context.translation[&quot;rules.properties.${ruleType.key}.options.${ruleState.key}&quot;]
</a><a href="#h29-0-89" id="h29-0-89" class="d">-                            } else context.translation[&quot;rules.properties.${ruleType.key}.name&quot;],
</a><a href="#h29-0-90" id="h29-0-90" class="d">-                            modifier = Modifier.weight(1f).padding(start = 5.dp, end = 5.dp)
</a><a href="#h29-0-91" id="h29-0-91" class="d">-                        )
</a><a href="#h29-0-92" id="h29-0-92" class="d">-                        Switch(checked = ruleEnabled,
</a><a href="#h29-0-93" id="h29-0-93" class="d">-                            enabled = if (ruleType.listMode) ruleState != null else true,
</a><a href="#h29-0-94" id="h29-0-94" class="d">-                            onCheckedChange = {
</a><a href="#h29-0-95" id="h29-0-95" class="d">-                                context.modDatabase.setRule(id, ruleType.key, it)
</a><a href="#h29-0-96" id="h29-0-96" class="d">-                                ruleEnabled = it
</a><a href="#h29-0-97" id="h29-0-97" class="d">-                            })
</a><a href="#h29-0-98" id="h29-0-98" class="d">-                    }
</a><a href="#h29-0-99" id="h29-0-99" class="d">-                }
</a><a href="#h29-0-100" id="h29-0-100" class="d">-            }
</a><a href="#h29-0-101" id="h29-0-101" class="d">-        }
</a><a href="#h29-0-102" id="h29-0-102" class="d">-    }
</a><a href="#h29-0-103" id="h29-0-103" class="d">-
</a><a href="#h29-0-104" id="h29-0-104" class="d">-    @Composable
</a><a href="#h29-0-105" id="h29-0-105" class="d">-    private fun ContentCard(modifier: Modifier = Modifier, content: @Composable () -&gt; Unit) {
</a><a href="#h29-0-106" id="h29-0-106" class="d">-        Card(
</a><a href="#h29-0-107" id="h29-0-107" class="d">-            modifier = Modifier
</a><a href="#h29-0-108" id="h29-0-108" class="d">-                .padding(10.dp)
</a><a href="#h29-0-109" id="h29-0-109" class="d">-                .fillMaxWidth()
</a><a href="#h29-0-110" id="h29-0-110" class="d">-        ) {
</a><a href="#h29-0-111" id="h29-0-111" class="d">-            Column(
</a><a href="#h29-0-112" id="h29-0-112" class="d">-                modifier = Modifier
</a><a href="#h29-0-113" id="h29-0-113" class="d">-                    .padding(10.dp)
</a><a href="#h29-0-114" id="h29-0-114" class="d">-                    .fillMaxWidth()
</a><a href="#h29-0-115" id="h29-0-115" class="d">-                    .then(modifier)
</a><a href="#h29-0-116" id="h29-0-116" class="d">-            ) {
</a><a href="#h29-0-117" id="h29-0-117" class="d">-                content()
</a><a href="#h29-0-118" id="h29-0-118" class="d">-            }
</a><a href="#h29-0-119" id="h29-0-119" class="d">-        }
</a><a href="#h29-0-120" id="h29-0-120" class="d">-    }
</a><a href="#h29-0-121" id="h29-0-121" class="d">-
</a><a href="#h29-0-122" id="h29-0-122" class="d">-    @Composable
</a><a href="#h29-0-123" id="h29-0-123" class="d">-    private fun SectionTitle(title: String) {
</a><a href="#h29-0-124" id="h29-0-124" class="d">-        Text(
</a><a href="#h29-0-125" id="h29-0-125" class="d">-            text = title,
</a><a href="#h29-0-126" id="h29-0-126" class="d">-            maxLines = 1,
</a><a href="#h29-0-127" id="h29-0-127" class="d">-            fontSize = 20.sp,
</a><a href="#h29-0-128" id="h29-0-128" class="d">-            fontWeight = FontWeight.Bold,
</a><a href="#h29-0-129" id="h29-0-129" class="d">-            modifier = Modifier
</a><a href="#h29-0-130" id="h29-0-130" class="d">-                .offset(x = 20.dp)
</a><a href="#h29-0-131" id="h29-0-131" class="d">-                .padding(bottom = 10.dp)
</a><a href="#h29-0-132" id="h29-0-132" class="d">-        )
</a><a href="#h29-0-133" id="h29-0-133" class="d">-    }
</a><a href="#h29-0-134" id="h29-0-134" class="d">-
</a><a href="#h29-0-135" id="h29-0-135" class="d">-    //need to display all units?
</a><a href="#h29-0-136" id="h29-0-136" class="d">-    private fun computeStreakETA(timestamp: Long): String {
</a><a href="#h29-0-137" id="h29-0-137" class="d">-        val now = System.currentTimeMillis()
</a><a href="#h29-0-138" id="h29-0-138" class="d">-        val stringBuilder = StringBuilder()
</a><a href="#h29-0-139" id="h29-0-139" class="d">-        val diff = timestamp - now
</a><a href="#h29-0-140" id="h29-0-140" class="d">-        val seconds = diff / 1000
</a><a href="#h29-0-141" id="h29-0-141" class="d">-        val minutes = seconds / 60
</a><a href="#h29-0-142" id="h29-0-142" class="d">-        val hours = minutes / 60
</a><a href="#h29-0-143" id="h29-0-143" class="d">-        val days = hours / 24
</a><a href="#h29-0-144" id="h29-0-144" class="d">-        if (days &gt; 0) {
</a><a href="#h29-0-145" id="h29-0-145" class="d">-            stringBuilder.append(&quot;$days day &quot;)
</a><a href="#h29-0-146" id="h29-0-146" class="d">-            return stringBuilder.toString()
</a><a href="#h29-0-147" id="h29-0-147" class="d">-        }
</a><a href="#h29-0-148" id="h29-0-148" class="d">-        if (hours &gt; 0) {
</a><a href="#h29-0-149" id="h29-0-149" class="d">-            stringBuilder.append(&quot;$hours hours &quot;)
</a><a href="#h29-0-150" id="h29-0-150" class="d">-            return stringBuilder.toString()
</a><a href="#h29-0-151" id="h29-0-151" class="d">-        }
</a><a href="#h29-0-152" id="h29-0-152" class="d">-        if (minutes &gt; 0) {
</a><a href="#h29-0-153" id="h29-0-153" class="d">-            stringBuilder.append(&quot;$minutes minutes &quot;)
</a><a href="#h29-0-154" id="h29-0-154" class="d">-            return stringBuilder.toString()
</a><a href="#h29-0-155" id="h29-0-155" class="d">-        }
</a><a href="#h29-0-156" id="h29-0-156" class="d">-        if (seconds &gt; 0) {
</a><a href="#h29-0-157" id="h29-0-157" class="d">-            stringBuilder.append(&quot;$seconds seconds &quot;)
</a><a href="#h29-0-158" id="h29-0-158" class="d">-            return stringBuilder.toString()
</a><a href="#h29-0-159" id="h29-0-159" class="d">-        }
</a><a href="#h29-0-160" id="h29-0-160" class="d">-        return &quot;Expired&quot;
</a><a href="#h29-0-161" id="h29-0-161" class="d">-    }
</a><a href="#h29-0-162" id="h29-0-162" class="d">-
</a><a href="#h29-0-163" id="h29-0-163" class="d">-    @OptIn(ExperimentalEncodingApi::class)
</a><a href="#h29-0-164" id="h29-0-164" class="d">-    @Composable
</a><a href="#h29-0-165" id="h29-0-165" class="d">-    private fun Friend() {
</a><a href="#h29-0-166" id="h29-0-166" class="d">-        //fetch the friend from the database
</a><a href="#h29-0-167" id="h29-0-167" class="d">-        val friend = remember { context.modDatabase.getFriendInfo(id) } ?: run {
</a><a href="#h29-0-168" id="h29-0-168" class="d">-            Text(text = translation[&quot;not_found&quot;])
</a><a href="#h29-0-169" id="h29-0-169" class="d">-            return
</a><a href="#h29-0-170" id="h29-0-170" class="d">-        }
</a><a href="#h29-0-171" id="h29-0-171" class="d">-
</a><a href="#h29-0-172" id="h29-0-172" class="d">-        val streaks = remember {
</a><a href="#h29-0-173" id="h29-0-173" class="d">-            context.modDatabase.getFriendStreaks(id)
</a><a href="#h29-0-174" id="h29-0-174" class="d">-        }
</a><a href="#h29-0-175" id="h29-0-175" class="d">-
</a><a href="#h29-0-176" id="h29-0-176" class="d">-        Column(
</a><a href="#h29-0-177" id="h29-0-177" class="d">-            modifier = Modifier
</a><a href="#h29-0-178" id="h29-0-178" class="d">-                .padding(10.dp)
</a><a href="#h29-0-179" id="h29-0-179" class="d">-                .fillMaxWidth(),
</a><a href="#h29-0-180" id="h29-0-180" class="d">-            horizontalAlignment = Alignment.CenterHorizontally
</a><a href="#h29-0-181" id="h29-0-181" class="d">-        ) {
</a><a href="#h29-0-182" id="h29-0-182" class="d">-            val bitmojiUrl = BitmojiSelfie.getBitmojiSelfie(
</a><a href="#h29-0-183" id="h29-0-183" class="d">-                friend.selfieId, friend.bitmojiId, BitmojiSelfie.BitmojiSelfieType.THREE_D
</a><a href="#h29-0-184" id="h29-0-184" class="d">-            )
</a><a href="#h29-0-185" id="h29-0-185" class="d">-            BitmojiImage(context = context, url = bitmojiUrl, size = 100)
</a><a href="#h29-0-186" id="h29-0-186" class="d">-            Spacer(modifier = Modifier.height(16.dp))
</a><a href="#h29-0-187" id="h29-0-187" class="d">-            Text(
</a><a href="#h29-0-188" id="h29-0-188" class="d">-                text = friend.displayName ?: friend.mutableUsername,
</a><a href="#h29-0-189" id="h29-0-189" class="d">-                maxLines = 1,
</a><a href="#h29-0-190" id="h29-0-190" class="d">-                fontSize = 20.sp,
</a><a href="#h29-0-191" id="h29-0-191" class="d">-                fontWeight = FontWeight.Bold
</a><a href="#h29-0-192" id="h29-0-192" class="d">-            )
</a><a href="#h29-0-193" id="h29-0-193" class="d">-            Spacer(modifier = Modifier.height(5.dp))
</a><a href="#h29-0-194" id="h29-0-194" class="d">-            Text(
</a><a href="#h29-0-195" id="h29-0-195" class="d">-                text = friend.mutableUsername,
</a><a href="#h29-0-196" id="h29-0-196" class="d">-                maxLines = 1,
</a><a href="#h29-0-197" id="h29-0-197" class="d">-                fontSize = 12.sp,
</a><a href="#h29-0-198" id="h29-0-198" class="d">-                fontWeight = FontWeight.Light
</a><a href="#h29-0-199" id="h29-0-199" class="d">-            )
</a><a href="#h29-0-200" id="h29-0-200" class="d">-        }
</a><a href="#h29-0-201" id="h29-0-201" class="d">-
</a><a href="#h29-0-202" id="h29-0-202" class="d">-        Spacer(modifier = Modifier.height(16.dp))
</a><a href="#h29-0-203" id="h29-0-203" class="d">-
</a><a href="#h29-0-204" id="h29-0-204" class="d">-        if (context.config.root.experimental.storyLogger.get()) {
</a><a href="#h29-0-205" id="h29-0-205" class="d">-            Row(
</a><a href="#h29-0-206" id="h29-0-206" class="d">-                modifier = Modifier.fillMaxWidth(),
</a><a href="#h29-0-207" id="h29-0-207" class="d">-                horizontalArrangement = Arrangement.spacedBy(10.dp, Alignment.CenterHorizontally),
</a><a href="#h29-0-208" id="h29-0-208" class="d">-            ) {
</a><a href="#h29-0-209" id="h29-0-209" class="d">-                Button(onClick = {
</a><a href="#h29-0-210" id="h29-0-210" class="d">-                    navController.navigate(SocialSection.LOGGED_STORIES_ROUTE.replace(&quot;{userId}&quot;, id))
</a><a href="#h29-0-211" id="h29-0-211" class="d">-                }) {
</a><a href="#h29-0-212" id="h29-0-212" class="d">-                    Text(&quot;Show Logged Stories&quot;)
</a><a href="#h29-0-213" id="h29-0-213" class="d">-                }
</a><a href="#h29-0-214" id="h29-0-214" class="d">-            }
</a><a href="#h29-0-215" id="h29-0-215" class="d">-
</a><a href="#h29-0-216" id="h29-0-216" class="d">-            Spacer(modifier = Modifier.height(16.dp))
</a><a href="#h29-0-217" id="h29-0-217" class="d">-        }
</a><a href="#h29-0-218" id="h29-0-218" class="d">-
</a><a href="#h29-0-219" id="h29-0-219" class="d">-        Column {
</a><a href="#h29-0-220" id="h29-0-220" class="d">-            //streaks
</a><a href="#h29-0-221" id="h29-0-221" class="d">-            streaks?.let {
</a><a href="#h29-0-222" id="h29-0-222" class="d">-                var shouldNotify by remember { mutableStateOf(it.notify) }
</a><a href="#h29-0-223" id="h29-0-223" class="d">-                SectionTitle(translation[&quot;streaks_title&quot;])
</a><a href="#h29-0-224" id="h29-0-224" class="d">-                ContentCard {
</a><a href="#h29-0-225" id="h29-0-225" class="d">-                    Row(
</a><a href="#h29-0-226" id="h29-0-226" class="d">-                        verticalAlignment = Alignment.CenterVertically
</a><a href="#h29-0-227" id="h29-0-227" class="d">-                    ) {
</a><a href="#h29-0-228" id="h29-0-228" class="d">-                        Column(
</a><a href="#h29-0-229" id="h29-0-229" class="d">-                            modifier = Modifier.weight(1f),
</a><a href="#h29-0-230" id="h29-0-230" class="d">-                        ) {
</a><a href="#h29-0-231" id="h29-0-231" class="d">-                            Text(
</a><a href="#h29-0-232" id="h29-0-232" class="d">-                                text = translation.format(
</a><a href="#h29-0-233" id="h29-0-233" class="d">-                                    &quot;streaks_length_text&quot;, &quot;length&quot; to streaks.length.toString()
</a><a href="#h29-0-234" id="h29-0-234" class="d">-                                ), maxLines = 1
</a><a href="#h29-0-235" id="h29-0-235" class="d">-                            )
</a><a href="#h29-0-236" id="h29-0-236" class="d">-                            Text(
</a><a href="#h29-0-237" id="h29-0-237" class="d">-                                text = translation.format(
</a><a href="#h29-0-238" id="h29-0-238" class="d">-                                    &quot;streaks_expiration_text&quot;,
</a><a href="#h29-0-239" id="h29-0-239" class="d">-                                    &quot;eta&quot; to computeStreakETA(streaks.expirationTimestamp)
</a><a href="#h29-0-240" id="h29-0-240" class="d">-                                ), maxLines = 1
</a><a href="#h29-0-241" id="h29-0-241" class="d">-                            )
</a><a href="#h29-0-242" id="h29-0-242" class="d">-                        }
</a><a href="#h29-0-243" id="h29-0-243" class="d">-                        Row(
</a><a href="#h29-0-244" id="h29-0-244" class="d">-                            verticalAlignment = Alignment.CenterVertically
</a><a href="#h29-0-245" id="h29-0-245" class="d">-                        ) {
</a><a href="#h29-0-246" id="h29-0-246" class="d">-                            Text(
</a><a href="#h29-0-247" id="h29-0-247" class="d">-                                text = translation[&quot;reminder_button&quot;],
</a><a href="#h29-0-248" id="h29-0-248" class="d">-                                maxLines = 1,
</a><a href="#h29-0-249" id="h29-0-249" class="d">-                                modifier = Modifier.padding(end = 10.dp)
</a><a href="#h29-0-250" id="h29-0-250" class="d">-                            )
</a><a href="#h29-0-251" id="h29-0-251" class="d">-                            Switch(checked = shouldNotify, onCheckedChange = {
</a><a href="#h29-0-252" id="h29-0-252" class="d">-                                context.modDatabase.setFriendStreaksNotify(id, it)
</a><a href="#h29-0-253" id="h29-0-253" class="d">-                                shouldNotify = it
</a><a href="#h29-0-254" id="h29-0-254" class="d">-                            })
</a><a href="#h29-0-255" id="h29-0-255" class="d">-                        }
</a><a href="#h29-0-256" id="h29-0-256" class="d">-                    }
</a><a href="#h29-0-257" id="h29-0-257" class="d">-                }
</a><a href="#h29-0-258" id="h29-0-258" class="d">-            }
</a><a href="#h29-0-259" id="h29-0-259" class="d">-            Spacer(modifier = Modifier.height(16.dp))
</a><a href="#h29-0-260" id="h29-0-260" class="d">-            // e2ee section
</a><a href="#h29-0-261" id="h29-0-261" class="d">-
</a><a href="#h29-0-262" id="h29-0-262" class="d">-            if (context.config.root.experimental.e2eEncryption.globalState == true) {
</a><a href="#h29-0-263" id="h29-0-263" class="d">-                SectionTitle(translation[&quot;e2ee_title&quot;])
</a><a href="#h29-0-264" id="h29-0-264" class="d">-                var hasSecretKey by remember { mutableStateOf(context.e2eeImplementation.friendKeyExists(friend.userId))}
</a><a href="#h29-0-265" id="h29-0-265" class="d">-                var importDialog by remember { mutableStateOf(false) }
</a><a href="#h29-0-266" id="h29-0-266" class="d">-
</a><a href="#h29-0-267" id="h29-0-267" class="d">-                if (importDialog) {
</a><a href="#h29-0-268" id="h29-0-268" class="d">-                    Dialog(
</a><a href="#h29-0-269" id="h29-0-269" class="d">-                        onDismissRequest = { importDialog = false }
</a><a href="#h29-0-270" id="h29-0-270" class="d">-                    ) {
</a><a href="#h29-0-271" id="h29-0-271" class="d">-                        dialogs.RawInputDialog(onDismiss = { importDialog = false  }, onConfirm = { newKey -&gt;
</a><a href="#h29-0-272" id="h29-0-272" class="d">-                            importDialog = false
</a><a href="#h29-0-273" id="h29-0-273" class="d">-                            runCatching {
</a><a href="#h29-0-274" id="h29-0-274" class="d">-                                val key = Base64.decode(newKey)
</a><a href="#h29-0-275" id="h29-0-275" class="d">-                                if (key.size != 32) {
</a><a href="#h29-0-276" id="h29-0-276" class="d">-                                    context.longToast(&quot;Invalid key size (must be 32 bytes)&quot;)
</a><a href="#h29-0-277" id="h29-0-277" class="d">-                                    return@runCatching
</a><a href="#h29-0-278" id="h29-0-278" class="d">-                                }
</a><a href="#h29-0-279" id="h29-0-279" class="d">-
</a><a href="#h29-0-280" id="h29-0-280" class="d">-                                context.e2eeImplementation.storeSharedSecretKey(friend.userId, key)
</a><a href="#h29-0-281" id="h29-0-281" class="d">-                                context.longToast(&quot;Successfully imported key&quot;)
</a><a href="#h29-0-282" id="h29-0-282" class="d">-                                hasSecretKey = true
</a><a href="#h29-0-283" id="h29-0-283" class="d">-                            }.onFailure {
</a><a href="#h29-0-284" id="h29-0-284" class="d">-                                context.longToast(&quot;Failed to import key: ${it.message}&quot;)
</a><a href="#h29-0-285" id="h29-0-285" class="d">-                                context.log.error(&quot;Failed to import key&quot;, it)
</a><a href="#h29-0-286" id="h29-0-286" class="d">-                            }
</a><a href="#h29-0-287" id="h29-0-287" class="d">-                        })
</a><a href="#h29-0-288" id="h29-0-288" class="d">-                    }
</a><a href="#h29-0-289" id="h29-0-289" class="d">-                }
</a><a href="#h29-0-290" id="h29-0-290" class="d">-
</a><a href="#h29-0-291" id="h29-0-291" class="d">-                ContentCard {
</a><a href="#h29-0-292" id="h29-0-292" class="d">-                    Row(
</a><a href="#h29-0-293" id="h29-0-293" class="d">-                        verticalAlignment = Alignment.CenterVertically,
</a><a href="#h29-0-294" id="h29-0-294" class="d">-                        horizontalArrangement = Arrangement.spacedBy(10.dp)
</a><a href="#h29-0-295" id="h29-0-295" class="d">-                    ) {
</a><a href="#h29-0-296" id="h29-0-296" class="d">-                        if (hasSecretKey) {
</a><a href="#h29-0-297" id="h29-0-297" class="d">-                            OutlinedButton(onClick = {
</a><a href="#h29-0-298" id="h29-0-298" class="d">-                                val secretKey = Base64.encode(context.e2eeImplementation.getSharedSecretKey(friend.userId) ?: return@OutlinedButton)
</a><a href="#h29-0-299" id="h29-0-299" class="d">-                                //TODO: fingerprint auth
</a><a href="#h29-0-300" id="h29-0-300" class="d">-                                context.activity!!.startActivity(Intent.createChooser(Intent().apply {
</a><a href="#h29-0-301" id="h29-0-301" class="d">-                                    action = Intent.ACTION_SEND
</a><a href="#h29-0-302" id="h29-0-302" class="d">-                                    putExtra(Intent.EXTRA_TEXT, secretKey)
</a><a href="#h29-0-303" id="h29-0-303" class="d">-                                    type = &quot;text/plain&quot;
</a><a href="#h29-0-304" id="h29-0-304" class="d">-                                }, &quot;&quot;).apply {
</a><a href="#h29-0-305" id="h29-0-305" class="d">-                                    putExtra(Intent.EXTRA_INITIAL_INTENTS, arrayOf(
</a><a href="#h29-0-306" id="h29-0-306" class="d">-                                        Intent().apply {
</a><a href="#h29-0-307" id="h29-0-307" class="d">-                                            putExtra(Intent.EXTRA_TEXT, secretKey)
</a><a href="#h29-0-308" id="h29-0-308" class="d">-                                            putExtra(Intent.EXTRA_SUBJECT, secretKey)
</a><a href="#h29-0-309" id="h29-0-309" class="d">-                                        })
</a><a href="#h29-0-310" id="h29-0-310" class="d">-                                    )
</a><a href="#h29-0-311" id="h29-0-311" class="d">-                                })
</a><a href="#h29-0-312" id="h29-0-312" class="d">-                            }) {
</a><a href="#h29-0-313" id="h29-0-313" class="d">-                                Text(
</a><a href="#h29-0-314" id="h29-0-314" class="d">-                                    text = &quot;Export Base64&quot;,
</a><a href="#h29-0-315" id="h29-0-315" class="d">-                                    maxLines = 1
</a><a href="#h29-0-316" id="h29-0-316" class="d">-                                )
</a><a href="#h29-0-317" id="h29-0-317" class="d">-                            }
</a><a href="#h29-0-318" id="h29-0-318" class="d">-                        }
</a><a href="#h29-0-319" id="h29-0-319" class="d">-
</a><a href="#h29-0-320" id="h29-0-320" class="d">-                        OutlinedButton(onClick = { importDialog = true }) {
</a><a href="#h29-0-321" id="h29-0-321" class="d">-                            Text(
</a><a href="#h29-0-322" id="h29-0-322" class="d">-                                text = &quot;Import Base64&quot;,
</a><a href="#h29-0-323" id="h29-0-323" class="d">-                                maxLines = 1
</a><a href="#h29-0-324" id="h29-0-324" class="d">-                            )
</a><a href="#h29-0-325" id="h29-0-325" class="d">-                        }
</a><a href="#h29-0-326" id="h29-0-326" class="d">-                    }
</a><a href="#h29-0-327" id="h29-0-327" class="d">-                }
</a><a href="#h29-0-328" id="h29-0-328" class="d">-            }
</a><a href="#h29-0-329" id="h29-0-329" class="d">-        }
</a><a href="#h29-0-330" id="h29-0-330" class="d">-    }
</a><a href="#h29-0-331" id="h29-0-331" class="d">-
</a><a href="#h29-0-332" id="h29-0-332" class="d">-    @Composable
</a><a href="#h29-0-333" id="h29-0-333" class="d">-    private fun Group() {
</a><a href="#h29-0-334" id="h29-0-334" class="d">-        //fetch the group from the database
</a><a href="#h29-0-335" id="h29-0-335" class="d">-        val group = remember { context.modDatabase.getGroupInfo(id) } ?: run {
</a><a href="#h29-0-336" id="h29-0-336" class="d">-            Text(text = translation[&quot;not_found&quot;])
</a><a href="#h29-0-337" id="h29-0-337" class="d">-            return
</a><a href="#h29-0-338" id="h29-0-338" class="d">-        }
</a><a href="#h29-0-339" id="h29-0-339" class="d">-
</a><a href="#h29-0-340" id="h29-0-340" class="d">-
</a><a href="#h29-0-341" id="h29-0-341" class="d">-        Column(
</a><a href="#h29-0-342" id="h29-0-342" class="d">-            modifier = Modifier
</a><a href="#h29-0-343" id="h29-0-343" class="d">-                .padding(10.dp)
</a><a href="#h29-0-344" id="h29-0-344" class="d">-                .fillMaxWidth(),
</a><a href="#h29-0-345" id="h29-0-345" class="d">-            horizontalAlignment = Alignment.CenterHorizontally
</a><a href="#h29-0-346" id="h29-0-346" class="d">-        ) {
</a><a href="#h29-0-347" id="h29-0-347" class="d">-            Text(
</a><a href="#h29-0-348" id="h29-0-348" class="d">-                text = group.name, maxLines = 1, fontSize = 20.sp, fontWeight = FontWeight.Bold
</a><a href="#h29-0-349" id="h29-0-349" class="d">-            )
</a><a href="#h29-0-350" id="h29-0-350" class="d">-            Spacer(modifier = Modifier.height(5.dp))
</a><a href="#h29-0-351" id="h29-0-351" class="d">-            Text(
</a><a href="#h29-0-352" id="h29-0-352" class="d">-                text = translation.format(
</a><a href="#h29-0-353" id="h29-0-353" class="d">-                    &quot;participants_text&quot;, &quot;count&quot; to group.participantsCount.toString()
</a><a href="#h29-0-354" id="h29-0-354" class="d">-                ), maxLines = 1, fontSize = 12.sp, fontWeight = FontWeight.Light
</a><a href="#h29-0-355" id="h29-0-355" class="d">-            )
</a><a href="#h29-0-356" id="h29-0-356" class="d">-        }
</a><a href="#h29-0-357" id="h29-0-357" class="d">-    }
</a><a href="#h29-0-358" id="h29-0-358" class="d">-}</a><a href="#h29-0-359" id="h29-0-359" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h30" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/social/SocialSection.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/social/SocialSection.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/social/SocialSection.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/social/SocialSection.kt</a></b>
<a href="#h30-0" id="h30-0" class="h">@@ -1,363 +0,0 @@
</a><a href="#h30-0-0" id="h30-0-0" class="d">-package me.rhunk.snapenhance.ui.manager.sections.social
</a><a href="#h30-0-1" id="h30-0-1" class="d">-
</a><a href="#h30-0-2" id="h30-0-2" class="d">-import androidx.compose.foundation.ExperimentalFoundationApi
</a><a href="#h30-0-3" id="h30-0-3" class="d">-import androidx.compose.foundation.clickable
</a><a href="#h30-0-4" id="h30-0-4" class="d">-import androidx.compose.foundation.layout.*
</a><a href="#h30-0-5" id="h30-0-5" class="d">-import androidx.compose.foundation.lazy.LazyColumn
</a><a href="#h30-0-6" id="h30-0-6" class="d">-import androidx.compose.foundation.pager.HorizontalPager
</a><a href="#h30-0-7" id="h30-0-7" class="d">-import androidx.compose.foundation.pager.rememberPagerState
</a><a href="#h30-0-8" id="h30-0-8" class="d">-import androidx.compose.foundation.shape.RoundedCornerShape
</a><a href="#h30-0-9" id="h30-0-9" class="d">-import androidx.compose.material.icons.Icons
</a><a href="#h30-0-10" id="h30-0-10" class="d">-import androidx.compose.material.icons.filled.RemoveRedEye
</a><a href="#h30-0-11" id="h30-0-11" class="d">-import androidx.compose.material.icons.rounded.Add
</a><a href="#h30-0-12" id="h30-0-12" class="d">-import androidx.compose.material.icons.rounded.DeleteForever
</a><a href="#h30-0-13" id="h30-0-13" class="d">-import androidx.compose.material3.*
</a><a href="#h30-0-14" id="h30-0-14" class="d">-import androidx.compose.runtime.*
</a><a href="#h30-0-15" id="h30-0-15" class="d">-import androidx.compose.ui.Alignment
</a><a href="#h30-0-16" id="h30-0-16" class="d">-import androidx.compose.ui.Modifier
</a><a href="#h30-0-17" id="h30-0-17" class="d">-import androidx.compose.ui.graphics.vector.ImageVector
</a><a href="#h30-0-18" id="h30-0-18" class="d">-import androidx.compose.ui.res.vectorResource
</a><a href="#h30-0-19" id="h30-0-19" class="d">-import androidx.compose.ui.text.font.FontWeight
</a><a href="#h30-0-20" id="h30-0-20" class="d">-import androidx.compose.ui.text.style.TextAlign
</a><a href="#h30-0-21" id="h30-0-21" class="d">-import androidx.compose.ui.text.style.TextOverflow
</a><a href="#h30-0-22" id="h30-0-22" class="d">-import androidx.compose.ui.unit.dp
</a><a href="#h30-0-23" id="h30-0-23" class="d">-import androidx.compose.ui.unit.sp
</a><a href="#h30-0-24" id="h30-0-24" class="d">-import androidx.compose.ui.window.Dialog
</a><a href="#h30-0-25" id="h30-0-25" class="d">-import androidx.navigation.NavGraphBuilder
</a><a href="#h30-0-26" id="h30-0-26" class="d">-import androidx.navigation.compose.composable
</a><a href="#h30-0-27" id="h30-0-27" class="d">-import androidx.navigation.navigation
</a><a href="#h30-0-28" id="h30-0-28" class="d">-import kotlinx.coroutines.Dispatchers
</a><a href="#h30-0-29" id="h30-0-29" class="d">-import kotlinx.coroutines.launch
</a><a href="#h30-0-30" id="h30-0-30" class="d">-import kotlinx.coroutines.withContext
</a><a href="#h30-0-31" id="h30-0-31" class="d">-import me.rhunk.snapenhance.R
</a><a href="#h30-0-32" id="h30-0-32" class="d">-import me.rhunk.snapenhance.common.data.MessagingFriendInfo
</a><a href="#h30-0-33" id="h30-0-33" class="d">-import me.rhunk.snapenhance.common.data.MessagingGroupInfo
</a><a href="#h30-0-34" id="h30-0-34" class="d">-import me.rhunk.snapenhance.common.data.SocialScope
</a><a href="#h30-0-35" id="h30-0-35" class="d">-import me.rhunk.snapenhance.common.util.snap.BitmojiSelfie
</a><a href="#h30-0-36" id="h30-0-36" class="d">-import me.rhunk.snapenhance.ui.manager.Section
</a><a href="#h30-0-37" id="h30-0-37" class="d">-import me.rhunk.snapenhance.ui.util.AlertDialogs
</a><a href="#h30-0-38" id="h30-0-38" class="d">-import me.rhunk.snapenhance.ui.util.BitmojiImage
</a><a href="#h30-0-39" id="h30-0-39" class="d">-import me.rhunk.snapenhance.ui.util.pagerTabIndicatorOffset
</a><a href="#h30-0-40" id="h30-0-40" class="d">-
</a><a href="#h30-0-41" id="h30-0-41" class="d">-class SocialSection : Section() {
</a><a href="#h30-0-42" id="h30-0-42" class="d">-    private lateinit var friendList: List&lt;MessagingFriendInfo&gt;
</a><a href="#h30-0-43" id="h30-0-43" class="d">-    private lateinit var groupList: List&lt;MessagingGroupInfo&gt;
</a><a href="#h30-0-44" id="h30-0-44" class="d">-
</a><a href="#h30-0-45" id="h30-0-45" class="d">-    companion object {
</a><a href="#h30-0-46" id="h30-0-46" class="d">-        const val MAIN_ROUTE = &quot;social_route&quot;
</a><a href="#h30-0-47" id="h30-0-47" class="d">-        const val MESSAGING_PREVIEW_ROUTE = &quot;messaging_preview/?id={id}&amp;scope={scope}&quot;
</a><a href="#h30-0-48" id="h30-0-48" class="d">-        const val LOGGED_STORIES_ROUTE = &quot;logged_stories/?userId={userId}&quot;
</a><a href="#h30-0-49" id="h30-0-49" class="d">-    }
</a><a href="#h30-0-50" id="h30-0-50" class="d">-
</a><a href="#h30-0-51" id="h30-0-51" class="d">-    private var currentScopeContent: ScopeContent? = null
</a><a href="#h30-0-52" id="h30-0-52" class="d">-    private var currentMessagingPreview by mutableStateOf(null as MessagingPreview?)
</a><a href="#h30-0-53" id="h30-0-53" class="d">-
</a><a href="#h30-0-54" id="h30-0-54" class="d">-    private val addFriendDialog by lazy {
</a><a href="#h30-0-55" id="h30-0-55" class="d">-        AddFriendDialog(context, this)
</a><a href="#h30-0-56" id="h30-0-56" class="d">-    }
</a><a href="#h30-0-57" id="h30-0-57" class="d">-
</a><a href="#h30-0-58" id="h30-0-58" class="d">-    //FIXME: don&#39;t reload the entire list when a friend is added/deleted
</a><a href="#h30-0-59" id="h30-0-59" class="d">-    override fun onResumed() {
</a><a href="#h30-0-60" id="h30-0-60" class="d">-        friendList = context.modDatabase.getFriends(descOrder = true)
</a><a href="#h30-0-61" id="h30-0-61" class="d">-        groupList = context.modDatabase.getGroups()
</a><a href="#h30-0-62" id="h30-0-62" class="d">-    }
</a><a href="#h30-0-63" id="h30-0-63" class="d">-
</a><a href="#h30-0-64" id="h30-0-64" class="d">-    override fun canGoBack() = currentRoute != MAIN_ROUTE
</a><a href="#h30-0-65" id="h30-0-65" class="d">-
</a><a href="#h30-0-66" id="h30-0-66" class="d">-    override fun build(navGraphBuilder: NavGraphBuilder) {
</a><a href="#h30-0-67" id="h30-0-67" class="d">-        navGraphBuilder.navigation(route = enumSection.route, startDestination = MAIN_ROUTE) {
</a><a href="#h30-0-68" id="h30-0-68" class="d">-            composable(MAIN_ROUTE) {
</a><a href="#h30-0-69" id="h30-0-69" class="d">-                Content()
</a><a href="#h30-0-70" id="h30-0-70" class="d">-            }
</a><a href="#h30-0-71" id="h30-0-71" class="d">-
</a><a href="#h30-0-72" id="h30-0-72" class="d">-            SocialScope.entries.forEach { scope -&gt;
</a><a href="#h30-0-73" id="h30-0-73" class="d">-                composable(scope.tabRoute) {
</a><a href="#h30-0-74" id="h30-0-74" class="d">-                    val id = it.arguments?.getString(&quot;id&quot;) ?: return@composable
</a><a href="#h30-0-75" id="h30-0-75" class="d">-                    remember {
</a><a href="#h30-0-76" id="h30-0-76" class="d">-                        ScopeContent(
</a><a href="#h30-0-77" id="h30-0-77" class="d">-                            context,
</a><a href="#h30-0-78" id="h30-0-78" class="d">-                            this@SocialSection,
</a><a href="#h30-0-79" id="h30-0-79" class="d">-                            navController,
</a><a href="#h30-0-80" id="h30-0-80" class="d">-                            scope,
</a><a href="#h30-0-81" id="h30-0-81" class="d">-                            id
</a><a href="#h30-0-82" id="h30-0-82" class="d">-                        ).also { tab -&gt;
</a><a href="#h30-0-83" id="h30-0-83" class="d">-                            currentScopeContent = tab
</a><a href="#h30-0-84" id="h30-0-84" class="d">-                        }
</a><a href="#h30-0-85" id="h30-0-85" class="d">-                    }.Content()
</a><a href="#h30-0-86" id="h30-0-86" class="d">-                }
</a><a href="#h30-0-87" id="h30-0-87" class="d">-            }
</a><a href="#h30-0-88" id="h30-0-88" class="d">-
</a><a href="#h30-0-89" id="h30-0-89" class="d">-            composable(LOGGED_STORIES_ROUTE) {
</a><a href="#h30-0-90" id="h30-0-90" class="d">-                val userId = it.arguments?.getString(&quot;userId&quot;) ?: return@composable
</a><a href="#h30-0-91" id="h30-0-91" class="d">-                LoggedStories(context, userId)
</a><a href="#h30-0-92" id="h30-0-92" class="d">-            }
</a><a href="#h30-0-93" id="h30-0-93" class="d">-
</a><a href="#h30-0-94" id="h30-0-94" class="d">-            composable(MESSAGING_PREVIEW_ROUTE) { navBackStackEntry -&gt;
</a><a href="#h30-0-95" id="h30-0-95" class="d">-                val id = navBackStackEntry.arguments?.getString(&quot;id&quot;) ?: return@composable
</a><a href="#h30-0-96" id="h30-0-96" class="d">-                val scope = navBackStackEntry.arguments?.getString(&quot;scope&quot;) ?: return@composable
</a><a href="#h30-0-97" id="h30-0-97" class="d">-                val messagePreview = remember {
</a><a href="#h30-0-98" id="h30-0-98" class="d">-                    MessagingPreview(context, SocialScope.getByName(scope), id)
</a><a href="#h30-0-99" id="h30-0-99" class="d">-                }
</a><a href="#h30-0-100" id="h30-0-100" class="d">-                LaunchedEffect(key1 = id) {
</a><a href="#h30-0-101" id="h30-0-101" class="d">-                    currentMessagingPreview = messagePreview
</a><a href="#h30-0-102" id="h30-0-102" class="d">-                }
</a><a href="#h30-0-103" id="h30-0-103" class="d">-                messagePreview.Content()
</a><a href="#h30-0-104" id="h30-0-104" class="d">-                DisposableEffect(Unit) {
</a><a href="#h30-0-105" id="h30-0-105" class="d">-                    onDispose {
</a><a href="#h30-0-106" id="h30-0-106" class="d">-                        currentMessagingPreview = null
</a><a href="#h30-0-107" id="h30-0-107" class="d">-                    }
</a><a href="#h30-0-108" id="h30-0-108" class="d">-                }
</a><a href="#h30-0-109" id="h30-0-109" class="d">-            }
</a><a href="#h30-0-110" id="h30-0-110" class="d">-        }
</a><a href="#h30-0-111" id="h30-0-111" class="d">-    }
</a><a href="#h30-0-112" id="h30-0-112" class="d">-
</a><a href="#h30-0-113" id="h30-0-113" class="d">-    @Composable
</a><a href="#h30-0-114" id="h30-0-114" class="d">-    override fun TopBarActions(rowScope: RowScope) {
</a><a href="#h30-0-115" id="h30-0-115" class="d">-        var deleteConfirmDialog by remember { mutableStateOf(false) }
</a><a href="#h30-0-116" id="h30-0-116" class="d">-        val coroutineScope = rememberCoroutineScope()
</a><a href="#h30-0-117" id="h30-0-117" class="d">-
</a><a href="#h30-0-118" id="h30-0-118" class="d">-        if (deleteConfirmDialog) {
</a><a href="#h30-0-119" id="h30-0-119" class="d">-            currentScopeContent?.let { scopeContent -&gt;
</a><a href="#h30-0-120" id="h30-0-120" class="d">-                Dialog(onDismissRequest = { deleteConfirmDialog = false }) {
</a><a href="#h30-0-121" id="h30-0-121" class="d">-                    remember { AlertDialogs(context.translation) }.ConfirmDialog(
</a><a href="#h30-0-122" id="h30-0-122" class="d">-                        title = &quot;Are you sure you want to delete this ${scopeContent.scope.key.lowercase()}?&quot;,
</a><a href="#h30-0-123" id="h30-0-123" class="d">-                        onDismiss = { deleteConfirmDialog = false },
</a><a href="#h30-0-124" id="h30-0-124" class="d">-                        onConfirm = {
</a><a href="#h30-0-125" id="h30-0-125" class="d">-                            scopeContent.deleteScope(coroutineScope); deleteConfirmDialog = false
</a><a href="#h30-0-126" id="h30-0-126" class="d">-                        }
</a><a href="#h30-0-127" id="h30-0-127" class="d">-                    )
</a><a href="#h30-0-128" id="h30-0-128" class="d">-                }
</a><a href="#h30-0-129" id="h30-0-129" class="d">-            }
</a><a href="#h30-0-130" id="h30-0-130" class="d">-        }
</a><a href="#h30-0-131" id="h30-0-131" class="d">-
</a><a href="#h30-0-132" id="h30-0-132" class="d">-        if (currentRoute == MESSAGING_PREVIEW_ROUTE) {
</a><a href="#h30-0-133" id="h30-0-133" class="d">-            currentMessagingPreview?.TopBarAction()
</a><a href="#h30-0-134" id="h30-0-134" class="d">-        }
</a><a href="#h30-0-135" id="h30-0-135" class="d">-
</a><a href="#h30-0-136" id="h30-0-136" class="d">-        if (currentRoute == SocialScope.FRIEND.tabRoute || currentRoute == SocialScope.GROUP.tabRoute) {
</a><a href="#h30-0-137" id="h30-0-137" class="d">-            IconButton(
</a><a href="#h30-0-138" id="h30-0-138" class="d">-                onClick = { deleteConfirmDialog = true },
</a><a href="#h30-0-139" id="h30-0-139" class="d">-            ) {
</a><a href="#h30-0-140" id="h30-0-140" class="d">-                Icon(
</a><a href="#h30-0-141" id="h30-0-141" class="d">-                    imageVector = Icons.Rounded.DeleteForever,
</a><a href="#h30-0-142" id="h30-0-142" class="d">-                    contentDescription = null
</a><a href="#h30-0-143" id="h30-0-143" class="d">-                )
</a><a href="#h30-0-144" id="h30-0-144" class="d">-            }
</a><a href="#h30-0-145" id="h30-0-145" class="d">-        }
</a><a href="#h30-0-146" id="h30-0-146" class="d">-    }
</a><a href="#h30-0-147" id="h30-0-147" class="d">-
</a><a href="#h30-0-148" id="h30-0-148" class="d">-
</a><a href="#h30-0-149" id="h30-0-149" class="d">-    @Composable
</a><a href="#h30-0-150" id="h30-0-150" class="d">-    private fun ScopeList(scope: SocialScope) {
</a><a href="#h30-0-151" id="h30-0-151" class="d">-        val remainingHours = remember { context.config.root.streaksReminder.remainingHours.get() }
</a><a href="#h30-0-152" id="h30-0-152" class="d">-
</a><a href="#h30-0-153" id="h30-0-153" class="d">-        LazyColumn(
</a><a href="#h30-0-154" id="h30-0-154" class="d">-            modifier = Modifier
</a><a href="#h30-0-155" id="h30-0-155" class="d">-                .padding(2.dp)
</a><a href="#h30-0-156" id="h30-0-156" class="d">-                .fillMaxWidth()
</a><a href="#h30-0-157" id="h30-0-157" class="d">-                .fillMaxHeight(),
</a><a href="#h30-0-158" id="h30-0-158" class="d">-            contentPadding = PaddingValues(bottom = 110.dp),
</a><a href="#h30-0-159" id="h30-0-159" class="d">-        ) {
</a><a href="#h30-0-160" id="h30-0-160" class="d">-            //check if scope list is empty
</a><a href="#h30-0-161" id="h30-0-161" class="d">-            val listSize = when (scope) {
</a><a href="#h30-0-162" id="h30-0-162" class="d">-                SocialScope.GROUP -&gt; groupList.size
</a><a href="#h30-0-163" id="h30-0-163" class="d">-                SocialScope.FRIEND -&gt; friendList.size
</a><a href="#h30-0-164" id="h30-0-164" class="d">-            }
</a><a href="#h30-0-165" id="h30-0-165" class="d">-
</a><a href="#h30-0-166" id="h30-0-166" class="d">-            if (listSize == 0) {
</a><a href="#h30-0-167" id="h30-0-167" class="d">-                item {
</a><a href="#h30-0-168" id="h30-0-168" class="d">-                    Text(
</a><a href="#h30-0-169" id="h30-0-169" class="d">-                        text = &quot;(empty)&quot;, modifier = Modifier
</a><a href="#h30-0-170" id="h30-0-170" class="d">-                            .fillMaxWidth()
</a><a href="#h30-0-171" id="h30-0-171" class="d">-                            .padding(10.dp), textAlign = TextAlign.Center
</a><a href="#h30-0-172" id="h30-0-172" class="d">-                    )
</a><a href="#h30-0-173" id="h30-0-173" class="d">-                }
</a><a href="#h30-0-174" id="h30-0-174" class="d">-            }
</a><a href="#h30-0-175" id="h30-0-175" class="d">-
</a><a href="#h30-0-176" id="h30-0-176" class="d">-            items(listSize) { index -&gt;
</a><a href="#h30-0-177" id="h30-0-177" class="d">-                val id = when (scope) {
</a><a href="#h30-0-178" id="h30-0-178" class="d">-                    SocialScope.GROUP -&gt; groupList[index].conversationId
</a><a href="#h30-0-179" id="h30-0-179" class="d">-                    SocialScope.FRIEND -&gt; friendList[index].userId
</a><a href="#h30-0-180" id="h30-0-180" class="d">-                }
</a><a href="#h30-0-181" id="h30-0-181" class="d">-
</a><a href="#h30-0-182" id="h30-0-182" class="d">-                Card(
</a><a href="#h30-0-183" id="h30-0-183" class="d">-                    modifier = Modifier
</a><a href="#h30-0-184" id="h30-0-184" class="d">-                        .padding(10.dp)
</a><a href="#h30-0-185" id="h30-0-185" class="d">-                        .fillMaxWidth()
</a><a href="#h30-0-186" id="h30-0-186" class="d">-                        .height(80.dp)
</a><a href="#h30-0-187" id="h30-0-187" class="d">-                        .clickable {
</a><a href="#h30-0-188" id="h30-0-188" class="d">-                            navController.navigate(
</a><a href="#h30-0-189" id="h30-0-189" class="d">-                                scope.tabRoute.replace(&quot;{id}&quot;, id)
</a><a href="#h30-0-190" id="h30-0-190" class="d">-                            )
</a><a href="#h30-0-191" id="h30-0-191" class="d">-                        },
</a><a href="#h30-0-192" id="h30-0-192" class="d">-                ) {
</a><a href="#h30-0-193" id="h30-0-193" class="d">-                    Row(
</a><a href="#h30-0-194" id="h30-0-194" class="d">-                        modifier = Modifier
</a><a href="#h30-0-195" id="h30-0-195" class="d">-                            .padding(10.dp)
</a><a href="#h30-0-196" id="h30-0-196" class="d">-                            .fillMaxSize(),
</a><a href="#h30-0-197" id="h30-0-197" class="d">-                        verticalAlignment = Alignment.CenterVertically
</a><a href="#h30-0-198" id="h30-0-198" class="d">-                    ) {
</a><a href="#h30-0-199" id="h30-0-199" class="d">-                        when (scope) {
</a><a href="#h30-0-200" id="h30-0-200" class="d">-                            SocialScope.GROUP -&gt; {
</a><a href="#h30-0-201" id="h30-0-201" class="d">-                                val group = groupList[index]
</a><a href="#h30-0-202" id="h30-0-202" class="d">-                                Column(
</a><a href="#h30-0-203" id="h30-0-203" class="d">-                                    modifier = Modifier
</a><a href="#h30-0-204" id="h30-0-204" class="d">-                                        .padding(10.dp)
</a><a href="#h30-0-205" id="h30-0-205" class="d">-                                        .fillMaxWidth()
</a><a href="#h30-0-206" id="h30-0-206" class="d">-                                        .weight(1f)
</a><a href="#h30-0-207" id="h30-0-207" class="d">-                                ) {
</a><a href="#h30-0-208" id="h30-0-208" class="d">-                                    Text(
</a><a href="#h30-0-209" id="h30-0-209" class="d">-                                        text = group.name,
</a><a href="#h30-0-210" id="h30-0-210" class="d">-                                        maxLines = 1,
</a><a href="#h30-0-211" id="h30-0-211" class="d">-                                        fontWeight = FontWeight.Bold
</a><a href="#h30-0-212" id="h30-0-212" class="d">-                                    )
</a><a href="#h30-0-213" id="h30-0-213" class="d">-                                }
</a><a href="#h30-0-214" id="h30-0-214" class="d">-                            }
</a><a href="#h30-0-215" id="h30-0-215" class="d">-
</a><a href="#h30-0-216" id="h30-0-216" class="d">-                            SocialScope.FRIEND -&gt; {
</a><a href="#h30-0-217" id="h30-0-217" class="d">-                                val friend = friendList[index]
</a><a href="#h30-0-218" id="h30-0-218" class="d">-                                var streaks by remember { mutableStateOf(friend.streaks) }
</a><a href="#h30-0-219" id="h30-0-219" class="d">-
</a><a href="#h30-0-220" id="h30-0-220" class="d">-                                LaunchedEffect(friend.userId) {
</a><a href="#h30-0-221" id="h30-0-221" class="d">-                                    withContext(Dispatchers.IO) {
</a><a href="#h30-0-222" id="h30-0-222" class="d">-                                        streaks = context.modDatabase.getFriendStreaks(friend.userId)
</a><a href="#h30-0-223" id="h30-0-223" class="d">-                                    }
</a><a href="#h30-0-224" id="h30-0-224" class="d">-                                }
</a><a href="#h30-0-225" id="h30-0-225" class="d">-
</a><a href="#h30-0-226" id="h30-0-226" class="d">-                                BitmojiImage(
</a><a href="#h30-0-227" id="h30-0-227" class="d">-                                    context = context,
</a><a href="#h30-0-228" id="h30-0-228" class="d">-                                    url = BitmojiSelfie.getBitmojiSelfie(
</a><a href="#h30-0-229" id="h30-0-229" class="d">-                                        friend.selfieId,
</a><a href="#h30-0-230" id="h30-0-230" class="d">-                                        friend.bitmojiId,
</a><a href="#h30-0-231" id="h30-0-231" class="d">-                                        BitmojiSelfie.BitmojiSelfieType.THREE_D
</a><a href="#h30-0-232" id="h30-0-232" class="d">-                                    )
</a><a href="#h30-0-233" id="h30-0-233" class="d">-                                )
</a><a href="#h30-0-234" id="h30-0-234" class="d">-                                Column(
</a><a href="#h30-0-235" id="h30-0-235" class="d">-                                    modifier = Modifier
</a><a href="#h30-0-236" id="h30-0-236" class="d">-                                        .padding(10.dp)
</a><a href="#h30-0-237" id="h30-0-237" class="d">-                                        .fillMaxWidth()
</a><a href="#h30-0-238" id="h30-0-238" class="d">-                                        .weight(1f)
</a><a href="#h30-0-239" id="h30-0-239" class="d">-                                ) {
</a><a href="#h30-0-240" id="h30-0-240" class="d">-                                    Text(
</a><a href="#h30-0-241" id="h30-0-241" class="d">-                                        text = friend.displayName ?: friend.mutableUsername,
</a><a href="#h30-0-242" id="h30-0-242" class="d">-                                        maxLines = 1,
</a><a href="#h30-0-243" id="h30-0-243" class="d">-                                        fontWeight = FontWeight.Bold
</a><a href="#h30-0-244" id="h30-0-244" class="d">-                                    )
</a><a href="#h30-0-245" id="h30-0-245" class="d">-                                    Text(
</a><a href="#h30-0-246" id="h30-0-246" class="d">-                                        text = friend.mutableUsername,
</a><a href="#h30-0-247" id="h30-0-247" class="d">-                                        maxLines = 1,
</a><a href="#h30-0-248" id="h30-0-248" class="d">-                                        fontSize = 12.sp,
</a><a href="#h30-0-249" id="h30-0-249" class="d">-                                        fontWeight = FontWeight.Light
</a><a href="#h30-0-250" id="h30-0-250" class="d">-                                    )
</a><a href="#h30-0-251" id="h30-0-251" class="d">-                                }
</a><a href="#h30-0-252" id="h30-0-252" class="d">-                                Row(verticalAlignment = Alignment.CenterVertically) {
</a><a href="#h30-0-253" id="h30-0-253" class="d">-                                    streaks?.takeIf { it.notify }?.let { streaks -&gt;
</a><a href="#h30-0-254" id="h30-0-254" class="d">-                                        Icon(
</a><a href="#h30-0-255" id="h30-0-255" class="d">-                                            imageVector = ImageVector.vectorResource(id = R.drawable.streak_icon),
</a><a href="#h30-0-256" id="h30-0-256" class="d">-                                            contentDescription = null,
</a><a href="#h30-0-257" id="h30-0-257" class="d">-                                            modifier = Modifier.height(40.dp),
</a><a href="#h30-0-258" id="h30-0-258" class="d">-                                            tint = if (streaks.isAboutToExpire(remainingHours))
</a><a href="#h30-0-259" id="h30-0-259" class="d">-                                                MaterialTheme.colorScheme.error
</a><a href="#h30-0-260" id="h30-0-260" class="d">-                                            else MaterialTheme.colorScheme.primary
</a><a href="#h30-0-261" id="h30-0-261" class="d">-                                        )
</a><a href="#h30-0-262" id="h30-0-262" class="d">-                                        Text(
</a><a href="#h30-0-263" id="h30-0-263" class="d">-                                            text = context.translation.format(
</a><a href="#h30-0-264" id="h30-0-264" class="d">-                                                &quot;manager.sections.social.streaks_expiration_short&quot;,
</a><a href="#h30-0-265" id="h30-0-265" class="d">-                                                &quot;hours&quot; to (((streaks.expirationTimestamp - System.currentTimeMillis()) / 3600000).toInt().takeIf { it &gt; 0 } ?: 0)
</a><a href="#h30-0-266" id="h30-0-266" class="d">-                                                    .toString()
</a><a href="#h30-0-267" id="h30-0-267" class="d">-                                            ),
</a><a href="#h30-0-268" id="h30-0-268" class="d">-                                            maxLines = 1,
</a><a href="#h30-0-269" id="h30-0-269" class="d">-                                            fontWeight = FontWeight.Bold
</a><a href="#h30-0-270" id="h30-0-270" class="d">-                                        )
</a><a href="#h30-0-271" id="h30-0-271" class="d">-                                    }
</a><a href="#h30-0-272" id="h30-0-272" class="d">-                                }
</a><a href="#h30-0-273" id="h30-0-273" class="d">-                            }
</a><a href="#h30-0-274" id="h30-0-274" class="d">-                        }
</a><a href="#h30-0-275" id="h30-0-275" class="d">-
</a><a href="#h30-0-276" id="h30-0-276" class="d">-                        FilledIconButton(onClick = {
</a><a href="#h30-0-277" id="h30-0-277" class="d">-                            navController.navigate(
</a><a href="#h30-0-278" id="h30-0-278" class="d">-                                MESSAGING_PREVIEW_ROUTE.replace(&quot;{id}&quot;, id).replace(&quot;{scope}&quot;, scope.key)
</a><a href="#h30-0-279" id="h30-0-279" class="d">-                            )
</a><a href="#h30-0-280" id="h30-0-280" class="d">-                        }) {
</a><a href="#h30-0-281" id="h30-0-281" class="d">-                            Icon(imageVector = Icons.Filled.RemoveRedEye, contentDescription = null)
</a><a href="#h30-0-282" id="h30-0-282" class="d">-                        }
</a><a href="#h30-0-283" id="h30-0-283" class="d">-                    }
</a><a href="#h30-0-284" id="h30-0-284" class="d">-                }
</a><a href="#h30-0-285" id="h30-0-285" class="d">-            }
</a><a href="#h30-0-286" id="h30-0-286" class="d">-        }
</a><a href="#h30-0-287" id="h30-0-287" class="d">-    }
</a><a href="#h30-0-288" id="h30-0-288" class="d">-
</a><a href="#h30-0-289" id="h30-0-289" class="d">-
</a><a href="#h30-0-290" id="h30-0-290" class="d">-    @OptIn(ExperimentalFoundationApi::class)
</a><a href="#h30-0-291" id="h30-0-291" class="d">-    @Composable
</a><a href="#h30-0-292" id="h30-0-292" class="d">-    override fun Content() {
</a><a href="#h30-0-293" id="h30-0-293" class="d">-        val titles = listOf(&quot;Friends&quot;, &quot;Groups&quot;)
</a><a href="#h30-0-294" id="h30-0-294" class="d">-        val coroutineScope = rememberCoroutineScope()
</a><a href="#h30-0-295" id="h30-0-295" class="d">-        val pagerState = rememberPagerState { titles.size }
</a><a href="#h30-0-296" id="h30-0-296" class="d">-        var showAddFriendDialog by remember { mutableStateOf(false) }
</a><a href="#h30-0-297" id="h30-0-297" class="d">-
</a><a href="#h30-0-298" id="h30-0-298" class="d">-        if (showAddFriendDialog) {
</a><a href="#h30-0-299" id="h30-0-299" class="d">-            addFriendDialog.Content {
</a><a href="#h30-0-300" id="h30-0-300" class="d">-                showAddFriendDialog = false
</a><a href="#h30-0-301" id="h30-0-301" class="d">-            }
</a><a href="#h30-0-302" id="h30-0-302" class="d">-        }
</a><a href="#h30-0-303" id="h30-0-303" class="d">-
</a><a href="#h30-0-304" id="h30-0-304" class="d">-        Scaffold(
</a><a href="#h30-0-305" id="h30-0-305" class="d">-            floatingActionButton = {
</a><a href="#h30-0-306" id="h30-0-306" class="d">-                FloatingActionButton(
</a><a href="#h30-0-307" id="h30-0-307" class="d">-                    onClick = {
</a><a href="#h30-0-308" id="h30-0-308" class="d">-                        showAddFriendDialog = true
</a><a href="#h30-0-309" id="h30-0-309" class="d">-                    },
</a><a href="#h30-0-310" id="h30-0-310" class="d">-                    modifier = Modifier.padding(10.dp),
</a><a href="#h30-0-311" id="h30-0-311" class="d">-                    containerColor = MaterialTheme.colorScheme.primary,
</a><a href="#h30-0-312" id="h30-0-312" class="d">-                    contentColor = MaterialTheme.colorScheme.onPrimary,
</a><a href="#h30-0-313" id="h30-0-313" class="d">-                    shape = RoundedCornerShape(16.dp),
</a><a href="#h30-0-314" id="h30-0-314" class="d">-                ) {
</a><a href="#h30-0-315" id="h30-0-315" class="d">-                    Icon(
</a><a href="#h30-0-316" id="h30-0-316" class="d">-                        imageVector = Icons.Rounded.Add,
</a><a href="#h30-0-317" id="h30-0-317" class="d">-                        contentDescription = null
</a><a href="#h30-0-318" id="h30-0-318" class="d">-                    )
</a><a href="#h30-0-319" id="h30-0-319" class="d">-                }
</a><a href="#h30-0-320" id="h30-0-320" class="d">-            }
</a><a href="#h30-0-321" id="h30-0-321" class="d">-        ) { paddingValues -&gt;
</a><a href="#h30-0-322" id="h30-0-322" class="d">-            Column(modifier = Modifier.padding(paddingValues)) {
</a><a href="#h30-0-323" id="h30-0-323" class="d">-                TabRow(selectedTabIndex = pagerState.currentPage, indicator = { tabPositions -&gt;
</a><a href="#h30-0-324" id="h30-0-324" class="d">-                    TabRowDefaults.Indicator(
</a><a href="#h30-0-325" id="h30-0-325" class="d">-                        Modifier.pagerTabIndicatorOffset(
</a><a href="#h30-0-326" id="h30-0-326" class="d">-                            pagerState = pagerState,
</a><a href="#h30-0-327" id="h30-0-327" class="d">-                            tabPositions = tabPositions
</a><a href="#h30-0-328" id="h30-0-328" class="d">-                        )
</a><a href="#h30-0-329" id="h30-0-329" class="d">-                    )
</a><a href="#h30-0-330" id="h30-0-330" class="d">-                }) {
</a><a href="#h30-0-331" id="h30-0-331" class="d">-                    titles.forEachIndexed { index, title -&gt;
</a><a href="#h30-0-332" id="h30-0-332" class="d">-                        Tab(
</a><a href="#h30-0-333" id="h30-0-333" class="d">-                            selected = pagerState.currentPage == index,
</a><a href="#h30-0-334" id="h30-0-334" class="d">-                            onClick = {
</a><a href="#h30-0-335" id="h30-0-335" class="d">-                                coroutineScope.launch {
</a><a href="#h30-0-336" id="h30-0-336" class="d">-                                    pagerState.animateScrollToPage(index)
</a><a href="#h30-0-337" id="h30-0-337" class="d">-                                }
</a><a href="#h30-0-338" id="h30-0-338" class="d">-                            },
</a><a href="#h30-0-339" id="h30-0-339" class="d">-                            text = {
</a><a href="#h30-0-340" id="h30-0-340" class="d">-                                Text(
</a><a href="#h30-0-341" id="h30-0-341" class="d">-                                    text = title,
</a><a href="#h30-0-342" id="h30-0-342" class="d">-                                    maxLines = 2,
</a><a href="#h30-0-343" id="h30-0-343" class="d">-                                    overflow = TextOverflow.Ellipsis
</a><a href="#h30-0-344" id="h30-0-344" class="d">-                                )
</a><a href="#h30-0-345" id="h30-0-345" class="d">-                            }
</a><a href="#h30-0-346" id="h30-0-346" class="d">-                        )
</a><a href="#h30-0-347" id="h30-0-347" class="d">-                    }
</a><a href="#h30-0-348" id="h30-0-348" class="d">-                }
</a><a href="#h30-0-349" id="h30-0-349" class="d">-
</a><a href="#h30-0-350" id="h30-0-350" class="d">-                HorizontalPager(
</a><a href="#h30-0-351" id="h30-0-351" class="d">-                    modifier = Modifier.padding(paddingValues),
</a><a href="#h30-0-352" id="h30-0-352" class="d">-                    state = pagerState
</a><a href="#h30-0-353" id="h30-0-353" class="d">-                ) { page -&gt;
</a><a href="#h30-0-354" id="h30-0-354" class="d">-                    when (page) {
</a><a href="#h30-0-355" id="h30-0-355" class="d">-                        0 -&gt; ScopeList(SocialScope.FRIEND)
</a><a href="#h30-0-356" id="h30-0-356" class="d">-                        1 -&gt; ScopeList(SocialScope.GROUP)
</a><a href="#h30-0-357" id="h30-0-357" class="d">-                    }
</a><a href="#h30-0-358" id="h30-0-358" class="d">-                }
</a><a href="#h30-0-359" id="h30-0-359" class="d">-            }
</a><a href="#h30-0-360" id="h30-0-360" class="d">-        }
</a><a href="#h30-0-361" id="h30-0-361" class="d">-    }
</a><a href="#h30-0-362" id="h30-0-362" class="d">-}</a><a href="#h30-0-363" id="h30-0-363" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h31" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/overlay/SettingsOverlay.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/overlay/SettingsOverlay.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/overlay/SettingsOverlay.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/overlay/SettingsOverlay.kt</a></b>
<a href="#h31-0" id="h31-0" class="h">@@ -25,9 +25,7 @@ import com.arthenica.ffmpegkit.Packages.getPackageName
</a> import me.rhunk.snapenhance.R
 import me.rhunk.snapenhance.RemoteSideContext
 import me.rhunk.snapenhance.common.ui.createComposeView
<a href="#h31-0-3" id="h31-0-3" class="d">-import me.rhunk.snapenhance.ui.manager.EnumSection
</a> import me.rhunk.snapenhance.ui.manager.Navigation
<a href="#h31-0-5" id="h31-0-5" class="d">-import me.rhunk.snapenhance.ui.manager.sections.features.FeaturesSection
</a> 
 
 class SettingsOverlay(
<a href="#h31-1" id="h31-1" class="h">@@ -55,26 +53,15 @@ class SettingsOverlay(
</a>             dismissCallback = { navHostController.popBackStack() }
         }
 
<a href="#h31-1-3" id="h31-1-3" class="d">-        val navigation = remember {
</a><a href="#h31-1-4" id="h31-1-4" class="d">-            Navigation(
</a><a href="#h31-1-5" id="h31-1-5" class="d">-                context,
</a><a href="#h31-1-6" id="h31-1-6" class="d">-                mapOf(
</a><a href="#h31-1-7" id="h31-1-7" class="d">-                    EnumSection.FEATURES to FeaturesSection().apply {
</a><a href="#h31-1-8" id="h31-1-8" class="d">-                        enumSection = EnumSection.FEATURES
</a><a href="#h31-1-9" id="h31-1-9" class="d">-                        context = this@SettingsOverlay.context
</a><a href="#h31-1-10" id="h31-1-10" class="d">-                    }
</a><a href="#h31-1-11" id="h31-1-11" class="d">-                ),
</a><a href="#h31-1-12" id="h31-1-12" class="d">-                navHostController
</a><a href="#h31-1-13" id="h31-1-13" class="d">-            )
</a><a href="#h31-1-14" id="h31-1-14" class="d">-        }
</a><a href="#h31-1-15" id="h31-1-15" class="i">+        val navigation = remember { Navigation(context, navHostController) }
</a> 
         Scaffold(
             containerColor = MaterialTheme.colorScheme.background,
             topBar = { navigation.TopBar() }
         ) { innerPadding -&gt;
<a href="#h31-1-21" id="h31-1-21" class="d">-            navigation.NavigationHost(
</a><a href="#h31-1-22" id="h31-1-22" class="d">-                startDestination = EnumSection.FEATURES,
</a><a href="#h31-1-23" id="h31-1-23" class="d">-                innerPadding = innerPadding
</a><a href="#h31-1-24" id="h31-1-24" class="i">+            navigation.Content(
</a><a href="#h31-1-25" id="h31-1-25" class="i">+                innerPadding,
</a><a href="#h31-1-26" id="h31-1-26" class="i">+                startDestination = navigation.routes.features.routeInfo.id
</a>             )
         }
     }
<b>diff --git a/<a id="h32" href="../file/common/src/main/assets/lang/en_US.json.html">common/src/main/assets/lang/en_US.json</a> b/<a href="../file/common/src/main/assets/lang/en_US.json.html">common/src/main/assets/lang/en_US.json</a></b>
<a href="#h32-0" id="h32-0" class="h">@@ -29,6 +29,8 @@
</a>             &quot;home_settings&quot;: &quot;Settings&quot;,
             &quot;home_logs&quot;: &quot;Logs&quot;,
             &quot;social&quot;: &quot;Social&quot;,
<a href="#h32-0-3" id="h32-0-3" class="i">+            &quot;manage_scope&quot;: &quot;Manage Scope&quot;,
</a><a href="#h32-0-4" id="h32-0-4" class="i">+            &quot;messaging_preview&quot;: &quot;Preview&quot;,
</a>             &quot;scripts&quot;: &quot;Scripts&quot;
         },
         &quot;sections&quot;: {
<b>diff --git a/<a id="h33" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/BridgeClient.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/BridgeClient.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/BridgeClient.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/BridgeClient.kt</a></b>
<a href="#h33-0" id="h33-0" class="h">@@ -110,7 +110,6 @@ class BridgeClient(
</a>         return runCatching {
             block()
         }.getOrElse {
<a href="#h33-0-3" id="h33-0-3" class="d">-            context.log.error(&quot;failed to call service&quot;, it)
</a>             if (it is DeadObjectException) {
                 context.softRestartApp()
             }
</pre>
</div>
</body>
</html>
