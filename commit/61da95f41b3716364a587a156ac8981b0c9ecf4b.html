<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>feat: log system - debug actions - move packages to core - SnapEnhance - An Xposed module offering an enhanced Snapchat experience
</title>
<link rel="icon" type="image/svg+xml" href="../../logo.png"/>
<link rel="alternate icon" href="../../favicon.png"/>
<link rel="alternate" type="application/atom+xml" title="SnapEnhance Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="SnapEnhance Atom Feed (tags)" href="../tags.xml" />
<link rel="stylesheet" type="text/css" href="../../style.css" />
<link rel="stylesheet" type="text/css" href="../../fonts.css" />
</head>
<body>
<div id="head"><table><tr><td><a class="logo" href="../../"><img src="../../logo.png" alt="" width="32" height="32" /></a></td><td><strong>SnapEnhance</strong><span class="desc"> - An Xposed module offering an enhanced Snapchat experience
</span>
</td></tr></table>
<p><a href="../about.html">About</a> | <a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/LICENSE.html">License</a></p>
</div>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/61da95f41b3716364a587a156ac8981b0c9ecf4b.html">61da95f41b3716364a587a156ac8981b0c9ecf4b</a>
<b>parent</b> <a href="../commit/6b9e44700d15399dbfe24c76e3747518f752bca8.html">6b9e44700d15399dbfe24c76e3747518f752bca8</a>
<b>Author:</b> rhunk &lt;<a href="mailto:101876869+rhunk@users.noreply.github.com">101876869+rhunk@users.noreply.github.com</a>&gt;
<b>Date:</b>   Thu, 31 Aug 2023 00:59:30 +0200

feat: log system
- debug actions
- move packages to core

<b>Diffstat:</b>
<table><tr><td class="A">A</td><td><a href="#h0">app/src/main/kotlin/me/rhunk/snapenhance/LogManager.kt</a></td><td> | </td><td class="num">190</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">app/src/main/kotlin/me/rhunk/snapenhance/RemoteSideContext.kt</a></td><td> | </td><td class="num">71</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">--------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h2">app/src/main/kotlin/me/rhunk/snapenhance/bridge/BridgeService.kt</a></td><td> | </td><td class="num">35</td><td><span class="i">+++++++++++++++++</span><span class="d">------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h3">app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadProcessor.kt</a></td><td> | </td><td class="num">29</td><td><span class="i">+++++++++++++++</span><span class="d">--------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h4">app/src/main/kotlin/me/rhunk/snapenhance/messaging/ModDatabase.kt</a></td><td> | </td><td class="num">7</td><td><span class="i">+++</span><span class="d">----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h5">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/Section.kt</a></td><td> | </td><td class="num">4</td><td><span class="i">+++</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h6">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/data/InstallationSummary.kt</a></td><td> | </td><td class="num">27</td><td><span class="i">++++++++++++++++++++++</span><span class="d">-----</span></td></tr>
<tr><td class="D">D</td><td><a href="#h7">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/HomeSection.kt</a></td><td> | </td><td class="num">148</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h8">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/downloads/DownloadsSection.kt</a></td><td> | </td><td class="num">4</td><td><span class="i">++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h9">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/features/FeaturesSection.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="A">A</td><td><a href="#h10">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/home/HomeSection.kt</a></td><td> | </td><td class="num">313</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h11">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/home/HomeSubSection.kt</a></td><td> | </td><td class="num">215</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h12">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/social/AddFriendDialog.kt</a></td><td> | </td><td class="num">15</td><td><span class="i">+++++++</span><span class="d">--------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h13">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/social/SocialSection.kt</a></td><td> | </td><td class="num">4</td><td><span class="i">++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h14">app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/screens/impl/MappingsScreen.kt</a></td><td> | </td><td class="num">4</td><td><span class="i">++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h15">app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/screens/impl/PickLanguageScreen.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h16">app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/screens/impl/SaveFolderScreen.kt</a></td><td> | </td><td class="num">2</td><td><span class="i"></span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h17">app/src/main/kotlin/me/rhunk/snapenhance/ui/util/ActivityLauncherHelper.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h18">app/src/main/kotlin/me/rhunk/snapenhance/ui/util/AlertDialogs.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h19">core/src/main/aidl/me/rhunk/snapenhance/bridge/BridgeInterface.aidl</a></td><td> | </td><td class="num">33</td><td><span class="i">+++++++++++++++</span><span class="d">------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h20">core/src/main/assets/lang/en_US.json</a></td><td> | </td><td class="num">6</td><td><span class="i">++++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h21">core/src/main/kotlin/me/rhunk/snapenhance/Constants.kt</a></td><td> | </td><td class="num">2</td><td><span class="i"></span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h22">core/src/main/kotlin/me/rhunk/snapenhance/Logger.kt</a></td><td> | </td><td class="num">92</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">-------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h23">core/src/main/kotlin/me/rhunk/snapenhance/ModContext.kt</a></td><td> | </td><td class="num">16</td><td><span class="i">+++++++++</span><span class="d">-------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h24">core/src/main/kotlin/me/rhunk/snapenhance/SnapEnhance.kt</a></td><td> | </td><td class="num">9</td><td><span class="i">++++</span><span class="d">-----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h25">core/src/main/kotlin/me/rhunk/snapenhance/action/AbstractAction.kt</a></td><td> | </td><td class="num">9</td><td><span class="i">+</span><span class="d">--------</span></td></tr>
<tr><td class="A">A</td><td><a href="#h26">core/src/main/kotlin/me/rhunk/snapenhance/action/EnumAction.kt</a></td><td> | </td><td class="num">18</td><td><span class="i">++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="D">D</td><td><a href="#h27">core/src/main/kotlin/me/rhunk/snapenhance/action/impl/CheckForUpdates.kt</a></td><td> | </td><td class="num">20</td><td><span class="i"></span><span class="d">--------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h28">core/src/main/kotlin/me/rhunk/snapenhance/action/impl/CleanCache.kt</a></td><td> | </td><td class="num">4</td><td><span class="i">++</span><span class="d">--</span></td></tr>
<tr><td class="D">D</td><td><a href="#h29">core/src/main/kotlin/me/rhunk/snapenhance/action/impl/ClearMessageLogger.kt</a></td><td> | </td><td class="num">11</td><td><span class="i"></span><span class="d">-----------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h30">core/src/main/kotlin/me/rhunk/snapenhance/action/impl/ExportChatMessages.kt</a></td><td> | </td><td class="num">9</td><td><span class="i">++++</span><span class="d">-----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h31">core/src/main/kotlin/me/rhunk/snapenhance/action/impl/OpenMap.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="D">D</td><td><a href="#h32">core/src/main/kotlin/me/rhunk/snapenhance/action/impl/RefreshMappings.kt</a></td><td> | </td><td class="num">12</td><td><span class="i"></span><span class="d">------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h33">core/src/main/kotlin/me/rhunk/snapenhance/bridge/BridgeClient.kt</a></td><td> | </td><td class="num">145</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h34">core/src/main/kotlin/me/rhunk/snapenhance/bridge/FileLoaderWrapper.kt</a></td><td> | </td><td class="num">36</td><td><span class="i"></span><span class="d">------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h35">core/src/main/kotlin/me/rhunk/snapenhance/bridge/types/BridgeFileType.kt</a></td><td> | </td><td class="num">26</td><td><span class="i"></span><span class="d">--------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h36">core/src/main/kotlin/me/rhunk/snapenhance/bridge/types/FileActionType.kt</a></td><td> | </td><td class="num">6</td><td><span class="i"></span><span class="d">------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h37">core/src/main/kotlin/me/rhunk/snapenhance/bridge/wrapper/LocaleWrapper.kt</a></td><td> | </td><td class="num">101</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h38">core/src/main/kotlin/me/rhunk/snapenhance/bridge/wrapper/MappingsWrapper.kt</a></td><td> | </td><td class="num">166</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h39">core/src/main/kotlin/me/rhunk/snapenhance/bridge/wrapper/MessageLoggerWrapper.kt</a></td><td> | </td><td class="num">71</td><td><span class="i"></span><span class="d">-----------------------------------------------------------------------</span></td></tr>
<tr><td class="A">A</td><td><a href="#h40">core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/BridgeClient.kt</a></td><td> | </td><td class="num">147</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h41">core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/FileLoaderWrapper.kt</a></td><td> | </td><td class="num">36</td><td><span class="i">++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h42">core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/types/BridgeFileType.kt</a></td><td> | </td><td class="num">26</td><td><span class="i">++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h43">core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/types/FileActionType.kt</a></td><td> | </td><td class="num">6</td><td><span class="i">++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h44">core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/wrapper/LocaleWrapper.kt</a></td><td> | </td><td class="num">101</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h45">core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/wrapper/MappingsWrapper.kt</a></td><td> | </td><td class="num">163</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h46">core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/wrapper/MessageLoggerWrapper.kt</a></td><td> | </td><td class="num">71</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h47">core/src/main/kotlin/me/rhunk/snapenhance/core/config/ConfigObjects.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h48">core/src/main/kotlin/me/rhunk/snapenhance/core/config/ModConfig.kt</a></td><td> | </td><td class="num">10</td><td><span class="i">++++</span><span class="d">------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h49">core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/Experimental.kt</a></td><td> | </td><td class="num">3</td><td><span class="i">++</span><span class="d">-</span></td></tr>
<tr><td class="A">A</td><td><a href="#h50">core/src/main/kotlin/me/rhunk/snapenhance/core/database/DatabaseAccess.kt</a></td><td> | </td><td class="num">258</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h51">core/src/main/kotlin/me/rhunk/snapenhance/core/database/DatabaseObject.kt</a></td><td> | </td><td class="num">7</td><td><span class="i">+++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h52">core/src/main/kotlin/me/rhunk/snapenhance/core/database/objects/ConversationMessage.kt</a></td><td> | </td><td class="num">50</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h53">core/src/main/kotlin/me/rhunk/snapenhance/core/database/objects/FriendFeedEntry.kt</a></td><td> | </td><td class="num">47</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h54">core/src/main/kotlin/me/rhunk/snapenhance/core/database/objects/FriendInfo.kt</a></td><td> | </td><td class="num">64</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h55">core/src/main/kotlin/me/rhunk/snapenhance/core/database/objects/StoryEntry.kt</a></td><td> | </td><td class="num">27</td><td><span class="i">+++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h56">core/src/main/kotlin/me/rhunk/snapenhance/core/database/objects/UserConversationLink.kt</a></td><td> | </td><td class="num">23</td><td><span class="i">+++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h57">core/src/main/kotlin/me/rhunk/snapenhance/core/download/DownloadManagerClient.kt</a></td><td> | </td><td class="num">74</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h58">core/src/main/kotlin/me/rhunk/snapenhance/core/download/DownloadTaskManager.kt</a></td><td> | </td><td class="num">183</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h59">core/src/main/kotlin/me/rhunk/snapenhance/core/download/data/DownloadMediaType.kt</a></td><td> | </td><td class="num">23</td><td><span class="i">+++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h60">core/src/main/kotlin/me/rhunk/snapenhance/core/download/data/DownloadMetadata.kt</a></td><td> | </td><td class="num">10</td><td><span class="i">++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h61">core/src/main/kotlin/me/rhunk/snapenhance/core/download/data/DownloadObject.kt</a></td><td> | </td><td class="num">32</td><td><span class="i">++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h62">core/src/main/kotlin/me/rhunk/snapenhance/core/download/data/DownloadRequest.kt</a></td><td> | </td><td class="num">27</td><td><span class="i">+++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h63">core/src/main/kotlin/me/rhunk/snapenhance/core/download/data/DownloadStage.kt</a></td><td> | </td><td class="num">15</td><td><span class="i">+++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h64">core/src/main/kotlin/me/rhunk/snapenhance/core/download/data/MediaEncryptionKeyPair.kt</a></td><td> | </td><td class="num">22</td><td><span class="i">++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h65">core/src/main/kotlin/me/rhunk/snapenhance/core/download/data/MediaFilter.kt</a></td><td> | </td><td class="num">19</td><td><span class="i">+++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h66">core/src/main/kotlin/me/rhunk/snapenhance/core/download/data/SplitMediaAssetType.kt</a></td><td> | </td><td class="num">5</td><td><span class="i">+++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h67">core/src/main/kotlin/me/rhunk/snapenhance/core/eventbus/EventBus.kt</a></td><td> | </td><td class="num">7</td><td><span class="i">+++</span><span class="d">----</span></td></tr>
<tr><td class="D">D</td><td><a href="#h68">core/src/main/kotlin/me/rhunk/snapenhance/database/DatabaseAccess.kt</a></td><td> | </td><td class="num">254</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h69">core/src/main/kotlin/me/rhunk/snapenhance/database/DatabaseObject.kt</a></td><td> | </td><td class="num">7</td><td><span class="i"></span><span class="d">-------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h70">core/src/main/kotlin/me/rhunk/snapenhance/database/objects/ConversationMessage.kt</a></td><td> | </td><td class="num">50</td><td><span class="i"></span><span class="d">--------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h71">core/src/main/kotlin/me/rhunk/snapenhance/database/objects/FriendFeedEntry.kt</a></td><td> | </td><td class="num">47</td><td><span class="i"></span><span class="d">-----------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h72">core/src/main/kotlin/me/rhunk/snapenhance/database/objects/FriendInfo.kt</a></td><td> | </td><td class="num">64</td><td><span class="i"></span><span class="d">----------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h73">core/src/main/kotlin/me/rhunk/snapenhance/database/objects/StoryEntry.kt</a></td><td> | </td><td class="num">27</td><td><span class="i"></span><span class="d">---------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h74">core/src/main/kotlin/me/rhunk/snapenhance/database/objects/UserConversationLink.kt</a></td><td> | </td><td class="num">23</td><td><span class="i"></span><span class="d">-----------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h75">core/src/main/kotlin/me/rhunk/snapenhance/download/DownloadManagerClient.kt</a></td><td> | </td><td class="num">70</td><td><span class="i"></span><span class="d">----------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h76">core/src/main/kotlin/me/rhunk/snapenhance/download/DownloadTaskManager.kt</a></td><td> | </td><td class="num">183</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h77">core/src/main/kotlin/me/rhunk/snapenhance/download/data/DownloadMediaType.kt</a></td><td> | </td><td class="num">23</td><td><span class="i"></span><span class="d">-----------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h78">core/src/main/kotlin/me/rhunk/snapenhance/download/data/DownloadMetadata.kt</a></td><td> | </td><td class="num">10</td><td><span class="i"></span><span class="d">----------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h79">core/src/main/kotlin/me/rhunk/snapenhance/download/data/DownloadObject.kt</a></td><td> | </td><td class="num">32</td><td><span class="i"></span><span class="d">--------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h80">core/src/main/kotlin/me/rhunk/snapenhance/download/data/DownloadRequest.kt</a></td><td> | </td><td class="num">27</td><td><span class="i"></span><span class="d">---------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h81">core/src/main/kotlin/me/rhunk/snapenhance/download/data/DownloadStage.kt</a></td><td> | </td><td class="num">15</td><td><span class="i"></span><span class="d">---------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h82">core/src/main/kotlin/me/rhunk/snapenhance/download/data/MediaEncryptionKeyPair.kt</a></td><td> | </td><td class="num">22</td><td><span class="i"></span><span class="d">----------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h83">core/src/main/kotlin/me/rhunk/snapenhance/download/data/MediaFilter.kt</a></td><td> | </td><td class="num">19</td><td><span class="i"></span><span class="d">-------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h84">core/src/main/kotlin/me/rhunk/snapenhance/download/data/SplitMediaAssetType.kt</a></td><td> | </td><td class="num">5</td><td><span class="i"></span><span class="d">-----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h85">core/src/main/kotlin/me/rhunk/snapenhance/features/BridgeFileFeature.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h86">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/AutoUpdater.kt</a></td><td> | </td><td class="num">3</td><td><span class="i">+</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h87">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/MediaDownloader.kt</a></td><td> | </td><td class="num">32</td><td><span class="i">+++++++++++++++</span><span class="d">-----------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h88">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/ProfilePictureDownloader.kt</a></td><td> | </td><td class="num">3</td><td><span class="i">+</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h89">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/experiments/DeviceSpooferHook.kt</a></td><td> | </td><td class="num">7</td><td><span class="i">+++</span><span class="d">----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h90">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/privacy/PreventMessageSending.kt</a></td><td> | </td><td class="num">3</td><td><span class="i">+</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h91">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/spying/AnonymousStoryViewing.kt</a></td><td> | </td><td class="num">1</td><td><span class="i"></span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h92">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/spying/MessageLogger.kt</a></td><td> | </td><td class="num">3</td><td><span class="i">+</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h93">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/AutoSave.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h94">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/DisableVideoLengthRestriction.kt</a></td><td> | </td><td class="num">3</td><td><span class="i">+</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h95">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/GooglePlayServicesDialogs.kt</a></td><td> | </td><td class="num">3</td><td><span class="i">+</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h96">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/Notifications.kt</a></td><td> | </td><td class="num">6</td><td><span class="i">+++</span><span class="d">---</span></td></tr>
<tr><td class="M">M</td><td><a href="#h97">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/PinConversations.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h98">core/src/main/kotlin/me/rhunk/snapenhance/manager/impl/ActionManager.kt</a></td><td> | </td><td class="num">45</td><td><span class="i">++++++++++++++++++++++</span><span class="d">-----------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h99">core/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/FriendFeedInfoMenu.kt</a></td><td> | </td><td class="num">10</td><td><span class="i">++++</span><span class="d">------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h100">core/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/OperaContextActionMenu.kt</a></td><td> | </td><td class="num">3</td><td><span class="i">+</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h101">core/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/SettingsMenu.kt</a></td><td> | </td><td class="num">6</td><td><span class="i">++</span><span class="d">----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h102">core/src/main/kotlin/me/rhunk/snapenhance/util/SQLiteDatabaseHelper.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h103">core/src/main/kotlin/me/rhunk/snapenhance/util/download/HttpServer.kt</a></td><td> | </td><td class="num">14</td><td><span class="i">+++++++</span><span class="d">-------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h104">core/src/main/kotlin/me/rhunk/snapenhance/util/download/RemoteMediaResolver.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h105">core/src/main/kotlin/me/rhunk/snapenhance/util/export/MessageExporter.kt</a></td><td> | </td><td class="num">9</td><td><span class="i">++++</span><span class="d">-----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h106">core/src/main/kotlin/me/rhunk/snapenhance/util/snap/MediaDownloaderHelper.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
</table></pre><pre>107 files changed, 2486 insertions(+), 1883 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/LogManager.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/LogManager.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/LogManager.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/LogManager.kt</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -0,0 +1,189 @@
</a><a href="#h0-0-0" id="h0-0-0" class="i">+package me.rhunk.snapenhance
</a><a href="#h0-0-1" id="h0-0-1" class="i">+
</a><a href="#h0-0-2" id="h0-0-2" class="i">+import android.content.SharedPreferences
</a><a href="#h0-0-3" id="h0-0-3" class="i">+import android.util.Log
</a><a href="#h0-0-4" id="h0-0-4" class="i">+import java.io.File
</a><a href="#h0-0-5" id="h0-0-5" class="i">+import java.io.OutputStream
</a><a href="#h0-0-6" id="h0-0-6" class="i">+import java.io.RandomAccessFile
</a><a href="#h0-0-7" id="h0-0-7" class="i">+import java.time.format.DateTimeFormatter
</a><a href="#h0-0-8" id="h0-0-8" class="i">+import java.util.zip.ZipEntry
</a><a href="#h0-0-9" id="h0-0-9" class="i">+import java.util.zip.ZipOutputStream
</a><a href="#h0-0-10" id="h0-0-10" class="i">+import kotlin.time.Duration.Companion.hours
</a><a href="#h0-0-11" id="h0-0-11" class="i">+
</a><a href="#h0-0-12" id="h0-0-12" class="i">+class LogLine(
</a><a href="#h0-0-13" id="h0-0-13" class="i">+    val logLevel: LogLevel,
</a><a href="#h0-0-14" id="h0-0-14" class="i">+    val dateTime: String,
</a><a href="#h0-0-15" id="h0-0-15" class="i">+    val tag: String,
</a><a href="#h0-0-16" id="h0-0-16" class="i">+    val message: String
</a><a href="#h0-0-17" id="h0-0-17" class="i">+) {
</a><a href="#h0-0-18" id="h0-0-18" class="i">+    companion object {
</a><a href="#h0-0-19" id="h0-0-19" class="i">+        fun fromString(line: String) = runCatching {
</a><a href="#h0-0-20" id="h0-0-20" class="i">+            val parts = line.trimEnd().split(&quot;/&quot;)
</a><a href="#h0-0-21" id="h0-0-21" class="i">+            if (parts.size != 4) return@runCatching null
</a><a href="#h0-0-22" id="h0-0-22" class="i">+            LogLine(
</a><a href="#h0-0-23" id="h0-0-23" class="i">+                LogLevel.fromLetter(parts[0]) ?: return@runCatching null,
</a><a href="#h0-0-24" id="h0-0-24" class="i">+                parts[1],
</a><a href="#h0-0-25" id="h0-0-25" class="i">+                parts[2],
</a><a href="#h0-0-26" id="h0-0-26" class="i">+                parts[3]
</a><a href="#h0-0-27" id="h0-0-27" class="i">+            )
</a><a href="#h0-0-28" id="h0-0-28" class="i">+        }.getOrNull()
</a><a href="#h0-0-29" id="h0-0-29" class="i">+    }
</a><a href="#h0-0-30" id="h0-0-30" class="i">+
</a><a href="#h0-0-31" id="h0-0-31" class="i">+    override fun toString(): String {
</a><a href="#h0-0-32" id="h0-0-32" class="i">+        return &quot;${logLevel.letter}/$dateTime/$tag/$message&quot;
</a><a href="#h0-0-33" id="h0-0-33" class="i">+    }
</a><a href="#h0-0-34" id="h0-0-34" class="i">+}
</a><a href="#h0-0-35" id="h0-0-35" class="i">+
</a><a href="#h0-0-36" id="h0-0-36" class="i">+
</a><a href="#h0-0-37" id="h0-0-37" class="i">+class LogReader(
</a><a href="#h0-0-38" id="h0-0-38" class="i">+    logFile: File
</a><a href="#h0-0-39" id="h0-0-39" class="i">+) {
</a><a href="#h0-0-40" id="h0-0-40" class="i">+    private val randomAccessFile = RandomAccessFile(logFile, &quot;r&quot;)
</a><a href="#h0-0-41" id="h0-0-41" class="i">+    private var startLineIndexes = mutableListOf&lt;Long&gt;()
</a><a href="#h0-0-42" id="h0-0-42" class="i">+    var lineCount = queryLineCount()
</a><a href="#h0-0-43" id="h0-0-43" class="i">+
</a><a href="#h0-0-44" id="h0-0-44" class="i">+    fun incrementLineCount() {
</a><a href="#h0-0-45" id="h0-0-45" class="i">+        randomAccessFile.seek(randomAccessFile.length())
</a><a href="#h0-0-46" id="h0-0-46" class="i">+        startLineIndexes.add(randomAccessFile.filePointer)
</a><a href="#h0-0-47" id="h0-0-47" class="i">+        lineCount++
</a><a href="#h0-0-48" id="h0-0-48" class="i">+    }
</a><a href="#h0-0-49" id="h0-0-49" class="i">+
</a><a href="#h0-0-50" id="h0-0-50" class="i">+    private fun queryLineCount(): Int {
</a><a href="#h0-0-51" id="h0-0-51" class="i">+        randomAccessFile.seek(0)
</a><a href="#h0-0-52" id="h0-0-52" class="i">+        var lines = 0
</a><a href="#h0-0-53" id="h0-0-53" class="i">+        var lastIndex: Long
</a><a href="#h0-0-54" id="h0-0-54" class="i">+        while (true) {
</a><a href="#h0-0-55" id="h0-0-55" class="i">+            lastIndex = randomAccessFile.filePointer
</a><a href="#h0-0-56" id="h0-0-56" class="i">+            randomAccessFile.readLine() ?: break
</a><a href="#h0-0-57" id="h0-0-57" class="i">+            startLineIndexes.add(lastIndex)
</a><a href="#h0-0-58" id="h0-0-58" class="i">+            lines++
</a><a href="#h0-0-59" id="h0-0-59" class="i">+        }
</a><a href="#h0-0-60" id="h0-0-60" class="i">+        return lines
</a><a href="#h0-0-61" id="h0-0-61" class="i">+    }
</a><a href="#h0-0-62" id="h0-0-62" class="i">+
</a><a href="#h0-0-63" id="h0-0-63" class="i">+    private fun getLine(index: Int): String? {
</a><a href="#h0-0-64" id="h0-0-64" class="i">+        if (index &lt;= 0 || index &gt; lineCount) return null
</a><a href="#h0-0-65" id="h0-0-65" class="i">+        randomAccessFile.seek(startLineIndexes[index])
</a><a href="#h0-0-66" id="h0-0-66" class="i">+        return randomAccessFile.readLine()
</a><a href="#h0-0-67" id="h0-0-67" class="i">+    }
</a><a href="#h0-0-68" id="h0-0-68" class="i">+
</a><a href="#h0-0-69" id="h0-0-69" class="i">+    fun getLogLine(index: Int): LogLine? {
</a><a href="#h0-0-70" id="h0-0-70" class="i">+        return getLine(index)?.let { LogLine.fromString(it) }
</a><a href="#h0-0-71" id="h0-0-71" class="i">+    }
</a><a href="#h0-0-72" id="h0-0-72" class="i">+}
</a><a href="#h0-0-73" id="h0-0-73" class="i">+
</a><a href="#h0-0-74" id="h0-0-74" class="i">+
</a><a href="#h0-0-75" id="h0-0-75" class="i">+class LogManager(
</a><a href="#h0-0-76" id="h0-0-76" class="i">+    remoteSideContext: RemoteSideContext
</a><a href="#h0-0-77" id="h0-0-77" class="i">+) {
</a><a href="#h0-0-78" id="h0-0-78" class="i">+    companion object {
</a><a href="#h0-0-79" id="h0-0-79" class="i">+        private const val TAG = &quot;SnapEnhanceManager&quot;
</a><a href="#h0-0-80" id="h0-0-80" class="i">+        private val LOG_LIFETIME = 24.hours
</a><a href="#h0-0-81" id="h0-0-81" class="i">+    }
</a><a href="#h0-0-82" id="h0-0-82" class="i">+
</a><a href="#h0-0-83" id="h0-0-83" class="i">+    var lineAddListener = { _: LogLine -&gt; }
</a><a href="#h0-0-84" id="h0-0-84" class="i">+
</a><a href="#h0-0-85" id="h0-0-85" class="i">+    private val logFolder = File(remoteSideContext.androidContext.cacheDir, &quot;logs&quot;)
</a><a href="#h0-0-86" id="h0-0-86" class="i">+    private val preferences: SharedPreferences
</a><a href="#h0-0-87" id="h0-0-87" class="i">+
</a><a href="#h0-0-88" id="h0-0-88" class="i">+    private var logFile: File
</a><a href="#h0-0-89" id="h0-0-89" class="i">+
</a><a href="#h0-0-90" id="h0-0-90" class="i">+    init {
</a><a href="#h0-0-91" id="h0-0-91" class="i">+        if (!logFolder.exists()) {
</a><a href="#h0-0-92" id="h0-0-92" class="i">+            logFolder.mkdirs()
</a><a href="#h0-0-93" id="h0-0-93" class="i">+        }
</a><a href="#h0-0-94" id="h0-0-94" class="i">+        preferences = remoteSideContext.androidContext.getSharedPreferences(&quot;logger&quot;, 0)
</a><a href="#h0-0-95" id="h0-0-95" class="i">+        logFile = preferences.getString(&quot;log_file&quot;, null)?.let { File(it) }?.takeIf { it.exists() } ?: run {
</a><a href="#h0-0-96" id="h0-0-96" class="i">+            newLogFile()
</a><a href="#h0-0-97" id="h0-0-97" class="i">+            logFile
</a><a href="#h0-0-98" id="h0-0-98" class="i">+        }
</a><a href="#h0-0-99" id="h0-0-99" class="i">+
</a><a href="#h0-0-100" id="h0-0-100" class="i">+        if (System.currentTimeMillis() - preferences.getLong(&quot;last_created&quot;, 0) &gt; LOG_LIFETIME.inWholeMilliseconds) {
</a><a href="#h0-0-101" id="h0-0-101" class="i">+            newLogFile()
</a><a href="#h0-0-102" id="h0-0-102" class="i">+        }
</a><a href="#h0-0-103" id="h0-0-103" class="i">+    }
</a><a href="#h0-0-104" id="h0-0-104" class="i">+
</a><a href="#h0-0-105" id="h0-0-105" class="i">+    private fun getCurrentDateTime(pathSafe: Boolean = false): String {
</a><a href="#h0-0-106" id="h0-0-106" class="i">+        return DateTimeFormatter.ofPattern(if (pathSafe) &quot;yyyy-MM-dd_HH-mm-ss&quot; else &quot;yyyy-MM-dd HH:mm:ss&quot;).format(
</a><a href="#h0-0-107" id="h0-0-107" class="i">+            java.time.LocalDateTime.now()
</a><a href="#h0-0-108" id="h0-0-108" class="i">+        )
</a><a href="#h0-0-109" id="h0-0-109" class="i">+    }
</a><a href="#h0-0-110" id="h0-0-110" class="i">+
</a><a href="#h0-0-111" id="h0-0-111" class="i">+    private fun newLogFile() {
</a><a href="#h0-0-112" id="h0-0-112" class="i">+        val currentTime = System.currentTimeMillis()
</a><a href="#h0-0-113" id="h0-0-113" class="i">+        logFile = File(logFolder, &quot;snapenhance_${getCurrentDateTime(pathSafe = true)}.log&quot;).also {
</a><a href="#h0-0-114" id="h0-0-114" class="i">+            it.createNewFile()
</a><a href="#h0-0-115" id="h0-0-115" class="i">+        }
</a><a href="#h0-0-116" id="h0-0-116" class="i">+        preferences.edit().putString(&quot;log_file&quot;, logFile.absolutePath).putLong(&quot;last_created&quot;, currentTime).apply()
</a><a href="#h0-0-117" id="h0-0-117" class="i">+    }
</a><a href="#h0-0-118" id="h0-0-118" class="i">+
</a><a href="#h0-0-119" id="h0-0-119" class="i">+    fun clearLogs() {
</a><a href="#h0-0-120" id="h0-0-120" class="i">+        logFile.delete()
</a><a href="#h0-0-121" id="h0-0-121" class="i">+        newLogFile()
</a><a href="#h0-0-122" id="h0-0-122" class="i">+    }
</a><a href="#h0-0-123" id="h0-0-123" class="i">+
</a><a href="#h0-0-124" id="h0-0-124" class="i">+    fun getLogFile() = logFile
</a><a href="#h0-0-125" id="h0-0-125" class="i">+
</a><a href="#h0-0-126" id="h0-0-126" class="i">+    fun exportLogsToZip(outputStream: OutputStream) {
</a><a href="#h0-0-127" id="h0-0-127" class="i">+        val zipOutputStream = ZipOutputStream(outputStream)
</a><a href="#h0-0-128" id="h0-0-128" class="i">+        //add logFolder to zip
</a><a href="#h0-0-129" id="h0-0-129" class="i">+        logFolder.walk().forEach {
</a><a href="#h0-0-130" id="h0-0-130" class="i">+            if (it.isFile) {
</a><a href="#h0-0-131" id="h0-0-131" class="i">+                zipOutputStream.putNextEntry(ZipEntry(it.name))
</a><a href="#h0-0-132" id="h0-0-132" class="i">+                it.inputStream().copyTo(zipOutputStream)
</a><a href="#h0-0-133" id="h0-0-133" class="i">+                zipOutputStream.closeEntry()
</a><a href="#h0-0-134" id="h0-0-134" class="i">+            }
</a><a href="#h0-0-135" id="h0-0-135" class="i">+        }
</a><a href="#h0-0-136" id="h0-0-136" class="i">+
</a><a href="#h0-0-137" id="h0-0-137" class="i">+        //add device info to zip
</a><a href="#h0-0-138" id="h0-0-138" class="i">+        zipOutputStream.putNextEntry(ZipEntry(&quot;device_info.txt&quot;))
</a><a href="#h0-0-139" id="h0-0-139" class="i">+
</a><a href="#h0-0-140" id="h0-0-140" class="i">+
</a><a href="#h0-0-141" id="h0-0-141" class="i">+        zipOutputStream.close()
</a><a href="#h0-0-142" id="h0-0-142" class="i">+    }
</a><a href="#h0-0-143" id="h0-0-143" class="i">+
</a><a href="#h0-0-144" id="h0-0-144" class="i">+    fun newReader(onAddLine: (LogLine) -&gt; Unit) = LogReader(logFile).also {
</a><a href="#h0-0-145" id="h0-0-145" class="i">+        lineAddListener = { line -&gt; it.incrementLineCount(); onAddLine(line) }
</a><a href="#h0-0-146" id="h0-0-146" class="i">+    }
</a><a href="#h0-0-147" id="h0-0-147" class="i">+
</a><a href="#h0-0-148" id="h0-0-148" class="i">+    fun debug(message: Any?, tag: String = TAG) {
</a><a href="#h0-0-149" id="h0-0-149" class="i">+        internalLog(tag, LogLevel.DEBUG, message)
</a><a href="#h0-0-150" id="h0-0-150" class="i">+    }
</a><a href="#h0-0-151" id="h0-0-151" class="i">+
</a><a href="#h0-0-152" id="h0-0-152" class="i">+    fun error(message: Any?, tag: String = TAG) {
</a><a href="#h0-0-153" id="h0-0-153" class="i">+        internalLog(tag, LogLevel.ERROR, message)
</a><a href="#h0-0-154" id="h0-0-154" class="i">+    }
</a><a href="#h0-0-155" id="h0-0-155" class="i">+
</a><a href="#h0-0-156" id="h0-0-156" class="i">+    fun error(message: Any?, throwable: Throwable, tag: String = TAG) {
</a><a href="#h0-0-157" id="h0-0-157" class="i">+        internalLog(tag, LogLevel.ERROR, message)
</a><a href="#h0-0-158" id="h0-0-158" class="i">+        internalLog(tag, LogLevel.ERROR, throwable)
</a><a href="#h0-0-159" id="h0-0-159" class="i">+    }
</a><a href="#h0-0-160" id="h0-0-160" class="i">+
</a><a href="#h0-0-161" id="h0-0-161" class="i">+    fun info(message: Any?, tag: String = TAG) {
</a><a href="#h0-0-162" id="h0-0-162" class="i">+        internalLog(tag, LogLevel.INFO, message)
</a><a href="#h0-0-163" id="h0-0-163" class="i">+    }
</a><a href="#h0-0-164" id="h0-0-164" class="i">+
</a><a href="#h0-0-165" id="h0-0-165" class="i">+    fun verbose(message: Any?, tag: String = TAG) {
</a><a href="#h0-0-166" id="h0-0-166" class="i">+        internalLog(tag, LogLevel.VERBOSE, message)
</a><a href="#h0-0-167" id="h0-0-167" class="i">+    }
</a><a href="#h0-0-168" id="h0-0-168" class="i">+
</a><a href="#h0-0-169" id="h0-0-169" class="i">+    fun warn(message: Any?, tag: String = TAG) {
</a><a href="#h0-0-170" id="h0-0-170" class="i">+        internalLog(tag, LogLevel.WARN, message)
</a><a href="#h0-0-171" id="h0-0-171" class="i">+    }
</a><a href="#h0-0-172" id="h0-0-172" class="i">+
</a><a href="#h0-0-173" id="h0-0-173" class="i">+    fun assert(message: Any?, tag: String = TAG) {
</a><a href="#h0-0-174" id="h0-0-174" class="i">+        internalLog(tag, LogLevel.ASSERT, message)
</a><a href="#h0-0-175" id="h0-0-175" class="i">+    }
</a><a href="#h0-0-176" id="h0-0-176" class="i">+
</a><a href="#h0-0-177" id="h0-0-177" class="i">+    fun internalLog(tag: String, logLevel: LogLevel, message: Any?) {
</a><a href="#h0-0-178" id="h0-0-178" class="i">+        runCatching {
</a><a href="#h0-0-179" id="h0-0-179" class="i">+            val line = LogLine(logLevel, getCurrentDateTime(), tag, message.toString())
</a><a href="#h0-0-180" id="h0-0-180" class="i">+            logFile.appendText(&quot;$line\n&quot;, Charsets.UTF_8)
</a><a href="#h0-0-181" id="h0-0-181" class="i">+            lineAddListener(line)
</a><a href="#h0-0-182" id="h0-0-182" class="i">+            Log.println(logLevel.priority, tag, message.toString())
</a><a href="#h0-0-183" id="h0-0-183" class="i">+        }.onFailure {
</a><a href="#h0-0-184" id="h0-0-184" class="i">+            Log.println(Log.ERROR, tag, &quot;Failed to log message: $message&quot;)
</a><a href="#h0-0-185" id="h0-0-185" class="i">+            Log.println(Log.ERROR, tag, it.toString())
</a><a href="#h0-0-186" id="h0-0-186" class="i">+        }
</a><a href="#h0-0-187" id="h0-0-187" class="i">+    }
</a><a href="#h0-0-188" id="h0-0-188" class="i">+}</a><a href="#h0-0-189" id="h0-0-189" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h1" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/RemoteSideContext.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/RemoteSideContext.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/RemoteSideContext.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/RemoteSideContext.kt</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -3,9 +3,12 @@ package me.rhunk.snapenhance
</a> import android.app.Activity
 import android.content.Context
 import android.content.Intent
<a href="#h1-0-3" id="h1-0-3" class="i">+import android.content.pm.PackageManager
</a> import android.net.Uri
<a href="#h1-0-5" id="h1-0-5" class="i">+import android.os.Build
</a> import android.widget.Toast
 import androidx.activity.ComponentActivity
<a href="#h1-0-8" id="h1-0-8" class="i">+import androidx.core.app.CoreComponentFactory
</a> import androidx.documentfile.provider.DocumentFile
 import coil.ImageLoader
 import coil.decode.VideoFrameDecoder
<a href="#h1-1" id="h1-1" class="h">@@ -13,18 +16,25 @@ import coil.disk.DiskCache
</a> import coil.memory.MemoryCache
 import kotlinx.coroutines.Dispatchers
 import me.rhunk.snapenhance.bridge.BridgeService
<a href="#h1-1-3" id="h1-1-3" class="d">-import me.rhunk.snapenhance.bridge.wrapper.LocaleWrapper
</a><a href="#h1-1-4" id="h1-1-4" class="d">-import me.rhunk.snapenhance.bridge.wrapper.MappingsWrapper
</a><a href="#h1-1-5" id="h1-1-5" class="i">+import me.rhunk.snapenhance.core.BuildConfig
</a><a href="#h1-1-6" id="h1-1-6" class="i">+import me.rhunk.snapenhance.core.bridge.wrapper.LocaleWrapper
</a><a href="#h1-1-7" id="h1-1-7" class="i">+import me.rhunk.snapenhance.core.bridge.wrapper.MappingsWrapper
</a> import me.rhunk.snapenhance.core.config.ModConfig
<a href="#h1-1-9" id="h1-1-9" class="d">-import me.rhunk.snapenhance.download.DownloadTaskManager
</a><a href="#h1-1-10" id="h1-1-10" class="i">+import me.rhunk.snapenhance.core.download.DownloadTaskManager
</a> import me.rhunk.snapenhance.messaging.ModDatabase
 import me.rhunk.snapenhance.messaging.StreaksReminder
<a href="#h1-1-13" id="h1-1-13" class="i">+import me.rhunk.snapenhance.ui.manager.MainActivity
</a> import me.rhunk.snapenhance.ui.manager.data.InstallationSummary
<a href="#h1-1-15" id="h1-1-15" class="d">-import me.rhunk.snapenhance.ui.manager.data.ModMappingsInfo
</a><a href="#h1-1-16" id="h1-1-16" class="i">+import me.rhunk.snapenhance.ui.manager.data.ModInfo
</a><a href="#h1-1-17" id="h1-1-17" class="i">+import me.rhunk.snapenhance.ui.manager.data.PlatformInfo
</a> import me.rhunk.snapenhance.ui.manager.data.SnapchatAppInfo
 import me.rhunk.snapenhance.ui.setup.Requirements
 import me.rhunk.snapenhance.ui.setup.SetupActivity
<a href="#h1-1-21" id="h1-1-21" class="i">+import java.io.ByteArrayInputStream
</a> import java.lang.ref.WeakReference
<a href="#h1-1-23" id="h1-1-23" class="i">+import java.security.cert.CertificateFactory
</a><a href="#h1-1-24" id="h1-1-24" class="i">+import java.security.cert.X509Certificate
</a><a href="#h1-1-25" id="h1-1-25" class="i">+
</a> 
 class RemoteSideContext(
     val androidContext: Context
<a href="#h1-2" id="h1-2" class="h">@@ -42,6 +52,7 @@ class RemoteSideContext(
</a>     val downloadTaskManager = DownloadTaskManager()
     val modDatabase = ModDatabase(this)
     val streaksReminder = StreaksReminder(this)
<a href="#h1-2-3" id="h1-2-3" class="i">+    val log = LogManager(this)
</a> 
     //used to load bitmoji selfies and download previews
     val imageLoader by lazy {
<a href="#h1-3" id="h1-3" class="h">@@ -76,37 +87,57 @@ class RemoteSideContext(
</a>             modDatabase.init()
             streaksReminder.init()
         }.onFailure {
<a href="#h1-3-3" id="h1-3-3" class="d">-            Logger.error(&quot;Failed to load RemoteSideContext&quot;, it)
</a><a href="#h1-3-4" id="h1-3-4" class="i">+            log.error(&quot;Failed to load RemoteSideContext&quot;, it)
</a>         }
     }
 
<a href="#h1-3-8" id="h1-3-8" class="d">-    fun getInstallationSummary() = InstallationSummary(
</a><a href="#h1-3-9" id="h1-3-9" class="d">-        snapchatInfo = mappings.getSnapchatPackageInfo()?.let {
</a><a href="#h1-3-10" id="h1-3-10" class="d">-            SnapchatAppInfo(
</a><a href="#h1-3-11" id="h1-3-11" class="d">-                version = it.versionName,
</a><a href="#h1-3-12" id="h1-3-12" class="d">-                versionCode = it.longVersionCode
</a><a href="#h1-3-13" id="h1-3-13" class="d">-            )
</a><a href="#h1-3-14" id="h1-3-14" class="d">-        },
</a><a href="#h1-3-15" id="h1-3-15" class="d">-        mappingsInfo = if (mappings.isMappingsLoaded()) {
</a><a href="#h1-3-16" id="h1-3-16" class="d">-            ModMappingsInfo(
</a><a href="#h1-3-17" id="h1-3-17" class="d">-                generatedSnapchatVersion = mappings.getGeneratedBuildNumber(),
</a><a href="#h1-3-18" id="h1-3-18" class="d">-                isOutdated = mappings.isMappingsOutdated()
</a><a href="#h1-3-19" id="h1-3-19" class="i">+    val installationSummary by lazy {
</a><a href="#h1-3-20" id="h1-3-20" class="i">+        InstallationSummary(
</a><a href="#h1-3-21" id="h1-3-21" class="i">+            snapchatInfo = mappings.getSnapchatPackageInfo()?.let {
</a><a href="#h1-3-22" id="h1-3-22" class="i">+                SnapchatAppInfo(
</a><a href="#h1-3-23" id="h1-3-23" class="i">+                    packageName = it.packageName,
</a><a href="#h1-3-24" id="h1-3-24" class="i">+                    version = it.versionName,
</a><a href="#h1-3-25" id="h1-3-25" class="i">+                    versionCode = it.longVersionCode,
</a><a href="#h1-3-26" id="h1-3-26" class="i">+                    isLSPatched = it.applicationInfo.appComponentFactory != CoreComponentFactory::class.java.name,
</a><a href="#h1-3-27" id="h1-3-27" class="i">+                    isSplitApk = it.splitNames.isNotEmpty()
</a><a href="#h1-3-28" id="h1-3-28" class="i">+                )
</a><a href="#h1-3-29" id="h1-3-29" class="i">+            },
</a><a href="#h1-3-30" id="h1-3-30" class="i">+            modInfo = ModInfo(
</a><a href="#h1-3-31" id="h1-3-31" class="i">+                loaderPackageName = MainActivity::class.java.`package`?.name ?: &quot;unknown&quot;,
</a><a href="#h1-3-32" id="h1-3-32" class="i">+                buildPackageName = BuildConfig.APPLICATION_ID,
</a><a href="#h1-3-33" id="h1-3-33" class="i">+                buildVersion = BuildConfig.VERSION_NAME,
</a><a href="#h1-3-34" id="h1-3-34" class="i">+                buildVersionCode = BuildConfig.VERSION_CODE.toLong(),
</a><a href="#h1-3-35" id="h1-3-35" class="i">+                buildIssuer = androidContext.packageManager.getPackageInfo(BuildConfig.APPLICATION_ID, PackageManager.GET_SIGNING_CERTIFICATES)
</a><a href="#h1-3-36" id="h1-3-36" class="i">+                    ?.signingInfo?.apkContentsSigners?.firstOrNull()?.let {
</a><a href="#h1-3-37" id="h1-3-37" class="i">+                        val certFactory = CertificateFactory.getInstance(&quot;X509&quot;)
</a><a href="#h1-3-38" id="h1-3-38" class="i">+                        val cert = certFactory.generateCertificate(ByteArrayInputStream(it.toByteArray())) as X509Certificate
</a><a href="#h1-3-39" id="h1-3-39" class="i">+                        cert.issuerDN.toString()
</a><a href="#h1-3-40" id="h1-3-40" class="i">+                    } ?: throw Exception(&quot;Failed to get certificate info&quot;),
</a><a href="#h1-3-41" id="h1-3-41" class="i">+                isDebugBuild = BuildConfig.DEBUG,
</a><a href="#h1-3-42" id="h1-3-42" class="i">+                mappingVersion = mappings.getGeneratedBuildNumber(),
</a><a href="#h1-3-43" id="h1-3-43" class="i">+                mappingsOutdated = mappings.isMappingsOutdated()
</a><a href="#h1-3-44" id="h1-3-44" class="i">+            ),
</a><a href="#h1-3-45" id="h1-3-45" class="i">+            platformInfo = PlatformInfo(
</a><a href="#h1-3-46" id="h1-3-46" class="i">+                device = Build.DEVICE,
</a><a href="#h1-3-47" id="h1-3-47" class="i">+                buildFingerprint = Build.FINGERPRINT,
</a><a href="#h1-3-48" id="h1-3-48" class="i">+                androidVersion = Build.VERSION.RELEASE,
</a><a href="#h1-3-49" id="h1-3-49" class="i">+                systemAbi = Build.SUPPORTED_ABIS.firstOrNull() ?: &quot;unknown&quot;
</a>             )
<a href="#h1-3-51" id="h1-3-51" class="d">-        } else null
</a><a href="#h1-3-52" id="h1-3-52" class="d">-    )
</a><a href="#h1-3-53" id="h1-3-53" class="i">+        )
</a><a href="#h1-3-54" id="h1-3-54" class="i">+    }
</a> 
     fun longToast(message: Any) {
         androidContext.mainExecutor.execute {
             Toast.makeText(androidContext, message.toString(), Toast.LENGTH_LONG).show()
         }
<a href="#h1-3-60" id="h1-3-60" class="d">-        Logger.debug(message.toString())
</a><a href="#h1-3-61" id="h1-3-61" class="i">+        log.debug(message.toString())
</a>     }
 
     fun shortToast(message: Any) {
         androidContext.mainExecutor.execute {
             Toast.makeText(androidContext, message.toString(), Toast.LENGTH_SHORT).show()
         }
<a href="#h1-3-68" id="h1-3-68" class="d">-        Logger.debug(message.toString())
</a><a href="#h1-3-69" id="h1-3-69" class="i">+        log.debug(message.toString())
</a>     }
 
     fun checkForRequirements(overrideRequirements: Int? = null): Boolean {
<b>diff --git a/<a id="h2" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/BridgeService.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/BridgeService.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/BridgeService.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/BridgeService.kt</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -3,16 +3,16 @@ package me.rhunk.snapenhance.bridge
</a> import android.app.Service
 import android.content.Intent
 import android.os.IBinder
<a href="#h2-0-3" id="h2-0-3" class="d">-import me.rhunk.snapenhance.Logger
</a><a href="#h2-0-4" id="h2-0-4" class="i">+import me.rhunk.snapenhance.LogLevel
</a> import me.rhunk.snapenhance.RemoteSideContext
 import me.rhunk.snapenhance.SharedContextHolder
<a href="#h2-0-7" id="h2-0-7" class="d">-import me.rhunk.snapenhance.bridge.types.BridgeFileType
</a><a href="#h2-0-8" id="h2-0-8" class="d">-import me.rhunk.snapenhance.bridge.types.FileActionType
</a><a href="#h2-0-9" id="h2-0-9" class="d">-import me.rhunk.snapenhance.bridge.wrapper.LocaleWrapper
</a><a href="#h2-0-10" id="h2-0-10" class="d">-import me.rhunk.snapenhance.bridge.wrapper.MessageLoggerWrapper
</a><a href="#h2-0-11" id="h2-0-11" class="i">+import me.rhunk.snapenhance.core.bridge.types.BridgeFileType
</a><a href="#h2-0-12" id="h2-0-12" class="i">+import me.rhunk.snapenhance.core.bridge.types.FileActionType
</a><a href="#h2-0-13" id="h2-0-13" class="i">+import me.rhunk.snapenhance.core.bridge.wrapper.LocaleWrapper
</a><a href="#h2-0-14" id="h2-0-14" class="i">+import me.rhunk.snapenhance.core.bridge.wrapper.MessageLoggerWrapper
</a><a href="#h2-0-15" id="h2-0-15" class="i">+import me.rhunk.snapenhance.core.database.objects.FriendInfo
</a> import me.rhunk.snapenhance.core.messaging.MessagingFriendInfo
 import me.rhunk.snapenhance.core.messaging.MessagingGroupInfo
<a href="#h2-0-18" id="h2-0-18" class="d">-import me.rhunk.snapenhance.database.objects.FriendInfo
</a> import me.rhunk.snapenhance.download.DownloadProcessor
 import me.rhunk.snapenhance.util.SerializableDataObject
 import kotlin.system.measureTimeMillis
<a href="#h2-1" id="h2-1" class="h">@@ -36,7 +36,7 @@ class BridgeService : Service() {
</a>     fun triggerFriendSync(friendId: String) {
         val syncedFriend = syncCallback.syncFriend(friendId)
         if (syncedFriend == null) {
<a href="#h2-1-3" id="h2-1-3" class="d">-            Logger.error(&quot;Failed to sync friend $friendId&quot;)
</a><a href="#h2-1-4" id="h2-1-4" class="i">+            remoteSideContext.log.error(&quot;Failed to sync friend $friendId&quot;)
</a>             return
         }
         SerializableDataObject.fromJson&lt;FriendInfo&gt;(syncedFriend).let {
<a href="#h2-2" id="h2-2" class="h">@@ -47,7 +47,7 @@ class BridgeService : Service() {
</a>     fun triggerGroupSync(groupId: String) {
         val syncedGroup = syncCallback.syncGroup(groupId)
         if (syncedGroup == null) {
<a href="#h2-2-3" id="h2-2-3" class="d">-            Logger.error(&quot;Failed to sync group $groupId&quot;)
</a><a href="#h2-2-4" id="h2-2-4" class="i">+            remoteSideContext.log.error(&quot;Failed to sync group $groupId&quot;)
</a>             return
         }
         SerializableDataObject.fromJson&lt;MessagingGroupInfo&gt;(syncedGroup).let {
<a href="#h2-3" id="h2-3" class="h">@@ -56,10 +56,12 @@ class BridgeService : Service() {
</a>     }
 
     inner class BridgeBinder : BridgeInterface.Stub() {
<a href="#h2-3-3" id="h2-3-3" class="i">+        override fun broadcastLog(tag: String, level: String, message: String) {
</a><a href="#h2-3-4" id="h2-3-4" class="i">+            remoteSideContext.log.internalLog(tag, LogLevel.fromShortName(level) ?: LogLevel.INFO, message)
</a><a href="#h2-3-5" id="h2-3-5" class="i">+        }
</a><a href="#h2-3-6" id="h2-3-6" class="i">+
</a>         override fun fileOperation(action: Int, fileType: Int, content: ByteArray?): ByteArray {
<a href="#h2-3-8" id="h2-3-8" class="d">-            val resolvedFile by lazy {
</a><a href="#h2-3-9" id="h2-3-9" class="d">-                BridgeFileType.fromValue(fileType)?.resolve(this@BridgeService)
</a><a href="#h2-3-10" id="h2-3-10" class="d">-            }
</a><a href="#h2-3-11" id="h2-3-11" class="i">+            val resolvedFile = BridgeFileType.fromValue(fileType)?.resolve(this@BridgeService)
</a> 
             return when (FileActionType.values()[action]) {
                 FileActionType.CREATE_AND_READ -&gt; {
<a href="#h2-4" id="h2-4" class="h">@@ -108,8 +110,6 @@ class BridgeService : Service() {
</a>         override fun deleteMessageLoggerMessage(conversationId: String, id: Long) =
             messageLoggerWrapper.deleteMessage(conversationId, id)
 
<a href="#h2-4-3" id="h2-4-3" class="d">-        override fun clearMessageLogger() = messageLoggerWrapper.clearMessages()
</a><a href="#h2-4-4" id="h2-4-4" class="d">-
</a>         override fun getApplicationApkPath(): String = applicationInfo.publicSourceDir
 
         override fun fetchLocales(userLocale: String) =
<a href="#h2-5" id="h2-5" class="h">@@ -133,25 +133,24 @@ class BridgeService : Service() {
</a>         }
 
         override fun sync(callback: SyncCallback) {
<a href="#h2-5-3" id="h2-5-3" class="d">-            Logger.debug(&quot;Syncing remote&quot;)
</a>             syncCallback = callback
             measureTimeMillis {
                 remoteSideContext.modDatabase.getFriends().map { it.userId } .forEach { friendId -&gt;
                     runCatching {
                         triggerFriendSync(friendId)
                     }.onFailure {
<a href="#h2-5-10" id="h2-5-10" class="d">-                        Logger.error(&quot;Failed to sync friend $friendId&quot;, it)
</a><a href="#h2-5-11" id="h2-5-11" class="i">+                        remoteSideContext.log.error(&quot;Failed to sync friend $friendId&quot;, it)
</a>                     }
                 }
                 remoteSideContext.modDatabase.getGroups().map { it.conversationId }.forEach { groupId -&gt;
                     runCatching {
                         triggerGroupSync(groupId)
                     }.onFailure {
<a href="#h2-5-18" id="h2-5-18" class="d">-                        Logger.error(&quot;Failed to sync group $groupId&quot;, it)
</a><a href="#h2-5-19" id="h2-5-19" class="i">+                        remoteSideContext.log.error(&quot;Failed to sync group $groupId&quot;, it)
</a>                     }
                 }
             }.also {
<a href="#h2-5-23" id="h2-5-23" class="d">-                Logger.debug(&quot;Syncing remote took $it ms&quot;)
</a><a href="#h2-5-24" id="h2-5-24" class="i">+                remoteSideContext.log.verbose(&quot;Syncing remote took $it ms&quot;)
</a>             }
         }
 
<a href="#h2-6" id="h2-6" class="h">@@ -159,7 +158,7 @@ class BridgeService : Service() {
</a>             groups: List&lt;String&gt;,
             friends: List&lt;String&gt;
         ) {
<a href="#h2-6-3" id="h2-6-3" class="d">-            Logger.debug(&quot;Received ${groups.size} groups and ${friends.size} friends&quot;)
</a><a href="#h2-6-4" id="h2-6-4" class="i">+            remoteSideContext.log.verbose(&quot;Received ${groups.size} groups and ${friends.size} friends&quot;)
</a>             remoteSideContext.modDatabase.receiveMessagingDataCallback(
                 friends.map { SerializableDataObject.fromJson&lt;MessagingFriendInfo&gt;(it) },
                 groups.map { SerializableDataObject.fromJson&lt;MessagingGroupInfo&gt;(it) }
<b>diff --git a/<a id="h3" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadProcessor.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadProcessor.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadProcessor.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadProcessor.kt</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -19,14 +19,15 @@ import me.rhunk.snapenhance.Constants
</a> import me.rhunk.snapenhance.Logger
 import me.rhunk.snapenhance.RemoteSideContext
 import me.rhunk.snapenhance.bridge.DownloadCallback
<a href="#h3-0-3" id="h3-0-3" class="i">+import me.rhunk.snapenhance.core.download.DownloadManagerClient
</a> import me.rhunk.snapenhance.data.FileType
<a href="#h3-0-5" id="h3-0-5" class="d">-import me.rhunk.snapenhance.download.data.DownloadMediaType
</a><a href="#h3-0-6" id="h3-0-6" class="d">-import me.rhunk.snapenhance.download.data.DownloadMetadata
</a><a href="#h3-0-7" id="h3-0-7" class="d">-import me.rhunk.snapenhance.download.data.DownloadObject
</a><a href="#h3-0-8" id="h3-0-8" class="d">-import me.rhunk.snapenhance.download.data.DownloadRequest
</a><a href="#h3-0-9" id="h3-0-9" class="d">-import me.rhunk.snapenhance.download.data.DownloadStage
</a><a href="#h3-0-10" id="h3-0-10" class="d">-import me.rhunk.snapenhance.download.data.InputMedia
</a><a href="#h3-0-11" id="h3-0-11" class="d">-import me.rhunk.snapenhance.download.data.MediaEncryptionKeyPair
</a><a href="#h3-0-12" id="h3-0-12" class="i">+import me.rhunk.snapenhance.core.download.data.DownloadMediaType
</a><a href="#h3-0-13" id="h3-0-13" class="i">+import me.rhunk.snapenhance.core.download.data.DownloadMetadata
</a><a href="#h3-0-14" id="h3-0-14" class="i">+import me.rhunk.snapenhance.core.download.data.DownloadObject
</a><a href="#h3-0-15" id="h3-0-15" class="i">+import me.rhunk.snapenhance.core.download.data.DownloadRequest
</a><a href="#h3-0-16" id="h3-0-16" class="i">+import me.rhunk.snapenhance.core.download.data.DownloadStage
</a><a href="#h3-0-17" id="h3-0-17" class="i">+import me.rhunk.snapenhance.core.download.data.InputMedia
</a><a href="#h3-0-18" id="h3-0-18" class="i">+import me.rhunk.snapenhance.core.download.data.MediaEncryptionKeyPair
</a> import me.rhunk.snapenhance.util.download.RemoteMediaResolver
 import me.rhunk.snapenhance.util.snap.MediaDownloaderHelper
 import java.io.File
<a href="#h3-1" id="h3-1" class="h">@@ -178,14 +179,14 @@ class DownloadProcessor (
</a>                 mediaScanIntent.setData(outputFile.uri)
                 remoteSideContext.androidContext.sendBroadcast(mediaScanIntent)
             }.onFailure {
<a href="#h3-1-3" id="h3-1-3" class="d">-                Logger.error(&quot;Failed to scan media file&quot;, it)
</a><a href="#h3-1-4" id="h3-1-4" class="i">+                remoteSideContext.log.error(&quot;Failed to scan media file&quot;, it)
</a>                 callbackOnFailure(translation.format(&quot;failed_gallery_toast&quot;, &quot;error&quot; to it.toString()), it.message)
             }
 
<a href="#h3-1-8" id="h3-1-8" class="d">-            Logger.debug(&quot;download complete&quot;)
</a><a href="#h3-1-9" id="h3-1-9" class="i">+            remoteSideContext.log.verbose(&quot;download complete&quot;)
</a>             callbackOnSuccess(fileName)
         }.onFailure { exception -&gt;
<a href="#h3-1-12" id="h3-1-12" class="d">-            Logger.error(exception)
</a><a href="#h3-1-13" id="h3-1-13" class="i">+            remoteSideContext.log.error(&quot;Failed to save media to gallery&quot;, exception)
</a>             callbackOnFailure(translation.format(&quot;failed_gallery_toast&quot;, &quot;error&quot; to exception.toString()), exception.message)
             downloadObject.downloadStage = DownloadStage.FAILED
         }
<a href="#h3-2" id="h3-2" class="h">@@ -284,7 +285,7 @@ class DownloadProcessor (
</a>                 saveMediaToGallery(outputFile, downloadObjectObject)
             }.onFailure { exception -&gt;
                 if (coroutineContext.job.isCancelled) return@onFailure
<a href="#h3-2-3" id="h3-2-3" class="d">-                Logger.error(exception)
</a><a href="#h3-2-4" id="h3-2-4" class="i">+                remoteSideContext.log.error(&quot;Failed to download dash media&quot;, exception)
</a>                 callbackOnFailure(translation.format(&quot;failed_processing_toast&quot;, &quot;error&quot; to exception.toString()), exception.message)
                 downloadObjectObject.downloadStage = DownloadStage.FAILED
             }
<a href="#h3-3" id="h3-3" class="h">@@ -333,7 +334,7 @@ class DownloadProcessor (
</a>                 val downloadedMedias = downloadInputMedias(downloadRequest).map {
                     it.key to DownloadedFile(it.value, FileType.fromFile(it.value))
                 }.toMap().toMutableMap()
<a href="#h3-3-3" id="h3-3-3" class="d">-                Logger.debug(&quot;downloaded ${downloadedMedias.size} medias&quot;)
</a><a href="#h3-3-4" id="h3-3-4" class="i">+                remoteSideContext.log.verbose(&quot;downloaded ${downloadedMedias.size} medias&quot;)
</a> 
                 var shouldMergeOverlay = downloadRequest.shouldMergeOverlay
 
<a href="#h3-4" id="h3-4" class="h">@@ -376,7 +377,7 @@ class DownloadProcessor (
</a>                         saveMediaToGallery(mergedOverlay, downloadObjectObject)
                     }.onFailure { exception -&gt;
                         if (coroutineContext.job.isCancelled) return@onFailure
<a href="#h3-4-3" id="h3-4-3" class="d">-                        Logger.error(exception)
</a><a href="#h3-4-4" id="h3-4-4" class="i">+                        remoteSideContext.log.error(&quot;Failed to merge overlay&quot;, exception)
</a>                         callbackOnFailure(translation.format(&quot;failed_processing_toast&quot;, &quot;error&quot; to exception.toString()), exception.message)
                         downloadObjectObject.downloadStage = DownloadStage.MERGE_FAILED
                     }
<a href="#h3-5" id="h3-5" class="h">@@ -390,7 +391,7 @@ class DownloadProcessor (
</a>                 downloadRemoteMedia(downloadObjectObject, downloadedMedias, downloadRequest)
             }.onFailure { exception -&gt;
                 downloadObjectObject.downloadStage = DownloadStage.FAILED
<a href="#h3-5-3" id="h3-5-3" class="d">-                Logger.error(exception)
</a><a href="#h3-5-4" id="h3-5-4" class="i">+                remoteSideContext.log.error(&quot;Failed to download media&quot;, exception)
</a>                 callbackOnFailure(translation[&quot;failed_generic_toast&quot;], exception.message)
             }
         }
<b>diff --git a/<a id="h4" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/messaging/ModDatabase.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/messaging/ModDatabase.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/messaging/ModDatabase.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/messaging/ModDatabase.kt</a></b>
<a href="#h4-0" id="h4-0" class="h">@@ -1,13 +1,12 @@
</a> package me.rhunk.snapenhance.messaging
 
 import android.database.sqlite.SQLiteDatabase
<a href="#h4-0-3" id="h4-0-3" class="d">-import me.rhunk.snapenhance.Logger
</a> import me.rhunk.snapenhance.RemoteSideContext
<a href="#h4-0-5" id="h4-0-5" class="i">+import me.rhunk.snapenhance.core.database.objects.FriendInfo
</a> import me.rhunk.snapenhance.core.messaging.FriendStreaks
 import me.rhunk.snapenhance.core.messaging.MessagingFriendInfo
 import me.rhunk.snapenhance.core.messaging.MessagingGroupInfo
 import me.rhunk.snapenhance.core.messaging.MessagingRuleType
<a href="#h4-0-10" id="h4-0-10" class="d">-import me.rhunk.snapenhance.database.objects.FriendInfo
</a> import me.rhunk.snapenhance.util.SQLiteDatabaseHelper
 import me.rhunk.snapenhance.util.ktx.getInteger
 import me.rhunk.snapenhance.util.ktx.getLongOrNull
<a href="#h4-1" id="h4-1" class="h">@@ -28,7 +27,7 @@ class ModDatabase(
</a>             runCatching {
                 block()
             }.onFailure {
<a href="#h4-1-3" id="h4-1-3" class="d">-                Logger.error(&quot;Failed to execute async block&quot;, it)
</a><a href="#h4-1-4" id="h4-1-4" class="i">+                context.log.error(&quot;Failed to execute async block&quot;, it)
</a>             }
         }
     }
<a href="#h4-2" id="h4-2" class="h">@@ -103,7 +102,7 @@ class ModDatabase(
</a>                         selfieId = cursor.getStringOrNull(&quot;selfieId&quot;)
                     ))
                 }.onFailure {
<a href="#h4-2-3" id="h4-2-3" class="d">-                    Logger.error(&quot;Failed to parse friend&quot;, it)
</a><a href="#h4-2-4" id="h4-2-4" class="i">+                    context.log.error(&quot;Failed to parse friend&quot;, it)
</a>                 }
             }
             friends
<b>diff --git a/<a id="h5" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/Section.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/Section.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/Section.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/Section.kt</a></b>
<a href="#h5-0" id="h5-0" class="h">@@ -13,7 +13,7 @@ import androidx.navigation.NavController
</a> import androidx.navigation.NavGraphBuilder
 import androidx.navigation.compose.composable
 import me.rhunk.snapenhance.RemoteSideContext
<a href="#h5-0-3" id="h5-0-3" class="d">-import me.rhunk.snapenhance.ui.manager.sections.HomeSection
</a><a href="#h5-0-4" id="h5-0-4" class="i">+import me.rhunk.snapenhance.ui.manager.sections.home.HomeSection
</a> import me.rhunk.snapenhance.ui.manager.sections.NotImplemented
 import me.rhunk.snapenhance.ui.manager.sections.downloads.DownloadsSection
 import me.rhunk.snapenhance.ui.manager.sections.features.FeaturesSection
<a href="#h5-1" id="h5-1" class="h">@@ -64,6 +64,8 @@ open class Section {
</a>     lateinit var context: RemoteSideContext
     lateinit var navController: NavController
 
<a href="#h5-1-3" id="h5-1-3" class="i">+    val currentRoute get() = navController.currentBackStackEntry?.destination?.route
</a><a href="#h5-1-4" id="h5-1-4" class="i">+
</a>     open fun init() {}
     open fun onResumed() {}
 
<b>diff --git a/<a id="h6" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/data/InstallationSummary.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/data/InstallationSummary.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/data/InstallationSummary.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/data/InstallationSummary.kt</a></b>
<a href="#h6-0" id="h6-0" class="h">@@ -2,16 +2,33 @@ package me.rhunk.snapenhance.ui.manager.data
</a> 
 
 data class SnapchatAppInfo(
<a href="#h6-0-3" id="h6-0-3" class="i">+    val packageName: String,
</a>     val version: String,
<a href="#h6-0-5" id="h6-0-5" class="d">-    val versionCode: Long
</a><a href="#h6-0-6" id="h6-0-6" class="i">+    val versionCode: Long,
</a><a href="#h6-0-7" id="h6-0-7" class="i">+    val isLSPatched: Boolean,
</a><a href="#h6-0-8" id="h6-0-8" class="i">+    val isSplitApk: Boolean,
</a> )
 
<a href="#h6-0-11" id="h6-0-11" class="d">-data class ModMappingsInfo(
</a><a href="#h6-0-12" id="h6-0-12" class="d">-    val generatedSnapchatVersion: Long,
</a><a href="#h6-0-13" id="h6-0-13" class="d">-    val isOutdated: Boolean
</a><a href="#h6-0-14" id="h6-0-14" class="i">+data class ModInfo(
</a><a href="#h6-0-15" id="h6-0-15" class="i">+    val loaderPackageName: String,
</a><a href="#h6-0-16" id="h6-0-16" class="i">+    val buildPackageName: String,
</a><a href="#h6-0-17" id="h6-0-17" class="i">+    val buildVersion: String,
</a><a href="#h6-0-18" id="h6-0-18" class="i">+    val buildVersionCode: Long,
</a><a href="#h6-0-19" id="h6-0-19" class="i">+    val buildIssuer: String,
</a><a href="#h6-0-20" id="h6-0-20" class="i">+    val isDebugBuild: Boolean,
</a><a href="#h6-0-21" id="h6-0-21" class="i">+    val mappingVersion: Long?,
</a><a href="#h6-0-22" id="h6-0-22" class="i">+    val mappingsOutdated: Boolean?,
</a><a href="#h6-0-23" id="h6-0-23" class="i">+)
</a><a href="#h6-0-24" id="h6-0-24" class="i">+
</a><a href="#h6-0-25" id="h6-0-25" class="i">+data class PlatformInfo(
</a><a href="#h6-0-26" id="h6-0-26" class="i">+    val device: String,
</a><a href="#h6-0-27" id="h6-0-27" class="i">+    val buildFingerprint: String,
</a><a href="#h6-0-28" id="h6-0-28" class="i">+    val androidVersion: String,
</a><a href="#h6-0-29" id="h6-0-29" class="i">+    val systemAbi: String,
</a> )
 
 data class InstallationSummary(
<a href="#h6-0-33" id="h6-0-33" class="i">+    val platformInfo: PlatformInfo,
</a>     val snapchatInfo: SnapchatAppInfo?,
<a href="#h6-0-35" id="h6-0-35" class="d">-    val mappingsInfo: ModMappingsInfo?
</a><a href="#h6-0-36" id="h6-0-36" class="i">+    val modInfo: ModInfo?,
</a> )
<b>diff --git a/<a id="h7" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/HomeSection.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/HomeSection.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/HomeSection.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/HomeSection.kt</a></b>
<a href="#h7-0" id="h7-0" class="h">@@ -1,147 +0,0 @@
</a><a href="#h7-0-0" id="h7-0-0" class="d">-package me.rhunk.snapenhance.ui.manager.sections
</a><a href="#h7-0-1" id="h7-0-1" class="d">-
</a><a href="#h7-0-2" id="h7-0-2" class="d">-import androidx.compose.foundation.ScrollState
</a><a href="#h7-0-3" id="h7-0-3" class="d">-import androidx.compose.foundation.layout.Arrangement
</a><a href="#h7-0-4" id="h7-0-4" class="d">-import androidx.compose.foundation.layout.Column
</a><a href="#h7-0-5" id="h7-0-5" class="d">-import androidx.compose.foundation.layout.Row
</a><a href="#h7-0-6" id="h7-0-6" class="d">-import androidx.compose.foundation.layout.fillMaxSize
</a><a href="#h7-0-7" id="h7-0-7" class="d">-import androidx.compose.foundation.layout.fillMaxWidth
</a><a href="#h7-0-8" id="h7-0-8" class="d">-import androidx.compose.foundation.layout.height
</a><a href="#h7-0-9" id="h7-0-9" class="d">-import androidx.compose.foundation.layout.padding
</a><a href="#h7-0-10" id="h7-0-10" class="d">-import androidx.compose.foundation.verticalScroll
</a><a href="#h7-0-11" id="h7-0-11" class="d">-import androidx.compose.material.icons.Icons
</a><a href="#h7-0-12" id="h7-0-12" class="d">-import androidx.compose.material.icons.filled.Language
</a><a href="#h7-0-13" id="h7-0-13" class="d">-import androidx.compose.material.icons.filled.Map
</a><a href="#h7-0-14" id="h7-0-14" class="d">-import androidx.compose.material.icons.filled.OpenInNew
</a><a href="#h7-0-15" id="h7-0-15" class="d">-import androidx.compose.material.icons.filled.Refresh
</a><a href="#h7-0-16" id="h7-0-16" class="d">-import androidx.compose.material3.Button
</a><a href="#h7-0-17" id="h7-0-17" class="d">-import androidx.compose.material3.Icon
</a><a href="#h7-0-18" id="h7-0-18" class="d">-import androidx.compose.material3.OutlinedCard
</a><a href="#h7-0-19" id="h7-0-19" class="d">-import androidx.compose.material3.Text
</a><a href="#h7-0-20" id="h7-0-20" class="d">-import androidx.compose.runtime.Composable
</a><a href="#h7-0-21" id="h7-0-21" class="d">-import androidx.compose.runtime.mutableStateOf
</a><a href="#h7-0-22" id="h7-0-22" class="d">-import androidx.compose.ui.Alignment
</a><a href="#h7-0-23" id="h7-0-23" class="d">-import androidx.compose.ui.Modifier
</a><a href="#h7-0-24" id="h7-0-24" class="d">-import androidx.compose.ui.tooling.preview.Preview
</a><a href="#h7-0-25" id="h7-0-25" class="d">-import androidx.compose.ui.unit.dp
</a><a href="#h7-0-26" id="h7-0-26" class="d">-import me.rhunk.snapenhance.ui.manager.Section
</a><a href="#h7-0-27" id="h7-0-27" class="d">-import me.rhunk.snapenhance.ui.manager.data.InstallationSummary
</a><a href="#h7-0-28" id="h7-0-28" class="d">-import me.rhunk.snapenhance.ui.setup.Requirements
</a><a href="#h7-0-29" id="h7-0-29" class="d">-import java.util.Locale
</a><a href="#h7-0-30" id="h7-0-30" class="d">-
</a><a href="#h7-0-31" id="h7-0-31" class="d">-class HomeSection : Section() {
</a><a href="#h7-0-32" id="h7-0-32" class="d">-    companion object {
</a><a href="#h7-0-33" id="h7-0-33" class="d">-        val cardMargin = 10.dp
</a><a href="#h7-0-34" id="h7-0-34" class="d">-    }
</a><a href="#h7-0-35" id="h7-0-35" class="d">-    private val installationSummary = mutableStateOf(null as InstallationSummary?)
</a><a href="#h7-0-36" id="h7-0-36" class="d">-    private val userLocale = mutableStateOf(null as String?)
</a><a href="#h7-0-37" id="h7-0-37" class="d">-
</a><a href="#h7-0-38" id="h7-0-38" class="d">-    @Composable
</a><a href="#h7-0-39" id="h7-0-39" class="d">-    private fun SummaryCards(installationSummary: InstallationSummary) {
</a><a href="#h7-0-40" id="h7-0-40" class="d">-        //installation summary
</a><a href="#h7-0-41" id="h7-0-41" class="d">-        OutlinedCard(
</a><a href="#h7-0-42" id="h7-0-42" class="d">-            modifier = Modifier
</a><a href="#h7-0-43" id="h7-0-43" class="d">-                .padding(all = cardMargin)
</a><a href="#h7-0-44" id="h7-0-44" class="d">-                .fillMaxWidth()
</a><a href="#h7-0-45" id="h7-0-45" class="d">-        ) {
</a><a href="#h7-0-46" id="h7-0-46" class="d">-            Column(modifier = Modifier.padding(all = 16.dp)) {
</a><a href="#h7-0-47" id="h7-0-47" class="d">-                if (installationSummary.snapchatInfo != null) {
</a><a href="#h7-0-48" id="h7-0-48" class="d">-                    Text(&quot;Snapchat version: ${installationSummary.snapchatInfo.version}&quot;)
</a><a href="#h7-0-49" id="h7-0-49" class="d">-                    Text(&quot;Snapchat version code: ${installationSummary.snapchatInfo.versionCode}&quot;)
</a><a href="#h7-0-50" id="h7-0-50" class="d">-                } else {
</a><a href="#h7-0-51" id="h7-0-51" class="d">-                    Text(&quot;Snapchat not installed/detected&quot;)
</a><a href="#h7-0-52" id="h7-0-52" class="d">-                }
</a><a href="#h7-0-53" id="h7-0-53" class="d">-            }
</a><a href="#h7-0-54" id="h7-0-54" class="d">-        }
</a><a href="#h7-0-55" id="h7-0-55" class="d">-
</a><a href="#h7-0-56" id="h7-0-56" class="d">-        OutlinedCard(
</a><a href="#h7-0-57" id="h7-0-57" class="d">-            modifier = Modifier
</a><a href="#h7-0-58" id="h7-0-58" class="d">-                .padding(all = cardMargin)
</a><a href="#h7-0-59" id="h7-0-59" class="d">-                .fillMaxWidth()
</a><a href="#h7-0-60" id="h7-0-60" class="d">-        ) {
</a><a href="#h7-0-61" id="h7-0-61" class="d">-            Row(
</a><a href="#h7-0-62" id="h7-0-62" class="d">-                modifier = Modifier.padding(all = 16.dp),
</a><a href="#h7-0-63" id="h7-0-63" class="d">-                horizontalArrangement = Arrangement.SpaceBetween
</a><a href="#h7-0-64" id="h7-0-64" class="d">-            ) {
</a><a href="#h7-0-65" id="h7-0-65" class="d">-                Icon(
</a><a href="#h7-0-66" id="h7-0-66" class="d">-                    Icons.Filled.Map,
</a><a href="#h7-0-67" id="h7-0-67" class="d">-                    contentDescription = &quot;Mappings&quot;,
</a><a href="#h7-0-68" id="h7-0-68" class="d">-                    modifier = Modifier
</a><a href="#h7-0-69" id="h7-0-69" class="d">-                        .padding(end = 10.dp)
</a><a href="#h7-0-70" id="h7-0-70" class="d">-                        .align(Alignment.CenterVertically)
</a><a href="#h7-0-71" id="h7-0-71" class="d">-                )
</a><a href="#h7-0-72" id="h7-0-72" class="d">-
</a><a href="#h7-0-73" id="h7-0-73" class="d">-                Text(text = if (installationSummary.mappingsInfo == null || installationSummary.mappingsInfo.isOutdated) {
</a><a href="#h7-0-74" id="h7-0-74" class="d">-                    &quot;Mappings ${if (installationSummary.mappingsInfo == null) &quot;not generated&quot; else &quot;outdated&quot;}&quot;
</a><a href="#h7-0-75" id="h7-0-75" class="d">-                } else {
</a><a href="#h7-0-76" id="h7-0-76" class="d">-                    &quot;Mappings version ${installationSummary.mappingsInfo.generatedSnapchatVersion}&quot;
</a><a href="#h7-0-77" id="h7-0-77" class="d">-                }, modifier = Modifier
</a><a href="#h7-0-78" id="h7-0-78" class="d">-                    .weight(1f)
</a><a href="#h7-0-79" id="h7-0-79" class="d">-                    .align(Alignment.CenterVertically)
</a><a href="#h7-0-80" id="h7-0-80" class="d">-                )
</a><a href="#h7-0-81" id="h7-0-81" class="d">-
</a><a href="#h7-0-82" id="h7-0-82" class="d">-                //inline button
</a><a href="#h7-0-83" id="h7-0-83" class="d">-                Button(onClick = {
</a><a href="#h7-0-84" id="h7-0-84" class="d">-                     context.checkForRequirements(Requirements.MAPPINGS)
</a><a href="#h7-0-85" id="h7-0-85" class="d">-                }, modifier = Modifier.height(40.dp)) {
</a><a href="#h7-0-86" id="h7-0-86" class="d">-                    Icon(Icons.Filled.Refresh, contentDescription = &quot;Refresh&quot;)
</a><a href="#h7-0-87" id="h7-0-87" class="d">-                }
</a><a href="#h7-0-88" id="h7-0-88" class="d">-            }
</a><a href="#h7-0-89" id="h7-0-89" class="d">-        }
</a><a href="#h7-0-90" id="h7-0-90" class="d">-        OutlinedCard(
</a><a href="#h7-0-91" id="h7-0-91" class="d">-            modifier = Modifier
</a><a href="#h7-0-92" id="h7-0-92" class="d">-                .padding(all = cardMargin)
</a><a href="#h7-0-93" id="h7-0-93" class="d">-                .fillMaxWidth()
</a><a href="#h7-0-94" id="h7-0-94" class="d">-        ) {
</a><a href="#h7-0-95" id="h7-0-95" class="d">-            Row(
</a><a href="#h7-0-96" id="h7-0-96" class="d">-                modifier = Modifier.padding(all = 16.dp),
</a><a href="#h7-0-97" id="h7-0-97" class="d">-            ) {
</a><a href="#h7-0-98" id="h7-0-98" class="d">-                Icon(
</a><a href="#h7-0-99" id="h7-0-99" class="d">-                    Icons.Filled.Language,
</a><a href="#h7-0-100" id="h7-0-100" class="d">-                    contentDescription = &quot;Language&quot;,
</a><a href="#h7-0-101" id="h7-0-101" class="d">-                    modifier = Modifier
</a><a href="#h7-0-102" id="h7-0-102" class="d">-                        .padding(end = 10.dp)
</a><a href="#h7-0-103" id="h7-0-103" class="d">-                        .align(Alignment.CenterVertically)
</a><a href="#h7-0-104" id="h7-0-104" class="d">-                )
</a><a href="#h7-0-105" id="h7-0-105" class="d">-                Text(text = userLocale.value ?: &quot;Unknown&quot;, modifier = Modifier
</a><a href="#h7-0-106" id="h7-0-106" class="d">-                    .weight(1f)
</a><a href="#h7-0-107" id="h7-0-107" class="d">-                    .align(Alignment.CenterVertically)
</a><a href="#h7-0-108" id="h7-0-108" class="d">-                )
</a><a href="#h7-0-109" id="h7-0-109" class="d">-
</a><a href="#h7-0-110" id="h7-0-110" class="d">-                //inline button
</a><a href="#h7-0-111" id="h7-0-111" class="d">-                Button(onClick = {
</a><a href="#h7-0-112" id="h7-0-112" class="d">-                    context.checkForRequirements(Requirements.LANGUAGE)
</a><a href="#h7-0-113" id="h7-0-113" class="d">-                }, modifier = Modifier.height(40.dp)) {
</a><a href="#h7-0-114" id="h7-0-114" class="d">-                    Icon(Icons.Filled.OpenInNew, contentDescription = null)
</a><a href="#h7-0-115" id="h7-0-115" class="d">-                }
</a><a href="#h7-0-116" id="h7-0-116" class="d">-            }
</a><a href="#h7-0-117" id="h7-0-117" class="d">-        }
</a><a href="#h7-0-118" id="h7-0-118" class="d">-    }
</a><a href="#h7-0-119" id="h7-0-119" class="d">-
</a><a href="#h7-0-120" id="h7-0-120" class="d">-    override fun onResumed() {
</a><a href="#h7-0-121" id="h7-0-121" class="d">-        if (!context.mappings.isMappingsLoaded()) {
</a><a href="#h7-0-122" id="h7-0-122" class="d">-            context.mappings.init(context.androidContext)
</a><a href="#h7-0-123" id="h7-0-123" class="d">-        }
</a><a href="#h7-0-124" id="h7-0-124" class="d">-        installationSummary.value = context.getInstallationSummary()
</a><a href="#h7-0-125" id="h7-0-125" class="d">-        userLocale.value = context.translation.loadedLocale.getDisplayName(Locale.getDefault())
</a><a href="#h7-0-126" id="h7-0-126" class="d">-    }
</a><a href="#h7-0-127" id="h7-0-127" class="d">-
</a><a href="#h7-0-128" id="h7-0-128" class="d">-    override fun sectionTopBarName() = &quot;SnapEnhance&quot;
</a><a href="#h7-0-129" id="h7-0-129" class="d">-
</a><a href="#h7-0-130" id="h7-0-130" class="d">-    @Composable
</a><a href="#h7-0-131" id="h7-0-131" class="d">-    @Preview
</a><a href="#h7-0-132" id="h7-0-132" class="d">-    override fun Content() {
</a><a href="#h7-0-133" id="h7-0-133" class="d">-        Column(
</a><a href="#h7-0-134" id="h7-0-134" class="d">-            modifier = Modifier
</a><a href="#h7-0-135" id="h7-0-135" class="d">-                .fillMaxSize()
</a><a href="#h7-0-136" id="h7-0-136" class="d">-                .verticalScroll(ScrollState(0))
</a><a href="#h7-0-137" id="h7-0-137" class="d">-        ) {
</a><a href="#h7-0-138" id="h7-0-138" class="d">-            Text(
</a><a href="#h7-0-139" id="h7-0-139" class="d">-                text = &quot;Lorem ipsum dolor sit amet, consectetur adipiscing elit. Donec euismod, nisl eget ultricies ultrices, nunc nisl aliquam nunc, quis aliquam nisl nunc eu nisl. Donec euismod, nisl eget ultricies ultrices, nunc nisl aliquam nunc, quis aliquam nisl nunc eu nisl.&quot;,
</a><a href="#h7-0-140" id="h7-0-140" class="d">-                modifier = Modifier.padding(16.dp)
</a><a href="#h7-0-141" id="h7-0-141" class="d">-            )
</a><a href="#h7-0-142" id="h7-0-142" class="d">-
</a><a href="#h7-0-143" id="h7-0-143" class="d">-            SummaryCards(installationSummary = installationSummary.value ?: return)
</a><a href="#h7-0-144" id="h7-0-144" class="d">-        }
</a><a href="#h7-0-145" id="h7-0-145" class="d">-    }
</a><a href="#h7-0-146" id="h7-0-146" class="d">-}</a><a href="#h7-0-147" id="h7-0-147" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h8" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/downloads/DownloadsSection.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/downloads/DownloadsSection.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/downloads/DownloadsSection.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/downloads/DownloadsSection.kt</a></b>
<a href="#h8-0" id="h8-0" class="h">@@ -51,8 +51,8 @@ import androidx.compose.ui.unit.sp
</a> import coil.compose.rememberAsyncImagePainter
 import kotlinx.coroutines.launch
 import me.rhunk.snapenhance.data.FileType
<a href="#h8-0-3" id="h8-0-3" class="d">-import me.rhunk.snapenhance.download.data.DownloadObject
</a><a href="#h8-0-4" id="h8-0-4" class="d">-import me.rhunk.snapenhance.download.data.MediaFilter
</a><a href="#h8-0-5" id="h8-0-5" class="i">+import me.rhunk.snapenhance.core.download.data.DownloadObject
</a><a href="#h8-0-6" id="h8-0-6" class="i">+import me.rhunk.snapenhance.core.download.data.MediaFilter
</a> import me.rhunk.snapenhance.ui.manager.Section
 import me.rhunk.snapenhance.ui.util.BitmojiImage
 import me.rhunk.snapenhance.ui.util.ImageRequestHelper
<b>diff --git a/<a id="h9" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/features/FeaturesSection.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/features/FeaturesSection.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/features/FeaturesSection.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/features/FeaturesSection.kt</a></b>
<a href="#h9-0" id="h9-0" class="h">@@ -439,7 +439,7 @@ class FeaturesSection : Section() {
</a> 
         IconButton(onClick = {
             showSearchBar = showSearchBar.not()
<a href="#h9-0-3" id="h9-0-3" class="d">-            if (!showSearchBar &amp;&amp; navController.currentBackStackEntry?.destination?.route == SEARCH_FEATURE_ROUTE) {
</a><a href="#h9-0-4" id="h9-0-4" class="i">+            if (!showSearchBar &amp;&amp; currentRoute == SEARCH_FEATURE_ROUTE) {
</a>                 navController.navigate(MAIN_ROUTE)
             }
         }) {
<b>diff --git a/<a id="h10" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/home/HomeSection.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/home/HomeSection.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/home/HomeSection.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/home/HomeSection.kt</a></b>
<a href="#h10-0" id="h10-0" class="h">@@ -0,0 +1,312 @@
</a><a href="#h10-0-0" id="h10-0-0" class="i">+package me.rhunk.snapenhance.ui.manager.sections.home
</a><a href="#h10-0-1" id="h10-0-1" class="i">+
</a><a href="#h10-0-2" id="h10-0-2" class="i">+import android.net.Uri
</a><a href="#h10-0-3" id="h10-0-3" class="i">+import androidx.compose.foundation.Image
</a><a href="#h10-0-4" id="h10-0-4" class="i">+import androidx.compose.foundation.ScrollState
</a><a href="#h10-0-5" id="h10-0-5" class="i">+import androidx.compose.foundation.layout.Arrangement
</a><a href="#h10-0-6" id="h10-0-6" class="i">+import androidx.compose.foundation.layout.Column
</a><a href="#h10-0-7" id="h10-0-7" class="i">+import androidx.compose.foundation.layout.Row
</a><a href="#h10-0-8" id="h10-0-8" class="i">+import androidx.compose.foundation.layout.RowScope
</a><a href="#h10-0-9" id="h10-0-9" class="i">+import androidx.compose.foundation.layout.fillMaxWidth
</a><a href="#h10-0-10" id="h10-0-10" class="i">+import androidx.compose.foundation.layout.height
</a><a href="#h10-0-11" id="h10-0-11" class="i">+import androidx.compose.foundation.layout.padding
</a><a href="#h10-0-12" id="h10-0-12" class="i">+import androidx.compose.foundation.verticalScroll
</a><a href="#h10-0-13" id="h10-0-13" class="i">+import androidx.compose.material.icons.Icons
</a><a href="#h10-0-14" id="h10-0-14" class="i">+import androidx.compose.material.icons.filled.BugReport
</a><a href="#h10-0-15" id="h10-0-15" class="i">+import androidx.compose.material.icons.filled.Language
</a><a href="#h10-0-16" id="h10-0-16" class="i">+import androidx.compose.material.icons.filled.Map
</a><a href="#h10-0-17" id="h10-0-17" class="i">+import androidx.compose.material.icons.filled.MoreVert
</a><a href="#h10-0-18" id="h10-0-18" class="i">+import androidx.compose.material.icons.filled.OpenInNew
</a><a href="#h10-0-19" id="h10-0-19" class="i">+import androidx.compose.material.icons.filled.ReceiptLong
</a><a href="#h10-0-20" id="h10-0-20" class="i">+import androidx.compose.material.icons.filled.Refresh
</a><a href="#h10-0-21" id="h10-0-21" class="i">+import androidx.compose.material3.Button
</a><a href="#h10-0-22" id="h10-0-22" class="i">+import androidx.compose.material3.Card
</a><a href="#h10-0-23" id="h10-0-23" class="i">+import androidx.compose.material3.CardDefaults
</a><a href="#h10-0-24" id="h10-0-24" class="i">+import androidx.compose.material3.DropdownMenu
</a><a href="#h10-0-25" id="h10-0-25" class="i">+import androidx.compose.material3.DropdownMenuItem
</a><a href="#h10-0-26" id="h10-0-26" class="i">+import androidx.compose.material3.Icon
</a><a href="#h10-0-27" id="h10-0-27" class="i">+import androidx.compose.material3.IconButton
</a><a href="#h10-0-28" id="h10-0-28" class="i">+import androidx.compose.material3.MaterialTheme
</a><a href="#h10-0-29" id="h10-0-29" class="i">+import androidx.compose.material3.OutlinedCard
</a><a href="#h10-0-30" id="h10-0-30" class="i">+import androidx.compose.material3.Text
</a><a href="#h10-0-31" id="h10-0-31" class="i">+import androidx.compose.runtime.Composable
</a><a href="#h10-0-32" id="h10-0-32" class="i">+import androidx.compose.runtime.getValue
</a><a href="#h10-0-33" id="h10-0-33" class="i">+import androidx.compose.runtime.mutableStateOf
</a><a href="#h10-0-34" id="h10-0-34" class="i">+import androidx.compose.runtime.remember
</a><a href="#h10-0-35" id="h10-0-35" class="i">+import androidx.compose.runtime.setValue
</a><a href="#h10-0-36" id="h10-0-36" class="i">+import androidx.compose.ui.Alignment
</a><a href="#h10-0-37" id="h10-0-37" class="i">+import androidx.compose.ui.Modifier
</a><a href="#h10-0-38" id="h10-0-38" class="i">+import androidx.compose.ui.draw.scale
</a><a href="#h10-0-39" id="h10-0-39" class="i">+import androidx.compose.ui.graphics.ColorFilter
</a><a href="#h10-0-40" id="h10-0-40" class="i">+import androidx.compose.ui.graphics.vector.ImageVector
</a><a href="#h10-0-41" id="h10-0-41" class="i">+import androidx.compose.ui.layout.ContentScale
</a><a href="#h10-0-42" id="h10-0-42" class="i">+import androidx.compose.ui.res.painterResource
</a><a href="#h10-0-43" id="h10-0-43" class="i">+import androidx.compose.ui.text.font.FontWeight
</a><a href="#h10-0-44" id="h10-0-44" class="i">+import androidx.compose.ui.tooling.preview.Preview
</a><a href="#h10-0-45" id="h10-0-45" class="i">+import androidx.compose.ui.unit.dp
</a><a href="#h10-0-46" id="h10-0-46" class="i">+import androidx.compose.ui.unit.sp
</a><a href="#h10-0-47" id="h10-0-47" class="i">+import androidx.navigation.NavGraphBuilder
</a><a href="#h10-0-48" id="h10-0-48" class="i">+import androidx.navigation.compose.composable
</a><a href="#h10-0-49" id="h10-0-49" class="i">+import androidx.navigation.navigation
</a><a href="#h10-0-50" id="h10-0-50" class="i">+import me.rhunk.snapenhance.R
</a><a href="#h10-0-51" id="h10-0-51" class="i">+import me.rhunk.snapenhance.ui.manager.Section
</a><a href="#h10-0-52" id="h10-0-52" class="i">+import me.rhunk.snapenhance.ui.manager.data.InstallationSummary
</a><a href="#h10-0-53" id="h10-0-53" class="i">+import me.rhunk.snapenhance.ui.setup.Requirements
</a><a href="#h10-0-54" id="h10-0-54" class="i">+import me.rhunk.snapenhance.ui.util.ActivityLauncherHelper
</a><a href="#h10-0-55" id="h10-0-55" class="i">+import me.rhunk.snapenhance.ui.util.saveFile
</a><a href="#h10-0-56" id="h10-0-56" class="i">+import java.util.Locale
</a><a href="#h10-0-57" id="h10-0-57" class="i">+
</a><a href="#h10-0-58" id="h10-0-58" class="i">+class HomeSection : Section() {
</a><a href="#h10-0-59" id="h10-0-59" class="i">+    companion object {
</a><a href="#h10-0-60" id="h10-0-60" class="i">+        val cardMargin = 10.dp
</a><a href="#h10-0-61" id="h10-0-61" class="i">+        const val HOME_ROOT = &quot;home_root&quot;
</a><a href="#h10-0-62" id="h10-0-62" class="i">+        const val DEBUG_SECTION_ROUTE = &quot;home_debug&quot;
</a><a href="#h10-0-63" id="h10-0-63" class="i">+        const val LOGS_SECTION_ROUTE = &quot;home_logs&quot;
</a><a href="#h10-0-64" id="h10-0-64" class="i">+    }
</a><a href="#h10-0-65" id="h10-0-65" class="i">+
</a><a href="#h10-0-66" id="h10-0-66" class="i">+    private val installationSummary = mutableStateOf(null as InstallationSummary?)
</a><a href="#h10-0-67" id="h10-0-67" class="i">+    private val userLocale = mutableStateOf(null as String?)
</a><a href="#h10-0-68" id="h10-0-68" class="i">+    private val homeSubSection by lazy { HomeSubSection(context) }
</a><a href="#h10-0-69" id="h10-0-69" class="i">+    private lateinit var activityLauncherHelper: ActivityLauncherHelper
</a><a href="#h10-0-70" id="h10-0-70" class="i">+
</a><a href="#h10-0-71" id="h10-0-71" class="i">+    override fun init() {
</a><a href="#h10-0-72" id="h10-0-72" class="i">+        activityLauncherHelper = ActivityLauncherHelper(context.activity!!)
</a><a href="#h10-0-73" id="h10-0-73" class="i">+    }
</a><a href="#h10-0-74" id="h10-0-74" class="i">+
</a><a href="#h10-0-75" id="h10-0-75" class="i">+    @Composable
</a><a href="#h10-0-76" id="h10-0-76" class="i">+    private fun SummaryCardRow(icon: ImageVector? = null, title: String, action: @Composable () -&gt; Unit) {
</a><a href="#h10-0-77" id="h10-0-77" class="i">+        Row(
</a><a href="#h10-0-78" id="h10-0-78" class="i">+            modifier = Modifier.padding(all = 16.dp),
</a><a href="#h10-0-79" id="h10-0-79" class="i">+            horizontalArrangement = Arrangement.SpaceBetween
</a><a href="#h10-0-80" id="h10-0-80" class="i">+        ) {
</a><a href="#h10-0-81" id="h10-0-81" class="i">+            icon?.let {
</a><a href="#h10-0-82" id="h10-0-82" class="i">+                Icon(
</a><a href="#h10-0-83" id="h10-0-83" class="i">+                    imageVector = it,
</a><a href="#h10-0-84" id="h10-0-84" class="i">+                    contentDescription = null,
</a><a href="#h10-0-85" id="h10-0-85" class="i">+                    modifier = Modifier
</a><a href="#h10-0-86" id="h10-0-86" class="i">+                        .padding(end = 10.dp)
</a><a href="#h10-0-87" id="h10-0-87" class="i">+                        .align(Alignment.CenterVertically)
</a><a href="#h10-0-88" id="h10-0-88" class="i">+                )
</a><a href="#h10-0-89" id="h10-0-89" class="i">+            }
</a><a href="#h10-0-90" id="h10-0-90" class="i">+            Text(text = title, modifier = Modifier
</a><a href="#h10-0-91" id="h10-0-91" class="i">+                .weight(1f)
</a><a href="#h10-0-92" id="h10-0-92" class="i">+                .align(Alignment.CenterVertically)
</a><a href="#h10-0-93" id="h10-0-93" class="i">+            )
</a><a href="#h10-0-94" id="h10-0-94" class="i">+            Column {
</a><a href="#h10-0-95" id="h10-0-95" class="i">+                action()
</a><a href="#h10-0-96" id="h10-0-96" class="i">+            }
</a><a href="#h10-0-97" id="h10-0-97" class="i">+        }
</a><a href="#h10-0-98" id="h10-0-98" class="i">+    }
</a><a href="#h10-0-99" id="h10-0-99" class="i">+
</a><a href="#h10-0-100" id="h10-0-100" class="i">+    @Composable
</a><a href="#h10-0-101" id="h10-0-101" class="i">+    private fun SummaryCards(installationSummary: InstallationSummary) {
</a><a href="#h10-0-102" id="h10-0-102" class="i">+        OutlinedCard(
</a><a href="#h10-0-103" id="h10-0-103" class="i">+            modifier = Modifier
</a><a href="#h10-0-104" id="h10-0-104" class="i">+                .padding(all = cardMargin)
</a><a href="#h10-0-105" id="h10-0-105" class="i">+                .fillMaxWidth()
</a><a href="#h10-0-106" id="h10-0-106" class="i">+        ) {
</a><a href="#h10-0-107" id="h10-0-107" class="i">+            SummaryCardRow(
</a><a href="#h10-0-108" id="h10-0-108" class="i">+                icon = Icons.Filled.Map,
</a><a href="#h10-0-109" id="h10-0-109" class="i">+                title = if (installationSummary.modInfo == null || installationSummary.modInfo.mappingsOutdated == true) {
</a><a href="#h10-0-110" id="h10-0-110" class="i">+                    &quot;Mappings ${if (installationSummary.modInfo == null) &quot;not generated&quot; else &quot;outdated&quot;}&quot;
</a><a href="#h10-0-111" id="h10-0-111" class="i">+                } else {
</a><a href="#h10-0-112" id="h10-0-112" class="i">+                    &quot;Mappings version ${installationSummary.modInfo.mappingVersion}&quot;
</a><a href="#h10-0-113" id="h10-0-113" class="i">+                }
</a><a href="#h10-0-114" id="h10-0-114" class="i">+            ) {
</a><a href="#h10-0-115" id="h10-0-115" class="i">+                Button(onClick = {
</a><a href="#h10-0-116" id="h10-0-116" class="i">+                    context.checkForRequirements(Requirements.MAPPINGS)
</a><a href="#h10-0-117" id="h10-0-117" class="i">+                }, modifier = Modifier.height(40.dp)) {
</a><a href="#h10-0-118" id="h10-0-118" class="i">+                    Icon(Icons.Filled.Refresh, contentDescription = null)
</a><a href="#h10-0-119" id="h10-0-119" class="i">+                }
</a><a href="#h10-0-120" id="h10-0-120" class="i">+            }
</a><a href="#h10-0-121" id="h10-0-121" class="i">+
</a><a href="#h10-0-122" id="h10-0-122" class="i">+            SummaryCardRow(icon = Icons.Filled.Language, title = userLocale.value ?: &quot;Unknown&quot;) {
</a><a href="#h10-0-123" id="h10-0-123" class="i">+                Button(onClick = {
</a><a href="#h10-0-124" id="h10-0-124" class="i">+                    context.checkForRequirements(Requirements.LANGUAGE)
</a><a href="#h10-0-125" id="h10-0-125" class="i">+                }, modifier = Modifier.height(40.dp)) {
</a><a href="#h10-0-126" id="h10-0-126" class="i">+                    Icon(Icons.Filled.OpenInNew, contentDescription = null)
</a><a href="#h10-0-127" id="h10-0-127" class="i">+                }
</a><a href="#h10-0-128" id="h10-0-128" class="i">+            }
</a><a href="#h10-0-129" id="h10-0-129" class="i">+        }
</a><a href="#h10-0-130" id="h10-0-130" class="i">+
</a><a href="#h10-0-131" id="h10-0-131" class="i">+        val summaryInfo = remember {
</a><a href="#h10-0-132" id="h10-0-132" class="i">+            mapOf(
</a><a href="#h10-0-133" id="h10-0-133" class="i">+                &quot;Build Issuer&quot; to (installationSummary.modInfo?.buildIssuer ?: &quot;Unknown&quot;),
</a><a href="#h10-0-134" id="h10-0-134" class="i">+                &quot;Device&quot; to installationSummary.platformInfo.device,
</a><a href="#h10-0-135" id="h10-0-135" class="i">+                &quot;Android version&quot; to installationSummary.platformInfo.androidVersion,
</a><a href="#h10-0-136" id="h10-0-136" class="i">+                &quot;System ABI&quot; to installationSummary.platformInfo.systemAbi,
</a><a href="#h10-0-137" id="h10-0-137" class="i">+                &quot;Build fingerprint&quot; to installationSummary.platformInfo.buildFingerprint
</a><a href="#h10-0-138" id="h10-0-138" class="i">+            )
</a><a href="#h10-0-139" id="h10-0-139" class="i">+        }
</a><a href="#h10-0-140" id="h10-0-140" class="i">+
</a><a href="#h10-0-141" id="h10-0-141" class="i">+        Card(
</a><a href="#h10-0-142" id="h10-0-142" class="i">+            modifier = Modifier
</a><a href="#h10-0-143" id="h10-0-143" class="i">+                .padding(all = cardMargin)
</a><a href="#h10-0-144" id="h10-0-144" class="i">+                .fillMaxWidth(),
</a><a href="#h10-0-145" id="h10-0-145" class="i">+            colors = CardDefaults.cardColors(
</a><a href="#h10-0-146" id="h10-0-146" class="i">+                containerColor = MaterialTheme.colorScheme.surfaceVariant,
</a><a href="#h10-0-147" id="h10-0-147" class="i">+                contentColor = MaterialTheme.colorScheme.onSurfaceVariant
</a><a href="#h10-0-148" id="h10-0-148" class="i">+            )
</a><a href="#h10-0-149" id="h10-0-149" class="i">+        ) {
</a><a href="#h10-0-150" id="h10-0-150" class="i">+            Column(
</a><a href="#h10-0-151" id="h10-0-151" class="i">+                modifier = Modifier
</a><a href="#h10-0-152" id="h10-0-152" class="i">+                    .fillMaxWidth()
</a><a href="#h10-0-153" id="h10-0-153" class="i">+                    .padding(all = 10.dp),
</a><a href="#h10-0-154" id="h10-0-154" class="i">+            ) {
</a><a href="#h10-0-155" id="h10-0-155" class="i">+                summaryInfo.forEach { (title, value) -&gt;
</a><a href="#h10-0-156" id="h10-0-156" class="i">+                    Column(
</a><a href="#h10-0-157" id="h10-0-157" class="i">+                        modifier = Modifier
</a><a href="#h10-0-158" id="h10-0-158" class="i">+                            .fillMaxWidth()
</a><a href="#h10-0-159" id="h10-0-159" class="i">+                            .padding(all = 5.dp),
</a><a href="#h10-0-160" id="h10-0-160" class="i">+                    ) {
</a><a href="#h10-0-161" id="h10-0-161" class="i">+                        Text(
</a><a href="#h10-0-162" id="h10-0-162" class="i">+                            text = title,
</a><a href="#h10-0-163" id="h10-0-163" class="i">+                            fontSize = 12.sp,
</a><a href="#h10-0-164" id="h10-0-164" class="i">+                            fontWeight = FontWeight.Light,
</a><a href="#h10-0-165" id="h10-0-165" class="i">+                        )
</a><a href="#h10-0-166" id="h10-0-166" class="i">+                        Text(
</a><a href="#h10-0-167" id="h10-0-167" class="i">+                            fontSize = 14.sp,
</a><a href="#h10-0-168" id="h10-0-168" class="i">+                            text = value,
</a><a href="#h10-0-169" id="h10-0-169" class="i">+                            lineHeight = 20.sp
</a><a href="#h10-0-170" id="h10-0-170" class="i">+                        )
</a><a href="#h10-0-171" id="h10-0-171" class="i">+                    }
</a><a href="#h10-0-172" id="h10-0-172" class="i">+                }
</a><a href="#h10-0-173" id="h10-0-173" class="i">+            }
</a><a href="#h10-0-174" id="h10-0-174" class="i">+
</a><a href="#h10-0-175" id="h10-0-175" class="i">+        }
</a><a href="#h10-0-176" id="h10-0-176" class="i">+    }
</a><a href="#h10-0-177" id="h10-0-177" class="i">+
</a><a href="#h10-0-178" id="h10-0-178" class="i">+    override fun onResumed() {
</a><a href="#h10-0-179" id="h10-0-179" class="i">+        if (!context.mappings.isMappingsLoaded()) {
</a><a href="#h10-0-180" id="h10-0-180" class="i">+            context.mappings.init(context.androidContext)
</a><a href="#h10-0-181" id="h10-0-181" class="i">+        }
</a><a href="#h10-0-182" id="h10-0-182" class="i">+        installationSummary.value = context.installationSummary
</a><a href="#h10-0-183" id="h10-0-183" class="i">+        userLocale.value = context.translation.loadedLocale.getDisplayName(Locale.getDefault())
</a><a href="#h10-0-184" id="h10-0-184" class="i">+    }
</a><a href="#h10-0-185" id="h10-0-185" class="i">+
</a><a href="#h10-0-186" id="h10-0-186" class="i">+    override fun sectionTopBarName(): String {
</a><a href="#h10-0-187" id="h10-0-187" class="i">+        if (currentRoute == HOME_ROOT) {
</a><a href="#h10-0-188" id="h10-0-188" class="i">+            return &quot;&quot;
</a><a href="#h10-0-189" id="h10-0-189" class="i">+        }
</a><a href="#h10-0-190" id="h10-0-190" class="i">+        return context.translation[&quot;manager.routes.$currentRoute&quot;]
</a><a href="#h10-0-191" id="h10-0-191" class="i">+    }
</a><a href="#h10-0-192" id="h10-0-192" class="i">+
</a><a href="#h10-0-193" id="h10-0-193" class="i">+    @Composable
</a><a href="#h10-0-194" id="h10-0-194" class="i">+    override fun FloatingActionButton() {
</a><a href="#h10-0-195" id="h10-0-195" class="i">+        if (currentRoute == LOGS_SECTION_ROUTE) {
</a><a href="#h10-0-196" id="h10-0-196" class="i">+            homeSubSection.LogsActionButtons()
</a><a href="#h10-0-197" id="h10-0-197" class="i">+        }
</a><a href="#h10-0-198" id="h10-0-198" class="i">+    }
</a><a href="#h10-0-199" id="h10-0-199" class="i">+
</a><a href="#h10-0-200" id="h10-0-200" class="i">+    @Composable
</a><a href="#h10-0-201" id="h10-0-201" class="i">+    override fun TopBarActions(rowScope: RowScope) {
</a><a href="#h10-0-202" id="h10-0-202" class="i">+        rowScope.apply {
</a><a href="#h10-0-203" id="h10-0-203" class="i">+            when (currentRoute) {
</a><a href="#h10-0-204" id="h10-0-204" class="i">+                HOME_ROOT -&gt; {
</a><a href="#h10-0-205" id="h10-0-205" class="i">+                    IconButton(onClick = {
</a><a href="#h10-0-206" id="h10-0-206" class="i">+                        navController.navigate(LOGS_SECTION_ROUTE)
</a><a href="#h10-0-207" id="h10-0-207" class="i">+                    }) {
</a><a href="#h10-0-208" id="h10-0-208" class="i">+                        Icon(Icons.Filled.ReceiptLong, contentDescription = null)
</a><a href="#h10-0-209" id="h10-0-209" class="i">+                    }
</a><a href="#h10-0-210" id="h10-0-210" class="i">+                    IconButton(onClick = {
</a><a href="#h10-0-211" id="h10-0-211" class="i">+                        navController.navigate(DEBUG_SECTION_ROUTE)
</a><a href="#h10-0-212" id="h10-0-212" class="i">+                    }) {
</a><a href="#h10-0-213" id="h10-0-213" class="i">+                        Icon(Icons.Filled.BugReport, contentDescription = null)
</a><a href="#h10-0-214" id="h10-0-214" class="i">+                    }
</a><a href="#h10-0-215" id="h10-0-215" class="i">+                }
</a><a href="#h10-0-216" id="h10-0-216" class="i">+                LOGS_SECTION_ROUTE -&gt; {
</a><a href="#h10-0-217" id="h10-0-217" class="i">+                    var showDropDown by remember { mutableStateOf(false) }
</a><a href="#h10-0-218" id="h10-0-218" class="i">+
</a><a href="#h10-0-219" id="h10-0-219" class="i">+                    IconButton(onClick = {
</a><a href="#h10-0-220" id="h10-0-220" class="i">+                        showDropDown = true
</a><a href="#h10-0-221" id="h10-0-221" class="i">+                    }) {
</a><a href="#h10-0-222" id="h10-0-222" class="i">+                        Icon(Icons.Filled.MoreVert, contentDescription = null)
</a><a href="#h10-0-223" id="h10-0-223" class="i">+                    }
</a><a href="#h10-0-224" id="h10-0-224" class="i">+
</a><a href="#h10-0-225" id="h10-0-225" class="i">+                    DropdownMenu(
</a><a href="#h10-0-226" id="h10-0-226" class="i">+                        expanded = showDropDown,
</a><a href="#h10-0-227" id="h10-0-227" class="i">+                        onDismissRequest = { showDropDown = false },
</a><a href="#h10-0-228" id="h10-0-228" class="i">+                        modifier = Modifier.align(Alignment.CenterVertically)
</a><a href="#h10-0-229" id="h10-0-229" class="i">+                    ) {
</a><a href="#h10-0-230" id="h10-0-230" class="i">+                        DropdownMenuItem(onClick = {
</a><a href="#h10-0-231" id="h10-0-231" class="i">+                            context.log.clearLogs()
</a><a href="#h10-0-232" id="h10-0-232" class="i">+                            navController.navigate(LOGS_SECTION_ROUTE)
</a><a href="#h10-0-233" id="h10-0-233" class="i">+                            showDropDown = false
</a><a href="#h10-0-234" id="h10-0-234" class="i">+                        }, text = {
</a><a href="#h10-0-235" id="h10-0-235" class="i">+                            Text(text = &quot;Clear logs&quot;)
</a><a href="#h10-0-236" id="h10-0-236" class="i">+                        })
</a><a href="#h10-0-237" id="h10-0-237" class="i">+
</a><a href="#h10-0-238" id="h10-0-238" class="i">+                        DropdownMenuItem(onClick = {
</a><a href="#h10-0-239" id="h10-0-239" class="i">+                            val logFile = context.log.getLogFile()
</a><a href="#h10-0-240" id="h10-0-240" class="i">+                            activityLauncherHelper.saveFile(logFile.name, &quot;text/plain&quot;) { uri -&gt;
</a><a href="#h10-0-241" id="h10-0-241" class="i">+                                context.androidContext.contentResolver.openOutputStream(Uri.parse(uri))?.use {
</a><a href="#h10-0-242" id="h10-0-242" class="i">+                                    logFile.inputStream().copyTo(it)
</a><a href="#h10-0-243" id="h10-0-243" class="i">+                                    context.longToast(&quot;Saved logs to $uri&quot;)
</a><a href="#h10-0-244" id="h10-0-244" class="i">+                                }
</a><a href="#h10-0-245" id="h10-0-245" class="i">+                            }
</a><a href="#h10-0-246" id="h10-0-246" class="i">+                            showDropDown = false
</a><a href="#h10-0-247" id="h10-0-247" class="i">+                        }, text = {
</a><a href="#h10-0-248" id="h10-0-248" class="i">+                            Text(text = &quot;Export logs&quot;)
</a><a href="#h10-0-249" id="h10-0-249" class="i">+                        })
</a><a href="#h10-0-250" id="h10-0-250" class="i">+                    }
</a><a href="#h10-0-251" id="h10-0-251" class="i">+                }
</a><a href="#h10-0-252" id="h10-0-252" class="i">+            }
</a><a href="#h10-0-253" id="h10-0-253" class="i">+        }
</a><a href="#h10-0-254" id="h10-0-254" class="i">+    }
</a><a href="#h10-0-255" id="h10-0-255" class="i">+
</a><a href="#h10-0-256" id="h10-0-256" class="i">+    override fun build(navGraphBuilder: NavGraphBuilder) {
</a><a href="#h10-0-257" id="h10-0-257" class="i">+        navGraphBuilder.navigation(
</a><a href="#h10-0-258" id="h10-0-258" class="i">+            route = enumSection.route,
</a><a href="#h10-0-259" id="h10-0-259" class="i">+            startDestination = HOME_ROOT
</a><a href="#h10-0-260" id="h10-0-260" class="i">+        ) {
</a><a href="#h10-0-261" id="h10-0-261" class="i">+            composable(HOME_ROOT) {
</a><a href="#h10-0-262" id="h10-0-262" class="i">+                Content()
</a><a href="#h10-0-263" id="h10-0-263" class="i">+            }
</a><a href="#h10-0-264" id="h10-0-264" class="i">+            composable(LOGS_SECTION_ROUTE) {
</a><a href="#h10-0-265" id="h10-0-265" class="i">+                homeSubSection.LogsSection()
</a><a href="#h10-0-266" id="h10-0-266" class="i">+            }
</a><a href="#h10-0-267" id="h10-0-267" class="i">+            composable(DEBUG_SECTION_ROUTE) {
</a><a href="#h10-0-268" id="h10-0-268" class="i">+                homeSubSection.DebugSection()
</a><a href="#h10-0-269" id="h10-0-269" class="i">+            }
</a><a href="#h10-0-270" id="h10-0-270" class="i">+        }
</a><a href="#h10-0-271" id="h10-0-271" class="i">+    }
</a><a href="#h10-0-272" id="h10-0-272" class="i">+
</a><a href="#h10-0-273" id="h10-0-273" class="i">+
</a><a href="#h10-0-274" id="h10-0-274" class="i">+    @Composable
</a><a href="#h10-0-275" id="h10-0-275" class="i">+    @Preview
</a><a href="#h10-0-276" id="h10-0-276" class="i">+    override fun Content() {
</a><a href="#h10-0-277" id="h10-0-277" class="i">+        Column(
</a><a href="#h10-0-278" id="h10-0-278" class="i">+            modifier = Modifier
</a><a href="#h10-0-279" id="h10-0-279" class="i">+                .verticalScroll(ScrollState(0))
</a><a href="#h10-0-280" id="h10-0-280" class="i">+        ) {
</a><a href="#h10-0-281" id="h10-0-281" class="i">+            Column(
</a><a href="#h10-0-282" id="h10-0-282" class="i">+                modifier = Modifier
</a><a href="#h10-0-283" id="h10-0-283" class="i">+                    .fillMaxWidth(),
</a><a href="#h10-0-284" id="h10-0-284" class="i">+                horizontalAlignment = Alignment.CenterHorizontally
</a><a href="#h10-0-285" id="h10-0-285" class="i">+            ) {
</a><a href="#h10-0-286" id="h10-0-286" class="i">+                Image(
</a><a href="#h10-0-287" id="h10-0-287" class="i">+                    painter = painterResource(id = R.drawable.launcher_icon_monochrome),
</a><a href="#h10-0-288" id="h10-0-288" class="i">+                    contentDescription = null,
</a><a href="#h10-0-289" id="h10-0-289" class="i">+                    colorFilter = ColorFilter.tint(MaterialTheme.colorScheme.primary),
</a><a href="#h10-0-290" id="h10-0-290" class="i">+                    contentScale = ContentScale.FillHeight,
</a><a href="#h10-0-291" id="h10-0-291" class="i">+                    modifier = Modifier
</a><a href="#h10-0-292" id="h10-0-292" class="i">+                        .height(120.dp)
</a><a href="#h10-0-293" id="h10-0-293" class="i">+                        .scale(1.75f)
</a><a href="#h10-0-294" id="h10-0-294" class="i">+                )
</a><a href="#h10-0-295" id="h10-0-295" class="i">+                Text(
</a><a href="#h10-0-296" id="h10-0-296" class="i">+                    text = (&quot;\u0065&quot; + &quot;\u0063&quot; + &quot;\u006e&quot; + &quot;\u0061&quot; + &quot;\u0068&quot; + &quot;\u006e&quot; + &quot;\u0045&quot; + &quot;\u0070&quot; + &quot;\u0061&quot; + &quot;\u006e&quot; + &quot;\u0053&quot;).reversed(),
</a><a href="#h10-0-297" id="h10-0-297" class="i">+                    fontSize = 30.sp,
</a><a href="#h10-0-298" id="h10-0-298" class="i">+                    modifier = Modifier.padding(16.dp),
</a><a href="#h10-0-299" id="h10-0-299" class="i">+                )
</a><a href="#h10-0-300" id="h10-0-300" class="i">+            }
</a><a href="#h10-0-301" id="h10-0-301" class="i">+
</a><a href="#h10-0-302" id="h10-0-302" class="i">+
</a><a href="#h10-0-303" id="h10-0-303" class="i">+            Text(
</a><a href="#h10-0-304" id="h10-0-304" class="i">+                text = &quot;An xposed module that enhances the Snapchat experience&quot;,
</a><a href="#h10-0-305" id="h10-0-305" class="i">+                modifier = Modifier.padding(16.dp)
</a><a href="#h10-0-306" id="h10-0-306" class="i">+            )
</a><a href="#h10-0-307" id="h10-0-307" class="i">+
</a><a href="#h10-0-308" id="h10-0-308" class="i">+            SummaryCards(installationSummary = installationSummary.value ?: return)
</a><a href="#h10-0-309" id="h10-0-309" class="i">+        }
</a><a href="#h10-0-310" id="h10-0-310" class="i">+    }
</a><a href="#h10-0-311" id="h10-0-311" class="i">+}</a><a href="#h10-0-312" id="h10-0-312" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h11" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/home/HomeSubSection.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/home/HomeSubSection.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/home/HomeSubSection.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/home/HomeSubSection.kt</a></b>
<a href="#h11-0" id="h11-0" class="h">@@ -0,0 +1,214 @@
</a><a href="#h11-0-0" id="h11-0-0" class="i">+package me.rhunk.snapenhance.ui.manager.sections.home
</a><a href="#h11-0-1" id="h11-0-1" class="i">+
</a><a href="#h11-0-2" id="h11-0-2" class="i">+import androidx.compose.foundation.ScrollState
</a><a href="#h11-0-3" id="h11-0-3" class="i">+import androidx.compose.foundation.background
</a><a href="#h11-0-4" id="h11-0-4" class="i">+import androidx.compose.foundation.clickable
</a><a href="#h11-0-5" id="h11-0-5" class="i">+import androidx.compose.foundation.layout.Arrangement
</a><a href="#h11-0-6" id="h11-0-6" class="i">+import androidx.compose.foundation.layout.Box
</a><a href="#h11-0-7" id="h11-0-7" class="i">+import androidx.compose.foundation.layout.Column
</a><a href="#h11-0-8" id="h11-0-8" class="i">+import androidx.compose.foundation.layout.Row
</a><a href="#h11-0-9" id="h11-0-9" class="i">+import androidx.compose.foundation.layout.fillMaxSize
</a><a href="#h11-0-10" id="h11-0-10" class="i">+import androidx.compose.foundation.layout.fillMaxWidth
</a><a href="#h11-0-11" id="h11-0-11" class="i">+import androidx.compose.foundation.layout.height
</a><a href="#h11-0-12" id="h11-0-12" class="i">+import androidx.compose.foundation.layout.padding
</a><a href="#h11-0-13" id="h11-0-13" class="i">+import androidx.compose.foundation.layout.size
</a><a href="#h11-0-14" id="h11-0-14" class="i">+import androidx.compose.foundation.lazy.LazyColumn
</a><a href="#h11-0-15" id="h11-0-15" class="i">+import androidx.compose.foundation.lazy.LazyListState
</a><a href="#h11-0-16" id="h11-0-16" class="i">+import androidx.compose.foundation.verticalScroll
</a><a href="#h11-0-17" id="h11-0-17" class="i">+import androidx.compose.material.icons.Icons
</a><a href="#h11-0-18" id="h11-0-18" class="i">+import androidx.compose.material.icons.filled.KeyboardDoubleArrowDown
</a><a href="#h11-0-19" id="h11-0-19" class="i">+import androidx.compose.material.icons.filled.KeyboardDoubleArrowUp
</a><a href="#h11-0-20" id="h11-0-20" class="i">+import androidx.compose.material.icons.filled.OpenInNew
</a><a href="#h11-0-21" id="h11-0-21" class="i">+import androidx.compose.material3.CircularProgressIndicator
</a><a href="#h11-0-22" id="h11-0-22" class="i">+import androidx.compose.material3.FilledIconButton
</a><a href="#h11-0-23" id="h11-0-23" class="i">+import androidx.compose.material3.FloatingActionButton
</a><a href="#h11-0-24" id="h11-0-24" class="i">+import androidx.compose.material3.Icon
</a><a href="#h11-0-25" id="h11-0-25" class="i">+import androidx.compose.material3.IconButton
</a><a href="#h11-0-26" id="h11-0-26" class="i">+import androidx.compose.material3.MaterialTheme
</a><a href="#h11-0-27" id="h11-0-27" class="i">+import androidx.compose.material3.Text
</a><a href="#h11-0-28" id="h11-0-28" class="i">+import androidx.compose.runtime.Composable
</a><a href="#h11-0-29" id="h11-0-29" class="i">+import androidx.compose.runtime.LaunchedEffect
</a><a href="#h11-0-30" id="h11-0-30" class="i">+import androidx.compose.runtime.getValue
</a><a href="#h11-0-31" id="h11-0-31" class="i">+import androidx.compose.runtime.mutableIntStateOf
</a><a href="#h11-0-32" id="h11-0-32" class="i">+import androidx.compose.runtime.mutableStateOf
</a><a href="#h11-0-33" id="h11-0-33" class="i">+import androidx.compose.runtime.remember
</a><a href="#h11-0-34" id="h11-0-34" class="i">+import androidx.compose.runtime.rememberCoroutineScope
</a><a href="#h11-0-35" id="h11-0-35" class="i">+import androidx.compose.runtime.setValue
</a><a href="#h11-0-36" id="h11-0-36" class="i">+import androidx.compose.ui.Alignment
</a><a href="#h11-0-37" id="h11-0-37" class="i">+import androidx.compose.ui.Modifier
</a><a href="#h11-0-38" id="h11-0-38" class="i">+import androidx.compose.ui.text.font.FontWeight
</a><a href="#h11-0-39" id="h11-0-39" class="i">+import androidx.compose.ui.unit.dp
</a><a href="#h11-0-40" id="h11-0-40" class="i">+import androidx.compose.ui.unit.sp
</a><a href="#h11-0-41" id="h11-0-41" class="i">+import androidx.compose.ui.window.Dialog
</a><a href="#h11-0-42" id="h11-0-42" class="i">+import kotlinx.coroutines.Dispatchers
</a><a href="#h11-0-43" id="h11-0-43" class="i">+import kotlinx.coroutines.launch
</a><a href="#h11-0-44" id="h11-0-44" class="i">+import me.rhunk.snapenhance.Constants
</a><a href="#h11-0-45" id="h11-0-45" class="i">+import me.rhunk.snapenhance.LogReader
</a><a href="#h11-0-46" id="h11-0-46" class="i">+import me.rhunk.snapenhance.RemoteSideContext
</a><a href="#h11-0-47" id="h11-0-47" class="i">+import me.rhunk.snapenhance.action.EnumAction
</a><a href="#h11-0-48" id="h11-0-48" class="i">+import me.rhunk.snapenhance.core.bridge.types.BridgeFileType
</a><a href="#h11-0-49" id="h11-0-49" class="i">+import me.rhunk.snapenhance.manager.impl.ActionManager
</a><a href="#h11-0-50" id="h11-0-50" class="i">+import me.rhunk.snapenhance.ui.util.AlertDialogs
</a><a href="#h11-0-51" id="h11-0-51" class="i">+
</a><a href="#h11-0-52" id="h11-0-52" class="i">+class HomeSubSection(
</a><a href="#h11-0-53" id="h11-0-53" class="i">+    private val context: RemoteSideContext
</a><a href="#h11-0-54" id="h11-0-54" class="i">+) {
</a><a href="#h11-0-55" id="h11-0-55" class="i">+    private val dialogs by lazy { AlertDialogs(context.translation) }
</a><a href="#h11-0-56" id="h11-0-56" class="i">+
</a><a href="#h11-0-57" id="h11-0-57" class="i">+    private lateinit var logListState: LazyListState
</a><a href="#h11-0-58" id="h11-0-58" class="i">+
</a><a href="#h11-0-59" id="h11-0-59" class="i">+    @Composable
</a><a href="#h11-0-60" id="h11-0-60" class="i">+    private fun RowAction(title: String, requireConfirmation: Boolean = false, action: () -&gt; Unit) {
</a><a href="#h11-0-61" id="h11-0-61" class="i">+        var confirmationDialog by remember {
</a><a href="#h11-0-62" id="h11-0-62" class="i">+            mutableStateOf(false)
</a><a href="#h11-0-63" id="h11-0-63" class="i">+        }
</a><a href="#h11-0-64" id="h11-0-64" class="i">+
</a><a href="#h11-0-65" id="h11-0-65" class="i">+        fun takeAction() {
</a><a href="#h11-0-66" id="h11-0-66" class="i">+            if (requireConfirmation) {
</a><a href="#h11-0-67" id="h11-0-67" class="i">+                confirmationDialog = true
</a><a href="#h11-0-68" id="h11-0-68" class="i">+            } else {
</a><a href="#h11-0-69" id="h11-0-69" class="i">+                action()
</a><a href="#h11-0-70" id="h11-0-70" class="i">+            }
</a><a href="#h11-0-71" id="h11-0-71" class="i">+        }
</a><a href="#h11-0-72" id="h11-0-72" class="i">+
</a><a href="#h11-0-73" id="h11-0-73" class="i">+        if (requireConfirmation &amp;&amp; confirmationDialog) {
</a><a href="#h11-0-74" id="h11-0-74" class="i">+            Dialog(onDismissRequest = { confirmationDialog = false }) {
</a><a href="#h11-0-75" id="h11-0-75" class="i">+                dialogs.ConfirmDialog(title = &quot;Are you sure?&quot;, onConfirm = {
</a><a href="#h11-0-76" id="h11-0-76" class="i">+                    action()
</a><a href="#h11-0-77" id="h11-0-77" class="i">+                    confirmationDialog = false
</a><a href="#h11-0-78" id="h11-0-78" class="i">+                }, onDismiss = {
</a><a href="#h11-0-79" id="h11-0-79" class="i">+                    confirmationDialog = false
</a><a href="#h11-0-80" id="h11-0-80" class="i">+                })
</a><a href="#h11-0-81" id="h11-0-81" class="i">+            }
</a><a href="#h11-0-82" id="h11-0-82" class="i">+        }
</a><a href="#h11-0-83" id="h11-0-83" class="i">+
</a><a href="#h11-0-84" id="h11-0-84" class="i">+        Row(
</a><a href="#h11-0-85" id="h11-0-85" class="i">+            modifier = Modifier
</a><a href="#h11-0-86" id="h11-0-86" class="i">+                .fillMaxWidth()
</a><a href="#h11-0-87" id="h11-0-87" class="i">+                .height(65.dp)
</a><a href="#h11-0-88" id="h11-0-88" class="i">+                .clickable {
</a><a href="#h11-0-89" id="h11-0-89" class="i">+                    takeAction()
</a><a href="#h11-0-90" id="h11-0-90" class="i">+                },
</a><a href="#h11-0-91" id="h11-0-91" class="i">+            horizontalArrangement = Arrangement.SpaceBetween,
</a><a href="#h11-0-92" id="h11-0-92" class="i">+            verticalAlignment = Alignment.CenterVertically
</a><a href="#h11-0-93" id="h11-0-93" class="i">+        ) {
</a><a href="#h11-0-94" id="h11-0-94" class="i">+            Text(text = title, modifier = Modifier.padding(start = 26.dp))
</a><a href="#h11-0-95" id="h11-0-95" class="i">+            IconButton(onClick = { takeAction() }) {
</a><a href="#h11-0-96" id="h11-0-96" class="i">+                Icon(
</a><a href="#h11-0-97" id="h11-0-97" class="i">+                    imageVector = Icons.Filled.OpenInNew,
</a><a href="#h11-0-98" id="h11-0-98" class="i">+                    contentDescription = null,
</a><a href="#h11-0-99" id="h11-0-99" class="i">+                    modifier = Modifier.size(24.dp)
</a><a href="#h11-0-100" id="h11-0-100" class="i">+                )
</a><a href="#h11-0-101" id="h11-0-101" class="i">+            }
</a><a href="#h11-0-102" id="h11-0-102" class="i">+        }
</a><a href="#h11-0-103" id="h11-0-103" class="i">+    }
</a><a href="#h11-0-104" id="h11-0-104" class="i">+
</a><a href="#h11-0-105" id="h11-0-105" class="i">+    @Composable
</a><a href="#h11-0-106" id="h11-0-106" class="i">+    fun LogsSection() {
</a><a href="#h11-0-107" id="h11-0-107" class="i">+        val coroutineScope = rememberCoroutineScope()
</a><a href="#h11-0-108" id="h11-0-108" class="i">+        var lineCount by remember { mutableIntStateOf(0) }
</a><a href="#h11-0-109" id="h11-0-109" class="i">+        var logReader by remember { mutableStateOf&lt;LogReader?&gt;(null) }
</a><a href="#h11-0-110" id="h11-0-110" class="i">+        logListState = remember { LazyListState(0) }
</a><a href="#h11-0-111" id="h11-0-111" class="i">+
</a><a href="#h11-0-112" id="h11-0-112" class="i">+        Column(
</a><a href="#h11-0-113" id="h11-0-113" class="i">+            modifier = Modifier
</a><a href="#h11-0-114" id="h11-0-114" class="i">+                .fillMaxSize()
</a><a href="#h11-0-115" id="h11-0-115" class="i">+        ) {
</a><a href="#h11-0-116" id="h11-0-116" class="i">+            LazyColumn(
</a><a href="#h11-0-117" id="h11-0-117" class="i">+                modifier = Modifier.background(MaterialTheme.colorScheme.surfaceVariant),
</a><a href="#h11-0-118" id="h11-0-118" class="i">+                state = logListState
</a><a href="#h11-0-119" id="h11-0-119" class="i">+            ) {
</a><a href="#h11-0-120" id="h11-0-120" class="i">+                items(lineCount) { index -&gt;
</a><a href="#h11-0-121" id="h11-0-121" class="i">+                    val line = logReader?.getLogLine(index) ?: return@items
</a><a href="#h11-0-122" id="h11-0-122" class="i">+                    Box(modifier = Modifier
</a><a href="#h11-0-123" id="h11-0-123" class="i">+                        .fillMaxWidth()
</a><a href="#h11-0-124" id="h11-0-124" class="i">+                        .background(
</a><a href="#h11-0-125" id="h11-0-125" class="i">+                            if (index % 2 == 0) MaterialTheme.colorScheme.surface else MaterialTheme.colorScheme.surfaceVariant
</a><a href="#h11-0-126" id="h11-0-126" class="i">+                        )) {
</a><a href="#h11-0-127" id="h11-0-127" class="i">+                        Text(text = line.message, modifier = Modifier.padding(9.dp), fontSize = 10.sp)
</a><a href="#h11-0-128" id="h11-0-128" class="i">+                    }
</a><a href="#h11-0-129" id="h11-0-129" class="i">+                }
</a><a href="#h11-0-130" id="h11-0-130" class="i">+            }
</a><a href="#h11-0-131" id="h11-0-131" class="i">+
</a><a href="#h11-0-132" id="h11-0-132" class="i">+            if (logReader == null) {
</a><a href="#h11-0-133" id="h11-0-133" class="i">+                CircularProgressIndicator(modifier = Modifier.align(Alignment.CenterHorizontally))
</a><a href="#h11-0-134" id="h11-0-134" class="i">+            }
</a><a href="#h11-0-135" id="h11-0-135" class="i">+
</a><a href="#h11-0-136" id="h11-0-136" class="i">+            LaunchedEffect(Unit) {
</a><a href="#h11-0-137" id="h11-0-137" class="i">+                coroutineScope.launch(Dispatchers.IO) {
</a><a href="#h11-0-138" id="h11-0-138" class="i">+                    runCatching {
</a><a href="#h11-0-139" id="h11-0-139" class="i">+                        logReader = context.log.newReader {
</a><a href="#h11-0-140" id="h11-0-140" class="i">+                            lineCount++
</a><a href="#h11-0-141" id="h11-0-141" class="i">+                        }
</a><a href="#h11-0-142" id="h11-0-142" class="i">+                        lineCount = logReader!!.lineCount
</a><a href="#h11-0-143" id="h11-0-143" class="i">+                    }.onFailure {
</a><a href="#h11-0-144" id="h11-0-144" class="i">+                        context.longToast(&quot;Failed to read logs!&quot;)
</a><a href="#h11-0-145" id="h11-0-145" class="i">+                    }
</a><a href="#h11-0-146" id="h11-0-146" class="i">+                }
</a><a href="#h11-0-147" id="h11-0-147" class="i">+            }
</a><a href="#h11-0-148" id="h11-0-148" class="i">+        }
</a><a href="#h11-0-149" id="h11-0-149" class="i">+    }
</a><a href="#h11-0-150" id="h11-0-150" class="i">+
</a><a href="#h11-0-151" id="h11-0-151" class="i">+    @Composable
</a><a href="#h11-0-152" id="h11-0-152" class="i">+    fun LogsActionButtons() {
</a><a href="#h11-0-153" id="h11-0-153" class="i">+        val coroutineScope = rememberCoroutineScope()
</a><a href="#h11-0-154" id="h11-0-154" class="i">+        Column(
</a><a href="#h11-0-155" id="h11-0-155" class="i">+            verticalArrangement = Arrangement.spacedBy(5.dp),
</a><a href="#h11-0-156" id="h11-0-156" class="i">+        ) {
</a><a href="#h11-0-157" id="h11-0-157" class="i">+            FilledIconButton(onClick = {
</a><a href="#h11-0-158" id="h11-0-158" class="i">+                coroutineScope.launch {
</a><a href="#h11-0-159" id="h11-0-159" class="i">+                    logListState.scrollToItem(0)
</a><a href="#h11-0-160" id="h11-0-160" class="i">+                }
</a><a href="#h11-0-161" id="h11-0-161" class="i">+            }) {
</a><a href="#h11-0-162" id="h11-0-162" class="i">+                Icon(Icons.Filled.KeyboardDoubleArrowUp, contentDescription = null)
</a><a href="#h11-0-163" id="h11-0-163" class="i">+            }
</a><a href="#h11-0-164" id="h11-0-164" class="i">+
</a><a href="#h11-0-165" id="h11-0-165" class="i">+            FilledIconButton(onClick = {
</a><a href="#h11-0-166" id="h11-0-166" class="i">+                coroutineScope.launch {
</a><a href="#h11-0-167" id="h11-0-167" class="i">+                    logListState.scrollToItem(logListState.layoutInfo.totalItemsCount - 1)
</a><a href="#h11-0-168" id="h11-0-168" class="i">+                }
</a><a href="#h11-0-169" id="h11-0-169" class="i">+            }) {
</a><a href="#h11-0-170" id="h11-0-170" class="i">+                Icon(Icons.Filled.KeyboardDoubleArrowDown, contentDescription = null)
</a><a href="#h11-0-171" id="h11-0-171" class="i">+            }
</a><a href="#h11-0-172" id="h11-0-172" class="i">+        }
</a><a href="#h11-0-173" id="h11-0-173" class="i">+    }
</a><a href="#h11-0-174" id="h11-0-174" class="i">+
</a><a href="#h11-0-175" id="h11-0-175" class="i">+    private fun launchActionIntent(action: EnumAction) {
</a><a href="#h11-0-176" id="h11-0-176" class="i">+        val intent = context.androidContext.packageManager.getLaunchIntentForPackage(Constants.SNAPCHAT_PACKAGE_NAME)
</a><a href="#h11-0-177" id="h11-0-177" class="i">+        intent?.putExtra(ActionManager.ACTION_PARAMETER, action.key)
</a><a href="#h11-0-178" id="h11-0-178" class="i">+        context.androidContext.startActivity(intent)
</a><a href="#h11-0-179" id="h11-0-179" class="i">+    }
</a><a href="#h11-0-180" id="h11-0-180" class="i">+
</a><a href="#h11-0-181" id="h11-0-181" class="i">+    @Composable
</a><a href="#h11-0-182" id="h11-0-182" class="i">+    private fun RowTitle(title: String) {
</a><a href="#h11-0-183" id="h11-0-183" class="i">+        Text(text = title, modifier = Modifier.padding(16.dp), fontSize = 20.sp, fontWeight = FontWeight.Bold)
</a><a href="#h11-0-184" id="h11-0-184" class="i">+    }
</a><a href="#h11-0-185" id="h11-0-185" class="i">+
</a><a href="#h11-0-186" id="h11-0-186" class="i">+    @Composable
</a><a href="#h11-0-187" id="h11-0-187" class="i">+    fun DebugSection() {
</a><a href="#h11-0-188" id="h11-0-188" class="i">+        Column(
</a><a href="#h11-0-189" id="h11-0-189" class="i">+            modifier = Modifier
</a><a href="#h11-0-190" id="h11-0-190" class="i">+                .fillMaxSize()
</a><a href="#h11-0-191" id="h11-0-191" class="i">+                .verticalScroll(ScrollState(0))
</a><a href="#h11-0-192" id="h11-0-192" class="i">+        ) {
</a><a href="#h11-0-193" id="h11-0-193" class="i">+            RowTitle(title = &quot;Actions&quot;)
</a><a href="#h11-0-194" id="h11-0-194" class="i">+            EnumAction.values().forEach { enumAction -&gt;
</a><a href="#h11-0-195" id="h11-0-195" class="i">+                RowAction(title = context.translation[&quot;actions.${enumAction.key}&quot;]) {
</a><a href="#h11-0-196" id="h11-0-196" class="i">+                    launchActionIntent(enumAction)
</a><a href="#h11-0-197" id="h11-0-197" class="i">+                }
</a><a href="#h11-0-198" id="h11-0-198" class="i">+            }
</a><a href="#h11-0-199" id="h11-0-199" class="i">+
</a><a href="#h11-0-200" id="h11-0-200" class="i">+            RowTitle(title = &quot;Clear Files&quot;)
</a><a href="#h11-0-201" id="h11-0-201" class="i">+            BridgeFileType.values().forEach { fileType -&gt;
</a><a href="#h11-0-202" id="h11-0-202" class="i">+                RowAction(title = fileType.displayName, requireConfirmation = true) {
</a><a href="#h11-0-203" id="h11-0-203" class="i">+                    runCatching {
</a><a href="#h11-0-204" id="h11-0-204" class="i">+                        fileType.resolve(context.androidContext).delete()
</a><a href="#h11-0-205" id="h11-0-205" class="i">+                        context.longToast(&quot;Deleted ${fileType.displayName}!&quot;)
</a><a href="#h11-0-206" id="h11-0-206" class="i">+                    }.onFailure {
</a><a href="#h11-0-207" id="h11-0-207" class="i">+                        context.longToast(&quot;Failed to delete ${fileType.displayName}!&quot;)
</a><a href="#h11-0-208" id="h11-0-208" class="i">+                    }
</a><a href="#h11-0-209" id="h11-0-209" class="i">+                }
</a><a href="#h11-0-210" id="h11-0-210" class="i">+            }
</a><a href="#h11-0-211" id="h11-0-211" class="i">+        }
</a><a href="#h11-0-212" id="h11-0-212" class="i">+    }
</a><a href="#h11-0-213" id="h11-0-213" class="i">+}</a><a href="#h11-0-214" id="h11-0-214" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h12" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/social/AddFriendDialog.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/social/AddFriendDialog.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/social/AddFriendDialog.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/social/AddFriendDialog.kt</a></b>
<a href="#h12-0" id="h12-0" class="h">@@ -43,9 +43,8 @@ import kotlinx.coroutines.Job
</a> import kotlinx.coroutines.delay
 import kotlinx.coroutines.launch
 import kotlinx.coroutines.withContext
<a href="#h12-0-3" id="h12-0-3" class="d">-import me.rhunk.snapenhance.Logger
</a> import me.rhunk.snapenhance.RemoteSideContext
<a href="#h12-0-5" id="h12-0-5" class="d">-import me.rhunk.snapenhance.bridge.BridgeClient
</a><a href="#h12-0-6" id="h12-0-6" class="i">+import me.rhunk.snapenhance.core.bridge.BridgeClient
</a> import me.rhunk.snapenhance.core.messaging.MessagingFriendInfo
 import me.rhunk.snapenhance.core.messaging.MessagingGroupInfo
 import me.rhunk.snapenhance.util.snap.SnapWidgetBroadcastReceiverHelper
<a href="#h12-1" id="h12-1" class="h">@@ -55,8 +54,8 @@ class AddFriendDialog(
</a>     private val section: SocialSection,
 ) {
     @Composable
<a href="#h12-1-3" id="h12-1-3" class="d">-    private fun ListCardEntry(name: String, currentState: () -&gt; Boolean, onState: (Boolean) -&gt; Unit = {}) {
</a><a href="#h12-1-4" id="h12-1-4" class="d">-        var currentState by remember { mutableStateOf(currentState()) }
</a><a href="#h12-1-5" id="h12-1-5" class="i">+    private fun ListCardEntry(name: String, getCurrentState: () -&gt; Boolean, onState: (Boolean) -&gt; Unit = {}) {
</a><a href="#h12-1-6" id="h12-1-6" class="i">+        var currentState by remember { mutableStateOf(getCurrentState()) }
</a> 
         Row(
             modifier = Modifier
<a href="#h12-2" id="h12-2" class="h">@@ -74,7 +73,7 @@ class AddFriendDialog(
</a>                 modifier = Modifier
                     .weight(1f)
                     .onGloballyPositioned {
<a href="#h12-2-3" id="h12-2-3" class="d">-                        currentState = currentState()
</a><a href="#h12-2-4" id="h12-2-4" class="i">+                        currentState = getCurrentState()
</a>                     }
             )
 
<a href="#h12-3" id="h12-3" class="h">@@ -149,7 +148,7 @@ class AddFriendDialog(
</a>                 runCatching {
                     context.androidContext.sendBroadcast(it)
                 }.onFailure {
<a href="#h12-3-3" id="h12-3-3" class="d">-                    Logger.error(&quot;Failed to send broadcast&quot;, it)
</a><a href="#h12-3-4" id="h12-3-4" class="i">+                    context.log.error(&quot;Failed to send broadcast&quot;, it)
</a>                     hasFetchError = true
                 }
             }
<a href="#h12-4" id="h12-4" class="h">@@ -234,7 +233,7 @@ class AddFriendDialog(
</a>                         val group = filteredGroups[it]
                         ListCardEntry(
                             name = group.name,
<a href="#h12-4-3" id="h12-4-3" class="d">-                            currentState = { context.modDatabase.getGroupInfo(group.conversationId) != null }
</a><a href="#h12-4-4" id="h12-4-4" class="i">+                            getCurrentState = { context.modDatabase.getGroupInfo(group.conversationId) != null }
</a>                         ) { state -&gt;
                             if (state) {
                                 context.bridgeService.triggerGroupSync(group.conversationId)
<a href="#h12-5" id="h12-5" class="h">@@ -261,7 +260,7 @@ class AddFriendDialog(
</a> 
                         ListCardEntry(
                             name = friend.displayName?.takeIf { name -&gt; name.isNotBlank() } ?: friend.mutableUsername,
<a href="#h12-5-3" id="h12-5-3" class="d">-                            currentState = { context.modDatabase.getFriendInfo(friend.userId) != null }
</a><a href="#h12-5-4" id="h12-5-4" class="i">+                            getCurrentState = { context.modDatabase.getFriendInfo(friend.userId) != null }
</a>                         ) { state -&gt;
                             if (state) {
                                 context.bridgeService.triggerFriendSync(friend.userId)
<b>diff --git a/<a id="h13" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/social/SocialSection.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/social/SocialSection.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/social/SocialSection.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/social/SocialSection.kt</a></b>
<a href="#h13-0" id="h13-0" class="h">@@ -79,7 +79,7 @@ class SocialSection : Section() {
</a>         groupList = context.modDatabase.getGroups()
     }
 
<a href="#h13-0-3" id="h13-0-3" class="d">-    override fun canGoBack() = navController.currentBackStackEntry?.destination?.route != MAIN_ROUTE
</a><a href="#h13-0-4" id="h13-0-4" class="i">+    override fun canGoBack() = currentRoute != MAIN_ROUTE
</a> 
     override fun build(navGraphBuilder: NavGraphBuilder) {
         navGraphBuilder.navigation(route = enumSection.route, startDestination = MAIN_ROUTE) {
<a href="#h13-1" id="h13-1" class="h">@@ -117,7 +117,7 @@ class SocialSection : Section() {
</a>             }
         }
 
<a href="#h13-1-3" id="h13-1-3" class="d">-        if (navController.currentBackStackEntry?.destination?.route != MAIN_ROUTE) {
</a><a href="#h13-1-4" id="h13-1-4" class="i">+        if (currentRoute != MAIN_ROUTE) {
</a>             IconButton(
                 onClick = { deleteConfirmDialog = true },
             ) {
<b>diff --git a/<a id="h14" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/screens/impl/MappingsScreen.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/screens/impl/MappingsScreen.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/screens/impl/MappingsScreen.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/screens/impl/MappingsScreen.kt</a></b>
<a href="#h14-0" id="h14-0" class="h">@@ -44,7 +44,7 @@ class MappingsScreen : SetupScreen() {
</a> 
         fun tryToGenerateMappings() {
             //check for snapchat installation
<a href="#h14-0-3" id="h14-0-3" class="d">-            val installationSummary = context.getInstallationSummary()
</a><a href="#h14-0-4" id="h14-0-4" class="i">+            val installationSummary = context.installationSummary
</a>             if (installationSummary.snapchatInfo == null) {
                 throw Exception(context.translation[&quot;setup.mappings.generate_failure_no_snapchat&quot;])
             }
<a href="#h14-1" id="h14-1" class="h">@@ -69,7 +69,7 @@ class MappingsScreen : SetupScreen() {
</a>                 }.onFailure {
                     isGenerating = false
                     infoText = context.translation[&quot;setup.mappings.generate_failure&quot;] + &quot;\n\n&quot; + it.message
<a href="#h14-1-3" id="h14-1-3" class="d">-                    Logger.error(&quot;Failed to generate mappings&quot;, it)
</a><a href="#h14-1-4" id="h14-1-4" class="i">+                    context.log.error(&quot;Failed to generate mappings&quot;, it)
</a>                 }
             }
         }) {
<b>diff --git a/<a id="h15" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/screens/impl/PickLanguageScreen.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/screens/impl/PickLanguageScreen.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/screens/impl/PickLanguageScreen.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/screens/impl/PickLanguageScreen.kt</a></b>
<a href="#h15-0" id="h15-0" class="h">@@ -25,7 +25,7 @@ import androidx.compose.ui.text.font.FontWeight
</a> import androidx.compose.ui.unit.dp
 import androidx.compose.ui.unit.sp
 import androidx.compose.ui.window.Dialog
<a href="#h15-0-3" id="h15-0-3" class="d">-import me.rhunk.snapenhance.bridge.wrapper.LocaleWrapper
</a><a href="#h15-0-4" id="h15-0-4" class="i">+import me.rhunk.snapenhance.core.bridge.wrapper.LocaleWrapper
</a> import me.rhunk.snapenhance.ui.setup.screens.SetupScreen
 import me.rhunk.snapenhance.ui.util.ObservableMutableState
 import java.util.Locale
<b>diff --git a/<a id="h16" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/screens/impl/SaveFolderScreen.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/screens/impl/SaveFolderScreen.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/screens/impl/SaveFolderScreen.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/screens/impl/SaveFolderScreen.kt</a></b>
<a href="#h16-0" id="h16-0" class="h">@@ -7,7 +7,6 @@ import androidx.compose.material3.Text
</a> import androidx.compose.runtime.Composable
 import androidx.compose.ui.Modifier
 import androidx.compose.ui.unit.dp
<a href="#h16-0-3" id="h16-0-3" class="d">-import me.rhunk.snapenhance.Logger
</a> import me.rhunk.snapenhance.ui.setup.screens.SetupScreen
 import me.rhunk.snapenhance.ui.util.ActivityLauncherHelper
 import me.rhunk.snapenhance.ui.util.ObservableMutableState
<a href="#h16-1" id="h16-1" class="h">@@ -23,7 +22,6 @@ class SaveFolderScreen : SetupScreen() {
</a>         saveFolder = ObservableMutableState(
                 defaultValue = &quot;&quot;,
                 onChange = { _, newValue -&gt;
<a href="#h16-1-3" id="h16-1-3" class="d">-                    Logger.debug(newValue)
</a>                     if (newValue.isNotBlank()) {
                         context.config.root.downloader.saveFolder.set(newValue)
                         context.config.writeConfig()
<b>diff --git a/<a id="h17" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/util/ActivityLauncherHelper.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/util/ActivityLauncherHelper.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/util/ActivityLauncherHelper.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/util/ActivityLauncherHelper.kt</a></b>
<a href="#h17-0" id="h17-0" class="h">@@ -16,7 +16,7 @@ class ActivityLauncherHelper(
</a>                 runCatching {
                     callback?.let { it(result.data!!) }
                 }.onFailure {
<a href="#h17-0-3" id="h17-0-3" class="d">-                    Logger.error(&quot;Failed to process activity result&quot;, it)
</a><a href="#h17-0-4" id="h17-0-4" class="i">+                    Logger.directError(&quot;Failed to process activity result&quot;, it)
</a>                 }
             }
             callback = null
<b>diff --git a/<a id="h18" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/util/AlertDialogs.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/util/AlertDialogs.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/util/AlertDialogs.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/util/AlertDialogs.kt</a></b>
<a href="#h18-0" id="h18-0" class="h">@@ -33,7 +33,7 @@ import androidx.compose.ui.text.input.KeyboardType
</a> import androidx.compose.ui.text.input.TextFieldValue
 import androidx.compose.ui.unit.dp
 import androidx.compose.ui.unit.sp
<a href="#h18-0-3" id="h18-0-3" class="d">-import me.rhunk.snapenhance.bridge.wrapper.LocaleWrapper
</a><a href="#h18-0-4" id="h18-0-4" class="i">+import me.rhunk.snapenhance.core.bridge.wrapper.LocaleWrapper
</a> import me.rhunk.snapenhance.core.config.DataProcessors
 import me.rhunk.snapenhance.core.config.PropertyPair
 
<b>diff --git a/<a id="h19" href="../file/core/src/main/aidl/me/rhunk/snapenhance/bridge/BridgeInterface.aidl.html">core/src/main/aidl/me/rhunk/snapenhance/bridge/BridgeInterface.aidl</a> b/<a href="../file/core/src/main/aidl/me/rhunk/snapenhance/bridge/BridgeInterface.aidl.html">core/src/main/aidl/me/rhunk/snapenhance/bridge/BridgeInterface.aidl</a></b>
<a href="#h19-0" id="h19-0" class="h">@@ -6,52 +6,46 @@ import me.rhunk.snapenhance.bridge.SyncCallback;
</a> 
 interface BridgeInterface {
     /**
<a href="#h19-0-3" id="h19-0-3" class="i">+    * broadcast a log message
</a><a href="#h19-0-4" id="h19-0-4" class="i">+    */
</a><a href="#h19-0-5" id="h19-0-5" class="i">+    void broadcastLog(String tag, String level, String message);
</a><a href="#h19-0-6" id="h19-0-6" class="i">+
</a><a href="#h19-0-7" id="h19-0-7" class="i">+    /**
</a>     * Execute a file operation
<a href="#h19-0-9" id="h19-0-9" class="i">+    * @param fileType the corresponding file type (see BridgeFileType)
</a>     */
     byte[] fileOperation(int action, int fileType, in @nullable byte[] content);
 
     /**
      * Get the content of a logged message from the database
<a href="#h19-0-15" id="h19-0-15" class="d">-     *
</a><a href="#h19-0-16" id="h19-0-16" class="d">-     * @param conversationId the ID of the conversation
</a><a href="#h19-0-17" id="h19-0-17" class="d">-     * @return the content of the message
</a><a href="#h19-0-18" id="h19-0-18" class="i">+     * @return message ids that are logged
</a>      */
     long[] getLoggedMessageIds(String conversationId, int limit);
 
     /**
      * Get the content of a logged message from the database
<a href="#h19-0-24" id="h19-0-24" class="d">-     *
</a><a href="#h19-0-25" id="h19-0-25" class="d">-     * @param id the ID of the message logger message
</a><a href="#h19-0-26" id="h19-0-26" class="d">-     * @return the content of the message
</a>      */
     @nullable byte[] getMessageLoggerMessage(String conversationId, long id);
 
     /**
      * Add a message to the message logger database
<a href="#h19-0-32" id="h19-0-32" class="d">-     *
</a><a href="#h19-0-33" id="h19-0-33" class="d">-     * @param id      the ID of the message logger message
</a><a href="#h19-0-34" id="h19-0-34" class="d">-     * @param message the content of the message
</a>      */
     void addMessageLoggerMessage(String conversationId, long id, in byte[] message);
 
     /**
      * Delete a message from the message logger database
<a href="#h19-0-40" id="h19-0-40" class="d">-     *
</a><a href="#h19-0-41" id="h19-0-41" class="d">-     * @param id the ID of the message logger message
</a>      */
     void deleteMessageLoggerMessage(String conversationId, long id);
 
     /**
<a href="#h19-0-46" id="h19-0-46" class="d">-     * Clear the message logger database
</a><a href="#h19-0-47" id="h19-0-47" class="d">-     */
</a><a href="#h19-0-48" id="h19-0-48" class="d">-    void clearMessageLogger();
</a><a href="#h19-0-49" id="h19-0-49" class="d">-
</a><a href="#h19-0-50" id="h19-0-50" class="i">+    * Get the application APK path (assets for the conversation exporter)
</a><a href="#h19-0-51" id="h19-0-51" class="i">+    */
</a>     String getApplicationApkPath();
 
     /**
      * Fetch the locales
      *
<a href="#h19-0-57" id="h19-0-57" class="d">-     * @return the locale result
</a><a href="#h19-0-58" id="h19-0-58" class="i">+     * @return the map of locales (key: locale short name, value: locale data as json)
</a>      */
     Map&lt;String, String&gt; fetchLocales(String userLocale);
 
<a href="#h19-1" id="h19-1" class="h">@@ -62,11 +56,14 @@ interface BridgeInterface {
</a> 
     /**
     * Get rules for a given user or conversation
<a href="#h19-1-3" id="h19-1-3" class="i">+    * @return list of rules (MessagingRuleType)
</a>     */
     List&lt;String&gt; getRules(String uuid);
 
     /**
     * Update rule for a giver user or conversation
<a href="#h19-1-9" id="h19-1-9" class="i">+    *
</a><a href="#h19-1-10" id="h19-1-10" class="i">+    * @param type rule type (MessagingRuleType)
</a>     */
     void setRule(String uuid, String type, boolean state);
 
<a href="#h19-2" id="h19-2" class="h">@@ -77,8 +74,8 @@ interface BridgeInterface {
</a> 
     /**
     * Pass all groups and friends to be able to add them to the database
<a href="#h19-2-3" id="h19-2-3" class="d">-    * @param groups serialized groups
</a><a href="#h19-2-4" id="h19-2-4" class="d">-    * @param friends serialized friends
</a><a href="#h19-2-5" id="h19-2-5" class="i">+    * @param groups list of groups (MessagingGroupInfo as json string)
</a><a href="#h19-2-6" id="h19-2-6" class="i">+    * @param friends list of friends (MessagingFriendInfo as json string)
</a>     */
     oneway void passGroupsAndFriends(in List&lt;String&gt; groups, in List&lt;String&gt; friends);
 } 
\ No newline at end of file
<b>diff --git a/<a id="h20" href="../file/core/src/main/assets/lang/en_US.json.html">core/src/main/assets/lang/en_US.json</a> b/<a href="../file/core/src/main/assets/lang/en_US.json.html">core/src/main/assets/lang/en_US.json</a></b>
<a href="#h20-0" id="h20-0" class="h">@@ -20,6 +20,8 @@
</a>             &quot;downloads&quot;: &quot;Downloads&quot;,
             &quot;features&quot;: &quot;Features&quot;,
             &quot;home&quot;: &quot;Home&quot;,
<a href="#h20-0-3" id="h20-0-3" class="i">+            &quot;home_debug&quot;: &quot;Debug&quot;,
</a><a href="#h20-0-4" id="h20-0-4" class="i">+            &quot;home_logs&quot;: &quot;Logs&quot;,
</a>             &quot;social&quot;: &quot;Social&quot;,
             &quot;plugins&quot;: &quot;Plugins&quot;
         },
<a href="#h20-1" id="h20-1" class="h">@@ -64,8 +66,8 @@
</a>         }
     },
 
<a href="#h20-1-3" id="h20-1-3" class="d">-    &quot;action&quot;: {
</a><a href="#h20-1-4" id="h20-1-4" class="d">-        &quot;clean_cache&quot;: &quot;Clean Cache&quot;,
</a><a href="#h20-1-5" id="h20-1-5" class="i">+    &quot;actions&quot;: {
</a><a href="#h20-1-6" id="h20-1-6" class="i">+        &quot;clean_snapchat_cache&quot;: &quot;Clean Snapchat Cache&quot;,
</a>         &quot;clear_message_logger&quot;: &quot;Clear Message Logger&quot;,
         &quot;refresh_mappings&quot;: &quot;Refresh Mappings&quot;,
         &quot;open_map&quot;: &quot;Choose location on map&quot;,
<b>diff --git a/<a id="h21" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/Constants.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/Constants.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/Constants.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/Constants.kt</a></b>
<a href="#h21-0" id="h21-0" class="h">@@ -1,14 +1,12 @@
</a> package me.rhunk.snapenhance
 
 object Constants {
<a href="#h21-0-3" id="h21-0-3" class="d">-    const val TAG = &quot;SnapEnhance&quot;
</a>     const val SNAPCHAT_PACKAGE_NAME = &quot;com.snapchat.android&quot;
 
     const val VIEW_INJECTED_CODE = 0x7FFFFF02
 
     val ARROYO_MEDIA_CONTAINER_PROTO_PATH = intArrayOf(4, 4)
     val ARROYO_STRING_CHAT_MESSAGE_PROTO = ARROYO_MEDIA_CONTAINER_PROTO_PATH + intArrayOf(2, 1)
<a href="#h21-0-10" id="h21-0-10" class="d">-    val ARROYO_URL_KEY_PROTO_PATH = intArrayOf(4, 5, 1, 3)
</a> 
     const val ENCRYPTION_PROTO_INDEX = 19
     const val ENCRYPTION_PROTO_INDEX_V2 = 4
<b>diff --git a/<a id="h22" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/Logger.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/Logger.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/Logger.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/Logger.kt</a></b>
<a href="#h22-0" id="h22-0" class="h">@@ -2,47 +2,81 @@ package me.rhunk.snapenhance
</a> 
 import android.util.Log
 import de.robv.android.xposed.XposedBridge
<a href="#h22-0-3" id="h22-0-3" class="d">-import me.rhunk.snapenhance.core.BuildConfig
</a><a href="#h22-0-4" id="h22-0-4" class="i">+import me.rhunk.snapenhance.core.bridge.BridgeClient
</a> 
<a href="#h22-0-6" id="h22-0-6" class="d">-object Logger {
</a><a href="#h22-0-7" id="h22-0-7" class="d">-    private const val TAG = &quot;SnapEnhance&quot;
</a><a href="#h22-0-8" id="h22-0-8" class="i">+enum class LogLevel(
</a><a href="#h22-0-9" id="h22-0-9" class="i">+    val letter: String,
</a><a href="#h22-0-10" id="h22-0-10" class="i">+    val shortName: String,
</a><a href="#h22-0-11" id="h22-0-11" class="i">+    val priority: Int = Log.INFO
</a><a href="#h22-0-12" id="h22-0-12" class="i">+) {
</a><a href="#h22-0-13" id="h22-0-13" class="i">+    VERBOSE(&quot;V&quot;, &quot;verbose&quot;, Log.VERBOSE),
</a><a href="#h22-0-14" id="h22-0-14" class="i">+    DEBUG(&quot;D&quot;, &quot;debug&quot;, Log.DEBUG),
</a><a href="#h22-0-15" id="h22-0-15" class="i">+    INFO(&quot;I&quot;, &quot;info&quot;, Log.INFO),
</a><a href="#h22-0-16" id="h22-0-16" class="i">+    WARN(&quot;W&quot;, &quot;warn&quot;, Log.WARN),
</a><a href="#h22-0-17" id="h22-0-17" class="i">+    ERROR(&quot;E&quot;, &quot;error&quot;, Log.ERROR),
</a><a href="#h22-0-18" id="h22-0-18" class="i">+    ASSERT(&quot;A&quot;, &quot;assert&quot;, Log.ASSERT);
</a> 
<a href="#h22-0-20" id="h22-0-20" class="d">-    fun log(message: Any?) {
</a><a href="#h22-0-21" id="h22-0-21" class="d">-        Log.i(TAG, message.toString())
</a><a href="#h22-0-22" id="h22-0-22" class="d">-    }
</a><a href="#h22-0-23" id="h22-0-23" class="i">+    companion object {
</a><a href="#h22-0-24" id="h22-0-24" class="i">+        fun fromLetter(letter: String): LogLevel? {
</a><a href="#h22-0-25" id="h22-0-25" class="i">+            return values().find { it.letter == letter }
</a><a href="#h22-0-26" id="h22-0-26" class="i">+        }
</a> 
<a href="#h22-0-28" id="h22-0-28" class="d">-    fun debug(message: Any?) {
</a><a href="#h22-0-29" id="h22-0-29" class="d">-        if (!BuildConfig.DEBUG) return
</a><a href="#h22-0-30" id="h22-0-30" class="d">-        Log.d(TAG, message.toString())
</a><a href="#h22-0-31" id="h22-0-31" class="i">+        fun fromShortName(shortName: String): LogLevel? {
</a><a href="#h22-0-32" id="h22-0-32" class="i">+            return values().find { it.shortName == shortName }
</a><a href="#h22-0-33" id="h22-0-33" class="i">+        }
</a>     }
<a href="#h22-0-35" id="h22-0-35" class="i">+}
</a> 
<a href="#h22-0-37" id="h22-0-37" class="d">-    fun debug(tag: String, message: Any?) {
</a><a href="#h22-0-38" id="h22-0-38" class="d">-        if (!BuildConfig.DEBUG) return
</a><a href="#h22-0-39" id="h22-0-39" class="d">-        Log.d(tag, message.toString())
</a><a href="#h22-0-40" id="h22-0-40" class="d">-    }
</a> 
<a href="#h22-0-42" id="h22-0-42" class="d">-    fun error(throwable: Throwable) {
</a><a href="#h22-0-43" id="h22-0-43" class="d">-        Log.e(TAG, &quot;&quot;, throwable)
</a><a href="#h22-0-44" id="h22-0-44" class="d">-    }
</a><a href="#h22-0-45" id="h22-0-45" class="i">+class Logger(
</a><a href="#h22-0-46" id="h22-0-46" class="i">+    private val bridgeClient: BridgeClient
</a><a href="#h22-0-47" id="h22-0-47" class="i">+) {
</a><a href="#h22-0-48" id="h22-0-48" class="i">+    companion object {
</a><a href="#h22-0-49" id="h22-0-49" class="i">+        private const val TAG = &quot;SnapEnhanceCore&quot;
</a> 
<a href="#h22-0-51" id="h22-0-51" class="d">-    fun error(message: Any?) {
</a><a href="#h22-0-52" id="h22-0-52" class="d">-        Log.e(TAG, message.toString())
</a><a href="#h22-0-53" id="h22-0-53" class="d">-    }
</a><a href="#h22-0-54" id="h22-0-54" class="i">+        fun directDebug(message: Any?, tag: String = TAG) {
</a><a href="#h22-0-55" id="h22-0-55" class="i">+            Log.println(Log.DEBUG, tag, message.toString())
</a><a href="#h22-0-56" id="h22-0-56" class="i">+        }
</a> 
<a href="#h22-0-58" id="h22-0-58" class="d">-    fun error(message: Any?, throwable: Throwable) {
</a><a href="#h22-0-59" id="h22-0-59" class="d">-        Log.e(TAG, message.toString(), throwable)
</a><a href="#h22-0-60" id="h22-0-60" class="d">-    }
</a><a href="#h22-0-61" id="h22-0-61" class="i">+        fun directError(message: Any?, throwable: Throwable, tag: String = TAG) {
</a><a href="#h22-0-62" id="h22-0-62" class="i">+            Log.println(Log.ERROR, tag, message.toString())
</a><a href="#h22-0-63" id="h22-0-63" class="i">+            Log.println(Log.ERROR, tag, throwable.toString())
</a><a href="#h22-0-64" id="h22-0-64" class="i">+        }
</a><a href="#h22-0-65" id="h22-0-65" class="i">+
</a><a href="#h22-0-66" id="h22-0-66" class="i">+        fun xposedLog(message: Any?, tag: String = TAG) {
</a><a href="#h22-0-67" id="h22-0-67" class="i">+            Log.println(Log.INFO, tag, message.toString())
</a><a href="#h22-0-68" id="h22-0-68" class="i">+            XposedBridge.log(&quot;$tag: $message&quot;)
</a><a href="#h22-0-69" id="h22-0-69" class="i">+        }
</a> 
<a href="#h22-0-71" id="h22-0-71" class="d">-    fun xposedLog(message: Any?) {
</a><a href="#h22-0-72" id="h22-0-72" class="d">-        XposedBridge.log(message.toString())
</a><a href="#h22-0-73" id="h22-0-73" class="i">+        fun xposedLog(message: Any?, throwable: Throwable, tag: String = TAG) {
</a><a href="#h22-0-74" id="h22-0-74" class="i">+            Log.println(Log.INFO, tag, message.toString())
</a><a href="#h22-0-75" id="h22-0-75" class="i">+            XposedBridge.log(&quot;$tag: $message&quot;)
</a><a href="#h22-0-76" id="h22-0-76" class="i">+            XposedBridge.log(throwable)
</a><a href="#h22-0-77" id="h22-0-77" class="i">+        }
</a>     }
 
<a href="#h22-0-80" id="h22-0-80" class="d">-    fun xposedLog(message: Any?, throwable: Throwable?) {
</a><a href="#h22-0-81" id="h22-0-81" class="d">-        XposedBridge.log(message.toString())
</a><a href="#h22-0-82" id="h22-0-82" class="d">-        XposedBridge.log(throwable)
</a><a href="#h22-0-83" id="h22-0-83" class="i">+    private fun internalLog(tag: String, logLevel: LogLevel, message: Any?) {
</a><a href="#h22-0-84" id="h22-0-84" class="i">+        runCatching {
</a><a href="#h22-0-85" id="h22-0-85" class="i">+            bridgeClient.broadcastLog(tag, logLevel.shortName, message.toString())
</a><a href="#h22-0-86" id="h22-0-86" class="i">+        }.onFailure {
</a><a href="#h22-0-87" id="h22-0-87" class="i">+            Log.println(logLevel.priority, tag, message.toString())
</a><a href="#h22-0-88" id="h22-0-88" class="i">+        }
</a>     }
 
<a href="#h22-0-91" id="h22-0-91" class="d">-    fun xposedLog(throwable: Throwable) {
</a><a href="#h22-0-92" id="h22-0-92" class="d">-        XposedBridge.log(throwable)
</a><a href="#h22-0-93" id="h22-0-93" class="i">+    fun debug(message: Any?, tag: String = TAG) = internalLog(tag, LogLevel.DEBUG, message)
</a><a href="#h22-0-94" id="h22-0-94" class="i">+
</a><a href="#h22-0-95" id="h22-0-95" class="i">+    fun error(message: Any?, tag: String = TAG) = internalLog(tag, LogLevel.ERROR, message)
</a><a href="#h22-0-96" id="h22-0-96" class="i">+
</a><a href="#h22-0-97" id="h22-0-97" class="i">+    fun error(message: Any?, throwable: Throwable, tag: String = TAG) {
</a><a href="#h22-0-98" id="h22-0-98" class="i">+        internalLog(tag, LogLevel.ERROR, message)
</a><a href="#h22-0-99" id="h22-0-99" class="i">+        internalLog(tag, LogLevel.ERROR, throwable)
</a>     }
<a href="#h22-0-101" id="h22-0-101" class="i">+
</a><a href="#h22-0-102" id="h22-0-102" class="i">+    fun info(message: Any?, tag: String = TAG) = internalLog(tag, LogLevel.INFO, message)
</a><a href="#h22-0-103" id="h22-0-103" class="i">+
</a><a href="#h22-0-104" id="h22-0-104" class="i">+    fun verbose(message: Any?, tag: String = TAG) = internalLog(tag, LogLevel.VERBOSE, message)
</a><a href="#h22-0-105" id="h22-0-105" class="i">+
</a><a href="#h22-0-106" id="h22-0-106" class="i">+    fun warn(message: Any?, tag: String = TAG) = internalLog(tag, LogLevel.WARN, message)
</a><a href="#h22-0-107" id="h22-0-107" class="i">+
</a><a href="#h22-0-108" id="h22-0-108" class="i">+    fun assert(message: Any?, tag: String = TAG) = internalLog(tag, LogLevel.ASSERT, message)
</a> } 
\ No newline at end of file
<b>diff --git a/<a id="h23" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/ModContext.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/ModContext.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/ModContext.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/ModContext.kt</a></b>
<a href="#h23-0" id="h23-0" class="h">@@ -11,13 +11,13 @@ import android.widget.Toast
</a> import com.google.gson.Gson
 import com.google.gson.GsonBuilder
 import kotlinx.coroutines.asCoroutineDispatcher
<a href="#h23-0-3" id="h23-0-3" class="d">-import me.rhunk.snapenhance.bridge.BridgeClient
</a><a href="#h23-0-4" id="h23-0-4" class="d">-import me.rhunk.snapenhance.bridge.wrapper.LocaleWrapper
</a><a href="#h23-0-5" id="h23-0-5" class="d">-import me.rhunk.snapenhance.bridge.wrapper.MappingsWrapper
</a><a href="#h23-0-6" id="h23-0-6" class="i">+import me.rhunk.snapenhance.core.bridge.BridgeClient
</a><a href="#h23-0-7" id="h23-0-7" class="i">+import me.rhunk.snapenhance.core.bridge.wrapper.LocaleWrapper
</a><a href="#h23-0-8" id="h23-0-8" class="i">+import me.rhunk.snapenhance.core.bridge.wrapper.MappingsWrapper
</a> import me.rhunk.snapenhance.core.config.ModConfig
<a href="#h23-0-10" id="h23-0-10" class="i">+import me.rhunk.snapenhance.core.database.DatabaseAccess
</a> import me.rhunk.snapenhance.core.eventbus.EventBus
 import me.rhunk.snapenhance.data.MessageSender
<a href="#h23-0-13" id="h23-0-13" class="d">-import me.rhunk.snapenhance.database.DatabaseAccess
</a> import me.rhunk.snapenhance.features.Feature
 import me.rhunk.snapenhance.manager.impl.ActionManager
 import me.rhunk.snapenhance.manager.impl.FeatureManager
<a href="#h23-1" id="h23-1" class="h">@@ -44,6 +44,7 @@ class ModContext {
</a> 
     private val modConfig = ModConfig()
     val config by modConfig
<a href="#h23-1-3" id="h23-1-3" class="i">+    val log by lazy { Logger(this.bridgeClient) }
</a>     val event = EventBus(this)
     val eventDispatcher = EventDispatcher(this)
     val native = NativeLib()
<a href="#h23-2" id="h23-2" class="h">@@ -81,13 +82,13 @@ class ModContext {
</a>         }
     }
 
<a href="#h23-2-3" id="h23-2-3" class="d">-    fun shortToast(message: Any) {
</a><a href="#h23-2-4" id="h23-2-4" class="i">+    fun shortToast(message: Any?) {
</a>         runOnUiThread {
             Toast.makeText(androidContext, message.toString(), Toast.LENGTH_SHORT).show()
         }
     }
 
<a href="#h23-2-10" id="h23-2-10" class="d">-    fun longToast(message: Any) {
</a><a href="#h23-2-11" id="h23-2-11" class="i">+    fun longToast(message: Any?) {
</a>         runOnUiThread {
             Toast.makeText(androidContext, message.toString(), Toast.LENGTH_LONG).show()
         }
<a href="#h23-3" id="h23-3" class="h">@@ -108,7 +109,7 @@ class ModContext {
</a>     }
 
     fun crash(message: String, throwable: Throwable? = null) {
<a href="#h23-3-3" id="h23-3-3" class="d">-        Logger.xposedLog(message, throwable)
</a><a href="#h23-3-4" id="h23-3-4" class="i">+        Logger.xposedLog(message, throwable ?: Exception())
</a>         longToast(message)
         delayForceCloseApp(100)
     }
<a href="#h23-4" id="h23-4" class="h">@@ -123,6 +124,7 @@ class ModContext {
</a>     }
 
     fun reloadConfig() {
<a href="#h23-4-3" id="h23-4-3" class="i">+        log.verbose(&quot;reloading config&quot;)
</a>         modConfig.loadFromBridge(bridgeClient)
         native.loadNativeConfig(
             NativeConfig(
<b>diff --git a/<a id="h24" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/SnapEnhance.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/SnapEnhance.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/SnapEnhance.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/SnapEnhance.kt</a></b>
<a href="#h24-0" id="h24-0" class="h">@@ -6,9 +6,9 @@ import android.content.Context
</a> import android.content.pm.PackageManager
 import kotlinx.coroutines.runBlocking
 import kotlinx.coroutines.withContext
<a href="#h24-0-3" id="h24-0-3" class="d">-import me.rhunk.snapenhance.bridge.BridgeClient
</a> import me.rhunk.snapenhance.bridge.SyncCallback
 import me.rhunk.snapenhance.core.BuildConfig
<a href="#h24-0-6" id="h24-0-6" class="i">+import me.rhunk.snapenhance.core.bridge.BridgeClient
</a> import me.rhunk.snapenhance.core.eventbus.events.impl.SnapWidgetBroadcastReceiveEvent
 import me.rhunk.snapenhance.core.eventbus.events.impl.UnaryCallEvent
 import me.rhunk.snapenhance.core.messaging.MessagingFriendInfo
<a href="#h24-1" id="h24-1" class="h">@@ -88,7 +88,7 @@ class SnapEnhance {
</a>                 return@hook
             }
 
<a href="#h24-1-3" id="h24-1-3" class="d">-            Logger.debug(&quot;Reloading config&quot;)
</a><a href="#h24-1-4" id="h24-1-4" class="i">+            appContext.actionManager.onNewIntent(activity.intent)
</a>             appContext.reloadConfig()
             syncRemote()
         }
<a href="#h24-2" id="h24-2" class="h">@@ -114,7 +114,7 @@ class SnapEnhance {
</a>                 syncRemote()
             }
         }.also { time -&gt;
<a href="#h24-2-3" id="h24-2-3" class="d">-            Logger.debug(&quot;init took $time&quot;)
</a><a href="#h24-2-4" id="h24-2-4" class="i">+            appContext.log.verbose(&quot;init took $time&quot;)
</a>         }
     }
 
<a href="#h24-3" id="h24-3" class="h">@@ -126,7 +126,7 @@ class SnapEnhance {
</a>                 actionManager.init()
             }
         }.also { time -&gt;
<a href="#h24-3-3" id="h24-3-3" class="d">-            Logger.debug(&quot;onActivityCreate took $time&quot;)
</a><a href="#h24-3-4" id="h24-3-4" class="i">+            appContext.log.verbose(&quot;onActivityCreate took $time&quot;)
</a>         }
     }
 
<a href="#h24-4" id="h24-4" class="h">@@ -149,7 +149,6 @@ class SnapEnhance {
</a>         val database = appContext.database
 
         appContext.executeAsync {
<a href="#h24-4-3" id="h24-4-3" class="d">-            Logger.debug(&quot;request remote sync&quot;)
</a>             appContext.bridgeClient.sync(object : SyncCallback.Stub() {
                 override fun syncFriend(uuid: String): String? {
                     return database.getFriendInfo(uuid)?.toJson()
<b>diff --git a/<a id="h25" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/action/AbstractAction.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/action/AbstractAction.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/action/AbstractAction.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/action/AbstractAction.kt</a></b>
<a href="#h25-0" id="h25-0" class="h">@@ -3,17 +3,10 @@ package me.rhunk.snapenhance.action
</a> import me.rhunk.snapenhance.ModContext
 import java.io.File
 
<a href="#h25-0-3" id="h25-0-3" class="d">-abstract class AbstractAction(
</a><a href="#h25-0-4" id="h25-0-4" class="d">-    val nameKey: String
</a><a href="#h25-0-5" id="h25-0-5" class="d">-) {
</a><a href="#h25-0-6" id="h25-0-6" class="i">+abstract class AbstractAction{
</a>     lateinit var context: ModContext
 
     /**
<a href="#h25-0-10" id="h25-0-10" class="d">-     * called on the main thread when the mod initialize
</a><a href="#h25-0-11" id="h25-0-11" class="d">-     */
</a><a href="#h25-0-12" id="h25-0-12" class="d">-    open fun init() {}
</a><a href="#h25-0-13" id="h25-0-13" class="d">-
</a><a href="#h25-0-14" id="h25-0-14" class="d">-    /**
</a>      * called when the action is triggered
      */
     open fun run() {}
<b>diff --git a/<a id="h26" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/action/EnumAction.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/action/EnumAction.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/action/EnumAction.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/action/EnumAction.kt</a></b>
<a href="#h26-0" id="h26-0" class="h">@@ -0,0 +1,17 @@
</a><a href="#h26-0-0" id="h26-0-0" class="i">+package me.rhunk.snapenhance.action
</a><a href="#h26-0-1" id="h26-0-1" class="i">+
</a><a href="#h26-0-2" id="h26-0-2" class="i">+import me.rhunk.snapenhance.action.impl.CleanCache
</a><a href="#h26-0-3" id="h26-0-3" class="i">+import me.rhunk.snapenhance.action.impl.ExportChatMessages
</a><a href="#h26-0-4" id="h26-0-4" class="i">+import me.rhunk.snapenhance.action.impl.OpenMap
</a><a href="#h26-0-5" id="h26-0-5" class="i">+import kotlin.reflect.KClass
</a><a href="#h26-0-6" id="h26-0-6" class="i">+
</a><a href="#h26-0-7" id="h26-0-7" class="i">+enum class EnumAction(
</a><a href="#h26-0-8" id="h26-0-8" class="i">+    val key: String,
</a><a href="#h26-0-9" id="h26-0-9" class="i">+    val clazz: KClass&lt;out AbstractAction&gt;,
</a><a href="#h26-0-10" id="h26-0-10" class="i">+    val exitOnFinish: Boolean = false,
</a><a href="#h26-0-11" id="h26-0-11" class="i">+    val isCritical: Boolean = false,
</a><a href="#h26-0-12" id="h26-0-12" class="i">+) {
</a><a href="#h26-0-13" id="h26-0-13" class="i">+    CLEAN_CACHE(&quot;clean_snapchat_cache&quot;, CleanCache::class, exitOnFinish = true),
</a><a href="#h26-0-14" id="h26-0-14" class="i">+    EXPORT_CHAT_MESSAGES(&quot;export_chat_messages&quot;, ExportChatMessages::class),
</a><a href="#h26-0-15" id="h26-0-15" class="i">+    OPEN_MAP(&quot;open_map&quot;, OpenMap::class);
</a><a href="#h26-0-16" id="h26-0-16" class="i">+}</a><a href="#h26-0-17" id="h26-0-17" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h27" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/action/impl/CheckForUpdates.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/action/impl/CheckForUpdates.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/action/impl/CheckForUpdates.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/action/impl/CheckForUpdates.kt</a></b>
<a href="#h27-0" id="h27-0" class="h">@@ -1,19 +0,0 @@
</a><a href="#h27-0-0" id="h27-0-0" class="d">-package me.rhunk.snapenhance.action.impl
</a><a href="#h27-0-1" id="h27-0-1" class="d">-
</a><a href="#h27-0-2" id="h27-0-2" class="d">-import me.rhunk.snapenhance.action.AbstractAction
</a><a href="#h27-0-3" id="h27-0-3" class="d">-import me.rhunk.snapenhance.features.impl.AutoUpdater
</a><a href="#h27-0-4" id="h27-0-4" class="d">-
</a><a href="#h27-0-5" id="h27-0-5" class="d">-class CheckForUpdates : AbstractAction(&quot;action.check_for_updates&quot;) {
</a><a href="#h27-0-6" id="h27-0-6" class="d">-    override fun run() {
</a><a href="#h27-0-7" id="h27-0-7" class="d">-        context.executeAsync {
</a><a href="#h27-0-8" id="h27-0-8" class="d">-            runCatching {
</a><a href="#h27-0-9" id="h27-0-9" class="d">-                val latestVersion = context.feature(AutoUpdater::class).checkForUpdates()
</a><a href="#h27-0-10" id="h27-0-10" class="d">-                if (latestVersion == null) {
</a><a href="#h27-0-11" id="h27-0-11" class="d">-                    context.longToast(context.translation[&quot;auto_updater.no_update_available&quot;])
</a><a href="#h27-0-12" id="h27-0-12" class="d">-                }
</a><a href="#h27-0-13" id="h27-0-13" class="d">-            }.onFailure {
</a><a href="#h27-0-14" id="h27-0-14" class="d">-                context.longToast(it.message ?: &quot;Failed to check for updates&quot;)
</a><a href="#h27-0-15" id="h27-0-15" class="d">-            }
</a><a href="#h27-0-16" id="h27-0-16" class="d">-        }
</a><a href="#h27-0-17" id="h27-0-17" class="d">-    }
</a><a href="#h27-0-18" id="h27-0-18" class="d">-}</a><a href="#h27-0-19" id="h27-0-19" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h28" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/action/impl/CleanCache.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/action/impl/CleanCache.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/action/impl/CleanCache.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/action/impl/CleanCache.kt</a></b>
<a href="#h28-0" id="h28-0" class="h">@@ -3,7 +3,7 @@ package me.rhunk.snapenhance.action.impl
</a> import me.rhunk.snapenhance.action.AbstractAction
 import java.io.File
 
<a href="#h28-0-3" id="h28-0-3" class="d">-class CleanCache : AbstractAction(&quot;action.clean_cache&quot;) {
</a><a href="#h28-0-4" id="h28-0-4" class="i">+class CleanCache : AbstractAction() {
</a>     companion object {
         private val FILES = arrayOf(
             &quot;files/mbgl-offline.db&quot;,
<a href="#h28-1" id="h28-1" class="h">@@ -22,7 +22,7 @@ class CleanCache : AbstractAction(&quot;action.clean_cache&quot;) {
</a>     }
 
     override fun run() {
<a href="#h28-1-3" id="h28-1-3" class="d">-        FILES.forEach {fileName -&gt;
</a><a href="#h28-1-4" id="h28-1-4" class="i">+        FILES.forEach { fileName -&gt;
</a>             val fileCache = File(context.androidContext.dataDir, fileName)
             if (fileName.endsWith(&quot;*&quot;)) {
                 val parent = fileCache.parentFile ?: throw IllegalStateException(&quot;Parent file is null&quot;)
<b>diff --git a/<a id="h29" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/action/impl/ClearMessageLogger.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/action/impl/ClearMessageLogger.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/action/impl/ClearMessageLogger.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/action/impl/ClearMessageLogger.kt</a></b>
<a href="#h29-0" id="h29-0" class="h">@@ -1,10 +0,0 @@
</a><a href="#h29-0-0" id="h29-0-0" class="d">-package me.rhunk.snapenhance.action.impl
</a><a href="#h29-0-1" id="h29-0-1" class="d">-
</a><a href="#h29-0-2" id="h29-0-2" class="d">-import me.rhunk.snapenhance.action.AbstractAction
</a><a href="#h29-0-3" id="h29-0-3" class="d">-
</a><a href="#h29-0-4" id="h29-0-4" class="d">-class ClearMessageLogger : AbstractAction(&quot;action.clear_message_logger&quot;) {
</a><a href="#h29-0-5" id="h29-0-5" class="d">-    override fun run() {
</a><a href="#h29-0-6" id="h29-0-6" class="d">-        context.bridgeClient.clearMessageLogger()
</a><a href="#h29-0-7" id="h29-0-7" class="d">-        context.shortToast(&quot;Message logger cleared&quot;)
</a><a href="#h29-0-8" id="h29-0-8" class="d">-    }
</a><a href="#h29-0-9" id="h29-0-9" class="d">-}</a><a href="#h29-0-10" id="h29-0-10" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h30" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/action/impl/ExportChatMessages.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/action/impl/ExportChatMessages.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/action/impl/ExportChatMessages.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/action/impl/ExportChatMessages.kt</a></b>
<a href="#h30-0" id="h30-0" class="h">@@ -14,10 +14,10 @@ import kotlinx.coroutines.launch
</a> import kotlinx.coroutines.suspendCancellableCoroutine
 import me.rhunk.snapenhance.Logger
 import me.rhunk.snapenhance.action.AbstractAction
<a href="#h30-0-3" id="h30-0-3" class="i">+import me.rhunk.snapenhance.core.database.objects.FriendFeedEntry
</a> import me.rhunk.snapenhance.data.ContentType
 import me.rhunk.snapenhance.data.wrapper.impl.Message
 import me.rhunk.snapenhance.data.wrapper.impl.SnapUUID
<a href="#h30-0-7" id="h30-0-7" class="d">-import me.rhunk.snapenhance.database.objects.FriendFeedEntry
</a> import me.rhunk.snapenhance.features.impl.Messaging
 import me.rhunk.snapenhance.ui.ViewAppearanceHelper
 import me.rhunk.snapenhance.util.CallbackBuilder
<a href="#h30-1" id="h30-1" class="h">@@ -26,7 +26,7 @@ import me.rhunk.snapenhance.util.export.MessageExporter
</a> import java.io.File
 
 @OptIn(DelicateCoroutinesApi::class)
<a href="#h30-1-3" id="h30-1-3" class="d">-class ExportChatMessages : AbstractAction(&quot;action.export_chat_messages&quot;) {
</a><a href="#h30-1-4" id="h30-1-4" class="i">+class ExportChatMessages : AbstractAction() {
</a>     private val callbackClass by lazy {  context.mappings.getMappedClass(&quot;callbacks&quot;, &quot;Callback&quot;) }
 
     private val fetchConversationWithMessagesCallbackClass by lazy {  context.mappings.getMappedClass(&quot;callbacks&quot;, &quot;FetchConversationWithMessagesCallback&quot;) }
<a href="#h30-2" id="h30-2" class="h">@@ -55,7 +55,7 @@ class ExportChatMessages : AbstractAction(&quot;action.export_chat_messages&quot;) {
</a>         context.runOnUiThread {
             if (dialogLogs.size &gt; 15) dialogLogs.removeAt(0)
             dialogLogs.add(message)
<a href="#h30-2-3" id="h30-2-3" class="d">-            Logger.debug(&quot;dialog: $message&quot;)
</a><a href="#h30-2-4" id="h30-2-4" class="i">+            context.log.debug(&quot;dialog: $message&quot;)
</a>             currentActionDialog!!.setMessage(dialogLogs.joinToString(&quot;\n&quot;))
         }
     }
<a href="#h30-3" id="h30-3" class="h">@@ -198,7 +198,6 @@ class ExportChatMessages : AbstractAction(&quot;action.export_chat_messages&quot;) {
</a>         }
 
         while (true) {
<a href="#h30-3-3" id="h30-3-3" class="d">-            Logger.debug(&quot;[$conversationName] fetching $lastMessageId&quot;)
</a>             val messages = fetchMessagesPaginated(conversationId, lastMessageId)
             if (messages.isEmpty()) break
             foundMessages.addAll(messages)
<a href="#h30-4" id="h30-4" class="h">@@ -224,7 +223,7 @@ class ExportChatMessages : AbstractAction(&quot;action.export_chat_messages&quot;) {
</a>                 it.readMessages(foundMessages)
             }.onFailure {
                 logDialog(context.translation.format(&quot;chat_export.export_failed&quot;,&quot;conversation&quot; to it.message.toString()))
<a href="#h30-4-3" id="h30-4-3" class="d">-                Logger.error(it)
</a><a href="#h30-4-4" id="h30-4-4" class="i">+                context.log.error(&quot;Failed to read messages&quot;, it)
</a>                 return
             }
         }.exportTo(exportType!!)
<b>diff --git a/<a id="h31" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/action/impl/OpenMap.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/action/impl/OpenMap.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/action/impl/OpenMap.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/action/impl/OpenMap.kt</a></b>
<a href="#h31-0" id="h31-0" class="h">@@ -5,7 +5,7 @@ import android.os.Bundle
</a> import me.rhunk.snapenhance.action.AbstractAction
 import me.rhunk.snapenhance.core.BuildConfig
 
<a href="#h31-0-3" id="h31-0-3" class="d">-class OpenMap: AbstractAction(&quot;action.open_map&quot;) {
</a><a href="#h31-0-4" id="h31-0-4" class="i">+class OpenMap: AbstractAction() {
</a>     override fun run() {
         context.runOnUiThread {
             val mapActivityIntent = Intent()
<b>diff --git a/<a id="h32" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/action/impl/RefreshMappings.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/action/impl/RefreshMappings.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/action/impl/RefreshMappings.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/action/impl/RefreshMappings.kt</a></b>
<a href="#h32-0" id="h32-0" class="h">@@ -1,11 +0,0 @@
</a><a href="#h32-0-0" id="h32-0-0" class="d">-package me.rhunk.snapenhance.action.impl
</a><a href="#h32-0-1" id="h32-0-1" class="d">-
</a><a href="#h32-0-2" id="h32-0-2" class="d">-import me.rhunk.snapenhance.action.AbstractAction
</a><a href="#h32-0-3" id="h32-0-3" class="d">-import me.rhunk.snapenhance.bridge.types.BridgeFileType
</a><a href="#h32-0-4" id="h32-0-4" class="d">-
</a><a href="#h32-0-5" id="h32-0-5" class="d">-class RefreshMappings : AbstractAction(&quot;action.refresh_mappings&quot;) {
</a><a href="#h32-0-6" id="h32-0-6" class="d">-    override fun run() {
</a><a href="#h32-0-7" id="h32-0-7" class="d">-        context.bridgeClient.deleteFile(BridgeFileType.MAPPINGS)
</a><a href="#h32-0-8" id="h32-0-8" class="d">-        context.softRestartApp()
</a><a href="#h32-0-9" id="h32-0-9" class="d">-    }
</a><a href="#h32-0-10" id="h32-0-10" class="d">-}</a><a href="#h32-0-11" id="h32-0-11" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h33" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/bridge/BridgeClient.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/bridge/BridgeClient.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/bridge/BridgeClient.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/bridge/BridgeClient.kt</a></b>
<a href="#h33-0" id="h33-0" class="h">@@ -1,145 +0,0 @@
</a><a href="#h33-0-0" id="h33-0-0" class="d">-package me.rhunk.snapenhance.bridge
</a><a href="#h33-0-1" id="h33-0-1" class="d">-
</a><a href="#h33-0-2" id="h33-0-2" class="d">-
</a><a href="#h33-0-3" id="h33-0-3" class="d">-import android.content.ComponentName
</a><a href="#h33-0-4" id="h33-0-4" class="d">-import android.content.Context
</a><a href="#h33-0-5" id="h33-0-5" class="d">-import android.content.Intent
</a><a href="#h33-0-6" id="h33-0-6" class="d">-import android.content.ServiceConnection
</a><a href="#h33-0-7" id="h33-0-7" class="d">-import android.os.Build
</a><a href="#h33-0-8" id="h33-0-8" class="d">-import android.os.Handler
</a><a href="#h33-0-9" id="h33-0-9" class="d">-import android.os.HandlerThread
</a><a href="#h33-0-10" id="h33-0-10" class="d">-import android.os.IBinder
</a><a href="#h33-0-11" id="h33-0-11" class="d">-import de.robv.android.xposed.XposedHelpers
</a><a href="#h33-0-12" id="h33-0-12" class="d">-import me.rhunk.snapenhance.Logger.xposedLog
</a><a href="#h33-0-13" id="h33-0-13" class="d">-import me.rhunk.snapenhance.ModContext
</a><a href="#h33-0-14" id="h33-0-14" class="d">-import me.rhunk.snapenhance.bridge.types.BridgeFileType
</a><a href="#h33-0-15" id="h33-0-15" class="d">-import me.rhunk.snapenhance.bridge.types.FileActionType
</a><a href="#h33-0-16" id="h33-0-16" class="d">-import me.rhunk.snapenhance.core.BuildConfig
</a><a href="#h33-0-17" id="h33-0-17" class="d">-import me.rhunk.snapenhance.core.messaging.MessagingRuleType
</a><a href="#h33-0-18" id="h33-0-18" class="d">-import me.rhunk.snapenhance.data.LocalePair
</a><a href="#h33-0-19" id="h33-0-19" class="d">-import java.util.concurrent.CompletableFuture
</a><a href="#h33-0-20" id="h33-0-20" class="d">-import java.util.concurrent.Executors
</a><a href="#h33-0-21" id="h33-0-21" class="d">-import kotlin.system.exitProcess
</a><a href="#h33-0-22" id="h33-0-22" class="d">-
</a><a href="#h33-0-23" id="h33-0-23" class="d">-
</a><a href="#h33-0-24" id="h33-0-24" class="d">-class BridgeClient(
</a><a href="#h33-0-25" id="h33-0-25" class="d">-    private val context: ModContext
</a><a href="#h33-0-26" id="h33-0-26" class="d">-):  ServiceConnection {
</a><a href="#h33-0-27" id="h33-0-27" class="d">-    private lateinit var future: CompletableFuture&lt;Boolean&gt;
</a><a href="#h33-0-28" id="h33-0-28" class="d">-    private lateinit var service: BridgeInterface
</a><a href="#h33-0-29" id="h33-0-29" class="d">-
</a><a href="#h33-0-30" id="h33-0-30" class="d">-    companion object {
</a><a href="#h33-0-31" id="h33-0-31" class="d">-        const val BRIDGE_SYNC_ACTION = &quot;me.rhunk.snapenhance.bridge.SYNC&quot;
</a><a href="#h33-0-32" id="h33-0-32" class="d">-    }
</a><a href="#h33-0-33" id="h33-0-33" class="d">-
</a><a href="#h33-0-34" id="h33-0-34" class="d">-    fun start(callback: (Boolean) -&gt; Unit) {
</a><a href="#h33-0-35" id="h33-0-35" class="d">-        this.future = CompletableFuture()
</a><a href="#h33-0-36" id="h33-0-36" class="d">-
</a><a href="#h33-0-37" id="h33-0-37" class="d">-        //TODO: randomize package name
</a><a href="#h33-0-38" id="h33-0-38" class="d">-        with(context.androidContext) {
</a><a href="#h33-0-39" id="h33-0-39" class="d">-            //ensure the remote process is running
</a><a href="#h33-0-40" id="h33-0-40" class="d">-            startActivity(Intent()
</a><a href="#h33-0-41" id="h33-0-41" class="d">-                .setClassName(BuildConfig.APPLICATION_ID, &quot;me.rhunk.snapenhance.bridge.ForceStartActivity&quot;)
</a><a href="#h33-0-42" id="h33-0-42" class="d">-                .addFlags(Intent.FLAG_ACTIVITY_NEW_TASK or Intent.FLAG_ACTIVITY_MULTIPLE_TASK)
</a><a href="#h33-0-43" id="h33-0-43" class="d">-            )
</a><a href="#h33-0-44" id="h33-0-44" class="d">-
</a><a href="#h33-0-45" id="h33-0-45" class="d">-            val intent = Intent()
</a><a href="#h33-0-46" id="h33-0-46" class="d">-                .setClassName(BuildConfig.APPLICATION_ID, &quot;me.rhunk.snapenhance.bridge.BridgeService&quot;)
</a><a href="#h33-0-47" id="h33-0-47" class="d">-            if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.Q) {
</a><a href="#h33-0-48" id="h33-0-48" class="d">-                bindService(
</a><a href="#h33-0-49" id="h33-0-49" class="d">-                    intent,
</a><a href="#h33-0-50" id="h33-0-50" class="d">-                    Context.BIND_AUTO_CREATE,
</a><a href="#h33-0-51" id="h33-0-51" class="d">-                    Executors.newSingleThreadExecutor(),
</a><a href="#h33-0-52" id="h33-0-52" class="d">-                    this@BridgeClient
</a><a href="#h33-0-53" id="h33-0-53" class="d">-                )
</a><a href="#h33-0-54" id="h33-0-54" class="d">-            } else {
</a><a href="#h33-0-55" id="h33-0-55" class="d">-                XposedHelpers.callMethod(
</a><a href="#h33-0-56" id="h33-0-56" class="d">-                    this,
</a><a href="#h33-0-57" id="h33-0-57" class="d">-                    &quot;bindServiceAsUser&quot;,
</a><a href="#h33-0-58" id="h33-0-58" class="d">-                    intent,
</a><a href="#h33-0-59" id="h33-0-59" class="d">-                    this@BridgeClient,
</a><a href="#h33-0-60" id="h33-0-60" class="d">-                    Context.BIND_AUTO_CREATE,
</a><a href="#h33-0-61" id="h33-0-61" class="d">-                    Handler(HandlerThread(&quot;BridgeClient&quot;).apply {
</a><a href="#h33-0-62" id="h33-0-62" class="d">-                        start()
</a><a href="#h33-0-63" id="h33-0-63" class="d">-                    }.looper),
</a><a href="#h33-0-64" id="h33-0-64" class="d">-                    android.os.Process.myUserHandle()
</a><a href="#h33-0-65" id="h33-0-65" class="d">-                )
</a><a href="#h33-0-66" id="h33-0-66" class="d">-            }
</a><a href="#h33-0-67" id="h33-0-67" class="d">-        }
</a><a href="#h33-0-68" id="h33-0-68" class="d">-        callback(future.get())
</a><a href="#h33-0-69" id="h33-0-69" class="d">-    }
</a><a href="#h33-0-70" id="h33-0-70" class="d">-
</a><a href="#h33-0-71" id="h33-0-71" class="d">-
</a><a href="#h33-0-72" id="h33-0-72" class="d">-    override fun onServiceConnected(name: ComponentName, service: IBinder) {
</a><a href="#h33-0-73" id="h33-0-73" class="d">-        this.service = BridgeInterface.Stub.asInterface(service)
</a><a href="#h33-0-74" id="h33-0-74" class="d">-        future.complete(true)
</a><a href="#h33-0-75" id="h33-0-75" class="d">-    }
</a><a href="#h33-0-76" id="h33-0-76" class="d">-
</a><a href="#h33-0-77" id="h33-0-77" class="d">-    override fun onNullBinding(name: ComponentName) {
</a><a href="#h33-0-78" id="h33-0-78" class="d">-        xposedLog(&quot;failed to connect to bridge service&quot;)
</a><a href="#h33-0-79" id="h33-0-79" class="d">-        exitProcess(1)
</a><a href="#h33-0-80" id="h33-0-80" class="d">-    }
</a><a href="#h33-0-81" id="h33-0-81" class="d">-
</a><a href="#h33-0-82" id="h33-0-82" class="d">-    override fun onServiceDisconnected(name: ComponentName) {
</a><a href="#h33-0-83" id="h33-0-83" class="d">-        exitProcess(0)
</a><a href="#h33-0-84" id="h33-0-84" class="d">-    }
</a><a href="#h33-0-85" id="h33-0-85" class="d">-
</a><a href="#h33-0-86" id="h33-0-86" class="d">-    fun createAndReadFile(
</a><a href="#h33-0-87" id="h33-0-87" class="d">-        fileType: BridgeFileType,
</a><a href="#h33-0-88" id="h33-0-88" class="d">-        defaultContent: ByteArray
</a><a href="#h33-0-89" id="h33-0-89" class="d">-    ): ByteArray = service.fileOperation(FileActionType.CREATE_AND_READ.ordinal, fileType.value, defaultContent)
</a><a href="#h33-0-90" id="h33-0-90" class="d">-
</a><a href="#h33-0-91" id="h33-0-91" class="d">-    fun readFile(fileType: BridgeFileType): ByteArray = service.fileOperation(FileActionType.READ.ordinal, fileType.value, null)
</a><a href="#h33-0-92" id="h33-0-92" class="d">-
</a><a href="#h33-0-93" id="h33-0-93" class="d">-    fun writeFile(
</a><a href="#h33-0-94" id="h33-0-94" class="d">-        fileType: BridgeFileType,
</a><a href="#h33-0-95" id="h33-0-95" class="d">-        content: ByteArray?
</a><a href="#h33-0-96" id="h33-0-96" class="d">-    ) { service.fileOperation(FileActionType.WRITE.ordinal, fileType.value, content) }
</a><a href="#h33-0-97" id="h33-0-97" class="d">-
</a><a href="#h33-0-98" id="h33-0-98" class="d">-    fun deleteFile(fileType: BridgeFileType) { service.fileOperation(FileActionType.DELETE.ordinal, fileType.value, null) }
</a><a href="#h33-0-99" id="h33-0-99" class="d">-
</a><a href="#h33-0-100" id="h33-0-100" class="d">-    fun isFileExists(fileType: BridgeFileType) = service.fileOperation(FileActionType.EXISTS.ordinal, fileType.value, null).isNotEmpty()
</a><a href="#h33-0-101" id="h33-0-101" class="d">-
</a><a href="#h33-0-102" id="h33-0-102" class="d">-    fun getLoggedMessageIds(conversationId: String, limit: Int): LongArray = service.getLoggedMessageIds(conversationId, limit)
</a><a href="#h33-0-103" id="h33-0-103" class="d">-
</a><a href="#h33-0-104" id="h33-0-104" class="d">-    fun getMessageLoggerMessage(conversationId: String, id: Long): ByteArray? = service.getMessageLoggerMessage(conversationId, id)
</a><a href="#h33-0-105" id="h33-0-105" class="d">-
</a><a href="#h33-0-106" id="h33-0-106" class="d">-    fun addMessageLoggerMessage(conversationId: String, id: Long, message: ByteArray) = service.addMessageLoggerMessage(conversationId, id, message)
</a><a href="#h33-0-107" id="h33-0-107" class="d">-
</a><a href="#h33-0-108" id="h33-0-108" class="d">-    fun deleteMessageLoggerMessage(conversationId: String, id: Long) = service.deleteMessageLoggerMessage(conversationId, id)
</a><a href="#h33-0-109" id="h33-0-109" class="d">-
</a><a href="#h33-0-110" id="h33-0-110" class="d">-    fun clearMessageLogger() = service.clearMessageLogger()
</a><a href="#h33-0-111" id="h33-0-111" class="d">-
</a><a href="#h33-0-112" id="h33-0-112" class="d">-    fun fetchLocales(userLocale: String) = service.fetchLocales(userLocale).map {
</a><a href="#h33-0-113" id="h33-0-113" class="d">-        LocalePair(it.key, it.value)
</a><a href="#h33-0-114" id="h33-0-114" class="d">-    }
</a><a href="#h33-0-115" id="h33-0-115" class="d">-
</a><a href="#h33-0-116" id="h33-0-116" class="d">-    fun getApplicationApkPath() = service.getApplicationApkPath()
</a><a href="#h33-0-117" id="h33-0-117" class="d">-
</a><a href="#h33-0-118" id="h33-0-118" class="d">-    fun getAutoUpdaterTime(): Long {
</a><a href="#h33-0-119" id="h33-0-119" class="d">-        createAndReadFile(BridgeFileType.AUTO_UPDATER_TIMESTAMP, &quot;0&quot;.toByteArray()).run {
</a><a href="#h33-0-120" id="h33-0-120" class="d">-            return if (isEmpty()) {
</a><a href="#h33-0-121" id="h33-0-121" class="d">-                0
</a><a href="#h33-0-122" id="h33-0-122" class="d">-            } else {
</a><a href="#h33-0-123" id="h33-0-123" class="d">-                String(this).toLong()
</a><a href="#h33-0-124" id="h33-0-124" class="d">-            }
</a><a href="#h33-0-125" id="h33-0-125" class="d">-        }
</a><a href="#h33-0-126" id="h33-0-126" class="d">-    }
</a><a href="#h33-0-127" id="h33-0-127" class="d">-
</a><a href="#h33-0-128" id="h33-0-128" class="d">-    fun setAutoUpdaterTime(time: Long) {
</a><a href="#h33-0-129" id="h33-0-129" class="d">-        writeFile(BridgeFileType.AUTO_UPDATER_TIMESTAMP, time.toString().toByteArray())
</a><a href="#h33-0-130" id="h33-0-130" class="d">-    }
</a><a href="#h33-0-131" id="h33-0-131" class="d">-
</a><a href="#h33-0-132" id="h33-0-132" class="d">-    fun enqueueDownload(intent: Intent, callback: DownloadCallback) = service.enqueueDownload(intent, callback)
</a><a href="#h33-0-133" id="h33-0-133" class="d">-
</a><a href="#h33-0-134" id="h33-0-134" class="d">-    fun sync(callback: SyncCallback) = service.sync(callback)
</a><a href="#h33-0-135" id="h33-0-135" class="d">-
</a><a href="#h33-0-136" id="h33-0-136" class="d">-    fun passGroupsAndFriends(groups: List&lt;String&gt;, friends: List&lt;String&gt;) = service.passGroupsAndFriends(groups, friends)
</a><a href="#h33-0-137" id="h33-0-137" class="d">-
</a><a href="#h33-0-138" id="h33-0-138" class="d">-    fun getRules(targetUuid: String): List&lt;MessagingRuleType&gt; {
</a><a href="#h33-0-139" id="h33-0-139" class="d">-        return service.getRules(targetUuid).map { MessagingRuleType.getByName(it) }
</a><a href="#h33-0-140" id="h33-0-140" class="d">-    }
</a><a href="#h33-0-141" id="h33-0-141" class="d">-
</a><a href="#h33-0-142" id="h33-0-142" class="d">-    fun setRule(targetUuid: String, type: MessagingRuleType, state: Boolean)
</a><a href="#h33-0-143" id="h33-0-143" class="d">-        = service.setRule(targetUuid, type.key, state)
</a><a href="#h33-0-144" id="h33-0-144" class="d">-}
</a><b>diff --git a/<a id="h34" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/bridge/FileLoaderWrapper.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/bridge/FileLoaderWrapper.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/bridge/FileLoaderWrapper.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/bridge/FileLoaderWrapper.kt</a></b>
<a href="#h34-0" id="h34-0" class="h">@@ -1,35 +0,0 @@
</a><a href="#h34-0-0" id="h34-0-0" class="d">-package me.rhunk.snapenhance.bridge
</a><a href="#h34-0-1" id="h34-0-1" class="d">-
</a><a href="#h34-0-2" id="h34-0-2" class="d">-import android.content.Context
</a><a href="#h34-0-3" id="h34-0-3" class="d">-import me.rhunk.snapenhance.bridge.types.BridgeFileType
</a><a href="#h34-0-4" id="h34-0-4" class="d">-
</a><a href="#h34-0-5" id="h34-0-5" class="d">-open class FileLoaderWrapper(
</a><a href="#h34-0-6" id="h34-0-6" class="d">-    private val fileType: BridgeFileType,
</a><a href="#h34-0-7" id="h34-0-7" class="d">-    private val defaultContent: ByteArray
</a><a href="#h34-0-8" id="h34-0-8" class="d">-) {
</a><a href="#h34-0-9" id="h34-0-9" class="d">-    lateinit var isFileExists: () -&gt; Boolean
</a><a href="#h34-0-10" id="h34-0-10" class="d">-    lateinit var write: (ByteArray) -&gt; Unit
</a><a href="#h34-0-11" id="h34-0-11" class="d">-    lateinit var read: () -&gt; ByteArray
</a><a href="#h34-0-12" id="h34-0-12" class="d">-    lateinit var delete: () -&gt; Unit
</a><a href="#h34-0-13" id="h34-0-13" class="d">-
</a><a href="#h34-0-14" id="h34-0-14" class="d">-    fun loadFromContext(context: Context) {
</a><a href="#h34-0-15" id="h34-0-15" class="d">-        val file = fileType.resolve(context)
</a><a href="#h34-0-16" id="h34-0-16" class="d">-        isFileExists = { file.exists() }
</a><a href="#h34-0-17" id="h34-0-17" class="d">-        read = {
</a><a href="#h34-0-18" id="h34-0-18" class="d">-            if (!file.exists()) {
</a><a href="#h34-0-19" id="h34-0-19" class="d">-                file.createNewFile()
</a><a href="#h34-0-20" id="h34-0-20" class="d">-                file.writeBytes(&quot;{}&quot;.toByteArray(Charsets.UTF_8))
</a><a href="#h34-0-21" id="h34-0-21" class="d">-            }
</a><a href="#h34-0-22" id="h34-0-22" class="d">-            file.readBytes()
</a><a href="#h34-0-23" id="h34-0-23" class="d">-        }
</a><a href="#h34-0-24" id="h34-0-24" class="d">-        write = { file.writeBytes(it) }
</a><a href="#h34-0-25" id="h34-0-25" class="d">-        delete = { file.delete() }
</a><a href="#h34-0-26" id="h34-0-26" class="d">-    }
</a><a href="#h34-0-27" id="h34-0-27" class="d">-
</a><a href="#h34-0-28" id="h34-0-28" class="d">-    fun loadFromBridge(bridgeClient: BridgeClient) {
</a><a href="#h34-0-29" id="h34-0-29" class="d">-        isFileExists = { bridgeClient.isFileExists(fileType) }
</a><a href="#h34-0-30" id="h34-0-30" class="d">-        read = { bridgeClient.createAndReadFile(fileType, defaultContent) }
</a><a href="#h34-0-31" id="h34-0-31" class="d">-        write = { bridgeClient.writeFile(fileType, it) }
</a><a href="#h34-0-32" id="h34-0-32" class="d">-        delete = { bridgeClient.deleteFile(fileType) }
</a><a href="#h34-0-33" id="h34-0-33" class="d">-    }
</a><a href="#h34-0-34" id="h34-0-34" class="d">-}</a><a href="#h34-0-35" id="h34-0-35" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h35" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/bridge/types/BridgeFileType.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/bridge/types/BridgeFileType.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/bridge/types/BridgeFileType.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/bridge/types/BridgeFileType.kt</a></b>
<a href="#h35-0" id="h35-0" class="h">@@ -1,25 +0,0 @@
</a><a href="#h35-0-0" id="h35-0-0" class="d">-package me.rhunk.snapenhance.bridge.types
</a><a href="#h35-0-1" id="h35-0-1" class="d">-
</a><a href="#h35-0-2" id="h35-0-2" class="d">-import android.content.Context
</a><a href="#h35-0-3" id="h35-0-3" class="d">-import java.io.File
</a><a href="#h35-0-4" id="h35-0-4" class="d">-
</a><a href="#h35-0-5" id="h35-0-5" class="d">-
</a><a href="#h35-0-6" id="h35-0-6" class="d">-enum class BridgeFileType(val value: Int, val fileName: String, val displayName: String, private val isDatabase: Boolean = false) {
</a><a href="#h35-0-7" id="h35-0-7" class="d">-    CONFIG(0, &quot;config.json&quot;, &quot;Config&quot;),
</a><a href="#h35-0-8" id="h35-0-8" class="d">-    MAPPINGS(1, &quot;mappings.json&quot;, &quot;Mappings&quot;),
</a><a href="#h35-0-9" id="h35-0-9" class="d">-    MESSAGE_LOGGER_DATABASE(2, &quot;message_logger.db&quot;, &quot;Message Logger&quot;,true),
</a><a href="#h35-0-10" id="h35-0-10" class="d">-    AUTO_UPDATER_TIMESTAMP(3, &quot;auto_updater_timestamp.txt&quot;, &quot;Auto Updater Timestamp&quot;),
</a><a href="#h35-0-11" id="h35-0-11" class="d">-    PINNED_CONVERSATIONS(4, &quot;pinned_conversations.txt&quot;, &quot;Pinned Conversations&quot;);
</a><a href="#h35-0-12" id="h35-0-12" class="d">-
</a><a href="#h35-0-13" id="h35-0-13" class="d">-    fun resolve(context: Context): File = if (isDatabase) {
</a><a href="#h35-0-14" id="h35-0-14" class="d">-        context.getDatabasePath(fileName)
</a><a href="#h35-0-15" id="h35-0-15" class="d">-    } else {
</a><a href="#h35-0-16" id="h35-0-16" class="d">-        File(context.filesDir, fileName)
</a><a href="#h35-0-17" id="h35-0-17" class="d">-    }
</a><a href="#h35-0-18" id="h35-0-18" class="d">-
</a><a href="#h35-0-19" id="h35-0-19" class="d">-    companion object {
</a><a href="#h35-0-20" id="h35-0-20" class="d">-        fun fromValue(value: Int): BridgeFileType? {
</a><a href="#h35-0-21" id="h35-0-21" class="d">-            return values().firstOrNull { it.value == value }
</a><a href="#h35-0-22" id="h35-0-22" class="d">-        }
</a><a href="#h35-0-23" id="h35-0-23" class="d">-    }
</a><a href="#h35-0-24" id="h35-0-24" class="d">-}</a><a href="#h35-0-25" id="h35-0-25" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h36" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/bridge/types/FileActionType.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/bridge/types/FileActionType.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/bridge/types/FileActionType.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/bridge/types/FileActionType.kt</a></b>
<a href="#h36-0" id="h36-0" class="h">@@ -1,5 +0,0 @@
</a><a href="#h36-0-0" id="h36-0-0" class="d">-package me.rhunk.snapenhance.bridge.types
</a><a href="#h36-0-1" id="h36-0-1" class="d">-
</a><a href="#h36-0-2" id="h36-0-2" class="d">-enum class FileActionType {
</a><a href="#h36-0-3" id="h36-0-3" class="d">-    CREATE_AND_READ, READ, WRITE, DELETE, EXISTS
</a><a href="#h36-0-4" id="h36-0-4" class="d">-}</a><a href="#h36-0-5" id="h36-0-5" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h37" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/bridge/wrapper/LocaleWrapper.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/bridge/wrapper/LocaleWrapper.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/bridge/wrapper/LocaleWrapper.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/bridge/wrapper/LocaleWrapper.kt</a></b>
<a href="#h37-0" id="h37-0" class="h">@@ -1,100 +0,0 @@
</a><a href="#h37-0-0" id="h37-0-0" class="d">-package me.rhunk.snapenhance.bridge.wrapper
</a><a href="#h37-0-1" id="h37-0-1" class="d">-
</a><a href="#h37-0-2" id="h37-0-2" class="d">-import android.content.Context
</a><a href="#h37-0-3" id="h37-0-3" class="d">-import com.google.gson.JsonObject
</a><a href="#h37-0-4" id="h37-0-4" class="d">-import com.google.gson.JsonParser
</a><a href="#h37-0-5" id="h37-0-5" class="d">-import me.rhunk.snapenhance.Logger
</a><a href="#h37-0-6" id="h37-0-6" class="d">-import me.rhunk.snapenhance.bridge.BridgeClient
</a><a href="#h37-0-7" id="h37-0-7" class="d">-import me.rhunk.snapenhance.data.LocalePair
</a><a href="#h37-0-8" id="h37-0-8" class="d">-import java.util.Locale
</a><a href="#h37-0-9" id="h37-0-9" class="d">-
</a><a href="#h37-0-10" id="h37-0-10" class="d">-
</a><a href="#h37-0-11" id="h37-0-11" class="d">-class LocaleWrapper {
</a><a href="#h37-0-12" id="h37-0-12" class="d">-    companion object {
</a><a href="#h37-0-13" id="h37-0-13" class="d">-        const val DEFAULT_LOCALE = &quot;en_US&quot;
</a><a href="#h37-0-14" id="h37-0-14" class="d">-
</a><a href="#h37-0-15" id="h37-0-15" class="d">-        fun fetchLocales(context: Context, locale: String = DEFAULT_LOCALE): List&lt;LocalePair&gt; {
</a><a href="#h37-0-16" id="h37-0-16" class="d">-            val locales = mutableListOf&lt;LocalePair&gt;().apply {
</a><a href="#h37-0-17" id="h37-0-17" class="d">-                add(LocalePair(DEFAULT_LOCALE, context.resources.assets.open(&quot;lang/$DEFAULT_LOCALE.json&quot;).bufferedReader().use { it.readText() }))
</a><a href="#h37-0-18" id="h37-0-18" class="d">-            }
</a><a href="#h37-0-19" id="h37-0-19" class="d">-
</a><a href="#h37-0-20" id="h37-0-20" class="d">-            if (locale == DEFAULT_LOCALE) return locales
</a><a href="#h37-0-21" id="h37-0-21" class="d">-
</a><a href="#h37-0-22" id="h37-0-22" class="d">-            val compatibleLocale = context.resources.assets.list(&quot;lang&quot;)?.firstOrNull { it.startsWith(locale) }?.substring(0, 5) ?: return locales
</a><a href="#h37-0-23" id="h37-0-23" class="d">-
</a><a href="#h37-0-24" id="h37-0-24" class="d">-            context.resources.assets.open(&quot;lang/$compatibleLocale.json&quot;).use { inputStream -&gt;
</a><a href="#h37-0-25" id="h37-0-25" class="d">-                locales.add(LocalePair(compatibleLocale, inputStream.bufferedReader().use { it.readText() }))
</a><a href="#h37-0-26" id="h37-0-26" class="d">-            }
</a><a href="#h37-0-27" id="h37-0-27" class="d">-
</a><a href="#h37-0-28" id="h37-0-28" class="d">-            return locales
</a><a href="#h37-0-29" id="h37-0-29" class="d">-        }
</a><a href="#h37-0-30" id="h37-0-30" class="d">-
</a><a href="#h37-0-31" id="h37-0-31" class="d">-        fun fetchAvailableLocales(context: Context): List&lt;String&gt; {
</a><a href="#h37-0-32" id="h37-0-32" class="d">-            return context.resources.assets.list(&quot;lang&quot;)?.map { it.substring(0, 5) } ?: listOf()
</a><a href="#h37-0-33" id="h37-0-33" class="d">-        }
</a><a href="#h37-0-34" id="h37-0-34" class="d">-    }
</a><a href="#h37-0-35" id="h37-0-35" class="d">-
</a><a href="#h37-0-36" id="h37-0-36" class="d">-    var userLocale = DEFAULT_LOCALE
</a><a href="#h37-0-37" id="h37-0-37" class="d">-
</a><a href="#h37-0-38" id="h37-0-38" class="d">-    private val translationMap = linkedMapOf&lt;String, String&gt;()
</a><a href="#h37-0-39" id="h37-0-39" class="d">-
</a><a href="#h37-0-40" id="h37-0-40" class="d">-    lateinit var loadedLocale: Locale
</a><a href="#h37-0-41" id="h37-0-41" class="d">-
</a><a href="#h37-0-42" id="h37-0-42" class="d">-    private fun load(localePair: LocalePair) {
</a><a href="#h37-0-43" id="h37-0-43" class="d">-        loadedLocale = localePair.locale.let { Locale(it.substring(0, 2), it.substring(3, 5)) }
</a><a href="#h37-0-44" id="h37-0-44" class="d">-
</a><a href="#h37-0-45" id="h37-0-45" class="d">-        val translations = JsonParser.parseString(localePair.content).asJsonObject
</a><a href="#h37-0-46" id="h37-0-46" class="d">-        if (translations == null || translations.isJsonNull) {
</a><a href="#h37-0-47" id="h37-0-47" class="d">-            return
</a><a href="#h37-0-48" id="h37-0-48" class="d">-        }
</a><a href="#h37-0-49" id="h37-0-49" class="d">-
</a><a href="#h37-0-50" id="h37-0-50" class="d">-        fun scanObject(jsonObject: JsonObject, prefix: String = &quot;&quot;) {
</a><a href="#h37-0-51" id="h37-0-51" class="d">-            jsonObject.entrySet().forEach {
</a><a href="#h37-0-52" id="h37-0-52" class="d">-                if (it.value.isJsonPrimitive) {
</a><a href="#h37-0-53" id="h37-0-53" class="d">-                    val key = &quot;$prefix${it.key}&quot;
</a><a href="#h37-0-54" id="h37-0-54" class="d">-                    translationMap[key] = it.value.asString
</a><a href="#h37-0-55" id="h37-0-55" class="d">-                }
</a><a href="#h37-0-56" id="h37-0-56" class="d">-                if (!it.value.isJsonObject) return@forEach
</a><a href="#h37-0-57" id="h37-0-57" class="d">-                scanObject(it.value.asJsonObject, &quot;$prefix${it.key}.&quot;)
</a><a href="#h37-0-58" id="h37-0-58" class="d">-            }
</a><a href="#h37-0-59" id="h37-0-59" class="d">-        }
</a><a href="#h37-0-60" id="h37-0-60" class="d">-
</a><a href="#h37-0-61" id="h37-0-61" class="d">-        scanObject(translations)
</a><a href="#h37-0-62" id="h37-0-62" class="d">-    }
</a><a href="#h37-0-63" id="h37-0-63" class="d">-
</a><a href="#h37-0-64" id="h37-0-64" class="d">-    fun loadFromBridge(bridgeClient: BridgeClient) {
</a><a href="#h37-0-65" id="h37-0-65" class="d">-        bridgeClient.fetchLocales(userLocale).forEach {
</a><a href="#h37-0-66" id="h37-0-66" class="d">-            load(it)
</a><a href="#h37-0-67" id="h37-0-67" class="d">-        }
</a><a href="#h37-0-68" id="h37-0-68" class="d">-    }
</a><a href="#h37-0-69" id="h37-0-69" class="d">-
</a><a href="#h37-0-70" id="h37-0-70" class="d">-    fun loadFromContext(context: Context) {
</a><a href="#h37-0-71" id="h37-0-71" class="d">-        fetchLocales(context, userLocale).forEach {
</a><a href="#h37-0-72" id="h37-0-72" class="d">-            load(it)
</a><a href="#h37-0-73" id="h37-0-73" class="d">-        }
</a><a href="#h37-0-74" id="h37-0-74" class="d">-    }
</a><a href="#h37-0-75" id="h37-0-75" class="d">-
</a><a href="#h37-0-76" id="h37-0-76" class="d">-    fun reloadFromContext(context: Context, locale: String) {
</a><a href="#h37-0-77" id="h37-0-77" class="d">-        userLocale = locale
</a><a href="#h37-0-78" id="h37-0-78" class="d">-        translationMap.clear()
</a><a href="#h37-0-79" id="h37-0-79" class="d">-        loadFromContext(context)
</a><a href="#h37-0-80" id="h37-0-80" class="d">-    }
</a><a href="#h37-0-81" id="h37-0-81" class="d">-
</a><a href="#h37-0-82" id="h37-0-82" class="d">-    operator fun get(key: String) = translationMap[key] ?: key.also { Logger.debug(&quot;Missing translation for $key&quot;) }
</a><a href="#h37-0-83" id="h37-0-83" class="d">-
</a><a href="#h37-0-84" id="h37-0-84" class="d">-    fun format(key: String, vararg args: Pair&lt;String, String&gt;): String {
</a><a href="#h37-0-85" id="h37-0-85" class="d">-        return args.fold(get(key)) { acc, pair -&gt;
</a><a href="#h37-0-86" id="h37-0-86" class="d">-            acc.replace(&quot;{${pair.first}}&quot;, pair.second)
</a><a href="#h37-0-87" id="h37-0-87" class="d">-        }
</a><a href="#h37-0-88" id="h37-0-88" class="d">-    }
</a><a href="#h37-0-89" id="h37-0-89" class="d">-
</a><a href="#h37-0-90" id="h37-0-90" class="d">-    fun getCategory(key: String): LocaleWrapper {
</a><a href="#h37-0-91" id="h37-0-91" class="d">-        return LocaleWrapper().apply {
</a><a href="#h37-0-92" id="h37-0-92" class="d">-            translationMap.putAll(
</a><a href="#h37-0-93" id="h37-0-93" class="d">-                this@LocaleWrapper.translationMap
</a><a href="#h37-0-94" id="h37-0-94" class="d">-                    .filterKeys { it.startsWith(&quot;$key.&quot;) }
</a><a href="#h37-0-95" id="h37-0-95" class="d">-                    .mapKeys { it.key.substring(key.length + 1) }
</a><a href="#h37-0-96" id="h37-0-96" class="d">-            )
</a><a href="#h37-0-97" id="h37-0-97" class="d">-        }
</a><a href="#h37-0-98" id="h37-0-98" class="d">-    }
</a><a href="#h37-0-99" id="h37-0-99" class="d">-}</a><a href="#h37-0-100" id="h37-0-100" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h38" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/bridge/wrapper/MappingsWrapper.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/bridge/wrapper/MappingsWrapper.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/bridge/wrapper/MappingsWrapper.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/bridge/wrapper/MappingsWrapper.kt</a></b>
<a href="#h38-0" id="h38-0" class="h">@@ -1,165 +0,0 @@
</a><a href="#h38-0-0" id="h38-0-0" class="d">-package me.rhunk.snapenhance.bridge.wrapper
</a><a href="#h38-0-1" id="h38-0-1" class="d">-
</a><a href="#h38-0-2" id="h38-0-2" class="d">-import android.content.Context
</a><a href="#h38-0-3" id="h38-0-3" class="d">-import com.google.gson.GsonBuilder
</a><a href="#h38-0-4" id="h38-0-4" class="d">-import com.google.gson.JsonElement
</a><a href="#h38-0-5" id="h38-0-5" class="d">-import com.google.gson.JsonParser
</a><a href="#h38-0-6" id="h38-0-6" class="d">-import me.rhunk.snapenhance.Constants
</a><a href="#h38-0-7" id="h38-0-7" class="d">-import me.rhunk.snapenhance.Logger
</a><a href="#h38-0-8" id="h38-0-8" class="d">-import me.rhunk.snapenhance.bridge.FileLoaderWrapper
</a><a href="#h38-0-9" id="h38-0-9" class="d">-import me.rhunk.snapenhance.bridge.types.BridgeFileType
</a><a href="#h38-0-10" id="h38-0-10" class="d">-import me.rhunk.snapmapper.Mapper
</a><a href="#h38-0-11" id="h38-0-11" class="d">-import me.rhunk.snapmapper.impl.BCryptClassMapper
</a><a href="#h38-0-12" id="h38-0-12" class="d">-import me.rhunk.snapmapper.impl.CallbackMapper
</a><a href="#h38-0-13" id="h38-0-13" class="d">-import me.rhunk.snapmapper.impl.CompositeConfigurationProviderMapper
</a><a href="#h38-0-14" id="h38-0-14" class="d">-import me.rhunk.snapmapper.impl.DefaultMediaItemMapper
</a><a href="#h38-0-15" id="h38-0-15" class="d">-import me.rhunk.snapmapper.impl.EnumMapper
</a><a href="#h38-0-16" id="h38-0-16" class="d">-import me.rhunk.snapmapper.impl.FriendsFeedEventDispatcherMapper
</a><a href="#h38-0-17" id="h38-0-17" class="d">-import me.rhunk.snapmapper.impl.MediaQualityLevelProviderMapper
</a><a href="#h38-0-18" id="h38-0-18" class="d">-import me.rhunk.snapmapper.impl.OperaPageViewControllerMapper
</a><a href="#h38-0-19" id="h38-0-19" class="d">-import me.rhunk.snapmapper.impl.PlatformAnalyticsCreatorMapper
</a><a href="#h38-0-20" id="h38-0-20" class="d">-import me.rhunk.snapmapper.impl.PlusSubscriptionMapper
</a><a href="#h38-0-21" id="h38-0-21" class="d">-import me.rhunk.snapmapper.impl.ScCameraSettingsMapper
</a><a href="#h38-0-22" id="h38-0-22" class="d">-import me.rhunk.snapmapper.impl.ScoreUpdateMapper
</a><a href="#h38-0-23" id="h38-0-23" class="d">-import me.rhunk.snapmapper.impl.StoryBoostStateMapper
</a><a href="#h38-0-24" id="h38-0-24" class="d">-import java.util.concurrent.ConcurrentHashMap
</a><a href="#h38-0-25" id="h38-0-25" class="d">-import kotlin.system.measureTimeMillis
</a><a href="#h38-0-26" id="h38-0-26" class="d">-
</a><a href="#h38-0-27" id="h38-0-27" class="d">-class MappingsWrapper : FileLoaderWrapper(BridgeFileType.MAPPINGS, &quot;{}&quot;.toByteArray(Charsets.UTF_8)) {
</a><a href="#h38-0-28" id="h38-0-28" class="d">-    companion object {
</a><a href="#h38-0-29" id="h38-0-29" class="d">-        private val gson = GsonBuilder().setPrettyPrinting().create()
</a><a href="#h38-0-30" id="h38-0-30" class="d">-        private val mappers = arrayOf(
</a><a href="#h38-0-31" id="h38-0-31" class="d">-            BCryptClassMapper::class,
</a><a href="#h38-0-32" id="h38-0-32" class="d">-            CallbackMapper::class,
</a><a href="#h38-0-33" id="h38-0-33" class="d">-            DefaultMediaItemMapper::class,
</a><a href="#h38-0-34" id="h38-0-34" class="d">-            MediaQualityLevelProviderMapper::class,
</a><a href="#h38-0-35" id="h38-0-35" class="d">-            EnumMapper::class,
</a><a href="#h38-0-36" id="h38-0-36" class="d">-            OperaPageViewControllerMapper::class,
</a><a href="#h38-0-37" id="h38-0-37" class="d">-            PlatformAnalyticsCreatorMapper::class,
</a><a href="#h38-0-38" id="h38-0-38" class="d">-            PlusSubscriptionMapper::class,
</a><a href="#h38-0-39" id="h38-0-39" class="d">-            ScCameraSettingsMapper::class,
</a><a href="#h38-0-40" id="h38-0-40" class="d">-            StoryBoostStateMapper::class,
</a><a href="#h38-0-41" id="h38-0-41" class="d">-            FriendsFeedEventDispatcherMapper::class,
</a><a href="#h38-0-42" id="h38-0-42" class="d">-            CompositeConfigurationProviderMapper::class,
</a><a href="#h38-0-43" id="h38-0-43" class="d">-            ScoreUpdateMapper::class
</a><a href="#h38-0-44" id="h38-0-44" class="d">-        )
</a><a href="#h38-0-45" id="h38-0-45" class="d">-    }
</a><a href="#h38-0-46" id="h38-0-46" class="d">-
</a><a href="#h38-0-47" id="h38-0-47" class="d">-    private lateinit var context: Context
</a><a href="#h38-0-48" id="h38-0-48" class="d">-
</a><a href="#h38-0-49" id="h38-0-49" class="d">-    private val mappings = ConcurrentHashMap&lt;String, Any&gt;()
</a><a href="#h38-0-50" id="h38-0-50" class="d">-    private var snapBuildNumber: Long = 0
</a><a href="#h38-0-51" id="h38-0-51" class="d">-
</a><a href="#h38-0-52" id="h38-0-52" class="d">-    fun init(context: Context) {
</a><a href="#h38-0-53" id="h38-0-53" class="d">-        this.context = context
</a><a href="#h38-0-54" id="h38-0-54" class="d">-        snapBuildNumber = getSnapchatVersionCode()
</a><a href="#h38-0-55" id="h38-0-55" class="d">-
</a><a href="#h38-0-56" id="h38-0-56" class="d">-        if (isFileExists()) {
</a><a href="#h38-0-57" id="h38-0-57" class="d">-            runCatching {
</a><a href="#h38-0-58" id="h38-0-58" class="d">-                loadCached()
</a><a href="#h38-0-59" id="h38-0-59" class="d">-            }.onFailure {
</a><a href="#h38-0-60" id="h38-0-60" class="d">-                Logger.error(&quot;Failed to load cached mappings&quot;, it)
</a><a href="#h38-0-61" id="h38-0-61" class="d">-                delete()
</a><a href="#h38-0-62" id="h38-0-62" class="d">-            }
</a><a href="#h38-0-63" id="h38-0-63" class="d">-        } else {
</a><a href="#h38-0-64" id="h38-0-64" class="d">-            Logger.debug(&quot;Mappings file does not exist&quot;)
</a><a href="#h38-0-65" id="h38-0-65" class="d">-        }
</a><a href="#h38-0-66" id="h38-0-66" class="d">-    }
</a><a href="#h38-0-67" id="h38-0-67" class="d">-
</a><a href="#h38-0-68" id="h38-0-68" class="d">-    fun getSnapchatPackageInfo() = runCatching {
</a><a href="#h38-0-69" id="h38-0-69" class="d">-        context.packageManager.getPackageInfo(
</a><a href="#h38-0-70" id="h38-0-70" class="d">-            Constants.SNAPCHAT_PACKAGE_NAME,
</a><a href="#h38-0-71" id="h38-0-71" class="d">-            0
</a><a href="#h38-0-72" id="h38-0-72" class="d">-        )
</a><a href="#h38-0-73" id="h38-0-73" class="d">-    }.getOrNull()
</a><a href="#h38-0-74" id="h38-0-74" class="d">-
</a><a href="#h38-0-75" id="h38-0-75" class="d">-    fun getSnapchatVersionCode() = getSnapchatPackageInfo()?.longVersionCode ?: -1
</a><a href="#h38-0-76" id="h38-0-76" class="d">-    fun getApplicationSourceDir() = getSnapchatPackageInfo()?.applicationInfo?.sourceDir
</a><a href="#h38-0-77" id="h38-0-77" class="d">-    fun getGeneratedBuildNumber() = snapBuildNumber
</a><a href="#h38-0-78" id="h38-0-78" class="d">-
</a><a href="#h38-0-79" id="h38-0-79" class="d">-    fun isMappingsOutdated(): Boolean {
</a><a href="#h38-0-80" id="h38-0-80" class="d">-        return snapBuildNumber != getSnapchatVersionCode() || isMappingsLoaded().not()
</a><a href="#h38-0-81" id="h38-0-81" class="d">-    }
</a><a href="#h38-0-82" id="h38-0-82" class="d">-
</a><a href="#h38-0-83" id="h38-0-83" class="d">-    fun isMappingsLoaded(): Boolean {
</a><a href="#h38-0-84" id="h38-0-84" class="d">-        return mappings.isNotEmpty()
</a><a href="#h38-0-85" id="h38-0-85" class="d">-    }
</a><a href="#h38-0-86" id="h38-0-86" class="d">-
</a><a href="#h38-0-87" id="h38-0-87" class="d">-    private fun loadCached() {
</a><a href="#h38-0-88" id="h38-0-88" class="d">-        if (!isFileExists()) {
</a><a href="#h38-0-89" id="h38-0-89" class="d">-            throw Exception(&quot;Mappings file does not exist&quot;)
</a><a href="#h38-0-90" id="h38-0-90" class="d">-        }
</a><a href="#h38-0-91" id="h38-0-91" class="d">-        val mappingsObject = JsonParser.parseString(read().toString(Charsets.UTF_8)).asJsonObject.also {
</a><a href="#h38-0-92" id="h38-0-92" class="d">-            snapBuildNumber = it[&quot;snap_build_number&quot;].asLong
</a><a href="#h38-0-93" id="h38-0-93" class="d">-        }
</a><a href="#h38-0-94" id="h38-0-94" class="d">-
</a><a href="#h38-0-95" id="h38-0-95" class="d">-        mappingsObject.entrySet().forEach { (key, value): Map.Entry&lt;String, JsonElement&gt; -&gt;
</a><a href="#h38-0-96" id="h38-0-96" class="d">-            if (value.isJsonArray) {
</a><a href="#h38-0-97" id="h38-0-97" class="d">-                mappings[key] = gson.fromJson(value, ArrayList::class.java)
</a><a href="#h38-0-98" id="h38-0-98" class="d">-                return@forEach
</a><a href="#h38-0-99" id="h38-0-99" class="d">-            }
</a><a href="#h38-0-100" id="h38-0-100" class="d">-            if (value.isJsonObject) {
</a><a href="#h38-0-101" id="h38-0-101" class="d">-                mappings[key] = gson.fromJson(value, ConcurrentHashMap::class.java)
</a><a href="#h38-0-102" id="h38-0-102" class="d">-                return@forEach
</a><a href="#h38-0-103" id="h38-0-103" class="d">-            }
</a><a href="#h38-0-104" id="h38-0-104" class="d">-            mappings[key] = value.asString
</a><a href="#h38-0-105" id="h38-0-105" class="d">-        }
</a><a href="#h38-0-106" id="h38-0-106" class="d">-    }
</a><a href="#h38-0-107" id="h38-0-107" class="d">-
</a><a href="#h38-0-108" id="h38-0-108" class="d">-    fun refresh() {
</a><a href="#h38-0-109" id="h38-0-109" class="d">-        snapBuildNumber = getSnapchatVersionCode()
</a><a href="#h38-0-110" id="h38-0-110" class="d">-        val mapper = Mapper(*mappers)
</a><a href="#h38-0-111" id="h38-0-111" class="d">-
</a><a href="#h38-0-112" id="h38-0-112" class="d">-        runCatching {
</a><a href="#h38-0-113" id="h38-0-113" class="d">-            mapper.loadApk(getApplicationSourceDir() ?: throw Exception(&quot;Failed to get APK&quot;))
</a><a href="#h38-0-114" id="h38-0-114" class="d">-        }.onFailure {
</a><a href="#h38-0-115" id="h38-0-115" class="d">-            throw Exception(&quot;Failed to load APK&quot;, it)
</a><a href="#h38-0-116" id="h38-0-116" class="d">-        }
</a><a href="#h38-0-117" id="h38-0-117" class="d">-
</a><a href="#h38-0-118" id="h38-0-118" class="d">-        measureTimeMillis {
</a><a href="#h38-0-119" id="h38-0-119" class="d">-            val result = mapper.start().apply {
</a><a href="#h38-0-120" id="h38-0-120" class="d">-                addProperty(&quot;snap_build_number&quot;, snapBuildNumber)
</a><a href="#h38-0-121" id="h38-0-121" class="d">-            }
</a><a href="#h38-0-122" id="h38-0-122" class="d">-            write(result.toString().toByteArray())
</a><a href="#h38-0-123" id="h38-0-123" class="d">-        }.also {
</a><a href="#h38-0-124" id="h38-0-124" class="d">-            Logger.debug(&quot;Generated mappings in $it ms&quot;)
</a><a href="#h38-0-125" id="h38-0-125" class="d">-        }
</a><a href="#h38-0-126" id="h38-0-126" class="d">-    }
</a><a href="#h38-0-127" id="h38-0-127" class="d">-
</a><a href="#h38-0-128" id="h38-0-128" class="d">-    fun getMappedObject(key: String): Any {
</a><a href="#h38-0-129" id="h38-0-129" class="d">-        if (mappings.containsKey(key)) {
</a><a href="#h38-0-130" id="h38-0-130" class="d">-            return mappings[key]!!
</a><a href="#h38-0-131" id="h38-0-131" class="d">-        }
</a><a href="#h38-0-132" id="h38-0-132" class="d">-        throw Exception(&quot;No mapping found for $key&quot;)
</a><a href="#h38-0-133" id="h38-0-133" class="d">-    }
</a><a href="#h38-0-134" id="h38-0-134" class="d">-
</a><a href="#h38-0-135" id="h38-0-135" class="d">-    fun getMappedObjectNullable(key: String): Any? {
</a><a href="#h38-0-136" id="h38-0-136" class="d">-        return mappings[key]
</a><a href="#h38-0-137" id="h38-0-137" class="d">-    }
</a><a href="#h38-0-138" id="h38-0-138" class="d">-
</a><a href="#h38-0-139" id="h38-0-139" class="d">-    fun getMappedClass(className: String): Class&lt;*&gt; {
</a><a href="#h38-0-140" id="h38-0-140" class="d">-        return context.classLoader.loadClass(getMappedObject(className) as String)
</a><a href="#h38-0-141" id="h38-0-141" class="d">-    }
</a><a href="#h38-0-142" id="h38-0-142" class="d">-
</a><a href="#h38-0-143" id="h38-0-143" class="d">-    fun getMappedClass(key: String, subKey: String): Class&lt;*&gt; {
</a><a href="#h38-0-144" id="h38-0-144" class="d">-        return context.classLoader.loadClass(getMappedValue(key, subKey))
</a><a href="#h38-0-145" id="h38-0-145" class="d">-    }
</a><a href="#h38-0-146" id="h38-0-146" class="d">-
</a><a href="#h38-0-147" id="h38-0-147" class="d">-    fun getMappedValue(key: String): String {
</a><a href="#h38-0-148" id="h38-0-148" class="d">-        return getMappedObject(key) as String
</a><a href="#h38-0-149" id="h38-0-149" class="d">-    }
</a><a href="#h38-0-150" id="h38-0-150" class="d">-
</a><a href="#h38-0-151" id="h38-0-151" class="d">-    @Suppress(&quot;UNCHECKED_CAST&quot;)
</a><a href="#h38-0-152" id="h38-0-152" class="d">-    fun &lt;T : Any&gt; getMappedList(key: String): List&lt;T&gt; {
</a><a href="#h38-0-153" id="h38-0-153" class="d">-        return listOf(getMappedObject(key) as List&lt;T&gt;).flatten()
</a><a href="#h38-0-154" id="h38-0-154" class="d">-    }
</a><a href="#h38-0-155" id="h38-0-155" class="d">-
</a><a href="#h38-0-156" id="h38-0-156" class="d">-    fun getMappedValue(key: String, subKey: String): String {
</a><a href="#h38-0-157" id="h38-0-157" class="d">-        return getMappedMap(key)[subKey] as String
</a><a href="#h38-0-158" id="h38-0-158" class="d">-    }
</a><a href="#h38-0-159" id="h38-0-159" class="d">-
</a><a href="#h38-0-160" id="h38-0-160" class="d">-    @Suppress(&quot;UNCHECKED_CAST&quot;)
</a><a href="#h38-0-161" id="h38-0-161" class="d">-    fun getMappedMap(key: String): Map&lt;String, *&gt; {
</a><a href="#h38-0-162" id="h38-0-162" class="d">-        return getMappedObject(key) as Map&lt;String, *&gt;
</a><a href="#h38-0-163" id="h38-0-163" class="d">-    }
</a><a href="#h38-0-164" id="h38-0-164" class="d">-}</a><a href="#h38-0-165" id="h38-0-165" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h39" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/bridge/wrapper/MessageLoggerWrapper.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/bridge/wrapper/MessageLoggerWrapper.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/bridge/wrapper/MessageLoggerWrapper.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/bridge/wrapper/MessageLoggerWrapper.kt</a></b>
<a href="#h39-0" id="h39-0" class="h">@@ -1,70 +0,0 @@
</a><a href="#h39-0-0" id="h39-0-0" class="d">-package me.rhunk.snapenhance.bridge.wrapper
</a><a href="#h39-0-1" id="h39-0-1" class="d">-
</a><a href="#h39-0-2" id="h39-0-2" class="d">-import android.content.ContentValues
</a><a href="#h39-0-3" id="h39-0-3" class="d">-import android.database.sqlite.SQLiteDatabase
</a><a href="#h39-0-4" id="h39-0-4" class="d">-import me.rhunk.snapenhance.util.SQLiteDatabaseHelper
</a><a href="#h39-0-5" id="h39-0-5" class="d">-import java.io.File
</a><a href="#h39-0-6" id="h39-0-6" class="d">-
</a><a href="#h39-0-7" id="h39-0-7" class="d">-class MessageLoggerWrapper(
</a><a href="#h39-0-8" id="h39-0-8" class="d">-    private val databaseFile: File
</a><a href="#h39-0-9" id="h39-0-9" class="d">-) {
</a><a href="#h39-0-10" id="h39-0-10" class="d">-
</a><a href="#h39-0-11" id="h39-0-11" class="d">-    lateinit var database: SQLiteDatabase
</a><a href="#h39-0-12" id="h39-0-12" class="d">-
</a><a href="#h39-0-13" id="h39-0-13" class="d">-    fun init() {
</a><a href="#h39-0-14" id="h39-0-14" class="d">-        database = SQLiteDatabase.openDatabase(databaseFile.absolutePath, null, SQLiteDatabase.CREATE_IF_NECESSARY or SQLiteDatabase.OPEN_READWRITE)
</a><a href="#h39-0-15" id="h39-0-15" class="d">-        SQLiteDatabaseHelper.createTablesFromSchema(database, mapOf(
</a><a href="#h39-0-16" id="h39-0-16" class="d">-            &quot;messages&quot; to listOf(
</a><a href="#h39-0-17" id="h39-0-17" class="d">-                &quot;id INTEGER PRIMARY KEY&quot;,
</a><a href="#h39-0-18" id="h39-0-18" class="d">-                &quot;conversation_id VARCHAR&quot;,
</a><a href="#h39-0-19" id="h39-0-19" class="d">-                &quot;message_id BIGINT&quot;,
</a><a href="#h39-0-20" id="h39-0-20" class="d">-                &quot;message_data BLOB&quot;
</a><a href="#h39-0-21" id="h39-0-21" class="d">-            )
</a><a href="#h39-0-22" id="h39-0-22" class="d">-        ))
</a><a href="#h39-0-23" id="h39-0-23" class="d">-    }
</a><a href="#h39-0-24" id="h39-0-24" class="d">-
</a><a href="#h39-0-25" id="h39-0-25" class="d">-    fun deleteMessage(conversationId: String, messageId: Long) {
</a><a href="#h39-0-26" id="h39-0-26" class="d">-        database.execSQL(&quot;DELETE FROM messages WHERE conversation_id = ? AND message_id = ?&quot;, arrayOf(conversationId, messageId.toString()))
</a><a href="#h39-0-27" id="h39-0-27" class="d">-    }
</a><a href="#h39-0-28" id="h39-0-28" class="d">-
</a><a href="#h39-0-29" id="h39-0-29" class="d">-    fun addMessage(conversationId: String, messageId: Long, serializedMessage: ByteArray): Boolean {
</a><a href="#h39-0-30" id="h39-0-30" class="d">-        val cursor = database.rawQuery(&quot;SELECT message_id FROM messages WHERE conversation_id = ? AND message_id = ?&quot;, arrayOf(conversationId, messageId.toString()))
</a><a href="#h39-0-31" id="h39-0-31" class="d">-        val state = cursor.moveToFirst()
</a><a href="#h39-0-32" id="h39-0-32" class="d">-        cursor.close()
</a><a href="#h39-0-33" id="h39-0-33" class="d">-        if (state) {
</a><a href="#h39-0-34" id="h39-0-34" class="d">-            return false
</a><a href="#h39-0-35" id="h39-0-35" class="d">-        }
</a><a href="#h39-0-36" id="h39-0-36" class="d">-        database.insert(&quot;messages&quot;, null, ContentValues().apply {
</a><a href="#h39-0-37" id="h39-0-37" class="d">-            put(&quot;conversation_id&quot;, conversationId)
</a><a href="#h39-0-38" id="h39-0-38" class="d">-            put(&quot;message_id&quot;, messageId)
</a><a href="#h39-0-39" id="h39-0-39" class="d">-            put(&quot;message_data&quot;, serializedMessage)
</a><a href="#h39-0-40" id="h39-0-40" class="d">-        })
</a><a href="#h39-0-41" id="h39-0-41" class="d">-        return true
</a><a href="#h39-0-42" id="h39-0-42" class="d">-    }
</a><a href="#h39-0-43" id="h39-0-43" class="d">-
</a><a href="#h39-0-44" id="h39-0-44" class="d">-    fun getMessage(conversationId: String, messageId: Long): Pair&lt;Boolean, ByteArray?&gt; {
</a><a href="#h39-0-45" id="h39-0-45" class="d">-        val cursor = database.rawQuery(&quot;SELECT message_data FROM messages WHERE conversation_id = ? AND message_id = ?&quot;, arrayOf(conversationId, messageId.toString()))
</a><a href="#h39-0-46" id="h39-0-46" class="d">-        val state = cursor.moveToFirst()
</a><a href="#h39-0-47" id="h39-0-47" class="d">-        val message: ByteArray? = if (state) {
</a><a href="#h39-0-48" id="h39-0-48" class="d">-            cursor.getBlob(0)
</a><a href="#h39-0-49" id="h39-0-49" class="d">-        } else {
</a><a href="#h39-0-50" id="h39-0-50" class="d">-            null
</a><a href="#h39-0-51" id="h39-0-51" class="d">-        }
</a><a href="#h39-0-52" id="h39-0-52" class="d">-        cursor.close()
</a><a href="#h39-0-53" id="h39-0-53" class="d">-        return Pair(state, message)
</a><a href="#h39-0-54" id="h39-0-54" class="d">-    }
</a><a href="#h39-0-55" id="h39-0-55" class="d">-
</a><a href="#h39-0-56" id="h39-0-56" class="d">-    fun getMessageIds(conversationId: String, limit: Int): List&lt;Long&gt; {
</a><a href="#h39-0-57" id="h39-0-57" class="d">-        val cursor = database.rawQuery(&quot;SELECT message_id FROM messages WHERE conversation_id = ? ORDER BY message_id DESC LIMIT ?&quot;, arrayOf(conversationId, limit.toString()))
</a><a href="#h39-0-58" id="h39-0-58" class="d">-        val messageIds = mutableListOf&lt;Long&gt;()
</a><a href="#h39-0-59" id="h39-0-59" class="d">-        while (cursor.moveToNext()) {
</a><a href="#h39-0-60" id="h39-0-60" class="d">-            messageIds.add(cursor.getLong(0))
</a><a href="#h39-0-61" id="h39-0-61" class="d">-        }
</a><a href="#h39-0-62" id="h39-0-62" class="d">-        cursor.close()
</a><a href="#h39-0-63" id="h39-0-63" class="d">-        return messageIds
</a><a href="#h39-0-64" id="h39-0-64" class="d">-    }
</a><a href="#h39-0-65" id="h39-0-65" class="d">-
</a><a href="#h39-0-66" id="h39-0-66" class="d">-    fun clearMessages() {
</a><a href="#h39-0-67" id="h39-0-67" class="d">-        database.execSQL(&quot;DELETE FROM messages&quot;)
</a><a href="#h39-0-68" id="h39-0-68" class="d">-    }
</a><a href="#h39-0-69" id="h39-0-69" class="d">-}</a><a href="#h39-0-70" id="h39-0-70" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h40" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/BridgeClient.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/BridgeClient.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/BridgeClient.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/BridgeClient.kt</a></b>
<a href="#h40-0" id="h40-0" class="h">@@ -0,0 +1,147 @@
</a><a href="#h40-0-0" id="h40-0-0" class="i">+package me.rhunk.snapenhance.core.bridge
</a><a href="#h40-0-1" id="h40-0-1" class="i">+
</a><a href="#h40-0-2" id="h40-0-2" class="i">+
</a><a href="#h40-0-3" id="h40-0-3" class="i">+import android.content.ComponentName
</a><a href="#h40-0-4" id="h40-0-4" class="i">+import android.content.Context
</a><a href="#h40-0-5" id="h40-0-5" class="i">+import android.content.Intent
</a><a href="#h40-0-6" id="h40-0-6" class="i">+import android.content.ServiceConnection
</a><a href="#h40-0-7" id="h40-0-7" class="i">+import android.os.Build
</a><a href="#h40-0-8" id="h40-0-8" class="i">+import android.os.Handler
</a><a href="#h40-0-9" id="h40-0-9" class="i">+import android.os.HandlerThread
</a><a href="#h40-0-10" id="h40-0-10" class="i">+import android.os.IBinder
</a><a href="#h40-0-11" id="h40-0-11" class="i">+import de.robv.android.xposed.XposedHelpers
</a><a href="#h40-0-12" id="h40-0-12" class="i">+import me.rhunk.snapenhance.ModContext
</a><a href="#h40-0-13" id="h40-0-13" class="i">+import me.rhunk.snapenhance.bridge.BridgeInterface
</a><a href="#h40-0-14" id="h40-0-14" class="i">+import me.rhunk.snapenhance.bridge.DownloadCallback
</a><a href="#h40-0-15" id="h40-0-15" class="i">+import me.rhunk.snapenhance.bridge.SyncCallback
</a><a href="#h40-0-16" id="h40-0-16" class="i">+import me.rhunk.snapenhance.core.BuildConfig
</a><a href="#h40-0-17" id="h40-0-17" class="i">+import me.rhunk.snapenhance.core.bridge.types.BridgeFileType
</a><a href="#h40-0-18" id="h40-0-18" class="i">+import me.rhunk.snapenhance.core.bridge.types.FileActionType
</a><a href="#h40-0-19" id="h40-0-19" class="i">+import me.rhunk.snapenhance.core.messaging.MessagingRuleType
</a><a href="#h40-0-20" id="h40-0-20" class="i">+import me.rhunk.snapenhance.data.LocalePair
</a><a href="#h40-0-21" id="h40-0-21" class="i">+import java.util.concurrent.CompletableFuture
</a><a href="#h40-0-22" id="h40-0-22" class="i">+import java.util.concurrent.Executors
</a><a href="#h40-0-23" id="h40-0-23" class="i">+import kotlin.system.exitProcess
</a><a href="#h40-0-24" id="h40-0-24" class="i">+
</a><a href="#h40-0-25" id="h40-0-25" class="i">+
</a><a href="#h40-0-26" id="h40-0-26" class="i">+class BridgeClient(
</a><a href="#h40-0-27" id="h40-0-27" class="i">+    private val context: ModContext
</a><a href="#h40-0-28" id="h40-0-28" class="i">+):  ServiceConnection {
</a><a href="#h40-0-29" id="h40-0-29" class="i">+    private lateinit var future: CompletableFuture&lt;Boolean&gt;
</a><a href="#h40-0-30" id="h40-0-30" class="i">+    private lateinit var service: BridgeInterface
</a><a href="#h40-0-31" id="h40-0-31" class="i">+
</a><a href="#h40-0-32" id="h40-0-32" class="i">+    companion object {
</a><a href="#h40-0-33" id="h40-0-33" class="i">+        const val BRIDGE_SYNC_ACTION = &quot;me.rhunk.snapenhance.core.bridge.SYNC&quot;
</a><a href="#h40-0-34" id="h40-0-34" class="i">+    }
</a><a href="#h40-0-35" id="h40-0-35" class="i">+
</a><a href="#h40-0-36" id="h40-0-36" class="i">+    fun start(callback: (Boolean) -&gt; Unit) {
</a><a href="#h40-0-37" id="h40-0-37" class="i">+        this.future = CompletableFuture()
</a><a href="#h40-0-38" id="h40-0-38" class="i">+
</a><a href="#h40-0-39" id="h40-0-39" class="i">+        //TODO: randomize package name
</a><a href="#h40-0-40" id="h40-0-40" class="i">+        with(context.androidContext) {
</a><a href="#h40-0-41" id="h40-0-41" class="i">+            //ensure the remote process is running
</a><a href="#h40-0-42" id="h40-0-42" class="i">+            startActivity(Intent()
</a><a href="#h40-0-43" id="h40-0-43" class="i">+                .setClassName(BuildConfig.APPLICATION_ID, &quot;me.rhunk.snapenhance.bridge.ForceStartActivity&quot;)
</a><a href="#h40-0-44" id="h40-0-44" class="i">+                .addFlags(Intent.FLAG_ACTIVITY_NEW_TASK or Intent.FLAG_ACTIVITY_MULTIPLE_TASK)
</a><a href="#h40-0-45" id="h40-0-45" class="i">+            )
</a><a href="#h40-0-46" id="h40-0-46" class="i">+
</a><a href="#h40-0-47" id="h40-0-47" class="i">+            val intent = Intent()
</a><a href="#h40-0-48" id="h40-0-48" class="i">+                .setClassName(BuildConfig.APPLICATION_ID, &quot;me.rhunk.snapenhance.bridge.BridgeService&quot;)
</a><a href="#h40-0-49" id="h40-0-49" class="i">+            if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.Q) {
</a><a href="#h40-0-50" id="h40-0-50" class="i">+                bindService(
</a><a href="#h40-0-51" id="h40-0-51" class="i">+                    intent,
</a><a href="#h40-0-52" id="h40-0-52" class="i">+                    Context.BIND_AUTO_CREATE,
</a><a href="#h40-0-53" id="h40-0-53" class="i">+                    Executors.newSingleThreadExecutor(),
</a><a href="#h40-0-54" id="h40-0-54" class="i">+                    this@BridgeClient
</a><a href="#h40-0-55" id="h40-0-55" class="i">+                )
</a><a href="#h40-0-56" id="h40-0-56" class="i">+            } else {
</a><a href="#h40-0-57" id="h40-0-57" class="i">+                XposedHelpers.callMethod(
</a><a href="#h40-0-58" id="h40-0-58" class="i">+                    this,
</a><a href="#h40-0-59" id="h40-0-59" class="i">+                    &quot;bindServiceAsUser&quot;,
</a><a href="#h40-0-60" id="h40-0-60" class="i">+                    intent,
</a><a href="#h40-0-61" id="h40-0-61" class="i">+                    this@BridgeClient,
</a><a href="#h40-0-62" id="h40-0-62" class="i">+                    Context.BIND_AUTO_CREATE,
</a><a href="#h40-0-63" id="h40-0-63" class="i">+                    Handler(HandlerThread(&quot;BridgeClient&quot;).apply {
</a><a href="#h40-0-64" id="h40-0-64" class="i">+                        start()
</a><a href="#h40-0-65" id="h40-0-65" class="i">+                    }.looper),
</a><a href="#h40-0-66" id="h40-0-66" class="i">+                    android.os.Process.myUserHandle()
</a><a href="#h40-0-67" id="h40-0-67" class="i">+                )
</a><a href="#h40-0-68" id="h40-0-68" class="i">+            }
</a><a href="#h40-0-69" id="h40-0-69" class="i">+        }
</a><a href="#h40-0-70" id="h40-0-70" class="i">+        callback(future.get())
</a><a href="#h40-0-71" id="h40-0-71" class="i">+    }
</a><a href="#h40-0-72" id="h40-0-72" class="i">+
</a><a href="#h40-0-73" id="h40-0-73" class="i">+
</a><a href="#h40-0-74" id="h40-0-74" class="i">+    override fun onServiceConnected(name: ComponentName, service: IBinder) {
</a><a href="#h40-0-75" id="h40-0-75" class="i">+        this.service = BridgeInterface.Stub.asInterface(service)
</a><a href="#h40-0-76" id="h40-0-76" class="i">+        future.complete(true)
</a><a href="#h40-0-77" id="h40-0-77" class="i">+    }
</a><a href="#h40-0-78" id="h40-0-78" class="i">+
</a><a href="#h40-0-79" id="h40-0-79" class="i">+    override fun onNullBinding(name: ComponentName) {
</a><a href="#h40-0-80" id="h40-0-80" class="i">+        context.log.error(&quot;BridgeClient&quot;, &quot;failed to connect to bridge service&quot;)
</a><a href="#h40-0-81" id="h40-0-81" class="i">+        exitProcess(1)
</a><a href="#h40-0-82" id="h40-0-82" class="i">+    }
</a><a href="#h40-0-83" id="h40-0-83" class="i">+
</a><a href="#h40-0-84" id="h40-0-84" class="i">+    override fun onServiceDisconnected(name: ComponentName) {
</a><a href="#h40-0-85" id="h40-0-85" class="i">+        exitProcess(0)
</a><a href="#h40-0-86" id="h40-0-86" class="i">+    }
</a><a href="#h40-0-87" id="h40-0-87" class="i">+
</a><a href="#h40-0-88" id="h40-0-88" class="i">+    fun broadcastLog(tag: String, level: String, message: String) = service.broadcastLog(tag, level, message)
</a><a href="#h40-0-89" id="h40-0-89" class="i">+
</a><a href="#h40-0-90" id="h40-0-90" class="i">+    fun createAndReadFile(
</a><a href="#h40-0-91" id="h40-0-91" class="i">+        fileType: BridgeFileType,
</a><a href="#h40-0-92" id="h40-0-92" class="i">+        defaultContent: ByteArray
</a><a href="#h40-0-93" id="h40-0-93" class="i">+    ): ByteArray = service.fileOperation(FileActionType.CREATE_AND_READ.ordinal, fileType.value, defaultContent)
</a><a href="#h40-0-94" id="h40-0-94" class="i">+
</a><a href="#h40-0-95" id="h40-0-95" class="i">+    fun readFile(fileType: BridgeFileType): ByteArray = service.fileOperation(FileActionType.READ.ordinal, fileType.value, null)
</a><a href="#h40-0-96" id="h40-0-96" class="i">+
</a><a href="#h40-0-97" id="h40-0-97" class="i">+    fun writeFile(
</a><a href="#h40-0-98" id="h40-0-98" class="i">+        fileType: BridgeFileType,
</a><a href="#h40-0-99" id="h40-0-99" class="i">+        content: ByteArray?
</a><a href="#h40-0-100" id="h40-0-100" class="i">+    ) { service.fileOperation(FileActionType.WRITE.ordinal, fileType.value, content) }
</a><a href="#h40-0-101" id="h40-0-101" class="i">+
</a><a href="#h40-0-102" id="h40-0-102" class="i">+    fun deleteFile(fileType: BridgeFileType) { service.fileOperation(FileActionType.DELETE.ordinal, fileType.value, null) }
</a><a href="#h40-0-103" id="h40-0-103" class="i">+
</a><a href="#h40-0-104" id="h40-0-104" class="i">+    fun isFileExists(fileType: BridgeFileType) = service.fileOperation(FileActionType.EXISTS.ordinal, fileType.value, null).isNotEmpty()
</a><a href="#h40-0-105" id="h40-0-105" class="i">+
</a><a href="#h40-0-106" id="h40-0-106" class="i">+    fun getLoggedMessageIds(conversationId: String, limit: Int): LongArray = service.getLoggedMessageIds(conversationId, limit)
</a><a href="#h40-0-107" id="h40-0-107" class="i">+
</a><a href="#h40-0-108" id="h40-0-108" class="i">+    fun getMessageLoggerMessage(conversationId: String, id: Long): ByteArray? = service.getMessageLoggerMessage(conversationId, id)
</a><a href="#h40-0-109" id="h40-0-109" class="i">+
</a><a href="#h40-0-110" id="h40-0-110" class="i">+    fun addMessageLoggerMessage(conversationId: String, id: Long, message: ByteArray) = service.addMessageLoggerMessage(conversationId, id, message)
</a><a href="#h40-0-111" id="h40-0-111" class="i">+
</a><a href="#h40-0-112" id="h40-0-112" class="i">+    fun deleteMessageLoggerMessage(conversationId: String, id: Long) = service.deleteMessageLoggerMessage(conversationId, id)
</a><a href="#h40-0-113" id="h40-0-113" class="i">+
</a><a href="#h40-0-114" id="h40-0-114" class="i">+    fun fetchLocales(userLocale: String) = service.fetchLocales(userLocale).map {
</a><a href="#h40-0-115" id="h40-0-115" class="i">+        LocalePair(it.key, it.value)
</a><a href="#h40-0-116" id="h40-0-116" class="i">+    }
</a><a href="#h40-0-117" id="h40-0-117" class="i">+
</a><a href="#h40-0-118" id="h40-0-118" class="i">+    fun getApplicationApkPath() = service.getApplicationApkPath()
</a><a href="#h40-0-119" id="h40-0-119" class="i">+
</a><a href="#h40-0-120" id="h40-0-120" class="i">+    fun getAutoUpdaterTime(): Long {
</a><a href="#h40-0-121" id="h40-0-121" class="i">+        createAndReadFile(BridgeFileType.AUTO_UPDATER_TIMESTAMP, &quot;0&quot;.toByteArray()).run {
</a><a href="#h40-0-122" id="h40-0-122" class="i">+            return if (isEmpty()) {
</a><a href="#h40-0-123" id="h40-0-123" class="i">+                0
</a><a href="#h40-0-124" id="h40-0-124" class="i">+            } else {
</a><a href="#h40-0-125" id="h40-0-125" class="i">+                String(this).toLong()
</a><a href="#h40-0-126" id="h40-0-126" class="i">+            }
</a><a href="#h40-0-127" id="h40-0-127" class="i">+        }
</a><a href="#h40-0-128" id="h40-0-128" class="i">+    }
</a><a href="#h40-0-129" id="h40-0-129" class="i">+
</a><a href="#h40-0-130" id="h40-0-130" class="i">+    fun setAutoUpdaterTime(time: Long) {
</a><a href="#h40-0-131" id="h40-0-131" class="i">+        writeFile(BridgeFileType.AUTO_UPDATER_TIMESTAMP, time.toString().toByteArray())
</a><a href="#h40-0-132" id="h40-0-132" class="i">+    }
</a><a href="#h40-0-133" id="h40-0-133" class="i">+
</a><a href="#h40-0-134" id="h40-0-134" class="i">+    fun enqueueDownload(intent: Intent, callback: DownloadCallback) = service.enqueueDownload(intent, callback)
</a><a href="#h40-0-135" id="h40-0-135" class="i">+
</a><a href="#h40-0-136" id="h40-0-136" class="i">+    fun sync(callback: SyncCallback) = service.sync(callback)
</a><a href="#h40-0-137" id="h40-0-137" class="i">+
</a><a href="#h40-0-138" id="h40-0-138" class="i">+    fun passGroupsAndFriends(groups: List&lt;String&gt;, friends: List&lt;String&gt;) = service.passGroupsAndFriends(groups, friends)
</a><a href="#h40-0-139" id="h40-0-139" class="i">+
</a><a href="#h40-0-140" id="h40-0-140" class="i">+    fun getRules(targetUuid: String): List&lt;MessagingRuleType&gt; {
</a><a href="#h40-0-141" id="h40-0-141" class="i">+        return service.getRules(targetUuid).map { MessagingRuleType.getByName(it) }
</a><a href="#h40-0-142" id="h40-0-142" class="i">+    }
</a><a href="#h40-0-143" id="h40-0-143" class="i">+
</a><a href="#h40-0-144" id="h40-0-144" class="i">+    fun setRule(targetUuid: String, type: MessagingRuleType, state: Boolean)
</a><a href="#h40-0-145" id="h40-0-145" class="i">+        = service.setRule(targetUuid, type.key, state)
</a><a href="#h40-0-146" id="h40-0-146" class="i">+}
</a><b>diff --git a/<a id="h41" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/FileLoaderWrapper.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/FileLoaderWrapper.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/FileLoaderWrapper.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/FileLoaderWrapper.kt</a></b>
<a href="#h41-0" id="h41-0" class="h">@@ -0,0 +1,35 @@
</a><a href="#h41-0-0" id="h41-0-0" class="i">+package me.rhunk.snapenhance.core.bridge
</a><a href="#h41-0-1" id="h41-0-1" class="i">+
</a><a href="#h41-0-2" id="h41-0-2" class="i">+import android.content.Context
</a><a href="#h41-0-3" id="h41-0-3" class="i">+import me.rhunk.snapenhance.core.bridge.types.BridgeFileType
</a><a href="#h41-0-4" id="h41-0-4" class="i">+
</a><a href="#h41-0-5" id="h41-0-5" class="i">+open class FileLoaderWrapper(
</a><a href="#h41-0-6" id="h41-0-6" class="i">+    private val fileType: BridgeFileType,
</a><a href="#h41-0-7" id="h41-0-7" class="i">+    private val defaultContent: ByteArray
</a><a href="#h41-0-8" id="h41-0-8" class="i">+) {
</a><a href="#h41-0-9" id="h41-0-9" class="i">+    lateinit var isFileExists: () -&gt; Boolean
</a><a href="#h41-0-10" id="h41-0-10" class="i">+    lateinit var write: (ByteArray) -&gt; Unit
</a><a href="#h41-0-11" id="h41-0-11" class="i">+    lateinit var read: () -&gt; ByteArray
</a><a href="#h41-0-12" id="h41-0-12" class="i">+    lateinit var delete: () -&gt; Unit
</a><a href="#h41-0-13" id="h41-0-13" class="i">+
</a><a href="#h41-0-14" id="h41-0-14" class="i">+    fun loadFromContext(context: Context) {
</a><a href="#h41-0-15" id="h41-0-15" class="i">+        val file = fileType.resolve(context)
</a><a href="#h41-0-16" id="h41-0-16" class="i">+        isFileExists = { file.exists() }
</a><a href="#h41-0-17" id="h41-0-17" class="i">+        read = {
</a><a href="#h41-0-18" id="h41-0-18" class="i">+            if (!file.exists()) {
</a><a href="#h41-0-19" id="h41-0-19" class="i">+                file.createNewFile()
</a><a href="#h41-0-20" id="h41-0-20" class="i">+                file.writeBytes(&quot;{}&quot;.toByteArray(Charsets.UTF_8))
</a><a href="#h41-0-21" id="h41-0-21" class="i">+            }
</a><a href="#h41-0-22" id="h41-0-22" class="i">+            file.readBytes()
</a><a href="#h41-0-23" id="h41-0-23" class="i">+        }
</a><a href="#h41-0-24" id="h41-0-24" class="i">+        write = { file.writeBytes(it) }
</a><a href="#h41-0-25" id="h41-0-25" class="i">+        delete = { file.delete() }
</a><a href="#h41-0-26" id="h41-0-26" class="i">+    }
</a><a href="#h41-0-27" id="h41-0-27" class="i">+
</a><a href="#h41-0-28" id="h41-0-28" class="i">+    fun loadFromBridge(bridgeClient: BridgeClient) {
</a><a href="#h41-0-29" id="h41-0-29" class="i">+        isFileExists = { bridgeClient.isFileExists(fileType) }
</a><a href="#h41-0-30" id="h41-0-30" class="i">+        read = { bridgeClient.createAndReadFile(fileType, defaultContent) }
</a><a href="#h41-0-31" id="h41-0-31" class="i">+        write = { bridgeClient.writeFile(fileType, it) }
</a><a href="#h41-0-32" id="h41-0-32" class="i">+        delete = { bridgeClient.deleteFile(fileType) }
</a><a href="#h41-0-33" id="h41-0-33" class="i">+    }
</a><a href="#h41-0-34" id="h41-0-34" class="i">+}</a><a href="#h41-0-35" id="h41-0-35" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h42" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/types/BridgeFileType.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/types/BridgeFileType.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/types/BridgeFileType.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/types/BridgeFileType.kt</a></b>
<a href="#h42-0" id="h42-0" class="h">@@ -0,0 +1,25 @@
</a><a href="#h42-0-0" id="h42-0-0" class="i">+package me.rhunk.snapenhance.core.bridge.types
</a><a href="#h42-0-1" id="h42-0-1" class="i">+
</a><a href="#h42-0-2" id="h42-0-2" class="i">+import android.content.Context
</a><a href="#h42-0-3" id="h42-0-3" class="i">+import java.io.File
</a><a href="#h42-0-4" id="h42-0-4" class="i">+
</a><a href="#h42-0-5" id="h42-0-5" class="i">+
</a><a href="#h42-0-6" id="h42-0-6" class="i">+enum class BridgeFileType(val value: Int, val fileName: String, val displayName: String, private val isDatabase: Boolean = false) {
</a><a href="#h42-0-7" id="h42-0-7" class="i">+    CONFIG(0, &quot;config.json&quot;, &quot;Config&quot;),
</a><a href="#h42-0-8" id="h42-0-8" class="i">+    MAPPINGS(1, &quot;mappings.json&quot;, &quot;Mappings&quot;),
</a><a href="#h42-0-9" id="h42-0-9" class="i">+    MESSAGE_LOGGER_DATABASE(2, &quot;message_logger.db&quot;, &quot;Message Logger&quot;,true),
</a><a href="#h42-0-10" id="h42-0-10" class="i">+    AUTO_UPDATER_TIMESTAMP(3, &quot;auto_updater_timestamp.txt&quot;, &quot;Auto Updater Timestamp&quot;),
</a><a href="#h42-0-11" id="h42-0-11" class="i">+    PINNED_CONVERSATIONS(4, &quot;pinned_conversations.txt&quot;, &quot;Pinned Conversations&quot;);
</a><a href="#h42-0-12" id="h42-0-12" class="i">+
</a><a href="#h42-0-13" id="h42-0-13" class="i">+    fun resolve(context: Context): File = if (isDatabase) {
</a><a href="#h42-0-14" id="h42-0-14" class="i">+        context.getDatabasePath(fileName)
</a><a href="#h42-0-15" id="h42-0-15" class="i">+    } else {
</a><a href="#h42-0-16" id="h42-0-16" class="i">+        File(context.filesDir, fileName)
</a><a href="#h42-0-17" id="h42-0-17" class="i">+    }
</a><a href="#h42-0-18" id="h42-0-18" class="i">+
</a><a href="#h42-0-19" id="h42-0-19" class="i">+    companion object {
</a><a href="#h42-0-20" id="h42-0-20" class="i">+        fun fromValue(value: Int): BridgeFileType? {
</a><a href="#h42-0-21" id="h42-0-21" class="i">+            return values().firstOrNull { it.value == value }
</a><a href="#h42-0-22" id="h42-0-22" class="i">+        }
</a><a href="#h42-0-23" id="h42-0-23" class="i">+    }
</a><a href="#h42-0-24" id="h42-0-24" class="i">+}</a><a href="#h42-0-25" id="h42-0-25" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h43" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/types/FileActionType.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/types/FileActionType.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/types/FileActionType.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/types/FileActionType.kt</a></b>
<a href="#h43-0" id="h43-0" class="h">@@ -0,0 +1,5 @@
</a><a href="#h43-0-0" id="h43-0-0" class="i">+package me.rhunk.snapenhance.core.bridge.types
</a><a href="#h43-0-1" id="h43-0-1" class="i">+
</a><a href="#h43-0-2" id="h43-0-2" class="i">+enum class FileActionType {
</a><a href="#h43-0-3" id="h43-0-3" class="i">+    CREATE_AND_READ, READ, WRITE, DELETE, EXISTS
</a><a href="#h43-0-4" id="h43-0-4" class="i">+}</a><a href="#h43-0-5" id="h43-0-5" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h44" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/wrapper/LocaleWrapper.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/wrapper/LocaleWrapper.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/wrapper/LocaleWrapper.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/wrapper/LocaleWrapper.kt</a></b>
<a href="#h44-0" id="h44-0" class="h">@@ -0,0 +1,100 @@
</a><a href="#h44-0-0" id="h44-0-0" class="i">+package me.rhunk.snapenhance.core.bridge.wrapper
</a><a href="#h44-0-1" id="h44-0-1" class="i">+
</a><a href="#h44-0-2" id="h44-0-2" class="i">+import android.content.Context
</a><a href="#h44-0-3" id="h44-0-3" class="i">+import com.google.gson.JsonObject
</a><a href="#h44-0-4" id="h44-0-4" class="i">+import com.google.gson.JsonParser
</a><a href="#h44-0-5" id="h44-0-5" class="i">+import me.rhunk.snapenhance.Logger
</a><a href="#h44-0-6" id="h44-0-6" class="i">+import me.rhunk.snapenhance.core.bridge.BridgeClient
</a><a href="#h44-0-7" id="h44-0-7" class="i">+import me.rhunk.snapenhance.data.LocalePair
</a><a href="#h44-0-8" id="h44-0-8" class="i">+import java.util.Locale
</a><a href="#h44-0-9" id="h44-0-9" class="i">+
</a><a href="#h44-0-10" id="h44-0-10" class="i">+
</a><a href="#h44-0-11" id="h44-0-11" class="i">+class LocaleWrapper {
</a><a href="#h44-0-12" id="h44-0-12" class="i">+    companion object {
</a><a href="#h44-0-13" id="h44-0-13" class="i">+        const val DEFAULT_LOCALE = &quot;en_US&quot;
</a><a href="#h44-0-14" id="h44-0-14" class="i">+
</a><a href="#h44-0-15" id="h44-0-15" class="i">+        fun fetchLocales(context: Context, locale: String = DEFAULT_LOCALE): List&lt;LocalePair&gt; {
</a><a href="#h44-0-16" id="h44-0-16" class="i">+            val locales = mutableListOf&lt;LocalePair&gt;().apply {
</a><a href="#h44-0-17" id="h44-0-17" class="i">+                add(LocalePair(DEFAULT_LOCALE, context.resources.assets.open(&quot;lang/$DEFAULT_LOCALE.json&quot;).bufferedReader().use { it.readText() }))
</a><a href="#h44-0-18" id="h44-0-18" class="i">+            }
</a><a href="#h44-0-19" id="h44-0-19" class="i">+
</a><a href="#h44-0-20" id="h44-0-20" class="i">+            if (locale == DEFAULT_LOCALE) return locales
</a><a href="#h44-0-21" id="h44-0-21" class="i">+
</a><a href="#h44-0-22" id="h44-0-22" class="i">+            val compatibleLocale = context.resources.assets.list(&quot;lang&quot;)?.firstOrNull { it.startsWith(locale) }?.substring(0, 5) ?: return locales
</a><a href="#h44-0-23" id="h44-0-23" class="i">+
</a><a href="#h44-0-24" id="h44-0-24" class="i">+            context.resources.assets.open(&quot;lang/$compatibleLocale.json&quot;).use { inputStream -&gt;
</a><a href="#h44-0-25" id="h44-0-25" class="i">+                locales.add(LocalePair(compatibleLocale, inputStream.bufferedReader().use { it.readText() }))
</a><a href="#h44-0-26" id="h44-0-26" class="i">+            }
</a><a href="#h44-0-27" id="h44-0-27" class="i">+
</a><a href="#h44-0-28" id="h44-0-28" class="i">+            return locales
</a><a href="#h44-0-29" id="h44-0-29" class="i">+        }
</a><a href="#h44-0-30" id="h44-0-30" class="i">+
</a><a href="#h44-0-31" id="h44-0-31" class="i">+        fun fetchAvailableLocales(context: Context): List&lt;String&gt; {
</a><a href="#h44-0-32" id="h44-0-32" class="i">+            return context.resources.assets.list(&quot;lang&quot;)?.map { it.substring(0, 5) } ?: listOf()
</a><a href="#h44-0-33" id="h44-0-33" class="i">+        }
</a><a href="#h44-0-34" id="h44-0-34" class="i">+    }
</a><a href="#h44-0-35" id="h44-0-35" class="i">+
</a><a href="#h44-0-36" id="h44-0-36" class="i">+    var userLocale = DEFAULT_LOCALE
</a><a href="#h44-0-37" id="h44-0-37" class="i">+
</a><a href="#h44-0-38" id="h44-0-38" class="i">+    private val translationMap = linkedMapOf&lt;String, String&gt;()
</a><a href="#h44-0-39" id="h44-0-39" class="i">+
</a><a href="#h44-0-40" id="h44-0-40" class="i">+    lateinit var loadedLocale: Locale
</a><a href="#h44-0-41" id="h44-0-41" class="i">+
</a><a href="#h44-0-42" id="h44-0-42" class="i">+    private fun load(localePair: LocalePair) {
</a><a href="#h44-0-43" id="h44-0-43" class="i">+        loadedLocale = localePair.locale.let { Locale(it.substring(0, 2), it.substring(3, 5)) }
</a><a href="#h44-0-44" id="h44-0-44" class="i">+
</a><a href="#h44-0-45" id="h44-0-45" class="i">+        val translations = JsonParser.parseString(localePair.content).asJsonObject
</a><a href="#h44-0-46" id="h44-0-46" class="i">+        if (translations == null || translations.isJsonNull) {
</a><a href="#h44-0-47" id="h44-0-47" class="i">+            return
</a><a href="#h44-0-48" id="h44-0-48" class="i">+        }
</a><a href="#h44-0-49" id="h44-0-49" class="i">+
</a><a href="#h44-0-50" id="h44-0-50" class="i">+        fun scanObject(jsonObject: JsonObject, prefix: String = &quot;&quot;) {
</a><a href="#h44-0-51" id="h44-0-51" class="i">+            jsonObject.entrySet().forEach {
</a><a href="#h44-0-52" id="h44-0-52" class="i">+                if (it.value.isJsonPrimitive) {
</a><a href="#h44-0-53" id="h44-0-53" class="i">+                    val key = &quot;$prefix${it.key}&quot;
</a><a href="#h44-0-54" id="h44-0-54" class="i">+                    translationMap[key] = it.value.asString
</a><a href="#h44-0-55" id="h44-0-55" class="i">+                }
</a><a href="#h44-0-56" id="h44-0-56" class="i">+                if (!it.value.isJsonObject) return@forEach
</a><a href="#h44-0-57" id="h44-0-57" class="i">+                scanObject(it.value.asJsonObject, &quot;$prefix${it.key}.&quot;)
</a><a href="#h44-0-58" id="h44-0-58" class="i">+            }
</a><a href="#h44-0-59" id="h44-0-59" class="i">+        }
</a><a href="#h44-0-60" id="h44-0-60" class="i">+
</a><a href="#h44-0-61" id="h44-0-61" class="i">+        scanObject(translations)
</a><a href="#h44-0-62" id="h44-0-62" class="i">+    }
</a><a href="#h44-0-63" id="h44-0-63" class="i">+
</a><a href="#h44-0-64" id="h44-0-64" class="i">+    fun loadFromBridge(bridgeClient: BridgeClient) {
</a><a href="#h44-0-65" id="h44-0-65" class="i">+        bridgeClient.fetchLocales(userLocale).forEach {
</a><a href="#h44-0-66" id="h44-0-66" class="i">+            load(it)
</a><a href="#h44-0-67" id="h44-0-67" class="i">+        }
</a><a href="#h44-0-68" id="h44-0-68" class="i">+    }
</a><a href="#h44-0-69" id="h44-0-69" class="i">+
</a><a href="#h44-0-70" id="h44-0-70" class="i">+    fun loadFromContext(context: Context) {
</a><a href="#h44-0-71" id="h44-0-71" class="i">+        fetchLocales(context, userLocale).forEach {
</a><a href="#h44-0-72" id="h44-0-72" class="i">+            load(it)
</a><a href="#h44-0-73" id="h44-0-73" class="i">+        }
</a><a href="#h44-0-74" id="h44-0-74" class="i">+    }
</a><a href="#h44-0-75" id="h44-0-75" class="i">+
</a><a href="#h44-0-76" id="h44-0-76" class="i">+    fun reloadFromContext(context: Context, locale: String) {
</a><a href="#h44-0-77" id="h44-0-77" class="i">+        userLocale = locale
</a><a href="#h44-0-78" id="h44-0-78" class="i">+        translationMap.clear()
</a><a href="#h44-0-79" id="h44-0-79" class="i">+        loadFromContext(context)
</a><a href="#h44-0-80" id="h44-0-80" class="i">+    }
</a><a href="#h44-0-81" id="h44-0-81" class="i">+
</a><a href="#h44-0-82" id="h44-0-82" class="i">+    operator fun get(key: String) = translationMap[key] ?: key.also { Logger.directDebug(&quot;Missing translation for $key&quot;) }
</a><a href="#h44-0-83" id="h44-0-83" class="i">+
</a><a href="#h44-0-84" id="h44-0-84" class="i">+    fun format(key: String, vararg args: Pair&lt;String, String&gt;): String {
</a><a href="#h44-0-85" id="h44-0-85" class="i">+        return args.fold(get(key)) { acc, pair -&gt;
</a><a href="#h44-0-86" id="h44-0-86" class="i">+            acc.replace(&quot;{${pair.first}}&quot;, pair.second)
</a><a href="#h44-0-87" id="h44-0-87" class="i">+        }
</a><a href="#h44-0-88" id="h44-0-88" class="i">+    }
</a><a href="#h44-0-89" id="h44-0-89" class="i">+
</a><a href="#h44-0-90" id="h44-0-90" class="i">+    fun getCategory(key: String): LocaleWrapper {
</a><a href="#h44-0-91" id="h44-0-91" class="i">+        return LocaleWrapper().apply {
</a><a href="#h44-0-92" id="h44-0-92" class="i">+            translationMap.putAll(
</a><a href="#h44-0-93" id="h44-0-93" class="i">+                this@LocaleWrapper.translationMap
</a><a href="#h44-0-94" id="h44-0-94" class="i">+                    .filterKeys { it.startsWith(&quot;$key.&quot;) }
</a><a href="#h44-0-95" id="h44-0-95" class="i">+                    .mapKeys { it.key.substring(key.length + 1) }
</a><a href="#h44-0-96" id="h44-0-96" class="i">+            )
</a><a href="#h44-0-97" id="h44-0-97" class="i">+        }
</a><a href="#h44-0-98" id="h44-0-98" class="i">+    }
</a><a href="#h44-0-99" id="h44-0-99" class="i">+}</a><a href="#h44-0-100" id="h44-0-100" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h45" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/wrapper/MappingsWrapper.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/wrapper/MappingsWrapper.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/wrapper/MappingsWrapper.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/wrapper/MappingsWrapper.kt</a></b>
<a href="#h45-0" id="h45-0" class="h">@@ -0,0 +1,162 @@
</a><a href="#h45-0-0" id="h45-0-0" class="i">+package me.rhunk.snapenhance.core.bridge.wrapper
</a><a href="#h45-0-1" id="h45-0-1" class="i">+
</a><a href="#h45-0-2" id="h45-0-2" class="i">+import android.content.Context
</a><a href="#h45-0-3" id="h45-0-3" class="i">+import com.google.gson.GsonBuilder
</a><a href="#h45-0-4" id="h45-0-4" class="i">+import com.google.gson.JsonElement
</a><a href="#h45-0-5" id="h45-0-5" class="i">+import com.google.gson.JsonParser
</a><a href="#h45-0-6" id="h45-0-6" class="i">+import me.rhunk.snapenhance.Constants
</a><a href="#h45-0-7" id="h45-0-7" class="i">+import me.rhunk.snapenhance.Logger
</a><a href="#h45-0-8" id="h45-0-8" class="i">+import me.rhunk.snapenhance.core.bridge.FileLoaderWrapper
</a><a href="#h45-0-9" id="h45-0-9" class="i">+import me.rhunk.snapenhance.core.bridge.types.BridgeFileType
</a><a href="#h45-0-10" id="h45-0-10" class="i">+import me.rhunk.snapmapper.Mapper
</a><a href="#h45-0-11" id="h45-0-11" class="i">+import me.rhunk.snapmapper.impl.BCryptClassMapper
</a><a href="#h45-0-12" id="h45-0-12" class="i">+import me.rhunk.snapmapper.impl.CallbackMapper
</a><a href="#h45-0-13" id="h45-0-13" class="i">+import me.rhunk.snapmapper.impl.CompositeConfigurationProviderMapper
</a><a href="#h45-0-14" id="h45-0-14" class="i">+import me.rhunk.snapmapper.impl.DefaultMediaItemMapper
</a><a href="#h45-0-15" id="h45-0-15" class="i">+import me.rhunk.snapmapper.impl.EnumMapper
</a><a href="#h45-0-16" id="h45-0-16" class="i">+import me.rhunk.snapmapper.impl.FriendsFeedEventDispatcherMapper
</a><a href="#h45-0-17" id="h45-0-17" class="i">+import me.rhunk.snapmapper.impl.MediaQualityLevelProviderMapper
</a><a href="#h45-0-18" id="h45-0-18" class="i">+import me.rhunk.snapmapper.impl.OperaPageViewControllerMapper
</a><a href="#h45-0-19" id="h45-0-19" class="i">+import me.rhunk.snapmapper.impl.PlatformAnalyticsCreatorMapper
</a><a href="#h45-0-20" id="h45-0-20" class="i">+import me.rhunk.snapmapper.impl.PlusSubscriptionMapper
</a><a href="#h45-0-21" id="h45-0-21" class="i">+import me.rhunk.snapmapper.impl.ScCameraSettingsMapper
</a><a href="#h45-0-22" id="h45-0-22" class="i">+import me.rhunk.snapmapper.impl.ScoreUpdateMapper
</a><a href="#h45-0-23" id="h45-0-23" class="i">+import me.rhunk.snapmapper.impl.StoryBoostStateMapper
</a><a href="#h45-0-24" id="h45-0-24" class="i">+import java.util.concurrent.ConcurrentHashMap
</a><a href="#h45-0-25" id="h45-0-25" class="i">+import kotlin.system.measureTimeMillis
</a><a href="#h45-0-26" id="h45-0-26" class="i">+
</a><a href="#h45-0-27" id="h45-0-27" class="i">+class MappingsWrapper : FileLoaderWrapper(BridgeFileType.MAPPINGS, &quot;{}&quot;.toByteArray(Charsets.UTF_8)) {
</a><a href="#h45-0-28" id="h45-0-28" class="i">+    companion object {
</a><a href="#h45-0-29" id="h45-0-29" class="i">+        private val gson = GsonBuilder().setPrettyPrinting().create()
</a><a href="#h45-0-30" id="h45-0-30" class="i">+        private val mappers = arrayOf(
</a><a href="#h45-0-31" id="h45-0-31" class="i">+            BCryptClassMapper::class,
</a><a href="#h45-0-32" id="h45-0-32" class="i">+            CallbackMapper::class,
</a><a href="#h45-0-33" id="h45-0-33" class="i">+            DefaultMediaItemMapper::class,
</a><a href="#h45-0-34" id="h45-0-34" class="i">+            MediaQualityLevelProviderMapper::class,
</a><a href="#h45-0-35" id="h45-0-35" class="i">+            EnumMapper::class,
</a><a href="#h45-0-36" id="h45-0-36" class="i">+            OperaPageViewControllerMapper::class,
</a><a href="#h45-0-37" id="h45-0-37" class="i">+            PlatformAnalyticsCreatorMapper::class,
</a><a href="#h45-0-38" id="h45-0-38" class="i">+            PlusSubscriptionMapper::class,
</a><a href="#h45-0-39" id="h45-0-39" class="i">+            ScCameraSettingsMapper::class,
</a><a href="#h45-0-40" id="h45-0-40" class="i">+            StoryBoostStateMapper::class,
</a><a href="#h45-0-41" id="h45-0-41" class="i">+            FriendsFeedEventDispatcherMapper::class,
</a><a href="#h45-0-42" id="h45-0-42" class="i">+            CompositeConfigurationProviderMapper::class,
</a><a href="#h45-0-43" id="h45-0-43" class="i">+            ScoreUpdateMapper::class
</a><a href="#h45-0-44" id="h45-0-44" class="i">+        )
</a><a href="#h45-0-45" id="h45-0-45" class="i">+    }
</a><a href="#h45-0-46" id="h45-0-46" class="i">+
</a><a href="#h45-0-47" id="h45-0-47" class="i">+    private lateinit var context: Context
</a><a href="#h45-0-48" id="h45-0-48" class="i">+
</a><a href="#h45-0-49" id="h45-0-49" class="i">+    private val mappings = ConcurrentHashMap&lt;String, Any&gt;()
</a><a href="#h45-0-50" id="h45-0-50" class="i">+    private var snapBuildNumber: Long = 0
</a><a href="#h45-0-51" id="h45-0-51" class="i">+
</a><a href="#h45-0-52" id="h45-0-52" class="i">+    fun init(context: Context) {
</a><a href="#h45-0-53" id="h45-0-53" class="i">+        this.context = context
</a><a href="#h45-0-54" id="h45-0-54" class="i">+        snapBuildNumber = getSnapchatVersionCode()
</a><a href="#h45-0-55" id="h45-0-55" class="i">+
</a><a href="#h45-0-56" id="h45-0-56" class="i">+        if (isFileExists()) {
</a><a href="#h45-0-57" id="h45-0-57" class="i">+            runCatching {
</a><a href="#h45-0-58" id="h45-0-58" class="i">+                loadCached()
</a><a href="#h45-0-59" id="h45-0-59" class="i">+            }.onFailure {
</a><a href="#h45-0-60" id="h45-0-60" class="i">+                delete()
</a><a href="#h45-0-61" id="h45-0-61" class="i">+            }
</a><a href="#h45-0-62" id="h45-0-62" class="i">+        }
</a><a href="#h45-0-63" id="h45-0-63" class="i">+    }
</a><a href="#h45-0-64" id="h45-0-64" class="i">+
</a><a href="#h45-0-65" id="h45-0-65" class="i">+    fun getSnapchatPackageInfo() = runCatching {
</a><a href="#h45-0-66" id="h45-0-66" class="i">+        context.packageManager.getPackageInfo(
</a><a href="#h45-0-67" id="h45-0-67" class="i">+            Constants.SNAPCHAT_PACKAGE_NAME,
</a><a href="#h45-0-68" id="h45-0-68" class="i">+            0
</a><a href="#h45-0-69" id="h45-0-69" class="i">+        )
</a><a href="#h45-0-70" id="h45-0-70" class="i">+    }.getOrNull()
</a><a href="#h45-0-71" id="h45-0-71" class="i">+
</a><a href="#h45-0-72" id="h45-0-72" class="i">+    fun getSnapchatVersionCode() = getSnapchatPackageInfo()?.longVersionCode ?: -1
</a><a href="#h45-0-73" id="h45-0-73" class="i">+    fun getApplicationSourceDir() = getSnapchatPackageInfo()?.applicationInfo?.sourceDir
</a><a href="#h45-0-74" id="h45-0-74" class="i">+    fun getGeneratedBuildNumber() = snapBuildNumber
</a><a href="#h45-0-75" id="h45-0-75" class="i">+
</a><a href="#h45-0-76" id="h45-0-76" class="i">+    fun isMappingsOutdated(): Boolean {
</a><a href="#h45-0-77" id="h45-0-77" class="i">+        return snapBuildNumber != getSnapchatVersionCode() || isMappingsLoaded().not()
</a><a href="#h45-0-78" id="h45-0-78" class="i">+    }
</a><a href="#h45-0-79" id="h45-0-79" class="i">+
</a><a href="#h45-0-80" id="h45-0-80" class="i">+    fun isMappingsLoaded(): Boolean {
</a><a href="#h45-0-81" id="h45-0-81" class="i">+        return mappings.isNotEmpty()
</a><a href="#h45-0-82" id="h45-0-82" class="i">+    }
</a><a href="#h45-0-83" id="h45-0-83" class="i">+
</a><a href="#h45-0-84" id="h45-0-84" class="i">+    private fun loadCached() {
</a><a href="#h45-0-85" id="h45-0-85" class="i">+        if (!isFileExists()) {
</a><a href="#h45-0-86" id="h45-0-86" class="i">+            throw Exception(&quot;Mappings file does not exist&quot;)
</a><a href="#h45-0-87" id="h45-0-87" class="i">+        }
</a><a href="#h45-0-88" id="h45-0-88" class="i">+        val mappingsObject = JsonParser.parseString(read().toString(Charsets.UTF_8)).asJsonObject.also {
</a><a href="#h45-0-89" id="h45-0-89" class="i">+            snapBuildNumber = it[&quot;snap_build_number&quot;].asLong
</a><a href="#h45-0-90" id="h45-0-90" class="i">+        }
</a><a href="#h45-0-91" id="h45-0-91" class="i">+
</a><a href="#h45-0-92" id="h45-0-92" class="i">+        mappingsObject.entrySet().forEach { (key, value): Map.Entry&lt;String, JsonElement&gt; -&gt;
</a><a href="#h45-0-93" id="h45-0-93" class="i">+            if (value.isJsonArray) {
</a><a href="#h45-0-94" id="h45-0-94" class="i">+                mappings[key] = gson.fromJson(value, ArrayList::class.java)
</a><a href="#h45-0-95" id="h45-0-95" class="i">+                return@forEach
</a><a href="#h45-0-96" id="h45-0-96" class="i">+            }
</a><a href="#h45-0-97" id="h45-0-97" class="i">+            if (value.isJsonObject) {
</a><a href="#h45-0-98" id="h45-0-98" class="i">+                mappings[key] = gson.fromJson(value, ConcurrentHashMap::class.java)
</a><a href="#h45-0-99" id="h45-0-99" class="i">+                return@forEach
</a><a href="#h45-0-100" id="h45-0-100" class="i">+            }
</a><a href="#h45-0-101" id="h45-0-101" class="i">+            mappings[key] = value.asString
</a><a href="#h45-0-102" id="h45-0-102" class="i">+        }
</a><a href="#h45-0-103" id="h45-0-103" class="i">+    }
</a><a href="#h45-0-104" id="h45-0-104" class="i">+
</a><a href="#h45-0-105" id="h45-0-105" class="i">+    fun refresh() {
</a><a href="#h45-0-106" id="h45-0-106" class="i">+        snapBuildNumber = getSnapchatVersionCode()
</a><a href="#h45-0-107" id="h45-0-107" class="i">+        val mapper = Mapper(*mappers)
</a><a href="#h45-0-108" id="h45-0-108" class="i">+
</a><a href="#h45-0-109" id="h45-0-109" class="i">+        runCatching {
</a><a href="#h45-0-110" id="h45-0-110" class="i">+            mapper.loadApk(getApplicationSourceDir() ?: throw Exception(&quot;Failed to get APK&quot;))
</a><a href="#h45-0-111" id="h45-0-111" class="i">+        }.onFailure {
</a><a href="#h45-0-112" id="h45-0-112" class="i">+            throw Exception(&quot;Failed to load APK&quot;, it)
</a><a href="#h45-0-113" id="h45-0-113" class="i">+        }
</a><a href="#h45-0-114" id="h45-0-114" class="i">+
</a><a href="#h45-0-115" id="h45-0-115" class="i">+        measureTimeMillis {
</a><a href="#h45-0-116" id="h45-0-116" class="i">+            val result = mapper.start().apply {
</a><a href="#h45-0-117" id="h45-0-117" class="i">+                addProperty(&quot;snap_build_number&quot;, snapBuildNumber)
</a><a href="#h45-0-118" id="h45-0-118" class="i">+            }
</a><a href="#h45-0-119" id="h45-0-119" class="i">+            write(result.toString().toByteArray())
</a><a href="#h45-0-120" id="h45-0-120" class="i">+        }.also {
</a><a href="#h45-0-121" id="h45-0-121" class="i">+            Logger.directDebug(&quot;Generated mappings in $it ms&quot;)
</a><a href="#h45-0-122" id="h45-0-122" class="i">+        }
</a><a href="#h45-0-123" id="h45-0-123" class="i">+    }
</a><a href="#h45-0-124" id="h45-0-124" class="i">+
</a><a href="#h45-0-125" id="h45-0-125" class="i">+    fun getMappedObject(key: String): Any {
</a><a href="#h45-0-126" id="h45-0-126" class="i">+        if (mappings.containsKey(key)) {
</a><a href="#h45-0-127" id="h45-0-127" class="i">+            return mappings[key]!!
</a><a href="#h45-0-128" id="h45-0-128" class="i">+        }
</a><a href="#h45-0-129" id="h45-0-129" class="i">+        throw Exception(&quot;No mapping found for $key&quot;)
</a><a href="#h45-0-130" id="h45-0-130" class="i">+    }
</a><a href="#h45-0-131" id="h45-0-131" class="i">+
</a><a href="#h45-0-132" id="h45-0-132" class="i">+    fun getMappedObjectNullable(key: String): Any? {
</a><a href="#h45-0-133" id="h45-0-133" class="i">+        return mappings[key]
</a><a href="#h45-0-134" id="h45-0-134" class="i">+    }
</a><a href="#h45-0-135" id="h45-0-135" class="i">+
</a><a href="#h45-0-136" id="h45-0-136" class="i">+    fun getMappedClass(className: String): Class&lt;*&gt; {
</a><a href="#h45-0-137" id="h45-0-137" class="i">+        return context.classLoader.loadClass(getMappedObject(className) as String)
</a><a href="#h45-0-138" id="h45-0-138" class="i">+    }
</a><a href="#h45-0-139" id="h45-0-139" class="i">+
</a><a href="#h45-0-140" id="h45-0-140" class="i">+    fun getMappedClass(key: String, subKey: String): Class&lt;*&gt; {
</a><a href="#h45-0-141" id="h45-0-141" class="i">+        return context.classLoader.loadClass(getMappedValue(key, subKey))
</a><a href="#h45-0-142" id="h45-0-142" class="i">+    }
</a><a href="#h45-0-143" id="h45-0-143" class="i">+
</a><a href="#h45-0-144" id="h45-0-144" class="i">+    fun getMappedValue(key: String): String {
</a><a href="#h45-0-145" id="h45-0-145" class="i">+        return getMappedObject(key) as String
</a><a href="#h45-0-146" id="h45-0-146" class="i">+    }
</a><a href="#h45-0-147" id="h45-0-147" class="i">+
</a><a href="#h45-0-148" id="h45-0-148" class="i">+    @Suppress(&quot;UNCHECKED_CAST&quot;)
</a><a href="#h45-0-149" id="h45-0-149" class="i">+    fun &lt;T : Any&gt; getMappedList(key: String): List&lt;T&gt; {
</a><a href="#h45-0-150" id="h45-0-150" class="i">+        return listOf(getMappedObject(key) as List&lt;T&gt;).flatten()
</a><a href="#h45-0-151" id="h45-0-151" class="i">+    }
</a><a href="#h45-0-152" id="h45-0-152" class="i">+
</a><a href="#h45-0-153" id="h45-0-153" class="i">+    fun getMappedValue(key: String, subKey: String): String {
</a><a href="#h45-0-154" id="h45-0-154" class="i">+        return getMappedMap(key)[subKey] as String
</a><a href="#h45-0-155" id="h45-0-155" class="i">+    }
</a><a href="#h45-0-156" id="h45-0-156" class="i">+
</a><a href="#h45-0-157" id="h45-0-157" class="i">+    @Suppress(&quot;UNCHECKED_CAST&quot;)
</a><a href="#h45-0-158" id="h45-0-158" class="i">+    fun getMappedMap(key: String): Map&lt;String, *&gt; {
</a><a href="#h45-0-159" id="h45-0-159" class="i">+        return getMappedObject(key) as Map&lt;String, *&gt;
</a><a href="#h45-0-160" id="h45-0-160" class="i">+    }
</a><a href="#h45-0-161" id="h45-0-161" class="i">+}</a><a href="#h45-0-162" id="h45-0-162" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h46" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/wrapper/MessageLoggerWrapper.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/wrapper/MessageLoggerWrapper.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/wrapper/MessageLoggerWrapper.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/wrapper/MessageLoggerWrapper.kt</a></b>
<a href="#h46-0" id="h46-0" class="h">@@ -0,0 +1,70 @@
</a><a href="#h46-0-0" id="h46-0-0" class="i">+package me.rhunk.snapenhance.core.bridge.wrapper
</a><a href="#h46-0-1" id="h46-0-1" class="i">+
</a><a href="#h46-0-2" id="h46-0-2" class="i">+import android.content.ContentValues
</a><a href="#h46-0-3" id="h46-0-3" class="i">+import android.database.sqlite.SQLiteDatabase
</a><a href="#h46-0-4" id="h46-0-4" class="i">+import me.rhunk.snapenhance.util.SQLiteDatabaseHelper
</a><a href="#h46-0-5" id="h46-0-5" class="i">+import java.io.File
</a><a href="#h46-0-6" id="h46-0-6" class="i">+
</a><a href="#h46-0-7" id="h46-0-7" class="i">+class MessageLoggerWrapper(
</a><a href="#h46-0-8" id="h46-0-8" class="i">+    private val databaseFile: File
</a><a href="#h46-0-9" id="h46-0-9" class="i">+) {
</a><a href="#h46-0-10" id="h46-0-10" class="i">+
</a><a href="#h46-0-11" id="h46-0-11" class="i">+    lateinit var database: SQLiteDatabase
</a><a href="#h46-0-12" id="h46-0-12" class="i">+
</a><a href="#h46-0-13" id="h46-0-13" class="i">+    fun init() {
</a><a href="#h46-0-14" id="h46-0-14" class="i">+        database = SQLiteDatabase.openDatabase(databaseFile.absolutePath, null, SQLiteDatabase.CREATE_IF_NECESSARY or SQLiteDatabase.OPEN_READWRITE)
</a><a href="#h46-0-15" id="h46-0-15" class="i">+        SQLiteDatabaseHelper.createTablesFromSchema(database, mapOf(
</a><a href="#h46-0-16" id="h46-0-16" class="i">+            &quot;messages&quot; to listOf(
</a><a href="#h46-0-17" id="h46-0-17" class="i">+                &quot;id INTEGER PRIMARY KEY&quot;,
</a><a href="#h46-0-18" id="h46-0-18" class="i">+                &quot;conversation_id VARCHAR&quot;,
</a><a href="#h46-0-19" id="h46-0-19" class="i">+                &quot;message_id BIGINT&quot;,
</a><a href="#h46-0-20" id="h46-0-20" class="i">+                &quot;message_data BLOB&quot;
</a><a href="#h46-0-21" id="h46-0-21" class="i">+            )
</a><a href="#h46-0-22" id="h46-0-22" class="i">+        ))
</a><a href="#h46-0-23" id="h46-0-23" class="i">+    }
</a><a href="#h46-0-24" id="h46-0-24" class="i">+
</a><a href="#h46-0-25" id="h46-0-25" class="i">+    fun deleteMessage(conversationId: String, messageId: Long) {
</a><a href="#h46-0-26" id="h46-0-26" class="i">+        database.execSQL(&quot;DELETE FROM messages WHERE conversation_id = ? AND message_id = ?&quot;, arrayOf(conversationId, messageId.toString()))
</a><a href="#h46-0-27" id="h46-0-27" class="i">+    }
</a><a href="#h46-0-28" id="h46-0-28" class="i">+
</a><a href="#h46-0-29" id="h46-0-29" class="i">+    fun addMessage(conversationId: String, messageId: Long, serializedMessage: ByteArray): Boolean {
</a><a href="#h46-0-30" id="h46-0-30" class="i">+        val cursor = database.rawQuery(&quot;SELECT message_id FROM messages WHERE conversation_id = ? AND message_id = ?&quot;, arrayOf(conversationId, messageId.toString()))
</a><a href="#h46-0-31" id="h46-0-31" class="i">+        val state = cursor.moveToFirst()
</a><a href="#h46-0-32" id="h46-0-32" class="i">+        cursor.close()
</a><a href="#h46-0-33" id="h46-0-33" class="i">+        if (state) {
</a><a href="#h46-0-34" id="h46-0-34" class="i">+            return false
</a><a href="#h46-0-35" id="h46-0-35" class="i">+        }
</a><a href="#h46-0-36" id="h46-0-36" class="i">+        database.insert(&quot;messages&quot;, null, ContentValues().apply {
</a><a href="#h46-0-37" id="h46-0-37" class="i">+            put(&quot;conversation_id&quot;, conversationId)
</a><a href="#h46-0-38" id="h46-0-38" class="i">+            put(&quot;message_id&quot;, messageId)
</a><a href="#h46-0-39" id="h46-0-39" class="i">+            put(&quot;message_data&quot;, serializedMessage)
</a><a href="#h46-0-40" id="h46-0-40" class="i">+        })
</a><a href="#h46-0-41" id="h46-0-41" class="i">+        return true
</a><a href="#h46-0-42" id="h46-0-42" class="i">+    }
</a><a href="#h46-0-43" id="h46-0-43" class="i">+
</a><a href="#h46-0-44" id="h46-0-44" class="i">+    fun getMessage(conversationId: String, messageId: Long): Pair&lt;Boolean, ByteArray?&gt; {
</a><a href="#h46-0-45" id="h46-0-45" class="i">+        val cursor = database.rawQuery(&quot;SELECT message_data FROM messages WHERE conversation_id = ? AND message_id = ?&quot;, arrayOf(conversationId, messageId.toString()))
</a><a href="#h46-0-46" id="h46-0-46" class="i">+        val state = cursor.moveToFirst()
</a><a href="#h46-0-47" id="h46-0-47" class="i">+        val message: ByteArray? = if (state) {
</a><a href="#h46-0-48" id="h46-0-48" class="i">+            cursor.getBlob(0)
</a><a href="#h46-0-49" id="h46-0-49" class="i">+        } else {
</a><a href="#h46-0-50" id="h46-0-50" class="i">+            null
</a><a href="#h46-0-51" id="h46-0-51" class="i">+        }
</a><a href="#h46-0-52" id="h46-0-52" class="i">+        cursor.close()
</a><a href="#h46-0-53" id="h46-0-53" class="i">+        return Pair(state, message)
</a><a href="#h46-0-54" id="h46-0-54" class="i">+    }
</a><a href="#h46-0-55" id="h46-0-55" class="i">+
</a><a href="#h46-0-56" id="h46-0-56" class="i">+    fun getMessageIds(conversationId: String, limit: Int): List&lt;Long&gt; {
</a><a href="#h46-0-57" id="h46-0-57" class="i">+        val cursor = database.rawQuery(&quot;SELECT message_id FROM messages WHERE conversation_id = ? ORDER BY message_id DESC LIMIT ?&quot;, arrayOf(conversationId, limit.toString()))
</a><a href="#h46-0-58" id="h46-0-58" class="i">+        val messageIds = mutableListOf&lt;Long&gt;()
</a><a href="#h46-0-59" id="h46-0-59" class="i">+        while (cursor.moveToNext()) {
</a><a href="#h46-0-60" id="h46-0-60" class="i">+            messageIds.add(cursor.getLong(0))
</a><a href="#h46-0-61" id="h46-0-61" class="i">+        }
</a><a href="#h46-0-62" id="h46-0-62" class="i">+        cursor.close()
</a><a href="#h46-0-63" id="h46-0-63" class="i">+        return messageIds
</a><a href="#h46-0-64" id="h46-0-64" class="i">+    }
</a><a href="#h46-0-65" id="h46-0-65" class="i">+
</a><a href="#h46-0-66" id="h46-0-66" class="i">+    fun clearMessages() {
</a><a href="#h46-0-67" id="h46-0-67" class="i">+        database.execSQL(&quot;DELETE FROM messages&quot;)
</a><a href="#h46-0-68" id="h46-0-68" class="i">+    }
</a><a href="#h46-0-69" id="h46-0-69" class="i">+}</a><a href="#h46-0-70" id="h46-0-70" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h47" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/config/ConfigObjects.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/config/ConfigObjects.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/config/ConfigObjects.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/config/ConfigObjects.kt</a></b>
<a href="#h47-0" id="h47-0" class="h">@@ -1,6 +1,6 @@
</a> package me.rhunk.snapenhance.core.config
 
<a href="#h47-0-2" id="h47-0-2" class="d">-import me.rhunk.snapenhance.bridge.wrapper.LocaleWrapper
</a><a href="#h47-0-3" id="h47-0-3" class="i">+import me.rhunk.snapenhance.core.bridge.wrapper.LocaleWrapper
</a> import kotlin.reflect.KProperty
 
 
<b>diff --git a/<a id="h48" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/config/ModConfig.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/config/ModConfig.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/config/ModConfig.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/config/ModConfig.kt</a></b>
<a href="#h48-0" id="h48-0" class="h">@@ -4,11 +4,10 @@ import android.content.Context
</a> import com.google.gson.Gson
 import com.google.gson.GsonBuilder
 import com.google.gson.JsonObject
<a href="#h48-0-3" id="h48-0-3" class="d">-import me.rhunk.snapenhance.Logger
</a><a href="#h48-0-4" id="h48-0-4" class="d">-import me.rhunk.snapenhance.bridge.BridgeClient
</a><a href="#h48-0-5" id="h48-0-5" class="d">-import me.rhunk.snapenhance.bridge.FileLoaderWrapper
</a><a href="#h48-0-6" id="h48-0-6" class="d">-import me.rhunk.snapenhance.bridge.types.BridgeFileType
</a><a href="#h48-0-7" id="h48-0-7" class="d">-import me.rhunk.snapenhance.bridge.wrapper.LocaleWrapper
</a><a href="#h48-0-8" id="h48-0-8" class="i">+import me.rhunk.snapenhance.core.bridge.BridgeClient
</a><a href="#h48-0-9" id="h48-0-9" class="i">+import me.rhunk.snapenhance.core.bridge.FileLoaderWrapper
</a><a href="#h48-0-10" id="h48-0-10" class="i">+import me.rhunk.snapenhance.core.bridge.types.BridgeFileType
</a><a href="#h48-0-11" id="h48-0-11" class="i">+import me.rhunk.snapenhance.core.bridge.wrapper.LocaleWrapper
</a> import me.rhunk.snapenhance.core.config.impl.RootConfig
 import kotlin.properties.Delegates
 
<a href="#h48-1" id="h48-1" class="h">@@ -33,7 +32,6 @@ class ModConfig {
</a>         runCatching {
             loadConfig()
         }.onFailure {
<a href="#h48-1-3" id="h48-1-3" class="d">-            Logger.error(&quot;Failed to load config&quot;, it)
</a>             writeConfig()
         }
     }
<b>diff --git a/<a id="h49" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/Experimental.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/Experimental.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/Experimental.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/Experimental.kt</a></b>
<a href="#h49-0" id="h49-0" class="h">@@ -1,6 +1,7 @@
</a> package me.rhunk.snapenhance.core.config.impl
 
 import me.rhunk.snapenhance.core.config.ConfigContainer
<a href="#h49-0-3" id="h49-0-3" class="i">+import me.rhunk.snapenhance.core.config.FeatureNotice
</a> 
 class Experimental : ConfigContainer() {
     val nativeHooks = container(&quot;native_hooks&quot;, NativeHooks()) { icon = &quot;Memory&quot; }
<a href="#h49-1" id="h49-1" class="h">@@ -9,6 +10,6 @@ class Experimental : ConfigContainer() {
</a>     val appLockOnResume = boolean(&quot;app_lock_on_resume&quot;)
     val infiniteStoryBoost = boolean(&quot;infinite_story_boost&quot;)
     val meoPasscodeBypass = boolean(&quot;meo_passcode_bypass&quot;)
<a href="#h49-1-3" id="h49-1-3" class="d">-    val unlimitedMultiSnap = boolean(&quot;unlimited_multi_snap&quot;)
</a><a href="#h49-1-4" id="h49-1-4" class="i">+    val unlimitedMultiSnap = boolean(&quot;unlimited_multi_snap&quot;) { addNotices(FeatureNotice.MAY_BAN)}
</a>     val noFriendScoreDelay = boolean(&quot;no_friend_score_delay&quot;)
 } 
\ No newline at end of file
<b>diff --git a/<a id="h50" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/database/DatabaseAccess.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/database/DatabaseAccess.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/database/DatabaseAccess.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/database/DatabaseAccess.kt</a></b>
<a href="#h50-0" id="h50-0" class="h">@@ -0,0 +1,257 @@
</a><a href="#h50-0-0" id="h50-0-0" class="i">+package me.rhunk.snapenhance.core.database
</a><a href="#h50-0-1" id="h50-0-1" class="i">+
</a><a href="#h50-0-2" id="h50-0-2" class="i">+import android.annotation.SuppressLint
</a><a href="#h50-0-3" id="h50-0-3" class="i">+import android.database.sqlite.SQLiteDatabase
</a><a href="#h50-0-4" id="h50-0-4" class="i">+import me.rhunk.snapenhance.Logger
</a><a href="#h50-0-5" id="h50-0-5" class="i">+import me.rhunk.snapenhance.ModContext
</a><a href="#h50-0-6" id="h50-0-6" class="i">+import me.rhunk.snapenhance.core.database.objects.ConversationMessage
</a><a href="#h50-0-7" id="h50-0-7" class="i">+import me.rhunk.snapenhance.core.database.objects.FriendFeedEntry
</a><a href="#h50-0-8" id="h50-0-8" class="i">+import me.rhunk.snapenhance.core.database.objects.FriendInfo
</a><a href="#h50-0-9" id="h50-0-9" class="i">+import me.rhunk.snapenhance.core.database.objects.StoryEntry
</a><a href="#h50-0-10" id="h50-0-10" class="i">+import me.rhunk.snapenhance.core.database.objects.UserConversationLink
</a><a href="#h50-0-11" id="h50-0-11" class="i">+import me.rhunk.snapenhance.manager.Manager
</a><a href="#h50-0-12" id="h50-0-12" class="i">+import java.io.File
</a><a href="#h50-0-13" id="h50-0-13" class="i">+
</a><a href="#h50-0-14" id="h50-0-14" class="i">+@SuppressLint(&quot;Range&quot;)
</a><a href="#h50-0-15" id="h50-0-15" class="i">+class DatabaseAccess(private val context: ModContext) : Manager {
</a><a href="#h50-0-16" id="h50-0-16" class="i">+    private val databaseLock = Any()
</a><a href="#h50-0-17" id="h50-0-17" class="i">+
</a><a href="#h50-0-18" id="h50-0-18" class="i">+    private val arroyoDatabase: File by lazy {
</a><a href="#h50-0-19" id="h50-0-19" class="i">+        context.androidContext.getDatabasePath(&quot;arroyo.db&quot;)
</a><a href="#h50-0-20" id="h50-0-20" class="i">+    }
</a><a href="#h50-0-21" id="h50-0-21" class="i">+
</a><a href="#h50-0-22" id="h50-0-22" class="i">+    private val mainDatabase: File by lazy {
</a><a href="#h50-0-23" id="h50-0-23" class="i">+        context.androidContext.getDatabasePath(&quot;main.db&quot;)
</a><a href="#h50-0-24" id="h50-0-24" class="i">+    }
</a><a href="#h50-0-25" id="h50-0-25" class="i">+
</a><a href="#h50-0-26" id="h50-0-26" class="i">+    private fun openMain(): SQLiteDatabase {
</a><a href="#h50-0-27" id="h50-0-27" class="i">+        return SQLiteDatabase.openDatabase(
</a><a href="#h50-0-28" id="h50-0-28" class="i">+            mainDatabase.absolutePath,
</a><a href="#h50-0-29" id="h50-0-29" class="i">+            null,
</a><a href="#h50-0-30" id="h50-0-30" class="i">+            SQLiteDatabase.OPEN_READONLY
</a><a href="#h50-0-31" id="h50-0-31" class="i">+        )!!
</a><a href="#h50-0-32" id="h50-0-32" class="i">+    }
</a><a href="#h50-0-33" id="h50-0-33" class="i">+
</a><a href="#h50-0-34" id="h50-0-34" class="i">+    private fun openArroyo(): SQLiteDatabase {
</a><a href="#h50-0-35" id="h50-0-35" class="i">+        return SQLiteDatabase.openDatabase(
</a><a href="#h50-0-36" id="h50-0-36" class="i">+            arroyoDatabase.absolutePath,
</a><a href="#h50-0-37" id="h50-0-37" class="i">+            null,
</a><a href="#h50-0-38" id="h50-0-38" class="i">+            SQLiteDatabase.OPEN_READONLY
</a><a href="#h50-0-39" id="h50-0-39" class="i">+        )!!
</a><a href="#h50-0-40" id="h50-0-40" class="i">+    }
</a><a href="#h50-0-41" id="h50-0-41" class="i">+
</a><a href="#h50-0-42" id="h50-0-42" class="i">+    fun hasArroyo(): Boolean {
</a><a href="#h50-0-43" id="h50-0-43" class="i">+        return arroyoDatabase.exists()
</a><a href="#h50-0-44" id="h50-0-44" class="i">+    }
</a><a href="#h50-0-45" id="h50-0-45" class="i">+
</a><a href="#h50-0-46" id="h50-0-46" class="i">+    private fun &lt;T&gt; safeDatabaseOperation(
</a><a href="#h50-0-47" id="h50-0-47" class="i">+        database: SQLiteDatabase,
</a><a href="#h50-0-48" id="h50-0-48" class="i">+        query: (SQLiteDatabase) -&gt; T?
</a><a href="#h50-0-49" id="h50-0-49" class="i">+    ): T? {
</a><a href="#h50-0-50" id="h50-0-50" class="i">+        synchronized(databaseLock) {
</a><a href="#h50-0-51" id="h50-0-51" class="i">+            return runCatching {
</a><a href="#h50-0-52" id="h50-0-52" class="i">+                query(database)
</a><a href="#h50-0-53" id="h50-0-53" class="i">+            }.onFailure {
</a><a href="#h50-0-54" id="h50-0-54" class="i">+                Logger.xposedLog(&quot;Database operation failed&quot;, it)
</a><a href="#h50-0-55" id="h50-0-55" class="i">+            }.getOrNull()
</a><a href="#h50-0-56" id="h50-0-56" class="i">+        }
</a><a href="#h50-0-57" id="h50-0-57" class="i">+    }
</a><a href="#h50-0-58" id="h50-0-58" class="i">+
</a><a href="#h50-0-59" id="h50-0-59" class="i">+    private fun &lt;T : DatabaseObject&gt; readDatabaseObject(
</a><a href="#h50-0-60" id="h50-0-60" class="i">+        obj: T,
</a><a href="#h50-0-61" id="h50-0-61" class="i">+        database: SQLiteDatabase,
</a><a href="#h50-0-62" id="h50-0-62" class="i">+        table: String,
</a><a href="#h50-0-63" id="h50-0-63" class="i">+        where: String,
</a><a href="#h50-0-64" id="h50-0-64" class="i">+        args: Array&lt;String&gt;
</a><a href="#h50-0-65" id="h50-0-65" class="i">+    ): T? {
</a><a href="#h50-0-66" id="h50-0-66" class="i">+        val cursor = database.rawQuery(&quot;SELECT * FROM $table WHERE $where&quot;, args)
</a><a href="#h50-0-67" id="h50-0-67" class="i">+        if (!cursor.moveToFirst()) {
</a><a href="#h50-0-68" id="h50-0-68" class="i">+            cursor.close()
</a><a href="#h50-0-69" id="h50-0-69" class="i">+            return null
</a><a href="#h50-0-70" id="h50-0-70" class="i">+        }
</a><a href="#h50-0-71" id="h50-0-71" class="i">+        try {
</a><a href="#h50-0-72" id="h50-0-72" class="i">+            obj.write(cursor)
</a><a href="#h50-0-73" id="h50-0-73" class="i">+        } catch (e: Throwable) {
</a><a href="#h50-0-74" id="h50-0-74" class="i">+            context.log.error(&quot;Failed to read database object&quot;, e)
</a><a href="#h50-0-75" id="h50-0-75" class="i">+        }
</a><a href="#h50-0-76" id="h50-0-76" class="i">+        cursor.close()
</a><a href="#h50-0-77" id="h50-0-77" class="i">+        return obj
</a><a href="#h50-0-78" id="h50-0-78" class="i">+    }
</a><a href="#h50-0-79" id="h50-0-79" class="i">+
</a><a href="#h50-0-80" id="h50-0-80" class="i">+    fun getFeedEntryByUserId(userId: String): FriendFeedEntry? {
</a><a href="#h50-0-81" id="h50-0-81" class="i">+        return safeDatabaseOperation(openMain()) { database -&gt;
</a><a href="#h50-0-82" id="h50-0-82" class="i">+            readDatabaseObject(
</a><a href="#h50-0-83" id="h50-0-83" class="i">+                FriendFeedEntry(),
</a><a href="#h50-0-84" id="h50-0-84" class="i">+                database,
</a><a href="#h50-0-85" id="h50-0-85" class="i">+                &quot;FriendsFeedView&quot;,
</a><a href="#h50-0-86" id="h50-0-86" class="i">+                &quot;friendUserId = ?&quot;,
</a><a href="#h50-0-87" id="h50-0-87" class="i">+                arrayOf(userId)
</a><a href="#h50-0-88" id="h50-0-88" class="i">+            )
</a><a href="#h50-0-89" id="h50-0-89" class="i">+        }
</a><a href="#h50-0-90" id="h50-0-90" class="i">+    }
</a><a href="#h50-0-91" id="h50-0-91" class="i">+
</a><a href="#h50-0-92" id="h50-0-92" class="i">+    val myUserId by lazy {
</a><a href="#h50-0-93" id="h50-0-93" class="i">+        safeDatabaseOperation(openArroyo()) { arroyoDatabase: SQLiteDatabase -&gt;
</a><a href="#h50-0-94" id="h50-0-94" class="i">+            val cursor = arroyoDatabase.rawQuery(buildString {
</a><a href="#h50-0-95" id="h50-0-95" class="i">+                append(&quot;SELECT * FROM required_values WHERE key = &#39;USERID&#39;&quot;)
</a><a href="#h50-0-96" id="h50-0-96" class="i">+            }, null)
</a><a href="#h50-0-97" id="h50-0-97" class="i">+
</a><a href="#h50-0-98" id="h50-0-98" class="i">+            if (!cursor.moveToFirst()) {
</a><a href="#h50-0-99" id="h50-0-99" class="i">+                cursor.close()
</a><a href="#h50-0-100" id="h50-0-100" class="i">+                return@safeDatabaseOperation null
</a><a href="#h50-0-101" id="h50-0-101" class="i">+            }
</a><a href="#h50-0-102" id="h50-0-102" class="i">+
</a><a href="#h50-0-103" id="h50-0-103" class="i">+            val userId = cursor.getString(cursor.getColumnIndex(&quot;value&quot;))
</a><a href="#h50-0-104" id="h50-0-104" class="i">+            cursor.close()
</a><a href="#h50-0-105" id="h50-0-105" class="i">+            userId
</a><a href="#h50-0-106" id="h50-0-106" class="i">+        }!!
</a><a href="#h50-0-107" id="h50-0-107" class="i">+    }
</a><a href="#h50-0-108" id="h50-0-108" class="i">+
</a><a href="#h50-0-109" id="h50-0-109" class="i">+    fun getFeedEntryByConversationId(conversationId: String): FriendFeedEntry? {
</a><a href="#h50-0-110" id="h50-0-110" class="i">+        return safeDatabaseOperation(openMain()) {
</a><a href="#h50-0-111" id="h50-0-111" class="i">+            readDatabaseObject(
</a><a href="#h50-0-112" id="h50-0-112" class="i">+                FriendFeedEntry(),
</a><a href="#h50-0-113" id="h50-0-113" class="i">+                it,
</a><a href="#h50-0-114" id="h50-0-114" class="i">+                &quot;FriendsFeedView&quot;,
</a><a href="#h50-0-115" id="h50-0-115" class="i">+                &quot;key = ?&quot;,
</a><a href="#h50-0-116" id="h50-0-116" class="i">+                arrayOf(conversationId)
</a><a href="#h50-0-117" id="h50-0-117" class="i">+            )
</a><a href="#h50-0-118" id="h50-0-118" class="i">+        }
</a><a href="#h50-0-119" id="h50-0-119" class="i">+    }
</a><a href="#h50-0-120" id="h50-0-120" class="i">+
</a><a href="#h50-0-121" id="h50-0-121" class="i">+    fun getFriendInfo(userId: String): FriendInfo? {
</a><a href="#h50-0-122" id="h50-0-122" class="i">+        return safeDatabaseOperation(openMain()) {
</a><a href="#h50-0-123" id="h50-0-123" class="i">+            readDatabaseObject(
</a><a href="#h50-0-124" id="h50-0-124" class="i">+                FriendInfo(),
</a><a href="#h50-0-125" id="h50-0-125" class="i">+                it,
</a><a href="#h50-0-126" id="h50-0-126" class="i">+                &quot;FriendWithUsername&quot;,
</a><a href="#h50-0-127" id="h50-0-127" class="i">+                &quot;userId = ?&quot;,
</a><a href="#h50-0-128" id="h50-0-128" class="i">+                arrayOf(userId)
</a><a href="#h50-0-129" id="h50-0-129" class="i">+            )
</a><a href="#h50-0-130" id="h50-0-130" class="i">+        }
</a><a href="#h50-0-131" id="h50-0-131" class="i">+    }
</a><a href="#h50-0-132" id="h50-0-132" class="i">+
</a><a href="#h50-0-133" id="h50-0-133" class="i">+    fun getFeedEntries(limit: Int): List&lt;FriendFeedEntry&gt; {
</a><a href="#h50-0-134" id="h50-0-134" class="i">+        return safeDatabaseOperation(openMain()) { database -&gt;
</a><a href="#h50-0-135" id="h50-0-135" class="i">+            val cursor = database.rawQuery(
</a><a href="#h50-0-136" id="h50-0-136" class="i">+                &quot;SELECT * FROM FriendsFeedView ORDER BY _id LIMIT ?&quot;,
</a><a href="#h50-0-137" id="h50-0-137" class="i">+                arrayOf(limit.toString())
</a><a href="#h50-0-138" id="h50-0-138" class="i">+            )
</a><a href="#h50-0-139" id="h50-0-139" class="i">+            val list = mutableListOf&lt;FriendFeedEntry&gt;()
</a><a href="#h50-0-140" id="h50-0-140" class="i">+            while (cursor.moveToNext()) {
</a><a href="#h50-0-141" id="h50-0-141" class="i">+                val friendFeedEntry = FriendFeedEntry()
</a><a href="#h50-0-142" id="h50-0-142" class="i">+                try {
</a><a href="#h50-0-143" id="h50-0-143" class="i">+                    friendFeedEntry.write(cursor)
</a><a href="#h50-0-144" id="h50-0-144" class="i">+                } catch (_: Throwable) {}
</a><a href="#h50-0-145" id="h50-0-145" class="i">+                list.add(friendFeedEntry)
</a><a href="#h50-0-146" id="h50-0-146" class="i">+            }
</a><a href="#h50-0-147" id="h50-0-147" class="i">+            cursor.close()
</a><a href="#h50-0-148" id="h50-0-148" class="i">+            list
</a><a href="#h50-0-149" id="h50-0-149" class="i">+        } ?: emptyList()
</a><a href="#h50-0-150" id="h50-0-150" class="i">+    }
</a><a href="#h50-0-151" id="h50-0-151" class="i">+
</a><a href="#h50-0-152" id="h50-0-152" class="i">+    fun getConversationMessageFromId(clientMessageId: Long): ConversationMessage? {
</a><a href="#h50-0-153" id="h50-0-153" class="i">+        return safeDatabaseOperation(openArroyo()) {
</a><a href="#h50-0-154" id="h50-0-154" class="i">+            readDatabaseObject(
</a><a href="#h50-0-155" id="h50-0-155" class="i">+                ConversationMessage(),
</a><a href="#h50-0-156" id="h50-0-156" class="i">+                it,
</a><a href="#h50-0-157" id="h50-0-157" class="i">+                &quot;conversation_message&quot;,
</a><a href="#h50-0-158" id="h50-0-158" class="i">+                &quot;client_message_id = ?&quot;,
</a><a href="#h50-0-159" id="h50-0-159" class="i">+                arrayOf(clientMessageId.toString())
</a><a href="#h50-0-160" id="h50-0-160" class="i">+            )
</a><a href="#h50-0-161" id="h50-0-161" class="i">+        }
</a><a href="#h50-0-162" id="h50-0-162" class="i">+    }
</a><a href="#h50-0-163" id="h50-0-163" class="i">+
</a><a href="#h50-0-164" id="h50-0-164" class="i">+    fun getConversationType(conversationId: String): Int? {
</a><a href="#h50-0-165" id="h50-0-165" class="i">+        return safeDatabaseOperation(openArroyo()) {
</a><a href="#h50-0-166" id="h50-0-166" class="i">+            val cursor = it.rawQuery(
</a><a href="#h50-0-167" id="h50-0-167" class="i">+                &quot;SELECT * FROM user_conversation WHERE client_conversation_id = ?&quot;,
</a><a href="#h50-0-168" id="h50-0-168" class="i">+                arrayOf(conversationId)
</a><a href="#h50-0-169" id="h50-0-169" class="i">+            )
</a><a href="#h50-0-170" id="h50-0-170" class="i">+            if (!cursor.moveToFirst()) {
</a><a href="#h50-0-171" id="h50-0-171" class="i">+                cursor.close()
</a><a href="#h50-0-172" id="h50-0-172" class="i">+                return@safeDatabaseOperation null
</a><a href="#h50-0-173" id="h50-0-173" class="i">+            }
</a><a href="#h50-0-174" id="h50-0-174" class="i">+            val type = cursor.getInt(cursor.getColumnIndex(&quot;conversation_type&quot;))
</a><a href="#h50-0-175" id="h50-0-175" class="i">+            cursor.close()
</a><a href="#h50-0-176" id="h50-0-176" class="i">+            type
</a><a href="#h50-0-177" id="h50-0-177" class="i">+        }
</a><a href="#h50-0-178" id="h50-0-178" class="i">+    }
</a><a href="#h50-0-179" id="h50-0-179" class="i">+
</a><a href="#h50-0-180" id="h50-0-180" class="i">+    fun getConversationLinkFromUserId(userId: String): UserConversationLink? {
</a><a href="#h50-0-181" id="h50-0-181" class="i">+        return safeDatabaseOperation(openArroyo()) {
</a><a href="#h50-0-182" id="h50-0-182" class="i">+            readDatabaseObject(
</a><a href="#h50-0-183" id="h50-0-183" class="i">+                UserConversationLink(),
</a><a href="#h50-0-184" id="h50-0-184" class="i">+                it,
</a><a href="#h50-0-185" id="h50-0-185" class="i">+                &quot;user_conversation&quot;,
</a><a href="#h50-0-186" id="h50-0-186" class="i">+                &quot;user_id = ? AND conversation_type = 0&quot;,
</a><a href="#h50-0-187" id="h50-0-187" class="i">+                arrayOf(userId)
</a><a href="#h50-0-188" id="h50-0-188" class="i">+            )
</a><a href="#h50-0-189" id="h50-0-189" class="i">+        }
</a><a href="#h50-0-190" id="h50-0-190" class="i">+    }
</a><a href="#h50-0-191" id="h50-0-191" class="i">+
</a><a href="#h50-0-192" id="h50-0-192" class="i">+    fun getDMOtherParticipant(conversationId: String): String? {
</a><a href="#h50-0-193" id="h50-0-193" class="i">+        return safeDatabaseOperation(openArroyo()) { cursor -&gt;
</a><a href="#h50-0-194" id="h50-0-194" class="i">+            val query = cursor.rawQuery(
</a><a href="#h50-0-195" id="h50-0-195" class="i">+                &quot;SELECT * FROM user_conversation WHERE client_conversation_id = ? AND conversation_type = 0&quot;,
</a><a href="#h50-0-196" id="h50-0-196" class="i">+                arrayOf(conversationId)
</a><a href="#h50-0-197" id="h50-0-197" class="i">+            )
</a><a href="#h50-0-198" id="h50-0-198" class="i">+            val participants = mutableListOf&lt;String&gt;()
</a><a href="#h50-0-199" id="h50-0-199" class="i">+            while (query.moveToNext()) {
</a><a href="#h50-0-200" id="h50-0-200" class="i">+                participants.add(query.getString(query.getColumnIndex(&quot;user_id&quot;)))
</a><a href="#h50-0-201" id="h50-0-201" class="i">+            }
</a><a href="#h50-0-202" id="h50-0-202" class="i">+            query.close()
</a><a href="#h50-0-203" id="h50-0-203" class="i">+            participants.firstOrNull { it != myUserId }
</a><a href="#h50-0-204" id="h50-0-204" class="i">+        }
</a><a href="#h50-0-205" id="h50-0-205" class="i">+    }
</a><a href="#h50-0-206" id="h50-0-206" class="i">+
</a><a href="#h50-0-207" id="h50-0-207" class="i">+
</a><a href="#h50-0-208" id="h50-0-208" class="i">+    fun getStoryEntryFromId(storyId: String): StoryEntry? {
</a><a href="#h50-0-209" id="h50-0-209" class="i">+        return safeDatabaseOperation(openMain()) {
</a><a href="#h50-0-210" id="h50-0-210" class="i">+            readDatabaseObject(StoryEntry(), it, &quot;Story&quot;, &quot;storyId = ?&quot;, arrayOf(storyId))
</a><a href="#h50-0-211" id="h50-0-211" class="i">+        }
</a><a href="#h50-0-212" id="h50-0-212" class="i">+    }
</a><a href="#h50-0-213" id="h50-0-213" class="i">+
</a><a href="#h50-0-214" id="h50-0-214" class="i">+    fun getConversationParticipants(conversationId: String): List&lt;String&gt;? {
</a><a href="#h50-0-215" id="h50-0-215" class="i">+        return safeDatabaseOperation(openArroyo()) { arroyoDatabase: SQLiteDatabase -&gt;
</a><a href="#h50-0-216" id="h50-0-216" class="i">+            val cursor = arroyoDatabase.rawQuery(
</a><a href="#h50-0-217" id="h50-0-217" class="i">+                &quot;SELECT * FROM user_conversation WHERE client_conversation_id = ?&quot;,
</a><a href="#h50-0-218" id="h50-0-218" class="i">+                arrayOf(conversationId)
</a><a href="#h50-0-219" id="h50-0-219" class="i">+            )
</a><a href="#h50-0-220" id="h50-0-220" class="i">+            if (!cursor.moveToFirst()) {
</a><a href="#h50-0-221" id="h50-0-221" class="i">+                cursor.close()
</a><a href="#h50-0-222" id="h50-0-222" class="i">+                return@safeDatabaseOperation emptyList()
</a><a href="#h50-0-223" id="h50-0-223" class="i">+            }
</a><a href="#h50-0-224" id="h50-0-224" class="i">+            val participants = mutableListOf&lt;String&gt;()
</a><a href="#h50-0-225" id="h50-0-225" class="i">+            do {
</a><a href="#h50-0-226" id="h50-0-226" class="i">+                participants.add(cursor.getString(cursor.getColumnIndex(&quot;user_id&quot;)))
</a><a href="#h50-0-227" id="h50-0-227" class="i">+            } while (cursor.moveToNext())
</a><a href="#h50-0-228" id="h50-0-228" class="i">+            cursor.close()
</a><a href="#h50-0-229" id="h50-0-229" class="i">+            participants
</a><a href="#h50-0-230" id="h50-0-230" class="i">+        }
</a><a href="#h50-0-231" id="h50-0-231" class="i">+    }
</a><a href="#h50-0-232" id="h50-0-232" class="i">+
</a><a href="#h50-0-233" id="h50-0-233" class="i">+    fun getMessagesFromConversationId(
</a><a href="#h50-0-234" id="h50-0-234" class="i">+        conversationId: String,
</a><a href="#h50-0-235" id="h50-0-235" class="i">+        limit: Int
</a><a href="#h50-0-236" id="h50-0-236" class="i">+    ): List&lt;ConversationMessage&gt;? {
</a><a href="#h50-0-237" id="h50-0-237" class="i">+        return safeDatabaseOperation(openArroyo()) { arroyoDatabase: SQLiteDatabase -&gt;
</a><a href="#h50-0-238" id="h50-0-238" class="i">+            val cursor = arroyoDatabase.rawQuery(
</a><a href="#h50-0-239" id="h50-0-239" class="i">+                &quot;SELECT * FROM conversation_message WHERE client_conversation_id = ? ORDER BY creation_timestamp DESC LIMIT ?&quot;,
</a><a href="#h50-0-240" id="h50-0-240" class="i">+                arrayOf(conversationId, limit.toString())
</a><a href="#h50-0-241" id="h50-0-241" class="i">+            )
</a><a href="#h50-0-242" id="h50-0-242" class="i">+            if (!cursor.moveToFirst()) {
</a><a href="#h50-0-243" id="h50-0-243" class="i">+                cursor.close()
</a><a href="#h50-0-244" id="h50-0-244" class="i">+                return@safeDatabaseOperation emptyList()
</a><a href="#h50-0-245" id="h50-0-245" class="i">+            }
</a><a href="#h50-0-246" id="h50-0-246" class="i">+            val messages = mutableListOf&lt;ConversationMessage&gt;()
</a><a href="#h50-0-247" id="h50-0-247" class="i">+            do {
</a><a href="#h50-0-248" id="h50-0-248" class="i">+                val message = ConversationMessage()
</a><a href="#h50-0-249" id="h50-0-249" class="i">+                message.write(cursor)
</a><a href="#h50-0-250" id="h50-0-250" class="i">+                messages.add(message)
</a><a href="#h50-0-251" id="h50-0-251" class="i">+            } while (cursor.moveToNext())
</a><a href="#h50-0-252" id="h50-0-252" class="i">+            cursor.close()
</a><a href="#h50-0-253" id="h50-0-253" class="i">+            messages
</a><a href="#h50-0-254" id="h50-0-254" class="i">+        }
</a><a href="#h50-0-255" id="h50-0-255" class="i">+    }
</a><a href="#h50-0-256" id="h50-0-256" class="i">+}</a><a href="#h50-0-257" id="h50-0-257" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h51" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/database/DatabaseObject.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/database/DatabaseObject.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/database/DatabaseObject.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/database/DatabaseObject.kt</a></b>
<a href="#h51-0" id="h51-0" class="h">@@ -0,0 +1,7 @@
</a><a href="#h51-0-0" id="h51-0-0" class="i">+package me.rhunk.snapenhance.core.database
</a><a href="#h51-0-1" id="h51-0-1" class="i">+
</a><a href="#h51-0-2" id="h51-0-2" class="i">+import android.database.Cursor
</a><a href="#h51-0-3" id="h51-0-3" class="i">+
</a><a href="#h51-0-4" id="h51-0-4" class="i">+interface DatabaseObject {
</a><a href="#h51-0-5" id="h51-0-5" class="i">+    fun write(cursor: Cursor)
</a><a href="#h51-0-6" id="h51-0-6" class="i">+}
</a><b>diff --git a/<a id="h52" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/database/objects/ConversationMessage.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/database/objects/ConversationMessage.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/database/objects/ConversationMessage.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/database/objects/ConversationMessage.kt</a></b>
<a href="#h52-0" id="h52-0" class="h">@@ -0,0 +1,50 @@
</a><a href="#h52-0-0" id="h52-0-0" class="i">+package me.rhunk.snapenhance.core.database.objects
</a><a href="#h52-0-1" id="h52-0-1" class="i">+
</a><a href="#h52-0-2" id="h52-0-2" class="i">+import android.annotation.SuppressLint
</a><a href="#h52-0-3" id="h52-0-3" class="i">+import android.database.Cursor
</a><a href="#h52-0-4" id="h52-0-4" class="i">+import me.rhunk.snapenhance.Constants
</a><a href="#h52-0-5" id="h52-0-5" class="i">+import me.rhunk.snapenhance.core.database.DatabaseObject
</a><a href="#h52-0-6" id="h52-0-6" class="i">+import me.rhunk.snapenhance.data.ContentType
</a><a href="#h52-0-7" id="h52-0-7" class="i">+import me.rhunk.snapenhance.util.ktx.getBlobOrNull
</a><a href="#h52-0-8" id="h52-0-8" class="i">+import me.rhunk.snapenhance.util.ktx.getInteger
</a><a href="#h52-0-9" id="h52-0-9" class="i">+import me.rhunk.snapenhance.util.ktx.getLong
</a><a href="#h52-0-10" id="h52-0-10" class="i">+import me.rhunk.snapenhance.util.ktx.getStringOrNull
</a><a href="#h52-0-11" id="h52-0-11" class="i">+import me.rhunk.snapenhance.util.protobuf.ProtoReader
</a><a href="#h52-0-12" id="h52-0-12" class="i">+
</a><a href="#h52-0-13" id="h52-0-13" class="i">+@Suppress(&quot;ArrayInDataClass&quot;)
</a><a href="#h52-0-14" id="h52-0-14" class="i">+data class ConversationMessage(
</a><a href="#h52-0-15" id="h52-0-15" class="i">+    var clientConversationId: String? = null,
</a><a href="#h52-0-16" id="h52-0-16" class="i">+    var clientMessageId: Int = 0,
</a><a href="#h52-0-17" id="h52-0-17" class="i">+    var serverMessageId: Int = 0,
</a><a href="#h52-0-18" id="h52-0-18" class="i">+    var messageContent: ByteArray? = null,
</a><a href="#h52-0-19" id="h52-0-19" class="i">+    var isSaved: Int = 0,
</a><a href="#h52-0-20" id="h52-0-20" class="i">+    var isViewedByUser: Int = 0,
</a><a href="#h52-0-21" id="h52-0-21" class="i">+    var contentType: Int = 0,
</a><a href="#h52-0-22" id="h52-0-22" class="i">+    var creationTimestamp: Long = 0,
</a><a href="#h52-0-23" id="h52-0-23" class="i">+    var readTimestamp: Long = 0,
</a><a href="#h52-0-24" id="h52-0-24" class="i">+    var senderId: String? = null
</a><a href="#h52-0-25" id="h52-0-25" class="i">+) : DatabaseObject {
</a><a href="#h52-0-26" id="h52-0-26" class="i">+
</a><a href="#h52-0-27" id="h52-0-27" class="i">+    @SuppressLint(&quot;Range&quot;)
</a><a href="#h52-0-28" id="h52-0-28" class="i">+    override fun write(cursor: Cursor) {
</a><a href="#h52-0-29" id="h52-0-29" class="i">+        with(cursor) {
</a><a href="#h52-0-30" id="h52-0-30" class="i">+            clientConversationId = getStringOrNull(&quot;client_conversation_id&quot;)
</a><a href="#h52-0-31" id="h52-0-31" class="i">+            clientMessageId = getInteger(&quot;client_message_id&quot;)
</a><a href="#h52-0-32" id="h52-0-32" class="i">+            serverMessageId = getInteger(&quot;server_message_id&quot;)
</a><a href="#h52-0-33" id="h52-0-33" class="i">+            messageContent = getBlobOrNull(&quot;message_content&quot;)
</a><a href="#h52-0-34" id="h52-0-34" class="i">+            isSaved = getInteger(&quot;is_saved&quot;)
</a><a href="#h52-0-35" id="h52-0-35" class="i">+            isViewedByUser = getInteger(&quot;is_viewed_by_user&quot;)
</a><a href="#h52-0-36" id="h52-0-36" class="i">+            contentType = getInteger(&quot;content_type&quot;)
</a><a href="#h52-0-37" id="h52-0-37" class="i">+            creationTimestamp = getLong(&quot;creation_timestamp&quot;)
</a><a href="#h52-0-38" id="h52-0-38" class="i">+            readTimestamp = getLong(&quot;read_timestamp&quot;)
</a><a href="#h52-0-39" id="h52-0-39" class="i">+            senderId = getStringOrNull(&quot;sender_id&quot;)
</a><a href="#h52-0-40" id="h52-0-40" class="i">+        }
</a><a href="#h52-0-41" id="h52-0-41" class="i">+    }
</a><a href="#h52-0-42" id="h52-0-42" class="i">+
</a><a href="#h52-0-43" id="h52-0-43" class="i">+    fun getMessageAsString(): String? {
</a><a href="#h52-0-44" id="h52-0-44" class="i">+        return when (ContentType.fromId(contentType)) {
</a><a href="#h52-0-45" id="h52-0-45" class="i">+            ContentType.CHAT -&gt; messageContent?.let { ProtoReader(it).getString(*Constants.ARROYO_STRING_CHAT_MESSAGE_PROTO) }
</a><a href="#h52-0-46" id="h52-0-46" class="i">+            else -&gt; null
</a><a href="#h52-0-47" id="h52-0-47" class="i">+        }
</a><a href="#h52-0-48" id="h52-0-48" class="i">+    }
</a><a href="#h52-0-49" id="h52-0-49" class="i">+}
</a><b>diff --git a/<a id="h53" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/database/objects/FriendFeedEntry.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/database/objects/FriendFeedEntry.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/database/objects/FriendFeedEntry.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/database/objects/FriendFeedEntry.kt</a></b>
<a href="#h53-0" id="h53-0" class="h">@@ -0,0 +1,47 @@
</a><a href="#h53-0-0" id="h53-0-0" class="i">+package me.rhunk.snapenhance.core.database.objects
</a><a href="#h53-0-1" id="h53-0-1" class="i">+
</a><a href="#h53-0-2" id="h53-0-2" class="i">+import android.annotation.SuppressLint
</a><a href="#h53-0-3" id="h53-0-3" class="i">+import android.database.Cursor
</a><a href="#h53-0-4" id="h53-0-4" class="i">+import me.rhunk.snapenhance.core.database.DatabaseObject
</a><a href="#h53-0-5" id="h53-0-5" class="i">+import me.rhunk.snapenhance.util.ktx.getIntOrNull
</a><a href="#h53-0-6" id="h53-0-6" class="i">+import me.rhunk.snapenhance.util.ktx.getInteger
</a><a href="#h53-0-7" id="h53-0-7" class="i">+import me.rhunk.snapenhance.util.ktx.getLong
</a><a href="#h53-0-8" id="h53-0-8" class="i">+import me.rhunk.snapenhance.util.ktx.getStringOrNull
</a><a href="#h53-0-9" id="h53-0-9" class="i">+
</a><a href="#h53-0-10" id="h53-0-10" class="i">+data class FriendFeedEntry(
</a><a href="#h53-0-11" id="h53-0-11" class="i">+    var id: Int = 0,
</a><a href="#h53-0-12" id="h53-0-12" class="i">+    var feedDisplayName: String? = null,
</a><a href="#h53-0-13" id="h53-0-13" class="i">+    var participantsSize: Int = 0,
</a><a href="#h53-0-14" id="h53-0-14" class="i">+    var lastInteractionTimestamp: Long = 0,
</a><a href="#h53-0-15" id="h53-0-15" class="i">+    var displayTimestamp: Long = 0,
</a><a href="#h53-0-16" id="h53-0-16" class="i">+    var displayInteractionType: String? = null,
</a><a href="#h53-0-17" id="h53-0-17" class="i">+    var lastInteractionUserId: Int? = null,
</a><a href="#h53-0-18" id="h53-0-18" class="i">+    var key: String? = null,
</a><a href="#h53-0-19" id="h53-0-19" class="i">+    var friendUserId: String? = null,
</a><a href="#h53-0-20" id="h53-0-20" class="i">+    var friendDisplayName: String? = null,
</a><a href="#h53-0-21" id="h53-0-21" class="i">+    var friendDisplayUsername: String? = null,
</a><a href="#h53-0-22" id="h53-0-22" class="i">+    var friendLinkType: Int? = null,
</a><a href="#h53-0-23" id="h53-0-23" class="i">+    var bitmojiAvatarId: String? = null,
</a><a href="#h53-0-24" id="h53-0-24" class="i">+    var bitmojiSelfieId: String? = null,
</a><a href="#h53-0-25" id="h53-0-25" class="i">+) : DatabaseObject {
</a><a href="#h53-0-26" id="h53-0-26" class="i">+
</a><a href="#h53-0-27" id="h53-0-27" class="i">+    @SuppressLint(&quot;Range&quot;)
</a><a href="#h53-0-28" id="h53-0-28" class="i">+    override fun write(cursor: Cursor) {
</a><a href="#h53-0-29" id="h53-0-29" class="i">+        with(cursor) {
</a><a href="#h53-0-30" id="h53-0-30" class="i">+            id = getInteger(&quot;_id&quot;)
</a><a href="#h53-0-31" id="h53-0-31" class="i">+            feedDisplayName = getStringOrNull(&quot;feedDisplayName&quot;)
</a><a href="#h53-0-32" id="h53-0-32" class="i">+            participantsSize = getInteger(&quot;participantsSize&quot;)
</a><a href="#h53-0-33" id="h53-0-33" class="i">+            lastInteractionTimestamp = getLong(&quot;lastInteractionTimestamp&quot;)
</a><a href="#h53-0-34" id="h53-0-34" class="i">+            displayTimestamp = getLong(&quot;displayTimestamp&quot;)
</a><a href="#h53-0-35" id="h53-0-35" class="i">+            displayInteractionType = getStringOrNull(&quot;displayInteractionType&quot;)
</a><a href="#h53-0-36" id="h53-0-36" class="i">+            lastInteractionUserId = getIntOrNull(&quot;lastInteractionUserId&quot;)
</a><a href="#h53-0-37" id="h53-0-37" class="i">+            key = getStringOrNull(&quot;key&quot;)
</a><a href="#h53-0-38" id="h53-0-38" class="i">+            friendUserId = getStringOrNull(&quot;friendUserId&quot;)
</a><a href="#h53-0-39" id="h53-0-39" class="i">+            friendDisplayName = getStringOrNull(&quot;friendDisplayName&quot;)
</a><a href="#h53-0-40" id="h53-0-40" class="i">+            friendDisplayUsername = getStringOrNull(&quot;friendDisplayUsername&quot;)
</a><a href="#h53-0-41" id="h53-0-41" class="i">+            friendLinkType = getIntOrNull(&quot;friendLinkType&quot;)
</a><a href="#h53-0-42" id="h53-0-42" class="i">+            bitmojiAvatarId = getStringOrNull(&quot;bitmojiAvatarId&quot;)
</a><a href="#h53-0-43" id="h53-0-43" class="i">+            bitmojiSelfieId = getStringOrNull(&quot;bitmojiSelfieId&quot;)
</a><a href="#h53-0-44" id="h53-0-44" class="i">+        }
</a><a href="#h53-0-45" id="h53-0-45" class="i">+    }
</a><a href="#h53-0-46" id="h53-0-46" class="i">+}
</a><b>diff --git a/<a id="h54" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/database/objects/FriendInfo.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/database/objects/FriendInfo.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/database/objects/FriendInfo.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/database/objects/FriendInfo.kt</a></b>
<a href="#h54-0" id="h54-0" class="h">@@ -0,0 +1,64 @@
</a><a href="#h54-0-0" id="h54-0-0" class="i">+package me.rhunk.snapenhance.core.database.objects
</a><a href="#h54-0-1" id="h54-0-1" class="i">+
</a><a href="#h54-0-2" id="h54-0-2" class="i">+import android.annotation.SuppressLint
</a><a href="#h54-0-3" id="h54-0-3" class="i">+import android.database.Cursor
</a><a href="#h54-0-4" id="h54-0-4" class="i">+import me.rhunk.snapenhance.core.database.DatabaseObject
</a><a href="#h54-0-5" id="h54-0-5" class="i">+import me.rhunk.snapenhance.util.SerializableDataObject
</a><a href="#h54-0-6" id="h54-0-6" class="i">+import me.rhunk.snapenhance.util.ktx.getInteger
</a><a href="#h54-0-7" id="h54-0-7" class="i">+import me.rhunk.snapenhance.util.ktx.getLong
</a><a href="#h54-0-8" id="h54-0-8" class="i">+import me.rhunk.snapenhance.util.ktx.getStringOrNull
</a><a href="#h54-0-9" id="h54-0-9" class="i">+
</a><a href="#h54-0-10" id="h54-0-10" class="i">+data class FriendInfo(
</a><a href="#h54-0-11" id="h54-0-11" class="i">+    var id: Int = 0,
</a><a href="#h54-0-12" id="h54-0-12" class="i">+    var lastModifiedTimestamp: Long = 0,
</a><a href="#h54-0-13" id="h54-0-13" class="i">+    var username: String? = null,
</a><a href="#h54-0-14" id="h54-0-14" class="i">+    var userId: String? = null,
</a><a href="#h54-0-15" id="h54-0-15" class="i">+    var displayName: String? = null,
</a><a href="#h54-0-16" id="h54-0-16" class="i">+    var bitmojiAvatarId: String? = null,
</a><a href="#h54-0-17" id="h54-0-17" class="i">+    var bitmojiSelfieId: String? = null,
</a><a href="#h54-0-18" id="h54-0-18" class="i">+    var bitmojiSceneId: String? = null,
</a><a href="#h54-0-19" id="h54-0-19" class="i">+    var bitmojiBackgroundId: String? = null,
</a><a href="#h54-0-20" id="h54-0-20" class="i">+    var friendmojis: String? = null,
</a><a href="#h54-0-21" id="h54-0-21" class="i">+    var friendmojiCategories: String? = null,
</a><a href="#h54-0-22" id="h54-0-22" class="i">+    var snapScore: Int = 0,
</a><a href="#h54-0-23" id="h54-0-23" class="i">+    var birthday: Long = 0,
</a><a href="#h54-0-24" id="h54-0-24" class="i">+    var addedTimestamp: Long = 0,
</a><a href="#h54-0-25" id="h54-0-25" class="i">+    var reverseAddedTimestamp: Long = 0,
</a><a href="#h54-0-26" id="h54-0-26" class="i">+    var serverDisplayName: String? = null,
</a><a href="#h54-0-27" id="h54-0-27" class="i">+    var streakLength: Int = 0,
</a><a href="#h54-0-28" id="h54-0-28" class="i">+    var streakExpirationTimestamp: Long = 0,
</a><a href="#h54-0-29" id="h54-0-29" class="i">+    var reverseBestFriendRanking: Int = 0,
</a><a href="#h54-0-30" id="h54-0-30" class="i">+    var isPinnedBestFriend: Int = 0,
</a><a href="#h54-0-31" id="h54-0-31" class="i">+    var plusBadgeVisibility: Int = 0,
</a><a href="#h54-0-32" id="h54-0-32" class="i">+    var usernameForSorting: String? = null
</a><a href="#h54-0-33" id="h54-0-33" class="i">+) : DatabaseObject, SerializableDataObject() {
</a><a href="#h54-0-34" id="h54-0-34" class="i">+    @SuppressLint(&quot;Range&quot;)
</a><a href="#h54-0-35" id="h54-0-35" class="i">+    override fun write(cursor: Cursor) {
</a><a href="#h54-0-36" id="h54-0-36" class="i">+        with(cursor) {
</a><a href="#h54-0-37" id="h54-0-37" class="i">+            id = getInteger(&quot;_id&quot;)
</a><a href="#h54-0-38" id="h54-0-38" class="i">+            lastModifiedTimestamp = getLong(&quot;_lastModifiedTimestamp&quot;)
</a><a href="#h54-0-39" id="h54-0-39" class="i">+            username = getStringOrNull(&quot;username&quot;)
</a><a href="#h54-0-40" id="h54-0-40" class="i">+            userId = getStringOrNull(&quot;userId&quot;)
</a><a href="#h54-0-41" id="h54-0-41" class="i">+            displayName = getStringOrNull(&quot;displayName&quot;)
</a><a href="#h54-0-42" id="h54-0-42" class="i">+            bitmojiAvatarId = getStringOrNull(&quot;bitmojiAvatarId&quot;)
</a><a href="#h54-0-43" id="h54-0-43" class="i">+            bitmojiSelfieId = getStringOrNull(&quot;bitmojiSelfieId&quot;)
</a><a href="#h54-0-44" id="h54-0-44" class="i">+            bitmojiSceneId = getStringOrNull(&quot;bitmojiSceneId&quot;)
</a><a href="#h54-0-45" id="h54-0-45" class="i">+            bitmojiBackgroundId = getStringOrNull(&quot;bitmojiBackgroundId&quot;)
</a><a href="#h54-0-46" id="h54-0-46" class="i">+            friendmojis = getStringOrNull(&quot;friendmojis&quot;)
</a><a href="#h54-0-47" id="h54-0-47" class="i">+            friendmojiCategories = getStringOrNull(&quot;friendmojiCategories&quot;)
</a><a href="#h54-0-48" id="h54-0-48" class="i">+            snapScore = getInteger(&quot;score&quot;)
</a><a href="#h54-0-49" id="h54-0-49" class="i">+            birthday = getLong(&quot;birthday&quot;)
</a><a href="#h54-0-50" id="h54-0-50" class="i">+            addedTimestamp = getLong(&quot;addedTimestamp&quot;)
</a><a href="#h54-0-51" id="h54-0-51" class="i">+            reverseAddedTimestamp = getLong(&quot;reverseAddedTimestamp&quot;)
</a><a href="#h54-0-52" id="h54-0-52" class="i">+            serverDisplayName = getStringOrNull(&quot;serverDisplayName&quot;)
</a><a href="#h54-0-53" id="h54-0-53" class="i">+            streakLength = getInteger(&quot;streakLength&quot;)
</a><a href="#h54-0-54" id="h54-0-54" class="i">+            streakExpirationTimestamp = getLong(&quot;streakExpiration&quot;)
</a><a href="#h54-0-55" id="h54-0-55" class="i">+            reverseBestFriendRanking = getInteger(&quot;reverseBestFriendRanking&quot;)
</a><a href="#h54-0-56" id="h54-0-56" class="i">+            usernameForSorting = getStringOrNull(&quot;usernameForSorting&quot;)
</a><a href="#h54-0-57" id="h54-0-57" class="i">+            if (getColumnIndex(&quot;isPinnedBestFriend&quot;) != -1) isPinnedBestFriend =
</a><a href="#h54-0-58" id="h54-0-58" class="i">+                getInteger(&quot;isPinnedBestFriend&quot;)
</a><a href="#h54-0-59" id="h54-0-59" class="i">+            if (getColumnIndex(&quot;plusBadgeVisibility&quot;) != -1) plusBadgeVisibility =
</a><a href="#h54-0-60" id="h54-0-60" class="i">+                getInteger(&quot;plusBadgeVisibility&quot;)
</a><a href="#h54-0-61" id="h54-0-61" class="i">+        }
</a><a href="#h54-0-62" id="h54-0-62" class="i">+    }
</a><a href="#h54-0-63" id="h54-0-63" class="i">+}
</a><b>diff --git a/<a id="h55" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/database/objects/StoryEntry.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/database/objects/StoryEntry.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/database/objects/StoryEntry.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/database/objects/StoryEntry.kt</a></b>
<a href="#h55-0" id="h55-0" class="h">@@ -0,0 +1,27 @@
</a><a href="#h55-0-0" id="h55-0-0" class="i">+package me.rhunk.snapenhance.core.database.objects
</a><a href="#h55-0-1" id="h55-0-1" class="i">+
</a><a href="#h55-0-2" id="h55-0-2" class="i">+import android.annotation.SuppressLint
</a><a href="#h55-0-3" id="h55-0-3" class="i">+import android.database.Cursor
</a><a href="#h55-0-4" id="h55-0-4" class="i">+import me.rhunk.snapenhance.core.database.DatabaseObject
</a><a href="#h55-0-5" id="h55-0-5" class="i">+import me.rhunk.snapenhance.util.ktx.getInteger
</a><a href="#h55-0-6" id="h55-0-6" class="i">+import me.rhunk.snapenhance.util.ktx.getStringOrNull
</a><a href="#h55-0-7" id="h55-0-7" class="i">+
</a><a href="#h55-0-8" id="h55-0-8" class="i">+data class StoryEntry(
</a><a href="#h55-0-9" id="h55-0-9" class="i">+    var id: Int = 0,
</a><a href="#h55-0-10" id="h55-0-10" class="i">+    var storyId: String? = null,
</a><a href="#h55-0-11" id="h55-0-11" class="i">+    var displayName: String? = null,
</a><a href="#h55-0-12" id="h55-0-12" class="i">+    var isLocal: Boolean? = null,
</a><a href="#h55-0-13" id="h55-0-13" class="i">+    var userId: String? = null
</a><a href="#h55-0-14" id="h55-0-14" class="i">+) : DatabaseObject {
</a><a href="#h55-0-15" id="h55-0-15" class="i">+
</a><a href="#h55-0-16" id="h55-0-16" class="i">+    @SuppressLint(&quot;Range&quot;)
</a><a href="#h55-0-17" id="h55-0-17" class="i">+    override fun write(cursor: Cursor) {
</a><a href="#h55-0-18" id="h55-0-18" class="i">+        with(cursor) {
</a><a href="#h55-0-19" id="h55-0-19" class="i">+            id = getInteger(&quot;_id&quot;)
</a><a href="#h55-0-20" id="h55-0-20" class="i">+            storyId = getStringOrNull(&quot;storyId&quot;)
</a><a href="#h55-0-21" id="h55-0-21" class="i">+            displayName = getStringOrNull(&quot;displayName&quot;)
</a><a href="#h55-0-22" id="h55-0-22" class="i">+            isLocal = getInteger(&quot;isLocal&quot;) == 1
</a><a href="#h55-0-23" id="h55-0-23" class="i">+            userId = getStringOrNull(&quot;userId&quot;)
</a><a href="#h55-0-24" id="h55-0-24" class="i">+        }
</a><a href="#h55-0-25" id="h55-0-25" class="i">+    }
</a><a href="#h55-0-26" id="h55-0-26" class="i">+}
</a><b>diff --git a/<a id="h56" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/database/objects/UserConversationLink.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/database/objects/UserConversationLink.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/database/objects/UserConversationLink.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/database/objects/UserConversationLink.kt</a></b>
<a href="#h56-0" id="h56-0" class="h">@@ -0,0 +1,23 @@
</a><a href="#h56-0-0" id="h56-0-0" class="i">+package me.rhunk.snapenhance.core.database.objects
</a><a href="#h56-0-1" id="h56-0-1" class="i">+
</a><a href="#h56-0-2" id="h56-0-2" class="i">+import android.annotation.SuppressLint
</a><a href="#h56-0-3" id="h56-0-3" class="i">+import android.database.Cursor
</a><a href="#h56-0-4" id="h56-0-4" class="i">+import me.rhunk.snapenhance.core.database.DatabaseObject
</a><a href="#h56-0-5" id="h56-0-5" class="i">+import me.rhunk.snapenhance.util.ktx.getInteger
</a><a href="#h56-0-6" id="h56-0-6" class="i">+import me.rhunk.snapenhance.util.ktx.getStringOrNull
</a><a href="#h56-0-7" id="h56-0-7" class="i">+
</a><a href="#h56-0-8" id="h56-0-8" class="i">+class UserConversationLink(
</a><a href="#h56-0-9" id="h56-0-9" class="i">+    var userId: String? = null,
</a><a href="#h56-0-10" id="h56-0-10" class="i">+    var clientConversationId: String? = null,
</a><a href="#h56-0-11" id="h56-0-11" class="i">+    var conversationType: Int = 0
</a><a href="#h56-0-12" id="h56-0-12" class="i">+) : DatabaseObject {
</a><a href="#h56-0-13" id="h56-0-13" class="i">+
</a><a href="#h56-0-14" id="h56-0-14" class="i">+    @SuppressLint(&quot;Range&quot;)
</a><a href="#h56-0-15" id="h56-0-15" class="i">+    override fun write(cursor: Cursor) {
</a><a href="#h56-0-16" id="h56-0-16" class="i">+        with(cursor) {
</a><a href="#h56-0-17" id="h56-0-17" class="i">+            userId = getStringOrNull(&quot;user_id&quot;)
</a><a href="#h56-0-18" id="h56-0-18" class="i">+            clientConversationId = getStringOrNull(&quot;client_conversation_id&quot;)
</a><a href="#h56-0-19" id="h56-0-19" class="i">+            conversationType = getInteger(&quot;conversation_type&quot;)
</a><a href="#h56-0-20" id="h56-0-20" class="i">+        }
</a><a href="#h56-0-21" id="h56-0-21" class="i">+    }
</a><a href="#h56-0-22" id="h56-0-22" class="i">+}
</a><b>diff --git a/<a id="h57" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/download/DownloadManagerClient.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/download/DownloadManagerClient.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/download/DownloadManagerClient.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/download/DownloadManagerClient.kt</a></b>
<a href="#h57-0" id="h57-0" class="h">@@ -0,0 +1,73 @@
</a><a href="#h57-0-0" id="h57-0-0" class="i">+package me.rhunk.snapenhance.core.download
</a><a href="#h57-0-1" id="h57-0-1" class="i">+
</a><a href="#h57-0-2" id="h57-0-2" class="i">+import android.content.Intent
</a><a href="#h57-0-3" id="h57-0-3" class="i">+import android.os.Bundle
</a><a href="#h57-0-4" id="h57-0-4" class="i">+import me.rhunk.snapenhance.ModContext
</a><a href="#h57-0-5" id="h57-0-5" class="i">+import me.rhunk.snapenhance.bridge.DownloadCallback
</a><a href="#h57-0-6" id="h57-0-6" class="i">+import me.rhunk.snapenhance.core.download.data.DashOptions
</a><a href="#h57-0-7" id="h57-0-7" class="i">+import me.rhunk.snapenhance.core.download.data.DownloadMediaType
</a><a href="#h57-0-8" id="h57-0-8" class="i">+import me.rhunk.snapenhance.core.download.data.DownloadMetadata
</a><a href="#h57-0-9" id="h57-0-9" class="i">+import me.rhunk.snapenhance.core.download.data.DownloadRequest
</a><a href="#h57-0-10" id="h57-0-10" class="i">+import me.rhunk.snapenhance.core.download.data.InputMedia
</a><a href="#h57-0-11" id="h57-0-11" class="i">+import me.rhunk.snapenhance.core.download.data.MediaEncryptionKeyPair
</a><a href="#h57-0-12" id="h57-0-12" class="i">+
</a><a href="#h57-0-13" id="h57-0-13" class="i">+class DownloadManagerClient (
</a><a href="#h57-0-14" id="h57-0-14" class="i">+    private val context: ModContext,
</a><a href="#h57-0-15" id="h57-0-15" class="i">+    private val metadata: DownloadMetadata,
</a><a href="#h57-0-16" id="h57-0-16" class="i">+    private val callback: DownloadCallback
</a><a href="#h57-0-17" id="h57-0-17" class="i">+) {
</a><a href="#h57-0-18" id="h57-0-18" class="i">+    companion object {
</a><a href="#h57-0-19" id="h57-0-19" class="i">+        const val DOWNLOAD_REQUEST_EXTRA = &quot;request&quot;
</a><a href="#h57-0-20" id="h57-0-20" class="i">+        const val DOWNLOAD_METADATA_EXTRA = &quot;metadata&quot;
</a><a href="#h57-0-21" id="h57-0-21" class="i">+    }
</a><a href="#h57-0-22" id="h57-0-22" class="i">+
</a><a href="#h57-0-23" id="h57-0-23" class="i">+    private fun enqueueDownloadRequest(request: DownloadRequest) {
</a><a href="#h57-0-24" id="h57-0-24" class="i">+        context.bridgeClient.enqueueDownload(Intent().apply {
</a><a href="#h57-0-25" id="h57-0-25" class="i">+            putExtras(Bundle().apply {
</a><a href="#h57-0-26" id="h57-0-26" class="i">+                putString(DOWNLOAD_REQUEST_EXTRA, context.gson.toJson(request))
</a><a href="#h57-0-27" id="h57-0-27" class="i">+                putString(DOWNLOAD_METADATA_EXTRA, context.gson.toJson(metadata))
</a><a href="#h57-0-28" id="h57-0-28" class="i">+            })
</a><a href="#h57-0-29" id="h57-0-29" class="i">+        }, callback)
</a><a href="#h57-0-30" id="h57-0-30" class="i">+    }
</a><a href="#h57-0-31" id="h57-0-31" class="i">+
</a><a href="#h57-0-32" id="h57-0-32" class="i">+    fun downloadDashMedia(playlistUrl: String, offsetTime: Long, duration: Long?) {
</a><a href="#h57-0-33" id="h57-0-33" class="i">+        enqueueDownloadRequest(
</a><a href="#h57-0-34" id="h57-0-34" class="i">+            DownloadRequest(
</a><a href="#h57-0-35" id="h57-0-35" class="i">+                inputMedias = arrayOf(
</a><a href="#h57-0-36" id="h57-0-36" class="i">+                    InputMedia(
</a><a href="#h57-0-37" id="h57-0-37" class="i">+                    content = playlistUrl,
</a><a href="#h57-0-38" id="h57-0-38" class="i">+                    type = DownloadMediaType.REMOTE_MEDIA
</a><a href="#h57-0-39" id="h57-0-39" class="i">+                )
</a><a href="#h57-0-40" id="h57-0-40" class="i">+                ),
</a><a href="#h57-0-41" id="h57-0-41" class="i">+                dashOptions = DashOptions(offsetTime, duration),
</a><a href="#h57-0-42" id="h57-0-42" class="i">+                flags = DownloadRequest.Flags.IS_DASH_PLAYLIST
</a><a href="#h57-0-43" id="h57-0-43" class="i">+            )
</a><a href="#h57-0-44" id="h57-0-44" class="i">+        )
</a><a href="#h57-0-45" id="h57-0-45" class="i">+    }
</a><a href="#h57-0-46" id="h57-0-46" class="i">+
</a><a href="#h57-0-47" id="h57-0-47" class="i">+    fun downloadSingleMedia(mediaData: String, mediaType: DownloadMediaType, encryption: MediaEncryptionKeyPair? = null) {
</a><a href="#h57-0-48" id="h57-0-48" class="i">+        enqueueDownloadRequest(
</a><a href="#h57-0-49" id="h57-0-49" class="i">+            DownloadRequest(
</a><a href="#h57-0-50" id="h57-0-50" class="i">+                inputMedias = arrayOf(
</a><a href="#h57-0-51" id="h57-0-51" class="i">+                    InputMedia(
</a><a href="#h57-0-52" id="h57-0-52" class="i">+                    content = mediaData,
</a><a href="#h57-0-53" id="h57-0-53" class="i">+                    type = mediaType,
</a><a href="#h57-0-54" id="h57-0-54" class="i">+                    encryption = encryption
</a><a href="#h57-0-55" id="h57-0-55" class="i">+                )
</a><a href="#h57-0-56" id="h57-0-56" class="i">+                )
</a><a href="#h57-0-57" id="h57-0-57" class="i">+            )
</a><a href="#h57-0-58" id="h57-0-58" class="i">+        )
</a><a href="#h57-0-59" id="h57-0-59" class="i">+    }
</a><a href="#h57-0-60" id="h57-0-60" class="i">+
</a><a href="#h57-0-61" id="h57-0-61" class="i">+    fun downloadMediaWithOverlay(
</a><a href="#h57-0-62" id="h57-0-62" class="i">+        original: InputMedia,
</a><a href="#h57-0-63" id="h57-0-63" class="i">+        overlay: InputMedia,
</a><a href="#h57-0-64" id="h57-0-64" class="i">+    ) {
</a><a href="#h57-0-65" id="h57-0-65" class="i">+        enqueueDownloadRequest(
</a><a href="#h57-0-66" id="h57-0-66" class="i">+            DownloadRequest(
</a><a href="#h57-0-67" id="h57-0-67" class="i">+                inputMedias = arrayOf(original, overlay),
</a><a href="#h57-0-68" id="h57-0-68" class="i">+                flags = DownloadRequest.Flags.MERGE_OVERLAY
</a><a href="#h57-0-69" id="h57-0-69" class="i">+            )
</a><a href="#h57-0-70" id="h57-0-70" class="i">+        )
</a><a href="#h57-0-71" id="h57-0-71" class="i">+    }
</a><a href="#h57-0-72" id="h57-0-72" class="i">+}</a><a href="#h57-0-73" id="h57-0-73" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h58" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/download/DownloadTaskManager.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/download/DownloadTaskManager.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/download/DownloadTaskManager.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/download/DownloadTaskManager.kt</a></b>
<a href="#h58-0" id="h58-0" class="h">@@ -0,0 +1,182 @@
</a><a href="#h58-0-0" id="h58-0-0" class="i">+package me.rhunk.snapenhance.core.download
</a><a href="#h58-0-1" id="h58-0-1" class="i">+
</a><a href="#h58-0-2" id="h58-0-2" class="i">+import android.annotation.SuppressLint
</a><a href="#h58-0-3" id="h58-0-3" class="i">+import android.content.Context
</a><a href="#h58-0-4" id="h58-0-4" class="i">+import android.database.sqlite.SQLiteDatabase
</a><a href="#h58-0-5" id="h58-0-5" class="i">+import me.rhunk.snapenhance.core.download.data.DownloadMetadata
</a><a href="#h58-0-6" id="h58-0-6" class="i">+import me.rhunk.snapenhance.core.download.data.DownloadObject
</a><a href="#h58-0-7" id="h58-0-7" class="i">+import me.rhunk.snapenhance.core.download.data.DownloadStage
</a><a href="#h58-0-8" id="h58-0-8" class="i">+import me.rhunk.snapenhance.core.download.data.MediaFilter
</a><a href="#h58-0-9" id="h58-0-9" class="i">+import me.rhunk.snapenhance.util.SQLiteDatabaseHelper
</a><a href="#h58-0-10" id="h58-0-10" class="i">+import me.rhunk.snapenhance.util.ktx.getIntOrNull
</a><a href="#h58-0-11" id="h58-0-11" class="i">+import me.rhunk.snapenhance.util.ktx.getStringOrNull
</a><a href="#h58-0-12" id="h58-0-12" class="i">+
</a><a href="#h58-0-13" id="h58-0-13" class="i">+class DownloadTaskManager {
</a><a href="#h58-0-14" id="h58-0-14" class="i">+    private lateinit var taskDatabase: SQLiteDatabase
</a><a href="#h58-0-15" id="h58-0-15" class="i">+    private val pendingTasks = mutableMapOf&lt;Int, DownloadObject&gt;()
</a><a href="#h58-0-16" id="h58-0-16" class="i">+    private val cachedTasks = mutableMapOf&lt;Int, DownloadObject&gt;()
</a><a href="#h58-0-17" id="h58-0-17" class="i">+
</a><a href="#h58-0-18" id="h58-0-18" class="i">+    @SuppressLint(&quot;Range&quot;)
</a><a href="#h58-0-19" id="h58-0-19" class="i">+    fun init(context: Context) {
</a><a href="#h58-0-20" id="h58-0-20" class="i">+        if (this::taskDatabase.isInitialized) return
</a><a href="#h58-0-21" id="h58-0-21" class="i">+        taskDatabase = context.openOrCreateDatabase(&quot;download_tasks&quot;, Context.MODE_PRIVATE, null).apply {
</a><a href="#h58-0-22" id="h58-0-22" class="i">+            SQLiteDatabaseHelper.createTablesFromSchema(this, mapOf(
</a><a href="#h58-0-23" id="h58-0-23" class="i">+                &quot;tasks&quot; to listOf(
</a><a href="#h58-0-24" id="h58-0-24" class="i">+                    &quot;id INTEGER PRIMARY KEY AUTOINCREMENT&quot;,
</a><a href="#h58-0-25" id="h58-0-25" class="i">+                    &quot;hash VARCHAR UNIQUE&quot;,
</a><a href="#h58-0-26" id="h58-0-26" class="i">+                    &quot;outputPath TEXT&quot;,
</a><a href="#h58-0-27" id="h58-0-27" class="i">+                    &quot;outputFile TEXT&quot;,
</a><a href="#h58-0-28" id="h58-0-28" class="i">+                    &quot;mediaDisplayType TEXT&quot;,
</a><a href="#h58-0-29" id="h58-0-29" class="i">+                    &quot;mediaDisplaySource TEXT&quot;,
</a><a href="#h58-0-30" id="h58-0-30" class="i">+                    &quot;iconUrl TEXT&quot;,
</a><a href="#h58-0-31" id="h58-0-31" class="i">+                    &quot;downloadStage TEXT&quot;
</a><a href="#h58-0-32" id="h58-0-32" class="i">+                )
</a><a href="#h58-0-33" id="h58-0-33" class="i">+            ))
</a><a href="#h58-0-34" id="h58-0-34" class="i">+        }
</a><a href="#h58-0-35" id="h58-0-35" class="i">+    }
</a><a href="#h58-0-36" id="h58-0-36" class="i">+
</a><a href="#h58-0-37" id="h58-0-37" class="i">+    fun addTask(task: DownloadObject): Int {
</a><a href="#h58-0-38" id="h58-0-38" class="i">+        taskDatabase.execSQL(&quot;INSERT INTO tasks (hash, outputPath, outputFile, mediaDisplayType, mediaDisplaySource, iconUrl, downloadStage) VALUES (?, ?, ?, ?, ?, ?, ?)&quot;,
</a><a href="#h58-0-39" id="h58-0-39" class="i">+            arrayOf(
</a><a href="#h58-0-40" id="h58-0-40" class="i">+                task.metadata.mediaIdentifier,
</a><a href="#h58-0-41" id="h58-0-41" class="i">+                task.metadata.outputPath,
</a><a href="#h58-0-42" id="h58-0-42" class="i">+                task.outputFile,
</a><a href="#h58-0-43" id="h58-0-43" class="i">+                task.metadata.mediaDisplayType,
</a><a href="#h58-0-44" id="h58-0-44" class="i">+                task.metadata.mediaDisplaySource,
</a><a href="#h58-0-45" id="h58-0-45" class="i">+                task.metadata.iconUrl,
</a><a href="#h58-0-46" id="h58-0-46" class="i">+                task.downloadStage.name
</a><a href="#h58-0-47" id="h58-0-47" class="i">+            )
</a><a href="#h58-0-48" id="h58-0-48" class="i">+        )
</a><a href="#h58-0-49" id="h58-0-49" class="i">+        task.downloadId = taskDatabase.rawQuery(&quot;SELECT last_insert_rowid()&quot;, null).use {
</a><a href="#h58-0-50" id="h58-0-50" class="i">+            it.moveToFirst()
</a><a href="#h58-0-51" id="h58-0-51" class="i">+            it.getInt(0)
</a><a href="#h58-0-52" id="h58-0-52" class="i">+        }
</a><a href="#h58-0-53" id="h58-0-53" class="i">+        pendingTasks[task.downloadId] = task
</a><a href="#h58-0-54" id="h58-0-54" class="i">+        return task.downloadId
</a><a href="#h58-0-55" id="h58-0-55" class="i">+    }
</a><a href="#h58-0-56" id="h58-0-56" class="i">+
</a><a href="#h58-0-57" id="h58-0-57" class="i">+    fun updateTask(task: DownloadObject) {
</a><a href="#h58-0-58" id="h58-0-58" class="i">+        taskDatabase.execSQL(&quot;UPDATE tasks SET hash = ?, outputPath = ?, outputFile = ?, mediaDisplayType = ?, mediaDisplaySource = ?, iconUrl = ?, downloadStage = ? WHERE id = ?&quot;,
</a><a href="#h58-0-59" id="h58-0-59" class="i">+            arrayOf(
</a><a href="#h58-0-60" id="h58-0-60" class="i">+                task.metadata.mediaIdentifier,
</a><a href="#h58-0-61" id="h58-0-61" class="i">+                task.metadata.outputPath,
</a><a href="#h58-0-62" id="h58-0-62" class="i">+                task.outputFile,
</a><a href="#h58-0-63" id="h58-0-63" class="i">+                task.metadata.mediaDisplayType,
</a><a href="#h58-0-64" id="h58-0-64" class="i">+                task.metadata.mediaDisplaySource,
</a><a href="#h58-0-65" id="h58-0-65" class="i">+                task.metadata.iconUrl,
</a><a href="#h58-0-66" id="h58-0-66" class="i">+                task.downloadStage.name,
</a><a href="#h58-0-67" id="h58-0-67" class="i">+                task.downloadId
</a><a href="#h58-0-68" id="h58-0-68" class="i">+            )
</a><a href="#h58-0-69" id="h58-0-69" class="i">+        )
</a><a href="#h58-0-70" id="h58-0-70" class="i">+        //if the task is no longer active, move it to the cached tasks
</a><a href="#h58-0-71" id="h58-0-71" class="i">+        if (task.isJobActive()) {
</a><a href="#h58-0-72" id="h58-0-72" class="i">+            pendingTasks[task.downloadId] = task
</a><a href="#h58-0-73" id="h58-0-73" class="i">+        } else {
</a><a href="#h58-0-74" id="h58-0-74" class="i">+            pendingTasks.remove(task.downloadId)
</a><a href="#h58-0-75" id="h58-0-75" class="i">+            cachedTasks[task.downloadId] = task
</a><a href="#h58-0-76" id="h58-0-76" class="i">+        }
</a><a href="#h58-0-77" id="h58-0-77" class="i">+    }
</a><a href="#h58-0-78" id="h58-0-78" class="i">+
</a><a href="#h58-0-79" id="h58-0-79" class="i">+    @SuppressLint(&quot;Range&quot;)
</a><a href="#h58-0-80" id="h58-0-80" class="i">+    fun canDownloadMedia(mediaIdentifier: String?): DownloadStage? {
</a><a href="#h58-0-81" id="h58-0-81" class="i">+        if (mediaIdentifier == null) return null
</a><a href="#h58-0-82" id="h58-0-82" class="i">+
</a><a href="#h58-0-83" id="h58-0-83" class="i">+        val cursor = taskDatabase.rawQuery(&quot;SELECT * FROM tasks WHERE hash = ?&quot;, arrayOf(mediaIdentifier))
</a><a href="#h58-0-84" id="h58-0-84" class="i">+        if (cursor.count &gt; 0) {
</a><a href="#h58-0-85" id="h58-0-85" class="i">+            cursor.moveToFirst()
</a><a href="#h58-0-86" id="h58-0-86" class="i">+            val downloadStage = DownloadStage.valueOf(cursor.getString(cursor.getColumnIndex(&quot;downloadStage&quot;)))
</a><a href="#h58-0-87" id="h58-0-87" class="i">+            cursor.close()
</a><a href="#h58-0-88" id="h58-0-88" class="i">+
</a><a href="#h58-0-89" id="h58-0-89" class="i">+            //if the stage has reached a final stage and is not in a saved state, remove the task
</a><a href="#h58-0-90" id="h58-0-90" class="i">+            if (downloadStage.isFinalStage &amp;&amp; downloadStage != DownloadStage.SAVED) {
</a><a href="#h58-0-91" id="h58-0-91" class="i">+                taskDatabase.execSQL(&quot;DELETE FROM tasks WHERE hash = ?&quot;, arrayOf(mediaIdentifier))
</a><a href="#h58-0-92" id="h58-0-92" class="i">+                return null
</a><a href="#h58-0-93" id="h58-0-93" class="i">+            }
</a><a href="#h58-0-94" id="h58-0-94" class="i">+
</a><a href="#h58-0-95" id="h58-0-95" class="i">+            return downloadStage
</a><a href="#h58-0-96" id="h58-0-96" class="i">+        }
</a><a href="#h58-0-97" id="h58-0-97" class="i">+        cursor.close()
</a><a href="#h58-0-98" id="h58-0-98" class="i">+        return null
</a><a href="#h58-0-99" id="h58-0-99" class="i">+    }
</a><a href="#h58-0-100" id="h58-0-100" class="i">+
</a><a href="#h58-0-101" id="h58-0-101" class="i">+    fun isEmpty(): Boolean {
</a><a href="#h58-0-102" id="h58-0-102" class="i">+        return cachedTasks.isEmpty() &amp;&amp; pendingTasks.isEmpty()
</a><a href="#h58-0-103" id="h58-0-103" class="i">+    }
</a><a href="#h58-0-104" id="h58-0-104" class="i">+
</a><a href="#h58-0-105" id="h58-0-105" class="i">+    private fun removeTask(id: Int) {
</a><a href="#h58-0-106" id="h58-0-106" class="i">+        taskDatabase.execSQL(&quot;DELETE FROM tasks WHERE id = ?&quot;, arrayOf(id))
</a><a href="#h58-0-107" id="h58-0-107" class="i">+        cachedTasks.remove(id)
</a><a href="#h58-0-108" id="h58-0-108" class="i">+        pendingTasks.remove(id)
</a><a href="#h58-0-109" id="h58-0-109" class="i">+    }
</a><a href="#h58-0-110" id="h58-0-110" class="i">+
</a><a href="#h58-0-111" id="h58-0-111" class="i">+    fun removeTask(task: DownloadObject) {
</a><a href="#h58-0-112" id="h58-0-112" class="i">+        removeTask(task.downloadId)
</a><a href="#h58-0-113" id="h58-0-113" class="i">+    }
</a><a href="#h58-0-114" id="h58-0-114" class="i">+
</a><a href="#h58-0-115" id="h58-0-115" class="i">+    fun queryFirstTasks(filter: MediaFilter): Map&lt;Int, DownloadObject&gt; {
</a><a href="#h58-0-116" id="h58-0-116" class="i">+        val isPendingFilter = filter == MediaFilter.PENDING
</a><a href="#h58-0-117" id="h58-0-117" class="i">+        val tasks = mutableMapOf&lt;Int, DownloadObject&gt;()
</a><a href="#h58-0-118" id="h58-0-118" class="i">+
</a><a href="#h58-0-119" id="h58-0-119" class="i">+        tasks.putAll(pendingTasks.filter { isPendingFilter || filter.matches(it.value.metadata.mediaDisplayType) })
</a><a href="#h58-0-120" id="h58-0-120" class="i">+        if (isPendingFilter) {
</a><a href="#h58-0-121" id="h58-0-121" class="i">+            return tasks.toSortedMap(reverseOrder())
</a><a href="#h58-0-122" id="h58-0-122" class="i">+        }
</a><a href="#h58-0-123" id="h58-0-123" class="i">+
</a><a href="#h58-0-124" id="h58-0-124" class="i">+        tasks.putAll(queryTasks(
</a><a href="#h58-0-125" id="h58-0-125" class="i">+            from = tasks.values.lastOrNull()?.downloadId ?: Int.MAX_VALUE,
</a><a href="#h58-0-126" id="h58-0-126" class="i">+            amount = 30,
</a><a href="#h58-0-127" id="h58-0-127" class="i">+            filter = filter
</a><a href="#h58-0-128" id="h58-0-128" class="i">+        ))
</a><a href="#h58-0-129" id="h58-0-129" class="i">+
</a><a href="#h58-0-130" id="h58-0-130" class="i">+        return tasks.toSortedMap(reverseOrder())
</a><a href="#h58-0-131" id="h58-0-131" class="i">+    }
</a><a href="#h58-0-132" id="h58-0-132" class="i">+
</a><a href="#h58-0-133" id="h58-0-133" class="i">+    @SuppressLint(&quot;Range&quot;)
</a><a href="#h58-0-134" id="h58-0-134" class="i">+    fun queryTasks(from: Int, amount: Int = 30, filter: MediaFilter = MediaFilter.NONE): Map&lt;Int, DownloadObject&gt; {
</a><a href="#h58-0-135" id="h58-0-135" class="i">+        if (filter == MediaFilter.PENDING) {
</a><a href="#h58-0-136" id="h58-0-136" class="i">+            return emptyMap()
</a><a href="#h58-0-137" id="h58-0-137" class="i">+        }
</a><a href="#h58-0-138" id="h58-0-138" class="i">+
</a><a href="#h58-0-139" id="h58-0-139" class="i">+        val cursor = taskDatabase.rawQuery(
</a><a href="#h58-0-140" id="h58-0-140" class="i">+            &quot;SELECT * FROM tasks WHERE id &lt; ? AND mediaDisplayType LIKE ? ORDER BY id DESC LIMIT ?&quot;,
</a><a href="#h58-0-141" id="h58-0-141" class="i">+            arrayOf(
</a><a href="#h58-0-142" id="h58-0-142" class="i">+                from.toString(),
</a><a href="#h58-0-143" id="h58-0-143" class="i">+                if (filter.shouldIgnoreFilter) &quot;%&quot; else &quot;%${filter.key}&quot;,
</a><a href="#h58-0-144" id="h58-0-144" class="i">+                amount.toString()
</a><a href="#h58-0-145" id="h58-0-145" class="i">+            )
</a><a href="#h58-0-146" id="h58-0-146" class="i">+        )
</a><a href="#h58-0-147" id="h58-0-147" class="i">+
</a><a href="#h58-0-148" id="h58-0-148" class="i">+        val result = sortedMapOf&lt;Int, DownloadObject&gt;()
</a><a href="#h58-0-149" id="h58-0-149" class="i">+
</a><a href="#h58-0-150" id="h58-0-150" class="i">+        while (cursor.moveToNext()) {
</a><a href="#h58-0-151" id="h58-0-151" class="i">+            val task = DownloadObject(
</a><a href="#h58-0-152" id="h58-0-152" class="i">+                downloadId = cursor.getIntOrNull(&quot;id&quot;)!!,
</a><a href="#h58-0-153" id="h58-0-153" class="i">+                outputFile = cursor.getStringOrNull(&quot;outputFile&quot;),
</a><a href="#h58-0-154" id="h58-0-154" class="i">+                metadata = DownloadMetadata(
</a><a href="#h58-0-155" id="h58-0-155" class="i">+                    outputPath = cursor.getStringOrNull(&quot;outputPath&quot;)!!,
</a><a href="#h58-0-156" id="h58-0-156" class="i">+                    mediaIdentifier = cursor.getStringOrNull(&quot;hash&quot;),
</a><a href="#h58-0-157" id="h58-0-157" class="i">+                    mediaDisplayType = cursor.getStringOrNull(&quot;mediaDisplayType&quot;),
</a><a href="#h58-0-158" id="h58-0-158" class="i">+                    mediaDisplaySource = cursor.getStringOrNull(&quot;mediaDisplaySource&quot;),
</a><a href="#h58-0-159" id="h58-0-159" class="i">+                    iconUrl = cursor.getStringOrNull(&quot;iconUrl&quot;)
</a><a href="#h58-0-160" id="h58-0-160" class="i">+                )
</a><a href="#h58-0-161" id="h58-0-161" class="i">+            ).apply {
</a><a href="#h58-0-162" id="h58-0-162" class="i">+                downloadTaskManager = this@DownloadTaskManager
</a><a href="#h58-0-163" id="h58-0-163" class="i">+                downloadStage = DownloadStage.valueOf(cursor.getStringOrNull(&quot;downloadStage&quot;)!!)
</a><a href="#h58-0-164" id="h58-0-164" class="i">+                //if downloadStage is not saved, it means the app was killed before the download was finished
</a><a href="#h58-0-165" id="h58-0-165" class="i">+                if (downloadStage != DownloadStage.SAVED) {
</a><a href="#h58-0-166" id="h58-0-166" class="i">+                    downloadStage = DownloadStage.FAILED
</a><a href="#h58-0-167" id="h58-0-167" class="i">+                }
</a><a href="#h58-0-168" id="h58-0-168" class="i">+            }
</a><a href="#h58-0-169" id="h58-0-169" class="i">+            result[task.downloadId] = task
</a><a href="#h58-0-170" id="h58-0-170" class="i">+        }
</a><a href="#h58-0-171" id="h58-0-171" class="i">+        cursor.close()
</a><a href="#h58-0-172" id="h58-0-172" class="i">+
</a><a href="#h58-0-173" id="h58-0-173" class="i">+        return result.toSortedMap(reverseOrder())
</a><a href="#h58-0-174" id="h58-0-174" class="i">+    }
</a><a href="#h58-0-175" id="h58-0-175" class="i">+
</a><a href="#h58-0-176" id="h58-0-176" class="i">+    fun removeAllTasks() {
</a><a href="#h58-0-177" id="h58-0-177" class="i">+        taskDatabase.execSQL(&quot;DELETE FROM tasks&quot;)
</a><a href="#h58-0-178" id="h58-0-178" class="i">+        cachedTasks.clear()
</a><a href="#h58-0-179" id="h58-0-179" class="i">+        pendingTasks.clear()
</a><a href="#h58-0-180" id="h58-0-180" class="i">+    }
</a><a href="#h58-0-181" id="h58-0-181" class="i">+}</a><a href="#h58-0-182" id="h58-0-182" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h59" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/download/data/DownloadMediaType.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/download/data/DownloadMediaType.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/download/data/DownloadMediaType.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/download/data/DownloadMediaType.kt</a></b>
<a href="#h59-0" id="h59-0" class="h">@@ -0,0 +1,22 @@
</a><a href="#h59-0-0" id="h59-0-0" class="i">+package me.rhunk.snapenhance.core.download.data
</a><a href="#h59-0-1" id="h59-0-1" class="i">+
</a><a href="#h59-0-2" id="h59-0-2" class="i">+import android.net.Uri
</a><a href="#h59-0-3" id="h59-0-3" class="i">+
</a><a href="#h59-0-4" id="h59-0-4" class="i">+enum class DownloadMediaType {
</a><a href="#h59-0-5" id="h59-0-5" class="i">+    PROTO_MEDIA,
</a><a href="#h59-0-6" id="h59-0-6" class="i">+    DIRECT_MEDIA,
</a><a href="#h59-0-7" id="h59-0-7" class="i">+    REMOTE_MEDIA,
</a><a href="#h59-0-8" id="h59-0-8" class="i">+    LOCAL_MEDIA;
</a><a href="#h59-0-9" id="h59-0-9" class="i">+
</a><a href="#h59-0-10" id="h59-0-10" class="i">+    companion object {
</a><a href="#h59-0-11" id="h59-0-11" class="i">+        fun fromUri(uri: Uri): DownloadMediaType {
</a><a href="#h59-0-12" id="h59-0-12" class="i">+            return when (uri.scheme) {
</a><a href="#h59-0-13" id="h59-0-13" class="i">+                &quot;proto&quot; -&gt; PROTO_MEDIA
</a><a href="#h59-0-14" id="h59-0-14" class="i">+                &quot;direct&quot; -&gt; DIRECT_MEDIA
</a><a href="#h59-0-15" id="h59-0-15" class="i">+                &quot;http&quot;, &quot;https&quot; -&gt; REMOTE_MEDIA
</a><a href="#h59-0-16" id="h59-0-16" class="i">+                &quot;file&quot; -&gt; LOCAL_MEDIA
</a><a href="#h59-0-17" id="h59-0-17" class="i">+                else -&gt; throw IllegalArgumentException(&quot;Unknown uri scheme: ${uri.scheme}&quot;)
</a><a href="#h59-0-18" id="h59-0-18" class="i">+            }
</a><a href="#h59-0-19" id="h59-0-19" class="i">+        }
</a><a href="#h59-0-20" id="h59-0-20" class="i">+    }
</a><a href="#h59-0-21" id="h59-0-21" class="i">+}</a><a href="#h59-0-22" id="h59-0-22" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h60" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/download/data/DownloadMetadata.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/download/data/DownloadMetadata.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/download/data/DownloadMetadata.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/download/data/DownloadMetadata.kt</a></b>
<a href="#h60-0" id="h60-0" class="h">@@ -0,0 +1,9 @@
</a><a href="#h60-0-0" id="h60-0-0" class="i">+package me.rhunk.snapenhance.core.download.data
</a><a href="#h60-0-1" id="h60-0-1" class="i">+
</a><a href="#h60-0-2" id="h60-0-2" class="i">+data class DownloadMetadata(
</a><a href="#h60-0-3" id="h60-0-3" class="i">+    val mediaIdentifier: String?,
</a><a href="#h60-0-4" id="h60-0-4" class="i">+    val outputPath: String,
</a><a href="#h60-0-5" id="h60-0-5" class="i">+    val mediaDisplaySource: String?,
</a><a href="#h60-0-6" id="h60-0-6" class="i">+    val mediaDisplayType: String?,
</a><a href="#h60-0-7" id="h60-0-7" class="i">+    val iconUrl: String?
</a><a href="#h60-0-8" id="h60-0-8" class="i">+)</a><a href="#h60-0-9" id="h60-0-9" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h61" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/download/data/DownloadObject.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/download/data/DownloadObject.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/download/data/DownloadObject.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/download/data/DownloadObject.kt</a></b>
<a href="#h61-0" id="h61-0" class="h">@@ -0,0 +1,32 @@
</a><a href="#h61-0-0" id="h61-0-0" class="i">+package me.rhunk.snapenhance.core.download.data
</a><a href="#h61-0-1" id="h61-0-1" class="i">+
</a><a href="#h61-0-2" id="h61-0-2" class="i">+import kotlinx.coroutines.Job
</a><a href="#h61-0-3" id="h61-0-3" class="i">+import me.rhunk.snapenhance.core.download.DownloadTaskManager
</a><a href="#h61-0-4" id="h61-0-4" class="i">+
</a><a href="#h61-0-5" id="h61-0-5" class="i">+data class DownloadObject(
</a><a href="#h61-0-6" id="h61-0-6" class="i">+    var downloadId: Int = 0,
</a><a href="#h61-0-7" id="h61-0-7" class="i">+    var outputFile: String? = null,
</a><a href="#h61-0-8" id="h61-0-8" class="i">+    val metadata : DownloadMetadata
</a><a href="#h61-0-9" id="h61-0-9" class="i">+) {
</a><a href="#h61-0-10" id="h61-0-10" class="i">+    lateinit var downloadTaskManager: DownloadTaskManager
</a><a href="#h61-0-11" id="h61-0-11" class="i">+    var job: Job? = null
</a><a href="#h61-0-12" id="h61-0-12" class="i">+
</a><a href="#h61-0-13" id="h61-0-13" class="i">+    var changeListener = { _: DownloadStage, _: DownloadStage -&gt; }
</a><a href="#h61-0-14" id="h61-0-14" class="i">+    private var _stage: DownloadStage = DownloadStage.PENDING
</a><a href="#h61-0-15" id="h61-0-15" class="i">+    var downloadStage: DownloadStage
</a><a href="#h61-0-16" id="h61-0-16" class="i">+        get() = synchronized(this) {
</a><a href="#h61-0-17" id="h61-0-17" class="i">+            _stage
</a><a href="#h61-0-18" id="h61-0-18" class="i">+        }
</a><a href="#h61-0-19" id="h61-0-19" class="i">+        set(value) = synchronized(this) {
</a><a href="#h61-0-20" id="h61-0-20" class="i">+            changeListener(_stage, value)
</a><a href="#h61-0-21" id="h61-0-21" class="i">+            _stage = value
</a><a href="#h61-0-22" id="h61-0-22" class="i">+            downloadTaskManager.updateTask(this)
</a><a href="#h61-0-23" id="h61-0-23" class="i">+        }
</a><a href="#h61-0-24" id="h61-0-24" class="i">+
</a><a href="#h61-0-25" id="h61-0-25" class="i">+    fun isJobActive() = job?.isActive == true
</a><a href="#h61-0-26" id="h61-0-26" class="i">+
</a><a href="#h61-0-27" id="h61-0-27" class="i">+    fun cancel() {
</a><a href="#h61-0-28" id="h61-0-28" class="i">+        downloadStage = DownloadStage.CANCELLED
</a><a href="#h61-0-29" id="h61-0-29" class="i">+        job?.cancel()
</a><a href="#h61-0-30" id="h61-0-30" class="i">+    }
</a><a href="#h61-0-31" id="h61-0-31" class="i">+}
</a><b>diff --git a/<a id="h62" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/download/data/DownloadRequest.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/download/data/DownloadRequest.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/download/data/DownloadRequest.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/download/data/DownloadRequest.kt</a></b>
<a href="#h62-0" id="h62-0" class="h">@@ -0,0 +1,26 @@
</a><a href="#h62-0-0" id="h62-0-0" class="i">+package me.rhunk.snapenhance.core.download.data
</a><a href="#h62-0-1" id="h62-0-1" class="i">+
</a><a href="#h62-0-2" id="h62-0-2" class="i">+
</a><a href="#h62-0-3" id="h62-0-3" class="i">+data class DashOptions(val offsetTime: Long, val duration: Long?)
</a><a href="#h62-0-4" id="h62-0-4" class="i">+data class InputMedia(
</a><a href="#h62-0-5" id="h62-0-5" class="i">+    val content: String,
</a><a href="#h62-0-6" id="h62-0-6" class="i">+    val type: DownloadMediaType,
</a><a href="#h62-0-7" id="h62-0-7" class="i">+    val encryption: MediaEncryptionKeyPair? = null
</a><a href="#h62-0-8" id="h62-0-8" class="i">+)
</a><a href="#h62-0-9" id="h62-0-9" class="i">+
</a><a href="#h62-0-10" id="h62-0-10" class="i">+class DownloadRequest(
</a><a href="#h62-0-11" id="h62-0-11" class="i">+    val inputMedias: Array&lt;InputMedia&gt;,
</a><a href="#h62-0-12" id="h62-0-12" class="i">+    val dashOptions: DashOptions? = null,
</a><a href="#h62-0-13" id="h62-0-13" class="i">+    private val flags: Int = 0,
</a><a href="#h62-0-14" id="h62-0-14" class="i">+) {
</a><a href="#h62-0-15" id="h62-0-15" class="i">+    object Flags {
</a><a href="#h62-0-16" id="h62-0-16" class="i">+        const val MERGE_OVERLAY = 1
</a><a href="#h62-0-17" id="h62-0-17" class="i">+        const val IS_DASH_PLAYLIST = 2
</a><a href="#h62-0-18" id="h62-0-18" class="i">+    }
</a><a href="#h62-0-19" id="h62-0-19" class="i">+
</a><a href="#h62-0-20" id="h62-0-20" class="i">+    val isDashPlaylist: Boolean
</a><a href="#h62-0-21" id="h62-0-21" class="i">+        get() = flags and Flags.IS_DASH_PLAYLIST != 0
</a><a href="#h62-0-22" id="h62-0-22" class="i">+
</a><a href="#h62-0-23" id="h62-0-23" class="i">+    val shouldMergeOverlay: Boolean
</a><a href="#h62-0-24" id="h62-0-24" class="i">+        get() = flags and Flags.MERGE_OVERLAY != 0
</a><a href="#h62-0-25" id="h62-0-25" class="i">+}</a><a href="#h62-0-26" id="h62-0-26" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h63" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/download/data/DownloadStage.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/download/data/DownloadStage.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/download/data/DownloadStage.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/download/data/DownloadStage.kt</a></b>
<a href="#h63-0" id="h63-0" class="h">@@ -0,0 +1,14 @@
</a><a href="#h63-0-0" id="h63-0-0" class="i">+package me.rhunk.snapenhance.core.download.data
</a><a href="#h63-0-1" id="h63-0-1" class="i">+
</a><a href="#h63-0-2" id="h63-0-2" class="i">+enum class DownloadStage(
</a><a href="#h63-0-3" id="h63-0-3" class="i">+    val isFinalStage: Boolean = false,
</a><a href="#h63-0-4" id="h63-0-4" class="i">+) {
</a><a href="#h63-0-5" id="h63-0-5" class="i">+    PENDING(false),
</a><a href="#h63-0-6" id="h63-0-6" class="i">+    DOWNLOADING(false),
</a><a href="#h63-0-7" id="h63-0-7" class="i">+    MERGING(false),
</a><a href="#h63-0-8" id="h63-0-8" class="i">+    DOWNLOADED(true),
</a><a href="#h63-0-9" id="h63-0-9" class="i">+    SAVED(true),
</a><a href="#h63-0-10" id="h63-0-10" class="i">+    MERGE_FAILED(true),
</a><a href="#h63-0-11" id="h63-0-11" class="i">+    FAILED(true),
</a><a href="#h63-0-12" id="h63-0-12" class="i">+    CANCELLED(true)
</a><a href="#h63-0-13" id="h63-0-13" class="i">+}</a><a href="#h63-0-14" id="h63-0-14" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h64" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/download/data/MediaEncryptionKeyPair.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/download/data/MediaEncryptionKeyPair.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/download/data/MediaEncryptionKeyPair.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/download/data/MediaEncryptionKeyPair.kt</a></b>
<a href="#h64-0" id="h64-0" class="h">@@ -0,0 +1,21 @@
</a><a href="#h64-0-0" id="h64-0-0" class="i">+@file:OptIn(ExperimentalEncodingApi::class)
</a><a href="#h64-0-1" id="h64-0-1" class="i">+
</a><a href="#h64-0-2" id="h64-0-2" class="i">+package me.rhunk.snapenhance.core.download.data
</a><a href="#h64-0-3" id="h64-0-3" class="i">+
</a><a href="#h64-0-4" id="h64-0-4" class="i">+import me.rhunk.snapenhance.data.wrapper.impl.media.EncryptionWrapper
</a><a href="#h64-0-5" id="h64-0-5" class="i">+import kotlin.io.encoding.Base64
</a><a href="#h64-0-6" id="h64-0-6" class="i">+import kotlin.io.encoding.ExperimentalEncodingApi
</a><a href="#h64-0-7" id="h64-0-7" class="i">+
</a><a href="#h64-0-8" id="h64-0-8" class="i">+// key and iv are base64 encoded
</a><a href="#h64-0-9" id="h64-0-9" class="i">+data class MediaEncryptionKeyPair(
</a><a href="#h64-0-10" id="h64-0-10" class="i">+    val key: String,
</a><a href="#h64-0-11" id="h64-0-11" class="i">+    val iv: String
</a><a href="#h64-0-12" id="h64-0-12" class="i">+)
</a><a href="#h64-0-13" id="h64-0-13" class="i">+
</a><a href="#h64-0-14" id="h64-0-14" class="i">+fun Pair&lt;ByteArray, ByteArray&gt;.toKeyPair(): MediaEncryptionKeyPair {
</a><a href="#h64-0-15" id="h64-0-15" class="i">+    return MediaEncryptionKeyPair(Base64.UrlSafe.encode(this.first), Base64.UrlSafe.encode(this.second))
</a><a href="#h64-0-16" id="h64-0-16" class="i">+}
</a><a href="#h64-0-17" id="h64-0-17" class="i">+
</a><a href="#h64-0-18" id="h64-0-18" class="i">+fun EncryptionWrapper.toKeyPair(): MediaEncryptionKeyPair {
</a><a href="#h64-0-19" id="h64-0-19" class="i">+    return MediaEncryptionKeyPair(Base64.UrlSafe.encode(this.keySpec), Base64.UrlSafe.encode(this.ivKeyParameterSpec))
</a><a href="#h64-0-20" id="h64-0-20" class="i">+}</a><a href="#h64-0-21" id="h64-0-21" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h65" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/download/data/MediaFilter.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/download/data/MediaFilter.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/download/data/MediaFilter.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/download/data/MediaFilter.kt</a></b>
<a href="#h65-0" id="h65-0" class="h">@@ -0,0 +1,18 @@
</a><a href="#h65-0-0" id="h65-0-0" class="i">+package me.rhunk.snapenhance.core.download.data
</a><a href="#h65-0-1" id="h65-0-1" class="i">+
</a><a href="#h65-0-2" id="h65-0-2" class="i">+enum class MediaFilter(
</a><a href="#h65-0-3" id="h65-0-3" class="i">+    val key: String,
</a><a href="#h65-0-4" id="h65-0-4" class="i">+    val shouldIgnoreFilter: Boolean = false
</a><a href="#h65-0-5" id="h65-0-5" class="i">+) {
</a><a href="#h65-0-6" id="h65-0-6" class="i">+    NONE(&quot;none&quot;, true),
</a><a href="#h65-0-7" id="h65-0-7" class="i">+    PENDING(&quot;pending&quot;, true),
</a><a href="#h65-0-8" id="h65-0-8" class="i">+    CHAT_MEDIA(&quot;chat_media&quot;),
</a><a href="#h65-0-9" id="h65-0-9" class="i">+    STORY(&quot;story&quot;),
</a><a href="#h65-0-10" id="h65-0-10" class="i">+    SPOTLIGHT(&quot;spotlight&quot;),
</a><a href="#h65-0-11" id="h65-0-11" class="i">+    PROFILE_PICTURE(&quot;profile_picture&quot;);
</a><a href="#h65-0-12" id="h65-0-12" class="i">+
</a><a href="#h65-0-13" id="h65-0-13" class="i">+    fun matches(source: String?): Boolean {
</a><a href="#h65-0-14" id="h65-0-14" class="i">+        if (source == null) return false
</a><a href="#h65-0-15" id="h65-0-15" class="i">+        return source.contains(key, ignoreCase = true)
</a><a href="#h65-0-16" id="h65-0-16" class="i">+    }
</a><a href="#h65-0-17" id="h65-0-17" class="i">+}</a><a href="#h65-0-18" id="h65-0-18" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h66" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/download/data/SplitMediaAssetType.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/download/data/SplitMediaAssetType.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/download/data/SplitMediaAssetType.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/download/data/SplitMediaAssetType.kt</a></b>
<a href="#h66-0" id="h66-0" class="h">@@ -0,0 +1,5 @@
</a><a href="#h66-0-0" id="h66-0-0" class="i">+package me.rhunk.snapenhance.core.download.data
</a><a href="#h66-0-1" id="h66-0-1" class="i">+
</a><a href="#h66-0-2" id="h66-0-2" class="i">+enum class SplitMediaAssetType {
</a><a href="#h66-0-3" id="h66-0-3" class="i">+    ORIGINAL, OVERLAY
</a><a href="#h66-0-4" id="h66-0-4" class="i">+}
</a><b>diff --git a/<a id="h67" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/eventbus/EventBus.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/eventbus/EventBus.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/eventbus/EventBus.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/eventbus/EventBus.kt</a></b>
<a href="#h67-0" id="h67-0" class="h">@@ -1,6 +1,5 @@
</a> package me.rhunk.snapenhance.core.eventbus
 
<a href="#h67-0-2" id="h67-0-2" class="d">-import me.rhunk.snapenhance.Logger
</a> import me.rhunk.snapenhance.ModContext
 import kotlin.reflect.KClass
 
<a href="#h67-1" id="h67-1" class="h">@@ -14,7 +13,7 @@ interface IListener&lt;T&gt; {
</a> }
 
 class EventBus(
<a href="#h67-1-3" id="h67-1-3" class="d">-    private val context: ModContext
</a><a href="#h67-1-4" id="h67-1-4" class="i">+    val context: ModContext
</a> ) {
     private val subscribers = mutableMapOf&lt;KClass&lt;out Event&gt;, MutableList&lt;IListener&lt;out Event&gt;&gt;&gt;()
 
<a href="#h67-2" id="h67-2" class="h">@@ -34,7 +33,7 @@ class EventBus(
</a>                 runCatching {
                     listener(event)
                 }.onFailure {
<a href="#h67-2-3" id="h67-2-3" class="d">-                    Logger.error(&quot;Error while handling event ${event::class.simpleName}&quot;, it)
</a><a href="#h67-2-4" id="h67-2-4" class="i">+                    context.log.error(&quot;Error while handling event ${event::class.simpleName}&quot;, it)
</a>                 }
             }
         }
<a href="#h67-3" id="h67-3" class="h">@@ -61,7 +60,7 @@ class EventBus(
</a>             runCatching {
                 (listener as IListener&lt;T&gt;).handle(event)
             }.onFailure { t -&gt;
<a href="#h67-3-3" id="h67-3-3" class="d">-                Logger.error(&quot;Error while handling event ${event::class.simpleName} by ${listener::class.simpleName}&quot;, t)
</a><a href="#h67-3-4" id="h67-3-4" class="i">+                context.log.error(&quot;Error while handling event ${event::class.simpleName} by ${listener::class.simpleName}&quot;, t)
</a>             }
         }
         return event
<b>diff --git a/<a id="h68" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/database/DatabaseAccess.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/database/DatabaseAccess.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/database/DatabaseAccess.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/database/DatabaseAccess.kt</a></b>
<a href="#h68-0" id="h68-0" class="h">@@ -1,253 +0,0 @@
</a><a href="#h68-0-0" id="h68-0-0" class="d">-package me.rhunk.snapenhance.database
</a><a href="#h68-0-1" id="h68-0-1" class="d">-
</a><a href="#h68-0-2" id="h68-0-2" class="d">-import android.annotation.SuppressLint
</a><a href="#h68-0-3" id="h68-0-3" class="d">-import android.database.sqlite.SQLiteDatabase
</a><a href="#h68-0-4" id="h68-0-4" class="d">-import me.rhunk.snapenhance.Logger
</a><a href="#h68-0-5" id="h68-0-5" class="d">-import me.rhunk.snapenhance.ModContext
</a><a href="#h68-0-6" id="h68-0-6" class="d">-import me.rhunk.snapenhance.database.objects.*
</a><a href="#h68-0-7" id="h68-0-7" class="d">-import me.rhunk.snapenhance.manager.Manager
</a><a href="#h68-0-8" id="h68-0-8" class="d">-import java.io.File
</a><a href="#h68-0-9" id="h68-0-9" class="d">-
</a><a href="#h68-0-10" id="h68-0-10" class="d">-@SuppressLint(&quot;Range&quot;)
</a><a href="#h68-0-11" id="h68-0-11" class="d">-class DatabaseAccess(private val context: ModContext) : Manager {
</a><a href="#h68-0-12" id="h68-0-12" class="d">-    private val databaseLock = Any()
</a><a href="#h68-0-13" id="h68-0-13" class="d">-
</a><a href="#h68-0-14" id="h68-0-14" class="d">-    private val arroyoDatabase: File by lazy {
</a><a href="#h68-0-15" id="h68-0-15" class="d">-        context.androidContext.getDatabasePath(&quot;arroyo.db&quot;)
</a><a href="#h68-0-16" id="h68-0-16" class="d">-    }
</a><a href="#h68-0-17" id="h68-0-17" class="d">-
</a><a href="#h68-0-18" id="h68-0-18" class="d">-    private val mainDatabase: File by lazy {
</a><a href="#h68-0-19" id="h68-0-19" class="d">-        context.androidContext.getDatabasePath(&quot;main.db&quot;)
</a><a href="#h68-0-20" id="h68-0-20" class="d">-    }
</a><a href="#h68-0-21" id="h68-0-21" class="d">-
</a><a href="#h68-0-22" id="h68-0-22" class="d">-    private fun openMain(): SQLiteDatabase {
</a><a href="#h68-0-23" id="h68-0-23" class="d">-        return SQLiteDatabase.openDatabase(
</a><a href="#h68-0-24" id="h68-0-24" class="d">-            mainDatabase.absolutePath,
</a><a href="#h68-0-25" id="h68-0-25" class="d">-            null,
</a><a href="#h68-0-26" id="h68-0-26" class="d">-            SQLiteDatabase.OPEN_READONLY
</a><a href="#h68-0-27" id="h68-0-27" class="d">-        )!!
</a><a href="#h68-0-28" id="h68-0-28" class="d">-    }
</a><a href="#h68-0-29" id="h68-0-29" class="d">-
</a><a href="#h68-0-30" id="h68-0-30" class="d">-    private fun openArroyo(): SQLiteDatabase {
</a><a href="#h68-0-31" id="h68-0-31" class="d">-        return SQLiteDatabase.openDatabase(
</a><a href="#h68-0-32" id="h68-0-32" class="d">-            arroyoDatabase.absolutePath,
</a><a href="#h68-0-33" id="h68-0-33" class="d">-            null,
</a><a href="#h68-0-34" id="h68-0-34" class="d">-            SQLiteDatabase.OPEN_READONLY
</a><a href="#h68-0-35" id="h68-0-35" class="d">-        )!!
</a><a href="#h68-0-36" id="h68-0-36" class="d">-    }
</a><a href="#h68-0-37" id="h68-0-37" class="d">-
</a><a href="#h68-0-38" id="h68-0-38" class="d">-    fun hasArroyo(): Boolean {
</a><a href="#h68-0-39" id="h68-0-39" class="d">-        return arroyoDatabase.exists()
</a><a href="#h68-0-40" id="h68-0-40" class="d">-    }
</a><a href="#h68-0-41" id="h68-0-41" class="d">-
</a><a href="#h68-0-42" id="h68-0-42" class="d">-    private fun &lt;T&gt; safeDatabaseOperation(
</a><a href="#h68-0-43" id="h68-0-43" class="d">-        database: SQLiteDatabase,
</a><a href="#h68-0-44" id="h68-0-44" class="d">-        query: (SQLiteDatabase) -&gt; T?
</a><a href="#h68-0-45" id="h68-0-45" class="d">-    ): T? {
</a><a href="#h68-0-46" id="h68-0-46" class="d">-        synchronized(databaseLock) {
</a><a href="#h68-0-47" id="h68-0-47" class="d">-            return runCatching {
</a><a href="#h68-0-48" id="h68-0-48" class="d">-                query(database)
</a><a href="#h68-0-49" id="h68-0-49" class="d">-            }.onFailure {
</a><a href="#h68-0-50" id="h68-0-50" class="d">-                Logger.xposedLog(&quot;Database operation failed&quot;, it)
</a><a href="#h68-0-51" id="h68-0-51" class="d">-            }.getOrNull()
</a><a href="#h68-0-52" id="h68-0-52" class="d">-        }
</a><a href="#h68-0-53" id="h68-0-53" class="d">-    }
</a><a href="#h68-0-54" id="h68-0-54" class="d">-
</a><a href="#h68-0-55" id="h68-0-55" class="d">-    private fun &lt;T : DatabaseObject&gt; readDatabaseObject(
</a><a href="#h68-0-56" id="h68-0-56" class="d">-        obj: T,
</a><a href="#h68-0-57" id="h68-0-57" class="d">-        database: SQLiteDatabase,
</a><a href="#h68-0-58" id="h68-0-58" class="d">-        table: String,
</a><a href="#h68-0-59" id="h68-0-59" class="d">-        where: String,
</a><a href="#h68-0-60" id="h68-0-60" class="d">-        args: Array&lt;String&gt;
</a><a href="#h68-0-61" id="h68-0-61" class="d">-    ): T? {
</a><a href="#h68-0-62" id="h68-0-62" class="d">-        val cursor = database.rawQuery(&quot;SELECT * FROM $table WHERE $where&quot;, args)
</a><a href="#h68-0-63" id="h68-0-63" class="d">-        if (!cursor.moveToFirst()) {
</a><a href="#h68-0-64" id="h68-0-64" class="d">-            cursor.close()
</a><a href="#h68-0-65" id="h68-0-65" class="d">-            return null
</a><a href="#h68-0-66" id="h68-0-66" class="d">-        }
</a><a href="#h68-0-67" id="h68-0-67" class="d">-        try {
</a><a href="#h68-0-68" id="h68-0-68" class="d">-            obj.write(cursor)
</a><a href="#h68-0-69" id="h68-0-69" class="d">-        } catch (e: Throwable) {
</a><a href="#h68-0-70" id="h68-0-70" class="d">-            Logger.xposedLog(e)
</a><a href="#h68-0-71" id="h68-0-71" class="d">-        }
</a><a href="#h68-0-72" id="h68-0-72" class="d">-        cursor.close()
</a><a href="#h68-0-73" id="h68-0-73" class="d">-        return obj
</a><a href="#h68-0-74" id="h68-0-74" class="d">-    }
</a><a href="#h68-0-75" id="h68-0-75" class="d">-
</a><a href="#h68-0-76" id="h68-0-76" class="d">-    fun getFeedEntryByUserId(userId: String): FriendFeedEntry? {
</a><a href="#h68-0-77" id="h68-0-77" class="d">-        return safeDatabaseOperation(openMain()) { database -&gt;
</a><a href="#h68-0-78" id="h68-0-78" class="d">-            readDatabaseObject(
</a><a href="#h68-0-79" id="h68-0-79" class="d">-                FriendFeedEntry(),
</a><a href="#h68-0-80" id="h68-0-80" class="d">-                database,
</a><a href="#h68-0-81" id="h68-0-81" class="d">-                &quot;FriendsFeedView&quot;,
</a><a href="#h68-0-82" id="h68-0-82" class="d">-                &quot;friendUserId = ?&quot;,
</a><a href="#h68-0-83" id="h68-0-83" class="d">-                arrayOf(userId)
</a><a href="#h68-0-84" id="h68-0-84" class="d">-            )
</a><a href="#h68-0-85" id="h68-0-85" class="d">-        }
</a><a href="#h68-0-86" id="h68-0-86" class="d">-    }
</a><a href="#h68-0-87" id="h68-0-87" class="d">-
</a><a href="#h68-0-88" id="h68-0-88" class="d">-    val myUserId by lazy {
</a><a href="#h68-0-89" id="h68-0-89" class="d">-        safeDatabaseOperation(openArroyo()) { arroyoDatabase: SQLiteDatabase -&gt;
</a><a href="#h68-0-90" id="h68-0-90" class="d">-            val cursor = arroyoDatabase.rawQuery(buildString {
</a><a href="#h68-0-91" id="h68-0-91" class="d">-                append(&quot;SELECT * FROM required_values WHERE key = &#39;USERID&#39;&quot;)
</a><a href="#h68-0-92" id="h68-0-92" class="d">-            }, null)
</a><a href="#h68-0-93" id="h68-0-93" class="d">-
</a><a href="#h68-0-94" id="h68-0-94" class="d">-            if (!cursor.moveToFirst()) {
</a><a href="#h68-0-95" id="h68-0-95" class="d">-                cursor.close()
</a><a href="#h68-0-96" id="h68-0-96" class="d">-                return@safeDatabaseOperation null
</a><a href="#h68-0-97" id="h68-0-97" class="d">-            }
</a><a href="#h68-0-98" id="h68-0-98" class="d">-
</a><a href="#h68-0-99" id="h68-0-99" class="d">-            val userId = cursor.getString(cursor.getColumnIndex(&quot;value&quot;))
</a><a href="#h68-0-100" id="h68-0-100" class="d">-            cursor.close()
</a><a href="#h68-0-101" id="h68-0-101" class="d">-            userId
</a><a href="#h68-0-102" id="h68-0-102" class="d">-        }!!
</a><a href="#h68-0-103" id="h68-0-103" class="d">-    }
</a><a href="#h68-0-104" id="h68-0-104" class="d">-
</a><a href="#h68-0-105" id="h68-0-105" class="d">-    fun getFeedEntryByConversationId(conversationId: String): FriendFeedEntry? {
</a><a href="#h68-0-106" id="h68-0-106" class="d">-        return safeDatabaseOperation(openMain()) {
</a><a href="#h68-0-107" id="h68-0-107" class="d">-            readDatabaseObject(
</a><a href="#h68-0-108" id="h68-0-108" class="d">-                FriendFeedEntry(),
</a><a href="#h68-0-109" id="h68-0-109" class="d">-                it,
</a><a href="#h68-0-110" id="h68-0-110" class="d">-                &quot;FriendsFeedView&quot;,
</a><a href="#h68-0-111" id="h68-0-111" class="d">-                &quot;key = ?&quot;,
</a><a href="#h68-0-112" id="h68-0-112" class="d">-                arrayOf(conversationId)
</a><a href="#h68-0-113" id="h68-0-113" class="d">-            )
</a><a href="#h68-0-114" id="h68-0-114" class="d">-        }
</a><a href="#h68-0-115" id="h68-0-115" class="d">-    }
</a><a href="#h68-0-116" id="h68-0-116" class="d">-
</a><a href="#h68-0-117" id="h68-0-117" class="d">-    fun getFriendInfo(userId: String): FriendInfo? {
</a><a href="#h68-0-118" id="h68-0-118" class="d">-        return safeDatabaseOperation(openMain()) {
</a><a href="#h68-0-119" id="h68-0-119" class="d">-            readDatabaseObject(
</a><a href="#h68-0-120" id="h68-0-120" class="d">-                FriendInfo(),
</a><a href="#h68-0-121" id="h68-0-121" class="d">-                it,
</a><a href="#h68-0-122" id="h68-0-122" class="d">-                &quot;FriendWithUsername&quot;,
</a><a href="#h68-0-123" id="h68-0-123" class="d">-                &quot;userId = ?&quot;,
</a><a href="#h68-0-124" id="h68-0-124" class="d">-                arrayOf(userId)
</a><a href="#h68-0-125" id="h68-0-125" class="d">-            )
</a><a href="#h68-0-126" id="h68-0-126" class="d">-        }
</a><a href="#h68-0-127" id="h68-0-127" class="d">-    }
</a><a href="#h68-0-128" id="h68-0-128" class="d">-
</a><a href="#h68-0-129" id="h68-0-129" class="d">-    fun getFeedEntries(limit: Int): List&lt;FriendFeedEntry&gt; {
</a><a href="#h68-0-130" id="h68-0-130" class="d">-        return safeDatabaseOperation(openMain()) { database -&gt;
</a><a href="#h68-0-131" id="h68-0-131" class="d">-            val cursor = database.rawQuery(
</a><a href="#h68-0-132" id="h68-0-132" class="d">-                &quot;SELECT * FROM FriendsFeedView ORDER BY _id LIMIT ?&quot;,
</a><a href="#h68-0-133" id="h68-0-133" class="d">-                arrayOf(limit.toString())
</a><a href="#h68-0-134" id="h68-0-134" class="d">-            )
</a><a href="#h68-0-135" id="h68-0-135" class="d">-            val list = mutableListOf&lt;FriendFeedEntry&gt;()
</a><a href="#h68-0-136" id="h68-0-136" class="d">-            while (cursor.moveToNext()) {
</a><a href="#h68-0-137" id="h68-0-137" class="d">-                val friendFeedEntry = FriendFeedEntry()
</a><a href="#h68-0-138" id="h68-0-138" class="d">-                try {
</a><a href="#h68-0-139" id="h68-0-139" class="d">-                    friendFeedEntry.write(cursor)
</a><a href="#h68-0-140" id="h68-0-140" class="d">-                } catch (_: Throwable) {}
</a><a href="#h68-0-141" id="h68-0-141" class="d">-                list.add(friendFeedEntry)
</a><a href="#h68-0-142" id="h68-0-142" class="d">-            }
</a><a href="#h68-0-143" id="h68-0-143" class="d">-            cursor.close()
</a><a href="#h68-0-144" id="h68-0-144" class="d">-            list
</a><a href="#h68-0-145" id="h68-0-145" class="d">-        } ?: emptyList()
</a><a href="#h68-0-146" id="h68-0-146" class="d">-    }
</a><a href="#h68-0-147" id="h68-0-147" class="d">-
</a><a href="#h68-0-148" id="h68-0-148" class="d">-    fun getConversationMessageFromId(clientMessageId: Long): ConversationMessage? {
</a><a href="#h68-0-149" id="h68-0-149" class="d">-        return safeDatabaseOperation(openArroyo()) {
</a><a href="#h68-0-150" id="h68-0-150" class="d">-            readDatabaseObject(
</a><a href="#h68-0-151" id="h68-0-151" class="d">-                ConversationMessage(),
</a><a href="#h68-0-152" id="h68-0-152" class="d">-                it,
</a><a href="#h68-0-153" id="h68-0-153" class="d">-                &quot;conversation_message&quot;,
</a><a href="#h68-0-154" id="h68-0-154" class="d">-                &quot;client_message_id = ?&quot;,
</a><a href="#h68-0-155" id="h68-0-155" class="d">-                arrayOf(clientMessageId.toString())
</a><a href="#h68-0-156" id="h68-0-156" class="d">-            )
</a><a href="#h68-0-157" id="h68-0-157" class="d">-        }
</a><a href="#h68-0-158" id="h68-0-158" class="d">-    }
</a><a href="#h68-0-159" id="h68-0-159" class="d">-
</a><a href="#h68-0-160" id="h68-0-160" class="d">-    fun getConversationType(conversationId: String): Int? {
</a><a href="#h68-0-161" id="h68-0-161" class="d">-        return safeDatabaseOperation(openArroyo()) {
</a><a href="#h68-0-162" id="h68-0-162" class="d">-            val cursor = it.rawQuery(
</a><a href="#h68-0-163" id="h68-0-163" class="d">-                &quot;SELECT * FROM user_conversation WHERE client_conversation_id = ?&quot;,
</a><a href="#h68-0-164" id="h68-0-164" class="d">-                arrayOf(conversationId)
</a><a href="#h68-0-165" id="h68-0-165" class="d">-            )
</a><a href="#h68-0-166" id="h68-0-166" class="d">-            if (!cursor.moveToFirst()) {
</a><a href="#h68-0-167" id="h68-0-167" class="d">-                cursor.close()
</a><a href="#h68-0-168" id="h68-0-168" class="d">-                return@safeDatabaseOperation null
</a><a href="#h68-0-169" id="h68-0-169" class="d">-            }
</a><a href="#h68-0-170" id="h68-0-170" class="d">-            val type = cursor.getInt(cursor.getColumnIndex(&quot;conversation_type&quot;))
</a><a href="#h68-0-171" id="h68-0-171" class="d">-            cursor.close()
</a><a href="#h68-0-172" id="h68-0-172" class="d">-            type
</a><a href="#h68-0-173" id="h68-0-173" class="d">-        }
</a><a href="#h68-0-174" id="h68-0-174" class="d">-    }
</a><a href="#h68-0-175" id="h68-0-175" class="d">-
</a><a href="#h68-0-176" id="h68-0-176" class="d">-    fun getConversationLinkFromUserId(userId: String): UserConversationLink? {
</a><a href="#h68-0-177" id="h68-0-177" class="d">-        return safeDatabaseOperation(openArroyo()) {
</a><a href="#h68-0-178" id="h68-0-178" class="d">-            readDatabaseObject(
</a><a href="#h68-0-179" id="h68-0-179" class="d">-                UserConversationLink(),
</a><a href="#h68-0-180" id="h68-0-180" class="d">-                it,
</a><a href="#h68-0-181" id="h68-0-181" class="d">-                &quot;user_conversation&quot;,
</a><a href="#h68-0-182" id="h68-0-182" class="d">-                &quot;user_id = ? AND conversation_type = 0&quot;,
</a><a href="#h68-0-183" id="h68-0-183" class="d">-                arrayOf(userId)
</a><a href="#h68-0-184" id="h68-0-184" class="d">-            )
</a><a href="#h68-0-185" id="h68-0-185" class="d">-        }
</a><a href="#h68-0-186" id="h68-0-186" class="d">-    }
</a><a href="#h68-0-187" id="h68-0-187" class="d">-
</a><a href="#h68-0-188" id="h68-0-188" class="d">-    fun getDMOtherParticipant(conversationId: String): String? {
</a><a href="#h68-0-189" id="h68-0-189" class="d">-        return safeDatabaseOperation(openArroyo()) { cursor -&gt;
</a><a href="#h68-0-190" id="h68-0-190" class="d">-            val query = cursor.rawQuery(
</a><a href="#h68-0-191" id="h68-0-191" class="d">-                &quot;SELECT * FROM user_conversation WHERE client_conversation_id = ? AND conversation_type = 0&quot;,
</a><a href="#h68-0-192" id="h68-0-192" class="d">-                arrayOf(conversationId)
</a><a href="#h68-0-193" id="h68-0-193" class="d">-            )
</a><a href="#h68-0-194" id="h68-0-194" class="d">-            val participants = mutableListOf&lt;String&gt;()
</a><a href="#h68-0-195" id="h68-0-195" class="d">-            while (query.moveToNext()) {
</a><a href="#h68-0-196" id="h68-0-196" class="d">-                participants.add(query.getString(query.getColumnIndex(&quot;user_id&quot;)))
</a><a href="#h68-0-197" id="h68-0-197" class="d">-            }
</a><a href="#h68-0-198" id="h68-0-198" class="d">-            query.close()
</a><a href="#h68-0-199" id="h68-0-199" class="d">-            participants.firstOrNull { it != myUserId }
</a><a href="#h68-0-200" id="h68-0-200" class="d">-        }
</a><a href="#h68-0-201" id="h68-0-201" class="d">-    }
</a><a href="#h68-0-202" id="h68-0-202" class="d">-
</a><a href="#h68-0-203" id="h68-0-203" class="d">-
</a><a href="#h68-0-204" id="h68-0-204" class="d">-    fun getStoryEntryFromId(storyId: String): StoryEntry? {
</a><a href="#h68-0-205" id="h68-0-205" class="d">-        return safeDatabaseOperation(openMain()) {
</a><a href="#h68-0-206" id="h68-0-206" class="d">-            readDatabaseObject(StoryEntry(), it, &quot;Story&quot;, &quot;storyId = ?&quot;, arrayOf(storyId))
</a><a href="#h68-0-207" id="h68-0-207" class="d">-        }
</a><a href="#h68-0-208" id="h68-0-208" class="d">-    }
</a><a href="#h68-0-209" id="h68-0-209" class="d">-
</a><a href="#h68-0-210" id="h68-0-210" class="d">-    fun getConversationParticipants(conversationId: String): List&lt;String&gt;? {
</a><a href="#h68-0-211" id="h68-0-211" class="d">-        return safeDatabaseOperation(openArroyo()) { arroyoDatabase: SQLiteDatabase -&gt;
</a><a href="#h68-0-212" id="h68-0-212" class="d">-            val cursor = arroyoDatabase.rawQuery(
</a><a href="#h68-0-213" id="h68-0-213" class="d">-                &quot;SELECT * FROM user_conversation WHERE client_conversation_id = ?&quot;,
</a><a href="#h68-0-214" id="h68-0-214" class="d">-                arrayOf(conversationId)
</a><a href="#h68-0-215" id="h68-0-215" class="d">-            )
</a><a href="#h68-0-216" id="h68-0-216" class="d">-            if (!cursor.moveToFirst()) {
</a><a href="#h68-0-217" id="h68-0-217" class="d">-                cursor.close()
</a><a href="#h68-0-218" id="h68-0-218" class="d">-                return@safeDatabaseOperation emptyList()
</a><a href="#h68-0-219" id="h68-0-219" class="d">-            }
</a><a href="#h68-0-220" id="h68-0-220" class="d">-            val participants = mutableListOf&lt;String&gt;()
</a><a href="#h68-0-221" id="h68-0-221" class="d">-            do {
</a><a href="#h68-0-222" id="h68-0-222" class="d">-                participants.add(cursor.getString(cursor.getColumnIndex(&quot;user_id&quot;)))
</a><a href="#h68-0-223" id="h68-0-223" class="d">-            } while (cursor.moveToNext())
</a><a href="#h68-0-224" id="h68-0-224" class="d">-            cursor.close()
</a><a href="#h68-0-225" id="h68-0-225" class="d">-            participants
</a><a href="#h68-0-226" id="h68-0-226" class="d">-        }
</a><a href="#h68-0-227" id="h68-0-227" class="d">-    }
</a><a href="#h68-0-228" id="h68-0-228" class="d">-
</a><a href="#h68-0-229" id="h68-0-229" class="d">-    fun getMessagesFromConversationId(
</a><a href="#h68-0-230" id="h68-0-230" class="d">-        conversationId: String,
</a><a href="#h68-0-231" id="h68-0-231" class="d">-        limit: Int
</a><a href="#h68-0-232" id="h68-0-232" class="d">-    ): List&lt;ConversationMessage&gt;? {
</a><a href="#h68-0-233" id="h68-0-233" class="d">-        return safeDatabaseOperation(openArroyo()) { arroyoDatabase: SQLiteDatabase -&gt;
</a><a href="#h68-0-234" id="h68-0-234" class="d">-            val cursor = arroyoDatabase.rawQuery(
</a><a href="#h68-0-235" id="h68-0-235" class="d">-                &quot;SELECT * FROM conversation_message WHERE client_conversation_id = ? ORDER BY creation_timestamp DESC LIMIT ?&quot;,
</a><a href="#h68-0-236" id="h68-0-236" class="d">-                arrayOf(conversationId, limit.toString())
</a><a href="#h68-0-237" id="h68-0-237" class="d">-            )
</a><a href="#h68-0-238" id="h68-0-238" class="d">-            if (!cursor.moveToFirst()) {
</a><a href="#h68-0-239" id="h68-0-239" class="d">-                cursor.close()
</a><a href="#h68-0-240" id="h68-0-240" class="d">-                return@safeDatabaseOperation emptyList()
</a><a href="#h68-0-241" id="h68-0-241" class="d">-            }
</a><a href="#h68-0-242" id="h68-0-242" class="d">-            val messages = mutableListOf&lt;ConversationMessage&gt;()
</a><a href="#h68-0-243" id="h68-0-243" class="d">-            do {
</a><a href="#h68-0-244" id="h68-0-244" class="d">-                val message = ConversationMessage()
</a><a href="#h68-0-245" id="h68-0-245" class="d">-                message.write(cursor)
</a><a href="#h68-0-246" id="h68-0-246" class="d">-                messages.add(message)
</a><a href="#h68-0-247" id="h68-0-247" class="d">-            } while (cursor.moveToNext())
</a><a href="#h68-0-248" id="h68-0-248" class="d">-            cursor.close()
</a><a href="#h68-0-249" id="h68-0-249" class="d">-            messages
</a><a href="#h68-0-250" id="h68-0-250" class="d">-        }
</a><a href="#h68-0-251" id="h68-0-251" class="d">-    }
</a><a href="#h68-0-252" id="h68-0-252" class="d">-}</a><a href="#h68-0-253" id="h68-0-253" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h69" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/database/DatabaseObject.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/database/DatabaseObject.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/database/DatabaseObject.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/database/DatabaseObject.kt</a></b>
<a href="#h69-0" id="h69-0" class="h">@@ -1,7 +0,0 @@
</a><a href="#h69-0-0" id="h69-0-0" class="d">-package me.rhunk.snapenhance.database
</a><a href="#h69-0-1" id="h69-0-1" class="d">-
</a><a href="#h69-0-2" id="h69-0-2" class="d">-import android.database.Cursor
</a><a href="#h69-0-3" id="h69-0-3" class="d">-
</a><a href="#h69-0-4" id="h69-0-4" class="d">-interface DatabaseObject {
</a><a href="#h69-0-5" id="h69-0-5" class="d">-    fun write(cursor: Cursor)
</a><a href="#h69-0-6" id="h69-0-6" class="d">-}
</a><b>diff --git a/<a id="h70" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/database/objects/ConversationMessage.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/database/objects/ConversationMessage.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/database/objects/ConversationMessage.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/database/objects/ConversationMessage.kt</a></b>
<a href="#h70-0" id="h70-0" class="h">@@ -1,50 +0,0 @@
</a><a href="#h70-0-0" id="h70-0-0" class="d">-package me.rhunk.snapenhance.database.objects
</a><a href="#h70-0-1" id="h70-0-1" class="d">-
</a><a href="#h70-0-2" id="h70-0-2" class="d">-import android.annotation.SuppressLint
</a><a href="#h70-0-3" id="h70-0-3" class="d">-import android.database.Cursor
</a><a href="#h70-0-4" id="h70-0-4" class="d">-import me.rhunk.snapenhance.Constants
</a><a href="#h70-0-5" id="h70-0-5" class="d">-import me.rhunk.snapenhance.data.ContentType
</a><a href="#h70-0-6" id="h70-0-6" class="d">-import me.rhunk.snapenhance.database.DatabaseObject
</a><a href="#h70-0-7" id="h70-0-7" class="d">-import me.rhunk.snapenhance.util.ktx.getBlobOrNull
</a><a href="#h70-0-8" id="h70-0-8" class="d">-import me.rhunk.snapenhance.util.ktx.getInteger
</a><a href="#h70-0-9" id="h70-0-9" class="d">-import me.rhunk.snapenhance.util.ktx.getLong
</a><a href="#h70-0-10" id="h70-0-10" class="d">-import me.rhunk.snapenhance.util.ktx.getStringOrNull
</a><a href="#h70-0-11" id="h70-0-11" class="d">-import me.rhunk.snapenhance.util.protobuf.ProtoReader
</a><a href="#h70-0-12" id="h70-0-12" class="d">-
</a><a href="#h70-0-13" id="h70-0-13" class="d">-@Suppress(&quot;ArrayInDataClass&quot;)
</a><a href="#h70-0-14" id="h70-0-14" class="d">-data class ConversationMessage(
</a><a href="#h70-0-15" id="h70-0-15" class="d">-    var clientConversationId: String? = null,
</a><a href="#h70-0-16" id="h70-0-16" class="d">-    var clientMessageId: Int = 0,
</a><a href="#h70-0-17" id="h70-0-17" class="d">-    var serverMessageId: Int = 0,
</a><a href="#h70-0-18" id="h70-0-18" class="d">-    var messageContent: ByteArray? = null,
</a><a href="#h70-0-19" id="h70-0-19" class="d">-    var isSaved: Int = 0,
</a><a href="#h70-0-20" id="h70-0-20" class="d">-    var isViewedByUser: Int = 0,
</a><a href="#h70-0-21" id="h70-0-21" class="d">-    var contentType: Int = 0,
</a><a href="#h70-0-22" id="h70-0-22" class="d">-    var creationTimestamp: Long = 0,
</a><a href="#h70-0-23" id="h70-0-23" class="d">-    var readTimestamp: Long = 0,
</a><a href="#h70-0-24" id="h70-0-24" class="d">-    var senderId: String? = null
</a><a href="#h70-0-25" id="h70-0-25" class="d">-) : DatabaseObject {
</a><a href="#h70-0-26" id="h70-0-26" class="d">-
</a><a href="#h70-0-27" id="h70-0-27" class="d">-    @SuppressLint(&quot;Range&quot;)
</a><a href="#h70-0-28" id="h70-0-28" class="d">-    override fun write(cursor: Cursor) {
</a><a href="#h70-0-29" id="h70-0-29" class="d">-        with(cursor) {
</a><a href="#h70-0-30" id="h70-0-30" class="d">-            clientConversationId = getStringOrNull(&quot;client_conversation_id&quot;)
</a><a href="#h70-0-31" id="h70-0-31" class="d">-            clientMessageId = getInteger(&quot;client_message_id&quot;)
</a><a href="#h70-0-32" id="h70-0-32" class="d">-            serverMessageId = getInteger(&quot;server_message_id&quot;)
</a><a href="#h70-0-33" id="h70-0-33" class="d">-            messageContent = getBlobOrNull(&quot;message_content&quot;)
</a><a href="#h70-0-34" id="h70-0-34" class="d">-            isSaved = getInteger(&quot;is_saved&quot;)
</a><a href="#h70-0-35" id="h70-0-35" class="d">-            isViewedByUser = getInteger(&quot;is_viewed_by_user&quot;)
</a><a href="#h70-0-36" id="h70-0-36" class="d">-            contentType = getInteger(&quot;content_type&quot;)
</a><a href="#h70-0-37" id="h70-0-37" class="d">-            creationTimestamp = getLong(&quot;creation_timestamp&quot;)
</a><a href="#h70-0-38" id="h70-0-38" class="d">-            readTimestamp = getLong(&quot;read_timestamp&quot;)
</a><a href="#h70-0-39" id="h70-0-39" class="d">-            senderId = getStringOrNull(&quot;sender_id&quot;)
</a><a href="#h70-0-40" id="h70-0-40" class="d">-        }
</a><a href="#h70-0-41" id="h70-0-41" class="d">-    }
</a><a href="#h70-0-42" id="h70-0-42" class="d">-
</a><a href="#h70-0-43" id="h70-0-43" class="d">-    fun getMessageAsString(): String? {
</a><a href="#h70-0-44" id="h70-0-44" class="d">-        return when (ContentType.fromId(contentType)) {
</a><a href="#h70-0-45" id="h70-0-45" class="d">-            ContentType.CHAT -&gt; messageContent?.let { ProtoReader(it).getString(*Constants.ARROYO_STRING_CHAT_MESSAGE_PROTO) }
</a><a href="#h70-0-46" id="h70-0-46" class="d">-            else -&gt; null
</a><a href="#h70-0-47" id="h70-0-47" class="d">-        }
</a><a href="#h70-0-48" id="h70-0-48" class="d">-    }
</a><a href="#h70-0-49" id="h70-0-49" class="d">-}
</a><b>diff --git a/<a id="h71" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/database/objects/FriendFeedEntry.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/database/objects/FriendFeedEntry.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/database/objects/FriendFeedEntry.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/database/objects/FriendFeedEntry.kt</a></b>
<a href="#h71-0" id="h71-0" class="h">@@ -1,47 +0,0 @@
</a><a href="#h71-0-0" id="h71-0-0" class="d">-package me.rhunk.snapenhance.database.objects
</a><a href="#h71-0-1" id="h71-0-1" class="d">-
</a><a href="#h71-0-2" id="h71-0-2" class="d">-import android.annotation.SuppressLint
</a><a href="#h71-0-3" id="h71-0-3" class="d">-import android.database.Cursor
</a><a href="#h71-0-4" id="h71-0-4" class="d">-import me.rhunk.snapenhance.database.DatabaseObject
</a><a href="#h71-0-5" id="h71-0-5" class="d">-import me.rhunk.snapenhance.util.ktx.getIntOrNull
</a><a href="#h71-0-6" id="h71-0-6" class="d">-import me.rhunk.snapenhance.util.ktx.getInteger
</a><a href="#h71-0-7" id="h71-0-7" class="d">-import me.rhunk.snapenhance.util.ktx.getLong
</a><a href="#h71-0-8" id="h71-0-8" class="d">-import me.rhunk.snapenhance.util.ktx.getStringOrNull
</a><a href="#h71-0-9" id="h71-0-9" class="d">-
</a><a href="#h71-0-10" id="h71-0-10" class="d">-data class FriendFeedEntry(
</a><a href="#h71-0-11" id="h71-0-11" class="d">-    var id: Int = 0,
</a><a href="#h71-0-12" id="h71-0-12" class="d">-    var feedDisplayName: String? = null,
</a><a href="#h71-0-13" id="h71-0-13" class="d">-    var participantsSize: Int = 0,
</a><a href="#h71-0-14" id="h71-0-14" class="d">-    var lastInteractionTimestamp: Long = 0,
</a><a href="#h71-0-15" id="h71-0-15" class="d">-    var displayTimestamp: Long = 0,
</a><a href="#h71-0-16" id="h71-0-16" class="d">-    var displayInteractionType: String? = null,
</a><a href="#h71-0-17" id="h71-0-17" class="d">-    var lastInteractionUserId: Int? = null,
</a><a href="#h71-0-18" id="h71-0-18" class="d">-    var key: String? = null,
</a><a href="#h71-0-19" id="h71-0-19" class="d">-    var friendUserId: String? = null,
</a><a href="#h71-0-20" id="h71-0-20" class="d">-    var friendDisplayName: String? = null,
</a><a href="#h71-0-21" id="h71-0-21" class="d">-    var friendDisplayUsername: String? = null,
</a><a href="#h71-0-22" id="h71-0-22" class="d">-    var friendLinkType: Int? = null,
</a><a href="#h71-0-23" id="h71-0-23" class="d">-    var bitmojiAvatarId: String? = null,
</a><a href="#h71-0-24" id="h71-0-24" class="d">-    var bitmojiSelfieId: String? = null,
</a><a href="#h71-0-25" id="h71-0-25" class="d">-) : DatabaseObject {
</a><a href="#h71-0-26" id="h71-0-26" class="d">-
</a><a href="#h71-0-27" id="h71-0-27" class="d">-    @SuppressLint(&quot;Range&quot;)
</a><a href="#h71-0-28" id="h71-0-28" class="d">-    override fun write(cursor: Cursor) {
</a><a href="#h71-0-29" id="h71-0-29" class="d">-        with(cursor) {
</a><a href="#h71-0-30" id="h71-0-30" class="d">-            id = getInteger(&quot;_id&quot;)
</a><a href="#h71-0-31" id="h71-0-31" class="d">-            feedDisplayName = getStringOrNull(&quot;feedDisplayName&quot;)
</a><a href="#h71-0-32" id="h71-0-32" class="d">-            participantsSize = getInteger(&quot;participantsSize&quot;)
</a><a href="#h71-0-33" id="h71-0-33" class="d">-            lastInteractionTimestamp = getLong(&quot;lastInteractionTimestamp&quot;)
</a><a href="#h71-0-34" id="h71-0-34" class="d">-            displayTimestamp = getLong(&quot;displayTimestamp&quot;)
</a><a href="#h71-0-35" id="h71-0-35" class="d">-            displayInteractionType = getStringOrNull(&quot;displayInteractionType&quot;)
</a><a href="#h71-0-36" id="h71-0-36" class="d">-            lastInteractionUserId = getIntOrNull(&quot;lastInteractionUserId&quot;)
</a><a href="#h71-0-37" id="h71-0-37" class="d">-            key = getStringOrNull(&quot;key&quot;)
</a><a href="#h71-0-38" id="h71-0-38" class="d">-            friendUserId = getStringOrNull(&quot;friendUserId&quot;)
</a><a href="#h71-0-39" id="h71-0-39" class="d">-            friendDisplayName = getStringOrNull(&quot;friendDisplayName&quot;)
</a><a href="#h71-0-40" id="h71-0-40" class="d">-            friendDisplayUsername = getStringOrNull(&quot;friendDisplayUsername&quot;)
</a><a href="#h71-0-41" id="h71-0-41" class="d">-            friendLinkType = getIntOrNull(&quot;friendLinkType&quot;)
</a><a href="#h71-0-42" id="h71-0-42" class="d">-            bitmojiAvatarId = getStringOrNull(&quot;bitmojiAvatarId&quot;)
</a><a href="#h71-0-43" id="h71-0-43" class="d">-            bitmojiSelfieId = getStringOrNull(&quot;bitmojiSelfieId&quot;)
</a><a href="#h71-0-44" id="h71-0-44" class="d">-        }
</a><a href="#h71-0-45" id="h71-0-45" class="d">-    }
</a><a href="#h71-0-46" id="h71-0-46" class="d">-}
</a><b>diff --git a/<a id="h72" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/database/objects/FriendInfo.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/database/objects/FriendInfo.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/database/objects/FriendInfo.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/database/objects/FriendInfo.kt</a></b>
<a href="#h72-0" id="h72-0" class="h">@@ -1,64 +0,0 @@
</a><a href="#h72-0-0" id="h72-0-0" class="d">-package me.rhunk.snapenhance.database.objects
</a><a href="#h72-0-1" id="h72-0-1" class="d">-
</a><a href="#h72-0-2" id="h72-0-2" class="d">-import android.annotation.SuppressLint
</a><a href="#h72-0-3" id="h72-0-3" class="d">-import android.database.Cursor
</a><a href="#h72-0-4" id="h72-0-4" class="d">-import me.rhunk.snapenhance.database.DatabaseObject
</a><a href="#h72-0-5" id="h72-0-5" class="d">-import me.rhunk.snapenhance.util.SerializableDataObject
</a><a href="#h72-0-6" id="h72-0-6" class="d">-import me.rhunk.snapenhance.util.ktx.getInteger
</a><a href="#h72-0-7" id="h72-0-7" class="d">-import me.rhunk.snapenhance.util.ktx.getLong
</a><a href="#h72-0-8" id="h72-0-8" class="d">-import me.rhunk.snapenhance.util.ktx.getStringOrNull
</a><a href="#h72-0-9" id="h72-0-9" class="d">-
</a><a href="#h72-0-10" id="h72-0-10" class="d">-data class FriendInfo(
</a><a href="#h72-0-11" id="h72-0-11" class="d">-    var id: Int = 0,
</a><a href="#h72-0-12" id="h72-0-12" class="d">-    var lastModifiedTimestamp: Long = 0,
</a><a href="#h72-0-13" id="h72-0-13" class="d">-    var username: String? = null,
</a><a href="#h72-0-14" id="h72-0-14" class="d">-    var userId: String? = null,
</a><a href="#h72-0-15" id="h72-0-15" class="d">-    var displayName: String? = null,
</a><a href="#h72-0-16" id="h72-0-16" class="d">-    var bitmojiAvatarId: String? = null,
</a><a href="#h72-0-17" id="h72-0-17" class="d">-    var bitmojiSelfieId: String? = null,
</a><a href="#h72-0-18" id="h72-0-18" class="d">-    var bitmojiSceneId: String? = null,
</a><a href="#h72-0-19" id="h72-0-19" class="d">-    var bitmojiBackgroundId: String? = null,
</a><a href="#h72-0-20" id="h72-0-20" class="d">-    var friendmojis: String? = null,
</a><a href="#h72-0-21" id="h72-0-21" class="d">-    var friendmojiCategories: String? = null,
</a><a href="#h72-0-22" id="h72-0-22" class="d">-    var snapScore: Int = 0,
</a><a href="#h72-0-23" id="h72-0-23" class="d">-    var birthday: Long = 0,
</a><a href="#h72-0-24" id="h72-0-24" class="d">-    var addedTimestamp: Long = 0,
</a><a href="#h72-0-25" id="h72-0-25" class="d">-    var reverseAddedTimestamp: Long = 0,
</a><a href="#h72-0-26" id="h72-0-26" class="d">-    var serverDisplayName: String? = null,
</a><a href="#h72-0-27" id="h72-0-27" class="d">-    var streakLength: Int = 0,
</a><a href="#h72-0-28" id="h72-0-28" class="d">-    var streakExpirationTimestamp: Long = 0,
</a><a href="#h72-0-29" id="h72-0-29" class="d">-    var reverseBestFriendRanking: Int = 0,
</a><a href="#h72-0-30" id="h72-0-30" class="d">-    var isPinnedBestFriend: Int = 0,
</a><a href="#h72-0-31" id="h72-0-31" class="d">-    var plusBadgeVisibility: Int = 0,
</a><a href="#h72-0-32" id="h72-0-32" class="d">-    var usernameForSorting: String? = null
</a><a href="#h72-0-33" id="h72-0-33" class="d">-) : DatabaseObject, SerializableDataObject() {
</a><a href="#h72-0-34" id="h72-0-34" class="d">-    @SuppressLint(&quot;Range&quot;)
</a><a href="#h72-0-35" id="h72-0-35" class="d">-    override fun write(cursor: Cursor) {
</a><a href="#h72-0-36" id="h72-0-36" class="d">-        with(cursor) {
</a><a href="#h72-0-37" id="h72-0-37" class="d">-            id = getInteger(&quot;_id&quot;)
</a><a href="#h72-0-38" id="h72-0-38" class="d">-            lastModifiedTimestamp = getLong(&quot;_lastModifiedTimestamp&quot;)
</a><a href="#h72-0-39" id="h72-0-39" class="d">-            username = getStringOrNull(&quot;username&quot;)
</a><a href="#h72-0-40" id="h72-0-40" class="d">-            userId = getStringOrNull(&quot;userId&quot;)
</a><a href="#h72-0-41" id="h72-0-41" class="d">-            displayName = getStringOrNull(&quot;displayName&quot;)
</a><a href="#h72-0-42" id="h72-0-42" class="d">-            bitmojiAvatarId = getStringOrNull(&quot;bitmojiAvatarId&quot;)
</a><a href="#h72-0-43" id="h72-0-43" class="d">-            bitmojiSelfieId = getStringOrNull(&quot;bitmojiSelfieId&quot;)
</a><a href="#h72-0-44" id="h72-0-44" class="d">-            bitmojiSceneId = getStringOrNull(&quot;bitmojiSceneId&quot;)
</a><a href="#h72-0-45" id="h72-0-45" class="d">-            bitmojiBackgroundId = getStringOrNull(&quot;bitmojiBackgroundId&quot;)
</a><a href="#h72-0-46" id="h72-0-46" class="d">-            friendmojis = getStringOrNull(&quot;friendmojis&quot;)
</a><a href="#h72-0-47" id="h72-0-47" class="d">-            friendmojiCategories = getStringOrNull(&quot;friendmojiCategories&quot;)
</a><a href="#h72-0-48" id="h72-0-48" class="d">-            snapScore = getInteger(&quot;score&quot;)
</a><a href="#h72-0-49" id="h72-0-49" class="d">-            birthday = getLong(&quot;birthday&quot;)
</a><a href="#h72-0-50" id="h72-0-50" class="d">-            addedTimestamp = getLong(&quot;addedTimestamp&quot;)
</a><a href="#h72-0-51" id="h72-0-51" class="d">-            reverseAddedTimestamp = getLong(&quot;reverseAddedTimestamp&quot;)
</a><a href="#h72-0-52" id="h72-0-52" class="d">-            serverDisplayName = getStringOrNull(&quot;serverDisplayName&quot;)
</a><a href="#h72-0-53" id="h72-0-53" class="d">-            streakLength = getInteger(&quot;streakLength&quot;)
</a><a href="#h72-0-54" id="h72-0-54" class="d">-            streakExpirationTimestamp = getLong(&quot;streakExpiration&quot;)
</a><a href="#h72-0-55" id="h72-0-55" class="d">-            reverseBestFriendRanking = getInteger(&quot;reverseBestFriendRanking&quot;)
</a><a href="#h72-0-56" id="h72-0-56" class="d">-            usernameForSorting = getStringOrNull(&quot;usernameForSorting&quot;)
</a><a href="#h72-0-57" id="h72-0-57" class="d">-            if (getColumnIndex(&quot;isPinnedBestFriend&quot;) != -1) isPinnedBestFriend =
</a><a href="#h72-0-58" id="h72-0-58" class="d">-                getInteger(&quot;isPinnedBestFriend&quot;)
</a><a href="#h72-0-59" id="h72-0-59" class="d">-            if (getColumnIndex(&quot;plusBadgeVisibility&quot;) != -1) plusBadgeVisibility =
</a><a href="#h72-0-60" id="h72-0-60" class="d">-                getInteger(&quot;plusBadgeVisibility&quot;)
</a><a href="#h72-0-61" id="h72-0-61" class="d">-        }
</a><a href="#h72-0-62" id="h72-0-62" class="d">-    }
</a><a href="#h72-0-63" id="h72-0-63" class="d">-}
</a><b>diff --git a/<a id="h73" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/database/objects/StoryEntry.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/database/objects/StoryEntry.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/database/objects/StoryEntry.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/database/objects/StoryEntry.kt</a></b>
<a href="#h73-0" id="h73-0" class="h">@@ -1,27 +0,0 @@
</a><a href="#h73-0-0" id="h73-0-0" class="d">-package me.rhunk.snapenhance.database.objects
</a><a href="#h73-0-1" id="h73-0-1" class="d">-
</a><a href="#h73-0-2" id="h73-0-2" class="d">-import android.annotation.SuppressLint
</a><a href="#h73-0-3" id="h73-0-3" class="d">-import android.database.Cursor
</a><a href="#h73-0-4" id="h73-0-4" class="d">-import me.rhunk.snapenhance.database.DatabaseObject
</a><a href="#h73-0-5" id="h73-0-5" class="d">-import me.rhunk.snapenhance.util.ktx.getInteger
</a><a href="#h73-0-6" id="h73-0-6" class="d">-import me.rhunk.snapenhance.util.ktx.getStringOrNull
</a><a href="#h73-0-7" id="h73-0-7" class="d">-
</a><a href="#h73-0-8" id="h73-0-8" class="d">-data class StoryEntry(
</a><a href="#h73-0-9" id="h73-0-9" class="d">-    var id: Int = 0,
</a><a href="#h73-0-10" id="h73-0-10" class="d">-    var storyId: String? = null,
</a><a href="#h73-0-11" id="h73-0-11" class="d">-    var displayName: String? = null,
</a><a href="#h73-0-12" id="h73-0-12" class="d">-    var isLocal: Boolean? = null,
</a><a href="#h73-0-13" id="h73-0-13" class="d">-    var userId: String? = null
</a><a href="#h73-0-14" id="h73-0-14" class="d">-) : DatabaseObject {
</a><a href="#h73-0-15" id="h73-0-15" class="d">-
</a><a href="#h73-0-16" id="h73-0-16" class="d">-    @SuppressLint(&quot;Range&quot;)
</a><a href="#h73-0-17" id="h73-0-17" class="d">-    override fun write(cursor: Cursor) {
</a><a href="#h73-0-18" id="h73-0-18" class="d">-        with(cursor) {
</a><a href="#h73-0-19" id="h73-0-19" class="d">-            id = getInteger(&quot;_id&quot;)
</a><a href="#h73-0-20" id="h73-0-20" class="d">-            storyId = getStringOrNull(&quot;storyId&quot;)
</a><a href="#h73-0-21" id="h73-0-21" class="d">-            displayName = getStringOrNull(&quot;displayName&quot;)
</a><a href="#h73-0-22" id="h73-0-22" class="d">-            isLocal = getInteger(&quot;isLocal&quot;) == 1
</a><a href="#h73-0-23" id="h73-0-23" class="d">-            userId = getStringOrNull(&quot;userId&quot;)
</a><a href="#h73-0-24" id="h73-0-24" class="d">-        }
</a><a href="#h73-0-25" id="h73-0-25" class="d">-    }
</a><a href="#h73-0-26" id="h73-0-26" class="d">-}
</a><b>diff --git a/<a id="h74" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/database/objects/UserConversationLink.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/database/objects/UserConversationLink.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/database/objects/UserConversationLink.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/database/objects/UserConversationLink.kt</a></b>
<a href="#h74-0" id="h74-0" class="h">@@ -1,23 +0,0 @@
</a><a href="#h74-0-0" id="h74-0-0" class="d">-package me.rhunk.snapenhance.database.objects
</a><a href="#h74-0-1" id="h74-0-1" class="d">-
</a><a href="#h74-0-2" id="h74-0-2" class="d">-import android.annotation.SuppressLint
</a><a href="#h74-0-3" id="h74-0-3" class="d">-import android.database.Cursor
</a><a href="#h74-0-4" id="h74-0-4" class="d">-import me.rhunk.snapenhance.database.DatabaseObject
</a><a href="#h74-0-5" id="h74-0-5" class="d">-import me.rhunk.snapenhance.util.ktx.getInteger
</a><a href="#h74-0-6" id="h74-0-6" class="d">-import me.rhunk.snapenhance.util.ktx.getStringOrNull
</a><a href="#h74-0-7" id="h74-0-7" class="d">-
</a><a href="#h74-0-8" id="h74-0-8" class="d">-class UserConversationLink(
</a><a href="#h74-0-9" id="h74-0-9" class="d">-    var userId: String? = null,
</a><a href="#h74-0-10" id="h74-0-10" class="d">-    var clientConversationId: String? = null,
</a><a href="#h74-0-11" id="h74-0-11" class="d">-    var conversationType: Int = 0
</a><a href="#h74-0-12" id="h74-0-12" class="d">-) : DatabaseObject {
</a><a href="#h74-0-13" id="h74-0-13" class="d">-
</a><a href="#h74-0-14" id="h74-0-14" class="d">-    @SuppressLint(&quot;Range&quot;)
</a><a href="#h74-0-15" id="h74-0-15" class="d">-    override fun write(cursor: Cursor) {
</a><a href="#h74-0-16" id="h74-0-16" class="d">-        with(cursor) {
</a><a href="#h74-0-17" id="h74-0-17" class="d">-            userId = getStringOrNull(&quot;user_id&quot;)
</a><a href="#h74-0-18" id="h74-0-18" class="d">-            clientConversationId = getStringOrNull(&quot;client_conversation_id&quot;)
</a><a href="#h74-0-19" id="h74-0-19" class="d">-            conversationType = getInteger(&quot;conversation_type&quot;)
</a><a href="#h74-0-20" id="h74-0-20" class="d">-        }
</a><a href="#h74-0-21" id="h74-0-21" class="d">-    }
</a><a href="#h74-0-22" id="h74-0-22" class="d">-}
</a><b>diff --git a/<a id="h75" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/download/DownloadManagerClient.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/download/DownloadManagerClient.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/download/DownloadManagerClient.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/download/DownloadManagerClient.kt</a></b>
<a href="#h75-0" id="h75-0" class="h">@@ -1,69 +0,0 @@
</a><a href="#h75-0-0" id="h75-0-0" class="d">-package me.rhunk.snapenhance.download
</a><a href="#h75-0-1" id="h75-0-1" class="d">-
</a><a href="#h75-0-2" id="h75-0-2" class="d">-import android.content.Intent
</a><a href="#h75-0-3" id="h75-0-3" class="d">-import android.os.Bundle
</a><a href="#h75-0-4" id="h75-0-4" class="d">-import me.rhunk.snapenhance.ModContext
</a><a href="#h75-0-5" id="h75-0-5" class="d">-import me.rhunk.snapenhance.bridge.DownloadCallback
</a><a href="#h75-0-6" id="h75-0-6" class="d">-import me.rhunk.snapenhance.download.data.DashOptions
</a><a href="#h75-0-7" id="h75-0-7" class="d">-import me.rhunk.snapenhance.download.data.DownloadMediaType
</a><a href="#h75-0-8" id="h75-0-8" class="d">-import me.rhunk.snapenhance.download.data.DownloadMetadata
</a><a href="#h75-0-9" id="h75-0-9" class="d">-import me.rhunk.snapenhance.download.data.DownloadRequest
</a><a href="#h75-0-10" id="h75-0-10" class="d">-import me.rhunk.snapenhance.download.data.InputMedia
</a><a href="#h75-0-11" id="h75-0-11" class="d">-import me.rhunk.snapenhance.download.data.MediaEncryptionKeyPair
</a><a href="#h75-0-12" id="h75-0-12" class="d">-
</a><a href="#h75-0-13" id="h75-0-13" class="d">-class DownloadManagerClient (
</a><a href="#h75-0-14" id="h75-0-14" class="d">-    private val context: ModContext,
</a><a href="#h75-0-15" id="h75-0-15" class="d">-    private val metadata: DownloadMetadata,
</a><a href="#h75-0-16" id="h75-0-16" class="d">-    private val callback: DownloadCallback
</a><a href="#h75-0-17" id="h75-0-17" class="d">-) {
</a><a href="#h75-0-18" id="h75-0-18" class="d">-    companion object {
</a><a href="#h75-0-19" id="h75-0-19" class="d">-        const val DOWNLOAD_REQUEST_EXTRA = &quot;request&quot;
</a><a href="#h75-0-20" id="h75-0-20" class="d">-        const val DOWNLOAD_METADATA_EXTRA = &quot;metadata&quot;
</a><a href="#h75-0-21" id="h75-0-21" class="d">-    }
</a><a href="#h75-0-22" id="h75-0-22" class="d">-
</a><a href="#h75-0-23" id="h75-0-23" class="d">-    private fun enqueueDownloadRequest(request: DownloadRequest) {
</a><a href="#h75-0-24" id="h75-0-24" class="d">-        context.bridgeClient.enqueueDownload(Intent().apply {
</a><a href="#h75-0-25" id="h75-0-25" class="d">-            putExtras(Bundle().apply {
</a><a href="#h75-0-26" id="h75-0-26" class="d">-                putString(DOWNLOAD_REQUEST_EXTRA, context.gson.toJson(request))
</a><a href="#h75-0-27" id="h75-0-27" class="d">-                putString(DOWNLOAD_METADATA_EXTRA, context.gson.toJson(metadata))
</a><a href="#h75-0-28" id="h75-0-28" class="d">-            })
</a><a href="#h75-0-29" id="h75-0-29" class="d">-        }, callback)
</a><a href="#h75-0-30" id="h75-0-30" class="d">-    }
</a><a href="#h75-0-31" id="h75-0-31" class="d">-
</a><a href="#h75-0-32" id="h75-0-32" class="d">-    fun downloadDashMedia(playlistUrl: String, offsetTime: Long, duration: Long?) {
</a><a href="#h75-0-33" id="h75-0-33" class="d">-        enqueueDownloadRequest(
</a><a href="#h75-0-34" id="h75-0-34" class="d">-            DownloadRequest(
</a><a href="#h75-0-35" id="h75-0-35" class="d">-                inputMedias = arrayOf(InputMedia(
</a><a href="#h75-0-36" id="h75-0-36" class="d">-                    content = playlistUrl,
</a><a href="#h75-0-37" id="h75-0-37" class="d">-                    type = DownloadMediaType.REMOTE_MEDIA
</a><a href="#h75-0-38" id="h75-0-38" class="d">-                )),
</a><a href="#h75-0-39" id="h75-0-39" class="d">-                dashOptions = DashOptions(offsetTime, duration),
</a><a href="#h75-0-40" id="h75-0-40" class="d">-                flags = DownloadRequest.Flags.IS_DASH_PLAYLIST
</a><a href="#h75-0-41" id="h75-0-41" class="d">-            )
</a><a href="#h75-0-42" id="h75-0-42" class="d">-        )
</a><a href="#h75-0-43" id="h75-0-43" class="d">-    }
</a><a href="#h75-0-44" id="h75-0-44" class="d">-
</a><a href="#h75-0-45" id="h75-0-45" class="d">-    fun downloadSingleMedia(mediaData: String, mediaType: DownloadMediaType, encryption: MediaEncryptionKeyPair? = null) {
</a><a href="#h75-0-46" id="h75-0-46" class="d">-        enqueueDownloadRequest(
</a><a href="#h75-0-47" id="h75-0-47" class="d">-            DownloadRequest(
</a><a href="#h75-0-48" id="h75-0-48" class="d">-                inputMedias = arrayOf(InputMedia(
</a><a href="#h75-0-49" id="h75-0-49" class="d">-                    content = mediaData,
</a><a href="#h75-0-50" id="h75-0-50" class="d">-                    type = mediaType,
</a><a href="#h75-0-51" id="h75-0-51" class="d">-                    encryption = encryption
</a><a href="#h75-0-52" id="h75-0-52" class="d">-                ))
</a><a href="#h75-0-53" id="h75-0-53" class="d">-            )
</a><a href="#h75-0-54" id="h75-0-54" class="d">-        )
</a><a href="#h75-0-55" id="h75-0-55" class="d">-    }
</a><a href="#h75-0-56" id="h75-0-56" class="d">-
</a><a href="#h75-0-57" id="h75-0-57" class="d">-    fun downloadMediaWithOverlay(
</a><a href="#h75-0-58" id="h75-0-58" class="d">-        original: InputMedia,
</a><a href="#h75-0-59" id="h75-0-59" class="d">-        overlay: InputMedia,
</a><a href="#h75-0-60" id="h75-0-60" class="d">-    ) {
</a><a href="#h75-0-61" id="h75-0-61" class="d">-        enqueueDownloadRequest(
</a><a href="#h75-0-62" id="h75-0-62" class="d">-            DownloadRequest(
</a><a href="#h75-0-63" id="h75-0-63" class="d">-                inputMedias = arrayOf(original, overlay),
</a><a href="#h75-0-64" id="h75-0-64" class="d">-                flags = DownloadRequest.Flags.MERGE_OVERLAY
</a><a href="#h75-0-65" id="h75-0-65" class="d">-            )
</a><a href="#h75-0-66" id="h75-0-66" class="d">-        )
</a><a href="#h75-0-67" id="h75-0-67" class="d">-    }
</a><a href="#h75-0-68" id="h75-0-68" class="d">-}</a><a href="#h75-0-69" id="h75-0-69" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h76" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/download/DownloadTaskManager.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/download/DownloadTaskManager.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/download/DownloadTaskManager.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/download/DownloadTaskManager.kt</a></b>
<a href="#h76-0" id="h76-0" class="h">@@ -1,182 +0,0 @@
</a><a href="#h76-0-0" id="h76-0-0" class="d">-package me.rhunk.snapenhance.download
</a><a href="#h76-0-1" id="h76-0-1" class="d">-
</a><a href="#h76-0-2" id="h76-0-2" class="d">-import android.annotation.SuppressLint
</a><a href="#h76-0-3" id="h76-0-3" class="d">-import android.content.Context
</a><a href="#h76-0-4" id="h76-0-4" class="d">-import android.database.sqlite.SQLiteDatabase
</a><a href="#h76-0-5" id="h76-0-5" class="d">-import me.rhunk.snapenhance.download.data.DownloadMetadata
</a><a href="#h76-0-6" id="h76-0-6" class="d">-import me.rhunk.snapenhance.download.data.DownloadObject
</a><a href="#h76-0-7" id="h76-0-7" class="d">-import me.rhunk.snapenhance.download.data.DownloadStage
</a><a href="#h76-0-8" id="h76-0-8" class="d">-import me.rhunk.snapenhance.download.data.MediaFilter
</a><a href="#h76-0-9" id="h76-0-9" class="d">-import me.rhunk.snapenhance.util.SQLiteDatabaseHelper
</a><a href="#h76-0-10" id="h76-0-10" class="d">-import me.rhunk.snapenhance.util.ktx.getIntOrNull
</a><a href="#h76-0-11" id="h76-0-11" class="d">-import me.rhunk.snapenhance.util.ktx.getStringOrNull
</a><a href="#h76-0-12" id="h76-0-12" class="d">-
</a><a href="#h76-0-13" id="h76-0-13" class="d">-class DownloadTaskManager {
</a><a href="#h76-0-14" id="h76-0-14" class="d">-    private lateinit var taskDatabase: SQLiteDatabase
</a><a href="#h76-0-15" id="h76-0-15" class="d">-    private val pendingTasks = mutableMapOf&lt;Int, DownloadObject&gt;()
</a><a href="#h76-0-16" id="h76-0-16" class="d">-    private val cachedTasks = mutableMapOf&lt;Int, DownloadObject&gt;()
</a><a href="#h76-0-17" id="h76-0-17" class="d">-
</a><a href="#h76-0-18" id="h76-0-18" class="d">-    @SuppressLint(&quot;Range&quot;)
</a><a href="#h76-0-19" id="h76-0-19" class="d">-    fun init(context: Context) {
</a><a href="#h76-0-20" id="h76-0-20" class="d">-        if (this::taskDatabase.isInitialized) return
</a><a href="#h76-0-21" id="h76-0-21" class="d">-        taskDatabase = context.openOrCreateDatabase(&quot;download_tasks&quot;, Context.MODE_PRIVATE, null).apply {
</a><a href="#h76-0-22" id="h76-0-22" class="d">-            SQLiteDatabaseHelper.createTablesFromSchema(this, mapOf(
</a><a href="#h76-0-23" id="h76-0-23" class="d">-                &quot;tasks&quot; to listOf(
</a><a href="#h76-0-24" id="h76-0-24" class="d">-                    &quot;id INTEGER PRIMARY KEY AUTOINCREMENT&quot;,
</a><a href="#h76-0-25" id="h76-0-25" class="d">-                    &quot;hash VARCHAR UNIQUE&quot;,
</a><a href="#h76-0-26" id="h76-0-26" class="d">-                    &quot;outputPath TEXT&quot;,
</a><a href="#h76-0-27" id="h76-0-27" class="d">-                    &quot;outputFile TEXT&quot;,
</a><a href="#h76-0-28" id="h76-0-28" class="d">-                    &quot;mediaDisplayType TEXT&quot;,
</a><a href="#h76-0-29" id="h76-0-29" class="d">-                    &quot;mediaDisplaySource TEXT&quot;,
</a><a href="#h76-0-30" id="h76-0-30" class="d">-                    &quot;iconUrl TEXT&quot;,
</a><a href="#h76-0-31" id="h76-0-31" class="d">-                    &quot;downloadStage TEXT&quot;
</a><a href="#h76-0-32" id="h76-0-32" class="d">-                )
</a><a href="#h76-0-33" id="h76-0-33" class="d">-            ))
</a><a href="#h76-0-34" id="h76-0-34" class="d">-        }
</a><a href="#h76-0-35" id="h76-0-35" class="d">-    }
</a><a href="#h76-0-36" id="h76-0-36" class="d">-
</a><a href="#h76-0-37" id="h76-0-37" class="d">-    fun addTask(task: DownloadObject): Int {
</a><a href="#h76-0-38" id="h76-0-38" class="d">-        taskDatabase.execSQL(&quot;INSERT INTO tasks (hash, outputPath, outputFile, mediaDisplayType, mediaDisplaySource, iconUrl, downloadStage) VALUES (?, ?, ?, ?, ?, ?, ?)&quot;,
</a><a href="#h76-0-39" id="h76-0-39" class="d">-            arrayOf(
</a><a href="#h76-0-40" id="h76-0-40" class="d">-                task.metadata.mediaIdentifier,
</a><a href="#h76-0-41" id="h76-0-41" class="d">-                task.metadata.outputPath,
</a><a href="#h76-0-42" id="h76-0-42" class="d">-                task.outputFile,
</a><a href="#h76-0-43" id="h76-0-43" class="d">-                task.metadata.mediaDisplayType,
</a><a href="#h76-0-44" id="h76-0-44" class="d">-                task.metadata.mediaDisplaySource,
</a><a href="#h76-0-45" id="h76-0-45" class="d">-                task.metadata.iconUrl,
</a><a href="#h76-0-46" id="h76-0-46" class="d">-                task.downloadStage.name
</a><a href="#h76-0-47" id="h76-0-47" class="d">-            )
</a><a href="#h76-0-48" id="h76-0-48" class="d">-        )
</a><a href="#h76-0-49" id="h76-0-49" class="d">-        task.downloadId = taskDatabase.rawQuery(&quot;SELECT last_insert_rowid()&quot;, null).use {
</a><a href="#h76-0-50" id="h76-0-50" class="d">-            it.moveToFirst()
</a><a href="#h76-0-51" id="h76-0-51" class="d">-            it.getInt(0)
</a><a href="#h76-0-52" id="h76-0-52" class="d">-        }
</a><a href="#h76-0-53" id="h76-0-53" class="d">-        pendingTasks[task.downloadId] = task
</a><a href="#h76-0-54" id="h76-0-54" class="d">-        return task.downloadId
</a><a href="#h76-0-55" id="h76-0-55" class="d">-    }
</a><a href="#h76-0-56" id="h76-0-56" class="d">-
</a><a href="#h76-0-57" id="h76-0-57" class="d">-    fun updateTask(task: DownloadObject) {
</a><a href="#h76-0-58" id="h76-0-58" class="d">-        taskDatabase.execSQL(&quot;UPDATE tasks SET hash = ?, outputPath = ?, outputFile = ?, mediaDisplayType = ?, mediaDisplaySource = ?, iconUrl = ?, downloadStage = ? WHERE id = ?&quot;,
</a><a href="#h76-0-59" id="h76-0-59" class="d">-            arrayOf(
</a><a href="#h76-0-60" id="h76-0-60" class="d">-                task.metadata.mediaIdentifier,
</a><a href="#h76-0-61" id="h76-0-61" class="d">-                task.metadata.outputPath,
</a><a href="#h76-0-62" id="h76-0-62" class="d">-                task.outputFile,
</a><a href="#h76-0-63" id="h76-0-63" class="d">-                task.metadata.mediaDisplayType,
</a><a href="#h76-0-64" id="h76-0-64" class="d">-                task.metadata.mediaDisplaySource,
</a><a href="#h76-0-65" id="h76-0-65" class="d">-                task.metadata.iconUrl,
</a><a href="#h76-0-66" id="h76-0-66" class="d">-                task.downloadStage.name,
</a><a href="#h76-0-67" id="h76-0-67" class="d">-                task.downloadId
</a><a href="#h76-0-68" id="h76-0-68" class="d">-            )
</a><a href="#h76-0-69" id="h76-0-69" class="d">-        )
</a><a href="#h76-0-70" id="h76-0-70" class="d">-        //if the task is no longer active, move it to the cached tasks
</a><a href="#h76-0-71" id="h76-0-71" class="d">-        if (task.isJobActive()) {
</a><a href="#h76-0-72" id="h76-0-72" class="d">-            pendingTasks[task.downloadId] = task
</a><a href="#h76-0-73" id="h76-0-73" class="d">-        } else {
</a><a href="#h76-0-74" id="h76-0-74" class="d">-            pendingTasks.remove(task.downloadId)
</a><a href="#h76-0-75" id="h76-0-75" class="d">-            cachedTasks[task.downloadId] = task
</a><a href="#h76-0-76" id="h76-0-76" class="d">-        }
</a><a href="#h76-0-77" id="h76-0-77" class="d">-    }
</a><a href="#h76-0-78" id="h76-0-78" class="d">-
</a><a href="#h76-0-79" id="h76-0-79" class="d">-    @SuppressLint(&quot;Range&quot;)
</a><a href="#h76-0-80" id="h76-0-80" class="d">-    fun canDownloadMedia(mediaIdentifier: String?): DownloadStage? {
</a><a href="#h76-0-81" id="h76-0-81" class="d">-        if (mediaIdentifier == null) return null
</a><a href="#h76-0-82" id="h76-0-82" class="d">-
</a><a href="#h76-0-83" id="h76-0-83" class="d">-        val cursor = taskDatabase.rawQuery(&quot;SELECT * FROM tasks WHERE hash = ?&quot;, arrayOf(mediaIdentifier))
</a><a href="#h76-0-84" id="h76-0-84" class="d">-        if (cursor.count &gt; 0) {
</a><a href="#h76-0-85" id="h76-0-85" class="d">-            cursor.moveToFirst()
</a><a href="#h76-0-86" id="h76-0-86" class="d">-            val downloadStage = DownloadStage.valueOf(cursor.getString(cursor.getColumnIndex(&quot;downloadStage&quot;)))
</a><a href="#h76-0-87" id="h76-0-87" class="d">-            cursor.close()
</a><a href="#h76-0-88" id="h76-0-88" class="d">-
</a><a href="#h76-0-89" id="h76-0-89" class="d">-            //if the stage has reached a final stage and is not in a saved state, remove the task
</a><a href="#h76-0-90" id="h76-0-90" class="d">-            if (downloadStage.isFinalStage &amp;&amp; downloadStage != DownloadStage.SAVED) {
</a><a href="#h76-0-91" id="h76-0-91" class="d">-                taskDatabase.execSQL(&quot;DELETE FROM tasks WHERE hash = ?&quot;, arrayOf(mediaIdentifier))
</a><a href="#h76-0-92" id="h76-0-92" class="d">-                return null
</a><a href="#h76-0-93" id="h76-0-93" class="d">-            }
</a><a href="#h76-0-94" id="h76-0-94" class="d">-
</a><a href="#h76-0-95" id="h76-0-95" class="d">-            return downloadStage
</a><a href="#h76-0-96" id="h76-0-96" class="d">-        }
</a><a href="#h76-0-97" id="h76-0-97" class="d">-        cursor.close()
</a><a href="#h76-0-98" id="h76-0-98" class="d">-        return null
</a><a href="#h76-0-99" id="h76-0-99" class="d">-    }
</a><a href="#h76-0-100" id="h76-0-100" class="d">-
</a><a href="#h76-0-101" id="h76-0-101" class="d">-    fun isEmpty(): Boolean {
</a><a href="#h76-0-102" id="h76-0-102" class="d">-        return cachedTasks.isEmpty() &amp;&amp; pendingTasks.isEmpty()
</a><a href="#h76-0-103" id="h76-0-103" class="d">-    }
</a><a href="#h76-0-104" id="h76-0-104" class="d">-
</a><a href="#h76-0-105" id="h76-0-105" class="d">-    private fun removeTask(id: Int) {
</a><a href="#h76-0-106" id="h76-0-106" class="d">-        taskDatabase.execSQL(&quot;DELETE FROM tasks WHERE id = ?&quot;, arrayOf(id))
</a><a href="#h76-0-107" id="h76-0-107" class="d">-        cachedTasks.remove(id)
</a><a href="#h76-0-108" id="h76-0-108" class="d">-        pendingTasks.remove(id)
</a><a href="#h76-0-109" id="h76-0-109" class="d">-    }
</a><a href="#h76-0-110" id="h76-0-110" class="d">-
</a><a href="#h76-0-111" id="h76-0-111" class="d">-    fun removeTask(task: DownloadObject) {
</a><a href="#h76-0-112" id="h76-0-112" class="d">-        removeTask(task.downloadId)
</a><a href="#h76-0-113" id="h76-0-113" class="d">-    }
</a><a href="#h76-0-114" id="h76-0-114" class="d">-
</a><a href="#h76-0-115" id="h76-0-115" class="d">-    fun queryFirstTasks(filter: MediaFilter): Map&lt;Int, DownloadObject&gt; {
</a><a href="#h76-0-116" id="h76-0-116" class="d">-        val isPendingFilter = filter == MediaFilter.PENDING
</a><a href="#h76-0-117" id="h76-0-117" class="d">-        val tasks = mutableMapOf&lt;Int, DownloadObject&gt;()
</a><a href="#h76-0-118" id="h76-0-118" class="d">-
</a><a href="#h76-0-119" id="h76-0-119" class="d">-        tasks.putAll(pendingTasks.filter { isPendingFilter || filter.matches(it.value.metadata.mediaDisplayType) })
</a><a href="#h76-0-120" id="h76-0-120" class="d">-        if (isPendingFilter) {
</a><a href="#h76-0-121" id="h76-0-121" class="d">-            return tasks.toSortedMap(reverseOrder())
</a><a href="#h76-0-122" id="h76-0-122" class="d">-        }
</a><a href="#h76-0-123" id="h76-0-123" class="d">-
</a><a href="#h76-0-124" id="h76-0-124" class="d">-        tasks.putAll(queryTasks(
</a><a href="#h76-0-125" id="h76-0-125" class="d">-            from = tasks.values.lastOrNull()?.downloadId ?: Int.MAX_VALUE,
</a><a href="#h76-0-126" id="h76-0-126" class="d">-            amount = 30,
</a><a href="#h76-0-127" id="h76-0-127" class="d">-            filter = filter
</a><a href="#h76-0-128" id="h76-0-128" class="d">-        ))
</a><a href="#h76-0-129" id="h76-0-129" class="d">-
</a><a href="#h76-0-130" id="h76-0-130" class="d">-        return tasks.toSortedMap(reverseOrder())
</a><a href="#h76-0-131" id="h76-0-131" class="d">-    }
</a><a href="#h76-0-132" id="h76-0-132" class="d">-
</a><a href="#h76-0-133" id="h76-0-133" class="d">-    @SuppressLint(&quot;Range&quot;)
</a><a href="#h76-0-134" id="h76-0-134" class="d">-    fun queryTasks(from: Int, amount: Int = 30, filter: MediaFilter = MediaFilter.NONE): Map&lt;Int, DownloadObject&gt; {
</a><a href="#h76-0-135" id="h76-0-135" class="d">-        if (filter == MediaFilter.PENDING) {
</a><a href="#h76-0-136" id="h76-0-136" class="d">-            return emptyMap()
</a><a href="#h76-0-137" id="h76-0-137" class="d">-        }
</a><a href="#h76-0-138" id="h76-0-138" class="d">-
</a><a href="#h76-0-139" id="h76-0-139" class="d">-        val cursor = taskDatabase.rawQuery(
</a><a href="#h76-0-140" id="h76-0-140" class="d">-            &quot;SELECT * FROM tasks WHERE id &lt; ? AND mediaDisplayType LIKE ? ORDER BY id DESC LIMIT ?&quot;,
</a><a href="#h76-0-141" id="h76-0-141" class="d">-            arrayOf(
</a><a href="#h76-0-142" id="h76-0-142" class="d">-                from.toString(),
</a><a href="#h76-0-143" id="h76-0-143" class="d">-                if (filter.shouldIgnoreFilter) &quot;%&quot; else &quot;%${filter.key}&quot;,
</a><a href="#h76-0-144" id="h76-0-144" class="d">-                amount.toString()
</a><a href="#h76-0-145" id="h76-0-145" class="d">-            )
</a><a href="#h76-0-146" id="h76-0-146" class="d">-        )
</a><a href="#h76-0-147" id="h76-0-147" class="d">-
</a><a href="#h76-0-148" id="h76-0-148" class="d">-        val result = sortedMapOf&lt;Int, DownloadObject&gt;()
</a><a href="#h76-0-149" id="h76-0-149" class="d">-
</a><a href="#h76-0-150" id="h76-0-150" class="d">-        while (cursor.moveToNext()) {
</a><a href="#h76-0-151" id="h76-0-151" class="d">-            val task = DownloadObject(
</a><a href="#h76-0-152" id="h76-0-152" class="d">-                downloadId = cursor.getIntOrNull(&quot;id&quot;)!!,
</a><a href="#h76-0-153" id="h76-0-153" class="d">-                outputFile = cursor.getStringOrNull(&quot;outputFile&quot;),
</a><a href="#h76-0-154" id="h76-0-154" class="d">-                metadata = DownloadMetadata(
</a><a href="#h76-0-155" id="h76-0-155" class="d">-                    outputPath = cursor.getStringOrNull(&quot;outputPath&quot;)!!,
</a><a href="#h76-0-156" id="h76-0-156" class="d">-                    mediaIdentifier = cursor.getStringOrNull(&quot;hash&quot;),
</a><a href="#h76-0-157" id="h76-0-157" class="d">-                    mediaDisplayType = cursor.getStringOrNull(&quot;mediaDisplayType&quot;),
</a><a href="#h76-0-158" id="h76-0-158" class="d">-                    mediaDisplaySource = cursor.getStringOrNull(&quot;mediaDisplaySource&quot;),
</a><a href="#h76-0-159" id="h76-0-159" class="d">-                    iconUrl = cursor.getStringOrNull(&quot;iconUrl&quot;)
</a><a href="#h76-0-160" id="h76-0-160" class="d">-                )
</a><a href="#h76-0-161" id="h76-0-161" class="d">-            ).apply {
</a><a href="#h76-0-162" id="h76-0-162" class="d">-                downloadTaskManager = this@DownloadTaskManager
</a><a href="#h76-0-163" id="h76-0-163" class="d">-                downloadStage = DownloadStage.valueOf(cursor.getStringOrNull(&quot;downloadStage&quot;)!!)
</a><a href="#h76-0-164" id="h76-0-164" class="d">-                //if downloadStage is not saved, it means the app was killed before the download was finished
</a><a href="#h76-0-165" id="h76-0-165" class="d">-                if (downloadStage != DownloadStage.SAVED) {
</a><a href="#h76-0-166" id="h76-0-166" class="d">-                    downloadStage = DownloadStage.FAILED
</a><a href="#h76-0-167" id="h76-0-167" class="d">-                }
</a><a href="#h76-0-168" id="h76-0-168" class="d">-            }
</a><a href="#h76-0-169" id="h76-0-169" class="d">-            result[task.downloadId] = task
</a><a href="#h76-0-170" id="h76-0-170" class="d">-        }
</a><a href="#h76-0-171" id="h76-0-171" class="d">-        cursor.close()
</a><a href="#h76-0-172" id="h76-0-172" class="d">-
</a><a href="#h76-0-173" id="h76-0-173" class="d">-        return result.toSortedMap(reverseOrder())
</a><a href="#h76-0-174" id="h76-0-174" class="d">-    }
</a><a href="#h76-0-175" id="h76-0-175" class="d">-
</a><a href="#h76-0-176" id="h76-0-176" class="d">-    fun removeAllTasks() {
</a><a href="#h76-0-177" id="h76-0-177" class="d">-        taskDatabase.execSQL(&quot;DELETE FROM tasks&quot;)
</a><a href="#h76-0-178" id="h76-0-178" class="d">-        cachedTasks.clear()
</a><a href="#h76-0-179" id="h76-0-179" class="d">-        pendingTasks.clear()
</a><a href="#h76-0-180" id="h76-0-180" class="d">-    }
</a><a href="#h76-0-181" id="h76-0-181" class="d">-}</a><a href="#h76-0-182" id="h76-0-182" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h77" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/download/data/DownloadMediaType.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/download/data/DownloadMediaType.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/download/data/DownloadMediaType.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/download/data/DownloadMediaType.kt</a></b>
<a href="#h77-0" id="h77-0" class="h">@@ -1,22 +0,0 @@
</a><a href="#h77-0-0" id="h77-0-0" class="d">-package me.rhunk.snapenhance.download.data
</a><a href="#h77-0-1" id="h77-0-1" class="d">-
</a><a href="#h77-0-2" id="h77-0-2" class="d">-import android.net.Uri
</a><a href="#h77-0-3" id="h77-0-3" class="d">-
</a><a href="#h77-0-4" id="h77-0-4" class="d">-enum class DownloadMediaType {
</a><a href="#h77-0-5" id="h77-0-5" class="d">-    PROTO_MEDIA,
</a><a href="#h77-0-6" id="h77-0-6" class="d">-    DIRECT_MEDIA,
</a><a href="#h77-0-7" id="h77-0-7" class="d">-    REMOTE_MEDIA,
</a><a href="#h77-0-8" id="h77-0-8" class="d">-    LOCAL_MEDIA;
</a><a href="#h77-0-9" id="h77-0-9" class="d">-
</a><a href="#h77-0-10" id="h77-0-10" class="d">-    companion object {
</a><a href="#h77-0-11" id="h77-0-11" class="d">-        fun fromUri(uri: Uri): DownloadMediaType {
</a><a href="#h77-0-12" id="h77-0-12" class="d">-            return when (uri.scheme) {
</a><a href="#h77-0-13" id="h77-0-13" class="d">-                &quot;proto&quot; -&gt; PROTO_MEDIA
</a><a href="#h77-0-14" id="h77-0-14" class="d">-                &quot;direct&quot; -&gt; DIRECT_MEDIA
</a><a href="#h77-0-15" id="h77-0-15" class="d">-                &quot;http&quot;, &quot;https&quot; -&gt; REMOTE_MEDIA
</a><a href="#h77-0-16" id="h77-0-16" class="d">-                &quot;file&quot; -&gt; LOCAL_MEDIA
</a><a href="#h77-0-17" id="h77-0-17" class="d">-                else -&gt; throw IllegalArgumentException(&quot;Unknown uri scheme: ${uri.scheme}&quot;)
</a><a href="#h77-0-18" id="h77-0-18" class="d">-            }
</a><a href="#h77-0-19" id="h77-0-19" class="d">-        }
</a><a href="#h77-0-20" id="h77-0-20" class="d">-    }
</a><a href="#h77-0-21" id="h77-0-21" class="d">-}</a><a href="#h77-0-22" id="h77-0-22" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h78" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/download/data/DownloadMetadata.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/download/data/DownloadMetadata.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/download/data/DownloadMetadata.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/download/data/DownloadMetadata.kt</a></b>
<a href="#h78-0" id="h78-0" class="h">@@ -1,9 +0,0 @@
</a><a href="#h78-0-0" id="h78-0-0" class="d">-package me.rhunk.snapenhance.download.data
</a><a href="#h78-0-1" id="h78-0-1" class="d">-
</a><a href="#h78-0-2" id="h78-0-2" class="d">-data class DownloadMetadata(
</a><a href="#h78-0-3" id="h78-0-3" class="d">-    val mediaIdentifier: String?,
</a><a href="#h78-0-4" id="h78-0-4" class="d">-    val outputPath: String,
</a><a href="#h78-0-5" id="h78-0-5" class="d">-    val mediaDisplaySource: String?,
</a><a href="#h78-0-6" id="h78-0-6" class="d">-    val mediaDisplayType: String?,
</a><a href="#h78-0-7" id="h78-0-7" class="d">-    val iconUrl: String?
</a><a href="#h78-0-8" id="h78-0-8" class="d">-)</a><a href="#h78-0-9" id="h78-0-9" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h79" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/download/data/DownloadObject.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/download/data/DownloadObject.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/download/data/DownloadObject.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/download/data/DownloadObject.kt</a></b>
<a href="#h79-0" id="h79-0" class="h">@@ -1,32 +0,0 @@
</a><a href="#h79-0-0" id="h79-0-0" class="d">-package me.rhunk.snapenhance.download.data
</a><a href="#h79-0-1" id="h79-0-1" class="d">-
</a><a href="#h79-0-2" id="h79-0-2" class="d">-import kotlinx.coroutines.Job
</a><a href="#h79-0-3" id="h79-0-3" class="d">-import me.rhunk.snapenhance.download.DownloadTaskManager
</a><a href="#h79-0-4" id="h79-0-4" class="d">-
</a><a href="#h79-0-5" id="h79-0-5" class="d">-data class DownloadObject(
</a><a href="#h79-0-6" id="h79-0-6" class="d">-    var downloadId: Int = 0,
</a><a href="#h79-0-7" id="h79-0-7" class="d">-    var outputFile: String? = null,
</a><a href="#h79-0-8" id="h79-0-8" class="d">-    val metadata : DownloadMetadata
</a><a href="#h79-0-9" id="h79-0-9" class="d">-) {
</a><a href="#h79-0-10" id="h79-0-10" class="d">-    lateinit var downloadTaskManager: DownloadTaskManager
</a><a href="#h79-0-11" id="h79-0-11" class="d">-    var job: Job? = null
</a><a href="#h79-0-12" id="h79-0-12" class="d">-
</a><a href="#h79-0-13" id="h79-0-13" class="d">-    var changeListener = { _: DownloadStage, _: DownloadStage -&gt; }
</a><a href="#h79-0-14" id="h79-0-14" class="d">-    private var _stage: DownloadStage = DownloadStage.PENDING
</a><a href="#h79-0-15" id="h79-0-15" class="d">-    var downloadStage: DownloadStage
</a><a href="#h79-0-16" id="h79-0-16" class="d">-        get() = synchronized(this) {
</a><a href="#h79-0-17" id="h79-0-17" class="d">-            _stage
</a><a href="#h79-0-18" id="h79-0-18" class="d">-        }
</a><a href="#h79-0-19" id="h79-0-19" class="d">-        set(value) = synchronized(this) {
</a><a href="#h79-0-20" id="h79-0-20" class="d">-            changeListener(_stage, value)
</a><a href="#h79-0-21" id="h79-0-21" class="d">-            _stage = value
</a><a href="#h79-0-22" id="h79-0-22" class="d">-            downloadTaskManager.updateTask(this)
</a><a href="#h79-0-23" id="h79-0-23" class="d">-        }
</a><a href="#h79-0-24" id="h79-0-24" class="d">-
</a><a href="#h79-0-25" id="h79-0-25" class="d">-    fun isJobActive() = job?.isActive == true
</a><a href="#h79-0-26" id="h79-0-26" class="d">-
</a><a href="#h79-0-27" id="h79-0-27" class="d">-    fun cancel() {
</a><a href="#h79-0-28" id="h79-0-28" class="d">-        downloadStage = DownloadStage.CANCELLED
</a><a href="#h79-0-29" id="h79-0-29" class="d">-        job?.cancel()
</a><a href="#h79-0-30" id="h79-0-30" class="d">-    }
</a><a href="#h79-0-31" id="h79-0-31" class="d">-}
</a><b>diff --git a/<a id="h80" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/download/data/DownloadRequest.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/download/data/DownloadRequest.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/download/data/DownloadRequest.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/download/data/DownloadRequest.kt</a></b>
<a href="#h80-0" id="h80-0" class="h">@@ -1,26 +0,0 @@
</a><a href="#h80-0-0" id="h80-0-0" class="d">-package me.rhunk.snapenhance.download.data
</a><a href="#h80-0-1" id="h80-0-1" class="d">-
</a><a href="#h80-0-2" id="h80-0-2" class="d">-
</a><a href="#h80-0-3" id="h80-0-3" class="d">-data class DashOptions(val offsetTime: Long, val duration: Long?)
</a><a href="#h80-0-4" id="h80-0-4" class="d">-data class InputMedia(
</a><a href="#h80-0-5" id="h80-0-5" class="d">-    val content: String,
</a><a href="#h80-0-6" id="h80-0-6" class="d">-    val type: DownloadMediaType,
</a><a href="#h80-0-7" id="h80-0-7" class="d">-    val encryption: MediaEncryptionKeyPair? = null
</a><a href="#h80-0-8" id="h80-0-8" class="d">-)
</a><a href="#h80-0-9" id="h80-0-9" class="d">-
</a><a href="#h80-0-10" id="h80-0-10" class="d">-class DownloadRequest(
</a><a href="#h80-0-11" id="h80-0-11" class="d">-    val inputMedias: Array&lt;InputMedia&gt;,
</a><a href="#h80-0-12" id="h80-0-12" class="d">-    val dashOptions: DashOptions? = null,
</a><a href="#h80-0-13" id="h80-0-13" class="d">-    private val flags: Int = 0,
</a><a href="#h80-0-14" id="h80-0-14" class="d">-) {
</a><a href="#h80-0-15" id="h80-0-15" class="d">-    object Flags {
</a><a href="#h80-0-16" id="h80-0-16" class="d">-        const val MERGE_OVERLAY = 1
</a><a href="#h80-0-17" id="h80-0-17" class="d">-        const val IS_DASH_PLAYLIST = 2
</a><a href="#h80-0-18" id="h80-0-18" class="d">-    }
</a><a href="#h80-0-19" id="h80-0-19" class="d">-
</a><a href="#h80-0-20" id="h80-0-20" class="d">-    val isDashPlaylist: Boolean
</a><a href="#h80-0-21" id="h80-0-21" class="d">-        get() = flags and Flags.IS_DASH_PLAYLIST != 0
</a><a href="#h80-0-22" id="h80-0-22" class="d">-
</a><a href="#h80-0-23" id="h80-0-23" class="d">-    val shouldMergeOverlay: Boolean
</a><a href="#h80-0-24" id="h80-0-24" class="d">-        get() = flags and Flags.MERGE_OVERLAY != 0
</a><a href="#h80-0-25" id="h80-0-25" class="d">-}</a><a href="#h80-0-26" id="h80-0-26" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h81" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/download/data/DownloadStage.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/download/data/DownloadStage.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/download/data/DownloadStage.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/download/data/DownloadStage.kt</a></b>
<a href="#h81-0" id="h81-0" class="h">@@ -1,14 +0,0 @@
</a><a href="#h81-0-0" id="h81-0-0" class="d">-package me.rhunk.snapenhance.download.data
</a><a href="#h81-0-1" id="h81-0-1" class="d">-
</a><a href="#h81-0-2" id="h81-0-2" class="d">-enum class DownloadStage(
</a><a href="#h81-0-3" id="h81-0-3" class="d">-    val isFinalStage: Boolean = false,
</a><a href="#h81-0-4" id="h81-0-4" class="d">-) {
</a><a href="#h81-0-5" id="h81-0-5" class="d">-    PENDING(false),
</a><a href="#h81-0-6" id="h81-0-6" class="d">-    DOWNLOADING(false),
</a><a href="#h81-0-7" id="h81-0-7" class="d">-    MERGING(false),
</a><a href="#h81-0-8" id="h81-0-8" class="d">-    DOWNLOADED(true),
</a><a href="#h81-0-9" id="h81-0-9" class="d">-    SAVED(true),
</a><a href="#h81-0-10" id="h81-0-10" class="d">-    MERGE_FAILED(true),
</a><a href="#h81-0-11" id="h81-0-11" class="d">-    FAILED(true),
</a><a href="#h81-0-12" id="h81-0-12" class="d">-    CANCELLED(true)
</a><a href="#h81-0-13" id="h81-0-13" class="d">-}</a><a href="#h81-0-14" id="h81-0-14" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h82" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/download/data/MediaEncryptionKeyPair.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/download/data/MediaEncryptionKeyPair.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/download/data/MediaEncryptionKeyPair.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/download/data/MediaEncryptionKeyPair.kt</a></b>
<a href="#h82-0" id="h82-0" class="h">@@ -1,21 +0,0 @@
</a><a href="#h82-0-0" id="h82-0-0" class="d">-@file:OptIn(ExperimentalEncodingApi::class)
</a><a href="#h82-0-1" id="h82-0-1" class="d">-
</a><a href="#h82-0-2" id="h82-0-2" class="d">-package me.rhunk.snapenhance.download.data
</a><a href="#h82-0-3" id="h82-0-3" class="d">-
</a><a href="#h82-0-4" id="h82-0-4" class="d">-import me.rhunk.snapenhance.data.wrapper.impl.media.EncryptionWrapper
</a><a href="#h82-0-5" id="h82-0-5" class="d">-import kotlin.io.encoding.Base64
</a><a href="#h82-0-6" id="h82-0-6" class="d">-import kotlin.io.encoding.ExperimentalEncodingApi
</a><a href="#h82-0-7" id="h82-0-7" class="d">-
</a><a href="#h82-0-8" id="h82-0-8" class="d">-// key and iv are base64 encoded
</a><a href="#h82-0-9" id="h82-0-9" class="d">-data class MediaEncryptionKeyPair(
</a><a href="#h82-0-10" id="h82-0-10" class="d">-    val key: String,
</a><a href="#h82-0-11" id="h82-0-11" class="d">-    val iv: String
</a><a href="#h82-0-12" id="h82-0-12" class="d">-)
</a><a href="#h82-0-13" id="h82-0-13" class="d">-
</a><a href="#h82-0-14" id="h82-0-14" class="d">-fun Pair&lt;ByteArray, ByteArray&gt;.toKeyPair(): MediaEncryptionKeyPair {
</a><a href="#h82-0-15" id="h82-0-15" class="d">-    return MediaEncryptionKeyPair(Base64.UrlSafe.encode(this.first), Base64.UrlSafe.encode(this.second))
</a><a href="#h82-0-16" id="h82-0-16" class="d">-}
</a><a href="#h82-0-17" id="h82-0-17" class="d">-
</a><a href="#h82-0-18" id="h82-0-18" class="d">-fun EncryptionWrapper.toKeyPair(): MediaEncryptionKeyPair {
</a><a href="#h82-0-19" id="h82-0-19" class="d">-    return MediaEncryptionKeyPair(Base64.UrlSafe.encode(this.keySpec), Base64.UrlSafe.encode(this.ivKeyParameterSpec))
</a><a href="#h82-0-20" id="h82-0-20" class="d">-}</a><a href="#h82-0-21" id="h82-0-21" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h83" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/download/data/MediaFilter.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/download/data/MediaFilter.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/download/data/MediaFilter.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/download/data/MediaFilter.kt</a></b>
<a href="#h83-0" id="h83-0" class="h">@@ -1,18 +0,0 @@
</a><a href="#h83-0-0" id="h83-0-0" class="d">-package me.rhunk.snapenhance.download.data
</a><a href="#h83-0-1" id="h83-0-1" class="d">-
</a><a href="#h83-0-2" id="h83-0-2" class="d">-enum class MediaFilter(
</a><a href="#h83-0-3" id="h83-0-3" class="d">-    val key: String,
</a><a href="#h83-0-4" id="h83-0-4" class="d">-    val shouldIgnoreFilter: Boolean = false
</a><a href="#h83-0-5" id="h83-0-5" class="d">-) {
</a><a href="#h83-0-6" id="h83-0-6" class="d">-    NONE(&quot;none&quot;, true),
</a><a href="#h83-0-7" id="h83-0-7" class="d">-    PENDING(&quot;pending&quot;, true),
</a><a href="#h83-0-8" id="h83-0-8" class="d">-    CHAT_MEDIA(&quot;chat_media&quot;),
</a><a href="#h83-0-9" id="h83-0-9" class="d">-    STORY(&quot;story&quot;),
</a><a href="#h83-0-10" id="h83-0-10" class="d">-    SPOTLIGHT(&quot;spotlight&quot;),
</a><a href="#h83-0-11" id="h83-0-11" class="d">-    PROFILE_PICTURE(&quot;profile_picture&quot;);
</a><a href="#h83-0-12" id="h83-0-12" class="d">-
</a><a href="#h83-0-13" id="h83-0-13" class="d">-    fun matches(source: String?): Boolean {
</a><a href="#h83-0-14" id="h83-0-14" class="d">-        if (source == null) return false
</a><a href="#h83-0-15" id="h83-0-15" class="d">-        return source.contains(key, ignoreCase = true)
</a><a href="#h83-0-16" id="h83-0-16" class="d">-    }
</a><a href="#h83-0-17" id="h83-0-17" class="d">-}</a><a href="#h83-0-18" id="h83-0-18" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h84" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/download/data/SplitMediaAssetType.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/download/data/SplitMediaAssetType.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/download/data/SplitMediaAssetType.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/download/data/SplitMediaAssetType.kt</a></b>
<a href="#h84-0" id="h84-0" class="h">@@ -1,5 +0,0 @@
</a><a href="#h84-0-0" id="h84-0-0" class="d">-package me.rhunk.snapenhance.download.data
</a><a href="#h84-0-1" id="h84-0-1" class="d">-
</a><a href="#h84-0-2" id="h84-0-2" class="d">-enum class SplitMediaAssetType {
</a><a href="#h84-0-3" id="h84-0-3" class="d">-    ORIGINAL, OVERLAY
</a><a href="#h84-0-4" id="h84-0-4" class="d">-}
</a><b>diff --git a/<a id="h85" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/BridgeFileFeature.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/BridgeFileFeature.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/BridgeFileFeature.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/BridgeFileFeature.kt</a></b>
<a href="#h85-0" id="h85-0" class="h">@@ -1,6 +1,6 @@
</a> package me.rhunk.snapenhance.features
 
<a href="#h85-0-2" id="h85-0-2" class="d">-import me.rhunk.snapenhance.bridge.types.BridgeFileType
</a><a href="#h85-0-3" id="h85-0-3" class="i">+import me.rhunk.snapenhance.core.bridge.types.BridgeFileType
</a> import java.io.BufferedReader
 import java.io.ByteArrayInputStream
 import java.io.InputStreamReader
<b>diff --git a/<a id="h86" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/AutoUpdater.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/AutoUpdater.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/AutoUpdater.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/AutoUpdater.kt</a></b>
<a href="#h86-0" id="h86-0" class="h">@@ -10,7 +10,6 @@ import android.net.Uri
</a> import android.os.Build
 import android.os.Environment
 import com.google.gson.JsonParser
<a href="#h86-0-3" id="h86-0-3" class="d">-import me.rhunk.snapenhance.Logger
</a> import me.rhunk.snapenhance.core.BuildConfig
 import me.rhunk.snapenhance.features.Feature
 import me.rhunk.snapenhance.features.FeatureLoadParams
<a href="#h86-1" id="h86-1" class="h">@@ -36,7 +35,7 @@ class AutoUpdater : Feature(&quot;AutoUpdater&quot;, loadParams = FeatureLoadParams.ACTIVI
</a>         runCatching {
             checkForUpdates()
         }.onFailure {
<a href="#h86-1-3" id="h86-1-3" class="d">-            Logger.error(&quot;Failed to check for updates: ${it.message}&quot;, it)
</a><a href="#h86-1-4" id="h86-1-4" class="i">+            context.log.error(&quot;Failed to check for updates: ${it.message}&quot;, it)
</a>         }.onSuccess {
             context.bridgeClient.setAutoUpdaterTime(currentTimeMillis)
         }
<b>diff --git a/<a id="h87" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/MediaDownloader.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/MediaDownloader.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/MediaDownloader.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/MediaDownloader.kt</a></b>
<a href="#h87-0" id="h87-0" class="h">@@ -6,9 +6,15 @@ import android.graphics.BitmapFactory
</a> import android.net.Uri
 import android.widget.ImageView
 import kotlinx.coroutines.runBlocking
<a href="#h87-0-3" id="h87-0-3" class="d">-import me.rhunk.snapenhance.Logger
</a><a href="#h87-0-4" id="h87-0-4" class="d">-import me.rhunk.snapenhance.Logger.xposedLog
</a> import me.rhunk.snapenhance.bridge.DownloadCallback
<a href="#h87-0-6" id="h87-0-6" class="i">+import me.rhunk.snapenhance.core.database.objects.FriendInfo
</a><a href="#h87-0-7" id="h87-0-7" class="i">+import me.rhunk.snapenhance.core.download.DownloadManagerClient
</a><a href="#h87-0-8" id="h87-0-8" class="i">+import me.rhunk.snapenhance.core.download.data.DownloadMediaType
</a><a href="#h87-0-9" id="h87-0-9" class="i">+import me.rhunk.snapenhance.core.download.data.DownloadMetadata
</a><a href="#h87-0-10" id="h87-0-10" class="i">+import me.rhunk.snapenhance.core.download.data.InputMedia
</a><a href="#h87-0-11" id="h87-0-11" class="i">+import me.rhunk.snapenhance.core.download.data.MediaFilter
</a><a href="#h87-0-12" id="h87-0-12" class="i">+import me.rhunk.snapenhance.core.download.data.SplitMediaAssetType
</a><a href="#h87-0-13" id="h87-0-13" class="i">+import me.rhunk.snapenhance.core.download.data.toKeyPair
</a> import me.rhunk.snapenhance.core.messaging.MessagingRuleType
 import me.rhunk.snapenhance.data.ContentType
 import me.rhunk.snapenhance.data.FileType
<a href="#h87-1" id="h87-1" class="h">@@ -17,14 +23,6 @@ import me.rhunk.snapenhance.data.wrapper.impl.media.dash.LongformVideoPlaylistIt
</a> import me.rhunk.snapenhance.data.wrapper.impl.media.dash.SnapPlaylistItem
 import me.rhunk.snapenhance.data.wrapper.impl.media.opera.Layer
 import me.rhunk.snapenhance.data.wrapper.impl.media.opera.ParamMap
<a href="#h87-1-3" id="h87-1-3" class="d">-import me.rhunk.snapenhance.database.objects.FriendInfo
</a><a href="#h87-1-4" id="h87-1-4" class="d">-import me.rhunk.snapenhance.download.DownloadManagerClient
</a><a href="#h87-1-5" id="h87-1-5" class="d">-import me.rhunk.snapenhance.download.data.DownloadMediaType
</a><a href="#h87-1-6" id="h87-1-6" class="d">-import me.rhunk.snapenhance.download.data.DownloadMetadata
</a><a href="#h87-1-7" id="h87-1-7" class="d">-import me.rhunk.snapenhance.download.data.InputMedia
</a><a href="#h87-1-8" id="h87-1-8" class="d">-import me.rhunk.snapenhance.download.data.MediaFilter
</a><a href="#h87-1-9" id="h87-1-9" class="d">-import me.rhunk.snapenhance.download.data.SplitMediaAssetType
</a><a href="#h87-1-10" id="h87-1-10" class="d">-import me.rhunk.snapenhance.download.data.toKeyPair
</a> import me.rhunk.snapenhance.features.FeatureLoadParams
 import me.rhunk.snapenhance.features.MessagingRuleFeature
 import me.rhunk.snapenhance.features.impl.Messaging
<a href="#h87-2" id="h87-2" class="h">@@ -84,19 +82,19 @@ class MediaDownloader : MessagingRuleFeature(&quot;MediaDownloader&quot;, MessagingRuleTyp
</a>             callback = object: DownloadCallback.Stub() {
                 override fun onSuccess(outputFile: String) {
                     if (!downloadLogging.contains(&quot;success&quot;)) return
<a href="#h87-2-3" id="h87-2-3" class="d">-                    Logger.debug(&quot;onSuccess: outputFile=$outputFile&quot;)
</a><a href="#h87-2-4" id="h87-2-4" class="i">+                    context.log.verbose(&quot;onSuccess: outputFile=$outputFile&quot;)
</a>                     context.shortToast(context.translation.format(&quot;download_processor.saved_toast&quot;, &quot;path&quot; to outputFile.split(&quot;/&quot;).takeLast(2).joinToString(&quot;/&quot;)))
                 }
 
                 override fun onProgress(message: String) {
                     if (!downloadLogging.contains(&quot;progress&quot;)) return
<a href="#h87-2-10" id="h87-2-10" class="d">-                    Logger.debug(&quot;onProgress: message=$message&quot;)
</a><a href="#h87-2-11" id="h87-2-11" class="i">+                    context.log.verbose(&quot;onProgress: message=$message&quot;)
</a>                     context.shortToast(message)
                 }
 
                 override fun onFailure(message: String, throwable: String?) {
                     if (!downloadLogging.contains(&quot;failure&quot;)) return
<a href="#h87-2-17" id="h87-2-17" class="d">-                    Logger.debug(&quot;onFailure: message=$message, throwable=$throwable&quot;)
</a><a href="#h87-2-18" id="h87-2-18" class="i">+                    context.log.verbose(&quot;onFailure: message=$message, throwable=$throwable&quot;)
</a>                     throwable?.let {
                         context.longToast((message + it.takeIf { it.isNotEmpty() }.orEmpty()))
                         return
<a href="#h87-3" id="h87-3" class="h">@@ -402,8 +400,8 @@ class MediaDownloader : MessagingRuleFeature(&quot;MediaDownloader&quot;, MessagingRuleTyp
</a>                 try {
                     handleOperaMedia(mediaParamMap, mediaInfoMap, false)
                 } catch (e: Throwable) {
<a href="#h87-3-3" id="h87-3-3" class="d">-                    xposedLog(e)
</a><a href="#h87-3-4" id="h87-3-4" class="d">-                    context.longToast(e.message!!)
</a><a href="#h87-3-5" id="h87-3-5" class="i">+                    context.log.error(&quot;Failed to handle opera media&quot;, e)
</a><a href="#h87-3-6" id="h87-3-6" class="i">+                    context.longToast(e.message)
</a>                 }
             }
         }
<a href="#h87-4" id="h87-4" class="h">@@ -524,11 +522,11 @@ class MediaDownloader : MessagingRuleFeature(&quot;MediaDownloader&quot;, MessagingRuleTyp
</a>                 }
             }.onFailure {
                 context.shortToast(translations[&quot;failed_to_create_preview_toast&quot;])
<a href="#h87-4-3" id="h87-4-3" class="d">-                xposedLog(it)
</a><a href="#h87-4-4" id="h87-4-4" class="i">+                context.log.error(&quot;Failed to create preview&quot;, it)
</a>             }
         }.onFailure {
             context.longToast(translations[&quot;failed_generic_toast&quot;])
<a href="#h87-4-8" id="h87-4-8" class="d">-            xposedLog(it)
</a><a href="#h87-4-9" id="h87-4-9" class="i">+            context.log.error(&quot;Failed to download message&quot;, it)
</a>         }
     }
 
<b>diff --git a/<a id="h88" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/ProfilePictureDownloader.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/ProfilePictureDownloader.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/ProfilePictureDownloader.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/ProfilePictureDownloader.kt</a></b>
<a href="#h88-0" id="h88-0" class="h">@@ -3,7 +3,6 @@ package me.rhunk.snapenhance.features.impl.downloader
</a> import android.annotation.SuppressLint
 import android.widget.Button
 import android.widget.RelativeLayout
<a href="#h88-0-3" id="h88-0-3" class="d">-import me.rhunk.snapenhance.Logger
</a> import me.rhunk.snapenhance.core.eventbus.events.impl.AddViewEvent
 import me.rhunk.snapenhance.core.eventbus.events.impl.NetworkApiRequestEvent
 import me.rhunk.snapenhance.features.Feature
<a href="#h88-1" id="h88-1" class="h">@@ -45,7 +44,7 @@ class ProfilePictureDownloader : Feature(&quot;ProfilePictureDownloader&quot;, loadParams 
</a>                                     friendUsername!!
                                 )
                             }.onFailure {
<a href="#h88-1-3" id="h88-1-3" class="d">-                                Logger.error(&quot;Failed to download profile picture&quot;, it)
</a><a href="#h88-1-4" id="h88-1-4" class="i">+                                this@ProfilePictureDownloader.context.log.error(&quot;Failed to download profile picture&quot;, it)
</a>                             }
                         }
                     }.show()
<b>diff --git a/<a id="h89" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/experiments/DeviceSpooferHook.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/experiments/DeviceSpooferHook.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/experiments/DeviceSpooferHook.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/experiments/DeviceSpooferHook.kt</a></b>
<a href="#h89-0" id="h89-0" class="h">@@ -1,6 +1,5 @@
</a> package me.rhunk.snapenhance.features.impl.experiments
 
<a href="#h89-0-2" id="h89-0-2" class="d">-import me.rhunk.snapenhance.Logger
</a> import me.rhunk.snapenhance.features.Feature
 import me.rhunk.snapenhance.features.FeatureLoadParams
 import me.rhunk.snapenhance.hook.HookStage
<a href="#h89-1" id="h89-1" class="h">@@ -17,11 +16,11 @@ class DeviceSpooferHook: Feature(&quot;device_spoofer&quot;, loadParams = FeatureLoadParam
</a> 			val fingerprintClass = android.os.Build::class.java
 			Hooker.hook(fingerprintClass, &quot;FINGERPRINT&quot;, HookStage.BEFORE) { hookAdapter -&gt;
 				hookAdapter.setResult(fingerprint)
<a href="#h89-1-3" id="h89-1-3" class="d">-				Logger.debug(&quot;Fingerprint spoofed to $fingerprint&quot;)
</a><a href="#h89-1-4" id="h89-1-4" class="i">+				context.log.verbose(&quot;Fingerprint spoofed to $fingerprint&quot;)
</a> 			}
 			Hooker.hook(fingerprintClass, &quot;deriveFingerprint&quot;, HookStage.BEFORE) { hookAdapter -&gt;
 				hookAdapter.setResult(fingerprint)
<a href="#h89-1-8" id="h89-1-8" class="d">-				Logger.debug(&quot;Fingerprint spoofed to $fingerprint&quot;)
</a><a href="#h89-1-9" id="h89-1-9" class="i">+				context.log.verbose(&quot;Fingerprint spoofed to $fingerprint&quot;)
</a> 			}
 		}
 
<a href="#h89-2" id="h89-2" class="h">@@ -30,7 +29,7 @@ class DeviceSpooferHook: Feature(&quot;device_spoofer&quot;, loadParams = FeatureLoadParam
</a> 			Hooker.hook(settingsSecureClass, &quot;getString&quot;, HookStage.BEFORE) { hookAdapter -&gt;
 				if(hookAdapter.args()[1] == &quot;android_id&quot;) {
 					hookAdapter.setResult(androidId)
<a href="#h89-2-3" id="h89-2-3" class="d">-					Logger.debug(&quot;Android ID spoofed to $androidId&quot;)
</a><a href="#h89-2-4" id="h89-2-4" class="i">+					context.log.verbose(&quot;Android ID spoofed to $androidId&quot;)
</a> 				}
 			}
 		}
<b>diff --git a/<a id="h90" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/privacy/PreventMessageSending.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/privacy/PreventMessageSending.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/privacy/PreventMessageSending.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/privacy/PreventMessageSending.kt</a></b>
<a href="#h90-0" id="h90-0" class="h">@@ -1,6 +1,5 @@
</a> package me.rhunk.snapenhance.features.impl.privacy
 
<a href="#h90-0-2" id="h90-0-2" class="d">-import me.rhunk.snapenhance.Logger
</a> import me.rhunk.snapenhance.core.eventbus.events.impl.SendMessageWithContentEvent
 import me.rhunk.snapenhance.data.NotificationType
 import me.rhunk.snapenhance.features.Feature
<a href="#h90-1" id="h90-1" class="h">@@ -28,7 +27,7 @@ class PreventMessageSending : Feature(&quot;Prevent message sending&quot;, loadParams = Fe
</a>             val associatedType = NotificationType.fromContentType(contentType) ?: return@subscribe
 
             if (preventMessageSending.contains(associatedType.key)) {
<a href="#h90-1-3" id="h90-1-3" class="d">-                Logger.debug(&quot;Preventing message sending for $associatedType&quot;)
</a><a href="#h90-1-4" id="h90-1-4" class="i">+                context.log.verbose(&quot;Preventing message sending for $associatedType&quot;)
</a>                 event.canceled = true
             }
         }
<b>diff --git a/<a id="h91" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/spying/AnonymousStoryViewing.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/spying/AnonymousStoryViewing.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/spying/AnonymousStoryViewing.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/spying/AnonymousStoryViewing.kt</a></b>
<a href="#h91-0" id="h91-0" class="h">@@ -1,7 +1,6 @@
</a> package me.rhunk.snapenhance.features.impl.spying
 
 import kotlinx.coroutines.runBlocking
<a href="#h91-0-3" id="h91-0-3" class="d">-import me.rhunk.snapenhance.Logger
</a> import me.rhunk.snapenhance.core.eventbus.events.impl.NetworkApiRequestEvent
 import me.rhunk.snapenhance.features.Feature
 import me.rhunk.snapenhance.features.FeatureLoadParams
<b>diff --git a/<a id="h92" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/spying/MessageLogger.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/spying/MessageLogger.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/spying/MessageLogger.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/spying/MessageLogger.kt</a></b>
<a href="#h92-0" id="h92-0" class="h">@@ -3,7 +3,6 @@ package me.rhunk.snapenhance.features.impl.spying
</a> import android.os.DeadObjectException
 import com.google.gson.JsonObject
 import com.google.gson.JsonParser
<a href="#h92-0-3" id="h92-0-3" class="d">-import me.rhunk.snapenhance.Logger
</a> import me.rhunk.snapenhance.data.ContentType
 import me.rhunk.snapenhance.data.MessageState
 import me.rhunk.snapenhance.data.wrapper.impl.Message
<a href="#h92-1" id="h92-1" class="h">@@ -72,7 +71,7 @@ class MessageLogger : Feature(&quot;MessageLogger&quot;,
</a>             context.database.getFeedEntries(PREFETCH_FEED_COUNT).forEach { friendFeedInfo -&gt;
                 fetchedMessages.addAll(context.bridgeClient.getLoggedMessageIds(friendFeedInfo.key!!, PREFETCH_MESSAGE_COUNT).toList())
             }
<a href="#h92-1-3" id="h92-1-3" class="d">-        }.also { Logger.debug(&quot;Loaded ${fetchedMessages.size} cached messages in $it&quot;) }
</a><a href="#h92-1-4" id="h92-1-4" class="i">+        }.also { context.log.verbose(&quot;Loaded ${fetchedMessages.size} cached messages in $it&quot;) }
</a>     }
 
     private fun processSnapMessage(messageInstance: Any) {
<b>diff --git a/<a id="h93" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/AutoSave.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/AutoSave.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/AutoSave.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/AutoSave.kt</a></b>
<a href="#h93-0" id="h93-0" class="h">@@ -41,7 +41,7 @@ class AutoSave : MessagingRuleFeature(&quot;Auto Save&quot;, MessagingRuleType.AUTO_SAVE, 
</a> 
         val callback = CallbackBuilder(callbackClass)
             .override(&quot;onError&quot;) {
<a href="#h93-0-3" id="h93-0-3" class="d">-                Logger.xposedLog(&quot;Error saving message $messageId&quot;)
</a><a href="#h93-0-4" id="h93-0-4" class="i">+                context.log.warn(&quot;Error saving message $messageId&quot;)
</a>             }.build()
 
         runCatching {
<b>diff --git a/<a id="h94" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/DisableVideoLengthRestriction.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/DisableVideoLengthRestriction.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/DisableVideoLengthRestriction.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/DisableVideoLengthRestriction.kt</a></b>
<a href="#h94-0" id="h94-0" class="h">@@ -3,7 +3,6 @@ package me.rhunk.snapenhance.features.impl.tweaks
</a> import android.os.Build
 import android.os.FileObserver
 import com.google.gson.JsonParser
<a href="#h94-0-3" id="h94-0-3" class="d">-import me.rhunk.snapenhance.Logger
</a> import me.rhunk.snapenhance.core.eventbus.events.impl.SendMessageWithContentEvent
 import me.rhunk.snapenhance.features.Feature
 import me.rhunk.snapenhance.features.FeatureLoadParams
<a href="#h94-1" id="h94-1" class="h">@@ -32,7 +31,7 @@ class DisableVideoLengthRestriction : Feature(&quot;DisableVideoLengthRestriction&quot;, l
</a>                         val fileContent = JsonParser.parseReader(file.reader()).asJsonObject
                         if (fileContent[&quot;timerOrDuration&quot;].asLong &lt; 0) file.delete()
                     }.onFailure {
<a href="#h94-1-3" id="h94-1-3" class="d">-                        Logger.error(&quot;Failed to read story metadata file&quot;, it)
</a><a href="#h94-1-4" id="h94-1-4" class="i">+                        context.log.error(&quot;Failed to read story metadata file&quot;, it)
</a>                     }
                 }
             })
<b>diff --git a/<a id="h95" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/GooglePlayServicesDialogs.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/GooglePlayServicesDialogs.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/GooglePlayServicesDialogs.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/GooglePlayServicesDialogs.kt</a></b>
<a href="#h95-0" id="h95-0" class="h">@@ -1,7 +1,6 @@
</a> package me.rhunk.snapenhance.features.impl.tweaks
 
 import android.app.AlertDialog
<a href="#h95-0-3" id="h95-0-3" class="d">-import me.rhunk.snapenhance.Logger
</a> import me.rhunk.snapenhance.features.Feature
 import me.rhunk.snapenhance.features.FeatureLoadParams
 import me.rhunk.snapenhance.hook.HookStage
<a href="#h95-1" id="h95-1" class="h">@@ -15,7 +14,7 @@ class GooglePlayServicesDialogs : Feature(&quot;Disable GMS Dialogs&quot;, loadParams = Fe
</a>         findClass(&quot;com.google.android.gms.common.GoogleApiAvailability&quot;).methods
             .first { Modifier.isStatic(it.modifiers) &amp;&amp; it.returnType == AlertDialog::class.java }.let { method -&gt;
             method.hook(HookStage.BEFORE) { param -&gt;
<a href="#h95-1-3" id="h95-1-3" class="d">-                Logger.debug(&quot;GoogleApiAvailability.showErrorDialogFragment() called, returning null&quot;)
</a><a href="#h95-1-4" id="h95-1-4" class="i">+                context.log.verbose(&quot;GoogleApiAvailability.showErrorDialogFragment() called, returning null&quot;)
</a>                 param.setResult(null)
             }
         }
<b>diff --git a/<a id="h96" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/Notifications.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/Notifications.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/Notifications.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/Notifications.kt</a></b>
<a href="#h96-0" id="h96-0" class="h">@@ -13,12 +13,12 @@ import android.os.UserHandle
</a> import de.robv.android.xposed.XposedBridge
 import de.robv.android.xposed.XposedHelpers
 import me.rhunk.snapenhance.Logger
<a href="#h96-0-3" id="h96-0-3" class="i">+import me.rhunk.snapenhance.core.download.data.SplitMediaAssetType
</a> import me.rhunk.snapenhance.core.eventbus.events.impl.SnapWidgetBroadcastReceiveEvent
 import me.rhunk.snapenhance.data.ContentType
 import me.rhunk.snapenhance.data.MediaReferenceType
 import me.rhunk.snapenhance.data.wrapper.impl.Message
 import me.rhunk.snapenhance.data.wrapper.impl.SnapUUID
<a href="#h96-0-9" id="h96-0-9" class="d">-import me.rhunk.snapenhance.download.data.SplitMediaAssetType
</a> import me.rhunk.snapenhance.features.Feature
 import me.rhunk.snapenhance.features.FeatureLoadParams
 import me.rhunk.snapenhance.features.impl.Messaging
<a href="#h96-1" id="h96-1" class="h">@@ -297,7 +297,7 @@ class Notifications : Feature(&quot;Notifications&quot;, loadParams = FeatureLoadParams.IN
</a>                     fetchMessagesResult(conversationId, messageList)
                 }
                 .override(&quot;onError&quot;) {
<a href="#h96-1-3" id="h96-1-3" class="d">-                    Logger.xposedLog(&quot;Failed to fetch message ${it.arg(0) as Any}&quot;)
</a><a href="#h96-1-4" id="h96-1-4" class="i">+                    context.log.error(&quot;Failed to fetch message ${it.arg(0) as Any}&quot;)
</a>                 }.build()
 
             fetchConversationWithMessagesMethod.invoke(conversationManager, SnapUUID.fromString(conversationId).instanceNonNull(), callback)
<a href="#h96-2" id="h96-2" class="h">@@ -323,7 +323,7 @@ class Notifications : Feature(&quot;Notifications&quot;, loadParams = FeatureLoadParams.IN
</a>                     val intent = param.argNullable&lt;Intent&gt;(0) ?: return@hook
                     val messageType = intent.getStringExtra(&quot;type&quot;) ?: return@hook
 
<a href="#h96-2-3" id="h96-2-3" class="d">-                    Logger.xposedLog(&quot;received message type: $messageType&quot;)
</a><a href="#h96-2-4" id="h96-2-4" class="i">+                    context.log.debug(&quot;received message type: $messageType&quot;)
</a> 
                     if (states.contains(messageType.replaceFirst(&quot;mischief_&quot;, &quot;&quot;))) {
                         param.setResult(null)
<b>diff --git a/<a id="h97" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/PinConversations.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/PinConversations.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/PinConversations.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/PinConversations.kt</a></b>
<a href="#h97-0" id="h97-0" class="h">@@ -1,6 +1,6 @@
</a> package me.rhunk.snapenhance.features.impl.ui
 
<a href="#h97-0-2" id="h97-0-2" class="d">-import me.rhunk.snapenhance.bridge.types.BridgeFileType
</a><a href="#h97-0-3" id="h97-0-3" class="i">+import me.rhunk.snapenhance.core.bridge.types.BridgeFileType
</a> import me.rhunk.snapenhance.data.wrapper.impl.SnapUUID
 import me.rhunk.snapenhance.features.BridgeFileFeature
 import me.rhunk.snapenhance.features.FeatureLoadParams
<b>diff --git a/<a id="h98" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/manager/impl/ActionManager.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/manager/impl/ActionManager.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/manager/impl/ActionManager.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/manager/impl/ActionManager.kt</a></b>
<a href="#h98-0" id="h98-0" class="h">@@ -1,38 +1,37 @@
</a> package me.rhunk.snapenhance.manager.impl
 
<a href="#h98-0-2" id="h98-0-2" class="i">+import android.content.Intent
</a> import me.rhunk.snapenhance.ModContext
 import me.rhunk.snapenhance.action.AbstractAction
<a href="#h98-0-5" id="h98-0-5" class="d">-import me.rhunk.snapenhance.action.impl.CheckForUpdates
</a><a href="#h98-0-6" id="h98-0-6" class="d">-import me.rhunk.snapenhance.action.impl.CleanCache
</a><a href="#h98-0-7" id="h98-0-7" class="d">-import me.rhunk.snapenhance.action.impl.ClearMessageLogger
</a><a href="#h98-0-8" id="h98-0-8" class="d">-import me.rhunk.snapenhance.action.impl.ExportChatMessages
</a><a href="#h98-0-9" id="h98-0-9" class="d">-import me.rhunk.snapenhance.action.impl.OpenMap
</a><a href="#h98-0-10" id="h98-0-10" class="d">-import me.rhunk.snapenhance.action.impl.RefreshMappings
</a><a href="#h98-0-11" id="h98-0-11" class="d">-import me.rhunk.snapenhance.core.BuildConfig
</a><a href="#h98-0-12" id="h98-0-12" class="i">+import me.rhunk.snapenhance.action.EnumAction
</a> import me.rhunk.snapenhance.manager.Manager
<a href="#h98-0-14" id="h98-0-14" class="d">-import kotlin.reflect.KClass
</a> 
 class ActionManager(
<a href="#h98-0-17" id="h98-0-17" class="d">-    private val context: ModContext,
</a><a href="#h98-0-18" id="h98-0-18" class="i">+    private val modContext: ModContext,
</a> ) : Manager {
<a href="#h98-0-20" id="h98-0-20" class="d">-    private val actions = mutableMapOf&lt;String, AbstractAction&gt;()
</a><a href="#h98-0-21" id="h98-0-21" class="d">-    fun getActions() = actions.values.toList()
</a><a href="#h98-0-22" id="h98-0-22" class="d">-    private fun load(clazz: KClass&lt;out AbstractAction&gt;) {
</a><a href="#h98-0-23" id="h98-0-23" class="d">-        val action = clazz.java.newInstance()
</a><a href="#h98-0-24" id="h98-0-24" class="d">-        action.context = context
</a><a href="#h98-0-25" id="h98-0-25" class="d">-        actions[action.nameKey] = action
</a><a href="#h98-0-26" id="h98-0-26" class="i">+    companion object {
</a><a href="#h98-0-27" id="h98-0-27" class="i">+        const val ACTION_PARAMETER = &quot;se_action&quot;
</a>     }
<a href="#h98-0-29" id="h98-0-29" class="i">+    private val actions = mutableMapOf&lt;String, AbstractAction&gt;()
</a><a href="#h98-0-30" id="h98-0-30" class="i">+
</a>     override fun init() {
<a href="#h98-0-32" id="h98-0-32" class="d">-        load(CleanCache::class)
</a><a href="#h98-0-33" id="h98-0-33" class="d">-        load(ExportChatMessages::class)
</a><a href="#h98-0-34" id="h98-0-34" class="d">-        load(OpenMap::class)
</a><a href="#h98-0-35" id="h98-0-35" class="d">-        load(CheckForUpdates::class)
</a><a href="#h98-0-36" id="h98-0-36" class="d">-        if(BuildConfig.DEBUG) {
</a><a href="#h98-0-37" id="h98-0-37" class="d">-            load(ClearMessageLogger::class)
</a><a href="#h98-0-38" id="h98-0-38" class="d">-            load(RefreshMappings::class)
</a><a href="#h98-0-39" id="h98-0-39" class="i">+        EnumAction.values().forEach { enumAction -&gt;
</a><a href="#h98-0-40" id="h98-0-40" class="i">+            actions[enumAction.key] = enumAction.clazz.java.getConstructor().newInstance().apply {
</a><a href="#h98-0-41" id="h98-0-41" class="i">+                this.context = modContext
</a><a href="#h98-0-42" id="h98-0-42" class="i">+            }
</a>         }
<a href="#h98-0-44" id="h98-0-44" class="i">+    }
</a> 
<a href="#h98-0-46" id="h98-0-46" class="i">+    fun onNewIntent(intent: Intent?) {
</a><a href="#h98-0-47" id="h98-0-47" class="i">+        val action = intent?.getStringExtra(ACTION_PARAMETER) ?: return
</a><a href="#h98-0-48" id="h98-0-48" class="i">+        execute(EnumAction.values().find { it.key == action } ?: return)
</a><a href="#h98-0-49" id="h98-0-49" class="i">+        intent.removeExtra(ACTION_PARAMETER)
</a><a href="#h98-0-50" id="h98-0-50" class="i">+    }
</a> 
<a href="#h98-0-52" id="h98-0-52" class="d">-        actions.values.forEach(AbstractAction::init)
</a><a href="#h98-0-53" id="h98-0-53" class="i">+    private fun execute(action: EnumAction) {
</a><a href="#h98-0-54" id="h98-0-54" class="i">+        actions[action.key]?.run()
</a><a href="#h98-0-55" id="h98-0-55" class="i">+        if (action.exitOnFinish) {
</a><a href="#h98-0-56" id="h98-0-56" class="i">+            modContext.forceCloseApp()
</a><a href="#h98-0-57" id="h98-0-57" class="i">+        }
</a>     }
 } 
\ No newline at end of file
<b>diff --git a/<a id="h99" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/FriendFeedInfoMenu.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/FriendFeedInfoMenu.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/FriendFeedInfoMenu.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/FriendFeedInfoMenu.kt</a></b>
<a href="#h99-0" id="h99-0" class="h">@@ -11,11 +11,10 @@ import android.view.View
</a> import android.widget.Button
 import android.widget.CompoundButton
 import android.widget.Switch
<a href="#h99-0-3" id="h99-0-3" class="d">-import me.rhunk.snapenhance.Logger
</a><a href="#h99-0-4" id="h99-0-4" class="i">+import me.rhunk.snapenhance.core.database.objects.ConversationMessage
</a><a href="#h99-0-5" id="h99-0-5" class="i">+import me.rhunk.snapenhance.core.database.objects.FriendInfo
</a><a href="#h99-0-6" id="h99-0-6" class="i">+import me.rhunk.snapenhance.core.database.objects.UserConversationLink
</a> import me.rhunk.snapenhance.data.ContentType
<a href="#h99-0-8" id="h99-0-8" class="d">-import me.rhunk.snapenhance.database.objects.ConversationMessage
</a><a href="#h99-0-9" id="h99-0-9" class="d">-import me.rhunk.snapenhance.database.objects.FriendInfo
</a><a href="#h99-0-10" id="h99-0-10" class="d">-import me.rhunk.snapenhance.database.objects.UserConversationLink
</a> import me.rhunk.snapenhance.features.MessagingRuleFeature
 import me.rhunk.snapenhance.features.impl.Messaging
 import me.rhunk.snapenhance.features.impl.downloader.MediaDownloader
<a href="#h99-1" id="h99-1" class="h">@@ -57,7 +56,7 @@ class FriendFeedInfoMenu : AbstractMenu() {
</a>                 )
             }
         } catch (e: Throwable) {
<a href="#h99-1-3" id="h99-1-3" class="d">-            Logger.xposedLog(e)
</a><a href="#h99-1-4" id="h99-1-4" class="i">+            context.log.error(&quot;Error loading bitmoji selfie&quot;, e)
</a>         }
         val finalIcon = icon
         context.runOnUiThread {
<a href="#h99-2" id="h99-2" class="h">@@ -243,7 +242,6 @@ class FriendFeedInfoMenu : AbstractMenu() {
</a> 
         rules.forEach { ruleFeature -&gt;
             if (!friendFeedMenuOptions.contains(ruleFeature.ruleType.key)) return@forEach
<a href="#h99-2-3" id="h99-2-3" class="d">-            Logger.debug(&quot;${ruleFeature.ruleType.key} ${ruleFeature.getRuleState()}&quot;)
</a> 
             val ruleState = ruleFeature.getRuleState() ?: return@forEach
             createToggleFeature(viewConsumer,
<b>diff --git a/<a id="h100" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/OperaContextActionMenu.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/OperaContextActionMenu.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/OperaContextActionMenu.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/OperaContextActionMenu.kt</a></b>
<a href="#h100-0" id="h100-0" class="h">@@ -8,7 +8,6 @@ import android.widget.Button
</a> import android.widget.LinearLayout
 import android.widget.ScrollView
 import me.rhunk.snapenhance.Constants
<a href="#h100-0-3" id="h100-0-3" class="d">-import me.rhunk.snapenhance.Logger
</a> import me.rhunk.snapenhance.features.impl.downloader.MediaDownloader
 import me.rhunk.snapenhance.ui.ViewAppearanceHelper.applyTheme
 import me.rhunk.snapenhance.ui.menu.AbstractMenu
<a href="#h100-1" id="h100-1" class="h">@@ -76,7 +75,7 @@ class OperaContextActionMenu : AbstractMenu() {
</a>             linearLayout.addView(button)
             (childView as ViewGroup).addView(linearLayout, 0)
         } catch (e: Throwable) {
<a href="#h100-1-3" id="h100-1-3" class="d">-            Logger.xposedLog(e)
</a><a href="#h100-1-4" id="h100-1-4" class="i">+            context.log.error(&quot;Error while injecting OperaContextActionMenu&quot;, e)
</a>         }
     }
 }
<b>diff --git a/<a id="h101" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/SettingsMenu.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/SettingsMenu.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/SettingsMenu.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/SettingsMenu.kt</a></b>
<a href="#h101-0" id="h101-0" class="h">@@ -2,15 +2,13 @@ package me.rhunk.snapenhance.ui.menu.impl
</a> 
 import android.annotation.SuppressLint
 import android.view.View
<a href="#h101-0-3" id="h101-0-3" class="d">-import android.widget.Button
</a><a href="#h101-0-4" id="h101-0-4" class="d">-import me.rhunk.snapenhance.ui.ViewAppearanceHelper
</a> import me.rhunk.snapenhance.ui.menu.AbstractMenu
 
 class SettingsMenu : AbstractMenu() {
     //TODO: quick settings
     @SuppressLint(&quot;SetTextI18n&quot;)
     fun inject(viewModel: View, addView: (View) -&gt; Unit) {
<a href="#h101-0-11" id="h101-0-11" class="d">-        val actions = context.actionManager.getActions().map {
</a><a href="#h101-0-12" id="h101-0-12" class="i">+        /*val actions = context.actionManager.getActions().map {
</a>             Pair(it) {
                 val button = Button(viewModel.context)
                 button.text = context.translation[it.nameKey]
<a href="#h101-1" id="h101-1" class="h">@@ -25,6 +23,6 @@ class SettingsMenu : AbstractMenu() {
</a> 
         actions.forEach {
             addView(it.second())
<a href="#h101-1-3" id="h101-1-3" class="d">-        }
</a><a href="#h101-1-4" id="h101-1-4" class="i">+        }*/
</a>     }
 } 
\ No newline at end of file
<b>diff --git a/<a id="h102" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/util/SQLiteDatabaseHelper.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/util/SQLiteDatabaseHelper.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/util/SQLiteDatabaseHelper.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/util/SQLiteDatabaseHelper.kt</a></b>
<a href="#h102-0" id="h102-0" class="h">@@ -23,7 +23,7 @@ object SQLiteDatabaseHelper {
</a> 
             if (newColumns.isEmpty()) return@forEach
 
<a href="#h102-0-3" id="h102-0-3" class="d">-            Logger.log(&quot;Schema for table $tableName has changed&quot;)
</a><a href="#h102-0-4" id="h102-0-4" class="i">+            Logger.directDebug(&quot;Schema for table $tableName has changed&quot;)
</a>             sqLiteDatabase.execSQL(&quot;DROP TABLE $tableName&quot;)
             sqLiteDatabase.execSQL(&quot;CREATE TABLE IF NOT EXISTS $tableName (${columns.joinToString(&quot;, &quot;)})&quot;)
         }
<b>diff --git a/<a id="h103" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/util/download/HttpServer.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/util/download/HttpServer.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/util/download/HttpServer.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/util/download/HttpServer.kt</a></b>
<a href="#h103-0" id="h103-0" class="h">@@ -37,7 +37,7 @@ class HttpServer(
</a>         }
 
         coroutineScope.launch(Dispatchers.IO) {
<a href="#h103-0-3" id="h103-0-3" class="d">-            Logger.debug(&quot;starting http server on port $port&quot;)
</a><a href="#h103-0-4" id="h103-0-4" class="i">+            Logger.directDebug(&quot;starting http server on port $port&quot;)
</a>             serverSocket = ServerSocket(port)
             callback(this@HttpServer)
             while (!serverSocket!!.isClosed) {
<a href="#h103-1" id="h103-1" class="h">@@ -48,21 +48,21 @@ class HttpServer(
</a>                         handleRequest(socket)
                         timeoutJob = launch {
                             delay(timeout.toLong())
<a href="#h103-1-3" id="h103-1-3" class="d">-                            Logger.debug(&quot;http server closed due to timeout&quot;)
</a><a href="#h103-1-4" id="h103-1-4" class="i">+                            Logger.directDebug(&quot;http server closed due to timeout&quot;)
</a>                             runCatching {
                                 socketJob?.cancel()
                                 socket.close()
                                 serverSocket?.close()
                             }.onFailure {
<a href="#h103-1-10" id="h103-1-10" class="d">-                                Logger.error(it)
</a><a href="#h103-1-11" id="h103-1-11" class="i">+                                Logger.directError(&quot;failed to close socket&quot;, it)
</a>                             }
                         }
                     }
                 } catch (e: SocketException) {
<a href="#h103-1-16" id="h103-1-16" class="d">-                    Logger.debug(&quot;http server timed out&quot;)
</a><a href="#h103-1-17" id="h103-1-17" class="i">+                    Logger.directDebug(&quot;http server timed out&quot;)
</a>                     break;
                 } catch (e: Throwable) {
<a href="#h103-1-20" id="h103-1-20" class="d">-                    Logger.error(&quot;failed to handle request&quot;, e)
</a><a href="#h103-1-21" id="h103-1-21" class="i">+                    Logger.directError(&quot;failed to handle request&quot;, e)
</a>                 }
             }
         }.also { socketJob = it }
<a href="#h103-2" id="h103-2" class="h">@@ -90,13 +90,13 @@ class HttpServer(
</a>                 outputStream.close()
                 socket.close()
             }.onFailure {
<a href="#h103-2-3" id="h103-2-3" class="d">-                Logger.error(&quot;failed to close socket&quot;, it)
</a><a href="#h103-2-4" id="h103-2-4" class="i">+                Logger.directError(&quot;failed to close socket&quot;, it)
</a>             }
         }
         val parse = StringTokenizer(line)
         val method = parse.nextToken().uppercase(Locale.getDefault())
         var fileRequested = parse.nextToken().lowercase(Locale.getDefault())
<a href="#h103-2-10" id="h103-2-10" class="d">-        Logger.debug(&quot;[http-server:${port}] $method $fileRequested&quot;)
</a><a href="#h103-2-11" id="h103-2-11" class="i">+        Logger.directDebug(&quot;[http-server:${port}] $method $fileRequested&quot;)
</a> 
         if (method != &quot;GET&quot;) {
             with(writer) {
<b>diff --git a/<a id="h104" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/util/download/RemoteMediaResolver.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/util/download/RemoteMediaResolver.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/util/download/RemoteMediaResolver.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/util/download/RemoteMediaResolver.kt</a></b>
<a href="#h104-0" id="h104-0" class="h">@@ -44,7 +44,7 @@ object RemoteMediaResolver {
</a> 
         okHttpClient.newCall(request).execute().use { response -&gt;
             if (!response.isSuccessful) {
<a href="#h104-0-3" id="h104-0-3" class="d">-                Logger.log(&quot;Unexpected code $response&quot;)
</a><a href="#h104-0-4" id="h104-0-4" class="i">+                Logger.directDebug(&quot;Unexpected code $response&quot;)
</a>                 return null
             }
             return ByteArrayInputStream(response.body.bytes())
<b>diff --git a/<a id="h105" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/util/export/MessageExporter.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/util/export/MessageExporter.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/util/export/MessageExporter.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/util/export/MessageExporter.kt</a></b>
<a href="#h105-0" id="h105-0" class="h">@@ -9,16 +9,15 @@ import kotlinx.coroutines.Dispatchers
</a> import kotlinx.coroutines.async
 import kotlinx.coroutines.awaitAll
 import kotlinx.coroutines.withContext
<a href="#h105-0-3" id="h105-0-3" class="d">-import me.rhunk.snapenhance.Logger
</a> import me.rhunk.snapenhance.ModContext
 import me.rhunk.snapenhance.core.BuildConfig
<a href="#h105-0-6" id="h105-0-6" class="i">+import me.rhunk.snapenhance.core.database.objects.FriendFeedEntry
</a><a href="#h105-0-7" id="h105-0-7" class="i">+import me.rhunk.snapenhance.core.database.objects.FriendInfo
</a> import me.rhunk.snapenhance.data.ContentType
 import me.rhunk.snapenhance.data.FileType
 import me.rhunk.snapenhance.data.MediaReferenceType
 import me.rhunk.snapenhance.data.wrapper.impl.Message
 import me.rhunk.snapenhance.data.wrapper.impl.SnapUUID
<a href="#h105-0-13" id="h105-0-13" class="d">-import me.rhunk.snapenhance.database.objects.FriendFeedEntry
</a><a href="#h105-0-14" id="h105-0-14" class="d">-import me.rhunk.snapenhance.database.objects.FriendInfo
</a> import me.rhunk.snapenhance.util.protobuf.ProtoReader
 import me.rhunk.snapenhance.util.snap.EncryptionHelper
 import me.rhunk.snapenhance.util.snap.MediaDownloaderHelper
<a href="#h105-1" id="h105-1" class="h">@@ -138,7 +137,7 @@ class MessageExporter(
</a>                             }
                         }.onFailure {
                             printLog(&quot;failed to download media for ${message.messageDescriptor.conversationId}_${message.orderKey}&quot;)
<a href="#h105-1-3" id="h105-1-3" class="d">-                            Logger.error(&quot;failed to download media for ${message.messageDescriptor.conversationId}_${message.orderKey}&quot;, it)
</a><a href="#h105-1-4" id="h105-1-4" class="i">+                            context.log.error(&quot;failed to download media for ${message.messageDescriptor.conversationId}_${message.orderKey}&quot;, it)
</a>                         }
                     }
                 }
<a href="#h105-2" id="h105-2" class="h">@@ -219,7 +218,7 @@ class MessageExporter(
</a>             }
         }.onFailure {
             printLog(&quot;failed to read template from apk&quot;)
<a href="#h105-2-3" id="h105-2-3" class="d">-            Logger.error(&quot;failed to read template from apk&quot;, it)
</a><a href="#h105-2-4" id="h105-2-4" class="i">+            context.log.error(&quot;failed to read template from apk&quot;, it)
</a>         }
 
         output.write(&quot;&lt;/html&gt;&quot;.toByteArray())
<b>diff --git a/<a id="h106" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/util/snap/MediaDownloaderHelper.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/util/snap/MediaDownloaderHelper.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/util/snap/MediaDownloaderHelper.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/util/snap/MediaDownloaderHelper.kt</a></b>
<a href="#h106-0" id="h106-0" class="h">@@ -4,9 +4,9 @@ import com.arthenica.ffmpegkit.FFmpegKit
</a> import com.arthenica.ffmpegkit.FFmpegSession
 import kotlinx.coroutines.suspendCancellableCoroutine
 import me.rhunk.snapenhance.Constants
<a href="#h106-0-3" id="h106-0-3" class="i">+import me.rhunk.snapenhance.core.download.data.SplitMediaAssetType
</a> import me.rhunk.snapenhance.data.ContentType
 import me.rhunk.snapenhance.data.FileType
<a href="#h106-0-6" id="h106-0-6" class="d">-import me.rhunk.snapenhance.download.data.SplitMediaAssetType
</a> import me.rhunk.snapenhance.util.download.RemoteMediaResolver
 import me.rhunk.snapenhance.util.protobuf.ProtoReader
 import java.io.ByteArrayInputStream
</pre>
</div>
</body>
</html>
