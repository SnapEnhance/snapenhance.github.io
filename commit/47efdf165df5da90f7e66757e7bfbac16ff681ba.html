<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>feat(core/security_features): better explanation of login response - SnapEnhance - An Xposed module offering an enhanced Snapchat experience
</title>
<link rel="icon" type="image/svg+xml" href="../../logo.png"/>
<link rel="alternate icon" href="../../favicon.png"/>
<link rel="alternate" type="application/atom+xml" title="SnapEnhance Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="SnapEnhance Atom Feed (tags)" href="../tags.xml" />
<link rel="stylesheet" type="text/css" href="../../style.css" />
<link rel="stylesheet" type="text/css" href="../../fonts.css" />
</head>
<body>
<div id="head"><table><tr><td><a class="logo" href="../../"><img src="../../logo.png" alt="" width="32" height="32" /></a></td><td><strong>SnapEnhance</strong><span class="desc"> - An Xposed module offering an enhanced Snapchat experience
</span>
</td></tr></table>
<p><a href="../about.html">About</a> | <a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/LICENSE.html">License</a></p>
</div>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/47efdf165df5da90f7e66757e7bfbac16ff681ba.html">47efdf165df5da90f7e66757e7bfbac16ff681ba</a>
<b>parent</b> <a href="../commit/ef1566add266cab963b3da458efd4673f01cbe33.html">ef1566add266cab963b3da458efd4673f01cbe33</a>
<b>Author:</b> rhunk &lt;<a href="mailto:101876869+rhunk@users.noreply.github.com">101876869+rhunk@users.noreply.github.com</a>&gt;
<b>Date:</b>   Fri, 16 Aug 2024 12:57:45 +0200

feat(core/security_features): better explanation of login response

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">app/src/main/kotlin/me/rhunk/snapenhance/RemoteSharedLibraryManager.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/home/HomeRootSection.kt</a></td><td> | </td><td class="num">9</td><td><span class="i">+++++++</span><span class="d">--</span></td></tr>
<tr><td class="A">A</td><td><a href="#h2">app/src/main/res/drawable/ic_codeberg.xml</a></td><td> | </td><td class="num">11</td><td><span class="i">+++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h3">common/build.gradle.kts</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h4">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/SecurityFeatures.kt</a></td><td> | </td><td class="num">60</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">----------</span></td></tr>
</table></pre><pre>5 files changed, 70 insertions(+), 14 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/RemoteSharedLibraryManager.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/RemoteSharedLibraryManager.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/RemoteSharedLibraryManager.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/RemoteSharedLibraryManager.kt</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -103,7 +103,7 @@ class RemoteSharedLibraryManager(
</a>                             0,
                             Intent().apply {
                                 action = Intent.ACTION_VIEW
<a href="#h0-0-3" id="h0-0-3" class="d">-                                data = &quot;https://github.com/SnapEnhance/resources&quot;.toUri()
</a><a href="#h0-0-4" id="h0-0-4" class="i">+                                data = &quot;https://codeberg.org/SnapEnhance/resources&quot;.toUri()
</a>                                 flags = Intent.FLAG_ACTIVITY_NEW_TASK
                             },
                             PendingIntent.FLAG_UPDATE_CURRENT
<b>diff --git a/<a id="h1" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/home/HomeRootSection.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/home/HomeRootSection.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/home/HomeRootSection.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/home/HomeRootSection.kt</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -179,6 +179,11 @@ class HomeRootSection : Routes.Route() {
</a>                     .padding(all = 10.dp)
             ) {
                 ExternalLinkIcon(
<a href="#h1-0-3" id="h1-0-3" class="i">+                    imageVector = ImageVector.vectorResource(id = R.drawable.ic_codeberg),
</a><a href="#h1-0-4" id="h1-0-4" class="i">+                    link = &quot;https://codeberg.org/SnapEnhance/SnapEnhance&quot;
</a><a href="#h1-0-5" id="h1-0-5" class="i">+                )
</a><a href="#h1-0-6" id="h1-0-6" class="i">+
</a><a href="#h1-0-7" id="h1-0-7" class="i">+                ExternalLinkIcon(
</a>                     imageVector = ImageVector.vectorResource(id = R.drawable.ic_telegram),
                     link = &quot;https://t.me/snapenhance&quot;
                 )
<a href="#h1-1" id="h1-1" class="h">@@ -189,8 +194,8 @@ class HomeRootSection : Routes.Route() {
</a>                 )
 
                 ExternalLinkIcon(
<a href="#h1-1-3" id="h1-1-3" class="d">-                    size = 36.dp,
</a><a href="#h1-1-4" id="h1-1-4" class="d">-                    modifier = Modifier.offset(y = (-2).dp),
</a><a href="#h1-1-5" id="h1-1-5" class="i">+                    size = 38.dp,
</a><a href="#h1-1-6" id="h1-1-6" class="i">+                    modifier = Modifier.offset(x = (-3).dp, y = (-3).dp),
</a>                     imageVector = Icons.AutoMirrored.Default.Help,
                     link = &quot;https://github.com/rhunk/SnapEnhance/wiki&quot;
                 )
<b>diff --git a/<a id="h2" href="../file/app/src/main/res/drawable/ic_codeberg.xml.html">app/src/main/res/drawable/ic_codeberg.xml</a> b/<a href="../file/app/src/main/res/drawable/ic_codeberg.xml.html">app/src/main/res/drawable/ic_codeberg.xml</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -0,0 +1,11 @@
</a><a href="#h2-0-0" id="h2-0-0" class="i">+&lt;vector xmlns:aapt=&quot;http://schemas.android.com/aapt&quot; xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot; android:height=&quot;24dp&quot; android:viewportHeight=&quot;4.233&quot; android:viewportWidth=&quot;4.233&quot; android:width=&quot;24dp&quot;&gt;
</a><a href="#h2-0-1" id="h2-0-1" class="i">+    &lt;path android:pathData=&quot;M2.1744,1.1041c-0.0055,0 -0.0106,0.0019 -0.0141,0.0051s-0.0049,0.0073 -0.0038,0.0113l0.8154,3.0565a2.1166,2.1166 135,0 0,0.9561 -0.8198l-1.7375,-2.2463c-0.0034,-0.0042 -0.0095,-0.0068 -0.0161,-0.0068z&quot; android:strokeColor=&quot;#00000000&quot; android:strokeWidth=&quot;1&quot;&gt;
</a><a href="#h2-0-2" id="h2-0-2" class="i">+        &lt;aapt:attr name=&quot;android:fillColor&quot;&gt;
</a><a href="#h2-0-3" id="h2-0-3" class="i">+            &lt;gradient android:endX=&quot;3.5352&quot; android:endY=&quot;3.8199&quot; android:startX=&quot;2.1744&quot; android:startY=&quot;1.1041&quot; android:type=&quot;linear&quot;&gt;
</a><a href="#h2-0-4" id="h2-0-4" class="i">+                &lt;item android:color=&quot;#00000000&quot; android:offset=&quot;0&quot;/&gt;
</a><a href="#h2-0-5" id="h2-0-5" class="i">+                &lt;item android:color=&quot;#4C000000&quot; android:offset=&quot;0.495&quot;/&gt;
</a><a href="#h2-0-6" id="h2-0-6" class="i">+            &lt;/gradient&gt;
</a><a href="#h2-0-7" id="h2-0-7" class="i">+        &lt;/aapt:attr&gt;
</a><a href="#h2-0-8" id="h2-0-8" class="i">+    &lt;/path&gt;
</a><a href="#h2-0-9" id="h2-0-9" class="i">+    &lt;path android:fillColor=&quot;#ffffff&quot; android:pathData=&quot;M2.113,0.12C0.944,0.12 -0.004,1.067 -0.004,2.236c0,0.398 0.112,0.787 0.323,1.124l1.765,-2.282c0.013,-0.016 0.045,-0.016 0.057,0l1.765,2.282c0.211,-0.337 0.323,-0.727 0.323,-1.124C4.23,1.067 3.282,0.12 2.113,0.12z&quot;/&gt;
</a><a href="#h2-0-10" id="h2-0-10" class="i">+&lt;/vector&gt;
</a><b>diff --git a/<a id="h3" href="../file/common/build.gradle.kts.html">common/build.gradle.kts</a> b/<a href="../file/common/build.gradle.kts.html">common/build.gradle.kts</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -30,7 +30,7 @@ android {
</a>             standardOutput = gitHash
         }
         buildConfigField(&quot;String&quot;, &quot;GIT_HASH&quot;, &quot;\&quot;${gitHash.toString(Charsets.UTF_8).trim()}\&quot;&quot;)
<a href="#h3-0-3" id="h3-0-3" class="d">-        buildConfigField(&quot;String&quot;, &quot;SIF_ENDPOINT&quot;, &quot;\&quot;${properties[&quot;debug_sif_endpoint&quot;]?.toString() ?: &quot;https://raw.githubusercontent.com/SnapEnhance/resources/main/sif&quot;}\&quot;&quot;)
</a><a href="#h3-0-4" id="h3-0-4" class="i">+        buildConfigField(&quot;String&quot;, &quot;SIF_ENDPOINT&quot;, &quot;\&quot;${properties[&quot;debug_sif_endpoint&quot;]?.toString() ?: &quot;https://codeberg.org/SnapEnhance/resources/raw/branch/main/sif&quot;}\&quot;&quot;)
</a>     }
 
     compileOptions {
<b>diff --git a/<a id="h4" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/SecurityFeatures.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/SecurityFeatures.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/SecurityFeatures.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/SecurityFeatures.kt</a></b>
<a href="#h4-0" id="h4-0" class="h">@@ -5,11 +5,7 @@ import androidx.compose.foundation.background
</a> import androidx.compose.foundation.layout.padding
 import androidx.compose.foundation.shape.RoundedCornerShape
 import androidx.compose.material3.Text
<a href="#h4-0-3" id="h4-0-3" class="d">-import androidx.compose.runtime.LaunchedEffect
</a><a href="#h4-0-4" id="h4-0-4" class="d">-import androidx.compose.runtime.getValue
</a><a href="#h4-0-5" id="h4-0-5" class="d">-import androidx.compose.runtime.mutableStateOf
</a><a href="#h4-0-6" id="h4-0-6" class="d">-import androidx.compose.runtime.remember
</a><a href="#h4-0-7" id="h4-0-7" class="d">-import androidx.compose.runtime.setValue
</a><a href="#h4-0-8" id="h4-0-8" class="i">+import androidx.compose.runtime.*
</a> import androidx.compose.ui.Alignment
 import androidx.compose.ui.Modifier
 import androidx.compose.ui.graphics.Color
<a href="#h4-1" id="h4-1" class="h">@@ -18,22 +14,66 @@ import androidx.compose.ui.unit.sp
</a> import kotlinx.coroutines.Dispatchers
 import kotlinx.coroutines.delay
 import kotlinx.coroutines.withContext
<a href="#h4-1-3" id="h4-1-3" class="i">+import me.rhunk.snapenhance.common.util.protobuf.ProtoEditor
</a><a href="#h4-1-4" id="h4-1-4" class="i">+import me.rhunk.snapenhance.common.util.protobuf.ProtoReader
</a><a href="#h4-1-5" id="h4-1-5" class="i">+import me.rhunk.snapenhance.core.event.events.impl.UnaryCallEvent
</a> import me.rhunk.snapenhance.core.features.Feature
<a href="#h4-1-7" id="h4-1-7" class="i">+import me.rhunk.snapenhance.core.util.ktx.setObjectField
</a><a href="#h4-1-8" id="h4-1-8" class="i">+import java.io.FileDescriptor
</a> 
 class SecurityFeatures : Feature(&quot;Security Features&quot;) {
<a href="#h4-1-11" id="h4-1-11" class="d">-    private fun transact(option: Int) = Os.prctl(option, 0, 0, 0, 0)
</a><a href="#h4-1-12" id="h4-1-12" class="i">+    private fun transact(option: Int, option2: Long) = kotlin.runCatching { Os.prctl(option, option2, 0, 0, 0) }.getOrNull()
</a> 
     private val token by lazy {
<a href="#h4-1-15" id="h4-1-15" class="d">-        runCatching { transact(0) }.getOrNull()
</a><a href="#h4-1-16" id="h4-1-16" class="i">+        transact(0, 0)
</a>     }
 
     private fun getStatus() = token?.run {
<a href="#h4-1-20" id="h4-1-20" class="d">-        transact(this).toString(2).padStart(32, &#39;0&#39;).count { it == &#39;1&#39; }
</a><a href="#h4-1-21" id="h4-1-21" class="i">+        transact(this, 0)?.toString(2)?.padStart(32, &#39;0&#39;)?.count { it == &#39;1&#39; }
</a>     }
 
     override fun init() {
         token // pre init token
 
<a href="#h4-1-27" id="h4-1-27" class="i">+        context.event.subscribe(UnaryCallEvent::class) { event -&gt;
</a><a href="#h4-1-28" id="h4-1-28" class="i">+            if (!event.uri.contains(&quot;/Login&quot;)) return@subscribe
</a><a href="#h4-1-29" id="h4-1-29" class="i">+
</a><a href="#h4-1-30" id="h4-1-30" class="i">+            // intercept login response
</a><a href="#h4-1-31" id="h4-1-31" class="i">+            event.addResponseCallback {
</a><a href="#h4-1-32" id="h4-1-32" class="i">+                val response = ProtoReader(buffer)
</a><a href="#h4-1-33" id="h4-1-33" class="i">+                val isBlocked = when {
</a><a href="#h4-1-34" id="h4-1-34" class="i">+                    event.uri.contains(&quot;TLv&quot;) -&gt; response.getVarInt(1) == 14L
</a><a href="#h4-1-35" id="h4-1-35" class="i">+                    else -&gt; response.getVarInt(1) == 16L
</a><a href="#h4-1-36" id="h4-1-36" class="i">+                }
</a><a href="#h4-1-37" id="h4-1-37" class="i">+
</a><a href="#h4-1-38" id="h4-1-38" class="i">+                val errorDataIndex = when {
</a><a href="#h4-1-39" id="h4-1-39" class="i">+                    response.contains(11) -&gt; 11
</a><a href="#h4-1-40" id="h4-1-40" class="i">+                    response.contains(10) -&gt; 10
</a><a href="#h4-1-41" id="h4-1-41" class="i">+                    response.contains(8) -&gt; 8
</a><a href="#h4-1-42" id="h4-1-42" class="i">+                    else -&gt; return@addResponseCallback
</a><a href="#h4-1-43" id="h4-1-43" class="i">+                }
</a><a href="#h4-1-44" id="h4-1-44" class="i">+
</a><a href="#h4-1-45" id="h4-1-45" class="i">+                if (isBlocked) {
</a><a href="#h4-1-46" id="h4-1-46" class="i">+                    val status = transact(token ?: return@addResponseCallback, 1)?.let {
</a><a href="#h4-1-47" id="h4-1-47" class="i">+                        val buffer = ByteArray(8192)
</a><a href="#h4-1-48" id="h4-1-48" class="i">+                        val fd = FileDescriptor().apply {
</a><a href="#h4-1-49" id="h4-1-49" class="i">+                            setObjectField(&quot;descriptor&quot;, it)
</a><a href="#h4-1-50" id="h4-1-50" class="i">+                        }
</a><a href="#h4-1-51" id="h4-1-51" class="i">+                        val read = Os.read(fd, buffer, 0, buffer.size)
</a><a href="#h4-1-52" id="h4-1-52" class="i">+                        Os.close(fd)
</a><a href="#h4-1-53" id="h4-1-53" class="i">+                        buffer.copyOfRange(0, read).decodeToString()
</a><a href="#h4-1-54" id="h4-1-54" class="i">+                    }!!
</a><a href="#h4-1-55" id="h4-1-55" class="i">+
</a><a href="#h4-1-56" id="h4-1-56" class="i">+                    buffer = ProtoEditor(buffer).apply {
</a><a href="#h4-1-57" id="h4-1-57" class="i">+                        edit(errorDataIndex) {
</a><a href="#h4-1-58" id="h4-1-58" class="i">+                            remove(1)
</a><a href="#h4-1-59" id="h4-1-59" class="i">+                            addString(1, status)
</a><a href="#h4-1-60" id="h4-1-60" class="i">+                        }
</a><a href="#h4-1-61" id="h4-1-61" class="i">+                    }.toByteArray()
</a><a href="#h4-1-62" id="h4-1-62" class="i">+                }
</a><a href="#h4-1-63" id="h4-1-63" class="i">+            }
</a><a href="#h4-1-64" id="h4-1-64" class="i">+        }
</a><a href="#h4-1-65" id="h4-1-65" class="i">+
</a>         context.inAppOverlay.addCustomComposable {
             var statusText by remember {
                 mutableStateOf(&quot;&quot;)
<a href="#h4-2" id="h4-2" class="h">@@ -49,10 +89,10 @@ class SecurityFeatures : Feature(&quot;Security Features&quot;) {
</a>                         withContext(Dispatchers.Main) {
                             if (status == null || status == 0) {
                                 textColor = Color.Red
<a href="#h4-2-3" id="h4-2-3" class="d">-                                statusText = &quot;sif not loaded. Can&#39;t get status&quot;
</a><a href="#h4-2-4" id="h4-2-4" class="i">+                                statusText = &quot;SIF not loaded!&quot;
</a>                             } else {
                                 textColor = Color.Green
<a href="#h4-2-7" id="h4-2-7" class="d">-                                statusText = &quot;sif = $status&quot;
</a><a href="#h4-2-8" id="h4-2-8" class="i">+                                statusText = &quot;SIF = $status&quot;
</a>                             }
                         }
                         delay(1000)
</pre>
</div>
</body>
</html>
