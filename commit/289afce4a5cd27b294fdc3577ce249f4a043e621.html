<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>package refactor - SnapEnhance - An Xposed module offering an enhanced Snapchat experience
</title>
<link rel="icon" type="image/svg+xml" href="../../logo.png"/>
<link rel="alternate icon" href="../../favicon.png"/>
<link rel="alternate" type="application/atom+xml" title="SnapEnhance Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="SnapEnhance Atom Feed (tags)" href="../tags.xml" />
<link rel="stylesheet" type="text/css" href="../../style.css" />
<link rel="stylesheet" type="text/css" href="../../fonts.css" />
</head>
<body>
<div id="head"><table><tr><td><a class="logo" href="../../"><img src="../../logo.png" alt="" width="32" height="32" /></a></td><td><strong>SnapEnhance</strong><span class="desc"> - An Xposed module offering an enhanced Snapchat experience
</span>
</td></tr></table>
<p><a href="../about.html">About</a> | <a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/LICENSE.html">License</a></p>
</div>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/289afce4a5cd27b294fdc3577ce249f4a043e621.html">289afce4a5cd27b294fdc3577ce249f4a043e621</a>
<b>parent</b> <a href="../commit/8e87e7c84d100c55ef05bc475df12b0de01c6233.html">8e87e7c84d100c55ef05bc475df12b0de01c6233</a>
<b>Author:</b> rhunk &lt;<a href="mailto:101876869+rhunk@users.noreply.github.com">101876869+rhunk@users.noreply.github.com</a>&gt;
<b>Date:</b>   Sun,  6 Aug 2023 22:07:53 +0200

package refactor

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">app/build.gradle.kts</a></td><td> | </td><td class="num">1</td><td><span class="i">+</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">app/src/main/AndroidManifest.xml</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="A">A</td><td><a href="#h2">app/src/main/kotlin/me/rhunk/snapenhance/ui/MapActivity.kt</a></td><td> | </td><td class="num">98</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h3">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/downloads/DownloadsSection.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="A">A</td><td><a href="#h4">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/features/PickLocation.kt</a></td><td> | </td><td class="num">5</td><td><span class="i">+++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h5">core/build.gradle.kts</a></td><td> | </td><td class="num">1</td><td><span class="i"></span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h6">core/src/main/kotlin/me/rhunk/snapenhance/action/impl/OpenMap.kt</a></td><td> | </td><td class="num">3</td><td><span class="i">+</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h7">core/src/main/kotlin/me/rhunk/snapenhance/download/DownloadTaskManager.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="A">A</td><td><a href="#h8">core/src/main/kotlin/me/rhunk/snapenhance/download/data/MediaFilter.kt</a></td><td> | </td><td class="num">18</td><td><span class="i">++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h9">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/MediaDownloader.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="D">D</td><td><a href="#h10">core/src/main/kotlin/me/rhunk/snapenhance/ui/download/DebugSettingsLayoutInflater.kt</a></td><td> | </td><td class="num">105</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h11">core/src/main/kotlin/me/rhunk/snapenhance/ui/download/DownloadListAdapter.kt</a></td><td> | </td><td class="num">243</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h12">core/src/main/kotlin/me/rhunk/snapenhance/ui/download/DownloadManagerActivity.kt</a></td><td> | </td><td class="num">215</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h13">core/src/main/kotlin/me/rhunk/snapenhance/ui/download/MediaFilter.kt</a></td><td> | </td><td class="num">18</td><td><span class="i"></span><span class="d">------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h14">core/src/main/kotlin/me/rhunk/snapenhance/ui/map/MapActivity.kt</a></td><td> | </td><td class="num">98</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
</table></pre><pre>15 files changed, 127 insertions(+), 686 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/app/build.gradle.kts.html">app/build.gradle.kts</a> b/<a href="../file/app/build.gradle.kts.html">app/build.gradle.kts</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -101,6 +101,7 @@ dependencies {
</a>     implementation(libs.gson)
     implementation(libs.coil.compose)
     implementation(libs.coil.video)
<a href="#h0-0-3" id="h0-0-3" class="i">+    implementation(libs.osmdroid.android)
</a> 
     debugImplementation(&quot;androidx.compose.ui:ui-tooling:1.4.3&quot;)
     implementation(&quot;androidx.compose.ui:ui-tooling-preview:1.4.3&quot;)
<b>diff --git a/<a id="h1" href="../file/app/src/main/AndroidManifest.xml.html">app/src/main/AndroidManifest.xml</a> b/<a href="../file/app/src/main/AndroidManifest.xml.html">app/src/main/AndroidManifest.xml</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -52,7 +52,7 @@
</a>             android:theme=&quot;@style/AppTheme&quot;
             android:excludeFromRecents=&quot;true&quot; /&gt;
         &lt;activity
<a href="#h1-0-3" id="h1-0-3" class="d">-            android:name=&quot;.ui.map.MapActivity&quot;
</a><a href="#h1-0-4" id="h1-0-4" class="i">+            android:name=&quot;.ui.MapActivity&quot;
</a>             android:exported=&quot;true&quot;
             android:excludeFromRecents=&quot;true&quot; /&gt;
         &lt;activity android:name=&quot;.bridge.ForceStartActivity&quot;
<b>diff --git a/<a id="h2" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/MapActivity.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/MapActivity.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/MapActivity.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/MapActivity.kt</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -0,0 +1,98 @@
</a><a href="#h2-0-0" id="h2-0-0" class="i">+package me.rhunk.snapenhance.ui
</a><a href="#h2-0-1" id="h2-0-1" class="i">+
</a><a href="#h2-0-2" id="h2-0-2" class="i">+import android.annotation.SuppressLint
</a><a href="#h2-0-3" id="h2-0-3" class="i">+import android.app.Activity
</a><a href="#h2-0-4" id="h2-0-4" class="i">+import android.app.AlertDialog
</a><a href="#h2-0-5" id="h2-0-5" class="i">+import android.content.Context
</a><a href="#h2-0-6" id="h2-0-6" class="i">+import android.os.Bundle
</a><a href="#h2-0-7" id="h2-0-7" class="i">+import android.view.MotionEvent
</a><a href="#h2-0-8" id="h2-0-8" class="i">+import android.widget.Button
</a><a href="#h2-0-9" id="h2-0-9" class="i">+import android.widget.EditText
</a><a href="#h2-0-10" id="h2-0-10" class="i">+import me.rhunk.snapenhance.core.R
</a><a href="#h2-0-11" id="h2-0-11" class="i">+import org.osmdroid.config.Configuration
</a><a href="#h2-0-12" id="h2-0-12" class="i">+import org.osmdroid.tileprovider.tilesource.TileSourceFactory
</a><a href="#h2-0-13" id="h2-0-13" class="i">+import org.osmdroid.util.GeoPoint
</a><a href="#h2-0-14" id="h2-0-14" class="i">+import org.osmdroid.views.MapView
</a><a href="#h2-0-15" id="h2-0-15" class="i">+import org.osmdroid.views.Projection
</a><a href="#h2-0-16" id="h2-0-16" class="i">+import org.osmdroid.views.overlay.Marker
</a><a href="#h2-0-17" id="h2-0-17" class="i">+import org.osmdroid.views.overlay.Overlay
</a><a href="#h2-0-18" id="h2-0-18" class="i">+
</a><a href="#h2-0-19" id="h2-0-19" class="i">+
</a><a href="#h2-0-20" id="h2-0-20" class="i">+class MapActivity : Activity() {
</a><a href="#h2-0-21" id="h2-0-21" class="i">+
</a><a href="#h2-0-22" id="h2-0-22" class="i">+    private lateinit var mapView: MapView
</a><a href="#h2-0-23" id="h2-0-23" class="i">+
</a><a href="#h2-0-24" id="h2-0-24" class="i">+    @SuppressLint(&quot;MissingInflatedId&quot;, &quot;ResourceType&quot;)
</a><a href="#h2-0-25" id="h2-0-25" class="i">+    override fun onCreate(savedInstanceState: Bundle?) {
</a><a href="#h2-0-26" id="h2-0-26" class="i">+        super.onCreate(savedInstanceState)
</a><a href="#h2-0-27" id="h2-0-27" class="i">+
</a><a href="#h2-0-28" id="h2-0-28" class="i">+        val contextBundle = intent.extras?.getBundle(&quot;location&quot;) ?: return
</a><a href="#h2-0-29" id="h2-0-29" class="i">+        val locationLatitude = contextBundle.getDouble(&quot;latitude&quot;)
</a><a href="#h2-0-30" id="h2-0-30" class="i">+        val locationLongitude = contextBundle.getDouble(&quot;longitude&quot;)
</a><a href="#h2-0-31" id="h2-0-31" class="i">+
</a><a href="#h2-0-32" id="h2-0-32" class="i">+        Configuration.getInstance().load(applicationContext, getSharedPreferences(&quot;osmdroid&quot;, Context.MODE_PRIVATE))
</a><a href="#h2-0-33" id="h2-0-33" class="i">+
</a><a href="#h2-0-34" id="h2-0-34" class="i">+        setContentView(R.layout.map)
</a><a href="#h2-0-35" id="h2-0-35" class="i">+
</a><a href="#h2-0-36" id="h2-0-36" class="i">+        mapView = findViewById(R.id.mapView)
</a><a href="#h2-0-37" id="h2-0-37" class="i">+        mapView.setMultiTouchControls(true);
</a><a href="#h2-0-38" id="h2-0-38" class="i">+        mapView.setTileSource(TileSourceFactory.MAPNIK)
</a><a href="#h2-0-39" id="h2-0-39" class="i">+
</a><a href="#h2-0-40" id="h2-0-40" class="i">+        val startPoint = GeoPoint(locationLatitude, locationLongitude)
</a><a href="#h2-0-41" id="h2-0-41" class="i">+        mapView.controller.setZoom(10.0)
</a><a href="#h2-0-42" id="h2-0-42" class="i">+        mapView.controller.setCenter(startPoint)
</a><a href="#h2-0-43" id="h2-0-43" class="i">+
</a><a href="#h2-0-44" id="h2-0-44" class="i">+        val marker = Marker(mapView)
</a><a href="#h2-0-45" id="h2-0-45" class="i">+        marker.isDraggable = true
</a><a href="#h2-0-46" id="h2-0-46" class="i">+        marker.position = startPoint
</a><a href="#h2-0-47" id="h2-0-47" class="i">+        marker.setAnchor(Marker.ANCHOR_CENTER, Marker.ANCHOR_BOTTOM)
</a><a href="#h2-0-48" id="h2-0-48" class="i">+
</a><a href="#h2-0-49" id="h2-0-49" class="i">+        mapView.overlays.add(object: Overlay() {
</a><a href="#h2-0-50" id="h2-0-50" class="i">+            override fun onSingleTapConfirmed(e: MotionEvent?, mapView: MapView?): Boolean {
</a><a href="#h2-0-51" id="h2-0-51" class="i">+                val proj: Projection = mapView!!.projection
</a><a href="#h2-0-52" id="h2-0-52" class="i">+                val loc = proj.fromPixels(e!!.x.toInt(), e.y.toInt()) as GeoPoint
</a><a href="#h2-0-53" id="h2-0-53" class="i">+                marker.position = loc
</a><a href="#h2-0-54" id="h2-0-54" class="i">+                mapView.invalidate()
</a><a href="#h2-0-55" id="h2-0-55" class="i">+                return true
</a><a href="#h2-0-56" id="h2-0-56" class="i">+            }
</a><a href="#h2-0-57" id="h2-0-57" class="i">+        })
</a><a href="#h2-0-58" id="h2-0-58" class="i">+
</a><a href="#h2-0-59" id="h2-0-59" class="i">+        mapView.overlays.add(marker)
</a><a href="#h2-0-60" id="h2-0-60" class="i">+
</a><a href="#h2-0-61" id="h2-0-61" class="i">+        val applyButton = findViewById&lt;Button&gt;(R.id.apply_location_button)
</a><a href="#h2-0-62" id="h2-0-62" class="i">+        applyButton.setOnClickListener {
</a><a href="#h2-0-63" id="h2-0-63" class="i">+            val bundle = Bundle()
</a><a href="#h2-0-64" id="h2-0-64" class="i">+            bundle.putFloat(&quot;latitude&quot;, marker.position.latitude.toFloat())
</a><a href="#h2-0-65" id="h2-0-65" class="i">+            bundle.putFloat(&quot;longitude&quot;, marker.position.longitude.toFloat())
</a><a href="#h2-0-66" id="h2-0-66" class="i">+            setResult(RESULT_OK, intent.putExtra(&quot;location&quot;, bundle))
</a><a href="#h2-0-67" id="h2-0-67" class="i">+            finish()
</a><a href="#h2-0-68" id="h2-0-68" class="i">+        }
</a><a href="#h2-0-69" id="h2-0-69" class="i">+
</a><a href="#h2-0-70" id="h2-0-70" class="i">+        val setPreciseLocationButton = findViewById&lt;Button&gt;(R.id.set_precise_location_button)
</a><a href="#h2-0-71" id="h2-0-71" class="i">+
</a><a href="#h2-0-72" id="h2-0-72" class="i">+        setPreciseLocationButton.setOnClickListener {
</a><a href="#h2-0-73" id="h2-0-73" class="i">+            val locationDialog = layoutInflater.inflate(R.layout.precise_location_dialog, null)
</a><a href="#h2-0-74" id="h2-0-74" class="i">+            val dialogLatitude = locationDialog.findViewById&lt;EditText&gt;(R.id.dialog_latitude).also { it.setText(marker.position.latitude.toString()) }
</a><a href="#h2-0-75" id="h2-0-75" class="i">+            val dialogLongitude = locationDialog.findViewById&lt;EditText&gt;(R.id.dialog_longitude).also { it.setText(marker.position.longitude.toString()) }
</a><a href="#h2-0-76" id="h2-0-76" class="i">+
</a><a href="#h2-0-77" id="h2-0-77" class="i">+            AlertDialog.Builder(this)
</a><a href="#h2-0-78" id="h2-0-78" class="i">+                .setView(locationDialog)
</a><a href="#h2-0-79" id="h2-0-79" class="i">+                .setTitle(&quot;Set a precise location&quot;)
</a><a href="#h2-0-80" id="h2-0-80" class="i">+                .setPositiveButton(&quot;Set&quot;) { _, _ -&gt;
</a><a href="#h2-0-81" id="h2-0-81" class="i">+                    val latitude = dialogLatitude.text.toString().toDoubleOrNull()
</a><a href="#h2-0-82" id="h2-0-82" class="i">+                    val longitude = dialogLongitude.text.toString().toDoubleOrNull()
</a><a href="#h2-0-83" id="h2-0-83" class="i">+                    if (latitude != null &amp;&amp; longitude != null) {
</a><a href="#h2-0-84" id="h2-0-84" class="i">+                        val preciseLocation = GeoPoint(latitude, longitude)
</a><a href="#h2-0-85" id="h2-0-85" class="i">+                        mapView.controller.setCenter(preciseLocation)
</a><a href="#h2-0-86" id="h2-0-86" class="i">+                        marker.position = preciseLocation
</a><a href="#h2-0-87" id="h2-0-87" class="i">+                        mapView.invalidate()
</a><a href="#h2-0-88" id="h2-0-88" class="i">+                    }
</a><a href="#h2-0-89" id="h2-0-89" class="i">+                }.setNegativeButton(&quot;Cancel&quot;) { _, _ -&gt; }.show()
</a><a href="#h2-0-90" id="h2-0-90" class="i">+        }
</a><a href="#h2-0-91" id="h2-0-91" class="i">+    }
</a><a href="#h2-0-92" id="h2-0-92" class="i">+
</a><a href="#h2-0-93" id="h2-0-93" class="i">+    override fun onDestroy() {
</a><a href="#h2-0-94" id="h2-0-94" class="i">+        super.onDestroy()
</a><a href="#h2-0-95" id="h2-0-95" class="i">+        mapView.onDetach()
</a><a href="#h2-0-96" id="h2-0-96" class="i">+    }
</a><a href="#h2-0-97" id="h2-0-97" class="i">+}
</a><b>diff --git a/<a id="h3" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/downloads/DownloadsSection.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/downloads/DownloadsSection.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/downloads/DownloadsSection.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/downloads/DownloadsSection.kt</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -58,7 +58,7 @@ import kotlinx.coroutines.launch
</a> import me.rhunk.snapenhance.R
 import me.rhunk.snapenhance.data.FileType
 import me.rhunk.snapenhance.download.data.DownloadObject
<a href="#h3-0-3" id="h3-0-3" class="d">-import me.rhunk.snapenhance.ui.download.MediaFilter
</a><a href="#h3-0-4" id="h3-0-4" class="i">+import me.rhunk.snapenhance.download.data.MediaFilter
</a> import me.rhunk.snapenhance.ui.manager.Section
 
 class DownloadsSection : Section() {
<b>diff --git a/<a id="h4" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/features/PickLocation.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/features/PickLocation.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/features/PickLocation.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/features/PickLocation.kt</a></b>
<a href="#h4-0" id="h4-0" class="h">@@ -0,0 +1,4 @@
</a><a href="#h4-0-0" id="h4-0-0" class="i">+package me.rhunk.snapenhance.ui.manager.sections.features
</a><a href="#h4-0-1" id="h4-0-1" class="i">+
</a><a href="#h4-0-2" id="h4-0-2" class="i">+class PickLocation {
</a><a href="#h4-0-3" id="h4-0-3" class="i">+}</a><a href="#h4-0-4" id="h4-0-4" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h5" href="../file/core/build.gradle.kts.html">core/build.gradle.kts</a> b/<a href="../file/core/build.gradle.kts.html">core/build.gradle.kts</a></b>
<a href="#h5-0" id="h5-0" class="h">@@ -38,7 +38,6 @@ dependencies {
</a>     implementation(libs.recyclerview)
     implementation(libs.gson)
     implementation(libs.ffmpeg.kit)
<a href="#h5-0-3" id="h5-0-3" class="d">-    implementation(libs.osmdroid.android)
</a>     implementation(libs.okhttp)
     implementation(libs.androidx.documentfile)
 
<b>diff --git a/<a id="h6" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/action/impl/OpenMap.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/action/impl/OpenMap.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/action/impl/OpenMap.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/action/impl/OpenMap.kt</a></b>
<a href="#h6-0" id="h6-0" class="h">@@ -4,13 +4,12 @@ import android.content.Intent
</a> import android.os.Bundle
 import me.rhunk.snapenhance.action.AbstractAction
 import me.rhunk.snapenhance.core.BuildConfig
<a href="#h6-0-3" id="h6-0-3" class="d">-import me.rhunk.snapenhance.ui.map.MapActivity
</a> 
 class OpenMap: AbstractAction(&quot;action.open_map&quot;) {
     override fun run() {
         context.runOnUiThread {
             val mapActivityIntent = Intent()
<a href="#h6-0-9" id="h6-0-9" class="d">-            mapActivityIntent.setClassName(BuildConfig.APPLICATION_ID, MapActivity::class.java.name)
</a><a href="#h6-0-10" id="h6-0-10" class="i">+            mapActivityIntent.setClassName(BuildConfig.APPLICATION_ID, &quot;me.rhunk.snapenhance.ui.MapActivity&quot;)
</a>             mapActivityIntent.putExtra(&quot;location&quot;, Bundle().apply {
                 putDouble(&quot;latitude&quot;, context.config.spoof.location.latitude.get().toDouble())
                 putDouble(&quot;longitude&quot;, context.config.spoof.location.longitude.get().toDouble())
<b>diff --git a/<a id="h7" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/download/DownloadTaskManager.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/download/DownloadTaskManager.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/download/DownloadTaskManager.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/download/DownloadTaskManager.kt</a></b>
<a href="#h7-0" id="h7-0" class="h">@@ -6,7 +6,7 @@ import android.database.sqlite.SQLiteDatabase
</a> import me.rhunk.snapenhance.download.data.DownloadMetadata
 import me.rhunk.snapenhance.download.data.DownloadObject
 import me.rhunk.snapenhance.download.data.DownloadStage
<a href="#h7-0-3" id="h7-0-3" class="d">-import me.rhunk.snapenhance.ui.download.MediaFilter
</a><a href="#h7-0-4" id="h7-0-4" class="i">+import me.rhunk.snapenhance.download.data.MediaFilter
</a> import me.rhunk.snapenhance.util.SQLiteDatabaseHelper
 import me.rhunk.snapenhance.util.getIntOrNull
 import me.rhunk.snapenhance.util.getStringOrNull
<b>diff --git a/<a id="h8" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/download/data/MediaFilter.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/download/data/MediaFilter.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/download/data/MediaFilter.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/download/data/MediaFilter.kt</a></b>
<a href="#h8-0" id="h8-0" class="h">@@ -0,0 +1,17 @@
</a><a href="#h8-0-0" id="h8-0-0" class="i">+package me.rhunk.snapenhance.download.data
</a><a href="#h8-0-1" id="h8-0-1" class="i">+
</a><a href="#h8-0-2" id="h8-0-2" class="i">+enum class MediaFilter(
</a><a href="#h8-0-3" id="h8-0-3" class="i">+    val key: String,
</a><a href="#h8-0-4" id="h8-0-4" class="i">+    val shouldIgnoreFilter: Boolean = false
</a><a href="#h8-0-5" id="h8-0-5" class="i">+) {
</a><a href="#h8-0-6" id="h8-0-6" class="i">+    NONE(&quot;none&quot;, true),
</a><a href="#h8-0-7" id="h8-0-7" class="i">+    PENDING(&quot;pending&quot;, true),
</a><a href="#h8-0-8" id="h8-0-8" class="i">+    CHAT_MEDIA(&quot;chat_media&quot;),
</a><a href="#h8-0-9" id="h8-0-9" class="i">+    STORY(&quot;story&quot;),
</a><a href="#h8-0-10" id="h8-0-10" class="i">+    SPOTLIGHT(&quot;spotlight&quot;);
</a><a href="#h8-0-11" id="h8-0-11" class="i">+
</a><a href="#h8-0-12" id="h8-0-12" class="i">+    fun matches(source: String?): Boolean {
</a><a href="#h8-0-13" id="h8-0-13" class="i">+        if (source == null) return false
</a><a href="#h8-0-14" id="h8-0-14" class="i">+        return source.contains(key, ignoreCase = true)
</a><a href="#h8-0-15" id="h8-0-15" class="i">+    }
</a><a href="#h8-0-16" id="h8-0-16" class="i">+}</a><a href="#h8-0-17" id="h8-0-17" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h9" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/MediaDownloader.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/MediaDownloader.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/MediaDownloader.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/MediaDownloader.kt</a></b>
<a href="#h9-0" id="h9-0" class="h">@@ -32,7 +32,7 @@ import me.rhunk.snapenhance.hook.HookAdapter
</a> import me.rhunk.snapenhance.hook.HookStage
 import me.rhunk.snapenhance.hook.Hooker
 import me.rhunk.snapenhance.ui.ViewAppearanceHelper
<a href="#h9-0-3" id="h9-0-3" class="d">-import me.rhunk.snapenhance.ui.download.MediaFilter
</a><a href="#h9-0-4" id="h9-0-4" class="i">+import me.rhunk.snapenhance.download.data.MediaFilter
</a> import me.rhunk.snapenhance.util.download.RemoteMediaResolver
 import me.rhunk.snapenhance.util.getObjectField
 import me.rhunk.snapenhance.util.protobuf.ProtoReader
<b>diff --git a/<a id="h10" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/ui/download/DebugSettingsLayoutInflater.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/ui/download/DebugSettingsLayoutInflater.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/ui/download/DebugSettingsLayoutInflater.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/ui/download/DebugSettingsLayoutInflater.kt</a></b>
<a href="#h10-0" id="h10-0" class="h">@@ -1,104 +0,0 @@
</a><a href="#h10-0-0" id="h10-0-0" class="d">-package me.rhunk.snapenhance.ui.download
</a><a href="#h10-0-1" id="h10-0-1" class="d">-
</a><a href="#h10-0-2" id="h10-0-2" class="d">-import android.app.AlertDialog
</a><a href="#h10-0-3" id="h10-0-3" class="d">-import android.view.View
</a><a href="#h10-0-4" id="h10-0-4" class="d">-import android.view.ViewGroup
</a><a href="#h10-0-5" id="h10-0-5" class="d">-import android.widget.ArrayAdapter
</a><a href="#h10-0-6" id="h10-0-6" class="d">-import android.widget.ImageButton
</a><a href="#h10-0-7" id="h10-0-7" class="d">-import android.widget.ListView
</a><a href="#h10-0-8" id="h10-0-8" class="d">-import android.widget.TextView
</a><a href="#h10-0-9" id="h10-0-9" class="d">-import android.widget.Toast
</a><a href="#h10-0-10" id="h10-0-10" class="d">-import me.rhunk.snapenhance.SharedContext
</a><a href="#h10-0-11" id="h10-0-11" class="d">-import me.rhunk.snapenhance.bridge.types.BridgeFileType
</a><a href="#h10-0-12" id="h10-0-12" class="d">-import me.rhunk.snapenhance.core.R
</a><a href="#h10-0-13" id="h10-0-13" class="d">-import java.io.File
</a><a href="#h10-0-14" id="h10-0-14" class="d">-
</a><a href="#h10-0-15" id="h10-0-15" class="d">-class ActionListAdapter(
</a><a href="#h10-0-16" id="h10-0-16" class="d">-    private val activity: DownloadManagerActivity,
</a><a href="#h10-0-17" id="h10-0-17" class="d">-    private val layoutId: Int,
</a><a href="#h10-0-18" id="h10-0-18" class="d">-    private val actions: Array&lt;Pair&lt;String, () -&gt; Unit&gt;&gt;
</a><a href="#h10-0-19" id="h10-0-19" class="d">-) : ArrayAdapter&lt;Pair&lt;String, () -&gt; Unit&gt;&gt;(activity, layoutId, actions) {
</a><a href="#h10-0-20" id="h10-0-20" class="d">-    override fun getView(position: Int, convertView: View?, parent: ViewGroup): View {
</a><a href="#h10-0-21" id="h10-0-21" class="d">-        val view = convertView ?: activity.layoutInflater.inflate(layoutId, parent, false)
</a><a href="#h10-0-22" id="h10-0-22" class="d">-        val action = actions[position]
</a><a href="#h10-0-23" id="h10-0-23" class="d">-        view.isClickable = true
</a><a href="#h10-0-24" id="h10-0-24" class="d">-
</a><a href="#h10-0-25" id="h10-0-25" class="d">-        view.findViewById&lt;TextView&gt;(R.id.feature_text).text = action.first
</a><a href="#h10-0-26" id="h10-0-26" class="d">-        view.setOnClickListener {
</a><a href="#h10-0-27" id="h10-0-27" class="d">-            action.second()
</a><a href="#h10-0-28" id="h10-0-28" class="d">-        }
</a><a href="#h10-0-29" id="h10-0-29" class="d">-
</a><a href="#h10-0-30" id="h10-0-30" class="d">-        return view
</a><a href="#h10-0-31" id="h10-0-31" class="d">-    }
</a><a href="#h10-0-32" id="h10-0-32" class="d">-}
</a><a href="#h10-0-33" id="h10-0-33" class="d">-
</a><a href="#h10-0-34" id="h10-0-34" class="d">-class DebugSettingsLayoutInflater(
</a><a href="#h10-0-35" id="h10-0-35" class="d">-    private val activity: DownloadManagerActivity
</a><a href="#h10-0-36" id="h10-0-36" class="d">-) {
</a><a href="#h10-0-37" id="h10-0-37" class="d">-    private fun confirmAction(title: String, message: String, action: () -&gt; Unit) {
</a><a href="#h10-0-38" id="h10-0-38" class="d">-        activity.runOnUiThread {
</a><a href="#h10-0-39" id="h10-0-39" class="d">-            AlertDialog.Builder(activity)
</a><a href="#h10-0-40" id="h10-0-40" class="d">-                .setTitle(title)
</a><a href="#h10-0-41" id="h10-0-41" class="d">-                .setMessage(message)
</a><a href="#h10-0-42" id="h10-0-42" class="d">-                .setPositiveButton(SharedContext.translation[&quot;button.positive&quot;]) { _, _ -&gt;
</a><a href="#h10-0-43" id="h10-0-43" class="d">-                    action()
</a><a href="#h10-0-44" id="h10-0-44" class="d">-                }
</a><a href="#h10-0-45" id="h10-0-45" class="d">-                .setNegativeButton(SharedContext.translation[&quot;button.negative&quot;]) { _, _ -&gt; }
</a><a href="#h10-0-46" id="h10-0-46" class="d">-                .show()
</a><a href="#h10-0-47" id="h10-0-47" class="d">-        }
</a><a href="#h10-0-48" id="h10-0-48" class="d">-    }
</a><a href="#h10-0-49" id="h10-0-49" class="d">-
</a><a href="#h10-0-50" id="h10-0-50" class="d">-    private fun showSuccessToast() {
</a><a href="#h10-0-51" id="h10-0-51" class="d">-        Toast.makeText(activity, &quot;Success&quot;, Toast.LENGTH_SHORT).show()
</a><a href="#h10-0-52" id="h10-0-52" class="d">-    }
</a><a href="#h10-0-53" id="h10-0-53" class="d">-
</a><a href="#h10-0-54" id="h10-0-54" class="d">-    fun inflate(parent: ViewGroup) {
</a><a href="#h10-0-55" id="h10-0-55" class="d">-        val debugSettingsLayout = activity.layoutInflater.inflate(R.layout.debug_settings_page, parent, false)
</a><a href="#h10-0-56" id="h10-0-56" class="d">-
</a><a href="#h10-0-57" id="h10-0-57" class="d">-        val debugSettingsTranslation = activity.translation.getCategory(&quot;debug_settings_page&quot;)
</a><a href="#h10-0-58" id="h10-0-58" class="d">-
</a><a href="#h10-0-59" id="h10-0-59" class="d">-        debugSettingsLayout.findViewById&lt;ImageButton&gt;(R.id.back_button).setOnClickListener {
</a><a href="#h10-0-60" id="h10-0-60" class="d">-            parent.removeView(debugSettingsLayout)
</a><a href="#h10-0-61" id="h10-0-61" class="d">-        }
</a><a href="#h10-0-62" id="h10-0-62" class="d">-
</a><a href="#h10-0-63" id="h10-0-63" class="d">-        debugSettingsLayout.findViewById&lt;TextView&gt;(R.id.title).text = activity.translation[&quot;debug_settings&quot;]
</a><a href="#h10-0-64" id="h10-0-64" class="d">-
</a><a href="#h10-0-65" id="h10-0-65" class="d">-        debugSettingsLayout.findViewById&lt;ListView&gt;(R.id.setting_page_list).apply {
</a><a href="#h10-0-66" id="h10-0-66" class="d">-            adapter = ActionListAdapter(activity, R.layout.debug_setting_item, mutableListOf&lt;Pair&lt;String, () -&gt; Unit&gt;&gt;().apply {
</a><a href="#h10-0-67" id="h10-0-67" class="d">-                add(debugSettingsTranslation[&quot;clear_cache_title&quot;] to {
</a><a href="#h10-0-68" id="h10-0-68" class="d">-                    context.cacheDir.listFiles()?.forEach {
</a><a href="#h10-0-69" id="h10-0-69" class="d">-                        it.deleteRecursively()
</a><a href="#h10-0-70" id="h10-0-70" class="d">-                    }
</a><a href="#h10-0-71" id="h10-0-71" class="d">-                    showSuccessToast()
</a><a href="#h10-0-72" id="h10-0-72" class="d">-                })
</a><a href="#h10-0-73" id="h10-0-73" class="d">-
</a><a href="#h10-0-74" id="h10-0-74" class="d">-                BridgeFileType.values().forEach { fileType -&gt;
</a><a href="#h10-0-75" id="h10-0-75" class="d">-                    val actionName = debugSettingsTranslation.format(&quot;clear_file_title&quot;, &quot;file_name&quot; to fileType.displayName)
</a><a href="#h10-0-76" id="h10-0-76" class="d">-                    add(actionName to {
</a><a href="#h10-0-77" id="h10-0-77" class="d">-                        confirmAction(actionName, debugSettingsTranslation.format(&quot;clear_file_confirmation&quot;, &quot;file_name&quot; to fileType.displayName)) {
</a><a href="#h10-0-78" id="h10-0-78" class="d">-                            fileType.resolve(context).deleteRecursively()
</a><a href="#h10-0-79" id="h10-0-79" class="d">-                            showSuccessToast()
</a><a href="#h10-0-80" id="h10-0-80" class="d">-                        }
</a><a href="#h10-0-81" id="h10-0-81" class="d">-                    })
</a><a href="#h10-0-82" id="h10-0-82" class="d">-                }
</a><a href="#h10-0-83" id="h10-0-83" class="d">-
</a><a href="#h10-0-84" id="h10-0-84" class="d">-                add(debugSettingsTranslation[&quot;reset_all_title&quot;] to {
</a><a href="#h10-0-85" id="h10-0-85" class="d">-                    confirmAction(debugSettingsTranslation[&quot;reset_all_title&quot;], debugSettingsTranslation[&quot;reset_all_confirmation&quot;]) {
</a><a href="#h10-0-86" id="h10-0-86" class="d">-                        arrayOf(context.cacheDir, context.filesDir, File(context.dataDir, &quot;databases&quot;), File(context.dataDir, &quot;shared_prefs&quot;)).forEach {
</a><a href="#h10-0-87" id="h10-0-87" class="d">-                            it.listFiles()?.forEach { file -&gt;
</a><a href="#h10-0-88" id="h10-0-88" class="d">-                                file.deleteRecursively()
</a><a href="#h10-0-89" id="h10-0-89" class="d">-                            }
</a><a href="#h10-0-90" id="h10-0-90" class="d">-                        }
</a><a href="#h10-0-91" id="h10-0-91" class="d">-                        showSuccessToast()
</a><a href="#h10-0-92" id="h10-0-92" class="d">-                    }
</a><a href="#h10-0-93" id="h10-0-93" class="d">-                })
</a><a href="#h10-0-94" id="h10-0-94" class="d">-            }.toTypedArray())
</a><a href="#h10-0-95" id="h10-0-95" class="d">-        }
</a><a href="#h10-0-96" id="h10-0-96" class="d">-
</a><a href="#h10-0-97" id="h10-0-97" class="d">-        activity.registerBackCallback {
</a><a href="#h10-0-98" id="h10-0-98" class="d">-            parent.removeView(debugSettingsLayout)
</a><a href="#h10-0-99" id="h10-0-99" class="d">-        }
</a><a href="#h10-0-100" id="h10-0-100" class="d">-
</a><a href="#h10-0-101" id="h10-0-101" class="d">-        parent.addView(debugSettingsLayout)
</a><a href="#h10-0-102" id="h10-0-102" class="d">-    }
</a><a href="#h10-0-103" id="h10-0-103" class="d">-}</a><a href="#h10-0-104" id="h10-0-104" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h11" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/ui/download/DownloadListAdapter.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/ui/download/DownloadListAdapter.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/ui/download/DownloadListAdapter.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/ui/download/DownloadListAdapter.kt</a></b>
<a href="#h11-0" id="h11-0" class="h">@@ -1,242 +0,0 @@
</a><a href="#h11-0-0" id="h11-0-0" class="d">-package me.rhunk.snapenhance.ui.download
</a><a href="#h11-0-1" id="h11-0-1" class="d">-
</a><a href="#h11-0-2" id="h11-0-2" class="d">-import android.annotation.SuppressLint
</a><a href="#h11-0-3" id="h11-0-3" class="d">-import android.content.Intent
</a><a href="#h11-0-4" id="h11-0-4" class="d">-import android.graphics.Bitmap
</a><a href="#h11-0-5" id="h11-0-5" class="d">-import android.graphics.BitmapFactory
</a><a href="#h11-0-6" id="h11-0-6" class="d">-import android.net.Uri
</a><a href="#h11-0-7" id="h11-0-7" class="d">-import android.os.Handler
</a><a href="#h11-0-8" id="h11-0-8" class="d">-import android.view.LayoutInflater
</a><a href="#h11-0-9" id="h11-0-9" class="d">-import android.view.View
</a><a href="#h11-0-10" id="h11-0-10" class="d">-import android.view.ViewGroup
</a><a href="#h11-0-11" id="h11-0-11" class="d">-import android.widget.Button
</a><a href="#h11-0-12" id="h11-0-12" class="d">-import android.widget.ImageView
</a><a href="#h11-0-13" id="h11-0-13" class="d">-import android.widget.TextView
</a><a href="#h11-0-14" id="h11-0-14" class="d">-import android.widget.Toast
</a><a href="#h11-0-15" id="h11-0-15" class="d">-import androidx.core.graphics.drawable.RoundedBitmapDrawableFactory
</a><a href="#h11-0-16" id="h11-0-16" class="d">-import androidx.recyclerview.widget.RecyclerView
</a><a href="#h11-0-17" id="h11-0-17" class="d">-import androidx.recyclerview.widget.RecyclerView.Adapter
</a><a href="#h11-0-18" id="h11-0-18" class="d">-import kotlinx.coroutines.CoroutineScope
</a><a href="#h11-0-19" id="h11-0-19" class="d">-import kotlinx.coroutines.Dispatchers
</a><a href="#h11-0-20" id="h11-0-20" class="d">-import kotlinx.coroutines.Job
</a><a href="#h11-0-21" id="h11-0-21" class="d">-import kotlinx.coroutines.job
</a><a href="#h11-0-22" id="h11-0-22" class="d">-import kotlinx.coroutines.launch
</a><a href="#h11-0-23" id="h11-0-23" class="d">-import kotlinx.coroutines.withTimeout
</a><a href="#h11-0-24" id="h11-0-24" class="d">-import me.rhunk.snapenhance.Logger
</a><a href="#h11-0-25" id="h11-0-25" class="d">-import me.rhunk.snapenhance.SharedContext
</a><a href="#h11-0-26" id="h11-0-26" class="d">-import me.rhunk.snapenhance.core.R
</a><a href="#h11-0-27" id="h11-0-27" class="d">-import me.rhunk.snapenhance.data.FileType
</a><a href="#h11-0-28" id="h11-0-28" class="d">-import me.rhunk.snapenhance.download.data.DownloadObject
</a><a href="#h11-0-29" id="h11-0-29" class="d">-import me.rhunk.snapenhance.download.data.DownloadStage
</a><a href="#h11-0-30" id="h11-0-30" class="d">-import me.rhunk.snapenhance.util.snap.PreviewUtils
</a><a href="#h11-0-31" id="h11-0-31" class="d">-import java.io.File
</a><a href="#h11-0-32" id="h11-0-32" class="d">-import java.io.FileInputStream
</a><a href="#h11-0-33" id="h11-0-33" class="d">-import java.net.URL
</a><a href="#h11-0-34" id="h11-0-34" class="d">-import kotlin.concurrent.thread
</a><a href="#h11-0-35" id="h11-0-35" class="d">-import kotlin.coroutines.coroutineContext
</a><a href="#h11-0-36" id="h11-0-36" class="d">-
</a><a href="#h11-0-37" id="h11-0-37" class="d">-class DownloadListAdapter(
</a><a href="#h11-0-38" id="h11-0-38" class="d">-    private val activity: DownloadManagerActivity,
</a><a href="#h11-0-39" id="h11-0-39" class="d">-    private val downloadList: MutableList&lt;DownloadObject&gt;
</a><a href="#h11-0-40" id="h11-0-40" class="d">-): Adapter&lt;DownloadListAdapter.ViewHolder&gt;() {
</a><a href="#h11-0-41" id="h11-0-41" class="d">-    private val coroutineScope = CoroutineScope(Dispatchers.IO)
</a><a href="#h11-0-42" id="h11-0-42" class="d">-    private val previewJobs = mutableMapOf&lt;Int, Job&gt;()
</a><a href="#h11-0-43" id="h11-0-43" class="d">-
</a><a href="#h11-0-44" id="h11-0-44" class="d">-    inner class ViewHolder(val view: View) : RecyclerView.ViewHolder(view) {
</a><a href="#h11-0-45" id="h11-0-45" class="d">-        val bitmojiIcon: ImageView = view.findViewById(R.id.bitmoji_icon)
</a><a href="#h11-0-46" id="h11-0-46" class="d">-        val title: TextView = view.findViewById(R.id.item_title)
</a><a href="#h11-0-47" id="h11-0-47" class="d">-        val subtitle: TextView = view.findViewById(R.id.item_subtitle)
</a><a href="#h11-0-48" id="h11-0-48" class="d">-        val status: TextView = view.findViewById(R.id.item_status)
</a><a href="#h11-0-49" id="h11-0-49" class="d">-        val actionButton: Button = view.findViewById(R.id.item_action_button)
</a><a href="#h11-0-50" id="h11-0-50" class="d">-        val radius by lazy {
</a><a href="#h11-0-51" id="h11-0-51" class="d">-            view.context.resources.getDimensionPixelSize(R.dimen.download_manager_item_preview_radius)
</a><a href="#h11-0-52" id="h11-0-52" class="d">-        }
</a><a href="#h11-0-53" id="h11-0-53" class="d">-        val viewWidth by lazy {
</a><a href="#h11-0-54" id="h11-0-54" class="d">-            view.resources.displayMetrics.widthPixels
</a><a href="#h11-0-55" id="h11-0-55" class="d">-        }
</a><a href="#h11-0-56" id="h11-0-56" class="d">-        val viewHeight by lazy {
</a><a href="#h11-0-57" id="h11-0-57" class="d">-            view.layoutParams.height
</a><a href="#h11-0-58" id="h11-0-58" class="d">-        }
</a><a href="#h11-0-59" id="h11-0-59" class="d">-    }
</a><a href="#h11-0-60" id="h11-0-60" class="d">-
</a><a href="#h11-0-61" id="h11-0-61" class="d">-    override fun onCreateViewHolder(parent: ViewGroup, viewType: Int): ViewHolder {
</a><a href="#h11-0-62" id="h11-0-62" class="d">-        return ViewHolder(LayoutInflater.from(parent.context).inflate(R.layout.download_manager_item, parent, false))
</a><a href="#h11-0-63" id="h11-0-63" class="d">-    }
</a><a href="#h11-0-64" id="h11-0-64" class="d">-
</a><a href="#h11-0-65" id="h11-0-65" class="d">-    override fun getItemCount(): Int {
</a><a href="#h11-0-66" id="h11-0-66" class="d">-        return downloadList.size
</a><a href="#h11-0-67" id="h11-0-67" class="d">-    }
</a><a href="#h11-0-68" id="h11-0-68" class="d">-
</a><a href="#h11-0-69" id="h11-0-69" class="d">-    @SuppressLint(&quot;Recycle&quot;)
</a><a href="#h11-0-70" id="h11-0-70" class="d">-    private suspend fun handlePreview(download: DownloadObject, holder: ViewHolder) {
</a><a href="#h11-0-71" id="h11-0-71" class="d">-        download.outputFile?.let {
</a><a href="#h11-0-72" id="h11-0-72" class="d">-            val uri = Uri.parse(it)
</a><a href="#h11-0-73" id="h11-0-73" class="d">-            runCatching {
</a><a href="#h11-0-74" id="h11-0-74" class="d">-                if (uri.scheme == &quot;content&quot;) {
</a><a href="#h11-0-75" id="h11-0-75" class="d">-                    val fileType = activity.contentResolver.openInputStream(uri)!!.use { stream -&gt;
</a><a href="#h11-0-76" id="h11-0-76" class="d">-                        FileType.fromInputStream(stream)
</a><a href="#h11-0-77" id="h11-0-77" class="d">-                    }
</a><a href="#h11-0-78" id="h11-0-78" class="d">-                    fileType to activity.contentResolver.openInputStream(uri)
</a><a href="#h11-0-79" id="h11-0-79" class="d">-                } else {
</a><a href="#h11-0-80" id="h11-0-80" class="d">-                    FileType.fromFile(File(it)) to FileInputStream(it)
</a><a href="#h11-0-81" id="h11-0-81" class="d">-                }
</a><a href="#h11-0-82" id="h11-0-82" class="d">-            }.getOrNull()
</a><a href="#h11-0-83" id="h11-0-83" class="d">-        }?.also { (fileType, assetStream) -&gt;
</a><a href="#h11-0-84" id="h11-0-84" class="d">-            val previewBitmap = assetStream?.use { stream -&gt;
</a><a href="#h11-0-85" id="h11-0-85" class="d">-                //don&#39;t preview files larger than 30MB
</a><a href="#h11-0-86" id="h11-0-86" class="d">-                if (stream.available() &gt; 30 * 1024 * 1024) return@also
</a><a href="#h11-0-87" id="h11-0-87" class="d">-
</a><a href="#h11-0-88" id="h11-0-88" class="d">-                val tempFile = File.createTempFile(&quot;preview&quot;, &quot;.${fileType.fileExtension}&quot;)
</a><a href="#h11-0-89" id="h11-0-89" class="d">-                tempFile.outputStream().use { output -&gt;
</a><a href="#h11-0-90" id="h11-0-90" class="d">-                    stream.copyTo(output)
</a><a href="#h11-0-91" id="h11-0-91" class="d">-                }
</a><a href="#h11-0-92" id="h11-0-92" class="d">-                runCatching {
</a><a href="#h11-0-93" id="h11-0-93" class="d">-                    PreviewUtils.createPreviewFromFile(tempFile)?.let { preview -&gt;
</a><a href="#h11-0-94" id="h11-0-94" class="d">-                        val offsetY = (preview.height / 2 - holder.viewHeight / 2).coerceAtLeast(0)
</a><a href="#h11-0-95" id="h11-0-95" class="d">-
</a><a href="#h11-0-96" id="h11-0-96" class="d">-                        Bitmap.createScaledBitmap(
</a><a href="#h11-0-97" id="h11-0-97" class="d">-                            Bitmap.createBitmap(
</a><a href="#h11-0-98" id="h11-0-98" class="d">-                                preview, 0, offsetY,
</a><a href="#h11-0-99" id="h11-0-99" class="d">-                                preview.width.coerceAtMost(holder.viewWidth),
</a><a href="#h11-0-100" id="h11-0-100" class="d">-                                preview.height.coerceAtMost(holder.viewHeight)
</a><a href="#h11-0-101" id="h11-0-101" class="d">-                            ),
</a><a href="#h11-0-102" id="h11-0-102" class="d">-                            holder.viewWidth,
</a><a href="#h11-0-103" id="h11-0-103" class="d">-                            holder.viewHeight,
</a><a href="#h11-0-104" id="h11-0-104" class="d">-                            false
</a><a href="#h11-0-105" id="h11-0-105" class="d">-                        )
</a><a href="#h11-0-106" id="h11-0-106" class="d">-                    }
</a><a href="#h11-0-107" id="h11-0-107" class="d">-                }.onFailure {
</a><a href="#h11-0-108" id="h11-0-108" class="d">-                    Logger.error(&quot;failed to create preview $fileType&quot;, it)
</a><a href="#h11-0-109" id="h11-0-109" class="d">-                }.also {
</a><a href="#h11-0-110" id="h11-0-110" class="d">-                    tempFile.delete()
</a><a href="#h11-0-111" id="h11-0-111" class="d">-                }.getOrNull()
</a><a href="#h11-0-112" id="h11-0-112" class="d">-            } ?: return@also
</a><a href="#h11-0-113" id="h11-0-113" class="d">-
</a><a href="#h11-0-114" id="h11-0-114" class="d">-            if (coroutineContext.job.isCancelled) return@also
</a><a href="#h11-0-115" id="h11-0-115" class="d">-            Handler(holder.view.context.mainLooper).post {
</a><a href="#h11-0-116" id="h11-0-116" class="d">-                holder.view.background = RoundedBitmapDrawableFactory.create(
</a><a href="#h11-0-117" id="h11-0-117" class="d">-                    holder.view.context.resources,
</a><a href="#h11-0-118" id="h11-0-118" class="d">-                    previewBitmap
</a><a href="#h11-0-119" id="h11-0-119" class="d">-                ).also {
</a><a href="#h11-0-120" id="h11-0-120" class="d">-                    it.cornerRadius = holder.radius.toFloat()
</a><a href="#h11-0-121" id="h11-0-121" class="d">-                }
</a><a href="#h11-0-122" id="h11-0-122" class="d">-            }
</a><a href="#h11-0-123" id="h11-0-123" class="d">-        }
</a><a href="#h11-0-124" id="h11-0-124" class="d">-    }
</a><a href="#h11-0-125" id="h11-0-125" class="d">-
</a><a href="#h11-0-126" id="h11-0-126" class="d">-    private fun updateViewHolder(download: DownloadObject, holder: ViewHolder) {
</a><a href="#h11-0-127" id="h11-0-127" class="d">-        holder.status.text = download.downloadStage.toString()
</a><a href="#h11-0-128" id="h11-0-128" class="d">-        holder.view.background = holder.view.context.getDrawable(R.drawable.download_manager_item_background)
</a><a href="#h11-0-129" id="h11-0-129" class="d">-
</a><a href="#h11-0-130" id="h11-0-130" class="d">-        coroutineScope.launch {
</a><a href="#h11-0-131" id="h11-0-131" class="d">-            withTimeout(2000) {
</a><a href="#h11-0-132" id="h11-0-132" class="d">-                handlePreview(download, holder)
</a><a href="#h11-0-133" id="h11-0-133" class="d">-            }
</a><a href="#h11-0-134" id="h11-0-134" class="d">-        }
</a><a href="#h11-0-135" id="h11-0-135" class="d">-
</a><a href="#h11-0-136" id="h11-0-136" class="d">-        val isSaved = download.downloadStage == DownloadStage.SAVED
</a><a href="#h11-0-137" id="h11-0-137" class="d">-        //if the download is in progress, the user can cancel it
</a><a href="#h11-0-138" id="h11-0-138" class="d">-        val canInteract = if (download.job != null) !download.downloadStage.isFinalStage || isSaved
</a><a href="#h11-0-139" id="h11-0-139" class="d">-        else isSaved
</a><a href="#h11-0-140" id="h11-0-140" class="d">-
</a><a href="#h11-0-141" id="h11-0-141" class="d">-        holder.status.visibility = if (isSaved) View.GONE else View.VISIBLE
</a><a href="#h11-0-142" id="h11-0-142" class="d">-
</a><a href="#h11-0-143" id="h11-0-143" class="d">-        with(holder.actionButton) {
</a><a href="#h11-0-144" id="h11-0-144" class="d">-            isEnabled = canInteract
</a><a href="#h11-0-145" id="h11-0-145" class="d">-            alpha = if (canInteract) 1f else 0.5f
</a><a href="#h11-0-146" id="h11-0-146" class="d">-            background = context.getDrawable(if (isSaved) R.drawable.action_button_success else R.drawable.action_button_cancel)
</a><a href="#h11-0-147" id="h11-0-147" class="d">-            setTextColor(context.getColor(if (isSaved) R.color.successColor else R.color.actionBarColor))
</a><a href="#h11-0-148" id="h11-0-148" class="d">-            text = if (isSaved)
</a><a href="#h11-0-149" id="h11-0-149" class="d">-                SharedContext.translation[&quot;button.open&quot;]
</a><a href="#h11-0-150" id="h11-0-150" class="d">-            else
</a><a href="#h11-0-151" id="h11-0-151" class="d">-                SharedContext.translation[&quot;button.cancel&quot;]
</a><a href="#h11-0-152" id="h11-0-152" class="d">-        }
</a><a href="#h11-0-153" id="h11-0-153" class="d">-    }
</a><a href="#h11-0-154" id="h11-0-154" class="d">-
</a><a href="#h11-0-155" id="h11-0-155" class="d">-    override fun onBindViewHolder(holder: ViewHolder, position: Int) {
</a><a href="#h11-0-156" id="h11-0-156" class="d">-        val pendingDownload = downloadList[position]
</a><a href="#h11-0-157" id="h11-0-157" class="d">-
</a><a href="#h11-0-158" id="h11-0-158" class="d">-        pendingDownload.changeListener = { _, _ -&gt;
</a><a href="#h11-0-159" id="h11-0-159" class="d">-            Handler(holder.view.context.mainLooper).post {
</a><a href="#h11-0-160" id="h11-0-160" class="d">-                updateViewHolder(pendingDownload, holder)
</a><a href="#h11-0-161" id="h11-0-161" class="d">-                notifyItemChanged(position)
</a><a href="#h11-0-162" id="h11-0-162" class="d">-            }
</a><a href="#h11-0-163" id="h11-0-163" class="d">-        }
</a><a href="#h11-0-164" id="h11-0-164" class="d">-
</a><a href="#h11-0-165" id="h11-0-165" class="d">-       // holder.bitmojiIcon.setImageResource(R.drawable.bitmoji_blank)
</a><a href="#h11-0-166" id="h11-0-166" class="d">-
</a><a href="#h11-0-167" id="h11-0-167" class="d">-        pendingDownload.metadata.iconUrl?.let { url -&gt;
</a><a href="#h11-0-168" id="h11-0-168" class="d">-            thread(start = true) {
</a><a href="#h11-0-169" id="h11-0-169" class="d">-                runCatching {
</a><a href="#h11-0-170" id="h11-0-170" class="d">-                    val iconBitmap = URL(url).openStream().use {
</a><a href="#h11-0-171" id="h11-0-171" class="d">-                        BitmapFactory.decodeStream(it)
</a><a href="#h11-0-172" id="h11-0-172" class="d">-                    }
</a><a href="#h11-0-173" id="h11-0-173" class="d">-                    Handler(holder.view.context.mainLooper).post {
</a><a href="#h11-0-174" id="h11-0-174" class="d">-                        holder.bitmojiIcon.setImageBitmap(iconBitmap)
</a><a href="#h11-0-175" id="h11-0-175" class="d">-                    }
</a><a href="#h11-0-176" id="h11-0-176" class="d">-                }
</a><a href="#h11-0-177" id="h11-0-177" class="d">-            }
</a><a href="#h11-0-178" id="h11-0-178" class="d">-        }
</a><a href="#h11-0-179" id="h11-0-179" class="d">-
</a><a href="#h11-0-180" id="h11-0-180" class="d">-        holder.title.visibility = View.GONE
</a><a href="#h11-0-181" id="h11-0-181" class="d">-        holder.subtitle.visibility = View.GONE
</a><a href="#h11-0-182" id="h11-0-182" class="d">-
</a><a href="#h11-0-183" id="h11-0-183" class="d">-        pendingDownload.metadata.mediaDisplayType?.let {
</a><a href="#h11-0-184" id="h11-0-184" class="d">-            holder.title.text = it
</a><a href="#h11-0-185" id="h11-0-185" class="d">-            holder.title.visibility = View.VISIBLE
</a><a href="#h11-0-186" id="h11-0-186" class="d">-        }
</a><a href="#h11-0-187" id="h11-0-187" class="d">-
</a><a href="#h11-0-188" id="h11-0-188" class="d">-        pendingDownload.metadata.mediaDisplaySource?.let {
</a><a href="#h11-0-189" id="h11-0-189" class="d">-            holder.subtitle.text = it
</a><a href="#h11-0-190" id="h11-0-190" class="d">-            holder.subtitle.visibility = View.VISIBLE
</a><a href="#h11-0-191" id="h11-0-191" class="d">-        }
</a><a href="#h11-0-192" id="h11-0-192" class="d">-
</a><a href="#h11-0-193" id="h11-0-193" class="d">-        holder.actionButton.setOnClickListener {
</a><a href="#h11-0-194" id="h11-0-194" class="d">-            if (pendingDownload.downloadStage != DownloadStage.SAVED) {
</a><a href="#h11-0-195" id="h11-0-195" class="d">-                pendingDownload.cancel()
</a><a href="#h11-0-196" id="h11-0-196" class="d">-                pendingDownload.downloadStage = DownloadStage.CANCELLED
</a><a href="#h11-0-197" id="h11-0-197" class="d">-                updateViewHolder(pendingDownload, holder)
</a><a href="#h11-0-198" id="h11-0-198" class="d">-                notifyItemChanged(position);
</a><a href="#h11-0-199" id="h11-0-199" class="d">-                return@setOnClickListener
</a><a href="#h11-0-200" id="h11-0-200" class="d">-            }
</a><a href="#h11-0-201" id="h11-0-201" class="d">-
</a><a href="#h11-0-202" id="h11-0-202" class="d">-            pendingDownload.outputFile?.let {
</a><a href="#h11-0-203" id="h11-0-203" class="d">-                fun showFileNotFound() {
</a><a href="#h11-0-204" id="h11-0-204" class="d">-                    Toast.makeText(holder.view.context, SharedContext.translation[&quot;download_manager_activity.file_not_found_toast&quot;], Toast.LENGTH_SHORT).show()
</a><a href="#h11-0-205" id="h11-0-205" class="d">-                }
</a><a href="#h11-0-206" id="h11-0-206" class="d">-
</a><a href="#h11-0-207" id="h11-0-207" class="d">-                val uri = Uri.parse(it)
</a><a href="#h11-0-208" id="h11-0-208" class="d">-                val fileType = runCatching {
</a><a href="#h11-0-209" id="h11-0-209" class="d">-                    if (uri.scheme == &quot;content&quot;) {
</a><a href="#h11-0-210" id="h11-0-210" class="d">-                        activity.contentResolver.openInputStream(uri)?.use { input -&gt;
</a><a href="#h11-0-211" id="h11-0-211" class="d">-                            FileType.fromInputStream(input)
</a><a href="#h11-0-212" id="h11-0-212" class="d">-                        } ?: run {
</a><a href="#h11-0-213" id="h11-0-213" class="d">-                            showFileNotFound()
</a><a href="#h11-0-214" id="h11-0-214" class="d">-                            return@setOnClickListener
</a><a href="#h11-0-215" id="h11-0-215" class="d">-                        }
</a><a href="#h11-0-216" id="h11-0-216" class="d">-                    } else {
</a><a href="#h11-0-217" id="h11-0-217" class="d">-                        val file = File(it)
</a><a href="#h11-0-218" id="h11-0-218" class="d">-                        if (!file.exists()) {
</a><a href="#h11-0-219" id="h11-0-219" class="d">-                            showFileNotFound()
</a><a href="#h11-0-220" id="h11-0-220" class="d">-                            return@setOnClickListener
</a><a href="#h11-0-221" id="h11-0-221" class="d">-                        }
</a><a href="#h11-0-222" id="h11-0-222" class="d">-                        FileType.fromFile(file)
</a><a href="#h11-0-223" id="h11-0-223" class="d">-                    }
</a><a href="#h11-0-224" id="h11-0-224" class="d">-                }.onFailure { exception -&gt;
</a><a href="#h11-0-225" id="h11-0-225" class="d">-                    Logger.error(&quot;Failed to open file&quot;, exception)
</a><a href="#h11-0-226" id="h11-0-226" class="d">-                }.getOrDefault(FileType.UNKNOWN)
</a><a href="#h11-0-227" id="h11-0-227" class="d">-                if (fileType == FileType.UNKNOWN) {
</a><a href="#h11-0-228" id="h11-0-228" class="d">-                    showFileNotFound()
</a><a href="#h11-0-229" id="h11-0-229" class="d">-                    return@setOnClickListener
</a><a href="#h11-0-230" id="h11-0-230" class="d">-                }
</a><a href="#h11-0-231" id="h11-0-231" class="d">-
</a><a href="#h11-0-232" id="h11-0-232" class="d">-                val intent = Intent(Intent.ACTION_VIEW)
</a><a href="#h11-0-233" id="h11-0-233" class="d">-                intent.flags = Intent.FLAG_ACTIVITY_NEW_TASK or Intent.FLAG_GRANT_READ_URI_PERMISSION
</a><a href="#h11-0-234" id="h11-0-234" class="d">-                intent.setDataAndType(uri, fileType.mimeType)
</a><a href="#h11-0-235" id="h11-0-235" class="d">-                holder.view.context.startActivity(intent)
</a><a href="#h11-0-236" id="h11-0-236" class="d">-            }
</a><a href="#h11-0-237" id="h11-0-237" class="d">-        }
</a><a href="#h11-0-238" id="h11-0-238" class="d">-
</a><a href="#h11-0-239" id="h11-0-239" class="d">-        updateViewHolder(pendingDownload, holder)
</a><a href="#h11-0-240" id="h11-0-240" class="d">-    }
</a><a href="#h11-0-241" id="h11-0-241" class="d">-}</a><a href="#h11-0-242" id="h11-0-242" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h12" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/ui/download/DownloadManagerActivity.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/ui/download/DownloadManagerActivity.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/ui/download/DownloadManagerActivity.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/ui/download/DownloadManagerActivity.kt</a></b>
<a href="#h12-0" id="h12-0" class="h">@@ -1,214 +0,0 @@
</a><a href="#h12-0-0" id="h12-0-0" class="d">-package me.rhunk.snapenhance.ui.download
</a><a href="#h12-0-1" id="h12-0-1" class="d">-
</a><a href="#h12-0-2" id="h12-0-2" class="d">-import android.annotation.SuppressLint
</a><a href="#h12-0-3" id="h12-0-3" class="d">-import android.app.Activity
</a><a href="#h12-0-4" id="h12-0-4" class="d">-import android.app.AlertDialog
</a><a href="#h12-0-5" id="h12-0-5" class="d">-import android.content.Context
</a><a href="#h12-0-6" id="h12-0-6" class="d">-import android.content.Intent
</a><a href="#h12-0-7" id="h12-0-7" class="d">-import android.net.Uri
</a><a href="#h12-0-8" id="h12-0-8" class="d">-import android.os.Bundle
</a><a href="#h12-0-9" id="h12-0-9" class="d">-import android.os.PowerManager
</a><a href="#h12-0-10" id="h12-0-10" class="d">-import android.provider.Settings
</a><a href="#h12-0-11" id="h12-0-11" class="d">-import android.view.View
</a><a href="#h12-0-12" id="h12-0-12" class="d">-import android.widget.Button
</a><a href="#h12-0-13" id="h12-0-13" class="d">-import android.widget.ImageButton
</a><a href="#h12-0-14" id="h12-0-14" class="d">-import android.widget.TextView
</a><a href="#h12-0-15" id="h12-0-15" class="d">-import androidx.recyclerview.widget.ItemTouchHelper
</a><a href="#h12-0-16" id="h12-0-16" class="d">-import androidx.recyclerview.widget.RecyclerView
</a><a href="#h12-0-17" id="h12-0-17" class="d">-import me.rhunk.snapenhance.SharedContext
</a><a href="#h12-0-18" id="h12-0-18" class="d">-import me.rhunk.snapenhance.bridge.wrapper.LocaleWrapper
</a><a href="#h12-0-19" id="h12-0-19" class="d">-import me.rhunk.snapenhance.core.BuildConfig
</a><a href="#h12-0-20" id="h12-0-20" class="d">-import me.rhunk.snapenhance.core.R
</a><a href="#h12-0-21" id="h12-0-21" class="d">-import me.rhunk.snapenhance.download.data.DownloadObject
</a><a href="#h12-0-22" id="h12-0-22" class="d">-
</a><a href="#h12-0-23" id="h12-0-23" class="d">-class DownloadManagerActivity : Activity() {
</a><a href="#h12-0-24" id="h12-0-24" class="d">-    lateinit var translation: LocaleWrapper
</a><a href="#h12-0-25" id="h12-0-25" class="d">-
</a><a href="#h12-0-26" id="h12-0-26" class="d">-    private val backCallbacks = mutableListOf&lt;() -&gt; Unit&gt;()
</a><a href="#h12-0-27" id="h12-0-27" class="d">-    private val fetchedDownloadTasks = mutableListOf&lt;DownloadObject&gt;()
</a><a href="#h12-0-28" id="h12-0-28" class="d">-    private var listFilter = MediaFilter.NONE
</a><a href="#h12-0-29" id="h12-0-29" class="d">-
</a><a href="#h12-0-30" id="h12-0-30" class="d">-    private val preferences by lazy {
</a><a href="#h12-0-31" id="h12-0-31" class="d">-        getSharedPreferences(&quot;settings&quot;, Context.MODE_PRIVATE)
</a><a href="#h12-0-32" id="h12-0-32" class="d">-    }
</a><a href="#h12-0-33" id="h12-0-33" class="d">-
</a><a href="#h12-0-34" id="h12-0-34" class="d">-    private fun updateNoDownloadText() {
</a><a href="#h12-0-35" id="h12-0-35" class="d">-        findViewById&lt;TextView&gt;(R.id.no_download_title).let {
</a><a href="#h12-0-36" id="h12-0-36" class="d">-            it.text = translation[&quot;no_downloads&quot;]
</a><a href="#h12-0-37" id="h12-0-37" class="d">-            it.visibility = if (fetchedDownloadTasks.isEmpty()) View.VISIBLE else View.GONE
</a><a href="#h12-0-38" id="h12-0-38" class="d">-        }
</a><a href="#h12-0-39" id="h12-0-39" class="d">-    }
</a><a href="#h12-0-40" id="h12-0-40" class="d">-
</a><a href="#h12-0-41" id="h12-0-41" class="d">-    @SuppressLint(&quot;NotifyDataSetChanged&quot;)
</a><a href="#h12-0-42" id="h12-0-42" class="d">-    private fun updateListContent() {
</a><a href="#h12-0-43" id="h12-0-43" class="d">-        fetchedDownloadTasks.clear()
</a><a href="#h12-0-44" id="h12-0-44" class="d">-        fetchedDownloadTasks.addAll(SharedContext.downloadTaskManager.queryFirstTasks(filter = listFilter).values)
</a><a href="#h12-0-45" id="h12-0-45" class="d">-
</a><a href="#h12-0-46" id="h12-0-46" class="d">-        with(findViewById&lt;RecyclerView&gt;(R.id.download_list)) {
</a><a href="#h12-0-47" id="h12-0-47" class="d">-            adapter?.notifyDataSetChanged()
</a><a href="#h12-0-48" id="h12-0-48" class="d">-            scrollToPosition(0)
</a><a href="#h12-0-49" id="h12-0-49" class="d">-        }
</a><a href="#h12-0-50" id="h12-0-50" class="d">-        updateNoDownloadText()
</a><a href="#h12-0-51" id="h12-0-51" class="d">-    }
</a><a href="#h12-0-52" id="h12-0-52" class="d">-
</a><a href="#h12-0-53" id="h12-0-53" class="d">-    @Deprecated(&quot;Deprecated in Java&quot;)
</a><a href="#h12-0-54" id="h12-0-54" class="d">-    @Suppress(&quot;DEPRECATION&quot;)
</a><a href="#h12-0-55" id="h12-0-55" class="d">-    override fun onBackPressed() {
</a><a href="#h12-0-56" id="h12-0-56" class="d">-        backCallbacks.lastOrNull()?.let {
</a><a href="#h12-0-57" id="h12-0-57" class="d">-            it()
</a><a href="#h12-0-58" id="h12-0-58" class="d">-            backCallbacks.removeLast()
</a><a href="#h12-0-59" id="h12-0-59" class="d">-        } ?: super.onBackPressed()
</a><a href="#h12-0-60" id="h12-0-60" class="d">-    }
</a><a href="#h12-0-61" id="h12-0-61" class="d">-
</a><a href="#h12-0-62" id="h12-0-62" class="d">-    fun registerBackCallback(callback: () -&gt; Unit) {
</a><a href="#h12-0-63" id="h12-0-63" class="d">-        backCallbacks.add(callback)
</a><a href="#h12-0-64" id="h12-0-64" class="d">-    }
</a><a href="#h12-0-65" id="h12-0-65" class="d">-
</a><a href="#h12-0-66" id="h12-0-66" class="d">-    @SuppressLint(&quot;BatteryLife&quot;, &quot;NotifyDataSetChanged&quot;, &quot;SetTextI18n&quot;)
</a><a href="#h12-0-67" id="h12-0-67" class="d">-    override fun onCreate(savedInstanceState: Bundle?) {
</a><a href="#h12-0-68" id="h12-0-68" class="d">-        super.onCreate(savedInstanceState)
</a><a href="#h12-0-69" id="h12-0-69" class="d">-        SharedContext.ensureInitialized(this)
</a><a href="#h12-0-70" id="h12-0-70" class="d">-        translation = SharedContext.translation.getCategory(&quot;download_manager_activity&quot;)
</a><a href="#h12-0-71" id="h12-0-71" class="d">-        
</a><a href="#h12-0-72" id="h12-0-72" class="d">-        setContentView(R.layout.download_manager_activity)
</a><a href="#h12-0-73" id="h12-0-73" class="d">-        
</a><a href="#h12-0-74" id="h12-0-74" class="d">-        findViewById&lt;TextView&gt;(R.id.title).text = resources.getString(R.string.app_name) + &quot; &quot; + BuildConfig.VERSION_NAME
</a><a href="#h12-0-75" id="h12-0-75" class="d">-
</a><a href="#h12-0-76" id="h12-0-76" class="d">-        findViewById&lt;ImageButton&gt;(R.id.debug_settings_button).setOnClickListener {
</a><a href="#h12-0-77" id="h12-0-77" class="d">-            DebugSettingsLayoutInflater(this).inflate(findViewById(android.R.id.content))
</a><a href="#h12-0-78" id="h12-0-78" class="d">-        }
</a><a href="#h12-0-79" id="h12-0-79" class="d">-        
</a><a href="#h12-0-80" id="h12-0-80" class="d">-        with(findViewById&lt;RecyclerView&gt;(R.id.download_list)) {
</a><a href="#h12-0-81" id="h12-0-81" class="d">-            layoutManager = androidx.recyclerview.widget.LinearLayoutManager(this@DownloadManagerActivity)
</a><a href="#h12-0-82" id="h12-0-82" class="d">-
</a><a href="#h12-0-83" id="h12-0-83" class="d">-            adapter = DownloadListAdapter(this@DownloadManagerActivity, fetchedDownloadTasks).apply {
</a><a href="#h12-0-84" id="h12-0-84" class="d">-                registerAdapterDataObserver(object : RecyclerView.AdapterDataObserver() {
</a><a href="#h12-0-85" id="h12-0-85" class="d">-                    override fun onItemRangeRemoved(positionStart: Int, itemCount: Int) {
</a><a href="#h12-0-86" id="h12-0-86" class="d">-                        updateNoDownloadText()
</a><a href="#h12-0-87" id="h12-0-87" class="d">-                    }
</a><a href="#h12-0-88" id="h12-0-88" class="d">-                })
</a><a href="#h12-0-89" id="h12-0-89" class="d">-            }
</a><a href="#h12-0-90" id="h12-0-90" class="d">-
</a><a href="#h12-0-91" id="h12-0-91" class="d">-            ItemTouchHelper(object : ItemTouchHelper.SimpleCallback(0, ItemTouchHelper.LEFT or ItemTouchHelper.RIGHT) {
</a><a href="#h12-0-92" id="h12-0-92" class="d">-                override fun getMovementFlags(
</a><a href="#h12-0-93" id="h12-0-93" class="d">-                    recyclerView: RecyclerView,
</a><a href="#h12-0-94" id="h12-0-94" class="d">-                    viewHolder: RecyclerView.ViewHolder
</a><a href="#h12-0-95" id="h12-0-95" class="d">-                ): Int {
</a><a href="#h12-0-96" id="h12-0-96" class="d">-                    val download = fetchedDownloadTasks[viewHolder.absoluteAdapterPosition]
</a><a href="#h12-0-97" id="h12-0-97" class="d">-                    return if (download.isJobActive()) {
</a><a href="#h12-0-98" id="h12-0-98" class="d">-                        0
</a><a href="#h12-0-99" id="h12-0-99" class="d">-                    } else {
</a><a href="#h12-0-100" id="h12-0-100" class="d">-                        super.getMovementFlags(recyclerView, viewHolder)
</a><a href="#h12-0-101" id="h12-0-101" class="d">-                    }
</a><a href="#h12-0-102" id="h12-0-102" class="d">-                }
</a><a href="#h12-0-103" id="h12-0-103" class="d">-
</a><a href="#h12-0-104" id="h12-0-104" class="d">-                override fun onMove(
</a><a href="#h12-0-105" id="h12-0-105" class="d">-                    recyclerView: RecyclerView,
</a><a href="#h12-0-106" id="h12-0-106" class="d">-                    viewHolder: RecyclerView.ViewHolder,
</a><a href="#h12-0-107" id="h12-0-107" class="d">-                    target: RecyclerView.ViewHolder
</a><a href="#h12-0-108" id="h12-0-108" class="d">-                ): Boolean {
</a><a href="#h12-0-109" id="h12-0-109" class="d">-                    return false
</a><a href="#h12-0-110" id="h12-0-110" class="d">-                }
</a><a href="#h12-0-111" id="h12-0-111" class="d">-
</a><a href="#h12-0-112" id="h12-0-112" class="d">-                @SuppressLint(&quot;NotifyDataSetChanged&quot;)
</a><a href="#h12-0-113" id="h12-0-113" class="d">-                override fun onSwiped(viewHolder: RecyclerView.ViewHolder, direction: Int) {
</a><a href="#h12-0-114" id="h12-0-114" class="d">-                    fetchedDownloadTasks.removeAt(viewHolder.absoluteAdapterPosition).let {
</a><a href="#h12-0-115" id="h12-0-115" class="d">-                        SharedContext.downloadTaskManager.removeTask(it)
</a><a href="#h12-0-116" id="h12-0-116" class="d">-                    }
</a><a href="#h12-0-117" id="h12-0-117" class="d">-                    adapter?.notifyItemRemoved(viewHolder.absoluteAdapterPosition)
</a><a href="#h12-0-118" id="h12-0-118" class="d">-                }
</a><a href="#h12-0-119" id="h12-0-119" class="d">-            }).attachToRecyclerView(this)
</a><a href="#h12-0-120" id="h12-0-120" class="d">-
</a><a href="#h12-0-121" id="h12-0-121" class="d">-            var isLoading = false
</a><a href="#h12-0-122" id="h12-0-122" class="d">-
</a><a href="#h12-0-123" id="h12-0-123" class="d">-            addOnScrollListener(object : RecyclerView.OnScrollListener() {
</a><a href="#h12-0-124" id="h12-0-124" class="d">-                override fun onScrollStateChanged(recyclerView: RecyclerView, newState: Int) {
</a><a href="#h12-0-125" id="h12-0-125" class="d">-                    val layoutManager = recyclerView.layoutManager as androidx.recyclerview.widget.LinearLayoutManager
</a><a href="#h12-0-126" id="h12-0-126" class="d">-                    val lastVisibleItemPosition = layoutManager.findLastVisibleItemPosition()
</a><a href="#h12-0-127" id="h12-0-127" class="d">-
</a><a href="#h12-0-128" id="h12-0-128" class="d">-                    if (lastVisibleItemPosition == RecyclerView.NO_POSITION) {
</a><a href="#h12-0-129" id="h12-0-129" class="d">-                        return
</a><a href="#h12-0-130" id="h12-0-130" class="d">-                    }
</a><a href="#h12-0-131" id="h12-0-131" class="d">-
</a><a href="#h12-0-132" id="h12-0-132" class="d">-                    if (lastVisibleItemPosition == fetchedDownloadTasks.size - 1 &amp;&amp; !isLoading) {
</a><a href="#h12-0-133" id="h12-0-133" class="d">-                        isLoading = true
</a><a href="#h12-0-134" id="h12-0-134" class="d">-
</a><a href="#h12-0-135" id="h12-0-135" class="d">-                        SharedContext.downloadTaskManager.queryTasks(fetchedDownloadTasks.last().downloadId, filter = listFilter).forEach {
</a><a href="#h12-0-136" id="h12-0-136" class="d">-                            fetchedDownloadTasks.add(it.value)
</a><a href="#h12-0-137" id="h12-0-137" class="d">-                            adapter?.notifyItemInserted(fetchedDownloadTasks.size - 1)
</a><a href="#h12-0-138" id="h12-0-138" class="d">-                        }
</a><a href="#h12-0-139" id="h12-0-139" class="d">-
</a><a href="#h12-0-140" id="h12-0-140" class="d">-                        isLoading = false
</a><a href="#h12-0-141" id="h12-0-141" class="d">-                    }
</a><a href="#h12-0-142" id="h12-0-142" class="d">-                }
</a><a href="#h12-0-143" id="h12-0-143" class="d">-            })
</a><a href="#h12-0-144" id="h12-0-144" class="d">-    
</a><a href="#h12-0-145" id="h12-0-145" class="d">-            arrayOf(
</a><a href="#h12-0-146" id="h12-0-146" class="d">-                Pair(R.id.all_category, MediaFilter.NONE),
</a><a href="#h12-0-147" id="h12-0-147" class="d">-                Pair(R.id.pending_category, MediaFilter.PENDING),
</a><a href="#h12-0-148" id="h12-0-148" class="d">-                Pair(R.id.snap_category, MediaFilter.CHAT_MEDIA),
</a><a href="#h12-0-149" id="h12-0-149" class="d">-                Pair(R.id.story_category, MediaFilter.STORY),
</a><a href="#h12-0-150" id="h12-0-150" class="d">-                Pair(R.id.spotlight_category, MediaFilter.SPOTLIGHT)
</a><a href="#h12-0-151" id="h12-0-151" class="d">-            ).let { categoryPairs -&gt;
</a><a href="#h12-0-152" id="h12-0-152" class="d">-                categoryPairs.forEach { pair -&gt;
</a><a href="#h12-0-153" id="h12-0-153" class="d">-                    this@DownloadManagerActivity.findViewById&lt;TextView&gt;(pair.first).apply {
</a><a href="#h12-0-154" id="h12-0-154" class="d">-                        text = translation[&quot;category.${resources.getResourceEntryName(pair.first)}&quot;]
</a><a href="#h12-0-155" id="h12-0-155" class="d">-                    }.setOnClickListener { view -&gt;
</a><a href="#h12-0-156" id="h12-0-156" class="d">-                        listFilter = pair.second
</a><a href="#h12-0-157" id="h12-0-157" class="d">-                        updateListContent()
</a><a href="#h12-0-158" id="h12-0-158" class="d">-                        categoryPairs.map { this@DownloadManagerActivity.findViewById&lt;TextView&gt;(it.first) }.forEach {
</a><a href="#h12-0-159" id="h12-0-159" class="d">-                            it.setTextColor(getColor(R.color.primaryText))
</a><a href="#h12-0-160" id="h12-0-160" class="d">-                        }
</a><a href="#h12-0-161" id="h12-0-161" class="d">-                        (view as TextView).setTextColor(getColor(R.color.focusedCategoryColor))
</a><a href="#h12-0-162" id="h12-0-162" class="d">-                    }
</a><a href="#h12-0-163" id="h12-0-163" class="d">-                }
</a><a href="#h12-0-164" id="h12-0-164" class="d">-            }
</a><a href="#h12-0-165" id="h12-0-165" class="d">-
</a><a href="#h12-0-166" id="h12-0-166" class="d">-            this@DownloadManagerActivity.findViewById&lt;Button&gt;(R.id.remove_all_button).also {
</a><a href="#h12-0-167" id="h12-0-167" class="d">-                it.text = translation[&quot;remove_all&quot;]
</a><a href="#h12-0-168" id="h12-0-168" class="d">-            }.setOnClickListener {
</a><a href="#h12-0-169" id="h12-0-169" class="d">-                with(AlertDialog.Builder(this@DownloadManagerActivity)) {
</a><a href="#h12-0-170" id="h12-0-170" class="d">-                    setTitle(translation[&quot;remove_all_title&quot;])
</a><a href="#h12-0-171" id="h12-0-171" class="d">-                    setMessage(translation[&quot;remove_all_text&quot;])
</a><a href="#h12-0-172" id="h12-0-172" class="d">-                    setPositiveButton(SharedContext.translation[&quot;button.positive&quot;]) { _, _ -&gt;
</a><a href="#h12-0-173" id="h12-0-173" class="d">-                        SharedContext.downloadTaskManager.removeAllTasks()
</a><a href="#h12-0-174" id="h12-0-174" class="d">-                        fetchedDownloadTasks.removeIf {
</a><a href="#h12-0-175" id="h12-0-175" class="d">-                            if (it.isJobActive()) it.cancel()
</a><a href="#h12-0-176" id="h12-0-176" class="d">-                            true
</a><a href="#h12-0-177" id="h12-0-177" class="d">-                        }
</a><a href="#h12-0-178" id="h12-0-178" class="d">-                        adapter?.notifyDataSetChanged()
</a><a href="#h12-0-179" id="h12-0-179" class="d">-                        updateNoDownloadText()
</a><a href="#h12-0-180" id="h12-0-180" class="d">-                    }
</a><a href="#h12-0-181" id="h12-0-181" class="d">-                    setNegativeButton(SharedContext.translation[&quot;button.negative&quot;]) { dialog, _ -&gt;
</a><a href="#h12-0-182" id="h12-0-182" class="d">-                        dialog.dismiss()
</a><a href="#h12-0-183" id="h12-0-183" class="d">-                    }
</a><a href="#h12-0-184" id="h12-0-184" class="d">-                    show()
</a><a href="#h12-0-185" id="h12-0-185" class="d">-                }
</a><a href="#h12-0-186" id="h12-0-186" class="d">-            }
</a><a href="#h12-0-187" id="h12-0-187" class="d">-
</a><a href="#h12-0-188" id="h12-0-188" class="d">-        }
</a><a href="#h12-0-189" id="h12-0-189" class="d">-
</a><a href="#h12-0-190" id="h12-0-190" class="d">-        updateListContent()
</a><a href="#h12-0-191" id="h12-0-191" class="d">-
</a><a href="#h12-0-192" id="h12-0-192" class="d">-        if (!preferences.getBoolean(&quot;ask_battery_optimisations&quot;, true) ||
</a><a href="#h12-0-193" id="h12-0-193" class="d">-            !(getSystemService(Context.POWER_SERVICE) as PowerManager).isIgnoringBatteryOptimizations(packageName)) return
</a><a href="#h12-0-194" id="h12-0-194" class="d">-
</a><a href="#h12-0-195" id="h12-0-195" class="d">-        with(Intent()) {
</a><a href="#h12-0-196" id="h12-0-196" class="d">-            action = Settings.ACTION_REQUEST_IGNORE_BATTERY_OPTIMIZATIONS
</a><a href="#h12-0-197" id="h12-0-197" class="d">-            data = Uri.parse(&quot;package:$packageName&quot;)
</a><a href="#h12-0-198" id="h12-0-198" class="d">-            startActivityForResult(this, 1)
</a><a href="#h12-0-199" id="h12-0-199" class="d">-        }
</a><a href="#h12-0-200" id="h12-0-200" class="d">-    }
</a><a href="#h12-0-201" id="h12-0-201" class="d">-
</a><a href="#h12-0-202" id="h12-0-202" class="d">-    override fun onActivityResult(requestCode: Int, resultCode: Int, data: Intent?) {
</a><a href="#h12-0-203" id="h12-0-203" class="d">-        if (requestCode == 1) {
</a><a href="#h12-0-204" id="h12-0-204" class="d">-            preferences.edit().putBoolean(&quot;ask_battery_optimisations&quot;, false).apply()
</a><a href="#h12-0-205" id="h12-0-205" class="d">-        }
</a><a href="#h12-0-206" id="h12-0-206" class="d">-    }
</a><a href="#h12-0-207" id="h12-0-207" class="d">-
</a><a href="#h12-0-208" id="h12-0-208" class="d">-    @SuppressLint(&quot;NotifyDataSetChanged&quot;)
</a><a href="#h12-0-209" id="h12-0-209" class="d">-    override fun onResume() {
</a><a href="#h12-0-210" id="h12-0-210" class="d">-        super.onResume()
</a><a href="#h12-0-211" id="h12-0-211" class="d">-        updateListContent()
</a><a href="#h12-0-212" id="h12-0-212" class="d">-    }
</a><a href="#h12-0-213" id="h12-0-213" class="d">-}</a><a href="#h12-0-214" id="h12-0-214" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h13" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/ui/download/MediaFilter.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/ui/download/MediaFilter.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/ui/download/MediaFilter.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/ui/download/MediaFilter.kt</a></b>
<a href="#h13-0" id="h13-0" class="h">@@ -1,17 +0,0 @@
</a><a href="#h13-0-0" id="h13-0-0" class="d">-package me.rhunk.snapenhance.ui.download
</a><a href="#h13-0-1" id="h13-0-1" class="d">-
</a><a href="#h13-0-2" id="h13-0-2" class="d">-enum class MediaFilter(
</a><a href="#h13-0-3" id="h13-0-3" class="d">-    val key: String,
</a><a href="#h13-0-4" id="h13-0-4" class="d">-    val shouldIgnoreFilter: Boolean = false
</a><a href="#h13-0-5" id="h13-0-5" class="d">-) {
</a><a href="#h13-0-6" id="h13-0-6" class="d">-    NONE(&quot;none&quot;, true),
</a><a href="#h13-0-7" id="h13-0-7" class="d">-    PENDING(&quot;pending&quot;, true),
</a><a href="#h13-0-8" id="h13-0-8" class="d">-    CHAT_MEDIA(&quot;chat_media&quot;),
</a><a href="#h13-0-9" id="h13-0-9" class="d">-    STORY(&quot;story&quot;),
</a><a href="#h13-0-10" id="h13-0-10" class="d">-    SPOTLIGHT(&quot;spotlight&quot;);
</a><a href="#h13-0-11" id="h13-0-11" class="d">-
</a><a href="#h13-0-12" id="h13-0-12" class="d">-    fun matches(source: String?): Boolean {
</a><a href="#h13-0-13" id="h13-0-13" class="d">-        if (source == null) return false
</a><a href="#h13-0-14" id="h13-0-14" class="d">-        return source.contains(key, ignoreCase = true)
</a><a href="#h13-0-15" id="h13-0-15" class="d">-    }
</a><a href="#h13-0-16" id="h13-0-16" class="d">-}</a><a href="#h13-0-17" id="h13-0-17" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h14" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/ui/map/MapActivity.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/ui/map/MapActivity.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/ui/map/MapActivity.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/ui/map/MapActivity.kt</a></b>
<a href="#h14-0" id="h14-0" class="h">@@ -1,98 +0,0 @@
</a><a href="#h14-0-0" id="h14-0-0" class="d">-package me.rhunk.snapenhance.ui.map
</a><a href="#h14-0-1" id="h14-0-1" class="d">-
</a><a href="#h14-0-2" id="h14-0-2" class="d">-import android.annotation.SuppressLint
</a><a href="#h14-0-3" id="h14-0-3" class="d">-import android.app.Activity
</a><a href="#h14-0-4" id="h14-0-4" class="d">-import android.app.AlertDialog
</a><a href="#h14-0-5" id="h14-0-5" class="d">-import android.content.Context
</a><a href="#h14-0-6" id="h14-0-6" class="d">-import android.os.Bundle
</a><a href="#h14-0-7" id="h14-0-7" class="d">-import android.view.MotionEvent
</a><a href="#h14-0-8" id="h14-0-8" class="d">-import android.widget.Button
</a><a href="#h14-0-9" id="h14-0-9" class="d">-import android.widget.EditText
</a><a href="#h14-0-10" id="h14-0-10" class="d">-import me.rhunk.snapenhance.core.R
</a><a href="#h14-0-11" id="h14-0-11" class="d">-import org.osmdroid.config.Configuration
</a><a href="#h14-0-12" id="h14-0-12" class="d">-import org.osmdroid.tileprovider.tilesource.TileSourceFactory
</a><a href="#h14-0-13" id="h14-0-13" class="d">-import org.osmdroid.util.GeoPoint
</a><a href="#h14-0-14" id="h14-0-14" class="d">-import org.osmdroid.views.MapView
</a><a href="#h14-0-15" id="h14-0-15" class="d">-import org.osmdroid.views.Projection
</a><a href="#h14-0-16" id="h14-0-16" class="d">-import org.osmdroid.views.overlay.Marker
</a><a href="#h14-0-17" id="h14-0-17" class="d">-import org.osmdroid.views.overlay.Overlay
</a><a href="#h14-0-18" id="h14-0-18" class="d">-
</a><a href="#h14-0-19" id="h14-0-19" class="d">-
</a><a href="#h14-0-20" id="h14-0-20" class="d">-class MapActivity : Activity() {
</a><a href="#h14-0-21" id="h14-0-21" class="d">-
</a><a href="#h14-0-22" id="h14-0-22" class="d">-    private lateinit var mapView: MapView
</a><a href="#h14-0-23" id="h14-0-23" class="d">-
</a><a href="#h14-0-24" id="h14-0-24" class="d">-    @SuppressLint(&quot;MissingInflatedId&quot;, &quot;ResourceType&quot;)
</a><a href="#h14-0-25" id="h14-0-25" class="d">-    override fun onCreate(savedInstanceState: Bundle?) {
</a><a href="#h14-0-26" id="h14-0-26" class="d">-        super.onCreate(savedInstanceState)
</a><a href="#h14-0-27" id="h14-0-27" class="d">-
</a><a href="#h14-0-28" id="h14-0-28" class="d">-        val contextBundle = intent.extras?.getBundle(&quot;location&quot;) ?: return
</a><a href="#h14-0-29" id="h14-0-29" class="d">-        val locationLatitude = contextBundle.getDouble(&quot;latitude&quot;)
</a><a href="#h14-0-30" id="h14-0-30" class="d">-        val locationLongitude = contextBundle.getDouble(&quot;longitude&quot;)
</a><a href="#h14-0-31" id="h14-0-31" class="d">-
</a><a href="#h14-0-32" id="h14-0-32" class="d">-        Configuration.getInstance().load(applicationContext, getSharedPreferences(&quot;osmdroid&quot;, Context.MODE_PRIVATE))
</a><a href="#h14-0-33" id="h14-0-33" class="d">-
</a><a href="#h14-0-34" id="h14-0-34" class="d">-        setContentView(R.layout.map)
</a><a href="#h14-0-35" id="h14-0-35" class="d">-
</a><a href="#h14-0-36" id="h14-0-36" class="d">-        mapView = findViewById(R.id.mapView)
</a><a href="#h14-0-37" id="h14-0-37" class="d">-        mapView.setMultiTouchControls(true);
</a><a href="#h14-0-38" id="h14-0-38" class="d">-        mapView.setTileSource(TileSourceFactory.MAPNIK)
</a><a href="#h14-0-39" id="h14-0-39" class="d">-
</a><a href="#h14-0-40" id="h14-0-40" class="d">-        val startPoint = GeoPoint(locationLatitude, locationLongitude)
</a><a href="#h14-0-41" id="h14-0-41" class="d">-        mapView.controller.setZoom(10.0)
</a><a href="#h14-0-42" id="h14-0-42" class="d">-        mapView.controller.setCenter(startPoint)
</a><a href="#h14-0-43" id="h14-0-43" class="d">-
</a><a href="#h14-0-44" id="h14-0-44" class="d">-        val marker = Marker(mapView)
</a><a href="#h14-0-45" id="h14-0-45" class="d">-        marker.isDraggable = true
</a><a href="#h14-0-46" id="h14-0-46" class="d">-        marker.position = startPoint
</a><a href="#h14-0-47" id="h14-0-47" class="d">-        marker.setAnchor(Marker.ANCHOR_CENTER, Marker.ANCHOR_BOTTOM)
</a><a href="#h14-0-48" id="h14-0-48" class="d">-
</a><a href="#h14-0-49" id="h14-0-49" class="d">-        mapView.overlays.add(object: Overlay() {
</a><a href="#h14-0-50" id="h14-0-50" class="d">-            override fun onSingleTapConfirmed(e: MotionEvent?, mapView: MapView?): Boolean {
</a><a href="#h14-0-51" id="h14-0-51" class="d">-                val proj: Projection = mapView!!.projection
</a><a href="#h14-0-52" id="h14-0-52" class="d">-                val loc = proj.fromPixels(e!!.x.toInt(), e.y.toInt()) as GeoPoint
</a><a href="#h14-0-53" id="h14-0-53" class="d">-                marker.position = loc
</a><a href="#h14-0-54" id="h14-0-54" class="d">-                mapView.invalidate()
</a><a href="#h14-0-55" id="h14-0-55" class="d">-                return true
</a><a href="#h14-0-56" id="h14-0-56" class="d">-            }
</a><a href="#h14-0-57" id="h14-0-57" class="d">-        })
</a><a href="#h14-0-58" id="h14-0-58" class="d">-
</a><a href="#h14-0-59" id="h14-0-59" class="d">-        mapView.overlays.add(marker)
</a><a href="#h14-0-60" id="h14-0-60" class="d">-
</a><a href="#h14-0-61" id="h14-0-61" class="d">-        val applyButton = findViewById&lt;Button&gt;(R.id.apply_location_button)
</a><a href="#h14-0-62" id="h14-0-62" class="d">-        applyButton.setOnClickListener {
</a><a href="#h14-0-63" id="h14-0-63" class="d">-            val bundle = Bundle()
</a><a href="#h14-0-64" id="h14-0-64" class="d">-            bundle.putFloat(&quot;latitude&quot;, marker.position.latitude.toFloat())
</a><a href="#h14-0-65" id="h14-0-65" class="d">-            bundle.putFloat(&quot;longitude&quot;, marker.position.longitude.toFloat())
</a><a href="#h14-0-66" id="h14-0-66" class="d">-            setResult(RESULT_OK, intent.putExtra(&quot;location&quot;, bundle))
</a><a href="#h14-0-67" id="h14-0-67" class="d">-            finish()
</a><a href="#h14-0-68" id="h14-0-68" class="d">-        }
</a><a href="#h14-0-69" id="h14-0-69" class="d">-
</a><a href="#h14-0-70" id="h14-0-70" class="d">-        val setPreciseLocationButton = findViewById&lt;Button&gt;(R.id.set_precise_location_button)
</a><a href="#h14-0-71" id="h14-0-71" class="d">-
</a><a href="#h14-0-72" id="h14-0-72" class="d">-        setPreciseLocationButton.setOnClickListener {
</a><a href="#h14-0-73" id="h14-0-73" class="d">-            val locationDialog = layoutInflater.inflate(R.layout.precise_location_dialog, null)
</a><a href="#h14-0-74" id="h14-0-74" class="d">-            val dialogLatitude = locationDialog.findViewById&lt;EditText&gt;(R.id.dialog_latitude).also { it.setText(marker.position.latitude.toString()) }
</a><a href="#h14-0-75" id="h14-0-75" class="d">-            val dialogLongitude = locationDialog.findViewById&lt;EditText&gt;(R.id.dialog_longitude).also { it.setText(marker.position.longitude.toString()) }
</a><a href="#h14-0-76" id="h14-0-76" class="d">-
</a><a href="#h14-0-77" id="h14-0-77" class="d">-            AlertDialog.Builder(this)
</a><a href="#h14-0-78" id="h14-0-78" class="d">-                .setView(locationDialog)
</a><a href="#h14-0-79" id="h14-0-79" class="d">-                .setTitle(&quot;Set a precise location&quot;)
</a><a href="#h14-0-80" id="h14-0-80" class="d">-                .setPositiveButton(&quot;Set&quot;) { _, _ -&gt;
</a><a href="#h14-0-81" id="h14-0-81" class="d">-                    val latitude = dialogLatitude.text.toString().toDoubleOrNull()
</a><a href="#h14-0-82" id="h14-0-82" class="d">-                    val longitude = dialogLongitude.text.toString().toDoubleOrNull()
</a><a href="#h14-0-83" id="h14-0-83" class="d">-                    if (latitude != null &amp;&amp; longitude != null) {
</a><a href="#h14-0-84" id="h14-0-84" class="d">-                        val preciseLocation = GeoPoint(latitude, longitude)
</a><a href="#h14-0-85" id="h14-0-85" class="d">-                        mapView.controller.setCenter(preciseLocation)
</a><a href="#h14-0-86" id="h14-0-86" class="d">-                        marker.position = preciseLocation
</a><a href="#h14-0-87" id="h14-0-87" class="d">-                        mapView.invalidate()
</a><a href="#h14-0-88" id="h14-0-88" class="d">-                    }
</a><a href="#h14-0-89" id="h14-0-89" class="d">-                }.setNegativeButton(&quot;Cancel&quot;) { _, _ -&gt; }.show()
</a><a href="#h14-0-90" id="h14-0-90" class="d">-        }
</a><a href="#h14-0-91" id="h14-0-91" class="d">-    }
</a><a href="#h14-0-92" id="h14-0-92" class="d">-
</a><a href="#h14-0-93" id="h14-0-93" class="d">-    override fun onDestroy() {
</a><a href="#h14-0-94" id="h14-0-94" class="d">-        super.onDestroy()
</a><a href="#h14-0-95" id="h14-0-95" class="d">-        mapView.onDetach()
</a><a href="#h14-0-96" id="h14-0-96" class="d">-    }
</a><a href="#h14-0-97" id="h14-0-97" class="d">-}
</a></pre>
</div>
</body>
</html>
