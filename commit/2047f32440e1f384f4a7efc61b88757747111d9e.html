<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>feat(manager): LSPatch tab - SnapEnhance - An Xposed module offering an enhanced Snapchat experience
</title>
<link rel="icon" type="image/svg+xml" href="../../logo.png"/>
<link rel="alternate icon" href="../../favicon.png"/>
<link rel="alternate" type="application/atom+xml" title="SnapEnhance Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="SnapEnhance Atom Feed (tags)" href="../tags.xml" />
<link rel="stylesheet" type="text/css" href="../../style.css" />
<link rel="stylesheet" type="text/css" href="../../fonts.css" />
</head>
<body>
<div id="head"><table><tr><td><a class="logo" href="../../"><img src="../../logo.png" alt="" width="32" height="32" /></a></td><td><strong>SnapEnhance</strong><span class="desc"> - An Xposed module offering an enhanced Snapchat experience
</span>
</td></tr></table>
<p><a href="../about.html">About</a> | <a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/LICENSE.html">License</a></p>
</div>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/2047f32440e1f384f4a7efc61b88757747111d9e.html">2047f32440e1f384f4a7efc61b88757747111d9e</a>
<b>parent</b> <a href="../commit/1a488425b2e11163acc606ca1c054a7834749ad6.html">1a488425b2e11163acc606ca1c054a7834749ad6</a>
<b>Author:</b> rhunk &lt;<a href="mailto:101876869+rhunk@users.noreply.github.com">101876869+rhunk@users.noreply.github.com</a>&gt;
<b>Date:</b>   Mon, 30 Oct 2023 13:01:47 +0100

feat(manager): LSPatch tab

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">manager/proguard-rules.pro</a></td><td> | </td><td class="num">5</td><td><span class="i">+++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">manager/src/main/kotlin/me/rhunk/snapenhance/manager/data/APKMirror.kt</a></td><td> | </td><td class="num">9</td><td><span class="i">++++++++</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h2">manager/src/main/kotlin/me/rhunk/snapenhance/manager/data/SharedConfig.kt</a></td><td> | </td><td class="num">10</td><td><span class="i">++++++++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h3">manager/src/main/kotlin/me/rhunk/snapenhance/manager/lspatch/LSPatch.kt</a></td><td> | </td><td class="num">15</td><td><span class="i">+++++++</span><span class="d">--------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h4">manager/src/main/kotlin/me/rhunk/snapenhance/manager/ui/MainActivity.kt</a></td><td> | </td><td class="num">3</td><td><span class="i">++</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h5">manager/src/main/kotlin/me/rhunk/snapenhance/manager/ui/Navigation.kt</a></td><td> | </td><td class="num">25</td><td><span class="i">+++++++++++</span><span class="d">--------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h6">manager/src/main/kotlin/me/rhunk/snapenhance/manager/ui/Tab.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h7">manager/src/main/kotlin/me/rhunk/snapenhance/manager/ui/components/Dialogs.kt</a></td><td> | </td><td class="num">32</td><td><span class="i">++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h8">manager/src/main/kotlin/me/rhunk/snapenhance/manager/ui/tab/HomeTab.kt</a></td><td> | </td><td class="num">58</td><td><span class="i">+++++++++++++++++++++++++++++</span><span class="d">-----------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h9">manager/src/main/kotlin/me/rhunk/snapenhance/manager/ui/tab/download/InstallAppTab.kt</a></td><td> | </td><td class="num">176</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="A">A</td><td><a href="#h10">manager/src/main/kotlin/me/rhunk/snapenhance/manager/ui/tab/download/InstallPackageTab.kt</a></td><td> | </td><td class="num">190</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h11">manager/src/main/kotlin/me/rhunk/snapenhance/manager/ui/tab/download/LSPatchTab.kt</a></td><td> | </td><td class="num">198</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h12">manager/src/main/kotlin/me/rhunk/snapenhance/manager/ui/tab/download/SEDownloadTab.kt</a></td><td> | </td><td class="num">62</td><td><span class="i">+++++++++++++++</span><span class="d">-----------------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h13">manager/src/main/kotlin/me/rhunk/snapenhance/manager/ui/tab/download/SnapchatPatchTab.kt</a></td><td> | </td><td class="num">273</td><td><span class="i">+++++++++++++++++++++++++++++++++++++</span><span class="d">------------------------------------------</span></td></tr>
</table></pre><pre>14 files changed, 632 insertions(+), 426 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/manager/proguard-rules.pro.html">manager/proguard-rules.pro</a> b/<a href="../file/manager/proguard-rules.pro.html">manager/proguard-rules.pro</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -1,2 +1,3 @@
</a> -dontwarn com.google.errorprone.annotations.**
<a href="#h0-0-1" id="h0-0-1" class="d">--dontwarn com.google.auto.value.**</a><a href="#h0-0-2" id="h0-0-2" class="d">-
\ No newline at end of file
</a><a href="#h0-0-3" id="h0-0-3" class="i">+-dontwarn com.google.auto.value.**
</a><a href="#h0-0-4" id="h0-0-4" class="i">+-keep enum me.rhunk.snapenhance.manager.** { *; }</a><a href="#h0-0-5" id="h0-0-5" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h1" href="../file/manager/src/main/kotlin/me/rhunk/snapenhance/manager/data/APKMirror.kt.html">manager/src/main/kotlin/me/rhunk/snapenhance/manager/data/APKMirror.kt</a> b/<a href="../file/manager/src/main/kotlin/me/rhunk/snapenhance/manager/data/APKMirror.kt.html">manager/src/main/kotlin/me/rhunk/snapenhance/manager/data/APKMirror.kt</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -1,17 +1,24 @@
</a> package me.rhunk.snapenhance.manager.data
 
<a href="#h1-0-2" id="h1-0-2" class="i">+import android.os.Parcelable
</a><a href="#h1-0-3" id="h1-0-3" class="i">+import kotlinx.parcelize.IgnoredOnParcel
</a><a href="#h1-0-4" id="h1-0-4" class="i">+import kotlinx.parcelize.Parcelize
</a> import okhttp3.OkHttpClient
 import okhttp3.Request
 import org.jsoup.Jsoup
 import kotlin.math.absoluteValue
 
<a href="#h1-0-10" id="h1-0-10" class="i">+@Parcelize
</a> data class DownloadItem(
     val title: String,
     val releaseDate: String,
     val downloadPage: String
<a href="#h1-0-15" id="h1-0-15" class="d">-) {
</a><a href="#h1-0-16" id="h1-0-16" class="i">+): Parcelable {
</a><a href="#h1-0-17" id="h1-0-17" class="i">+    @IgnoredOnParcel
</a>     val shortTitle = title.substringBefore(&quot;(&quot;).trim()
<a href="#h1-0-19" id="h1-0-19" class="i">+    @IgnoredOnParcel
</a>     val hash = (title + releaseDate + downloadPage).hashCode().absoluteValue.toString(16)
<a href="#h1-0-21" id="h1-0-21" class="i">+    @IgnoredOnParcel
</a>     val isBeta = title.contains(&quot;Beta&quot;, ignoreCase = true)
 }
 
<b>diff --git a/<a id="h2" href="../file/manager/src/main/kotlin/me/rhunk/snapenhance/manager/data/SharedConfig.kt.html">manager/src/main/kotlin/me/rhunk/snapenhance/manager/data/SharedConfig.kt</a> b/<a href="../file/manager/src/main/kotlin/me/rhunk/snapenhance/manager/data/SharedConfig.kt.html">manager/src/main/kotlin/me/rhunk/snapenhance/manager/data/SharedConfig.kt</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -7,9 +7,15 @@ class SharedConfig(
</a> ) {
     private val sharedPreferences = context.getSharedPreferences(&quot;snapenhance&quot;, Context.MODE_PRIVATE)
 
<a href="#h2-0-3" id="h2-0-3" class="d">-    var snapchatPackageName get() = sharedPreferences.getString(&quot;snapchatPackageName&quot;, &quot;com.snapchat.android&quot;)?.takeIf { it.isNotEmpty() }
</a><a href="#h2-0-4" id="h2-0-4" class="i">+    val apkCache by lazy {
</a><a href="#h2-0-5" id="h2-0-5" class="i">+        context.cacheDir.resolve(&quot;snapchat_apk_cache&quot;).also {
</a><a href="#h2-0-6" id="h2-0-6" class="i">+            if (!it.exists()) it.mkdirs()
</a><a href="#h2-0-7" id="h2-0-7" class="i">+        }
</a><a href="#h2-0-8" id="h2-0-8" class="i">+    }
</a><a href="#h2-0-9" id="h2-0-9" class="i">+
</a><a href="#h2-0-10" id="h2-0-10" class="i">+    var snapchatPackageName get() = sharedPreferences.getString(&quot;snapchatPackageName&quot;, &quot;com.snapchat.android&quot;)?.takeIf { it.isNotEmpty() } ?: &quot;com.snapchat.android&quot;
</a>         set(value) = sharedPreferences.edit().putString(&quot;snapchatPackageName&quot;, value).apply()
 
<a href="#h2-0-13" id="h2-0-13" class="d">-    var snapEnhancePackageName get() = sharedPreferences.getString(&quot;snapEnhancePackageName&quot;, &quot;me.rhunk.snapenhance&quot;)?.takeIf { it.isNotEmpty() }
</a><a href="#h2-0-14" id="h2-0-14" class="i">+    var snapEnhancePackageName get() = sharedPreferences.getString(&quot;snapEnhancePackageName&quot;, &quot;me.rhunk.snapenhance&quot;)?.takeIf { it.isNotEmpty() } ?: &quot;me.rhunk.snapenhance&quot;
</a>         set(value) = sharedPreferences.edit().putString(&quot;snapEnhancePackageName&quot;, value).apply()
 } 
\ No newline at end of file
<b>diff --git a/<a id="h3" href="../file/manager/src/main/kotlin/me/rhunk/snapenhance/manager/lspatch/LSPatch.kt.html">manager/src/main/kotlin/me/rhunk/snapenhance/manager/lspatch/LSPatch.kt</a> b/<a href="../file/manager/src/main/kotlin/me/rhunk/snapenhance/manager/lspatch/LSPatch.kt.html">manager/src/main/kotlin/me/rhunk/snapenhance/manager/lspatch/LSPatch.kt</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -137,8 +137,9 @@ class LSPatch(
</a>         }
 
         //embed modules
<a href="#h3-0-3" id="h3-0-3" class="d">-        printLog(&quot;embedding modules&quot;)
</a><a href="#h3-0-4" id="h3-0-4" class="i">+        printLog(&quot;Embedding modules&quot;)
</a>         modules.forEach { (packageName, module) -&gt;
<a href="#h3-0-6" id="h3-0-6" class="i">+            printLog(&quot;- $packageName&quot;)
</a>             dstZFile.add(&quot;assets/lspatch/modules/$packageName.apk&quot;, module.inputStream())
         }
 
<a href="#h3-1" id="h3-1" class="h">@@ -162,17 +163,17 @@ class LSPatch(
</a>         printLog(&quot;Done&quot;)
     }
 
<a href="#h3-1-3" id="h3-1-3" class="d">-    fun patchSplits(inputs: List&lt;File&gt;): List&lt;File&gt; {
</a><a href="#h3-1-4" id="h3-1-4" class="d">-        val outputs = mutableListOf&lt;File&gt;()
</a><a href="#h3-1-5" id="h3-1-5" class="i">+    fun patchSplits(inputs: List&lt;File&gt;): Map&lt;String, File&gt; {
</a><a href="#h3-1-6" id="h3-1-6" class="i">+        val outputs = mutableMapOf&lt;String, File&gt;()
</a>         inputs.forEach { input -&gt;
<a href="#h3-1-8" id="h3-1-8" class="d">-            val outputFile = File.createTempFile(&quot;patched&quot;, &quot;.apk&quot;, context.cacheDir)
</a><a href="#h3-1-9" id="h3-1-9" class="i">+            val outputFile = File.createTempFile(&quot;patched&quot;, &quot;.apk&quot;, context.externalCacheDir ?: context.cacheDir)
</a>             if (input.name.contains(&quot;split&quot;)) {
                 resignApk(input, outputFile)
<a href="#h3-1-12" id="h3-1-12" class="d">-                outputs.add(outputFile)
</a><a href="#h3-1-13" id="h3-1-13" class="i">+                outputs[input.name] = outputFile
</a>                 return@forEach
             }
             patch(input, outputFile)
<a href="#h3-1-17" id="h3-1-17" class="d">-            outputs.add(outputFile)
</a><a href="#h3-1-18" id="h3-1-18" class="i">+            outputs[&quot;base.apk&quot;] = outputFile
</a>         }
         return outputs
     }
<a href="#h3-2" id="h3-2" class="h">@@ -206,8 +207,6 @@ class LSPatch(
</a>             outputFile.delete()
             printLog(&quot;Failed to patch&quot;)
             printLog(it)
<a href="#h3-2-3" id="h3-2-3" class="d">-        }.onSuccess {
</a><a href="#h3-2-4" id="h3-2-4" class="d">-            outputFile.delete()
</a>         }
     }
 } 
\ No newline at end of file
<b>diff --git a/<a id="h4" href="../file/manager/src/main/kotlin/me/rhunk/snapenhance/manager/ui/MainActivity.kt.html">manager/src/main/kotlin/me/rhunk/snapenhance/manager/ui/MainActivity.kt</a> b/<a href="../file/manager/src/main/kotlin/me/rhunk/snapenhance/manager/ui/MainActivity.kt.html">manager/src/main/kotlin/me/rhunk/snapenhance/manager/ui/MainActivity.kt</a></b>
<a href="#h4-0" id="h4-0" class="h">@@ -12,10 +12,11 @@ import androidx.navigation.compose.rememberNavController
</a> import me.rhunk.snapenhance.manager.data.SharedConfig
 import me.rhunk.snapenhance.manager.ui.tab.HomeTab
 import me.rhunk.snapenhance.manager.ui.tab.SettingsTab
<a href="#h4-0-3" id="h4-0-3" class="i">+import me.rhunk.snapenhance.manager.ui.tab.download.InstallPackageTab
</a> 
 class MainActivity : ComponentActivity() {
     companion object{
<a href="#h4-0-7" id="h4-0-7" class="d">-        private val primaryTabs = listOf(HomeTab::class, SettingsTab::class)
</a><a href="#h4-0-8" id="h4-0-8" class="i">+        private val primaryTabs = listOf(HomeTab::class, SettingsTab::class, InstallPackageTab::class)
</a>     }
 
     override fun onCreate(savedInstanceState: Bundle?) {
<b>diff --git a/<a id="h5" href="../file/manager/src/main/kotlin/me/rhunk/snapenhance/manager/ui/Navigation.kt.html">manager/src/main/kotlin/me/rhunk/snapenhance/manager/ui/Navigation.kt</a> b/<a href="../file/manager/src/main/kotlin/me/rhunk/snapenhance/manager/ui/Navigation.kt.html">manager/src/main/kotlin/me/rhunk/snapenhance/manager/ui/Navigation.kt</a></b>
<a href="#h5-0" id="h5-0" class="h">@@ -50,25 +50,22 @@ class Navigation(
</a>         tabs.firstOrNull { it.route == navBackStackEntry?.destination?.route }?.FloatingActionButtons()
     }
 
<a href="#h5-0-3" id="h5-0-3" class="d">-    fun navigateTo(tab: KClass&lt;out Tab&gt;) {
</a><a href="#h5-0-4" id="h5-0-4" class="d">-        navHostController.navigate(tabs.first { it::class == tab }.route)
</a><a href="#h5-0-5" id="h5-0-5" class="d">-    }
</a><a href="#h5-0-6" id="h5-0-6" class="d">-
</a><a href="#h5-0-7" id="h5-0-7" class="d">-    fun navigateTo(tab: KClass&lt;out Tab&gt;, noHistory: Boolean) {
</a><a href="#h5-0-8" id="h5-0-8" class="i">+    fun navigateTo(tab: KClass&lt;out Tab&gt;, noHistory: Boolean = false) {
</a>         navHostController.navigate(tabs.first { it::class == tab }.route) {
<a href="#h5-0-10" id="h5-0-10" class="d">-            restoreState = false
</a><a href="#h5-0-11" id="h5-0-11" class="d">-            launchSingleTop = true
</a><a href="#h5-0-12" id="h5-0-12" class="d">-            popUpTo(navHostController.graph.findStartDestination().id) {
</a><a href="#h5-0-13" id="h5-0-13" class="d">-                saveState = true
</a><a href="#h5-0-14" id="h5-0-14" class="i">+            if (noHistory) {
</a><a href="#h5-0-15" id="h5-0-15" class="i">+                restoreState = false
</a><a href="#h5-0-16" id="h5-0-16" class="i">+                launchSingleTop = true
</a><a href="#h5-0-17" id="h5-0-17" class="i">+                popUpTo(navHostController.graph.findStartDestination().id) {
</a><a href="#h5-0-18" id="h5-0-18" class="i">+                    saveState = true
</a><a href="#h5-0-19" id="h5-0-19" class="i">+                }
</a>             }
         }
     }
 
<a href="#h5-0-24" id="h5-0-24" class="d">-    fun navigateTo(tab: KClass&lt;out Tab&gt;, args: Bundle) {
</a><a href="#h5-0-25" id="h5-0-25" class="d">-        navHostController.currentBackStackEntry?.savedStateHandle?.apply {
</a><a href="#h5-0-26" id="h5-0-26" class="d">-            set(&quot;args&quot;, args)
</a><a href="#h5-0-27" id="h5-0-27" class="d">-        }
</a><a href="#h5-0-28" id="h5-0-28" class="d">-        navigateTo(tab)
</a><a href="#h5-0-29" id="h5-0-29" class="i">+
</a><a href="#h5-0-30" id="h5-0-30" class="i">+    fun navigateTo(tab: KClass&lt;out Tab&gt;, args: Bundle, noHistory: Boolean = false) {
</a><a href="#h5-0-31" id="h5-0-31" class="i">+        navigateTo(tab, noHistory)
</a><a href="#h5-0-32" id="h5-0-32" class="i">+        navHostController.currentBackStackEntry?.savedStateHandle?.set(&quot;args&quot;, args)
</a>     }
 
     @Composable
<b>diff --git a/<a id="h6" href="../file/manager/src/main/kotlin/me/rhunk/snapenhance/manager/ui/Tab.kt.html">manager/src/main/kotlin/me/rhunk/snapenhance/manager/ui/Tab.kt</a> b/<a href="../file/manager/src/main/kotlin/me/rhunk/snapenhance/manager/ui/Tab.kt.html">manager/src/main/kotlin/me/rhunk/snapenhance/manager/ui/Tab.kt</a></b>
<a href="#h6-0" id="h6-0" class="h">@@ -27,7 +27,7 @@ open class Tab(
</a>     lateinit var navigation: Navigation
     lateinit var sharedConfig: SharedConfig
 
<a href="#h6-0-3" id="h6-0-3" class="d">-    fun getArguments() = navigation.navHostController.previousBackStackEntry?.savedStateHandle?.get&lt;Bundle&gt;(&quot;args&quot;)
</a><a href="#h6-0-4" id="h6-0-4" class="i">+    fun getArguments() = navigation.navHostController.currentBackStackEntry?.savedStateHandle?.get&lt;Bundle&gt;(&quot;args&quot;)
</a> 
     open fun init(activity: ComponentActivity) {
         this.activity = activity
<b>diff --git a/<a id="h7" href="../file/manager/src/main/kotlin/me/rhunk/snapenhance/manager/ui/components/Dialogs.kt.html">manager/src/main/kotlin/me/rhunk/snapenhance/manager/ui/components/Dialogs.kt</a> b/<a href="../file/manager/src/main/kotlin/me/rhunk/snapenhance/manager/ui/components/Dialogs.kt.html">manager/src/main/kotlin/me/rhunk/snapenhance/manager/ui/components/Dialogs.kt</a></b>
<a href="#h7-0" id="h7-0" class="h">@@ -9,8 +9,10 @@ import androidx.compose.material3.Button
</a> import androidx.compose.material3.Card
 import androidx.compose.material3.Text
 import androidx.compose.runtime.Composable
<a href="#h7-0-3" id="h7-0-3" class="i">+import androidx.compose.ui.Alignment
</a> import androidx.compose.ui.Modifier
 import androidx.compose.ui.unit.dp
<a href="#h7-0-6" id="h7-0-6" class="i">+import androidx.compose.ui.unit.sp
</a> 
 
 @Composable
<a href="#h7-1" id="h7-1" class="h">@@ -34,4 +36,34 @@ fun ConfirmationDialog(title: String, onDismiss: () -&gt; Unit, onConfirm: () -&gt; Un
</a>             }
         }
     }
<a href="#h7-1-3" id="h7-1-3" class="i">+}
</a><a href="#h7-1-4" id="h7-1-4" class="i">+
</a><a href="#h7-1-5" id="h7-1-5" class="i">+
</a><a href="#h7-1-6" id="h7-1-6" class="i">+@Composable
</a><a href="#h7-1-7" id="h7-1-7" class="i">+fun DowngradeNoticeDialog(onDismiss: () -&gt; Unit, onSuccess: () -&gt; Unit) {
</a><a href="#h7-1-8" id="h7-1-8" class="i">+    Card {
</a><a href="#h7-1-9" id="h7-1-9" class="i">+        Column(
</a><a href="#h7-1-10" id="h7-1-10" class="i">+            modifier = Modifier
</a><a href="#h7-1-11" id="h7-1-11" class="i">+                .fillMaxWidth()
</a><a href="#h7-1-12" id="h7-1-12" class="i">+                .padding(16.dp),
</a><a href="#h7-1-13" id="h7-1-13" class="i">+            horizontalAlignment = Alignment.CenterHorizontally,
</a><a href="#h7-1-14" id="h7-1-14" class="i">+            verticalArrangement = Arrangement.spacedBy(16.dp),
</a><a href="#h7-1-15" id="h7-1-15" class="i">+        ) {
</a><a href="#h7-1-16" id="h7-1-16" class="i">+            Text(text = &quot;Downgrade Notice&quot;, fontSize = 24.sp)
</a><a href="#h7-1-17" id="h7-1-17" class="i">+            Text(text = &quot;You are about to update the app. If you&#39;re installing an older version over a newer one, make sure you have CorePatch installed. Otherwise, you will need to uninstall and install.&quot;, fontSize = 12.sp)
</a><a href="#h7-1-18" id="h7-1-18" class="i">+        }
</a><a href="#h7-1-19" id="h7-1-19" class="i">+        Row(
</a><a href="#h7-1-20" id="h7-1-20" class="i">+            modifier = Modifier
</a><a href="#h7-1-21" id="h7-1-21" class="i">+                .fillMaxWidth()
</a><a href="#h7-1-22" id="h7-1-22" class="i">+                .padding(16.dp),
</a><a href="#h7-1-23" id="h7-1-23" class="i">+            horizontalArrangement = Arrangement.SpaceAround
</a><a href="#h7-1-24" id="h7-1-24" class="i">+        ) {
</a><a href="#h7-1-25" id="h7-1-25" class="i">+            Button(onClick = onDismiss) {
</a><a href="#h7-1-26" id="h7-1-26" class="i">+                Text(text = &quot;Cancel&quot;)
</a><a href="#h7-1-27" id="h7-1-27" class="i">+            }
</a><a href="#h7-1-28" id="h7-1-28" class="i">+            Button(onClick = onSuccess) {
</a><a href="#h7-1-29" id="h7-1-29" class="i">+                Text(text = &quot;Continue&quot;)
</a><a href="#h7-1-30" id="h7-1-30" class="i">+            }
</a><a href="#h7-1-31" id="h7-1-31" class="i">+        }
</a><a href="#h7-1-32" id="h7-1-32" class="i">+    }
</a> } 
\ No newline at end of file
<b>diff --git a/<a id="h8" href="../file/manager/src/main/kotlin/me/rhunk/snapenhance/manager/ui/tab/HomeTab.kt.html">manager/src/main/kotlin/me/rhunk/snapenhance/manager/ui/tab/HomeTab.kt</a> b/<a href="../file/manager/src/main/kotlin/me/rhunk/snapenhance/manager/ui/tab/HomeTab.kt.html">manager/src/main/kotlin/me/rhunk/snapenhance/manager/ui/tab/HomeTab.kt</a></b>
<a href="#h8-0" id="h8-0" class="h">@@ -15,9 +15,9 @@ import androidx.compose.material.icons.filled.Home
</a> import androidx.compose.material3.Card
 import androidx.compose.material3.Icon
 import androidx.compose.material3.MaterialTheme
<a href="#h8-0-3" id="h8-0-3" class="d">-import androidx.compose.material3.OutlinedButton
</a> import androidx.compose.material3.Text
 import androidx.compose.runtime.*
<a href="#h8-0-6" id="h8-0-6" class="i">+import androidx.compose.ui.Alignment
</a> import androidx.compose.ui.Modifier
 import androidx.compose.ui.platform.LocalContext
 import androidx.compose.ui.text.font.FontWeight
<a href="#h8-1" id="h8-1" class="h">@@ -25,7 +25,6 @@ import androidx.compose.ui.unit.dp
</a> import androidx.compose.ui.unit.sp
 import kotlinx.coroutines.Dispatchers
 import kotlinx.coroutines.launch
<a href="#h8-1-3" id="h8-1-3" class="d">-import me.rhunk.snapenhance.manager.BuildConfig
</a> import me.rhunk.snapenhance.manager.lspatch.config.Constants
 import me.rhunk.snapenhance.manager.ui.Tab
 import me.rhunk.snapenhance.manager.ui.tab.download.SEDownloadTab
<a href="#h8-2" id="h8-2" class="h">@@ -46,6 +45,7 @@ class HomeTab : Tab(&quot;home&quot;, true, icon = Icons.Default.Home) {
</a>         var snapEnhanceInfo by remember { mutableStateOf(null as PackageInfo?) }
 
         Column {
<a href="#h8-2-3" id="h8-2-3" class="i">+
</a>             Card(
                 modifier = Modifier
                     .fillMaxWidth()
<a href="#h8-3" id="h8-3" class="h">@@ -54,37 +54,33 @@ class HomeTab : Tab(&quot;home&quot;, true, icon = Icons.Default.Home) {
</a>                 Row(
                     modifier = Modifier
                         .fillMaxWidth()
<a href="#h8-3-3" id="h8-3-3" class="i">+                        .clickable {
</a><a href="#h8-3-4" id="h8-3-4" class="i">+                            navigation.navigateTo(SEDownloadTab::class)
</a><a href="#h8-3-5" id="h8-3-5" class="i">+                        }
</a>                         .padding(16.dp),
<a href="#h8-3-7" id="h8-3-7" class="d">-                    verticalAlignment = androidx.compose.ui.Alignment.CenterVertically
</a><a href="#h8-3-8" id="h8-3-8" class="i">+                    verticalAlignment = Alignment.CenterVertically
</a>                 ) {
                     Column {
<a href="#h8-3-11" id="h8-3-11" class="d">-                        Text(text = &quot;Snapchat&quot;, fontSize = 24.sp, color = MaterialTheme.colorScheme.onSurface, fontWeight = FontWeight.Bold)
</a><a href="#h8-3-12" id="h8-3-12" class="d">-                        snapchatAppInfo?.let {
</a><a href="#h8-3-13" id="h8-3-13" class="d">-                            Text(text = &quot;${it.versionName} (${it.longVersionCode})&quot;, fontSize = 12.sp, color = MaterialTheme.colorScheme.onSurfaceVariant)
</a><a href="#h8-3-14" id="h8-3-14" class="i">+                        Text(text = &quot;SnapEnhance&quot;, fontSize = 24.sp, color = MaterialTheme.colorScheme.onSurface, fontWeight = FontWeight.Bold)
</a><a href="#h8-3-15" id="h8-3-15" class="i">+                        snapEnhanceInfo?.let {
</a><a href="#h8-3-16" id="h8-3-16" class="i">+                            Text(text = &quot;${it.versionName} (${it.longVersionCode}) - ${if ((it.applicationInfo.flags and FLAG_DEBUGGABLE) != 0) &quot;Debug&quot; else &quot;Release&quot;}&quot;, fontSize = 12.sp, color = MaterialTheme.colorScheme.onSurfaceVariant)
</a>                         }
                     }
                     Row(
                         modifier = Modifier
                             .weight(1f),
                         horizontalArrangement = Arrangement.End,
<a href="#h8-3-23" id="h8-3-23" class="d">-                        verticalAlignment = androidx.compose.ui.Alignment.CenterVertically
</a><a href="#h8-3-24" id="h8-3-24" class="i">+                        verticalAlignment = Alignment.CenterVertically
</a>                     ) {
<a href="#h8-3-26" id="h8-3-26" class="d">-                        snapchatAppInfo?.let { appInfo -&gt;
</a><a href="#h8-3-27" id="h8-3-27" class="d">-                            val isLSPatched = appInfo.applicationInfo.appComponentFactory == Constants.PROXY_APP_COMPONENT_FACTORY
</a><a href="#h8-3-28" id="h8-3-28" class="d">-                            if (isLSPatched) {
</a><a href="#h8-3-29" id="h8-3-29" class="d">-                                Text(text = &quot;Patched&quot;, fontSize = 16.sp, color = MaterialTheme.colorScheme.onSurface)
</a><a href="#h8-3-30" id="h8-3-30" class="d">-                            }
</a><a href="#h8-3-31" id="h8-3-31" class="d">-                            OutlinedButton(onClick = {
</a><a href="#h8-3-32" id="h8-3-32" class="d">-                                navigation.navigateTo(SnapchatPatchTab::class)
</a><a href="#h8-3-33" id="h8-3-33" class="d">-                            }) {
</a><a href="#h8-3-34" id="h8-3-34" class="d">-                                Text(text = if (isLSPatched) &quot;Repatch&quot; else &quot;Patch&quot;)
</a><a href="#h8-3-35" id="h8-3-35" class="d">-                            }
</a><a href="#h8-3-36" id="h8-3-36" class="i">+                        snapEnhanceInfo?.let {
</a><a href="#h8-3-37" id="h8-3-37" class="i">+                            Text(text = &quot;Installed&quot;, fontSize = 16.sp, color = MaterialTheme.colorScheme.onSurface)
</a>                         } ?: run {
                             Text(text = &quot;Not installed&quot;, fontSize = 16.sp, color = MaterialTheme.colorScheme.onSurface)
                         }
<a href="#h8-3-41" id="h8-3-41" class="i">+
</a><a href="#h8-3-42" id="h8-3-42" class="i">+                        Icon(imageVector = Icons.AutoMirrored.Default.OpenInNew, contentDescription = null, Modifier.padding(10.dp))
</a>                     }
                 }
<a href="#h8-3-45" id="h8-3-45" class="d">-
</a>             }
 
             Card(
<a href="#h8-4" id="h8-4" class="h">@@ -96,25 +92,28 @@ class HomeTab : Tab(&quot;home&quot;, true, icon = Icons.Default.Home) {
</a>                     modifier = Modifier
                         .fillMaxWidth()
                         .clickable {
<a href="#h8-4-3" id="h8-4-3" class="d">-                            navigation.navigateTo(SEDownloadTab::class)
</a><a href="#h8-4-4" id="h8-4-4" class="i">+                            navigation.navigateTo(SnapchatPatchTab::class)
</a>                         }
                         .padding(16.dp),
<a href="#h8-4-7" id="h8-4-7" class="d">-                    verticalAlignment = androidx.compose.ui.Alignment.CenterVertically
</a><a href="#h8-4-8" id="h8-4-8" class="i">+                    verticalAlignment = Alignment.CenterVertically
</a>                 ) {
                     Column {
<a href="#h8-4-11" id="h8-4-11" class="d">-                        Text(text = &quot;SnapEnhance&quot;, fontSize = 24.sp, color = MaterialTheme.colorScheme.onSurface, fontWeight = FontWeight.Bold)
</a><a href="#h8-4-12" id="h8-4-12" class="d">-                        snapEnhanceInfo?.let {
</a><a href="#h8-4-13" id="h8-4-13" class="d">-                            Text(text = &quot;${it.versionName} (${it.longVersionCode}) - ${if ((it.applicationInfo.flags and FLAG_DEBUGGABLE) != 0) &quot;Debug&quot; else &quot;Release&quot;}&quot;, fontSize = 12.sp, color = MaterialTheme.colorScheme.onSurfaceVariant)
</a><a href="#h8-4-14" id="h8-4-14" class="i">+                        Text(text = &quot;Snapchat&quot;, fontSize = 24.sp, color = MaterialTheme.colorScheme.onSurface, fontWeight = FontWeight.Bold)
</a><a href="#h8-4-15" id="h8-4-15" class="i">+                        snapchatAppInfo?.let {
</a><a href="#h8-4-16" id="h8-4-16" class="i">+                            Text(text = &quot;${it.versionName} (${it.longVersionCode})&quot;, fontSize = 12.sp, color = MaterialTheme.colorScheme.onSurfaceVariant)
</a>                         }
                     }
                     Row(
                         modifier = Modifier
                             .weight(1f),
<a href="#h8-4-22" id="h8-4-22" class="d">-                        horizontalArrangement = Arrangement.End,
</a><a href="#h8-4-23" id="h8-4-23" class="d">-                        verticalAlignment = androidx.compose.ui.Alignment.CenterVertically
</a><a href="#h8-4-24" id="h8-4-24" class="i">+                        horizontalArrangement = Arrangement.spacedBy(5.dp, Alignment.End),
</a><a href="#h8-4-25" id="h8-4-25" class="i">+                        verticalAlignment = Alignment.CenterVertically
</a>                     ) {
<a href="#h8-4-27" id="h8-4-27" class="d">-                        snapEnhanceInfo?.let {
</a><a href="#h8-4-28" id="h8-4-28" class="d">-                            Text(text = &quot;Installed&quot;, fontSize = 16.sp, color = MaterialTheme.colorScheme.onSurface)
</a><a href="#h8-4-29" id="h8-4-29" class="i">+                        snapchatAppInfo?.let { appInfo -&gt;
</a><a href="#h8-4-30" id="h8-4-30" class="i">+                            val isLSPatched = appInfo.applicationInfo.appComponentFactory == Constants.PROXY_APP_COMPONENT_FACTORY
</a><a href="#h8-4-31" id="h8-4-31" class="i">+                            if (isLSPatched) {
</a><a href="#h8-4-32" id="h8-4-32" class="i">+                                Text(text = &quot;Patched&quot;, fontSize = 16.sp, color = MaterialTheme.colorScheme.onSurface)
</a><a href="#h8-4-33" id="h8-4-33" class="i">+                            }
</a>                         } ?: run {
                             Text(text = &quot;Not installed&quot;, fontSize = 16.sp, color = MaterialTheme.colorScheme.onSurface)
                         }
<a href="#h8-5" id="h8-5" class="h">@@ -122,6 +121,7 @@ class HomeTab : Tab(&quot;home&quot;, true, icon = Icons.Default.Home) {
</a>                         Icon(imageVector = Icons.AutoMirrored.Default.OpenInNew, contentDescription = null, Modifier.padding(10.dp))
                     }
                 }
<a href="#h8-5-3" id="h8-5-3" class="i">+
</a>             }
         }
 
<a href="#h8-6" id="h8-6" class="h">@@ -129,10 +129,10 @@ class HomeTab : Tab(&quot;home&quot;, true, icon = Icons.Default.Home) {
</a>             coroutineScope.launch(Dispatchers.IO) {
                 runCatching {
                     snapchatAppInfo = runCatching {
<a href="#h8-6-3" id="h8-6-3" class="d">-                        context.packageManager.getPackageInfo(sharedConfig.snapchatPackageName ?: &quot;com.snapchat.android&quot;, 0)
</a><a href="#h8-6-4" id="h8-6-4" class="i">+                        context.packageManager.getPackageInfo(sharedConfig.snapchatPackageName, 0)
</a>                     }.getOrNull()
                     snapEnhanceInfo = runCatching {
<a href="#h8-6-7" id="h8-6-7" class="d">-                        context.packageManager.getPackageInfo(sharedConfig.snapEnhancePackageName ?: BuildConfig.APPLICATION_ID, 0)
</a><a href="#h8-6-8" id="h8-6-8" class="i">+                        context.packageManager.getPackageInfo(sharedConfig.snapEnhancePackageName, 0)
</a>                     }.getOrNull()
                 }
             }
<b>diff --git a/<a id="h9" href="../file/manager/src/main/kotlin/me/rhunk/snapenhance/manager/ui/tab/download/InstallAppTab.kt.html">manager/src/main/kotlin/me/rhunk/snapenhance/manager/ui/tab/download/InstallAppTab.kt</a> b/<a href="../file/manager/src/main/kotlin/me/rhunk/snapenhance/manager/ui/tab/download/InstallAppTab.kt.html">manager/src/main/kotlin/me/rhunk/snapenhance/manager/ui/tab/download/InstallAppTab.kt</a></b>
<a href="#h9-0" id="h9-0" class="h">@@ -1,176 +0,0 @@
</a><a href="#h9-0-0" id="h9-0-0" class="d">-package me.rhunk.snapenhance.manager.ui.tab.download
</a><a href="#h9-0-1" id="h9-0-1" class="d">-
</a><a href="#h9-0-2" id="h9-0-2" class="d">-import android.content.Intent
</a><a href="#h9-0-3" id="h9-0-3" class="d">-import android.widget.Toast
</a><a href="#h9-0-4" id="h9-0-4" class="d">-import androidx.activity.ComponentActivity
</a><a href="#h9-0-5" id="h9-0-5" class="d">-import androidx.activity.result.ActivityResultLauncher
</a><a href="#h9-0-6" id="h9-0-6" class="d">-import androidx.activity.result.contract.ActivityResultContracts
</a><a href="#h9-0-7" id="h9-0-7" class="d">-import androidx.compose.foundation.layout.Arrangement
</a><a href="#h9-0-8" id="h9-0-8" class="d">-import androidx.compose.foundation.layout.Column
</a><a href="#h9-0-9" id="h9-0-9" class="d">-import androidx.compose.foundation.layout.Row
</a><a href="#h9-0-10" id="h9-0-10" class="d">-import androidx.compose.foundation.layout.fillMaxSize
</a><a href="#h9-0-11" id="h9-0-11" class="d">-import androidx.compose.foundation.layout.fillMaxWidth
</a><a href="#h9-0-12" id="h9-0-12" class="d">-import androidx.compose.material3.CircularProgressIndicator
</a><a href="#h9-0-13" id="h9-0-13" class="d">-import androidx.compose.material3.Text
</a><a href="#h9-0-14" id="h9-0-14" class="d">-import androidx.compose.runtime.*
</a><a href="#h9-0-15" id="h9-0-15" class="d">-import androidx.compose.ui.Alignment
</a><a href="#h9-0-16" id="h9-0-16" class="d">-import androidx.compose.ui.Modifier
</a><a href="#h9-0-17" id="h9-0-17" class="d">-import androidx.compose.ui.platform.LocalContext
</a><a href="#h9-0-18" id="h9-0-18" class="d">-import androidx.compose.ui.unit.dp
</a><a href="#h9-0-19" id="h9-0-19" class="d">-import androidx.core.content.FileProvider
</a><a href="#h9-0-20" id="h9-0-20" class="d">-import androidx.core.net.toUri
</a><a href="#h9-0-21" id="h9-0-21" class="d">-import kotlinx.coroutines.Dispatchers
</a><a href="#h9-0-22" id="h9-0-22" class="d">-import kotlinx.coroutines.launch
</a><a href="#h9-0-23" id="h9-0-23" class="d">-import me.rhunk.snapenhance.manager.data.download.InstallStage
</a><a href="#h9-0-24" id="h9-0-24" class="d">-import me.rhunk.snapenhance.manager.data.download.SEArtifact
</a><a href="#h9-0-25" id="h9-0-25" class="d">-import me.rhunk.snapenhance.manager.ui.Tab
</a><a href="#h9-0-26" id="h9-0-26" class="d">-import me.rhunk.snapenhance.manager.ui.tab.HomeTab
</a><a href="#h9-0-27" id="h9-0-27" class="d">-import okhttp3.OkHttpClient
</a><a href="#h9-0-28" id="h9-0-28" class="d">-import okhttp3.Request
</a><a href="#h9-0-29" id="h9-0-29" class="d">-import java.io.File
</a><a href="#h9-0-30" id="h9-0-30" class="d">-
</a><a href="#h9-0-31" id="h9-0-31" class="d">-
</a><a href="#h9-0-32" id="h9-0-32" class="d">-class InstallAppTab : Tab(&quot;install_app&quot;) {
</a><a href="#h9-0-33" id="h9-0-33" class="d">-    private lateinit var installPackageIntentLauncher: ActivityResultLauncher&lt;Intent&gt;
</a><a href="#h9-0-34" id="h9-0-34" class="d">-    private lateinit var uninstallPackageIntentLauncher: ActivityResultLauncher&lt;Intent&gt;
</a><a href="#h9-0-35" id="h9-0-35" class="d">-    private var uninstallPackageCallback: ((resultCode: Int, data: Intent?) -&gt; Unit)? = null
</a><a href="#h9-0-36" id="h9-0-36" class="d">-    private var installPackageCallback: ((resultCode: Int, data: Intent?) -&gt; Unit)? = null
</a><a href="#h9-0-37" id="h9-0-37" class="d">-
</a><a href="#h9-0-38" id="h9-0-38" class="d">-    override fun init(activity: ComponentActivity) {
</a><a href="#h9-0-39" id="h9-0-39" class="d">-        super.init(activity)
</a><a href="#h9-0-40" id="h9-0-40" class="d">-        installPackageIntentLauncher = activity.registerForActivityResult(ActivityResultContracts.StartActivityForResult()) {
</a><a href="#h9-0-41" id="h9-0-41" class="d">-            installPackageCallback?.invoke(it.resultCode, it.data)
</a><a href="#h9-0-42" id="h9-0-42" class="d">-        }
</a><a href="#h9-0-43" id="h9-0-43" class="d">-        uninstallPackageIntentLauncher = activity.registerForActivityResult(ActivityResultContracts.StartActivityForResult()) {
</a><a href="#h9-0-44" id="h9-0-44" class="d">-            uninstallPackageCallback?.invoke(it.resultCode, it.data)
</a><a href="#h9-0-45" id="h9-0-45" class="d">-        }
</a><a href="#h9-0-46" id="h9-0-46" class="d">-    }
</a><a href="#h9-0-47" id="h9-0-47" class="d">-
</a><a href="#h9-0-48" id="h9-0-48" class="d">-
</a><a href="#h9-0-49" id="h9-0-49" class="d">-    private fun downloadArtifact(artifact: SEArtifact, progress: (Int) -&gt; Unit): File? {
</a><a href="#h9-0-50" id="h9-0-50" class="d">-        val endpoint = Request.Builder().url(artifact.downloadUrl).build()
</a><a href="#h9-0-51" id="h9-0-51" class="d">-        val response = OkHttpClient().newCall(endpoint).execute()
</a><a href="#h9-0-52" id="h9-0-52" class="d">-        if (!response.isSuccessful) throw Throwable(&quot;Failed to download artifact: ${response.code}&quot;)
</a><a href="#h9-0-53" id="h9-0-53" class="d">-
</a><a href="#h9-0-54" id="h9-0-54" class="d">-        return response.body.byteStream().use { input -&gt;
</a><a href="#h9-0-55" id="h9-0-55" class="d">-            val file = activity.externalCacheDirs.first().resolve(artifact.fileName)
</a><a href="#h9-0-56" id="h9-0-56" class="d">-            runCatching {
</a><a href="#h9-0-57" id="h9-0-57" class="d">-                file.outputStream().use { output -&gt;
</a><a href="#h9-0-58" id="h9-0-58" class="d">-                    val buffer = ByteArray(4 * 1024)
</a><a href="#h9-0-59" id="h9-0-59" class="d">-                    var read: Int
</a><a href="#h9-0-60" id="h9-0-60" class="d">-                    var totalRead = 0L
</a><a href="#h9-0-61" id="h9-0-61" class="d">-                    val totalSize = response.body.contentLength()
</a><a href="#h9-0-62" id="h9-0-62" class="d">-                    while (input.read(buffer).also { read = it } != -1) {
</a><a href="#h9-0-63" id="h9-0-63" class="d">-                        output.write(buffer, 0, read)
</a><a href="#h9-0-64" id="h9-0-64" class="d">-                        totalRead += read
</a><a href="#h9-0-65" id="h9-0-65" class="d">-                        progress((totalRead * 100 / totalSize).toInt())
</a><a href="#h9-0-66" id="h9-0-66" class="d">-                    }
</a><a href="#h9-0-67" id="h9-0-67" class="d">-                }
</a><a href="#h9-0-68" id="h9-0-68" class="d">-                file
</a><a href="#h9-0-69" id="h9-0-69" class="d">-            }.getOrNull()
</a><a href="#h9-0-70" id="h9-0-70" class="d">-        }
</a><a href="#h9-0-71" id="h9-0-71" class="d">-    }
</a><a href="#h9-0-72" id="h9-0-72" class="d">-
</a><a href="#h9-0-73" id="h9-0-73" class="d">-
</a><a href="#h9-0-74" id="h9-0-74" class="d">-    @Composable
</a><a href="#h9-0-75" id="h9-0-75" class="d">-    @Suppress(&quot;DEPRECATION&quot;)
</a><a href="#h9-0-76" id="h9-0-76" class="d">-    override fun Content() {
</a><a href="#h9-0-77" id="h9-0-77" class="d">-        val coroutineScope = rememberCoroutineScope()
</a><a href="#h9-0-78" id="h9-0-78" class="d">-        val context = LocalContext.current
</a><a href="#h9-0-79" id="h9-0-79" class="d">-        var installStage by remember { mutableStateOf(InstallStage.DOWNLOADING) }
</a><a href="#h9-0-80" id="h9-0-80" class="d">-        var downloadProgress by remember { mutableIntStateOf(0) }
</a><a href="#h9-0-81" id="h9-0-81" class="d">-        var downloadedFile by remember { mutableStateOf&lt;File?&gt;(null) }
</a><a href="#h9-0-82" id="h9-0-82" class="d">-
</a><a href="#h9-0-83" id="h9-0-83" class="d">-        LaunchedEffect(Unit) {
</a><a href="#h9-0-84" id="h9-0-84" class="d">-            uninstallPackageCallback = null
</a><a href="#h9-0-85" id="h9-0-85" class="d">-            installPackageCallback = null
</a><a href="#h9-0-86" id="h9-0-86" class="d">-        }
</a><a href="#h9-0-87" id="h9-0-87" class="d">-
</a><a href="#h9-0-88" id="h9-0-88" class="d">-        val artifact = getArguments()?.getParcelable&lt;SEArtifact&gt;(&quot;artifact&quot;) ?: return
</a><a href="#h9-0-89" id="h9-0-89" class="d">-        val appPackage = getArguments()?.getString(&quot;appPackage&quot;) ?: return
</a><a href="#h9-0-90" id="h9-0-90" class="d">-        val shouldUninstall = getArguments()?.getBoolean(&quot;uninstall&quot;) ?: false
</a><a href="#h9-0-91" id="h9-0-91" class="d">-
</a><a href="#h9-0-92" id="h9-0-92" class="d">-        Column(
</a><a href="#h9-0-93" id="h9-0-93" class="d">-            modifier = Modifier.fillMaxSize(),
</a><a href="#h9-0-94" id="h9-0-94" class="d">-            horizontalAlignment = Alignment.CenterHorizontally,
</a><a href="#h9-0-95" id="h9-0-95" class="d">-            verticalArrangement = Arrangement.spacedBy(16.dp, Alignment.CenterVertically)
</a><a href="#h9-0-96" id="h9-0-96" class="d">-        ) {
</a><a href="#h9-0-97" id="h9-0-97" class="d">-            Row(
</a><a href="#h9-0-98" id="h9-0-98" class="d">-                modifier = Modifier.fillMaxWidth(),
</a><a href="#h9-0-99" id="h9-0-99" class="d">-                horizontalArrangement = Arrangement.Center
</a><a href="#h9-0-100" id="h9-0-100" class="d">-            ) {
</a><a href="#h9-0-101" id="h9-0-101" class="d">-                if (installStage != InstallStage.DONE &amp;&amp; installStage != InstallStage.ERROR) {
</a><a href="#h9-0-102" id="h9-0-102" class="d">-                    CircularProgressIndicator()
</a><a href="#h9-0-103" id="h9-0-103" class="d">-                }
</a><a href="#h9-0-104" id="h9-0-104" class="d">-            }
</a><a href="#h9-0-105" id="h9-0-105" class="d">-
</a><a href="#h9-0-106" id="h9-0-106" class="d">-            when (installStage) {
</a><a href="#h9-0-107" id="h9-0-107" class="d">-                InstallStage.DOWNLOADING -&gt; {
</a><a href="#h9-0-108" id="h9-0-108" class="d">-                    Text(text = &quot;Downloading ${artifact.fileName}... ($downloadProgress%)&quot;)
</a><a href="#h9-0-109" id="h9-0-109" class="d">-                }
</a><a href="#h9-0-110" id="h9-0-110" class="d">-                InstallStage.UNINSTALLING -&gt; {
</a><a href="#h9-0-111" id="h9-0-111" class="d">-                    Text(text = &quot;Uninstalling app $appPackage...&quot;)
</a><a href="#h9-0-112" id="h9-0-112" class="d">-                }
</a><a href="#h9-0-113" id="h9-0-113" class="d">-                InstallStage.INSTALLING -&gt; {
</a><a href="#h9-0-114" id="h9-0-114" class="d">-                    Text(text = &quot;Installing ${artifact.fileName}...&quot;)
</a><a href="#h9-0-115" id="h9-0-115" class="d">-                }
</a><a href="#h9-0-116" id="h9-0-116" class="d">-                InstallStage.DONE -&gt; {
</a><a href="#h9-0-117" id="h9-0-117" class="d">-                    LaunchedEffect(Unit) {
</a><a href="#h9-0-118" id="h9-0-118" class="d">-                        navigation.navigateTo(HomeTab::class, noHistory = true)
</a><a href="#h9-0-119" id="h9-0-119" class="d">-                        Toast.makeText(context, &quot;${artifact.fileName} installed successfully!&quot;, Toast.LENGTH_SHORT).show()
</a><a href="#h9-0-120" id="h9-0-120" class="d">-                    }
</a><a href="#h9-0-121" id="h9-0-121" class="d">-                }
</a><a href="#h9-0-122" id="h9-0-122" class="d">-                InstallStage.ERROR -&gt; Text(text = &quot;Failed to install ${artifact.fileName}. Check logcat for more details.&quot;)
</a><a href="#h9-0-123" id="h9-0-123" class="d">-            }
</a><a href="#h9-0-124" id="h9-0-124" class="d">-        }
</a><a href="#h9-0-125" id="h9-0-125" class="d">-
</a><a href="#h9-0-126" id="h9-0-126" class="d">-        fun installPackage() {
</a><a href="#h9-0-127" id="h9-0-127" class="d">-            installStage = InstallStage.INSTALLING
</a><a href="#h9-0-128" id="h9-0-128" class="d">-            installPackageCallback = resultCallbacks@{ code, _ -&gt;
</a><a href="#h9-0-129" id="h9-0-129" class="d">-                installStage = if (code != ComponentActivity.RESULT_OK) {
</a><a href="#h9-0-130" id="h9-0-130" class="d">-                    InstallStage.ERROR
</a><a href="#h9-0-131" id="h9-0-131" class="d">-                } else {
</a><a href="#h9-0-132" id="h9-0-132" class="d">-                    InstallStage.DONE
</a><a href="#h9-0-133" id="h9-0-133" class="d">-                }
</a><a href="#h9-0-134" id="h9-0-134" class="d">-                downloadedFile?.delete()
</a><a href="#h9-0-135" id="h9-0-135" class="d">-            }
</a><a href="#h9-0-136" id="h9-0-136" class="d">-
</a><a href="#h9-0-137" id="h9-0-137" class="d">-            installPackageIntentLauncher.launch(Intent(Intent.ACTION_INSTALL_PACKAGE).apply {
</a><a href="#h9-0-138" id="h9-0-138" class="d">-                println(context)
</a><a href="#h9-0-139" id="h9-0-139" class="d">-                data = FileProvider.getUriForFile(context, &quot;me.rhunk.snapenhance.manager.provider&quot;, downloadedFile!!)
</a><a href="#h9-0-140" id="h9-0-140" class="d">-                setFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION)
</a><a href="#h9-0-141" id="h9-0-141" class="d">-                putExtra(Intent.EXTRA_RETURN_RESULT, true)
</a><a href="#h9-0-142" id="h9-0-142" class="d">-            })
</a><a href="#h9-0-143" id="h9-0-143" class="d">-        }
</a><a href="#h9-0-144" id="h9-0-144" class="d">-
</a><a href="#h9-0-145" id="h9-0-145" class="d">-
</a><a href="#h9-0-146" id="h9-0-146" class="d">-        LaunchedEffect(Unit) {
</a><a href="#h9-0-147" id="h9-0-147" class="d">-            coroutineScope.launch(Dispatchers.IO) {
</a><a href="#h9-0-148" id="h9-0-148" class="d">-                downloadedFile = downloadArtifact(artifact) {
</a><a href="#h9-0-149" id="h9-0-149" class="d">-                    downloadProgress = it
</a><a href="#h9-0-150" id="h9-0-150" class="d">-                } ?: run {
</a><a href="#h9-0-151" id="h9-0-151" class="d">-                    installStage = InstallStage.ERROR
</a><a href="#h9-0-152" id="h9-0-152" class="d">-                    return@launch
</a><a href="#h9-0-153" id="h9-0-153" class="d">-                }
</a><a href="#h9-0-154" id="h9-0-154" class="d">-                if (shouldUninstall) {
</a><a href="#h9-0-155" id="h9-0-155" class="d">-                    installStage = InstallStage.UNINSTALLING
</a><a href="#h9-0-156" id="h9-0-156" class="d">-                    val intent = Intent(Intent.ACTION_UNINSTALL_PACKAGE).apply {
</a><a href="#h9-0-157" id="h9-0-157" class="d">-                        data = &quot;package:$appPackage&quot;.toUri()
</a><a href="#h9-0-158" id="h9-0-158" class="d">-                        putExtra(Intent.EXTRA_RETURN_RESULT, true)
</a><a href="#h9-0-159" id="h9-0-159" class="d">-                    }
</a><a href="#h9-0-160" id="h9-0-160" class="d">-                    uninstallPackageCallback = resultCallback@{ resultCode, _ -&gt;
</a><a href="#h9-0-161" id="h9-0-161" class="d">-                        if (resultCode != ComponentActivity.RESULT_OK) {
</a><a href="#h9-0-162" id="h9-0-162" class="d">-                            installStage = InstallStage.ERROR
</a><a href="#h9-0-163" id="h9-0-163" class="d">-                            downloadedFile?.delete()
</a><a href="#h9-0-164" id="h9-0-164" class="d">-                            return@resultCallback
</a><a href="#h9-0-165" id="h9-0-165" class="d">-                        }
</a><a href="#h9-0-166" id="h9-0-166" class="d">-                        installPackage()
</a><a href="#h9-0-167" id="h9-0-167" class="d">-                    }
</a><a href="#h9-0-168" id="h9-0-168" class="d">-                    uninstallPackageIntentLauncher.launch(intent)
</a><a href="#h9-0-169" id="h9-0-169" class="d">-                } else {
</a><a href="#h9-0-170" id="h9-0-170" class="d">-                    installPackage()
</a><a href="#h9-0-171" id="h9-0-171" class="d">-                }
</a><a href="#h9-0-172" id="h9-0-172" class="d">-            }
</a><a href="#h9-0-173" id="h9-0-173" class="d">-        }
</a><a href="#h9-0-174" id="h9-0-174" class="d">-    }
</a><a href="#h9-0-175" id="h9-0-175" class="d">-}
</a><b>diff --git a/<a id="h10" href="../file/manager/src/main/kotlin/me/rhunk/snapenhance/manager/ui/tab/download/InstallPackageTab.kt.html">manager/src/main/kotlin/me/rhunk/snapenhance/manager/ui/tab/download/InstallPackageTab.kt</a> b/<a href="../file/manager/src/main/kotlin/me/rhunk/snapenhance/manager/ui/tab/download/InstallPackageTab.kt.html">manager/src/main/kotlin/me/rhunk/snapenhance/manager/ui/tab/download/InstallPackageTab.kt</a></b>
<a href="#h10-0" id="h10-0" class="h">@@ -0,0 +1,190 @@
</a><a href="#h10-0-0" id="h10-0-0" class="i">+package me.rhunk.snapenhance.manager.ui.tab.download
</a><a href="#h10-0-1" id="h10-0-1" class="i">+
</a><a href="#h10-0-2" id="h10-0-2" class="i">+import android.content.Intent
</a><a href="#h10-0-3" id="h10-0-3" class="i">+import android.net.Uri
</a><a href="#h10-0-4" id="h10-0-4" class="i">+import android.widget.Toast
</a><a href="#h10-0-5" id="h10-0-5" class="i">+import androidx.activity.ComponentActivity
</a><a href="#h10-0-6" id="h10-0-6" class="i">+import androidx.activity.result.ActivityResultLauncher
</a><a href="#h10-0-7" id="h10-0-7" class="i">+import androidx.activity.result.contract.ActivityResultContracts
</a><a href="#h10-0-8" id="h10-0-8" class="i">+import androidx.compose.foundation.layout.*
</a><a href="#h10-0-9" id="h10-0-9" class="i">+import androidx.compose.material3.CircularProgressIndicator
</a><a href="#h10-0-10" id="h10-0-10" class="i">+import androidx.compose.material3.LinearProgressIndicator
</a><a href="#h10-0-11" id="h10-0-11" class="i">+import androidx.compose.material3.Text
</a><a href="#h10-0-12" id="h10-0-12" class="i">+import androidx.compose.runtime.*
</a><a href="#h10-0-13" id="h10-0-13" class="i">+import androidx.compose.ui.Alignment
</a><a href="#h10-0-14" id="h10-0-14" class="i">+import androidx.compose.ui.Modifier
</a><a href="#h10-0-15" id="h10-0-15" class="i">+import androidx.compose.ui.graphics.StrokeCap
</a><a href="#h10-0-16" id="h10-0-16" class="i">+import androidx.compose.ui.platform.LocalContext
</a><a href="#h10-0-17" id="h10-0-17" class="i">+import androidx.compose.ui.unit.dp
</a><a href="#h10-0-18" id="h10-0-18" class="i">+import androidx.core.content.FileProvider
</a><a href="#h10-0-19" id="h10-0-19" class="i">+import androidx.core.net.toUri
</a><a href="#h10-0-20" id="h10-0-20" class="i">+import kotlinx.coroutines.Dispatchers
</a><a href="#h10-0-21" id="h10-0-21" class="i">+import kotlinx.coroutines.launch
</a><a href="#h10-0-22" id="h10-0-22" class="i">+import me.rhunk.snapenhance.manager.data.download.InstallStage
</a><a href="#h10-0-23" id="h10-0-23" class="i">+import me.rhunk.snapenhance.manager.ui.Tab
</a><a href="#h10-0-24" id="h10-0-24" class="i">+import me.rhunk.snapenhance.manager.ui.tab.HomeTab
</a><a href="#h10-0-25" id="h10-0-25" class="i">+import okhttp3.OkHttpClient
</a><a href="#h10-0-26" id="h10-0-26" class="i">+import okhttp3.Request
</a><a href="#h10-0-27" id="h10-0-27" class="i">+import java.io.File
</a><a href="#h10-0-28" id="h10-0-28" class="i">+
</a><a href="#h10-0-29" id="h10-0-29" class="i">+
</a><a href="#h10-0-30" id="h10-0-30" class="i">+class InstallPackageTab : Tab(&quot;install_app&quot;) {
</a><a href="#h10-0-31" id="h10-0-31" class="i">+    private lateinit var installPackageIntentLauncher: ActivityResultLauncher&lt;Intent&gt;
</a><a href="#h10-0-32" id="h10-0-32" class="i">+    private lateinit var uninstallPackageIntentLauncher: ActivityResultLauncher&lt;Intent&gt;
</a><a href="#h10-0-33" id="h10-0-33" class="i">+    private var uninstallPackageCallback: ((resultCode: Int, data: Intent?) -&gt; Unit)? = null
</a><a href="#h10-0-34" id="h10-0-34" class="i">+    private var installPackageCallback: ((resultCode: Int, data: Intent?) -&gt; Unit)? = null
</a><a href="#h10-0-35" id="h10-0-35" class="i">+
</a><a href="#h10-0-36" id="h10-0-36" class="i">+    override fun init(activity: ComponentActivity) {
</a><a href="#h10-0-37" id="h10-0-37" class="i">+        super.init(activity)
</a><a href="#h10-0-38" id="h10-0-38" class="i">+        installPackageIntentLauncher = activity.registerForActivityResult(ActivityResultContracts.StartActivityForResult()) {
</a><a href="#h10-0-39" id="h10-0-39" class="i">+            installPackageCallback?.invoke(it.resultCode, it.data)
</a><a href="#h10-0-40" id="h10-0-40" class="i">+        }
</a><a href="#h10-0-41" id="h10-0-41" class="i">+        uninstallPackageIntentLauncher = activity.registerForActivityResult(ActivityResultContracts.StartActivityForResult()) {
</a><a href="#h10-0-42" id="h10-0-42" class="i">+            uninstallPackageCallback?.invoke(it.resultCode, it.data)
</a><a href="#h10-0-43" id="h10-0-43" class="i">+        }
</a><a href="#h10-0-44" id="h10-0-44" class="i">+    }
</a><a href="#h10-0-45" id="h10-0-45" class="i">+
</a><a href="#h10-0-46" id="h10-0-46" class="i">+    private fun downloadArtifact(url: String, progress: (Float) -&gt; Unit): File? {
</a><a href="#h10-0-47" id="h10-0-47" class="i">+        val urlScheme = Uri.parse(url).scheme
</a><a href="#h10-0-48" id="h10-0-48" class="i">+        if (urlScheme != &quot;https&quot; &amp;&amp; urlScheme != &quot;http&quot;) {
</a><a href="#h10-0-49" id="h10-0-49" class="i">+            val file = File(url)
</a><a href="#h10-0-50" id="h10-0-50" class="i">+            val dest = File(activity.externalCacheDirs.first(), file.name).also {
</a><a href="#h10-0-51" id="h10-0-51" class="i">+                it.deleteOnExit()
</a><a href="#h10-0-52" id="h10-0-52" class="i">+            }
</a><a href="#h10-0-53" id="h10-0-53" class="i">+            if (dest.exists()) return file
</a><a href="#h10-0-54" id="h10-0-54" class="i">+            file.copyTo(dest)
</a><a href="#h10-0-55" id="h10-0-55" class="i">+            return dest
</a><a href="#h10-0-56" id="h10-0-56" class="i">+        }
</a><a href="#h10-0-57" id="h10-0-57" class="i">+
</a><a href="#h10-0-58" id="h10-0-58" class="i">+        val endpoint = Request.Builder().url(url).build()
</a><a href="#h10-0-59" id="h10-0-59" class="i">+        val response = OkHttpClient().newCall(endpoint).execute()
</a><a href="#h10-0-60" id="h10-0-60" class="i">+        if (!response.isSuccessful) throw Throwable(&quot;Failed to download artifact: ${response.code}&quot;)
</a><a href="#h10-0-61" id="h10-0-61" class="i">+
</a><a href="#h10-0-62" id="h10-0-62" class="i">+        return response.body.byteStream().use { input -&gt;
</a><a href="#h10-0-63" id="h10-0-63" class="i">+            val file = File.createTempFile(&quot;artifact&quot;, &quot;.apk&quot;, activity.externalCacheDirs.first()).also {
</a><a href="#h10-0-64" id="h10-0-64" class="i">+                it.deleteOnExit()
</a><a href="#h10-0-65" id="h10-0-65" class="i">+            }
</a><a href="#h10-0-66" id="h10-0-66" class="i">+            runCatching {
</a><a href="#h10-0-67" id="h10-0-67" class="i">+                file.outputStream().use { output -&gt;
</a><a href="#h10-0-68" id="h10-0-68" class="i">+                    val buffer = ByteArray(4 * 1024)
</a><a href="#h10-0-69" id="h10-0-69" class="i">+                    var read: Int
</a><a href="#h10-0-70" id="h10-0-70" class="i">+                    var totalRead = 0L
</a><a href="#h10-0-71" id="h10-0-71" class="i">+                    val totalSize = response.body.contentLength()
</a><a href="#h10-0-72" id="h10-0-72" class="i">+                    while (input.read(buffer).also { read = it } != -1) {
</a><a href="#h10-0-73" id="h10-0-73" class="i">+                        output.write(buffer, 0, read)
</a><a href="#h10-0-74" id="h10-0-74" class="i">+                        totalRead += read
</a><a href="#h10-0-75" id="h10-0-75" class="i">+                        progress(totalRead.toFloat() / totalSize.toFloat())
</a><a href="#h10-0-76" id="h10-0-76" class="i">+                    }
</a><a href="#h10-0-77" id="h10-0-77" class="i">+                }
</a><a href="#h10-0-78" id="h10-0-78" class="i">+                file
</a><a href="#h10-0-79" id="h10-0-79" class="i">+            }.getOrNull()
</a><a href="#h10-0-80" id="h10-0-80" class="i">+        }
</a><a href="#h10-0-81" id="h10-0-81" class="i">+    }
</a><a href="#h10-0-82" id="h10-0-82" class="i">+
</a><a href="#h10-0-83" id="h10-0-83" class="i">+
</a><a href="#h10-0-84" id="h10-0-84" class="i">+    @Composable
</a><a href="#h10-0-85" id="h10-0-85" class="i">+    @Suppress(&quot;DEPRECATION&quot;)
</a><a href="#h10-0-86" id="h10-0-86" class="i">+    override fun Content() {
</a><a href="#h10-0-87" id="h10-0-87" class="i">+        val coroutineScope = rememberCoroutineScope()
</a><a href="#h10-0-88" id="h10-0-88" class="i">+        val context = LocalContext.current
</a><a href="#h10-0-89" id="h10-0-89" class="i">+        var installStage by remember { mutableStateOf(InstallStage.DOWNLOADING) }
</a><a href="#h10-0-90" id="h10-0-90" class="i">+        var downloadProgress by remember { mutableFloatStateOf(-1f) }
</a><a href="#h10-0-91" id="h10-0-91" class="i">+        var downloadedFile by remember { mutableStateOf&lt;File?&gt;(null) }
</a><a href="#h10-0-92" id="h10-0-92" class="i">+
</a><a href="#h10-0-93" id="h10-0-93" class="i">+        LaunchedEffect(Unit) {
</a><a href="#h10-0-94" id="h10-0-94" class="i">+            uninstallPackageCallback = null
</a><a href="#h10-0-95" id="h10-0-95" class="i">+            installPackageCallback = null
</a><a href="#h10-0-96" id="h10-0-96" class="i">+        }
</a><a href="#h10-0-97" id="h10-0-97" class="i">+
</a><a href="#h10-0-98" id="h10-0-98" class="i">+        val downloadPath = getArguments()?.getString(&quot;downloadPath&quot;) ?: return
</a><a href="#h10-0-99" id="h10-0-99" class="i">+        val appPackage = getArguments()?.getString(&quot;appPackage&quot;) ?: return
</a><a href="#h10-0-100" id="h10-0-100" class="i">+        val shouldUninstall = getArguments()?.getBoolean(&quot;uninstall&quot;) ?: false
</a><a href="#h10-0-101" id="h10-0-101" class="i">+
</a><a href="#h10-0-102" id="h10-0-102" class="i">+        Column(
</a><a href="#h10-0-103" id="h10-0-103" class="i">+            modifier = Modifier.fillMaxSize().padding(16.dp),
</a><a href="#h10-0-104" id="h10-0-104" class="i">+            horizontalAlignment = Alignment.CenterHorizontally,
</a><a href="#h10-0-105" id="h10-0-105" class="i">+            verticalArrangement = Arrangement.spacedBy(16.dp, Alignment.CenterVertically)
</a><a href="#h10-0-106" id="h10-0-106" class="i">+        ) {
</a><a href="#h10-0-107" id="h10-0-107" class="i">+            Row(
</a><a href="#h10-0-108" id="h10-0-108" class="i">+                modifier = Modifier.fillMaxWidth(),
</a><a href="#h10-0-109" id="h10-0-109" class="i">+                horizontalArrangement = Arrangement.Center
</a><a href="#h10-0-110" id="h10-0-110" class="i">+            ) {
</a><a href="#h10-0-111" id="h10-0-111" class="i">+                if (installStage != InstallStage.DONE &amp;&amp; installStage != InstallStage.ERROR) {
</a><a href="#h10-0-112" id="h10-0-112" class="i">+                    CircularProgressIndicator()
</a><a href="#h10-0-113" id="h10-0-113" class="i">+                }
</a><a href="#h10-0-114" id="h10-0-114" class="i">+            }
</a><a href="#h10-0-115" id="h10-0-115" class="i">+
</a><a href="#h10-0-116" id="h10-0-116" class="i">+            when (installStage) {
</a><a href="#h10-0-117" id="h10-0-117" class="i">+                InstallStage.DOWNLOADING -&gt; {
</a><a href="#h10-0-118" id="h10-0-118" class="i">+                    Text(text = &quot;Downloading ...&quot;)
</a><a href="#h10-0-119" id="h10-0-119" class="i">+                    LinearProgressIndicator(progress = downloadProgress, Modifier.fillMaxWidth().height(4.dp), strokeCap = StrokeCap.Round)
</a><a href="#h10-0-120" id="h10-0-120" class="i">+                }
</a><a href="#h10-0-121" id="h10-0-121" class="i">+                InstallStage.UNINSTALLING -&gt; {
</a><a href="#h10-0-122" id="h10-0-122" class="i">+                    Text(text = &quot;Uninstalling app $appPackage...&quot;)
</a><a href="#h10-0-123" id="h10-0-123" class="i">+                }
</a><a href="#h10-0-124" id="h10-0-124" class="i">+                InstallStage.INSTALLING -&gt; {
</a><a href="#h10-0-125" id="h10-0-125" class="i">+                    Text(text = &quot;Installing ...&quot;)
</a><a href="#h10-0-126" id="h10-0-126" class="i">+                }
</a><a href="#h10-0-127" id="h10-0-127" class="i">+                InstallStage.DONE -&gt; {
</a><a href="#h10-0-128" id="h10-0-128" class="i">+                    LaunchedEffect(Unit) {
</a><a href="#h10-0-129" id="h10-0-129" class="i">+                        navigation.navigateTo(HomeTab::class, noHistory = true)
</a><a href="#h10-0-130" id="h10-0-130" class="i">+                        Toast.makeText(context, &quot;Successfully installed $appPackage!&quot;, Toast.LENGTH_SHORT).show()
</a><a href="#h10-0-131" id="h10-0-131" class="i">+                    }
</a><a href="#h10-0-132" id="h10-0-132" class="i">+                }
</a><a href="#h10-0-133" id="h10-0-133" class="i">+                InstallStage.ERROR -&gt; Text(text = &quot;Failed to install $appPackage. Check logcat for more details.&quot;)
</a><a href="#h10-0-134" id="h10-0-134" class="i">+            }
</a><a href="#h10-0-135" id="h10-0-135" class="i">+        }
</a><a href="#h10-0-136" id="h10-0-136" class="i">+
</a><a href="#h10-0-137" id="h10-0-137" class="i">+        fun installPackage() {
</a><a href="#h10-0-138" id="h10-0-138" class="i">+            installStage = InstallStage.INSTALLING
</a><a href="#h10-0-139" id="h10-0-139" class="i">+            installPackageCallback = resultCallbacks@{ code, _ -&gt;
</a><a href="#h10-0-140" id="h10-0-140" class="i">+                installStage = if (code != ComponentActivity.RESULT_OK) {
</a><a href="#h10-0-141" id="h10-0-141" class="i">+                    InstallStage.ERROR
</a><a href="#h10-0-142" id="h10-0-142" class="i">+                } else {
</a><a href="#h10-0-143" id="h10-0-143" class="i">+                    InstallStage.DONE
</a><a href="#h10-0-144" id="h10-0-144" class="i">+                }
</a><a href="#h10-0-145" id="h10-0-145" class="i">+                downloadedFile?.delete()
</a><a href="#h10-0-146" id="h10-0-146" class="i">+            }
</a><a href="#h10-0-147" id="h10-0-147" class="i">+
</a><a href="#h10-0-148" id="h10-0-148" class="i">+            installPackageIntentLauncher.launch(Intent(Intent.ACTION_INSTALL_PACKAGE).apply {
</a><a href="#h10-0-149" id="h10-0-149" class="i">+                data = FileProvider.getUriForFile(context, &quot;me.rhunk.snapenhance.manager.provider&quot;, downloadedFile!!)
</a><a href="#h10-0-150" id="h10-0-150" class="i">+                setFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION)
</a><a href="#h10-0-151" id="h10-0-151" class="i">+                putExtra(Intent.EXTRA_RETURN_RESULT, true)
</a><a href="#h10-0-152" id="h10-0-152" class="i">+            })
</a><a href="#h10-0-153" id="h10-0-153" class="i">+        }
</a><a href="#h10-0-154" id="h10-0-154" class="i">+
</a><a href="#h10-0-155" id="h10-0-155" class="i">+
</a><a href="#h10-0-156" id="h10-0-156" class="i">+        LaunchedEffect(Unit) {
</a><a href="#h10-0-157" id="h10-0-157" class="i">+            coroutineScope.launch(Dispatchers.IO) {
</a><a href="#h10-0-158" id="h10-0-158" class="i">+                runCatching {
</a><a href="#h10-0-159" id="h10-0-159" class="i">+                    downloadedFile = downloadArtifact(downloadPath) { downloadProgress = it } ?: run {
</a><a href="#h10-0-160" id="h10-0-160" class="i">+                        installStage = InstallStage.ERROR
</a><a href="#h10-0-161" id="h10-0-161" class="i">+                        return@launch
</a><a href="#h10-0-162" id="h10-0-162" class="i">+                    }
</a><a href="#h10-0-163" id="h10-0-163" class="i">+                    if (shouldUninstall) {
</a><a href="#h10-0-164" id="h10-0-164" class="i">+                        installStage = InstallStage.UNINSTALLING
</a><a href="#h10-0-165" id="h10-0-165" class="i">+                        val intent = Intent(Intent.ACTION_UNINSTALL_PACKAGE).apply {
</a><a href="#h10-0-166" id="h10-0-166" class="i">+                            data = &quot;package:$appPackage&quot;.toUri()
</a><a href="#h10-0-167" id="h10-0-167" class="i">+                            putExtra(Intent.EXTRA_RETURN_RESULT, true)
</a><a href="#h10-0-168" id="h10-0-168" class="i">+                        }
</a><a href="#h10-0-169" id="h10-0-169" class="i">+                        uninstallPackageCallback = resultCallback@{ resultCode, _ -&gt;
</a><a href="#h10-0-170" id="h10-0-170" class="i">+                            if (resultCode != ComponentActivity.RESULT_OK) {
</a><a href="#h10-0-171" id="h10-0-171" class="i">+                                installStage = InstallStage.ERROR
</a><a href="#h10-0-172" id="h10-0-172" class="i">+                                downloadedFile?.delete()
</a><a href="#h10-0-173" id="h10-0-173" class="i">+                                return@resultCallback
</a><a href="#h10-0-174" id="h10-0-174" class="i">+                            }
</a><a href="#h10-0-175" id="h10-0-175" class="i">+                            installPackage()
</a><a href="#h10-0-176" id="h10-0-176" class="i">+                        }
</a><a href="#h10-0-177" id="h10-0-177" class="i">+                        uninstallPackageIntentLauncher.launch(intent)
</a><a href="#h10-0-178" id="h10-0-178" class="i">+                    } else {
</a><a href="#h10-0-179" id="h10-0-179" class="i">+                        installPackage()
</a><a href="#h10-0-180" id="h10-0-180" class="i">+                    }
</a><a href="#h10-0-181" id="h10-0-181" class="i">+                }.onFailure {
</a><a href="#h10-0-182" id="h10-0-182" class="i">+                    it.printStackTrace()
</a><a href="#h10-0-183" id="h10-0-183" class="i">+                    installStage = InstallStage.ERROR
</a><a href="#h10-0-184" id="h10-0-184" class="i">+                    downloadedFile?.delete()
</a><a href="#h10-0-185" id="h10-0-185" class="i">+                }
</a><a href="#h10-0-186" id="h10-0-186" class="i">+            }
</a><a href="#h10-0-187" id="h10-0-187" class="i">+        }
</a><a href="#h10-0-188" id="h10-0-188" class="i">+    }
</a><a href="#h10-0-189" id="h10-0-189" class="i">+}
</a><b>diff --git a/<a id="h11" href="../file/manager/src/main/kotlin/me/rhunk/snapenhance/manager/ui/tab/download/LSPatchTab.kt.html">manager/src/main/kotlin/me/rhunk/snapenhance/manager/ui/tab/download/LSPatchTab.kt</a> b/<a href="../file/manager/src/main/kotlin/me/rhunk/snapenhance/manager/ui/tab/download/LSPatchTab.kt.html">manager/src/main/kotlin/me/rhunk/snapenhance/manager/ui/tab/download/LSPatchTab.kt</a></b>
<a href="#h11-0" id="h11-0" class="h">@@ -0,0 +1,197 @@
</a><a href="#h11-0-0" id="h11-0-0" class="i">+package me.rhunk.snapenhance.manager.ui.tab.download
</a><a href="#h11-0-1" id="h11-0-1" class="i">+
</a><a href="#h11-0-2" id="h11-0-2" class="i">+import android.os.Bundle
</a><a href="#h11-0-3" id="h11-0-3" class="i">+import androidx.compose.foundation.layout.*
</a><a href="#h11-0-4" id="h11-0-4" class="i">+import androidx.compose.foundation.rememberScrollState
</a><a href="#h11-0-5" id="h11-0-5" class="i">+import androidx.compose.foundation.verticalScroll
</a><a href="#h11-0-6" id="h11-0-6" class="i">+import androidx.compose.material3.Button
</a><a href="#h11-0-7" id="h11-0-7" class="i">+import androidx.compose.material3.Card
</a><a href="#h11-0-8" id="h11-0-8" class="i">+import androidx.compose.material3.LinearProgressIndicator
</a><a href="#h11-0-9" id="h11-0-9" class="i">+import androidx.compose.material3.Text
</a><a href="#h11-0-10" id="h11-0-10" class="i">+import androidx.compose.runtime.*
</a><a href="#h11-0-11" id="h11-0-11" class="i">+import androidx.compose.ui.Alignment
</a><a href="#h11-0-12" id="h11-0-12" class="i">+import androidx.compose.ui.Modifier
</a><a href="#h11-0-13" id="h11-0-13" class="i">+import androidx.compose.ui.graphics.StrokeCap
</a><a href="#h11-0-14" id="h11-0-14" class="i">+import androidx.compose.ui.text.style.TextOverflow
</a><a href="#h11-0-15" id="h11-0-15" class="i">+import androidx.compose.ui.unit.dp
</a><a href="#h11-0-16" id="h11-0-16" class="i">+import androidx.compose.ui.window.Dialog
</a><a href="#h11-0-17" id="h11-0-17" class="i">+import kotlinx.coroutines.Dispatchers
</a><a href="#h11-0-18" id="h11-0-18" class="i">+import kotlinx.coroutines.launch
</a><a href="#h11-0-19" id="h11-0-19" class="i">+import me.rhunk.snapenhance.manager.data.APKMirror
</a><a href="#h11-0-20" id="h11-0-20" class="i">+import me.rhunk.snapenhance.manager.data.DownloadItem
</a><a href="#h11-0-21" id="h11-0-21" class="i">+import me.rhunk.snapenhance.manager.lspatch.LSPatch
</a><a href="#h11-0-22" id="h11-0-22" class="i">+import me.rhunk.snapenhance.manager.ui.Tab
</a><a href="#h11-0-23" id="h11-0-23" class="i">+import me.rhunk.snapenhance.manager.ui.components.DowngradeNoticeDialog
</a><a href="#h11-0-24" id="h11-0-24" class="i">+import okio.use
</a><a href="#h11-0-25" id="h11-0-25" class="i">+import java.io.File
</a><a href="#h11-0-26" id="h11-0-26" class="i">+
</a><a href="#h11-0-27" id="h11-0-27" class="i">+class LSPatchTab : Tab(&quot;lspatch&quot;) {
</a><a href="#h11-0-28" id="h11-0-28" class="i">+    private lateinit var downloadItem: DownloadItem
</a><a href="#h11-0-29" id="h11-0-29" class="i">+    private var snapEnhanceModule: File? = null
</a><a href="#h11-0-30" id="h11-0-30" class="i">+    private var patchedApk by mutableStateOf&lt;File?&gt;(null)
</a><a href="#h11-0-31" id="h11-0-31" class="i">+    private val apkMirror = APKMirror()
</a><a href="#h11-0-32" id="h11-0-32" class="i">+
</a><a href="#h11-0-33" id="h11-0-33" class="i">+    private fun patch(log: (Any?) -&gt; Unit, onProgress: (Float) -&gt; Unit) {
</a><a href="#h11-0-34" id="h11-0-34" class="i">+        log(&quot;Fetching download link for ${downloadItem.title}...&quot;)
</a><a href="#h11-0-35" id="h11-0-35" class="i">+        val downloadLink = apkMirror.fetchDownloadLink(downloadItem.downloadPage) ?: run {
</a><a href="#h11-0-36" id="h11-0-36" class="i">+            log(&quot;== Failed to fetch download link ==&quot;)
</a><a href="#h11-0-37" id="h11-0-37" class="i">+            return
</a><a href="#h11-0-38" id="h11-0-38" class="i">+        }
</a><a href="#h11-0-39" id="h11-0-39" class="i">+
</a><a href="#h11-0-40" id="h11-0-40" class="i">+        log(&quot;Downloading apk...&quot;)
</a><a href="#h11-0-41" id="h11-0-41" class="i">+
</a><a href="#h11-0-42" id="h11-0-42" class="i">+        val downloadResponse = apkMirror.okhttpClient.newCall(
</a><a href="#h11-0-43" id="h11-0-43" class="i">+            okhttp3.Request.Builder()
</a><a href="#h11-0-44" id="h11-0-44" class="i">+                .url(downloadLink)
</a><a href="#h11-0-45" id="h11-0-45" class="i">+                .build()
</a><a href="#h11-0-46" id="h11-0-46" class="i">+        ).execute()
</a><a href="#h11-0-47" id="h11-0-47" class="i">+
</a><a href="#h11-0-48" id="h11-0-48" class="i">+        if (!downloadResponse.isSuccessful) {
</a><a href="#h11-0-49" id="h11-0-49" class="i">+            log(&quot;== Failed to download apk ==&quot;)
</a><a href="#h11-0-50" id="h11-0-50" class="i">+            log(&quot;Response code: ${downloadResponse.code}&quot;)
</a><a href="#h11-0-51" id="h11-0-51" class="i">+            return
</a><a href="#h11-0-52" id="h11-0-52" class="i">+        }
</a><a href="#h11-0-53" id="h11-0-53" class="i">+
</a><a href="#h11-0-54" id="h11-0-54" class="i">+        val apkFile = sharedConfig.apkCache.resolve(&quot;${downloadItem.hash}.apk&quot;)
</a><a href="#h11-0-55" id="h11-0-55" class="i">+        apkFile.outputStream().use { outputStream -&gt;
</a><a href="#h11-0-56" id="h11-0-56" class="i">+            runCatching {
</a><a href="#h11-0-57" id="h11-0-57" class="i">+                downloadResponse.body.byteStream().use { inputStream -&gt;
</a><a href="#h11-0-58" id="h11-0-58" class="i">+                    val buffer = ByteArray(DEFAULT_BUFFER_SIZE)
</a><a href="#h11-0-59" id="h11-0-59" class="i">+                    var read: Int
</a><a href="#h11-0-60" id="h11-0-60" class="i">+                    var totalRead = 0L
</a><a href="#h11-0-61" id="h11-0-61" class="i">+                    val totalSize = downloadResponse.body.contentLength()
</a><a href="#h11-0-62" id="h11-0-62" class="i">+                    while (inputStream.read(buffer).also { read = it } != -1) {
</a><a href="#h11-0-63" id="h11-0-63" class="i">+                        outputStream.write(buffer, 0, read)
</a><a href="#h11-0-64" id="h11-0-64" class="i">+                        totalRead += read
</a><a href="#h11-0-65" id="h11-0-65" class="i">+                        onProgress(totalRead.toFloat() / totalSize.toFloat())
</a><a href="#h11-0-66" id="h11-0-66" class="i">+                    }
</a><a href="#h11-0-67" id="h11-0-67" class="i">+                }
</a><a href="#h11-0-68" id="h11-0-68" class="i">+            }.onFailure {
</a><a href="#h11-0-69" id="h11-0-69" class="i">+                log(&quot;== Failed to download apk ==&quot;)
</a><a href="#h11-0-70" id="h11-0-70" class="i">+                log(it)
</a><a href="#h11-0-71" id="h11-0-71" class="i">+                return
</a><a href="#h11-0-72" id="h11-0-72" class="i">+            }
</a><a href="#h11-0-73" id="h11-0-73" class="i">+        }
</a><a href="#h11-0-74" id="h11-0-74" class="i">+
</a><a href="#h11-0-75" id="h11-0-75" class="i">+        apkFile.renameTo(File(activity.externalCacheDir!!, &quot;base.apk&quot;))
</a><a href="#h11-0-76" id="h11-0-76" class="i">+
</a><a href="#h11-0-77" id="h11-0-77" class="i">+        log(&quot;== Downloaded apk ==&quot;)
</a><a href="#h11-0-78" id="h11-0-78" class="i">+        snapEnhanceModule?.let { module -&gt;
</a><a href="#h11-0-79" id="h11-0-79" class="i">+            val lsPatch = LSPatch(activity, mapOf(
</a><a href="#h11-0-80" id="h11-0-80" class="i">+                sharedConfig.snapEnhancePackageName to module,
</a><a href="#h11-0-81" id="h11-0-81" class="i">+            ), printLog = {
</a><a href="#h11-0-82" id="h11-0-82" class="i">+                log(&quot;[LSPatch] $it&quot;)
</a><a href="#h11-0-83" id="h11-0-83" class="i">+            })
</a><a href="#h11-0-84" id="h11-0-84" class="i">+
</a><a href="#h11-0-85" id="h11-0-85" class="i">+            log(&quot;== Patching apk ==&quot;)
</a><a href="#h11-0-86" id="h11-0-86" class="i">+            val outputFiles = lsPatch.patchSplits(listOf(apkFile))
</a><a href="#h11-0-87" id="h11-0-87" class="i">+
</a><a href="#h11-0-88" id="h11-0-88" class="i">+            patchedApk = outputFiles[&quot;base.apk&quot;] ?: run {
</a><a href="#h11-0-89" id="h11-0-89" class="i">+                log(&quot;== Failed to patch apk ==&quot;)
</a><a href="#h11-0-90" id="h11-0-90" class="i">+                return
</a><a href="#h11-0-91" id="h11-0-91" class="i">+            }
</a><a href="#h11-0-92" id="h11-0-92" class="i">+            return@let
</a><a href="#h11-0-93" id="h11-0-93" class="i">+        }
</a><a href="#h11-0-94" id="h11-0-94" class="i">+        patchedApk = apkFile
</a><a href="#h11-0-95" id="h11-0-95" class="i">+    }
</a><a href="#h11-0-96" id="h11-0-96" class="i">+
</a><a href="#h11-0-97" id="h11-0-97" class="i">+    @Composable
</a><a href="#h11-0-98" id="h11-0-98" class="i">+    @Suppress(&quot;DEPRECATION&quot;)
</a><a href="#h11-0-99" id="h11-0-99" class="i">+    override fun Content() {
</a><a href="#h11-0-100" id="h11-0-100" class="i">+        this.downloadItem = remember { getArguments()?.getParcelable&lt;DownloadItem&gt;(&quot;downloadItem&quot;) } ?: return
</a><a href="#h11-0-101" id="h11-0-101" class="i">+        this.snapEnhanceModule = remember {
</a><a href="#h11-0-102" id="h11-0-102" class="i">+            getArguments()?.getString(&quot;modulePath&quot;)?.let {
</a><a href="#h11-0-103" id="h11-0-103" class="i">+                File(it)
</a><a href="#h11-0-104" id="h11-0-104" class="i">+            }
</a><a href="#h11-0-105" id="h11-0-105" class="i">+        }
</a><a href="#h11-0-106" id="h11-0-106" class="i">+
</a><a href="#h11-0-107" id="h11-0-107" class="i">+        val coroutineScope = rememberCoroutineScope()
</a><a href="#h11-0-108" id="h11-0-108" class="i">+        var showDowngradeNoticeDialog by remember { mutableStateOf(false) }
</a><a href="#h11-0-109" id="h11-0-109" class="i">+
</a><a href="#h11-0-110" id="h11-0-110" class="i">+        var status by remember { mutableStateOf(&quot;&quot;) }
</a><a href="#h11-0-111" id="h11-0-111" class="i">+        var progress by remember { mutableFloatStateOf(-1f) }
</a><a href="#h11-0-112" id="h11-0-112" class="i">+
</a><a href="#h11-0-113" id="h11-0-113" class="i">+        LaunchedEffect(this.downloadItem.hash) {
</a><a href="#h11-0-114" id="h11-0-114" class="i">+            patchedApk = null
</a><a href="#h11-0-115" id="h11-0-115" class="i">+            coroutineScope.launch(Dispatchers.IO) {
</a><a href="#h11-0-116" id="h11-0-116" class="i">+                runCatching {
</a><a href="#h11-0-117" id="h11-0-117" class="i">+                    patch(log = {
</a><a href="#h11-0-118" id="h11-0-118" class="i">+                        coroutineScope.launch {
</a><a href="#h11-0-119" id="h11-0-119" class="i">+                            status += when (it) {
</a><a href="#h11-0-120" id="h11-0-120" class="i">+                                is Throwable -&gt; it.message + &quot;\n&quot; + it.stackTraceToString()
</a><a href="#h11-0-121" id="h11-0-121" class="i">+                                else -&gt; it.toString()
</a><a href="#h11-0-122" id="h11-0-122" class="i">+                            } + &quot;\n&quot;
</a><a href="#h11-0-123" id="h11-0-123" class="i">+                        }
</a><a href="#h11-0-124" id="h11-0-124" class="i">+                    }) {
</a><a href="#h11-0-125" id="h11-0-125" class="i">+                        progress = it
</a><a href="#h11-0-126" id="h11-0-126" class="i">+                    }
</a><a href="#h11-0-127" id="h11-0-127" class="i">+                }.onFailure {
</a><a href="#h11-0-128" id="h11-0-128" class="i">+                    coroutineScope.launch {
</a><a href="#h11-0-129" id="h11-0-129" class="i">+                        status += it.message + &quot;\n&quot; + it.stackTraceToString()
</a><a href="#h11-0-130" id="h11-0-130" class="i">+                    }
</a><a href="#h11-0-131" id="h11-0-131" class="i">+                }
</a><a href="#h11-0-132" id="h11-0-132" class="i">+            }
</a><a href="#h11-0-133" id="h11-0-133" class="i">+        }
</a><a href="#h11-0-134" id="h11-0-134" class="i">+
</a><a href="#h11-0-135" id="h11-0-135" class="i">+        val scrollState = rememberScrollState()
</a><a href="#h11-0-136" id="h11-0-136" class="i">+
</a><a href="#h11-0-137" id="h11-0-137" class="i">+        fun triggerInstallation(shouldUninstall: Boolean) {
</a><a href="#h11-0-138" id="h11-0-138" class="i">+            navigation.navigateTo(InstallPackageTab::class, args = Bundle().apply {
</a><a href="#h11-0-139" id="h11-0-139" class="i">+                putString(&quot;downloadPath&quot;, patchedApk?.absolutePath)
</a><a href="#h11-0-140" id="h11-0-140" class="i">+                putString(&quot;appPackage&quot;, sharedConfig.snapchatPackageName)
</a><a href="#h11-0-141" id="h11-0-141" class="i">+                putBoolean(&quot;uninstall&quot;, shouldUninstall)
</a><a href="#h11-0-142" id="h11-0-142" class="i">+            })
</a><a href="#h11-0-143" id="h11-0-143" class="i">+        }
</a><a href="#h11-0-144" id="h11-0-144" class="i">+
</a><a href="#h11-0-145" id="h11-0-145" class="i">+        Column(
</a><a href="#h11-0-146" id="h11-0-146" class="i">+            modifier = Modifier
</a><a href="#h11-0-147" id="h11-0-147" class="i">+                .fillMaxSize()
</a><a href="#h11-0-148" id="h11-0-148" class="i">+                .padding(20.dp),
</a><a href="#h11-0-149" id="h11-0-149" class="i">+            horizontalAlignment = Alignment.CenterHorizontally,
</a><a href="#h11-0-150" id="h11-0-150" class="i">+            verticalArrangement = Arrangement.spacedBy(10.dp)
</a><a href="#h11-0-151" id="h11-0-151" class="i">+        ) {
</a><a href="#h11-0-152" id="h11-0-152" class="i">+            Card(
</a><a href="#h11-0-153" id="h11-0-153" class="i">+                modifier = Modifier
</a><a href="#h11-0-154" id="h11-0-154" class="i">+                    .weight(1f)
</a><a href="#h11-0-155" id="h11-0-155" class="i">+                    .padding(10.dp),
</a><a href="#h11-0-156" id="h11-0-156" class="i">+            ) {
</a><a href="#h11-0-157" id="h11-0-157" class="i">+                Column(
</a><a href="#h11-0-158" id="h11-0-158" class="i">+                    modifier = Modifier
</a><a href="#h11-0-159" id="h11-0-159" class="i">+                        .fillMaxSize()
</a><a href="#h11-0-160" id="h11-0-160" class="i">+                        .verticalScroll(scrollState)
</a><a href="#h11-0-161" id="h11-0-161" class="i">+                ) {
</a><a href="#h11-0-162" id="h11-0-162" class="i">+                    Text(text = status, overflow = TextOverflow.Visible, modifier = Modifier.padding(10.dp))
</a><a href="#h11-0-163" id="h11-0-163" class="i">+                }
</a><a href="#h11-0-164" id="h11-0-164" class="i">+            }
</a><a href="#h11-0-165" id="h11-0-165" class="i">+            if (progress != -1f) {
</a><a href="#h11-0-166" id="h11-0-166" class="i">+                LinearProgressIndicator(progress = progress, modifier = Modifier.height(10.dp), strokeCap = StrokeCap.Round)
</a><a href="#h11-0-167" id="h11-0-167" class="i">+            }
</a><a href="#h11-0-168" id="h11-0-168" class="i">+
</a><a href="#h11-0-169" id="h11-0-169" class="i">+            if (patchedApk != null) {
</a><a href="#h11-0-170" id="h11-0-170" class="i">+                Button(modifier = Modifier.fillMaxWidth(), onClick = {
</a><a href="#h11-0-171" id="h11-0-171" class="i">+                    triggerInstallation(true)
</a><a href="#h11-0-172" id="h11-0-172" class="i">+                }) {
</a><a href="#h11-0-173" id="h11-0-173" class="i">+                    Text(text = &quot;Uninstall &amp; Install&quot;)
</a><a href="#h11-0-174" id="h11-0-174" class="i">+                }
</a><a href="#h11-0-175" id="h11-0-175" class="i">+
</a><a href="#h11-0-176" id="h11-0-176" class="i">+                Button(modifier = Modifier.fillMaxWidth(), onClick = {
</a><a href="#h11-0-177" id="h11-0-177" class="i">+                    showDowngradeNoticeDialog = true
</a><a href="#h11-0-178" id="h11-0-178" class="i">+                }) {
</a><a href="#h11-0-179" id="h11-0-179" class="i">+                    Text(text = &quot;Update&quot;)
</a><a href="#h11-0-180" id="h11-0-180" class="i">+                }
</a><a href="#h11-0-181" id="h11-0-181" class="i">+            }
</a><a href="#h11-0-182" id="h11-0-182" class="i">+
</a><a href="#h11-0-183" id="h11-0-183" class="i">+            LaunchedEffect(status) {
</a><a href="#h11-0-184" id="h11-0-184" class="i">+                scrollState.scrollTo(scrollState.maxValue)
</a><a href="#h11-0-185" id="h11-0-185" class="i">+            }
</a><a href="#h11-0-186" id="h11-0-186" class="i">+        }
</a><a href="#h11-0-187" id="h11-0-187" class="i">+
</a><a href="#h11-0-188" id="h11-0-188" class="i">+        if (showDowngradeNoticeDialog) {
</a><a href="#h11-0-189" id="h11-0-189" class="i">+            Dialog(onDismissRequest = { showDowngradeNoticeDialog = false }) {
</a><a href="#h11-0-190" id="h11-0-190" class="i">+                DowngradeNoticeDialog(onDismiss = { showDowngradeNoticeDialog = false }, onSuccess = {
</a><a href="#h11-0-191" id="h11-0-191" class="i">+                    triggerInstallation(false)
</a><a href="#h11-0-192" id="h11-0-192" class="i">+                })
</a><a href="#h11-0-193" id="h11-0-193" class="i">+            }
</a><a href="#h11-0-194" id="h11-0-194" class="i">+        }
</a><a href="#h11-0-195" id="h11-0-195" class="i">+    }
</a><a href="#h11-0-196" id="h11-0-196" class="i">+}</a><a href="#h11-0-197" id="h11-0-197" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h12" href="../file/manager/src/main/kotlin/me/rhunk/snapenhance/manager/ui/tab/download/SEDownloadTab.kt.html">manager/src/main/kotlin/me/rhunk/snapenhance/manager/ui/tab/download/SEDownloadTab.kt</a> b/<a href="../file/manager/src/main/kotlin/me/rhunk/snapenhance/manager/ui/tab/download/SEDownloadTab.kt.html">manager/src/main/kotlin/me/rhunk/snapenhance/manager/ui/tab/download/SEDownloadTab.kt</a></b>
<a href="#h12-0" id="h12-0" class="h">@@ -5,7 +5,11 @@ import androidx.activity.ComponentActivity
</a> import androidx.compose.foundation.background
 import androidx.compose.foundation.border
 import androidx.compose.foundation.clickable
<a href="#h12-0-3" id="h12-0-3" class="d">-import androidx.compose.foundation.layout.*
</a><a href="#h12-0-4" id="h12-0-4" class="i">+import androidx.compose.foundation.layout.Arrangement
</a><a href="#h12-0-5" id="h12-0-5" class="i">+import androidx.compose.foundation.layout.Column
</a><a href="#h12-0-6" id="h12-0-6" class="i">+import androidx.compose.foundation.layout.Row
</a><a href="#h12-0-7" id="h12-0-7" class="i">+import androidx.compose.foundation.layout.fillMaxWidth
</a><a href="#h12-0-8" id="h12-0-8" class="i">+import androidx.compose.foundation.layout.padding
</a> import androidx.compose.foundation.lazy.LazyColumn
 import androidx.compose.foundation.lazy.items
 import androidx.compose.material.icons.Icons
<a href="#h12-1" id="h12-1" class="h">@@ -20,22 +24,20 @@ import androidx.compose.ui.window.Dialog
</a> import com.google.gson.JsonParser
 import kotlinx.coroutines.Dispatchers
 import kotlinx.coroutines.launch
<a href="#h12-1-3" id="h12-1-3" class="d">-import me.rhunk.snapenhance.manager.BuildConfig
</a> import me.rhunk.snapenhance.manager.data.download.SEArtifact
 import me.rhunk.snapenhance.manager.data.download.SEVersion
 import me.rhunk.snapenhance.manager.ui.Tab
<a href="#h12-1-7" id="h12-1-7" class="i">+import me.rhunk.snapenhance.manager.ui.components.DowngradeNoticeDialog
</a> import okhttp3.OkHttpClient
 import okhttp3.Request
 import java.text.SimpleDateFormat
 import java.util.Locale
 
 
<a href="#h12-1-14" id="h12-1-14" class="d">-class SEDownloadTab : Tab(&quot;se_downloads&quot;) {
</a><a href="#h12-1-15" id="h12-1-15" class="i">+class SEDownloadTab : Tab(&quot;se_download&quot;) {
</a>     private fun fetchSEReleases(): List&lt;SEVersion&gt;? {
         return runCatching {
<a href="#h12-1-18" id="h12-1-18" class="d">-            val endpoint =
</a><a href="#h12-1-19" id="h12-1-19" class="d">-                Request.Builder().url(&quot;https://api.github.com/repos/rhunk/SnapEnhance/releases&quot;)
</a><a href="#h12-1-20" id="h12-1-20" class="d">-                    .build()
</a><a href="#h12-1-21" id="h12-1-21" class="i">+            val endpoint = Request.Builder().url(&quot;https://api.github.com/repos/rhunk/SnapEnhance/releases&quot;).build()
</a>             val response = OkHttpClient().newCall(endpoint).execute()
             if (!response.isSuccessful) return null
 
<a href="#h12-2" id="h12-2" class="h">@@ -69,36 +71,6 @@ class SEDownloadTab : Tab(&quot;se_downloads&quot;) {
</a> 
     override fun init(activity: ComponentActivity) {
         super.init(activity)
<a href="#h12-2-3" id="h12-2-3" class="d">-        registerNestedTab(InstallAppTab::class)
</a><a href="#h12-2-4" id="h12-2-4" class="d">-    }
</a><a href="#h12-2-5" id="h12-2-5" class="d">-
</a><a href="#h12-2-6" id="h12-2-6" class="d">-    @Composable
</a><a href="#h12-2-7" id="h12-2-7" class="d">-    private fun DowngradeNoticeDialog(onDismiss: () -&gt; Unit, onSuccess: () -&gt; Unit) {
</a><a href="#h12-2-8" id="h12-2-8" class="d">-        Card {
</a><a href="#h12-2-9" id="h12-2-9" class="d">-            Column(
</a><a href="#h12-2-10" id="h12-2-10" class="d">-                modifier = Modifier
</a><a href="#h12-2-11" id="h12-2-11" class="d">-                    .fillMaxWidth()
</a><a href="#h12-2-12" id="h12-2-12" class="d">-                    .padding(16.dp),
</a><a href="#h12-2-13" id="h12-2-13" class="d">-                horizontalAlignment = Alignment.CenterHorizontally,
</a><a href="#h12-2-14" id="h12-2-14" class="d">-                verticalArrangement = Arrangement.spacedBy(16.dp),
</a><a href="#h12-2-15" id="h12-2-15" class="d">-            ) {
</a><a href="#h12-2-16" id="h12-2-16" class="d">-                Text(text = &quot;Downgrade Notice&quot;, fontSize = 24.sp)
</a><a href="#h12-2-17" id="h12-2-17" class="d">-                Text(text = &quot;You are about to update the app. If you&#39;re installing an older version over a newer one, make sure you have CorePatch installed. Otherwise, you will need to uninstall and install.&quot;, fontSize = 12.sp)
</a><a href="#h12-2-18" id="h12-2-18" class="d">-            }
</a><a href="#h12-2-19" id="h12-2-19" class="d">-            Row(
</a><a href="#h12-2-20" id="h12-2-20" class="d">-                modifier = Modifier
</a><a href="#h12-2-21" id="h12-2-21" class="d">-                    .fillMaxWidth()
</a><a href="#h12-2-22" id="h12-2-22" class="d">-                    .padding(16.dp),
</a><a href="#h12-2-23" id="h12-2-23" class="d">-                horizontalArrangement = Arrangement.SpaceAround
</a><a href="#h12-2-24" id="h12-2-24" class="d">-            ) {
</a><a href="#h12-2-25" id="h12-2-25" class="d">-                Button(onClick = onDismiss) {
</a><a href="#h12-2-26" id="h12-2-26" class="d">-                    Text(text = &quot;Cancel&quot;)
</a><a href="#h12-2-27" id="h12-2-27" class="d">-                }
</a><a href="#h12-2-28" id="h12-2-28" class="d">-                Button(onClick = onSuccess) {
</a><a href="#h12-2-29" id="h12-2-29" class="d">-                    Text(text = &quot;Continue&quot;)
</a><a href="#h12-2-30" id="h12-2-30" class="d">-                }
</a><a href="#h12-2-31" id="h12-2-31" class="d">-            }
</a><a href="#h12-2-32" id="h12-2-32" class="d">-        }
</a>     }
 
     @Composable
<a href="#h12-3" id="h12-3" class="h">@@ -110,20 +82,16 @@ class SEDownloadTab : Tab(&quot;se_downloads&quot;) {
</a> 
         var selectedVersion by remember { mutableStateOf(null as SEVersion?) }
         var selectedArtifact by remember { mutableStateOf(null as SEArtifact?) }
<a href="#h12-3-3" id="h12-3-3" class="d">-        val appPackageName = remember { sharedConfig.snapEnhancePackageName ?: BuildConfig.APPLICATION_ID }
</a><a href="#h12-3-4" id="h12-3-4" class="d">-        val isAppInstalled = remember { runCatching { activity.packageManager.getPackageInfo(appPackageName, 0) != null }.getOrNull() != null }
</a><a href="#h12-3-5" id="h12-3-5" class="i">+        val isAppInstalled = remember { runCatching { activity.packageManager.getPackageInfo(sharedConfig.snapEnhancePackageName, 0) != null }.getOrNull() != null }
</a> 
         var showDowngradeNotice by remember { mutableStateOf(false) }
 
         fun triggerPackageInstallation(shouldUninstall: Boolean) {
<a href="#h12-3-10" id="h12-3-10" class="d">-            navigation.navigateTo(InstallAppTab::class, Bundle().apply {
</a><a href="#h12-3-11" id="h12-3-11" class="d">-                putParcelable(&quot;artifact&quot;, selectedArtifact)
</a><a href="#h12-3-12" id="h12-3-12" class="d">-                putString(
</a><a href="#h12-3-13" id="h12-3-13" class="d">-                    &quot;appPackage&quot;,
</a><a href="#h12-3-14" id="h12-3-14" class="d">-                    sharedConfig.snapEnhancePackageName ?: BuildConfig.APPLICATION_ID
</a><a href="#h12-3-15" id="h12-3-15" class="d">-                )
</a><a href="#h12-3-16" id="h12-3-16" class="i">+            navigation.navigateTo(InstallPackageTab::class, Bundle().apply {
</a><a href="#h12-3-17" id="h12-3-17" class="i">+                putString(&quot;downloadPath&quot;, selectedArtifact?.downloadUrl)
</a><a href="#h12-3-18" id="h12-3-18" class="i">+                putString(&quot;appPackage&quot;, sharedConfig.snapEnhancePackageName)
</a>                 putBoolean(&quot;uninstall&quot;, shouldUninstall)
<a href="#h12-3-20" id="h12-3-20" class="d">-            })
</a><a href="#h12-3-21" id="h12-3-21" class="i">+            }, noHistory = true)
</a>         }
 
         if (showDowngradeNotice) {
<a href="#h12-4" id="h12-4" class="h">@@ -141,12 +109,12 @@ class SEDownloadTab : Tab(&quot;se_downloads&quot;) {
</a>             verticalArrangement = Arrangement.spacedBy(16.dp),
             horizontalAlignment = Alignment.CenterHorizontally
         ) {
<a href="#h12-4-3" id="h12-4-3" class="d">-            Text(text = &quot;SnapEnhance Builds&quot;)
</a><a href="#h12-4-4" id="h12-4-4" class="i">+            Text(text = &quot;Choose SnapEnhance version&quot;)
</a> 
             LazyColumn(
                 modifier = Modifier
                     .fillMaxWidth()
<a href="#h12-4-9" id="h12-4-9" class="d">-                    .fillMaxHeight(0.8f),
</a><a href="#h12-4-10" id="h12-4-10" class="i">+                    .weight(1f),
</a>                 verticalArrangement = Arrangement.spacedBy(10.dp)
             ) {
                 item {
<b>diff --git a/<a id="h13" href="../file/manager/src/main/kotlin/me/rhunk/snapenhance/manager/ui/tab/download/SnapchatPatchTab.kt.html">manager/src/main/kotlin/me/rhunk/snapenhance/manager/ui/tab/download/SnapchatPatchTab.kt</a> b/<a href="../file/manager/src/main/kotlin/me/rhunk/snapenhance/manager/ui/tab/download/SnapchatPatchTab.kt.html">manager/src/main/kotlin/me/rhunk/snapenhance/manager/ui/tab/download/SnapchatPatchTab.kt</a></b>
<a href="#h13-0" id="h13-0" class="h">@@ -1,12 +1,13 @@
</a> package me.rhunk.snapenhance.manager.ui.tab.download
 
<a href="#h13-0-2" id="h13-0-2" class="i">+import android.os.Bundle
</a><a href="#h13-0-3" id="h13-0-3" class="i">+import androidx.activity.ComponentActivity
</a> import androidx.compose.foundation.layout.*
 import androidx.compose.foundation.lazy.LazyColumn
 import androidx.compose.foundation.lazy.items
 import androidx.compose.material.icons.Icons
<a href="#h13-0-8" id="h13-0-8" class="d">-import androidx.compose.material.icons.filled.Delete
</a><a href="#h13-0-9" id="h13-0-9" class="i">+import androidx.compose.material.icons.filled.Check
</a> import androidx.compose.material.icons.filled.DeleteForever
<a href="#h13-0-11" id="h13-0-11" class="d">-import androidx.compose.material.icons.filled.Download
</a> import androidx.compose.material3.*
 import androidx.compose.runtime.*
 import androidx.compose.ui.Alignment
<a href="#h13-1" id="h13-1" class="h">@@ -14,7 +15,6 @@ import androidx.compose.ui.Modifier
</a> import androidx.compose.ui.draw.alpha
 import androidx.compose.ui.res.painterResource
 import androidx.compose.ui.unit.dp
<a href="#h13-1-3" id="h13-1-3" class="d">-import kotlinx.coroutines.CoroutineScope
</a> import kotlinx.coroutines.Dispatchers
 import kotlinx.coroutines.launch
 import kotlinx.coroutines.withContext
<a href="#h13-2" id="h13-2" class="h">@@ -25,73 +25,14 @@ import me.rhunk.snapenhance.manager.ui.Tab
</a> import me.rhunk.snapenhance.manager.ui.components.ConfirmationDialog
 
 @OptIn(ExperimentalMaterial3Api::class)
<a href="#h13-2-3" id="h13-2-3" class="d">-class SnapchatPatchTab : Tab(&quot;snapchat_download_tab&quot;) {
</a><a href="#h13-2-4" id="h13-2-4" class="d">-    private val apkCache by lazy {
</a><a href="#h13-2-5" id="h13-2-5" class="d">-        activity.cacheDir.resolve(&quot;snapchat_apk_cache&quot;).also {
</a><a href="#h13-2-6" id="h13-2-6" class="d">-            if (!it.exists()) it.mkdirs()
</a><a href="#h13-2-7" id="h13-2-7" class="d">-        }
</a><a href="#h13-2-8" id="h13-2-8" class="d">-    }
</a><a href="#h13-2-9" id="h13-2-9" class="i">+class SnapchatPatchTab : Tab(&quot;snapchat_download&quot;) {
</a>     private val apkMirror =  APKMirror()
     private val cachedDownloadItems = mutableListOf&lt;DownloadItem&gt;()
     private var currentPage by mutableIntStateOf(1)
 
<a href="#h13-2-14" id="h13-2-14" class="d">-    private fun isDownloaded(hash: String): Boolean {
</a><a href="#h13-2-15" id="h13-2-15" class="d">-        return apkCache.resolve(&quot;${hash}.apk&quot;).exists()
</a><a href="#h13-2-16" id="h13-2-16" class="d">-    }
</a><a href="#h13-2-17" id="h13-2-17" class="d">-
</a><a href="#h13-2-18" id="h13-2-18" class="d">-    private fun deleteDownload(hash: String) {
</a><a href="#h13-2-19" id="h13-2-19" class="d">-        runCatching {
</a><a href="#h13-2-20" id="h13-2-20" class="d">-            apkCache.resolve(&quot;${hash}.apk&quot;).delete()
</a><a href="#h13-2-21" id="h13-2-21" class="d">-        }.onFailure {
</a><a href="#h13-2-22" id="h13-2-22" class="d">-            it.printStackTrace()
</a><a href="#h13-2-23" id="h13-2-23" class="d">-            toast(&quot;Failed to delete download. It may have already been deleted.&quot;)
</a><a href="#h13-2-24" id="h13-2-24" class="d">-        }
</a><a href="#h13-2-25" id="h13-2-25" class="d">-    }
</a><a href="#h13-2-26" id="h13-2-26" class="d">-
</a><a href="#h13-2-27" id="h13-2-27" class="d">-    private suspend fun downloadSnapchatVersion(downloadItem: DownloadItem, onProgress: (Float) -&gt; Unit, onSuccess: suspend () -&gt; Unit) {
</a><a href="#h13-2-28" id="h13-2-28" class="d">-        withContext(Dispatchers.IO) {
</a><a href="#h13-2-29" id="h13-2-29" class="d">-            toast(&quot;Downloading ${downloadItem.title}...&quot;)
</a><a href="#h13-2-30" id="h13-2-30" class="d">-            val downloadLink = apkMirror.fetchDownloadLink(downloadItem.downloadPage) ?: run {
</a><a href="#h13-2-31" id="h13-2-31" class="d">-                toast(&quot;Failed to fetch download link&quot;)
</a><a href="#h13-2-32" id="h13-2-32" class="d">-                return@withContext
</a><a href="#h13-2-33" id="h13-2-33" class="d">-            }
</a><a href="#h13-2-34" id="h13-2-34" class="d">-
</a><a href="#h13-2-35" id="h13-2-35" class="d">-            val downloadResponse = apkMirror.okhttpClient.newCall(
</a><a href="#h13-2-36" id="h13-2-36" class="d">-                okhttp3.Request.Builder()
</a><a href="#h13-2-37" id="h13-2-37" class="d">-                    .url(downloadLink)
</a><a href="#h13-2-38" id="h13-2-38" class="d">-                    .build()
</a><a href="#h13-2-39" id="h13-2-39" class="d">-            ).execute()
</a><a href="#h13-2-40" id="h13-2-40" class="d">-
</a><a href="#h13-2-41" id="h13-2-41" class="d">-            if (!downloadResponse.isSuccessful) {
</a><a href="#h13-2-42" id="h13-2-42" class="d">-                toast(&quot;Failed to download&quot;)
</a><a href="#h13-2-43" id="h13-2-43" class="d">-                return@withContext
</a><a href="#h13-2-44" id="h13-2-44" class="d">-            }
</a><a href="#h13-2-45" id="h13-2-45" class="d">-
</a><a href="#h13-2-46" id="h13-2-46" class="d">-            val apkFile = apkCache.resolve(&quot;${downloadItem.hash}.apk&quot;)
</a><a href="#h13-2-47" id="h13-2-47" class="d">-            apkFile.outputStream().use { outputStream -&gt;
</a><a href="#h13-2-48" id="h13-2-48" class="d">-                runCatching {
</a><a href="#h13-2-49" id="h13-2-49" class="d">-                    downloadResponse.body.byteStream().use { inputStream -&gt;
</a><a href="#h13-2-50" id="h13-2-50" class="d">-                        val buffer = ByteArray(DEFAULT_BUFFER_SIZE)
</a><a href="#h13-2-51" id="h13-2-51" class="d">-                        var read: Int
</a><a href="#h13-2-52" id="h13-2-52" class="d">-                        var totalRead = 0L
</a><a href="#h13-2-53" id="h13-2-53" class="d">-                        val totalSize = downloadResponse.body.contentLength()
</a><a href="#h13-2-54" id="h13-2-54" class="d">-                        while (inputStream.read(buffer).also { read = it } != -1) {
</a><a href="#h13-2-55" id="h13-2-55" class="d">-                            outputStream.write(buffer, 0, read)
</a><a href="#h13-2-56" id="h13-2-56" class="d">-                            totalRead += read
</a><a href="#h13-2-57" id="h13-2-57" class="d">-                            onProgress(totalRead.toFloat() / totalSize.toFloat())
</a><a href="#h13-2-58" id="h13-2-58" class="d">-                        }
</a><a href="#h13-2-59" id="h13-2-59" class="d">-                    }
</a><a href="#h13-2-60" id="h13-2-60" class="d">-                }.onFailure {
</a><a href="#h13-2-61" id="h13-2-61" class="d">-                    it.printStackTrace()
</a><a href="#h13-2-62" id="h13-2-62" class="d">-                    toast(&quot;Failed to save apk&quot;)
</a><a href="#h13-2-63" id="h13-2-63" class="d">-                    return@withContext
</a><a href="#h13-2-64" id="h13-2-64" class="d">-                }
</a><a href="#h13-2-65" id="h13-2-65" class="d">-            }
</a><a href="#h13-2-66" id="h13-2-66" class="d">-
</a><a href="#h13-2-67" id="h13-2-67" class="d">-            withContext(Dispatchers.Main) {
</a><a href="#h13-2-68" id="h13-2-68" class="d">-                onSuccess()
</a><a href="#h13-2-69" id="h13-2-69" class="d">-            }
</a><a href="#h13-2-70" id="h13-2-70" class="d">-        }
</a><a href="#h13-2-71" id="h13-2-71" class="i">+    override fun init(activity: ComponentActivity) {
</a><a href="#h13-2-72" id="h13-2-72" class="i">+        super.init(activity)
</a><a href="#h13-2-73" id="h13-2-73" class="i">+        registerNestedTab(LSPatchTab::class)
</a>     }
 
     @Composable
<a href="#h13-3" id="h13-3" class="h">@@ -106,7 +47,7 @@ class SnapchatPatchTab : Tab(&quot;snapchat_download_tab&quot;) {
</a>                 ConfirmationDialog(title = &quot;Are you sure you want to delete all downloads?&quot;, onDismiss = { deleteAllDialog = false }) {
                     deleteAllDialog = false
                     runCatching {
<a href="#h13-3-3" id="h13-3-3" class="d">-                        apkCache.listFiles()?.forEach { it.deleteRecursively() }
</a><a href="#h13-3-4" id="h13-3-4" class="i">+                        sharedConfig.apkCache.listFiles()?.forEach { it.deleteRecursively() }
</a>                     }.onFailure {
                         toast(&quot;Failed to delete downloads&quot;)
                         it.printStackTrace()
<a href="#h13-4" id="h13-4" class="h">@@ -118,25 +59,7 @@ class SnapchatPatchTab : Tab(&quot;snapchat_download_tab&quot;) {
</a>     }
 
     @Composable
<a href="#h13-4-3" id="h13-4-3" class="d">-    private fun DownloadItemRow(coroutineScope: CoroutineScope, item: DownloadItem) {
</a><a href="#h13-4-4" id="h13-4-4" class="d">-        var isDownloading by remember { mutableStateOf(false) }
</a><a href="#h13-4-5" id="h13-4-5" class="d">-        var downloadProgress by remember { mutableFloatStateOf(-1f) }
</a><a href="#h13-4-6" id="h13-4-6" class="d">-        var isDownloaded by remember { mutableStateOf(isDownloaded(item.hash)) }
</a><a href="#h13-4-7" id="h13-4-7" class="d">-
</a><a href="#h13-4-8" id="h13-4-8" class="d">-        var showDeleteCurrentDownloadDialog by remember { mutableStateOf(false) }
</a><a href="#h13-4-9" id="h13-4-9" class="d">-
</a><a href="#h13-4-10" id="h13-4-10" class="d">-        if (showDeleteCurrentDownloadDialog) {
</a><a href="#h13-4-11" id="h13-4-11" class="d">-            AlertDialog(onDismissRequest = { showDeleteCurrentDownloadDialog = false }) {
</a><a href="#h13-4-12" id="h13-4-12" class="d">-                ConfirmationDialog(title = &quot;Are you sure you want to delete this download?&quot;, onDismiss = { showDeleteCurrentDownloadDialog = false }) {
</a><a href="#h13-4-13" id="h13-4-13" class="d">-                    coroutineScope.launch {
</a><a href="#h13-4-14" id="h13-4-14" class="d">-                        deleteDownload(item.hash)
</a><a href="#h13-4-15" id="h13-4-15" class="d">-                        isDownloaded = false
</a><a href="#h13-4-16" id="h13-4-16" class="d">-                    }
</a><a href="#h13-4-17" id="h13-4-17" class="d">-                    showDeleteCurrentDownloadDialog = false
</a><a href="#h13-4-18" id="h13-4-18" class="d">-                }
</a><a href="#h13-4-19" id="h13-4-19" class="d">-            }
</a><a href="#h13-4-20" id="h13-4-20" class="d">-        }
</a><a href="#h13-4-21" id="h13-4-21" class="d">-
</a><a href="#h13-4-22" id="h13-4-22" class="i">+    private fun DownloadItemRow(item: DownloadItem, onSelected: () -&gt; Unit = {}) {
</a>         ElevatedCard(
             modifier = Modifier.padding(10.dp),
         ) {
<a href="#h13-5" id="h13-5" class="h">@@ -157,7 +80,6 @@ class SnapchatPatchTab : Tab(&quot;snapchat_download_tab&quot;) {
</a>                     verticalArrangement = Arrangement.spacedBy(5.dp)
                 ) {
                     Text(item.shortTitle)
<a href="#h13-5-3" id="h13-5-3" class="d">-                    Text(item.releaseDate)
</a>                     if (!item.isBeta) {
                         Text(&quot;Recommended&quot;, color = MaterialTheme.colorScheme.tertiary)
                     }
<a href="#h13-6" id="h13-6" class="h">@@ -166,34 +88,54 @@ class SnapchatPatchTab : Tab(&quot;snapchat_download_tab&quot;) {
</a>                     modifier = Modifier.padding(5.dp),
                     horizontalArrangement = Arrangement.spacedBy(5.dp),
                 ) {
<a href="#h13-6-3" id="h13-6-3" class="d">-                    if (!isDownloaded) {
</a><a href="#h13-6-4" id="h13-6-4" class="d">-                        if (isDownloading) {
</a><a href="#h13-6-5" id="h13-6-5" class="d">-                            if (downloadProgress != -1f) {
</a><a href="#h13-6-6" id="h13-6-6" class="d">-                                CircularProgressIndicator(progress = downloadProgress, modifier = Modifier.size(40.dp))
</a><a href="#h13-6-7" id="h13-6-7" class="d">-                            } else {
</a><a href="#h13-6-8" id="h13-6-8" class="d">-                                CircularProgressIndicator(modifier = Modifier.size(40.dp))
</a><a href="#h13-6-9" id="h13-6-9" class="d">-                            }
</a><a href="#h13-6-10" id="h13-6-10" class="d">-                        } else {
</a><a href="#h13-6-11" id="h13-6-11" class="d">-                            FilledIconButton(onClick = {
</a><a href="#h13-6-12" id="h13-6-12" class="d">-                                coroutineScope.launch {
</a><a href="#h13-6-13" id="h13-6-13" class="d">-                                    isDownloading = true
</a><a href="#h13-6-14" id="h13-6-14" class="d">-                                    downloadProgress = -1f
</a><a href="#h13-6-15" id="h13-6-15" class="d">-                                    downloadSnapchatVersion(item, onProgress = {
</a><a href="#h13-6-16" id="h13-6-16" class="d">-                                        downloadProgress = it
</a><a href="#h13-6-17" id="h13-6-17" class="d">-                                    }, onSuccess = { isDownloaded = true })
</a><a href="#h13-6-18" id="h13-6-18" class="d">-                                    isDownloading = false
</a><a href="#h13-6-19" id="h13-6-19" class="i">+                    FilledIconButton(onClick = { onSelected() }) {
</a><a href="#h13-6-20" id="h13-6-20" class="i">+                        Icon(imageVector = Icons.Default.Check, contentDescription = null)
</a><a href="#h13-6-21" id="h13-6-21" class="i">+                    }
</a><a href="#h13-6-22" id="h13-6-22" class="i">+                }
</a><a href="#h13-6-23" id="h13-6-23" class="i">+            }
</a><a href="#h13-6-24" id="h13-6-24" class="i">+        }
</a><a href="#h13-6-25" id="h13-6-25" class="i">+    }
</a><a href="#h13-6-26" id="h13-6-26" class="i">+
</a><a href="#h13-6-27" id="h13-6-27" class="i">+
</a><a href="#h13-6-28" id="h13-6-28" class="i">+    @Composable
</a><a href="#h13-6-29" id="h13-6-29" class="i">+    private fun SelectSnapchatVersionDialog(onSelected: (DownloadItem) -&gt; Unit = {}) {
</a><a href="#h13-6-30" id="h13-6-30" class="i">+        val coroutineScope = rememberCoroutineScope()
</a><a href="#h13-6-31" id="h13-6-31" class="i">+        var isFetching by remember { mutableStateOf(false) }
</a><a href="#h13-6-32" id="h13-6-32" class="i">+        val downloadItems = remember { cachedDownloadItems.toMutableStateList() }
</a><a href="#h13-6-33" id="h13-6-33" class="i">+
</a><a href="#h13-6-34" id="h13-6-34" class="i">+        LazyColumn {
</a><a href="#h13-6-35" id="h13-6-35" class="i">+            items(downloadItems, key = { it.hash }) { item -&gt;
</a><a href="#h13-6-36" id="h13-6-36" class="i">+                DownloadItemRow(item) {
</a><a href="#h13-6-37" id="h13-6-37" class="i">+                    onSelected(item)
</a><a href="#h13-6-38" id="h13-6-38" class="i">+                }
</a><a href="#h13-6-39" id="h13-6-39" class="i">+            }
</a><a href="#h13-6-40" id="h13-6-40" class="i">+            item {
</a><a href="#h13-6-41" id="h13-6-41" class="i">+                Box(
</a><a href="#h13-6-42" id="h13-6-42" class="i">+                    modifier = Modifier
</a><a href="#h13-6-43" id="h13-6-43" class="i">+                        .fillMaxWidth()
</a><a href="#h13-6-44" id="h13-6-44" class="i">+                        .padding(20.dp),
</a><a href="#h13-6-45" id="h13-6-45" class="i">+                    contentAlignment = Alignment.Center
</a><a href="#h13-6-46" id="h13-6-46" class="i">+                ) {
</a><a href="#h13-6-47" id="h13-6-47" class="i">+                    CircularProgressIndicator(modifier = Modifier.alpha(if (isFetching) 1f else 0f))
</a><a href="#h13-6-48" id="h13-6-48" class="i">+                }
</a><a href="#h13-6-49" id="h13-6-49" class="i">+                SideEffect {
</a><a href="#h13-6-50" id="h13-6-50" class="i">+                    if (isFetching) return@SideEffect
</a><a href="#h13-6-51" id="h13-6-51" class="i">+                    isFetching = true
</a><a href="#h13-6-52" id="h13-6-52" class="i">+                    coroutineScope.launch {
</a><a href="#h13-6-53" id="h13-6-53" class="i">+                        runCatching {
</a><a href="#h13-6-54" id="h13-6-54" class="i">+                            withContext(Dispatchers.IO) {
</a><a href="#h13-6-55" id="h13-6-55" class="i">+                                apkMirror.fetchSnapchatVersions(currentPage)?.let {
</a><a href="#h13-6-56" id="h13-6-56" class="i">+                                    withContext(Dispatchers.Main) {
</a><a href="#h13-6-57" id="h13-6-57" class="i">+                                        cachedDownloadItems.addAll(it)
</a><a href="#h13-6-58" id="h13-6-58" class="i">+                                        downloadItems.addAll(it)
</a><a href="#h13-6-59" id="h13-6-59" class="i">+                                    }
</a>                                 }
<a href="#h13-6-61" id="h13-6-61" class="d">-                            }) {
</a><a href="#h13-6-62" id="h13-6-62" class="d">-                                Icon(imageVector = Icons.Default.Download, contentDescription = null)
</a>                             }
<a href="#h13-6-64" id="h13-6-64" class="i">+                        }.onFailure {
</a><a href="#h13-6-65" id="h13-6-65" class="i">+                            it.printStackTrace()
</a>                         }
<a href="#h13-6-67" id="h13-6-67" class="d">-                    } else {
</a><a href="#h13-6-68" id="h13-6-68" class="d">-                        Button(onClick = { /*TODO*/ }) {
</a><a href="#h13-6-69" id="h13-6-69" class="d">-                            Text(&quot;Patch&quot;)
</a><a href="#h13-6-70" id="h13-6-70" class="d">-                        }
</a><a href="#h13-6-71" id="h13-6-71" class="d">-                        IconButton(onClick = { showDeleteCurrentDownloadDialog = true }) {
</a><a href="#h13-6-72" id="h13-6-72" class="d">-                            Icon(imageVector = Icons.Default.Delete, contentDescription = null)
</a><a href="#h13-6-73" id="h13-6-73" class="d">-                        }
</a><a href="#h13-6-74" id="h13-6-74" class="i">+                        ++currentPage
</a><a href="#h13-6-75" id="h13-6-75" class="i">+                        isFetching = false
</a>                     }
                 }
             }
<a href="#h13-7" id="h13-7" class="h">@@ -202,9 +144,19 @@ class SnapchatPatchTab : Tab(&quot;snapchat_download_tab&quot;) {
</a> 
     @Composable
     override fun Content() {
<a href="#h13-7-3" id="h13-7-3" class="d">-        val coroutineScope = rememberCoroutineScope()
</a><a href="#h13-7-4" id="h13-7-4" class="d">-        var isFetching by remember { mutableStateOf(false) }
</a><a href="#h13-7-5" id="h13-7-5" class="d">-        val downloadItems = remember { cachedDownloadItems.toMutableStateList() }
</a><a href="#h13-7-6" id="h13-7-6" class="i">+        var showSelectSnapchatVersionDialog by remember { mutableStateOf(false) }
</a><a href="#h13-7-7" id="h13-7-7" class="i">+        var selectedSnapchatVersion by remember { mutableStateOf(null as DownloadItem?) }
</a><a href="#h13-7-8" id="h13-7-8" class="i">+        val installedSnapEnhanceVersion = remember { runCatching { activity.packageManager.getPackageInfo(
</a><a href="#h13-7-9" id="h13-7-9" class="i">+            sharedConfig.snapEnhancePackageName, 0) }.getOrNull() }
</a><a href="#h13-7-10" id="h13-7-10" class="i">+
</a><a href="#h13-7-11" id="h13-7-11" class="i">+        if (showSelectSnapchatVersionDialog) {
</a><a href="#h13-7-12" id="h13-7-12" class="i">+            AlertDialog(onDismissRequest = { showSelectSnapchatVersionDialog = false }) {
</a><a href="#h13-7-13" id="h13-7-13" class="i">+                SelectSnapchatVersionDialog {
</a><a href="#h13-7-14" id="h13-7-14" class="i">+                    selectedSnapchatVersion = it
</a><a href="#h13-7-15" id="h13-7-15" class="i">+                    showSelectSnapchatVersionDialog = false
</a><a href="#h13-7-16" id="h13-7-16" class="i">+                }
</a><a href="#h13-7-17" id="h13-7-17" class="i">+            }
</a><a href="#h13-7-18" id="h13-7-18" class="i">+        }
</a> 
         Column(
             modifier = Modifier.fillMaxSize(),
<a href="#h13-8" id="h13-8" class="h">@@ -212,39 +164,70 @@ class SnapchatPatchTab : Tab(&quot;snapchat_download_tab&quot;) {
</a>             verticalArrangement = Arrangement.spacedBy(10.dp)
         ) {
             Text(&quot;Select a version to download and patch&quot;)
<a href="#h13-8-3" id="h13-8-3" class="d">-            LazyColumn {
</a><a href="#h13-8-4" id="h13-8-4" class="d">-                items(downloadItems, key = { it.hash }) { item -&gt;
</a><a href="#h13-8-5" id="h13-8-5" class="d">-                    DownloadItemRow(coroutineScope, item)
</a><a href="#h13-8-6" id="h13-8-6" class="i">+
</a><a href="#h13-8-7" id="h13-8-7" class="i">+            ElevatedCard(
</a><a href="#h13-8-8" id="h13-8-8" class="i">+                modifier = Modifier.padding(10.dp),
</a><a href="#h13-8-9" id="h13-8-9" class="i">+            ) {
</a><a href="#h13-8-10" id="h13-8-10" class="i">+                Row(
</a><a href="#h13-8-11" id="h13-8-11" class="i">+                    modifier = Modifier
</a><a href="#h13-8-12" id="h13-8-12" class="i">+                        .fillMaxWidth()
</a><a href="#h13-8-13" id="h13-8-13" class="i">+                        .padding(10.dp),
</a><a href="#h13-8-14" id="h13-8-14" class="i">+                    horizontalArrangement = Arrangement.SpaceBetween,
</a><a href="#h13-8-15" id="h13-8-15" class="i">+                    verticalAlignment = Alignment.CenterVertically
</a><a href="#h13-8-16" id="h13-8-16" class="i">+                ) {
</a><a href="#h13-8-17" id="h13-8-17" class="i">+                    Icon(painter = painterResource(R.drawable.sclogo), contentDescription = null, tint = MaterialTheme.colorScheme.onSurface, modifier = Modifier.size(40.dp))
</a><a href="#h13-8-18" id="h13-8-18" class="i">+                    if (selectedSnapchatVersion == null) {
</a><a href="#h13-8-19" id="h13-8-19" class="i">+                        Text(text = &quot;Snapchat&quot;)
</a><a href="#h13-8-20" id="h13-8-20" class="i">+                    }
</a><a href="#h13-8-21" id="h13-8-21" class="i">+                    Text(text = selectedSnapchatVersion?.shortTitle ?: &quot;Not Selected&quot;)
</a><a href="#h13-8-22" id="h13-8-22" class="i">+                    Button(onClick = { showSelectSnapchatVersionDialog = true }) {
</a><a href="#h13-8-23" id="h13-8-23" class="i">+                        Text(&quot;Choose&quot;)
</a><a href="#h13-8-24" id="h13-8-24" class="i">+                    }
</a><a href="#h13-8-25" id="h13-8-25" class="i">+                }
</a><a href="#h13-8-26" id="h13-8-26" class="i">+            }
</a><a href="#h13-8-27" id="h13-8-27" class="i">+
</a><a href="#h13-8-28" id="h13-8-28" class="i">+            ElevatedCard(
</a><a href="#h13-8-29" id="h13-8-29" class="i">+                modifier = Modifier.padding(10.dp),
</a><a href="#h13-8-30" id="h13-8-30" class="i">+            ) {
</a><a href="#h13-8-31" id="h13-8-31" class="i">+                Row(
</a><a href="#h13-8-32" id="h13-8-32" class="i">+                    modifier = Modifier
</a><a href="#h13-8-33" id="h13-8-33" class="i">+                        .fillMaxWidth()
</a><a href="#h13-8-34" id="h13-8-34" class="i">+                        .padding(20.dp),
</a><a href="#h13-8-35" id="h13-8-35" class="i">+                    horizontalArrangement = Arrangement.SpaceBetween,
</a><a href="#h13-8-36" id="h13-8-36" class="i">+                    verticalAlignment = Alignment.CenterVertically
</a><a href="#h13-8-37" id="h13-8-37" class="i">+                ) {
</a><a href="#h13-8-38" id="h13-8-38" class="i">+                    Text(text = &quot;SnapEnhance&quot;)
</a><a href="#h13-8-39" id="h13-8-39" class="i">+                    Text(text = installedSnapEnhanceVersion?.versionName ?: &quot;Not installed&quot;)
</a>                 }
<a href="#h13-8-41" id="h13-8-41" class="d">-                item {
</a><a href="#h13-8-42" id="h13-8-42" class="d">-                    Box(
</a><a href="#h13-8-43" id="h13-8-43" class="d">-                        modifier = Modifier
</a><a href="#h13-8-44" id="h13-8-44" class="d">-                            .fillMaxWidth()
</a><a href="#h13-8-45" id="h13-8-45" class="d">-                            .padding(20.dp),
</a><a href="#h13-8-46" id="h13-8-46" class="d">-                        contentAlignment = Alignment.Center
</a><a href="#h13-8-47" id="h13-8-47" class="d">-                    ) {
</a><a href="#h13-8-48" id="h13-8-48" class="d">-                        CircularProgressIndicator(modifier = Modifier.alpha(if (isFetching) 1f else 0f))
</a><a href="#h13-8-49" id="h13-8-49" class="i">+            }
</a><a href="#h13-8-50" id="h13-8-50" class="i">+
</a><a href="#h13-8-51" id="h13-8-51" class="i">+            Column(
</a><a href="#h13-8-52" id="h13-8-52" class="i">+                modifier = Modifier.padding(top = 10.dp, bottom = 10.dp, start = 20.dp, end = 20.dp),
</a><a href="#h13-8-53" id="h13-8-53" class="i">+                verticalArrangement = Arrangement.spacedBy(5.dp)
</a><a href="#h13-8-54" id="h13-8-54" class="i">+            ) {
</a><a href="#h13-8-55" id="h13-8-55" class="i">+                Button(
</a><a href="#h13-8-56" id="h13-8-56" class="i">+                    modifier = Modifier.fillMaxWidth(),
</a><a href="#h13-8-57" id="h13-8-57" class="i">+                    enabled = selectedSnapchatVersion != null &amp;&amp; installedSnapEnhanceVersion != null,
</a><a href="#h13-8-58" id="h13-8-58" class="i">+                    onClick = {
</a><a href="#h13-8-59" id="h13-8-59" class="i">+                        navigation.navigateTo(LSPatchTab::class, args = Bundle().apply {
</a><a href="#h13-8-60" id="h13-8-60" class="i">+                            putParcelable(&quot;downloadItem&quot;, selectedSnapchatVersion)
</a><a href="#h13-8-61" id="h13-8-61" class="i">+                            putString(&quot;modulePath&quot;, installedSnapEnhanceVersion?.applicationInfo?.sourceDir)
</a><a href="#h13-8-62" id="h13-8-62" class="i">+                        }, noHistory = true)
</a>                     }
<a href="#h13-8-64" id="h13-8-64" class="d">-                    SideEffect {
</a><a href="#h13-8-65" id="h13-8-65" class="d">-                        if (isFetching) return@SideEffect
</a><a href="#h13-8-66" id="h13-8-66" class="d">-                        isFetching = true
</a><a href="#h13-8-67" id="h13-8-67" class="d">-                        coroutineScope.launch {
</a><a href="#h13-8-68" id="h13-8-68" class="d">-                            runCatching {
</a><a href="#h13-8-69" id="h13-8-69" class="d">-                                withContext(Dispatchers.IO) {
</a><a href="#h13-8-70" id="h13-8-70" class="d">-                                    apkMirror.fetchSnapchatVersions(currentPage)?.let {
</a><a href="#h13-8-71" id="h13-8-71" class="d">-                                        withContext(Dispatchers.Main) {
</a><a href="#h13-8-72" id="h13-8-72" class="d">-                                            cachedDownloadItems.addAll(it)
</a><a href="#h13-8-73" id="h13-8-73" class="d">-                                            downloadItems.addAll(it)
</a><a href="#h13-8-74" id="h13-8-74" class="d">-                                        }
</a><a href="#h13-8-75" id="h13-8-75" class="d">-                                    }
</a><a href="#h13-8-76" id="h13-8-76" class="d">-                                }
</a><a href="#h13-8-77" id="h13-8-77" class="d">-                            }.onFailure {
</a><a href="#h13-8-78" id="h13-8-78" class="d">-                                it.printStackTrace()
</a><a href="#h13-8-79" id="h13-8-79" class="d">-                            }
</a><a href="#h13-8-80" id="h13-8-80" class="d">-                            ++currentPage
</a><a href="#h13-8-81" id="h13-8-81" class="d">-                            isFetching = false
</a><a href="#h13-8-82" id="h13-8-82" class="d">-                        }
</a><a href="#h13-8-83" id="h13-8-83" class="i">+                ) {
</a><a href="#h13-8-84" id="h13-8-84" class="i">+                    Text(&quot;Download &amp; Patch&quot;)
</a><a href="#h13-8-85" id="h13-8-85" class="i">+                }
</a><a href="#h13-8-86" id="h13-8-86" class="i">+
</a><a href="#h13-8-87" id="h13-8-87" class="i">+                Button(
</a><a href="#h13-8-88" id="h13-8-88" class="i">+                    modifier = Modifier.fillMaxWidth(),
</a><a href="#h13-8-89" id="h13-8-89" class="i">+                    enabled = selectedSnapchatVersion != null,
</a><a href="#h13-8-90" id="h13-8-90" class="i">+                    onClick = {
</a><a href="#h13-8-91" id="h13-8-91" class="i">+                        navigation.navigateTo(LSPatchTab::class, args = Bundle().apply {
</a><a href="#h13-8-92" id="h13-8-92" class="i">+                            putParcelable(&quot;downloadItem&quot;, selectedSnapchatVersion)
</a><a href="#h13-8-93" id="h13-8-93" class="i">+                        }, noHistory = true)
</a>                     }
<a href="#h13-8-95" id="h13-8-95" class="i">+                ) {
</a><a href="#h13-8-96" id="h13-8-96" class="i">+                    Text(&quot;Install/Restore Original Snapchat&quot;)
</a>                 }
             }
         }
</pre>
</div>
</body>
</html>
