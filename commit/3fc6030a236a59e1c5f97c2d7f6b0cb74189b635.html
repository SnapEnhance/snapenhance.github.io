<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>refactor: mapping wrapper - rename members - SnapEnhance - An Xposed module offering an enhanced Snapchat experience
</title>
<link rel="icon" type="image/svg+xml" href="../../logo.png"/>
<link rel="alternate icon" href="../../favicon.png"/>
<link rel="alternate" type="application/atom+xml" title="SnapEnhance Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="SnapEnhance Atom Feed (tags)" href="../tags.xml" />
<link rel="stylesheet" type="text/css" href="../../style.css" />
<link rel="stylesheet" type="text/css" href="../../fonts.css" />
</head>
<body>
<div id="head"><table><tr><td><a class="logo" href="../../"><img src="../../logo.png" alt="" width="32" height="32" /></a></td><td><strong>SnapEnhance</strong><span class="desc"> - An Xposed module offering an enhanced Snapchat experience
</span>
</td></tr></table>
<p><a href="../about.html">About</a> | <a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/LICENSE.html">License</a></p>
</div>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/3fc6030a236a59e1c5f97c2d7f6b0cb74189b635.html">3fc6030a236a59e1c5f97c2d7f6b0cb74189b635</a>
<b>parent</b> <a href="../commit/289afce4a5cd27b294fdc3577ce249f4a043e621.html">289afce4a5cd27b294fdc3577ce249f4a043e621</a>
<b>Author:</b> rhunk &lt;<a href="mailto:101876869+rhunk@users.noreply.github.com">101876869+rhunk@users.noreply.github.com</a>&gt;
<b>Date:</b>   Mon,  7 Aug 2023 00:38:20 +0200

refactor: mapping wrapper
- rename members

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">app/src/main/kotlin/me/rhunk/snapenhance/RemoteSideContext.kt</a></td><td> | </td><td class="num">4</td><td><span class="i">++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">core/src/main/kotlin/me/rhunk/snapenhance/ModContext.kt</a></td><td> | </td><td class="num">4</td><td><span class="i">++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h2">core/src/main/kotlin/me/rhunk/snapenhance/SnapEnhance.kt</a></td><td> | </td><td class="num">9</td><td><span class="i">+++++</span><span class="d">----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h3">core/src/main/kotlin/me/rhunk/snapenhance/bridge/wrapper/MappingsWrapper.kt</a></td><td> | </td><td class="num">17</td><td><span class="i">++++++++++++</span><span class="d">-----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h4">core/src/main/kotlin/me/rhunk/snapenhance/data/SnapClassCache.kt</a></td><td> | </td><td class="num">1</td><td><span class="i"></span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h5">core/src/main/kotlin/me/rhunk/snapenhance/database/objects/ConversationMessage.kt</a></td><td> | </td><td class="num">50</td><td><span class="i">++++++++++++++++++++++++++++</span><span class="d">----------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h6">core/src/main/kotlin/me/rhunk/snapenhance/database/objects/FriendFeedInfo.kt</a></td><td> | </td><td class="num">25</td><td><span class="i">+++++++++++++++</span><span class="d">----------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h7">core/src/main/kotlin/me/rhunk/snapenhance/database/objects/FriendInfo.kt</a></td><td> | </td><td class="num">53</td><td><span class="i">+++++++++++++++++++++++++++++</span><span class="d">------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h8">core/src/main/kotlin/me/rhunk/snapenhance/database/objects/StoryEntry.kt</a></td><td> | </td><td class="num">14</td><td><span class="i">+++++++++</span><span class="d">-----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h9">core/src/main/kotlin/me/rhunk/snapenhance/database/objects/UserConversationLink.kt</a></td><td> | </td><td class="num">16</td><td><span class="i">++++++++++</span><span class="d">------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h10">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/MediaDownloader.kt</a></td><td> | </td><td class="num">22</td><td><span class="i">+++++++++++</span><span class="d">-----------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h11">core/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/FriendFeedInfoMenu.kt</a></td><td> | </td><td class="num">12</td><td><span class="i">++++++</span><span class="d">------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h12">core/src/main/kotlin/me/rhunk/snapenhance/util/DbCursorExt.kt</a></td><td> | </td><td class="num">9</td><td><span class="i">+++++++++</span><span class="d"></span></td></tr>
</table></pre><pre>13 files changed, 138 insertions(+), 98 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/RemoteSideContext.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/RemoteSideContext.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/RemoteSideContext.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/RemoteSideContext.kt</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -28,7 +28,7 @@ class RemoteSideContext(
</a> 
     val config = ModConfig()
     val translation = LocaleWrapper()
<a href="#h0-0-3" id="h0-0-3" class="d">-    val mappings = MappingsWrapper(androidContext)
</a><a href="#h0-0-4" id="h0-0-4" class="i">+    val mappings = MappingsWrapper()
</a>     val downloadTaskManager = DownloadTaskManager()
 
     init {
<a href="#h0-1" id="h0-1" class="h">@@ -38,7 +38,7 @@ class RemoteSideContext(
</a>             translation.loadFromContext(androidContext)
             mappings.apply {
                 loadFromContext(androidContext)
<a href="#h0-1-3" id="h0-1-3" class="d">-                init()
</a><a href="#h0-1-4" id="h0-1-4" class="i">+                init(androidContext)
</a>             }
             downloadTaskManager.init(androidContext)
         }.onFailure {
<b>diff --git a/<a id="h1" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/ModContext.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/ModContext.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/ModContext.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/ModContext.kt</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -13,6 +13,7 @@ import com.google.gson.GsonBuilder
</a> import kotlinx.coroutines.asCoroutineDispatcher
 import me.rhunk.snapenhance.bridge.BridgeClient
 import me.rhunk.snapenhance.bridge.wrapper.LocaleWrapper
<a href="#h1-0-3" id="h1-0-3" class="i">+import me.rhunk.snapenhance.bridge.wrapper.MappingsWrapper
</a> import me.rhunk.snapenhance.core.config.ModConfig
 import me.rhunk.snapenhance.core.eventbus.EventBus
 import me.rhunk.snapenhance.data.MessageSender
<a href="#h1-1" id="h1-1" class="h">@@ -20,7 +21,6 @@ import me.rhunk.snapenhance.database.DatabaseAccess
</a> import me.rhunk.snapenhance.features.Feature
 import me.rhunk.snapenhance.manager.impl.ActionManager
 import me.rhunk.snapenhance.manager.impl.FeatureManager
<a href="#h1-1-3" id="h1-1-3" class="d">-import me.rhunk.snapenhance.manager.impl.MappingManager
</a> import me.rhunk.snapenhance.util.download.DownloadServer
 import java.util.concurrent.ExecutorService
 import java.util.concurrent.Executors
<a href="#h1-2" id="h1-2" class="h">@@ -47,7 +47,7 @@ class ModContext {
</a> 
     val translation = LocaleWrapper()
     val features = FeatureManager(this)
<a href="#h1-2-3" id="h1-2-3" class="d">-    val mappings = MappingManager(this)
</a><a href="#h1-2-4" id="h1-2-4" class="i">+    val mappings = MappingsWrapper()
</a>     val actionManager = ActionManager(this)
     val database = DatabaseAccess(this)
     val downloadServer = DownloadServer()
<b>diff --git a/<a id="h2" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/SnapEnhance.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/SnapEnhance.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/SnapEnhance.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/SnapEnhance.kt</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -66,7 +66,7 @@ class SnapEnhance {
</a>             if (!activity.packageName.equals(Constants.SNAPCHAT_PACKAGE_NAME)) return@hook
             val isMainActivityNotNull = appContext.mainActivity != null
             appContext.mainActivity = activity
<a href="#h2-0-3" id="h2-0-3" class="d">-            if (isMainActivityNotNull || !appContext.mappings.areMappingsLoaded) return@hook
</a><a href="#h2-0-4" id="h2-0-4" class="i">+            if (isMainActivityNotNull || !appContext.mappings.isMappingsLoaded()) return@hook
</a>             onActivityCreate()
         }
 
<a href="#h2-1" id="h2-1" class="h">@@ -95,13 +95,14 @@ class SnapEnhance {
</a>                 reloadConfig()
                 withContext(appContext.coroutineDispatcher) {
                     translation.userLocale = getConfigLocale()
<a href="#h2-1-3" id="h2-1-3" class="d">-                    translation.loadFromBridge(appContext.bridgeClient)
</a><a href="#h2-1-4" id="h2-1-4" class="i">+                    translation.loadFromBridge(bridgeClient)
</a>                 }
 
<a href="#h2-1-7" id="h2-1-7" class="d">-                mappings.init()
</a><a href="#h2-1-8" id="h2-1-8" class="i">+                mappings.loadFromBridge(bridgeClient)
</a><a href="#h2-1-9" id="h2-1-9" class="i">+                mappings.init(androidContext)
</a>                 eventDispatcher.init()
                 //if mappings aren&#39;t loaded, we can&#39;t initialize features
<a href="#h2-1-12" id="h2-1-12" class="d">-                if (!mappings.areMappingsLoaded) return
</a><a href="#h2-1-13" id="h2-1-13" class="i">+                if (!mappings.isMappingsLoaded()) return
</a>                 features.init()
             }
         }.also { time -&gt;
<b>diff --git a/<a id="h3" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/bridge/wrapper/MappingsWrapper.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/bridge/wrapper/MappingsWrapper.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/bridge/wrapper/MappingsWrapper.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/bridge/wrapper/MappingsWrapper.kt</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -11,6 +11,7 @@ import me.rhunk.snapenhance.bridge.types.BridgeFileType
</a> import me.rhunk.snapmapper.Mapper
 import me.rhunk.snapmapper.impl.BCryptClassMapper
 import me.rhunk.snapmapper.impl.CallbackMapper
<a href="#h3-0-3" id="h3-0-3" class="i">+import me.rhunk.snapmapper.impl.CompositeConfigurationProviderMapper
</a> import me.rhunk.snapmapper.impl.DefaultMediaItemMapper
 import me.rhunk.snapmapper.impl.EnumMapper
 import me.rhunk.snapmapper.impl.FriendsFeedEventDispatcherMapper
<a href="#h3-1" id="h3-1" class="h">@@ -19,13 +20,12 @@ import me.rhunk.snapmapper.impl.OperaPageViewControllerMapper
</a> import me.rhunk.snapmapper.impl.PlatformAnalyticsCreatorMapper
 import me.rhunk.snapmapper.impl.PlusSubscriptionMapper
 import me.rhunk.snapmapper.impl.ScCameraSettingsMapper
<a href="#h3-1-3" id="h3-1-3" class="i">+import me.rhunk.snapmapper.impl.ScoreUpdateMapper
</a> import me.rhunk.snapmapper.impl.StoryBoostStateMapper
 import java.util.concurrent.ConcurrentHashMap
 import kotlin.system.measureTimeMillis
 
<a href="#h3-1-8" id="h3-1-8" class="d">-class MappingsWrapper(
</a><a href="#h3-1-9" id="h3-1-9" class="d">-    private val context: Context,
</a><a href="#h3-1-10" id="h3-1-10" class="d">-) : FileLoaderWrapper(BridgeFileType.MAPPINGS, &quot;{}&quot;.toByteArray(Charsets.UTF_8)) {
</a><a href="#h3-1-11" id="h3-1-11" class="i">+class MappingsWrapper : FileLoaderWrapper(BridgeFileType.MAPPINGS, &quot;{}&quot;.toByteArray(Charsets.UTF_8)) {
</a>     companion object {
         private val gson = GsonBuilder().setPrettyPrinting().create()
         private val mappers = arrayOf(
<a href="#h3-2" id="h3-2" class="h">@@ -39,14 +39,19 @@ class MappingsWrapper(
</a>             PlusSubscriptionMapper::class,
             ScCameraSettingsMapper::class,
             StoryBoostStateMapper::class,
<a href="#h3-2-3" id="h3-2-3" class="d">-            FriendsFeedEventDispatcherMapper::class
</a><a href="#h3-2-4" id="h3-2-4" class="i">+            FriendsFeedEventDispatcherMapper::class,
</a><a href="#h3-2-5" id="h3-2-5" class="i">+            CompositeConfigurationProviderMapper::class,
</a><a href="#h3-2-6" id="h3-2-6" class="i">+            ScoreUpdateMapper::class
</a>         )
     }
 
<a href="#h3-2-10" id="h3-2-10" class="i">+    private lateinit var context: Context
</a><a href="#h3-2-11" id="h3-2-11" class="i">+
</a>     private val mappings = ConcurrentHashMap&lt;String, Any&gt;()
     private var snapBuildNumber: Long = 0
 
<a href="#h3-2-15" id="h3-2-15" class="d">-    fun init() {
</a><a href="#h3-2-16" id="h3-2-16" class="i">+    fun init(context: Context) {
</a><a href="#h3-2-17" id="h3-2-17" class="i">+        this.context = context
</a>         snapBuildNumber = getSnapchatVersionCode()
 
         if (isFileExists()) {
<a href="#h3-3" id="h3-3" class="h">@@ -56,6 +61,8 @@ class MappingsWrapper(
</a>                 Logger.error(&quot;Failed to load cached mappings&quot;, it)
                 delete()
             }
<a href="#h3-3-3" id="h3-3-3" class="i">+        } else {
</a><a href="#h3-3-4" id="h3-3-4" class="i">+            Logger.debug(&quot;Mappings file does not exist&quot;)
</a>         }
     }
 
<b>diff --git a/<a id="h4" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/data/SnapClassCache.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/data/SnapClassCache.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/data/SnapClassCache.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/data/SnapClassCache.kt</a></b>
<a href="#h4-0" id="h4-0" class="h">@@ -4,7 +4,6 @@ class SnapClassCache (
</a>     private val classLoader: ClassLoader
 ) {
     val snapUUID by lazy { findClass(&quot;com.snapchat.client.messaging.UUID&quot;) }
<a href="#h4-0-3" id="h4-0-3" class="d">-    val composerLocalSubscriptionStore by lazy { findClass(&quot;com.snap.plus.lib.common.ComposerLocalSubscriptionStore&quot;) }
</a>     val snapManager by lazy { findClass(&quot;com.snapchat.client.messaging.SnapManager\$CppProxy&quot;) }
     val conversationManager by lazy { findClass(&quot;com.snapchat.client.messaging.ConversationManager\$CppProxy&quot;) }
     val presenceSession by lazy { findClass(&quot;com.snapchat.talkcorev3.PresenceSession\$CppProxy&quot;) }
<b>diff --git a/<a id="h5" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/database/objects/ConversationMessage.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/database/objects/ConversationMessage.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/database/objects/ConversationMessage.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/database/objects/ConversationMessage.kt</a></b>
<a href="#h5-0" id="h5-0" class="h">@@ -5,39 +5,45 @@ import android.database.Cursor
</a> import me.rhunk.snapenhance.Constants
 import me.rhunk.snapenhance.data.ContentType
 import me.rhunk.snapenhance.database.DatabaseObject
<a href="#h5-0-3" id="h5-0-3" class="i">+import me.rhunk.snapenhance.util.getBlobOrNull
</a><a href="#h5-0-4" id="h5-0-4" class="i">+import me.rhunk.snapenhance.util.getInteger
</a><a href="#h5-0-5" id="h5-0-5" class="i">+import me.rhunk.snapenhance.util.getLong
</a><a href="#h5-0-6" id="h5-0-6" class="i">+import me.rhunk.snapenhance.util.getStringOrNull
</a> import me.rhunk.snapenhance.util.protobuf.ProtoReader
 
 @Suppress(&quot;ArrayInDataClass&quot;)
 data class ConversationMessage(
<a href="#h5-0-11" id="h5-0-11" class="d">-    var client_conversation_id: String? = null,
</a><a href="#h5-0-12" id="h5-0-12" class="d">-    var client_message_id: Int = 0,
</a><a href="#h5-0-13" id="h5-0-13" class="d">-    var server_message_id: Int = 0,
</a><a href="#h5-0-14" id="h5-0-14" class="d">-    var message_content: ByteArray? = null,
</a><a href="#h5-0-15" id="h5-0-15" class="d">-    var is_saved: Int = 0,
</a><a href="#h5-0-16" id="h5-0-16" class="d">-    var is_viewed_by_user: Int = 0,
</a><a href="#h5-0-17" id="h5-0-17" class="d">-    var content_type: Int = 0,
</a><a href="#h5-0-18" id="h5-0-18" class="d">-    var creation_timestamp: Long = 0,
</a><a href="#h5-0-19" id="h5-0-19" class="d">-    var read_timestamp: Long = 0,
</a><a href="#h5-0-20" id="h5-0-20" class="d">-    var sender_id: String? = null
</a><a href="#h5-0-21" id="h5-0-21" class="i">+    var clientConversationId: String? = null,
</a><a href="#h5-0-22" id="h5-0-22" class="i">+    var clientMessageId: Int = 0,
</a><a href="#h5-0-23" id="h5-0-23" class="i">+    var serverMessageId: Int = 0,
</a><a href="#h5-0-24" id="h5-0-24" class="i">+    var messageContent: ByteArray? = null,
</a><a href="#h5-0-25" id="h5-0-25" class="i">+    var isSaved: Int = 0,
</a><a href="#h5-0-26" id="h5-0-26" class="i">+    var isViewedByUser: Int = 0,
</a><a href="#h5-0-27" id="h5-0-27" class="i">+    var contentType: Int = 0,
</a><a href="#h5-0-28" id="h5-0-28" class="i">+    var creationTimestamp: Long = 0,
</a><a href="#h5-0-29" id="h5-0-29" class="i">+    var readTimestamp: Long = 0,
</a><a href="#h5-0-30" id="h5-0-30" class="i">+    var senderId: String? = null
</a> ) : DatabaseObject {
 
     @SuppressLint(&quot;Range&quot;)
     override fun write(cursor: Cursor) {
<a href="#h5-0-35" id="h5-0-35" class="d">-        client_conversation_id = cursor.getString(cursor.getColumnIndex(&quot;client_conversation_id&quot;))
</a><a href="#h5-0-36" id="h5-0-36" class="d">-        client_message_id = cursor.getInt(cursor.getColumnIndex(&quot;client_message_id&quot;))
</a><a href="#h5-0-37" id="h5-0-37" class="d">-        server_message_id = cursor.getInt(cursor.getColumnIndex(&quot;server_message_id&quot;))
</a><a href="#h5-0-38" id="h5-0-38" class="d">-        message_content = cursor.getBlob(cursor.getColumnIndex(&quot;message_content&quot;))
</a><a href="#h5-0-39" id="h5-0-39" class="d">-        is_saved = cursor.getInt(cursor.getColumnIndex(&quot;is_saved&quot;))
</a><a href="#h5-0-40" id="h5-0-40" class="d">-        is_viewed_by_user = cursor.getInt(cursor.getColumnIndex(&quot;is_viewed_by_user&quot;))
</a><a href="#h5-0-41" id="h5-0-41" class="d">-        content_type = cursor.getInt(cursor.getColumnIndex(&quot;content_type&quot;))
</a><a href="#h5-0-42" id="h5-0-42" class="d">-        creation_timestamp = cursor.getLong(cursor.getColumnIndex(&quot;creation_timestamp&quot;))
</a><a href="#h5-0-43" id="h5-0-43" class="d">-        read_timestamp = cursor.getLong(cursor.getColumnIndex(&quot;read_timestamp&quot;))
</a><a href="#h5-0-44" id="h5-0-44" class="d">-        sender_id = cursor.getString(cursor.getColumnIndex(&quot;sender_id&quot;))
</a><a href="#h5-0-45" id="h5-0-45" class="i">+        with(cursor) {
</a><a href="#h5-0-46" id="h5-0-46" class="i">+            clientConversationId = getStringOrNull(&quot;client_conversation_id&quot;)
</a><a href="#h5-0-47" id="h5-0-47" class="i">+            clientMessageId = getInteger(&quot;client_message_id&quot;)
</a><a href="#h5-0-48" id="h5-0-48" class="i">+            serverMessageId = getInteger(&quot;server_message_id&quot;)
</a><a href="#h5-0-49" id="h5-0-49" class="i">+            messageContent = getBlobOrNull(&quot;message_content&quot;)
</a><a href="#h5-0-50" id="h5-0-50" class="i">+            isSaved = getInteger(&quot;is_saved&quot;)
</a><a href="#h5-0-51" id="h5-0-51" class="i">+            isViewedByUser = getInteger(&quot;is_viewed_by_user&quot;)
</a><a href="#h5-0-52" id="h5-0-52" class="i">+            contentType = getInteger(&quot;content_type&quot;)
</a><a href="#h5-0-53" id="h5-0-53" class="i">+            creationTimestamp = getLong(&quot;creation_timestamp&quot;)
</a><a href="#h5-0-54" id="h5-0-54" class="i">+            readTimestamp = getLong(&quot;read_timestamp&quot;)
</a><a href="#h5-0-55" id="h5-0-55" class="i">+            senderId = getStringOrNull(&quot;sender_id&quot;)
</a><a href="#h5-0-56" id="h5-0-56" class="i">+        }
</a>     }
 
     fun getMessageAsString(): String? {
<a href="#h5-0-60" id="h5-0-60" class="d">-        return when (ContentType.fromId(content_type)) {
</a><a href="#h5-0-61" id="h5-0-61" class="d">-            ContentType.CHAT -&gt; message_content?.let { ProtoReader(it).getString(*Constants.ARROYO_STRING_CHAT_MESSAGE_PROTO) }
</a><a href="#h5-0-62" id="h5-0-62" class="i">+        return when (ContentType.fromId(contentType)) {
</a><a href="#h5-0-63" id="h5-0-63" class="i">+            ContentType.CHAT -&gt; messageContent?.let { ProtoReader(it).getString(*Constants.ARROYO_STRING_CHAT_MESSAGE_PROTO) }
</a>             else -&gt; null
         }
     }
<b>diff --git a/<a id="h6" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/database/objects/FriendFeedInfo.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/database/objects/FriendFeedInfo.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/database/objects/FriendFeedInfo.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/database/objects/FriendFeedInfo.kt</a></b>
<a href="#h6-0" id="h6-0" class="h">@@ -3,6 +3,9 @@ package me.rhunk.snapenhance.database.objects
</a> import android.annotation.SuppressLint
 import android.database.Cursor
 import me.rhunk.snapenhance.database.DatabaseObject
<a href="#h6-0-3" id="h6-0-3" class="i">+import me.rhunk.snapenhance.util.getInteger
</a><a href="#h6-0-4" id="h6-0-4" class="i">+import me.rhunk.snapenhance.util.getLong
</a><a href="#h6-0-5" id="h6-0-5" class="i">+import me.rhunk.snapenhance.util.getStringOrNull
</a> 
 data class FriendFeedInfo(
     var id: Int = 0,
<a href="#h6-1" id="h6-1" class="h">@@ -19,15 +22,17 @@ data class FriendFeedInfo(
</a> 
     @SuppressLint(&quot;Range&quot;)
     override fun write(cursor: Cursor) {
<a href="#h6-1-3" id="h6-1-3" class="d">-        id = cursor.getInt(cursor.getColumnIndex(&quot;_id&quot;))
</a><a href="#h6-1-4" id="h6-1-4" class="d">-        feedDisplayName = cursor.getString(cursor.getColumnIndex(&quot;feedDisplayName&quot;))
</a><a href="#h6-1-5" id="h6-1-5" class="d">-        participantsSize = cursor.getInt(cursor.getColumnIndex(&quot;participantsSize&quot;))
</a><a href="#h6-1-6" id="h6-1-6" class="d">-        lastInteractionTimestamp = cursor.getLong(cursor.getColumnIndex(&quot;lastInteractionTimestamp&quot;))
</a><a href="#h6-1-7" id="h6-1-7" class="d">-        displayTimestamp = cursor.getLong(cursor.getColumnIndex(&quot;displayTimestamp&quot;))
</a><a href="#h6-1-8" id="h6-1-8" class="d">-        displayInteractionType = cursor.getString(cursor.getColumnIndex(&quot;displayInteractionType&quot;))
</a><a href="#h6-1-9" id="h6-1-9" class="d">-        lastInteractionUserId = cursor.getInt(cursor.getColumnIndex(&quot;lastInteractionUserId&quot;))
</a><a href="#h6-1-10" id="h6-1-10" class="d">-        key = cursor.getString(cursor.getColumnIndex(&quot;key&quot;))
</a><a href="#h6-1-11" id="h6-1-11" class="d">-        friendUserId = cursor.getString(cursor.getColumnIndex(&quot;friendUserId&quot;))
</a><a href="#h6-1-12" id="h6-1-12" class="d">-        friendDisplayName = cursor.getString(cursor.getColumnIndex(&quot;friendDisplayUsername&quot;))
</a><a href="#h6-1-13" id="h6-1-13" class="i">+        with(cursor) {
</a><a href="#h6-1-14" id="h6-1-14" class="i">+            id = getInteger(&quot;_id&quot;)
</a><a href="#h6-1-15" id="h6-1-15" class="i">+            feedDisplayName = getStringOrNull(&quot;feedDisplayName&quot;)
</a><a href="#h6-1-16" id="h6-1-16" class="i">+            participantsSize = getInteger(&quot;participantsSize&quot;)
</a><a href="#h6-1-17" id="h6-1-17" class="i">+            lastInteractionTimestamp = getLong(&quot;lastInteractionTimestamp&quot;)
</a><a href="#h6-1-18" id="h6-1-18" class="i">+            displayTimestamp = getLong(&quot;displayTimestamp&quot;)
</a><a href="#h6-1-19" id="h6-1-19" class="i">+            displayInteractionType = getStringOrNull(&quot;displayInteractionType&quot;)
</a><a href="#h6-1-20" id="h6-1-20" class="i">+            lastInteractionUserId = getInteger(&quot;lastInteractionUserId&quot;)
</a><a href="#h6-1-21" id="h6-1-21" class="i">+            key = getStringOrNull(&quot;key&quot;)
</a><a href="#h6-1-22" id="h6-1-22" class="i">+            friendUserId = getStringOrNull(&quot;friendUserId&quot;)
</a><a href="#h6-1-23" id="h6-1-23" class="i">+            friendDisplayName = getStringOrNull(&quot;friendDisplayUsername&quot;)
</a><a href="#h6-1-24" id="h6-1-24" class="i">+        }
</a>     }
 }
<b>diff --git a/<a id="h7" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/database/objects/FriendInfo.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/database/objects/FriendInfo.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/database/objects/FriendInfo.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/database/objects/FriendInfo.kt</a></b>
<a href="#h7-0" id="h7-0" class="h">@@ -3,6 +3,9 @@ package me.rhunk.snapenhance.database.objects
</a> import android.annotation.SuppressLint
 import android.database.Cursor
 import me.rhunk.snapenhance.database.DatabaseObject
<a href="#h7-0-3" id="h7-0-3" class="i">+import me.rhunk.snapenhance.util.getInteger
</a><a href="#h7-0-4" id="h7-0-4" class="i">+import me.rhunk.snapenhance.util.getLong
</a><a href="#h7-0-5" id="h7-0-5" class="i">+import me.rhunk.snapenhance.util.getStringOrNull
</a> 
 data class FriendInfo(
     var id: Int = 0,
<a href="#h7-1" id="h7-1" class="h">@@ -30,29 +33,31 @@ data class FriendInfo(
</a> ) : DatabaseObject {
     @SuppressLint(&quot;Range&quot;)
     override fun write(cursor: Cursor) {
<a href="#h7-1-3" id="h7-1-3" class="d">-        id = cursor.getInt(cursor.getColumnIndex(&quot;_id&quot;))
</a><a href="#h7-1-4" id="h7-1-4" class="d">-        lastModifiedTimestamp = cursor.getLong(cursor.getColumnIndex(&quot;_lastModifiedTimestamp&quot;))
</a><a href="#h7-1-5" id="h7-1-5" class="d">-        username = cursor.getString(cursor.getColumnIndex(&quot;username&quot;))
</a><a href="#h7-1-6" id="h7-1-6" class="d">-        userId = cursor.getString(cursor.getColumnIndex(&quot;userId&quot;))
</a><a href="#h7-1-7" id="h7-1-7" class="d">-        displayName = cursor.getString(cursor.getColumnIndex(&quot;displayName&quot;))
</a><a href="#h7-1-8" id="h7-1-8" class="d">-        bitmojiAvatarId = cursor.getString(cursor.getColumnIndex(&quot;bitmojiAvatarId&quot;))
</a><a href="#h7-1-9" id="h7-1-9" class="d">-        bitmojiSelfieId = cursor.getString(cursor.getColumnIndex(&quot;bitmojiSelfieId&quot;))
</a><a href="#h7-1-10" id="h7-1-10" class="d">-        bitmojiSceneId = cursor.getString(cursor.getColumnIndex(&quot;bitmojiSceneId&quot;))
</a><a href="#h7-1-11" id="h7-1-11" class="d">-        bitmojiBackgroundId = cursor.getString(cursor.getColumnIndex(&quot;bitmojiBackgroundId&quot;))
</a><a href="#h7-1-12" id="h7-1-12" class="d">-        friendmojis = cursor.getString(cursor.getColumnIndex(&quot;friendmojis&quot;))
</a><a href="#h7-1-13" id="h7-1-13" class="d">-        friendmojiCategories = cursor.getString(cursor.getColumnIndex(&quot;friendmojiCategories&quot;))
</a><a href="#h7-1-14" id="h7-1-14" class="d">-        snapScore = cursor.getInt(cursor.getColumnIndex(&quot;score&quot;))
</a><a href="#h7-1-15" id="h7-1-15" class="d">-        birthday = cursor.getLong(cursor.getColumnIndex(&quot;birthday&quot;))
</a><a href="#h7-1-16" id="h7-1-16" class="d">-        addedTimestamp = cursor.getLong(cursor.getColumnIndex(&quot;addedTimestamp&quot;))
</a><a href="#h7-1-17" id="h7-1-17" class="d">-        reverseAddedTimestamp = cursor.getLong(cursor.getColumnIndex(&quot;reverseAddedTimestamp&quot;))
</a><a href="#h7-1-18" id="h7-1-18" class="d">-        serverDisplayName = cursor.getString(cursor.getColumnIndex(&quot;serverDisplayName&quot;))
</a><a href="#h7-1-19" id="h7-1-19" class="d">-        streakLength = cursor.getInt(cursor.getColumnIndex(&quot;streakLength&quot;))
</a><a href="#h7-1-20" id="h7-1-20" class="d">-        streakExpirationTimestamp = cursor.getLong(cursor.getColumnIndex(&quot;streakExpiration&quot;))
</a><a href="#h7-1-21" id="h7-1-21" class="d">-        reverseBestFriendRanking = cursor.getInt(cursor.getColumnIndex(&quot;reverseBestFriendRanking&quot;))
</a><a href="#h7-1-22" id="h7-1-22" class="d">-        usernameForSorting = cursor.getString(cursor.getColumnIndex(&quot;usernameForSorting&quot;))
</a><a href="#h7-1-23" id="h7-1-23" class="d">-        if (cursor.getColumnIndex(&quot;isPinnedBestFriend&quot;) != -1) isPinnedBestFriend =
</a><a href="#h7-1-24" id="h7-1-24" class="d">-            cursor.getInt(cursor.getColumnIndex(&quot;isPinnedBestFriend&quot;))
</a><a href="#h7-1-25" id="h7-1-25" class="d">-        if (cursor.getColumnIndex(&quot;plusBadgeVisibility&quot;) != -1) plusBadgeVisibility =
</a><a href="#h7-1-26" id="h7-1-26" class="d">-            cursor.getInt(cursor.getColumnIndex(&quot;plusBadgeVisibility&quot;))
</a><a href="#h7-1-27" id="h7-1-27" class="i">+        with(cursor) {
</a><a href="#h7-1-28" id="h7-1-28" class="i">+            id = getInteger(&quot;_id&quot;)
</a><a href="#h7-1-29" id="h7-1-29" class="i">+            lastModifiedTimestamp = getLong(&quot;_lastModifiedTimestamp&quot;)
</a><a href="#h7-1-30" id="h7-1-30" class="i">+            username = getStringOrNull(&quot;username&quot;)
</a><a href="#h7-1-31" id="h7-1-31" class="i">+            userId = getStringOrNull(&quot;userId&quot;)
</a><a href="#h7-1-32" id="h7-1-32" class="i">+            displayName = getStringOrNull(&quot;displayName&quot;)
</a><a href="#h7-1-33" id="h7-1-33" class="i">+            bitmojiAvatarId = getStringOrNull(&quot;bitmojiAvatarId&quot;)
</a><a href="#h7-1-34" id="h7-1-34" class="i">+            bitmojiSelfieId = getStringOrNull(&quot;bitmojiSelfieId&quot;)
</a><a href="#h7-1-35" id="h7-1-35" class="i">+            bitmojiSceneId = getStringOrNull(&quot;bitmojiSceneId&quot;)
</a><a href="#h7-1-36" id="h7-1-36" class="i">+            bitmojiBackgroundId = getStringOrNull(&quot;bitmojiBackgroundId&quot;)
</a><a href="#h7-1-37" id="h7-1-37" class="i">+            friendmojis = getStringOrNull(&quot;friendmojis&quot;)
</a><a href="#h7-1-38" id="h7-1-38" class="i">+            friendmojiCategories = getStringOrNull(&quot;friendmojiCategories&quot;)
</a><a href="#h7-1-39" id="h7-1-39" class="i">+            snapScore = getInteger(&quot;score&quot;)
</a><a href="#h7-1-40" id="h7-1-40" class="i">+            birthday = getLong(&quot;birthday&quot;)
</a><a href="#h7-1-41" id="h7-1-41" class="i">+            addedTimestamp = getLong(&quot;addedTimestamp&quot;)
</a><a href="#h7-1-42" id="h7-1-42" class="i">+            reverseAddedTimestamp = getLong(&quot;reverseAddedTimestamp&quot;)
</a><a href="#h7-1-43" id="h7-1-43" class="i">+            serverDisplayName = getStringOrNull(&quot;serverDisplayName&quot;)
</a><a href="#h7-1-44" id="h7-1-44" class="i">+            streakLength = getInteger(&quot;streakLength&quot;)
</a><a href="#h7-1-45" id="h7-1-45" class="i">+            streakExpirationTimestamp = getLong(&quot;streakExpiration&quot;)
</a><a href="#h7-1-46" id="h7-1-46" class="i">+            reverseBestFriendRanking = getInteger(&quot;reverseBestFriendRanking&quot;)
</a><a href="#h7-1-47" id="h7-1-47" class="i">+            usernameForSorting = getStringOrNull(&quot;usernameForSorting&quot;)
</a><a href="#h7-1-48" id="h7-1-48" class="i">+            if (getColumnIndex(&quot;isPinnedBestFriend&quot;) != -1) isPinnedBestFriend =
</a><a href="#h7-1-49" id="h7-1-49" class="i">+                getInteger(&quot;isPinnedBestFriend&quot;)
</a><a href="#h7-1-50" id="h7-1-50" class="i">+            if (getColumnIndex(&quot;plusBadgeVisibility&quot;) != -1) plusBadgeVisibility =
</a><a href="#h7-1-51" id="h7-1-51" class="i">+                getInteger(&quot;plusBadgeVisibility&quot;)
</a><a href="#h7-1-52" id="h7-1-52" class="i">+        }
</a>     }
 }
<b>diff --git a/<a id="h8" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/database/objects/StoryEntry.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/database/objects/StoryEntry.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/database/objects/StoryEntry.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/database/objects/StoryEntry.kt</a></b>
<a href="#h8-0" id="h8-0" class="h">@@ -3,6 +3,8 @@ package me.rhunk.snapenhance.database.objects
</a> import android.annotation.SuppressLint
 import android.database.Cursor
 import me.rhunk.snapenhance.database.DatabaseObject
<a href="#h8-0-3" id="h8-0-3" class="i">+import me.rhunk.snapenhance.util.getInteger
</a><a href="#h8-0-4" id="h8-0-4" class="i">+import me.rhunk.snapenhance.util.getStringOrNull
</a> 
 data class StoryEntry(
     var id: Int = 0,
<a href="#h8-1" id="h8-1" class="h">@@ -14,10 +16,12 @@ data class StoryEntry(
</a> 
     @SuppressLint(&quot;Range&quot;)
     override fun write(cursor: Cursor) {
<a href="#h8-1-3" id="h8-1-3" class="d">-        id = cursor.getInt(cursor.getColumnIndex(&quot;_id&quot;))
</a><a href="#h8-1-4" id="h8-1-4" class="d">-        storyId = cursor.getString(cursor.getColumnIndex(&quot;storyId&quot;))
</a><a href="#h8-1-5" id="h8-1-5" class="d">-        displayName = cursor.getString(cursor.getColumnIndex(&quot;displayName&quot;))
</a><a href="#h8-1-6" id="h8-1-6" class="d">-        isLocal = cursor.getInt(cursor.getColumnIndex(&quot;isLocal&quot;)) == 1
</a><a href="#h8-1-7" id="h8-1-7" class="d">-        userId = cursor.getString(cursor.getColumnIndex(&quot;userId&quot;))
</a><a href="#h8-1-8" id="h8-1-8" class="i">+        with(cursor) {
</a><a href="#h8-1-9" id="h8-1-9" class="i">+            id = getInteger(&quot;_id&quot;)
</a><a href="#h8-1-10" id="h8-1-10" class="i">+            storyId = getStringOrNull(&quot;storyId&quot;)
</a><a href="#h8-1-11" id="h8-1-11" class="i">+            displayName = getStringOrNull(&quot;displayName&quot;)
</a><a href="#h8-1-12" id="h8-1-12" class="i">+            isLocal = getInteger(&quot;isLocal&quot;) == 1
</a><a href="#h8-1-13" id="h8-1-13" class="i">+            userId = getStringOrNull(&quot;userId&quot;)
</a><a href="#h8-1-14" id="h8-1-14" class="i">+        }
</a>     }
 }
<b>diff --git a/<a id="h9" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/database/objects/UserConversationLink.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/database/objects/UserConversationLink.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/database/objects/UserConversationLink.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/database/objects/UserConversationLink.kt</a></b>
<a href="#h9-0" id="h9-0" class="h">@@ -3,17 +3,21 @@ package me.rhunk.snapenhance.database.objects
</a> import android.annotation.SuppressLint
 import android.database.Cursor
 import me.rhunk.snapenhance.database.DatabaseObject
<a href="#h9-0-3" id="h9-0-3" class="i">+import me.rhunk.snapenhance.util.getInteger
</a><a href="#h9-0-4" id="h9-0-4" class="i">+import me.rhunk.snapenhance.util.getStringOrNull
</a> 
 class UserConversationLink(
<a href="#h9-0-7" id="h9-0-7" class="d">-    var user_id: String? = null,
</a><a href="#h9-0-8" id="h9-0-8" class="d">-    var client_conversation_id: String? = null,
</a><a href="#h9-0-9" id="h9-0-9" class="d">-    var conversation_type: Int = 0
</a><a href="#h9-0-10" id="h9-0-10" class="i">+    var userId: String? = null,
</a><a href="#h9-0-11" id="h9-0-11" class="i">+    var clientConversationId: String? = null,
</a><a href="#h9-0-12" id="h9-0-12" class="i">+    var conversationType: Int = 0
</a> ) : DatabaseObject {
 
     @SuppressLint(&quot;Range&quot;)
     override fun write(cursor: Cursor) {
<a href="#h9-0-17" id="h9-0-17" class="d">-        user_id = cursor.getString(cursor.getColumnIndex(&quot;user_id&quot;))
</a><a href="#h9-0-18" id="h9-0-18" class="d">-        client_conversation_id = cursor.getString(cursor.getColumnIndex(&quot;client_conversation_id&quot;))
</a><a href="#h9-0-19" id="h9-0-19" class="d">-        conversation_type = cursor.getInt(cursor.getColumnIndex(&quot;conversation_type&quot;))
</a><a href="#h9-0-20" id="h9-0-20" class="i">+        with(cursor) {
</a><a href="#h9-0-21" id="h9-0-21" class="i">+            userId = getStringOrNull(&quot;user_id&quot;)
</a><a href="#h9-0-22" id="h9-0-22" class="i">+            clientConversationId = getStringOrNull(&quot;client_conversation_id&quot;)
</a><a href="#h9-0-23" id="h9-0-23" class="i">+            conversationType = getInteger(&quot;conversation_type&quot;)
</a><a href="#h9-0-24" id="h9-0-24" class="i">+        }
</a>     }
 }
<b>diff --git a/<a id="h10" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/MediaDownloader.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/MediaDownloader.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/MediaDownloader.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/MediaDownloader.kt</a></b>
<a href="#h10-0" id="h10-0" class="h">@@ -228,8 +228,8 @@ class MediaDownloader : Feature(&quot;MediaDownloader&quot;, loadParams = FeatureLoadParam
</a>             val messageId = id.substring(id.lastIndexOf(&quot;:&quot;) + 1).toLong()
             val conversationMessage = context.database.getConversationMessageFromId(messageId)!!
 
<a href="#h10-0-3" id="h10-0-3" class="d">-            val senderId = conversationMessage.sender_id!!
</a><a href="#h10-0-4" id="h10-0-4" class="d">-            val conversationId = conversationMessage.client_conversation_id!!
</a><a href="#h10-0-5" id="h10-0-5" class="i">+            val senderId = conversationMessage.senderId!!
</a><a href="#h10-0-6" id="h10-0-6" class="i">+            val conversationId = conversationMessage.clientConversationId!!
</a> 
             if (!forceDownload &amp;&amp; context.feature(AntiAutoDownload::class).isUserIgnored(senderId)) {
                 return
<a href="#h10-1" id="h10-1" class="h">@@ -240,7 +240,7 @@ class MediaDownloader : Feature(&quot;MediaDownloader&quot;, loadParams = FeatureLoadParam
</a> 
             downloadOperaMedia(provideDownloadManagerClient(
                 pathSuffix = authorUsername,
<a href="#h10-1-3" id="h10-1-3" class="d">-                mediaIdentifier = &quot;$conversationId$senderId${conversationMessage.server_message_id}&quot;,
</a><a href="#h10-1-4" id="h10-1-4" class="i">+                mediaIdentifier = &quot;$conversationId$senderId${conversationMessage.serverMessageId}&quot;,
</a>                 mediaDisplaySource = authorUsername,
                 mediaDisplayType = MediaFilter.CHAT_MEDIA.key,
                 friendInfo = author
<a href="#h10-2" id="h10-2" class="h">@@ -266,9 +266,9 @@ class MediaDownloader : Feature(&quot;MediaDownloader&quot;, loadParams = FeatureLoadParam
</a>                     ?.split(&quot;:&quot;)?.getOrNull(2) ?: return@let
 
                 val conversationMessage = context.database.getConversationMessageFromId(arroyoMessageId.toLong()) ?: return@let
<a href="#h10-2-3" id="h10-2-3" class="d">-                val conversationParticipants = context.database.getConversationParticipants(conversationMessage.client_conversation_id.toString()) ?: return@let
</a><a href="#h10-2-4" id="h10-2-4" class="i">+                val conversationParticipants = context.database.getConversationParticipants(conversationMessage.clientConversationId.toString()) ?: return@let
</a> 
<a href="#h10-2-6" id="h10-2-6" class="d">-                conversationParticipants.firstOrNull { it != conversationMessage.sender_id }
</a><a href="#h10-2-7" id="h10-2-7" class="i">+                conversationParticipants.firstOrNull { it != conversationMessage.senderId }
</a>             }
 
             val author = context.database.getFriendInfo(
<a href="#h10-3" id="h10-3" class="h">@@ -421,18 +421,18 @@ class MediaDownloader : Feature(&quot;MediaDownloader&quot;, loadParams = FeatureLoadParam
</a>         val message = context.database.getConversationMessageFromId(messageId) ?: throw Exception(&quot;Message not found in database&quot;)
 
         //get the message author
<a href="#h10-3-3" id="h10-3-3" class="d">-        val friendInfo: FriendInfo = context.database.getFriendInfo(message.sender_id!!) ?: throw Exception(&quot;Friend not found in database&quot;)
</a><a href="#h10-3-4" id="h10-3-4" class="i">+        val friendInfo: FriendInfo = context.database.getFriendInfo(message.senderId!!) ?: throw Exception(&quot;Friend not found in database&quot;)
</a>         val authorName = friendInfo.usernameForSorting!!
 
<a href="#h10-3-7" id="h10-3-7" class="d">-        var messageContent = message.message_content!!
</a><a href="#h10-3-8" id="h10-3-8" class="i">+        var messageContent = message.messageContent!!
</a>         var isArroyoMessage = true
         var deletedMediaReference: ByteArray? = null
 
         //check if the messageId
<a href="#h10-3-13" id="h10-3-13" class="d">-        var contentType: ContentType = ContentType.fromId(message.content_type)
</a><a href="#h10-3-14" id="h10-3-14" class="i">+        var contentType: ContentType = ContentType.fromId(message.contentType)
</a> 
<a href="#h10-3-16" id="h10-3-16" class="d">-        if (messageLogger.isMessageRemoved(message.client_message_id.toLong())) {
</a><a href="#h10-3-17" id="h10-3-17" class="d">-            val messageObject = messageLogger.getMessageObject(message.client_conversation_id!!, message.client_message_id.toLong()) ?: throw Exception(&quot;Message not found in database&quot;)
</a><a href="#h10-3-18" id="h10-3-18" class="i">+        if (messageLogger.isMessageRemoved(message.clientMessageId.toLong())) {
</a><a href="#h10-3-19" id="h10-3-19" class="i">+            val messageObject = messageLogger.getMessageObject(message.clientConversationId!!, message.clientMessageId.toLong()) ?: throw Exception(&quot;Message not found in database&quot;)
</a>             isArroyoMessage = false
             val messageContentObject = messageObject.getAsJsonObject(&quot;mMessageContent&quot;)
 
<a href="#h10-4" id="h10-4" class="h">@@ -474,7 +474,7 @@ class MediaDownloader : Feature(&quot;MediaDownloader&quot;, loadParams = FeatureLoadParam
</a>                 val encryptionKeys = EncryptionHelper.getEncryptionKeys(contentType, messageReader, isArroyo = isArroyoMessage)
                 provideDownloadManagerClient(
                     pathSuffix = authorName,
<a href="#h10-4-3" id="h10-4-3" class="d">-                    mediaIdentifier = &quot;${message.client_conversation_id}${message.sender_id}${message.server_message_id}&quot;,
</a><a href="#h10-4-4" id="h10-4-4" class="i">+                    mediaIdentifier = &quot;${message.clientConversationId}${message.senderId}${message.serverMessageId}&quot;,
</a>                     mediaDisplaySource = authorName,
                     mediaDisplayType = MediaFilter.CHAT_MEDIA.key,
                     friendInfo = friendInfo
<b>diff --git a/<a id="h11" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/FriendFeedInfoMenu.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/FriendFeedInfoMenu.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/FriendFeedInfoMenu.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/FriendFeedInfoMenu.kt</a></b>
<a href="#h11-0" id="h11-0" class="h">@@ -117,12 +117,12 @@ class FriendFeedInfoMenu : AbstractMenu() {
</a>         val messageBuilder = StringBuilder()
 
         messages.forEach{ message: ConversationMessage -&gt;
<a href="#h11-0-3" id="h11-0-3" class="d">-            val sender: FriendInfo? = participants[message.sender_id]
</a><a href="#h11-0-4" id="h11-0-4" class="i">+            val sender: FriendInfo? = participants[message.senderId]
</a> 
<a href="#h11-0-6" id="h11-0-6" class="d">-            var messageString: String = message.getMessageAsString() ?: ContentType.fromId(message.content_type).name
</a><a href="#h11-0-7" id="h11-0-7" class="i">+            var messageString: String = message.getMessageAsString() ?: ContentType.fromId(message.contentType).name
</a> 
<a href="#h11-0-9" id="h11-0-9" class="d">-            if (message.content_type == ContentType.SNAP.id) {
</a><a href="#h11-0-10" id="h11-0-10" class="d">-                val readTimeStamp: Long = message.read_timestamp
</a><a href="#h11-0-11" id="h11-0-11" class="i">+            if (message.contentType == ContentType.SNAP.id) {
</a><a href="#h11-0-12" id="h11-0-12" class="i">+                val readTimeStamp: Long = message.readTimestamp
</a>                 messageString = &quot;\uD83D\uDFE5&quot; //red square
                 if (readTimeStamp &gt; 0) {
                     messageString += &quot; \uD83D\uDC40 &quot; //eyes
<a href="#h11-1" id="h11-1" class="h">@@ -160,7 +160,7 @@ class FriendFeedInfoMenu : AbstractMenu() {
</a>         messages.lastOrNull()?.let {
             messageBuilder
                 .append(&quot;\n\n&quot;)
<a href="#h11-1-3" id="h11-1-3" class="d">-                .append(context.translation.format(&quot;conversation_preview.total_messages&quot;, &quot;count&quot; to it.server_message_id.toString()))
</a><a href="#h11-1-4" id="h11-1-4" class="i">+                .append(context.translation.format(&quot;conversation_preview.total_messages&quot;, &quot;count&quot; to it.serverMessageId.toString()))
</a>                 .append(&quot;\n&quot;)
         }
 
<a href="#h11-2" id="h11-2" class="h">@@ -214,7 +214,7 @@ class FriendFeedInfoMenu : AbstractMenu() {
</a>         //old conversation fetch
         val conversationId = if (messaging.lastFetchConversationUUID == null &amp;&amp; focusedConversationTargetUser != null) {
             val conversation: UserConversationLink = context.database.getDMConversationIdFromUserId(focusedConversationTargetUser) ?: throw IllegalStateException(&quot;No conversation found&quot;)
<a href="#h11-2-3" id="h11-2-3" class="d">-            conversation.client_conversation_id!!.trim().lowercase()
</a><a href="#h11-2-4" id="h11-2-4" class="i">+            conversation.clientConversationId!!.trim().lowercase()
</a>         } else {
             messaging.lastFetchConversationUUID.toString()
         }
<b>diff --git a/<a id="h12" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/util/DbCursorExt.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/util/DbCursorExt.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/util/DbCursorExt.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/util/DbCursorExt.kt</a></b>
<a href="#h12-0" id="h12-0" class="h">@@ -12,6 +12,15 @@ fun Cursor.getIntOrNull(columnName: String): Int? {
</a>     return if (columnIndex == -1) null else getInt(columnIndex)
 }
 
<a href="#h12-0-3" id="h12-0-3" class="i">+fun Cursor.getInteger(columnName: String) = getIntOrNull(columnName) ?: throw NullPointerException(&quot;Column $columnName is null&quot;)
</a><a href="#h12-0-4" id="h12-0-4" class="i">+fun Cursor.getLong(columnName: String) = getLongOrNull(columnName) ?: throw NullPointerException(&quot;Column $columnName is null&quot;)
</a><a href="#h12-0-5" id="h12-0-5" class="i">+
</a><a href="#h12-0-6" id="h12-0-6" class="i">+fun Cursor.getBlobOrNull(columnName: String): ByteArray? {
</a><a href="#h12-0-7" id="h12-0-7" class="i">+    val columnIndex = getColumnIndex(columnName)
</a><a href="#h12-0-8" id="h12-0-8" class="i">+    return if (columnIndex == -1) null else getBlob(columnIndex)
</a><a href="#h12-0-9" id="h12-0-9" class="i">+}
</a><a href="#h12-0-10" id="h12-0-10" class="i">+
</a><a href="#h12-0-11" id="h12-0-11" class="i">+
</a> fun Cursor.getLongOrNull(columnName: String): Long? {
     val columnIndex = getColumnIndex(columnName)
     return if (columnIndex == -1) null else getLong(columnIndex)
</pre>
</div>
</body>
</html>
