<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>feat: chat export (#17) - SnapEnhance - An Xposed module offering an enhanced Snapchat experience
</title>
<link rel="icon" type="image/svg+xml" href="../../logo.png"/>
<link rel="alternate icon" href="../../favicon.png"/>
<link rel="alternate" type="application/atom+xml" title="SnapEnhance Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="SnapEnhance Atom Feed (tags)" href="../tags.xml" />
<link rel="stylesheet" type="text/css" href="../../style.css" />
<link rel="stylesheet" type="text/css" href="../../fonts.css" />
</head>
<body>
<div id="head"><table><tr><td><a class="logo" href="../../"><img src="../../logo.png" alt="" width="32" height="32" /></a></td><td><strong>SnapEnhance</strong><span class="desc"> - An Xposed module offering an enhanced Snapchat experience
</span>
</td></tr></table>
<p><a href="../about.html">About</a> | <a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/LICENSE.html">License</a></p>
</div>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/c0ed3da64eda32753301341364620c42912903c5.html">c0ed3da64eda32753301341364620c42912903c5</a>
<b>parent</b> <a href="../commit/86abe10fa2260dbe10ee9b16082f42851bbec649.html">86abe10fa2260dbe10ee9b16082f42851bbec649</a>
<b>Author:</b> auth &lt;<a href="mailto:64337177+authorisation@users.noreply.github.com">64337177+authorisation@users.noreply.github.com</a>&gt;
<b>Date:</b>   Mon, 19 Jun 2023 21:43:54 +0200

feat: chat export (#17)

Co-authored-by: rhunk &lt;101876869+rhunk@users.noreply.github.com&gt;
<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">app/src/main/assets/lang/en_US.json</a></td><td> | </td><td class="num">20</td><td><span class="i">+++++++++++++++++++</span><span class="d">-</span></td></tr>
<tr><td class="A">A</td><td><a href="#h1">app/src/main/assets/web/export_template.html</a></td><td> | </td><td class="num">254</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h2">app/src/main/assets/web/rawinflate.js</a></td><td> | </td><td class="num">7</td><td><span class="i">+++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h3">app/src/main/kotlin/me/rhunk/snapenhance/action/impl/ExportChatMessages.kt</a></td><td> | </td><td class="num">282</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h4">app/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/MessageMetadata.kt</a></td><td> | </td><td class="num">18</td><td><span class="i">+++++++++++++++++</span><span class="d">-</span></td></tr>
<tr><td class="A">A</td><td><a href="#h5">app/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/UserIdToReaction.kt</a></td><td> | </td><td class="num">12</td><td><span class="i">++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h6">app/src/main/kotlin/me/rhunk/snapenhance/manager/impl/ActionManager.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h7">app/src/main/kotlin/me/rhunk/snapenhance/util/CallbackBuilder.kt</a></td><td> | </td><td class="num">8</td><td><span class="i">++++</span><span class="d">----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h8">app/src/main/kotlin/me/rhunk/snapenhance/util/download/RemoteMediaResolver.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h9">app/src/main/kotlin/me/rhunk/snapenhance/util/export/MessageExporter.kt</a></td><td> | </td><td class="num">337</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h10">app/src/main/kotlin/me/rhunk/snapenhance/util/snap/EncryptionHelper.kt</a></td><td> | </td><td class="num">34</td><td><span class="i">+++++++++++++++</span><span class="d">-------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h11">app/src/main/kotlin/me/rhunk/snapenhance/util/snap/MediaDownloaderHelper.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h12">app/src/main/res/font/avenir_next_medium.ttf</a></td><td> | </td><td class="num">0</td><td><span class="i"></span><span class="d"></span></td></tr>
</table></pre><pre>13 files changed, 952 insertions(+), 26 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/app/src/main/assets/lang/en_US.json.html">app/src/main/assets/lang/en_US.json</a> b/<a href="../file/app/src/main/assets/lang/en_US.json.html">app/src/main/assets/lang/en_US.json</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -13,7 +13,8 @@
</a>         &quot;clear_message_logger&quot;: &quot;Clear Message Logger&quot;,
         &quot;refresh_mappings&quot;: &quot;Refresh Mappings&quot;,
         &quot;open_map&quot;: &quot;Choose location on map&quot;,
<a href="#h0-0-3" id="h0-0-3" class="d">-        &quot;check_for_updates&quot;: &quot;Check for updates&quot;
</a><a href="#h0-0-4" id="h0-0-4" class="i">+        &quot;check_for_updates&quot;: &quot;Check for updates&quot;,
</a><a href="#h0-0-5" id="h0-0-5" class="i">+        &quot;export_chat_messages&quot;: &quot;Export chat messages&quot;
</a>     },
    
     &quot;property&quot;: {
<a href="#h0-1" id="h0-1" class="h">@@ -181,5 +182,22 @@
</a>         &quot;dialog_negative_button&quot;: &quot;Cancel&quot;,
         &quot;downloading_toast&quot;: &quot;Downloading Update...&quot;,
         &quot;download_manager_notification_title&quot;: &quot;Downloading SnapEnhance APK...&quot;
<a href="#h0-1-3" id="h0-1-3" class="i">+    },
</a><a href="#h0-1-4" id="h0-1-4" class="i">+
</a><a href="#h0-1-5" id="h0-1-5" class="i">+    &quot;chat_export&quot;: {
</a><a href="#h0-1-6" id="h0-1-6" class="i">+        &quot;select_export_format&quot;: &quot;Select the Export Format&quot;,
</a><a href="#h0-1-7" id="h0-1-7" class="i">+        &quot;select_media_type&quot;: &quot;Select Media Types to export&quot;,
</a><a href="#h0-1-8" id="h0-1-8" class="i">+        &quot;select_conversation&quot;: &quot;Select a Conversation to export&quot;,
</a><a href="#h0-1-9" id="h0-1-9" class="i">+        &quot;dialog_negative_button&quot;: &quot;Cancel&quot;,
</a><a href="#h0-1-10" id="h0-1-10" class="i">+        &quot;dialog_neutral_button&quot;: &quot;Export All&quot;,
</a><a href="#h0-1-11" id="h0-1-11" class="i">+        &quot;dialog_positive_button&quot;: &quot;Export&quot;,
</a><a href="#h0-1-12" id="h0-1-12" class="i">+        &quot;exported_to&quot;: &quot;Exported to {path}&quot;,
</a><a href="#h0-1-13" id="h0-1-13" class="i">+        &quot;exporting_chats&quot;: &quot;Exporting Chats...&quot;,
</a><a href="#h0-1-14" id="h0-1-14" class="i">+        &quot;processing_chats&quot;: &quot;Processing {amount} conversations...&quot;,
</a><a href="#h0-1-15" id="h0-1-15" class="i">+        &quot;export_fail&quot;: &quot;Failed to export conversation {conversation}&quot;,
</a><a href="#h0-1-16" id="h0-1-16" class="i">+        &quot;writing_output&quot;: &quot;Writing output...&quot;,
</a><a href="#h0-1-17" id="h0-1-17" class="i">+        &quot;finished&quot;: &quot;Done! You now can close this dialog.&quot;,
</a><a href="#h0-1-18" id="h0-1-18" class="i">+        &quot;no_messages_found&quot;: &quot;No messages found!&quot;,
</a><a href="#h0-1-19" id="h0-1-19" class="i">+        &quot;exporting_message&quot;: &quot;Exporting {conversation}...&quot;
</a>     }
 } 
\ No newline at end of file
<b>diff --git a/<a id="h1" href="../file/app/src/main/assets/web/export_template.html.html">app/src/main/assets/web/export_template.html</a> b/<a href="../file/app/src/main/assets/web/export_template.html.html">app/src/main/assets/web/export_template.html</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -0,0 +1,254 @@
</a><a href="#h1-0-0" id="h1-0-0" class="i">+&lt;style&gt;
</a><a href="#h1-0-1" id="h1-0-1" class="i">+    :root {
</a><a href="#h1-0-2" id="h1-0-2" class="i">+        --sigIconPrimary: #dedede;
</a><a href="#h1-0-3" id="h1-0-3" class="i">+        --sigIconSecondary: #999;
</a><a href="#h1-0-4" id="h1-0-4" class="i">+        --sigIconTertiary: #616161;
</a><a href="#h1-0-5" id="h1-0-5" class="i">+        --sigIconNegative: #f23c57;
</a><a href="#h1-0-6" id="h1-0-6" class="i">+        --sigTextPrimary: #dedede;
</a><a href="#h1-0-7" id="h1-0-7" class="i">+        --sigTextPrimaryInverse: #000;
</a><a href="#h1-0-8" id="h1-0-8" class="i">+        --sigTextSecondary: #999;
</a><a href="#h1-0-9" id="h1-0-9" class="i">+        --sigTextTertiary: #616161;
</a><a href="#h1-0-10" id="h1-0-10" class="i">+        --sigTextPlayer: #fff;
</a><a href="#h1-0-11" id="h1-0-11" class="i">+        --sigTextNegative: #f23c57;
</a><a href="#h1-0-12" id="h1-0-12" class="i">+        --sigColorBackgroundBorder: rgba(255, 255, 255, 0.1);
</a><a href="#h1-0-13" id="h1-0-13" class="i">+        --sigBackgroundPrimary: #121212;
</a><a href="#h1-0-14" id="h1-0-14" class="i">+        --sigBackgroundPrimaryInverse: #fff;
</a><a href="#h1-0-15" id="h1-0-15" class="i">+        --sigBackgroundSecondary: #1e1e1e;
</a><a href="#h1-0-16" id="h1-0-16" class="i">+        --sigBackgroundSecondaryHover: #2b2b2b;
</a><a href="#h1-0-17" id="h1-0-17" class="i">+        --sigBackgroundFeedHover: rgba(255, 255, 255, 0.1);
</a><a href="#h1-0-18" id="h1-0-18" class="i">+        --sigBackgroundMessageHover: #292929;
</a><a href="#h1-0-19" id="h1-0-19" class="i">+        --sigBackgroundMessageSaved: #333232;
</a><a href="#h1-0-20" id="h1-0-20" class="i">+        --sigBackgroundMessageSavedHover: #3a3a3a;
</a><a href="#h1-0-21" id="h1-0-21" class="i">+        --sigMediaControlContainerBackground: rgba(255, 255, 255, 0.1);
</a><a href="#h1-0-22" id="h1-0-22" class="i">+        --sigStartupFooterBackground: rgba(0, 0, 0, 0.05);
</a><a href="#h1-0-23" id="h1-0-23" class="i">+        --sigButtonPrimary: #0fadff;
</a><a href="#h1-0-24" id="h1-0-24" class="i">+        --sigButtonPrimaryHover: #42bfff;
</a><a href="#h1-0-25" id="h1-0-25" class="i">+        --sigButtonSecondary: #2b2b2b;
</a><a href="#h1-0-26" id="h1-0-26" class="i">+        --sigButtonSecondaryHover: #424242;
</a><a href="#h1-0-27" id="h1-0-27" class="i">+        --sigButtonSecondaryActive: #5c5c5c;
</a><a href="#h1-0-28" id="h1-0-28" class="i">+        --sigButtonTertiary: #4e565f;
</a><a href="#h1-0-29" id="h1-0-29" class="i">+        --sigButtonQuaternary: #fff;
</a><a href="#h1-0-30" id="h1-0-30" class="i">+        --sigButtonInactive: #1e1e1e;
</a><a href="#h1-0-31" id="h1-0-31" class="i">+        --sigButtonNegative: #e1143d;
</a><a href="#h1-0-32" id="h1-0-32" class="i">+        --sigButtonOnPrimary: #fff;
</a><a href="#h1-0-33" id="h1-0-33" class="i">+        --sigButtonOnSecondary: #dedede;
</a><a href="#h1-0-34" id="h1-0-34" class="i">+        --sigButtonOnTertiary: #fff;
</a><a href="#h1-0-35" id="h1-0-35" class="i">+        --sigButtonOnQuaternary: #1e1e1e;
</a><a href="#h1-0-36" id="h1-0-36" class="i">+        --sigButtonOnInactive: rgba(255, 255, 255, 0.3);
</a><a href="#h1-0-37" id="h1-0-37" class="i">+        --sigButtonOnNegative: #fff;
</a><a href="#h1-0-38" id="h1-0-38" class="i">+        --sigMain: #121212;
</a><a href="#h1-0-39" id="h1-0-39" class="i">+        --sigSubscreen: #121212;
</a><a href="#h1-0-40" id="h1-0-40" class="i">+        --sigOverlay: rgba(0, 0, 0, 0.4);
</a><a href="#h1-0-41" id="h1-0-41" class="i">+        --sigOverlayHover: rgba(0, 0, 0, 0.35);
</a><a href="#h1-0-42" id="h1-0-42" class="i">+        --sigSurface: #1e1e1e;
</a><a href="#h1-0-43" id="h1-0-43" class="i">+        --sigSurfaceRGB: 30, 30, 30;
</a><a href="#h1-0-44" id="h1-0-44" class="i">+        --sigSurfaceDown: #212121;
</a><a href="#h1-0-45" id="h1-0-45" class="i">+        --sigAboveSurface: #292929;
</a><a href="#h1-0-46" id="h1-0-46" class="i">+        --sigObject: rgba(255, 255, 255, 0.1);
</a><a href="#h1-0-47" id="h1-0-47" class="i">+        --sigObjectDown: rgba(255, 255, 255, 0.19);
</a><a href="#h1-0-48" id="h1-0-48" class="i">+        --sigConversationBoxBackground: rgba(255, 255, 255, 0.25);
</a><a href="#h1-0-49" id="h1-0-49" class="i">+        --sigDivider: rgba(255, 255, 255, 0.1);
</a><a href="#h1-0-50" id="h1-0-50" class="i">+        --sigDividerLight: rgba(255, 255, 255, 0.2);
</a><a href="#h1-0-51" id="h1-0-51" class="i">+        --sigPlaceholder: #1e1e1e;
</a><a href="#h1-0-52" id="h1-0-52" class="i">+        --sigDisabled: rgba(255, 255, 255, 0.1);
</a><a href="#h1-0-53" id="h1-0-53" class="i">+        --sigCallTileHighlight: rgba(255, 255, 255, 0.8);
</a><a href="#h1-0-54" id="h1-0-54" class="i">+        --sigChat: #0fadff;
</a><a href="#h1-0-55" id="h1-0-55" class="i">+        --sigSnapWithoutSound: #f23c57;
</a><a href="#h1-0-56" id="h1-0-56" class="i">+        --sigSnapWithSound: #a05dcd;
</a><a href="#h1-0-57" id="h1-0-57" class="i">+        --sigChatSurfaceCalling: #39ca8e;
</a><a href="#h1-0-58" id="h1-0-58" class="i">+        --sigChatSurfaceCallingDisabled: #105e3d;
</a><a href="#h1-0-59" id="h1-0-59" class="i">+        --sigChatPending: #767676;
</a><a href="#h1-0-60" id="h1-0-60" class="i">+        --sigChatPendingHover: #8f8f8f;
</a><a href="#h1-0-61" id="h1-0-61" class="i">+        --sigChatIcon: #0fadff;
</a><a href="#h1-0-62" id="h1-0-62" class="i">+        --sigChatIconCaret: #f8616d;
</a><a href="#h1-0-63" id="h1-0-63" class="i">+        --sigChatShadowOne: 0 0 17px rgba(33, 33, 33, 0.07), 0 0 22px rgba(0, 0, 0, 0.06), 0 0 8px rgba(84, 84, 84, 0.1);
</a><a href="#h1-0-64" id="h1-0-64" class="i">+        --selectedMiddleColorGradient: rgba(4, 4, 4, 0.1);
</a><a href="#h1-0-65" id="h1-0-65" class="i">+        --selectedRightColorGradient: rgba(4, 4, 4, 0);
</a><a href="#h1-0-66" id="h1-0-66" class="i">+    }
</a><a href="#h1-0-67" id="h1-0-67" class="i">+
</a><a href="#h1-0-68" id="h1-0-68" class="i">+    body {
</a><a href="#h1-0-69" id="h1-0-69" class="i">+        margin: 0;
</a><a href="#h1-0-70" id="h1-0-70" class="i">+        font-family: &#39;Avenir Next&#39;, sans-serif;
</a><a href="#h1-0-71" id="h1-0-71" class="i">+        color: var(--sigTextPrimary);
</a><a href="#h1-0-72" id="h1-0-72" class="i">+        background-color: var(--sigBackgroundPrimary);
</a><a href="#h1-0-73" id="h1-0-73" class="i">+    }
</a><a href="#h1-0-74" id="h1-0-74" class="i">+
</a><a href="#h1-0-75" id="h1-0-75" class="i">+    /* like an header */
</a><a href="#h1-0-76" id="h1-0-76" class="i">+    .conversation_summary {
</a><a href="#h1-0-77" id="h1-0-77" class="i">+        display: flex;
</a><a href="#h1-0-78" id="h1-0-78" class="i">+        flex-direction: row;
</a><a href="#h1-0-79" id="h1-0-79" class="i">+        align-items: center;
</a><a href="#h1-0-80" id="h1-0-80" class="i">+        padding: 10px;
</a><a href="#h1-0-81" id="h1-0-81" class="i">+        border-bottom: 1px solid var(--sigColorBackgroundBorder);
</a><a href="#h1-0-82" id="h1-0-82" class="i">+    }
</a><a href="#h1-0-83" id="h1-0-83" class="i">+
</a><a href="#h1-0-84" id="h1-0-84" class="i">+    .conversation_message_container {
</a><a href="#h1-0-85" id="h1-0-85" class="i">+        display: flex;
</a><a href="#h1-0-86" id="h1-0-86" class="i">+        flex-direction: column;
</a><a href="#h1-0-87" id="h1-0-87" class="i">+        padding: 5px;
</a><a href="#h1-0-88" id="h1-0-88" class="i">+        background-color: var(--sigBackgroundSecondary);
</a><a href="#h1-0-89" id="h1-0-89" class="i">+    }
</a><a href="#h1-0-90" id="h1-0-90" class="i">+
</a><a href="#h1-0-91" id="h1-0-91" class="i">+    .message {
</a><a href="#h1-0-92" id="h1-0-92" class="i">+        display: flex;
</a><a href="#h1-0-93" id="h1-0-93" class="i">+        flex-direction: row;
</a><a href="#h1-0-94" id="h1-0-94" class="i">+        align-items: center;
</a><a href="#h1-0-95" id="h1-0-95" class="i">+        padding: 5px;
</a><a href="#h1-0-96" id="h1-0-96" class="i">+        margin-left: 5px;
</a><a href="#h1-0-97" id="h1-0-97" class="i">+        border-bottom: 1px solid var(--sigColorBackgroundBorder);
</a><a href="#h1-0-98" id="h1-0-98" class="i">+    }
</a><a href="#h1-0-99" id="h1-0-99" class="i">+
</a><a href="#h1-0-100" id="h1-0-100" class="i">+    .message .header {
</a><a href="#h1-0-101" id="h1-0-101" class="i">+        display: flex;
</a><a href="#h1-0-102" id="h1-0-102" class="i">+        flex-direction: column;
</a><a href="#h1-0-103" id="h1-0-103" class="i">+        vertical-align: top;
</a><a href="#h1-0-104" id="h1-0-104" class="i">+        align-self: flex-start;
</a><a href="#h1-0-105" id="h1-0-105" class="i">+    }
</a><a href="#h1-0-106" id="h1-0-106" class="i">+
</a><a href="#h1-0-107" id="h1-0-107" class="i">+    .message .username {
</a><a href="#h1-0-108" id="h1-0-108" class="i">+        font-weight: bold;
</a><a href="#h1-0-109" id="h1-0-109" class="i">+    }
</a><a href="#h1-0-110" id="h1-0-110" class="i">+
</a><a href="#h1-0-111" id="h1-0-111" class="i">+    .message .time {
</a><a href="#h1-0-112" id="h1-0-112" class="i">+        font-size: 12px;
</a><a href="#h1-0-113" id="h1-0-113" class="i">+        color: var(--sigTextSecondary);
</a><a href="#h1-0-114" id="h1-0-114" class="i">+    }
</a><a href="#h1-0-115" id="h1-0-115" class="i">+
</a><a href="#h1-0-116" id="h1-0-116" class="i">+    .message .content {
</a><a href="#h1-0-117" id="h1-0-117" class="i">+        margin-left: 10px;
</a><a href="#h1-0-118" id="h1-0-118" class="i">+        display: flex;
</a><a href="#h1-0-119" id="h1-0-119" class="i">+        flex-direction: row;
</a><a href="#h1-0-120" id="h1-0-120" class="i">+        align-items: center;
</a><a href="#h1-0-121" id="h1-0-121" class="i">+
</a><a href="#h1-0-122" id="h1-0-122" class="i">+    }
</a><a href="#h1-0-123" id="h1-0-123" class="i">+
</a><a href="#h1-0-124" id="h1-0-124" class="i">+    .media_container {
</a><a href="#h1-0-125" id="h1-0-125" class="i">+        max-width: 300px;
</a><a href="#h1-0-126" id="h1-0-126" class="i">+        max-height: 500px;
</a><a href="#h1-0-127" id="h1-0-127" class="i">+    }
</a><a href="#h1-0-128" id="h1-0-128" class="i">+
</a><a href="#h1-0-129" id="h1-0-129" class="i">+    .red_snap_svg {
</a><a href="#h1-0-130" id="h1-0-130" class="i">+        color: var(--sigSnapWithoutSound);
</a><a href="#h1-0-131" id="h1-0-131" class="i">+    }
</a><a href="#h1-0-132" id="h1-0-132" class="i">+&lt;/style&gt;
</a><a href="#h1-0-133" id="h1-0-133" class="i">+&lt;body&gt;
</a><a href="#h1-0-134" id="h1-0-134" class="i">+    &lt;div class=&quot;conversation_summary&quot;&gt;
</a><a href="#h1-0-135" id="h1-0-135" class="i">+        &lt;div class=&quot;title&quot;&gt;&lt;/div&gt;
</a><a href="#h1-0-136" id="h1-0-136" class="i">+    &lt;/div&gt;
</a><a href="#h1-0-137" id="h1-0-137" class="i">+
</a><a href="#h1-0-138" id="h1-0-138" class="i">+    &lt;div class=&quot;conversation_message_container&quot;&gt;&lt;/div&gt;
</a><a href="#h1-0-139" id="h1-0-139" class="i">+    &lt;div style=&quot;display: none;&quot;&gt;
</a><a href="#h1-0-140" id="h1-0-140" class="i">+        &lt;svg class=&quot;red_snap_svg&quot; width=&quot;16&quot; height=&quot;16&quot; viewBox=&quot;0 0 16 16&quot; fill=&quot;none&quot; xmlns=&quot;http://www.w3.org/2000/svg&quot;&gt;
</a><a href="#h1-0-141" id="h1-0-141" class="i">+            &lt;rect x=&quot;2.75&quot; y=&quot;2.75&quot; width=&quot;10.5&quot; height=&quot;10.5&quot; rx=&quot;1.808&quot; stroke=&quot;currentColor&quot; stroke-width=&quot;1.5&quot;&gt;&lt;/rect&gt;
</a><a href="#h1-0-142" id="h1-0-142" class="i">+         &lt;/svg&gt;
</a><a href="#h1-0-143" id="h1-0-143" class="i">+    &lt;/div&gt;
</a><a href="#h1-0-144" id="h1-0-144" class="i">+
</a><a href="#h1-0-145" id="h1-0-145" class="i">+    &lt;script&gt;
</a><a href="#h1-0-146" id="h1-0-146" class="i">+        const conversationData = JSON.parse(document.querySelector(&quot;.exported_content&quot;).innerHTML)
</a><a href="#h1-0-147" id="h1-0-147" class="i">+        const participants = Object.values(conversationData.participants)
</a><a href="#h1-0-148" id="h1-0-148" class="i">+
</a><a href="#h1-0-149" id="h1-0-149" class="i">+        function base64decode(data) {
</a><a href="#h1-0-150" id="h1-0-150" class="i">+            return new Uint8Array(atob(data).split(&#39;&#39;).map(c =&gt; c.charCodeAt(0)))
</a><a href="#h1-0-151" id="h1-0-151" class="i">+        }
</a><a href="#h1-0-152" id="h1-0-152" class="i">+
</a><a href="#h1-0-153" id="h1-0-153" class="i">+        function makeConversationSummary() {
</a><a href="#h1-0-154" id="h1-0-154" class="i">+            const conversationTitle = conversationData.conversationName != null ? 
</a><a href="#h1-0-155" id="h1-0-155" class="i">+            conversationData.conversationName : 
</a><a href="#h1-0-156" id="h1-0-156" class="i">+            &quot;DM with &quot; + Object.values(participants).map(user =&gt; user.username).join(&quot;, &quot;)
</a><a href="#h1-0-157" id="h1-0-157" class="i">+
</a><a href="#h1-0-158" id="h1-0-158" class="i">+            document.querySelector(&quot;.conversation_summary .title&quot;).textContent = conversationTitle
</a><a href="#h1-0-159" id="h1-0-159" class="i">+        }
</a><a href="#h1-0-160" id="h1-0-160" class="i">+
</a><a href="#h1-0-161" id="h1-0-161" class="i">+        function makeConversationMessageContainer() {
</a><a href="#h1-0-162" id="h1-0-162" class="i">+            const messageTemplate = document.querySelector(&quot;#message_template&quot;)
</a><a href="#h1-0-163" id="h1-0-163" class="i">+            Object.values(conversationData.messages).forEach(message =&gt; {
</a><a href="#h1-0-164" id="h1-0-164" class="i">+                const messageObject = document.createElement(&quot;div&quot;)
</a><a href="#h1-0-165" id="h1-0-165" class="i">+                messageObject.classList.add(&quot;message&quot;)
</a><a href="#h1-0-166" id="h1-0-166" class="i">+
</a><a href="#h1-0-167" id="h1-0-167" class="i">+                messageObject.appendChild(((headerElement) =&gt;{
</a><a href="#h1-0-168" id="h1-0-168" class="i">+                    headerElement.classList.add(&quot;header&quot;)
</a><a href="#h1-0-169" id="h1-0-169" class="i">+
</a><a href="#h1-0-170" id="h1-0-170" class="i">+                    headerElement.appendChild(((elem) =&gt;{
</a><a href="#h1-0-171" id="h1-0-171" class="i">+                        elem.classList.add(&quot;username&quot;)
</a><a href="#h1-0-172" id="h1-0-172" class="i">+                        const participant = participants[message.senderId]
</a><a href="#h1-0-173" id="h1-0-173" class="i">+                        elem.innerHTML = (participant == null) ? &quot;Unknown user&quot; : participant.username
</a><a href="#h1-0-174" id="h1-0-174" class="i">+                        return elem
</a><a href="#h1-0-175" id="h1-0-175" class="i">+                    })(document.createElement(&quot;div&quot;)))
</a><a href="#h1-0-176" id="h1-0-176" class="i">+
</a><a href="#h1-0-177" id="h1-0-177" class="i">+
</a><a href="#h1-0-178" id="h1-0-178" class="i">+                    headerElement.appendChild(((elem) =&gt;{
</a><a href="#h1-0-179" id="h1-0-179" class="i">+                        elem.classList.add(&quot;time&quot;)
</a><a href="#h1-0-180" id="h1-0-180" class="i">+                        elem.innerHTML = new Date(message.createdTimestamp).toISOString()
</a><a href="#h1-0-181" id="h1-0-181" class="i">+                        return elem
</a><a href="#h1-0-182" id="h1-0-182" class="i">+                    })(document.createElement(&quot;div&quot;)))
</a><a href="#h1-0-183" id="h1-0-183" class="i">+
</a><a href="#h1-0-184" id="h1-0-184" class="i">+                    return headerElement
</a><a href="#h1-0-185" id="h1-0-185" class="i">+                })(document.createElement(&quot;div&quot;)))
</a><a href="#h1-0-186" id="h1-0-186" class="i">+
</a><a href="#h1-0-187" id="h1-0-187" class="i">+                messageObject.appendChild(((elem) =&gt;{
</a><a href="#h1-0-188" id="h1-0-188" class="i">+                    elem.classList.add(&quot;content&quot;)
</a><a href="#h1-0-189" id="h1-0-189" class="i">+
</a><a href="#h1-0-190" id="h1-0-190" class="i">+                    elem.innerHTML = message.serializedContent
</a><a href="#h1-0-191" id="h1-0-191" class="i">+
</a><a href="#h1-0-192" id="h1-0-192" class="i">+                    if (!message.serializedContent) {
</a><a href="#h1-0-193" id="h1-0-193" class="i">+                        elem.innerHTML = &quot;&quot;
</a><a href="#h1-0-194" id="h1-0-194" class="i">+                        let messageData = &quot;&quot;
</a><a href="#h1-0-195" id="h1-0-195" class="i">+                        switch(message.type) {
</a><a href="#h1-0-196" id="h1-0-196" class="i">+                            case &quot;SNAP&quot;:
</a><a href="#h1-0-197" id="h1-0-197" class="i">+                                elem.appendChild(document.querySelector(&#39;.red_snap_svg&#39;).cloneNode(true))
</a><a href="#h1-0-198" id="h1-0-198" class="i">+                                messageData = &quot;Snap&quot;
</a><a href="#h1-0-199" id="h1-0-199" class="i">+                                break
</a><a href="#h1-0-200" id="h1-0-200" class="i">+                            default:
</a><a href="#h1-0-201" id="h1-0-201" class="i">+                                messageData = message.type
</a><a href="#h1-0-202" id="h1-0-202" class="i">+
</a><a href="#h1-0-203" id="h1-0-203" class="i">+                        }
</a><a href="#h1-0-204" id="h1-0-204" class="i">+                        elem.innerHTML += messageData
</a><a href="#h1-0-205" id="h1-0-205" class="i">+                    }
</a><a href="#h1-0-206" id="h1-0-206" class="i">+
</a><a href="#h1-0-207" id="h1-0-207" class="i">+                    if (message.mediaReferences &amp;&amp; message.mediaReferences.length &gt; 0) {
</a><a href="#h1-0-208" id="h1-0-208" class="i">+                        //only get the first reference
</a><a href="#h1-0-209" id="h1-0-209" class="i">+                        const reference = Object.values(message.mediaReferences)[0]
</a><a href="#h1-0-210" id="h1-0-210" class="i">+                        let fetched = false
</a><a href="#h1-0-211" id="h1-0-211" class="i">+                        var observer = new IntersectionObserver(function(entries) {
</a><a href="#h1-0-212" id="h1-0-212" class="i">+                            if(!fetched &amp;&amp; entries[0].isIntersecting === true) {
</a><a href="#h1-0-213" id="h1-0-213" class="i">+                                fetched = true
</a><a href="#h1-0-214" id="h1-0-214" class="i">+
</a><a href="#h1-0-215" id="h1-0-215" class="i">+                                const mediaDiv = document.querySelector(&#39;.media-ORIGINAL_&#39; + reference.content.replace(/(=)/g, &quot;&quot;))
</a><a href="#h1-0-216" id="h1-0-216" class="i">+                                if (!mediaDiv) return
</a><a href="#h1-0-217" id="h1-0-217" class="i">+                                
</a><a href="#h1-0-218" id="h1-0-218" class="i">+                                const content = mediaDiv.innerHTML.substring(5, mediaDiv.innerHTML.length - 4)
</a><a href="#h1-0-219" id="h1-0-219" class="i">+                                const decodedData = new Uint8Array(inflate(base64decode(content)))
</a><a href="#h1-0-220" id="h1-0-220" class="i">+
</a><a href="#h1-0-221" id="h1-0-221" class="i">+                                const blob = new Blob([decodedData])
</a><a href="#h1-0-222" id="h1-0-222" class="i">+                                const url = URL.createObjectURL(blob)
</a><a href="#h1-0-223" id="h1-0-223" class="i">+                                
</a><a href="#h1-0-224" id="h1-0-224" class="i">+                                const imageTag = document.createElement(&quot;img&quot;)
</a><a href="#h1-0-225" id="h1-0-225" class="i">+                                imageTag.classList.add(&quot;media_container&quot;)
</a><a href="#h1-0-226" id="h1-0-226" class="i">+                                imageTag.src = url
</a><a href="#h1-0-227" id="h1-0-227" class="i">+                                imageTag.onerror = () =&gt; {
</a><a href="#h1-0-228" id="h1-0-228" class="i">+                                    elem.removeChild(imageTag)
</a><a href="#h1-0-229" id="h1-0-229" class="i">+                                    const mediaTag = document.createElement(message.type === &quot;VIDEO&quot; ? &quot;video&quot; : &quot;audio&quot;)
</a><a href="#h1-0-230" id="h1-0-230" class="i">+                                    mediaTag.classList.add(&quot;media_container&quot;)
</a><a href="#h1-0-231" id="h1-0-231" class="i">+                                    mediaTag.src = url
</a><a href="#h1-0-232" id="h1-0-232" class="i">+                                    mediaTag.preload = &quot;metadata&quot;
</a><a href="#h1-0-233" id="h1-0-233" class="i">+                                    mediaTag.controls = true
</a><a href="#h1-0-234" id="h1-0-234" class="i">+                                    elem.appendChild(mediaTag)
</a><a href="#h1-0-235" id="h1-0-235" class="i">+                                }
</a><a href="#h1-0-236" id="h1-0-236" class="i">+                                elem.innerHTML = &quot;&quot;
</a><a href="#h1-0-237" id="h1-0-237" class="i">+                                elem.appendChild(imageTag)
</a><a href="#h1-0-238" id="h1-0-238" class="i">+                            }
</a><a href="#h1-0-239" id="h1-0-239" class="i">+                        }, { threshold: [1] });
</a><a href="#h1-0-240" id="h1-0-240" class="i">+                        observer.observe(elem)
</a><a href="#h1-0-241" id="h1-0-241" class="i">+                    }
</a><a href="#h1-0-242" id="h1-0-242" class="i">+
</a><a href="#h1-0-243" id="h1-0-243" class="i">+                    return elem
</a><a href="#h1-0-244" id="h1-0-244" class="i">+                })(document.createElement(&quot;div&quot;)))
</a><a href="#h1-0-245" id="h1-0-245" class="i">+
</a><a href="#h1-0-246" id="h1-0-246" class="i">+                document.querySelector(&#39;.conversation_message_container&#39;).appendChild(messageObject)
</a><a href="#h1-0-247" id="h1-0-247" class="i">+            })
</a><a href="#h1-0-248" id="h1-0-248" class="i">+        }
</a><a href="#h1-0-249" id="h1-0-249" class="i">+
</a><a href="#h1-0-250" id="h1-0-250" class="i">+        makeConversationSummary()
</a><a href="#h1-0-251" id="h1-0-251" class="i">+        makeConversationMessageContainer()
</a><a href="#h1-0-252" id="h1-0-252" class="i">+    &lt;/script&gt;
</a><a href="#h1-0-253" id="h1-0-253" class="i">+&lt;/body&gt;
</a><b>diff --git a/<a id="h2" href="../file/app/src/main/assets/web/rawinflate.js.html">app/src/main/assets/web/rawinflate.js</a> b/<a href="../file/app/src/main/assets/web/rawinflate.js.html">app/src/main/assets/web/rawinflate.js</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -0,0 +1,6 @@
</a><a href="#h2-0-0" id="h2-0-0" class="i">+/* Copyright (C) 1999 Masanao Izumo &lt;iz@onicos.co.jp&gt;
</a><a href="#h2-0-1" id="h2-0-1" class="i">+ * Version: 1.0.0.1
</a><a href="#h2-0-2" id="h2-0-2" class="i">+ * LastModified: Dec 25 1999
</a><a href="#h2-0-3" id="h2-0-3" class="i">+ */
</a><a href="#h2-0-4" id="h2-0-4" class="i">+
</a><a href="#h2-0-5" id="h2-0-5" class="i">+(function(){var WSIZE=32768,STORED_BLOCK=0,STATIC_TREES=1,DYN_TREES=2,lbits=9,dbits=6,slide,wp,fixed_tl=null,fixed_td,fixed_bl,fixed_bd,bit_buf,bit_len,method,eof,copy_leng,copy_dist,tl,td,bl,bd,inflate_data,inflate_pos,MASK_BITS=[0x0000,0x0001,0x0003,0x0007,0x000f,0x001f,0x003f,0x007f,0x00ff,0x01ff,0x03ff,0x07ff,0x0fff,0x1fff,0x3fff,0x7fff,0xffff],cplens=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],cplext=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,99,99],cpdist=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577],cpdext=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],border=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];function HuftList(){this.next=null;this.list=null}function HuftNode(){this.e=0;this.b=0;this.n=0;this.t=null;}function HuftBuild(b,n,s,d,e,mm){this.BMAX=16;this.N_MAX=288;this.status=0;this.root=null;this.m=0;var a;var c=[];var el;var f;var g;var h;var i;var j;var k;var lx=[];var p;var pidx;var q;var r=new HuftNode();var u=[];var v=[];var w;var x=[];var xp;var y;var z;var o;var tail;tail=this.root=null;for(i=0;i&lt;this.BMAX+1;i+=1){c[i]=0}for(i=0;i&lt;this.BMAX+1;i+=1){lx[i]=0}for(i=0;i&lt;this.BMAX;i+=1){u[i]=null}for(i=0;i&lt;this.N_MAX;i+=1){v[i]=0}for(i=0;i&lt;this.BMAX+1;i+=1){x[i]=0}el=n&gt;256?b[256]:this.BMAX;p=b;pidx=0;i=n;do{c[p[pidx]]+=1;pidx+=1}while(--i&gt;0);if(c[0]===n){this.root=null;this.m=0;this.status=0;return}for(j=1;j&lt;=this.BMAX;j+=1){if(c[j]!==0){break}}k=j;if(mm&lt;j){mm=j}for(i=this.BMAX;i!==0;i-=1){if(c[i]!==0){break}}g=i;if(mm&gt;i){mm=i}for(y=1&lt;&lt;j;j&lt;i;j+=1,y&lt;&lt;=1){if((y-=c[j])&lt;0){this.status=2;this.m=mm;return}}if((y-=c[i])&lt;0){this.status=2;this.m=mm;return}c[i]+=y;x[1]=j=0;p=c;pidx=1;xp=2;while(--i&gt;0){x[xp++]=(j+=p[pidx++])}p=b;pidx=0;i=0;do{if((j=p[pidx++])!==0){v[x[j]++]=i}}while(++i&lt;n);n=x[g];x[0]=i=0;p=v;pidx=0;h=-1;w=lx[0]=0;q=null;z=0;for(null;k&lt;=g;k+=1){a=c[k];while(a-- &gt;0){while(k&gt;w+lx[1+h]){w+=lx[1+h];h+=1;z=(z=g-w)&gt;mm?mm:z;if((f=1&lt;&lt;(j=k-w))&gt;a+1){f-=a+1;xp=k;while(++j&lt;z){if((f&lt;&lt;=1)&lt;=c[xp+=1]){break;}f-=c[xp];}}if(w+j&gt;el&amp;&amp;w&lt;el){j=el-w;}z=1&lt;&lt;j;lx[1+h]=j;q=[];for(o=0;o&lt;z;o+=1){q[o]=new HuftNode()}if(!tail){tail=this.root=new HuftList()}else{tail=tail.next=new HuftList()}tail.next=null;tail.list=q;u[h]=q;if(h&gt;0){x[h]=i;r.b=lx[h];r.e=16+j;r.t=q;j=(i&amp;((1&lt;&lt;w)-1))&gt;&gt;(w-lx[h]);u[h-1][j].e=r.e;u[h-1][j].b=r.b;u[h-1][j].n=r.n;u[h-1][j].t=r.t}}r.b=k-w;if(pidx&gt;=n){r.e=99;}else if(p[pidx]&lt;s){r.e=(p[pidx]&lt;256?16:15);r.n=p[pidx++];}else{r.e=e[p[pidx]-s];r.n=d[p[pidx++]-s]}f=1&lt;&lt;(k-w);for(j=i&gt;&gt;w;j&lt;z;j+=f){q[j].e=r.e;q[j].b=r.b;q[j].n=r.n;q[j].t=r.t}for(j=1&lt;&lt;(k-1);(i&amp;j)!==0;j&gt;&gt;=1){i^=j}i^=j;while((i&amp;((1&lt;&lt;w)-1))!==x[h]){w-=lx[h];h-=1}}}this.m=lx[1];this.status=((y!==0&amp;&amp;g!==1)?1:0)}function GET_BYTE(){if(inflate_data.length===inflate_pos){return -1}return inflate_data[inflate_pos++]&amp;0xff}function NEEDBITS(n){while(bit_len&lt;n){bit_buf|=GET_BYTE()&lt;&lt;bit_len;bit_len+=8}}function GETBITS(n){return bit_buf&amp;MASK_BITS[n]}function DUMPBITS(n){bit_buf&gt;&gt;=n;bit_len-=n}function inflate_codes(buff,off,size){var e;var t;var n;if(size===0){return 0}n=0;for(;;){NEEDBITS(bl);t=tl.list[GETBITS(bl)];e=t.e;while(e&gt;16){if(e===99){return -1}DUMPBITS(t.b);e-=16;NEEDBITS(e);t=t.t[GETBITS(e)];e=t.e}DUMPBITS(t.b);if(e===16){wp&amp;=WSIZE-1;buff[off+n++]=slide[wp++]=t.n;if(n===size){return size}continue}if(e===15){break}NEEDBITS(e);copy_leng=t.n+GETBITS(e);DUMPBITS(e);NEEDBITS(bd);t=td.list[GETBITS(bd)];e=t.e;while(e&gt;16){if(e===99){return -1}DUMPBITS(t.b);e-=16;NEEDBITS(e);t=t.t[GETBITS(e)];e=t.e}DUMPBITS(t.b);NEEDBITS(e);copy_dist=wp-t.n-GETBITS(e);DUMPBITS(e);while(copy_leng&gt;0&amp;&amp;n&lt;size){copy_leng-=1;copy_dist&amp;=WSIZE-1;wp&amp;=WSIZE-1;buff[off+n++]=slide[wp++]=slide[copy_dist++]}if(n===size){return size}}method=-1;return n}function inflate_stored(buff,off,size){var n;n=bit_len&amp;7;DUMPBITS(n);NEEDBITS(16);n=GETBITS(16);DUMPBITS(16);NEEDBITS(16);if(n!==((~bit_buf)&amp;0xffff)){return -1;}DUMPBITS(16);copy_leng=n;n=0;while(copy_leng&gt;0&amp;&amp;n&lt;size){copy_leng-=1;wp&amp;=WSIZE-1;NEEDBITS(8);buff[off+n++]=slide[wp++]=GETBITS(8);DUMPBITS(8)}if(copy_leng===0){method=-1;}return n}function inflate_fixed(buff,off,size){if(!fixed_tl){var i;var l=[];var h;for(i=0;i&lt;144;i+=1){l[i]=8}for(null;i&lt;256;i+=1){l[i]=9}for(null;i&lt;280;i+=1){l[i]=7}for(null;i&lt;288;i+=1){l[i]=8}fixed_bl=7;h=new HuftBuild(l,288,257,cplens,cplext,fixed_bl);if(h.status!==0){console.error(&quot;HufBuild error: &quot;+h.status);return -1}fixed_tl=h.root;fixed_bl=h.m;for(i=0;i&lt;30;i+=1){l[i]=5}fixed_bd=5;h=new HuftBuild(l,30,0,cpdist,cpdext,fixed_bd);if(h.status&gt;1){fixed_tl=null;console.error(&quot;HufBuild error: &quot;+h.status);return -1}fixed_td=h.root;fixed_bd=h.m}tl=fixed_tl;td=fixed_td;bl=fixed_bl;bd=fixed_bd;return inflate_codes(buff,off,size)}function inflate_dynamic(buff,off,size){var i;var j;var l;var n;var t;var nb;var nl;var nd;var ll=[];var h;for(i=0;i&lt;286+30;i+=1){ll[i]=0}NEEDBITS(5);nl=257+GETBITS(5);DUMPBITS(5);NEEDBITS(5);nd=1+GETBITS(5);DUMPBITS(5);NEEDBITS(4);nb=4+GETBITS(4);DUMPBITS(4);if(nl&gt;286||nd&gt;30){return -1;}for(j=0;j&lt;nb;j+=1){NEEDBITS(3);ll[border[j]]=GETBITS(3);DUMPBITS(3)}for(null;j&lt;19;j+=1){ll[border[j]]=0}bl=7;h=new HuftBuild(ll,19,19,null,null,bl);if(h.status!==0){return -1;}tl=h.root;bl=h.m;n=nl+nd;i=l=0;while(i&lt;n){NEEDBITS(bl);t=tl.list[GETBITS(bl)];j=t.b;DUMPBITS(j);j=t.n;if(j&lt;16){ll[i++]=l=j;}else if(j===16){NEEDBITS(2);j=3+GETBITS(2);DUMPBITS(2);if(i+j&gt;n){return -1}while(j-- &gt;0){ll[i++]=l}}else if(j===17){NEEDBITS(3);j=3+GETBITS(3);DUMPBITS(3);if(i+j&gt;n){return -1}while(j-- &gt;0){ll[i++]=0}l=0}else{NEEDBITS(7);j=11+GETBITS(7);DUMPBITS(7);if(i+j&gt;n){return -1}while(j-- &gt;0){ll[i++]=0}l=0}}bl=lbits;h=new HuftBuild(ll,nl,257,cplens,cplext,bl);if(bl===0){h.status=1}if(h.status!==0){if(h.status!==1){return -1;}}tl=h.root;bl=h.m;for(i=0;i&lt;nd;i+=1){ll[i]=ll[i+nl]}bd=dbits;h=new HuftBuild(ll,nd,0,cpdist,cpdext,bd);td=h.root;bd=h.m;if(bd===0&amp;&amp;nl&gt;257){return -1}if(h.status!==0){return -1}return inflate_codes(buff,off,size)}function inflate_start(){if(!slide){slide=[];}wp=0;bit_buf=0;bit_len=0;method=-1;eof=false;copy_leng=copy_dist=0;tl=null}function inflate_internal(buff,off,size){var n,i;n=0;while(n&lt;size){if(eof&amp;&amp;method===-1){return n}if(copy_leng&gt;0){if(method!==STORED_BLOCK){while(copy_leng&gt;0&amp;&amp;n&lt;size){copy_leng-=1;copy_dist&amp;=WSIZE-1;wp&amp;=WSIZE-1;buff[off+n++]=slide[wp++]=slide[copy_dist++]}}else{while(copy_leng&gt;0&amp;&amp;n&lt;size){copy_leng-=1;wp&amp;=WSIZE-1;NEEDBITS(8);buff[off+n++]=slide[wp++]=GETBITS(8);DUMPBITS(8)}if(copy_leng===0){method=-1;}}if(n===size){return n}}if(method===-1){if(eof){break}NEEDBITS(1);if(GETBITS(1)!==0){eof=true}DUMPBITS(1);NEEDBITS(2);method=GETBITS(2);DUMPBITS(2);tl=null;copy_leng=0}switch(method){case STORED_BLOCK:i=inflate_stored(buff,off+n,size-n);break;case STATIC_TREES:if(tl){i=inflate_codes(buff,off+n,size-n)}else{i=inflate_fixed(buff,off+n,size-n)}break;case DYN_TREES:if(tl){i=inflate_codes(buff,off+n,size-n)}else{i=inflate_dynamic(buff,off+n,size-n)}break;default:i=-1;break}if(i===-1){if(eof){return 0}return -1}n+=i}return n}function inflate(arr){var buff=[],i;inflate_start();inflate_data=arr;inflate_pos=0;do{i=inflate_internal(buff,buff.length,1024)}while(i&gt;0);inflate_data=null;return buff}window.inflate=inflate}());</a><a href="#h2-0-6" id="h2-0-6" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h3" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/action/impl/ExportChatMessages.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/action/impl/ExportChatMessages.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/action/impl/ExportChatMessages.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/action/impl/ExportChatMessages.kt</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -0,0 +1,281 @@
</a><a href="#h3-0-0" id="h3-0-0" class="i">+package me.rhunk.snapenhance.action.impl
</a><a href="#h3-0-1" id="h3-0-1" class="i">+
</a><a href="#h3-0-2" id="h3-0-2" class="i">+import android.app.AlertDialog
</a><a href="#h3-0-3" id="h3-0-3" class="i">+import android.content.DialogInterface
</a><a href="#h3-0-4" id="h3-0-4" class="i">+import android.content.Intent
</a><a href="#h3-0-5" id="h3-0-5" class="i">+import android.net.Uri
</a><a href="#h3-0-6" id="h3-0-6" class="i">+import android.os.Environment
</a><a href="#h3-0-7" id="h3-0-7" class="i">+import kotlinx.coroutines.DelicateCoroutinesApi
</a><a href="#h3-0-8" id="h3-0-8" class="i">+import kotlinx.coroutines.Dispatchers
</a><a href="#h3-0-9" id="h3-0-9" class="i">+import kotlinx.coroutines.GlobalScope
</a><a href="#h3-0-10" id="h3-0-10" class="i">+import kotlinx.coroutines.Job
</a><a href="#h3-0-11" id="h3-0-11" class="i">+import kotlinx.coroutines.joinAll
</a><a href="#h3-0-12" id="h3-0-12" class="i">+import kotlinx.coroutines.launch
</a><a href="#h3-0-13" id="h3-0-13" class="i">+import kotlinx.coroutines.suspendCancellableCoroutine
</a><a href="#h3-0-14" id="h3-0-14" class="i">+import me.rhunk.snapenhance.Logger
</a><a href="#h3-0-15" id="h3-0-15" class="i">+import me.rhunk.snapenhance.action.AbstractAction
</a><a href="#h3-0-16" id="h3-0-16" class="i">+import me.rhunk.snapenhance.data.ContentType
</a><a href="#h3-0-17" id="h3-0-17" class="i">+import me.rhunk.snapenhance.data.wrapper.impl.Message
</a><a href="#h3-0-18" id="h3-0-18" class="i">+import me.rhunk.snapenhance.data.wrapper.impl.SnapUUID
</a><a href="#h3-0-19" id="h3-0-19" class="i">+import me.rhunk.snapenhance.database.objects.FriendFeedInfo
</a><a href="#h3-0-20" id="h3-0-20" class="i">+import me.rhunk.snapenhance.features.impl.Messaging
</a><a href="#h3-0-21" id="h3-0-21" class="i">+import me.rhunk.snapenhance.util.CallbackBuilder
</a><a href="#h3-0-22" id="h3-0-22" class="i">+import me.rhunk.snapenhance.util.export.ExportFormat
</a><a href="#h3-0-23" id="h3-0-23" class="i">+import me.rhunk.snapenhance.util.export.MessageExporter
</a><a href="#h3-0-24" id="h3-0-24" class="i">+import java.io.File
</a><a href="#h3-0-25" id="h3-0-25" class="i">+
</a><a href="#h3-0-26" id="h3-0-26" class="i">+@OptIn(DelicateCoroutinesApi::class)
</a><a href="#h3-0-27" id="h3-0-27" class="i">+class ExportChatMessages : AbstractAction(&quot;action.export_chat_messages&quot;) {
</a><a href="#h3-0-28" id="h3-0-28" class="i">+    private val callbackClass by lazy {  context.mappings.getMappedClass(&quot;callbacks&quot;, &quot;Callback&quot;) }
</a><a href="#h3-0-29" id="h3-0-29" class="i">+
</a><a href="#h3-0-30" id="h3-0-30" class="i">+    private val fetchConversationWithMessagesCallbackClass by lazy {  context.mappings.getMappedClass(&quot;callbacks&quot;, &quot;FetchConversationWithMessagesCallback&quot;) }
</a><a href="#h3-0-31" id="h3-0-31" class="i">+
</a><a href="#h3-0-32" id="h3-0-32" class="i">+    private val enterConversationMethod by lazy {
</a><a href="#h3-0-33" id="h3-0-33" class="i">+        context.classCache.conversationManager.methods.first { it.name == &quot;enterConversation&quot; }
</a><a href="#h3-0-34" id="h3-0-34" class="i">+    }
</a><a href="#h3-0-35" id="h3-0-35" class="i">+    private val exitConversationMethod by lazy {
</a><a href="#h3-0-36" id="h3-0-36" class="i">+        context.classCache.conversationManager.methods.first { it.name == &quot;exitConversation&quot; }
</a><a href="#h3-0-37" id="h3-0-37" class="i">+    }
</a><a href="#h3-0-38" id="h3-0-38" class="i">+    private val fetchConversationWithMessagesPaginatedMethod by lazy {
</a><a href="#h3-0-39" id="h3-0-39" class="i">+        context.classCache.conversationManager.methods.first { it.name == &quot;fetchConversationWithMessagesPaginated&quot; }
</a><a href="#h3-0-40" id="h3-0-40" class="i">+    }
</a><a href="#h3-0-41" id="h3-0-41" class="i">+
</a><a href="#h3-0-42" id="h3-0-42" class="i">+    private val conversationManagerInstance by lazy {
</a><a href="#h3-0-43" id="h3-0-43" class="i">+        context.feature(Messaging::class).conversationManager
</a><a href="#h3-0-44" id="h3-0-44" class="i">+    }
</a><a href="#h3-0-45" id="h3-0-45" class="i">+
</a><a href="#h3-0-46" id="h3-0-46" class="i">+    private val dialogLogs = mutableListOf&lt;String&gt;()
</a><a href="#h3-0-47" id="h3-0-47" class="i">+    private var currentActionDialog: AlertDialog? = null
</a><a href="#h3-0-48" id="h3-0-48" class="i">+
</a><a href="#h3-0-49" id="h3-0-49" class="i">+    private var exportType: ExportFormat? = null
</a><a href="#h3-0-50" id="h3-0-50" class="i">+    private var mediaToDownload: List&lt;ContentType&gt;? = null
</a><a href="#h3-0-51" id="h3-0-51" class="i">+
</a><a href="#h3-0-52" id="h3-0-52" class="i">+    private fun logDialog(message: String) {
</a><a href="#h3-0-53" id="h3-0-53" class="i">+        context.runOnUiThread {
</a><a href="#h3-0-54" id="h3-0-54" class="i">+            if (dialogLogs.size &gt; 15) dialogLogs.removeAt(0)
</a><a href="#h3-0-55" id="h3-0-55" class="i">+            dialogLogs.add(message)
</a><a href="#h3-0-56" id="h3-0-56" class="i">+            Logger.debug(&quot;dialog: $message&quot;)
</a><a href="#h3-0-57" id="h3-0-57" class="i">+            currentActionDialog!!.setMessage(dialogLogs.joinToString(&quot;\n&quot;))
</a><a href="#h3-0-58" id="h3-0-58" class="i">+        }
</a><a href="#h3-0-59" id="h3-0-59" class="i">+    }
</a><a href="#h3-0-60" id="h3-0-60" class="i">+
</a><a href="#h3-0-61" id="h3-0-61" class="i">+    private suspend fun askExportType() = suspendCancellableCoroutine { cont -&gt;
</a><a href="#h3-0-62" id="h3-0-62" class="i">+        context.runOnUiThread {
</a><a href="#h3-0-63" id="h3-0-63" class="i">+            AlertDialog.Builder(context.mainActivity)
</a><a href="#h3-0-64" id="h3-0-64" class="i">+                .setTitle(context.translation.get(&quot;chat_export.select_export_format&quot;))
</a><a href="#h3-0-65" id="h3-0-65" class="i">+                .setItems(ExportFormat.values().map { it.name }.toTypedArray()) { _, which -&gt;
</a><a href="#h3-0-66" id="h3-0-66" class="i">+                    cont.resumeWith(Result.success(ExportFormat.values()[which]))
</a><a href="#h3-0-67" id="h3-0-67" class="i">+                }
</a><a href="#h3-0-68" id="h3-0-68" class="i">+                .setOnCancelListener {
</a><a href="#h3-0-69" id="h3-0-69" class="i">+                    cont.resumeWith(Result.success(null))
</a><a href="#h3-0-70" id="h3-0-70" class="i">+                }
</a><a href="#h3-0-71" id="h3-0-71" class="i">+                .show()
</a><a href="#h3-0-72" id="h3-0-72" class="i">+        }
</a><a href="#h3-0-73" id="h3-0-73" class="i">+    }
</a><a href="#h3-0-74" id="h3-0-74" class="i">+
</a><a href="#h3-0-75" id="h3-0-75" class="i">+    private suspend fun askMediaToDownload() = suspendCancellableCoroutine { cont -&gt;
</a><a href="#h3-0-76" id="h3-0-76" class="i">+        context.runOnUiThread {
</a><a href="#h3-0-77" id="h3-0-77" class="i">+            val mediasToDownload = mutableListOf&lt;ContentType&gt;()
</a><a href="#h3-0-78" id="h3-0-78" class="i">+            val contentTypes = arrayOf(
</a><a href="#h3-0-79" id="h3-0-79" class="i">+                ContentType.SNAP,
</a><a href="#h3-0-80" id="h3-0-80" class="i">+                ContentType.EXTERNAL_MEDIA,
</a><a href="#h3-0-81" id="h3-0-81" class="i">+                ContentType.NOTE,
</a><a href="#h3-0-82" id="h3-0-82" class="i">+                ContentType.STICKER
</a><a href="#h3-0-83" id="h3-0-83" class="i">+            )
</a><a href="#h3-0-84" id="h3-0-84" class="i">+            AlertDialog.Builder(context.mainActivity)
</a><a href="#h3-0-85" id="h3-0-85" class="i">+                .setTitle(context.translation.get(&quot;chat_export.select_media_type&quot;))
</a><a href="#h3-0-86" id="h3-0-86" class="i">+                .setMultiChoiceItems(contentTypes.map { it.name }.toTypedArray(), BooleanArray(contentTypes.size) { false }) { _, which, isChecked -&gt;
</a><a href="#h3-0-87" id="h3-0-87" class="i">+                    val media = contentTypes[which]
</a><a href="#h3-0-88" id="h3-0-88" class="i">+                    if (isChecked) {
</a><a href="#h3-0-89" id="h3-0-89" class="i">+                        mediasToDownload.add(media)
</a><a href="#h3-0-90" id="h3-0-90" class="i">+                    } else if (mediasToDownload.contains(media)) {
</a><a href="#h3-0-91" id="h3-0-91" class="i">+                        mediasToDownload.remove(media)
</a><a href="#h3-0-92" id="h3-0-92" class="i">+                    }
</a><a href="#h3-0-93" id="h3-0-93" class="i">+                }
</a><a href="#h3-0-94" id="h3-0-94" class="i">+                .setOnCancelListener {
</a><a href="#h3-0-95" id="h3-0-95" class="i">+                    cont.resumeWith(Result.success(null))
</a><a href="#h3-0-96" id="h3-0-96" class="i">+                }
</a><a href="#h3-0-97" id="h3-0-97" class="i">+                .setPositiveButton(&quot;OK&quot;) { _, _ -&gt;
</a><a href="#h3-0-98" id="h3-0-98" class="i">+                    cont.resumeWith(Result.success(mediasToDownload))
</a><a href="#h3-0-99" id="h3-0-99" class="i">+                }
</a><a href="#h3-0-100" id="h3-0-100" class="i">+                .show()
</a><a href="#h3-0-101" id="h3-0-101" class="i">+        }
</a><a href="#h3-0-102" id="h3-0-102" class="i">+    }
</a><a href="#h3-0-103" id="h3-0-103" class="i">+
</a><a href="#h3-0-104" id="h3-0-104" class="i">+    override fun run() {
</a><a href="#h3-0-105" id="h3-0-105" class="i">+        GlobalScope.launch(Dispatchers.Main) {
</a><a href="#h3-0-106" id="h3-0-106" class="i">+            exportType = askExportType() ?: return@launch
</a><a href="#h3-0-107" id="h3-0-107" class="i">+            mediaToDownload = if (exportType == ExportFormat.HTML) askMediaToDownload() else null
</a><a href="#h3-0-108" id="h3-0-108" class="i">+
</a><a href="#h3-0-109" id="h3-0-109" class="i">+            val friendFeedEntries = context.database.getFriendFeed(20)
</a><a href="#h3-0-110" id="h3-0-110" class="i">+            val selectedConversations = mutableListOf&lt;FriendFeedInfo&gt;()
</a><a href="#h3-0-111" id="h3-0-111" class="i">+
</a><a href="#h3-0-112" id="h3-0-112" class="i">+            AlertDialog.Builder(context.mainActivity)
</a><a href="#h3-0-113" id="h3-0-113" class="i">+                .setTitle(context.translation.get(&quot;chat_export.select_conversation&quot;))
</a><a href="#h3-0-114" id="h3-0-114" class="i">+                .setMultiChoiceItems(
</a><a href="#h3-0-115" id="h3-0-115" class="i">+                    friendFeedEntries.map { it.feedDisplayName ?: it.friendDisplayName!!.split(&quot;|&quot;).firstOrNull() }.toTypedArray(),
</a><a href="#h3-0-116" id="h3-0-116" class="i">+                    BooleanArray(friendFeedEntries.size) { false }
</a><a href="#h3-0-117" id="h3-0-117" class="i">+                ) { _, which, isChecked -&gt;
</a><a href="#h3-0-118" id="h3-0-118" class="i">+                    if (isChecked) {
</a><a href="#h3-0-119" id="h3-0-119" class="i">+                        selectedConversations.add(friendFeedEntries[which])
</a><a href="#h3-0-120" id="h3-0-120" class="i">+                    } else if (selectedConversations.contains(friendFeedEntries[which])) {
</a><a href="#h3-0-121" id="h3-0-121" class="i">+                        selectedConversations.remove(friendFeedEntries[which])
</a><a href="#h3-0-122" id="h3-0-122" class="i">+                    }
</a><a href="#h3-0-123" id="h3-0-123" class="i">+                }
</a><a href="#h3-0-124" id="h3-0-124" class="i">+                .setNegativeButton(context.translation.get(&quot;chat_export.dialog_negative_button&quot;)) { dialog, _ -&gt;
</a><a href="#h3-0-125" id="h3-0-125" class="i">+                    dialog.dismiss()
</a><a href="#h3-0-126" id="h3-0-126" class="i">+                }
</a><a href="#h3-0-127" id="h3-0-127" class="i">+                .setNeutralButton(context.translation.get(&quot;chat_export.dialog_neutral_button&quot;)) { _, _ -&gt;
</a><a href="#h3-0-128" id="h3-0-128" class="i">+                    exportChatForConversations(friendFeedEntries)
</a><a href="#h3-0-129" id="h3-0-129" class="i">+                }
</a><a href="#h3-0-130" id="h3-0-130" class="i">+                .setPositiveButton(context.translation.get(&quot;chat_export.dialog_positive_button&quot;)) { _, _ -&gt;
</a><a href="#h3-0-131" id="h3-0-131" class="i">+                    exportChatForConversations(selectedConversations)
</a><a href="#h3-0-132" id="h3-0-132" class="i">+                }
</a><a href="#h3-0-133" id="h3-0-133" class="i">+                .show()
</a><a href="#h3-0-134" id="h3-0-134" class="i">+        }
</a><a href="#h3-0-135" id="h3-0-135" class="i">+    }
</a><a href="#h3-0-136" id="h3-0-136" class="i">+
</a><a href="#h3-0-137" id="h3-0-137" class="i">+    private suspend fun conversationAction(isEntering: Boolean, conversationId: String, conversationType: String?) = suspendCancellableCoroutine { continuation -&gt;
</a><a href="#h3-0-138" id="h3-0-138" class="i">+        val callback = CallbackBuilder(callbackClass)
</a><a href="#h3-0-139" id="h3-0-139" class="i">+            .override(&quot;onSuccess&quot;) { _ -&gt;
</a><a href="#h3-0-140" id="h3-0-140" class="i">+                continuation.resumeWith(Result.success(Unit))
</a><a href="#h3-0-141" id="h3-0-141" class="i">+            }
</a><a href="#h3-0-142" id="h3-0-142" class="i">+            .override(&quot;onError&quot;) {
</a><a href="#h3-0-143" id="h3-0-143" class="i">+                continuation.resumeWith(Result.failure(Exception(&quot;Failed to ${if (isEntering) &quot;enter&quot; else &quot;exit&quot;} conversation&quot;)))
</a><a href="#h3-0-144" id="h3-0-144" class="i">+            }.build()
</a><a href="#h3-0-145" id="h3-0-145" class="i">+
</a><a href="#h3-0-146" id="h3-0-146" class="i">+        if (isEntering) {
</a><a href="#h3-0-147" id="h3-0-147" class="i">+            enterConversationMethod.invoke(
</a><a href="#h3-0-148" id="h3-0-148" class="i">+                conversationManagerInstance,
</a><a href="#h3-0-149" id="h3-0-149" class="i">+                SnapUUID.fromString(conversationId).instanceNonNull(),
</a><a href="#h3-0-150" id="h3-0-150" class="i">+                enterConversationMethod.parameterTypes[1].enumConstants.first { it.toString() == conversationType },
</a><a href="#h3-0-151" id="h3-0-151" class="i">+                callback
</a><a href="#h3-0-152" id="h3-0-152" class="i">+            )
</a><a href="#h3-0-153" id="h3-0-153" class="i">+        } else {
</a><a href="#h3-0-154" id="h3-0-154" class="i">+            exitConversationMethod.invoke(
</a><a href="#h3-0-155" id="h3-0-155" class="i">+                conversationManagerInstance,
</a><a href="#h3-0-156" id="h3-0-156" class="i">+                SnapUUID.fromString(conversationId).instanceNonNull(),
</a><a href="#h3-0-157" id="h3-0-157" class="i">+                Long.MAX_VALUE,
</a><a href="#h3-0-158" id="h3-0-158" class="i">+                callback
</a><a href="#h3-0-159" id="h3-0-159" class="i">+            )
</a><a href="#h3-0-160" id="h3-0-160" class="i">+        }
</a><a href="#h3-0-161" id="h3-0-161" class="i">+    }
</a><a href="#h3-0-162" id="h3-0-162" class="i">+
</a><a href="#h3-0-163" id="h3-0-163" class="i">+    private suspend fun fetchMessagesPaginated(conversationId: String, lastMessageId: Long) = suspendCancellableCoroutine { continuation -&gt;
</a><a href="#h3-0-164" id="h3-0-164" class="i">+        val callback = CallbackBuilder(fetchConversationWithMessagesCallbackClass)
</a><a href="#h3-0-165" id="h3-0-165" class="i">+            .override(&quot;onFetchConversationWithMessagesComplete&quot;) { param -&gt;
</a><a href="#h3-0-166" id="h3-0-166" class="i">+                val messagesList = param.arg&lt;List&lt;*&gt;&gt;(1).map { Message(it) }
</a><a href="#h3-0-167" id="h3-0-167" class="i">+                continuation.resumeWith(Result.success(messagesList))
</a><a href="#h3-0-168" id="h3-0-168" class="i">+            }
</a><a href="#h3-0-169" id="h3-0-169" class="i">+            .override(&quot;onServerRequest&quot;, shouldUnhook = false) {}
</a><a href="#h3-0-170" id="h3-0-170" class="i">+            .override(&quot;onError&quot;) {
</a><a href="#h3-0-171" id="h3-0-171" class="i">+                continuation.resumeWith(Result.failure(Exception(&quot;Failed to fetch messages&quot;)))
</a><a href="#h3-0-172" id="h3-0-172" class="i">+            }.build()
</a><a href="#h3-0-173" id="h3-0-173" class="i">+
</a><a href="#h3-0-174" id="h3-0-174" class="i">+        fetchConversationWithMessagesPaginatedMethod.invoke(
</a><a href="#h3-0-175" id="h3-0-175" class="i">+            conversationManagerInstance,
</a><a href="#h3-0-176" id="h3-0-176" class="i">+            SnapUUID.fromString(conversationId).instanceNonNull(),
</a><a href="#h3-0-177" id="h3-0-177" class="i">+            lastMessageId,
</a><a href="#h3-0-178" id="h3-0-178" class="i">+            100,
</a><a href="#h3-0-179" id="h3-0-179" class="i">+            callback
</a><a href="#h3-0-180" id="h3-0-180" class="i">+        )
</a><a href="#h3-0-181" id="h3-0-181" class="i">+    }
</a><a href="#h3-0-182" id="h3-0-182" class="i">+
</a><a href="#h3-0-183" id="h3-0-183" class="i">+    private suspend fun exportFullConversation(friendFeedInfo: FriendFeedInfo) {
</a><a href="#h3-0-184" id="h3-0-184" class="i">+        //first fetch the first message
</a><a href="#h3-0-185" id="h3-0-185" class="i">+        val conversationId = friendFeedInfo.key!!
</a><a href="#h3-0-186" id="h3-0-186" class="i">+        val conversationName = friendFeedInfo.feedDisplayName ?: friendFeedInfo.friendDisplayName!!.split(&quot;|&quot;).lastOrNull() ?: &quot;unknown&quot;
</a><a href="#h3-0-187" id="h3-0-187" class="i">+
</a><a href="#h3-0-188" id="h3-0-188" class="i">+        conversationAction(true, conversationId, if (friendFeedInfo.feedDisplayName != null) &quot;USERCREATEDGROUP&quot; else &quot;ONEONONE&quot;)
</a><a href="#h3-0-189" id="h3-0-189" class="i">+        
</a><a href="#h3-0-190" id="h3-0-190" class="i">+        logDialog(context.translation.get(&quot;chat_export.exporting_message&quot;).replace(&quot;{conversation}&quot;, conversationName))
</a><a href="#h3-0-191" id="h3-0-191" class="i">+
</a><a href="#h3-0-192" id="h3-0-192" class="i">+        val foundMessages = fetchMessagesPaginated(conversationId, Long.MAX_VALUE).toMutableList()
</a><a href="#h3-0-193" id="h3-0-193" class="i">+        var lastMessageId = foundMessages.firstOrNull()?.messageDescriptor?.messageId ?: run {
</a><a href="#h3-0-194" id="h3-0-194" class="i">+            logDialog(context.translation.get(&quot;chat_export.no_messages_found&quot;))
</a><a href="#h3-0-195" id="h3-0-195" class="i">+            return
</a><a href="#h3-0-196" id="h3-0-196" class="i">+        }
</a><a href="#h3-0-197" id="h3-0-197" class="i">+
</a><a href="#h3-0-198" id="h3-0-198" class="i">+        while (true) {
</a><a href="#h3-0-199" id="h3-0-199" class="i">+            Logger.debug(&quot;[$conversationName] fetching $lastMessageId&quot;)
</a><a href="#h3-0-200" id="h3-0-200" class="i">+            val messages = fetchMessagesPaginated(conversationId, lastMessageId)
</a><a href="#h3-0-201" id="h3-0-201" class="i">+            if (messages.isEmpty()) break
</a><a href="#h3-0-202" id="h3-0-202" class="i">+            foundMessages.addAll(messages)
</a><a href="#h3-0-203" id="h3-0-203" class="i">+            messages.firstOrNull()?.let {
</a><a href="#h3-0-204" id="h3-0-204" class="i">+                lastMessageId = it.messageDescriptor.messageId
</a><a href="#h3-0-205" id="h3-0-205" class="i">+            }
</a><a href="#h3-0-206" id="h3-0-206" class="i">+        }
</a><a href="#h3-0-207" id="h3-0-207" class="i">+
</a><a href="#h3-0-208" id="h3-0-208" class="i">+        val outputFile = File(
</a><a href="#h3-0-209" id="h3-0-209" class="i">+            Environment.getExternalStoragePublicDirectory(Environment.DIRECTORY_DOWNLOADS),
</a><a href="#h3-0-210" id="h3-0-210" class="i">+            &quot;SnapEnhance/conversation_${conversationName}_${System.currentTimeMillis()}.${exportType!!.extension}&quot;
</a><a href="#h3-0-211" id="h3-0-211" class="i">+        ).also { it.parentFile?.mkdirs() }
</a><a href="#h3-0-212" id="h3-0-212" class="i">+
</a><a href="#h3-0-213" id="h3-0-213" class="i">+        logDialog(context.translation.get(&quot;chat_export.writing_output&quot;))
</a><a href="#h3-0-214" id="h3-0-214" class="i">+        MessageExporter(
</a><a href="#h3-0-215" id="h3-0-215" class="i">+            context = context,
</a><a href="#h3-0-216" id="h3-0-216" class="i">+            friendFeedInfo = friendFeedInfo,
</a><a href="#h3-0-217" id="h3-0-217" class="i">+            outputFile = outputFile,
</a><a href="#h3-0-218" id="h3-0-218" class="i">+            mediaToDownload = mediaToDownload,
</a><a href="#h3-0-219" id="h3-0-219" class="i">+            printLog = ::logDialog
</a><a href="#h3-0-220" id="h3-0-220" class="i">+        ).also {
</a><a href="#h3-0-221" id="h3-0-221" class="i">+            runCatching {
</a><a href="#h3-0-222" id="h3-0-222" class="i">+                it.readMessages(foundMessages)
</a><a href="#h3-0-223" id="h3-0-223" class="i">+            }.onFailure {
</a><a href="#h3-0-224" id="h3-0-224" class="i">+                logDialog(context.translation.get(&quot;chat_export.export_failed&quot;).replace(&quot;{conversation}&quot;, it.message.toString()))
</a><a href="#h3-0-225" id="h3-0-225" class="i">+                Logger.error(it)
</a><a href="#h3-0-226" id="h3-0-226" class="i">+                return
</a><a href="#h3-0-227" id="h3-0-227" class="i">+            }
</a><a href="#h3-0-228" id="h3-0-228" class="i">+        }.exportTo(exportType!!)
</a><a href="#h3-0-229" id="h3-0-229" class="i">+
</a><a href="#h3-0-230" id="h3-0-230" class="i">+        dialogLogs.clear()
</a><a href="#h3-0-231" id="h3-0-231" class="i">+        logDialog(&quot;\n&quot; + context.translation.get(&quot;chat_export.exported_to&quot;).replace(&quot;{path}&quot;, outputFile.absolutePath.toString()) + &quot;\n&quot;)
</a><a href="#h3-0-232" id="h3-0-232" class="i">+
</a><a href="#h3-0-233" id="h3-0-233" class="i">+        currentActionDialog?.setButton(DialogInterface.BUTTON_POSITIVE, &quot;Open&quot;) { _, _ -&gt;
</a><a href="#h3-0-234" id="h3-0-234" class="i">+            val intent = Intent(Intent.ACTION_VIEW)
</a><a href="#h3-0-235" id="h3-0-235" class="i">+            intent.setDataAndType(Uri.fromFile(outputFile.parentFile), &quot;resource/folder&quot;)
</a><a href="#h3-0-236" id="h3-0-236" class="i">+            context.mainActivity!!.startActivity(intent)
</a><a href="#h3-0-237" id="h3-0-237" class="i">+        }
</a><a href="#h3-0-238" id="h3-0-238" class="i">+
</a><a href="#h3-0-239" id="h3-0-239" class="i">+        runCatching {
</a><a href="#h3-0-240" id="h3-0-240" class="i">+            conversationAction(false, conversationId, null)
</a><a href="#h3-0-241" id="h3-0-241" class="i">+        }
</a><a href="#h3-0-242" id="h3-0-242" class="i">+    }
</a><a href="#h3-0-243" id="h3-0-243" class="i">+
</a><a href="#h3-0-244" id="h3-0-244" class="i">+    private fun exportChatForConversations(conversations: List&lt;FriendFeedInfo&gt;) {
</a><a href="#h3-0-245" id="h3-0-245" class="i">+        dialogLogs.clear()
</a><a href="#h3-0-246" id="h3-0-246" class="i">+        val jobs = mutableListOf&lt;Job&gt;()
</a><a href="#h3-0-247" id="h3-0-247" class="i">+
</a><a href="#h3-0-248" id="h3-0-248" class="i">+        currentActionDialog = AlertDialog.Builder(context.mainActivity)
</a><a href="#h3-0-249" id="h3-0-249" class="i">+            .setTitle(context.translation.get(&quot;chat_export.exporting_chats&quot;))
</a><a href="#h3-0-250" id="h3-0-250" class="i">+            .setCancelable(false)
</a><a href="#h3-0-251" id="h3-0-251" class="i">+            .setMessage(&quot;&quot;)
</a><a href="#h3-0-252" id="h3-0-252" class="i">+            .setNegativeButton(context.translation.get(&quot;chat_export.dialog_negative_button&quot;)) { dialog, _ -&gt;
</a><a href="#h3-0-253" id="h3-0-253" class="i">+                jobs.forEach { it.cancel() }
</a><a href="#h3-0-254" id="h3-0-254" class="i">+                dialog.dismiss()
</a><a href="#h3-0-255" id="h3-0-255" class="i">+            }
</a><a href="#h3-0-256" id="h3-0-256" class="i">+            .create()
</a><a href="#h3-0-257" id="h3-0-257" class="i">+        
</a><a href="#h3-0-258" id="h3-0-258" class="i">+        val conversationSize = context.translation.get(&quot;chat_export.processing_chats&quot;).replace(&quot;{amount}&quot;, conversations.size.toString())
</a><a href="#h3-0-259" id="h3-0-259" class="i">+        
</a><a href="#h3-0-260" id="h3-0-260" class="i">+        logDialog(conversationSize)
</a><a href="#h3-0-261" id="h3-0-261" class="i">+
</a><a href="#h3-0-262" id="h3-0-262" class="i">+        currentActionDialog!!.show()
</a><a href="#h3-0-263" id="h3-0-263" class="i">+
</a><a href="#h3-0-264" id="h3-0-264" class="i">+        GlobalScope.launch(Dispatchers.Default) {
</a><a href="#h3-0-265" id="h3-0-265" class="i">+            conversations.forEach { conversation -&gt;
</a><a href="#h3-0-266" id="h3-0-266" class="i">+                launch {
</a><a href="#h3-0-267" id="h3-0-267" class="i">+                    runCatching {
</a><a href="#h3-0-268" id="h3-0-268" class="i">+                        exportFullConversation(conversation)
</a><a href="#h3-0-269" id="h3-0-269" class="i">+                    }.onFailure {
</a><a href="#h3-0-270" id="h3-0-270" class="i">+                        logDialog(context.translation.get(&quot;chat_export.export_fail&quot;).replace(&quot;{conversation}&quot;, conversation.key.toString()))
</a><a href="#h3-0-271" id="h3-0-271" class="i">+                        logDialog(it.stackTraceToString())
</a><a href="#h3-0-272" id="h3-0-272" class="i">+                        Logger.xposedLog(it)
</a><a href="#h3-0-273" id="h3-0-273" class="i">+                    }
</a><a href="#h3-0-274" id="h3-0-274" class="i">+                }.also { jobs.add(it) }
</a><a href="#h3-0-275" id="h3-0-275" class="i">+            }
</a><a href="#h3-0-276" id="h3-0-276" class="i">+            jobs.joinAll()
</a><a href="#h3-0-277" id="h3-0-277" class="i">+            logDialog(context.translation.get(&quot;chat_export.finished&quot;))
</a><a href="#h3-0-278" id="h3-0-278" class="i">+        }
</a><a href="#h3-0-279" id="h3-0-279" class="i">+    }
</a><a href="#h3-0-280" id="h3-0-280" class="i">+}</a><a href="#h3-0-281" id="h3-0-281" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h4" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/MessageMetadata.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/MessageMetadata.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/MessageMetadata.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/MessageMetadata.kt</a></b>
<a href="#h4-0" id="h4-0" class="h">@@ -12,5 +12,21 @@ class MessageMetadata(obj: Any?) : AbstractWrapper(obj){
</a>     set(value) {
         setEnumValue(&quot;mPlayableSnapState&quot;, value)
     }
<a href="#h4-0-3" id="h4-0-3" class="d">-    val savedBy: List&lt;SnapUUID&gt; = (instanceNonNull().getObjectField(&quot;mSavedBy&quot;) as List&lt;*&gt;).map { SnapUUID(it!!) }
</a><a href="#h4-0-4" id="h4-0-4" class="i">+
</a><a href="#h4-0-5" id="h4-0-5" class="i">+    private fun getUUIDList(name: String): List&lt;SnapUUID&gt; {
</a><a href="#h4-0-6" id="h4-0-6" class="i">+        return (instanceNonNull().getObjectField(name) as List&lt;*&gt;).map { SnapUUID(it!!) }
</a><a href="#h4-0-7" id="h4-0-7" class="i">+    }
</a><a href="#h4-0-8" id="h4-0-8" class="i">+
</a><a href="#h4-0-9" id="h4-0-9" class="i">+    val savedBy: List&lt;SnapUUID&gt; by lazy {
</a><a href="#h4-0-10" id="h4-0-10" class="i">+        getUUIDList(&quot;mSavedBy&quot;)
</a><a href="#h4-0-11" id="h4-0-11" class="i">+    }
</a><a href="#h4-0-12" id="h4-0-12" class="i">+    val openedBy: List&lt;SnapUUID&gt; by lazy {
</a><a href="#h4-0-13" id="h4-0-13" class="i">+        getUUIDList(&quot;mOpenedBy&quot;)
</a><a href="#h4-0-14" id="h4-0-14" class="i">+    }
</a><a href="#h4-0-15" id="h4-0-15" class="i">+    val seenBy: List&lt;SnapUUID&gt; by lazy {
</a><a href="#h4-0-16" id="h4-0-16" class="i">+        getUUIDList(&quot;mSeenBy&quot;)
</a><a href="#h4-0-17" id="h4-0-17" class="i">+    }
</a><a href="#h4-0-18" id="h4-0-18" class="i">+    val reactions: List&lt;UserIdToReaction&gt; by lazy {
</a><a href="#h4-0-19" id="h4-0-19" class="i">+        (instanceNonNull().getObjectField(&quot;mReactions&quot;) as List&lt;*&gt;).map { UserIdToReaction(it!!) }
</a><a href="#h4-0-20" id="h4-0-20" class="i">+    }
</a> } 
\ No newline at end of file
<b>diff --git a/<a id="h5" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/UserIdToReaction.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/UserIdToReaction.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/UserIdToReaction.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/UserIdToReaction.kt</a></b>
<a href="#h5-0" id="h5-0" class="h">@@ -0,0 +1,11 @@
</a><a href="#h5-0-0" id="h5-0-0" class="i">+package me.rhunk.snapenhance.data.wrapper.impl
</a><a href="#h5-0-1" id="h5-0-1" class="i">+
</a><a href="#h5-0-2" id="h5-0-2" class="i">+import me.rhunk.snapenhance.data.wrapper.AbstractWrapper
</a><a href="#h5-0-3" id="h5-0-3" class="i">+import me.rhunk.snapenhance.util.getObjectField
</a><a href="#h5-0-4" id="h5-0-4" class="i">+
</a><a href="#h5-0-5" id="h5-0-5" class="i">+class UserIdToReaction(obj: Any?) : AbstractWrapper(obj) {
</a><a href="#h5-0-6" id="h5-0-6" class="i">+    val userId = SnapUUID(instanceNonNull().getObjectField(&quot;mUserId&quot;))
</a><a href="#h5-0-7" id="h5-0-7" class="i">+    val reactionId = (instanceNonNull().getObjectField(&quot;mReaction&quot;)
</a><a href="#h5-0-8" id="h5-0-8" class="i">+        ?.getObjectField(&quot;mReactionContent&quot;)
</a><a href="#h5-0-9" id="h5-0-9" class="i">+        ?.getObjectField(&quot;mIntentionType&quot;) as Long?) ?: 0
</a><a href="#h5-0-10" id="h5-0-10" class="i">+}</a><a href="#h5-0-11" id="h5-0-11" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h6" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/manager/impl/ActionManager.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/manager/impl/ActionManager.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/manager/impl/ActionManager.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/manager/impl/ActionManager.kt</a></b>
<a href="#h6-0" id="h6-0" class="h">@@ -5,6 +5,7 @@ import me.rhunk.snapenhance.action.AbstractAction
</a> import me.rhunk.snapenhance.action.impl.CheckForUpdates
 import me.rhunk.snapenhance.action.impl.CleanCache
 import me.rhunk.snapenhance.action.impl.ClearMessageLogger
<a href="#h6-0-3" id="h6-0-3" class="i">+import me.rhunk.snapenhance.action.impl.ExportChatMessages
</a> import me.rhunk.snapenhance.action.impl.OpenMap
 import me.rhunk.snapenhance.action.impl.RefreshMappings
 import me.rhunk.snapenhance.manager.Manager
<a href="#h6-1" id="h6-1" class="h">@@ -26,6 +27,7 @@ class ActionManager(
</a>         load(RefreshMappings::class)
         load(OpenMap::class)
         load(CheckForUpdates::class)
<a href="#h6-1-3" id="h6-1-3" class="i">+        load(ExportChatMessages::class)
</a> 
         actions.values.forEach(AbstractAction::init)
     }
<b>diff --git a/<a id="h7" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/util/CallbackBuilder.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/util/CallbackBuilder.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/util/CallbackBuilder.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/util/CallbackBuilder.kt</a></b>
<a href="#h7-0" id="h7-0" class="h">@@ -13,13 +13,14 @@ class CallbackBuilder(
</a> ) {
     internal class Override(
         val methodName: String,
<a href="#h7-0-3" id="h7-0-3" class="i">+        val shouldUnhook: Boolean = true,
</a>         val callback: (HookAdapter) -&gt; Unit
     )
 
     private val methodOverrides = mutableListOf&lt;Override&gt;()
 
<a href="#h7-0-9" id="h7-0-9" class="d">-    fun override(methodName: String, callback: (HookAdapter) -&gt; Unit = {}): CallbackBuilder {
</a><a href="#h7-0-10" id="h7-0-10" class="d">-        methodOverrides.add(Override(methodName, callback))
</a><a href="#h7-0-11" id="h7-0-11" class="i">+    fun override(methodName: String, shouldUnhook: Boolean = true, callback: (HookAdapter) -&gt; Unit = {}): CallbackBuilder {
</a><a href="#h7-0-12" id="h7-0-12" class="i">+        methodOverrides.add(Override(methodName, shouldUnhook, callback))
</a>         return this
     }
 
<a href="#h7-1" id="h7-1" class="h">@@ -46,9 +47,7 @@ class CallbackBuilder(
</a>                 //checking invokerField ensure that&#39;s the callback was created by the CallbackBuilder
                 if (invokerField.get(it.thisObject()) != null) return@defaultHook false
                 if ((it.thisObject() as Any).hashCode() != callbackInstanceHashCode) return@defaultHook false
<a href="#h7-1-3" id="h7-1-3" class="d">-
</a>                 it.setResult(null)
<a href="#h7-1-5" id="h7-1-5" class="d">-                unhooks.forEach { unhook -&gt; unhook.unhook() }
</a>                 true
             }
 
<a href="#h7-2" id="h7-2" class="h">@@ -59,6 +58,7 @@ class CallbackBuilder(
</a>                 hook = {
                     if (defaultHook(it)) {
                         callback(it)
<a href="#h7-2-3" id="h7-2-3" class="i">+                        if (shouldUnhook) unhooks.forEach { unhook -&gt; unhook.unhook() }
</a>                     }
                 }
             }
<b>diff --git a/<a id="h8" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/util/download/RemoteMediaResolver.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/util/download/RemoteMediaResolver.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/util/download/RemoteMediaResolver.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/util/download/RemoteMediaResolver.kt</a></b>
<a href="#h8-0" id="h8-0" class="h">@@ -16,6 +16,8 @@ object RemoteMediaResolver {
</a> 
     private val okHttpClient = OkHttpClient.Builder()
         .followRedirects(true)
<a href="#h8-0-3" id="h8-0-3" class="i">+        .retryOnConnectionFailure(true)
</a><a href="#h8-0-4" id="h8-0-4" class="i">+        .readTimeout(20, java.util.concurrent.TimeUnit.SECONDS)
</a>         .addInterceptor { chain -&gt;
             val request = chain.request()
             val requestUrl = request.url.toString()
<b>diff --git a/<a id="h9" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/util/export/MessageExporter.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/util/export/MessageExporter.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/util/export/MessageExporter.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/util/export/MessageExporter.kt</a></b>
<a href="#h9-0" id="h9-0" class="h">@@ -0,0 +1,336 @@
</a><a href="#h9-0-0" id="h9-0-0" class="i">+package me.rhunk.snapenhance.util.export
</a><a href="#h9-0-1" id="h9-0-1" class="i">+
</a><a href="#h9-0-2" id="h9-0-2" class="i">+import android.content.pm.PackageManager
</a><a href="#h9-0-3" id="h9-0-3" class="i">+import android.os.Environment
</a><a href="#h9-0-4" id="h9-0-4" class="i">+import android.util.Base64InputStream
</a><a href="#h9-0-5" id="h9-0-5" class="i">+import com.google.gson.JsonArray
</a><a href="#h9-0-6" id="h9-0-6" class="i">+import com.google.gson.JsonObject
</a><a href="#h9-0-7" id="h9-0-7" class="i">+import de.robv.android.xposed.XposedHelpers
</a><a href="#h9-0-8" id="h9-0-8" class="i">+import kotlinx.coroutines.Dispatchers
</a><a href="#h9-0-9" id="h9-0-9" class="i">+import kotlinx.coroutines.async
</a><a href="#h9-0-10" id="h9-0-10" class="i">+import kotlinx.coroutines.awaitAll
</a><a href="#h9-0-11" id="h9-0-11" class="i">+import kotlinx.coroutines.withContext
</a><a href="#h9-0-12" id="h9-0-12" class="i">+import me.rhunk.snapenhance.BuildConfig
</a><a href="#h9-0-13" id="h9-0-13" class="i">+import me.rhunk.snapenhance.Logger
</a><a href="#h9-0-14" id="h9-0-14" class="i">+import me.rhunk.snapenhance.ModContext
</a><a href="#h9-0-15" id="h9-0-15" class="i">+import me.rhunk.snapenhance.data.ContentType
</a><a href="#h9-0-16" id="h9-0-16" class="i">+import me.rhunk.snapenhance.data.FileType
</a><a href="#h9-0-17" id="h9-0-17" class="i">+import me.rhunk.snapenhance.data.MediaReferenceType
</a><a href="#h9-0-18" id="h9-0-18" class="i">+import me.rhunk.snapenhance.data.wrapper.impl.Message
</a><a href="#h9-0-19" id="h9-0-19" class="i">+import me.rhunk.snapenhance.data.wrapper.impl.SnapUUID
</a><a href="#h9-0-20" id="h9-0-20" class="i">+import me.rhunk.snapenhance.database.objects.FriendFeedInfo
</a><a href="#h9-0-21" id="h9-0-21" class="i">+import me.rhunk.snapenhance.database.objects.FriendInfo
</a><a href="#h9-0-22" id="h9-0-22" class="i">+import me.rhunk.snapenhance.util.protobuf.ProtoReader
</a><a href="#h9-0-23" id="h9-0-23" class="i">+import me.rhunk.snapenhance.util.snap.EncryptionHelper
</a><a href="#h9-0-24" id="h9-0-24" class="i">+import me.rhunk.snapenhance.util.snap.MediaDownloaderHelper
</a><a href="#h9-0-25" id="h9-0-25" class="i">+import java.io.File
</a><a href="#h9-0-26" id="h9-0-26" class="i">+import java.io.FileOutputStream
</a><a href="#h9-0-27" id="h9-0-27" class="i">+import java.io.InputStream
</a><a href="#h9-0-28" id="h9-0-28" class="i">+import java.io.OutputStream
</a><a href="#h9-0-29" id="h9-0-29" class="i">+import java.text.SimpleDateFormat
</a><a href="#h9-0-30" id="h9-0-30" class="i">+import java.util.Base64
</a><a href="#h9-0-31" id="h9-0-31" class="i">+import java.util.Collections
</a><a href="#h9-0-32" id="h9-0-32" class="i">+import java.util.Date
</a><a href="#h9-0-33" id="h9-0-33" class="i">+import java.util.Locale
</a><a href="#h9-0-34" id="h9-0-34" class="i">+import java.util.zip.Deflater
</a><a href="#h9-0-35" id="h9-0-35" class="i">+import java.util.zip.DeflaterInputStream
</a><a href="#h9-0-36" id="h9-0-36" class="i">+import java.util.zip.ZipFile
</a><a href="#h9-0-37" id="h9-0-37" class="i">+import kotlin.io.encoding.ExperimentalEncodingApi
</a><a href="#h9-0-38" id="h9-0-38" class="i">+
</a><a href="#h9-0-39" id="h9-0-39" class="i">+
</a><a href="#h9-0-40" id="h9-0-40" class="i">+enum class ExportFormat(
</a><a href="#h9-0-41" id="h9-0-41" class="i">+    val extension: String,
</a><a href="#h9-0-42" id="h9-0-42" class="i">+){
</a><a href="#h9-0-43" id="h9-0-43" class="i">+    JSON(&quot;json&quot;),
</a><a href="#h9-0-44" id="h9-0-44" class="i">+    TEXT(&quot;txt&quot;),
</a><a href="#h9-0-45" id="h9-0-45" class="i">+    HTML(&quot;html&quot;);
</a><a href="#h9-0-46" id="h9-0-46" class="i">+}
</a><a href="#h9-0-47" id="h9-0-47" class="i">+
</a><a href="#h9-0-48" id="h9-0-48" class="i">+class MessageExporter(
</a><a href="#h9-0-49" id="h9-0-49" class="i">+    private val context: ModContext,
</a><a href="#h9-0-50" id="h9-0-50" class="i">+    private val outputFile: File,
</a><a href="#h9-0-51" id="h9-0-51" class="i">+    private val friendFeedInfo: FriendFeedInfo,
</a><a href="#h9-0-52" id="h9-0-52" class="i">+    private val mediaToDownload: List&lt;ContentType&gt;? = null,
</a><a href="#h9-0-53" id="h9-0-53" class="i">+    private val printLog: (String) -&gt; Unit = {},
</a><a href="#h9-0-54" id="h9-0-54" class="i">+) {
</a><a href="#h9-0-55" id="h9-0-55" class="i">+    private lateinit var conversationParticipants: Map&lt;String, FriendInfo&gt;
</a><a href="#h9-0-56" id="h9-0-56" class="i">+    private lateinit var messages: List&lt;Message&gt;
</a><a href="#h9-0-57" id="h9-0-57" class="i">+
</a><a href="#h9-0-58" id="h9-0-58" class="i">+    fun readMessages(messages: List&lt;Message&gt;) {
</a><a href="#h9-0-59" id="h9-0-59" class="i">+        conversationParticipants =
</a><a href="#h9-0-60" id="h9-0-60" class="i">+            context.database.getConversationParticipants(friendFeedInfo.key!!)
</a><a href="#h9-0-61" id="h9-0-61" class="i">+                ?.mapNotNull {
</a><a href="#h9-0-62" id="h9-0-62" class="i">+                    context.database.getFriendInfo(it)
</a><a href="#h9-0-63" id="h9-0-63" class="i">+                }?.associateBy { it.userId!! } ?: emptyMap()
</a><a href="#h9-0-64" id="h9-0-64" class="i">+
</a><a href="#h9-0-65" id="h9-0-65" class="i">+        if (conversationParticipants.isEmpty())
</a><a href="#h9-0-66" id="h9-0-66" class="i">+            throw Throwable(&quot;Failed to get conversation participants for ${friendFeedInfo.key}&quot;)
</a><a href="#h9-0-67" id="h9-0-67" class="i">+
</a><a href="#h9-0-68" id="h9-0-68" class="i">+        this.messages = messages.sortedBy { it.orderKey }
</a><a href="#h9-0-69" id="h9-0-69" class="i">+    }
</a><a href="#h9-0-70" id="h9-0-70" class="i">+
</a><a href="#h9-0-71" id="h9-0-71" class="i">+    private fun serializeMessageContent(message: Message): String? {
</a><a href="#h9-0-72" id="h9-0-72" class="i">+        return if (message.messageContent.contentType == ContentType.CHAT) {
</a><a href="#h9-0-73" id="h9-0-73" class="i">+            ProtoReader(message.messageContent.content).getString(2, 1) ?: &quot;Failed to parse message&quot;
</a><a href="#h9-0-74" id="h9-0-74" class="i">+        } else null
</a><a href="#h9-0-75" id="h9-0-75" class="i">+    }
</a><a href="#h9-0-76" id="h9-0-76" class="i">+
</a><a href="#h9-0-77" id="h9-0-77" class="i">+    private fun exportText(output: OutputStream) {
</a><a href="#h9-0-78" id="h9-0-78" class="i">+        val writer = output.bufferedWriter()
</a><a href="#h9-0-79" id="h9-0-79" class="i">+        writer.write(&quot;Conversation key: ${friendFeedInfo.key}\n&quot;)
</a><a href="#h9-0-80" id="h9-0-80" class="i">+        writer.write(&quot;Conversation Name: ${friendFeedInfo.feedDisplayName}\n&quot;)
</a><a href="#h9-0-81" id="h9-0-81" class="i">+        writer.write(&quot;Participants:\n&quot;)
</a><a href="#h9-0-82" id="h9-0-82" class="i">+        conversationParticipants.forEach { (userId, friendInfo) -&gt;
</a><a href="#h9-0-83" id="h9-0-83" class="i">+            writer.write(&quot;  $userId: ${friendInfo.displayName}\n&quot;)
</a><a href="#h9-0-84" id="h9-0-84" class="i">+        }
</a><a href="#h9-0-85" id="h9-0-85" class="i">+
</a><a href="#h9-0-86" id="h9-0-86" class="i">+        writer.write(&quot;\nMessages:\n&quot;)
</a><a href="#h9-0-87" id="h9-0-87" class="i">+        messages.forEach { message -&gt;
</a><a href="#h9-0-88" id="h9-0-88" class="i">+            val sender = conversationParticipants[message.senderId.toString()]
</a><a href="#h9-0-89" id="h9-0-89" class="i">+            val senderUsername = sender?.usernameForSorting ?: message.senderId.toString()
</a><a href="#h9-0-90" id="h9-0-90" class="i">+            val senderDisplayName = sender?.displayName ?: message.senderId.toString()
</a><a href="#h9-0-91" id="h9-0-91" class="i">+            val messageContent = serializeMessageContent(message) ?: &quot;Failed to parse message&quot;
</a><a href="#h9-0-92" id="h9-0-92" class="i">+            val date = SimpleDateFormat(&quot;yyyy-MM-dd HH:mm:ss&quot;, Locale.ENGLISH).format(Date(message.messageMetadata.createdAt))
</a><a href="#h9-0-93" id="h9-0-93" class="i">+            writer.write(&quot;[$date] - $senderDisplayName (${senderUsername}): $messageContent\n&quot;)
</a><a href="#h9-0-94" id="h9-0-94" class="i">+        }
</a><a href="#h9-0-95" id="h9-0-95" class="i">+        writer.flush()
</a><a href="#h9-0-96" id="h9-0-96" class="i">+    }
</a><a href="#h9-0-97" id="h9-0-97" class="i">+
</a><a href="#h9-0-98" id="h9-0-98" class="i">+    @OptIn(ExperimentalEncodingApi::class)
</a><a href="#h9-0-99" id="h9-0-99" class="i">+    suspend fun exportHtml(output: OutputStream) {
</a><a href="#h9-0-100" id="h9-0-100" class="i">+        val downloadMediaCacheFolder = File(Environment.getExternalStoragePublicDirectory(Environment.DIRECTORY_DOWNLOADS), &quot;SnapEnhance/cache&quot;).also { it.mkdirs() }
</a><a href="#h9-0-101" id="h9-0-101" class="i">+        val mediaFiles = Collections.synchronizedMap(mutableMapOf&lt;String, Pair&lt;FileType, File&gt;&gt;())
</a><a href="#h9-0-102" id="h9-0-102" class="i">+
</a><a href="#h9-0-103" id="h9-0-103" class="i">+        printLog(&quot;found ${messages.size} messages&quot;)
</a><a href="#h9-0-104" id="h9-0-104" class="i">+
</a><a href="#h9-0-105" id="h9-0-105" class="i">+        withContext(Dispatchers.IO) {
</a><a href="#h9-0-106" id="h9-0-106" class="i">+            messages.filter {
</a><a href="#h9-0-107" id="h9-0-107" class="i">+                mediaToDownload?.contains(it.messageContent.contentType) ?: false
</a><a href="#h9-0-108" id="h9-0-108" class="i">+            }.map { message -&gt;
</a><a href="#h9-0-109" id="h9-0-109" class="i">+                async {
</a><a href="#h9-0-110" id="h9-0-110" class="i">+                    val remoteMediaReferences by lazy {
</a><a href="#h9-0-111" id="h9-0-111" class="i">+                        val serializedMessageContent = context.gson.toJsonTree(message.messageContent.instanceNonNull()).asJsonObject
</a><a href="#h9-0-112" id="h9-0-112" class="i">+                        serializedMessageContent[&quot;mRemoteMediaReferences&quot;]
</a><a href="#h9-0-113" id="h9-0-113" class="i">+                            .asJsonArray.map { it.asJsonObject[&quot;mMediaReferences&quot;].asJsonArray }
</a><a href="#h9-0-114" id="h9-0-114" class="i">+                            .flatten()
</a><a href="#h9-0-115" id="h9-0-115" class="i">+                    }
</a><a href="#h9-0-116" id="h9-0-116" class="i">+
</a><a href="#h9-0-117" id="h9-0-117" class="i">+                    remoteMediaReferences.firstOrNull().takeIf { it != null }?.let { media -&gt;
</a><a href="#h9-0-118" id="h9-0-118" class="i">+                        val protoMediaReference = media.asJsonObject[&quot;mContentObject&quot;].asJsonArray.map { it.asByte }.toByteArray()
</a><a href="#h9-0-119" id="h9-0-119" class="i">+
</a><a href="#h9-0-120" id="h9-0-120" class="i">+                        runCatching {
</a><a href="#h9-0-121" id="h9-0-121" class="i">+                            val downloadedMedia = MediaDownloaderHelper.downloadMediaFromReference(protoMediaReference) {
</a><a href="#h9-0-122" id="h9-0-122" class="i">+                                EncryptionHelper.decryptInputStream(it, message.messageContent.contentType, ProtoReader(message.messageContent.content), isArroyo = false)
</a><a href="#h9-0-123" id="h9-0-123" class="i">+                            }
</a><a href="#h9-0-124" id="h9-0-124" class="i">+
</a><a href="#h9-0-125" id="h9-0-125" class="i">+                            printLog(&quot;downloaded media ${message.orderKey}&quot;)
</a><a href="#h9-0-126" id="h9-0-126" class="i">+
</a><a href="#h9-0-127" id="h9-0-127" class="i">+                            downloadedMedia.forEach { (type, mediaData) -&gt;
</a><a href="#h9-0-128" id="h9-0-128" class="i">+                                val fileType = FileType.fromByteArray(mediaData)
</a><a href="#h9-0-129" id="h9-0-129" class="i">+                                val fileName = &quot;${type}_${kotlin.io.encoding.Base64.UrlSafe.encode(protoMediaReference).replace(&quot;=&quot;, &quot;&quot;)}&quot;
</a><a href="#h9-0-130" id="h9-0-130" class="i">+
</a><a href="#h9-0-131" id="h9-0-131" class="i">+                                val mediaFile = File(downloadMediaCacheFolder, &quot;$fileName.${fileType.fileExtension}&quot;)
</a><a href="#h9-0-132" id="h9-0-132" class="i">+
</a><a href="#h9-0-133" id="h9-0-133" class="i">+                                FileOutputStream(mediaFile).use { fos -&gt;
</a><a href="#h9-0-134" id="h9-0-134" class="i">+                                    mediaData.inputStream().copyTo(fos)
</a><a href="#h9-0-135" id="h9-0-135" class="i">+                                }
</a><a href="#h9-0-136" id="h9-0-136" class="i">+
</a><a href="#h9-0-137" id="h9-0-137" class="i">+                                mediaFiles[fileName] = fileType to mediaFile
</a><a href="#h9-0-138" id="h9-0-138" class="i">+                            }
</a><a href="#h9-0-139" id="h9-0-139" class="i">+                        }.onFailure {
</a><a href="#h9-0-140" id="h9-0-140" class="i">+                            printLog(&quot;failed to download media for ${message.messageDescriptor.conversationId}_${message.orderKey}&quot;)
</a><a href="#h9-0-141" id="h9-0-141" class="i">+                            Logger.error(&quot;failed to download media for ${message.messageDescriptor.conversationId}_${message.orderKey}&quot;, it)
</a><a href="#h9-0-142" id="h9-0-142" class="i">+                        }
</a><a href="#h9-0-143" id="h9-0-143" class="i">+                    }
</a><a href="#h9-0-144" id="h9-0-144" class="i">+                }
</a><a href="#h9-0-145" id="h9-0-145" class="i">+            }.awaitAll()
</a><a href="#h9-0-146" id="h9-0-146" class="i">+        }
</a><a href="#h9-0-147" id="h9-0-147" class="i">+
</a><a href="#h9-0-148" id="h9-0-148" class="i">+        printLog(&quot;writing downloaded medias...&quot;)
</a><a href="#h9-0-149" id="h9-0-149" class="i">+
</a><a href="#h9-0-150" id="h9-0-150" class="i">+        //write the head of the html file
</a><a href="#h9-0-151" id="h9-0-151" class="i">+        output.write(&quot;&quot;&quot;
</a><a href="#h9-0-152" id="h9-0-152" class="i">+            &lt;!DOCTYPE html&gt;
</a><a href="#h9-0-153" id="h9-0-153" class="i">+            &lt;html&gt;
</a><a href="#h9-0-154" id="h9-0-154" class="i">+            &lt;head&gt;
</a><a href="#h9-0-155" id="h9-0-155" class="i">+                &lt;meta charset=&quot;UTF-8&quot;&gt;
</a><a href="#h9-0-156" id="h9-0-156" class="i">+                &lt;meta http-equiv=&quot;X-UA-Compatible&quot; content=&quot;IE=edge&quot;&gt;
</a><a href="#h9-0-157" id="h9-0-157" class="i">+                &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot;&gt;
</a><a href="#h9-0-158" id="h9-0-158" class="i">+                &lt;title&gt;&lt;/title&gt;
</a><a href="#h9-0-159" id="h9-0-159" class="i">+            &lt;/head&gt;
</a><a href="#h9-0-160" id="h9-0-160" class="i">+        &quot;&quot;&quot;.trimIndent().toByteArray())
</a><a href="#h9-0-161" id="h9-0-161" class="i">+
</a><a href="#h9-0-162" id="h9-0-162" class="i">+        output.write(&quot;&lt;!-- This file was generated by SnapEnhance ${BuildConfig.VERSION_NAME} --&gt;\n&quot;.toByteArray())
</a><a href="#h9-0-163" id="h9-0-163" class="i">+
</a><a href="#h9-0-164" id="h9-0-164" class="i">+        mediaFiles.forEach { (key, filePair) -&gt;
</a><a href="#h9-0-165" id="h9-0-165" class="i">+            printLog(&quot;writing $key...&quot;)
</a><a href="#h9-0-166" id="h9-0-166" class="i">+            output.write(&quot;&lt;div class=\&quot;media-$key\&quot;&gt;&lt;!-- &quot;.toByteArray())
</a><a href="#h9-0-167" id="h9-0-167" class="i">+
</a><a href="#h9-0-168" id="h9-0-168" class="i">+            val deflateInputStream = DeflaterInputStream(filePair.second.inputStream(), Deflater(Deflater.BEST_COMPRESSION, true))
</a><a href="#h9-0-169" id="h9-0-169" class="i">+            val base64InputStream = XposedHelpers.newInstance(
</a><a href="#h9-0-170" id="h9-0-170" class="i">+                Base64InputStream::class.java,
</a><a href="#h9-0-171" id="h9-0-171" class="i">+                deflateInputStream,
</a><a href="#h9-0-172" id="h9-0-172" class="i">+                android.util.Base64.DEFAULT or android.util.Base64.NO_WRAP,
</a><a href="#h9-0-173" id="h9-0-173" class="i">+                true
</a><a href="#h9-0-174" id="h9-0-174" class="i">+            ) as InputStream
</a><a href="#h9-0-175" id="h9-0-175" class="i">+            base64InputStream.copyTo(output)
</a><a href="#h9-0-176" id="h9-0-176" class="i">+            deflateInputStream.close()
</a><a href="#h9-0-177" id="h9-0-177" class="i">+
</a><a href="#h9-0-178" id="h9-0-178" class="i">+            output.write(&quot; --&gt;&lt;/div&gt;\n&quot;.toByteArray())
</a><a href="#h9-0-179" id="h9-0-179" class="i">+            output.flush()
</a><a href="#h9-0-180" id="h9-0-180" class="i">+        }
</a><a href="#h9-0-181" id="h9-0-181" class="i">+        printLog(&quot;writing json conversation data...&quot;)
</a><a href="#h9-0-182" id="h9-0-182" class="i">+
</a><a href="#h9-0-183" id="h9-0-183" class="i">+        //write the json file
</a><a href="#h9-0-184" id="h9-0-184" class="i">+        output.write(&quot;&lt;script type=\&quot;application/json\&quot; class=\&quot;exported_content\&quot;&gt;&quot;.toByteArray())
</a><a href="#h9-0-185" id="h9-0-185" class="i">+        exportJson(output)
</a><a href="#h9-0-186" id="h9-0-186" class="i">+        output.write(&quot;&lt;/script&gt;\n&quot;.toByteArray())
</a><a href="#h9-0-187" id="h9-0-187" class="i">+
</a><a href="#h9-0-188" id="h9-0-188" class="i">+        printLog(&quot;writing template...&quot;)
</a><a href="#h9-0-189" id="h9-0-189" class="i">+
</a><a href="#h9-0-190" id="h9-0-190" class="i">+        runCatching {
</a><a href="#h9-0-191" id="h9-0-191" class="i">+            ZipFile(
</a><a href="#h9-0-192" id="h9-0-192" class="i">+                context.androidContext.packageManager.getApplicationInfo(BuildConfig.APPLICATION_ID, PackageManager.GET_META_DATA).publicSourceDir
</a><a href="#h9-0-193" id="h9-0-193" class="i">+            ).use { apkFile -&gt;
</a><a href="#h9-0-194" id="h9-0-194" class="i">+                //export rawinflate.js
</a><a href="#h9-0-195" id="h9-0-195" class="i">+                apkFile.getEntry(&quot;assets/web/rawinflate.js&quot;).let { entry -&gt;
</a><a href="#h9-0-196" id="h9-0-196" class="i">+                    output.write(&quot;&lt;script&gt;&quot;.toByteArray())
</a><a href="#h9-0-197" id="h9-0-197" class="i">+                    apkFile.getInputStream(entry).copyTo(output)
</a><a href="#h9-0-198" id="h9-0-198" class="i">+                    output.write(&quot;&lt;/script&gt;\n&quot;.toByteArray())
</a><a href="#h9-0-199" id="h9-0-199" class="i">+                }
</a><a href="#h9-0-200" id="h9-0-200" class="i">+
</a><a href="#h9-0-201" id="h9-0-201" class="i">+                //export avenir next font
</a><a href="#h9-0-202" id="h9-0-202" class="i">+                apkFile.getEntry(&quot;res/font/avenir_next_medium.ttf&quot;).let { entry -&gt;
</a><a href="#h9-0-203" id="h9-0-203" class="i">+                    val encodedFontData = kotlin.io.encoding.Base64.Default.encode(apkFile.getInputStream(entry).readBytes())
</a><a href="#h9-0-204" id="h9-0-204" class="i">+                    output.write(&quot;&quot;&quot;
</a><a href="#h9-0-205" id="h9-0-205" class="i">+                        &lt;style&gt;
</a><a href="#h9-0-206" id="h9-0-206" class="i">+                            @font-face {
</a><a href="#h9-0-207" id="h9-0-207" class="i">+                                font-family: &#39;Avenir Next&#39;;
</a><a href="#h9-0-208" id="h9-0-208" class="i">+                                src: url(&#39;data:font/truetype;charset=utf-8;base64, $encodedFontData&#39;);
</a><a href="#h9-0-209" id="h9-0-209" class="i">+                                font-weight: normal;
</a><a href="#h9-0-210" id="h9-0-210" class="i">+                                font-style: normal;
</a><a href="#h9-0-211" id="h9-0-211" class="i">+                            }
</a><a href="#h9-0-212" id="h9-0-212" class="i">+                        &lt;/style&gt;
</a><a href="#h9-0-213" id="h9-0-213" class="i">+                    &quot;&quot;&quot;.trimIndent().toByteArray())
</a><a href="#h9-0-214" id="h9-0-214" class="i">+                }
</a><a href="#h9-0-215" id="h9-0-215" class="i">+
</a><a href="#h9-0-216" id="h9-0-216" class="i">+                apkFile.getEntry(&quot;assets/web/export_template.html&quot;).let { entry -&gt;
</a><a href="#h9-0-217" id="h9-0-217" class="i">+                    apkFile.getInputStream(entry).copyTo(output)
</a><a href="#h9-0-218" id="h9-0-218" class="i">+                }
</a><a href="#h9-0-219" id="h9-0-219" class="i">+
</a><a href="#h9-0-220" id="h9-0-220" class="i">+                apkFile.close()
</a><a href="#h9-0-221" id="h9-0-221" class="i">+            }
</a><a href="#h9-0-222" id="h9-0-222" class="i">+        }.onFailure {
</a><a href="#h9-0-223" id="h9-0-223" class="i">+            printLog(&quot;failed to read template from apk&quot;)
</a><a href="#h9-0-224" id="h9-0-224" class="i">+            Logger.error(&quot;failed to read template from apk&quot;, it)
</a><a href="#h9-0-225" id="h9-0-225" class="i">+        }
</a><a href="#h9-0-226" id="h9-0-226" class="i">+
</a><a href="#h9-0-227" id="h9-0-227" class="i">+        output.write(&quot;&lt;/html&gt;&quot;.toByteArray())
</a><a href="#h9-0-228" id="h9-0-228" class="i">+        output.close()
</a><a href="#h9-0-229" id="h9-0-229" class="i">+        printLog(&quot;done&quot;)
</a><a href="#h9-0-230" id="h9-0-230" class="i">+    }
</a><a href="#h9-0-231" id="h9-0-231" class="i">+
</a><a href="#h9-0-232" id="h9-0-232" class="i">+    private fun exportJson(output: OutputStream) {
</a><a href="#h9-0-233" id="h9-0-233" class="i">+        val rootObject = JsonObject().apply {
</a><a href="#h9-0-234" id="h9-0-234" class="i">+            addProperty(&quot;conversationId&quot;, friendFeedInfo.key)
</a><a href="#h9-0-235" id="h9-0-235" class="i">+            addProperty(&quot;conversationName&quot;, friendFeedInfo.feedDisplayName)
</a><a href="#h9-0-236" id="h9-0-236" class="i">+
</a><a href="#h9-0-237" id="h9-0-237" class="i">+            var index = 0
</a><a href="#h9-0-238" id="h9-0-238" class="i">+            val participants = mutableMapOf&lt;String, Int&gt;()
</a><a href="#h9-0-239" id="h9-0-239" class="i">+
</a><a href="#h9-0-240" id="h9-0-240" class="i">+            add(&quot;participants&quot;, JsonObject().apply {
</a><a href="#h9-0-241" id="h9-0-241" class="i">+                conversationParticipants.forEach { (userId, friendInfo) -&gt;
</a><a href="#h9-0-242" id="h9-0-242" class="i">+                    add(userId, JsonObject().apply {
</a><a href="#h9-0-243" id="h9-0-243" class="i">+                        addProperty(&quot;id&quot;, index)
</a><a href="#h9-0-244" id="h9-0-244" class="i">+                        addProperty(&quot;displayName&quot;, friendInfo.displayName)
</a><a href="#h9-0-245" id="h9-0-245" class="i">+                        addProperty(&quot;username&quot;, friendInfo.usernameForSorting)
</a><a href="#h9-0-246" id="h9-0-246" class="i">+                        addProperty(&quot;bitmojiSelfieId&quot;, friendInfo.bitmojiSelfieId)
</a><a href="#h9-0-247" id="h9-0-247" class="i">+                    })
</a><a href="#h9-0-248" id="h9-0-248" class="i">+                    participants[userId] = index++
</a><a href="#h9-0-249" id="h9-0-249" class="i">+                }
</a><a href="#h9-0-250" id="h9-0-250" class="i">+            })
</a><a href="#h9-0-251" id="h9-0-251" class="i">+            add(&quot;messages&quot;, JsonArray().apply {
</a><a href="#h9-0-252" id="h9-0-252" class="i">+                messages.forEach { message -&gt;
</a><a href="#h9-0-253" id="h9-0-253" class="i">+                    add(JsonObject().apply {
</a><a href="#h9-0-254" id="h9-0-254" class="i">+                        addProperty(&quot;orderKey&quot;, message.orderKey)
</a><a href="#h9-0-255" id="h9-0-255" class="i">+                        addProperty(&quot;senderId&quot;, participants.getOrDefault(message.senderId.toString(), -1))
</a><a href="#h9-0-256" id="h9-0-256" class="i">+                        addProperty(&quot;type&quot;, message.messageContent.contentType.toString())
</a><a href="#h9-0-257" id="h9-0-257" class="i">+
</a><a href="#h9-0-258" id="h9-0-258" class="i">+                        fun addUUIDList(name: String, list: List&lt;SnapUUID&gt;) {
</a><a href="#h9-0-259" id="h9-0-259" class="i">+                            add(name, JsonArray().apply {
</a><a href="#h9-0-260" id="h9-0-260" class="i">+                                list.map { participants.getOrDefault(it.toString(), -1) }.forEach { add(it) }
</a><a href="#h9-0-261" id="h9-0-261" class="i">+                            })
</a><a href="#h9-0-262" id="h9-0-262" class="i">+                        }
</a><a href="#h9-0-263" id="h9-0-263" class="i">+
</a><a href="#h9-0-264" id="h9-0-264" class="i">+                        addUUIDList(&quot;savedBy&quot;, message.messageMetadata.savedBy)
</a><a href="#h9-0-265" id="h9-0-265" class="i">+                        addUUIDList(&quot;seenBy&quot;, message.messageMetadata.seenBy)
</a><a href="#h9-0-266" id="h9-0-266" class="i">+                        addUUIDList(&quot;openedBy&quot;, message.messageMetadata.openedBy)
</a><a href="#h9-0-267" id="h9-0-267" class="i">+
</a><a href="#h9-0-268" id="h9-0-268" class="i">+                        add(&quot;reactions&quot;, JsonObject().apply {
</a><a href="#h9-0-269" id="h9-0-269" class="i">+                            message.messageMetadata.reactions.forEach { reaction -&gt;
</a><a href="#h9-0-270" id="h9-0-270" class="i">+                                addProperty(
</a><a href="#h9-0-271" id="h9-0-271" class="i">+                                    participants.getOrDefault(reaction.userId.toString(), -1L).toString(),
</a><a href="#h9-0-272" id="h9-0-272" class="i">+                                    reaction.reactionId
</a><a href="#h9-0-273" id="h9-0-273" class="i">+                                )
</a><a href="#h9-0-274" id="h9-0-274" class="i">+                            }
</a><a href="#h9-0-275" id="h9-0-275" class="i">+                        })
</a><a href="#h9-0-276" id="h9-0-276" class="i">+
</a><a href="#h9-0-277" id="h9-0-277" class="i">+                        addProperty(&quot;createdTimestamp&quot;, message.messageMetadata.createdAt)
</a><a href="#h9-0-278" id="h9-0-278" class="i">+                        addProperty(&quot;readTimestamp&quot;, message.messageMetadata.readAt)
</a><a href="#h9-0-279" id="h9-0-279" class="i">+                        addProperty(&quot;serializedContent&quot;, serializeMessageContent(message))
</a><a href="#h9-0-280" id="h9-0-280" class="i">+                        addProperty(&quot;rawContent&quot;, Base64.getUrlEncoder().encodeToString(message.messageContent.content))
</a><a href="#h9-0-281" id="h9-0-281" class="i">+
</a><a href="#h9-0-282" id="h9-0-282" class="i">+                        val messageContentType = message.messageContent.contentType
</a><a href="#h9-0-283" id="h9-0-283" class="i">+
</a><a href="#h9-0-284" id="h9-0-284" class="i">+                        EncryptionHelper.getEncryptionKeys(messageContentType, ProtoReader(message.messageContent.content), isArroyo = false)?.let { encryptionKeyPair -&gt;
</a><a href="#h9-0-285" id="h9-0-285" class="i">+                            add(&quot;encryption&quot;, JsonObject().apply encryption@{
</a><a href="#h9-0-286" id="h9-0-286" class="i">+                                addProperty(&quot;key&quot;, Base64.getEncoder().encodeToString(encryptionKeyPair.first))
</a><a href="#h9-0-287" id="h9-0-287" class="i">+                                addProperty(&quot;iv&quot;, Base64.getEncoder().encodeToString(encryptionKeyPair.second))
</a><a href="#h9-0-288" id="h9-0-288" class="i">+                            })
</a><a href="#h9-0-289" id="h9-0-289" class="i">+                        }
</a><a href="#h9-0-290" id="h9-0-290" class="i">+
</a><a href="#h9-0-291" id="h9-0-291" class="i">+                        val remoteMediaReferences by lazy {
</a><a href="#h9-0-292" id="h9-0-292" class="i">+                            val serializedMessageContent = context.gson.toJsonTree(message.messageContent.instanceNonNull()).asJsonObject
</a><a href="#h9-0-293" id="h9-0-293" class="i">+                            serializedMessageContent[&quot;mRemoteMediaReferences&quot;]
</a><a href="#h9-0-294" id="h9-0-294" class="i">+                                .asJsonArray.map { it.asJsonObject[&quot;mMediaReferences&quot;].asJsonArray }
</a><a href="#h9-0-295" id="h9-0-295" class="i">+                                .flatten()
</a><a href="#h9-0-296" id="h9-0-296" class="i">+                        }
</a><a href="#h9-0-297" id="h9-0-297" class="i">+
</a><a href="#h9-0-298" id="h9-0-298" class="i">+                        add(&quot;mediaReferences&quot;, JsonArray().apply mediaReferences@ {
</a><a href="#h9-0-299" id="h9-0-299" class="i">+                            if (messageContentType != ContentType.EXTERNAL_MEDIA &amp;&amp;
</a><a href="#h9-0-300" id="h9-0-300" class="i">+                                messageContentType != ContentType.STICKER &amp;&amp;
</a><a href="#h9-0-301" id="h9-0-301" class="i">+                                messageContentType != ContentType.SNAP &amp;&amp;
</a><a href="#h9-0-302" id="h9-0-302" class="i">+                                messageContentType != ContentType.NOTE)
</a><a href="#h9-0-303" id="h9-0-303" class="i">+                                return@mediaReferences
</a><a href="#h9-0-304" id="h9-0-304" class="i">+
</a><a href="#h9-0-305" id="h9-0-305" class="i">+                            remoteMediaReferences.forEach { media -&gt;
</a><a href="#h9-0-306" id="h9-0-306" class="i">+                                val protoMediaReference = media.asJsonObject[&quot;mContentObject&quot;].asJsonArray.map { it.asByte }.toByteArray()
</a><a href="#h9-0-307" id="h9-0-307" class="i">+                                val mediaType = MediaReferenceType.valueOf(media.asJsonObject[&quot;mMediaType&quot;].asString)
</a><a href="#h9-0-308" id="h9-0-308" class="i">+                                add(JsonObject().apply {
</a><a href="#h9-0-309" id="h9-0-309" class="i">+                                    addProperty(&quot;mediaType&quot;, mediaType.toString())
</a><a href="#h9-0-310" id="h9-0-310" class="i">+                                    addProperty(&quot;content&quot;, Base64.getUrlEncoder().encodeToString(protoMediaReference))
</a><a href="#h9-0-311" id="h9-0-311" class="i">+                                })
</a><a href="#h9-0-312" id="h9-0-312" class="i">+                            }
</a><a href="#h9-0-313" id="h9-0-313" class="i">+                        })
</a><a href="#h9-0-314" id="h9-0-314" class="i">+
</a><a href="#h9-0-315" id="h9-0-315" class="i">+                    })
</a><a href="#h9-0-316" id="h9-0-316" class="i">+                }
</a><a href="#h9-0-317" id="h9-0-317" class="i">+            })
</a><a href="#h9-0-318" id="h9-0-318" class="i">+        }
</a><a href="#h9-0-319" id="h9-0-319" class="i">+
</a><a href="#h9-0-320" id="h9-0-320" class="i">+        output.write(context.gson.toJson(rootObject).toByteArray())
</a><a href="#h9-0-321" id="h9-0-321" class="i">+        output.flush()
</a><a href="#h9-0-322" id="h9-0-322" class="i">+    }
</a><a href="#h9-0-323" id="h9-0-323" class="i">+
</a><a href="#h9-0-324" id="h9-0-324" class="i">+    suspend fun exportTo(exportFormat: ExportFormat) {
</a><a href="#h9-0-325" id="h9-0-325" class="i">+        val output = FileOutputStream(outputFile)
</a><a href="#h9-0-326" id="h9-0-326" class="i">+
</a><a href="#h9-0-327" id="h9-0-327" class="i">+        when (exportFormat) {
</a><a href="#h9-0-328" id="h9-0-328" class="i">+            ExportFormat.HTML -&gt; exportHtml(output)
</a><a href="#h9-0-329" id="h9-0-329" class="i">+            ExportFormat.JSON -&gt; exportJson(output)
</a><a href="#h9-0-330" id="h9-0-330" class="i">+            ExportFormat.TEXT -&gt; exportText(output)
</a><a href="#h9-0-331" id="h9-0-331" class="i">+        }
</a><a href="#h9-0-332" id="h9-0-332" class="i">+
</a><a href="#h9-0-333" id="h9-0-333" class="i">+        output.close()
</a><a href="#h9-0-334" id="h9-0-334" class="i">+    }
</a><a href="#h9-0-335" id="h9-0-335" class="i">+}</a><a href="#h9-0-336" id="h9-0-336" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h10" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/util/snap/EncryptionHelper.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/util/snap/EncryptionHelper.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/util/snap/EncryptionHelper.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/util/snap/EncryptionHelper.kt</a></b>
<a href="#h10-0" id="h10-0" class="h">@@ -12,28 +12,24 @@ import javax.crypto.spec.SecretKeySpec
</a> 
 object EncryptionHelper {
     fun getEncryptionKeys(contentType: ContentType, messageProto: ProtoReader, isArroyo: Boolean): Pair&lt;ByteArray, ByteArray&gt;? {
<a href="#h10-0-3" id="h10-0-3" class="d">-        val messageMediaInfo =
</a><a href="#h10-0-4" id="h10-0-4" class="d">-            MediaDownloaderHelper.getMessageMediaInfo(messageProto, contentType, isArroyo)
</a><a href="#h10-0-5" id="h10-0-5" class="d">-
</a><a href="#h10-0-6" id="h10-0-6" class="d">-        return messageMediaInfo?.let {  mediaEncryption -&gt;
</a><a href="#h10-0-7" id="h10-0-7" class="d">-            val encryptionProtoIndex: Int = if (mediaEncryption.exists(Constants.ENCRYPTION_PROTO_INDEX_V2)) {
</a><a href="#h10-0-8" id="h10-0-8" class="d">-                Constants.ENCRYPTION_PROTO_INDEX_V2
</a><a href="#h10-0-9" id="h10-0-9" class="d">-            } else {
</a><a href="#h10-0-10" id="h10-0-10" class="d">-                Constants.ENCRYPTION_PROTO_INDEX
</a><a href="#h10-0-11" id="h10-0-11" class="d">-            }
</a><a href="#h10-0-12" id="h10-0-12" class="d">-
</a><a href="#h10-0-13" id="h10-0-13" class="d">-            val encryptionProto = mediaEncryption.readPath(encryptionProtoIndex) ?: return null
</a><a href="#h10-0-14" id="h10-0-14" class="d">-            var key: ByteArray = encryptionProto.getByteArray(1)!!
</a><a href="#h10-0-15" id="h10-0-15" class="d">-            var iv: ByteArray = encryptionProto.getByteArray(2)!!
</a><a href="#h10-0-16" id="h10-0-16" class="i">+        val messageMediaInfo = MediaDownloaderHelper.getMessageMediaInfo(messageProto, contentType, isArroyo) ?: return null
</a><a href="#h10-0-17" id="h10-0-17" class="i">+        val encryptionProtoIndex = if (messageMediaInfo.exists(Constants.ENCRYPTION_PROTO_INDEX_V2)) {
</a><a href="#h10-0-18" id="h10-0-18" class="i">+            Constants.ENCRYPTION_PROTO_INDEX_V2
</a><a href="#h10-0-19" id="h10-0-19" class="i">+        } else {
</a><a href="#h10-0-20" id="h10-0-20" class="i">+            Constants.ENCRYPTION_PROTO_INDEX
</a><a href="#h10-0-21" id="h10-0-21" class="i">+        }
</a><a href="#h10-0-22" id="h10-0-22" class="i">+        val encryptionProto = messageMediaInfo.readPath(encryptionProtoIndex) ?: return null
</a> 
<a href="#h10-0-24" id="h10-0-24" class="d">-            if (encryptionProtoIndex == Constants.ENCRYPTION_PROTO_INDEX_V2) {
</a><a href="#h10-0-25" id="h10-0-25" class="d">-                val decoder = Base64.getMimeDecoder()
</a><a href="#h10-0-26" id="h10-0-26" class="d">-                key = decoder.decode(key)
</a><a href="#h10-0-27" id="h10-0-27" class="d">-                iv = decoder.decode(iv)
</a><a href="#h10-0-28" id="h10-0-28" class="d">-            }
</a><a href="#h10-0-29" id="h10-0-29" class="i">+        var key: ByteArray = encryptionProto.getByteArray(1)!!
</a><a href="#h10-0-30" id="h10-0-30" class="i">+        var iv: ByteArray = encryptionProto.getByteArray(2)!!
</a> 
<a href="#h10-0-32" id="h10-0-32" class="d">-            return Pair(key, iv)
</a><a href="#h10-0-33" id="h10-0-33" class="i">+        if (encryptionProtoIndex == Constants.ENCRYPTION_PROTO_INDEX_V2) {
</a><a href="#h10-0-34" id="h10-0-34" class="i">+            val decoder = Base64.getMimeDecoder()
</a><a href="#h10-0-35" id="h10-0-35" class="i">+            key = decoder.decode(key)
</a><a href="#h10-0-36" id="h10-0-36" class="i">+            iv = decoder.decode(iv)
</a>         }
<a href="#h10-0-38" id="h10-0-38" class="i">+
</a><a href="#h10-0-39" id="h10-0-39" class="i">+        return Pair(key, iv)
</a>     }
 
     fun decryptInputStream(
<b>diff --git a/<a id="h11" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/util/snap/MediaDownloaderHelper.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/util/snap/MediaDownloaderHelper.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/util/snap/MediaDownloaderHelper.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/util/snap/MediaDownloaderHelper.kt</a></b>
<a href="#h11-0" id="h11-0" class="h">@@ -28,7 +28,7 @@ object MediaDownloaderHelper {
</a>             ContentType.NOTE -&gt; messageContainerPath.readPath(*mediaContainerPath)
             ContentType.SNAP -&gt; messageContainerPath.readPath(*(intArrayOf(11) + mediaContainerPath))
             ContentType.EXTERNAL_MEDIA -&gt; messageContainerPath.readPath(*(intArrayOf(3, 3) + mediaContainerPath))
<a href="#h11-0-3" id="h11-0-3" class="d">-            else -&gt; throw IllegalArgumentException(&quot;Invalid content type: $contentType&quot;)
</a><a href="#h11-0-4" id="h11-0-4" class="i">+            else -&gt; null
</a>         }
     }
 
<b>diff --git a/<a id="h12" href="../file/app/src/main/res/font/avenir_next_medium.ttf.html">app/src/main/res/font/avenir_next_medium.ttf</a> b/<a href="../file/app/src/main/res/font/avenir_next_medium.ttf.html">app/src/main/res/font/avenir_next_medium.ttf</a></b>
Binary files differ.
</pre>
</div>
</body>
</html>
