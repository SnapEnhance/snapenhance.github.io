<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>feat: reply from notifications - SnapEnhance - An Xposed module offering an enhanced Snapchat experience
</title>
<link rel="icon" type="image/svg+xml" href="../../logo.png"/>
<link rel="alternate icon" href="../../favicon.png"/>
<link rel="alternate" type="application/atom+xml" title="SnapEnhance Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="SnapEnhance Atom Feed (tags)" href="../tags.xml" />
<link rel="stylesheet" type="text/css" href="../../style.css" />
<link rel="stylesheet" type="text/css" href="../../fonts.css" />
</head>
<body>
<div id="head"><table><tr><td><a class="logo" href="../../"><img src="../../logo.png" alt="" width="32" height="32" /></a></td><td><strong>SnapEnhance</strong><span class="desc"> - An Xposed module offering an enhanced Snapchat experience
</span>
</td></tr></table>
<p><a href="../about.html">About</a> | <a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/LICENSE.html">License</a></p>
</div>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/6f3251de5106ba1e1c9bd2e940a2bb996ddf4396.html">6f3251de5106ba1e1c9bd2e940a2bb996ddf4396</a>
<b>parent</b> <a href="../commit/7ff124a9eb41693f91be457c2be55f24972c5dd2.html">7ff124a9eb41693f91be457c2be55f24972c5dd2</a>
<b>Author:</b> rhunk &lt;<a href="mailto:101876869+rhunk@users.noreply.github.com">101876869+rhunk@users.noreply.github.com</a>&gt;
<b>Date:</b>   Mon, 29 May 2023 10:56:15 +0200

feat: reply from notifications

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">app/src/main/kotlin/me/rhunk/snapenhance/ModContext.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">app/src/main/kotlin/me/rhunk/snapenhance/config/ConfigProperty.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="A">A</td><td><a href="#h2">app/src/main/kotlin/me/rhunk/snapenhance/data/MessageSender.kt</a></td><td> | </td><td class="num">165</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h3">app/src/main/kotlin/me/rhunk/snapenhance/data/SnapClassCache.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h4">app/src/main/kotlin/me/rhunk/snapenhance/data/SnapEnums.kt</a></td><td> | </td><td class="num">93</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h5">app/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/AbstractWrapper.kt</a></td><td> | </td><td class="num">7</td><td><span class="i">+++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h6">app/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/MessageDestinations.kt</a></td><td> | </td><td class="num">15</td><td><span class="i">+++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h7">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/extras/GalleryMediaSendOverride.kt</a></td><td> | </td><td class="num">45</td><td><span class="i">+++++</span><span class="d">----------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h8">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/extras/Notifications.kt</a></td><td> | </td><td class="num">91</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">---</span></td></tr>
<tr><td class="M">M</td><td><a href="#h9">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/privacy/DisableMetrics.kt</a></td><td> | </td><td class="num">3</td><td><span class="i"></span><span class="d">---</span></td></tr>
<tr><td class="M">M</td><td><a href="#h10">app/src/main/kotlin/me/rhunk/snapenhance/manager/impl/MappingManager.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h11">app/src/main/kotlin/me/rhunk/snapenhance/mapping/impl/PlatformAnalyticsCreatorMapper.kt</a></td><td> | </td><td class="num">27</td><td><span class="i">+++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h12">app/src/main/kotlin/me/rhunk/snapenhance/util/CallbackBuilder.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
</table></pre><pre>13 files changed, 408 insertions(+), 48 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ModContext.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ModContext.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ModContext.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ModContext.kt</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -11,6 +11,7 @@ import android.widget.Toast
</a> import com.google.gson.Gson
 import com.google.gson.GsonBuilder
 import me.rhunk.snapenhance.bridge.AbstractBridgeClient
<a href="#h0-0-3" id="h0-0-3" class="i">+import me.rhunk.snapenhance.data.MessageSender
</a> import me.rhunk.snapenhance.database.DatabaseAccess
 import me.rhunk.snapenhance.features.Feature
 import me.rhunk.snapenhance.manager.impl.ActionManager
<a href="#h0-1" id="h0-1" class="h">@@ -40,6 +41,7 @@ class ModContext {
</a>     val actionManager = ActionManager(this)
     val database = DatabaseAccess(this)
     val downloadServer = DownloadServer(this)
<a href="#h0-1-3" id="h0-1-3" class="i">+    val messageSender = MessageSender(this)
</a>     val classCache get() = SnapEnhance.classCache
     val resources: Resources get() = androidContext.resources
 
<b>diff --git a/<a id="h1" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/config/ConfigProperty.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/config/ConfigProperty.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/config/ConfigProperty.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/config/ConfigProperty.kt</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -169,7 +169,7 @@ enum class ConfigProperty(
</a>         &quot;description.gallery_media_send_override&quot;,
         ConfigCategory.EXTRAS,
         ConfigStateSelection(
<a href="#h1-0-3" id="h1-0-3" class="d">-            listOf(&quot;OFF&quot;, &quot;NOTE&quot;, &quot;SNAP&quot;),
</a><a href="#h1-0-4" id="h1-0-4" class="i">+            listOf(&quot;OFF&quot;, &quot;NOTE&quot;, &quot;SNAP&quot;, &quot;LIVE_SNAP&quot;),
</a>             &quot;OFF&quot;
         )
     ),
<b>diff --git a/<a id="h2" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/data/MessageSender.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/data/MessageSender.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/data/MessageSender.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/data/MessageSender.kt</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -0,0 +1,164 @@
</a><a href="#h2-0-0" id="h2-0-0" class="i">+package me.rhunk.snapenhance.data
</a><a href="#h2-0-1" id="h2-0-1" class="i">+
</a><a href="#h2-0-2" id="h2-0-2" class="i">+import me.rhunk.snapenhance.ModContext
</a><a href="#h2-0-3" id="h2-0-3" class="i">+import me.rhunk.snapenhance.data.wrapper.AbstractWrapper
</a><a href="#h2-0-4" id="h2-0-4" class="i">+import me.rhunk.snapenhance.data.wrapper.impl.MessageDestinations
</a><a href="#h2-0-5" id="h2-0-5" class="i">+import me.rhunk.snapenhance.data.wrapper.impl.SnapUUID
</a><a href="#h2-0-6" id="h2-0-6" class="i">+import me.rhunk.snapenhance.features.impl.Messaging
</a><a href="#h2-0-7" id="h2-0-7" class="i">+import me.rhunk.snapenhance.util.CallbackBuilder
</a><a href="#h2-0-8" id="h2-0-8" class="i">+import me.rhunk.snapenhance.util.protobuf.ProtoWriter
</a><a href="#h2-0-9" id="h2-0-9" class="i">+
</a><a href="#h2-0-10" id="h2-0-10" class="i">+class MessageSender(
</a><a href="#h2-0-11" id="h2-0-11" class="i">+    private val context: ModContext,
</a><a href="#h2-0-12" id="h2-0-12" class="i">+) {
</a><a href="#h2-0-13" id="h2-0-13" class="i">+    companion object {
</a><a href="#h2-0-14" id="h2-0-14" class="i">+        val redSnapProto: (Boolean) -&gt; ByteArray = {hasAudio -&gt;
</a><a href="#h2-0-15" id="h2-0-15" class="i">+            ProtoWriter().apply {
</a><a href="#h2-0-16" id="h2-0-16" class="i">+                write(11, 5) {
</a><a href="#h2-0-17" id="h2-0-17" class="i">+                    write(1) {
</a><a href="#h2-0-18" id="h2-0-18" class="i">+                        write(1) {
</a><a href="#h2-0-19" id="h2-0-19" class="i">+                            writeConstant(2, 0)
</a><a href="#h2-0-20" id="h2-0-20" class="i">+                            writeConstant(12, 0)
</a><a href="#h2-0-21" id="h2-0-21" class="i">+                            writeConstant(15, 0)
</a><a href="#h2-0-22" id="h2-0-22" class="i">+                        }
</a><a href="#h2-0-23" id="h2-0-23" class="i">+                        writeConstant(6, 0)
</a><a href="#h2-0-24" id="h2-0-24" class="i">+                    }
</a><a href="#h2-0-25" id="h2-0-25" class="i">+                    write(2) {
</a><a href="#h2-0-26" id="h2-0-26" class="i">+                        writeConstant(5, if (hasAudio) 1 else 0)
</a><a href="#h2-0-27" id="h2-0-27" class="i">+                        writeBuffer(6, byteArrayOf())
</a><a href="#h2-0-28" id="h2-0-28" class="i">+                    }
</a><a href="#h2-0-29" id="h2-0-29" class="i">+                }
</a><a href="#h2-0-30" id="h2-0-30" class="i">+            }.toByteArray()
</a><a href="#h2-0-31" id="h2-0-31" class="i">+        }
</a><a href="#h2-0-32" id="h2-0-32" class="i">+
</a><a href="#h2-0-33" id="h2-0-33" class="i">+        val audioNoteProto: (Int) -&gt; ByteArray = { duration -&gt;
</a><a href="#h2-0-34" id="h2-0-34" class="i">+            ProtoWriter().apply {
</a><a href="#h2-0-35" id="h2-0-35" class="i">+                write(6, 1) {
</a><a href="#h2-0-36" id="h2-0-36" class="i">+                    write(1) {
</a><a href="#h2-0-37" id="h2-0-37" class="i">+                        writeConstant(2, 4)
</a><a href="#h2-0-38" id="h2-0-38" class="i">+                        write(5) {
</a><a href="#h2-0-39" id="h2-0-39" class="i">+                            writeConstant(1, 0)
</a><a href="#h2-0-40" id="h2-0-40" class="i">+                            writeConstant(2, 0)
</a><a href="#h2-0-41" id="h2-0-41" class="i">+                        }
</a><a href="#h2-0-42" id="h2-0-42" class="i">+                        writeConstant(7, 0)
</a><a href="#h2-0-43" id="h2-0-43" class="i">+                        writeConstant(13, duration)
</a><a href="#h2-0-44" id="h2-0-44" class="i">+                    }
</a><a href="#h2-0-45" id="h2-0-45" class="i">+                }
</a><a href="#h2-0-46" id="h2-0-46" class="i">+            }.toByteArray()
</a><a href="#h2-0-47" id="h2-0-47" class="i">+        }
</a><a href="#h2-0-48" id="h2-0-48" class="i">+
</a><a href="#h2-0-49" id="h2-0-49" class="i">+    }
</a><a href="#h2-0-50" id="h2-0-50" class="i">+
</a><a href="#h2-0-51" id="h2-0-51" class="i">+    private val sendMessageCallback by lazy { context.mappings.getMappedClass(&quot;callbacks&quot;, &quot;SendMessageCallback&quot;) }
</a><a href="#h2-0-52" id="h2-0-52" class="i">+
</a><a href="#h2-0-53" id="h2-0-53" class="i">+    private val platformAnalyticsCreatorClass by lazy {
</a><a href="#h2-0-54" id="h2-0-54" class="i">+        context.mappings.getMappedClass(&quot;PlatformAnalyticsCreator&quot;)
</a><a href="#h2-0-55" id="h2-0-55" class="i">+    }
</a><a href="#h2-0-56" id="h2-0-56" class="i">+
</a><a href="#h2-0-57" id="h2-0-57" class="i">+    private fun defaultPlatformAnalytics(): ByteArray {
</a><a href="#h2-0-58" id="h2-0-58" class="i">+        val analyticsSource = platformAnalyticsCreatorClass.constructors[0].parameterTypes[0]
</a><a href="#h2-0-59" id="h2-0-59" class="i">+        val chatAnalyticsSource = analyticsSource.enumConstants.first { it.toString() == &quot;CHAT&quot; }
</a><a href="#h2-0-60" id="h2-0-60" class="i">+
</a><a href="#h2-0-61" id="h2-0-61" class="i">+        val platformAnalyticsDefaultArgs = arrayOf(chatAnalyticsSource, null, null, null, null, null, null, null, null, null, 0L, 0L,
</a><a href="#h2-0-62" id="h2-0-62" class="i">+            null, null, false, null, null, 0L, null, null, false, null, null,
</a><a href="#h2-0-63" id="h2-0-63" class="i">+            null, null, null, null, null, null, null, null, null, null, null,
</a><a href="#h2-0-64" id="h2-0-64" class="i">+            null, null, null, null, null, null, false, null, null, false, 0L, -2, 8191)
</a><a href="#h2-0-65" id="h2-0-65" class="i">+
</a><a href="#h2-0-66" id="h2-0-66" class="i">+        val platformAnalyticsInstance = platformAnalyticsCreatorClass.constructors[0].newInstance(
</a><a href="#h2-0-67" id="h2-0-67" class="i">+            *platformAnalyticsDefaultArgs
</a><a href="#h2-0-68" id="h2-0-68" class="i">+        ) ?: throw Exception(&quot;Failed to create platform analytics instance&quot;)
</a><a href="#h2-0-69" id="h2-0-69" class="i">+
</a><a href="#h2-0-70" id="h2-0-70" class="i">+        return platformAnalyticsInstance.javaClass.declaredMethods.first { it.returnType == ByteArray::class.java }
</a><a href="#h2-0-71" id="h2-0-71" class="i">+            .invoke(platformAnalyticsInstance) as ByteArray?
</a><a href="#h2-0-72" id="h2-0-72" class="i">+            ?: throw Exception(&quot;Failed to get platform analytics content&quot;)
</a><a href="#h2-0-73" id="h2-0-73" class="i">+    }
</a><a href="#h2-0-74" id="h2-0-74" class="i">+
</a><a href="#h2-0-75" id="h2-0-75" class="i">+    private fun createLocalMessageContentTemplate(
</a><a href="#h2-0-76" id="h2-0-76" class="i">+        contentType: ContentType,
</a><a href="#h2-0-77" id="h2-0-77" class="i">+        messageContent: ByteArray,
</a><a href="#h2-0-78" id="h2-0-78" class="i">+        localMediaReference: ByteArray? = null,
</a><a href="#h2-0-79" id="h2-0-79" class="i">+        metricMessageMediaType: MetricsMessageMediaType = MetricsMessageMediaType.DERIVED_FROM_MESSAGE_TYPE,
</a><a href="#h2-0-80" id="h2-0-80" class="i">+        metricsMediaType: MetricsMessageType = MetricsMessageType.TEXT,
</a><a href="#h2-0-81" id="h2-0-81" class="i">+        savePolicy: String = &quot;PROHIBITED&quot;,
</a><a href="#h2-0-82" id="h2-0-82" class="i">+    ): String {
</a><a href="#h2-0-83" id="h2-0-83" class="i">+        return &quot;&quot;&quot;
</a><a href="#h2-0-84" id="h2-0-84" class="i">+        {
</a><a href="#h2-0-85" id="h2-0-85" class="i">+            &quot;mAllowsTranscription&quot;: false,
</a><a href="#h2-0-86" id="h2-0-86" class="i">+            &quot;mBotMention&quot;: false,
</a><a href="#h2-0-87" id="h2-0-87" class="i">+            &quot;mContent&quot;: [${messageContent.joinToString(&quot;,&quot;)}],
</a><a href="#h2-0-88" id="h2-0-88" class="i">+            &quot;mContentType&quot;: &quot;${contentType.name}&quot;,
</a><a href="#h2-0-89" id="h2-0-89" class="i">+            &quot;mIncidentalAttachments&quot;: [],
</a><a href="#h2-0-90" id="h2-0-90" class="i">+            &quot;mLocalMediaReferences&quot;: [${
</a><a href="#h2-0-91" id="h2-0-91" class="i">+                if (localMediaReference != null) {
</a><a href="#h2-0-92" id="h2-0-92" class="i">+                    &quot;{\&quot;mId\&quot;: [${localMediaReference.joinToString(&quot;,&quot;)}]}&quot;
</a><a href="#h2-0-93" id="h2-0-93" class="i">+                } else {
</a><a href="#h2-0-94" id="h2-0-94" class="i">+                    &quot;&quot;
</a><a href="#h2-0-95" id="h2-0-95" class="i">+                }
</a><a href="#h2-0-96" id="h2-0-96" class="i">+            }],
</a><a href="#h2-0-97" id="h2-0-97" class="i">+            &quot;mPlatformAnalytics&quot;: {
</a><a href="#h2-0-98" id="h2-0-98" class="i">+                &quot;mAttemptId&quot;: {
</a><a href="#h2-0-99" id="h2-0-99" class="i">+                  &quot;mId&quot;: [${(1..16).map { (-127 ..127).random() }.joinToString(&quot;,&quot;)}]
</a><a href="#h2-0-100" id="h2-0-100" class="i">+                },
</a><a href="#h2-0-101" id="h2-0-101" class="i">+                &quot;mContent&quot;: [${defaultPlatformAnalytics().joinToString(&quot;,&quot;)}],
</a><a href="#h2-0-102" id="h2-0-102" class="i">+                &quot;mMetricsMessageMediaType&quot;: &quot;${metricMessageMediaType.name}&quot;,
</a><a href="#h2-0-103" id="h2-0-103" class="i">+                &quot;mMetricsMessageType&quot;: &quot;${metricsMediaType.name}&quot;,
</a><a href="#h2-0-104" id="h2-0-104" class="i">+                &quot;mReactionSource&quot;: &quot;NONE&quot;
</a><a href="#h2-0-105" id="h2-0-105" class="i">+            },
</a><a href="#h2-0-106" id="h2-0-106" class="i">+            &quot;mSavePolicy&quot;: &quot;$savePolicy&quot;
</a><a href="#h2-0-107" id="h2-0-107" class="i">+        }
</a><a href="#h2-0-108" id="h2-0-108" class="i">+        &quot;&quot;&quot;.trimIndent()
</a><a href="#h2-0-109" id="h2-0-109" class="i">+    }
</a><a href="#h2-0-110" id="h2-0-110" class="i">+
</a><a href="#h2-0-111" id="h2-0-111" class="i">+    private fun internalSendMessage(conversations: List&lt;SnapUUID&gt;, localMessageContentTemplate: String, callback: Any) {
</a><a href="#h2-0-112" id="h2-0-112" class="i">+        val sendMessageWithContentMethod = context.classCache.conversationManager.declaredMethods.first { it.name == &quot;sendMessageWithContent&quot; }
</a><a href="#h2-0-113" id="h2-0-113" class="i">+
</a><a href="#h2-0-114" id="h2-0-114" class="i">+        val localMessageContent = context.gson.fromJson(localMessageContentTemplate, context.classCache.localMessageContent)
</a><a href="#h2-0-115" id="h2-0-115" class="i">+        val messageDestinations = MessageDestinations(AbstractWrapper.newEmptyInstance(context.classCache.messageDestinations)).also {
</a><a href="#h2-0-116" id="h2-0-116" class="i">+            it.conversations = conversations
</a><a href="#h2-0-117" id="h2-0-117" class="i">+            it.mPhoneNumbers = arrayListOf()
</a><a href="#h2-0-118" id="h2-0-118" class="i">+            it.stories = arrayListOf()
</a><a href="#h2-0-119" id="h2-0-119" class="i">+        }
</a><a href="#h2-0-120" id="h2-0-120" class="i">+
</a><a href="#h2-0-121" id="h2-0-121" class="i">+        sendMessageWithContentMethod.invoke(context.feature(Messaging::class).conversationManager, messageDestinations.instanceNonNull(), localMessageContent, callback)
</a><a href="#h2-0-122" id="h2-0-122" class="i">+    }
</a><a href="#h2-0-123" id="h2-0-123" class="i">+
</a><a href="#h2-0-124" id="h2-0-124" class="i">+    //TODO: implement sendSnapMessage
</a><a href="#h2-0-125" id="h2-0-125" class="i">+    /*
</a><a href="#h2-0-126" id="h2-0-126" class="i">+    fun sendSnapMessage(conversations: List&lt;SnapUUID&gt;, chatMediaType: ChatMediaType, uri: Uri, onError: (Any) -&gt; Unit = {}, onSuccess: () -&gt; Unit = {}) {
</a><a href="#h2-0-127" id="h2-0-127" class="i">+        val mediaReferenceBuffer = FlatBufferBuilder(0).apply {
</a><a href="#h2-0-128" id="h2-0-128" class="i">+            val uriOffset = createString(uri.toString())
</a><a href="#h2-0-129" id="h2-0-129" class="i">+            forceDefaults(true)
</a><a href="#h2-0-130" id="h2-0-130" class="i">+            startTable(2)
</a><a href="#h2-0-131" id="h2-0-131" class="i">+            addOffset(1, uriOffset, 0)
</a><a href="#h2-0-132" id="h2-0-132" class="i">+            addInt(0, chatMediaType.value, 0)
</a><a href="#h2-0-133" id="h2-0-133" class="i">+            finish(endTable())
</a><a href="#h2-0-134" id="h2-0-134" class="i">+            finished()
</a><a href="#h2-0-135" id="h2-0-135" class="i">+        }.sizedByteArray()
</a><a href="#h2-0-136" id="h2-0-136" class="i">+
</a><a href="#h2-0-137" id="h2-0-137" class="i">+        internalSendMessage(conversations, createLocalMessageContentTemplate(
</a><a href="#h2-0-138" id="h2-0-138" class="i">+            contentType = ContentType.SNAP,
</a><a href="#h2-0-139" id="h2-0-139" class="i">+            messageContent = redSnapProto(chatMediaType == ChatMediaType.AUDIO || chatMediaType == ChatMediaType.VIDEO),
</a><a href="#h2-0-140" id="h2-0-140" class="i">+            localMediaReference = mediaReferenceBuffer,
</a><a href="#h2-0-141" id="h2-0-141" class="i">+            metricMessageMediaType = MetricsMessageMediaType.IMAGE,
</a><a href="#h2-0-142" id="h2-0-142" class="i">+            metricsMediaType = MetricsMessageType.SNAP
</a><a href="#h2-0-143" id="h2-0-143" class="i">+        ), CallbackBuilder(sendMessageCallback)
</a><a href="#h2-0-144" id="h2-0-144" class="i">+            .override(&quot;onSuccess&quot;) {
</a><a href="#h2-0-145" id="h2-0-145" class="i">+                onSuccess()
</a><a href="#h2-0-146" id="h2-0-146" class="i">+            }
</a><a href="#h2-0-147" id="h2-0-147" class="i">+            .override(&quot;onError&quot;) {
</a><a href="#h2-0-148" id="h2-0-148" class="i">+                onError(it.arg(0))
</a><a href="#h2-0-149" id="h2-0-149" class="i">+            }
</a><a href="#h2-0-150" id="h2-0-150" class="i">+            .build())
</a><a href="#h2-0-151" id="h2-0-151" class="i">+    }*/
</a><a href="#h2-0-152" id="h2-0-152" class="i">+
</a><a href="#h2-0-153" id="h2-0-153" class="i">+    fun sendChatMessage(conversations: List&lt;SnapUUID&gt;, message: String, onError: (Any) -&gt; Unit = {}, onSuccess: () -&gt; Unit = {}) {
</a><a href="#h2-0-154" id="h2-0-154" class="i">+        internalSendMessage(conversations, createLocalMessageContentTemplate(ContentType.CHAT, ProtoWriter().apply {
</a><a href="#h2-0-155" id="h2-0-155" class="i">+            write(2) {
</a><a href="#h2-0-156" id="h2-0-156" class="i">+                writeString(1, message)
</a><a href="#h2-0-157" id="h2-0-157" class="i">+            }
</a><a href="#h2-0-158" id="h2-0-158" class="i">+        }.toByteArray(), savePolicy = &quot;LIFETIME&quot;), CallbackBuilder(sendMessageCallback)
</a><a href="#h2-0-159" id="h2-0-159" class="i">+            .override(&quot;onSuccess&quot;, callback = { onSuccess() })
</a><a href="#h2-0-160" id="h2-0-160" class="i">+            .override(&quot;onError&quot;, callback = { onError(it.arg(0)) })
</a><a href="#h2-0-161" id="h2-0-161" class="i">+            .build())
</a><a href="#h2-0-162" id="h2-0-162" class="i">+    }
</a><a href="#h2-0-163" id="h2-0-163" class="i">+}</a><a href="#h2-0-164" id="h2-0-164" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h3" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/data/SnapClassCache.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/data/SnapClassCache.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/data/SnapClassCache.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/data/SnapClassCache.kt</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -12,6 +12,8 @@ class SnapClassCache (
</a>     val messageUpdateEnum by lazy { findClass(&quot;com.snapchat.client.messaging.MessageUpdate&quot;) }
     val unifiedGrpcService by lazy { findClass(&quot;com.snapchat.client.grpc.UnifiedGrpcService\$CppProxy&quot;) }
     val networkApi by lazy { findClass(&quot;com.snapchat.client.network_api.NetworkApi\$CppProxy&quot;) }
<a href="#h3-0-3" id="h3-0-3" class="i">+    val messageDestinations by lazy { findClass(&quot;com.snapchat.client.messaging.MessageDestinations&quot;) }
</a><a href="#h3-0-4" id="h3-0-4" class="i">+    val localMessageContent by lazy { findClass(&quot;com.snapchat.client.messaging.LocalMessageContent&quot;) }
</a> 
     private fun findClass(className: String): Class&lt;*&gt; {
         return try {
<b>diff --git a/<a id="h4" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/data/SnapEnums.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/data/SnapEnums.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/data/SnapEnums.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/data/SnapEnums.kt</a></b>
<a href="#h4-0" id="h4-0" class="h">@@ -4,6 +4,39 @@ enum class MessageState {
</a>     PREPARING, SENDING, COMMITTED, FAILED, CANCELING
 }
 
<a href="#h4-0-3" id="h4-0-3" class="i">+enum class ChatMediaType (
</a><a href="#h4-0-4" id="h4-0-4" class="i">+    val value: Int
</a><a href="#h4-0-5" id="h4-0-5" class="i">+) {
</a><a href="#h4-0-6" id="h4-0-6" class="i">+    IMAGE(0),
</a><a href="#h4-0-7" id="h4-0-7" class="i">+    VIDEO(1),
</a><a href="#h4-0-8" id="h4-0-8" class="i">+    VIDEO_NO_SOUND(2),
</a><a href="#h4-0-9" id="h4-0-9" class="i">+    FRIEND_DEPRECATED(3),
</a><a href="#h4-0-10" id="h4-0-10" class="i">+    BLOB(4),
</a><a href="#h4-0-11" id="h4-0-11" class="i">+    LAGUNA_SOUND(5),
</a><a href="#h4-0-12" id="h4-0-12" class="i">+    LAGUNA_NO_SOUND(6),
</a><a href="#h4-0-13" id="h4-0-13" class="i">+    GIF(7),
</a><a href="#h4-0-14" id="h4-0-14" class="i">+    FINGERPRINT_HEADER_SIZE(8),
</a><a href="#h4-0-15" id="h4-0-15" class="i">+    AUDIO_STITCH(9),
</a><a href="#h4-0-16" id="h4-0-16" class="i">+    PSYCHOMANTIS(10),
</a><a href="#h4-0-17" id="h4-0-17" class="i">+    SCREAMINGMANTIS(11),
</a><a href="#h4-0-18" id="h4-0-18" class="i">+    MALIBU_SOUND(12),
</a><a href="#h4-0-19" id="h4-0-19" class="i">+    MALIBU_NO_SOUND(13),
</a><a href="#h4-0-20" id="h4-0-20" class="i">+    LAGUNAHD_SOUND(14),
</a><a href="#h4-0-21" id="h4-0-21" class="i">+    LAGUNAHD_NO_SOUND(15),
</a><a href="#h4-0-22" id="h4-0-22" class="i">+    GHOSTMANTIS(16),
</a><a href="#h4-0-23" id="h4-0-23" class="i">+    NEWPORT_SOUND(17),
</a><a href="#h4-0-24" id="h4-0-24" class="i">+    NEWPORT_NO_SOUND(18),
</a><a href="#h4-0-25" id="h4-0-25" class="i">+    AUDIO(19),
</a><a href="#h4-0-26" id="h4-0-26" class="i">+    BLOOP(20),
</a><a href="#h4-0-27" id="h4-0-27" class="i">+    SPECTACLES_IMAGE(21),
</a><a href="#h4-0-28" id="h4-0-28" class="i">+    SPECTACLES_VIDEO(22),
</a><a href="#h4-0-29" id="h4-0-29" class="i">+    SPECTACLES_VIDEO_NO_SOUND(23),
</a><a href="#h4-0-30" id="h4-0-30" class="i">+    CHEERIOS_IMAGE(24),
</a><a href="#h4-0-31" id="h4-0-31" class="i">+    CHEERIOS_VIDEO_SOUND(25),
</a><a href="#h4-0-32" id="h4-0-32" class="i">+    CHEERIOS_VIDEO_NO_SOUND(26),
</a><a href="#h4-0-33" id="h4-0-33" class="i">+    WEB(27),
</a><a href="#h4-0-34" id="h4-0-34" class="i">+    UNRECOGNIZED_VALUE(-9999);
</a><a href="#h4-0-35" id="h4-0-35" class="i">+}
</a> enum class ContentType(val id: Int) {
     UNKNOWN(-1),
     SNAP(0),
<a href="#h4-1" id="h4-1" class="h">@@ -36,6 +69,66 @@ enum class PlayableSnapState {
</a>     NOTDOWNLOADED, DOWNLOADING, DOWNLOADFAILED, PLAYABLE, VIEWEDREPLAYABLE, PLAYING, VIEWEDNOTREPLAYABLE
 }
 
<a href="#h4-1-3" id="h4-1-3" class="i">+enum class MetricsMessageMediaType {
</a><a href="#h4-1-4" id="h4-1-4" class="i">+    NO_MEDIA,
</a><a href="#h4-1-5" id="h4-1-5" class="i">+    IMAGE,
</a><a href="#h4-1-6" id="h4-1-6" class="i">+    VIDEO,
</a><a href="#h4-1-7" id="h4-1-7" class="i">+    VIDEO_NO_SOUND,
</a><a href="#h4-1-8" id="h4-1-8" class="i">+    GIF,
</a><a href="#h4-1-9" id="h4-1-9" class="i">+    DERIVED_FROM_MESSAGE_TYPE,
</a><a href="#h4-1-10" id="h4-1-10" class="i">+    REACTION
</a><a href="#h4-1-11" id="h4-1-11" class="i">+}
</a><a href="#h4-1-12" id="h4-1-12" class="i">+
</a><a href="#h4-1-13" id="h4-1-13" class="i">+enum class MetricsMessageType {
</a><a href="#h4-1-14" id="h4-1-14" class="i">+    TEXT,
</a><a href="#h4-1-15" id="h4-1-15" class="i">+    STICKER,
</a><a href="#h4-1-16" id="h4-1-16" class="i">+    CUSTOM_STICKER,
</a><a href="#h4-1-17" id="h4-1-17" class="i">+    SNAP,
</a><a href="#h4-1-18" id="h4-1-18" class="i">+    AUDIO_NOTE,
</a><a href="#h4-1-19" id="h4-1-19" class="i">+    MEDIA,
</a><a href="#h4-1-20" id="h4-1-20" class="i">+    BATCHED_MEDIA,
</a><a href="#h4-1-21" id="h4-1-21" class="i">+    MISSED_AUDIO_CALL,
</a><a href="#h4-1-22" id="h4-1-22" class="i">+    MISSED_VIDEO_CALL,
</a><a href="#h4-1-23" id="h4-1-23" class="i">+    JOINED_CALL,
</a><a href="#h4-1-24" id="h4-1-24" class="i">+    LEFT_CALL,
</a><a href="#h4-1-25" id="h4-1-25" class="i">+    SNAPCHATTER,
</a><a href="#h4-1-26" id="h4-1-26" class="i">+    LOCATION_SHARE,
</a><a href="#h4-1-27" id="h4-1-27" class="i">+    LOCATION_REQUEST,
</a><a href="#h4-1-28" id="h4-1-28" class="i">+    SCREENSHOT,
</a><a href="#h4-1-29" id="h4-1-29" class="i">+    SCREEN_RECORDING,
</a><a href="#h4-1-30" id="h4-1-30" class="i">+    GAME_CLOSED,
</a><a href="#h4-1-31" id="h4-1-31" class="i">+    STORY_SHARE,
</a><a href="#h4-1-32" id="h4-1-32" class="i">+    MAP_DROP_SHARE,
</a><a href="#h4-1-33" id="h4-1-33" class="i">+    MAP_STORY_SHARE,
</a><a href="#h4-1-34" id="h4-1-34" class="i">+    MAP_STORY_SNAP_SHARE,
</a><a href="#h4-1-35" id="h4-1-35" class="i">+    MAP_HEAT_SNAP_SHARE,
</a><a href="#h4-1-36" id="h4-1-36" class="i">+    MAP_SCREENSHOT_SHARE,
</a><a href="#h4-1-37" id="h4-1-37" class="i">+    MEMORIES_STORY,
</a><a href="#h4-1-38" id="h4-1-38" class="i">+    SEARCH_STORY_SHARE,
</a><a href="#h4-1-39" id="h4-1-39" class="i">+    SEARCH_STORY_SNAP_SHARE,
</a><a href="#h4-1-40" id="h4-1-40" class="i">+    DISCOVER_SHARE,
</a><a href="#h4-1-41" id="h4-1-41" class="i">+    SHAZAM_SHARE,
</a><a href="#h4-1-42" id="h4-1-42" class="i">+    SAVE_TO_CAMERA_ROLL,
</a><a href="#h4-1-43" id="h4-1-43" class="i">+    GAME_SCORE_SHARE,
</a><a href="#h4-1-44" id="h4-1-44" class="i">+    SNAP_PRO_PROFILE_SHARE,
</a><a href="#h4-1-45" id="h4-1-45" class="i">+    SNAP_PRO_SNAP_SHARE,
</a><a href="#h4-1-46" id="h4-1-46" class="i">+    CANVAS_APP_SHARE,
</a><a href="#h4-1-47" id="h4-1-47" class="i">+    AD_SHARE,
</a><a href="#h4-1-48" id="h4-1-48" class="i">+    STORY_REPLY,
</a><a href="#h4-1-49" id="h4-1-49" class="i">+    SPOTLIGHT_STORY_SHARE,
</a><a href="#h4-1-50" id="h4-1-50" class="i">+    CAMEO,
</a><a href="#h4-1-51" id="h4-1-51" class="i">+    MEMOJI,
</a><a href="#h4-1-52" id="h4-1-52" class="i">+    BITMOJI_OUTFIT_SHARE,
</a><a href="#h4-1-53" id="h4-1-53" class="i">+    LIVE_LOCATION_SHARE,
</a><a href="#h4-1-54" id="h4-1-54" class="i">+    CREATIVE_TOOL_ITEM,
</a><a href="#h4-1-55" id="h4-1-55" class="i">+    SNAP_KIT_INVITE_SHARE,
</a><a href="#h4-1-56" id="h4-1-56" class="i">+    QUOTE_REPLY_SHARE,
</a><a href="#h4-1-57" id="h4-1-57" class="i">+    BLOOPS_STORY_SHARE,
</a><a href="#h4-1-58" id="h4-1-58" class="i">+    SNAP_PRO_SAVED_STORY_SHARE,
</a><a href="#h4-1-59" id="h4-1-59" class="i">+    PLACE_PROFILE_SHARE,
</a><a href="#h4-1-60" id="h4-1-60" class="i">+    PLACE_STORY_SHARE,
</a><a href="#h4-1-61" id="h4-1-61" class="i">+    SAVED_STORY_SHARE
</a><a href="#h4-1-62" id="h4-1-62" class="i">+}
</a> enum class MediaReferenceType {
     UNASSIGNED, OVERLAY, IMAGE, VIDEO, ASSET_BUNDLE, AUDIO, ANIMATED_IMAGE, FONT, WEB_VIEW_CONTENT, VIDEO_NO_AUDIO
 }
<b>diff --git a/<a id="h5" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/AbstractWrapper.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/AbstractWrapper.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/AbstractWrapper.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/AbstractWrapper.kt</a></b>
<a href="#h5-0" id="h5-0" class="h">@@ -1,10 +1,17 @@
</a> package me.rhunk.snapenhance.data.wrapper
 
 import de.robv.android.xposed.XposedHelpers
<a href="#h5-0-3" id="h5-0-3" class="i">+import me.rhunk.snapenhance.util.CallbackBuilder
</a> 
 abstract class AbstractWrapper(
     protected var instance: Any?
 ) {
<a href="#h5-0-8" id="h5-0-8" class="i">+    companion object {
</a><a href="#h5-0-9" id="h5-0-9" class="i">+        fun newEmptyInstance(clazz: Class&lt;*&gt;): Any {
</a><a href="#h5-0-10" id="h5-0-10" class="i">+            return CallbackBuilder.createEmptyObject(clazz.constructors[0]) ?: throw NullPointerException()
</a><a href="#h5-0-11" id="h5-0-11" class="i">+        }
</a><a href="#h5-0-12" id="h5-0-12" class="i">+    }
</a><a href="#h5-0-13" id="h5-0-13" class="i">+
</a>     fun instanceNonNull(): Any = instance!!
     fun isPresent(): Boolean = instance == null
 
<b>diff --git a/<a id="h6" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/MessageDestinations.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/MessageDestinations.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/MessageDestinations.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/MessageDestinations.kt</a></b>
<a href="#h6-0" id="h6-0" class="h">@@ -0,0 +1,14 @@
</a><a href="#h6-0-0" id="h6-0-0" class="i">+package me.rhunk.snapenhance.data.wrapper.impl
</a><a href="#h6-0-1" id="h6-0-1" class="i">+
</a><a href="#h6-0-2" id="h6-0-2" class="i">+import me.rhunk.snapenhance.data.wrapper.AbstractWrapper
</a><a href="#h6-0-3" id="h6-0-3" class="i">+import me.rhunk.snapenhance.util.getObjectField
</a><a href="#h6-0-4" id="h6-0-4" class="i">+import me.rhunk.snapenhance.util.setObjectField
</a><a href="#h6-0-5" id="h6-0-5" class="i">+
</a><a href="#h6-0-6" id="h6-0-6" class="i">+class MessageDestinations(obj: Any) : AbstractWrapper(obj){
</a><a href="#h6-0-7" id="h6-0-7" class="i">+    var conversations get() = (instanceNonNull().getObjectField(&quot;mConversations&quot;) as ArrayList&lt;*&gt;).map { SnapUUID(it) }
</a><a href="#h6-0-8" id="h6-0-8" class="i">+        set(value) = instanceNonNull().setObjectField(&quot;mConversations&quot;, value.map { it.instanceNonNull() }.toCollection(ArrayList()))
</a><a href="#h6-0-9" id="h6-0-9" class="i">+    var stories get() = instanceNonNull().getObjectField(&quot;mStories&quot;) as ArrayList&lt;Any&gt;
</a><a href="#h6-0-10" id="h6-0-10" class="i">+        set(value) = instanceNonNull().setObjectField(&quot;mStories&quot;, value)
</a><a href="#h6-0-11" id="h6-0-11" class="i">+    var mPhoneNumbers get() = instanceNonNull().getObjectField(&quot;mPhoneNumbers&quot;) as ArrayList&lt;Any&gt;
</a><a href="#h6-0-12" id="h6-0-12" class="i">+        set(value) = instanceNonNull().setObjectField(&quot;mPhoneNumbers&quot;, value)
</a><a href="#h6-0-13" id="h6-0-13" class="i">+}</a><a href="#h6-0-14" id="h6-0-14" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h7" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/extras/GalleryMediaSendOverride.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/extras/GalleryMediaSendOverride.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/extras/GalleryMediaSendOverride.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/extras/GalleryMediaSendOverride.kt</a></b>
<a href="#h7-0" id="h7-0" class="h">@@ -1,51 +1,16 @@
</a> package me.rhunk.snapenhance.features.impl.extras
 
<a href="#h7-0-2" id="h7-0-2" class="d">-import me.rhunk.snapenhance.Logger
</a> import me.rhunk.snapenhance.config.ConfigProperty
 import me.rhunk.snapenhance.data.ContentType
<a href="#h7-0-5" id="h7-0-5" class="i">+import me.rhunk.snapenhance.data.MessageSender
</a> import me.rhunk.snapenhance.data.wrapper.impl.MessageContent
 import me.rhunk.snapenhance.features.Feature
 import me.rhunk.snapenhance.features.FeatureLoadParams
 import me.rhunk.snapenhance.hook.HookStage
 import me.rhunk.snapenhance.hook.Hooker
 import me.rhunk.snapenhance.util.protobuf.ProtoReader
<a href="#h7-0-12" id="h7-0-12" class="d">-import me.rhunk.snapenhance.util.protobuf.ProtoWriter
</a> 
 class GalleryMediaSendOverride : Feature(&quot;Gallery Media Send Override&quot;, loadParams = FeatureLoadParams.INIT_SYNC) {
<a href="#h7-0-15" id="h7-0-15" class="d">-    private val redSnapProto: ByteArray by lazy {
</a><a href="#h7-0-16" id="h7-0-16" class="d">-        ProtoWriter().apply {
</a><a href="#h7-0-17" id="h7-0-17" class="d">-            write(11, 5) {
</a><a href="#h7-0-18" id="h7-0-18" class="d">-                write(1) {
</a><a href="#h7-0-19" id="h7-0-19" class="d">-                    write(1) {
</a><a href="#h7-0-20" id="h7-0-20" class="d">-                        writeConstant(2, 0)
</a><a href="#h7-0-21" id="h7-0-21" class="d">-                        writeConstant(12, 0)
</a><a href="#h7-0-22" id="h7-0-22" class="d">-                        writeConstant(15, 0)
</a><a href="#h7-0-23" id="h7-0-23" class="d">-                    }
</a><a href="#h7-0-24" id="h7-0-24" class="d">-                    writeConstant(6, 0)
</a><a href="#h7-0-25" id="h7-0-25" class="d">-                }
</a><a href="#h7-0-26" id="h7-0-26" class="d">-                write(2) {
</a><a href="#h7-0-27" id="h7-0-27" class="d">-                    writeConstant(5, 0)
</a><a href="#h7-0-28" id="h7-0-28" class="d">-                    writeBuffer(6, byteArrayOf())
</a><a href="#h7-0-29" id="h7-0-29" class="d">-                }
</a><a href="#h7-0-30" id="h7-0-30" class="d">-            }
</a><a href="#h7-0-31" id="h7-0-31" class="d">-        }.toByteArray()
</a><a href="#h7-0-32" id="h7-0-32" class="d">-    }
</a><a href="#h7-0-33" id="h7-0-33" class="d">-
</a><a href="#h7-0-34" id="h7-0-34" class="d">-    private val audioNoteProto: (Int) -&gt; ByteArray = { duration -&gt;
</a><a href="#h7-0-35" id="h7-0-35" class="d">-        ProtoWriter().apply {
</a><a href="#h7-0-36" id="h7-0-36" class="d">-            write(6, 1) {
</a><a href="#h7-0-37" id="h7-0-37" class="d">-                write(1) {
</a><a href="#h7-0-38" id="h7-0-38" class="d">-                    writeConstant(2, 4)
</a><a href="#h7-0-39" id="h7-0-39" class="d">-                    write(5) {
</a><a href="#h7-0-40" id="h7-0-40" class="d">-                        writeConstant(1, 0)
</a><a href="#h7-0-41" id="h7-0-41" class="d">-                        writeConstant(2, 0)
</a><a href="#h7-0-42" id="h7-0-42" class="d">-                    }
</a><a href="#h7-0-43" id="h7-0-43" class="d">-                    writeConstant(7, 0)
</a><a href="#h7-0-44" id="h7-0-44" class="d">-                    writeConstant(13, duration)
</a><a href="#h7-0-45" id="h7-0-45" class="d">-                }
</a><a href="#h7-0-46" id="h7-0-46" class="d">-            }
</a><a href="#h7-0-47" id="h7-0-47" class="d">-        }.toByteArray()
</a><a href="#h7-0-48" id="h7-0-48" class="d">-    }
</a> 
     override fun init() {
         Hooker.hook(context.classCache.conversationManager, &quot;sendMessageWithContent&quot;, HookStage.BEFORE) { param -&gt;
<a href="#h7-1" id="h7-1" class="h">@@ -56,15 +21,15 @@ class GalleryMediaSendOverride : Feature(&quot;Gallery Media Send Override&quot;, loadPara
</a>             val messageProtoReader = ProtoReader(localMessageContent.content)
             if (messageProtoReader.exists(7)) return@hook
 
<a href="#h7-1-3" id="h7-1-3" class="d">-            when (context.config.state(ConfigProperty.GALLERY_MEDIA_SEND_OVERRIDE)) {
</a><a href="#h7-1-4" id="h7-1-4" class="d">-                &quot;SNAP&quot; -&gt; {
</a><a href="#h7-1-5" id="h7-1-5" class="i">+            when (val overrideType = context.config.state(ConfigProperty.GALLERY_MEDIA_SEND_OVERRIDE)) {
</a><a href="#h7-1-6" id="h7-1-6" class="i">+                &quot;SNAP&quot;, &quot;LIVE_SNAP&quot; -&gt; {
</a>                     localMessageContent.contentType = ContentType.SNAP
<a href="#h7-1-8" id="h7-1-8" class="d">-                    localMessageContent.content = redSnapProto
</a><a href="#h7-1-9" id="h7-1-9" class="i">+                    localMessageContent.content = MessageSender.redSnapProto(overrideType == &quot;LIVE_SNAP&quot;)
</a>                 }
                 &quot;NOTE&quot; -&gt; {
                     localMessageContent.contentType = ContentType.NOTE
                     val mediaDuration = messageProtoReader.getInt(3, 3, 5, 1, 1, 15) ?: 0
<a href="#h7-1-14" id="h7-1-14" class="d">-                    localMessageContent.content = audioNoteProto(mediaDuration)
</a><a href="#h7-1-15" id="h7-1-15" class="i">+                    localMessageContent.content = MessageSender.audioNoteProto(mediaDuration)
</a>                 }
             }
         }
<b>diff --git a/<a id="h8" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/extras/Notifications.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/extras/Notifications.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/extras/Notifications.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/extras/Notifications.kt</a></b>
<a href="#h8-0" id="h8-0" class="h">@@ -2,7 +2,10 @@ package me.rhunk.snapenhance.features.impl.extras
</a> 
 import android.app.Notification
 import android.app.NotificationManager
<a href="#h8-0-3" id="h8-0-3" class="i">+import android.app.PendingIntent
</a><a href="#h8-0-4" id="h8-0-4" class="i">+import android.app.RemoteInput
</a> import android.content.Context
<a href="#h8-0-6" id="h8-0-6" class="i">+import android.content.Intent
</a> import android.graphics.Bitmap
 import android.os.Bundle
 import android.os.UserHandle
<a href="#h8-1" id="h8-1" class="h">@@ -28,10 +31,18 @@ import me.rhunk.snapenhance.util.PreviewUtils
</a> import me.rhunk.snapenhance.util.protobuf.ProtoReader
 
 class Notifications : Feature(&quot;Notifications&quot;, loadParams = FeatureLoadParams.INIT_SYNC) {
<a href="#h8-1-3" id="h8-1-3" class="i">+    companion object{
</a><a href="#h8-1-4" id="h8-1-4" class="i">+        const val ACTION_REPLY = &quot;me.rhunk.snapenhance.action.REPLY&quot;
</a><a href="#h8-1-5" id="h8-1-5" class="i">+    }
</a><a href="#h8-1-6" id="h8-1-6" class="i">+
</a>     private val notificationDataQueue = mutableMapOf&lt;Long, NotificationData&gt;() // messageId =&gt; notification
     private val cachedMessages = mutableMapOf&lt;String, MutableList&lt;String&gt;&gt;() // conversationId =&gt; cached messages
     private val notificationIdMap = mutableMapOf&lt;Int, String&gt;() // notificationId =&gt; conversationId
 
<a href="#h8-1-11" id="h8-1-11" class="i">+    private val broadcastReceiverClass by lazy {
</a><a href="#h8-1-12" id="h8-1-12" class="i">+        context.androidContext.classLoader.loadClass(&quot;com.snap.widgets.core.BestFriendsWidgetProvider&quot;)
</a><a href="#h8-1-13" id="h8-1-13" class="i">+    }
</a><a href="#h8-1-14" id="h8-1-14" class="i">+
</a>     private val notifyAsUserMethod by lazy {
         XposedHelpers.findMethodExact(
             NotificationManager::class.java, &quot;notifyAsUser&quot;,
<a href="#h8-2" id="h8-2" class="h">@@ -54,8 +65,8 @@ class Notifications : Feature(&quot;Notifications&quot;, loadParams = FeatureLoadParams.IN
</a>         context.androidContext.getSystemService(Context.NOTIFICATION_SERVICE) as NotificationManager
     }
 
<a href="#h8-2-3" id="h8-2-3" class="d">-    private fun setNotificationText(notification: NotificationData, text: String) {
</a><a href="#h8-2-4" id="h8-2-4" class="d">-        with(notification.notification.extras) {
</a><a href="#h8-2-5" id="h8-2-5" class="i">+    private fun setNotificationText(notification: Notification, text: String) {
</a><a href="#h8-2-6" id="h8-2-6" class="i">+        with(notification.extras) {
</a>             putString(&quot;android.text&quot;, text)
             putString(&quot;android.bigText&quot;, text)
         }
<a href="#h8-3" id="h8-3" class="h">@@ -70,6 +81,74 @@ class Notifications : Feature(&quot;Notifications&quot;, loadParams = FeatureLoadParams.IN
</a>         return messageBuilder.toString()
     }
 
<a href="#h8-3-3" id="h8-3-3" class="i">+    private fun setupNotificationActionButtons(conversationId: String, notificationData: NotificationData) {
</a><a href="#h8-3-4" id="h8-3-4" class="i">+        val notificationBuilder = XposedHelpers.newInstance(
</a><a href="#h8-3-5" id="h8-3-5" class="i">+            Notification.Builder::class.java,
</a><a href="#h8-3-6" id="h8-3-6" class="i">+            context.androidContext,
</a><a href="#h8-3-7" id="h8-3-7" class="i">+            notificationData.notification
</a><a href="#h8-3-8" id="h8-3-8" class="i">+        ) as Notification.Builder
</a><a href="#h8-3-9" id="h8-3-9" class="i">+
</a><a href="#h8-3-10" id="h8-3-10" class="i">+        val chatReplyInput = RemoteInput.Builder(&quot;chat_reply_input&quot;)
</a><a href="#h8-3-11" id="h8-3-11" class="i">+            .setLabel(&quot;Reply&quot;)
</a><a href="#h8-3-12" id="h8-3-12" class="i">+            .build()
</a><a href="#h8-3-13" id="h8-3-13" class="i">+
</a><a href="#h8-3-14" id="h8-3-14" class="i">+        val replyIntent = Intent()
</a><a href="#h8-3-15" id="h8-3-15" class="i">+            .setClassName(Constants.SNAPCHAT_PACKAGE_NAME, broadcastReceiverClass.name)
</a><a href="#h8-3-16" id="h8-3-16" class="i">+            .putExtra(&quot;conversation_id&quot;, conversationId)
</a><a href="#h8-3-17" id="h8-3-17" class="i">+            .putExtra(&quot;notification_id&quot;, notificationData.id)
</a><a href="#h8-3-18" id="h8-3-18" class="i">+            .setAction(ACTION_REPLY)
</a><a href="#h8-3-19" id="h8-3-19" class="i">+
</a><a href="#h8-3-20" id="h8-3-20" class="i">+        val action = Notification.Action.Builder(
</a><a href="#h8-3-21" id="h8-3-21" class="i">+            null,
</a><a href="#h8-3-22" id="h8-3-22" class="i">+            &quot;Reply&quot;,
</a><a href="#h8-3-23" id="h8-3-23" class="i">+            PendingIntent.getBroadcast(
</a><a href="#h8-3-24" id="h8-3-24" class="i">+                context.androidContext,
</a><a href="#h8-3-25" id="h8-3-25" class="i">+                0,
</a><a href="#h8-3-26" id="h8-3-26" class="i">+                replyIntent,
</a><a href="#h8-3-27" id="h8-3-27" class="i">+                PendingIntent.FLAG_UPDATE_CURRENT or PendingIntent.FLAG_MUTABLE
</a><a href="#h8-3-28" id="h8-3-28" class="i">+            )
</a><a href="#h8-3-29" id="h8-3-29" class="i">+        ).addRemoteInput(chatReplyInput).build()
</a><a href="#h8-3-30" id="h8-3-30" class="i">+
</a><a href="#h8-3-31" id="h8-3-31" class="i">+        notificationBuilder.setActions(action)
</a><a href="#h8-3-32" id="h8-3-32" class="i">+        notificationData.notification = notificationBuilder.build()
</a><a href="#h8-3-33" id="h8-3-33" class="i">+    }
</a><a href="#h8-3-34" id="h8-3-34" class="i">+
</a><a href="#h8-3-35" id="h8-3-35" class="i">+    private fun setupBroadcastReceiverHook() {
</a><a href="#h8-3-36" id="h8-3-36" class="i">+        Hooker.hook(broadcastReceiverClass, &quot;onReceive&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h8-3-37" id="h8-3-37" class="i">+            val androidContext = param.arg&lt;Context&gt;(0)
</a><a href="#h8-3-38" id="h8-3-38" class="i">+            val intent = param.arg&lt;Intent&gt;(1)
</a><a href="#h8-3-39" id="h8-3-39" class="i">+            if (intent.action != ACTION_REPLY) return@hook
</a><a href="#h8-3-40" id="h8-3-40" class="i">+            param.setResult(null)
</a><a href="#h8-3-41" id="h8-3-41" class="i">+
</a><a href="#h8-3-42" id="h8-3-42" class="i">+            val notificationManager = androidContext.getSystemService(Context.NOTIFICATION_SERVICE) as NotificationManager
</a><a href="#h8-3-43" id="h8-3-43" class="i">+            val updateNotification: (Int, (Notification) -&gt; Unit) -&gt; Unit = { notificationId, notificationBuilder -&gt;
</a><a href="#h8-3-44" id="h8-3-44" class="i">+                notificationManager.activeNotifications.firstOrNull { it.id == notificationId }?.let {
</a><a href="#h8-3-45" id="h8-3-45" class="i">+                    notificationBuilder(it.notification)
</a><a href="#h8-3-46" id="h8-3-46" class="i">+                    XposedBridge.invokeOriginalMethod(notifyAsUserMethod, notificationManager, arrayOf(
</a><a href="#h8-3-47" id="h8-3-47" class="i">+                        it.tag, it.id, it.notification, it.user
</a><a href="#h8-3-48" id="h8-3-48" class="i">+                    ))
</a><a href="#h8-3-49" id="h8-3-49" class="i">+                }
</a><a href="#h8-3-50" id="h8-3-50" class="i">+            }
</a><a href="#h8-3-51" id="h8-3-51" class="i">+
</a><a href="#h8-3-52" id="h8-3-52" class="i">+            val input = RemoteInput.getResultsFromIntent(intent).getCharSequence(&quot;chat_reply_input&quot;)
</a><a href="#h8-3-53" id="h8-3-53" class="i">+                .toString()
</a><a href="#h8-3-54" id="h8-3-54" class="i">+            val conversationId = intent.getStringExtra(&quot;conversation_id&quot;)!!
</a><a href="#h8-3-55" id="h8-3-55" class="i">+            val notificationId = intent.getIntExtra(&quot;notification_id&quot;, -1)
</a><a href="#h8-3-56" id="h8-3-56" class="i">+
</a><a href="#h8-3-57" id="h8-3-57" class="i">+            context.database.getMyUserId()?.let { context.database.getFriendInfo(it) }?.let { myUser -&gt;
</a><a href="#h8-3-58" id="h8-3-58" class="i">+                cachedMessages.computeIfAbsent(conversationId) { mutableListOf() }.add(&quot;${myUser.displayName}: $input&quot;)
</a><a href="#h8-3-59" id="h8-3-59" class="i">+
</a><a href="#h8-3-60" id="h8-3-60" class="i">+                updateNotification(notificationId) { notification -&gt;
</a><a href="#h8-3-61" id="h8-3-61" class="i">+                    setNotificationText(notification, computeNotificationText(conversationId))
</a><a href="#h8-3-62" id="h8-3-62" class="i">+                }
</a><a href="#h8-3-63" id="h8-3-63" class="i">+
</a><a href="#h8-3-64" id="h8-3-64" class="i">+                context.messageSender.sendChatMessage(listOf(SnapUUID.fromString(conversationId)), input, onError = {
</a><a href="#h8-3-65" id="h8-3-65" class="i">+                    context.longToast(&quot;Failed to send message: $it&quot;)
</a><a href="#h8-3-66" id="h8-3-66" class="i">+                })
</a><a href="#h8-3-67" id="h8-3-67" class="i">+            }
</a><a href="#h8-3-68" id="h8-3-68" class="i">+        }
</a><a href="#h8-3-69" id="h8-3-69" class="i">+    }
</a><a href="#h8-3-70" id="h8-3-70" class="i">+
</a>     private fun fetchMessagesResult(conversationId: String, messages: List&lt;Message&gt;) {
         val sendNotificationData = { notificationData: NotificationData, forceCreate: Boolean  -&gt;
             val notificationId = if (forceCreate) System.nanoTime().toInt() else notificationData.id
<a href="#h8-4" id="h8-4" class="h">@@ -89,7 +168,7 @@ class Notifications : Feature(&quot;Notifications&quot;, loadParams = FeatureLoadParams.IN
</a> 
             val formatUsername: (String) -&gt; String = { &quot;$senderUsername: $it&quot; }
             val notificationCache = cachedMessages.let { it.computeIfAbsent(conversationId) { mutableListOf() } }
<a href="#h8-4-3" id="h8-4-3" class="d">-            val appendNotifications: () -&gt; Unit = { setNotificationText(notificationData, computeNotificationText(conversationId))}
</a><a href="#h8-4-4" id="h8-4-4" class="i">+            val appendNotifications: () -&gt; Unit = { setNotificationText(notificationData.notification, computeNotificationText(conversationId))}
</a> 
             when (contentType) {
                 ContentType.NOTE -&gt; {
<a href="#h8-5" id="h8-5" class="h">@@ -150,6 +229,10 @@ class Notifications : Feature(&quot;Notifications&quot;, loadParams = FeatureLoadParams.IN
</a>                 }
             }
 
<a href="#h8-5-3" id="h8-5-3" class="i">+            if (contentType == ContentType.CHAT) {
</a><a href="#h8-5-4" id="h8-5-4" class="i">+                setupNotificationActionButtons(conversationId, notificationData)
</a><a href="#h8-5-5" id="h8-5-5" class="i">+            }
</a><a href="#h8-5-6" id="h8-5-6" class="i">+
</a>             sendNotificationData(notificationData, false)
         }.clear()
     }
<a href="#h8-6" id="h8-6" class="h">@@ -165,6 +248,8 @@ class Notifications : Feature(&quot;Notifications&quot;, loadParams = FeatureLoadParams.IN
</a>     }
 
     override fun init() {
<a href="#h8-6-3" id="h8-6-3" class="i">+        setupBroadcastReceiverHook()
</a><a href="#h8-6-4" id="h8-6-4" class="i">+
</a>         val fetchConversationWithMessagesCallback = context.mappings.getMappedClass(&quot;callbacks&quot;, &quot;FetchConversationWithMessagesCallback&quot;)
 
         Hooker.hook(notifyAsUserMethod, HookStage.BEFORE) { param -&gt;
<b>diff --git a/<a id="h9" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/privacy/DisableMetrics.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/privacy/DisableMetrics.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/privacy/DisableMetrics.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/privacy/DisableMetrics.kt</a></b>
<a href="#h9-0" id="h9-0" class="h">@@ -1,15 +1,12 @@
</a> package me.rhunk.snapenhance.features.impl.privacy
 
 import de.robv.android.xposed.XposedHelpers
<a href="#h9-0-3" id="h9-0-3" class="d">-import me.rhunk.snapenhance.Logger.debug
</a> import me.rhunk.snapenhance.config.ConfigProperty
 import me.rhunk.snapenhance.features.Feature
 import me.rhunk.snapenhance.features.FeatureLoadParams
 import me.rhunk.snapenhance.hook.HookAdapter
 import me.rhunk.snapenhance.hook.HookStage
 import me.rhunk.snapenhance.hook.Hooker
<a href="#h9-0-10" id="h9-0-10" class="d">-import java.nio.charset.StandardCharsets
</a><a href="#h9-0-11" id="h9-0-11" class="d">-import java.util.Base64
</a> 
 class DisableMetrics : Feature(&quot;DisableMetrics&quot;, loadParams = FeatureLoadParams.INIT_SYNC) {
     override fun init() {
<b>diff --git a/<a id="h10" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/manager/impl/MappingManager.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/manager/impl/MappingManager.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/manager/impl/MappingManager.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/manager/impl/MappingManager.kt</a></b>
<a href="#h10-0" id="h10-0" class="h">@@ -17,6 +17,7 @@ import me.rhunk.snapenhance.mapping.impl.CallbackMapper
</a> import me.rhunk.snapenhance.mapping.impl.EnumMapper
 import me.rhunk.snapenhance.mapping.impl.GridMediaItemMapper
 import me.rhunk.snapenhance.mapping.impl.OperaPageViewControllerMapper
<a href="#h10-0-3" id="h10-0-3" class="i">+import me.rhunk.snapenhance.mapping.impl.PlatformAnalyticsCreatorMapper
</a> import me.rhunk.snapenhance.mapping.impl.PlusSubscriptionMapper
 import me.rhunk.snapenhance.util.getObjectField
 import java.nio.charset.StandardCharsets
<a href="#h10-1" id="h10-1" class="h">@@ -31,6 +32,7 @@ class MappingManager(private val context: ModContext) : Manager {
</a>         add(PlusSubscriptionMapper())
         add(GridMediaItemMapper())
         add(BCryptClassMapper())
<a href="#h10-1-3" id="h10-1-3" class="i">+        add(PlatformAnalyticsCreatorMapper())
</a>     }
 
     private val mappings = ConcurrentHashMap&lt;String, Any&gt;()
<b>diff --git a/<a id="h11" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/mapping/impl/PlatformAnalyticsCreatorMapper.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/mapping/impl/PlatformAnalyticsCreatorMapper.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/mapping/impl/PlatformAnalyticsCreatorMapper.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/mapping/impl/PlatformAnalyticsCreatorMapper.kt</a></b>
<a href="#h11-0" id="h11-0" class="h">@@ -0,0 +1,26 @@
</a><a href="#h11-0-0" id="h11-0-0" class="i">+package me.rhunk.snapenhance.mapping.impl
</a><a href="#h11-0-1" id="h11-0-1" class="i">+
</a><a href="#h11-0-2" id="h11-0-2" class="i">+import me.rhunk.snapenhance.mapping.Mapper
</a><a href="#h11-0-3" id="h11-0-3" class="i">+
</a><a href="#h11-0-4" id="h11-0-4" class="i">+class PlatformAnalyticsCreatorMapper : Mapper() {
</a><a href="#h11-0-5" id="h11-0-5" class="i">+    override fun useClasses(
</a><a href="#h11-0-6" id="h11-0-6" class="i">+        classLoader: ClassLoader,
</a><a href="#h11-0-7" id="h11-0-7" class="i">+        classes: List&lt;Class&lt;*&gt;&gt;,
</a><a href="#h11-0-8" id="h11-0-8" class="i">+        mappings: MutableMap&lt;String, Any&gt;
</a><a href="#h11-0-9" id="h11-0-9" class="i">+    ) {
</a><a href="#h11-0-10" id="h11-0-10" class="i">+        for (clazz in classes) {
</a><a href="#h11-0-11" id="h11-0-11" class="i">+            if (clazz.isEnum || clazz.isInterface) continue
</a><a href="#h11-0-12" id="h11-0-12" class="i">+            val constructors = clazz.constructors
</a><a href="#h11-0-13" id="h11-0-13" class="i">+            if (constructors.isEmpty()) continue
</a><a href="#h11-0-14" id="h11-0-14" class="i">+            val firstConstructor = constructors[0]
</a><a href="#h11-0-15" id="h11-0-15" class="i">+            // 47 is the number of parameters of the constructor
</a><a href="#h11-0-16" id="h11-0-16" class="i">+            // can change in future versions
</a><a href="#h11-0-17" id="h11-0-17" class="i">+            if (firstConstructor.parameterCount != 47) continue
</a><a href="#h11-0-18" id="h11-0-18" class="i">+            if (!firstConstructor.parameterTypes[0].isEnum) continue
</a><a href="#h11-0-19" id="h11-0-19" class="i">+            if (firstConstructor.parameterTypes[0].enumConstants.none { it.toString() == &quot;IN_APP_NOTIFICATION&quot; }) continue
</a><a href="#h11-0-20" id="h11-0-20" class="i">+
</a><a href="#h11-0-21" id="h11-0-21" class="i">+            mappings[&quot;PlatformAnalyticsCreator&quot;] = clazz.name
</a><a href="#h11-0-22" id="h11-0-22" class="i">+            return
</a><a href="#h11-0-23" id="h11-0-23" class="i">+        }
</a><a href="#h11-0-24" id="h11-0-24" class="i">+    }
</a><a href="#h11-0-25" id="h11-0-25" class="i">+}</a><a href="#h11-0-26" id="h11-0-26" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h12" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/util/CallbackBuilder.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/util/CallbackBuilder.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/util/CallbackBuilder.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/util/CallbackBuilder.kt</a></b>
<a href="#h12-0" id="h12-0" class="h">@@ -69,7 +69,7 @@ class CallbackBuilder(
</a>     }
 
     companion object {
<a href="#h12-0-3" id="h12-0-3" class="d">-        private fun createEmptyObject(constructor: Constructor&lt;*&gt;): Any? {
</a><a href="#h12-0-4" id="h12-0-4" class="i">+        fun createEmptyObject(constructor: Constructor&lt;*&gt;): Any? {
</a>             //compute the args for the constructor with null or default primitive values
             val args = constructor.parameterTypes.map { type: Class&lt;*&gt; -&gt;
                 if (type.isPrimitive) {
</pre>
</div>
</body>
</html>
