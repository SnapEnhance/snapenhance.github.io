<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>fix(app/logged_stories): coil preview decoder - SnapEnhance - An Xposed module offering an enhanced Snapchat experience
</title>
<link rel="icon" type="image/svg+xml" href="../../logo.png"/>
<link rel="alternate icon" href="../../favicon.png"/>
<link rel="alternate" type="application/atom+xml" title="SnapEnhance Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="SnapEnhance Atom Feed (tags)" href="../tags.xml" />
<link rel="stylesheet" type="text/css" href="../../style.css" />
<link rel="stylesheet" type="text/css" href="../../fonts.css" />
</head>
<body>
<div id="head"><table><tr><td><a class="logo" href="../../"><img src="../../logo.png" alt="" width="32" height="32" /></a></td><td><strong>SnapEnhance</strong><span class="desc"> - An Xposed module offering an enhanced Snapchat experience
</span>
</td></tr></table>
<p><a href="../about.html">About</a> | <a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/LICENSE.html">License</a></p>
</div>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/3d2dcec9857def6282341500117ce4f7e0c4970c.html">3d2dcec9857def6282341500117ce4f7e0c4970c</a>
<b>parent</b> <a href="../commit/b1860ed29f1a862b2aac91ebb94a5ab102598993.html">b1860ed29f1a862b2aac91ebb94a5ab102598993</a>
<b>Author:</b> rhunk &lt;<a href="mailto:101876869+rhunk@users.noreply.github.com">101876869+rhunk@users.noreply.github.com</a>&gt;
<b>Date:</b>   Mon,  1 Apr 2024 19:47:09 +0200

fix(app/logged_stories): coil preview decoder

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadProcessor.kt</a></td><td> | </td><td class="num">18</td><td><span class="i">++++++++</span><span class="d">----------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">app/src/main/kotlin/me/rhunk/snapenhance/messaging/StreaksReminder.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h2">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/social/LoggedStories.kt</a></td><td> | </td><td class="num">212</td><td><span class="i">++++++++++++++++++++++++++++</span><span class="d">---------------------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h3">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/social/ManageScope.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h4">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/social/SocialRoot.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="D">D</td><td><a href="#h5">app/src/main/kotlin/me/rhunk/snapenhance/ui/util/ComposeImageHelper.kt</a></td><td> | </td><td class="num">61</td><td><span class="i"></span><span class="d">-------------------------------------------------------------</span></td></tr>
<tr><td class="A">A</td><td><a href="#h6">app/src/main/kotlin/me/rhunk/snapenhance/ui/util/coil/CoilPreviewDecoder.kt</a></td><td> | </td><td class="num">62</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h7">app/src/main/kotlin/me/rhunk/snapenhance/ui/util/coil/ComposeImageHelper.kt</a></td><td> | </td><td class="num">72</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h8">common/src/main/kotlin/me/rhunk/snapenhance/common/data/MessagingCoreObjects.kt</a></td><td> | </td><td class="num">7</td><td><span class="i">+++++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h9">common/src/main/kotlin/me/rhunk/snapenhance/common/data/download/MediaEncryptionKeyPair.kt</a></td><td> | </td><td class="num">3</td><td><span class="i">++</span><span class="d">-</span></td></tr>
</table></pre><pre>10 files changed, 226 insertions(+), 215 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadProcessor.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadProcessor.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadProcessor.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadProcessor.kt</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -186,20 +186,16 @@ class DownloadProcessor (
</a>             fun handleInputStream(inputStream: InputStream, estimatedSize: Long = 0L) {
                 createMediaTempFile().apply {
                     val decryptedInputStream = (inputMedia.encryption?.decryptInputStream(inputStream) ?: inputStream).buffered()
<a href="#h0-0-3" id="h0-0-3" class="d">-                    val buffer = ByteArray(DEFAULT_BUFFER_SIZE)
</a><a href="#h0-0-4" id="h0-0-4" class="i">+                    val buffer = ByteArray(1024 * 1024 * 2) // 2MB
</a>                     var read: Int
                     var totalRead = 0L
<a href="#h0-0-7" id="h0-0-7" class="d">-                    var lastTotalRead = 0L
</a> 
                     outputStream().use { outputStream -&gt;
                         while (decryptedInputStream.read(buffer).also { read = it } != -1) {
                             outputStream.write(buffer, 0, read)
                             totalRead += read
                             inputMediaDownloadedBytes[inputMedia] = totalRead
<a href="#h0-0-14" id="h0-0-14" class="d">-                            if (totalRead - lastTotalRead &gt; 1024 * 1024) {
</a><a href="#h0-0-15" id="h0-0-15" class="d">-                                setProgress(&quot;${totalRead / 1024}KB/${estimatedSize / 1024}KB&quot;)
</a><a href="#h0-0-16" id="h0-0-16" class="d">-                                lastTotalRead = totalRead
</a><a href="#h0-0-17" id="h0-0-17" class="d">-                            }
</a><a href="#h0-0-18" id="h0-0-18" class="i">+                            setProgress(&quot;${totalRead / 1024}KB/${estimatedSize / 1024}KB&quot;)
</a>                         }
                     }
                 }.also { downloadedMedias[inputMedia] = it }
<a href="#h0-1" id="h0-1" class="h">@@ -228,12 +224,14 @@ class DownloadProcessor (
</a>                     }
                     DownloadMediaType.DIRECT_MEDIA -&gt; {
                         val decoded = Base64.UrlSafe.decode(inputMedia.content)
<a href="#h0-1-3" id="h0-1-3" class="d">-                        createMediaTempFile().apply {
</a><a href="#h0-1-4" id="h0-1-4" class="d">-                            writeBytes(decoded)
</a><a href="#h0-1-5" id="h0-1-5" class="d">-                        }.also { downloadedMedias[inputMedia] = it }
</a><a href="#h0-1-6" id="h0-1-6" class="i">+                        totalSize += decoded.size.toLong()
</a><a href="#h0-1-7" id="h0-1-7" class="i">+                        handleInputStream(decoded.inputStream(), estimatedSize = decoded.size.toLong())
</a>                     }
                     else -&gt; {
<a href="#h0-1-10" id="h0-1-10" class="d">-                        downloadedMedias[inputMedia] = File(inputMedia.content)
</a><a href="#h0-1-11" id="h0-1-11" class="i">+                        File(inputMedia.content).inputStream().use {
</a><a href="#h0-1-12" id="h0-1-12" class="i">+                            totalSize += it.available().toLong()
</a><a href="#h0-1-13" id="h0-1-13" class="i">+                            handleInputStream(it, estimatedSize = it.available().toLong())
</a><a href="#h0-1-14" id="h0-1-14" class="i">+                        }
</a>                     }
                 }
             }.also { jobs.add(it) }
<b>diff --git a/<a id="h1" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/messaging/StreaksReminder.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/messaging/StreaksReminder.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/messaging/StreaksReminder.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/messaging/StreaksReminder.kt</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -15,7 +15,7 @@ import me.rhunk.snapenhance.RemoteSideContext
</a> import me.rhunk.snapenhance.SharedContextHolder
 import me.rhunk.snapenhance.bridge.ForceStartActivity
 import me.rhunk.snapenhance.common.util.snap.BitmojiSelfie
<a href="#h1-0-3" id="h1-0-3" class="d">-import me.rhunk.snapenhance.ui.util.ImageRequestHelper
</a><a href="#h1-0-4" id="h1-0-4" class="i">+import me.rhunk.snapenhance.ui.util.coil.ImageRequestHelper
</a> import kotlin.time.Duration.Companion.hours
 import kotlin.time.Duration.Companion.milliseconds
 import kotlin.time.Duration.Companion.minutes
<b>diff --git a/<a id="h2" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/social/LoggedStories.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/social/LoggedStories.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/social/LoggedStories.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/social/LoggedStories.kt</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -1,56 +1,42 @@
</a> package me.rhunk.snapenhance.ui.manager.pages.social
 
 import android.content.Intent
<a href="#h2-0-3" id="h2-0-3" class="d">-import android.graphics.Bitmap
</a><a href="#h2-0-4" id="h2-0-4" class="d">-import android.graphics.BitmapFactory
</a> import androidx.compose.foundation.Image
 import androidx.compose.foundation.clickable
 import androidx.compose.foundation.layout.*
 import androidx.compose.foundation.lazy.grid.GridCells
 import androidx.compose.foundation.lazy.grid.LazyVerticalGrid
 import androidx.compose.foundation.lazy.grid.items
<a href="#h2-0-11" id="h2-0-11" class="d">-import androidx.compose.material.icons.Icons
</a><a href="#h2-0-12" id="h2-0-12" class="d">-import androidx.compose.material.icons.filled.ErrorOutline
</a> import androidx.compose.material3.Button
 import androidx.compose.material3.Card
<a href="#h2-0-15" id="h2-0-15" class="d">-import androidx.compose.material3.CircularProgressIndicator
</a><a href="#h2-0-16" id="h2-0-16" class="d">-import androidx.compose.material3.Icon
</a><a href="#h2-0-17" id="h2-0-17" class="i">+import androidx.compose.material3.MaterialTheme
</a> import androidx.compose.material3.Text
 import androidx.compose.runtime.*
 import androidx.compose.ui.Alignment
 import androidx.compose.ui.Modifier
<a href="#h2-0-22" id="h2-0-22" class="d">-import androidx.compose.ui.graphics.ImageBitmap
</a><a href="#h2-0-23" id="h2-0-23" class="d">-import androidx.compose.ui.graphics.asImageBitmap
</a><a href="#h2-0-24" id="h2-0-24" class="i">+import androidx.compose.ui.draw.clip
</a><a href="#h2-0-25" id="h2-0-25" class="i">+import androidx.compose.ui.layout.ContentScale
</a> import androidx.compose.ui.text.style.TextAlign
 import androidx.compose.ui.unit.dp
<a href="#h2-0-28" id="h2-0-28" class="i">+import androidx.compose.ui.unit.sp
</a> import androidx.core.content.FileProvider
 import androidx.navigation.NavBackStackEntry
 import coil.annotation.ExperimentalCoilApi
<a href="#h2-0-32" id="h2-0-32" class="d">-import coil.disk.DiskCache
</a><a href="#h2-0-33" id="h2-0-33" class="d">-import kotlinx.coroutines.Dispatchers
</a><a href="#h2-0-34" id="h2-0-34" class="d">-import kotlinx.coroutines.withContext
</a><a href="#h2-0-35" id="h2-0-35" class="d">-import kotlinx.coroutines.withTimeout
</a><a href="#h2-0-36" id="h2-0-36" class="i">+import coil.compose.rememberAsyncImagePainter
</a> import me.rhunk.snapenhance.bridge.DownloadCallback
 import me.rhunk.snapenhance.common.data.FileType
 import me.rhunk.snapenhance.common.data.StoryData
 import me.rhunk.snapenhance.common.data.download.*
 import me.rhunk.snapenhance.common.util.ktx.longHashCode
<a href="#h2-0-42" id="h2-0-42" class="d">-import me.rhunk.snapenhance.common.util.snap.MediaDownloaderHelper
</a><a href="#h2-0-43" id="h2-0-43" class="d">-import me.rhunk.snapenhance.core.util.media.PreviewUtils
</a> import me.rhunk.snapenhance.download.DownloadProcessor
 import me.rhunk.snapenhance.ui.manager.Routes
 import me.rhunk.snapenhance.ui.util.Dialog
<a href="#h2-0-47" id="h2-0-47" class="d">-import okhttp3.HttpUrl.Companion.toHttpUrl
</a><a href="#h2-0-48" id="h2-0-48" class="i">+import me.rhunk.snapenhance.ui.util.coil.ImageRequestHelper
</a> import okhttp3.OkHttpClient
<a href="#h2-0-50" id="h2-0-50" class="d">-import okhttp3.Request
</a> import java.io.File
 import java.text.DateFormat
 import java.util.Date
 import java.util.UUID
<a href="#h2-0-55" id="h2-0-55" class="d">-import javax.crypto.Cipher
</a><a href="#h2-0-56" id="h2-0-56" class="d">-import javax.crypto.CipherInputStream
</a><a href="#h2-0-57" id="h2-0-57" class="d">-import javax.crypto.spec.IvParameterSpec
</a><a href="#h2-0-58" id="h2-0-58" class="d">-import javax.crypto.spec.SecretKeySpec
</a> import kotlin.math.absoluteValue
 
 class LoggedStories : Routes.Route() {
<a href="#h2-1" id="h2-1" class="h">@@ -58,24 +44,18 @@ class LoggedStories : Routes.Route() {
</a>     override val content: @Composable (NavBackStackEntry) -&gt; Unit = content@{ navBackStackEntry -&gt;
         val userId = navBackStackEntry.arguments?.getString(&quot;id&quot;) ?: return@content
 
<a href="#h2-1-3" id="h2-1-3" class="d">-        val stories = remember {
</a><a href="#h2-1-4" id="h2-1-4" class="d">-            mutableStateListOf&lt;StoryData&gt;()
</a><a href="#h2-1-5" id="h2-1-5" class="d">-        }
</a><a href="#h2-1-6" id="h2-1-6" class="d">-        val friendInfo = remember {
</a><a href="#h2-1-7" id="h2-1-7" class="d">-            context.modDatabase.getFriendInfo(userId)
</a><a href="#h2-1-8" id="h2-1-8" class="d">-        }
</a><a href="#h2-1-9" id="h2-1-9" class="d">-        val httpClient = remember { OkHttpClient() }
</a><a href="#h2-1-10" id="h2-1-10" class="i">+        val stories = remember { mutableStateListOf&lt;StoryData&gt;() }
</a><a href="#h2-1-11" id="h2-1-11" class="i">+        val friendInfo = remember { context.modDatabase.getFriendInfo(userId) }
</a>         var lastStoryTimestamp by remember { mutableLongStateOf(Long.MAX_VALUE) }
 
         var selectedStory by remember { mutableStateOf&lt;StoryData?&gt;(null) }
<a href="#h2-1-15" id="h2-1-15" class="d">-        var coilCachedFile by remember { mutableStateOf&lt;File?&gt;(null) }
</a> 
         selectedStory?.let { story -&gt;
             fun downloadSelectedStory(
                 inputMedia: InputMedia,
             ) {
                 val mediaAuthor = friendInfo?.mutableUsername ?: userId
<a href="#h2-1-22" id="h2-1-22" class="d">-                val uniqueHash = (selectedStory?.url ?: UUID.randomUUID().toString()).longHashCode().absoluteValue.toString(16)
</a><a href="#h2-1-23" id="h2-1-23" class="i">+                val uniqueHash = UUID.randomUUID().toString().longHashCode().absoluteValue.toString(16)
</a> 
                 DownloadProcessor(
                     remoteSideContext = context,
<a href="#h2-2" id="h2-2" class="h">@@ -131,24 +111,41 @@ class LoggedStories : Routes.Route() {
</a>                         ) {
                             Button(onClick = {
                                 context.androidContext.externalCacheDir?.let { cacheDir -&gt;
<a href="#h2-2-3" id="h2-2-3" class="d">-                                    val cacheFile = coilCachedFile ?: run {
</a><a href="#h2-2-4" id="h2-2-4" class="i">+                                    context.imageLoader.diskCache?.openSnapshot(story.url)?.use { diskCacheSnapshot -&gt;
</a><a href="#h2-2-5" id="h2-2-5" class="i">+                                        val cacheFile = diskCacheSnapshot.data.toFile()
</a><a href="#h2-2-6" id="h2-2-6" class="i">+                                        val targetFile = File(cacheDir, cacheFile.name).also {
</a><a href="#h2-2-7" id="h2-2-7" class="i">+                                            it.deleteOnExit()
</a><a href="#h2-2-8" id="h2-2-8" class="i">+                                        }
</a><a href="#h2-2-9" id="h2-2-9" class="i">+
</a><a href="#h2-2-10" id="h2-2-10" class="i">+                                        runCatching {
</a><a href="#h2-2-11" id="h2-2-11" class="i">+                                            cacheFile.inputStream().let {
</a><a href="#h2-2-12" id="h2-2-12" class="i">+                                                story.getEncryptionKeyPair()?.decryptInputStream(it) ?: it
</a><a href="#h2-2-13" id="h2-2-13" class="i">+                                            }.use { inputStream -&gt;
</a><a href="#h2-2-14" id="h2-2-14" class="i">+                                                targetFile.outputStream().use { outputStream -&gt;
</a><a href="#h2-2-15" id="h2-2-15" class="i">+                                                    inputStream.copyTo(outputStream)
</a><a href="#h2-2-16" id="h2-2-16" class="i">+                                                }
</a><a href="#h2-2-17" id="h2-2-17" class="i">+                                            }
</a><a href="#h2-2-18" id="h2-2-18" class="i">+
</a><a href="#h2-2-19" id="h2-2-19" class="i">+                                            context.androidContext.startActivity(Intent().apply {
</a><a href="#h2-2-20" id="h2-2-20" class="i">+                                                action = Intent.ACTION_VIEW
</a><a href="#h2-2-21" id="h2-2-21" class="i">+                                                setDataAndType(
</a><a href="#h2-2-22" id="h2-2-22" class="i">+                                                    FileProvider.getUriForFile(
</a><a href="#h2-2-23" id="h2-2-23" class="i">+                                                        context.androidContext,
</a><a href="#h2-2-24" id="h2-2-24" class="i">+                                                        &quot;me.rhunk.snapenhance.fileprovider&quot;,
</a><a href="#h2-2-25" id="h2-2-25" class="i">+                                                        targetFile
</a><a href="#h2-2-26" id="h2-2-26" class="i">+                                                    ),
</a><a href="#h2-2-27" id="h2-2-27" class="i">+                                                    FileType.fromFile(targetFile).mimeType
</a><a href="#h2-2-28" id="h2-2-28" class="i">+                                                )
</a><a href="#h2-2-29" id="h2-2-29" class="i">+                                                addFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION or Intent.FLAG_ACTIVITY_NEW_TASK)
</a><a href="#h2-2-30" id="h2-2-30" class="i">+                                            })
</a><a href="#h2-2-31" id="h2-2-31" class="i">+                                        }.onFailure {
</a><a href="#h2-2-32" id="h2-2-32" class="i">+                                            context.shortToast(&quot;Failed to open file. Check logs for more info&quot;)
</a><a href="#h2-2-33" id="h2-2-33" class="i">+                                            context.log.error(&quot;Failed to open file&quot;, it)
</a><a href="#h2-2-34" id="h2-2-34" class="i">+                                        }
</a><a href="#h2-2-35" id="h2-2-35" class="i">+                                    } ?: run {
</a>                                         context.shortToast(&quot;Failed to get file&quot;)
                                         return@Button
                                     }
<a href="#h2-2-39" id="h2-2-39" class="d">-                                    val targetFile = File(cacheDir, cacheFile.name)
</a><a href="#h2-2-40" id="h2-2-40" class="d">-                                    cacheFile.copyTo(targetFile, overwrite = true)
</a><a href="#h2-2-41" id="h2-2-41" class="d">-                                    context.androidContext.startActivity(Intent().apply {
</a><a href="#h2-2-42" id="h2-2-42" class="d">-                                        action = Intent.ACTION_VIEW
</a><a href="#h2-2-43" id="h2-2-43" class="d">-                                        setDataAndType(
</a><a href="#h2-2-44" id="h2-2-44" class="d">-                                            FileProvider.getUriForFile(
</a><a href="#h2-2-45" id="h2-2-45" class="d">-                                                context.androidContext,
</a><a href="#h2-2-46" id="h2-2-46" class="d">-                                                &quot;me.rhunk.snapenhance.fileprovider&quot;,
</a><a href="#h2-2-47" id="h2-2-47" class="d">-                                                targetFile
</a><a href="#h2-2-48" id="h2-2-48" class="d">-                                            ),
</a><a href="#h2-2-49" id="h2-2-49" class="d">-                                            FileType.fromFile(targetFile).mimeType
</a><a href="#h2-2-50" id="h2-2-50" class="d">-                                        )
</a><a href="#h2-2-51" id="h2-2-51" class="d">-                                        addFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION or Intent.FLAG_ACTIVITY_NEW_TASK)
</a><a href="#h2-2-52" id="h2-2-52" class="d">-                                    })
</a>                                 }
                             }) {
                                 Text(text = &quot;Open&quot;)
<a href="#h2-3" id="h2-3" class="h">@@ -159,22 +156,27 @@ class LoggedStories : Routes.Route() {
</a>                                     InputMedia(
                                         content = story.url,
                                         type = DownloadMediaType.REMOTE_MEDIA,
<a href="#h2-3-3" id="h2-3-3" class="d">-                                        encryption = story.key?.let { it to story.iv!! }?.toKeyPair()
</a><a href="#h2-3-4" id="h2-3-4" class="i">+                                        encryption = story.getEncryptionKeyPair()
</a>                                     )
                                 )
                             }) {
                                 Text(text = &quot;Download&quot;)
                             }
 
<a href="#h2-3-11" id="h2-3-11" class="d">-                            if (coilCachedFile != null) {
</a><a href="#h2-3-12" id="h2-3-12" class="i">+                            if (remember {
</a><a href="#h2-3-13" id="h2-3-13" class="i">+                                context.imageLoader.diskCache?.openSnapshot(story.url)?.also { it.close() } != null
</a><a href="#h2-3-14" id="h2-3-14" class="i">+                            }) {
</a>                                 Button(onClick = {
                                     downloadSelectedStory(
                                         InputMedia(
<a href="#h2-3-18" id="h2-3-18" class="d">-                                            content = coilCachedFile?.absolutePath ?: run {
</a><a href="#h2-3-19" id="h2-3-19" class="d">-                                                context.shortToast(&quot;Failed to get file from cache&quot;)
</a><a href="#h2-3-20" id="h2-3-20" class="i">+                                            content = context.imageLoader.diskCache?.openSnapshot(story.url)?.use {
</a><a href="#h2-3-21" id="h2-3-21" class="i">+                                                it.data.toFile().absolutePath
</a><a href="#h2-3-22" id="h2-3-22" class="i">+                                            } ?: run {
</a><a href="#h2-3-23" id="h2-3-23" class="i">+                                                context.shortToast(&quot;Failed to get file&quot;)
</a>                                                 return@Button
                                             },
<a href="#h2-3-26" id="h2-3-26" class="d">-                                            type = DownloadMediaType.LOCAL_MEDIA
</a><a href="#h2-3-27" id="h2-3-27" class="i">+                                            type = DownloadMediaType.LOCAL_MEDIA,
</a><a href="#h2-3-28" id="h2-3-28" class="i">+                                            encryption = story.getEncryptionKeyPair()
</a>                                         )
                                     )
                                 }) {
<a href="#h2-4" id="h2-4" class="h">@@ -195,107 +197,41 @@ class LoggedStories : Routes.Route() {
</a>             columns = GridCells.Adaptive(100.dp),
             contentPadding = PaddingValues(8.dp),
         ) {
<a href="#h2-4-3" id="h2-4-3" class="d">-            items(stories) { story -&gt;
</a><a href="#h2-4-4" id="h2-4-4" class="d">-                var isFailed by remember { mutableStateOf(false) }
</a><a href="#h2-4-5" id="h2-4-5" class="d">-                var imageBitmap by remember { mutableStateOf&lt;ImageBitmap?&gt;(null) }
</a><a href="#h2-4-6" id="h2-4-6" class="d">-                val uniqueHash = remember { story.url.hashCode().absoluteValue.toString(16) }
</a><a href="#h2-4-7" id="h2-4-7" class="d">-
</a><a href="#h2-4-8" id="h2-4-8" class="d">-                fun openDiskCacheSnapshot(snapshot: DiskCache.Snapshot): Boolean {
</a><a href="#h2-4-9" id="h2-4-9" class="d">-                    runCatching {
</a><a href="#h2-4-10" id="h2-4-10" class="d">-                        val mediaList = mutableMapOf&lt;SplitMediaAssetType, ByteArray&gt;()
</a><a href="#h2-4-11" id="h2-4-11" class="d">-
</a><a href="#h2-4-12" id="h2-4-12" class="d">-                        snapshot.data.toFile().inputStream().use { inputStream -&gt;
</a><a href="#h2-4-13" id="h2-4-13" class="d">-                            MediaDownloaderHelper.getSplitElements(inputStream) { type, splitInputStream -&gt;
</a><a href="#h2-4-14" id="h2-4-14" class="d">-                                mediaList[type] = splitInputStream.readBytes()
</a><a href="#h2-4-15" id="h2-4-15" class="d">-                            }
</a><a href="#h2-4-16" id="h2-4-16" class="d">-                        }
</a><a href="#h2-4-17" id="h2-4-17" class="d">-
</a><a href="#h2-4-18" id="h2-4-18" class="d">-                        val originalMedia = mediaList[SplitMediaAssetType.ORIGINAL] ?: return@runCatching false
</a><a href="#h2-4-19" id="h2-4-19" class="d">-                        val overlay = mediaList[SplitMediaAssetType.OVERLAY]
</a><a href="#h2-4-20" id="h2-4-20" class="d">-
</a><a href="#h2-4-21" id="h2-4-21" class="d">-                        var bitmap: Bitmap? = PreviewUtils.createPreview(originalMedia, isVideo = FileType.fromByteArray(originalMedia).isVideo)
</a><a href="#h2-4-22" id="h2-4-22" class="d">-
</a><a href="#h2-4-23" id="h2-4-23" class="d">-                        overlay?.also {
</a><a href="#h2-4-24" id="h2-4-24" class="d">-                            bitmap = PreviewUtils.mergeBitmapOverlay(bitmap!!, BitmapFactory.decodeByteArray(it, 0, it.size))
</a><a href="#h2-4-25" id="h2-4-25" class="d">-                        }
</a><a href="#h2-4-26" id="h2-4-26" class="d">-
</a><a href="#h2-4-27" id="h2-4-27" class="d">-                        imageBitmap = bitmap?.asImageBitmap()
</a><a href="#h2-4-28" id="h2-4-28" class="d">-                        return true
</a><a href="#h2-4-29" id="h2-4-29" class="d">-                    }.onFailure {
</a><a href="#h2-4-30" id="h2-4-30" class="d">-                        context.log.error(&quot;Failed to open disk cache snapshot&quot;, it)
</a><a href="#h2-4-31" id="h2-4-31" class="d">-                    }
</a><a href="#h2-4-32" id="h2-4-32" class="d">-                    return false
</a><a href="#h2-4-33" id="h2-4-33" class="d">-                }
</a><a href="#h2-4-34" id="h2-4-34" class="d">-
</a><a href="#h2-4-35" id="h2-4-35" class="d">-                LaunchedEffect(Unit) {
</a><a href="#h2-4-36" id="h2-4-36" class="d">-                    withContext(Dispatchers.IO) {
</a><a href="#h2-4-37" id="h2-4-37" class="d">-                        withTimeout(10000L) {
</a><a href="#h2-4-38" id="h2-4-38" class="d">-                            context.imageLoader.diskCache?.openSnapshot(uniqueHash)?.use {
</a><a href="#h2-4-39" id="h2-4-39" class="d">-                                if (!openDiskCacheSnapshot(it)) isFailed = true
</a><a href="#h2-4-40" id="h2-4-40" class="d">-                                return@withTimeout
</a><a href="#h2-4-41" id="h2-4-41" class="d">-                            }
</a><a href="#h2-4-42" id="h2-4-42" class="d">-
</a><a href="#h2-4-43" id="h2-4-43" class="d">-                            runCatching {
</a><a href="#h2-4-44" id="h2-4-44" class="d">-                                val response = httpClient.newCall(Request(
</a><a href="#h2-4-45" id="h2-4-45" class="d">-                                    url = story.url.toHttpUrl()
</a><a href="#h2-4-46" id="h2-4-46" class="d">-                                )).execute()
</a><a href="#h2-4-47" id="h2-4-47" class="d">-                                response.body.byteStream().use {
</a><a href="#h2-4-48" id="h2-4-48" class="d">-                                    val decrypted = story.key?.let { _ -&gt;
</a><a href="#h2-4-49" id="h2-4-49" class="d">-                                        val cipher = Cipher.getInstance(&quot;AES/CBC/PKCS5Padding&quot;)
</a><a href="#h2-4-50" id="h2-4-50" class="d">-                                        cipher.init(Cipher.DECRYPT_MODE, SecretKeySpec(story.key, &quot;AES&quot;), IvParameterSpec(story.iv))
</a><a href="#h2-4-51" id="h2-4-51" class="d">-                                        CipherInputStream(it, cipher)
</a><a href="#h2-4-52" id="h2-4-52" class="d">-                                    } ?: it
</a><a href="#h2-4-53" id="h2-4-53" class="d">-
</a><a href="#h2-4-54" id="h2-4-54" class="d">-                                    context.imageLoader.diskCache?.openEditor(uniqueHash)?.apply {
</a><a href="#h2-4-55" id="h2-4-55" class="d">-                                        data.toFile().outputStream().use { fos -&gt;
</a><a href="#h2-4-56" id="h2-4-56" class="d">-                                            decrypted.copyTo(fos)
</a><a href="#h2-4-57" id="h2-4-57" class="d">-                                        }
</a><a href="#h2-4-58" id="h2-4-58" class="d">-                                        commitAndOpenSnapshot()?.use { snapshot -&gt;
</a><a href="#h2-4-59" id="h2-4-59" class="d">-                                            if (!openDiskCacheSnapshot(snapshot)) isFailed = true
</a><a href="#h2-4-60" id="h2-4-60" class="d">-                                        }
</a><a href="#h2-4-61" id="h2-4-61" class="d">-                                    }
</a><a href="#h2-4-62" id="h2-4-62" class="d">-                                }
</a><a href="#h2-4-63" id="h2-4-63" class="d">-                            }.onFailure {
</a><a href="#h2-4-64" id="h2-4-64" class="d">-                                isFailed = true
</a><a href="#h2-4-65" id="h2-4-65" class="d">-                                context.log.error(&quot;Failed to load story&quot;, it)
</a><a href="#h2-4-66" id="h2-4-66" class="d">-                            }
</a><a href="#h2-4-67" id="h2-4-67" class="d">-                        }
</a><a href="#h2-4-68" id="h2-4-68" class="d">-                    }
</a><a href="#h2-4-69" id="h2-4-69" class="d">-                }
</a><a href="#h2-4-70" id="h2-4-70" class="i">+            items(stories, key = { it.url }) { story -&gt;
</a><a href="#h2-4-71" id="h2-4-71" class="i">+                var hasFailed by remember(story.url) { mutableStateOf(false) }
</a> 
                 Column(
                     modifier = Modifier
                         .padding(8.dp)
                         .clickable {
                             selectedStory = story
<a href="#h2-4-78" id="h2-4-78" class="d">-                            coilCachedFile = context.imageLoader.diskCache
</a><a href="#h2-4-79" id="h2-4-79" class="d">-                                ?.openSnapshot(uniqueHash)
</a><a href="#h2-4-80" id="h2-4-80" class="d">-                                .use {
</a><a href="#h2-4-81" id="h2-4-81" class="d">-                                    it?.data?.toFile()
</a><a href="#h2-4-82" id="h2-4-82" class="d">-                                }
</a>                         }
<a href="#h2-4-84" id="h2-4-84" class="i">+                        .clip(MaterialTheme.shapes.medium)
</a>                         .heightIn(min = 128.dp),
                     horizontalAlignment = Alignment.CenterHorizontally,
                     verticalArrangement = Arrangement.Center,
                 ) {
<a href="#h2-4-89" id="h2-4-89" class="d">-                    if (isFailed) {
</a><a href="#h2-4-90" id="h2-4-90" class="d">-                        Icon(
</a><a href="#h2-4-91" id="h2-4-91" class="d">-                            imageVector = Icons.Default.ErrorOutline,
</a><a href="#h2-4-92" id="h2-4-92" class="d">-                            contentDescription = &quot;&quot;,
</a><a href="#h2-4-93" id="h2-4-93" class="d">-                            modifier = Modifier.size(48.dp)
</a><a href="#h2-4-94" id="h2-4-94" class="d">-                        )
</a><a href="#h2-4-95" id="h2-4-95" class="i">+                    if (hasFailed) {
</a><a href="#h2-4-96" id="h2-4-96" class="i">+                        Text(text = &quot;Failed to load&quot;, Modifier.padding(8.dp), fontSize = 10.sp)
</a>                     } else {
<a href="#h2-4-98" id="h2-4-98" class="d">-                        imageBitmap?.let {
</a><a href="#h2-4-99" id="h2-4-99" class="d">-                            Card {
</a><a href="#h2-4-100" id="h2-4-100" class="d">-                                Image(
</a><a href="#h2-4-101" id="h2-4-101" class="d">-                                    bitmap = it,
</a><a href="#h2-4-102" id="h2-4-102" class="d">-                                    modifier = Modifier.fillMaxSize(),
</a><a href="#h2-4-103" id="h2-4-103" class="d">-                                    contentDescription = null,
</a><a href="#h2-4-104" id="h2-4-104" class="d">-                                )
</a><a href="#h2-4-105" id="h2-4-105" class="d">-                            }
</a><a href="#h2-4-106" id="h2-4-106" class="d">-                        } ?: run {
</a><a href="#h2-4-107" id="h2-4-107" class="d">-                            CircularProgressIndicator()
</a><a href="#h2-4-108" id="h2-4-108" class="d">-                        }
</a><a href="#h2-4-109" id="h2-4-109" class="i">+                        Image(
</a><a href="#h2-4-110" id="h2-4-110" class="i">+                            painter = rememberAsyncImagePainter(
</a><a href="#h2-4-111" id="h2-4-111" class="i">+                                model = ImageRequestHelper.newPreviewImageRequest(
</a><a href="#h2-4-112" id="h2-4-112" class="i">+                                    context.androidContext,
</a><a href="#h2-4-113" id="h2-4-113" class="i">+                                    story.url,
</a><a href="#h2-4-114" id="h2-4-114" class="i">+                                    story.getEncryptionKeyPair(),
</a><a href="#h2-4-115" id="h2-4-115" class="i">+                                ),
</a><a href="#h2-4-116" id="h2-4-116" class="i">+                                imageLoader = context.imageLoader,
</a><a href="#h2-4-117" id="h2-4-117" class="i">+                                onError = {
</a><a href="#h2-4-118" id="h2-4-118" class="i">+                                    hasFailed = true
</a><a href="#h2-4-119" id="h2-4-119" class="i">+                                }
</a><a href="#h2-4-120" id="h2-4-120" class="i">+                            ),
</a><a href="#h2-4-121" id="h2-4-121" class="i">+                            contentDescription = null,
</a><a href="#h2-4-122" id="h2-4-122" class="i">+                            contentScale = ContentScale.FillWidth,
</a><a href="#h2-4-123" id="h2-4-123" class="i">+                            modifier = Modifier
</a><a href="#h2-4-124" id="h2-4-124" class="i">+                                .fillMaxSize()
</a><a href="#h2-4-125" id="h2-4-125" class="i">+                                .height(128.dp)
</a><a href="#h2-4-126" id="h2-4-126" class="i">+                        )
</a>                     }
                 }
             }
<b>diff --git a/<a id="h3" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/social/ManageScope.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/social/ManageScope.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/social/ManageScope.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/social/ManageScope.kt</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -22,7 +22,7 @@ import me.rhunk.snapenhance.common.data.SocialScope
</a> import me.rhunk.snapenhance.common.util.snap.BitmojiSelfie
 import me.rhunk.snapenhance.ui.manager.Routes
 import me.rhunk.snapenhance.ui.util.AlertDialogs
<a href="#h3-0-3" id="h3-0-3" class="d">-import me.rhunk.snapenhance.ui.util.BitmojiImage
</a><a href="#h3-0-4" id="h3-0-4" class="i">+import me.rhunk.snapenhance.ui.util.coil.BitmojiImage
</a> import me.rhunk.snapenhance.ui.util.Dialog
 import kotlin.io.encoding.Base64
 import kotlin.io.encoding.ExperimentalEncodingApi
<b>diff --git a/<a id="h4" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/social/SocialRoot.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/social/SocialRoot.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/social/SocialRoot.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/social/SocialRoot.kt</a></b>
<a href="#h4-0" id="h4-0" class="h">@@ -31,7 +31,7 @@ import me.rhunk.snapenhance.common.data.MessagingGroupInfo
</a> import me.rhunk.snapenhance.common.data.SocialScope
 import me.rhunk.snapenhance.common.util.snap.BitmojiSelfie
 import me.rhunk.snapenhance.ui.manager.Routes
<a href="#h4-0-3" id="h4-0-3" class="d">-import me.rhunk.snapenhance.ui.util.BitmojiImage
</a><a href="#h4-0-4" id="h4-0-4" class="i">+import me.rhunk.snapenhance.ui.util.coil.BitmojiImage
</a> import me.rhunk.snapenhance.ui.util.pagerTabIndicatorOffset
 
 class SocialRoot : Routes.Route() {
<b>diff --git a/<a id="h5" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/util/ComposeImageHelper.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/util/ComposeImageHelper.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/util/ComposeImageHelper.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/util/ComposeImageHelper.kt</a></b>
<a href="#h5-0" id="h5-0" class="h">@@ -1,60 +0,0 @@
</a><a href="#h5-0-0" id="h5-0-0" class="d">-package me.rhunk.snapenhance.ui.util
</a><a href="#h5-0-1" id="h5-0-1" class="d">-
</a><a href="#h5-0-2" id="h5-0-2" class="d">-import android.content.Context
</a><a href="#h5-0-3" id="h5-0-3" class="d">-import androidx.compose.foundation.Image
</a><a href="#h5-0-4" id="h5-0-4" class="d">-import androidx.compose.foundation.layout.height
</a><a href="#h5-0-5" id="h5-0-5" class="d">-import androidx.compose.foundation.layout.requiredWidthIn
</a><a href="#h5-0-6" id="h5-0-6" class="d">-import androidx.compose.material3.MaterialTheme
</a><a href="#h5-0-7" id="h5-0-7" class="d">-import androidx.compose.runtime.Composable
</a><a href="#h5-0-8" id="h5-0-8" class="d">-import androidx.compose.ui.Modifier
</a><a href="#h5-0-9" id="h5-0-9" class="d">-import androidx.compose.ui.draw.clip
</a><a href="#h5-0-10" id="h5-0-10" class="d">-import androidx.compose.ui.layout.ContentScale
</a><a href="#h5-0-11" id="h5-0-11" class="d">-import androidx.compose.ui.unit.dp
</a><a href="#h5-0-12" id="h5-0-12" class="d">-import coil.compose.rememberAsyncImagePainter
</a><a href="#h5-0-13" id="h5-0-13" class="d">-import coil.request.ImageRequest
</a><a href="#h5-0-14" id="h5-0-14" class="d">-import coil.size.Precision
</a><a href="#h5-0-15" id="h5-0-15" class="d">-import me.rhunk.snapenhance.R
</a><a href="#h5-0-16" id="h5-0-16" class="d">-import me.rhunk.snapenhance.RemoteSideContext
</a><a href="#h5-0-17" id="h5-0-17" class="d">-
</a><a href="#h5-0-18" id="h5-0-18" class="d">-@Composable
</a><a href="#h5-0-19" id="h5-0-19" class="d">-fun BitmojiImage(context: RemoteSideContext, modifier: Modifier = Modifier, size: Int = 48, url: String?) {
</a><a href="#h5-0-20" id="h5-0-20" class="d">-    Image(
</a><a href="#h5-0-21" id="h5-0-21" class="d">-        painter = rememberAsyncImagePainter(
</a><a href="#h5-0-22" id="h5-0-22" class="d">-            model = ImageRequestHelper.newBitmojiImageRequest(
</a><a href="#h5-0-23" id="h5-0-23" class="d">-                context.androidContext,
</a><a href="#h5-0-24" id="h5-0-24" class="d">-                url
</a><a href="#h5-0-25" id="h5-0-25" class="d">-            ),
</a><a href="#h5-0-26" id="h5-0-26" class="d">-            imageLoader = context.imageLoader
</a><a href="#h5-0-27" id="h5-0-27" class="d">-        ),
</a><a href="#h5-0-28" id="h5-0-28" class="d">-        contentDescription = null,
</a><a href="#h5-0-29" id="h5-0-29" class="d">-        contentScale = ContentScale.Crop,
</a><a href="#h5-0-30" id="h5-0-30" class="d">-        modifier = Modifier
</a><a href="#h5-0-31" id="h5-0-31" class="d">-            .requiredWidthIn(min = 0.dp, max = size.dp)
</a><a href="#h5-0-32" id="h5-0-32" class="d">-            .height(size.dp)
</a><a href="#h5-0-33" id="h5-0-33" class="d">-            .clip(MaterialTheme.shapes.medium)
</a><a href="#h5-0-34" id="h5-0-34" class="d">-            .then(modifier)
</a><a href="#h5-0-35" id="h5-0-35" class="d">-    )
</a><a href="#h5-0-36" id="h5-0-36" class="d">-}
</a><a href="#h5-0-37" id="h5-0-37" class="d">-
</a><a href="#h5-0-38" id="h5-0-38" class="d">-fun ImageRequest.Builder.cacheKey(key: String?) = apply {
</a><a href="#h5-0-39" id="h5-0-39" class="d">-    memoryCacheKey(key)
</a><a href="#h5-0-40" id="h5-0-40" class="d">-    diskCacheKey(key)
</a><a href="#h5-0-41" id="h5-0-41" class="d">-}
</a><a href="#h5-0-42" id="h5-0-42" class="d">-
</a><a href="#h5-0-43" id="h5-0-43" class="d">-object ImageRequestHelper {
</a><a href="#h5-0-44" id="h5-0-44" class="d">-    fun newBitmojiImageRequest(context: Context, url: String?) = ImageRequest.Builder(context)
</a><a href="#h5-0-45" id="h5-0-45" class="d">-        .data(url)
</a><a href="#h5-0-46" id="h5-0-46" class="d">-        .fallback(R.drawable.bitmoji_blank)
</a><a href="#h5-0-47" id="h5-0-47" class="d">-        .precision(Precision.INEXACT)
</a><a href="#h5-0-48" id="h5-0-48" class="d">-        .crossfade(true)
</a><a href="#h5-0-49" id="h5-0-49" class="d">-        .cacheKey(url)
</a><a href="#h5-0-50" id="h5-0-50" class="d">-        .build()
</a><a href="#h5-0-51" id="h5-0-51" class="d">-
</a><a href="#h5-0-52" id="h5-0-52" class="d">-    fun newDownloadPreviewImageRequest(context: Context, filePath: String?) = ImageRequest.Builder(context)
</a><a href="#h5-0-53" id="h5-0-53" class="d">-        .data(filePath)
</a><a href="#h5-0-54" id="h5-0-54" class="d">-        .cacheKey(filePath)
</a><a href="#h5-0-55" id="h5-0-55" class="d">-        .memoryCacheKey(filePath)
</a><a href="#h5-0-56" id="h5-0-56" class="d">-        .crossfade(true)
</a><a href="#h5-0-57" id="h5-0-57" class="d">-        .crossfade(200)
</a><a href="#h5-0-58" id="h5-0-58" class="d">-        .build()
</a><a href="#h5-0-59" id="h5-0-59" class="d">-}</a><a href="#h5-0-60" id="h5-0-60" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h6" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/util/coil/CoilPreviewDecoder.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/util/coil/CoilPreviewDecoder.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/util/coil/CoilPreviewDecoder.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/util/coil/CoilPreviewDecoder.kt</a></b>
<a href="#h6-0" id="h6-0" class="h">@@ -0,0 +1,61 @@
</a><a href="#h6-0-0" id="h6-0-0" class="i">+package me.rhunk.snapenhance.ui.util.coil
</a><a href="#h6-0-1" id="h6-0-1" class="i">+
</a><a href="#h6-0-2" id="h6-0-2" class="i">+import android.content.res.Resources
</a><a href="#h6-0-3" id="h6-0-3" class="i">+import android.graphics.Bitmap
</a><a href="#h6-0-4" id="h6-0-4" class="i">+import android.graphics.drawable.BitmapDrawable
</a><a href="#h6-0-5" id="h6-0-5" class="i">+import coil.decode.DecodeResult
</a><a href="#h6-0-6" id="h6-0-6" class="i">+import coil.decode.Decoder
</a><a href="#h6-0-7" id="h6-0-7" class="i">+import coil.fetch.SourceResult
</a><a href="#h6-0-8" id="h6-0-8" class="i">+import me.rhunk.snapenhance.common.data.FileType
</a><a href="#h6-0-9" id="h6-0-9" class="i">+import me.rhunk.snapenhance.common.data.download.MediaEncryptionKeyPair
</a><a href="#h6-0-10" id="h6-0-10" class="i">+import me.rhunk.snapenhance.common.data.download.SplitMediaAssetType
</a><a href="#h6-0-11" id="h6-0-11" class="i">+import me.rhunk.snapenhance.common.logger.AbstractLogger
</a><a href="#h6-0-12" id="h6-0-12" class="i">+import me.rhunk.snapenhance.common.util.snap.MediaDownloaderHelper
</a><a href="#h6-0-13" id="h6-0-13" class="i">+import me.rhunk.snapenhance.core.util.media.PreviewUtils
</a><a href="#h6-0-14" id="h6-0-14" class="i">+
</a><a href="#h6-0-15" id="h6-0-15" class="i">+class CoilPreviewDecoder(
</a><a href="#h6-0-16" id="h6-0-16" class="i">+    private val resources: Resources,
</a><a href="#h6-0-17" id="h6-0-17" class="i">+    private val sourceResult: SourceResult,
</a><a href="#h6-0-18" id="h6-0-18" class="i">+    private val encryptionKeyPair: MediaEncryptionKeyPair? = null,
</a><a href="#h6-0-19" id="h6-0-19" class="i">+    private val mergeOverlay: Boolean = false
</a><a href="#h6-0-20" id="h6-0-20" class="i">+): Decoder {
</a><a href="#h6-0-21" id="h6-0-21" class="i">+    override suspend fun decode(): DecodeResult {
</a><a href="#h6-0-22" id="h6-0-22" class="i">+        return sourceResult.source.file().toFile().inputStream().use { fileInputStream -&gt;
</a><a href="#h6-0-23" id="h6-0-23" class="i">+            val cipherInputStream = encryptionKeyPair?.decryptInputStream(fileInputStream) ?: fileInputStream
</a><a href="#h6-0-24" id="h6-0-24" class="i">+
</a><a href="#h6-0-25" id="h6-0-25" class="i">+            var bitmap: Bitmap? = null
</a><a href="#h6-0-26" id="h6-0-26" class="i">+            var overlayBitmap: Bitmap? = null
</a><a href="#h6-0-27" id="h6-0-27" class="i">+
</a><a href="#h6-0-28" id="h6-0-28" class="i">+            MediaDownloaderHelper.getSplitElements(cipherInputStream) { type, inputStream -&gt;
</a><a href="#h6-0-29" id="h6-0-29" class="i">+                if (inputStream.available() &gt; 50 * 1024 * 1024) {
</a><a href="#h6-0-30" id="h6-0-30" class="i">+                    return@getSplitElements
</a><a href="#h6-0-31" id="h6-0-31" class="i">+                }
</a><a href="#h6-0-32" id="h6-0-32" class="i">+                if (type == SplitMediaAssetType.ORIGINAL || (mergeOverlay &amp;&amp; type == SplitMediaAssetType.OVERLAY)) {
</a><a href="#h6-0-33" id="h6-0-33" class="i">+                    runCatching {
</a><a href="#h6-0-34" id="h6-0-34" class="i">+                        val bytes = inputStream.readBytes()
</a><a href="#h6-0-35" id="h6-0-35" class="i">+                        PreviewUtils.createPreview(bytes, isVideo = FileType.fromByteArray(bytes).isVideo)?.let {
</a><a href="#h6-0-36" id="h6-0-36" class="i">+                            if (type == SplitMediaAssetType.ORIGINAL) {
</a><a href="#h6-0-37" id="h6-0-37" class="i">+                                bitmap = it
</a><a href="#h6-0-38" id="h6-0-38" class="i">+                            } else {
</a><a href="#h6-0-39" id="h6-0-39" class="i">+                                overlayBitmap = it
</a><a href="#h6-0-40" id="h6-0-40" class="i">+                            }
</a><a href="#h6-0-41" id="h6-0-41" class="i">+                        }
</a><a href="#h6-0-42" id="h6-0-42" class="i">+                    }.onFailure {
</a><a href="#h6-0-43" id="h6-0-43" class="i">+                        AbstractLogger.directError(&quot;CoilPreviewDecoder&quot;, it)
</a><a href="#h6-0-44" id="h6-0-44" class="i">+                    }
</a><a href="#h6-0-45" id="h6-0-45" class="i">+                }
</a><a href="#h6-0-46" id="h6-0-46" class="i">+            }
</a><a href="#h6-0-47" id="h6-0-47" class="i">+
</a><a href="#h6-0-48" id="h6-0-48" class="i">+            if (mergeOverlay &amp;&amp; overlayBitmap != null) {
</a><a href="#h6-0-49" id="h6-0-49" class="i">+                bitmap = PreviewUtils.mergeBitmapOverlay(bitmap!!, overlayBitmap!!)
</a><a href="#h6-0-50" id="h6-0-50" class="i">+            }
</a><a href="#h6-0-51" id="h6-0-51" class="i">+
</a><a href="#h6-0-52" id="h6-0-52" class="i">+            cipherInputStream.close()
</a><a href="#h6-0-53" id="h6-0-53" class="i">+
</a><a href="#h6-0-54" id="h6-0-54" class="i">+            DecodeResult(
</a><a href="#h6-0-55" id="h6-0-55" class="i">+                drawable = BitmapDrawable(resources, bitmap!!),
</a><a href="#h6-0-56" id="h6-0-56" class="i">+                isSampled = true
</a><a href="#h6-0-57" id="h6-0-57" class="i">+            )
</a><a href="#h6-0-58" id="h6-0-58" class="i">+        }
</a><a href="#h6-0-59" id="h6-0-59" class="i">+    }
</a><a href="#h6-0-60" id="h6-0-60" class="i">+}</a><a href="#h6-0-61" id="h6-0-61" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h7" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/util/coil/ComposeImageHelper.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/util/coil/ComposeImageHelper.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/util/coil/ComposeImageHelper.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/util/coil/ComposeImageHelper.kt</a></b>
<a href="#h7-0" id="h7-0" class="h">@@ -0,0 +1,71 @@
</a><a href="#h7-0-0" id="h7-0-0" class="i">+package me.rhunk.snapenhance.ui.util.coil
</a><a href="#h7-0-1" id="h7-0-1" class="i">+
</a><a href="#h7-0-2" id="h7-0-2" class="i">+import android.content.Context
</a><a href="#h7-0-3" id="h7-0-3" class="i">+import android.graphics.drawable.ColorDrawable
</a><a href="#h7-0-4" id="h7-0-4" class="i">+import androidx.compose.foundation.Image
</a><a href="#h7-0-5" id="h7-0-5" class="i">+import androidx.compose.foundation.layout.height
</a><a href="#h7-0-6" id="h7-0-6" class="i">+import androidx.compose.foundation.layout.requiredWidthIn
</a><a href="#h7-0-7" id="h7-0-7" class="i">+import androidx.compose.material3.MaterialTheme
</a><a href="#h7-0-8" id="h7-0-8" class="i">+import androidx.compose.runtime.Composable
</a><a href="#h7-0-9" id="h7-0-9" class="i">+import androidx.compose.ui.Modifier
</a><a href="#h7-0-10" id="h7-0-10" class="i">+import androidx.compose.ui.draw.clip
</a><a href="#h7-0-11" id="h7-0-11" class="i">+import androidx.compose.ui.layout.ContentScale
</a><a href="#h7-0-12" id="h7-0-12" class="i">+import androidx.compose.ui.unit.dp
</a><a href="#h7-0-13" id="h7-0-13" class="i">+import coil.compose.rememberAsyncImagePainter
</a><a href="#h7-0-14" id="h7-0-14" class="i">+import coil.request.ImageRequest
</a><a href="#h7-0-15" id="h7-0-15" class="i">+import coil.size.Precision
</a><a href="#h7-0-16" id="h7-0-16" class="i">+import me.rhunk.snapenhance.R
</a><a href="#h7-0-17" id="h7-0-17" class="i">+import me.rhunk.snapenhance.RemoteSideContext
</a><a href="#h7-0-18" id="h7-0-18" class="i">+import me.rhunk.snapenhance.common.data.download.MediaEncryptionKeyPair
</a><a href="#h7-0-19" id="h7-0-19" class="i">+
</a><a href="#h7-0-20" id="h7-0-20" class="i">+@Composable
</a><a href="#h7-0-21" id="h7-0-21" class="i">+fun BitmojiImage(context: RemoteSideContext, modifier: Modifier = Modifier, size: Int = 48, url: String?) {
</a><a href="#h7-0-22" id="h7-0-22" class="i">+    Image(
</a><a href="#h7-0-23" id="h7-0-23" class="i">+        painter = rememberAsyncImagePainter(
</a><a href="#h7-0-24" id="h7-0-24" class="i">+            model = ImageRequestHelper.newBitmojiImageRequest(
</a><a href="#h7-0-25" id="h7-0-25" class="i">+                context.androidContext,
</a><a href="#h7-0-26" id="h7-0-26" class="i">+                url
</a><a href="#h7-0-27" id="h7-0-27" class="i">+            ),
</a><a href="#h7-0-28" id="h7-0-28" class="i">+            imageLoader = context.imageLoader
</a><a href="#h7-0-29" id="h7-0-29" class="i">+        ),
</a><a href="#h7-0-30" id="h7-0-30" class="i">+        contentDescription = null,
</a><a href="#h7-0-31" id="h7-0-31" class="i">+        contentScale = ContentScale.Crop,
</a><a href="#h7-0-32" id="h7-0-32" class="i">+        modifier = Modifier
</a><a href="#h7-0-33" id="h7-0-33" class="i">+            .requiredWidthIn(min = 0.dp, max = size.dp)
</a><a href="#h7-0-34" id="h7-0-34" class="i">+            .height(size.dp)
</a><a href="#h7-0-35" id="h7-0-35" class="i">+            .clip(MaterialTheme.shapes.medium)
</a><a href="#h7-0-36" id="h7-0-36" class="i">+            .then(modifier)
</a><a href="#h7-0-37" id="h7-0-37" class="i">+    )
</a><a href="#h7-0-38" id="h7-0-38" class="i">+}
</a><a href="#h7-0-39" id="h7-0-39" class="i">+
</a><a href="#h7-0-40" id="h7-0-40" class="i">+fun ImageRequest.Builder.cacheKey(key: String?) = apply {
</a><a href="#h7-0-41" id="h7-0-41" class="i">+    memoryCacheKey(key)
</a><a href="#h7-0-42" id="h7-0-42" class="i">+    diskCacheKey(key)
</a><a href="#h7-0-43" id="h7-0-43" class="i">+}
</a><a href="#h7-0-44" id="h7-0-44" class="i">+
</a><a href="#h7-0-45" id="h7-0-45" class="i">+object ImageRequestHelper {
</a><a href="#h7-0-46" id="h7-0-46" class="i">+    fun newBitmojiImageRequest(context: Context, url: String?) = ImageRequest.Builder(context)
</a><a href="#h7-0-47" id="h7-0-47" class="i">+        .data(url)
</a><a href="#h7-0-48" id="h7-0-48" class="i">+        .fallback(R.drawable.bitmoji_blank)
</a><a href="#h7-0-49" id="h7-0-49" class="i">+        .precision(Precision.INEXACT)
</a><a href="#h7-0-50" id="h7-0-50" class="i">+        .crossfade(true)
</a><a href="#h7-0-51" id="h7-0-51" class="i">+        .cacheKey(url)
</a><a href="#h7-0-52" id="h7-0-52" class="i">+        .build()
</a><a href="#h7-0-53" id="h7-0-53" class="i">+
</a><a href="#h7-0-54" id="h7-0-54" class="i">+    fun newPreviewImageRequest(context: Context, url: String, mediaEncryptionKeyPair: MediaEncryptionKeyPair? = null) = ImageRequest.Builder(context)
</a><a href="#h7-0-55" id="h7-0-55" class="i">+        .cacheKey(url)
</a><a href="#h7-0-56" id="h7-0-56" class="i">+        .precision(Precision.INEXACT)
</a><a href="#h7-0-57" id="h7-0-57" class="i">+        .crossfade(true)
</a><a href="#h7-0-58" id="h7-0-58" class="i">+        .placeholder(ColorDrawable(0x1EFFFFFF))
</a><a href="#h7-0-59" id="h7-0-59" class="i">+        .crossfade(200)
</a><a href="#h7-0-60" id="h7-0-60" class="i">+        .data(url)
</a><a href="#h7-0-61" id="h7-0-61" class="i">+        .decoderFactory { result, _, _ -&gt;
</a><a href="#h7-0-62" id="h7-0-62" class="i">+            CoilPreviewDecoder(
</a><a href="#h7-0-63" id="h7-0-63" class="i">+                context.resources,
</a><a href="#h7-0-64" id="h7-0-64" class="i">+                result,
</a><a href="#h7-0-65" id="h7-0-65" class="i">+                mediaEncryptionKeyPair,
</a><a href="#h7-0-66" id="h7-0-66" class="i">+                mergeOverlay = true
</a><a href="#h7-0-67" id="h7-0-67" class="i">+            )
</a><a href="#h7-0-68" id="h7-0-68" class="i">+        }
</a><a href="#h7-0-69" id="h7-0-69" class="i">+        .build()
</a><a href="#h7-0-70" id="h7-0-70" class="i">+}</a><a href="#h7-0-71" id="h7-0-71" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h8" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/data/MessagingCoreObjects.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/data/MessagingCoreObjects.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/data/MessagingCoreObjects.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/data/MessagingCoreObjects.kt</a></b>
<a href="#h8-0" id="h8-0" class="h">@@ -4,6 +4,7 @@ import android.database.Cursor
</a> import android.os.Parcelable
 import kotlinx.parcelize.Parcelize
 import me.rhunk.snapenhance.common.config.FeatureNotice
<a href="#h8-0-3" id="h8-0-3" class="i">+import me.rhunk.snapenhance.common.data.download.toKeyPair
</a> import me.rhunk.snapenhance.common.util.ktx.getIntOrNull
 import me.rhunk.snapenhance.common.util.ktx.getInteger
 import me.rhunk.snapenhance.common.util.ktx.getLongOrNull
<a href="#h8-1" id="h8-1" class="h">@@ -125,4 +126,6 @@ class StoryData(
</a>     val createdAt: Long,
     val key: ByteArray?,
     val iv: ByteArray?
<a href="#h8-1-3" id="h8-1-3" class="d">-)</a><a href="#h8-1-4" id="h8-1-4" class="d">-
\ No newline at end of file
</a><a href="#h8-1-5" id="h8-1-5" class="i">+) {
</a><a href="#h8-1-6" id="h8-1-6" class="i">+    fun getEncryptionKeyPair() = key?.let { (it to (iv ?: return@let null)) }?.toKeyPair()
</a><a href="#h8-1-7" id="h8-1-7" class="i">+}</a><a href="#h8-1-8" id="h8-1-8" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h9" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/data/download/MediaEncryptionKeyPair.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/data/download/MediaEncryptionKeyPair.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/data/download/MediaEncryptionKeyPair.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/data/download/MediaEncryptionKeyPair.kt</a></b>
<a href="#h9-0" id="h9-0" class="h">@@ -1,4 +1,3 @@
</a><a href="#h9-0-0" id="h9-0-0" class="d">-@file:OptIn(ExperimentalEncodingApi::class)
</a> 
 package me.rhunk.snapenhance.common.data.download
 
<a href="#h9-1" id="h9-1" class="h">@@ -15,6 +14,7 @@ data class MediaEncryptionKeyPair(
</a>     val key: String,
     val iv: String
 ) {
<a href="#h9-1-3" id="h9-1-3" class="i">+    @OptIn(ExperimentalEncodingApi::class)
</a>     fun decryptInputStream(inputStream: InputStream): InputStream {
         val cipher = Cipher.getInstance(&quot;AES/CBC/PKCS5Padding&quot;)
         cipher.init(Cipher.DECRYPT_MODE, SecretKeySpec(Base64.UrlSafe.decode(key), &quot;AES&quot;), IvParameterSpec(Base64.UrlSafe.decode(iv)))
<a href="#h9-2" id="h9-2" class="h">@@ -22,5 +22,6 @@ data class MediaEncryptionKeyPair(
</a>     }
 }
 
<a href="#h9-2-3" id="h9-2-3" class="i">+@OptIn(ExperimentalEncodingApi::class)
</a> fun Pair&lt;ByteArray, ByteArray&gt;.toKeyPair()
     = MediaEncryptionKeyPair(Base64.UrlSafe.encode(this.first), Base64.UrlSafe.encode(this.second))
</pre>
</div>
</body>
</html>
