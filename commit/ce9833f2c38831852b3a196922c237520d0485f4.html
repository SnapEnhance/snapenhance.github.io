<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>refactor: bridge and mapper (#130) - SnapEnhance - An Xposed module offering an enhanced Snapchat experience
</title>
<link rel="icon" type="image/svg+xml" href="../../logo.png"/>
<link rel="alternate icon" href="../../favicon.png"/>
<link rel="alternate" type="application/atom+xml" title="SnapEnhance Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="SnapEnhance Atom Feed (tags)" href="../tags.xml" />
<link rel="stylesheet" type="text/css" href="../../style.css" />
<link rel="stylesheet" type="text/css" href="../../fonts.css" />
</head>
<body>
<div id="head"><table><tr><td><a class="logo" href="../../"><img src="../../logo.png" alt="" width="32" height="32" /></a></td><td><strong>SnapEnhance</strong><span class="desc"> - An Xposed module offering an enhanced Snapchat experience
</span>
</td></tr></table>
<p><a href="../about.html">About</a> | <a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/LICENSE.html">License</a></p>
</div>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/ce9833f2c38831852b3a196922c237520d0485f4.html">ce9833f2c38831852b3a196922c237520d0485f4</a>
<b>parent</b> <a href="../commit/151c804629a9dca3de9ba155e9e6dd376f256a00.html">151c804629a9dca3de9ba155e9e6dd376f256a00</a>
<b>Author:</b> rhunk &lt;<a href="mailto:101876869+rhunk@users.noreply.github.com">101876869+rhunk@users.noreply.github.com</a>&gt;
<b>Date:</b>   Thu, 27 Jul 2023 15:32:50 +0200

refactor: bridge and mapper (#130)

* feat: fingerprint spoof

* fetch upstream - fix errors

* fix(ci): wrong env

* fix all items being shown and translations

* use filter instead of check

* fix(snap_enums/ContentType): status plus gift

* refactor: download bridge

* fix: check if bridge svc is correctly installed

* refactor bridge
- async handlers
- optimized reply callback calls
- add timeout debug when sending a bridge msg

* fix: check for bridge correctly initialized instead of connected

* fix: android compat + suppress warnings

* fix(feature/manager): set a fixed thread pool

* feat: dex mapper

* build: libs catalog

* fix: infinite loading

* refactor: config ui items

* feat: disable google play services dialogs

* fix(mapper): getClassName

* fix(bridge/force_start): use broadcast receiver instead of activity

* fix: notification filter

* refactor: aidl

* fix(bridge): bindServiceAsUser handler

* refactor: download manager

* fix(download/callback): add outputPath

* fix(mapper): lspatch support

* fix(notifications): blacklist &amp; reply
- config value container translation key

* feat: download from notifications

* fix(notification/reply): use FLAG_ONLY_ALERT_ONCE

* fix: alert dialog builder theme

* hooker method inline

* fix: immersive camera preview

* fix: chat action menu design

* fix(download/processor): fallback toasts

* fix(message_logger): limit thread pool to 10

* feat(download): logging

* fix: screenshot detection in snaps

* feat: hide friend suggestions

* refactor: download content URIs

* feat: preview group chats

* fix(config): ask for save folder

* fix(download_manager): async item preview

* fix(media_downloader): story replies

* fix(notifications): concurrent exception

* build: kotlin dsl

* fix(ci): upload only on main

* fix(build): getVersion task

* fix(build): abi filters

* fix(build): default product flavor

* test(mapper): mapping tests

* fix(mappings): group chat preview

* fix(mapper): dexlib interfaces instead of impl

---------

Co-authored-by: auth &lt;64337177+authorisation@users.noreply.github.com&gt;
<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">.github/workflows/android.yml</a></td><td> | </td><td class="num">2</td><td><span class="i">++</span><span class="d"></span></td></tr>
<tr><td class="D">D</td><td><a href="#h1">app/build.gradle</a></td><td> | </td><td class="num">110</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="A">A</td><td><a href="#h2">app/build.gradle.kts</a></td><td> | </td><td class="num">120</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="D">D</td><td><a href="#h3">app/proguard-rules.pro</a></td><td> | </td><td class="num">22</td><td><span class="i"></span><span class="d">----------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h4">app/src/main/AndroidManifest.xml</a></td><td> | </td><td class="num">18</td><td><span class="i">++++++++++</span><span class="d">--------</span></td></tr>
<tr><td class="A">A</td><td><a href="#h5">app/src/main/aidl/me/rhunk/snapenhance/bridge/BridgeInterface.aidl</a></td><td> | </td><td class="num">109</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h6">app/src/main/aidl/me/rhunk/snapenhance/bridge/DownloadCallback.aidl</a></td><td> | </td><td class="num">7</td><td><span class="i">+++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h7">app/src/main/assets/lang/en_US.json</a></td><td> | </td><td class="num">65</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h8">app/src/main/kotlin/me/rhunk/snapenhance/ModContext.kt</a></td><td> | </td><td class="num">8</td><td><span class="i">++++</span><span class="d">----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h9">app/src/main/kotlin/me/rhunk/snapenhance/SharedContext.kt</a></td><td> | </td><td class="num">34</td><td><span class="i">++++++++++++++++++++++</span><span class="d">------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h10">app/src/main/kotlin/me/rhunk/snapenhance/SnapEnhance.kt</a></td><td> | </td><td class="num">37</td><td><span class="i">++++++++++++++++++++</span><span class="d">-----------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h11">app/src/main/kotlin/me/rhunk/snapenhance/action/impl/ExportChatMessages.kt</a></td><td> | </td><td class="num">9</td><td><span class="i">+++++</span><span class="d">----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h12">app/src/main/kotlin/me/rhunk/snapenhance/action/impl/RefreshMappings.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="D">D</td><td><a href="#h13">app/src/main/kotlin/me/rhunk/snapenhance/bridge/AbstractBridgeClient.kt</a></td><td> | </td><td class="num">123</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="A">A</td><td><a href="#h14">app/src/main/kotlin/me/rhunk/snapenhance/bridge/BridgeClient.kt</a></td><td> | </td><td class="num">126</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h15">app/src/main/kotlin/me/rhunk/snapenhance/bridge/BridgeService.kt</a></td><td> | </td><td class="num">105</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="D">D</td><td><a href="#h16">app/src/main/kotlin/me/rhunk/snapenhance/bridge/ConfigWrapper.kt</a></td><td> | </td><td class="num">80</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="A">A</td><td><a href="#h17">app/src/main/kotlin/me/rhunk/snapenhance/bridge/ForceStartActivity.kt</a></td><td> | </td><td class="num">12</td><td><span class="i">++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="D">D</td><td><a href="#h18">app/src/main/kotlin/me/rhunk/snapenhance/bridge/MessageLoggerWrapper.kt</a></td><td> | </td><td class="num">71</td><td><span class="i"></span><span class="d">-----------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h19">app/src/main/kotlin/me/rhunk/snapenhance/bridge/TranslationWrapper.kt</a></td><td> | </td><td class="num">97</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h20">app/src/main/kotlin/me/rhunk/snapenhance/bridge/client/RootBridgeClient.kt</a></td><td> | </td><td class="num">156</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h21">app/src/main/kotlin/me/rhunk/snapenhance/bridge/client/ServiceBridgeClient.kt</a></td><td> | </td><td class="num">270</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h22">app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/BridgeMessage.kt</a></td><td> | </td><td class="num">16</td><td><span class="i"></span><span class="d">----------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h23">app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/BridgeMessageType.kt</a></td><td> | </td><td class="num">23</td><td><span class="i"></span><span class="d">-----------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h24">app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/impl/download/DownloadContentRequest.kt</a></td><td> | </td><td class="num">20</td><td><span class="i"></span><span class="d">--------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h25">app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/impl/download/DownloadContentResult.kt</a></td><td> | </td><td class="num">17</td><td><span class="i"></span><span class="d">-----------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h26">app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/impl/file/BridgeFileType.kt</a></td><td> | </td><td class="num">29</td><td><span class="i"></span><span class="d">-----------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h27">app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/impl/file/FileAccessRequest.kt</a></td><td> | </td><td class="num">33</td><td><span class="i"></span><span class="d">---------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h28">app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/impl/file/FileAccessResult.kt</a></td><td> | </td><td class="num">20</td><td><span class="i"></span><span class="d">--------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h29">app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/impl/locale/LocaleRequest.kt</a></td><td> | </td><td class="num">13</td><td><span class="i"></span><span class="d">-------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h30">app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/impl/locale/LocaleResult.kt</a></td><td> | </td><td class="num">32</td><td><span class="i"></span><span class="d">--------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h31">app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/impl/messagelogger/MessageLoggerListResult.kt</a></td><td> | </td><td class="num">19</td><td><span class="i"></span><span class="d">-------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h32">app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/impl/messagelogger/MessageLoggerRequest.kt</a></td><td> | </td><td class="num">35</td><td><span class="i"></span><span class="d">-----------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h33">app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/impl/messagelogger/MessageLoggerResult.kt</a></td><td> | </td><td class="num">21</td><td><span class="i"></span><span class="d">---------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h34">app/src/main/kotlin/me/rhunk/snapenhance/bridge/service/BridgeService.kt</a></td><td> | </td><td class="num">189</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="A">A</td><td><a href="#h35">app/src/main/kotlin/me/rhunk/snapenhance/bridge/types/BridgeFileType.kt</a></td><td> | </td><td class="num">29</td><td><span class="i">+++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h36">app/src/main/kotlin/me/rhunk/snapenhance/bridge/wrapper/ConfigWrapper.kt</a></td><td> | </td><td class="num">81</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h37">app/src/main/kotlin/me/rhunk/snapenhance/bridge/wrapper/MessageLoggerWrapper.kt</a></td><td> | </td><td class="num">71</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h38">app/src/main/kotlin/me/rhunk/snapenhance/bridge/wrapper/TranslationWrapper.kt</a></td><td> | </td><td class="num">98</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h39">app/src/main/kotlin/me/rhunk/snapenhance/config/ConfigCategory.kt</a></td><td> | </td><td class="num">6</td><td><span class="i">++++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h40">app/src/main/kotlin/me/rhunk/snapenhance/config/ConfigProperty.kt</a></td><td> | </td><td class="num">81</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">-------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h41">app/src/main/kotlin/me/rhunk/snapenhance/config/impl/ConfigStringValue.kt</a></td><td> | </td><td class="num">1</td><td><span class="i">+</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h42">app/src/main/kotlin/me/rhunk/snapenhance/data/FileType.kt</a></td><td> | </td><td class="num">7</td><td><span class="i">+++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h43">app/src/main/kotlin/me/rhunk/snapenhance/data/SnapEnums.kt</a></td><td> | </td><td class="num">65</td><td><span class="i">+++++++++++++++++++++++++++++++++</span><span class="d">--------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h44">app/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/MessageDestinations.kt</a></td><td> | </td><td class="num">1</td><td><span class="i">+</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h45">app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadManagerClient.kt</a></td><td> | </td><td class="num">92</td><td><span class="i">+++++++++++++++++++++++++++++++</span><span class="d">------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h46">app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadManagerReceiver.kt</a></td><td> | </td><td class="num">365</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="A">A</td><td><a href="#h47">app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadProcessor.kt</a></td><td> | </td><td class="num">388</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h48">app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadTaskManager.kt</a></td><td> | </td><td class="num">57</td><td><span class="i">++++++++++++++++++++++++++++++</span><span class="d">---------------------------</span></td></tr>
<tr><td class="A">A</td><td><a href="#h49">app/src/main/kotlin/me/rhunk/snapenhance/download/data/DownloadMetadata.kt</a></td><td> | </td><td class="num">10</td><td><span class="i">++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h50">app/src/main/kotlin/me/rhunk/snapenhance/download/data/DownloadRequest.kt</a></td><td> | </td><td class="num">86</td><td><span class="i">++++</span><span class="d">---------------------------------------------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h51">app/src/main/kotlin/me/rhunk/snapenhance/download/data/PendingDownload.kt</a></td><td> | </td><td class="num">21</td><td><span class="i">++</span><span class="d">-------------------</span></td></tr>
<tr><td class="A">A</td><td><a href="#h52">app/src/main/kotlin/me/rhunk/snapenhance/download/data/SplitMediaAssetType.kt</a></td><td> | </td><td class="num">5</td><td><span class="i">+++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h53">app/src/main/kotlin/me/rhunk/snapenhance/features/BridgeFileFeature.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h54">app/src/main/kotlin/me/rhunk/snapenhance/features/Feature.kt</a></td><td> | </td><td class="num">4</td><td><span class="i">++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h55">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/AutoUpdater.kt</a></td><td> | </td><td class="num">3</td><td><span class="i">++</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h56">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/Messaging.kt</a></td><td> | </td><td class="num">14</td><td><span class="i">+++++++++++++</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h57">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/AntiAutoDownload.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h58">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/MediaDownloader.kt</a></td><td> | </td><td class="num">184</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">----------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h59">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/experiments/AppPasscode.kt</a></td><td> | </td><td class="num">3</td><td><span class="i">++</span><span class="d">-</span></td></tr>
<tr><td class="A">A</td><td><a href="#h60">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/experiments/DeviceSpooferHook.kt</a></td><td> | </td><td class="num">48</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h61">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/experiments/MeoPasscodeBypass.kt</a></td><td> | </td><td class="num">6</td><td><span class="i">++++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h62">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/privacy/PreventMessageSending.kt</a></td><td> | </td><td class="num">45</td><td><span class="i">++++++++++++++++++++++++</span><span class="d">---------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h63">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/spying/MessageLogger.kt</a></td><td> | </td><td class="num">18</td><td><span class="i">++++++++++++</span><span class="d">------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h64">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/spying/StealthMode.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h65">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/AntiAutoSave.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h66">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/GalleryMediaSendOverride.kt</a></td><td> | </td><td class="num">3</td><td><span class="i">++</span><span class="d">-</span></td></tr>
<tr><td class="A">A</td><td><a href="#h67">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/GooglePlayServicesDialogs.kt</a></td><td> | </td><td class="num">25</td><td><span class="i">+++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h68">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/MediaQualityLevelOverride.kt</a></td><td> | </td><td class="num">9</td><td><span class="i">+++++</span><span class="d">----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h69">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/Notifications.kt</a></td><td> | </td><td class="num">312</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">----------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h70">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/PinConversations.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h71">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/UITweaks.kt</a></td><td> | </td><td class="num">35</td><td><span class="i">+++++++++++++++++++++++++++++++</span><span class="d">----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h72">app/src/main/kotlin/me/rhunk/snapenhance/hook/Hooker.kt</a></td><td> | </td><td class="num">86</td><td><span class="i">++++++++++++++++++++++++++++++++++++++</span><span class="d">-----------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h73">app/src/main/kotlin/me/rhunk/snapenhance/manager/impl/ConfigManager.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h74">app/src/main/kotlin/me/rhunk/snapenhance/manager/impl/FeatureManager.kt</a></td><td> | </td><td class="num">22</td><td><span class="i">+++++++++++++</span><span class="d">---------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h75">app/src/main/kotlin/me/rhunk/snapenhance/manager/impl/MappingManager.kt</a></td><td> | </td><td class="num">138</td><td><span class="i">++++++++++++++++++++++++++++</span><span class="d">---------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h76">app/src/main/kotlin/me/rhunk/snapenhance/mapping/Mapper.kt</a></td><td> | </td><td class="num">13</td><td><span class="i"></span><span class="d">-------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h77">app/src/main/kotlin/me/rhunk/snapenhance/mapping/impl/BCryptClassMapper.kt</a></td><td> | </td><td class="num">27</td><td><span class="i"></span><span class="d">---------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h78">app/src/main/kotlin/me/rhunk/snapenhance/mapping/impl/CallbackMapper.kt</a></td><td> | </td><td class="num">29</td><td><span class="i"></span><span class="d">-----------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h79">app/src/main/kotlin/me/rhunk/snapenhance/mapping/impl/DefaultMediaItemMapper.kt</a></td><td> | </td><td class="num">25</td><td><span class="i"></span><span class="d">-------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h80">app/src/main/kotlin/me/rhunk/snapenhance/mapping/impl/EnumMapper.kt</a></td><td> | </td><td class="num">67</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h81">app/src/main/kotlin/me/rhunk/snapenhance/mapping/impl/OperaPageViewControllerMapper.kt</a></td><td> | </td><td class="num">78</td><td><span class="i"></span><span class="d">------------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h82">app/src/main/kotlin/me/rhunk/snapenhance/mapping/impl/PlatformAnalyticsCreatorMapper.kt</a></td><td> | </td><td class="num">27</td><td><span class="i"></span><span class="d">---------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h83">app/src/main/kotlin/me/rhunk/snapenhance/mapping/impl/PlusSubscriptionMapper.kt</a></td><td> | </td><td class="num">28</td><td><span class="i"></span><span class="d">----------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h84">app/src/main/kotlin/me/rhunk/snapenhance/mapping/impl/ScCameraSettingsMapper.kt</a></td><td> | </td><td class="num">22</td><td><span class="i"></span><span class="d">----------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h85">app/src/main/kotlin/me/rhunk/snapenhance/mapping/impl/StoryBoostStateMapper.kt</a></td><td> | </td><td class="num">22</td><td><span class="i"></span><span class="d">----------------------</span></td></tr>
<tr><td class="A">A</td><td><a href="#h86">app/src/main/kotlin/me/rhunk/snapenhance/ui/ItemHelper.kt</a></td><td> | </td><td class="num">85</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h87">app/src/main/kotlin/me/rhunk/snapenhance/ui/ViewAppearanceHelper.kt</a></td><td> | </td><td class="num">97</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h88">app/src/main/kotlin/me/rhunk/snapenhance/ui/config/ConfigActivity.kt</a></td><td> | </td><td class="num">124</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++</span><span class="d">----------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h89">app/src/main/kotlin/me/rhunk/snapenhance/ui/download/DebugSettingsLayoutInflater.kt</a></td><td> | </td><td class="num">6</td><td><span class="i">+++++</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h90">app/src/main/kotlin/me/rhunk/snapenhance/ui/download/DownloadListAdapter.kt</a></td><td> | </td><td class="num">129</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">---------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h91">app/src/main/kotlin/me/rhunk/snapenhance/ui/download/DownloadManagerActivity.kt</a></td><td> | </td><td class="num">4</td><td><span class="i">++</span><span class="d">--</span></td></tr>
<tr><td class="D">D</td><td><a href="#h92">app/src/main/kotlin/me/rhunk/snapenhance/ui/menu/ViewAppearanceHelper.kt</a></td><td> | </td><td class="num">93</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h93">app/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/ChatActionMenu.kt</a></td><td> | </td><td class="num">61</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">-----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h94">app/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/FriendFeedInfoMenu.kt</a></td><td> | </td><td class="num">23</td><td><span class="i">++++++++++++++++</span><span class="d">-------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h95">app/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/MenuViewInjector.kt</a></td><td> | </td><td class="num">22</td><td><span class="i">++++++++++</span><span class="d">------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h96">app/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/OperaContextActionMenu.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h97">app/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/SettingsMenu.kt</a></td><td> | </td><td class="num">14</td><td><span class="i">+++++++</span><span class="d">-------</span></td></tr>
<tr><td class="A">A</td><td><a href="#h98">app/src/main/kotlin/me/rhunk/snapenhance/ui/spoof/DeviceSpooferActivity.kt</a></td><td> | </td><td class="num">112</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h99">app/src/main/kotlin/me/rhunk/snapenhance/util/ActivityResultCallback.kt</a></td><td> | </td><td class="num">6</td><td><span class="i">++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h100">app/src/main/kotlin/me/rhunk/snapenhance/util/AndroidCompatExtensions.kt</a></td><td> | </td><td class="num">13</td><td><span class="i">+++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h101">app/src/main/kotlin/me/rhunk/snapenhance/util/export/MessageExporter.kt</a></td><td> | </td><td class="num">3</td><td><span class="i">++</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h102">app/src/main/kotlin/me/rhunk/snapenhance/util/snap/MediaDownloaderHelper.kt</a></td><td> | </td><td class="num">10</td><td><span class="i">++++</span><span class="d">------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h103">app/src/main/kotlin/me/rhunk/snapenhance/util/snap/PreviewUtils.kt</a></td><td> | </td><td class="num">1</td><td><span class="i"></span><span class="d">-</span></td></tr>
<tr><td class="A">A</td><td><a href="#h104">app/src/main/res/layout/device_spoofer_activity.xml</a></td><td> | </td><td class="num">28</td><td><span class="i">++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="D">D</td><td><a href="#h105">build.gradle</a></td><td> | </td><td class="num">11</td><td><span class="i"></span><span class="d">-----------</span></td></tr>
<tr><td class="A">A</td><td><a href="#h106">build.gradle.kts</a></td><td> | </td><td class="num">9</td><td><span class="i">+++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h107">gradle/libs.versions.toml</a></td><td> | </td><td class="num">36</td><td><span class="i">++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h108">gradle/wrapper/gradle-wrapper.properties</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="A">A</td><td><a href="#h109">mapper/.gitignore</a></td><td> | </td><td class="num">2</td><td><span class="i">++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h110">mapper/build.gradle.kts</a></td><td> | </td><td class="num">22</td><td><span class="i">++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h111">mapper/src/main/kotlin/me/rhunk/snapmapper/AbstractClassMapper.kt</a></td><td> | </td><td class="num">10</td><td><span class="i">++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h112">mapper/src/main/kotlin/me/rhunk/snapmapper/Mapper.kt</a></td><td> | </td><td class="num">91</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h113">mapper/src/main/kotlin/me/rhunk/snapmapper/MapperContext.kt</a></td><td> | </td><td class="num">59</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h114">mapper/src/main/kotlin/me/rhunk/snapmapper/ext/DexClassDef.kt</a></td><td> | </td><td class="num">23</td><td><span class="i">+++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h115">mapper/src/main/kotlin/me/rhunk/snapmapper/ext/DexMethod.kt</a></td><td> | </td><td class="num">44</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h116">mapper/src/main/kotlin/me/rhunk/snapmapper/impl/BCryptClassMapper.kt</a></td><td> | </td><td class="num">35</td><td><span class="i">+++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h117">mapper/src/main/kotlin/me/rhunk/snapmapper/impl/CallbackMapper.kt</a></td><td> | </td><td class="num">28</td><td><span class="i">++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h118">mapper/src/main/kotlin/me/rhunk/snapmapper/impl/DefaultMediaItemMapper.kt</a></td><td> | </td><td class="num">22</td><td><span class="i">++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h119">mapper/src/main/kotlin/me/rhunk/snapmapper/impl/EnumMapper.kt</a></td><td> | </td><td class="num">73</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h120">mapper/src/main/kotlin/me/rhunk/snapmapper/impl/FriendsFeedEventDispatcherMapper.kt</a></td><td> | </td><td class="num">28</td><td><span class="i">++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h121">mapper/src/main/kotlin/me/rhunk/snapmapper/impl/MediaQualityLevelProviderMapper.kt</a></td><td> | </td><td class="num">25</td><td><span class="i">+++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h122">mapper/src/main/kotlin/me/rhunk/snapmapper/impl/OperaPageViewControllerMapper.kt</a></td><td> | </td><td class="num">53</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h123">mapper/src/main/kotlin/me/rhunk/snapmapper/impl/PlatformAnalyticsCreatorMapper.kt</a></td><td> | </td><td class="num">24</td><td><span class="i">++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h124">mapper/src/main/kotlin/me/rhunk/snapmapper/impl/PlusSubscriptionMapper.kt</a></td><td> | </td><td class="num">29</td><td><span class="i">+++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h125">mapper/src/main/kotlin/me/rhunk/snapmapper/impl/ScCameraSettingsMapper.kt</a></td><td> | </td><td class="num">21</td><td><span class="i">+++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h126">mapper/src/main/kotlin/me/rhunk/snapmapper/impl/StoryBoostStateMapper.kt</a></td><td> | </td><td class="num">24</td><td><span class="i">++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h127">mapper/src/test/kotlin/android/util/Log.kt</a></td><td> | </td><td class="num">28</td><td><span class="i">++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h128">mapper/src/test/kotlin/me/rhunk/snapenhance/mapper/tests/TestMappings.kt</a></td><td> | </td><td class="num">33</td><td><span class="i">+++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="D">D</td><td><a href="#h129">settings.gradle</a></td><td> | </td><td class="num">16</td><td><span class="i"></span><span class="d">----------------</span></td></tr>
<tr><td class="A">A</td><td><a href="#h130">settings.gradle.kts</a></td><td> | </td><td class="num">21</td><td><span class="i">+++++++++++++++++++++</span><span class="d"></span></td></tr>
</table></pre><pre>131 files changed, 3371 insertions(+), 3050 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/.github/workflows/android.yml.html">.github/workflows/android.yml</a> b/<a href="../file/.github/workflows/android.yml.html">.github/workflows/android.yml</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -71,7 +71,9 @@ jobs:
</a>           path: app/build/outputs/apk/armv7/debug/*.apk
           
       - name: CI Upload armv8
<a href="#h0-0-3" id="h0-0-3" class="i">+        if: github.ref_name == &#39;main&#39;
</a>         run: node ./.github/workflows/upload.js -t &quot;${{ secrets.TELEGRAM_BOT_TOKEN }}&quot; -f &quot;app/build/outputs/apk/armv8/debug/app-${{ env.version }}-armv8-${{ steps.version-env.outputs.sha_short }}.apk&quot; --caption &quot;A new commit has been pushed to the ${{ env.GIT_BRANCH_NAME }} branch! ${{ steps.version-env.outputs.sha_short }}&quot; --chatid &quot;${{ secrets.TELEGRAM_CHAT_ID }}&quot; 
 
       - name: CI Upload armv7
<a href="#h0-0-7" id="h0-0-7" class="i">+        if: github.ref_name == &#39;main&#39;
</a>         run: node ./.github/workflows/upload.js -t &quot;${{ secrets.TELEGRAM_BOT_TOKEN }}&quot; -f &quot;app/build/outputs/apk/armv7/debug/app-${{ env.version }}-armv7-${{ steps.version-env.outputs.sha_short }}.apk&quot; --chatid &quot;${{ secrets.TELEGRAM_CHAT_ID }}&quot; 
<b>diff --git a/<a id="h1" href="../file/app/build.gradle.html">app/build.gradle</a> b/<a href="../file/app/build.gradle.html">app/build.gradle</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -1,110 +0,0 @@
</a><a href="#h1-0-0" id="h1-0-0" class="d">-plugins {
</a><a href="#h1-0-1" id="h1-0-1" class="d">-    id &#39;com.android.application&#39;
</a><a href="#h1-0-2" id="h1-0-2" class="d">-    id &#39;org.jetbrains.kotlin.android&#39;
</a><a href="#h1-0-3" id="h1-0-3" class="d">-}
</a><a href="#h1-0-4" id="h1-0-4" class="d">-
</a><a href="#h1-0-5" id="h1-0-5" class="d">-def appVersionName = &quot;1.1.0&quot;
</a><a href="#h1-0-6" id="h1-0-6" class="d">-def appVersionCode = 7
</a><a href="#h1-0-7" id="h1-0-7" class="d">-
</a><a href="#h1-0-8" id="h1-0-8" class="d">-android {
</a><a href="#h1-0-9" id="h1-0-9" class="d">-    compileSdk 33
</a><a href="#h1-0-10" id="h1-0-10" class="d">-    buildToolsVersion = &quot;33.0.2&quot;
</a><a href="#h1-0-11" id="h1-0-11" class="d">-
</a><a href="#h1-0-12" id="h1-0-12" class="d">-    defaultConfig {
</a><a href="#h1-0-13" id="h1-0-13" class="d">-        applicationId &quot;me.rhunk.snapenhance&quot;
</a><a href="#h1-0-14" id="h1-0-14" class="d">-        minSdk 28
</a><a href="#h1-0-15" id="h1-0-15" class="d">-        targetSdk 33
</a><a href="#h1-0-16" id="h1-0-16" class="d">-        versionCode appVersionCode
</a><a href="#h1-0-17" id="h1-0-17" class="d">-        versionName appVersionName
</a><a href="#h1-0-18" id="h1-0-18" class="d">-        multiDexEnabled true
</a><a href="#h1-0-19" id="h1-0-19" class="d">-    }
</a><a href="#h1-0-20" id="h1-0-20" class="d">-
</a><a href="#h1-0-21" id="h1-0-21" class="d">-    buildTypes {
</a><a href="#h1-0-22" id="h1-0-22" class="d">-        release {
</a><a href="#h1-0-23" id="h1-0-23" class="d">-            minifyEnabled false
</a><a href="#h1-0-24" id="h1-0-24" class="d">-            shrinkResources false
</a><a href="#h1-0-25" id="h1-0-25" class="d">-            proguardFiles getDefaultProguardFile(&#39;proguard-android-optimize.txt&#39;), &#39;proguard-rules.pro&#39;
</a><a href="#h1-0-26" id="h1-0-26" class="d">-        }
</a><a href="#h1-0-27" id="h1-0-27" class="d">-    }
</a><a href="#h1-0-28" id="h1-0-28" class="d">-    compileOptions {
</a><a href="#h1-0-29" id="h1-0-29" class="d">-        sourceCompatibility JavaVersion.VERSION_1_8
</a><a href="#h1-0-30" id="h1-0-30" class="d">-        targetCompatibility JavaVersion.VERSION_1_8
</a><a href="#h1-0-31" id="h1-0-31" class="d">-    }
</a><a href="#h1-0-32" id="h1-0-32" class="d">-
</a><a href="#h1-0-33" id="h1-0-33" class="d">-    applicationVariants.configureEach { variant -&gt;
</a><a href="#h1-0-34" id="h1-0-34" class="d">-        variant.outputs.configureEach {
</a><a href="#h1-0-35" id="h1-0-35" class="d">-            outputFileName = &quot;app-${appVersionName}-${variant.flavorName}.apk&quot;
</a><a href="#h1-0-36" id="h1-0-36" class="d">-        }
</a><a href="#h1-0-37" id="h1-0-37" class="d">-    }
</a><a href="#h1-0-38" id="h1-0-38" class="d">-
</a><a href="#h1-0-39" id="h1-0-39" class="d">-    flavorDimensions &quot;release&quot;
</a><a href="#h1-0-40" id="h1-0-40" class="d">-
</a><a href="#h1-0-41" id="h1-0-41" class="d">-    productFlavors {
</a><a href="#h1-0-42" id="h1-0-42" class="d">-        armv8 {
</a><a href="#h1-0-43" id="h1-0-43" class="d">-            getIsDefault().set(true)
</a><a href="#h1-0-44" id="h1-0-44" class="d">-            ndk {
</a><a href="#h1-0-45" id="h1-0-45" class="d">-                //noinspection ChromeOsAbiSupport
</a><a href="#h1-0-46" id="h1-0-46" class="d">-                abiFilters &quot;arm64-v8a&quot;
</a><a href="#h1-0-47" id="h1-0-47" class="d">-            }
</a><a href="#h1-0-48" id="h1-0-48" class="d">-            dimension &quot;release&quot;
</a><a href="#h1-0-49" id="h1-0-49" class="d">-        }
</a><a href="#h1-0-50" id="h1-0-50" class="d">-        armv7 {
</a><a href="#h1-0-51" id="h1-0-51" class="d">-            ndk {
</a><a href="#h1-0-52" id="h1-0-52" class="d">-                //noinspection ChromeOsAbiSupport
</a><a href="#h1-0-53" id="h1-0-53" class="d">-                abiFilters &quot;armeabi-v7a&quot;
</a><a href="#h1-0-54" id="h1-0-54" class="d">-            }
</a><a href="#h1-0-55" id="h1-0-55" class="d">-            packagingOptions {
</a><a href="#h1-0-56" id="h1-0-56" class="d">-                exclude &#39;lib/armeabi-v7a/*_neon.so&#39;
</a><a href="#h1-0-57" id="h1-0-57" class="d">-            }
</a><a href="#h1-0-58" id="h1-0-58" class="d">-            dimension &quot;release&quot;
</a><a href="#h1-0-59" id="h1-0-59" class="d">-        }
</a><a href="#h1-0-60" id="h1-0-60" class="d">-    }
</a><a href="#h1-0-61" id="h1-0-61" class="d">-
</a><a href="#h1-0-62" id="h1-0-62" class="d">-    kotlinOptions {
</a><a href="#h1-0-63" id="h1-0-63" class="d">-        jvmTarget = &#39;1.8&#39;
</a><a href="#h1-0-64" id="h1-0-64" class="d">-    }
</a><a href="#h1-0-65" id="h1-0-65" class="d">-    namespace &#39;me.rhunk.snapenhance&#39;
</a><a href="#h1-0-66" id="h1-0-66" class="d">-}
</a><a href="#h1-0-67" id="h1-0-67" class="d">-
</a><a href="#h1-0-68" id="h1-0-68" class="d">-afterEvaluate {
</a><a href="#h1-0-69" id="h1-0-69" class="d">-    //auto install for debug purpose
</a><a href="#h1-0-70" id="h1-0-70" class="d">-    getTasks().getByPath(&quot;:app:assembleArmv8Debug&quot;).doLast {
</a><a href="#h1-0-71" id="h1-0-71" class="d">-        def apkDebugFile = android.applicationVariants.find { it.buildType.name == &quot;debug&quot; &amp;&amp; it.flavorName == &quot;armv8&quot; }.outputs[0].outputFile
</a><a href="#h1-0-72" id="h1-0-72" class="d">-        try {
</a><a href="#h1-0-73" id="h1-0-73" class="d">-            println &quot;Killing Snapchat&quot;
</a><a href="#h1-0-74" id="h1-0-74" class="d">-            exec {
</a><a href="#h1-0-75" id="h1-0-75" class="d">-                commandLine &quot;adb&quot;, &quot;shell&quot;, &quot;am&quot;, &quot;force-stop&quot;, &quot;com.snapchat.android&quot;
</a><a href="#h1-0-76" id="h1-0-76" class="d">-            }
</a><a href="#h1-0-77" id="h1-0-77" class="d">-            println &quot;Installing debug build&quot;
</a><a href="#h1-0-78" id="h1-0-78" class="d">-            exec() {
</a><a href="#h1-0-79" id="h1-0-79" class="d">-                commandLine &quot;adb&quot;, &quot;install&quot;, &quot;-r&quot;, &quot;-d&quot;, apkDebugFile.absolutePath
</a><a href="#h1-0-80" id="h1-0-80" class="d">-            }
</a><a href="#h1-0-81" id="h1-0-81" class="d">-            println &quot;Starting Snapchat&quot;
</a><a href="#h1-0-82" id="h1-0-82" class="d">-            exec {
</a><a href="#h1-0-83" id="h1-0-83" class="d">-                commandLine &quot;adb&quot;, &quot;shell&quot;, &quot;am&quot;, &quot;start&quot;, &quot;com.snapchat.android&quot;
</a><a href="#h1-0-84" id="h1-0-84" class="d">-            }
</a><a href="#h1-0-85" id="h1-0-85" class="d">-        } catch (Throwable t) {
</a><a href="#h1-0-86" id="h1-0-86" class="d">-            println &quot;Failed to install debug build&quot;
</a><a href="#h1-0-87" id="h1-0-87" class="d">-            t.printStackTrace()
</a><a href="#h1-0-88" id="h1-0-88" class="d">-        }
</a><a href="#h1-0-89" id="h1-0-89" class="d">-    }
</a><a href="#h1-0-90" id="h1-0-90" class="d">-}
</a><a href="#h1-0-91" id="h1-0-91" class="d">-
</a><a href="#h1-0-92" id="h1-0-92" class="d">-task getVersion {
</a><a href="#h1-0-93" id="h1-0-93" class="d">-    doLast {
</a><a href="#h1-0-94" id="h1-0-94" class="d">-        def version = new File(&#39;app/build/version.txt&#39;)
</a><a href="#h1-0-95" id="h1-0-95" class="d">-        version.text = android.defaultConfig.versionName
</a><a href="#h1-0-96" id="h1-0-96" class="d">-    }
</a><a href="#h1-0-97" id="h1-0-97" class="d">-}
</a><a href="#h1-0-98" id="h1-0-98" class="d">-
</a><a href="#h1-0-99" id="h1-0-99" class="d">-dependencies {
</a><a href="#h1-0-100" id="h1-0-100" class="d">-    implementation &#39;org.jetbrains.kotlinx:kotlinx-coroutines-android:1.7.1&#39;
</a><a href="#h1-0-101" id="h1-0-101" class="d">-    implementation &#39;org.jetbrains.kotlin:kotlin-reflect:1.8.21&#39;
</a><a href="#h1-0-102" id="h1-0-102" class="d">-    implementation &#39;androidx.recyclerview:recyclerview:1.3.0&#39;
</a><a href="#h1-0-103" id="h1-0-103" class="d">-
</a><a href="#h1-0-104" id="h1-0-104" class="d">-    compileOnly files(&#39;libs/LSPosed-api-1.0-SNAPSHOT.jar&#39;)
</a><a href="#h1-0-105" id="h1-0-105" class="d">-    implementation &#39;com.google.code.gson:gson:2.10.1&#39;
</a><a href="#h1-0-106" id="h1-0-106" class="d">-    implementation &#39;com.arthenica:ffmpeg-kit-full-gpl:5.1.LTS&#39;
</a><a href="#h1-0-107" id="h1-0-107" class="d">-    implementation &#39;org.osmdroid:osmdroid-android:6.1.16&#39;
</a><a href="#h1-0-108" id="h1-0-108" class="d">-    implementation &#39;com.squareup.okhttp3:okhttp:5.0.0-alpha.11&#39;
</a><a href="#h1-0-109" id="h1-0-109" class="d">-}
</a><b>diff --git a/<a id="h2" href="../file/app/build.gradle.kts.html">app/build.gradle.kts</a> b/<a href="../file/app/build.gradle.kts.html">app/build.gradle.kts</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -0,0 +1,119 @@
</a><a href="#h2-0-0" id="h2-0-0" class="i">+import com.android.build.gradle.internal.api.BaseVariantOutputImpl
</a><a href="#h2-0-1" id="h2-0-1" class="i">+
</a><a href="#h2-0-2" id="h2-0-2" class="i">+@Suppress(&quot;DSL_SCOPE_VIOLATION&quot;) // TODO: Remove once KTIJ-19369 is fixed
</a><a href="#h2-0-3" id="h2-0-3" class="i">+plugins {
</a><a href="#h2-0-4" id="h2-0-4" class="i">+    alias(libs.plugins.androidApplication)
</a><a href="#h2-0-5" id="h2-0-5" class="i">+    alias(libs.plugins.kotlinAndroid)
</a><a href="#h2-0-6" id="h2-0-6" class="i">+}
</a><a href="#h2-0-7" id="h2-0-7" class="i">+
</a><a href="#h2-0-8" id="h2-0-8" class="i">+val appVersionName = &quot;1.1.0&quot;
</a><a href="#h2-0-9" id="h2-0-9" class="i">+val appVersionCode = 7
</a><a href="#h2-0-10" id="h2-0-10" class="i">+
</a><a href="#h2-0-11" id="h2-0-11" class="i">+android {
</a><a href="#h2-0-12" id="h2-0-12" class="i">+    namespace = &quot;me.rhunk.snapenhance&quot;
</a><a href="#h2-0-13" id="h2-0-13" class="i">+    compileSdk = 33
</a><a href="#h2-0-14" id="h2-0-14" class="i">+
</a><a href="#h2-0-15" id="h2-0-15" class="i">+    buildFeatures {
</a><a href="#h2-0-16" id="h2-0-16" class="i">+        aidl = true
</a><a href="#h2-0-17" id="h2-0-17" class="i">+    }
</a><a href="#h2-0-18" id="h2-0-18" class="i">+
</a><a href="#h2-0-19" id="h2-0-19" class="i">+    defaultConfig {
</a><a href="#h2-0-20" id="h2-0-20" class="i">+        applicationId = &quot;me.rhunk.snapenhance&quot;
</a><a href="#h2-0-21" id="h2-0-21" class="i">+        minSdk = 28
</a><a href="#h2-0-22" id="h2-0-22" class="i">+        //noinspection OldTargetApi
</a><a href="#h2-0-23" id="h2-0-23" class="i">+        targetSdk = 33
</a><a href="#h2-0-24" id="h2-0-24" class="i">+
</a><a href="#h2-0-25" id="h2-0-25" class="i">+        versionCode = appVersionCode
</a><a href="#h2-0-26" id="h2-0-26" class="i">+        versionName = appVersionName
</a><a href="#h2-0-27" id="h2-0-27" class="i">+        multiDexEnabled = true
</a><a href="#h2-0-28" id="h2-0-28" class="i">+    }
</a><a href="#h2-0-29" id="h2-0-29" class="i">+
</a><a href="#h2-0-30" id="h2-0-30" class="i">+
</a><a href="#h2-0-31" id="h2-0-31" class="i">+    buildTypes {
</a><a href="#h2-0-32" id="h2-0-32" class="i">+        release {
</a><a href="#h2-0-33" id="h2-0-33" class="i">+            isMinifyEnabled = false
</a><a href="#h2-0-34" id="h2-0-34" class="i">+            isShrinkResources = false
</a><a href="#h2-0-35" id="h2-0-35" class="i">+        }
</a><a href="#h2-0-36" id="h2-0-36" class="i">+    }
</a><a href="#h2-0-37" id="h2-0-37" class="i">+
</a><a href="#h2-0-38" id="h2-0-38" class="i">+    flavorDimensions += &quot;abi&quot;
</a><a href="#h2-0-39" id="h2-0-39" class="i">+
</a><a href="#h2-0-40" id="h2-0-40" class="i">+    productFlavors {
</a><a href="#h2-0-41" id="h2-0-41" class="i">+        create(&quot;armv8&quot;) {
</a><a href="#h2-0-42" id="h2-0-42" class="i">+            ndk {
</a><a href="#h2-0-43" id="h2-0-43" class="i">+                abiFilters.add(&quot;arm64-v8a&quot;)
</a><a href="#h2-0-44" id="h2-0-44" class="i">+            }
</a><a href="#h2-0-45" id="h2-0-45" class="i">+
</a><a href="#h2-0-46" id="h2-0-46" class="i">+            dimension = &quot;abi&quot;
</a><a href="#h2-0-47" id="h2-0-47" class="i">+        }
</a><a href="#h2-0-48" id="h2-0-48" class="i">+
</a><a href="#h2-0-49" id="h2-0-49" class="i">+        create(&quot;armv7&quot;) {
</a><a href="#h2-0-50" id="h2-0-50" class="i">+            ndk {
</a><a href="#h2-0-51" id="h2-0-51" class="i">+                abiFilters.add(&quot;armeabi-v7a&quot;)
</a><a href="#h2-0-52" id="h2-0-52" class="i">+            }
</a><a href="#h2-0-53" id="h2-0-53" class="i">+            packaging {
</a><a href="#h2-0-54" id="h2-0-54" class="i">+                jniLibs {
</a><a href="#h2-0-55" id="h2-0-55" class="i">+                    excludes += &quot;**/*_neon.so&quot;
</a><a href="#h2-0-56" id="h2-0-56" class="i">+                }
</a><a href="#h2-0-57" id="h2-0-57" class="i">+            }
</a><a href="#h2-0-58" id="h2-0-58" class="i">+            dimension = &quot;abi&quot;
</a><a href="#h2-0-59" id="h2-0-59" class="i">+        }
</a><a href="#h2-0-60" id="h2-0-60" class="i">+    }
</a><a href="#h2-0-61" id="h2-0-61" class="i">+
</a><a href="#h2-0-62" id="h2-0-62" class="i">+    properties[&quot;debug_flavor&quot;]?.let {
</a><a href="#h2-0-63" id="h2-0-63" class="i">+        android.productFlavors[it.toString()].setIsDefault(true)
</a><a href="#h2-0-64" id="h2-0-64" class="i">+    }
</a><a href="#h2-0-65" id="h2-0-65" class="i">+
</a><a href="#h2-0-66" id="h2-0-66" class="i">+    applicationVariants.all {
</a><a href="#h2-0-67" id="h2-0-67" class="i">+        outputs.map { it as BaseVariantOutputImpl }.forEach { variant -&gt;
</a><a href="#h2-0-68" id="h2-0-68" class="i">+            variant.outputFileName = &quot;app-${appVersionName}-${variant.name}.apk&quot;
</a><a href="#h2-0-69" id="h2-0-69" class="i">+        }
</a><a href="#h2-0-70" id="h2-0-70" class="i">+    }
</a><a href="#h2-0-71" id="h2-0-71" class="i">+
</a><a href="#h2-0-72" id="h2-0-72" class="i">+    compileOptions {
</a><a href="#h2-0-73" id="h2-0-73" class="i">+        sourceCompatibility = JavaVersion.VERSION_1_8
</a><a href="#h2-0-74" id="h2-0-74" class="i">+        targetCompatibility = JavaVersion.VERSION_1_8
</a><a href="#h2-0-75" id="h2-0-75" class="i">+    }
</a><a href="#h2-0-76" id="h2-0-76" class="i">+
</a><a href="#h2-0-77" id="h2-0-77" class="i">+    kotlinOptions {
</a><a href="#h2-0-78" id="h2-0-78" class="i">+        jvmTarget = &quot;1.8&quot;
</a><a href="#h2-0-79" id="h2-0-79" class="i">+    }
</a><a href="#h2-0-80" id="h2-0-80" class="i">+}
</a><a href="#h2-0-81" id="h2-0-81" class="i">+
</a><a href="#h2-0-82" id="h2-0-82" class="i">+dependencies {
</a><a href="#h2-0-83" id="h2-0-83" class="i">+    compileOnly(files(&quot;libs/LSPosed-api-1.0-SNAPSHOT.jar&quot;))
</a><a href="#h2-0-84" id="h2-0-84" class="i">+    implementation(libs.coroutines)
</a><a href="#h2-0-85" id="h2-0-85" class="i">+    implementation(libs.kotlin.reflect)
</a><a href="#h2-0-86" id="h2-0-86" class="i">+    implementation(libs.recyclerview)
</a><a href="#h2-0-87" id="h2-0-87" class="i">+    implementation(libs.gson)
</a><a href="#h2-0-88" id="h2-0-88" class="i">+    implementation(libs.ffmpeg.kit)
</a><a href="#h2-0-89" id="h2-0-89" class="i">+    implementation(libs.osmdroid.android)
</a><a href="#h2-0-90" id="h2-0-90" class="i">+    implementation(libs.okhttp)
</a><a href="#h2-0-91" id="h2-0-91" class="i">+    implementation(libs.androidx.documentfile)
</a><a href="#h2-0-92" id="h2-0-92" class="i">+
</a><a href="#h2-0-93" id="h2-0-93" class="i">+    implementation(project(&quot;:mapper&quot;))
</a><a href="#h2-0-94" id="h2-0-94" class="i">+}
</a><a href="#h2-0-95" id="h2-0-95" class="i">+
</a><a href="#h2-0-96" id="h2-0-96" class="i">+tasks.register(&quot;getVersion&quot;) {
</a><a href="#h2-0-97" id="h2-0-97" class="i">+    doLast {
</a><a href="#h2-0-98" id="h2-0-98" class="i">+        val versionFile = File(&quot;app/build/version.txt&quot;)
</a><a href="#h2-0-99" id="h2-0-99" class="i">+        versionFile.writeText(android.defaultConfig.versionName.toString())
</a><a href="#h2-0-100" id="h2-0-100" class="i">+    }
</a><a href="#h2-0-101" id="h2-0-101" class="i">+}
</a><a href="#h2-0-102" id="h2-0-102" class="i">+
</a><a href="#h2-0-103" id="h2-0-103" class="i">+afterEvaluate {
</a><a href="#h2-0-104" id="h2-0-104" class="i">+    properties[&quot;debug_assemble_task&quot;]?.let { tasks.named(it.toString()) }?.orNull?.doLast {
</a><a href="#h2-0-105" id="h2-0-105" class="i">+        runCatching {
</a><a href="#h2-0-106" id="h2-0-106" class="i">+            val apkDebugFile = android.applicationVariants.find { it.buildType.name == &quot;debug&quot; &amp;&amp; it.flavorName == properties[&quot;debug_flavor&quot;] }?.outputs?.first()?.outputFile ?: return@doLast
</a><a href="#h2-0-107" id="h2-0-107" class="i">+            exec {
</a><a href="#h2-0-108" id="h2-0-108" class="i">+                commandLine(&quot;adb&quot;, &quot;shell&quot;, &quot;am&quot;, &quot;force-stop&quot;, &quot;com.snapchat.android&quot;)
</a><a href="#h2-0-109" id="h2-0-109" class="i">+            }
</a><a href="#h2-0-110" id="h2-0-110" class="i">+            exec {
</a><a href="#h2-0-111" id="h2-0-111" class="i">+                commandLine(&quot;adb&quot;, &quot;install&quot;, &quot;-r&quot;, &quot;-d&quot;, apkDebugFile.absolutePath)
</a><a href="#h2-0-112" id="h2-0-112" class="i">+            }
</a><a href="#h2-0-113" id="h2-0-113" class="i">+            exec {
</a><a href="#h2-0-114" id="h2-0-114" class="i">+                commandLine(&quot;adb&quot;, &quot;shell&quot;, &quot;am&quot;, &quot;start&quot;, &quot;com.snapchat.android&quot;)
</a><a href="#h2-0-115" id="h2-0-115" class="i">+            }
</a><a href="#h2-0-116" id="h2-0-116" class="i">+        }
</a><a href="#h2-0-117" id="h2-0-117" class="i">+    }
</a><a href="#h2-0-118" id="h2-0-118" class="i">+}</a><a href="#h2-0-119" id="h2-0-119" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h3" href="../file/app/proguard-rules.pro.html">app/proguard-rules.pro</a> b/<a href="../file/app/proguard-rules.pro.html">app/proguard-rules.pro</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -1,21 +0,0 @@
</a><a href="#h3-0-0" id="h3-0-0" class="d">-# Add project specific ProGuard rules here.
</a><a href="#h3-0-1" id="h3-0-1" class="d">-# You can control the set of applied configuration files using the
</a><a href="#h3-0-2" id="h3-0-2" class="d">-# proguardFiles setting in build.gradle.
</a><a href="#h3-0-3" id="h3-0-3" class="d">-#
</a><a href="#h3-0-4" id="h3-0-4" class="d">-# For more details, see
</a><a href="#h3-0-5" id="h3-0-5" class="d">-#   http://developer.android.com/guide/developing/tools/proguard.html
</a><a href="#h3-0-6" id="h3-0-6" class="d">-
</a><a href="#h3-0-7" id="h3-0-7" class="d">-# If your project uses WebView with JS, uncomment the following
</a><a href="#h3-0-8" id="h3-0-8" class="d">-# and specify the fully qualified class name to the JavaScript interface
</a><a href="#h3-0-9" id="h3-0-9" class="d">-# class:
</a><a href="#h3-0-10" id="h3-0-10" class="d">-#-keepclassmembers class fqcn.of.javascript.interface.for.webview {
</a><a href="#h3-0-11" id="h3-0-11" class="d">-#   public *;
</a><a href="#h3-0-12" id="h3-0-12" class="d">-#}
</a><a href="#h3-0-13" id="h3-0-13" class="d">-
</a><a href="#h3-0-14" id="h3-0-14" class="d">-# Uncomment this to preserve the line number information for
</a><a href="#h3-0-15" id="h3-0-15" class="d">-# debugging stack traces.
</a><a href="#h3-0-16" id="h3-0-16" class="d">-#-keepattributes SourceFile,LineNumberTable
</a><a href="#h3-0-17" id="h3-0-17" class="d">-
</a><a href="#h3-0-18" id="h3-0-18" class="d">-# If you keep the line number information, uncomment this to
</a><a href="#h3-0-19" id="h3-0-19" class="d">-# hide the original source file name.
</a><a href="#h3-0-20" id="h3-0-20" class="d">-#-renamesourcefileattribute SourceFile</a><a href="#h3-0-21" id="h3-0-21" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h4" href="../file/app/src/main/AndroidManifest.xml.html">app/src/main/AndroidManifest.xml</a> b/<a href="../file/app/src/main/AndroidManifest.xml.html">app/src/main/AndroidManifest.xml</a></b>
<a href="#h4-0" id="h4-0" class="h">@@ -32,18 +32,11 @@
</a>             android:resource=&quot;@array/sc_scope&quot; /&gt;
 
         &lt;service
<a href="#h4-0-3" id="h4-0-3" class="d">-            android:name=&quot;.bridge.service.BridgeService&quot;
</a><a href="#h4-0-4" id="h4-0-4" class="i">+            android:name=&quot;.bridge.BridgeService&quot;
</a>             android:exported=&quot;true&quot;
             tools:ignore=&quot;ExportedService&quot;&gt;
         &lt;/service&gt;
 
<a href="#h4-0-9" id="h4-0-9" class="d">-        &lt;receiver android:name=&quot;.download.DownloadManagerReceiver&quot; android:exported=&quot;true&quot;
</a><a href="#h4-0-10" id="h4-0-10" class="d">-            tools:ignore=&quot;ExportedReceiver&quot;&gt;
</a><a href="#h4-0-11" id="h4-0-11" class="d">-            &lt;intent-filter&gt;
</a><a href="#h4-0-12" id="h4-0-12" class="d">-                &lt;action android:name=&quot;me.rhunk.snapenhance.download.DownloadManagerReceiver.DOWNLOAD_ACTION&quot; /&gt;
</a><a href="#h4-0-13" id="h4-0-13" class="d">-            &lt;/intent-filter&gt;
</a><a href="#h4-0-14" id="h4-0-14" class="d">-        &lt;/receiver&gt;
</a><a href="#h4-0-15" id="h4-0-15" class="d">-
</a>         &lt;activity
             android:name=&quot;.ui.download.DownloadManagerActivity&quot;
             android:theme=&quot;@style/AppTheme&quot;
<a href="#h4-1" id="h4-1" class="h">@@ -62,6 +55,15 @@
</a>             android:theme=&quot;@style/AppTheme&quot;
             android:excludeFromRecents=&quot;true&quot;
             android:exported=&quot;true&quot; /&gt;
<a href="#h4-1-3" id="h4-1-3" class="i">+        &lt;activity
</a><a href="#h4-1-4" id="h4-1-4" class="i">+            android:name=&quot;.ui.spoof.DeviceSpooferActivity&quot;
</a><a href="#h4-1-5" id="h4-1-5" class="i">+            android:theme=&quot;@style/AppTheme&quot;
</a><a href="#h4-1-6" id="h4-1-6" class="i">+            android:excludeFromRecents=&quot;true&quot;
</a><a href="#h4-1-7" id="h4-1-7" class="i">+            android:exported=&quot;true&quot; /&gt;
</a><a href="#h4-1-8" id="h4-1-8" class="i">+        &lt;activity android:name=&quot;.bridge.ForceStartActivity&quot;
</a><a href="#h4-1-9" id="h4-1-9" class="i">+            android:theme=&quot;@android:style/Theme.NoDisplay&quot;
</a><a href="#h4-1-10" id="h4-1-10" class="i">+            android:excludeFromRecents=&quot;true&quot;
</a><a href="#h4-1-11" id="h4-1-11" class="i">+            android:exported=&quot;true&quot; /&gt;
</a>     &lt;/application&gt;
 
 &lt;/manifest&gt; 
\ No newline at end of file
<b>diff --git a/<a id="h5" href="../file/app/src/main/aidl/me/rhunk/snapenhance/bridge/BridgeInterface.aidl.html">app/src/main/aidl/me/rhunk/snapenhance/bridge/BridgeInterface.aidl</a> b/<a href="../file/app/src/main/aidl/me/rhunk/snapenhance/bridge/BridgeInterface.aidl.html">app/src/main/aidl/me/rhunk/snapenhance/bridge/BridgeInterface.aidl</a></b>
<a href="#h5-0" id="h5-0" class="h">@@ -0,0 +1,108 @@
</a><a href="#h5-0-0" id="h5-0-0" class="i">+package me.rhunk.snapenhance.bridge;
</a><a href="#h5-0-1" id="h5-0-1" class="i">+
</a><a href="#h5-0-2" id="h5-0-2" class="i">+import java.util.List;
</a><a href="#h5-0-3" id="h5-0-3" class="i">+import me.rhunk.snapenhance.bridge.DownloadCallback;
</a><a href="#h5-0-4" id="h5-0-4" class="i">+
</a><a href="#h5-0-5" id="h5-0-5" class="i">+interface BridgeInterface {
</a><a href="#h5-0-6" id="h5-0-6" class="i">+        /**
</a><a href="#h5-0-7" id="h5-0-7" class="i">+         * Create a file if it doesn&#39;t exist, and read it
</a><a href="#h5-0-8" id="h5-0-8" class="i">+         *
</a><a href="#h5-0-9" id="h5-0-9" class="i">+         * @param fileType       the type of file to create and read
</a><a href="#h5-0-10" id="h5-0-10" class="i">+         * @param defaultContent the default content to write to the file if it doesn&#39;t exist
</a><a href="#h5-0-11" id="h5-0-11" class="i">+         * @return the content of the file
</a><a href="#h5-0-12" id="h5-0-12" class="i">+         */
</a><a href="#h5-0-13" id="h5-0-13" class="i">+        byte[] createAndReadFile(int fileType, in byte[] defaultContent);
</a><a href="#h5-0-14" id="h5-0-14" class="i">+
</a><a href="#h5-0-15" id="h5-0-15" class="i">+        /**
</a><a href="#h5-0-16" id="h5-0-16" class="i">+         * Read a file
</a><a href="#h5-0-17" id="h5-0-17" class="i">+         *
</a><a href="#h5-0-18" id="h5-0-18" class="i">+         * @param fileType the type of file to read
</a><a href="#h5-0-19" id="h5-0-19" class="i">+         * @return the content of the file
</a><a href="#h5-0-20" id="h5-0-20" class="i">+         */
</a><a href="#h5-0-21" id="h5-0-21" class="i">+        byte[] readFile(int fileType);
</a><a href="#h5-0-22" id="h5-0-22" class="i">+
</a><a href="#h5-0-23" id="h5-0-23" class="i">+        /**
</a><a href="#h5-0-24" id="h5-0-24" class="i">+         * Write a file
</a><a href="#h5-0-25" id="h5-0-25" class="i">+         *
</a><a href="#h5-0-26" id="h5-0-26" class="i">+         * @param fileType the type of file to write
</a><a href="#h5-0-27" id="h5-0-27" class="i">+         * @param content  the content to write to the file
</a><a href="#h5-0-28" id="h5-0-28" class="i">+         * @return true if the file was written successfully
</a><a href="#h5-0-29" id="h5-0-29" class="i">+         */
</a><a href="#h5-0-30" id="h5-0-30" class="i">+        boolean writeFile(int fileType, in byte[] content);
</a><a href="#h5-0-31" id="h5-0-31" class="i">+
</a><a href="#h5-0-32" id="h5-0-32" class="i">+        /**
</a><a href="#h5-0-33" id="h5-0-33" class="i">+         * Delete a file
</a><a href="#h5-0-34" id="h5-0-34" class="i">+         *
</a><a href="#h5-0-35" id="h5-0-35" class="i">+         * @param fileType the type of file to delete
</a><a href="#h5-0-36" id="h5-0-36" class="i">+         * @return true if the file was deleted successfully
</a><a href="#h5-0-37" id="h5-0-37" class="i">+         */
</a><a href="#h5-0-38" id="h5-0-38" class="i">+        boolean deleteFile(int fileType);
</a><a href="#h5-0-39" id="h5-0-39" class="i">+
</a><a href="#h5-0-40" id="h5-0-40" class="i">+        /**
</a><a href="#h5-0-41" id="h5-0-41" class="i">+         * Check if a file exists
</a><a href="#h5-0-42" id="h5-0-42" class="i">+         *
</a><a href="#h5-0-43" id="h5-0-43" class="i">+         * @param fileType the type of file to check
</a><a href="#h5-0-44" id="h5-0-44" class="i">+         * @return true if the file exists
</a><a href="#h5-0-45" id="h5-0-45" class="i">+         */
</a><a href="#h5-0-46" id="h5-0-46" class="i">+        boolean isFileExists(int fileType);
</a><a href="#h5-0-47" id="h5-0-47" class="i">+
</a><a href="#h5-0-48" id="h5-0-48" class="i">+        /**
</a><a href="#h5-0-49" id="h5-0-49" class="i">+         * Get the content of a logged message from the database
</a><a href="#h5-0-50" id="h5-0-50" class="i">+         *
</a><a href="#h5-0-51" id="h5-0-51" class="i">+         * @param conversationId the ID of the conversation
</a><a href="#h5-0-52" id="h5-0-52" class="i">+         * @return the content of the message
</a><a href="#h5-0-53" id="h5-0-53" class="i">+         */
</a><a href="#h5-0-54" id="h5-0-54" class="i">+        long[] getLoggedMessageIds(String conversationId, int limit);
</a><a href="#h5-0-55" id="h5-0-55" class="i">+
</a><a href="#h5-0-56" id="h5-0-56" class="i">+        /**
</a><a href="#h5-0-57" id="h5-0-57" class="i">+         * Get the content of a logged message from the database
</a><a href="#h5-0-58" id="h5-0-58" class="i">+         *
</a><a href="#h5-0-59" id="h5-0-59" class="i">+         * @param id the ID of the message logger message
</a><a href="#h5-0-60" id="h5-0-60" class="i">+         * @return the content of the message
</a><a href="#h5-0-61" id="h5-0-61" class="i">+         */
</a><a href="#h5-0-62" id="h5-0-62" class="i">+        @nullable byte[] getMessageLoggerMessage(String conversationId, long id);
</a><a href="#h5-0-63" id="h5-0-63" class="i">+
</a><a href="#h5-0-64" id="h5-0-64" class="i">+        /**
</a><a href="#h5-0-65" id="h5-0-65" class="i">+         * Add a message to the message logger database
</a><a href="#h5-0-66" id="h5-0-66" class="i">+         *
</a><a href="#h5-0-67" id="h5-0-67" class="i">+         * @param id      the ID of the message logger message
</a><a href="#h5-0-68" id="h5-0-68" class="i">+         * @param message the content of the message
</a><a href="#h5-0-69" id="h5-0-69" class="i">+         */
</a><a href="#h5-0-70" id="h5-0-70" class="i">+        void addMessageLoggerMessage(String conversationId, long id, in byte[] message);
</a><a href="#h5-0-71" id="h5-0-71" class="i">+
</a><a href="#h5-0-72" id="h5-0-72" class="i">+        /**
</a><a href="#h5-0-73" id="h5-0-73" class="i">+         * Delete a message from the message logger database
</a><a href="#h5-0-74" id="h5-0-74" class="i">+         *
</a><a href="#h5-0-75" id="h5-0-75" class="i">+         * @param id the ID of the message logger message
</a><a href="#h5-0-76" id="h5-0-76" class="i">+         */
</a><a href="#h5-0-77" id="h5-0-77" class="i">+        void deleteMessageLoggerMessage(String conversationId, long id);
</a><a href="#h5-0-78" id="h5-0-78" class="i">+
</a><a href="#h5-0-79" id="h5-0-79" class="i">+        /**
</a><a href="#h5-0-80" id="h5-0-80" class="i">+         * Clear the message logger database
</a><a href="#h5-0-81" id="h5-0-81" class="i">+         */
</a><a href="#h5-0-82" id="h5-0-82" class="i">+        void clearMessageLogger();
</a><a href="#h5-0-83" id="h5-0-83" class="i">+
</a><a href="#h5-0-84" id="h5-0-84" class="i">+        /**
</a><a href="#h5-0-85" id="h5-0-85" class="i">+         * Fetch the translations
</a><a href="#h5-0-86" id="h5-0-86" class="i">+         *
</a><a href="#h5-0-87" id="h5-0-87" class="i">+         * @return the translations result
</a><a href="#h5-0-88" id="h5-0-88" class="i">+         */
</a><a href="#h5-0-89" id="h5-0-89" class="i">+        Map&lt;String, String&gt; fetchTranslations();
</a><a href="#h5-0-90" id="h5-0-90" class="i">+
</a><a href="#h5-0-91" id="h5-0-91" class="i">+        /**
</a><a href="#h5-0-92" id="h5-0-92" class="i">+         * Get check for updates last time
</a><a href="#h5-0-93" id="h5-0-93" class="i">+         * @return the last time check for updates was done
</a><a href="#h5-0-94" id="h5-0-94" class="i">+         */
</a><a href="#h5-0-95" id="h5-0-95" class="i">+        long getAutoUpdaterTime();
</a><a href="#h5-0-96" id="h5-0-96" class="i">+
</a><a href="#h5-0-97" id="h5-0-97" class="i">+        /**
</a><a href="#h5-0-98" id="h5-0-98" class="i">+         * Set check for updates last time
</a><a href="#h5-0-99" id="h5-0-99" class="i">+         * @param time the time to set
</a><a href="#h5-0-100" id="h5-0-100" class="i">+         */
</a><a href="#h5-0-101" id="h5-0-101" class="i">+        void setAutoUpdaterTime(long time);
</a><a href="#h5-0-102" id="h5-0-102" class="i">+
</a><a href="#h5-0-103" id="h5-0-103" class="i">+        /**
</a><a href="#h5-0-104" id="h5-0-104" class="i">+         * Enqueue a download
</a><a href="#h5-0-105" id="h5-0-105" class="i">+         */
</a><a href="#h5-0-106" id="h5-0-106" class="i">+        void enqueueDownload(in Intent intent, DownloadCallback callback);
</a><a href="#h5-0-107" id="h5-0-107" class="i">+}</a><a href="#h5-0-108" id="h5-0-108" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h6" href="../file/app/src/main/aidl/me/rhunk/snapenhance/bridge/DownloadCallback.aidl.html">app/src/main/aidl/me/rhunk/snapenhance/bridge/DownloadCallback.aidl</a> b/<a href="../file/app/src/main/aidl/me/rhunk/snapenhance/bridge/DownloadCallback.aidl.html">app/src/main/aidl/me/rhunk/snapenhance/bridge/DownloadCallback.aidl</a></b>
<a href="#h6-0" id="h6-0" class="h">@@ -0,0 +1,7 @@
</a><a href="#h6-0-0" id="h6-0-0" class="i">+package me.rhunk.snapenhance.bridge;
</a><a href="#h6-0-1" id="h6-0-1" class="i">+
</a><a href="#h6-0-2" id="h6-0-2" class="i">+oneway interface DownloadCallback {
</a><a href="#h6-0-3" id="h6-0-3" class="i">+    void onSuccess(String outputPath);
</a><a href="#h6-0-4" id="h6-0-4" class="i">+    void onProgress(String message);
</a><a href="#h6-0-5" id="h6-0-5" class="i">+    void onFailure(String message, @nullable String throwable);
</a><a href="#h6-0-6" id="h6-0-6" class="i">+}
</a><b>diff --git a/<a id="h7" href="../file/app/src/main/assets/lang/en_US.json.html">app/src/main/assets/lang/en_US.json</a> b/<a href="../file/app/src/main/assets/lang/en_US.json.html">app/src/main/assets/lang/en_US.json</a></b>
<a href="#h7-0" id="h7-0" class="h">@@ -50,13 +50,9 @@
</a>             &quot;name&quot;: &quot;Unlimited Snap View Time&quot;,
             &quot;description&quot;: &quot;Removes the time limit for viewing Snaps&quot;
         },
<a href="#h7-0-3" id="h7-0-3" class="d">-        &quot;prevent_screenshot_notifications&quot;: {
</a><a href="#h7-0-4" id="h7-0-4" class="d">-            &quot;name&quot;: &quot;Prevent Screenshot Notifications&quot;,
</a><a href="#h7-0-5" id="h7-0-5" class="d">-            &quot;description&quot;: &quot;Prevents anyone from knowing that you&#39;ve taken a screenshot&quot;
</a><a href="#h7-0-6" id="h7-0-6" class="d">-        },
</a><a href="#h7-0-7" id="h7-0-7" class="d">-        &quot;prevent_status_notifications&quot;: {
</a><a href="#h7-0-8" id="h7-0-8" class="d">-            &quot;name&quot;: &quot;Prevent Status Notifications&quot;,
</a><a href="#h7-0-9" id="h7-0-9" class="d">-            &quot;description&quot;: &quot;Prevents sending status notifications\ne.g. Saved to camera roll&quot;
</a><a href="#h7-0-10" id="h7-0-10" class="i">+        &quot;prevent_sending_messages&quot;: {
</a><a href="#h7-0-11" id="h7-0-11" class="i">+            &quot;name&quot;: &quot;Prevent Sending Messages&quot;,
</a><a href="#h7-0-12" id="h7-0-12" class="i">+            &quot;description&quot;: &quot;Prevents sending certain types of messages&quot;
</a>         },
         &quot;anonymous_story_view&quot;: {
             &quot;name&quot;: &quot;Anonymous Story View&quot;,
<a href="#h7-1" id="h7-1" class="h">@@ -95,6 +91,10 @@
</a>             &quot;name&quot;: &quot;Force Media Source Quality&quot;,
             &quot;description&quot;: &quot;Overrides the media source quality&quot;
         },
<a href="#h7-1-3" id="h7-1-3" class="i">+        &quot;download_logging&quot;: {
</a><a href="#h7-1-4" id="h7-1-4" class="i">+            &quot;name&quot;: &quot;Download Logging&quot;,
</a><a href="#h7-1-5" id="h7-1-5" class="i">+            &quot;description&quot;: &quot;Show a toast when media is downloading&quot;
</a><a href="#h7-1-6" id="h7-1-6" class="i">+        },
</a> 
         &quot;enable_friend_feed_menu_bar&quot;: {
             &quot;name&quot;: &quot;Friend Feed Menu Bar&quot;,
<a href="#h7-2" id="h7-2" class="h">@@ -164,6 +164,10 @@
</a>             &quot;name&quot;: &quot;Override Startup Page&quot;,
             &quot;description&quot;: &quot;Overrides the startup page&quot;
         },
<a href="#h7-2-3" id="h7-2-3" class="i">+        &quot;disable_google_play_dialogs&quot;: {
</a><a href="#h7-2-4" id="h7-2-4" class="i">+            &quot;name&quot;: &quot;Disable Google Play Services Dialogs&quot;,
</a><a href="#h7-2-5" id="h7-2-5" class="i">+            &quot;description&quot;: &quot;Prevent Google Play Services availability dialogs from being shown&quot;
</a><a href="#h7-2-6" id="h7-2-6" class="i">+        },
</a> 
         &quot;auto_updater&quot;: {
             &quot;name&quot;: &quot;Auto Updater&quot;,
<a href="#h7-3" id="h7-3" class="h">@@ -218,6 +222,18 @@
</a>         &quot;unlimited_multi_snap&quot;: {
             &quot;name&quot;: &quot;Unlimited Multi Snap&quot;,
             &quot;description&quot;: &quot;Allows you to take an unlimited amount of multi snaps&quot;
<a href="#h7-3-3" id="h7-3-3" class="i">+        },
</a><a href="#h7-3-4" id="h7-3-4" class="i">+        &quot;device_spoof&quot;: {
</a><a href="#h7-3-5" id="h7-3-5" class="i">+            &quot;name&quot;: &quot;Spoof Device Values&quot;,
</a><a href="#h7-3-6" id="h7-3-6" class="i">+            &quot;description&quot;: &quot;Spoofs the devices values&quot;
</a><a href="#h7-3-7" id="h7-3-7" class="i">+        },
</a><a href="#h7-3-8" id="h7-3-8" class="i">+        &quot;device_fingerprint&quot;: {
</a><a href="#h7-3-9" id="h7-3-9" class="i">+            &quot;name&quot;: &quot;Device Fingerprint&quot;,
</a><a href="#h7-3-10" id="h7-3-10" class="i">+            &quot;description&quot;: &quot;Spoofs the device fingerprint&quot;
</a><a href="#h7-3-11" id="h7-3-11" class="i">+        },
</a><a href="#h7-3-12" id="h7-3-12" class="i">+        &quot;android_id&quot;: {
</a><a href="#h7-3-13" id="h7-3-13" class="i">+            &quot;name&quot;: &quot;Android ID&quot;,
</a><a href="#h7-3-14" id="h7-3-14" class="i">+            &quot;description&quot;: &quot;Spoofs the devices Android ID&quot;
</a>         }
     },
 
<a href="#h7-4" id="h7-4" class="h">@@ -226,7 +242,8 @@
</a>             &quot;better_notifications&quot;: {
                 &quot;chat&quot;: &quot;Show chat messages&quot;,
                 &quot;snap&quot;: &quot;Show medias&quot;,
<a href="#h7-4-3" id="h7-4-3" class="d">-                &quot;reply_button&quot;: &quot;Add reply button&quot;
</a><a href="#h7-4-4" id="h7-4-4" class="i">+                &quot;reply_button&quot;: &quot;Add reply button&quot;,
</a><a href="#h7-4-5" id="h7-4-5" class="i">+                &quot;download_button&quot;: &quot;Add download button&quot;
</a>             },
             &quot;friend_feed_menu_buttons&quot;: {
                 &quot;auto_download_blacklist&quot;: &quot;\u2B07\uFE0F Auto Download Blacklist&quot;,
<a href="#h7-5" id="h7-5" class="h">@@ -249,6 +266,12 @@
</a>                 &quot;public_stories&quot;: &quot;Public Stories&quot;,
                 &quot;spotlight&quot;: &quot;Spotlight&quot;
             },
<a href="#h7-5-3" id="h7-5-3" class="i">+            &quot;download_logging&quot;: {
</a><a href="#h7-5-4" id="h7-5-4" class="i">+                &quot;started&quot;: &quot;Started&quot;,
</a><a href="#h7-5-5" id="h7-5-5" class="i">+                &quot;success&quot;: &quot;Success&quot;,
</a><a href="#h7-5-6" id="h7-5-6" class="i">+                &quot;progress&quot;: &quot;Progress&quot;,
</a><a href="#h7-5-7" id="h7-5-7" class="i">+                &quot;failure&quot;: &quot;Failure&quot;
</a><a href="#h7-5-8" id="h7-5-8" class="i">+            },
</a>             &quot;auto_save_messages&quot;: {
                 &quot;NOTE&quot;: &quot;Audio Note&quot;,
                 &quot;CHAT&quot;: &quot;Chat&quot;,
<a href="#h7-6" id="h7-6" class="h">@@ -256,10 +279,19 @@
</a>                 &quot;SNAP&quot;: &quot;Snap&quot;,
                 &quot;STICKER&quot;: &quot;Sticker&quot;
             },
<a href="#h7-6-3" id="h7-6-3" class="d">-            &quot;notification_blacklist&quot;: {
</a><a href="#h7-6-4" id="h7-6-4" class="i">+            &quot;notifications&quot;: {
</a><a href="#h7-6-5" id="h7-6-5" class="i">+                &quot;chat_screenshot&quot;: &quot;Screenshot&quot;,
</a><a href="#h7-6-6" id="h7-6-6" class="i">+                &quot;chat_screen_record&quot;: &quot;Screen Record&quot;,
</a><a href="#h7-6-7" id="h7-6-7" class="i">+                &quot;camera_roll_save&quot;: &quot;Camera Roll Save&quot;,
</a>                 &quot;chat&quot;: &quot;Chat&quot;,
<a href="#h7-6-9" id="h7-6-9" class="i">+                &quot;chat_reply&quot;: &quot;Chat Reply&quot;,
</a>                 &quot;snap&quot;: &quot;Snap&quot;,
<a href="#h7-6-11" id="h7-6-11" class="d">-                &quot;typing&quot;: &quot;Typing&quot;
</a><a href="#h7-6-12" id="h7-6-12" class="i">+                &quot;typing&quot;: &quot;Typing&quot;,
</a><a href="#h7-6-13" id="h7-6-13" class="i">+                &quot;stories&quot;: &quot;Stories&quot;,
</a><a href="#h7-6-14" id="h7-6-14" class="i">+                &quot;initiate_audio&quot;: &quot;Incoming Audio Call&quot;,
</a><a href="#h7-6-15" id="h7-6-15" class="i">+                &quot;abandon_audio&quot;: &quot;Missed Audio Call&quot;,
</a><a href="#h7-6-16" id="h7-6-16" class="i">+                &quot;initiate_video&quot;: &quot;Incoming Video Call&quot;,
</a><a href="#h7-6-17" id="h7-6-17" class="i">+                &quot;abandon_video&quot;: &quot;Missed Video Call&quot;
</a>             },
             &quot;gallery_media_send_override&quot;: {
                 &quot;OFF&quot;: &quot;Off&quot;,
<a href="#h7-7" id="h7-7" class="h">@@ -287,6 +319,7 @@
</a>                 &quot;VERTICAL_STORY_VIEWER&quot;: &quot;Enable Vertical Story Viewer&quot;
             },
             &quot;hide_story_section&quot;: {
<a href="#h7-7-3" id="h7-7-3" class="i">+                &quot;hide_friend_suggestions&quot;: &quot;Hide friend suggestions&quot;,
</a>                 &quot;hide_friends&quot;: &quot;Hide friends section&quot;,
                 &quot;hide_following&quot;: &quot;Hide following section&quot;,
                 &quot;hide_for_you&quot;: &quot;Hide For You section&quot;
<a href="#h7-8" id="h7-8" class="h">@@ -401,16 +434,21 @@
</a>             &quot;clear_cache_title&quot;: &quot;Clear Cache&quot;,
             &quot;reset_all_title&quot;: &quot;Reset all settings&quot;,
             &quot;reset_all_confirmation&quot;: &quot;Are you sure you want to reset all settings?&quot;,
<a href="#h7-8-3" id="h7-8-3" class="d">-            &quot;success_toast&quot;: &quot;Success!&quot;
</a><a href="#h7-8-4" id="h7-8-4" class="i">+            &quot;success_toast&quot;: &quot;Success!&quot;,
</a><a href="#h7-8-5" id="h7-8-5" class="i">+            &quot;device_spoofer&quot;: &quot;Device Spoofer&quot;
</a>         }
     },
<a href="#h7-8-8" id="h7-8-8" class="d">-    &quot;download_manager_receiver&quot;: {
</a><a href="#h7-8-9" id="h7-8-9" class="i">+    &quot;download_processor&quot;: {
</a><a href="#h7-8-10" id="h7-8-10" class="i">+        &quot;download_started_toast&quot;: &quot;Download started&quot;,
</a><a href="#h7-8-11" id="h7-8-11" class="i">+        &quot;unsupported_content_type_toast&quot;: &quot;Unsupported content type!&quot;,
</a><a href="#h7-8-12" id="h7-8-12" class="i">+        &quot;failed_no_longer_available_toast&quot;: &quot;Media no longer available&quot;,
</a>         &quot;already_queued_toast&quot;: &quot;Media already in queue!&quot;,
         &quot;already_downloaded_toast&quot;: &quot;Media already downloaded!&quot;,
         &quot;saved_toast&quot;: &quot;Saved to {path}&quot;,
         &quot;download_toast&quot;: &quot;Downloading {path}...&quot;,
         &quot;processing_toast&quot;: &quot;Processing {path}...&quot;,
         &quot;failed_generic_toast&quot;: &quot;Failed to download&quot;,
<a href="#h7-8-19" id="h7-8-19" class="i">+        &quot;failed_to_create_preview_toast&quot;: &quot;Failed to create preview&quot;,
</a>         &quot;failed_processing_toast&quot;: &quot;Failed to process {error}&quot;,
         &quot;failed_gallery_toast&quot;: &quot;Failed to save to gallery {error}&quot;
     },
<a href="#h7-9" id="h7-9" class="h">@@ -418,5 +456,8 @@
</a>         &quot;title&quot;: &quot;SnapEnhance Settings&quot;,
         &quot;selected_text&quot;: &quot;{count} selected&quot;,
         &quot;invalid_number_toast&quot;: &quot;Invalid number!&quot;
<a href="#h7-9-3" id="h7-9-3" class="i">+    },
</a><a href="#h7-9-4" id="h7-9-4" class="i">+    &quot;spoof_activity&quot;: {
</a><a href="#h7-9-5" id="h7-9-5" class="i">+        &quot;title&quot;: &quot;Spoof Settings&quot;
</a>     }
 } 
\ No newline at end of file
<b>diff --git a/<a id="h8" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ModContext.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ModContext.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ModContext.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ModContext.kt</a></b>
<a href="#h8-0" id="h8-0" class="h">@@ -11,9 +11,9 @@ import android.widget.Toast
</a> import com.google.gson.Gson
 import com.google.gson.GsonBuilder
 import kotlinx.coroutines.asCoroutineDispatcher
<a href="#h8-0-3" id="h8-0-3" class="d">-import me.rhunk.snapenhance.bridge.AbstractBridgeClient
</a><a href="#h8-0-4" id="h8-0-4" class="d">-import me.rhunk.snapenhance.bridge.ConfigWrapper
</a><a href="#h8-0-5" id="h8-0-5" class="d">-import me.rhunk.snapenhance.bridge.TranslationWrapper
</a><a href="#h8-0-6" id="h8-0-6" class="i">+import me.rhunk.snapenhance.bridge.BridgeClient
</a><a href="#h8-0-7" id="h8-0-7" class="i">+import me.rhunk.snapenhance.bridge.wrapper.ConfigWrapper
</a><a href="#h8-0-8" id="h8-0-8" class="i">+import me.rhunk.snapenhance.bridge.wrapper.TranslationWrapper
</a> import me.rhunk.snapenhance.data.MessageSender
 import me.rhunk.snapenhance.database.DatabaseAccess
 import me.rhunk.snapenhance.features.Feature
<a href="#h8-1" id="h8-1" class="h">@@ -35,7 +35,7 @@ class ModContext {
</a> 
     lateinit var androidContext: Context
     var mainActivity: Activity? = null
<a href="#h8-1-3" id="h8-1-3" class="d">-    lateinit var bridgeClient: AbstractBridgeClient
</a><a href="#h8-1-4" id="h8-1-4" class="i">+    lateinit var bridgeClient: BridgeClient
</a> 
     val gson: Gson = GsonBuilder().create()
 
<b>diff --git a/<a id="h9" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/SharedContext.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/SharedContext.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/SharedContext.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/SharedContext.kt</a></b>
<a href="#h9-0" id="h9-0" class="h">@@ -7,7 +7,8 @@ import android.content.Intent
</a> import android.os.Build
 import android.os.Environment
 import android.provider.Settings
<a href="#h9-0-3" id="h9-0-3" class="d">-import me.rhunk.snapenhance.bridge.TranslationWrapper
</a><a href="#h9-0-4" id="h9-0-4" class="i">+import me.rhunk.snapenhance.bridge.wrapper.ConfigWrapper
</a><a href="#h9-0-5" id="h9-0-5" class="i">+import me.rhunk.snapenhance.bridge.wrapper.TranslationWrapper
</a> import me.rhunk.snapenhance.download.DownloadTaskManager
 import kotlin.system.exitProcess
 
<a href="#h9-1" id="h9-1" class="h">@@ -17,6 +18,7 @@ import kotlin.system.exitProcess
</a> object SharedContext {
     lateinit var downloadTaskManager: DownloadTaskManager
     lateinit var translation: TranslationWrapper
<a href="#h9-1-3" id="h9-1-3" class="i">+    lateinit var config: ConfigWrapper
</a> 
     private fun askForStoragePermission(context: Context) {
         if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.R) {
<a href="#h9-2" id="h9-2" class="h">@@ -36,17 +38,7 @@ object SharedContext {
</a>         context.requestPermissions(arrayOf(android.Manifest.permission.WRITE_EXTERNAL_STORAGE, android.Manifest.permission.READ_EXTERNAL_STORAGE), 0)
     }
 
<a href="#h9-2-3" id="h9-2-3" class="d">-    fun ensureInitialized(context: Context) {
</a><a href="#h9-2-4" id="h9-2-4" class="d">-        if (!this::downloadTaskManager.isInitialized) {
</a><a href="#h9-2-5" id="h9-2-5" class="d">-            downloadTaskManager = DownloadTaskManager().apply {
</a><a href="#h9-2-6" id="h9-2-6" class="d">-                init(context)
</a><a href="#h9-2-7" id="h9-2-7" class="d">-            }
</a><a href="#h9-2-8" id="h9-2-8" class="d">-        }
</a><a href="#h9-2-9" id="h9-2-9" class="d">-        if (!this::translation.isInitialized) {
</a><a href="#h9-2-10" id="h9-2-10" class="d">-            translation = TranslationWrapper().apply {
</a><a href="#h9-2-11" id="h9-2-11" class="d">-                loadFromContext(context)
</a><a href="#h9-2-12" id="h9-2-12" class="d">-            }
</a><a href="#h9-2-13" id="h9-2-13" class="d">-        }
</a><a href="#h9-2-14" id="h9-2-14" class="i">+    private fun askForPermissions(context: Context) {
</a> 
         //ask for storage permission
         val hasStoragePermission = if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.R) {
<a href="#h9-3" id="h9-3" class="h">@@ -72,4 +64,22 @@ object SharedContext {
</a>             }
             .show()
     }
<a href="#h9-3-3" id="h9-3-3" class="i">+
</a><a href="#h9-3-4" id="h9-3-4" class="i">+    fun ensureInitialized(context: Context) {
</a><a href="#h9-3-5" id="h9-3-5" class="i">+        if (!this::downloadTaskManager.isInitialized) {
</a><a href="#h9-3-6" id="h9-3-6" class="i">+            downloadTaskManager = DownloadTaskManager().apply {
</a><a href="#h9-3-7" id="h9-3-7" class="i">+                init(context)
</a><a href="#h9-3-8" id="h9-3-8" class="i">+            }
</a><a href="#h9-3-9" id="h9-3-9" class="i">+        }
</a><a href="#h9-3-10" id="h9-3-10" class="i">+        if (!this::translation.isInitialized) {
</a><a href="#h9-3-11" id="h9-3-11" class="i">+            translation = TranslationWrapper().apply {
</a><a href="#h9-3-12" id="h9-3-12" class="i">+                loadFromContext(context)
</a><a href="#h9-3-13" id="h9-3-13" class="i">+            }
</a><a href="#h9-3-14" id="h9-3-14" class="i">+        }
</a><a href="#h9-3-15" id="h9-3-15" class="i">+        if (!this::config.isInitialized) {
</a><a href="#h9-3-16" id="h9-3-16" class="i">+            config = ConfigWrapper().apply { loadFromContext(context) }
</a><a href="#h9-3-17" id="h9-3-17" class="i">+        }
</a><a href="#h9-3-18" id="h9-3-18" class="i">+
</a><a href="#h9-3-19" id="h9-3-19" class="i">+        askForPermissions(context)
</a><a href="#h9-3-20" id="h9-3-20" class="i">+    }
</a> } 
\ No newline at end of file
<b>diff --git a/<a id="h10" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/SnapEnhance.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/SnapEnhance.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/SnapEnhance.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/SnapEnhance.kt</a></b>
<a href="#h10-0" id="h10-0" class="h">@@ -1,16 +1,17 @@
</a> package me.rhunk.snapenhance
 
<a href="#h10-0-2" id="h10-0-2" class="d">-import android.annotation.SuppressLint
</a> import android.app.Activity
 import android.app.Application
 import android.content.Context
<a href="#h10-0-6" id="h10-0-6" class="i">+import android.content.pm.PackageManager
</a> import kotlinx.coroutines.runBlocking
 import kotlinx.coroutines.withContext
<a href="#h10-0-9" id="h10-0-9" class="d">-import me.rhunk.snapenhance.bridge.AbstractBridgeClient
</a><a href="#h10-0-10" id="h10-0-10" class="d">-import me.rhunk.snapenhance.bridge.client.ServiceBridgeClient
</a><a href="#h10-0-11" id="h10-0-11" class="i">+import me.rhunk.snapenhance.bridge.BridgeClient
</a> import me.rhunk.snapenhance.data.SnapClassCache
 import me.rhunk.snapenhance.hook.HookStage
 import me.rhunk.snapenhance.hook.Hooker
<a href="#h10-0-15" id="h10-0-15" class="i">+import me.rhunk.snapenhance.hook.hook
</a><a href="#h10-0-16" id="h10-0-16" class="i">+import me.rhunk.snapenhance.util.getApplicationInfoCompat
</a> import kotlin.time.ExperimentalTime
 import kotlin.time.measureTime
 
<a href="#h10-1" id="h10-1" class="h">@@ -22,16 +23,24 @@ class SnapEnhance {
</a>         }
     }
     private val appContext = ModContext()
<a href="#h10-1-3" id="h10-1-3" class="i">+    private var isBridgeInitialized = false
</a> 
     init {
         Hooker.hook(Application::class.java, &quot;attach&quot;, HookStage.BEFORE) { param -&gt;
             appContext.androidContext = param.arg&lt;Context&gt;(0).also {
                 classLoader = it.classLoader
             }
<a href="#h10-1-10" id="h10-1-10" class="d">-            appContext.bridgeClient = provideBridgeClient()
</a><a href="#h10-1-11" id="h10-1-11" class="i">+            appContext.bridgeClient = BridgeClient(appContext)
</a><a href="#h10-1-12" id="h10-1-12" class="i">+
</a><a href="#h10-1-13" id="h10-1-13" class="i">+            //for lspatch builds, we need to check if the service is correctly installed
</a><a href="#h10-1-14" id="h10-1-14" class="i">+            runCatching {
</a><a href="#h10-1-15" id="h10-1-15" class="i">+                appContext.androidContext.packageManager.getApplicationInfoCompat(BuildConfig.APPLICATION_ID, PackageManager.GET_META_DATA)
</a><a href="#h10-1-16" id="h10-1-16" class="i">+            }.onFailure {
</a><a href="#h10-1-17" id="h10-1-17" class="i">+                appContext.crash(&quot;SnapEnhance bridge service is not installed. Please download stable version from https://github.com/rhunk/SnapEnhance/releases&quot;)
</a><a href="#h10-1-18" id="h10-1-18" class="i">+                return@hook
</a><a href="#h10-1-19" id="h10-1-19" class="i">+            }
</a> 
             appContext.bridgeClient.apply {
<a href="#h10-1-22" id="h10-1-22" class="d">-                this.context = appContext
</a>                 start { bridgeResult -&gt;
                     if (!bridgeResult) {
                         Logger.xposedLog(&quot;Cannot connect to bridge service&quot;)
<a href="#h10-2" id="h10-2" class="h">@@ -42,6 +51,8 @@ class SnapEnhance {
</a>                         runBlocking {
                             init()
                         }
<a href="#h10-2-3" id="h10-2-3" class="i">+                    }.onSuccess {
</a><a href="#h10-2-4" id="h10-2-4" class="i">+                        isBridgeInitialized = true
</a>                     }.onFailure {
                         Logger.xposedLog(&quot;Failed to initialize&quot;, it)
                     }
<a href="#h10-3" id="h10-3" class="h">@@ -49,7 +60,7 @@ class SnapEnhance {
</a>             }
         }
 
<a href="#h10-3-3" id="h10-3-3" class="d">-        Hooker.hook(Activity::class.java, &quot;onCreate&quot;, HookStage.AFTER) {
</a><a href="#h10-3-4" id="h10-3-4" class="i">+        Activity::class.java.hook( &quot;onCreate&quot;,  HookStage.AFTER, { isBridgeInitialized }) {
</a>             val activity = it.thisObject() as Activity
             if (!activity.packageName.equals(Constants.SNAPCHAT_PACKAGE_NAME)) return@hook
             val isMainActivityNotNull = appContext.mainActivity != null
<a href="#h10-4" id="h10-4" class="h">@@ -61,7 +72,7 @@ class SnapEnhance {
</a>         var activityWasResumed = false
 
         //we need to reload the config when the app is resumed
<a href="#h10-4-3" id="h10-4-3" class="d">-        Hooker.hook(Activity::class.java, &quot;onResume&quot;, HookStage.AFTER) {
</a><a href="#h10-4-4" id="h10-4-4" class="i">+        Activity::class.java.hook(&quot;onResume&quot;, HookStage.AFTER, { isBridgeInitialized }) {
</a>             val activity = it.thisObject() as Activity
 
             if (!activity.packageName.equals(Constants.SNAPCHAT_PACKAGE_NAME)) return@hook
<a href="#h10-5" id="h10-5" class="h">@@ -76,14 +87,6 @@ class SnapEnhance {
</a>         }
     }
 
<a href="#h10-5-3" id="h10-5-3" class="d">-    @SuppressLint(&quot;ObsoleteSdkInt&quot;)
</a><a href="#h10-5-4" id="h10-5-4" class="d">-    private fun provideBridgeClient(): AbstractBridgeClient {
</a><a href="#h10-5-5" id="h10-5-5" class="d">-        /*if (Build.VERSION.SDK_INT &lt;= Build.VERSION_CODES.P) {
</a><a href="#h10-5-6" id="h10-5-6" class="d">-            return RootBridgeClient()
</a><a href="#h10-5-7" id="h10-5-7" class="d">-        }*/
</a><a href="#h10-5-8" id="h10-5-8" class="d">-        return ServiceBridgeClient()
</a><a href="#h10-5-9" id="h10-5-9" class="d">-    }
</a><a href="#h10-5-10" id="h10-5-10" class="d">-
</a>     @OptIn(ExperimentalTime::class)
     private suspend fun init() {
         //load translations in a coroutine to speed up initialization
<a href="#h10-6" id="h10-6" class="h">@@ -100,7 +103,7 @@ class SnapEnhance {
</a>                 features.init()
             }
         }.also { time -&gt;
<a href="#h10-6-3" id="h10-6-3" class="d">-            Logger.debug(&quot;initialized in $time&quot;)
</a><a href="#h10-6-4" id="h10-6-4" class="i">+            Logger.debug(&quot;init took $time&quot;)
</a>         }
     }
 
<a href="#h10-7" id="h10-7" class="h">@@ -112,7 +115,7 @@ class SnapEnhance {
</a>                 actionManager.init()
             }
         }.also { time -&gt;
<a href="#h10-7-3" id="h10-7-3" class="d">-            Logger.debug(&quot;onActivityCreate in $time&quot;)
</a><a href="#h10-7-4" id="h10-7-4" class="i">+            Logger.debug(&quot;onActivityCreate took $time&quot;)
</a>         }
     }
 } 
\ No newline at end of file
<b>diff --git a/<a id="h11" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/action/impl/ExportChatMessages.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/action/impl/ExportChatMessages.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/action/impl/ExportChatMessages.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/action/impl/ExportChatMessages.kt</a></b>
<a href="#h11-0" id="h11-0" class="h">@@ -19,6 +19,7 @@ import me.rhunk.snapenhance.data.wrapper.impl.Message
</a> import me.rhunk.snapenhance.data.wrapper.impl.SnapUUID
 import me.rhunk.snapenhance.database.objects.FriendFeedInfo
 import me.rhunk.snapenhance.features.impl.Messaging
<a href="#h11-0-3" id="h11-0-3" class="i">+import me.rhunk.snapenhance.ui.ViewAppearanceHelper
</a> import me.rhunk.snapenhance.util.CallbackBuilder
 import me.rhunk.snapenhance.util.export.ExportFormat
 import me.rhunk.snapenhance.util.export.MessageExporter
<a href="#h11-1" id="h11-1" class="h">@@ -61,7 +62,7 @@ class ExportChatMessages : AbstractAction(&quot;action.export_chat_messages&quot;) {
</a> 
     private suspend fun askExportType() = suspendCancellableCoroutine { cont -&gt;
         context.runOnUiThread {
<a href="#h11-1-3" id="h11-1-3" class="d">-            AlertDialog.Builder(context.mainActivity)
</a><a href="#h11-1-4" id="h11-1-4" class="i">+            ViewAppearanceHelper.newAlertDialogBuilder(context.mainActivity)
</a>                 .setTitle(context.translation[&quot;chat_export.select_export_format&quot;])
                 .setItems(ExportFormat.values().map { it.name }.toTypedArray()) { _, which -&gt;
                     cont.resumeWith(Result.success(ExportFormat.values()[which]))
<a href="#h11-2" id="h11-2" class="h">@@ -82,7 +83,7 @@ class ExportChatMessages : AbstractAction(&quot;action.export_chat_messages&quot;) {
</a>                 ContentType.NOTE,
                 ContentType.STICKER
             )
<a href="#h11-2-3" id="h11-2-3" class="d">-            AlertDialog.Builder(context.mainActivity)
</a><a href="#h11-2-4" id="h11-2-4" class="i">+            ViewAppearanceHelper.newAlertDialogBuilder(context.mainActivity)
</a>                 .setTitle(context.translation[&quot;chat_export.select_media_type&quot;])
                 .setMultiChoiceItems(contentTypes.map { it.name }.toTypedArray(), BooleanArray(contentTypes.size) { false }) { _, which, isChecked -&gt;
                     val media = contentTypes[which]
<a href="#h11-3" id="h11-3" class="h">@@ -110,7 +111,7 @@ class ExportChatMessages : AbstractAction(&quot;action.export_chat_messages&quot;) {
</a>             val friendFeedEntries = context.database.getFriendFeed(20)
             val selectedConversations = mutableListOf&lt;FriendFeedInfo&gt;()
 
<a href="#h11-3-3" id="h11-3-3" class="d">-            AlertDialog.Builder(context.mainActivity)
</a><a href="#h11-3-4" id="h11-3-4" class="i">+            ViewAppearanceHelper.newAlertDialogBuilder(context.mainActivity)
</a>                 .setTitle(context.translation[&quot;chat_export.select_conversation&quot;])
                 .setMultiChoiceItems(
                     friendFeedEntries.map { it.feedDisplayName ?: it.friendDisplayName!!.split(&quot;|&quot;).firstOrNull() }.toTypedArray(),
<a href="#h11-4" id="h11-4" class="h">@@ -248,7 +249,7 @@ class ExportChatMessages : AbstractAction(&quot;action.export_chat_messages&quot;) {
</a>         dialogLogs.clear()
         val jobs = mutableListOf&lt;Job&gt;()
 
<a href="#h11-4-3" id="h11-4-3" class="d">-        currentActionDialog = AlertDialog.Builder(context.mainActivity)
</a><a href="#h11-4-4" id="h11-4-4" class="i">+        currentActionDialog = ViewAppearanceHelper.newAlertDialogBuilder(context.mainActivity)
</a>             .setTitle(context.translation[&quot;chat_export.exporting_chats&quot;])
             .setCancelable(false)
             .setMessage(&quot;&quot;)
<b>diff --git a/<a id="h12" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/action/impl/RefreshMappings.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/action/impl/RefreshMappings.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/action/impl/RefreshMappings.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/action/impl/RefreshMappings.kt</a></b>
<a href="#h12-0" id="h12-0" class="h">@@ -1,7 +1,7 @@
</a> package me.rhunk.snapenhance.action.impl
 
 import me.rhunk.snapenhance.action.AbstractAction
<a href="#h12-0-3" id="h12-0-3" class="d">-import me.rhunk.snapenhance.bridge.common.impl.file.BridgeFileType
</a><a href="#h12-0-4" id="h12-0-4" class="i">+import me.rhunk.snapenhance.bridge.types.BridgeFileType
</a> 
 class RefreshMappings : AbstractAction(&quot;action.refresh_mappings&quot;) {
     override fun run() {
<b>diff --git a/<a id="h13" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/AbstractBridgeClient.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/AbstractBridgeClient.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/AbstractBridgeClient.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/AbstractBridgeClient.kt</a></b>
<a href="#h13-0" id="h13-0" class="h">@@ -1,122 +0,0 @@
</a><a href="#h13-0-0" id="h13-0-0" class="d">-package me.rhunk.snapenhance.bridge
</a><a href="#h13-0-1" id="h13-0-1" class="d">-
</a><a href="#h13-0-2" id="h13-0-2" class="d">-import me.rhunk.snapenhance.ModContext
</a><a href="#h13-0-3" id="h13-0-3" class="d">-import me.rhunk.snapenhance.bridge.common.impl.file.BridgeFileType
</a><a href="#h13-0-4" id="h13-0-4" class="d">-import me.rhunk.snapenhance.bridge.common.impl.locale.LocaleResult
</a><a href="#h13-0-5" id="h13-0-5" class="d">-
</a><a href="#h13-0-6" id="h13-0-6" class="d">-abstract class AbstractBridgeClient {
</a><a href="#h13-0-7" id="h13-0-7" class="d">-    lateinit var context: ModContext
</a><a href="#h13-0-8" id="h13-0-8" class="d">-
</a><a href="#h13-0-9" id="h13-0-9" class="d">-    /**
</a><a href="#h13-0-10" id="h13-0-10" class="d">-     * Start the bridge client
</a><a href="#h13-0-11" id="h13-0-11" class="d">-     *
</a><a href="#h13-0-12" id="h13-0-12" class="d">-     * @param callback the callback to call when the initialization is done
</a><a href="#h13-0-13" id="h13-0-13" class="d">-     */
</a><a href="#h13-0-14" id="h13-0-14" class="d">-    abstract fun start(callback: (Boolean) -&gt; Unit = {})
</a><a href="#h13-0-15" id="h13-0-15" class="d">-
</a><a href="#h13-0-16" id="h13-0-16" class="d">-    /**
</a><a href="#h13-0-17" id="h13-0-17" class="d">-     * Create a file if it doesn&#39;t exist, and read it
</a><a href="#h13-0-18" id="h13-0-18" class="d">-     *
</a><a href="#h13-0-19" id="h13-0-19" class="d">-     * @param fileType       the type of file to create and read
</a><a href="#h13-0-20" id="h13-0-20" class="d">-     * @param defaultContent the default content to write to the file if it doesn&#39;t exist
</a><a href="#h13-0-21" id="h13-0-21" class="d">-     * @return the content of the file
</a><a href="#h13-0-22" id="h13-0-22" class="d">-     */
</a><a href="#h13-0-23" id="h13-0-23" class="d">-    abstract fun createAndReadFile(fileType: BridgeFileType, defaultContent: ByteArray): ByteArray
</a><a href="#h13-0-24" id="h13-0-24" class="d">-
</a><a href="#h13-0-25" id="h13-0-25" class="d">-    /**
</a><a href="#h13-0-26" id="h13-0-26" class="d">-     * Read a file
</a><a href="#h13-0-27" id="h13-0-27" class="d">-     *
</a><a href="#h13-0-28" id="h13-0-28" class="d">-     * @param fileType the type of file to read
</a><a href="#h13-0-29" id="h13-0-29" class="d">-     * @return the content of the file
</a><a href="#h13-0-30" id="h13-0-30" class="d">-     */
</a><a href="#h13-0-31" id="h13-0-31" class="d">-    abstract fun readFile(fileType: BridgeFileType): ByteArray
</a><a href="#h13-0-32" id="h13-0-32" class="d">-
</a><a href="#h13-0-33" id="h13-0-33" class="d">-    /**
</a><a href="#h13-0-34" id="h13-0-34" class="d">-     * Write a file
</a><a href="#h13-0-35" id="h13-0-35" class="d">-     *
</a><a href="#h13-0-36" id="h13-0-36" class="d">-     * @param fileType the type of file to write
</a><a href="#h13-0-37" id="h13-0-37" class="d">-     * @param content  the content to write to the file
</a><a href="#h13-0-38" id="h13-0-38" class="d">-     * @return true if the file was written successfully
</a><a href="#h13-0-39" id="h13-0-39" class="d">-     */
</a><a href="#h13-0-40" id="h13-0-40" class="d">-    abstract fun writeFile(fileType: BridgeFileType, content: ByteArray?): Boolean
</a><a href="#h13-0-41" id="h13-0-41" class="d">-
</a><a href="#h13-0-42" id="h13-0-42" class="d">-    /**
</a><a href="#h13-0-43" id="h13-0-43" class="d">-     * Delete a file
</a><a href="#h13-0-44" id="h13-0-44" class="d">-     *
</a><a href="#h13-0-45" id="h13-0-45" class="d">-     * @param fileType the type of file to delete
</a><a href="#h13-0-46" id="h13-0-46" class="d">-     * @return true if the file was deleted successfully
</a><a href="#h13-0-47" id="h13-0-47" class="d">-     */
</a><a href="#h13-0-48" id="h13-0-48" class="d">-    abstract fun deleteFile(fileType: BridgeFileType): Boolean
</a><a href="#h13-0-49" id="h13-0-49" class="d">-
</a><a href="#h13-0-50" id="h13-0-50" class="d">-    /**
</a><a href="#h13-0-51" id="h13-0-51" class="d">-     * Check if a file exists
</a><a href="#h13-0-52" id="h13-0-52" class="d">-     *
</a><a href="#h13-0-53" id="h13-0-53" class="d">-     * @param fileType the type of file to check
</a><a href="#h13-0-54" id="h13-0-54" class="d">-     * @return true if the file exists
</a><a href="#h13-0-55" id="h13-0-55" class="d">-     */
</a><a href="#h13-0-56" id="h13-0-56" class="d">-    abstract fun isFileExists(fileType: BridgeFileType): Boolean
</a><a href="#h13-0-57" id="h13-0-57" class="d">-
</a><a href="#h13-0-58" id="h13-0-58" class="d">-    /**
</a><a href="#h13-0-59" id="h13-0-59" class="d">-     * Download content from a URL and save it to a file
</a><a href="#h13-0-60" id="h13-0-60" class="d">-     *
</a><a href="#h13-0-61" id="h13-0-61" class="d">-     * @param url  the URL to download content from
</a><a href="#h13-0-62" id="h13-0-62" class="d">-     * @param path the path to save the content to
</a><a href="#h13-0-63" id="h13-0-63" class="d">-     * @return true if the content was downloaded successfully
</a><a href="#h13-0-64" id="h13-0-64" class="d">-     */
</a><a href="#h13-0-65" id="h13-0-65" class="d">-    abstract fun downloadContent(url: String, path: String): Boolean
</a><a href="#h13-0-66" id="h13-0-66" class="d">-
</a><a href="#h13-0-67" id="h13-0-67" class="d">-    /**
</a><a href="#h13-0-68" id="h13-0-68" class="d">-     * Get the content of a logged message from the database
</a><a href="#h13-0-69" id="h13-0-69" class="d">-     *
</a><a href="#h13-0-70" id="h13-0-70" class="d">-     * @param conversationId the ID of the conversation
</a><a href="#h13-0-71" id="h13-0-71" class="d">-     * @return the content of the message
</a><a href="#h13-0-72" id="h13-0-72" class="d">-     */
</a><a href="#h13-0-73" id="h13-0-73" class="d">-    abstract fun getLoggedMessageIds(conversationId: String, limit: Int): List&lt;Long&gt;
</a><a href="#h13-0-74" id="h13-0-74" class="d">-
</a><a href="#h13-0-75" id="h13-0-75" class="d">-    /**
</a><a href="#h13-0-76" id="h13-0-76" class="d">-     * Get the content of a logged message from the database
</a><a href="#h13-0-77" id="h13-0-77" class="d">-     *
</a><a href="#h13-0-78" id="h13-0-78" class="d">-     * @param id the ID of the message logger message
</a><a href="#h13-0-79" id="h13-0-79" class="d">-     * @return the content of the message
</a><a href="#h13-0-80" id="h13-0-80" class="d">-     */
</a><a href="#h13-0-81" id="h13-0-81" class="d">-    abstract fun getMessageLoggerMessage(conversationId: String, id: Long): ByteArray?
</a><a href="#h13-0-82" id="h13-0-82" class="d">-
</a><a href="#h13-0-83" id="h13-0-83" class="d">-    /**
</a><a href="#h13-0-84" id="h13-0-84" class="d">-     * Add a message to the message logger database
</a><a href="#h13-0-85" id="h13-0-85" class="d">-     *
</a><a href="#h13-0-86" id="h13-0-86" class="d">-     * @param id      the ID of the message logger message
</a><a href="#h13-0-87" id="h13-0-87" class="d">-     * @param message the content of the message
</a><a href="#h13-0-88" id="h13-0-88" class="d">-     */
</a><a href="#h13-0-89" id="h13-0-89" class="d">-    abstract fun addMessageLoggerMessage(conversationId: String, id: Long, message: ByteArray)
</a><a href="#h13-0-90" id="h13-0-90" class="d">-
</a><a href="#h13-0-91" id="h13-0-91" class="d">-    /**
</a><a href="#h13-0-92" id="h13-0-92" class="d">-     * Delete a message from the message logger database
</a><a href="#h13-0-93" id="h13-0-93" class="d">-     *
</a><a href="#h13-0-94" id="h13-0-94" class="d">-     * @param id the ID of the message logger message
</a><a href="#h13-0-95" id="h13-0-95" class="d">-     */
</a><a href="#h13-0-96" id="h13-0-96" class="d">-    abstract fun deleteMessageLoggerMessage(conversationId: String, id: Long)
</a><a href="#h13-0-97" id="h13-0-97" class="d">-
</a><a href="#h13-0-98" id="h13-0-98" class="d">-    /**
</a><a href="#h13-0-99" id="h13-0-99" class="d">-     * Clear the message logger database
</a><a href="#h13-0-100" id="h13-0-100" class="d">-     */
</a><a href="#h13-0-101" id="h13-0-101" class="d">-    abstract fun clearMessageLogger()
</a><a href="#h13-0-102" id="h13-0-102" class="d">-
</a><a href="#h13-0-103" id="h13-0-103" class="d">-    /**
</a><a href="#h13-0-104" id="h13-0-104" class="d">-     * Fetch the translations
</a><a href="#h13-0-105" id="h13-0-105" class="d">-     *
</a><a href="#h13-0-106" id="h13-0-106" class="d">-     * @return the translations result
</a><a href="#h13-0-107" id="h13-0-107" class="d">-     */
</a><a href="#h13-0-108" id="h13-0-108" class="d">-    abstract fun fetchTranslations(): LocaleResult
</a><a href="#h13-0-109" id="h13-0-109" class="d">-
</a><a href="#h13-0-110" id="h13-0-110" class="d">-    /**
</a><a href="#h13-0-111" id="h13-0-111" class="d">-     * Get check for updates last time
</a><a href="#h13-0-112" id="h13-0-112" class="d">-     * @return the last time check for updates was done
</a><a href="#h13-0-113" id="h13-0-113" class="d">-     */
</a><a href="#h13-0-114" id="h13-0-114" class="d">-    abstract fun getAutoUpdaterTime(): Long
</a><a href="#h13-0-115" id="h13-0-115" class="d">-
</a><a href="#h13-0-116" id="h13-0-116" class="d">-    /**
</a><a href="#h13-0-117" id="h13-0-117" class="d">-     * Set check for updates last time
</a><a href="#h13-0-118" id="h13-0-118" class="d">-     * @param time the time to set
</a><a href="#h13-0-119" id="h13-0-119" class="d">-     */
</a><a href="#h13-0-120" id="h13-0-120" class="d">-    abstract fun setAutoUpdaterTime(time: Long)
</a><a href="#h13-0-121" id="h13-0-121" class="d">-}</a><a href="#h13-0-122" id="h13-0-122" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h14" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/BridgeClient.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/BridgeClient.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/BridgeClient.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/BridgeClient.kt</a></b>
<a href="#h14-0" id="h14-0" class="h">@@ -0,0 +1,126 @@
</a><a href="#h14-0-0" id="h14-0-0" class="i">+package me.rhunk.snapenhance.bridge
</a><a href="#h14-0-1" id="h14-0-1" class="i">+
</a><a href="#h14-0-2" id="h14-0-2" class="i">+
</a><a href="#h14-0-3" id="h14-0-3" class="i">+import android.content.ComponentName
</a><a href="#h14-0-4" id="h14-0-4" class="i">+import android.content.Context
</a><a href="#h14-0-5" id="h14-0-5" class="i">+import android.content.Intent
</a><a href="#h14-0-6" id="h14-0-6" class="i">+import android.content.ServiceConnection
</a><a href="#h14-0-7" id="h14-0-7" class="i">+import android.os.Build
</a><a href="#h14-0-8" id="h14-0-8" class="i">+import android.os.Handler
</a><a href="#h14-0-9" id="h14-0-9" class="i">+import android.os.HandlerThread
</a><a href="#h14-0-10" id="h14-0-10" class="i">+import android.os.IBinder
</a><a href="#h14-0-11" id="h14-0-11" class="i">+import de.robv.android.xposed.XposedHelpers
</a><a href="#h14-0-12" id="h14-0-12" class="i">+import me.rhunk.snapenhance.BuildConfig
</a><a href="#h14-0-13" id="h14-0-13" class="i">+import me.rhunk.snapenhance.Logger.xposedLog
</a><a href="#h14-0-14" id="h14-0-14" class="i">+import me.rhunk.snapenhance.ModContext
</a><a href="#h14-0-15" id="h14-0-15" class="i">+import me.rhunk.snapenhance.bridge.types.BridgeFileType
</a><a href="#h14-0-16" id="h14-0-16" class="i">+import me.rhunk.snapenhance.data.LocalePair
</a><a href="#h14-0-17" id="h14-0-17" class="i">+import java.util.concurrent.CompletableFuture
</a><a href="#h14-0-18" id="h14-0-18" class="i">+import java.util.concurrent.Executors
</a><a href="#h14-0-19" id="h14-0-19" class="i">+import kotlin.system.exitProcess
</a><a href="#h14-0-20" id="h14-0-20" class="i">+
</a><a href="#h14-0-21" id="h14-0-21" class="i">+
</a><a href="#h14-0-22" id="h14-0-22" class="i">+class BridgeClient(
</a><a href="#h14-0-23" id="h14-0-23" class="i">+    private val context: ModContext
</a><a href="#h14-0-24" id="h14-0-24" class="i">+):  ServiceConnection {
</a><a href="#h14-0-25" id="h14-0-25" class="i">+    private lateinit var future: CompletableFuture&lt;Boolean&gt;
</a><a href="#h14-0-26" id="h14-0-26" class="i">+    private lateinit var service: BridgeInterface
</a><a href="#h14-0-27" id="h14-0-27" class="i">+
</a><a href="#h14-0-28" id="h14-0-28" class="i">+    fun start(callback: (Boolean) -&gt; Unit) {
</a><a href="#h14-0-29" id="h14-0-29" class="i">+        this.future = CompletableFuture()
</a><a href="#h14-0-30" id="h14-0-30" class="i">+
</a><a href="#h14-0-31" id="h14-0-31" class="i">+        with(context.androidContext) {
</a><a href="#h14-0-32" id="h14-0-32" class="i">+            //ensure the remote process is running
</a><a href="#h14-0-33" id="h14-0-33" class="i">+            startActivity(Intent()
</a><a href="#h14-0-34" id="h14-0-34" class="i">+                .setClassName(BuildConfig.APPLICATION_ID, ForceStartActivity::class.java.name)
</a><a href="#h14-0-35" id="h14-0-35" class="i">+                .addFlags(Intent.FLAG_ACTIVITY_NEW_TASK or Intent.FLAG_ACTIVITY_MULTIPLE_TASK)
</a><a href="#h14-0-36" id="h14-0-36" class="i">+            )
</a><a href="#h14-0-37" id="h14-0-37" class="i">+
</a><a href="#h14-0-38" id="h14-0-38" class="i">+            val intent = Intent()
</a><a href="#h14-0-39" id="h14-0-39" class="i">+                .setClassName(BuildConfig.APPLICATION_ID, BridgeService::class.java.name)
</a><a href="#h14-0-40" id="h14-0-40" class="i">+            if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.Q) {
</a><a href="#h14-0-41" id="h14-0-41" class="i">+                bindService(
</a><a href="#h14-0-42" id="h14-0-42" class="i">+                    intent,
</a><a href="#h14-0-43" id="h14-0-43" class="i">+                    Context.BIND_AUTO_CREATE,
</a><a href="#h14-0-44" id="h14-0-44" class="i">+                    Executors.newSingleThreadExecutor(),
</a><a href="#h14-0-45" id="h14-0-45" class="i">+                    this@BridgeClient
</a><a href="#h14-0-46" id="h14-0-46" class="i">+                )
</a><a href="#h14-0-47" id="h14-0-47" class="i">+            } else {
</a><a href="#h14-0-48" id="h14-0-48" class="i">+                XposedHelpers.callMethod(
</a><a href="#h14-0-49" id="h14-0-49" class="i">+                    this,
</a><a href="#h14-0-50" id="h14-0-50" class="i">+                    &quot;bindServiceAsUser&quot;,
</a><a href="#h14-0-51" id="h14-0-51" class="i">+                    intent,
</a><a href="#h14-0-52" id="h14-0-52" class="i">+                    this@BridgeClient,
</a><a href="#h14-0-53" id="h14-0-53" class="i">+                    Context.BIND_AUTO_CREATE,
</a><a href="#h14-0-54" id="h14-0-54" class="i">+                    Handler(HandlerThread(&quot;BridgeClient&quot;).apply {
</a><a href="#h14-0-55" id="h14-0-55" class="i">+                        start()
</a><a href="#h14-0-56" id="h14-0-56" class="i">+                    }.looper),
</a><a href="#h14-0-57" id="h14-0-57" class="i">+                    android.os.Process.myUserHandle()
</a><a href="#h14-0-58" id="h14-0-58" class="i">+                )
</a><a href="#h14-0-59" id="h14-0-59" class="i">+            }
</a><a href="#h14-0-60" id="h14-0-60" class="i">+        }
</a><a href="#h14-0-61" id="h14-0-61" class="i">+        callback(future.get())
</a><a href="#h14-0-62" id="h14-0-62" class="i">+    }
</a><a href="#h14-0-63" id="h14-0-63" class="i">+
</a><a href="#h14-0-64" id="h14-0-64" class="i">+
</a><a href="#h14-0-65" id="h14-0-65" class="i">+    override fun onServiceConnected(name: ComponentName, service: IBinder) {
</a><a href="#h14-0-66" id="h14-0-66" class="i">+        this.service = BridgeInterface.Stub.asInterface(service)
</a><a href="#h14-0-67" id="h14-0-67" class="i">+        future.complete(true)
</a><a href="#h14-0-68" id="h14-0-68" class="i">+    }
</a><a href="#h14-0-69" id="h14-0-69" class="i">+
</a><a href="#h14-0-70" id="h14-0-70" class="i">+    override fun onNullBinding(name: ComponentName) {
</a><a href="#h14-0-71" id="h14-0-71" class="i">+        xposedLog(&quot;failed to connect to bridge service&quot;)
</a><a href="#h14-0-72" id="h14-0-72" class="i">+        future.complete(false)
</a><a href="#h14-0-73" id="h14-0-73" class="i">+    }
</a><a href="#h14-0-74" id="h14-0-74" class="i">+
</a><a href="#h14-0-75" id="h14-0-75" class="i">+    override fun onServiceDisconnected(name: ComponentName) {
</a><a href="#h14-0-76" id="h14-0-76" class="i">+        exitProcess(0)
</a><a href="#h14-0-77" id="h14-0-77" class="i">+    }
</a><a href="#h14-0-78" id="h14-0-78" class="i">+
</a><a href="#h14-0-79" id="h14-0-79" class="i">+    fun createAndReadFile(
</a><a href="#h14-0-80" id="h14-0-80" class="i">+        fileType: BridgeFileType,
</a><a href="#h14-0-81" id="h14-0-81" class="i">+        defaultContent: ByteArray
</a><a href="#h14-0-82" id="h14-0-82" class="i">+    ): ByteArray = service.createAndReadFile(fileType.value, defaultContent)
</a><a href="#h14-0-83" id="h14-0-83" class="i">+
</a><a href="#h14-0-84" id="h14-0-84" class="i">+    fun readFile(fileType: BridgeFileType): ByteArray = service.readFile(fileType.value)
</a><a href="#h14-0-85" id="h14-0-85" class="i">+
</a><a href="#h14-0-86" id="h14-0-86" class="i">+    fun writeFile(
</a><a href="#h14-0-87" id="h14-0-87" class="i">+        fileType: BridgeFileType,
</a><a href="#h14-0-88" id="h14-0-88" class="i">+        content: ByteArray?
</a><a href="#h14-0-89" id="h14-0-89" class="i">+    ): Boolean = service.writeFile(fileType.value, content)
</a><a href="#h14-0-90" id="h14-0-90" class="i">+
</a><a href="#h14-0-91" id="h14-0-91" class="i">+    fun deleteFile(fileType: BridgeFileType) = service.deleteFile(fileType.value)
</a><a href="#h14-0-92" id="h14-0-92" class="i">+
</a><a href="#h14-0-93" id="h14-0-93" class="i">+
</a><a href="#h14-0-94" id="h14-0-94" class="i">+    fun isFileExists(fileType: BridgeFileType) = service.isFileExists(fileType.value)
</a><a href="#h14-0-95" id="h14-0-95" class="i">+
</a><a href="#h14-0-96" id="h14-0-96" class="i">+    fun getLoggedMessageIds(conversationId: String, limit: Int): LongArray = service.getLoggedMessageIds(conversationId, limit)
</a><a href="#h14-0-97" id="h14-0-97" class="i">+
</a><a href="#h14-0-98" id="h14-0-98" class="i">+    fun getMessageLoggerMessage(conversationId: String, id: Long): ByteArray? = service.getMessageLoggerMessage(conversationId, id)
</a><a href="#h14-0-99" id="h14-0-99" class="i">+
</a><a href="#h14-0-100" id="h14-0-100" class="i">+    fun addMessageLoggerMessage(conversationId: String,id: Long, message: ByteArray) = service.addMessageLoggerMessage(conversationId, id, message)
</a><a href="#h14-0-101" id="h14-0-101" class="i">+
</a><a href="#h14-0-102" id="h14-0-102" class="i">+    fun deleteMessageLoggerMessage(conversationId: String, id: Long) = service.deleteMessageLoggerMessage(conversationId, id)
</a><a href="#h14-0-103" id="h14-0-103" class="i">+
</a><a href="#h14-0-104" id="h14-0-104" class="i">+    fun clearMessageLogger() = service.clearMessageLogger()
</a><a href="#h14-0-105" id="h14-0-105" class="i">+
</a><a href="#h14-0-106" id="h14-0-106" class="i">+    fun fetchTranslations() = service.fetchTranslations().map {
</a><a href="#h14-0-107" id="h14-0-107" class="i">+        LocalePair(it.key, it.value)
</a><a href="#h14-0-108" id="h14-0-108" class="i">+    }
</a><a href="#h14-0-109" id="h14-0-109" class="i">+
</a><a href="#h14-0-110" id="h14-0-110" class="i">+    fun getAutoUpdaterTime(): Long {
</a><a href="#h14-0-111" id="h14-0-111" class="i">+        createAndReadFile(BridgeFileType.AUTO_UPDATER_TIMESTAMP, &quot;0&quot;.toByteArray()).run {
</a><a href="#h14-0-112" id="h14-0-112" class="i">+            return if (isEmpty()) {
</a><a href="#h14-0-113" id="h14-0-113" class="i">+                0
</a><a href="#h14-0-114" id="h14-0-114" class="i">+            } else {
</a><a href="#h14-0-115" id="h14-0-115" class="i">+                String(this).toLong()
</a><a href="#h14-0-116" id="h14-0-116" class="i">+            }
</a><a href="#h14-0-117" id="h14-0-117" class="i">+        }
</a><a href="#h14-0-118" id="h14-0-118" class="i">+    }
</a><a href="#h14-0-119" id="h14-0-119" class="i">+
</a><a href="#h14-0-120" id="h14-0-120" class="i">+    fun setAutoUpdaterTime(time: Long) {
</a><a href="#h14-0-121" id="h14-0-121" class="i">+        writeFile(BridgeFileType.AUTO_UPDATER_TIMESTAMP, time.toString().toByteArray())
</a><a href="#h14-0-122" id="h14-0-122" class="i">+    }
</a><a href="#h14-0-123" id="h14-0-123" class="i">+
</a><a href="#h14-0-124" id="h14-0-124" class="i">+    fun enqueueDownload(intent: Intent, callback: DownloadCallback) = service.enqueueDownload(intent, callback)
</a><a href="#h14-0-125" id="h14-0-125" class="i">+}
</a><b>diff --git a/<a id="h15" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/BridgeService.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/BridgeService.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/BridgeService.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/BridgeService.kt</a></b>
<a href="#h15-0" id="h15-0" class="h">@@ -0,0 +1,105 @@
</a><a href="#h15-0-0" id="h15-0-0" class="i">+package me.rhunk.snapenhance.bridge
</a><a href="#h15-0-1" id="h15-0-1" class="i">+
</a><a href="#h15-0-2" id="h15-0-2" class="i">+import android.app.Service
</a><a href="#h15-0-3" id="h15-0-3" class="i">+import android.content.Intent
</a><a href="#h15-0-4" id="h15-0-4" class="i">+import android.os.IBinder
</a><a href="#h15-0-5" id="h15-0-5" class="i">+import me.rhunk.snapenhance.SharedContext
</a><a href="#h15-0-6" id="h15-0-6" class="i">+import me.rhunk.snapenhance.bridge.types.BridgeFileType
</a><a href="#h15-0-7" id="h15-0-7" class="i">+import me.rhunk.snapenhance.bridge.wrapper.MessageLoggerWrapper
</a><a href="#h15-0-8" id="h15-0-8" class="i">+import me.rhunk.snapenhance.bridge.wrapper.TranslationWrapper
</a><a href="#h15-0-9" id="h15-0-9" class="i">+import me.rhunk.snapenhance.download.DownloadProcessor
</a><a href="#h15-0-10" id="h15-0-10" class="i">+
</a><a href="#h15-0-11" id="h15-0-11" class="i">+class BridgeService : Service() {
</a><a href="#h15-0-12" id="h15-0-12" class="i">+    private lateinit var messageLoggerWrapper: MessageLoggerWrapper
</a><a href="#h15-0-13" id="h15-0-13" class="i">+    override fun onBind(intent: Intent): IBinder {
</a><a href="#h15-0-14" id="h15-0-14" class="i">+        messageLoggerWrapper = MessageLoggerWrapper(getDatabasePath(BridgeFileType.MESSAGE_LOGGER_DATABASE.fileName)).also { it.init() }
</a><a href="#h15-0-15" id="h15-0-15" class="i">+        return BridgeBinder()
</a><a href="#h15-0-16" id="h15-0-16" class="i">+    }
</a><a href="#h15-0-17" id="h15-0-17" class="i">+
</a><a href="#h15-0-18" id="h15-0-18" class="i">+    inner class BridgeBinder : BridgeInterface.Stub() {
</a><a href="#h15-0-19" id="h15-0-19" class="i">+        override fun createAndReadFile(fileType: Int, defaultContent: ByteArray?): ByteArray {
</a><a href="#h15-0-20" id="h15-0-20" class="i">+            val file = BridgeFileType.fromValue(fileType)?.resolve(this@BridgeService)
</a><a href="#h15-0-21" id="h15-0-21" class="i">+                ?: return defaultContent ?: ByteArray(0)
</a><a href="#h15-0-22" id="h15-0-22" class="i">+
</a><a href="#h15-0-23" id="h15-0-23" class="i">+            if (!file.exists()) {
</a><a href="#h15-0-24" id="h15-0-24" class="i">+                if (defaultContent == null) {
</a><a href="#h15-0-25" id="h15-0-25" class="i">+                    return ByteArray(0)
</a><a href="#h15-0-26" id="h15-0-26" class="i">+                }
</a><a href="#h15-0-27" id="h15-0-27" class="i">+
</a><a href="#h15-0-28" id="h15-0-28" class="i">+                file.writeBytes(defaultContent)
</a><a href="#h15-0-29" id="h15-0-29" class="i">+            }
</a><a href="#h15-0-30" id="h15-0-30" class="i">+
</a><a href="#h15-0-31" id="h15-0-31" class="i">+            return file.readBytes()
</a><a href="#h15-0-32" id="h15-0-32" class="i">+        }
</a><a href="#h15-0-33" id="h15-0-33" class="i">+
</a><a href="#h15-0-34" id="h15-0-34" class="i">+        override fun readFile(fileType: Int): ByteArray {
</a><a href="#h15-0-35" id="h15-0-35" class="i">+            val file = BridgeFileType.fromValue(fileType)?.resolve(this@BridgeService)
</a><a href="#h15-0-36" id="h15-0-36" class="i">+                ?: return ByteArray(0)
</a><a href="#h15-0-37" id="h15-0-37" class="i">+
</a><a href="#h15-0-38" id="h15-0-38" class="i">+            if (!file.exists()) {
</a><a href="#h15-0-39" id="h15-0-39" class="i">+                return ByteArray(0)
</a><a href="#h15-0-40" id="h15-0-40" class="i">+            }
</a><a href="#h15-0-41" id="h15-0-41" class="i">+
</a><a href="#h15-0-42" id="h15-0-42" class="i">+            return file.readBytes()
</a><a href="#h15-0-43" id="h15-0-43" class="i">+        }
</a><a href="#h15-0-44" id="h15-0-44" class="i">+
</a><a href="#h15-0-45" id="h15-0-45" class="i">+        override fun writeFile(fileType: Int, content: ByteArray?): Boolean {
</a><a href="#h15-0-46" id="h15-0-46" class="i">+            val file = BridgeFileType.fromValue(fileType)?.resolve(this@BridgeService)
</a><a href="#h15-0-47" id="h15-0-47" class="i">+                ?: return false
</a><a href="#h15-0-48" id="h15-0-48" class="i">+
</a><a href="#h15-0-49" id="h15-0-49" class="i">+            if (content == null) {
</a><a href="#h15-0-50" id="h15-0-50" class="i">+                return false
</a><a href="#h15-0-51" id="h15-0-51" class="i">+            }
</a><a href="#h15-0-52" id="h15-0-52" class="i">+
</a><a href="#h15-0-53" id="h15-0-53" class="i">+            file.writeBytes(content)
</a><a href="#h15-0-54" id="h15-0-54" class="i">+            return true
</a><a href="#h15-0-55" id="h15-0-55" class="i">+        }
</a><a href="#h15-0-56" id="h15-0-56" class="i">+
</a><a href="#h15-0-57" id="h15-0-57" class="i">+        override fun deleteFile(fileType: Int): Boolean {
</a><a href="#h15-0-58" id="h15-0-58" class="i">+            val file = BridgeFileType.fromValue(fileType)?.resolve(this@BridgeService)
</a><a href="#h15-0-59" id="h15-0-59" class="i">+                ?: return false
</a><a href="#h15-0-60" id="h15-0-60" class="i">+
</a><a href="#h15-0-61" id="h15-0-61" class="i">+            if (!file.exists()) {
</a><a href="#h15-0-62" id="h15-0-62" class="i">+                return false
</a><a href="#h15-0-63" id="h15-0-63" class="i">+            }
</a><a href="#h15-0-64" id="h15-0-64" class="i">+
</a><a href="#h15-0-65" id="h15-0-65" class="i">+            return file.delete()
</a><a href="#h15-0-66" id="h15-0-66" class="i">+        }
</a><a href="#h15-0-67" id="h15-0-67" class="i">+
</a><a href="#h15-0-68" id="h15-0-68" class="i">+        override fun isFileExists(fileType: Int): Boolean {
</a><a href="#h15-0-69" id="h15-0-69" class="i">+            val file = BridgeFileType.fromValue(fileType)?.resolve(this@BridgeService)
</a><a href="#h15-0-70" id="h15-0-70" class="i">+                ?: return false
</a><a href="#h15-0-71" id="h15-0-71" class="i">+
</a><a href="#h15-0-72" id="h15-0-72" class="i">+            return file.exists()
</a><a href="#h15-0-73" id="h15-0-73" class="i">+        }
</a><a href="#h15-0-74" id="h15-0-74" class="i">+
</a><a href="#h15-0-75" id="h15-0-75" class="i">+        override fun getLoggedMessageIds(conversationId: String, limit: Int) = messageLoggerWrapper.getMessageIds(conversationId, limit).toLongArray()
</a><a href="#h15-0-76" id="h15-0-76" class="i">+
</a><a href="#h15-0-77" id="h15-0-77" class="i">+        override fun getMessageLoggerMessage(conversationId: String, id: Long) = messageLoggerWrapper.getMessage(conversationId, id).second
</a><a href="#h15-0-78" id="h15-0-78" class="i">+
</a><a href="#h15-0-79" id="h15-0-79" class="i">+        override fun addMessageLoggerMessage(conversationId: String, id: Long, message: ByteArray) {
</a><a href="#h15-0-80" id="h15-0-80" class="i">+            messageLoggerWrapper.addMessage(conversationId, id, message)
</a><a href="#h15-0-81" id="h15-0-81" class="i">+        }
</a><a href="#h15-0-82" id="h15-0-82" class="i">+
</a><a href="#h15-0-83" id="h15-0-83" class="i">+        override fun deleteMessageLoggerMessage(conversationId: String, id: Long) = messageLoggerWrapper.deleteMessage(conversationId, id)
</a><a href="#h15-0-84" id="h15-0-84" class="i">+
</a><a href="#h15-0-85" id="h15-0-85" class="i">+        override fun clearMessageLogger() = messageLoggerWrapper.clearMessages()
</a><a href="#h15-0-86" id="h15-0-86" class="i">+
</a><a href="#h15-0-87" id="h15-0-87" class="i">+        override fun fetchTranslations() = TranslationWrapper.fetchLocales(context = this@BridgeService).associate {
</a><a href="#h15-0-88" id="h15-0-88" class="i">+            it.locale to it.content
</a><a href="#h15-0-89" id="h15-0-89" class="i">+        }
</a><a href="#h15-0-90" id="h15-0-90" class="i">+
</a><a href="#h15-0-91" id="h15-0-91" class="i">+        override fun getAutoUpdaterTime(): Long {
</a><a href="#h15-0-92" id="h15-0-92" class="i">+            throw UnsupportedOperationException()
</a><a href="#h15-0-93" id="h15-0-93" class="i">+        }
</a><a href="#h15-0-94" id="h15-0-94" class="i">+
</a><a href="#h15-0-95" id="h15-0-95" class="i">+        override fun setAutoUpdaterTime(time: Long) {
</a><a href="#h15-0-96" id="h15-0-96" class="i">+            throw UnsupportedOperationException()
</a><a href="#h15-0-97" id="h15-0-97" class="i">+        }
</a><a href="#h15-0-98" id="h15-0-98" class="i">+
</a><a href="#h15-0-99" id="h15-0-99" class="i">+        override fun enqueueDownload(intent: Intent, callback: DownloadCallback) {
</a><a href="#h15-0-100" id="h15-0-100" class="i">+            SharedContext.ensureInitialized(this@BridgeService)
</a><a href="#h15-0-101" id="h15-0-101" class="i">+            DownloadProcessor(this@BridgeService, callback).onReceive(intent)
</a><a href="#h15-0-102" id="h15-0-102" class="i">+        }
</a><a href="#h15-0-103" id="h15-0-103" class="i">+    }
</a><a href="#h15-0-104" id="h15-0-104" class="i">+}
</a><b>diff --git a/<a id="h16" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/ConfigWrapper.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/ConfigWrapper.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/ConfigWrapper.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/ConfigWrapper.kt</a></b>
<a href="#h16-0" id="h16-0" class="h">@@ -1,79 +0,0 @@
</a><a href="#h16-0-0" id="h16-0-0" class="d">-package me.rhunk.snapenhance.bridge
</a><a href="#h16-0-1" id="h16-0-1" class="d">-
</a><a href="#h16-0-2" id="h16-0-2" class="d">-import android.content.Context
</a><a href="#h16-0-3" id="h16-0-3" class="d">-import com.google.gson.GsonBuilder
</a><a href="#h16-0-4" id="h16-0-4" class="d">-import com.google.gson.JsonObject
</a><a href="#h16-0-5" id="h16-0-5" class="d">-import me.rhunk.snapenhance.Logger
</a><a href="#h16-0-6" id="h16-0-6" class="d">-import me.rhunk.snapenhance.bridge.common.impl.file.BridgeFileType
</a><a href="#h16-0-7" id="h16-0-7" class="d">-import me.rhunk.snapenhance.config.ConfigAccessor
</a><a href="#h16-0-8" id="h16-0-8" class="d">-import me.rhunk.snapenhance.config.ConfigProperty
</a><a href="#h16-0-9" id="h16-0-9" class="d">-
</a><a href="#h16-0-10" id="h16-0-10" class="d">-class ConfigWrapper: ConfigAccessor() {
</a><a href="#h16-0-11" id="h16-0-11" class="d">-    companion object {
</a><a href="#h16-0-12" id="h16-0-12" class="d">-        private val gson = GsonBuilder().setPrettyPrinting().create()
</a><a href="#h16-0-13" id="h16-0-13" class="d">-    }
</a><a href="#h16-0-14" id="h16-0-14" class="d">-
</a><a href="#h16-0-15" id="h16-0-15" class="d">-    private lateinit var isFileExistsAction: () -&gt; Boolean
</a><a href="#h16-0-16" id="h16-0-16" class="d">-    private lateinit var writeFileAction: (ByteArray) -&gt; Unit
</a><a href="#h16-0-17" id="h16-0-17" class="d">-    private lateinit var readFileAction: () -&gt; ByteArray
</a><a href="#h16-0-18" id="h16-0-18" class="d">-
</a><a href="#h16-0-19" id="h16-0-19" class="d">-    fun load() {
</a><a href="#h16-0-20" id="h16-0-20" class="d">-        ConfigProperty.sortedByCategory().forEach { key -&gt;
</a><a href="#h16-0-21" id="h16-0-21" class="d">-            set(key, key.valueContainer)
</a><a href="#h16-0-22" id="h16-0-22" class="d">-        }
</a><a href="#h16-0-23" id="h16-0-23" class="d">-
</a><a href="#h16-0-24" id="h16-0-24" class="d">-        if (!isFileExistsAction()) {
</a><a href="#h16-0-25" id="h16-0-25" class="d">-            writeConfig()
</a><a href="#h16-0-26" id="h16-0-26" class="d">-            return
</a><a href="#h16-0-27" id="h16-0-27" class="d">-        }
</a><a href="#h16-0-28" id="h16-0-28" class="d">-
</a><a href="#h16-0-29" id="h16-0-29" class="d">-        runCatching {
</a><a href="#h16-0-30" id="h16-0-30" class="d">-            loadConfig()
</a><a href="#h16-0-31" id="h16-0-31" class="d">-        }.onFailure {
</a><a href="#h16-0-32" id="h16-0-32" class="d">-            Logger.error(&quot;Failed to load config&quot;, it)
</a><a href="#h16-0-33" id="h16-0-33" class="d">-            writeConfig()
</a><a href="#h16-0-34" id="h16-0-34" class="d">-        }
</a><a href="#h16-0-35" id="h16-0-35" class="d">-    }
</a><a href="#h16-0-36" id="h16-0-36" class="d">-
</a><a href="#h16-0-37" id="h16-0-37" class="d">-    private fun loadConfig() {
</a><a href="#h16-0-38" id="h16-0-38" class="d">-        val configContent = readFileAction()
</a><a href="#h16-0-39" id="h16-0-39" class="d">-
</a><a href="#h16-0-40" id="h16-0-40" class="d">-        val configObject: JsonObject = gson.fromJson(
</a><a href="#h16-0-41" id="h16-0-41" class="d">-            configContent.toString(Charsets.UTF_8),
</a><a href="#h16-0-42" id="h16-0-42" class="d">-            JsonObject::class.java
</a><a href="#h16-0-43" id="h16-0-43" class="d">-        )
</a><a href="#h16-0-44" id="h16-0-44" class="d">-
</a><a href="#h16-0-45" id="h16-0-45" class="d">-        entries().forEach { (key, value) -&gt;
</a><a href="#h16-0-46" id="h16-0-46" class="d">-            value.writeFrom(configObject.get(key.name)?.asString ?: value.read())
</a><a href="#h16-0-47" id="h16-0-47" class="d">-        }
</a><a href="#h16-0-48" id="h16-0-48" class="d">-    }
</a><a href="#h16-0-49" id="h16-0-49" class="d">-
</a><a href="#h16-0-50" id="h16-0-50" class="d">-    fun writeConfig() {
</a><a href="#h16-0-51" id="h16-0-51" class="d">-        val configObject = JsonObject()
</a><a href="#h16-0-52" id="h16-0-52" class="d">-        entries().forEach { (key, value) -&gt;
</a><a href="#h16-0-53" id="h16-0-53" class="d">-            configObject.addProperty(key.name, value.read())
</a><a href="#h16-0-54" id="h16-0-54" class="d">-        }
</a><a href="#h16-0-55" id="h16-0-55" class="d">-        writeFileAction(gson.toJson(configObject).toByteArray(Charsets.UTF_8))
</a><a href="#h16-0-56" id="h16-0-56" class="d">-    }
</a><a href="#h16-0-57" id="h16-0-57" class="d">-
</a><a href="#h16-0-58" id="h16-0-58" class="d">-    fun loadFromContext(context: Context) {
</a><a href="#h16-0-59" id="h16-0-59" class="d">-        val configFile = BridgeFileType.CONFIG.resolve(context)
</a><a href="#h16-0-60" id="h16-0-60" class="d">-        isFileExistsAction = { configFile.exists() }
</a><a href="#h16-0-61" id="h16-0-61" class="d">-        readFileAction = {
</a><a href="#h16-0-62" id="h16-0-62" class="d">-            if (!configFile.exists()) {
</a><a href="#h16-0-63" id="h16-0-63" class="d">-                configFile.createNewFile()
</a><a href="#h16-0-64" id="h16-0-64" class="d">-                configFile.writeBytes(&quot;{}&quot;.toByteArray(Charsets.UTF_8))
</a><a href="#h16-0-65" id="h16-0-65" class="d">-            }
</a><a href="#h16-0-66" id="h16-0-66" class="d">-            configFile.readBytes()
</a><a href="#h16-0-67" id="h16-0-67" class="d">-        }
</a><a href="#h16-0-68" id="h16-0-68" class="d">-        writeFileAction = { configFile.writeBytes(it) }
</a><a href="#h16-0-69" id="h16-0-69" class="d">-        load()
</a><a href="#h16-0-70" id="h16-0-70" class="d">-    }
</a><a href="#h16-0-71" id="h16-0-71" class="d">-
</a><a href="#h16-0-72" id="h16-0-72" class="d">-    fun loadFromBridge(bridgeClient: AbstractBridgeClient) {
</a><a href="#h16-0-73" id="h16-0-73" class="d">-        isFileExistsAction = { bridgeClient.isFileExists(BridgeFileType.CONFIG) }
</a><a href="#h16-0-74" id="h16-0-74" class="d">-        readFileAction = { bridgeClient.createAndReadFile(BridgeFileType.CONFIG, &quot;{}&quot;.toByteArray(Charsets.UTF_8)) }
</a><a href="#h16-0-75" id="h16-0-75" class="d">-        writeFileAction = { bridgeClient.writeFile(BridgeFileType.CONFIG, it) }
</a><a href="#h16-0-76" id="h16-0-76" class="d">-        load()
</a><a href="#h16-0-77" id="h16-0-77" class="d">-    }
</a><a href="#h16-0-78" id="h16-0-78" class="d">-}</a><a href="#h16-0-79" id="h16-0-79" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h17" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/ForceStartActivity.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/ForceStartActivity.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/ForceStartActivity.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/ForceStartActivity.kt</a></b>
<a href="#h17-0" id="h17-0" class="h">@@ -0,0 +1,11 @@
</a><a href="#h17-0-0" id="h17-0-0" class="i">+package me.rhunk.snapenhance.bridge
</a><a href="#h17-0-1" id="h17-0-1" class="i">+
</a><a href="#h17-0-2" id="h17-0-2" class="i">+import android.app.Activity
</a><a href="#h17-0-3" id="h17-0-3" class="i">+import android.os.Bundle
</a><a href="#h17-0-4" id="h17-0-4" class="i">+
</a><a href="#h17-0-5" id="h17-0-5" class="i">+class ForceStartActivity : Activity() {
</a><a href="#h17-0-6" id="h17-0-6" class="i">+    override fun onCreate(savedInstanceState: Bundle?) {
</a><a href="#h17-0-7" id="h17-0-7" class="i">+        super.onCreate(savedInstanceState)
</a><a href="#h17-0-8" id="h17-0-8" class="i">+        finish()
</a><a href="#h17-0-9" id="h17-0-9" class="i">+    }
</a><a href="#h17-0-10" id="h17-0-10" class="i">+}</a><a href="#h17-0-11" id="h17-0-11" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h18" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/MessageLoggerWrapper.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/MessageLoggerWrapper.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/MessageLoggerWrapper.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/MessageLoggerWrapper.kt</a></b>
<a href="#h18-0" id="h18-0" class="h">@@ -1,70 +0,0 @@
</a><a href="#h18-0-0" id="h18-0-0" class="d">-package me.rhunk.snapenhance.bridge
</a><a href="#h18-0-1" id="h18-0-1" class="d">-
</a><a href="#h18-0-2" id="h18-0-2" class="d">-import android.content.ContentValues
</a><a href="#h18-0-3" id="h18-0-3" class="d">-import android.database.sqlite.SQLiteDatabase
</a><a href="#h18-0-4" id="h18-0-4" class="d">-import me.rhunk.snapenhance.util.SQLiteDatabaseHelper
</a><a href="#h18-0-5" id="h18-0-5" class="d">-import java.io.File
</a><a href="#h18-0-6" id="h18-0-6" class="d">-
</a><a href="#h18-0-7" id="h18-0-7" class="d">-class MessageLoggerWrapper(
</a><a href="#h18-0-8" id="h18-0-8" class="d">-    private val databaseFile: File
</a><a href="#h18-0-9" id="h18-0-9" class="d">-) {
</a><a href="#h18-0-10" id="h18-0-10" class="d">-
</a><a href="#h18-0-11" id="h18-0-11" class="d">-    lateinit var database: SQLiteDatabase
</a><a href="#h18-0-12" id="h18-0-12" class="d">-
</a><a href="#h18-0-13" id="h18-0-13" class="d">-    fun init() {
</a><a href="#h18-0-14" id="h18-0-14" class="d">-        database = SQLiteDatabase.openDatabase(databaseFile.absolutePath, null, SQLiteDatabase.CREATE_IF_NECESSARY or SQLiteDatabase.OPEN_READWRITE)
</a><a href="#h18-0-15" id="h18-0-15" class="d">-        SQLiteDatabaseHelper.createTablesFromSchema(database, mapOf(
</a><a href="#h18-0-16" id="h18-0-16" class="d">-            &quot;messages&quot; to listOf(
</a><a href="#h18-0-17" id="h18-0-17" class="d">-                &quot;id INTEGER PRIMARY KEY&quot;,
</a><a href="#h18-0-18" id="h18-0-18" class="d">-                &quot;conversation_id VARCHAR&quot;,
</a><a href="#h18-0-19" id="h18-0-19" class="d">-                &quot;message_id BIGINT&quot;,
</a><a href="#h18-0-20" id="h18-0-20" class="d">-                &quot;message_data BLOB&quot;
</a><a href="#h18-0-21" id="h18-0-21" class="d">-            )
</a><a href="#h18-0-22" id="h18-0-22" class="d">-        ))
</a><a href="#h18-0-23" id="h18-0-23" class="d">-    }
</a><a href="#h18-0-24" id="h18-0-24" class="d">-
</a><a href="#h18-0-25" id="h18-0-25" class="d">-    fun deleteMessage(conversationId: String, messageId: Long) {
</a><a href="#h18-0-26" id="h18-0-26" class="d">-        database.execSQL(&quot;DELETE FROM messages WHERE conversation_id = ? AND message_id = ?&quot;, arrayOf(conversationId, messageId.toString()))
</a><a href="#h18-0-27" id="h18-0-27" class="d">-    }
</a><a href="#h18-0-28" id="h18-0-28" class="d">-
</a><a href="#h18-0-29" id="h18-0-29" class="d">-    fun addMessage(conversationId: String, messageId: Long, serializedMessage: ByteArray): Boolean {
</a><a href="#h18-0-30" id="h18-0-30" class="d">-        val cursor = database.rawQuery(&quot;SELECT message_id FROM messages WHERE conversation_id = ? AND message_id = ?&quot;, arrayOf(conversationId, messageId.toString()))
</a><a href="#h18-0-31" id="h18-0-31" class="d">-        val state = cursor.moveToFirst()
</a><a href="#h18-0-32" id="h18-0-32" class="d">-        cursor.close()
</a><a href="#h18-0-33" id="h18-0-33" class="d">-        if (state) {
</a><a href="#h18-0-34" id="h18-0-34" class="d">-            return false
</a><a href="#h18-0-35" id="h18-0-35" class="d">-        }
</a><a href="#h18-0-36" id="h18-0-36" class="d">-        database.insert(&quot;messages&quot;, null, ContentValues().apply {
</a><a href="#h18-0-37" id="h18-0-37" class="d">-            put(&quot;conversation_id&quot;, conversationId)
</a><a href="#h18-0-38" id="h18-0-38" class="d">-            put(&quot;message_id&quot;, messageId)
</a><a href="#h18-0-39" id="h18-0-39" class="d">-            put(&quot;message_data&quot;, serializedMessage)
</a><a href="#h18-0-40" id="h18-0-40" class="d">-        })
</a><a href="#h18-0-41" id="h18-0-41" class="d">-        return true
</a><a href="#h18-0-42" id="h18-0-42" class="d">-    }
</a><a href="#h18-0-43" id="h18-0-43" class="d">-
</a><a href="#h18-0-44" id="h18-0-44" class="d">-    fun getMessage(conversationId: String, messageId: Long): Pair&lt;Boolean, ByteArray?&gt; {
</a><a href="#h18-0-45" id="h18-0-45" class="d">-        val cursor = database.rawQuery(&quot;SELECT message_data FROM messages WHERE conversation_id = ? AND message_id = ?&quot;, arrayOf(conversationId, messageId.toString()))
</a><a href="#h18-0-46" id="h18-0-46" class="d">-        val state = cursor.moveToFirst()
</a><a href="#h18-0-47" id="h18-0-47" class="d">-        val message: ByteArray? = if (state) {
</a><a href="#h18-0-48" id="h18-0-48" class="d">-            cursor.getBlob(0)
</a><a href="#h18-0-49" id="h18-0-49" class="d">-        } else {
</a><a href="#h18-0-50" id="h18-0-50" class="d">-            null
</a><a href="#h18-0-51" id="h18-0-51" class="d">-        }
</a><a href="#h18-0-52" id="h18-0-52" class="d">-        cursor.close()
</a><a href="#h18-0-53" id="h18-0-53" class="d">-        return Pair(state, message)
</a><a href="#h18-0-54" id="h18-0-54" class="d">-    }
</a><a href="#h18-0-55" id="h18-0-55" class="d">-
</a><a href="#h18-0-56" id="h18-0-56" class="d">-    fun getMessageIds(conversationId: String, limit: Int): List&lt;Long&gt; {
</a><a href="#h18-0-57" id="h18-0-57" class="d">-        val cursor = database.rawQuery(&quot;SELECT message_id FROM messages WHERE conversation_id = ? ORDER BY message_id DESC LIMIT ?&quot;, arrayOf(conversationId, limit.toString()))
</a><a href="#h18-0-58" id="h18-0-58" class="d">-        val messageIds = mutableListOf&lt;Long&gt;()
</a><a href="#h18-0-59" id="h18-0-59" class="d">-        while (cursor.moveToNext()) {
</a><a href="#h18-0-60" id="h18-0-60" class="d">-            messageIds.add(cursor.getLong(0))
</a><a href="#h18-0-61" id="h18-0-61" class="d">-        }
</a><a href="#h18-0-62" id="h18-0-62" class="d">-        cursor.close()
</a><a href="#h18-0-63" id="h18-0-63" class="d">-        return messageIds
</a><a href="#h18-0-64" id="h18-0-64" class="d">-    }
</a><a href="#h18-0-65" id="h18-0-65" class="d">-
</a><a href="#h18-0-66" id="h18-0-66" class="d">-    fun clearMessages() {
</a><a href="#h18-0-67" id="h18-0-67" class="d">-        database.execSQL(&quot;DELETE FROM messages&quot;)
</a><a href="#h18-0-68" id="h18-0-68" class="d">-    }
</a><a href="#h18-0-69" id="h18-0-69" class="d">-}</a><a href="#h18-0-70" id="h18-0-70" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h19" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/TranslationWrapper.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/TranslationWrapper.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/TranslationWrapper.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/TranslationWrapper.kt</a></b>
<a href="#h19-0" id="h19-0" class="h">@@ -1,96 +0,0 @@
</a><a href="#h19-0-0" id="h19-0-0" class="d">-package me.rhunk.snapenhance.bridge
</a><a href="#h19-0-1" id="h19-0-1" class="d">-
</a><a href="#h19-0-2" id="h19-0-2" class="d">-import android.content.Context
</a><a href="#h19-0-3" id="h19-0-3" class="d">-import com.google.gson.JsonObject
</a><a href="#h19-0-4" id="h19-0-4" class="d">-import com.google.gson.JsonParser
</a><a href="#h19-0-5" id="h19-0-5" class="d">-import me.rhunk.snapenhance.Logger
</a><a href="#h19-0-6" id="h19-0-6" class="d">-import me.rhunk.snapenhance.data.LocalePair
</a><a href="#h19-0-7" id="h19-0-7" class="d">-import java.util.Locale
</a><a href="#h19-0-8" id="h19-0-8" class="d">-
</a><a href="#h19-0-9" id="h19-0-9" class="d">-
</a><a href="#h19-0-10" id="h19-0-10" class="d">-class TranslationWrapper {
</a><a href="#h19-0-11" id="h19-0-11" class="d">-    companion object {
</a><a href="#h19-0-12" id="h19-0-12" class="d">-        private const val DEFAULT_LOCALE = &quot;en_US&quot;
</a><a href="#h19-0-13" id="h19-0-13" class="d">-
</a><a href="#h19-0-14" id="h19-0-14" class="d">-        fun fetchLocales(context: Context): List&lt;LocalePair&gt; {
</a><a href="#h19-0-15" id="h19-0-15" class="d">-            val deviceLocale = Locale.getDefault().toString()
</a><a href="#h19-0-16" id="h19-0-16" class="d">-            val locales = mutableListOf&lt;LocalePair&gt;()
</a><a href="#h19-0-17" id="h19-0-17" class="d">-
</a><a href="#h19-0-18" id="h19-0-18" class="d">-            locales.add(LocalePair(DEFAULT_LOCALE, context.resources.assets.open(&quot;lang/$DEFAULT_LOCALE.json&quot;).bufferedReader().use { it.readText() }))
</a><a href="#h19-0-19" id="h19-0-19" class="d">-
</a><a href="#h19-0-20" id="h19-0-20" class="d">-            if (deviceLocale == DEFAULT_LOCALE) return locales
</a><a href="#h19-0-21" id="h19-0-21" class="d">-
</a><a href="#h19-0-22" id="h19-0-22" class="d">-            val compatibleLocale = context.resources.assets.list(&quot;lang&quot;)?.firstOrNull { it.startsWith(deviceLocale) }?.substring(0, 5) ?: return locales
</a><a href="#h19-0-23" id="h19-0-23" class="d">-
</a><a href="#h19-0-24" id="h19-0-24" class="d">-            context.resources.assets.open(&quot;lang/$compatibleLocale.json&quot;).use { inputStream -&gt;
</a><a href="#h19-0-25" id="h19-0-25" class="d">-                locales.add(LocalePair(compatibleLocale, inputStream.bufferedReader().use { it.readText() }))
</a><a href="#h19-0-26" id="h19-0-26" class="d">-            }
</a><a href="#h19-0-27" id="h19-0-27" class="d">-
</a><a href="#h19-0-28" id="h19-0-28" class="d">-            return locales
</a><a href="#h19-0-29" id="h19-0-29" class="d">-        }
</a><a href="#h19-0-30" id="h19-0-30" class="d">-    }
</a><a href="#h19-0-31" id="h19-0-31" class="d">-
</a><a href="#h19-0-32" id="h19-0-32" class="d">-
</a><a href="#h19-0-33" id="h19-0-33" class="d">-    private val translationMap = linkedMapOf&lt;String, String&gt;()
</a><a href="#h19-0-34" id="h19-0-34" class="d">-    private lateinit var _locale: String
</a><a href="#h19-0-35" id="h19-0-35" class="d">-
</a><a href="#h19-0-36" id="h19-0-36" class="d">-    val locale by lazy {
</a><a href="#h19-0-37" id="h19-0-37" class="d">-        Locale(_locale.substring(0, 2), _locale.substring(3, 5))
</a><a href="#h19-0-38" id="h19-0-38" class="d">-    }
</a><a href="#h19-0-39" id="h19-0-39" class="d">-
</a><a href="#h19-0-40" id="h19-0-40" class="d">-    private fun load(localePair: LocalePair) {
</a><a href="#h19-0-41" id="h19-0-41" class="d">-        if (!::_locale.isInitialized) {
</a><a href="#h19-0-42" id="h19-0-42" class="d">-            _locale = localePair.locale
</a><a href="#h19-0-43" id="h19-0-43" class="d">-        }
</a><a href="#h19-0-44" id="h19-0-44" class="d">-
</a><a href="#h19-0-45" id="h19-0-45" class="d">-        val translations = JsonParser.parseString(localePair.content).asJsonObject
</a><a href="#h19-0-46" id="h19-0-46" class="d">-        if (translations == null || translations.isJsonNull) {
</a><a href="#h19-0-47" id="h19-0-47" class="d">-            return
</a><a href="#h19-0-48" id="h19-0-48" class="d">-        }
</a><a href="#h19-0-49" id="h19-0-49" class="d">-
</a><a href="#h19-0-50" id="h19-0-50" class="d">-        fun scanObject(jsonObject: JsonObject, prefix: String = &quot;&quot;) {
</a><a href="#h19-0-51" id="h19-0-51" class="d">-            jsonObject.entrySet().forEach {
</a><a href="#h19-0-52" id="h19-0-52" class="d">-                if (it.value.isJsonPrimitive) {
</a><a href="#h19-0-53" id="h19-0-53" class="d">-                    val key = &quot;$prefix${it.key}&quot;
</a><a href="#h19-0-54" id="h19-0-54" class="d">-                    translationMap[key] = it.value.asString
</a><a href="#h19-0-55" id="h19-0-55" class="d">-                }
</a><a href="#h19-0-56" id="h19-0-56" class="d">-                if (!it.value.isJsonObject) return@forEach
</a><a href="#h19-0-57" id="h19-0-57" class="d">-                scanObject(it.value.asJsonObject, &quot;$prefix${it.key}.&quot;)
</a><a href="#h19-0-58" id="h19-0-58" class="d">-            }
</a><a href="#h19-0-59" id="h19-0-59" class="d">-        }
</a><a href="#h19-0-60" id="h19-0-60" class="d">-
</a><a href="#h19-0-61" id="h19-0-61" class="d">-        scanObject(translations)
</a><a href="#h19-0-62" id="h19-0-62" class="d">-    }
</a><a href="#h19-0-63" id="h19-0-63" class="d">-
</a><a href="#h19-0-64" id="h19-0-64" class="d">-    fun loadFromBridge(bridgeClient: AbstractBridgeClient) {
</a><a href="#h19-0-65" id="h19-0-65" class="d">-        bridgeClient.fetchTranslations().getLocales().forEach {
</a><a href="#h19-0-66" id="h19-0-66" class="d">-            load(it)
</a><a href="#h19-0-67" id="h19-0-67" class="d">-        }
</a><a href="#h19-0-68" id="h19-0-68" class="d">-    }
</a><a href="#h19-0-69" id="h19-0-69" class="d">-
</a><a href="#h19-0-70" id="h19-0-70" class="d">-    fun loadFromContext(context: Context) {
</a><a href="#h19-0-71" id="h19-0-71" class="d">-        fetchLocales(context).forEach {
</a><a href="#h19-0-72" id="h19-0-72" class="d">-            load(it)
</a><a href="#h19-0-73" id="h19-0-73" class="d">-        }
</a><a href="#h19-0-74" id="h19-0-74" class="d">-    }
</a><a href="#h19-0-75" id="h19-0-75" class="d">-
</a><a href="#h19-0-76" id="h19-0-76" class="d">-    operator fun get(key: String): String {
</a><a href="#h19-0-77" id="h19-0-77" class="d">-        return translationMap[key] ?: key.also { Logger.debug(&quot;Missing translation for $key&quot;) }
</a><a href="#h19-0-78" id="h19-0-78" class="d">-    }
</a><a href="#h19-0-79" id="h19-0-79" class="d">-
</a><a href="#h19-0-80" id="h19-0-80" class="d">-    fun format(key: String, vararg args: Pair&lt;String, String&gt;): String {
</a><a href="#h19-0-81" id="h19-0-81" class="d">-        return args.fold(get(key)) { acc, pair -&gt;
</a><a href="#h19-0-82" id="h19-0-82" class="d">-            acc.replace(&quot;{${pair.first}}&quot;, pair.second)
</a><a href="#h19-0-83" id="h19-0-83" class="d">-        }
</a><a href="#h19-0-84" id="h19-0-84" class="d">-    }
</a><a href="#h19-0-85" id="h19-0-85" class="d">-
</a><a href="#h19-0-86" id="h19-0-86" class="d">-    fun getCategory(key: String): TranslationWrapper {
</a><a href="#h19-0-87" id="h19-0-87" class="d">-        return TranslationWrapper().apply {
</a><a href="#h19-0-88" id="h19-0-88" class="d">-            translationMap.putAll(
</a><a href="#h19-0-89" id="h19-0-89" class="d">-                this@TranslationWrapper.translationMap
</a><a href="#h19-0-90" id="h19-0-90" class="d">-                    .filterKeys { it.startsWith(&quot;$key.&quot;) }
</a><a href="#h19-0-91" id="h19-0-91" class="d">-                    .mapKeys { it.key.substring(key.length + 1) }
</a><a href="#h19-0-92" id="h19-0-92" class="d">-            )
</a><a href="#h19-0-93" id="h19-0-93" class="d">-        }
</a><a href="#h19-0-94" id="h19-0-94" class="d">-    }
</a><a href="#h19-0-95" id="h19-0-95" class="d">-}</a><a href="#h19-0-96" id="h19-0-96" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h20" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/client/RootBridgeClient.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/client/RootBridgeClient.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/client/RootBridgeClient.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/client/RootBridgeClient.kt</a></b>
<a href="#h20-0" id="h20-0" class="h">@@ -1,155 +0,0 @@
</a><a href="#h20-0-0" id="h20-0-0" class="d">-package me.rhunk.snapenhance.bridge.client
</a><a href="#h20-0-1" id="h20-0-1" class="d">-
</a><a href="#h20-0-2" id="h20-0-2" class="d">-import android.os.Environment
</a><a href="#h20-0-3" id="h20-0-3" class="d">-import me.rhunk.snapenhance.Logger
</a><a href="#h20-0-4" id="h20-0-4" class="d">-import me.rhunk.snapenhance.bridge.AbstractBridgeClient
</a><a href="#h20-0-5" id="h20-0-5" class="d">-import me.rhunk.snapenhance.bridge.MessageLoggerWrapper
</a><a href="#h20-0-6" id="h20-0-6" class="d">-import me.rhunk.snapenhance.bridge.common.impl.file.BridgeFileType
</a><a href="#h20-0-7" id="h20-0-7" class="d">-import me.rhunk.snapenhance.bridge.common.impl.locale.LocaleResult
</a><a href="#h20-0-8" id="h20-0-8" class="d">-import java.io.File
</a><a href="#h20-0-9" id="h20-0-9" class="d">-import java.io.FileInputStream
</a><a href="#h20-0-10" id="h20-0-10" class="d">-import java.io.FileOutputStream
</a><a href="#h20-0-11" id="h20-0-11" class="d">-import java.io.OutputStream
</a><a href="#h20-0-12" id="h20-0-12" class="d">-import java.util.zip.ZipInputStream
</a><a href="#h20-0-13" id="h20-0-13" class="d">-
</a><a href="#h20-0-14" id="h20-0-14" class="d">-class RootBridgeClient : AbstractBridgeClient() {
</a><a href="#h20-0-15" id="h20-0-15" class="d">-    private lateinit var messageLoggerWrapper: MessageLoggerWrapper
</a><a href="#h20-0-16" id="h20-0-16" class="d">-    companion object {
</a><a href="#h20-0-17" id="h20-0-17" class="d">-        private val MOD_FOLDER = File(Environment.getExternalStoragePublicDirectory(Environment.DIRECTORY_DOCUMENTS),&quot;SnapEnhance&quot;)
</a><a href="#h20-0-18" id="h20-0-18" class="d">-    }
</a><a href="#h20-0-19" id="h20-0-19" class="d">-
</a><a href="#h20-0-20" id="h20-0-20" class="d">-    override fun start(callback: (Boolean) -&gt; Unit) {
</a><a href="#h20-0-21" id="h20-0-21" class="d">-        if (!MOD_FOLDER.exists()) {
</a><a href="#h20-0-22" id="h20-0-22" class="d">-            MOD_FOLDER.mkdirs()
</a><a href="#h20-0-23" id="h20-0-23" class="d">-        }
</a><a href="#h20-0-24" id="h20-0-24" class="d">-        messageLoggerWrapper = MessageLoggerWrapper(File(MOD_FOLDER, BridgeFileType.MESSAGE_LOGGER_DATABASE.fileName)).also { it.init() }
</a><a href="#h20-0-25" id="h20-0-25" class="d">-        callback(true)
</a><a href="#h20-0-26" id="h20-0-26" class="d">-    }
</a><a href="#h20-0-27" id="h20-0-27" class="d">-
</a><a href="#h20-0-28" id="h20-0-28" class="d">-    override fun createAndReadFile(fileType: BridgeFileType, defaultContent: ByteArray): ByteArray {
</a><a href="#h20-0-29" id="h20-0-29" class="d">-        val file = File(MOD_FOLDER, fileType.fileName)
</a><a href="#h20-0-30" id="h20-0-30" class="d">-        if (file.exists()) {
</a><a href="#h20-0-31" id="h20-0-31" class="d">-            return readFile(fileType)
</a><a href="#h20-0-32" id="h20-0-32" class="d">-        }
</a><a href="#h20-0-33" id="h20-0-33" class="d">-        val outputStream = openFileWritable(file)
</a><a href="#h20-0-34" id="h20-0-34" class="d">-        outputStream.write(defaultContent)
</a><a href="#h20-0-35" id="h20-0-35" class="d">-        outputStream.close()
</a><a href="#h20-0-36" id="h20-0-36" class="d">-        return defaultContent
</a><a href="#h20-0-37" id="h20-0-37" class="d">-    }
</a><a href="#h20-0-38" id="h20-0-38" class="d">-
</a><a href="#h20-0-39" id="h20-0-39" class="d">-    override fun readFile(fileType: BridgeFileType): ByteArray {
</a><a href="#h20-0-40" id="h20-0-40" class="d">-        return File(MOD_FOLDER, fileType.fileName).readBytes()
</a><a href="#h20-0-41" id="h20-0-41" class="d">-    }
</a><a href="#h20-0-42" id="h20-0-42" class="d">-
</a><a href="#h20-0-43" id="h20-0-43" class="d">-    override fun writeFile(fileType: BridgeFileType, content: ByteArray?): Boolean {
</a><a href="#h20-0-44" id="h20-0-44" class="d">-        val outputStream = openFileWritable(File(MOD_FOLDER, fileType.fileName))
</a><a href="#h20-0-45" id="h20-0-45" class="d">-        outputStream.write(content)
</a><a href="#h20-0-46" id="h20-0-46" class="d">-        outputStream.close()
</a><a href="#h20-0-47" id="h20-0-47" class="d">-        return true
</a><a href="#h20-0-48" id="h20-0-48" class="d">-    }
</a><a href="#h20-0-49" id="h20-0-49" class="d">-
</a><a href="#h20-0-50" id="h20-0-50" class="d">-    override fun deleteFile(fileType: BridgeFileType): Boolean {
</a><a href="#h20-0-51" id="h20-0-51" class="d">-        val file = File(MOD_FOLDER, fileType.fileName)
</a><a href="#h20-0-52" id="h20-0-52" class="d">-        val exists = file.exists()
</a><a href="#h20-0-53" id="h20-0-53" class="d">-        if (exists) {
</a><a href="#h20-0-54" id="h20-0-54" class="d">-            rootOperation(&quot;rm ${file.absolutePath}&quot;)
</a><a href="#h20-0-55" id="h20-0-55" class="d">-        }
</a><a href="#h20-0-56" id="h20-0-56" class="d">-        return exists
</a><a href="#h20-0-57" id="h20-0-57" class="d">-    }
</a><a href="#h20-0-58" id="h20-0-58" class="d">-
</a><a href="#h20-0-59" id="h20-0-59" class="d">-    override fun isFileExists(fileType: BridgeFileType): Boolean {
</a><a href="#h20-0-60" id="h20-0-60" class="d">-        return File(MOD_FOLDER, fileType.fileName).exists()
</a><a href="#h20-0-61" id="h20-0-61" class="d">-    }
</a><a href="#h20-0-62" id="h20-0-62" class="d">-
</a><a href="#h20-0-63" id="h20-0-63" class="d">-    override fun downloadContent(url: String, path: String): Boolean {
</a><a href="#h20-0-64" id="h20-0-64" class="d">-        return true
</a><a href="#h20-0-65" id="h20-0-65" class="d">-    }
</a><a href="#h20-0-66" id="h20-0-66" class="d">-
</a><a href="#h20-0-67" id="h20-0-67" class="d">-    override fun getLoggedMessageIds(conversationId: String, limit: Int): List&lt;Long&gt; {
</a><a href="#h20-0-68" id="h20-0-68" class="d">-        return messageLoggerWrapper.getMessageIds(conversationId, limit)
</a><a href="#h20-0-69" id="h20-0-69" class="d">-    }
</a><a href="#h20-0-70" id="h20-0-70" class="d">-
</a><a href="#h20-0-71" id="h20-0-71" class="d">-    override fun getMessageLoggerMessage(conversationId: String, id: Long): ByteArray? {
</a><a href="#h20-0-72" id="h20-0-72" class="d">-        val (state, messageData) = messageLoggerWrapper.getMessage(conversationId, id)
</a><a href="#h20-0-73" id="h20-0-73" class="d">-        if (state) {
</a><a href="#h20-0-74" id="h20-0-74" class="d">-            return messageData
</a><a href="#h20-0-75" id="h20-0-75" class="d">-        }
</a><a href="#h20-0-76" id="h20-0-76" class="d">-        return null
</a><a href="#h20-0-77" id="h20-0-77" class="d">-    }
</a><a href="#h20-0-78" id="h20-0-78" class="d">-
</a><a href="#h20-0-79" id="h20-0-79" class="d">-    override fun addMessageLoggerMessage(conversationId: String, id: Long, message: ByteArray) {
</a><a href="#h20-0-80" id="h20-0-80" class="d">-        messageLoggerWrapper.addMessage(conversationId, id, message)
</a><a href="#h20-0-81" id="h20-0-81" class="d">-    }
</a><a href="#h20-0-82" id="h20-0-82" class="d">-
</a><a href="#h20-0-83" id="h20-0-83" class="d">-    override fun deleteMessageLoggerMessage(conversationId: String, id: Long) {
</a><a href="#h20-0-84" id="h20-0-84" class="d">-        messageLoggerWrapper.deleteMessage(conversationId, id)
</a><a href="#h20-0-85" id="h20-0-85" class="d">-    }
</a><a href="#h20-0-86" id="h20-0-86" class="d">-
</a><a href="#h20-0-87" id="h20-0-87" class="d">-    override fun clearMessageLogger() {
</a><a href="#h20-0-88" id="h20-0-88" class="d">-        messageLoggerWrapper.clearMessages()
</a><a href="#h20-0-89" id="h20-0-89" class="d">-    }
</a><a href="#h20-0-90" id="h20-0-90" class="d">-
</a><a href="#h20-0-91" id="h20-0-91" class="d">-    override fun fetchTranslations(): LocaleResult {
</a><a href="#h20-0-92" id="h20-0-92" class="d">-        val locale = &quot;en_US&quot;//Locale.getDefault().toString()
</a><a href="#h20-0-93" id="h20-0-93" class="d">-
</a><a href="#h20-0-94" id="h20-0-94" class="d">-        //https://github.com/LSPosed/LSPosed/blob/master/core/src/main/java/org/lsposed/lspd/util/LspModuleClassLoader.java#L36
</a><a href="#h20-0-95" id="h20-0-95" class="d">-        val moduleApk = javaClass.classLoader.javaClass.declaredFields.first { it.type == String::class.java }.let {
</a><a href="#h20-0-96" id="h20-0-96" class="d">-            it.isAccessible = true
</a><a href="#h20-0-97" id="h20-0-97" class="d">-            it.get(javaClass.classLoader) as String
</a><a href="#h20-0-98" id="h20-0-98" class="d">-        }
</a><a href="#h20-0-99" id="h20-0-99" class="d">-
</a><a href="#h20-0-100" id="h20-0-100" class="d">-        val langJsonData: ByteArray? = ZipInputStream(FileInputStream(moduleApk)).let { zip -&gt;
</a><a href="#h20-0-101" id="h20-0-101" class="d">-            while (true) {
</a><a href="#h20-0-102" id="h20-0-102" class="d">-                val entry = zip.nextEntry ?: break
</a><a href="#h20-0-103" id="h20-0-103" class="d">-                if (entry.name == &quot;assets/lang/$locale.json&quot;) {
</a><a href="#h20-0-104" id="h20-0-104" class="d">-                    return@let zip.readBytes()
</a><a href="#h20-0-105" id="h20-0-105" class="d">-                }
</a><a href="#h20-0-106" id="h20-0-106" class="d">-            }
</a><a href="#h20-0-107" id="h20-0-107" class="d">-            return@let null
</a><a href="#h20-0-108" id="h20-0-108" class="d">-        }
</a><a href="#h20-0-109" id="h20-0-109" class="d">-
</a><a href="#h20-0-110" id="h20-0-110" class="d">-        if (langJsonData != null) {
</a><a href="#h20-0-111" id="h20-0-111" class="d">-            Logger.debug(&quot;Fetched translations for $locale&quot;)
</a><a href="#h20-0-112" id="h20-0-112" class="d">-            return LocaleResult(arrayOf(locale), arrayOf(langJsonData.toString(Charsets.UTF_8)))
</a><a href="#h20-0-113" id="h20-0-113" class="d">-        }
</a><a href="#h20-0-114" id="h20-0-114" class="d">-
</a><a href="#h20-0-115" id="h20-0-115" class="d">-        throw Throwable(&quot;Failed to fetch translations for $locale&quot;)
</a><a href="#h20-0-116" id="h20-0-116" class="d">-    }
</a><a href="#h20-0-117" id="h20-0-117" class="d">-
</a><a href="#h20-0-118" id="h20-0-118" class="d">-    override fun getAutoUpdaterTime(): Long {
</a><a href="#h20-0-119" id="h20-0-119" class="d">-        readFile(BridgeFileType.AUTO_UPDATER_TIMESTAMP).run {
</a><a href="#h20-0-120" id="h20-0-120" class="d">-            return if (isEmpty()) {
</a><a href="#h20-0-121" id="h20-0-121" class="d">-                0
</a><a href="#h20-0-122" id="h20-0-122" class="d">-            } else {
</a><a href="#h20-0-123" id="h20-0-123" class="d">-                String(this).toLong()
</a><a href="#h20-0-124" id="h20-0-124" class="d">-            }
</a><a href="#h20-0-125" id="h20-0-125" class="d">-        }
</a><a href="#h20-0-126" id="h20-0-126" class="d">-    }
</a><a href="#h20-0-127" id="h20-0-127" class="d">-
</a><a href="#h20-0-128" id="h20-0-128" class="d">-    override fun setAutoUpdaterTime(time: Long) {
</a><a href="#h20-0-129" id="h20-0-129" class="d">-        writeFile(BridgeFileType.AUTO_UPDATER_TIMESTAMP, time.toString().toByteArray(Charsets.UTF_8))
</a><a href="#h20-0-130" id="h20-0-130" class="d">-    }
</a><a href="#h20-0-131" id="h20-0-131" class="d">-
</a><a href="#h20-0-132" id="h20-0-132" class="d">-    private fun rootOperation(command: String): String {
</a><a href="#h20-0-133" id="h20-0-133" class="d">-        val process = Runtime.getRuntime().exec(&quot;su -c $command&quot;)
</a><a href="#h20-0-134" id="h20-0-134" class="d">-        process.waitFor()
</a><a href="#h20-0-135" id="h20-0-135" class="d">-        process.errorStream?.bufferedReader()?.let {
</a><a href="#h20-0-136" id="h20-0-136" class="d">-            val error = it.readText()
</a><a href="#h20-0-137" id="h20-0-137" class="d">-            if (error.isNotEmpty()) {
</a><a href="#h20-0-138" id="h20-0-138" class="d">-                throw Throwable(&quot;Failed to execute root operation: $error&quot;)
</a><a href="#h20-0-139" id="h20-0-139" class="d">-            }
</a><a href="#h20-0-140" id="h20-0-140" class="d">-        }
</a><a href="#h20-0-141" id="h20-0-141" class="d">-        Logger.debug(&quot;Root operation executed: $command&quot;)
</a><a href="#h20-0-142" id="h20-0-142" class="d">-        return process.inputStream.bufferedReader().readText()
</a><a href="#h20-0-143" id="h20-0-143" class="d">-    }
</a><a href="#h20-0-144" id="h20-0-144" class="d">-
</a><a href="#h20-0-145" id="h20-0-145" class="d">-    private fun openFileWritable(file: File): OutputStream {
</a><a href="#h20-0-146" id="h20-0-146" class="d">-        runCatching {
</a><a href="#h20-0-147" id="h20-0-147" class="d">-            if (!file.exists()) rootOperation(&quot;touch ${file.absolutePath}&quot;)
</a><a href="#h20-0-148" id="h20-0-148" class="d">-        }.onFailure {
</a><a href="#h20-0-149" id="h20-0-149" class="d">-            Logger.error(&quot;Failed to set file permissions: ${it.message}&quot;)
</a><a href="#h20-0-150" id="h20-0-150" class="d">-        }
</a><a href="#h20-0-151" id="h20-0-151" class="d">-
</a><a href="#h20-0-152" id="h20-0-152" class="d">-        return FileOutputStream(file)
</a><a href="#h20-0-153" id="h20-0-153" class="d">-    }
</a><a href="#h20-0-154" id="h20-0-154" class="d">-}</a><a href="#h20-0-155" id="h20-0-155" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h21" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/client/ServiceBridgeClient.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/client/ServiceBridgeClient.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/client/ServiceBridgeClient.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/client/ServiceBridgeClient.kt</a></b>
<a href="#h21-0" id="h21-0" class="h">@@ -1,270 +0,0 @@
</a><a href="#h21-0-0" id="h21-0-0" class="d">-package me.rhunk.snapenhance.bridge.client
</a><a href="#h21-0-1" id="h21-0-1" class="d">-
</a><a href="#h21-0-2" id="h21-0-2" class="d">-
</a><a href="#h21-0-3" id="h21-0-3" class="d">-import android.content.ComponentName
</a><a href="#h21-0-4" id="h21-0-4" class="d">-import android.content.Context
</a><a href="#h21-0-5" id="h21-0-5" class="d">-import android.content.Intent
</a><a href="#h21-0-6" id="h21-0-6" class="d">-import android.content.ServiceConnection
</a><a href="#h21-0-7" id="h21-0-7" class="d">-import android.os.Build
</a><a href="#h21-0-8" id="h21-0-8" class="d">-import android.os.Bundle
</a><a href="#h21-0-9" id="h21-0-9" class="d">-import android.os.Handler
</a><a href="#h21-0-10" id="h21-0-10" class="d">-import android.os.HandlerThread
</a><a href="#h21-0-11" id="h21-0-11" class="d">-import android.os.IBinder
</a><a href="#h21-0-12" id="h21-0-12" class="d">-import android.os.Message
</a><a href="#h21-0-13" id="h21-0-13" class="d">-import android.os.Messenger
</a><a href="#h21-0-14" id="h21-0-14" class="d">-import de.robv.android.xposed.XposedHelpers
</a><a href="#h21-0-15" id="h21-0-15" class="d">-import kotlinx.coroutines.runBlocking
</a><a href="#h21-0-16" id="h21-0-16" class="d">-import kotlinx.coroutines.suspendCancellableCoroutine
</a><a href="#h21-0-17" id="h21-0-17" class="d">-import me.rhunk.snapenhance.BuildConfig
</a><a href="#h21-0-18" id="h21-0-18" class="d">-import me.rhunk.snapenhance.Logger.xposedLog
</a><a href="#h21-0-19" id="h21-0-19" class="d">-import me.rhunk.snapenhance.bridge.AbstractBridgeClient
</a><a href="#h21-0-20" id="h21-0-20" class="d">-import me.rhunk.snapenhance.bridge.common.BridgeMessage
</a><a href="#h21-0-21" id="h21-0-21" class="d">-import me.rhunk.snapenhance.bridge.common.BridgeMessageType
</a><a href="#h21-0-22" id="h21-0-22" class="d">-import me.rhunk.snapenhance.bridge.common.impl.download.DownloadContentRequest
</a><a href="#h21-0-23" id="h21-0-23" class="d">-import me.rhunk.snapenhance.bridge.common.impl.download.DownloadContentResult
</a><a href="#h21-0-24" id="h21-0-24" class="d">-import me.rhunk.snapenhance.bridge.common.impl.file.BridgeFileType
</a><a href="#h21-0-25" id="h21-0-25" class="d">-import me.rhunk.snapenhance.bridge.common.impl.file.FileAccessRequest
</a><a href="#h21-0-26" id="h21-0-26" class="d">-import me.rhunk.snapenhance.bridge.common.impl.file.FileAccessResult
</a><a href="#h21-0-27" id="h21-0-27" class="d">-import me.rhunk.snapenhance.bridge.common.impl.locale.LocaleRequest
</a><a href="#h21-0-28" id="h21-0-28" class="d">-import me.rhunk.snapenhance.bridge.common.impl.locale.LocaleResult
</a><a href="#h21-0-29" id="h21-0-29" class="d">-import me.rhunk.snapenhance.bridge.common.impl.messagelogger.MessageLoggerListResult
</a><a href="#h21-0-30" id="h21-0-30" class="d">-import me.rhunk.snapenhance.bridge.common.impl.messagelogger.MessageLoggerRequest
</a><a href="#h21-0-31" id="h21-0-31" class="d">-import me.rhunk.snapenhance.bridge.common.impl.messagelogger.MessageLoggerResult
</a><a href="#h21-0-32" id="h21-0-32" class="d">-import me.rhunk.snapenhance.bridge.service.BridgeService
</a><a href="#h21-0-33" id="h21-0-33" class="d">-import java.util.concurrent.CompletableFuture
</a><a href="#h21-0-34" id="h21-0-34" class="d">-import java.util.concurrent.Executors
</a><a href="#h21-0-35" id="h21-0-35" class="d">-import kotlin.reflect.KClass
</a><a href="#h21-0-36" id="h21-0-36" class="d">-import kotlin.system.exitProcess
</a><a href="#h21-0-37" id="h21-0-37" class="d">-
</a><a href="#h21-0-38" id="h21-0-38" class="d">-
</a><a href="#h21-0-39" id="h21-0-39" class="d">-class ServiceBridgeClient: AbstractBridgeClient(), ServiceConnection {
</a><a href="#h21-0-40" id="h21-0-40" class="d">-    private val handlerThread = HandlerThread(&quot;BridgeClient&quot;)
</a><a href="#h21-0-41" id="h21-0-41" class="d">-
</a><a href="#h21-0-42" id="h21-0-42" class="d">-    private lateinit var messenger: Messenger
</a><a href="#h21-0-43" id="h21-0-43" class="d">-    private lateinit var future: CompletableFuture&lt;Boolean&gt;
</a><a href="#h21-0-44" id="h21-0-44" class="d">-
</a><a href="#h21-0-45" id="h21-0-45" class="d">-    override fun start(callback: (Boolean) -&gt; Unit) {
</a><a href="#h21-0-46" id="h21-0-46" class="d">-        this.future = CompletableFuture()
</a><a href="#h21-0-47" id="h21-0-47" class="d">-        this.handlerThread.start()
</a><a href="#h21-0-48" id="h21-0-48" class="d">-
</a><a href="#h21-0-49" id="h21-0-49" class="d">-        with(context.androidContext) {
</a><a href="#h21-0-50" id="h21-0-50" class="d">-            val intent = Intent()
</a><a href="#h21-0-51" id="h21-0-51" class="d">-                .setClassName(BuildConfig.APPLICATION_ID, BridgeService::class.java.name)
</a><a href="#h21-0-52" id="h21-0-52" class="d">-            if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.Q) {
</a><a href="#h21-0-53" id="h21-0-53" class="d">-                bindService(
</a><a href="#h21-0-54" id="h21-0-54" class="d">-                    intent,
</a><a href="#h21-0-55" id="h21-0-55" class="d">-                    Context.BIND_AUTO_CREATE,
</a><a href="#h21-0-56" id="h21-0-56" class="d">-                    Executors.newSingleThreadExecutor(),
</a><a href="#h21-0-57" id="h21-0-57" class="d">-                    this@ServiceBridgeClient
</a><a href="#h21-0-58" id="h21-0-58" class="d">-                )
</a><a href="#h21-0-59" id="h21-0-59" class="d">-            } else {
</a><a href="#h21-0-60" id="h21-0-60" class="d">-                XposedHelpers.callMethod(
</a><a href="#h21-0-61" id="h21-0-61" class="d">-                    this,
</a><a href="#h21-0-62" id="h21-0-62" class="d">-                    &quot;bindServiceAsUser&quot;,
</a><a href="#h21-0-63" id="h21-0-63" class="d">-                    intent,
</a><a href="#h21-0-64" id="h21-0-64" class="d">-                    this@ServiceBridgeClient,
</a><a href="#h21-0-65" id="h21-0-65" class="d">-                    Context.BIND_AUTO_CREATE,
</a><a href="#h21-0-66" id="h21-0-66" class="d">-                    Handler(handlerThread.looper),
</a><a href="#h21-0-67" id="h21-0-67" class="d">-                    android.os.Process.myUserHandle()
</a><a href="#h21-0-68" id="h21-0-68" class="d">-                )
</a><a href="#h21-0-69" id="h21-0-69" class="d">-            }
</a><a href="#h21-0-70" id="h21-0-70" class="d">-        }
</a><a href="#h21-0-71" id="h21-0-71" class="d">-        callback(future.get())
</a><a href="#h21-0-72" id="h21-0-72" class="d">-    }
</a><a href="#h21-0-73" id="h21-0-73" class="d">-
</a><a href="#h21-0-74" id="h21-0-74" class="d">-    private fun handleResponseMessage(
</a><a href="#h21-0-75" id="h21-0-75" class="d">-        msg: Message
</a><a href="#h21-0-76" id="h21-0-76" class="d">-    ): BridgeMessage {
</a><a href="#h21-0-77" id="h21-0-77" class="d">-        val message: BridgeMessage = when (BridgeMessageType.fromValue(msg.what)) {
</a><a href="#h21-0-78" id="h21-0-78" class="d">-            BridgeMessageType.FILE_ACCESS_RESULT -&gt; FileAccessResult()
</a><a href="#h21-0-79" id="h21-0-79" class="d">-            BridgeMessageType.DOWNLOAD_CONTENT_RESULT -&gt; DownloadContentResult()
</a><a href="#h21-0-80" id="h21-0-80" class="d">-            BridgeMessageType.MESSAGE_LOGGER_RESULT -&gt; MessageLoggerResult()
</a><a href="#h21-0-81" id="h21-0-81" class="d">-            BridgeMessageType.MESSAGE_LOGGER_LIST_RESULT -&gt; MessageLoggerListResult()
</a><a href="#h21-0-82" id="h21-0-82" class="d">-            BridgeMessageType.LOCALE_RESULT -&gt; LocaleResult()
</a><a href="#h21-0-83" id="h21-0-83" class="d">-            else -&gt; throw IllegalStateException(&quot;Unknown message type: ${msg.what}&quot;)
</a><a href="#h21-0-84" id="h21-0-84" class="d">-        }
</a><a href="#h21-0-85" id="h21-0-85" class="d">-
</a><a href="#h21-0-86" id="h21-0-86" class="d">-        with(message) {
</a><a href="#h21-0-87" id="h21-0-87" class="d">-            read(msg.data)
</a><a href="#h21-0-88" id="h21-0-88" class="d">-            return this
</a><a href="#h21-0-89" id="h21-0-89" class="d">-        }
</a><a href="#h21-0-90" id="h21-0-90" class="d">-    }
</a><a href="#h21-0-91" id="h21-0-91" class="d">-
</a><a href="#h21-0-92" id="h21-0-92" class="d">-    @Suppress(&quot;UNCHECKED_CAST&quot;, &quot;UNUSED_PARAMETER&quot;)
</a><a href="#h21-0-93" id="h21-0-93" class="d">-    private fun &lt;T : BridgeMessage&gt; sendMessage(
</a><a href="#h21-0-94" id="h21-0-94" class="d">-        messageType: BridgeMessageType,
</a><a href="#h21-0-95" id="h21-0-95" class="d">-        bridgeMessage: BridgeMessage,
</a><a href="#h21-0-96" id="h21-0-96" class="d">-        resultType: KClass&lt;T&gt;? = null
</a><a href="#h21-0-97" id="h21-0-97" class="d">-    ) = runBlocking {
</a><a href="#h21-0-98" id="h21-0-98" class="d">-        return@runBlocking suspendCancellableCoroutine&lt;T&gt; { continuation -&gt;
</a><a href="#h21-0-99" id="h21-0-99" class="d">-            with(Message.obtain()) {
</a><a href="#h21-0-100" id="h21-0-100" class="d">-                what = messageType.value
</a><a href="#h21-0-101" id="h21-0-101" class="d">-                replyTo = Messenger(object : Handler(handlerThread.looper) {
</a><a href="#h21-0-102" id="h21-0-102" class="d">-                    override fun handleMessage(msg: Message) {
</a><a href="#h21-0-103" id="h21-0-103" class="d">-                        if (continuation.isCompleted) {
</a><a href="#h21-0-104" id="h21-0-104" class="d">-                            continuation.cancel(Throwable(&quot;Already completed&quot;))
</a><a href="#h21-0-105" id="h21-0-105" class="d">-                            return
</a><a href="#h21-0-106" id="h21-0-106" class="d">-                        }
</a><a href="#h21-0-107" id="h21-0-107" class="d">-                        continuation.resumeWith(Result.success(handleResponseMessage(msg) as T))
</a><a href="#h21-0-108" id="h21-0-108" class="d">-                    }
</a><a href="#h21-0-109" id="h21-0-109" class="d">-                })
</a><a href="#h21-0-110" id="h21-0-110" class="d">-                data = Bundle()
</a><a href="#h21-0-111" id="h21-0-111" class="d">-                bridgeMessage.write(data)
</a><a href="#h21-0-112" id="h21-0-112" class="d">-                messenger.send(this)
</a><a href="#h21-0-113" id="h21-0-113" class="d">-            }
</a><a href="#h21-0-114" id="h21-0-114" class="d">-        }
</a><a href="#h21-0-115" id="h21-0-115" class="d">-    }
</a><a href="#h21-0-116" id="h21-0-116" class="d">-
</a><a href="#h21-0-117" id="h21-0-117" class="d">-    override fun createAndReadFile(
</a><a href="#h21-0-118" id="h21-0-118" class="d">-        fileType: BridgeFileType,
</a><a href="#h21-0-119" id="h21-0-119" class="d">-        defaultContent: ByteArray
</a><a href="#h21-0-120" id="h21-0-120" class="d">-    ): ByteArray {
</a><a href="#h21-0-121" id="h21-0-121" class="d">-        sendMessage(
</a><a href="#h21-0-122" id="h21-0-122" class="d">-            BridgeMessageType.FILE_ACCESS_REQUEST,
</a><a href="#h21-0-123" id="h21-0-123" class="d">-            FileAccessRequest(FileAccessRequest.FileAccessAction.EXISTS, fileType, null),
</a><a href="#h21-0-124" id="h21-0-124" class="d">-            FileAccessResult::class
</a><a href="#h21-0-125" id="h21-0-125" class="d">-        ).run {
</a><a href="#h21-0-126" id="h21-0-126" class="d">-            if (state!!) {
</a><a href="#h21-0-127" id="h21-0-127" class="d">-                return readFile(fileType)
</a><a href="#h21-0-128" id="h21-0-128" class="d">-            }
</a><a href="#h21-0-129" id="h21-0-129" class="d">-            writeFile(fileType, defaultContent)
</a><a href="#h21-0-130" id="h21-0-130" class="d">-            return defaultContent
</a><a href="#h21-0-131" id="h21-0-131" class="d">-        }
</a><a href="#h21-0-132" id="h21-0-132" class="d">-    }
</a><a href="#h21-0-133" id="h21-0-133" class="d">-
</a><a href="#h21-0-134" id="h21-0-134" class="d">-    override fun readFile(fileType: BridgeFileType): ByteArray {
</a><a href="#h21-0-135" id="h21-0-135" class="d">-        sendMessage(
</a><a href="#h21-0-136" id="h21-0-136" class="d">-            BridgeMessageType.FILE_ACCESS_REQUEST,
</a><a href="#h21-0-137" id="h21-0-137" class="d">-            FileAccessRequest(FileAccessRequest.FileAccessAction.READ, fileType, null),
</a><a href="#h21-0-138" id="h21-0-138" class="d">-            FileAccessResult::class
</a><a href="#h21-0-139" id="h21-0-139" class="d">-        ).run {
</a><a href="#h21-0-140" id="h21-0-140" class="d">-            return content!!
</a><a href="#h21-0-141" id="h21-0-141" class="d">-        }
</a><a href="#h21-0-142" id="h21-0-142" class="d">-    }
</a><a href="#h21-0-143" id="h21-0-143" class="d">-
</a><a href="#h21-0-144" id="h21-0-144" class="d">-    override fun writeFile(
</a><a href="#h21-0-145" id="h21-0-145" class="d">-        fileType: BridgeFileType,
</a><a href="#h21-0-146" id="h21-0-146" class="d">-        content: ByteArray?
</a><a href="#h21-0-147" id="h21-0-147" class="d">-    ): Boolean {
</a><a href="#h21-0-148" id="h21-0-148" class="d">-        sendMessage(
</a><a href="#h21-0-149" id="h21-0-149" class="d">-            BridgeMessageType.FILE_ACCESS_REQUEST,
</a><a href="#h21-0-150" id="h21-0-150" class="d">-            FileAccessRequest(FileAccessRequest.FileAccessAction.WRITE, fileType, content),
</a><a href="#h21-0-151" id="h21-0-151" class="d">-            FileAccessResult::class
</a><a href="#h21-0-152" id="h21-0-152" class="d">-        ).run {
</a><a href="#h21-0-153" id="h21-0-153" class="d">-            return state!!
</a><a href="#h21-0-154" id="h21-0-154" class="d">-        }
</a><a href="#h21-0-155" id="h21-0-155" class="d">-    }
</a><a href="#h21-0-156" id="h21-0-156" class="d">-
</a><a href="#h21-0-157" id="h21-0-157" class="d">-    override fun deleteFile(fileType: BridgeFileType): Boolean {
</a><a href="#h21-0-158" id="h21-0-158" class="d">-        sendMessage(
</a><a href="#h21-0-159" id="h21-0-159" class="d">-            BridgeMessageType.FILE_ACCESS_REQUEST,
</a><a href="#h21-0-160" id="h21-0-160" class="d">-            FileAccessRequest(FileAccessRequest.FileAccessAction.DELETE, fileType, null),
</a><a href="#h21-0-161" id="h21-0-161" class="d">-            FileAccessResult::class
</a><a href="#h21-0-162" id="h21-0-162" class="d">-        ).run {
</a><a href="#h21-0-163" id="h21-0-163" class="d">-            return state!!
</a><a href="#h21-0-164" id="h21-0-164" class="d">-        }
</a><a href="#h21-0-165" id="h21-0-165" class="d">-    }
</a><a href="#h21-0-166" id="h21-0-166" class="d">-
</a><a href="#h21-0-167" id="h21-0-167" class="d">-
</a><a href="#h21-0-168" id="h21-0-168" class="d">-    override fun isFileExists(fileType: BridgeFileType): Boolean {
</a><a href="#h21-0-169" id="h21-0-169" class="d">-        sendMessage(
</a><a href="#h21-0-170" id="h21-0-170" class="d">-            BridgeMessageType.FILE_ACCESS_REQUEST,
</a><a href="#h21-0-171" id="h21-0-171" class="d">-            FileAccessRequest(FileAccessRequest.FileAccessAction.EXISTS, fileType, null),
</a><a href="#h21-0-172" id="h21-0-172" class="d">-            FileAccessResult::class
</a><a href="#h21-0-173" id="h21-0-173" class="d">-        ).run {
</a><a href="#h21-0-174" id="h21-0-174" class="d">-            return state!!
</a><a href="#h21-0-175" id="h21-0-175" class="d">-        }
</a><a href="#h21-0-176" id="h21-0-176" class="d">-    }
</a><a href="#h21-0-177" id="h21-0-177" class="d">-
</a><a href="#h21-0-178" id="h21-0-178" class="d">-    override fun downloadContent(url: String, path: String): Boolean {
</a><a href="#h21-0-179" id="h21-0-179" class="d">-        sendMessage(
</a><a href="#h21-0-180" id="h21-0-180" class="d">-            BridgeMessageType.DOWNLOAD_CONTENT_REQUEST,
</a><a href="#h21-0-181" id="h21-0-181" class="d">-            DownloadContentRequest(url, path),
</a><a href="#h21-0-182" id="h21-0-182" class="d">-            DownloadContentResult::class
</a><a href="#h21-0-183" id="h21-0-183" class="d">-        ).run {
</a><a href="#h21-0-184" id="h21-0-184" class="d">-            return state!!
</a><a href="#h21-0-185" id="h21-0-185" class="d">-        }
</a><a href="#h21-0-186" id="h21-0-186" class="d">-    }
</a><a href="#h21-0-187" id="h21-0-187" class="d">-
</a><a href="#h21-0-188" id="h21-0-188" class="d">-    override fun getLoggedMessageIds(conversationId: String, limit: Int): List&lt;Long&gt; {
</a><a href="#h21-0-189" id="h21-0-189" class="d">-        sendMessage(
</a><a href="#h21-0-190" id="h21-0-190" class="d">-            BridgeMessageType.MESSAGE_LOGGER_REQUEST,
</a><a href="#h21-0-191" id="h21-0-191" class="d">-            MessageLoggerRequest(MessageLoggerRequest.Action.LIST_IDS, conversationId, limit.toLong()),
</a><a href="#h21-0-192" id="h21-0-192" class="d">-            MessageLoggerListResult::class
</a><a href="#h21-0-193" id="h21-0-193" class="d">-        ).run {
</a><a href="#h21-0-194" id="h21-0-194" class="d">-            return messages!!
</a><a href="#h21-0-195" id="h21-0-195" class="d">-        }
</a><a href="#h21-0-196" id="h21-0-196" class="d">-    }
</a><a href="#h21-0-197" id="h21-0-197" class="d">-
</a><a href="#h21-0-198" id="h21-0-198" class="d">-    override fun getMessageLoggerMessage(conversationId: String, id: Long): ByteArray? {
</a><a href="#h21-0-199" id="h21-0-199" class="d">-        sendMessage(
</a><a href="#h21-0-200" id="h21-0-200" class="d">-            BridgeMessageType.MESSAGE_LOGGER_REQUEST,
</a><a href="#h21-0-201" id="h21-0-201" class="d">-            MessageLoggerRequest(MessageLoggerRequest.Action.GET, conversationId, id),
</a><a href="#h21-0-202" id="h21-0-202" class="d">-            MessageLoggerResult::class
</a><a href="#h21-0-203" id="h21-0-203" class="d">-        ).run {
</a><a href="#h21-0-204" id="h21-0-204" class="d">-            return message
</a><a href="#h21-0-205" id="h21-0-205" class="d">-        }
</a><a href="#h21-0-206" id="h21-0-206" class="d">-    }
</a><a href="#h21-0-207" id="h21-0-207" class="d">-
</a><a href="#h21-0-208" id="h21-0-208" class="d">-    override fun addMessageLoggerMessage(conversationId: String,id: Long, message: ByteArray) {
</a><a href="#h21-0-209" id="h21-0-209" class="d">-        sendMessage(
</a><a href="#h21-0-210" id="h21-0-210" class="d">-            BridgeMessageType.MESSAGE_LOGGER_REQUEST,
</a><a href="#h21-0-211" id="h21-0-211" class="d">-            MessageLoggerRequest(MessageLoggerRequest.Action.ADD, conversationId, id, message),
</a><a href="#h21-0-212" id="h21-0-212" class="d">-            MessageLoggerResult::class
</a><a href="#h21-0-213" id="h21-0-213" class="d">-        )
</a><a href="#h21-0-214" id="h21-0-214" class="d">-    }
</a><a href="#h21-0-215" id="h21-0-215" class="d">-
</a><a href="#h21-0-216" id="h21-0-216" class="d">-    override fun deleteMessageLoggerMessage(conversationId: String,id: Long) {
</a><a href="#h21-0-217" id="h21-0-217" class="d">-        sendMessage(
</a><a href="#h21-0-218" id="h21-0-218" class="d">-            BridgeMessageType.MESSAGE_LOGGER_REQUEST,
</a><a href="#h21-0-219" id="h21-0-219" class="d">-            MessageLoggerRequest(MessageLoggerRequest.Action.DELETE, conversationId, id),
</a><a href="#h21-0-220" id="h21-0-220" class="d">-            MessageLoggerResult::class
</a><a href="#h21-0-221" id="h21-0-221" class="d">-        )
</a><a href="#h21-0-222" id="h21-0-222" class="d">-    }
</a><a href="#h21-0-223" id="h21-0-223" class="d">-
</a><a href="#h21-0-224" id="h21-0-224" class="d">-    override fun clearMessageLogger() {
</a><a href="#h21-0-225" id="h21-0-225" class="d">-        sendMessage(
</a><a href="#h21-0-226" id="h21-0-226" class="d">-            BridgeMessageType.MESSAGE_LOGGER_REQUEST,
</a><a href="#h21-0-227" id="h21-0-227" class="d">-            MessageLoggerRequest(MessageLoggerRequest.Action.CLEAR),
</a><a href="#h21-0-228" id="h21-0-228" class="d">-            MessageLoggerResult::class
</a><a href="#h21-0-229" id="h21-0-229" class="d">-        )
</a><a href="#h21-0-230" id="h21-0-230" class="d">-    }
</a><a href="#h21-0-231" id="h21-0-231" class="d">-
</a><a href="#h21-0-232" id="h21-0-232" class="d">-    override fun fetchTranslations(): LocaleResult {
</a><a href="#h21-0-233" id="h21-0-233" class="d">-        sendMessage(
</a><a href="#h21-0-234" id="h21-0-234" class="d">-            BridgeMessageType.LOCALE_REQUEST,
</a><a href="#h21-0-235" id="h21-0-235" class="d">-            LocaleRequest(),
</a><a href="#h21-0-236" id="h21-0-236" class="d">-            LocaleResult::class
</a><a href="#h21-0-237" id="h21-0-237" class="d">-        ).run {
</a><a href="#h21-0-238" id="h21-0-238" class="d">-            return this
</a><a href="#h21-0-239" id="h21-0-239" class="d">-        }
</a><a href="#h21-0-240" id="h21-0-240" class="d">-    }
</a><a href="#h21-0-241" id="h21-0-241" class="d">-
</a><a href="#h21-0-242" id="h21-0-242" class="d">-    override fun getAutoUpdaterTime(): Long {
</a><a href="#h21-0-243" id="h21-0-243" class="d">-        createAndReadFile(BridgeFileType.AUTO_UPDATER_TIMESTAMP, &quot;0&quot;.toByteArray()).run {
</a><a href="#h21-0-244" id="h21-0-244" class="d">-            return if (isEmpty()) {
</a><a href="#h21-0-245" id="h21-0-245" class="d">-                0
</a><a href="#h21-0-246" id="h21-0-246" class="d">-            } else {
</a><a href="#h21-0-247" id="h21-0-247" class="d">-                String(this).toLong()
</a><a href="#h21-0-248" id="h21-0-248" class="d">-            }
</a><a href="#h21-0-249" id="h21-0-249" class="d">-        }
</a><a href="#h21-0-250" id="h21-0-250" class="d">-    }
</a><a href="#h21-0-251" id="h21-0-251" class="d">-
</a><a href="#h21-0-252" id="h21-0-252" class="d">-    override fun setAutoUpdaterTime(time: Long) {
</a><a href="#h21-0-253" id="h21-0-253" class="d">-        writeFile(BridgeFileType.AUTO_UPDATER_TIMESTAMP, time.toString().toByteArray())
</a><a href="#h21-0-254" id="h21-0-254" class="d">-    }
</a><a href="#h21-0-255" id="h21-0-255" class="d">-
</a><a href="#h21-0-256" id="h21-0-256" class="d">-    override fun onServiceConnected(name: ComponentName, service: IBinder) {
</a><a href="#h21-0-257" id="h21-0-257" class="d">-        messenger = Messenger(service)
</a><a href="#h21-0-258" id="h21-0-258" class="d">-        future.complete(true)
</a><a href="#h21-0-259" id="h21-0-259" class="d">-    }
</a><a href="#h21-0-260" id="h21-0-260" class="d">-
</a><a href="#h21-0-261" id="h21-0-261" class="d">-    override fun onNullBinding(name: ComponentName) {
</a><a href="#h21-0-262" id="h21-0-262" class="d">-        xposedLog(&quot;failed to connect to bridge service&quot;)
</a><a href="#h21-0-263" id="h21-0-263" class="d">-        future.complete(false)
</a><a href="#h21-0-264" id="h21-0-264" class="d">-    }
</a><a href="#h21-0-265" id="h21-0-265" class="d">-
</a><a href="#h21-0-266" id="h21-0-266" class="d">-    override fun onServiceDisconnected(name: ComponentName) {
</a><a href="#h21-0-267" id="h21-0-267" class="d">-        exitProcess(0)
</a><a href="#h21-0-268" id="h21-0-268" class="d">-    }
</a><a href="#h21-0-269" id="h21-0-269" class="d">-}
</a><b>diff --git a/<a id="h22" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/BridgeMessage.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/BridgeMessage.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/BridgeMessage.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/BridgeMessage.kt</a></b>
<a href="#h22-0" id="h22-0" class="h">@@ -1,16 +0,0 @@
</a><a href="#h22-0-0" id="h22-0-0" class="d">-package me.rhunk.snapenhance.bridge.common
</a><a href="#h22-0-1" id="h22-0-1" class="d">-
</a><a href="#h22-0-2" id="h22-0-2" class="d">-import android.os.Bundle
</a><a href="#h22-0-3" id="h22-0-3" class="d">-import android.os.Message
</a><a href="#h22-0-4" id="h22-0-4" class="d">-
</a><a href="#h22-0-5" id="h22-0-5" class="d">-abstract class BridgeMessage {
</a><a href="#h22-0-6" id="h22-0-6" class="d">-    abstract fun write(bundle: Bundle)
</a><a href="#h22-0-7" id="h22-0-7" class="d">-    abstract fun read(bundle: Bundle)
</a><a href="#h22-0-8" id="h22-0-8" class="d">-
</a><a href="#h22-0-9" id="h22-0-9" class="d">-    fun toMessage(what: Int): Message {
</a><a href="#h22-0-10" id="h22-0-10" class="d">-        val message = Message.obtain(null, what)
</a><a href="#h22-0-11" id="h22-0-11" class="d">-        message.data = Bundle()
</a><a href="#h22-0-12" id="h22-0-12" class="d">-        write(message.data)
</a><a href="#h22-0-13" id="h22-0-13" class="d">-        return message
</a><a href="#h22-0-14" id="h22-0-14" class="d">-    }
</a><a href="#h22-0-15" id="h22-0-15" class="d">-}
</a><b>diff --git a/<a id="h23" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/BridgeMessageType.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/BridgeMessageType.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/BridgeMessageType.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/BridgeMessageType.kt</a></b>
<a href="#h23-0" id="h23-0" class="h">@@ -1,23 +0,0 @@
</a><a href="#h23-0-0" id="h23-0-0" class="d">-package me.rhunk.snapenhance.bridge.common
</a><a href="#h23-0-1" id="h23-0-1" class="d">-
</a><a href="#h23-0-2" id="h23-0-2" class="d">-
</a><a href="#h23-0-3" id="h23-0-3" class="d">-enum class BridgeMessageType(
</a><a href="#h23-0-4" id="h23-0-4" class="d">-    val value: Int = 0
</a><a href="#h23-0-5" id="h23-0-5" class="d">-) {
</a><a href="#h23-0-6" id="h23-0-6" class="d">-    UNKNOWN(-1),
</a><a href="#h23-0-7" id="h23-0-7" class="d">-    FILE_ACCESS_REQUEST(0),
</a><a href="#h23-0-8" id="h23-0-8" class="d">-    FILE_ACCESS_RESULT(1),
</a><a href="#h23-0-9" id="h23-0-9" class="d">-    DOWNLOAD_CONTENT_REQUEST(2),
</a><a href="#h23-0-10" id="h23-0-10" class="d">-    DOWNLOAD_CONTENT_RESULT(3),
</a><a href="#h23-0-11" id="h23-0-11" class="d">-    LOCALE_REQUEST(4),
</a><a href="#h23-0-12" id="h23-0-12" class="d">-    LOCALE_RESULT(5),
</a><a href="#h23-0-13" id="h23-0-13" class="d">-    MESSAGE_LOGGER_REQUEST(6),
</a><a href="#h23-0-14" id="h23-0-14" class="d">-    MESSAGE_LOGGER_RESULT(7),
</a><a href="#h23-0-15" id="h23-0-15" class="d">-    MESSAGE_LOGGER_LIST_RESULT(8);
</a><a href="#h23-0-16" id="h23-0-16" class="d">-
</a><a href="#h23-0-17" id="h23-0-17" class="d">-    companion object {
</a><a href="#h23-0-18" id="h23-0-18" class="d">-        fun fromValue(value: Int): BridgeMessageType {
</a><a href="#h23-0-19" id="h23-0-19" class="d">-            return values().firstOrNull { it.value == value } ?: UNKNOWN
</a><a href="#h23-0-20" id="h23-0-20" class="d">-        }
</a><a href="#h23-0-21" id="h23-0-21" class="d">-    }
</a><a href="#h23-0-22" id="h23-0-22" class="d">-}
</a><b>diff --git a/<a id="h24" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/impl/download/DownloadContentRequest.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/impl/download/DownloadContentRequest.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/impl/download/DownloadContentRequest.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/impl/download/DownloadContentRequest.kt</a></b>
<a href="#h24-0" id="h24-0" class="h">@@ -1,20 +0,0 @@
</a><a href="#h24-0-0" id="h24-0-0" class="d">-package me.rhunk.snapenhance.bridge.common.impl.download
</a><a href="#h24-0-1" id="h24-0-1" class="d">-
</a><a href="#h24-0-2" id="h24-0-2" class="d">-import android.os.Bundle
</a><a href="#h24-0-3" id="h24-0-3" class="d">-import me.rhunk.snapenhance.bridge.common.BridgeMessage
</a><a href="#h24-0-4" id="h24-0-4" class="d">-
</a><a href="#h24-0-5" id="h24-0-5" class="d">-class DownloadContentRequest(
</a><a href="#h24-0-6" id="h24-0-6" class="d">-    var url: String? = null,
</a><a href="#h24-0-7" id="h24-0-7" class="d">-    var path: String? = null
</a><a href="#h24-0-8" id="h24-0-8" class="d">-) : BridgeMessage() {
</a><a href="#h24-0-9" id="h24-0-9" class="d">-
</a><a href="#h24-0-10" id="h24-0-10" class="d">-    override fun write(bundle: Bundle) {
</a><a href="#h24-0-11" id="h24-0-11" class="d">-        bundle.putString(&quot;url&quot;, url)
</a><a href="#h24-0-12" id="h24-0-12" class="d">-        bundle.putString(&quot;path&quot;, path)
</a><a href="#h24-0-13" id="h24-0-13" class="d">-    }
</a><a href="#h24-0-14" id="h24-0-14" class="d">-
</a><a href="#h24-0-15" id="h24-0-15" class="d">-    override fun read(bundle: Bundle) {
</a><a href="#h24-0-16" id="h24-0-16" class="d">-        url = bundle.getString(&quot;url&quot;)
</a><a href="#h24-0-17" id="h24-0-17" class="d">-        path = bundle.getString(&quot;path&quot;)
</a><a href="#h24-0-18" id="h24-0-18" class="d">-    }
</a><a href="#h24-0-19" id="h24-0-19" class="d">-}
</a><b>diff --git a/<a id="h25" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/impl/download/DownloadContentResult.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/impl/download/DownloadContentResult.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/impl/download/DownloadContentResult.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/impl/download/DownloadContentResult.kt</a></b>
<a href="#h25-0" id="h25-0" class="h">@@ -1,17 +0,0 @@
</a><a href="#h25-0-0" id="h25-0-0" class="d">-package me.rhunk.snapenhance.bridge.common.impl.download
</a><a href="#h25-0-1" id="h25-0-1" class="d">-
</a><a href="#h25-0-2" id="h25-0-2" class="d">-import android.os.Bundle
</a><a href="#h25-0-3" id="h25-0-3" class="d">-import me.rhunk.snapenhance.bridge.common.BridgeMessage
</a><a href="#h25-0-4" id="h25-0-4" class="d">-
</a><a href="#h25-0-5" id="h25-0-5" class="d">-class DownloadContentResult(
</a><a href="#h25-0-6" id="h25-0-6" class="d">-    var state: Boolean? = null
</a><a href="#h25-0-7" id="h25-0-7" class="d">-) : BridgeMessage() {
</a><a href="#h25-0-8" id="h25-0-8" class="d">-
</a><a href="#h25-0-9" id="h25-0-9" class="d">-    override fun write(bundle: Bundle) {
</a><a href="#h25-0-10" id="h25-0-10" class="d">-        bundle.putBoolean(&quot;state&quot;, state!!)
</a><a href="#h25-0-11" id="h25-0-11" class="d">-    }
</a><a href="#h25-0-12" id="h25-0-12" class="d">-
</a><a href="#h25-0-13" id="h25-0-13" class="d">-    override fun read(bundle: Bundle) {
</a><a href="#h25-0-14" id="h25-0-14" class="d">-        state = bundle.getBoolean(&quot;state&quot;)
</a><a href="#h25-0-15" id="h25-0-15" class="d">-    }
</a><a href="#h25-0-16" id="h25-0-16" class="d">-}
</a><b>diff --git a/<a id="h26" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/impl/file/BridgeFileType.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/impl/file/BridgeFileType.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/impl/file/BridgeFileType.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/impl/file/BridgeFileType.kt</a></b>
<a href="#h26-0" id="h26-0" class="h">@@ -1,28 +0,0 @@
</a><a href="#h26-0-0" id="h26-0-0" class="d">-package me.rhunk.snapenhance.bridge.common.impl.file
</a><a href="#h26-0-1" id="h26-0-1" class="d">-
</a><a href="#h26-0-2" id="h26-0-2" class="d">-import android.content.Context
</a><a href="#h26-0-3" id="h26-0-3" class="d">-import java.io.File
</a><a href="#h26-0-4" id="h26-0-4" class="d">-
</a><a href="#h26-0-5" id="h26-0-5" class="d">-
</a><a href="#h26-0-6" id="h26-0-6" class="d">-enum class BridgeFileType(val value: Int, val fileName: String, val displayName: String, val isDatabase: Boolean = false) {
</a><a href="#h26-0-7" id="h26-0-7" class="d">-    CONFIG(0, &quot;config.json&quot;, &quot;Config&quot;),
</a><a href="#h26-0-8" id="h26-0-8" class="d">-    MAPPINGS(1, &quot;mappings.json&quot;, &quot;Mappings&quot;),
</a><a href="#h26-0-9" id="h26-0-9" class="d">-    MESSAGE_LOGGER_DATABASE(2, &quot;message_logger.db&quot;, &quot;Message Logger&quot;,true),
</a><a href="#h26-0-10" id="h26-0-10" class="d">-    STEALTH(3, &quot;stealth.txt&quot;, &quot;Stealth Conversations&quot;),
</a><a href="#h26-0-11" id="h26-0-11" class="d">-    ANTI_AUTO_DOWNLOAD(4, &quot;anti_auto_download.txt&quot;, &quot;Anti Auto Download&quot;),
</a><a href="#h26-0-12" id="h26-0-12" class="d">-    ANTI_AUTO_SAVE(5, &quot;anti_auto_save.txt&quot;, &quot;Anti Auto Save&quot;),
</a><a href="#h26-0-13" id="h26-0-13" class="d">-    AUTO_UPDATER_TIMESTAMP(6, &quot;auto_updater_timestamp.txt&quot;, &quot;Auto Updater Timestamp&quot;),
</a><a href="#h26-0-14" id="h26-0-14" class="d">-    PINNED_CONVERSATIONS(7, &quot;pinned_conversations.txt&quot;, &quot;Pinned Conversations&quot;);
</a><a href="#h26-0-15" id="h26-0-15" class="d">-
</a><a href="#h26-0-16" id="h26-0-16" class="d">-    fun resolve(context: Context): File = if (isDatabase) {
</a><a href="#h26-0-17" id="h26-0-17" class="d">-        context.getDatabasePath(fileName)
</a><a href="#h26-0-18" id="h26-0-18" class="d">-    } else {
</a><a href="#h26-0-19" id="h26-0-19" class="d">-        File(context.filesDir, fileName)
</a><a href="#h26-0-20" id="h26-0-20" class="d">-    }
</a><a href="#h26-0-21" id="h26-0-21" class="d">-
</a><a href="#h26-0-22" id="h26-0-22" class="d">-    companion object {
</a><a href="#h26-0-23" id="h26-0-23" class="d">-        fun fromValue(value: Int): BridgeFileType? {
</a><a href="#h26-0-24" id="h26-0-24" class="d">-            return values().firstOrNull { it.value == value }
</a><a href="#h26-0-25" id="h26-0-25" class="d">-        }
</a><a href="#h26-0-26" id="h26-0-26" class="d">-    }
</a><a href="#h26-0-27" id="h26-0-27" class="d">-}</a><a href="#h26-0-28" id="h26-0-28" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h27" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/impl/file/FileAccessRequest.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/impl/file/FileAccessRequest.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/impl/file/FileAccessRequest.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/impl/file/FileAccessRequest.kt</a></b>
<a href="#h27-0" id="h27-0" class="h">@@ -1,33 +0,0 @@
</a><a href="#h27-0-0" id="h27-0-0" class="d">-package me.rhunk.snapenhance.bridge.common.impl.file
</a><a href="#h27-0-1" id="h27-0-1" class="d">-
</a><a href="#h27-0-2" id="h27-0-2" class="d">-import android.os.Bundle
</a><a href="#h27-0-3" id="h27-0-3" class="d">-import me.rhunk.snapenhance.bridge.common.BridgeMessage
</a><a href="#h27-0-4" id="h27-0-4" class="d">-
</a><a href="#h27-0-5" id="h27-0-5" class="d">-class FileAccessRequest(
</a><a href="#h27-0-6" id="h27-0-6" class="d">-    var action: FileAccessAction? = null,
</a><a href="#h27-0-7" id="h27-0-7" class="d">-    var fileType: BridgeFileType? = null,
</a><a href="#h27-0-8" id="h27-0-8" class="d">-    var content: ByteArray? = null
</a><a href="#h27-0-9" id="h27-0-9" class="d">-) : BridgeMessage() {
</a><a href="#h27-0-10" id="h27-0-10" class="d">-
</a><a href="#h27-0-11" id="h27-0-11" class="d">-    override fun write(bundle: Bundle) {
</a><a href="#h27-0-12" id="h27-0-12" class="d">-        bundle.putInt(&quot;action&quot;, action!!.value)
</a><a href="#h27-0-13" id="h27-0-13" class="d">-        bundle.putInt(&quot;fileType&quot;, fileType!!.value)
</a><a href="#h27-0-14" id="h27-0-14" class="d">-        bundle.putByteArray(&quot;content&quot;, content)
</a><a href="#h27-0-15" id="h27-0-15" class="d">-    }
</a><a href="#h27-0-16" id="h27-0-16" class="d">-
</a><a href="#h27-0-17" id="h27-0-17" class="d">-    override fun read(bundle: Bundle) {
</a><a href="#h27-0-18" id="h27-0-18" class="d">-        action = FileAccessAction.fromValue(bundle.getInt(&quot;action&quot;))
</a><a href="#h27-0-19" id="h27-0-19" class="d">-        fileType = BridgeFileType.fromValue(bundle.getInt(&quot;fileType&quot;))
</a><a href="#h27-0-20" id="h27-0-20" class="d">-        content = bundle.getByteArray(&quot;content&quot;)
</a><a href="#h27-0-21" id="h27-0-21" class="d">-    }
</a><a href="#h27-0-22" id="h27-0-22" class="d">-
</a><a href="#h27-0-23" id="h27-0-23" class="d">-    enum class FileAccessAction(val value: Int) {
</a><a href="#h27-0-24" id="h27-0-24" class="d">-        READ(0), WRITE(1), DELETE(2), EXISTS(3);
</a><a href="#h27-0-25" id="h27-0-25" class="d">-
</a><a href="#h27-0-26" id="h27-0-26" class="d">-        companion object {
</a><a href="#h27-0-27" id="h27-0-27" class="d">-            fun fromValue(value: Int): FileAccessAction? {
</a><a href="#h27-0-28" id="h27-0-28" class="d">-                return values().firstOrNull { it.value == value }
</a><a href="#h27-0-29" id="h27-0-29" class="d">-            }
</a><a href="#h27-0-30" id="h27-0-30" class="d">-        }
</a><a href="#h27-0-31" id="h27-0-31" class="d">-    }
</a><a href="#h27-0-32" id="h27-0-32" class="d">-}
</a><b>diff --git a/<a id="h28" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/impl/file/FileAccessResult.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/impl/file/FileAccessResult.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/impl/file/FileAccessResult.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/impl/file/FileAccessResult.kt</a></b>
<a href="#h28-0" id="h28-0" class="h">@@ -1,20 +0,0 @@
</a><a href="#h28-0-0" id="h28-0-0" class="d">-package me.rhunk.snapenhance.bridge.common.impl.file
</a><a href="#h28-0-1" id="h28-0-1" class="d">-
</a><a href="#h28-0-2" id="h28-0-2" class="d">-import android.os.Bundle
</a><a href="#h28-0-3" id="h28-0-3" class="d">-import me.rhunk.snapenhance.bridge.common.BridgeMessage
</a><a href="#h28-0-4" id="h28-0-4" class="d">-
</a><a href="#h28-0-5" id="h28-0-5" class="d">-class FileAccessResult(
</a><a href="#h28-0-6" id="h28-0-6" class="d">-    var state: Boolean? = null,
</a><a href="#h28-0-7" id="h28-0-7" class="d">-    var content: ByteArray? = null
</a><a href="#h28-0-8" id="h28-0-8" class="d">-) : BridgeMessage() {
</a><a href="#h28-0-9" id="h28-0-9" class="d">-
</a><a href="#h28-0-10" id="h28-0-10" class="d">-    override fun write(bundle: Bundle) {
</a><a href="#h28-0-11" id="h28-0-11" class="d">-        bundle.putBoolean(&quot;state&quot;, state!!)
</a><a href="#h28-0-12" id="h28-0-12" class="d">-        bundle.putByteArray(&quot;content&quot;, content)
</a><a href="#h28-0-13" id="h28-0-13" class="d">-    }
</a><a href="#h28-0-14" id="h28-0-14" class="d">-
</a><a href="#h28-0-15" id="h28-0-15" class="d">-    override fun read(bundle: Bundle) {
</a><a href="#h28-0-16" id="h28-0-16" class="d">-        state = bundle.getBoolean(&quot;state&quot;)
</a><a href="#h28-0-17" id="h28-0-17" class="d">-        content = bundle.getByteArray(&quot;content&quot;)
</a><a href="#h28-0-18" id="h28-0-18" class="d">-    }
</a><a href="#h28-0-19" id="h28-0-19" class="d">-}
</a><b>diff --git a/<a id="h29" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/impl/locale/LocaleRequest.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/impl/locale/LocaleRequest.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/impl/locale/LocaleRequest.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/impl/locale/LocaleRequest.kt</a></b>
<a href="#h29-0" id="h29-0" class="h">@@ -1,12 +0,0 @@
</a><a href="#h29-0-0" id="h29-0-0" class="d">-package me.rhunk.snapenhance.bridge.common.impl.locale
</a><a href="#h29-0-1" id="h29-0-1" class="d">-
</a><a href="#h29-0-2" id="h29-0-2" class="d">-import android.os.Bundle
</a><a href="#h29-0-3" id="h29-0-3" class="d">-import me.rhunk.snapenhance.bridge.common.BridgeMessage
</a><a href="#h29-0-4" id="h29-0-4" class="d">-
</a><a href="#h29-0-5" id="h29-0-5" class="d">-class LocaleRequest() : BridgeMessage() {
</a><a href="#h29-0-6" id="h29-0-6" class="d">-    override fun write(bundle: Bundle) {
</a><a href="#h29-0-7" id="h29-0-7" class="d">-    }
</a><a href="#h29-0-8" id="h29-0-8" class="d">-
</a><a href="#h29-0-9" id="h29-0-9" class="d">-    override fun read(bundle: Bundle) {
</a><a href="#h29-0-10" id="h29-0-10" class="d">-    }
</a><a href="#h29-0-11" id="h29-0-11" class="d">-}</a><a href="#h29-0-12" id="h29-0-12" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h30" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/impl/locale/LocaleResult.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/impl/locale/LocaleResult.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/impl/locale/LocaleResult.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/impl/locale/LocaleResult.kt</a></b>
<a href="#h30-0" id="h30-0" class="h">@@ -1,31 +0,0 @@
</a><a href="#h30-0-0" id="h30-0-0" class="d">-package me.rhunk.snapenhance.bridge.common.impl.locale
</a><a href="#h30-0-1" id="h30-0-1" class="d">-
</a><a href="#h30-0-2" id="h30-0-2" class="d">-import android.os.Bundle
</a><a href="#h30-0-3" id="h30-0-3" class="d">-import me.rhunk.snapenhance.bridge.common.BridgeMessage
</a><a href="#h30-0-4" id="h30-0-4" class="d">-import me.rhunk.snapenhance.data.LocalePair
</a><a href="#h30-0-5" id="h30-0-5" class="d">-
</a><a href="#h30-0-6" id="h30-0-6" class="d">-class LocaleResult(
</a><a href="#h30-0-7" id="h30-0-7" class="d">-    private var locales: Array&lt;String&gt;? = null,
</a><a href="#h30-0-8" id="h30-0-8" class="d">-    private var localContentArray: Array&lt;String&gt;? = null
</a><a href="#h30-0-9" id="h30-0-9" class="d">-) : BridgeMessage(){
</a><a href="#h30-0-10" id="h30-0-10" class="d">-
</a><a href="#h30-0-11" id="h30-0-11" class="d">-    fun getLocales(): List&lt;LocalePair&gt; {
</a><a href="#h30-0-12" id="h30-0-12" class="d">-        val locales = locales ?: return emptyList()
</a><a href="#h30-0-13" id="h30-0-13" class="d">-        val localContentArray = localContentArray ?: return emptyList()
</a><a href="#h30-0-14" id="h30-0-14" class="d">-        return locales.mapIndexed { index, locale -&gt;
</a><a href="#h30-0-15" id="h30-0-15" class="d">-            LocalePair(locale, localContentArray[index])
</a><a href="#h30-0-16" id="h30-0-16" class="d">-        }.asReversed()
</a><a href="#h30-0-17" id="h30-0-17" class="d">-    }
</a><a href="#h30-0-18" id="h30-0-18" class="d">-
</a><a href="#h30-0-19" id="h30-0-19" class="d">-
</a><a href="#h30-0-20" id="h30-0-20" class="d">-    override fun write(bundle: Bundle) {
</a><a href="#h30-0-21" id="h30-0-21" class="d">-        bundle.putStringArray(&quot;locales&quot;, locales)
</a><a href="#h30-0-22" id="h30-0-22" class="d">-        bundle.putSerializable(&quot;localContentArray&quot;, localContentArray)
</a><a href="#h30-0-23" id="h30-0-23" class="d">-    }
</a><a href="#h30-0-24" id="h30-0-24" class="d">-
</a><a href="#h30-0-25" id="h30-0-25" class="d">-    @Suppress(&quot;UNCHECKED_CAST&quot;, &quot;DEPRECATION&quot;)
</a><a href="#h30-0-26" id="h30-0-26" class="d">-    override fun read(bundle: Bundle) {
</a><a href="#h30-0-27" id="h30-0-27" class="d">-        locales = bundle.getStringArray(&quot;locales&quot;)
</a><a href="#h30-0-28" id="h30-0-28" class="d">-        localContentArray = bundle.getSerializable(&quot;localContentArray&quot;) as? Array&lt;String&gt;
</a><a href="#h30-0-29" id="h30-0-29" class="d">-    }
</a><a href="#h30-0-30" id="h30-0-30" class="d">-}</a><a href="#h30-0-31" id="h30-0-31" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h31" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/impl/messagelogger/MessageLoggerListResult.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/impl/messagelogger/MessageLoggerListResult.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/impl/messagelogger/MessageLoggerListResult.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/impl/messagelogger/MessageLoggerListResult.kt</a></b>
<a href="#h31-0" id="h31-0" class="h">@@ -1,18 +0,0 @@
</a><a href="#h31-0-0" id="h31-0-0" class="d">-package me.rhunk.snapenhance.bridge.common.impl.messagelogger
</a><a href="#h31-0-1" id="h31-0-1" class="d">-
</a><a href="#h31-0-2" id="h31-0-2" class="d">-import android.os.Bundle
</a><a href="#h31-0-3" id="h31-0-3" class="d">-import me.rhunk.snapenhance.bridge.common.BridgeMessage
</a><a href="#h31-0-4" id="h31-0-4" class="d">-
</a><a href="#h31-0-5" id="h31-0-5" class="d">-
</a><a href="#h31-0-6" id="h31-0-6" class="d">-class MessageLoggerListResult(
</a><a href="#h31-0-7" id="h31-0-7" class="d">-    var messages: List&lt;Long&gt;? = null
</a><a href="#h31-0-8" id="h31-0-8" class="d">-) : BridgeMessage() {
</a><a href="#h31-0-9" id="h31-0-9" class="d">-
</a><a href="#h31-0-10" id="h31-0-10" class="d">-    override fun write(bundle: Bundle) {
</a><a href="#h31-0-11" id="h31-0-11" class="d">-        bundle.putLongArray(&quot;messages&quot;, messages!!.map { it }.toLongArray())
</a><a href="#h31-0-12" id="h31-0-12" class="d">-    }
</a><a href="#h31-0-13" id="h31-0-13" class="d">-
</a><a href="#h31-0-14" id="h31-0-14" class="d">-    override fun read(bundle: Bundle) {
</a><a href="#h31-0-15" id="h31-0-15" class="d">-        messages = bundle.getLongArray(&quot;messages&quot;)?.toList() ?: emptyList()
</a><a href="#h31-0-16" id="h31-0-16" class="d">-    }
</a><a href="#h31-0-17" id="h31-0-17" class="d">-}</a><a href="#h31-0-18" id="h31-0-18" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h32" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/impl/messagelogger/MessageLoggerRequest.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/impl/messagelogger/MessageLoggerRequest.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/impl/messagelogger/MessageLoggerRequest.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/impl/messagelogger/MessageLoggerRequest.kt</a></b>
<a href="#h32-0" id="h32-0" class="h">@@ -1,34 +0,0 @@
</a><a href="#h32-0-0" id="h32-0-0" class="d">-package me.rhunk.snapenhance.bridge.common.impl.messagelogger
</a><a href="#h32-0-1" id="h32-0-1" class="d">-
</a><a href="#h32-0-2" id="h32-0-2" class="d">-import android.os.Bundle
</a><a href="#h32-0-3" id="h32-0-3" class="d">-import me.rhunk.snapenhance.bridge.common.BridgeMessage
</a><a href="#h32-0-4" id="h32-0-4" class="d">-
</a><a href="#h32-0-5" id="h32-0-5" class="d">-class MessageLoggerRequest(
</a><a href="#h32-0-6" id="h32-0-6" class="d">-    var action: Action? = null,
</a><a href="#h32-0-7" id="h32-0-7" class="d">-    var conversationId: String? = null,
</a><a href="#h32-0-8" id="h32-0-8" class="d">-    var index: Long? = null,
</a><a href="#h32-0-9" id="h32-0-9" class="d">-    var message: ByteArray? = null
</a><a href="#h32-0-10" id="h32-0-10" class="d">-) : BridgeMessage(){
</a><a href="#h32-0-11" id="h32-0-11" class="d">-
</a><a href="#h32-0-12" id="h32-0-12" class="d">-    override fun write(bundle: Bundle) {
</a><a href="#h32-0-13" id="h32-0-13" class="d">-        bundle.putString(&quot;action&quot;, action!!.name)
</a><a href="#h32-0-14" id="h32-0-14" class="d">-        bundle.putString(&quot;conversationId&quot;, conversationId)
</a><a href="#h32-0-15" id="h32-0-15" class="d">-        bundle.putLong(&quot;messageId&quot;, index ?: 0)
</a><a href="#h32-0-16" id="h32-0-16" class="d">-        bundle.putByteArray(&quot;message&quot;, message)
</a><a href="#h32-0-17" id="h32-0-17" class="d">-    }
</a><a href="#h32-0-18" id="h32-0-18" class="d">-
</a><a href="#h32-0-19" id="h32-0-19" class="d">-    override fun read(bundle: Bundle) {
</a><a href="#h32-0-20" id="h32-0-20" class="d">-        action = Action.valueOf(bundle.getString(&quot;action&quot;)!!)
</a><a href="#h32-0-21" id="h32-0-21" class="d">-        conversationId = bundle.getString(&quot;conversationId&quot;)
</a><a href="#h32-0-22" id="h32-0-22" class="d">-        index = bundle.getLong(&quot;messageId&quot;)
</a><a href="#h32-0-23" id="h32-0-23" class="d">-        message = bundle.getByteArray(&quot;message&quot;)
</a><a href="#h32-0-24" id="h32-0-24" class="d">-    }
</a><a href="#h32-0-25" id="h32-0-25" class="d">-
</a><a href="#h32-0-26" id="h32-0-26" class="d">-    enum class Action {
</a><a href="#h32-0-27" id="h32-0-27" class="d">-        ADD,
</a><a href="#h32-0-28" id="h32-0-28" class="d">-        GET,
</a><a href="#h32-0-29" id="h32-0-29" class="d">-        CLEAR,
</a><a href="#h32-0-30" id="h32-0-30" class="d">-        DELETE,
</a><a href="#h32-0-31" id="h32-0-31" class="d">-        LIST_IDS
</a><a href="#h32-0-32" id="h32-0-32" class="d">-    }
</a><a href="#h32-0-33" id="h32-0-33" class="d">-}</a><a href="#h32-0-34" id="h32-0-34" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h33" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/impl/messagelogger/MessageLoggerResult.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/impl/messagelogger/MessageLoggerResult.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/impl/messagelogger/MessageLoggerResult.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/impl/messagelogger/MessageLoggerResult.kt</a></b>
<a href="#h33-0" id="h33-0" class="h">@@ -1,20 +0,0 @@
</a><a href="#h33-0-0" id="h33-0-0" class="d">-package me.rhunk.snapenhance.bridge.common.impl.messagelogger
</a><a href="#h33-0-1" id="h33-0-1" class="d">-
</a><a href="#h33-0-2" id="h33-0-2" class="d">-import android.os.Bundle
</a><a href="#h33-0-3" id="h33-0-3" class="d">-import me.rhunk.snapenhance.bridge.common.BridgeMessage
</a><a href="#h33-0-4" id="h33-0-4" class="d">-
</a><a href="#h33-0-5" id="h33-0-5" class="d">-class MessageLoggerResult(
</a><a href="#h33-0-6" id="h33-0-6" class="d">-    var state: Boolean? = null,
</a><a href="#h33-0-7" id="h33-0-7" class="d">-    var message: ByteArray? = null
</a><a href="#h33-0-8" id="h33-0-8" class="d">-) : BridgeMessage() {
</a><a href="#h33-0-9" id="h33-0-9" class="d">-
</a><a href="#h33-0-10" id="h33-0-10" class="d">-    override fun write(bundle: Bundle) {
</a><a href="#h33-0-11" id="h33-0-11" class="d">-        bundle.putBoolean(&quot;state&quot;, state!!)
</a><a href="#h33-0-12" id="h33-0-12" class="d">-        bundle.putByteArray(&quot;message&quot;, message)
</a><a href="#h33-0-13" id="h33-0-13" class="d">-    }
</a><a href="#h33-0-14" id="h33-0-14" class="d">-
</a><a href="#h33-0-15" id="h33-0-15" class="d">-    override fun read(bundle: Bundle) {
</a><a href="#h33-0-16" id="h33-0-16" class="d">-        state = bundle.getBoolean(&quot;state&quot;)
</a><a href="#h33-0-17" id="h33-0-17" class="d">-        message = bundle.getByteArray(&quot;message&quot;)
</a><a href="#h33-0-18" id="h33-0-18" class="d">-    }
</a><a href="#h33-0-19" id="h33-0-19" class="d">-}</a><a href="#h33-0-20" id="h33-0-20" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h34" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/service/BridgeService.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/service/BridgeService.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/service/BridgeService.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/service/BridgeService.kt</a></b>
<a href="#h34-0" id="h34-0" class="h">@@ -1,189 +0,0 @@
</a><a href="#h34-0-0" id="h34-0-0" class="d">-package me.rhunk.snapenhance.bridge.service
</a><a href="#h34-0-1" id="h34-0-1" class="d">-
</a><a href="#h34-0-2" id="h34-0-2" class="d">-import android.annotation.SuppressLint
</a><a href="#h34-0-3" id="h34-0-3" class="d">-import android.app.DownloadManager
</a><a href="#h34-0-4" id="h34-0-4" class="d">-import android.app.Service
</a><a href="#h34-0-5" id="h34-0-5" class="d">-import android.content.*
</a><a href="#h34-0-6" id="h34-0-6" class="d">-import android.net.Uri
</a><a href="#h34-0-7" id="h34-0-7" class="d">-import android.os.*
</a><a href="#h34-0-8" id="h34-0-8" class="d">-import me.rhunk.snapenhance.Logger
</a><a href="#h34-0-9" id="h34-0-9" class="d">-import me.rhunk.snapenhance.bridge.MessageLoggerWrapper
</a><a href="#h34-0-10" id="h34-0-10" class="d">-import me.rhunk.snapenhance.bridge.TranslationWrapper
</a><a href="#h34-0-11" id="h34-0-11" class="d">-import me.rhunk.snapenhance.bridge.common.BridgeMessageType
</a><a href="#h34-0-12" id="h34-0-12" class="d">-import me.rhunk.snapenhance.bridge.common.impl.*
</a><a href="#h34-0-13" id="h34-0-13" class="d">-import me.rhunk.snapenhance.bridge.common.impl.download.DownloadContentRequest
</a><a href="#h34-0-14" id="h34-0-14" class="d">-import me.rhunk.snapenhance.bridge.common.impl.download.DownloadContentResult
</a><a href="#h34-0-15" id="h34-0-15" class="d">-import me.rhunk.snapenhance.bridge.common.impl.file.BridgeFileType
</a><a href="#h34-0-16" id="h34-0-16" class="d">-import me.rhunk.snapenhance.bridge.common.impl.file.FileAccessRequest
</a><a href="#h34-0-17" id="h34-0-17" class="d">-import me.rhunk.snapenhance.bridge.common.impl.file.FileAccessResult
</a><a href="#h34-0-18" id="h34-0-18" class="d">-import me.rhunk.snapenhance.bridge.common.impl.locale.LocaleRequest
</a><a href="#h34-0-19" id="h34-0-19" class="d">-import me.rhunk.snapenhance.bridge.common.impl.locale.LocaleResult
</a><a href="#h34-0-20" id="h34-0-20" class="d">-import me.rhunk.snapenhance.bridge.common.impl.messagelogger.MessageLoggerListResult
</a><a href="#h34-0-21" id="h34-0-21" class="d">-import me.rhunk.snapenhance.bridge.common.impl.messagelogger.MessageLoggerRequest
</a><a href="#h34-0-22" id="h34-0-22" class="d">-import me.rhunk.snapenhance.bridge.common.impl.messagelogger.MessageLoggerResult
</a><a href="#h34-0-23" id="h34-0-23" class="d">-import java.io.File
</a><a href="#h34-0-24" id="h34-0-24" class="d">-import java.util.*
</a><a href="#h34-0-25" id="h34-0-25" class="d">-
</a><a href="#h34-0-26" id="h34-0-26" class="d">-class BridgeService : Service() {
</a><a href="#h34-0-27" id="h34-0-27" class="d">-    private lateinit var messageLoggerWrapper: MessageLoggerWrapper
</a><a href="#h34-0-28" id="h34-0-28" class="d">-
</a><a href="#h34-0-29" id="h34-0-29" class="d">-    override fun onBind(intent: Intent): IBinder {
</a><a href="#h34-0-30" id="h34-0-30" class="d">-        messageLoggerWrapper = MessageLoggerWrapper(getDatabasePath(BridgeFileType.MESSAGE_LOGGER_DATABASE.fileName)).also { it.init() }
</a><a href="#h34-0-31" id="h34-0-31" class="d">-
</a><a href="#h34-0-32" id="h34-0-32" class="d">-        return Messenger(object : Handler(Looper.getMainLooper()) {
</a><a href="#h34-0-33" id="h34-0-33" class="d">-            override fun handleMessage(msg: Message) {
</a><a href="#h34-0-34" id="h34-0-34" class="d">-                runCatching {
</a><a href="#h34-0-35" id="h34-0-35" class="d">-                    this@BridgeService.handleMessage(msg)
</a><a href="#h34-0-36" id="h34-0-36" class="d">-                }.onFailure {
</a><a href="#h34-0-37" id="h34-0-37" class="d">-                    Logger.error(&quot;Failed to handle message ${BridgeMessageType.fromValue(msg.what)}&quot;, it)
</a><a href="#h34-0-38" id="h34-0-38" class="d">-                }
</a><a href="#h34-0-39" id="h34-0-39" class="d">-            }
</a><a href="#h34-0-40" id="h34-0-40" class="d">-        }).binder
</a><a href="#h34-0-41" id="h34-0-41" class="d">-    }
</a><a href="#h34-0-42" id="h34-0-42" class="d">-
</a><a href="#h34-0-43" id="h34-0-43" class="d">-    private fun handleMessage(msg: Message) {
</a><a href="#h34-0-44" id="h34-0-44" class="d">-        val replyMessenger = msg.replyTo
</a><a href="#h34-0-45" id="h34-0-45" class="d">-        when (BridgeMessageType.fromValue(msg.what)) {
</a><a href="#h34-0-46" id="h34-0-46" class="d">-            BridgeMessageType.FILE_ACCESS_REQUEST -&gt; {
</a><a href="#h34-0-47" id="h34-0-47" class="d">-                with(FileAccessRequest()) {
</a><a href="#h34-0-48" id="h34-0-48" class="d">-                    read(msg.data)
</a><a href="#h34-0-49" id="h34-0-49" class="d">-                    handleFileAccess(this) { message -&gt;
</a><a href="#h34-0-50" id="h34-0-50" class="d">-                        replyMessenger.send(message)
</a><a href="#h34-0-51" id="h34-0-51" class="d">-                    }
</a><a href="#h34-0-52" id="h34-0-52" class="d">-                }
</a><a href="#h34-0-53" id="h34-0-53" class="d">-            }
</a><a href="#h34-0-54" id="h34-0-54" class="d">-            BridgeMessageType.DOWNLOAD_CONTENT_REQUEST -&gt; {
</a><a href="#h34-0-55" id="h34-0-55" class="d">-                with(DownloadContentRequest()) {
</a><a href="#h34-0-56" id="h34-0-56" class="d">-                    read(msg.data)
</a><a href="#h34-0-57" id="h34-0-57" class="d">-                    handleDownloadContent(this) { message -&gt;
</a><a href="#h34-0-58" id="h34-0-58" class="d">-                        replyMessenger.send(message)
</a><a href="#h34-0-59" id="h34-0-59" class="d">-                    }
</a><a href="#h34-0-60" id="h34-0-60" class="d">-                }
</a><a href="#h34-0-61" id="h34-0-61" class="d">-            }
</a><a href="#h34-0-62" id="h34-0-62" class="d">-            BridgeMessageType.LOCALE_REQUEST -&gt; {
</a><a href="#h34-0-63" id="h34-0-63" class="d">-                with(LocaleRequest()) {
</a><a href="#h34-0-64" id="h34-0-64" class="d">-                    read(msg.data)
</a><a href="#h34-0-65" id="h34-0-65" class="d">-                    handleLocaleRequest { message -&gt;
</a><a href="#h34-0-66" id="h34-0-66" class="d">-                        replyMessenger.send(message)
</a><a href="#h34-0-67" id="h34-0-67" class="d">-                    }
</a><a href="#h34-0-68" id="h34-0-68" class="d">-                }
</a><a href="#h34-0-69" id="h34-0-69" class="d">-            }
</a><a href="#h34-0-70" id="h34-0-70" class="d">-            BridgeMessageType.MESSAGE_LOGGER_REQUEST -&gt; {
</a><a href="#h34-0-71" id="h34-0-71" class="d">-                with(MessageLoggerRequest()) {
</a><a href="#h34-0-72" id="h34-0-72" class="d">-                    read(msg.data)
</a><a href="#h34-0-73" id="h34-0-73" class="d">-                    handleMessageLoggerRequest(this) { message -&gt;
</a><a href="#h34-0-74" id="h34-0-74" class="d">-                        replyMessenger.send(message)
</a><a href="#h34-0-75" id="h34-0-75" class="d">-                    }
</a><a href="#h34-0-76" id="h34-0-76" class="d">-                }
</a><a href="#h34-0-77" id="h34-0-77" class="d">-            }
</a><a href="#h34-0-78" id="h34-0-78" class="d">-
</a><a href="#h34-0-79" id="h34-0-79" class="d">-            else -&gt; Logger.log(&quot;Unknown message type: &quot; + msg.what)
</a><a href="#h34-0-80" id="h34-0-80" class="d">-        }
</a><a href="#h34-0-81" id="h34-0-81" class="d">-    }
</a><a href="#h34-0-82" id="h34-0-82" class="d">-
</a><a href="#h34-0-83" id="h34-0-83" class="d">-    private fun handleMessageLoggerRequest(msg: MessageLoggerRequest, reply: (Message) -&gt; Unit) {
</a><a href="#h34-0-84" id="h34-0-84" class="d">-        when (msg.action) {
</a><a href="#h34-0-85" id="h34-0-85" class="d">-            MessageLoggerRequest.Action.ADD  -&gt; {
</a><a href="#h34-0-86" id="h34-0-86" class="d">-                val isSuccess = messageLoggerWrapper.addMessage(msg.conversationId!!, msg.index!!, msg.message!!)
</a><a href="#h34-0-87" id="h34-0-87" class="d">-                reply(MessageLoggerResult(isSuccess).toMessage(BridgeMessageType.MESSAGE_LOGGER_RESULT.value))
</a><a href="#h34-0-88" id="h34-0-88" class="d">-                return
</a><a href="#h34-0-89" id="h34-0-89" class="d">-            }
</a><a href="#h34-0-90" id="h34-0-90" class="d">-            MessageLoggerRequest.Action.CLEAR -&gt; {
</a><a href="#h34-0-91" id="h34-0-91" class="d">-                messageLoggerWrapper.clearMessages()
</a><a href="#h34-0-92" id="h34-0-92" class="d">-            }
</a><a href="#h34-0-93" id="h34-0-93" class="d">-            MessageLoggerRequest.Action.DELETE -&gt; {
</a><a href="#h34-0-94" id="h34-0-94" class="d">-                messageLoggerWrapper.deleteMessage(msg.conversationId!!, msg.index!!)
</a><a href="#h34-0-95" id="h34-0-95" class="d">-            }
</a><a href="#h34-0-96" id="h34-0-96" class="d">-            MessageLoggerRequest.Action.GET -&gt; {
</a><a href="#h34-0-97" id="h34-0-97" class="d">-                val (state, messageData) = messageLoggerWrapper.getMessage(msg.conversationId!!, msg.index!!)
</a><a href="#h34-0-98" id="h34-0-98" class="d">-                reply(MessageLoggerResult(state, messageData).toMessage(BridgeMessageType.MESSAGE_LOGGER_RESULT.value))
</a><a href="#h34-0-99" id="h34-0-99" class="d">-                return
</a><a href="#h34-0-100" id="h34-0-100" class="d">-            }
</a><a href="#h34-0-101" id="h34-0-101" class="d">-            MessageLoggerRequest.Action.LIST_IDS -&gt; {
</a><a href="#h34-0-102" id="h34-0-102" class="d">-                val messageIds = messageLoggerWrapper.getMessageIds(msg.conversationId!!, msg.index!!.toInt())
</a><a href="#h34-0-103" id="h34-0-103" class="d">-                reply(MessageLoggerListResult(messageIds).toMessage(BridgeMessageType.MESSAGE_LOGGER_LIST_RESULT.value))
</a><a href="#h34-0-104" id="h34-0-104" class="d">-                return
</a><a href="#h34-0-105" id="h34-0-105" class="d">-            }
</a><a href="#h34-0-106" id="h34-0-106" class="d">-            else -&gt; {
</a><a href="#h34-0-107" id="h34-0-107" class="d">-                Logger.log(Exception(&quot;Unknown message logger action: ${msg.action}&quot;))
</a><a href="#h34-0-108" id="h34-0-108" class="d">-            }
</a><a href="#h34-0-109" id="h34-0-109" class="d">-        }
</a><a href="#h34-0-110" id="h34-0-110" class="d">-
</a><a href="#h34-0-111" id="h34-0-111" class="d">-        reply(MessageLoggerResult(true).toMessage(BridgeMessageType.MESSAGE_LOGGER_RESULT.value))
</a><a href="#h34-0-112" id="h34-0-112" class="d">-    }
</a><a href="#h34-0-113" id="h34-0-113" class="d">-
</a><a href="#h34-0-114" id="h34-0-114" class="d">-    private fun handleLocaleRequest(reply: (Message) -&gt; Unit) {
</a><a href="#h34-0-115" id="h34-0-115" class="d">-        val locales = sortedSetOf&lt;String&gt;()
</a><a href="#h34-0-116" id="h34-0-116" class="d">-        val contentArray = sortedSetOf&lt;String&gt;()
</a><a href="#h34-0-117" id="h34-0-117" class="d">-
</a><a href="#h34-0-118" id="h34-0-118" class="d">-        TranslationWrapper.fetchLocales(context = this).forEach { pair -&gt;
</a><a href="#h34-0-119" id="h34-0-119" class="d">-            locales.add(pair.locale)
</a><a href="#h34-0-120" id="h34-0-120" class="d">-            contentArray.add(pair.content)
</a><a href="#h34-0-121" id="h34-0-121" class="d">-        }
</a><a href="#h34-0-122" id="h34-0-122" class="d">-
</a><a href="#h34-0-123" id="h34-0-123" class="d">-        reply(LocaleResult(locales.toTypedArray(), contentArray.toTypedArray()).toMessage(BridgeMessageType.LOCALE_RESULT.value))
</a><a href="#h34-0-124" id="h34-0-124" class="d">-    }
</a><a href="#h34-0-125" id="h34-0-125" class="d">-
</a><a href="#h34-0-126" id="h34-0-126" class="d">-    @SuppressLint(&quot;UnspecifiedRegisterReceiverFlag&quot;)
</a><a href="#h34-0-127" id="h34-0-127" class="d">-    private fun handleDownloadContent(msg: DownloadContentRequest, reply: (Message) -&gt; Unit) {
</a><a href="#h34-0-128" id="h34-0-128" class="d">-        if (!msg.url!!.startsWith(&quot;http://127.0.0.1:&quot;)) return
</a><a href="#h34-0-129" id="h34-0-129" class="d">-
</a><a href="#h34-0-130" id="h34-0-130" class="d">-        val outputFile = File(msg.path!!)
</a><a href="#h34-0-131" id="h34-0-131" class="d">-        outputFile.parentFile?.let {
</a><a href="#h34-0-132" id="h34-0-132" class="d">-            if (!it.exists()) it.mkdirs()
</a><a href="#h34-0-133" id="h34-0-133" class="d">-        }
</a><a href="#h34-0-134" id="h34-0-134" class="d">-        val downloadManager = getSystemService(DOWNLOAD_SERVICE) as DownloadManager
</a><a href="#h34-0-135" id="h34-0-135" class="d">-        val request = DownloadManager.Request(Uri.parse(msg.url))
</a><a href="#h34-0-136" id="h34-0-136" class="d">-            .setNotificationVisibility(DownloadManager.Request.VISIBILITY_VISIBLE)
</a><a href="#h34-0-137" id="h34-0-137" class="d">-            .setAllowedOverMetered(true)
</a><a href="#h34-0-138" id="h34-0-138" class="d">-            .setAllowedOverRoaming(true)
</a><a href="#h34-0-139" id="h34-0-139" class="d">-            .setDestinationUri(Uri.fromFile(outputFile))
</a><a href="#h34-0-140" id="h34-0-140" class="d">-        val downloadId = downloadManager.enqueue(request)
</a><a href="#h34-0-141" id="h34-0-141" class="d">-        registerReceiver(object : BroadcastReceiver() {
</a><a href="#h34-0-142" id="h34-0-142" class="d">-            override fun onReceive(context: Context, intent: Intent) {
</a><a href="#h34-0-143" id="h34-0-143" class="d">-                if (intent.getLongExtra(DownloadManager.EXTRA_DOWNLOAD_ID, -1) != downloadId) return
</a><a href="#h34-0-144" id="h34-0-144" class="d">-                unregisterReceiver(this)
</a><a href="#h34-0-145" id="h34-0-145" class="d">-                reply(DownloadContentResult(true).toMessage(BridgeMessageType.DOWNLOAD_CONTENT_RESULT.value))
</a><a href="#h34-0-146" id="h34-0-146" class="d">-            }
</a><a href="#h34-0-147" id="h34-0-147" class="d">-        }, IntentFilter(DownloadManager.ACTION_DOWNLOAD_COMPLETE))
</a><a href="#h34-0-148" id="h34-0-148" class="d">-    }
</a><a href="#h34-0-149" id="h34-0-149" class="d">-
</a><a href="#h34-0-150" id="h34-0-150" class="d">-    private fun handleFileAccess(msg: FileAccessRequest, reply: (Message) -&gt; Unit) {
</a><a href="#h34-0-151" id="h34-0-151" class="d">-        val fileFolder = if (msg.fileType!!.isDatabase) {
</a><a href="#h34-0-152" id="h34-0-152" class="d">-            File(dataDir, &quot;databases&quot;)
</a><a href="#h34-0-153" id="h34-0-153" class="d">-        } else {
</a><a href="#h34-0-154" id="h34-0-154" class="d">-            File(filesDir.absolutePath)
</a><a href="#h34-0-155" id="h34-0-155" class="d">-        }
</a><a href="#h34-0-156" id="h34-0-156" class="d">-        val requestFile =  File(fileFolder, msg.fileType!!.fileName)
</a><a href="#h34-0-157" id="h34-0-157" class="d">-
</a><a href="#h34-0-158" id="h34-0-158" class="d">-        val result: FileAccessResult = when (msg.action) {
</a><a href="#h34-0-159" id="h34-0-159" class="d">-            FileAccessRequest.FileAccessAction.READ -&gt; {
</a><a href="#h34-0-160" id="h34-0-160" class="d">-                if (!requestFile.exists()) {
</a><a href="#h34-0-161" id="h34-0-161" class="d">-                    FileAccessResult(false, null)
</a><a href="#h34-0-162" id="h34-0-162" class="d">-                } else {
</a><a href="#h34-0-163" id="h34-0-163" class="d">-                    FileAccessResult(true, requestFile.readBytes())
</a><a href="#h34-0-164" id="h34-0-164" class="d">-                }
</a><a href="#h34-0-165" id="h34-0-165" class="d">-            }
</a><a href="#h34-0-166" id="h34-0-166" class="d">-            FileAccessRequest.FileAccessAction.WRITE -&gt; {
</a><a href="#h34-0-167" id="h34-0-167" class="d">-                if (!requestFile.exists()) {
</a><a href="#h34-0-168" id="h34-0-168" class="d">-                    requestFile.createNewFile()
</a><a href="#h34-0-169" id="h34-0-169" class="d">-                }
</a><a href="#h34-0-170" id="h34-0-170" class="d">-                requestFile.writeBytes(msg.content!!)
</a><a href="#h34-0-171" id="h34-0-171" class="d">-                FileAccessResult(true, null)
</a><a href="#h34-0-172" id="h34-0-172" class="d">-            }
</a><a href="#h34-0-173" id="h34-0-173" class="d">-            FileAccessRequest.FileAccessAction.DELETE -&gt; {
</a><a href="#h34-0-174" id="h34-0-174" class="d">-                if (!requestFile.exists()) {
</a><a href="#h34-0-175" id="h34-0-175" class="d">-                    FileAccessResult(false, null)
</a><a href="#h34-0-176" id="h34-0-176" class="d">-                } else {
</a><a href="#h34-0-177" id="h34-0-177" class="d">-                    requestFile.delete()
</a><a href="#h34-0-178" id="h34-0-178" class="d">-                    FileAccessResult(true, null)
</a><a href="#h34-0-179" id="h34-0-179" class="d">-                }
</a><a href="#h34-0-180" id="h34-0-180" class="d">-            }
</a><a href="#h34-0-181" id="h34-0-181" class="d">-            FileAccessRequest.FileAccessAction.EXISTS -&gt; FileAccessResult(requestFile.exists(), null)
</a><a href="#h34-0-182" id="h34-0-182" class="d">-            else -&gt; throw Exception(&quot;Unknown action: &quot; + msg.action)
</a><a href="#h34-0-183" id="h34-0-183" class="d">-        }
</a><a href="#h34-0-184" id="h34-0-184" class="d">-
</a><a href="#h34-0-185" id="h34-0-185" class="d">-        reply(result.toMessage(BridgeMessageType.FILE_ACCESS_RESULT.value))
</a><a href="#h34-0-186" id="h34-0-186" class="d">-    }
</a><a href="#h34-0-187" id="h34-0-187" class="d">-
</a><a href="#h34-0-188" id="h34-0-188" class="d">-}
</a><b>diff --git a/<a id="h35" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/types/BridgeFileType.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/types/BridgeFileType.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/types/BridgeFileType.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/types/BridgeFileType.kt</a></b>
<a href="#h35-0" id="h35-0" class="h">@@ -0,0 +1,28 @@
</a><a href="#h35-0-0" id="h35-0-0" class="i">+package me.rhunk.snapenhance.bridge.types
</a><a href="#h35-0-1" id="h35-0-1" class="i">+
</a><a href="#h35-0-2" id="h35-0-2" class="i">+import android.content.Context
</a><a href="#h35-0-3" id="h35-0-3" class="i">+import java.io.File
</a><a href="#h35-0-4" id="h35-0-4" class="i">+
</a><a href="#h35-0-5" id="h35-0-5" class="i">+
</a><a href="#h35-0-6" id="h35-0-6" class="i">+enum class BridgeFileType(val value: Int, val fileName: String, val displayName: String, private val isDatabase: Boolean = false) {
</a><a href="#h35-0-7" id="h35-0-7" class="i">+    CONFIG(0, &quot;config.json&quot;, &quot;Config&quot;),
</a><a href="#h35-0-8" id="h35-0-8" class="i">+    MAPPINGS(1, &quot;mappings.json&quot;, &quot;Mappings&quot;),
</a><a href="#h35-0-9" id="h35-0-9" class="i">+    MESSAGE_LOGGER_DATABASE(2, &quot;message_logger.db&quot;, &quot;Message Logger&quot;,true),
</a><a href="#h35-0-10" id="h35-0-10" class="i">+    STEALTH(3, &quot;stealth.txt&quot;, &quot;Stealth Conversations&quot;),
</a><a href="#h35-0-11" id="h35-0-11" class="i">+    ANTI_AUTO_DOWNLOAD(4, &quot;anti_auto_download.txt&quot;, &quot;Anti Auto Download&quot;),
</a><a href="#h35-0-12" id="h35-0-12" class="i">+    ANTI_AUTO_SAVE(5, &quot;anti_auto_save.txt&quot;, &quot;Anti Auto Save&quot;),
</a><a href="#h35-0-13" id="h35-0-13" class="i">+    AUTO_UPDATER_TIMESTAMP(6, &quot;auto_updater_timestamp.txt&quot;, &quot;Auto Updater Timestamp&quot;),
</a><a href="#h35-0-14" id="h35-0-14" class="i">+    PINNED_CONVERSATIONS(7, &quot;pinned_conversations.txt&quot;, &quot;Pinned Conversations&quot;);
</a><a href="#h35-0-15" id="h35-0-15" class="i">+
</a><a href="#h35-0-16" id="h35-0-16" class="i">+    fun resolve(context: Context): File = if (isDatabase) {
</a><a href="#h35-0-17" id="h35-0-17" class="i">+        context.getDatabasePath(fileName)
</a><a href="#h35-0-18" id="h35-0-18" class="i">+    } else {
</a><a href="#h35-0-19" id="h35-0-19" class="i">+        File(context.filesDir, fileName)
</a><a href="#h35-0-20" id="h35-0-20" class="i">+    }
</a><a href="#h35-0-21" id="h35-0-21" class="i">+
</a><a href="#h35-0-22" id="h35-0-22" class="i">+    companion object {
</a><a href="#h35-0-23" id="h35-0-23" class="i">+        fun fromValue(value: Int): BridgeFileType? {
</a><a href="#h35-0-24" id="h35-0-24" class="i">+            return values().firstOrNull { it.value == value }
</a><a href="#h35-0-25" id="h35-0-25" class="i">+        }
</a><a href="#h35-0-26" id="h35-0-26" class="i">+    }
</a><a href="#h35-0-27" id="h35-0-27" class="i">+}</a><a href="#h35-0-28" id="h35-0-28" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h36" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/wrapper/ConfigWrapper.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/wrapper/ConfigWrapper.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/wrapper/ConfigWrapper.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/wrapper/ConfigWrapper.kt</a></b>
<a href="#h36-0" id="h36-0" class="h">@@ -0,0 +1,80 @@
</a><a href="#h36-0-0" id="h36-0-0" class="i">+package me.rhunk.snapenhance.bridge.wrapper
</a><a href="#h36-0-1" id="h36-0-1" class="i">+
</a><a href="#h36-0-2" id="h36-0-2" class="i">+import android.content.Context
</a><a href="#h36-0-3" id="h36-0-3" class="i">+import com.google.gson.GsonBuilder
</a><a href="#h36-0-4" id="h36-0-4" class="i">+import com.google.gson.JsonObject
</a><a href="#h36-0-5" id="h36-0-5" class="i">+import me.rhunk.snapenhance.Logger
</a><a href="#h36-0-6" id="h36-0-6" class="i">+import me.rhunk.snapenhance.bridge.BridgeClient
</a><a href="#h36-0-7" id="h36-0-7" class="i">+import me.rhunk.snapenhance.bridge.types.BridgeFileType
</a><a href="#h36-0-8" id="h36-0-8" class="i">+import me.rhunk.snapenhance.config.ConfigAccessor
</a><a href="#h36-0-9" id="h36-0-9" class="i">+import me.rhunk.snapenhance.config.ConfigProperty
</a><a href="#h36-0-10" id="h36-0-10" class="i">+
</a><a href="#h36-0-11" id="h36-0-11" class="i">+class ConfigWrapper: ConfigAccessor() {
</a><a href="#h36-0-12" id="h36-0-12" class="i">+    companion object {
</a><a href="#h36-0-13" id="h36-0-13" class="i">+        private val gson = GsonBuilder().setPrettyPrinting().create()
</a><a href="#h36-0-14" id="h36-0-14" class="i">+    }
</a><a href="#h36-0-15" id="h36-0-15" class="i">+
</a><a href="#h36-0-16" id="h36-0-16" class="i">+    private lateinit var isFileExistsAction: () -&gt; Boolean
</a><a href="#h36-0-17" id="h36-0-17" class="i">+    private lateinit var writeFileAction: (ByteArray) -&gt; Unit
</a><a href="#h36-0-18" id="h36-0-18" class="i">+    private lateinit var readFileAction: () -&gt; ByteArray
</a><a href="#h36-0-19" id="h36-0-19" class="i">+
</a><a href="#h36-0-20" id="h36-0-20" class="i">+    fun load() {
</a><a href="#h36-0-21" id="h36-0-21" class="i">+        ConfigProperty.sortedByCategory().forEach { key -&gt;
</a><a href="#h36-0-22" id="h36-0-22" class="i">+            set(key, key.valueContainer)
</a><a href="#h36-0-23" id="h36-0-23" class="i">+        }
</a><a href="#h36-0-24" id="h36-0-24" class="i">+
</a><a href="#h36-0-25" id="h36-0-25" class="i">+        if (!isFileExistsAction()) {
</a><a href="#h36-0-26" id="h36-0-26" class="i">+            writeConfig()
</a><a href="#h36-0-27" id="h36-0-27" class="i">+            return
</a><a href="#h36-0-28" id="h36-0-28" class="i">+        }
</a><a href="#h36-0-29" id="h36-0-29" class="i">+
</a><a href="#h36-0-30" id="h36-0-30" class="i">+        runCatching {
</a><a href="#h36-0-31" id="h36-0-31" class="i">+            loadConfig()
</a><a href="#h36-0-32" id="h36-0-32" class="i">+        }.onFailure {
</a><a href="#h36-0-33" id="h36-0-33" class="i">+            Logger.error(&quot;Failed to load config&quot;, it)
</a><a href="#h36-0-34" id="h36-0-34" class="i">+            writeConfig()
</a><a href="#h36-0-35" id="h36-0-35" class="i">+        }
</a><a href="#h36-0-36" id="h36-0-36" class="i">+    }
</a><a href="#h36-0-37" id="h36-0-37" class="i">+
</a><a href="#h36-0-38" id="h36-0-38" class="i">+    private fun loadConfig() {
</a><a href="#h36-0-39" id="h36-0-39" class="i">+        val configContent = readFileAction()
</a><a href="#h36-0-40" id="h36-0-40" class="i">+
</a><a href="#h36-0-41" id="h36-0-41" class="i">+        val configObject: JsonObject = gson.fromJson(
</a><a href="#h36-0-42" id="h36-0-42" class="i">+            configContent.toString(Charsets.UTF_8),
</a><a href="#h36-0-43" id="h36-0-43" class="i">+            JsonObject::class.java
</a><a href="#h36-0-44" id="h36-0-44" class="i">+        )
</a><a href="#h36-0-45" id="h36-0-45" class="i">+
</a><a href="#h36-0-46" id="h36-0-46" class="i">+        entries().forEach { (key, value) -&gt;
</a><a href="#h36-0-47" id="h36-0-47" class="i">+            value.writeFrom(configObject.get(key.name)?.asString ?: value.read())
</a><a href="#h36-0-48" id="h36-0-48" class="i">+        }
</a><a href="#h36-0-49" id="h36-0-49" class="i">+    }
</a><a href="#h36-0-50" id="h36-0-50" class="i">+
</a><a href="#h36-0-51" id="h36-0-51" class="i">+    fun writeConfig() {
</a><a href="#h36-0-52" id="h36-0-52" class="i">+        val configObject = JsonObject()
</a><a href="#h36-0-53" id="h36-0-53" class="i">+        entries().forEach { (key, value) -&gt;
</a><a href="#h36-0-54" id="h36-0-54" class="i">+            configObject.addProperty(key.name, value.read())
</a><a href="#h36-0-55" id="h36-0-55" class="i">+        }
</a><a href="#h36-0-56" id="h36-0-56" class="i">+        writeFileAction(gson.toJson(configObject).toByteArray(Charsets.UTF_8))
</a><a href="#h36-0-57" id="h36-0-57" class="i">+    }
</a><a href="#h36-0-58" id="h36-0-58" class="i">+
</a><a href="#h36-0-59" id="h36-0-59" class="i">+    fun loadFromContext(context: Context) {
</a><a href="#h36-0-60" id="h36-0-60" class="i">+        val configFile = BridgeFileType.CONFIG.resolve(context)
</a><a href="#h36-0-61" id="h36-0-61" class="i">+        isFileExistsAction = { configFile.exists() }
</a><a href="#h36-0-62" id="h36-0-62" class="i">+        readFileAction = {
</a><a href="#h36-0-63" id="h36-0-63" class="i">+            if (!configFile.exists()) {
</a><a href="#h36-0-64" id="h36-0-64" class="i">+                configFile.createNewFile()
</a><a href="#h36-0-65" id="h36-0-65" class="i">+                configFile.writeBytes(&quot;{}&quot;.toByteArray(Charsets.UTF_8))
</a><a href="#h36-0-66" id="h36-0-66" class="i">+            }
</a><a href="#h36-0-67" id="h36-0-67" class="i">+            configFile.readBytes()
</a><a href="#h36-0-68" id="h36-0-68" class="i">+        }
</a><a href="#h36-0-69" id="h36-0-69" class="i">+        writeFileAction = { configFile.writeBytes(it) }
</a><a href="#h36-0-70" id="h36-0-70" class="i">+        load()
</a><a href="#h36-0-71" id="h36-0-71" class="i">+    }
</a><a href="#h36-0-72" id="h36-0-72" class="i">+
</a><a href="#h36-0-73" id="h36-0-73" class="i">+    fun loadFromBridge(bridgeClient: BridgeClient) {
</a><a href="#h36-0-74" id="h36-0-74" class="i">+        isFileExistsAction = { bridgeClient.isFileExists(BridgeFileType.CONFIG) }
</a><a href="#h36-0-75" id="h36-0-75" class="i">+        readFileAction = { bridgeClient.createAndReadFile(BridgeFileType.CONFIG, &quot;{}&quot;.toByteArray(Charsets.UTF_8)) }
</a><a href="#h36-0-76" id="h36-0-76" class="i">+        writeFileAction = { bridgeClient.writeFile(BridgeFileType.CONFIG, it) }
</a><a href="#h36-0-77" id="h36-0-77" class="i">+        load()
</a><a href="#h36-0-78" id="h36-0-78" class="i">+    }
</a><a href="#h36-0-79" id="h36-0-79" class="i">+}</a><a href="#h36-0-80" id="h36-0-80" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h37" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/wrapper/MessageLoggerWrapper.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/wrapper/MessageLoggerWrapper.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/wrapper/MessageLoggerWrapper.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/wrapper/MessageLoggerWrapper.kt</a></b>
<a href="#h37-0" id="h37-0" class="h">@@ -0,0 +1,70 @@
</a><a href="#h37-0-0" id="h37-0-0" class="i">+package me.rhunk.snapenhance.bridge.wrapper
</a><a href="#h37-0-1" id="h37-0-1" class="i">+
</a><a href="#h37-0-2" id="h37-0-2" class="i">+import android.content.ContentValues
</a><a href="#h37-0-3" id="h37-0-3" class="i">+import android.database.sqlite.SQLiteDatabase
</a><a href="#h37-0-4" id="h37-0-4" class="i">+import me.rhunk.snapenhance.util.SQLiteDatabaseHelper
</a><a href="#h37-0-5" id="h37-0-5" class="i">+import java.io.File
</a><a href="#h37-0-6" id="h37-0-6" class="i">+
</a><a href="#h37-0-7" id="h37-0-7" class="i">+class MessageLoggerWrapper(
</a><a href="#h37-0-8" id="h37-0-8" class="i">+    private val databaseFile: File
</a><a href="#h37-0-9" id="h37-0-9" class="i">+) {
</a><a href="#h37-0-10" id="h37-0-10" class="i">+
</a><a href="#h37-0-11" id="h37-0-11" class="i">+    lateinit var database: SQLiteDatabase
</a><a href="#h37-0-12" id="h37-0-12" class="i">+
</a><a href="#h37-0-13" id="h37-0-13" class="i">+    fun init() {
</a><a href="#h37-0-14" id="h37-0-14" class="i">+        database = SQLiteDatabase.openDatabase(databaseFile.absolutePath, null, SQLiteDatabase.CREATE_IF_NECESSARY or SQLiteDatabase.OPEN_READWRITE)
</a><a href="#h37-0-15" id="h37-0-15" class="i">+        SQLiteDatabaseHelper.createTablesFromSchema(database, mapOf(
</a><a href="#h37-0-16" id="h37-0-16" class="i">+            &quot;messages&quot; to listOf(
</a><a href="#h37-0-17" id="h37-0-17" class="i">+                &quot;id INTEGER PRIMARY KEY&quot;,
</a><a href="#h37-0-18" id="h37-0-18" class="i">+                &quot;conversation_id VARCHAR&quot;,
</a><a href="#h37-0-19" id="h37-0-19" class="i">+                &quot;message_id BIGINT&quot;,
</a><a href="#h37-0-20" id="h37-0-20" class="i">+                &quot;message_data BLOB&quot;
</a><a href="#h37-0-21" id="h37-0-21" class="i">+            )
</a><a href="#h37-0-22" id="h37-0-22" class="i">+        ))
</a><a href="#h37-0-23" id="h37-0-23" class="i">+    }
</a><a href="#h37-0-24" id="h37-0-24" class="i">+
</a><a href="#h37-0-25" id="h37-0-25" class="i">+    fun deleteMessage(conversationId: String, messageId: Long) {
</a><a href="#h37-0-26" id="h37-0-26" class="i">+        database.execSQL(&quot;DELETE FROM messages WHERE conversation_id = ? AND message_id = ?&quot;, arrayOf(conversationId, messageId.toString()))
</a><a href="#h37-0-27" id="h37-0-27" class="i">+    }
</a><a href="#h37-0-28" id="h37-0-28" class="i">+
</a><a href="#h37-0-29" id="h37-0-29" class="i">+    fun addMessage(conversationId: String, messageId: Long, serializedMessage: ByteArray): Boolean {
</a><a href="#h37-0-30" id="h37-0-30" class="i">+        val cursor = database.rawQuery(&quot;SELECT message_id FROM messages WHERE conversation_id = ? AND message_id = ?&quot;, arrayOf(conversationId, messageId.toString()))
</a><a href="#h37-0-31" id="h37-0-31" class="i">+        val state = cursor.moveToFirst()
</a><a href="#h37-0-32" id="h37-0-32" class="i">+        cursor.close()
</a><a href="#h37-0-33" id="h37-0-33" class="i">+        if (state) {
</a><a href="#h37-0-34" id="h37-0-34" class="i">+            return false
</a><a href="#h37-0-35" id="h37-0-35" class="i">+        }
</a><a href="#h37-0-36" id="h37-0-36" class="i">+        database.insert(&quot;messages&quot;, null, ContentValues().apply {
</a><a href="#h37-0-37" id="h37-0-37" class="i">+            put(&quot;conversation_id&quot;, conversationId)
</a><a href="#h37-0-38" id="h37-0-38" class="i">+            put(&quot;message_id&quot;, messageId)
</a><a href="#h37-0-39" id="h37-0-39" class="i">+            put(&quot;message_data&quot;, serializedMessage)
</a><a href="#h37-0-40" id="h37-0-40" class="i">+        })
</a><a href="#h37-0-41" id="h37-0-41" class="i">+        return true
</a><a href="#h37-0-42" id="h37-0-42" class="i">+    }
</a><a href="#h37-0-43" id="h37-0-43" class="i">+
</a><a href="#h37-0-44" id="h37-0-44" class="i">+    fun getMessage(conversationId: String, messageId: Long): Pair&lt;Boolean, ByteArray?&gt; {
</a><a href="#h37-0-45" id="h37-0-45" class="i">+        val cursor = database.rawQuery(&quot;SELECT message_data FROM messages WHERE conversation_id = ? AND message_id = ?&quot;, arrayOf(conversationId, messageId.toString()))
</a><a href="#h37-0-46" id="h37-0-46" class="i">+        val state = cursor.moveToFirst()
</a><a href="#h37-0-47" id="h37-0-47" class="i">+        val message: ByteArray? = if (state) {
</a><a href="#h37-0-48" id="h37-0-48" class="i">+            cursor.getBlob(0)
</a><a href="#h37-0-49" id="h37-0-49" class="i">+        } else {
</a><a href="#h37-0-50" id="h37-0-50" class="i">+            null
</a><a href="#h37-0-51" id="h37-0-51" class="i">+        }
</a><a href="#h37-0-52" id="h37-0-52" class="i">+        cursor.close()
</a><a href="#h37-0-53" id="h37-0-53" class="i">+        return Pair(state, message)
</a><a href="#h37-0-54" id="h37-0-54" class="i">+    }
</a><a href="#h37-0-55" id="h37-0-55" class="i">+
</a><a href="#h37-0-56" id="h37-0-56" class="i">+    fun getMessageIds(conversationId: String, limit: Int): List&lt;Long&gt; {
</a><a href="#h37-0-57" id="h37-0-57" class="i">+        val cursor = database.rawQuery(&quot;SELECT message_id FROM messages WHERE conversation_id = ? ORDER BY message_id DESC LIMIT ?&quot;, arrayOf(conversationId, limit.toString()))
</a><a href="#h37-0-58" id="h37-0-58" class="i">+        val messageIds = mutableListOf&lt;Long&gt;()
</a><a href="#h37-0-59" id="h37-0-59" class="i">+        while (cursor.moveToNext()) {
</a><a href="#h37-0-60" id="h37-0-60" class="i">+            messageIds.add(cursor.getLong(0))
</a><a href="#h37-0-61" id="h37-0-61" class="i">+        }
</a><a href="#h37-0-62" id="h37-0-62" class="i">+        cursor.close()
</a><a href="#h37-0-63" id="h37-0-63" class="i">+        return messageIds
</a><a href="#h37-0-64" id="h37-0-64" class="i">+    }
</a><a href="#h37-0-65" id="h37-0-65" class="i">+
</a><a href="#h37-0-66" id="h37-0-66" class="i">+    fun clearMessages() {
</a><a href="#h37-0-67" id="h37-0-67" class="i">+        database.execSQL(&quot;DELETE FROM messages&quot;)
</a><a href="#h37-0-68" id="h37-0-68" class="i">+    }
</a><a href="#h37-0-69" id="h37-0-69" class="i">+}</a><a href="#h37-0-70" id="h37-0-70" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h38" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/wrapper/TranslationWrapper.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/wrapper/TranslationWrapper.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/wrapper/TranslationWrapper.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/wrapper/TranslationWrapper.kt</a></b>
<a href="#h38-0" id="h38-0" class="h">@@ -0,0 +1,97 @@
</a><a href="#h38-0-0" id="h38-0-0" class="i">+package me.rhunk.snapenhance.bridge.wrapper
</a><a href="#h38-0-1" id="h38-0-1" class="i">+
</a><a href="#h38-0-2" id="h38-0-2" class="i">+import android.content.Context
</a><a href="#h38-0-3" id="h38-0-3" class="i">+import com.google.gson.JsonObject
</a><a href="#h38-0-4" id="h38-0-4" class="i">+import com.google.gson.JsonParser
</a><a href="#h38-0-5" id="h38-0-5" class="i">+import me.rhunk.snapenhance.Logger
</a><a href="#h38-0-6" id="h38-0-6" class="i">+import me.rhunk.snapenhance.bridge.BridgeClient
</a><a href="#h38-0-7" id="h38-0-7" class="i">+import me.rhunk.snapenhance.data.LocalePair
</a><a href="#h38-0-8" id="h38-0-8" class="i">+import java.util.Locale
</a><a href="#h38-0-9" id="h38-0-9" class="i">+
</a><a href="#h38-0-10" id="h38-0-10" class="i">+
</a><a href="#h38-0-11" id="h38-0-11" class="i">+class TranslationWrapper {
</a><a href="#h38-0-12" id="h38-0-12" class="i">+    companion object {
</a><a href="#h38-0-13" id="h38-0-13" class="i">+        private const val DEFAULT_LOCALE = &quot;en_US&quot;
</a><a href="#h38-0-14" id="h38-0-14" class="i">+
</a><a href="#h38-0-15" id="h38-0-15" class="i">+        fun fetchLocales(context: Context): List&lt;LocalePair&gt; {
</a><a href="#h38-0-16" id="h38-0-16" class="i">+            val deviceLocale = Locale.getDefault().toString()
</a><a href="#h38-0-17" id="h38-0-17" class="i">+            val locales = mutableListOf&lt;LocalePair&gt;()
</a><a href="#h38-0-18" id="h38-0-18" class="i">+
</a><a href="#h38-0-19" id="h38-0-19" class="i">+            locales.add(LocalePair(DEFAULT_LOCALE, context.resources.assets.open(&quot;lang/$DEFAULT_LOCALE.json&quot;).bufferedReader().use { it.readText() }))
</a><a href="#h38-0-20" id="h38-0-20" class="i">+
</a><a href="#h38-0-21" id="h38-0-21" class="i">+            if (deviceLocale == DEFAULT_LOCALE) return locales
</a><a href="#h38-0-22" id="h38-0-22" class="i">+
</a><a href="#h38-0-23" id="h38-0-23" class="i">+            val compatibleLocale = context.resources.assets.list(&quot;lang&quot;)?.firstOrNull { it.startsWith(deviceLocale) }?.substring(0, 5) ?: return locales
</a><a href="#h38-0-24" id="h38-0-24" class="i">+
</a><a href="#h38-0-25" id="h38-0-25" class="i">+            context.resources.assets.open(&quot;lang/$compatibleLocale.json&quot;).use { inputStream -&gt;
</a><a href="#h38-0-26" id="h38-0-26" class="i">+                locales.add(LocalePair(compatibleLocale, inputStream.bufferedReader().use { it.readText() }))
</a><a href="#h38-0-27" id="h38-0-27" class="i">+            }
</a><a href="#h38-0-28" id="h38-0-28" class="i">+
</a><a href="#h38-0-29" id="h38-0-29" class="i">+            return locales
</a><a href="#h38-0-30" id="h38-0-30" class="i">+        }
</a><a href="#h38-0-31" id="h38-0-31" class="i">+    }
</a><a href="#h38-0-32" id="h38-0-32" class="i">+
</a><a href="#h38-0-33" id="h38-0-33" class="i">+
</a><a href="#h38-0-34" id="h38-0-34" class="i">+    private val translationMap = linkedMapOf&lt;String, String&gt;()
</a><a href="#h38-0-35" id="h38-0-35" class="i">+    private lateinit var _locale: String
</a><a href="#h38-0-36" id="h38-0-36" class="i">+
</a><a href="#h38-0-37" id="h38-0-37" class="i">+    val locale by lazy {
</a><a href="#h38-0-38" id="h38-0-38" class="i">+        Locale(_locale.substring(0, 2), _locale.substring(3, 5))
</a><a href="#h38-0-39" id="h38-0-39" class="i">+    }
</a><a href="#h38-0-40" id="h38-0-40" class="i">+
</a><a href="#h38-0-41" id="h38-0-41" class="i">+    private fun load(localePair: LocalePair) {
</a><a href="#h38-0-42" id="h38-0-42" class="i">+        if (!::_locale.isInitialized) {
</a><a href="#h38-0-43" id="h38-0-43" class="i">+            _locale = localePair.locale
</a><a href="#h38-0-44" id="h38-0-44" class="i">+        }
</a><a href="#h38-0-45" id="h38-0-45" class="i">+
</a><a href="#h38-0-46" id="h38-0-46" class="i">+        val translations = JsonParser.parseString(localePair.content).asJsonObject
</a><a href="#h38-0-47" id="h38-0-47" class="i">+        if (translations == null || translations.isJsonNull) {
</a><a href="#h38-0-48" id="h38-0-48" class="i">+            return
</a><a href="#h38-0-49" id="h38-0-49" class="i">+        }
</a><a href="#h38-0-50" id="h38-0-50" class="i">+
</a><a href="#h38-0-51" id="h38-0-51" class="i">+        fun scanObject(jsonObject: JsonObject, prefix: String = &quot;&quot;) {
</a><a href="#h38-0-52" id="h38-0-52" class="i">+            jsonObject.entrySet().forEach {
</a><a href="#h38-0-53" id="h38-0-53" class="i">+                if (it.value.isJsonPrimitive) {
</a><a href="#h38-0-54" id="h38-0-54" class="i">+                    val key = &quot;$prefix${it.key}&quot;
</a><a href="#h38-0-55" id="h38-0-55" class="i">+                    translationMap[key] = it.value.asString
</a><a href="#h38-0-56" id="h38-0-56" class="i">+                }
</a><a href="#h38-0-57" id="h38-0-57" class="i">+                if (!it.value.isJsonObject) return@forEach
</a><a href="#h38-0-58" id="h38-0-58" class="i">+                scanObject(it.value.asJsonObject, &quot;$prefix${it.key}.&quot;)
</a><a href="#h38-0-59" id="h38-0-59" class="i">+            }
</a><a href="#h38-0-60" id="h38-0-60" class="i">+        }
</a><a href="#h38-0-61" id="h38-0-61" class="i">+
</a><a href="#h38-0-62" id="h38-0-62" class="i">+        scanObject(translations)
</a><a href="#h38-0-63" id="h38-0-63" class="i">+    }
</a><a href="#h38-0-64" id="h38-0-64" class="i">+
</a><a href="#h38-0-65" id="h38-0-65" class="i">+    fun loadFromBridge(bridgeClient: BridgeClient) {
</a><a href="#h38-0-66" id="h38-0-66" class="i">+        bridgeClient.fetchTranslations().forEach {
</a><a href="#h38-0-67" id="h38-0-67" class="i">+            load(it)
</a><a href="#h38-0-68" id="h38-0-68" class="i">+        }
</a><a href="#h38-0-69" id="h38-0-69" class="i">+    }
</a><a href="#h38-0-70" id="h38-0-70" class="i">+
</a><a href="#h38-0-71" id="h38-0-71" class="i">+    fun loadFromContext(context: Context) {
</a><a href="#h38-0-72" id="h38-0-72" class="i">+        fetchLocales(context).forEach {
</a><a href="#h38-0-73" id="h38-0-73" class="i">+            load(it)
</a><a href="#h38-0-74" id="h38-0-74" class="i">+        }
</a><a href="#h38-0-75" id="h38-0-75" class="i">+    }
</a><a href="#h38-0-76" id="h38-0-76" class="i">+
</a><a href="#h38-0-77" id="h38-0-77" class="i">+    operator fun get(key: String): String {
</a><a href="#h38-0-78" id="h38-0-78" class="i">+        return translationMap[key] ?: key.also { Logger.debug(&quot;Missing translation for $key&quot;) }
</a><a href="#h38-0-79" id="h38-0-79" class="i">+    }
</a><a href="#h38-0-80" id="h38-0-80" class="i">+
</a><a href="#h38-0-81" id="h38-0-81" class="i">+    fun format(key: String, vararg args: Pair&lt;String, String&gt;): String {
</a><a href="#h38-0-82" id="h38-0-82" class="i">+        return args.fold(get(key)) { acc, pair -&gt;
</a><a href="#h38-0-83" id="h38-0-83" class="i">+            acc.replace(&quot;{${pair.first}}&quot;, pair.second)
</a><a href="#h38-0-84" id="h38-0-84" class="i">+        }
</a><a href="#h38-0-85" id="h38-0-85" class="i">+    }
</a><a href="#h38-0-86" id="h38-0-86" class="i">+
</a><a href="#h38-0-87" id="h38-0-87" class="i">+    fun getCategory(key: String): TranslationWrapper {
</a><a href="#h38-0-88" id="h38-0-88" class="i">+        return TranslationWrapper().apply {
</a><a href="#h38-0-89" id="h38-0-89" class="i">+            translationMap.putAll(
</a><a href="#h38-0-90" id="h38-0-90" class="i">+                this@TranslationWrapper.translationMap
</a><a href="#h38-0-91" id="h38-0-91" class="i">+                    .filterKeys { it.startsWith(&quot;$key.&quot;) }
</a><a href="#h38-0-92" id="h38-0-92" class="i">+                    .mapKeys { it.key.substring(key.length + 1) }
</a><a href="#h38-0-93" id="h38-0-93" class="i">+            )
</a><a href="#h38-0-94" id="h38-0-94" class="i">+        }
</a><a href="#h38-0-95" id="h38-0-95" class="i">+    }
</a><a href="#h38-0-96" id="h38-0-96" class="i">+}</a><a href="#h38-0-97" id="h38-0-97" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h39" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/config/ConfigCategory.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/config/ConfigCategory.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/config/ConfigCategory.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/config/ConfigCategory.kt</a></b>
<a href="#h39-0" id="h39-0" class="h">@@ -1,12 +1,14 @@
</a> package me.rhunk.snapenhance.config
 
 enum class ConfigCategory(
<a href="#h39-0-3" id="h39-0-3" class="d">-    val key: String
</a><a href="#h39-0-4" id="h39-0-4" class="i">+    val key: String,
</a><a href="#h39-0-5" id="h39-0-5" class="i">+    val hidden: Boolean = false
</a> ) {
     SPYING_PRIVACY(&quot;spying_privacy&quot;),
     MEDIA_MANAGEMENT(&quot;media_manager&quot;),
     UI_TWEAKS(&quot;ui_tweaks&quot;),
     UPDATES(&quot;updates&quot;),
     CAMERA(&quot;camera&quot;),
<a href="#h39-0-12" id="h39-0-12" class="d">-    EXPERIMENTAL_DEBUGGING(&quot;experimental_debugging&quot;);
</a><a href="#h39-0-13" id="h39-0-13" class="i">+    EXPERIMENTAL_DEBUGGING(&quot;experimental_debugging&quot;),
</a><a href="#h39-0-14" id="h39-0-14" class="i">+    DEVICE_SPOOFER(&quot;device_spoofer&quot;, hidden = true)
</a> }
<b>diff --git a/<a id="h40" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/config/ConfigProperty.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/config/ConfigProperty.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/config/ConfigProperty.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/config/ConfigProperty.kt</a></b>
<a href="#h40-0" id="h40-0" class="h">@@ -1,18 +1,18 @@
</a> package me.rhunk.snapenhance.config
 
<a href="#h40-0-2" id="h40-0-2" class="d">-import android.os.Environment
</a> import me.rhunk.snapenhance.config.impl.ConfigIntegerValue
 import me.rhunk.snapenhance.config.impl.ConfigStateListValue
 import me.rhunk.snapenhance.config.impl.ConfigStateSelection
 import me.rhunk.snapenhance.config.impl.ConfigStateValue
 import me.rhunk.snapenhance.config.impl.ConfigStringValue
<a href="#h40-0-8" id="h40-0-8" class="i">+import me.rhunk.snapenhance.data.NotificationType
</a> import me.rhunk.snapenhance.features.impl.tweaks.CameraTweaks
<a href="#h40-0-10" id="h40-0-10" class="d">-import java.io.File
</a> 
 enum class ConfigProperty(
     val translationKey: String,
     val category: ConfigCategory,
     val valueContainer: ConfigValue&lt;*&gt;,
<a href="#h40-0-16" id="h40-0-16" class="i">+    val valueContainerTranslationKey: String? = null,
</a>     val shouldAppearInSettings: Boolean = true,
     val disableValueLocalization: Boolean = false
 ) {
<a href="#h40-1" id="h40-1" class="h">@@ -36,11 +36,12 @@ enum class ConfigProperty(
</a>         &quot;better_notifications&quot;,
         ConfigCategory.SPYING_PRIVACY,
         ConfigStateListValue(
<a href="#h40-1-3" id="h40-1-3" class="d">-            listOf(&quot;snap&quot;, &quot;chat&quot;, &quot;reply_button&quot;),
</a><a href="#h40-1-4" id="h40-1-4" class="i">+            listOf(&quot;snap&quot;, &quot;chat&quot;, &quot;reply_button&quot;, &quot;download_button&quot;),
</a>             mutableMapOf(
                 &quot;snap&quot; to false,
                 &quot;chat&quot; to false,
<a href="#h40-1-8" id="h40-1-8" class="d">-                &quot;reply_button&quot; to false
</a><a href="#h40-1-9" id="h40-1-9" class="i">+                &quot;reply_button&quot; to false,
</a><a href="#h40-1-10" id="h40-1-10" class="i">+                &quot;download_button&quot; to false
</a>             )
         )
     ),
<a href="#h40-2" id="h40-2" class="h">@@ -48,13 +49,10 @@ enum class ConfigProperty(
</a>         &quot;notification_blacklist&quot;,
         ConfigCategory.SPYING_PRIVACY,
         ConfigStateListValue(
<a href="#h40-2-3" id="h40-2-3" class="d">-            listOf(&quot;snap&quot;, &quot;chat&quot;, &quot;typing&quot;),
</a><a href="#h40-2-4" id="h40-2-4" class="d">-            mutableMapOf(
</a><a href="#h40-2-5" id="h40-2-5" class="d">-                &quot;snap&quot; to false,
</a><a href="#h40-2-6" id="h40-2-6" class="d">-                &quot;chat&quot; to false,
</a><a href="#h40-2-7" id="h40-2-7" class="d">-                &quot;typing&quot; to false
</a><a href="#h40-2-8" id="h40-2-8" class="d">-            )
</a><a href="#h40-2-9" id="h40-2-9" class="d">-        )
</a><a href="#h40-2-10" id="h40-2-10" class="i">+            NotificationType.getIncomingValues().map { it.key },
</a><a href="#h40-2-11" id="h40-2-11" class="i">+            NotificationType.getIncomingValues().associate { it.key to false }.toMutableMap()
</a><a href="#h40-2-12" id="h40-2-12" class="i">+        ),
</a><a href="#h40-2-13" id="h40-2-13" class="i">+        valueContainerTranslationKey = &quot;notifications&quot;,
</a>     ),
     DISABLE_METRICS(&quot;disable_metrics&quot;,
         ConfigCategory.SPYING_PRIVACY,
<a href="#h40-3" id="h40-3" class="h">@@ -68,15 +66,14 @@ enum class ConfigProperty(
</a>         ConfigCategory.SPYING_PRIVACY,
         ConfigStateValue(false)
     ),
<a href="#h40-3-3" id="h40-3-3" class="d">-    PREVENT_SCREENSHOT_NOTIFICATIONS(
</a><a href="#h40-3-4" id="h40-3-4" class="d">-        &quot;prevent_screenshot_notifications&quot;,
</a><a href="#h40-3-5" id="h40-3-5" class="d">-        ConfigCategory.SPYING_PRIVACY,
</a><a href="#h40-3-6" id="h40-3-6" class="d">-        ConfigStateValue(false)
</a><a href="#h40-3-7" id="h40-3-7" class="d">-    ),
</a><a href="#h40-3-8" id="h40-3-8" class="d">-    PREVENT_STATUS_NOTIFICATIONS(
</a><a href="#h40-3-9" id="h40-3-9" class="d">-        &quot;prevent_status_notifications&quot;,
</a><a href="#h40-3-10" id="h40-3-10" class="i">+    PREVENT_SENDING_MESSAGES(
</a><a href="#h40-3-11" id="h40-3-11" class="i">+        &quot;prevent_sending_messages&quot;,
</a>         ConfigCategory.SPYING_PRIVACY,
<a href="#h40-3-13" id="h40-3-13" class="d">-        ConfigStateValue(false)
</a><a href="#h40-3-14" id="h40-3-14" class="i">+        ConfigStateListValue(
</a><a href="#h40-3-15" id="h40-3-15" class="i">+            NotificationType.getOutgoingValues().map { it.key },
</a><a href="#h40-3-16" id="h40-3-16" class="i">+            NotificationType.getOutgoingValues().associate { it.key to false }.toMutableMap()
</a><a href="#h40-3-17" id="h40-3-17" class="i">+        ),
</a><a href="#h40-3-18" id="h40-3-18" class="i">+        valueContainerTranslationKey = &quot;notifications&quot;,
</a>     ),
     ANONYMOUS_STORY_VIEW(
         &quot;anonymous_story_view&quot;,
<a href="#h40-4" id="h40-4" class="h">@@ -93,10 +90,7 @@ enum class ConfigProperty(
</a>     SAVE_FOLDER(
         &quot;save_folder&quot;,
         ConfigCategory.MEDIA_MANAGEMENT,
<a href="#h40-4-3" id="h40-4-3" class="d">-        ConfigStringValue(File(
</a><a href="#h40-4-4" id="h40-4-4" class="d">-            Environment.getExternalStoragePublicDirectory(Environment.DIRECTORY_DCIM).absolutePath + &quot;/Snapchat&quot;,
</a><a href="#h40-4-5" id="h40-4-5" class="d">-            &quot;SnapEnhance&quot;
</a><a href="#h40-4-6" id="h40-4-6" class="d">-        ).absolutePath)
</a><a href="#h40-4-7" id="h40-4-7" class="i">+        ConfigStringValue(&quot;&quot;,  isFolderPath =true),
</a>     ),
     AUTO_DOWNLOAD_OPTIONS(
         &quot;auto_download_options&quot;,
<a href="#h40-5" id="h40-5" class="h">@@ -160,6 +154,19 @@ enum class ConfigProperty(
</a>         ConfigCategory.MEDIA_MANAGEMENT,
         ConfigStateValue(false)
     ),
<a href="#h40-5-3" id="h40-5-3" class="i">+    DOWNLOAD_LOGGING(
</a><a href="#h40-5-4" id="h40-5-4" class="i">+        &quot;download_logging&quot;,
</a><a href="#h40-5-5" id="h40-5-5" class="i">+        ConfigCategory.MEDIA_MANAGEMENT,
</a><a href="#h40-5-6" id="h40-5-6" class="i">+        ConfigStateListValue(
</a><a href="#h40-5-7" id="h40-5-7" class="i">+            listOf(&quot;started&quot;, &quot;success&quot;, &quot;progress&quot;, &quot;failure&quot;),
</a><a href="#h40-5-8" id="h40-5-8" class="i">+            mutableMapOf(
</a><a href="#h40-5-9" id="h40-5-9" class="i">+                &quot;started&quot; to false,
</a><a href="#h40-5-10" id="h40-5-10" class="i">+                &quot;success&quot; to true,
</a><a href="#h40-5-11" id="h40-5-11" class="i">+                &quot;progress&quot; to false,
</a><a href="#h40-5-12" id="h40-5-12" class="i">+                &quot;failure&quot; to true
</a><a href="#h40-5-13" id="h40-5-13" class="i">+            )
</a><a href="#h40-5-14" id="h40-5-14" class="i">+        )
</a><a href="#h40-5-15" id="h40-5-15" class="i">+    ),
</a>     
     //UI AND TWEAKS
     ENABLE_FRIEND_FEED_MENU_BAR(
<a href="#h40-6" id="h40-6" class="h">@@ -203,8 +210,9 @@ enum class ConfigProperty(
</a>         &quot;hide_story_section&quot;,
         ConfigCategory.UI_TWEAKS,
         ConfigStateListValue(
<a href="#h40-6-3" id="h40-6-3" class="d">-            listOf(&quot;hide_friends&quot;, &quot;hide_following&quot;, &quot;hide_for_you&quot;),
</a><a href="#h40-6-4" id="h40-6-4" class="i">+            listOf(&quot;hide_friend_suggestions&quot;, &quot;hide_friends&quot;, &quot;hide_following&quot;, &quot;hide_for_you&quot;),
</a>             mutableMapOf(
<a href="#h40-6-6" id="h40-6-6" class="i">+                &quot;hide_friend_suggestions&quot; to false,
</a>                 &quot;hide_friends&quot; to false,
                 &quot;hide_following&quot; to false,
                 &quot;hide_for_you&quot; to false
<a href="#h40-7" id="h40-7" class="h">@@ -294,7 +302,11 @@ enum class ConfigProperty(
</a>             &quot;OFF&quot;
         )
     ),
<a href="#h40-7-3" id="h40-7-3" class="d">-
</a><a href="#h40-7-4" id="h40-7-4" class="i">+    DISABLE_GOOGLE_PLAY_DIALOGS(
</a><a href="#h40-7-5" id="h40-7-5" class="i">+        &quot;disable_google_play_dialogs&quot;,
</a><a href="#h40-7-6" id="h40-7-6" class="i">+        ConfigCategory.UI_TWEAKS,
</a><a href="#h40-7-7" id="h40-7-7" class="i">+        ConfigStateValue(false)
</a><a href="#h40-7-8" id="h40-7-8" class="i">+    ),
</a> 
     //CAMERA
     CAMERA_DISABLE(
<a href="#h40-8" id="h40-8" class="h">@@ -376,8 +388,27 @@ enum class ConfigProperty(
</a>         &quot;unlimited_multi_snap&quot;,
         ConfigCategory.EXPERIMENTAL_DEBUGGING,
         ConfigStateValue(false)
<a href="#h40-8-3" id="h40-8-3" class="i">+    ),
</a><a href="#h40-8-4" id="h40-8-4" class="i">+    
</a><a href="#h40-8-5" id="h40-8-5" class="i">+    //DEVICE SPOOFER
</a><a href="#h40-8-6" id="h40-8-6" class="i">+    DEVICE_SPOOF(
</a><a href="#h40-8-7" id="h40-8-7" class="i">+        &quot;device_spoof&quot;,
</a><a href="#h40-8-8" id="h40-8-8" class="i">+        ConfigCategory.DEVICE_SPOOFER,
</a><a href="#h40-8-9" id="h40-8-9" class="i">+        ConfigStateValue(false)
</a><a href="#h40-8-10" id="h40-8-10" class="i">+    ),
</a><a href="#h40-8-11" id="h40-8-11" class="i">+    FINGERPRINT(
</a><a href="#h40-8-12" id="h40-8-12" class="i">+        &quot;device_fingerprint&quot;,
</a><a href="#h40-8-13" id="h40-8-13" class="i">+        ConfigCategory.DEVICE_SPOOFER,
</a><a href="#h40-8-14" id="h40-8-14" class="i">+        ConfigStringValue(&quot;&quot;)
</a><a href="#h40-8-15" id="h40-8-15" class="i">+    ),
</a><a href="#h40-8-16" id="h40-8-16" class="i">+    ANDROID_ID(
</a><a href="#h40-8-17" id="h40-8-17" class="i">+        &quot;android_id&quot;,
</a><a href="#h40-8-18" id="h40-8-18" class="i">+        ConfigCategory.DEVICE_SPOOFER,
</a><a href="#h40-8-19" id="h40-8-19" class="i">+        ConfigStringValue(&quot;&quot;)
</a>     );
 
<a href="#h40-8-22" id="h40-8-22" class="i">+    fun getOptionTranslationKey(key: String) = &quot;option.property.${valueContainerTranslationKey ?: translationKey}.$key&quot;
</a><a href="#h40-8-23" id="h40-8-23" class="i">+
</a>     companion object {
         fun sortedByCategory(): List&lt;ConfigProperty&gt; {
             return values().sortedBy { it.category.ordinal }
<b>diff --git a/<a id="h41" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/config/impl/ConfigStringValue.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/config/impl/ConfigStringValue.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/config/impl/ConfigStringValue.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/config/impl/ConfigStringValue.kt</a></b>
<a href="#h41-0" id="h41-0" class="h">@@ -4,6 +4,7 @@ import me.rhunk.snapenhance.config.ConfigValue
</a> 
 class ConfigStringValue(
     private var value: String = &quot;&quot;,
<a href="#h41-0-3" id="h41-0-3" class="i">+    val isFolderPath: Boolean = false,
</a>     val isHidden: Boolean = false
 ) : ConfigValue&lt;String&gt;() {
     override fun value() = value
<b>diff --git a/<a id="h42" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/data/FileType.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/data/FileType.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/data/FileType.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/data/FileType.kt</a></b>
<a href="#h42-0" id="h42-0" class="h">@@ -1,6 +1,7 @@
</a> package me.rhunk.snapenhance.data
 
 import java.io.File
<a href="#h42-0-3" id="h42-0-3" class="i">+import java.io.InputStream
</a> 
 enum class FileType(
     val fileExtension: String? = null,
<a href="#h42-1" id="h42-1" class="h">@@ -58,5 +59,11 @@ enum class FileType(
</a>             val hex = bytesToHex(headerBytes)
             return fileSignatures.entries.firstOrNull { hex.startsWith(it.key) }?.value ?: UNKNOWN
         }
<a href="#h42-1-3" id="h42-1-3" class="i">+
</a><a href="#h42-1-4" id="h42-1-4" class="i">+        fun fromInputStream(inputStream: InputStream): FileType {
</a><a href="#h42-1-5" id="h42-1-5" class="i">+            val buffer = ByteArray(16)
</a><a href="#h42-1-6" id="h42-1-6" class="i">+            inputStream.read(buffer)
</a><a href="#h42-1-7" id="h42-1-7" class="i">+            return fromByteArray(buffer)
</a><a href="#h42-1-8" id="h42-1-8" class="i">+        }
</a>     }
 }
<b>diff --git a/<a id="h43" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/data/SnapEnums.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/data/SnapEnums.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/data/SnapEnums.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/data/SnapEnums.kt</a></b>
<a href="#h43-0" id="h43-0" class="h">@@ -4,39 +4,39 @@ enum class MessageState {
</a>     PREPARING, SENDING, COMMITTED, FAILED, CANCELING
 }
 
<a href="#h43-0-3" id="h43-0-3" class="d">-enum class ChatMediaType (
</a><a href="#h43-0-4" id="h43-0-4" class="d">-    val value: Int
</a><a href="#h43-0-5" id="h43-0-5" class="i">+enum class NotificationType (
</a><a href="#h43-0-6" id="h43-0-6" class="i">+    val key: String,
</a><a href="#h43-0-7" id="h43-0-7" class="i">+    val isIncoming: Boolean = false,
</a><a href="#h43-0-8" id="h43-0-8" class="i">+    val associatedOutgoingContentType: ContentType? = null,
</a> ) {
<a href="#h43-0-10" id="h43-0-10" class="d">-    IMAGE(0),
</a><a href="#h43-0-11" id="h43-0-11" class="d">-    VIDEO(1),
</a><a href="#h43-0-12" id="h43-0-12" class="d">-    VIDEO_NO_SOUND(2),
</a><a href="#h43-0-13" id="h43-0-13" class="d">-    FRIEND_DEPRECATED(3),
</a><a href="#h43-0-14" id="h43-0-14" class="d">-    BLOB(4),
</a><a href="#h43-0-15" id="h43-0-15" class="d">-    LAGUNA_SOUND(5),
</a><a href="#h43-0-16" id="h43-0-16" class="d">-    LAGUNA_NO_SOUND(6),
</a><a href="#h43-0-17" id="h43-0-17" class="d">-    GIF(7),
</a><a href="#h43-0-18" id="h43-0-18" class="d">-    FINGERPRINT_HEADER_SIZE(8),
</a><a href="#h43-0-19" id="h43-0-19" class="d">-    AUDIO_STITCH(9),
</a><a href="#h43-0-20" id="h43-0-20" class="d">-    PSYCHOMANTIS(10),
</a><a href="#h43-0-21" id="h43-0-21" class="d">-    SCREAMINGMANTIS(11),
</a><a href="#h43-0-22" id="h43-0-22" class="d">-    MALIBU_SOUND(12),
</a><a href="#h43-0-23" id="h43-0-23" class="d">-    MALIBU_NO_SOUND(13),
</a><a href="#h43-0-24" id="h43-0-24" class="d">-    LAGUNAHD_SOUND(14),
</a><a href="#h43-0-25" id="h43-0-25" class="d">-    LAGUNAHD_NO_SOUND(15),
</a><a href="#h43-0-26" id="h43-0-26" class="d">-    GHOSTMANTIS(16),
</a><a href="#h43-0-27" id="h43-0-27" class="d">-    NEWPORT_SOUND(17),
</a><a href="#h43-0-28" id="h43-0-28" class="d">-    NEWPORT_NO_SOUND(18),
</a><a href="#h43-0-29" id="h43-0-29" class="d">-    AUDIO(19),
</a><a href="#h43-0-30" id="h43-0-30" class="d">-    BLOOP(20),
</a><a href="#h43-0-31" id="h43-0-31" class="d">-    SPECTACLES_IMAGE(21),
</a><a href="#h43-0-32" id="h43-0-32" class="d">-    SPECTACLES_VIDEO(22),
</a><a href="#h43-0-33" id="h43-0-33" class="d">-    SPECTACLES_VIDEO_NO_SOUND(23),
</a><a href="#h43-0-34" id="h43-0-34" class="d">-    CHEERIOS_IMAGE(24),
</a><a href="#h43-0-35" id="h43-0-35" class="d">-    CHEERIOS_VIDEO_SOUND(25),
</a><a href="#h43-0-36" id="h43-0-36" class="d">-    CHEERIOS_VIDEO_NO_SOUND(26),
</a><a href="#h43-0-37" id="h43-0-37" class="d">-    WEB(27),
</a><a href="#h43-0-38" id="h43-0-38" class="d">-    UNRECOGNIZED_VALUE(-9999);
</a><a href="#h43-0-39" id="h43-0-39" class="i">+    SCREENSHOT(&quot;chat_screenshot&quot;, true, ContentType.STATUS_CONVERSATION_CAPTURE_SCREENSHOT),
</a><a href="#h43-0-40" id="h43-0-40" class="i">+    SCREEN_RECORD(&quot;chat_screen_record&quot;, true, ContentType.STATUS_CONVERSATION_CAPTURE_RECORD),
</a><a href="#h43-0-41" id="h43-0-41" class="i">+    CAMERA_ROLL_SAVE(&quot;camera_roll_save&quot;, true, ContentType.STATUS_SAVE_TO_CAMERA_ROLL),
</a><a href="#h43-0-42" id="h43-0-42" class="i">+    SNAP(&quot;snap&quot;,true),
</a><a href="#h43-0-43" id="h43-0-43" class="i">+    CHAT(&quot;chat&quot;,true),
</a><a href="#h43-0-44" id="h43-0-44" class="i">+    CHAT_REPLY(&quot;chat_reply&quot;,true),
</a><a href="#h43-0-45" id="h43-0-45" class="i">+    TYPING(&quot;typing&quot;, true),
</a><a href="#h43-0-46" id="h43-0-46" class="i">+    STORIES(&quot;stories&quot;,true),
</a><a href="#h43-0-47" id="h43-0-47" class="i">+    INITIATE_AUDIO(&quot;initiate_audio&quot;,true),
</a><a href="#h43-0-48" id="h43-0-48" class="i">+    ABANDON_AUDIO(&quot;abandon_audio&quot;, false, ContentType.STATUS_CALL_MISSED_AUDIO),
</a><a href="#h43-0-49" id="h43-0-49" class="i">+    INITIATE_VIDEO(&quot;initiate_video&quot;,true),
</a><a href="#h43-0-50" id="h43-0-50" class="i">+    ABANDON_VIDEO(&quot;abandon_video&quot;, false, ContentType.STATUS_CALL_MISSED_VIDEO);
</a><a href="#h43-0-51" id="h43-0-51" class="i">+
</a><a href="#h43-0-52" id="h43-0-52" class="i">+    companion object {
</a><a href="#h43-0-53" id="h43-0-53" class="i">+        fun getIncomingValues(): List&lt;NotificationType&gt; {
</a><a href="#h43-0-54" id="h43-0-54" class="i">+            return values().filter { it.isIncoming }.toList()
</a><a href="#h43-0-55" id="h43-0-55" class="i">+        }
</a><a href="#h43-0-56" id="h43-0-56" class="i">+
</a><a href="#h43-0-57" id="h43-0-57" class="i">+        fun getOutgoingValues(): List&lt;NotificationType&gt; {
</a><a href="#h43-0-58" id="h43-0-58" class="i">+            return values().filter { it.associatedOutgoingContentType != null }.toList()
</a><a href="#h43-0-59" id="h43-0-59" class="i">+        }
</a><a href="#h43-0-60" id="h43-0-60" class="i">+
</a><a href="#h43-0-61" id="h43-0-61" class="i">+        fun fromContentType(contentType: ContentType): NotificationType? {
</a><a href="#h43-0-62" id="h43-0-62" class="i">+            return values().firstOrNull { it.associatedOutgoingContentType == contentType }
</a><a href="#h43-0-63" id="h43-0-63" class="i">+        }
</a><a href="#h43-0-64" id="h43-0-64" class="i">+    }
</a> }
<a href="#h43-0-66" id="h43-0-66" class="i">+
</a> enum class ContentType(val id: Int) {
     UNKNOWN(-1),
     SNAP(0),
<a href="#h43-1" id="h43-1" class="h">@@ -56,7 +56,8 @@ enum class ContentType(val id: Int) {
</a>     CREATIVE_TOOL_ITEM(14),
     FAMILY_CENTER_INVITE(15),
     FAMILY_CENTER_ACCEPT(16),
<a href="#h43-1-3" id="h43-1-3" class="d">-    FAMILY_CENTER_LEAVE(17);
</a><a href="#h43-1-4" id="h43-1-4" class="i">+    FAMILY_CENTER_LEAVE(17),
</a><a href="#h43-1-5" id="h43-1-5" class="i">+    STATUS_PLUS_GIFT(18);
</a> 
     companion object {
         fun fromId(i: Int): ContentType {
<b>diff --git a/<a id="h44" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/MessageDestinations.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/MessageDestinations.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/MessageDestinations.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/MessageDestinations.kt</a></b>
<a href="#h44-0" id="h44-0" class="h">@@ -4,6 +4,7 @@ import me.rhunk.snapenhance.data.wrapper.AbstractWrapper
</a> import me.rhunk.snapenhance.util.getObjectField
 import me.rhunk.snapenhance.util.setObjectField
 
<a href="#h44-0-3" id="h44-0-3" class="i">+@Suppress(&quot;UNCHECKED_CAST&quot;)
</a> class MessageDestinations(obj: Any) : AbstractWrapper(obj){
     var conversations get() = (instanceNonNull().getObjectField(&quot;mConversations&quot;) as ArrayList&lt;*&gt;).map { SnapUUID(it) }
         set(value) = instanceNonNull().setObjectField(&quot;mConversations&quot;, value.map { it.instanceNonNull() }.toCollection(ArrayList()))
<b>diff --git a/<a id="h45" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadManagerClient.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadManagerClient.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadManagerClient.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadManagerClient.kt</a></b>
<a href="#h45-0" id="h45-0" class="h">@@ -2,83 +2,63 @@ package me.rhunk.snapenhance.download
</a> 
 import android.content.Intent
 import android.os.Bundle
<a href="#h45-0-3" id="h45-0-3" class="d">-import me.rhunk.snapenhance.BuildConfig
</a> import me.rhunk.snapenhance.ModContext
<a href="#h45-0-5" id="h45-0-5" class="i">+import me.rhunk.snapenhance.bridge.DownloadCallback
</a><a href="#h45-0-6" id="h45-0-6" class="i">+import me.rhunk.snapenhance.download.data.DashOptions
</a><a href="#h45-0-7" id="h45-0-7" class="i">+import me.rhunk.snapenhance.download.data.DownloadMetadata
</a> import me.rhunk.snapenhance.download.data.DownloadRequest
<a href="#h45-0-9" id="h45-0-9" class="i">+import me.rhunk.snapenhance.download.data.InputMedia
</a> import me.rhunk.snapenhance.download.data.MediaEncryptionKeyPair
 import me.rhunk.snapenhance.download.enums.DownloadMediaType
 
 class DownloadManagerClient (
     private val context: ModContext,
<a href="#h45-0-15" id="h45-0-15" class="d">-    private val outputPath: String,
</a><a href="#h45-0-16" id="h45-0-16" class="d">-    private val mediaDisplaySource: String?,
</a><a href="#h45-0-17" id="h45-0-17" class="d">-    private val mediaDisplayType: String?,
</a><a href="#h45-0-18" id="h45-0-18" class="d">-    private val iconUrl: String?,
</a><a href="#h45-0-19" id="h45-0-19" class="d">-    private val uniqueHash: String?
</a><a href="#h45-0-20" id="h45-0-20" class="i">+    private val metadata: DownloadMetadata,
</a><a href="#h45-0-21" id="h45-0-21" class="i">+    private val callback: DownloadCallback
</a> ) {
<a href="#h45-0-23" id="h45-0-23" class="d">-    private fun sendToBroadcastReceiver(bundle: Bundle) {
</a><a href="#h45-0-24" id="h45-0-24" class="d">-        val intent = Intent()
</a><a href="#h45-0-25" id="h45-0-25" class="d">-        intent.setClassName(BuildConfig.APPLICATION_ID, DownloadManagerReceiver::class.java.name)
</a><a href="#h45-0-26" id="h45-0-26" class="d">-        intent.action = DownloadManagerReceiver.DOWNLOAD_ACTION
</a><a href="#h45-0-27" id="h45-0-27" class="d">-        intent.putExtras(bundle)
</a><a href="#h45-0-28" id="h45-0-28" class="d">-        context.androidContext.sendBroadcast(intent)
</a><a href="#h45-0-29" id="h45-0-29" class="d">-    }
</a><a href="#h45-0-30" id="h45-0-30" class="d">-
</a><a href="#h45-0-31" id="h45-0-31" class="d">-    private fun sendToBroadcastReceiver(
</a><a href="#h45-0-32" id="h45-0-32" class="d">-        request: DownloadRequest,
</a><a href="#h45-0-33" id="h45-0-33" class="d">-        extras: Bundle.() -&gt; Unit = {}
</a><a href="#h45-0-34" id="h45-0-34" class="d">-    ) {
</a><a href="#h45-0-35" id="h45-0-35" class="d">-        sendToBroadcastReceiver(request.toBundle().apply {
</a><a href="#h45-0-36" id="h45-0-36" class="d">-            putString(&quot;outputPath&quot;, outputPath)
</a><a href="#h45-0-37" id="h45-0-37" class="d">-            putString(&quot;mediaDisplaySource&quot;, mediaDisplaySource)
</a><a href="#h45-0-38" id="h45-0-38" class="d">-            putString(&quot;mediaDisplayType&quot;, mediaDisplayType)
</a><a href="#h45-0-39" id="h45-0-39" class="d">-            putString(&quot;iconUrl&quot;, iconUrl)
</a><a href="#h45-0-40" id="h45-0-40" class="d">-            putString(&quot;uniqueHash&quot;, uniqueHash)
</a><a href="#h45-0-41" id="h45-0-41" class="d">-        }.apply(extras))
</a><a href="#h45-0-42" id="h45-0-42" class="i">+    private fun enqueueDownloadRequest(request: DownloadRequest) {
</a><a href="#h45-0-43" id="h45-0-43" class="i">+        context.bridgeClient.enqueueDownload(Intent().apply {
</a><a href="#h45-0-44" id="h45-0-44" class="i">+            putExtras(Bundle().apply {
</a><a href="#h45-0-45" id="h45-0-45" class="i">+                putString(DownloadProcessor.DOWNLOAD_REQUEST_EXTRA, context.gson.toJson(request))
</a><a href="#h45-0-46" id="h45-0-46" class="i">+                putString(DownloadProcessor.DOWNLOAD_METADATA_EXTRA, context.gson.toJson(metadata))
</a><a href="#h45-0-47" id="h45-0-47" class="i">+            })
</a><a href="#h45-0-48" id="h45-0-48" class="i">+        }, callback)
</a>     }
 
     fun downloadDashMedia(playlistUrl: String, offsetTime: Long, duration: Long?) {
<a href="#h45-0-52" id="h45-0-52" class="d">-        sendToBroadcastReceiver(
</a><a href="#h45-0-53" id="h45-0-53" class="i">+        enqueueDownloadRequest(
</a>             DownloadRequest(
<a href="#h45-0-55" id="h45-0-55" class="d">-                inputMedias = arrayOf(playlistUrl),
</a><a href="#h45-0-56" id="h45-0-56" class="d">-                inputTypes = arrayOf(DownloadMediaType.REMOTE_MEDIA.name),
</a><a href="#h45-0-57" id="h45-0-57" class="i">+                inputMedias = arrayOf(InputMedia(
</a><a href="#h45-0-58" id="h45-0-58" class="i">+                    content = playlistUrl,
</a><a href="#h45-0-59" id="h45-0-59" class="i">+                    type = DownloadMediaType.REMOTE_MEDIA
</a><a href="#h45-0-60" id="h45-0-60" class="i">+                )),
</a><a href="#h45-0-61" id="h45-0-61" class="i">+                dashOptions = DashOptions(offsetTime, duration),
</a>                 flags = DownloadRequest.Flags.IS_DASH_PLAYLIST
             )
<a href="#h45-0-64" id="h45-0-64" class="d">-        ) {
</a><a href="#h45-0-65" id="h45-0-65" class="d">-            putBundle(&quot;dashOptions&quot;, Bundle().apply {
</a><a href="#h45-0-66" id="h45-0-66" class="d">-                putString(&quot;offsetTime&quot;, offsetTime.toString())
</a><a href="#h45-0-67" id="h45-0-67" class="d">-                duration?.let { putString(&quot;duration&quot;, it.toString()) }
</a><a href="#h45-0-68" id="h45-0-68" class="d">-            })
</a><a href="#h45-0-69" id="h45-0-69" class="d">-        }
</a><a href="#h45-0-70" id="h45-0-70" class="i">+        )
</a>     }
 
<a href="#h45-0-73" id="h45-0-73" class="d">-    fun downloadMedia(mediaData: String, mediaType: DownloadMediaType, encryption: MediaEncryptionKeyPair? = null) {
</a><a href="#h45-0-74" id="h45-0-74" class="d">-        sendToBroadcastReceiver(
</a><a href="#h45-0-75" id="h45-0-75" class="i">+    fun downloadSingleMedia(mediaData: String, mediaType: DownloadMediaType, encryption: MediaEncryptionKeyPair? = null) {
</a><a href="#h45-0-76" id="h45-0-76" class="i">+        enqueueDownloadRequest(
</a>             DownloadRequest(
<a href="#h45-0-78" id="h45-0-78" class="d">-                inputMedias = arrayOf(mediaData),
</a><a href="#h45-0-79" id="h45-0-79" class="d">-                inputTypes = arrayOf(mediaType.name),
</a><a href="#h45-0-80" id="h45-0-80" class="d">-                mediaEncryption = if (encryption != null) mapOf(mediaData to encryption) else mapOf()
</a><a href="#h45-0-81" id="h45-0-81" class="i">+                inputMedias = arrayOf(InputMedia(
</a><a href="#h45-0-82" id="h45-0-82" class="i">+                    content = mediaData,
</a><a href="#h45-0-83" id="h45-0-83" class="i">+                    type = mediaType,
</a><a href="#h45-0-84" id="h45-0-84" class="i">+                    encryption = encryption
</a><a href="#h45-0-85" id="h45-0-85" class="i">+                ))
</a>             )
         )
     }
 
     fun downloadMediaWithOverlay(
<a href="#h45-0-91" id="h45-0-91" class="d">-        videoData: String,
</a><a href="#h45-0-92" id="h45-0-92" class="d">-        overlayData: String,
</a><a href="#h45-0-93" id="h45-0-93" class="d">-        videoType: DownloadMediaType = DownloadMediaType.LOCAL_MEDIA,
</a><a href="#h45-0-94" id="h45-0-94" class="d">-        overlayType: DownloadMediaType = DownloadMediaType.LOCAL_MEDIA,
</a><a href="#h45-0-95" id="h45-0-95" class="d">-        videoEncryption: MediaEncryptionKeyPair? = null,
</a><a href="#h45-0-96" id="h45-0-96" class="d">-        overlayEncryption: MediaEncryptionKeyPair? = null)
</a><a href="#h45-0-97" id="h45-0-97" class="d">-    {
</a><a href="#h45-0-98" id="h45-0-98" class="d">-        val encryptionMap = mutableMapOf&lt;String, MediaEncryptionKeyPair&gt;()
</a><a href="#h45-0-99" id="h45-0-99" class="d">-
</a><a href="#h45-0-100" id="h45-0-100" class="d">-        if (videoEncryption != null) encryptionMap[videoData] = videoEncryption
</a><a href="#h45-0-101" id="h45-0-101" class="d">-        if (overlayEncryption != null) encryptionMap[overlayData] = overlayEncryption
</a><a href="#h45-0-102" id="h45-0-102" class="d">-        sendToBroadcastReceiver(DownloadRequest(
</a><a href="#h45-0-103" id="h45-0-103" class="d">-            inputMedias = arrayOf(videoData, overlayData),
</a><a href="#h45-0-104" id="h45-0-104" class="d">-            inputTypes = arrayOf(videoType.name, overlayType.name),
</a><a href="#h45-0-105" id="h45-0-105" class="d">-            mediaEncryption = encryptionMap,
</a><a href="#h45-0-106" id="h45-0-106" class="d">-            flags = DownloadRequest.Flags.SHOULD_MERGE_OVERLAY
</a><a href="#h45-0-107" id="h45-0-107" class="d">-        ))
</a><a href="#h45-0-108" id="h45-0-108" class="i">+        original: InputMedia,
</a><a href="#h45-0-109" id="h45-0-109" class="i">+        overlay: InputMedia,
</a><a href="#h45-0-110" id="h45-0-110" class="i">+    ) {
</a><a href="#h45-0-111" id="h45-0-111" class="i">+        enqueueDownloadRequest(
</a><a href="#h45-0-112" id="h45-0-112" class="i">+            DownloadRequest(
</a><a href="#h45-0-113" id="h45-0-113" class="i">+                inputMedias = arrayOf(original, overlay),
</a><a href="#h45-0-114" id="h45-0-114" class="i">+                flags = DownloadRequest.Flags.MERGE_OVERLAY
</a><a href="#h45-0-115" id="h45-0-115" class="i">+            )
</a><a href="#h45-0-116" id="h45-0-116" class="i">+        )
</a>     }
 } 
\ No newline at end of file
<b>diff --git a/<a id="h46" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadManagerReceiver.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadManagerReceiver.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadManagerReceiver.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadManagerReceiver.kt</a></b>
<a href="#h46-0" id="h46-0" class="h">@@ -1,364 +0,0 @@
</a><a href="#h46-0-0" id="h46-0-0" class="d">-package me.rhunk.snapenhance.download
</a><a href="#h46-0-1" id="h46-0-1" class="d">-
</a><a href="#h46-0-2" id="h46-0-2" class="d">-import android.annotation.SuppressLint
</a><a href="#h46-0-3" id="h46-0-3" class="d">-import android.content.BroadcastReceiver
</a><a href="#h46-0-4" id="h46-0-4" class="d">-import android.content.Context
</a><a href="#h46-0-5" id="h46-0-5" class="d">-import android.content.Intent
</a><a href="#h46-0-6" id="h46-0-6" class="d">-import android.net.Uri
</a><a href="#h46-0-7" id="h46-0-7" class="d">-import android.os.Handler
</a><a href="#h46-0-8" id="h46-0-8" class="d">-import android.widget.Toast
</a><a href="#h46-0-9" id="h46-0-9" class="d">-import kotlinx.coroutines.CoroutineScope
</a><a href="#h46-0-10" id="h46-0-10" class="d">-import kotlinx.coroutines.Dispatchers
</a><a href="#h46-0-11" id="h46-0-11" class="d">-import kotlinx.coroutines.Job
</a><a href="#h46-0-12" id="h46-0-12" class="d">-import kotlinx.coroutines.job
</a><a href="#h46-0-13" id="h46-0-13" class="d">-import kotlinx.coroutines.joinAll
</a><a href="#h46-0-14" id="h46-0-14" class="d">-import kotlinx.coroutines.launch
</a><a href="#h46-0-15" id="h46-0-15" class="d">-import kotlinx.coroutines.runBlocking
</a><a href="#h46-0-16" id="h46-0-16" class="d">-import me.rhunk.snapenhance.Constants
</a><a href="#h46-0-17" id="h46-0-17" class="d">-import me.rhunk.snapenhance.Logger
</a><a href="#h46-0-18" id="h46-0-18" class="d">-import me.rhunk.snapenhance.SharedContext
</a><a href="#h46-0-19" id="h46-0-19" class="d">-import me.rhunk.snapenhance.data.FileType
</a><a href="#h46-0-20" id="h46-0-20" class="d">-import me.rhunk.snapenhance.download.data.DownloadRequest
</a><a href="#h46-0-21" id="h46-0-21" class="d">-import me.rhunk.snapenhance.download.data.InputMedia
</a><a href="#h46-0-22" id="h46-0-22" class="d">-import me.rhunk.snapenhance.download.data.MediaEncryptionKeyPair
</a><a href="#h46-0-23" id="h46-0-23" class="d">-import me.rhunk.snapenhance.download.data.PendingDownload
</a><a href="#h46-0-24" id="h46-0-24" class="d">-import me.rhunk.snapenhance.download.enums.DownloadMediaType
</a><a href="#h46-0-25" id="h46-0-25" class="d">-import me.rhunk.snapenhance.download.enums.DownloadStage
</a><a href="#h46-0-26" id="h46-0-26" class="d">-import me.rhunk.snapenhance.util.download.RemoteMediaResolver
</a><a href="#h46-0-27" id="h46-0-27" class="d">-import me.rhunk.snapenhance.util.snap.MediaDownloaderHelper
</a><a href="#h46-0-28" id="h46-0-28" class="d">-import java.io.File
</a><a href="#h46-0-29" id="h46-0-29" class="d">-import java.io.InputStream
</a><a href="#h46-0-30" id="h46-0-30" class="d">-import java.net.HttpURLConnection
</a><a href="#h46-0-31" id="h46-0-31" class="d">-import java.net.URL
</a><a href="#h46-0-32" id="h46-0-32" class="d">-import java.util.zip.ZipInputStream
</a><a href="#h46-0-33" id="h46-0-33" class="d">-import javax.crypto.Cipher
</a><a href="#h46-0-34" id="h46-0-34" class="d">-import javax.crypto.CipherInputStream
</a><a href="#h46-0-35" id="h46-0-35" class="d">-import javax.crypto.spec.IvParameterSpec
</a><a href="#h46-0-36" id="h46-0-36" class="d">-import javax.crypto.spec.SecretKeySpec
</a><a href="#h46-0-37" id="h46-0-37" class="d">-import javax.xml.parsers.DocumentBuilderFactory
</a><a href="#h46-0-38" id="h46-0-38" class="d">-import javax.xml.transform.TransformerFactory
</a><a href="#h46-0-39" id="h46-0-39" class="d">-import javax.xml.transform.dom.DOMSource
</a><a href="#h46-0-40" id="h46-0-40" class="d">-import javax.xml.transform.stream.StreamResult
</a><a href="#h46-0-41" id="h46-0-41" class="d">-import kotlin.coroutines.coroutineContext
</a><a href="#h46-0-42" id="h46-0-42" class="d">-import kotlin.io.encoding.Base64
</a><a href="#h46-0-43" id="h46-0-43" class="d">-import kotlin.io.encoding.ExperimentalEncodingApi
</a><a href="#h46-0-44" id="h46-0-44" class="d">-
</a><a href="#h46-0-45" id="h46-0-45" class="d">-data class DownloadedFile(
</a><a href="#h46-0-46" id="h46-0-46" class="d">-    val file: File,
</a><a href="#h46-0-47" id="h46-0-47" class="d">-    val fileType: FileType
</a><a href="#h46-0-48" id="h46-0-48" class="d">-)
</a><a href="#h46-0-49" id="h46-0-49" class="d">-
</a><a href="#h46-0-50" id="h46-0-50" class="d">-/**
</a><a href="#h46-0-51" id="h46-0-51" class="d">- * DownloadManagerReceiver handles the download requests of the user
</a><a href="#h46-0-52" id="h46-0-52" class="d">- */
</a><a href="#h46-0-53" id="h46-0-53" class="d">-@OptIn(ExperimentalEncodingApi::class)
</a><a href="#h46-0-54" id="h46-0-54" class="d">-class DownloadManagerReceiver : BroadcastReceiver() {
</a><a href="#h46-0-55" id="h46-0-55" class="d">-    companion object {
</a><a href="#h46-0-56" id="h46-0-56" class="d">-        const val DOWNLOAD_ACTION = &quot;me.rhunk.snapenhance.download.DownloadManagerReceiver.DOWNLOAD_ACTION&quot;
</a><a href="#h46-0-57" id="h46-0-57" class="d">-    }
</a><a href="#h46-0-58" id="h46-0-58" class="d">-
</a><a href="#h46-0-59" id="h46-0-59" class="d">-    private val translation by lazy {
</a><a href="#h46-0-60" id="h46-0-60" class="d">-        SharedContext.translation.getCategory(&quot;download_manager_receiver&quot;)
</a><a href="#h46-0-61" id="h46-0-61" class="d">-    }
</a><a href="#h46-0-62" id="h46-0-62" class="d">-
</a><a href="#h46-0-63" id="h46-0-63" class="d">-    private lateinit var context: Context
</a><a href="#h46-0-64" id="h46-0-64" class="d">-
</a><a href="#h46-0-65" id="h46-0-65" class="d">-    private fun runOnUIThread(block: () -&gt; Unit) {
</a><a href="#h46-0-66" id="h46-0-66" class="d">-        Handler(context.mainLooper).post(block)
</a><a href="#h46-0-67" id="h46-0-67" class="d">-    }
</a><a href="#h46-0-68" id="h46-0-68" class="d">-
</a><a href="#h46-0-69" id="h46-0-69" class="d">-    private fun shortToast(text: String) {
</a><a href="#h46-0-70" id="h46-0-70" class="d">-        runOnUIThread {
</a><a href="#h46-0-71" id="h46-0-71" class="d">-            Toast.makeText(context, text, Toast.LENGTH_SHORT).show()
</a><a href="#h46-0-72" id="h46-0-72" class="d">-        }
</a><a href="#h46-0-73" id="h46-0-73" class="d">-    }
</a><a href="#h46-0-74" id="h46-0-74" class="d">-
</a><a href="#h46-0-75" id="h46-0-75" class="d">-    private fun longToast(text: String) {
</a><a href="#h46-0-76" id="h46-0-76" class="d">-        runOnUIThread {
</a><a href="#h46-0-77" id="h46-0-77" class="d">-            Toast.makeText(context, text, Toast.LENGTH_LONG).show()
</a><a href="#h46-0-78" id="h46-0-78" class="d">-        }
</a><a href="#h46-0-79" id="h46-0-79" class="d">-    }
</a><a href="#h46-0-80" id="h46-0-80" class="d">-
</a><a href="#h46-0-81" id="h46-0-81" class="d">-    private fun extractZip(inputStream: InputStream): List&lt;File&gt; {
</a><a href="#h46-0-82" id="h46-0-82" class="d">-        val files = mutableListOf&lt;File&gt;()
</a><a href="#h46-0-83" id="h46-0-83" class="d">-        val zipInputStream = ZipInputStream(inputStream)
</a><a href="#h46-0-84" id="h46-0-84" class="d">-        var entry = zipInputStream.nextEntry
</a><a href="#h46-0-85" id="h46-0-85" class="d">-
</a><a href="#h46-0-86" id="h46-0-86" class="d">-        while (entry != null) {
</a><a href="#h46-0-87" id="h46-0-87" class="d">-            createMediaTempFile().also { file -&gt;
</a><a href="#h46-0-88" id="h46-0-88" class="d">-                file.outputStream().use { outputStream -&gt;
</a><a href="#h46-0-89" id="h46-0-89" class="d">-                    zipInputStream.copyTo(outputStream)
</a><a href="#h46-0-90" id="h46-0-90" class="d">-                }
</a><a href="#h46-0-91" id="h46-0-91" class="d">-                files += file
</a><a href="#h46-0-92" id="h46-0-92" class="d">-            }
</a><a href="#h46-0-93" id="h46-0-93" class="d">-            entry = zipInputStream.nextEntry
</a><a href="#h46-0-94" id="h46-0-94" class="d">-        }
</a><a href="#h46-0-95" id="h46-0-95" class="d">-
</a><a href="#h46-0-96" id="h46-0-96" class="d">-        return files
</a><a href="#h46-0-97" id="h46-0-97" class="d">-    }
</a><a href="#h46-0-98" id="h46-0-98" class="d">-
</a><a href="#h46-0-99" id="h46-0-99" class="d">-    private fun decryptInputStream(inputStream: InputStream, encryption: MediaEncryptionKeyPair): InputStream {
</a><a href="#h46-0-100" id="h46-0-100" class="d">-        val cipher = Cipher.getInstance(&quot;AES/CBC/PKCS5Padding&quot;)
</a><a href="#h46-0-101" id="h46-0-101" class="d">-        val key = Base64.UrlSafe.decode(encryption.key)
</a><a href="#h46-0-102" id="h46-0-102" class="d">-        val iv = Base64.UrlSafe.decode(encryption.iv)
</a><a href="#h46-0-103" id="h46-0-103" class="d">-        cipher.init(Cipher.DECRYPT_MODE, SecretKeySpec(key, &quot;AES&quot;), IvParameterSpec(iv))
</a><a href="#h46-0-104" id="h46-0-104" class="d">-        return CipherInputStream(inputStream, cipher)
</a><a href="#h46-0-105" id="h46-0-105" class="d">-    }
</a><a href="#h46-0-106" id="h46-0-106" class="d">-
</a><a href="#h46-0-107" id="h46-0-107" class="d">-    private fun createNeededDirectories(file: File): File {
</a><a href="#h46-0-108" id="h46-0-108" class="d">-        val directory = file.parentFile ?: return file
</a><a href="#h46-0-109" id="h46-0-109" class="d">-        if (!directory.exists()) {
</a><a href="#h46-0-110" id="h46-0-110" class="d">-            directory.mkdirs()
</a><a href="#h46-0-111" id="h46-0-111" class="d">-        }
</a><a href="#h46-0-112" id="h46-0-112" class="d">-        return file
</a><a href="#h46-0-113" id="h46-0-113" class="d">-    }
</a><a href="#h46-0-114" id="h46-0-114" class="d">-
</a><a href="#h46-0-115" id="h46-0-115" class="d">-    @SuppressLint(&quot;UnspecifiedRegisterReceiverFlag&quot;)
</a><a href="#h46-0-116" id="h46-0-116" class="d">-    private suspend fun saveMediaToGallery(inputFile: File, pendingDownload: PendingDownload) {
</a><a href="#h46-0-117" id="h46-0-117" class="d">-        if (coroutineContext.job.isCancelled) return
</a><a href="#h46-0-118" id="h46-0-118" class="d">-
</a><a href="#h46-0-119" id="h46-0-119" class="d">-        runCatching {
</a><a href="#h46-0-120" id="h46-0-120" class="d">-            val fileType = FileType.fromFile(inputFile)
</a><a href="#h46-0-121" id="h46-0-121" class="d">-            if (fileType == FileType.UNKNOWN) {
</a><a href="#h46-0-122" id="h46-0-122" class="d">-                longToast(translation.format(&quot;failed_gallery_toast&quot;, &quot;error&quot; to &quot;Unknown media type&quot;))
</a><a href="#h46-0-123" id="h46-0-123" class="d">-                return
</a><a href="#h46-0-124" id="h46-0-124" class="d">-            }
</a><a href="#h46-0-125" id="h46-0-125" class="d">-            val outputFile = File(pendingDownload.outputPath + &quot;.&quot; + fileType.fileExtension).also { createNeededDirectories(it) }
</a><a href="#h46-0-126" id="h46-0-126" class="d">-
</a><a href="#h46-0-127" id="h46-0-127" class="d">-            inputFile.copyTo(outputFile, overwrite = true)
</a><a href="#h46-0-128" id="h46-0-128" class="d">-
</a><a href="#h46-0-129" id="h46-0-129" class="d">-            pendingDownload.outputFile = outputFile.absolutePath
</a><a href="#h46-0-130" id="h46-0-130" class="d">-            pendingDownload.downloadStage = DownloadStage.SAVED
</a><a href="#h46-0-131" id="h46-0-131" class="d">-
</a><a href="#h46-0-132" id="h46-0-132" class="d">-            runCatching {
</a><a href="#h46-0-133" id="h46-0-133" class="d">-                val contentUri = Uri.fromFile(outputFile)
</a><a href="#h46-0-134" id="h46-0-134" class="d">-                val mediaScanIntent = Intent(&quot;android.intent.action.MEDIA_SCANNER_SCAN_FILE&quot;)
</a><a href="#h46-0-135" id="h46-0-135" class="d">-                mediaScanIntent.setData(contentUri)
</a><a href="#h46-0-136" id="h46-0-136" class="d">-                context.sendBroadcast(mediaScanIntent)
</a><a href="#h46-0-137" id="h46-0-137" class="d">-            }.onFailure {
</a><a href="#h46-0-138" id="h46-0-138" class="d">-                Logger.error(&quot;Failed to scan media file&quot;, it)
</a><a href="#h46-0-139" id="h46-0-139" class="d">-                longToast(translation.format(&quot;failed_gallery_toast&quot;, &quot;error&quot; to it.toString()))
</a><a href="#h46-0-140" id="h46-0-140" class="d">-            }
</a><a href="#h46-0-141" id="h46-0-141" class="d">-
</a><a href="#h46-0-142" id="h46-0-142" class="d">-            Logger.debug(&quot;download complete&quot;)
</a><a href="#h46-0-143" id="h46-0-143" class="d">-
</a><a href="#h46-0-144" id="h46-0-144" class="d">-            //print the path of the saved media
</a><a href="#h46-0-145" id="h46-0-145" class="d">-            val parentName = outputFile.parentFile?.parentFile?.absolutePath?.let {
</a><a href="#h46-0-146" id="h46-0-146" class="d">-                if (!it.endsWith(&quot;/&quot;)) &quot;$it/&quot; else it
</a><a href="#h46-0-147" id="h46-0-147" class="d">-            }
</a><a href="#h46-0-148" id="h46-0-148" class="d">-
</a><a href="#h46-0-149" id="h46-0-149" class="d">-            shortToast(
</a><a href="#h46-0-150" id="h46-0-150" class="d">-                translation.format(&quot;saved_toast&quot;, &quot;path&quot; to outputFile.absolutePath.replace(parentName ?: &quot;&quot;, &quot;&quot;))
</a><a href="#h46-0-151" id="h46-0-151" class="d">-            )
</a><a href="#h46-0-152" id="h46-0-152" class="d">-        }.onFailure {
</a><a href="#h46-0-153" id="h46-0-153" class="d">-            Logger.error(it)
</a><a href="#h46-0-154" id="h46-0-154" class="d">-            longToast(translation.format(&quot;failed_gallery_toast&quot;, &quot;error&quot; to it.toString()))
</a><a href="#h46-0-155" id="h46-0-155" class="d">-            pendingDownload.downloadStage = DownloadStage.FAILED
</a><a href="#h46-0-156" id="h46-0-156" class="d">-        }
</a><a href="#h46-0-157" id="h46-0-157" class="d">-    }
</a><a href="#h46-0-158" id="h46-0-158" class="d">-
</a><a href="#h46-0-159" id="h46-0-159" class="d">-    private fun createMediaTempFile(): File {
</a><a href="#h46-0-160" id="h46-0-160" class="d">-        return File.createTempFile(&quot;media&quot;, &quot;.tmp&quot;)
</a><a href="#h46-0-161" id="h46-0-161" class="d">-    }
</a><a href="#h46-0-162" id="h46-0-162" class="d">-
</a><a href="#h46-0-163" id="h46-0-163" class="d">-    private fun downloadInputMedias(downloadRequest: DownloadRequest) = runBlocking {
</a><a href="#h46-0-164" id="h46-0-164" class="d">-        val jobs = mutableListOf&lt;Job&gt;()
</a><a href="#h46-0-165" id="h46-0-165" class="d">-        val downloadedMedias = mutableMapOf&lt;InputMedia, File&gt;()
</a><a href="#h46-0-166" id="h46-0-166" class="d">-
</a><a href="#h46-0-167" id="h46-0-167" class="d">-        downloadRequest.getInputMedias().forEach { inputMedia -&gt;
</a><a href="#h46-0-168" id="h46-0-168" class="d">-            fun handleInputStream(inputStream: InputStream) {
</a><a href="#h46-0-169" id="h46-0-169" class="d">-                createMediaTempFile().apply {
</a><a href="#h46-0-170" id="h46-0-170" class="d">-                    if (inputMedia.encryption != null) {
</a><a href="#h46-0-171" id="h46-0-171" class="d">-                        decryptInputStream(inputStream, inputMedia.encryption).use { decryptedInputStream -&gt;
</a><a href="#h46-0-172" id="h46-0-172" class="d">-                            decryptedInputStream.copyTo(outputStream())
</a><a href="#h46-0-173" id="h46-0-173" class="d">-                        }
</a><a href="#h46-0-174" id="h46-0-174" class="d">-                    } else {
</a><a href="#h46-0-175" id="h46-0-175" class="d">-                        inputStream.copyTo(outputStream())
</a><a href="#h46-0-176" id="h46-0-176" class="d">-                    }
</a><a href="#h46-0-177" id="h46-0-177" class="d">-                }.also { downloadedMedias[inputMedia] = it }
</a><a href="#h46-0-178" id="h46-0-178" class="d">-            }
</a><a href="#h46-0-179" id="h46-0-179" class="d">-
</a><a href="#h46-0-180" id="h46-0-180" class="d">-            launch {
</a><a href="#h46-0-181" id="h46-0-181" class="d">-                when (inputMedia.type) {
</a><a href="#h46-0-182" id="h46-0-182" class="d">-                    DownloadMediaType.PROTO_MEDIA -&gt; {
</a><a href="#h46-0-183" id="h46-0-183" class="d">-                        RemoteMediaResolver.downloadBoltMedia(Base64.UrlSafe.decode(inputMedia.content))?.let { inputStream -&gt;
</a><a href="#h46-0-184" id="h46-0-184" class="d">-                            handleInputStream(inputStream)
</a><a href="#h46-0-185" id="h46-0-185" class="d">-                        }
</a><a href="#h46-0-186" id="h46-0-186" class="d">-                    }
</a><a href="#h46-0-187" id="h46-0-187" class="d">-                    DownloadMediaType.DIRECT_MEDIA -&gt; {
</a><a href="#h46-0-188" id="h46-0-188" class="d">-                        val decoded = Base64.UrlSafe.decode(inputMedia.content)
</a><a href="#h46-0-189" id="h46-0-189" class="d">-                        createMediaTempFile().apply {
</a><a href="#h46-0-190" id="h46-0-190" class="d">-                            writeBytes(decoded)
</a><a href="#h46-0-191" id="h46-0-191" class="d">-                        }.also { downloadedMedias[inputMedia] = it }
</a><a href="#h46-0-192" id="h46-0-192" class="d">-                    }
</a><a href="#h46-0-193" id="h46-0-193" class="d">-                    DownloadMediaType.REMOTE_MEDIA -&gt; {
</a><a href="#h46-0-194" id="h46-0-194" class="d">-                        with(URL(inputMedia.content).openConnection() as HttpURLConnection) {
</a><a href="#h46-0-195" id="h46-0-195" class="d">-                            requestMethod = &quot;GET&quot;
</a><a href="#h46-0-196" id="h46-0-196" class="d">-                            setRequestProperty(&quot;User-Agent&quot;, Constants.USER_AGENT)
</a><a href="#h46-0-197" id="h46-0-197" class="d">-                            connect()
</a><a href="#h46-0-198" id="h46-0-198" class="d">-                            handleInputStream(inputStream)
</a><a href="#h46-0-199" id="h46-0-199" class="d">-                        }
</a><a href="#h46-0-200" id="h46-0-200" class="d">-                    }
</a><a href="#h46-0-201" id="h46-0-201" class="d">-                    else -&gt; {
</a><a href="#h46-0-202" id="h46-0-202" class="d">-                        downloadedMedias[inputMedia] = File(inputMedia.content)
</a><a href="#h46-0-203" id="h46-0-203" class="d">-                    }
</a><a href="#h46-0-204" id="h46-0-204" class="d">-                }
</a><a href="#h46-0-205" id="h46-0-205" class="d">-            }.also { jobs.add(it) }
</a><a href="#h46-0-206" id="h46-0-206" class="d">-        }
</a><a href="#h46-0-207" id="h46-0-207" class="d">-
</a><a href="#h46-0-208" id="h46-0-208" class="d">-        jobs.joinAll()
</a><a href="#h46-0-209" id="h46-0-209" class="d">-        downloadedMedias
</a><a href="#h46-0-210" id="h46-0-210" class="d">-    }
</a><a href="#h46-0-211" id="h46-0-211" class="d">-
</a><a href="#h46-0-212" id="h46-0-212" class="d">-    private suspend fun downloadRemoteMedia(pendingDownloadObject:  PendingDownload, downloadedMedias: Map&lt;InputMedia, DownloadedFile&gt;, downloadRequest: DownloadRequest) {
</a><a href="#h46-0-213" id="h46-0-213" class="d">-        downloadRequest.getInputMedias().first().let { inputMedia -&gt;
</a><a href="#h46-0-214" id="h46-0-214" class="d">-            val mediaType = downloadRequest.getInputType(0)!!
</a><a href="#h46-0-215" id="h46-0-215" class="d">-            val media = downloadedMedias[inputMedia]!!
</a><a href="#h46-0-216" id="h46-0-216" class="d">-
</a><a href="#h46-0-217" id="h46-0-217" class="d">-            if (!downloadRequest.isDashPlaylist) {
</a><a href="#h46-0-218" id="h46-0-218" class="d">-                saveMediaToGallery(media.file, pendingDownloadObject)
</a><a href="#h46-0-219" id="h46-0-219" class="d">-                media.file.delete()
</a><a href="#h46-0-220" id="h46-0-220" class="d">-                return
</a><a href="#h46-0-221" id="h46-0-221" class="d">-            }
</a><a href="#h46-0-222" id="h46-0-222" class="d">-
</a><a href="#h46-0-223" id="h46-0-223" class="d">-            assert(mediaType == DownloadMediaType.REMOTE_MEDIA)
</a><a href="#h46-0-224" id="h46-0-224" class="d">-
</a><a href="#h46-0-225" id="h46-0-225" class="d">-            val playlistXml = DocumentBuilderFactory.newInstance().newDocumentBuilder().parse(media.file)
</a><a href="#h46-0-226" id="h46-0-226" class="d">-            val baseUrlNodeList = playlistXml.getElementsByTagName(&quot;BaseURL&quot;)
</a><a href="#h46-0-227" id="h46-0-227" class="d">-            for (i in 0 until baseUrlNodeList.length) {
</a><a href="#h46-0-228" id="h46-0-228" class="d">-                val baseUrlNode = baseUrlNodeList.item(i)
</a><a href="#h46-0-229" id="h46-0-229" class="d">-                val baseUrl = baseUrlNode.textContent
</a><a href="#h46-0-230" id="h46-0-230" class="d">-                baseUrlNode.textContent = &quot;${RemoteMediaResolver.CF_ST_CDN_D}$baseUrl&quot;
</a><a href="#h46-0-231" id="h46-0-231" class="d">-            }
</a><a href="#h46-0-232" id="h46-0-232" class="d">-
</a><a href="#h46-0-233" id="h46-0-233" class="d">-            val dashOptions = downloadRequest.getDashOptions()!!
</a><a href="#h46-0-234" id="h46-0-234" class="d">-
</a><a href="#h46-0-235" id="h46-0-235" class="d">-            val dashPlaylistFile = renameFromFileType(media.file, FileType.MPD)
</a><a href="#h46-0-236" id="h46-0-236" class="d">-            val xmlData = dashPlaylistFile.outputStream()
</a><a href="#h46-0-237" id="h46-0-237" class="d">-            TransformerFactory.newInstance().newTransformer().transform(DOMSource(playlistXml), StreamResult(xmlData))
</a><a href="#h46-0-238" id="h46-0-238" class="d">-
</a><a href="#h46-0-239" id="h46-0-239" class="d">-            longToast(translation.format(&quot;download_toast&quot;, &quot;path&quot; to dashPlaylistFile.nameWithoutExtension))
</a><a href="#h46-0-240" id="h46-0-240" class="d">-            val outputFile = File.createTempFile(&quot;dash&quot;, &quot;.mp4&quot;)
</a><a href="#h46-0-241" id="h46-0-241" class="d">-            runCatching {
</a><a href="#h46-0-242" id="h46-0-242" class="d">-                MediaDownloaderHelper.downloadDashChapterFile(
</a><a href="#h46-0-243" id="h46-0-243" class="d">-                    dashPlaylist = dashPlaylistFile,
</a><a href="#h46-0-244" id="h46-0-244" class="d">-                    output = outputFile,
</a><a href="#h46-0-245" id="h46-0-245" class="d">-                    startTime = dashOptions.offsetTime,
</a><a href="#h46-0-246" id="h46-0-246" class="d">-                    duration = dashOptions.duration)
</a><a href="#h46-0-247" id="h46-0-247" class="d">-                saveMediaToGallery(outputFile, pendingDownloadObject)
</a><a href="#h46-0-248" id="h46-0-248" class="d">-            }.onFailure {
</a><a href="#h46-0-249" id="h46-0-249" class="d">-                if (coroutineContext.job.isCancelled) return@onFailure
</a><a href="#h46-0-250" id="h46-0-250" class="d">-                Logger.error(it)
</a><a href="#h46-0-251" id="h46-0-251" class="d">-                longToast(translation.format(&quot;failed_processing_toast&quot;, &quot;error&quot; to it.toString()))
</a><a href="#h46-0-252" id="h46-0-252" class="d">-                pendingDownloadObject.downloadStage = DownloadStage.FAILED
</a><a href="#h46-0-253" id="h46-0-253" class="d">-            }
</a><a href="#h46-0-254" id="h46-0-254" class="d">-
</a><a href="#h46-0-255" id="h46-0-255" class="d">-            dashPlaylistFile.delete()
</a><a href="#h46-0-256" id="h46-0-256" class="d">-            outputFile.delete()
</a><a href="#h46-0-257" id="h46-0-257" class="d">-            media.file.delete()
</a><a href="#h46-0-258" id="h46-0-258" class="d">-        }
</a><a href="#h46-0-259" id="h46-0-259" class="d">-    }
</a><a href="#h46-0-260" id="h46-0-260" class="d">-
</a><a href="#h46-0-261" id="h46-0-261" class="d">-    private fun renameFromFileType(file: File, fileType: FileType): File {
</a><a href="#h46-0-262" id="h46-0-262" class="d">-        val newFile = File(file.parentFile, file.nameWithoutExtension + &quot;.&quot; + fileType.fileExtension)
</a><a href="#h46-0-263" id="h46-0-263" class="d">-        file.renameTo(newFile)
</a><a href="#h46-0-264" id="h46-0-264" class="d">-        return newFile
</a><a href="#h46-0-265" id="h46-0-265" class="d">-    }
</a><a href="#h46-0-266" id="h46-0-266" class="d">-
</a><a href="#h46-0-267" id="h46-0-267" class="d">-    override fun onReceive(context: Context, intent: Intent) {
</a><a href="#h46-0-268" id="h46-0-268" class="d">-        if (intent.action != DOWNLOAD_ACTION) return
</a><a href="#h46-0-269" id="h46-0-269" class="d">-        this.context = context
</a><a href="#h46-0-270" id="h46-0-270" class="d">-        Logger.debug(&quot;onReceive download&quot;)
</a><a href="#h46-0-271" id="h46-0-271" class="d">-
</a><a href="#h46-0-272" id="h46-0-272" class="d">-        SharedContext.ensureInitialized(context)
</a><a href="#h46-0-273" id="h46-0-273" class="d">-
</a><a href="#h46-0-274" id="h46-0-274" class="d">-        val downloadRequest = DownloadRequest.fromBundle(intent.extras!!)
</a><a href="#h46-0-275" id="h46-0-275" class="d">-
</a><a href="#h46-0-276" id="h46-0-276" class="d">-        SharedContext.downloadTaskManager.canDownloadMedia(downloadRequest.getUniqueHash())?.let { downloadStage -&gt;
</a><a href="#h46-0-277" id="h46-0-277" class="d">-            shortToast(
</a><a href="#h46-0-278" id="h46-0-278" class="d">-                translation[if (downloadStage.isFinalStage) {
</a><a href="#h46-0-279" id="h46-0-279" class="d">-                    &quot;already_downloaded_toast&quot;
</a><a href="#h46-0-280" id="h46-0-280" class="d">-                } else {
</a><a href="#h46-0-281" id="h46-0-281" class="d">-                    &quot;already_queued_toast&quot;
</a><a href="#h46-0-282" id="h46-0-282" class="d">-                }]
</a><a href="#h46-0-283" id="h46-0-283" class="d">-            )
</a><a href="#h46-0-284" id="h46-0-284" class="d">-            return
</a><a href="#h46-0-285" id="h46-0-285" class="d">-        }
</a><a href="#h46-0-286" id="h46-0-286" class="d">-
</a><a href="#h46-0-287" id="h46-0-287" class="d">-        CoroutineScope(Dispatchers.IO).launch {
</a><a href="#h46-0-288" id="h46-0-288" class="d">-            val pendingDownloadObject = PendingDownload.fromBundle(intent.extras!!)
</a><a href="#h46-0-289" id="h46-0-289" class="d">-
</a><a href="#h46-0-290" id="h46-0-290" class="d">-            SharedContext.downloadTaskManager.addTask(pendingDownloadObject)
</a><a href="#h46-0-291" id="h46-0-291" class="d">-            pendingDownloadObject.apply {
</a><a href="#h46-0-292" id="h46-0-292" class="d">-                job = coroutineContext.job
</a><a href="#h46-0-293" id="h46-0-293" class="d">-                downloadStage = DownloadStage.DOWNLOADING
</a><a href="#h46-0-294" id="h46-0-294" class="d">-            }
</a><a href="#h46-0-295" id="h46-0-295" class="d">-
</a><a href="#h46-0-296" id="h46-0-296" class="d">-            runCatching {
</a><a href="#h46-0-297" id="h46-0-297" class="d">-                //first download all input medias into cache
</a><a href="#h46-0-298" id="h46-0-298" class="d">-                val downloadedMedias = downloadInputMedias(downloadRequest).map {
</a><a href="#h46-0-299" id="h46-0-299" class="d">-                    it.key to DownloadedFile(it.value, FileType.fromFile(it.value))
</a><a href="#h46-0-300" id="h46-0-300" class="d">-                }.toMap().toMutableMap()
</a><a href="#h46-0-301" id="h46-0-301" class="d">-                Logger.debug(&quot;downloaded ${downloadedMedias.size} medias&quot;)
</a><a href="#h46-0-302" id="h46-0-302" class="d">-
</a><a href="#h46-0-303" id="h46-0-303" class="d">-                var shouldMergeOverlay = downloadRequest.shouldMergeOverlay
</a><a href="#h46-0-304" id="h46-0-304" class="d">-
</a><a href="#h46-0-305" id="h46-0-305" class="d">-                //if there is a zip file, extract it and replace the downloaded media with the extracted ones
</a><a href="#h46-0-306" id="h46-0-306" class="d">-                downloadedMedias.values.find { it.fileType == FileType.ZIP }?.let { entry -&gt;
</a><a href="#h46-0-307" id="h46-0-307" class="d">-                    val extractedMedias = extractZip(entry.file.inputStream()).map {
</a><a href="#h46-0-308" id="h46-0-308" class="d">-                        InputMedia(
</a><a href="#h46-0-309" id="h46-0-309" class="d">-                            type = DownloadMediaType.LOCAL_MEDIA,
</a><a href="#h46-0-310" id="h46-0-310" class="d">-                            content = it.absolutePath
</a><a href="#h46-0-311" id="h46-0-311" class="d">-                        ) to DownloadedFile(it, FileType.fromFile(it))
</a><a href="#h46-0-312" id="h46-0-312" class="d">-                    }
</a><a href="#h46-0-313" id="h46-0-313" class="d">-
</a><a href="#h46-0-314" id="h46-0-314" class="d">-                    downloadedMedias.values.removeIf {
</a><a href="#h46-0-315" id="h46-0-315" class="d">-                        it.file.delete()
</a><a href="#h46-0-316" id="h46-0-316" class="d">-                        true
</a><a href="#h46-0-317" id="h46-0-317" class="d">-                    }
</a><a href="#h46-0-318" id="h46-0-318" class="d">-
</a><a href="#h46-0-319" id="h46-0-319" class="d">-                    downloadedMedias.putAll(extractedMedias)
</a><a href="#h46-0-320" id="h46-0-320" class="d">-                    shouldMergeOverlay = true
</a><a href="#h46-0-321" id="h46-0-321" class="d">-                }
</a><a href="#h46-0-322" id="h46-0-322" class="d">-
</a><a href="#h46-0-323" id="h46-0-323" class="d">-                if (shouldMergeOverlay) {
</a><a href="#h46-0-324" id="h46-0-324" class="d">-                    assert(downloadedMedias.size == 2)
</a><a href="#h46-0-325" id="h46-0-325" class="d">-                    val media = downloadedMedias.values.first { it.fileType.isVideo }
</a><a href="#h46-0-326" id="h46-0-326" class="d">-                    val overlayMedia = downloadedMedias.values.first { it.fileType.isImage }
</a><a href="#h46-0-327" id="h46-0-327" class="d">-
</a><a href="#h46-0-328" id="h46-0-328" class="d">-                    val renamedMedia = renameFromFileType(media.file, media.fileType)
</a><a href="#h46-0-329" id="h46-0-329" class="d">-                    val renamedOverlayMedia = renameFromFileType(overlayMedia.file, overlayMedia.fileType)
</a><a href="#h46-0-330" id="h46-0-330" class="d">-                    val mergedOverlay: File = File.createTempFile(&quot;merged&quot;, &quot;.&quot; + media.fileType.fileExtension)
</a><a href="#h46-0-331" id="h46-0-331" class="d">-                    runCatching {
</a><a href="#h46-0-332" id="h46-0-332" class="d">-                        longToast(translation.format(&quot;download_toast&quot;, &quot;path&quot; to media.file.nameWithoutExtension))
</a><a href="#h46-0-333" id="h46-0-333" class="d">-                        pendingDownloadObject.downloadStage = DownloadStage.MERGING
</a><a href="#h46-0-334" id="h46-0-334" class="d">-
</a><a href="#h46-0-335" id="h46-0-335" class="d">-                        MediaDownloaderHelper.mergeOverlayFile(
</a><a href="#h46-0-336" id="h46-0-336" class="d">-                            media = renamedMedia,
</a><a href="#h46-0-337" id="h46-0-337" class="d">-                            overlay = renamedOverlayMedia,
</a><a href="#h46-0-338" id="h46-0-338" class="d">-                            output = mergedOverlay
</a><a href="#h46-0-339" id="h46-0-339" class="d">-                        )
</a><a href="#h46-0-340" id="h46-0-340" class="d">-
</a><a href="#h46-0-341" id="h46-0-341" class="d">-                        saveMediaToGallery(mergedOverlay, pendingDownloadObject)
</a><a href="#h46-0-342" id="h46-0-342" class="d">-                    }.onFailure {
</a><a href="#h46-0-343" id="h46-0-343" class="d">-                        if (coroutineContext.job.isCancelled) return@onFailure
</a><a href="#h46-0-344" id="h46-0-344" class="d">-                        Logger.error(it)
</a><a href="#h46-0-345" id="h46-0-345" class="d">-                        longToast(translation.format(&quot;failed_processing_toast&quot;, &quot;error&quot; to it.toString()))
</a><a href="#h46-0-346" id="h46-0-346" class="d">-                        pendingDownloadObject.downloadStage = DownloadStage.MERGE_FAILED
</a><a href="#h46-0-347" id="h46-0-347" class="d">-                    }
</a><a href="#h46-0-348" id="h46-0-348" class="d">-
</a><a href="#h46-0-349" id="h46-0-349" class="d">-                    mergedOverlay.delete()
</a><a href="#h46-0-350" id="h46-0-350" class="d">-                    renamedOverlayMedia.delete()
</a><a href="#h46-0-351" id="h46-0-351" class="d">-                    renamedMedia.delete()
</a><a href="#h46-0-352" id="h46-0-352" class="d">-                    return@launch
</a><a href="#h46-0-353" id="h46-0-353" class="d">-                }
</a><a href="#h46-0-354" id="h46-0-354" class="d">-
</a><a href="#h46-0-355" id="h46-0-355" class="d">-                downloadRemoteMedia(pendingDownloadObject, downloadedMedias, downloadRequest)
</a><a href="#h46-0-356" id="h46-0-356" class="d">-            }.onFailure {
</a><a href="#h46-0-357" id="h46-0-357" class="d">-                pendingDownloadObject.downloadStage = DownloadStage.FAILED
</a><a href="#h46-0-358" id="h46-0-358" class="d">-                Logger.error(it)
</a><a href="#h46-0-359" id="h46-0-359" class="d">-                longToast(translation[&quot;failed_generic_toast&quot;])
</a><a href="#h46-0-360" id="h46-0-360" class="d">-            }
</a><a href="#h46-0-361" id="h46-0-361" class="d">-        }
</a><a href="#h46-0-362" id="h46-0-362" class="d">-    }
</a><a href="#h46-0-363" id="h46-0-363" class="d">-}</a><a href="#h46-0-364" id="h46-0-364" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h47" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadProcessor.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadProcessor.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadProcessor.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadProcessor.kt</a></b>
<a href="#h47-0" id="h47-0" class="h">@@ -0,0 +1,387 @@
</a><a href="#h47-0-0" id="h47-0-0" class="i">+package me.rhunk.snapenhance.download
</a><a href="#h47-0-1" id="h47-0-1" class="i">+
</a><a href="#h47-0-2" id="h47-0-2" class="i">+import android.annotation.SuppressLint
</a><a href="#h47-0-3" id="h47-0-3" class="i">+import android.content.Context
</a><a href="#h47-0-4" id="h47-0-4" class="i">+import android.content.Intent
</a><a href="#h47-0-5" id="h47-0-5" class="i">+import android.net.Uri
</a><a href="#h47-0-6" id="h47-0-6" class="i">+import android.widget.Toast
</a><a href="#h47-0-7" id="h47-0-7" class="i">+import androidx.documentfile.provider.DocumentFile
</a><a href="#h47-0-8" id="h47-0-8" class="i">+import com.google.gson.GsonBuilder
</a><a href="#h47-0-9" id="h47-0-9" class="i">+import kotlinx.coroutines.CoroutineScope
</a><a href="#h47-0-10" id="h47-0-10" class="i">+import kotlinx.coroutines.Dispatchers
</a><a href="#h47-0-11" id="h47-0-11" class="i">+import kotlinx.coroutines.Job
</a><a href="#h47-0-12" id="h47-0-12" class="i">+import kotlinx.coroutines.job
</a><a href="#h47-0-13" id="h47-0-13" class="i">+import kotlinx.coroutines.joinAll
</a><a href="#h47-0-14" id="h47-0-14" class="i">+import kotlinx.coroutines.launch
</a><a href="#h47-0-15" id="h47-0-15" class="i">+import kotlinx.coroutines.runBlocking
</a><a href="#h47-0-16" id="h47-0-16" class="i">+import me.rhunk.snapenhance.Constants
</a><a href="#h47-0-17" id="h47-0-17" class="i">+import me.rhunk.snapenhance.Logger
</a><a href="#h47-0-18" id="h47-0-18" class="i">+import me.rhunk.snapenhance.SharedContext
</a><a href="#h47-0-19" id="h47-0-19" class="i">+import me.rhunk.snapenhance.bridge.DownloadCallback
</a><a href="#h47-0-20" id="h47-0-20" class="i">+import me.rhunk.snapenhance.bridge.wrapper.ConfigWrapper
</a><a href="#h47-0-21" id="h47-0-21" class="i">+import me.rhunk.snapenhance.config.ConfigProperty
</a><a href="#h47-0-22" id="h47-0-22" class="i">+import me.rhunk.snapenhance.data.FileType
</a><a href="#h47-0-23" id="h47-0-23" class="i">+import me.rhunk.snapenhance.download.data.DownloadMetadata
</a><a href="#h47-0-24" id="h47-0-24" class="i">+import me.rhunk.snapenhance.download.data.DownloadRequest
</a><a href="#h47-0-25" id="h47-0-25" class="i">+import me.rhunk.snapenhance.download.data.InputMedia
</a><a href="#h47-0-26" id="h47-0-26" class="i">+import me.rhunk.snapenhance.download.data.MediaEncryptionKeyPair
</a><a href="#h47-0-27" id="h47-0-27" class="i">+import me.rhunk.snapenhance.download.data.PendingDownload
</a><a href="#h47-0-28" id="h47-0-28" class="i">+import me.rhunk.snapenhance.download.enums.DownloadMediaType
</a><a href="#h47-0-29" id="h47-0-29" class="i">+import me.rhunk.snapenhance.download.enums.DownloadStage
</a><a href="#h47-0-30" id="h47-0-30" class="i">+import me.rhunk.snapenhance.util.download.RemoteMediaResolver
</a><a href="#h47-0-31" id="h47-0-31" class="i">+import me.rhunk.snapenhance.util.snap.MediaDownloaderHelper
</a><a href="#h47-0-32" id="h47-0-32" class="i">+import java.io.File
</a><a href="#h47-0-33" id="h47-0-33" class="i">+import java.io.InputStream
</a><a href="#h47-0-34" id="h47-0-34" class="i">+import java.net.HttpURLConnection
</a><a href="#h47-0-35" id="h47-0-35" class="i">+import java.net.URL
</a><a href="#h47-0-36" id="h47-0-36" class="i">+import java.util.zip.ZipInputStream
</a><a href="#h47-0-37" id="h47-0-37" class="i">+import javax.crypto.Cipher
</a><a href="#h47-0-38" id="h47-0-38" class="i">+import javax.crypto.CipherInputStream
</a><a href="#h47-0-39" id="h47-0-39" class="i">+import javax.crypto.spec.IvParameterSpec
</a><a href="#h47-0-40" id="h47-0-40" class="i">+import javax.crypto.spec.SecretKeySpec
</a><a href="#h47-0-41" id="h47-0-41" class="i">+import javax.xml.parsers.DocumentBuilderFactory
</a><a href="#h47-0-42" id="h47-0-42" class="i">+import javax.xml.transform.TransformerFactory
</a><a href="#h47-0-43" id="h47-0-43" class="i">+import javax.xml.transform.dom.DOMSource
</a><a href="#h47-0-44" id="h47-0-44" class="i">+import javax.xml.transform.stream.StreamResult
</a><a href="#h47-0-45" id="h47-0-45" class="i">+import kotlin.coroutines.coroutineContext
</a><a href="#h47-0-46" id="h47-0-46" class="i">+import kotlin.io.encoding.Base64
</a><a href="#h47-0-47" id="h47-0-47" class="i">+import kotlin.io.encoding.ExperimentalEncodingApi
</a><a href="#h47-0-48" id="h47-0-48" class="i">+
</a><a href="#h47-0-49" id="h47-0-49" class="i">+data class DownloadedFile(
</a><a href="#h47-0-50" id="h47-0-50" class="i">+    val file: File,
</a><a href="#h47-0-51" id="h47-0-51" class="i">+    val fileType: FileType
</a><a href="#h47-0-52" id="h47-0-52" class="i">+)
</a><a href="#h47-0-53" id="h47-0-53" class="i">+
</a><a href="#h47-0-54" id="h47-0-54" class="i">+/**
</a><a href="#h47-0-55" id="h47-0-55" class="i">+ * DownloadProcessor handles the download requests of the user
</a><a href="#h47-0-56" id="h47-0-56" class="i">+ */
</a><a href="#h47-0-57" id="h47-0-57" class="i">+@OptIn(ExperimentalEncodingApi::class)
</a><a href="#h47-0-58" id="h47-0-58" class="i">+class DownloadProcessor (
</a><a href="#h47-0-59" id="h47-0-59" class="i">+    private val context: Context,
</a><a href="#h47-0-60" id="h47-0-60" class="i">+    private val callback: DownloadCallback
</a><a href="#h47-0-61" id="h47-0-61" class="i">+) {
</a><a href="#h47-0-62" id="h47-0-62" class="i">+    companion object {
</a><a href="#h47-0-63" id="h47-0-63" class="i">+        const val DOWNLOAD_REQUEST_EXTRA = &quot;request&quot;
</a><a href="#h47-0-64" id="h47-0-64" class="i">+        const val DOWNLOAD_METADATA_EXTRA = &quot;metadata&quot;
</a><a href="#h47-0-65" id="h47-0-65" class="i">+    }
</a><a href="#h47-0-66" id="h47-0-66" class="i">+
</a><a href="#h47-0-67" id="h47-0-67" class="i">+    private val translation by lazy {
</a><a href="#h47-0-68" id="h47-0-68" class="i">+        SharedContext.translation.getCategory(&quot;download_processor&quot;)
</a><a href="#h47-0-69" id="h47-0-69" class="i">+    }
</a><a href="#h47-0-70" id="h47-0-70" class="i">+
</a><a href="#h47-0-71" id="h47-0-71" class="i">+    private val gson by lazy {
</a><a href="#h47-0-72" id="h47-0-72" class="i">+        GsonBuilder().setPrettyPrinting().create()
</a><a href="#h47-0-73" id="h47-0-73" class="i">+    }
</a><a href="#h47-0-74" id="h47-0-74" class="i">+
</a><a href="#h47-0-75" id="h47-0-75" class="i">+    private fun fallbackToast(message: Any) {
</a><a href="#h47-0-76" id="h47-0-76" class="i">+        android.os.Handler(context.mainLooper).post {
</a><a href="#h47-0-77" id="h47-0-77" class="i">+            Toast.makeText(context, message.toString(), Toast.LENGTH_SHORT).show()
</a><a href="#h47-0-78" id="h47-0-78" class="i">+        }
</a><a href="#h47-0-79" id="h47-0-79" class="i">+    }
</a><a href="#h47-0-80" id="h47-0-80" class="i">+
</a><a href="#h47-0-81" id="h47-0-81" class="i">+    private fun extractZip(inputStream: InputStream): List&lt;File&gt; {
</a><a href="#h47-0-82" id="h47-0-82" class="i">+        val files = mutableListOf&lt;File&gt;()
</a><a href="#h47-0-83" id="h47-0-83" class="i">+        val zipInputStream = ZipInputStream(inputStream)
</a><a href="#h47-0-84" id="h47-0-84" class="i">+        var entry = zipInputStream.nextEntry
</a><a href="#h47-0-85" id="h47-0-85" class="i">+
</a><a href="#h47-0-86" id="h47-0-86" class="i">+        while (entry != null) {
</a><a href="#h47-0-87" id="h47-0-87" class="i">+            createMediaTempFile().also { file -&gt;
</a><a href="#h47-0-88" id="h47-0-88" class="i">+                file.outputStream().use { outputStream -&gt;
</a><a href="#h47-0-89" id="h47-0-89" class="i">+                    zipInputStream.copyTo(outputStream)
</a><a href="#h47-0-90" id="h47-0-90" class="i">+                }
</a><a href="#h47-0-91" id="h47-0-91" class="i">+                files += file
</a><a href="#h47-0-92" id="h47-0-92" class="i">+            }
</a><a href="#h47-0-93" id="h47-0-93" class="i">+            entry = zipInputStream.nextEntry
</a><a href="#h47-0-94" id="h47-0-94" class="i">+        }
</a><a href="#h47-0-95" id="h47-0-95" class="i">+
</a><a href="#h47-0-96" id="h47-0-96" class="i">+        return files
</a><a href="#h47-0-97" id="h47-0-97" class="i">+    }
</a><a href="#h47-0-98" id="h47-0-98" class="i">+
</a><a href="#h47-0-99" id="h47-0-99" class="i">+    private fun decryptInputStream(inputStream: InputStream, encryption: MediaEncryptionKeyPair): InputStream {
</a><a href="#h47-0-100" id="h47-0-100" class="i">+        val cipher = Cipher.getInstance(&quot;AES/CBC/PKCS5Padding&quot;)
</a><a href="#h47-0-101" id="h47-0-101" class="i">+        val key = Base64.UrlSafe.decode(encryption.key)
</a><a href="#h47-0-102" id="h47-0-102" class="i">+        val iv = Base64.UrlSafe.decode(encryption.iv)
</a><a href="#h47-0-103" id="h47-0-103" class="i">+        cipher.init(Cipher.DECRYPT_MODE, SecretKeySpec(key, &quot;AES&quot;), IvParameterSpec(iv))
</a><a href="#h47-0-104" id="h47-0-104" class="i">+        return CipherInputStream(inputStream, cipher)
</a><a href="#h47-0-105" id="h47-0-105" class="i">+    }
</a><a href="#h47-0-106" id="h47-0-106" class="i">+
</a><a href="#h47-0-107" id="h47-0-107" class="i">+    private fun createNeededDirectories(file: File): File {
</a><a href="#h47-0-108" id="h47-0-108" class="i">+        val directory = file.parentFile ?: return file
</a><a href="#h47-0-109" id="h47-0-109" class="i">+        if (!directory.exists()) {
</a><a href="#h47-0-110" id="h47-0-110" class="i">+            directory.mkdirs()
</a><a href="#h47-0-111" id="h47-0-111" class="i">+        }
</a><a href="#h47-0-112" id="h47-0-112" class="i">+        return file
</a><a href="#h47-0-113" id="h47-0-113" class="i">+    }
</a><a href="#h47-0-114" id="h47-0-114" class="i">+
</a><a href="#h47-0-115" id="h47-0-115" class="i">+    @SuppressLint(&quot;UnspecifiedRegisterReceiverFlag&quot;)
</a><a href="#h47-0-116" id="h47-0-116" class="i">+    private suspend fun saveMediaToGallery(inputFile: File, pendingDownload: PendingDownload) {
</a><a href="#h47-0-117" id="h47-0-117" class="i">+        if (coroutineContext.job.isCancelled) return
</a><a href="#h47-0-118" id="h47-0-118" class="i">+
</a><a href="#h47-0-119" id="h47-0-119" class="i">+        val config = ConfigWrapper().apply { loadFromContext(context) }
</a><a href="#h47-0-120" id="h47-0-120" class="i">+
</a><a href="#h47-0-121" id="h47-0-121" class="i">+        runCatching {
</a><a href="#h47-0-122" id="h47-0-122" class="i">+            val fileType = FileType.fromFile(inputFile)
</a><a href="#h47-0-123" id="h47-0-123" class="i">+            if (fileType == FileType.UNKNOWN) {
</a><a href="#h47-0-124" id="h47-0-124" class="i">+                callback.onFailure(translation.format(&quot;failed_gallery_toast&quot;, &quot;error&quot; to &quot;Unknown media type&quot;), null)
</a><a href="#h47-0-125" id="h47-0-125" class="i">+                return
</a><a href="#h47-0-126" id="h47-0-126" class="i">+            }
</a><a href="#h47-0-127" id="h47-0-127" class="i">+
</a><a href="#h47-0-128" id="h47-0-128" class="i">+            val fileName = pendingDownload.metadata.outputPath.substringAfterLast(&quot;/&quot;) + &quot;.&quot; + fileType.fileExtension
</a><a href="#h47-0-129" id="h47-0-129" class="i">+
</a><a href="#h47-0-130" id="h47-0-130" class="i">+            val outputFolder = DocumentFile.fromTreeUri(context, Uri.parse(config.string(ConfigProperty.SAVE_FOLDER)))
</a><a href="#h47-0-131" id="h47-0-131" class="i">+                ?: throw Exception(&quot;Failed to open output folder&quot;)
</a><a href="#h47-0-132" id="h47-0-132" class="i">+
</a><a href="#h47-0-133" id="h47-0-133" class="i">+            val outputFileFolder = pendingDownload.metadata.outputPath.let {
</a><a href="#h47-0-134" id="h47-0-134" class="i">+                if (it.contains(&quot;/&quot;)) {
</a><a href="#h47-0-135" id="h47-0-135" class="i">+                    it.substringBeforeLast(&quot;/&quot;).split(&quot;/&quot;).fold(outputFolder) { folder, name -&gt;
</a><a href="#h47-0-136" id="h47-0-136" class="i">+                        folder.findFile(name) ?: folder.createDirectory(name)!!
</a><a href="#h47-0-137" id="h47-0-137" class="i">+                    }
</a><a href="#h47-0-138" id="h47-0-138" class="i">+                } else {
</a><a href="#h47-0-139" id="h47-0-139" class="i">+                    outputFolder
</a><a href="#h47-0-140" id="h47-0-140" class="i">+                }
</a><a href="#h47-0-141" id="h47-0-141" class="i">+            }
</a><a href="#h47-0-142" id="h47-0-142" class="i">+
</a><a href="#h47-0-143" id="h47-0-143" class="i">+            val outputFile = outputFileFolder.createFile(fileType.mimeType, fileName)!!
</a><a href="#h47-0-144" id="h47-0-144" class="i">+            val outputStream = context.contentResolver.openOutputStream(outputFile.uri)!!
</a><a href="#h47-0-145" id="h47-0-145" class="i">+
</a><a href="#h47-0-146" id="h47-0-146" class="i">+            inputFile.inputStream().use { inputStream -&gt;
</a><a href="#h47-0-147" id="h47-0-147" class="i">+                inputStream.copyTo(outputStream)
</a><a href="#h47-0-148" id="h47-0-148" class="i">+            }
</a><a href="#h47-0-149" id="h47-0-149" class="i">+
</a><a href="#h47-0-150" id="h47-0-150" class="i">+            pendingDownload.outputFile = outputFile.uri.toString()
</a><a href="#h47-0-151" id="h47-0-151" class="i">+            pendingDownload.downloadStage = DownloadStage.SAVED
</a><a href="#h47-0-152" id="h47-0-152" class="i">+
</a><a href="#h47-0-153" id="h47-0-153" class="i">+            runCatching {
</a><a href="#h47-0-154" id="h47-0-154" class="i">+                val mediaScanIntent = Intent(&quot;android.intent.action.MEDIA_SCANNER_SCAN_FILE&quot;)
</a><a href="#h47-0-155" id="h47-0-155" class="i">+                mediaScanIntent.setData(outputFile.uri)
</a><a href="#h47-0-156" id="h47-0-156" class="i">+                context.sendBroadcast(mediaScanIntent)
</a><a href="#h47-0-157" id="h47-0-157" class="i">+            }.onFailure {
</a><a href="#h47-0-158" id="h47-0-158" class="i">+                Logger.error(&quot;Failed to scan media file&quot;, it)
</a><a href="#h47-0-159" id="h47-0-159" class="i">+                callback.onFailure(translation.format(&quot;failed_gallery_toast&quot;, &quot;error&quot; to it.toString()), it.message)
</a><a href="#h47-0-160" id="h47-0-160" class="i">+            }
</a><a href="#h47-0-161" id="h47-0-161" class="i">+
</a><a href="#h47-0-162" id="h47-0-162" class="i">+            Logger.debug(&quot;download complete&quot;)
</a><a href="#h47-0-163" id="h47-0-163" class="i">+            fileName.let {
</a><a href="#h47-0-164" id="h47-0-164" class="i">+                runCatching { callback.onSuccess(it) }.onFailure { fallbackToast(it) }
</a><a href="#h47-0-165" id="h47-0-165" class="i">+            }
</a><a href="#h47-0-166" id="h47-0-166" class="i">+        }.onFailure { exception -&gt;
</a><a href="#h47-0-167" id="h47-0-167" class="i">+            Logger.error(exception)
</a><a href="#h47-0-168" id="h47-0-168" class="i">+            translation.format(&quot;failed_gallery_toast&quot;, &quot;error&quot; to exception.toString()).let {
</a><a href="#h47-0-169" id="h47-0-169" class="i">+                runCatching { callback.onFailure(it, exception.message) }.onFailure { fallbackToast(it) }
</a><a href="#h47-0-170" id="h47-0-170" class="i">+            }
</a><a href="#h47-0-171" id="h47-0-171" class="i">+            pendingDownload.downloadStage = DownloadStage.FAILED
</a><a href="#h47-0-172" id="h47-0-172" class="i">+        }
</a><a href="#h47-0-173" id="h47-0-173" class="i">+    }
</a><a href="#h47-0-174" id="h47-0-174" class="i">+
</a><a href="#h47-0-175" id="h47-0-175" class="i">+    private fun createMediaTempFile(): File {
</a><a href="#h47-0-176" id="h47-0-176" class="i">+        return File.createTempFile(&quot;media&quot;, &quot;.tmp&quot;)
</a><a href="#h47-0-177" id="h47-0-177" class="i">+    }
</a><a href="#h47-0-178" id="h47-0-178" class="i">+
</a><a href="#h47-0-179" id="h47-0-179" class="i">+    private fun downloadInputMedias(downloadRequest: DownloadRequest) = runBlocking {
</a><a href="#h47-0-180" id="h47-0-180" class="i">+        val jobs = mutableListOf&lt;Job&gt;()
</a><a href="#h47-0-181" id="h47-0-181" class="i">+        val downloadedMedias = mutableMapOf&lt;InputMedia, File&gt;()
</a><a href="#h47-0-182" id="h47-0-182" class="i">+
</a><a href="#h47-0-183" id="h47-0-183" class="i">+        downloadRequest.inputMedias.forEach { inputMedia -&gt;
</a><a href="#h47-0-184" id="h47-0-184" class="i">+            fun handleInputStream(inputStream: InputStream) {
</a><a href="#h47-0-185" id="h47-0-185" class="i">+                createMediaTempFile().apply {
</a><a href="#h47-0-186" id="h47-0-186" class="i">+                    if (inputMedia.encryption != null) {
</a><a href="#h47-0-187" id="h47-0-187" class="i">+                        decryptInputStream(inputStream, inputMedia.encryption).use { decryptedInputStream -&gt;
</a><a href="#h47-0-188" id="h47-0-188" class="i">+                            decryptedInputStream.copyTo(outputStream())
</a><a href="#h47-0-189" id="h47-0-189" class="i">+                        }
</a><a href="#h47-0-190" id="h47-0-190" class="i">+                    } else {
</a><a href="#h47-0-191" id="h47-0-191" class="i">+                        inputStream.copyTo(outputStream())
</a><a href="#h47-0-192" id="h47-0-192" class="i">+                    }
</a><a href="#h47-0-193" id="h47-0-193" class="i">+                }.also { downloadedMedias[inputMedia] = it }
</a><a href="#h47-0-194" id="h47-0-194" class="i">+            }
</a><a href="#h47-0-195" id="h47-0-195" class="i">+
</a><a href="#h47-0-196" id="h47-0-196" class="i">+            launch {
</a><a href="#h47-0-197" id="h47-0-197" class="i">+                when (inputMedia.type) {
</a><a href="#h47-0-198" id="h47-0-198" class="i">+                    DownloadMediaType.PROTO_MEDIA -&gt; {
</a><a href="#h47-0-199" id="h47-0-199" class="i">+                        RemoteMediaResolver.downloadBoltMedia(Base64.UrlSafe.decode(inputMedia.content))?.let { inputStream -&gt;
</a><a href="#h47-0-200" id="h47-0-200" class="i">+                            handleInputStream(inputStream)
</a><a href="#h47-0-201" id="h47-0-201" class="i">+                        }
</a><a href="#h47-0-202" id="h47-0-202" class="i">+                    }
</a><a href="#h47-0-203" id="h47-0-203" class="i">+                    DownloadMediaType.DIRECT_MEDIA -&gt; {
</a><a href="#h47-0-204" id="h47-0-204" class="i">+                        val decoded = Base64.UrlSafe.decode(inputMedia.content)
</a><a href="#h47-0-205" id="h47-0-205" class="i">+                        createMediaTempFile().apply {
</a><a href="#h47-0-206" id="h47-0-206" class="i">+                            writeBytes(decoded)
</a><a href="#h47-0-207" id="h47-0-207" class="i">+                        }.also { downloadedMedias[inputMedia] = it }
</a><a href="#h47-0-208" id="h47-0-208" class="i">+                    }
</a><a href="#h47-0-209" id="h47-0-209" class="i">+                    DownloadMediaType.REMOTE_MEDIA -&gt; {
</a><a href="#h47-0-210" id="h47-0-210" class="i">+                        with(URL(inputMedia.content).openConnection() as HttpURLConnection) {
</a><a href="#h47-0-211" id="h47-0-211" class="i">+                            requestMethod = &quot;GET&quot;
</a><a href="#h47-0-212" id="h47-0-212" class="i">+                            setRequestProperty(&quot;User-Agent&quot;, Constants.USER_AGENT)
</a><a href="#h47-0-213" id="h47-0-213" class="i">+                            connect()
</a><a href="#h47-0-214" id="h47-0-214" class="i">+                            handleInputStream(inputStream)
</a><a href="#h47-0-215" id="h47-0-215" class="i">+                        }
</a><a href="#h47-0-216" id="h47-0-216" class="i">+                    }
</a><a href="#h47-0-217" id="h47-0-217" class="i">+                    else -&gt; {
</a><a href="#h47-0-218" id="h47-0-218" class="i">+                        downloadedMedias[inputMedia] = File(inputMedia.content)
</a><a href="#h47-0-219" id="h47-0-219" class="i">+                    }
</a><a href="#h47-0-220" id="h47-0-220" class="i">+                }
</a><a href="#h47-0-221" id="h47-0-221" class="i">+            }.also { jobs.add(it) }
</a><a href="#h47-0-222" id="h47-0-222" class="i">+        }
</a><a href="#h47-0-223" id="h47-0-223" class="i">+
</a><a href="#h47-0-224" id="h47-0-224" class="i">+        jobs.joinAll()
</a><a href="#h47-0-225" id="h47-0-225" class="i">+        downloadedMedias
</a><a href="#h47-0-226" id="h47-0-226" class="i">+    }
</a><a href="#h47-0-227" id="h47-0-227" class="i">+
</a><a href="#h47-0-228" id="h47-0-228" class="i">+    private suspend fun downloadRemoteMedia(pendingDownloadObject: PendingDownload, downloadedMedias: Map&lt;InputMedia, DownloadedFile&gt;, downloadRequest: DownloadRequest) {
</a><a href="#h47-0-229" id="h47-0-229" class="i">+        downloadRequest.inputMedias.first().let { inputMedia -&gt;
</a><a href="#h47-0-230" id="h47-0-230" class="i">+            val mediaType = inputMedia.type
</a><a href="#h47-0-231" id="h47-0-231" class="i">+            val media = downloadedMedias[inputMedia]!!
</a><a href="#h47-0-232" id="h47-0-232" class="i">+
</a><a href="#h47-0-233" id="h47-0-233" class="i">+            if (!downloadRequest.isDashPlaylist) {
</a><a href="#h47-0-234" id="h47-0-234" class="i">+                saveMediaToGallery(media.file, pendingDownloadObject)
</a><a href="#h47-0-235" id="h47-0-235" class="i">+                media.file.delete()
</a><a href="#h47-0-236" id="h47-0-236" class="i">+                return
</a><a href="#h47-0-237" id="h47-0-237" class="i">+            }
</a><a href="#h47-0-238" id="h47-0-238" class="i">+
</a><a href="#h47-0-239" id="h47-0-239" class="i">+            assert(mediaType == DownloadMediaType.REMOTE_MEDIA)
</a><a href="#h47-0-240" id="h47-0-240" class="i">+
</a><a href="#h47-0-241" id="h47-0-241" class="i">+            val playlistXml = DocumentBuilderFactory.newInstance().newDocumentBuilder().parse(media.file)
</a><a href="#h47-0-242" id="h47-0-242" class="i">+            val baseUrlNodeList = playlistXml.getElementsByTagName(&quot;BaseURL&quot;)
</a><a href="#h47-0-243" id="h47-0-243" class="i">+            for (i in 0 until baseUrlNodeList.length) {
</a><a href="#h47-0-244" id="h47-0-244" class="i">+                val baseUrlNode = baseUrlNodeList.item(i)
</a><a href="#h47-0-245" id="h47-0-245" class="i">+                val baseUrl = baseUrlNode.textContent
</a><a href="#h47-0-246" id="h47-0-246" class="i">+                baseUrlNode.textContent = &quot;${RemoteMediaResolver.CF_ST_CDN_D}$baseUrl&quot;
</a><a href="#h47-0-247" id="h47-0-247" class="i">+            }
</a><a href="#h47-0-248" id="h47-0-248" class="i">+
</a><a href="#h47-0-249" id="h47-0-249" class="i">+            val dashOptions = downloadRequest.dashOptions!!
</a><a href="#h47-0-250" id="h47-0-250" class="i">+
</a><a href="#h47-0-251" id="h47-0-251" class="i">+            val dashPlaylistFile = renameFromFileType(media.file, FileType.MPD)
</a><a href="#h47-0-252" id="h47-0-252" class="i">+            val xmlData = dashPlaylistFile.outputStream()
</a><a href="#h47-0-253" id="h47-0-253" class="i">+            TransformerFactory.newInstance().newTransformer().transform(DOMSource(playlistXml), StreamResult(xmlData))
</a><a href="#h47-0-254" id="h47-0-254" class="i">+
</a><a href="#h47-0-255" id="h47-0-255" class="i">+            translation.format(&quot;download_toast&quot;, &quot;path&quot; to dashPlaylistFile.nameWithoutExtension).let {
</a><a href="#h47-0-256" id="h47-0-256" class="i">+                runCatching { callback.onProgress(it) }.onFailure { fallbackToast(it) }
</a><a href="#h47-0-257" id="h47-0-257" class="i">+            }
</a><a href="#h47-0-258" id="h47-0-258" class="i">+            val outputFile = File.createTempFile(&quot;dash&quot;, &quot;.mp4&quot;)
</a><a href="#h47-0-259" id="h47-0-259" class="i">+            runCatching {
</a><a href="#h47-0-260" id="h47-0-260" class="i">+                MediaDownloaderHelper.downloadDashChapterFile(
</a><a href="#h47-0-261" id="h47-0-261" class="i">+                    dashPlaylist = dashPlaylistFile,
</a><a href="#h47-0-262" id="h47-0-262" class="i">+                    output = outputFile,
</a><a href="#h47-0-263" id="h47-0-263" class="i">+                    startTime = dashOptions.offsetTime,
</a><a href="#h47-0-264" id="h47-0-264" class="i">+                    duration = dashOptions.duration)
</a><a href="#h47-0-265" id="h47-0-265" class="i">+                saveMediaToGallery(outputFile, pendingDownloadObject)
</a><a href="#h47-0-266" id="h47-0-266" class="i">+            }.onFailure { exception -&gt;
</a><a href="#h47-0-267" id="h47-0-267" class="i">+                if (coroutineContext.job.isCancelled) return@onFailure
</a><a href="#h47-0-268" id="h47-0-268" class="i">+                Logger.error(exception)
</a><a href="#h47-0-269" id="h47-0-269" class="i">+                translation.format(&quot;failed_processing_toast&quot;, &quot;error&quot; to exception.toString()).let {
</a><a href="#h47-0-270" id="h47-0-270" class="i">+                    runCatching { callback.onFailure(it, exception.message) }.onFailure { fallbackToast(it) }
</a><a href="#h47-0-271" id="h47-0-271" class="i">+                }
</a><a href="#h47-0-272" id="h47-0-272" class="i">+                pendingDownloadObject.downloadStage = DownloadStage.FAILED
</a><a href="#h47-0-273" id="h47-0-273" class="i">+            }
</a><a href="#h47-0-274" id="h47-0-274" class="i">+
</a><a href="#h47-0-275" id="h47-0-275" class="i">+            dashPlaylistFile.delete()
</a><a href="#h47-0-276" id="h47-0-276" class="i">+            outputFile.delete()
</a><a href="#h47-0-277" id="h47-0-277" class="i">+            media.file.delete()
</a><a href="#h47-0-278" id="h47-0-278" class="i">+        }
</a><a href="#h47-0-279" id="h47-0-279" class="i">+    }
</a><a href="#h47-0-280" id="h47-0-280" class="i">+
</a><a href="#h47-0-281" id="h47-0-281" class="i">+    private fun renameFromFileType(file: File, fileType: FileType): File {
</a><a href="#h47-0-282" id="h47-0-282" class="i">+        val newFile = File(file.parentFile, file.nameWithoutExtension + &quot;.&quot; + fileType.fileExtension)
</a><a href="#h47-0-283" id="h47-0-283" class="i">+        file.renameTo(newFile)
</a><a href="#h47-0-284" id="h47-0-284" class="i">+        return newFile
</a><a href="#h47-0-285" id="h47-0-285" class="i">+    }
</a><a href="#h47-0-286" id="h47-0-286" class="i">+
</a><a href="#h47-0-287" id="h47-0-287" class="i">+    fun onReceive(intent: Intent) {
</a><a href="#h47-0-288" id="h47-0-288" class="i">+        CoroutineScope(Dispatchers.IO).launch {
</a><a href="#h47-0-289" id="h47-0-289" class="i">+            val downloadMetadata = gson.fromJson(intent.getStringExtra(DOWNLOAD_METADATA_EXTRA)!!, DownloadMetadata::class.java)
</a><a href="#h47-0-290" id="h47-0-290" class="i">+            val downloadRequest = gson.fromJson(intent.getStringExtra(DOWNLOAD_REQUEST_EXTRA)!!, DownloadRequest::class.java)
</a><a href="#h47-0-291" id="h47-0-291" class="i">+
</a><a href="#h47-0-292" id="h47-0-292" class="i">+            SharedContext.downloadTaskManager.canDownloadMedia(downloadMetadata.mediaIdentifier)?.let { downloadStage -&gt;
</a><a href="#h47-0-293" id="h47-0-293" class="i">+                translation[if (downloadStage.isFinalStage) {
</a><a href="#h47-0-294" id="h47-0-294" class="i">+                    &quot;already_downloaded_toast&quot;
</a><a href="#h47-0-295" id="h47-0-295" class="i">+                } else {
</a><a href="#h47-0-296" id="h47-0-296" class="i">+                    &quot;already_queued_toast&quot;
</a><a href="#h47-0-297" id="h47-0-297" class="i">+                }].let {
</a><a href="#h47-0-298" id="h47-0-298" class="i">+                    runCatching { callback.onFailure(it, null) }.onFailure { fallbackToast(it) }
</a><a href="#h47-0-299" id="h47-0-299" class="i">+                }
</a><a href="#h47-0-300" id="h47-0-300" class="i">+                return@launch
</a><a href="#h47-0-301" id="h47-0-301" class="i">+            }
</a><a href="#h47-0-302" id="h47-0-302" class="i">+
</a><a href="#h47-0-303" id="h47-0-303" class="i">+            val pendingDownloadObject = PendingDownload(
</a><a href="#h47-0-304" id="h47-0-304" class="i">+                metadata = downloadMetadata
</a><a href="#h47-0-305" id="h47-0-305" class="i">+            )
</a><a href="#h47-0-306" id="h47-0-306" class="i">+
</a><a href="#h47-0-307" id="h47-0-307" class="i">+            SharedContext.downloadTaskManager.addTask(pendingDownloadObject)
</a><a href="#h47-0-308" id="h47-0-308" class="i">+            pendingDownloadObject.apply {
</a><a href="#h47-0-309" id="h47-0-309" class="i">+                job = coroutineContext.job
</a><a href="#h47-0-310" id="h47-0-310" class="i">+                downloadStage = DownloadStage.DOWNLOADING
</a><a href="#h47-0-311" id="h47-0-311" class="i">+            }
</a><a href="#h47-0-312" id="h47-0-312" class="i">+
</a><a href="#h47-0-313" id="h47-0-313" class="i">+            runCatching {
</a><a href="#h47-0-314" id="h47-0-314" class="i">+                //first download all input medias into cache
</a><a href="#h47-0-315" id="h47-0-315" class="i">+                val downloadedMedias = downloadInputMedias(downloadRequest).map {
</a><a href="#h47-0-316" id="h47-0-316" class="i">+                    it.key to DownloadedFile(it.value, FileType.fromFile(it.value))
</a><a href="#h47-0-317" id="h47-0-317" class="i">+                }.toMap().toMutableMap()
</a><a href="#h47-0-318" id="h47-0-318" class="i">+                Logger.debug(&quot;downloaded ${downloadedMedias.size} medias&quot;)
</a><a href="#h47-0-319" id="h47-0-319" class="i">+
</a><a href="#h47-0-320" id="h47-0-320" class="i">+                var shouldMergeOverlay = downloadRequest.shouldMergeOverlay
</a><a href="#h47-0-321" id="h47-0-321" class="i">+
</a><a href="#h47-0-322" id="h47-0-322" class="i">+                //if there is a zip file, extract it and replace the downloaded media with the extracted ones
</a><a href="#h47-0-323" id="h47-0-323" class="i">+                downloadedMedias.values.find { it.fileType == FileType.ZIP }?.let { entry -&gt;
</a><a href="#h47-0-324" id="h47-0-324" class="i">+                    val extractedMedias = extractZip(entry.file.inputStream()).map {
</a><a href="#h47-0-325" id="h47-0-325" class="i">+                        InputMedia(
</a><a href="#h47-0-326" id="h47-0-326" class="i">+                            type = DownloadMediaType.LOCAL_MEDIA,
</a><a href="#h47-0-327" id="h47-0-327" class="i">+                            content = it.absolutePath
</a><a href="#h47-0-328" id="h47-0-328" class="i">+                        ) to DownloadedFile(it, FileType.fromFile(it))
</a><a href="#h47-0-329" id="h47-0-329" class="i">+                    }
</a><a href="#h47-0-330" id="h47-0-330" class="i">+
</a><a href="#h47-0-331" id="h47-0-331" class="i">+                    downloadedMedias.values.removeIf {
</a><a href="#h47-0-332" id="h47-0-332" class="i">+                        it.file.delete()
</a><a href="#h47-0-333" id="h47-0-333" class="i">+                        true
</a><a href="#h47-0-334" id="h47-0-334" class="i">+                    }
</a><a href="#h47-0-335" id="h47-0-335" class="i">+
</a><a href="#h47-0-336" id="h47-0-336" class="i">+                    downloadedMedias.putAll(extractedMedias)
</a><a href="#h47-0-337" id="h47-0-337" class="i">+                    shouldMergeOverlay = true
</a><a href="#h47-0-338" id="h47-0-338" class="i">+                }
</a><a href="#h47-0-339" id="h47-0-339" class="i">+
</a><a href="#h47-0-340" id="h47-0-340" class="i">+                if (shouldMergeOverlay) {
</a><a href="#h47-0-341" id="h47-0-341" class="i">+                    assert(downloadedMedias.size == 2)
</a><a href="#h47-0-342" id="h47-0-342" class="i">+                    val media = downloadedMedias.values.first { it.fileType.isVideo }
</a><a href="#h47-0-343" id="h47-0-343" class="i">+                    val overlayMedia = downloadedMedias.values.first { it.fileType.isImage }
</a><a href="#h47-0-344" id="h47-0-344" class="i">+
</a><a href="#h47-0-345" id="h47-0-345" class="i">+                    val renamedMedia = renameFromFileType(media.file, media.fileType)
</a><a href="#h47-0-346" id="h47-0-346" class="i">+                    val renamedOverlayMedia = renameFromFileType(overlayMedia.file, overlayMedia.fileType)
</a><a href="#h47-0-347" id="h47-0-347" class="i">+                    val mergedOverlay: File = File.createTempFile(&quot;merged&quot;, &quot;.&quot; + media.fileType.fileExtension)
</a><a href="#h47-0-348" id="h47-0-348" class="i">+                    runCatching {
</a><a href="#h47-0-349" id="h47-0-349" class="i">+                        translation.format(&quot;download_toast&quot;, &quot;path&quot; to media.file.nameWithoutExtension).let {
</a><a href="#h47-0-350" id="h47-0-350" class="i">+                            runCatching { callback.onProgress(it) }.onFailure { fallbackToast(it) }
</a><a href="#h47-0-351" id="h47-0-351" class="i">+                        }
</a><a href="#h47-0-352" id="h47-0-352" class="i">+                        pendingDownloadObject.downloadStage = DownloadStage.MERGING
</a><a href="#h47-0-353" id="h47-0-353" class="i">+
</a><a href="#h47-0-354" id="h47-0-354" class="i">+                        MediaDownloaderHelper.mergeOverlayFile(
</a><a href="#h47-0-355" id="h47-0-355" class="i">+                            media = renamedMedia,
</a><a href="#h47-0-356" id="h47-0-356" class="i">+                            overlay = renamedOverlayMedia,
</a><a href="#h47-0-357" id="h47-0-357" class="i">+                            output = mergedOverlay
</a><a href="#h47-0-358" id="h47-0-358" class="i">+                        )
</a><a href="#h47-0-359" id="h47-0-359" class="i">+
</a><a href="#h47-0-360" id="h47-0-360" class="i">+                        saveMediaToGallery(mergedOverlay, pendingDownloadObject)
</a><a href="#h47-0-361" id="h47-0-361" class="i">+                    }.onFailure { exception -&gt;
</a><a href="#h47-0-362" id="h47-0-362" class="i">+                        if (coroutineContext.job.isCancelled) return@onFailure
</a><a href="#h47-0-363" id="h47-0-363" class="i">+                        Logger.error(exception)
</a><a href="#h47-0-364" id="h47-0-364" class="i">+                        translation.format(&quot;failed_processing_toast&quot;, &quot;error&quot; to exception.toString()).let {
</a><a href="#h47-0-365" id="h47-0-365" class="i">+                            runCatching { callback.onFailure(it, exception.message) }.onFailure { fallbackToast(it) }
</a><a href="#h47-0-366" id="h47-0-366" class="i">+                        }
</a><a href="#h47-0-367" id="h47-0-367" class="i">+                        pendingDownloadObject.downloadStage = DownloadStage.MERGE_FAILED
</a><a href="#h47-0-368" id="h47-0-368" class="i">+                    }
</a><a href="#h47-0-369" id="h47-0-369" class="i">+
</a><a href="#h47-0-370" id="h47-0-370" class="i">+                    mergedOverlay.delete()
</a><a href="#h47-0-371" id="h47-0-371" class="i">+                    renamedOverlayMedia.delete()
</a><a href="#h47-0-372" id="h47-0-372" class="i">+                    renamedMedia.delete()
</a><a href="#h47-0-373" id="h47-0-373" class="i">+                    return@launch
</a><a href="#h47-0-374" id="h47-0-374" class="i">+                }
</a><a href="#h47-0-375" id="h47-0-375" class="i">+
</a><a href="#h47-0-376" id="h47-0-376" class="i">+                downloadRemoteMedia(pendingDownloadObject, downloadedMedias, downloadRequest)
</a><a href="#h47-0-377" id="h47-0-377" class="i">+            }.onFailure { exception -&gt;
</a><a href="#h47-0-378" id="h47-0-378" class="i">+                pendingDownloadObject.downloadStage = DownloadStage.FAILED
</a><a href="#h47-0-379" id="h47-0-379" class="i">+                Logger.error(exception)
</a><a href="#h47-0-380" id="h47-0-380" class="i">+                translation[&quot;failed_generic_toast&quot;].let {
</a><a href="#h47-0-381" id="h47-0-381" class="i">+                    runCatching { callback.onFailure(it, exception.message) }.onFailure { fallbackToast(it) }
</a><a href="#h47-0-382" id="h47-0-382" class="i">+                }
</a><a href="#h47-0-383" id="h47-0-383" class="i">+            }
</a><a href="#h47-0-384" id="h47-0-384" class="i">+        }
</a><a href="#h47-0-385" id="h47-0-385" class="i">+    }
</a><a href="#h47-0-386" id="h47-0-386" class="i">+}</a><a href="#h47-0-387" id="h47-0-387" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h48" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadTaskManager.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadTaskManager.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadTaskManager.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadTaskManager.kt</a></b>
<a href="#h48-0" id="h48-0" class="h">@@ -3,6 +3,7 @@ package me.rhunk.snapenhance.download
</a> import android.annotation.SuppressLint
 import android.content.Context
 import android.database.sqlite.SQLiteDatabase
<a href="#h48-0-3" id="h48-0-3" class="i">+import me.rhunk.snapenhance.download.data.DownloadMetadata
</a> import me.rhunk.snapenhance.download.data.PendingDownload
 import me.rhunk.snapenhance.download.enums.DownloadStage
 import me.rhunk.snapenhance.ui.download.MediaFilter
<a href="#h48-1" id="h48-1" class="h">@@ -35,42 +36,42 @@ class DownloadTaskManager {
</a>     fun addTask(task: PendingDownload): Int {
         taskDatabase.execSQL(&quot;INSERT INTO tasks (hash, outputPath, outputFile, mediaDisplayType, mediaDisplaySource, iconUrl, downloadStage) VALUES (?, ?, ?, ?, ?, ?, ?)&quot;,
             arrayOf(
<a href="#h48-1-3" id="h48-1-3" class="d">-                task.uniqueHash,
</a><a href="#h48-1-4" id="h48-1-4" class="d">-                task.outputPath,
</a><a href="#h48-1-5" id="h48-1-5" class="i">+                task.metadata.mediaIdentifier,
</a><a href="#h48-1-6" id="h48-1-6" class="i">+                task.metadata.outputPath,
</a>                 task.outputFile,
<a href="#h48-1-8" id="h48-1-8" class="d">-                task.mediaDisplayType,
</a><a href="#h48-1-9" id="h48-1-9" class="d">-                task.mediaDisplaySource,
</a><a href="#h48-1-10" id="h48-1-10" class="d">-                task.iconUrl,
</a><a href="#h48-1-11" id="h48-1-11" class="i">+                task.metadata.mediaDisplayType,
</a><a href="#h48-1-12" id="h48-1-12" class="i">+                task.metadata.mediaDisplaySource,
</a><a href="#h48-1-13" id="h48-1-13" class="i">+                task.metadata.iconUrl,
</a>                 task.downloadStage.name
             )
         )
<a href="#h48-1-17" id="h48-1-17" class="d">-        task.id = taskDatabase.rawQuery(&quot;SELECT last_insert_rowid()&quot;, null).use {
</a><a href="#h48-1-18" id="h48-1-18" class="i">+        task.downloadId = taskDatabase.rawQuery(&quot;SELECT last_insert_rowid()&quot;, null).use {
</a>             it.moveToFirst()
             it.getInt(0)
         }
<a href="#h48-1-22" id="h48-1-22" class="d">-        pendingTasks[task.id] = task
</a><a href="#h48-1-23" id="h48-1-23" class="d">-        return task.id
</a><a href="#h48-1-24" id="h48-1-24" class="i">+        pendingTasks[task.downloadId] = task
</a><a href="#h48-1-25" id="h48-1-25" class="i">+        return task.downloadId
</a>     }
 
     fun updateTask(task: PendingDownload) {
         taskDatabase.execSQL(&quot;UPDATE tasks SET hash = ?, outputPath = ?, outputFile = ?, mediaDisplayType = ?, mediaDisplaySource = ?, iconUrl = ?, downloadStage = ? WHERE id = ?&quot;,
             arrayOf(
<a href="#h48-1-31" id="h48-1-31" class="d">-                task.uniqueHash,
</a><a href="#h48-1-32" id="h48-1-32" class="d">-                task.outputPath,
</a><a href="#h48-1-33" id="h48-1-33" class="i">+                task.metadata.mediaIdentifier,
</a><a href="#h48-1-34" id="h48-1-34" class="i">+                task.metadata.outputPath,
</a>                 task.outputFile,
<a href="#h48-1-36" id="h48-1-36" class="d">-                task.mediaDisplayType,
</a><a href="#h48-1-37" id="h48-1-37" class="d">-                task.mediaDisplaySource,
</a><a href="#h48-1-38" id="h48-1-38" class="d">-                task.iconUrl,
</a><a href="#h48-1-39" id="h48-1-39" class="i">+                task.metadata.mediaDisplayType,
</a><a href="#h48-1-40" id="h48-1-40" class="i">+                task.metadata.mediaDisplaySource,
</a><a href="#h48-1-41" id="h48-1-41" class="i">+                task.metadata.iconUrl,
</a>                 task.downloadStage.name,
<a href="#h48-1-43" id="h48-1-43" class="d">-                task.id
</a><a href="#h48-1-44" id="h48-1-44" class="i">+                task.downloadId
</a>             )
         )
         //if the task is no longer active, move it to the cached tasks
         if (task.isJobActive()) {
<a href="#h48-1-49" id="h48-1-49" class="d">-            pendingTasks[task.id] = task
</a><a href="#h48-1-50" id="h48-1-50" class="i">+            pendingTasks[task.downloadId] = task
</a>         } else {
<a href="#h48-1-52" id="h48-1-52" class="d">-            pendingTasks.remove(task.id)
</a><a href="#h48-1-53" id="h48-1-53" class="d">-            cachedTasks[task.id] = task
</a><a href="#h48-1-54" id="h48-1-54" class="i">+            pendingTasks.remove(task.downloadId)
</a><a href="#h48-1-55" id="h48-1-55" class="i">+            cachedTasks[task.downloadId] = task
</a>         }
     }
 
<a href="#h48-2" id="h48-2" class="h">@@ -107,20 +108,20 @@ class DownloadTaskManager {
</a>     }
 
     fun removeTask(task: PendingDownload) {
<a href="#h48-2-3" id="h48-2-3" class="d">-        removeTask(task.id)
</a><a href="#h48-2-4" id="h48-2-4" class="i">+        removeTask(task.downloadId)
</a>     }
 
     fun queryAllTasks(filter: MediaFilter): Map&lt;Int, PendingDownload&gt; {
         val isPendingFilter = filter == MediaFilter.PENDING
         val tasks = mutableMapOf&lt;Int, PendingDownload&gt;()
 
<a href="#h48-2-11" id="h48-2-11" class="d">-        tasks.putAll(pendingTasks.filter { isPendingFilter || filter.matches(it.value.mediaDisplayType) })
</a><a href="#h48-2-12" id="h48-2-12" class="i">+        tasks.putAll(pendingTasks.filter { isPendingFilter || filter.matches(it.value.metadata.mediaDisplayType) })
</a>         if (isPendingFilter) {
             return tasks.toSortedMap(reverseOrder())
         }
 
         tasks.putAll(queryTasks(
<a href="#h48-2-18" id="h48-2-18" class="d">-            from = tasks.values.lastOrNull()?.id ?: Int.MAX_VALUE,
</a><a href="#h48-2-19" id="h48-2-19" class="i">+            from = tasks.values.lastOrNull()?.downloadId ?: Int.MAX_VALUE,
</a>             amount = 30,
             filter = filter
         ))
<a href="#h48-3" id="h48-3" class="h">@@ -147,13 +148,15 @@ class DownloadTaskManager {
</a> 
         while (cursor.moveToNext()) {
             val task = PendingDownload(
<a href="#h48-3-3" id="h48-3-3" class="d">-                id = cursor.getInt(cursor.getColumnIndex(&quot;id&quot;)),
</a><a href="#h48-3-4" id="h48-3-4" class="i">+                downloadId = cursor.getInt(cursor.getColumnIndex(&quot;id&quot;)),
</a>                 outputFile = cursor.getString(cursor.getColumnIndex(&quot;outputFile&quot;)),
<a href="#h48-3-6" id="h48-3-6" class="d">-                outputPath = cursor.getString(cursor.getColumnIndex(&quot;outputPath&quot;)),
</a><a href="#h48-3-7" id="h48-3-7" class="d">-                mediaDisplayType = cursor.getString(cursor.getColumnIndex(&quot;mediaDisplayType&quot;)),
</a><a href="#h48-3-8" id="h48-3-8" class="d">-                mediaDisplaySource = cursor.getString(cursor.getColumnIndex(&quot;mediaDisplaySource&quot;)),
</a><a href="#h48-3-9" id="h48-3-9" class="d">-                uniqueHash = cursor.getString(cursor.getColumnIndex(&quot;hash&quot;)),
</a><a href="#h48-3-10" id="h48-3-10" class="d">-                iconUrl = cursor.getString(cursor.getColumnIndex(&quot;iconUrl&quot;))
</a><a href="#h48-3-11" id="h48-3-11" class="i">+                metadata = DownloadMetadata(
</a><a href="#h48-3-12" id="h48-3-12" class="i">+                    outputPath = cursor.getString(cursor.getColumnIndex(&quot;outputPath&quot;)),
</a><a href="#h48-3-13" id="h48-3-13" class="i">+                    mediaIdentifier = cursor.getString(cursor.getColumnIndex(&quot;hash&quot;)),
</a><a href="#h48-3-14" id="h48-3-14" class="i">+                    mediaDisplayType = cursor.getString(cursor.getColumnIndex(&quot;mediaDisplayType&quot;)),
</a><a href="#h48-3-15" id="h48-3-15" class="i">+                    mediaDisplaySource = cursor.getString(cursor.getColumnIndex(&quot;mediaDisplaySource&quot;)),
</a><a href="#h48-3-16" id="h48-3-16" class="i">+                    iconUrl = cursor.getString(cursor.getColumnIndex(&quot;iconUrl&quot;))
</a><a href="#h48-3-17" id="h48-3-17" class="i">+                )
</a>             ).apply {
                 downloadStage = DownloadStage.valueOf(cursor.getString(cursor.getColumnIndex(&quot;downloadStage&quot;)))
                 //if downloadStage is not saved, it means the app was killed before the download was finished
<a href="#h48-4" id="h48-4" class="h">@@ -161,7 +164,7 @@ class DownloadTaskManager {
</a>                     downloadStage = DownloadStage.FAILED
                 }
             }
<a href="#h48-4-3" id="h48-4-3" class="d">-            result[task.id] = task
</a><a href="#h48-4-4" id="h48-4-4" class="i">+            result[task.downloadId] = task
</a>         }
         cursor.close()
 
<b>diff --git a/<a id="h49" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/download/data/DownloadMetadata.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/download/data/DownloadMetadata.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/download/data/DownloadMetadata.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/download/data/DownloadMetadata.kt</a></b>
<a href="#h49-0" id="h49-0" class="h">@@ -0,0 +1,9 @@
</a><a href="#h49-0-0" id="h49-0-0" class="i">+package me.rhunk.snapenhance.download.data
</a><a href="#h49-0-1" id="h49-0-1" class="i">+
</a><a href="#h49-0-2" id="h49-0-2" class="i">+data class DownloadMetadata(
</a><a href="#h49-0-3" id="h49-0-3" class="i">+    val mediaIdentifier: String?,
</a><a href="#h49-0-4" id="h49-0-4" class="i">+    val outputPath: String,
</a><a href="#h49-0-5" id="h49-0-5" class="i">+    val mediaDisplaySource: String?,
</a><a href="#h49-0-6" id="h49-0-6" class="i">+    val mediaDisplayType: String?,
</a><a href="#h49-0-7" id="h49-0-7" class="i">+    val iconUrl: String?
</a><a href="#h49-0-8" id="h49-0-8" class="i">+)</a><a href="#h49-0-9" id="h49-0-9" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h50" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/download/data/DownloadRequest.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/download/data/DownloadRequest.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/download/data/DownloadRequest.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/download/data/DownloadRequest.kt</a></b>
<a href="#h50-0" id="h50-0" class="h">@@ -1,6 +1,5 @@
</a> package me.rhunk.snapenhance.download.data
 
<a href="#h50-0-2" id="h50-0-2" class="d">-import android.os.Bundle
</a> import me.rhunk.snapenhance.download.enums.DownloadMediaType
 
 
<a href="#h50-1" id="h50-1" class="h">@@ -12,64 +11,12 @@ data class InputMedia(
</a> )
 
 class DownloadRequest(
<a href="#h50-1-3" id="h50-1-3" class="d">-    private val outputPath: String = &quot;&quot;,
</a><a href="#h50-1-4" id="h50-1-4" class="d">-    private val inputMedias: Array&lt;String&gt;,
</a><a href="#h50-1-5" id="h50-1-5" class="d">-    private val inputTypes: Array&lt;String&gt;,
</a><a href="#h50-1-6" id="h50-1-6" class="d">-    private val mediaEncryption: Map&lt;String, MediaEncryptionKeyPair&gt; = emptyMap(),
</a><a href="#h50-1-7" id="h50-1-7" class="i">+    val inputMedias: Array&lt;InputMedia&gt;,
</a><a href="#h50-1-8" id="h50-1-8" class="i">+    val dashOptions: DashOptions? = null,
</a>     private val flags: Int = 0,
<a href="#h50-1-10" id="h50-1-10" class="d">-    private val dashOptions: Map&lt;String, String?&gt;? = null,
</a><a href="#h50-1-11" id="h50-1-11" class="d">-    private val mediaDisplaySource: String? = null,
</a><a href="#h50-1-12" id="h50-1-12" class="d">-    private val mediaDisplayType: String? = null,
</a><a href="#h50-1-13" id="h50-1-13" class="d">-    private val uniqueHash: String? = null
</a> ) {
<a href="#h50-1-15" id="h50-1-15" class="d">-    companion object {
</a><a href="#h50-1-16" id="h50-1-16" class="d">-        fun fromBundle(bundle: Bundle): DownloadRequest {
</a><a href="#h50-1-17" id="h50-1-17" class="d">-            return DownloadRequest(
</a><a href="#h50-1-18" id="h50-1-18" class="d">-                outputPath = bundle.getString(&quot;outputPath&quot;)!!,
</a><a href="#h50-1-19" id="h50-1-19" class="d">-                mediaDisplaySource = bundle.getString(&quot;mediaDisplaySource&quot;),
</a><a href="#h50-1-20" id="h50-1-20" class="d">-                mediaDisplayType = bundle.getString(&quot;mediaDisplayType&quot;),
</a><a href="#h50-1-21" id="h50-1-21" class="d">-                inputMedias = bundle.getStringArray(&quot;inputMedias&quot;)!!,
</a><a href="#h50-1-22" id="h50-1-22" class="d">-                inputTypes = bundle.getStringArray(&quot;inputTypes&quot;)!!,
</a><a href="#h50-1-23" id="h50-1-23" class="d">-                mediaEncryption = bundle.getStringArray(&quot;mediaEncryption&quot;)?.associate { entry -&gt;
</a><a href="#h50-1-24" id="h50-1-24" class="d">-                    entry.split(&quot;|&quot;).let {
</a><a href="#h50-1-25" id="h50-1-25" class="d">-                        it[0] to MediaEncryptionKeyPair(it[1], it[2])
</a><a href="#h50-1-26" id="h50-1-26" class="d">-                    }
</a><a href="#h50-1-27" id="h50-1-27" class="d">-                } ?: emptyMap(),
</a><a href="#h50-1-28" id="h50-1-28" class="d">-                dashOptions = bundle.getBundle(&quot;dashOptions&quot;)?.let { options -&gt;
</a><a href="#h50-1-29" id="h50-1-29" class="d">-                    options.keySet().associateWith { key -&gt;
</a><a href="#h50-1-30" id="h50-1-30" class="d">-                        options.getString(key)
</a><a href="#h50-1-31" id="h50-1-31" class="d">-                    }
</a><a href="#h50-1-32" id="h50-1-32" class="d">-                },
</a><a href="#h50-1-33" id="h50-1-33" class="d">-                flags = bundle.getInt(&quot;flags&quot;, 0),
</a><a href="#h50-1-34" id="h50-1-34" class="d">-                uniqueHash = bundle.getString(&quot;uniqueHash&quot;)
</a><a href="#h50-1-35" id="h50-1-35" class="d">-            )
</a><a href="#h50-1-36" id="h50-1-36" class="d">-        }
</a><a href="#h50-1-37" id="h50-1-37" class="d">-    }
</a><a href="#h50-1-38" id="h50-1-38" class="d">-
</a><a href="#h50-1-39" id="h50-1-39" class="d">-    fun toBundle(): Bundle {
</a><a href="#h50-1-40" id="h50-1-40" class="d">-        return Bundle().apply {
</a><a href="#h50-1-41" id="h50-1-41" class="d">-            putString(&quot;outputPath&quot;, outputPath)
</a><a href="#h50-1-42" id="h50-1-42" class="d">-            putString(&quot;mediaDisplaySource&quot;, mediaDisplaySource)
</a><a href="#h50-1-43" id="h50-1-43" class="d">-            putString(&quot;mediaDisplayType&quot;, mediaDisplayType)
</a><a href="#h50-1-44" id="h50-1-44" class="d">-            putStringArray(&quot;inputMedias&quot;, inputMedias)
</a><a href="#h50-1-45" id="h50-1-45" class="d">-            putStringArray(&quot;inputTypes&quot;, inputTypes)
</a><a href="#h50-1-46" id="h50-1-46" class="d">-            putStringArray(&quot;mediaEncryption&quot;, mediaEncryption.map { entry -&gt;
</a><a href="#h50-1-47" id="h50-1-47" class="d">-                &quot;${entry.key}|${entry.value.key}|${entry.value.iv}&quot;
</a><a href="#h50-1-48" id="h50-1-48" class="d">-            }.toTypedArray())
</a><a href="#h50-1-49" id="h50-1-49" class="d">-            putBundle(&quot;dashOptions&quot;, dashOptions?.let { bundle -&gt;
</a><a href="#h50-1-50" id="h50-1-50" class="d">-                Bundle().apply {
</a><a href="#h50-1-51" id="h50-1-51" class="d">-                    bundle.forEach { (key, value) -&gt;
</a><a href="#h50-1-52" id="h50-1-52" class="d">-                        putString(key, value)
</a><a href="#h50-1-53" id="h50-1-53" class="d">-                    }
</a><a href="#h50-1-54" id="h50-1-54" class="d">-                }
</a><a href="#h50-1-55" id="h50-1-55" class="d">-            })
</a><a href="#h50-1-56" id="h50-1-56" class="d">-            putInt(&quot;flags&quot;, flags)
</a><a href="#h50-1-57" id="h50-1-57" class="d">-            putString(&quot;uniqueHash&quot;, uniqueHash)
</a><a href="#h50-1-58" id="h50-1-58" class="d">-        }
</a><a href="#h50-1-59" id="h50-1-59" class="d">-    }
</a><a href="#h50-1-60" id="h50-1-60" class="d">-
</a>     object Flags {
<a href="#h50-1-62" id="h50-1-62" class="d">-        const val SHOULD_MERGE_OVERLAY = 1
</a><a href="#h50-1-63" id="h50-1-63" class="i">+        const val MERGE_OVERLAY = 1
</a>         const val IS_DASH_PLAYLIST = 2
     }
 
<a href="#h50-2" id="h50-2" class="h">@@ -77,30 +24,5 @@ class DownloadRequest(
</a>         get() = flags and Flags.IS_DASH_PLAYLIST != 0
 
     val shouldMergeOverlay: Boolean
<a href="#h50-2-3" id="h50-2-3" class="d">-        get() = flags and Flags.SHOULD_MERGE_OVERLAY != 0
</a><a href="#h50-2-4" id="h50-2-4" class="d">-
</a><a href="#h50-2-5" id="h50-2-5" class="d">-    fun getDashOptions(): DashOptions? {
</a><a href="#h50-2-6" id="h50-2-6" class="d">-        return dashOptions?.let {
</a><a href="#h50-2-7" id="h50-2-7" class="d">-            DashOptions(
</a><a href="#h50-2-8" id="h50-2-8" class="d">-                offsetTime = it[&quot;offsetTime&quot;]?.toLong() ?: 0,
</a><a href="#h50-2-9" id="h50-2-9" class="d">-                duration = it[&quot;duration&quot;]?.toLong()
</a><a href="#h50-2-10" id="h50-2-10" class="d">-            )
</a><a href="#h50-2-11" id="h50-2-11" class="d">-        }
</a><a href="#h50-2-12" id="h50-2-12" class="d">-    }
</a><a href="#h50-2-13" id="h50-2-13" class="d">-
</a><a href="#h50-2-14" id="h50-2-14" class="d">-    fun getInputMedias(): List&lt;InputMedia&gt; {
</a><a href="#h50-2-15" id="h50-2-15" class="d">-        return inputMedias.mapIndexed { index, uri -&gt;
</a><a href="#h50-2-16" id="h50-2-16" class="d">-            InputMedia(
</a><a href="#h50-2-17" id="h50-2-17" class="d">-                content = uri,
</a><a href="#h50-2-18" id="h50-2-18" class="d">-                type = DownloadMediaType.valueOf(inputTypes[index]),
</a><a href="#h50-2-19" id="h50-2-19" class="d">-                encryption = mediaEncryption.getOrDefault(uri, null)
</a><a href="#h50-2-20" id="h50-2-20" class="d">-            )
</a><a href="#h50-2-21" id="h50-2-21" class="d">-        }
</a><a href="#h50-2-22" id="h50-2-22" class="d">-    }
</a><a href="#h50-2-23" id="h50-2-23" class="d">-
</a><a href="#h50-2-24" id="h50-2-24" class="d">-    fun getInputType(index: Int): DownloadMediaType? {
</a><a href="#h50-2-25" id="h50-2-25" class="d">-        return inputTypes.getOrNull(index)?.let { DownloadMediaType.valueOf(it) }
</a><a href="#h50-2-26" id="h50-2-26" class="d">-    }
</a><a href="#h50-2-27" id="h50-2-27" class="d">-
</a><a href="#h50-2-28" id="h50-2-28" class="d">-    fun getUniqueHash() = uniqueHash
</a><a href="#h50-2-29" id="h50-2-29" class="i">+        get() = flags and Flags.MERGE_OVERLAY != 0
</a> } 
\ No newline at end of file
<b>diff --git a/<a id="h51" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/download/data/PendingDownload.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/download/data/PendingDownload.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/download/data/PendingDownload.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/download/data/PendingDownload.kt</a></b>
<a href="#h51-0" id="h51-0" class="h">@@ -1,33 +1,16 @@
</a> package me.rhunk.snapenhance.download.data
 
<a href="#h51-0-2" id="h51-0-2" class="d">-import android.os.Bundle
</a> import kotlinx.coroutines.Job
 import me.rhunk.snapenhance.SharedContext
 import me.rhunk.snapenhance.download.enums.DownloadStage
 
 data class PendingDownload(
<a href="#h51-0-8" id="h51-0-8" class="i">+    var downloadId: Int = 0,
</a>     var outputFile: String? = null,
     var job: Job? = null,
 
<a href="#h51-0-12" id="h51-0-12" class="d">-    var id: Int = 0,
</a><a href="#h51-0-13" id="h51-0-13" class="d">-    val outputPath: String,
</a><a href="#h51-0-14" id="h51-0-14" class="d">-    val mediaDisplayType: String?,
</a><a href="#h51-0-15" id="h51-0-15" class="d">-    val mediaDisplaySource: String?,
</a><a href="#h51-0-16" id="h51-0-16" class="d">-    val iconUrl: String?,
</a><a href="#h51-0-17" id="h51-0-17" class="d">-    val uniqueHash: String?
</a><a href="#h51-0-18" id="h51-0-18" class="i">+    val metadata : DownloadMetadata
</a> ) {
<a href="#h51-0-20" id="h51-0-20" class="d">-    companion object {
</a><a href="#h51-0-21" id="h51-0-21" class="d">-        fun fromBundle(bundle: Bundle): PendingDownload {
</a><a href="#h51-0-22" id="h51-0-22" class="d">-            return PendingDownload(
</a><a href="#h51-0-23" id="h51-0-23" class="d">-                outputPath = bundle.getString(&quot;outputPath&quot;)!!,
</a><a href="#h51-0-24" id="h51-0-24" class="d">-                mediaDisplayType = bundle.getString(&quot;mediaDisplayType&quot;),
</a><a href="#h51-0-25" id="h51-0-25" class="d">-                mediaDisplaySource = bundle.getString(&quot;mediaDisplaySource&quot;),
</a><a href="#h51-0-26" id="h51-0-26" class="d">-                iconUrl = bundle.getString(&quot;iconUrl&quot;),
</a><a href="#h51-0-27" id="h51-0-27" class="d">-                uniqueHash = bundle.getString(&quot;uniqueHash&quot;)
</a><a href="#h51-0-28" id="h51-0-28" class="d">-            )
</a><a href="#h51-0-29" id="h51-0-29" class="d">-        }
</a><a href="#h51-0-30" id="h51-0-30" class="d">-    }
</a><a href="#h51-0-31" id="h51-0-31" class="d">-
</a>     var changeListener = { _: DownloadStage, _: DownloadStage -&gt; }
     private var _stage: DownloadStage = DownloadStage.PENDING
     var downloadStage: DownloadStage
<b>diff --git a/<a id="h52" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/download/data/SplitMediaAssetType.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/download/data/SplitMediaAssetType.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/download/data/SplitMediaAssetType.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/download/data/SplitMediaAssetType.kt</a></b>
<a href="#h52-0" id="h52-0" class="h">@@ -0,0 +1,5 @@
</a><a href="#h52-0-0" id="h52-0-0" class="i">+package me.rhunk.snapenhance.download.data
</a><a href="#h52-0-1" id="h52-0-1" class="i">+
</a><a href="#h52-0-2" id="h52-0-2" class="i">+enum class SplitMediaAssetType {
</a><a href="#h52-0-3" id="h52-0-3" class="i">+    ORIGINAL, OVERLAY
</a><a href="#h52-0-4" id="h52-0-4" class="i">+}
</a><b>diff --git a/<a id="h53" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/BridgeFileFeature.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/BridgeFileFeature.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/BridgeFileFeature.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/BridgeFileFeature.kt</a></b>
<a href="#h53-0" id="h53-0" class="h">@@ -1,6 +1,6 @@
</a> package me.rhunk.snapenhance.features
 
<a href="#h53-0-2" id="h53-0-2" class="d">-import me.rhunk.snapenhance.bridge.common.impl.file.BridgeFileType
</a><a href="#h53-0-3" id="h53-0-3" class="i">+import me.rhunk.snapenhance.bridge.types.BridgeFileType
</a> import java.io.BufferedReader
 import java.io.ByteArrayInputStream
 import java.io.InputStreamReader
<b>diff --git a/<a id="h54" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/Feature.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/Feature.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/Feature.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/Feature.kt</a></b>
<a href="#h54-0" id="h54-0" class="h">@@ -28,4 +28,8 @@ abstract class Feature(
</a>      * called on a dedicated thread when the Snapchat Activity is created
      */
     open fun asyncOnActivityCreate() {}
<a href="#h54-0-3" id="h54-0-3" class="i">+
</a><a href="#h54-0-4" id="h54-0-4" class="i">+    protected fun findClass(name: String): Class&lt;*&gt; {
</a><a href="#h54-0-5" id="h54-0-5" class="i">+        return context.androidContext.classLoader.loadClass(name)
</a><a href="#h54-0-6" id="h54-0-6" class="i">+    }
</a> } 
\ No newline at end of file
<b>diff --git a/<a id="h55" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/AutoUpdater.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/AutoUpdater.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/AutoUpdater.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/AutoUpdater.kt</a></b>
<a href="#h55-0" id="h55-0" class="h">@@ -14,6 +14,7 @@ import me.rhunk.snapenhance.Logger
</a> import me.rhunk.snapenhance.config.ConfigProperty
 import me.rhunk.snapenhance.features.Feature
 import me.rhunk.snapenhance.features.FeatureLoadParams
<a href="#h55-0-3" id="h55-0-3" class="i">+import me.rhunk.snapenhance.ui.ViewAppearanceHelper
</a> import okhttp3.OkHttpClient
 import okhttp3.Request
 import org.json.JSONArray
<a href="#h55-1" id="h55-1" class="h">@@ -61,7 +62,7 @@ class AutoUpdater : Feature(&quot;AutoUpdater&quot;, loadParams = FeatureLoadParams.ACTIVI
</a>         val downloadEndpoint = latestRelease.getJSONArray(&quot;assets&quot;).getJSONObject(0).getString(&quot;browser_download_url&quot;)
 
         context.runOnUiThread {
<a href="#h55-1-3" id="h55-1-3" class="d">-            AlertDialog.Builder(context.mainActivity)
</a><a href="#h55-1-4" id="h55-1-4" class="i">+            ViewAppearanceHelper.newAlertDialogBuilder(context.mainActivity)
</a>                 .setTitle(context.translation[&quot;auto_updater.dialog_title&quot;])
                 .setMessage(
                     context.translation.format(&quot;auto_updater.dialog_message&quot;,
<b>diff --git a/<a id="h56" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/Messaging.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/Messaging.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/Messaging.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/Messaging.kt</a></b>
<a href="#h56-0" id="h56-0" class="h">@@ -1,5 +1,6 @@
</a> package me.rhunk.snapenhance.features.impl
 
<a href="#h56-0-2" id="h56-0-2" class="i">+import me.rhunk.snapenhance.Logger
</a> import me.rhunk.snapenhance.config.ConfigProperty
 import me.rhunk.snapenhance.data.wrapper.impl.SnapUUID
 import me.rhunk.snapenhance.features.Feature
<a href="#h56-1" id="h56-1" class="h">@@ -13,9 +14,9 @@ class Messaging : Feature(&quot;Messaging&quot;, loadParams = FeatureLoadParams.ACTIVITY_C
</a>     lateinit var conversationManager: Any
 
     var openedConversationUUID: SnapUUID? = null
<a href="#h56-1-3" id="h56-1-3" class="d">-    var lastOpenedConversationUUID: SnapUUID? = null
</a>     var lastFetchConversationUserUUID: SnapUUID? = null
     var lastFetchConversationUUID: SnapUUID? = null
<a href="#h56-1-6" id="h56-1-6" class="i">+    var lastFetchGroupConversationUUID: SnapUUID? = null
</a>     var lastFocusedMessageId: Long = -1
 
     override fun init() {
<a href="#h56-2" id="h56-2" class="h">@@ -25,6 +26,17 @@ class Messaging : Feature(&quot;Messaging&quot;, loadParams = FeatureLoadParams.ACTIVITY_C
</a>     }
 
     override fun onActivityCreate() {
<a href="#h56-2-3" id="h56-2-3" class="i">+        context.mappings.getMappedObjectNullable(&quot;FriendsFeedEventDispatcher&quot;).let { it as? Map&lt;*, *&gt; }?.let { mappings -&gt;
</a><a href="#h56-2-4" id="h56-2-4" class="i">+            findClass(mappings[&quot;class&quot;].toString()).hook(&quot;onItemLongPress&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h56-2-5" id="h56-2-5" class="i">+                val viewItemContainer = param.arg&lt;Any&gt;(0)
</a><a href="#h56-2-6" id="h56-2-6" class="i">+                val viewItem = viewItemContainer.getObjectField(mappings[&quot;viewModelField&quot;].toString()).toString()
</a><a href="#h56-2-7" id="h56-2-7" class="i">+                val conversationId = viewItem.substringAfter(&quot;conversationId: &quot;).substring(0, 36).also {
</a><a href="#h56-2-8" id="h56-2-8" class="i">+                    if (it.startsWith(&quot;null&quot;)) return@hook
</a><a href="#h56-2-9" id="h56-2-9" class="i">+                }
</a><a href="#h56-2-10" id="h56-2-10" class="i">+                lastFetchGroupConversationUUID = SnapUUID.fromString(conversationId)
</a><a href="#h56-2-11" id="h56-2-11" class="i">+            }
</a><a href="#h56-2-12" id="h56-2-12" class="i">+        }
</a><a href="#h56-2-13" id="h56-2-13" class="i">+
</a>         context.mappings.getMappedClass(&quot;callbacks&quot;, &quot;GetOneOnOneConversationIdsCallback&quot;).hook(&quot;onSuccess&quot;, HookStage.BEFORE) { param -&gt;
             val userIdToConversation = (param.arg&lt;ArrayList&lt;*&gt;&gt;(0))
                 .takeIf { it.isNotEmpty() }
<b>diff --git a/<a id="h57" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/AntiAutoDownload.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/AntiAutoDownload.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/AntiAutoDownload.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/AntiAutoDownload.kt</a></b>
<a href="#h57-0" id="h57-0" class="h">@@ -1,6 +1,6 @@
</a> package me.rhunk.snapenhance.features.impl.downloader
 
<a href="#h57-0-2" id="h57-0-2" class="d">-import me.rhunk.snapenhance.bridge.common.impl.file.BridgeFileType
</a><a href="#h57-0-3" id="h57-0-3" class="i">+import me.rhunk.snapenhance.bridge.types.BridgeFileType
</a> import me.rhunk.snapenhance.features.BridgeFileFeature
 import me.rhunk.snapenhance.features.FeatureLoadParams
 
<b>diff --git a/<a id="h58" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/MediaDownloader.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/MediaDownloader.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/MediaDownloader.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/MediaDownloader.kt</a></b>
<a href="#h58-0" id="h58-0" class="h">@@ -1,6 +1,5 @@
</a> package me.rhunk.snapenhance.features.impl.downloader
 
<a href="#h58-0-2" id="h58-0-2" class="d">-import android.app.AlertDialog
</a> import android.content.DialogInterface
 import android.graphics.Bitmap
 import android.graphics.BitmapFactory
<a href="#h58-1" id="h58-1" class="h">@@ -9,10 +8,13 @@ import android.widget.ImageView
</a> import com.arthenica.ffmpegkit.FFmpegKit
 import kotlinx.coroutines.runBlocking
 import me.rhunk.snapenhance.Constants.ARROYO_URL_KEY_PROTO_PATH
<a href="#h58-1-3" id="h58-1-3" class="i">+import me.rhunk.snapenhance.Logger
</a> import me.rhunk.snapenhance.Logger.xposedLog
<a href="#h58-1-5" id="h58-1-5" class="i">+import me.rhunk.snapenhance.bridge.DownloadCallback
</a> import me.rhunk.snapenhance.config.ConfigProperty
 import me.rhunk.snapenhance.data.ContentType
 import me.rhunk.snapenhance.data.FileType
<a href="#h58-1-9" id="h58-1-9" class="i">+import me.rhunk.snapenhance.data.wrapper.impl.SnapUUID
</a> import me.rhunk.snapenhance.data.wrapper.impl.media.MediaInfo
 import me.rhunk.snapenhance.data.wrapper.impl.media.dash.LongformVideoPlaylistItem
 import me.rhunk.snapenhance.data.wrapper.impl.media.dash.SnapPlaylistItem
<a href="#h58-2" id="h58-2" class="h">@@ -20,6 +22,9 @@ import me.rhunk.snapenhance.data.wrapper.impl.media.opera.Layer
</a> import me.rhunk.snapenhance.data.wrapper.impl.media.opera.ParamMap
 import me.rhunk.snapenhance.database.objects.FriendInfo
 import me.rhunk.snapenhance.download.DownloadManagerClient
<a href="#h58-2-3" id="h58-2-3" class="i">+import me.rhunk.snapenhance.download.data.DownloadMetadata
</a><a href="#h58-2-4" id="h58-2-4" class="i">+import me.rhunk.snapenhance.download.data.InputMedia
</a><a href="#h58-2-5" id="h58-2-5" class="i">+import me.rhunk.snapenhance.download.data.SplitMediaAssetType
</a> import me.rhunk.snapenhance.download.data.toKeyPair
 import me.rhunk.snapenhance.download.enums.DownloadMediaType
 import me.rhunk.snapenhance.features.Feature
<a href="#h58-3" id="h58-3" class="h">@@ -29,6 +34,7 @@ import me.rhunk.snapenhance.features.impl.spying.MessageLogger
</a> import me.rhunk.snapenhance.hook.HookAdapter
 import me.rhunk.snapenhance.hook.HookStage
 import me.rhunk.snapenhance.hook.Hooker
<a href="#h58-3-3" id="h58-3-3" class="i">+import me.rhunk.snapenhance.ui.ViewAppearanceHelper
</a> import me.rhunk.snapenhance.ui.download.MediaFilter
 import me.rhunk.snapenhance.util.download.RemoteMediaResolver
 import me.rhunk.snapenhance.util.getObjectField
<a href="#h58-4" id="h58-4" class="h">@@ -36,20 +42,17 @@ import me.rhunk.snapenhance.util.protobuf.ProtoReader
</a> import me.rhunk.snapenhance.util.snap.BitmojiSelfie
 import me.rhunk.snapenhance.util.snap.EncryptionHelper
 import me.rhunk.snapenhance.util.snap.MediaDownloaderHelper
<a href="#h58-4-3" id="h58-4-3" class="d">-import me.rhunk.snapenhance.util.snap.MediaType
</a> import me.rhunk.snapenhance.util.snap.PreviewUtils
<a href="#h58-4-5" id="h58-4-5" class="d">-import java.io.File
</a> import java.nio.file.Paths
 import java.text.SimpleDateFormat
 import java.util.Locale
 import kotlin.coroutines.suspendCoroutine
 import kotlin.io.encoding.Base64
 import kotlin.io.encoding.ExperimentalEncodingApi
<a href="#h58-4-12" id="h58-4-12" class="d">-import kotlin.io.path.inputStream
</a> 
 @OptIn(ExperimentalEncodingApi::class)
 class MediaDownloader : Feature(&quot;MediaDownloader&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_ASYNC) {
<a href="#h58-4-16" id="h58-4-16" class="d">-    private var lastSeenMediaInfoMap: MutableMap&lt;MediaType, MediaInfo&gt;? = null
</a><a href="#h58-4-17" id="h58-4-17" class="i">+    private var lastSeenMediaInfoMap: MutableMap&lt;SplitMediaAssetType, MediaInfo&gt;? = null
</a>     private var lastSeenMapParams: ParamMap? = null
     private val isFFmpegPresent by lazy {
         runCatching { FFmpegKit.execute(&quot;-version&quot;) }.isSuccess
<a href="#h58-5" id="h58-5" class="h">@@ -70,22 +73,47 @@ class MediaDownloader : Feature(&quot;MediaDownloader&quot;, loadParams = FeatureLoadParam
</a>             BitmojiSelfie.getBitmojiSelfie(it.bitmojiSelfieId!!, it.bitmojiAvatarId!!, BitmojiSelfie.BitmojiSelfieType.THREE_D)
         }
 
<a href="#h58-5-3" id="h58-5-3" class="d">-        val outputPath = File(
</a><a href="#h58-5-4" id="h58-5-4" class="d">-            context.config.string(ConfigProperty.SAVE_FOLDER),
</a><a href="#h58-5-5" id="h58-5-5" class="d">-            createNewFilePath(generatedHash, mediaDisplayType, pathSuffix)
</a><a href="#h58-5-6" id="h58-5-6" class="d">-        ).absolutePath
</a><a href="#h58-5-7" id="h58-5-7" class="i">+        val downloadLogging = context.config.options(ConfigProperty.DOWNLOAD_LOGGING)
</a><a href="#h58-5-8" id="h58-5-8" class="i">+        if (downloadLogging[&quot;started&quot;] == true) {
</a><a href="#h58-5-9" id="h58-5-9" class="i">+            context.shortToast(context.translation[&quot;download_processor.download_started_toast&quot;])
</a><a href="#h58-5-10" id="h58-5-10" class="i">+        }
</a><a href="#h58-5-11" id="h58-5-11" class="i">+
</a><a href="#h58-5-12" id="h58-5-12" class="i">+        val outputPath = createNewFilePath(generatedHash, mediaDisplayType, pathSuffix)
</a> 
         return DownloadManagerClient(
             context = context,
<a href="#h58-5-16" id="h58-5-16" class="d">-            mediaDisplaySource = mediaDisplaySource,
</a><a href="#h58-5-17" id="h58-5-17" class="d">-            mediaDisplayType = mediaDisplayType,
</a><a href="#h58-5-18" id="h58-5-18" class="d">-            iconUrl = iconUrl,
</a><a href="#h58-5-19" id="h58-5-19" class="d">-            uniqueHash =
</a><a href="#h58-5-20" id="h58-5-20" class="d">-            // If duplicate is allowed, we don&#39;t need to pass the hash
</a><a href="#h58-5-21" id="h58-5-21" class="d">-            if (context.config.options(ConfigProperty.DOWNLOAD_OPTIONS)[&quot;allow_duplicate&quot;] == false) {
</a><a href="#h58-5-22" id="h58-5-22" class="d">-                generatedHash
</a><a href="#h58-5-23" id="h58-5-23" class="d">-            } else null,
</a><a href="#h58-5-24" id="h58-5-24" class="d">-            outputPath = outputPath
</a><a href="#h58-5-25" id="h58-5-25" class="i">+            metadata = DownloadMetadata(
</a><a href="#h58-5-26" id="h58-5-26" class="i">+                mediaIdentifier = if (context.config.options(ConfigProperty.DOWNLOAD_OPTIONS)[&quot;allow_duplicate&quot;] == false) {
</a><a href="#h58-5-27" id="h58-5-27" class="i">+                    generatedHash
</a><a href="#h58-5-28" id="h58-5-28" class="i">+                } else null,
</a><a href="#h58-5-29" id="h58-5-29" class="i">+                mediaDisplaySource = mediaDisplaySource,
</a><a href="#h58-5-30" id="h58-5-30" class="i">+                mediaDisplayType = mediaDisplayType,
</a><a href="#h58-5-31" id="h58-5-31" class="i">+                iconUrl = iconUrl,
</a><a href="#h58-5-32" id="h58-5-32" class="i">+                outputPath = outputPath
</a><a href="#h58-5-33" id="h58-5-33" class="i">+            ),
</a><a href="#h58-5-34" id="h58-5-34" class="i">+            callback = object: DownloadCallback.Stub() {
</a><a href="#h58-5-35" id="h58-5-35" class="i">+                override fun onSuccess(outputFile: String) {
</a><a href="#h58-5-36" id="h58-5-36" class="i">+                    if (downloadLogging[&quot;success&quot;] != true) return
</a><a href="#h58-5-37" id="h58-5-37" class="i">+                    Logger.debug(&quot;onSuccess: outputFile=$outputFile&quot;)
</a><a href="#h58-5-38" id="h58-5-38" class="i">+                    context.shortToast(context.translation.format(&quot;download_processor.saved_toast&quot;, &quot;path&quot; to outputFile.split(&quot;/&quot;).takeLast(2).joinToString(&quot;/&quot;)))
</a><a href="#h58-5-39" id="h58-5-39" class="i">+                }
</a><a href="#h58-5-40" id="h58-5-40" class="i">+
</a><a href="#h58-5-41" id="h58-5-41" class="i">+                override fun onProgress(message: String) {
</a><a href="#h58-5-42" id="h58-5-42" class="i">+                    if (downloadLogging[&quot;progress&quot;] != true) return
</a><a href="#h58-5-43" id="h58-5-43" class="i">+                    Logger.debug(&quot;onProgress: message=$message&quot;)
</a><a href="#h58-5-44" id="h58-5-44" class="i">+                    context.shortToast(message)
</a><a href="#h58-5-45" id="h58-5-45" class="i">+                }
</a><a href="#h58-5-46" id="h58-5-46" class="i">+
</a><a href="#h58-5-47" id="h58-5-47" class="i">+                override fun onFailure(message: String, throwable: String?) {
</a><a href="#h58-5-48" id="h58-5-48" class="i">+                    if (downloadLogging[&quot;failure&quot;] != true) return
</a><a href="#h58-5-49" id="h58-5-49" class="i">+                    Logger.debug(&quot;onFailure: message=$message, throwable=$throwable&quot;)
</a><a href="#h58-5-50" id="h58-5-50" class="i">+                    throwable?.let {
</a><a href="#h58-5-51" id="h58-5-51" class="i">+                        context.longToast((message + it.takeIf { it.isNotEmpty() }.orEmpty()))
</a><a href="#h58-5-52" id="h58-5-52" class="i">+                        return
</a><a href="#h58-5-53" id="h58-5-53" class="i">+                    }
</a><a href="#h58-5-54" id="h58-5-54" class="i">+                    context.shortToast(message)
</a><a href="#h58-5-55" id="h58-5-55" class="i">+                }
</a><a href="#h58-5-56" id="h58-5-56" class="i">+            }
</a>         )
     }
 
<a href="#h58-6" id="h58-6" class="h">@@ -162,28 +190,31 @@ class MediaDownloader : Feature(&quot;MediaDownloader&quot;, loadParams = FeatureLoadParam
</a>         }
     }
 
<a href="#h58-6-3" id="h58-6-3" class="d">-    private fun downloadOperaMedia(downloadManagerClient: DownloadManagerClient, mediaInfoMap: Map&lt;MediaType, MediaInfo&gt;) {
</a><a href="#h58-6-4" id="h58-6-4" class="i">+    private fun downloadOperaMedia(downloadManagerClient: DownloadManagerClient, mediaInfoMap: Map&lt;SplitMediaAssetType, MediaInfo&gt;) {
</a>         if (mediaInfoMap.isEmpty()) return
 
<a href="#h58-6-7" id="h58-6-7" class="d">-        val originalMediaInfo = mediaInfoMap[MediaType.ORIGINAL]!!
</a><a href="#h58-6-8" id="h58-6-8" class="d">-        val overlay = mediaInfoMap[MediaType.OVERLAY]
</a><a href="#h58-6-9" id="h58-6-9" class="d">-
</a><a href="#h58-6-10" id="h58-6-10" class="i">+        val originalMediaInfo = mediaInfoMap[SplitMediaAssetType.ORIGINAL]!!
</a>         val originalMediaInfoReference = handleLocalReferences(originalMediaInfo.uri)
<a href="#h58-6-12" id="h58-6-12" class="d">-        val overlayReference = overlay?.let { handleLocalReferences(it.uri) }
</a> 
<a href="#h58-6-14" id="h58-6-14" class="d">-        overlay?.let {
</a><a href="#h58-6-15" id="h58-6-15" class="i">+        mediaInfoMap[SplitMediaAssetType.OVERLAY]?.let { overlay -&gt;
</a><a href="#h58-6-16" id="h58-6-16" class="i">+            val overlayReference = handleLocalReferences(overlay.uri)
</a><a href="#h58-6-17" id="h58-6-17" class="i">+
</a>             downloadManagerClient.downloadMediaWithOverlay(
<a href="#h58-6-19" id="h58-6-19" class="d">-                originalMediaInfoReference,
</a><a href="#h58-6-20" id="h58-6-20" class="d">-                overlayReference!!,
</a><a href="#h58-6-21" id="h58-6-21" class="d">-                DownloadMediaType.fromUri(Uri.parse(originalMediaInfoReference)),
</a><a href="#h58-6-22" id="h58-6-22" class="d">-                DownloadMediaType.fromUri(Uri.parse(overlayReference)),
</a><a href="#h58-6-23" id="h58-6-23" class="d">-                videoEncryption = originalMediaInfo.encryption?.toKeyPair(),
</a><a href="#h58-6-24" id="h58-6-24" class="d">-                overlayEncryption = overlay.encryption?.toKeyPair()
</a><a href="#h58-6-25" id="h58-6-25" class="i">+                original = InputMedia(
</a><a href="#h58-6-26" id="h58-6-26" class="i">+                    originalMediaInfoReference,
</a><a href="#h58-6-27" id="h58-6-27" class="i">+                    DownloadMediaType.fromUri(Uri.parse(originalMediaInfoReference)),
</a><a href="#h58-6-28" id="h58-6-28" class="i">+                    originalMediaInfo.encryption?.toKeyPair()
</a><a href="#h58-6-29" id="h58-6-29" class="i">+                ),
</a><a href="#h58-6-30" id="h58-6-30" class="i">+                overlay = InputMedia(
</a><a href="#h58-6-31" id="h58-6-31" class="i">+                    overlayReference,
</a><a href="#h58-6-32" id="h58-6-32" class="i">+                    DownloadMediaType.fromUri(Uri.parse(overlayReference)),
</a><a href="#h58-6-33" id="h58-6-33" class="i">+                    overlay.encryption?.toKeyPair()
</a><a href="#h58-6-34" id="h58-6-34" class="i">+                )
</a>             )
             return
         }
 
<a href="#h58-6-39" id="h58-6-39" class="d">-        downloadManagerClient.downloadMedia(
</a><a href="#h58-6-40" id="h58-6-40" class="i">+        downloadManagerClient.downloadSingleMedia(
</a>             originalMediaInfoReference,
             DownloadMediaType.fromUri(Uri.parse(originalMediaInfoReference)),
             originalMediaInfo.encryption?.toKeyPair()
<a href="#h58-7" id="h58-7" class="h">@@ -199,7 +230,7 @@ class MediaDownloader : Feature(&quot;MediaDownloader&quot;, loadParams = FeatureLoadParam
</a>      */
     private fun handleOperaMedia(
         paramMap: ParamMap,
<a href="#h58-7-3" id="h58-7-3" class="d">-        mediaInfoMap: Map&lt;MediaType, MediaInfo&gt;,
</a><a href="#h58-7-4" id="h58-7-4" class="i">+        mediaInfoMap: Map&lt;SplitMediaAssetType, MediaInfo&gt;,
</a>         forceDownload: Boolean
     ) {
         //messages
<a href="#h58-8" id="h58-8" class="h">@@ -229,14 +260,32 @@ class MediaDownloader : Feature(&quot;MediaDownloader&quot;, loadParams = FeatureLoadParam
</a>         }
 
         //private stories
<a href="#h58-8-3" id="h58-8-3" class="d">-        paramMap[&quot;PLAYLIST_V2_GROUP&quot;]?.toString()?.takeIf {
</a><a href="#h58-8-4" id="h58-8-4" class="d">-            it.contains(&quot;storyUserId=&quot;) &amp;&amp; (forceDownload || canAutoDownload(&quot;friend_stories&quot;))
</a><a href="#h58-8-5" id="h58-8-5" class="i">+        paramMap[&quot;PLAYLIST_V2_GROUP&quot;]?.takeIf {
</a><a href="#h58-8-6" id="h58-8-6" class="i">+            forceDownload || canAutoDownload(&quot;friend_stories&quot;)
</a>         }?.let { playlistGroup -&gt;
<a href="#h58-8-8" id="h58-8-8" class="d">-            val storyUserId = (playlistGroup.indexOf(&quot;storyUserId=&quot;) + 12).let {
</a><a href="#h58-8-9" id="h58-8-9" class="d">-                playlistGroup.substring(it, playlistGroup.indexOf(&quot;,&quot;, it))
</a><a href="#h58-8-10" id="h58-8-10" class="i">+            val playlistGroupString = playlistGroup.toString()
</a><a href="#h58-8-11" id="h58-8-11" class="i">+
</a><a href="#h58-8-12" id="h58-8-12" class="i">+            val storyUserId = if (playlistGroupString.contains(&quot;storyUserId=&quot;)) {
</a><a href="#h58-8-13" id="h58-8-13" class="i">+                (playlistGroupString.indexOf(&quot;storyUserId=&quot;) + 12).let {
</a><a href="#h58-8-14" id="h58-8-14" class="i">+                    playlistGroupString.substring(it, playlistGroupString.indexOf(&quot;,&quot;, it))
</a><a href="#h58-8-15" id="h58-8-15" class="i">+                }
</a><a href="#h58-8-16" id="h58-8-16" class="i">+            } else {
</a><a href="#h58-8-17" id="h58-8-17" class="i">+                //story replies
</a><a href="#h58-8-18" id="h58-8-18" class="i">+                val arroyoMessageId = playlistGroup::class.java.methods.firstOrNull { it.name == &quot;getId&quot; }
</a><a href="#h58-8-19" id="h58-8-19" class="i">+                    ?.invoke(playlistGroup)?.toString()
</a><a href="#h58-8-20" id="h58-8-20" class="i">+                    ?.split(&quot;:&quot;)?.getOrNull(2) ?: return@let
</a><a href="#h58-8-21" id="h58-8-21" class="i">+
</a><a href="#h58-8-22" id="h58-8-22" class="i">+                val conversationMessage = context.database.getConversationMessageFromId(arroyoMessageId.toLong()) ?: return@let
</a><a href="#h58-8-23" id="h58-8-23" class="i">+                val conversationParticipants = context.database.getConversationParticipants(conversationMessage.client_conversation_id.toString()) ?: return@let
</a><a href="#h58-8-24" id="h58-8-24" class="i">+
</a><a href="#h58-8-25" id="h58-8-25" class="i">+                conversationParticipants.firstOrNull { it != conversationMessage.sender_id }
</a>             }
 
<a href="#h58-8-28" id="h58-8-28" class="d">-            val author = context.database.getFriendInfo(if (storyUserId == &quot;null&quot;) context.database.getMyUserId()!! else storyUserId) ?: return
</a><a href="#h58-8-29" id="h58-8-29" class="i">+            val author = context.database.getFriendInfo(
</a><a href="#h58-8-30" id="h58-8-30" class="i">+                if (storyUserId == null || storyUserId == &quot;null&quot;)
</a><a href="#h58-8-31" id="h58-8-31" class="i">+                    context.database.getMyUserId()!!
</a><a href="#h58-8-32" id="h58-8-32" class="i">+                else storyUserId
</a><a href="#h58-8-33" id="h58-8-33" class="i">+            ) ?: throw Exception(&quot;Friend not found in database&quot;)
</a>             val authorName = author.usernameForSorting!!
 
             downloadOperaMedia(provideClientDownloadManager(
<a href="#h58-9" id="h58-9" class="h">@@ -333,7 +382,7 @@ class MediaDownloader : Feature(&quot;MediaDownloader&quot;, loadParams = FeatureLoadParam
</a>     }
 
     override fun asyncOnActivityCreate() {
<a href="#h58-9-3" id="h58-9-3" class="d">-        val operaViewerControllerClass: Class&lt;*&gt; = context.mappings.getMappedClass(&quot;OperaPageViewController&quot;, &quot;Class&quot;)
</a><a href="#h58-9-4" id="h58-9-4" class="i">+        val operaViewerControllerClass: Class&lt;*&gt; = context.mappings.getMappedClass(&quot;OperaPageViewController&quot;, &quot;class&quot;)
</a> 
         val onOperaViewStateCallback: (HookAdapter) -&gt; Unit = onOperaViewStateCallback@{ param -&gt;
 
<a href="#h58-10" id="h58-10" class="h">@@ -347,13 +396,13 @@ class MediaDownloader : Feature(&quot;MediaDownloader&quot;, loadParams = FeatureLoadParam
</a>             if (!mediaParamMap.containsKey(&quot;image_media_info&quot;) &amp;&amp; !mediaParamMap.containsKey(&quot;video_media_info_list&quot;))
                 return@onOperaViewStateCallback
 
<a href="#h58-10-3" id="h58-10-3" class="d">-            val mediaInfoMap = mutableMapOf&lt;MediaType, MediaInfo&gt;()
</a><a href="#h58-10-4" id="h58-10-4" class="i">+            val mediaInfoMap = mutableMapOf&lt;SplitMediaAssetType, MediaInfo&gt;()
</a>             val isVideo = mediaParamMap.containsKey(&quot;video_media_info_list&quot;)
<a href="#h58-10-6" id="h58-10-6" class="d">-            mediaInfoMap[MediaType.ORIGINAL] = MediaInfo(
</a><a href="#h58-10-7" id="h58-10-7" class="i">+            mediaInfoMap[SplitMediaAssetType.ORIGINAL] = MediaInfo(
</a>                 (if (isVideo) mediaParamMap[&quot;video_media_info_list&quot;] else mediaParamMap[&quot;image_media_info&quot;])!!
             )
             if (canMergeOverlay() &amp;&amp; mediaParamMap.containsKey(&quot;overlay_image_media_info&quot;)) {
<a href="#h58-10-11" id="h58-10-11" class="d">-                mediaInfoMap[MediaType.OVERLAY] =
</a><a href="#h58-10-12" id="h58-10-12" class="i">+                mediaInfoMap[SplitMediaAssetType.OVERLAY] =
</a>                     MediaInfo(mediaParamMap[&quot;overlay_image_media_info&quot;]!!)
             }
             lastSeenMapParams = mediaParamMap
<a href="#h58-11" id="h58-11" class="h">@@ -371,7 +420,7 @@ class MediaDownloader : Feature(&quot;MediaDownloader&quot;, loadParams = FeatureLoadParam
</a>             }
         }
 
<a href="#h58-11-3" id="h58-11-3" class="d">-        arrayOf(&quot;onDisplayStateChange&quot;, &quot;onDisplayStateChange2&quot;).forEach { methodName -&gt;
</a><a href="#h58-11-4" id="h58-11-4" class="i">+        arrayOf(&quot;onDisplayStateChange&quot;, &quot;onDisplayStateChangeGesture&quot;).forEach { methodName -&gt;
</a>             Hooker.hook(
                 operaViewerControllerClass,
                 context.mappings.getMappedValue(&quot;OperaPageViewController&quot;, methodName),
<a href="#h58-12" id="h58-12" class="h">@@ -380,20 +429,12 @@ class MediaDownloader : Feature(&quot;MediaDownloader&quot;, loadParams = FeatureLoadParam
</a>         }
     }
 
<a href="#h58-12-3" id="h58-12-3" class="d">-    /**
</a><a href="#h58-12-4" id="h58-12-4" class="d">-     * Called when a message is focused in chat
</a><a href="#h58-12-5" id="h58-12-5" class="d">-     */
</a><a href="#h58-12-6" id="h58-12-6" class="d">-    //TODO: use snapchat classes instead of database (when content is deleted)
</a><a href="#h58-12-7" id="h58-12-7" class="d">-    fun onMessageActionMenu(isPreviewMode: Boolean) {
</a><a href="#h58-12-8" id="h58-12-8" class="d">-        //check if the message was focused in a conversation
</a><a href="#h58-12-9" id="h58-12-9" class="d">-        val messaging = context.feature(Messaging::class)
</a><a href="#h58-12-10" id="h58-12-10" class="i">+    fun downloadMessageId(messageId: Long, isPreview: Boolean = false) {
</a>         val messageLogger = context.feature(MessageLogger::class)
<a href="#h58-12-12" id="h58-12-12" class="d">-
</a><a href="#h58-12-13" id="h58-12-13" class="d">-        if (messaging.openedConversationUUID == null) return
</a><a href="#h58-12-14" id="h58-12-14" class="d">-        val message = context.database.getConversationMessageFromId(messaging.lastFocusedMessageId) ?: return
</a><a href="#h58-12-15" id="h58-12-15" class="i">+        val message = context.database.getConversationMessageFromId(messageId) ?: throw Exception(&quot;Message not found in database&quot;)
</a> 
         //get the message author
<a href="#h58-12-18" id="h58-12-18" class="d">-        val friendInfo: FriendInfo = context.database.getFriendInfo(message.sender_id!!)!!
</a><a href="#h58-12-19" id="h58-12-19" class="i">+        val friendInfo: FriendInfo = context.database.getFriendInfo(message.sender_id!!) ?: throw Exception(&quot;Friend not found in database&quot;)
</a>         val authorName = friendInfo.usernameForSorting!!
 
         var messageContent = message.message_content!!
<a href="#h58-13" id="h58-13" class="h">@@ -425,10 +466,12 @@ class MediaDownloader : Feature(&quot;MediaDownloader&quot;, loadParams = FeatureLoadParam
</a>                 }
         }
 
<a href="#h58-13-3" id="h58-13-3" class="i">+        val translations = context.translation.getCategory(&quot;download_processor&quot;)
</a><a href="#h58-13-4" id="h58-13-4" class="i">+
</a>         if (contentType != ContentType.NOTE &amp;&amp;
             contentType != ContentType.SNAP &amp;&amp;
             contentType != ContentType.EXTERNAL_MEDIA) {
<a href="#h58-13-8" id="h58-13-8" class="d">-            context.shortToast(&quot;Unsupported content type $contentType&quot;)
</a><a href="#h58-13-9" id="h58-13-9" class="i">+            context.shortToast(translations[&quot;unsupported_content_type_toast&quot;])
</a>             return
         }
 
<a href="#h58-14" id="h58-14" class="h">@@ -440,7 +483,7 @@ class MediaDownloader : Feature(&quot;MediaDownloader&quot;, loadParams = FeatureLoadParam
</a>         }
 
         runCatching {
<a href="#h58-14-3" id="h58-14-3" class="d">-            if (!isPreviewMode) {
</a><a href="#h58-14-4" id="h58-14-4" class="i">+            if (!isPreview) {
</a>                 val encryptionKeys = EncryptionHelper.getEncryptionKeys(contentType, messageReader, isArroyo = isArroyoMessage)
                 provideClientDownloadManager(
                     pathSuffix = authorName,
<a href="#h58-15" id="h58-15" class="h">@@ -448,7 +491,7 @@ class MediaDownloader : Feature(&quot;MediaDownloader&quot;, loadParams = FeatureLoadParam
</a>                     mediaDisplaySource = authorName,
                     mediaDisplayType = MediaFilter.CHAT_MEDIA.mediaDisplayType,
                     friendInfo = friendInfo
<a href="#h58-15-3" id="h58-15-3" class="d">-                ).downloadMedia(
</a><a href="#h58-15-4" id="h58-15-4" class="i">+                ).downloadSingleMedia(
</a>                     Base64.UrlSafe.encode(urlProto),
                     DownloadMediaType.PROTO_MEDIA,
                     encryption = encryptionKeys?.toKeyPair()
<a href="#h58-16" id="h58-16" class="h">@@ -456,18 +499,23 @@ class MediaDownloader : Feature(&quot;MediaDownloader&quot;, loadParams = FeatureLoadParam
</a>                 return
             }
 
<a href="#h58-16-3" id="h58-16-3" class="i">+            if (EncryptionHelper.getEncryptionKeys(contentType, messageReader, isArroyo = isArroyoMessage) == null) {
</a><a href="#h58-16-4" id="h58-16-4" class="i">+                context.shortToast(translations[&quot;failed_no_longer_available_toast&quot;])
</a><a href="#h58-16-5" id="h58-16-5" class="i">+                return
</a><a href="#h58-16-6" id="h58-16-6" class="i">+            }
</a><a href="#h58-16-7" id="h58-16-7" class="i">+
</a>             val downloadedMediaList = MediaDownloaderHelper.downloadMediaFromReference(urlProto) {
                 EncryptionHelper.decryptInputStream(it, contentType, messageReader, isArroyo = isArroyoMessage)
             }
 
             runCatching {
<a href="#h58-16-13" id="h58-16-13" class="d">-                val originalMedia = downloadedMediaList[MediaType.ORIGINAL] ?: return
</a><a href="#h58-16-14" id="h58-16-14" class="d">-                val overlay = downloadedMediaList[MediaType.OVERLAY]
</a><a href="#h58-16-15" id="h58-16-15" class="i">+                val originalMedia = downloadedMediaList[SplitMediaAssetType.ORIGINAL] ?: return
</a><a href="#h58-16-16" id="h58-16-16" class="i">+                val overlay = downloadedMediaList[SplitMediaAssetType.OVERLAY]
</a> 
                 var bitmap: Bitmap? = PreviewUtils.createPreview(originalMedia, isVideo = FileType.fromByteArray(originalMedia).isVideo)
 
                 if (bitmap == null) {
<a href="#h58-16-21" id="h58-16-21" class="d">-                    context.shortToast(&quot;Failed to create preview&quot;)
</a><a href="#h58-16-22" id="h58-16-22" class="i">+                    context.shortToast(translations[&quot;failed_to_create_preview_toast&quot;])
</a>                     return
                 }
 
<a href="#h58-17" id="h58-17" class="h">@@ -475,21 +523,29 @@ class MediaDownloader : Feature(&quot;MediaDownloader&quot;, loadParams = FeatureLoadParam
</a>                     bitmap = PreviewUtils.mergeBitmapOverlay(bitmap!!, BitmapFactory.decodeByteArray(it, 0, it.size))
                 }
 
<a href="#h58-17-3" id="h58-17-3" class="d">-                with(AlertDialog.Builder(context.mainActivity)) {
</a><a href="#h58-17-4" id="h58-17-4" class="d">-                    setTitle(&quot;Preview&quot;)
</a><a href="#h58-17-5" id="h58-17-5" class="i">+                with(ViewAppearanceHelper.newAlertDialogBuilder(context.mainActivity)) {
</a>                     setView(ImageView(context).apply {
                         setImageBitmap(bitmap)
                     })
                     setPositiveButton(&quot;Close&quot;) { dialog: DialogInterface, _: Int -&gt; dialog.dismiss() }
<a href="#h58-17-10" id="h58-17-10" class="d">-                    this@MediaDownloader.context.runOnUiThread { show() }
</a><a href="#h58-17-11" id="h58-17-11" class="i">+                    this@MediaDownloader.context.runOnUiThread { show()}
</a>                 }
             }.onFailure {
<a href="#h58-17-14" id="h58-17-14" class="d">-                context.shortToast(&quot;Failed to create preview: $it&quot;)
</a><a href="#h58-17-15" id="h58-17-15" class="i">+                context.shortToast(translations[&quot;failed_to_create_preview_toast&quot;])
</a>                 xposedLog(it)
             }
         }.onFailure {
<a href="#h58-17-19" id="h58-17-19" class="d">-            context.longToast(&quot;Failed to download &quot; + it.message)
</a><a href="#h58-17-20" id="h58-17-20" class="i">+            context.longToast(translations[&quot;failed_generic_toast&quot;])
</a>             xposedLog(it)
         }
     }
<a href="#h58-17-24" id="h58-17-24" class="i">+
</a><a href="#h58-17-25" id="h58-17-25" class="i">+    /**
</a><a href="#h58-17-26" id="h58-17-26" class="i">+     * Called when a message is focused in chat
</a><a href="#h58-17-27" id="h58-17-27" class="i">+     */
</a><a href="#h58-17-28" id="h58-17-28" class="i">+    fun onMessageActionMenu(isPreviewMode: Boolean) {
</a><a href="#h58-17-29" id="h58-17-29" class="i">+        val messaging = context.feature(Messaging::class)
</a><a href="#h58-17-30" id="h58-17-30" class="i">+        if (messaging.openedConversationUUID == null) return
</a><a href="#h58-17-31" id="h58-17-31" class="i">+        downloadMessageId(messaging.lastFocusedMessageId, isPreviewMode)
</a><a href="#h58-17-32" id="h58-17-32" class="i">+    }
</a> } 
\ No newline at end of file
<b>diff --git a/<a id="h59" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/experiments/AppPasscode.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/experiments/AppPasscode.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/experiments/AppPasscode.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/experiments/AppPasscode.kt</a></b>
<a href="#h59-0" id="h59-0" class="h">@@ -12,6 +12,7 @@ import android.widget.EditText
</a> import me.rhunk.snapenhance.config.ConfigProperty
 import me.rhunk.snapenhance.features.Feature
 import me.rhunk.snapenhance.features.FeatureLoadParams
<a href="#h59-0-3" id="h59-0-3" class="i">+import me.rhunk.snapenhance.ui.ViewAppearanceHelper
</a> 
 //TODO: fingerprint unlock
 class AppPasscode : Feature(&quot;App Passcode&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_SYNC) {
<a href="#h59-1" id="h59-1" class="h">@@ -32,7 +33,7 @@ class AppPasscode : Feature(&quot;App Passcode&quot;, loadParams = FeatureLoadParams.ACTIV
</a>         val mainActivity = context.mainActivity!!
         setActivityVisibility(false)
 
<a href="#h59-1-3" id="h59-1-3" class="d">-        val prompt = AlertDialog.Builder(mainActivity)
</a><a href="#h59-1-4" id="h59-1-4" class="i">+        val prompt = ViewAppearanceHelper.newAlertDialogBuilder(mainActivity)
</a>         val createPrompt  = {
             val alertDialog = prompt.create()
             val textView = EditText(mainActivity)
<b>diff --git a/<a id="h60" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/experiments/DeviceSpooferHook.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/experiments/DeviceSpooferHook.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/experiments/DeviceSpooferHook.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/experiments/DeviceSpooferHook.kt</a></b>
<a href="#h60-0" id="h60-0" class="h">@@ -0,0 +1,47 @@
</a><a href="#h60-0-0" id="h60-0-0" class="i">+package me.rhunk.snapenhance.features.impl.experiments
</a><a href="#h60-0-1" id="h60-0-1" class="i">+
</a><a href="#h60-0-2" id="h60-0-2" class="i">+import me.rhunk.snapenhance.Logger
</a><a href="#h60-0-3" id="h60-0-3" class="i">+import me.rhunk.snapenhance.config.ConfigProperty
</a><a href="#h60-0-4" id="h60-0-4" class="i">+import me.rhunk.snapenhance.features.Feature
</a><a href="#h60-0-5" id="h60-0-5" class="i">+import me.rhunk.snapenhance.features.FeatureLoadParams
</a><a href="#h60-0-6" id="h60-0-6" class="i">+import me.rhunk.snapenhance.hook.HookStage
</a><a href="#h60-0-7" id="h60-0-7" class="i">+import me.rhunk.snapenhance.hook.Hooker
</a><a href="#h60-0-8" id="h60-0-8" class="i">+
</a><a href="#h60-0-9" id="h60-0-9" class="i">+class DeviceSpooferHook: Feature(&quot;device_spoofer&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_ASYNC)  {
</a><a href="#h60-0-10" id="h60-0-10" class="i">+	override fun asyncOnActivityCreate() {
</a><a href="#h60-0-11" id="h60-0-11" class="i">+		//FINGERPRINT
</a><a href="#h60-0-12" id="h60-0-12" class="i">+		if(getFingerprint().isNotEmpty()) {
</a><a href="#h60-0-13" id="h60-0-13" class="i">+			val fingerprintClass = android.os.Build::class.java
</a><a href="#h60-0-14" id="h60-0-14" class="i">+			Hooker.hook(fingerprintClass, &quot;FINGERPRINT&quot;, HookStage.BEFORE) { hookAdapter -&gt;
</a><a href="#h60-0-15" id="h60-0-15" class="i">+				hookAdapter.setResult(getFingerprint())
</a><a href="#h60-0-16" id="h60-0-16" class="i">+			}
</a><a href="#h60-0-17" id="h60-0-17" class="i">+			Hooker.hook(fingerprintClass, &quot;deriveFingerprint&quot;, HookStage.BEFORE) { hookAdapter -&gt;
</a><a href="#h60-0-18" id="h60-0-18" class="i">+				hookAdapter.setResult(getFingerprint())
</a><a href="#h60-0-19" id="h60-0-19" class="i">+			}
</a><a href="#h60-0-20" id="h60-0-20" class="i">+		}
</a><a href="#h60-0-21" id="h60-0-21" class="i">+		else {
</a><a href="#h60-0-22" id="h60-0-22" class="i">+			Logger.xposedLog(&quot;Fingerprint is null, not spoofing&quot;)
</a><a href="#h60-0-23" id="h60-0-23" class="i">+		}
</a><a href="#h60-0-24" id="h60-0-24" class="i">+		
</a><a href="#h60-0-25" id="h60-0-25" class="i">+		//ANDROID ID
</a><a href="#h60-0-26" id="h60-0-26" class="i">+		if(getAndroidId().isNotEmpty()) {
</a><a href="#h60-0-27" id="h60-0-27" class="i">+			val settingsSecureClass = android.provider.Settings.Secure::class.java
</a><a href="#h60-0-28" id="h60-0-28" class="i">+			Hooker.hook(settingsSecureClass, &quot;getString&quot;, HookStage.BEFORE) { hookAdapter -&gt;
</a><a href="#h60-0-29" id="h60-0-29" class="i">+				if(hookAdapter.args()[1] == &quot;android_id&quot;) {
</a><a href="#h60-0-30" id="h60-0-30" class="i">+					hookAdapter.setResult(getAndroidId())
</a><a href="#h60-0-31" id="h60-0-31" class="i">+				}
</a><a href="#h60-0-32" id="h60-0-32" class="i">+			}
</a><a href="#h60-0-33" id="h60-0-33" class="i">+		}
</a><a href="#h60-0-34" id="h60-0-34" class="i">+		else {
</a><a href="#h60-0-35" id="h60-0-35" class="i">+			Logger.xposedLog(&quot;Android ID is null, not spoofing&quot;)
</a><a href="#h60-0-36" id="h60-0-36" class="i">+		}
</a><a href="#h60-0-37" id="h60-0-37" class="i">+	}
</a><a href="#h60-0-38" id="h60-0-38" class="i">+	private fun getFingerprint():String {
</a><a href="#h60-0-39" id="h60-0-39" class="i">+		return context.config.string(ConfigProperty.FINGERPRINT)
</a><a href="#h60-0-40" id="h60-0-40" class="i">+	}
</a><a href="#h60-0-41" id="h60-0-41" class="i">+	
</a><a href="#h60-0-42" id="h60-0-42" class="i">+	private fun getAndroidId():String {
</a><a href="#h60-0-43" id="h60-0-43" class="i">+		return context.config.string(ConfigProperty.ANDROID_ID)
</a><a href="#h60-0-44" id="h60-0-44" class="i">+	}
</a><a href="#h60-0-45" id="h60-0-45" class="i">+	
</a><a href="#h60-0-46" id="h60-0-46" class="i">+}</a><a href="#h60-0-47" id="h60-0-47" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h61" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/experiments/MeoPasscodeBypass.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/experiments/MeoPasscodeBypass.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/experiments/MeoPasscodeBypass.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/experiments/MeoPasscodeBypass.kt</a></b>
<a href="#h61-0" id="h61-0" class="h">@@ -8,9 +8,11 @@ import me.rhunk.snapenhance.hook.Hooker
</a> 
 class MeoPasscodeBypass : Feature(&quot;Meo Passcode Bypass&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_ASYNC) {
     override fun asyncOnActivityCreate() {
<a href="#h61-0-3" id="h61-0-3" class="i">+        val bcrypt = context.mappings.getMappedMap(&quot;BCrypt&quot;)
</a><a href="#h61-0-4" id="h61-0-4" class="i">+
</a>         Hooker.hook(
<a href="#h61-0-6" id="h61-0-6" class="d">-            context.mappings.getMappedClass(&quot;BCryptClass&quot;),
</a><a href="#h61-0-7" id="h61-0-7" class="d">-            context.mappings.getMappedValue(&quot;BCryptClassHashMethod&quot;),
</a><a href="#h61-0-8" id="h61-0-8" class="i">+            context.androidContext.classLoader.loadClass(bcrypt[&quot;class&quot;].toString()),
</a><a href="#h61-0-9" id="h61-0-9" class="i">+            bcrypt[&quot;hashMethod&quot;].toString(),
</a>             HookStage.BEFORE,
             { context.config.bool(ConfigProperty.MEO_PASSCODE_BYPASS) },
         ) { param -&gt;
<b>diff --git a/<a id="h62" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/privacy/PreventMessageSending.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/privacy/PreventMessageSending.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/privacy/PreventMessageSending.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/privacy/PreventMessageSending.kt</a></b>
<a href="#h62-0" id="h62-0" class="h">@@ -1,36 +1,39 @@
</a> package me.rhunk.snapenhance.features.impl.privacy
 
<a href="#h62-0-2" id="h62-0-2" class="i">+import me.rhunk.snapenhance.Logger
</a> import me.rhunk.snapenhance.config.ConfigProperty
<a href="#h62-0-4" id="h62-0-4" class="d">-import me.rhunk.snapenhance.data.ContentType
</a><a href="#h62-0-5" id="h62-0-5" class="i">+import me.rhunk.snapenhance.data.NotificationType
</a> import me.rhunk.snapenhance.data.wrapper.impl.MessageContent
 import me.rhunk.snapenhance.features.Feature
 import me.rhunk.snapenhance.features.FeatureLoadParams
 import me.rhunk.snapenhance.hook.HookStage
<a href="#h62-0-10" id="h62-0-10" class="d">-import me.rhunk.snapenhance.hook.Hooker
</a><a href="#h62-0-11" id="h62-0-11" class="i">+import me.rhunk.snapenhance.hook.hook
</a> 
<a href="#h62-0-13" id="h62-0-13" class="d">-class PreventMessageSending : Feature(&quot;Send message override&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_ASYNC) {
</a><a href="#h62-0-14" id="h62-0-14" class="i">+class PreventMessageSending : Feature(&quot;Prevent message sending&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_ASYNC) {
</a>     override fun asyncOnActivityCreate() {
<a href="#h62-0-16" id="h62-0-16" class="d">-        Hooker.hook(
</a><a href="#h62-0-17" id="h62-0-17" class="d">-            context.classCache.conversationManager,
</a><a href="#h62-0-18" id="h62-0-18" class="d">-            &quot;sendMessageWithContent&quot;,
</a><a href="#h62-0-19" id="h62-0-19" class="d">-            HookStage.BEFORE
</a><a href="#h62-0-20" id="h62-0-20" class="d">-        ) { param -&gt;
</a><a href="#h62-0-21" id="h62-0-21" class="d">-            val message = MessageContent(param.arg(1))
</a><a href="#h62-0-22" id="h62-0-22" class="d">-            val contentType = message.contentType
</a><a href="#h62-0-23" id="h62-0-23" class="i">+        context.classCache.conversationManager.hook(&quot;updateMessage&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h62-0-24" id="h62-0-24" class="i">+            val messageUpdate = param.arg&lt;Any&gt;(2).toString();
</a><a href="#h62-0-25" id="h62-0-25" class="i">+            val options by lazy {
</a><a href="#h62-0-26" id="h62-0-26" class="i">+                context.config.options(ConfigProperty.PREVENT_SENDING_MESSAGES)
</a><a href="#h62-0-27" id="h62-0-27" class="i">+            }
</a><a href="#h62-0-28" id="h62-0-28" class="i">+            if (messageUpdate == &quot;SCREENSHOT&quot; &amp;&amp; options[&quot;chat_screenshot&quot;] == true) {
</a><a href="#h62-0-29" id="h62-0-29" class="i">+                param.setResult(null)
</a><a href="#h62-0-30" id="h62-0-30" class="i">+            }
</a> 
<a href="#h62-0-32" id="h62-0-32" class="d">-            if (context.config.bool(ConfigProperty.PREVENT_STATUS_NOTIFICATIONS)) {
</a><a href="#h62-0-33" id="h62-0-33" class="d">-                if (contentType == ContentType.STATUS_SAVE_TO_CAMERA_ROLL ||
</a><a href="#h62-0-34" id="h62-0-34" class="d">-                        contentType == ContentType.STATUS_CALL_MISSED_AUDIO ||
</a><a href="#h62-0-35" id="h62-0-35" class="d">-                        contentType == ContentType.STATUS_CALL_MISSED_VIDEO) {
</a><a href="#h62-0-36" id="h62-0-36" class="d">-                    param.setResult(null)
</a><a href="#h62-0-37" id="h62-0-37" class="d">-                }
</a><a href="#h62-0-38" id="h62-0-38" class="i">+            if (messageUpdate == &quot;SCREEN_RECORD&quot; &amp;&amp; options[&quot;chat_screen_record&quot;] == true) {
</a><a href="#h62-0-39" id="h62-0-39" class="i">+                param.setResult(null)
</a>             }
<a href="#h62-0-41" id="h62-0-41" class="i">+        }
</a><a href="#h62-0-42" id="h62-0-42" class="i">+
</a><a href="#h62-0-43" id="h62-0-43" class="i">+        context.classCache.conversationManager.hook(&quot;sendMessageWithContent&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h62-0-44" id="h62-0-44" class="i">+            val message = MessageContent(param.arg(1))
</a><a href="#h62-0-45" id="h62-0-45" class="i">+            val contentType = message.contentType
</a><a href="#h62-0-46" id="h62-0-46" class="i">+            val associatedType = NotificationType.fromContentType(contentType) ?: return@hook
</a><a href="#h62-0-47" id="h62-0-47" class="i">+            val options = context.config.options(ConfigProperty.PREVENT_SENDING_MESSAGES)
</a> 
<a href="#h62-0-49" id="h62-0-49" class="d">-            if (context.config.bool(ConfigProperty.PREVENT_SCREENSHOT_NOTIFICATIONS)) {
</a><a href="#h62-0-50" id="h62-0-50" class="d">-                if (contentType == ContentType.STATUS_CONVERSATION_CAPTURE_SCREENSHOT ||
</a><a href="#h62-0-51" id="h62-0-51" class="d">-                    contentType == ContentType.STATUS_CONVERSATION_CAPTURE_RECORD) {
</a><a href="#h62-0-52" id="h62-0-52" class="d">-                    param.setResult(null)
</a><a href="#h62-0-53" id="h62-0-53" class="d">-                }
</a><a href="#h62-0-54" id="h62-0-54" class="i">+            if (options[associatedType.key] == true) {
</a><a href="#h62-0-55" id="h62-0-55" class="i">+                Logger.debug(&quot;Preventing message sending for $associatedType&quot;)
</a><a href="#h62-0-56" id="h62-0-56" class="i">+                param.setResult(null)
</a>             }
         }
     }
<b>diff --git a/<a id="h63" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/spying/MessageLogger.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/spying/MessageLogger.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/spying/MessageLogger.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/spying/MessageLogger.kt</a></b>
<a href="#h63-0" id="h63-0" class="h">@@ -1,5 +1,6 @@
</a> package me.rhunk.snapenhance.features.impl.spying
 
<a href="#h63-0-2" id="h63-0-2" class="i">+import android.os.DeadObjectException
</a> import com.google.gson.JsonObject
 import com.google.gson.JsonParser
 import me.rhunk.snapenhance.Logger
<a href="#h63-1" id="h63-1" class="h">@@ -11,6 +12,7 @@ import me.rhunk.snapenhance.features.Feature
</a> import me.rhunk.snapenhance.features.FeatureLoadParams
 import me.rhunk.snapenhance.hook.HookStage
 import me.rhunk.snapenhance.hook.Hooker
<a href="#h63-1-3" id="h63-1-3" class="i">+import java.util.concurrent.Executors
</a> import kotlin.time.ExperimentalTime
 import kotlin.time.measureTime
 
<a href="#h63-2" id="h63-2" class="h">@@ -23,6 +25,8 @@ class MessageLogger : Feature(&quot;MessageLogger&quot;,
</a>         const val PREFETCH_FEED_COUNT = 20
     }
 
<a href="#h63-2-3" id="h63-2-3" class="i">+    private val threadPool = Executors.newFixedThreadPool(10)
</a><a href="#h63-2-4" id="h63-2-4" class="i">+
</a>     //two level of cache to avoid querying the database
     private val fetchedMessages = mutableListOf&lt;Long&gt;()
     private val deletedMessageCache = mutableMapOf&lt;Long, JsonObject&gt;()
<a href="#h63-3" id="h63-3" class="h">@@ -59,7 +63,7 @@ class MessageLogger : Feature(&quot;MessageLogger&quot;,
</a> 
         measureTime {
             context.database.getFriendFeed(PREFETCH_FEED_COUNT).forEach { friendFeedInfo -&gt;
<a href="#h63-3-3" id="h63-3-3" class="d">-                fetchedMessages.addAll(context.bridgeClient.getLoggedMessageIds(friendFeedInfo.key!!, PREFETCH_MESSAGE_COUNT))
</a><a href="#h63-3-4" id="h63-3-4" class="i">+                fetchedMessages.addAll(context.bridgeClient.getLoggedMessageIds(friendFeedInfo.key!!, PREFETCH_MESSAGE_COUNT).toList())
</a>             }
         }.also { Logger.debug(&quot;Loaded ${fetchedMessages.size} cached messages in $it&quot;) }
     }
<a href="#h63-4" id="h63-4" class="h">@@ -79,11 +83,13 @@ class MessageLogger : Feature(&quot;MessageLogger&quot;,
</a>             if (fetchedMessages.contains(messageId)) return
             fetchedMessages.add(messageId)
 
<a href="#h63-4-3" id="h63-4-3" class="d">-            context.executeAsync {
</a><a href="#h63-4-4" id="h63-4-4" class="d">-                context.bridgeClient.getMessageLoggerMessage(conversationId, messageId)?.let {
</a><a href="#h63-4-5" id="h63-4-5" class="d">-                    return@executeAsync
</a><a href="#h63-4-6" id="h63-4-6" class="d">-                }
</a><a href="#h63-4-7" id="h63-4-7" class="d">-                context.bridgeClient.addMessageLoggerMessage(conversationId, messageId, context.gson.toJson(messageInstance).toByteArray(Charsets.UTF_8))
</a><a href="#h63-4-8" id="h63-4-8" class="i">+            threadPool.execute {
</a><a href="#h63-4-9" id="h63-4-9" class="i">+                try {
</a><a href="#h63-4-10" id="h63-4-10" class="i">+                    context.bridgeClient.getMessageLoggerMessage(conversationId, messageId)?.let {
</a><a href="#h63-4-11" id="h63-4-11" class="i">+                        return@execute
</a><a href="#h63-4-12" id="h63-4-12" class="i">+                    }
</a><a href="#h63-4-13" id="h63-4-13" class="i">+                    context.bridgeClient.addMessageLoggerMessage(conversationId, messageId, context.gson.toJson(messageInstance).toByteArray(Charsets.UTF_8))
</a><a href="#h63-4-14" id="h63-4-14" class="i">+                } catch (ignored: DeadObjectException) {}
</a>             }
 
             return
<b>diff --git a/<a id="h64" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/spying/StealthMode.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/spying/StealthMode.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/spying/StealthMode.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/spying/StealthMode.kt</a></b>
<a href="#h64-0" id="h64-0" class="h">@@ -1,6 +1,6 @@
</a> package me.rhunk.snapenhance.features.impl.spying
 
<a href="#h64-0-2" id="h64-0-2" class="d">-import me.rhunk.snapenhance.bridge.common.impl.file.BridgeFileType
</a><a href="#h64-0-3" id="h64-0-3" class="i">+import me.rhunk.snapenhance.bridge.types.BridgeFileType
</a> import me.rhunk.snapenhance.features.BridgeFileFeature
 import me.rhunk.snapenhance.features.FeatureLoadParams
 
<b>diff --git a/<a id="h65" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/AntiAutoSave.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/AntiAutoSave.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/AntiAutoSave.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/AntiAutoSave.kt</a></b>
<a href="#h65-0" id="h65-0" class="h">@@ -1,6 +1,6 @@
</a> package me.rhunk.snapenhance.features.impl.tweaks
 
<a href="#h65-0-2" id="h65-0-2" class="d">-import me.rhunk.snapenhance.bridge.common.impl.file.BridgeFileType
</a><a href="#h65-0-3" id="h65-0-3" class="i">+import me.rhunk.snapenhance.bridge.types.BridgeFileType
</a> import me.rhunk.snapenhance.features.BridgeFileFeature
 import me.rhunk.snapenhance.features.FeatureLoadParams
 
<b>diff --git a/<a id="h66" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/GalleryMediaSendOverride.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/GalleryMediaSendOverride.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/GalleryMediaSendOverride.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/GalleryMediaSendOverride.kt</a></b>
<a href="#h66-0" id="h66-0" class="h">@@ -9,6 +9,7 @@ import me.rhunk.snapenhance.features.Feature
</a> import me.rhunk.snapenhance.features.FeatureLoadParams
 import me.rhunk.snapenhance.hook.HookStage
 import me.rhunk.snapenhance.hook.Hooker
<a href="#h66-0-3" id="h66-0-3" class="i">+import me.rhunk.snapenhance.ui.ViewAppearanceHelper
</a> import me.rhunk.snapenhance.util.protobuf.ProtoReader
 
 class GalleryMediaSendOverride : Feature(&quot;Gallery Media Send Override&quot;, loadParams = FeatureLoadParams.INIT_SYNC) {
<a href="#h66-1" id="h66-1" class="h">@@ -24,7 +25,7 @@ class GalleryMediaSendOverride : Feature(&quot;Gallery Media Send Override&quot;, loadPara
</a> 
             if (messageProtoReader.readPath(3)?.getCount(3) != 1) {
                 context.runOnUiThread {
<a href="#h66-1-3" id="h66-1-3" class="d">-                    AlertDialog.Builder(context.mainActivity!!)
</a><a href="#h66-1-4" id="h66-1-4" class="i">+                    ViewAppearanceHelper.newAlertDialogBuilder(context.mainActivity!!)
</a>                         .setMessage(&quot;You can only send one media at a time&quot;)
                         .setPositiveButton(&quot;OK&quot;, null)
                         .show()
<b>diff --git a/<a id="h67" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/GooglePlayServicesDialogs.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/GooglePlayServicesDialogs.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/GooglePlayServicesDialogs.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/GooglePlayServicesDialogs.kt</a></b>
<a href="#h67-0" id="h67-0" class="h">@@ -0,0 +1,24 @@
</a><a href="#h67-0-0" id="h67-0-0" class="i">+package me.rhunk.snapenhance.features.impl.tweaks
</a><a href="#h67-0-1" id="h67-0-1" class="i">+
</a><a href="#h67-0-2" id="h67-0-2" class="i">+import android.app.AlertDialog
</a><a href="#h67-0-3" id="h67-0-3" class="i">+import me.rhunk.snapenhance.Logger
</a><a href="#h67-0-4" id="h67-0-4" class="i">+import me.rhunk.snapenhance.config.ConfigProperty
</a><a href="#h67-0-5" id="h67-0-5" class="i">+import me.rhunk.snapenhance.features.Feature
</a><a href="#h67-0-6" id="h67-0-6" class="i">+import me.rhunk.snapenhance.features.FeatureLoadParams
</a><a href="#h67-0-7" id="h67-0-7" class="i">+import me.rhunk.snapenhance.hook.HookStage
</a><a href="#h67-0-8" id="h67-0-8" class="i">+import me.rhunk.snapenhance.hook.hook
</a><a href="#h67-0-9" id="h67-0-9" class="i">+import java.lang.reflect.Modifier
</a><a href="#h67-0-10" id="h67-0-10" class="i">+
</a><a href="#h67-0-11" id="h67-0-11" class="i">+class GooglePlayServicesDialogs : Feature(&quot;Disable GMS Dialogs&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_ASYNC) {
</a><a href="#h67-0-12" id="h67-0-12" class="i">+    override fun asyncOnActivityCreate() {
</a><a href="#h67-0-13" id="h67-0-13" class="i">+        if (!context.config.bool(ConfigProperty.DISABLE_GOOGLE_PLAY_DIALOGS)) return
</a><a href="#h67-0-14" id="h67-0-14" class="i">+
</a><a href="#h67-0-15" id="h67-0-15" class="i">+        findClass(&quot;com.google.android.gms.common.GoogleApiAvailability&quot;).methods
</a><a href="#h67-0-16" id="h67-0-16" class="i">+            .first { Modifier.isStatic(it.modifiers) &amp;&amp; it.returnType == AlertDialog::class.java }.let { method -&gt;
</a><a href="#h67-0-17" id="h67-0-17" class="i">+            method.hook(HookStage.BEFORE) { param -&gt;
</a><a href="#h67-0-18" id="h67-0-18" class="i">+                Logger.debug(&quot;GoogleApiAvailability.showErrorDialogFragment() called, returning null&quot;)
</a><a href="#h67-0-19" id="h67-0-19" class="i">+                param.setResult(null)
</a><a href="#h67-0-20" id="h67-0-20" class="i">+            }
</a><a href="#h67-0-21" id="h67-0-21" class="i">+        }
</a><a href="#h67-0-22" id="h67-0-22" class="i">+    }
</a><a href="#h67-0-23" id="h67-0-23" class="i">+}</a><a href="#h67-0-24" id="h67-0-24" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h68" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/MediaQualityLevelOverride.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/MediaQualityLevelOverride.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/MediaQualityLevelOverride.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/MediaQualityLevelOverride.kt</a></b>
<a href="#h68-0" id="h68-0" class="h">@@ -4,14 +4,15 @@ import me.rhunk.snapenhance.config.ConfigProperty
</a> import me.rhunk.snapenhance.features.Feature
 import me.rhunk.snapenhance.features.FeatureLoadParams
 import me.rhunk.snapenhance.hook.HookStage
<a href="#h68-0-3" id="h68-0-3" class="d">-import me.rhunk.snapenhance.hook.Hooker
</a><a href="#h68-0-4" id="h68-0-4" class="i">+import me.rhunk.snapenhance.hook.hook
</a> 
 class MediaQualityLevelOverride : Feature(&quot;MediaQualityLevelOverride&quot;, loadParams = FeatureLoadParams.INIT_SYNC) {
     override fun init() {
<a href="#h68-0-8" id="h68-0-8" class="d">-        val enumQualityLevel = context.mappings.getMappedClass(&quot;enums&quot;, &quot;QualityLevel&quot;)
</a><a href="#h68-0-9" id="h68-0-9" class="i">+        val enumQualityLevel = context.mappings.getMappedClass(&quot;EnumQualityLevel&quot;)
</a><a href="#h68-0-10" id="h68-0-10" class="i">+        val mediaQualityLevelProvider = context.mappings.getMappedMap(&quot;MediaQualityLevelProvider&quot;)
</a> 
<a href="#h68-0-12" id="h68-0-12" class="d">-        Hooker.hook(context.mappings.getMappedClass(&quot;MediaQualityLevelProvider&quot;),
</a><a href="#h68-0-13" id="h68-0-13" class="d">-            context.mappings.getMappedValue(&quot;MediaQualityLevelProviderMethod&quot;),
</a><a href="#h68-0-14" id="h68-0-14" class="i">+        context.androidContext.classLoader.loadClass(mediaQualityLevelProvider[&quot;class&quot;].toString()).hook(
</a><a href="#h68-0-15" id="h68-0-15" class="i">+            mediaQualityLevelProvider[&quot;method&quot;].toString(),
</a>             HookStage.BEFORE,
             { context.config.bool(ConfigProperty.FORCE_MEDIA_SOURCE_QUALITY) }
         ) { param -&gt;
<b>diff --git a/<a id="h69" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/Notifications.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/Notifications.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/Notifications.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/Notifications.kt</a></b>
<a href="#h69-0" id="h69-0" class="h">@@ -19,21 +19,24 @@ import me.rhunk.snapenhance.data.ContentType
</a> import me.rhunk.snapenhance.data.MediaReferenceType
 import me.rhunk.snapenhance.data.wrapper.impl.Message
 import me.rhunk.snapenhance.data.wrapper.impl.SnapUUID
<a href="#h69-0-3" id="h69-0-3" class="i">+import me.rhunk.snapenhance.download.data.SplitMediaAssetType
</a> import me.rhunk.snapenhance.features.Feature
 import me.rhunk.snapenhance.features.FeatureLoadParams
 import me.rhunk.snapenhance.features.impl.Messaging
<a href="#h69-0-7" id="h69-0-7" class="i">+import me.rhunk.snapenhance.features.impl.downloader.MediaDownloader
</a> import me.rhunk.snapenhance.hook.HookStage
 import me.rhunk.snapenhance.hook.Hooker
<a href="#h69-0-10" id="h69-0-10" class="i">+import me.rhunk.snapenhance.hook.hook
</a> import me.rhunk.snapenhance.util.CallbackBuilder
<a href="#h69-0-12" id="h69-0-12" class="i">+import me.rhunk.snapenhance.util.protobuf.ProtoReader
</a> import me.rhunk.snapenhance.util.snap.EncryptionHelper
 import me.rhunk.snapenhance.util.snap.MediaDownloaderHelper
<a href="#h69-0-15" id="h69-0-15" class="d">-import me.rhunk.snapenhance.util.snap.MediaType
</a> import me.rhunk.snapenhance.util.snap.PreviewUtils
<a href="#h69-0-17" id="h69-0-17" class="d">-import me.rhunk.snapenhance.util.protobuf.ProtoReader
</a> 
 class Notifications : Feature(&quot;Notifications&quot;, loadParams = FeatureLoadParams.INIT_SYNC) {
     companion object{
<a href="#h69-0-21" id="h69-0-21" class="d">-        const val ACTION_REPLY = &quot;me.rhunk.snapenhance.action.REPLY&quot;
</a><a href="#h69-0-22" id="h69-0-22" class="i">+        const val ACTION_REPLY = &quot;me.rhunk.snapenhance.action.notification.REPLY&quot;
</a><a href="#h69-0-23" id="h69-0-23" class="i">+        const val ACTION_DOWNLOAD = &quot;me.rhunk.snapenhance.action.notification.DOWNLOAD&quot;
</a>     }
 
     private val notificationDataQueue = mutableMapOf&lt;Long, NotificationData&gt;() // messageId =&gt; notification
<a href="#h69-1" id="h69-1" class="h">@@ -54,10 +57,6 @@ class Notifications : Feature(&quot;Notifications&quot;, loadParams = FeatureLoadParams.IN
</a>         )
     }
 
<a href="#h69-1-3" id="h69-1-3" class="d">-    private val cancelAsUserMethod by lazy {
</a><a href="#h69-1-4" id="h69-1-4" class="d">-        XposedHelpers.findMethodExact(NotificationManager::class.java, &quot;cancelAsUser&quot;, String::class.java, Int::class.javaPrimitiveType, UserHandle::class.java)
</a><a href="#h69-1-5" id="h69-1-5" class="d">-    }
</a><a href="#h69-1-6" id="h69-1-6" class="d">-
</a>     private val fetchConversationWithMessagesMethod by lazy {
         context.classCache.conversationManager.methods.first { it.name == &quot;fetchConversationWithMessages&quot;}
     }
<a href="#h69-2" id="h69-2" class="h">@@ -66,51 +65,69 @@ class Notifications : Feature(&quot;Notifications&quot;, loadParams = FeatureLoadParams.IN
</a>         context.androidContext.getSystemService(Context.NOTIFICATION_SERVICE) as NotificationManager
     }
 
<a href="#h69-2-3" id="h69-2-3" class="d">-    private fun setNotificationText(notification: Notification, text: String) {
</a><a href="#h69-2-4" id="h69-2-4" class="i">+    private fun setNotificationText(notification: Notification, conversationId: String) {
</a><a href="#h69-2-5" id="h69-2-5" class="i">+        val messageText = StringBuilder().apply {
</a><a href="#h69-2-6" id="h69-2-6" class="i">+            cachedMessages.computeIfAbsent(conversationId) { mutableListOf() }.forEach {
</a><a href="#h69-2-7" id="h69-2-7" class="i">+                if (isNotEmpty()) append(&quot;\n&quot;)
</a><a href="#h69-2-8" id="h69-2-8" class="i">+                append(it)
</a><a href="#h69-2-9" id="h69-2-9" class="i">+            }
</a><a href="#h69-2-10" id="h69-2-10" class="i">+        }.toString()
</a><a href="#h69-2-11" id="h69-2-11" class="i">+
</a>         with(notification.extras) {
<a href="#h69-2-13" id="h69-2-13" class="d">-            putString(&quot;android.text&quot;, text)
</a><a href="#h69-2-14" id="h69-2-14" class="d">-            putString(&quot;android.bigText&quot;, text)
</a><a href="#h69-2-15" id="h69-2-15" class="i">+            putString(&quot;android.text&quot;, messageText)
</a><a href="#h69-2-16" id="h69-2-16" class="i">+            putString(&quot;android.bigText&quot;, messageText)
</a><a href="#h69-2-17" id="h69-2-17" class="i">+            putParcelableArray(&quot;android.messages&quot;, messageText.split(&quot;\n&quot;).map {
</a><a href="#h69-2-18" id="h69-2-18" class="i">+                Bundle().apply {
</a><a href="#h69-2-19" id="h69-2-19" class="i">+                    putBundle(&quot;extras&quot;, Bundle())
</a><a href="#h69-2-20" id="h69-2-20" class="i">+                    putString(&quot;text&quot;, it)
</a><a href="#h69-2-21" id="h69-2-21" class="i">+                    putLong(&quot;time&quot;, System.currentTimeMillis())
</a><a href="#h69-2-22" id="h69-2-22" class="i">+                }
</a><a href="#h69-2-23" id="h69-2-23" class="i">+            }.toTypedArray())
</a>         }
     }
 
<a href="#h69-2-27" id="h69-2-27" class="d">-    private fun computeNotificationText(conversationId: String): String {
</a><a href="#h69-2-28" id="h69-2-28" class="d">-        val messageBuilder = StringBuilder()
</a><a href="#h69-2-29" id="h69-2-29" class="d">-        cachedMessages.computeIfAbsent(conversationId) { mutableListOf() }.forEach {
</a><a href="#h69-2-30" id="h69-2-30" class="d">-            if (messageBuilder.isNotEmpty()) messageBuilder.append(&quot;\n&quot;)
</a><a href="#h69-2-31" id="h69-2-31" class="d">-            messageBuilder.append(it)
</a><a href="#h69-2-32" id="h69-2-32" class="d">-        }
</a><a href="#h69-2-33" id="h69-2-33" class="d">-        return messageBuilder.toString()
</a><a href="#h69-2-34" id="h69-2-34" class="d">-    }
</a><a href="#h69-2-35" id="h69-2-35" class="i">+    private fun setupNotificationActionButtons(contentType: ContentType, conversationId: String, messageId: Long, notificationData: NotificationData) {
</a><a href="#h69-2-36" id="h69-2-36" class="i">+        val betterNotifications = context.config.options(ConfigProperty.BETTER_NOTIFICATIONS)
</a> 
<a href="#h69-2-38" id="h69-2-38" class="d">-    private fun setupNotificationActionButtons(conversationId: String, notificationData: NotificationData) {
</a>         val notificationBuilder = XposedHelpers.newInstance(
             Notification.Builder::class.java,
             context.androidContext,
             notificationData.notification
         ) as Notification.Builder
 
<a href="#h69-2-45" id="h69-2-45" class="d">-        val chatReplyInput = RemoteInput.Builder(&quot;chat_reply_input&quot;)
</a><a href="#h69-2-46" id="h69-2-46" class="d">-            .setLabel(&quot;Reply&quot;)
</a><a href="#h69-2-47" id="h69-2-47" class="d">-            .build()
</a><a href="#h69-2-48" id="h69-2-48" class="d">-
</a><a href="#h69-2-49" id="h69-2-49" class="d">-        val replyIntent = Intent()
</a><a href="#h69-2-50" id="h69-2-50" class="d">-            .setClassName(Constants.SNAPCHAT_PACKAGE_NAME, broadcastReceiverClass.name)
</a><a href="#h69-2-51" id="h69-2-51" class="d">-            .putExtra(&quot;conversation_id&quot;, conversationId)
</a><a href="#h69-2-52" id="h69-2-52" class="d">-            .putExtra(&quot;notification_id&quot;, notificationData.id)
</a><a href="#h69-2-53" id="h69-2-53" class="d">-            .setAction(ACTION_REPLY)
</a><a href="#h69-2-54" id="h69-2-54" class="d">-
</a><a href="#h69-2-55" id="h69-2-55" class="d">-        val action = Notification.Action.Builder(
</a><a href="#h69-2-56" id="h69-2-56" class="d">-            null,
</a><a href="#h69-2-57" id="h69-2-57" class="d">-            &quot;Reply&quot;,
</a><a href="#h69-2-58" id="h69-2-58" class="d">-            PendingIntent.getBroadcast(
</a><a href="#h69-2-59" id="h69-2-59" class="i">+        val actions = mutableListOf&lt;Notification.Action&gt;()
</a><a href="#h69-2-60" id="h69-2-60" class="i">+        actions.addAll(notificationData.notification.actions)
</a><a href="#h69-2-61" id="h69-2-61" class="i">+
</a><a href="#h69-2-62" id="h69-2-62" class="i">+        fun newAction(title: String, remoteAction: String, filter: (() -&gt; Boolean), builder: (Notification.Action.Builder) -&gt; Unit) {
</a><a href="#h69-2-63" id="h69-2-63" class="i">+            if (!filter()) return
</a><a href="#h69-2-64" id="h69-2-64" class="i">+            val intent = Intent().setClassName(Constants.SNAPCHAT_PACKAGE_NAME, broadcastReceiverClass.name)
</a><a href="#h69-2-65" id="h69-2-65" class="i">+                .putExtra(&quot;conversation_id&quot;, conversationId)
</a><a href="#h69-2-66" id="h69-2-66" class="i">+                .putExtra(&quot;notification_id&quot;, notificationData.id)
</a><a href="#h69-2-67" id="h69-2-67" class="i">+                .putExtra(&quot;message_id&quot;, messageId)
</a><a href="#h69-2-68" id="h69-2-68" class="i">+                .setAction(remoteAction)
</a><a href="#h69-2-69" id="h69-2-69" class="i">+            val action = Notification.Action.Builder(null, title, PendingIntent.getBroadcast(
</a>                 context.androidContext,
                 System.nanoTime().toInt(),
<a href="#h69-2-72" id="h69-2-72" class="d">-                replyIntent,
</a><a href="#h69-2-73" id="h69-2-73" class="i">+                intent,
</a>                 PendingIntent.FLAG_CANCEL_CURRENT or PendingIntent.FLAG_MUTABLE
<a href="#h69-2-75" id="h69-2-75" class="d">-            )
</a><a href="#h69-2-76" id="h69-2-76" class="d">-        ).addRemoteInput(chatReplyInput).build()
</a><a href="#h69-2-77" id="h69-2-77" class="i">+            )).apply(builder).build()
</a><a href="#h69-2-78" id="h69-2-78" class="i">+            actions.add(action)
</a><a href="#h69-2-79" id="h69-2-79" class="i">+        }
</a> 
<a href="#h69-2-81" id="h69-2-81" class="d">-        notificationBuilder.setActions(action)
</a><a href="#h69-2-82" id="h69-2-82" class="i">+        newAction(&quot;Reply&quot;, ACTION_REPLY, {
</a><a href="#h69-2-83" id="h69-2-83" class="i">+            betterNotifications[&quot;reply_button&quot;] == true &amp;&amp; contentType == ContentType.CHAT
</a><a href="#h69-2-84" id="h69-2-84" class="i">+        }) {
</a><a href="#h69-2-85" id="h69-2-85" class="i">+            val chatReplyInput = RemoteInput.Builder(&quot;chat_reply_input&quot;)
</a><a href="#h69-2-86" id="h69-2-86" class="i">+                .setLabel(&quot;Reply&quot;)
</a><a href="#h69-2-87" id="h69-2-87" class="i">+                .build()
</a><a href="#h69-2-88" id="h69-2-88" class="i">+            it.addRemoteInput(chatReplyInput)
</a><a href="#h69-2-89" id="h69-2-89" class="i">+        }
</a><a href="#h69-2-90" id="h69-2-90" class="i">+
</a><a href="#h69-2-91" id="h69-2-91" class="i">+        newAction(&quot;Download&quot;, ACTION_DOWNLOAD, {
</a><a href="#h69-2-92" id="h69-2-92" class="i">+            betterNotifications[&quot;download_button&quot;] == true &amp;&amp; (contentType == ContentType.EXTERNAL_MEDIA || contentType == ContentType.SNAP)
</a><a href="#h69-2-93" id="h69-2-93" class="i">+        }) {}
</a><a href="#h69-2-94" id="h69-2-94" class="i">+
</a><a href="#h69-2-95" id="h69-2-95" class="i">+        notificationBuilder.setActions(*actions.toTypedArray())
</a>         notificationData.notification = notificationBuilder.build()
     }
 
<a href="#h69-3" id="h69-3" class="h">@@ -118,12 +135,14 @@ class Notifications : Feature(&quot;Notifications&quot;, loadParams = FeatureLoadParams.IN
</a>         Hooker.hook(broadcastReceiverClass, &quot;onReceive&quot;, HookStage.BEFORE) { param -&gt;
             val androidContext = param.arg&lt;Context&gt;(0)
             val intent = param.arg&lt;Intent&gt;(1)
<a href="#h69-3-3" id="h69-3-3" class="d">-            if (intent.action != ACTION_REPLY) return@hook
</a><a href="#h69-3-4" id="h69-3-4" class="d">-            param.setResult(null)
</a> 
<a href="#h69-3-6" id="h69-3-6" class="i">+            val conversationId = intent.getStringExtra(&quot;conversation_id&quot;) ?: return@hook
</a><a href="#h69-3-7" id="h69-3-7" class="i">+            val messageId = intent.getLongExtra(&quot;message_id&quot;, -1)
</a><a href="#h69-3-8" id="h69-3-8" class="i">+            val notificationId = intent.getIntExtra(&quot;notification_id&quot;, -1)
</a>             val notificationManager = androidContext.getSystemService(Context.NOTIFICATION_SERVICE) as NotificationManager
<a href="#h69-3-10" id="h69-3-10" class="d">-            val updateNotification: (Int, (Notification) -&gt; Unit) -&gt; Unit = { notificationId, notificationBuilder -&gt;
</a><a href="#h69-3-11" id="h69-3-11" class="d">-                notificationManager.activeNotifications.firstOrNull { it.id == notificationId }?.let {
</a><a href="#h69-3-12" id="h69-3-12" class="i">+
</a><a href="#h69-3-13" id="h69-3-13" class="i">+            val updateNotification: (Int, (Notification) -&gt; Unit) -&gt; Unit = { id, notificationBuilder -&gt;
</a><a href="#h69-3-14" id="h69-3-14" class="i">+                notificationManager.activeNotifications.firstOrNull { it.id == id }?.let {
</a>                     notificationBuilder(it.notification)
                     XposedBridge.invokeOriginalMethod(notifyAsUserMethod, notificationManager, arrayOf(
                         it.tag, it.id, it.notification, it.user
<a href="#h69-4" id="h69-4" class="h">@@ -131,22 +150,35 @@ class Notifications : Feature(&quot;Notifications&quot;, loadParams = FeatureLoadParams.IN
</a>                 }
             }
 
<a href="#h69-4-3" id="h69-4-3" class="d">-            val input = RemoteInput.getResultsFromIntent(intent).getCharSequence(&quot;chat_reply_input&quot;)
</a><a href="#h69-4-4" id="h69-4-4" class="d">-                .toString()
</a><a href="#h69-4-5" id="h69-4-5" class="d">-            val conversationId = intent.getStringExtra(&quot;conversation_id&quot;)!!
</a><a href="#h69-4-6" id="h69-4-6" class="d">-            val notificationId = intent.getIntExtra(&quot;notification_id&quot;, -1)
</a><a href="#h69-4-7" id="h69-4-7" class="i">+            when (intent.action) {
</a><a href="#h69-4-8" id="h69-4-8" class="i">+                ACTION_REPLY -&gt; {
</a><a href="#h69-4-9" id="h69-4-9" class="i">+                    val input = RemoteInput.getResultsFromIntent(intent).getCharSequence(&quot;chat_reply_input&quot;)
</a><a href="#h69-4-10" id="h69-4-10" class="i">+                        .toString()
</a> 
<a href="#h69-4-12" id="h69-4-12" class="d">-            context.database.getMyUserId()?.let { context.database.getFriendInfo(it) }?.let { myUser -&gt;
</a><a href="#h69-4-13" id="h69-4-13" class="d">-                cachedMessages.computeIfAbsent(conversationId) { mutableListOf() }.add(&quot;${myUser.displayName}: $input&quot;)
</a><a href="#h69-4-14" id="h69-4-14" class="i">+                    context.database.getMyUserId()?.let { context.database.getFriendInfo(it) }?.let { myUser -&gt;
</a><a href="#h69-4-15" id="h69-4-15" class="i">+                        cachedMessages.computeIfAbsent(conversationId) { mutableListOf() }.add(&quot;${myUser.displayName}: $input&quot;)
</a> 
<a href="#h69-4-17" id="h69-4-17" class="d">-                updateNotification(notificationId) { notification -&gt;
</a><a href="#h69-4-18" id="h69-4-18" class="d">-                    setNotificationText(notification, computeNotificationText(conversationId))
</a><a href="#h69-4-19" id="h69-4-19" class="d">-                }
</a><a href="#h69-4-20" id="h69-4-20" class="i">+                        updateNotification(notificationId) { notification -&gt;
</a><a href="#h69-4-21" id="h69-4-21" class="i">+                            notification.flags = notification.flags or Notification.FLAG_ONLY_ALERT_ONCE
</a><a href="#h69-4-22" id="h69-4-22" class="i">+                            setNotificationText(notification, conversationId)
</a><a href="#h69-4-23" id="h69-4-23" class="i">+                        }
</a> 
<a href="#h69-4-25" id="h69-4-25" class="d">-                context.messageSender.sendChatMessage(listOf(SnapUUID.fromString(conversationId)), input, onError = {
</a><a href="#h69-4-26" id="h69-4-26" class="d">-                    context.longToast(&quot;Failed to send message: $it&quot;)
</a><a href="#h69-4-27" id="h69-4-27" class="d">-                })
</a><a href="#h69-4-28" id="h69-4-28" class="i">+                        context.messageSender.sendChatMessage(listOf(SnapUUID.fromString(conversationId)), input, onError = {
</a><a href="#h69-4-29" id="h69-4-29" class="i">+                            context.longToast(&quot;Failed to send message: $it&quot;)
</a><a href="#h69-4-30" id="h69-4-30" class="i">+                        })
</a><a href="#h69-4-31" id="h69-4-31" class="i">+                    }
</a><a href="#h69-4-32" id="h69-4-32" class="i">+                }
</a><a href="#h69-4-33" id="h69-4-33" class="i">+                ACTION_DOWNLOAD -&gt; {
</a><a href="#h69-4-34" id="h69-4-34" class="i">+                    runCatching {
</a><a href="#h69-4-35" id="h69-4-35" class="i">+                        context.feature(MediaDownloader::class).downloadMessageId(messageId, isPreview = false)
</a><a href="#h69-4-36" id="h69-4-36" class="i">+                    }.onFailure {
</a><a href="#h69-4-37" id="h69-4-37" class="i">+                        context.longToast(it)
</a><a href="#h69-4-38" id="h69-4-38" class="i">+                    }
</a><a href="#h69-4-39" id="h69-4-39" class="i">+                }
</a><a href="#h69-4-40" id="h69-4-40" class="i">+                else -&gt; return@hook
</a>             }
<a href="#h69-4-42" id="h69-4-42" class="i">+
</a><a href="#h69-4-43" id="h69-4-43" class="i">+            param.setResult(null)
</a>         }
     }
 
<a href="#h69-5" id="h69-5" class="h">@@ -160,90 +192,80 @@ class Notifications : Feature(&quot;Notifications&quot;, loadParams = FeatureLoadParams.IN
</a>             ))
         }
 
<a href="#h69-5-3" id="h69-5-3" class="d">-        notificationDataQueue.entries.onEach { (messageId, notificationData) -&gt;
</a><a href="#h69-5-4" id="h69-5-4" class="d">-            val snapMessage = messages.firstOrNull { message -&gt; message.orderKey == messageId } ?: return
</a><a href="#h69-5-5" id="h69-5-5" class="d">-            val senderUsername by lazy {
</a><a href="#h69-5-6" id="h69-5-6" class="d">-                context.database.getFriendInfo(snapMessage.senderId.toString())?.let {
</a><a href="#h69-5-7" id="h69-5-7" class="d">-                    it.displayName ?: it.username
</a><a href="#h69-5-8" id="h69-5-8" class="i">+        synchronized(notificationDataQueue) {
</a><a href="#h69-5-9" id="h69-5-9" class="i">+            notificationDataQueue.entries.onEach { (messageId, notificationData) -&gt;
</a><a href="#h69-5-10" id="h69-5-10" class="i">+                val snapMessage = messages.firstOrNull { message -&gt; message.orderKey == messageId } ?: return
</a><a href="#h69-5-11" id="h69-5-11" class="i">+                val senderUsername by lazy {
</a><a href="#h69-5-12" id="h69-5-12" class="i">+                    context.database.getFriendInfo(snapMessage.senderId.toString())?.let {
</a><a href="#h69-5-13" id="h69-5-13" class="i">+                        it.displayName ?: it.username
</a><a href="#h69-5-14" id="h69-5-14" class="i">+                    }
</a>                 }
<a href="#h69-5-16" id="h69-5-16" class="d">-            }
</a> 
<a href="#h69-5-18" id="h69-5-18" class="d">-            val contentType = snapMessage.messageContent.contentType
</a><a href="#h69-5-19" id="h69-5-19" class="d">-            val contentData = snapMessage.messageContent.content
</a><a href="#h69-5-20" id="h69-5-20" class="i">+                val contentType = snapMessage.messageContent.contentType
</a><a href="#h69-5-21" id="h69-5-21" class="i">+                val contentData = snapMessage.messageContent.content
</a> 
<a href="#h69-5-23" id="h69-5-23" class="d">-            val formatUsername: (String) -&gt; String = { &quot;$senderUsername: $it&quot; }
</a><a href="#h69-5-24" id="h69-5-24" class="d">-            val notificationCache = cachedMessages.let { it.computeIfAbsent(conversationId) { mutableListOf() } }
</a><a href="#h69-5-25" id="h69-5-25" class="d">-            val appendNotifications: () -&gt; Unit = { setNotificationText(notificationData.notification, computeNotificationText(conversationId))}
</a><a href="#h69-5-26" id="h69-5-26" class="i">+                val formatUsername: (String) -&gt; String = { &quot;$senderUsername: $it&quot; }
</a><a href="#h69-5-27" id="h69-5-27" class="i">+                val notificationCache = cachedMessages.let { it.computeIfAbsent(conversationId) { mutableListOf() } }
</a><a href="#h69-5-28" id="h69-5-28" class="i">+                val appendNotifications: () -&gt; Unit = { setNotificationText(notificationData.notification, conversationId)}
</a> 
<a href="#h69-5-30" id="h69-5-30" class="d">-            when (contentType) {
</a><a href="#h69-5-31" id="h69-5-31" class="d">-                ContentType.NOTE -&gt; {
</a><a href="#h69-5-32" id="h69-5-32" class="d">-                    notificationCache.add(formatUsername(&quot;sent audio note&quot;))
</a><a href="#h69-5-33" id="h69-5-33" class="d">-                    appendNotifications()
</a><a href="#h69-5-34" id="h69-5-34" class="d">-                }
</a><a href="#h69-5-35" id="h69-5-35" class="d">-                ContentType.CHAT -&gt; {
</a><a href="#h69-5-36" id="h69-5-36" class="d">-                    ProtoReader(contentData).getString(2, 1)?.trim()?.let {
</a><a href="#h69-5-37" id="h69-5-37" class="d">-                        notificationCache.add(formatUsername(it))
</a><a href="#h69-5-38" id="h69-5-38" class="d">-                    }
</a><a href="#h69-5-39" id="h69-5-39" class="d">-                    appendNotifications()
</a><a href="#h69-5-40" id="h69-5-40" class="d">-                }
</a><a href="#h69-5-41" id="h69-5-41" class="d">-                ContentType.SNAP, ContentType.EXTERNAL_MEDIA-&gt; {
</a><a href="#h69-5-42" id="h69-5-42" class="d">-                    //serialize the message content into a json object
</a><a href="#h69-5-43" id="h69-5-43" class="d">-                    val serializedMessageContent = context.gson.toJsonTree(snapMessage.messageContent.instanceNonNull()).asJsonObject
</a><a href="#h69-5-44" id="h69-5-44" class="d">-                    val mediaReferences = serializedMessageContent[&quot;mRemoteMediaReferences&quot;]
</a><a href="#h69-5-45" id="h69-5-45" class="d">-                        .asJsonArray.map { it.asJsonObject[&quot;mMediaReferences&quot;].asJsonArray }
</a><a href="#h69-5-46" id="h69-5-46" class="d">-                        .flatten()
</a><a href="#h69-5-47" id="h69-5-47" class="d">-
</a><a href="#h69-5-48" id="h69-5-48" class="d">-                    mediaReferences.forEach { media -&gt;
</a><a href="#h69-5-49" id="h69-5-49" class="d">-                        val protoMediaReference = media.asJsonObject[&quot;mContentObject&quot;].asJsonArray.map { it.asByte }.toByteArray()
</a><a href="#h69-5-50" id="h69-5-50" class="d">-                        val mediaType = MediaReferenceType.valueOf(media.asJsonObject[&quot;mMediaType&quot;].asString)
</a><a href="#h69-5-51" id="h69-5-51" class="d">-                        runCatching {
</a><a href="#h69-5-52" id="h69-5-52" class="d">-                            val messageReader = ProtoReader(contentData)
</a><a href="#h69-5-53" id="h69-5-53" class="d">-                            val downloadedMediaList = MediaDownloaderHelper.downloadMediaFromReference(protoMediaReference) {
</a><a href="#h69-5-54" id="h69-5-54" class="d">-                                EncryptionHelper.decryptInputStream(it, contentType, messageReader, isArroyo = false)
</a><a href="#h69-5-55" id="h69-5-55" class="d">-                            }
</a><a href="#h69-5-56" id="h69-5-56" class="i">+                setupNotificationActionButtons(contentType, conversationId, snapMessage.messageDescriptor.messageId, notificationData)
</a> 
<a href="#h69-5-58" id="h69-5-58" class="d">-                            var bitmapPreview = PreviewUtils.createPreview(downloadedMediaList[MediaType.ORIGINAL]!!, mediaType.name.contains(&quot;VIDEO&quot;))!!
</a><a href="#h69-5-59" id="h69-5-59" class="d">-
</a><a href="#h69-5-60" id="h69-5-60" class="d">-                            downloadedMediaList[MediaType.OVERLAY]?.let {
</a><a href="#h69-5-61" id="h69-5-61" class="d">-                                bitmapPreview = PreviewUtils.mergeBitmapOverlay(bitmapPreview, BitmapFactory.decodeByteArray(it, 0, it.size))
</a><a href="#h69-5-62" id="h69-5-62" class="i">+                when (contentType) {
</a><a href="#h69-5-63" id="h69-5-63" class="i">+                    ContentType.NOTE -&gt; {
</a><a href="#h69-5-64" id="h69-5-64" class="i">+                        notificationCache.add(formatUsername(&quot;sent audio note&quot;))
</a><a href="#h69-5-65" id="h69-5-65" class="i">+                        appendNotifications()
</a><a href="#h69-5-66" id="h69-5-66" class="i">+                    }
</a><a href="#h69-5-67" id="h69-5-67" class="i">+                    ContentType.CHAT -&gt; {
</a><a href="#h69-5-68" id="h69-5-68" class="i">+                        ProtoReader(contentData).getString(2, 1)?.trim()?.let {
</a><a href="#h69-5-69" id="h69-5-69" class="i">+                            notificationCache.add(formatUsername(it))
</a><a href="#h69-5-70" id="h69-5-70" class="i">+                        }
</a><a href="#h69-5-71" id="h69-5-71" class="i">+                        appendNotifications()
</a><a href="#h69-5-72" id="h69-5-72" class="i">+                    }
</a><a href="#h69-5-73" id="h69-5-73" class="i">+                    ContentType.SNAP, ContentType.EXTERNAL_MEDIA-&gt; {
</a><a href="#h69-5-74" id="h69-5-74" class="i">+                        //serialize the message content into a json object
</a><a href="#h69-5-75" id="h69-5-75" class="i">+                        val serializedMessageContent = context.gson.toJsonTree(snapMessage.messageContent.instanceNonNull()).asJsonObject
</a><a href="#h69-5-76" id="h69-5-76" class="i">+                        val mediaReferences = serializedMessageContent[&quot;mRemoteMediaReferences&quot;]
</a><a href="#h69-5-77" id="h69-5-77" class="i">+                            .asJsonArray.map { it.asJsonObject[&quot;mMediaReferences&quot;].asJsonArray }
</a><a href="#h69-5-78" id="h69-5-78" class="i">+                            .flatten()
</a><a href="#h69-5-79" id="h69-5-79" class="i">+
</a><a href="#h69-5-80" id="h69-5-80" class="i">+                        mediaReferences.forEach { media -&gt;
</a><a href="#h69-5-81" id="h69-5-81" class="i">+                            val protoMediaReference = media.asJsonObject[&quot;mContentObject&quot;].asJsonArray.map { it.asByte }.toByteArray()
</a><a href="#h69-5-82" id="h69-5-82" class="i">+                            val mediaType = MediaReferenceType.valueOf(media.asJsonObject[&quot;mMediaType&quot;].asString)
</a><a href="#h69-5-83" id="h69-5-83" class="i">+                            runCatching {
</a><a href="#h69-5-84" id="h69-5-84" class="i">+                                val messageReader = ProtoReader(contentData)
</a><a href="#h69-5-85" id="h69-5-85" class="i">+                                val downloadedMediaList = MediaDownloaderHelper.downloadMediaFromReference(protoMediaReference) {
</a><a href="#h69-5-86" id="h69-5-86" class="i">+                                    EncryptionHelper.decryptInputStream(it, contentType, messageReader, isArroyo = false)
</a><a href="#h69-5-87" id="h69-5-87" class="i">+                                }
</a><a href="#h69-5-88" id="h69-5-88" class="i">+
</a><a href="#h69-5-89" id="h69-5-89" class="i">+                                var bitmapPreview = PreviewUtils.createPreview(downloadedMediaList[SplitMediaAssetType.ORIGINAL]!!, mediaType.name.contains(&quot;VIDEO&quot;))!!
</a><a href="#h69-5-90" id="h69-5-90" class="i">+
</a><a href="#h69-5-91" id="h69-5-91" class="i">+                                downloadedMediaList[SplitMediaAssetType.OVERLAY]?.let {
</a><a href="#h69-5-92" id="h69-5-92" class="i">+                                    bitmapPreview = PreviewUtils.mergeBitmapOverlay(bitmapPreview, BitmapFactory.decodeByteArray(it, 0, it.size))
</a><a href="#h69-5-93" id="h69-5-93" class="i">+                                }
</a><a href="#h69-5-94" id="h69-5-94" class="i">+
</a><a href="#h69-5-95" id="h69-5-95" class="i">+                                val notificationBuilder = XposedHelpers.newInstance(
</a><a href="#h69-5-96" id="h69-5-96" class="i">+                                    Notification.Builder::class.java,
</a><a href="#h69-5-97" id="h69-5-97" class="i">+                                    context.androidContext,
</a><a href="#h69-5-98" id="h69-5-98" class="i">+                                    notificationData.notification
</a><a href="#h69-5-99" id="h69-5-99" class="i">+                                ) as Notification.Builder
</a><a href="#h69-5-100" id="h69-5-100" class="i">+                                notificationBuilder.setLargeIcon(bitmapPreview)
</a><a href="#h69-5-101" id="h69-5-101" class="i">+                                notificationBuilder.style = Notification.BigPictureStyle().bigPicture(bitmapPreview).bigLargeIcon(null as Bitmap?)
</a><a href="#h69-5-102" id="h69-5-102" class="i">+
</a><a href="#h69-5-103" id="h69-5-103" class="i">+                                sendNotificationData(notificationData.copy(notification = notificationBuilder.build()), true)
</a><a href="#h69-5-104" id="h69-5-104" class="i">+                                return@onEach
</a><a href="#h69-5-105" id="h69-5-105" class="i">+                            }.onFailure {
</a><a href="#h69-5-106" id="h69-5-106" class="i">+                                Logger.xposedLog(&quot;Failed to send preview notification&quot;, it)
</a>                             }
<a href="#h69-5-108" id="h69-5-108" class="d">-
</a><a href="#h69-5-109" id="h69-5-109" class="d">-                            val notificationBuilder = XposedHelpers.newInstance(
</a><a href="#h69-5-110" id="h69-5-110" class="d">-                                Notification.Builder::class.java,
</a><a href="#h69-5-111" id="h69-5-111" class="d">-                                context.androidContext,
</a><a href="#h69-5-112" id="h69-5-112" class="d">-                                notificationData.notification
</a><a href="#h69-5-113" id="h69-5-113" class="d">-                            ) as Notification.Builder
</a><a href="#h69-5-114" id="h69-5-114" class="d">-                            notificationBuilder.setLargeIcon(bitmapPreview)
</a><a href="#h69-5-115" id="h69-5-115" class="d">-                            notificationBuilder.style = Notification.BigPictureStyle().bigPicture(bitmapPreview).bigLargeIcon(null as Bitmap?)
</a><a href="#h69-5-116" id="h69-5-116" class="d">-
</a><a href="#h69-5-117" id="h69-5-117" class="d">-                            sendNotificationData(notificationData.copy(notification = notificationBuilder.build()), true)
</a><a href="#h69-5-118" id="h69-5-118" class="d">-                            return@onEach
</a><a href="#h69-5-119" id="h69-5-119" class="d">-                        }.onFailure {
</a><a href="#h69-5-120" id="h69-5-120" class="d">-                            Logger.xposedLog(&quot;Failed to send preview notification&quot;, it)
</a>                         }
                     }
<a href="#h69-5-123" id="h69-5-123" class="i">+                    else -&gt; {
</a><a href="#h69-5-124" id="h69-5-124" class="i">+                        notificationCache.add(formatUsername(&quot;sent $contentType&quot;))
</a><a href="#h69-5-125" id="h69-5-125" class="i">+                    }
</a>                 }
<a href="#h69-5-127" id="h69-5-127" class="d">-                else -&gt; {
</a><a href="#h69-5-128" id="h69-5-128" class="d">-                    notificationCache.add(formatUsername(&quot;sent $contentType&quot;))
</a><a href="#h69-5-129" id="h69-5-129" class="d">-                }
</a><a href="#h69-5-130" id="h69-5-130" class="d">-            }
</a><a href="#h69-5-131" id="h69-5-131" class="d">-
</a><a href="#h69-5-132" id="h69-5-132" class="d">-            if (contentType == ContentType.CHAT &amp;&amp; context.config.options(ConfigProperty.BETTER_NOTIFICATIONS)[&quot;reply_button&quot;] == true) {
</a><a href="#h69-5-133" id="h69-5-133" class="d">-                setupNotificationActionButtons(conversationId, notificationData)
</a><a href="#h69-5-134" id="h69-5-134" class="d">-            }
</a><a href="#h69-5-135" id="h69-5-135" class="d">-
</a><a href="#h69-5-136" id="h69-5-136" class="d">-            sendNotificationData(notificationData, false)
</a><a href="#h69-5-137" id="h69-5-137" class="d">-        }.clear()
</a><a href="#h69-5-138" id="h69-5-138" class="d">-    }
</a><a href="#h69-5-139" id="h69-5-139" class="d">-
</a><a href="#h69-5-140" id="h69-5-140" class="d">-    private fun shouldIgnoreNotification(type: String): Boolean {
</a><a href="#h69-5-141" id="h69-5-141" class="d">-        val states = context.config.options(ConfigProperty.NOTIFICATION_BLACKLIST)
</a> 
<a href="#h69-5-143" id="h69-5-143" class="d">-        states[&quot;snap&quot;]?.let { if (type.endsWith(&quot;SNAP&quot;) &amp;&amp; it) return true }
</a><a href="#h69-5-144" id="h69-5-144" class="d">-        states[&quot;chat&quot;]?.let { if (type.endsWith(&quot;CHAT&quot;) &amp;&amp; it) return true }
</a><a href="#h69-5-145" id="h69-5-145" class="d">-        states[&quot;typing&quot;]?.let { if (type.endsWith(&quot;TYPING&quot;) &amp;&amp; it) return true }
</a><a href="#h69-5-146" id="h69-5-146" class="d">-
</a><a href="#h69-5-147" id="h69-5-147" class="d">-        return false
</a><a href="#h69-5-148" id="h69-5-148" class="i">+                sendNotificationData(notificationData, false)
</a><a href="#h69-5-149" id="h69-5-149" class="i">+            }.clear()
</a><a href="#h69-5-150" id="h69-5-150" class="i">+        }
</a>     }
 
     override fun init() {
<a href="#h69-6" id="h69-6" class="h">@@ -260,16 +282,16 @@ class Notifications : Feature(&quot;Notifications&quot;, loadParams = FeatureLoadParams.IN
</a>             val notificationType = extras.getString(&quot;notification_type&quot;) ?: return@hook
             val conversationId = extras.getString(&quot;conversation_id&quot;) ?: return@hook
 
<a href="#h69-6-3" id="h69-6-3" class="d">-            if (shouldIgnoreNotification(notificationType)) {
</a><a href="#h69-6-4" id="h69-6-4" class="d">-                param.setResult(null)
</a><a href="#h69-6-5" id="h69-6-5" class="d">-                return@hook
</a><a href="#h69-6-6" id="h69-6-6" class="d">-            }
</a><a href="#h69-6-7" id="h69-6-7" class="d">-
</a>             if (context.config.options(ConfigProperty.BETTER_NOTIFICATIONS)
<a href="#h69-6-9" id="h69-6-9" class="d">-                .filter { it.value }.none { notificationType.endsWith(it.key.uppercase())}) return@hook
</a><a href="#h69-6-10" id="h69-6-10" class="i">+                .filter { it.value }.map { it.key.uppercase() }.none {
</a><a href="#h69-6-11" id="h69-6-11" class="i">+                    notificationType.contains(it)
</a><a href="#h69-6-12" id="h69-6-12" class="i">+                }) return@hook
</a> 
             val conversationManager: Any = context.feature(Messaging::class).conversationManager
<a href="#h69-6-15" id="h69-6-15" class="d">-            notificationDataQueue[messageId.toLong()] = notificationData
</a><a href="#h69-6-16" id="h69-6-16" class="i">+
</a><a href="#h69-6-17" id="h69-6-17" class="i">+            synchronized(notificationDataQueue) {
</a><a href="#h69-6-18" id="h69-6-18" class="i">+                notificationDataQueue[messageId.toLong()] = notificationData
</a><a href="#h69-6-19" id="h69-6-19" class="i">+            }
</a> 
             val callback = CallbackBuilder(fetchConversationWithMessagesCallback)
                 .override(&quot;onFetchConversationWithMessagesComplete&quot;) { callbackParam -&gt;
<a href="#h69-7" id="h69-7" class="h">@@ -284,12 +306,32 @@ class Notifications : Feature(&quot;Notifications&quot;, loadParams = FeatureLoadParams.IN
</a>             param.setResult(null)
         }
 
<a href="#h69-7-3" id="h69-7-3" class="d">-        Hooker.hook(cancelAsUserMethod, HookStage.BEFORE) { param -&gt;
</a><a href="#h69-7-4" id="h69-7-4" class="i">+        XposedHelpers.findMethodExact(
</a><a href="#h69-7-5" id="h69-7-5" class="i">+            NotificationManager::class.java,
</a><a href="#h69-7-6" id="h69-7-6" class="i">+            &quot;cancelAsUser&quot;, String::class.java,
</a><a href="#h69-7-7" id="h69-7-7" class="i">+            Int::class.javaPrimitiveType,
</a><a href="#h69-7-8" id="h69-7-8" class="i">+            UserHandle::class.java
</a><a href="#h69-7-9" id="h69-7-9" class="i">+        ).hook(HookStage.BEFORE) { param -&gt;
</a>             val notificationId = param.arg&lt;Int&gt;(1)
             notificationIdMap[notificationId]?.let {
                 cachedMessages[it]?.clear()
             }
         }
<a href="#h69-7-15" id="h69-7-15" class="i">+
</a><a href="#h69-7-16" id="h69-7-16" class="i">+        findClass(&quot;com.google.firebase.messaging.FirebaseMessagingService&quot;).run {
</a><a href="#h69-7-17" id="h69-7-17" class="i">+            methods.first { it.declaringClass == this &amp;&amp; it.returnType == Void::class.javaPrimitiveType &amp;&amp; it.parameterCount == 1 &amp;&amp; it.parameterTypes[0] == Intent::class.java }
</a><a href="#h69-7-18" id="h69-7-18" class="i">+                .hook(HookStage.BEFORE) { param -&gt;
</a><a href="#h69-7-19" id="h69-7-19" class="i">+                    val intent = param.argNullable&lt;Intent&gt;(0) ?: return@hook
</a><a href="#h69-7-20" id="h69-7-20" class="i">+                    val messageType = intent.getStringExtra(&quot;type&quot;) ?: return@hook
</a><a href="#h69-7-21" id="h69-7-21" class="i">+                    val states = context.config.options(ConfigProperty.NOTIFICATION_BLACKLIST)
</a><a href="#h69-7-22" id="h69-7-22" class="i">+
</a><a href="#h69-7-23" id="h69-7-23" class="i">+                    Logger.xposedLog(&quot;received message type: $messageType&quot;)
</a><a href="#h69-7-24" id="h69-7-24" class="i">+
</a><a href="#h69-7-25" id="h69-7-25" class="i">+                    if (states[messageType.replaceFirst(&quot;mischief_&quot;, &quot;&quot;)] == true) {
</a><a href="#h69-7-26" id="h69-7-26" class="i">+                        param.setResult(null)
</a><a href="#h69-7-27" id="h69-7-27" class="i">+                    }
</a><a href="#h69-7-28" id="h69-7-28" class="i">+                }
</a><a href="#h69-7-29" id="h69-7-29" class="i">+        }
</a>     }
 
     data class NotificationData(
<b>diff --git a/<a id="h70" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/PinConversations.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/PinConversations.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/PinConversations.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/PinConversations.kt</a></b>
<a href="#h70-0" id="h70-0" class="h">@@ -1,6 +1,6 @@
</a> package me.rhunk.snapenhance.features.impl.ui
 
<a href="#h70-0-2" id="h70-0-2" class="d">-import me.rhunk.snapenhance.bridge.common.impl.file.BridgeFileType
</a><a href="#h70-0-3" id="h70-0-3" class="i">+import me.rhunk.snapenhance.bridge.types.BridgeFileType
</a> import me.rhunk.snapenhance.data.wrapper.impl.SnapUUID
 import me.rhunk.snapenhance.features.BridgeFileFeature
 import me.rhunk.snapenhance.features.FeatureLoadParams
<b>diff --git a/<a id="h71" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/UITweaks.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/UITweaks.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/UITweaks.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/UITweaks.kt</a></b>
<a href="#h71-0" id="h71-0" class="h">@@ -1,7 +1,9 @@
</a> package me.rhunk.snapenhance.features.impl.ui
 
 import android.annotation.SuppressLint
<a href="#h71-0-3" id="h71-0-3" class="i">+import android.content.Context
</a> import android.content.res.Resources
<a href="#h71-0-5" id="h71-0-5" class="i">+import android.text.SpannableString
</a> import android.view.View
 import android.view.ViewGroup
 import android.widget.FrameLayout
<a href="#h71-1" id="h71-1" class="h">@@ -32,7 +34,7 @@ class UITweaks : Feature(&quot;UITweaks&quot;, loadParams = FeatureLoadParams.ACTIVITY_CRE
</a>         param.setResult(null)
     }
 
<a href="#h71-1-3" id="h71-1-3" class="d">-    @SuppressLint(&quot;DiscouragedApi&quot;)
</a><a href="#h71-1-4" id="h71-1-4" class="i">+    @SuppressLint(&quot;DiscouragedApi&quot;, &quot;InternalInsetResource&quot;)
</a>     override fun onActivityCreate() {
         val blockAds = context.config.bool(ConfigProperty.BLOCK_ADS)
         val hiddenElements = context.config.options(ConfigProperty.HIDE_UI_ELEMENTS)
<a href="#h71-2" id="h71-2" class="h">@@ -92,6 +94,20 @@ class UITweaks : Feature(&quot;UITweaks&quot;, loadParams = FeatureLoadParams.ACTIVITY_CRE
</a>                 hideStorySection(param)
             }
 
<a href="#h71-2-3" id="h71-2-3" class="i">+            //mappings?
</a><a href="#h71-2-4" id="h71-2-4" class="i">+            if (hideStorySection[&quot;hide_friend_suggestions&quot;] == true &amp;&amp; view.javaClass.superclass?.name?.endsWith(&quot;StackDrawLayout&quot;) == true) {
</a><a href="#h71-2-5" id="h71-2-5" class="i">+                val layoutParams = view.layoutParams as? FrameLayout.LayoutParams ?: return@hook
</a><a href="#h71-2-6" id="h71-2-6" class="i">+                if (layoutParams.width == -1 &amp;&amp;
</a><a href="#h71-2-7" id="h71-2-7" class="i">+                    layoutParams.height == -2 &amp;&amp;
</a><a href="#h71-2-8" id="h71-2-8" class="i">+                    view.javaClass.let { clazz -&gt;
</a><a href="#h71-2-9" id="h71-2-9" class="i">+                        clazz.methods.any { it.returnType == SpannableString::class.java} &amp;&amp;
</a><a href="#h71-2-10" id="h71-2-10" class="i">+                        clazz.constructors.any { it.parameterCount == 1 &amp;&amp; it.parameterTypes[0] == Context::class.java }
</a><a href="#h71-2-11" id="h71-2-11" class="i">+                    }
</a><a href="#h71-2-12" id="h71-2-12" class="i">+                ) {
</a><a href="#h71-2-13" id="h71-2-13" class="i">+                    hideStorySection(param)
</a><a href="#h71-2-14" id="h71-2-14" class="i">+                }
</a><a href="#h71-2-15" id="h71-2-15" class="i">+            }
</a><a href="#h71-2-16" id="h71-2-16" class="i">+
</a>             if (hideStorySection[&quot;hide_following&quot;] == true &amp;&amp; (viewId == getIdentifier(&quot;df_small_story&quot;, &quot;id&quot;))
             ) {
                 hideStorySection(param)
<a href="#h71-3" id="h71-3" class="h">@@ -101,9 +117,20 @@ class UITweaks : Feature(&quot;UITweaks&quot;, loadParams = FeatureLoadParams.ACTIVITY_CRE
</a>                 hideStorySection(param)
             }
 
<a href="#h71-3-3" id="h71-3-3" class="d">-            if (isImmersiveCamera &amp;&amp; view.id == getIdentifier(&quot;full_screen_surface_view&quot;, &quot;id&quot;)) {
</a><a href="#h71-3-4" id="h71-3-4" class="d">-                Hooker.hookObjectMethod(View::class.java, view, &quot;setLayoutParams&quot;, HookStage.BEFORE) {
</a><a href="#h71-3-5" id="h71-3-5" class="d">-                    it.setArg(0, FrameLayout.LayoutParams(displayMetrics.widthPixels, displayMetrics.heightPixels))
</a><a href="#h71-3-6" id="h71-3-6" class="i">+            if (isImmersiveCamera) {
</a><a href="#h71-3-7" id="h71-3-7" class="i">+                if (view.id == getIdentifier(&quot;edits_container&quot;, &quot;id&quot;)) {
</a><a href="#h71-3-8" id="h71-3-8" class="i">+                    val deviceAspectRatio = displayMetrics.widthPixels.toFloat() / displayMetrics.heightPixels.toFloat()
</a><a href="#h71-3-9" id="h71-3-9" class="i">+                    Hooker.hookObjectMethod(View::class.java, view, &quot;layout&quot;, HookStage.BEFORE) {
</a><a href="#h71-3-10" id="h71-3-10" class="i">+                        val width = it.arg(2) as Int
</a><a href="#h71-3-11" id="h71-3-11" class="i">+                        val realHeight = (width / deviceAspectRatio).toInt()
</a><a href="#h71-3-12" id="h71-3-12" class="i">+                        it.setArg(3, realHeight)
</a><a href="#h71-3-13" id="h71-3-13" class="i">+                    }
</a><a href="#h71-3-14" id="h71-3-14" class="i">+                }
</a><a href="#h71-3-15" id="h71-3-15" class="i">+                if (view.id == getIdentifier(&quot;full_screen_surface_view&quot;, &quot;id&quot;)) {
</a><a href="#h71-3-16" id="h71-3-16" class="i">+                    Hooker.hookObjectMethod(View::class.java, view, &quot;layout&quot;, HookStage.BEFORE) {
</a><a href="#h71-3-17" id="h71-3-17" class="i">+                        it.setArg(1, 1)
</a><a href="#h71-3-18" id="h71-3-18" class="i">+                        it.setArg(3, displayMetrics.heightPixels)
</a><a href="#h71-3-19" id="h71-3-19" class="i">+                    }
</a>                 }
             }
 
<b>diff --git a/<a id="h72" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/hook/Hooker.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/hook/Hooker.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/hook/Hooker.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/hook/Hooker.kt</a></b>
<a href="#h72-0" id="h72-0" class="h">@@ -5,82 +5,78 @@ import de.robv.android.xposed.XposedBridge
</a> import java.lang.reflect.Member
 
 object Hooker {
<a href="#h72-0-3" id="h72-0-3" class="d">-    private fun newMethodHook(
</a><a href="#h72-0-4" id="h72-0-4" class="i">+    inline fun newMethodHook(
</a>         stage: HookStage,
<a href="#h72-0-6" id="h72-0-6" class="d">-        consumer: (HookAdapter) -&gt; Unit,
</a><a href="#h72-0-7" id="h72-0-7" class="d">-        filter: ((HookAdapter) -&gt; Boolean) = { true }
</a><a href="#h72-0-8" id="h72-0-8" class="i">+        crossinline consumer: (HookAdapter) -&gt; Unit,
</a><a href="#h72-0-9" id="h72-0-9" class="i">+        crossinline filter: ((HookAdapter) -&gt; Boolean) = { true }
</a>     ): XC_MethodHook {
<a href="#h72-0-11" id="h72-0-11" class="d">-        val callEvent = { param: XC_MethodHook.MethodHookParam&lt;*&gt; -&gt;
</a><a href="#h72-0-12" id="h72-0-12" class="d">-            HookAdapter(param).takeIf(filter)?.also(consumer)
</a><a href="#h72-0-13" id="h72-0-13" class="d">-        }
</a><a href="#h72-0-14" id="h72-0-14" class="d">-
</a>         return if (stage == HookStage.BEFORE) object : XC_MethodHook() {
             override fun beforeHookedMethod(param: MethodHookParam&lt;*&gt;) {
<a href="#h72-0-17" id="h72-0-17" class="d">-                callEvent(param)
</a><a href="#h72-0-18" id="h72-0-18" class="i">+                HookAdapter(param).takeIf(filter)?.also(consumer)
</a>             }
         } else object : XC_MethodHook() {
             override fun afterHookedMethod(param: MethodHookParam&lt;*&gt;) {
<a href="#h72-0-22" id="h72-0-22" class="d">-                callEvent(param)
</a><a href="#h72-0-23" id="h72-0-23" class="i">+                HookAdapter(param).takeIf(filter)?.also(consumer)
</a>             }
         }
     }
 
<a href="#h72-0-28" id="h72-0-28" class="d">-    fun hook(
</a><a href="#h72-0-29" id="h72-0-29" class="i">+    inline fun hook(
</a>         clazz: Class&lt;*&gt;,
         methodName: String,
         stage: HookStage,
<a href="#h72-0-33" id="h72-0-33" class="d">-        consumer: (HookAdapter) -&gt; Unit
</a><a href="#h72-0-34" id="h72-0-34" class="i">+        crossinline consumer: (HookAdapter) -&gt; Unit
</a>     ): Set&lt;XC_MethodHook.Unhook&gt; = hook(clazz, methodName, stage, { true }, consumer)
 
<a href="#h72-0-37" id="h72-0-37" class="d">-    fun hook(
</a><a href="#h72-0-38" id="h72-0-38" class="i">+    inline fun hook(
</a>         clazz: Class&lt;*&gt;,
         methodName: String,
         stage: HookStage,
<a href="#h72-0-42" id="h72-0-42" class="d">-        filter: (HookAdapter) -&gt; Boolean,
</a><a href="#h72-0-43" id="h72-0-43" class="d">-        consumer: (HookAdapter) -&gt; Unit
</a><a href="#h72-0-44" id="h72-0-44" class="i">+        crossinline filter: (HookAdapter) -&gt; Boolean,
</a><a href="#h72-0-45" id="h72-0-45" class="i">+        crossinline consumer: (HookAdapter) -&gt; Unit
</a>     ): Set&lt;XC_MethodHook.Unhook&gt; = XposedBridge.hookAllMethods(clazz, methodName, newMethodHook(stage, consumer, filter))
 
<a href="#h72-0-48" id="h72-0-48" class="d">-    fun hook(
</a><a href="#h72-0-49" id="h72-0-49" class="i">+    inline fun hook(
</a>         member: Member,
         stage: HookStage,
<a href="#h72-0-52" id="h72-0-52" class="d">-        consumer: (HookAdapter) -&gt; Unit
</a><a href="#h72-0-53" id="h72-0-53" class="i">+        crossinline consumer: (HookAdapter) -&gt; Unit
</a>     ): XC_MethodHook.Unhook {
         return hook(member, stage, { true }, consumer)
     }
 
<a href="#h72-0-58" id="h72-0-58" class="d">-    fun hook(
</a><a href="#h72-0-59" id="h72-0-59" class="i">+    inline fun hook(
</a>         member: Member,
         stage: HookStage,
<a href="#h72-0-62" id="h72-0-62" class="d">-        filter: ((HookAdapter) -&gt; Boolean),
</a><a href="#h72-0-63" id="h72-0-63" class="d">-        consumer: (HookAdapter) -&gt; Unit
</a><a href="#h72-0-64" id="h72-0-64" class="i">+        crossinline filter: ((HookAdapter) -&gt; Boolean),
</a><a href="#h72-0-65" id="h72-0-65" class="i">+        crossinline consumer: (HookAdapter) -&gt; Unit
</a>     ): XC_MethodHook.Unhook {
         return XposedBridge.hookMethod(member, newMethodHook(stage, consumer, filter))
     }
 
 
<a href="#h72-0-71" id="h72-0-71" class="d">-    fun hookConstructor(
</a><a href="#h72-0-72" id="h72-0-72" class="i">+    inline fun hookConstructor(
</a>         clazz: Class&lt;*&gt;,
         stage: HookStage,
<a href="#h72-0-75" id="h72-0-75" class="d">-        consumer: (HookAdapter) -&gt; Unit
</a><a href="#h72-0-76" id="h72-0-76" class="i">+        crossinline consumer: (HookAdapter) -&gt; Unit
</a>     ) {
         XposedBridge.hookAllConstructors(clazz, newMethodHook(stage, consumer))
     }
 
<a href="#h72-0-81" id="h72-0-81" class="d">-    fun hookConstructor(
</a><a href="#h72-0-82" id="h72-0-82" class="i">+    inline fun hookConstructor(
</a>         clazz: Class&lt;*&gt;,
         stage: HookStage,
<a href="#h72-0-85" id="h72-0-85" class="d">-        filter: ((HookAdapter) -&gt; Boolean),
</a><a href="#h72-0-86" id="h72-0-86" class="d">-        consumer: (HookAdapter) -&gt; Unit
</a><a href="#h72-0-87" id="h72-0-87" class="i">+        crossinline filter: ((HookAdapter) -&gt; Boolean),
</a><a href="#h72-0-88" id="h72-0-88" class="i">+        crossinline consumer: (HookAdapter) -&gt; Unit
</a>     ) {
         XposedBridge.hookAllConstructors(clazz, newMethodHook(stage, consumer, filter))
     }
 
<a href="#h72-0-93" id="h72-0-93" class="d">-    fun hookObjectMethod(
</a><a href="#h72-0-94" id="h72-0-94" class="i">+    inline fun hookObjectMethod(
</a>         clazz: Class&lt;*&gt;,
         instance: Any,
         methodName: String,
         stage: HookStage,
<a href="#h72-0-99" id="h72-0-99" class="d">-        hookConsumer: (HookAdapter) -&gt; Unit
</a><a href="#h72-0-100" id="h72-0-100" class="i">+        crossinline hookConsumer: (HookAdapter) -&gt; Unit
</a>     ) {
         val unhooks: MutableSet&lt;XC_MethodHook.Unhook&gt; = HashSet()
         hook(clazz, methodName, stage) { param-&gt;
<a href="#h72-1" id="h72-1" class="h">@@ -92,11 +88,11 @@ object Hooker {
</a>         }.also { unhooks.addAll(it) }
     }
 
<a href="#h72-1-3" id="h72-1-3" class="d">-    fun ephemeralHook(
</a><a href="#h72-1-4" id="h72-1-4" class="i">+    inline fun ephemeralHook(
</a>         clazz: Class&lt;*&gt;,
         methodName: String,
         stage: HookStage,
<a href="#h72-1-8" id="h72-1-8" class="d">-        hookConsumer: (HookAdapter) -&gt; Unit
</a><a href="#h72-1-9" id="h72-1-9" class="i">+        crossinline hookConsumer: (HookAdapter) -&gt; Unit
</a>     ) {
         val unhooks: MutableSet&lt;XC_MethodHook.Unhook&gt; = HashSet()
         hook(clazz, methodName, stage) { param-&gt;
<a href="#h72-2" id="h72-2" class="h">@@ -105,12 +101,12 @@ object Hooker {
</a>         }.also { unhooks.addAll(it) }
     }
 
<a href="#h72-2-3" id="h72-2-3" class="d">-    fun ephemeralHookObjectMethod(
</a><a href="#h72-2-4" id="h72-2-4" class="i">+    inline fun ephemeralHookObjectMethod(
</a>         clazz: Class&lt;*&gt;,
         instance: Any,
         methodName: String,
         stage: HookStage,
<a href="#h72-2-9" id="h72-2-9" class="d">-        hookConsumer: (HookAdapter) -&gt; Unit
</a><a href="#h72-2-10" id="h72-2-10" class="i">+        crossinline hookConsumer: (HookAdapter) -&gt; Unit
</a>     ) {
         val unhooks: MutableSet&lt;XC_MethodHook.Unhook&gt; = HashSet()
         hook(clazz, methodName, stage) { param-&gt;
<a href="#h72-3" id="h72-3" class="h">@@ -121,37 +117,37 @@ object Hooker {
</a>     }
 }
 
<a href="#h72-3-3" id="h72-3-3" class="d">-fun Class&lt;*&gt;.hookConstructor(
</a><a href="#h72-3-4" id="h72-3-4" class="i">+inline fun Class&lt;*&gt;.hookConstructor(
</a>     stage: HookStage,
<a href="#h72-3-6" id="h72-3-6" class="d">-    consumer: (HookAdapter) -&gt; Unit
</a><a href="#h72-3-7" id="h72-3-7" class="i">+    crossinline consumer: (HookAdapter) -&gt; Unit
</a> ) = Hooker.hookConstructor(this, stage, consumer)
 
<a href="#h72-3-10" id="h72-3-10" class="d">-fun Class&lt;*&gt;.hookConstructor(
</a><a href="#h72-3-11" id="h72-3-11" class="i">+inline fun Class&lt;*&gt;.hookConstructor(
</a>     stage: HookStage,
<a href="#h72-3-13" id="h72-3-13" class="d">-    filter: ((HookAdapter) -&gt; Boolean),
</a><a href="#h72-3-14" id="h72-3-14" class="d">-    consumer: (HookAdapter) -&gt; Unit
</a><a href="#h72-3-15" id="h72-3-15" class="i">+    crossinline filter: ((HookAdapter) -&gt; Boolean),
</a><a href="#h72-3-16" id="h72-3-16" class="i">+    crossinline consumer: (HookAdapter) -&gt; Unit
</a> ) = Hooker.hookConstructor(this, stage, filter, consumer)
 
<a href="#h72-3-19" id="h72-3-19" class="d">-fun Class&lt;*&gt;.hook(
</a><a href="#h72-3-20" id="h72-3-20" class="i">+inline fun Class&lt;*&gt;.hook(
</a>     methodName: String,
     stage: HookStage,
<a href="#h72-3-23" id="h72-3-23" class="d">-    consumer: (HookAdapter) -&gt; Unit
</a><a href="#h72-3-24" id="h72-3-24" class="i">+    crossinline consumer: (HookAdapter) -&gt; Unit
</a> ): Set&lt;XC_MethodHook.Unhook&gt; = Hooker.hook(this, methodName, stage, consumer)
 
<a href="#h72-3-27" id="h72-3-27" class="d">-fun Class&lt;*&gt;.hook(
</a><a href="#h72-3-28" id="h72-3-28" class="i">+inline fun Class&lt;*&gt;.hook(
</a>     methodName: String,
     stage: HookStage,
<a href="#h72-3-31" id="h72-3-31" class="d">-    filter: (HookAdapter) -&gt; Boolean,
</a><a href="#h72-3-32" id="h72-3-32" class="d">-    consumer: (HookAdapter) -&gt; Unit
</a><a href="#h72-3-33" id="h72-3-33" class="i">+    crossinline filter: (HookAdapter) -&gt; Boolean,
</a><a href="#h72-3-34" id="h72-3-34" class="i">+    crossinline consumer: (HookAdapter) -&gt; Unit
</a> ): Set&lt;XC_MethodHook.Unhook&gt; = Hooker.hook(this, methodName, stage, filter, consumer)
 
<a href="#h72-3-37" id="h72-3-37" class="d">-fun Member.hook(
</a><a href="#h72-3-38" id="h72-3-38" class="i">+inline fun Member.hook(
</a>     stage: HookStage,
<a href="#h72-3-40" id="h72-3-40" class="d">-    consumer: (HookAdapter) -&gt; Unit
</a><a href="#h72-3-41" id="h72-3-41" class="i">+    crossinline consumer: (HookAdapter) -&gt; Unit
</a> ): XC_MethodHook.Unhook = Hooker.hook(this, stage, consumer)
 
<a href="#h72-3-44" id="h72-3-44" class="d">-fun Member.hook(
</a><a href="#h72-3-45" id="h72-3-45" class="i">+inline fun Member.hook(
</a>     stage: HookStage,
<a href="#h72-3-47" id="h72-3-47" class="d">-    filter: ((HookAdapter) -&gt; Boolean),
</a><a href="#h72-3-48" id="h72-3-48" class="d">-    consumer: (HookAdapter) -&gt; Unit
</a><a href="#h72-3-49" id="h72-3-49" class="i">+    crossinline filter: ((HookAdapter) -&gt; Boolean),
</a><a href="#h72-3-50" id="h72-3-50" class="i">+    crossinline consumer: (HookAdapter) -&gt; Unit
</a> ): XC_MethodHook.Unhook = Hooker.hook(this, stage, filter, consumer) 
\ No newline at end of file
<b>diff --git a/<a id="h73" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/manager/impl/ConfigManager.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/manager/impl/ConfigManager.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/manager/impl/ConfigManager.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/manager/impl/ConfigManager.kt</a></b>
<a href="#h73-0" id="h73-0" class="h">@@ -3,7 +3,7 @@ package me.rhunk.snapenhance.manager.impl
</a> import com.google.gson.JsonObject
 import me.rhunk.snapenhance.Logger
 import me.rhunk.snapenhance.ModContext
<a href="#h73-0-3" id="h73-0-3" class="d">-import me.rhunk.snapenhance.bridge.common.impl.file.BridgeFileType
</a><a href="#h73-0-4" id="h73-0-4" class="i">+import me.rhunk.snapenhance.bridge.types.BridgeFileType
</a> import me.rhunk.snapenhance.config.ConfigAccessor
 import me.rhunk.snapenhance.config.ConfigProperty
 import me.rhunk.snapenhance.manager.Manager
<b>diff --git a/<a id="h74" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/manager/impl/FeatureManager.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/manager/impl/FeatureManager.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/manager/impl/FeatureManager.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/manager/impl/FeatureManager.kt</a></b>
<a href="#h74-0" id="h74-0" class="h">@@ -11,35 +11,37 @@ import me.rhunk.snapenhance.features.impl.downloader.AntiAutoDownload
</a> import me.rhunk.snapenhance.features.impl.downloader.MediaDownloader
 import me.rhunk.snapenhance.features.impl.experiments.AmoledDarkMode
 import me.rhunk.snapenhance.features.impl.experiments.AppPasscode
<a href="#h74-0-3" id="h74-0-3" class="i">+import me.rhunk.snapenhance.features.impl.experiments.DeviceSpooferHook
</a> import me.rhunk.snapenhance.features.impl.experiments.InfiniteStoryBoost
 import me.rhunk.snapenhance.features.impl.experiments.MeoPasscodeBypass
 import me.rhunk.snapenhance.features.impl.experiments.UnlimitedMultiSnap
<a href="#h74-0-7" id="h74-0-7" class="i">+import me.rhunk.snapenhance.features.impl.privacy.DisableMetrics
</a><a href="#h74-0-8" id="h74-0-8" class="i">+import me.rhunk.snapenhance.features.impl.privacy.PreventMessageSending
</a><a href="#h74-0-9" id="h74-0-9" class="i">+import me.rhunk.snapenhance.features.impl.spying.AnonymousStoryViewing
</a><a href="#h74-0-10" id="h74-0-10" class="i">+import me.rhunk.snapenhance.features.impl.spying.MessageLogger
</a><a href="#h74-0-11" id="h74-0-11" class="i">+import me.rhunk.snapenhance.features.impl.spying.PreventReadReceipts
</a><a href="#h74-0-12" id="h74-0-12" class="i">+import me.rhunk.snapenhance.features.impl.spying.StealthMode
</a> import me.rhunk.snapenhance.features.impl.tweaks.AntiAutoSave
 import me.rhunk.snapenhance.features.impl.tweaks.AutoSave
<a href="#h74-0-15" id="h74-0-15" class="i">+import me.rhunk.snapenhance.features.impl.tweaks.CameraTweaks
</a> import me.rhunk.snapenhance.features.impl.tweaks.DisableVideoLengthRestriction
 import me.rhunk.snapenhance.features.impl.tweaks.GalleryMediaSendOverride
<a href="#h74-0-18" id="h74-0-18" class="i">+import me.rhunk.snapenhance.features.impl.tweaks.GooglePlayServicesDialogs
</a> import me.rhunk.snapenhance.features.impl.tweaks.LocationSpoofer
 import me.rhunk.snapenhance.features.impl.tweaks.MediaQualityLevelOverride
 import me.rhunk.snapenhance.features.impl.tweaks.Notifications
 import me.rhunk.snapenhance.features.impl.tweaks.SnapchatPlus
 import me.rhunk.snapenhance.features.impl.tweaks.UnlimitedSnapViewTime
<a href="#h74-0-24" id="h74-0-24" class="d">-import me.rhunk.snapenhance.features.impl.privacy.DisableMetrics
</a><a href="#h74-0-25" id="h74-0-25" class="d">-import me.rhunk.snapenhance.features.impl.privacy.PreventMessageSending
</a><a href="#h74-0-26" id="h74-0-26" class="d">-import me.rhunk.snapenhance.features.impl.spying.AnonymousStoryViewing
</a><a href="#h74-0-27" id="h74-0-27" class="d">-import me.rhunk.snapenhance.features.impl.spying.MessageLogger
</a><a href="#h74-0-28" id="h74-0-28" class="d">-import me.rhunk.snapenhance.features.impl.spying.PreventReadReceipts
</a><a href="#h74-0-29" id="h74-0-29" class="d">-import me.rhunk.snapenhance.features.impl.spying.StealthMode
</a><a href="#h74-0-30" id="h74-0-30" class="d">-import me.rhunk.snapenhance.features.impl.tweaks.CameraTweaks
</a> import me.rhunk.snapenhance.features.impl.ui.PinConversations
 import me.rhunk.snapenhance.features.impl.ui.StartupPageOverride
 import me.rhunk.snapenhance.features.impl.ui.UITweaks
<a href="#h74-0-34" id="h74-0-34" class="d">-import me.rhunk.snapenhance.ui.menu.impl.MenuViewInjector
</a> import me.rhunk.snapenhance.manager.Manager
<a href="#h74-0-36" id="h74-0-36" class="i">+import me.rhunk.snapenhance.ui.menu.impl.MenuViewInjector
</a> import java.util.concurrent.Executors
 import kotlin.reflect.KClass
 
 class FeatureManager(private val context: ModContext) : Manager {
<a href="#h74-0-41" id="h74-0-41" class="d">-    private val asyncLoadExecutorService = Executors.newCachedThreadPool()
</a><a href="#h74-0-42" id="h74-0-42" class="i">+    private val asyncLoadExecutorService = Executors.newFixedThreadPool(5)
</a>     private val features = mutableListOf&lt;Feature&gt;()
 
     private fun register(featureClass: KClass&lt;out Feature&gt;) {
<a href="#h74-1" id="h74-1" class="h">@@ -88,7 +90,9 @@ class FeatureManager(private val context: ModContext) : Manager {
</a>         register(AmoledDarkMode::class)
         register(PinConversations::class)
         register(UnlimitedMultiSnap::class)
<a href="#h74-1-3" id="h74-1-3" class="i">+        register(DeviceSpooferHook::class)
</a>         register(StartupPageOverride::class)
<a href="#h74-1-5" id="h74-1-5" class="i">+        register(GooglePlayServicesDialogs::class)
</a> 
         initializeFeatures()
     }
<b>diff --git a/<a id="h75" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/manager/impl/MappingManager.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/manager/impl/MappingManager.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/manager/impl/MappingManager.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/manager/impl/MappingManager.kt</a></b>
<a href="#h75-0" id="h75-0" class="h">@@ -2,45 +2,44 @@ package me.rhunk.snapenhance.manager.impl
</a> 
 import android.app.AlertDialog
 import com.google.gson.JsonElement
<a href="#h75-0-3" id="h75-0-3" class="d">-import com.google.gson.JsonObject
</a> import com.google.gson.JsonParser
<a href="#h75-0-5" id="h75-0-5" class="d">-import kotlinx.coroutines.Job
</a><a href="#h75-0-6" id="h75-0-6" class="d">-import kotlinx.coroutines.joinAll
</a><a href="#h75-0-7" id="h75-0-7" class="d">-import kotlinx.coroutines.launch
</a><a href="#h75-0-8" id="h75-0-8" class="d">-import kotlinx.coroutines.runBlocking
</a> import me.rhunk.snapenhance.Constants
 import me.rhunk.snapenhance.Logger
 import me.rhunk.snapenhance.ModContext
<a href="#h75-0-12" id="h75-0-12" class="d">-import me.rhunk.snapenhance.R
</a><a href="#h75-0-13" id="h75-0-13" class="d">-import me.rhunk.snapenhance.bridge.common.impl.file.BridgeFileType
</a><a href="#h75-0-14" id="h75-0-14" class="i">+import me.rhunk.snapenhance.bridge.types.BridgeFileType
</a> import me.rhunk.snapenhance.manager.Manager
<a href="#h75-0-16" id="h75-0-16" class="d">-import me.rhunk.snapenhance.mapping.Mapper
</a><a href="#h75-0-17" id="h75-0-17" class="d">-import me.rhunk.snapenhance.mapping.impl.BCryptClassMapper
</a><a href="#h75-0-18" id="h75-0-18" class="d">-import me.rhunk.snapenhance.mapping.impl.CallbackMapper
</a><a href="#h75-0-19" id="h75-0-19" class="d">-import me.rhunk.snapenhance.mapping.impl.DefaultMediaItemMapper
</a><a href="#h75-0-20" id="h75-0-20" class="d">-import me.rhunk.snapenhance.mapping.impl.EnumMapper
</a><a href="#h75-0-21" id="h75-0-21" class="d">-import me.rhunk.snapenhance.mapping.impl.OperaPageViewControllerMapper
</a><a href="#h75-0-22" id="h75-0-22" class="d">-import me.rhunk.snapenhance.mapping.impl.PlatformAnalyticsCreatorMapper
</a><a href="#h75-0-23" id="h75-0-23" class="d">-import me.rhunk.snapenhance.mapping.impl.PlusSubscriptionMapper
</a><a href="#h75-0-24" id="h75-0-24" class="d">-import me.rhunk.snapenhance.mapping.impl.ScCameraSettingsMapper
</a><a href="#h75-0-25" id="h75-0-25" class="d">-import me.rhunk.snapenhance.mapping.impl.StoryBoostStateMapper
</a><a href="#h75-0-26" id="h75-0-26" class="d">-import me.rhunk.snapenhance.util.getObjectField
</a><a href="#h75-0-27" id="h75-0-27" class="i">+import me.rhunk.snapenhance.ui.ViewAppearanceHelper
</a><a href="#h75-0-28" id="h75-0-28" class="i">+import me.rhunk.snapmapper.Mapper
</a><a href="#h75-0-29" id="h75-0-29" class="i">+import me.rhunk.snapmapper.impl.BCryptClassMapper
</a><a href="#h75-0-30" id="h75-0-30" class="i">+import me.rhunk.snapmapper.impl.CallbackMapper
</a><a href="#h75-0-31" id="h75-0-31" class="i">+import me.rhunk.snapmapper.impl.DefaultMediaItemMapper
</a><a href="#h75-0-32" id="h75-0-32" class="i">+import me.rhunk.snapmapper.impl.EnumMapper
</a><a href="#h75-0-33" id="h75-0-33" class="i">+import me.rhunk.snapmapper.impl.FriendsFeedEventDispatcherMapper
</a><a href="#h75-0-34" id="h75-0-34" class="i">+import me.rhunk.snapmapper.impl.MediaQualityLevelProviderMapper
</a><a href="#h75-0-35" id="h75-0-35" class="i">+import me.rhunk.snapmapper.impl.OperaPageViewControllerMapper
</a><a href="#h75-0-36" id="h75-0-36" class="i">+import me.rhunk.snapmapper.impl.PlatformAnalyticsCreatorMapper
</a><a href="#h75-0-37" id="h75-0-37" class="i">+import me.rhunk.snapmapper.impl.PlusSubscriptionMapper
</a><a href="#h75-0-38" id="h75-0-38" class="i">+import me.rhunk.snapmapper.impl.ScCameraSettingsMapper
</a><a href="#h75-0-39" id="h75-0-39" class="i">+import me.rhunk.snapmapper.impl.StoryBoostStateMapper
</a> import java.nio.charset.StandardCharsets
 import java.util.concurrent.ConcurrentHashMap
<a href="#h75-0-42" id="h75-0-42" class="i">+import kotlin.system.measureTimeMillis
</a> 
 @Suppress(&quot;UNCHECKED_CAST&quot;)
 class MappingManager(private val context: ModContext) : Manager {
<a href="#h75-0-46" id="h75-0-46" class="d">-    private val mappers = mutableListOf&lt;Mapper&gt;().apply {
</a><a href="#h75-0-47" id="h75-0-47" class="d">-        add(CallbackMapper())
</a><a href="#h75-0-48" id="h75-0-48" class="d">-        add(EnumMapper())
</a><a href="#h75-0-49" id="h75-0-49" class="d">-        add(OperaPageViewControllerMapper())
</a><a href="#h75-0-50" id="h75-0-50" class="d">-        add(PlusSubscriptionMapper())
</a><a href="#h75-0-51" id="h75-0-51" class="d">-        add(DefaultMediaItemMapper())
</a><a href="#h75-0-52" id="h75-0-52" class="d">-        add(BCryptClassMapper())
</a><a href="#h75-0-53" id="h75-0-53" class="d">-        add(PlatformAnalyticsCreatorMapper())
</a><a href="#h75-0-54" id="h75-0-54" class="d">-        add(ScCameraSettingsMapper())
</a><a href="#h75-0-55" id="h75-0-55" class="d">-        add(StoryBoostStateMapper())
</a><a href="#h75-0-56" id="h75-0-56" class="d">-    }
</a><a href="#h75-0-57" id="h75-0-57" class="i">+    private val mappers = arrayOf(
</a><a href="#h75-0-58" id="h75-0-58" class="i">+        BCryptClassMapper::class,
</a><a href="#h75-0-59" id="h75-0-59" class="i">+        CallbackMapper::class,
</a><a href="#h75-0-60" id="h75-0-60" class="i">+        DefaultMediaItemMapper::class,
</a><a href="#h75-0-61" id="h75-0-61" class="i">+        MediaQualityLevelProviderMapper::class,
</a><a href="#h75-0-62" id="h75-0-62" class="i">+        EnumMapper::class,
</a><a href="#h75-0-63" id="h75-0-63" class="i">+        OperaPageViewControllerMapper::class,
</a><a href="#h75-0-64" id="h75-0-64" class="i">+        PlatformAnalyticsCreatorMapper::class,
</a><a href="#h75-0-65" id="h75-0-65" class="i">+        PlusSubscriptionMapper::class,
</a><a href="#h75-0-66" id="h75-0-66" class="i">+        ScCameraSettingsMapper::class,
</a><a href="#h75-0-67" id="h75-0-67" class="i">+        StoryBoostStateMapper::class,
</a><a href="#h75-0-68" id="h75-0-68" class="i">+        FriendsFeedEventDispatcherMapper::class
</a><a href="#h75-0-69" id="h75-0-69" class="i">+    )
</a> 
     private val mappings = ConcurrentHashMap&lt;String, Any&gt;()
     val areMappingsLoaded: Boolean
<a href="#h75-1" id="h75-1" class="h">@@ -69,7 +68,7 @@ class MappingManager(private val context: ModContext) : Manager {
</a>             return
         }
         context.runOnUiThread {
<a href="#h75-1-3" id="h75-1-3" class="d">-            val statusDialogBuilder = AlertDialog.Builder(context.mainActivity, AlertDialog.THEME_DEVICE_DEFAULT_DARK)
</a><a href="#h75-1-4" id="h75-1-4" class="i">+            val statusDialogBuilder = ViewAppearanceHelper.newAlertDialogBuilder(context.mainActivity)
</a>                 .setMessage(&quot;Generating mappings, please wait...&quot;)
                 .setCancelable(false)
                 .setView(android.widget.ProgressBar(context.mainActivity).apply {
<a href="#h75-2" id="h75-2" class="h">@@ -127,70 +126,27 @@ class MappingManager(private val context: ModContext) : Manager {
</a>         }
     }
 
<a href="#h75-2-3" id="h75-2-3" class="d">-    private fun executeMappers(classes: List&lt;Class&lt;*&gt;&gt;) = runBlocking {
</a><a href="#h75-2-4" id="h75-2-4" class="d">-        val jobs = mutableListOf&lt;Job&gt;()
</a><a href="#h75-2-5" id="h75-2-5" class="d">-        mappers.forEach { mapper -&gt;
</a><a href="#h75-2-6" id="h75-2-6" class="d">-            mapper.context = context
</a><a href="#h75-2-7" id="h75-2-7" class="d">-            launch {
</a><a href="#h75-2-8" id="h75-2-8" class="d">-                runCatching {
</a><a href="#h75-2-9" id="h75-2-9" class="d">-                    mapper.useClasses(context.androidContext.classLoader, classes, mappings)
</a><a href="#h75-2-10" id="h75-2-10" class="d">-                }.onFailure {
</a><a href="#h75-2-11" id="h75-2-11" class="d">-                    Logger.xposedLog(&quot;Failed to execute mapper ${mapper.javaClass.simpleName}&quot;, it)
</a><a href="#h75-2-12" id="h75-2-12" class="d">-                }
</a><a href="#h75-2-13" id="h75-2-13" class="d">-            }.also { jobs.add(it) }
</a><a href="#h75-2-14" id="h75-2-14" class="d">-        }
</a><a href="#h75-2-15" id="h75-2-15" class="d">-        jobs.joinAll()
</a><a href="#h75-2-16" id="h75-2-16" class="d">-    }
</a><a href="#h75-2-17" id="h75-2-17" class="d">-
</a><a href="#h75-2-18" id="h75-2-18" class="d">-    @Suppress(&quot;UNCHECKED_CAST&quot;, &quot;DEPRECATION&quot;)
</a><a href="#h75-2-19" id="h75-2-19" class="i">+    @Suppress(&quot;DEPRECATION&quot;)
</a>     private fun refresh() {
<a href="#h75-2-21" id="h75-2-21" class="d">-        val classes: MutableList&lt;Class&lt;*&gt;&gt; = ArrayList()
</a><a href="#h75-2-22" id="h75-2-22" class="d">-
</a><a href="#h75-2-23" id="h75-2-23" class="d">-        val classLoader = context.androidContext.classLoader
</a><a href="#h75-2-24" id="h75-2-24" class="d">-        val dexPathList = classLoader.getObjectField(&quot;pathList&quot;)!!
</a><a href="#h75-2-25" id="h75-2-25" class="d">-        val dexElements = dexPathList.getObjectField(&quot;dexElements&quot;) as Array&lt;Any&gt;
</a><a href="#h75-2-26" id="h75-2-26" class="d">-
</a><a href="#h75-2-27" id="h75-2-27" class="d">-        dexElements.forEach { dexElement: Any -&gt;
</a><a href="#h75-2-28" id="h75-2-28" class="d">-            (dexElement.getObjectField(&quot;dexFile&quot;) as dalvik.system.DexFile?)?.apply {
</a><a href="#h75-2-29" id="h75-2-29" class="d">-                entries().toList().forEach fileList@{ className -&gt;
</a><a href="#h75-2-30" id="h75-2-30" class="d">-                    //ignore classes without a dot in them
</a><a href="#h75-2-31" id="h75-2-31" class="d">-                    if (className.contains(&quot;.&quot;) &amp;&amp; !className.startsWith(&quot;com.snap&quot;)) return@fileList
</a><a href="#h75-2-32" id="h75-2-32" class="d">-                    runCatching {
</a><a href="#h75-2-33" id="h75-2-33" class="d">-                        classLoader.loadClass(className)?.let {
</a><a href="#h75-2-34" id="h75-2-34" class="d">-                            //force load fields to avoid ClassNotFoundExceptions when executing mappers
</a><a href="#h75-2-35" id="h75-2-35" class="d">-                            it.declaredFields
</a><a href="#h75-2-36" id="h75-2-36" class="d">-                            classes.add(it)
</a><a href="#h75-2-37" id="h75-2-37" class="d">-                        }
</a><a href="#h75-2-38" id="h75-2-38" class="d">-                    }.onFailure {
</a><a href="#h75-2-39" id="h75-2-39" class="d">-                        Logger.debug(&quot;Failed to load class $className&quot;)
</a><a href="#h75-2-40" id="h75-2-40" class="d">-                    }
</a><a href="#h75-2-41" id="h75-2-41" class="d">-                }
</a><a href="#h75-2-42" id="h75-2-42" class="d">-            }
</a><a href="#h75-2-43" id="h75-2-43" class="i">+        val mapper = Mapper(*mappers)
</a><a href="#h75-2-44" id="h75-2-44" class="i">+
</a><a href="#h75-2-45" id="h75-2-45" class="i">+        runCatching {
</a><a href="#h75-2-46" id="h75-2-46" class="i">+            mapper.loadApk(context.androidContext.packageManager.getApplicationInfo(
</a><a href="#h75-2-47" id="h75-2-47" class="i">+                Constants.SNAPCHAT_PACKAGE_NAME,
</a><a href="#h75-2-48" id="h75-2-48" class="i">+                0
</a><a href="#h75-2-49" id="h75-2-49" class="i">+            ).sourceDir)
</a><a href="#h75-2-50" id="h75-2-50" class="i">+        }.onFailure {
</a><a href="#h75-2-51" id="h75-2-51" class="i">+            throw Exception(&quot;Failed to load APK&quot;, it)
</a>         }
 
<a href="#h75-2-54" id="h75-2-54" class="d">-        executeMappers(classes)
</a><a href="#h75-2-55" id="h75-2-55" class="d">-        write()
</a><a href="#h75-2-56" id="h75-2-56" class="d">-    }
</a><a href="#h75-2-57" id="h75-2-57" class="d">-
</a><a href="#h75-2-58" id="h75-2-58" class="d">-    private fun write() {
</a><a href="#h75-2-59" id="h75-2-59" class="d">-        val mappingsObject = JsonObject()
</a><a href="#h75-2-60" id="h75-2-60" class="d">-        mappingsObject.addProperty(&quot;snap_build_number&quot;, snapBuildNumber)
</a><a href="#h75-2-61" id="h75-2-61" class="d">-        mappings.forEach { (key, value) -&gt;
</a><a href="#h75-2-62" id="h75-2-62" class="d">-            if (value is List&lt;*&gt;) {
</a><a href="#h75-2-63" id="h75-2-63" class="d">-                mappingsObject.add(key, context.gson.toJsonTree(value))
</a><a href="#h75-2-64" id="h75-2-64" class="d">-                return@forEach
</a><a href="#h75-2-65" id="h75-2-65" class="i">+        measureTimeMillis {
</a><a href="#h75-2-66" id="h75-2-66" class="i">+            val result = mapper.start().apply {
</a><a href="#h75-2-67" id="h75-2-67" class="i">+                addProperty(&quot;snap_build_number&quot;, snapBuildNumber)
</a>             }
<a href="#h75-2-69" id="h75-2-69" class="d">-            if (value is Map&lt;*, *&gt;) {
</a><a href="#h75-2-70" id="h75-2-70" class="d">-                mappingsObject.add(key, context.gson.toJsonTree(value))
</a><a href="#h75-2-71" id="h75-2-71" class="d">-                return@forEach
</a><a href="#h75-2-72" id="h75-2-72" class="d">-            }
</a><a href="#h75-2-73" id="h75-2-73" class="d">-            mappingsObject.addProperty(key, value.toString())
</a><a href="#h75-2-74" id="h75-2-74" class="i">+            context.bridgeClient.writeFile(BridgeFileType.MAPPINGS, result.toString().toByteArray())
</a><a href="#h75-2-75" id="h75-2-75" class="i">+        }.also {
</a><a href="#h75-2-76" id="h75-2-76" class="i">+            Logger.xposedLog(&quot;Generated mappings in $it ms&quot;)
</a>         }
<a href="#h75-2-78" id="h75-2-78" class="d">-
</a><a href="#h75-2-79" id="h75-2-79" class="d">-        context.bridgeClient.writeFile(
</a><a href="#h75-2-80" id="h75-2-80" class="d">-            BridgeFileType.MAPPINGS,
</a><a href="#h75-2-81" id="h75-2-81" class="d">-            mappingsObject.toString().toByteArray()
</a><a href="#h75-2-82" id="h75-2-82" class="d">-        )
</a>     }
 
     fun getMappedObject(key: String): Any {
<a href="#h75-3" id="h75-3" class="h">@@ -200,6 +156,10 @@ class MappingManager(private val context: ModContext) : Manager {
</a>         throw Exception(&quot;No mapping found for $key&quot;)
     }
 
<a href="#h75-3-3" id="h75-3-3" class="i">+    fun getMappedObjectNullable(key: String): Any? {
</a><a href="#h75-3-4" id="h75-3-4" class="i">+        return mappings[key]
</a><a href="#h75-3-5" id="h75-3-5" class="i">+    }
</a><a href="#h75-3-6" id="h75-3-6" class="i">+
</a>     fun getMappedClass(className: String): Class&lt;*&gt; {
         return context.androidContext.classLoader.loadClass(getMappedObject(className) as String)
     }
<b>diff --git a/<a id="h76" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/mapping/Mapper.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/mapping/Mapper.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/mapping/Mapper.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/mapping/Mapper.kt</a></b>
<a href="#h76-0" id="h76-0" class="h">@@ -1,13 +0,0 @@
</a><a href="#h76-0-0" id="h76-0-0" class="d">-package me.rhunk.snapenhance.mapping
</a><a href="#h76-0-1" id="h76-0-1" class="d">-
</a><a href="#h76-0-2" id="h76-0-2" class="d">-import me.rhunk.snapenhance.ModContext
</a><a href="#h76-0-3" id="h76-0-3" class="d">-
</a><a href="#h76-0-4" id="h76-0-4" class="d">-abstract class Mapper {
</a><a href="#h76-0-5" id="h76-0-5" class="d">-    lateinit var context: ModContext
</a><a href="#h76-0-6" id="h76-0-6" class="d">-
</a><a href="#h76-0-7" id="h76-0-7" class="d">-    abstract fun useClasses(
</a><a href="#h76-0-8" id="h76-0-8" class="d">-        classLoader: ClassLoader,
</a><a href="#h76-0-9" id="h76-0-9" class="d">-        classes: List&lt;Class&lt;*&gt;&gt;,
</a><a href="#h76-0-10" id="h76-0-10" class="d">-        mappings: MutableMap&lt;String, Any&gt;
</a><a href="#h76-0-11" id="h76-0-11" class="d">-    )
</a><a href="#h76-0-12" id="h76-0-12" class="d">-}
</a><b>diff --git a/<a id="h77" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/mapping/impl/BCryptClassMapper.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/mapping/impl/BCryptClassMapper.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/mapping/impl/BCryptClassMapper.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/mapping/impl/BCryptClassMapper.kt</a></b>
<a href="#h77-0" id="h77-0" class="h">@@ -1,26 +0,0 @@
</a><a href="#h77-0-0" id="h77-0-0" class="d">-package me.rhunk.snapenhance.mapping.impl
</a><a href="#h77-0-1" id="h77-0-1" class="d">-
</a><a href="#h77-0-2" id="h77-0-2" class="d">-import me.rhunk.snapenhance.mapping.Mapper
</a><a href="#h77-0-3" id="h77-0-3" class="d">-import java.lang.reflect.Modifier
</a><a href="#h77-0-4" id="h77-0-4" class="d">-
</a><a href="#h77-0-5" id="h77-0-5" class="d">-class BCryptClassMapper : Mapper() {
</a><a href="#h77-0-6" id="h77-0-6" class="d">-    override fun useClasses(
</a><a href="#h77-0-7" id="h77-0-7" class="d">-        classLoader: ClassLoader,
</a><a href="#h77-0-8" id="h77-0-8" class="d">-        classes: List&lt;Class&lt;*&gt;&gt;,
</a><a href="#h77-0-9" id="h77-0-9" class="d">-        mappings: MutableMap&lt;String, Any&gt;
</a><a href="#h77-0-10" id="h77-0-10" class="d">-    ) {
</a><a href="#h77-0-11" id="h77-0-11" class="d">-        for (clazz in classes) {
</a><a href="#h77-0-12" id="h77-0-12" class="d">-            if (!Modifier.isFinal(clazz.modifiers)) continue
</a><a href="#h77-0-13" id="h77-0-13" class="d">-            clazz.declaredFields.firstOrNull { it.type == IntArray::class.java &amp;&amp; Modifier.isStatic(it.modifiers)}?.let { field -&gt;
</a><a href="#h77-0-14" id="h77-0-14" class="d">-                val fieldData = field.get(null)
</a><a href="#h77-0-15" id="h77-0-15" class="d">-                if (fieldData !is IntArray) return@let
</a><a href="#h77-0-16" id="h77-0-16" class="d">-                if (fieldData.size != 18 || fieldData[0] != 608135816) return@let
</a><a href="#h77-0-17" id="h77-0-17" class="d">-                mappings[&quot;BCryptClass&quot;] = clazz.name
</a><a href="#h77-0-18" id="h77-0-18" class="d">-                mappings[&quot;BCryptClassHashMethod&quot;] = clazz.methods.first {
</a><a href="#h77-0-19" id="h77-0-19" class="d">-                    it.parameterTypes.size == 2 &amp;&amp; it.returnType == String::class.java &amp;&amp; it.parameterTypes[0] == String::class.java &amp;&amp; it.parameterTypes[1] == String::class.java
</a><a href="#h77-0-20" id="h77-0-20" class="d">-                }.name
</a><a href="#h77-0-21" id="h77-0-21" class="d">-                return
</a><a href="#h77-0-22" id="h77-0-22" class="d">-            }
</a><a href="#h77-0-23" id="h77-0-23" class="d">-        }
</a><a href="#h77-0-24" id="h77-0-24" class="d">-    }
</a><a href="#h77-0-25" id="h77-0-25" class="d">-}</a><a href="#h77-0-26" id="h77-0-26" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h78" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/mapping/impl/CallbackMapper.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/mapping/impl/CallbackMapper.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/mapping/impl/CallbackMapper.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/mapping/impl/CallbackMapper.kt</a></b>
<a href="#h78-0" id="h78-0" class="h">@@ -1,29 +0,0 @@
</a><a href="#h78-0-0" id="h78-0-0" class="d">-package me.rhunk.snapenhance.mapping.impl
</a><a href="#h78-0-1" id="h78-0-1" class="d">-
</a><a href="#h78-0-2" id="h78-0-2" class="d">-import me.rhunk.snapenhance.Logger.debug
</a><a href="#h78-0-3" id="h78-0-3" class="d">-import me.rhunk.snapenhance.mapping.Mapper
</a><a href="#h78-0-4" id="h78-0-4" class="d">-import java.lang.reflect.Method
</a><a href="#h78-0-5" id="h78-0-5" class="d">-import java.lang.reflect.Modifier
</a><a href="#h78-0-6" id="h78-0-6" class="d">-
</a><a href="#h78-0-7" id="h78-0-7" class="d">-class CallbackMapper : Mapper() {
</a><a href="#h78-0-8" id="h78-0-8" class="d">-    override fun useClasses(
</a><a href="#h78-0-9" id="h78-0-9" class="d">-        classLoader: ClassLoader,
</a><a href="#h78-0-10" id="h78-0-10" class="d">-        classes: List&lt;Class&lt;*&gt;&gt;,
</a><a href="#h78-0-11" id="h78-0-11" class="d">-        mappings: MutableMap&lt;String, Any&gt;
</a><a href="#h78-0-12" id="h78-0-12" class="d">-    ) {
</a><a href="#h78-0-13" id="h78-0-13" class="d">-        val callbackMappings = HashMap&lt;String, String&gt;()
</a><a href="#h78-0-14" id="h78-0-14" class="d">-        classes.forEach { clazz -&gt;
</a><a href="#h78-0-15" id="h78-0-15" class="d">-            val superClass = clazz.superclass ?: return@forEach
</a><a href="#h78-0-16" id="h78-0-16" class="d">-            if (!superClass.name.endsWith(&quot;Callback&quot;) || superClass.name.endsWith(&quot;\$Callback&quot;)) return@forEach
</a><a href="#h78-0-17" id="h78-0-17" class="d">-            if (!Modifier.isAbstract(superClass.modifiers)) return@forEach
</a><a href="#h78-0-18" id="h78-0-18" class="d">-
</a><a href="#h78-0-19" id="h78-0-19" class="d">-            if (superClass.declaredMethods.any { method: Method -&gt;
</a><a href="#h78-0-20" id="h78-0-20" class="d">-                    method.name == &quot;onError&quot;
</a><a href="#h78-0-21" id="h78-0-21" class="d">-                }) {
</a><a href="#h78-0-22" id="h78-0-22" class="d">-                callbackMappings[superClass.simpleName] = clazz.name
</a><a href="#h78-0-23" id="h78-0-23" class="d">-            }
</a><a href="#h78-0-24" id="h78-0-24" class="d">-        }
</a><a href="#h78-0-25" id="h78-0-25" class="d">-        debug(&quot;found &quot; + callbackMappings.size + &quot; callbacks&quot;)
</a><a href="#h78-0-26" id="h78-0-26" class="d">-        mappings[&quot;callbacks&quot;] = callbackMappings
</a><a href="#h78-0-27" id="h78-0-27" class="d">-    }
</a><a href="#h78-0-28" id="h78-0-28" class="d">-}
</a><b>diff --git a/<a id="h79" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/mapping/impl/DefaultMediaItemMapper.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/mapping/impl/DefaultMediaItemMapper.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/mapping/impl/DefaultMediaItemMapper.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/mapping/impl/DefaultMediaItemMapper.kt</a></b>
<a href="#h79-0" id="h79-0" class="h">@@ -1,24 +0,0 @@
</a><a href="#h79-0-0" id="h79-0-0" class="d">-package me.rhunk.snapenhance.mapping.impl
</a><a href="#h79-0-1" id="h79-0-1" class="d">-
</a><a href="#h79-0-2" id="h79-0-2" class="d">-import android.net.Uri
</a><a href="#h79-0-3" id="h79-0-3" class="d">-import me.rhunk.snapenhance.mapping.Mapper
</a><a href="#h79-0-4" id="h79-0-4" class="d">-import java.lang.reflect.Modifier
</a><a href="#h79-0-5" id="h79-0-5" class="d">-
</a><a href="#h79-0-6" id="h79-0-6" class="d">-class DefaultMediaItemMapper : Mapper() {
</a><a href="#h79-0-7" id="h79-0-7" class="d">-    override fun useClasses(
</a><a href="#h79-0-8" id="h79-0-8" class="d">-        classLoader: ClassLoader,
</a><a href="#h79-0-9" id="h79-0-9" class="d">-        classes: List&lt;Class&lt;*&gt;&gt;,
</a><a href="#h79-0-10" id="h79-0-10" class="d">-        mappings: MutableMap&lt;String, Any&gt;
</a><a href="#h79-0-11" id="h79-0-11" class="d">-    ) {
</a><a href="#h79-0-12" id="h79-0-12" class="d">-        for (clazz in classes) {
</a><a href="#h79-0-13" id="h79-0-13" class="d">-            if (clazz.superclass == null || !Modifier.isAbstract(clazz.superclass.modifiers)) continue
</a><a href="#h79-0-14" id="h79-0-14" class="d">-            if (clazz.superclass.interfaces.isEmpty() || clazz.superclass.interfaces[0] != Comparable::class.java) continue
</a><a href="#h79-0-15" id="h79-0-15" class="d">-            if (clazz.methods.none { it.returnType == Uri::class.java }) continue
</a><a href="#h79-0-16" id="h79-0-16" class="d">-
</a><a href="#h79-0-17" id="h79-0-17" class="d">-            val constructorParameters = clazz.constructors[0]?.parameterTypes ?: continue
</a><a href="#h79-0-18" id="h79-0-18" class="d">-            if (constructorParameters.size &lt; 6 || constructorParameters[5] != Long::class.javaPrimitiveType) continue
</a><a href="#h79-0-19" id="h79-0-19" class="d">-
</a><a href="#h79-0-20" id="h79-0-20" class="d">-            mappings[&quot;DefaultMediaItem&quot;] = clazz.name
</a><a href="#h79-0-21" id="h79-0-21" class="d">-        }
</a><a href="#h79-0-22" id="h79-0-22" class="d">-    }
</a><a href="#h79-0-23" id="h79-0-23" class="d">-}</a><a href="#h79-0-24" id="h79-0-24" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h80" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/mapping/impl/EnumMapper.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/mapping/impl/EnumMapper.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/mapping/impl/EnumMapper.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/mapping/impl/EnumMapper.kt</a></b>
<a href="#h80-0" id="h80-0" class="h">@@ -1,66 +0,0 @@
</a><a href="#h80-0-0" id="h80-0-0" class="d">-package me.rhunk.snapenhance.mapping.impl
</a><a href="#h80-0-1" id="h80-0-1" class="d">-
</a><a href="#h80-0-2" id="h80-0-2" class="d">-import me.rhunk.snapenhance.Logger.debug
</a><a href="#h80-0-3" id="h80-0-3" class="d">-import me.rhunk.snapenhance.mapping.Mapper
</a><a href="#h80-0-4" id="h80-0-4" class="d">-import java.lang.reflect.Method
</a><a href="#h80-0-5" id="h80-0-5" class="d">-import java.lang.reflect.Modifier
</a><a href="#h80-0-6" id="h80-0-6" class="d">-import java.util.Objects
</a><a href="#h80-0-7" id="h80-0-7" class="d">-
</a><a href="#h80-0-8" id="h80-0-8" class="d">-
</a><a href="#h80-0-9" id="h80-0-9" class="d">-class EnumMapper : Mapper() {
</a><a href="#h80-0-10" id="h80-0-10" class="d">-    override fun useClasses(
</a><a href="#h80-0-11" id="h80-0-11" class="d">-        classLoader: ClassLoader,
</a><a href="#h80-0-12" id="h80-0-12" class="d">-        classes: List&lt;Class&lt;*&gt;&gt;,
</a><a href="#h80-0-13" id="h80-0-13" class="d">-        mappings: MutableMap&lt;String, Any&gt;
</a><a href="#h80-0-14" id="h80-0-14" class="d">-    ) {
</a><a href="#h80-0-15" id="h80-0-15" class="d">-        val enumMappings = HashMap&lt;String, String&gt;()
</a><a href="#h80-0-16" id="h80-0-16" class="d">-        var enumQualityLevel: Class&lt;*&gt;? = null
</a><a href="#h80-0-17" id="h80-0-17" class="d">-
</a><a href="#h80-0-18" id="h80-0-18" class="d">-        //settings classes have an interface that extends Serializable and contains the getName method
</a><a href="#h80-0-19" id="h80-0-19" class="d">-        //this enum classes are used to store the settings values
</a><a href="#h80-0-20" id="h80-0-20" class="d">-        //Setting enum class -&gt; implements an interface -&gt; getName method
</a><a href="#h80-0-21" id="h80-0-21" class="d">-        classes.forEach { clazz -&gt;
</a><a href="#h80-0-22" id="h80-0-22" class="d">-            if (!clazz.isEnum) return@forEach
</a><a href="#h80-0-23" id="h80-0-23" class="d">-
</a><a href="#h80-0-24" id="h80-0-24" class="d">-            //quality level enum
</a><a href="#h80-0-25" id="h80-0-25" class="d">-            if (enumQualityLevel == null) {
</a><a href="#h80-0-26" id="h80-0-26" class="d">-                if (clazz.enumConstants.any { it.toString().startsWith(&quot;LEVEL_NONE&quot;) }) {
</a><a href="#h80-0-27" id="h80-0-27" class="d">-                    enumMappings[&quot;QualityLevel&quot;] = clazz.name
</a><a href="#h80-0-28" id="h80-0-28" class="d">-                    enumQualityLevel = clazz
</a><a href="#h80-0-29" id="h80-0-29" class="d">-                }
</a><a href="#h80-0-30" id="h80-0-30" class="d">-            }
</a><a href="#h80-0-31" id="h80-0-31" class="d">-
</a><a href="#h80-0-32" id="h80-0-32" class="d">-            if (clazz.interfaces.isEmpty()) return@forEach
</a><a href="#h80-0-33" id="h80-0-33" class="d">-            val serializableInterfaceClass = clazz.interfaces[0]
</a><a href="#h80-0-34" id="h80-0-34" class="d">-            if (serializableInterfaceClass.methods
</a><a href="#h80-0-35" id="h80-0-35" class="d">-                    .filter { method: Method -&gt; method.declaringClass == serializableInterfaceClass }
</a><a href="#h80-0-36" id="h80-0-36" class="d">-                    .none { method: Method -&gt; method.name == &quot;getName&quot; }
</a><a href="#h80-0-37" id="h80-0-37" class="d">-            ) return@forEach
</a><a href="#h80-0-38" id="h80-0-38" class="d">-
</a><a href="#h80-0-39" id="h80-0-39" class="d">-            runCatching {
</a><a href="#h80-0-40" id="h80-0-40" class="d">-                val getEnumNameMethod =
</a><a href="#h80-0-41" id="h80-0-41" class="d">-                    serializableInterfaceClass.methods.first { it!!.returnType.isEnum }
</a><a href="#h80-0-42" id="h80-0-42" class="d">-                clazz.enumConstants?.onEach { enumConstant -&gt;
</a><a href="#h80-0-43" id="h80-0-43" class="d">-                    val enumName =
</a><a href="#h80-0-44" id="h80-0-44" class="d">-                        Objects.requireNonNull(getEnumNameMethod.invoke(enumConstant)).toString()
</a><a href="#h80-0-45" id="h80-0-45" class="d">-                    enumMappings[enumName] = clazz.name
</a><a href="#h80-0-46" id="h80-0-46" class="d">-                }
</a><a href="#h80-0-47" id="h80-0-47" class="d">-            }
</a><a href="#h80-0-48" id="h80-0-48" class="d">-        }
</a><a href="#h80-0-49" id="h80-0-49" class="d">-
</a><a href="#h80-0-50" id="h80-0-50" class="d">-        debug(&quot;found &quot; + enumMappings.size + &quot; enums&quot;)
</a><a href="#h80-0-51" id="h80-0-51" class="d">-        mappings[&quot;enums&quot;] = enumMappings
</a><a href="#h80-0-52" id="h80-0-52" class="d">-
</a><a href="#h80-0-53" id="h80-0-53" class="d">-        //find the media quality level provider
</a><a href="#h80-0-54" id="h80-0-54" class="d">-        for (clazz in classes) {
</a><a href="#h80-0-55" id="h80-0-55" class="d">-            if (!Modifier.isAbstract(clazz.modifiers)) continue
</a><a href="#h80-0-56" id="h80-0-56" class="d">-            if (clazz.fields.none { Modifier.isTransient(it.modifiers) }) continue
</a><a href="#h80-0-57" id="h80-0-57" class="d">-            clazz.methods.firstOrNull { it.returnType == enumQualityLevel }?.let {
</a><a href="#h80-0-58" id="h80-0-58" class="d">-                mappings[&quot;MediaQualityLevelProvider&quot;] = clazz.name
</a><a href="#h80-0-59" id="h80-0-59" class="d">-                mappings[&quot;MediaQualityLevelProviderMethod&quot;] = it.name
</a><a href="#h80-0-60" id="h80-0-60" class="d">-                debug(&quot;found MediaQualityLevelProvider: ${clazz.name}.${it.name}&quot;)
</a><a href="#h80-0-61" id="h80-0-61" class="d">-                return
</a><a href="#h80-0-62" id="h80-0-62" class="d">-            }
</a><a href="#h80-0-63" id="h80-0-63" class="d">-        }
</a><a href="#h80-0-64" id="h80-0-64" class="d">-    }
</a><a href="#h80-0-65" id="h80-0-65" class="d">-}</a><a href="#h80-0-66" id="h80-0-66" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h81" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/mapping/impl/OperaPageViewControllerMapper.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/mapping/impl/OperaPageViewControllerMapper.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/mapping/impl/OperaPageViewControllerMapper.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/mapping/impl/OperaPageViewControllerMapper.kt</a></b>
<a href="#h81-0" id="h81-0" class="h">@@ -1,78 +0,0 @@
</a><a href="#h81-0-0" id="h81-0-0" class="d">-package me.rhunk.snapenhance.mapping.impl
</a><a href="#h81-0-1" id="h81-0-1" class="d">-
</a><a href="#h81-0-2" id="h81-0-2" class="d">-import me.rhunk.snapenhance.mapping.Mapper
</a><a href="#h81-0-3" id="h81-0-3" class="d">-import me.rhunk.snapenhance.util.ReflectionHelper
</a><a href="#h81-0-4" id="h81-0-4" class="d">-import java.lang.reflect.Field
</a><a href="#h81-0-5" id="h81-0-5" class="d">-import java.lang.reflect.Method
</a><a href="#h81-0-6" id="h81-0-6" class="d">-import java.lang.reflect.Modifier
</a><a href="#h81-0-7" id="h81-0-7" class="d">-import java.util.Arrays
</a><a href="#h81-0-8" id="h81-0-8" class="d">-
</a><a href="#h81-0-9" id="h81-0-9" class="d">-
</a><a href="#h81-0-10" id="h81-0-10" class="d">-class OperaPageViewControllerMapper : Mapper() {
</a><a href="#h81-0-11" id="h81-0-11" class="d">-    override fun useClasses(
</a><a href="#h81-0-12" id="h81-0-12" class="d">-        classLoader: ClassLoader,
</a><a href="#h81-0-13" id="h81-0-13" class="d">-        classes: List&lt;Class&lt;*&gt;&gt;,
</a><a href="#h81-0-14" id="h81-0-14" class="d">-        mappings: MutableMap&lt;String, Any&gt;
</a><a href="#h81-0-15" id="h81-0-15" class="d">-    ) {
</a><a href="#h81-0-16" id="h81-0-16" class="d">-        var operaPageViewControllerClass: Class&lt;*&gt;? = null
</a><a href="#h81-0-17" id="h81-0-17" class="d">-        for (aClass in classes) {
</a><a href="#h81-0-18" id="h81-0-18" class="d">-            if (!Modifier.isAbstract(aClass.modifiers)) continue
</a><a href="#h81-0-19" id="h81-0-19" class="d">-            if (aClass.interfaces.isEmpty()) continue
</a><a href="#h81-0-20" id="h81-0-20" class="d">-            val foundFields = Arrays.stream(aClass.declaredFields).filter { field: Field -&gt;
</a><a href="#h81-0-21" id="h81-0-21" class="d">-                val modifiers = field.modifiers
</a><a href="#h81-0-22" id="h81-0-22" class="d">-                Modifier.isStatic(modifiers) &amp;&amp; Modifier.isFinal(
</a><a href="#h81-0-23" id="h81-0-23" class="d">-                    modifiers
</a><a href="#h81-0-24" id="h81-0-24" class="d">-                )
</a><a href="#h81-0-25" id="h81-0-25" class="d">-            }.filter { field: Field -&gt;
</a><a href="#h81-0-26" id="h81-0-26" class="d">-                try {
</a><a href="#h81-0-27" id="h81-0-27" class="d">-                    return@filter &quot;ad_product_type&quot; == String.format(&quot;%s&quot;, field[null])
</a><a href="#h81-0-28" id="h81-0-28" class="d">-                } catch (e: IllegalAccessException) {
</a><a href="#h81-0-29" id="h81-0-29" class="d">-                    e.printStackTrace()
</a><a href="#h81-0-30" id="h81-0-30" class="d">-                }
</a><a href="#h81-0-31" id="h81-0-31" class="d">-                false
</a><a href="#h81-0-32" id="h81-0-32" class="d">-            }.count()
</a><a href="#h81-0-33" id="h81-0-33" class="d">-            if (foundFields == 0L) continue
</a><a href="#h81-0-34" id="h81-0-34" class="d">-            operaPageViewControllerClass = aClass
</a><a href="#h81-0-35" id="h81-0-35" class="d">-            break
</a><a href="#h81-0-36" id="h81-0-36" class="d">-        }
</a><a href="#h81-0-37" id="h81-0-37" class="d">-        if (operaPageViewControllerClass == null) throw RuntimeException(&quot;OperaPageViewController not found&quot;)
</a><a href="#h81-0-38" id="h81-0-38" class="d">-
</a><a href="#h81-0-39" id="h81-0-39" class="d">-        val members = HashMap&lt;String, String&gt;()
</a><a href="#h81-0-40" id="h81-0-40" class="d">-        members[&quot;Class&quot;] = operaPageViewControllerClass.name
</a><a href="#h81-0-41" id="h81-0-41" class="d">-
</a><a href="#h81-0-42" id="h81-0-42" class="d">-        operaPageViewControllerClass.fields.forEach { field -&gt;
</a><a href="#h81-0-43" id="h81-0-43" class="d">-            val fieldType = field.type
</a><a href="#h81-0-44" id="h81-0-44" class="d">-            if (fieldType.isEnum) {
</a><a href="#h81-0-45" id="h81-0-45" class="d">-                fieldType.enumConstants.firstOrNull { enumConstant: Any -&gt; enumConstant.toString() == &quot;FULLY_DISPLAYED&quot; }
</a><a href="#h81-0-46" id="h81-0-46" class="d">-                    .let { members[&quot;viewStateField&quot;] = field.name }
</a><a href="#h81-0-47" id="h81-0-47" class="d">-            }
</a><a href="#h81-0-48" id="h81-0-48" class="d">-            if (fieldType == ArrayList::class.java) {
</a><a href="#h81-0-49" id="h81-0-49" class="d">-                members[&quot;layerListField&quot;] = field.name
</a><a href="#h81-0-50" id="h81-0-50" class="d">-            }
</a><a href="#h81-0-51" id="h81-0-51" class="d">-        }
</a><a href="#h81-0-52" id="h81-0-52" class="d">-        val enumViewStateClass = operaPageViewControllerClass.fields.first { field: Field -&gt;
</a><a href="#h81-0-53" id="h81-0-53" class="d">-            field.name == members[&quot;viewStateField&quot;]
</a><a href="#h81-0-54" id="h81-0-54" class="d">-        }.type
</a><a href="#h81-0-55" id="h81-0-55" class="d">-
</a><a href="#h81-0-56" id="h81-0-56" class="d">-        //find the method that call the onDisplayStateChange method
</a><a href="#h81-0-57" id="h81-0-57" class="d">-        members[&quot;onDisplayStateChange&quot;] =
</a><a href="#h81-0-58" id="h81-0-58" class="d">-            operaPageViewControllerClass.methods.first { method: Method -&gt;
</a><a href="#h81-0-59" id="h81-0-59" class="d">-                if (method.returnType != Void.TYPE || method.parameterTypes.size != 1) return@first false
</a><a href="#h81-0-60" id="h81-0-60" class="d">-                val firstParameterClass = method.parameterTypes[0]
</a><a href="#h81-0-61" id="h81-0-61" class="d">-                //check if the class contains a field with the enumViewStateClass type
</a><a href="#h81-0-62" id="h81-0-62" class="d">-                ReflectionHelper.searchFieldByType(firstParameterClass, enumViewStateClass) != null
</a><a href="#h81-0-63" id="h81-0-63" class="d">-            }.name
</a><a href="#h81-0-64" id="h81-0-64" class="d">-
</a><a href="#h81-0-65" id="h81-0-65" class="d">-        //find the method that call the onDisplayStateChange method from gestures
</a><a href="#h81-0-66" id="h81-0-66" class="d">-        members[&quot;onDisplayStateChange2&quot;] =
</a><a href="#h81-0-67" id="h81-0-67" class="d">-            operaPageViewControllerClass.methods.first { method: Method -&gt;
</a><a href="#h81-0-68" id="h81-0-68" class="d">-                if (method.returnType != Void.TYPE || method.parameterTypes.size != 2) return@first false
</a><a href="#h81-0-69" id="h81-0-69" class="d">-                val firstParameterClass = method.parameterTypes[0]
</a><a href="#h81-0-70" id="h81-0-70" class="d">-                val secondParameterClass = method.parameterTypes[1]
</a><a href="#h81-0-71" id="h81-0-71" class="d">-                firstParameterClass.isEnum &amp;&amp; secondParameterClass.isEnum
</a><a href="#h81-0-72" id="h81-0-72" class="d">-            }.name
</a><a href="#h81-0-73" id="h81-0-73" class="d">-
</a><a href="#h81-0-74" id="h81-0-74" class="d">-        mappings[&quot;OperaPageViewController&quot;] = members
</a><a href="#h81-0-75" id="h81-0-75" class="d">-        return
</a><a href="#h81-0-76" id="h81-0-76" class="d">-    }
</a><a href="#h81-0-77" id="h81-0-77" class="d">-}
</a><b>diff --git a/<a id="h82" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/mapping/impl/PlatformAnalyticsCreatorMapper.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/mapping/impl/PlatformAnalyticsCreatorMapper.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/mapping/impl/PlatformAnalyticsCreatorMapper.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/mapping/impl/PlatformAnalyticsCreatorMapper.kt</a></b>
<a href="#h82-0" id="h82-0" class="h">@@ -1,26 +0,0 @@
</a><a href="#h82-0-0" id="h82-0-0" class="d">-package me.rhunk.snapenhance.mapping.impl
</a><a href="#h82-0-1" id="h82-0-1" class="d">-
</a><a href="#h82-0-2" id="h82-0-2" class="d">-import me.rhunk.snapenhance.mapping.Mapper
</a><a href="#h82-0-3" id="h82-0-3" class="d">-
</a><a href="#h82-0-4" id="h82-0-4" class="d">-class PlatformAnalyticsCreatorMapper : Mapper() {
</a><a href="#h82-0-5" id="h82-0-5" class="d">-    override fun useClasses(
</a><a href="#h82-0-6" id="h82-0-6" class="d">-        classLoader: ClassLoader,
</a><a href="#h82-0-7" id="h82-0-7" class="d">-        classes: List&lt;Class&lt;*&gt;&gt;,
</a><a href="#h82-0-8" id="h82-0-8" class="d">-        mappings: MutableMap&lt;String, Any&gt;
</a><a href="#h82-0-9" id="h82-0-9" class="d">-    ) {
</a><a href="#h82-0-10" id="h82-0-10" class="d">-        for (clazz in classes) {
</a><a href="#h82-0-11" id="h82-0-11" class="d">-            if (clazz.isEnum || clazz.isInterface) continue
</a><a href="#h82-0-12" id="h82-0-12" class="d">-            val constructors = clazz.constructors
</a><a href="#h82-0-13" id="h82-0-13" class="d">-            if (constructors.isEmpty()) continue
</a><a href="#h82-0-14" id="h82-0-14" class="d">-            val firstConstructor = constructors[0]
</a><a href="#h82-0-15" id="h82-0-15" class="d">-            // 47 is the number of parameters of the constructor
</a><a href="#h82-0-16" id="h82-0-16" class="d">-            // can change in future versions
</a><a href="#h82-0-17" id="h82-0-17" class="d">-            if (firstConstructor.parameterCount != 47) continue
</a><a href="#h82-0-18" id="h82-0-18" class="d">-            if (!firstConstructor.parameterTypes[0].isEnum) continue
</a><a href="#h82-0-19" id="h82-0-19" class="d">-            if (firstConstructor.parameterTypes[0].enumConstants.none { it.toString() == &quot;IN_APP_NOTIFICATION&quot; }) continue
</a><a href="#h82-0-20" id="h82-0-20" class="d">-
</a><a href="#h82-0-21" id="h82-0-21" class="d">-            mappings[&quot;PlatformAnalyticsCreator&quot;] = clazz.name
</a><a href="#h82-0-22" id="h82-0-22" class="d">-            return
</a><a href="#h82-0-23" id="h82-0-23" class="d">-        }
</a><a href="#h82-0-24" id="h82-0-24" class="d">-    }
</a><a href="#h82-0-25" id="h82-0-25" class="d">-}</a><a href="#h82-0-26" id="h82-0-26" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h83" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/mapping/impl/PlusSubscriptionMapper.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/mapping/impl/PlusSubscriptionMapper.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/mapping/impl/PlusSubscriptionMapper.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/mapping/impl/PlusSubscriptionMapper.kt</a></b>
<a href="#h83-0" id="h83-0" class="h">@@ -1,27 +0,0 @@
</a><a href="#h83-0-0" id="h83-0-0" class="d">-package me.rhunk.snapenhance.mapping.impl
</a><a href="#h83-0-1" id="h83-0-1" class="d">-
</a><a href="#h83-0-2" id="h83-0-2" class="d">-import me.rhunk.snapenhance.mapping.Mapper
</a><a href="#h83-0-3" id="h83-0-3" class="d">-import java.lang.reflect.Modifier
</a><a href="#h83-0-4" id="h83-0-4" class="d">-
</a><a href="#h83-0-5" id="h83-0-5" class="d">-
</a><a href="#h83-0-6" id="h83-0-6" class="d">-class PlusSubscriptionMapper : Mapper() {
</a><a href="#h83-0-7" id="h83-0-7" class="d">-    override fun useClasses(
</a><a href="#h83-0-8" id="h83-0-8" class="d">-        classLoader: ClassLoader,
</a><a href="#h83-0-9" id="h83-0-9" class="d">-        classes: List&lt;Class&lt;*&gt;&gt;,
</a><a href="#h83-0-10" id="h83-0-10" class="d">-        mappings: MutableMap&lt;String, Any&gt;
</a><a href="#h83-0-11" id="h83-0-11" class="d">-    ) {
</a><a href="#h83-0-12" id="h83-0-12" class="d">-        for (clazz in classes) {
</a><a href="#h83-0-13" id="h83-0-13" class="d">-            clazz.declaredFields.firstOrNull {
</a><a href="#h83-0-14" id="h83-0-14" class="d">-                it.type == clazz &amp;&amp;
</a><a href="#h83-0-15" id="h83-0-15" class="d">-                Modifier.isFinal(it.modifiers) &amp;&amp;
</a><a href="#h83-0-16" id="h83-0-16" class="d">-                Modifier.isStatic(it.modifiers) &amp;&amp;
</a><a href="#h83-0-17" id="h83-0-17" class="d">-                runCatching {
</a><a href="#h83-0-18" id="h83-0-18" class="d">-                    it?.get(null).toString().startsWith(&quot;PlusSubscriptionState&quot;)
</a><a href="#h83-0-19" id="h83-0-19" class="d">-                }.getOrDefault(false)
</a><a href="#h83-0-20" id="h83-0-20" class="d">-            } ?: continue
</a><a href="#h83-0-21" id="h83-0-21" class="d">-
</a><a href="#h83-0-22" id="h83-0-22" class="d">-            mappings[&quot;SubscriptionInfoClass&quot;] = clazz.constructors[0]!!.parameterTypes[0]!!.name
</a><a href="#h83-0-23" id="h83-0-23" class="d">-            return
</a><a href="#h83-0-24" id="h83-0-24" class="d">-        }
</a><a href="#h83-0-25" id="h83-0-25" class="d">-    }
</a><a href="#h83-0-26" id="h83-0-26" class="d">-}</a><a href="#h83-0-27" id="h83-0-27" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h84" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/mapping/impl/ScCameraSettingsMapper.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/mapping/impl/ScCameraSettingsMapper.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/mapping/impl/ScCameraSettingsMapper.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/mapping/impl/ScCameraSettingsMapper.kt</a></b>
<a href="#h84-0" id="h84-0" class="h">@@ -1,21 +0,0 @@
</a><a href="#h84-0-0" id="h84-0-0" class="d">-package me.rhunk.snapenhance.mapping.impl
</a><a href="#h84-0-1" id="h84-0-1" class="d">-
</a><a href="#h84-0-2" id="h84-0-2" class="d">-import me.rhunk.snapenhance.mapping.Mapper
</a><a href="#h84-0-3" id="h84-0-3" class="d">-
</a><a href="#h84-0-4" id="h84-0-4" class="d">-class ScCameraSettingsMapper : Mapper() {
</a><a href="#h84-0-5" id="h84-0-5" class="d">-    override fun useClasses(
</a><a href="#h84-0-6" id="h84-0-6" class="d">-        classLoader: ClassLoader,
</a><a href="#h84-0-7" id="h84-0-7" class="d">-        classes: List&lt;Class&lt;*&gt;&gt;,
</a><a href="#h84-0-8" id="h84-0-8" class="d">-        mappings: MutableMap&lt;String, Any&gt;
</a><a href="#h84-0-9" id="h84-0-9" class="d">-    ) {
</a><a href="#h84-0-10" id="h84-0-10" class="d">-        for (clazz in classes) {
</a><a href="#h84-0-11" id="h84-0-11" class="d">-            if (clazz.constructors.isEmpty()) continue
</a><a href="#h84-0-12" id="h84-0-12" class="d">-            val parameters =  clazz.constructors.first().parameterTypes
</a><a href="#h84-0-13" id="h84-0-13" class="d">-            if (parameters.size &lt; 27) continue
</a><a href="#h84-0-14" id="h84-0-14" class="d">-            val firstParameter = parameters[0]
</a><a href="#h84-0-15" id="h84-0-15" class="d">-            if (!firstParameter.isEnum || firstParameter.enumConstants.find { it.toString() == &quot;CONTINUOUS_PICTURE&quot; } == null) continue
</a><a href="#h84-0-16" id="h84-0-16" class="d">-            mappings[&quot;ScCameraSettings&quot;] = clazz.name
</a><a href="#h84-0-17" id="h84-0-17" class="d">-            return
</a><a href="#h84-0-18" id="h84-0-18" class="d">-        }
</a><a href="#h84-0-19" id="h84-0-19" class="d">-    }
</a><a href="#h84-0-20" id="h84-0-20" class="d">-}</a><a href="#h84-0-21" id="h84-0-21" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h85" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/mapping/impl/StoryBoostStateMapper.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/mapping/impl/StoryBoostStateMapper.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/mapping/impl/StoryBoostStateMapper.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/mapping/impl/StoryBoostStateMapper.kt</a></b>
<a href="#h85-0" id="h85-0" class="h">@@ -1,21 +0,0 @@
</a><a href="#h85-0-0" id="h85-0-0" class="d">-package me.rhunk.snapenhance.mapping.impl
</a><a href="#h85-0-1" id="h85-0-1" class="d">-
</a><a href="#h85-0-2" id="h85-0-2" class="d">-import me.rhunk.snapenhance.mapping.Mapper
</a><a href="#h85-0-3" id="h85-0-3" class="d">-
</a><a href="#h85-0-4" id="h85-0-4" class="d">-class StoryBoostStateMapper : Mapper(){
</a><a href="#h85-0-5" id="h85-0-5" class="d">-    override fun useClasses(
</a><a href="#h85-0-6" id="h85-0-6" class="d">-        classLoader: ClassLoader,
</a><a href="#h85-0-7" id="h85-0-7" class="d">-        classes: List&lt;Class&lt;*&gt;&gt;,
</a><a href="#h85-0-8" id="h85-0-8" class="d">-        mappings: MutableMap&lt;String, Any&gt;
</a><a href="#h85-0-9" id="h85-0-9" class="d">-    ) {
</a><a href="#h85-0-10" id="h85-0-10" class="d">-        for (clazz in classes) {
</a><a href="#h85-0-11" id="h85-0-11" class="d">-            val firstConstructor = clazz.constructors.firstOrNull() ?: continue
</a><a href="#h85-0-12" id="h85-0-12" class="d">-            if (firstConstructor.parameterCount != 3) continue
</a><a href="#h85-0-13" id="h85-0-13" class="d">-            if (firstConstructor.parameterTypes[1] != Long::class.javaPrimitiveType || firstConstructor.parameterTypes[2] != Long::class.javaPrimitiveType) continue
</a><a href="#h85-0-14" id="h85-0-14" class="d">-            val storyBoostEnumClass = firstConstructor.parameterTypes[0]
</a><a href="#h85-0-15" id="h85-0-15" class="d">-            if (!storyBoostEnumClass.isEnum || storyBoostEnumClass.enumConstants.none { it.toString() == &quot;NeedSubscriptionCannotSubscribe&quot; }) continue
</a><a href="#h85-0-16" id="h85-0-16" class="d">-            mappings[&quot;StoryBoostStateClass&quot;] = clazz.name
</a><a href="#h85-0-17" id="h85-0-17" class="d">-            return
</a><a href="#h85-0-18" id="h85-0-18" class="d">-        }
</a><a href="#h85-0-19" id="h85-0-19" class="d">-    }
</a><a href="#h85-0-20" id="h85-0-20" class="d">-}</a><a href="#h85-0-21" id="h85-0-21" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h86" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/ItemHelper.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/ItemHelper.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/ItemHelper.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/ItemHelper.kt</a></b>
<a href="#h86-0" id="h86-0" class="h">@@ -0,0 +1,85 @@
</a><a href="#h86-0-0" id="h86-0-0" class="i">+package me.rhunk.snapenhance.ui
</a><a href="#h86-0-1" id="h86-0-1" class="i">+
</a><a href="#h86-0-2" id="h86-0-2" class="i">+import android.app.Activity
</a><a href="#h86-0-3" id="h86-0-3" class="i">+import android.app.AlertDialog
</a><a href="#h86-0-4" id="h86-0-4" class="i">+import android.content.Context
</a><a href="#h86-0-5" id="h86-0-5" class="i">+import android.content.Intent
</a><a href="#h86-0-6" id="h86-0-6" class="i">+import android.widget.EditText
</a><a href="#h86-0-7" id="h86-0-7" class="i">+import android.widget.TextView
</a><a href="#h86-0-8" id="h86-0-8" class="i">+import android.widget.Toast
</a><a href="#h86-0-9" id="h86-0-9" class="i">+import me.rhunk.snapenhance.R
</a><a href="#h86-0-10" id="h86-0-10" class="i">+import me.rhunk.snapenhance.SharedContext
</a><a href="#h86-0-11" id="h86-0-11" class="i">+import me.rhunk.snapenhance.config.ConfigProperty
</a><a href="#h86-0-12" id="h86-0-12" class="i">+import me.rhunk.snapenhance.util.ActivityResultCallback
</a><a href="#h86-0-13" id="h86-0-13" class="i">+import kotlin.math.abs
</a><a href="#h86-0-14" id="h86-0-14" class="i">+import kotlin.random.Random
</a><a href="#h86-0-15" id="h86-0-15" class="i">+
</a><a href="#h86-0-16" id="h86-0-16" class="i">+class ItemHelper(
</a><a href="#h86-0-17" id="h86-0-17" class="i">+    private val context : Context
</a><a href="#h86-0-18" id="h86-0-18" class="i">+) {
</a><a href="#h86-0-19" id="h86-0-19" class="i">+    val positiveButtonText by lazy {
</a><a href="#h86-0-20" id="h86-0-20" class="i">+        SharedContext.translation[&quot;button.ok&quot;]
</a><a href="#h86-0-21" id="h86-0-21" class="i">+    }
</a><a href="#h86-0-22" id="h86-0-22" class="i">+    
</a><a href="#h86-0-23" id="h86-0-23" class="i">+    val cancelButtonText by lazy {
</a><a href="#h86-0-24" id="h86-0-24" class="i">+        SharedContext.translation[&quot;button.cancel&quot;]
</a><a href="#h86-0-25" id="h86-0-25" class="i">+    }
</a><a href="#h86-0-26" id="h86-0-26" class="i">+    
</a><a href="#h86-0-27" id="h86-0-27" class="i">+    fun longToast(message: String, context: Context) {
</a><a href="#h86-0-28" id="h86-0-28" class="i">+        Toast.makeText(context, message, Toast.LENGTH_LONG).show()
</a><a href="#h86-0-29" id="h86-0-29" class="i">+    }
</a><a href="#h86-0-30" id="h86-0-30" class="i">+
</a><a href="#h86-0-31" id="h86-0-31" class="i">+    fun createTranslatedTextView(property: ConfigProperty, shouldTranslatePropertyValue: Boolean = true): TextView {
</a><a href="#h86-0-32" id="h86-0-32" class="i">+        return object: TextView(context) {
</a><a href="#h86-0-33" id="h86-0-33" class="i">+            override fun setText(text: CharSequence?, type: BufferType?) {
</a><a href="#h86-0-34" id="h86-0-34" class="i">+                val newText = text?.takeIf { it.isNotEmpty() }?.let {
</a><a href="#h86-0-35" id="h86-0-35" class="i">+                    if (!shouldTranslatePropertyValue || property.disableValueLocalization) it
</a><a href="#h86-0-36" id="h86-0-36" class="i">+                    else SharedContext.translation[property.getOptionTranslationKey(it.toString())]
</a><a href="#h86-0-37" id="h86-0-37" class="i">+                }?.let {
</a><a href="#h86-0-38" id="h86-0-38" class="i">+                    if (it.length &gt; 20) {
</a><a href="#h86-0-39" id="h86-0-39" class="i">+                        &quot;...${it.substring(it.length - 20)}&quot;
</a><a href="#h86-0-40" id="h86-0-40" class="i">+                    } else {
</a><a href="#h86-0-41" id="h86-0-41" class="i">+                        it
</a><a href="#h86-0-42" id="h86-0-42" class="i">+                    }
</a><a href="#h86-0-43" id="h86-0-43" class="i">+                } ?: &quot;&quot;
</a><a href="#h86-0-44" id="h86-0-44" class="i">+                super.setTextColor(context.getColor(R.color.tertiaryText))
</a><a href="#h86-0-45" id="h86-0-45" class="i">+                super.setText(newText, type)
</a><a href="#h86-0-46" id="h86-0-46" class="i">+            }
</a><a href="#h86-0-47" id="h86-0-47" class="i">+        }
</a><a href="#h86-0-48" id="h86-0-48" class="i">+    }
</a><a href="#h86-0-49" id="h86-0-49" class="i">+
</a><a href="#h86-0-50" id="h86-0-50" class="i">+    fun askForValue(property: ConfigProperty, requestedInputType: Int, callback: (String) -&gt; Unit) {
</a><a href="#h86-0-51" id="h86-0-51" class="i">+        val editText = EditText(context).apply {
</a><a href="#h86-0-52" id="h86-0-52" class="i">+            inputType = requestedInputType
</a><a href="#h86-0-53" id="h86-0-53" class="i">+            setText(property.valueContainer.value().toString())
</a><a href="#h86-0-54" id="h86-0-54" class="i">+        }
</a><a href="#h86-0-55" id="h86-0-55" class="i">+        AlertDialog.Builder(context)
</a><a href="#h86-0-56" id="h86-0-56" class="i">+            .setTitle(SharedContext.translation[&quot;property.${property.translationKey}.name&quot;])
</a><a href="#h86-0-57" id="h86-0-57" class="i">+            .setView(editText)
</a><a href="#h86-0-58" id="h86-0-58" class="i">+            .setPositiveButton(positiveButtonText) { _, _ -&gt;
</a><a href="#h86-0-59" id="h86-0-59" class="i">+                callback(editText.text.toString())
</a><a href="#h86-0-60" id="h86-0-60" class="i">+            }
</a><a href="#h86-0-61" id="h86-0-61" class="i">+            .setNegativeButton(cancelButtonText) { dialog, _ -&gt;
</a><a href="#h86-0-62" id="h86-0-62" class="i">+                dialog.cancel()
</a><a href="#h86-0-63" id="h86-0-63" class="i">+            }
</a><a href="#h86-0-64" id="h86-0-64" class="i">+            .show()
</a><a href="#h86-0-65" id="h86-0-65" class="i">+    }
</a><a href="#h86-0-66" id="h86-0-66" class="i">+
</a><a href="#h86-0-67" id="h86-0-67" class="i">+    fun askForFolder(activity: Activity, property: ConfigProperty, callback: (String) -&gt; Unit): Pair&lt;Int, ActivityResultCallback&gt; {
</a><a href="#h86-0-68" id="h86-0-68" class="i">+        val intent = Intent(Intent.ACTION_OPEN_DOCUMENT_TREE)
</a><a href="#h86-0-69" id="h86-0-69" class="i">+            .addFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION)
</a><a href="#h86-0-70" id="h86-0-70" class="i">+            .addFlags(Intent.FLAG_GRANT_WRITE_URI_PERMISSION)
</a><a href="#h86-0-71" id="h86-0-71" class="i">+
</a><a href="#h86-0-72" id="h86-0-72" class="i">+        val requestCode = abs(Random.nextInt())
</a><a href="#h86-0-73" id="h86-0-73" class="i">+        activity.startActivityForResult(intent, requestCode)
</a><a href="#h86-0-74" id="h86-0-74" class="i">+
</a><a href="#h86-0-75" id="h86-0-75" class="i">+        return requestCode to let@{_, resultCode, data -&gt;
</a><a href="#h86-0-76" id="h86-0-76" class="i">+            if (resultCode != Activity.RESULT_OK) return@let
</a><a href="#h86-0-77" id="h86-0-77" class="i">+            val uri = data?.data ?: return@let
</a><a href="#h86-0-78" id="h86-0-78" class="i">+            val value = uri.toString()
</a><a href="#h86-0-79" id="h86-0-79" class="i">+            activity.contentResolver.takePersistableUriPermission(uri, Intent.FLAG_GRANT_READ_URI_PERMISSION or Intent.FLAG_GRANT_WRITE_URI_PERMISSION)
</a><a href="#h86-0-80" id="h86-0-80" class="i">+            property.valueContainer.writeFrom(value)
</a><a href="#h86-0-81" id="h86-0-81" class="i">+            callback(value)
</a><a href="#h86-0-82" id="h86-0-82" class="i">+        }
</a><a href="#h86-0-83" id="h86-0-83" class="i">+    }
</a><a href="#h86-0-84" id="h86-0-84" class="i">+}
</a><b>diff --git a/<a id="h87" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/ViewAppearanceHelper.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/ViewAppearanceHelper.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/ViewAppearanceHelper.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/ViewAppearanceHelper.kt</a></b>
<a href="#h87-0" id="h87-0" class="h">@@ -0,0 +1,97 @@
</a><a href="#h87-0-0" id="h87-0-0" class="i">+package me.rhunk.snapenhance.ui
</a><a href="#h87-0-1" id="h87-0-1" class="i">+
</a><a href="#h87-0-2" id="h87-0-2" class="i">+import android.annotation.SuppressLint
</a><a href="#h87-0-3" id="h87-0-3" class="i">+import android.app.AlertDialog
</a><a href="#h87-0-4" id="h87-0-4" class="i">+import android.content.Context
</a><a href="#h87-0-5" id="h87-0-5" class="i">+import android.content.res.ColorStateList
</a><a href="#h87-0-6" id="h87-0-6" class="i">+import android.graphics.Color
</a><a href="#h87-0-7" id="h87-0-7" class="i">+import android.graphics.drawable.ColorDrawable
</a><a href="#h87-0-8" id="h87-0-8" class="i">+import android.graphics.drawable.Drawable
</a><a href="#h87-0-9" id="h87-0-9" class="i">+import android.graphics.drawable.ShapeDrawable
</a><a href="#h87-0-10" id="h87-0-10" class="i">+import android.graphics.drawable.StateListDrawable
</a><a href="#h87-0-11" id="h87-0-11" class="i">+import android.view.Gravity
</a><a href="#h87-0-12" id="h87-0-12" class="i">+import android.view.View
</a><a href="#h87-0-13" id="h87-0-13" class="i">+import android.widget.Switch
</a><a href="#h87-0-14" id="h87-0-14" class="i">+import android.widget.TextView
</a><a href="#h87-0-15" id="h87-0-15" class="i">+import me.rhunk.snapenhance.Constants
</a><a href="#h87-0-16" id="h87-0-16" class="i">+
</a><a href="#h87-0-17" id="h87-0-17" class="i">+object ViewAppearanceHelper {
</a><a href="#h87-0-18" id="h87-0-18" class="i">+    @SuppressLint(&quot;UseSwitchCompatOrMaterialCode&quot;, &quot;RtlHardcoded&quot;, &quot;DiscouragedApi&quot;,
</a><a href="#h87-0-19" id="h87-0-19" class="i">+        &quot;ClickableViewAccessibility&quot;
</a><a href="#h87-0-20" id="h87-0-20" class="i">+    )
</a><a href="#h87-0-21" id="h87-0-21" class="i">+    private var sigColorTextPrimary: Int = 0
</a><a href="#h87-0-22" id="h87-0-22" class="i">+    private var sigColorBackgroundSurface: Int = 0
</a><a href="#h87-0-23" id="h87-0-23" class="i">+
</a><a href="#h87-0-24" id="h87-0-24" class="i">+    private fun createRoundedBackground(color: Int, hasRadius: Boolean): Drawable {
</a><a href="#h87-0-25" id="h87-0-25" class="i">+        if (!hasRadius) return ColorDrawable(color)
</a><a href="#h87-0-26" id="h87-0-26" class="i">+        //FIXME: hardcoded radius
</a><a href="#h87-0-27" id="h87-0-27" class="i">+        return ShapeDrawable().apply {
</a><a href="#h87-0-28" id="h87-0-28" class="i">+            paint.color = color
</a><a href="#h87-0-29" id="h87-0-29" class="i">+            shape = android.graphics.drawable.shapes.RoundRectShape(
</a><a href="#h87-0-30" id="h87-0-30" class="i">+                floatArrayOf(20f, 20f, 20f, 20f, 20f, 20f, 20f, 20f),
</a><a href="#h87-0-31" id="h87-0-31" class="i">+                null,
</a><a href="#h87-0-32" id="h87-0-32" class="i">+                null
</a><a href="#h87-0-33" id="h87-0-33" class="i">+            )
</a><a href="#h87-0-34" id="h87-0-34" class="i">+        }
</a><a href="#h87-0-35" id="h87-0-35" class="i">+    }
</a><a href="#h87-0-36" id="h87-0-36" class="i">+
</a><a href="#h87-0-37" id="h87-0-37" class="i">+    @SuppressLint(&quot;DiscouragedApi&quot;)
</a><a href="#h87-0-38" id="h87-0-38" class="i">+    fun applyTheme(component: View, componentWidth: Int? = null, hasRadius: Boolean = false) {
</a><a href="#h87-0-39" id="h87-0-39" class="i">+        val resources = component.context.resources
</a><a href="#h87-0-40" id="h87-0-40" class="i">+        if (sigColorBackgroundSurface == 0 || sigColorTextPrimary == 0) {
</a><a href="#h87-0-41" id="h87-0-41" class="i">+            with(component.context.theme) {
</a><a href="#h87-0-42" id="h87-0-42" class="i">+                sigColorTextPrimary = obtainStyledAttributes(
</a><a href="#h87-0-43" id="h87-0-43" class="i">+                    intArrayOf(resources.getIdentifier(&quot;sigColorTextPrimary&quot;, &quot;attr&quot;, Constants.SNAPCHAT_PACKAGE_NAME))
</a><a href="#h87-0-44" id="h87-0-44" class="i">+                ).getColor(0, 0)
</a><a href="#h87-0-45" id="h87-0-45" class="i">+
</a><a href="#h87-0-46" id="h87-0-46" class="i">+                sigColorBackgroundSurface = obtainStyledAttributes(
</a><a href="#h87-0-47" id="h87-0-47" class="i">+                    intArrayOf(resources.getIdentifier(&quot;sigColorBackgroundSurface&quot;, &quot;attr&quot;, Constants.SNAPCHAT_PACKAGE_NAME))
</a><a href="#h87-0-48" id="h87-0-48" class="i">+                ).getColor(0, 0)
</a><a href="#h87-0-49" id="h87-0-49" class="i">+            }
</a><a href="#h87-0-50" id="h87-0-50" class="i">+        }
</a><a href="#h87-0-51" id="h87-0-51" class="i">+
</a><a href="#h87-0-52" id="h87-0-52" class="i">+        val snapchatFontResId = resources.getIdentifier(&quot;avenir_next_medium&quot;, &quot;font&quot;, &quot;com.snapchat.android&quot;)
</a><a href="#h87-0-53" id="h87-0-53" class="i">+        val scalingFactor = resources.displayMetrics.densityDpi.toDouble() / 400
</a><a href="#h87-0-54" id="h87-0-54" class="i">+
</a><a href="#h87-0-55" id="h87-0-55" class="i">+        with(component) {
</a><a href="#h87-0-56" id="h87-0-56" class="i">+            if (this is TextView) {
</a><a href="#h87-0-57" id="h87-0-57" class="i">+                setTextColor(sigColorTextPrimary)
</a><a href="#h87-0-58" id="h87-0-58" class="i">+                setShadowLayer(0F, 0F, 0F, 0)
</a><a href="#h87-0-59" id="h87-0-59" class="i">+                gravity = Gravity.CENTER_VERTICAL
</a><a href="#h87-0-60" id="h87-0-60" class="i">+                componentWidth?.let { width = it}
</a><a href="#h87-0-61" id="h87-0-61" class="i">+                height = (150 * scalingFactor).toInt()
</a><a href="#h87-0-62" id="h87-0-62" class="i">+                isAllCaps = false
</a><a href="#h87-0-63" id="h87-0-63" class="i">+                textSize = 16f
</a><a href="#h87-0-64" id="h87-0-64" class="i">+                typeface = resources.getFont(snapchatFontResId)
</a><a href="#h87-0-65" id="h87-0-65" class="i">+                outlineProvider = null
</a><a href="#h87-0-66" id="h87-0-66" class="i">+                setPadding((40 * scalingFactor).toInt(), 0, (40 * scalingFactor).toInt(), 0)
</a><a href="#h87-0-67" id="h87-0-67" class="i">+            }
</a><a href="#h87-0-68" id="h87-0-68" class="i">+            background = StateListDrawable().apply {
</a><a href="#h87-0-69" id="h87-0-69" class="i">+                addState(intArrayOf(), createRoundedBackground(color = sigColorBackgroundSurface, hasRadius))
</a><a href="#h87-0-70" id="h87-0-70" class="i">+                addState(intArrayOf(android.R.attr.state_pressed), createRoundedBackground(color = 0x5395026, hasRadius))
</a><a href="#h87-0-71" id="h87-0-71" class="i">+            }
</a><a href="#h87-0-72" id="h87-0-72" class="i">+        }
</a><a href="#h87-0-73" id="h87-0-73" class="i">+
</a><a href="#h87-0-74" id="h87-0-74" class="i">+        if (component is Switch) {
</a><a href="#h87-0-75" id="h87-0-75" class="i">+            with(resources) {
</a><a href="#h87-0-76" id="h87-0-76" class="i">+                component.switchMinWidth = getDimension(getIdentifier(&quot;v11_switch_min_width&quot;, &quot;dimen&quot;, Constants.SNAPCHAT_PACKAGE_NAME)).toInt()
</a><a href="#h87-0-77" id="h87-0-77" class="i">+            }
</a><a href="#h87-0-78" id="h87-0-78" class="i">+            component.trackTintList = ColorStateList(
</a><a href="#h87-0-79" id="h87-0-79" class="i">+                arrayOf(intArrayOf(-android.R.attr.state_checked), intArrayOf(android.R.attr.state_checked)
</a><a href="#h87-0-80" id="h87-0-80" class="i">+                ), intArrayOf(
</a><a href="#h87-0-81" id="h87-0-81" class="i">+                    Color.parseColor(&quot;#1d1d1d&quot;),
</a><a href="#h87-0-82" id="h87-0-82" class="i">+                    Color.parseColor(&quot;#26bd49&quot;)
</a><a href="#h87-0-83" id="h87-0-83" class="i">+                )
</a><a href="#h87-0-84" id="h87-0-84" class="i">+            )
</a><a href="#h87-0-85" id="h87-0-85" class="i">+            component.thumbTintList = ColorStateList(
</a><a href="#h87-0-86" id="h87-0-86" class="i">+                arrayOf(intArrayOf(-android.R.attr.state_checked), intArrayOf(android.R.attr.state_checked)
</a><a href="#h87-0-87" id="h87-0-87" class="i">+                ), intArrayOf(
</a><a href="#h87-0-88" id="h87-0-88" class="i">+                    Color.parseColor(&quot;#F5F5F5&quot;),
</a><a href="#h87-0-89" id="h87-0-89" class="i">+                    Color.parseColor(&quot;#26bd49&quot;)
</a><a href="#h87-0-90" id="h87-0-90" class="i">+                )
</a><a href="#h87-0-91" id="h87-0-91" class="i">+            )
</a><a href="#h87-0-92" id="h87-0-92" class="i">+        }
</a><a href="#h87-0-93" id="h87-0-93" class="i">+    }
</a><a href="#h87-0-94" id="h87-0-94" class="i">+
</a><a href="#h87-0-95" id="h87-0-95" class="i">+    fun newAlertDialogBuilder(context: Context?) = AlertDialog.Builder(context, android.R.style.Theme_DeviceDefault_Dialog_Alert)
</a><a href="#h87-0-96" id="h87-0-96" class="i">+}
</a><b>diff --git a/<a id="h88" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/config/ConfigActivity.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/config/ConfigActivity.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/config/ConfigActivity.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/config/ConfigActivity.kt</a></b>
<a href="#h88-0" id="h88-0" class="h">@@ -2,13 +2,13 @@ package me.rhunk.snapenhance.ui.config
</a> 
 import android.app.Activity
 import android.app.AlertDialog
<a href="#h88-0-3" id="h88-0-3" class="i">+import android.content.Intent
</a> import android.content.res.ColorStateList
 import android.os.Bundle
 import android.text.Html
 import android.text.InputType
 import android.view.View
 import android.view.ViewGroup
<a href="#h88-0-10" id="h88-0-10" class="d">-import android.widget.EditText
</a> import android.widget.ImageButton
 import android.widget.Switch
 import android.widget.TextView
<a href="#h88-1" id="h88-1" class="h">@@ -16,7 +16,6 @@ import android.widget.Toast
</a> import me.rhunk.snapenhance.BuildConfig
 import me.rhunk.snapenhance.R
 import me.rhunk.snapenhance.SharedContext
<a href="#h88-1-3" id="h88-1-3" class="d">-import me.rhunk.snapenhance.bridge.ConfigWrapper
</a> import me.rhunk.snapenhance.config.ConfigCategory
 import me.rhunk.snapenhance.config.ConfigProperty
 import me.rhunk.snapenhance.config.impl.ConfigIntegerValue
<a href="#h88-2" id="h88-2" class="h">@@ -24,9 +23,14 @@ import me.rhunk.snapenhance.config.impl.ConfigStateListValue
</a> import me.rhunk.snapenhance.config.impl.ConfigStateSelection
 import me.rhunk.snapenhance.config.impl.ConfigStateValue
 import me.rhunk.snapenhance.config.impl.ConfigStringValue
<a href="#h88-2-3" id="h88-2-3" class="i">+import me.rhunk.snapenhance.ui.ItemHelper
</a><a href="#h88-2-4" id="h88-2-4" class="i">+import me.rhunk.snapenhance.util.ActivityResultCallback
</a><a href="#h88-2-5" id="h88-2-5" class="i">+import kotlin.system.exitProcess
</a><a href="#h88-2-6" id="h88-2-6" class="i">+
</a> 
 class ConfigActivity : Activity() {
<a href="#h88-2-9" id="h88-2-9" class="d">-    private val config = ConfigWrapper()
</a><a href="#h88-2-10" id="h88-2-10" class="i">+    private val itemHelper = ItemHelper(this)
</a><a href="#h88-2-11" id="h88-2-11" class="i">+    private val activityResultCallbacks = mutableMapOf&lt;Int, ActivityResultCallback&gt;()
</a> 
     @Deprecated(&quot;Deprecated in Java&quot;)
     @Suppress(&quot;DEPRECATION&quot;)
<a href="#h88-3" id="h88-3" class="h">@@ -37,65 +41,20 @@ class ConfigActivity : Activity() {
</a> 
     override fun onDestroy() {
         super.onDestroy()
<a href="#h88-3-3" id="h88-3-3" class="d">-        config.writeConfig()
</a><a href="#h88-3-4" id="h88-3-4" class="i">+        SharedContext.config.writeConfig()
</a>     }
 
     override fun onPause() {
         super.onPause()
<a href="#h88-3-9" id="h88-3-9" class="d">-        config.writeConfig()
</a><a href="#h88-3-10" id="h88-3-10" class="d">-    }
</a><a href="#h88-3-11" id="h88-3-11" class="d">-
</a><a href="#h88-3-12" id="h88-3-12" class="d">-    private val positiveButtonText by lazy {
</a><a href="#h88-3-13" id="h88-3-13" class="d">-        SharedContext.translation[&quot;button.ok&quot;]
</a><a href="#h88-3-14" id="h88-3-14" class="d">-    }
</a><a href="#h88-3-15" id="h88-3-15" class="d">-
</a><a href="#h88-3-16" id="h88-3-16" class="d">-    private val cancelButtonText by lazy {
</a><a href="#h88-3-17" id="h88-3-17" class="d">-        SharedContext.translation[&quot;button.cancel&quot;]
</a><a href="#h88-3-18" id="h88-3-18" class="d">-    }
</a><a href="#h88-3-19" id="h88-3-19" class="d">-
</a><a href="#h88-3-20" id="h88-3-20" class="d">-    private fun longToast(message: String) {
</a><a href="#h88-3-21" id="h88-3-21" class="d">-        Toast.makeText(this, message, Toast.LENGTH_LONG).show()
</a><a href="#h88-3-22" id="h88-3-22" class="i">+        SharedContext.config.writeConfig()
</a>     }
 
<a href="#h88-3-25" id="h88-3-25" class="d">-    private fun createTranslatedTextView(property: ConfigProperty, shouldTranslatePropertyValue: Boolean = true): TextView {
</a><a href="#h88-3-26" id="h88-3-26" class="d">-        return object: TextView(this) {
</a><a href="#h88-3-27" id="h88-3-27" class="d">-            override fun setText(text: CharSequence?, type: BufferType?) {
</a><a href="#h88-3-28" id="h88-3-28" class="d">-                val newText = text?.takeIf { it.isNotEmpty() }?.let {
</a><a href="#h88-3-29" id="h88-3-29" class="d">-                    if (!shouldTranslatePropertyValue || property.disableValueLocalization) it
</a><a href="#h88-3-30" id="h88-3-30" class="d">-                    else SharedContext.translation[&quot;option.property.&quot; + property.translationKey + &quot;.&quot; + it]
</a><a href="#h88-3-31" id="h88-3-31" class="d">-                }?.let {
</a><a href="#h88-3-32" id="h88-3-32" class="d">-                    if (it.length &gt; 20) {
</a><a href="#h88-3-33" id="h88-3-33" class="d">-                        it.substring(0, 20) + &quot;...&quot;
</a><a href="#h88-3-34" id="h88-3-34" class="d">-                    } else {
</a><a href="#h88-3-35" id="h88-3-35" class="d">-                        it
</a><a href="#h88-3-36" id="h88-3-36" class="d">-                    }
</a><a href="#h88-3-37" id="h88-3-37" class="d">-                } ?: &quot;&quot;
</a><a href="#h88-3-38" id="h88-3-38" class="d">-                super.setTextColor(getColor(R.color.tertiaryText))
</a><a href="#h88-3-39" id="h88-3-39" class="d">-                super.setText(newText, type)
</a><a href="#h88-3-40" id="h88-3-40" class="d">-            }
</a><a href="#h88-3-41" id="h88-3-41" class="d">-        }
</a><a href="#h88-3-42" id="h88-3-42" class="d">-    }
</a><a href="#h88-3-43" id="h88-3-43" class="d">-
</a><a href="#h88-3-44" id="h88-3-44" class="d">-    private fun askForValue(property: ConfigProperty, requestedInputType: Int, callback: (String) -&gt; Unit) {
</a><a href="#h88-3-45" id="h88-3-45" class="d">-        val editText = EditText(this).apply {
</a><a href="#h88-3-46" id="h88-3-46" class="d">-            inputType = requestedInputType
</a><a href="#h88-3-47" id="h88-3-47" class="d">-            setText(property.valueContainer.value().toString())
</a><a href="#h88-3-48" id="h88-3-48" class="d">-        }
</a><a href="#h88-3-49" id="h88-3-49" class="d">-        AlertDialog.Builder(this)
</a><a href="#h88-3-50" id="h88-3-50" class="d">-            .setTitle(SharedContext.translation[&quot;property.${property.translationKey}.name&quot;])
</a><a href="#h88-3-51" id="h88-3-51" class="d">-            .setView(editText)
</a><a href="#h88-3-52" id="h88-3-52" class="d">-            .setPositiveButton(positiveButtonText) { _, _ -&gt;
</a><a href="#h88-3-53" id="h88-3-53" class="d">-                callback(editText.text.toString())
</a><a href="#h88-3-54" id="h88-3-54" class="d">-            }
</a><a href="#h88-3-55" id="h88-3-55" class="d">-            .setNegativeButton(cancelButtonText) { dialog, _ -&gt;
</a><a href="#h88-3-56" id="h88-3-56" class="d">-                dialog.cancel()
</a><a href="#h88-3-57" id="h88-3-57" class="d">-            }
</a><a href="#h88-3-58" id="h88-3-58" class="d">-            .show()
</a><a href="#h88-3-59" id="h88-3-59" class="i">+    override fun onActivityResult(requestCode: Int, resultCode: Int, data: Intent?) {
</a><a href="#h88-3-60" id="h88-3-60" class="i">+        activityResultCallbacks[requestCode]?.invoke(requestCode, resultCode, data)
</a>     }
 
     override fun onCreate(savedInstanceState: Bundle?) {
         super.onCreate(savedInstanceState)
<a href="#h88-3-65" id="h88-3-65" class="d">-        config.loadFromContext(this)
</a>         SharedContext.ensureInitialized(this)
         setContentView(R.layout.config_activity)
 
<a href="#h88-4" id="h88-4" class="h">@@ -126,9 +85,37 @@ class ConfigActivity : Activity() {
</a>                 })
         }
 
<a href="#h88-4-3" id="h88-4-3" class="i">+        //check if save folder is set
</a><a href="#h88-4-4" id="h88-4-4" class="i">+        //TODO: first run activity
</a><a href="#h88-4-5" id="h88-4-5" class="i">+        run {
</a><a href="#h88-4-6" id="h88-4-6" class="i">+            val saveFolder = SharedContext.config.string(ConfigProperty.SAVE_FOLDER)
</a><a href="#h88-4-7" id="h88-4-7" class="i">+            val itemHelper = ItemHelper(this)
</a><a href="#h88-4-8" id="h88-4-8" class="i">+
</a><a href="#h88-4-9" id="h88-4-9" class="i">+            if (saveFolder.isEmpty() || !saveFolder.startsWith(&quot;content://&quot;)) {
</a><a href="#h88-4-10" id="h88-4-10" class="i">+                AlertDialog.Builder(this)
</a><a href="#h88-4-11" id="h88-4-11" class="i">+                    .setTitle(&quot;Save folder&quot;)
</a><a href="#h88-4-12" id="h88-4-12" class="i">+                    .setMessage(&quot;Please select a folder where you want to save downloaded files.&quot;)
</a><a href="#h88-4-13" id="h88-4-13" class="i">+                    .setPositiveButton(&quot;Select&quot;) { _, _ -&gt;
</a><a href="#h88-4-14" id="h88-4-14" class="i">+                        val (requestCode, callback) = itemHelper.askForFolder(
</a><a href="#h88-4-15" id="h88-4-15" class="i">+                            this,
</a><a href="#h88-4-16" id="h88-4-16" class="i">+                            ConfigProperty.SAVE_FOLDER
</a><a href="#h88-4-17" id="h88-4-17" class="i">+                        ) {}
</a><a href="#h88-4-18" id="h88-4-18" class="i">+                        activityResultCallbacks[requestCode] = { a1, a2, a3 -&gt;
</a><a href="#h88-4-19" id="h88-4-19" class="i">+                            callback(a1, a2, a3)
</a><a href="#h88-4-20" id="h88-4-20" class="i">+                            Toast.makeText(this, &quot;Save Folder set!&quot;, Toast.LENGTH_SHORT).show()
</a><a href="#h88-4-21" id="h88-4-21" class="i">+                            finish()
</a><a href="#h88-4-22" id="h88-4-22" class="i">+                        }
</a><a href="#h88-4-23" id="h88-4-23" class="i">+                    }
</a><a href="#h88-4-24" id="h88-4-24" class="i">+                    .setNegativeButton(&quot;Cancel&quot;) { _, _ -&gt;
</a><a href="#h88-4-25" id="h88-4-25" class="i">+                        exitProcess(0)
</a><a href="#h88-4-26" id="h88-4-26" class="i">+                    }
</a><a href="#h88-4-27" id="h88-4-27" class="i">+                    .show()
</a><a href="#h88-4-28" id="h88-4-28" class="i">+            }
</a><a href="#h88-4-29" id="h88-4-29" class="i">+        }
</a><a href="#h88-4-30" id="h88-4-30" class="i">+
</a>         var currentCategory: ConfigCategory? = null
 
<a href="#h88-4-33" id="h88-4-33" class="d">-        config.entries().forEach { (property, value) -&gt;
</a><a href="#h88-4-34" id="h88-4-34" class="i">+        SharedContext.config.entries().filter { !it.key.category.hidden }.forEach { (property, value) -&gt;
</a>             val configItem = layoutInflater.inflate(R.layout.config_activity_item, propertyListLayout, false)
 
             fun addSeparator() {
<a href="#h88-5" id="h88-5" class="h">@@ -140,6 +127,7 @@ class ConfigActivity : Activity() {
</a>             }
 
             if (property.category != currentCategory) {
<a href="#h88-5-3" id="h88-5-3" class="i">+                if(!property.shouldAppearInSettings) return@forEach
</a>                 currentCategory = property.category
                 with(layoutInflater.inflate(R.layout.config_activity_item, propertyListLayout, false)) {
                     findViewById&lt;TextView&gt;(R.id.name).apply {
<a href="#h88-6" id="h88-6" class="h">@@ -187,22 +175,32 @@ class ConfigActivity : Activity() {
</a>                     addValueView(switch)
                 }
                 is ConfigStringValue, is ConfigIntegerValue -&gt; {
<a href="#h88-6-3" id="h88-6-3" class="d">-                    val textView = createTranslatedTextView(property, shouldTranslatePropertyValue = false).also {
</a><a href="#h88-6-4" id="h88-6-4" class="i">+                    val textView = itemHelper.createTranslatedTextView(property, shouldTranslatePropertyValue = false).also {
</a>                         it.text = value.value().toString()
                     }
                     configItem.setOnClickListener {
<a href="#h88-6-8" id="h88-6-8" class="i">+                        if (value is ConfigStringValue &amp;&amp; value.isFolderPath) {
</a><a href="#h88-6-9" id="h88-6-9" class="i">+                            val (requestCode, callback) = itemHelper.askForFolder(this, property) {
</a><a href="#h88-6-10" id="h88-6-10" class="i">+                                value.writeFrom(it)
</a><a href="#h88-6-11" id="h88-6-11" class="i">+                                textView.text = value.value()
</a><a href="#h88-6-12" id="h88-6-12" class="i">+                            }
</a><a href="#h88-6-13" id="h88-6-13" class="i">+
</a><a href="#h88-6-14" id="h88-6-14" class="i">+                            activityResultCallbacks[requestCode] = callback
</a><a href="#h88-6-15" id="h88-6-15" class="i">+                            return@setOnClickListener
</a><a href="#h88-6-16" id="h88-6-16" class="i">+                        }
</a><a href="#h88-6-17" id="h88-6-17" class="i">+
</a>                         if (value is ConfigIntegerValue) {
<a href="#h88-6-19" id="h88-6-19" class="d">-                            askForValue(property, InputType.TYPE_CLASS_NUMBER) {
</a><a href="#h88-6-20" id="h88-6-20" class="i">+                            itemHelper.askForValue(property, InputType.TYPE_CLASS_NUMBER) {
</a>                                 try {
                                     value.writeFrom(it)
                                     textView.text = value.value().toString()
                                 } catch (e: NumberFormatException) {
<a href="#h88-6-25" id="h88-6-25" class="d">-                                    longToast(SharedContext.translation[&quot;config_activity.invalid_number_toast&quot;])
</a><a href="#h88-6-26" id="h88-6-26" class="i">+                                    itemHelper.longToast(SharedContext.translation[&quot;config_activity.invalid_number_toast&quot;], this)
</a>                                 }
                             }
                             return@setOnClickListener
                         }
<a href="#h88-6-31" id="h88-6-31" class="d">-                        askForValue(property, InputType.TYPE_CLASS_TEXT) {
</a><a href="#h88-6-32" id="h88-6-32" class="i">+                        itemHelper.askForValue(property, InputType.TYPE_CLASS_TEXT) {
</a>                             value.writeFrom(it)
                             textView.text = value.value().toString()
                         }
<a href="#h88-7" id="h88-7" class="h">@@ -210,7 +208,7 @@ class ConfigActivity : Activity() {
</a>                     addValueView(textView)
                 }
                 is ConfigStateListValue -&gt; {
<a href="#h88-7-3" id="h88-7-3" class="d">-                    val textView = createTranslatedTextView(property, shouldTranslatePropertyValue = false)
</a><a href="#h88-7-4" id="h88-7-4" class="i">+                    val textView = itemHelper.createTranslatedTextView(property, shouldTranslatePropertyValue = false)
</a>                     val values = value.value()
 
                     fun updateText() {
<a href="#h88-8" id="h88-8" class="h">@@ -222,13 +220,13 @@ class ConfigActivity : Activity() {
</a>                     configItem.setOnClickListener {
                         AlertDialog.Builder(this)
                             .setTitle(propertyName)
<a href="#h88-8-3" id="h88-8-3" class="d">-                            .setPositiveButton(positiveButtonText) { _, _ -&gt;
</a><a href="#h88-8-4" id="h88-8-4" class="i">+                            .setPositiveButton(itemHelper.positiveButtonText) { _, _ -&gt;
</a>                                 updateText()
                             }
                             .setMultiChoiceItems(
                                 values.keys.map {
                                     if (property.disableValueLocalization) it
<a href="#h88-8-10" id="h88-8-10" class="d">-                                    else SharedContext.translation[&quot;option.property.&quot; + property.translationKey + &quot;.&quot; + it]
</a><a href="#h88-8-11" id="h88-8-11" class="i">+                                    else SharedContext.translation[property.getOptionTranslationKey(it)]
</a>                                 }.toTypedArray(),
                                 values.map { it.value }.toBooleanArray()
                             ) { _, which, isChecked -&gt;
<a href="#h88-9" id="h88-9" class="h">@@ -240,7 +238,7 @@ class ConfigActivity : Activity() {
</a>                     addValueView(textView)
                 }
                 is ConfigStateSelection -&gt; {
<a href="#h88-9-3" id="h88-9-3" class="d">-                    val textView = createTranslatedTextView(property, shouldTranslatePropertyValue = true)
</a><a href="#h88-9-4" id="h88-9-4" class="i">+                    val textView = itemHelper.createTranslatedTextView(property, shouldTranslatePropertyValue = true)
</a>                     textView.text = value.value()
 
                     configItem.setOnClickListener {
<a href="#h88-10" id="h88-10" class="h">@@ -250,14 +248,14 @@ class ConfigActivity : Activity() {
</a>                         builder.setSingleChoiceItems(
                             value.keys().toTypedArray().map {
                                 if (property.disableValueLocalization) it
<a href="#h88-10-3" id="h88-10-3" class="d">-                                else SharedContext.translation[&quot;option.property.&quot; + property.translationKey + &quot;.&quot; + it]
</a><a href="#h88-10-4" id="h88-10-4" class="i">+                                else SharedContext.translation[property.getOptionTranslationKey(it)]
</a>                             }.toTypedArray(),
                             value.keys().indexOf(value.value())
                         ) { _, which -&gt;
                             value.writeFrom(value.keys()[which])
                         }
 
<a href="#h88-10-11" id="h88-10-11" class="d">-                        builder.setPositiveButton(positiveButtonText) { _, _ -&gt;
</a><a href="#h88-10-12" id="h88-10-12" class="i">+                        builder.setPositiveButton(itemHelper.positiveButtonText) { _, _ -&gt;
</a>                             textView.text = value.value()
                         }
 
<b>diff --git a/<a id="h89" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/download/DebugSettingsLayoutInflater.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/download/DebugSettingsLayoutInflater.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/download/DebugSettingsLayoutInflater.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/download/DebugSettingsLayoutInflater.kt</a></b>
<a href="#h89-0" id="h89-0" class="h">@@ -11,8 +11,9 @@ import android.widget.TextView
</a> import android.widget.Toast
 import me.rhunk.snapenhance.R
 import me.rhunk.snapenhance.SharedContext
<a href="#h89-0-3" id="h89-0-3" class="d">-import me.rhunk.snapenhance.bridge.common.impl.file.BridgeFileType
</a><a href="#h89-0-4" id="h89-0-4" class="i">+import me.rhunk.snapenhance.bridge.types.BridgeFileType
</a> import me.rhunk.snapenhance.ui.config.ConfigActivity
<a href="#h89-0-6" id="h89-0-6" class="i">+import me.rhunk.snapenhance.ui.spoof.DeviceSpooferActivity
</a> import java.io.File
 
 class ActionListAdapter(
<a href="#h89-1" id="h89-1" class="h">@@ -70,6 +71,9 @@ class DebugSettingsLayoutInflater(
</a>                 add(SharedContext.translation[&quot;config_activity.title&quot;] to {
                     activity.startActivity(Intent(activity, ConfigActivity::class.java))
                 })
<a href="#h89-1-3" id="h89-1-3" class="i">+                add(SharedContext.translation[&quot;spoof_activity.title&quot;] to {
</a><a href="#h89-1-4" id="h89-1-4" class="i">+                    activity.startActivity(Intent(activity, DeviceSpooferActivity::class.java))
</a><a href="#h89-1-5" id="h89-1-5" class="i">+                })
</a>                 add(debugSettingsTranslation[&quot;clear_cache_title&quot;] to {
                     context.cacheDir.listFiles()?.forEach {
                         it.deleteRecursively()
<b>diff --git a/<a id="h90" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/download/DownloadListAdapter.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/download/DownloadListAdapter.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/download/DownloadListAdapter.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/download/DownloadListAdapter.kt</a></b>
<a href="#h90-0" id="h90-0" class="h">@@ -1,5 +1,6 @@
</a> package me.rhunk.snapenhance.ui.download
 
<a href="#h90-0-2" id="h90-0-2" class="i">+import android.annotation.SuppressLint
</a> import android.content.Intent
 import android.graphics.Bitmap
 import android.graphics.BitmapFactory
<a href="#h90-1" id="h90-1" class="h">@@ -15,12 +16,13 @@ import android.widget.Toast
</a> import androidx.core.graphics.drawable.RoundedBitmapDrawableFactory
 import androidx.recyclerview.widget.RecyclerView
 import androidx.recyclerview.widget.RecyclerView.Adapter
<a href="#h90-1-3" id="h90-1-3" class="d">-import kotlinx.coroutines.DelicateCoroutinesApi
</a><a href="#h90-1-4" id="h90-1-4" class="i">+import kotlinx.coroutines.CoroutineScope
</a> import kotlinx.coroutines.Dispatchers
<a href="#h90-1-6" id="h90-1-6" class="d">-import kotlinx.coroutines.GlobalScope
</a> import kotlinx.coroutines.Job
 import kotlinx.coroutines.job
 import kotlinx.coroutines.launch
<a href="#h90-1-10" id="h90-1-10" class="i">+import kotlinx.coroutines.withTimeout
</a><a href="#h90-1-11" id="h90-1-11" class="i">+import me.rhunk.snapenhance.Logger
</a> import me.rhunk.snapenhance.R
 import me.rhunk.snapenhance.SharedContext
 import me.rhunk.snapenhance.data.FileType
<a href="#h90-2" id="h90-2" class="h">@@ -28,13 +30,16 @@ import me.rhunk.snapenhance.download.data.PendingDownload
</a> import me.rhunk.snapenhance.download.enums.DownloadStage
 import me.rhunk.snapenhance.util.snap.PreviewUtils
 import java.io.File
<a href="#h90-2-3" id="h90-2-3" class="i">+import java.io.FileInputStream
</a> import java.net.URL
 import kotlin.concurrent.thread
<a href="#h90-2-6" id="h90-2-6" class="i">+import kotlin.coroutines.coroutineContext
</a> 
 class DownloadListAdapter(
     private val activity: DownloadManagerActivity,
     private val downloadList: MutableList&lt;PendingDownload&gt;
 ): Adapter&lt;DownloadListAdapter.ViewHolder&gt;() {
<a href="#h90-2-12" id="h90-2-12" class="i">+    private val coroutineScope = CoroutineScope(Dispatchers.IO)
</a>     private val previewJobs = mutableMapOf&lt;Int, Job&gt;()
 
     inner class ViewHolder(val view: View) : RecyclerView.ViewHolder(view) {
<a href="#h90-3" id="h90-3" class="h">@@ -62,32 +67,59 @@ class DownloadListAdapter(
</a>         return downloadList.size
     }
 
<a href="#h90-3-3" id="h90-3-3" class="d">-    @OptIn(DelicateCoroutinesApi::class)
</a><a href="#h90-3-4" id="h90-3-4" class="d">-    private fun handlePreview(download: PendingDownload, holder: ViewHolder) {
</a><a href="#h90-3-5" id="h90-3-5" class="d">-        download.outputFile?.let { File(it) }?.takeIf { it.exists() }?.let {
</a><a href="#h90-3-6" id="h90-3-6" class="d">-            GlobalScope.launch(Dispatchers.IO) {
</a><a href="#h90-3-7" id="h90-3-7" class="d">-                val previewBitmap = PreviewUtils.createPreviewFromFile(it)?.let { preview -&gt;
</a><a href="#h90-3-8" id="h90-3-8" class="d">-                    val offsetY = (preview.height / 2 - holder.viewHeight / 2).coerceAtLeast(0)
</a><a href="#h90-3-9" id="h90-3-9" class="d">-
</a><a href="#h90-3-10" id="h90-3-10" class="d">-                    Bitmap.createScaledBitmap(
</a><a href="#h90-3-11" id="h90-3-11" class="d">-                        Bitmap.createBitmap(preview, 0, offsetY,
</a><a href="#h90-3-12" id="h90-3-12" class="d">-                            preview.width.coerceAtMost(holder.viewWidth),
</a><a href="#h90-3-13" id="h90-3-13" class="d">-                            preview.height.coerceAtMost(holder.viewHeight)
</a><a href="#h90-3-14" id="h90-3-14" class="d">-                        ),
</a><a href="#h90-3-15" id="h90-3-15" class="d">-                        holder.viewWidth,
</a><a href="#h90-3-16" id="h90-3-16" class="d">-                        holder.viewHeight,
</a><a href="#h90-3-17" id="h90-3-17" class="d">-                        false
</a><a href="#h90-3-18" id="h90-3-18" class="d">-                    )
</a><a href="#h90-3-19" id="h90-3-19" class="d">-                }?: return@launch
</a><a href="#h90-3-20" id="h90-3-20" class="d">-
</a><a href="#h90-3-21" id="h90-3-21" class="d">-                if (coroutineContext.job.isCancelled) return@launch
</a><a href="#h90-3-22" id="h90-3-22" class="d">-                Handler(holder.view.context.mainLooper).post {
</a><a href="#h90-3-23" id="h90-3-23" class="d">-                    holder.view.background = RoundedBitmapDrawableFactory.create(holder.view.context.resources, previewBitmap).also {
</a><a href="#h90-3-24" id="h90-3-24" class="d">-                        it.cornerRadius = holder.radius.toFloat()
</a><a href="#h90-3-25" id="h90-3-25" class="i">+    @SuppressLint(&quot;Recycle&quot;)
</a><a href="#h90-3-26" id="h90-3-26" class="i">+    private suspend fun handlePreview(download: PendingDownload, holder: ViewHolder) {
</a><a href="#h90-3-27" id="h90-3-27" class="i">+        download.outputFile?.let {
</a><a href="#h90-3-28" id="h90-3-28" class="i">+            val uri = Uri.parse(it)
</a><a href="#h90-3-29" id="h90-3-29" class="i">+            runCatching {
</a><a href="#h90-3-30" id="h90-3-30" class="i">+                if (uri.scheme == &quot;content&quot;) {
</a><a href="#h90-3-31" id="h90-3-31" class="i">+                    val fileType = activity.contentResolver.openInputStream(uri)!!.use { stream -&gt;
</a><a href="#h90-3-32" id="h90-3-32" class="i">+                        FileType.fromInputStream(stream)
</a>                     }
<a href="#h90-3-34" id="h90-3-34" class="i">+                    fileType to activity.contentResolver.openInputStream(uri)
</a><a href="#h90-3-35" id="h90-3-35" class="i">+                } else {
</a><a href="#h90-3-36" id="h90-3-36" class="i">+                    FileType.fromFile(File(it)) to FileInputStream(it)
</a><a href="#h90-3-37" id="h90-3-37" class="i">+                }
</a><a href="#h90-3-38" id="h90-3-38" class="i">+            }.getOrNull()
</a><a href="#h90-3-39" id="h90-3-39" class="i">+        }?.also { (fileType, assetStream) -&gt;
</a><a href="#h90-3-40" id="h90-3-40" class="i">+            val previewBitmap = assetStream?.use { stream -&gt;
</a><a href="#h90-3-41" id="h90-3-41" class="i">+                //don&#39;t preview files larger than 30MB
</a><a href="#h90-3-42" id="h90-3-42" class="i">+                if (stream.available() &gt; 30 * 1024 * 1024) return@also
</a><a href="#h90-3-43" id="h90-3-43" class="i">+
</a><a href="#h90-3-44" id="h90-3-44" class="i">+                val tempFile = File.createTempFile(&quot;preview&quot;, &quot;.${fileType.fileExtension}&quot;)
</a><a href="#h90-3-45" id="h90-3-45" class="i">+                tempFile.outputStream().use { output -&gt;
</a><a href="#h90-3-46" id="h90-3-46" class="i">+                    stream.copyTo(output)
</a><a href="#h90-3-47" id="h90-3-47" class="i">+                }
</a><a href="#h90-3-48" id="h90-3-48" class="i">+                runCatching {
</a><a href="#h90-3-49" id="h90-3-49" class="i">+                    PreviewUtils.createPreviewFromFile(tempFile)?.let { preview -&gt;
</a><a href="#h90-3-50" id="h90-3-50" class="i">+                        val offsetY = (preview.height / 2 - holder.viewHeight / 2).coerceAtLeast(0)
</a><a href="#h90-3-51" id="h90-3-51" class="i">+
</a><a href="#h90-3-52" id="h90-3-52" class="i">+                        Bitmap.createScaledBitmap(
</a><a href="#h90-3-53" id="h90-3-53" class="i">+                            Bitmap.createBitmap(
</a><a href="#h90-3-54" id="h90-3-54" class="i">+                                preview, 0, offsetY,
</a><a href="#h90-3-55" id="h90-3-55" class="i">+                                preview.width.coerceAtMost(holder.viewWidth),
</a><a href="#h90-3-56" id="h90-3-56" class="i">+                                preview.height.coerceAtMost(holder.viewHeight)
</a><a href="#h90-3-57" id="h90-3-57" class="i">+                            ),
</a><a href="#h90-3-58" id="h90-3-58" class="i">+                            holder.viewWidth,
</a><a href="#h90-3-59" id="h90-3-59" class="i">+                            holder.viewHeight,
</a><a href="#h90-3-60" id="h90-3-60" class="i">+                            false
</a><a href="#h90-3-61" id="h90-3-61" class="i">+                        )
</a><a href="#h90-3-62" id="h90-3-62" class="i">+                    }
</a><a href="#h90-3-63" id="h90-3-63" class="i">+                }.onFailure {
</a><a href="#h90-3-64" id="h90-3-64" class="i">+                    Logger.error(&quot;failed to create preview $fileType&quot;, it)
</a><a href="#h90-3-65" id="h90-3-65" class="i">+                }.also {
</a><a href="#h90-3-66" id="h90-3-66" class="i">+                    tempFile.delete()
</a><a href="#h90-3-67" id="h90-3-67" class="i">+                }.getOrNull()
</a><a href="#h90-3-68" id="h90-3-68" class="i">+            } ?: return@also
</a><a href="#h90-3-69" id="h90-3-69" class="i">+
</a><a href="#h90-3-70" id="h90-3-70" class="i">+            if (coroutineContext.job.isCancelled) return@also
</a><a href="#h90-3-71" id="h90-3-71" class="i">+            Handler(holder.view.context.mainLooper).post {
</a><a href="#h90-3-72" id="h90-3-72" class="i">+                holder.view.background = RoundedBitmapDrawableFactory.create(
</a><a href="#h90-3-73" id="h90-3-73" class="i">+                    holder.view.context.resources,
</a><a href="#h90-3-74" id="h90-3-74" class="i">+                    previewBitmap
</a><a href="#h90-3-75" id="h90-3-75" class="i">+                ).also {
</a><a href="#h90-3-76" id="h90-3-76" class="i">+                    it.cornerRadius = holder.radius.toFloat()
</a>                 }
<a href="#h90-3-78" id="h90-3-78" class="d">-            }.also { job -&gt;
</a><a href="#h90-3-79" id="h90-3-79" class="d">-                previewJobs[holder.hashCode()] = job
</a>             }
         }
     }
<a href="#h90-4" id="h90-4" class="h">@@ -96,7 +128,11 @@ class DownloadListAdapter(
</a>         holder.status.text = download.downloadStage.toString()
         holder.view.background = holder.view.context.getDrawable(R.drawable.download_manager_item_background)
 
<a href="#h90-4-3" id="h90-4-3" class="d">-        handlePreview(download, holder)
</a><a href="#h90-4-4" id="h90-4-4" class="i">+        coroutineScope.launch {
</a><a href="#h90-4-5" id="h90-4-5" class="i">+            withTimeout(2000) {
</a><a href="#h90-4-6" id="h90-4-6" class="i">+                handlePreview(download, holder)
</a><a href="#h90-4-7" id="h90-4-7" class="i">+            }
</a><a href="#h90-4-8" id="h90-4-8" class="i">+        }
</a> 
         val isSaved = download.downloadStage == DownloadStage.SAVED
         //if the download is in progress, the user can cancel it
<a href="#h90-5" id="h90-5" class="h">@@ -129,7 +165,7 @@ class DownloadListAdapter(
</a> 
         holder.bitmojiIcon.setImageResource(R.drawable.bitmoji_blank)
 
<a href="#h90-5-3" id="h90-5-3" class="d">-        pendingDownload.iconUrl?.let { url -&gt;
</a><a href="#h90-5-4" id="h90-5-4" class="i">+        pendingDownload.metadata.iconUrl?.let { url -&gt;
</a>             thread(start = true) {
                 runCatching {
                     val iconBitmap = URL(url).openStream().use {
<a href="#h90-6" id="h90-6" class="h">@@ -145,12 +181,12 @@ class DownloadListAdapter(
</a>         holder.title.visibility = View.GONE
         holder.subtitle.visibility = View.GONE
 
<a href="#h90-6-3" id="h90-6-3" class="d">-        pendingDownload.mediaDisplayType?.let {
</a><a href="#h90-6-4" id="h90-6-4" class="i">+        pendingDownload.metadata.mediaDisplayType?.let {
</a>             holder.title.text = it
             holder.title.visibility = View.VISIBLE
         }
 
<a href="#h90-6-9" id="h90-6-9" class="d">-        pendingDownload.mediaDisplaySource?.let {
</a><a href="#h90-6-10" id="h90-6-10" class="i">+        pendingDownload.metadata.mediaDisplaySource?.let {
</a>             holder.subtitle.text = it
             holder.subtitle.visibility = View.VISIBLE
         }
<a href="#h90-7" id="h90-7" class="h">@@ -165,13 +201,38 @@ class DownloadListAdapter(
</a>             }
 
             pendingDownload.outputFile?.let {
<a href="#h90-7-3" id="h90-7-3" class="d">-                val file = File(it)
</a><a href="#h90-7-4" id="h90-7-4" class="d">-                if (!file.exists()) {
</a><a href="#h90-7-5" id="h90-7-5" class="d">-                    Toast.makeText(holder.view.context, activity.translation[&quot;file_not_found_toast&quot;], Toast.LENGTH_SHORT).show()
</a><a href="#h90-7-6" id="h90-7-6" class="i">+                fun showFileNotFound() {
</a><a href="#h90-7-7" id="h90-7-7" class="i">+                    Toast.makeText(holder.view.context, SharedContext.translation[&quot;download_manager_activity.file_not_found_toast&quot;], Toast.LENGTH_SHORT).show()
</a><a href="#h90-7-8" id="h90-7-8" class="i">+                }
</a><a href="#h90-7-9" id="h90-7-9" class="i">+
</a><a href="#h90-7-10" id="h90-7-10" class="i">+                val uri = Uri.parse(it)
</a><a href="#h90-7-11" id="h90-7-11" class="i">+                val fileType = runCatching {
</a><a href="#h90-7-12" id="h90-7-12" class="i">+                    if (uri.scheme == &quot;content&quot;) {
</a><a href="#h90-7-13" id="h90-7-13" class="i">+                        activity.contentResolver.openInputStream(uri)?.use { input -&gt;
</a><a href="#h90-7-14" id="h90-7-14" class="i">+                            FileType.fromInputStream(input)
</a><a href="#h90-7-15" id="h90-7-15" class="i">+                        } ?: run {
</a><a href="#h90-7-16" id="h90-7-16" class="i">+                            showFileNotFound()
</a><a href="#h90-7-17" id="h90-7-17" class="i">+                            return@setOnClickListener
</a><a href="#h90-7-18" id="h90-7-18" class="i">+                        }
</a><a href="#h90-7-19" id="h90-7-19" class="i">+                    } else {
</a><a href="#h90-7-20" id="h90-7-20" class="i">+                        val file = File(it)
</a><a href="#h90-7-21" id="h90-7-21" class="i">+                        if (!file.exists()) {
</a><a href="#h90-7-22" id="h90-7-22" class="i">+                            showFileNotFound()
</a><a href="#h90-7-23" id="h90-7-23" class="i">+                            return@setOnClickListener
</a><a href="#h90-7-24" id="h90-7-24" class="i">+                        }
</a><a href="#h90-7-25" id="h90-7-25" class="i">+                        FileType.fromFile(file)
</a><a href="#h90-7-26" id="h90-7-26" class="i">+                    }
</a><a href="#h90-7-27" id="h90-7-27" class="i">+                }.onFailure { exception -&gt;
</a><a href="#h90-7-28" id="h90-7-28" class="i">+                    Logger.error(&quot;Failed to open file&quot;, exception)
</a><a href="#h90-7-29" id="h90-7-29" class="i">+                }.getOrDefault(FileType.UNKNOWN)
</a><a href="#h90-7-30" id="h90-7-30" class="i">+                if (fileType == FileType.UNKNOWN) {
</a><a href="#h90-7-31" id="h90-7-31" class="i">+                    showFileNotFound()
</a>                     return@setOnClickListener
                 }
<a href="#h90-7-34" id="h90-7-34" class="i">+
</a>                 val intent = Intent(Intent.ACTION_VIEW)
<a href="#h90-7-36" id="h90-7-36" class="d">-                intent.setDataAndType(Uri.parse(it), FileType.fromFile(File(it)).mimeType)
</a><a href="#h90-7-37" id="h90-7-37" class="i">+                intent.flags = Intent.FLAG_ACTIVITY_NEW_TASK or Intent.FLAG_GRANT_READ_URI_PERMISSION
</a><a href="#h90-7-38" id="h90-7-38" class="i">+                intent.setDataAndType(uri, fileType.mimeType)
</a>                 holder.view.context.startActivity(intent)
             }
         }
<b>diff --git a/<a id="h91" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/download/DownloadManagerActivity.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/download/DownloadManagerActivity.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/download/DownloadManagerActivity.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/download/DownloadManagerActivity.kt</a></b>
<a href="#h91-0" id="h91-0" class="h">@@ -17,8 +17,8 @@ import androidx.recyclerview.widget.ItemTouchHelper
</a> import androidx.recyclerview.widget.RecyclerView
 import me.rhunk.snapenhance.BuildConfig
 import me.rhunk.snapenhance.R
<a href="#h91-0-3" id="h91-0-3" class="d">-import me.rhunk.snapenhance.bridge.TranslationWrapper
</a> import me.rhunk.snapenhance.SharedContext
<a href="#h91-0-5" id="h91-0-5" class="i">+import me.rhunk.snapenhance.bridge.wrapper.TranslationWrapper
</a> import me.rhunk.snapenhance.download.data.PendingDownload
 
 class DownloadManagerActivity : Activity() {
<a href="#h91-1" id="h91-1" class="h">@@ -133,7 +133,7 @@ class DownloadManagerActivity : Activity() {
</a>                     if (lastVisibleItemPosition == fetchedDownloadTasks.size - 1 &amp;&amp; !isLoading) {
                         isLoading = true
 
<a href="#h91-1-3" id="h91-1-3" class="d">-                        SharedContext.downloadTaskManager.queryTasks(fetchedDownloadTasks.last().id, filter = listFilter).forEach {
</a><a href="#h91-1-4" id="h91-1-4" class="i">+                        SharedContext.downloadTaskManager.queryTasks(fetchedDownloadTasks.last().downloadId, filter = listFilter).forEach {
</a>                             fetchedDownloadTasks.add(it.value)
                             adapter?.notifyItemInserted(fetchedDownloadTasks.size - 1)
                         }
<b>diff --git a/<a id="h92" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/menu/ViewAppearanceHelper.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/menu/ViewAppearanceHelper.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/menu/ViewAppearanceHelper.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/menu/ViewAppearanceHelper.kt</a></b>
<a href="#h92-0" id="h92-0" class="h">@@ -1,93 +0,0 @@
</a><a href="#h92-0-0" id="h92-0-0" class="d">-package me.rhunk.snapenhance.ui.menu
</a><a href="#h92-0-1" id="h92-0-1" class="d">-
</a><a href="#h92-0-2" id="h92-0-2" class="d">-import android.annotation.SuppressLint
</a><a href="#h92-0-3" id="h92-0-3" class="d">-import android.content.res.ColorStateList
</a><a href="#h92-0-4" id="h92-0-4" class="d">-import android.graphics.Color
</a><a href="#h92-0-5" id="h92-0-5" class="d">-import android.graphics.drawable.ColorDrawable
</a><a href="#h92-0-6" id="h92-0-6" class="d">-import android.graphics.drawable.Drawable
</a><a href="#h92-0-7" id="h92-0-7" class="d">-import android.graphics.drawable.ShapeDrawable
</a><a href="#h92-0-8" id="h92-0-8" class="d">-import android.graphics.drawable.StateListDrawable
</a><a href="#h92-0-9" id="h92-0-9" class="d">-import android.view.Gravity
</a><a href="#h92-0-10" id="h92-0-10" class="d">-import android.view.View
</a><a href="#h92-0-11" id="h92-0-11" class="d">-import android.widget.Switch
</a><a href="#h92-0-12" id="h92-0-12" class="d">-import android.widget.TextView
</a><a href="#h92-0-13" id="h92-0-13" class="d">-import me.rhunk.snapenhance.Constants
</a><a href="#h92-0-14" id="h92-0-14" class="d">-
</a><a href="#h92-0-15" id="h92-0-15" class="d">-object ViewAppearanceHelper {
</a><a href="#h92-0-16" id="h92-0-16" class="d">-    @SuppressLint(&quot;UseSwitchCompatOrMaterialCode&quot;, &quot;RtlHardcoded&quot;, &quot;DiscouragedApi&quot;,
</a><a href="#h92-0-17" id="h92-0-17" class="d">-        &quot;ClickableViewAccessibility&quot;
</a><a href="#h92-0-18" id="h92-0-18" class="d">-    )
</a><a href="#h92-0-19" id="h92-0-19" class="d">-    private var sigColorTextPrimary: Int = 0
</a><a href="#h92-0-20" id="h92-0-20" class="d">-    private var sigColorBackgroundSurface: Int = 0
</a><a href="#h92-0-21" id="h92-0-21" class="d">-
</a><a href="#h92-0-22" id="h92-0-22" class="d">-    private fun createRoundedBackground(color: Int, hasRadius: Boolean): Drawable {
</a><a href="#h92-0-23" id="h92-0-23" class="d">-        if (!hasRadius) return ColorDrawable(color)
</a><a href="#h92-0-24" id="h92-0-24" class="d">-        //FIXME: hardcoded radius
</a><a href="#h92-0-25" id="h92-0-25" class="d">-        return ShapeDrawable().apply {
</a><a href="#h92-0-26" id="h92-0-26" class="d">-            paint.color = color
</a><a href="#h92-0-27" id="h92-0-27" class="d">-            shape = android.graphics.drawable.shapes.RoundRectShape(
</a><a href="#h92-0-28" id="h92-0-28" class="d">-                floatArrayOf(20f, 20f, 20f, 20f, 20f, 20f, 20f, 20f),
</a><a href="#h92-0-29" id="h92-0-29" class="d">-                null,
</a><a href="#h92-0-30" id="h92-0-30" class="d">-                null
</a><a href="#h92-0-31" id="h92-0-31" class="d">-            )
</a><a href="#h92-0-32" id="h92-0-32" class="d">-        }
</a><a href="#h92-0-33" id="h92-0-33" class="d">-    }
</a><a href="#h92-0-34" id="h92-0-34" class="d">-
</a><a href="#h92-0-35" id="h92-0-35" class="d">-    @SuppressLint(&quot;DiscouragedApi&quot;)
</a><a href="#h92-0-36" id="h92-0-36" class="d">-    fun applyTheme(component: View, componentWidth: Int? = null, hasRadius: Boolean = false) {
</a><a href="#h92-0-37" id="h92-0-37" class="d">-        val resources = component.context.resources
</a><a href="#h92-0-38" id="h92-0-38" class="d">-        if (sigColorBackgroundSurface == 0 || sigColorTextPrimary == 0) {
</a><a href="#h92-0-39" id="h92-0-39" class="d">-            with(component.context.theme) {
</a><a href="#h92-0-40" id="h92-0-40" class="d">-                sigColorTextPrimary = obtainStyledAttributes(
</a><a href="#h92-0-41" id="h92-0-41" class="d">-                    intArrayOf(resources.getIdentifier(&quot;sigColorTextPrimary&quot;, &quot;attr&quot;, Constants.SNAPCHAT_PACKAGE_NAME))
</a><a href="#h92-0-42" id="h92-0-42" class="d">-                ).getColor(0, 0)
</a><a href="#h92-0-43" id="h92-0-43" class="d">-
</a><a href="#h92-0-44" id="h92-0-44" class="d">-                sigColorBackgroundSurface = obtainStyledAttributes(
</a><a href="#h92-0-45" id="h92-0-45" class="d">-                    intArrayOf(resources.getIdentifier(&quot;sigColorBackgroundSurface&quot;, &quot;attr&quot;, Constants.SNAPCHAT_PACKAGE_NAME))
</a><a href="#h92-0-46" id="h92-0-46" class="d">-                ).getColor(0, 0)
</a><a href="#h92-0-47" id="h92-0-47" class="d">-            }
</a><a href="#h92-0-48" id="h92-0-48" class="d">-        }
</a><a href="#h92-0-49" id="h92-0-49" class="d">-
</a><a href="#h92-0-50" id="h92-0-50" class="d">-        val snapchatFontResId = resources.getIdentifier(&quot;avenir_next_medium&quot;, &quot;font&quot;, &quot;com.snapchat.android&quot;)
</a><a href="#h92-0-51" id="h92-0-51" class="d">-        val scalingFactor = resources.displayMetrics.densityDpi.toDouble() / 400
</a><a href="#h92-0-52" id="h92-0-52" class="d">-
</a><a href="#h92-0-53" id="h92-0-53" class="d">-        with(component) {
</a><a href="#h92-0-54" id="h92-0-54" class="d">-            if (this is TextView) {
</a><a href="#h92-0-55" id="h92-0-55" class="d">-                setTextColor(sigColorTextPrimary)
</a><a href="#h92-0-56" id="h92-0-56" class="d">-                setShadowLayer(0F, 0F, 0F, 0)
</a><a href="#h92-0-57" id="h92-0-57" class="d">-                gravity = Gravity.CENTER_VERTICAL
</a><a href="#h92-0-58" id="h92-0-58" class="d">-                componentWidth?.let { width = it}
</a><a href="#h92-0-59" id="h92-0-59" class="d">-                height = (150 * scalingFactor).toInt()
</a><a href="#h92-0-60" id="h92-0-60" class="d">-                isAllCaps = false
</a><a href="#h92-0-61" id="h92-0-61" class="d">-                textSize = 16f
</a><a href="#h92-0-62" id="h92-0-62" class="d">-                typeface = resources.getFont(snapchatFontResId)
</a><a href="#h92-0-63" id="h92-0-63" class="d">-                outlineProvider = null
</a><a href="#h92-0-64" id="h92-0-64" class="d">-                setPadding((40 * scalingFactor).toInt(), 0, (40 * scalingFactor).toInt(), 0)
</a><a href="#h92-0-65" id="h92-0-65" class="d">-            }
</a><a href="#h92-0-66" id="h92-0-66" class="d">-            background = StateListDrawable().apply {
</a><a href="#h92-0-67" id="h92-0-67" class="d">-                addState(intArrayOf(), createRoundedBackground(color = sigColorBackgroundSurface, hasRadius))
</a><a href="#h92-0-68" id="h92-0-68" class="d">-                addState(intArrayOf(android.R.attr.state_pressed), createRoundedBackground(color = 0x5395026, hasRadius))
</a><a href="#h92-0-69" id="h92-0-69" class="d">-            }
</a><a href="#h92-0-70" id="h92-0-70" class="d">-        }
</a><a href="#h92-0-71" id="h92-0-71" class="d">-
</a><a href="#h92-0-72" id="h92-0-72" class="d">-        if (component is Switch) {
</a><a href="#h92-0-73" id="h92-0-73" class="d">-            with(resources) {
</a><a href="#h92-0-74" id="h92-0-74" class="d">-                component.switchMinWidth = getDimension(getIdentifier(&quot;v11_switch_min_width&quot;, &quot;dimen&quot;, Constants.SNAPCHAT_PACKAGE_NAME)).toInt()
</a><a href="#h92-0-75" id="h92-0-75" class="d">-            }
</a><a href="#h92-0-76" id="h92-0-76" class="d">-            component.trackTintList = ColorStateList(
</a><a href="#h92-0-77" id="h92-0-77" class="d">-                arrayOf(intArrayOf(-android.R.attr.state_checked), intArrayOf(android.R.attr.state_checked)
</a><a href="#h92-0-78" id="h92-0-78" class="d">-                ), intArrayOf(
</a><a href="#h92-0-79" id="h92-0-79" class="d">-                    Color.parseColor(&quot;#1d1d1d&quot;),
</a><a href="#h92-0-80" id="h92-0-80" class="d">-                    Color.parseColor(&quot;#26bd49&quot;)
</a><a href="#h92-0-81" id="h92-0-81" class="d">-                )
</a><a href="#h92-0-82" id="h92-0-82" class="d">-            )
</a><a href="#h92-0-83" id="h92-0-83" class="d">-            component.thumbTintList = ColorStateList(
</a><a href="#h92-0-84" id="h92-0-84" class="d">-                arrayOf(intArrayOf(-android.R.attr.state_checked), intArrayOf(android.R.attr.state_checked)
</a><a href="#h92-0-85" id="h92-0-85" class="d">-                ), intArrayOf(
</a><a href="#h92-0-86" id="h92-0-86" class="d">-                    Color.parseColor(&quot;#F5F5F5&quot;),
</a><a href="#h92-0-87" id="h92-0-87" class="d">-                    Color.parseColor(&quot;#26bd49&quot;)
</a><a href="#h92-0-88" id="h92-0-88" class="d">-                )
</a><a href="#h92-0-89" id="h92-0-89" class="d">-            )
</a><a href="#h92-0-90" id="h92-0-90" class="d">-        }
</a><a href="#h92-0-91" id="h92-0-91" class="d">-    }
</a><a href="#h92-0-92" id="h92-0-92" class="d">-}
</a><b>diff --git a/<a id="h93" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/ChatActionMenu.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/ChatActionMenu.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/ChatActionMenu.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/ChatActionMenu.kt</a></b>
<a href="#h93-0" id="h93-0" class="h">@@ -7,13 +7,15 @@ import android.view.View
</a> import android.view.ViewGroup
 import android.view.ViewGroup.MarginLayoutParams
 import android.widget.Button
<a href="#h93-0-3" id="h93-0-3" class="i">+import android.widget.LinearLayout
</a><a href="#h93-0-4" id="h93-0-4" class="i">+import me.rhunk.snapenhance.Constants
</a> import me.rhunk.snapenhance.Constants.VIEW_INJECTED_CODE
 import me.rhunk.snapenhance.config.ConfigProperty
 import me.rhunk.snapenhance.features.impl.Messaging
 import me.rhunk.snapenhance.features.impl.downloader.MediaDownloader
 import me.rhunk.snapenhance.features.impl.spying.MessageLogger
<a href="#h93-0-10" id="h93-0-10" class="i">+import me.rhunk.snapenhance.ui.ViewAppearanceHelper
</a> import me.rhunk.snapenhance.ui.menu.AbstractMenu
<a href="#h93-0-12" id="h93-0-12" class="d">-import me.rhunk.snapenhance.ui.menu.ViewAppearanceHelper
</a> 
 
 class ChatActionMenu : AbstractMenu() {
<a href="#h93-1" id="h93-1" class="h">@@ -23,7 +25,7 @@ class ChatActionMenu : AbstractMenu() {
</a>         return false
     }
 
<a href="#h93-1-3" id="h93-1-3" class="d">-    @SuppressLint(&quot;SetTextI18n&quot;)
</a><a href="#h93-1-4" id="h93-1-4" class="i">+    @SuppressLint(&quot;SetTextI18n&quot;, &quot;DiscouragedApi&quot;)
</a>     fun inject(viewGroup: ViewGroup) {
         val parent = viewGroup.parent.parent as ViewGroup
         if (wasInjectedView(parent)) return
<a href="#h93-2" id="h93-2" class="h">@@ -41,17 +43,64 @@ class ChatActionMenu : AbstractMenu() {
</a>             )
         }
 
<a href="#h93-2-3" id="h93-2-3" class="i">+        val defaultGap = viewGroup.resources.getDimensionPixelSize(
</a><a href="#h93-2-4" id="h93-2-4" class="i">+            viewGroup.resources.getIdentifier(
</a><a href="#h93-2-5" id="h93-2-5" class="i">+                &quot;default_gap&quot;,
</a><a href="#h93-2-6" id="h93-2-6" class="i">+                &quot;dimen&quot;,
</a><a href="#h93-2-7" id="h93-2-7" class="i">+                Constants.SNAPCHAT_PACKAGE_NAME
</a><a href="#h93-2-8" id="h93-2-8" class="i">+            )
</a><a href="#h93-2-9" id="h93-2-9" class="i">+        )
</a><a href="#h93-2-10" id="h93-2-10" class="i">+
</a><a href="#h93-2-11" id="h93-2-11" class="i">+        val chatActionMenuItemMargin = viewGroup.resources.getDimensionPixelSize(
</a><a href="#h93-2-12" id="h93-2-12" class="i">+            viewGroup.resources.getIdentifier(
</a><a href="#h93-2-13" id="h93-2-13" class="i">+                &quot;chat_action_menu_item_margin&quot;,
</a><a href="#h93-2-14" id="h93-2-14" class="i">+                &quot;dimen&quot;,
</a><a href="#h93-2-15" id="h93-2-15" class="i">+                Constants.SNAPCHAT_PACKAGE_NAME
</a><a href="#h93-2-16" id="h93-2-16" class="i">+            )
</a><a href="#h93-2-17" id="h93-2-17" class="i">+        )
</a><a href="#h93-2-18" id="h93-2-18" class="i">+
</a><a href="#h93-2-19" id="h93-2-19" class="i">+        val actionMenuItemHeight = viewGroup.resources.getDimensionPixelSize(
</a><a href="#h93-2-20" id="h93-2-20" class="i">+            viewGroup.resources.getIdentifier(
</a><a href="#h93-2-21" id="h93-2-21" class="i">+                &quot;action_menu_item_height&quot;,
</a><a href="#h93-2-22" id="h93-2-22" class="i">+                &quot;dimen&quot;,
</a><a href="#h93-2-23" id="h93-2-23" class="i">+                Constants.SNAPCHAT_PACKAGE_NAME
</a><a href="#h93-2-24" id="h93-2-24" class="i">+            )
</a><a href="#h93-2-25" id="h93-2-25" class="i">+        )
</a><a href="#h93-2-26" id="h93-2-26" class="i">+
</a><a href="#h93-2-27" id="h93-2-27" class="i">+        val buttonContainer = LinearLayout(viewGroup.context).apply layout@{
</a><a href="#h93-2-28" id="h93-2-28" class="i">+            orientation = LinearLayout.VERTICAL
</a><a href="#h93-2-29" id="h93-2-29" class="i">+            layoutParams = MarginLayoutParams(
</a><a href="#h93-2-30" id="h93-2-30" class="i">+                ViewGroup.LayoutParams.MATCH_PARENT,
</a><a href="#h93-2-31" id="h93-2-31" class="i">+                ViewGroup.LayoutParams.WRAP_CONTENT
</a><a href="#h93-2-32" id="h93-2-32" class="i">+            ).apply {
</a><a href="#h93-2-33" id="h93-2-33" class="i">+                ViewAppearanceHelper.applyTheme(this@layout, parent.width, true)
</a><a href="#h93-2-34" id="h93-2-34" class="i">+                setMargins(chatActionMenuItemMargin, 0, chatActionMenuItemMargin, defaultGap)
</a><a href="#h93-2-35" id="h93-2-35" class="i">+            }
</a><a href="#h93-2-36" id="h93-2-36" class="i">+        }
</a><a href="#h93-2-37" id="h93-2-37" class="i">+
</a>         val injectButton = { button: Button -&gt;
<a href="#h93-2-39" id="h93-2-39" class="d">-            ViewAppearanceHelper.applyTheme(button, parent.width, hasRadius = true)
</a><a href="#h93-2-40" id="h93-2-40" class="i">+            if (buttonContainer.childCount &gt; 0) {
</a><a href="#h93-2-41" id="h93-2-41" class="i">+                buttonContainer.addView(View(viewGroup.context).apply {
</a><a href="#h93-2-42" id="h93-2-42" class="i">+                    layoutParams = MarginLayoutParams(
</a><a href="#h93-2-43" id="h93-2-43" class="i">+                        ViewGroup.LayoutParams.MATCH_PARENT,
</a><a href="#h93-2-44" id="h93-2-44" class="i">+                        ViewGroup.LayoutParams.WRAP_CONTENT
</a><a href="#h93-2-45" id="h93-2-45" class="i">+                    ).apply {
</a><a href="#h93-2-46" id="h93-2-46" class="i">+                        height = 1
</a><a href="#h93-2-47" id="h93-2-47" class="i">+                    }
</a><a href="#h93-2-48" id="h93-2-48" class="i">+                    setBackgroundColor(0x1A000000)
</a><a href="#h93-2-49" id="h93-2-49" class="i">+                })
</a><a href="#h93-2-50" id="h93-2-50" class="i">+            }
</a><a href="#h93-2-51" id="h93-2-51" class="i">+
</a><a href="#h93-2-52" id="h93-2-52" class="i">+            ViewAppearanceHelper.applyTheme(button, parent.width, true)
</a> 
             with(button) {
                 layoutParams = MarginLayoutParams(
                     ViewGroup.LayoutParams.MATCH_PARENT,
                     ViewGroup.LayoutParams.WRAP_CONTENT
                 ).apply {
<a href="#h93-2-59" id="h93-2-59" class="d">-                    setMargins(40, 0, 40, 15)
</a><a href="#h93-2-60" id="h93-2-60" class="i">+                    height = actionMenuItemHeight + defaultGap
</a>                 }
<a href="#h93-2-62" id="h93-2-62" class="d">-                parent.addView(this)
</a><a href="#h93-2-63" id="h93-2-63" class="i">+                buttonContainer.addView(this)
</a>             }
         }
 
<a href="#h93-3" id="h93-3" class="h">@@ -91,5 +140,7 @@ class ChatActionMenu : AbstractMenu() {
</a>                 }
             })
         }
<a href="#h93-3-3" id="h93-3-3" class="i">+
</a><a href="#h93-3-4" id="h93-3-4" class="i">+        parent.addView(buttonContainer)
</a>     }
 }
<b>diff --git a/<a id="h94" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/FriendFeedInfoMenu.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/FriendFeedInfoMenu.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/FriendFeedInfoMenu.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/FriendFeedInfoMenu.kt</a></b>
<a href="#h94-0" id="h94-0" class="h">@@ -1,7 +1,6 @@
</a> package me.rhunk.snapenhance.ui.menu.impl
 
 import android.annotation.SuppressLint
<a href="#h94-0-3" id="h94-0-3" class="d">-import android.app.AlertDialog
</a> import android.content.Context
 import android.content.DialogInterface
 import android.content.res.Resources
<a href="#h94-1" id="h94-1" class="h">@@ -32,8 +31,8 @@ import me.rhunk.snapenhance.features.impl.Messaging
</a> import me.rhunk.snapenhance.features.impl.downloader.AntiAutoDownload
 import me.rhunk.snapenhance.features.impl.spying.StealthMode
 import me.rhunk.snapenhance.features.impl.tweaks.AntiAutoSave
<a href="#h94-1-3" id="h94-1-3" class="i">+import me.rhunk.snapenhance.ui.ViewAppearanceHelper
</a> import me.rhunk.snapenhance.ui.menu.AbstractMenu
<a href="#h94-1-5" id="h94-1-5" class="d">-import me.rhunk.snapenhance.ui.menu.ViewAppearanceHelper
</a> import me.rhunk.snapenhance.util.snap.BitmojiSelfie
 import java.net.HttpURLConnection
 import java.net.URL
<a href="#h94-2" id="h94-2" class="h">@@ -73,7 +72,7 @@ class FriendFeedInfoMenu : AbstractMenu() {
</a>         val finalIcon = icon
         context.runOnUiThread {
             val addedTimestamp: Long = profile.addedTimestamp.coerceAtLeast(profile.reverseAddedTimestamp)
<a href="#h94-2-3" id="h94-2-3" class="d">-            val builder = AlertDialog.Builder(context.mainActivity)
</a><a href="#h94-2-4" id="h94-2-4" class="i">+            val builder = ViewAppearanceHelper.newAlertDialogBuilder(context.mainActivity)
</a>             builder.setIcon(finalIcon)
             builder.setTitle(profile.displayName ?: profile.username)
 
<a href="#h94-3" id="h94-3" class="h">@@ -168,7 +167,7 @@ class FriendFeedInfoMenu : AbstractMenu() {
</a> 
 
         //alert dialog
<a href="#h94-3-3" id="h94-3-3" class="d">-        val builder = AlertDialog.Builder(context.mainActivity)
</a><a href="#h94-3-4" id="h94-3-4" class="i">+        val builder = ViewAppearanceHelper.newAlertDialogBuilder(context.mainActivity)
</a>         builder.setTitle(context.translation[&quot;conversation_preview.title&quot;])
         builder.setMessage(messageBuilder.toString())
         builder.setPositiveButton(
<a href="#h94-4" id="h94-4" class="h">@@ -200,10 +199,20 @@ class FriendFeedInfoMenu : AbstractMenu() {
</a>         return BitmapDrawable(context.resources, bitmap)
     }
 
<a href="#h94-4-3" id="h94-4-3" class="d">-    private fun getCurrentConversationId(): Pair&lt;String, String?&gt; {
</a><a href="#h94-4-4" id="h94-4-4" class="i">+    private fun getCurrentConversationInfo(): Pair&lt;String, String?&gt; {
</a>         val messaging = context.feature(Messaging::class)
         val focusedConversationTargetUser: String? = messaging.lastFetchConversationUserUUID?.toString()
 
<a href="#h94-4-8" id="h94-4-8" class="i">+        //mapped conversation fetch (may not work with legacy sc versions)
</a><a href="#h94-4-9" id="h94-4-9" class="i">+        messaging.lastFetchGroupConversationUUID?.let {
</a><a href="#h94-4-10" id="h94-4-10" class="i">+            context.database.getFriendFeedInfoByConversationId(it.toString())?.let { friendFeedInfo -&gt;
</a><a href="#h94-4-11" id="h94-4-11" class="i">+                val participantSize = friendFeedInfo.participantsSize
</a><a href="#h94-4-12" id="h94-4-12" class="i">+                return it.toString() to if (participantSize == 1) focusedConversationTargetUser else null
</a><a href="#h94-4-13" id="h94-4-13" class="i">+            }
</a><a href="#h94-4-14" id="h94-4-14" class="i">+            throw IllegalStateException(&quot;No conversation found&quot;)
</a><a href="#h94-4-15" id="h94-4-15" class="i">+        }
</a><a href="#h94-4-16" id="h94-4-16" class="i">+
</a><a href="#h94-4-17" id="h94-4-17" class="i">+        //old conversation fetch
</a>         val conversationId = if (messaging.lastFetchConversationUUID == null &amp;&amp; focusedConversationTargetUser != null) {
             val conversation: UserConversationLink = context.database.getDMConversationIdFromUserId(focusedConversationTargetUser) ?: throw IllegalStateException(&quot;No conversation found&quot;)
             conversation.client_conversation_id!!.trim().lowercase()
<a href="#h94-5" id="h94-5" class="h">@@ -211,7 +220,7 @@ class FriendFeedInfoMenu : AbstractMenu() {
</a>             messaging.lastFetchConversationUUID.toString()
         }
 
<a href="#h94-5-3" id="h94-5-3" class="d">-        return Pair(conversationId, focusedConversationTargetUser)
</a><a href="#h94-5-4" id="h94-5-4" class="i">+        return conversationId to focusedConversationTargetUser
</a>     }
 
     private fun createToggleFeature(viewConsumer: ((View) -&gt; Unit), text: String, isChecked: () -&gt; Boolean, toggle: (Boolean) -&gt; Unit) {
<a href="#h94-6" id="h94-6" class="h">@@ -234,7 +243,7 @@ class FriendFeedInfoMenu : AbstractMenu() {
</a>         val friendFeedMenuOptions = context.config.options(ConfigProperty.FRIEND_FEED_MENU_BUTTONS)
         if (friendFeedMenuOptions.none { it.value }) return
 
<a href="#h94-6-3" id="h94-6-3" class="d">-        val (conversationId, targetUser) = getCurrentConversationId()
</a><a href="#h94-6-4" id="h94-6-4" class="i">+        val (conversationId, targetUser) = getCurrentConversationInfo()
</a> 
         if (!context.config.bool(ConfigProperty.ENABLE_FRIEND_FEED_MENU_BAR)) {
             //preview button
<b>diff --git a/<a id="h95" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/MenuViewInjector.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/MenuViewInjector.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/MenuViewInjector.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/MenuViewInjector.kt</a></b>
<a href="#h95-0" id="h95-0" class="h">@@ -28,14 +28,6 @@ class MenuViewInjector : Feature(&quot;MenuViewInjector&quot;, loadParams = FeatureLoadPar
</a>         context.resources.getString(context.resources.getIdentifier(&quot;new_chat&quot;, &quot;string&quot;, Constants.SNAPCHAT_PACKAGE_NAME))
     }
 
<a href="#h95-0-3" id="h95-0-3" class="d">-    private val fetchConversationHooks = mutableSetOf&lt;Unhook&gt;()
</a><a href="#h95-0-4" id="h95-0-4" class="d">-
</a><a href="#h95-0-5" id="h95-0-5" class="d">-    private fun unhookFetchConversation() {
</a><a href="#h95-0-6" id="h95-0-6" class="d">-        fetchConversationHooks.let {
</a><a href="#h95-0-7" id="h95-0-7" class="d">-            it.removeIf { hook -&gt; hook.unhook() ; true}
</a><a href="#h95-0-8" id="h95-0-8" class="d">-        }
</a><a href="#h95-0-9" id="h95-0-9" class="d">-    }
</a><a href="#h95-0-10" id="h95-0-10" class="d">-
</a>     @SuppressLint(&quot;ResourceType&quot;)
     override fun asyncOnActivityCreate() {
         friendFeedInfoMenu.context = context
<a href="#h95-1" id="h95-1" class="h">@@ -86,19 +78,25 @@ class MenuViewInjector : Feature(&quot;MenuViewInjector&quot;, loadParams = FeatureLoadPar
</a>             }
 
             //TODO: inject in group chat menus
<a href="#h95-1-3" id="h95-1-3" class="d">-            if (viewGroup.id == actionSheetContainer &amp;&amp; childView.id == actionMenu) {
</a><a href="#h95-1-4" id="h95-1-4" class="i">+            if (viewGroup.id == actionSheetContainer &amp;&amp; childView.id == actionMenu &amp;&amp; messaging.lastFetchGroupConversationUUID != null) {
</a>                 val injectedLayout = LinearLayout(childView.context).apply {
                     orientation = LinearLayout.VERTICAL
                     gravity = Gravity.BOTTOM
                     layoutParams = ViewGroup.LayoutParams(ViewGroup.LayoutParams.MATCH_PARENT, ViewGroup.LayoutParams.MATCH_PARENT)
                     addView(childView)
<a href="#h95-1-10" id="h95-1-10" class="i">+                    addOnAttachStateChangeListener(object: View.OnAttachStateChangeListener {
</a><a href="#h95-1-11" id="h95-1-11" class="i">+                        override fun onViewAttachedToWindow(v: View) {}
</a><a href="#h95-1-12" id="h95-1-12" class="i">+                        override fun onViewDetachedFromWindow(v: View) {
</a><a href="#h95-1-13" id="h95-1-13" class="i">+                            messaging.lastFetchGroupConversationUUID = null
</a><a href="#h95-1-14" id="h95-1-14" class="i">+                        }
</a><a href="#h95-1-15" id="h95-1-15" class="i">+                    })
</a>                 }
 
<a href="#h95-1-18" id="h95-1-18" class="d">-                fun injectView() {
</a><a href="#h95-1-19" id="h95-1-19" class="d">-                    val viewList = mutableListOf&lt;View&gt;()
</a><a href="#h95-1-20" id="h95-1-20" class="i">+                val viewList = mutableListOf&lt;View&gt;()
</a><a href="#h95-1-21" id="h95-1-21" class="i">+                context.runOnUiThread {
</a>                     friendFeedInfoMenu.inject(injectedLayout) { view -&gt;
                         view.layoutParams = LinearLayout.LayoutParams(ViewGroup.LayoutParams.MATCH_PARENT, ViewGroup.LayoutParams.WRAP_CONTENT).apply {
<a href="#h95-1-24" id="h95-1-24" class="d">-                            setMargins(0, 10, 0, 10)
</a><a href="#h95-1-25" id="h95-1-25" class="i">+                            setMargins(0, 3, 0, 3)
</a>                         }
                         viewList.add(view)
                     }
<b>diff --git a/<a id="h96" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/OperaContextActionMenu.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/OperaContextActionMenu.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/OperaContextActionMenu.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/OperaContextActionMenu.kt</a></b>
<a href="#h96-0" id="h96-0" class="h">@@ -11,7 +11,7 @@ import me.rhunk.snapenhance.Constants
</a> import me.rhunk.snapenhance.Logger
 import me.rhunk.snapenhance.features.impl.downloader.MediaDownloader
 import me.rhunk.snapenhance.ui.menu.AbstractMenu
<a href="#h96-0-3" id="h96-0-3" class="d">-import me.rhunk.snapenhance.ui.menu.ViewAppearanceHelper.applyTheme
</a><a href="#h96-0-4" id="h96-0-4" class="i">+import me.rhunk.snapenhance.ui.ViewAppearanceHelper.applyTheme
</a> 
 @SuppressLint(&quot;DiscouragedApi&quot;)
 class OperaContextActionMenu : AbstractMenu() {
<b>diff --git a/<a id="h97" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/SettingsMenu.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/SettingsMenu.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/SettingsMenu.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/SettingsMenu.kt</a></b>
<a href="#h97-0" id="h97-0" class="h">@@ -18,7 +18,7 @@ import me.rhunk.snapenhance.config.impl.ConfigStateSelection
</a> import me.rhunk.snapenhance.config.impl.ConfigStateValue
 import me.rhunk.snapenhance.config.impl.ConfigStringValue
 import me.rhunk.snapenhance.ui.menu.AbstractMenu
<a href="#h97-0-3" id="h97-0-3" class="d">-import me.rhunk.snapenhance.ui.menu.ViewAppearanceHelper
</a><a href="#h97-0-4" id="h97-0-4" class="i">+import me.rhunk.snapenhance.ui.ViewAppearanceHelper
</a> 
 class SettingsMenu : AbstractMenu() {
     @SuppressLint(&quot;ClickableViewAccessibility&quot;)
<a href="#h97-1" id="h97-1" class="h">@@ -48,14 +48,14 @@ class SettingsMenu : AbstractMenu() {
</a>                     if (property.disableValueLocalization) {
                         it
                     } else {
<a href="#h97-1-3" id="h97-1-3" class="d">-                        context.translation[&quot;option.property.&quot; + property.translationKey + &quot;.&quot; + it]
</a><a href="#h97-1-4" id="h97-1-4" class="i">+                        context.translation[property.getOptionTranslationKey(it)]
</a>                     }
                 }
             })
         }
 
         val textEditor: ((String) -&gt; Unit) -&gt; Unit = { updateValue -&gt;
<a href="#h97-1-11" id="h97-1-11" class="d">-            val builder = AlertDialog.Builder(context.mainActivity!!)
</a><a href="#h97-1-12" id="h97-1-12" class="i">+            val builder = ViewAppearanceHelper.newAlertDialogBuilder(context.mainActivity!!)
</a>             builder.setTitle(propertyName)
 
             val input = EditText(context.androidContext)
<a href="#h97-2" id="h97-2" class="h">@@ -121,13 +121,13 @@ class SettingsMenu : AbstractMenu() {
</a>                 updateLocalizedText(button, property.valueContainer.value())
 
                 button.setOnClickListener {_ -&gt;
<a href="#h97-2-3" id="h97-2-3" class="d">-                    val builder = AlertDialog.Builder(context.mainActivity!!)
</a><a href="#h97-2-4" id="h97-2-4" class="i">+                    val builder = ViewAppearanceHelper.newAlertDialogBuilder(context.mainActivity!!)
</a>                     builder.setTitle(propertyName)
 
                     builder.setSingleChoiceItems(
                         property.valueContainer.keys().toTypedArray().map {
                             if (property.disableValueLocalization) it
<a href="#h97-2-10" id="h97-2-10" class="d">-                            else context.translation[&quot;option.property.&quot; + property.translationKey + &quot;.&quot; + it]
</a><a href="#h97-2-11" id="h97-2-11" class="i">+                            else context.translation[property.getOptionTranslationKey(it)]
</a>                         }.toTypedArray(),
                         property.valueContainer.keys().indexOf(property.valueContainer.value())
                     ) { _, which -&gt;
<a href="#h97-3" id="h97-3" class="h">@@ -148,7 +148,7 @@ class SettingsMenu : AbstractMenu() {
</a>                 updateButtonText(button, &quot;(${property.valueContainer.value().count { it.value }})&quot;)
 
                 button.setOnClickListener {_ -&gt;
<a href="#h97-3-3" id="h97-3-3" class="d">-                    val builder = AlertDialog.Builder(context.mainActivity!!)
</a><a href="#h97-3-4" id="h97-3-4" class="i">+                    val builder = ViewAppearanceHelper.newAlertDialogBuilder(context.mainActivity!!)
</a>                     builder.setTitle(propertyName)
 
                     val sortedStates = property.valueContainer.value().toSortedMap()
<a href="#h97-4" id="h97-4" class="h">@@ -156,7 +156,7 @@ class SettingsMenu : AbstractMenu() {
</a>                     builder.setMultiChoiceItems(
                         sortedStates.toSortedMap().map {
                             if (property.disableValueLocalization) it.key
<a href="#h97-4-3" id="h97-4-3" class="d">-                            else context.translation[&quot;option.property.&quot; + property.translationKey + &quot;.&quot; + it.key]
</a><a href="#h97-4-4" id="h97-4-4" class="i">+                            else context.translation[property.getOptionTranslationKey(it.key)]
</a>                         }.toTypedArray(),
                         sortedStates.map { it.value }.toBooleanArray()
                     ) { _, which, isChecked -&gt;
<b>diff --git a/<a id="h98" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/spoof/DeviceSpooferActivity.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/spoof/DeviceSpooferActivity.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/spoof/DeviceSpooferActivity.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/spoof/DeviceSpooferActivity.kt</a></b>
<a href="#h98-0" id="h98-0" class="h">@@ -0,0 +1,111 @@
</a><a href="#h98-0-0" id="h98-0-0" class="i">+package me.rhunk.snapenhance.ui.spoof
</a><a href="#h98-0-1" id="h98-0-1" class="i">+
</a><a href="#h98-0-2" id="h98-0-2" class="i">+import android.app.Activity
</a><a href="#h98-0-3" id="h98-0-3" class="i">+import android.content.res.ColorStateList
</a><a href="#h98-0-4" id="h98-0-4" class="i">+import android.os.Bundle
</a><a href="#h98-0-5" id="h98-0-5" class="i">+import android.text.InputType
</a><a href="#h98-0-6" id="h98-0-6" class="i">+import android.view.View
</a><a href="#h98-0-7" id="h98-0-7" class="i">+import android.view.ViewGroup
</a><a href="#h98-0-8" id="h98-0-8" class="i">+import android.widget.ImageButton
</a><a href="#h98-0-9" id="h98-0-9" class="i">+import android.widget.Switch
</a><a href="#h98-0-10" id="h98-0-10" class="i">+import android.widget.TextView
</a><a href="#h98-0-11" id="h98-0-11" class="i">+import me.rhunk.snapenhance.R
</a><a href="#h98-0-12" id="h98-0-12" class="i">+import me.rhunk.snapenhance.SharedContext
</a><a href="#h98-0-13" id="h98-0-13" class="i">+import me.rhunk.snapenhance.config.ConfigCategory
</a><a href="#h98-0-14" id="h98-0-14" class="i">+import me.rhunk.snapenhance.config.impl.ConfigIntegerValue
</a><a href="#h98-0-15" id="h98-0-15" class="i">+import me.rhunk.snapenhance.config.impl.ConfigStateValue
</a><a href="#h98-0-16" id="h98-0-16" class="i">+import me.rhunk.snapenhance.config.impl.ConfigStringValue
</a><a href="#h98-0-17" id="h98-0-17" class="i">+import me.rhunk.snapenhance.ui.ItemHelper
</a><a href="#h98-0-18" id="h98-0-18" class="i">+
</a><a href="#h98-0-19" id="h98-0-19" class="i">+class DeviceSpooferActivity: Activity() {
</a><a href="#h98-0-20" id="h98-0-20" class="i">+    private val itemHelper = ItemHelper(this)
</a><a href="#h98-0-21" id="h98-0-21" class="i">+    
</a><a href="#h98-0-22" id="h98-0-22" class="i">+    override fun onCreate(savedInstanceState: Bundle?) {
</a><a href="#h98-0-23" id="h98-0-23" class="i">+        super.onCreate(savedInstanceState)
</a><a href="#h98-0-24" id="h98-0-24" class="i">+        SharedContext.ensureInitialized(this)
</a><a href="#h98-0-25" id="h98-0-25" class="i">+        setContentView(R.layout.device_spoofer_activity)
</a><a href="#h98-0-26" id="h98-0-26" class="i">+        
</a><a href="#h98-0-27" id="h98-0-27" class="i">+        findViewById&lt;TextView&gt;(R.id.title).text = &quot;Device Spoofer&quot;
</a><a href="#h98-0-28" id="h98-0-28" class="i">+        findViewById&lt;ImageButton&gt;(R.id.back_button).setOnClickListener { finish() }
</a><a href="#h98-0-29" id="h98-0-29" class="i">+        val propertyListLayout = findViewById&lt;ViewGroup&gt;(R.id.spoof_property_list)
</a><a href="#h98-0-30" id="h98-0-30" class="i">+        
</a><a href="#h98-0-31" id="h98-0-31" class="i">+        SharedContext.config.entries().filter { it.key.category == ConfigCategory.DEVICE_SPOOFER }.forEach { (property, value) -&gt;
</a><a href="#h98-0-32" id="h98-0-32" class="i">+            val configItem = layoutInflater.inflate(R.layout.config_activity_item, propertyListLayout, false)
</a><a href="#h98-0-33" id="h98-0-33" class="i">+            
</a><a href="#h98-0-34" id="h98-0-34" class="i">+            val propertyName = SharedContext.translation[&quot;property.${property.translationKey}.name&quot;]
</a><a href="#h98-0-35" id="h98-0-35" class="i">+            
</a><a href="#h98-0-36" id="h98-0-36" class="i">+            fun addSeparator() {
</a><a href="#h98-0-37" id="h98-0-37" class="i">+                //add separator
</a><a href="#h98-0-38" id="h98-0-38" class="i">+                propertyListLayout.addView(View(this).apply {
</a><a href="#h98-0-39" id="h98-0-39" class="i">+                    layoutParams = ViewGroup.LayoutParams(ViewGroup.LayoutParams.MATCH_PARENT, 1)
</a><a href="#h98-0-40" id="h98-0-40" class="i">+                    setBackgroundColor(getColor(R.color.tertiaryBackground))
</a><a href="#h98-0-41" id="h98-0-41" class="i">+                })
</a><a href="#h98-0-42" id="h98-0-42" class="i">+            }
</a><a href="#h98-0-43" id="h98-0-43" class="i">+            
</a><a href="#h98-0-44" id="h98-0-44" class="i">+            configItem.findViewById&lt;TextView&gt;(R.id.name).text = propertyName
</a><a href="#h98-0-45" id="h98-0-45" class="i">+            configItem.findViewById&lt;TextView&gt;(R.id.description).also {
</a><a href="#h98-0-46" id="h98-0-46" class="i">+                it.text = SharedContext.translation[&quot;property.${property.translationKey}.description&quot;]
</a><a href="#h98-0-47" id="h98-0-47" class="i">+                it.visibility = if (it.text.isEmpty()) View.GONE else View.VISIBLE
</a><a href="#h98-0-48" id="h98-0-48" class="i">+            }
</a><a href="#h98-0-49" id="h98-0-49" class="i">+        
</a><a href="#h98-0-50" id="h98-0-50" class="i">+            fun addValueView(view: View) {
</a><a href="#h98-0-51" id="h98-0-51" class="i">+                configItem.findViewById&lt;ViewGroup&gt;(R.id.value).addView(view)
</a><a href="#h98-0-52" id="h98-0-52" class="i">+            }
</a><a href="#h98-0-53" id="h98-0-53" class="i">+        
</a><a href="#h98-0-54" id="h98-0-54" class="i">+            when (value) {
</a><a href="#h98-0-55" id="h98-0-55" class="i">+                is ConfigStateValue -&gt; {
</a><a href="#h98-0-56" id="h98-0-56" class="i">+                    val switch = Switch(this)
</a><a href="#h98-0-57" id="h98-0-57" class="i">+                    switch.isChecked = value.value()
</a><a href="#h98-0-58" id="h98-0-58" class="i">+                    switch.trackTintList = ColorStateList(
</a><a href="#h98-0-59" id="h98-0-59" class="i">+                        arrayOf(
</a><a href="#h98-0-60" id="h98-0-60" class="i">+                            intArrayOf(android.R.attr.state_checked),
</a><a href="#h98-0-61" id="h98-0-61" class="i">+                            intArrayOf(-android.R.attr.state_checked)
</a><a href="#h98-0-62" id="h98-0-62" class="i">+                        ),
</a><a href="#h98-0-63" id="h98-0-63" class="i">+                        intArrayOf(
</a><a href="#h98-0-64" id="h98-0-64" class="i">+                            switch.highlightColor,
</a><a href="#h98-0-65" id="h98-0-65" class="i">+                            getColor(R.color.tertiaryBackground)
</a><a href="#h98-0-66" id="h98-0-66" class="i">+                        )
</a><a href="#h98-0-67" id="h98-0-67" class="i">+                    )
</a><a href="#h98-0-68" id="h98-0-68" class="i">+                    switch.setOnCheckedChangeListener { _, isChecked -&gt;
</a><a href="#h98-0-69" id="h98-0-69" class="i">+                        value.writeFrom(isChecked.toString())
</a><a href="#h98-0-70" id="h98-0-70" class="i">+                    }
</a><a href="#h98-0-71" id="h98-0-71" class="i">+                    configItem.setOnClickListener { switch.toggle() }
</a><a href="#h98-0-72" id="h98-0-72" class="i">+                    addValueView(switch)
</a><a href="#h98-0-73" id="h98-0-73" class="i">+                }
</a><a href="#h98-0-74" id="h98-0-74" class="i">+                is ConfigStringValue, is ConfigIntegerValue -&gt; {
</a><a href="#h98-0-75" id="h98-0-75" class="i">+                    val textView = itemHelper.createTranslatedTextView(property, shouldTranslatePropertyValue = false).also {
</a><a href="#h98-0-76" id="h98-0-76" class="i">+                        it.text = value.value().toString()
</a><a href="#h98-0-77" id="h98-0-77" class="i">+                    }
</a><a href="#h98-0-78" id="h98-0-78" class="i">+                    configItem.setOnClickListener {
</a><a href="#h98-0-79" id="h98-0-79" class="i">+                        if (value is ConfigIntegerValue) {
</a><a href="#h98-0-80" id="h98-0-80" class="i">+                            itemHelper.askForValue(property, InputType.TYPE_CLASS_NUMBER) {
</a><a href="#h98-0-81" id="h98-0-81" class="i">+                                try {
</a><a href="#h98-0-82" id="h98-0-82" class="i">+                                    value.writeFrom(it)
</a><a href="#h98-0-83" id="h98-0-83" class="i">+                                    textView.text = value.value().toString()
</a><a href="#h98-0-84" id="h98-0-84" class="i">+                                } catch (e: NumberFormatException) {
</a><a href="#h98-0-85" id="h98-0-85" class="i">+                                    itemHelper.longToast(SharedContext.translation[&quot;config_activity.invalid_number_toast&quot;], this)
</a><a href="#h98-0-86" id="h98-0-86" class="i">+                                }
</a><a href="#h98-0-87" id="h98-0-87" class="i">+                            }
</a><a href="#h98-0-88" id="h98-0-88" class="i">+                            return@setOnClickListener
</a><a href="#h98-0-89" id="h98-0-89" class="i">+                        }
</a><a href="#h98-0-90" id="h98-0-90" class="i">+                        itemHelper.askForValue(property, InputType.TYPE_CLASS_TEXT) {
</a><a href="#h98-0-91" id="h98-0-91" class="i">+                            value.writeFrom(it)
</a><a href="#h98-0-92" id="h98-0-92" class="i">+                            textView.text = value.value().toString()
</a><a href="#h98-0-93" id="h98-0-93" class="i">+                        }
</a><a href="#h98-0-94" id="h98-0-94" class="i">+                    }
</a><a href="#h98-0-95" id="h98-0-95" class="i">+                    addValueView(textView)
</a><a href="#h98-0-96" id="h98-0-96" class="i">+                }
</a><a href="#h98-0-97" id="h98-0-97" class="i">+            }
</a><a href="#h98-0-98" id="h98-0-98" class="i">+        
</a><a href="#h98-0-99" id="h98-0-99" class="i">+            propertyListLayout.addView(configItem)
</a><a href="#h98-0-100" id="h98-0-100" class="i">+            addSeparator()
</a><a href="#h98-0-101" id="h98-0-101" class="i">+        }
</a><a href="#h98-0-102" id="h98-0-102" class="i">+    }
</a><a href="#h98-0-103" id="h98-0-103" class="i">+    
</a><a href="#h98-0-104" id="h98-0-104" class="i">+    @Deprecated(&quot;Deprecated in Java&quot;)
</a><a href="#h98-0-105" id="h98-0-105" class="i">+    @Suppress(&quot;DEPRECATION&quot;)
</a><a href="#h98-0-106" id="h98-0-106" class="i">+    override fun onBackPressed() {
</a><a href="#h98-0-107" id="h98-0-107" class="i">+        super.onBackPressed()
</a><a href="#h98-0-108" id="h98-0-108" class="i">+        finish()
</a><a href="#h98-0-109" id="h98-0-109" class="i">+    }
</a><a href="#h98-0-110" id="h98-0-110" class="i">+}</a><a href="#h98-0-111" id="h98-0-111" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h99" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/util/ActivityResultCallback.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/util/ActivityResultCallback.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/util/ActivityResultCallback.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/util/ActivityResultCallback.kt</a></b>
<a href="#h99-0" id="h99-0" class="h">@@ -0,0 +1,5 @@
</a><a href="#h99-0-0" id="h99-0-0" class="i">+package me.rhunk.snapenhance.util
</a><a href="#h99-0-1" id="h99-0-1" class="i">+
</a><a href="#h99-0-2" id="h99-0-2" class="i">+import android.content.Intent
</a><a href="#h99-0-3" id="h99-0-3" class="i">+
</a><a href="#h99-0-4" id="h99-0-4" class="i">+typealias ActivityResultCallback = (requestCode: Int, resultCode: Int, data: Intent?) -&gt; Unit</a><a href="#h99-0-5" id="h99-0-5" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h100" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/util/AndroidCompatExtensions.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/util/AndroidCompatExtensions.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/util/AndroidCompatExtensions.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/util/AndroidCompatExtensions.kt</a></b>
<a href="#h100-0" id="h100-0" class="h">@@ -0,0 +1,13 @@
</a><a href="#h100-0-0" id="h100-0-0" class="i">+package me.rhunk.snapenhance.util
</a><a href="#h100-0-1" id="h100-0-1" class="i">+
</a><a href="#h100-0-2" id="h100-0-2" class="i">+import android.content.pm.PackageManager
</a><a href="#h100-0-3" id="h100-0-3" class="i">+import android.content.pm.PackageManager.ApplicationInfoFlags
</a><a href="#h100-0-4" id="h100-0-4" class="i">+import android.os.Build
</a><a href="#h100-0-5" id="h100-0-5" class="i">+
</a><a href="#h100-0-6" id="h100-0-6" class="i">+fun PackageManager.getApplicationInfoCompat(packageName: String, flags: Int) =
</a><a href="#h100-0-7" id="h100-0-7" class="i">+    if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.TIRAMISU) {
</a><a href="#h100-0-8" id="h100-0-8" class="i">+        getApplicationInfo(packageName, ApplicationInfoFlags.of(flags.toLong()))
</a><a href="#h100-0-9" id="h100-0-9" class="i">+    } else {
</a><a href="#h100-0-10" id="h100-0-10" class="i">+        @Suppress(&quot;DEPRECATION&quot;)
</a><a href="#h100-0-11" id="h100-0-11" class="i">+        getApplicationInfo(packageName, flags)
</a><a href="#h100-0-12" id="h100-0-12" class="i">+    }
</a><b>diff --git a/<a id="h101" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/util/export/MessageExporter.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/util/export/MessageExporter.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/util/export/MessageExporter.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/util/export/MessageExporter.kt</a></b>
<a href="#h101-0" id="h101-0" class="h">@@ -20,6 +20,7 @@ import me.rhunk.snapenhance.data.wrapper.impl.Message
</a> import me.rhunk.snapenhance.data.wrapper.impl.SnapUUID
 import me.rhunk.snapenhance.database.objects.FriendFeedInfo
 import me.rhunk.snapenhance.database.objects.FriendInfo
<a href="#h101-0-3" id="h101-0-3" class="i">+import me.rhunk.snapenhance.util.getApplicationInfoCompat
</a> import me.rhunk.snapenhance.util.protobuf.ProtoReader
 import me.rhunk.snapenhance.util.snap.EncryptionHelper
 import me.rhunk.snapenhance.util.snap.MediaDownloaderHelper
<a href="#h101-1" id="h101-1" class="h">@@ -190,7 +191,7 @@ class MessageExporter(
</a> 
         runCatching {
             ZipFile(
<a href="#h101-1-3" id="h101-1-3" class="d">-                context.androidContext.packageManager.getApplicationInfo(BuildConfig.APPLICATION_ID, PackageManager.GET_META_DATA).publicSourceDir
</a><a href="#h101-1-4" id="h101-1-4" class="i">+                context.androidContext.packageManager.getApplicationInfoCompat(BuildConfig.APPLICATION_ID, PackageManager.GET_META_DATA).publicSourceDir
</a>             ).use { apkFile -&gt;
                 //export rawinflate.js
                 apkFile.getEntry(&quot;assets/web/rawinflate.js&quot;).let { entry -&gt;
<b>diff --git a/<a id="h102" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/util/snap/MediaDownloaderHelper.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/util/snap/MediaDownloaderHelper.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/util/snap/MediaDownloaderHelper.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/util/snap/MediaDownloaderHelper.kt</a></b>
<a href="#h102-0" id="h102-0" class="h">@@ -6,6 +6,7 @@ import kotlinx.coroutines.suspendCancellableCoroutine
</a> import me.rhunk.snapenhance.Constants
 import me.rhunk.snapenhance.data.ContentType
 import me.rhunk.snapenhance.data.FileType
<a href="#h102-0-3" id="h102-0-3" class="i">+import me.rhunk.snapenhance.download.data.SplitMediaAssetType
</a> import me.rhunk.snapenhance.util.download.RemoteMediaResolver
 import me.rhunk.snapenhance.util.protobuf.ProtoReader
 import java.io.ByteArrayInputStream
<a href="#h102-1" id="h102-1" class="h">@@ -15,9 +16,6 @@ import java.io.InputStream
</a> import java.util.concurrent.Executors
 import java.util.zip.ZipInputStream
 
<a href="#h102-1-3" id="h102-1-3" class="d">-enum class MediaType {
</a><a href="#h102-1-4" id="h102-1-4" class="d">-    ORIGINAL, OVERLAY
</a><a href="#h102-1-5" id="h102-1-5" class="d">-}
</a> 
 object MediaDownloaderHelper {
     fun getMessageMediaInfo(protoReader: ProtoReader, contentType: ContentType, isArroyo: Boolean): ProtoReader? {
<a href="#h102-2" id="h102-2" class="h">@@ -32,7 +30,7 @@ object MediaDownloaderHelper {
</a>         }
     }
 
<a href="#h102-2-3" id="h102-2-3" class="d">-    fun downloadMediaFromReference(mediaReference: ByteArray, decryptionCallback: (InputStream) -&gt; InputStream): Map&lt;MediaType, ByteArray&gt; {
</a><a href="#h102-2-4" id="h102-2-4" class="i">+    fun downloadMediaFromReference(mediaReference: ByteArray, decryptionCallback: (InputStream) -&gt; InputStream): Map&lt;SplitMediaAssetType, ByteArray&gt; {
</a>         val inputStream: InputStream = RemoteMediaResolver.downloadBoltMedia(mediaReference) ?: throw FileNotFoundException(&quot;Unable to get media key. Check the logs for more info&quot;)
         val content = decryptionCallback(inputStream).readBytes()
         val fileType = FileType.fromByteArray(content)
<a href="#h102-3" id="h102-3" class="h">@@ -55,10 +53,10 @@ object MediaDownloaderHelper {
</a>             }
             videoData ?: throw FileNotFoundException(&quot;Unable to find video file in zip file&quot;)
             overlayData ?: throw FileNotFoundException(&quot;Unable to find overlay file in zip file&quot;)
<a href="#h102-3-3" id="h102-3-3" class="d">-            return mapOf(MediaType.ORIGINAL to videoData, MediaType.OVERLAY to overlayData)
</a><a href="#h102-3-4" id="h102-3-4" class="i">+            return mapOf(SplitMediaAssetType.ORIGINAL to videoData, SplitMediaAssetType.OVERLAY to overlayData)
</a>         }
 
<a href="#h102-3-7" id="h102-3-7" class="d">-        return mapOf(MediaType.ORIGINAL to content)
</a><a href="#h102-3-8" id="h102-3-8" class="i">+        return mapOf(SplitMediaAssetType.ORIGINAL to content)
</a>     }
 
 
<b>diff --git a/<a id="h103" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/util/snap/PreviewUtils.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/util/snap/PreviewUtils.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/util/snap/PreviewUtils.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/util/snap/PreviewUtils.kt</a></b>
<a href="#h103-0" id="h103-0" class="h">@@ -8,7 +8,6 @@ import android.media.MediaDataSource
</a> import android.media.MediaMetadataRetriever
 import me.rhunk.snapenhance.data.FileType
 import java.io.File
<a href="#h103-0-3" id="h103-0-3" class="d">-import kotlin.math.roundToInt
</a> 
 object PreviewUtils {
     fun createPreview(data: ByteArray, isVideo: Boolean): Bitmap? {
<b>diff --git a/<a id="h104" href="../file/app/src/main/res/layout/device_spoofer_activity.xml.html">app/src/main/res/layout/device_spoofer_activity.xml</a> b/<a href="../file/app/src/main/res/layout/device_spoofer_activity.xml.html">app/src/main/res/layout/device_spoofer_activity.xml</a></b>
<a href="#h104-0" id="h104-0" class="h">@@ -0,0 +1,27 @@
</a><a href="#h104-0-0" id="h104-0-0" class="i">+&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
</a><a href="#h104-0-1" id="h104-0-1" class="i">+&lt;LinearLayout xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;
</a><a href="#h104-0-2" id="h104-0-2" class="i">+    xmlns:tools=&quot;http://schemas.android.com/tools&quot;
</a><a href="#h104-0-3" id="h104-0-3" class="i">+    android:orientation=&quot;vertical&quot;
</a><a href="#h104-0-4" id="h104-0-4" class="i">+    android:background=&quot;@color/primaryBackground&quot;
</a><a href="#h104-0-5" id="h104-0-5" class="i">+    android:layout_width=&quot;match_parent&quot;
</a><a href="#h104-0-6" id="h104-0-6" class="i">+    android:layout_height=&quot;match_parent&quot;&gt;
</a><a href="#h104-0-7" id="h104-0-7" class="i">+
</a><a href="#h104-0-8" id="h104-0-8" class="i">+    &lt;include
</a><a href="#h104-0-9" id="h104-0-9" class="i">+        android:id=&quot;@+id/title_bar&quot;
</a><a href="#h104-0-10" id="h104-0-10" class="i">+        layout=&quot;@layout/activity_default_header&quot; /&gt;
</a><a href="#h104-0-11" id="h104-0-11" class="i">+
</a><a href="#h104-0-12" id="h104-0-12" class="i">+    &lt;ScrollView
</a><a href="#h104-0-13" id="h104-0-13" class="i">+        android:layout_width=&quot;match_parent&quot;
</a><a href="#h104-0-14" id="h104-0-14" class="i">+        android:layout_height=&quot;match_parent&quot;
</a><a href="#h104-0-15" id="h104-0-15" class="i">+        android:fillViewport=&quot;true&quot;&gt;
</a><a href="#h104-0-16" id="h104-0-16" class="i">+
</a><a href="#h104-0-17" id="h104-0-17" class="i">+        &lt;LinearLayout
</a><a href="#h104-0-18" id="h104-0-18" class="i">+            android:id=&quot;@+id/spoof_property_list&quot;
</a><a href="#h104-0-19" id="h104-0-19" class="i">+            android:layout_width=&quot;match_parent&quot;
</a><a href="#h104-0-20" id="h104-0-20" class="i">+            android:layout_height=&quot;wrap_content&quot;
</a><a href="#h104-0-21" id="h104-0-21" class="i">+            android:orientation=&quot;vertical&quot;&gt;
</a><a href="#h104-0-22" id="h104-0-22" class="i">+        &lt;/LinearLayout&gt;
</a><a href="#h104-0-23" id="h104-0-23" class="i">+
</a><a href="#h104-0-24" id="h104-0-24" class="i">+    &lt;/ScrollView&gt;
</a><a href="#h104-0-25" id="h104-0-25" class="i">+
</a><a href="#h104-0-26" id="h104-0-26" class="i">+&lt;/LinearLayout&gt;</a><a href="#h104-0-27" id="h104-0-27" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h105" href="../file/build.gradle.html">build.gradle</a> b/<a href="../file/build.gradle.html">build.gradle</a></b>
<a href="#h105-0" id="h105-0" class="h">@@ -1,10 +0,0 @@
</a><a href="#h105-0-0" id="h105-0-0" class="d">-// Top-level build file where you can add configuration options common to all sub-projects/modules.
</a><a href="#h105-0-1" id="h105-0-1" class="d">-plugins {
</a><a href="#h105-0-2" id="h105-0-2" class="d">-    id &#39;com.android.application&#39; version &#39;8.0.2&#39; apply false
</a><a href="#h105-0-3" id="h105-0-3" class="d">-    id &#39;com.android.library&#39; version &#39;8.0.2&#39; apply false
</a><a href="#h105-0-4" id="h105-0-4" class="d">-    id &#39;org.jetbrains.kotlin.android&#39; version &#39;1.8.21&#39; apply false
</a><a href="#h105-0-5" id="h105-0-5" class="d">-}
</a><a href="#h105-0-6" id="h105-0-6" class="d">-
</a><a href="#h105-0-7" id="h105-0-7" class="d">-tasks.register(&#39;clean&#39;, Delete) {
</a><a href="#h105-0-8" id="h105-0-8" class="d">-    delete rootProject.buildDir
</a><a href="#h105-0-9" id="h105-0-9" class="d">-}</a><a href="#h105-0-10" id="h105-0-10" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h106" href="../file/build.gradle.kts.html">build.gradle.kts</a> b/<a href="../file/build.gradle.kts.html">build.gradle.kts</a></b>
<a href="#h106-0" id="h106-0" class="h">@@ -0,0 +1,8 @@
</a><a href="#h106-0-0" id="h106-0-0" class="i">+// Top-level build file where you can add configuration options common to all sub-projects/modules.
</a><a href="#h106-0-1" id="h106-0-1" class="i">+@Suppress(&quot;DSL_SCOPE_VIOLATION&quot;) // TODO: Remove once KTIJ-19369 is fixed
</a><a href="#h106-0-2" id="h106-0-2" class="i">+plugins {
</a><a href="#h106-0-3" id="h106-0-3" class="i">+    alias(libs.plugins.androidApplication) apply false
</a><a href="#h106-0-4" id="h106-0-4" class="i">+    alias(libs.plugins.kotlinAndroid) apply false
</a><a href="#h106-0-5" id="h106-0-5" class="i">+}
</a><a href="#h106-0-6" id="h106-0-6" class="i">+
</a><a href="#h106-0-7" id="h106-0-7" class="i">+true // Needed to make the Suppress annotation work for the plugins block</a><a href="#h106-0-8" id="h106-0-8" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h107" href="../file/gradle/libs.versions.toml.html">gradle/libs.versions.toml</a> b/<a href="../file/gradle/libs.versions.toml.html">gradle/libs.versions.toml</a></b>
<a href="#h107-0" id="h107-0" class="h">@@ -0,0 +1,36 @@
</a><a href="#h107-0-0" id="h107-0-0" class="i">+[versions]
</a><a href="#h107-0-1" id="h107-0-1" class="i">+agp = &quot;8.1.0&quot;
</a><a href="#h107-0-2" id="h107-0-2" class="i">+junit = &quot;4.13.2&quot;
</a><a href="#h107-0-3" id="h107-0-3" class="i">+kotlin = &quot;1.8.21&quot;
</a><a href="#h107-0-4" id="h107-0-4" class="i">+kotlinx-coroutines-android = &quot;1.7.2&quot;
</a><a href="#h107-0-5" id="h107-0-5" class="i">+kotlin-reflect = &quot;1.8.21&quot;
</a><a href="#h107-0-6" id="h107-0-6" class="i">+recyclerview = &quot;1.3.0&quot;
</a><a href="#h107-0-7" id="h107-0-7" class="i">+gson = &quot;2.10.1&quot;
</a><a href="#h107-0-8" id="h107-0-8" class="i">+ffmpeg-kit = &quot;5.1.LTS&quot;
</a><a href="#h107-0-9" id="h107-0-9" class="i">+osmdroid-android = &quot;6.1.16&quot;
</a><a href="#h107-0-10" id="h107-0-10" class="i">+okhttp = &quot;5.0.0-alpha.11&quot;
</a><a href="#h107-0-11" id="h107-0-11" class="i">+dexlib2 = &quot;2.5.2&quot;
</a><a href="#h107-0-12" id="h107-0-12" class="i">+androidx-documentfile = &quot;1.1.0-alpha01&quot;
</a><a href="#h107-0-13" id="h107-0-13" class="i">+
</a><a href="#h107-0-14" id="h107-0-14" class="i">+
</a><a href="#h107-0-15" id="h107-0-15" class="i">+[libraries]
</a><a href="#h107-0-16" id="h107-0-16" class="i">+coroutines = { group = &quot;org.jetbrains.kotlinx&quot;, name = &quot;kotlinx-coroutines-android&quot;, version.ref = &quot;kotlinx-coroutines-android&quot; }
</a><a href="#h107-0-17" id="h107-0-17" class="i">+junit = { module = &quot;junit:junit&quot;, version.ref = &quot;junit&quot; }
</a><a href="#h107-0-18" id="h107-0-18" class="i">+kotlin-reflect = { group = &quot;org.jetbrains.kotlin&quot;, name = &quot;kotlin-reflect&quot;, version.ref = &quot;kotlin-reflect&quot; }
</a><a href="#h107-0-19" id="h107-0-19" class="i">+recyclerview = { group = &quot;androidx.recyclerview&quot;, name = &quot;recyclerview&quot;, version.ref = &quot;recyclerview&quot; }
</a><a href="#h107-0-20" id="h107-0-20" class="i">+gson = { group = &quot;com.google.code.gson&quot;, name = &quot;gson&quot;, version.ref = &quot;gson&quot; }
</a><a href="#h107-0-21" id="h107-0-21" class="i">+ffmpeg-kit = { group = &quot;com.arthenica&quot;, name = &quot;ffmpeg-kit-full-gpl&quot;, version.ref = &quot;ffmpeg-kit&quot; }
</a><a href="#h107-0-22" id="h107-0-22" class="i">+osmdroid-android = { group = &quot;org.osmdroid&quot;, name = &quot;osmdroid-android&quot;, version.ref = &quot;osmdroid-android&quot; }
</a><a href="#h107-0-23" id="h107-0-23" class="i">+okhttp = { group = &quot;com.squareup.okhttp3&quot;, name = &quot;okhttp&quot;, version.ref = &quot;okhttp&quot; }
</a><a href="#h107-0-24" id="h107-0-24" class="i">+dexlib2 = { group = &quot;org.smali&quot;, name = &quot;dexlib2&quot;, version.ref = &quot;dexlib2&quot; }
</a><a href="#h107-0-25" id="h107-0-25" class="i">+androidx-documentfile = { group = &quot;androidx.documentfile&quot;, name = &quot;documentfile&quot;, version.ref = &quot;androidx-documentfile&quot; }
</a><a href="#h107-0-26" id="h107-0-26" class="i">+
</a><a href="#h107-0-27" id="h107-0-27" class="i">+
</a><a href="#h107-0-28" id="h107-0-28" class="i">+[plugins]
</a><a href="#h107-0-29" id="h107-0-29" class="i">+androidApplication = { id = &quot;com.android.application&quot;, version.ref = &quot;agp&quot; }
</a><a href="#h107-0-30" id="h107-0-30" class="i">+androidLibrary = { id = &quot;com.android.library&quot;, version.ref = &quot;agp&quot; }
</a><a href="#h107-0-31" id="h107-0-31" class="i">+kotlinAndroid = { id = &quot;org.jetbrains.kotlin.android&quot;, version.ref = &quot;kotlin&quot; }
</a><a href="#h107-0-32" id="h107-0-32" class="i">+
</a><a href="#h107-0-33" id="h107-0-33" class="i">+
</a><a href="#h107-0-34" id="h107-0-34" class="i">+[bundles]
</a><a href="#h107-0-35" id="h107-0-35" class="i">+
</a><b>diff --git a/<a id="h108" href="../file/gradle/wrapper/gradle-wrapper.properties.html">gradle/wrapper/gradle-wrapper.properties</a> b/<a href="../file/gradle/wrapper/gradle-wrapper.properties.html">gradle/wrapper/gradle-wrapper.properties</a></b>
<a href="#h108-0" id="h108-0" class="h">@@ -1,6 +1,6 @@
</a> #Fri May 12 21:23:16 CEST 2023
 distributionBase=GRADLE_USER_HOME
<a href="#h108-0-2" id="h108-0-2" class="d">-distributionUrl=https\://services.gradle.org/distributions/gradle-8.0-bin.zip
</a><a href="#h108-0-3" id="h108-0-3" class="i">+distributionUrl=https\://services.gradle.org/distributions/gradle-8.1-bin.zip
</a> distributionPath=wrapper/dists
 zipStorePath=wrapper/dists
 zipStoreBase=GRADLE_USER_HOME
<b>diff --git a/<a id="h109" href="../file/mapper/.gitignore.html">mapper/.gitignore</a> b/<a href="../file/mapper/.gitignore.html">mapper/.gitignore</a></b>
<a href="#h109-0" id="h109-0" class="h">@@ -0,0 +1 @@
</a><a href="#h109-0-0" id="h109-0-0" class="i">+build/</a><a href="#h109-0-1" id="h109-0-1" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h110" href="../file/mapper/build.gradle.kts.html">mapper/build.gradle.kts</a> b/<a href="../file/mapper/build.gradle.kts.html">mapper/build.gradle.kts</a></b>
<a href="#h110-0" id="h110-0" class="h">@@ -0,0 +1,21 @@
</a><a href="#h110-0-0" id="h110-0-0" class="i">+@Suppress(&quot;DSL_SCOPE_VIOLATION&quot;) // TODO: Remove once KTIJ-19369 is fixed
</a><a href="#h110-0-1" id="h110-0-1" class="i">+plugins {
</a><a href="#h110-0-2" id="h110-0-2" class="i">+    id(&quot;com.android.library&quot;)
</a><a href="#h110-0-3" id="h110-0-3" class="i">+    alias(libs.plugins.kotlinAndroid)
</a><a href="#h110-0-4" id="h110-0-4" class="i">+}
</a><a href="#h110-0-5" id="h110-0-5" class="i">+
</a><a href="#h110-0-6" id="h110-0-6" class="i">+android {
</a><a href="#h110-0-7" id="h110-0-7" class="i">+    namespace = &quot;me.rhunk.snapenhance.mapper&quot;
</a><a href="#h110-0-8" id="h110-0-8" class="i">+    compileSdk = 33
</a><a href="#h110-0-9" id="h110-0-9" class="i">+
</a><a href="#h110-0-10" id="h110-0-10" class="i">+    kotlinOptions {
</a><a href="#h110-0-11" id="h110-0-11" class="i">+        jvmTarget = &quot;1.8&quot;
</a><a href="#h110-0-12" id="h110-0-12" class="i">+    }
</a><a href="#h110-0-13" id="h110-0-13" class="i">+}
</a><a href="#h110-0-14" id="h110-0-14" class="i">+
</a><a href="#h110-0-15" id="h110-0-15" class="i">+dependencies {
</a><a href="#h110-0-16" id="h110-0-16" class="i">+    implementation(libs.gson)
</a><a href="#h110-0-17" id="h110-0-17" class="i">+    implementation(libs.coroutines)
</a><a href="#h110-0-18" id="h110-0-18" class="i">+    implementation(libs.dexlib2)
</a><a href="#h110-0-19" id="h110-0-19" class="i">+    testImplementation(libs.junit)
</a><a href="#h110-0-20" id="h110-0-20" class="i">+}</a><a href="#h110-0-21" id="h110-0-21" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h111" href="../file/mapper/src/main/kotlin/me/rhunk/snapmapper/AbstractClassMapper.kt.html">mapper/src/main/kotlin/me/rhunk/snapmapper/AbstractClassMapper.kt</a> b/<a href="../file/mapper/src/main/kotlin/me/rhunk/snapmapper/AbstractClassMapper.kt.html">mapper/src/main/kotlin/me/rhunk/snapmapper/AbstractClassMapper.kt</a></b>
<a href="#h111-0" id="h111-0" class="h">@@ -0,0 +1,9 @@
</a><a href="#h111-0-0" id="h111-0-0" class="i">+package me.rhunk.snapmapper
</a><a href="#h111-0-1" id="h111-0-1" class="i">+
</a><a href="#h111-0-2" id="h111-0-2" class="i">+import kotlin.reflect.KClass
</a><a href="#h111-0-3" id="h111-0-3" class="i">+
</a><a href="#h111-0-4" id="h111-0-4" class="i">+abstract class AbstractClassMapper(
</a><a href="#h111-0-5" id="h111-0-5" class="i">+   vararg val dependsOn: KClass&lt;out AbstractClassMapper&gt; = arrayOf()
</a><a href="#h111-0-6" id="h111-0-6" class="i">+) {
</a><a href="#h111-0-7" id="h111-0-7" class="i">+    abstract fun run(context: MapperContext)
</a><a href="#h111-0-8" id="h111-0-8" class="i">+}</a><a href="#h111-0-9" id="h111-0-9" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h112" href="../file/mapper/src/main/kotlin/me/rhunk/snapmapper/Mapper.kt.html">mapper/src/main/kotlin/me/rhunk/snapmapper/Mapper.kt</a> b/<a href="../file/mapper/src/main/kotlin/me/rhunk/snapmapper/Mapper.kt.html">mapper/src/main/kotlin/me/rhunk/snapmapper/Mapper.kt</a></b>
<a href="#h112-0" id="h112-0" class="h">@@ -0,0 +1,90 @@
</a><a href="#h112-0-0" id="h112-0-0" class="i">+package me.rhunk.snapmapper
</a><a href="#h112-0-1" id="h112-0-1" class="i">+
</a><a href="#h112-0-2" id="h112-0-2" class="i">+import com.google.gson.JsonObject
</a><a href="#h112-0-3" id="h112-0-3" class="i">+import kotlinx.coroutines.Dispatchers
</a><a href="#h112-0-4" id="h112-0-4" class="i">+import kotlinx.coroutines.launch
</a><a href="#h112-0-5" id="h112-0-5" class="i">+import kotlinx.coroutines.runBlocking
</a><a href="#h112-0-6" id="h112-0-6" class="i">+import kotlinx.coroutines.withContext
</a><a href="#h112-0-7" id="h112-0-7" class="i">+import org.jf.dexlib2.Opcodes
</a><a href="#h112-0-8" id="h112-0-8" class="i">+import org.jf.dexlib2.dexbacked.DexBackedDexFile
</a><a href="#h112-0-9" id="h112-0-9" class="i">+import org.jf.dexlib2.iface.ClassDef
</a><a href="#h112-0-10" id="h112-0-10" class="i">+import java.io.BufferedInputStream
</a><a href="#h112-0-11" id="h112-0-11" class="i">+import java.io.InputStream
</a><a href="#h112-0-12" id="h112-0-12" class="i">+import java.util.zip.ZipFile
</a><a href="#h112-0-13" id="h112-0-13" class="i">+import java.util.zip.ZipInputStream
</a><a href="#h112-0-14" id="h112-0-14" class="i">+import kotlin.reflect.KClass
</a><a href="#h112-0-15" id="h112-0-15" class="i">+
</a><a href="#h112-0-16" id="h112-0-16" class="i">+class Mapper(
</a><a href="#h112-0-17" id="h112-0-17" class="i">+    private vararg val mappers: KClass&lt;out AbstractClassMapper&gt; = arrayOf()
</a><a href="#h112-0-18" id="h112-0-18" class="i">+) {
</a><a href="#h112-0-19" id="h112-0-19" class="i">+    private val classes = mutableListOf&lt;ClassDef&gt;()
</a><a href="#h112-0-20" id="h112-0-20" class="i">+    fun loadApk(path: String) {
</a><a href="#h112-0-21" id="h112-0-21" class="i">+        val apkFile = ZipFile(path)
</a><a href="#h112-0-22" id="h112-0-22" class="i">+        val apkEntries = apkFile.entries().toList()
</a><a href="#h112-0-23" id="h112-0-23" class="i">+
</a><a href="#h112-0-24" id="h112-0-24" class="i">+        fun readClass(stream: InputStream) = runCatching {
</a><a href="#h112-0-25" id="h112-0-25" class="i">+            classes.addAll(
</a><a href="#h112-0-26" id="h112-0-26" class="i">+                DexBackedDexFile.fromInputStream(Opcodes.getDefault(), BufferedInputStream(stream)).classes
</a><a href="#h112-0-27" id="h112-0-27" class="i">+            )
</a><a href="#h112-0-28" id="h112-0-28" class="i">+        }.onFailure {
</a><a href="#h112-0-29" id="h112-0-29" class="i">+            throw Throwable(&quot;Failed to load dex file&quot;, it)
</a><a href="#h112-0-30" id="h112-0-30" class="i">+        }
</a><a href="#h112-0-31" id="h112-0-31" class="i">+
</a><a href="#h112-0-32" id="h112-0-32" class="i">+        fun filterDexClasses(name: String) = name.startsWith(&quot;classes&quot;) &amp;&amp; name.endsWith(&quot;.dex&quot;)
</a><a href="#h112-0-33" id="h112-0-33" class="i">+
</a><a href="#h112-0-34" id="h112-0-34" class="i">+        apkEntries.firstOrNull { it.name.endsWith(&quot;lspatch/origin.apk&quot;) }?.let { origin -&gt;
</a><a href="#h112-0-35" id="h112-0-35" class="i">+            val originApk = ZipInputStream(apkFile.getInputStream(origin))
</a><a href="#h112-0-36" id="h112-0-36" class="i">+            var nextEntry = originApk.nextEntry
</a><a href="#h112-0-37" id="h112-0-37" class="i">+            while (nextEntry != null) {
</a><a href="#h112-0-38" id="h112-0-38" class="i">+                if (filterDexClasses(nextEntry.name)) {
</a><a href="#h112-0-39" id="h112-0-39" class="i">+                    readClass(originApk)
</a><a href="#h112-0-40" id="h112-0-40" class="i">+                }
</a><a href="#h112-0-41" id="h112-0-41" class="i">+                originApk.closeEntry()
</a><a href="#h112-0-42" id="h112-0-42" class="i">+                nextEntry = originApk.nextEntry
</a><a href="#h112-0-43" id="h112-0-43" class="i">+            }
</a><a href="#h112-0-44" id="h112-0-44" class="i">+            return
</a><a href="#h112-0-45" id="h112-0-45" class="i">+        }
</a><a href="#h112-0-46" id="h112-0-46" class="i">+
</a><a href="#h112-0-47" id="h112-0-47" class="i">+        apkEntries.toList().filter { filterDexClasses(it.name) }.forEach {
</a><a href="#h112-0-48" id="h112-0-48" class="i">+            readClass(apkFile.getInputStream(it))
</a><a href="#h112-0-49" id="h112-0-49" class="i">+        }
</a><a href="#h112-0-50" id="h112-0-50" class="i">+    }
</a><a href="#h112-0-51" id="h112-0-51" class="i">+
</a><a href="#h112-0-52" id="h112-0-52" class="i">+    fun start(): JsonObject {
</a><a href="#h112-0-53" id="h112-0-53" class="i">+        val mappers = mappers.map { it.java.constructors.first().newInstance() as AbstractClassMapper }
</a><a href="#h112-0-54" id="h112-0-54" class="i">+        val context = MapperContext(classes.associateBy { it.type })
</a><a href="#h112-0-55" id="h112-0-55" class="i">+
</a><a href="#h112-0-56" id="h112-0-56" class="i">+        runBlocking {
</a><a href="#h112-0-57" id="h112-0-57" class="i">+            withContext(Dispatchers.IO) {
</a><a href="#h112-0-58" id="h112-0-58" class="i">+                val finishedJobs = mutableListOf&lt;Class&lt;*&gt;&gt;()
</a><a href="#h112-0-59" id="h112-0-59" class="i">+                val dependentsMappers = mappers.filter { it.dependsOn.isNotEmpty() }
</a><a href="#h112-0-60" id="h112-0-60" class="i">+
</a><a href="#h112-0-61" id="h112-0-61" class="i">+                fun onJobFinished(mapper: AbstractClassMapper) {
</a><a href="#h112-0-62" id="h112-0-62" class="i">+                    finishedJobs.add(mapper.javaClass)
</a><a href="#h112-0-63" id="h112-0-63" class="i">+
</a><a href="#h112-0-64" id="h112-0-64" class="i">+                    dependentsMappers.filter { it -&gt;
</a><a href="#h112-0-65" id="h112-0-65" class="i">+                        !finishedJobs.contains(it.javaClass) &amp;&amp;
</a><a href="#h112-0-66" id="h112-0-66" class="i">+                                it.dependsOn.all {
</a><a href="#h112-0-67" id="h112-0-67" class="i">+                                    finishedJobs.contains(it.java)
</a><a href="#h112-0-68" id="h112-0-68" class="i">+                                }
</a><a href="#h112-0-69" id="h112-0-69" class="i">+                    }.forEach {
</a><a href="#h112-0-70" id="h112-0-70" class="i">+                        launch {
</a><a href="#h112-0-71" id="h112-0-71" class="i">+                            it.run(context)
</a><a href="#h112-0-72" id="h112-0-72" class="i">+                            onJobFinished(it)
</a><a href="#h112-0-73" id="h112-0-73" class="i">+                        }
</a><a href="#h112-0-74" id="h112-0-74" class="i">+                    }
</a><a href="#h112-0-75" id="h112-0-75" class="i">+                }
</a><a href="#h112-0-76" id="h112-0-76" class="i">+
</a><a href="#h112-0-77" id="h112-0-77" class="i">+                mappers.forEach { mapper -&gt;
</a><a href="#h112-0-78" id="h112-0-78" class="i">+                    if (mapper.dependsOn.isNotEmpty()) return@forEach
</a><a href="#h112-0-79" id="h112-0-79" class="i">+                    launch {
</a><a href="#h112-0-80" id="h112-0-80" class="i">+                        mapper.run(context)
</a><a href="#h112-0-81" id="h112-0-81" class="i">+                        onJobFinished(mapper)
</a><a href="#h112-0-82" id="h112-0-82" class="i">+                    }
</a><a href="#h112-0-83" id="h112-0-83" class="i">+                }
</a><a href="#h112-0-84" id="h112-0-84" class="i">+            }
</a><a href="#h112-0-85" id="h112-0-85" class="i">+        }
</a><a href="#h112-0-86" id="h112-0-86" class="i">+
</a><a href="#h112-0-87" id="h112-0-87" class="i">+        return context.exportToJson()
</a><a href="#h112-0-88" id="h112-0-88" class="i">+    }
</a><a href="#h112-0-89" id="h112-0-89" class="i">+}</a><a href="#h112-0-90" id="h112-0-90" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h113" href="../file/mapper/src/main/kotlin/me/rhunk/snapmapper/MapperContext.kt.html">mapper/src/main/kotlin/me/rhunk/snapmapper/MapperContext.kt</a> b/<a href="../file/mapper/src/main/kotlin/me/rhunk/snapmapper/MapperContext.kt.html">mapper/src/main/kotlin/me/rhunk/snapmapper/MapperContext.kt</a></b>
<a href="#h113-0" id="h113-0" class="h">@@ -0,0 +1,58 @@
</a><a href="#h113-0-0" id="h113-0-0" class="i">+package me.rhunk.snapmapper
</a><a href="#h113-0-1" id="h113-0-1" class="i">+
</a><a href="#h113-0-2" id="h113-0-2" class="i">+import com.google.gson.GsonBuilder
</a><a href="#h113-0-3" id="h113-0-3" class="i">+import com.google.gson.JsonObject
</a><a href="#h113-0-4" id="h113-0-4" class="i">+import org.jf.dexlib2.iface.ClassDef
</a><a href="#h113-0-5" id="h113-0-5" class="i">+
</a><a href="#h113-0-6" id="h113-0-6" class="i">+class MapperContext(
</a><a href="#h113-0-7" id="h113-0-7" class="i">+    private val classMap: Map&lt;String, ClassDef&gt;
</a><a href="#h113-0-8" id="h113-0-8" class="i">+) {
</a><a href="#h113-0-9" id="h113-0-9" class="i">+    val classes: Collection&lt;ClassDef&gt;
</a><a href="#h113-0-10" id="h113-0-10" class="i">+        get() = classMap.values
</a><a href="#h113-0-11" id="h113-0-11" class="i">+
</a><a href="#h113-0-12" id="h113-0-12" class="i">+    fun getClass(name: String?): ClassDef? {
</a><a href="#h113-0-13" id="h113-0-13" class="i">+        if (name == null) return null
</a><a href="#h113-0-14" id="h113-0-14" class="i">+        return classMap[name]
</a><a href="#h113-0-15" id="h113-0-15" class="i">+    }
</a><a href="#h113-0-16" id="h113-0-16" class="i">+
</a><a href="#h113-0-17" id="h113-0-17" class="i">+    fun getClass(name: CharSequence?): ClassDef? {
</a><a href="#h113-0-18" id="h113-0-18" class="i">+        if (name == null) return null
</a><a href="#h113-0-19" id="h113-0-19" class="i">+        return classMap[name.toString()]
</a><a href="#h113-0-20" id="h113-0-20" class="i">+    }
</a><a href="#h113-0-21" id="h113-0-21" class="i">+
</a><a href="#h113-0-22" id="h113-0-22" class="i">+    private val mappings = mutableMapOf&lt;String, Any&gt;()
</a><a href="#h113-0-23" id="h113-0-23" class="i">+
</a><a href="#h113-0-24" id="h113-0-24" class="i">+    fun addMapping(key: String, vararg array: Pair&lt;String, Any&gt;) {
</a><a href="#h113-0-25" id="h113-0-25" class="i">+        mappings[key] = array.toMap()
</a><a href="#h113-0-26" id="h113-0-26" class="i">+    }
</a><a href="#h113-0-27" id="h113-0-27" class="i">+
</a><a href="#h113-0-28" id="h113-0-28" class="i">+    fun addMapping(key: String, value: String) {
</a><a href="#h113-0-29" id="h113-0-29" class="i">+        mappings[key] = value
</a><a href="#h113-0-30" id="h113-0-30" class="i">+    }
</a><a href="#h113-0-31" id="h113-0-31" class="i">+
</a><a href="#h113-0-32" id="h113-0-32" class="i">+    fun getStringMapping(key: String): String? {
</a><a href="#h113-0-33" id="h113-0-33" class="i">+        return mappings[key] as? String
</a><a href="#h113-0-34" id="h113-0-34" class="i">+    }
</a><a href="#h113-0-35" id="h113-0-35" class="i">+
</a><a href="#h113-0-36" id="h113-0-36" class="i">+    fun getMapMapping(key: String): Map&lt;*, *&gt;? {
</a><a href="#h113-0-37" id="h113-0-37" class="i">+        return mappings[key] as? Map&lt;*, *&gt;
</a><a href="#h113-0-38" id="h113-0-38" class="i">+    }
</a><a href="#h113-0-39" id="h113-0-39" class="i">+
</a><a href="#h113-0-40" id="h113-0-40" class="i">+    fun exportToJson(): JsonObject {
</a><a href="#h113-0-41" id="h113-0-41" class="i">+        val gson = GsonBuilder().setPrettyPrinting().create()
</a><a href="#h113-0-42" id="h113-0-42" class="i">+        val json = JsonObject()
</a><a href="#h113-0-43" id="h113-0-43" class="i">+        for ((key, value) in mappings) {
</a><a href="#h113-0-44" id="h113-0-44" class="i">+            when (value) {
</a><a href="#h113-0-45" id="h113-0-45" class="i">+                is String -&gt; json.addProperty(key, value)
</a><a href="#h113-0-46" id="h113-0-46" class="i">+                is Map&lt;*, *&gt; -&gt; {
</a><a href="#h113-0-47" id="h113-0-47" class="i">+                    val obj = JsonObject()
</a><a href="#h113-0-48" id="h113-0-48" class="i">+                    for ((k, v) in value) {
</a><a href="#h113-0-49" id="h113-0-49" class="i">+                        obj.add(k.toString(), gson.toJsonTree(v))
</a><a href="#h113-0-50" id="h113-0-50" class="i">+                    }
</a><a href="#h113-0-51" id="h113-0-51" class="i">+                    json.add(key, obj)
</a><a href="#h113-0-52" id="h113-0-52" class="i">+                }
</a><a href="#h113-0-53" id="h113-0-53" class="i">+            }
</a><a href="#h113-0-54" id="h113-0-54" class="i">+        }
</a><a href="#h113-0-55" id="h113-0-55" class="i">+        return json
</a><a href="#h113-0-56" id="h113-0-56" class="i">+    }
</a><a href="#h113-0-57" id="h113-0-57" class="i">+}</a><a href="#h113-0-58" id="h113-0-58" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h114" href="../file/mapper/src/main/kotlin/me/rhunk/snapmapper/ext/DexClassDef.kt.html">mapper/src/main/kotlin/me/rhunk/snapmapper/ext/DexClassDef.kt</a> b/<a href="../file/mapper/src/main/kotlin/me/rhunk/snapmapper/ext/DexClassDef.kt.html">mapper/src/main/kotlin/me/rhunk/snapmapper/ext/DexClassDef.kt</a></b>
<a href="#h114-0" id="h114-0" class="h">@@ -0,0 +1,23 @@
</a><a href="#h114-0-0" id="h114-0-0" class="i">+package me.rhunk.snapmapper.ext
</a><a href="#h114-0-1" id="h114-0-1" class="i">+
</a><a href="#h114-0-2" id="h114-0-2" class="i">+import org.jf.dexlib2.AccessFlags
</a><a href="#h114-0-3" id="h114-0-3" class="i">+import org.jf.dexlib2.iface.ClassDef
</a><a href="#h114-0-4" id="h114-0-4" class="i">+
</a><a href="#h114-0-5" id="h114-0-5" class="i">+fun ClassDef.isEnum(): Boolean = accessFlags and AccessFlags.ENUM.value != 0
</a><a href="#h114-0-6" id="h114-0-6" class="i">+fun ClassDef.isAbstract(): Boolean = accessFlags and AccessFlags.ABSTRACT.value != 0
</a><a href="#h114-0-7" id="h114-0-7" class="i">+fun ClassDef.isFinal(): Boolean = accessFlags and AccessFlags.FINAL.value != 0
</a><a href="#h114-0-8" id="h114-0-8" class="i">+
</a><a href="#h114-0-9" id="h114-0-9" class="i">+fun ClassDef.hasStaticConstructorString(string: String): Boolean = methods.any {
</a><a href="#h114-0-10" id="h114-0-10" class="i">+    it.name == &quot;&lt;clinit&gt;&quot; &amp;&amp; it.implementation?.findConstString(string) == true
</a><a href="#h114-0-11" id="h114-0-11" class="i">+}
</a><a href="#h114-0-12" id="h114-0-12" class="i">+
</a><a href="#h114-0-13" id="h114-0-13" class="i">+fun ClassDef.hasConstructorString(string: String): Boolean = methods.any {
</a><a href="#h114-0-14" id="h114-0-14" class="i">+    it.name == &quot;&lt;init&gt;&quot; &amp;&amp; it.implementation?.findConstString(string) == true
</a><a href="#h114-0-15" id="h114-0-15" class="i">+}
</a><a href="#h114-0-16" id="h114-0-16" class="i">+
</a><a href="#h114-0-17" id="h114-0-17" class="i">+fun ClassDef.getStaticConstructor() = methods.firstOrNull {
</a><a href="#h114-0-18" id="h114-0-18" class="i">+    it.name == &quot;&lt;clinit&gt;&quot;
</a><a href="#h114-0-19" id="h114-0-19" class="i">+}
</a><a href="#h114-0-20" id="h114-0-20" class="i">+
</a><a href="#h114-0-21" id="h114-0-21" class="i">+fun ClassDef.getClassName() = type.replaceFirst(&quot;L&quot;, &quot;&quot;).replaceFirst(&quot;;&quot;, &quot;&quot;)
</a><a href="#h114-0-22" id="h114-0-22" class="i">+fun ClassDef.getSuperClassName() = superclass?.replaceFirst(&quot;L&quot;, &quot;&quot;)?.replaceFirst(&quot;;&quot;, &quot;&quot;)
</a><b>diff --git a/<a id="h115" href="../file/mapper/src/main/kotlin/me/rhunk/snapmapper/ext/DexMethod.kt.html">mapper/src/main/kotlin/me/rhunk/snapmapper/ext/DexMethod.kt</a> b/<a href="../file/mapper/src/main/kotlin/me/rhunk/snapmapper/ext/DexMethod.kt.html">mapper/src/main/kotlin/me/rhunk/snapmapper/ext/DexMethod.kt</a></b>
<a href="#h115-0" id="h115-0" class="h">@@ -0,0 +1,44 @@
</a><a href="#h115-0-0" id="h115-0-0" class="i">+package me.rhunk.snapmapper.ext
</a><a href="#h115-0-1" id="h115-0-1" class="i">+
</a><a href="#h115-0-2" id="h115-0-2" class="i">+import org.jf.dexlib2.iface.MethodImplementation
</a><a href="#h115-0-3" id="h115-0-3" class="i">+import org.jf.dexlib2.iface.instruction.formats.Instruction21c
</a><a href="#h115-0-4" id="h115-0-4" class="i">+import org.jf.dexlib2.iface.instruction.formats.Instruction22c
</a><a href="#h115-0-5" id="h115-0-5" class="i">+import org.jf.dexlib2.iface.reference.FieldReference
</a><a href="#h115-0-6" id="h115-0-6" class="i">+import org.jf.dexlib2.iface.reference.StringReference
</a><a href="#h115-0-7" id="h115-0-7" class="i">+
</a><a href="#h115-0-8" id="h115-0-8" class="i">+fun MethodImplementation.findConstString(string: String, contains: Boolean = false): Boolean = instructions.filterIsInstance(Instruction21c::class.java).any {
</a><a href="#h115-0-9" id="h115-0-9" class="i">+     (it.reference as? StringReference)?.string?.let { str -&gt;
</a><a href="#h115-0-10" id="h115-0-10" class="i">+        if (contains) {
</a><a href="#h115-0-11" id="h115-0-11" class="i">+            str.contains(string)
</a><a href="#h115-0-12" id="h115-0-12" class="i">+        } else {
</a><a href="#h115-0-13" id="h115-0-13" class="i">+            str == string
</a><a href="#h115-0-14" id="h115-0-14" class="i">+        }
</a><a href="#h115-0-15" id="h115-0-15" class="i">+    } == true
</a><a href="#h115-0-16" id="h115-0-16" class="i">+}
</a><a href="#h115-0-17" id="h115-0-17" class="i">+
</a><a href="#h115-0-18" id="h115-0-18" class="i">+fun MethodImplementation.getAllConstStrings(): List&lt;String&gt; = instructions.filterIsInstance&lt;Instruction21c&gt;().mapNotNull {
</a><a href="#h115-0-19" id="h115-0-19" class="i">+    it.reference as? StringReference
</a><a href="#h115-0-20" id="h115-0-20" class="i">+}.map {
</a><a href="#h115-0-21" id="h115-0-21" class="i">+    it.string
</a><a href="#h115-0-22" id="h115-0-22" class="i">+}
</a><a href="#h115-0-23" id="h115-0-23" class="i">+
</a><a href="#h115-0-24" id="h115-0-24" class="i">+fun MethodImplementation.searchNextFieldReference(constString: String, contains: Boolean = false): FieldReference? = this.instructions.let {
</a><a href="#h115-0-25" id="h115-0-25" class="i">+    var found = false
</a><a href="#h115-0-26" id="h115-0-26" class="i">+    for (instruction in it) {
</a><a href="#h115-0-27" id="h115-0-27" class="i">+        if (instruction is Instruction21c &amp;&amp; instruction.reference is StringReference) {
</a><a href="#h115-0-28" id="h115-0-28" class="i">+            val str = (instruction.reference as StringReference).string
</a><a href="#h115-0-29" id="h115-0-29" class="i">+            if (if (contains) str.contains(constString) else str == constString) {
</a><a href="#h115-0-30" id="h115-0-30" class="i">+                found = true
</a><a href="#h115-0-31" id="h115-0-31" class="i">+            }
</a><a href="#h115-0-32" id="h115-0-32" class="i">+        }
</a><a href="#h115-0-33" id="h115-0-33" class="i">+
</a><a href="#h115-0-34" id="h115-0-34" class="i">+        if (!found) continue
</a><a href="#h115-0-35" id="h115-0-35" class="i">+
</a><a href="#h115-0-36" id="h115-0-36" class="i">+        if (instruction is Instruction22c &amp;&amp;
</a><a href="#h115-0-37" id="h115-0-37" class="i">+            instruction.reference is FieldReference
</a><a href="#h115-0-38" id="h115-0-38" class="i">+        ) {
</a><a href="#h115-0-39" id="h115-0-39" class="i">+            return@let (instruction.reference as FieldReference)
</a><a href="#h115-0-40" id="h115-0-40" class="i">+        }
</a><a href="#h115-0-41" id="h115-0-41" class="i">+    }
</a><a href="#h115-0-42" id="h115-0-42" class="i">+    null
</a><a href="#h115-0-43" id="h115-0-43" class="i">+}
</a><b>diff --git a/<a id="h116" href="../file/mapper/src/main/kotlin/me/rhunk/snapmapper/impl/BCryptClassMapper.kt.html">mapper/src/main/kotlin/me/rhunk/snapmapper/impl/BCryptClassMapper.kt</a> b/<a href="../file/mapper/src/main/kotlin/me/rhunk/snapmapper/impl/BCryptClassMapper.kt.html">mapper/src/main/kotlin/me/rhunk/snapmapper/impl/BCryptClassMapper.kt</a></b>
<a href="#h116-0" id="h116-0" class="h">@@ -0,0 +1,34 @@
</a><a href="#h116-0-0" id="h116-0-0" class="i">+package me.rhunk.snapmapper.impl
</a><a href="#h116-0-1" id="h116-0-1" class="i">+
</a><a href="#h116-0-2" id="h116-0-2" class="i">+import me.rhunk.snapmapper.AbstractClassMapper
</a><a href="#h116-0-3" id="h116-0-3" class="i">+import me.rhunk.snapmapper.MapperContext
</a><a href="#h116-0-4" id="h116-0-4" class="i">+import me.rhunk.snapmapper.ext.getStaticConstructor
</a><a href="#h116-0-5" id="h116-0-5" class="i">+import me.rhunk.snapmapper.ext.isFinal
</a><a href="#h116-0-6" id="h116-0-6" class="i">+import org.jf.dexlib2.iface.instruction.formats.ArrayPayload
</a><a href="#h116-0-7" id="h116-0-7" class="i">+
</a><a href="#h116-0-8" id="h116-0-8" class="i">+class BCryptClassMapper : AbstractClassMapper() {
</a><a href="#h116-0-9" id="h116-0-9" class="i">+    override fun run(context: MapperContext) {
</a><a href="#h116-0-10" id="h116-0-10" class="i">+        for (clazz in context.classes) {
</a><a href="#h116-0-11" id="h116-0-11" class="i">+            if (!clazz.isFinal()) continue
</a><a href="#h116-0-12" id="h116-0-12" class="i">+
</a><a href="#h116-0-13" id="h116-0-13" class="i">+            val isBcryptClass = clazz.getStaticConstructor()?.let { constructor -&gt;
</a><a href="#h116-0-14" id="h116-0-14" class="i">+                constructor.implementation?.instructions?.filterIsInstance&lt;ArrayPayload&gt;()?.any { it.arrayElements.size == 18 &amp;&amp; it.arrayElements[0] == 608135816 }
</a><a href="#h116-0-15" id="h116-0-15" class="i">+            }
</a><a href="#h116-0-16" id="h116-0-16" class="i">+
</a><a href="#h116-0-17" id="h116-0-17" class="i">+            if (isBcryptClass == true) {
</a><a href="#h116-0-18" id="h116-0-18" class="i">+                val hashMethod = clazz.methods.first {
</a><a href="#h116-0-19" id="h116-0-19" class="i">+                    it.parameterTypes.size == 2 &amp;&amp;
</a><a href="#h116-0-20" id="h116-0-20" class="i">+                    it.parameterTypes[0] == &quot;Ljava/lang/String;&quot; &amp;&amp;
</a><a href="#h116-0-21" id="h116-0-21" class="i">+                    it.parameterTypes[1] == &quot;Ljava/lang/String;&quot; &amp;&amp;
</a><a href="#h116-0-22" id="h116-0-22" class="i">+                    it.returnType == &quot;Ljava/lang/String;&quot;
</a><a href="#h116-0-23" id="h116-0-23" class="i">+                }
</a><a href="#h116-0-24" id="h116-0-24" class="i">+
</a><a href="#h116-0-25" id="h116-0-25" class="i">+                context.addMapping(&quot;BCrypt&quot;,
</a><a href="#h116-0-26" id="h116-0-26" class="i">+                    &quot;class&quot; to clazz.type.replace(&quot;L&quot;, &quot;&quot;).replace(&quot;;&quot;, &quot;&quot;),
</a><a href="#h116-0-27" id="h116-0-27" class="i">+                    &quot;hashMethod&quot; to hashMethod.name
</a><a href="#h116-0-28" id="h116-0-28" class="i">+                )
</a><a href="#h116-0-29" id="h116-0-29" class="i">+                return
</a><a href="#h116-0-30" id="h116-0-30" class="i">+            }
</a><a href="#h116-0-31" id="h116-0-31" class="i">+        }
</a><a href="#h116-0-32" id="h116-0-32" class="i">+    }
</a><a href="#h116-0-33" id="h116-0-33" class="i">+}</a><a href="#h116-0-34" id="h116-0-34" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h117" href="../file/mapper/src/main/kotlin/me/rhunk/snapmapper/impl/CallbackMapper.kt.html">mapper/src/main/kotlin/me/rhunk/snapmapper/impl/CallbackMapper.kt</a> b/<a href="../file/mapper/src/main/kotlin/me/rhunk/snapmapper/impl/CallbackMapper.kt.html">mapper/src/main/kotlin/me/rhunk/snapmapper/impl/CallbackMapper.kt</a></b>
<a href="#h117-0" id="h117-0" class="h">@@ -0,0 +1,27 @@
</a><a href="#h117-0-0" id="h117-0-0" class="i">+package me.rhunk.snapmapper.impl
</a><a href="#h117-0-1" id="h117-0-1" class="i">+
</a><a href="#h117-0-2" id="h117-0-2" class="i">+import me.rhunk.snapmapper.AbstractClassMapper
</a><a href="#h117-0-3" id="h117-0-3" class="i">+import me.rhunk.snapmapper.MapperContext
</a><a href="#h117-0-4" id="h117-0-4" class="i">+import me.rhunk.snapmapper.ext.getClassName
</a><a href="#h117-0-5" id="h117-0-5" class="i">+import me.rhunk.snapmapper.ext.getSuperClassName
</a><a href="#h117-0-6" id="h117-0-6" class="i">+import me.rhunk.snapmapper.ext.isFinal
</a><a href="#h117-0-7" id="h117-0-7" class="i">+
</a><a href="#h117-0-8" id="h117-0-8" class="i">+class CallbackMapper : AbstractClassMapper() {
</a><a href="#h117-0-9" id="h117-0-9" class="i">+    override fun run(context: MapperContext) {
</a><a href="#h117-0-10" id="h117-0-10" class="i">+        val callbackClasses = context.classes.filter { clazz -&gt;
</a><a href="#h117-0-11" id="h117-0-11" class="i">+            if (clazz.superclass == null) return@filter false
</a><a href="#h117-0-12" id="h117-0-12" class="i">+
</a><a href="#h117-0-13" id="h117-0-13" class="i">+            val superclassName = clazz.getSuperClassName()!!
</a><a href="#h117-0-14" id="h117-0-14" class="i">+            if (!superclassName.endsWith(&quot;Callback&quot;) || superclassName.endsWith(&quot;\$Callback&quot;)) return@filter false
</a><a href="#h117-0-15" id="h117-0-15" class="i">+
</a><a href="#h117-0-16" id="h117-0-16" class="i">+            val superClass = context.getClass(clazz.superclass) ?: return@filter false
</a><a href="#h117-0-17" id="h117-0-17" class="i">+            if (superClass.isFinal()) return@filter false
</a><a href="#h117-0-18" id="h117-0-18" class="i">+
</a><a href="#h117-0-19" id="h117-0-19" class="i">+            superClass.virtualMethods.any { it.name == &quot;onError&quot; }
</a><a href="#h117-0-20" id="h117-0-20" class="i">+        }.map {
</a><a href="#h117-0-21" id="h117-0-21" class="i">+             it.getSuperClassName()!!.substringAfterLast(&quot;/&quot;) to it.getClassName()
</a><a href="#h117-0-22" id="h117-0-22" class="i">+        }
</a><a href="#h117-0-23" id="h117-0-23" class="i">+
</a><a href="#h117-0-24" id="h117-0-24" class="i">+        context.addMapping(&quot;callbacks&quot;, *callbackClasses.toTypedArray())
</a><a href="#h117-0-25" id="h117-0-25" class="i">+    }
</a><a href="#h117-0-26" id="h117-0-26" class="i">+}</a><a href="#h117-0-27" id="h117-0-27" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h118" href="../file/mapper/src/main/kotlin/me/rhunk/snapmapper/impl/DefaultMediaItemMapper.kt.html">mapper/src/main/kotlin/me/rhunk/snapmapper/impl/DefaultMediaItemMapper.kt</a> b/<a href="../file/mapper/src/main/kotlin/me/rhunk/snapmapper/impl/DefaultMediaItemMapper.kt.html">mapper/src/main/kotlin/me/rhunk/snapmapper/impl/DefaultMediaItemMapper.kt</a></b>
<a href="#h118-0" id="h118-0" class="h">@@ -0,0 +1,21 @@
</a><a href="#h118-0-0" id="h118-0-0" class="i">+package me.rhunk.snapmapper.impl
</a><a href="#h118-0-1" id="h118-0-1" class="i">+
</a><a href="#h118-0-2" id="h118-0-2" class="i">+import me.rhunk.snapmapper.AbstractClassMapper
</a><a href="#h118-0-3" id="h118-0-3" class="i">+import me.rhunk.snapmapper.MapperContext
</a><a href="#h118-0-4" id="h118-0-4" class="i">+import me.rhunk.snapmapper.ext.isAbstract
</a><a href="#h118-0-5" id="h118-0-5" class="i">+
</a><a href="#h118-0-6" id="h118-0-6" class="i">+class DefaultMediaItemMapper : AbstractClassMapper() {
</a><a href="#h118-0-7" id="h118-0-7" class="i">+    override fun run(context: MapperContext) {
</a><a href="#h118-0-8" id="h118-0-8" class="i">+        for (clazz in context.classes) {
</a><a href="#h118-0-9" id="h118-0-9" class="i">+            val superClass = context.getClass(clazz.superclass) ?: continue
</a><a href="#h118-0-10" id="h118-0-10" class="i">+
</a><a href="#h118-0-11" id="h118-0-11" class="i">+            if (!superClass.isAbstract() || superClass.interfaces.isEmpty() || superClass.interfaces[0] != &quot;Ljava/lang/Comparable;&quot;) continue
</a><a href="#h118-0-12" id="h118-0-12" class="i">+            if (clazz.methods.none { it.returnType == &quot;Landroid/net/Uri;&quot; }) continue
</a><a href="#h118-0-13" id="h118-0-13" class="i">+
</a><a href="#h118-0-14" id="h118-0-14" class="i">+            val constructorParameters = clazz.directMethods.firstOrNull { it.name == &quot;&lt;init&gt;&quot; }?.parameterTypes ?: continue
</a><a href="#h118-0-15" id="h118-0-15" class="i">+            if (constructorParameters.size &lt; 6 || constructorParameters[5] != &quot;J&quot;) continue
</a><a href="#h118-0-16" id="h118-0-16" class="i">+
</a><a href="#h118-0-17" id="h118-0-17" class="i">+            context.addMapping(&quot;DefaultMediaItem&quot;, clazz.type.replace(&quot;L&quot;, &quot;&quot;).replace(&quot;;&quot;, &quot;&quot;))
</a><a href="#h118-0-18" id="h118-0-18" class="i">+        }
</a><a href="#h118-0-19" id="h118-0-19" class="i">+    }
</a><a href="#h118-0-20" id="h118-0-20" class="i">+}</a><a href="#h118-0-21" id="h118-0-21" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h119" href="../file/mapper/src/main/kotlin/me/rhunk/snapmapper/impl/EnumMapper.kt.html">mapper/src/main/kotlin/me/rhunk/snapmapper/impl/EnumMapper.kt</a> b/<a href="../file/mapper/src/main/kotlin/me/rhunk/snapmapper/impl/EnumMapper.kt.html">mapper/src/main/kotlin/me/rhunk/snapmapper/impl/EnumMapper.kt</a></b>
<a href="#h119-0" id="h119-0" class="h">@@ -0,0 +1,72 @@
</a><a href="#h119-0-0" id="h119-0-0" class="i">+package me.rhunk.snapmapper.impl
</a><a href="#h119-0-1" id="h119-0-1" class="i">+
</a><a href="#h119-0-2" id="h119-0-2" class="i">+import me.rhunk.snapmapper.AbstractClassMapper
</a><a href="#h119-0-3" id="h119-0-3" class="i">+import me.rhunk.snapmapper.MapperContext
</a><a href="#h119-0-4" id="h119-0-4" class="i">+import me.rhunk.snapmapper.ext.getClassName
</a><a href="#h119-0-5" id="h119-0-5" class="i">+import me.rhunk.snapmapper.ext.getStaticConstructor
</a><a href="#h119-0-6" id="h119-0-6" class="i">+import me.rhunk.snapmapper.ext.hasStaticConstructorString
</a><a href="#h119-0-7" id="h119-0-7" class="i">+import me.rhunk.snapmapper.ext.isEnum
</a><a href="#h119-0-8" id="h119-0-8" class="i">+import org.jf.dexlib2.Opcode
</a><a href="#h119-0-9" id="h119-0-9" class="i">+import org.jf.dexlib2.iface.Method
</a><a href="#h119-0-10" id="h119-0-10" class="i">+import org.jf.dexlib2.iface.instruction.formats.Instruction21c
</a><a href="#h119-0-11" id="h119-0-11" class="i">+import org.jf.dexlib2.iface.reference.FieldReference
</a><a href="#h119-0-12" id="h119-0-12" class="i">+import org.jf.dexlib2.iface.reference.StringReference
</a><a href="#h119-0-13" id="h119-0-13" class="i">+
</a><a href="#h119-0-14" id="h119-0-14" class="i">+class EnumMapper : AbstractClassMapper() {
</a><a href="#h119-0-15" id="h119-0-15" class="i">+    override fun run(context: MapperContext) {
</a><a href="#h119-0-16" id="h119-0-16" class="i">+        var enumQualityLevel : String? = null
</a><a href="#h119-0-17" id="h119-0-17" class="i">+        val enums = mutableListOf&lt;Pair&lt;String, String&gt;&gt;()
</a><a href="#h119-0-18" id="h119-0-18" class="i">+
</a><a href="#h119-0-19" id="h119-0-19" class="i">+        for (enumClass in context.classes) {
</a><a href="#h119-0-20" id="h119-0-20" class="i">+            if (!enumClass.isEnum()) continue
</a><a href="#h119-0-21" id="h119-0-21" class="i">+
</a><a href="#h119-0-22" id="h119-0-22" class="i">+            if (enumQualityLevel == null &amp;&amp; enumClass.hasStaticConstructorString(&quot;LEVEL_MAX&quot;)) {
</a><a href="#h119-0-23" id="h119-0-23" class="i">+                enumQualityLevel = enumClass.getClassName()
</a><a href="#h119-0-24" id="h119-0-24" class="i">+            }
</a><a href="#h119-0-25" id="h119-0-25" class="i">+
</a><a href="#h119-0-26" id="h119-0-26" class="i">+            if (enumClass.interfaces.isEmpty()) continue
</a><a href="#h119-0-27" id="h119-0-27" class="i">+
</a><a href="#h119-0-28" id="h119-0-28" class="i">+            //check if it&#39;s a config enum
</a><a href="#h119-0-29" id="h119-0-29" class="i">+            val serializableInterfaceClass = context.getClass(enumClass.interfaces.first()) ?: continue
</a><a href="#h119-0-30" id="h119-0-30" class="i">+            if (serializableInterfaceClass.methods.none {it.name == &quot;getName&quot; &amp;&amp; it.returnType == &quot;Ljava/lang/String;&quot; }) continue
</a><a href="#h119-0-31" id="h119-0-31" class="i">+
</a><a href="#h119-0-32" id="h119-0-32" class="i">+            //find the method which returns the enum name
</a><a href="#h119-0-33" id="h119-0-33" class="i">+            val getEnumMethod = enumClass.virtualMethods.firstOrNull { context.getClass(it.returnType)?.isEnum() == true } ?: continue
</a><a href="#h119-0-34" id="h119-0-34" class="i">+
</a><a href="#h119-0-35" id="h119-0-35" class="i">+            //search for constant field instruction sget-object
</a><a href="#h119-0-36" id="h119-0-36" class="i">+
</a><a href="#h119-0-37" id="h119-0-37" class="i">+            fun getFirstFieldReference21c(opcode: Opcode, method: Method) = method.implementation!!.instructions.firstOrNull {
</a><a href="#h119-0-38" id="h119-0-38" class="i">+                it.opcode == opcode &amp;&amp; it is Instruction21c
</a><a href="#h119-0-39" id="h119-0-39" class="i">+            }.let { it as? Instruction21c }?.let {
</a><a href="#h119-0-40" id="h119-0-40" class="i">+                it.reference as? FieldReference
</a><a href="#h119-0-41" id="h119-0-41" class="i">+            }
</a><a href="#h119-0-42" id="h119-0-42" class="i">+
</a><a href="#h119-0-43" id="h119-0-43" class="i">+            val fieldReference = getFirstFieldReference21c(Opcode.SGET_OBJECT, getEnumMethod) ?:
</a><a href="#h119-0-44" id="h119-0-44" class="i">+                getFirstFieldReference21c(Opcode.SGET_OBJECT,enumClass.directMethods.first { it.name == &quot;&lt;init&gt;&quot; }) ?: continue
</a><a href="#h119-0-45" id="h119-0-45" class="i">+
</a><a href="#h119-0-46" id="h119-0-46" class="i">+            //search field name in the &lt;clinit&gt; class
</a><a href="#h119-0-47" id="h119-0-47" class="i">+            val enumClassListEnum = context.getClass(fieldReference.definingClass) ?: continue
</a><a href="#h119-0-48" id="h119-0-48" class="i">+
</a><a href="#h119-0-49" id="h119-0-49" class="i">+            enumClassListEnum.getStaticConstructor()?.let { constructor -&gt;
</a><a href="#h119-0-50" id="h119-0-50" class="i">+                var lastEnumClassName = &quot;&quot;
</a><a href="#h119-0-51" id="h119-0-51" class="i">+                constructor.implementation!!.instructions.forEach {
</a><a href="#h119-0-52" id="h119-0-52" class="i">+                    if (it.opcode == Opcode.CONST_STRING) {
</a><a href="#h119-0-53" id="h119-0-53" class="i">+                        lastEnumClassName = ((it as Instruction21c).reference as StringReference).string
</a><a href="#h119-0-54" id="h119-0-54" class="i">+                        return@forEach
</a><a href="#h119-0-55" id="h119-0-55" class="i">+                    }
</a><a href="#h119-0-56" id="h119-0-56" class="i">+
</a><a href="#h119-0-57" id="h119-0-57" class="i">+                    if (it.opcode == Opcode.SPUT_OBJECT &amp;&amp; it is Instruction21c) {
</a><a href="#h119-0-58" id="h119-0-58" class="i">+                        val field = it.reference as? FieldReference ?: return@forEach
</a><a href="#h119-0-59" id="h119-0-59" class="i">+                        if (field.name != fieldReference.name || field.type != fieldReference.type) return@forEach
</a><a href="#h119-0-60" id="h119-0-60" class="i">+
</a><a href="#h119-0-61" id="h119-0-61" class="i">+                        enums.add(lastEnumClassName to enumClass.getClassName())
</a><a href="#h119-0-62" id="h119-0-62" class="i">+                    }
</a><a href="#h119-0-63" id="h119-0-63" class="i">+                }
</a><a href="#h119-0-64" id="h119-0-64" class="i">+            }
</a><a href="#h119-0-65" id="h119-0-65" class="i">+        }
</a><a href="#h119-0-66" id="h119-0-66" class="i">+
</a><a href="#h119-0-67" id="h119-0-67" class="i">+        context.addMapping(&quot;EnumQualityLevel&quot;, enumQualityLevel!!)
</a><a href="#h119-0-68" id="h119-0-68" class="i">+
</a><a href="#h119-0-69" id="h119-0-69" class="i">+        context.addMapping(&quot;enums&quot;, *enums.sortedBy { it.first }.toTypedArray())
</a><a href="#h119-0-70" id="h119-0-70" class="i">+    }
</a><a href="#h119-0-71" id="h119-0-71" class="i">+}</a><a href="#h119-0-72" id="h119-0-72" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h120" href="../file/mapper/src/main/kotlin/me/rhunk/snapmapper/impl/FriendsFeedEventDispatcherMapper.kt.html">mapper/src/main/kotlin/me/rhunk/snapmapper/impl/FriendsFeedEventDispatcherMapper.kt</a> b/<a href="../file/mapper/src/main/kotlin/me/rhunk/snapmapper/impl/FriendsFeedEventDispatcherMapper.kt.html">mapper/src/main/kotlin/me/rhunk/snapmapper/impl/FriendsFeedEventDispatcherMapper.kt</a></b>
<a href="#h120-0" id="h120-0" class="h">@@ -0,0 +1,27 @@
</a><a href="#h120-0-0" id="h120-0-0" class="i">+package me.rhunk.snapmapper.impl
</a><a href="#h120-0-1" id="h120-0-1" class="i">+
</a><a href="#h120-0-2" id="h120-0-2" class="i">+import me.rhunk.snapmapper.AbstractClassMapper
</a><a href="#h120-0-3" id="h120-0-3" class="i">+import me.rhunk.snapmapper.MapperContext
</a><a href="#h120-0-4" id="h120-0-4" class="i">+import me.rhunk.snapmapper.ext.findConstString
</a><a href="#h120-0-5" id="h120-0-5" class="i">+import me.rhunk.snapmapper.ext.getClassName
</a><a href="#h120-0-6" id="h120-0-6" class="i">+
</a><a href="#h120-0-7" id="h120-0-7" class="i">+
</a><a href="#h120-0-8" id="h120-0-8" class="i">+class FriendsFeedEventDispatcherMapper : AbstractClassMapper() {
</a><a href="#h120-0-9" id="h120-0-9" class="i">+    override fun run(context: MapperContext) {
</a><a href="#h120-0-10" id="h120-0-10" class="i">+        for (clazz in context.classes) {
</a><a href="#h120-0-11" id="h120-0-11" class="i">+            if (clazz.methods.count { it.name == &quot;onClickFeed&quot; || it.name == &quot;onItemLongPress&quot; } != 2) continue
</a><a href="#h120-0-12" id="h120-0-12" class="i">+            val onItemLongPress = clazz.methods.first { it.name == &quot;onItemLongPress&quot; }
</a><a href="#h120-0-13" id="h120-0-13" class="i">+            val viewHolderContainerClass = context.getClass(onItemLongPress.parameterTypes[0]) ?: continue
</a><a href="#h120-0-14" id="h120-0-14" class="i">+
</a><a href="#h120-0-15" id="h120-0-15" class="i">+            val viewModelField = viewHolderContainerClass.fields.firstOrNull { field -&gt;
</a><a href="#h120-0-16" id="h120-0-16" class="i">+                val typeClass = context.getClass(field.type) ?: return@firstOrNull false
</a><a href="#h120-0-17" id="h120-0-17" class="i">+                typeClass.methods.firstOrNull {it.name == &quot;toString&quot;}?.implementation?.findConstString(&quot;FriendFeedItemViewModel&quot;, contains = true) == true
</a><a href="#h120-0-18" id="h120-0-18" class="i">+            }?.name ?: continue
</a><a href="#h120-0-19" id="h120-0-19" class="i">+
</a><a href="#h120-0-20" id="h120-0-20" class="i">+            context.addMapping(&quot;FriendsFeedEventDispatcher&quot;,
</a><a href="#h120-0-21" id="h120-0-21" class="i">+                &quot;class&quot; to clazz.getClassName(),
</a><a href="#h120-0-22" id="h120-0-22" class="i">+                &quot;viewModelField&quot; to viewModelField
</a><a href="#h120-0-23" id="h120-0-23" class="i">+            )
</a><a href="#h120-0-24" id="h120-0-24" class="i">+        }
</a><a href="#h120-0-25" id="h120-0-25" class="i">+    }
</a><a href="#h120-0-26" id="h120-0-26" class="i">+}</a><a href="#h120-0-27" id="h120-0-27" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h121" href="../file/mapper/src/main/kotlin/me/rhunk/snapmapper/impl/MediaQualityLevelProviderMapper.kt.html">mapper/src/main/kotlin/me/rhunk/snapmapper/impl/MediaQualityLevelProviderMapper.kt</a> b/<a href="../file/mapper/src/main/kotlin/me/rhunk/snapmapper/impl/MediaQualityLevelProviderMapper.kt.html">mapper/src/main/kotlin/me/rhunk/snapmapper/impl/MediaQualityLevelProviderMapper.kt</a></b>
<a href="#h121-0" id="h121-0" class="h">@@ -0,0 +1,24 @@
</a><a href="#h121-0-0" id="h121-0-0" class="i">+package me.rhunk.snapmapper.impl
</a><a href="#h121-0-1" id="h121-0-1" class="i">+
</a><a href="#h121-0-2" id="h121-0-2" class="i">+import me.rhunk.snapmapper.AbstractClassMapper
</a><a href="#h121-0-3" id="h121-0-3" class="i">+import me.rhunk.snapmapper.MapperContext
</a><a href="#h121-0-4" id="h121-0-4" class="i">+import me.rhunk.snapmapper.ext.isAbstract
</a><a href="#h121-0-5" id="h121-0-5" class="i">+import org.jf.dexlib2.AccessFlags
</a><a href="#h121-0-6" id="h121-0-6" class="i">+
</a><a href="#h121-0-7" id="h121-0-7" class="i">+class MediaQualityLevelProviderMapper : AbstractClassMapper(EnumMapper::class) {
</a><a href="#h121-0-8" id="h121-0-8" class="i">+    override fun run(context: MapperContext) {
</a><a href="#h121-0-9" id="h121-0-9" class="i">+        val mediaQualityLevelClass = context.getStringMapping(&quot;EnumQualityLevel&quot;) ?: return
</a><a href="#h121-0-10" id="h121-0-10" class="i">+
</a><a href="#h121-0-11" id="h121-0-11" class="i">+        for (clazz in context.classes) {
</a><a href="#h121-0-12" id="h121-0-12" class="i">+            if (!clazz.isAbstract()) continue
</a><a href="#h121-0-13" id="h121-0-13" class="i">+            if (clazz.fields.none { it.accessFlags and AccessFlags.TRANSIENT.value != 0 }) continue
</a><a href="#h121-0-14" id="h121-0-14" class="i">+
</a><a href="#h121-0-15" id="h121-0-15" class="i">+            clazz.methods.firstOrNull { it.returnType == &quot;L$mediaQualityLevelClass;&quot; }?.let {
</a><a href="#h121-0-16" id="h121-0-16" class="i">+                context.addMapping(&quot;MediaQualityLevelProvider&quot;,
</a><a href="#h121-0-17" id="h121-0-17" class="i">+                    &quot;class&quot; to clazz.type.replace(&quot;L&quot;, &quot;&quot;).replace(&quot;;&quot;, &quot;&quot;),
</a><a href="#h121-0-18" id="h121-0-18" class="i">+                    &quot;method&quot; to it.name
</a><a href="#h121-0-19" id="h121-0-19" class="i">+                )
</a><a href="#h121-0-20" id="h121-0-20" class="i">+            }
</a><a href="#h121-0-21" id="h121-0-21" class="i">+        }
</a><a href="#h121-0-22" id="h121-0-22" class="i">+    }
</a><a href="#h121-0-23" id="h121-0-23" class="i">+}</a><a href="#h121-0-24" id="h121-0-24" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h122" href="../file/mapper/src/main/kotlin/me/rhunk/snapmapper/impl/OperaPageViewControllerMapper.kt.html">mapper/src/main/kotlin/me/rhunk/snapmapper/impl/OperaPageViewControllerMapper.kt</a> b/<a href="../file/mapper/src/main/kotlin/me/rhunk/snapmapper/impl/OperaPageViewControllerMapper.kt.html">mapper/src/main/kotlin/me/rhunk/snapmapper/impl/OperaPageViewControllerMapper.kt</a></b>
<a href="#h122-0" id="h122-0" class="h">@@ -0,0 +1,52 @@
</a><a href="#h122-0-0" id="h122-0-0" class="i">+package me.rhunk.snapmapper.impl
</a><a href="#h122-0-1" id="h122-0-1" class="i">+
</a><a href="#h122-0-2" id="h122-0-2" class="i">+import me.rhunk.snapmapper.AbstractClassMapper
</a><a href="#h122-0-3" id="h122-0-3" class="i">+import me.rhunk.snapmapper.MapperContext
</a><a href="#h122-0-4" id="h122-0-4" class="i">+import me.rhunk.snapmapper.ext.hasConstructorString
</a><a href="#h122-0-5" id="h122-0-5" class="i">+import me.rhunk.snapmapper.ext.hasStaticConstructorString
</a><a href="#h122-0-6" id="h122-0-6" class="i">+import me.rhunk.snapmapper.ext.isAbstract
</a><a href="#h122-0-7" id="h122-0-7" class="i">+import me.rhunk.snapmapper.ext.isEnum
</a><a href="#h122-0-8" id="h122-0-8" class="i">+
</a><a href="#h122-0-9" id="h122-0-9" class="i">+class OperaPageViewControllerMapper : AbstractClassMapper() {
</a><a href="#h122-0-10" id="h122-0-10" class="i">+    override fun run(context: MapperContext) {
</a><a href="#h122-0-11" id="h122-0-11" class="i">+        for (clazz in context.classes) {
</a><a href="#h122-0-12" id="h122-0-12" class="i">+            if (!clazz.isAbstract()) continue
</a><a href="#h122-0-13" id="h122-0-13" class="i">+            if (!clazz.hasConstructorString(&quot;OperaPageViewController&quot;) || !clazz.hasStaticConstructorString(&quot;ad_product_type&quot;)) {
</a><a href="#h122-0-14" id="h122-0-14" class="i">+                continue
</a><a href="#h122-0-15" id="h122-0-15" class="i">+            }
</a><a href="#h122-0-16" id="h122-0-16" class="i">+
</a><a href="#h122-0-17" id="h122-0-17" class="i">+            val viewStateField = clazz.fields.first { field -&gt;
</a><a href="#h122-0-18" id="h122-0-18" class="i">+                val fieldClass = context.getClass(field.type) ?: return@first false
</a><a href="#h122-0-19" id="h122-0-19" class="i">+                fieldClass.isEnum() &amp;&amp; fieldClass.hasStaticConstructorString(&quot;FULLY_DISPLAYED&quot;)
</a><a href="#h122-0-20" id="h122-0-20" class="i">+            }
</a><a href="#h122-0-21" id="h122-0-21" class="i">+
</a><a href="#h122-0-22" id="h122-0-22" class="i">+            val layerListField = clazz.fields.first { it.type == &quot;Ljava/util/ArrayList;&quot; }
</a><a href="#h122-0-23" id="h122-0-23" class="i">+
</a><a href="#h122-0-24" id="h122-0-24" class="i">+            val onDisplayStateChange = clazz.methods.first {
</a><a href="#h122-0-25" id="h122-0-25" class="i">+                if (it.returnType != &quot;V&quot; || it.parameterTypes.size != 1) return@first false
</a><a href="#h122-0-26" id="h122-0-26" class="i">+                val firstParameterType = context.getClass(it.parameterTypes[0]) ?: return@first false
</a><a href="#h122-0-27" id="h122-0-27" class="i">+                //check if the class contains a field with the enumViewStateClass type
</a><a href="#h122-0-28" id="h122-0-28" class="i">+                firstParameterType.fields.any { field -&gt;
</a><a href="#h122-0-29" id="h122-0-29" class="i">+                    field.type == viewStateField.type
</a><a href="#h122-0-30" id="h122-0-30" class="i">+                }
</a><a href="#h122-0-31" id="h122-0-31" class="i">+            }
</a><a href="#h122-0-32" id="h122-0-32" class="i">+
</a><a href="#h122-0-33" id="h122-0-33" class="i">+            val onDisplayStateChangeGesture = clazz.methods.first {
</a><a href="#h122-0-34" id="h122-0-34" class="i">+                if (it.returnType != &quot;V&quot; || it.parameterTypes.size != 2) return@first false
</a><a href="#h122-0-35" id="h122-0-35" class="i">+                val firstParameterType = context.getClass(it.parameterTypes[0]) ?: return@first false
</a><a href="#h122-0-36" id="h122-0-36" class="i">+                val secondParameterType = context.getClass(it.parameterTypes[1]) ?: return@first false
</a><a href="#h122-0-37" id="h122-0-37" class="i">+                firstParameterType.isEnum() &amp;&amp; secondParameterType.isEnum()
</a><a href="#h122-0-38" id="h122-0-38" class="i">+            }
</a><a href="#h122-0-39" id="h122-0-39" class="i">+
</a><a href="#h122-0-40" id="h122-0-40" class="i">+            context.addMapping(&quot;OperaPageViewController&quot;,
</a><a href="#h122-0-41" id="h122-0-41" class="i">+                &quot;class&quot; to clazz.type.replace(&quot;L&quot;, &quot;&quot;).replace(&quot;;&quot;, &quot;&quot;),
</a><a href="#h122-0-42" id="h122-0-42" class="i">+                &quot;viewStateField&quot; to viewStateField.name,
</a><a href="#h122-0-43" id="h122-0-43" class="i">+                &quot;layerListField&quot; to layerListField.name,
</a><a href="#h122-0-44" id="h122-0-44" class="i">+                &quot;onDisplayStateChange&quot; to onDisplayStateChange.name,
</a><a href="#h122-0-45" id="h122-0-45" class="i">+                &quot;onDisplayStateChangeGesture&quot; to onDisplayStateChangeGesture.name
</a><a href="#h122-0-46" id="h122-0-46" class="i">+            )
</a><a href="#h122-0-47" id="h122-0-47" class="i">+
</a><a href="#h122-0-48" id="h122-0-48" class="i">+            return
</a><a href="#h122-0-49" id="h122-0-49" class="i">+        }
</a><a href="#h122-0-50" id="h122-0-50" class="i">+    }
</a><a href="#h122-0-51" id="h122-0-51" class="i">+}</a><a href="#h122-0-52" id="h122-0-52" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h123" href="../file/mapper/src/main/kotlin/me/rhunk/snapmapper/impl/PlatformAnalyticsCreatorMapper.kt.html">mapper/src/main/kotlin/me/rhunk/snapmapper/impl/PlatformAnalyticsCreatorMapper.kt</a> b/<a href="../file/mapper/src/main/kotlin/me/rhunk/snapmapper/impl/PlatformAnalyticsCreatorMapper.kt.html">mapper/src/main/kotlin/me/rhunk/snapmapper/impl/PlatformAnalyticsCreatorMapper.kt</a></b>
<a href="#h123-0" id="h123-0" class="h">@@ -0,0 +1,23 @@
</a><a href="#h123-0-0" id="h123-0-0" class="i">+package me.rhunk.snapmapper.impl
</a><a href="#h123-0-1" id="h123-0-1" class="i">+
</a><a href="#h123-0-2" id="h123-0-2" class="i">+import me.rhunk.snapmapper.AbstractClassMapper
</a><a href="#h123-0-3" id="h123-0-3" class="i">+import me.rhunk.snapmapper.MapperContext
</a><a href="#h123-0-4" id="h123-0-4" class="i">+import me.rhunk.snapmapper.ext.findConstString
</a><a href="#h123-0-5" id="h123-0-5" class="i">+import me.rhunk.snapmapper.ext.getStaticConstructor
</a><a href="#h123-0-6" id="h123-0-6" class="i">+import me.rhunk.snapmapper.ext.isEnum
</a><a href="#h123-0-7" id="h123-0-7" class="i">+
</a><a href="#h123-0-8" id="h123-0-8" class="i">+class PlatformAnalyticsCreatorMapper : AbstractClassMapper() {
</a><a href="#h123-0-9" id="h123-0-9" class="i">+    override fun run(context: MapperContext) {
</a><a href="#h123-0-10" id="h123-0-10" class="i">+        for (clazz in context.classes) {
</a><a href="#h123-0-11" id="h123-0-11" class="i">+            val firstConstructor = clazz.directMethods.firstOrNull { it.name == &quot;&lt;init&gt;&quot; } ?: continue
</a><a href="#h123-0-12" id="h123-0-12" class="i">+            // 47 is the number of parameters of the constructor
</a><a href="#h123-0-13" id="h123-0-13" class="i">+            // it may change in future versions
</a><a href="#h123-0-14" id="h123-0-14" class="i">+            if (firstConstructor.parameters.size != 47) continue
</a><a href="#h123-0-15" id="h123-0-15" class="i">+            val firstParameterClass = context.getClass(firstConstructor.parameterTypes[0]) ?: continue
</a><a href="#h123-0-16" id="h123-0-16" class="i">+            if (!firstParameterClass.isEnum()) continue
</a><a href="#h123-0-17" id="h123-0-17" class="i">+            if (firstParameterClass.getStaticConstructor()?.implementation?.findConstString(&quot;IN_APP_NOTIFICATION&quot;) != true) continue
</a><a href="#h123-0-18" id="h123-0-18" class="i">+
</a><a href="#h123-0-19" id="h123-0-19" class="i">+            context.addMapping(&quot;PlatformAnalyticsCreator&quot;, clazz.type.replace(&quot;L&quot;, &quot;&quot;).replace(&quot;;&quot;, &quot;&quot;))
</a><a href="#h123-0-20" id="h123-0-20" class="i">+        }
</a><a href="#h123-0-21" id="h123-0-21" class="i">+    }
</a><a href="#h123-0-22" id="h123-0-22" class="i">+}</a><a href="#h123-0-23" id="h123-0-23" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h124" href="../file/mapper/src/main/kotlin/me/rhunk/snapmapper/impl/PlusSubscriptionMapper.kt.html">mapper/src/main/kotlin/me/rhunk/snapmapper/impl/PlusSubscriptionMapper.kt</a> b/<a href="../file/mapper/src/main/kotlin/me/rhunk/snapmapper/impl/PlusSubscriptionMapper.kt.html">mapper/src/main/kotlin/me/rhunk/snapmapper/impl/PlusSubscriptionMapper.kt</a></b>
<a href="#h124-0" id="h124-0" class="h">@@ -0,0 +1,28 @@
</a><a href="#h124-0-0" id="h124-0-0" class="i">+package me.rhunk.snapmapper.impl
</a><a href="#h124-0-1" id="h124-0-1" class="i">+
</a><a href="#h124-0-2" id="h124-0-2" class="i">+import me.rhunk.snapmapper.AbstractClassMapper
</a><a href="#h124-0-3" id="h124-0-3" class="i">+import me.rhunk.snapmapper.MapperContext
</a><a href="#h124-0-4" id="h124-0-4" class="i">+import me.rhunk.snapmapper.ext.findConstString
</a><a href="#h124-0-5" id="h124-0-5" class="i">+
</a><a href="#h124-0-6" id="h124-0-6" class="i">+class PlusSubscriptionMapper : AbstractClassMapper(){
</a><a href="#h124-0-7" id="h124-0-7" class="i">+    override fun run(context: MapperContext) {
</a><a href="#h124-0-8" id="h124-0-8" class="i">+        for (clazz in context.classes) {
</a><a href="#h124-0-9" id="h124-0-9" class="i">+            if (clazz.directMethods.filter { it.name == &quot;&lt;init&gt;&quot; }.none {
</a><a href="#h124-0-10" id="h124-0-10" class="i">+                it.parameters.size == 4 &amp;&amp;
</a><a href="#h124-0-11" id="h124-0-11" class="i">+                it.parameterTypes[0] == &quot;I&quot; &amp;&amp;
</a><a href="#h124-0-12" id="h124-0-12" class="i">+                it.parameterTypes[1] == &quot;I&quot; &amp;&amp;
</a><a href="#h124-0-13" id="h124-0-13" class="i">+                it.parameterTypes[2] == &quot;J&quot; &amp;&amp;
</a><a href="#h124-0-14" id="h124-0-14" class="i">+                it.parameterTypes[3] == &quot;J&quot;
</a><a href="#h124-0-15" id="h124-0-15" class="i">+            }) continue
</a><a href="#h124-0-16" id="h124-0-16" class="i">+
</a><a href="#h124-0-17" id="h124-0-17" class="i">+            val isPlusSubscriptionInfoClass = clazz.virtualMethods.firstOrNull { it.name == &quot;toString&quot; }?.implementation?.let {
</a><a href="#h124-0-18" id="h124-0-18" class="i">+                it.findConstString(&quot;SubscriptionInfo&quot;, contains = true) &amp;&amp; it.findConstString(&quot;expirationTimeMillis&quot;, contains = true)
</a><a href="#h124-0-19" id="h124-0-19" class="i">+            }
</a><a href="#h124-0-20" id="h124-0-20" class="i">+
</a><a href="#h124-0-21" id="h124-0-21" class="i">+            if (isPlusSubscriptionInfoClass == true) {
</a><a href="#h124-0-22" id="h124-0-22" class="i">+                context.addMapping(&quot;SubscriptionInfoClass&quot;, clazz.type.replace(&quot;L&quot;, &quot;&quot;).replace(&quot;;&quot;, &quot;&quot;))
</a><a href="#h124-0-23" id="h124-0-23" class="i">+                return
</a><a href="#h124-0-24" id="h124-0-24" class="i">+            }
</a><a href="#h124-0-25" id="h124-0-25" class="i">+        }
</a><a href="#h124-0-26" id="h124-0-26" class="i">+    }
</a><a href="#h124-0-27" id="h124-0-27" class="i">+}</a><a href="#h124-0-28" id="h124-0-28" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h125" href="../file/mapper/src/main/kotlin/me/rhunk/snapmapper/impl/ScCameraSettingsMapper.kt.html">mapper/src/main/kotlin/me/rhunk/snapmapper/impl/ScCameraSettingsMapper.kt</a> b/<a href="../file/mapper/src/main/kotlin/me/rhunk/snapmapper/impl/ScCameraSettingsMapper.kt.html">mapper/src/main/kotlin/me/rhunk/snapmapper/impl/ScCameraSettingsMapper.kt</a></b>
<a href="#h125-0" id="h125-0" class="h">@@ -0,0 +1,20 @@
</a><a href="#h125-0-0" id="h125-0-0" class="i">+package me.rhunk.snapmapper.impl
</a><a href="#h125-0-1" id="h125-0-1" class="i">+
</a><a href="#h125-0-2" id="h125-0-2" class="i">+import me.rhunk.snapmapper.AbstractClassMapper
</a><a href="#h125-0-3" id="h125-0-3" class="i">+import me.rhunk.snapmapper.MapperContext
</a><a href="#h125-0-4" id="h125-0-4" class="i">+import me.rhunk.snapmapper.ext.findConstString
</a><a href="#h125-0-5" id="h125-0-5" class="i">+import me.rhunk.snapmapper.ext.getStaticConstructor
</a><a href="#h125-0-6" id="h125-0-6" class="i">+import me.rhunk.snapmapper.ext.isEnum
</a><a href="#h125-0-7" id="h125-0-7" class="i">+
</a><a href="#h125-0-8" id="h125-0-8" class="i">+class ScCameraSettingsMapper : AbstractClassMapper() {
</a><a href="#h125-0-9" id="h125-0-9" class="i">+    override fun run(context: MapperContext) {
</a><a href="#h125-0-10" id="h125-0-10" class="i">+        for (clazz in context.classes) {
</a><a href="#h125-0-11" id="h125-0-11" class="i">+            val firstConstructor = clazz.directMethods.firstOrNull { it.name == &quot;&lt;init&gt;&quot; } ?: continue
</a><a href="#h125-0-12" id="h125-0-12" class="i">+            if (firstConstructor.parameterTypes.size &lt; 27) continue
</a><a href="#h125-0-13" id="h125-0-13" class="i">+            val firstParameter = context.getClass(firstConstructor.parameterTypes[0]) ?: continue
</a><a href="#h125-0-14" id="h125-0-14" class="i">+            if (!firstParameter.isEnum() || firstParameter.getStaticConstructor()?.implementation?.findConstString(&quot;CONTINUOUS_PICTURE&quot;) != true) continue
</a><a href="#h125-0-15" id="h125-0-15" class="i">+
</a><a href="#h125-0-16" id="h125-0-16" class="i">+            context.addMapping(&quot;ScCameraSettings&quot;, clazz.type.replace(&quot;L&quot;, &quot;&quot;).replace(&quot;;&quot;, &quot;&quot;))
</a><a href="#h125-0-17" id="h125-0-17" class="i">+        }
</a><a href="#h125-0-18" id="h125-0-18" class="i">+    }
</a><a href="#h125-0-19" id="h125-0-19" class="i">+}</a><a href="#h125-0-20" id="h125-0-20" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h126" href="../file/mapper/src/main/kotlin/me/rhunk/snapmapper/impl/StoryBoostStateMapper.kt.html">mapper/src/main/kotlin/me/rhunk/snapmapper/impl/StoryBoostStateMapper.kt</a> b/<a href="../file/mapper/src/main/kotlin/me/rhunk/snapmapper/impl/StoryBoostStateMapper.kt.html">mapper/src/main/kotlin/me/rhunk/snapmapper/impl/StoryBoostStateMapper.kt</a></b>
<a href="#h126-0" id="h126-0" class="h">@@ -0,0 +1,23 @@
</a><a href="#h126-0-0" id="h126-0-0" class="i">+package me.rhunk.snapmapper.impl
</a><a href="#h126-0-1" id="h126-0-1" class="i">+
</a><a href="#h126-0-2" id="h126-0-2" class="i">+import me.rhunk.snapmapper.AbstractClassMapper
</a><a href="#h126-0-3" id="h126-0-3" class="i">+import me.rhunk.snapmapper.MapperContext
</a><a href="#h126-0-4" id="h126-0-4" class="i">+import me.rhunk.snapmapper.ext.findConstString
</a><a href="#h126-0-5" id="h126-0-5" class="i">+import me.rhunk.snapmapper.ext.getStaticConstructor
</a><a href="#h126-0-6" id="h126-0-6" class="i">+import me.rhunk.snapmapper.ext.isEnum
</a><a href="#h126-0-7" id="h126-0-7" class="i">+
</a><a href="#h126-0-8" id="h126-0-8" class="i">+class StoryBoostStateMapper : AbstractClassMapper() {
</a><a href="#h126-0-9" id="h126-0-9" class="i">+    override fun run(context: MapperContext) {
</a><a href="#h126-0-10" id="h126-0-10" class="i">+        for (clazz in context.classes) {
</a><a href="#h126-0-11" id="h126-0-11" class="i">+            val firstConstructor = clazz.directMethods.firstOrNull { it.name == &quot;&lt;init&gt;&quot; } ?: continue
</a><a href="#h126-0-12" id="h126-0-12" class="i">+            if (firstConstructor.parameters.size != 3) continue
</a><a href="#h126-0-13" id="h126-0-13" class="i">+            if (firstConstructor.parameterTypes[1] != &quot;J&quot; || firstConstructor.parameterTypes[2] != &quot;J&quot;) continue
</a><a href="#h126-0-14" id="h126-0-14" class="i">+
</a><a href="#h126-0-15" id="h126-0-15" class="i">+            val storyBoostEnumClass = context.getClass(firstConstructor.parameterTypes[0]) ?: continue
</a><a href="#h126-0-16" id="h126-0-16" class="i">+            if (!storyBoostEnumClass.isEnum()) continue
</a><a href="#h126-0-17" id="h126-0-17" class="i">+            if (storyBoostEnumClass.getStaticConstructor()?.implementation?.findConstString(&quot;NeedSubscriptionCannotSubscribe&quot;) != true) continue
</a><a href="#h126-0-18" id="h126-0-18" class="i">+
</a><a href="#h126-0-19" id="h126-0-19" class="i">+            context.addMapping(&quot;StoryBoostStateClass&quot;, clazz.type.replace(&quot;L&quot;, &quot;&quot;).replace(&quot;;&quot;, &quot;&quot;))
</a><a href="#h126-0-20" id="h126-0-20" class="i">+        }
</a><a href="#h126-0-21" id="h126-0-21" class="i">+    }
</a><a href="#h126-0-22" id="h126-0-22" class="i">+}</a><a href="#h126-0-23" id="h126-0-23" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h127" href="../file/mapper/src/test/kotlin/android/util/Log.kt.html">mapper/src/test/kotlin/android/util/Log.kt</a> b/<a href="../file/mapper/src/test/kotlin/android/util/Log.kt.html">mapper/src/test/kotlin/android/util/Log.kt</a></b>
<a href="#h127-0" id="h127-0" class="h">@@ -0,0 +1,27 @@
</a><a href="#h127-0-0" id="h127-0-0" class="i">+package android.util
</a><a href="#h127-0-1" id="h127-0-1" class="i">+
</a><a href="#h127-0-2" id="h127-0-2" class="i">+object Log {
</a><a href="#h127-0-3" id="h127-0-3" class="i">+    @JvmStatic
</a><a href="#h127-0-4" id="h127-0-4" class="i">+    fun d(tag: String, msg: String): Int {
</a><a href="#h127-0-5" id="h127-0-5" class="i">+        println(&quot;[$tag] $msg&quot;)
</a><a href="#h127-0-6" id="h127-0-6" class="i">+        return 0
</a><a href="#h127-0-7" id="h127-0-7" class="i">+    }
</a><a href="#h127-0-8" id="h127-0-8" class="i">+
</a><a href="#h127-0-9" id="h127-0-9" class="i">+    @JvmStatic
</a><a href="#h127-0-10" id="h127-0-10" class="i">+    fun e(tag: String, msg: String): Int {
</a><a href="#h127-0-11" id="h127-0-11" class="i">+        println(&quot;[$tag] $msg&quot;)
</a><a href="#h127-0-12" id="h127-0-12" class="i">+        return 0
</a><a href="#h127-0-13" id="h127-0-13" class="i">+    }
</a><a href="#h127-0-14" id="h127-0-14" class="i">+
</a><a href="#h127-0-15" id="h127-0-15" class="i">+    @JvmStatic
</a><a href="#h127-0-16" id="h127-0-16" class="i">+    fun i(tag: String, msg: String): Int {
</a><a href="#h127-0-17" id="h127-0-17" class="i">+        println(&quot;[$tag] $msg&quot;)
</a><a href="#h127-0-18" id="h127-0-18" class="i">+        return 0
</a><a href="#h127-0-19" id="h127-0-19" class="i">+    }
</a><a href="#h127-0-20" id="h127-0-20" class="i">+
</a><a href="#h127-0-21" id="h127-0-21" class="i">+    @JvmStatic
</a><a href="#h127-0-22" id="h127-0-22" class="i">+    fun v(tag: String, msg: String): Int {
</a><a href="#h127-0-23" id="h127-0-23" class="i">+        println(&quot;[$tag] $msg&quot;)
</a><a href="#h127-0-24" id="h127-0-24" class="i">+        return 0
</a><a href="#h127-0-25" id="h127-0-25" class="i">+    }
</a><a href="#h127-0-26" id="h127-0-26" class="i">+}</a><a href="#h127-0-27" id="h127-0-27" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h128" href="../file/mapper/src/test/kotlin/me/rhunk/snapenhance/mapper/tests/TestMappings.kt.html">mapper/src/test/kotlin/me/rhunk/snapenhance/mapper/tests/TestMappings.kt</a> b/<a href="../file/mapper/src/test/kotlin/me/rhunk/snapenhance/mapper/tests/TestMappings.kt.html">mapper/src/test/kotlin/me/rhunk/snapenhance/mapper/tests/TestMappings.kt</a></b>
<a href="#h128-0" id="h128-0" class="h">@@ -0,0 +1,33 @@
</a><a href="#h128-0-0" id="h128-0-0" class="i">+package me.rhunk.snapenhance.mapper.tests
</a><a href="#h128-0-1" id="h128-0-1" class="i">+
</a><a href="#h128-0-2" id="h128-0-2" class="i">+import com.google.gson.GsonBuilder
</a><a href="#h128-0-3" id="h128-0-3" class="i">+import me.rhunk.snapmapper.Mapper
</a><a href="#h128-0-4" id="h128-0-4" class="i">+import me.rhunk.snapmapper.impl.*
</a><a href="#h128-0-5" id="h128-0-5" class="i">+import org.junit.Test
</a><a href="#h128-0-6" id="h128-0-6" class="i">+import java.io.File
</a><a href="#h128-0-7" id="h128-0-7" class="i">+
</a><a href="#h128-0-8" id="h128-0-8" class="i">+
</a><a href="#h128-0-9" id="h128-0-9" class="i">+class TestMappings {
</a><a href="#h128-0-10" id="h128-0-10" class="i">+    @Test
</a><a href="#h128-0-11" id="h128-0-11" class="i">+    fun testMappings() {
</a><a href="#h128-0-12" id="h128-0-12" class="i">+        val mapper = Mapper(
</a><a href="#h128-0-13" id="h128-0-13" class="i">+            BCryptClassMapper::class,
</a><a href="#h128-0-14" id="h128-0-14" class="i">+            CallbackMapper::class,
</a><a href="#h128-0-15" id="h128-0-15" class="i">+            DefaultMediaItemMapper::class,
</a><a href="#h128-0-16" id="h128-0-16" class="i">+            MediaQualityLevelProviderMapper::class,
</a><a href="#h128-0-17" id="h128-0-17" class="i">+            EnumMapper::class,
</a><a href="#h128-0-18" id="h128-0-18" class="i">+            OperaPageViewControllerMapper::class,
</a><a href="#h128-0-19" id="h128-0-19" class="i">+            PlatformAnalyticsCreatorMapper::class,
</a><a href="#h128-0-20" id="h128-0-20" class="i">+            PlusSubscriptionMapper::class,
</a><a href="#h128-0-21" id="h128-0-21" class="i">+            ScCameraSettingsMapper::class,
</a><a href="#h128-0-22" id="h128-0-22" class="i">+            StoryBoostStateMapper::class,
</a><a href="#h128-0-23" id="h128-0-23" class="i">+            FriendsFeedEventDispatcherMapper::class
</a><a href="#h128-0-24" id="h128-0-24" class="i">+        )
</a><a href="#h128-0-25" id="h128-0-25" class="i">+
</a><a href="#h128-0-26" id="h128-0-26" class="i">+        val gson = GsonBuilder().setPrettyPrinting().create()
</a><a href="#h128-0-27" id="h128-0-27" class="i">+        val apkFile = File(System.getenv(&quot;SNAPCHAT_APK&quot;)!!)
</a><a href="#h128-0-28" id="h128-0-28" class="i">+        mapper.loadApk(apkFile.absolutePath)
</a><a href="#h128-0-29" id="h128-0-29" class="i">+        val result = mapper.start()
</a><a href="#h128-0-30" id="h128-0-30" class="i">+        println(&quot;Mappings: ${gson.toJson(result)}&quot;)
</a><a href="#h128-0-31" id="h128-0-31" class="i">+    }
</a><a href="#h128-0-32" id="h128-0-32" class="i">+}
</a><b>diff --git a/<a id="h129" href="../file/settings.gradle.html">settings.gradle</a> b/<a href="../file/settings.gradle.html">settings.gradle</a></b>
<a href="#h129-0" id="h129-0" class="h">@@ -1,16 +0,0 @@
</a><a href="#h129-0-0" id="h129-0-0" class="d">-pluginManagement {
</a><a href="#h129-0-1" id="h129-0-1" class="d">-    repositories {
</a><a href="#h129-0-2" id="h129-0-2" class="d">-        gradlePluginPortal()
</a><a href="#h129-0-3" id="h129-0-3" class="d">-        google()
</a><a href="#h129-0-4" id="h129-0-4" class="d">-        mavenCentral()
</a><a href="#h129-0-5" id="h129-0-5" class="d">-    }
</a><a href="#h129-0-6" id="h129-0-6" class="d">-}
</a><a href="#h129-0-7" id="h129-0-7" class="d">-dependencyResolutionManagement {
</a><a href="#h129-0-8" id="h129-0-8" class="d">-    repositoriesMode.set(RepositoriesMode.FAIL_ON_PROJECT_REPOS)
</a><a href="#h129-0-9" id="h129-0-9" class="d">-    repositories {
</a><a href="#h129-0-10" id="h129-0-10" class="d">-        google()
</a><a href="#h129-0-11" id="h129-0-11" class="d">-        mavenCentral()
</a><a href="#h129-0-12" id="h129-0-12" class="d">-    }
</a><a href="#h129-0-13" id="h129-0-13" class="d">-}
</a><a href="#h129-0-14" id="h129-0-14" class="d">-rootProject.name = &quot;SnapEnhance&quot;
</a><a href="#h129-0-15" id="h129-0-15" class="d">-include &#39;:app&#39;
</a><b>diff --git a/<a id="h130" href="../file/settings.gradle.kts.html">settings.gradle.kts</a> b/<a href="../file/settings.gradle.kts.html">settings.gradle.kts</a></b>
<a href="#h130-0" id="h130-0" class="h">@@ -0,0 +1,20 @@
</a><a href="#h130-0-0" id="h130-0-0" class="i">+pluginManagement {
</a><a href="#h130-0-1" id="h130-0-1" class="i">+    repositories {
</a><a href="#h130-0-2" id="h130-0-2" class="i">+        google()
</a><a href="#h130-0-3" id="h130-0-3" class="i">+        mavenCentral()
</a><a href="#h130-0-4" id="h130-0-4" class="i">+        gradlePluginPortal()
</a><a href="#h130-0-5" id="h130-0-5" class="i">+    }
</a><a href="#h130-0-6" id="h130-0-6" class="i">+}
</a><a href="#h130-0-7" id="h130-0-7" class="i">+
</a><a href="#h130-0-8" id="h130-0-8" class="i">+@Suppress(&quot;UnstableApiUsage&quot;)
</a><a href="#h130-0-9" id="h130-0-9" class="i">+dependencyResolutionManagement {
</a><a href="#h130-0-10" id="h130-0-10" class="i">+    repositoriesMode.set(RepositoriesMode.FAIL_ON_PROJECT_REPOS)
</a><a href="#h130-0-11" id="h130-0-11" class="i">+    repositories {
</a><a href="#h130-0-12" id="h130-0-12" class="i">+        google()
</a><a href="#h130-0-13" id="h130-0-13" class="i">+        mavenCentral()
</a><a href="#h130-0-14" id="h130-0-14" class="i">+    }
</a><a href="#h130-0-15" id="h130-0-15" class="i">+}
</a><a href="#h130-0-16" id="h130-0-16" class="i">+
</a><a href="#h130-0-17" id="h130-0-17" class="i">+rootProject.name = &quot;SnapEnhance&quot;
</a><a href="#h130-0-18" id="h130-0-18" class="i">+include(&quot;:app&quot;)
</a><a href="#h130-0-19" id="h130-0-19" class="i">+include(&quot;:mapper&quot;)</a><a href="#h130-0-20" id="h130-0-20" class="i">+
\ No newline at end of file
</a></pre>
</div>
</body>
</html>
