<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>feat: export memories - SnapEnhance - An Xposed module offering an enhanced Snapchat experience
</title>
<link rel="icon" type="image/svg+xml" href="../../logo.png"/>
<link rel="alternate icon" href="../../favicon.png"/>
<link rel="alternate" type="application/atom+xml" title="SnapEnhance Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="SnapEnhance Atom Feed (tags)" href="../tags.xml" />
<link rel="stylesheet" type="text/css" href="../../style.css" />
<link rel="stylesheet" type="text/css" href="../../fonts.css" />
</head>
<body>
<div id="head"><table><tr><td><a class="logo" href="../../"><img src="../../logo.png" alt="" width="32" height="32" /></a></td><td><strong>SnapEnhance</strong><span class="desc"> - An Xposed module offering an enhanced Snapchat experience
</span>
</td></tr></table>
<p><a href="../about.html">About</a> | <a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/.gitmodules.html">Submodules</a> | <a href="../file/LICENSE.html">License</a></p>
</div>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/dd755af5be3be51fab88f09042cfca5d0f76a830.html">dd755af5be3be51fab88f09042cfca5d0f76a830</a>
<b>parent</b> <a href="../commit/04b70431c7b384bae81a79ebbdc9675046a9a643.html">04b70431c7b384bae81a79ebbdc9675046a9a643</a>
<b>Author:</b> rhunk &lt;<a href="mailto:101876869+rhunk@users.noreply.github.com">101876869+rhunk@users.noreply.github.com</a>&gt;
<b>Date:</b>   Sun, 31 Dec 2023 00:33:38 +0100

feat: export memories

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">app/proguard-rules.pro</a></td><td> | </td><td class="num">1</td><td><span class="i">+</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">common/src/main/assets/lang/en_US.json</a></td><td> | </td><td class="num">17</td><td><span class="i">+++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h2">common/src/main/kotlin/me/rhunk/snapenhance/common/action/EnumAction.kt</a></td><td> | </td><td class="num">1</td><td><span class="i">+</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h3">core/src/main/kotlin/me/rhunk/snapenhance/core/SnapEnhance.kt</a></td><td> | </td><td class="num">32</td><td><span class="i">+++++++++++++++++++++++++++++</span><span class="d">---</span></td></tr>
<tr><td class="A">A</td><td><a href="#h4">core/src/main/kotlin/me/rhunk/snapenhance/core/action/impl/ExportMemories.kt</a></td><td> | </td><td class="num">385</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h5">core/src/main/kotlin/me/rhunk/snapenhance/core/manager/impl/ActionManager.kt</a></td><td> | </td><td class="num">4</td><td><span class="i">+++</span><span class="d">-</span></td></tr>
</table></pre><pre>6 files changed, 436 insertions(+), 4 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/app/proguard-rules.pro.html">app/proguard-rules.pro</a> b/<a href="../file/app/proguard-rules.pro.html">app/proguard-rules.pro</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -6,5 +6,6 @@
</a> -keep class org.jf.dexlib2.** { *; }
 -keep class org.mozilla.javascript.** { *; }
 -keep class androidx.compose.material.icons.** { *; }
<a href="#h0-0-3" id="h0-0-3" class="i">+-keep class androidx.compose.material3.R$* { *; }
</a> -keep class androidx.navigation.** { *; }
 -keep class me.rhunk.snapenhance.** { *; }
<b>diff --git a/<a id="h1" href="../file/common/src/main/assets/lang/en_US.json.html">common/src/main/assets/lang/en_US.json</a> b/<a href="../file/common/src/main/assets/lang/en_US.json.html">common/src/main/assets/lang/en_US.json</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -128,6 +128,7 @@
</a>         &quot;open_map&quot;: &quot;Choose location on map&quot;,
         &quot;check_for_updates&quot;: &quot;Check for updates&quot;,
         &quot;export_chat_messages&quot;: &quot;Export Chat Messages&quot;,
<a href="#h1-0-3" id="h1-0-3" class="i">+        &quot;export_memories&quot;: &quot;Export Memories&quot;,
</a>         &quot;bulk_messaging_action&quot;: &quot;Bulk Messaging Action&quot;
     },
 
<a href="#h1-1" id="h1-1" class="h">@@ -1075,5 +1076,21 @@
</a> 
     &quot;suspend_location_updates&quot;: {
         &quot;switch_text&quot;: &quot;Suspend Location Updates&quot;
<a href="#h1-1-3" id="h1-1-3" class="i">+    },
</a><a href="#h1-1-4" id="h1-1-4" class="i">+    &quot;material3_strings&quot;: {
</a><a href="#h1-1-5" id="h1-1-5" class="i">+        &quot;date_range_input_title&quot;: &quot;&quot;,
</a><a href="#h1-1-6" id="h1-1-6" class="i">+        &quot;date_range_picker_start_headline&quot;: &quot;From&quot;,
</a><a href="#h1-1-7" id="h1-1-7" class="i">+        &quot;date_range_picker_end_headline&quot;: &quot;To&quot;,
</a><a href="#h1-1-8" id="h1-1-8" class="i">+        &quot;date_range_picker_title&quot;: &quot;Select date range&quot;,
</a><a href="#h1-1-9" id="h1-1-9" class="i">+        &quot;date_picker_switch_to_calendar_mode&quot;: &quot;Calendar&quot;,
</a><a href="#h1-1-10" id="h1-1-10" class="i">+        &quot;date_picker_switch_to_input_mode&quot;: &quot;Input&quot;,
</a><a href="#h1-1-11" id="h1-1-11" class="i">+        &quot;date_range_picker_scroll_to_previous_month&quot;: &quot;Previous month&quot;,
</a><a href="#h1-1-12" id="h1-1-12" class="i">+        &quot;date_range_picker_scroll_to_next_month&quot;: &quot;Next month&quot;,
</a><a href="#h1-1-13" id="h1-1-13" class="i">+        &quot;date_picker_today_description&quot;: &quot;Today&quot;,
</a><a href="#h1-1-14" id="h1-1-14" class="i">+        &quot;date_range_picker_day_in_range&quot;: &quot;Selected&quot;,
</a><a href="#h1-1-15" id="h1-1-15" class="i">+        &quot;date_input_invalid_for_pattern&quot;: &quot;Invalid date&quot;,
</a><a href="#h1-1-16" id="h1-1-16" class="i">+        &quot;date_input_invalid_year_range&quot;: &quot;Invalid year&quot;,
</a><a href="#h1-1-17" id="h1-1-17" class="i">+        &quot;date_input_invalid_not_allowed&quot;: &quot;Invalid date&quot;,
</a><a href="#h1-1-18" id="h1-1-18" class="i">+        &quot;date_range_input_invalid_range_input&quot;: &quot;Invalid date range&quot;
</a>     }
 } 
\ No newline at end of file
<b>diff --git a/<a id="h2" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/action/EnumAction.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/action/EnumAction.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/action/EnumAction.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/action/EnumAction.kt</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -9,6 +9,7 @@ enum class EnumAction(
</a> ) {
     CLEAN_CACHE(&quot;clean_snapchat_cache&quot;, exitOnFinish = true),
     EXPORT_CHAT_MESSAGES(&quot;export_chat_messages&quot;),
<a href="#h2-0-3" id="h2-0-3" class="i">+    EXPORT_MEMORIES(&quot;export_memories&quot;),
</a>     BULK_MESSAGING_ACTION(&quot;bulk_messaging_action&quot;);
 
     companion object {
<b>diff --git a/<a id="h3" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/SnapEnhance.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/SnapEnhance.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/SnapEnhance.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/SnapEnhance.kt</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -3,6 +3,7 @@ package me.rhunk.snapenhance.core
</a> import android.app.Activity
 import android.app.Application
 import android.content.Context
<a href="#h3-0-3" id="h3-0-3" class="i">+import android.content.res.Resources
</a> import kotlinx.coroutines.CoroutineScope
 import kotlinx.coroutines.Dispatchers
 import kotlinx.coroutines.launch
<a href="#h3-1" id="h3-1" class="h">@@ -20,8 +21,10 @@ import me.rhunk.snapenhance.core.data.SnapClassCache
</a> import me.rhunk.snapenhance.core.event.events.impl.NativeUnaryCallEvent
 import me.rhunk.snapenhance.core.event.events.impl.SnapWidgetBroadcastReceiveEvent
 import me.rhunk.snapenhance.core.util.LSPatchUpdater
<a href="#h3-1-3" id="h3-1-3" class="i">+import me.rhunk.snapenhance.core.util.hook.HookAdapter
</a> import me.rhunk.snapenhance.core.util.hook.HookStage
 import me.rhunk.snapenhance.core.util.hook.hook
<a href="#h3-1-6" id="h3-1-6" class="i">+import java.lang.reflect.Modifier
</a> import kotlin.system.measureTimeMillis
 
 
<a href="#h3-2" id="h3-2" class="h">@@ -36,11 +39,11 @@ class SnapEnhance {
</a>     private lateinit var appContext: ModContext
     private var isBridgeInitialized = false
 
<a href="#h3-2-3" id="h3-2-3" class="d">-    private fun hookMainActivity(methodName: String, stage: HookStage = HookStage.AFTER, block: Activity.() -&gt; Unit) {
</a><a href="#h3-2-4" id="h3-2-4" class="i">+    private fun hookMainActivity(methodName: String, stage: HookStage = HookStage.AFTER, block: Activity.(param: HookAdapter) -&gt; Unit) {
</a>         Activity::class.java.hook(methodName, stage, { isBridgeInitialized }) { param -&gt;
             val activity = param.thisObject() as Activity
             if (!activity.packageName.equals(Constants.SNAPCHAT_PACKAGE_NAME)) return@hook
<a href="#h3-2-8" id="h3-2-8" class="d">-            block(activity)
</a><a href="#h3-2-9" id="h3-2-9" class="i">+            block(activity, param)
</a>         }
     }
 
<a href="#h3-3" id="h3-3" class="h">@@ -90,6 +93,8 @@ class SnapEnhance {
</a>             appContext.mainActivity = this
             if (isMainActivityNotNull || !appContext.mappings.isMappingsLoaded()) return@hookMainActivity
             onActivityCreate()
<a href="#h3-3-3" id="h3-3-3" class="i">+            jetpackComposeResourceHook()
</a><a href="#h3-3-4" id="h3-3-4" class="i">+            appContext.actionManager.onNewIntent(intent)
</a>         }
 
         hookMainActivity(&quot;onPause&quot;) {
<a href="#h3-4" id="h3-4" class="h">@@ -97,6 +102,10 @@ class SnapEnhance {
</a>             appContext.isMainActivityPaused = true
         }
 
<a href="#h3-4-3" id="h3-4-3" class="i">+        hookMainActivity(&quot;onNewIntent&quot;) { param -&gt;
</a><a href="#h3-4-4" id="h3-4-4" class="i">+            appContext.actionManager.onNewIntent(param.argNullable(0))
</a><a href="#h3-4-5" id="h3-4-5" class="i">+        }
</a><a href="#h3-4-6" id="h3-4-6" class="i">+
</a>         var activityWasResumed = false
         //we need to reload the config when the app is resumed
         //FIXME: called twice at first launch
<a href="#h3-5" id="h3-5" class="h">@@ -107,7 +116,6 @@ class SnapEnhance {
</a>                 return@hookMainActivity
             }
 
<a href="#h3-5-3" id="h3-5-3" class="d">-            appContext.actionManager.onNewIntent(this.intent)
</a>             appContext.reloadConfig()
             syncRemote()
         }
<a href="#h3-6" id="h3-6" class="h">@@ -263,4 +271,22 @@ class SnapEnhance {
</a>             }
         }
     }
<a href="#h3-6-3" id="h3-6-3" class="i">+
</a><a href="#h3-6-4" id="h3-6-4" class="i">+    private fun jetpackComposeResourceHook() {
</a><a href="#h3-6-5" id="h3-6-5" class="i">+        val material3RString = try {
</a><a href="#h3-6-6" id="h3-6-6" class="i">+            Class.forName(&quot;androidx.compose.material3.R\$string&quot;)
</a><a href="#h3-6-7" id="h3-6-7" class="i">+        } catch (e: ClassNotFoundException) {
</a><a href="#h3-6-8" id="h3-6-8" class="i">+            return
</a><a href="#h3-6-9" id="h3-6-9" class="i">+        }
</a><a href="#h3-6-10" id="h3-6-10" class="i">+
</a><a href="#h3-6-11" id="h3-6-11" class="i">+        val stringResources = material3RString.fields.filter {
</a><a href="#h3-6-12" id="h3-6-12" class="i">+            Modifier.isStatic(it.modifiers) &amp;&amp; it.type == Int::class.javaPrimitiveType
</a><a href="#h3-6-13" id="h3-6-13" class="i">+        }.associate { it.getInt(null) to it.name }
</a><a href="#h3-6-14" id="h3-6-14" class="i">+
</a><a href="#h3-6-15" id="h3-6-15" class="i">+        Resources::class.java.getMethod(&quot;getString&quot;, Int::class.javaPrimitiveType).hook(HookStage.BEFORE) { param -&gt;
</a><a href="#h3-6-16" id="h3-6-16" class="i">+            val key = param.arg&lt;Int&gt;(0)
</a><a href="#h3-6-17" id="h3-6-17" class="i">+            val name = stringResources[key] ?: return@hook
</a><a href="#h3-6-18" id="h3-6-18" class="i">+            param.setResult(appContext.translation.getOrNull(&quot;material3_strings.$name&quot;) ?: return@hook)
</a><a href="#h3-6-19" id="h3-6-19" class="i">+        }
</a><a href="#h3-6-20" id="h3-6-20" class="i">+    }
</a> } 
\ No newline at end of file
<b>diff --git a/<a id="h4" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/action/impl/ExportMemories.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/action/impl/ExportMemories.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/action/impl/ExportMemories.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/action/impl/ExportMemories.kt</a></b>
<a href="#h4-0" id="h4-0" class="h">@@ -0,0 +1,384 @@
</a><a href="#h4-0-0" id="h4-0-0" class="i">+package me.rhunk.snapenhance.core.action.impl
</a><a href="#h4-0-1" id="h4-0-1" class="i">+
</a><a href="#h4-0-2" id="h4-0-2" class="i">+import android.database.sqlite.SQLiteDatabase
</a><a href="#h4-0-3" id="h4-0-3" class="i">+import android.database.sqlite.SQLiteDatabase.OpenParams
</a><a href="#h4-0-4" id="h4-0-4" class="i">+import android.os.Environment
</a><a href="#h4-0-5" id="h4-0-5" class="i">+import androidx.compose.foundation.layout.Arrangement
</a><a href="#h4-0-6" id="h4-0-6" class="i">+import androidx.compose.foundation.layout.Column
</a><a href="#h4-0-7" id="h4-0-7" class="i">+import androidx.compose.foundation.layout.Row
</a><a href="#h4-0-8" id="h4-0-8" class="i">+import androidx.compose.foundation.layout.fillMaxWidth
</a><a href="#h4-0-9" id="h4-0-9" class="i">+import androidx.compose.foundation.layout.padding
</a><a href="#h4-0-10" id="h4-0-10" class="i">+import androidx.compose.material3.*
</a><a href="#h4-0-11" id="h4-0-11" class="i">+import androidx.compose.runtime.Composable
</a><a href="#h4-0-12" id="h4-0-12" class="i">+import androidx.compose.runtime.getValue
</a><a href="#h4-0-13" id="h4-0-13" class="i">+import androidx.compose.runtime.mutableStateOf
</a><a href="#h4-0-14" id="h4-0-14" class="i">+import androidx.compose.runtime.remember
</a><a href="#h4-0-15" id="h4-0-15" class="i">+import androidx.compose.runtime.setValue
</a><a href="#h4-0-16" id="h4-0-16" class="i">+import androidx.compose.ui.Alignment
</a><a href="#h4-0-17" id="h4-0-17" class="i">+import androidx.compose.ui.Modifier
</a><a href="#h4-0-18" id="h4-0-18" class="i">+import androidx.compose.ui.text.style.TextAlign
</a><a href="#h4-0-19" id="h4-0-19" class="i">+import androidx.compose.ui.unit.dp
</a><a href="#h4-0-20" id="h4-0-20" class="i">+import androidx.compose.ui.unit.sp
</a><a href="#h4-0-21" id="h4-0-21" class="i">+import kotlinx.coroutines.*
</a><a href="#h4-0-22" id="h4-0-22" class="i">+import me.rhunk.snapenhance.common.data.FileType
</a><a href="#h4-0-23" id="h4-0-23" class="i">+import me.rhunk.snapenhance.common.ui.createComposeAlertDialog
</a><a href="#h4-0-24" id="h4-0-24" class="i">+import me.rhunk.snapenhance.common.util.ktx.getLongOrNull
</a><a href="#h4-0-25" id="h4-0-25" class="i">+import me.rhunk.snapenhance.common.util.ktx.getStringOrNull
</a><a href="#h4-0-26" id="h4-0-26" class="i">+import me.rhunk.snapenhance.core.action.AbstractAction
</a><a href="#h4-0-27" id="h4-0-27" class="i">+import okhttp3.OkHttpClient
</a><a href="#h4-0-28" id="h4-0-28" class="i">+import java.io.File
</a><a href="#h4-0-29" id="h4-0-29" class="i">+import java.io.FileOutputStream
</a><a href="#h4-0-30" id="h4-0-30" class="i">+import java.nio.file.attribute.FileTime
</a><a href="#h4-0-31" id="h4-0-31" class="i">+import java.time.Instant
</a><a href="#h4-0-32" id="h4-0-32" class="i">+import java.time.OffsetDateTime
</a><a href="#h4-0-33" id="h4-0-33" class="i">+import java.util.zip.ZipEntry
</a><a href="#h4-0-34" id="h4-0-34" class="i">+import java.util.zip.ZipOutputStream
</a><a href="#h4-0-35" id="h4-0-35" class="i">+import javax.crypto.Cipher
</a><a href="#h4-0-36" id="h4-0-36" class="i">+import javax.crypto.CipherInputStream
</a><a href="#h4-0-37" id="h4-0-37" class="i">+import javax.crypto.spec.IvParameterSpec
</a><a href="#h4-0-38" id="h4-0-38" class="i">+import javax.crypto.spec.SecretKeySpec
</a><a href="#h4-0-39" id="h4-0-39" class="i">+import kotlin.io.encoding.Base64
</a><a href="#h4-0-40" id="h4-0-40" class="i">+import kotlin.io.encoding.ExperimentalEncodingApi
</a><a href="#h4-0-41" id="h4-0-41" class="i">+import kotlin.math.absoluteValue
</a><a href="#h4-0-42" id="h4-0-42" class="i">+
</a><a href="#h4-0-43" id="h4-0-43" class="i">+class ExportMemories : AbstractAction() {
</a><a href="#h4-0-44" id="h4-0-44" class="i">+    data class TimeRange(
</a><a href="#h4-0-45" id="h4-0-45" class="i">+        val start: Long?,
</a><a href="#h4-0-46" id="h4-0-46" class="i">+        val end: Long?,
</a><a href="#h4-0-47" id="h4-0-47" class="i">+    )
</a><a href="#h4-0-48" id="h4-0-48" class="i">+
</a><a href="#h4-0-49" id="h4-0-49" class="i">+    data class MemoriesEntry(
</a><a href="#h4-0-50" id="h4-0-50" class="i">+        val storyTitle: String,
</a><a href="#h4-0-51" id="h4-0-51" class="i">+        val createTime: Long,
</a><a href="#h4-0-52" id="h4-0-52" class="i">+        val mediaKey: String?,
</a><a href="#h4-0-53" id="h4-0-53" class="i">+        val mediaIv: String?,
</a><a href="#h4-0-54" id="h4-0-54" class="i">+        val downloadUrl: String
</a><a href="#h4-0-55" id="h4-0-55" class="i">+    ) {
</a><a href="#h4-0-56" id="h4-0-56" class="i">+        val folderName: String
</a><a href="#h4-0-57" id="h4-0-57" class="i">+            get() = storyTitle.replace(Regex(&quot;[^a-zA-Z0-9\\s]&quot;), &quot;&quot;).trim().replace(Regex(&quot;\\s+&quot;), &quot;_&quot;)
</a><a href="#h4-0-58" id="h4-0-58" class="i">+    }
</a><a href="#h4-0-59" id="h4-0-59" class="i">+
</a><a href="#h4-0-60" id="h4-0-60" class="i">+    @OptIn(ExperimentalCoroutinesApi::class, ExperimentalEncodingApi::class)
</a><a href="#h4-0-61" id="h4-0-61" class="i">+    private suspend fun exportMemories(
</a><a href="#h4-0-62" id="h4-0-62" class="i">+        scope: CoroutineScope = context.coroutineScope,
</a><a href="#h4-0-63" id="h4-0-63" class="i">+        database: SQLiteDatabase,
</a><a href="#h4-0-64" id="h4-0-64" class="i">+        timeRange: TimeRange?,
</a><a href="#h4-0-65" id="h4-0-65" class="i">+        includeMEO: Boolean,
</a><a href="#h4-0-66" id="h4-0-66" class="i">+        folders: Boolean,
</a><a href="#h4-0-67" id="h4-0-67" class="i">+        progress: (Int, Int) -&gt; Unit
</a><a href="#h4-0-68" id="h4-0-68" class="i">+    ) {
</a><a href="#h4-0-69" id="h4-0-69" class="i">+        val downloadContext = Dispatchers.IO.limitedParallelism(10)
</a><a href="#h4-0-70" id="h4-0-70" class="i">+        val writeToZipContext = Dispatchers.IO.limitedParallelism(1)
</a><a href="#h4-0-71" id="h4-0-71" class="i">+        val outputZip = File(Environment.getExternalStoragePublicDirectory(Environment.DIRECTORY_DOCUMENTS), &quot;memories_&quot; + System.currentTimeMillis() + &quot;.zip&quot;).also {
</a><a href="#h4-0-72" id="h4-0-72" class="i">+            if (it.exists()) it.delete()
</a><a href="#h4-0-73" id="h4-0-73" class="i">+        }
</a><a href="#h4-0-74" id="h4-0-74" class="i">+        val okHttpClient = OkHttpClient.Builder().build()
</a><a href="#h4-0-75" id="h4-0-75" class="i">+        val outputZipFile = withContext(Dispatchers.IO) {
</a><a href="#h4-0-76" id="h4-0-76" class="i">+            ZipOutputStream(FileOutputStream(outputZip)).apply {
</a><a href="#h4-0-77" id="h4-0-77" class="i">+                setComment(&quot;Exported from SnapEnhance&quot;)
</a><a href="#h4-0-78" id="h4-0-78" class="i">+                setMethod(ZipOutputStream.DEFLATED)
</a><a href="#h4-0-79" id="h4-0-79" class="i">+            }
</a><a href="#h4-0-80" id="h4-0-80" class="i">+        }
</a><a href="#h4-0-81" id="h4-0-81" class="i">+        var totalCount = 0
</a><a href="#h4-0-82" id="h4-0-82" class="i">+        var currentCount = 0
</a><a href="#h4-0-83" id="h4-0-83" class="i">+        var failed = 0
</a><a href="#h4-0-84" id="h4-0-84" class="i">+
</a><a href="#h4-0-85" id="h4-0-85" class="i">+        fun updateProgress() {
</a><a href="#h4-0-86" id="h4-0-86" class="i">+            progress((currentCount.toFloat() / totalCount.toFloat() * 100f).toInt(), failed)
</a><a href="#h4-0-87" id="h4-0-87" class="i">+        }
</a><a href="#h4-0-88" id="h4-0-88" class="i">+
</a><a href="#h4-0-89" id="h4-0-89" class="i">+        val jobs = mutableListOf&lt;Job&gt;()
</a><a href="#h4-0-90" id="h4-0-90" class="i">+
</a><a href="#h4-0-91" id="h4-0-91" class="i">+        val meoMasterKeyPair = if (includeMEO) {
</a><a href="#h4-0-92" id="h4-0-92" class="i">+            runCatching {
</a><a href="#h4-0-93" id="h4-0-93" class="i">+                database.rawQuery(&quot;SELECT * FROM memories_meo_confidential&quot;, null).use { cursor -&gt;
</a><a href="#h4-0-94" id="h4-0-94" class="i">+                    if (cursor.moveToNext()) {
</a><a href="#h4-0-95" id="h4-0-95" class="i">+                        cursor.getStringOrNull(&quot;master_key&quot;)!!.trim() to cursor.getStringOrNull(&quot;master_key_iv&quot;)!!.trim()
</a><a href="#h4-0-96" id="h4-0-96" class="i">+                    } else null
</a><a href="#h4-0-97" id="h4-0-97" class="i">+                }
</a><a href="#h4-0-98" id="h4-0-98" class="i">+            }.getOrNull()
</a><a href="#h4-0-99" id="h4-0-99" class="i">+        } else null
</a><a href="#h4-0-100" id="h4-0-100" class="i">+
</a><a href="#h4-0-101" id="h4-0-101" class="i">+        database.rawQuery(&quot;SELECT memories_entry.title as story_title, memories_snap.create_time, &quot; +
</a><a href="#h4-0-102" id="h4-0-102" class="i">+                &quot;memories_snap.media_key, memories_snap.media_iv, memories_snap.encrypted_media_key, memories_snap.encrypted_media_iv, &quot; +
</a><a href="#h4-0-103" id="h4-0-103" class="i">+                &quot;memories_media.download_url FROM memories_snap &quot; +
</a><a href="#h4-0-104" id="h4-0-104" class="i">+            &quot;INNER JOIN memories_entry ON memories_snap.memories_entry_id = memories_entry._id &quot; +
</a><a href="#h4-0-105" id="h4-0-105" class="i">+            &quot;INNER JOIN memories_media ON memories_snap.media_id = memories_media._id &quot; +
</a><a href="#h4-0-106" id="h4-0-106" class="i">+            &quot;WHERE memories_snap.create_time &gt;= ? AND memories_snap.create_time &lt;= ? &quot; +
</a><a href="#h4-0-107" id="h4-0-107" class="i">+            &quot;ORDER BY memories_snap.create_time ASC&quot;, arrayOf(timeRange?.start?.toString() ?: &quot;-1&quot;, timeRange?.end?.toString() ?: Long.MAX_VALUE.toString())
</a><a href="#h4-0-108" id="h4-0-108" class="i">+        ).use { cursor -&gt;
</a><a href="#h4-0-109" id="h4-0-109" class="i">+            while (cursor.moveToNext()) {
</a><a href="#h4-0-110" id="h4-0-110" class="i">+                val encryptedMediaKey = cursor.getStringOrNull(&quot;encrypted_media_key&quot;)?.trim()
</a><a href="#h4-0-111" id="h4-0-111" class="i">+                val encryptedMediaIv = cursor.getStringOrNull(&quot;encrypted_media_iv&quot;)?.trim()
</a><a href="#h4-0-112" id="h4-0-112" class="i">+                var mediaKey = cursor.getStringOrNull(&quot;media_key&quot;)?.trim()
</a><a href="#h4-0-113" id="h4-0-113" class="i">+                var mediaIv = cursor.getStringOrNull(&quot;media_iv&quot;)?.trim()
</a><a href="#h4-0-114" id="h4-0-114" class="i">+
</a><a href="#h4-0-115" id="h4-0-115" class="i">+                if (!includeMEO &amp;&amp; encryptedMediaKey != null &amp;&amp; encryptedMediaIv != null) continue
</a><a href="#h4-0-116" id="h4-0-116" class="i">+
</a><a href="#h4-0-117" id="h4-0-117" class="i">+                meoMasterKeyPair.takeIf { encryptedMediaKey != null &amp;&amp; encryptedMediaIv != null }?.let { keyPair -&gt;
</a><a href="#h4-0-118" id="h4-0-118" class="i">+                    val cipher = Cipher.getInstance(&quot;AES/CBC/PKCS5Padding&quot;)
</a><a href="#h4-0-119" id="h4-0-119" class="i">+                    runCatching {
</a><a href="#h4-0-120" id="h4-0-120" class="i">+                        cipher.init(Cipher.DECRYPT_MODE, SecretKeySpec(Base64.decode(keyPair.first), &quot;AES&quot;), IvParameterSpec(Base64.decode(keyPair.second)))
</a><a href="#h4-0-121" id="h4-0-121" class="i">+                        mediaKey = Base64.encode(cipher.doFinal(Base64.decode(encryptedMediaKey ?: return@let)))
</a><a href="#h4-0-122" id="h4-0-122" class="i">+                        mediaIv = Base64.encode(cipher.doFinal(Base64.decode(encryptedMediaIv ?: return@let)))
</a><a href="#h4-0-123" id="h4-0-123" class="i">+                        context.log.verbose(&quot;decrypted meo $mediaKey/$mediaIv&quot;)
</a><a href="#h4-0-124" id="h4-0-124" class="i">+                    }.onFailure {
</a><a href="#h4-0-125" id="h4-0-125" class="i">+                        context.log.error(&quot;failed to decrypt meo&quot;, it)
</a><a href="#h4-0-126" id="h4-0-126" class="i">+                    }
</a><a href="#h4-0-127" id="h4-0-127" class="i">+                }
</a><a href="#h4-0-128" id="h4-0-128" class="i">+
</a><a href="#h4-0-129" id="h4-0-129" class="i">+                if (mediaKey == null || mediaIv == null) {
</a><a href="#h4-0-130" id="h4-0-130" class="i">+                    context.log.error(&quot;missing media key or iv for ${cursor.getStringOrNull(&quot;download_url&quot;)}&quot;)
</a><a href="#h4-0-131" id="h4-0-131" class="i">+                    failed++
</a><a href="#h4-0-132" id="h4-0-132" class="i">+                    updateProgress()
</a><a href="#h4-0-133" id="h4-0-133" class="i">+                    continue
</a><a href="#h4-0-134" id="h4-0-134" class="i">+                }
</a><a href="#h4-0-135" id="h4-0-135" class="i">+
</a><a href="#h4-0-136" id="h4-0-136" class="i">+                val entry = MemoriesEntry(
</a><a href="#h4-0-137" id="h4-0-137" class="i">+                    storyTitle = cursor.getStringOrNull(&quot;story_title&quot;) ?: &quot;unknown&quot;,
</a><a href="#h4-0-138" id="h4-0-138" class="i">+                    createTime = cursor.getLongOrNull(&quot;create_time&quot;) ?: -1L,
</a><a href="#h4-0-139" id="h4-0-139" class="i">+                    mediaKey = mediaKey,
</a><a href="#h4-0-140" id="h4-0-140" class="i">+                    mediaIv = mediaIv,
</a><a href="#h4-0-141" id="h4-0-141" class="i">+                    downloadUrl = cursor.getStringOrNull(&quot;download_url&quot;) ?: continue
</a><a href="#h4-0-142" id="h4-0-142" class="i">+                )
</a><a href="#h4-0-143" id="h4-0-143" class="i">+
</a><a href="#h4-0-144" id="h4-0-144" class="i">+                totalCount++
</a><a href="#h4-0-145" id="h4-0-145" class="i">+
</a><a href="#h4-0-146" id="h4-0-146" class="i">+                scope.launch(downloadContext) {
</a><a href="#h4-0-147" id="h4-0-147" class="i">+                    var downloadedFile = File.createTempFile(&quot;memories&quot;, &quot;.tmp&quot;, context.androidContext.cacheDir)
</a><a href="#h4-0-148" id="h4-0-148" class="i">+
</a><a href="#h4-0-149" id="h4-0-149" class="i">+                    runCatching {
</a><a href="#h4-0-150" id="h4-0-150" class="i">+                        okHttpClient.newCall(
</a><a href="#h4-0-151" id="h4-0-151" class="i">+                            okhttp3.Request.Builder()
</a><a href="#h4-0-152" id="h4-0-152" class="i">+                                .url(entry.downloadUrl)
</a><a href="#h4-0-153" id="h4-0-153" class="i">+                                .build()
</a><a href="#h4-0-154" id="h4-0-154" class="i">+                        ).execute().use { response -&gt;
</a><a href="#h4-0-155" id="h4-0-155" class="i">+                            val inputStream  = response.body.byteStream().let {
</a><a href="#h4-0-156" id="h4-0-156" class="i">+                                if (entry.mediaKey != null &amp;&amp; entry.mediaIv != null) {
</a><a href="#h4-0-157" id="h4-0-157" class="i">+                                    val cipher = Cipher.getInstance(&quot;AES/CBC/PKCS5Padding&quot;)
</a><a href="#h4-0-158" id="h4-0-158" class="i">+                                    cipher.init(Cipher.DECRYPT_MODE, SecretKeySpec(Base64.decode(entry.mediaKey), &quot;AES&quot;), IvParameterSpec(Base64.decode(entry.mediaIv)))
</a><a href="#h4-0-159" id="h4-0-159" class="i">+                                    CipherInputStream(it, cipher)
</a><a href="#h4-0-160" id="h4-0-160" class="i">+                                } else it
</a><a href="#h4-0-161" id="h4-0-161" class="i">+                            }
</a><a href="#h4-0-162" id="h4-0-162" class="i">+
</a><a href="#h4-0-163" id="h4-0-163" class="i">+                            downloadedFile.outputStream().use { outputStream -&gt;
</a><a href="#h4-0-164" id="h4-0-164" class="i">+                                inputStream.use { inputStream -&gt;
</a><a href="#h4-0-165" id="h4-0-165" class="i">+                                    inputStream.copyTo(outputStream)
</a><a href="#h4-0-166" id="h4-0-166" class="i">+                                }
</a><a href="#h4-0-167" id="h4-0-167" class="i">+                            }
</a><a href="#h4-0-168" id="h4-0-168" class="i">+
</a><a href="#h4-0-169" id="h4-0-169" class="i">+                            val fileType = FileType.fromFile(downloadedFile)
</a><a href="#h4-0-170" id="h4-0-170" class="i">+
</a><a href="#h4-0-171" id="h4-0-171" class="i">+                            downloadedFile = File(
</a><a href="#h4-0-172" id="h4-0-172" class="i">+                                downloadedFile.parentFile,
</a><a href="#h4-0-173" id="h4-0-173" class="i">+                                &quot;${entry.createTime}-${entry.downloadUrl.hashCode().absoluteValue.toString(16)}.${fileType.fileExtension}&quot;
</a><a href="#h4-0-174" id="h4-0-174" class="i">+                            ).also {
</a><a href="#h4-0-175" id="h4-0-175" class="i">+                                downloadedFile.renameTo(it)
</a><a href="#h4-0-176" id="h4-0-176" class="i">+                            }
</a><a href="#h4-0-177" id="h4-0-177" class="i">+
</a><a href="#h4-0-178" id="h4-0-178" class="i">+                            withContext(writeToZipContext) {
</a><a href="#h4-0-179" id="h4-0-179" class="i">+                                val zipEntry = ZipEntry(&quot;${if (folders) entry.folderName + &quot;/&quot; else entry.folderName}${downloadedFile.name}&quot;)
</a><a href="#h4-0-180" id="h4-0-180" class="i">+                                FileTime.fromMillis(entry.createTime).let {
</a><a href="#h4-0-181" id="h4-0-181" class="i">+                                    zipEntry.lastModifiedTime = it
</a><a href="#h4-0-182" id="h4-0-182" class="i">+                                    zipEntry.lastAccessTime = it
</a><a href="#h4-0-183" id="h4-0-183" class="i">+                                    zipEntry.creationTime = it
</a><a href="#h4-0-184" id="h4-0-184" class="i">+                                }
</a><a href="#h4-0-185" id="h4-0-185" class="i">+                                outputZipFile.apply {
</a><a href="#h4-0-186" id="h4-0-186" class="i">+                                    putNextEntry(zipEntry)
</a><a href="#h4-0-187" id="h4-0-187" class="i">+                                    downloadedFile.inputStream().use { it.copyTo(outputZipFile) }
</a><a href="#h4-0-188" id="h4-0-188" class="i">+                                    closeEntry()
</a><a href="#h4-0-189" id="h4-0-189" class="i">+                                    flush()
</a><a href="#h4-0-190" id="h4-0-190" class="i">+                                }
</a><a href="#h4-0-191" id="h4-0-191" class="i">+                                currentCount++
</a><a href="#h4-0-192" id="h4-0-192" class="i">+                                updateProgress()
</a><a href="#h4-0-193" id="h4-0-193" class="i">+                            }
</a><a href="#h4-0-194" id="h4-0-194" class="i">+                        }
</a><a href="#h4-0-195" id="h4-0-195" class="i">+                    }.onFailure {
</a><a href="#h4-0-196" id="h4-0-196" class="i">+                        context.log.error(&quot;failed to download ${entry.downloadUrl}&quot;, it)
</a><a href="#h4-0-197" id="h4-0-197" class="i">+                        failed++
</a><a href="#h4-0-198" id="h4-0-198" class="i">+                        updateProgress()
</a><a href="#h4-0-199" id="h4-0-199" class="i">+                    }
</a><a href="#h4-0-200" id="h4-0-200" class="i">+                    downloadedFile.delete()
</a><a href="#h4-0-201" id="h4-0-201" class="i">+                }.also { jobs.add(it) }
</a><a href="#h4-0-202" id="h4-0-202" class="i">+            }
</a><a href="#h4-0-203" id="h4-0-203" class="i">+        }
</a><a href="#h4-0-204" id="h4-0-204" class="i">+
</a><a href="#h4-0-205" id="h4-0-205" class="i">+        jobs.joinAll()
</a><a href="#h4-0-206" id="h4-0-206" class="i">+        withContext(Dispatchers.IO) {
</a><a href="#h4-0-207" id="h4-0-207" class="i">+            outputZipFile.close()
</a><a href="#h4-0-208" id="h4-0-208" class="i">+        }
</a><a href="#h4-0-209" id="h4-0-209" class="i">+        context.longToast(&quot;Exported to ${outputZip.absolutePath}&quot;)
</a><a href="#h4-0-210" id="h4-0-210" class="i">+    }
</a><a href="#h4-0-211" id="h4-0-211" class="i">+
</a><a href="#h4-0-212" id="h4-0-212" class="i">+    @OptIn(ExperimentalMaterial3Api::class)
</a><a href="#h4-0-213" id="h4-0-213" class="i">+    @Composable
</a><a href="#h4-0-214" id="h4-0-214" class="i">+    fun ExporterDialog(database: SQLiteDatabase, onDismiss: () -&gt; Unit) {
</a><a href="#h4-0-215" id="h4-0-215" class="i">+        var exportJob by remember { mutableStateOf(null as Job?) }
</a><a href="#h4-0-216" id="h4-0-216" class="i">+        var exportFinished by remember { mutableStateOf(false) }
</a><a href="#h4-0-217" id="h4-0-217" class="i">+        var exportProgress by remember { mutableStateOf(Pair(0, 0)) } // progress, failed
</a><a href="#h4-0-218" id="h4-0-218" class="i">+
</a><a href="#h4-0-219" id="h4-0-219" class="i">+        var dateRangeFilter by remember { mutableStateOf(false) }
</a><a href="#h4-0-220" id="h4-0-220" class="i">+        var sortByFolder by remember { mutableStateOf(false) }
</a><a href="#h4-0-221" id="h4-0-221" class="i">+        var includeMEO by remember { mutableStateOf(false) }
</a><a href="#h4-0-222" id="h4-0-222" class="i">+        val dateRangePickerState = rememberDateRangePickerState(
</a><a href="#h4-0-223" id="h4-0-223" class="i">+            initialSelectedStartDateMillis = OffsetDateTime.now().minusDays(8).toInstant().toEpochMilli(),
</a><a href="#h4-0-224" id="h4-0-224" class="i">+            initialSelectedEndDateMillis = Instant.now().toEpochMilli(),
</a><a href="#h4-0-225" id="h4-0-225" class="i">+            initialDisplayMode = DisplayMode.Input
</a><a href="#h4-0-226" id="h4-0-226" class="i">+        )
</a><a href="#h4-0-227" id="h4-0-227" class="i">+
</a><a href="#h4-0-228" id="h4-0-228" class="i">+        val totalCount = remember(dateRangePickerState.selectedStartDateMillis, dateRangePickerState.selectedEndDateMillis, dateRangeFilter) {
</a><a href="#h4-0-229" id="h4-0-229" class="i">+            val timeRange = dateRangePickerState.takeIf { dateRangeFilter }?.let {
</a><a href="#h4-0-230" id="h4-0-230" class="i">+                TimeRange(it.selectedStartDateMillis, it.selectedEndDateMillis)
</a><a href="#h4-0-231" id="h4-0-231" class="i">+            }
</a><a href="#h4-0-232" id="h4-0-232" class="i">+
</a><a href="#h4-0-233" id="h4-0-233" class="i">+            database.rawQuery(&quot;SELECT COUNT(*) FROM memories_snap WHERE create_time &gt;= ? AND create_time &lt;= ? &quot;, arrayOf(timeRange?.start?.toString() ?: &quot;-1&quot;, timeRange?.end?.toString() ?: Long.MAX_VALUE.toString())).use {
</a><a href="#h4-0-234" id="h4-0-234" class="i">+                it.moveToFirst()
</a><a href="#h4-0-235" id="h4-0-235" class="i">+                it.getInt(0)
</a><a href="#h4-0-236" id="h4-0-236" class="i">+            }
</a><a href="#h4-0-237" id="h4-0-237" class="i">+        }
</a><a href="#h4-0-238" id="h4-0-238" class="i">+
</a><a href="#h4-0-239" id="h4-0-239" class="i">+        Column(
</a><a href="#h4-0-240" id="h4-0-240" class="i">+            modifier = Modifier.padding(16.dp),
</a><a href="#h4-0-241" id="h4-0-241" class="i">+            verticalArrangement = Arrangement.spacedBy(8.dp)
</a><a href="#h4-0-242" id="h4-0-242" class="i">+        ) {
</a><a href="#h4-0-243" id="h4-0-243" class="i">+            Text(&quot;Export memories&quot;, modifier = Modifier.fillMaxWidth(), textAlign = TextAlign.Center, fontSize = 20.sp)
</a><a href="#h4-0-244" id="h4-0-244" class="i">+
</a><a href="#h4-0-245" id="h4-0-245" class="i">+            if (exportJob != null) {
</a><a href="#h4-0-246" id="h4-0-246" class="i">+                Text(text = &quot;Exporting memories... (${exportProgress.second} failed)&quot;, modifier = Modifier.fillMaxWidth(), textAlign = TextAlign.Center)
</a><a href="#h4-0-247" id="h4-0-247" class="i">+                LinearProgressIndicator(progress = exportProgress.first / 100f, Modifier.fillMaxWidth())
</a><a href="#h4-0-248" id="h4-0-248" class="i">+                Row(
</a><a href="#h4-0-249" id="h4-0-249" class="i">+                    modifier = Modifier.fillMaxWidth(),
</a><a href="#h4-0-250" id="h4-0-250" class="i">+                    horizontalArrangement = Arrangement.SpaceEvenly,
</a><a href="#h4-0-251" id="h4-0-251" class="i">+                    verticalAlignment = Alignment.CenterVertically
</a><a href="#h4-0-252" id="h4-0-252" class="i">+                ) {
</a><a href="#h4-0-253" id="h4-0-253" class="i">+                    Button(onClick = {
</a><a href="#h4-0-254" id="h4-0-254" class="i">+                        exportJob?.cancel()
</a><a href="#h4-0-255" id="h4-0-255" class="i">+                        exportJob = null
</a><a href="#h4-0-256" id="h4-0-256" class="i">+                        onDismiss()
</a><a href="#h4-0-257" id="h4-0-257" class="i">+                    }) {
</a><a href="#h4-0-258" id="h4-0-258" class="i">+                        Text(&quot;Quit&quot;)
</a><a href="#h4-0-259" id="h4-0-259" class="i">+                    }
</a><a href="#h4-0-260" id="h4-0-260" class="i">+                    if (exportFinished) {
</a><a href="#h4-0-261" id="h4-0-261" class="i">+                        Button(onClick = {
</a><a href="#h4-0-262" id="h4-0-262" class="i">+                            exportJob = null
</a><a href="#h4-0-263" id="h4-0-263" class="i">+                            onDismiss()
</a><a href="#h4-0-264" id="h4-0-264" class="i">+                        }) {
</a><a href="#h4-0-265" id="h4-0-265" class="i">+                            Text(&quot;Done&quot;)
</a><a href="#h4-0-266" id="h4-0-266" class="i">+                        }
</a><a href="#h4-0-267" id="h4-0-267" class="i">+                    }
</a><a href="#h4-0-268" id="h4-0-268" class="i">+                }
</a><a href="#h4-0-269" id="h4-0-269" class="i">+            } else {
</a><a href="#h4-0-270" id="h4-0-270" class="i">+                Text(&quot;Total memories: $totalCount&quot;, modifier = Modifier.fillMaxWidth(), textAlign = TextAlign.Center)
</a><a href="#h4-0-271" id="h4-0-271" class="i">+
</a><a href="#h4-0-272" id="h4-0-272" class="i">+                Row(
</a><a href="#h4-0-273" id="h4-0-273" class="i">+                    modifier = Modifier.fillMaxWidth(),
</a><a href="#h4-0-274" id="h4-0-274" class="i">+                    horizontalArrangement = Arrangement.spacedBy(5.dp),
</a><a href="#h4-0-275" id="h4-0-275" class="i">+                    verticalAlignment = Alignment.CenterVertically
</a><a href="#h4-0-276" id="h4-0-276" class="i">+                ) {
</a><a href="#h4-0-277" id="h4-0-277" class="i">+                    var dateRangeDialog by remember { mutableStateOf(false) }
</a><a href="#h4-0-278" id="h4-0-278" class="i">+                    Checkbox(checked = dateRangeFilter, onCheckedChange = { dateRangeFilter = it })
</a><a href="#h4-0-279" id="h4-0-279" class="i">+                    Text(&quot;Date Range&quot;, modifier = Modifier.weight(1f))
</a><a href="#h4-0-280" id="h4-0-280" class="i">+                    Button(onClick = { dateRangeDialog = true }, enabled = dateRangeFilter) {
</a><a href="#h4-0-281" id="h4-0-281" class="i">+                        Text(&quot;Select&quot;)
</a><a href="#h4-0-282" id="h4-0-282" class="i">+                    }
</a><a href="#h4-0-283" id="h4-0-283" class="i">+
</a><a href="#h4-0-284" id="h4-0-284" class="i">+                    if (dateRangeDialog) {
</a><a href="#h4-0-285" id="h4-0-285" class="i">+                        DatePickerDialog(onDismissRequest = {
</a><a href="#h4-0-286" id="h4-0-286" class="i">+                            dateRangeDialog = false
</a><a href="#h4-0-287" id="h4-0-287" class="i">+                        }, confirmButton = {}) {
</a><a href="#h4-0-288" id="h4-0-288" class="i">+                            DateRangePicker(
</a><a href="#h4-0-289" id="h4-0-289" class="i">+                                state = dateRangePickerState,
</a><a href="#h4-0-290" id="h4-0-290" class="i">+                                modifier = Modifier.weight(1f),
</a><a href="#h4-0-291" id="h4-0-291" class="i">+                            )
</a><a href="#h4-0-292" id="h4-0-292" class="i">+                            Row(
</a><a href="#h4-0-293" id="h4-0-293" class="i">+                                modifier = Modifier
</a><a href="#h4-0-294" id="h4-0-294" class="i">+                                    .fillMaxWidth()
</a><a href="#h4-0-295" id="h4-0-295" class="i">+                                    .padding(8.dp),
</a><a href="#h4-0-296" id="h4-0-296" class="i">+                                horizontalArrangement = Arrangement.End
</a><a href="#h4-0-297" id="h4-0-297" class="i">+                            ) {
</a><a href="#h4-0-298" id="h4-0-298" class="i">+                                Button(onClick = {
</a><a href="#h4-0-299" id="h4-0-299" class="i">+                                    dateRangeDialog = false
</a><a href="#h4-0-300" id="h4-0-300" class="i">+                                }) {
</a><a href="#h4-0-301" id="h4-0-301" class="i">+                                    Text(&quot;OK&quot;)
</a><a href="#h4-0-302" id="h4-0-302" class="i">+                                }
</a><a href="#h4-0-303" id="h4-0-303" class="i">+                            }
</a><a href="#h4-0-304" id="h4-0-304" class="i">+                        }
</a><a href="#h4-0-305" id="h4-0-305" class="i">+                    }
</a><a href="#h4-0-306" id="h4-0-306" class="i">+                }
</a><a href="#h4-0-307" id="h4-0-307" class="i">+
</a><a href="#h4-0-308" id="h4-0-308" class="i">+                Row(
</a><a href="#h4-0-309" id="h4-0-309" class="i">+                    modifier = Modifier.fillMaxWidth(),
</a><a href="#h4-0-310" id="h4-0-310" class="i">+                    horizontalArrangement = Arrangement.spacedBy(5.dp),
</a><a href="#h4-0-311" id="h4-0-311" class="i">+                    verticalAlignment = Alignment.CenterVertically
</a><a href="#h4-0-312" id="h4-0-312" class="i">+                ) {
</a><a href="#h4-0-313" id="h4-0-313" class="i">+                    Checkbox(checked = sortByFolder, onCheckedChange = { sortByFolder = it })
</a><a href="#h4-0-314" id="h4-0-314" class="i">+                    Text(&quot;Sort by folder&quot;, modifier = Modifier.weight(1f))
</a><a href="#h4-0-315" id="h4-0-315" class="i">+                }
</a><a href="#h4-0-316" id="h4-0-316" class="i">+
</a><a href="#h4-0-317" id="h4-0-317" class="i">+                Row(
</a><a href="#h4-0-318" id="h4-0-318" class="i">+                    modifier = Modifier.fillMaxWidth(),
</a><a href="#h4-0-319" id="h4-0-319" class="i">+                    horizontalArrangement = Arrangement.spacedBy(5.dp),
</a><a href="#h4-0-320" id="h4-0-320" class="i">+                    verticalAlignment = Alignment.CenterVertically
</a><a href="#h4-0-321" id="h4-0-321" class="i">+                ) {
</a><a href="#h4-0-322" id="h4-0-322" class="i">+                    Checkbox(checked = includeMEO, onCheckedChange = { includeMEO = it })
</a><a href="#h4-0-323" id="h4-0-323" class="i">+                    Text(&quot;Include My Eyes Only&quot;, modifier = Modifier.weight(1f))
</a><a href="#h4-0-324" id="h4-0-324" class="i">+                }
</a><a href="#h4-0-325" id="h4-0-325" class="i">+
</a><a href="#h4-0-326" id="h4-0-326" class="i">+                Row(
</a><a href="#h4-0-327" id="h4-0-327" class="i">+                    modifier = Modifier.fillMaxWidth(),
</a><a href="#h4-0-328" id="h4-0-328" class="i">+                    horizontalArrangement = Arrangement.SpaceEvenly,
</a><a href="#h4-0-329" id="h4-0-329" class="i">+                    verticalAlignment = Alignment.CenterVertically
</a><a href="#h4-0-330" id="h4-0-330" class="i">+                ) {
</a><a href="#h4-0-331" id="h4-0-331" class="i">+                    Button(onClick = onDismiss) {
</a><a href="#h4-0-332" id="h4-0-332" class="i">+                        Text(&quot;Cancel&quot;)
</a><a href="#h4-0-333" id="h4-0-333" class="i">+                    }
</a><a href="#h4-0-334" id="h4-0-334" class="i">+                    Button(onClick = {
</a><a href="#h4-0-335" id="h4-0-335" class="i">+                        context.coroutineScope.launch {
</a><a href="#h4-0-336" id="h4-0-336" class="i">+                            exportMemories(
</a><a href="#h4-0-337" id="h4-0-337" class="i">+                                scope = this,
</a><a href="#h4-0-338" id="h4-0-338" class="i">+                                database = database,
</a><a href="#h4-0-339" id="h4-0-339" class="i">+                                timeRange = dateRangePickerState.takeIf { dateRangeFilter }?.let {
</a><a href="#h4-0-340" id="h4-0-340" class="i">+                                    TimeRange(it.selectedStartDateMillis, it.selectedEndDateMillis)
</a><a href="#h4-0-341" id="h4-0-341" class="i">+                                },
</a><a href="#h4-0-342" id="h4-0-342" class="i">+                                folders = sortByFolder,
</a><a href="#h4-0-343" id="h4-0-343" class="i">+                                includeMEO = includeMEO,
</a><a href="#h4-0-344" id="h4-0-344" class="i">+                            ) { progress, failed -&gt;
</a><a href="#h4-0-345" id="h4-0-345" class="i">+                                exportProgress = Pair(progress, failed)
</a><a href="#h4-0-346" id="h4-0-346" class="i">+                            }
</a><a href="#h4-0-347" id="h4-0-347" class="i">+                        }.also { exportJob = it }.invokeOnCompletion {
</a><a href="#h4-0-348" id="h4-0-348" class="i">+                            exportFinished = true
</a><a href="#h4-0-349" id="h4-0-349" class="i">+                        }
</a><a href="#h4-0-350" id="h4-0-350" class="i">+                    }) {
</a><a href="#h4-0-351" id="h4-0-351" class="i">+                        Text(&quot;Export&quot;)
</a><a href="#h4-0-352" id="h4-0-352" class="i">+                    }
</a><a href="#h4-0-353" id="h4-0-353" class="i">+                }
</a><a href="#h4-0-354" id="h4-0-354" class="i">+            }
</a><a href="#h4-0-355" id="h4-0-355" class="i">+
</a><a href="#h4-0-356" id="h4-0-356" class="i">+
</a><a href="#h4-0-357" id="h4-0-357" class="i">+        }
</a><a href="#h4-0-358" id="h4-0-358" class="i">+    }
</a><a href="#h4-0-359" id="h4-0-359" class="i">+
</a><a href="#h4-0-360" id="h4-0-360" class="i">+    override fun run() {
</a><a href="#h4-0-361" id="h4-0-361" class="i">+        context.coroutineScope.launch(Dispatchers.Main) {
</a><a href="#h4-0-362" id="h4-0-362" class="i">+            val database = runCatching {
</a><a href="#h4-0-363" id="h4-0-363" class="i">+                SQLiteDatabase.openDatabase(
</a><a href="#h4-0-364" id="h4-0-364" class="i">+                    context.androidContext.getDatabasePath(&quot;memories.db&quot;),
</a><a href="#h4-0-365" id="h4-0-365" class="i">+                    OpenParams.Builder().build(),
</a><a href="#h4-0-366" id="h4-0-366" class="i">+                )
</a><a href="#h4-0-367" id="h4-0-367" class="i">+            }.getOrNull()
</a><a href="#h4-0-368" id="h4-0-368" class="i">+
</a><a href="#h4-0-369" id="h4-0-369" class="i">+            if (database == null) {
</a><a href="#h4-0-370" id="h4-0-370" class="i">+                context.longToast(&quot;Failed to open memories database&quot;)
</a><a href="#h4-0-371" id="h4-0-371" class="i">+                return@launch
</a><a href="#h4-0-372" id="h4-0-372" class="i">+            }
</a><a href="#h4-0-373" id="h4-0-373" class="i">+
</a><a href="#h4-0-374" id="h4-0-374" class="i">+            createComposeAlertDialog(context.mainActivity!!) { alertDialog -&gt;
</a><a href="#h4-0-375" id="h4-0-375" class="i">+                ExporterDialog(database) { alertDialog.dismiss() }
</a><a href="#h4-0-376" id="h4-0-376" class="i">+            }.apply {
</a><a href="#h4-0-377" id="h4-0-377" class="i">+                setOnDismissListener { database.close() }
</a><a href="#h4-0-378" id="h4-0-378" class="i">+                setCanceledOnTouchOutside(false)
</a><a href="#h4-0-379" id="h4-0-379" class="i">+                show()
</a><a href="#h4-0-380" id="h4-0-380" class="i">+            }
</a><a href="#h4-0-381" id="h4-0-381" class="i">+        }
</a><a href="#h4-0-382" id="h4-0-382" class="i">+    }
</a><a href="#h4-0-383" id="h4-0-383" class="i">+}</a><a href="#h4-0-384" id="h4-0-384" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h5" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/manager/impl/ActionManager.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/manager/impl/ActionManager.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/manager/impl/ActionManager.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/manager/impl/ActionManager.kt</a></b>
<a href="#h5-0" id="h5-0" class="h">@@ -6,6 +6,7 @@ import me.rhunk.snapenhance.core.ModContext
</a> import me.rhunk.snapenhance.core.action.impl.BulkMessagingAction
 import me.rhunk.snapenhance.core.action.impl.CleanCache
 import me.rhunk.snapenhance.core.action.impl.ExportChatMessages
<a href="#h5-0-3" id="h5-0-3" class="i">+import me.rhunk.snapenhance.core.action.impl.ExportMemories
</a> import me.rhunk.snapenhance.core.manager.Manager
 
 class ActionManager(
<a href="#h5-1" id="h5-1" class="h">@@ -17,6 +18,7 @@ class ActionManager(
</a>             EnumAction.CLEAN_CACHE to CleanCache::class,
             EnumAction.EXPORT_CHAT_MESSAGES to ExportChatMessages::class,
             EnumAction.BULK_MESSAGING_ACTION to BulkMessagingAction::class,
<a href="#h5-1-3" id="h5-1-3" class="i">+            EnumAction.EXPORT_MEMORIES to ExportMemories::class,
</a>         ).map {
             it.key to it.value.java.getConstructor().newInstance().apply {
                 this.context = modContext
<a href="#h5-2" id="h5-2" class="h">@@ -29,8 +31,8 @@ class ActionManager(
</a> 
     fun onNewIntent(intent: Intent?) {
         val action = intent?.getStringExtra(EnumAction.ACTION_PARAMETER) ?: return
<a href="#h5-2-3" id="h5-2-3" class="d">-        execute(EnumAction.entries.find { it.key == action } ?: return)
</a>         intent.removeExtra(EnumAction.ACTION_PARAMETER)
<a href="#h5-2-5" id="h5-2-5" class="i">+        execute(EnumAction.entries.find { it.key == action } ?: return)
</a>     }
 
     fun execute(enumAction: EnumAction) {
</pre>
</div>
</body>
</html>
