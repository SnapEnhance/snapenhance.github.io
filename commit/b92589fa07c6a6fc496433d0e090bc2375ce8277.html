<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>feat(scripting): config interface - change onLaunched to onDispose - refactor JSModule extras - SnapEnhance - An Xposed module offering an enhanced Snapchat experience
</title>
<link rel="icon" type="image/svg+xml" href="../../logo.png"/>
<link rel="alternate icon" href="../../favicon.png"/>
<link rel="alternate" type="application/atom+xml" title="SnapEnhance Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="SnapEnhance Atom Feed (tags)" href="../tags.xml" />
<link rel="stylesheet" type="text/css" href="../../style.css" />
<link rel="stylesheet" type="text/css" href="../../fonts.css" />
</head>
<body>
<div id="head"><table><tr><td><a class="logo" href="../../"><img src="../../logo.png" alt="" width="32" height="32" /></a></td><td><strong>SnapEnhance</strong><span class="desc"> - An Xposed module offering an enhanced Snapchat experience
</span>
</td></tr></table>
<p><a href="../about.html">About</a> | <a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/.gitmodules.html">Submodules</a> | <a href="../file/LICENSE.html">License</a></p>
</div>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/b92589fa07c6a6fc496433d0e090bc2375ce8277.html">b92589fa07c6a6fc496433d0e090bc2375ce8277</a>
<b>parent</b> <a href="../commit/baf872791246cd3b3fe9ca3da39082f2c72b047d.html">baf872791246cd3b3fe9ca3da39082f2c72b047d</a>
<b>Author:</b> rhunk &lt;<a href="mailto:101876869+rhunk@users.noreply.github.com">101876869+rhunk@users.noreply.github.com</a>&gt;
<b>Date:</b>   Sat, 14 Oct 2023 12:14:30 +0200

feat(scripting): config interface
- change onLaunched to onDispose
- refactor JSModule extras

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">app/src/main/kotlin/me/rhunk/snapenhance/RemoteSideContext.kt</a></td><td> | </td><td class="num">4</td><td><span class="i">++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">app/src/main/kotlin/me/rhunk/snapenhance/scripting/RemoteScriptManager.kt</a></td><td> | </td><td class="num">67</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">--------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h2">app/src/main/kotlin/me/rhunk/snapenhance/scripting/impl/RemoteManagerIPC.kt</a></td><td> | </td><td class="num">4</td><td><span class="i">++</span><span class="d">--</span></td></tr>
<tr><td class="A">A</td><td><a href="#h3">app/src/main/kotlin/me/rhunk/snapenhance/scripting/impl/RemoteScriptConfig.kt</a></td><td> | </td><td class="num">58</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h4">app/src/main/kotlin/me/rhunk/snapenhance/scripting/impl/ui/InterfaceManager.kt</a></td><td> | </td><td class="num">33</td><td><span class="i">++++++++++++++++++++++</span><span class="d">-----------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h5">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/scripting/ScriptInterface.kt</a></td><td> | </td><td class="num">10</td><td><span class="i">++++++++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h6">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/scripting/ScriptsSection.kt</a></td><td> | </td><td class="num">5</td><td><span class="i">+++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h7">common/src/main/aidl/me/rhunk/snapenhance/bridge/scripting/IScripting.aidl</a></td><td> | </td><td class="num">2</td><td><span class="i">++</span><span class="d"></span></td></tr>
<tr><td class="D">D</td><td><a href="#h8">common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/IPCInterface.kt</a></td><td> | </td><td class="num">18</td><td><span class="i"></span><span class="d">------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h9">common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/JSModule.kt</a></td><td> | </td><td class="num">5</td><td><span class="i">++++</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h10">common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/ScriptRuntime.kt</a></td><td> | </td><td class="num">4</td><td><span class="i">++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h11">common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/impl/ConfigInterface.kt</a></td><td> | </td><td class="num">75</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h12">common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/impl/IPCInterface.kt</a></td><td> | </td><td class="num">18</td><td><span class="i">++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h13">core/src/main/kotlin/me/rhunk/snapenhance/core/scripting/CoreScriptRuntime.kt</a></td><td> | </td><td class="num">44</td><td><span class="i">++++++++++++</span><span class="d">--------------------------------</span></td></tr>
<tr><td class="A">A</td><td><a href="#h14">core/src/main/kotlin/me/rhunk/snapenhance/core/scripting/impl/CoreIPC.kt</a></td><td> | </td><td class="num">33</td><td><span class="i">+++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h15">core/src/main/kotlin/me/rhunk/snapenhance/core/scripting/impl/CoreScriptConfig.kt</a></td><td> | </td><td class="num">32</td><td><span class="i">++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
</table></pre><pre>16 files changed, 324 insertions(+), 88 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/RemoteSideContext.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/RemoteSideContext.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/RemoteSideContext.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/RemoteSideContext.kt</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -14,6 +14,8 @@ import coil.ImageLoader
</a> import coil.decode.VideoFrameDecoder
 import coil.disk.DiskCache
 import coil.memory.MemoryCache
<a href="#h0-0-3" id="h0-0-3" class="i">+import com.google.gson.Gson
</a><a href="#h0-0-4" id="h0-0-4" class="i">+import com.google.gson.GsonBuilder
</a> import kotlinx.coroutines.CoroutineScope
 import kotlinx.coroutines.Dispatchers
 import me.rhunk.snapenhance.bridge.BridgeService
<a href="#h0-1" id="h0-1" class="h">@@ -81,6 +83,8 @@ class RemoteSideContext(
</a>             .components { add(VideoFrameDecoder.Factory()) }.build()
     }
 
<a href="#h0-1-3" id="h0-1-3" class="i">+    val gson: Gson by lazy { GsonBuilder().setPrettyPrinting().create() }
</a><a href="#h0-1-4" id="h0-1-4" class="i">+
</a>     fun reload() {
         log.verbose(&quot;Loading RemoteSideContext&quot;)
         runCatching {
<b>diff --git a/<a id="h1" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/scripting/RemoteScriptManager.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/scripting/RemoteScriptManager.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/scripting/RemoteScriptManager.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/scripting/RemoteScriptManager.kt</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -6,18 +6,20 @@ import me.rhunk.snapenhance.RemoteSideContext
</a> import me.rhunk.snapenhance.bridge.scripting.IPCListener
 import me.rhunk.snapenhance.bridge.scripting.IScripting
 import me.rhunk.snapenhance.common.scripting.ScriptRuntime
<a href="#h1-0-3" id="h1-0-3" class="i">+import me.rhunk.snapenhance.common.scripting.impl.ConfigInterface
</a><a href="#h1-0-4" id="h1-0-4" class="i">+import me.rhunk.snapenhance.common.scripting.impl.ConfigTransactionType
</a> import me.rhunk.snapenhance.common.scripting.type.ModuleInfo
 import me.rhunk.snapenhance.scripting.impl.IPCListeners
 import me.rhunk.snapenhance.scripting.impl.RemoteManagerIPC
<a href="#h1-0-8" id="h1-0-8" class="d">-import me.rhunk.snapenhance.scripting.impl.ui.InterfaceBuilder
</a><a href="#h1-0-9" id="h1-0-9" class="i">+import me.rhunk.snapenhance.scripting.impl.RemoteScriptConfig
</a> import me.rhunk.snapenhance.scripting.impl.ui.InterfaceManager
<a href="#h1-0-11" id="h1-0-11" class="i">+import java.io.File
</a> import java.io.InputStream
 
 class RemoteScriptManager(
<a href="#h1-0-15" id="h1-0-15" class="d">-    private val context: RemoteSideContext,
</a><a href="#h1-0-16" id="h1-0-16" class="i">+    val context: RemoteSideContext,
</a> ) : IScripting.Stub() {
     val runtime = ScriptRuntime(context.androidContext, context.log)
<a href="#h1-0-19" id="h1-0-19" class="d">-    private val userInterfaces = mutableMapOf&lt;String, MutableMap&lt;String, InterfaceBuilder&gt;&gt;()
</a> 
     private val cachedModuleInfo = mutableMapOf&lt;String, ModuleInfo&gt;()
     private val ipcListeners = IPCListeners()
<a href="#h1-1" id="h1-1" class="h">@@ -40,19 +42,15 @@ class RemoteScriptManager(
</a> 
     fun init() {
         runtime.buildModuleObject = { module -&gt;
<a href="#h1-1-3" id="h1-1-3" class="d">-            putConst(&quot;ipc&quot;, this, RemoteManagerIPC(module.moduleInfo, context.log, ipcListeners))
</a><a href="#h1-1-4" id="h1-1-4" class="d">-            putConst(&quot;im&quot;, this, InterfaceManager(module.moduleInfo, context.log) { name, interfaceBuilder -&gt;
</a><a href="#h1-1-5" id="h1-1-5" class="d">-                userInterfaces.getOrPut(module.moduleInfo.name) {
</a><a href="#h1-1-6" id="h1-1-6" class="d">-                    mutableMapOf()
</a><a href="#h1-1-7" id="h1-1-7" class="d">-                }[name] = interfaceBuilder
</a><a href="#h1-1-8" id="h1-1-8" class="d">-            })
</a><a href="#h1-1-9" id="h1-1-9" class="i">+            module.extras[&quot;ipc&quot;] = RemoteManagerIPC(module.moduleInfo, context.log, ipcListeners)
</a><a href="#h1-1-10" id="h1-1-10" class="i">+            module.extras[&quot;im&quot;] = InterfaceManager(module.moduleInfo, context.log)
</a><a href="#h1-1-11" id="h1-1-11" class="i">+            module.extras[&quot;config&quot;] = RemoteScriptConfig(this@RemoteScriptManager, module.moduleInfo, context.log).also {
</a><a href="#h1-1-12" id="h1-1-12" class="i">+                it.load()
</a><a href="#h1-1-13" id="h1-1-13" class="i">+            }
</a>         }
 
         sync()
         enabledScripts.forEach { name -&gt;
<a href="#h1-1-18" id="h1-1-18" class="d">-            if (getModuleDataFolder(name) == null) {
</a><a href="#h1-1-19" id="h1-1-19" class="d">-                context.log.warn(&quot;Module data folder not found for $name&quot;)
</a><a href="#h1-1-20" id="h1-1-20" class="d">-            }
</a>             loadScript(name)
         }
     }
<a href="#h1-2" id="h1-2" class="h">@@ -62,19 +60,17 @@ class RemoteScriptManager(
</a>         runtime.load(name, content)
     }
 
<a href="#h1-2-3" id="h1-2-3" class="d">-    fun getScriptInterface(scriptName: String, interfaceName: String)
</a><a href="#h1-2-4" id="h1-2-4" class="d">-            = userInterfaces[scriptName]?.get(interfaceName)
</a><a href="#h1-2-5" id="h1-2-5" class="d">-
</a><a href="#h1-2-6" id="h1-2-6" class="d">-
</a>     private fun &lt;R&gt; getScriptInputStream(name: String, callback: (InputStream?) -&gt; R): R {
         val file = getScriptsFolder()?.findFile(name) ?: return callback(null)
         return context.androidContext.contentResolver.openInputStream(file.uri)?.use(callback) ?: callback(null)
     }
 
<a href="#h1-2-12" id="h1-2-12" class="d">-    private fun getModuleDataFolder(moduleFileName: String): DocumentFile? {
</a><a href="#h1-2-13" id="h1-2-13" class="d">-        val folderName = moduleFileName.substringBeforeLast(&quot;.js&quot;)
</a><a href="#h1-2-14" id="h1-2-14" class="d">-        val folder = getScriptsFolder() ?: return null
</a><a href="#h1-2-15" id="h1-2-15" class="d">-        return folder.findFile(folderName) ?: folder.createDirectory(folderName)
</a><a href="#h1-2-16" id="h1-2-16" class="i">+    fun getModuleDataFolder(moduleFileName: String): File {
</a><a href="#h1-2-17" id="h1-2-17" class="i">+        return context.androidContext.filesDir.resolve(&quot;modules&quot;).resolve(moduleFileName).also {
</a><a href="#h1-2-18" id="h1-2-18" class="i">+            if (!it.exists()) {
</a><a href="#h1-2-19" id="h1-2-19" class="i">+                it.mkdirs()
</a><a href="#h1-2-20" id="h1-2-20" class="i">+            }
</a><a href="#h1-2-21" id="h1-2-21" class="i">+        }
</a>     }
 
     private fun getScriptsFolder() = runCatching {
<a href="#h1-3" id="h1-3" class="h">@@ -114,4 +110,35 @@ class RemoteScriptManager(
</a>             context.log.error(&quot;Failed to send message for $eventName&quot;, it)
         }
     }
<a href="#h1-3-3" id="h1-3-3" class="i">+
</a><a href="#h1-3-4" id="h1-3-4" class="i">+    override fun configTransaction(
</a><a href="#h1-3-5" id="h1-3-5" class="i">+        module: String?,
</a><a href="#h1-3-6" id="h1-3-6" class="i">+        action: String,
</a><a href="#h1-3-7" id="h1-3-7" class="i">+        key: String?,
</a><a href="#h1-3-8" id="h1-3-8" class="i">+        value: String?,
</a><a href="#h1-3-9" id="h1-3-9" class="i">+        save: Boolean
</a><a href="#h1-3-10" id="h1-3-10" class="i">+    ): String? {
</a><a href="#h1-3-11" id="h1-3-11" class="i">+        val scriptConfig = runtime.getModuleByName(module ?: return null)?.extras?.get(&quot;config&quot;) as? ConfigInterface ?: return null.also {
</a><a href="#h1-3-12" id="h1-3-12" class="i">+            context.log.warn(&quot;Failed to get config interface for $module&quot;)
</a><a href="#h1-3-13" id="h1-3-13" class="i">+        }
</a><a href="#h1-3-14" id="h1-3-14" class="i">+        val transactionType = ConfigTransactionType.fromKey(action)
</a><a href="#h1-3-15" id="h1-3-15" class="i">+
</a><a href="#h1-3-16" id="h1-3-16" class="i">+        return runCatching {
</a><a href="#h1-3-17" id="h1-3-17" class="i">+            scriptConfig.run {
</a><a href="#h1-3-18" id="h1-3-18" class="i">+                if (transactionType == ConfigTransactionType.GET) {
</a><a href="#h1-3-19" id="h1-3-19" class="i">+                    return get(key ?: return@runCatching null, value)
</a><a href="#h1-3-20" id="h1-3-20" class="i">+                }
</a><a href="#h1-3-21" id="h1-3-21" class="i">+                when (transactionType) {
</a><a href="#h1-3-22" id="h1-3-22" class="i">+                    ConfigTransactionType.SET -&gt; set(key ?: return@runCatching null, value, save)
</a><a href="#h1-3-23" id="h1-3-23" class="i">+                    ConfigTransactionType.SAVE -&gt; save()
</a><a href="#h1-3-24" id="h1-3-24" class="i">+                    ConfigTransactionType.LOAD -&gt; load()
</a><a href="#h1-3-25" id="h1-3-25" class="i">+                    ConfigTransactionType.DELETE -&gt; delete()
</a><a href="#h1-3-26" id="h1-3-26" class="i">+                    else -&gt; {}
</a><a href="#h1-3-27" id="h1-3-27" class="i">+                }
</a><a href="#h1-3-28" id="h1-3-28" class="i">+                null
</a><a href="#h1-3-29" id="h1-3-29" class="i">+            }
</a><a href="#h1-3-30" id="h1-3-30" class="i">+        }.onFailure {
</a><a href="#h1-3-31" id="h1-3-31" class="i">+            context.log.error(&quot;Failed to perform config transaction&quot;, it)
</a><a href="#h1-3-32" id="h1-3-32" class="i">+        }.getOrDefault(&quot;&quot;)
</a><a href="#h1-3-33" id="h1-3-33" class="i">+    }
</a> } 
\ No newline at end of file
<b>diff --git a/<a id="h2" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/scripting/impl/RemoteManagerIPC.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/scripting/impl/RemoteManagerIPC.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/scripting/impl/RemoteManagerIPC.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/scripting/impl/RemoteManagerIPC.kt</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -3,8 +3,8 @@ package me.rhunk.snapenhance.scripting.impl
</a> import android.os.DeadObjectException
 import me.rhunk.snapenhance.bridge.scripting.IPCListener
 import me.rhunk.snapenhance.common.logger.AbstractLogger
<a href="#h2-0-3" id="h2-0-3" class="d">-import me.rhunk.snapenhance.common.scripting.IPCInterface
</a><a href="#h2-0-4" id="h2-0-4" class="d">-import me.rhunk.snapenhance.common.scripting.Listener
</a><a href="#h2-0-5" id="h2-0-5" class="i">+import me.rhunk.snapenhance.common.scripting.impl.IPCInterface
</a><a href="#h2-0-6" id="h2-0-6" class="i">+import me.rhunk.snapenhance.common.scripting.impl.Listener
</a> import me.rhunk.snapenhance.common.scripting.type.ModuleInfo
 import java.util.concurrent.ConcurrentHashMap
 
<b>diff --git a/<a id="h3" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/scripting/impl/RemoteScriptConfig.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/scripting/impl/RemoteScriptConfig.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/scripting/impl/RemoteScriptConfig.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/scripting/impl/RemoteScriptConfig.kt</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -0,0 +1,57 @@
</a><a href="#h3-0-0" id="h3-0-0" class="i">+package me.rhunk.snapenhance.scripting.impl
</a><a href="#h3-0-1" id="h3-0-1" class="i">+
</a><a href="#h3-0-2" id="h3-0-2" class="i">+import com.google.gson.JsonObject
</a><a href="#h3-0-3" id="h3-0-3" class="i">+import me.rhunk.snapenhance.common.logger.AbstractLogger
</a><a href="#h3-0-4" id="h3-0-4" class="i">+import me.rhunk.snapenhance.common.scripting.impl.ConfigInterface
</a><a href="#h3-0-5" id="h3-0-5" class="i">+import me.rhunk.snapenhance.common.scripting.type.ModuleInfo
</a><a href="#h3-0-6" id="h3-0-6" class="i">+import me.rhunk.snapenhance.scripting.RemoteScriptManager
</a><a href="#h3-0-7" id="h3-0-7" class="i">+import java.io.File
</a><a href="#h3-0-8" id="h3-0-8" class="i">+
</a><a href="#h3-0-9" id="h3-0-9" class="i">+class RemoteScriptConfig(
</a><a href="#h3-0-10" id="h3-0-10" class="i">+    private val remoteScriptManager: RemoteScriptManager,
</a><a href="#h3-0-11" id="h3-0-11" class="i">+    moduleInfo: ModuleInfo,
</a><a href="#h3-0-12" id="h3-0-12" class="i">+    private val logger: AbstractLogger,
</a><a href="#h3-0-13" id="h3-0-13" class="i">+) : ConfigInterface() {
</a><a href="#h3-0-14" id="h3-0-14" class="i">+    private val configFile = File(remoteScriptManager.getModuleDataFolder(moduleInfo.name), &quot;config.json&quot;)
</a><a href="#h3-0-15" id="h3-0-15" class="i">+    private var config = JsonObject()
</a><a href="#h3-0-16" id="h3-0-16" class="i">+
</a><a href="#h3-0-17" id="h3-0-17" class="i">+    override fun get(key: String, defaultValue: Any?): String? {
</a><a href="#h3-0-18" id="h3-0-18" class="i">+        return config[key]?.asString ?: defaultValue?.toString()
</a><a href="#h3-0-19" id="h3-0-19" class="i">+    }
</a><a href="#h3-0-20" id="h3-0-20" class="i">+
</a><a href="#h3-0-21" id="h3-0-21" class="i">+    override fun set(key: String, value: Any?, save: Boolean) {
</a><a href="#h3-0-22" id="h3-0-22" class="i">+        when (value) {
</a><a href="#h3-0-23" id="h3-0-23" class="i">+            is Int -&gt; config.addProperty(key, value)
</a><a href="#h3-0-24" id="h3-0-24" class="i">+            is Double -&gt; config.addProperty(key, value)
</a><a href="#h3-0-25" id="h3-0-25" class="i">+            is Boolean -&gt; config.addProperty(key, value)
</a><a href="#h3-0-26" id="h3-0-26" class="i">+            is Long -&gt; config.addProperty(key, value)
</a><a href="#h3-0-27" id="h3-0-27" class="i">+            is Float -&gt; config.addProperty(key, value)
</a><a href="#h3-0-28" id="h3-0-28" class="i">+            is Byte -&gt; config.addProperty(key, value)
</a><a href="#h3-0-29" id="h3-0-29" class="i">+            is Short -&gt; config.addProperty(key, value)
</a><a href="#h3-0-30" id="h3-0-30" class="i">+            else -&gt; config.addProperty(key, value?.toString())
</a><a href="#h3-0-31" id="h3-0-31" class="i">+        }
</a><a href="#h3-0-32" id="h3-0-32" class="i">+
</a><a href="#h3-0-33" id="h3-0-33" class="i">+        if (save) save()
</a><a href="#h3-0-34" id="h3-0-34" class="i">+    }
</a><a href="#h3-0-35" id="h3-0-35" class="i">+
</a><a href="#h3-0-36" id="h3-0-36" class="i">+    override fun save() {
</a><a href="#h3-0-37" id="h3-0-37" class="i">+        configFile.writeText(config.toString())
</a><a href="#h3-0-38" id="h3-0-38" class="i">+    }
</a><a href="#h3-0-39" id="h3-0-39" class="i">+
</a><a href="#h3-0-40" id="h3-0-40" class="i">+    override fun load() {
</a><a href="#h3-0-41" id="h3-0-41" class="i">+        runCatching {
</a><a href="#h3-0-42" id="h3-0-42" class="i">+            if (!configFile.exists()) {
</a><a href="#h3-0-43" id="h3-0-43" class="i">+                save()
</a><a href="#h3-0-44" id="h3-0-44" class="i">+                return@runCatching
</a><a href="#h3-0-45" id="h3-0-45" class="i">+            }
</a><a href="#h3-0-46" id="h3-0-46" class="i">+            config = remoteScriptManager.context.gson.fromJson(configFile.readText(), JsonObject::class.java)
</a><a href="#h3-0-47" id="h3-0-47" class="i">+        }.onFailure {
</a><a href="#h3-0-48" id="h3-0-48" class="i">+            logger.error(&quot;Failed to load config file&quot;, it)
</a><a href="#h3-0-49" id="h3-0-49" class="i">+            save()
</a><a href="#h3-0-50" id="h3-0-50" class="i">+        }
</a><a href="#h3-0-51" id="h3-0-51" class="i">+    }
</a><a href="#h3-0-52" id="h3-0-52" class="i">+
</a><a href="#h3-0-53" id="h3-0-53" class="i">+    override fun delete() {
</a><a href="#h3-0-54" id="h3-0-54" class="i">+        configFile.delete()
</a><a href="#h3-0-55" id="h3-0-55" class="i">+    }
</a><a href="#h3-0-56" id="h3-0-56" class="i">+}</a><a href="#h3-0-57" id="h3-0-57" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h4" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/scripting/impl/ui/InterfaceManager.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/scripting/impl/ui/InterfaceManager.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/scripting/impl/ui/InterfaceManager.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/scripting/impl/ui/InterfaceManager.kt</a></b>
<a href="#h4-0" id="h4-0" class="h">@@ -12,15 +12,15 @@ import org.mozilla.javascript.annotations.JSFunction
</a> 
 class InterfaceBuilder {
     val nodes = mutableListOf&lt;Node&gt;()
<a href="#h4-0-3" id="h4-0-3" class="d">-    var onLaunchedCallback: (() -&gt; Unit)? = null
</a><a href="#h4-0-4" id="h4-0-4" class="i">+    var onDisposeCallback: (() -&gt; Unit)? = null
</a> 
 
     private fun createNode(type: NodeType, block: Node.() -&gt; Unit): Node {
         return Node(type).apply(block).also { nodes.add(it) }
     }
 
<a href="#h4-0-11" id="h4-0-11" class="d">-    fun onLaunched(block: () -&gt; Unit) {
</a><a href="#h4-0-12" id="h4-0-12" class="d">-        onLaunchedCallback = block
</a><a href="#h4-0-13" id="h4-0-13" class="i">+    fun onDispose(block: () -&gt; Unit) {
</a><a href="#h4-0-14" id="h4-0-14" class="i">+        onDisposeCallback = block
</a>     }
 
     fun row(block: (InterfaceBuilder) -&gt; Unit) = RowColumnNode(NodeType.ROW).apply {
<a href="#h4-1" id="h4-1" class="h">@@ -66,14 +66,25 @@ class InterfaceBuilder {
</a> 
 class InterfaceManager(
     private val moduleInfo: ModuleInfo,
<a href="#h4-1-3" id="h4-1-3" class="d">-    private val logger: AbstractLogger,
</a><a href="#h4-1-4" id="h4-1-4" class="d">-    private val registerInterface: (String, InterfaceBuilder) -&gt; Unit,
</a><a href="#h4-1-5" id="h4-1-5" class="i">+    private val logger: AbstractLogger
</a> ) {
<a href="#h4-1-7" id="h4-1-7" class="d">-    @JSFunction
</a><a href="#h4-1-8" id="h4-1-8" class="d">-    fun create(name: String, callback: Function) {
</a><a href="#h4-1-9" id="h4-1-9" class="d">-        logger.info(&quot;Creating interface $name for ${moduleInfo.name}&quot;)
</a><a href="#h4-1-10" id="h4-1-10" class="d">-        val interfaceBuilder = InterfaceBuilder()
</a><a href="#h4-1-11" id="h4-1-11" class="d">-        callback.call(Context.getCurrentContext(), callback, callback, arrayOf(interfaceBuilder))
</a><a href="#h4-1-12" id="h4-1-12" class="d">-        registerInterface(name, interfaceBuilder)
</a><a href="#h4-1-13" id="h4-1-13" class="i">+    private val interfaces = mutableMapOf&lt;String, () -&gt; InterfaceBuilder?&gt;()
</a><a href="#h4-1-14" id="h4-1-14" class="i">+
</a><a href="#h4-1-15" id="h4-1-15" class="i">+    fun buildInterface(name: String): InterfaceBuilder? {
</a><a href="#h4-1-16" id="h4-1-16" class="i">+        return interfaces[name]?.invoke()
</a><a href="#h4-1-17" id="h4-1-17" class="i">+    }
</a><a href="#h4-1-18" id="h4-1-18" class="i">+
</a><a href="#h4-1-19" id="h4-1-19" class="i">+    @JSFunction fun create(name: String, callback: Function) {
</a><a href="#h4-1-20" id="h4-1-20" class="i">+        interfaces[name] = {
</a><a href="#h4-1-21" id="h4-1-21" class="i">+            val interfaceBuilder = InterfaceBuilder()
</a><a href="#h4-1-22" id="h4-1-22" class="i">+            runCatching {
</a><a href="#h4-1-23" id="h4-1-23" class="i">+                Context.enter()
</a><a href="#h4-1-24" id="h4-1-24" class="i">+                callback.call(Context.getCurrentContext(), callback, callback, arrayOf(interfaceBuilder))
</a><a href="#h4-1-25" id="h4-1-25" class="i">+                Context.exit()
</a><a href="#h4-1-26" id="h4-1-26" class="i">+                interfaceBuilder
</a><a href="#h4-1-27" id="h4-1-27" class="i">+            }.onFailure {
</a><a href="#h4-1-28" id="h4-1-28" class="i">+                logger.error(&quot;Failed to create interface $name for ${moduleInfo.name}&quot;, it)
</a><a href="#h4-1-29" id="h4-1-29" class="i">+            }.getOrNull()
</a><a href="#h4-1-30" id="h4-1-30" class="i">+        }
</a>     }
 } 
\ No newline at end of file
<b>diff --git a/<a id="h5" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/scripting/ScriptInterface.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/scripting/ScriptInterface.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/scripting/ScriptInterface.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/scripting/ScriptInterface.kt</a></b>
<a href="#h5-0" id="h5-0" class="h">@@ -147,8 +147,14 @@ fun ScriptInterface(interfaceBuilder: InterfaceBuilder) {
</a>             DrawNode(node)
         }
 
<a href="#h5-0-3" id="h5-0-3" class="d">-        LaunchedEffect(interfaceBuilder) {
</a><a href="#h5-0-4" id="h5-0-4" class="d">-            interfaceBuilder.onLaunchedCallback?.invoke()
</a><a href="#h5-0-5" id="h5-0-5" class="i">+        DisposableEffect(Unit) {
</a><a href="#h5-0-6" id="h5-0-6" class="i">+            onDispose {
</a><a href="#h5-0-7" id="h5-0-7" class="i">+                runCatching {
</a><a href="#h5-0-8" id="h5-0-8" class="i">+                    interfaceBuilder.onDisposeCallback?.invoke()
</a><a href="#h5-0-9" id="h5-0-9" class="i">+                }.onFailure {
</a><a href="#h5-0-10" id="h5-0-10" class="i">+                    AbstractLogger.directError(&quot;Error running onDisposed callback&quot;, it)
</a><a href="#h5-0-11" id="h5-0-11" class="i">+                }
</a><a href="#h5-0-12" id="h5-0-12" class="i">+            }
</a>         }
     }
 } 
\ No newline at end of file
<b>diff --git a/<a id="h6" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/scripting/ScriptsSection.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/scripting/ScriptsSection.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/scripting/ScriptsSection.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/scripting/ScriptsSection.kt</a></b>
<a href="#h6-0" id="h6-0" class="h">@@ -14,6 +14,7 @@ import androidx.compose.ui.unit.sp
</a> import kotlinx.coroutines.delay
 import kotlinx.coroutines.launch
 import me.rhunk.snapenhance.common.scripting.type.ModuleInfo
<a href="#h6-0-3" id="h6-0-3" class="i">+import me.rhunk.snapenhance.scripting.impl.ui.InterfaceManager
</a> import me.rhunk.snapenhance.ui.manager.Section
 import me.rhunk.snapenhance.ui.util.pullrefresh.PullRefreshIndicator
 import me.rhunk.snapenhance.ui.util.pullrefresh.pullRefresh
<a href="#h6-1" id="h6-1" class="h">@@ -88,7 +89,8 @@ class ScriptsSection : Section() {
</a>     @Composable
     fun ScriptSettings(script: ModuleInfo) {
         val settingsInterface = remember {
<a href="#h6-1-3" id="h6-1-3" class="d">-            context.scriptManager.getScriptInterface(script.name, &quot;settings&quot;)
</a><a href="#h6-1-4" id="h6-1-4" class="i">+            val module = context.scriptManager.runtime.getModuleByName(script.name) ?: return@remember null
</a><a href="#h6-1-5" id="h6-1-5" class="i">+            (module.extras[&quot;im&quot;] as? InterfaceManager)?.buildInterface(&quot;settings&quot;)
</a>         } ?: run {
             Text(
                 text = &quot;This module does not have any settings&quot;,
<a href="#h6-2" id="h6-2" class="h">@@ -101,7 +103,6 @@ class ScriptsSection : Section() {
</a>         ScriptInterface(interfaceBuilder = settingsInterface)
     }
 
<a href="#h6-2-3" id="h6-2-3" class="d">-
</a>     @Composable
     override fun Content() {
         var scriptModules by remember {
<b>diff --git a/<a id="h7" href="../file/common/src/main/aidl/me/rhunk/snapenhance/bridge/scripting/IScripting.aidl.html">common/src/main/aidl/me/rhunk/snapenhance/bridge/scripting/IScripting.aidl</a> b/<a href="../file/common/src/main/aidl/me/rhunk/snapenhance/bridge/scripting/IScripting.aidl.html">common/src/main/aidl/me/rhunk/snapenhance/bridge/scripting/IScripting.aidl</a></b>
<a href="#h7-0" id="h7-0" class="h">@@ -10,4 +10,6 @@ interface IScripting {
</a>     void registerIPCListener(String channel, String eventName, IPCListener listener);
 
     void sendIPCMessage(String channel, String eventName, in String[] args);
<a href="#h7-0-3" id="h7-0-3" class="i">+
</a><a href="#h7-0-4" id="h7-0-4" class="i">+    @nullable String configTransaction(String module, String action, @nullable String key, @nullable String value, boolean save);
</a> } 
\ No newline at end of file
<b>diff --git a/<a id="h8" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/IPCInterface.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/IPCInterface.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/IPCInterface.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/IPCInterface.kt</a></b>
<a href="#h8-0" id="h8-0" class="h">@@ -1,17 +0,0 @@
</a><a href="#h8-0-0" id="h8-0-0" class="d">-package me.rhunk.snapenhance.common.scripting
</a><a href="#h8-0-1" id="h8-0-1" class="d">-
</a><a href="#h8-0-2" id="h8-0-2" class="d">-typealias Listener = (Array&lt;out String?&gt;) -&gt; Unit
</a><a href="#h8-0-3" id="h8-0-3" class="d">-
</a><a href="#h8-0-4" id="h8-0-4" class="d">-abstract class IPCInterface {
</a><a href="#h8-0-5" id="h8-0-5" class="d">-    abstract fun on(eventName: String, listener: Listener)
</a><a href="#h8-0-6" id="h8-0-6" class="d">-
</a><a href="#h8-0-7" id="h8-0-7" class="d">-    abstract fun onBroadcast(channel: String, eventName: String, listener: Listener)
</a><a href="#h8-0-8" id="h8-0-8" class="d">-
</a><a href="#h8-0-9" id="h8-0-9" class="d">-    abstract fun emit(eventName: String, vararg args: String?)
</a><a href="#h8-0-10" id="h8-0-10" class="d">-    abstract fun broadcast(channel: String, eventName: String, vararg args: String?)
</a><a href="#h8-0-11" id="h8-0-11" class="d">-
</a><a href="#h8-0-12" id="h8-0-12" class="d">-    @Suppress(&quot;unused&quot;)
</a><a href="#h8-0-13" id="h8-0-13" class="d">-    fun emit(eventName: String) = emit(eventName, *emptyArray())
</a><a href="#h8-0-14" id="h8-0-14" class="d">-    @Suppress(&quot;unused&quot;)
</a><a href="#h8-0-15" id="h8-0-15" class="d">-    fun emit(channel: String, eventName: String) = broadcast(channel, eventName)
</a><a href="#h8-0-16" id="h8-0-16" class="d">-}</a><a href="#h8-0-17" id="h8-0-17" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h9" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/JSModule.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/JSModule.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/JSModule.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/JSModule.kt</a></b>
<a href="#h9-0" id="h9-0" class="h">@@ -18,6 +18,7 @@ class JSModule(
</a>     val moduleInfo: ModuleInfo,
     val content: String,
 ) {
<a href="#h9-0-3" id="h9-0-3" class="i">+    val extras = mutableMapOf&lt;String, Any&gt;()
</a>     private lateinit var moduleObject: ScriptableObject
 
     fun load(block: ScriptableObject.() -&gt; Unit) {
<a href="#h9-1" id="h9-1" class="h">@@ -115,8 +116,10 @@ class JSModule(
</a>                     Undefined.instance
                 }
             }
<a href="#h9-1-3" id="h9-1-3" class="d">-
</a>             block(moduleObject)
<a href="#h9-1-5" id="h9-1-5" class="i">+            extras.forEach { (key, value) -&gt;
</a><a href="#h9-1-6" id="h9-1-6" class="i">+                moduleObject.putConst(key, moduleObject, value)
</a><a href="#h9-1-7" id="h9-1-7" class="i">+            }
</a>             evaluateString(moduleObject, content, moduleInfo.name, 1, null)
         }
     }
<b>diff --git a/<a id="h10" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/ScriptRuntime.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/ScriptRuntime.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/ScriptRuntime.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/ScriptRuntime.kt</a></b>
<a href="#h10-0" id="h10-0" class="h">@@ -25,6 +25,10 @@ open class ScriptRuntime(
</a>         }
     }
 
<a href="#h10-0-3" id="h10-0-3" class="i">+    fun getModuleByName(name: String): JSModule? {
</a><a href="#h10-0-4" id="h10-0-4" class="i">+        return modules.values.find { it.moduleInfo.name == name }
</a><a href="#h10-0-5" id="h10-0-5" class="i">+    }
</a><a href="#h10-0-6" id="h10-0-6" class="i">+
</a>     private fun readModuleInfo(reader: BufferedReader): ModuleInfo {
         val header = reader.readLine()
         if (!header.startsWith(&quot;// ==SE_module==&quot;)) {
<b>diff --git a/<a id="h11" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/impl/ConfigInterface.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/impl/ConfigInterface.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/impl/ConfigInterface.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/impl/ConfigInterface.kt</a></b>
<a href="#h11-0" id="h11-0" class="h">@@ -0,0 +1,74 @@
</a><a href="#h11-0-0" id="h11-0-0" class="i">+package me.rhunk.snapenhance.common.scripting.impl
</a><a href="#h11-0-1" id="h11-0-1" class="i">+
</a><a href="#h11-0-2" id="h11-0-2" class="i">+import org.mozilla.javascript.annotations.JSFunction
</a><a href="#h11-0-3" id="h11-0-3" class="i">+
</a><a href="#h11-0-4" id="h11-0-4" class="i">+
</a><a href="#h11-0-5" id="h11-0-5" class="i">+enum class ConfigTransactionType(
</a><a href="#h11-0-6" id="h11-0-6" class="i">+    val key: String
</a><a href="#h11-0-7" id="h11-0-7" class="i">+) {
</a><a href="#h11-0-8" id="h11-0-8" class="i">+    GET(&quot;get&quot;),
</a><a href="#h11-0-9" id="h11-0-9" class="i">+    SET(&quot;set&quot;),
</a><a href="#h11-0-10" id="h11-0-10" class="i">+    SAVE(&quot;save&quot;),
</a><a href="#h11-0-11" id="h11-0-11" class="i">+    LOAD(&quot;load&quot;),
</a><a href="#h11-0-12" id="h11-0-12" class="i">+    DELETE(&quot;delete&quot;);
</a><a href="#h11-0-13" id="h11-0-13" class="i">+
</a><a href="#h11-0-14" id="h11-0-14" class="i">+    companion object {
</a><a href="#h11-0-15" id="h11-0-15" class="i">+        fun fromKey(key: String) = entries.find { it.key == key }
</a><a href="#h11-0-16" id="h11-0-16" class="i">+    }
</a><a href="#h11-0-17" id="h11-0-17" class="i">+}
</a><a href="#h11-0-18" id="h11-0-18" class="i">+
</a><a href="#h11-0-19" id="h11-0-19" class="i">+
</a><a href="#h11-0-20" id="h11-0-20" class="i">+abstract class ConfigInterface {
</a><a href="#h11-0-21" id="h11-0-21" class="i">+    @JSFunction fun get(key: String): String? = get(key, null)
</a><a href="#h11-0-22" id="h11-0-22" class="i">+    @JSFunction abstract fun get(key: String, defaultValue: Any?): String?
</a><a href="#h11-0-23" id="h11-0-23" class="i">+
</a><a href="#h11-0-24" id="h11-0-24" class="i">+    @JSFunction fun getInteger(key: String): Int? = getInteger(key, null)
</a><a href="#h11-0-25" id="h11-0-25" class="i">+    @JSFunction fun getInteger(key: String, defaultValue: Int?): Int? = get(key, defaultValue.toString())?.toIntOrNull() ?: defaultValue
</a><a href="#h11-0-26" id="h11-0-26" class="i">+
</a><a href="#h11-0-27" id="h11-0-27" class="i">+    @JSFunction fun getDouble(key: String): Double? = getDouble(key, null)
</a><a href="#h11-0-28" id="h11-0-28" class="i">+    @JSFunction fun getDouble(key: String, defaultValue: Double?): Double? = get(key, defaultValue.toString())?.toDoubleOrNull() ?: defaultValue
</a><a href="#h11-0-29" id="h11-0-29" class="i">+
</a><a href="#h11-0-30" id="h11-0-30" class="i">+    @JSFunction fun getBoolean(key: String): Boolean? = getBoolean(key, null)
</a><a href="#h11-0-31" id="h11-0-31" class="i">+    @JSFunction fun getBoolean(key: String, defaultValue: Boolean?): Boolean? = get(key, defaultValue.toString())?.toBoolean() ?: defaultValue
</a><a href="#h11-0-32" id="h11-0-32" class="i">+
</a><a href="#h11-0-33" id="h11-0-33" class="i">+    @JSFunction fun getLong(key: String): Long? = getLong(key, null)
</a><a href="#h11-0-34" id="h11-0-34" class="i">+    @JSFunction fun getLong(key: String, defaultValue: Long?): Long? = get(key, defaultValue.toString())?.toLongOrNull() ?: defaultValue
</a><a href="#h11-0-35" id="h11-0-35" class="i">+
</a><a href="#h11-0-36" id="h11-0-36" class="i">+    @JSFunction fun getFloat(key: String): Float? = getFloat(key, null)
</a><a href="#h11-0-37" id="h11-0-37" class="i">+    @JSFunction fun getFloat(key: String, defaultValue: Float?): Float? = get(key, defaultValue.toString())?.toFloatOrNull() ?: defaultValue
</a><a href="#h11-0-38" id="h11-0-38" class="i">+
</a><a href="#h11-0-39" id="h11-0-39" class="i">+    @JSFunction fun getByte(key: String): Byte? = getByte(key, null)
</a><a href="#h11-0-40" id="h11-0-40" class="i">+    @JSFunction fun getByte(key: String, defaultValue: Byte?): Byte? = get(key, defaultValue.toString())?.toByteOrNull() ?: defaultValue
</a><a href="#h11-0-41" id="h11-0-41" class="i">+
</a><a href="#h11-0-42" id="h11-0-42" class="i">+    @JSFunction fun getShort(key: String): Short? = getShort(key, null)
</a><a href="#h11-0-43" id="h11-0-43" class="i">+    @JSFunction fun getShort(key: String, defaultValue: Short?): Short? = get(key, defaultValue.toString())?.toShortOrNull() ?: defaultValue
</a><a href="#h11-0-44" id="h11-0-44" class="i">+
</a><a href="#h11-0-45" id="h11-0-45" class="i">+
</a><a href="#h11-0-46" id="h11-0-46" class="i">+    @JSFunction fun set(key: String, value: Any?) = set(key, value, false)
</a><a href="#h11-0-47" id="h11-0-47" class="i">+    @JSFunction abstract fun set(key: String, value: Any?, save: Boolean)
</a><a href="#h11-0-48" id="h11-0-48" class="i">+
</a><a href="#h11-0-49" id="h11-0-49" class="i">+    @JSFunction fun setInteger(key: String, value: Int?) = setInteger(key, value, false)
</a><a href="#h11-0-50" id="h11-0-50" class="i">+    @JSFunction fun setInteger(key: String, value: Int?, save: Boolean) = set(key, value, save)
</a><a href="#h11-0-51" id="h11-0-51" class="i">+
</a><a href="#h11-0-52" id="h11-0-52" class="i">+    @JSFunction fun setDouble(key: String, value: Double?) = setDouble(key, value, false)
</a><a href="#h11-0-53" id="h11-0-53" class="i">+    @JSFunction fun setDouble(key: String, value: Double?, save: Boolean) = set(key, value, save)
</a><a href="#h11-0-54" id="h11-0-54" class="i">+
</a><a href="#h11-0-55" id="h11-0-55" class="i">+    @JSFunction fun setBoolean(key: String, value: Boolean?) = setBoolean(key, value, false)
</a><a href="#h11-0-56" id="h11-0-56" class="i">+    @JSFunction fun setBoolean(key: String, value: Boolean?, save: Boolean) = set(key, value, save)
</a><a href="#h11-0-57" id="h11-0-57" class="i">+
</a><a href="#h11-0-58" id="h11-0-58" class="i">+    @JSFunction fun setLong(key: String, value: Long?) = setLong(key, value, false)
</a><a href="#h11-0-59" id="h11-0-59" class="i">+    @JSFunction fun setLong(key: String, value: Long?, save: Boolean) = set(key, value, save)
</a><a href="#h11-0-60" id="h11-0-60" class="i">+
</a><a href="#h11-0-61" id="h11-0-61" class="i">+    @JSFunction fun setFloat(key: String, value: Float?) = setFloat(key, value, false)
</a><a href="#h11-0-62" id="h11-0-62" class="i">+    @JSFunction fun setFloat(key: String, value: Float?, save: Boolean) = set(key, value, save)
</a><a href="#h11-0-63" id="h11-0-63" class="i">+
</a><a href="#h11-0-64" id="h11-0-64" class="i">+    @JSFunction fun setByte(key: String, value: Byte?) = setByte(key, value, false)
</a><a href="#h11-0-65" id="h11-0-65" class="i">+    @JSFunction fun setByte(key: String, value: Byte?, save: Boolean) = set(key, value, save)
</a><a href="#h11-0-66" id="h11-0-66" class="i">+
</a><a href="#h11-0-67" id="h11-0-67" class="i">+    @JSFunction fun setShort(key: String, value: Short?) = setShort(key, value, false)
</a><a href="#h11-0-68" id="h11-0-68" class="i">+    @JSFunction fun setShort(key: String, value: Short?, save: Boolean) = set(key, value, save)
</a><a href="#h11-0-69" id="h11-0-69" class="i">+
</a><a href="#h11-0-70" id="h11-0-70" class="i">+    @JSFunction abstract fun save()
</a><a href="#h11-0-71" id="h11-0-71" class="i">+    @JSFunction abstract fun load()
</a><a href="#h11-0-72" id="h11-0-72" class="i">+    @JSFunction abstract fun delete()
</a><a href="#h11-0-73" id="h11-0-73" class="i">+}</a><a href="#h11-0-74" id="h11-0-74" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h12" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/impl/IPCInterface.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/impl/IPCInterface.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/impl/IPCInterface.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/impl/IPCInterface.kt</a></b>
<a href="#h12-0" id="h12-0" class="h">@@ -0,0 +1,17 @@
</a><a href="#h12-0-0" id="h12-0-0" class="i">+package me.rhunk.snapenhance.common.scripting.impl
</a><a href="#h12-0-1" id="h12-0-1" class="i">+
</a><a href="#h12-0-2" id="h12-0-2" class="i">+typealias Listener = (Array&lt;out String?&gt;) -&gt; Unit
</a><a href="#h12-0-3" id="h12-0-3" class="i">+
</a><a href="#h12-0-4" id="h12-0-4" class="i">+abstract class IPCInterface {
</a><a href="#h12-0-5" id="h12-0-5" class="i">+    abstract fun on(eventName: String, listener: Listener)
</a><a href="#h12-0-6" id="h12-0-6" class="i">+
</a><a href="#h12-0-7" id="h12-0-7" class="i">+    abstract fun onBroadcast(channel: String, eventName: String, listener: Listener)
</a><a href="#h12-0-8" id="h12-0-8" class="i">+
</a><a href="#h12-0-9" id="h12-0-9" class="i">+    abstract fun emit(eventName: String, vararg args: String?)
</a><a href="#h12-0-10" id="h12-0-10" class="i">+    abstract fun broadcast(channel: String, eventName: String, vararg args: String?)
</a><a href="#h12-0-11" id="h12-0-11" class="i">+
</a><a href="#h12-0-12" id="h12-0-12" class="i">+    @Suppress(&quot;unused&quot;)
</a><a href="#h12-0-13" id="h12-0-13" class="i">+    fun emit(eventName: String) = emit(eventName, *emptyArray())
</a><a href="#h12-0-14" id="h12-0-14" class="i">+    @Suppress(&quot;unused&quot;)
</a><a href="#h12-0-15" id="h12-0-15" class="i">+    fun emit(channel: String, eventName: String) = broadcast(channel, eventName)
</a><a href="#h12-0-16" id="h12-0-16" class="i">+}</a><a href="#h12-0-17" id="h12-0-17" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h13" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/scripting/CoreScriptRuntime.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/scripting/CoreScriptRuntime.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/scripting/CoreScriptRuntime.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/scripting/CoreScriptRuntime.kt</a></b>
<a href="#h13-0" id="h13-0" class="h">@@ -1,12 +1,11 @@
</a> package me.rhunk.snapenhance.core.scripting
 
 import android.content.Context
<a href="#h13-0-3" id="h13-0-3" class="d">-import me.rhunk.snapenhance.bridge.scripting.IPCListener
</a> import me.rhunk.snapenhance.bridge.scripting.IScripting
 import me.rhunk.snapenhance.common.logger.AbstractLogger
<a href="#h13-0-6" id="h13-0-6" class="d">-import me.rhunk.snapenhance.common.scripting.IPCInterface
</a><a href="#h13-0-7" id="h13-0-7" class="d">-import me.rhunk.snapenhance.common.scripting.Listener
</a> import me.rhunk.snapenhance.common.scripting.ScriptRuntime
<a href="#h13-0-9" id="h13-0-9" class="i">+import me.rhunk.snapenhance.core.scripting.impl.CoreIPC
</a><a href="#h13-0-10" id="h13-0-10" class="i">+import me.rhunk.snapenhance.core.scripting.impl.CoreScriptConfig
</a> import me.rhunk.snapenhance.core.scripting.impl.ScriptHooker
 
 class CoreScriptRuntime(
<a href="#h13-1" id="h13-1" class="h">@@ -18,38 +17,19 @@ class CoreScriptRuntime(
</a>     fun connect(scriptingInterface: IScripting) {
         scriptingInterface.apply {
             buildModuleObject = { module -&gt;
<a href="#h13-1-3" id="h13-1-3" class="d">-                putConst(&quot;ipc&quot;, this, object: IPCInterface() {
</a><a href="#h13-1-4" id="h13-1-4" class="d">-                    override fun onBroadcast(channel: String, eventName: String, listener: Listener) {
</a><a href="#h13-1-5" id="h13-1-5" class="d">-                        registerIPCListener(channel, eventName, object: IPCListener.Stub() {
</a><a href="#h13-1-6" id="h13-1-6" class="d">-                            override fun onMessage(args: Array&lt;out String?&gt;) {
</a><a href="#h13-1-7" id="h13-1-7" class="d">-                                listener(args)
</a><a href="#h13-1-8" id="h13-1-8" class="d">-                            }
</a><a href="#h13-1-9" id="h13-1-9" class="d">-                        })
</a><a href="#h13-1-10" id="h13-1-10" class="d">-                    }
</a><a href="#h13-1-11" id="h13-1-11" class="d">-
</a><a href="#h13-1-12" id="h13-1-12" class="d">-                    override fun on(eventName: String, listener: Listener) {
</a><a href="#h13-1-13" id="h13-1-13" class="d">-                        onBroadcast(module.moduleInfo.name, eventName, listener)
</a><a href="#h13-1-14" id="h13-1-14" class="d">-                    }
</a><a href="#h13-1-15" id="h13-1-15" class="d">-
</a><a href="#h13-1-16" id="h13-1-16" class="d">-                    override fun emit(eventName: String, vararg args: String?) {
</a><a href="#h13-1-17" id="h13-1-17" class="d">-                        broadcast(module.moduleInfo.name, eventName, *args)
</a><a href="#h13-1-18" id="h13-1-18" class="d">-                    }
</a><a href="#h13-1-19" id="h13-1-19" class="d">-
</a><a href="#h13-1-20" id="h13-1-20" class="d">-                    override fun broadcast(channel: String, eventName: String, vararg args: String?) {
</a><a href="#h13-1-21" id="h13-1-21" class="d">-                        sendIPCMessage(channel, eventName, args)
</a><a href="#h13-1-22" id="h13-1-22" class="d">-                    }
</a><a href="#h13-1-23" id="h13-1-23" class="d">-                })
</a><a href="#h13-1-24" id="h13-1-24" class="d">-                putConst(&quot;hooker&quot;, this, ScriptHooker(module.moduleInfo, logger, androidContext.classLoader).also {
</a><a href="#h13-1-25" id="h13-1-25" class="i">+                module.extras[&quot;ipc&quot;] = CoreIPC(this@apply, module.moduleInfo)
</a><a href="#h13-1-26" id="h13-1-26" class="i">+                module.extras[&quot;hooker&quot;] = ScriptHooker(module.moduleInfo, logger, androidContext.classLoader).also {
</a>                     scriptHookers.add(it)
<a href="#h13-1-28" id="h13-1-28" class="d">-                })
</a><a href="#h13-1-29" id="h13-1-29" class="i">+                }
</a><a href="#h13-1-30" id="h13-1-30" class="i">+                module.extras[&quot;config&quot;] = CoreScriptConfig(this@apply, module.moduleInfo)
</a>             }
<a href="#h13-1-32" id="h13-1-32" class="d">-        }
</a> 
<a href="#h13-1-34" id="h13-1-34" class="d">-        scriptingInterface.enabledScripts.forEach { path -&gt;
</a><a href="#h13-1-35" id="h13-1-35" class="d">-            runCatching {
</a><a href="#h13-1-36" id="h13-1-36" class="d">-                load(path, scriptingInterface.getScriptContent(path))
</a><a href="#h13-1-37" id="h13-1-37" class="d">-            }.onFailure {
</a><a href="#h13-1-38" id="h13-1-38" class="d">-                logger.error(&quot;Failed to load script $path&quot;, it)
</a><a href="#h13-1-39" id="h13-1-39" class="i">+            enabledScripts.forEach { path -&gt;
</a><a href="#h13-1-40" id="h13-1-40" class="i">+                runCatching {
</a><a href="#h13-1-41" id="h13-1-41" class="i">+                    load(path, scriptingInterface.getScriptContent(path))
</a><a href="#h13-1-42" id="h13-1-42" class="i">+                }.onFailure {
</a><a href="#h13-1-43" id="h13-1-43" class="i">+                    logger.error(&quot;Failed to load script $path&quot;, it)
</a><a href="#h13-1-44" id="h13-1-44" class="i">+                }
</a>             }
         }
     }
<b>diff --git a/<a id="h14" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/scripting/impl/CoreIPC.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/scripting/impl/CoreIPC.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/scripting/impl/CoreIPC.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/scripting/impl/CoreIPC.kt</a></b>
<a href="#h14-0" id="h14-0" class="h">@@ -0,0 +1,32 @@
</a><a href="#h14-0-0" id="h14-0-0" class="i">+package me.rhunk.snapenhance.core.scripting.impl
</a><a href="#h14-0-1" id="h14-0-1" class="i">+
</a><a href="#h14-0-2" id="h14-0-2" class="i">+import me.rhunk.snapenhance.bridge.scripting.IPCListener
</a><a href="#h14-0-3" id="h14-0-3" class="i">+import me.rhunk.snapenhance.bridge.scripting.IScripting
</a><a href="#h14-0-4" id="h14-0-4" class="i">+import me.rhunk.snapenhance.common.scripting.impl.IPCInterface
</a><a href="#h14-0-5" id="h14-0-5" class="i">+import me.rhunk.snapenhance.common.scripting.impl.Listener
</a><a href="#h14-0-6" id="h14-0-6" class="i">+import me.rhunk.snapenhance.common.scripting.type.ModuleInfo
</a><a href="#h14-0-7" id="h14-0-7" class="i">+
</a><a href="#h14-0-8" id="h14-0-8" class="i">+class CoreIPC(
</a><a href="#h14-0-9" id="h14-0-9" class="i">+    private val scripting: IScripting,
</a><a href="#h14-0-10" id="h14-0-10" class="i">+    private val moduleInfo: ModuleInfo
</a><a href="#h14-0-11" id="h14-0-11" class="i">+) : IPCInterface() {
</a><a href="#h14-0-12" id="h14-0-12" class="i">+    override fun onBroadcast(channel: String, eventName: String, listener: Listener) {
</a><a href="#h14-0-13" id="h14-0-13" class="i">+        scripting.registerIPCListener(channel, eventName, object: IPCListener.Stub() {
</a><a href="#h14-0-14" id="h14-0-14" class="i">+            override fun onMessage(args: Array&lt;out String?&gt;) {
</a><a href="#h14-0-15" id="h14-0-15" class="i">+                listener(args)
</a><a href="#h14-0-16" id="h14-0-16" class="i">+            }
</a><a href="#h14-0-17" id="h14-0-17" class="i">+        })
</a><a href="#h14-0-18" id="h14-0-18" class="i">+    }
</a><a href="#h14-0-19" id="h14-0-19" class="i">+
</a><a href="#h14-0-20" id="h14-0-20" class="i">+    override fun on(eventName: String, listener: Listener) {
</a><a href="#h14-0-21" id="h14-0-21" class="i">+        onBroadcast(moduleInfo.name, eventName, listener)
</a><a href="#h14-0-22" id="h14-0-22" class="i">+    }
</a><a href="#h14-0-23" id="h14-0-23" class="i">+
</a><a href="#h14-0-24" id="h14-0-24" class="i">+    override fun emit(eventName: String, vararg args: String?) {
</a><a href="#h14-0-25" id="h14-0-25" class="i">+        broadcast(moduleInfo.name, eventName, *args)
</a><a href="#h14-0-26" id="h14-0-26" class="i">+    }
</a><a href="#h14-0-27" id="h14-0-27" class="i">+
</a><a href="#h14-0-28" id="h14-0-28" class="i">+    override fun broadcast(channel: String, eventName: String, vararg args: String?) {
</a><a href="#h14-0-29" id="h14-0-29" class="i">+        scripting.sendIPCMessage(channel, eventName, args)
</a><a href="#h14-0-30" id="h14-0-30" class="i">+    }
</a><a href="#h14-0-31" id="h14-0-31" class="i">+}</a><a href="#h14-0-32" id="h14-0-32" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h15" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/scripting/impl/CoreScriptConfig.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/scripting/impl/CoreScriptConfig.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/scripting/impl/CoreScriptConfig.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/scripting/impl/CoreScriptConfig.kt</a></b>
<a href="#h15-0" id="h15-0" class="h">@@ -0,0 +1,31 @@
</a><a href="#h15-0-0" id="h15-0-0" class="i">+package me.rhunk.snapenhance.core.scripting.impl
</a><a href="#h15-0-1" id="h15-0-1" class="i">+
</a><a href="#h15-0-2" id="h15-0-2" class="i">+import me.rhunk.snapenhance.bridge.scripting.IScripting
</a><a href="#h15-0-3" id="h15-0-3" class="i">+import me.rhunk.snapenhance.common.scripting.impl.ConfigInterface
</a><a href="#h15-0-4" id="h15-0-4" class="i">+import me.rhunk.snapenhance.common.scripting.impl.ConfigTransactionType
</a><a href="#h15-0-5" id="h15-0-5" class="i">+import me.rhunk.snapenhance.common.scripting.type.ModuleInfo
</a><a href="#h15-0-6" id="h15-0-6" class="i">+
</a><a href="#h15-0-7" id="h15-0-7" class="i">+class CoreScriptConfig(
</a><a href="#h15-0-8" id="h15-0-8" class="i">+    private val scripting: IScripting,
</a><a href="#h15-0-9" id="h15-0-9" class="i">+    private val moduleInfo: ModuleInfo
</a><a href="#h15-0-10" id="h15-0-10" class="i">+): ConfigInterface() {
</a><a href="#h15-0-11" id="h15-0-11" class="i">+    override fun get(key: String, defaultValue: Any?): String? {
</a><a href="#h15-0-12" id="h15-0-12" class="i">+        return scripting.configTransaction(moduleInfo.name, ConfigTransactionType.GET.key, key, defaultValue.toString(), false)
</a><a href="#h15-0-13" id="h15-0-13" class="i">+    }
</a><a href="#h15-0-14" id="h15-0-14" class="i">+
</a><a href="#h15-0-15" id="h15-0-15" class="i">+    override fun set(key: String, value: Any?, save: Boolean) {
</a><a href="#h15-0-16" id="h15-0-16" class="i">+        scripting.configTransaction(moduleInfo.name, ConfigTransactionType.SET.key, key, value.toString(), save)
</a><a href="#h15-0-17" id="h15-0-17" class="i">+    }
</a><a href="#h15-0-18" id="h15-0-18" class="i">+
</a><a href="#h15-0-19" id="h15-0-19" class="i">+    override fun save() {
</a><a href="#h15-0-20" id="h15-0-20" class="i">+        scripting.configTransaction(moduleInfo.name, ConfigTransactionType.SAVE.key, null, null, false)
</a><a href="#h15-0-21" id="h15-0-21" class="i">+    }
</a><a href="#h15-0-22" id="h15-0-22" class="i">+
</a><a href="#h15-0-23" id="h15-0-23" class="i">+    override fun load() {
</a><a href="#h15-0-24" id="h15-0-24" class="i">+        scripting.configTransaction(moduleInfo.name, ConfigTransactionType.LOAD.key, null, null, false)
</a><a href="#h15-0-25" id="h15-0-25" class="i">+    }
</a><a href="#h15-0-26" id="h15-0-26" class="i">+
</a><a href="#h15-0-27" id="h15-0-27" class="i">+    override fun delete() {
</a><a href="#h15-0-28" id="h15-0-28" class="i">+        scripting.configTransaction(moduleInfo.name, ConfigTransactionType.DELETE.key, null, null, false)
</a><a href="#h15-0-29" id="h15-0-29" class="i">+    }
</a><a href="#h15-0-30" id="h15-0-30" class="i">+}</a><a href="#h15-0-31" id="h15-0-31" class="i">+
\ No newline at end of file
</a></pre>
</div>
</body>
</html>
