<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>refactor: translations (#78) - SnapEnhance - An Xposed module offering an enhanced Snapchat experience
</title>
<link rel="icon" type="image/svg+xml" href="../../logo.png"/>
<link rel="alternate icon" href="../../favicon.png"/>
<link rel="alternate" type="application/atom+xml" title="SnapEnhance Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="SnapEnhance Atom Feed (tags)" href="../tags.xml" />
<link rel="stylesheet" type="text/css" href="../../style.css" />
<link rel="stylesheet" type="text/css" href="../../fonts.css" />
</head>
<body>
<div id="head"><table><tr><td><a class="logo" href="../../"><img src="../../logo.png" alt="" width="32" height="32" /></a></td><td><strong>SnapEnhance</strong><span class="desc"> - An Xposed module offering an enhanced Snapchat experience
</span>
</td></tr></table>
<p><a href="../about.html">About</a> | <a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/.gitmodules.html">Submodules</a> | <a href="../file/LICENSE.html">License</a></p>
</div>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/cc59f9d060b685eda27ccb013673dc016270a906.html">cc59f9d060b685eda27ccb013673dc016270a906</a>
<b>parent</b> <a href="../commit/65cbf79dce99d689fcbe0244045d559353450b24.html">65cbf79dce99d689fcbe0244045d559353450b24</a>
<b>Author:</b> auth &lt;<a href="mailto:64337177+authorisation@users.noreply.github.com">64337177+authorisation@users.noreply.github.com</a>&gt;
<b>Date:</b>   Wed, 21 Jun 2023 19:41:36 +0200

refactor: translations (#78)

* ui changes

* fix more stuff

* fix: set ffmpeg preset to ultrafast

* refactor: ui tweaks
getIdentifier function

* feat: download manager filter

* add placeholder bitmoji

* change bitmoji blank color

* add settings page (not done)

* setting page impl

* confirmation dialog

* update theme

* remove snap context buttons

* fix: delete cache

* fix: bitmoji icon

* fix: french translation

* translation refactor

* translation: download manager

* refactor: get operator

* refactor: config properties

* add translation for download manager receiver

* fix: steak expire translation format

---------

Co-authored-by: rhunk &lt;101876869+rhunk@users.noreply.github.com&gt;
<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">app/src/main/AndroidManifest.xml</a></td><td> | </td><td class="num">4</td><td><span class="i">++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">app/src/main/assets/lang/en_US.json</a></td><td> | </td><td class="num">41</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h2">app/src/main/assets/lang/fr_FR.json</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h3">app/src/main/kotlin/me/rhunk/snapenhance/ModContext.kt</a></td><td> | </td><td class="num">9</td><td><span class="i">+++++++</span><span class="d">--</span></td></tr>
<tr><td class="A">A</td><td><a href="#h4">app/src/main/kotlin/me/rhunk/snapenhance/SharedContext.kt</a></td><td> | </td><td class="num">27</td><td><span class="i">+++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h5">app/src/main/kotlin/me/rhunk/snapenhance/SnapEnhance.kt</a></td><td> | </td><td class="num">25</td><td><span class="i">+++++++++++++++++++</span><span class="d">------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h6">app/src/main/kotlin/me/rhunk/snapenhance/action/impl/CheckForUpdates.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h7">app/src/main/kotlin/me/rhunk/snapenhance/action/impl/ExportChatMessages.kt</a></td><td> | </td><td class="num">34</td><td><span class="i">++++++++++++++++++</span><span class="d">----------------</span></td></tr>
<tr><td class="A">A</td><td><a href="#h8">app/src/main/kotlin/me/rhunk/snapenhance/bridge/TranslationWrapper.kt</a></td><td> | </td><td class="num">97</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h9">app/src/main/kotlin/me/rhunk/snapenhance/bridge/client/RootBridgeClient.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h10">app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/impl/locale/LocaleResult.kt</a></td><td> | </td><td class="num">24</td><td><span class="i">++++++++++++++++++</span><span class="d">------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h11">app/src/main/kotlin/me/rhunk/snapenhance/bridge/service/BridgeService.kt</a></td><td> | </td><td class="num">12</td><td><span class="i">++++++++</span><span class="d">----</span></td></tr>
<tr><td class="D">D</td><td><a href="#h12">app/src/main/kotlin/me/rhunk/snapenhance/bridge/service/MainActivity.kt</a></td><td> | </td><td class="num">17</td><td><span class="i"></span><span class="d">-----------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h13">app/src/main/kotlin/me/rhunk/snapenhance/config/ConfigProperty.kt</a></td><td> | </td><td class="num">144</td><td><span class="i">++++++++++++++++++++++++++++</span><span class="d">---------------------------------------------------</span></td></tr>
<tr><td class="A">A</td><td><a href="#h14">app/src/main/kotlin/me/rhunk/snapenhance/data/LocalePair.kt</a></td><td> | </td><td class="num">4</td><td><span class="i">++++</span><span class="d"></span></td></tr>
<tr><td class="D">D</td><td><a href="#h15">app/src/main/kotlin/me/rhunk/snapenhance/download/ClientDownloadManager.kt</a></td><td> | </td><td class="num">83</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="A">A</td><td><a href="#h16">app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadManagerClient.kt</a></td><td> | </td><td class="num">83</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h17">app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadManagerReceiver.kt</a></td><td> | </td><td class="num">337</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="D">D</td><td><a href="#h18">app/src/main/kotlin/me/rhunk/snapenhance/download/MediaDownloadReceiver.kt</a></td><td> | </td><td class="num">330</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h19">app/src/main/kotlin/me/rhunk/snapenhance/download/data/PendingDownload.kt</a></td><td> | </td><td class="num">4</td><td><span class="i">++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h20">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/AutoUpdater.kt</a></td><td> | </td><td class="num">16</td><td><span class="i">++++++++</span><span class="d">--------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h21">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/MediaDownloader.kt</a></td><td> | </td><td class="num">12</td><td><span class="i">++++++</span><span class="d">------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h22">app/src/main/kotlin/me/rhunk/snapenhance/manager/impl/FeatureManager.kt</a></td><td> | </td><td class="num">3</td><td><span class="i">+</span><span class="d">--</span></td></tr>
<tr><td class="D">D</td><td><a href="#h23">app/src/main/kotlin/me/rhunk/snapenhance/manager/impl/TranslationManager.kt</a></td><td> | </td><td class="num">44</td><td><span class="i"></span><span class="d">--------------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h24">app/src/main/kotlin/me/rhunk/snapenhance/ui/download/DownloadListAdapter.kt</a></td><td> | </td><td class="num">22</td><td><span class="i">+++++++++++</span><span class="d">-----------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h25">app/src/main/kotlin/me/rhunk/snapenhance/ui/download/DownloadManagerActivity.kt</a></td><td> | </td><td class="num">43</td><td><span class="i">++++++++++++++++++++++++</span><span class="d">-------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h26">app/src/main/kotlin/me/rhunk/snapenhance/ui/download/SettingLayoutInflater.kt</a></td><td> | </td><td class="num">27</td><td><span class="i">+++++++++++++++++</span><span class="d">----------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h27">app/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/ChatActionMenu.kt</a></td><td> | </td><td class="num">6</td><td><span class="i">+++</span><span class="d">---</span></td></tr>
<tr><td class="M">M</td><td><a href="#h28">app/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/FriendFeedInfoMenu.kt</a></td><td> | </td><td class="num">34</td><td><span class="i">++++++++++++++++++</span><span class="d">----------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h29">app/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/OperaContextActionMenu.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h30">app/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/SettingsMenu.kt</a></td><td> | </td><td class="num">12</td><td><span class="i">++++++</span><span class="d">------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h31">app/src/main/res/layout/download_manager_activity.xml</a></td><td> | </td><td class="num">16</td><td><span class="i">++++++++</span><span class="d">--------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h32">app/src/main/res/layout/download_manager_item.xml</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h33">app/src/main/res/layout/settings_page.xml</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h34">app/src/main/res/values/strings.xml</a></td><td> | </td><td class="num">12</td><td><span class="i"></span><span class="d">------------</span></td></tr>
</table></pre><pre>35 files changed, 821 insertions(+), 713 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/app/src/main/AndroidManifest.xml.html">app/src/main/AndroidManifest.xml</a> b/<a href="../file/app/src/main/AndroidManifest.xml.html">app/src/main/AndroidManifest.xml</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -34,10 +34,10 @@
</a>             tools:ignore=&quot;ExportedService&quot;&gt;
         &lt;/service&gt;
 
<a href="#h0-0-3" id="h0-0-3" class="d">-        &lt;receiver android:name=&quot;.download.MediaDownloadReceiver&quot; android:exported=&quot;true&quot;
</a><a href="#h0-0-4" id="h0-0-4" class="i">+        &lt;receiver android:name=&quot;.download.DownloadManagerReceiver&quot; android:exported=&quot;true&quot;
</a>             tools:ignore=&quot;ExportedReceiver&quot;&gt;
             &lt;intent-filter&gt;
<a href="#h0-0-7" id="h0-0-7" class="d">-                &lt;action android:name=&quot;me.rhunk.snapenhance.download.MediaDownloadReceiver.DOWNLOAD_ACTION&quot; /&gt;
</a><a href="#h0-0-8" id="h0-0-8" class="i">+                &lt;action android:name=&quot;me.rhunk.snapenhance.download.DownloadManagerReceiver.DOWNLOAD_ACTION&quot; /&gt;
</a>             &lt;/intent-filter&gt;
         &lt;/receiver&gt;
 
<b>diff --git a/<a id="h1" href="../file/app/src/main/assets/lang/en_US.json.html">app/src/main/assets/lang/en_US.json</a> b/<a href="../file/app/src/main/assets/lang/en_US.json.html">app/src/main/assets/lang/en_US.json</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -161,7 +161,7 @@
</a>     },
 
     &quot;conversation_preview&quot;: {
<a href="#h1-0-3" id="h1-0-3" class="d">-        &quot;streak_expiration&quot;: &quot;expires in %s days %s hours %s minutes&quot;,
</a><a href="#h1-0-4" id="h1-0-4" class="i">+        &quot;streak_expiration&quot;: &quot;expires in {day} days {hour} hours {minute} minutes&quot;,
</a>         &quot;title&quot;: &quot;Preview&quot;,
         &quot;unknown_user&quot;: &quot;Unknown User&quot;
     },
<a href="#h1-1" id="h1-1" class="h">@@ -199,5 +199,44 @@
</a>         &quot;finished&quot;: &quot;Done! You now can close this dialog.&quot;,
         &quot;no_messages_found&quot;: &quot;No messages found!&quot;,
         &quot;exporting_message&quot;: &quot;Exporting {conversation}...&quot;
<a href="#h1-1-3" id="h1-1-3" class="i">+    },
</a><a href="#h1-1-4" id="h1-1-4" class="i">+
</a><a href="#h1-1-5" id="h1-1-5" class="i">+    &quot;download_manager_activity&quot;: {
</a><a href="#h1-1-6" id="h1-1-6" class="i">+        &quot;remove_all_title&quot;: &quot;Remove all Downloads&quot;,
</a><a href="#h1-1-7" id="h1-1-7" class="i">+        &quot;remove_all_text&quot;: &quot;Are you sure you want to do this?&quot;,
</a><a href="#h1-1-8" id="h1-1-8" class="i">+        &quot;remove_all&quot;: &quot;Remove All&quot;,
</a><a href="#h1-1-9" id="h1-1-9" class="i">+        &quot;no_downloads&quot;: &quot;No downloads&quot;,
</a><a href="#h1-1-10" id="h1-1-10" class="i">+        &quot;cancel&quot;: &quot;Cancel&quot;,
</a><a href="#h1-1-11" id="h1-1-11" class="i">+        &quot;file_not_found_toast&quot;: &quot;File does not exist!&quot;,
</a><a href="#h1-1-12" id="h1-1-12" class="i">+        &quot;category&quot;: {
</a><a href="#h1-1-13" id="h1-1-13" class="i">+            &quot;all_category&quot;: &quot;All&quot;,
</a><a href="#h1-1-14" id="h1-1-14" class="i">+            &quot;pending_category&quot;: &quot;Pending&quot;,
</a><a href="#h1-1-15" id="h1-1-15" class="i">+            &quot;snap_category&quot;: &quot;Snaps&quot;,
</a><a href="#h1-1-16" id="h1-1-16" class="i">+            &quot;story_category&quot;: &quot;Stories&quot;,
</a><a href="#h1-1-17" id="h1-1-17" class="i">+            &quot;spotlight_category&quot;: &quot;Spotlight&quot;
</a><a href="#h1-1-18" id="h1-1-18" class="i">+        },
</a><a href="#h1-1-19" id="h1-1-19" class="i">+        &quot;settings&quot;: &quot;Settings&quot;,
</a><a href="#h1-1-20" id="h1-1-20" class="i">+        &quot;button&quot;: {
</a><a href="#h1-1-21" id="h1-1-21" class="i">+            &quot;positive&quot;: &quot;Yes&quot;,
</a><a href="#h1-1-22" id="h1-1-22" class="i">+            &quot;negative&quot;: &quot;No&quot;,
</a><a href="#h1-1-23" id="h1-1-23" class="i">+            &quot;cancel&quot;: &quot;Cancel&quot;,
</a><a href="#h1-1-24" id="h1-1-24" class="i">+            &quot;open&quot;: &quot;Open&quot;
</a><a href="#h1-1-25" id="h1-1-25" class="i">+        },
</a><a href="#h1-1-26" id="h1-1-26" class="i">+        &quot;settings_page&quot;: {
</a><a href="#h1-1-27" id="h1-1-27" class="i">+            &quot;clear_file_title&quot;: &quot;Clear {file_name} file&quot;,
</a><a href="#h1-1-28" id="h1-1-28" class="i">+            &quot;clear_file_confirmation&quot;: &quot;Are you sure you want to clear the {file_name} file?&quot;,
</a><a href="#h1-1-29" id="h1-1-29" class="i">+            &quot;clear_cache_title&quot;: &quot;Clear Cache&quot;,
</a><a href="#h1-1-30" id="h1-1-30" class="i">+            &quot;reset_all_title&quot;: &quot;Reset all settings&quot;,
</a><a href="#h1-1-31" id="h1-1-31" class="i">+            &quot;reset_all_confirmation&quot;: &quot;Are you sure you want to reset all settings?&quot;,
</a><a href="#h1-1-32" id="h1-1-32" class="i">+            &quot;success_toast&quot;: &quot;Success!&quot;
</a><a href="#h1-1-33" id="h1-1-33" class="i">+        }
</a><a href="#h1-1-34" id="h1-1-34" class="i">+    },
</a><a href="#h1-1-35" id="h1-1-35" class="i">+    &quot;download_manager_receiver&quot;: {
</a><a href="#h1-1-36" id="h1-1-36" class="i">+        &quot;saved_toast&quot;: &quot;Saved to {path}&quot;,
</a><a href="#h1-1-37" id="h1-1-37" class="i">+        &quot;download_toast&quot;: &quot;Downloading {path}...&quot;,
</a><a href="#h1-1-38" id="h1-1-38" class="i">+        &quot;processing_toast&quot;: &quot;Processing {path}...&quot;,
</a><a href="#h1-1-39" id="h1-1-39" class="i">+        &quot;failed_generic_toast&quot;: &quot;Failed to download&quot;,
</a><a href="#h1-1-40" id="h1-1-40" class="i">+        &quot;failed_processing_toast&quot;: &quot;Failed to process {error}&quot;,
</a><a href="#h1-1-41" id="h1-1-41" class="i">+        &quot;failed_gallery_toast&quot;: &quot;Failed to save to gallery {error}&quot;
</a>     }
 } 
\ No newline at end of file
<b>diff --git a/<a id="h2" href="../file/app/src/main/assets/lang/fr_FR.json.html">app/src/main/assets/lang/fr_FR.json</a> b/<a href="../file/app/src/main/assets/lang/fr_FR.json.html">app/src/main/assets/lang/fr_FR.json</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -159,7 +159,7 @@
</a>         &quot;username&quot;: &quot;Nom d&#39;utilisateur&quot;,
         &quot;display_name&quot;: &quot;Nom d&#39;affichage&quot;,
         &quot;added_date&quot;: &quot;Date d&#39;ajout&quot;,
<a href="#h2-0-3" id="h2-0-3" class="d">-        &quot;birthday&quot;: &quot;Anniversaire : {month} {day}&quot;
</a><a href="#h2-0-4" id="h2-0-4" class="i">+        &quot;birthday&quot;: &quot;Anniversaire : {day} {month}&quot;
</a>     },
     &quot;auto_updater&quot;: {
         &quot;no_update_available&quot;: &quot;Aucune mise Ã  jour disponible !&quot;,
<b>diff --git a/<a id="h3" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ModContext.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ModContext.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ModContext.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ModContext.kt</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -10,7 +10,9 @@ import android.os.Process
</a> import android.widget.Toast
 import com.google.gson.Gson
 import com.google.gson.GsonBuilder
<a href="#h3-0-3" id="h3-0-3" class="i">+import kotlinx.coroutines.asCoroutineDispatcher
</a> import me.rhunk.snapenhance.bridge.AbstractBridgeClient
<a href="#h3-0-5" id="h3-0-5" class="i">+import me.rhunk.snapenhance.bridge.TranslationWrapper
</a> import me.rhunk.snapenhance.data.MessageSender
 import me.rhunk.snapenhance.database.DatabaseAccess
 import me.rhunk.snapenhance.features.Feature
<a href="#h3-1" id="h3-1" class="h">@@ -18,7 +20,6 @@ import me.rhunk.snapenhance.manager.impl.ActionManager
</a> import me.rhunk.snapenhance.manager.impl.ConfigManager
 import me.rhunk.snapenhance.manager.impl.FeatureManager
 import me.rhunk.snapenhance.manager.impl.MappingManager
<a href="#h3-1-3" id="h3-1-3" class="d">-import me.rhunk.snapenhance.manager.impl.TranslationManager
</a> import me.rhunk.snapenhance.util.download.DownloadServer
 import java.util.concurrent.ExecutorService
 import java.util.concurrent.Executors
<a href="#h3-2" id="h3-2" class="h">@@ -28,13 +29,17 @@ import kotlin.system.exitProcess
</a> class ModContext {
     private val executorService: ExecutorService = Executors.newCachedThreadPool()
 
<a href="#h3-2-3" id="h3-2-3" class="i">+    val coroutineDispatcher by lazy {
</a><a href="#h3-2-4" id="h3-2-4" class="i">+        executorService.asCoroutineDispatcher()
</a><a href="#h3-2-5" id="h3-2-5" class="i">+    }
</a><a href="#h3-2-6" id="h3-2-6" class="i">+
</a>     lateinit var androidContext: Context
     var mainActivity: Activity? = null
     lateinit var bridgeClient: AbstractBridgeClient
 
     val gson: Gson = GsonBuilder().create()
 
<a href="#h3-2-13" id="h3-2-13" class="d">-    val translation = TranslationManager(this)
</a><a href="#h3-2-14" id="h3-2-14" class="i">+    val translation = TranslationWrapper()
</a>     val features = FeatureManager(this)
     val mappings = MappingManager(this)
     val config = ConfigManager(this)
<b>diff --git a/<a id="h4" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/SharedContext.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/SharedContext.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/SharedContext.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/SharedContext.kt</a></b>
<a href="#h4-0" id="h4-0" class="h">@@ -0,0 +1,26 @@
</a><a href="#h4-0-0" id="h4-0-0" class="i">+package me.rhunk.snapenhance
</a><a href="#h4-0-1" id="h4-0-1" class="i">+
</a><a href="#h4-0-2" id="h4-0-2" class="i">+import android.content.Context
</a><a href="#h4-0-3" id="h4-0-3" class="i">+import me.rhunk.snapenhance.bridge.TranslationWrapper
</a><a href="#h4-0-4" id="h4-0-4" class="i">+import me.rhunk.snapenhance.download.DownloadTaskManager
</a><a href="#h4-0-5" id="h4-0-5" class="i">+
</a><a href="#h4-0-6" id="h4-0-6" class="i">+/**
</a><a href="#h4-0-7" id="h4-0-7" class="i">+ * Used to store objects between activities and receivers
</a><a href="#h4-0-8" id="h4-0-8" class="i">+ */
</a><a href="#h4-0-9" id="h4-0-9" class="i">+object SharedContext {
</a><a href="#h4-0-10" id="h4-0-10" class="i">+    lateinit var downloadTaskManager: DownloadTaskManager
</a><a href="#h4-0-11" id="h4-0-11" class="i">+    lateinit var translation: TranslationWrapper
</a><a href="#h4-0-12" id="h4-0-12" class="i">+
</a><a href="#h4-0-13" id="h4-0-13" class="i">+    fun ensureInitialized(context: Context) {
</a><a href="#h4-0-14" id="h4-0-14" class="i">+        if (!this::downloadTaskManager.isInitialized) {
</a><a href="#h4-0-15" id="h4-0-15" class="i">+            downloadTaskManager = DownloadTaskManager().apply {
</a><a href="#h4-0-16" id="h4-0-16" class="i">+                init(context)
</a><a href="#h4-0-17" id="h4-0-17" class="i">+            }
</a><a href="#h4-0-18" id="h4-0-18" class="i">+        }
</a><a href="#h4-0-19" id="h4-0-19" class="i">+        if (!this::translation.isInitialized) {
</a><a href="#h4-0-20" id="h4-0-20" class="i">+            translation = TranslationWrapper().apply {
</a><a href="#h4-0-21" id="h4-0-21" class="i">+                loadFromContext(context)
</a><a href="#h4-0-22" id="h4-0-22" class="i">+            }
</a><a href="#h4-0-23" id="h4-0-23" class="i">+        }
</a><a href="#h4-0-24" id="h4-0-24" class="i">+    }
</a><a href="#h4-0-25" id="h4-0-25" class="i">+}</a><a href="#h4-0-26" id="h4-0-26" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h5" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/SnapEnhance.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/SnapEnhance.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/SnapEnhance.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/SnapEnhance.kt</a></b>
<a href="#h5-0" id="h5-0" class="h">@@ -5,6 +5,8 @@ import android.app.Activity
</a> import android.app.Application
 import android.content.Context
 import android.os.Build
<a href="#h5-0-3" id="h5-0-3" class="i">+import kotlinx.coroutines.runBlocking
</a><a href="#h5-0-4" id="h5-0-4" class="i">+import kotlinx.coroutines.withContext
</a> import me.rhunk.snapenhance.bridge.AbstractBridgeClient
 import me.rhunk.snapenhance.bridge.client.RootBridgeClient
 import me.rhunk.snapenhance.bridge.client.ServiceBridgeClient
<a href="#h5-1" id="h5-1" class="h">@@ -39,7 +41,9 @@ class SnapEnhance {
</a>                         return@start
                     }
                     runCatching {
<a href="#h5-1-3" id="h5-1-3" class="d">-                        init()
</a><a href="#h5-1-4" id="h5-1-4" class="i">+                        runBlocking {
</a><a href="#h5-1-5" id="h5-1-5" class="i">+                            init()
</a><a href="#h5-1-6" id="h5-1-6" class="i">+                        }
</a>                     }.onFailure {
                         Logger.xposedLog(&quot;Failed to initialize&quot;, it)
                     }
<a href="#h5-2" id="h5-2" class="h">@@ -67,10 +71,14 @@ class SnapEnhance {
</a>     }
 
     @OptIn(ExperimentalTime::class)
<a href="#h5-2-3" id="h5-2-3" class="d">-    private fun init() {
</a><a href="#h5-2-4" id="h5-2-4" class="i">+    private suspend fun init() {
</a><a href="#h5-2-5" id="h5-2-5" class="i">+        //load translations in a coroutine to speed up initialization
</a><a href="#h5-2-6" id="h5-2-6" class="i">+        withContext(appContext.coroutineDispatcher) {
</a><a href="#h5-2-7" id="h5-2-7" class="i">+            appContext.translation.loadFromBridge(appContext.bridgeClient)
</a><a href="#h5-2-8" id="h5-2-8" class="i">+        }
</a><a href="#h5-2-9" id="h5-2-9" class="i">+
</a>         measureTime {
             with(appContext) {
<a href="#h5-2-12" id="h5-2-12" class="d">-                translation.init()
</a>                 config.init()
                 mappings.init()
                 //if mappings aren&#39;t loaded, we can&#39;t initialize features
<a href="#h5-3" id="h5-3" class="h">@@ -82,10 +90,15 @@ class SnapEnhance {
</a>         }
     }
 
<a href="#h5-3-3" id="h5-3-3" class="i">+    @OptIn(ExperimentalTime::class)
</a>     private fun onActivityCreate() {
<a href="#h5-3-5" id="h5-3-5" class="d">-        with(appContext) {
</a><a href="#h5-3-6" id="h5-3-6" class="d">-            features.onActivityCreate()
</a><a href="#h5-3-7" id="h5-3-7" class="d">-            actionManager.init()
</a><a href="#h5-3-8" id="h5-3-8" class="i">+        measureTime {
</a><a href="#h5-3-9" id="h5-3-9" class="i">+            with(appContext) {
</a><a href="#h5-3-10" id="h5-3-10" class="i">+                features.onActivityCreate()
</a><a href="#h5-3-11" id="h5-3-11" class="i">+                actionManager.init()
</a><a href="#h5-3-12" id="h5-3-12" class="i">+            }
</a><a href="#h5-3-13" id="h5-3-13" class="i">+        }.also { time -&gt;
</a><a href="#h5-3-14" id="h5-3-14" class="i">+            Logger.debug(&quot;onActivityCreate in $time&quot;)
</a>         }
     }
 } 
\ No newline at end of file
<b>diff --git a/<a id="h6" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/action/impl/CheckForUpdates.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/action/impl/CheckForUpdates.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/action/impl/CheckForUpdates.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/action/impl/CheckForUpdates.kt</a></b>
<a href="#h6-0" id="h6-0" class="h">@@ -10,7 +10,7 @@ class CheckForUpdates : AbstractAction(&quot;action.check_for_updates&quot;, dependsOnProp
</a>             runCatching {
                 val latestVersion = context.feature(AutoUpdater::class).checkForUpdates()
                 if (latestVersion == null) {
<a href="#h6-0-3" id="h6-0-3" class="d">-                    context.longToast(context.translation.get(&quot;auto_updater.no_update_available&quot;))
</a><a href="#h6-0-4" id="h6-0-4" class="i">+                    context.longToast(context.translation[&quot;auto_updater.no_update_available&quot;])
</a>                 }
             }.onFailure {
                 context.longToast(it.message ?: &quot;Failed to check for updates&quot;)
<b>diff --git a/<a id="h7" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/action/impl/ExportChatMessages.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/action/impl/ExportChatMessages.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/action/impl/ExportChatMessages.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/action/impl/ExportChatMessages.kt</a></b>
<a href="#h7-0" id="h7-0" class="h">@@ -62,7 +62,7 @@ class ExportChatMessages : AbstractAction(&quot;action.export_chat_messages&quot;) {
</a>     private suspend fun askExportType() = suspendCancellableCoroutine { cont -&gt;
         context.runOnUiThread {
             AlertDialog.Builder(context.mainActivity)
<a href="#h7-0-3" id="h7-0-3" class="d">-                .setTitle(context.translation.get(&quot;chat_export.select_export_format&quot;))
</a><a href="#h7-0-4" id="h7-0-4" class="i">+                .setTitle(context.translation[&quot;chat_export.select_export_format&quot;])
</a>                 .setItems(ExportFormat.values().map { it.name }.toTypedArray()) { _, which -&gt;
                     cont.resumeWith(Result.success(ExportFormat.values()[which]))
                 }
<a href="#h7-1" id="h7-1" class="h">@@ -83,7 +83,7 @@ class ExportChatMessages : AbstractAction(&quot;action.export_chat_messages&quot;) {
</a>                 ContentType.STICKER
             )
             AlertDialog.Builder(context.mainActivity)
<a href="#h7-1-3" id="h7-1-3" class="d">-                .setTitle(context.translation.get(&quot;chat_export.select_media_type&quot;))
</a><a href="#h7-1-4" id="h7-1-4" class="i">+                .setTitle(context.translation[&quot;chat_export.select_media_type&quot;])
</a>                 .setMultiChoiceItems(contentTypes.map { it.name }.toTypedArray(), BooleanArray(contentTypes.size) { false }) { _, which, isChecked -&gt;
                     val media = contentTypes[which]
                     if (isChecked) {
<a href="#h7-2" id="h7-2" class="h">@@ -111,7 +111,7 @@ class ExportChatMessages : AbstractAction(&quot;action.export_chat_messages&quot;) {
</a>             val selectedConversations = mutableListOf&lt;FriendFeedInfo&gt;()
 
             AlertDialog.Builder(context.mainActivity)
<a href="#h7-2-3" id="h7-2-3" class="d">-                .setTitle(context.translation.get(&quot;chat_export.select_conversation&quot;))
</a><a href="#h7-2-4" id="h7-2-4" class="i">+                .setTitle(context.translation[&quot;chat_export.select_conversation&quot;])
</a>                 .setMultiChoiceItems(
                     friendFeedEntries.map { it.feedDisplayName ?: it.friendDisplayName!!.split(&quot;|&quot;).firstOrNull() }.toTypedArray(),
                     BooleanArray(friendFeedEntries.size) { false }
<a href="#h7-3" id="h7-3" class="h">@@ -122,13 +122,13 @@ class ExportChatMessages : AbstractAction(&quot;action.export_chat_messages&quot;) {
</a>                         selectedConversations.remove(friendFeedEntries[which])
                     }
                 }
<a href="#h7-3-3" id="h7-3-3" class="d">-                .setNegativeButton(context.translation.get(&quot;chat_export.dialog_negative_button&quot;)) { dialog, _ -&gt;
</a><a href="#h7-3-4" id="h7-3-4" class="i">+                .setNegativeButton(context.translation[&quot;chat_export.dialog_negative_button&quot;]) { dialog, _ -&gt;
</a>                     dialog.dismiss()
                 }
<a href="#h7-3-7" id="h7-3-7" class="d">-                .setNeutralButton(context.translation.get(&quot;chat_export.dialog_neutral_button&quot;)) { _, _ -&gt;
</a><a href="#h7-3-8" id="h7-3-8" class="i">+                .setNeutralButton(context.translation[&quot;chat_export.dialog_neutral_button&quot;]) { _, _ -&gt;
</a>                     exportChatForConversations(friendFeedEntries)
                 }
<a href="#h7-3-11" id="h7-3-11" class="d">-                .setPositiveButton(context.translation.get(&quot;chat_export.dialog_positive_button&quot;)) { _, _ -&gt;
</a><a href="#h7-3-12" id="h7-3-12" class="i">+                .setPositiveButton(context.translation[&quot;chat_export.dialog_positive_button&quot;]) { _, _ -&gt;
</a>                     exportChatForConversations(selectedConversations)
                 }
                 .show()
<a href="#h7-4" id="h7-4" class="h">@@ -188,11 +188,11 @@ class ExportChatMessages : AbstractAction(&quot;action.export_chat_messages&quot;) {
</a> 
         conversationAction(true, conversationId, if (friendFeedInfo.feedDisplayName != null) &quot;USERCREATEDGROUP&quot; else &quot;ONEONONE&quot;)
         
<a href="#h7-4-3" id="h7-4-3" class="d">-        logDialog(context.translation.get(&quot;chat_export.exporting_message&quot;).replace(&quot;{conversation}&quot;, conversationName))
</a><a href="#h7-4-4" id="h7-4-4" class="i">+        logDialog(context.translation.format(&quot;chat_export.exporting_message&quot;, &quot;conversation&quot; to conversationName))
</a> 
         val foundMessages = fetchMessagesPaginated(conversationId, Long.MAX_VALUE).toMutableList()
         var lastMessageId = foundMessages.firstOrNull()?.messageDescriptor?.messageId ?: run {
<a href="#h7-4-8" id="h7-4-8" class="d">-            logDialog(context.translation.get(&quot;chat_export.no_messages_found&quot;))
</a><a href="#h7-4-9" id="h7-4-9" class="i">+            logDialog(context.translation[&quot;chat_export.no_messages_found&quot;])
</a>             return
         }
 
<a href="#h7-5" id="h7-5" class="h">@@ -211,7 +211,7 @@ class ExportChatMessages : AbstractAction(&quot;action.export_chat_messages&quot;) {
</a>             &quot;SnapEnhance/conversation_${conversationName}_${System.currentTimeMillis()}.${exportType!!.extension}&quot;
         ).also { it.parentFile?.mkdirs() }
 
<a href="#h7-5-3" id="h7-5-3" class="d">-        logDialog(context.translation.get(&quot;chat_export.writing_output&quot;))
</a><a href="#h7-5-4" id="h7-5-4" class="i">+        logDialog(context.translation[&quot;chat_export.writing_output&quot;])
</a>         MessageExporter(
             context = context,
             friendFeedInfo = friendFeedInfo,
<a href="#h7-6" id="h7-6" class="h">@@ -222,14 +222,16 @@ class ExportChatMessages : AbstractAction(&quot;action.export_chat_messages&quot;) {
</a>             runCatching {
                 it.readMessages(foundMessages)
             }.onFailure {
<a href="#h7-6-3" id="h7-6-3" class="d">-                logDialog(context.translation.get(&quot;chat_export.export_failed&quot;).replace(&quot;{conversation}&quot;, it.message.toString()))
</a><a href="#h7-6-4" id="h7-6-4" class="i">+                logDialog(context.translation.format(&quot;chat_export.export_failed&quot;,&quot;conversation&quot; to it.message.toString()))
</a>                 Logger.error(it)
                 return
             }
         }.exportTo(exportType!!)
 
         dialogLogs.clear()
<a href="#h7-6-11" id="h7-6-11" class="d">-        logDialog(&quot;\n&quot; + context.translation.get(&quot;chat_export.exported_to&quot;).replace(&quot;{path}&quot;, outputFile.absolutePath.toString()) + &quot;\n&quot;)
</a><a href="#h7-6-12" id="h7-6-12" class="i">+        logDialog(&quot;\n&quot; + context.translation.format(&quot;chat_export.exported_to&quot;,
</a><a href="#h7-6-13" id="h7-6-13" class="i">+            &quot;path&quot; to outputFile.absolutePath.toString()
</a><a href="#h7-6-14" id="h7-6-14" class="i">+        ) + &quot;\n&quot;)
</a> 
         currentActionDialog?.setButton(DialogInterface.BUTTON_POSITIVE, &quot;Open&quot;) { _, _ -&gt;
             val intent = Intent(Intent.ACTION_VIEW)
<a href="#h7-7" id="h7-7" class="h">@@ -247,16 +249,16 @@ class ExportChatMessages : AbstractAction(&quot;action.export_chat_messages&quot;) {
</a>         val jobs = mutableListOf&lt;Job&gt;()
 
         currentActionDialog = AlertDialog.Builder(context.mainActivity)
<a href="#h7-7-3" id="h7-7-3" class="d">-            .setTitle(context.translation.get(&quot;chat_export.exporting_chats&quot;))
</a><a href="#h7-7-4" id="h7-7-4" class="i">+            .setTitle(context.translation[&quot;chat_export.exporting_chats&quot;])
</a>             .setCancelable(false)
             .setMessage(&quot;&quot;)
<a href="#h7-7-7" id="h7-7-7" class="d">-            .setNegativeButton(context.translation.get(&quot;chat_export.dialog_negative_button&quot;)) { dialog, _ -&gt;
</a><a href="#h7-7-8" id="h7-7-8" class="i">+            .setNegativeButton(context.translation[&quot;chat_export.dialog_negative_button&quot;]) { dialog, _ -&gt;
</a>                 jobs.forEach { it.cancel() }
                 dialog.dismiss()
             }
             .create()
         
<a href="#h7-7-14" id="h7-7-14" class="d">-        val conversationSize = context.translation.get(&quot;chat_export.processing_chats&quot;).replace(&quot;{amount}&quot;, conversations.size.toString())
</a><a href="#h7-7-15" id="h7-7-15" class="i">+        val conversationSize = context.translation.format(&quot;chat_export.processing_chats&quot;, &quot;amount&quot; to conversations.size.toString())
</a>         
         logDialog(conversationSize)
 
<a href="#h7-8" id="h7-8" class="h">@@ -268,14 +270,14 @@ class ExportChatMessages : AbstractAction(&quot;action.export_chat_messages&quot;) {
</a>                     runCatching {
                         exportFullConversation(conversation)
                     }.onFailure {
<a href="#h7-8-3" id="h7-8-3" class="d">-                        logDialog(context.translation.get(&quot;chat_export.export_fail&quot;).replace(&quot;{conversation}&quot;, conversation.key.toString()))
</a><a href="#h7-8-4" id="h7-8-4" class="i">+                        logDialog(context.translation.format(&quot;chat_export.export_fail&quot;, &quot;conversation&quot; to conversation.key.toString()))
</a>                         logDialog(it.stackTraceToString())
                         Logger.xposedLog(it)
                     }
                 }.also { jobs.add(it) }
             }
             jobs.joinAll()
<a href="#h7-8-11" id="h7-8-11" class="d">-            logDialog(context.translation.get(&quot;chat_export.finished&quot;))
</a><a href="#h7-8-12" id="h7-8-12" class="i">+            logDialog(context.translation[&quot;chat_export.finished&quot;])
</a>         }
     }
 } 
\ No newline at end of file
<b>diff --git a/<a id="h8" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/TranslationWrapper.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/TranslationWrapper.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/TranslationWrapper.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/TranslationWrapper.kt</a></b>
<a href="#h8-0" id="h8-0" class="h">@@ -0,0 +1,96 @@
</a><a href="#h8-0-0" id="h8-0-0" class="i">+package me.rhunk.snapenhance.bridge
</a><a href="#h8-0-1" id="h8-0-1" class="i">+
</a><a href="#h8-0-2" id="h8-0-2" class="i">+import android.content.Context
</a><a href="#h8-0-3" id="h8-0-3" class="i">+import com.google.gson.JsonObject
</a><a href="#h8-0-4" id="h8-0-4" class="i">+import com.google.gson.JsonParser
</a><a href="#h8-0-5" id="h8-0-5" class="i">+import me.rhunk.snapenhance.Logger
</a><a href="#h8-0-6" id="h8-0-6" class="i">+import me.rhunk.snapenhance.data.LocalePair
</a><a href="#h8-0-7" id="h8-0-7" class="i">+import java.util.Locale
</a><a href="#h8-0-8" id="h8-0-8" class="i">+
</a><a href="#h8-0-9" id="h8-0-9" class="i">+
</a><a href="#h8-0-10" id="h8-0-10" class="i">+class TranslationWrapper {
</a><a href="#h8-0-11" id="h8-0-11" class="i">+    companion object {
</a><a href="#h8-0-12" id="h8-0-12" class="i">+        private const val DEFAULT_LOCALE = &quot;en_US&quot;
</a><a href="#h8-0-13" id="h8-0-13" class="i">+
</a><a href="#h8-0-14" id="h8-0-14" class="i">+        fun fetchLocales(context: Context): List&lt;LocalePair&gt; {
</a><a href="#h8-0-15" id="h8-0-15" class="i">+            val deviceLocale = Locale.getDefault().toString()
</a><a href="#h8-0-16" id="h8-0-16" class="i">+            val locales = mutableListOf&lt;LocalePair&gt;()
</a><a href="#h8-0-17" id="h8-0-17" class="i">+
</a><a href="#h8-0-18" id="h8-0-18" class="i">+            locales.add(LocalePair(DEFAULT_LOCALE, context.resources.assets.open(&quot;lang/$DEFAULT_LOCALE.json&quot;).bufferedReader().use { it.readText() }))
</a><a href="#h8-0-19" id="h8-0-19" class="i">+
</a><a href="#h8-0-20" id="h8-0-20" class="i">+            if (deviceLocale == DEFAULT_LOCALE) return locales
</a><a href="#h8-0-21" id="h8-0-21" class="i">+
</a><a href="#h8-0-22" id="h8-0-22" class="i">+            val compatibleLocale = context.resources.assets.list(&quot;lang&quot;)?.firstOrNull { it.startsWith(deviceLocale) }?.substring(0, 5) ?: return locales
</a><a href="#h8-0-23" id="h8-0-23" class="i">+
</a><a href="#h8-0-24" id="h8-0-24" class="i">+            context.resources.assets.open(&quot;lang/$compatibleLocale.json&quot;).use { inputStream -&gt;
</a><a href="#h8-0-25" id="h8-0-25" class="i">+                locales.add(LocalePair(compatibleLocale, inputStream.bufferedReader().use { it.readText() }))
</a><a href="#h8-0-26" id="h8-0-26" class="i">+            }
</a><a href="#h8-0-27" id="h8-0-27" class="i">+
</a><a href="#h8-0-28" id="h8-0-28" class="i">+            return locales
</a><a href="#h8-0-29" id="h8-0-29" class="i">+        }
</a><a href="#h8-0-30" id="h8-0-30" class="i">+    }
</a><a href="#h8-0-31" id="h8-0-31" class="i">+
</a><a href="#h8-0-32" id="h8-0-32" class="i">+
</a><a href="#h8-0-33" id="h8-0-33" class="i">+    private val translationMap = linkedMapOf&lt;String, String&gt;()
</a><a href="#h8-0-34" id="h8-0-34" class="i">+    private lateinit var _locale: String
</a><a href="#h8-0-35" id="h8-0-35" class="i">+
</a><a href="#h8-0-36" id="h8-0-36" class="i">+    val locale by lazy {
</a><a href="#h8-0-37" id="h8-0-37" class="i">+        Locale(_locale.substring(0, 2), _locale.substring(3, 5))
</a><a href="#h8-0-38" id="h8-0-38" class="i">+    }
</a><a href="#h8-0-39" id="h8-0-39" class="i">+
</a><a href="#h8-0-40" id="h8-0-40" class="i">+    private fun load(localePair: LocalePair) {
</a><a href="#h8-0-41" id="h8-0-41" class="i">+        if (!::_locale.isInitialized) {
</a><a href="#h8-0-42" id="h8-0-42" class="i">+            _locale = localePair.locale
</a><a href="#h8-0-43" id="h8-0-43" class="i">+        }
</a><a href="#h8-0-44" id="h8-0-44" class="i">+
</a><a href="#h8-0-45" id="h8-0-45" class="i">+        val translations = JsonParser.parseString(localePair.content).asJsonObject
</a><a href="#h8-0-46" id="h8-0-46" class="i">+        if (translations == null || translations.isJsonNull) {
</a><a href="#h8-0-47" id="h8-0-47" class="i">+            return
</a><a href="#h8-0-48" id="h8-0-48" class="i">+        }
</a><a href="#h8-0-49" id="h8-0-49" class="i">+
</a><a href="#h8-0-50" id="h8-0-50" class="i">+        fun scanObject(jsonObject: JsonObject, prefix: String = &quot;&quot;) {
</a><a href="#h8-0-51" id="h8-0-51" class="i">+            jsonObject.entrySet().forEach {
</a><a href="#h8-0-52" id="h8-0-52" class="i">+                if (it.value.isJsonPrimitive) {
</a><a href="#h8-0-53" id="h8-0-53" class="i">+                    val key = &quot;$prefix${it.key}&quot;
</a><a href="#h8-0-54" id="h8-0-54" class="i">+                    translationMap[key] = it.value.asString
</a><a href="#h8-0-55" id="h8-0-55" class="i">+                }
</a><a href="#h8-0-56" id="h8-0-56" class="i">+                if (!it.value.isJsonObject) return@forEach
</a><a href="#h8-0-57" id="h8-0-57" class="i">+                scanObject(it.value.asJsonObject, &quot;$prefix${it.key}.&quot;)
</a><a href="#h8-0-58" id="h8-0-58" class="i">+            }
</a><a href="#h8-0-59" id="h8-0-59" class="i">+        }
</a><a href="#h8-0-60" id="h8-0-60" class="i">+
</a><a href="#h8-0-61" id="h8-0-61" class="i">+        scanObject(translations)
</a><a href="#h8-0-62" id="h8-0-62" class="i">+    }
</a><a href="#h8-0-63" id="h8-0-63" class="i">+
</a><a href="#h8-0-64" id="h8-0-64" class="i">+    fun loadFromBridge(bridgeClient: AbstractBridgeClient) {
</a><a href="#h8-0-65" id="h8-0-65" class="i">+        bridgeClient.fetchTranslations().getLocales().forEach {
</a><a href="#h8-0-66" id="h8-0-66" class="i">+            load(it)
</a><a href="#h8-0-67" id="h8-0-67" class="i">+        }
</a><a href="#h8-0-68" id="h8-0-68" class="i">+    }
</a><a href="#h8-0-69" id="h8-0-69" class="i">+
</a><a href="#h8-0-70" id="h8-0-70" class="i">+    fun loadFromContext(context: Context) {
</a><a href="#h8-0-71" id="h8-0-71" class="i">+        fetchLocales(context).forEach {
</a><a href="#h8-0-72" id="h8-0-72" class="i">+            load(it)
</a><a href="#h8-0-73" id="h8-0-73" class="i">+        }
</a><a href="#h8-0-74" id="h8-0-74" class="i">+    }
</a><a href="#h8-0-75" id="h8-0-75" class="i">+
</a><a href="#h8-0-76" id="h8-0-76" class="i">+    operator fun get(key: String): String {
</a><a href="#h8-0-77" id="h8-0-77" class="i">+        return translationMap[key] ?: key.also { Logger.debug(&quot;Missing translation for $key&quot;) }
</a><a href="#h8-0-78" id="h8-0-78" class="i">+    }
</a><a href="#h8-0-79" id="h8-0-79" class="i">+
</a><a href="#h8-0-80" id="h8-0-80" class="i">+    fun format(key: String, vararg args: Pair&lt;String, String&gt;): String {
</a><a href="#h8-0-81" id="h8-0-81" class="i">+        return args.fold(get(key)) { acc, pair -&gt;
</a><a href="#h8-0-82" id="h8-0-82" class="i">+            acc.replace(&quot;{${pair.first}}&quot;, pair.second)
</a><a href="#h8-0-83" id="h8-0-83" class="i">+        }
</a><a href="#h8-0-84" id="h8-0-84" class="i">+    }
</a><a href="#h8-0-85" id="h8-0-85" class="i">+
</a><a href="#h8-0-86" id="h8-0-86" class="i">+    fun getCategory(key: String): TranslationWrapper {
</a><a href="#h8-0-87" id="h8-0-87" class="i">+        return TranslationWrapper().apply {
</a><a href="#h8-0-88" id="h8-0-88" class="i">+            translationMap.putAll(
</a><a href="#h8-0-89" id="h8-0-89" class="i">+                this@TranslationWrapper.translationMap
</a><a href="#h8-0-90" id="h8-0-90" class="i">+                    .filterKeys { it.startsWith(&quot;$key.&quot;) }
</a><a href="#h8-0-91" id="h8-0-91" class="i">+                    .mapKeys { it.key.substring(key.length + 1) }
</a><a href="#h8-0-92" id="h8-0-92" class="i">+            )
</a><a href="#h8-0-93" id="h8-0-93" class="i">+        }
</a><a href="#h8-0-94" id="h8-0-94" class="i">+    }
</a><a href="#h8-0-95" id="h8-0-95" class="i">+}</a><a href="#h8-0-96" id="h8-0-96" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h9" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/client/RootBridgeClient.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/client/RootBridgeClient.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/client/RootBridgeClient.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/client/RootBridgeClient.kt</a></b>
<a href="#h9-0" id="h9-0" class="h">@@ -110,7 +110,7 @@ class RootBridgeClient : AbstractBridgeClient() {
</a> 
         if (langJsonData != null) {
             Logger.debug(&quot;Fetched translations for $locale&quot;)
<a href="#h9-0-3" id="h9-0-3" class="d">-            return LocaleResult(locale, langJsonData)
</a><a href="#h9-0-4" id="h9-0-4" class="i">+            return LocaleResult(arrayOf(locale), arrayOf(langJsonData.toString(Charsets.UTF_8)))
</a>         }
 
         throw Throwable(&quot;Failed to fetch translations for $locale&quot;)
<b>diff --git a/<a id="h10" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/impl/locale/LocaleResult.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/impl/locale/LocaleResult.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/impl/locale/LocaleResult.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/impl/locale/LocaleResult.kt</a></b>
<a href="#h10-0" id="h10-0" class="h">@@ -2,18 +2,30 @@ package me.rhunk.snapenhance.bridge.common.impl.locale
</a> 
 import android.os.Bundle
 import me.rhunk.snapenhance.bridge.common.BridgeMessage
<a href="#h10-0-3" id="h10-0-3" class="i">+import me.rhunk.snapenhance.data.LocalePair
</a> 
 class LocaleResult(
<a href="#h10-0-6" id="h10-0-6" class="d">-    var locale: String? = null,
</a><a href="#h10-0-7" id="h10-0-7" class="d">-    var content: ByteArray? = null
</a><a href="#h10-0-8" id="h10-0-8" class="i">+    private var locales: Array&lt;String&gt;? = null,
</a><a href="#h10-0-9" id="h10-0-9" class="i">+    private var localContentArray: Array&lt;String&gt;? = null
</a> ) : BridgeMessage(){
<a href="#h10-0-11" id="h10-0-11" class="i">+
</a><a href="#h10-0-12" id="h10-0-12" class="i">+    fun getLocales(): List&lt;LocalePair&gt; {
</a><a href="#h10-0-13" id="h10-0-13" class="i">+        val locales = locales ?: return emptyList()
</a><a href="#h10-0-14" id="h10-0-14" class="i">+        val localContentArray = localContentArray ?: return emptyList()
</a><a href="#h10-0-15" id="h10-0-15" class="i">+        return locales.mapIndexed { index, locale -&gt;
</a><a href="#h10-0-16" id="h10-0-16" class="i">+            LocalePair(locale, localContentArray[index])
</a><a href="#h10-0-17" id="h10-0-17" class="i">+        }.asReversed()
</a><a href="#h10-0-18" id="h10-0-18" class="i">+    }
</a><a href="#h10-0-19" id="h10-0-19" class="i">+
</a><a href="#h10-0-20" id="h10-0-20" class="i">+
</a>     override fun write(bundle: Bundle) {
<a href="#h10-0-22" id="h10-0-22" class="d">-        bundle.putString(&quot;locale&quot;, locale)
</a><a href="#h10-0-23" id="h10-0-23" class="d">-        bundle.putByteArray(&quot;content&quot;, content)
</a><a href="#h10-0-24" id="h10-0-24" class="i">+        bundle.putStringArray(&quot;locales&quot;, locales)
</a><a href="#h10-0-25" id="h10-0-25" class="i">+        bundle.putSerializable(&quot;localContentArray&quot;, localContentArray)
</a>     }
 
<a href="#h10-0-28" id="h10-0-28" class="i">+    @Suppress(&quot;UNCHECKED_CAST&quot;, &quot;DEPRECATION&quot;)
</a>     override fun read(bundle: Bundle) {
<a href="#h10-0-30" id="h10-0-30" class="d">-        locale = bundle.getString(&quot;locale&quot;)
</a><a href="#h10-0-31" id="h10-0-31" class="d">-        content = bundle.getByteArray(&quot;content&quot;)
</a><a href="#h10-0-32" id="h10-0-32" class="i">+        locales = bundle.getStringArray(&quot;locales&quot;)
</a><a href="#h10-0-33" id="h10-0-33" class="i">+        localContentArray = bundle.getSerializable(&quot;localContentArray&quot;) as? Array&lt;String&gt;
</a>     }
 } 
\ No newline at end of file
<b>diff --git a/<a id="h11" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/service/BridgeService.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/service/BridgeService.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/service/BridgeService.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/service/BridgeService.kt</a></b>
<a href="#h11-0" id="h11-0" class="h">@@ -8,6 +8,7 @@ import android.net.Uri
</a> import android.os.*
 import me.rhunk.snapenhance.Logger
 import me.rhunk.snapenhance.bridge.MessageLoggerWrapper
<a href="#h11-0-3" id="h11-0-3" class="i">+import me.rhunk.snapenhance.bridge.TranslationWrapper
</a> import me.rhunk.snapenhance.bridge.common.BridgeMessageType
 import me.rhunk.snapenhance.bridge.common.impl.*
 import me.rhunk.snapenhance.bridge.common.impl.download.DownloadContentRequest
<a href="#h11-1" id="h11-1" class="h">@@ -111,12 +112,15 @@ class BridgeService : Service() {
</a>     }
 
     private fun handleLocaleRequest(reply: (Message) -&gt; Unit) {
<a href="#h11-1-3" id="h11-1-3" class="d">-        val deviceLocale = Locale.getDefault().toString()
</a><a href="#h11-1-4" id="h11-1-4" class="d">-        val compatibleLocale = resources.assets.list(&quot;lang&quot;)?.find { it.startsWith(deviceLocale) }?.substring(0, 5) ?: &quot;en_US&quot;
</a><a href="#h11-1-5" id="h11-1-5" class="i">+        val locales = sortedSetOf&lt;String&gt;()
</a><a href="#h11-1-6" id="h11-1-6" class="i">+        val contentArray = sortedSetOf&lt;String&gt;()
</a> 
<a href="#h11-1-8" id="h11-1-8" class="d">-        resources.assets.open(&quot;lang/$compatibleLocale.json&quot;).use { inputStream -&gt;
</a><a href="#h11-1-9" id="h11-1-9" class="d">-            reply(LocaleResult(compatibleLocale, inputStream.readBytes()).toMessage(BridgeMessageType.LOCALE_RESULT.value))
</a><a href="#h11-1-10" id="h11-1-10" class="i">+        TranslationWrapper.fetchLocales(context = this).forEach { pair -&gt;
</a><a href="#h11-1-11" id="h11-1-11" class="i">+            locales.add(pair.locale)
</a><a href="#h11-1-12" id="h11-1-12" class="i">+            contentArray.add(pair.content)
</a>         }
<a href="#h11-1-14" id="h11-1-14" class="i">+
</a><a href="#h11-1-15" id="h11-1-15" class="i">+        reply(LocaleResult(locales.toTypedArray(), contentArray.toTypedArray()).toMessage(BridgeMessageType.LOCALE_RESULT.value))
</a>     }
 
     @SuppressLint(&quot;UnspecifiedRegisterReceiverFlag&quot;)
<b>diff --git a/<a id="h12" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/service/MainActivity.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/service/MainActivity.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/service/MainActivity.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/service/MainActivity.kt</a></b>
<a href="#h12-0" id="h12-0" class="h">@@ -1,17 +0,0 @@
</a><a href="#h12-0-0" id="h12-0-0" class="d">-package me.rhunk.snapenhance.bridge.service
</a><a href="#h12-0-1" id="h12-0-1" class="d">-
</a><a href="#h12-0-2" id="h12-0-2" class="d">-import android.app.Activity
</a><a href="#h12-0-3" id="h12-0-3" class="d">-import android.content.Intent
</a><a href="#h12-0-4" id="h12-0-4" class="d">-import android.os.Bundle
</a><a href="#h12-0-5" id="h12-0-5" class="d">-import me.rhunk.snapenhance.Constants
</a><a href="#h12-0-6" id="h12-0-6" class="d">-
</a><a href="#h12-0-7" id="h12-0-7" class="d">-class MainActivity : Activity() {
</a><a href="#h12-0-8" id="h12-0-8" class="d">-    override fun onCreate(savedInstanceState: Bundle?) {
</a><a href="#h12-0-9" id="h12-0-9" class="d">-        super.onCreate(savedInstanceState)
</a><a href="#h12-0-10" id="h12-0-10" class="d">-        packageManager.getLaunchIntentForPackage(Constants.SNAPCHAT_PACKAGE_NAME)?.apply {
</a><a href="#h12-0-11" id="h12-0-11" class="d">-            addFlags(Intent.FLAG_ACTIVITY_NEW_TASK)
</a><a href="#h12-0-12" id="h12-0-12" class="d">-            startActivity(this)
</a><a href="#h12-0-13" id="h12-0-13" class="d">-        }
</a><a href="#h12-0-14" id="h12-0-14" class="d">-        finish()
</a><a href="#h12-0-15" id="h12-0-15" class="d">-    }
</a><a href="#h12-0-16" id="h12-0-16" class="d">-}
</a><b>diff --git a/<a id="h13" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/config/ConfigProperty.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/config/ConfigProperty.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/config/ConfigProperty.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/config/ConfigProperty.kt</a></b>
<a href="#h13-0" id="h13-0" class="h">@@ -10,8 +10,7 @@ import me.rhunk.snapenhance.features.impl.tweaks.CameraTweaks
</a> import java.io.File
 
 enum class ConfigProperty(
<a href="#h13-0-3" id="h13-0-3" class="d">-    val nameKey: String,
</a><a href="#h13-0-4" id="h13-0-4" class="d">-    val descriptionKey: String,
</a><a href="#h13-0-5" id="h13-0-5" class="i">+    val translationKey: String,
</a>     val category: ConfigCategory,
     val valueContainer: ConfigValue&lt;*&gt;,
     val shouldAppearInSettings: Boolean = true,
<a href="#h13-1" id="h13-1" class="h">@@ -19,26 +18,22 @@ enum class ConfigProperty(
</a> ) {
 
     //SPYING AND PRIVACY
<a href="#h13-1-3" id="h13-1-3" class="d">-    MESSAGE_LOGGER(&quot;property.message_logger&quot;,
</a><a href="#h13-1-4" id="h13-1-4" class="d">-        &quot;description.message_logger&quot;,
</a><a href="#h13-1-5" id="h13-1-5" class="i">+    MESSAGE_LOGGER(&quot;message_logger&quot;,
</a>         ConfigCategory.SPYING_PRIVACY,
         ConfigStateValue(false)
     ),
     PREVENT_READ_RECEIPTS(
<a href="#h13-1-10" id="h13-1-10" class="d">-        &quot;property.prevent_read_receipts&quot;,
</a><a href="#h13-1-11" id="h13-1-11" class="d">-        &quot;description.prevent_read_receipts&quot;,
</a><a href="#h13-1-12" id="h13-1-12" class="i">+        &quot;prevent_read_receipts&quot;,
</a>         ConfigCategory.SPYING_PRIVACY,
         ConfigStateValue(false)
     ),
     HIDE_BITMOJI_PRESENCE(
<a href="#h13-1-17" id="h13-1-17" class="d">-        &quot;property.hide_bitmoji_presence&quot;,
</a><a href="#h13-1-18" id="h13-1-18" class="d">-        &quot;description.hide_bitmoji_presence&quot;,
</a><a href="#h13-1-19" id="h13-1-19" class="i">+        &quot;hide_bitmoji_presence&quot;,
</a>         ConfigCategory.SPYING_PRIVACY,
         ConfigStateValue(false)
     ),
     BETTER_NOTIFICATIONS(
<a href="#h13-1-24" id="h13-1-24" class="d">-        &quot;property.better_notifications&quot;,
</a><a href="#h13-1-25" id="h13-1-25" class="d">-        &quot;description.better_notifications&quot;,
</a><a href="#h13-1-26" id="h13-1-26" class="i">+        &quot;better_notifications&quot;,
</a>         ConfigCategory.SPYING_PRIVACY,
         ConfigStateListValue(
             listOf(&quot;snap&quot;, &quot;chat&quot;, &quot;reply_button&quot;),
<a href="#h13-2" id="h13-2" class="h">@@ -50,8 +45,7 @@ enum class ConfigProperty(
</a>         )
     ),
     NOTIFICATION_BLACKLIST(
<a href="#h13-2-3" id="h13-2-3" class="d">-        &quot;property.notification_blacklist&quot;,
</a><a href="#h13-2-4" id="h13-2-4" class="d">-        &quot;description.notification_blacklist&quot;,
</a><a href="#h13-2-5" id="h13-2-5" class="i">+        &quot;notification_blacklist&quot;,
</a>         ConfigCategory.SPYING_PRIVACY,
         ConfigStateListValue(
             listOf(&quot;snap&quot;, &quot;chat&quot;, &quot;typing&quot;),
<a href="#h13-3" id="h13-3" class="h">@@ -62,56 +56,51 @@ enum class ConfigProperty(
</a>             )
         )
     ),
<a href="#h13-3-3" id="h13-3-3" class="d">-    DISABLE_METRICS(&quot;property.disable_metrics&quot;,
</a><a href="#h13-3-4" id="h13-3-4" class="d">-        &quot;description.disable_metrics&quot;,
</a><a href="#h13-3-5" id="h13-3-5" class="i">+    DISABLE_METRICS(&quot;disable_metrics&quot;,
</a>         ConfigCategory.SPYING_PRIVACY,
         ConfigStateValue(false)
     ),
<a href="#h13-3-9" id="h13-3-9" class="d">-    BLOCK_ADS(&quot;property.block_ads&quot;,
</a><a href="#h13-3-10" id="h13-3-10" class="d">-        &quot;description.block_ads&quot;,
</a><a href="#h13-3-11" id="h13-3-11" class="i">+    BLOCK_ADS(&quot;block_ads&quot;,
</a>         ConfigCategory.SPYING_PRIVACY,
         ConfigStateValue(false)
     ),
<a href="#h13-3-15" id="h13-3-15" class="d">-    UNLIMITED_SNAP_VIEW_TIME(&quot;property.unlimited_snap_view_time&quot;,
</a><a href="#h13-3-16" id="h13-3-16" class="d">-        &quot;description.unlimited_snap_view_time&quot;,
</a><a href="#h13-3-17" id="h13-3-17" class="i">+    UNLIMITED_SNAP_VIEW_TIME(&quot;unlimited_snap_view_time&quot;,
</a>         ConfigCategory.SPYING_PRIVACY,
         ConfigStateValue(false)
     ),
     PREVENT_SCREENSHOT_NOTIFICATIONS(
<a href="#h13-3-22" id="h13-3-22" class="d">-        &quot;property.prevent_screenshot_notifications&quot;,
</a><a href="#h13-3-23" id="h13-3-23" class="d">-        &quot;description.prevent_screenshot_notifications&quot;,
</a><a href="#h13-3-24" id="h13-3-24" class="i">+        &quot;prevent_screenshot_notifications&quot;,
</a>         ConfigCategory.SPYING_PRIVACY,
         ConfigStateValue(false)
     ),
     PREVENT_STATUS_NOTIFICATIONS(
<a href="#h13-3-29" id="h13-3-29" class="d">-        &quot;property.prevent_status_notifications&quot;,
</a><a href="#h13-3-30" id="h13-3-30" class="d">-        &quot;description.prevent_status_notifications&quot;,
</a><a href="#h13-3-31" id="h13-3-31" class="i">+        &quot;prevent_status_notifications&quot;,
</a>         ConfigCategory.SPYING_PRIVACY,
         ConfigStateValue(false)
     ),
     ANONYMOUS_STORY_VIEW(
<a href="#h13-3-36" id="h13-3-36" class="d">-        &quot;property.anonymous_story_view&quot;,
</a><a href="#h13-3-37" id="h13-3-37" class="d">-        &quot;description.anonymous_story_view&quot;,
</a><a href="#h13-3-38" id="h13-3-38" class="i">+        &quot;anonymous_story_view&quot;,
</a>         ConfigCategory.SPYING_PRIVACY,
         ConfigStateValue(false)
     ),
     HIDE_TYPING_NOTIFICATION(
<a href="#h13-3-43" id="h13-3-43" class="d">-        &quot;property.hide_typing_notification&quot;,
</a><a href="#h13-3-44" id="h13-3-44" class="d">-        &quot;description.hide_typing_notification&quot;,
</a><a href="#h13-3-45" id="h13-3-45" class="i">+        &quot;hide_typing_notification&quot;,
</a>         ConfigCategory.SPYING_PRIVACY,
         ConfigStateValue(false)
     ),
     
     //MEDIA MANAGEMENT
     SAVE_FOLDER(
<a href="#h13-3-52" id="h13-3-52" class="d">-        &quot;property.save_folder&quot;, &quot;description.save_folder&quot;, ConfigCategory.MEDIA_MANAGEMENT,
</a><a href="#h13-3-53" id="h13-3-53" class="i">+        &quot;save_folder&quot;,
</a><a href="#h13-3-54" id="h13-3-54" class="i">+        ConfigCategory.MEDIA_MANAGEMENT,
</a>         ConfigStringValue(File(
             Environment.getExternalStoragePublicDirectory(Environment.DIRECTORY_DCIM).absolutePath + &quot;/Snapchat&quot;,
             &quot;SnapEnhance&quot;
         ).absolutePath)
     ),
     AUTO_DOWNLOAD_OPTIONS(
<a href="#h13-3-61" id="h13-3-61" class="d">-        &quot;property.auto_download_options&quot;, &quot;description.auto_download_options&quot;, ConfigCategory.MEDIA_MANAGEMENT,
</a><a href="#h13-3-62" id="h13-3-62" class="i">+        &quot;auto_download_options&quot;,
</a><a href="#h13-3-63" id="h13-3-63" class="i">+        ConfigCategory.MEDIA_MANAGEMENT,
</a>         ConfigStateListValue(
             listOf(&quot;friend_snaps&quot;, &quot;friend_stories&quot;, &quot;public_stories&quot;, &quot;spotlight&quot;),
             mutableMapOf(
<a href="#h13-4" id="h13-4" class="h">@@ -123,7 +112,8 @@ enum class ConfigProperty(
</a>         )
     ),
     DOWNLOAD_OPTIONS(
<a href="#h13-4-3" id="h13-4-3" class="d">-        &quot;property.download_options&quot;, &quot;description.download_options&quot;, ConfigCategory.MEDIA_MANAGEMENT,
</a><a href="#h13-4-4" id="h13-4-4" class="i">+        &quot;download_options&quot;,
</a><a href="#h13-4-5" id="h13-4-5" class="i">+        ConfigCategory.MEDIA_MANAGEMENT,
</a>         ConfigStateListValue(
             listOf(&quot;format_user_folder&quot;, &quot;format_hash&quot;, &quot;format_date_time&quot;, &quot;format_username&quot;, &quot;merge_overlay&quot;),
             mutableMapOf(
<a href="#h13-5" id="h13-5" class="h">@@ -136,22 +126,19 @@ enum class ConfigProperty(
</a>         )
     ),
     CHAT_DOWNLOAD_CONTEXT_MENU(
<a href="#h13-5-3" id="h13-5-3" class="d">-        &quot;property.chat_download_context_menu&quot;,
</a><a href="#h13-5-4" id="h13-5-4" class="d">-        &quot;description.chat_download_context_menu&quot;,
</a><a href="#h13-5-5" id="h13-5-5" class="i">+        &quot;chat_download_context_menu&quot;,
</a>         ConfigCategory.MEDIA_MANAGEMENT,
         ConfigStateValue(false)
     ),
     GALLERY_MEDIA_SEND_OVERRIDE(
<a href="#h13-5-10" id="h13-5-10" class="d">-        &quot;property.gallery_media_send_override&quot;,
</a><a href="#h13-5-11" id="h13-5-11" class="d">-        &quot;description.gallery_media_send_override&quot;,
</a><a href="#h13-5-12" id="h13-5-12" class="i">+        &quot;gallery_media_send_override&quot;,
</a>         ConfigCategory.MEDIA_MANAGEMENT,
         ConfigStateSelection(
             listOf(&quot;OFF&quot;, &quot;NOTE&quot;, &quot;SNAP&quot;, &quot;LIVE_SNAP&quot;),
             &quot;OFF&quot;
         )
     ),
<a href="#h13-5-19" id="h13-5-19" class="d">-    AUTO_SAVE_MESSAGES(&quot;property.auto_save_messages&quot;,
</a><a href="#h13-5-20" id="h13-5-20" class="d">-        &quot;description.auto_save_messages&quot;,
</a><a href="#h13-5-21" id="h13-5-21" class="i">+    AUTO_SAVE_MESSAGES(&quot;auto_save_messages&quot;,
</a>         ConfigCategory.MEDIA_MANAGEMENT,
         ConfigStateListValue(
             listOf(&quot;CHAT&quot;, &quot;SNAP&quot;, &quot;NOTE&quot;, &quot;EXTERNAL_MEDIA&quot;, &quot;STICKER&quot;)
<a href="#h13-6" id="h13-6" class="h">@@ -159,22 +146,19 @@ enum class ConfigProperty(
</a>     ),
 
     FORCE_MEDIA_SOURCE_QUALITY(
<a href="#h13-6-3" id="h13-6-3" class="d">-        &quot;property.force_media_source_quality&quot;,
</a><a href="#h13-6-4" id="h13-6-4" class="d">-        &quot;description.force_media_source_quality&quot;,
</a><a href="#h13-6-5" id="h13-6-5" class="i">+        &quot;force_media_source_quality&quot;,
</a>         ConfigCategory.MEDIA_MANAGEMENT,
         ConfigStateValue(false)
     ),
     
     //UI AND TWEAKS
     ENABLE_FRIEND_FEED_MENU_BAR(
<a href="#h13-6-12" id="h13-6-12" class="d">-        &quot;property.enable_friend_feed_menu_bar&quot;,
</a><a href="#h13-6-13" id="h13-6-13" class="d">-        &quot;description.enable_friend_feed_menu_bar&quot;,
</a><a href="#h13-6-14" id="h13-6-14" class="i">+        &quot;enable_friend_feed_menu_bar&quot;,
</a>         ConfigCategory.UI_TWEAKS,
         ConfigStateValue(false)
     ),
     FRIEND_FEED_MENU_BUTTONS(
<a href="#h13-6-19" id="h13-6-19" class="d">-        &quot;property.friend_feed_menu_buttons&quot;,
</a><a href="#h13-6-20" id="h13-6-20" class="d">-        &quot;description.friend_feed_menu_buttons&quot;,
</a><a href="#h13-6-21" id="h13-6-21" class="i">+        &quot;friend_feed_menu_buttons&quot;,
</a>         ConfigCategory.UI_TWEAKS,
         ConfigStateListValue(
             listOf(&quot;auto_download_blacklist&quot;, &quot;anti_auto_save&quot;, &quot;stealth_mode&quot;, &quot;conversation_info&quot;),
<a href="#h13-7" id="h13-7" class="h">@@ -186,14 +170,12 @@ enum class ConfigProperty(
</a>             )
         )
     ),
<a href="#h13-7-3" id="h13-7-3" class="d">-    FRIEND_FEED_MENU_POSITION(&quot;property.friend_feed_menu_buttons_position&quot;,
</a><a href="#h13-7-4" id="h13-7-4" class="d">-        &quot;description.friend_feed_menu_buttons_position&quot;,
</a><a href="#h13-7-5" id="h13-7-5" class="i">+    FRIEND_FEED_MENU_POSITION(&quot;friend_feed_menu_buttons_position&quot;,
</a>         ConfigCategory.UI_TWEAKS,
         ConfigIntegerValue(1)
     ),
     HIDE_UI_ELEMENTS(
<a href="#h13-7-10" id="h13-7-10" class="d">-        &quot;property.hide_ui_elements&quot;,
</a><a href="#h13-7-11" id="h13-7-11" class="d">-        &quot;description.hide_ui_elements&quot;,
</a><a href="#h13-7-12" id="h13-7-12" class="i">+        &quot;hide_ui_elements&quot;,
</a>         ConfigCategory.UI_TWEAKS,
         ConfigStateListValue(
             listOf(&quot;remove_voice_record_button&quot;, &quot;remove_stickers_button&quot;, &quot;remove_cognac_button&quot;, &quot;remove_call_buttons&quot;, &quot;remove_camera_borders&quot;),
<a href="#h13-8" id="h13-8" class="h">@@ -207,74 +189,62 @@ enum class ConfigProperty(
</a>         )
     ),
     STREAK_EXPIRATION_INFO(
<a href="#h13-8-3" id="h13-8-3" class="d">-        &quot;property.streak_expiration_info&quot;,
</a><a href="#h13-8-4" id="h13-8-4" class="d">-        &quot;description.streakexpirationinfo&quot;,
</a><a href="#h13-8-5" id="h13-8-5" class="i">+        &quot;streak_expiration_info&quot;,
</a>         ConfigCategory.UI_TWEAKS,
         ConfigStateValue(false)
     ),
     DISABLE_SNAP_SPLITTING(
<a href="#h13-8-10" id="h13-8-10" class="d">-        &quot;property.disable_snap_splitting&quot;,
</a><a href="#h13-8-11" id="h13-8-11" class="d">-        &quot;description.disable_snap_splitting&quot;,
</a><a href="#h13-8-12" id="h13-8-12" class="i">+        &quot;disable_snap_splitting&quot;,
</a>         ConfigCategory.UI_TWEAKS,
         ConfigStateValue(false)
     ),
     DISABLE_VIDEO_LENGTH_RESTRICTION(
<a href="#h13-8-17" id="h13-8-17" class="d">-        &quot;property.disable_video_length_restriction&quot;,
</a><a href="#h13-8-18" id="h13-8-18" class="d">-        &quot;description.disable_video_length_restriction&quot;,
</a><a href="#h13-8-19" id="h13-8-19" class="i">+        &quot;disable_video_length_restriction&quot;,
</a>         ConfigCategory.UI_TWEAKS,
         ConfigStateValue(false)
     ),
<a href="#h13-8-23" id="h13-8-23" class="d">-    SNAPCHAT_PLUS(&quot;property.snapchat_plus&quot;,
</a><a href="#h13-8-24" id="h13-8-24" class="d">-        &quot;description.snapchat_plus&quot;,
</a><a href="#h13-8-25" id="h13-8-25" class="i">+    SNAPCHAT_PLUS(&quot;snapchat_plus&quot;,
</a>         ConfigCategory.UI_TWEAKS,
         ConfigStateValue(false)
     ),
<a href="#h13-8-29" id="h13-8-29" class="d">-    NEW_MAP_UI(&quot;property.new_map_ui&quot;,
</a><a href="#h13-8-30" id="h13-8-30" class="d">-        &quot;description.new_map_ui&quot;,
</a><a href="#h13-8-31" id="h13-8-31" class="i">+    NEW_MAP_UI(&quot;new_map_ui&quot;,
</a>         ConfigCategory.UI_TWEAKS,
         ConfigStateValue(false)
     ),
     LOCATION_SPOOF(
<a href="#h13-8-36" id="h13-8-36" class="d">-        &quot;property.location_spoof&quot;,
</a><a href="#h13-8-37" id="h13-8-37" class="d">-        &quot;description.location_spoof&quot;,
</a><a href="#h13-8-38" id="h13-8-38" class="i">+        &quot;location_spoof&quot;,
</a>         ConfigCategory.UI_TWEAKS,
         ConfigStateValue(false)
     ),
     LATITUDE(
<a href="#h13-8-43" id="h13-8-43" class="d">-        &quot;property.latitude_value&quot;,
</a><a href="#h13-8-44" id="h13-8-44" class="d">-        &quot;description.latitude_value&quot;,
</a><a href="#h13-8-45" id="h13-8-45" class="i">+        &quot;latitude_value&quot;,
</a>         ConfigCategory.UI_TWEAKS,
         ConfigStringValue(&quot;0.0000&quot;),
         shouldAppearInSettings = false
     ),
     LONGITUDE(
<a href="#h13-8-51" id="h13-8-51" class="d">-        &quot;property.longitude_value&quot;,
</a><a href="#h13-8-52" id="h13-8-52" class="d">-        &quot;description.longitude_value&quot;,
</a><a href="#h13-8-53" id="h13-8-53" class="i">+        &quot;longitude_value&quot;,
</a>         ConfigCategory.UI_TWEAKS,
         ConfigStringValue(&quot;0.0000&quot;),
         shouldAppearInSettings = false
     ),
     MESSAGE_PREVIEW_LENGTH(
<a href="#h13-8-59" id="h13-8-59" class="d">-        &quot;property.message_preview_length&quot;,
</a><a href="#h13-8-60" id="h13-8-60" class="d">-        &quot;description.message_preview_length&quot;,
</a><a href="#h13-8-61" id="h13-8-61" class="i">+        &quot;message_preview_length&quot;,
</a>         ConfigCategory.UI_TWEAKS,
         ConfigIntegerValue(20)
     ),
     UNLIMITED_CONVERSATION_PINNING(
<a href="#h13-8-66" id="h13-8-66" class="d">-        &quot;property.unlimited_conversation_pinning&quot;,
</a><a href="#h13-8-67" id="h13-8-67" class="d">-        &quot;description.unlimited_conversation_pinning&quot;,
</a><a href="#h13-8-68" id="h13-8-68" class="i">+        &quot;unlimited_conversation_pinning&quot;,
</a>         ConfigCategory.UI_TWEAKS,
         ConfigStateValue(false)
     ),
     DISABLE_SPOTLIGHT(
<a href="#h13-8-73" id="h13-8-73" class="d">-        &quot;property.disable_spotlight&quot;,
</a><a href="#h13-8-74" id="h13-8-74" class="d">-        &quot;description.disable_spotlight&quot;,
</a><a href="#h13-8-75" id="h13-8-75" class="i">+        &quot;disable_spotlight&quot;,
</a>         ConfigCategory.UI_TWEAKS,
         ConfigStateValue(false)
     ),
     ENABLE_APP_APPEARANCE(
<a href="#h13-8-80" id="h13-8-80" class="d">-        &quot;property.enable_app_appearance&quot;,
</a><a href="#h13-8-81" id="h13-8-81" class="d">-        &quot;description.enable_app_appearance&quot;,
</a><a href="#h13-8-82" id="h13-8-82" class="i">+        &quot;enable_app_appearance&quot;,
</a>         ConfigCategory.UI_TWEAKS,
         ConfigStateValue(false)
     ),
<a href="#h13-9" id="h13-9" class="h">@@ -282,20 +252,17 @@ enum class ConfigProperty(
</a> 
     //CAMERA
     CAMERA_DISABLE(
<a href="#h13-9-3" id="h13-9-3" class="d">-        &quot;property.disable_camera&quot;,
</a><a href="#h13-9-4" id="h13-9-4" class="d">-        &quot;description.disable_camera&quot;,
</a><a href="#h13-9-5" id="h13-9-5" class="i">+        &quot;disable_camera&quot;,
</a>         ConfigCategory.CAMERA,
         ConfigStateValue(false)
     ),
     IMMERSIVE_CAMERA_PREVIEW(
<a href="#h13-9-10" id="h13-9-10" class="d">-        &quot;property.immersive_camera_preview&quot;,
</a><a href="#h13-9-11" id="h13-9-11" class="d">-        &quot;description.immersive_camera_preview&quot;,
</a><a href="#h13-9-12" id="h13-9-12" class="i">+        &quot;immersive_camera_preview&quot;,
</a>         ConfigCategory.CAMERA,
         ConfigStateValue(false)
     ),
     OVERRIDE_PREVIEW_RESOLUTION(
<a href="#h13-9-17" id="h13-9-17" class="d">-        &quot;property.preview_resolution&quot;,
</a><a href="#h13-9-18" id="h13-9-18" class="d">-        &quot;description.preview_resolution&quot;,
</a><a href="#h13-9-19" id="h13-9-19" class="i">+        &quot;preview_resolution&quot;,
</a>         ConfigCategory.CAMERA,
         ConfigStateSelection(
             CameraTweaks.resolutions,
<a href="#h13-10" id="h13-10" class="h">@@ -304,8 +271,7 @@ enum class ConfigProperty(
</a>         disableValueLocalization = true
     ),
     OVERRIDE_PICTURE_RESOLUTION(
<a href="#h13-10-3" id="h13-10-3" class="d">-        &quot;property.picture_resolution&quot;,
</a><a href="#h13-10-4" id="h13-10-4" class="d">-        &quot;description.picture_resolution&quot;,
</a><a href="#h13-10-5" id="h13-10-5" class="i">+        &quot;picture_resolution&quot;,
</a>         ConfigCategory.CAMERA,
         ConfigStateSelection(
             CameraTweaks.resolutions,
<a href="#h13-11" id="h13-11" class="h">@@ -314,22 +280,19 @@ enum class ConfigProperty(
</a>         disableValueLocalization = true
     ),
     FORCE_HIGHEST_FRAME_RATE(
<a href="#h13-11-3" id="h13-11-3" class="d">-        &quot;property.force_highest_frame_rate&quot;,
</a><a href="#h13-11-4" id="h13-11-4" class="d">-        &quot;description.force_highest_frame_rate&quot;,
</a><a href="#h13-11-5" id="h13-11-5" class="i">+        &quot;force_highest_frame_rate&quot;,
</a>         ConfigCategory.CAMERA,
         ConfigStateValue(false)
     ),
     FORCE_CAMERA_SOURCE_ENCODING(
<a href="#h13-11-10" id="h13-11-10" class="d">-        &quot;property.force_camera_source_encoding&quot;,
</a><a href="#h13-11-11" id="h13-11-11" class="d">-        &quot;description.force_camera_source_encoding&quot;,
</a><a href="#h13-11-12" id="h13-11-12" class="i">+        &quot;force_camera_source_encoding&quot;,
</a>         ConfigCategory.CAMERA,
         ConfigStateValue(false)
     ),
 
     // UPDATES
     AUTO_UPDATER(
<a href="#h13-11-19" id="h13-11-19" class="d">-        &quot;property.auto_updater&quot;,
</a><a href="#h13-11-20" id="h13-11-20" class="d">-        &quot;description.auto_updater&quot;,
</a><a href="#h13-11-21" id="h13-11-21" class="i">+        &quot;auto_updater&quot;,
</a>         ConfigCategory.UPDATES,
         ConfigStateSelection(
             listOf(&quot;DISABLED&quot;, &quot;EVERY_LAUNCH&quot;, &quot;DAILY&quot;, &quot;WEEKLY&quot;),
<a href="#h13-12" id="h13-12" class="h">@@ -339,32 +302,27 @@ enum class ConfigProperty(
</a> 
     // EXPERIMENTAL DEBUGGING
     APP_PASSCODE(
<a href="#h13-12-3" id="h13-12-3" class="d">-        &quot;property.app_passcode&quot;,
</a><a href="#h13-12-4" id="h13-12-4" class="d">-        &quot;description.app_passcode&quot;,
</a><a href="#h13-12-5" id="h13-12-5" class="i">+        &quot;app_passcode&quot;,
</a>         ConfigCategory.EXPERIMENTAL_DEBUGGING,
         ConfigStringValue(&quot;&quot;, isHidden = true)
     ),
     APP_LOCK_ON_RESUME(
<a href="#h13-12-10" id="h13-12-10" class="d">-        &quot;property.app_lock_on_resume&quot;,
</a><a href="#h13-12-11" id="h13-12-11" class="d">-        &quot;description.app_lock_on_resume&quot;,
</a><a href="#h13-12-12" id="h13-12-12" class="i">+        &quot;app_lock_on_resume&quot;,
</a>         ConfigCategory.EXPERIMENTAL_DEBUGGING,
         ConfigStateValue(false)
     ),
     INFINITE_STORY_BOOST(
<a href="#h13-12-17" id="h13-12-17" class="d">-        &quot;property.infinite_story_boost&quot;,
</a><a href="#h13-12-18" id="h13-12-18" class="d">-        &quot;description.infinite_story_boost&quot;,
</a><a href="#h13-12-19" id="h13-12-19" class="i">+        &quot;infinite_story_boost&quot;,
</a>         ConfigCategory.EXPERIMENTAL_DEBUGGING,
         ConfigStateValue(false)
     ),
     MEO_PASSCODE_BYPASS(
<a href="#h13-12-24" id="h13-12-24" class="d">-    &quot;property.meo_passcode_bypass&quot;,
</a><a href="#h13-12-25" id="h13-12-25" class="d">-    &quot;description.meo_passcode_bypass&quot;,
</a><a href="#h13-12-26" id="h13-12-26" class="i">+    &quot;meo_passcode_bypass&quot;,
</a>         ConfigCategory.EXPERIMENTAL_DEBUGGING,
         ConfigStateValue(false)
     ),
     AMOLED_DARK_MODE(
<a href="#h13-12-31" id="h13-12-31" class="d">-        &quot;property.amoled_dark_mode&quot;,
</a><a href="#h13-12-32" id="h13-12-32" class="d">-        &quot;description.amoled_dark_mode&quot;,
</a><a href="#h13-12-33" id="h13-12-33" class="i">+        &quot;amoled_dark_mode&quot;,
</a>         ConfigCategory.EXPERIMENTAL_DEBUGGING,
         ConfigStateValue(false)
     );
<b>diff --git a/<a id="h14" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/data/LocalePair.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/data/LocalePair.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/data/LocalePair.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/data/LocalePair.kt</a></b>
<a href="#h14-0" id="h14-0" class="h">@@ -0,0 +1,3 @@
</a><a href="#h14-0-0" id="h14-0-0" class="i">+package me.rhunk.snapenhance.data
</a><a href="#h14-0-1" id="h14-0-1" class="i">+
</a><a href="#h14-0-2" id="h14-0-2" class="i">+data class LocalePair(val locale: String, val content: String)</a><a href="#h14-0-3" id="h14-0-3" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h15" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/download/ClientDownloadManager.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/download/ClientDownloadManager.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/download/ClientDownloadManager.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/download/ClientDownloadManager.kt</a></b>
<a href="#h15-0" id="h15-0" class="h">@@ -1,82 +0,0 @@
</a><a href="#h15-0-0" id="h15-0-0" class="d">-package me.rhunk.snapenhance.download
</a><a href="#h15-0-1" id="h15-0-1" class="d">-
</a><a href="#h15-0-2" id="h15-0-2" class="d">-import android.content.Intent
</a><a href="#h15-0-3" id="h15-0-3" class="d">-import android.os.Bundle
</a><a href="#h15-0-4" id="h15-0-4" class="d">-import me.rhunk.snapenhance.BuildConfig
</a><a href="#h15-0-5" id="h15-0-5" class="d">-import me.rhunk.snapenhance.ModContext
</a><a href="#h15-0-6" id="h15-0-6" class="d">-import me.rhunk.snapenhance.download.data.DownloadRequest
</a><a href="#h15-0-7" id="h15-0-7" class="d">-import me.rhunk.snapenhance.download.data.MediaEncryptionKeyPair
</a><a href="#h15-0-8" id="h15-0-8" class="d">-import me.rhunk.snapenhance.download.enums.DownloadMediaType
</a><a href="#h15-0-9" id="h15-0-9" class="d">-
</a><a href="#h15-0-10" id="h15-0-10" class="d">-class ClientDownloadManager (
</a><a href="#h15-0-11" id="h15-0-11" class="d">-    private val context: ModContext,
</a><a href="#h15-0-12" id="h15-0-12" class="d">-    private val outputPath: String,
</a><a href="#h15-0-13" id="h15-0-13" class="d">-    private val mediaDisplaySource: String?,
</a><a href="#h15-0-14" id="h15-0-14" class="d">-    private val mediaDisplayType: String?,
</a><a href="#h15-0-15" id="h15-0-15" class="d">-    private val iconUrl: String?
</a><a href="#h15-0-16" id="h15-0-16" class="d">-) {
</a><a href="#h15-0-17" id="h15-0-17" class="d">-    private fun sendToBroadcastReceiver(bundle: Bundle) {
</a><a href="#h15-0-18" id="h15-0-18" class="d">-        val intent = Intent()
</a><a href="#h15-0-19" id="h15-0-19" class="d">-        intent.setClassName(BuildConfig.APPLICATION_ID, MediaDownloadReceiver::class.java.name)
</a><a href="#h15-0-20" id="h15-0-20" class="d">-        intent.action = MediaDownloadReceiver.DOWNLOAD_ACTION
</a><a href="#h15-0-21" id="h15-0-21" class="d">-        intent.putExtras(bundle)
</a><a href="#h15-0-22" id="h15-0-22" class="d">-        context.androidContext.sendBroadcast(intent)
</a><a href="#h15-0-23" id="h15-0-23" class="d">-    }
</a><a href="#h15-0-24" id="h15-0-24" class="d">-
</a><a href="#h15-0-25" id="h15-0-25" class="d">-    private fun sendToBroadcastReceiver(
</a><a href="#h15-0-26" id="h15-0-26" class="d">-        request: DownloadRequest,
</a><a href="#h15-0-27" id="h15-0-27" class="d">-        extras: Bundle.() -&gt; Unit = {}
</a><a href="#h15-0-28" id="h15-0-28" class="d">-    ) {
</a><a href="#h15-0-29" id="h15-0-29" class="d">-        sendToBroadcastReceiver(request.toBundle().apply {
</a><a href="#h15-0-30" id="h15-0-30" class="d">-            putString(&quot;outputPath&quot;, outputPath)
</a><a href="#h15-0-31" id="h15-0-31" class="d">-            putString(&quot;mediaDisplaySource&quot;, mediaDisplaySource)
</a><a href="#h15-0-32" id="h15-0-32" class="d">-            putString(&quot;mediaDisplayType&quot;, mediaDisplayType)
</a><a href="#h15-0-33" id="h15-0-33" class="d">-            putString(&quot;iconUrl&quot;, iconUrl)
</a><a href="#h15-0-34" id="h15-0-34" class="d">-        }.apply(extras))
</a><a href="#h15-0-35" id="h15-0-35" class="d">-    }
</a><a href="#h15-0-36" id="h15-0-36" class="d">-
</a><a href="#h15-0-37" id="h15-0-37" class="d">-    fun downloadDashMedia(playlistUrl: String, offsetTime: Long, duration: Long) {
</a><a href="#h15-0-38" id="h15-0-38" class="d">-        sendToBroadcastReceiver(
</a><a href="#h15-0-39" id="h15-0-39" class="d">-            DownloadRequest(
</a><a href="#h15-0-40" id="h15-0-40" class="d">-                inputMedias = arrayOf(playlistUrl),
</a><a href="#h15-0-41" id="h15-0-41" class="d">-                inputTypes = arrayOf(DownloadMediaType.REMOTE_MEDIA.name),
</a><a href="#h15-0-42" id="h15-0-42" class="d">-                flags = DownloadRequest.Flags.IS_DASH_PLAYLIST
</a><a href="#h15-0-43" id="h15-0-43" class="d">-            )
</a><a href="#h15-0-44" id="h15-0-44" class="d">-        ) {
</a><a href="#h15-0-45" id="h15-0-45" class="d">-            putBundle(&quot;dashOptions&quot;, Bundle().apply {
</a><a href="#h15-0-46" id="h15-0-46" class="d">-                putLong(&quot;offsetTime&quot;, offsetTime)
</a><a href="#h15-0-47" id="h15-0-47" class="d">-                putLong(&quot;duration&quot;, duration)
</a><a href="#h15-0-48" id="h15-0-48" class="d">-            })
</a><a href="#h15-0-49" id="h15-0-49" class="d">-        }
</a><a href="#h15-0-50" id="h15-0-50" class="d">-    }
</a><a href="#h15-0-51" id="h15-0-51" class="d">-
</a><a href="#h15-0-52" id="h15-0-52" class="d">-    fun downloadMedia(mediaData: String, mediaType: DownloadMediaType, encryption: MediaEncryptionKeyPair? = null) {
</a><a href="#h15-0-53" id="h15-0-53" class="d">-        sendToBroadcastReceiver(
</a><a href="#h15-0-54" id="h15-0-54" class="d">-            DownloadRequest(
</a><a href="#h15-0-55" id="h15-0-55" class="d">-                inputMedias = arrayOf(mediaData),
</a><a href="#h15-0-56" id="h15-0-56" class="d">-                inputTypes = arrayOf(mediaType.name),
</a><a href="#h15-0-57" id="h15-0-57" class="d">-                mediaEncryption = if (encryption != null) mapOf(mediaData to encryption) else mapOf()
</a><a href="#h15-0-58" id="h15-0-58" class="d">-            )
</a><a href="#h15-0-59" id="h15-0-59" class="d">-        )
</a><a href="#h15-0-60" id="h15-0-60" class="d">-    }
</a><a href="#h15-0-61" id="h15-0-61" class="d">-
</a><a href="#h15-0-62" id="h15-0-62" class="d">-    fun downloadMediaWithOverlay(
</a><a href="#h15-0-63" id="h15-0-63" class="d">-        videoData: String,
</a><a href="#h15-0-64" id="h15-0-64" class="d">-        overlayData: String,
</a><a href="#h15-0-65" id="h15-0-65" class="d">-        videoType: DownloadMediaType = DownloadMediaType.LOCAL_MEDIA,
</a><a href="#h15-0-66" id="h15-0-66" class="d">-        overlayType: DownloadMediaType = DownloadMediaType.LOCAL_MEDIA,
</a><a href="#h15-0-67" id="h15-0-67" class="d">-        videoEncryption: MediaEncryptionKeyPair? = null,
</a><a href="#h15-0-68" id="h15-0-68" class="d">-        overlayEncryption: MediaEncryptionKeyPair? = null)
</a><a href="#h15-0-69" id="h15-0-69" class="d">-    {
</a><a href="#h15-0-70" id="h15-0-70" class="d">-        val encryptionMap = mutableMapOf&lt;String, MediaEncryptionKeyPair&gt;()
</a><a href="#h15-0-71" id="h15-0-71" class="d">-
</a><a href="#h15-0-72" id="h15-0-72" class="d">-        if (videoEncryption != null) encryptionMap[videoData] = videoEncryption
</a><a href="#h15-0-73" id="h15-0-73" class="d">-        if (overlayEncryption != null) encryptionMap[overlayData] = overlayEncryption
</a><a href="#h15-0-74" id="h15-0-74" class="d">-        sendToBroadcastReceiver(DownloadRequest(
</a><a href="#h15-0-75" id="h15-0-75" class="d">-            inputMedias = arrayOf(videoData, overlayData),
</a><a href="#h15-0-76" id="h15-0-76" class="d">-            inputTypes = arrayOf(videoType.name, overlayType.name),
</a><a href="#h15-0-77" id="h15-0-77" class="d">-            mediaEncryption = encryptionMap,
</a><a href="#h15-0-78" id="h15-0-78" class="d">-            flags = DownloadRequest.Flags.SHOULD_MERGE_OVERLAY
</a><a href="#h15-0-79" id="h15-0-79" class="d">-        ))
</a><a href="#h15-0-80" id="h15-0-80" class="d">-    }
</a><a href="#h15-0-81" id="h15-0-81" class="d">-}</a><a href="#h15-0-82" id="h15-0-82" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h16" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadManagerClient.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadManagerClient.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadManagerClient.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadManagerClient.kt</a></b>
<a href="#h16-0" id="h16-0" class="h">@@ -0,0 +1,82 @@
</a><a href="#h16-0-0" id="h16-0-0" class="i">+package me.rhunk.snapenhance.download
</a><a href="#h16-0-1" id="h16-0-1" class="i">+
</a><a href="#h16-0-2" id="h16-0-2" class="i">+import android.content.Intent
</a><a href="#h16-0-3" id="h16-0-3" class="i">+import android.os.Bundle
</a><a href="#h16-0-4" id="h16-0-4" class="i">+import me.rhunk.snapenhance.BuildConfig
</a><a href="#h16-0-5" id="h16-0-5" class="i">+import me.rhunk.snapenhance.ModContext
</a><a href="#h16-0-6" id="h16-0-6" class="i">+import me.rhunk.snapenhance.download.data.DownloadRequest
</a><a href="#h16-0-7" id="h16-0-7" class="i">+import me.rhunk.snapenhance.download.data.MediaEncryptionKeyPair
</a><a href="#h16-0-8" id="h16-0-8" class="i">+import me.rhunk.snapenhance.download.enums.DownloadMediaType
</a><a href="#h16-0-9" id="h16-0-9" class="i">+
</a><a href="#h16-0-10" id="h16-0-10" class="i">+class DownloadManagerClient (
</a><a href="#h16-0-11" id="h16-0-11" class="i">+    private val context: ModContext,
</a><a href="#h16-0-12" id="h16-0-12" class="i">+    private val outputPath: String,
</a><a href="#h16-0-13" id="h16-0-13" class="i">+    private val mediaDisplaySource: String?,
</a><a href="#h16-0-14" id="h16-0-14" class="i">+    private val mediaDisplayType: String?,
</a><a href="#h16-0-15" id="h16-0-15" class="i">+    private val iconUrl: String?
</a><a href="#h16-0-16" id="h16-0-16" class="i">+) {
</a><a href="#h16-0-17" id="h16-0-17" class="i">+    private fun sendToBroadcastReceiver(bundle: Bundle) {
</a><a href="#h16-0-18" id="h16-0-18" class="i">+        val intent = Intent()
</a><a href="#h16-0-19" id="h16-0-19" class="i">+        intent.setClassName(BuildConfig.APPLICATION_ID, DownloadManagerReceiver::class.java.name)
</a><a href="#h16-0-20" id="h16-0-20" class="i">+        intent.action = DownloadManagerReceiver.DOWNLOAD_ACTION
</a><a href="#h16-0-21" id="h16-0-21" class="i">+        intent.putExtras(bundle)
</a><a href="#h16-0-22" id="h16-0-22" class="i">+        context.androidContext.sendBroadcast(intent)
</a><a href="#h16-0-23" id="h16-0-23" class="i">+    }
</a><a href="#h16-0-24" id="h16-0-24" class="i">+
</a><a href="#h16-0-25" id="h16-0-25" class="i">+    private fun sendToBroadcastReceiver(
</a><a href="#h16-0-26" id="h16-0-26" class="i">+        request: DownloadRequest,
</a><a href="#h16-0-27" id="h16-0-27" class="i">+        extras: Bundle.() -&gt; Unit = {}
</a><a href="#h16-0-28" id="h16-0-28" class="i">+    ) {
</a><a href="#h16-0-29" id="h16-0-29" class="i">+        sendToBroadcastReceiver(request.toBundle().apply {
</a><a href="#h16-0-30" id="h16-0-30" class="i">+            putString(&quot;outputPath&quot;, outputPath)
</a><a href="#h16-0-31" id="h16-0-31" class="i">+            putString(&quot;mediaDisplaySource&quot;, mediaDisplaySource)
</a><a href="#h16-0-32" id="h16-0-32" class="i">+            putString(&quot;mediaDisplayType&quot;, mediaDisplayType)
</a><a href="#h16-0-33" id="h16-0-33" class="i">+            putString(&quot;iconUrl&quot;, iconUrl)
</a><a href="#h16-0-34" id="h16-0-34" class="i">+        }.apply(extras))
</a><a href="#h16-0-35" id="h16-0-35" class="i">+    }
</a><a href="#h16-0-36" id="h16-0-36" class="i">+
</a><a href="#h16-0-37" id="h16-0-37" class="i">+    fun downloadDashMedia(playlistUrl: String, offsetTime: Long, duration: Long) {
</a><a href="#h16-0-38" id="h16-0-38" class="i">+        sendToBroadcastReceiver(
</a><a href="#h16-0-39" id="h16-0-39" class="i">+            DownloadRequest(
</a><a href="#h16-0-40" id="h16-0-40" class="i">+                inputMedias = arrayOf(playlistUrl),
</a><a href="#h16-0-41" id="h16-0-41" class="i">+                inputTypes = arrayOf(DownloadMediaType.REMOTE_MEDIA.name),
</a><a href="#h16-0-42" id="h16-0-42" class="i">+                flags = DownloadRequest.Flags.IS_DASH_PLAYLIST
</a><a href="#h16-0-43" id="h16-0-43" class="i">+            )
</a><a href="#h16-0-44" id="h16-0-44" class="i">+        ) {
</a><a href="#h16-0-45" id="h16-0-45" class="i">+            putBundle(&quot;dashOptions&quot;, Bundle().apply {
</a><a href="#h16-0-46" id="h16-0-46" class="i">+                putLong(&quot;offsetTime&quot;, offsetTime)
</a><a href="#h16-0-47" id="h16-0-47" class="i">+                putLong(&quot;duration&quot;, duration)
</a><a href="#h16-0-48" id="h16-0-48" class="i">+            })
</a><a href="#h16-0-49" id="h16-0-49" class="i">+        }
</a><a href="#h16-0-50" id="h16-0-50" class="i">+    }
</a><a href="#h16-0-51" id="h16-0-51" class="i">+
</a><a href="#h16-0-52" id="h16-0-52" class="i">+    fun downloadMedia(mediaData: String, mediaType: DownloadMediaType, encryption: MediaEncryptionKeyPair? = null) {
</a><a href="#h16-0-53" id="h16-0-53" class="i">+        sendToBroadcastReceiver(
</a><a href="#h16-0-54" id="h16-0-54" class="i">+            DownloadRequest(
</a><a href="#h16-0-55" id="h16-0-55" class="i">+                inputMedias = arrayOf(mediaData),
</a><a href="#h16-0-56" id="h16-0-56" class="i">+                inputTypes = arrayOf(mediaType.name),
</a><a href="#h16-0-57" id="h16-0-57" class="i">+                mediaEncryption = if (encryption != null) mapOf(mediaData to encryption) else mapOf()
</a><a href="#h16-0-58" id="h16-0-58" class="i">+            )
</a><a href="#h16-0-59" id="h16-0-59" class="i">+        )
</a><a href="#h16-0-60" id="h16-0-60" class="i">+    }
</a><a href="#h16-0-61" id="h16-0-61" class="i">+
</a><a href="#h16-0-62" id="h16-0-62" class="i">+    fun downloadMediaWithOverlay(
</a><a href="#h16-0-63" id="h16-0-63" class="i">+        videoData: String,
</a><a href="#h16-0-64" id="h16-0-64" class="i">+        overlayData: String,
</a><a href="#h16-0-65" id="h16-0-65" class="i">+        videoType: DownloadMediaType = DownloadMediaType.LOCAL_MEDIA,
</a><a href="#h16-0-66" id="h16-0-66" class="i">+        overlayType: DownloadMediaType = DownloadMediaType.LOCAL_MEDIA,
</a><a href="#h16-0-67" id="h16-0-67" class="i">+        videoEncryption: MediaEncryptionKeyPair? = null,
</a><a href="#h16-0-68" id="h16-0-68" class="i">+        overlayEncryption: MediaEncryptionKeyPair? = null)
</a><a href="#h16-0-69" id="h16-0-69" class="i">+    {
</a><a href="#h16-0-70" id="h16-0-70" class="i">+        val encryptionMap = mutableMapOf&lt;String, MediaEncryptionKeyPair&gt;()
</a><a href="#h16-0-71" id="h16-0-71" class="i">+
</a><a href="#h16-0-72" id="h16-0-72" class="i">+        if (videoEncryption != null) encryptionMap[videoData] = videoEncryption
</a><a href="#h16-0-73" id="h16-0-73" class="i">+        if (overlayEncryption != null) encryptionMap[overlayData] = overlayEncryption
</a><a href="#h16-0-74" id="h16-0-74" class="i">+        sendToBroadcastReceiver(DownloadRequest(
</a><a href="#h16-0-75" id="h16-0-75" class="i">+            inputMedias = arrayOf(videoData, overlayData),
</a><a href="#h16-0-76" id="h16-0-76" class="i">+            inputTypes = arrayOf(videoType.name, overlayType.name),
</a><a href="#h16-0-77" id="h16-0-77" class="i">+            mediaEncryption = encryptionMap,
</a><a href="#h16-0-78" id="h16-0-78" class="i">+            flags = DownloadRequest.Flags.SHOULD_MERGE_OVERLAY
</a><a href="#h16-0-79" id="h16-0-79" class="i">+        ))
</a><a href="#h16-0-80" id="h16-0-80" class="i">+    }
</a><a href="#h16-0-81" id="h16-0-81" class="i">+}</a><a href="#h16-0-82" id="h16-0-82" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h17" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadManagerReceiver.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadManagerReceiver.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadManagerReceiver.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadManagerReceiver.kt</a></b>
<a href="#h17-0" id="h17-0" class="h">@@ -0,0 +1,336 @@
</a><a href="#h17-0-0" id="h17-0-0" class="i">+package me.rhunk.snapenhance.download
</a><a href="#h17-0-1" id="h17-0-1" class="i">+
</a><a href="#h17-0-2" id="h17-0-2" class="i">+import android.content.BroadcastReceiver
</a><a href="#h17-0-3" id="h17-0-3" class="i">+import android.content.Context
</a><a href="#h17-0-4" id="h17-0-4" class="i">+import android.content.Intent
</a><a href="#h17-0-5" id="h17-0-5" class="i">+import android.media.MediaScannerConnection
</a><a href="#h17-0-6" id="h17-0-6" class="i">+import android.os.Handler
</a><a href="#h17-0-7" id="h17-0-7" class="i">+import android.widget.Toast
</a><a href="#h17-0-8" id="h17-0-8" class="i">+import kotlinx.coroutines.DelicateCoroutinesApi
</a><a href="#h17-0-9" id="h17-0-9" class="i">+import kotlinx.coroutines.Dispatchers
</a><a href="#h17-0-10" id="h17-0-10" class="i">+import kotlinx.coroutines.GlobalScope
</a><a href="#h17-0-11" id="h17-0-11" class="i">+import kotlinx.coroutines.Job
</a><a href="#h17-0-12" id="h17-0-12" class="i">+import kotlinx.coroutines.job
</a><a href="#h17-0-13" id="h17-0-13" class="i">+import kotlinx.coroutines.joinAll
</a><a href="#h17-0-14" id="h17-0-14" class="i">+import kotlinx.coroutines.launch
</a><a href="#h17-0-15" id="h17-0-15" class="i">+import kotlinx.coroutines.runBlocking
</a><a href="#h17-0-16" id="h17-0-16" class="i">+import me.rhunk.snapenhance.Constants
</a><a href="#h17-0-17" id="h17-0-17" class="i">+import me.rhunk.snapenhance.Logger
</a><a href="#h17-0-18" id="h17-0-18" class="i">+import me.rhunk.snapenhance.data.FileType
</a><a href="#h17-0-19" id="h17-0-19" class="i">+import me.rhunk.snapenhance.download.data.DownloadRequest
</a><a href="#h17-0-20" id="h17-0-20" class="i">+import me.rhunk.snapenhance.download.data.InputMedia
</a><a href="#h17-0-21" id="h17-0-21" class="i">+import me.rhunk.snapenhance.download.data.MediaEncryptionKeyPair
</a><a href="#h17-0-22" id="h17-0-22" class="i">+import me.rhunk.snapenhance.download.data.PendingDownload
</a><a href="#h17-0-23" id="h17-0-23" class="i">+import me.rhunk.snapenhance.download.enums.DownloadMediaType
</a><a href="#h17-0-24" id="h17-0-24" class="i">+import me.rhunk.snapenhance.download.enums.DownloadStage
</a><a href="#h17-0-25" id="h17-0-25" class="i">+import me.rhunk.snapenhance.SharedContext
</a><a href="#h17-0-26" id="h17-0-26" class="i">+import me.rhunk.snapenhance.util.snap.MediaDownloaderHelper
</a><a href="#h17-0-27" id="h17-0-27" class="i">+import me.rhunk.snapenhance.util.download.RemoteMediaResolver
</a><a href="#h17-0-28" id="h17-0-28" class="i">+import java.io.File
</a><a href="#h17-0-29" id="h17-0-29" class="i">+import java.io.InputStream
</a><a href="#h17-0-30" id="h17-0-30" class="i">+import java.net.HttpURLConnection
</a><a href="#h17-0-31" id="h17-0-31" class="i">+import java.net.URL
</a><a href="#h17-0-32" id="h17-0-32" class="i">+import java.util.zip.ZipInputStream
</a><a href="#h17-0-33" id="h17-0-33" class="i">+import javax.crypto.Cipher
</a><a href="#h17-0-34" id="h17-0-34" class="i">+import javax.crypto.CipherInputStream
</a><a href="#h17-0-35" id="h17-0-35" class="i">+import javax.crypto.spec.IvParameterSpec
</a><a href="#h17-0-36" id="h17-0-36" class="i">+import javax.crypto.spec.SecretKeySpec
</a><a href="#h17-0-37" id="h17-0-37" class="i">+import javax.xml.parsers.DocumentBuilderFactory
</a><a href="#h17-0-38" id="h17-0-38" class="i">+import javax.xml.transform.TransformerFactory
</a><a href="#h17-0-39" id="h17-0-39" class="i">+import javax.xml.transform.dom.DOMSource
</a><a href="#h17-0-40" id="h17-0-40" class="i">+import javax.xml.transform.stream.StreamResult
</a><a href="#h17-0-41" id="h17-0-41" class="i">+import kotlin.coroutines.coroutineContext
</a><a href="#h17-0-42" id="h17-0-42" class="i">+import kotlin.io.encoding.Base64
</a><a href="#h17-0-43" id="h17-0-43" class="i">+import kotlin.io.encoding.ExperimentalEncodingApi
</a><a href="#h17-0-44" id="h17-0-44" class="i">+
</a><a href="#h17-0-45" id="h17-0-45" class="i">+data class DownloadedFile(
</a><a href="#h17-0-46" id="h17-0-46" class="i">+    val file: File,
</a><a href="#h17-0-47" id="h17-0-47" class="i">+    val fileType: FileType
</a><a href="#h17-0-48" id="h17-0-48" class="i">+)
</a><a href="#h17-0-49" id="h17-0-49" class="i">+
</a><a href="#h17-0-50" id="h17-0-50" class="i">+/**
</a><a href="#h17-0-51" id="h17-0-51" class="i">+ * DownloadManagerReceiver handles the download requests of the user
</a><a href="#h17-0-52" id="h17-0-52" class="i">+ */
</a><a href="#h17-0-53" id="h17-0-53" class="i">+@OptIn(ExperimentalEncodingApi::class)
</a><a href="#h17-0-54" id="h17-0-54" class="i">+class DownloadManagerReceiver : BroadcastReceiver() {
</a><a href="#h17-0-55" id="h17-0-55" class="i">+    companion object {
</a><a href="#h17-0-56" id="h17-0-56" class="i">+        const val DOWNLOAD_ACTION = &quot;me.rhunk.snapenhance.download.DownloadManagerReceiver.DOWNLOAD_ACTION&quot;
</a><a href="#h17-0-57" id="h17-0-57" class="i">+    }
</a><a href="#h17-0-58" id="h17-0-58" class="i">+
</a><a href="#h17-0-59" id="h17-0-59" class="i">+    private val translation by lazy {
</a><a href="#h17-0-60" id="h17-0-60" class="i">+        SharedContext.translation.getCategory(&quot;download_manager_receiver&quot;)
</a><a href="#h17-0-61" id="h17-0-61" class="i">+    }
</a><a href="#h17-0-62" id="h17-0-62" class="i">+
</a><a href="#h17-0-63" id="h17-0-63" class="i">+    private lateinit var context: Context
</a><a href="#h17-0-64" id="h17-0-64" class="i">+
</a><a href="#h17-0-65" id="h17-0-65" class="i">+    private fun runOnUIThread(block: () -&gt; Unit) {
</a><a href="#h17-0-66" id="h17-0-66" class="i">+        Handler(context.mainLooper).post(block)
</a><a href="#h17-0-67" id="h17-0-67" class="i">+    }
</a><a href="#h17-0-68" id="h17-0-68" class="i">+
</a><a href="#h17-0-69" id="h17-0-69" class="i">+    private fun shortToast(text: String) {
</a><a href="#h17-0-70" id="h17-0-70" class="i">+        runOnUIThread {
</a><a href="#h17-0-71" id="h17-0-71" class="i">+            Toast.makeText(context, text, Toast.LENGTH_SHORT).show()
</a><a href="#h17-0-72" id="h17-0-72" class="i">+        }
</a><a href="#h17-0-73" id="h17-0-73" class="i">+    }
</a><a href="#h17-0-74" id="h17-0-74" class="i">+
</a><a href="#h17-0-75" id="h17-0-75" class="i">+    private fun longToast(text: String) {
</a><a href="#h17-0-76" id="h17-0-76" class="i">+        runOnUIThread {
</a><a href="#h17-0-77" id="h17-0-77" class="i">+            Toast.makeText(context, text, Toast.LENGTH_LONG).show()
</a><a href="#h17-0-78" id="h17-0-78" class="i">+        }
</a><a href="#h17-0-79" id="h17-0-79" class="i">+    }
</a><a href="#h17-0-80" id="h17-0-80" class="i">+
</a><a href="#h17-0-81" id="h17-0-81" class="i">+    private fun extractZip(inputStream: InputStream): List&lt;File&gt; {
</a><a href="#h17-0-82" id="h17-0-82" class="i">+        val files = mutableListOf&lt;File&gt;()
</a><a href="#h17-0-83" id="h17-0-83" class="i">+        val zipInputStream = ZipInputStream(inputStream)
</a><a href="#h17-0-84" id="h17-0-84" class="i">+        var entry = zipInputStream.nextEntry
</a><a href="#h17-0-85" id="h17-0-85" class="i">+
</a><a href="#h17-0-86" id="h17-0-86" class="i">+        while (entry != null) {
</a><a href="#h17-0-87" id="h17-0-87" class="i">+            createMediaTempFile().also { file -&gt;
</a><a href="#h17-0-88" id="h17-0-88" class="i">+                file.outputStream().use { outputStream -&gt;
</a><a href="#h17-0-89" id="h17-0-89" class="i">+                    zipInputStream.copyTo(outputStream)
</a><a href="#h17-0-90" id="h17-0-90" class="i">+                }
</a><a href="#h17-0-91" id="h17-0-91" class="i">+                files += file
</a><a href="#h17-0-92" id="h17-0-92" class="i">+            }
</a><a href="#h17-0-93" id="h17-0-93" class="i">+            entry = zipInputStream.nextEntry
</a><a href="#h17-0-94" id="h17-0-94" class="i">+        }
</a><a href="#h17-0-95" id="h17-0-95" class="i">+
</a><a href="#h17-0-96" id="h17-0-96" class="i">+        return files
</a><a href="#h17-0-97" id="h17-0-97" class="i">+    }
</a><a href="#h17-0-98" id="h17-0-98" class="i">+
</a><a href="#h17-0-99" id="h17-0-99" class="i">+    private fun decryptInputStream(inputStream: InputStream, encryption: MediaEncryptionKeyPair): InputStream {
</a><a href="#h17-0-100" id="h17-0-100" class="i">+        val cipher = Cipher.getInstance(&quot;AES/CBC/PKCS5Padding&quot;)
</a><a href="#h17-0-101" id="h17-0-101" class="i">+        val key = Base64.UrlSafe.decode(encryption.key)
</a><a href="#h17-0-102" id="h17-0-102" class="i">+        val iv = Base64.UrlSafe.decode(encryption.iv)
</a><a href="#h17-0-103" id="h17-0-103" class="i">+        cipher.init(Cipher.DECRYPT_MODE, SecretKeySpec(key, &quot;AES&quot;), IvParameterSpec(iv))
</a><a href="#h17-0-104" id="h17-0-104" class="i">+        return CipherInputStream(inputStream, cipher)
</a><a href="#h17-0-105" id="h17-0-105" class="i">+    }
</a><a href="#h17-0-106" id="h17-0-106" class="i">+
</a><a href="#h17-0-107" id="h17-0-107" class="i">+    private fun createNeededDirectories(file: File): File {
</a><a href="#h17-0-108" id="h17-0-108" class="i">+        val directory = file.parentFile ?: return file
</a><a href="#h17-0-109" id="h17-0-109" class="i">+        if (!directory.exists()) {
</a><a href="#h17-0-110" id="h17-0-110" class="i">+            directory.mkdirs()
</a><a href="#h17-0-111" id="h17-0-111" class="i">+        }
</a><a href="#h17-0-112" id="h17-0-112" class="i">+        return file
</a><a href="#h17-0-113" id="h17-0-113" class="i">+    }
</a><a href="#h17-0-114" id="h17-0-114" class="i">+
</a><a href="#h17-0-115" id="h17-0-115" class="i">+    private suspend fun saveMediaToGallery(inputFile: File, pendingDownload: PendingDownload) {
</a><a href="#h17-0-116" id="h17-0-116" class="i">+        if (coroutineContext.job.isCancelled) return
</a><a href="#h17-0-117" id="h17-0-117" class="i">+
</a><a href="#h17-0-118" id="h17-0-118" class="i">+        runCatching {
</a><a href="#h17-0-119" id="h17-0-119" class="i">+            val fileType = FileType.fromFile(inputFile)
</a><a href="#h17-0-120" id="h17-0-120" class="i">+            val outputFile = File(pendingDownload.outputPath + &quot;.&quot; + fileType.fileExtension).also { createNeededDirectories(it) }
</a><a href="#h17-0-121" id="h17-0-121" class="i">+            inputFile.copyTo(outputFile, overwrite = true)
</a><a href="#h17-0-122" id="h17-0-122" class="i">+
</a><a href="#h17-0-123" id="h17-0-123" class="i">+            MediaScannerConnection.scanFile(context, arrayOf(outputFile.absolutePath), null, null)
</a><a href="#h17-0-124" id="h17-0-124" class="i">+
</a><a href="#h17-0-125" id="h17-0-125" class="i">+            //print the path of the saved media
</a><a href="#h17-0-126" id="h17-0-126" class="i">+            val parentName = outputFile.parentFile?.parentFile?.absolutePath?.let {
</a><a href="#h17-0-127" id="h17-0-127" class="i">+                if (!it.endsWith(&quot;/&quot;)) &quot;$it/&quot; else it
</a><a href="#h17-0-128" id="h17-0-128" class="i">+            }
</a><a href="#h17-0-129" id="h17-0-129" class="i">+
</a><a href="#h17-0-130" id="h17-0-130" class="i">+            longToast(
</a><a href="#h17-0-131" id="h17-0-131" class="i">+                translation.format(&quot;saved_toast&quot;, &quot;path&quot; to outputFile.absolutePath.replace(parentName ?: &quot;&quot;, &quot;&quot;))
</a><a href="#h17-0-132" id="h17-0-132" class="i">+            )
</a><a href="#h17-0-133" id="h17-0-133" class="i">+
</a><a href="#h17-0-134" id="h17-0-134" class="i">+            pendingDownload.outputFile = outputFile.absolutePath
</a><a href="#h17-0-135" id="h17-0-135" class="i">+            pendingDownload.downloadStage = DownloadStage.SAVED
</a><a href="#h17-0-136" id="h17-0-136" class="i">+        }.onFailure {
</a><a href="#h17-0-137" id="h17-0-137" class="i">+            Logger.error(it)
</a><a href="#h17-0-138" id="h17-0-138" class="i">+            longToast(translation.format(&quot;failed_gallery_toast&quot;, &quot;error&quot; to it.toString()))
</a><a href="#h17-0-139" id="h17-0-139" class="i">+            pendingDownload.downloadStage = DownloadStage.FAILED
</a><a href="#h17-0-140" id="h17-0-140" class="i">+        }
</a><a href="#h17-0-141" id="h17-0-141" class="i">+    }
</a><a href="#h17-0-142" id="h17-0-142" class="i">+
</a><a href="#h17-0-143" id="h17-0-143" class="i">+    private fun createMediaTempFile(): File {
</a><a href="#h17-0-144" id="h17-0-144" class="i">+        return File.createTempFile(&quot;media&quot;, &quot;.tmp&quot;)
</a><a href="#h17-0-145" id="h17-0-145" class="i">+    }
</a><a href="#h17-0-146" id="h17-0-146" class="i">+
</a><a href="#h17-0-147" id="h17-0-147" class="i">+    private fun downloadInputMedias(downloadRequest: DownloadRequest) = runBlocking {
</a><a href="#h17-0-148" id="h17-0-148" class="i">+        val jobs = mutableListOf&lt;Job&gt;()
</a><a href="#h17-0-149" id="h17-0-149" class="i">+        val downloadedMedias = mutableMapOf&lt;InputMedia, File&gt;()
</a><a href="#h17-0-150" id="h17-0-150" class="i">+
</a><a href="#h17-0-151" id="h17-0-151" class="i">+        downloadRequest.getInputMedias().forEach { inputMedia -&gt;
</a><a href="#h17-0-152" id="h17-0-152" class="i">+            fun handleInputStream(inputStream: InputStream) {
</a><a href="#h17-0-153" id="h17-0-153" class="i">+                createMediaTempFile().apply {
</a><a href="#h17-0-154" id="h17-0-154" class="i">+                    if (inputMedia.encryption != null) {
</a><a href="#h17-0-155" id="h17-0-155" class="i">+                        decryptInputStream(inputStream, inputMedia.encryption).use { decryptedInputStream -&gt;
</a><a href="#h17-0-156" id="h17-0-156" class="i">+                            decryptedInputStream.copyTo(outputStream())
</a><a href="#h17-0-157" id="h17-0-157" class="i">+                        }
</a><a href="#h17-0-158" id="h17-0-158" class="i">+                    } else {
</a><a href="#h17-0-159" id="h17-0-159" class="i">+                        inputStream.copyTo(outputStream())
</a><a href="#h17-0-160" id="h17-0-160" class="i">+                    }
</a><a href="#h17-0-161" id="h17-0-161" class="i">+                }.also { downloadedMedias[inputMedia] = it }
</a><a href="#h17-0-162" id="h17-0-162" class="i">+            }
</a><a href="#h17-0-163" id="h17-0-163" class="i">+
</a><a href="#h17-0-164" id="h17-0-164" class="i">+            launch {
</a><a href="#h17-0-165" id="h17-0-165" class="i">+                when (inputMedia.type) {
</a><a href="#h17-0-166" id="h17-0-166" class="i">+                    DownloadMediaType.PROTO_MEDIA -&gt; {
</a><a href="#h17-0-167" id="h17-0-167" class="i">+                        RemoteMediaResolver.downloadBoltMedia(Base64.UrlSafe.decode(inputMedia.content))?.let { inputStream -&gt;
</a><a href="#h17-0-168" id="h17-0-168" class="i">+                            handleInputStream(inputStream)
</a><a href="#h17-0-169" id="h17-0-169" class="i">+                        }
</a><a href="#h17-0-170" id="h17-0-170" class="i">+                    }
</a><a href="#h17-0-171" id="h17-0-171" class="i">+                    DownloadMediaType.DIRECT_MEDIA -&gt; {
</a><a href="#h17-0-172" id="h17-0-172" class="i">+                        val decoded = Base64.UrlSafe.decode(inputMedia.content)
</a><a href="#h17-0-173" id="h17-0-173" class="i">+                        createMediaTempFile().apply {
</a><a href="#h17-0-174" id="h17-0-174" class="i">+                            writeBytes(decoded)
</a><a href="#h17-0-175" id="h17-0-175" class="i">+                        }.also { downloadedMedias[inputMedia] = it }
</a><a href="#h17-0-176" id="h17-0-176" class="i">+                    }
</a><a href="#h17-0-177" id="h17-0-177" class="i">+                    DownloadMediaType.REMOTE_MEDIA -&gt; {
</a><a href="#h17-0-178" id="h17-0-178" class="i">+                        with(URL(inputMedia.content).openConnection() as HttpURLConnection) {
</a><a href="#h17-0-179" id="h17-0-179" class="i">+                            requestMethod = &quot;GET&quot;
</a><a href="#h17-0-180" id="h17-0-180" class="i">+                            setRequestProperty(&quot;User-Agent&quot;, Constants.USER_AGENT)
</a><a href="#h17-0-181" id="h17-0-181" class="i">+                            connect()
</a><a href="#h17-0-182" id="h17-0-182" class="i">+                            handleInputStream(inputStream)
</a><a href="#h17-0-183" id="h17-0-183" class="i">+                        }
</a><a href="#h17-0-184" id="h17-0-184" class="i">+                    }
</a><a href="#h17-0-185" id="h17-0-185" class="i">+                    else -&gt; {
</a><a href="#h17-0-186" id="h17-0-186" class="i">+                        downloadedMedias[inputMedia] = File(inputMedia.content)
</a><a href="#h17-0-187" id="h17-0-187" class="i">+                    }
</a><a href="#h17-0-188" id="h17-0-188" class="i">+                }
</a><a href="#h17-0-189" id="h17-0-189" class="i">+            }.also { jobs.add(it) }
</a><a href="#h17-0-190" id="h17-0-190" class="i">+        }
</a><a href="#h17-0-191" id="h17-0-191" class="i">+
</a><a href="#h17-0-192" id="h17-0-192" class="i">+        jobs.joinAll()
</a><a href="#h17-0-193" id="h17-0-193" class="i">+        downloadedMedias
</a><a href="#h17-0-194" id="h17-0-194" class="i">+    }
</a><a href="#h17-0-195" id="h17-0-195" class="i">+
</a><a href="#h17-0-196" id="h17-0-196" class="i">+    private suspend fun downloadRemoteMedia(pendingDownloadObject:  PendingDownload, downloadedMedias: Map&lt;InputMedia, DownloadedFile&gt;, downloadRequest: DownloadRequest) {
</a><a href="#h17-0-197" id="h17-0-197" class="i">+        downloadRequest.getInputMedias().first().let { inputMedia -&gt;
</a><a href="#h17-0-198" id="h17-0-198" class="i">+            val mediaType = downloadRequest.getInputType(0)!!
</a><a href="#h17-0-199" id="h17-0-199" class="i">+            val media = downloadedMedias[inputMedia]!!
</a><a href="#h17-0-200" id="h17-0-200" class="i">+
</a><a href="#h17-0-201" id="h17-0-201" class="i">+            if (!downloadRequest.isDashPlaylist) {
</a><a href="#h17-0-202" id="h17-0-202" class="i">+                saveMediaToGallery(media.file, pendingDownloadObject)
</a><a href="#h17-0-203" id="h17-0-203" class="i">+                media.file.delete()
</a><a href="#h17-0-204" id="h17-0-204" class="i">+                return
</a><a href="#h17-0-205" id="h17-0-205" class="i">+            }
</a><a href="#h17-0-206" id="h17-0-206" class="i">+
</a><a href="#h17-0-207" id="h17-0-207" class="i">+            assert(mediaType == DownloadMediaType.REMOTE_MEDIA)
</a><a href="#h17-0-208" id="h17-0-208" class="i">+
</a><a href="#h17-0-209" id="h17-0-209" class="i">+            val playlistXml = DocumentBuilderFactory.newInstance().newDocumentBuilder().parse(media.file)
</a><a href="#h17-0-210" id="h17-0-210" class="i">+            val baseUrlNodeList = playlistXml.getElementsByTagName(&quot;BaseURL&quot;)
</a><a href="#h17-0-211" id="h17-0-211" class="i">+            for (i in 0 until baseUrlNodeList.length) {
</a><a href="#h17-0-212" id="h17-0-212" class="i">+                val baseUrlNode = baseUrlNodeList.item(i)
</a><a href="#h17-0-213" id="h17-0-213" class="i">+                val baseUrl = baseUrlNode.textContent
</a><a href="#h17-0-214" id="h17-0-214" class="i">+                baseUrlNode.textContent = &quot;${RemoteMediaResolver.CF_ST_CDN_D}$baseUrl&quot;
</a><a href="#h17-0-215" id="h17-0-215" class="i">+            }
</a><a href="#h17-0-216" id="h17-0-216" class="i">+
</a><a href="#h17-0-217" id="h17-0-217" class="i">+            val dashOptions = downloadRequest.getDashOptions()!!
</a><a href="#h17-0-218" id="h17-0-218" class="i">+
</a><a href="#h17-0-219" id="h17-0-219" class="i">+            val dashPlaylistFile = renameFromFileType(media.file, FileType.MPD)
</a><a href="#h17-0-220" id="h17-0-220" class="i">+            val xmlData = dashPlaylistFile.outputStream()
</a><a href="#h17-0-221" id="h17-0-221" class="i">+            TransformerFactory.newInstance().newTransformer().transform(DOMSource(playlistXml), StreamResult(xmlData))
</a><a href="#h17-0-222" id="h17-0-222" class="i">+
</a><a href="#h17-0-223" id="h17-0-223" class="i">+            longToast(translation.format(&quot;download_toast&quot;, &quot;path&quot; to dashPlaylistFile.nameWithoutExtension))
</a><a href="#h17-0-224" id="h17-0-224" class="i">+            val outputFile = File.createTempFile(&quot;dash&quot;, &quot;.mp4&quot;)
</a><a href="#h17-0-225" id="h17-0-225" class="i">+            runCatching {
</a><a href="#h17-0-226" id="h17-0-226" class="i">+                MediaDownloaderHelper.downloadDashChapterFile(
</a><a href="#h17-0-227" id="h17-0-227" class="i">+                    dashPlaylist = dashPlaylistFile,
</a><a href="#h17-0-228" id="h17-0-228" class="i">+                    output = outputFile,
</a><a href="#h17-0-229" id="h17-0-229" class="i">+                    startTime = dashOptions.offsetTime,
</a><a href="#h17-0-230" id="h17-0-230" class="i">+                    duration = dashOptions.duration)
</a><a href="#h17-0-231" id="h17-0-231" class="i">+                saveMediaToGallery(outputFile, pendingDownloadObject)
</a><a href="#h17-0-232" id="h17-0-232" class="i">+            }.onFailure {
</a><a href="#h17-0-233" id="h17-0-233" class="i">+                if (coroutineContext.job.isCancelled) return@onFailure
</a><a href="#h17-0-234" id="h17-0-234" class="i">+                Logger.error(it)
</a><a href="#h17-0-235" id="h17-0-235" class="i">+                longToast(translation.format(&quot;failed_processing_toast&quot;, &quot;error&quot; to it.toString()))
</a><a href="#h17-0-236" id="h17-0-236" class="i">+                pendingDownloadObject.downloadStage = DownloadStage.FAILED
</a><a href="#h17-0-237" id="h17-0-237" class="i">+            }
</a><a href="#h17-0-238" id="h17-0-238" class="i">+
</a><a href="#h17-0-239" id="h17-0-239" class="i">+            dashPlaylistFile.delete()
</a><a href="#h17-0-240" id="h17-0-240" class="i">+            outputFile.delete()
</a><a href="#h17-0-241" id="h17-0-241" class="i">+            media.file.delete()
</a><a href="#h17-0-242" id="h17-0-242" class="i">+        }
</a><a href="#h17-0-243" id="h17-0-243" class="i">+    }
</a><a href="#h17-0-244" id="h17-0-244" class="i">+
</a><a href="#h17-0-245" id="h17-0-245" class="i">+    private fun renameFromFileType(file: File, fileType: FileType): File {
</a><a href="#h17-0-246" id="h17-0-246" class="i">+        val newFile = File(file.parentFile, file.nameWithoutExtension + &quot;.&quot; + fileType.fileExtension)
</a><a href="#h17-0-247" id="h17-0-247" class="i">+        file.renameTo(newFile)
</a><a href="#h17-0-248" id="h17-0-248" class="i">+        return newFile
</a><a href="#h17-0-249" id="h17-0-249" class="i">+    }
</a><a href="#h17-0-250" id="h17-0-250" class="i">+
</a><a href="#h17-0-251" id="h17-0-251" class="i">+    @OptIn(DelicateCoroutinesApi::class)
</a><a href="#h17-0-252" id="h17-0-252" class="i">+    override fun onReceive(context: Context, intent: Intent) {
</a><a href="#h17-0-253" id="h17-0-253" class="i">+        if (intent.action != DOWNLOAD_ACTION) return
</a><a href="#h17-0-254" id="h17-0-254" class="i">+        this.context = context
</a><a href="#h17-0-255" id="h17-0-255" class="i">+        SharedContext.ensureInitialized(context)
</a><a href="#h17-0-256" id="h17-0-256" class="i">+
</a><a href="#h17-0-257" id="h17-0-257" class="i">+
</a><a href="#h17-0-258" id="h17-0-258" class="i">+        val downloadRequest = DownloadRequest.fromBundle(intent.extras!!)
</a><a href="#h17-0-259" id="h17-0-259" class="i">+
</a><a href="#h17-0-260" id="h17-0-260" class="i">+        GlobalScope.launch(Dispatchers.IO) {
</a><a href="#h17-0-261" id="h17-0-261" class="i">+            val pendingDownloadObject = PendingDownload.fromBundle(intent.extras!!)
</a><a href="#h17-0-262" id="h17-0-262" class="i">+
</a><a href="#h17-0-263" id="h17-0-263" class="i">+            SharedContext.downloadTaskManager.addTask(pendingDownloadObject)
</a><a href="#h17-0-264" id="h17-0-264" class="i">+            pendingDownloadObject.apply {
</a><a href="#h17-0-265" id="h17-0-265" class="i">+                job = coroutineContext.job
</a><a href="#h17-0-266" id="h17-0-266" class="i">+                downloadStage = DownloadStage.DOWNLOADING
</a><a href="#h17-0-267" id="h17-0-267" class="i">+            }
</a><a href="#h17-0-268" id="h17-0-268" class="i">+
</a><a href="#h17-0-269" id="h17-0-269" class="i">+            runCatching {
</a><a href="#h17-0-270" id="h17-0-270" class="i">+                //first download all input medias into cache
</a><a href="#h17-0-271" id="h17-0-271" class="i">+                val downloadedMedias = downloadInputMedias(downloadRequest).map {
</a><a href="#h17-0-272" id="h17-0-272" class="i">+                    it.key to DownloadedFile(it.value, FileType.fromFile(it.value))
</a><a href="#h17-0-273" id="h17-0-273" class="i">+                }.toMap().toMutableMap()
</a><a href="#h17-0-274" id="h17-0-274" class="i">+
</a><a href="#h17-0-275" id="h17-0-275" class="i">+                var shouldMergeOverlay = downloadRequest.shouldMergeOverlay
</a><a href="#h17-0-276" id="h17-0-276" class="i">+
</a><a href="#h17-0-277" id="h17-0-277" class="i">+                //if there is a zip file, extract it and replace the downloaded media with the extracted ones
</a><a href="#h17-0-278" id="h17-0-278" class="i">+                downloadedMedias.values.find { it.fileType == FileType.ZIP }?.let { entry -&gt;
</a><a href="#h17-0-279" id="h17-0-279" class="i">+                    val extractedMedias = extractZip(entry.file.inputStream()).map {
</a><a href="#h17-0-280" id="h17-0-280" class="i">+                        InputMedia(
</a><a href="#h17-0-281" id="h17-0-281" class="i">+                            type = DownloadMediaType.LOCAL_MEDIA,
</a><a href="#h17-0-282" id="h17-0-282" class="i">+                            content = it.absolutePath
</a><a href="#h17-0-283" id="h17-0-283" class="i">+                        ) to DownloadedFile(it, FileType.fromFile(it))
</a><a href="#h17-0-284" id="h17-0-284" class="i">+                    }
</a><a href="#h17-0-285" id="h17-0-285" class="i">+
</a><a href="#h17-0-286" id="h17-0-286" class="i">+                    downloadedMedias.values.removeIf {
</a><a href="#h17-0-287" id="h17-0-287" class="i">+                        it.file.delete()
</a><a href="#h17-0-288" id="h17-0-288" class="i">+                        true
</a><a href="#h17-0-289" id="h17-0-289" class="i">+                    }
</a><a href="#h17-0-290" id="h17-0-290" class="i">+
</a><a href="#h17-0-291" id="h17-0-291" class="i">+                    downloadedMedias.putAll(extractedMedias)
</a><a href="#h17-0-292" id="h17-0-292" class="i">+                    shouldMergeOverlay = true
</a><a href="#h17-0-293" id="h17-0-293" class="i">+                }
</a><a href="#h17-0-294" id="h17-0-294" class="i">+
</a><a href="#h17-0-295" id="h17-0-295" class="i">+                if (shouldMergeOverlay) {
</a><a href="#h17-0-296" id="h17-0-296" class="i">+                    assert(downloadedMedias.size == 2)
</a><a href="#h17-0-297" id="h17-0-297" class="i">+                    val media = downloadedMedias.values.first { it.fileType.isVideo }
</a><a href="#h17-0-298" id="h17-0-298" class="i">+                    val overlayMedia = downloadedMedias.values.first { it.fileType.isImage }
</a><a href="#h17-0-299" id="h17-0-299" class="i">+
</a><a href="#h17-0-300" id="h17-0-300" class="i">+                    val renamedMedia = renameFromFileType(media.file, media.fileType)
</a><a href="#h17-0-301" id="h17-0-301" class="i">+                    val renamedOverlayMedia = renameFromFileType(overlayMedia.file, overlayMedia.fileType)
</a><a href="#h17-0-302" id="h17-0-302" class="i">+                    val mergedOverlay: File = File.createTempFile(&quot;merged&quot;, &quot;.&quot; + media.fileType.fileExtension)
</a><a href="#h17-0-303" id="h17-0-303" class="i">+                    runCatching {
</a><a href="#h17-0-304" id="h17-0-304" class="i">+                        longToast(translation.format(&quot;download_toast&quot;, &quot;path&quot; to media.file.nameWithoutExtension))
</a><a href="#h17-0-305" id="h17-0-305" class="i">+                        pendingDownloadObject.downloadStage = DownloadStage.MERGING
</a><a href="#h17-0-306" id="h17-0-306" class="i">+
</a><a href="#h17-0-307" id="h17-0-307" class="i">+                        MediaDownloaderHelper.mergeOverlayFile(
</a><a href="#h17-0-308" id="h17-0-308" class="i">+                            media = renamedMedia,
</a><a href="#h17-0-309" id="h17-0-309" class="i">+                            overlay = renamedOverlayMedia,
</a><a href="#h17-0-310" id="h17-0-310" class="i">+                            output = mergedOverlay
</a><a href="#h17-0-311" id="h17-0-311" class="i">+                        )
</a><a href="#h17-0-312" id="h17-0-312" class="i">+
</a><a href="#h17-0-313" id="h17-0-313" class="i">+                        saveMediaToGallery(mergedOverlay, pendingDownloadObject)
</a><a href="#h17-0-314" id="h17-0-314" class="i">+                    }.onFailure {
</a><a href="#h17-0-315" id="h17-0-315" class="i">+                        if (coroutineContext.job.isCancelled) return@onFailure
</a><a href="#h17-0-316" id="h17-0-316" class="i">+                        Logger.error(it)
</a><a href="#h17-0-317" id="h17-0-317" class="i">+                        longToast(translation.format(&quot;failed_processing_toast&quot;, &quot;error&quot; to it.toString()))
</a><a href="#h17-0-318" id="h17-0-318" class="i">+                        pendingDownloadObject.downloadStage = DownloadStage.MERGE_FAILED
</a><a href="#h17-0-319" id="h17-0-319" class="i">+                    }
</a><a href="#h17-0-320" id="h17-0-320" class="i">+
</a><a href="#h17-0-321" id="h17-0-321" class="i">+                    mergedOverlay.delete()
</a><a href="#h17-0-322" id="h17-0-322" class="i">+                    renamedOverlayMedia.delete()
</a><a href="#h17-0-323" id="h17-0-323" class="i">+                    renamedMedia.delete()
</a><a href="#h17-0-324" id="h17-0-324" class="i">+                    return@launch
</a><a href="#h17-0-325" id="h17-0-325" class="i">+                }
</a><a href="#h17-0-326" id="h17-0-326" class="i">+
</a><a href="#h17-0-327" id="h17-0-327" class="i">+                downloadRemoteMedia(pendingDownloadObject, downloadedMedias, downloadRequest)
</a><a href="#h17-0-328" id="h17-0-328" class="i">+            }.onFailure {
</a><a href="#h17-0-329" id="h17-0-329" class="i">+                pendingDownloadObject.downloadStage = DownloadStage.FAILED
</a><a href="#h17-0-330" id="h17-0-330" class="i">+                Logger.error(it)
</a><a href="#h17-0-331" id="h17-0-331" class="i">+                longToast(translation[&quot;failed_generic_toast&quot;])
</a><a href="#h17-0-332" id="h17-0-332" class="i">+            }
</a><a href="#h17-0-333" id="h17-0-333" class="i">+        }
</a><a href="#h17-0-334" id="h17-0-334" class="i">+    }
</a><a href="#h17-0-335" id="h17-0-335" class="i">+}</a><a href="#h17-0-336" id="h17-0-336" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h18" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/download/MediaDownloadReceiver.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/download/MediaDownloadReceiver.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/download/MediaDownloadReceiver.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/download/MediaDownloadReceiver.kt</a></b>
<a href="#h18-0" id="h18-0" class="h">@@ -1,329 +0,0 @@
</a><a href="#h18-0-0" id="h18-0-0" class="d">-package me.rhunk.snapenhance.download
</a><a href="#h18-0-1" id="h18-0-1" class="d">-
</a><a href="#h18-0-2" id="h18-0-2" class="d">-import android.content.BroadcastReceiver
</a><a href="#h18-0-3" id="h18-0-3" class="d">-import android.content.Context
</a><a href="#h18-0-4" id="h18-0-4" class="d">-import android.content.Intent
</a><a href="#h18-0-5" id="h18-0-5" class="d">-import android.media.MediaScannerConnection
</a><a href="#h18-0-6" id="h18-0-6" class="d">-import android.os.Handler
</a><a href="#h18-0-7" id="h18-0-7" class="d">-import android.widget.Toast
</a><a href="#h18-0-8" id="h18-0-8" class="d">-import kotlinx.coroutines.DelicateCoroutinesApi
</a><a href="#h18-0-9" id="h18-0-9" class="d">-import kotlinx.coroutines.Dispatchers
</a><a href="#h18-0-10" id="h18-0-10" class="d">-import kotlinx.coroutines.GlobalScope
</a><a href="#h18-0-11" id="h18-0-11" class="d">-import kotlinx.coroutines.Job
</a><a href="#h18-0-12" id="h18-0-12" class="d">-import kotlinx.coroutines.job
</a><a href="#h18-0-13" id="h18-0-13" class="d">-import kotlinx.coroutines.joinAll
</a><a href="#h18-0-14" id="h18-0-14" class="d">-import kotlinx.coroutines.launch
</a><a href="#h18-0-15" id="h18-0-15" class="d">-import kotlinx.coroutines.runBlocking
</a><a href="#h18-0-16" id="h18-0-16" class="d">-import me.rhunk.snapenhance.Constants
</a><a href="#h18-0-17" id="h18-0-17" class="d">-import me.rhunk.snapenhance.Logger
</a><a href="#h18-0-18" id="h18-0-18" class="d">-import me.rhunk.snapenhance.data.FileType
</a><a href="#h18-0-19" id="h18-0-19" class="d">-import me.rhunk.snapenhance.download.data.DownloadRequest
</a><a href="#h18-0-20" id="h18-0-20" class="d">-import me.rhunk.snapenhance.download.data.InputMedia
</a><a href="#h18-0-21" id="h18-0-21" class="d">-import me.rhunk.snapenhance.download.data.MediaEncryptionKeyPair
</a><a href="#h18-0-22" id="h18-0-22" class="d">-import me.rhunk.snapenhance.download.data.PendingDownload
</a><a href="#h18-0-23" id="h18-0-23" class="d">-import me.rhunk.snapenhance.download.enums.DownloadMediaType
</a><a href="#h18-0-24" id="h18-0-24" class="d">-import me.rhunk.snapenhance.download.enums.DownloadStage
</a><a href="#h18-0-25" id="h18-0-25" class="d">-import me.rhunk.snapenhance.util.snap.MediaDownloaderHelper
</a><a href="#h18-0-26" id="h18-0-26" class="d">-import me.rhunk.snapenhance.util.download.RemoteMediaResolver
</a><a href="#h18-0-27" id="h18-0-27" class="d">-import java.io.File
</a><a href="#h18-0-28" id="h18-0-28" class="d">-import java.io.InputStream
</a><a href="#h18-0-29" id="h18-0-29" class="d">-import java.net.HttpURLConnection
</a><a href="#h18-0-30" id="h18-0-30" class="d">-import java.net.URL
</a><a href="#h18-0-31" id="h18-0-31" class="d">-import java.util.zip.ZipInputStream
</a><a href="#h18-0-32" id="h18-0-32" class="d">-import javax.crypto.Cipher
</a><a href="#h18-0-33" id="h18-0-33" class="d">-import javax.crypto.CipherInputStream
</a><a href="#h18-0-34" id="h18-0-34" class="d">-import javax.crypto.spec.IvParameterSpec
</a><a href="#h18-0-35" id="h18-0-35" class="d">-import javax.crypto.spec.SecretKeySpec
</a><a href="#h18-0-36" id="h18-0-36" class="d">-import javax.xml.parsers.DocumentBuilderFactory
</a><a href="#h18-0-37" id="h18-0-37" class="d">-import javax.xml.transform.TransformerFactory
</a><a href="#h18-0-38" id="h18-0-38" class="d">-import javax.xml.transform.dom.DOMSource
</a><a href="#h18-0-39" id="h18-0-39" class="d">-import javax.xml.transform.stream.StreamResult
</a><a href="#h18-0-40" id="h18-0-40" class="d">-import kotlin.coroutines.coroutineContext
</a><a href="#h18-0-41" id="h18-0-41" class="d">-import kotlin.io.encoding.Base64
</a><a href="#h18-0-42" id="h18-0-42" class="d">-import kotlin.io.encoding.ExperimentalEncodingApi
</a><a href="#h18-0-43" id="h18-0-43" class="d">-
</a><a href="#h18-0-44" id="h18-0-44" class="d">-data class DownloadedFile(
</a><a href="#h18-0-45" id="h18-0-45" class="d">-    val file: File,
</a><a href="#h18-0-46" id="h18-0-46" class="d">-    val fileType: FileType
</a><a href="#h18-0-47" id="h18-0-47" class="d">-)
</a><a href="#h18-0-48" id="h18-0-48" class="d">-
</a><a href="#h18-0-49" id="h18-0-49" class="d">-/**
</a><a href="#h18-0-50" id="h18-0-50" class="d">- * MediaDownloadReceiver handles the download of media files
</a><a href="#h18-0-51" id="h18-0-51" class="d">- */
</a><a href="#h18-0-52" id="h18-0-52" class="d">-@OptIn(ExperimentalEncodingApi::class)
</a><a href="#h18-0-53" id="h18-0-53" class="d">-class MediaDownloadReceiver : BroadcastReceiver() {
</a><a href="#h18-0-54" id="h18-0-54" class="d">-    companion object {
</a><a href="#h18-0-55" id="h18-0-55" class="d">-        val downloadTaskManager = DownloadTaskManager()
</a><a href="#h18-0-56" id="h18-0-56" class="d">-        const val DOWNLOAD_ACTION = &quot;me.rhunk.snapenhance.download.MediaDownloadReceiver.DOWNLOAD_ACTION&quot;
</a><a href="#h18-0-57" id="h18-0-57" class="d">-    }
</a><a href="#h18-0-58" id="h18-0-58" class="d">-
</a><a href="#h18-0-59" id="h18-0-59" class="d">-    private lateinit var context: Context
</a><a href="#h18-0-60" id="h18-0-60" class="d">-
</a><a href="#h18-0-61" id="h18-0-61" class="d">-    private fun runOnUIThread(block: () -&gt; Unit) {
</a><a href="#h18-0-62" id="h18-0-62" class="d">-        Handler(context.mainLooper).post(block)
</a><a href="#h18-0-63" id="h18-0-63" class="d">-    }
</a><a href="#h18-0-64" id="h18-0-64" class="d">-
</a><a href="#h18-0-65" id="h18-0-65" class="d">-    private fun shortToast(text: String) {
</a><a href="#h18-0-66" id="h18-0-66" class="d">-        runOnUIThread {
</a><a href="#h18-0-67" id="h18-0-67" class="d">-            Toast.makeText(context, text, Toast.LENGTH_SHORT).show()
</a><a href="#h18-0-68" id="h18-0-68" class="d">-        }
</a><a href="#h18-0-69" id="h18-0-69" class="d">-    }
</a><a href="#h18-0-70" id="h18-0-70" class="d">-
</a><a href="#h18-0-71" id="h18-0-71" class="d">-    private fun longToast(text: String) {
</a><a href="#h18-0-72" id="h18-0-72" class="d">-        runOnUIThread {
</a><a href="#h18-0-73" id="h18-0-73" class="d">-            Toast.makeText(context, text, Toast.LENGTH_LONG).show()
</a><a href="#h18-0-74" id="h18-0-74" class="d">-        }
</a><a href="#h18-0-75" id="h18-0-75" class="d">-    }
</a><a href="#h18-0-76" id="h18-0-76" class="d">-
</a><a href="#h18-0-77" id="h18-0-77" class="d">-    private fun extractZip(inputStream: InputStream): List&lt;File&gt; {
</a><a href="#h18-0-78" id="h18-0-78" class="d">-        val files = mutableListOf&lt;File&gt;()
</a><a href="#h18-0-79" id="h18-0-79" class="d">-        val zipInputStream = ZipInputStream(inputStream)
</a><a href="#h18-0-80" id="h18-0-80" class="d">-        var entry = zipInputStream.nextEntry
</a><a href="#h18-0-81" id="h18-0-81" class="d">-
</a><a href="#h18-0-82" id="h18-0-82" class="d">-        while (entry != null) {
</a><a href="#h18-0-83" id="h18-0-83" class="d">-            createMediaTempFile().also { file -&gt;
</a><a href="#h18-0-84" id="h18-0-84" class="d">-                file.outputStream().use { outputStream -&gt;
</a><a href="#h18-0-85" id="h18-0-85" class="d">-                    zipInputStream.copyTo(outputStream)
</a><a href="#h18-0-86" id="h18-0-86" class="d">-                }
</a><a href="#h18-0-87" id="h18-0-87" class="d">-                files += file
</a><a href="#h18-0-88" id="h18-0-88" class="d">-            }
</a><a href="#h18-0-89" id="h18-0-89" class="d">-            entry = zipInputStream.nextEntry
</a><a href="#h18-0-90" id="h18-0-90" class="d">-        }
</a><a href="#h18-0-91" id="h18-0-91" class="d">-
</a><a href="#h18-0-92" id="h18-0-92" class="d">-        return files
</a><a href="#h18-0-93" id="h18-0-93" class="d">-    }
</a><a href="#h18-0-94" id="h18-0-94" class="d">-
</a><a href="#h18-0-95" id="h18-0-95" class="d">-    private fun decryptInputStream(inputStream: InputStream, encryption: MediaEncryptionKeyPair): InputStream {
</a><a href="#h18-0-96" id="h18-0-96" class="d">-        val cipher = Cipher.getInstance(&quot;AES/CBC/PKCS5Padding&quot;)
</a><a href="#h18-0-97" id="h18-0-97" class="d">-        val key = Base64.UrlSafe.decode(encryption.key)
</a><a href="#h18-0-98" id="h18-0-98" class="d">-        val iv = Base64.UrlSafe.decode(encryption.iv)
</a><a href="#h18-0-99" id="h18-0-99" class="d">-        cipher.init(Cipher.DECRYPT_MODE, SecretKeySpec(key, &quot;AES&quot;), IvParameterSpec(iv))
</a><a href="#h18-0-100" id="h18-0-100" class="d">-        return CipherInputStream(inputStream, cipher)
</a><a href="#h18-0-101" id="h18-0-101" class="d">-    }
</a><a href="#h18-0-102" id="h18-0-102" class="d">-
</a><a href="#h18-0-103" id="h18-0-103" class="d">-    private fun createNeededDirectories(file: File): File {
</a><a href="#h18-0-104" id="h18-0-104" class="d">-        val directory = file.parentFile ?: return file
</a><a href="#h18-0-105" id="h18-0-105" class="d">-        if (!directory.exists()) {
</a><a href="#h18-0-106" id="h18-0-106" class="d">-            directory.mkdirs()
</a><a href="#h18-0-107" id="h18-0-107" class="d">-        }
</a><a href="#h18-0-108" id="h18-0-108" class="d">-        return file
</a><a href="#h18-0-109" id="h18-0-109" class="d">-    }
</a><a href="#h18-0-110" id="h18-0-110" class="d">-
</a><a href="#h18-0-111" id="h18-0-111" class="d">-    private suspend fun saveMediaToGallery(inputFile: File, pendingDownload: PendingDownload) {
</a><a href="#h18-0-112" id="h18-0-112" class="d">-        if (coroutineContext.job.isCancelled) return
</a><a href="#h18-0-113" id="h18-0-113" class="d">-
</a><a href="#h18-0-114" id="h18-0-114" class="d">-        runCatching {
</a><a href="#h18-0-115" id="h18-0-115" class="d">-            val fileType = FileType.fromFile(inputFile)
</a><a href="#h18-0-116" id="h18-0-116" class="d">-            val outputFile = File(pendingDownload.outputPath + &quot;.&quot; + fileType.fileExtension).also { createNeededDirectories(it) }
</a><a href="#h18-0-117" id="h18-0-117" class="d">-            inputFile.copyTo(outputFile, overwrite = true)
</a><a href="#h18-0-118" id="h18-0-118" class="d">-
</a><a href="#h18-0-119" id="h18-0-119" class="d">-            MediaScannerConnection.scanFile(context, arrayOf(outputFile.absolutePath), null, null)
</a><a href="#h18-0-120" id="h18-0-120" class="d">-
</a><a href="#h18-0-121" id="h18-0-121" class="d">-            //print the path of the saved media
</a><a href="#h18-0-122" id="h18-0-122" class="d">-            val parentName = outputFile.parentFile?.parentFile?.absolutePath?.let {
</a><a href="#h18-0-123" id="h18-0-123" class="d">-                if (!it.endsWith(&quot;/&quot;)) &quot;$it/&quot; else it
</a><a href="#h18-0-124" id="h18-0-124" class="d">-            }
</a><a href="#h18-0-125" id="h18-0-125" class="d">-
</a><a href="#h18-0-126" id="h18-0-126" class="d">-            longToast(&quot;Saved media to ${outputFile.absolutePath.replace(parentName ?: &quot;&quot;, &quot;&quot;)}&quot;)
</a><a href="#h18-0-127" id="h18-0-127" class="d">-
</a><a href="#h18-0-128" id="h18-0-128" class="d">-            pendingDownload.outputFile = outputFile.absolutePath
</a><a href="#h18-0-129" id="h18-0-129" class="d">-            pendingDownload.downloadStage = DownloadStage.SAVED
</a><a href="#h18-0-130" id="h18-0-130" class="d">-        }.onFailure {
</a><a href="#h18-0-131" id="h18-0-131" class="d">-            Logger.error(&quot;Failed to save media to gallery&quot;, it)
</a><a href="#h18-0-132" id="h18-0-132" class="d">-            longToast(&quot;Failed to save media to gallery&quot;)
</a><a href="#h18-0-133" id="h18-0-133" class="d">-            pendingDownload.downloadStage = DownloadStage.FAILED
</a><a href="#h18-0-134" id="h18-0-134" class="d">-        }
</a><a href="#h18-0-135" id="h18-0-135" class="d">-    }
</a><a href="#h18-0-136" id="h18-0-136" class="d">-
</a><a href="#h18-0-137" id="h18-0-137" class="d">-    private fun createMediaTempFile(): File {
</a><a href="#h18-0-138" id="h18-0-138" class="d">-        return File.createTempFile(&quot;media&quot;, &quot;.tmp&quot;)
</a><a href="#h18-0-139" id="h18-0-139" class="d">-    }
</a><a href="#h18-0-140" id="h18-0-140" class="d">-
</a><a href="#h18-0-141" id="h18-0-141" class="d">-    private fun downloadInputMedias(downloadRequest: DownloadRequest) = runBlocking {
</a><a href="#h18-0-142" id="h18-0-142" class="d">-        val jobs = mutableListOf&lt;Job&gt;()
</a><a href="#h18-0-143" id="h18-0-143" class="d">-        val downloadedMedias = mutableMapOf&lt;InputMedia, File&gt;()
</a><a href="#h18-0-144" id="h18-0-144" class="d">-
</a><a href="#h18-0-145" id="h18-0-145" class="d">-        downloadRequest.getInputMedias().forEach { inputMedia -&gt;
</a><a href="#h18-0-146" id="h18-0-146" class="d">-            fun handleInputStream(inputStream: InputStream) {
</a><a href="#h18-0-147" id="h18-0-147" class="d">-                createMediaTempFile().apply {
</a><a href="#h18-0-148" id="h18-0-148" class="d">-                    if (inputMedia.encryption != null) {
</a><a href="#h18-0-149" id="h18-0-149" class="d">-                        decryptInputStream(inputStream, inputMedia.encryption).use { decryptedInputStream -&gt;
</a><a href="#h18-0-150" id="h18-0-150" class="d">-                            decryptedInputStream.copyTo(outputStream())
</a><a href="#h18-0-151" id="h18-0-151" class="d">-                        }
</a><a href="#h18-0-152" id="h18-0-152" class="d">-                    } else {
</a><a href="#h18-0-153" id="h18-0-153" class="d">-                        inputStream.copyTo(outputStream())
</a><a href="#h18-0-154" id="h18-0-154" class="d">-                    }
</a><a href="#h18-0-155" id="h18-0-155" class="d">-                }.also { downloadedMedias[inputMedia] = it }
</a><a href="#h18-0-156" id="h18-0-156" class="d">-            }
</a><a href="#h18-0-157" id="h18-0-157" class="d">-
</a><a href="#h18-0-158" id="h18-0-158" class="d">-            launch {
</a><a href="#h18-0-159" id="h18-0-159" class="d">-                when (inputMedia.type) {
</a><a href="#h18-0-160" id="h18-0-160" class="d">-                    DownloadMediaType.PROTO_MEDIA -&gt; {
</a><a href="#h18-0-161" id="h18-0-161" class="d">-                        RemoteMediaResolver.downloadBoltMedia(Base64.UrlSafe.decode(inputMedia.content))?.let { inputStream -&gt;
</a><a href="#h18-0-162" id="h18-0-162" class="d">-                            handleInputStream(inputStream)
</a><a href="#h18-0-163" id="h18-0-163" class="d">-                        }
</a><a href="#h18-0-164" id="h18-0-164" class="d">-                    }
</a><a href="#h18-0-165" id="h18-0-165" class="d">-                    DownloadMediaType.DIRECT_MEDIA -&gt; {
</a><a href="#h18-0-166" id="h18-0-166" class="d">-                        val decoded = Base64.UrlSafe.decode(inputMedia.content)
</a><a href="#h18-0-167" id="h18-0-167" class="d">-                        createMediaTempFile().apply {
</a><a href="#h18-0-168" id="h18-0-168" class="d">-                            writeBytes(decoded)
</a><a href="#h18-0-169" id="h18-0-169" class="d">-                        }.also { downloadedMedias[inputMedia] = it }
</a><a href="#h18-0-170" id="h18-0-170" class="d">-                    }
</a><a href="#h18-0-171" id="h18-0-171" class="d">-                    DownloadMediaType.REMOTE_MEDIA -&gt; {
</a><a href="#h18-0-172" id="h18-0-172" class="d">-                        with(URL(inputMedia.content).openConnection() as HttpURLConnection) {
</a><a href="#h18-0-173" id="h18-0-173" class="d">-                            requestMethod = &quot;GET&quot;
</a><a href="#h18-0-174" id="h18-0-174" class="d">-                            setRequestProperty(&quot;User-Agent&quot;, Constants.USER_AGENT)
</a><a href="#h18-0-175" id="h18-0-175" class="d">-                            connect()
</a><a href="#h18-0-176" id="h18-0-176" class="d">-                            handleInputStream(inputStream)
</a><a href="#h18-0-177" id="h18-0-177" class="d">-                        }
</a><a href="#h18-0-178" id="h18-0-178" class="d">-                    }
</a><a href="#h18-0-179" id="h18-0-179" class="d">-                    else -&gt; {
</a><a href="#h18-0-180" id="h18-0-180" class="d">-                        downloadedMedias[inputMedia] = File(inputMedia.content)
</a><a href="#h18-0-181" id="h18-0-181" class="d">-                    }
</a><a href="#h18-0-182" id="h18-0-182" class="d">-                }
</a><a href="#h18-0-183" id="h18-0-183" class="d">-            }.also { jobs.add(it) }
</a><a href="#h18-0-184" id="h18-0-184" class="d">-        }
</a><a href="#h18-0-185" id="h18-0-185" class="d">-
</a><a href="#h18-0-186" id="h18-0-186" class="d">-        jobs.joinAll()
</a><a href="#h18-0-187" id="h18-0-187" class="d">-        downloadedMedias
</a><a href="#h18-0-188" id="h18-0-188" class="d">-    }
</a><a href="#h18-0-189" id="h18-0-189" class="d">-
</a><a href="#h18-0-190" id="h18-0-190" class="d">-    private suspend fun downloadRemoteMedia(pendingDownloadObject:  PendingDownload, downloadedMedias: Map&lt;InputMedia, DownloadedFile&gt;, downloadRequest: DownloadRequest) {
</a><a href="#h18-0-191" id="h18-0-191" class="d">-        downloadRequest.getInputMedias().first().let { inputMedia -&gt;
</a><a href="#h18-0-192" id="h18-0-192" class="d">-            val mediaType = downloadRequest.getInputType(0)!!
</a><a href="#h18-0-193" id="h18-0-193" class="d">-            val media = downloadedMedias[inputMedia]!!
</a><a href="#h18-0-194" id="h18-0-194" class="d">-
</a><a href="#h18-0-195" id="h18-0-195" class="d">-            if (!downloadRequest.isDashPlaylist) {
</a><a href="#h18-0-196" id="h18-0-196" class="d">-                saveMediaToGallery(media.file, pendingDownloadObject)
</a><a href="#h18-0-197" id="h18-0-197" class="d">-                media.file.delete()
</a><a href="#h18-0-198" id="h18-0-198" class="d">-                return
</a><a href="#h18-0-199" id="h18-0-199" class="d">-            }
</a><a href="#h18-0-200" id="h18-0-200" class="d">-
</a><a href="#h18-0-201" id="h18-0-201" class="d">-            assert(mediaType == DownloadMediaType.REMOTE_MEDIA)
</a><a href="#h18-0-202" id="h18-0-202" class="d">-
</a><a href="#h18-0-203" id="h18-0-203" class="d">-            val playlistXml = DocumentBuilderFactory.newInstance().newDocumentBuilder().parse(media.file)
</a><a href="#h18-0-204" id="h18-0-204" class="d">-            val baseUrlNodeList = playlistXml.getElementsByTagName(&quot;BaseURL&quot;)
</a><a href="#h18-0-205" id="h18-0-205" class="d">-            for (i in 0 until baseUrlNodeList.length) {
</a><a href="#h18-0-206" id="h18-0-206" class="d">-                val baseUrlNode = baseUrlNodeList.item(i)
</a><a href="#h18-0-207" id="h18-0-207" class="d">-                val baseUrl = baseUrlNode.textContent
</a><a href="#h18-0-208" id="h18-0-208" class="d">-                baseUrlNode.textContent = &quot;${RemoteMediaResolver.CF_ST_CDN_D}$baseUrl&quot;
</a><a href="#h18-0-209" id="h18-0-209" class="d">-            }
</a><a href="#h18-0-210" id="h18-0-210" class="d">-
</a><a href="#h18-0-211" id="h18-0-211" class="d">-            val dashOptions = downloadRequest.getDashOptions()!!
</a><a href="#h18-0-212" id="h18-0-212" class="d">-
</a><a href="#h18-0-213" id="h18-0-213" class="d">-            val dashPlaylistFile = renameFromFileType(media.file, FileType.MPD)
</a><a href="#h18-0-214" id="h18-0-214" class="d">-            val xmlData = dashPlaylistFile.outputStream()
</a><a href="#h18-0-215" id="h18-0-215" class="d">-            TransformerFactory.newInstance().newTransformer().transform(DOMSource(playlistXml), StreamResult(xmlData))
</a><a href="#h18-0-216" id="h18-0-216" class="d">-
</a><a href="#h18-0-217" id="h18-0-217" class="d">-            longToast(&quot;Downloading dash media...&quot;)
</a><a href="#h18-0-218" id="h18-0-218" class="d">-            val outputFile = File.createTempFile(&quot;dash&quot;, &quot;.mp4&quot;)
</a><a href="#h18-0-219" id="h18-0-219" class="d">-            runCatching {
</a><a href="#h18-0-220" id="h18-0-220" class="d">-                MediaDownloaderHelper.downloadDashChapterFile(
</a><a href="#h18-0-221" id="h18-0-221" class="d">-                    dashPlaylist = dashPlaylistFile,
</a><a href="#h18-0-222" id="h18-0-222" class="d">-                    output = outputFile,
</a><a href="#h18-0-223" id="h18-0-223" class="d">-                    startTime = dashOptions.offsetTime,
</a><a href="#h18-0-224" id="h18-0-224" class="d">-                    duration = dashOptions.duration)
</a><a href="#h18-0-225" id="h18-0-225" class="d">-                saveMediaToGallery(outputFile, pendingDownloadObject)
</a><a href="#h18-0-226" id="h18-0-226" class="d">-            }.onFailure {
</a><a href="#h18-0-227" id="h18-0-227" class="d">-                if (coroutineContext.job.isCancelled) return@onFailure
</a><a href="#h18-0-228" id="h18-0-228" class="d">-                Logger.error(&quot;failed to download dash media&quot;, it)
</a><a href="#h18-0-229" id="h18-0-229" class="d">-                longToast(&quot;Failed to download dash media: ${it.message}&quot;)
</a><a href="#h18-0-230" id="h18-0-230" class="d">-                pendingDownloadObject.downloadStage = DownloadStage.FAILED
</a><a href="#h18-0-231" id="h18-0-231" class="d">-            }
</a><a href="#h18-0-232" id="h18-0-232" class="d">-
</a><a href="#h18-0-233" id="h18-0-233" class="d">-            dashPlaylistFile.delete()
</a><a href="#h18-0-234" id="h18-0-234" class="d">-            outputFile.delete()
</a><a href="#h18-0-235" id="h18-0-235" class="d">-            media.file.delete()
</a><a href="#h18-0-236" id="h18-0-236" class="d">-        }
</a><a href="#h18-0-237" id="h18-0-237" class="d">-    }
</a><a href="#h18-0-238" id="h18-0-238" class="d">-
</a><a href="#h18-0-239" id="h18-0-239" class="d">-    private fun renameFromFileType(file: File, fileType: FileType): File {
</a><a href="#h18-0-240" id="h18-0-240" class="d">-        val newFile = File(file.parentFile, file.nameWithoutExtension + &quot;.&quot; + fileType.fileExtension)
</a><a href="#h18-0-241" id="h18-0-241" class="d">-        file.renameTo(newFile)
</a><a href="#h18-0-242" id="h18-0-242" class="d">-        return newFile
</a><a href="#h18-0-243" id="h18-0-243" class="d">-    }
</a><a href="#h18-0-244" id="h18-0-244" class="d">-
</a><a href="#h18-0-245" id="h18-0-245" class="d">-    @OptIn(DelicateCoroutinesApi::class)
</a><a href="#h18-0-246" id="h18-0-246" class="d">-    override fun onReceive(context: Context, intent: Intent) {
</a><a href="#h18-0-247" id="h18-0-247" class="d">-        if (intent.action != DOWNLOAD_ACTION) return
</a><a href="#h18-0-248" id="h18-0-248" class="d">-        this.context = context
</a><a href="#h18-0-249" id="h18-0-249" class="d">-        downloadTaskManager.init(context)
</a><a href="#h18-0-250" id="h18-0-250" class="d">-
</a><a href="#h18-0-251" id="h18-0-251" class="d">-        val downloadRequest = DownloadRequest.fromBundle(intent.extras!!)
</a><a href="#h18-0-252" id="h18-0-252" class="d">-
</a><a href="#h18-0-253" id="h18-0-253" class="d">-        GlobalScope.launch(Dispatchers.IO) {
</a><a href="#h18-0-254" id="h18-0-254" class="d">-            val pendingDownloadObject = PendingDownload.fromBundle(intent.extras!!)
</a><a href="#h18-0-255" id="h18-0-255" class="d">-
</a><a href="#h18-0-256" id="h18-0-256" class="d">-            downloadTaskManager.addTask(pendingDownloadObject)
</a><a href="#h18-0-257" id="h18-0-257" class="d">-            pendingDownloadObject.apply {
</a><a href="#h18-0-258" id="h18-0-258" class="d">-                job = coroutineContext.job
</a><a href="#h18-0-259" id="h18-0-259" class="d">-                downloadStage = DownloadStage.DOWNLOADING
</a><a href="#h18-0-260" id="h18-0-260" class="d">-            }
</a><a href="#h18-0-261" id="h18-0-261" class="d">-
</a><a href="#h18-0-262" id="h18-0-262" class="d">-            runCatching {
</a><a href="#h18-0-263" id="h18-0-263" class="d">-                //first download all input medias into cache
</a><a href="#h18-0-264" id="h18-0-264" class="d">-                val downloadedMedias = downloadInputMedias(downloadRequest).map {
</a><a href="#h18-0-265" id="h18-0-265" class="d">-                    it.key to DownloadedFile(it.value, FileType.fromFile(it.value))
</a><a href="#h18-0-266" id="h18-0-266" class="d">-                }.toMap().toMutableMap()
</a><a href="#h18-0-267" id="h18-0-267" class="d">-
</a><a href="#h18-0-268" id="h18-0-268" class="d">-                var shouldMergeOverlay = downloadRequest.shouldMergeOverlay
</a><a href="#h18-0-269" id="h18-0-269" class="d">-
</a><a href="#h18-0-270" id="h18-0-270" class="d">-                //if there is a zip file, extract it and replace the downloaded media with the extracted ones
</a><a href="#h18-0-271" id="h18-0-271" class="d">-                downloadedMedias.values.find { it.fileType == FileType.ZIP }?.let { entry -&gt;
</a><a href="#h18-0-272" id="h18-0-272" class="d">-                    val extractedMedias = extractZip(entry.file.inputStream()).map {
</a><a href="#h18-0-273" id="h18-0-273" class="d">-                        InputMedia(
</a><a href="#h18-0-274" id="h18-0-274" class="d">-                            type = DownloadMediaType.LOCAL_MEDIA,
</a><a href="#h18-0-275" id="h18-0-275" class="d">-                            content = it.absolutePath
</a><a href="#h18-0-276" id="h18-0-276" class="d">-                        ) to DownloadedFile(it, FileType.fromFile(it))
</a><a href="#h18-0-277" id="h18-0-277" class="d">-                    }
</a><a href="#h18-0-278" id="h18-0-278" class="d">-
</a><a href="#h18-0-279" id="h18-0-279" class="d">-                    downloadedMedias.values.removeIf {
</a><a href="#h18-0-280" id="h18-0-280" class="d">-                        it.file.delete()
</a><a href="#h18-0-281" id="h18-0-281" class="d">-                        true
</a><a href="#h18-0-282" id="h18-0-282" class="d">-                    }
</a><a href="#h18-0-283" id="h18-0-283" class="d">-
</a><a href="#h18-0-284" id="h18-0-284" class="d">-                    downloadedMedias.putAll(extractedMedias)
</a><a href="#h18-0-285" id="h18-0-285" class="d">-                    shouldMergeOverlay = true
</a><a href="#h18-0-286" id="h18-0-286" class="d">-                }
</a><a href="#h18-0-287" id="h18-0-287" class="d">-
</a><a href="#h18-0-288" id="h18-0-288" class="d">-                if (shouldMergeOverlay) {
</a><a href="#h18-0-289" id="h18-0-289" class="d">-                    assert(downloadedMedias.size == 2)
</a><a href="#h18-0-290" id="h18-0-290" class="d">-                    val media = downloadedMedias.values.first { it.fileType.isVideo }
</a><a href="#h18-0-291" id="h18-0-291" class="d">-                    val overlayMedia = downloadedMedias.values.first { it.fileType.isImage }
</a><a href="#h18-0-292" id="h18-0-292" class="d">-
</a><a href="#h18-0-293" id="h18-0-293" class="d">-                    val renamedMedia = renameFromFileType(media.file, media.fileType)
</a><a href="#h18-0-294" id="h18-0-294" class="d">-                    val renamedOverlayMedia = renameFromFileType(overlayMedia.file, overlayMedia.fileType)
</a><a href="#h18-0-295" id="h18-0-295" class="d">-                    val mergedOverlay: File = File.createTempFile(&quot;merged&quot;, &quot;.&quot; + media.fileType.fileExtension)
</a><a href="#h18-0-296" id="h18-0-296" class="d">-                    runCatching {
</a><a href="#h18-0-297" id="h18-0-297" class="d">-                        longToast(&quot;Merging overlay...&quot;)
</a><a href="#h18-0-298" id="h18-0-298" class="d">-                        pendingDownloadObject.downloadStage = DownloadStage.MERGING
</a><a href="#h18-0-299" id="h18-0-299" class="d">-
</a><a href="#h18-0-300" id="h18-0-300" class="d">-                        MediaDownloaderHelper.mergeOverlayFile(
</a><a href="#h18-0-301" id="h18-0-301" class="d">-                            media = renamedMedia,
</a><a href="#h18-0-302" id="h18-0-302" class="d">-                            overlay = renamedOverlayMedia,
</a><a href="#h18-0-303" id="h18-0-303" class="d">-                            output = mergedOverlay
</a><a href="#h18-0-304" id="h18-0-304" class="d">-                        )
</a><a href="#h18-0-305" id="h18-0-305" class="d">-
</a><a href="#h18-0-306" id="h18-0-306" class="d">-                        saveMediaToGallery(mergedOverlay, pendingDownloadObject)
</a><a href="#h18-0-307" id="h18-0-307" class="d">-                    }.onFailure {
</a><a href="#h18-0-308" id="h18-0-308" class="d">-                        if (coroutineContext.job.isCancelled) return@onFailure
</a><a href="#h18-0-309" id="h18-0-309" class="d">-                        Logger.error(&quot;failed to merge overlay&quot;, it)
</a><a href="#h18-0-310" id="h18-0-310" class="d">-                        longToast(&quot;Failed to merge overlay: ${it.message}&quot;)
</a><a href="#h18-0-311" id="h18-0-311" class="d">-                        pendingDownloadObject.downloadStage = DownloadStage.MERGE_FAILED
</a><a href="#h18-0-312" id="h18-0-312" class="d">-                    }
</a><a href="#h18-0-313" id="h18-0-313" class="d">-
</a><a href="#h18-0-314" id="h18-0-314" class="d">-                    mergedOverlay.delete()
</a><a href="#h18-0-315" id="h18-0-315" class="d">-                    renamedOverlayMedia.delete()
</a><a href="#h18-0-316" id="h18-0-316" class="d">-                    renamedMedia.delete()
</a><a href="#h18-0-317" id="h18-0-317" class="d">-                    return@launch
</a><a href="#h18-0-318" id="h18-0-318" class="d">-                }
</a><a href="#h18-0-319" id="h18-0-319" class="d">-
</a><a href="#h18-0-320" id="h18-0-320" class="d">-                downloadRemoteMedia(pendingDownloadObject, downloadedMedias, downloadRequest)
</a><a href="#h18-0-321" id="h18-0-321" class="d">-            }.onFailure {
</a><a href="#h18-0-322" id="h18-0-322" class="d">-                pendingDownloadObject.downloadStage = DownloadStage.FAILED
</a><a href="#h18-0-323" id="h18-0-323" class="d">-                Logger.error(&quot;failed to download media&quot;, it)
</a><a href="#h18-0-324" id="h18-0-324" class="d">-                longToast(&quot;Failed to download media: ${it.message}&quot;)
</a><a href="#h18-0-325" id="h18-0-325" class="d">-            }
</a><a href="#h18-0-326" id="h18-0-326" class="d">-        }
</a><a href="#h18-0-327" id="h18-0-327" class="d">-    }
</a><a href="#h18-0-328" id="h18-0-328" class="d">-}</a><a href="#h18-0-329" id="h18-0-329" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h19" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/download/data/PendingDownload.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/download/data/PendingDownload.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/download/data/PendingDownload.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/download/data/PendingDownload.kt</a></b>
<a href="#h19-0" id="h19-0" class="h">@@ -2,7 +2,7 @@ package me.rhunk.snapenhance.download.data
</a> 
 import android.os.Bundle
 import kotlinx.coroutines.Job
<a href="#h19-0-3" id="h19-0-3" class="d">-import me.rhunk.snapenhance.download.MediaDownloadReceiver
</a><a href="#h19-0-4" id="h19-0-4" class="i">+import me.rhunk.snapenhance.SharedContext
</a> import me.rhunk.snapenhance.download.enums.DownloadStage
 
 data class PendingDownload(
<a href="#h19-1" id="h19-1" class="h">@@ -35,7 +35,7 @@ data class PendingDownload(
</a>         set(value) = synchronized(this) {
             changeListener(_stage, value)
             _stage = value
<a href="#h19-1-3" id="h19-1-3" class="d">-            MediaDownloadReceiver.downloadTaskManager.updateTask(this)
</a><a href="#h19-1-4" id="h19-1-4" class="i">+            SharedContext.downloadTaskManager.updateTask(this)
</a>         }
 
     fun isJobActive(): Boolean {
<b>diff --git a/<a id="h20" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/AutoUpdater.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/AutoUpdater.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/AutoUpdater.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/AutoUpdater.kt</a></b>
<a href="#h20-0" id="h20-0" class="h">@@ -62,21 +62,21 @@ class AutoUpdater : Feature(&quot;AutoUpdater&quot;, loadParams = FeatureLoadParams.ACTIVI
</a> 
         context.runOnUiThread {
             AlertDialog.Builder(context.mainActivity)
<a href="#h20-0-3" id="h20-0-3" class="d">-                .setTitle(context.translation.get(&quot;auto_updater.dialog_title&quot;))
</a><a href="#h20-0-4" id="h20-0-4" class="i">+                .setTitle(context.translation[&quot;auto_updater.dialog_title&quot;])
</a>                 .setMessage(
<a href="#h20-0-6" id="h20-0-6" class="d">-                    context.translation.get(&quot;auto_updater.dialog_message&quot;)
</a><a href="#h20-0-7" id="h20-0-7" class="d">-                        .replace(&quot;{version}&quot;, latestVersion)
</a><a href="#h20-0-8" id="h20-0-8" class="d">-                        .replace(&quot;{body}&quot;, releaseContentBody)
</a><a href="#h20-0-9" id="h20-0-9" class="i">+                    context.translation.format(&quot;auto_updater.dialog_message&quot;,
</a><a href="#h20-0-10" id="h20-0-10" class="i">+                        &quot;version&quot; to latestVersion,
</a><a href="#h20-0-11" id="h20-0-11" class="i">+                        &quot;body&quot; to releaseContentBody)
</a>                 )
<a href="#h20-0-13" id="h20-0-13" class="d">-                .setNegativeButton(context.translation.get(&quot;auto_updater.dialog_negative_button&quot;)) { dialog, _ -&gt;
</a><a href="#h20-0-14" id="h20-0-14" class="i">+                .setNegativeButton(context.translation[&quot;auto_updater.dialog_negative_button&quot;]) { dialog, _ -&gt;
</a>                     dialog.dismiss()
                 }
<a href="#h20-0-17" id="h20-0-17" class="d">-                .setPositiveButton(context.translation.get(&quot;auto_updater.dialog_positive_button&quot;)) { dialog, _ -&gt;
</a><a href="#h20-0-18" id="h20-0-18" class="i">+                .setPositiveButton(context.translation[&quot;auto_updater.dialog_positive_button&quot;]) { dialog, _ -&gt;
</a>                     dialog.dismiss()
<a href="#h20-0-20" id="h20-0-20" class="d">-                    context.longToast(context.translation.get(&quot;auto_updater.downloading_toast&quot;))
</a><a href="#h20-0-21" id="h20-0-21" class="i">+                    context.longToast(context.translation[&quot;auto_updater.downloading_toast&quot;])
</a> 
                     val request = DownloadManager.Request(Uri.parse(downloadEndpoint))
<a href="#h20-0-24" id="h20-0-24" class="d">-                        .setTitle(context.translation.get(&quot;auto_updater.download_manager_notification_title&quot;))
</a><a href="#h20-0-25" id="h20-0-25" class="i">+                        .setTitle(context.translation[&quot;auto_updater.download_manager_notification_title&quot;])
</a>                         .setDestinationInExternalPublicDir(Environment.DIRECTORY_DOWNLOADS, &quot;latest-snapenhance.apk&quot;)
                         .setMimeType(&quot;application/vnd.android.package-archive&quot;)
                         .setNotificationVisibility(DownloadManager.Request.VISIBILITY_VISIBLE)
<b>diff --git a/<a id="h21" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/MediaDownloader.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/MediaDownloader.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/MediaDownloader.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/MediaDownloader.kt</a></b>
<a href="#h21-0" id="h21-0" class="h">@@ -19,7 +19,7 @@ import me.rhunk.snapenhance.data.wrapper.impl.media.dash.SnapPlaylistItem
</a> import me.rhunk.snapenhance.data.wrapper.impl.media.opera.Layer
 import me.rhunk.snapenhance.data.wrapper.impl.media.opera.ParamMap
 import me.rhunk.snapenhance.database.objects.FriendInfo
<a href="#h21-0-3" id="h21-0-3" class="d">-import me.rhunk.snapenhance.download.ClientDownloadManager
</a><a href="#h21-0-4" id="h21-0-4" class="i">+import me.rhunk.snapenhance.download.DownloadManagerClient
</a> import me.rhunk.snapenhance.download.data.toKeyPair
 import me.rhunk.snapenhance.download.enums.DownloadMediaType
 import me.rhunk.snapenhance.features.Feature
<a href="#h21-1" id="h21-1" class="h">@@ -59,7 +59,7 @@ class MediaDownloader : Feature(&quot;MediaDownloader&quot;, loadParams = FeatureLoadParam
</a>         mediaDisplaySource: String? = null,
         mediaDisplayType: String? = null,
         friendInfo: FriendInfo? = null
<a href="#h21-1-3" id="h21-1-3" class="d">-    ): ClientDownloadManager {
</a><a href="#h21-1-4" id="h21-1-4" class="i">+    ): DownloadManagerClient {
</a>         val iconUrl = friendInfo?.takeIf {
             it.bitmojiAvatarId != null &amp;&amp; it.bitmojiSelfieId != null
         }?.let {
<a href="#h21-2" id="h21-2" class="h">@@ -71,7 +71,7 @@ class MediaDownloader : Feature(&quot;MediaDownloader&quot;, loadParams = FeatureLoadParam
</a>             createNewFilePath(pathSuffix.hashCode(), pathSuffix)
         ).absolutePath
 
<a href="#h21-2-3" id="h21-2-3" class="d">-        return ClientDownloadManager(
</a><a href="#h21-2-4" id="h21-2-4" class="i">+        return DownloadManagerClient(
</a>             context = context,
             mediaDisplaySource = mediaDisplaySource,
             mediaDisplayType = mediaDisplayType,
<a href="#h21-3" id="h21-3" class="h">@@ -143,7 +143,7 @@ class MediaDownloader : Feature(&quot;MediaDownloader&quot;, loadParams = FeatureLoadParam
</a>         }
     }
 
<a href="#h21-3-3" id="h21-3-3" class="d">-    private fun downloadOperaMedia(clientDownloadManager: ClientDownloadManager, mediaInfoMap: Map&lt;MediaType, MediaInfo&gt;) {
</a><a href="#h21-3-4" id="h21-3-4" class="i">+    private fun downloadOperaMedia(downloadManagerClient: DownloadManagerClient, mediaInfoMap: Map&lt;MediaType, MediaInfo&gt;) {
</a>         if (mediaInfoMap.isEmpty()) return
 
         val originalMediaInfo = mediaInfoMap[MediaType.ORIGINAL]!!
<a href="#h21-4" id="h21-4" class="h">@@ -153,7 +153,7 @@ class MediaDownloader : Feature(&quot;MediaDownloader&quot;, loadParams = FeatureLoadParam
</a>         val overlayReference = overlay?.let { handleLocalReferences(it.uri) }
 
         overlay?.let {
<a href="#h21-4-3" id="h21-4-3" class="d">-            clientDownloadManager.downloadMediaWithOverlay(
</a><a href="#h21-4-4" id="h21-4-4" class="i">+            downloadManagerClient.downloadMediaWithOverlay(
</a>                 originalMediaInfoReference,
                 overlayReference!!,
                 DownloadMediaType.fromUri(Uri.parse(originalMediaInfoReference)),
<a href="#h21-5" id="h21-5" class="h">@@ -164,7 +164,7 @@ class MediaDownloader : Feature(&quot;MediaDownloader&quot;, loadParams = FeatureLoadParam
</a>             return
         }
 
<a href="#h21-5-3" id="h21-5-3" class="d">-        clientDownloadManager.downloadMedia(
</a><a href="#h21-5-4" id="h21-5-4" class="i">+        downloadManagerClient.downloadMedia(
</a>             originalMediaInfoReference,
             DownloadMediaType.fromUri(Uri.parse(originalMediaInfoReference)),
             originalMediaInfo.encryption?.toKeyPair()
<b>diff --git a/<a id="h22" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/manager/impl/FeatureManager.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/manager/impl/FeatureManager.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/manager/impl/FeatureManager.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/manager/impl/FeatureManager.kt</a></b>
<a href="#h22-0" id="h22-0" class="h">@@ -90,8 +90,7 @@ class FeatureManager(private val context: ModContext) : Manager {
</a>     }
 
     private fun featureInitializer(isAsync: Boolean, param: Int, action: (Feature) -&gt; Unit) {
<a href="#h22-0-3" id="h22-0-3" class="d">-        features.forEach { feature -&gt;
</a><a href="#h22-0-4" id="h22-0-4" class="d">-            if (feature.loadParams and param == 0) return@forEach
</a><a href="#h22-0-5" id="h22-0-5" class="i">+        features.filter { it.loadParams and param != 0 }.forEach { feature -&gt;
</a>             val callback = {
                 runCatching {
                     action(feature)
<b>diff --git a/<a id="h23" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/manager/impl/TranslationManager.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/manager/impl/TranslationManager.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/manager/impl/TranslationManager.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/manager/impl/TranslationManager.kt</a></b>
<a href="#h23-0" id="h23-0" class="h">@@ -1,43 +0,0 @@
</a><a href="#h23-0-0" id="h23-0-0" class="d">-package me.rhunk.snapenhance.manager.impl
</a><a href="#h23-0-1" id="h23-0-1" class="d">-
</a><a href="#h23-0-2" id="h23-0-2" class="d">-import com.google.gson.JsonObject
</a><a href="#h23-0-3" id="h23-0-3" class="d">-import com.google.gson.JsonParser
</a><a href="#h23-0-4" id="h23-0-4" class="d">-import me.rhunk.snapenhance.Logger
</a><a href="#h23-0-5" id="h23-0-5" class="d">-import me.rhunk.snapenhance.ModContext
</a><a href="#h23-0-6" id="h23-0-6" class="d">-import me.rhunk.snapenhance.manager.Manager
</a><a href="#h23-0-7" id="h23-0-7" class="d">-import java.util.Locale
</a><a href="#h23-0-8" id="h23-0-8" class="d">-
</a><a href="#h23-0-9" id="h23-0-9" class="d">-class TranslationManager(
</a><a href="#h23-0-10" id="h23-0-10" class="d">-    private val context: ModContext
</a><a href="#h23-0-11" id="h23-0-11" class="d">-) : Manager {
</a><a href="#h23-0-12" id="h23-0-12" class="d">-    private val translationMap = mutableMapOf&lt;String, String&gt;()
</a><a href="#h23-0-13" id="h23-0-13" class="d">-    lateinit var locale: Locale
</a><a href="#h23-0-14" id="h23-0-14" class="d">-
</a><a href="#h23-0-15" id="h23-0-15" class="d">-    override fun init() {
</a><a href="#h23-0-16" id="h23-0-16" class="d">-        val messageLocaleResult = context.bridgeClient.fetchTranslations()
</a><a href="#h23-0-17" id="h23-0-17" class="d">-        locale = messageLocaleResult.locale?.split(&quot;_&quot;)?.let { Locale(it[0], it[1]) } ?: Locale.getDefault()
</a><a href="#h23-0-18" id="h23-0-18" class="d">-
</a><a href="#h23-0-19" id="h23-0-19" class="d">-        val translations = JsonParser.parseString(messageLocaleResult.content?.toString(Charsets.UTF_8)).asJsonObject
</a><a href="#h23-0-20" id="h23-0-20" class="d">-        if (translations == null || translations.isJsonNull) {
</a><a href="#h23-0-21" id="h23-0-21" class="d">-            context.crash(&quot;Failed to fetch translations&quot;)
</a><a href="#h23-0-22" id="h23-0-22" class="d">-            return
</a><a href="#h23-0-23" id="h23-0-23" class="d">-        }
</a><a href="#h23-0-24" id="h23-0-24" class="d">-
</a><a href="#h23-0-25" id="h23-0-25" class="d">-        fun scanObject(jsonObject: JsonObject, prefix: String = &quot;&quot;) {
</a><a href="#h23-0-26" id="h23-0-26" class="d">-            jsonObject.entrySet().forEach {
</a><a href="#h23-0-27" id="h23-0-27" class="d">-                if (it.value.isJsonPrimitive) {
</a><a href="#h23-0-28" id="h23-0-28" class="d">-                    translationMap[&quot;$prefix${it.key}&quot;] = it.value.asString
</a><a href="#h23-0-29" id="h23-0-29" class="d">-                }
</a><a href="#h23-0-30" id="h23-0-30" class="d">-                if (!it.value.isJsonObject) return@forEach
</a><a href="#h23-0-31" id="h23-0-31" class="d">-                scanObject(it.value.asJsonObject, &quot;$prefix${it.key}.&quot;)
</a><a href="#h23-0-32" id="h23-0-32" class="d">-            }
</a><a href="#h23-0-33" id="h23-0-33" class="d">-        }
</a><a href="#h23-0-34" id="h23-0-34" class="d">-
</a><a href="#h23-0-35" id="h23-0-35" class="d">-        scanObject(translations)
</a><a href="#h23-0-36" id="h23-0-36" class="d">-    }
</a><a href="#h23-0-37" id="h23-0-37" class="d">-
</a><a href="#h23-0-38" id="h23-0-38" class="d">-
</a><a href="#h23-0-39" id="h23-0-39" class="d">-    fun get(key: String): String {
</a><a href="#h23-0-40" id="h23-0-40" class="d">-        return translationMap[key] ?: key.also { Logger.xposedLog(&quot;Missing translation for $key&quot;) }
</a><a href="#h23-0-41" id="h23-0-41" class="d">-    }
</a><a href="#h23-0-42" id="h23-0-42" class="d">-}</a><a href="#h23-0-43" id="h23-0-43" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h24" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/download/DownloadListAdapter.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/download/DownloadListAdapter.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/download/DownloadListAdapter.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/download/DownloadListAdapter.kt</a></b>
<a href="#h24-0" id="h24-0" class="h">@@ -31,6 +31,7 @@ import java.net.URL
</a> import kotlin.concurrent.thread
 
 class DownloadListAdapter(
<a href="#h24-0-3" id="h24-0-3" class="i">+    private val activity: DownloadManagerActivity,
</a>     private val downloadList: MutableList&lt;PendingDownload&gt;
 ): Adapter&lt;DownloadListAdapter.ViewHolder&gt;() {
     private val previewJobs = mutableMapOf&lt;Int, Job&gt;()
<a href="#h24-1" id="h24-1" class="h">@@ -56,15 +57,6 @@ class DownloadListAdapter(
</a>         return ViewHolder(LayoutInflater.from(parent.context).inflate(R.layout.download_manager_item, parent, false))
     }
 
<a href="#h24-1-3" id="h24-1-3" class="d">-    override fun onViewRecycled(holder: ViewHolder) {
</a><a href="#h24-1-4" id="h24-1-4" class="d">-        val download = downloadList.getOrNull(holder.bindingAdapterPosition) ?: return
</a><a href="#h24-1-5" id="h24-1-5" class="d">-
</a><a href="#h24-1-6" id="h24-1-6" class="d">-        previewJobs[holder.hashCode()]?.let {
</a><a href="#h24-1-7" id="h24-1-7" class="d">-            it.cancel()
</a><a href="#h24-1-8" id="h24-1-8" class="d">-            previewJobs.remove(holder.hashCode())
</a><a href="#h24-1-9" id="h24-1-9" class="d">-        }
</a><a href="#h24-1-10" id="h24-1-10" class="d">-    }
</a><a href="#h24-1-11" id="h24-1-11" class="d">-
</a>     override fun getItemCount(): Int {
         return downloadList.size
     }
<a href="#h24-2" id="h24-2" class="h">@@ -99,6 +91,11 @@ class DownloadListAdapter(
</a>         }
     }
 
<a href="#h24-2-3" id="h24-2-3" class="i">+    private val openButtonText by lazy {
</a><a href="#h24-2-4" id="h24-2-4" class="i">+        activity.translation[&quot;button.open&quot;]
</a><a href="#h24-2-5" id="h24-2-5" class="i">+    }
</a><a href="#h24-2-6" id="h24-2-6" class="i">+
</a><a href="#h24-2-7" id="h24-2-7" class="i">+
</a>     private fun updateViewHolder(download: PendingDownload, holder: ViewHolder) {
         holder.status.text = download.downloadStage.toString()
         holder.view.background = holder.view.context.getDrawable(R.drawable.download_manager_item_background)
<a href="#h24-3" id="h24-3" class="h">@@ -117,7 +114,10 @@ class DownloadListAdapter(
</a>             alpha = if (canInteract) 1f else 0.5f
             background = context.getDrawable(if (isSaved) R.drawable.action_button_success else R.drawable.action_button_cancel)
             setTextColor(context.getColor(if (isSaved) R.color.successColor else R.color.actionBarColor))
<a href="#h24-3-3" id="h24-3-3" class="d">-            text = if (isSaved) &quot;Open&quot; else &quot;Cancel&quot;
</a><a href="#h24-3-4" id="h24-3-4" class="i">+            text = if (isSaved)
</a><a href="#h24-3-5" id="h24-3-5" class="i">+                activity.translation[&quot;button.open&quot;]
</a><a href="#h24-3-6" id="h24-3-6" class="i">+            else
</a><a href="#h24-3-7" id="h24-3-7" class="i">+                activity.translation[&quot;button.cancel&quot;]
</a>         }
     }
 
<a href="#h24-4" id="h24-4" class="h">@@ -171,7 +171,7 @@ class DownloadListAdapter(
</a>             pendingDownload.outputFile?.let {
                 val file = File(it)
                 if (!file.exists()) {
<a href="#h24-4-3" id="h24-4-3" class="d">-                    Toast.makeText(holder.view.context, &quot;File does not exist&quot;, Toast.LENGTH_SHORT).show()
</a><a href="#h24-4-4" id="h24-4-4" class="i">+                    Toast.makeText(holder.view.context, activity.translation[&quot;file_not_found_toast&quot;], Toast.LENGTH_SHORT).show()
</a>                     return@setOnClickListener
                 }
                 val intent = Intent(Intent.ACTION_VIEW)
<b>diff --git a/<a id="h25" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/download/DownloadManagerActivity.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/download/DownloadManagerActivity.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/download/DownloadManagerActivity.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/download/DownloadManagerActivity.kt</a></b>
<a href="#h25-0" id="h25-0" class="h">@@ -10,7 +10,6 @@ import android.os.Bundle
</a> import android.os.PowerManager
 import android.provider.Settings
 import android.view.View
<a href="#h25-0-3" id="h25-0-3" class="d">-import android.view.ViewGroup
</a> import android.widget.Button
 import android.widget.ImageButton
 import android.widget.TextView
<a href="#h25-1" id="h25-1" class="h">@@ -18,24 +17,24 @@ import androidx.recyclerview.widget.ItemTouchHelper
</a> import androidx.recyclerview.widget.RecyclerView
 import me.rhunk.snapenhance.BuildConfig
 import me.rhunk.snapenhance.R
<a href="#h25-1-3" id="h25-1-3" class="d">-import me.rhunk.snapenhance.download.MediaDownloadReceiver
</a><a href="#h25-1-4" id="h25-1-4" class="i">+import me.rhunk.snapenhance.bridge.TranslationWrapper
</a><a href="#h25-1-5" id="h25-1-5" class="i">+import me.rhunk.snapenhance.SharedContext
</a> import me.rhunk.snapenhance.download.data.PendingDownload
 
 class DownloadManagerActivity : Activity() {
<a href="#h25-1-9" id="h25-1-9" class="i">+    lateinit var translation: TranslationWrapper
</a><a href="#h25-1-10" id="h25-1-10" class="i">+
</a>     private val backCallbacks = mutableListOf&lt;() -&gt; Unit&gt;()
     private val fetchedDownloadTasks = mutableListOf&lt;PendingDownload&gt;()
     private var listFilter = MediaFilter.NONE
 
<a href="#h25-1-15" id="h25-1-15" class="d">-    private val downloadTaskManager by lazy {
</a><a href="#h25-1-16" id="h25-1-16" class="d">-        MediaDownloadReceiver.downloadTaskManager.also { it.init(this) }
</a><a href="#h25-1-17" id="h25-1-17" class="d">-    }
</a><a href="#h25-1-18" id="h25-1-18" class="d">-
</a>     private val preferences by lazy {
         getSharedPreferences(&quot;settings&quot;, Context.MODE_PRIVATE)
     }
 
     private fun updateNoDownloadText() {
<a href="#h25-1-24" id="h25-1-24" class="d">-        findViewById&lt;View&gt;(R.id.no_download_title).let {
</a><a href="#h25-1-25" id="h25-1-25" class="i">+        findViewById&lt;TextView&gt;(R.id.no_download_title).let {
</a><a href="#h25-1-26" id="h25-1-26" class="i">+            it.text = translation[&quot;no_downloads&quot;]
</a>             it.visibility = if (fetchedDownloadTasks.isEmpty()) View.VISIBLE else View.GONE
         }
     }
<a href="#h25-2" id="h25-2" class="h">@@ -43,7 +42,7 @@ class DownloadManagerActivity : Activity() {
</a>     @SuppressLint(&quot;NotifyDataSetChanged&quot;)
     private fun updateListContent() {
         fetchedDownloadTasks.clear()
<a href="#h25-2-3" id="h25-2-3" class="d">-        fetchedDownloadTasks.addAll(downloadTaskManager.queryAllTasks(filter = listFilter).values)
</a><a href="#h25-2-4" id="h25-2-4" class="i">+        fetchedDownloadTasks.addAll(SharedContext.downloadTaskManager.queryAllTasks(filter = listFilter).values)
</a> 
         with(findViewById&lt;RecyclerView&gt;(R.id.download_list)) {
             adapter?.notifyDataSetChanged()
<a href="#h25-3" id="h25-3" class="h">@@ -68,6 +67,8 @@ class DownloadManagerActivity : Activity() {
</a>     @SuppressLint(&quot;BatteryLife&quot;, &quot;NotifyDataSetChanged&quot;, &quot;SetTextI18n&quot;)
     override fun onCreate(savedInstanceState: Bundle?) {
         super.onCreate(savedInstanceState)
<a href="#h25-3-3" id="h25-3-3" class="i">+        SharedContext.ensureInitialized(this)
</a><a href="#h25-3-4" id="h25-3-4" class="i">+        translation = SharedContext.translation.getCategory(&quot;download_manager_activity&quot;)
</a>         
         setContentView(R.layout.download_manager_activity)
 
<a href="#h25-4" id="h25-4" class="h">@@ -75,13 +76,13 @@ class DownloadManagerActivity : Activity() {
</a>         findViewById&lt;TextView&gt;(R.id.title).text = resources.getString(R.string.app_name) + &quot; &quot; + BuildConfig.VERSION_NAME
 
         findViewById&lt;ImageButton&gt;(R.id.settings_button).setOnClickListener {
<a href="#h25-4-3" id="h25-4-3" class="d">-            SettingLayoutInflater(this).inflate(findViewById&lt;ViewGroup&gt;(android.R.id.content))
</a><a href="#h25-4-4" id="h25-4-4" class="i">+            SettingLayoutInflater(this).inflate(findViewById(android.R.id.content))
</a>         }
         
         with(findViewById&lt;RecyclerView&gt;(R.id.download_list)) {
             layoutManager = androidx.recyclerview.widget.LinearLayoutManager(this@DownloadManagerActivity)
 
<a href="#h25-4-10" id="h25-4-10" class="d">-            adapter = DownloadListAdapter(fetchedDownloadTasks).apply {
</a><a href="#h25-4-11" id="h25-4-11" class="i">+            adapter = DownloadListAdapter(this@DownloadManagerActivity, fetchedDownloadTasks).apply {
</a>                 registerAdapterDataObserver(object : RecyclerView.AdapterDataObserver() {
                     override fun onItemRangeRemoved(positionStart: Int, itemCount: Int) {
                         updateNoDownloadText()
<a href="#h25-5" id="h25-5" class="h">@@ -113,7 +114,7 @@ class DownloadManagerActivity : Activity() {
</a>                 @SuppressLint(&quot;NotifyDataSetChanged&quot;)
                 override fun onSwiped(viewHolder: RecyclerView.ViewHolder, direction: Int) {
                     fetchedDownloadTasks.removeAt(viewHolder.absoluteAdapterPosition).let {
<a href="#h25-5-3" id="h25-5-3" class="d">-                        downloadTaskManager.removeTask(it)
</a><a href="#h25-5-4" id="h25-5-4" class="i">+                        SharedContext.downloadTaskManager.removeTask(it)
</a>                     }
                     adapter?.notifyItemRemoved(viewHolder.absoluteAdapterPosition)
                 }
<a href="#h25-6" id="h25-6" class="h">@@ -133,7 +134,7 @@ class DownloadManagerActivity : Activity() {
</a>                     if (lastVisibleItemPosition == fetchedDownloadTasks.size - 1 &amp;&amp; !isLoading) {
                         isLoading = true
 
<a href="#h25-6-3" id="h25-6-3" class="d">-                        downloadTaskManager.queryTasks(fetchedDownloadTasks.last().id, filter = listFilter).forEach {
</a><a href="#h25-6-4" id="h25-6-4" class="i">+                        SharedContext.downloadTaskManager.queryTasks(fetchedDownloadTasks.last().id, filter = listFilter).forEach {
</a>                             fetchedDownloadTasks.add(it.value)
                             adapter?.notifyItemInserted(fetchedDownloadTasks.size - 1)
                         }
<a href="#h25-7" id="h25-7" class="h">@@ -151,7 +152,9 @@ class DownloadManagerActivity : Activity() {
</a>                 Pair(R.id.spotlight_category, MediaFilter.SPOTLIGHT)
             ).let { categoryPairs -&gt;
                 categoryPairs.forEach { pair -&gt;
<a href="#h25-7-3" id="h25-7-3" class="d">-                    this@DownloadManagerActivity.findViewById&lt;TextView&gt;(pair.first).setOnClickListener { view -&gt;
</a><a href="#h25-7-4" id="h25-7-4" class="i">+                    this@DownloadManagerActivity.findViewById&lt;TextView&gt;(pair.first).apply {
</a><a href="#h25-7-5" id="h25-7-5" class="i">+                        text = translation[&quot;category.${resources.getResourceEntryName(pair.first)}&quot;]
</a><a href="#h25-7-6" id="h25-7-6" class="i">+                    }.setOnClickListener { view -&gt;
</a>                         listFilter = pair.second
                         updateListContent()
                         categoryPairs.map { this@DownloadManagerActivity.findViewById&lt;TextView&gt;(it.first) }.forEach {
<a href="#h25-8" id="h25-8" class="h">@@ -162,12 +165,14 @@ class DownloadManagerActivity : Activity() {
</a>                 }
             }
 
<a href="#h25-8-3" id="h25-8-3" class="d">-            this@DownloadManagerActivity.findViewById&lt;Button&gt;(R.id.remove_all_button).setOnClickListener {
</a><a href="#h25-8-4" id="h25-8-4" class="i">+            this@DownloadManagerActivity.findViewById&lt;Button&gt;(R.id.remove_all_button).also {
</a><a href="#h25-8-5" id="h25-8-5" class="i">+                it.text = translation[&quot;remove_all&quot;]
</a><a href="#h25-8-6" id="h25-8-6" class="i">+            }.setOnClickListener {
</a>                 with(AlertDialog.Builder(this@DownloadManagerActivity)) {
<a href="#h25-8-8" id="h25-8-8" class="d">-                    setTitle(R.string.remove_all_title)
</a><a href="#h25-8-9" id="h25-8-9" class="d">-                    setMessage(R.string.remove_all_text)
</a><a href="#h25-8-10" id="h25-8-10" class="d">-                    setPositiveButton(&quot;Yes&quot;) { _, _ -&gt;
</a><a href="#h25-8-11" id="h25-8-11" class="d">-                        downloadTaskManager.removeAllTasks()
</a><a href="#h25-8-12" id="h25-8-12" class="i">+                    setTitle(translation[&quot;remove_all_title&quot;])
</a><a href="#h25-8-13" id="h25-8-13" class="i">+                    setMessage(translation[&quot;remove_all_text&quot;])
</a><a href="#h25-8-14" id="h25-8-14" class="i">+                    setPositiveButton(translation[&quot;button.positive&quot;]) { _, _ -&gt;
</a><a href="#h25-8-15" id="h25-8-15" class="i">+                        SharedContext.downloadTaskManager.removeAllTasks()
</a>                         fetchedDownloadTasks.removeIf {
                             if (it.isJobActive()) it.cancel()
                             true
<a href="#h25-9" id="h25-9" class="h">@@ -175,7 +180,7 @@ class DownloadManagerActivity : Activity() {
</a>                         adapter?.notifyDataSetChanged()
                         updateNoDownloadText()
                     }
<a href="#h25-9-3" id="h25-9-3" class="d">-                    setNegativeButton(&quot;Cancel&quot;) { dialog, _ -&gt;
</a><a href="#h25-9-4" id="h25-9-4" class="i">+                    setNegativeButton(translation[&quot;button.negative&quot;]) { dialog, _ -&gt;
</a>                         dialog.dismiss()
                     }
                     show()
<b>diff --git a/<a id="h26" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/download/SettingLayoutInflater.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/download/SettingLayoutInflater.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/download/SettingLayoutInflater.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/download/SettingLayoutInflater.kt</a></b>
<a href="#h26-0" id="h26-0" class="h">@@ -39,49 +39,56 @@ class SettingLayoutInflater(
</a>             AlertDialog.Builder(activity)
                 .setTitle(title)
                 .setMessage(message)
<a href="#h26-0-3" id="h26-0-3" class="d">-                .setPositiveButton(&quot;Yes&quot;) { _, _ -&gt;
</a><a href="#h26-0-4" id="h26-0-4" class="i">+                .setPositiveButton(activity.translation[&quot;button.positive&quot;]) { _, _ -&gt;
</a>                     action()
                 }
<a href="#h26-0-7" id="h26-0-7" class="d">-                .setNegativeButton(&quot;No&quot;) { _, _ -&gt; }
</a><a href="#h26-0-8" id="h26-0-8" class="i">+                .setNegativeButton(activity.translation[&quot;button.negative&quot;]) { _, _ -&gt; }
</a>                 .show()
         }
     }
 
<a href="#h26-0-13" id="h26-0-13" class="i">+    private fun showSuccessToast() {
</a><a href="#h26-0-14" id="h26-0-14" class="i">+        Toast.makeText(activity, &quot;Success&quot;, Toast.LENGTH_SHORT).show()
</a><a href="#h26-0-15" id="h26-0-15" class="i">+    }
</a> 
     fun inflate(parent: ViewGroup) {
         val settingsView = activity.layoutInflater.inflate(R.layout.settings_page, parent, false)
 
<a href="#h26-0-20" id="h26-0-20" class="i">+        val settingTranslation = activity.translation.getCategory(&quot;settings_page&quot;)
</a><a href="#h26-0-21" id="h26-0-21" class="i">+
</a>         settingsView.findViewById&lt;ImageButton&gt;(R.id.settings_button).setOnClickListener {
             parent.removeView(settingsView)
         }
 
<a href="#h26-0-26" id="h26-0-26" class="i">+        settingsView.findViewById&lt;TextView&gt;(R.id.title).text = activity.translation[&quot;settings&quot;]
</a><a href="#h26-0-27" id="h26-0-27" class="i">+
</a>         settingsView.findViewById&lt;ListView&gt;(R.id.setting_page_list).apply {
             adapter = SettingAdapter(activity, R.layout.setting_item, mutableListOf&lt;Pair&lt;String, () -&gt; Unit&gt;&gt;().apply {
<a href="#h26-0-30" id="h26-0-30" class="d">-                add(&quot;Clear Cache&quot; to {
</a><a href="#h26-0-31" id="h26-0-31" class="i">+                add(settingTranslation[&quot;clear_cache_title&quot;] to {
</a>                     context.cacheDir.listFiles()?.forEach {
                         it.deleteRecursively()
                     }
<a href="#h26-0-35" id="h26-0-35" class="d">-                    Toast.makeText(context, &quot;Cache cleared&quot;, Toast.LENGTH_SHORT).show()
</a><a href="#h26-0-36" id="h26-0-36" class="i">+                    showSuccessToast()
</a>                 })
 
                 BridgeFileType.values().forEach { fileType -&gt;
<a href="#h26-0-40" id="h26-0-40" class="d">-                    val actionName = &quot;Clear ${fileType.displayName} File&quot;
</a><a href="#h26-0-41" id="h26-0-41" class="i">+                    val actionName = settingTranslation.format(&quot;clear_file_title&quot;, &quot;file_name&quot; to fileType.displayName)
</a>                     add(actionName to {
<a href="#h26-0-43" id="h26-0-43" class="d">-                        confirmAction(actionName, &quot;Are you sure you want to clear ${fileType.displayName} file?&quot;) {
</a><a href="#h26-0-44" id="h26-0-44" class="i">+                        confirmAction(actionName, settingTranslation.format(&quot;clear_file_confirmation&quot;, &quot;file_name&quot; to fileType.displayName)) {
</a>                             fileType.resolve(context).deleteRecursively()
<a href="#h26-0-46" id="h26-0-46" class="d">-                            Toast.makeText(context, &quot;${fileType.displayName} file cleared&quot;, Toast.LENGTH_SHORT).show()
</a><a href="#h26-0-47" id="h26-0-47" class="i">+                            showSuccessToast()
</a>                         }
                     })
                 }
 
<a href="#h26-0-52" id="h26-0-52" class="d">-                add(&quot;Reset All&quot; to {
</a><a href="#h26-0-53" id="h26-0-53" class="d">-                    confirmAction(&quot;Reset All&quot;, &quot;Are you sure you want to reset all?&quot;) {
</a><a href="#h26-0-54" id="h26-0-54" class="i">+                add(settingTranslation[&quot;reset_all_title&quot;] to {
</a><a href="#h26-0-55" id="h26-0-55" class="i">+                    confirmAction(settingTranslation[&quot;reset_all_title&quot;], settingTranslation[&quot;reset_all_confirmation&quot;]) {
</a>                         arrayOf(context.cacheDir, context.filesDir, File(context.dataDir, &quot;databases&quot;), File(context.dataDir, &quot;shared_prefs&quot;)).forEach {
                             it.listFiles()?.forEach { file -&gt;
                                 file.deleteRecursively()
                             }
                         }
<a href="#h26-0-61" id="h26-0-61" class="d">-                        Toast.makeText(context, &quot;Success!&quot;, Toast.LENGTH_SHORT).show()
</a><a href="#h26-0-62" id="h26-0-62" class="i">+                        showSuccessToast()
</a>                     }
                 })
             }.toTypedArray())
<b>diff --git a/<a id="h27" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/ChatActionMenu.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/ChatActionMenu.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/ChatActionMenu.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/ChatActionMenu.kt</a></b>
<a href="#h27-0" id="h27-0" class="h">@@ -57,7 +57,7 @@ class ChatActionMenu : AbstractMenu() {
</a> 
         if (context.config.bool(ConfigProperty.CHAT_DOWNLOAD_CONTEXT_MENU)) {
             injectButton(Button(viewGroup.context).apply {
<a href="#h27-0-3" id="h27-0-3" class="d">-                text = this@ChatActionMenu.context.translation.get(&quot;chat_action_menu.preview_button&quot;)
</a><a href="#h27-0-4" id="h27-0-4" class="i">+                text = this@ChatActionMenu.context.translation[&quot;chat_action_menu.preview_button&quot;]
</a>                 setOnClickListener {
                     closeActionMenu()
                     this@ChatActionMenu.context.executeAsync { this@ChatActionMenu.context.feature(MediaDownloader::class).onMessageActionMenu(true) }
<a href="#h27-1" id="h27-1" class="h">@@ -65,7 +65,7 @@ class ChatActionMenu : AbstractMenu() {
</a>             })
 
             injectButton(Button(viewGroup.context).apply {
<a href="#h27-1-3" id="h27-1-3" class="d">-                text = this@ChatActionMenu.context.translation.get(&quot;chat_action_menu.download_button&quot;)
</a><a href="#h27-1-4" id="h27-1-4" class="i">+                text = this@ChatActionMenu.context.translation[&quot;chat_action_menu.download_button&quot;]
</a>                 setOnClickListener {
                     closeActionMenu()
                     this@ChatActionMenu.context.executeAsync {
<a href="#h27-2" id="h27-2" class="h">@@ -80,7 +80,7 @@ class ChatActionMenu : AbstractMenu() {
</a>         //delete logged message button
         if (context.config.bool(ConfigProperty.MESSAGE_LOGGER)) {
             injectButton(Button(viewGroup.context).apply {
<a href="#h27-2-3" id="h27-2-3" class="d">-                text = this@ChatActionMenu.context.translation.get(&quot;chat_action_menu.delete_logged_message_button&quot;)
</a><a href="#h27-2-4" id="h27-2-4" class="i">+                text = this@ChatActionMenu.context.translation[&quot;chat_action_menu.delete_logged_message_button&quot;]
</a>                 setOnClickListener {
                     closeActionMenu()
                     this@ChatActionMenu.context.executeAsync {
<b>diff --git a/<a id="h28" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/FriendFeedInfoMenu.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/FriendFeedInfoMenu.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/FriendFeedInfoMenu.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/FriendFeedInfoMenu.kt</a></b>
<a href="#h28-0" id="h28-0" class="h">@@ -80,17 +80,18 @@ class FriendFeedInfoMenu : AbstractMenu() {
</a>             val birthday = Calendar.getInstance()
             birthday[Calendar.MONTH] = (profile.birthday shr 32).toInt() - 1
             val message: String = &quot;&quot;&quot;
<a href="#h28-0-3" id="h28-0-3" class="d">-                ${context.translation.get(&quot;profile_info.username&quot;)}: ${profile.username}
</a><a href="#h28-0-4" id="h28-0-4" class="d">-                ${context.translation.get(&quot;profile_info.display_name&quot;)}: ${profile.displayName}
</a><a href="#h28-0-5" id="h28-0-5" class="d">-                ${context.translation.get(&quot;profile_info.added_date&quot;)}: ${formatDate(addedTimestamp)}
</a><a href="#h28-0-6" id="h28-0-6" class="i">+                ${context.translation[&quot;profile_info.username&quot;]}: ${profile.username}
</a><a href="#h28-0-7" id="h28-0-7" class="i">+                ${context.translation[&quot;profile_info.display_name&quot;]}: ${profile.displayName}
</a><a href="#h28-0-8" id="h28-0-8" class="i">+                ${context.translation[&quot;profile_info.added_date&quot;]}: ${formatDate(addedTimestamp)}
</a>                 ${birthday.getDisplayName(
                     Calendar.MONTH,
                     Calendar.LONG,
                     context.translation.locale
                 )?.let {
<a href="#h28-0-14" id="h28-0-14" class="d">-                    context.translation.get(&quot;profile_info.birthday&quot;)
</a><a href="#h28-0-15" id="h28-0-15" class="d">-                        .replace(&quot;{month}&quot;, it)
</a><a href="#h28-0-16" id="h28-0-16" class="d">-                        .replace(&quot;{day}&quot;, profile.birthday.toInt().toString())
</a><a href="#h28-0-17" id="h28-0-17" class="i">+                    context.translation.format(&quot;profile_info.birthday&quot;,
</a><a href="#h28-0-18" id="h28-0-18" class="i">+                        &quot;month&quot; to it,
</a><a href="#h28-0-19" id="h28-0-19" class="i">+                        &quot;day&quot; to birthday[Calendar.DAY_OF_MONTH].toString()
</a><a href="#h28-0-20" id="h28-0-20" class="i">+                    )
</a>                 }
             }
             &quot;&quot;&quot;.trimIndent()
<a href="#h28-1" id="h28-1" class="h">@@ -136,7 +137,7 @@ class FriendFeedInfoMenu : AbstractMenu() {
</a>                 }
             }
 
<a href="#h28-1-3" id="h28-1-3" class="d">-            var displayUsername = sender?.displayName ?: sender?.usernameForSorting?: context.translation.get(&quot;conversation_preview.unknown_user&quot;)
</a><a href="#h28-1-4" id="h28-1-4" class="i">+            var displayUsername = sender?.displayName ?: sender?.usernameForSorting?: context.translation[&quot;conversation_preview.unknown_user&quot;]
</a> 
             if (displayUsername.length &gt; 12) {
                 displayUsername = displayUsername.substring(0, 13) + &quot;... &quot;
<a href="#h28-2" id="h28-2" class="h">@@ -152,22 +153,23 @@ class FriendFeedInfoMenu : AbstractMenu() {
</a>             val timeSecondDiff = ((it - System.currentTimeMillis()) / 1000 / 60).toInt()
             messageBuilder.append(&quot;\n\n&quot;)
                 .append(&quot;\uD83D\uDD25 &quot;) //fire emoji
<a href="#h28-2-3" id="h28-2-3" class="d">-                .append(context.translation.get(&quot;conversation_preview.streak_expiration&quot;).format(
</a><a href="#h28-2-4" id="h28-2-4" class="d">-                    timeSecondDiff / 60 / 24,
</a><a href="#h28-2-5" id="h28-2-5" class="d">-                    timeSecondDiff / 60 % 24,
</a><a href="#h28-2-6" id="h28-2-6" class="d">-                    timeSecondDiff % 60
</a><a href="#h28-2-7" id="h28-2-7" class="i">+                .append(
</a><a href="#h28-2-8" id="h28-2-8" class="i">+                    context.translation.format(&quot;conversation_preview.streak_expiration&quot;,
</a><a href="#h28-2-9" id="h28-2-9" class="i">+                    &quot;day&quot; to (timeSecondDiff / 60 / 24).toString(),
</a><a href="#h28-2-10" id="h28-2-10" class="i">+                    &quot;hour&quot; to (timeSecondDiff / 60 % 24).toString(),
</a><a href="#h28-2-11" id="h28-2-11" class="i">+                    &quot;minute&quot; to (timeSecondDiff % 60).toString()
</a>                 ))
         }
 
         //alert dialog
         val builder = AlertDialog.Builder(context.mainActivity)
<a href="#h28-2-17" id="h28-2-17" class="d">-        builder.setTitle(context.translation.get(&quot;conversation_preview.title&quot;))
</a><a href="#h28-2-18" id="h28-2-18" class="i">+        builder.setTitle(context.translation[&quot;conversation_preview.title&quot;])
</a>         builder.setMessage(messageBuilder.toString())
         builder.setPositiveButton(
             &quot;OK&quot;
         ) { dialog: DialogInterface, _: Int -&gt; dialog.dismiss() }
         targetPerson?.let {
<a href="#h28-2-24" id="h28-2-24" class="d">-            builder.setNegativeButton(context.translation.get(&quot;modal_option.profile_info&quot;)) {_, _ -&gt;
</a><a href="#h28-2-25" id="h28-2-25" class="i">+            builder.setNegativeButton(context.translation[&quot;modal_option.profile_info&quot;]) { _, _ -&gt;
</a>                 context.executeAsync {
                     showProfileInfo(it)
                 }
<a href="#h28-3" id="h28-3" class="h">@@ -208,7 +210,7 @@ class FriendFeedInfoMenu : AbstractMenu() {
</a> 
     private fun createToggleFeature(viewConsumer: ((View) -&gt; Unit), text: String, isChecked: () -&gt; Boolean, toggle: (Boolean) -&gt; Unit) {
         val switch = Switch(context.androidContext)
<a href="#h28-3-3" id="h28-3-3" class="d">-        switch.text = context.translation.get(text)
</a><a href="#h28-3-4" id="h28-3-4" class="i">+        switch.text = context.translation[text]
</a>         switch.isChecked = isChecked()
         ViewAppearanceHelper.applyTheme(switch)
         switch.setOnCheckedChangeListener { _: CompoundButton?, checked: Boolean -&gt;
<a href="#h28-4" id="h28-4" class="h">@@ -231,7 +233,7 @@ class FriendFeedInfoMenu : AbstractMenu() {
</a>         if (!context.config.bool(ConfigProperty.ENABLE_FRIEND_FEED_MENU_BAR)) {
             //preview button
             val previewButton = Button(viewModel.context).apply {
<a href="#h28-4-3" id="h28-4-3" class="d">-                text = modContext.translation.get(&quot;friend_menu_option.preview&quot;)
</a><a href="#h28-4-4" id="h28-4-4" class="i">+                text = modContext.translation[&quot;friend_menu_option.preview&quot;]
</a>                 ViewAppearanceHelper.applyTheme(this, viewModel.width)
                 setOnClickListener {
                     showPreview(
<a href="#h28-5" id="h28-5" class="h">@@ -244,7 +246,7 @@ class FriendFeedInfoMenu : AbstractMenu() {
</a> 
             //stealth switch
             val stealthSwitch = Switch(viewModel.context).apply {
<a href="#h28-5-3" id="h28-5-3" class="d">-                text = modContext.translation.get(&quot;friend_menu_option.stealth_mode&quot;)
</a><a href="#h28-5-4" id="h28-5-4" class="i">+                text = modContext.translation[&quot;friend_menu_option.stealth_mode&quot;]
</a>                 isChecked = modContext.feature(StealthMode::class).isStealth(conversationId)
                 ViewAppearanceHelper.applyTheme(this)
                 setOnCheckedChangeListener { _: CompoundButton?, isChecked: Boolean -&gt;
<b>diff --git a/<a id="h29" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/OperaContextActionMenu.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/OperaContextActionMenu.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/OperaContextActionMenu.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/OperaContextActionMenu.kt</a></b>
<a href="#h29-0" id="h29-0" class="h">@@ -70,7 +70,7 @@ class OperaContextActionMenu : AbstractMenu() {
</a>                     ViewGroup.LayoutParams.MATCH_PARENT
                 )
             val button = Button(childView.getContext())
<a href="#h29-0-3" id="h29-0-3" class="d">-            button.text = context.translation.get(&quot;opera_context_menu.download&quot;)
</a><a href="#h29-0-4" id="h29-0-4" class="i">+            button.text = context.translation[&quot;opera_context_menu.download&quot;]
</a>             button.setOnClickListener { context.feature(MediaDownloader::class).downloadLastOperaMediaAsync() }
             applyTheme(button)
             linearLayout.addView(button)
<b>diff --git a/<a id="h30" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/SettingsMenu.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/SettingsMenu.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/SettingsMenu.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/SettingsMenu.kt</a></b>
<a href="#h30-0" id="h30-0" class="h">@@ -26,7 +26,7 @@ class SettingsMenu : AbstractMenu() {
</a>     @SuppressLint(&quot;ClickableViewAccessibility&quot;)
     private fun createCategoryTitle(key: String): TextView {
         val categoryText = TextView(context.androidContext)
<a href="#h30-0-3" id="h30-0-3" class="d">-        categoryText.text = context.translation.get(key)
</a><a href="#h30-0-4" id="h30-0-4" class="i">+        categoryText.text = context.translation[key]
</a>         ViewAppearanceHelper.applyTheme(categoryText)
         categoryText.textSize = 20f
         categoryText.typeface = categoryText.typeface?.let { Typeface.create(it, Typeface.BOLD) }
<a href="#h30-1" id="h30-1" class="h">@@ -36,7 +36,7 @@ class SettingsMenu : AbstractMenu() {
</a> 
     @SuppressLint(&quot;SetTextI18n&quot;)
     private fun createPropertyView(property: ConfigProperty): View {
<a href="#h30-1-3" id="h30-1-3" class="d">-        val propertyName = context.translation.get(property.nameKey)
</a><a href="#h30-1-4" id="h30-1-4" class="i">+        val propertyName = context.translation[&quot;property.${property.translationKey}&quot;]
</a>         val updateButtonText: (TextView, String) -&gt; Unit = { textView, text -&gt;
             textView.text = &quot;$propertyName${if (text.isEmpty()) &quot;&quot; else &quot;: $text&quot;}&quot;
         }
<a href="#h30-2" id="h30-2" class="h">@@ -50,7 +50,7 @@ class SettingsMenu : AbstractMenu() {
</a>                     if (property.disableValueLocalization) {
                         it
                     } else {
<a href="#h30-2-3" id="h30-2-3" class="d">-                        context.translation.get(&quot;option.&quot; + property.nameKey + &quot;.&quot; + it)
</a><a href="#h30-2-4" id="h30-2-4" class="i">+                        context.translation[&quot;option.property.&quot; + property.translationKey + &quot;.&quot; + it]
</a>                     }
                 }
             })
<a href="#h30-3" id="h30-3" class="h">@@ -129,7 +129,7 @@ class SettingsMenu : AbstractMenu() {
</a>                     builder.setSingleChoiceItems(
                         property.valueContainer.keys().toTypedArray().map {
                             if (property.disableValueLocalization) it
<a href="#h30-3-3" id="h30-3-3" class="d">-                            else context.translation.get(&quot;option.&quot; + property.nameKey + &quot;.&quot; + it)
</a><a href="#h30-3-4" id="h30-3-4" class="i">+                            else context.translation[&quot;option.property.&quot; + property.translationKey + &quot;.&quot; + it]
</a>                         }.toTypedArray(),
                         property.valueContainer.keys().indexOf(property.valueContainer.value())
                     ) { _, which -&gt;
<a href="#h30-4" id="h30-4" class="h">@@ -158,7 +158,7 @@ class SettingsMenu : AbstractMenu() {
</a>                     builder.setMultiChoiceItems(
                         sortedStates.toSortedMap().map {
                             if (property.disableValueLocalization) it.key
<a href="#h30-4-3" id="h30-4-3" class="d">-                            else context.translation.get(&quot;option.&quot; + property.nameKey + &quot;.&quot; + it.key)
</a><a href="#h30-4-4" id="h30-4-4" class="i">+                            else context.translation[&quot;option.property.&quot; + property.translationKey + &quot;.&quot; + it.key]
</a>                         }.toTypedArray(),
                         sortedStates.map { it.value }.toBooleanArray()
                     ) { _, which, isChecked -&gt;
<a href="#h30-5" id="h30-5" class="h">@@ -212,7 +212,7 @@ class SettingsMenu : AbstractMenu() {
</a>         val actions = context.actionManager.getActions().map {
             Pair(it) {
                 val button = Button(viewModel.context)
<a href="#h30-5-3" id="h30-5-3" class="d">-                button.text = context.translation.get(it.nameKey)
</a><a href="#h30-5-4" id="h30-5-4" class="i">+                button.text = context.translation[it.nameKey]
</a>                 button.setOnClickListener { _ -&gt;
                     it.run()
                 }
<b>diff --git a/<a id="h31" href="../file/app/src/main/res/layout/download_manager_activity.xml.html">app/src/main/res/layout/download_manager_activity.xml</a> b/<a href="../file/app/src/main/res/layout/download_manager_activity.xml.html">app/src/main/res/layout/download_manager_activity.xml</a></b>
<a href="#h31-0" id="h31-0" class="h">@@ -34,7 +34,7 @@
</a>             android:src=&quot;@drawable/settings_icon&quot;
             android:layout_gravity=&quot;center_vertical|end&quot;
             android:padding=&quot;8dp&quot;
<a href="#h31-0-3" id="h31-0-3" class="d">-            android:contentDescription=&quot;@string/settings&quot; /&gt;
</a><a href="#h31-0-4" id="h31-0-4" class="i">+            android:contentDescription=&quot;@null&quot; /&gt;
</a> 
     &lt;/FrameLayout&gt;
 
<a href="#h31-1" id="h31-1" class="h">@@ -53,7 +53,7 @@
</a>             android:focusable=&quot;true&quot;
             android:fontFamily=&quot;@font/avenir_next_medium&quot;
             android:gravity=&quot;center&quot;
<a href="#h31-1-3" id="h31-1-3" class="d">-            android:text=&quot;@string/all_category&quot;
</a><a href="#h31-1-4" id="h31-1-4" class="i">+            android:text=&quot;&quot;
</a>             android:textColor=&quot;@color/focusedCategoryColor&quot; /&gt;
 
         &lt;TextView
<a href="#h31-2" id="h31-2" class="h">@@ -65,7 +65,7 @@
</a>             android:focusable=&quot;true&quot;
             android:fontFamily=&quot;@font/avenir_next_medium&quot;
             android:gravity=&quot;center&quot;
<a href="#h31-2-3" id="h31-2-3" class="d">-            android:text=&quot;@string/pending_category&quot;
</a><a href="#h31-2-4" id="h31-2-4" class="i">+            android:text=&quot;&quot;
</a>             android:textColor=&quot;@color/primaryText&quot; /&gt;
 
         &lt;TextView
<a href="#h31-3" id="h31-3" class="h">@@ -77,7 +77,7 @@
</a>             android:focusable=&quot;true&quot;
             android:fontFamily=&quot;@font/avenir_next_medium&quot;
             android:gravity=&quot;center&quot;
<a href="#h31-3-3" id="h31-3-3" class="d">-            android:text=&quot;@string/snap_category&quot;
</a><a href="#h31-3-4" id="h31-3-4" class="i">+            android:text=&quot;&quot;
</a>             android:textColor=&quot;@color/primaryText&quot; /&gt;
 
         &lt;TextView
<a href="#h31-4" id="h31-4" class="h">@@ -89,7 +89,7 @@
</a>             android:focusable=&quot;true&quot;
             android:fontFamily=&quot;@font/avenir_next_medium&quot;
             android:gravity=&quot;center&quot;
<a href="#h31-4-3" id="h31-4-3" class="d">-            android:text=&quot;@string/story_category&quot;
</a><a href="#h31-4-4" id="h31-4-4" class="i">+            android:text=&quot;&quot;
</a>             android:textColor=&quot;@color/primaryText&quot; /&gt;
 
         &lt;TextView
<a href="#h31-5" id="h31-5" class="h">@@ -101,7 +101,7 @@
</a>             android:focusable=&quot;true&quot;
             android:fontFamily=&quot;@font/avenir_next_medium&quot;
             android:gravity=&quot;center&quot;
<a href="#h31-5-3" id="h31-5-3" class="d">-            android:text=&quot;@string/spotlight_category&quot;
</a><a href="#h31-5-4" id="h31-5-4" class="i">+            android:text=&quot;&quot;
</a>             android:textColor=&quot;@color/primaryText&quot; /&gt;
 
     &lt;/LinearLayout&gt;
<a href="#h31-6" id="h31-6" class="h">@@ -124,7 +124,7 @@
</a>             android:layout_centerInParent=&quot;true&quot;
             android:gravity=&quot;center&quot;
             android:paddingVertical=&quot;40dp&quot;
<a href="#h31-6-3" id="h31-6-3" class="d">-            android:text=&quot;@string/no_downloads&quot;
</a><a href="#h31-6-4" id="h31-6-4" class="i">+            android:text=&quot;&quot;
</a>             android:textColor=&quot;@color/primaryText&quot; /&gt;
     &lt;/RelativeLayout&gt;
 
<a href="#h31-7" id="h31-7" class="h">@@ -141,7 +141,7 @@
</a>             android:layout_height=&quot;45dp&quot;
             android:background=&quot;@drawable/action_button_cancel&quot;
             android:padding=&quot;5dp&quot;
<a href="#h31-7-3" id="h31-7-3" class="d">-            android:text=&quot;@string/remove_all&quot;
</a><a href="#h31-7-4" id="h31-7-4" class="i">+            android:text=&quot;&quot;
</a>             android:textColor=&quot;@color/darkText&quot;
             android:layout_gravity=&quot;center_horizontal|bottom&quot;
             android:layout_marginBottom=&quot;5dp&quot;/&gt;
<b>diff --git a/<a id="h32" href="../file/app/src/main/res/layout/download_manager_item.xml.html">app/src/main/res/layout/download_manager_item.xml</a> b/<a href="../file/app/src/main/res/layout/download_manager_item.xml.html">app/src/main/res/layout/download_manager_item.xml</a></b>
<a href="#h32-0" id="h32-0" class="h">@@ -71,7 +71,7 @@
</a>         android:background=&quot;@drawable/action_button_cancel&quot;
         android:padding=&quot;5dp&quot;
         android:layout_marginEnd=&quot;10dp&quot;
<a href="#h32-0-3" id="h32-0-3" class="d">-        android:text=&quot;@string/cancel&quot;
</a><a href="#h32-0-4" id="h32-0-4" class="i">+        android:text=&quot;&quot;
</a>         android:textColor=&quot;@color/darkText&quot;
         tools:ignore=&quot;ButtonOrder&quot; /&gt;
 &lt;/LinearLayout&gt;
<b>diff --git a/<a id="h33" href="../file/app/src/main/res/layout/settings_page.xml.html">app/src/main/res/layout/settings_page.xml</a> b/<a href="../file/app/src/main/res/layout/settings_page.xml.html">app/src/main/res/layout/settings_page.xml</a></b>
<a href="#h33-0" id="h33-0" class="h">@@ -34,7 +34,7 @@
</a>             android:layout_width=&quot;match_parent&quot;
             android:layout_height=&quot;match_parent&quot;
             android:gravity=&quot;center&quot;
<a href="#h33-0-3" id="h33-0-3" class="d">-            android:text=&quot;@string/settings&quot;
</a><a href="#h33-0-4" id="h33-0-4" class="i">+            android:text=&quot;&quot;
</a>             android:textColor=&quot;@color/primaryText&quot;
             android:textSize=&quot;23sp&quot;
             android:fontFamily=&quot;@font/avenir_next_bold&quot; /&gt;
<b>diff --git a/<a id="h34" href="../file/app/src/main/res/values/strings.xml.html">app/src/main/res/values/strings.xml</a> b/<a href="../file/app/src/main/res/values/strings.xml.html">app/src/main/res/values/strings.xml</a></b>
<a href="#h34-0" id="h34-0" class="h">@@ -1,15 +1,3 @@
</a> &lt;resources&gt;
     &lt;string name=&quot;app_name&quot; translatable=&quot;false&quot;&gt;SnapEnhance&lt;/string&gt;
<a href="#h34-0-2" id="h34-0-2" class="d">-    &lt;string name=&quot;remove_all_title&quot;&gt;Remove all Downloads&lt;/string&gt;
</a><a href="#h34-0-3" id="h34-0-3" class="d">-    &lt;string name=&quot;remove_all_text&quot;&gt;Are you sure you want to do this?&lt;/string&gt;
</a><a href="#h34-0-4" id="h34-0-4" class="d">-    &lt;string name=&quot;remove_all&quot;&gt;Remove All&lt;/string&gt;
</a><a href="#h34-0-5" id="h34-0-5" class="d">-    &lt;string name=&quot;no_downloads&quot;&gt;No downloads&lt;/string&gt;
</a><a href="#h34-0-6" id="h34-0-6" class="d">-    &lt;string name=&quot;cancel&quot;&gt;Cancel&lt;/string&gt;
</a><a href="#h34-0-7" id="h34-0-7" class="d">-    &lt;string name=&quot;all_category&quot;&gt;All&lt;/string&gt;
</a><a href="#h34-0-8" id="h34-0-8" class="d">-    &lt;string name=&quot;pending_category&quot;&gt;Pending&lt;/string&gt;
</a><a href="#h34-0-9" id="h34-0-9" class="d">-    &lt;string name=&quot;snap_category&quot;&gt;Snaps&lt;/string&gt;
</a><a href="#h34-0-10" id="h34-0-10" class="d">-    &lt;string name=&quot;story_category&quot;&gt;Stories&lt;/string&gt;
</a><a href="#h34-0-11" id="h34-0-11" class="d">-    &lt;string name=&quot;spotlight_category&quot;&gt;Spotlight&lt;/string&gt;
</a><a href="#h34-0-12" id="h34-0-12" class="d">-    &lt;string name=&quot;settings&quot;&gt;Settings&lt;/string&gt;
</a><a href="#h34-0-13" id="h34-0-13" class="d">-    &lt;string name=&quot;refresh_mappings&quot;&gt;Refresh Mappings&lt;/string&gt;
</a> &lt;/resources&gt; 
\ No newline at end of file
</pre>
</div>
</body>
</html>
