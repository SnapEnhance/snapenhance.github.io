<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>feat: friend tracker (#969) - SnapEnhance - An Xposed module offering an enhanced Snapchat experience
</title>
<link rel="icon" type="image/svg+xml" href="../../logo.png"/>
<link rel="alternate icon" href="../../favicon.png"/>
<link rel="alternate" type="application/atom+xml" title="SnapEnhance Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="SnapEnhance Atom Feed (tags)" href="../tags.xml" />
<link rel="stylesheet" type="text/css" href="../../style.css" />
<link rel="stylesheet" type="text/css" href="../../fonts.css" />
</head>
<body>
<div id="head"><table><tr><td><a class="logo" href="../../"><img src="../../logo.png" alt="" width="32" height="32" /></a></td><td><strong>SnapEnhance</strong><span class="desc"> - An Xposed module offering an enhanced Snapchat experience
</span>
</td></tr></table>
<p><a href="../about.html">About</a> | <a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/LICENSE.html">License</a></p>
</div>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/dadec3d2783da9eddbc1887090377601b6a5eb39.html">dadec3d2783da9eddbc1887090377601b6a5eb39</a>
<b>parent</b> <a href="../commit/43fb83ab5c91fe4c852c619bde0574138a1e6408.html">43fb83ab5c91fe4c852c619bde0574138a1e6408</a>
<b>Author:</b> auth &lt;<a href="mailto:64337177+authorisation@users.noreply.github.com">64337177+authorisation@users.noreply.github.com</a>&gt;
<b>Date:</b>   Tue, 21 May 2024 20:48:47 +0200

feat: friend tracker (#969)

Co-authored-by: rhunk &lt;101876869+rhunk@users.noreply.github.com&gt;
Co-authored-by: Jacob Thomas &lt;41988041+bocajthomas@users.noreply.github.com&gt;
<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">app/src/main/AndroidManifest.xml</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">app/src/main/kotlin/me/rhunk/snapenhance/LogManager.kt</a></td><td> | </td><td class="num">57</td><td><span class="i">+++++++++++++++++++++++++++++++++</span><span class="d">------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h2">app/src/main/kotlin/me/rhunk/snapenhance/RemoteAccountStorage.kt</a></td><td> | </td><td class="num">6</td><td><span class="i">++++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h3">app/src/main/kotlin/me/rhunk/snapenhance/RemoteSideContext.kt</a></td><td> | </td><td class="num">52</td><td><span class="i">+++++++++++++++++++++++++++++</span><span class="d">-----------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h4">app/src/main/kotlin/me/rhunk/snapenhance/RemoteTracker.kt</a></td><td> | </td><td class="num">16</td><td><span class="i">++++++++</span><span class="d">--------</span></td></tr>
<tr><td class="A">A</td><td><a href="#h5">app/src/main/kotlin/me/rhunk/snapenhance/StreaksReminder.kt</a></td><td> | </td><td class="num">126</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h6">app/src/main/kotlin/me/rhunk/snapenhance/bridge/BridgeService.kt</a></td><td> | </td><td class="num">15</td><td><span class="i">++++++++</span><span class="d">-------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h7">app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadProcessor.kt</a></td><td> | </td><td class="num">1</td><td><span class="i"></span><span class="d">-</span></td></tr>
<tr><td class="D">D</td><td><a href="#h8">app/src/main/kotlin/me/rhunk/snapenhance/messaging/ModDatabase.kt</a></td><td> | </td><td class="num">406</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h9">app/src/main/kotlin/me/rhunk/snapenhance/messaging/StreaksReminder.kt</a></td><td> | </td><td class="num">127</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h10">app/src/main/kotlin/me/rhunk/snapenhance/scripting/AutoReloadHandler.kt</a></td><td> | </td><td class="num">26</td><td><span class="i">+++++++++++++++</span><span class="d">-----------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h11">app/src/main/kotlin/me/rhunk/snapenhance/scripting/RemoteScriptManager.kt</a></td><td> | </td><td class="num">49</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">----</span></td></tr>
<tr><td class="A">A</td><td><a href="#h12">app/src/main/kotlin/me/rhunk/snapenhance/storage/AppDatabase.kt</a></td><td> | </td><td class="num">94</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h13">app/src/main/kotlin/me/rhunk/snapenhance/storage/Messaging.kt</a></td><td> | </td><td class="num">181</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h14">app/src/main/kotlin/me/rhunk/snapenhance/storage/QuickTiles.kt</a></td><td> | </td><td class="num">27</td><td><span class="i">+++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h15">app/src/main/kotlin/me/rhunk/snapenhance/storage/Scripting.kt</a></td><td> | </td><td class="num">74</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h16">app/src/main/kotlin/me/rhunk/snapenhance/storage/Tracker.kt</a></td><td> | </td><td class="num">197</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h17">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/Navigation.kt</a></td><td> | </td><td class="num">4</td><td><span class="i">++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h18">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/Routes.kt</a></td><td> | </td><td class="num">4</td><td><span class="i">+++</span><span class="d">-</span></td></tr>
<tr><td class="D">D</td><td><a href="#h19">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/FriendTrackerManagerRoot.kt</a></td><td> | </td><td class="num">331</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h20">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/LoggerHistoryRoot.kt</a></td><td> | </td><td class="num">44</td><td><span class="i">+++++++++++++++++++++++++++++++++</span><span class="d">-----------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h21">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/TasksRoot.kt</a></td><td> | </td><td class="num">129</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">---------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h22">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/features/FeaturesRoot.kt</a></td><td> | </td><td class="num">30</td><td><span class="i">+++++++++</span><span class="d">---------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h23">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/home/HomeLogs.kt</a></td><td> | </td><td class="num">115</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">----------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h24">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/home/HomeRoot.kt</a></td><td> | </td><td class="num">337</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">----------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h25">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/home/HomeSettings.kt</a></td><td> | </td><td class="num">18</td><td><span class="i">++++++++++</span><span class="d">--------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h26">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/scripting/ScriptingRoot.kt</a></td><td> | </td><td class="num">354</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h27">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/social/AddFriendDialog.kt</a></td><td> | </td><td class="num">79</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">----------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h28">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/social/LoggedStories.kt</a></td><td> | </td><td class="num">4</td><td><span class="i">++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h29">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/social/ManageScope.kt</a></td><td> | </td><td class="num">195</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">-----------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h30">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/social/MessagingPreview.kt</a></td><td> | </td><td class="num">10</td><td><span class="i">++++++</span><span class="d">----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h31">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/social/SocialRoot.kt</a></td><td> | </td><td class="num">46</td><td><span class="i">++++++++++++++++++++++++++++++++</span><span class="d">--------------</span></td></tr>
<tr><td class="A">A</td><td><a href="#h32">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/tracker/EditRule.kt</a></td><td> | </td><td class="num">463</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h33">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/tracker/FriendTrackerManagerRoot.kt</a></td><td> | </td><td class="num">471</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h34">app/src/main/kotlin/me/rhunk/snapenhance/ui/util/coil/ComposeImageHelper.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h35">common/src/main/assets/lang/en_US.json</a></td><td> | </td><td class="num">30</td><td><span class="i">++++++++++++++++</span><span class="d">--------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h36">common/src/main/kotlin/me/rhunk/snapenhance/common/action/EnumAction.kt</a></td><td> | </td><td class="num">18</td><td><span class="i">+++++++++++++</span><span class="d">-----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h37">common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/wrapper/LoggerWrapper.kt</a></td><td> | </td><td class="num">114</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">--------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h38">common/src/main/kotlin/me/rhunk/snapenhance/common/config/ConfigObjects.kt</a></td><td> | </td><td class="num">3</td><td><span class="i">++</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h39">common/src/main/kotlin/me/rhunk/snapenhance/common/config/impl/Experimental.kt</a></td><td> | </td><td class="num">13</td><td><span class="i">+++++</span><span class="d">--------</span></td></tr>
<tr><td class="A">A</td><td><a href="#h40">common/src/main/kotlin/me/rhunk/snapenhance/common/config/impl/FriendTrackerConfig.kt</a></td><td> | </td><td class="num">9</td><td><span class="i">+++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h41">common/src/main/kotlin/me/rhunk/snapenhance/common/config/impl/RootConfig.kt</a></td><td> | </td><td class="num">23</td><td><span class="i">++++++++++++++</span><span class="d">---------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h42">common/src/main/kotlin/me/rhunk/snapenhance/common/data/SessionEventsData.kt</a></td><td> | </td><td class="num">167</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h43">common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/JSModule.kt</a></td><td> | </td><td class="num">26</td><td><span class="i">+++++++++++++++++++++</span><span class="d">-----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h44">common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/ScriptRuntime.kt</a></td><td> | </td><td class="num">47</td><td><span class="i">+++++++++++++++++++++++++++</span><span class="d">--------------------</span></td></tr>
<tr><td class="A">A</td><td><a href="#h45">common/src/main/kotlin/me/rhunk/snapenhance/common/ui/AsyncMutableState.kt</a></td><td> | </td><td class="num">103</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h46">common/src/main/kotlin/me/rhunk/snapenhance/common/util/snap/BitmojiSelfie.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h47">core/src/main/kotlin/me/rhunk/snapenhance/core/ModContext.kt</a></td><td> | </td><td class="num">4</td><td><span class="i">++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h48">core/src/main/kotlin/me/rhunk/snapenhance/core/action/impl/BulkMessagingAction.kt</a></td><td> | </td><td class="num">34</td><td><span class="i">+++++++++++++++++++++++++++++</span><span class="d">-----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h49">core/src/main/kotlin/me/rhunk/snapenhance/core/action/impl/ManageFriendList.kt</a></td><td> | </td><td class="num">1</td><td><span class="i"></span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h50">core/src/main/kotlin/me/rhunk/snapenhance/core/features/FeatureManager.kt</a></td><td> | </td><td class="num">3</td><td><span class="i">++</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h51">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/MixerStories.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h52">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/downloader/ProfilePictureDownloader.kt</a></td><td> | </td><td class="num">3</td><td><span class="i"></span><span class="d">---</span></td></tr>
<tr><td class="D">D</td><td><a href="#h53">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/SessionEvents.kt</a></td><td> | </td><td class="num">360</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="A">A</td><td><a href="#h54">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/spying/FriendTracker.kt</a></td><td> | </td><td class="num">384</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h55">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/spying/MessageLogger.kt</a></td><td> | </td><td class="num">6</td><td><span class="i">++++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h56">core/src/main/kotlin/me/rhunk/snapenhance/core/wrapper/AbstractWrapper.kt</a></td><td> | </td><td class="num">10</td><td><span class="i">++++</span><span class="d">------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h57">mapper/src/main/kotlin/me/rhunk/snapenhance/mapper/impl/BCryptClassMapper.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h58">mapper/src/main/kotlin/me/rhunk/snapenhance/mapper/impl/CompositeConfigurationProviderMapper.kt</a></td><td> | </td><td class="num">8</td><td><span class="i">++++</span><span class="d">----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h59">mapper/src/main/kotlin/me/rhunk/snapenhance/mapper/impl/MediaQualityLevelProviderMapper.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h60">mapper/src/main/kotlin/me/rhunk/snapenhance/mapper/impl/OperaViewerParamsMapper.kt</a></td><td> | </td><td class="num">4</td><td><span class="i">++</span><span class="d">--</span></td></tr>
</table></pre><pre>61 files changed, 3533 insertions(+), 1937 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/app/src/main/AndroidManifest.xml.html">app/src/main/AndroidManifest.xml</a> b/<a href="../file/app/src/main/AndroidManifest.xml.html">app/src/main/AndroidManifest.xml</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -65,7 +65,7 @@
</a>             android:excludeFromRecents=&quot;true&quot;
             android:exported=&quot;true&quot; /&gt;
 
<a href="#h0-0-3" id="h0-0-3" class="d">-        &lt;receiver android:name=&quot;.messaging.StreaksReminder&quot; /&gt;
</a><a href="#h0-0-4" id="h0-0-4" class="i">+        &lt;receiver android:name=&quot;.StreaksReminder&quot; /&gt;
</a> 
         &lt;provider
             android:name=&quot;androidx.core.content.FileProvider&quot;
<b>diff --git a/<a id="h1" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/LogManager.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/LogManager.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/LogManager.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/LogManager.kt</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -2,6 +2,8 @@ package me.rhunk.snapenhance
</a> 
 import android.util.Log
 import com.google.gson.GsonBuilder
<a href="#h1-0-3" id="h1-0-3" class="i">+import kotlinx.coroutines.Dispatchers
</a><a href="#h1-0-4" id="h1-0-4" class="i">+import kotlinx.coroutines.launch
</a> import me.rhunk.snapenhance.common.data.FileType
 import me.rhunk.snapenhance.common.logger.AbstractLogger
 import me.rhunk.snapenhance.common.logger.LogChannel
<a href="#h1-1" id="h1-1" class="h">@@ -70,33 +72,39 @@ class LogReader(
</a>     }
 
     fun incrementLineCount() {
<a href="#h1-1-3" id="h1-1-3" class="d">-        randomAccessFile.seek(randomAccessFile.length())
</a><a href="#h1-1-4" id="h1-1-4" class="d">-        startLineIndexes.add(randomAccessFile.filePointer + 1)
</a><a href="#h1-1-5" id="h1-1-5" class="d">-        lineCount++
</a><a href="#h1-1-6" id="h1-1-6" class="i">+        synchronized(randomAccessFile) {
</a><a href="#h1-1-7" id="h1-1-7" class="i">+            randomAccessFile.seek(randomAccessFile.length())
</a><a href="#h1-1-8" id="h1-1-8" class="i">+            startLineIndexes.add(randomAccessFile.filePointer + 1)
</a><a href="#h1-1-9" id="h1-1-9" class="i">+            lineCount++
</a><a href="#h1-1-10" id="h1-1-10" class="i">+        }
</a>     }
 
     private fun queryLineCount(): Int {
<a href="#h1-1-14" id="h1-1-14" class="d">-        randomAccessFile.seek(0)
</a><a href="#h1-1-15" id="h1-1-15" class="d">-        var lineCount = 0
</a><a href="#h1-1-16" id="h1-1-16" class="d">-        var lastPointer: Long
</a><a href="#h1-1-17" id="h1-1-17" class="d">-        var line: String?
</a><a href="#h1-1-18" id="h1-1-18" class="d">-
</a><a href="#h1-1-19" id="h1-1-19" class="d">-        while (randomAccessFile.also {
</a><a href="#h1-1-20" id="h1-1-20" class="d">-            lastPointer = it.filePointer
</a><a href="#h1-1-21" id="h1-1-21" class="d">-        }.readLine().also { line = it } != null) {
</a><a href="#h1-1-22" id="h1-1-22" class="d">-            if (line?.startsWith(&#39;|&#39;) == true) {
</a><a href="#h1-1-23" id="h1-1-23" class="d">-                lineCount++
</a><a href="#h1-1-24" id="h1-1-24" class="d">-                startLineIndexes.add(lastPointer + 1)
</a><a href="#h1-1-25" id="h1-1-25" class="i">+        synchronized(randomAccessFile) {
</a><a href="#h1-1-26" id="h1-1-26" class="i">+            randomAccessFile.seek(0)
</a><a href="#h1-1-27" id="h1-1-27" class="i">+            var lineCount = 0
</a><a href="#h1-1-28" id="h1-1-28" class="i">+            var lastPointer: Long
</a><a href="#h1-1-29" id="h1-1-29" class="i">+            var line: String?
</a><a href="#h1-1-30" id="h1-1-30" class="i">+
</a><a href="#h1-1-31" id="h1-1-31" class="i">+            while (randomAccessFile.also {
</a><a href="#h1-1-32" id="h1-1-32" class="i">+                    lastPointer = it.filePointer
</a><a href="#h1-1-33" id="h1-1-33" class="i">+                }.readLine().also { line = it } != null) {
</a><a href="#h1-1-34" id="h1-1-34" class="i">+                if (line?.startsWith(&#39;|&#39;) == true) {
</a><a href="#h1-1-35" id="h1-1-35" class="i">+                    lineCount++
</a><a href="#h1-1-36" id="h1-1-36" class="i">+                    startLineIndexes.add(lastPointer + 1)
</a><a href="#h1-1-37" id="h1-1-37" class="i">+                }
</a>             }
<a href="#h1-1-39" id="h1-1-39" class="d">-        }
</a> 
<a href="#h1-1-41" id="h1-1-41" class="d">-        return lineCount
</a><a href="#h1-1-42" id="h1-1-42" class="i">+            return lineCount
</a><a href="#h1-1-43" id="h1-1-43" class="i">+        }
</a>     }
 
     private fun getLine(index: Int): String? {
         if (index &lt;= 0 || index &gt; lineCount) return null
<a href="#h1-1-48" id="h1-1-48" class="d">-        randomAccessFile.seek(startLineIndexes[index])
</a><a href="#h1-1-49" id="h1-1-49" class="d">-        return readLogLine()?.toString()
</a><a href="#h1-1-50" id="h1-1-50" class="i">+        synchronized(randomAccessFile) {
</a><a href="#h1-1-51" id="h1-1-51" class="i">+            randomAccessFile.seek(startLineIndexes[index])
</a><a href="#h1-1-52" id="h1-1-52" class="i">+            return readLogLine()?.toString()
</a><a href="#h1-1-53" id="h1-1-53" class="i">+        }
</a>     }
 
     fun getLogLine(index: Int): LogLine? {
<a href="#h1-2" id="h1-2" class="h">@@ -109,7 +117,6 @@ class LogManager(
</a>     private val remoteSideContext: RemoteSideContext
 ): AbstractLogger(LogChannel.MANAGER) {
     companion object {
<a href="#h1-2-3" id="h1-2-3" class="d">-        private const val TAG = &quot;SnapEnhanceManager&quot;
</a>         private val LOG_LIFETIME = 24.hours
     }
 
<a href="#h1-3" id="h1-3" class="h">@@ -118,13 +125,13 @@ class LogManager(
</a>     var lineAddListener = { _: LogLine -&gt; }
 
     private val logFolder = File(remoteSideContext.androidContext.cacheDir, &quot;logs&quot;)
<a href="#h1-3-3" id="h1-3-3" class="d">-    private var logFile: File
</a><a href="#h1-3-4" id="h1-3-4" class="i">+    private var logFile: File? = null
</a> 
     private val uuidRegex by lazy { Regex(&quot;[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}&quot;, RegexOption.MULTILINE) }
     private val contentUriRegex by lazy { Regex(&quot;content://[a-zA-Z0-9_\\-./]+&quot;) }
     private val filePathRegex by lazy { Regex(&quot;([a-zA-Z0-9_\\-./]+)\\.(${FileType.entries.joinToString(&quot;|&quot;) { file -&gt; file.fileExtension.toString() }})&quot;) }
 
<a href="#h1-3-10" id="h1-3-10" class="d">-    init {
</a><a href="#h1-3-11" id="h1-3-11" class="i">+    fun init() {
</a>         if (!logFolder.exists()) {
             logFolder.mkdirs()
         }
<a href="#h1-4" id="h1-4" class="h">@@ -153,7 +160,9 @@ class LogManager(
</a>                 tag = tag,
                 message = anonymizedMessage
             )
<a href="#h1-4-3" id="h1-4-3" class="d">-            logFile.appendText(&quot;|$line\n&quot;, Charsets.UTF_8)
</a><a href="#h1-4-4" id="h1-4-4" class="i">+            remoteSideContext.coroutineScope.launch(Dispatchers.IO) {
</a><a href="#h1-4-5" id="h1-4-5" class="i">+                logFile?.appendText(&quot;|$line\n&quot;, Charsets.UTF_8)
</a><a href="#h1-4-6" id="h1-4-6" class="i">+            }
</a>             lineAddListener(line)
             Log.println(logLevel.priority, tag, anonymizedMessage)
         }.onFailure {
<a href="#h1-5" id="h1-5" class="h">@@ -172,8 +181,8 @@ class LogManager(
</a>         val currentTime = System.currentTimeMillis()
         logFile = File(logFolder, &quot;snapenhance_${getCurrentDateTime(pathSafe = true)}.log&quot;).also {
             it.createNewFile()
<a href="#h1-5-3" id="h1-5-3" class="i">+            remoteSideContext.sharedPreferences.edit().putString(&quot;log_file&quot;, it.absolutePath).putLong(&quot;last_created&quot;, currentTime).apply()
</a>         }
<a href="#h1-5-5" id="h1-5-5" class="d">-        remoteSideContext.sharedPreferences.edit().putString(&quot;log_file&quot;, logFile.absolutePath).putLong(&quot;last_created&quot;, currentTime).apply()
</a>     }
 
     fun clearLogs() {
<a href="#h1-6" id="h1-6" class="h">@@ -201,7 +210,7 @@ class LogManager(
</a>         zipOutputStream.close()
     }
 
<a href="#h1-6-3" id="h1-6-3" class="d">-    fun newReader(onAddLine: (LogLine) -&gt; Unit) = LogReader(logFile).also {
</a><a href="#h1-6-4" id="h1-6-4" class="i">+    fun newReader(onAddLine: (LogLine) -&gt; Unit) = LogReader(logFile!!).also {
</a>         lineAddListener = { line -&gt; it.incrementLineCount(); onAddLine(line) }
     }
 
<b>diff --git a/<a id="h2" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/RemoteAccountStorage.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/RemoteAccountStorage.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/RemoteAccountStorage.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/RemoteAccountStorage.kt</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -7,8 +7,10 @@ import me.rhunk.snapenhance.core.util.ktx.toParcelFileDescriptor
</a> class RemoteAccountStorage(
     private val context: RemoteSideContext
 ): AccountStorage.Stub() {
<a href="#h2-0-3" id="h2-0-3" class="d">-    private val accountFolder = context.androidContext.filesDir.resolve(&quot;accounts&quot;).also {
</a><a href="#h2-0-4" id="h2-0-4" class="d">-        if (!it.exists()) it.mkdirs()
</a><a href="#h2-0-5" id="h2-0-5" class="i">+    private val accountFolder by lazy {
</a><a href="#h2-0-6" id="h2-0-6" class="i">+        context.androidContext.filesDir.resolve(&quot;accounts&quot;).also {
</a><a href="#h2-0-7" id="h2-0-7" class="i">+            if (!it.exists()) it.mkdirs()
</a><a href="#h2-0-8" id="h2-0-8" class="i">+        }
</a>     }
 
     override fun getAccounts(): Map&lt;String, String&gt; {
<b>diff --git a/<a id="h3" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/RemoteSideContext.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/RemoteSideContext.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/RemoteSideContext.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/RemoteSideContext.kt</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -19,6 +19,8 @@ import com.google.gson.Gson
</a> import com.google.gson.GsonBuilder
 import kotlinx.coroutines.CoroutineScope
 import kotlinx.coroutines.Dispatchers
<a href="#h3-0-3" id="h3-0-3" class="i">+import kotlinx.coroutines.launch
</a><a href="#h3-0-4" id="h3-0-4" class="i">+import kotlinx.coroutines.runBlocking
</a> import me.rhunk.snapenhance.bridge.BridgeService
 import me.rhunk.snapenhance.common.BuildConfig
 import me.rhunk.snapenhance.common.bridge.types.BridgeFileType
<a href="#h3-1" id="h3-1" class="h">@@ -27,9 +29,8 @@ import me.rhunk.snapenhance.common.bridge.wrapper.LoggerWrapper
</a> import me.rhunk.snapenhance.common.bridge.wrapper.MappingsWrapper
 import me.rhunk.snapenhance.common.config.ModConfig
 import me.rhunk.snapenhance.e2ee.E2EEImplementation
<a href="#h3-1-3" id="h3-1-3" class="d">-import me.rhunk.snapenhance.messaging.ModDatabase
</a><a href="#h3-1-4" id="h3-1-4" class="d">-import me.rhunk.snapenhance.messaging.StreaksReminder
</a> import me.rhunk.snapenhance.scripting.RemoteScriptManager
<a href="#h3-1-6" id="h3-1-6" class="i">+import me.rhunk.snapenhance.storage.AppDatabase
</a> import me.rhunk.snapenhance.task.TaskManager
 import me.rhunk.snapenhance.ui.manager.MainActivity
 import me.rhunk.snapenhance.ui.manager.data.InstallationSummary
<a href="#h3-2" id="h3-2" class="h">@@ -63,7 +64,7 @@ class RemoteSideContext(
</a>     val translation = LocaleWrapper()
     val mappings = MappingsWrapper()
     val taskManager = TaskManager(this)
<a href="#h3-2-3" id="h3-2-3" class="d">-    val modDatabase = ModDatabase(this)
</a><a href="#h3-2-4" id="h3-2-4" class="i">+    val database = AppDatabase(this)
</a>     val streaksReminder = StreaksReminder(this)
     val log = LogManager(this)
     val scriptManager = RemoteScriptManager(this)
<a href="#h3-3" id="h3-3" class="h">@@ -94,27 +95,32 @@ class RemoteSideContext(
</a>     val gson: Gson by lazy { GsonBuilder().setPrettyPrinting().create() }
 
     fun reload() {
<a href="#h3-3-3" id="h3-3-3" class="d">-        log.verbose(&quot;Loading RemoteSideContext&quot;)
</a>         runCatching {
<a href="#h3-3-5" id="h3-3-5" class="d">-            config.loadFromContext(androidContext)
</a><a href="#h3-3-6" id="h3-3-6" class="d">-            translation.apply {
</a><a href="#h3-3-7" id="h3-3-7" class="d">-                userLocale = config.locale
</a><a href="#h3-3-8" id="h3-3-8" class="d">-                loadFromContext(androidContext)
</a><a href="#h3-3-9" id="h3-3-9" class="d">-            }
</a><a href="#h3-3-10" id="h3-3-10" class="d">-            mappings.apply {
</a><a href="#h3-3-11" id="h3-3-11" class="d">-                loadFromContext(androidContext)
</a><a href="#h3-3-12" id="h3-3-12" class="d">-                init(androidContext)
</a><a href="#h3-3-13" id="h3-3-13" class="d">-            }
</a><a href="#h3-3-14" id="h3-3-14" class="d">-            taskManager.init()
</a><a href="#h3-3-15" id="h3-3-15" class="d">-            modDatabase.init()
</a><a href="#h3-3-16" id="h3-3-16" class="d">-            streaksReminder.init()
</a><a href="#h3-3-17" id="h3-3-17" class="d">-            scriptManager.init()
</a><a href="#h3-3-18" id="h3-3-18" class="d">-            messageLogger.init()
</a><a href="#h3-3-19" id="h3-3-19" class="d">-            tracker.init()
</a><a href="#h3-3-20" id="h3-3-20" class="d">-            config.root.messaging.messageLogger.takeIf {
</a><a href="#h3-3-21" id="h3-3-21" class="d">-                it.globalState == true
</a><a href="#h3-3-22" id="h3-3-22" class="d">-            }?.getAutoPurgeTime()?.let {
</a><a href="#h3-3-23" id="h3-3-23" class="d">-                messageLogger.purgeAll(it)
</a><a href="#h3-3-24" id="h3-3-24" class="i">+            runBlocking(Dispatchers.IO) {
</a><a href="#h3-3-25" id="h3-3-25" class="i">+                log.init()
</a><a href="#h3-3-26" id="h3-3-26" class="i">+                log.verbose(&quot;Loading RemoteSideContext&quot;)
</a><a href="#h3-3-27" id="h3-3-27" class="i">+                config.loadFromContext(androidContext)
</a><a href="#h3-3-28" id="h3-3-28" class="i">+                launch {
</a><a href="#h3-3-29" id="h3-3-29" class="i">+                    mappings.apply {
</a><a href="#h3-3-30" id="h3-3-30" class="i">+                        loadFromContext(androidContext)
</a><a href="#h3-3-31" id="h3-3-31" class="i">+                        init(androidContext)
</a><a href="#h3-3-32" id="h3-3-32" class="i">+                    }
</a><a href="#h3-3-33" id="h3-3-33" class="i">+                }
</a><a href="#h3-3-34" id="h3-3-34" class="i">+                translation.apply {
</a><a href="#h3-3-35" id="h3-3-35" class="i">+                    userLocale = config.locale
</a><a href="#h3-3-36" id="h3-3-36" class="i">+                    loadFromContext(androidContext)
</a><a href="#h3-3-37" id="h3-3-37" class="i">+                }
</a><a href="#h3-3-38" id="h3-3-38" class="i">+                database.init()
</a><a href="#h3-3-39" id="h3-3-39" class="i">+                streaksReminder.init()
</a><a href="#h3-3-40" id="h3-3-40" class="i">+                scriptManager.init()
</a><a href="#h3-3-41" id="h3-3-41" class="i">+                launch {
</a><a href="#h3-3-42" id="h3-3-42" class="i">+                    taskManager.init()
</a><a href="#h3-3-43" id="h3-3-43" class="i">+                    config.root.messaging.messageLogger.takeIf {
</a><a href="#h3-3-44" id="h3-3-44" class="i">+                        it.globalState == true
</a><a href="#h3-3-45" id="h3-3-45" class="i">+                    }?.getAutoPurgeTime()?.let {
</a><a href="#h3-3-46" id="h3-3-46" class="i">+                        messageLogger.purgeAll(it)
</a><a href="#h3-3-47" id="h3-3-47" class="i">+                    }
</a><a href="#h3-3-48" id="h3-3-48" class="i">+                }
</a>             }
         }.onFailure {
             log.error(&quot;Failed to load RemoteSideContext&quot;, it)
<b>diff --git a/<a id="h4" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/RemoteTracker.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/RemoteTracker.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/RemoteTracker.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/RemoteTracker.kt</a></b>
<a href="#h4-0" id="h4-0" class="h">@@ -1,29 +1,29 @@
</a> package me.rhunk.snapenhance
 
 import me.rhunk.snapenhance.bridge.logger.TrackerInterface
<a href="#h4-0-3" id="h4-0-3" class="i">+import me.rhunk.snapenhance.common.data.ScopedTrackerRule
</a> import me.rhunk.snapenhance.common.data.TrackerEventsResult
 import me.rhunk.snapenhance.common.data.TrackerRule
 import me.rhunk.snapenhance.common.data.TrackerRuleEvent
 import me.rhunk.snapenhance.common.util.toSerialized
<a href="#h4-0-8" id="h4-0-8" class="i">+import me.rhunk.snapenhance.storage.getRuleTrackerScopes
</a><a href="#h4-0-9" id="h4-0-9" class="i">+import me.rhunk.snapenhance.storage.getTrackerEvents
</a> 
 
 class RemoteTracker(
     private val context: RemoteSideContext
 ): TrackerInterface.Stub() {
<a href="#h4-0-15" id="h4-0-15" class="d">-    fun init() {
</a><a href="#h4-0-16" id="h4-0-16" class="d">-        /*TrackerEventType.entries.forEach { eventType -&gt;
</a><a href="#h4-0-17" id="h4-0-17" class="d">-            val ruleId = context.modDatabase.addTrackerRule(TrackerFlags.TRACK or TrackerFlags.LOG or TrackerFlags.NOTIFY, null, null)
</a><a href="#h4-0-18" id="h4-0-18" class="d">-            context.modDatabase.addTrackerRuleEvent(ruleId, TrackerFlags.TRACK or TrackerFlags.LOG or TrackerFlags.NOTIFY, eventType.key)
</a><a href="#h4-0-19" id="h4-0-19" class="d">-        }*/
</a><a href="#h4-0-20" id="h4-0-20" class="d">-    }
</a><a href="#h4-0-21" id="h4-0-21" class="i">+    fun init() {}
</a> 
     override fun getTrackedEvents(eventType: String): String? {
         val events = mutableMapOf&lt;TrackerRule, MutableList&lt;TrackerRuleEvent&gt;&gt;()
 
<a href="#h4-0-26" id="h4-0-26" class="d">-        context.modDatabase.getTrackerEvents(eventType).forEach { (event, rule) -&gt;
</a><a href="#h4-0-27" id="h4-0-27" class="i">+        context.database.getTrackerEvents(eventType).forEach { (event, rule) -&gt;
</a>             events.getOrPut(rule) { mutableListOf() }.add(event)
         }
 
<a href="#h4-0-31" id="h4-0-31" class="d">-        return TrackerEventsResult(events).toSerialized()
</a><a href="#h4-0-32" id="h4-0-32" class="i">+        return TrackerEventsResult(events.mapKeys {
</a><a href="#h4-0-33" id="h4-0-33" class="i">+            ScopedTrackerRule(it.key, context.database.getRuleTrackerScopes(it.key.id))
</a><a href="#h4-0-34" id="h4-0-34" class="i">+        }).toSerialized()
</a>     }
 } 
\ No newline at end of file
<b>diff --git a/<a id="h5" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/StreaksReminder.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/StreaksReminder.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/StreaksReminder.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/StreaksReminder.kt</a></b>
<a href="#h5-0" id="h5-0" class="h">@@ -0,0 +1,125 @@
</a><a href="#h5-0-0" id="h5-0-0" class="i">+package me.rhunk.snapenhance
</a><a href="#h5-0-1" id="h5-0-1" class="i">+
</a><a href="#h5-0-2" id="h5-0-2" class="i">+import android.app.AlarmManager
</a><a href="#h5-0-3" id="h5-0-3" class="i">+import android.app.NotificationChannel
</a><a href="#h5-0-4" id="h5-0-4" class="i">+import android.app.NotificationManager
</a><a href="#h5-0-5" id="h5-0-5" class="i">+import android.app.PendingIntent
</a><a href="#h5-0-6" id="h5-0-6" class="i">+import android.content.BroadcastReceiver
</a><a href="#h5-0-7" id="h5-0-7" class="i">+import android.content.Context
</a><a href="#h5-0-8" id="h5-0-8" class="i">+import android.content.Intent
</a><a href="#h5-0-9" id="h5-0-9" class="i">+import androidx.core.app.NotificationCompat
</a><a href="#h5-0-10" id="h5-0-10" class="i">+import androidx.core.graphics.drawable.toBitmap
</a><a href="#h5-0-11" id="h5-0-11" class="i">+import kotlinx.coroutines.launch
</a><a href="#h5-0-12" id="h5-0-12" class="i">+import me.rhunk.snapenhance.bridge.ForceStartActivity
</a><a href="#h5-0-13" id="h5-0-13" class="i">+import me.rhunk.snapenhance.common.util.snap.BitmojiSelfie
</a><a href="#h5-0-14" id="h5-0-14" class="i">+import me.rhunk.snapenhance.storage.getFriendStreaks
</a><a href="#h5-0-15" id="h5-0-15" class="i">+import me.rhunk.snapenhance.storage.getFriends
</a><a href="#h5-0-16" id="h5-0-16" class="i">+import me.rhunk.snapenhance.ui.util.coil.ImageRequestHelper
</a><a href="#h5-0-17" id="h5-0-17" class="i">+import kotlin.time.Duration.Companion.hours
</a><a href="#h5-0-18" id="h5-0-18" class="i">+import kotlin.time.Duration.Companion.milliseconds
</a><a href="#h5-0-19" id="h5-0-19" class="i">+import kotlin.time.Duration.Companion.minutes
</a><a href="#h5-0-20" id="h5-0-20" class="i">+
</a><a href="#h5-0-21" id="h5-0-21" class="i">+class StreaksReminder(
</a><a href="#h5-0-22" id="h5-0-22" class="i">+    private val remoteSideContext: RemoteSideContext? = null
</a><a href="#h5-0-23" id="h5-0-23" class="i">+): BroadcastReceiver() {
</a><a href="#h5-0-24" id="h5-0-24" class="i">+    companion object {
</a><a href="#h5-0-25" id="h5-0-25" class="i">+        private const val NOTIFICATION_CHANNEL_ID = &quot;streaks&quot;
</a><a href="#h5-0-26" id="h5-0-26" class="i">+    }
</a><a href="#h5-0-27" id="h5-0-27" class="i">+
</a><a href="#h5-0-28" id="h5-0-28" class="i">+    private fun getNotificationManager(context: Context) = context.getSystemService(NotificationManager::class.java).apply {
</a><a href="#h5-0-29" id="h5-0-29" class="i">+        createNotificationChannel(
</a><a href="#h5-0-30" id="h5-0-30" class="i">+            NotificationChannel(
</a><a href="#h5-0-31" id="h5-0-31" class="i">+                NOTIFICATION_CHANNEL_ID,
</a><a href="#h5-0-32" id="h5-0-32" class="i">+                &quot;Streaks&quot;,
</a><a href="#h5-0-33" id="h5-0-33" class="i">+                NotificationManager.IMPORTANCE_HIGH
</a><a href="#h5-0-34" id="h5-0-34" class="i">+            )
</a><a href="#h5-0-35" id="h5-0-35" class="i">+        )
</a><a href="#h5-0-36" id="h5-0-36" class="i">+    }
</a><a href="#h5-0-37" id="h5-0-37" class="i">+
</a><a href="#h5-0-38" id="h5-0-38" class="i">+    override fun onReceive(ctx: Context, intent: Intent) {
</a><a href="#h5-0-39" id="h5-0-39" class="i">+        val remoteSideContext = this.remoteSideContext ?: SharedContextHolder.remote(ctx)
</a><a href="#h5-0-40" id="h5-0-40" class="i">+        val streaksReminderConfig = remoteSideContext.config.root.streaksReminder
</a><a href="#h5-0-41" id="h5-0-41" class="i">+        val sharedPreferences = remoteSideContext.sharedPreferences
</a><a href="#h5-0-42" id="h5-0-42" class="i">+
</a><a href="#h5-0-43" id="h5-0-43" class="i">+        if (streaksReminderConfig.globalState != true) return
</a><a href="#h5-0-44" id="h5-0-44" class="i">+
</a><a href="#h5-0-45" id="h5-0-45" class="i">+        val interval = streaksReminderConfig.interval.get().hours
</a><a href="#h5-0-46" id="h5-0-46" class="i">+        val remainingHours = streaksReminderConfig.remainingHours.get()
</a><a href="#h5-0-47" id="h5-0-47" class="i">+
</a><a href="#h5-0-48" id="h5-0-48" class="i">+        if (sharedPreferences.getLong(&quot;lastStreaksReminder&quot;, 0).milliseconds + interval - 10.minutes &gt; System.currentTimeMillis().milliseconds) return
</a><a href="#h5-0-49" id="h5-0-49" class="i">+        sharedPreferences.edit().putLong(&quot;lastStreaksReminder&quot;, System.currentTimeMillis()).apply()
</a><a href="#h5-0-50" id="h5-0-50" class="i">+
</a><a href="#h5-0-51" id="h5-0-51" class="i">+        remoteSideContext.androidContext.getSystemService(AlarmManager::class.java).setRepeating(
</a><a href="#h5-0-52" id="h5-0-52" class="i">+            AlarmManager.RTC_WAKEUP, 5000, interval.inWholeMilliseconds,
</a><a href="#h5-0-53" id="h5-0-53" class="i">+            PendingIntent.getBroadcast(remoteSideContext.androidContext, 0, Intent(remoteSideContext.androidContext, StreaksReminder::class.java),
</a><a href="#h5-0-54" id="h5-0-54" class="i">+                PendingIntent.FLAG_IMMUTABLE)
</a><a href="#h5-0-55" id="h5-0-55" class="i">+        )
</a><a href="#h5-0-56" id="h5-0-56" class="i">+
</a><a href="#h5-0-57" id="h5-0-57" class="i">+        val notifyFriendList = remoteSideContext.database.getFriends()
</a><a href="#h5-0-58" id="h5-0-58" class="i">+            .associateBy { remoteSideContext.database.getFriendStreaks(it.userId) }
</a><a href="#h5-0-59" id="h5-0-59" class="i">+            .filter { (streaks, _) -&gt; streaks != null &amp;&amp; streaks.notify &amp;&amp; streaks.isAboutToExpire(remainingHours) }
</a><a href="#h5-0-60" id="h5-0-60" class="i">+
</a><a href="#h5-0-61" id="h5-0-61" class="i">+        val notificationManager = getNotificationManager(ctx)
</a><a href="#h5-0-62" id="h5-0-62" class="i">+        val streaksReminderTranslation = remoteSideContext.translation.getCategory(&quot;streaks_reminder&quot;)
</a><a href="#h5-0-63" id="h5-0-63" class="i">+
</a><a href="#h5-0-64" id="h5-0-64" class="i">+        if (streaksReminderConfig.groupNotifications.get() &amp;&amp; notifyFriendList.isNotEmpty()) {
</a><a href="#h5-0-65" id="h5-0-65" class="i">+            notificationManager.notify(0, NotificationCompat.Builder(ctx, NOTIFICATION_CHANNEL_ID)
</a><a href="#h5-0-66" id="h5-0-66" class="i">+                .setPriority(NotificationCompat.PRIORITY_HIGH)
</a><a href="#h5-0-67" id="h5-0-67" class="i">+                .setAutoCancel(true)
</a><a href="#h5-0-68" id="h5-0-68" class="i">+                .setGroup(&quot;streaks&quot;)
</a><a href="#h5-0-69" id="h5-0-69" class="i">+                .setGroupSummary(true)
</a><a href="#h5-0-70" id="h5-0-70" class="i">+                .setSmallIcon(R.drawable.streak_icon)
</a><a href="#h5-0-71" id="h5-0-71" class="i">+                .build())
</a><a href="#h5-0-72" id="h5-0-72" class="i">+        }
</a><a href="#h5-0-73" id="h5-0-73" class="i">+
</a><a href="#h5-0-74" id="h5-0-74" class="i">+        notifyFriendList.forEach { (streaks, friend) -&gt;
</a><a href="#h5-0-75" id="h5-0-75" class="i">+            remoteSideContext.coroutineScope.launch {
</a><a href="#h5-0-76" id="h5-0-76" class="i">+                val bitmojiUrl = BitmojiSelfie.getBitmojiSelfie(friend.selfieId, friend.bitmojiId, BitmojiSelfie.BitmojiSelfieType.THREE_D)
</a><a href="#h5-0-77" id="h5-0-77" class="i">+                val bitmojiImage = remoteSideContext.imageLoader.execute(
</a><a href="#h5-0-78" id="h5-0-78" class="i">+                    ImageRequestHelper.newBitmojiImageRequest(ctx, bitmojiUrl)
</a><a href="#h5-0-79" id="h5-0-79" class="i">+                )
</a><a href="#h5-0-80" id="h5-0-80" class="i">+
</a><a href="#h5-0-81" id="h5-0-81" class="i">+                val notificationBuilder = NotificationCompat.Builder(ctx, NOTIFICATION_CHANNEL_ID)
</a><a href="#h5-0-82" id="h5-0-82" class="i">+                    .setContentTitle(streaksReminderTranslation[&quot;notification_title&quot;])
</a><a href="#h5-0-83" id="h5-0-83" class="i">+                    .setContentText(streaksReminderTranslation.format(&quot;notification_text&quot;,
</a><a href="#h5-0-84" id="h5-0-84" class="i">+                        &quot;friend&quot; to (friend.displayName ?: friend.mutableUsername),
</a><a href="#h5-0-85" id="h5-0-85" class="i">+                        &quot;hoursLeft&quot; to (streaks?.hoursLeft() ?: 0).toString()
</a><a href="#h5-0-86" id="h5-0-86" class="i">+                    ))
</a><a href="#h5-0-87" id="h5-0-87" class="i">+                    .setPriority(NotificationCompat.PRIORITY_DEFAULT)
</a><a href="#h5-0-88" id="h5-0-88" class="i">+                    .setAutoCancel(true)
</a><a href="#h5-0-89" id="h5-0-89" class="i">+                    .setGroup(&quot;streaks&quot;)
</a><a href="#h5-0-90" id="h5-0-90" class="i">+                    .setContentIntent(PendingIntent.getActivity(
</a><a href="#h5-0-91" id="h5-0-91" class="i">+                        ctx,
</a><a href="#h5-0-92" id="h5-0-92" class="i">+                        0,
</a><a href="#h5-0-93" id="h5-0-93" class="i">+                        Intent(ctx, ForceStartActivity::class.java).apply {
</a><a href="#h5-0-94" id="h5-0-94" class="i">+                            putExtra(&quot;streaks_notification_action&quot;, true)
</a><a href="#h5-0-95" id="h5-0-95" class="i">+                        },
</a><a href="#h5-0-96" id="h5-0-96" class="i">+                        PendingIntent.FLAG_IMMUTABLE
</a><a href="#h5-0-97" id="h5-0-97" class="i">+                    ))
</a><a href="#h5-0-98" id="h5-0-98" class="i">+                    .apply {
</a><a href="#h5-0-99" id="h5-0-99" class="i">+                        setSmallIcon(R.drawable.streak_icon)
</a><a href="#h5-0-100" id="h5-0-100" class="i">+                        bitmojiImage.drawable?.let {
</a><a href="#h5-0-101" id="h5-0-101" class="i">+                            setLargeIcon(it.toBitmap())
</a><a href="#h5-0-102" id="h5-0-102" class="i">+                        }
</a><a href="#h5-0-103" id="h5-0-103" class="i">+                    }
</a><a href="#h5-0-104" id="h5-0-104" class="i">+
</a><a href="#h5-0-105" id="h5-0-105" class="i">+                if (streaksReminderConfig.groupNotifications.get()) {
</a><a href="#h5-0-106" id="h5-0-106" class="i">+                    notificationBuilder.setGroupAlertBehavior(NotificationCompat.GROUP_ALERT_CHILDREN)
</a><a href="#h5-0-107" id="h5-0-107" class="i">+                }
</a><a href="#h5-0-108" id="h5-0-108" class="i">+
</a><a href="#h5-0-109" id="h5-0-109" class="i">+                notificationManager.notify(friend.userId.hashCode(), notificationBuilder.build().apply {
</a><a href="#h5-0-110" id="h5-0-110" class="i">+                    flags = NotificationCompat.FLAG_ONLY_ALERT_ONCE
</a><a href="#h5-0-111" id="h5-0-111" class="i">+                })
</a><a href="#h5-0-112" id="h5-0-112" class="i">+            }
</a><a href="#h5-0-113" id="h5-0-113" class="i">+        }
</a><a href="#h5-0-114" id="h5-0-114" class="i">+    }
</a><a href="#h5-0-115" id="h5-0-115" class="i">+
</a><a href="#h5-0-116" id="h5-0-116" class="i">+    fun init() {
</a><a href="#h5-0-117" id="h5-0-117" class="i">+        if (remoteSideContext == null) throw IllegalStateException(&quot;RemoteSideContext is null&quot;)
</a><a href="#h5-0-118" id="h5-0-118" class="i">+        if (remoteSideContext.config.root.streaksReminder.globalState != true) return
</a><a href="#h5-0-119" id="h5-0-119" class="i">+
</a><a href="#h5-0-120" id="h5-0-120" class="i">+        onReceive(remoteSideContext.androidContext, Intent())
</a><a href="#h5-0-121" id="h5-0-121" class="i">+    }
</a><a href="#h5-0-122" id="h5-0-122" class="i">+
</a><a href="#h5-0-123" id="h5-0-123" class="i">+    fun dismissAllNotifications() = getNotificationManager(remoteSideContext!!.androidContext).cancelAll()
</a><a href="#h5-0-124" id="h5-0-124" class="i">+}</a><a href="#h5-0-125" id="h5-0-125" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h6" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/BridgeService.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/BridgeService.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/BridgeService.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/BridgeService.kt</a></b>
<a href="#h6-0" id="h6-0" class="h">@@ -18,6 +18,7 @@ import me.rhunk.snapenhance.common.logger.LogLevel
</a> import me.rhunk.snapenhance.common.util.toParcelable
 import me.rhunk.snapenhance.download.DownloadProcessor
 import me.rhunk.snapenhance.download.FFMpegProcessor
<a href="#h6-0-3" id="h6-0-3" class="i">+import me.rhunk.snapenhance.storage.*
</a> import me.rhunk.snapenhance.task.Task
 import me.rhunk.snapenhance.task.TaskType
 import java.io.File
<a href="#h6-1" id="h6-1" class="h">@@ -47,7 +48,7 @@ class BridgeService : Service() {
</a> 
     fun triggerScopeSync(scope: SocialScope, id: String, updateOnly: Boolean = false) {
         runCatching {
<a href="#h6-1-3" id="h6-1-3" class="d">-            val modDatabase = remoteSideContext.modDatabase
</a><a href="#h6-1-4" id="h6-1-4" class="i">+            val modDatabase = remoteSideContext.database
</a>             val syncedObject = when (scope) {
                 SocialScope.FRIEND -&gt; {
                     if (updateOnly &amp;&amp; modDatabase.getFriendInfo(id) == null) return
<a href="#h6-2" id="h6-2" class="h">@@ -194,24 +195,24 @@ class BridgeService : Service() {
</a>         }
 
         override fun getRules(uuid: String): List&lt;String&gt; {
<a href="#h6-2-3" id="h6-2-3" class="d">-            return remoteSideContext.modDatabase.getRules(uuid).map { it.key }
</a><a href="#h6-2-4" id="h6-2-4" class="i">+            return remoteSideContext.database.getRules(uuid).map { it.key }
</a>         }
 
         override fun getRuleIds(type: String): MutableList&lt;String&gt; {
<a href="#h6-2-8" id="h6-2-8" class="d">-            return remoteSideContext.modDatabase.getRuleIds(type)
</a><a href="#h6-2-9" id="h6-2-9" class="i">+            return remoteSideContext.database.getRuleIds(type)
</a>         }
 
         override fun setRule(uuid: String, rule: String, state: Boolean) {
<a href="#h6-2-13" id="h6-2-13" class="d">-            remoteSideContext.modDatabase.setRule(uuid, rule, state)
</a><a href="#h6-2-14" id="h6-2-14" class="i">+            remoteSideContext.database.setRule(uuid, rule, state)
</a>         }
 
         override fun sync(callback: SyncCallback) {
             syncCallback = callback
             measureTimeMillis {
<a href="#h6-2-20" id="h6-2-20" class="d">-                remoteSideContext.modDatabase.getFriends().map { it.userId } .forEach { friendId -&gt;
</a><a href="#h6-2-21" id="h6-2-21" class="i">+                remoteSideContext.database.getFriends().map { it.userId } .forEach { friendId -&gt;
</a>                     triggerScopeSync(SocialScope.FRIEND, friendId, true)
                 }
<a href="#h6-2-24" id="h6-2-24" class="d">-                remoteSideContext.modDatabase.getGroups().map { it.conversationId }.forEach { groupId -&gt;
</a><a href="#h6-2-25" id="h6-2-25" class="i">+                remoteSideContext.database.getGroups().map { it.conversationId }.forEach { groupId -&gt;
</a>                     triggerScopeSync(SocialScope.GROUP, groupId, true)
                 }
             }.also {
<a href="#h6-3" id="h6-3" class="h">@@ -229,7 +230,7 @@ class BridgeService : Service() {
</a>             friends: List&lt;String&gt;
         ) {
             remoteSideContext.log.verbose(&quot;Received ${groups.size} groups and ${friends.size} friends&quot;)
<a href="#h6-3-3" id="h6-3-3" class="d">-            remoteSideContext.modDatabase.receiveMessagingDataCallback(
</a><a href="#h6-3-4" id="h6-3-4" class="i">+            remoteSideContext.database.receiveMessagingDataCallback(
</a>                 friends.mapNotNull { toParcelable&lt;MessagingFriendInfo&gt;(it) },
                 groups.mapNotNull { toParcelable&lt;MessagingGroupInfo&gt;(it) }
             )
<b>diff --git a/<a id="h7" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadProcessor.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadProcessor.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadProcessor.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadProcessor.kt</a></b>
<a href="#h7-0" id="h7-0" class="h">@@ -1,6 +1,5 @@
</a> package me.rhunk.snapenhance.download
 
<a href="#h7-0-2" id="h7-0-2" class="d">-import android.annotation.SuppressLint
</a> import android.content.Intent
 import android.graphics.Bitmap
 import android.graphics.BitmapFactory
<b>diff --git a/<a id="h8" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/messaging/ModDatabase.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/messaging/ModDatabase.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/messaging/ModDatabase.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/messaging/ModDatabase.kt</a></b>
<a href="#h8-0" id="h8-0" class="h">@@ -1,405 +0,0 @@
</a><a href="#h8-0-0" id="h8-0-0" class="d">-package me.rhunk.snapenhance.messaging
</a><a href="#h8-0-1" id="h8-0-1" class="d">-
</a><a href="#h8-0-2" id="h8-0-2" class="d">-import android.content.ContentValues
</a><a href="#h8-0-3" id="h8-0-3" class="d">-import android.database.sqlite.SQLiteDatabase
</a><a href="#h8-0-4" id="h8-0-4" class="d">-import kotlinx.coroutines.runBlocking
</a><a href="#h8-0-5" id="h8-0-5" class="d">-import me.rhunk.snapenhance.RemoteSideContext
</a><a href="#h8-0-6" id="h8-0-6" class="d">-import me.rhunk.snapenhance.common.data.*
</a><a href="#h8-0-7" id="h8-0-7" class="d">-import me.rhunk.snapenhance.common.scripting.type.ModuleInfo
</a><a href="#h8-0-8" id="h8-0-8" class="d">-import me.rhunk.snapenhance.common.util.SQLiteDatabaseHelper
</a><a href="#h8-0-9" id="h8-0-9" class="d">-import me.rhunk.snapenhance.common.util.ktx.getInteger
</a><a href="#h8-0-10" id="h8-0-10" class="d">-import me.rhunk.snapenhance.common.util.ktx.getLongOrNull
</a><a href="#h8-0-11" id="h8-0-11" class="d">-import me.rhunk.snapenhance.common.util.ktx.getStringOrNull
</a><a href="#h8-0-12" id="h8-0-12" class="d">-import java.util.concurrent.Executors
</a><a href="#h8-0-13" id="h8-0-13" class="d">-import kotlin.coroutines.suspendCoroutine
</a><a href="#h8-0-14" id="h8-0-14" class="d">-
</a><a href="#h8-0-15" id="h8-0-15" class="d">-
</a><a href="#h8-0-16" id="h8-0-16" class="d">-class ModDatabase(
</a><a href="#h8-0-17" id="h8-0-17" class="d">-    private val context: RemoteSideContext,
</a><a href="#h8-0-18" id="h8-0-18" class="d">-) {
</a><a href="#h8-0-19" id="h8-0-19" class="d">-    private val executor = Executors.newSingleThreadExecutor()
</a><a href="#h8-0-20" id="h8-0-20" class="d">-    private lateinit var database: SQLiteDatabase
</a><a href="#h8-0-21" id="h8-0-21" class="d">-
</a><a href="#h8-0-22" id="h8-0-22" class="d">-    var receiveMessagingDataCallback: (friends: List&lt;MessagingFriendInfo&gt;, groups: List&lt;MessagingGroupInfo&gt;) -&gt; Unit = { _, _ -&gt; }
</a><a href="#h8-0-23" id="h8-0-23" class="d">-
</a><a href="#h8-0-24" id="h8-0-24" class="d">-    fun executeAsync(block: () -&gt; Unit) {
</a><a href="#h8-0-25" id="h8-0-25" class="d">-        executor.execute {
</a><a href="#h8-0-26" id="h8-0-26" class="d">-            runCatching {
</a><a href="#h8-0-27" id="h8-0-27" class="d">-                block()
</a><a href="#h8-0-28" id="h8-0-28" class="d">-            }.onFailure {
</a><a href="#h8-0-29" id="h8-0-29" class="d">-                context.log.error(&quot;Failed to execute async block&quot;, it)
</a><a href="#h8-0-30" id="h8-0-30" class="d">-            }
</a><a href="#h8-0-31" id="h8-0-31" class="d">-        }
</a><a href="#h8-0-32" id="h8-0-32" class="d">-    }
</a><a href="#h8-0-33" id="h8-0-33" class="d">-
</a><a href="#h8-0-34" id="h8-0-34" class="d">-    fun init() {
</a><a href="#h8-0-35" id="h8-0-35" class="d">-        database = context.androidContext.openOrCreateDatabase(&quot;main.db&quot;, 0, null)
</a><a href="#h8-0-36" id="h8-0-36" class="d">-        SQLiteDatabaseHelper.createTablesFromSchema(database, mapOf(
</a><a href="#h8-0-37" id="h8-0-37" class="d">-            &quot;friends&quot; to listOf(
</a><a href="#h8-0-38" id="h8-0-38" class="d">-                &quot;id INTEGER PRIMARY KEY AUTOINCREMENT&quot;,
</a><a href="#h8-0-39" id="h8-0-39" class="d">-                &quot;userId CHAR(36) UNIQUE&quot;,
</a><a href="#h8-0-40" id="h8-0-40" class="d">-                &quot;dmConversationId VARCHAR(36)&quot;,
</a><a href="#h8-0-41" id="h8-0-41" class="d">-                &quot;displayName VARCHAR&quot;,
</a><a href="#h8-0-42" id="h8-0-42" class="d">-                &quot;mutableUsername VARCHAR&quot;,
</a><a href="#h8-0-43" id="h8-0-43" class="d">-                &quot;bitmojiId VARCHAR&quot;,
</a><a href="#h8-0-44" id="h8-0-44" class="d">-                &quot;selfieId VARCHAR&quot;
</a><a href="#h8-0-45" id="h8-0-45" class="d">-            ),
</a><a href="#h8-0-46" id="h8-0-46" class="d">-            &quot;groups&quot; to listOf(
</a><a href="#h8-0-47" id="h8-0-47" class="d">-                &quot;id INTEGER PRIMARY KEY AUTOINCREMENT&quot;,
</a><a href="#h8-0-48" id="h8-0-48" class="d">-                &quot;conversationId CHAR(36) UNIQUE&quot;,
</a><a href="#h8-0-49" id="h8-0-49" class="d">-                &quot;name VARCHAR&quot;,
</a><a href="#h8-0-50" id="h8-0-50" class="d">-                &quot;participantsCount INTEGER&quot;
</a><a href="#h8-0-51" id="h8-0-51" class="d">-            ),
</a><a href="#h8-0-52" id="h8-0-52" class="d">-            &quot;rules&quot; to listOf(
</a><a href="#h8-0-53" id="h8-0-53" class="d">-                &quot;id INTEGER PRIMARY KEY AUTOINCREMENT&quot;,
</a><a href="#h8-0-54" id="h8-0-54" class="d">-                &quot;type VARCHAR&quot;,
</a><a href="#h8-0-55" id="h8-0-55" class="d">-                &quot;targetUuid VARCHAR&quot;
</a><a href="#h8-0-56" id="h8-0-56" class="d">-            ),
</a><a href="#h8-0-57" id="h8-0-57" class="d">-            &quot;streaks&quot; to listOf(
</a><a href="#h8-0-58" id="h8-0-58" class="d">-                &quot;id VARCHAR PRIMARY KEY&quot;,
</a><a href="#h8-0-59" id="h8-0-59" class="d">-                &quot;notify BOOLEAN&quot;,
</a><a href="#h8-0-60" id="h8-0-60" class="d">-                &quot;expirationTimestamp BIGINT&quot;,
</a><a href="#h8-0-61" id="h8-0-61" class="d">-                &quot;length INTEGER&quot;
</a><a href="#h8-0-62" id="h8-0-62" class="d">-            ),
</a><a href="#h8-0-63" id="h8-0-63" class="d">-            &quot;scripts&quot; to listOf(
</a><a href="#h8-0-64" id="h8-0-64" class="d">-                &quot;name VARCHAR PRIMARY KEY&quot;,
</a><a href="#h8-0-65" id="h8-0-65" class="d">-                &quot;version VARCHAR NOT NULL&quot;,
</a><a href="#h8-0-66" id="h8-0-66" class="d">-                &quot;displayName VARCHAR&quot;,
</a><a href="#h8-0-67" id="h8-0-67" class="d">-                &quot;description VARCHAR&quot;,
</a><a href="#h8-0-68" id="h8-0-68" class="d">-                &quot;author VARCHAR NOT NULL&quot;,
</a><a href="#h8-0-69" id="h8-0-69" class="d">-                &quot;enabled BOOLEAN&quot;
</a><a href="#h8-0-70" id="h8-0-70" class="d">-            ),
</a><a href="#h8-0-71" id="h8-0-71" class="d">-            &quot;tracker_rules&quot; to listOf(
</a><a href="#h8-0-72" id="h8-0-72" class="d">-                &quot;id INTEGER PRIMARY KEY AUTOINCREMENT&quot;,
</a><a href="#h8-0-73" id="h8-0-73" class="d">-                &quot;flags INTEGER&quot;,
</a><a href="#h8-0-74" id="h8-0-74" class="d">-                &quot;conversation_id CHAR(36)&quot;, // nullable
</a><a href="#h8-0-75" id="h8-0-75" class="d">-                &quot;user_id CHAR(36)&quot;, // nullable
</a><a href="#h8-0-76" id="h8-0-76" class="d">-            ),
</a><a href="#h8-0-77" id="h8-0-77" class="d">-            &quot;tracker_rules_events&quot; to listOf(
</a><a href="#h8-0-78" id="h8-0-78" class="d">-                &quot;id INTEGER PRIMARY KEY AUTOINCREMENT&quot;,
</a><a href="#h8-0-79" id="h8-0-79" class="d">-                &quot;flags INTEGER&quot;,
</a><a href="#h8-0-80" id="h8-0-80" class="d">-                &quot;rule_id INTEGER&quot;,
</a><a href="#h8-0-81" id="h8-0-81" class="d">-                &quot;event_type VARCHAR&quot;,
</a><a href="#h8-0-82" id="h8-0-82" class="d">-            )
</a><a href="#h8-0-83" id="h8-0-83" class="d">-        ))
</a><a href="#h8-0-84" id="h8-0-84" class="d">-    }
</a><a href="#h8-0-85" id="h8-0-85" class="d">-
</a><a href="#h8-0-86" id="h8-0-86" class="d">-    fun getGroups(): List&lt;MessagingGroupInfo&gt; {
</a><a href="#h8-0-87" id="h8-0-87" class="d">-        return database.rawQuery(&quot;SELECT * FROM groups&quot;, null).use { cursor -&gt;
</a><a href="#h8-0-88" id="h8-0-88" class="d">-            val groups = mutableListOf&lt;MessagingGroupInfo&gt;()
</a><a href="#h8-0-89" id="h8-0-89" class="d">-            while (cursor.moveToNext()) {
</a><a href="#h8-0-90" id="h8-0-90" class="d">-                groups.add(MessagingGroupInfo.fromCursor(cursor))
</a><a href="#h8-0-91" id="h8-0-91" class="d">-            }
</a><a href="#h8-0-92" id="h8-0-92" class="d">-            groups
</a><a href="#h8-0-93" id="h8-0-93" class="d">-        }
</a><a href="#h8-0-94" id="h8-0-94" class="d">-    }
</a><a href="#h8-0-95" id="h8-0-95" class="d">-
</a><a href="#h8-0-96" id="h8-0-96" class="d">-    fun getFriends(descOrder: Boolean = false): List&lt;MessagingFriendInfo&gt; {
</a><a href="#h8-0-97" id="h8-0-97" class="d">-        return database.rawQuery(&quot;SELECT * FROM friends LEFT OUTER JOIN streaks ON friends.userId = streaks.id ORDER BY id ${if (descOrder) &quot;DESC&quot; else &quot;ASC&quot;}&quot;, null).use { cursor -&gt;
</a><a href="#h8-0-98" id="h8-0-98" class="d">-            val friends = mutableListOf&lt;MessagingFriendInfo&gt;()
</a><a href="#h8-0-99" id="h8-0-99" class="d">-            while (cursor.moveToNext()) {
</a><a href="#h8-0-100" id="h8-0-100" class="d">-                runCatching {
</a><a href="#h8-0-101" id="h8-0-101" class="d">-                    friends.add(MessagingFriendInfo.fromCursor(cursor))
</a><a href="#h8-0-102" id="h8-0-102" class="d">-                }.onFailure {
</a><a href="#h8-0-103" id="h8-0-103" class="d">-                    context.log.error(&quot;Failed to parse friend&quot;, it)
</a><a href="#h8-0-104" id="h8-0-104" class="d">-                }
</a><a href="#h8-0-105" id="h8-0-105" class="d">-            }
</a><a href="#h8-0-106" id="h8-0-106" class="d">-            friends
</a><a href="#h8-0-107" id="h8-0-107" class="d">-        }
</a><a href="#h8-0-108" id="h8-0-108" class="d">-    }
</a><a href="#h8-0-109" id="h8-0-109" class="d">-
</a><a href="#h8-0-110" id="h8-0-110" class="d">-
</a><a href="#h8-0-111" id="h8-0-111" class="d">-    fun syncGroupInfo(conversationInfo: MessagingGroupInfo) {
</a><a href="#h8-0-112" id="h8-0-112" class="d">-        executeAsync {
</a><a href="#h8-0-113" id="h8-0-113" class="d">-            try {
</a><a href="#h8-0-114" id="h8-0-114" class="d">-                database.execSQL(&quot;INSERT OR REPLACE INTO groups (conversationId, name, participantsCount) VALUES (?, ?, ?)&quot;, arrayOf(
</a><a href="#h8-0-115" id="h8-0-115" class="d">-                    conversationInfo.conversationId,
</a><a href="#h8-0-116" id="h8-0-116" class="d">-                    conversationInfo.name,
</a><a href="#h8-0-117" id="h8-0-117" class="d">-                    conversationInfo.participantsCount
</a><a href="#h8-0-118" id="h8-0-118" class="d">-                ))
</a><a href="#h8-0-119" id="h8-0-119" class="d">-            } catch (e: Exception) {
</a><a href="#h8-0-120" id="h8-0-120" class="d">-                throw e
</a><a href="#h8-0-121" id="h8-0-121" class="d">-            }
</a><a href="#h8-0-122" id="h8-0-122" class="d">-        }
</a><a href="#h8-0-123" id="h8-0-123" class="d">-    }
</a><a href="#h8-0-124" id="h8-0-124" class="d">-
</a><a href="#h8-0-125" id="h8-0-125" class="d">-    fun syncFriend(friend: MessagingFriendInfo) {
</a><a href="#h8-0-126" id="h8-0-126" class="d">-        executeAsync {
</a><a href="#h8-0-127" id="h8-0-127" class="d">-            try {
</a><a href="#h8-0-128" id="h8-0-128" class="d">-                database.execSQL(
</a><a href="#h8-0-129" id="h8-0-129" class="d">-                    &quot;INSERT OR REPLACE INTO friends (userId, dmConversationId, displayName, mutableUsername, bitmojiId, selfieId) VALUES (?, ?, ?, ?, ?, ?)&quot;,
</a><a href="#h8-0-130" id="h8-0-130" class="d">-                    arrayOf(
</a><a href="#h8-0-131" id="h8-0-131" class="d">-                        friend.userId,
</a><a href="#h8-0-132" id="h8-0-132" class="d">-                        friend.dmConversationId,
</a><a href="#h8-0-133" id="h8-0-133" class="d">-                        friend.displayName,
</a><a href="#h8-0-134" id="h8-0-134" class="d">-                        friend.mutableUsername,
</a><a href="#h8-0-135" id="h8-0-135" class="d">-                        friend.bitmojiId,
</a><a href="#h8-0-136" id="h8-0-136" class="d">-                        friend.selfieId
</a><a href="#h8-0-137" id="h8-0-137" class="d">-                    )
</a><a href="#h8-0-138" id="h8-0-138" class="d">-                )
</a><a href="#h8-0-139" id="h8-0-139" class="d">-                //sync streaks
</a><a href="#h8-0-140" id="h8-0-140" class="d">-                friend.streaks?.takeIf { it.length &gt; 0 }?.let {
</a><a href="#h8-0-141" id="h8-0-141" class="d">-                    val streaks = getFriendStreaks(friend.userId)
</a><a href="#h8-0-142" id="h8-0-142" class="d">-
</a><a href="#h8-0-143" id="h8-0-143" class="d">-                    database.execSQL(&quot;INSERT OR REPLACE INTO streaks (id, notify, expirationTimestamp, length) VALUES (?, ?, ?, ?)&quot;, arrayOf(
</a><a href="#h8-0-144" id="h8-0-144" class="d">-                        friend.userId,
</a><a href="#h8-0-145" id="h8-0-145" class="d">-                        streaks?.notify ?: true,
</a><a href="#h8-0-146" id="h8-0-146" class="d">-                        it.expirationTimestamp,
</a><a href="#h8-0-147" id="h8-0-147" class="d">-                        it.length
</a><a href="#h8-0-148" id="h8-0-148" class="d">-                    ))
</a><a href="#h8-0-149" id="h8-0-149" class="d">-                } ?: database.execSQL(&quot;DELETE FROM streaks WHERE id = ?&quot;, arrayOf(friend.userId))
</a><a href="#h8-0-150" id="h8-0-150" class="d">-            } catch (e: Exception) {
</a><a href="#h8-0-151" id="h8-0-151" class="d">-                throw e
</a><a href="#h8-0-152" id="h8-0-152" class="d">-            }
</a><a href="#h8-0-153" id="h8-0-153" class="d">-        }
</a><a href="#h8-0-154" id="h8-0-154" class="d">-    }
</a><a href="#h8-0-155" id="h8-0-155" class="d">-
</a><a href="#h8-0-156" id="h8-0-156" class="d">-    fun getRules(targetUuid: String): List&lt;MessagingRuleType&gt; {
</a><a href="#h8-0-157" id="h8-0-157" class="d">-        return database.rawQuery(&quot;SELECT type FROM rules WHERE targetUuid = ?&quot;, arrayOf(
</a><a href="#h8-0-158" id="h8-0-158" class="d">-            targetUuid
</a><a href="#h8-0-159" id="h8-0-159" class="d">-        )).use { cursor -&gt;
</a><a href="#h8-0-160" id="h8-0-160" class="d">-            val rules = mutableListOf&lt;MessagingRuleType&gt;()
</a><a href="#h8-0-161" id="h8-0-161" class="d">-            while (cursor.moveToNext()) {
</a><a href="#h8-0-162" id="h8-0-162" class="d">-                runCatching {
</a><a href="#h8-0-163" id="h8-0-163" class="d">-                    rules.add(MessagingRuleType.getByName(cursor.getStringOrNull(&quot;type&quot;)!!) ?: return@runCatching)
</a><a href="#h8-0-164" id="h8-0-164" class="d">-                }.onFailure {
</a><a href="#h8-0-165" id="h8-0-165" class="d">-                    context.log.error(&quot;Failed to parse rule&quot;, it)
</a><a href="#h8-0-166" id="h8-0-166" class="d">-                }
</a><a href="#h8-0-167" id="h8-0-167" class="d">-            }
</a><a href="#h8-0-168" id="h8-0-168" class="d">-            rules
</a><a href="#h8-0-169" id="h8-0-169" class="d">-        }
</a><a href="#h8-0-170" id="h8-0-170" class="d">-    }
</a><a href="#h8-0-171" id="h8-0-171" class="d">-
</a><a href="#h8-0-172" id="h8-0-172" class="d">-    fun setRule(targetUuid: String, type: String, enabled: Boolean) {
</a><a href="#h8-0-173" id="h8-0-173" class="d">-        executeAsync {
</a><a href="#h8-0-174" id="h8-0-174" class="d">-            if (enabled) {
</a><a href="#h8-0-175" id="h8-0-175" class="d">-                database.execSQL(&quot;INSERT OR REPLACE INTO rules (targetUuid, type) VALUES (?, ?)&quot;, arrayOf(
</a><a href="#h8-0-176" id="h8-0-176" class="d">-                    targetUuid,
</a><a href="#h8-0-177" id="h8-0-177" class="d">-                    type
</a><a href="#h8-0-178" id="h8-0-178" class="d">-                ))
</a><a href="#h8-0-179" id="h8-0-179" class="d">-            } else {
</a><a href="#h8-0-180" id="h8-0-180" class="d">-                database.execSQL(&quot;DELETE FROM rules WHERE targetUuid = ? AND type = ?&quot;, arrayOf(
</a><a href="#h8-0-181" id="h8-0-181" class="d">-                    targetUuid,
</a><a href="#h8-0-182" id="h8-0-182" class="d">-                    type
</a><a href="#h8-0-183" id="h8-0-183" class="d">-                ))
</a><a href="#h8-0-184" id="h8-0-184" class="d">-            }
</a><a href="#h8-0-185" id="h8-0-185" class="d">-        }
</a><a href="#h8-0-186" id="h8-0-186" class="d">-    }
</a><a href="#h8-0-187" id="h8-0-187" class="d">-
</a><a href="#h8-0-188" id="h8-0-188" class="d">-    fun getFriendInfo(userId: String): MessagingFriendInfo? {
</a><a href="#h8-0-189" id="h8-0-189" class="d">-        return database.rawQuery(&quot;SELECT * FROM friends LEFT OUTER JOIN streaks ON friends.userId = streaks.id WHERE userId = ?&quot;, arrayOf(userId)).use { cursor -&gt;
</a><a href="#h8-0-190" id="h8-0-190" class="d">-            if (!cursor.moveToFirst()) return@use null
</a><a href="#h8-0-191" id="h8-0-191" class="d">-            MessagingFriendInfo.fromCursor(cursor)
</a><a href="#h8-0-192" id="h8-0-192" class="d">-        }
</a><a href="#h8-0-193" id="h8-0-193" class="d">-    }
</a><a href="#h8-0-194" id="h8-0-194" class="d">-
</a><a href="#h8-0-195" id="h8-0-195" class="d">-    fun findFriend(conversationId: String): MessagingFriendInfo? {
</a><a href="#h8-0-196" id="h8-0-196" class="d">-        return database.rawQuery(&quot;SELECT * FROM friends WHERE dmConversationId = ?&quot;, arrayOf(conversationId)).use { cursor -&gt;
</a><a href="#h8-0-197" id="h8-0-197" class="d">-            if (!cursor.moveToFirst()) return@use null
</a><a href="#h8-0-198" id="h8-0-198" class="d">-            MessagingFriendInfo.fromCursor(cursor)
</a><a href="#h8-0-199" id="h8-0-199" class="d">-        }
</a><a href="#h8-0-200" id="h8-0-200" class="d">-    }
</a><a href="#h8-0-201" id="h8-0-201" class="d">-
</a><a href="#h8-0-202" id="h8-0-202" class="d">-    fun deleteFriend(userId: String) {
</a><a href="#h8-0-203" id="h8-0-203" class="d">-        executeAsync {
</a><a href="#h8-0-204" id="h8-0-204" class="d">-            database.execSQL(&quot;DELETE FROM friends WHERE userId = ?&quot;, arrayOf(userId))
</a><a href="#h8-0-205" id="h8-0-205" class="d">-            database.execSQL(&quot;DELETE FROM streaks WHERE id = ?&quot;, arrayOf(userId))
</a><a href="#h8-0-206" id="h8-0-206" class="d">-            database.execSQL(&quot;DELETE FROM rules WHERE targetUuid = ?&quot;, arrayOf(userId))
</a><a href="#h8-0-207" id="h8-0-207" class="d">-        }
</a><a href="#h8-0-208" id="h8-0-208" class="d">-    }
</a><a href="#h8-0-209" id="h8-0-209" class="d">-
</a><a href="#h8-0-210" id="h8-0-210" class="d">-    fun deleteGroup(conversationId: String) {
</a><a href="#h8-0-211" id="h8-0-211" class="d">-        executeAsync {
</a><a href="#h8-0-212" id="h8-0-212" class="d">-            database.execSQL(&quot;DELETE FROM groups WHERE conversationId = ?&quot;, arrayOf(conversationId))
</a><a href="#h8-0-213" id="h8-0-213" class="d">-            database.execSQL(&quot;DELETE FROM rules WHERE targetUuid = ?&quot;, arrayOf(conversationId))
</a><a href="#h8-0-214" id="h8-0-214" class="d">-        }
</a><a href="#h8-0-215" id="h8-0-215" class="d">-    }
</a><a href="#h8-0-216" id="h8-0-216" class="d">-
</a><a href="#h8-0-217" id="h8-0-217" class="d">-    fun getGroupInfo(conversationId: String): MessagingGroupInfo? {
</a><a href="#h8-0-218" id="h8-0-218" class="d">-        return database.rawQuery(&quot;SELECT * FROM groups WHERE conversationId = ?&quot;, arrayOf(conversationId)).use { cursor -&gt;
</a><a href="#h8-0-219" id="h8-0-219" class="d">-            if (!cursor.moveToFirst()) return@use null
</a><a href="#h8-0-220" id="h8-0-220" class="d">-            MessagingGroupInfo.fromCursor(cursor)
</a><a href="#h8-0-221" id="h8-0-221" class="d">-        }
</a><a href="#h8-0-222" id="h8-0-222" class="d">-    }
</a><a href="#h8-0-223" id="h8-0-223" class="d">-
</a><a href="#h8-0-224" id="h8-0-224" class="d">-    fun getFriendStreaks(userId: String): FriendStreaks? {
</a><a href="#h8-0-225" id="h8-0-225" class="d">-        return database.rawQuery(&quot;SELECT * FROM streaks WHERE id = ?&quot;, arrayOf(userId)).use { cursor -&gt;
</a><a href="#h8-0-226" id="h8-0-226" class="d">-            if (!cursor.moveToFirst()) return@use null
</a><a href="#h8-0-227" id="h8-0-227" class="d">-            FriendStreaks(
</a><a href="#h8-0-228" id="h8-0-228" class="d">-                notify = cursor.getInteger(&quot;notify&quot;) == 1,
</a><a href="#h8-0-229" id="h8-0-229" class="d">-                expirationTimestamp = cursor.getLongOrNull(&quot;expirationTimestamp&quot;) ?: 0L,
</a><a href="#h8-0-230" id="h8-0-230" class="d">-                length = cursor.getInteger(&quot;length&quot;)
</a><a href="#h8-0-231" id="h8-0-231" class="d">-            )
</a><a href="#h8-0-232" id="h8-0-232" class="d">-        }
</a><a href="#h8-0-233" id="h8-0-233" class="d">-    }
</a><a href="#h8-0-234" id="h8-0-234" class="d">-
</a><a href="#h8-0-235" id="h8-0-235" class="d">-    fun setFriendStreaksNotify(userId: String, notify: Boolean) {
</a><a href="#h8-0-236" id="h8-0-236" class="d">-        executeAsync {
</a><a href="#h8-0-237" id="h8-0-237" class="d">-            database.execSQL(&quot;UPDATE streaks SET notify = ? WHERE id = ?&quot;, arrayOf(
</a><a href="#h8-0-238" id="h8-0-238" class="d">-                if (notify) 1 else 0,
</a><a href="#h8-0-239" id="h8-0-239" class="d">-                userId
</a><a href="#h8-0-240" id="h8-0-240" class="d">-            ))
</a><a href="#h8-0-241" id="h8-0-241" class="d">-        }
</a><a href="#h8-0-242" id="h8-0-242" class="d">-    }
</a><a href="#h8-0-243" id="h8-0-243" class="d">-
</a><a href="#h8-0-244" id="h8-0-244" class="d">-    fun getRuleIds(type: String): MutableList&lt;String&gt; {
</a><a href="#h8-0-245" id="h8-0-245" class="d">-        return database.rawQuery(&quot;SELECT targetUuid FROM rules WHERE type = ?&quot;, arrayOf(type)).use { cursor -&gt;
</a><a href="#h8-0-246" id="h8-0-246" class="d">-            val ruleIds = mutableListOf&lt;String&gt;()
</a><a href="#h8-0-247" id="h8-0-247" class="d">-            while (cursor.moveToNext()) {
</a><a href="#h8-0-248" id="h8-0-248" class="d">-                ruleIds.add(cursor.getStringOrNull(&quot;targetUuid&quot;)!!)
</a><a href="#h8-0-249" id="h8-0-249" class="d">-            }
</a><a href="#h8-0-250" id="h8-0-250" class="d">-            ruleIds
</a><a href="#h8-0-251" id="h8-0-251" class="d">-        }
</a><a href="#h8-0-252" id="h8-0-252" class="d">-    }
</a><a href="#h8-0-253" id="h8-0-253" class="d">-
</a><a href="#h8-0-254" id="h8-0-254" class="d">-    fun getScripts(): List&lt;ModuleInfo&gt; {
</a><a href="#h8-0-255" id="h8-0-255" class="d">-        return database.rawQuery(&quot;SELECT * FROM scripts&quot;, null).use { cursor -&gt;
</a><a href="#h8-0-256" id="h8-0-256" class="d">-            val scripts = mutableListOf&lt;ModuleInfo&gt;()
</a><a href="#h8-0-257" id="h8-0-257" class="d">-            while (cursor.moveToNext()) {
</a><a href="#h8-0-258" id="h8-0-258" class="d">-                scripts.add(
</a><a href="#h8-0-259" id="h8-0-259" class="d">-                    ModuleInfo(
</a><a href="#h8-0-260" id="h8-0-260" class="d">-                        name = cursor.getStringOrNull(&quot;name&quot;)!!,
</a><a href="#h8-0-261" id="h8-0-261" class="d">-                        version = cursor.getStringOrNull(&quot;version&quot;)!!,
</a><a href="#h8-0-262" id="h8-0-262" class="d">-                        displayName = cursor.getStringOrNull(&quot;displayName&quot;),
</a><a href="#h8-0-263" id="h8-0-263" class="d">-                        description = cursor.getStringOrNull(&quot;description&quot;),
</a><a href="#h8-0-264" id="h8-0-264" class="d">-                        author = cursor.getStringOrNull(&quot;author&quot;),
</a><a href="#h8-0-265" id="h8-0-265" class="d">-                        grantedPermissions = emptyList()
</a><a href="#h8-0-266" id="h8-0-266" class="d">-                    )
</a><a href="#h8-0-267" id="h8-0-267" class="d">-                )
</a><a href="#h8-0-268" id="h8-0-268" class="d">-            }
</a><a href="#h8-0-269" id="h8-0-269" class="d">-            scripts
</a><a href="#h8-0-270" id="h8-0-270" class="d">-        }
</a><a href="#h8-0-271" id="h8-0-271" class="d">-    }
</a><a href="#h8-0-272" id="h8-0-272" class="d">-
</a><a href="#h8-0-273" id="h8-0-273" class="d">-    fun setScriptEnabled(name: String, enabled: Boolean) {
</a><a href="#h8-0-274" id="h8-0-274" class="d">-        executeAsync {
</a><a href="#h8-0-275" id="h8-0-275" class="d">-            database.execSQL(&quot;UPDATE scripts SET enabled = ? WHERE name = ?&quot;, arrayOf(
</a><a href="#h8-0-276" id="h8-0-276" class="d">-                if (enabled) 1 else 0,
</a><a href="#h8-0-277" id="h8-0-277" class="d">-                name
</a><a href="#h8-0-278" id="h8-0-278" class="d">-            ))
</a><a href="#h8-0-279" id="h8-0-279" class="d">-        }
</a><a href="#h8-0-280" id="h8-0-280" class="d">-    }
</a><a href="#h8-0-281" id="h8-0-281" class="d">-
</a><a href="#h8-0-282" id="h8-0-282" class="d">-    fun isScriptEnabled(name: String): Boolean {
</a><a href="#h8-0-283" id="h8-0-283" class="d">-        return database.rawQuery(&quot;SELECT enabled FROM scripts WHERE name = ?&quot;, arrayOf(name)).use { cursor -&gt;
</a><a href="#h8-0-284" id="h8-0-284" class="d">-            if (!cursor.moveToFirst()) return@use false
</a><a href="#h8-0-285" id="h8-0-285" class="d">-            cursor.getInteger(&quot;enabled&quot;) == 1
</a><a href="#h8-0-286" id="h8-0-286" class="d">-        }
</a><a href="#h8-0-287" id="h8-0-287" class="d">-    }
</a><a href="#h8-0-288" id="h8-0-288" class="d">-
</a><a href="#h8-0-289" id="h8-0-289" class="d">-    fun syncScripts(availableScripts: List&lt;ModuleInfo&gt;) {
</a><a href="#h8-0-290" id="h8-0-290" class="d">-        executeAsync {
</a><a href="#h8-0-291" id="h8-0-291" class="d">-            val enabledScripts = getScripts()
</a><a href="#h8-0-292" id="h8-0-292" class="d">-            val enabledScriptPaths = enabledScripts.map { it.name }
</a><a href="#h8-0-293" id="h8-0-293" class="d">-            val availableScriptPaths = availableScripts.map { it.name }
</a><a href="#h8-0-294" id="h8-0-294" class="d">-
</a><a href="#h8-0-295" id="h8-0-295" class="d">-            enabledScripts.forEach { script -&gt;
</a><a href="#h8-0-296" id="h8-0-296" class="d">-                if (!availableScriptPaths.contains(script.name)) {
</a><a href="#h8-0-297" id="h8-0-297" class="d">-                    database.execSQL(&quot;DELETE FROM scripts WHERE name = ?&quot;, arrayOf(script.name))
</a><a href="#h8-0-298" id="h8-0-298" class="d">-                }
</a><a href="#h8-0-299" id="h8-0-299" class="d">-            }
</a><a href="#h8-0-300" id="h8-0-300" class="d">-
</a><a href="#h8-0-301" id="h8-0-301" class="d">-            availableScripts.forEach { script -&gt;
</a><a href="#h8-0-302" id="h8-0-302" class="d">-                if (!enabledScriptPaths.contains(script.name) || script != enabledScripts.find { it.name == script.name }) {
</a><a href="#h8-0-303" id="h8-0-303" class="d">-                    database.execSQL(
</a><a href="#h8-0-304" id="h8-0-304" class="d">-                        &quot;INSERT OR REPLACE INTO scripts (name, version, displayName, description, author, enabled) VALUES (?, ?, ?, ?, ?, ?)&quot;,
</a><a href="#h8-0-305" id="h8-0-305" class="d">-                        arrayOf(
</a><a href="#h8-0-306" id="h8-0-306" class="d">-                            script.name,
</a><a href="#h8-0-307" id="h8-0-307" class="d">-                            script.version,
</a><a href="#h8-0-308" id="h8-0-308" class="d">-                            script.displayName,
</a><a href="#h8-0-309" id="h8-0-309" class="d">-                            script.description,
</a><a href="#h8-0-310" id="h8-0-310" class="d">-                            script.author,
</a><a href="#h8-0-311" id="h8-0-311" class="d">-                            0
</a><a href="#h8-0-312" id="h8-0-312" class="d">-                        )
</a><a href="#h8-0-313" id="h8-0-313" class="d">-                    )
</a><a href="#h8-0-314" id="h8-0-314" class="d">-                }
</a><a href="#h8-0-315" id="h8-0-315" class="d">-            }
</a><a href="#h8-0-316" id="h8-0-316" class="d">-        }
</a><a href="#h8-0-317" id="h8-0-317" class="d">-    }
</a><a href="#h8-0-318" id="h8-0-318" class="d">-
</a><a href="#h8-0-319" id="h8-0-319" class="d">-    fun addTrackerRule(flags: Int, conversationId: String?, userId: String?): Int {
</a><a href="#h8-0-320" id="h8-0-320" class="d">-        return runBlocking {
</a><a href="#h8-0-321" id="h8-0-321" class="d">-            suspendCoroutine { continuation -&gt;
</a><a href="#h8-0-322" id="h8-0-322" class="d">-                executeAsync {
</a><a href="#h8-0-323" id="h8-0-323" class="d">-                    val id = database.insert(&quot;tracker_rules&quot;, null, ContentValues().apply {
</a><a href="#h8-0-324" id="h8-0-324" class="d">-                        put(&quot;flags&quot;, flags)
</a><a href="#h8-0-325" id="h8-0-325" class="d">-                        put(&quot;conversation_id&quot;, conversationId)
</a><a href="#h8-0-326" id="h8-0-326" class="d">-                        put(&quot;user_id&quot;, userId)
</a><a href="#h8-0-327" id="h8-0-327" class="d">-                    })
</a><a href="#h8-0-328" id="h8-0-328" class="d">-                    continuation.resumeWith(Result.success(id.toInt()))
</a><a href="#h8-0-329" id="h8-0-329" class="d">-                }
</a><a href="#h8-0-330" id="h8-0-330" class="d">-            }
</a><a href="#h8-0-331" id="h8-0-331" class="d">-        }
</a><a href="#h8-0-332" id="h8-0-332" class="d">-    }
</a><a href="#h8-0-333" id="h8-0-333" class="d">-
</a><a href="#h8-0-334" id="h8-0-334" class="d">-    fun addTrackerRuleEvent(ruleId: Int, flags: Int, eventType: String) {
</a><a href="#h8-0-335" id="h8-0-335" class="d">-        executeAsync {
</a><a href="#h8-0-336" id="h8-0-336" class="d">-            database.execSQL(&quot;INSERT INTO tracker_rules_events (flags, rule_id, event_type) VALUES (?, ?, ?)&quot;, arrayOf(
</a><a href="#h8-0-337" id="h8-0-337" class="d">-                flags,
</a><a href="#h8-0-338" id="h8-0-338" class="d">-                ruleId,
</a><a href="#h8-0-339" id="h8-0-339" class="d">-                eventType
</a><a href="#h8-0-340" id="h8-0-340" class="d">-            ))
</a><a href="#h8-0-341" id="h8-0-341" class="d">-        }
</a><a href="#h8-0-342" id="h8-0-342" class="d">-    }
</a><a href="#h8-0-343" id="h8-0-343" class="d">-
</a><a href="#h8-0-344" id="h8-0-344" class="d">-     fun getTrackerRules(conversationId: String?, userId: String?): List&lt;TrackerRule&gt; {
</a><a href="#h8-0-345" id="h8-0-345" class="d">-        val rules = mutableListOf&lt;TrackerRule&gt;()
</a><a href="#h8-0-346" id="h8-0-346" class="d">-
</a><a href="#h8-0-347" id="h8-0-347" class="d">-        database.rawQuery(&quot;SELECT * FROM tracker_rules WHERE (conversation_id = ? OR conversation_id IS NULL) AND (user_id = ? OR user_id IS NULL)&quot;, arrayOf(conversationId, userId).filterNotNull().toTypedArray()).use { cursor -&gt;
</a><a href="#h8-0-348" id="h8-0-348" class="d">-            while (cursor.moveToNext()) {
</a><a href="#h8-0-349" id="h8-0-349" class="d">-                rules.add(
</a><a href="#h8-0-350" id="h8-0-350" class="d">-                    TrackerRule(
</a><a href="#h8-0-351" id="h8-0-351" class="d">-                        id = cursor.getInteger(&quot;id&quot;),
</a><a href="#h8-0-352" id="h8-0-352" class="d">-                        flags = cursor.getInteger(&quot;flags&quot;),
</a><a href="#h8-0-353" id="h8-0-353" class="d">-                        conversationId = cursor.getStringOrNull(&quot;conversation_id&quot;),
</a><a href="#h8-0-354" id="h8-0-354" class="d">-                        userId = cursor.getStringOrNull(&quot;user_id&quot;)
</a><a href="#h8-0-355" id="h8-0-355" class="d">-                    )
</a><a href="#h8-0-356" id="h8-0-356" class="d">-                )
</a><a href="#h8-0-357" id="h8-0-357" class="d">-            }
</a><a href="#h8-0-358" id="h8-0-358" class="d">-        }
</a><a href="#h8-0-359" id="h8-0-359" class="d">-        
</a><a href="#h8-0-360" id="h8-0-360" class="d">-        return rules
</a><a href="#h8-0-361" id="h8-0-361" class="d">-    }
</a><a href="#h8-0-362" id="h8-0-362" class="d">-
</a><a href="#h8-0-363" id="h8-0-363" class="d">-    fun getTrackerEvents(ruleId: Int): List&lt;TrackerRuleEvent&gt; {
</a><a href="#h8-0-364" id="h8-0-364" class="d">-        val events = mutableListOf&lt;TrackerRuleEvent&gt;()
</a><a href="#h8-0-365" id="h8-0-365" class="d">-        database.rawQuery(&quot;SELECT * FROM tracker_rules_events WHERE rule_id = ?&quot;, arrayOf(ruleId.toString())).use { cursor -&gt;
</a><a href="#h8-0-366" id="h8-0-366" class="d">-            while (cursor.moveToNext()) {
</a><a href="#h8-0-367" id="h8-0-367" class="d">-                events.add(
</a><a href="#h8-0-368" id="h8-0-368" class="d">-                    TrackerRuleEvent(
</a><a href="#h8-0-369" id="h8-0-369" class="d">-                        id = cursor.getInteger(&quot;id&quot;),
</a><a href="#h8-0-370" id="h8-0-370" class="d">-                        flags = cursor.getInteger(&quot;flags&quot;),
</a><a href="#h8-0-371" id="h8-0-371" class="d">-                        eventType = cursor.getStringOrNull(&quot;event_type&quot;) ?: continue
</a><a href="#h8-0-372" id="h8-0-372" class="d">-                    )
</a><a href="#h8-0-373" id="h8-0-373" class="d">-                )
</a><a href="#h8-0-374" id="h8-0-374" class="d">-            }
</a><a href="#h8-0-375" id="h8-0-375" class="d">-        }
</a><a href="#h8-0-376" id="h8-0-376" class="d">-        return events
</a><a href="#h8-0-377" id="h8-0-377" class="d">-    }
</a><a href="#h8-0-378" id="h8-0-378" class="d">-
</a><a href="#h8-0-379" id="h8-0-379" class="d">-    fun getTrackerEvents(eventType: String): Map&lt;TrackerRuleEvent, TrackerRule&gt; {
</a><a href="#h8-0-380" id="h8-0-380" class="d">-        val events = mutableMapOf&lt;TrackerRuleEvent, TrackerRule&gt;()
</a><a href="#h8-0-381" id="h8-0-381" class="d">-        database.rawQuery(&quot;SELECT tracker_rules_events.id as event_id, tracker_rules_events.flags, tracker_rules_events.event_type, tracker_rules.conversation_id, tracker_rules.user_id &quot; +
</a><a href="#h8-0-382" id="h8-0-382" class="d">-                &quot;FROM tracker_rules_events &quot; +
</a><a href="#h8-0-383" id="h8-0-383" class="d">-                &quot;INNER JOIN tracker_rules &quot; +
</a><a href="#h8-0-384" id="h8-0-384" class="d">-                &quot;ON tracker_rules_events.rule_id = tracker_rules.id &quot; +
</a><a href="#h8-0-385" id="h8-0-385" class="d">-                &quot;WHERE event_type = ?&quot;, arrayOf(eventType)
</a><a href="#h8-0-386" id="h8-0-386" class="d">-        ).use { cursor -&gt;
</a><a href="#h8-0-387" id="h8-0-387" class="d">-            while (cursor.moveToNext()) {
</a><a href="#h8-0-388" id="h8-0-388" class="d">-                val trackerRule = TrackerRule(
</a><a href="#h8-0-389" id="h8-0-389" class="d">-                    id = -1,
</a><a href="#h8-0-390" id="h8-0-390" class="d">-                    flags = cursor.getInteger(&quot;flags&quot;),
</a><a href="#h8-0-391" id="h8-0-391" class="d">-                    conversationId = cursor.getStringOrNull(&quot;conversation_id&quot;),
</a><a href="#h8-0-392" id="h8-0-392" class="d">-                    userId = cursor.getStringOrNull(&quot;user_id&quot;)
</a><a href="#h8-0-393" id="h8-0-393" class="d">-                )
</a><a href="#h8-0-394" id="h8-0-394" class="d">-                val trackerRuleEvent = TrackerRuleEvent(
</a><a href="#h8-0-395" id="h8-0-395" class="d">-                    id = cursor.getInteger(&quot;event_id&quot;),
</a><a href="#h8-0-396" id="h8-0-396" class="d">-                    flags = cursor.getInteger(&quot;flags&quot;),
</a><a href="#h8-0-397" id="h8-0-397" class="d">-                    eventType = cursor.getStringOrNull(&quot;event_type&quot;) ?: continue
</a><a href="#h8-0-398" id="h8-0-398" class="d">-                )
</a><a href="#h8-0-399" id="h8-0-399" class="d">-                events[trackerRuleEvent] = trackerRule
</a><a href="#h8-0-400" id="h8-0-400" class="d">-            }
</a><a href="#h8-0-401" id="h8-0-401" class="d">-        }
</a><a href="#h8-0-402" id="h8-0-402" class="d">-        return events
</a><a href="#h8-0-403" id="h8-0-403" class="d">-    }
</a><a href="#h8-0-404" id="h8-0-404" class="d">-}</a><a href="#h8-0-405" id="h8-0-405" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h9" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/messaging/StreaksReminder.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/messaging/StreaksReminder.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/messaging/StreaksReminder.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/messaging/StreaksReminder.kt</a></b>
<a href="#h9-0" id="h9-0" class="h">@@ -1,126 +0,0 @@
</a><a href="#h9-0-0" id="h9-0-0" class="d">-package me.rhunk.snapenhance.messaging
</a><a href="#h9-0-1" id="h9-0-1" class="d">-
</a><a href="#h9-0-2" id="h9-0-2" class="d">-import android.app.AlarmManager
</a><a href="#h9-0-3" id="h9-0-3" class="d">-import android.app.NotificationChannel
</a><a href="#h9-0-4" id="h9-0-4" class="d">-import android.app.NotificationManager
</a><a href="#h9-0-5" id="h9-0-5" class="d">-import android.app.PendingIntent
</a><a href="#h9-0-6" id="h9-0-6" class="d">-import android.content.BroadcastReceiver
</a><a href="#h9-0-7" id="h9-0-7" class="d">-import android.content.Context
</a><a href="#h9-0-8" id="h9-0-8" class="d">-import android.content.Intent
</a><a href="#h9-0-9" id="h9-0-9" class="d">-import androidx.core.app.NotificationCompat
</a><a href="#h9-0-10" id="h9-0-10" class="d">-import androidx.core.graphics.drawable.toBitmap
</a><a href="#h9-0-11" id="h9-0-11" class="d">-import kotlinx.coroutines.launch
</a><a href="#h9-0-12" id="h9-0-12" class="d">-import me.rhunk.snapenhance.R
</a><a href="#h9-0-13" id="h9-0-13" class="d">-import me.rhunk.snapenhance.RemoteSideContext
</a><a href="#h9-0-14" id="h9-0-14" class="d">-import me.rhunk.snapenhance.SharedContextHolder
</a><a href="#h9-0-15" id="h9-0-15" class="d">-import me.rhunk.snapenhance.bridge.ForceStartActivity
</a><a href="#h9-0-16" id="h9-0-16" class="d">-import me.rhunk.snapenhance.common.util.snap.BitmojiSelfie
</a><a href="#h9-0-17" id="h9-0-17" class="d">-import me.rhunk.snapenhance.ui.util.coil.ImageRequestHelper
</a><a href="#h9-0-18" id="h9-0-18" class="d">-import kotlin.time.Duration.Companion.hours
</a><a href="#h9-0-19" id="h9-0-19" class="d">-import kotlin.time.Duration.Companion.milliseconds
</a><a href="#h9-0-20" id="h9-0-20" class="d">-import kotlin.time.Duration.Companion.minutes
</a><a href="#h9-0-21" id="h9-0-21" class="d">-
</a><a href="#h9-0-22" id="h9-0-22" class="d">-class StreaksReminder(
</a><a href="#h9-0-23" id="h9-0-23" class="d">-    private val remoteSideContext: RemoteSideContext? = null
</a><a href="#h9-0-24" id="h9-0-24" class="d">-): BroadcastReceiver() {
</a><a href="#h9-0-25" id="h9-0-25" class="d">-    companion object {
</a><a href="#h9-0-26" id="h9-0-26" class="d">-        private const val NOTIFICATION_CHANNEL_ID = &quot;streaks&quot;
</a><a href="#h9-0-27" id="h9-0-27" class="d">-    }
</a><a href="#h9-0-28" id="h9-0-28" class="d">-
</a><a href="#h9-0-29" id="h9-0-29" class="d">-    private fun getNotificationManager(context: Context) = context.getSystemService(NotificationManager::class.java).apply {
</a><a href="#h9-0-30" id="h9-0-30" class="d">-        createNotificationChannel(
</a><a href="#h9-0-31" id="h9-0-31" class="d">-            NotificationChannel(
</a><a href="#h9-0-32" id="h9-0-32" class="d">-                NOTIFICATION_CHANNEL_ID,
</a><a href="#h9-0-33" id="h9-0-33" class="d">-                &quot;Streaks&quot;,
</a><a href="#h9-0-34" id="h9-0-34" class="d">-                NotificationManager.IMPORTANCE_HIGH
</a><a href="#h9-0-35" id="h9-0-35" class="d">-            )
</a><a href="#h9-0-36" id="h9-0-36" class="d">-        )
</a><a href="#h9-0-37" id="h9-0-37" class="d">-    }
</a><a href="#h9-0-38" id="h9-0-38" class="d">-
</a><a href="#h9-0-39" id="h9-0-39" class="d">-    override fun onReceive(ctx: Context, intent: Intent) {
</a><a href="#h9-0-40" id="h9-0-40" class="d">-        val remoteSideContext = this.remoteSideContext ?: SharedContextHolder.remote(ctx)
</a><a href="#h9-0-41" id="h9-0-41" class="d">-        val streaksReminderConfig = remoteSideContext.config.root.streaksReminder
</a><a href="#h9-0-42" id="h9-0-42" class="d">-        val sharedPreferences = remoteSideContext.sharedPreferences
</a><a href="#h9-0-43" id="h9-0-43" class="d">-
</a><a href="#h9-0-44" id="h9-0-44" class="d">-        if (streaksReminderConfig.globalState != true) return
</a><a href="#h9-0-45" id="h9-0-45" class="d">-
</a><a href="#h9-0-46" id="h9-0-46" class="d">-        val interval = streaksReminderConfig.interval.get().hours
</a><a href="#h9-0-47" id="h9-0-47" class="d">-        val remainingHours = streaksReminderConfig.remainingHours.get()
</a><a href="#h9-0-48" id="h9-0-48" class="d">-
</a><a href="#h9-0-49" id="h9-0-49" class="d">-        if (sharedPreferences.getLong(&quot;lastStreaksReminder&quot;, 0).milliseconds + interval - 10.minutes &gt; System.currentTimeMillis().milliseconds) return
</a><a href="#h9-0-50" id="h9-0-50" class="d">-        sharedPreferences.edit().putLong(&quot;lastStreaksReminder&quot;, System.currentTimeMillis()).apply()
</a><a href="#h9-0-51" id="h9-0-51" class="d">-
</a><a href="#h9-0-52" id="h9-0-52" class="d">-        remoteSideContext.androidContext.getSystemService(AlarmManager::class.java).setRepeating(
</a><a href="#h9-0-53" id="h9-0-53" class="d">-            AlarmManager.RTC_WAKEUP, 5000, interval.inWholeMilliseconds,
</a><a href="#h9-0-54" id="h9-0-54" class="d">-            PendingIntent.getBroadcast(remoteSideContext.androidContext, 0, Intent(remoteSideContext.androidContext, StreaksReminder::class.java),
</a><a href="#h9-0-55" id="h9-0-55" class="d">-                PendingIntent.FLAG_IMMUTABLE)
</a><a href="#h9-0-56" id="h9-0-56" class="d">-        )
</a><a href="#h9-0-57" id="h9-0-57" class="d">-
</a><a href="#h9-0-58" id="h9-0-58" class="d">-        val notifyFriendList = remoteSideContext.modDatabase.getFriends()
</a><a href="#h9-0-59" id="h9-0-59" class="d">-            .associateBy { remoteSideContext.modDatabase.getFriendStreaks(it.userId) }
</a><a href="#h9-0-60" id="h9-0-60" class="d">-            .filter { (streaks, _) -&gt; streaks != null &amp;&amp; streaks.notify &amp;&amp; streaks.isAboutToExpire(remainingHours) }
</a><a href="#h9-0-61" id="h9-0-61" class="d">-
</a><a href="#h9-0-62" id="h9-0-62" class="d">-        val notificationManager = getNotificationManager(ctx)
</a><a href="#h9-0-63" id="h9-0-63" class="d">-        val streaksReminderTranslation = remoteSideContext.translation.getCategory(&quot;streaks_reminder&quot;)
</a><a href="#h9-0-64" id="h9-0-64" class="d">-
</a><a href="#h9-0-65" id="h9-0-65" class="d">-        if (streaksReminderConfig.groupNotifications.get() &amp;&amp; notifyFriendList.isNotEmpty()) {
</a><a href="#h9-0-66" id="h9-0-66" class="d">-            notificationManager.notify(0, NotificationCompat.Builder(ctx, NOTIFICATION_CHANNEL_ID)
</a><a href="#h9-0-67" id="h9-0-67" class="d">-                .setPriority(NotificationCompat.PRIORITY_HIGH)
</a><a href="#h9-0-68" id="h9-0-68" class="d">-                .setAutoCancel(true)
</a><a href="#h9-0-69" id="h9-0-69" class="d">-                .setGroup(&quot;streaks&quot;)
</a><a href="#h9-0-70" id="h9-0-70" class="d">-                .setGroupSummary(true)
</a><a href="#h9-0-71" id="h9-0-71" class="d">-                .setSmallIcon(R.drawable.streak_icon)
</a><a href="#h9-0-72" id="h9-0-72" class="d">-                .build())
</a><a href="#h9-0-73" id="h9-0-73" class="d">-        }
</a><a href="#h9-0-74" id="h9-0-74" class="d">-
</a><a href="#h9-0-75" id="h9-0-75" class="d">-        notifyFriendList.forEach { (streaks, friend) -&gt;
</a><a href="#h9-0-76" id="h9-0-76" class="d">-            remoteSideContext.coroutineScope.launch {
</a><a href="#h9-0-77" id="h9-0-77" class="d">-                val bitmojiUrl = BitmojiSelfie.getBitmojiSelfie(friend.selfieId, friend.bitmojiId, BitmojiSelfie.BitmojiSelfieType.THREE_D)
</a><a href="#h9-0-78" id="h9-0-78" class="d">-                val bitmojiImage = remoteSideContext.imageLoader.execute(
</a><a href="#h9-0-79" id="h9-0-79" class="d">-                    ImageRequestHelper.newBitmojiImageRequest(ctx, bitmojiUrl)
</a><a href="#h9-0-80" id="h9-0-80" class="d">-                )
</a><a href="#h9-0-81" id="h9-0-81" class="d">-
</a><a href="#h9-0-82" id="h9-0-82" class="d">-                val notificationBuilder = NotificationCompat.Builder(ctx, NOTIFICATION_CHANNEL_ID)
</a><a href="#h9-0-83" id="h9-0-83" class="d">-                    .setContentTitle(streaksReminderTranslation[&quot;notification_title&quot;])
</a><a href="#h9-0-84" id="h9-0-84" class="d">-                    .setContentText(streaksReminderTranslation.format(&quot;notification_text&quot;,
</a><a href="#h9-0-85" id="h9-0-85" class="d">-                        &quot;friend&quot; to (friend.displayName ?: friend.mutableUsername),
</a><a href="#h9-0-86" id="h9-0-86" class="d">-                        &quot;hoursLeft&quot; to (streaks?.hoursLeft() ?: 0).toString()
</a><a href="#h9-0-87" id="h9-0-87" class="d">-                    ))
</a><a href="#h9-0-88" id="h9-0-88" class="d">-                    .setPriority(NotificationCompat.PRIORITY_DEFAULT)
</a><a href="#h9-0-89" id="h9-0-89" class="d">-                    .setAutoCancel(true)
</a><a href="#h9-0-90" id="h9-0-90" class="d">-                    .setGroup(&quot;streaks&quot;)
</a><a href="#h9-0-91" id="h9-0-91" class="d">-                    .setContentIntent(PendingIntent.getActivity(
</a><a href="#h9-0-92" id="h9-0-92" class="d">-                        ctx,
</a><a href="#h9-0-93" id="h9-0-93" class="d">-                        0,
</a><a href="#h9-0-94" id="h9-0-94" class="d">-                        Intent(ctx, ForceStartActivity::class.java).apply {
</a><a href="#h9-0-95" id="h9-0-95" class="d">-                            putExtra(&quot;streaks_notification_action&quot;, true)
</a><a href="#h9-0-96" id="h9-0-96" class="d">-                        },
</a><a href="#h9-0-97" id="h9-0-97" class="d">-                        PendingIntent.FLAG_IMMUTABLE
</a><a href="#h9-0-98" id="h9-0-98" class="d">-                    ))
</a><a href="#h9-0-99" id="h9-0-99" class="d">-                    .apply {
</a><a href="#h9-0-100" id="h9-0-100" class="d">-                        setSmallIcon(R.drawable.streak_icon)
</a><a href="#h9-0-101" id="h9-0-101" class="d">-                        bitmojiImage.drawable?.let {
</a><a href="#h9-0-102" id="h9-0-102" class="d">-                            setLargeIcon(it.toBitmap())
</a><a href="#h9-0-103" id="h9-0-103" class="d">-                        }
</a><a href="#h9-0-104" id="h9-0-104" class="d">-                    }
</a><a href="#h9-0-105" id="h9-0-105" class="d">-
</a><a href="#h9-0-106" id="h9-0-106" class="d">-                if (streaksReminderConfig.groupNotifications.get()) {
</a><a href="#h9-0-107" id="h9-0-107" class="d">-                    notificationBuilder.setGroupAlertBehavior(NotificationCompat.GROUP_ALERT_CHILDREN)
</a><a href="#h9-0-108" id="h9-0-108" class="d">-                }
</a><a href="#h9-0-109" id="h9-0-109" class="d">-
</a><a href="#h9-0-110" id="h9-0-110" class="d">-                notificationManager.notify(friend.userId.hashCode(), notificationBuilder.build().apply {
</a><a href="#h9-0-111" id="h9-0-111" class="d">-                    flags = NotificationCompat.FLAG_ONLY_ALERT_ONCE
</a><a href="#h9-0-112" id="h9-0-112" class="d">-                })
</a><a href="#h9-0-113" id="h9-0-113" class="d">-            }
</a><a href="#h9-0-114" id="h9-0-114" class="d">-        }
</a><a href="#h9-0-115" id="h9-0-115" class="d">-    }
</a><a href="#h9-0-116" id="h9-0-116" class="d">-
</a><a href="#h9-0-117" id="h9-0-117" class="d">-    fun init() {
</a><a href="#h9-0-118" id="h9-0-118" class="d">-        if (remoteSideContext == null) throw IllegalStateException(&quot;RemoteSideContext is null&quot;)
</a><a href="#h9-0-119" id="h9-0-119" class="d">-        if (remoteSideContext.config.root.streaksReminder.globalState != true) return
</a><a href="#h9-0-120" id="h9-0-120" class="d">-
</a><a href="#h9-0-121" id="h9-0-121" class="d">-        onReceive(remoteSideContext.androidContext, Intent())
</a><a href="#h9-0-122" id="h9-0-122" class="d">-    }
</a><a href="#h9-0-123" id="h9-0-123" class="d">-
</a><a href="#h9-0-124" id="h9-0-124" class="d">-    fun dismissAllNotifications() = getNotificationManager(remoteSideContext!!.androidContext).cancelAll()
</a><a href="#h9-0-125" id="h9-0-125" class="d">-}</a><a href="#h9-0-126" id="h9-0-126" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h10" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/scripting/AutoReloadHandler.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/scripting/AutoReloadHandler.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/scripting/AutoReloadHandler.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/scripting/AutoReloadHandler.kt</a></b>
<a href="#h10-0" id="h10-0" class="h">@@ -15,23 +15,27 @@ class AutoReloadHandler(
</a>     private val lastModifiedMap = mutableMapOf&lt;Uri, Long&gt;()
 
     fun addFile(file: DocumentFile) {
<a href="#h10-0-3" id="h10-0-3" class="d">-        files.add(file)
</a><a href="#h10-0-4" id="h10-0-4" class="d">-        lastModifiedMap[file.uri] = file.lastModified()
</a><a href="#h10-0-5" id="h10-0-5" class="i">+        synchronized(lastModifiedMap) {
</a><a href="#h10-0-6" id="h10-0-6" class="i">+            files.add(file)
</a><a href="#h10-0-7" id="h10-0-7" class="i">+            lastModifiedMap[file.uri] = file.lastModified()
</a><a href="#h10-0-8" id="h10-0-8" class="i">+        }
</a>     }
 
     fun start() {
         coroutineScope.launch(Dispatchers.IO) {
             while (true) {
<a href="#h10-0-14" id="h10-0-14" class="d">-                files.forEach { file -&gt;
</a><a href="#h10-0-15" id="h10-0-15" class="d">-                    val lastModified = lastModifiedMap[file.uri] ?: return@forEach
</a><a href="#h10-0-16" id="h10-0-16" class="d">-                    runCatching {
</a><a href="#h10-0-17" id="h10-0-17" class="d">-                        val newLastModified = file.lastModified()
</a><a href="#h10-0-18" id="h10-0-18" class="d">-                        if (newLastModified &gt; lastModified) {
</a><a href="#h10-0-19" id="h10-0-19" class="d">-                            lastModifiedMap[file.uri] = newLastModified
</a><a href="#h10-0-20" id="h10-0-20" class="d">-                            onReload(file)
</a><a href="#h10-0-21" id="h10-0-21" class="i">+                synchronized(lastModifiedMap) {
</a><a href="#h10-0-22" id="h10-0-22" class="i">+                    files.forEach { file -&gt;
</a><a href="#h10-0-23" id="h10-0-23" class="i">+                        val lastModified = lastModifiedMap[file.uri] ?: return@forEach
</a><a href="#h10-0-24" id="h10-0-24" class="i">+                        runCatching {
</a><a href="#h10-0-25" id="h10-0-25" class="i">+                            val newLastModified = file.lastModified()
</a><a href="#h10-0-26" id="h10-0-26" class="i">+                            if (newLastModified &gt; lastModified) {
</a><a href="#h10-0-27" id="h10-0-27" class="i">+                                lastModifiedMap[file.uri] = newLastModified
</a><a href="#h10-0-28" id="h10-0-28" class="i">+                                onReload(file)
</a><a href="#h10-0-29" id="h10-0-29" class="i">+                            }
</a><a href="#h10-0-30" id="h10-0-30" class="i">+                        }.onFailure {
</a><a href="#h10-0-31" id="h10-0-31" class="i">+                            it.printStackTrace()
</a>                         }
<a href="#h10-0-33" id="h10-0-33" class="d">-                    }.onFailure {
</a><a href="#h10-0-34" id="h10-0-34" class="d">-                        it.printStackTrace()
</a>                     }
                 }
                 delay(1000)
<b>diff --git a/<a id="h11" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/scripting/RemoteScriptManager.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/scripting/RemoteScriptManager.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/scripting/RemoteScriptManager.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/scripting/RemoteScriptManager.kt</a></b>
<a href="#h11-0" id="h11-0" class="h">@@ -17,6 +17,10 @@ import me.rhunk.snapenhance.core.util.ktx.toParcelFileDescriptor
</a> import me.rhunk.snapenhance.scripting.impl.IPCListeners
 import me.rhunk.snapenhance.scripting.impl.ManagerIPC
 import me.rhunk.snapenhance.scripting.impl.ManagerScriptConfig
<a href="#h11-0-3" id="h11-0-3" class="i">+import me.rhunk.snapenhance.storage.isScriptEnabled
</a><a href="#h11-0-4" id="h11-0-4" class="i">+import me.rhunk.snapenhance.storage.syncScripts
</a><a href="#h11-0-5" id="h11-0-5" class="i">+import okhttp3.OkHttpClient
</a><a href="#h11-0-6" id="h11-0-6" class="i">+import okhttp3.Request
</a> import java.io.File
 import java.io.InputStream
 import kotlin.system.exitProcess
<a href="#h11-1" id="h11-1" class="h">@@ -28,6 +32,10 @@ class RemoteScriptManager(
</a>         scripting = this@RemoteScriptManager
     }
 
<a href="#h11-1-3" id="h11-1-3" class="i">+    private val okHttpClient by lazy {
</a><a href="#h11-1-4" id="h11-1-4" class="i">+        OkHttpClient.Builder().build()
</a><a href="#h11-1-5" id="h11-1-5" class="i">+    }
</a><a href="#h11-1-6" id="h11-1-6" class="i">+
</a>     private var autoReloadListener: AutoReloadListener? = null
     private val autoReloadHandler by lazy {
         AutoReloadHandler(context.coroutineScope) {
<a href="#h11-2" id="h11-2" class="h">@@ -49,6 +57,7 @@ class RemoteScriptManager(
</a>     private val ipcListeners = IPCListeners()
 
     fun sync() {
<a href="#h11-2-3" id="h11-2-3" class="i">+        cachedModuleInfo.clear()
</a>         getScriptFileNames().forEach { name -&gt;
             runCatching {
                 getScriptInputStream(name) { stream -&gt;
<a href="#h11-3" id="h11-3" class="h">@@ -63,7 +72,7 @@ class RemoteScriptManager(
</a>             }
         }
 
<a href="#h11-3-3" id="h11-3-3" class="d">-        context.modDatabase.syncScripts(cachedModuleInfo.values.toList())
</a><a href="#h11-3-4" id="h11-3-4" class="i">+        context.database.syncScripts(cachedModuleInfo.values.toList())
</a>     }
 
     fun init() {
<a href="#h11-4" id="h11-4" class="h">@@ -77,7 +86,11 @@ class RemoteScriptManager(
</a> 
         sync()
         enabledScripts.forEach { name -&gt;
<a href="#h11-4-3" id="h11-4-3" class="d">-            loadScript(name)
</a><a href="#h11-4-4" id="h11-4-4" class="i">+            runCatching {
</a><a href="#h11-4-5" id="h11-4-5" class="i">+                loadScript(name)
</a><a href="#h11-4-6" id="h11-4-6" class="i">+            }.onFailure {
</a><a href="#h11-4-7" id="h11-4-7" class="i">+                context.log.error(&quot;Failed to load script $name&quot;, it)
</a><a href="#h11-4-8" id="h11-4-8" class="i">+            }
</a>         }
     }
 
<a href="#h11-5" id="h11-5" class="h">@@ -87,10 +100,10 @@ class RemoteScriptManager(
</a> 
     fun loadScript(path: String) {
         val content = getScriptContent(path) ?: return
<a href="#h11-5-3" id="h11-5-3" class="i">+        runtime.load(path, content)
</a>         if (context.config.root.scripting.autoReload.getNullable() != null) {
             autoReloadHandler.addFile(getScriptsFolder()?.findFile(path) ?: return)
         }
<a href="#h11-5-7" id="h11-5-7" class="d">-        runtime.load(path, content)
</a>     }
 
     fun unloadScript(scriptPath: String) {
<a href="#h11-6" id="h11-6" class="h">@@ -119,10 +132,38 @@ class RemoteScriptManager(
</a>         return (getScriptsFolder() ?: return emptyList()).listFiles().filter { it.name?.endsWith(&quot;.js&quot;) ?: false }.map { it.name!! }
     }
 
<a href="#h11-6-3" id="h11-6-3" class="i">+    fun importFromUrl(
</a><a href="#h11-6-4" id="h11-6-4" class="i">+        url: String
</a><a href="#h11-6-5" id="h11-6-5" class="i">+    ): ModuleInfo {
</a><a href="#h11-6-6" id="h11-6-6" class="i">+        val response = okHttpClient.newCall(Request.Builder().url(url).build()).execute()
</a><a href="#h11-6-7" id="h11-6-7" class="i">+        if (!response.isSuccessful) {
</a><a href="#h11-6-8" id="h11-6-8" class="i">+            throw Exception(&quot;Failed to fetch script. Code: ${response.code}&quot;)
</a><a href="#h11-6-9" id="h11-6-9" class="i">+        }
</a><a href="#h11-6-10" id="h11-6-10" class="i">+        response.body.byteStream().use { inputStream -&gt;
</a><a href="#h11-6-11" id="h11-6-11" class="i">+            val bufferedInputStream = inputStream.buffered()
</a><a href="#h11-6-12" id="h11-6-12" class="i">+            bufferedInputStream.mark(0)
</a><a href="#h11-6-13" id="h11-6-13" class="i">+            val moduleInfo = runtime.readModuleInfo(bufferedInputStream.bufferedReader())
</a><a href="#h11-6-14" id="h11-6-14" class="i">+            bufferedInputStream.reset()
</a><a href="#h11-6-15" id="h11-6-15" class="i">+
</a><a href="#h11-6-16" id="h11-6-16" class="i">+            val scriptPath = moduleInfo.name + &quot;.js&quot;
</a><a href="#h11-6-17" id="h11-6-17" class="i">+            val scriptFile = getScriptsFolder()?.findFile(scriptPath) ?: getScriptsFolder()?.createFile(&quot;text/javascript&quot;, scriptPath)
</a><a href="#h11-6-18" id="h11-6-18" class="i">+                ?: throw Exception(&quot;Failed to create script file&quot;)
</a><a href="#h11-6-19" id="h11-6-19" class="i">+
</a><a href="#h11-6-20" id="h11-6-20" class="i">+            context.androidContext.contentResolver.openOutputStream(scriptFile.uri)?.use { output -&gt;
</a><a href="#h11-6-21" id="h11-6-21" class="i">+                bufferedInputStream.copyTo(output)
</a><a href="#h11-6-22" id="h11-6-22" class="i">+            }
</a><a href="#h11-6-23" id="h11-6-23" class="i">+
</a><a href="#h11-6-24" id="h11-6-24" class="i">+            sync()
</a><a href="#h11-6-25" id="h11-6-25" class="i">+            loadScript(scriptPath)
</a><a href="#h11-6-26" id="h11-6-26" class="i">+            runtime.removeModule(scriptPath)
</a><a href="#h11-6-27" id="h11-6-27" class="i">+            return moduleInfo
</a><a href="#h11-6-28" id="h11-6-28" class="i">+        }
</a><a href="#h11-6-29" id="h11-6-29" class="i">+    }
</a><a href="#h11-6-30" id="h11-6-30" class="i">+
</a>     override fun getEnabledScripts(): List&lt;String&gt; {
         return runCatching {
             getScriptFileNames().filter {
<a href="#h11-6-34" id="h11-6-34" class="d">-                context.modDatabase.isScriptEnabled(cachedModuleInfo[it]?.name ?: return@filter false)
</a><a href="#h11-6-35" id="h11-6-35" class="i">+                context.database.isScriptEnabled(cachedModuleInfo[it]?.name ?: return@filter false)
</a>             }
         }.onFailure {
             context.log.error(&quot;Failed to get enabled scripts&quot;, it)
<b>diff --git a/<a id="h12" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/storage/AppDatabase.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/storage/AppDatabase.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/storage/AppDatabase.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/storage/AppDatabase.kt</a></b>
<a href="#h12-0" id="h12-0" class="h">@@ -0,0 +1,93 @@
</a><a href="#h12-0-0" id="h12-0-0" class="i">+package me.rhunk.snapenhance.storage
</a><a href="#h12-0-1" id="h12-0-1" class="i">+
</a><a href="#h12-0-2" id="h12-0-2" class="i">+import android.database.sqlite.SQLiteDatabase
</a><a href="#h12-0-3" id="h12-0-3" class="i">+import me.rhunk.snapenhance.RemoteSideContext
</a><a href="#h12-0-4" id="h12-0-4" class="i">+import me.rhunk.snapenhance.common.data.MessagingFriendInfo
</a><a href="#h12-0-5" id="h12-0-5" class="i">+import me.rhunk.snapenhance.common.data.MessagingGroupInfo
</a><a href="#h12-0-6" id="h12-0-6" class="i">+import me.rhunk.snapenhance.common.util.SQLiteDatabaseHelper
</a><a href="#h12-0-7" id="h12-0-7" class="i">+import java.util.concurrent.ExecutorService
</a><a href="#h12-0-8" id="h12-0-8" class="i">+import java.util.concurrent.Executors
</a><a href="#h12-0-9" id="h12-0-9" class="i">+
</a><a href="#h12-0-10" id="h12-0-10" class="i">+
</a><a href="#h12-0-11" id="h12-0-11" class="i">+class AppDatabase(
</a><a href="#h12-0-12" id="h12-0-12" class="i">+    val context: RemoteSideContext,
</a><a href="#h12-0-13" id="h12-0-13" class="i">+) {
</a><a href="#h12-0-14" id="h12-0-14" class="i">+    val executor: ExecutorService = Executors.newSingleThreadExecutor()
</a><a href="#h12-0-15" id="h12-0-15" class="i">+    lateinit var database: SQLiteDatabase
</a><a href="#h12-0-16" id="h12-0-16" class="i">+
</a><a href="#h12-0-17" id="h12-0-17" class="i">+    var receiveMessagingDataCallback: (friends: List&lt;MessagingFriendInfo&gt;, groups: List&lt;MessagingGroupInfo&gt;) -&gt; Unit = { _, _ -&gt; }
</a><a href="#h12-0-18" id="h12-0-18" class="i">+
</a><a href="#h12-0-19" id="h12-0-19" class="i">+    fun executeAsync(block: () -&gt; Unit) {
</a><a href="#h12-0-20" id="h12-0-20" class="i">+        executor.execute {
</a><a href="#h12-0-21" id="h12-0-21" class="i">+            runCatching {
</a><a href="#h12-0-22" id="h12-0-22" class="i">+                block()
</a><a href="#h12-0-23" id="h12-0-23" class="i">+            }.onFailure {
</a><a href="#h12-0-24" id="h12-0-24" class="i">+                context.log.error(&quot;Failed to execute async block&quot;, it)
</a><a href="#h12-0-25" id="h12-0-25" class="i">+            }
</a><a href="#h12-0-26" id="h12-0-26" class="i">+        }
</a><a href="#h12-0-27" id="h12-0-27" class="i">+    }
</a><a href="#h12-0-28" id="h12-0-28" class="i">+
</a><a href="#h12-0-29" id="h12-0-29" class="i">+    fun init() {
</a><a href="#h12-0-30" id="h12-0-30" class="i">+        database = context.androidContext.openOrCreateDatabase(&quot;main.db&quot;, 0, null)
</a><a href="#h12-0-31" id="h12-0-31" class="i">+        SQLiteDatabaseHelper.createTablesFromSchema(database, mapOf(
</a><a href="#h12-0-32" id="h12-0-32" class="i">+            &quot;friends&quot; to listOf(
</a><a href="#h12-0-33" id="h12-0-33" class="i">+                &quot;id INTEGER PRIMARY KEY AUTOINCREMENT&quot;,
</a><a href="#h12-0-34" id="h12-0-34" class="i">+                &quot;userId CHAR(36) UNIQUE&quot;,
</a><a href="#h12-0-35" id="h12-0-35" class="i">+                &quot;dmConversationId VARCHAR(36)&quot;,
</a><a href="#h12-0-36" id="h12-0-36" class="i">+                &quot;displayName VARCHAR&quot;,
</a><a href="#h12-0-37" id="h12-0-37" class="i">+                &quot;mutableUsername VARCHAR&quot;,
</a><a href="#h12-0-38" id="h12-0-38" class="i">+                &quot;bitmojiId VARCHAR&quot;,
</a><a href="#h12-0-39" id="h12-0-39" class="i">+                &quot;selfieId VARCHAR&quot;
</a><a href="#h12-0-40" id="h12-0-40" class="i">+            ),
</a><a href="#h12-0-41" id="h12-0-41" class="i">+            &quot;groups&quot; to listOf(
</a><a href="#h12-0-42" id="h12-0-42" class="i">+                &quot;id INTEGER PRIMARY KEY AUTOINCREMENT&quot;,
</a><a href="#h12-0-43" id="h12-0-43" class="i">+                &quot;conversationId CHAR(36) UNIQUE&quot;,
</a><a href="#h12-0-44" id="h12-0-44" class="i">+                &quot;name VARCHAR&quot;,
</a><a href="#h12-0-45" id="h12-0-45" class="i">+                &quot;participantsCount INTEGER&quot;
</a><a href="#h12-0-46" id="h12-0-46" class="i">+            ),
</a><a href="#h12-0-47" id="h12-0-47" class="i">+            &quot;rules&quot; to listOf(
</a><a href="#h12-0-48" id="h12-0-48" class="i">+                &quot;id INTEGER PRIMARY KEY AUTOINCREMENT&quot;,
</a><a href="#h12-0-49" id="h12-0-49" class="i">+                &quot;type VARCHAR&quot;,
</a><a href="#h12-0-50" id="h12-0-50" class="i">+                &quot;targetUuid VARCHAR&quot;
</a><a href="#h12-0-51" id="h12-0-51" class="i">+            ),
</a><a href="#h12-0-52" id="h12-0-52" class="i">+            &quot;streaks&quot; to listOf(
</a><a href="#h12-0-53" id="h12-0-53" class="i">+                &quot;id VARCHAR PRIMARY KEY&quot;,
</a><a href="#h12-0-54" id="h12-0-54" class="i">+                &quot;notify BOOLEAN&quot;,
</a><a href="#h12-0-55" id="h12-0-55" class="i">+                &quot;expirationTimestamp BIGINT&quot;,
</a><a href="#h12-0-56" id="h12-0-56" class="i">+                &quot;length INTEGER&quot;
</a><a href="#h12-0-57" id="h12-0-57" class="i">+            ),
</a><a href="#h12-0-58" id="h12-0-58" class="i">+            &quot;scripts&quot; to listOf(
</a><a href="#h12-0-59" id="h12-0-59" class="i">+                &quot;id INTEGER PRIMARY KEY AUTOINCREMENT&quot;,
</a><a href="#h12-0-60" id="h12-0-60" class="i">+                &quot;name VARCHAR NOT NULL&quot;,
</a><a href="#h12-0-61" id="h12-0-61" class="i">+                &quot;version VARCHAR NOT NULL&quot;,
</a><a href="#h12-0-62" id="h12-0-62" class="i">+                &quot;displayName VARCHAR&quot;,
</a><a href="#h12-0-63" id="h12-0-63" class="i">+                &quot;description VARCHAR&quot;,
</a><a href="#h12-0-64" id="h12-0-64" class="i">+                &quot;author VARCHAR NOT NULL&quot;,
</a><a href="#h12-0-65" id="h12-0-65" class="i">+                &quot;enabled BOOLEAN&quot;
</a><a href="#h12-0-66" id="h12-0-66" class="i">+            ),
</a><a href="#h12-0-67" id="h12-0-67" class="i">+            &quot;tracker_rules&quot; to listOf(
</a><a href="#h12-0-68" id="h12-0-68" class="i">+                &quot;id INTEGER PRIMARY KEY AUTOINCREMENT&quot;,
</a><a href="#h12-0-69" id="h12-0-69" class="i">+                &quot;enabled BOOLEAN DEFAULT 1&quot;,
</a><a href="#h12-0-70" id="h12-0-70" class="i">+                &quot;name VARCHAR&quot;,
</a><a href="#h12-0-71" id="h12-0-71" class="i">+            ),
</a><a href="#h12-0-72" id="h12-0-72" class="i">+            &quot;tracker_scopes&quot; to listOf(
</a><a href="#h12-0-73" id="h12-0-73" class="i">+                &quot;id INTEGER PRIMARY KEY AUTOINCREMENT&quot;,
</a><a href="#h12-0-74" id="h12-0-74" class="i">+                &quot;rule_id INTEGER&quot;,
</a><a href="#h12-0-75" id="h12-0-75" class="i">+                &quot;scope_type VARCHAR&quot;,
</a><a href="#h12-0-76" id="h12-0-76" class="i">+                &quot;scope_id CHAR(36)&quot;
</a><a href="#h12-0-77" id="h12-0-77" class="i">+            ),
</a><a href="#h12-0-78" id="h12-0-78" class="i">+            &quot;tracker_rules_events&quot; to listOf(
</a><a href="#h12-0-79" id="h12-0-79" class="i">+                &quot;id INTEGER PRIMARY KEY AUTOINCREMENT&quot;,
</a><a href="#h12-0-80" id="h12-0-80" class="i">+                &quot;rule_id INTEGER&quot;,
</a><a href="#h12-0-81" id="h12-0-81" class="i">+                &quot;flags INTEGER DEFAULT 1&quot;,
</a><a href="#h12-0-82" id="h12-0-82" class="i">+                &quot;event_type VARCHAR&quot;,
</a><a href="#h12-0-83" id="h12-0-83" class="i">+                &quot;params TEXT&quot;,
</a><a href="#h12-0-84" id="h12-0-84" class="i">+                &quot;actions TEXT&quot;
</a><a href="#h12-0-85" id="h12-0-85" class="i">+            ),
</a><a href="#h12-0-86" id="h12-0-86" class="i">+            &quot;quick_tiles&quot; to listOf(
</a><a href="#h12-0-87" id="h12-0-87" class="i">+                &quot;key VARCHAR PRIMARY KEY&quot;,
</a><a href="#h12-0-88" id="h12-0-88" class="i">+                &quot;position INTEGER&quot;,
</a><a href="#h12-0-89" id="h12-0-89" class="i">+            )
</a><a href="#h12-0-90" id="h12-0-90" class="i">+        ))
</a><a href="#h12-0-91" id="h12-0-91" class="i">+    }
</a><a href="#h12-0-92" id="h12-0-92" class="i">+}</a><a href="#h12-0-93" id="h12-0-93" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h13" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/storage/Messaging.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/storage/Messaging.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/storage/Messaging.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/storage/Messaging.kt</a></b>
<a href="#h13-0" id="h13-0" class="h">@@ -0,0 +1,181 @@
</a><a href="#h13-0-0" id="h13-0-0" class="i">+package me.rhunk.snapenhance.storage
</a><a href="#h13-0-1" id="h13-0-1" class="i">+
</a><a href="#h13-0-2" id="h13-0-2" class="i">+import me.rhunk.snapenhance.common.data.FriendStreaks
</a><a href="#h13-0-3" id="h13-0-3" class="i">+import me.rhunk.snapenhance.common.data.MessagingFriendInfo
</a><a href="#h13-0-4" id="h13-0-4" class="i">+import me.rhunk.snapenhance.common.data.MessagingGroupInfo
</a><a href="#h13-0-5" id="h13-0-5" class="i">+import me.rhunk.snapenhance.common.data.MessagingRuleType
</a><a href="#h13-0-6" id="h13-0-6" class="i">+import me.rhunk.snapenhance.common.util.ktx.getInteger
</a><a href="#h13-0-7" id="h13-0-7" class="i">+import me.rhunk.snapenhance.common.util.ktx.getLongOrNull
</a><a href="#h13-0-8" id="h13-0-8" class="i">+import me.rhunk.snapenhance.common.util.ktx.getStringOrNull
</a><a href="#h13-0-9" id="h13-0-9" class="i">+
</a><a href="#h13-0-10" id="h13-0-10" class="i">+
</a><a href="#h13-0-11" id="h13-0-11" class="i">+fun AppDatabase.getGroups(): List&lt;MessagingGroupInfo&gt; {
</a><a href="#h13-0-12" id="h13-0-12" class="i">+    return database.rawQuery(&quot;SELECT * FROM groups&quot;, null).use { cursor -&gt;
</a><a href="#h13-0-13" id="h13-0-13" class="i">+        val groups = mutableListOf&lt;MessagingGroupInfo&gt;()
</a><a href="#h13-0-14" id="h13-0-14" class="i">+        while (cursor.moveToNext()) {
</a><a href="#h13-0-15" id="h13-0-15" class="i">+            groups.add(MessagingGroupInfo.fromCursor(cursor))
</a><a href="#h13-0-16" id="h13-0-16" class="i">+        }
</a><a href="#h13-0-17" id="h13-0-17" class="i">+        groups
</a><a href="#h13-0-18" id="h13-0-18" class="i">+    }
</a><a href="#h13-0-19" id="h13-0-19" class="i">+}
</a><a href="#h13-0-20" id="h13-0-20" class="i">+
</a><a href="#h13-0-21" id="h13-0-21" class="i">+fun AppDatabase.getFriends(descOrder: Boolean = false): List&lt;MessagingFriendInfo&gt; {
</a><a href="#h13-0-22" id="h13-0-22" class="i">+    return database.rawQuery(&quot;SELECT * FROM friends LEFT OUTER JOIN streaks ON friends.userId = streaks.id ORDER BY id ${if (descOrder) &quot;DESC&quot; else &quot;ASC&quot;}&quot;, null).use { cursor -&gt;
</a><a href="#h13-0-23" id="h13-0-23" class="i">+        val friends = mutableListOf&lt;MessagingFriendInfo&gt;()
</a><a href="#h13-0-24" id="h13-0-24" class="i">+        while (cursor.moveToNext()) {
</a><a href="#h13-0-25" id="h13-0-25" class="i">+            runCatching {
</a><a href="#h13-0-26" id="h13-0-26" class="i">+                friends.add(MessagingFriendInfo.fromCursor(cursor))
</a><a href="#h13-0-27" id="h13-0-27" class="i">+            }.onFailure {
</a><a href="#h13-0-28" id="h13-0-28" class="i">+                context.log.error(&quot;Failed to parse friend&quot;, it)
</a><a href="#h13-0-29" id="h13-0-29" class="i">+            }
</a><a href="#h13-0-30" id="h13-0-30" class="i">+        }
</a><a href="#h13-0-31" id="h13-0-31" class="i">+        friends
</a><a href="#h13-0-32" id="h13-0-32" class="i">+    }
</a><a href="#h13-0-33" id="h13-0-33" class="i">+}
</a><a href="#h13-0-34" id="h13-0-34" class="i">+
</a><a href="#h13-0-35" id="h13-0-35" class="i">+
</a><a href="#h13-0-36" id="h13-0-36" class="i">+fun AppDatabase.syncGroupInfo(conversationInfo: MessagingGroupInfo) {
</a><a href="#h13-0-37" id="h13-0-37" class="i">+    executeAsync {
</a><a href="#h13-0-38" id="h13-0-38" class="i">+        try {
</a><a href="#h13-0-39" id="h13-0-39" class="i">+            database.execSQL(&quot;INSERT OR REPLACE INTO groups (conversationId, name, participantsCount) VALUES (?, ?, ?)&quot;, arrayOf(
</a><a href="#h13-0-40" id="h13-0-40" class="i">+                conversationInfo.conversationId,
</a><a href="#h13-0-41" id="h13-0-41" class="i">+                conversationInfo.name,
</a><a href="#h13-0-42" id="h13-0-42" class="i">+                conversationInfo.participantsCount
</a><a href="#h13-0-43" id="h13-0-43" class="i">+            ))
</a><a href="#h13-0-44" id="h13-0-44" class="i">+        } catch (e: Exception) {
</a><a href="#h13-0-45" id="h13-0-45" class="i">+            throw e
</a><a href="#h13-0-46" id="h13-0-46" class="i">+        }
</a><a href="#h13-0-47" id="h13-0-47" class="i">+    }
</a><a href="#h13-0-48" id="h13-0-48" class="i">+}
</a><a href="#h13-0-49" id="h13-0-49" class="i">+
</a><a href="#h13-0-50" id="h13-0-50" class="i">+fun AppDatabase.syncFriend(friend: MessagingFriendInfo) {
</a><a href="#h13-0-51" id="h13-0-51" class="i">+    executeAsync {
</a><a href="#h13-0-52" id="h13-0-52" class="i">+        try {
</a><a href="#h13-0-53" id="h13-0-53" class="i">+            database.execSQL(
</a><a href="#h13-0-54" id="h13-0-54" class="i">+                &quot;INSERT OR REPLACE INTO friends (userId, dmConversationId, displayName, mutableUsername, bitmojiId, selfieId) VALUES (?, ?, ?, ?, ?, ?)&quot;,
</a><a href="#h13-0-55" id="h13-0-55" class="i">+                arrayOf(
</a><a href="#h13-0-56" id="h13-0-56" class="i">+                    friend.userId,
</a><a href="#h13-0-57" id="h13-0-57" class="i">+                    friend.dmConversationId,
</a><a href="#h13-0-58" id="h13-0-58" class="i">+                    friend.displayName,
</a><a href="#h13-0-59" id="h13-0-59" class="i">+                    friend.mutableUsername,
</a><a href="#h13-0-60" id="h13-0-60" class="i">+                    friend.bitmojiId,
</a><a href="#h13-0-61" id="h13-0-61" class="i">+                    friend.selfieId
</a><a href="#h13-0-62" id="h13-0-62" class="i">+                )
</a><a href="#h13-0-63" id="h13-0-63" class="i">+            )
</a><a href="#h13-0-64" id="h13-0-64" class="i">+            //sync streaks
</a><a href="#h13-0-65" id="h13-0-65" class="i">+            friend.streaks?.takeIf { it.length &gt; 0 }?.let {
</a><a href="#h13-0-66" id="h13-0-66" class="i">+                val streaks = getFriendStreaks(friend.userId)
</a><a href="#h13-0-67" id="h13-0-67" class="i">+
</a><a href="#h13-0-68" id="h13-0-68" class="i">+                database.execSQL(&quot;INSERT OR REPLACE INTO streaks (id, notify, expirationTimestamp, length) VALUES (?, ?, ?, ?)&quot;, arrayOf(
</a><a href="#h13-0-69" id="h13-0-69" class="i">+                    friend.userId,
</a><a href="#h13-0-70" id="h13-0-70" class="i">+                    streaks?.notify ?: true,
</a><a href="#h13-0-71" id="h13-0-71" class="i">+                    it.expirationTimestamp,
</a><a href="#h13-0-72" id="h13-0-72" class="i">+                    it.length
</a><a href="#h13-0-73" id="h13-0-73" class="i">+                ))
</a><a href="#h13-0-74" id="h13-0-74" class="i">+            } ?: database.execSQL(&quot;DELETE FROM streaks WHERE id = ?&quot;, arrayOf(friend.userId))
</a><a href="#h13-0-75" id="h13-0-75" class="i">+        } catch (e: Exception) {
</a><a href="#h13-0-76" id="h13-0-76" class="i">+            throw e
</a><a href="#h13-0-77" id="h13-0-77" class="i">+        }
</a><a href="#h13-0-78" id="h13-0-78" class="i">+    }
</a><a href="#h13-0-79" id="h13-0-79" class="i">+}
</a><a href="#h13-0-80" id="h13-0-80" class="i">+
</a><a href="#h13-0-81" id="h13-0-81" class="i">+
</a><a href="#h13-0-82" id="h13-0-82" class="i">+
</a><a href="#h13-0-83" id="h13-0-83" class="i">+fun AppDatabase.getRules(targetUuid: String): List&lt;MessagingRuleType&gt; {
</a><a href="#h13-0-84" id="h13-0-84" class="i">+    return database.rawQuery(&quot;SELECT type FROM rules WHERE targetUuid = ?&quot;, arrayOf(
</a><a href="#h13-0-85" id="h13-0-85" class="i">+        targetUuid
</a><a href="#h13-0-86" id="h13-0-86" class="i">+    )).use { cursor -&gt;
</a><a href="#h13-0-87" id="h13-0-87" class="i">+        val rules = mutableListOf&lt;MessagingRuleType&gt;()
</a><a href="#h13-0-88" id="h13-0-88" class="i">+        while (cursor.moveToNext()) {
</a><a href="#h13-0-89" id="h13-0-89" class="i">+            runCatching {
</a><a href="#h13-0-90" id="h13-0-90" class="i">+                rules.add(MessagingRuleType.getByName(cursor.getStringOrNull(&quot;type&quot;)!!) ?: return@runCatching)
</a><a href="#h13-0-91" id="h13-0-91" class="i">+            }.onFailure {
</a><a href="#h13-0-92" id="h13-0-92" class="i">+                context.log.error(&quot;Failed to parse rule&quot;, it)
</a><a href="#h13-0-93" id="h13-0-93" class="i">+            }
</a><a href="#h13-0-94" id="h13-0-94" class="i">+        }
</a><a href="#h13-0-95" id="h13-0-95" class="i">+        rules
</a><a href="#h13-0-96" id="h13-0-96" class="i">+    }
</a><a href="#h13-0-97" id="h13-0-97" class="i">+}
</a><a href="#h13-0-98" id="h13-0-98" class="i">+
</a><a href="#h13-0-99" id="h13-0-99" class="i">+fun AppDatabase.setRule(targetUuid: String, type: String, enabled: Boolean) {
</a><a href="#h13-0-100" id="h13-0-100" class="i">+    executeAsync {
</a><a href="#h13-0-101" id="h13-0-101" class="i">+        if (enabled) {
</a><a href="#h13-0-102" id="h13-0-102" class="i">+            database.execSQL(&quot;INSERT OR REPLACE INTO rules (targetUuid, type) VALUES (?, ?)&quot;, arrayOf(
</a><a href="#h13-0-103" id="h13-0-103" class="i">+                targetUuid,
</a><a href="#h13-0-104" id="h13-0-104" class="i">+                type
</a><a href="#h13-0-105" id="h13-0-105" class="i">+            ))
</a><a href="#h13-0-106" id="h13-0-106" class="i">+        } else {
</a><a href="#h13-0-107" id="h13-0-107" class="i">+            database.execSQL(&quot;DELETE FROM rules WHERE targetUuid = ? AND type = ?&quot;, arrayOf(
</a><a href="#h13-0-108" id="h13-0-108" class="i">+                targetUuid,
</a><a href="#h13-0-109" id="h13-0-109" class="i">+                type
</a><a href="#h13-0-110" id="h13-0-110" class="i">+            ))
</a><a href="#h13-0-111" id="h13-0-111" class="i">+        }
</a><a href="#h13-0-112" id="h13-0-112" class="i">+    }
</a><a href="#h13-0-113" id="h13-0-113" class="i">+}
</a><a href="#h13-0-114" id="h13-0-114" class="i">+
</a><a href="#h13-0-115" id="h13-0-115" class="i">+fun AppDatabase.getFriendInfo(userId: String): MessagingFriendInfo? {
</a><a href="#h13-0-116" id="h13-0-116" class="i">+    return database.rawQuery(&quot;SELECT * FROM friends LEFT OUTER JOIN streaks ON friends.userId = streaks.id WHERE userId = ?&quot;, arrayOf(userId)).use { cursor -&gt;
</a><a href="#h13-0-117" id="h13-0-117" class="i">+        if (!cursor.moveToFirst()) return@use null
</a><a href="#h13-0-118" id="h13-0-118" class="i">+        MessagingFriendInfo.fromCursor(cursor)
</a><a href="#h13-0-119" id="h13-0-119" class="i">+    }
</a><a href="#h13-0-120" id="h13-0-120" class="i">+}
</a><a href="#h13-0-121" id="h13-0-121" class="i">+
</a><a href="#h13-0-122" id="h13-0-122" class="i">+fun AppDatabase.findFriend(conversationId: String): MessagingFriendInfo? {
</a><a href="#h13-0-123" id="h13-0-123" class="i">+    return database.rawQuery(&quot;SELECT * FROM friends WHERE dmConversationId = ?&quot;, arrayOf(conversationId)).use { cursor -&gt;
</a><a href="#h13-0-124" id="h13-0-124" class="i">+        if (!cursor.moveToFirst()) return@use null
</a><a href="#h13-0-125" id="h13-0-125" class="i">+        MessagingFriendInfo.fromCursor(cursor)
</a><a href="#h13-0-126" id="h13-0-126" class="i">+    }
</a><a href="#h13-0-127" id="h13-0-127" class="i">+}
</a><a href="#h13-0-128" id="h13-0-128" class="i">+
</a><a href="#h13-0-129" id="h13-0-129" class="i">+fun AppDatabase.deleteFriend(userId: String) {
</a><a href="#h13-0-130" id="h13-0-130" class="i">+    executeAsync {
</a><a href="#h13-0-131" id="h13-0-131" class="i">+        database.execSQL(&quot;DELETE FROM friends WHERE userId = ?&quot;, arrayOf(userId))
</a><a href="#h13-0-132" id="h13-0-132" class="i">+        database.execSQL(&quot;DELETE FROM streaks WHERE id = ?&quot;, arrayOf(userId))
</a><a href="#h13-0-133" id="h13-0-133" class="i">+        database.execSQL(&quot;DELETE FROM rules WHERE targetUuid = ?&quot;, arrayOf(userId))
</a><a href="#h13-0-134" id="h13-0-134" class="i">+    }
</a><a href="#h13-0-135" id="h13-0-135" class="i">+}
</a><a href="#h13-0-136" id="h13-0-136" class="i">+
</a><a href="#h13-0-137" id="h13-0-137" class="i">+fun AppDatabase.deleteGroup(conversationId: String) {
</a><a href="#h13-0-138" id="h13-0-138" class="i">+    executeAsync {
</a><a href="#h13-0-139" id="h13-0-139" class="i">+        database.execSQL(&quot;DELETE FROM groups WHERE conversationId = ?&quot;, arrayOf(conversationId))
</a><a href="#h13-0-140" id="h13-0-140" class="i">+        database.execSQL(&quot;DELETE FROM rules WHERE targetUuid = ?&quot;, arrayOf(conversationId))
</a><a href="#h13-0-141" id="h13-0-141" class="i">+    }
</a><a href="#h13-0-142" id="h13-0-142" class="i">+}
</a><a href="#h13-0-143" id="h13-0-143" class="i">+
</a><a href="#h13-0-144" id="h13-0-144" class="i">+fun AppDatabase.getGroupInfo(conversationId: String): MessagingGroupInfo? {
</a><a href="#h13-0-145" id="h13-0-145" class="i">+    return database.rawQuery(&quot;SELECT * FROM groups WHERE conversationId = ?&quot;, arrayOf(conversationId)).use { cursor -&gt;
</a><a href="#h13-0-146" id="h13-0-146" class="i">+        if (!cursor.moveToFirst()) return@use null
</a><a href="#h13-0-147" id="h13-0-147" class="i">+        MessagingGroupInfo.fromCursor(cursor)
</a><a href="#h13-0-148" id="h13-0-148" class="i">+    }
</a><a href="#h13-0-149" id="h13-0-149" class="i">+}
</a><a href="#h13-0-150" id="h13-0-150" class="i">+
</a><a href="#h13-0-151" id="h13-0-151" class="i">+fun AppDatabase.getFriendStreaks(userId: String): FriendStreaks? {
</a><a href="#h13-0-152" id="h13-0-152" class="i">+    return database.rawQuery(&quot;SELECT * FROM streaks WHERE id = ?&quot;, arrayOf(userId)).use { cursor -&gt;
</a><a href="#h13-0-153" id="h13-0-153" class="i">+        if (!cursor.moveToFirst()) return@use null
</a><a href="#h13-0-154" id="h13-0-154" class="i">+        FriendStreaks(
</a><a href="#h13-0-155" id="h13-0-155" class="i">+            notify = cursor.getInteger(&quot;notify&quot;) == 1,
</a><a href="#h13-0-156" id="h13-0-156" class="i">+            expirationTimestamp = cursor.getLongOrNull(&quot;expirationTimestamp&quot;) ?: 0L,
</a><a href="#h13-0-157" id="h13-0-157" class="i">+            length = cursor.getInteger(&quot;length&quot;)
</a><a href="#h13-0-158" id="h13-0-158" class="i">+        )
</a><a href="#h13-0-159" id="h13-0-159" class="i">+    }
</a><a href="#h13-0-160" id="h13-0-160" class="i">+}
</a><a href="#h13-0-161" id="h13-0-161" class="i">+
</a><a href="#h13-0-162" id="h13-0-162" class="i">+fun AppDatabase.setFriendStreaksNotify(userId: String, notify: Boolean) {
</a><a href="#h13-0-163" id="h13-0-163" class="i">+    executeAsync {
</a><a href="#h13-0-164" id="h13-0-164" class="i">+        database.execSQL(&quot;UPDATE streaks SET notify = ? WHERE id = ?&quot;, arrayOf(
</a><a href="#h13-0-165" id="h13-0-165" class="i">+            if (notify) 1 else 0,
</a><a href="#h13-0-166" id="h13-0-166" class="i">+            userId
</a><a href="#h13-0-167" id="h13-0-167" class="i">+        ))
</a><a href="#h13-0-168" id="h13-0-168" class="i">+    }
</a><a href="#h13-0-169" id="h13-0-169" class="i">+}
</a><a href="#h13-0-170" id="h13-0-170" class="i">+
</a><a href="#h13-0-171" id="h13-0-171" class="i">+fun AppDatabase.getRuleIds(type: String): MutableList&lt;String&gt; {
</a><a href="#h13-0-172" id="h13-0-172" class="i">+    return database.rawQuery(&quot;SELECT targetUuid FROM rules WHERE type = ?&quot;, arrayOf(type)).use { cursor -&gt;
</a><a href="#h13-0-173" id="h13-0-173" class="i">+        val ruleIds = mutableListOf&lt;String&gt;()
</a><a href="#h13-0-174" id="h13-0-174" class="i">+        while (cursor.moveToNext()) {
</a><a href="#h13-0-175" id="h13-0-175" class="i">+            ruleIds.add(cursor.getStringOrNull(&quot;targetUuid&quot;)!!)
</a><a href="#h13-0-176" id="h13-0-176" class="i">+        }
</a><a href="#h13-0-177" id="h13-0-177" class="i">+        ruleIds
</a><a href="#h13-0-178" id="h13-0-178" class="i">+    }
</a><a href="#h13-0-179" id="h13-0-179" class="i">+}
</a><a href="#h13-0-180" id="h13-0-180" class="i">+
</a><b>diff --git a/<a id="h14" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/storage/QuickTiles.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/storage/QuickTiles.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/storage/QuickTiles.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/storage/QuickTiles.kt</a></b>
<a href="#h14-0" id="h14-0" class="h">@@ -0,0 +1,26 @@
</a><a href="#h14-0-0" id="h14-0-0" class="i">+package me.rhunk.snapenhance.storage
</a><a href="#h14-0-1" id="h14-0-1" class="i">+
</a><a href="#h14-0-2" id="h14-0-2" class="i">+import me.rhunk.snapenhance.common.util.ktx.getStringOrNull
</a><a href="#h14-0-3" id="h14-0-3" class="i">+
</a><a href="#h14-0-4" id="h14-0-4" class="i">+
</a><a href="#h14-0-5" id="h14-0-5" class="i">+fun AppDatabase.getQuickTiles(): List&lt;String&gt; {
</a><a href="#h14-0-6" id="h14-0-6" class="i">+    return database.rawQuery(&quot;SELECT `key` FROM quick_tiles ORDER BY position ASC&quot;, null).use { cursor -&gt;
</a><a href="#h14-0-7" id="h14-0-7" class="i">+        val keys = mutableListOf&lt;String&gt;()
</a><a href="#h14-0-8" id="h14-0-8" class="i">+        while (cursor.moveToNext()) {
</a><a href="#h14-0-9" id="h14-0-9" class="i">+            keys.add(cursor.getStringOrNull(&quot;key&quot;) ?: continue)
</a><a href="#h14-0-10" id="h14-0-10" class="i">+        }
</a><a href="#h14-0-11" id="h14-0-11" class="i">+        keys
</a><a href="#h14-0-12" id="h14-0-12" class="i">+    }
</a><a href="#h14-0-13" id="h14-0-13" class="i">+}
</a><a href="#h14-0-14" id="h14-0-14" class="i">+
</a><a href="#h14-0-15" id="h14-0-15" class="i">+fun AppDatabase.setQuickTiles(keys: List&lt;String&gt;) {
</a><a href="#h14-0-16" id="h14-0-16" class="i">+    executeAsync {
</a><a href="#h14-0-17" id="h14-0-17" class="i">+        database.execSQL(&quot;DELETE FROM quick_tiles&quot;)
</a><a href="#h14-0-18" id="h14-0-18" class="i">+        keys.forEachIndexed { index, key -&gt;
</a><a href="#h14-0-19" id="h14-0-19" class="i">+            database.execSQL(&quot;INSERT INTO quick_tiles (`key`, position) VALUES (?, ?)&quot;, arrayOf(
</a><a href="#h14-0-20" id="h14-0-20" class="i">+                key,
</a><a href="#h14-0-21" id="h14-0-21" class="i">+                index
</a><a href="#h14-0-22" id="h14-0-22" class="i">+            ))
</a><a href="#h14-0-23" id="h14-0-23" class="i">+        }
</a><a href="#h14-0-24" id="h14-0-24" class="i">+    }
</a><a href="#h14-0-25" id="h14-0-25" class="i">+}</a><a href="#h14-0-26" id="h14-0-26" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h15" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/storage/Scripting.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/storage/Scripting.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/storage/Scripting.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/storage/Scripting.kt</a></b>
<a href="#h15-0" id="h15-0" class="h">@@ -0,0 +1,73 @@
</a><a href="#h15-0-0" id="h15-0-0" class="i">+package me.rhunk.snapenhance.storage
</a><a href="#h15-0-1" id="h15-0-1" class="i">+
</a><a href="#h15-0-2" id="h15-0-2" class="i">+import kotlinx.coroutines.asCoroutineDispatcher
</a><a href="#h15-0-3" id="h15-0-3" class="i">+import kotlinx.coroutines.runBlocking
</a><a href="#h15-0-4" id="h15-0-4" class="i">+import me.rhunk.snapenhance.common.scripting.type.ModuleInfo
</a><a href="#h15-0-5" id="h15-0-5" class="i">+import me.rhunk.snapenhance.common.util.ktx.getInteger
</a><a href="#h15-0-6" id="h15-0-6" class="i">+import me.rhunk.snapenhance.common.util.ktx.getStringOrNull
</a><a href="#h15-0-7" id="h15-0-7" class="i">+
</a><a href="#h15-0-8" id="h15-0-8" class="i">+
</a><a href="#h15-0-9" id="h15-0-9" class="i">+fun AppDatabase.getScripts(): List&lt;ModuleInfo&gt; {
</a><a href="#h15-0-10" id="h15-0-10" class="i">+    return database.rawQuery(&quot;SELECT * FROM scripts ORDER BY id DESC&quot;, null).use { cursor -&gt;
</a><a href="#h15-0-11" id="h15-0-11" class="i">+        val scripts = mutableListOf&lt;ModuleInfo&gt;()
</a><a href="#h15-0-12" id="h15-0-12" class="i">+        while (cursor.moveToNext()) {
</a><a href="#h15-0-13" id="h15-0-13" class="i">+            scripts.add(
</a><a href="#h15-0-14" id="h15-0-14" class="i">+                ModuleInfo(
</a><a href="#h15-0-15" id="h15-0-15" class="i">+                    name = cursor.getStringOrNull(&quot;name&quot;)!!,
</a><a href="#h15-0-16" id="h15-0-16" class="i">+                    version = cursor.getStringOrNull(&quot;version&quot;)!!,
</a><a href="#h15-0-17" id="h15-0-17" class="i">+                    displayName = cursor.getStringOrNull(&quot;displayName&quot;),
</a><a href="#h15-0-18" id="h15-0-18" class="i">+                    description = cursor.getStringOrNull(&quot;description&quot;),
</a><a href="#h15-0-19" id="h15-0-19" class="i">+                    author = cursor.getStringOrNull(&quot;author&quot;),
</a><a href="#h15-0-20" id="h15-0-20" class="i">+                    grantedPermissions = emptyList()
</a><a href="#h15-0-21" id="h15-0-21" class="i">+                )
</a><a href="#h15-0-22" id="h15-0-22" class="i">+            )
</a><a href="#h15-0-23" id="h15-0-23" class="i">+        }
</a><a href="#h15-0-24" id="h15-0-24" class="i">+        scripts
</a><a href="#h15-0-25" id="h15-0-25" class="i">+    }
</a><a href="#h15-0-26" id="h15-0-26" class="i">+}
</a><a href="#h15-0-27" id="h15-0-27" class="i">+
</a><a href="#h15-0-28" id="h15-0-28" class="i">+fun AppDatabase.setScriptEnabled(name: String, enabled: Boolean) {
</a><a href="#h15-0-29" id="h15-0-29" class="i">+    executeAsync {
</a><a href="#h15-0-30" id="h15-0-30" class="i">+        database.execSQL(&quot;UPDATE scripts SET enabled = ? WHERE name = ?&quot;, arrayOf(
</a><a href="#h15-0-31" id="h15-0-31" class="i">+            if (enabled) 1 else 0,
</a><a href="#h15-0-32" id="h15-0-32" class="i">+            name
</a><a href="#h15-0-33" id="h15-0-33" class="i">+        ))
</a><a href="#h15-0-34" id="h15-0-34" class="i">+    }
</a><a href="#h15-0-35" id="h15-0-35" class="i">+}
</a><a href="#h15-0-36" id="h15-0-36" class="i">+
</a><a href="#h15-0-37" id="h15-0-37" class="i">+fun AppDatabase.isScriptEnabled(name: String): Boolean {
</a><a href="#h15-0-38" id="h15-0-38" class="i">+    return database.rawQuery(&quot;SELECT enabled FROM scripts WHERE name = ?&quot;, arrayOf(name)).use { cursor -&gt;
</a><a href="#h15-0-39" id="h15-0-39" class="i">+        if (!cursor.moveToFirst()) return@use false
</a><a href="#h15-0-40" id="h15-0-40" class="i">+        cursor.getInteger(&quot;enabled&quot;) == 1
</a><a href="#h15-0-41" id="h15-0-41" class="i">+    }
</a><a href="#h15-0-42" id="h15-0-42" class="i">+}
</a><a href="#h15-0-43" id="h15-0-43" class="i">+
</a><a href="#h15-0-44" id="h15-0-44" class="i">+fun AppDatabase.syncScripts(availableScripts: List&lt;ModuleInfo&gt;) {
</a><a href="#h15-0-45" id="h15-0-45" class="i">+    runBlocking(executor.asCoroutineDispatcher()) {
</a><a href="#h15-0-46" id="h15-0-46" class="i">+        val enabledScripts = getScripts()
</a><a href="#h15-0-47" id="h15-0-47" class="i">+        val enabledScriptPaths = enabledScripts.map { it.name }
</a><a href="#h15-0-48" id="h15-0-48" class="i">+        val availableScriptPaths = availableScripts.map { it.name }
</a><a href="#h15-0-49" id="h15-0-49" class="i">+
</a><a href="#h15-0-50" id="h15-0-50" class="i">+        enabledScripts.forEach { script -&gt;
</a><a href="#h15-0-51" id="h15-0-51" class="i">+            if (!availableScriptPaths.contains(script.name)) {
</a><a href="#h15-0-52" id="h15-0-52" class="i">+                database.execSQL(&quot;DELETE FROM scripts WHERE name = ?&quot;, arrayOf(script.name))
</a><a href="#h15-0-53" id="h15-0-53" class="i">+            }
</a><a href="#h15-0-54" id="h15-0-54" class="i">+        }
</a><a href="#h15-0-55" id="h15-0-55" class="i">+
</a><a href="#h15-0-56" id="h15-0-56" class="i">+        availableScripts.forEach { script -&gt;
</a><a href="#h15-0-57" id="h15-0-57" class="i">+            if (!enabledScriptPaths.contains(script.name) || script != enabledScripts.find { it.name == script.name }) {
</a><a href="#h15-0-58" id="h15-0-58" class="i">+                database.execSQL(
</a><a href="#h15-0-59" id="h15-0-59" class="i">+                    &quot;INSERT OR REPLACE INTO scripts (name, version, displayName, description, author, enabled) VALUES (?, ?, ?, ?, ?, ?)&quot;,
</a><a href="#h15-0-60" id="h15-0-60" class="i">+                    arrayOf(
</a><a href="#h15-0-61" id="h15-0-61" class="i">+                        script.name,
</a><a href="#h15-0-62" id="h15-0-62" class="i">+                        script.version,
</a><a href="#h15-0-63" id="h15-0-63" class="i">+                        script.displayName,
</a><a href="#h15-0-64" id="h15-0-64" class="i">+                        script.description,
</a><a href="#h15-0-65" id="h15-0-65" class="i">+                        script.author,
</a><a href="#h15-0-66" id="h15-0-66" class="i">+                        0
</a><a href="#h15-0-67" id="h15-0-67" class="i">+                    )
</a><a href="#h15-0-68" id="h15-0-68" class="i">+                )
</a><a href="#h15-0-69" id="h15-0-69" class="i">+            }
</a><a href="#h15-0-70" id="h15-0-70" class="i">+        }
</a><a href="#h15-0-71" id="h15-0-71" class="i">+    }
</a><a href="#h15-0-72" id="h15-0-72" class="i">+}</a><a href="#h15-0-73" id="h15-0-73" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h16" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/storage/Tracker.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/storage/Tracker.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/storage/Tracker.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/storage/Tracker.kt</a></b>
<a href="#h16-0" id="h16-0" class="h">@@ -0,0 +1,197 @@
</a><a href="#h16-0-0" id="h16-0-0" class="i">+package me.rhunk.snapenhance.storage
</a><a href="#h16-0-1" id="h16-0-1" class="i">+
</a><a href="#h16-0-2" id="h16-0-2" class="i">+import android.content.ContentValues
</a><a href="#h16-0-3" id="h16-0-3" class="i">+import com.google.gson.JsonArray
</a><a href="#h16-0-4" id="h16-0-4" class="i">+import kotlinx.coroutines.runBlocking
</a><a href="#h16-0-5" id="h16-0-5" class="i">+import me.rhunk.snapenhance.common.data.TrackerRule
</a><a href="#h16-0-6" id="h16-0-6" class="i">+import me.rhunk.snapenhance.common.data.TrackerRuleAction
</a><a href="#h16-0-7" id="h16-0-7" class="i">+import me.rhunk.snapenhance.common.data.TrackerRuleActionParams
</a><a href="#h16-0-8" id="h16-0-8" class="i">+import me.rhunk.snapenhance.common.data.TrackerRuleEvent
</a><a href="#h16-0-9" id="h16-0-9" class="i">+import me.rhunk.snapenhance.common.data.TrackerScopeType
</a><a href="#h16-0-10" id="h16-0-10" class="i">+import me.rhunk.snapenhance.common.util.ktx.getInteger
</a><a href="#h16-0-11" id="h16-0-11" class="i">+import me.rhunk.snapenhance.common.util.ktx.getStringOrNull
</a><a href="#h16-0-12" id="h16-0-12" class="i">+import kotlin.coroutines.suspendCoroutine
</a><a href="#h16-0-13" id="h16-0-13" class="i">+
</a><a href="#h16-0-14" id="h16-0-14" class="i">+
</a><a href="#h16-0-15" id="h16-0-15" class="i">+fun AppDatabase.clearTrackerRules() {
</a><a href="#h16-0-16" id="h16-0-16" class="i">+    runBlocking {
</a><a href="#h16-0-17" id="h16-0-17" class="i">+        suspendCoroutine { continuation -&gt;
</a><a href="#h16-0-18" id="h16-0-18" class="i">+            executeAsync {
</a><a href="#h16-0-19" id="h16-0-19" class="i">+                database.execSQL(&quot;DELETE FROM tracker_rules&quot;)
</a><a href="#h16-0-20" id="h16-0-20" class="i">+                database.execSQL(&quot;DELETE FROM tracker_rules_events&quot;)
</a><a href="#h16-0-21" id="h16-0-21" class="i">+                continuation.resumeWith(Result.success(Unit))
</a><a href="#h16-0-22" id="h16-0-22" class="i">+            }
</a><a href="#h16-0-23" id="h16-0-23" class="i">+        }
</a><a href="#h16-0-24" id="h16-0-24" class="i">+    }
</a><a href="#h16-0-25" id="h16-0-25" class="i">+}
</a><a href="#h16-0-26" id="h16-0-26" class="i">+
</a><a href="#h16-0-27" id="h16-0-27" class="i">+fun AppDatabase.deleteTrackerRule(ruleId: Int) {
</a><a href="#h16-0-28" id="h16-0-28" class="i">+    executeAsync {
</a><a href="#h16-0-29" id="h16-0-29" class="i">+        database.execSQL(&quot;DELETE FROM tracker_rules WHERE id = ?&quot;, arrayOf(ruleId))
</a><a href="#h16-0-30" id="h16-0-30" class="i">+        database.execSQL(&quot;DELETE FROM tracker_rules_events WHERE rule_id = ?&quot;, arrayOf(ruleId))
</a><a href="#h16-0-31" id="h16-0-31" class="i">+    }
</a><a href="#h16-0-32" id="h16-0-32" class="i">+}
</a><a href="#h16-0-33" id="h16-0-33" class="i">+
</a><a href="#h16-0-34" id="h16-0-34" class="i">+fun AppDatabase.newTrackerRule(name: String = &quot;Custom Rule&quot;): Int {
</a><a href="#h16-0-35" id="h16-0-35" class="i">+    return runBlocking {
</a><a href="#h16-0-36" id="h16-0-36" class="i">+        suspendCoroutine { continuation -&gt;
</a><a href="#h16-0-37" id="h16-0-37" class="i">+            executeAsync {
</a><a href="#h16-0-38" id="h16-0-38" class="i">+                val id = database.insert(&quot;tracker_rules&quot;, null, ContentValues().apply {
</a><a href="#h16-0-39" id="h16-0-39" class="i">+                    put(&quot;name&quot;, name)
</a><a href="#h16-0-40" id="h16-0-40" class="i">+                })
</a><a href="#h16-0-41" id="h16-0-41" class="i">+                continuation.resumeWith(Result.success(id.toInt()))
</a><a href="#h16-0-42" id="h16-0-42" class="i">+            }
</a><a href="#h16-0-43" id="h16-0-43" class="i">+        }
</a><a href="#h16-0-44" id="h16-0-44" class="i">+    }
</a><a href="#h16-0-45" id="h16-0-45" class="i">+}
</a><a href="#h16-0-46" id="h16-0-46" class="i">+
</a><a href="#h16-0-47" id="h16-0-47" class="i">+fun AppDatabase.addOrUpdateTrackerRuleEvent(
</a><a href="#h16-0-48" id="h16-0-48" class="i">+    ruleEventId: Int? = null,
</a><a href="#h16-0-49" id="h16-0-49" class="i">+    ruleId: Int? = null,
</a><a href="#h16-0-50" id="h16-0-50" class="i">+    eventType: String? = null,
</a><a href="#h16-0-51" id="h16-0-51" class="i">+    params: TrackerRuleActionParams,
</a><a href="#h16-0-52" id="h16-0-52" class="i">+    actions: List&lt;TrackerRuleAction&gt;
</a><a href="#h16-0-53" id="h16-0-53" class="i">+): Int? {
</a><a href="#h16-0-54" id="h16-0-54" class="i">+    return runBlocking {
</a><a href="#h16-0-55" id="h16-0-55" class="i">+        suspendCoroutine { continuation -&gt;
</a><a href="#h16-0-56" id="h16-0-56" class="i">+            executeAsync {
</a><a href="#h16-0-57" id="h16-0-57" class="i">+                val id = if (ruleEventId != null) {
</a><a href="#h16-0-58" id="h16-0-58" class="i">+                    database.execSQL(&quot;UPDATE tracker_rules_events SET params = ?, actions = ? WHERE id = ?&quot;, arrayOf(
</a><a href="#h16-0-59" id="h16-0-59" class="i">+                        context.gson.toJson(params),
</a><a href="#h16-0-60" id="h16-0-60" class="i">+                        context.gson.toJson(actions.map { it.key }),
</a><a href="#h16-0-61" id="h16-0-61" class="i">+                        ruleEventId
</a><a href="#h16-0-62" id="h16-0-62" class="i">+                    ))
</a><a href="#h16-0-63" id="h16-0-63" class="i">+                    ruleEventId
</a><a href="#h16-0-64" id="h16-0-64" class="i">+                } else {
</a><a href="#h16-0-65" id="h16-0-65" class="i">+                    database.insert(&quot;tracker_rules_events&quot;, null, ContentValues().apply {
</a><a href="#h16-0-66" id="h16-0-66" class="i">+                        put(&quot;rule_id&quot;, ruleId)
</a><a href="#h16-0-67" id="h16-0-67" class="i">+                        put(&quot;event_type&quot;, eventType)
</a><a href="#h16-0-68" id="h16-0-68" class="i">+                        put(&quot;params&quot;, context.gson.toJson(params))
</a><a href="#h16-0-69" id="h16-0-69" class="i">+                        put(&quot;actions&quot;, context.gson.toJson(actions.map { it.key }))
</a><a href="#h16-0-70" id="h16-0-70" class="i">+                    }).toInt()
</a><a href="#h16-0-71" id="h16-0-71" class="i">+                }
</a><a href="#h16-0-72" id="h16-0-72" class="i">+                continuation.resumeWith(Result.success(id))
</a><a href="#h16-0-73" id="h16-0-73" class="i">+            }
</a><a href="#h16-0-74" id="h16-0-74" class="i">+        }
</a><a href="#h16-0-75" id="h16-0-75" class="i">+    }
</a><a href="#h16-0-76" id="h16-0-76" class="i">+}
</a><a href="#h16-0-77" id="h16-0-77" class="i">+
</a><a href="#h16-0-78" id="h16-0-78" class="i">+fun AppDatabase.deleteTrackerRuleEvent(eventId: Int) {
</a><a href="#h16-0-79" id="h16-0-79" class="i">+    executeAsync {
</a><a href="#h16-0-80" id="h16-0-80" class="i">+        database.execSQL(&quot;DELETE FROM tracker_rules_events WHERE id = ?&quot;, arrayOf(eventId))
</a><a href="#h16-0-81" id="h16-0-81" class="i">+    }
</a><a href="#h16-0-82" id="h16-0-82" class="i">+}
</a><a href="#h16-0-83" id="h16-0-83" class="i">+
</a><a href="#h16-0-84" id="h16-0-84" class="i">+fun AppDatabase.getTrackerRulesDesc(): List&lt;TrackerRule&gt; {
</a><a href="#h16-0-85" id="h16-0-85" class="i">+    val rules = mutableListOf&lt;TrackerRule&gt;()
</a><a href="#h16-0-86" id="h16-0-86" class="i">+
</a><a href="#h16-0-87" id="h16-0-87" class="i">+    database.rawQuery(&quot;SELECT * FROM tracker_rules ORDER BY id DESC&quot;, null).use { cursor -&gt;
</a><a href="#h16-0-88" id="h16-0-88" class="i">+        while (cursor.moveToNext()) {
</a><a href="#h16-0-89" id="h16-0-89" class="i">+            rules.add(
</a><a href="#h16-0-90" id="h16-0-90" class="i">+                TrackerRule(
</a><a href="#h16-0-91" id="h16-0-91" class="i">+                    id = cursor.getInteger(&quot;id&quot;),
</a><a href="#h16-0-92" id="h16-0-92" class="i">+                    enabled = cursor.getInteger(&quot;enabled&quot;) == 1,
</a><a href="#h16-0-93" id="h16-0-93" class="i">+                    name = cursor.getStringOrNull(&quot;name&quot;) ?: &quot;&quot;,
</a><a href="#h16-0-94" id="h16-0-94" class="i">+                )
</a><a href="#h16-0-95" id="h16-0-95" class="i">+            )
</a><a href="#h16-0-96" id="h16-0-96" class="i">+        }
</a><a href="#h16-0-97" id="h16-0-97" class="i">+    }
</a><a href="#h16-0-98" id="h16-0-98" class="i">+
</a><a href="#h16-0-99" id="h16-0-99" class="i">+    return rules
</a><a href="#h16-0-100" id="h16-0-100" class="i">+}
</a><a href="#h16-0-101" id="h16-0-101" class="i">+
</a><a href="#h16-0-102" id="h16-0-102" class="i">+fun AppDatabase.getTrackerRule(ruleId: Int): TrackerRule? {
</a><a href="#h16-0-103" id="h16-0-103" class="i">+    return database.rawQuery(&quot;SELECT * FROM tracker_rules WHERE id = ?&quot;, arrayOf(ruleId.toString())).use { cursor -&gt;
</a><a href="#h16-0-104" id="h16-0-104" class="i">+        if (!cursor.moveToFirst()) return@use null
</a><a href="#h16-0-105" id="h16-0-105" class="i">+        TrackerRule(
</a><a href="#h16-0-106" id="h16-0-106" class="i">+            id = cursor.getInteger(&quot;id&quot;),
</a><a href="#h16-0-107" id="h16-0-107" class="i">+            enabled = cursor.getInteger(&quot;enabled&quot;) == 1,
</a><a href="#h16-0-108" id="h16-0-108" class="i">+            name = cursor.getStringOrNull(&quot;name&quot;) ?: &quot;&quot;,
</a><a href="#h16-0-109" id="h16-0-109" class="i">+        )
</a><a href="#h16-0-110" id="h16-0-110" class="i">+    }
</a><a href="#h16-0-111" id="h16-0-111" class="i">+}
</a><a href="#h16-0-112" id="h16-0-112" class="i">+
</a><a href="#h16-0-113" id="h16-0-113" class="i">+fun AppDatabase.setTrackerRuleName(ruleId: Int, name: String) {
</a><a href="#h16-0-114" id="h16-0-114" class="i">+    executeAsync {
</a><a href="#h16-0-115" id="h16-0-115" class="i">+        database.execSQL(&quot;UPDATE tracker_rules SET name = ? WHERE id = ?&quot;, arrayOf(name, ruleId))
</a><a href="#h16-0-116" id="h16-0-116" class="i">+    }
</a><a href="#h16-0-117" id="h16-0-117" class="i">+}
</a><a href="#h16-0-118" id="h16-0-118" class="i">+
</a><a href="#h16-0-119" id="h16-0-119" class="i">+fun AppDatabase.setTrackerRuleState(ruleId: Int, enabled: Boolean) {
</a><a href="#h16-0-120" id="h16-0-120" class="i">+    executeAsync {
</a><a href="#h16-0-121" id="h16-0-121" class="i">+        database.execSQL(&quot;UPDATE tracker_rules SET enabled = ? WHERE id = ?&quot;, arrayOf(if (enabled) 1 else 0, ruleId))
</a><a href="#h16-0-122" id="h16-0-122" class="i">+    }
</a><a href="#h16-0-123" id="h16-0-123" class="i">+}
</a><a href="#h16-0-124" id="h16-0-124" class="i">+
</a><a href="#h16-0-125" id="h16-0-125" class="i">+fun AppDatabase.getTrackerEvents(ruleId: Int): List&lt;TrackerRuleEvent&gt; {
</a><a href="#h16-0-126" id="h16-0-126" class="i">+    val events = mutableListOf&lt;TrackerRuleEvent&gt;()
</a><a href="#h16-0-127" id="h16-0-127" class="i">+    database.rawQuery(&quot;SELECT * FROM tracker_rules_events WHERE rule_id = ?&quot;, arrayOf(ruleId.toString())).use { cursor -&gt;
</a><a href="#h16-0-128" id="h16-0-128" class="i">+        while (cursor.moveToNext()) {
</a><a href="#h16-0-129" id="h16-0-129" class="i">+            events.add(
</a><a href="#h16-0-130" id="h16-0-130" class="i">+                TrackerRuleEvent(
</a><a href="#h16-0-131" id="h16-0-131" class="i">+                    id = cursor.getInteger(&quot;id&quot;),
</a><a href="#h16-0-132" id="h16-0-132" class="i">+                    eventType = cursor.getStringOrNull(&quot;event_type&quot;) ?: continue,
</a><a href="#h16-0-133" id="h16-0-133" class="i">+                    enabled = cursor.getInteger(&quot;flags&quot;) == 1,
</a><a href="#h16-0-134" id="h16-0-134" class="i">+                    params = context.gson.fromJson(cursor.getStringOrNull(&quot;params&quot;) ?: &quot;{}&quot;, TrackerRuleActionParams::class.java),
</a><a href="#h16-0-135" id="h16-0-135" class="i">+                    actions = context.gson.fromJson(cursor.getStringOrNull(&quot;actions&quot;) ?: &quot;[]&quot;, JsonArray::class.java).mapNotNull {
</a><a href="#h16-0-136" id="h16-0-136" class="i">+                        TrackerRuleAction.fromString(it.asString)
</a><a href="#h16-0-137" id="h16-0-137" class="i">+                    }
</a><a href="#h16-0-138" id="h16-0-138" class="i">+                )
</a><a href="#h16-0-139" id="h16-0-139" class="i">+            )
</a><a href="#h16-0-140" id="h16-0-140" class="i">+        }
</a><a href="#h16-0-141" id="h16-0-141" class="i">+    }
</a><a href="#h16-0-142" id="h16-0-142" class="i">+    return events
</a><a href="#h16-0-143" id="h16-0-143" class="i">+}
</a><a href="#h16-0-144" id="h16-0-144" class="i">+
</a><a href="#h16-0-145" id="h16-0-145" class="i">+fun AppDatabase.getTrackerEvents(eventType: String): Map&lt;TrackerRuleEvent, TrackerRule&gt; {
</a><a href="#h16-0-146" id="h16-0-146" class="i">+    val events = mutableMapOf&lt;TrackerRuleEvent, TrackerRule&gt;()
</a><a href="#h16-0-147" id="h16-0-147" class="i">+    database.rawQuery(&quot;SELECT tracker_rules_events.id as event_id, tracker_rules_events.params as event_params,&quot; +
</a><a href="#h16-0-148" id="h16-0-148" class="i">+            &quot;tracker_rules_events.actions, tracker_rules_events.flags, tracker_rules_events.event_type, tracker_rules.name, tracker_rules.id as rule_id &quot; +
</a><a href="#h16-0-149" id="h16-0-149" class="i">+            &quot;FROM tracker_rules_events &quot; +
</a><a href="#h16-0-150" id="h16-0-150" class="i">+            &quot;INNER JOIN tracker_rules &quot; +
</a><a href="#h16-0-151" id="h16-0-151" class="i">+            &quot;ON tracker_rules_events.rule_id = tracker_rules.id &quot; +
</a><a href="#h16-0-152" id="h16-0-152" class="i">+            &quot;WHERE event_type = ? AND tracker_rules.enabled = 1&quot;, arrayOf(eventType)
</a><a href="#h16-0-153" id="h16-0-153" class="i">+    ).use { cursor -&gt;
</a><a href="#h16-0-154" id="h16-0-154" class="i">+        while (cursor.moveToNext()) {
</a><a href="#h16-0-155" id="h16-0-155" class="i">+            val trackerRule = TrackerRule(
</a><a href="#h16-0-156" id="h16-0-156" class="i">+                id = cursor.getInteger(&quot;rule_id&quot;),
</a><a href="#h16-0-157" id="h16-0-157" class="i">+                enabled = true,
</a><a href="#h16-0-158" id="h16-0-158" class="i">+                name = cursor.getStringOrNull(&quot;name&quot;) ?: &quot;&quot;,
</a><a href="#h16-0-159" id="h16-0-159" class="i">+            )
</a><a href="#h16-0-160" id="h16-0-160" class="i">+            val trackerRuleEvent = TrackerRuleEvent(
</a><a href="#h16-0-161" id="h16-0-161" class="i">+                id = cursor.getInteger(&quot;event_id&quot;),
</a><a href="#h16-0-162" id="h16-0-162" class="i">+                eventType = cursor.getStringOrNull(&quot;event_type&quot;) ?: continue,
</a><a href="#h16-0-163" id="h16-0-163" class="i">+                enabled = cursor.getInteger(&quot;flags&quot;) == 1,
</a><a href="#h16-0-164" id="h16-0-164" class="i">+                params = context.gson.fromJson(cursor.getStringOrNull(&quot;event_params&quot;) ?: &quot;{}&quot;, TrackerRuleActionParams::class.java),
</a><a href="#h16-0-165" id="h16-0-165" class="i">+                actions = context.gson.fromJson(cursor.getStringOrNull(&quot;actions&quot;) ?: &quot;[]&quot;, JsonArray::class.java).mapNotNull {
</a><a href="#h16-0-166" id="h16-0-166" class="i">+                    TrackerRuleAction.fromString(it.asString)
</a><a href="#h16-0-167" id="h16-0-167" class="i">+                }
</a><a href="#h16-0-168" id="h16-0-168" class="i">+            )
</a><a href="#h16-0-169" id="h16-0-169" class="i">+            events[trackerRuleEvent] = trackerRule
</a><a href="#h16-0-170" id="h16-0-170" class="i">+        }
</a><a href="#h16-0-171" id="h16-0-171" class="i">+    }
</a><a href="#h16-0-172" id="h16-0-172" class="i">+    return events
</a><a href="#h16-0-173" id="h16-0-173" class="i">+}
</a><a href="#h16-0-174" id="h16-0-174" class="i">+
</a><a href="#h16-0-175" id="h16-0-175" class="i">+fun AppDatabase.setRuleTrackerScopes(ruleId: Int, type: TrackerScopeType, scopes: List&lt;String&gt;) {
</a><a href="#h16-0-176" id="h16-0-176" class="i">+    executeAsync {
</a><a href="#h16-0-177" id="h16-0-177" class="i">+        database.execSQL(&quot;DELETE FROM tracker_scopes WHERE rule_id = ?&quot;, arrayOf(ruleId))
</a><a href="#h16-0-178" id="h16-0-178" class="i">+        scopes.forEach { scopeId -&gt;
</a><a href="#h16-0-179" id="h16-0-179" class="i">+            database.execSQL(&quot;INSERT INTO tracker_scopes (rule_id, scope_type, scope_id) VALUES (?, ?, ?)&quot;, arrayOf(
</a><a href="#h16-0-180" id="h16-0-180" class="i">+                ruleId,
</a><a href="#h16-0-181" id="h16-0-181" class="i">+                type.key,
</a><a href="#h16-0-182" id="h16-0-182" class="i">+                scopeId
</a><a href="#h16-0-183" id="h16-0-183" class="i">+            ))
</a><a href="#h16-0-184" id="h16-0-184" class="i">+        }
</a><a href="#h16-0-185" id="h16-0-185" class="i">+    }
</a><a href="#h16-0-186" id="h16-0-186" class="i">+}
</a><a href="#h16-0-187" id="h16-0-187" class="i">+
</a><a href="#h16-0-188" id="h16-0-188" class="i">+fun AppDatabase.getRuleTrackerScopes(ruleId: Int, limit: Int = Int.MAX_VALUE): Map&lt;String, TrackerScopeType&gt; {
</a><a href="#h16-0-189" id="h16-0-189" class="i">+    val scopes = mutableMapOf&lt;String, TrackerScopeType&gt;()
</a><a href="#h16-0-190" id="h16-0-190" class="i">+    database.rawQuery(&quot;SELECT * FROM tracker_scopes WHERE rule_id = ? LIMIT ?&quot;, arrayOf(ruleId.toString(), limit.toString())).use { cursor -&gt;
</a><a href="#h16-0-191" id="h16-0-191" class="i">+        while (cursor.moveToNext()) {
</a><a href="#h16-0-192" id="h16-0-192" class="i">+            scopes[cursor.getStringOrNull(&quot;scope_id&quot;) ?: continue] = TrackerScopeType.entries.find { it.key == cursor.getStringOrNull(&quot;scope_type&quot;) } ?: continue
</a><a href="#h16-0-193" id="h16-0-193" class="i">+        }
</a><a href="#h16-0-194" id="h16-0-194" class="i">+    }
</a><a href="#h16-0-195" id="h16-0-195" class="i">+    return scopes
</a><a href="#h16-0-196" id="h16-0-196" class="i">+}
</a><b>diff --git a/<a id="h17" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/Navigation.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/Navigation.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/Navigation.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/Navigation.kt</a></b>
<a href="#h17-0" id="h17-0" class="h">@@ -78,7 +78,7 @@ class Navigation(
</a>             val currentRoute = routes.getCurrentRoute(navBackStackEntry)
             primaryRoutes.forEach { route -&gt;
                 NavigationBarItem(
<a href="#h17-0-3" id="h17-0-3" class="d">-                    alwaysShowLabel = false,
</a><a href="#h17-0-4" id="h17-0-4" class="i">+                    alwaysShowLabel = true,
</a>                     icon = {
                         Icon(imageVector = route.routeInfo.icon, contentDescription = null)
                     },
<a href="#h17-1" id="h17-1" class="h">@@ -88,7 +88,7 @@ class Navigation(
</a>                             softWrap = false,
                             fontSize = 12.sp,
                             modifier = Modifier.wrapContentWidth(unbounded = true),
<a href="#h17-1-3" id="h17-1-3" class="d">-                            text = if (currentRoute == route) context.translation[&quot;manager.routes.${route.routeInfo.key.substringBefore(&quot;/&quot;)}&quot;] else &quot;&quot;,
</a><a href="#h17-1-4" id="h17-1-4" class="i">+                            text = remember(context.translation.loadedLocale) { context.translation[&quot;manager.routes.${route.routeInfo.key.substringBefore(&quot;/&quot;)}&quot;] },
</a>                         )
                     },
                     selected = currentRoute == route,
<b>diff --git a/<a id="h18" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/Routes.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/Routes.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/Routes.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/Routes.kt</a></b>
<a href="#h18-0" id="h18-0" class="h">@@ -15,7 +15,6 @@ import androidx.navigation.NavDestination.Companion.hierarchy
</a> import androidx.navigation.NavGraph.Companion.findStartDestination
 import androidx.navigation.NavGraphBuilder
 import me.rhunk.snapenhance.RemoteSideContext
<a href="#h18-0-3" id="h18-0-3" class="d">-import me.rhunk.snapenhance.ui.manager.pages.FriendTrackerManagerRoot
</a> import me.rhunk.snapenhance.ui.manager.pages.LoggerHistoryRoot
 import me.rhunk.snapenhance.ui.manager.pages.TasksRoot
 import me.rhunk.snapenhance.ui.manager.pages.features.FeaturesRoot
<a href="#h18-1" id="h18-1" class="h">@@ -27,6 +26,8 @@ import me.rhunk.snapenhance.ui.manager.pages.social.LoggedStories
</a> import me.rhunk.snapenhance.ui.manager.pages.social.ManageScope
 import me.rhunk.snapenhance.ui.manager.pages.social.MessagingPreview
 import me.rhunk.snapenhance.ui.manager.pages.social.SocialRoot
<a href="#h18-1-3" id="h18-1-3" class="i">+import me.rhunk.snapenhance.ui.manager.pages.tracker.EditRule
</a><a href="#h18-1-4" id="h18-1-4" class="i">+import me.rhunk.snapenhance.ui.manager.pages.tracker.FriendTrackerManagerRoot
</a> 
 
 data class RouteInfo(
<a href="#h18-2" id="h18-2" class="h">@@ -55,6 +56,7 @@ class Routes(
</a>     val homeLogs = route(RouteInfo(&quot;home_logs&quot;), HomeLogs()).parent(home)
     val loggerHistory = route(RouteInfo(&quot;logger_history&quot;), LoggerHistoryRoot()).parent(home)
     val friendTracker = route(RouteInfo(&quot;friend_tracker&quot;), FriendTrackerManagerRoot()).parent(home)
<a href="#h18-2-3" id="h18-2-3" class="i">+    val editRule = route(RouteInfo(&quot;edit_rule/?rule_id={rule_id}&quot;), EditRule())
</a> 
     val social = route(RouteInfo(&quot;social&quot;, icon = Icons.Default.Group, primary = true), SocialRoot())
     val manageScope = route(RouteInfo(&quot;manage_scope/?scope={scope}&amp;id={id}&quot;), ManageScope()).parent(social)
<b>diff --git a/<a id="h19" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/FriendTrackerManagerRoot.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/FriendTrackerManagerRoot.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/FriendTrackerManagerRoot.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/FriendTrackerManagerRoot.kt</a></b>
<a href="#h19-0" id="h19-0" class="h">@@ -1,330 +0,0 @@
</a><a href="#h19-0-0" id="h19-0-0" class="d">-package me.rhunk.snapenhance.ui.manager.pages
</a><a href="#h19-0-1" id="h19-0-1" class="d">-
</a><a href="#h19-0-2" id="h19-0-2" class="d">-import androidx.compose.foundation.ExperimentalFoundationApi
</a><a href="#h19-0-3" id="h19-0-3" class="d">-import androidx.compose.foundation.layout.*
</a><a href="#h19-0-4" id="h19-0-4" class="d">-import androidx.compose.foundation.lazy.LazyColumn
</a><a href="#h19-0-5" id="h19-0-5" class="d">-import androidx.compose.foundation.lazy.items
</a><a href="#h19-0-6" id="h19-0-6" class="d">-import androidx.compose.foundation.pager.HorizontalPager
</a><a href="#h19-0-7" id="h19-0-7" class="d">-import androidx.compose.foundation.pager.rememberPagerState
</a><a href="#h19-0-8" id="h19-0-8" class="d">-import androidx.compose.material.icons.Icons
</a><a href="#h19-0-9" id="h19-0-9" class="d">-import androidx.compose.material.icons.filled.Add
</a><a href="#h19-0-10" id="h19-0-10" class="d">-import androidx.compose.material.icons.filled.DeleteOutline
</a><a href="#h19-0-11" id="h19-0-11" class="d">-import androidx.compose.material3.*
</a><a href="#h19-0-12" id="h19-0-12" class="d">-import androidx.compose.runtime.*
</a><a href="#h19-0-13" id="h19-0-13" class="d">-import androidx.compose.ui.Alignment
</a><a href="#h19-0-14" id="h19-0-14" class="d">-import androidx.compose.ui.Modifier
</a><a href="#h19-0-15" id="h19-0-15" class="d">-import androidx.compose.ui.graphics.Color
</a><a href="#h19-0-16" id="h19-0-16" class="d">-import androidx.compose.ui.text.font.FontWeight
</a><a href="#h19-0-17" id="h19-0-17" class="d">-import androidx.compose.ui.text.style.TextAlign
</a><a href="#h19-0-18" id="h19-0-18" class="d">-import androidx.compose.ui.text.style.TextOverflow
</a><a href="#h19-0-19" id="h19-0-19" class="d">-import androidx.compose.ui.unit.dp
</a><a href="#h19-0-20" id="h19-0-20" class="d">-import androidx.compose.ui.unit.sp
</a><a href="#h19-0-21" id="h19-0-21" class="d">-import androidx.compose.ui.window.PopupProperties
</a><a href="#h19-0-22" id="h19-0-22" class="d">-import androidx.navigation.NavBackStackEntry
</a><a href="#h19-0-23" id="h19-0-23" class="d">-import kotlinx.coroutines.Dispatchers
</a><a href="#h19-0-24" id="h19-0-24" class="d">-import kotlinx.coroutines.Job
</a><a href="#h19-0-25" id="h19-0-25" class="d">-import kotlinx.coroutines.delay
</a><a href="#h19-0-26" id="h19-0-26" class="d">-import kotlinx.coroutines.launch
</a><a href="#h19-0-27" id="h19-0-27" class="d">-import kotlinx.coroutines.withContext
</a><a href="#h19-0-28" id="h19-0-28" class="d">-import me.rhunk.snapenhance.common.bridge.wrapper.TrackerLog
</a><a href="#h19-0-29" id="h19-0-29" class="d">-import me.rhunk.snapenhance.common.data.TrackerEventType
</a><a href="#h19-0-30" id="h19-0-30" class="d">-import me.rhunk.snapenhance.common.data.TrackerRule
</a><a href="#h19-0-31" id="h19-0-31" class="d">-import me.rhunk.snapenhance.common.data.TrackerRuleEvent
</a><a href="#h19-0-32" id="h19-0-32" class="d">-import me.rhunk.snapenhance.ui.manager.Routes
</a><a href="#h19-0-33" id="h19-0-33" class="d">-import me.rhunk.snapenhance.ui.util.pagerTabIndicatorOffset
</a><a href="#h19-0-34" id="h19-0-34" class="d">-import java.text.DateFormat
</a><a href="#h19-0-35" id="h19-0-35" class="d">-
</a><a href="#h19-0-36" id="h19-0-36" class="d">-
</a><a href="#h19-0-37" id="h19-0-37" class="d">-@OptIn(ExperimentalFoundationApi::class)
</a><a href="#h19-0-38" id="h19-0-38" class="d">-class FriendTrackerManagerRoot : Routes.Route() {
</a><a href="#h19-0-39" id="h19-0-39" class="d">-    enum class FilterType {
</a><a href="#h19-0-40" id="h19-0-40" class="d">-        CONVERSATION, USERNAME, EVENT
</a><a href="#h19-0-41" id="h19-0-41" class="d">-    }
</a><a href="#h19-0-42" id="h19-0-42" class="d">-
</a><a href="#h19-0-43" id="h19-0-43" class="d">-    private val titles = listOf(&quot;Logs&quot;, &quot;Config Rules&quot;)
</a><a href="#h19-0-44" id="h19-0-44" class="d">-    private var currentPage by mutableIntStateOf(0)
</a><a href="#h19-0-45" id="h19-0-45" class="d">-
</a><a href="#h19-0-46" id="h19-0-46" class="d">-    override val floatingActionButton: @Composable () -&gt; Unit = {
</a><a href="#h19-0-47" id="h19-0-47" class="d">-        if (currentPage == 1) {
</a><a href="#h19-0-48" id="h19-0-48" class="d">-            ExtendedFloatingActionButton(
</a><a href="#h19-0-49" id="h19-0-49" class="d">-                icon = { Icon(Icons.Default.Add, contentDescription = &quot;Add Rule&quot;) },
</a><a href="#h19-0-50" id="h19-0-50" class="d">-                expanded = false,
</a><a href="#h19-0-51" id="h19-0-51" class="d">-                text = {},
</a><a href="#h19-0-52" id="h19-0-52" class="d">-                onClick = {}
</a><a href="#h19-0-53" id="h19-0-53" class="d">-            )
</a><a href="#h19-0-54" id="h19-0-54" class="d">-        }
</a><a href="#h19-0-55" id="h19-0-55" class="d">-    }
</a><a href="#h19-0-56" id="h19-0-56" class="d">-
</a><a href="#h19-0-57" id="h19-0-57" class="d">-    @OptIn(ExperimentalMaterial3Api::class)
</a><a href="#h19-0-58" id="h19-0-58" class="d">-    @Composable
</a><a href="#h19-0-59" id="h19-0-59" class="d">-    private fun LogsTab() {
</a><a href="#h19-0-60" id="h19-0-60" class="d">-        val coroutineScope = rememberCoroutineScope()
</a><a href="#h19-0-61" id="h19-0-61" class="d">-
</a><a href="#h19-0-62" id="h19-0-62" class="d">-        val logs = remember { mutableStateListOf&lt;TrackerLog&gt;() }
</a><a href="#h19-0-63" id="h19-0-63" class="d">-        var lastTimestamp by remember { mutableLongStateOf(Long.MAX_VALUE) }
</a><a href="#h19-0-64" id="h19-0-64" class="d">-        var filterType by remember { mutableStateOf(FilterType.USERNAME) }
</a><a href="#h19-0-65" id="h19-0-65" class="d">-
</a><a href="#h19-0-66" id="h19-0-66" class="d">-        var filter by remember { mutableStateOf(&quot;&quot;) }
</a><a href="#h19-0-67" id="h19-0-67" class="d">-        var searchTimeoutJob by remember { mutableStateOf&lt;Job?&gt;(null) }
</a><a href="#h19-0-68" id="h19-0-68" class="d">-
</a><a href="#h19-0-69" id="h19-0-69" class="d">-        suspend fun loadNewLogs() {
</a><a href="#h19-0-70" id="h19-0-70" class="d">-            withContext(Dispatchers.IO) {
</a><a href="#h19-0-71" id="h19-0-71" class="d">-                logs.addAll(context.messageLogger.getLogs(lastTimestamp, filter = {
</a><a href="#h19-0-72" id="h19-0-72" class="d">-                    when (filterType) {
</a><a href="#h19-0-73" id="h19-0-73" class="d">-                        FilterType.USERNAME -&gt; it.username.contains(filter, ignoreCase = true)
</a><a href="#h19-0-74" id="h19-0-74" class="d">-                        FilterType.CONVERSATION -&gt; it.conversationTitle?.contains(filter, ignoreCase = true) == true || (it.username == filter &amp;&amp; !it.isGroup)
</a><a href="#h19-0-75" id="h19-0-75" class="d">-                        FilterType.EVENT -&gt; it.eventType.contains(filter, ignoreCase = true)
</a><a href="#h19-0-76" id="h19-0-76" class="d">-                    }
</a><a href="#h19-0-77" id="h19-0-77" class="d">-                }).apply {
</a><a href="#h19-0-78" id="h19-0-78" class="d">-                    lastTimestamp = minOfOrNull { it.timestamp } ?: lastTimestamp
</a><a href="#h19-0-79" id="h19-0-79" class="d">-                })
</a><a href="#h19-0-80" id="h19-0-80" class="d">-            }
</a><a href="#h19-0-81" id="h19-0-81" class="d">-        }
</a><a href="#h19-0-82" id="h19-0-82" class="d">-
</a><a href="#h19-0-83" id="h19-0-83" class="d">-        suspend fun resetAndLoadLogs() {
</a><a href="#h19-0-84" id="h19-0-84" class="d">-            logs.clear()
</a><a href="#h19-0-85" id="h19-0-85" class="d">-            lastTimestamp = Long.MAX_VALUE
</a><a href="#h19-0-86" id="h19-0-86" class="d">-            loadNewLogs()
</a><a href="#h19-0-87" id="h19-0-87" class="d">-        }
</a><a href="#h19-0-88" id="h19-0-88" class="d">-
</a><a href="#h19-0-89" id="h19-0-89" class="d">-        Column(
</a><a href="#h19-0-90" id="h19-0-90" class="d">-            modifier = Modifier.fillMaxSize()
</a><a href="#h19-0-91" id="h19-0-91" class="d">-        ) {
</a><a href="#h19-0-92" id="h19-0-92" class="d">-            Row(
</a><a href="#h19-0-93" id="h19-0-93" class="d">-                modifier = Modifier.fillMaxWidth(),
</a><a href="#h19-0-94" id="h19-0-94" class="d">-                verticalAlignment = Alignment.CenterVertically,
</a><a href="#h19-0-95" id="h19-0-95" class="d">-            ) {
</a><a href="#h19-0-96" id="h19-0-96" class="d">-                var showAutoComplete by remember { mutableStateOf(false) }
</a><a href="#h19-0-97" id="h19-0-97" class="d">-                ExposedDropdownMenuBox(expanded = showAutoComplete, onExpandedChange = { showAutoComplete = it }) {
</a><a href="#h19-0-98" id="h19-0-98" class="d">-                    TextField(
</a><a href="#h19-0-99" id="h19-0-99" class="d">-                        value = filter,
</a><a href="#h19-0-100" id="h19-0-100" class="d">-                        onValueChange = {
</a><a href="#h19-0-101" id="h19-0-101" class="d">-                            filter = it
</a><a href="#h19-0-102" id="h19-0-102" class="d">-                            coroutineScope.launch {
</a><a href="#h19-0-103" id="h19-0-103" class="d">-                                searchTimeoutJob?.cancel()
</a><a href="#h19-0-104" id="h19-0-104" class="d">-                                searchTimeoutJob = coroutineScope.launch {
</a><a href="#h19-0-105" id="h19-0-105" class="d">-                                    delay(200)
</a><a href="#h19-0-106" id="h19-0-106" class="d">-                                    showAutoComplete = true
</a><a href="#h19-0-107" id="h19-0-107" class="d">-                                    resetAndLoadLogs()
</a><a href="#h19-0-108" id="h19-0-108" class="d">-                                }
</a><a href="#h19-0-109" id="h19-0-109" class="d">-                            }
</a><a href="#h19-0-110" id="h19-0-110" class="d">-                        },
</a><a href="#h19-0-111" id="h19-0-111" class="d">-                        placeholder = { Text(&quot;Search&quot;) },
</a><a href="#h19-0-112" id="h19-0-112" class="d">-                        maxLines = 1,
</a><a href="#h19-0-113" id="h19-0-113" class="d">-                        colors = TextFieldDefaults.colors(
</a><a href="#h19-0-114" id="h19-0-114" class="d">-                            focusedContainerColor = Color.Transparent,
</a><a href="#h19-0-115" id="h19-0-115" class="d">-                            unfocusedContainerColor = Color.Transparent
</a><a href="#h19-0-116" id="h19-0-116" class="d">-                        ),
</a><a href="#h19-0-117" id="h19-0-117" class="d">-                        modifier = Modifier
</a><a href="#h19-0-118" id="h19-0-118" class="d">-                            .weight(1F)
</a><a href="#h19-0-119" id="h19-0-119" class="d">-                            .menuAnchor()
</a><a href="#h19-0-120" id="h19-0-120" class="d">-                            .padding(8.dp)
</a><a href="#h19-0-121" id="h19-0-121" class="d">-                    )
</a><a href="#h19-0-122" id="h19-0-122" class="d">-
</a><a href="#h19-0-123" id="h19-0-123" class="d">-                    DropdownMenu(expanded = showAutoComplete, onDismissRequest = {
</a><a href="#h19-0-124" id="h19-0-124" class="d">-                        showAutoComplete = false
</a><a href="#h19-0-125" id="h19-0-125" class="d">-                    }, properties = PopupProperties(focusable = false)) {
</a><a href="#h19-0-126" id="h19-0-126" class="d">-                        val suggestedEntries = remember(filter) {
</a><a href="#h19-0-127" id="h19-0-127" class="d">-                            mutableStateListOf&lt;String&gt;()
</a><a href="#h19-0-128" id="h19-0-128" class="d">-                        }
</a><a href="#h19-0-129" id="h19-0-129" class="d">-
</a><a href="#h19-0-130" id="h19-0-130" class="d">-                        LaunchedEffect(filter) {
</a><a href="#h19-0-131" id="h19-0-131" class="d">-                            suggestedEntries.addAll(when (filterType) {
</a><a href="#h19-0-132" id="h19-0-132" class="d">-                                FilterType.USERNAME -&gt; context.messageLogger.findUsername(filter)
</a><a href="#h19-0-133" id="h19-0-133" class="d">-                                FilterType.CONVERSATION -&gt; context.messageLogger.findConversation(filter) + context.messageLogger.findUsername(filter)
</a><a href="#h19-0-134" id="h19-0-134" class="d">-                                FilterType.EVENT -&gt; TrackerEventType.entries.filter { it.name.contains(filter, ignoreCase = true) }.map { it.key }
</a><a href="#h19-0-135" id="h19-0-135" class="d">-                            }.take(5))
</a><a href="#h19-0-136" id="h19-0-136" class="d">-                        }
</a><a href="#h19-0-137" id="h19-0-137" class="d">-
</a><a href="#h19-0-138" id="h19-0-138" class="d">-                        suggestedEntries.forEach { entry -&gt;
</a><a href="#h19-0-139" id="h19-0-139" class="d">-                            DropdownMenuItem(onClick = {
</a><a href="#h19-0-140" id="h19-0-140" class="d">-                                filter = entry
</a><a href="#h19-0-141" id="h19-0-141" class="d">-                                coroutineScope.launch {
</a><a href="#h19-0-142" id="h19-0-142" class="d">-                                    resetAndLoadLogs()
</a><a href="#h19-0-143" id="h19-0-143" class="d">-                                }
</a><a href="#h19-0-144" id="h19-0-144" class="d">-                                showAutoComplete = false
</a><a href="#h19-0-145" id="h19-0-145" class="d">-                            }, text = {
</a><a href="#h19-0-146" id="h19-0-146" class="d">-                                Text(entry)
</a><a href="#h19-0-147" id="h19-0-147" class="d">-                            })
</a><a href="#h19-0-148" id="h19-0-148" class="d">-                        }
</a><a href="#h19-0-149" id="h19-0-149" class="d">-                    }
</a><a href="#h19-0-150" id="h19-0-150" class="d">-                }
</a><a href="#h19-0-151" id="h19-0-151" class="d">-
</a><a href="#h19-0-152" id="h19-0-152" class="d">-                var dropDownExpanded by remember { mutableStateOf(false) }
</a><a href="#h19-0-153" id="h19-0-153" class="d">-                ExposedDropdownMenuBox(expanded = dropDownExpanded, onExpandedChange = { dropDownExpanded = it }) {
</a><a href="#h19-0-154" id="h19-0-154" class="d">-                    ElevatedCard(
</a><a href="#h19-0-155" id="h19-0-155" class="d">-                        modifier = Modifier.menuAnchor()
</a><a href="#h19-0-156" id="h19-0-156" class="d">-                    ) {
</a><a href="#h19-0-157" id="h19-0-157" class="d">-                        Text(&quot;Filter &quot; + filterType.name, modifier = Modifier.padding(8.dp))
</a><a href="#h19-0-158" id="h19-0-158" class="d">-                    }
</a><a href="#h19-0-159" id="h19-0-159" class="d">-                    DropdownMenu(expanded = dropDownExpanded, onDismissRequest = {
</a><a href="#h19-0-160" id="h19-0-160" class="d">-                        dropDownExpanded = false
</a><a href="#h19-0-161" id="h19-0-161" class="d">-                    }) {
</a><a href="#h19-0-162" id="h19-0-162" class="d">-                        FilterType.entries.forEach { type -&gt;
</a><a href="#h19-0-163" id="h19-0-163" class="d">-                            DropdownMenuItem(onClick = {
</a><a href="#h19-0-164" id="h19-0-164" class="d">-                                filterType = type
</a><a href="#h19-0-165" id="h19-0-165" class="d">-                                dropDownExpanded = false
</a><a href="#h19-0-166" id="h19-0-166" class="d">-                                coroutineScope.launch {
</a><a href="#h19-0-167" id="h19-0-167" class="d">-                                    resetAndLoadLogs()
</a><a href="#h19-0-168" id="h19-0-168" class="d">-                                }
</a><a href="#h19-0-169" id="h19-0-169" class="d">-                            }, text = {
</a><a href="#h19-0-170" id="h19-0-170" class="d">-                                Text(type.name)
</a><a href="#h19-0-171" id="h19-0-171" class="d">-                            })
</a><a href="#h19-0-172" id="h19-0-172" class="d">-                        }
</a><a href="#h19-0-173" id="h19-0-173" class="d">-                    }
</a><a href="#h19-0-174" id="h19-0-174" class="d">-                }
</a><a href="#h19-0-175" id="h19-0-175" class="d">-            }
</a><a href="#h19-0-176" id="h19-0-176" class="d">-
</a><a href="#h19-0-177" id="h19-0-177" class="d">-            LazyColumn(
</a><a href="#h19-0-178" id="h19-0-178" class="d">-                modifier = Modifier.weight(1f)
</a><a href="#h19-0-179" id="h19-0-179" class="d">-            ) {
</a><a href="#h19-0-180" id="h19-0-180" class="d">-                item {
</a><a href="#h19-0-181" id="h19-0-181" class="d">-                    if (logs.isEmpty()) {
</a><a href="#h19-0-182" id="h19-0-182" class="d">-                        Text(&quot;No logs found&quot;, modifier = Modifier.padding(16.dp).fillMaxWidth(), textAlign = TextAlign.Center, fontWeight = FontWeight.Light)
</a><a href="#h19-0-183" id="h19-0-183" class="d">-                    }
</a><a href="#h19-0-184" id="h19-0-184" class="d">-                }
</a><a href="#h19-0-185" id="h19-0-185" class="d">-                items(logs) { log -&gt;
</a><a href="#h19-0-186" id="h19-0-186" class="d">-                    ElevatedCard(
</a><a href="#h19-0-187" id="h19-0-187" class="d">-                        modifier = Modifier
</a><a href="#h19-0-188" id="h19-0-188" class="d">-                            .fillMaxWidth()
</a><a href="#h19-0-189" id="h19-0-189" class="d">-                            .padding(5.dp)
</a><a href="#h19-0-190" id="h19-0-190" class="d">-                    ) {
</a><a href="#h19-0-191" id="h19-0-191" class="d">-                        Row(
</a><a href="#h19-0-192" id="h19-0-192" class="d">-                            modifier = Modifier
</a><a href="#h19-0-193" id="h19-0-193" class="d">-                                .fillMaxWidth()
</a><a href="#h19-0-194" id="h19-0-194" class="d">-                                .padding(8.dp),
</a><a href="#h19-0-195" id="h19-0-195" class="d">-                        ) {
</a><a href="#h19-0-196" id="h19-0-196" class="d">-                            Column(
</a><a href="#h19-0-197" id="h19-0-197" class="d">-                                modifier = Modifier
</a><a href="#h19-0-198" id="h19-0-198" class="d">-                                    .weight(1f)
</a><a href="#h19-0-199" id="h19-0-199" class="d">-                            ) {
</a><a href="#h19-0-200" id="h19-0-200" class="d">-                                Text(log.username + &quot; &quot; + log.eventType + &quot; in &quot; + log.conversationTitle)
</a><a href="#h19-0-201" id="h19-0-201" class="d">-                                Text(
</a><a href="#h19-0-202" id="h19-0-202" class="d">-                                    DateFormat.getDateTimeInstance().format(log.timestamp),
</a><a href="#h19-0-203" id="h19-0-203" class="d">-                                    fontSize = 12.sp,
</a><a href="#h19-0-204" id="h19-0-204" class="d">-                                    fontWeight = FontWeight.Light
</a><a href="#h19-0-205" id="h19-0-205" class="d">-                                )
</a><a href="#h19-0-206" id="h19-0-206" class="d">-                            }
</a><a href="#h19-0-207" id="h19-0-207" class="d">-
</a><a href="#h19-0-208" id="h19-0-208" class="d">-                            OutlinedIconButton(
</a><a href="#h19-0-209" id="h19-0-209" class="d">-                                onClick = {
</a><a href="#h19-0-210" id="h19-0-210" class="d">-
</a><a href="#h19-0-211" id="h19-0-211" class="d">-                                }
</a><a href="#h19-0-212" id="h19-0-212" class="d">-                            ) {
</a><a href="#h19-0-213" id="h19-0-213" class="d">-                                Icon(Icons.Default.DeleteOutline, contentDescription = &quot;Delete&quot;)
</a><a href="#h19-0-214" id="h19-0-214" class="d">-                            }
</a><a href="#h19-0-215" id="h19-0-215" class="d">-                        }
</a><a href="#h19-0-216" id="h19-0-216" class="d">-                    }
</a><a href="#h19-0-217" id="h19-0-217" class="d">-                }
</a><a href="#h19-0-218" id="h19-0-218" class="d">-                item {
</a><a href="#h19-0-219" id="h19-0-219" class="d">-                    Spacer(modifier = Modifier.height(16.dp))
</a><a href="#h19-0-220" id="h19-0-220" class="d">-
</a><a href="#h19-0-221" id="h19-0-221" class="d">-                    LaunchedEffect(lastTimestamp) {
</a><a href="#h19-0-222" id="h19-0-222" class="d">-                        loadNewLogs()
</a><a href="#h19-0-223" id="h19-0-223" class="d">-                    }
</a><a href="#h19-0-224" id="h19-0-224" class="d">-                }
</a><a href="#h19-0-225" id="h19-0-225" class="d">-            }
</a><a href="#h19-0-226" id="h19-0-226" class="d">-        }
</a><a href="#h19-0-227" id="h19-0-227" class="d">-
</a><a href="#h19-0-228" id="h19-0-228" class="d">-    }
</a><a href="#h19-0-229" id="h19-0-229" class="d">-
</a><a href="#h19-0-230" id="h19-0-230" class="d">-    @Composable
</a><a href="#h19-0-231" id="h19-0-231" class="d">-    @OptIn(ExperimentalLayoutApi::class)
</a><a href="#h19-0-232" id="h19-0-232" class="d">-    private fun ConfigRulesTab() {
</a><a href="#h19-0-233" id="h19-0-233" class="d">-        val rules = remember { mutableStateListOf&lt;TrackerRule&gt;() }
</a><a href="#h19-0-234" id="h19-0-234" class="d">-
</a><a href="#h19-0-235" id="h19-0-235" class="d">-        Column(
</a><a href="#h19-0-236" id="h19-0-236" class="d">-            modifier = Modifier.fillMaxSize()
</a><a href="#h19-0-237" id="h19-0-237" class="d">-        ) {
</a><a href="#h19-0-238" id="h19-0-238" class="d">-            LazyColumn(
</a><a href="#h19-0-239" id="h19-0-239" class="d">-                modifier = Modifier.weight(1f)
</a><a href="#h19-0-240" id="h19-0-240" class="d">-            ) {
</a><a href="#h19-0-241" id="h19-0-241" class="d">-                items(rules) { rule -&gt;
</a><a href="#h19-0-242" id="h19-0-242" class="d">-                    val events = remember(rule.id) {
</a><a href="#h19-0-243" id="h19-0-243" class="d">-                        mutableStateListOf&lt;TrackerRuleEvent&gt;()
</a><a href="#h19-0-244" id="h19-0-244" class="d">-                    }
</a><a href="#h19-0-245" id="h19-0-245" class="d">-
</a><a href="#h19-0-246" id="h19-0-246" class="d">-                    LaunchedEffect(rule.id) {
</a><a href="#h19-0-247" id="h19-0-247" class="d">-                        withContext(Dispatchers.IO) {
</a><a href="#h19-0-248" id="h19-0-248" class="d">-                            events.addAll(context.modDatabase.getTrackerEvents(rule.id))
</a><a href="#h19-0-249" id="h19-0-249" class="d">-                        }
</a><a href="#h19-0-250" id="h19-0-250" class="d">-                    }
</a><a href="#h19-0-251" id="h19-0-251" class="d">-
</a><a href="#h19-0-252" id="h19-0-252" class="d">-                    ElevatedCard(
</a><a href="#h19-0-253" id="h19-0-253" class="d">-                        modifier = Modifier
</a><a href="#h19-0-254" id="h19-0-254" class="d">-                            .fillMaxWidth()
</a><a href="#h19-0-255" id="h19-0-255" class="d">-                            .padding(5.dp)
</a><a href="#h19-0-256" id="h19-0-256" class="d">-                    ) {
</a><a href="#h19-0-257" id="h19-0-257" class="d">-                        Column(
</a><a href="#h19-0-258" id="h19-0-258" class="d">-                            modifier = Modifier
</a><a href="#h19-0-259" id="h19-0-259" class="d">-                                .fillMaxWidth()
</a><a href="#h19-0-260" id="h19-0-260" class="d">-                                .padding(16.dp),
</a><a href="#h19-0-261" id="h19-0-261" class="d">-                            verticalArrangement = Arrangement.spacedBy(2.dp)
</a><a href="#h19-0-262" id="h19-0-262" class="d">-                        ) {
</a><a href="#h19-0-263" id="h19-0-263" class="d">-                            Text(&quot;Rule: ${rule.id} - conversationId: ${rule.conversationId?.let { &quot;present&quot; } ?: &quot;none&quot; } - userId: ${rule.userId?.let { &quot;present&quot; } ?: &quot;none&quot;}&quot;)
</a><a href="#h19-0-264" id="h19-0-264" class="d">-                            FlowRow(
</a><a href="#h19-0-265" id="h19-0-265" class="d">-                                modifier = Modifier.fillMaxWidth(),
</a><a href="#h19-0-266" id="h19-0-266" class="d">-                                horizontalArrangement = Arrangement.spacedBy(5.dp)
</a><a href="#h19-0-267" id="h19-0-267" class="d">-                            ) {
</a><a href="#h19-0-268" id="h19-0-268" class="d">-                                events.forEach { event -&gt;
</a><a href="#h19-0-269" id="h19-0-269" class="d">-                                    Text(&quot;${event.eventType} - ${event.flags}&quot;)
</a><a href="#h19-0-270" id="h19-0-270" class="d">-                                }
</a><a href="#h19-0-271" id="h19-0-271" class="d">-                            }
</a><a href="#h19-0-272" id="h19-0-272" class="d">-                        }
</a><a href="#h19-0-273" id="h19-0-273" class="d">-                    }
</a><a href="#h19-0-274" id="h19-0-274" class="d">-                }
</a><a href="#h19-0-275" id="h19-0-275" class="d">-            }
</a><a href="#h19-0-276" id="h19-0-276" class="d">-        }
</a><a href="#h19-0-277" id="h19-0-277" class="d">-
</a><a href="#h19-0-278" id="h19-0-278" class="d">-        LaunchedEffect(Unit) {
</a><a href="#h19-0-279" id="h19-0-279" class="d">-            rules.addAll(context.modDatabase.getTrackerRules(null, null))
</a><a href="#h19-0-280" id="h19-0-280" class="d">-        }
</a><a href="#h19-0-281" id="h19-0-281" class="d">-    }
</a><a href="#h19-0-282" id="h19-0-282" class="d">-
</a><a href="#h19-0-283" id="h19-0-283" class="d">-
</a><a href="#h19-0-284" id="h19-0-284" class="d">-    @OptIn(ExperimentalFoundationApi::class)
</a><a href="#h19-0-285" id="h19-0-285" class="d">-    override val content: @Composable (NavBackStackEntry) -&gt; Unit = {
</a><a href="#h19-0-286" id="h19-0-286" class="d">-        val coroutineScope = rememberCoroutineScope()
</a><a href="#h19-0-287" id="h19-0-287" class="d">-        val pagerState = rememberPagerState { titles.size }
</a><a href="#h19-0-288" id="h19-0-288" class="d">-        currentPage = pagerState.currentPage
</a><a href="#h19-0-289" id="h19-0-289" class="d">-
</a><a href="#h19-0-290" id="h19-0-290" class="d">-        Column {
</a><a href="#h19-0-291" id="h19-0-291" class="d">-            TabRow(selectedTabIndex = pagerState.currentPage, indicator = { tabPositions -&gt;
</a><a href="#h19-0-292" id="h19-0-292" class="d">-                TabRowDefaults.Indicator(
</a><a href="#h19-0-293" id="h19-0-293" class="d">-                    Modifier.pagerTabIndicatorOffset(
</a><a href="#h19-0-294" id="h19-0-294" class="d">-                        pagerState = pagerState,
</a><a href="#h19-0-295" id="h19-0-295" class="d">-                        tabPositions = tabPositions
</a><a href="#h19-0-296" id="h19-0-296" class="d">-                    )
</a><a href="#h19-0-297" id="h19-0-297" class="d">-                )
</a><a href="#h19-0-298" id="h19-0-298" class="d">-            }) {
</a><a href="#h19-0-299" id="h19-0-299" class="d">-                titles.forEachIndexed { index, title -&gt;
</a><a href="#h19-0-300" id="h19-0-300" class="d">-                    Tab(
</a><a href="#h19-0-301" id="h19-0-301" class="d">-                        selected = pagerState.currentPage == index,
</a><a href="#h19-0-302" id="h19-0-302" class="d">-                        onClick = {
</a><a href="#h19-0-303" id="h19-0-303" class="d">-                            coroutineScope.launch {
</a><a href="#h19-0-304" id="h19-0-304" class="d">-                                pagerState.animateScrollToPage(index)
</a><a href="#h19-0-305" id="h19-0-305" class="d">-                            }
</a><a href="#h19-0-306" id="h19-0-306" class="d">-                        },
</a><a href="#h19-0-307" id="h19-0-307" class="d">-                        text = {
</a><a href="#h19-0-308" id="h19-0-308" class="d">-                            Text(
</a><a href="#h19-0-309" id="h19-0-309" class="d">-                                text = title,
</a><a href="#h19-0-310" id="h19-0-310" class="d">-                                maxLines = 2,
</a><a href="#h19-0-311" id="h19-0-311" class="d">-                                overflow = TextOverflow.Ellipsis
</a><a href="#h19-0-312" id="h19-0-312" class="d">-                            )
</a><a href="#h19-0-313" id="h19-0-313" class="d">-                        }
</a><a href="#h19-0-314" id="h19-0-314" class="d">-                    )
</a><a href="#h19-0-315" id="h19-0-315" class="d">-                }
</a><a href="#h19-0-316" id="h19-0-316" class="d">-            }
</a><a href="#h19-0-317" id="h19-0-317" class="d">-
</a><a href="#h19-0-318" id="h19-0-318" class="d">-            HorizontalPager(
</a><a href="#h19-0-319" id="h19-0-319" class="d">-                modifier = Modifier.weight(1f),
</a><a href="#h19-0-320" id="h19-0-320" class="d">-                state = pagerState
</a><a href="#h19-0-321" id="h19-0-321" class="d">-            ) { page -&gt;
</a><a href="#h19-0-322" id="h19-0-322" class="d">-                when (page) {
</a><a href="#h19-0-323" id="h19-0-323" class="d">-                    0 -&gt; LogsTab()
</a><a href="#h19-0-324" id="h19-0-324" class="d">-                    1 -&gt; ConfigRulesTab()
</a><a href="#h19-0-325" id="h19-0-325" class="d">-                }
</a><a href="#h19-0-326" id="h19-0-326" class="d">-            }
</a><a href="#h19-0-327" id="h19-0-327" class="d">-        }
</a><a href="#h19-0-328" id="h19-0-328" class="d">-    }
</a><a href="#h19-0-329" id="h19-0-329" class="d">-}</a><a href="#h19-0-330" id="h19-0-330" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h20" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/LoggerHistoryRoot.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/LoggerHistoryRoot.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/LoggerHistoryRoot.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/LoggerHistoryRoot.kt</a></b>
<a href="#h20-0" id="h20-0" class="h">@@ -17,9 +17,11 @@ import androidx.compose.ui.focus.FocusRequester
</a> import androidx.compose.ui.focus.focusRequester
 import androidx.compose.ui.graphics.Color
 import androidx.compose.ui.input.pointer.pointerInput
<a href="#h20-0-3" id="h20-0-3" class="i">+import androidx.compose.ui.text.font.FontStyle
</a> import androidx.compose.ui.text.font.FontWeight
 import androidx.compose.ui.text.style.TextAlign
 import androidx.compose.ui.unit.dp
<a href="#h20-0-7" id="h20-0-7" class="i">+import androidx.compose.ui.unit.sp
</a> import androidx.navigation.NavBackStackEntry
 import com.google.gson.JsonParser
 import kotlinx.coroutines.Dispatchers
<a href="#h20-1" id="h20-1" class="h">@@ -33,14 +35,19 @@ import me.rhunk.snapenhance.common.data.download.DownloadMetadata
</a> import me.rhunk.snapenhance.common.data.download.DownloadRequest
 import me.rhunk.snapenhance.common.data.download.MediaDownloadSource
 import me.rhunk.snapenhance.common.data.download.createNewFilePath
<a href="#h20-1-3" id="h20-1-3" class="i">+import me.rhunk.snapenhance.common.ui.rememberAsyncMutableState
</a> import me.rhunk.snapenhance.common.util.ktx.copyToClipboard
 import me.rhunk.snapenhance.common.util.ktx.longHashCode
 import me.rhunk.snapenhance.common.util.protobuf.ProtoReader
 import me.rhunk.snapenhance.core.features.impl.downloader.decoder.DecodedAttachment
 import me.rhunk.snapenhance.core.features.impl.downloader.decoder.MessageDecoder
 import me.rhunk.snapenhance.download.DownloadProcessor
<a href="#h20-1-10" id="h20-1-10" class="i">+import me.rhunk.snapenhance.storage.findFriend
</a><a href="#h20-1-11" id="h20-1-11" class="i">+import me.rhunk.snapenhance.storage.getFriendInfo
</a><a href="#h20-1-12" id="h20-1-12" class="i">+import me.rhunk.snapenhance.storage.getGroupInfo
</a> import me.rhunk.snapenhance.ui.manager.Routes
 import java.nio.ByteBuffer
<a href="#h20-1-15" id="h20-1-15" class="i">+import java.text.DateFormat
</a> import java.util.UUID
 import kotlin.math.absoluteValue
 
<a href="#h20-2" id="h20-2" class="h">@@ -114,7 +121,7 @@ class LoggerHistoryRoot : Routes.Route() {
</a>         ) {
             Row(
                 modifier = Modifier
<a href="#h20-2-3" id="h20-2-3" class="d">-                    .padding(4.dp)
</a><a href="#h20-2-4" id="h20-2-4" class="i">+                    .padding(8.dp)
</a>                     .fillMaxWidth(),
                 verticalAlignment = Alignment.CenterVertically
             ) {
<a href="#h20-3" id="h20-3" class="h">@@ -123,7 +130,7 @@ class LoggerHistoryRoot : Routes.Route() {
</a>                 LaunchedEffect(Unit, message) {
                     runCatching {
                         decodeMessage(message) { senderId, contentType, messageReader, attachments -&gt;
<a href="#h20-3-3" id="h20-3-3" class="d">-                            val senderUsername = senderId?.let { context.modDatabase.getFriendInfo(it)?.mutableUsername } ?: translation[&quot;unknown_sender&quot;]
</a><a href="#h20-3-4" id="h20-3-4" class="i">+                            val senderUsername = senderId?.let { context.database.getFriendInfo(it)?.mutableUsername } ?: translation[&quot;unknown_sender&quot;]
</a> 
                             @Composable
                             fun ContentHeader() {
<a href="#h20-4" id="h20-4" class="h">@@ -141,6 +148,26 @@ class LoggerHistoryRoot : Routes.Route() {
</a>                                                     context.androidContext.copyToClipboard(content)
                                                 })
                                             })
<a href="#h20-4-3" id="h20-4-3" class="i">+
</a><a href="#h20-4-4" id="h20-4-4" class="i">+                                        val edits by rememberAsyncMutableState(defaultValue = emptyList()) {
</a><a href="#h20-4-5" id="h20-4-5" class="i">+                                            loggerWrapper.getMessageEdits(selectedConversation!!, message.messageId)
</a><a href="#h20-4-6" id="h20-4-6" class="i">+                                        }
</a><a href="#h20-4-7" id="h20-4-7" class="i">+                                        edits.forEach { messageEdit -&gt;
</a><a href="#h20-4-8" id="h20-4-8" class="i">+                                            val date = remember {
</a><a href="#h20-4-9" id="h20-4-9" class="i">+                                                DateFormat.getDateTimeInstance().format(messageEdit.timestamp)
</a><a href="#h20-4-10" id="h20-4-10" class="i">+                                            }
</a><a href="#h20-4-11" id="h20-4-11" class="i">+                                            Text(
</a><a href="#h20-4-12" id="h20-4-12" class="i">+                                                modifier = Modifier.pointerInput(Unit) {
</a><a href="#h20-4-13" id="h20-4-13" class="i">+                                                    detectTapGestures(onLongPress = {
</a><a href="#h20-4-14" id="h20-4-14" class="i">+                                                        context.androidContext.copyToClipboard(messageEdit.messageText)
</a><a href="#h20-4-15" id="h20-4-15" class="i">+                                                    })
</a><a href="#h20-4-16" id="h20-4-16" class="i">+                                                }.fillMaxWidth().padding(start = 4.dp),
</a><a href="#h20-4-17" id="h20-4-17" class="i">+                                                text = messageEdit.messageText + &quot; (edited at $date)&quot;,
</a><a href="#h20-4-18" id="h20-4-18" class="i">+                                                fontWeight = FontWeight.Light,
</a><a href="#h20-4-19" id="h20-4-19" class="i">+                                                fontStyle = FontStyle.Italic,
</a><a href="#h20-4-20" id="h20-4-20" class="i">+                                                fontSize = 12.sp
</a><a href="#h20-4-21" id="h20-4-21" class="i">+                                            )
</a><a href="#h20-4-22" id="h20-4-22" class="i">+                                        }
</a>                                         ContentHeader()
                                     }
                                 }
<a href="#h20-5" id="h20-5" class="h">@@ -209,9 +236,9 @@ class LoggerHistoryRoot : Routes.Route() {
</a>             ) {
                 fun formatConversationId(conversationId: String?): String? {
                     if (conversationId == null) return null
<a href="#h20-5-3" id="h20-5-3" class="d">-                    return context.modDatabase.getGroupInfo(conversationId)?.name?.let {
</a><a href="#h20-5-4" id="h20-5-4" class="i">+                    return context.database.getGroupInfo(conversationId)?.name?.let {
</a>                         translation.format(&quot;list_group_format&quot;, &quot;name&quot; to it)
<a href="#h20-5-6" id="h20-5-6" class="d">-                    } ?: context.modDatabase.findFriend(conversationId)?.let {
</a><a href="#h20-5-7" id="h20-5-7" class="i">+                    } ?: context.database.findFriend(conversationId)?.let {
</a>                         translation.format(&quot;list_friend_format&quot;, &quot;name&quot; to (it.displayName?.let { name -&gt; &quot;$name (${it.mutableUsername})&quot; } ?: it.mutableUsername))
                     } ?: conversationId
                 }
<a href="#h20-6" id="h20-6" class="h">@@ -225,13 +252,8 @@ class LoggerHistoryRoot : Routes.Route() {
</a>                         .fillMaxWidth()
                 )
 
<a href="#h20-6-3" id="h20-6-3" class="d">-                val conversations = remember { mutableStateListOf&lt;String&gt;() }
</a><a href="#h20-6-4" id="h20-6-4" class="d">-
</a><a href="#h20-6-5" id="h20-6-5" class="d">-                LaunchedEffect(Unit) {
</a><a href="#h20-6-6" id="h20-6-6" class="d">-                    conversations.clear()
</a><a href="#h20-6-7" id="h20-6-7" class="d">-                    withContext(Dispatchers.IO) {
</a><a href="#h20-6-8" id="h20-6-8" class="d">-                        conversations.addAll(loggerWrapper.getAllConversations())
</a><a href="#h20-6-9" id="h20-6-9" class="d">-                    }
</a><a href="#h20-6-10" id="h20-6-10" class="i">+                val conversations by rememberAsyncMutableState(defaultValue = emptyList()) {
</a><a href="#h20-6-11" id="h20-6-11" class="i">+                    loggerWrapper.getAllConversations().toMutableList()
</a>                 }
 
                 ExposedDropdownMenu(expanded = expanded, onDismissRequest = { expanded = false }) {
<b>diff --git a/<a id="h21" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/TasksRoot.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/TasksRoot.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/TasksRoot.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/TasksRoot.kt</a></b>
<a href="#h21-0" id="h21-0" class="h">@@ -16,7 +16,7 @@ import androidx.compose.ui.Alignment
</a> import androidx.compose.ui.Modifier
 import androidx.compose.ui.draw.clip
 import androidx.compose.ui.graphics.StrokeCap
<a href="#h21-0-3" id="h21-0-3" class="d">- import androidx.compose.ui.unit.dp
</a><a href="#h21-0-4" id="h21-0-4" class="i">+import androidx.compose.ui.unit.dp
</a> import androidx.core.net.toUri
 import androidx.documentfile.provider.DocumentFile
 import androidx.lifecycle.Lifecycle
<a href="#h21-1" id="h21-1" class="h">@@ -28,6 +28,7 @@ import me.rhunk.snapenhance.bridge.DownloadCallback
</a> import me.rhunk.snapenhance.common.data.download.DownloadMetadata
 import me.rhunk.snapenhance.common.data.download.MediaDownloadSource
 import me.rhunk.snapenhance.common.data.download.createNewFilePath
<a href="#h21-1-3" id="h21-1-3" class="i">+import me.rhunk.snapenhance.common.ui.rememberAsyncMutableState
</a> import me.rhunk.snapenhance.common.util.ktx.longHashCode
 import me.rhunk.snapenhance.download.DownloadProcessor
 import me.rhunk.snapenhance.download.FFMpegProcessor
<a href="#h21-2" id="h21-2" class="h">@@ -133,34 +134,46 @@ class TasksRoot : Routes.Route() {
</a>         }
     }
 
<a href="#h21-2-3" id="h21-2-3" class="d">-    override val topBarActions: @Composable() (RowScope.() -&gt; Unit) = {
</a><a href="#h21-2-4" id="h21-2-4" class="i">+    override val topBarActions: @Composable (RowScope.() -&gt; Unit) = {
</a>         var showConfirmDialog by remember { mutableStateOf(false) }
<a href="#h21-2-6" id="h21-2-6" class="i">+        val coroutineScope = rememberCoroutineScope()
</a> 
<a href="#h21-2-8" id="h21-2-8" class="d">-        if (taskSelection.size == 1 &amp;&amp; taskSelection.firstOrNull()?.second?.exists() == true) {
</a><a href="#h21-2-9" id="h21-2-9" class="d">-            taskSelection.firstOrNull()?.second?.takeIf { it.exists() }?.let { documentFile -&gt;
</a><a href="#h21-2-10" id="h21-2-10" class="d">-                IconButton(onClick = {
</a><a href="#h21-2-11" id="h21-2-11" class="d">-                    runCatching {
</a><a href="#h21-2-12" id="h21-2-12" class="d">-                        context.androidContext.startActivity(Intent(Intent.ACTION_VIEW).apply {
</a><a href="#h21-2-13" id="h21-2-13" class="d">-                            setDataAndType(documentFile.uri, documentFile.type)
</a><a href="#h21-2-14" id="h21-2-14" class="d">-                            flags = Intent.FLAG_GRANT_READ_URI_PERMISSION or Intent.FLAG_ACTIVITY_NEW_TASK
</a><a href="#h21-2-15" id="h21-2-15" class="d">-                        })
</a><a href="#h21-2-16" id="h21-2-16" class="d">-                        taskSelection.clear()
</a><a href="#h21-2-17" id="h21-2-17" class="d">-                    }.onFailure {
</a><a href="#h21-2-18" id="h21-2-18" class="d">-                        context.log.error(&quot;Failed to open file ${taskSelection.first().second}&quot;, it)
</a><a href="#h21-2-19" id="h21-2-19" class="i">+        if (taskSelection.size == 1) {
</a><a href="#h21-2-20" id="h21-2-20" class="i">+            val selectionExists by rememberAsyncMutableState(defaultValue = false) {
</a><a href="#h21-2-21" id="h21-2-21" class="i">+                taskSelection.firstOrNull()?.second?.exists() == true
</a><a href="#h21-2-22" id="h21-2-22" class="i">+            }
</a><a href="#h21-2-23" id="h21-2-23" class="i">+            if (selectionExists) {
</a><a href="#h21-2-24" id="h21-2-24" class="i">+                taskSelection.firstOrNull()?.second?.let { documentFile -&gt;
</a><a href="#h21-2-25" id="h21-2-25" class="i">+                    IconButton(onClick = {
</a><a href="#h21-2-26" id="h21-2-26" class="i">+                        runCatching {
</a><a href="#h21-2-27" id="h21-2-27" class="i">+                            context.androidContext.startActivity(Intent(Intent.ACTION_VIEW).apply {
</a><a href="#h21-2-28" id="h21-2-28" class="i">+                                setDataAndType(documentFile.uri, documentFile.type)
</a><a href="#h21-2-29" id="h21-2-29" class="i">+                                flags = Intent.FLAG_GRANT_READ_URI_PERMISSION or Intent.FLAG_ACTIVITY_NEW_TASK
</a><a href="#h21-2-30" id="h21-2-30" class="i">+                            })
</a><a href="#h21-2-31" id="h21-2-31" class="i">+                            taskSelection.clear()
</a><a href="#h21-2-32" id="h21-2-32" class="i">+                        }.onFailure {
</a><a href="#h21-2-33" id="h21-2-33" class="i">+                            context.log.error(&quot;Failed to open file ${taskSelection.first().second}&quot;, it)
</a><a href="#h21-2-34" id="h21-2-34" class="i">+                        }
</a><a href="#h21-2-35" id="h21-2-35" class="i">+                    }) {
</a><a href="#h21-2-36" id="h21-2-36" class="i">+                        Icon(Icons.AutoMirrored.Filled.OpenInNew, contentDescription = &quot;Open&quot;)
</a>                     }
<a href="#h21-2-38" id="h21-2-38" class="d">-                }) {
</a><a href="#h21-2-39" id="h21-2-39" class="d">-                    Icon(Icons.AutoMirrored.Filled.OpenInNew, contentDescription = &quot;Open&quot;)
</a>                 }
             }
         }
 
<a href="#h21-2-44" id="h21-2-44" class="d">-        if (taskSelection.size &gt; 1 &amp;&amp; taskSelection.all { it.second?.type?.contains(&quot;video&quot;) == true }) {
</a><a href="#h21-2-45" id="h21-2-45" class="d">-            IconButton(onClick = {
</a><a href="#h21-2-46" id="h21-2-46" class="d">-                mergeSelection(taskSelection.toList().also {
</a><a href="#h21-2-47" id="h21-2-47" class="d">-                    taskSelection.clear()
</a><a href="#h21-2-48" id="h21-2-48" class="d">-                }.map { it.first to it.second!! })
</a><a href="#h21-2-49" id="h21-2-49" class="d">-            }) {
</a><a href="#h21-2-50" id="h21-2-50" class="d">-                Icon(Icons.Filled.Merge, contentDescription = &quot;Merge&quot;)
</a><a href="#h21-2-51" id="h21-2-51" class="i">+        if (taskSelection.size &gt; 1) {
</a><a href="#h21-2-52" id="h21-2-52" class="i">+            val canMergeSelection by rememberAsyncMutableState(defaultValue = false, keys = arrayOf(taskSelection.size)) {
</a><a href="#h21-2-53" id="h21-2-53" class="i">+                taskSelection.all { it.second?.type?.contains(&quot;video&quot;) == true }
</a><a href="#h21-2-54" id="h21-2-54" class="i">+            }
</a><a href="#h21-2-55" id="h21-2-55" class="i">+
</a><a href="#h21-2-56" id="h21-2-56" class="i">+            if (canMergeSelection) {
</a><a href="#h21-2-57" id="h21-2-57" class="i">+                IconButton(onClick = {
</a><a href="#h21-2-58" id="h21-2-58" class="i">+                    mergeSelection(taskSelection.toList().also {
</a><a href="#h21-2-59" id="h21-2-59" class="i">+                        taskSelection.clear()
</a><a href="#h21-2-60" id="h21-2-60" class="i">+                    }.map { it.first to it.second!! })
</a><a href="#h21-2-61" id="h21-2-61" class="i">+                }) {
</a><a href="#h21-2-62" id="h21-2-62" class="i">+                    Icon(Icons.Filled.Merge, contentDescription = &quot;Merge&quot;)
</a><a href="#h21-2-63" id="h21-2-63" class="i">+                }
</a>             }
         }
 
<a href="#h21-3" id="h21-3" class="h">@@ -187,9 +200,12 @@ class TasksRoot : Routes.Route() {
</a>                         if (taskSelection.isNotEmpty()) {
                             Text(translation[&quot;remove_selected_tasks_title&quot;])
                             Row (
<a href="#h21-3-3" id="h21-3-3" class="d">-                                modifier = Modifier.padding(top = 10.dp).fillMaxWidth().clickable {
</a><a href="#h21-3-4" id="h21-3-4" class="d">-                                    alsoDeleteFiles = !alsoDeleteFiles
</a><a href="#h21-3-5" id="h21-3-5" class="d">-                                },
</a><a href="#h21-3-6" id="h21-3-6" class="i">+                                modifier = Modifier
</a><a href="#h21-3-7" id="h21-3-7" class="i">+                                    .padding(top = 10.dp)
</a><a href="#h21-3-8" id="h21-3-8" class="i">+                                    .fillMaxWidth()
</a><a href="#h21-3-9" id="h21-3-9" class="i">+                                    .clickable {
</a><a href="#h21-3-10" id="h21-3-10" class="i">+                                        alsoDeleteFiles = !alsoDeleteFiles
</a><a href="#h21-3-11" id="h21-3-11" class="i">+                                    },
</a>                                 horizontalArrangement = Arrangement.spacedBy(5.dp),
                                 verticalAlignment = Alignment.CenterVertically
                             ) {
<a href="#h21-4" id="h21-4" class="h">@@ -207,19 +223,22 @@ class TasksRoot : Routes.Route() {
</a>                     Button(
                         onClick = {
                             showConfirmDialog = false
<a href="#h21-4-3" id="h21-4-3" class="d">-
</a>                             if (taskSelection.isNotEmpty()) {
                                 taskSelection.forEach { (task, documentFile) -&gt;
<a href="#h21-4-6" id="h21-4-6" class="d">-                                    context.taskManager.removeTask(task)
</a><a href="#h21-4-7" id="h21-4-7" class="d">-                                    recentTasks.remove(task)
</a><a href="#h21-4-8" id="h21-4-8" class="d">-                                    if (alsoDeleteFiles) {
</a><a href="#h21-4-9" id="h21-4-9" class="d">-                                        documentFile?.delete()
</a><a href="#h21-4-10" id="h21-4-10" class="i">+                                    coroutineScope.launch(Dispatchers.IO) {
</a><a href="#h21-4-11" id="h21-4-11" class="i">+                                        context.taskManager.removeTask(task)
</a><a href="#h21-4-12" id="h21-4-12" class="i">+                                        if (alsoDeleteFiles) {
</a><a href="#h21-4-13" id="h21-4-13" class="i">+                                            documentFile?.delete()
</a><a href="#h21-4-14" id="h21-4-14" class="i">+                                        }
</a>                                     }
<a href="#h21-4-16" id="h21-4-16" class="i">+                                    recentTasks.remove(task)
</a>                                 }
                                 activeTasks = activeTasks.filter { task -&gt; !taskSelection.map { it.first }.contains(task.task) }
                                 taskSelection.clear()
                             } else {
<a href="#h21-4-21" id="h21-4-21" class="d">-                                context.taskManager.clearAllTasks()
</a><a href="#h21-4-22" id="h21-4-22" class="i">+                                coroutineScope.launch(Dispatchers.IO) {
</a><a href="#h21-4-23" id="h21-4-23" class="i">+                                    context.taskManager.clearAllTasks()
</a><a href="#h21-4-24" id="h21-4-24" class="i">+                                }
</a>                                 recentTasks.clear()
                                 activeTasks.forEach {
                                     runCatching {
<a href="#h21-5" id="h21-5" class="h">@@ -255,16 +274,17 @@ class TasksRoot : Routes.Route() {
</a>         var taskProgressLabel by remember { mutableStateOf&lt;String?&gt;(null) }
         var taskProgress by remember { mutableIntStateOf(-1) }
         val isSelected by remember { derivedStateOf { taskSelection.any { it.first == task } } }
<a href="#h21-5-3" id="h21-5-3" class="d">-        var documentFile by remember { mutableStateOf&lt;DocumentFile?&gt;(null) }
</a><a href="#h21-5-4" id="h21-5-4" class="d">-        var isDocumentFileReadable by remember { mutableStateOf(true) }
</a> 
<a href="#h21-5-6" id="h21-5-6" class="d">-        LaunchedEffect(taskStatus.key) {
</a><a href="#h21-5-7" id="h21-5-7" class="d">-            launch(Dispatchers.IO) {
</a><a href="#h21-5-8" id="h21-5-8" class="d">-                documentFile = DocumentFile.fromSingleUri(context.androidContext, task.extra?.toUri() ?: return@launch)
</a><a href="#h21-5-9" id="h21-5-9" class="d">-                isDocumentFileReadable = documentFile?.canRead() ?: false
</a><a href="#h21-5-10" id="h21-5-10" class="i">+        var documentFileMimeType by remember { mutableStateOf(&quot;&quot;) }
</a><a href="#h21-5-11" id="h21-5-11" class="i">+        var isDocumentFileReadable by remember { mutableStateOf(true) }
</a><a href="#h21-5-12" id="h21-5-12" class="i">+        val documentFile by rememberAsyncMutableState(defaultValue = null, keys = arrayOf(taskStatus.key)) {
</a><a href="#h21-5-13" id="h21-5-13" class="i">+            DocumentFile.fromSingleUri(context.androidContext, task.extra?.toUri() ?: return@rememberAsyncMutableState null)?.apply {
</a><a href="#h21-5-14" id="h21-5-14" class="i">+                documentFileMimeType = type ?: &quot;&quot;
</a><a href="#h21-5-15" id="h21-5-15" class="i">+                isDocumentFileReadable = canRead()
</a>             }
         }
 
<a href="#h21-5-19" id="h21-5-19" class="i">+
</a>         val listener = remember { PendingTaskListener(
             onStateChange = {
                 taskStatus = it
<a href="#h21-6" id="h21-6" class="h">@@ -285,19 +305,21 @@ class TasksRoot : Routes.Route() {
</a>             }
         }
 
<a href="#h21-6-3" id="h21-6-3" class="d">-        OutlinedCard(modifier = modifier.clickable {
</a><a href="#h21-6-4" id="h21-6-4" class="d">-            if (isSelected) {
</a><a href="#h21-6-5" id="h21-6-5" class="d">-                taskSelection.removeIf { it.first == task }
</a><a href="#h21-6-6" id="h21-6-6" class="d">-                return@clickable
</a><a href="#h21-6-7" id="h21-6-7" class="i">+        OutlinedCard(modifier = modifier
</a><a href="#h21-6-8" id="h21-6-8" class="i">+            .clickable {
</a><a href="#h21-6-9" id="h21-6-9" class="i">+                if (isSelected) {
</a><a href="#h21-6-10" id="h21-6-10" class="i">+                    taskSelection.removeIf { it.first == task }
</a><a href="#h21-6-11" id="h21-6-11" class="i">+                    return@clickable
</a><a href="#h21-6-12" id="h21-6-12" class="i">+                }
</a><a href="#h21-6-13" id="h21-6-13" class="i">+                taskSelection.add(task to documentFile)
</a>             }
<a href="#h21-6-15" id="h21-6-15" class="d">-            taskSelection.add(task to documentFile)
</a><a href="#h21-6-16" id="h21-6-16" class="d">-        }.let {
</a><a href="#h21-6-17" id="h21-6-17" class="d">-            if (isSelected) {
</a><a href="#h21-6-18" id="h21-6-18" class="d">-                it
</a><a href="#h21-6-19" id="h21-6-19" class="d">-                    .border(2.dp, MaterialTheme.colorScheme.primary)
</a><a href="#h21-6-20" id="h21-6-20" class="d">-                    .clip(MaterialTheme.shapes.medium)
</a><a href="#h21-6-21" id="h21-6-21" class="d">-            } else it
</a><a href="#h21-6-22" id="h21-6-22" class="d">-        }) {
</a><a href="#h21-6-23" id="h21-6-23" class="i">+            .let {
</a><a href="#h21-6-24" id="h21-6-24" class="i">+                if (isSelected) {
</a><a href="#h21-6-25" id="h21-6-25" class="i">+                    it
</a><a href="#h21-6-26" id="h21-6-26" class="i">+                        .border(2.dp, MaterialTheme.colorScheme.primary)
</a><a href="#h21-6-27" id="h21-6-27" class="i">+                        .clip(MaterialTheme.shapes.medium)
</a><a href="#h21-6-28" id="h21-6-28" class="i">+                } else it
</a><a href="#h21-6-29" id="h21-6-29" class="i">+            }) {
</a>             Row(
                 modifier = Modifier.padding(15.dp),
                 verticalAlignment = Alignment.CenterVertically
<a href="#h21-7" id="h21-7" class="h">@@ -305,13 +327,12 @@ class TasksRoot : Routes.Route() {
</a>                 Column(
                     modifier = Modifier.padding(end = 15.dp)
                 ) {
<a href="#h21-7-3" id="h21-7-3" class="d">-                    documentFile?.let { file -&gt;
</a><a href="#h21-7-4" id="h21-7-4" class="d">-                        val mimeType = file.type ?: &quot;&quot;
</a><a href="#h21-7-5" id="h21-7-5" class="i">+                    documentFile?.let {
</a>                         when {
                             !isDocumentFileReadable -&gt; Icon(Icons.Filled.DeleteOutline, contentDescription = &quot;File not found&quot;)
<a href="#h21-7-8" id="h21-7-8" class="d">-                            mimeType.contains(&quot;image&quot;) -&gt; Icon(Icons.Filled.Image, contentDescription = &quot;Image&quot;)
</a><a href="#h21-7-9" id="h21-7-9" class="d">-                            mimeType.contains(&quot;video&quot;) -&gt; Icon(Icons.Filled.Videocam, contentDescription = &quot;Video&quot;)
</a><a href="#h21-7-10" id="h21-7-10" class="d">-                            mimeType.contains(&quot;audio&quot;) -&gt; Icon(Icons.Filled.MusicNote, contentDescription = &quot;Audio&quot;)
</a><a href="#h21-7-11" id="h21-7-11" class="i">+                            documentFileMimeType.contains(&quot;image&quot;) -&gt; Icon(Icons.Filled.Image, contentDescription = &quot;Image&quot;)
</a><a href="#h21-7-12" id="h21-7-12" class="i">+                            documentFileMimeType.contains(&quot;video&quot;) -&gt; Icon(Icons.Filled.Videocam, contentDescription = &quot;Video&quot;)
</a><a href="#h21-7-13" id="h21-7-13" class="i">+                            documentFileMimeType.contains(&quot;audio&quot;) -&gt; Icon(Icons.Filled.MusicNote, contentDescription = &quot;Audio&quot;)
</a>                             else -&gt; Icon(Icons.Filled.FileCopy, contentDescription = &quot;File&quot;)
                         }
                     } ?: run {
<b>diff --git a/<a id="h22" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/features/FeaturesRoot.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/features/FeaturesRoot.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/features/FeaturesRoot.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/features/FeaturesRoot.kt</a></b>
<a href="#h22-0" id="h22-0" class="h">@@ -25,7 +25,6 @@ import androidx.compose.ui.Modifier
</a> import androidx.compose.ui.focus.FocusRequester
 import androidx.compose.ui.focus.focusRequester
 import androidx.compose.ui.graphics.Color
<a href="#h22-0-3" id="h22-0-3" class="d">-import androidx.compose.ui.graphics.vector.ImageVector
</a> import androidx.compose.ui.text.font.FontWeight
 import androidx.compose.ui.text.style.TextOverflow
 import androidx.compose.ui.unit.dp
<a href="#h22-1" id="h22-1" class="h">@@ -45,7 +44,6 @@ import me.rhunk.snapenhance.ui.manager.MainActivity
</a> import me.rhunk.snapenhance.ui.manager.Routes
 import me.rhunk.snapenhance.ui.util.*
 
<a href="#h22-1-3" id="h22-1-3" class="d">-@OptIn(ExperimentalMaterial3Api::class)
</a> class FeaturesRoot : Routes.Route() {
     private val alertDialogs by lazy { AlertDialogs(context.translation) }
 
<a href="#h22-2" id="h22-2" class="h">@@ -313,7 +311,7 @@ class FeaturesRoot : Routes.Route() {
</a>             FeatureNotice.REQUIRE_NATIVE_HOOKS.key to Color(0xFFFF5722),
         )
 
<a href="#h22-2-3" id="h22-2-3" class="d">-        Card(
</a><a href="#h22-2-4" id="h22-2-4" class="i">+        ElevatedCard(
</a>             modifier = Modifier
                 .fillMaxWidth()
                 .padding(start = 10.dp, end = 10.dp, top = 5.dp, bottom = 5.dp)
<a href="#h22-3" id="h22-3" class="h">@@ -327,24 +325,14 @@ class FeaturesRoot : Routes.Route() {
</a>                     .padding(all = 4.dp),
                 horizontalArrangement = Arrangement.SpaceBetween
             ) {
<a href="#h22-3-3" id="h22-3-3" class="d">-                property.key.params.icon?.let { iconName -&gt;
</a><a href="#h22-3-4" id="h22-3-4" class="d">-                    //TODO: find a better way to load icons
</a><a href="#h22-3-5" id="h22-3-5" class="d">-                    val icon: ImageVector? = remember(iconName) {
</a><a href="#h22-3-6" id="h22-3-6" class="d">-                        runCatching {
</a><a href="#h22-3-7" id="h22-3-7" class="d">-                            val cl = Class.forName(&quot;androidx.compose.material.icons.filled.${iconName}Kt&quot;)
</a><a href="#h22-3-8" id="h22-3-8" class="d">-                            val method = cl.declaredMethods.first()
</a><a href="#h22-3-9" id="h22-3-9" class="d">-                            method.invoke(null, Icons.Filled) as ImageVector
</a><a href="#h22-3-10" id="h22-3-10" class="d">-                        }.getOrNull()
</a><a href="#h22-3-11" id="h22-3-11" class="d">-                    }
</a><a href="#h22-3-12" id="h22-3-12" class="d">-                    if (icon != null) {
</a><a href="#h22-3-13" id="h22-3-13" class="d">-                        Icon(
</a><a href="#h22-3-14" id="h22-3-14" class="d">-                            imageVector = icon,
</a><a href="#h22-3-15" id="h22-3-15" class="d">-                            contentDescription = null,
</a><a href="#h22-3-16" id="h22-3-16" class="d">-                            modifier = Modifier
</a><a href="#h22-3-17" id="h22-3-17" class="d">-                                .align(Alignment.CenterVertically)
</a><a href="#h22-3-18" id="h22-3-18" class="d">-                                .padding(start = 10.dp)
</a><a href="#h22-3-19" id="h22-3-19" class="d">-                        )
</a><a href="#h22-3-20" id="h22-3-20" class="d">-                    }
</a><a href="#h22-3-21" id="h22-3-21" class="i">+                property.key.params.icon?.let { icon -&gt;
</a><a href="#h22-3-22" id="h22-3-22" class="i">+                    Icon(
</a><a href="#h22-3-23" id="h22-3-23" class="i">+                        imageVector = icon,
</a><a href="#h22-3-24" id="h22-3-24" class="i">+                        contentDescription = null,
</a><a href="#h22-3-25" id="h22-3-25" class="i">+                        modifier = Modifier
</a><a href="#h22-3-26" id="h22-3-26" class="i">+                            .align(Alignment.CenterVertically)
</a><a href="#h22-3-27" id="h22-3-27" class="i">+                            .padding(start = 10.dp)
</a><a href="#h22-3-28" id="h22-3-28" class="i">+                    )
</a>                 }
 
                 Column(
<b>diff --git a/<a id="h23" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/home/HomeLogs.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/home/HomeLogs.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/home/HomeLogs.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/home/HomeLogs.kt</a></b>
<a href="#h23-0" id="h23-0" class="h">@@ -31,6 +31,7 @@ import androidx.navigation.NavBackStackEntry
</a> import kotlinx.coroutines.Dispatchers
 import kotlinx.coroutines.delay
 import kotlinx.coroutines.launch
<a href="#h23-0-3" id="h23-0-3" class="i">+import kotlinx.coroutines.runBlocking
</a> import kotlinx.coroutines.withContext
 import me.rhunk.snapenhance.LogReader
 import me.rhunk.snapenhance.common.logger.LogChannel
<a href="#h23-1" id="h23-1" class="h">@@ -64,8 +65,12 @@ class HomeLogs : Routes.Route() {
</a>             modifier = Modifier.align(Alignment.CenterVertically)
         ) {
             DropdownMenuItem(onClick = {
<a href="#h23-1-3" id="h23-1-3" class="d">-                context.log.clearLogs()
</a><a href="#h23-1-4" id="h23-1-4" class="d">-                navigate()
</a><a href="#h23-1-5" id="h23-1-5" class="i">+                context.coroutineScope.launch {
</a><a href="#h23-1-6" id="h23-1-6" class="i">+                    context.log.clearLogs()
</a><a href="#h23-1-7" id="h23-1-7" class="i">+                }
</a><a href="#h23-1-8" id="h23-1-8" class="i">+                routes.navController.navigate(routeInfo.id) {
</a><a href="#h23-1-9" id="h23-1-9" class="i">+                    popUpTo(routeInfo.id) { inclusive = true }
</a><a href="#h23-1-10" id="h23-1-10" class="i">+                }
</a>                 showDropDown = false
             }, text = {
                 Text(translation[&quot;clear_logs_button&quot;])
<a href="#h23-2" id="h23-2" class="h">@@ -148,63 +153,73 @@ class HomeLogs : Routes.Route() {
</a>                     }
                 }
                 items(lineCount) { index -&gt;
<a href="#h23-2-3" id="h23-2-3" class="d">-                    val logLine = remember(index) { logReader?.getLogLine(index) } ?: return@items
</a><a href="#h23-2-4" id="h23-2-4" class="i">+                    val logLine by remember(index) {
</a><a href="#h23-2-5" id="h23-2-5" class="i">+                        mutableStateOf(runBlocking(Dispatchers.IO) {
</a><a href="#h23-2-6" id="h23-2-6" class="i">+                            logReader?.getLogLine(index)
</a><a href="#h23-2-7" id="h23-2-7" class="i">+                        })
</a><a href="#h23-2-8" id="h23-2-8" class="i">+                    }
</a>                     var expand by remember { mutableStateOf(false) }
 
<a href="#h23-2-11" id="h23-2-11" class="d">-                    Box(modifier = Modifier
</a><a href="#h23-2-12" id="h23-2-12" class="d">-                        .fillMaxWidth()
</a><a href="#h23-2-13" id="h23-2-13" class="d">-                        .pointerInput(Unit) {
</a><a href="#h23-2-14" id="h23-2-14" class="d">-                            detectTapGestures(
</a><a href="#h23-2-15" id="h23-2-15" class="d">-                                onLongPress = {
</a><a href="#h23-2-16" id="h23-2-16" class="d">-                                    coroutineScope.launch {
</a><a href="#h23-2-17" id="h23-2-17" class="d">-                                        clipboardManager.setText(AnnotatedString(logLine.message))
</a><a href="#h23-2-18" id="h23-2-18" class="d">-                                    }
</a><a href="#h23-2-19" id="h23-2-19" class="d">-                                },
</a><a href="#h23-2-20" id="h23-2-20" class="d">-                                onTap = {
</a><a href="#h23-2-21" id="h23-2-21" class="d">-                                    expand = !expand
</a><a href="#h23-2-22" id="h23-2-22" class="d">-                                }
</a><a href="#h23-2-23" id="h23-2-23" class="d">-                            )
</a><a href="#h23-2-24" id="h23-2-24" class="d">-                        }) {
</a><a href="#h23-2-25" id="h23-2-25" class="d">-
</a><a href="#h23-2-26" id="h23-2-26" class="d">-                        Row(
</a><a href="#h23-2-27" id="h23-2-27" class="d">-                            modifier = Modifier
</a><a href="#h23-2-28" id="h23-2-28" class="d">-                                .padding(4.dp)
</a><a href="#h23-2-29" id="h23-2-29" class="d">-                                .fillMaxWidth()
</a><a href="#h23-2-30" id="h23-2-30" class="d">-                                .defaultMinSize(minHeight = 30.dp),
</a><a href="#h23-2-31" id="h23-2-31" class="d">-                            verticalAlignment = Alignment.CenterVertically
</a><a href="#h23-2-32" id="h23-2-32" class="d">-                        ) {
</a><a href="#h23-2-33" id="h23-2-33" class="d">-                            if (!expand) {
</a><a href="#h23-2-34" id="h23-2-34" class="d">-                                Icon(
</a><a href="#h23-2-35" id="h23-2-35" class="d">-                                    imageVector = when (logLine.logLevel) {
</a><a href="#h23-2-36" id="h23-2-36" class="d">-                                        LogLevel.DEBUG -&gt; Icons.Outlined.BugReport
</a><a href="#h23-2-37" id="h23-2-37" class="d">-                                        LogLevel.ERROR, LogLevel.ASSERT -&gt; Icons.Outlined.Report
</a><a href="#h23-2-38" id="h23-2-38" class="d">-                                        LogLevel.INFO, LogLevel.VERBOSE -&gt; Icons.Outlined.Info
</a><a href="#h23-2-39" id="h23-2-39" class="d">-                                        LogLevel.WARN -&gt; Icons.Outlined.Warning
</a><a href="#h23-2-40" id="h23-2-40" class="i">+                    logLine?.let { line -&gt;
</a><a href="#h23-2-41" id="h23-2-41" class="i">+                        Box(modifier = Modifier
</a><a href="#h23-2-42" id="h23-2-42" class="i">+                            .fillMaxWidth()
</a><a href="#h23-2-43" id="h23-2-43" class="i">+                            .pointerInput(Unit) {
</a><a href="#h23-2-44" id="h23-2-44" class="i">+                                detectTapGestures(
</a><a href="#h23-2-45" id="h23-2-45" class="i">+                                    onLongPress = {
</a><a href="#h23-2-46" id="h23-2-46" class="i">+                                        coroutineScope.launch {
</a><a href="#h23-2-47" id="h23-2-47" class="i">+                                            clipboardManager.setText(
</a><a href="#h23-2-48" id="h23-2-48" class="i">+                                                AnnotatedString(
</a><a href="#h23-2-49" id="h23-2-49" class="i">+                                                    line.message
</a><a href="#h23-2-50" id="h23-2-50" class="i">+                                                )
</a><a href="#h23-2-51" id="h23-2-51" class="i">+                                            )
</a><a href="#h23-2-52" id="h23-2-52" class="i">+                                        }
</a>                                     },
<a href="#h23-2-54" id="h23-2-54" class="d">-                                    contentDescription = null,
</a><a href="#h23-2-55" id="h23-2-55" class="i">+                                    onTap = {
</a><a href="#h23-2-56" id="h23-2-56" class="i">+                                        expand = !expand
</a><a href="#h23-2-57" id="h23-2-57" class="i">+                                    }
</a>                                 )
<a href="#h23-2-59" id="h23-2-59" class="i">+                            }) {
</a><a href="#h23-2-60" id="h23-2-60" class="i">+                            Row(
</a><a href="#h23-2-61" id="h23-2-61" class="i">+                                modifier = Modifier
</a><a href="#h23-2-62" id="h23-2-62" class="i">+                                    .padding(4.dp)
</a><a href="#h23-2-63" id="h23-2-63" class="i">+                                    .fillMaxWidth()
</a><a href="#h23-2-64" id="h23-2-64" class="i">+                                    .defaultMinSize(minHeight = 30.dp),
</a><a href="#h23-2-65" id="h23-2-65" class="i">+                                verticalAlignment = Alignment.CenterVertically
</a><a href="#h23-2-66" id="h23-2-66" class="i">+                            ) {
</a><a href="#h23-2-67" id="h23-2-67" class="i">+                                if (!expand) {
</a><a href="#h23-2-68" id="h23-2-68" class="i">+                                    Icon(
</a><a href="#h23-2-69" id="h23-2-69" class="i">+                                        imageVector = when (line.logLevel) {
</a><a href="#h23-2-70" id="h23-2-70" class="i">+                                            LogLevel.DEBUG -&gt; Icons.Outlined.BugReport
</a><a href="#h23-2-71" id="h23-2-71" class="i">+                                            LogLevel.ERROR, LogLevel.ASSERT -&gt; Icons.Outlined.Report
</a><a href="#h23-2-72" id="h23-2-72" class="i">+                                            LogLevel.INFO, LogLevel.VERBOSE -&gt; Icons.Outlined.Info
</a><a href="#h23-2-73" id="h23-2-73" class="i">+                                            LogLevel.WARN -&gt; Icons.Outlined.Warning
</a><a href="#h23-2-74" id="h23-2-74" class="i">+                                            else -&gt; Icons.Outlined.Info
</a><a href="#h23-2-75" id="h23-2-75" class="i">+                                        },
</a><a href="#h23-2-76" id="h23-2-76" class="i">+                                        contentDescription = null,
</a><a href="#h23-2-77" id="h23-2-77" class="i">+                                    )
</a> 
<a href="#h23-2-79" id="h23-2-79" class="d">-                                Text(
</a><a href="#h23-2-80" id="h23-2-80" class="d">-                                    text = LogChannel.fromChannel(logLine.tag)?.shortName ?: logLine.tag,
</a><a href="#h23-2-81" id="h23-2-81" class="d">-                                    modifier = Modifier.padding(start = 4.dp),
</a><a href="#h23-2-82" id="h23-2-82" class="d">-                                    fontWeight = FontWeight.Light,
</a><a href="#h23-2-83" id="h23-2-83" class="d">-                                    fontSize = 10.sp,
</a><a href="#h23-2-84" id="h23-2-84" class="d">-                                )
</a><a href="#h23-2-85" id="h23-2-85" class="i">+                                    Text(
</a><a href="#h23-2-86" id="h23-2-86" class="i">+                                        text = LogChannel.fromChannel(line.tag)?.shortName ?: line.tag,
</a><a href="#h23-2-87" id="h23-2-87" class="i">+                                        modifier = Modifier.padding(start = 4.dp),
</a><a href="#h23-2-88" id="h23-2-88" class="i">+                                        fontWeight = FontWeight.Light,
</a><a href="#h23-2-89" id="h23-2-89" class="i">+                                        fontSize = 10.sp,
</a><a href="#h23-2-90" id="h23-2-90" class="i">+                                    )
</a><a href="#h23-2-91" id="h23-2-91" class="i">+
</a><a href="#h23-2-92" id="h23-2-92" class="i">+                                    Text(
</a><a href="#h23-2-93" id="h23-2-93" class="i">+                                        text = line.dateTime,
</a><a href="#h23-2-94" id="h23-2-94" class="i">+                                        modifier = Modifier.padding(start = 4.dp, end = 4.dp),
</a><a href="#h23-2-95" id="h23-2-95" class="i">+                                        fontSize = 10.sp
</a><a href="#h23-2-96" id="h23-2-96" class="i">+                                    )
</a><a href="#h23-2-97" id="h23-2-97" class="i">+                                }
</a> 
                                 Text(
<a href="#h23-2-100" id="h23-2-100" class="d">-                                    text = logLine.dateTime,
</a><a href="#h23-2-101" id="h23-2-101" class="d">-                                    modifier = Modifier.padding(start = 4.dp, end = 4.dp),
</a><a href="#h23-2-102" id="h23-2-102" class="d">-                                    fontSize = 10.sp
</a><a href="#h23-2-103" id="h23-2-103" class="i">+                                    text = line.message.trimIndent(),
</a><a href="#h23-2-104" id="h23-2-104" class="i">+                                    fontSize = 10.sp,
</a><a href="#h23-2-105" id="h23-2-105" class="i">+                                    maxLines = if (expand) Int.MAX_VALUE else 6,
</a><a href="#h23-2-106" id="h23-2-106" class="i">+                                    overflow = if (expand) TextOverflow.Visible else TextOverflow.Ellipsis,
</a><a href="#h23-2-107" id="h23-2-107" class="i">+                                    softWrap = !expand,
</a>                                 )
                             }
<a href="#h23-2-110" id="h23-2-110" class="d">-
</a><a href="#h23-2-111" id="h23-2-111" class="d">-                            Text(
</a><a href="#h23-2-112" id="h23-2-112" class="d">-                                text = logLine.message.trimIndent(),
</a><a href="#h23-2-113" id="h23-2-113" class="d">-                                fontSize = 10.sp,
</a><a href="#h23-2-114" id="h23-2-114" class="d">-                                maxLines = if (expand) Int.MAX_VALUE else 6,
</a><a href="#h23-2-115" id="h23-2-115" class="d">-                                overflow = if (expand) TextOverflow.Visible else TextOverflow.Ellipsis,
</a><a href="#h23-2-116" id="h23-2-116" class="d">-                                softWrap = !expand,
</a><a href="#h23-2-117" id="h23-2-117" class="d">-                            )
</a>                         }
                     }
                 }
<b>diff --git a/<a id="h24" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/home/HomeRoot.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/home/HomeRoot.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/home/HomeRoot.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/home/HomeRoot.kt</a></b>
<a href="#h24-0" id="h24-0" class="h">@@ -2,42 +2,47 @@ package me.rhunk.snapenhance.ui.manager.pages.home
</a> 
 import android.content.Intent
 import android.net.Uri
<a href="#h24-0-3" id="h24-0-3" class="d">-import androidx.compose.foundation.Image
</a> import androidx.compose.foundation.ScrollState
 import androidx.compose.foundation.clickable
 import androidx.compose.foundation.layout.*
 import androidx.compose.foundation.verticalScroll
 import androidx.compose.material.icons.Icons
<a href="#h24-0-9" id="h24-0-9" class="i">+import androidx.compose.material.icons.automirrored.filled.Help
</a> import androidx.compose.material.icons.filled.BugReport
<a href="#h24-0-11" id="h24-0-11" class="i">+import androidx.compose.material.icons.filled.History
</a><a href="#h24-0-12" id="h24-0-12" class="i">+import androidx.compose.material.icons.filled.MoreVert
</a><a href="#h24-0-13" id="h24-0-13" class="i">+import androidx.compose.material.icons.filled.PersonSearch
</a> import androidx.compose.material.icons.filled.Settings
 import androidx.compose.material3.*
<a href="#h24-0-16" id="h24-0-16" class="d">-import androidx.compose.runtime.*
</a><a href="#h24-0-17" id="h24-0-17" class="i">+import androidx.compose.runtime.Composable
</a><a href="#h24-0-18" id="h24-0-18" class="i">+import androidx.compose.runtime.getValue
</a><a href="#h24-0-19" id="h24-0-19" class="i">+import androidx.compose.runtime.mutableStateOf
</a><a href="#h24-0-20" id="h24-0-20" class="i">+import androidx.compose.runtime.remember
</a><a href="#h24-0-21" id="h24-0-21" class="i">+import androidx.compose.runtime.setValue
</a> import androidx.compose.ui.Alignment
 import androidx.compose.ui.Modifier
<a href="#h24-0-24" id="h24-0-24" class="d">-import androidx.compose.ui.draw.scale
</a><a href="#h24-0-25" id="h24-0-25" class="d">-import androidx.compose.ui.graphics.ColorFilter
</a> import androidx.compose.ui.graphics.vector.ImageVector
<a href="#h24-0-27" id="h24-0-27" class="d">-import androidx.compose.ui.layout.ContentScale
</a><a href="#h24-0-28" id="h24-0-28" class="d">-import androidx.compose.ui.res.painterResource
</a> import androidx.compose.ui.res.vectorResource
 import androidx.compose.ui.text.font.Font
 import androidx.compose.ui.text.font.FontFamily
 import androidx.compose.ui.text.font.FontWeight
 import androidx.compose.ui.text.style.TextAlign
<a href="#h24-0-34" id="h24-0-34" class="i">+import androidx.compose.ui.unit.Dp
</a> import androidx.compose.ui.unit.dp
 import androidx.compose.ui.unit.sp
<a href="#h24-0-37" id="h24-0-37" class="d">-import androidx.lifecycle.Lifecycle
</a> import androidx.navigation.NavBackStackEntry
<a href="#h24-0-39" id="h24-0-39" class="d">-import kotlinx.coroutines.CoroutineScope
</a><a href="#h24-0-40" id="h24-0-40" class="d">-import kotlinx.coroutines.Dispatchers
</a> import kotlinx.coroutines.launch
 import me.rhunk.snapenhance.R
 import me.rhunk.snapenhance.common.BuildConfig
<a href="#h24-0-44" id="h24-0-44" class="i">+import me.rhunk.snapenhance.common.Constants
</a><a href="#h24-0-45" id="h24-0-45" class="i">+import me.rhunk.snapenhance.common.action.EnumAction
</a><a href="#h24-0-46" id="h24-0-46" class="i">+import me.rhunk.snapenhance.common.ui.rememberAsyncMutableState
</a><a href="#h24-0-47" id="h24-0-47" class="i">+import me.rhunk.snapenhance.common.ui.rememberAsyncMutableStateList
</a><a href="#h24-0-48" id="h24-0-48" class="i">+import me.rhunk.snapenhance.storage.getQuickTiles
</a><a href="#h24-0-49" id="h24-0-49" class="i">+import me.rhunk.snapenhance.storage.setQuickTiles
</a> import me.rhunk.snapenhance.ui.manager.Routes
<a href="#h24-0-51" id="h24-0-51" class="d">-import me.rhunk.snapenhance.ui.manager.data.InstallationSummary
</a> import me.rhunk.snapenhance.ui.manager.data.Updater
 import me.rhunk.snapenhance.ui.util.ActivityLauncherHelper
<a href="#h24-0-54" id="h24-0-54" class="d">-import me.rhunk.snapenhance.ui.util.OnLifecycleEvent
</a> 
 class HomeRoot : Routes.Route() {
     companion object {
<a href="#h24-1" id="h24-1" class="h">@@ -46,61 +51,33 @@ class HomeRoot : Routes.Route() {
</a> 
     private lateinit var activityLauncherHelper: ActivityLauncherHelper
 
<a href="#h24-1-3" id="h24-1-3" class="d">-    override val init: () -&gt; Unit = {
</a><a href="#h24-1-4" id="h24-1-4" class="d">-        activityLauncherHelper = ActivityLauncherHelper(context.activity!!)
</a><a href="#h24-1-5" id="h24-1-5" class="i">+    private fun launchActionIntent(action: EnumAction) {
</a><a href="#h24-1-6" id="h24-1-6" class="i">+        val intent = context.androidContext.packageManager.getLaunchIntentForPackage(Constants.SNAPCHAT_PACKAGE_NAME)
</a><a href="#h24-1-7" id="h24-1-7" class="i">+        intent?.putExtra(EnumAction.ACTION_PARAMETER, action.key)
</a><a href="#h24-1-8" id="h24-1-8" class="i">+        context.androidContext.startActivity(intent)
</a>     }
 
<a href="#h24-1-11" id="h24-1-11" class="d">-    @Composable
</a><a href="#h24-1-12" id="h24-1-12" class="d">-    private fun SummaryCards(installationSummary: InstallationSummary) {
</a><a href="#h24-1-13" id="h24-1-13" class="d">-        val summaryInfo = remember {
</a><a href="#h24-1-14" id="h24-1-14" class="d">-            mapOf(
</a><a href="#h24-1-15" id="h24-1-15" class="d">-                &quot;Build Issuer&quot; to (installationSummary.modInfo?.buildIssuer ?: &quot;Unknown&quot;),
</a><a href="#h24-1-16" id="h24-1-16" class="d">-                &quot;Build Type&quot; to (if (installationSummary.modInfo?.isDebugBuild == true) &quot;debug&quot; else &quot;release&quot;),
</a><a href="#h24-1-17" id="h24-1-17" class="d">-                &quot;Build Version&quot; to (installationSummary.modInfo?.buildVersion ?: &quot;Unknown&quot;),
</a><a href="#h24-1-18" id="h24-1-18" class="d">-                &quot;Build Package&quot; to (installationSummary.modInfo?.buildPackageName ?: &quot;Unknown&quot;),
</a><a href="#h24-1-19" id="h24-1-19" class="d">-                &quot;Activity Package&quot; to (installationSummary.modInfo?.loaderPackageName ?: &quot;Unknown&quot;),
</a><a href="#h24-1-20" id="h24-1-20" class="d">-                &quot;Device&quot; to installationSummary.platformInfo.device,
</a><a href="#h24-1-21" id="h24-1-21" class="d">-                &quot;Android Version&quot; to installationSummary.platformInfo.androidVersion,
</a><a href="#h24-1-22" id="h24-1-22" class="d">-                &quot;System ABI&quot; to installationSummary.platformInfo.systemAbi
</a><a href="#h24-1-23" id="h24-1-23" class="d">-            )
</a><a href="#h24-1-24" id="h24-1-24" class="d">-        }
</a><a href="#h24-1-25" id="h24-1-25" class="d">-
</a><a href="#h24-1-26" id="h24-1-26" class="d">-        Card(
</a><a href="#h24-1-27" id="h24-1-27" class="d">-            modifier = Modifier
</a><a href="#h24-1-28" id="h24-1-28" class="d">-                .padding(all = cardMargin)
</a><a href="#h24-1-29" id="h24-1-29" class="d">-                .fillMaxWidth(),
</a><a href="#h24-1-30" id="h24-1-30" class="d">-            colors = CardDefaults.cardColors(
</a><a href="#h24-1-31" id="h24-1-31" class="d">-                containerColor = MaterialTheme.colorScheme.surfaceVariant,
</a><a href="#h24-1-32" id="h24-1-32" class="d">-                contentColor = MaterialTheme.colorScheme.onSurfaceVariant
</a><a href="#h24-1-33" id="h24-1-33" class="d">-            )
</a><a href="#h24-1-34" id="h24-1-34" class="d">-        ) {
</a><a href="#h24-1-35" id="h24-1-35" class="d">-            Column(
</a><a href="#h24-1-36" id="h24-1-36" class="d">-                modifier = Modifier
</a><a href="#h24-1-37" id="h24-1-37" class="d">-                    .fillMaxWidth()
</a><a href="#h24-1-38" id="h24-1-38" class="d">-                    .padding(all = 10.dp),
</a><a href="#h24-1-39" id="h24-1-39" class="d">-            ) {
</a><a href="#h24-1-40" id="h24-1-40" class="d">-                summaryInfo.forEach { (title, value) -&gt;
</a><a href="#h24-1-41" id="h24-1-41" class="d">-                    Column(
</a><a href="#h24-1-42" id="h24-1-42" class="d">-                        modifier = Modifier
</a><a href="#h24-1-43" id="h24-1-43" class="d">-                            .fillMaxWidth()
</a><a href="#h24-1-44" id="h24-1-44" class="d">-                            .padding(all = 5.dp),
</a><a href="#h24-1-45" id="h24-1-45" class="d">-                    ) {
</a><a href="#h24-1-46" id="h24-1-46" class="d">-                        Text(
</a><a href="#h24-1-47" id="h24-1-47" class="d">-                            text = title,
</a><a href="#h24-1-48" id="h24-1-48" class="d">-                            fontSize = 12.sp,
</a><a href="#h24-1-49" id="h24-1-49" class="d">-                            fontWeight = FontWeight.Light,
</a><a href="#h24-1-50" id="h24-1-50" class="d">-                        )
</a><a href="#h24-1-51" id="h24-1-51" class="d">-                        Text(
</a><a href="#h24-1-52" id="h24-1-52" class="d">-                            fontSize = 14.sp,
</a><a href="#h24-1-53" id="h24-1-53" class="d">-                            text = value,
</a><a href="#h24-1-54" id="h24-1-54" class="d">-                            lineHeight = 20.sp
</a><a href="#h24-1-55" id="h24-1-55" class="d">-                        )
</a><a href="#h24-1-56" id="h24-1-56" class="d">-                    }
</a><a href="#h24-1-57" id="h24-1-57" class="i">+    private val cards by lazy {
</a><a href="#h24-1-58" id="h24-1-58" class="i">+        mapOf(
</a><a href="#h24-1-59" id="h24-1-59" class="i">+            (&quot;Friend Tracker&quot; to Icons.Default.PersonSearch) to {
</a><a href="#h24-1-60" id="h24-1-60" class="i">+                routes.friendTracker.navigateReset()
</a><a href="#h24-1-61" id="h24-1-61" class="i">+            },
</a><a href="#h24-1-62" id="h24-1-62" class="i">+            (&quot;Logger History&quot; to Icons.Default.History) to {
</a><a href="#h24-1-63" id="h24-1-63" class="i">+                routes.loggerHistory.navigateReset()
</a><a href="#h24-1-64" id="h24-1-64" class="i">+            },
</a><a href="#h24-1-65" id="h24-1-65" class="i">+        ).toMutableMap().apply {
</a><a href="#h24-1-66" id="h24-1-66" class="i">+            EnumAction.entries.forEach { action -&gt;
</a><a href="#h24-1-67" id="h24-1-67" class="i">+                this[context.translation[&quot;actions.${action.key}.name&quot;] to action.icon] = {
</a><a href="#h24-1-68" id="h24-1-68" class="i">+                    launchActionIntent(action)
</a>                 }
             }
         }
     }
 
<a href="#h24-1-74" id="h24-1-74" class="i">+    override val init: () -&gt; Unit = {
</a><a href="#h24-1-75" id="h24-1-75" class="i">+        activityLauncherHelper = ActivityLauncherHelper(context.activity !!)
</a><a href="#h24-1-76" id="h24-1-76" class="i">+    }
</a><a href="#h24-1-77" id="h24-1-77" class="i">+
</a>     override val topBarActions: @Composable (RowScope.() -&gt; Unit) = {
         IconButton(onClick = {
             routes.homeLogs.navigate()
<a href="#h24-2" id="h24-2" class="h">@@ -114,6 +91,36 @@ class HomeRoot : Routes.Route() {
</a>         }
     }
 
<a href="#h24-2-3" id="h24-2-3" class="i">+    @Composable
</a><a href="#h24-2-4" id="h24-2-4" class="i">+    fun LinkIcon(
</a><a href="#h24-2-5" id="h24-2-5" class="i">+        modifier: Modifier = Modifier,
</a><a href="#h24-2-6" id="h24-2-6" class="i">+        size: Dp = 32.dp,
</a><a href="#h24-2-7" id="h24-2-7" class="i">+        imageVector: ImageVector,
</a><a href="#h24-2-8" id="h24-2-8" class="i">+        dataArray: IntArray
</a><a href="#h24-2-9" id="h24-2-9" class="i">+    ) {
</a><a href="#h24-2-10" id="h24-2-10" class="i">+        Icon(
</a><a href="#h24-2-11" id="h24-2-11" class="i">+            imageVector = imageVector,
</a><a href="#h24-2-12" id="h24-2-12" class="i">+            contentDescription = null,
</a><a href="#h24-2-13" id="h24-2-13" class="i">+            tint = MaterialTheme.colorScheme.onSurfaceVariant,
</a><a href="#h24-2-14" id="h24-2-14" class="i">+            modifier = Modifier
</a><a href="#h24-2-15" id="h24-2-15" class="i">+                .size(size)
</a><a href="#h24-2-16" id="h24-2-16" class="i">+                .then(modifier)
</a><a href="#h24-2-17" id="h24-2-17" class="i">+                .clickable {
</a><a href="#h24-2-18" id="h24-2-18" class="i">+                    context.activity?.startActivity(Intent(Intent.ACTION_VIEW).apply {
</a><a href="#h24-2-19" id="h24-2-19" class="i">+                        data = Uri.parse(
</a><a href="#h24-2-20" id="h24-2-20" class="i">+                            dataArray
</a><a href="#h24-2-21" id="h24-2-21" class="i">+                                .map { it.toChar() }
</a><a href="#h24-2-22" id="h24-2-22" class="i">+                                .joinToString(&quot;&quot;)
</a><a href="#h24-2-23" id="h24-2-23" class="i">+                                .reversed()
</a><a href="#h24-2-24" id="h24-2-24" class="i">+                        )
</a><a href="#h24-2-25" id="h24-2-25" class="i">+                        flags = Intent.FLAG_ACTIVITY_NEW_TASK
</a><a href="#h24-2-26" id="h24-2-26" class="i">+                    })
</a><a href="#h24-2-27" id="h24-2-27" class="i">+                }
</a><a href="#h24-2-28" id="h24-2-28" class="i">+        )
</a><a href="#h24-2-29" id="h24-2-29" class="i">+    }
</a><a href="#h24-2-30" id="h24-2-30" class="i">+
</a><a href="#h24-2-31" id="h24-2-31" class="i">+
</a><a href="#h24-2-32" id="h24-2-32" class="i">+    @OptIn(ExperimentalLayoutApi::class, ExperimentalMaterial3Api::class)
</a>     override val content: @Composable (NavBackStackEntry) -&gt; Unit = {
         val avenirNextFontFamily = remember {
             FontFamily(
<a href="#h24-3" id="h24-3" class="h">@@ -121,26 +128,17 @@ class HomeRoot : Routes.Route() {
</a>             )
         }
 
<a href="#h24-3-3" id="h24-3-3" class="d">-        var latestUpdate by remember { mutableStateOf&lt;Updater.LatestRelease?&gt;(null) }
</a><a href="#h24-3-4" id="h24-3-4" class="d">-
</a>         Column(
             modifier = Modifier
<a href="#h24-3-7" id="h24-3-7" class="i">+                .fillMaxSize()
</a>                 .verticalScroll(ScrollState(0))
         ) {
<a href="#h24-3-10" id="h24-3-10" class="d">-
</a><a href="#h24-3-11" id="h24-3-11" class="d">-            Image(
</a><a href="#h24-3-12" id="h24-3-12" class="d">-                painter = painterResource(id = R.drawable.launcher_icon_monochrome),
</a><a href="#h24-3-13" id="h24-3-13" class="d">-                contentDescription = null,
</a><a href="#h24-3-14" id="h24-3-14" class="d">-                colorFilter = ColorFilter.tint(MaterialTheme.colorScheme.primary),
</a><a href="#h24-3-15" id="h24-3-15" class="d">-                contentScale = ContentScale.FillHeight,
</a><a href="#h24-3-16" id="h24-3-16" class="d">-                modifier = Modifier
</a><a href="#h24-3-17" id="h24-3-17" class="d">-                    .fillMaxWidth()
</a><a href="#h24-3-18" id="h24-3-18" class="d">-                    .scale(1.8f)
</a><a href="#h24-3-19" id="h24-3-19" class="d">-                    .height(90.dp)
</a><a href="#h24-3-20" id="h24-3-20" class="d">-            )
</a><a href="#h24-3-21" id="h24-3-21" class="d">-
</a>             Text(
<a href="#h24-3-23" id="h24-3-23" class="d">-                text = remember { intArrayOf(101,99,110,97,104,110,69,112,97,110,83).map { it.toChar() }.joinToString(&quot;&quot;).reversed() },
</a><a href="#h24-3-24" id="h24-3-24" class="i">+                text = remember {
</a><a href="#h24-3-25" id="h24-3-25" class="i">+                    intArrayOf(
</a><a href="#h24-3-26" id="h24-3-26" class="i">+                        101, 99, 110, 97, 104, 110, 69, 112, 97, 110, 83
</a><a href="#h24-3-27" id="h24-3-27" class="i">+                    ).map { it.toChar() }.joinToString(&quot;&quot;).reversed()
</a><a href="#h24-3-28" id="h24-3-28" class="i">+                },
</a>                 fontSize = 30.sp,
                 fontFamily = avenirNextFontFamily,
                 modifier = Modifier.align(Alignment.CenterHorizontally),
<a href="#h24-4" id="h24-4" class="h">@@ -153,52 +151,50 @@ class HomeRoot : Routes.Route() {
</a>                 modifier = Modifier.align(Alignment.CenterHorizontally),
             )
 
<a href="#h24-4-3" id="h24-4-3" class="d">-            Text(
</a><a href="#h24-4-4" id="h24-4-4" class="d">-                text = &quot;An xposed module made to enhance your Snapchat experience&quot;,
</a><a href="#h24-4-5" id="h24-4-5" class="d">-                modifier = Modifier
</a><a href="#h24-4-6" id="h24-4-6" class="d">-                    .padding(16.dp)
</a><a href="#h24-4-7" id="h24-4-7" class="d">-                    .fillMaxWidth(),
</a><a href="#h24-4-8" id="h24-4-8" class="d">-                textAlign = TextAlign.Center,
</a><a href="#h24-4-9" id="h24-4-9" class="d">-            )
</a><a href="#h24-4-10" id="h24-4-10" class="d">-
</a>             Row(
<a href="#h24-4-12" id="h24-4-12" class="d">-                horizontalArrangement = Arrangement.spacedBy(15.dp, Alignment.CenterHorizontally),
</a><a href="#h24-4-13" id="h24-4-13" class="d">-                modifier = Modifier
</a><a href="#h24-4-14" id="h24-4-14" class="i">+                horizontalArrangement = Arrangement.spacedBy(
</a><a href="#h24-4-15" id="h24-4-15" class="i">+                    15.dp, Alignment.CenterHorizontally
</a><a href="#h24-4-16" id="h24-4-16" class="i">+                ), modifier = Modifier
</a>                     .fillMaxWidth()
                     .padding(all = 10.dp)
             ) {
<a href="#h24-4-20" id="h24-4-20" class="d">-                Icon(
</a><a href="#h24-4-21" id="h24-4-21" class="i">+                LinkIcon(
</a>                     imageVector = ImageVector.vectorResource(id = R.drawable.ic_github),
<a href="#h24-4-23" id="h24-4-23" class="d">-                    contentDescription = null,
</a><a href="#h24-4-24" id="h24-4-24" class="d">-                    tint = MaterialTheme.colorScheme.onSurfaceVariant,
</a><a href="#h24-4-25" id="h24-4-25" class="d">-                    modifier = Modifier.size(32.dp).clickable {
</a><a href="#h24-4-26" id="h24-4-26" class="d">-                        context.activity?.startActivity(
</a><a href="#h24-4-27" id="h24-4-27" class="d">-                            Intent(Intent.ACTION_VIEW).apply {
</a><a href="#h24-4-28" id="h24-4-28" class="d">-                                data = Uri.parse(
</a><a href="#h24-4-29" id="h24-4-29" class="d">-                                    intArrayOf(101,99,110,97,104,110,69,112,97,110,83,47,107,110,117,104,114,47,109,111,99,46,98,117,104,116,105,103,47,47,58,115,112,116,116,104).map { it.toChar() }.joinToString(&quot;&quot;).reversed()
</a><a href="#h24-4-30" id="h24-4-30" class="d">-                                )
</a><a href="#h24-4-31" id="h24-4-31" class="d">-                                flags = Intent.FLAG_ACTIVITY_NEW_TASK
</a><a href="#h24-4-32" id="h24-4-32" class="d">-                            }
</a><a href="#h24-4-33" id="h24-4-33" class="d">-                        )
</a><a href="#h24-4-34" id="h24-4-34" class="d">-                    }
</a><a href="#h24-4-35" id="h24-4-35" class="i">+                    dataArray = intArrayOf(
</a><a href="#h24-4-36" id="h24-4-36" class="i">+                        101, 99, 110, 97, 104, 110, 69, 112, 97, 110, 83, 47, 107, 110,
</a><a href="#h24-4-37" id="h24-4-37" class="i">+                        117, 104, 114, 47, 109, 111, 99, 46, 98, 117, 104, 116, 105,
</a><a href="#h24-4-38" id="h24-4-38" class="i">+                        103, 47, 58, 115, 112, 116, 116, 104
</a><a href="#h24-4-39" id="h24-4-39" class="i">+                    )
</a>                 )
<a href="#h24-4-41" id="h24-4-41" class="d">-                Icon(
</a><a href="#h24-4-42" id="h24-4-42" class="i">+
</a><a href="#h24-4-43" id="h24-4-43" class="i">+                LinkIcon(
</a>                     imageVector = ImageVector.vectorResource(id = R.drawable.ic_telegram),
<a href="#h24-4-45" id="h24-4-45" class="d">-                    contentDescription = null,
</a><a href="#h24-4-46" id="h24-4-46" class="d">-                    tint = MaterialTheme.colorScheme.onSurfaceVariant,
</a><a href="#h24-4-47" id="h24-4-47" class="d">-                    modifier = Modifier.size(32.dp).clickable {
</a><a href="#h24-4-48" id="h24-4-48" class="d">-                        context.activity?.startActivity(
</a><a href="#h24-4-49" id="h24-4-49" class="d">-                            Intent(Intent.ACTION_VIEW).apply {
</a><a href="#h24-4-50" id="h24-4-50" class="d">-                                data = Uri.parse(
</a><a href="#h24-4-51" id="h24-4-51" class="d">-                                    intArrayOf(101,99,110,97,104,110,101,112,97,110,115,47,101,109,46,116,47,47,58,115,112,116,116,104).map { it.toChar() }.joinToString(&quot;&quot;).reversed()
</a><a href="#h24-4-52" id="h24-4-52" class="d">-                                )
</a><a href="#h24-4-53" id="h24-4-53" class="d">-                                flags = Intent.FLAG_ACTIVITY_NEW_TASK
</a><a href="#h24-4-54" id="h24-4-54" class="d">-                            }
</a><a href="#h24-4-55" id="h24-4-55" class="d">-                        )
</a><a href="#h24-4-56" id="h24-4-56" class="d">-                    }
</a><a href="#h24-4-57" id="h24-4-57" class="i">+                    dataArray = intArrayOf(
</a><a href="#h24-4-58" id="h24-4-58" class="i">+                        101, 99, 110, 97, 104, 110, 101, 112, 97, 110, 115, 47, 101,
</a><a href="#h24-4-59" id="h24-4-59" class="i">+                        109, 46, 116, 47, 47, 58, 115, 112, 116, 116, 104
</a><a href="#h24-4-60" id="h24-4-60" class="i">+                    )
</a><a href="#h24-4-61" id="h24-4-61" class="i">+                )
</a><a href="#h24-4-62" id="h24-4-62" class="i">+
</a><a href="#h24-4-63" id="h24-4-63" class="i">+                LinkIcon(
</a><a href="#h24-4-64" id="h24-4-64" class="i">+                    size = 36.dp,
</a><a href="#h24-4-65" id="h24-4-65" class="i">+                    modifier = Modifier.offset(y = (-2).dp),
</a><a href="#h24-4-66" id="h24-4-66" class="i">+                    imageVector = Icons.AutoMirrored.Default.Help,
</a><a href="#h24-4-67" id="h24-4-67" class="i">+                    dataArray = intArrayOf(
</a><a href="#h24-4-68" id="h24-4-68" class="i">+                        105, 107, 105, 119, 47, 101, 99, 110, 97, 104, 110, 69, 112, 97,
</a><a href="#h24-4-69" id="h24-4-69" class="i">+                        110, 83, 47, 107, 110, 117, 104, 114, 47, 109, 111, 99, 46, 98,
</a><a href="#h24-4-70" id="h24-4-70" class="i">+                        117, 104, 116, 105, 103, 47, 47, 58, 115, 112, 116, 116, 104
</a><a href="#h24-4-71" id="h24-4-71" class="i">+                    )
</a>                 )
             }
 
<a href="#h24-4-75" id="h24-4-75" class="i">+            val selectedTiles = rememberAsyncMutableStateList(defaultValue = listOf()) {
</a><a href="#h24-4-76" id="h24-4-76" class="i">+                context.database.getQuickTiles()
</a><a href="#h24-4-77" id="h24-4-77" class="i">+            }
</a><a href="#h24-4-78" id="h24-4-78" class="i">+
</a><a href="#h24-4-79" id="h24-4-79" class="i">+            val latestUpdate by rememberAsyncMutableState(defaultValue = null) {
</a><a href="#h24-4-80" id="h24-4-80" class="i">+                if (!BuildConfig.DEBUG) Updater.checkForLatestRelease() else null
</a><a href="#h24-4-81" id="h24-4-81" class="i">+            }
</a><a href="#h24-4-82" id="h24-4-82" class="i">+
</a>             if (latestUpdate != null) {
                 Spacer(modifier = Modifier.height(20.dp))
                 OutlinedCard(
<a href="#h24-5" id="h24-5" class="h">@@ -209,7 +205,7 @@ class HomeRoot : Routes.Route() {
</a>                         containerColor = MaterialTheme.colorScheme.surfaceVariant,
                         contentColor = MaterialTheme.colorScheme.onSurfaceVariant
                     )
<a href="#h24-5-3" id="h24-5-3" class="d">-                ){
</a><a href="#h24-5-4" id="h24-5-4" class="i">+                ) {
</a>                     Row(
                         modifier = Modifier
                             .fillMaxWidth()
<a href="#h24-6" id="h24-6" class="h">@@ -223,17 +219,16 @@ class HomeRoot : Routes.Route() {
</a>                                 fontWeight = FontWeight.Bold,
                             )
                             Text(
<a href="#h24-6-3" id="h24-6-3" class="d">-                                fontSize = 12.sp,
</a><a href="#h24-6-4" id="h24-6-4" class="d">-                                text = translation.format(&quot;update_content&quot;, &quot;version&quot; to (latestUpdate?.versionName ?: &quot;unknown&quot;)),
</a><a href="#h24-6-5" id="h24-6-5" class="d">-                                lineHeight = 20.sp
</a><a href="#h24-6-6" id="h24-6-6" class="i">+                                fontSize = 12.sp, text = translation.format(
</a><a href="#h24-6-7" id="h24-6-7" class="i">+                                    &quot;update_content&quot;,
</a><a href="#h24-6-8" id="h24-6-8" class="i">+                                    &quot;version&quot; to (latestUpdate?.versionName ?: &quot;unknown&quot;)
</a><a href="#h24-6-9" id="h24-6-9" class="i">+                                ), lineHeight = 20.sp
</a>                             )
                         }
                         Button(onClick = {
<a href="#h24-6-13" id="h24-6-13" class="d">-                            context.activity?.startActivity(
</a><a href="#h24-6-14" id="h24-6-14" class="d">-                                Intent(Intent.ACTION_VIEW).apply {
</a><a href="#h24-6-15" id="h24-6-15" class="d">-                                    data = Uri.parse(latestUpdate?.releaseUrl)
</a><a href="#h24-6-16" id="h24-6-16" class="d">-                                }
</a><a href="#h24-6-17" id="h24-6-17" class="d">-                            )
</a><a href="#h24-6-18" id="h24-6-18" class="i">+                            context.activity?.startActivity(Intent(Intent.ACTION_VIEW).apply {
</a><a href="#h24-6-19" id="h24-6-19" class="i">+                                data = Uri.parse(latestUpdate?.releaseUrl)
</a><a href="#h24-6-20" id="h24-6-20" class="i">+                            })
</a>                         }, modifier = Modifier.height(40.dp)) {
                             Text(text = translation[&quot;update_button&quot;])
                         }
<a href="#h24-7" id="h24-7" class="h">@@ -241,38 +236,93 @@ class HomeRoot : Routes.Route() {
</a>                 }
             }
 
<a href="#h24-7-3" id="h24-7-3" class="d">-            val coroutineScope = rememberCoroutineScope()
</a><a href="#h24-7-4" id="h24-7-4" class="d">-            var installationSummary by remember { mutableStateOf(null as InstallationSummary?) }
</a><a href="#h24-7-5" id="h24-7-5" class="i">+            var showQuickActionsMenu by remember { mutableStateOf(false) }
</a> 
<a href="#h24-7-7" id="h24-7-7" class="d">-            fun updateInstallationSummary(scope: CoroutineScope) {
</a><a href="#h24-7-8" id="h24-7-8" class="d">-                scope.launch(Dispatchers.IO) {
</a><a href="#h24-7-9" id="h24-7-9" class="d">-                    runCatching {
</a><a href="#h24-7-10" id="h24-7-10" class="d">-                        installationSummary = context.installationSummary
</a><a href="#h24-7-11" id="h24-7-11" class="d">-                    }.onFailure {
</a><a href="#h24-7-12" id="h24-7-12" class="d">-                        context.longToast(&quot;SnapEnhance failed to load installation summary: ${it.message}&quot;)
</a><a href="#h24-7-13" id="h24-7-13" class="i">+            Row(
</a><a href="#h24-7-14" id="h24-7-14" class="i">+                modifier = Modifier
</a><a href="#h24-7-15" id="h24-7-15" class="i">+                    .fillMaxWidth()
</a><a href="#h24-7-16" id="h24-7-16" class="i">+                    .padding(start = 20.dp, end = 30.dp, top = 20.dp),
</a><a href="#h24-7-17" id="h24-7-17" class="i">+                verticalAlignment = Alignment.CenterVertically
</a><a href="#h24-7-18" id="h24-7-18" class="i">+            ) {
</a><a href="#h24-7-19" id="h24-7-19" class="i">+                Text(&quot;Quick Actions&quot;, fontSize = 20.sp, modifier = Modifier.weight(1f))
</a><a href="#h24-7-20" id="h24-7-20" class="i">+                Box {
</a><a href="#h24-7-21" id="h24-7-21" class="i">+                    IconButton(
</a><a href="#h24-7-22" id="h24-7-22" class="i">+                        onClick = { showQuickActionsMenu = !showQuickActionsMenu },
</a><a href="#h24-7-23" id="h24-7-23" class="i">+                    ) {
</a><a href="#h24-7-24" id="h24-7-24" class="i">+                        Icon(Icons.Default.MoreVert, contentDescription = null)
</a>                     }
<a href="#h24-7-26" id="h24-7-26" class="d">-                    runCatching {
</a><a href="#h24-7-27" id="h24-7-27" class="d">-                        if (!BuildConfig.DEBUG) {
</a><a href="#h24-7-28" id="h24-7-28" class="d">-                            latestUpdate = Updater.checkForLatestRelease()
</a><a href="#h24-7-29" id="h24-7-29" class="i">+                    DropdownMenu(
</a><a href="#h24-7-30" id="h24-7-30" class="i">+                        expanded = showQuickActionsMenu,
</a><a href="#h24-7-31" id="h24-7-31" class="i">+                        onDismissRequest = { showQuickActionsMenu = false }
</a><a href="#h24-7-32" id="h24-7-32" class="i">+                    ) {
</a><a href="#h24-7-33" id="h24-7-33" class="i">+                        cards.forEach { (card, _) -&gt;
</a><a href="#h24-7-34" id="h24-7-34" class="i">+                            fun toggle(state: Boolean? = null) {
</a><a href="#h24-7-35" id="h24-7-35" class="i">+                                if (state?.let { !it } ?: selectedTiles.contains(card.first)) {
</a><a href="#h24-7-36" id="h24-7-36" class="i">+                                    selectedTiles.remove(card.first)
</a><a href="#h24-7-37" id="h24-7-37" class="i">+                                } else {
</a><a href="#h24-7-38" id="h24-7-38" class="i">+                                    selectedTiles.add(0, card.first)
</a><a href="#h24-7-39" id="h24-7-39" class="i">+                                }
</a><a href="#h24-7-40" id="h24-7-40" class="i">+                                context.coroutineScope.launch {
</a><a href="#h24-7-41" id="h24-7-41" class="i">+                                    context.database.setQuickTiles(selectedTiles)
</a><a href="#h24-7-42" id="h24-7-42" class="i">+                                }
</a><a href="#h24-7-43" id="h24-7-43" class="i">+                            }
</a><a href="#h24-7-44" id="h24-7-44" class="i">+
</a><a href="#h24-7-45" id="h24-7-45" class="i">+                            DropdownMenuItem(onClick = { toggle() }, text = {
</a><a href="#h24-7-46" id="h24-7-46" class="i">+                                Row(
</a><a href="#h24-7-47" id="h24-7-47" class="i">+                                    verticalAlignment = Alignment.CenterVertically,
</a><a href="#h24-7-48" id="h24-7-48" class="i">+                                    modifier = Modifier.padding(all = 5.dp)
</a><a href="#h24-7-49" id="h24-7-49" class="i">+                                ) {
</a><a href="#h24-7-50" id="h24-7-50" class="i">+                                    Checkbox(
</a><a href="#h24-7-51" id="h24-7-51" class="i">+                                        checked = selectedTiles.contains(card.first),
</a><a href="#h24-7-52" id="h24-7-52" class="i">+                                        onCheckedChange = {
</a><a href="#h24-7-53" id="h24-7-53" class="i">+                                            toggle(it)
</a><a href="#h24-7-54" id="h24-7-54" class="i">+                                        }
</a><a href="#h24-7-55" id="h24-7-55" class="i">+                                    )
</a><a href="#h24-7-56" id="h24-7-56" class="i">+                                    Text(text = card.first)
</a><a href="#h24-7-57" id="h24-7-57" class="i">+                                }
</a><a href="#h24-7-58" id="h24-7-58" class="i">+                            })
</a>                         }
<a href="#h24-7-60" id="h24-7-60" class="d">-                    }.onFailure {
</a><a href="#h24-7-61" id="h24-7-61" class="d">-                        context.longToast(&quot;SnapEnhance failed to check for updates: ${it.message}&quot;)
</a>                     }
                 }
<a href="#h24-7-64" id="h24-7-64" class="d">-            }
</a> 
<a href="#h24-7-66" id="h24-7-66" class="d">-            OnLifecycleEvent { _, event -&gt;
</a><a href="#h24-7-67" id="h24-7-67" class="d">-                if (event == Lifecycle.Event.ON_RESUME) {
</a><a href="#h24-7-68" id="h24-7-68" class="d">-                    updateInstallationSummary(coroutineScope)
</a><a href="#h24-7-69" id="h24-7-69" class="d">-                }
</a>             }
 
<a href="#h24-7-72" id="h24-7-72" class="d">-            LaunchedEffect(Unit) {
</a><a href="#h24-7-73" id="h24-7-73" class="d">-                updateInstallationSummary(coroutineScope)
</a><a href="#h24-7-74" id="h24-7-74" class="i">+            FlowRow(
</a><a href="#h24-7-75" id="h24-7-75" class="i">+                modifier = Modifier
</a><a href="#h24-7-76" id="h24-7-76" class="i">+                    .padding(all = cardMargin)
</a><a href="#h24-7-77" id="h24-7-77" class="i">+                    .fillMaxWidth(),
</a><a href="#h24-7-78" id="h24-7-78" class="i">+                horizontalArrangement = Arrangement.SpaceEvenly,
</a><a href="#h24-7-79" id="h24-7-79" class="i">+            ) {
</a><a href="#h24-7-80" id="h24-7-80" class="i">+                remember(selectedTiles.size, context.translation.loadedLocale) { selectedTiles.mapNotNull {
</a><a href="#h24-7-81" id="h24-7-81" class="i">+                    cards.entries.find { entry -&gt; entry.key.first == it }
</a><a href="#h24-7-82" id="h24-7-82" class="i">+                } }.forEach { (card, action) -&gt;
</a><a href="#h24-7-83" id="h24-7-83" class="i">+                    ElevatedCard(
</a><a href="#h24-7-84" id="h24-7-84" class="i">+                        modifier = Modifier
</a><a href="#h24-7-85" id="h24-7-85" class="i">+                            .size(105.dp)
</a><a href="#h24-7-86" id="h24-7-86" class="i">+                            .weight(1f)
</a><a href="#h24-7-87" id="h24-7-87" class="i">+                            .clickable { action() }
</a><a href="#h24-7-88" id="h24-7-88" class="i">+                            .padding(all = 6.dp),
</a><a href="#h24-7-89" id="h24-7-89" class="i">+                    ) {
</a><a href="#h24-7-90" id="h24-7-90" class="i">+                        Column(
</a><a href="#h24-7-91" id="h24-7-91" class="i">+                            modifier = Modifier
</a><a href="#h24-7-92" id="h24-7-92" class="i">+                                .fillMaxSize()
</a><a href="#h24-7-93" id="h24-7-93" class="i">+                                .padding(all = 5.dp),
</a><a href="#h24-7-94" id="h24-7-94" class="i">+                            horizontalAlignment = Alignment.CenterHorizontally,
</a><a href="#h24-7-95" id="h24-7-95" class="i">+                            verticalArrangement = Arrangement.SpaceEvenly,
</a><a href="#h24-7-96" id="h24-7-96" class="i">+                        ) {
</a><a href="#h24-7-97" id="h24-7-97" class="i">+                            Icon(
</a><a href="#h24-7-98" id="h24-7-98" class="i">+                                imageVector = card.second, contentDescription = null,
</a><a href="#h24-7-99" id="h24-7-99" class="i">+                                tint = MaterialTheme.colorScheme.onSurfaceVariant,
</a><a href="#h24-7-100" id="h24-7-100" class="i">+                                modifier = Modifier.size(50.dp)
</a><a href="#h24-7-101" id="h24-7-101" class="i">+                            )
</a><a href="#h24-7-102" id="h24-7-102" class="i">+                            Text(
</a><a href="#h24-7-103" id="h24-7-103" class="i">+                                lineHeight = 16.sp, text = card.first, fontSize = 11.sp,
</a><a href="#h24-7-104" id="h24-7-104" class="i">+                                textAlign = TextAlign.Center
</a><a href="#h24-7-105" id="h24-7-105" class="i">+                            )
</a><a href="#h24-7-106" id="h24-7-106" class="i">+                        }
</a><a href="#h24-7-107" id="h24-7-107" class="i">+                    }
</a><a href="#h24-7-108" id="h24-7-108" class="i">+                }
</a>             }
<a href="#h24-7-110" id="h24-7-110" class="d">-
</a><a href="#h24-7-111" id="h24-7-111" class="d">-            Spacer(modifier = Modifier.height(20.dp))
</a><a href="#h24-7-112" id="h24-7-112" class="d">-            installationSummary?.let { SummaryCards(installationSummary = it) }
</a>         }
     }
<a href="#h24-7-115" id="h24-7-115" class="d">-}</a><a href="#h24-7-116" id="h24-7-116" class="d">-
\ No newline at end of file
</a><a href="#h24-7-117" id="h24-7-117" class="i">+}
</a><b>diff --git a/<a id="h25" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/home/HomeSettings.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/home/HomeSettings.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/home/HomeSettings.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/home/HomeSettings.kt</a></b>
<a href="#h25-0" id="h25-0" class="h">@@ -18,10 +18,12 @@ import androidx.compose.ui.window.Dialog
</a> import androidx.core.net.toUri
 import androidx.navigation.NavBackStackEntry
 import kotlinx.coroutines.Dispatchers
<a href="#h25-0-3" id="h25-0-3" class="i">+import kotlinx.coroutines.launch
</a> import kotlinx.coroutines.withContext
 import me.rhunk.snapenhance.common.Constants
 import me.rhunk.snapenhance.common.action.EnumAction
 import me.rhunk.snapenhance.common.bridge.types.BridgeFileType
<a href="#h25-0-8" id="h25-0-8" class="i">+import me.rhunk.snapenhance.common.ui.rememberAsyncMutableState
</a> import me.rhunk.snapenhance.ui.manager.Routes
 import me.rhunk.snapenhance.ui.setup.Requirements
 import me.rhunk.snapenhance.ui.util.ActivityLauncherHelper
<a href="#h25-1" id="h25-1" class="h">@@ -165,13 +167,11 @@ class HomeSettings : Routes.Route() {
</a>                 Column(
                     verticalArrangement = Arrangement.spacedBy(4.dp),
                 ) {
<a href="#h25-1-3" id="h25-1-3" class="d">-                    var storedMessagesCount by remember { mutableIntStateOf(0) }
</a><a href="#h25-1-4" id="h25-1-4" class="d">-                    var storedStoriesCount by remember { mutableIntStateOf(0) }
</a><a href="#h25-1-5" id="h25-1-5" class="d">-                    LaunchedEffect(Unit) {
</a><a href="#h25-1-6" id="h25-1-6" class="d">-                        withContext(Dispatchers.IO) {
</a><a href="#h25-1-7" id="h25-1-7" class="d">-                            storedMessagesCount = context.messageLogger.getStoredMessageCount()
</a><a href="#h25-1-8" id="h25-1-8" class="d">-                            storedStoriesCount = context.messageLogger.getStoredStoriesCount()
</a><a href="#h25-1-9" id="h25-1-9" class="d">-                        }
</a><a href="#h25-1-10" id="h25-1-10" class="i">+                    var storedMessagesCount by rememberAsyncMutableState(defaultValue = 0) {
</a><a href="#h25-1-11" id="h25-1-11" class="i">+                        context.messageLogger.getStoredMessageCount()
</a><a href="#h25-1-12" id="h25-1-12" class="i">+                    }
</a><a href="#h25-1-13" id="h25-1-13" class="i">+                    var storedStoriesCount by rememberAsyncMutableState(defaultValue = 0) {
</a><a href="#h25-1-14" id="h25-1-14" class="i">+                        context.messageLogger.getStoredStoriesCount()
</a>                     }
                     Row(
                         horizontalArrangement = Arrangement.spacedBy(10.dp),
<a href="#h25-2" id="h25-2" class="h">@@ -273,7 +273,9 @@ class HomeSettings : Routes.Route() {
</a>                 }
                 Button(onClick = {
                     runCatching {
<a href="#h25-2-3" id="h25-2-3" class="d">-                        selectedFileType.resolve(context.androidContext).delete()
</a><a href="#h25-2-4" id="h25-2-4" class="i">+                        context.coroutineScope.launch {
</a><a href="#h25-2-5" id="h25-2-5" class="i">+                            selectedFileType.resolve(context.androidContext).delete()
</a><a href="#h25-2-6" id="h25-2-6" class="i">+                        }
</a>                     }.onFailure {
                         context.log.error(&quot;Failed to clear file&quot;, it)
                         context.longToast(&quot;Failed to clear file! ${it.localizedMessage}&quot;)
<b>diff --git a/<a id="h26" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/scripting/ScriptingRoot.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/scripting/ScriptingRoot.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/scripting/ScriptingRoot.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/scripting/ScriptingRoot.kt</a></b>
<a href="#h26-0" id="h26-0" class="h">@@ -6,17 +6,21 @@ import androidx.compose.foundation.layout.*
</a> import androidx.compose.foundation.lazy.LazyColumn
 import androidx.compose.material.icons.Icons
 import androidx.compose.material.icons.automirrored.filled.LibraryBooks
<a href="#h26-0-3" id="h26-0-3" class="d">-import androidx.compose.material.icons.filled.FolderOpen
</a><a href="#h26-0-4" id="h26-0-4" class="d">-import androidx.compose.material.icons.filled.Link
</a><a href="#h26-0-5" id="h26-0-5" class="d">-import androidx.compose.material.icons.filled.Settings
</a><a href="#h26-0-6" id="h26-0-6" class="i">+import androidx.compose.material.icons.filled.*
</a> import androidx.compose.material3.*
 import androidx.compose.runtime.*
 import androidx.compose.ui.Alignment
 import androidx.compose.ui.Modifier
<a href="#h26-0-11" id="h26-0-11" class="i">+import androidx.compose.ui.focus.FocusRequester
</a><a href="#h26-0-12" id="h26-0-12" class="i">+import androidx.compose.ui.focus.focusRequester
</a><a href="#h26-0-13" id="h26-0-13" class="i">+import androidx.compose.ui.graphics.vector.ImageVector
</a><a href="#h26-0-14" id="h26-0-14" class="i">+import androidx.compose.ui.layout.onGloballyPositioned
</a><a href="#h26-0-15" id="h26-0-15" class="i">+import androidx.compose.ui.text.font.FontStyle
</a><a href="#h26-0-16" id="h26-0-16" class="i">+import androidx.compose.ui.text.font.FontWeight
</a><a href="#h26-0-17" id="h26-0-17" class="i">+import androidx.compose.ui.text.style.TextAlign
</a> import androidx.compose.ui.unit.dp
 import androidx.compose.ui.unit.sp
 import androidx.core.net.toUri
<a href="#h26-0-21" id="h26-0-21" class="d">-import androidx.documentfile.provider.DocumentFile
</a> import androidx.navigation.NavBackStackEntry
 import kotlinx.coroutines.Dispatchers
 import kotlinx.coroutines.delay
<a href="#h26-1" id="h26-1" class="h">@@ -26,8 +30,14 @@ import me.rhunk.snapenhance.common.scripting.type.ModuleInfo
</a> import me.rhunk.snapenhance.common.scripting.ui.EnumScriptInterface
 import me.rhunk.snapenhance.common.scripting.ui.InterfaceManager
 import me.rhunk.snapenhance.common.scripting.ui.ScriptInterface
<a href="#h26-1-3" id="h26-1-3" class="i">+import me.rhunk.snapenhance.common.ui.AsyncUpdateDispatcher
</a><a href="#h26-1-4" id="h26-1-4" class="i">+import me.rhunk.snapenhance.common.ui.rememberAsyncMutableState
</a><a href="#h26-1-5" id="h26-1-5" class="i">+import me.rhunk.snapenhance.storage.getScripts
</a><a href="#h26-1-6" id="h26-1-6" class="i">+import me.rhunk.snapenhance.storage.isScriptEnabled
</a><a href="#h26-1-7" id="h26-1-7" class="i">+import me.rhunk.snapenhance.storage.setScriptEnabled
</a> import me.rhunk.snapenhance.ui.manager.Routes
 import me.rhunk.snapenhance.ui.util.ActivityLauncherHelper
<a href="#h26-1-10" id="h26-1-10" class="i">+import me.rhunk.snapenhance.ui.util.Dialog
</a> import me.rhunk.snapenhance.ui.util.chooseFolder
 import me.rhunk.snapenhance.ui.util.pullrefresh.PullRefreshIndicator
 import me.rhunk.snapenhance.ui.util.pullrefresh.pullRefresh
<a href="#h26-2" id="h26-2" class="h">@@ -35,19 +45,213 @@ import me.rhunk.snapenhance.ui.util.pullrefresh.rememberPullRefreshState
</a> 
 class ScriptingRoot : Routes.Route() {
     private lateinit var activityLauncherHelper: ActivityLauncherHelper
<a href="#h26-2-3" id="h26-2-3" class="i">+    private val reloadDispatcher = AsyncUpdateDispatcher(updateOnFirstComposition = false)
</a> 
     override val init: () -&gt; Unit = {
         activityLauncherHelper = ActivityLauncherHelper(context.activity!!)
     }
 
     @Composable
<a href="#h26-2-10" id="h26-2-10" class="i">+    private fun ImportRemoteScript(
</a><a href="#h26-2-11" id="h26-2-11" class="i">+        dismiss: () -&gt; Unit
</a><a href="#h26-2-12" id="h26-2-12" class="i">+    ) {
</a><a href="#h26-2-13" id="h26-2-13" class="i">+        Dialog(onDismissRequest = dismiss) {
</a><a href="#h26-2-14" id="h26-2-14" class="i">+            var url by remember { mutableStateOf(&quot;&quot;) }
</a><a href="#h26-2-15" id="h26-2-15" class="i">+            val focusRequester = remember { FocusRequester() }
</a><a href="#h26-2-16" id="h26-2-16" class="i">+            var isLoading by remember {
</a><a href="#h26-2-17" id="h26-2-17" class="i">+                mutableStateOf(false)
</a><a href="#h26-2-18" id="h26-2-18" class="i">+            }
</a><a href="#h26-2-19" id="h26-2-19" class="i">+            ElevatedCard(
</a><a href="#h26-2-20" id="h26-2-20" class="i">+                modifier = Modifier
</a><a href="#h26-2-21" id="h26-2-21" class="i">+                    .fillMaxWidth(),
</a><a href="#h26-2-22" id="h26-2-22" class="i">+            ) {
</a><a href="#h26-2-23" id="h26-2-23" class="i">+                Column(
</a><a href="#h26-2-24" id="h26-2-24" class="i">+                    modifier = Modifier
</a><a href="#h26-2-25" id="h26-2-25" class="i">+                        .fillMaxWidth()
</a><a href="#h26-2-26" id="h26-2-26" class="i">+                        .padding(16.dp),
</a><a href="#h26-2-27" id="h26-2-27" class="i">+                    horizontalAlignment = Alignment.CenterHorizontally
</a><a href="#h26-2-28" id="h26-2-28" class="i">+                ) {
</a><a href="#h26-2-29" id="h26-2-29" class="i">+                    Text(
</a><a href="#h26-2-30" id="h26-2-30" class="i">+                        text = &quot;Import Script from URL&quot;,
</a><a href="#h26-2-31" id="h26-2-31" class="i">+                        fontSize = 22.sp,
</a><a href="#h26-2-32" id="h26-2-32" class="i">+                        fontWeight = FontWeight.Bold,
</a><a href="#h26-2-33" id="h26-2-33" class="i">+                        modifier = Modifier.padding(8.dp),
</a><a href="#h26-2-34" id="h26-2-34" class="i">+                    )
</a><a href="#h26-2-35" id="h26-2-35" class="i">+                    Text(
</a><a href="#h26-2-36" id="h26-2-36" class="i">+                        text = &quot;Warning: Imported scripts can be harmful to your device. Only import scripts from trusted sources.&quot;,
</a><a href="#h26-2-37" id="h26-2-37" class="i">+                        fontSize = 14.sp,
</a><a href="#h26-2-38" id="h26-2-38" class="i">+                        fontWeight = FontWeight.Light,
</a><a href="#h26-2-39" id="h26-2-39" class="i">+                        fontStyle = FontStyle.Italic,
</a><a href="#h26-2-40" id="h26-2-40" class="i">+                        modifier = Modifier.padding(8.dp),
</a><a href="#h26-2-41" id="h26-2-41" class="i">+                        textAlign = TextAlign.Center,
</a><a href="#h26-2-42" id="h26-2-42" class="i">+                    )
</a><a href="#h26-2-43" id="h26-2-43" class="i">+                    TextField(
</a><a href="#h26-2-44" id="h26-2-44" class="i">+                        value = url,
</a><a href="#h26-2-45" id="h26-2-45" class="i">+                        onValueChange = {
</a><a href="#h26-2-46" id="h26-2-46" class="i">+                            url = it
</a><a href="#h26-2-47" id="h26-2-47" class="i">+                        },
</a><a href="#h26-2-48" id="h26-2-48" class="i">+                        label = {
</a><a href="#h26-2-49" id="h26-2-49" class="i">+                            Text(text = &quot;Enter URL here:&quot;)
</a><a href="#h26-2-50" id="h26-2-50" class="i">+                        },
</a><a href="#h26-2-51" id="h26-2-51" class="i">+                        modifier = Modifier
</a><a href="#h26-2-52" id="h26-2-52" class="i">+                            .fillMaxWidth()
</a><a href="#h26-2-53" id="h26-2-53" class="i">+                            .focusRequester(focusRequester)
</a><a href="#h26-2-54" id="h26-2-54" class="i">+                            .onGloballyPositioned {
</a><a href="#h26-2-55" id="h26-2-55" class="i">+                                focusRequester.requestFocus()
</a><a href="#h26-2-56" id="h26-2-56" class="i">+                            }
</a><a href="#h26-2-57" id="h26-2-57" class="i">+                    )
</a><a href="#h26-2-58" id="h26-2-58" class="i">+                    Spacer(modifier = Modifier.height(8.dp))
</a><a href="#h26-2-59" id="h26-2-59" class="i">+                    Button(
</a><a href="#h26-2-60" id="h26-2-60" class="i">+                        enabled = url.isNotBlank(),
</a><a href="#h26-2-61" id="h26-2-61" class="i">+                        onClick = {
</a><a href="#h26-2-62" id="h26-2-62" class="i">+                            isLoading = true
</a><a href="#h26-2-63" id="h26-2-63" class="i">+                            context.coroutineScope.launch {
</a><a href="#h26-2-64" id="h26-2-64" class="i">+                                runCatching {
</a><a href="#h26-2-65" id="h26-2-65" class="i">+                                    val moduleInfo = context.scriptManager.importFromUrl(url)
</a><a href="#h26-2-66" id="h26-2-66" class="i">+                                    context.shortToast(&quot;Script ${moduleInfo.name} imported!&quot;)
</a><a href="#h26-2-67" id="h26-2-67" class="i">+                                    reloadDispatcher.dispatch()
</a><a href="#h26-2-68" id="h26-2-68" class="i">+                                    withContext(Dispatchers.Main) {
</a><a href="#h26-2-69" id="h26-2-69" class="i">+                                        dismiss()
</a><a href="#h26-2-70" id="h26-2-70" class="i">+                                    }
</a><a href="#h26-2-71" id="h26-2-71" class="i">+                                    return@launch
</a><a href="#h26-2-72" id="h26-2-72" class="i">+                                }.onFailure {
</a><a href="#h26-2-73" id="h26-2-73" class="i">+                                    context.log.error(&quot;Failed to import script&quot;, it)
</a><a href="#h26-2-74" id="h26-2-74" class="i">+                                    context.shortToast(&quot;Failed to import script. ${it.message}. Check logs for more details&quot;)
</a><a href="#h26-2-75" id="h26-2-75" class="i">+                                }
</a><a href="#h26-2-76" id="h26-2-76" class="i">+                                isLoading = false
</a><a href="#h26-2-77" id="h26-2-77" class="i">+                            }
</a><a href="#h26-2-78" id="h26-2-78" class="i">+                        },
</a><a href="#h26-2-79" id="h26-2-79" class="i">+                    ) {
</a><a href="#h26-2-80" id="h26-2-80" class="i">+                        if (isLoading) {
</a><a href="#h26-2-81" id="h26-2-81" class="i">+                            CircularProgressIndicator(
</a><a href="#h26-2-82" id="h26-2-82" class="i">+                                modifier = Modifier
</a><a href="#h26-2-83" id="h26-2-83" class="i">+                                    .size(30.dp),
</a><a href="#h26-2-84" id="h26-2-84" class="i">+                                strokeWidth = 3.dp,
</a><a href="#h26-2-85" id="h26-2-85" class="i">+                                color = MaterialTheme.colorScheme.onPrimary
</a><a href="#h26-2-86" id="h26-2-86" class="i">+                            )
</a><a href="#h26-2-87" id="h26-2-87" class="i">+                        } else {
</a><a href="#h26-2-88" id="h26-2-88" class="i">+                            Text(text = &quot;Import&quot;)
</a><a href="#h26-2-89" id="h26-2-89" class="i">+                        }
</a><a href="#h26-2-90" id="h26-2-90" class="i">+                    }
</a><a href="#h26-2-91" id="h26-2-91" class="i">+                }
</a><a href="#h26-2-92" id="h26-2-92" class="i">+            }
</a><a href="#h26-2-93" id="h26-2-93" class="i">+        }
</a><a href="#h26-2-94" id="h26-2-94" class="i">+    }
</a><a href="#h26-2-95" id="h26-2-95" class="i">+
</a><a href="#h26-2-96" id="h26-2-96" class="i">+
</a><a href="#h26-2-97" id="h26-2-97" class="i">+    @Composable
</a><a href="#h26-2-98" id="h26-2-98" class="i">+    private fun ModuleActions(
</a><a href="#h26-2-99" id="h26-2-99" class="i">+        script: ModuleInfo,
</a><a href="#h26-2-100" id="h26-2-100" class="i">+        dismiss: () -&gt; Unit
</a><a href="#h26-2-101" id="h26-2-101" class="i">+    ) {
</a><a href="#h26-2-102" id="h26-2-102" class="i">+        Dialog(
</a><a href="#h26-2-103" id="h26-2-103" class="i">+            onDismissRequest = dismiss,
</a><a href="#h26-2-104" id="h26-2-104" class="i">+        ) {
</a><a href="#h26-2-105" id="h26-2-105" class="i">+            ElevatedCard(
</a><a href="#h26-2-106" id="h26-2-106" class="i">+                modifier = Modifier
</a><a href="#h26-2-107" id="h26-2-107" class="i">+                    .fillMaxWidth()
</a><a href="#h26-2-108" id="h26-2-108" class="i">+                    .padding(2.dp),
</a><a href="#h26-2-109" id="h26-2-109" class="i">+            ) {
</a><a href="#h26-2-110" id="h26-2-110" class="i">+                val actions = remember {
</a><a href="#h26-2-111" id="h26-2-111" class="i">+                    mapOf&lt;Pair&lt;String, ImageVector&gt;, suspend () -&gt; Unit&gt;(
</a><a href="#h26-2-112" id="h26-2-112" class="i">+                        (&quot;Edit Module&quot; to Icons.Default.Edit) to {
</a><a href="#h26-2-113" id="h26-2-113" class="i">+                            runCatching {
</a><a href="#h26-2-114" id="h26-2-114" class="i">+                                val modulePath = context.scriptManager.getModulePath(script.name)!!
</a><a href="#h26-2-115" id="h26-2-115" class="i">+                                context.androidContext.startActivity(
</a><a href="#h26-2-116" id="h26-2-116" class="i">+                                    Intent(Intent.ACTION_VIEW).apply {
</a><a href="#h26-2-117" id="h26-2-117" class="i">+                                        data = context.scriptManager.getScriptsFolder()!!
</a><a href="#h26-2-118" id="h26-2-118" class="i">+                                            .findFile(modulePath)!!.uri
</a><a href="#h26-2-119" id="h26-2-119" class="i">+                                        flags =
</a><a href="#h26-2-120" id="h26-2-120" class="i">+                                            Intent.FLAG_ACTIVITY_NEW_TASK or Intent.FLAG_GRANT_READ_URI_PERMISSION or Intent.FLAG_GRANT_WRITE_URI_PERMISSION
</a><a href="#h26-2-121" id="h26-2-121" class="i">+                                    }
</a><a href="#h26-2-122" id="h26-2-122" class="i">+                                )
</a><a href="#h26-2-123" id="h26-2-123" class="i">+                                dismiss()
</a><a href="#h26-2-124" id="h26-2-124" class="i">+                            }.onFailure {
</a><a href="#h26-2-125" id="h26-2-125" class="i">+                                context.log.error(&quot;Failed to open module file&quot;, it)
</a><a href="#h26-2-126" id="h26-2-126" class="i">+                                context.shortToast(&quot;Failed to open module file. Check logs for more details&quot;)
</a><a href="#h26-2-127" id="h26-2-127" class="i">+                            }
</a><a href="#h26-2-128" id="h26-2-128" class="i">+                        },
</a><a href="#h26-2-129" id="h26-2-129" class="i">+                        (&quot;Clear Module Data&quot; to Icons.Default.Save) to {
</a><a href="#h26-2-130" id="h26-2-130" class="i">+                            runCatching {
</a><a href="#h26-2-131" id="h26-2-131" class="i">+                                context.scriptManager.getModuleDataFolder(script.name)
</a><a href="#h26-2-132" id="h26-2-132" class="i">+                                    .deleteRecursively()
</a><a href="#h26-2-133" id="h26-2-133" class="i">+                                context.shortToast(&quot;Module data cleared!&quot;)
</a><a href="#h26-2-134" id="h26-2-134" class="i">+                                dismiss()
</a><a href="#h26-2-135" id="h26-2-135" class="i">+                            }.onFailure {
</a><a href="#h26-2-136" id="h26-2-136" class="i">+                                context.log.error(&quot;Failed to clear module data&quot;, it)
</a><a href="#h26-2-137" id="h26-2-137" class="i">+                                context.shortToast(&quot;Failed to clear module data. Check logs for more details&quot;)
</a><a href="#h26-2-138" id="h26-2-138" class="i">+                            }
</a><a href="#h26-2-139" id="h26-2-139" class="i">+                        },
</a><a href="#h26-2-140" id="h26-2-140" class="i">+                        (&quot;Delete Module&quot; to Icons.Default.DeleteOutline) to {
</a><a href="#h26-2-141" id="h26-2-141" class="i">+                            context.scriptManager.apply {
</a><a href="#h26-2-142" id="h26-2-142" class="i">+                                runCatching {
</a><a href="#h26-2-143" id="h26-2-143" class="i">+                                    val modulePath = getModulePath(script.name)!!
</a><a href="#h26-2-144" id="h26-2-144" class="i">+                                    unloadScript(modulePath)
</a><a href="#h26-2-145" id="h26-2-145" class="i">+                                    getScriptsFolder()?.findFile(modulePath)?.delete()
</a><a href="#h26-2-146" id="h26-2-146" class="i">+                                    reloadDispatcher.dispatch()
</a><a href="#h26-2-147" id="h26-2-147" class="i">+                                    context.shortToast(&quot;Deleted script ${script.name}!&quot;)
</a><a href="#h26-2-148" id="h26-2-148" class="i">+                                    dismiss()
</a><a href="#h26-2-149" id="h26-2-149" class="i">+                                }.onFailure {
</a><a href="#h26-2-150" id="h26-2-150" class="i">+                                    context.log.error(&quot;Failed to delete module&quot;, it)
</a><a href="#h26-2-151" id="h26-2-151" class="i">+                                    context.shortToast(&quot;Failed to delete module. Check logs for more details&quot;)
</a><a href="#h26-2-152" id="h26-2-152" class="i">+                                }
</a><a href="#h26-2-153" id="h26-2-153" class="i">+                            }
</a><a href="#h26-2-154" id="h26-2-154" class="i">+                        }
</a><a href="#h26-2-155" id="h26-2-155" class="i">+                    )
</a><a href="#h26-2-156" id="h26-2-156" class="i">+                }
</a><a href="#h26-2-157" id="h26-2-157" class="i">+
</a><a href="#h26-2-158" id="h26-2-158" class="i">+                LazyColumn(
</a><a href="#h26-2-159" id="h26-2-159" class="i">+                    modifier = Modifier.fillMaxWidth()
</a><a href="#h26-2-160" id="h26-2-160" class="i">+                ) {
</a><a href="#h26-2-161" id="h26-2-161" class="i">+                    item {
</a><a href="#h26-2-162" id="h26-2-162" class="i">+                        Text(
</a><a href="#h26-2-163" id="h26-2-163" class="i">+                            text = &quot;Actions&quot;,
</a><a href="#h26-2-164" id="h26-2-164" class="i">+                            fontSize = 22.sp,
</a><a href="#h26-2-165" id="h26-2-165" class="i">+                            fontWeight = FontWeight.Bold,
</a><a href="#h26-2-166" id="h26-2-166" class="i">+                            modifier = Modifier
</a><a href="#h26-2-167" id="h26-2-167" class="i">+                                .padding(16.dp)
</a><a href="#h26-2-168" id="h26-2-168" class="i">+                                .fillMaxWidth(),
</a><a href="#h26-2-169" id="h26-2-169" class="i">+                            textAlign = TextAlign.Center,
</a><a href="#h26-2-170" id="h26-2-170" class="i">+                        )
</a><a href="#h26-2-171" id="h26-2-171" class="i">+                    }
</a><a href="#h26-2-172" id="h26-2-172" class="i">+                    items(actions.size) { index -&gt;
</a><a href="#h26-2-173" id="h26-2-173" class="i">+                        val action = actions.entries.elementAt(index)
</a><a href="#h26-2-174" id="h26-2-174" class="i">+                        ListItem(
</a><a href="#h26-2-175" id="h26-2-175" class="i">+                            modifier = Modifier
</a><a href="#h26-2-176" id="h26-2-176" class="i">+                                .clickable {
</a><a href="#h26-2-177" id="h26-2-177" class="i">+                                    context.coroutineScope.launch {
</a><a href="#h26-2-178" id="h26-2-178" class="i">+                                        action.value()
</a><a href="#h26-2-179" id="h26-2-179" class="i">+                                        dismiss()
</a><a href="#h26-2-180" id="h26-2-180" class="i">+                                    }
</a><a href="#h26-2-181" id="h26-2-181" class="i">+                                }
</a><a href="#h26-2-182" id="h26-2-182" class="i">+                                .fillMaxWidth(),
</a><a href="#h26-2-183" id="h26-2-183" class="i">+                            leadingContent = {
</a><a href="#h26-2-184" id="h26-2-184" class="i">+                                Icon(
</a><a href="#h26-2-185" id="h26-2-185" class="i">+                                    imageVector = action.key.second,
</a><a href="#h26-2-186" id="h26-2-186" class="i">+                                    contentDescription = action.key.first
</a><a href="#h26-2-187" id="h26-2-187" class="i">+                                )
</a><a href="#h26-2-188" id="h26-2-188" class="i">+                            },
</a><a href="#h26-2-189" id="h26-2-189" class="i">+                            headlineContent = {
</a><a href="#h26-2-190" id="h26-2-190" class="i">+                                Text(text = action.key.first)
</a><a href="#h26-2-191" id="h26-2-191" class="i">+                            },
</a><a href="#h26-2-192" id="h26-2-192" class="i">+                        )
</a><a href="#h26-2-193" id="h26-2-193" class="i">+                    }
</a><a href="#h26-2-194" id="h26-2-194" class="i">+                }
</a><a href="#h26-2-195" id="h26-2-195" class="i">+            }
</a><a href="#h26-2-196" id="h26-2-196" class="i">+        }
</a><a href="#h26-2-197" id="h26-2-197" class="i">+    }
</a><a href="#h26-2-198" id="h26-2-198" class="i">+
</a><a href="#h26-2-199" id="h26-2-199" class="i">+    @Composable
</a>     fun ModuleItem(script: ModuleInfo) {
<a href="#h26-2-201" id="h26-2-201" class="d">-        var enabled by remember {
</a><a href="#h26-2-202" id="h26-2-202" class="d">-            mutableStateOf(context.modDatabase.isScriptEnabled(script.name))
</a><a href="#h26-2-203" id="h26-2-203" class="i">+        var enabled by rememberAsyncMutableState(defaultValue = false) {
</a><a href="#h26-2-204" id="h26-2-204" class="i">+            context.database.isScriptEnabled(script.name)
</a>         }
         var openSettings by remember {
             mutableStateOf(false)
         }
<a href="#h26-2-209" id="h26-2-209" class="i">+        var openActions by remember {
</a><a href="#h26-2-210" id="h26-2-210" class="i">+            mutableStateOf(false)
</a><a href="#h26-2-211" id="h26-2-211" class="i">+        }
</a> 
         Card(
             modifier = Modifier
<a href="#h26-3" id="h26-3" class="h">@@ -59,43 +263,64 @@ class ScriptingRoot : Routes.Route() {
</a>                 modifier = Modifier
                     .fillMaxWidth()
                     .clickable {
<a href="#h26-3-3" id="h26-3-3" class="i">+                        if (!enabled) return@clickable
</a>                         openSettings = !openSettings
                     }
                     .padding(8.dp),
                 verticalAlignment = Alignment.CenterVertically
             ) {
<a href="#h26-3-9" id="h26-3-9" class="i">+                if (enabled) {
</a><a href="#h26-3-10" id="h26-3-10" class="i">+                    Icon(
</a><a href="#h26-3-11" id="h26-3-11" class="i">+                        imageVector = if (openSettings) Icons.Default.ExpandLess else Icons.Default.ExpandMore,
</a><a href="#h26-3-12" id="h26-3-12" class="i">+                        contentDescription = null,
</a><a href="#h26-3-13" id="h26-3-13" class="i">+                        modifier = Modifier
</a><a href="#h26-3-14" id="h26-3-14" class="i">+                            .padding(end = 8.dp)
</a><a href="#h26-3-15" id="h26-3-15" class="i">+                            .size(32.dp),
</a><a href="#h26-3-16" id="h26-3-16" class="i">+                    )
</a><a href="#h26-3-17" id="h26-3-17" class="i">+                }
</a><a href="#h26-3-18" id="h26-3-18" class="i">+
</a>                 Column(
                     modifier = Modifier
                         .weight(1f)
                         .padding(end = 8.dp)
                 ) {
<a href="#h26-3-24" id="h26-3-24" class="d">-                    Text(text = script.displayName ?: script.name, fontSize = 20.sp,)
</a><a href="#h26-3-25" id="h26-3-25" class="d">-                    Text(text = script.description ?: &quot;No description&quot;, fontSize = 14.sp,)
</a><a href="#h26-3-26" id="h26-3-26" class="i">+                    Text(text = script.displayName ?: script.name, fontSize = 20.sp)
</a><a href="#h26-3-27" id="h26-3-27" class="i">+                    Text(text = script.description ?: &quot;No description&quot;, fontSize = 14.sp)
</a>                 }
<a href="#h26-3-29" id="h26-3-29" class="d">-                IconButton(onClick = { openSettings = !openSettings }) {
</a><a href="#h26-3-30" id="h26-3-30" class="d">-                    Icon(imageVector = Icons.Default.Settings, contentDescription = &quot;Settings&quot;,)
</a><a href="#h26-3-31" id="h26-3-31" class="i">+                IconButton(onClick = {
</a><a href="#h26-3-32" id="h26-3-32" class="i">+                    openActions = !openActions
</a><a href="#h26-3-33" id="h26-3-33" class="i">+                }) {
</a><a href="#h26-3-34" id="h26-3-34" class="i">+                    Icon(imageVector = Icons.Default.Build, contentDescription = &quot;Actions&quot;)
</a>                 }
                 Switch(
                     checked = enabled,
                     onCheckedChange = { isChecked -&gt;
<a href="#h26-3-39" id="h26-3-39" class="d">-                        context.modDatabase.setScriptEnabled(script.name, isChecked)
</a><a href="#h26-3-40" id="h26-3-40" class="d">-                        enabled = isChecked
</a><a href="#h26-3-41" id="h26-3-41" class="d">-                        runCatching {
</a><a href="#h26-3-42" id="h26-3-42" class="d">-                            val modulePath = context.scriptManager.getModulePath(script.name)!!
</a><a href="#h26-3-43" id="h26-3-43" class="d">-                            context.scriptManager.unloadScript(modulePath)
</a><a href="#h26-3-44" id="h26-3-44" class="d">-                            if (isChecked) {
</a><a href="#h26-3-45" id="h26-3-45" class="d">-                                context.scriptManager.loadScript(modulePath)
</a><a href="#h26-3-46" id="h26-3-46" class="d">-                                context.scriptManager.runtime.getModuleByName(script.name)
</a><a href="#h26-3-47" id="h26-3-47" class="d">-                                    ?.callFunction(&quot;module.onSnapEnhanceLoad&quot;)
</a><a href="#h26-3-48" id="h26-3-48" class="d">-                                context.shortToast(&quot;Loaded script ${script.name}&quot;)
</a><a href="#h26-3-49" id="h26-3-49" class="d">-                            } else {
</a><a href="#h26-3-50" id="h26-3-50" class="d">-                                context.shortToast(&quot;Unloaded script ${script.name}&quot;)
</a><a href="#h26-3-51" id="h26-3-51" class="d">-                            }
</a><a href="#h26-3-52" id="h26-3-52" class="d">-                        }.onFailure { throwable -&gt;
</a><a href="#h26-3-53" id="h26-3-53" class="d">-                            enabled = !isChecked
</a><a href="#h26-3-54" id="h26-3-54" class="d">-                            (&quot;Failed to ${if (isChecked) &quot;enable&quot; else &quot;disable&quot;} script&quot;).let {
</a><a href="#h26-3-55" id="h26-3-55" class="d">-                                context.log.error(it, throwable)
</a><a href="#h26-3-56" id="h26-3-56" class="d">-                                context.shortToast(it)
</a><a href="#h26-3-57" id="h26-3-57" class="i">+                        openSettings = false
</a><a href="#h26-3-58" id="h26-3-58" class="i">+                        context.coroutineScope.launch(Dispatchers.IO) {
</a><a href="#h26-3-59" id="h26-3-59" class="i">+                            runCatching {
</a><a href="#h26-3-60" id="h26-3-60" class="i">+                                val modulePath = context.scriptManager.getModulePath(script.name)!!
</a><a href="#h26-3-61" id="h26-3-61" class="i">+                                context.scriptManager.unloadScript(modulePath)
</a><a href="#h26-3-62" id="h26-3-62" class="i">+                                if (isChecked) {
</a><a href="#h26-3-63" id="h26-3-63" class="i">+                                    context.scriptManager.loadScript(modulePath)
</a><a href="#h26-3-64" id="h26-3-64" class="i">+                                    context.scriptManager.runtime.getModuleByName(script.name)
</a><a href="#h26-3-65" id="h26-3-65" class="i">+                                        ?.callFunction(&quot;module.onSnapEnhanceLoad&quot;)
</a><a href="#h26-3-66" id="h26-3-66" class="i">+                                    context.shortToast(&quot;Loaded script ${script.name}&quot;)
</a><a href="#h26-3-67" id="h26-3-67" class="i">+                                } else {
</a><a href="#h26-3-68" id="h26-3-68" class="i">+                                    context.shortToast(&quot;Unloaded script ${script.name}&quot;)
</a><a href="#h26-3-69" id="h26-3-69" class="i">+                                }
</a><a href="#h26-3-70" id="h26-3-70" class="i">+
</a><a href="#h26-3-71" id="h26-3-71" class="i">+                                context.database.setScriptEnabled(script.name, isChecked)
</a><a href="#h26-3-72" id="h26-3-72" class="i">+                                withContext(Dispatchers.Main) {
</a><a href="#h26-3-73" id="h26-3-73" class="i">+                                    enabled = isChecked
</a><a href="#h26-3-74" id="h26-3-74" class="i">+                                }
</a><a href="#h26-3-75" id="h26-3-75" class="i">+                            }.onFailure { throwable -&gt;
</a><a href="#h26-3-76" id="h26-3-76" class="i">+                                withContext(Dispatchers.Main) {
</a><a href="#h26-3-77" id="h26-3-77" class="i">+                                    enabled = !isChecked
</a><a href="#h26-3-78" id="h26-3-78" class="i">+                                }
</a><a href="#h26-3-79" id="h26-3-79" class="i">+                                (&quot;Failed to ${if (isChecked) &quot;enable&quot; else &quot;disable&quot;} script. Check logs for more details&quot;).also {
</a><a href="#h26-3-80" id="h26-3-80" class="i">+                                    context.log.error(it, throwable)
</a><a href="#h26-3-81" id="h26-3-81" class="i">+                                    context.shortToast(it)
</a><a href="#h26-3-82" id="h26-3-82" class="i">+                                }
</a>                             }
                         }
                     }
<a href="#h26-4" id="h26-4" class="h">@@ -106,18 +331,31 @@ class ScriptingRoot : Routes.Route() {
</a>                 ScriptSettings(script)
             }
         }
<a href="#h26-4-3" id="h26-4-3" class="i">+
</a><a href="#h26-4-4" id="h26-4-4" class="i">+        if (openActions) {
</a><a href="#h26-4-5" id="h26-4-5" class="i">+            ModuleActions(script) { openActions = false }
</a><a href="#h26-4-6" id="h26-4-6" class="i">+        }
</a>     }
 
     override val floatingActionButton: @Composable () -&gt; Unit = {
<a href="#h26-4-10" id="h26-4-10" class="i">+        var showImportDialog by remember {
</a><a href="#h26-4-11" id="h26-4-11" class="i">+            mutableStateOf(false)
</a><a href="#h26-4-12" id="h26-4-12" class="i">+        }
</a><a href="#h26-4-13" id="h26-4-13" class="i">+        if (showImportDialog) {
</a><a href="#h26-4-14" id="h26-4-14" class="i">+            ImportRemoteScript {
</a><a href="#h26-4-15" id="h26-4-15" class="i">+                showImportDialog = false
</a><a href="#h26-4-16" id="h26-4-16" class="i">+            }
</a><a href="#h26-4-17" id="h26-4-17" class="i">+        }
</a><a href="#h26-4-18" id="h26-4-18" class="i">+
</a>         Column(
             verticalArrangement = Arrangement.spacedBy(8.dp),
             horizontalAlignment = Alignment.End,
         ) {
             ExtendedFloatingActionButton(
                 onClick = {
<a href="#h26-4-25" id="h26-4-25" class="d">-
</a><a href="#h26-4-26" id="h26-4-26" class="i">+                    showImportDialog = true
</a>                 },
<a href="#h26-4-28" id="h26-4-28" class="d">-                icon= { Icon(imageVector = Icons.Default.Link, contentDescription = &quot;Link&quot;) },
</a><a href="#h26-4-29" id="h26-4-29" class="i">+                icon = { Icon(imageVector = Icons.Default.Link, contentDescription = &quot;Link&quot;) },
</a>                 text = {
                     Text(text = &quot;Import from URL&quot;)
                 },
<a href="#h26-5" id="h26-5" class="h">@@ -133,7 +371,12 @@ class ScriptingRoot : Routes.Route() {
</a>                         )
                     }
                 },
<a href="#h26-5-3" id="h26-5-3" class="d">-                icon= { Icon(imageVector = Icons.Default.FolderOpen, contentDescription = &quot;Folder&quot;) },
</a><a href="#h26-5-4" id="h26-5-4" class="i">+                icon = {
</a><a href="#h26-5-5" id="h26-5-5" class="i">+                    Icon(
</a><a href="#h26-5-6" id="h26-5-6" class="i">+                        imageVector = Icons.Default.FolderOpen,
</a><a href="#h26-5-7" id="h26-5-7" class="i">+                        contentDescription = &quot;Folder&quot;
</a><a href="#h26-5-8" id="h26-5-8" class="i">+                    )
</a><a href="#h26-5-9" id="h26-5-9" class="i">+                },
</a>                 text = {
                     Text(text = &quot;Open Scripts Folder&quot;)
                 },
<a href="#h26-6" id="h26-6" class="h">@@ -144,8 +387,9 @@ class ScriptingRoot : Routes.Route() {
</a> 
     @Composable
     fun ScriptSettings(script: ModuleInfo) {
<a href="#h26-6-3" id="h26-6-3" class="d">-       val settingsInterface = remember {
</a><a href="#h26-6-4" id="h26-6-4" class="d">-            val module = context.scriptManager.runtime.getModuleByName(script.name) ?: return@remember null
</a><a href="#h26-6-5" id="h26-6-5" class="i">+        val settingsInterface = remember {
</a><a href="#h26-6-6" id="h26-6-6" class="i">+            val module =
</a><a href="#h26-6-7" id="h26-6-7" class="i">+                context.scriptManager.runtime.getModuleByName(script.name) ?: return@remember null
</a>             (module.getBinding(InterfaceManager::class))?.buildInterface(EnumScriptInterface.SETTINGS)
         }
 
<a href="#h26-7" id="h26-7" class="h">@@ -155,43 +399,44 @@ class ScriptingRoot : Routes.Route() {
</a>                 style = MaterialTheme.typography.bodySmall,
                 modifier = Modifier.padding(8.dp)
             )
<a href="#h26-7-3" id="h26-7-3" class="d">-        } else  {
</a><a href="#h26-7-4" id="h26-7-4" class="i">+        } else {
</a>             ScriptInterface(interfaceBuilder = settingsInterface)
         }
     }
 
     override val content: @Composable (NavBackStackEntry) -&gt; Unit = {
<a href="#h26-7-10" id="h26-7-10" class="d">-        var scriptModules by remember { mutableStateOf(listOf&lt;ModuleInfo&gt;()) }
</a><a href="#h26-7-11" id="h26-7-11" class="d">-        var scriptingFolder by remember { mutableStateOf(null as DocumentFile?) }
</a><a href="#h26-7-12" id="h26-7-12" class="i">+        val scriptingFolder by rememberAsyncMutableState(
</a><a href="#h26-7-13" id="h26-7-13" class="i">+            defaultValue = null,
</a><a href="#h26-7-14" id="h26-7-14" class="i">+            updateDispatcher = reloadDispatcher
</a><a href="#h26-7-15" id="h26-7-15" class="i">+        ) {
</a><a href="#h26-7-16" id="h26-7-16" class="i">+            context.scriptManager.getScriptsFolder()
</a><a href="#h26-7-17" id="h26-7-17" class="i">+        }
</a><a href="#h26-7-18" id="h26-7-18" class="i">+        val scriptModules by rememberAsyncMutableState(
</a><a href="#h26-7-19" id="h26-7-19" class="i">+            defaultValue = emptyList(),
</a><a href="#h26-7-20" id="h26-7-20" class="i">+            updateDispatcher = reloadDispatcher
</a><a href="#h26-7-21" id="h26-7-21" class="i">+        ) {
</a><a href="#h26-7-22" id="h26-7-22" class="i">+            context.scriptManager.sync()
</a><a href="#h26-7-23" id="h26-7-23" class="i">+            context.database.getScripts()
</a><a href="#h26-7-24" id="h26-7-24" class="i">+        }
</a><a href="#h26-7-25" id="h26-7-25" class="i">+
</a>         val coroutineScope = rememberCoroutineScope()
 
         var refreshing by remember {
             mutableStateOf(false)
         }
 
<a href="#h26-7-32" id="h26-7-32" class="d">-        fun syncScripts() {
</a><a href="#h26-7-33" id="h26-7-33" class="d">-            runCatching {
</a><a href="#h26-7-34" id="h26-7-34" class="d">-                scriptingFolder = context.scriptManager.getScriptsFolder()
</a><a href="#h26-7-35" id="h26-7-35" class="d">-                context.scriptManager.sync()
</a><a href="#h26-7-36" id="h26-7-36" class="d">-                scriptModules = context.modDatabase.getScripts()
</a><a href="#h26-7-37" id="h26-7-37" class="d">-            }.onFailure {
</a><a href="#h26-7-38" id="h26-7-38" class="d">-                context.log.error(&quot;Failed to sync scripts&quot;, it)
</a><a href="#h26-7-39" id="h26-7-39" class="d">-            }
</a><a href="#h26-7-40" id="h26-7-40" class="d">-        }
</a><a href="#h26-7-41" id="h26-7-41" class="d">-
</a>         LaunchedEffect(Unit) {
             refreshing = true
             withContext(Dispatchers.IO) {
<a href="#h26-7-45" id="h26-7-45" class="d">-                syncScripts()
</a><a href="#h26-7-46" id="h26-7-46" class="i">+                reloadDispatcher.dispatch()
</a>                 refreshing = false
             }
         }
 
         val pullRefreshState = rememberPullRefreshState(refreshing, onRefresh = {
             refreshing = true
<a href="#h26-7-53" id="h26-7-53" class="d">-            syncScripts()
</a><a href="#h26-7-54" id="h26-7-54" class="d">-            coroutineScope.launch {
</a><a href="#h26-7-55" id="h26-7-55" class="d">-                delay(300)
</a><a href="#h26-7-56" id="h26-7-56" class="i">+            coroutineScope.launch(Dispatchers.IO) {
</a><a href="#h26-7-57" id="h26-7-57" class="i">+                reloadDispatcher.dispatch()
</a>                 refreshing = false
             }
         })
<a href="#h26-8" id="h26-8" class="h">@@ -206,7 +451,7 @@ class ScriptingRoot : Routes.Route() {
</a>                 horizontalAlignment = Alignment.CenterHorizontally
             ) {
                 item {
<a href="#h26-8-3" id="h26-8-3" class="d">-                    if (scriptingFolder == null) {
</a><a href="#h26-8-4" id="h26-8-4" class="i">+                    if (scriptingFolder == null &amp;&amp; !refreshing) {
</a>                         Text(
                             text = &quot;No scripts folder selected&quot;,
                             style = MaterialTheme.typography.bodySmall,
<a href="#h26-9" id="h26-9" class="h">@@ -218,7 +463,7 @@ class ScriptingRoot : Routes.Route() {
</a>                                 context.config.root.scripting.moduleFolder.set(it)
                                 context.config.writeConfig()
                                 coroutineScope.launch {
<a href="#h26-9-3" id="h26-9-3" class="d">-                                    syncScripts()
</a><a href="#h26-9-4" id="h26-9-4" class="i">+                                    reloadDispatcher.dispatch()
</a>                                 }
                             }
                         }) {
<a href="#h26-10" id="h26-10" class="h">@@ -295,7 +540,10 @@ class ScriptingRoot : Routes.Route() {
</a>                 flags = Intent.FLAG_ACTIVITY_NEW_TASK
             })
         }) {
<a href="#h26-10-3" id="h26-10-3" class="d">-            Icon(imageVector = Icons.AutoMirrored.Default.LibraryBooks, contentDescription = &quot;Documentation&quot;)
</a><a href="#h26-10-4" id="h26-10-4" class="i">+            Icon(
</a><a href="#h26-10-5" id="h26-10-5" class="i">+                imageVector = Icons.AutoMirrored.Default.LibraryBooks,
</a><a href="#h26-10-6" id="h26-10-6" class="i">+                contentDescription = &quot;Documentation&quot;
</a><a href="#h26-10-7" id="h26-10-7" class="i">+            )
</a>         }
     }
 } 
\ No newline at end of file
<b>diff --git a/<a id="h27" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/social/AddFriendDialog.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/social/AddFriendDialog.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/social/AddFriendDialog.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/social/AddFriendDialog.kt</a></b>
<a href="#h27-0" id="h27-0" class="h">@@ -10,7 +10,6 @@ import androidx.compose.material3.*
</a> import androidx.compose.runtime.*
 import androidx.compose.ui.Alignment
 import androidx.compose.ui.Modifier
<a href="#h27-0-3" id="h27-0-3" class="d">-import androidx.compose.ui.layout.onGloballyPositioned
</a> import androidx.compose.ui.text.font.FontWeight
 import androidx.compose.ui.text.input.ImeAction
 import androidx.compose.ui.text.input.KeyboardType
<a href="#h27-1" id="h27-1" class="h">@@ -27,45 +26,74 @@ import me.rhunk.snapenhance.RemoteSideContext
</a> import me.rhunk.snapenhance.common.ReceiversConfig
 import me.rhunk.snapenhance.common.data.MessagingFriendInfo
 import me.rhunk.snapenhance.common.data.MessagingGroupInfo
<a href="#h27-1-3" id="h27-1-3" class="d">-import me.rhunk.snapenhance.common.data.SocialScope
</a><a href="#h27-1-4" id="h27-1-4" class="i">+import me.rhunk.snapenhance.common.ui.rememberAsyncMutableState
</a><a href="#h27-1-5" id="h27-1-5" class="i">+import me.rhunk.snapenhance.common.util.snap.BitmojiSelfie
</a> import me.rhunk.snapenhance.common.util.snap.SnapWidgetBroadcastReceiverHelper
<a href="#h27-1-7" id="h27-1-7" class="i">+import me.rhunk.snapenhance.ui.util.coil.BitmojiImage
</a> 
 class AddFriendDialog(
     private val context: RemoteSideContext,
<a href="#h27-1-11" id="h27-1-11" class="d">-    private val socialRoot: SocialRoot,
</a><a href="#h27-1-12" id="h27-1-12" class="i">+    private val actionHandler: Actions,
</a> ) {
<a href="#h27-1-14" id="h27-1-14" class="i">+    class Actions(
</a><a href="#h27-1-15" id="h27-1-15" class="i">+        val onFriendState: (friend: MessagingFriendInfo, state: Boolean) -&gt; Unit,
</a><a href="#h27-1-16" id="h27-1-16" class="i">+        val onGroupState: (group: MessagingGroupInfo, state: Boolean) -&gt; Unit,
</a><a href="#h27-1-17" id="h27-1-17" class="i">+        val getFriendState: (friend: MessagingFriendInfo) -&gt; Boolean,
</a><a href="#h27-1-18" id="h27-1-18" class="i">+        val getGroupState: (group: MessagingGroupInfo) -&gt; Boolean,
</a><a href="#h27-1-19" id="h27-1-19" class="i">+    )
</a> 
<a href="#h27-1-21" id="h27-1-21" class="i">+    private val stateCache = mutableMapOf&lt;String, Boolean&gt;()
</a>     private val translation by lazy { context.translation.getCategory(&quot;manager.dialogs.add_friend&quot;)}
 
     @Composable
<a href="#h27-1-25" id="h27-1-25" class="d">-    private fun ListCardEntry(name: String, getCurrentState: () -&gt; Boolean, onState: (Boolean) -&gt; Unit = {}) {
</a><a href="#h27-1-26" id="h27-1-26" class="d">-        var currentState by remember { mutableStateOf(getCurrentState()) }
</a><a href="#h27-1-27" id="h27-1-27" class="i">+    private fun ListCardEntry(
</a><a href="#h27-1-28" id="h27-1-28" class="i">+        id: String,
</a><a href="#h27-1-29" id="h27-1-29" class="i">+        bitmoji: String? = null,
</a><a href="#h27-1-30" id="h27-1-30" class="i">+        name: String,
</a><a href="#h27-1-31" id="h27-1-31" class="i">+        getCurrentState: () -&gt; Boolean,
</a><a href="#h27-1-32" id="h27-1-32" class="i">+        onState: (Boolean) -&gt; Unit = {},
</a><a href="#h27-1-33" id="h27-1-33" class="i">+    ) {
</a><a href="#h27-1-34" id="h27-1-34" class="i">+        var currentState by rememberAsyncMutableState(defaultValue = stateCache[id] ?: false) {
</a><a href="#h27-1-35" id="h27-1-35" class="i">+            getCurrentState().also { stateCache[id] = it }
</a><a href="#h27-1-36" id="h27-1-36" class="i">+        }
</a><a href="#h27-1-37" id="h27-1-37" class="i">+        val coroutineScope = rememberCoroutineScope()
</a> 
         Row(
             modifier = Modifier
                 .fillMaxWidth()
                 .clickable {
                     currentState = !currentState
<a href="#h27-1-44" id="h27-1-44" class="d">-                    onState(currentState)
</a><a href="#h27-1-45" id="h27-1-45" class="i">+                    stateCache[id] = currentState
</a><a href="#h27-1-46" id="h27-1-46" class="i">+                    coroutineScope.launch(Dispatchers.IO) {
</a><a href="#h27-1-47" id="h27-1-47" class="i">+                        onState(currentState)
</a><a href="#h27-1-48" id="h27-1-48" class="i">+                    }
</a>                 }
                 .padding(4.dp),
<a href="#h27-1-51" id="h27-1-51" class="i">+            horizontalArrangement = Arrangement.spacedBy(4.dp),
</a>             verticalAlignment = Alignment.CenterVertically
         ) {
<a href="#h27-1-54" id="h27-1-54" class="i">+            BitmojiImage(
</a><a href="#h27-1-55" id="h27-1-55" class="i">+                context = this@AddFriendDialog.context,
</a><a href="#h27-1-56" id="h27-1-56" class="i">+                url = bitmoji,
</a><a href="#h27-1-57" id="h27-1-57" class="i">+                modifier = Modifier.padding(end = 2.dp),
</a><a href="#h27-1-58" id="h27-1-58" class="i">+                size = 32,
</a><a href="#h27-1-59" id="h27-1-59" class="i">+            )
</a><a href="#h27-1-60" id="h27-1-60" class="i">+
</a>             Text(
                 text = name,
                 fontSize = 15.sp,
                 modifier = Modifier
                     .weight(1f)
<a href="#h27-1-66" id="h27-1-66" class="d">-                    .onGloballyPositioned {
</a><a href="#h27-1-67" id="h27-1-67" class="d">-                        currentState = getCurrentState()
</a><a href="#h27-1-68" id="h27-1-68" class="d">-                    }
</a>             )
 
             Checkbox(
                 checked = currentState,
                 onCheckedChange = {
                     currentState = it
<a href="#h27-1-75" id="h27-1-75" class="d">-                    onState(currentState)
</a><a href="#h27-1-76" id="h27-1-76" class="i">+                    stateCache[id] = currentState
</a><a href="#h27-1-77" id="h27-1-77" class="i">+                    coroutineScope.launch(Dispatchers.IO) {
</a><a href="#h27-1-78" id="h27-1-78" class="i">+                        onState(currentState)
</a><a href="#h27-1-79" id="h27-1-79" class="i">+                    }
</a>                 }
             )
         }
<a href="#h27-2" id="h27-2" class="h">@@ -122,7 +150,7 @@ class AddFriendDialog(
</a>         var hasFetchError by remember { mutableStateOf(false) }
 
         LaunchedEffect(Unit) {
<a href="#h27-2-3" id="h27-2-3" class="d">-            context.modDatabase.receiveMessagingDataCallback = { friends, groups -&gt;
</a><a href="#h27-2-4" id="h27-2-4" class="i">+            context.database.receiveMessagingDataCallback = { friends, groups -&gt;
</a>                 cachedFriends = friends
                 cachedGroups = groups
                 timeoutJob?.cancel()
<a href="#h27-3" id="h27-3" class="h">@@ -138,7 +166,7 @@ class AddFriendDialog(
</a>             }
             timeoutJob = coroutineScope.launch {
                 withContext(Dispatchers.IO) {
<a href="#h27-3-3" id="h27-3-3" class="d">-                    delay(10000)
</a><a href="#h27-3-4" id="h27-3-4" class="i">+                    delay(20000)
</a>                     hasFetchError = true
                 }
             }
<a href="#h27-4" id="h27-4" class="h">@@ -216,15 +244,11 @@ class AddFriendDialog(
</a>                     items(filteredGroups.size) {
                         val group = filteredGroups[it]
                         ListCardEntry(
<a href="#h27-4-3" id="h27-4-3" class="i">+                            id = group.conversationId,
</a>                             name = group.name,
<a href="#h27-4-5" id="h27-4-5" class="d">-                            getCurrentState = { context.modDatabase.getGroupInfo(group.conversationId) != null }
</a><a href="#h27-4-6" id="h27-4-6" class="i">+                            getCurrentState = { actionHandler.getGroupState(group) }
</a>                         ) { state -&gt;
<a href="#h27-4-8" id="h27-4-8" class="d">-                            if (state) {
</a><a href="#h27-4-9" id="h27-4-9" class="d">-                                context.bridgeService?.triggerScopeSync(SocialScope.GROUP, group.conversationId)
</a><a href="#h27-4-10" id="h27-4-10" class="d">-                            } else {
</a><a href="#h27-4-11" id="h27-4-11" class="d">-                                context.modDatabase.deleteGroup(group.conversationId)
</a><a href="#h27-4-12" id="h27-4-12" class="d">-                            }
</a><a href="#h27-4-13" id="h27-4-13" class="d">-                            socialRoot.updateScopeLists()
</a><a href="#h27-4-14" id="h27-4-14" class="i">+                            actionHandler.onGroupState(group, state)
</a>                         }
                     }
 
<a href="#h27-5" id="h27-5" class="h">@@ -237,19 +261,18 @@ class AddFriendDialog(
</a>                         )
                     }
 
<a href="#h27-5-3" id="h27-5-3" class="d">-                    items(filteredFriends.size) {
</a><a href="#h27-5-4" id="h27-5-4" class="d">-                        val friend = filteredFriends[it]
</a><a href="#h27-5-5" id="h27-5-5" class="i">+                    items(filteredFriends.size) { index -&gt;
</a><a href="#h27-5-6" id="h27-5-6" class="i">+                        val friend = filteredFriends[index]
</a> 
                         ListCardEntry(
<a href="#h27-5-9" id="h27-5-9" class="i">+                            id = friend.userId,
</a><a href="#h27-5-10" id="h27-5-10" class="i">+                            bitmoji = friend.takeIf { it.bitmojiId != null }?.let {
</a><a href="#h27-5-11" id="h27-5-11" class="i">+                                BitmojiSelfie.getBitmojiSelfie(it.selfieId, it.bitmojiId, BitmojiSelfie.BitmojiSelfieType.NEW_THREE_D)
</a><a href="#h27-5-12" id="h27-5-12" class="i">+                            },
</a>                             name = friend.displayName?.takeIf { name -&gt; name.isNotBlank() } ?: friend.mutableUsername,
<a href="#h27-5-14" id="h27-5-14" class="d">-                            getCurrentState = { context.modDatabase.getFriendInfo(friend.userId) != null }
</a><a href="#h27-5-15" id="h27-5-15" class="i">+                            getCurrentState = { actionHandler.getFriendState(friend) }
</a>                         ) { state -&gt;
<a href="#h27-5-17" id="h27-5-17" class="d">-                            if (state) {
</a><a href="#h27-5-18" id="h27-5-18" class="d">-                                context.bridgeService?.triggerScopeSync(SocialScope.FRIEND, friend.userId)
</a><a href="#h27-5-19" id="h27-5-19" class="d">-                            } else {
</a><a href="#h27-5-20" id="h27-5-20" class="d">-                                context.modDatabase.deleteFriend(friend.userId)
</a><a href="#h27-5-21" id="h27-5-21" class="d">-                            }
</a><a href="#h27-5-22" id="h27-5-22" class="d">-                            socialRoot.updateScopeLists()
</a><a href="#h27-5-23" id="h27-5-23" class="i">+                            actionHandler.onFriendState(friend, state)
</a>                         }
                     }
                 }
<b>diff --git a/<a id="h28" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/social/LoggedStories.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/social/LoggedStories.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/social/LoggedStories.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/social/LoggedStories.kt</a></b>
<a href="#h28-0" id="h28-0" class="h">@@ -29,10 +29,10 @@ import me.rhunk.snapenhance.common.data.StoryData
</a> import me.rhunk.snapenhance.common.data.download.*
 import me.rhunk.snapenhance.common.util.ktx.longHashCode
 import me.rhunk.snapenhance.download.DownloadProcessor
<a href="#h28-0-3" id="h28-0-3" class="i">+import me.rhunk.snapenhance.storage.getFriendInfo
</a> import me.rhunk.snapenhance.ui.manager.Routes
 import me.rhunk.snapenhance.ui.util.Dialog
 import me.rhunk.snapenhance.ui.util.coil.ImageRequestHelper
<a href="#h28-0-7" id="h28-0-7" class="d">-import okhttp3.OkHttpClient
</a> import java.io.File
 import java.text.DateFormat
 import java.util.Date
<a href="#h28-1" id="h28-1" class="h">@@ -45,7 +45,7 @@ class LoggedStories : Routes.Route() {
</a>         val userId = navBackStackEntry.arguments?.getString(&quot;id&quot;) ?: return@content
 
         val stories = remember { mutableStateListOf&lt;StoryData&gt;() }
<a href="#h28-1-3" id="h28-1-3" class="d">-        val friendInfo = remember { context.modDatabase.getFriendInfo(userId) }
</a><a href="#h28-1-4" id="h28-1-4" class="i">+        val friendInfo = remember { context.database.getFriendInfo(userId) }
</a>         var lastStoryTimestamp by remember { mutableLongStateOf(Long.MAX_VALUE) }
 
         var selectedStory by remember { mutableStateOf&lt;StoryData?&gt;(null) }
<b>diff --git a/<a id="h29" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/social/ManageScope.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/social/ManageScope.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/social/ManageScope.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/social/ManageScope.kt</a></b>
<a href="#h29-0" id="h29-0" class="h">@@ -17,13 +17,19 @@ import androidx.navigation.NavBackStackEntry
</a> import androidx.navigation.compose.currentBackStackEntryAsState
 import kotlinx.coroutines.CoroutineScope
 import kotlinx.coroutines.launch
<a href="#h29-0-3" id="h29-0-3" class="i">+import me.rhunk.snapenhance.common.data.FriendStreaks
</a><a href="#h29-0-4" id="h29-0-4" class="i">+import me.rhunk.snapenhance.common.data.MessagingFriendInfo
</a><a href="#h29-0-5" id="h29-0-5" class="i">+import me.rhunk.snapenhance.common.data.MessagingGroupInfo
</a> import me.rhunk.snapenhance.common.data.MessagingRuleType
 import me.rhunk.snapenhance.common.data.SocialScope
<a href="#h29-0-8" id="h29-0-8" class="i">+import me.rhunk.snapenhance.common.ui.rememberAsyncMutableState
</a><a href="#h29-0-9" id="h29-0-9" class="i">+import me.rhunk.snapenhance.common.ui.rememberAsyncMutableStateList
</a> import me.rhunk.snapenhance.common.util.snap.BitmojiSelfie
<a href="#h29-0-11" id="h29-0-11" class="i">+import me.rhunk.snapenhance.storage.*
</a> import me.rhunk.snapenhance.ui.manager.Routes
 import me.rhunk.snapenhance.ui.util.AlertDialogs
<a href="#h29-0-14" id="h29-0-14" class="d">-import me.rhunk.snapenhance.ui.util.coil.BitmojiImage
</a> import me.rhunk.snapenhance.ui.util.Dialog
<a href="#h29-0-16" id="h29-0-16" class="i">+import me.rhunk.snapenhance.ui.util.coil.BitmojiImage
</a> import kotlin.io.encoding.Base64
 import kotlin.io.encoding.ExperimentalEncodingApi
 
<a href="#h29-1" id="h29-1" class="h">@@ -32,10 +38,10 @@ class ManageScope: Routes.Route() {
</a> 
     private fun deleteScope(scope: SocialScope, id: String, coroutineScope: CoroutineScope) {
         when (scope) {
<a href="#h29-1-3" id="h29-1-3" class="d">-            SocialScope.FRIEND -&gt; context.modDatabase.deleteFriend(id)
</a><a href="#h29-1-4" id="h29-1-4" class="d">-            SocialScope.GROUP -&gt; context.modDatabase.deleteGroup(id)
</a><a href="#h29-1-5" id="h29-1-5" class="i">+            SocialScope.FRIEND -&gt; context.database.deleteFriend(id)
</a><a href="#h29-1-6" id="h29-1-6" class="i">+            SocialScope.GROUP -&gt; context.database.deleteGroup(id)
</a>         }
<a href="#h29-1-8" id="h29-1-8" class="d">-        context.modDatabase.executeAsync {
</a><a href="#h29-1-9" id="h29-1-9" class="i">+        context.database.executeAsync {
</a>             coroutineScope.launch {
                 routes.navController.popBackStack()
             }
<a href="#h29-2" id="h29-2" class="h">@@ -79,47 +85,97 @@ class ManageScope: Routes.Route() {
</a>         val id = navBackStackEntry.arguments?.getString(&quot;id&quot;)!!
 
         Column(
<a href="#h29-2-3" id="h29-2-3" class="d">-            modifier = Modifier.verticalScroll(rememberScrollState())
</a><a href="#h29-2-4" id="h29-2-4" class="i">+            modifier = Modifier
</a><a href="#h29-2-5" id="h29-2-5" class="i">+                .verticalScroll(rememberScrollState())
</a><a href="#h29-2-6" id="h29-2-6" class="i">+                .fillMaxSize()
</a>         ) {
<a href="#h29-2-8" id="h29-2-8" class="i">+            var hasScope by remember {
</a><a href="#h29-2-9" id="h29-2-9" class="i">+                mutableStateOf(null as Boolean?)
</a><a href="#h29-2-10" id="h29-2-10" class="i">+            }
</a>             when (scope) {
<a href="#h29-2-12" id="h29-2-12" class="d">-                SocialScope.FRIEND -&gt; Friend(id)
</a><a href="#h29-2-13" id="h29-2-13" class="d">-                SocialScope.GROUP -&gt; Group(id)
</a><a href="#h29-2-14" id="h29-2-14" class="i">+                SocialScope.FRIEND -&gt; {
</a><a href="#h29-2-15" id="h29-2-15" class="i">+                    var streaks by remember { mutableStateOf(null as FriendStreaks?) }
</a><a href="#h29-2-16" id="h29-2-16" class="i">+                    val friend by rememberAsyncMutableState(null) {
</a><a href="#h29-2-17" id="h29-2-17" class="i">+                        context.database.getFriendInfo(id)?.also {
</a><a href="#h29-2-18" id="h29-2-18" class="i">+                            streaks = context.database.getFriendStreaks(id)
</a><a href="#h29-2-19" id="h29-2-19" class="i">+                        }.also {
</a><a href="#h29-2-20" id="h29-2-20" class="i">+                            hasScope = it != null
</a><a href="#h29-2-21" id="h29-2-21" class="i">+                        }
</a><a href="#h29-2-22" id="h29-2-22" class="i">+                    }
</a><a href="#h29-2-23" id="h29-2-23" class="i">+                    friend?.let {
</a><a href="#h29-2-24" id="h29-2-24" class="i">+                        Friend(id, it, streaks)
</a><a href="#h29-2-25" id="h29-2-25" class="i">+                    }
</a><a href="#h29-2-26" id="h29-2-26" class="i">+                }
</a><a href="#h29-2-27" id="h29-2-27" class="i">+                SocialScope.GROUP -&gt; {
</a><a href="#h29-2-28" id="h29-2-28" class="i">+                    val group by rememberAsyncMutableState(null) {
</a><a href="#h29-2-29" id="h29-2-29" class="i">+                        context.database.getGroupInfo(id).also {
</a><a href="#h29-2-30" id="h29-2-30" class="i">+                            hasScope = it != null
</a><a href="#h29-2-31" id="h29-2-31" class="i">+                        }
</a><a href="#h29-2-32" id="h29-2-32" class="i">+                    }
</a><a href="#h29-2-33" id="h29-2-33" class="i">+                    group?.let {
</a><a href="#h29-2-34" id="h29-2-34" class="i">+                        Group(it)
</a><a href="#h29-2-35" id="h29-2-35" class="i">+                    }
</a><a href="#h29-2-36" id="h29-2-36" class="i">+                }
</a><a href="#h29-2-37" id="h29-2-37" class="i">+            }
</a><a href="#h29-2-38" id="h29-2-38" class="i">+            if (hasScope == true) {
</a><a href="#h29-2-39" id="h29-2-39" class="i">+                RulesCard(id)
</a><a href="#h29-2-40" id="h29-2-40" class="i">+            }
</a><a href="#h29-2-41" id="h29-2-41" class="i">+            if (hasScope == false) {
</a><a href="#h29-2-42" id="h29-2-42" class="i">+                Column(
</a><a href="#h29-2-43" id="h29-2-43" class="i">+                    modifier = Modifier.fillMaxSize(),
</a><a href="#h29-2-44" id="h29-2-44" class="i">+                    verticalArrangement = Arrangement.Center,
</a><a href="#h29-2-45" id="h29-2-45" class="i">+                    horizontalAlignment = Alignment.CenterHorizontally
</a><a href="#h29-2-46" id="h29-2-46" class="i">+                ) {
</a><a href="#h29-2-47" id="h29-2-47" class="i">+                    Text(
</a><a href="#h29-2-48" id="h29-2-48" class="i">+                        text = translation[&quot;not_found&quot;],
</a><a href="#h29-2-49" id="h29-2-49" class="i">+                        fontSize = 20.sp,
</a><a href="#h29-2-50" id="h29-2-50" class="i">+                        fontWeight = FontWeight.Bold
</a><a href="#h29-2-51" id="h29-2-51" class="i">+                    )
</a><a href="#h29-2-52" id="h29-2-52" class="i">+                }
</a>             }
<a href="#h29-2-54" id="h29-2-54" class="i">+        }
</a><a href="#h29-2-55" id="h29-2-55" class="i">+    }
</a> 
<a href="#h29-2-57" id="h29-2-57" class="d">-            Spacer(modifier = Modifier.height(16.dp))
</a> 
<a href="#h29-2-59" id="h29-2-59" class="d">-            val rules = context.modDatabase.getRules(id)
</a><a href="#h29-2-60" id="h29-2-60" class="i">+    @Composable
</a><a href="#h29-2-61" id="h29-2-61" class="i">+    private fun RulesCard(
</a><a href="#h29-2-62" id="h29-2-62" class="i">+        id: String
</a><a href="#h29-2-63" id="h29-2-63" class="i">+    ) {
</a><a href="#h29-2-64" id="h29-2-64" class="i">+        Spacer(modifier = Modifier.height(16.dp))
</a> 
<a href="#h29-2-66" id="h29-2-66" class="d">-            SectionTitle(translation[&quot;rules_title&quot;])
</a><a href="#h29-2-67" id="h29-2-67" class="i">+        val rules = rememberAsyncMutableStateList(listOf()) {
</a><a href="#h29-2-68" id="h29-2-68" class="i">+            context.database.getRules(id)
</a><a href="#h29-2-69" id="h29-2-69" class="i">+        }
</a> 
<a href="#h29-2-71" id="h29-2-71" class="d">-            ContentCard {
</a><a href="#h29-2-72" id="h29-2-72" class="d">-                MessagingRuleType.entries.forEach { ruleType -&gt;
</a><a href="#h29-2-73" id="h29-2-73" class="d">-                    var ruleEnabled by remember {
</a><a href="#h29-2-74" id="h29-2-74" class="d">-                        mutableStateOf(rules.any { it.key == ruleType.key })
</a><a href="#h29-2-75" id="h29-2-75" class="d">-                    }
</a><a href="#h29-2-76" id="h29-2-76" class="i">+        SectionTitle(translation[&quot;rules_title&quot;])
</a> 
<a href="#h29-2-78" id="h29-2-78" class="d">-                    val ruleState = context.config.root.rules.getRuleState(ruleType)
</a><a href="#h29-2-79" id="h29-2-79" class="i">+        ContentCard {
</a><a href="#h29-2-80" id="h29-2-80" class="i">+            MessagingRuleType.entries.forEach { ruleType -&gt;
</a><a href="#h29-2-81" id="h29-2-81" class="i">+                var ruleEnabled by remember(rules.size) {
</a><a href="#h29-2-82" id="h29-2-82" class="i">+                    mutableStateOf(rules.any { it.key == ruleType.key })
</a><a href="#h29-2-83" id="h29-2-83" class="i">+                }
</a> 
<a href="#h29-2-85" id="h29-2-85" class="d">-                    Row(
</a><a href="#h29-2-86" id="h29-2-86" class="d">-                        verticalAlignment = Alignment.CenterVertically,
</a><a href="#h29-2-87" id="h29-2-87" class="d">-                        modifier = Modifier.padding(all = 4.dp)
</a><a href="#h29-2-88" id="h29-2-88" class="d">-                    ) {
</a><a href="#h29-2-89" id="h29-2-89" class="d">-                        Text(
</a><a href="#h29-2-90" id="h29-2-90" class="d">-                            text = if (ruleType.listMode &amp;&amp; ruleState != null) {
</a><a href="#h29-2-91" id="h29-2-91" class="d">-                                context.translation[&quot;rules.properties.${ruleType.key}.options.${ruleState.key}&quot;]
</a><a href="#h29-2-92" id="h29-2-92" class="d">-                            } else context.translation[&quot;rules.properties.${ruleType.key}.name&quot;],
</a><a href="#h29-2-93" id="h29-2-93" class="d">-                            modifier = Modifier
</a><a href="#h29-2-94" id="h29-2-94" class="d">-                                .weight(1f)
</a><a href="#h29-2-95" id="h29-2-95" class="d">-                                .padding(start = 5.dp, end = 5.dp)
</a><a href="#h29-2-96" id="h29-2-96" class="d">-                        )
</a><a href="#h29-2-97" id="h29-2-97" class="d">-                        Switch(checked = ruleEnabled,
</a><a href="#h29-2-98" id="h29-2-98" class="d">-                            enabled = if (ruleType.listMode) ruleState != null else true,
</a><a href="#h29-2-99" id="h29-2-99" class="d">-                            onCheckedChange = {
</a><a href="#h29-2-100" id="h29-2-100" class="d">-                                context.modDatabase.setRule(id, ruleType.key, it)
</a><a href="#h29-2-101" id="h29-2-101" class="d">-                                ruleEnabled = it
</a><a href="#h29-2-102" id="h29-2-102" class="d">-                            }
</a><a href="#h29-2-103" id="h29-2-103" class="d">-                        )
</a><a href="#h29-2-104" id="h29-2-104" class="d">-                    }
</a><a href="#h29-2-105" id="h29-2-105" class="i">+                val ruleState = context.config.root.rules.getRuleState(ruleType)
</a><a href="#h29-2-106" id="h29-2-106" class="i">+
</a><a href="#h29-2-107" id="h29-2-107" class="i">+                Row(
</a><a href="#h29-2-108" id="h29-2-108" class="i">+                    verticalAlignment = Alignment.CenterVertically,
</a><a href="#h29-2-109" id="h29-2-109" class="i">+                    modifier = Modifier.padding(all = 4.dp)
</a><a href="#h29-2-110" id="h29-2-110" class="i">+                ) {
</a><a href="#h29-2-111" id="h29-2-111" class="i">+                    Text(
</a><a href="#h29-2-112" id="h29-2-112" class="i">+                        text = if (ruleType.listMode &amp;&amp; ruleState != null) {
</a><a href="#h29-2-113" id="h29-2-113" class="i">+                            context.translation[&quot;rules.properties.${ruleType.key}.options.${ruleState.key}&quot;]
</a><a href="#h29-2-114" id="h29-2-114" class="i">+                        } else context.translation[&quot;rules.properties.${ruleType.key}.name&quot;],
</a><a href="#h29-2-115" id="h29-2-115" class="i">+                        modifier = Modifier
</a><a href="#h29-2-116" id="h29-2-116" class="i">+                            .weight(1f)
</a><a href="#h29-2-117" id="h29-2-117" class="i">+                            .padding(start = 5.dp, end = 5.dp)
</a><a href="#h29-2-118" id="h29-2-118" class="i">+                    )
</a><a href="#h29-2-119" id="h29-2-119" class="i">+                    Switch(checked = ruleEnabled,
</a><a href="#h29-2-120" id="h29-2-120" class="i">+                        enabled = if (ruleType.listMode) ruleState != null else true,
</a><a href="#h29-2-121" id="h29-2-121" class="i">+                        onCheckedChange = {
</a><a href="#h29-2-122" id="h29-2-122" class="i">+                            context.database.setRule(id, ruleType.key, it)
</a><a href="#h29-2-123" id="h29-2-123" class="i">+                            ruleEnabled = it
</a><a href="#h29-2-124" id="h29-2-124" class="i">+                        }
</a><a href="#h29-2-125" id="h29-2-125" class="i">+                    )
</a>                 }
             }
         }
<a href="#h29-3" id="h29-3" class="h">@@ -185,17 +241,11 @@ class ManageScope: Routes.Route() {
</a> 
     @OptIn(ExperimentalEncodingApi::class)
     @Composable
<a href="#h29-3-3" id="h29-3-3" class="d">-    private fun Friend(id: String) {
</a><a href="#h29-3-4" id="h29-3-4" class="d">-        //fetch the friend from the database
</a><a href="#h29-3-5" id="h29-3-5" class="d">-        val friend = remember { context.modDatabase.getFriendInfo(id) } ?: run {
</a><a href="#h29-3-6" id="h29-3-6" class="d">-            Text(text = translation[&quot;not_found&quot;])
</a><a href="#h29-3-7" id="h29-3-7" class="d">-            return
</a><a href="#h29-3-8" id="h29-3-8" class="d">-        }
</a><a href="#h29-3-9" id="h29-3-9" class="d">-
</a><a href="#h29-3-10" id="h29-3-10" class="d">-        val streaks = remember {
</a><a href="#h29-3-11" id="h29-3-11" class="d">-            context.modDatabase.getFriendStreaks(id)
</a><a href="#h29-3-12" id="h29-3-12" class="d">-        }
</a><a href="#h29-3-13" id="h29-3-13" class="d">-
</a><a href="#h29-3-14" id="h29-3-14" class="i">+    private fun Friend(
</a><a href="#h29-3-15" id="h29-3-15" class="i">+        id: String,
</a><a href="#h29-3-16" id="h29-3-16" class="i">+        friend: MessagingFriendInfo,
</a><a href="#h29-3-17" id="h29-3-17" class="i">+        streaks: FriendStreaks?
</a><a href="#h29-3-18" id="h29-3-18" class="i">+    ) {
</a>         Column(
             modifier = Modifier
                 .padding(10.dp)
<a href="#h29-4" id="h29-4" class="h">@@ -275,7 +325,7 @@ class ManageScope: Routes.Route() {
</a>                                 modifier = Modifier.padding(end = 10.dp)
                             )
                             Switch(checked = shouldNotify, onCheckedChange = {
<a href="#h29-4-3" id="h29-4-3" class="d">-                                context.modDatabase.setFriendStreaksNotify(id, it)
</a><a href="#h29-4-4" id="h29-4-4" class="i">+                                context.database.setFriendStreaksNotify(id, it)
</a>                                 shouldNotify = it
                             })
                         }
<a href="#h29-5" id="h29-5" class="h">@@ -286,7 +336,9 @@ class ManageScope: Routes.Route() {
</a> 
             if (context.config.root.experimental.e2eEncryption.globalState == true) {
                 SectionTitle(translation[&quot;e2ee_title&quot;])
<a href="#h29-5-3" id="h29-5-3" class="d">-                var hasSecretKey by remember { mutableStateOf(context.e2eeImplementation.friendKeyExists(friend.userId))}
</a><a href="#h29-5-4" id="h29-5-4" class="i">+                var hasSecretKey by rememberAsyncMutableState(defaultValue = false) {
</a><a href="#h29-5-5" id="h29-5-5" class="i">+                    context.e2eeImplementation.friendKeyExists(friend.userId)
</a><a href="#h29-5-6" id="h29-5-6" class="i">+                }
</a>                 var importDialog by remember { mutableStateOf(false) }
 
                 if (importDialog) {
<a href="#h29-6" id="h29-6" class="h">@@ -302,8 +354,11 @@ class ManageScope: Routes.Route() {
</a>                                     return@runCatching
                                 }
 
<a href="#h29-6-3" id="h29-6-3" class="d">-                                context.e2eeImplementation.storeSharedSecretKey(friend.userId, key)
</a><a href="#h29-6-4" id="h29-6-4" class="d">-                                context.longToast(&quot;Successfully imported key&quot;)
</a><a href="#h29-6-5" id="h29-6-5" class="i">+                                context.coroutineScope.launch {
</a><a href="#h29-6-6" id="h29-6-6" class="i">+                                    context.e2eeImplementation.storeSharedSecretKey(friend.userId, key)
</a><a href="#h29-6-7" id="h29-6-7" class="i">+                                    context.longToast(&quot;Successfully imported key&quot;)
</a><a href="#h29-6-8" id="h29-6-8" class="i">+                                }
</a><a href="#h29-6-9" id="h29-6-9" class="i">+
</a>                                 hasSecretKey = true
                             }.onFailure {
                                 context.longToast(&quot;Failed to import key: ${it.message}&quot;)
<a href="#h29-7" id="h29-7" class="h">@@ -320,20 +375,22 @@ class ManageScope: Routes.Route() {
</a>                     ) {
                         if (hasSecretKey) {
                             OutlinedButton(onClick = {
<a href="#h29-7-3" id="h29-7-3" class="d">-                                val secretKey = Base64.encode(context.e2eeImplementation.getSharedSecretKey(friend.userId) ?: return@OutlinedButton)
</a><a href="#h29-7-4" id="h29-7-4" class="d">-                                //TODO: fingerprint auth
</a><a href="#h29-7-5" id="h29-7-5" class="d">-                                context.activity!!.startActivity(Intent.createChooser(Intent().apply {
</a><a href="#h29-7-6" id="h29-7-6" class="d">-                                    action = Intent.ACTION_SEND
</a><a href="#h29-7-7" id="h29-7-7" class="d">-                                    putExtra(Intent.EXTRA_TEXT, secretKey)
</a><a href="#h29-7-8" id="h29-7-8" class="d">-                                    type = &quot;text/plain&quot;
</a><a href="#h29-7-9" id="h29-7-9" class="d">-                                }, &quot;&quot;).apply {
</a><a href="#h29-7-10" id="h29-7-10" class="d">-                                    putExtra(Intent.EXTRA_INITIAL_INTENTS, arrayOf(
</a><a href="#h29-7-11" id="h29-7-11" class="d">-                                        Intent().apply {
</a><a href="#h29-7-12" id="h29-7-12" class="d">-                                            putExtra(Intent.EXTRA_TEXT, secretKey)
</a><a href="#h29-7-13" id="h29-7-13" class="d">-                                            putExtra(Intent.EXTRA_SUBJECT, secretKey)
</a><a href="#h29-7-14" id="h29-7-14" class="d">-                                        })
</a><a href="#h29-7-15" id="h29-7-15" class="d">-                                    )
</a><a href="#h29-7-16" id="h29-7-16" class="d">-                                })
</a><a href="#h29-7-17" id="h29-7-17" class="i">+                                context.coroutineScope.launch {
</a><a href="#h29-7-18" id="h29-7-18" class="i">+                                    val secretKey = Base64.encode(context.e2eeImplementation.getSharedSecretKey(friend.userId) ?: return@launch)
</a><a href="#h29-7-19" id="h29-7-19" class="i">+                                    //TODO: fingerprint auth
</a><a href="#h29-7-20" id="h29-7-20" class="i">+                                    context.activity!!.startActivity(Intent.createChooser(Intent().apply {
</a><a href="#h29-7-21" id="h29-7-21" class="i">+                                        action = Intent.ACTION_SEND
</a><a href="#h29-7-22" id="h29-7-22" class="i">+                                        putExtra(Intent.EXTRA_TEXT, secretKey)
</a><a href="#h29-7-23" id="h29-7-23" class="i">+                                        type = &quot;text/plain&quot;
</a><a href="#h29-7-24" id="h29-7-24" class="i">+                                    }, &quot;&quot;).apply {
</a><a href="#h29-7-25" id="h29-7-25" class="i">+                                        putExtra(Intent.EXTRA_INITIAL_INTENTS, arrayOf(
</a><a href="#h29-7-26" id="h29-7-26" class="i">+                                            Intent().apply {
</a><a href="#h29-7-27" id="h29-7-27" class="i">+                                                putExtra(Intent.EXTRA_TEXT, secretKey)
</a><a href="#h29-7-28" id="h29-7-28" class="i">+                                                putExtra(Intent.EXTRA_SUBJECT, secretKey)
</a><a href="#h29-7-29" id="h29-7-29" class="i">+                                            })
</a><a href="#h29-7-30" id="h29-7-30" class="i">+                                        )
</a><a href="#h29-7-31" id="h29-7-31" class="i">+                                    })
</a><a href="#h29-7-32" id="h29-7-32" class="i">+                                }
</a>                             }) {
                                 Text(
                                     text = &quot;Export Base64&quot;,
<a href="#h29-8" id="h29-8" class="h">@@ -355,13 +412,7 @@ class ManageScope: Routes.Route() {
</a>     }
 
     @Composable
<a href="#h29-8-3" id="h29-8-3" class="d">-    private fun Group(id: String) {
</a><a href="#h29-8-4" id="h29-8-4" class="d">-        //fetch the group from the database
</a><a href="#h29-8-5" id="h29-8-5" class="d">-        val group = remember { context.modDatabase.getGroupInfo(id) } ?: run {
</a><a href="#h29-8-6" id="h29-8-6" class="d">-            Text(text = translation[&quot;not_found&quot;])
</a><a href="#h29-8-7" id="h29-8-7" class="d">-            return
</a><a href="#h29-8-8" id="h29-8-8" class="d">-        }
</a><a href="#h29-8-9" id="h29-8-9" class="d">-
</a><a href="#h29-8-10" id="h29-8-10" class="i">+    private fun Group(group: MessagingGroupInfo) {
</a>         Column(
             modifier = Modifier
                 .padding(10.dp)
<b>diff --git a/<a id="h30" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/social/MessagingPreview.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/social/MessagingPreview.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/social/MessagingPreview.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/social/MessagingPreview.kt</a></b>
<a href="#h30-0" id="h30-0" class="h">@@ -478,12 +478,14 @@ class MessagingPreview: Routes.Route() {
</a> 
             isBridgeConnected = context.hasMessagingBridge()
             if (isBridgeConnected) {
<a href="#h30-0-3" id="h30-0-3" class="d">-                onMessagingBridgeReady(scope, id)
</a><a href="#h30-0-4" id="h30-0-4" class="d">-            } else {
</a><a href="#h30-0-5" id="h30-0-5" class="d">-                SnapWidgetBroadcastReceiverHelper.create(&quot;wakeup&quot;) {}.also {
</a><a href="#h30-0-6" id="h30-0-6" class="d">-                    context.androidContext.sendBroadcast(it)
</a><a href="#h30-0-7" id="h30-0-7" class="i">+                withContext(Dispatchers.IO) {
</a><a href="#h30-0-8" id="h30-0-8" class="i">+                    onMessagingBridgeReady(scope, id)
</a>                 }
<a href="#h30-0-10" id="h30-0-10" class="i">+            } else {
</a>                 coroutineScope.launch(Dispatchers.IO) {
<a href="#h30-0-12" id="h30-0-12" class="i">+                    SnapWidgetBroadcastReceiverHelper.create(&quot;wakeup&quot;) {}.also {
</a><a href="#h30-0-13" id="h30-0-13" class="i">+                        context.androidContext.sendBroadcast(it)
</a><a href="#h30-0-14" id="h30-0-14" class="i">+                    }
</a>                     withTimeout(10000) {
                         while (!context.hasMessagingBridge()) {
                             delay(100)
<b>diff --git a/<a id="h31" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/social/SocialRoot.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/social/SocialRoot.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/social/SocialRoot.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/social/SocialRoot.kt</a></b>
<a href="#h31-0" id="h31-0" class="h">@@ -22,14 +22,14 @@ import androidx.compose.ui.text.style.TextOverflow
</a> import androidx.compose.ui.unit.dp
 import androidx.compose.ui.unit.sp
 import androidx.navigation.NavBackStackEntry
<a href="#h31-0-3" id="h31-0-3" class="d">-import kotlinx.coroutines.Dispatchers
</a> import kotlinx.coroutines.launch
<a href="#h31-0-5" id="h31-0-5" class="d">-import kotlinx.coroutines.withContext
</a> import me.rhunk.snapenhance.R
 import me.rhunk.snapenhance.common.data.MessagingFriendInfo
 import me.rhunk.snapenhance.common.data.MessagingGroupInfo
 import me.rhunk.snapenhance.common.data.SocialScope
<a href="#h31-0-10" id="h31-0-10" class="i">+import me.rhunk.snapenhance.common.ui.rememberAsyncMutableState
</a> import me.rhunk.snapenhance.common.util.snap.BitmojiSelfie
<a href="#h31-0-12" id="h31-0-12" class="i">+import me.rhunk.snapenhance.storage.*
</a> import me.rhunk.snapenhance.ui.manager.Routes
 import me.rhunk.snapenhance.ui.util.coil.BitmojiImage
 import me.rhunk.snapenhance.ui.util.pagerTabIndicatorOffset
<a href="#h31-1" id="h31-1" class="h">@@ -38,15 +38,32 @@ class SocialRoot : Routes.Route() {
</a>     private var friendList: List&lt;MessagingFriendInfo&gt; by mutableStateOf(emptyList())
     private var groupList: List&lt;MessagingGroupInfo&gt; by mutableStateOf(emptyList())
 
<a href="#h31-1-3" id="h31-1-3" class="d">-    fun updateScopeLists() {
</a><a href="#h31-1-4" id="h31-1-4" class="d">-        context.coroutineScope.launch(Dispatchers.IO) {
</a><a href="#h31-1-5" id="h31-1-5" class="d">-            friendList = context.modDatabase.getFriends(descOrder = true)
</a><a href="#h31-1-6" id="h31-1-6" class="d">-            groupList = context.modDatabase.getGroups()
</a><a href="#h31-1-7" id="h31-1-7" class="i">+    private fun updateScopeLists() {
</a><a href="#h31-1-8" id="h31-1-8" class="i">+        context.coroutineScope.launch {
</a><a href="#h31-1-9" id="h31-1-9" class="i">+            friendList = context.database.getFriends(descOrder = true)
</a><a href="#h31-1-10" id="h31-1-10" class="i">+            groupList = context.database.getGroups()
</a>         }
     }
 
     private val addFriendDialog by lazy {
<a href="#h31-1-15" id="h31-1-15" class="d">-        AddFriendDialog(context, this)
</a><a href="#h31-1-16" id="h31-1-16" class="i">+        AddFriendDialog(context, AddFriendDialog.Actions(
</a><a href="#h31-1-17" id="h31-1-17" class="i">+            onFriendState = { friend, state -&gt;
</a><a href="#h31-1-18" id="h31-1-18" class="i">+                if (state) {
</a><a href="#h31-1-19" id="h31-1-19" class="i">+                    context.bridgeService?.triggerScopeSync(SocialScope.FRIEND, friend.userId)
</a><a href="#h31-1-20" id="h31-1-20" class="i">+                } else {
</a><a href="#h31-1-21" id="h31-1-21" class="i">+                    context.database.deleteFriend(friend.userId)
</a><a href="#h31-1-22" id="h31-1-22" class="i">+                }
</a><a href="#h31-1-23" id="h31-1-23" class="i">+            },
</a><a href="#h31-1-24" id="h31-1-24" class="i">+            onGroupState = { group, state -&gt;
</a><a href="#h31-1-25" id="h31-1-25" class="i">+                if (state) {
</a><a href="#h31-1-26" id="h31-1-26" class="i">+                    context.bridgeService?.triggerScopeSync(SocialScope.GROUP, group.conversationId)
</a><a href="#h31-1-27" id="h31-1-27" class="i">+                } else {
</a><a href="#h31-1-28" id="h31-1-28" class="i">+                    context.database.deleteGroup(group.conversationId)
</a><a href="#h31-1-29" id="h31-1-29" class="i">+                }
</a><a href="#h31-1-30" id="h31-1-30" class="i">+            },
</a><a href="#h31-1-31" id="h31-1-31" class="i">+            getFriendState = { friend -&gt; context.database.getFriendInfo(friend.userId) != null },
</a><a href="#h31-1-32" id="h31-1-32" class="i">+            getGroupState = { group -&gt; context.database.getGroupInfo(group.conversationId) != null }
</a><a href="#h31-1-33" id="h31-1-33" class="i">+        ))
</a>     }
 
     @Composable
<a href="#h31-2" id="h31-2" class="h">@@ -82,7 +99,7 @@ class SocialRoot : Routes.Route() {
</a>                     SocialScope.FRIEND -&gt; friendList[index].userId
                 }
 
<a href="#h31-2-3" id="h31-2-3" class="d">-                Card(
</a><a href="#h31-2-4" id="h31-2-4" class="i">+                ElevatedCard(
</a>                     modifier = Modifier
                         .padding(10.dp)
                         .fillMaxWidth()
<a href="#h31-3" id="h31-3" class="h">@@ -119,12 +136,8 @@ class SocialRoot : Routes.Route() {
</a> 
                             SocialScope.FRIEND -&gt; {
                                 val friend = friendList[index]
<a href="#h31-3-3" id="h31-3-3" class="d">-                                var streaks by remember { mutableStateOf(friend.streaks) }
</a><a href="#h31-3-4" id="h31-3-4" class="d">-
</a><a href="#h31-3-5" id="h31-3-5" class="d">-                                LaunchedEffect(friend.userId) {
</a><a href="#h31-3-6" id="h31-3-6" class="d">-                                    withContext(Dispatchers.IO) {
</a><a href="#h31-3-7" id="h31-3-7" class="d">-                                        streaks = context.modDatabase.getFriendStreaks(friend.userId)
</a><a href="#h31-3-8" id="h31-3-8" class="d">-                                    }
</a><a href="#h31-3-9" id="h31-3-9" class="i">+                                val streaks by rememberAsyncMutableState(defaultValue = friend.streaks) {
</a><a href="#h31-3-10" id="h31-3-10" class="i">+                                    context.database.getFriendStreaks(friend.userId)
</a>                                 }
 
                                 BitmojiImage(
<a href="#h31-4" id="h31-4" class="h">@@ -204,6 +217,11 @@ class SocialRoot : Routes.Route() {
</a>             addFriendDialog.Content {
                 showAddFriendDialog = false
             }
<a href="#h31-4-3" id="h31-4-3" class="i">+            DisposableEffect(Unit) {
</a><a href="#h31-4-4" id="h31-4-4" class="i">+                onDispose {
</a><a href="#h31-4-5" id="h31-4-5" class="i">+                    updateScopeLists()
</a><a href="#h31-4-6" id="h31-4-6" class="i">+                }
</a><a href="#h31-4-7" id="h31-4-7" class="i">+            }
</a>         }
 
         LaunchedEffect(Unit) {
<b>diff --git a/<a id="h32" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/tracker/EditRule.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/tracker/EditRule.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/tracker/EditRule.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/tracker/EditRule.kt</a></b>
<a href="#h32-0" id="h32-0" class="h">@@ -0,0 +1,463 @@
</a><a href="#h32-0-0" id="h32-0-0" class="i">+package me.rhunk.snapenhance.ui.manager.pages.tracker
</a><a href="#h32-0-1" id="h32-0-1" class="i">+
</a><a href="#h32-0-2" id="h32-0-2" class="i">+import androidx.compose.foundation.clickable
</a><a href="#h32-0-3" id="h32-0-3" class="i">+import androidx.compose.foundation.layout.*
</a><a href="#h32-0-4" id="h32-0-4" class="i">+import androidx.compose.foundation.lazy.LazyColumn
</a><a href="#h32-0-5" id="h32-0-5" class="i">+import androidx.compose.foundation.lazy.items
</a><a href="#h32-0-6" id="h32-0-6" class="i">+import androidx.compose.foundation.rememberScrollState
</a><a href="#h32-0-7" id="h32-0-7" class="i">+import androidx.compose.foundation.verticalScroll
</a><a href="#h32-0-8" id="h32-0-8" class="i">+import androidx.compose.material.icons.Icons
</a><a href="#h32-0-9" id="h32-0-9" class="i">+import androidx.compose.material.icons.filled.Add
</a><a href="#h32-0-10" id="h32-0-10" class="i">+import androidx.compose.material.icons.filled.DeleteOutline
</a><a href="#h32-0-11" id="h32-0-11" class="i">+import androidx.compose.material.icons.filled.ExpandLess
</a><a href="#h32-0-12" id="h32-0-12" class="i">+import androidx.compose.material.icons.filled.ExpandMore
</a><a href="#h32-0-13" id="h32-0-13" class="i">+import androidx.compose.material.icons.filled.Save
</a><a href="#h32-0-14" id="h32-0-14" class="i">+import androidx.compose.material3.*
</a><a href="#h32-0-15" id="h32-0-15" class="i">+import androidx.compose.runtime.*
</a><a href="#h32-0-16" id="h32-0-16" class="i">+import androidx.compose.ui.Alignment
</a><a href="#h32-0-17" id="h32-0-17" class="i">+import androidx.compose.ui.Modifier
</a><a href="#h32-0-18" id="h32-0-18" class="i">+import androidx.compose.ui.draw.clip
</a><a href="#h32-0-19" id="h32-0-19" class="i">+import androidx.compose.ui.graphics.Color
</a><a href="#h32-0-20" id="h32-0-20" class="i">+import androidx.compose.ui.text.TextStyle
</a><a href="#h32-0-21" id="h32-0-21" class="i">+import androidx.compose.ui.text.font.FontWeight
</a><a href="#h32-0-22" id="h32-0-22" class="i">+import androidx.compose.ui.text.style.TextAlign
</a><a href="#h32-0-23" id="h32-0-23" class="i">+import androidx.compose.ui.text.style.TextOverflow
</a><a href="#h32-0-24" id="h32-0-24" class="i">+import androidx.compose.ui.unit.dp
</a><a href="#h32-0-25" id="h32-0-25" class="i">+import androidx.compose.ui.unit.sp
</a><a href="#h32-0-26" id="h32-0-26" class="i">+import androidx.navigation.NavBackStackEntry
</a><a href="#h32-0-27" id="h32-0-27" class="i">+import me.rhunk.snapenhance.common.data.TrackerEventType
</a><a href="#h32-0-28" id="h32-0-28" class="i">+import me.rhunk.snapenhance.common.data.TrackerRuleAction
</a><a href="#h32-0-29" id="h32-0-29" class="i">+import me.rhunk.snapenhance.common.data.TrackerRuleActionParams
</a><a href="#h32-0-30" id="h32-0-30" class="i">+import me.rhunk.snapenhance.common.data.TrackerRuleEvent
</a><a href="#h32-0-31" id="h32-0-31" class="i">+import me.rhunk.snapenhance.common.data.TrackerScopeType
</a><a href="#h32-0-32" id="h32-0-32" class="i">+import me.rhunk.snapenhance.common.ui.rememberAsyncMutableState
</a><a href="#h32-0-33" id="h32-0-33" class="i">+import me.rhunk.snapenhance.common.ui.rememberAsyncMutableStateList
</a><a href="#h32-0-34" id="h32-0-34" class="i">+import me.rhunk.snapenhance.storage.*
</a><a href="#h32-0-35" id="h32-0-35" class="i">+import me.rhunk.snapenhance.ui.manager.Routes
</a><a href="#h32-0-36" id="h32-0-36" class="i">+import me.rhunk.snapenhance.ui.manager.pages.social.AddFriendDialog
</a><a href="#h32-0-37" id="h32-0-37" class="i">+
</a><a href="#h32-0-38" id="h32-0-38" class="i">+@Composable
</a><a href="#h32-0-39" id="h32-0-39" class="i">+fun ActionCheckbox(
</a><a href="#h32-0-40" id="h32-0-40" class="i">+    text: String,
</a><a href="#h32-0-41" id="h32-0-41" class="i">+    checked: MutableState&lt;Boolean&gt;,
</a><a href="#h32-0-42" id="h32-0-42" class="i">+    onChanged: (Boolean) -&gt; Unit = {}
</a><a href="#h32-0-43" id="h32-0-43" class="i">+) {
</a><a href="#h32-0-44" id="h32-0-44" class="i">+    Row(
</a><a href="#h32-0-45" id="h32-0-45" class="i">+        modifier = Modifier.clickable {
</a><a href="#h32-0-46" id="h32-0-46" class="i">+            checked.value = !checked.value
</a><a href="#h32-0-47" id="h32-0-47" class="i">+            onChanged(checked.value)
</a><a href="#h32-0-48" id="h32-0-48" class="i">+        },
</a><a href="#h32-0-49" id="h32-0-49" class="i">+        horizontalArrangement = Arrangement.spacedBy(2.dp),
</a><a href="#h32-0-50" id="h32-0-50" class="i">+        verticalAlignment = Alignment.CenterVertically
</a><a href="#h32-0-51" id="h32-0-51" class="i">+    ) {
</a><a href="#h32-0-52" id="h32-0-52" class="i">+        Checkbox(
</a><a href="#h32-0-53" id="h32-0-53" class="i">+            modifier = Modifier.size(30.dp),
</a><a href="#h32-0-54" id="h32-0-54" class="i">+            checked = checked.value,
</a><a href="#h32-0-55" id="h32-0-55" class="i">+            onCheckedChange = {
</a><a href="#h32-0-56" id="h32-0-56" class="i">+                checked.value = it
</a><a href="#h32-0-57" id="h32-0-57" class="i">+                onChanged(it)
</a><a href="#h32-0-58" id="h32-0-58" class="i">+            }
</a><a href="#h32-0-59" id="h32-0-59" class="i">+        )
</a><a href="#h32-0-60" id="h32-0-60" class="i">+        Text(text, fontSize = 12.sp)
</a><a href="#h32-0-61" id="h32-0-61" class="i">+    }
</a><a href="#h32-0-62" id="h32-0-62" class="i">+}
</a><a href="#h32-0-63" id="h32-0-63" class="i">+
</a><a href="#h32-0-64" id="h32-0-64" class="i">+
</a><a href="#h32-0-65" id="h32-0-65" class="i">+@Composable
</a><a href="#h32-0-66" id="h32-0-66" class="i">+fun ConditionCheckboxes(
</a><a href="#h32-0-67" id="h32-0-67" class="i">+    params: TrackerRuleActionParams
</a><a href="#h32-0-68" id="h32-0-68" class="i">+) {
</a><a href="#h32-0-69" id="h32-0-69" class="i">+    ActionCheckbox(text = &quot;Only when I&#39;m inside conversation&quot;, checked = remember { mutableStateOf(params.onlyInsideConversation) }, onChanged = { params.onlyInsideConversation = it })
</a><a href="#h32-0-70" id="h32-0-70" class="i">+    ActionCheckbox(text = &quot;Only when I&#39;m outside conversation&quot;, checked = remember { mutableStateOf(params.onlyOutsideConversation) }, onChanged = { params.onlyOutsideConversation = it })
</a><a href="#h32-0-71" id="h32-0-71" class="i">+    ActionCheckbox(text = &quot;Only when Snapchat is active&quot;, checked = remember { mutableStateOf(params.onlyWhenAppActive) }, onChanged = { params.onlyWhenAppActive = it })
</a><a href="#h32-0-72" id="h32-0-72" class="i">+    ActionCheckbox(text = &quot;Only when Snapchat is inactive&quot;, checked = remember { mutableStateOf(params.onlyWhenAppInactive) }, onChanged = { params.onlyWhenAppInactive = it })
</a><a href="#h32-0-73" id="h32-0-73" class="i">+    ActionCheckbox(text = &quot;No notification when Snapchat is active&quot;, checked = remember { mutableStateOf(params.noPushNotificationWhenAppActive) }, onChanged = { params.noPushNotificationWhenAppActive = it })
</a><a href="#h32-0-74" id="h32-0-74" class="i">+}
</a><a href="#h32-0-75" id="h32-0-75" class="i">+
</a><a href="#h32-0-76" id="h32-0-76" class="i">+class EditRule : Routes.Route() {
</a><a href="#h32-0-77" id="h32-0-77" class="i">+    private val fab = mutableStateOf&lt;@Composable (() -&gt; Unit)?&gt;(null)
</a><a href="#h32-0-78" id="h32-0-78" class="i">+
</a><a href="#h32-0-79" id="h32-0-79" class="i">+    // persistent add event state
</a><a href="#h32-0-80" id="h32-0-80" class="i">+    private var currentEventType by mutableStateOf(TrackerEventType.CONVERSATION_ENTER.key)
</a><a href="#h32-0-81" id="h32-0-81" class="i">+    private var addEventActions by mutableStateOf(emptySet&lt;TrackerRuleAction&gt;())
</a><a href="#h32-0-82" id="h32-0-82" class="i">+    private val addEventActionParams by mutableStateOf(TrackerRuleActionParams())
</a><a href="#h32-0-83" id="h32-0-83" class="i">+
</a><a href="#h32-0-84" id="h32-0-84" class="i">+    override val floatingActionButton: @Composable () -&gt; Unit = {
</a><a href="#h32-0-85" id="h32-0-85" class="i">+        fab.value?.invoke()
</a><a href="#h32-0-86" id="h32-0-86" class="i">+    }
</a><a href="#h32-0-87" id="h32-0-87" class="i">+
</a><a href="#h32-0-88" id="h32-0-88" class="i">+    @OptIn(ExperimentalLayoutApi::class, ExperimentalMaterial3Api::class)
</a><a href="#h32-0-89" id="h32-0-89" class="i">+    override val content: @Composable (NavBackStackEntry) -&gt; Unit = { navBackStackEntry -&gt;
</a><a href="#h32-0-90" id="h32-0-90" class="i">+        val currentRuleId = navBackStackEntry.arguments?.getString(&quot;rule_id&quot;)?.toIntOrNull()
</a><a href="#h32-0-91" id="h32-0-91" class="i">+
</a><a href="#h32-0-92" id="h32-0-92" class="i">+        val events = rememberAsyncMutableStateList(defaultValue = emptyList()) {
</a><a href="#h32-0-93" id="h32-0-93" class="i">+            currentRuleId?.let { ruleId -&gt;
</a><a href="#h32-0-94" id="h32-0-94" class="i">+                context.database.getTrackerEvents(ruleId)
</a><a href="#h32-0-95" id="h32-0-95" class="i">+            } ?: emptyList()
</a><a href="#h32-0-96" id="h32-0-96" class="i">+        }
</a><a href="#h32-0-97" id="h32-0-97" class="i">+        var currentScopeType by remember { mutableStateOf(TrackerScopeType.BLACKLIST) }
</a><a href="#h32-0-98" id="h32-0-98" class="i">+        val scopes = rememberAsyncMutableStateList(defaultValue = emptyList()) {
</a><a href="#h32-0-99" id="h32-0-99" class="i">+            currentRuleId?.let { ruleId -&gt;
</a><a href="#h32-0-100" id="h32-0-100" class="i">+                context.database.getRuleTrackerScopes(ruleId).also {
</a><a href="#h32-0-101" id="h32-0-101" class="i">+                    currentScopeType = if (it.isEmpty()) {
</a><a href="#h32-0-102" id="h32-0-102" class="i">+                        TrackerScopeType.WHITELIST
</a><a href="#h32-0-103" id="h32-0-103" class="i">+                    } else {
</a><a href="#h32-0-104" id="h32-0-104" class="i">+                        it.values.first()
</a><a href="#h32-0-105" id="h32-0-105" class="i">+                    }
</a><a href="#h32-0-106" id="h32-0-106" class="i">+                }.map { it.key }
</a><a href="#h32-0-107" id="h32-0-107" class="i">+            } ?: emptyList()
</a><a href="#h32-0-108" id="h32-0-108" class="i">+        }
</a><a href="#h32-0-109" id="h32-0-109" class="i">+        val ruleName = rememberAsyncMutableState(defaultValue = &quot;&quot;, keys = arrayOf(currentRuleId)) {
</a><a href="#h32-0-110" id="h32-0-110" class="i">+            currentRuleId?.let { ruleId -&gt;
</a><a href="#h32-0-111" id="h32-0-111" class="i">+                context.database.getTrackerRule(ruleId)?.name ?: &quot;Custom Rule&quot;
</a><a href="#h32-0-112" id="h32-0-112" class="i">+            } ?: &quot;Custom Rule&quot;
</a><a href="#h32-0-113" id="h32-0-113" class="i">+        }
</a><a href="#h32-0-114" id="h32-0-114" class="i">+
</a><a href="#h32-0-115" id="h32-0-115" class="i">+        LaunchedEffect(Unit) {
</a><a href="#h32-0-116" id="h32-0-116" class="i">+            fab.value = {
</a><a href="#h32-0-117" id="h32-0-117" class="i">+                var deleteConfirmation by remember { mutableStateOf(false) }
</a><a href="#h32-0-118" id="h32-0-118" class="i">+
</a><a href="#h32-0-119" id="h32-0-119" class="i">+                if (deleteConfirmation) {
</a><a href="#h32-0-120" id="h32-0-120" class="i">+                    AlertDialog(
</a><a href="#h32-0-121" id="h32-0-121" class="i">+                        onDismissRequest = { deleteConfirmation = false },
</a><a href="#h32-0-122" id="h32-0-122" class="i">+                        title = { Text(&quot;Delete Rule&quot;) },
</a><a href="#h32-0-123" id="h32-0-123" class="i">+                        text = { Text(&quot;Are you sure you want to delete this rule?&quot;) },
</a><a href="#h32-0-124" id="h32-0-124" class="i">+                        confirmButton = {
</a><a href="#h32-0-125" id="h32-0-125" class="i">+                            Button(
</a><a href="#h32-0-126" id="h32-0-126" class="i">+                                onClick = {
</a><a href="#h32-0-127" id="h32-0-127" class="i">+                                    if (currentRuleId != null) {
</a><a href="#h32-0-128" id="h32-0-128" class="i">+                                        context.database.deleteTrackerRule(currentRuleId)
</a><a href="#h32-0-129" id="h32-0-129" class="i">+                                    }
</a><a href="#h32-0-130" id="h32-0-130" class="i">+                                    routes.navController.popBackStack()
</a><a href="#h32-0-131" id="h32-0-131" class="i">+                                }
</a><a href="#h32-0-132" id="h32-0-132" class="i">+                            ) {
</a><a href="#h32-0-133" id="h32-0-133" class="i">+                                Text(&quot;Delete&quot;)
</a><a href="#h32-0-134" id="h32-0-134" class="i">+                            }
</a><a href="#h32-0-135" id="h32-0-135" class="i">+                        },
</a><a href="#h32-0-136" id="h32-0-136" class="i">+                        dismissButton = {
</a><a href="#h32-0-137" id="h32-0-137" class="i">+                            Button(
</a><a href="#h32-0-138" id="h32-0-138" class="i">+                                onClick = { deleteConfirmation = false }
</a><a href="#h32-0-139" id="h32-0-139" class="i">+                            ) {
</a><a href="#h32-0-140" id="h32-0-140" class="i">+                                Text(&quot;Cancel&quot;)
</a><a href="#h32-0-141" id="h32-0-141" class="i">+                            }
</a><a href="#h32-0-142" id="h32-0-142" class="i">+                        }
</a><a href="#h32-0-143" id="h32-0-143" class="i">+                    )
</a><a href="#h32-0-144" id="h32-0-144" class="i">+                }
</a><a href="#h32-0-145" id="h32-0-145" class="i">+
</a><a href="#h32-0-146" id="h32-0-146" class="i">+                Column(
</a><a href="#h32-0-147" id="h32-0-147" class="i">+                    modifier = Modifier.fillMaxWidth(),
</a><a href="#h32-0-148" id="h32-0-148" class="i">+                    verticalArrangement = Arrangement.spacedBy(6.dp),
</a><a href="#h32-0-149" id="h32-0-149" class="i">+                    horizontalAlignment = Alignment.End
</a><a href="#h32-0-150" id="h32-0-150" class="i">+                ) {
</a><a href="#h32-0-151" id="h32-0-151" class="i">+                    ExtendedFloatingActionButton(
</a><a href="#h32-0-152" id="h32-0-152" class="i">+                        onClick = {
</a><a href="#h32-0-153" id="h32-0-153" class="i">+                            val ruleId = currentRuleId ?: context.database.newTrackerRule()
</a><a href="#h32-0-154" id="h32-0-154" class="i">+                            events.forEach { event -&gt;
</a><a href="#h32-0-155" id="h32-0-155" class="i">+                                context.database.addOrUpdateTrackerRuleEvent(
</a><a href="#h32-0-156" id="h32-0-156" class="i">+                                    event.id.takeIf { it &gt; -1 },
</a><a href="#h32-0-157" id="h32-0-157" class="i">+                                    ruleId,
</a><a href="#h32-0-158" id="h32-0-158" class="i">+                                    event.eventType,
</a><a href="#h32-0-159" id="h32-0-159" class="i">+                                    event.params,
</a><a href="#h32-0-160" id="h32-0-160" class="i">+                                    event.actions
</a><a href="#h32-0-161" id="h32-0-161" class="i">+                                )
</a><a href="#h32-0-162" id="h32-0-162" class="i">+                            }
</a><a href="#h32-0-163" id="h32-0-163" class="i">+                            context.database.setTrackerRuleName(ruleId, ruleName.value.trim())
</a><a href="#h32-0-164" id="h32-0-164" class="i">+                            context.database.setRuleTrackerScopes(ruleId, currentScopeType, scopes)
</a><a href="#h32-0-165" id="h32-0-165" class="i">+                            routes.navController.popBackStack()
</a><a href="#h32-0-166" id="h32-0-166" class="i">+                        },
</a><a href="#h32-0-167" id="h32-0-167" class="i">+                        text = { Text(&quot;Save Rule&quot;) },
</a><a href="#h32-0-168" id="h32-0-168" class="i">+                        icon = { Icon(Icons.Default.Save, contentDescription = &quot;Save Rule&quot;) }
</a><a href="#h32-0-169" id="h32-0-169" class="i">+                    )
</a><a href="#h32-0-170" id="h32-0-170" class="i">+
</a><a href="#h32-0-171" id="h32-0-171" class="i">+                    if (currentRuleId != null) {
</a><a href="#h32-0-172" id="h32-0-172" class="i">+                        ExtendedFloatingActionButton(
</a><a href="#h32-0-173" id="h32-0-173" class="i">+                            containerColor = MaterialTheme.colorScheme.error,
</a><a href="#h32-0-174" id="h32-0-174" class="i">+                            onClick = { deleteConfirmation = true },
</a><a href="#h32-0-175" id="h32-0-175" class="i">+                            text = { Text(&quot;Delete Rule&quot;) },
</a><a href="#h32-0-176" id="h32-0-176" class="i">+                            icon = { Icon(Icons.Default.DeleteOutline, contentDescription = &quot;Delete Rule&quot;) }
</a><a href="#h32-0-177" id="h32-0-177" class="i">+                        )
</a><a href="#h32-0-178" id="h32-0-178" class="i">+                    }
</a><a href="#h32-0-179" id="h32-0-179" class="i">+                }
</a><a href="#h32-0-180" id="h32-0-180" class="i">+            }
</a><a href="#h32-0-181" id="h32-0-181" class="i">+        }
</a><a href="#h32-0-182" id="h32-0-182" class="i">+
</a><a href="#h32-0-183" id="h32-0-183" class="i">+        DisposableEffect(Unit) {
</a><a href="#h32-0-184" id="h32-0-184" class="i">+            onDispose { fab.value = null }
</a><a href="#h32-0-185" id="h32-0-185" class="i">+        }
</a><a href="#h32-0-186" id="h32-0-186" class="i">+
</a><a href="#h32-0-187" id="h32-0-187" class="i">+        LazyColumn(
</a><a href="#h32-0-188" id="h32-0-188" class="i">+            verticalArrangement = Arrangement.spacedBy(2.dp),
</a><a href="#h32-0-189" id="h32-0-189" class="i">+        ) {
</a><a href="#h32-0-190" id="h32-0-190" class="i">+            item {
</a><a href="#h32-0-191" id="h32-0-191" class="i">+                TextField(
</a><a href="#h32-0-192" id="h32-0-192" class="i">+                    value = ruleName.value,
</a><a href="#h32-0-193" id="h32-0-193" class="i">+                    onValueChange = {
</a><a href="#h32-0-194" id="h32-0-194" class="i">+                        ruleName.value = it
</a><a href="#h32-0-195" id="h32-0-195" class="i">+                    },
</a><a href="#h32-0-196" id="h32-0-196" class="i">+                    singleLine = true,
</a><a href="#h32-0-197" id="h32-0-197" class="i">+                    placeholder = {
</a><a href="#h32-0-198" id="h32-0-198" class="i">+                        Text(
</a><a href="#h32-0-199" id="h32-0-199" class="i">+                            &quot;Rule Name&quot;,
</a><a href="#h32-0-200" id="h32-0-200" class="i">+                            fontSize = 18.sp,
</a><a href="#h32-0-201" id="h32-0-201" class="i">+                            modifier = Modifier.fillMaxWidth(),
</a><a href="#h32-0-202" id="h32-0-202" class="i">+                            textAlign = TextAlign.Center
</a><a href="#h32-0-203" id="h32-0-203" class="i">+                        )
</a><a href="#h32-0-204" id="h32-0-204" class="i">+                    },
</a><a href="#h32-0-205" id="h32-0-205" class="i">+                    modifier = Modifier.fillMaxWidth(),
</a><a href="#h32-0-206" id="h32-0-206" class="i">+                    colors = TextFieldDefaults.colors(
</a><a href="#h32-0-207" id="h32-0-207" class="i">+                        focusedContainerColor = Color.Transparent,
</a><a href="#h32-0-208" id="h32-0-208" class="i">+                        unfocusedContainerColor = Color.Transparent
</a><a href="#h32-0-209" id="h32-0-209" class="i">+                    ),
</a><a href="#h32-0-210" id="h32-0-210" class="i">+                    textStyle = TextStyle(fontSize = 20.sp, textAlign = TextAlign.Center, fontWeight = FontWeight.Bold)
</a><a href="#h32-0-211" id="h32-0-211" class="i">+                )
</a><a href="#h32-0-212" id="h32-0-212" class="i">+            }
</a><a href="#h32-0-213" id="h32-0-213" class="i">+
</a><a href="#h32-0-214" id="h32-0-214" class="i">+
</a><a href="#h32-0-215" id="h32-0-215" class="i">+            item {
</a><a href="#h32-0-216" id="h32-0-216" class="i">+                Column(
</a><a href="#h32-0-217" id="h32-0-217" class="i">+                    modifier = Modifier.fillMaxWidth(),
</a><a href="#h32-0-218" id="h32-0-218" class="i">+                ){
</a><a href="#h32-0-219" id="h32-0-219" class="i">+                    Text(&quot;Scope&quot;, fontSize = 16.sp, fontWeight = FontWeight.Bold, modifier = Modifier.padding(16.dp))
</a><a href="#h32-0-220" id="h32-0-220" class="i">+
</a><a href="#h32-0-221" id="h32-0-221" class="i">+                    var addFriendDialog by remember { mutableStateOf(null as AddFriendDialog?) }
</a><a href="#h32-0-222" id="h32-0-222" class="i">+
</a><a href="#h32-0-223" id="h32-0-223" class="i">+                    val friendDialogActions = remember {
</a><a href="#h32-0-224" id="h32-0-224" class="i">+                        AddFriendDialog.Actions(
</a><a href="#h32-0-225" id="h32-0-225" class="i">+                            onFriendState = { friend, state -&gt;
</a><a href="#h32-0-226" id="h32-0-226" class="i">+                                if (state) {
</a><a href="#h32-0-227" id="h32-0-227" class="i">+                                    scopes.add(friend.userId)
</a><a href="#h32-0-228" id="h32-0-228" class="i">+                                } else {
</a><a href="#h32-0-229" id="h32-0-229" class="i">+                                    scopes.remove(friend.userId)
</a><a href="#h32-0-230" id="h32-0-230" class="i">+                                }
</a><a href="#h32-0-231" id="h32-0-231" class="i">+                            },
</a><a href="#h32-0-232" id="h32-0-232" class="i">+                            onGroupState = { group, state -&gt;
</a><a href="#h32-0-233" id="h32-0-233" class="i">+                                if (state) {
</a><a href="#h32-0-234" id="h32-0-234" class="i">+                                    scopes.add(group.conversationId)
</a><a href="#h32-0-235" id="h32-0-235" class="i">+                                } else {
</a><a href="#h32-0-236" id="h32-0-236" class="i">+                                    scopes.remove(group.conversationId)
</a><a href="#h32-0-237" id="h32-0-237" class="i">+                                }
</a><a href="#h32-0-238" id="h32-0-238" class="i">+                            },
</a><a href="#h32-0-239" id="h32-0-239" class="i">+                            getFriendState = { friend -&gt;
</a><a href="#h32-0-240" id="h32-0-240" class="i">+                                friend.userId in scopes
</a><a href="#h32-0-241" id="h32-0-241" class="i">+                            },
</a><a href="#h32-0-242" id="h32-0-242" class="i">+                            getGroupState = { group -&gt;
</a><a href="#h32-0-243" id="h32-0-243" class="i">+                                group.conversationId in scopes
</a><a href="#h32-0-244" id="h32-0-244" class="i">+                            }
</a><a href="#h32-0-245" id="h32-0-245" class="i">+                        )
</a><a href="#h32-0-246" id="h32-0-246" class="i">+                    }
</a><a href="#h32-0-247" id="h32-0-247" class="i">+
</a><a href="#h32-0-248" id="h32-0-248" class="i">+                    Box(modifier = Modifier.clickable { scopes.clear() }) {
</a><a href="#h32-0-249" id="h32-0-249" class="i">+                        Row(
</a><a href="#h32-0-250" id="h32-0-250" class="i">+                            modifier = Modifier
</a><a href="#h32-0-251" id="h32-0-251" class="i">+                                .fillMaxWidth()
</a><a href="#h32-0-252" id="h32-0-252" class="i">+                                .padding(10.dp),
</a><a href="#h32-0-253" id="h32-0-253" class="i">+                            horizontalArrangement = Arrangement.spacedBy(4.dp),
</a><a href="#h32-0-254" id="h32-0-254" class="i">+                            verticalAlignment = Alignment.CenterVertically,
</a><a href="#h32-0-255" id="h32-0-255" class="i">+                        ) {
</a><a href="#h32-0-256" id="h32-0-256" class="i">+                            RadioButton(selected = scopes.isEmpty(), onClick = null)
</a><a href="#h32-0-257" id="h32-0-257" class="i">+                            Text(&quot;All Friends/Groups&quot;)
</a><a href="#h32-0-258" id="h32-0-258" class="i">+                        }
</a><a href="#h32-0-259" id="h32-0-259" class="i">+                    }
</a><a href="#h32-0-260" id="h32-0-260" class="i">+
</a><a href="#h32-0-261" id="h32-0-261" class="i">+                    Box(modifier = Modifier.clickable {
</a><a href="#h32-0-262" id="h32-0-262" class="i">+                        currentScopeType = TrackerScopeType.BLACKLIST
</a><a href="#h32-0-263" id="h32-0-263" class="i">+                        addFriendDialog = AddFriendDialog(
</a><a href="#h32-0-264" id="h32-0-264" class="i">+                            context,
</a><a href="#h32-0-265" id="h32-0-265" class="i">+                            friendDialogActions
</a><a href="#h32-0-266" id="h32-0-266" class="i">+                        )
</a><a href="#h32-0-267" id="h32-0-267" class="i">+                    }) {
</a><a href="#h32-0-268" id="h32-0-268" class="i">+                        Row(
</a><a href="#h32-0-269" id="h32-0-269" class="i">+                            modifier = Modifier
</a><a href="#h32-0-270" id="h32-0-270" class="i">+                                .fillMaxWidth()
</a><a href="#h32-0-271" id="h32-0-271" class="i">+                                .padding(10.dp),
</a><a href="#h32-0-272" id="h32-0-272" class="i">+                            horizontalArrangement = Arrangement.spacedBy(4.dp),
</a><a href="#h32-0-273" id="h32-0-273" class="i">+                            verticalAlignment = Alignment.CenterVertically,
</a><a href="#h32-0-274" id="h32-0-274" class="i">+                        ) {
</a><a href="#h32-0-275" id="h32-0-275" class="i">+                            RadioButton(selected = scopes.isNotEmpty() &amp;&amp; currentScopeType == TrackerScopeType.BLACKLIST, onClick = null)
</a><a href="#h32-0-276" id="h32-0-276" class="i">+                            Text(&quot;Blacklist&quot; + if (currentScopeType == TrackerScopeType.BLACKLIST &amp;&amp; scopes.isNotEmpty()) &quot; (&quot; + scopes.size.toString() + &quot;)&quot; else &quot;&quot;)
</a><a href="#h32-0-277" id="h32-0-277" class="i">+                        }
</a><a href="#h32-0-278" id="h32-0-278" class="i">+                    }
</a><a href="#h32-0-279" id="h32-0-279" class="i">+
</a><a href="#h32-0-280" id="h32-0-280" class="i">+                    Box(modifier = Modifier.clickable {
</a><a href="#h32-0-281" id="h32-0-281" class="i">+                        currentScopeType = TrackerScopeType.WHITELIST
</a><a href="#h32-0-282" id="h32-0-282" class="i">+                        addFriendDialog = AddFriendDialog(
</a><a href="#h32-0-283" id="h32-0-283" class="i">+                            context,
</a><a href="#h32-0-284" id="h32-0-284" class="i">+                            friendDialogActions
</a><a href="#h32-0-285" id="h32-0-285" class="i">+                        )
</a><a href="#h32-0-286" id="h32-0-286" class="i">+                    }) {
</a><a href="#h32-0-287" id="h32-0-287" class="i">+                        Row(
</a><a href="#h32-0-288" id="h32-0-288" class="i">+                            modifier = Modifier
</a><a href="#h32-0-289" id="h32-0-289" class="i">+                                .fillMaxWidth()
</a><a href="#h32-0-290" id="h32-0-290" class="i">+                                .padding(10.dp),
</a><a href="#h32-0-291" id="h32-0-291" class="i">+                            horizontalArrangement = Arrangement.spacedBy(4.dp),
</a><a href="#h32-0-292" id="h32-0-292" class="i">+                            verticalAlignment = Alignment.CenterVertically,
</a><a href="#h32-0-293" id="h32-0-293" class="i">+                        ) {
</a><a href="#h32-0-294" id="h32-0-294" class="i">+                            RadioButton(selected = scopes.isNotEmpty() &amp;&amp; currentScopeType == TrackerScopeType.WHITELIST, onClick = null)
</a><a href="#h32-0-295" id="h32-0-295" class="i">+                            Text(&quot;Whitelist&quot; + if (currentScopeType == TrackerScopeType.WHITELIST &amp;&amp; scopes.isNotEmpty()) &quot; (&quot; + scopes.size.toString() + &quot;)&quot; else &quot;&quot;)
</a><a href="#h32-0-296" id="h32-0-296" class="i">+                        }
</a><a href="#h32-0-297" id="h32-0-297" class="i">+                    }
</a><a href="#h32-0-298" id="h32-0-298" class="i">+
</a><a href="#h32-0-299" id="h32-0-299" class="i">+                    addFriendDialog?.Content {
</a><a href="#h32-0-300" id="h32-0-300" class="i">+                        addFriendDialog = null
</a><a href="#h32-0-301" id="h32-0-301" class="i">+                    }
</a><a href="#h32-0-302" id="h32-0-302" class="i">+                }
</a><a href="#h32-0-303" id="h32-0-303" class="i">+
</a><a href="#h32-0-304" id="h32-0-304" class="i">+                var addEventDialog by remember { mutableStateOf(false) }
</a><a href="#h32-0-305" id="h32-0-305" class="i">+                val showDropdown = remember { mutableStateOf(false) }
</a><a href="#h32-0-306" id="h32-0-306" class="i">+
</a><a href="#h32-0-307" id="h32-0-307" class="i">+                Row(
</a><a href="#h32-0-308" id="h32-0-308" class="i">+                    modifier = Modifier.fillMaxWidth(),
</a><a href="#h32-0-309" id="h32-0-309" class="i">+                    horizontalArrangement = Arrangement.SpaceBetween,
</a><a href="#h32-0-310" id="h32-0-310" class="i">+                    verticalAlignment = Alignment.CenterVertically
</a><a href="#h32-0-311" id="h32-0-311" class="i">+                ) {
</a><a href="#h32-0-312" id="h32-0-312" class="i">+                    Text(&quot;Events&quot;, fontSize = 16.sp, fontWeight = FontWeight.Bold, modifier = Modifier.padding(16.dp))
</a><a href="#h32-0-313" id="h32-0-313" class="i">+                    IconButton(onClick = { addEventDialog = true }, modifier = Modifier.padding(8.dp)) {
</a><a href="#h32-0-314" id="h32-0-314" class="i">+                        Icon(Icons.Default.Add, contentDescription = &quot;Add Event&quot;, modifier = Modifier.size(32.dp))
</a><a href="#h32-0-315" id="h32-0-315" class="i">+                    }
</a><a href="#h32-0-316" id="h32-0-316" class="i">+                }
</a><a href="#h32-0-317" id="h32-0-317" class="i">+
</a><a href="#h32-0-318" id="h32-0-318" class="i">+                if (addEventDialog) {
</a><a href="#h32-0-319" id="h32-0-319" class="i">+                    AlertDialog(
</a><a href="#h32-0-320" id="h32-0-320" class="i">+                        onDismissRequest = { addEventDialog = false },
</a><a href="#h32-0-321" id="h32-0-321" class="i">+                        title = { Text(&quot;Add Event&quot;, fontSize = 20.sp, fontWeight = FontWeight.Bold) },
</a><a href="#h32-0-322" id="h32-0-322" class="i">+                        text = {
</a><a href="#h32-0-323" id="h32-0-323" class="i">+                            Column(
</a><a href="#h32-0-324" id="h32-0-324" class="i">+                                modifier = Modifier
</a><a href="#h32-0-325" id="h32-0-325" class="i">+                                    .verticalScroll(rememberScrollState())
</a><a href="#h32-0-326" id="h32-0-326" class="i">+                                    .padding(16.dp),
</a><a href="#h32-0-327" id="h32-0-327" class="i">+                                verticalArrangement = Arrangement.spacedBy(4.dp)
</a><a href="#h32-0-328" id="h32-0-328" class="i">+                            ) {
</a><a href="#h32-0-329" id="h32-0-329" class="i">+                                Row(
</a><a href="#h32-0-330" id="h32-0-330" class="i">+                                    modifier = Modifier
</a><a href="#h32-0-331" id="h32-0-331" class="i">+                                        .fillMaxWidth()
</a><a href="#h32-0-332" id="h32-0-332" class="i">+                                        .padding(2.dp),
</a><a href="#h32-0-333" id="h32-0-333" class="i">+                                    horizontalArrangement = Arrangement.SpaceBetween,
</a><a href="#h32-0-334" id="h32-0-334" class="i">+                                    verticalAlignment = Alignment.CenterVertically
</a><a href="#h32-0-335" id="h32-0-335" class="i">+                                ) {
</a><a href="#h32-0-336" id="h32-0-336" class="i">+                                    Text(&quot;Type&quot;, fontSize = 14.sp, fontWeight = FontWeight.Bold)
</a><a href="#h32-0-337" id="h32-0-337" class="i">+                                    ExposedDropdownMenuBox(expanded = showDropdown.value, onExpandedChange = { showDropdown.value = it }) {
</a><a href="#h32-0-338" id="h32-0-338" class="i">+                                        ElevatedButton(
</a><a href="#h32-0-339" id="h32-0-339" class="i">+                                            onClick = { showDropdown.value = true },
</a><a href="#h32-0-340" id="h32-0-340" class="i">+                                            modifier = Modifier.menuAnchor()
</a><a href="#h32-0-341" id="h32-0-341" class="i">+                                        ) {
</a><a href="#h32-0-342" id="h32-0-342" class="i">+                                            Text(currentEventType, overflow = TextOverflow.Ellipsis, maxLines = 1)
</a><a href="#h32-0-343" id="h32-0-343" class="i">+                                        }
</a><a href="#h32-0-344" id="h32-0-344" class="i">+                                        DropdownMenu(expanded = showDropdown.value, onDismissRequest = { showDropdown.value = false }) {
</a><a href="#h32-0-345" id="h32-0-345" class="i">+                                            TrackerEventType.entries.forEach { eventType -&gt;
</a><a href="#h32-0-346" id="h32-0-346" class="i">+                                                DropdownMenuItem(onClick = {
</a><a href="#h32-0-347" id="h32-0-347" class="i">+                                                    currentEventType = eventType.key
</a><a href="#h32-0-348" id="h32-0-348" class="i">+                                                    showDropdown.value = false
</a><a href="#h32-0-349" id="h32-0-349" class="i">+                                                }, text = {
</a><a href="#h32-0-350" id="h32-0-350" class="i">+                                                    Text(eventType.key)
</a><a href="#h32-0-351" id="h32-0-351" class="i">+                                                })
</a><a href="#h32-0-352" id="h32-0-352" class="i">+                                            }
</a><a href="#h32-0-353" id="h32-0-353" class="i">+                                        }
</a><a href="#h32-0-354" id="h32-0-354" class="i">+                                    }
</a><a href="#h32-0-355" id="h32-0-355" class="i">+                                }
</a><a href="#h32-0-356" id="h32-0-356" class="i">+
</a><a href="#h32-0-357" id="h32-0-357" class="i">+                                Text(&quot;Triggers&quot;, fontSize = 14.sp, fontWeight = FontWeight.Bold, modifier = Modifier.padding(2.dp))
</a><a href="#h32-0-358" id="h32-0-358" class="i">+
</a><a href="#h32-0-359" id="h32-0-359" class="i">+                                FlowRow(
</a><a href="#h32-0-360" id="h32-0-360" class="i">+                                    modifier = Modifier
</a><a href="#h32-0-361" id="h32-0-361" class="i">+                                        .fillMaxWidth()
</a><a href="#h32-0-362" id="h32-0-362" class="i">+                                        .padding(2.dp),
</a><a href="#h32-0-363" id="h32-0-363" class="i">+                                ) {
</a><a href="#h32-0-364" id="h32-0-364" class="i">+                                    TrackerRuleAction.entries.forEach { action -&gt;
</a><a href="#h32-0-365" id="h32-0-365" class="i">+                                        ActionCheckbox(action.name, checked = remember { mutableStateOf(addEventActions.contains(action)) }) {
</a><a href="#h32-0-366" id="h32-0-366" class="i">+                                            if (it) {
</a><a href="#h32-0-367" id="h32-0-367" class="i">+                                                addEventActions += action
</a><a href="#h32-0-368" id="h32-0-368" class="i">+                                            } else {
</a><a href="#h32-0-369" id="h32-0-369" class="i">+                                                addEventActions -= action
</a><a href="#h32-0-370" id="h32-0-370" class="i">+                                            }
</a><a href="#h32-0-371" id="h32-0-371" class="i">+                                        }
</a><a href="#h32-0-372" id="h32-0-372" class="i">+                                    }
</a><a href="#h32-0-373" id="h32-0-373" class="i">+                                }
</a><a href="#h32-0-374" id="h32-0-374" class="i">+
</a><a href="#h32-0-375" id="h32-0-375" class="i">+                                Text(&quot;Conditions&quot;, fontSize = 14.sp, fontWeight = FontWeight.Bold, modifier = Modifier.padding(2.dp))
</a><a href="#h32-0-376" id="h32-0-376" class="i">+                                ConditionCheckboxes(addEventActionParams)
</a><a href="#h32-0-377" id="h32-0-377" class="i">+                            }
</a><a href="#h32-0-378" id="h32-0-378" class="i">+                        },
</a><a href="#h32-0-379" id="h32-0-379" class="i">+                        confirmButton = {
</a><a href="#h32-0-380" id="h32-0-380" class="i">+                            Button(
</a><a href="#h32-0-381" id="h32-0-381" class="i">+                                onClick = {
</a><a href="#h32-0-382" id="h32-0-382" class="i">+                                    events.add(0, TrackerRuleEvent(-1, true, currentEventType, addEventActionParams.copy(), addEventActions.toList()))
</a><a href="#h32-0-383" id="h32-0-383" class="i">+                                    addEventDialog = false
</a><a href="#h32-0-384" id="h32-0-384" class="i">+                                }
</a><a href="#h32-0-385" id="h32-0-385" class="i">+                            ) {
</a><a href="#h32-0-386" id="h32-0-386" class="i">+                                Text(&quot;Add&quot;)
</a><a href="#h32-0-387" id="h32-0-387" class="i">+                            }
</a><a href="#h32-0-388" id="h32-0-388" class="i">+                        }
</a><a href="#h32-0-389" id="h32-0-389" class="i">+                    )
</a><a href="#h32-0-390" id="h32-0-390" class="i">+                }
</a><a href="#h32-0-391" id="h32-0-391" class="i">+            }
</a><a href="#h32-0-392" id="h32-0-392" class="i">+
</a><a href="#h32-0-393" id="h32-0-393" class="i">+            item {
</a><a href="#h32-0-394" id="h32-0-394" class="i">+                if (events.isEmpty()) {
</a><a href="#h32-0-395" id="h32-0-395" class="i">+                    Text(&quot;No events&quot;, fontSize = 12.sp, fontWeight = FontWeight.Light, modifier = Modifier
</a><a href="#h32-0-396" id="h32-0-396" class="i">+                        .padding(10.dp)
</a><a href="#h32-0-397" id="h32-0-397" class="i">+                        .fillMaxWidth(), textAlign = TextAlign.Center)
</a><a href="#h32-0-398" id="h32-0-398" class="i">+                }
</a><a href="#h32-0-399" id="h32-0-399" class="i">+            }
</a><a href="#h32-0-400" id="h32-0-400" class="i">+
</a><a href="#h32-0-401" id="h32-0-401" class="i">+            items(events) { event -&gt;
</a><a href="#h32-0-402" id="h32-0-402" class="i">+                var expanded by remember { mutableStateOf(false) }
</a><a href="#h32-0-403" id="h32-0-403" class="i">+
</a><a href="#h32-0-404" id="h32-0-404" class="i">+                ElevatedCard(
</a><a href="#h32-0-405" id="h32-0-405" class="i">+                    modifier = Modifier
</a><a href="#h32-0-406" id="h32-0-406" class="i">+                        .fillMaxWidth()
</a><a href="#h32-0-407" id="h32-0-407" class="i">+                        .clip(MaterialTheme.shapes.medium)
</a><a href="#h32-0-408" id="h32-0-408" class="i">+                        .padding(4.dp),
</a><a href="#h32-0-409" id="h32-0-409" class="i">+                    onClick = { expanded = !expanded }
</a><a href="#h32-0-410" id="h32-0-410" class="i">+                ) {
</a><a href="#h32-0-411" id="h32-0-411" class="i">+                    Column {
</a><a href="#h32-0-412" id="h32-0-412" class="i">+                        Row(
</a><a href="#h32-0-413" id="h32-0-413" class="i">+                            modifier = Modifier
</a><a href="#h32-0-414" id="h32-0-414" class="i">+                                .fillMaxWidth()
</a><a href="#h32-0-415" id="h32-0-415" class="i">+                                .padding(10.dp),
</a><a href="#h32-0-416" id="h32-0-416" class="i">+                            horizontalArrangement = Arrangement.SpaceBetween,
</a><a href="#h32-0-417" id="h32-0-417" class="i">+                            verticalAlignment = Alignment.CenterVertically
</a><a href="#h32-0-418" id="h32-0-418" class="i">+                        ) {
</a><a href="#h32-0-419" id="h32-0-419" class="i">+                            Row(
</a><a href="#h32-0-420" id="h32-0-420" class="i">+                                modifier = Modifier.weight(1f, fill = false),
</a><a href="#h32-0-421" id="h32-0-421" class="i">+                                horizontalArrangement = Arrangement.spacedBy(6.dp),
</a><a href="#h32-0-422" id="h32-0-422" class="i">+                                verticalAlignment = Alignment.CenterVertically,
</a><a href="#h32-0-423" id="h32-0-423" class="i">+                            ) {
</a><a href="#h32-0-424" id="h32-0-424" class="i">+                                Icon(
</a><a href="#h32-0-425" id="h32-0-425" class="i">+                                    if (expanded) Icons.Default.ExpandLess else Icons.Default.ExpandMore,
</a><a href="#h32-0-426" id="h32-0-426" class="i">+                                    contentDescription = null,
</a><a href="#h32-0-427" id="h32-0-427" class="i">+                                    modifier = Modifier.size(24.dp)
</a><a href="#h32-0-428" id="h32-0-428" class="i">+                                )
</a><a href="#h32-0-429" id="h32-0-429" class="i">+                                Column {
</a><a href="#h32-0-430" id="h32-0-430" class="i">+                                    Text(event.eventType, lineHeight = 20.sp, fontSize = 18.sp, fontWeight = FontWeight.Bold)
</a><a href="#h32-0-431" id="h32-0-431" class="i">+                                    Text(text = event.actions.joinToString(&quot;, &quot;) { it.name }, fontSize = 10.sp, fontWeight = FontWeight.Light, overflow = TextOverflow.Ellipsis, maxLines = 1, lineHeight = 14.sp)
</a><a href="#h32-0-432" id="h32-0-432" class="i">+                                }
</a><a href="#h32-0-433" id="h32-0-433" class="i">+                            }
</a><a href="#h32-0-434" id="h32-0-434" class="i">+                            OutlinedIconButton(
</a><a href="#h32-0-435" id="h32-0-435" class="i">+                                onClick = {
</a><a href="#h32-0-436" id="h32-0-436" class="i">+                                    if (event.id &gt; -1) {
</a><a href="#h32-0-437" id="h32-0-437" class="i">+                                        context.database.deleteTrackerRuleEvent(event.id)
</a><a href="#h32-0-438" id="h32-0-438" class="i">+                                    }
</a><a href="#h32-0-439" id="h32-0-439" class="i">+                                    events.remove(event)
</a><a href="#h32-0-440" id="h32-0-440" class="i">+                                }
</a><a href="#h32-0-441" id="h32-0-441" class="i">+                            ) {
</a><a href="#h32-0-442" id="h32-0-442" class="i">+                                Icon(Icons.Default.DeleteOutline, contentDescription = &quot;Delete&quot;)
</a><a href="#h32-0-443" id="h32-0-443" class="i">+                            }
</a><a href="#h32-0-444" id="h32-0-444" class="i">+                        }
</a><a href="#h32-0-445" id="h32-0-445" class="i">+                        if (expanded) {
</a><a href="#h32-0-446" id="h32-0-446" class="i">+                            Column(
</a><a href="#h32-0-447" id="h32-0-447" class="i">+                                modifier = Modifier.padding(10.dp)
</a><a href="#h32-0-448" id="h32-0-448" class="i">+                            ) {
</a><a href="#h32-0-449" id="h32-0-449" class="i">+                                ConditionCheckboxes(event.params)
</a><a href="#h32-0-450" id="h32-0-450" class="i">+                            }
</a><a href="#h32-0-451" id="h32-0-451" class="i">+                        }
</a><a href="#h32-0-452" id="h32-0-452" class="i">+                    }
</a><a href="#h32-0-453" id="h32-0-453" class="i">+                }
</a><a href="#h32-0-454" id="h32-0-454" class="i">+            }
</a><a href="#h32-0-455" id="h32-0-455" class="i">+
</a><a href="#h32-0-456" id="h32-0-456" class="i">+            item {
</a><a href="#h32-0-457" id="h32-0-457" class="i">+                Spacer(modifier = Modifier.height(140.dp))
</a><a href="#h32-0-458" id="h32-0-458" class="i">+            }
</a><a href="#h32-0-459" id="h32-0-459" class="i">+        }
</a><a href="#h32-0-460" id="h32-0-460" class="i">+    }
</a><a href="#h32-0-461" id="h32-0-461" class="i">+}
</a><a href="#h32-0-462" id="h32-0-462" class="i">+
</a><b>diff --git a/<a id="h33" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/tracker/FriendTrackerManagerRoot.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/tracker/FriendTrackerManagerRoot.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/tracker/FriendTrackerManagerRoot.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/tracker/FriendTrackerManagerRoot.kt</a></b>
<a href="#h33-0" id="h33-0" class="h">@@ -0,0 +1,470 @@
</a><a href="#h33-0-0" id="h33-0-0" class="i">+package me.rhunk.snapenhance.ui.manager.pages.tracker
</a><a href="#h33-0-1" id="h33-0-1" class="i">+
</a><a href="#h33-0-2" id="h33-0-2" class="i">+import androidx.compose.foundation.BorderStroke
</a><a href="#h33-0-3" id="h33-0-3" class="i">+import androidx.compose.foundation.ExperimentalFoundationApi
</a><a href="#h33-0-4" id="h33-0-4" class="i">+import androidx.compose.foundation.background
</a><a href="#h33-0-5" id="h33-0-5" class="i">+import androidx.compose.foundation.border
</a><a href="#h33-0-6" id="h33-0-6" class="i">+import androidx.compose.foundation.clickable
</a><a href="#h33-0-7" id="h33-0-7" class="i">+import androidx.compose.foundation.layout.*
</a><a href="#h33-0-8" id="h33-0-8" class="i">+import androidx.compose.foundation.lazy.LazyColumn
</a><a href="#h33-0-9" id="h33-0-9" class="i">+import androidx.compose.foundation.lazy.items
</a><a href="#h33-0-10" id="h33-0-10" class="i">+import androidx.compose.foundation.pager.HorizontalPager
</a><a href="#h33-0-11" id="h33-0-11" class="i">+import androidx.compose.foundation.pager.rememberPagerState
</a><a href="#h33-0-12" id="h33-0-12" class="i">+import androidx.compose.foundation.shape.CircleShape
</a><a href="#h33-0-13" id="h33-0-13" class="i">+import androidx.compose.foundation.shape.RoundedCornerShape
</a><a href="#h33-0-14" id="h33-0-14" class="i">+import androidx.compose.material.icons.Icons
</a><a href="#h33-0-15" id="h33-0-15" class="i">+import androidx.compose.material.icons.filled.Add
</a><a href="#h33-0-16" id="h33-0-16" class="i">+import androidx.compose.material.icons.filled.Clear
</a><a href="#h33-0-17" id="h33-0-17" class="i">+import androidx.compose.material.icons.filled.DeleteOutline
</a><a href="#h33-0-18" id="h33-0-18" class="i">+import androidx.compose.material3.*
</a><a href="#h33-0-19" id="h33-0-19" class="i">+import androidx.compose.runtime.*
</a><a href="#h33-0-20" id="h33-0-20" class="i">+import androidx.compose.ui.Alignment
</a><a href="#h33-0-21" id="h33-0-21" class="i">+import androidx.compose.ui.Modifier
</a><a href="#h33-0-22" id="h33-0-22" class="i">+import androidx.compose.ui.draw.clip
</a><a href="#h33-0-23" id="h33-0-23" class="i">+import androidx.compose.ui.graphics.Color
</a><a href="#h33-0-24" id="h33-0-24" class="i">+import androidx.compose.ui.text.font.FontWeight
</a><a href="#h33-0-25" id="h33-0-25" class="i">+import androidx.compose.ui.text.style.TextAlign
</a><a href="#h33-0-26" id="h33-0-26" class="i">+import androidx.compose.ui.text.style.TextOverflow
</a><a href="#h33-0-27" id="h33-0-27" class="i">+import androidx.compose.ui.unit.dp
</a><a href="#h33-0-28" id="h33-0-28" class="i">+import androidx.compose.ui.unit.sp
</a><a href="#h33-0-29" id="h33-0-29" class="i">+import androidx.compose.ui.window.PopupProperties
</a><a href="#h33-0-30" id="h33-0-30" class="i">+import androidx.navigation.NavBackStackEntry
</a><a href="#h33-0-31" id="h33-0-31" class="i">+import kotlinx.coroutines.Dispatchers
</a><a href="#h33-0-32" id="h33-0-32" class="i">+import kotlinx.coroutines.Job
</a><a href="#h33-0-33" id="h33-0-33" class="i">+import kotlinx.coroutines.delay
</a><a href="#h33-0-34" id="h33-0-34" class="i">+import kotlinx.coroutines.launch
</a><a href="#h33-0-35" id="h33-0-35" class="i">+import kotlinx.coroutines.withContext
</a><a href="#h33-0-36" id="h33-0-36" class="i">+import me.rhunk.snapenhance.common.bridge.wrapper.TrackerLog
</a><a href="#h33-0-37" id="h33-0-37" class="i">+import me.rhunk.snapenhance.common.data.MessagingFriendInfo
</a><a href="#h33-0-38" id="h33-0-38" class="i">+import me.rhunk.snapenhance.common.data.TrackerEventType
</a><a href="#h33-0-39" id="h33-0-39" class="i">+import me.rhunk.snapenhance.common.ui.rememberAsyncMutableState
</a><a href="#h33-0-40" id="h33-0-40" class="i">+import me.rhunk.snapenhance.common.ui.rememberAsyncMutableStateList
</a><a href="#h33-0-41" id="h33-0-41" class="i">+import me.rhunk.snapenhance.common.ui.rememberAsyncUpdateDispatcher
</a><a href="#h33-0-42" id="h33-0-42" class="i">+import me.rhunk.snapenhance.common.util.snap.BitmojiSelfie
</a><a href="#h33-0-43" id="h33-0-43" class="i">+import me.rhunk.snapenhance.storage.*
</a><a href="#h33-0-44" id="h33-0-44" class="i">+import me.rhunk.snapenhance.ui.manager.Routes
</a><a href="#h33-0-45" id="h33-0-45" class="i">+import me.rhunk.snapenhance.ui.util.coil.BitmojiImage
</a><a href="#h33-0-46" id="h33-0-46" class="i">+import me.rhunk.snapenhance.ui.util.pagerTabIndicatorOffset
</a><a href="#h33-0-47" id="h33-0-47" class="i">+import java.text.DateFormat
</a><a href="#h33-0-48" id="h33-0-48" class="i">+
</a><a href="#h33-0-49" id="h33-0-49" class="i">+
</a><a href="#h33-0-50" id="h33-0-50" class="i">+@OptIn(ExperimentalFoundationApi::class)
</a><a href="#h33-0-51" id="h33-0-51" class="i">+class FriendTrackerManagerRoot : Routes.Route() {
</a><a href="#h33-0-52" id="h33-0-52" class="i">+    enum class FilterType {
</a><a href="#h33-0-53" id="h33-0-53" class="i">+        CONVERSATION, USERNAME, EVENT
</a><a href="#h33-0-54" id="h33-0-54" class="i">+    }
</a><a href="#h33-0-55" id="h33-0-55" class="i">+
</a><a href="#h33-0-56" id="h33-0-56" class="i">+    private val titles = listOf(&quot;Logs&quot;, &quot;Rules&quot;)
</a><a href="#h33-0-57" id="h33-0-57" class="i">+    private var currentPage by mutableIntStateOf(0)
</a><a href="#h33-0-58" id="h33-0-58" class="i">+
</a><a href="#h33-0-59" id="h33-0-59" class="i">+    override val floatingActionButton: @Composable () -&gt; Unit = {
</a><a href="#h33-0-60" id="h33-0-60" class="i">+        if (currentPage == 1) {
</a><a href="#h33-0-61" id="h33-0-61" class="i">+            ExtendedFloatingActionButton(
</a><a href="#h33-0-62" id="h33-0-62" class="i">+                icon = { Icon(Icons.Default.Add, contentDescription = &quot;Add Rule&quot;) },
</a><a href="#h33-0-63" id="h33-0-63" class="i">+                expanded = true,
</a><a href="#h33-0-64" id="h33-0-64" class="i">+                text = { Text(&quot;Add Rule&quot;) },
</a><a href="#h33-0-65" id="h33-0-65" class="i">+                onClick = { routes.editRule.navigate() }
</a><a href="#h33-0-66" id="h33-0-66" class="i">+            )
</a><a href="#h33-0-67" id="h33-0-67" class="i">+        }
</a><a href="#h33-0-68" id="h33-0-68" class="i">+    }
</a><a href="#h33-0-69" id="h33-0-69" class="i">+
</a><a href="#h33-0-70" id="h33-0-70" class="i">+    @OptIn(ExperimentalMaterial3Api::class)
</a><a href="#h33-0-71" id="h33-0-71" class="i">+    @Composable
</a><a href="#h33-0-72" id="h33-0-72" class="i">+    private fun LogsTab() {
</a><a href="#h33-0-73" id="h33-0-73" class="i">+        val coroutineScope = rememberCoroutineScope()
</a><a href="#h33-0-74" id="h33-0-74" class="i">+
</a><a href="#h33-0-75" id="h33-0-75" class="i">+        val logs = remember { mutableStateListOf&lt;TrackerLog&gt;() }
</a><a href="#h33-0-76" id="h33-0-76" class="i">+        var lastTimestamp by remember { mutableLongStateOf(Long.MAX_VALUE) }
</a><a href="#h33-0-77" id="h33-0-77" class="i">+        var filterType by remember { mutableStateOf(FilterType.USERNAME) }
</a><a href="#h33-0-78" id="h33-0-78" class="i">+
</a><a href="#h33-0-79" id="h33-0-79" class="i">+        var filter by remember { mutableStateOf(&quot;&quot;) }
</a><a href="#h33-0-80" id="h33-0-80" class="i">+        var searchTimeoutJob by remember { mutableStateOf&lt;Job?&gt;(null) }
</a><a href="#h33-0-81" id="h33-0-81" class="i">+
</a><a href="#h33-0-82" id="h33-0-82" class="i">+        suspend fun loadNewLogs() {
</a><a href="#h33-0-83" id="h33-0-83" class="i">+            withContext(Dispatchers.IO) {
</a><a href="#h33-0-84" id="h33-0-84" class="i">+                logs.addAll(context.messageLogger.getLogs(lastTimestamp, filter = {
</a><a href="#h33-0-85" id="h33-0-85" class="i">+                    when (filterType) {
</a><a href="#h33-0-86" id="h33-0-86" class="i">+                        FilterType.USERNAME -&gt; it.username.contains(filter, ignoreCase = true)
</a><a href="#h33-0-87" id="h33-0-87" class="i">+                        FilterType.CONVERSATION -&gt; it.conversationTitle?.contains(filter, ignoreCase = true) == true || (it.username == filter &amp;&amp; !it.isGroup)
</a><a href="#h33-0-88" id="h33-0-88" class="i">+                        FilterType.EVENT -&gt; it.eventType.contains(filter, ignoreCase = true)
</a><a href="#h33-0-89" id="h33-0-89" class="i">+                    }
</a><a href="#h33-0-90" id="h33-0-90" class="i">+                }).apply {
</a><a href="#h33-0-91" id="h33-0-91" class="i">+                    lastTimestamp = minOfOrNull { it.timestamp } ?: lastTimestamp
</a><a href="#h33-0-92" id="h33-0-92" class="i">+                })
</a><a href="#h33-0-93" id="h33-0-93" class="i">+            }
</a><a href="#h33-0-94" id="h33-0-94" class="i">+        }
</a><a href="#h33-0-95" id="h33-0-95" class="i">+
</a><a href="#h33-0-96" id="h33-0-96" class="i">+        suspend fun resetAndLoadLogs() {
</a><a href="#h33-0-97" id="h33-0-97" class="i">+            logs.clear()
</a><a href="#h33-0-98" id="h33-0-98" class="i">+            lastTimestamp = Long.MAX_VALUE
</a><a href="#h33-0-99" id="h33-0-99" class="i">+            loadNewLogs()
</a><a href="#h33-0-100" id="h33-0-100" class="i">+        }
</a><a href="#h33-0-101" id="h33-0-101" class="i">+
</a><a href="#h33-0-102" id="h33-0-102" class="i">+        Column(
</a><a href="#h33-0-103" id="h33-0-103" class="i">+            modifier = Modifier.fillMaxSize()
</a><a href="#h33-0-104" id="h33-0-104" class="i">+        ) {
</a><a href="#h33-0-105" id="h33-0-105" class="i">+            Row(
</a><a href="#h33-0-106" id="h33-0-106" class="i">+                modifier = Modifier.fillMaxWidth(),
</a><a href="#h33-0-107" id="h33-0-107" class="i">+                verticalAlignment = Alignment.CenterVertically,
</a><a href="#h33-0-108" id="h33-0-108" class="i">+            ) {
</a><a href="#h33-0-109" id="h33-0-109" class="i">+                var showAutoComplete by remember { mutableStateOf(false) }
</a><a href="#h33-0-110" id="h33-0-110" class="i">+                var dropDownExpanded by remember { mutableStateOf(false) }
</a><a href="#h33-0-111" id="h33-0-111" class="i">+
</a><a href="#h33-0-112" id="h33-0-112" class="i">+                ExposedDropdownMenuBox(
</a><a href="#h33-0-113" id="h33-0-113" class="i">+                    expanded = showAutoComplete,
</a><a href="#h33-0-114" id="h33-0-114" class="i">+                    onExpandedChange = { showAutoComplete = it },
</a><a href="#h33-0-115" id="h33-0-115" class="i">+                ) {
</a><a href="#h33-0-116" id="h33-0-116" class="i">+                    TextField(
</a><a href="#h33-0-117" id="h33-0-117" class="i">+                        value = filter,
</a><a href="#h33-0-118" id="h33-0-118" class="i">+                        modifier = Modifier
</a><a href="#h33-0-119" id="h33-0-119" class="i">+                            .fillMaxWidth()
</a><a href="#h33-0-120" id="h33-0-120" class="i">+                            .menuAnchor()
</a><a href="#h33-0-121" id="h33-0-121" class="i">+                            .padding(8.dp),
</a><a href="#h33-0-122" id="h33-0-122" class="i">+                        onValueChange = {
</a><a href="#h33-0-123" id="h33-0-123" class="i">+                            filter = it
</a><a href="#h33-0-124" id="h33-0-124" class="i">+                            coroutineScope.launch {
</a><a href="#h33-0-125" id="h33-0-125" class="i">+                                searchTimeoutJob?.cancel()
</a><a href="#h33-0-126" id="h33-0-126" class="i">+                                searchTimeoutJob = coroutineScope.launch {
</a><a href="#h33-0-127" id="h33-0-127" class="i">+                                    delay(200)
</a><a href="#h33-0-128" id="h33-0-128" class="i">+                                    showAutoComplete = true
</a><a href="#h33-0-129" id="h33-0-129" class="i">+                                    resetAndLoadLogs()
</a><a href="#h33-0-130" id="h33-0-130" class="i">+                                }
</a><a href="#h33-0-131" id="h33-0-131" class="i">+                            }
</a><a href="#h33-0-132" id="h33-0-132" class="i">+                        },
</a><a href="#h33-0-133" id="h33-0-133" class="i">+                        placeholder = { Text(&quot;Search&quot;) },
</a><a href="#h33-0-134" id="h33-0-134" class="i">+                        colors = TextFieldDefaults.colors(
</a><a href="#h33-0-135" id="h33-0-135" class="i">+                            focusedContainerColor = Color.Transparent,
</a><a href="#h33-0-136" id="h33-0-136" class="i">+                            unfocusedContainerColor = Color.Transparent
</a><a href="#h33-0-137" id="h33-0-137" class="i">+                        ),
</a><a href="#h33-0-138" id="h33-0-138" class="i">+                        maxLines = 1,
</a><a href="#h33-0-139" id="h33-0-139" class="i">+                        leadingIcon = {
</a><a href="#h33-0-140" id="h33-0-140" class="i">+                            ExposedDropdownMenuBox(
</a><a href="#h33-0-141" id="h33-0-141" class="i">+                                expanded = dropDownExpanded,
</a><a href="#h33-0-142" id="h33-0-142" class="i">+                                onExpandedChange = { dropDownExpanded = it },
</a><a href="#h33-0-143" id="h33-0-143" class="i">+                            ) {
</a><a href="#h33-0-144" id="h33-0-144" class="i">+                                ElevatedCard(
</a><a href="#h33-0-145" id="h33-0-145" class="i">+                                    modifier = Modifier
</a><a href="#h33-0-146" id="h33-0-146" class="i">+                                        .menuAnchor()
</a><a href="#h33-0-147" id="h33-0-147" class="i">+                                        .padding(2.dp)
</a><a href="#h33-0-148" id="h33-0-148" class="i">+                                ) {
</a><a href="#h33-0-149" id="h33-0-149" class="i">+                                    Text(filterType.name, modifier = Modifier.padding(8.dp))
</a><a href="#h33-0-150" id="h33-0-150" class="i">+                                }
</a><a href="#h33-0-151" id="h33-0-151" class="i">+                                DropdownMenu(expanded = dropDownExpanded, onDismissRequest = {
</a><a href="#h33-0-152" id="h33-0-152" class="i">+                                    dropDownExpanded = false
</a><a href="#h33-0-153" id="h33-0-153" class="i">+                                }) {
</a><a href="#h33-0-154" id="h33-0-154" class="i">+                                    FilterType.entries.forEach { type -&gt;
</a><a href="#h33-0-155" id="h33-0-155" class="i">+                                        DropdownMenuItem(onClick = {
</a><a href="#h33-0-156" id="h33-0-156" class="i">+                                            filter = &quot;&quot;
</a><a href="#h33-0-157" id="h33-0-157" class="i">+                                            filterType = type
</a><a href="#h33-0-158" id="h33-0-158" class="i">+                                            dropDownExpanded = false
</a><a href="#h33-0-159" id="h33-0-159" class="i">+                                            coroutineScope.launch {
</a><a href="#h33-0-160" id="h33-0-160" class="i">+                                                resetAndLoadLogs()
</a><a href="#h33-0-161" id="h33-0-161" class="i">+                                            }
</a><a href="#h33-0-162" id="h33-0-162" class="i">+                                        }, text = {
</a><a href="#h33-0-163" id="h33-0-163" class="i">+                                            Text(type.name)
</a><a href="#h33-0-164" id="h33-0-164" class="i">+                                        })
</a><a href="#h33-0-165" id="h33-0-165" class="i">+                                    }
</a><a href="#h33-0-166" id="h33-0-166" class="i">+                                }
</a><a href="#h33-0-167" id="h33-0-167" class="i">+                            }
</a><a href="#h33-0-168" id="h33-0-168" class="i">+                        },
</a><a href="#h33-0-169" id="h33-0-169" class="i">+                        trailingIcon = {
</a><a href="#h33-0-170" id="h33-0-170" class="i">+                            if (filter != &quot;&quot;) {
</a><a href="#h33-0-171" id="h33-0-171" class="i">+                                IconButton(onClick = {
</a><a href="#h33-0-172" id="h33-0-172" class="i">+                                    filter = &quot;&quot;
</a><a href="#h33-0-173" id="h33-0-173" class="i">+                                    coroutineScope.launch {
</a><a href="#h33-0-174" id="h33-0-174" class="i">+                                        resetAndLoadLogs()
</a><a href="#h33-0-175" id="h33-0-175" class="i">+                                    }
</a><a href="#h33-0-176" id="h33-0-176" class="i">+                                }) {
</a><a href="#h33-0-177" id="h33-0-177" class="i">+                                    Icon(Icons.Default.Clear, contentDescription = &quot;Clear&quot;)
</a><a href="#h33-0-178" id="h33-0-178" class="i">+                                }
</a><a href="#h33-0-179" id="h33-0-179" class="i">+                            }
</a><a href="#h33-0-180" id="h33-0-180" class="i">+
</a><a href="#h33-0-181" id="h33-0-181" class="i">+                            DropdownMenu(
</a><a href="#h33-0-182" id="h33-0-182" class="i">+                                expanded = showAutoComplete,
</a><a href="#h33-0-183" id="h33-0-183" class="i">+                                onDismissRequest = {
</a><a href="#h33-0-184" id="h33-0-184" class="i">+                                    showAutoComplete = false
</a><a href="#h33-0-185" id="h33-0-185" class="i">+                                },
</a><a href="#h33-0-186" id="h33-0-186" class="i">+                                properties = PopupProperties(focusable = false),
</a><a href="#h33-0-187" id="h33-0-187" class="i">+                            ) {
</a><a href="#h33-0-188" id="h33-0-188" class="i">+                                val suggestedEntries = remember(filter) {
</a><a href="#h33-0-189" id="h33-0-189" class="i">+                                    mutableStateListOf&lt;String&gt;()
</a><a href="#h33-0-190" id="h33-0-190" class="i">+                                }
</a><a href="#h33-0-191" id="h33-0-191" class="i">+
</a><a href="#h33-0-192" id="h33-0-192" class="i">+                                LaunchedEffect(filter) {
</a><a href="#h33-0-193" id="h33-0-193" class="i">+                                    launch(Dispatchers.IO) {
</a><a href="#h33-0-194" id="h33-0-194" class="i">+                                        suggestedEntries.addAll(when (filterType) {
</a><a href="#h33-0-195" id="h33-0-195" class="i">+                                            FilterType.USERNAME -&gt; context.messageLogger.findUsername(filter)
</a><a href="#h33-0-196" id="h33-0-196" class="i">+                                            FilterType.CONVERSATION -&gt; context.messageLogger.findConversation(filter) + context.messageLogger.findUsername(filter)
</a><a href="#h33-0-197" id="h33-0-197" class="i">+                                            FilterType.EVENT -&gt; TrackerEventType.entries.filter { it.name.contains(filter, ignoreCase = true) }.map { it.key }
</a><a href="#h33-0-198" id="h33-0-198" class="i">+                                        }.take(5))
</a><a href="#h33-0-199" id="h33-0-199" class="i">+                                    }
</a><a href="#h33-0-200" id="h33-0-200" class="i">+                                }
</a><a href="#h33-0-201" id="h33-0-201" class="i">+
</a><a href="#h33-0-202" id="h33-0-202" class="i">+                                suggestedEntries.forEach { entry -&gt;
</a><a href="#h33-0-203" id="h33-0-203" class="i">+                                    DropdownMenuItem(onClick = {
</a><a href="#h33-0-204" id="h33-0-204" class="i">+                                        filter = entry
</a><a href="#h33-0-205" id="h33-0-205" class="i">+                                        coroutineScope.launch {
</a><a href="#h33-0-206" id="h33-0-206" class="i">+                                            resetAndLoadLogs()
</a><a href="#h33-0-207" id="h33-0-207" class="i">+                                        }
</a><a href="#h33-0-208" id="h33-0-208" class="i">+                                        showAutoComplete = false
</a><a href="#h33-0-209" id="h33-0-209" class="i">+                                    }, text = {
</a><a href="#h33-0-210" id="h33-0-210" class="i">+                                        Text(entry)
</a><a href="#h33-0-211" id="h33-0-211" class="i">+                                    })
</a><a href="#h33-0-212" id="h33-0-212" class="i">+                                }
</a><a href="#h33-0-213" id="h33-0-213" class="i">+                            }
</a><a href="#h33-0-214" id="h33-0-214" class="i">+                        },
</a><a href="#h33-0-215" id="h33-0-215" class="i">+                    )
</a><a href="#h33-0-216" id="h33-0-216" class="i">+                }
</a><a href="#h33-0-217" id="h33-0-217" class="i">+            }
</a><a href="#h33-0-218" id="h33-0-218" class="i">+
</a><a href="#h33-0-219" id="h33-0-219" class="i">+            LazyColumn(
</a><a href="#h33-0-220" id="h33-0-220" class="i">+                modifier = Modifier.weight(1f)
</a><a href="#h33-0-221" id="h33-0-221" class="i">+            ) {
</a><a href="#h33-0-222" id="h33-0-222" class="i">+                item {
</a><a href="#h33-0-223" id="h33-0-223" class="i">+                    if (logs.isEmpty()) {
</a><a href="#h33-0-224" id="h33-0-224" class="i">+                        Text(&quot;No logs found&quot;, modifier = Modifier
</a><a href="#h33-0-225" id="h33-0-225" class="i">+                            .padding(16.dp)
</a><a href="#h33-0-226" id="h33-0-226" class="i">+                            .fillMaxWidth(), textAlign = TextAlign.Center, fontWeight = FontWeight.Light)
</a><a href="#h33-0-227" id="h33-0-227" class="i">+                    }
</a><a href="#h33-0-228" id="h33-0-228" class="i">+                }
</a><a href="#h33-0-229" id="h33-0-229" class="i">+                items(logs, key = { it.userId + it.id }) { log -&gt;
</a><a href="#h33-0-230" id="h33-0-230" class="i">+                    ElevatedCard(
</a><a href="#h33-0-231" id="h33-0-231" class="i">+                        modifier = Modifier
</a><a href="#h33-0-232" id="h33-0-232" class="i">+                            .fillMaxWidth()
</a><a href="#h33-0-233" id="h33-0-233" class="i">+                            .padding(5.dp)
</a><a href="#h33-0-234" id="h33-0-234" class="i">+                    ) {
</a><a href="#h33-0-235" id="h33-0-235" class="i">+                        Row(
</a><a href="#h33-0-236" id="h33-0-236" class="i">+                            modifier = Modifier
</a><a href="#h33-0-237" id="h33-0-237" class="i">+                                .fillMaxWidth()
</a><a href="#h33-0-238" id="h33-0-238" class="i">+                                .padding(4.dp),
</a><a href="#h33-0-239" id="h33-0-239" class="i">+                            verticalAlignment = Alignment.CenterVertically
</a><a href="#h33-0-240" id="h33-0-240" class="i">+                        ) {
</a><a href="#h33-0-241" id="h33-0-241" class="i">+                            var databaseFriend by remember { mutableStateOf&lt;MessagingFriendInfo?&gt;(null) }
</a><a href="#h33-0-242" id="h33-0-242" class="i">+
</a><a href="#h33-0-243" id="h33-0-243" class="i">+                            LaunchedEffect(Unit) {
</a><a href="#h33-0-244" id="h33-0-244" class="i">+                                launch(Dispatchers.IO) {
</a><a href="#h33-0-245" id="h33-0-245" class="i">+                                    databaseFriend = context.database.getFriendInfo(log.userId)
</a><a href="#h33-0-246" id="h33-0-246" class="i">+                                }
</a><a href="#h33-0-247" id="h33-0-247" class="i">+                            }
</a><a href="#h33-0-248" id="h33-0-248" class="i">+                            BitmojiImage(
</a><a href="#h33-0-249" id="h33-0-249" class="i">+                                modifier = Modifier.padding(10.dp),
</a><a href="#h33-0-250" id="h33-0-250" class="i">+                                size = 70,
</a><a href="#h33-0-251" id="h33-0-251" class="i">+                                context = context,
</a><a href="#h33-0-252" id="h33-0-252" class="i">+                                url = databaseFriend?.takeIf { it.bitmojiId != null }?.let {
</a><a href="#h33-0-253" id="h33-0-253" class="i">+                                    BitmojiSelfie.getBitmojiSelfie(it.selfieId, it.bitmojiId, BitmojiSelfie.BitmojiSelfieType.NEW_THREE_D)
</a><a href="#h33-0-254" id="h33-0-254" class="i">+                                },
</a><a href="#h33-0-255" id="h33-0-255" class="i">+                            )
</a><a href="#h33-0-256" id="h33-0-256" class="i">+
</a><a href="#h33-0-257" id="h33-0-257" class="i">+                            Column(
</a><a href="#h33-0-258" id="h33-0-258" class="i">+                                modifier = Modifier
</a><a href="#h33-0-259" id="h33-0-259" class="i">+                                    .weight(1f),
</a><a href="#h33-0-260" id="h33-0-260" class="i">+                            ) {
</a><a href="#h33-0-261" id="h33-0-261" class="i">+                                Text(databaseFriend?.displayName?.let {
</a><a href="#h33-0-262" id="h33-0-262" class="i">+                                    &quot;$it (${log.username})&quot;
</a><a href="#h33-0-263" id="h33-0-263" class="i">+                                } ?: log.username, lineHeight = 20.sp, fontWeight = FontWeight.Bold, maxLines = 1, overflow = TextOverflow.Ellipsis)
</a><a href="#h33-0-264" id="h33-0-264" class="i">+                                Text(&quot;${log.eventType} in ${log.conversationTitle}&quot;, fontSize = 15.sp, fontWeight = FontWeight.Light, lineHeight = 20.sp, maxLines = 1, overflow = TextOverflow.Ellipsis)
</a><a href="#h33-0-265" id="h33-0-265" class="i">+                                Text(
</a><a href="#h33-0-266" id="h33-0-266" class="i">+                                    DateFormat.getDateTimeInstance().format(log.timestamp),
</a><a href="#h33-0-267" id="h33-0-267" class="i">+                                    fontSize = 10.sp,
</a><a href="#h33-0-268" id="h33-0-268" class="i">+                                    fontWeight = FontWeight.Light,
</a><a href="#h33-0-269" id="h33-0-269" class="i">+                                    lineHeight = 15.sp,
</a><a href="#h33-0-270" id="h33-0-270" class="i">+                                )
</a><a href="#h33-0-271" id="h33-0-271" class="i">+                            }
</a><a href="#h33-0-272" id="h33-0-272" class="i">+
</a><a href="#h33-0-273" id="h33-0-273" class="i">+                            OutlinedIconButton(
</a><a href="#h33-0-274" id="h33-0-274" class="i">+                                onClick = {
</a><a href="#h33-0-275" id="h33-0-275" class="i">+                                    context.messageLogger.deleteTrackerLog(log.id)
</a><a href="#h33-0-276" id="h33-0-276" class="i">+                                    logs.remove(log)
</a><a href="#h33-0-277" id="h33-0-277" class="i">+                                }
</a><a href="#h33-0-278" id="h33-0-278" class="i">+                            ) {
</a><a href="#h33-0-279" id="h33-0-279" class="i">+                                Icon(Icons.Default.DeleteOutline, contentDescription = &quot;Delete&quot;)
</a><a href="#h33-0-280" id="h33-0-280" class="i">+                            }
</a><a href="#h33-0-281" id="h33-0-281" class="i">+                        }
</a><a href="#h33-0-282" id="h33-0-282" class="i">+                    }
</a><a href="#h33-0-283" id="h33-0-283" class="i">+                }
</a><a href="#h33-0-284" id="h33-0-284" class="i">+                item {
</a><a href="#h33-0-285" id="h33-0-285" class="i">+                    Spacer(modifier = Modifier.height(16.dp))
</a><a href="#h33-0-286" id="h33-0-286" class="i">+
</a><a href="#h33-0-287" id="h33-0-287" class="i">+                    LaunchedEffect(lastTimestamp) {
</a><a href="#h33-0-288" id="h33-0-288" class="i">+                        loadNewLogs()
</a><a href="#h33-0-289" id="h33-0-289" class="i">+                    }
</a><a href="#h33-0-290" id="h33-0-290" class="i">+                }
</a><a href="#h33-0-291" id="h33-0-291" class="i">+            }
</a><a href="#h33-0-292" id="h33-0-292" class="i">+        }
</a><a href="#h33-0-293" id="h33-0-293" class="i">+
</a><a href="#h33-0-294" id="h33-0-294" class="i">+    }
</a><a href="#h33-0-295" id="h33-0-295" class="i">+
</a><a href="#h33-0-296" id="h33-0-296" class="i">+    @Composable
</a><a href="#h33-0-297" id="h33-0-297" class="i">+    private fun ConfigRulesTab() {
</a><a href="#h33-0-298" id="h33-0-298" class="i">+        val updateRules = rememberAsyncUpdateDispatcher()
</a><a href="#h33-0-299" id="h33-0-299" class="i">+        val rules = rememberAsyncMutableStateList(defaultValue = listOf(), updateDispatcher = updateRules) {
</a><a href="#h33-0-300" id="h33-0-300" class="i">+            context.database.getTrackerRulesDesc()
</a><a href="#h33-0-301" id="h33-0-301" class="i">+        }
</a><a href="#h33-0-302" id="h33-0-302" class="i">+
</a><a href="#h33-0-303" id="h33-0-303" class="i">+        Column(
</a><a href="#h33-0-304" id="h33-0-304" class="i">+            modifier = Modifier.fillMaxSize()
</a><a href="#h33-0-305" id="h33-0-305" class="i">+        ) {
</a><a href="#h33-0-306" id="h33-0-306" class="i">+            LazyColumn(
</a><a href="#h33-0-307" id="h33-0-307" class="i">+                modifier = Modifier.weight(1f)
</a><a href="#h33-0-308" id="h33-0-308" class="i">+            ) {
</a><a href="#h33-0-309" id="h33-0-309" class="i">+                item {
</a><a href="#h33-0-310" id="h33-0-310" class="i">+                    if (rules.isEmpty()) {
</a><a href="#h33-0-311" id="h33-0-311" class="i">+                        Text(&quot;No rules found&quot;, modifier = Modifier
</a><a href="#h33-0-312" id="h33-0-312" class="i">+                            .padding(16.dp)
</a><a href="#h33-0-313" id="h33-0-313" class="i">+                            .fillMaxWidth(), textAlign = TextAlign.Center, fontWeight = FontWeight.Light)
</a><a href="#h33-0-314" id="h33-0-314" class="i">+                    }
</a><a href="#h33-0-315" id="h33-0-315" class="i">+                }
</a><a href="#h33-0-316" id="h33-0-316" class="i">+                items(rules, key = { it.id }) { rule -&gt;
</a><a href="#h33-0-317" id="h33-0-317" class="i">+                    val ruleName by rememberAsyncMutableState(defaultValue = rule.name) {
</a><a href="#h33-0-318" id="h33-0-318" class="i">+                        context.database.getTrackerRule(rule.id)?.name ?: &quot;(empty)&quot;
</a><a href="#h33-0-319" id="h33-0-319" class="i">+                    }
</a><a href="#h33-0-320" id="h33-0-320" class="i">+                    val eventCount by rememberAsyncMutableState(defaultValue = 0) {
</a><a href="#h33-0-321" id="h33-0-321" class="i">+                        context.database.getTrackerEvents(rule.id).size
</a><a href="#h33-0-322" id="h33-0-322" class="i">+                    }
</a><a href="#h33-0-323" id="h33-0-323" class="i">+                    val scopeCount by rememberAsyncMutableState(defaultValue = 0) {
</a><a href="#h33-0-324" id="h33-0-324" class="i">+                        context.database.getRuleTrackerScopes(rule.id).size
</a><a href="#h33-0-325" id="h33-0-325" class="i">+                    }
</a><a href="#h33-0-326" id="h33-0-326" class="i">+                    var enabled by rememberAsyncMutableState(defaultValue = rule.enabled) {
</a><a href="#h33-0-327" id="h33-0-327" class="i">+                        context.database.getTrackerRule(rule.id)?.enabled ?: false
</a><a href="#h33-0-328" id="h33-0-328" class="i">+                    }
</a><a href="#h33-0-329" id="h33-0-329" class="i">+
</a><a href="#h33-0-330" id="h33-0-330" class="i">+                    ElevatedCard(
</a><a href="#h33-0-331" id="h33-0-331" class="i">+                        modifier = Modifier
</a><a href="#h33-0-332" id="h33-0-332" class="i">+                            .fillMaxWidth()
</a><a href="#h33-0-333" id="h33-0-333" class="i">+                            .clickable {
</a><a href="#h33-0-334" id="h33-0-334" class="i">+                                routes.editRule.navigate {
</a><a href="#h33-0-335" id="h33-0-335" class="i">+                                    this[&quot;rule_id&quot;] = rule.id.toString()
</a><a href="#h33-0-336" id="h33-0-336" class="i">+                                }
</a><a href="#h33-0-337" id="h33-0-337" class="i">+                            }
</a><a href="#h33-0-338" id="h33-0-338" class="i">+                            .padding(5.dp)
</a><a href="#h33-0-339" id="h33-0-339" class="i">+                    ) {
</a><a href="#h33-0-340" id="h33-0-340" class="i">+                        Row(
</a><a href="#h33-0-341" id="h33-0-341" class="i">+                            modifier = Modifier
</a><a href="#h33-0-342" id="h33-0-342" class="i">+                                .fillMaxWidth(),
</a><a href="#h33-0-343" id="h33-0-343" class="i">+                            verticalAlignment = Alignment.CenterVertically
</a><a href="#h33-0-344" id="h33-0-344" class="i">+                        ) {
</a><a href="#h33-0-345" id="h33-0-345" class="i">+                            Column(
</a><a href="#h33-0-346" id="h33-0-346" class="i">+                                modifier = Modifier
</a><a href="#h33-0-347" id="h33-0-347" class="i">+                                    .fillMaxWidth()
</a><a href="#h33-0-348" id="h33-0-348" class="i">+                                    .padding(16.dp)
</a><a href="#h33-0-349" id="h33-0-349" class="i">+                                    .weight(1f),
</a><a href="#h33-0-350" id="h33-0-350" class="i">+                                verticalArrangement = Arrangement.spacedBy(2.dp)
</a><a href="#h33-0-351" id="h33-0-351" class="i">+                            ) {
</a><a href="#h33-0-352" id="h33-0-352" class="i">+                                Text(ruleName, fontSize = 20.sp, fontWeight = FontWeight.Bold)
</a><a href="#h33-0-353" id="h33-0-353" class="i">+                                Text(buildString {
</a><a href="#h33-0-354" id="h33-0-354" class="i">+                                    append(eventCount)
</a><a href="#h33-0-355" id="h33-0-355" class="i">+                                    append(&quot; events&quot;)
</a><a href="#h33-0-356" id="h33-0-356" class="i">+                                    if (scopeCount &gt; 0) {
</a><a href="#h33-0-357" id="h33-0-357" class="i">+                                        append(&quot;, &quot;)
</a><a href="#h33-0-358" id="h33-0-358" class="i">+                                        append(scopeCount)
</a><a href="#h33-0-359" id="h33-0-359" class="i">+                                        append(&quot; scopes&quot;)
</a><a href="#h33-0-360" id="h33-0-360" class="i">+                                    }
</a><a href="#h33-0-361" id="h33-0-361" class="i">+                                }, fontSize = 13.sp, fontWeight = FontWeight.Light)
</a><a href="#h33-0-362" id="h33-0-362" class="i">+                            }
</a><a href="#h33-0-363" id="h33-0-363" class="i">+
</a><a href="#h33-0-364" id="h33-0-364" class="i">+                            Row(
</a><a href="#h33-0-365" id="h33-0-365" class="i">+                                modifier = Modifier.padding(10.dp),
</a><a href="#h33-0-366" id="h33-0-366" class="i">+                                horizontalArrangement = Arrangement.spacedBy(10.dp)
</a><a href="#h33-0-367" id="h33-0-367" class="i">+                            ) {
</a><a href="#h33-0-368" id="h33-0-368" class="i">+                                val scopesBitmoji = rememberAsyncMutableStateList(defaultValue = emptyList()) {
</a><a href="#h33-0-369" id="h33-0-369" class="i">+                                    context.database.getRuleTrackerScopes(rule.id, limit = 10).mapNotNull {
</a><a href="#h33-0-370" id="h33-0-370" class="i">+                                        context.database.getFriendInfo(it.key)?.let { friend -&gt;
</a><a href="#h33-0-371" id="h33-0-371" class="i">+                                            friend.selfieId to friend.bitmojiId
</a><a href="#h33-0-372" id="h33-0-372" class="i">+                                        }
</a><a href="#h33-0-373" id="h33-0-373" class="i">+                                    }.take(3)
</a><a href="#h33-0-374" id="h33-0-374" class="i">+                                }
</a><a href="#h33-0-375" id="h33-0-375" class="i">+
</a><a href="#h33-0-376" id="h33-0-376" class="i">+                                Row {
</a><a href="#h33-0-377" id="h33-0-377" class="i">+                                    scopesBitmoji.forEachIndexed { index, friend -&gt;
</a><a href="#h33-0-378" id="h33-0-378" class="i">+                                        Box(
</a><a href="#h33-0-379" id="h33-0-379" class="i">+                                            modifier = Modifier
</a><a href="#h33-0-380" id="h33-0-380" class="i">+                                                .offset(x = (-index * 20).dp + (scopesBitmoji.size * 20).dp - 20.dp)
</a><a href="#h33-0-381" id="h33-0-381" class="i">+                                        ) {
</a><a href="#h33-0-382" id="h33-0-382" class="i">+                                            BitmojiImage(
</a><a href="#h33-0-383" id="h33-0-383" class="i">+                                                size = 50,
</a><a href="#h33-0-384" id="h33-0-384" class="i">+                                                modifier = Modifier
</a><a href="#h33-0-385" id="h33-0-385" class="i">+                                                    .border(
</a><a href="#h33-0-386" id="h33-0-386" class="i">+                                                        BorderStroke(1.dp, Color.White),
</a><a href="#h33-0-387" id="h33-0-387" class="i">+                                                        CircleShape
</a><a href="#h33-0-388" id="h33-0-388" class="i">+                                                    )
</a><a href="#h33-0-389" id="h33-0-389" class="i">+                                                    .background(Color.White, CircleShape)
</a><a href="#h33-0-390" id="h33-0-390" class="i">+                                                    .clip(CircleShape),
</a><a href="#h33-0-391" id="h33-0-391" class="i">+                                                context = context,
</a><a href="#h33-0-392" id="h33-0-392" class="i">+                                                url = BitmojiSelfie.getBitmojiSelfie(friend.first, friend.second, BitmojiSelfie.BitmojiSelfieType.NEW_THREE_D),
</a><a href="#h33-0-393" id="h33-0-393" class="i">+                                            )
</a><a href="#h33-0-394" id="h33-0-394" class="i">+                                        }
</a><a href="#h33-0-395" id="h33-0-395" class="i">+                                    }
</a><a href="#h33-0-396" id="h33-0-396" class="i">+                                }
</a><a href="#h33-0-397" id="h33-0-397" class="i">+
</a><a href="#h33-0-398" id="h33-0-398" class="i">+                                Box(modifier = Modifier
</a><a href="#h33-0-399" id="h33-0-399" class="i">+                                    .padding(start = 5.dp, end = 5.dp)
</a><a href="#h33-0-400" id="h33-0-400" class="i">+                                    .height(50.dp)
</a><a href="#h33-0-401" id="h33-0-401" class="i">+                                    .width(1.dp)
</a><a href="#h33-0-402" id="h33-0-402" class="i">+                                    .background(
</a><a href="#h33-0-403" id="h33-0-403" class="i">+                                        color = MaterialTheme.colorScheme.primary.copy(alpha = 0.12f),
</a><a href="#h33-0-404" id="h33-0-404" class="i">+                                        shape = RoundedCornerShape(5.dp)
</a><a href="#h33-0-405" id="h33-0-405" class="i">+                                    )
</a><a href="#h33-0-406" id="h33-0-406" class="i">+                                )
</a><a href="#h33-0-407" id="h33-0-407" class="i">+
</a><a href="#h33-0-408" id="h33-0-408" class="i">+                                Switch(
</a><a href="#h33-0-409" id="h33-0-409" class="i">+                                    checked = enabled,
</a><a href="#h33-0-410" id="h33-0-410" class="i">+                                    onCheckedChange = {
</a><a href="#h33-0-411" id="h33-0-411" class="i">+                                        enabled = it
</a><a href="#h33-0-412" id="h33-0-412" class="i">+                                        context.database.setTrackerRuleState(rule.id, it)
</a><a href="#h33-0-413" id="h33-0-413" class="i">+                                    }
</a><a href="#h33-0-414" id="h33-0-414" class="i">+                                )
</a><a href="#h33-0-415" id="h33-0-415" class="i">+                            }
</a><a href="#h33-0-416" id="h33-0-416" class="i">+                        }
</a><a href="#h33-0-417" id="h33-0-417" class="i">+                    }
</a><a href="#h33-0-418" id="h33-0-418" class="i">+                }
</a><a href="#h33-0-419" id="h33-0-419" class="i">+            }
</a><a href="#h33-0-420" id="h33-0-420" class="i">+        }
</a><a href="#h33-0-421" id="h33-0-421" class="i">+    }
</a><a href="#h33-0-422" id="h33-0-422" class="i">+
</a><a href="#h33-0-423" id="h33-0-423" class="i">+
</a><a href="#h33-0-424" id="h33-0-424" class="i">+    @OptIn(ExperimentalFoundationApi::class)
</a><a href="#h33-0-425" id="h33-0-425" class="i">+    override val content: @Composable (NavBackStackEntry) -&gt; Unit = {
</a><a href="#h33-0-426" id="h33-0-426" class="i">+        val coroutineScope = rememberCoroutineScope()
</a><a href="#h33-0-427" id="h33-0-427" class="i">+        val pagerState = rememberPagerState { titles.size }
</a><a href="#h33-0-428" id="h33-0-428" class="i">+        currentPage = pagerState.currentPage
</a><a href="#h33-0-429" id="h33-0-429" class="i">+
</a><a href="#h33-0-430" id="h33-0-430" class="i">+        Column {
</a><a href="#h33-0-431" id="h33-0-431" class="i">+            TabRow(selectedTabIndex = pagerState.currentPage, indicator = { tabPositions -&gt;
</a><a href="#h33-0-432" id="h33-0-432" class="i">+                TabRowDefaults.SecondaryIndicator(
</a><a href="#h33-0-433" id="h33-0-433" class="i">+                    Modifier.pagerTabIndicatorOffset(
</a><a href="#h33-0-434" id="h33-0-434" class="i">+                        pagerState = pagerState,
</a><a href="#h33-0-435" id="h33-0-435" class="i">+                        tabPositions = tabPositions
</a><a href="#h33-0-436" id="h33-0-436" class="i">+                    )
</a><a href="#h33-0-437" id="h33-0-437" class="i">+                )
</a><a href="#h33-0-438" id="h33-0-438" class="i">+            }) {
</a><a href="#h33-0-439" id="h33-0-439" class="i">+                titles.forEachIndexed { index, title -&gt;
</a><a href="#h33-0-440" id="h33-0-440" class="i">+                    Tab(
</a><a href="#h33-0-441" id="h33-0-441" class="i">+                        selected = pagerState.currentPage == index,
</a><a href="#h33-0-442" id="h33-0-442" class="i">+                        onClick = {
</a><a href="#h33-0-443" id="h33-0-443" class="i">+                            coroutineScope.launch {
</a><a href="#h33-0-444" id="h33-0-444" class="i">+                                pagerState.animateScrollToPage(index)
</a><a href="#h33-0-445" id="h33-0-445" class="i">+                            }
</a><a href="#h33-0-446" id="h33-0-446" class="i">+                        },
</a><a href="#h33-0-447" id="h33-0-447" class="i">+                        text = {
</a><a href="#h33-0-448" id="h33-0-448" class="i">+                            Text(
</a><a href="#h33-0-449" id="h33-0-449" class="i">+                                text = title,
</a><a href="#h33-0-450" id="h33-0-450" class="i">+                                maxLines = 2,
</a><a href="#h33-0-451" id="h33-0-451" class="i">+                                overflow = TextOverflow.Ellipsis
</a><a href="#h33-0-452" id="h33-0-452" class="i">+                            )
</a><a href="#h33-0-453" id="h33-0-453" class="i">+                        }
</a><a href="#h33-0-454" id="h33-0-454" class="i">+                    )
</a><a href="#h33-0-455" id="h33-0-455" class="i">+                }
</a><a href="#h33-0-456" id="h33-0-456" class="i">+            }
</a><a href="#h33-0-457" id="h33-0-457" class="i">+
</a><a href="#h33-0-458" id="h33-0-458" class="i">+            HorizontalPager(
</a><a href="#h33-0-459" id="h33-0-459" class="i">+                modifier = Modifier.weight(1f),
</a><a href="#h33-0-460" id="h33-0-460" class="i">+                state = pagerState
</a><a href="#h33-0-461" id="h33-0-461" class="i">+            ) { page -&gt;
</a><a href="#h33-0-462" id="h33-0-462" class="i">+                when (page) {
</a><a href="#h33-0-463" id="h33-0-463" class="i">+                    0 -&gt; LogsTab()
</a><a href="#h33-0-464" id="h33-0-464" class="i">+                    1 -&gt; ConfigRulesTab()
</a><a href="#h33-0-465" id="h33-0-465" class="i">+                }
</a><a href="#h33-0-466" id="h33-0-466" class="i">+            }
</a><a href="#h33-0-467" id="h33-0-467" class="i">+        }
</a><a href="#h33-0-468" id="h33-0-468" class="i">+    }
</a><a href="#h33-0-469" id="h33-0-469" class="i">+}</a><a href="#h33-0-470" id="h33-0-470" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h34" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/util/coil/ComposeImageHelper.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/util/coil/ComposeImageHelper.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/util/coil/ComposeImageHelper.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/util/coil/ComposeImageHelper.kt</a></b>
<a href="#h34-0" id="h34-0" class="h">@@ -29,7 +29,7 @@ fun BitmojiImage(context: RemoteSideContext, modifier: Modifier = Modifier, size
</a>             imageLoader = context.imageLoader
         ),
         contentDescription = null,
<a href="#h34-0-3" id="h34-0-3" class="d">-        contentScale = ContentScale.Crop,
</a><a href="#h34-0-4" id="h34-0-4" class="i">+        contentScale = ContentScale.Inside,
</a>         modifier = Modifier
             .requiredWidthIn(min = 0.dp, max = size.dp)
             .height(size.dp)
<b>diff --git a/<a id="h35" href="../file/common/src/main/assets/lang/en_US.json.html">common/src/main/assets/lang/en_US.json</a> b/<a href="../file/common/src/main/assets/lang/en_US.json.html">common/src/main/assets/lang/en_US.json</a></b>
<a href="#h35-0" id="h35-0" class="h">@@ -33,6 +33,8 @@
</a>             &quot;home_logs&quot;: &quot;Logs&quot;,
             &quot;logger_history&quot;: &quot;Logger History&quot;,
             &quot;logged_stories&quot;: &quot;Logged Stories&quot;,
<a href="#h35-0-3" id="h35-0-3" class="i">+            &quot;friend_tracker&quot;: &quot;Friend Tracker&quot;,
</a><a href="#h35-0-4" id="h35-0-4" class="i">+            &quot;edit_rule&quot;: &quot;Edit Rule&quot;,
</a>             &quot;social&quot;: &quot;Social&quot;,
             &quot;manage_scope&quot;: &quot;Manage Scope&quot;,
             &quot;messaging_preview&quot;: &quot;Preview&quot;,
<a href="#h35-1" id="h35-1" class="h">@@ -878,20 +880,6 @@
</a>                             }
                         }
                     },
<a href="#h35-1-3" id="h35-1-3" class="d">-                    &quot;session_events&quot;: {
</a><a href="#h35-1-4" id="h35-1-4" class="d">-                        &quot;name&quot;: &quot;Session Events&quot;,
</a><a href="#h35-1-5" id="h35-1-5" class="d">-                        &quot;description&quot;: &quot;Records session events&quot;,
</a><a href="#h35-1-6" id="h35-1-6" class="d">-                        &quot;properties&quot;: {
</a><a href="#h35-1-7" id="h35-1-7" class="d">-                            &quot;capture_duplex_events&quot;: {
</a><a href="#h35-1-8" id="h35-1-8" class="d">-                                &quot;name&quot;: &quot;Capture Duplex Events&quot;,
</a><a href="#h35-1-9" id="h35-1-9" class="d">-                                &quot;description&quot;: &quot;Capture presence and messaging events when a session is active&quot;
</a><a href="#h35-1-10" id="h35-1-10" class="d">-                            },
</a><a href="#h35-1-11" id="h35-1-11" class="d">-                            &quot;allow_running_in_background&quot;: {
</a><a href="#h35-1-12" id="h35-1-12" class="d">-                                &quot;name&quot;: &quot;Allow Running in Background&quot;,
</a><a href="#h35-1-13" id="h35-1-13" class="d">-                                &quot;description&quot;: &quot;Allows session to run in the background&quot;
</a><a href="#h35-1-14" id="h35-1-14" class="d">-                            }
</a><a href="#h35-1-15" id="h35-1-15" class="d">-                        }
</a><a href="#h35-1-16" id="h35-1-16" class="d">-                    },
</a>                     &quot;spoof&quot;: {
                         &quot;name&quot;: &quot;Spoof&quot;,
                         &quot;description&quot;: &quot;Spoof various information about you&quot;,
<a href="#h35-2" id="h35-2" class="h">@@ -1039,6 +1027,20 @@
</a>                         &quot;description&quot;: &quot;Disables the anonymization of logs&quot;
                     }
                 }
<a href="#h35-2-3" id="h35-2-3" class="i">+            },
</a><a href="#h35-2-4" id="h35-2-4" class="i">+            &quot;friend_tracker&quot;: {
</a><a href="#h35-2-5" id="h35-2-5" class="i">+                &quot;name&quot;: &quot;Friend Tracker&quot;,
</a><a href="#h35-2-6" id="h35-2-6" class="i">+                &quot;description&quot;: &quot;Records friend&#39;s activity on Snapchat&quot;,
</a><a href="#h35-2-7" id="h35-2-7" class="i">+                &quot;properties&quot;: {
</a><a href="#h35-2-8" id="h35-2-8" class="i">+                    &quot;record_messaging_events&quot;: {
</a><a href="#h35-2-9" id="h35-2-9" class="i">+                        &quot;name&quot;: &quot;Record Messaging Events&quot;,
</a><a href="#h35-2-10" id="h35-2-10" class="i">+                        &quot;description&quot;: &quot;Records messaging events such as sending a opening a snap, reading a message, etc.&quot;
</a><a href="#h35-2-11" id="h35-2-11" class="i">+                    },
</a><a href="#h35-2-12" id="h35-2-12" class="i">+                    &quot;allow_running_in_background&quot;: {
</a><a href="#h35-2-13" id="h35-2-13" class="i">+                        &quot;name&quot;: &quot;Allow Running in Background&quot;,
</a><a href="#h35-2-14" id="h35-2-14" class="i">+                        &quot;description&quot;: &quot;Allows the tracker to run in the background. Note: This will significantly drain your battery&quot;
</a><a href="#h35-2-15" id="h35-2-15" class="i">+                    }
</a><a href="#h35-2-16" id="h35-2-16" class="i">+                }
</a>             }
         },
         &quot;options&quot;: {
<b>diff --git a/<a id="h36" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/action/EnumAction.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/action/EnumAction.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/action/EnumAction.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/action/EnumAction.kt</a></b>
<a href="#h36-0" id="h36-0" class="h">@@ -1,16 +1,24 @@
</a> package me.rhunk.snapenhance.common.action
 
<a href="#h36-0-2" id="h36-0-2" class="i">+import androidx.compose.material.icons.Icons
</a><a href="#h36-0-3" id="h36-0-3" class="i">+import androidx.compose.material.icons.automirrored.filled.Chat
</a><a href="#h36-0-4" id="h36-0-4" class="i">+import androidx.compose.material.icons.filled.CleaningServices
</a><a href="#h36-0-5" id="h36-0-5" class="i">+import androidx.compose.material.icons.filled.DeleteOutline
</a><a href="#h36-0-6" id="h36-0-6" class="i">+import androidx.compose.material.icons.filled.Image
</a><a href="#h36-0-7" id="h36-0-7" class="i">+import androidx.compose.material.icons.filled.PersonOutline
</a><a href="#h36-0-8" id="h36-0-8" class="i">+import androidx.compose.ui.graphics.vector.ImageVector
</a> 
 
 enum class EnumAction(
     val key: String,
<a href="#h36-0-13" id="h36-0-13" class="i">+    val icon: ImageVector,
</a>     val exitOnFinish: Boolean = false,
 ) {
<a href="#h36-0-16" id="h36-0-16" class="d">-    EXPORT_CHAT_MESSAGES(&quot;export_chat_messages&quot;),
</a><a href="#h36-0-17" id="h36-0-17" class="d">-    EXPORT_MEMORIES(&quot;export_memories&quot;),
</a><a href="#h36-0-18" id="h36-0-18" class="d">-    BULK_MESSAGING_ACTION(&quot;bulk_messaging_action&quot;),
</a><a href="#h36-0-19" id="h36-0-19" class="d">-    MANAGE_FRIEND_LIST(&quot;manage_friend_list&quot;),
</a><a href="#h36-0-20" id="h36-0-20" class="d">-    CLEAN_CACHE(&quot;clean_snapchat_cache&quot;, exitOnFinish = true);
</a><a href="#h36-0-21" id="h36-0-21" class="i">+    EXPORT_CHAT_MESSAGES(&quot;export_chat_messages&quot;, Icons.AutoMirrored.Default.Chat),
</a><a href="#h36-0-22" id="h36-0-22" class="i">+    EXPORT_MEMORIES(&quot;export_memories&quot;, Icons.Default.Image),
</a><a href="#h36-0-23" id="h36-0-23" class="i">+    BULK_MESSAGING_ACTION(&quot;bulk_messaging_action&quot;, Icons.Default.DeleteOutline),
</a><a href="#h36-0-24" id="h36-0-24" class="i">+    CLEAN_CACHE(&quot;clean_snapchat_cache&quot;, Icons.Default.CleaningServices, exitOnFinish = true),
</a><a href="#h36-0-25" id="h36-0-25" class="i">+    MANAGE_FRIEND_LIST(&quot;manage_friend_list&quot;, Icons.Default.PersonOutline);
</a> 
     companion object {
         const val ACTION_PARAMETER = &quot;se_action&quot;
<b>diff --git a/<a id="h37" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/wrapper/LoggerWrapper.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/wrapper/LoggerWrapper.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/wrapper/LoggerWrapper.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/wrapper/LoggerWrapper.kt</a></b>
<a href="#h37-0" id="h37-0" class="h">@@ -2,25 +2,34 @@ package me.rhunk.snapenhance.common.bridge.wrapper
</a> 
 import android.content.ContentValues
 import android.database.sqlite.SQLiteDatabase
<a href="#h37-0-3" id="h37-0-3" class="i">+import com.google.gson.GsonBuilder
</a><a href="#h37-0-4" id="h37-0-4" class="i">+import com.google.gson.JsonObject
</a> import kotlinx.coroutines.*
 import me.rhunk.snapenhance.bridge.logger.LoggerInterface
 import me.rhunk.snapenhance.common.data.StoryData
<a href="#h37-0-8" id="h37-0-8" class="i">+import me.rhunk.snapenhance.common.logger.AbstractLogger
</a> import me.rhunk.snapenhance.common.util.SQLiteDatabaseHelper
 import me.rhunk.snapenhance.common.util.ktx.getBlobOrNull
 import me.rhunk.snapenhance.common.util.ktx.getIntOrNull
 import me.rhunk.snapenhance.common.util.ktx.getLongOrNull
 import me.rhunk.snapenhance.common.util.ktx.getStringOrNull
<a href="#h37-0-14" id="h37-0-14" class="i">+import me.rhunk.snapenhance.common.util.protobuf.ProtoReader
</a> import java.io.File
 import java.util.UUID
 
<a href="#h37-0-18" id="h37-0-18" class="i">+class LoggedMessageEdit(
</a><a href="#h37-0-19" id="h37-0-19" class="i">+    val timestamp: Long,
</a><a href="#h37-0-20" id="h37-0-20" class="i">+    val messageText: String
</a><a href="#h37-0-21" id="h37-0-21" class="i">+)
</a> 
 class LoggedMessage(
     val messageId: Long,
     val timestamp: Long,
<a href="#h37-0-26" id="h37-0-26" class="d">-    val messageData: ByteArray
</a><a href="#h37-0-27" id="h37-0-27" class="i">+    val messageData: ByteArray,
</a> )
 
 class TrackerLog(
<a href="#h37-0-31" id="h37-0-31" class="i">+    val id: Int,
</a>     val timestamp: Long,
     val conversationId: String,
     val conversationTitle: String?,
<a href="#h37-1" id="h37-1" class="h">@@ -37,6 +46,7 @@ class LoggerWrapper(
</a>     private var _database: SQLiteDatabase? = null
     @OptIn(ExperimentalCoroutinesApi::class)
     private val coroutineScope = CoroutineScope(Dispatchers.IO.limitedParallelism(1))
<a href="#h37-1-3" id="h37-1-3" class="i">+    private val gson by lazy { GsonBuilder().create() }
</a> 
     private val database get() = synchronized(this) {
         _database?.takeIf { it.isOpen } ?: run {
<a href="#h37-2" id="h37-2" class="h">@@ -50,6 +60,14 @@ class LoggerWrapper(
</a>                     &quot;message_id BIGINT&quot;,
                     &quot;message_data BLOB&quot;
                 ),
<a href="#h37-2-3" id="h37-2-3" class="i">+                &quot;chat_edits&quot; to listOf(
</a><a href="#h37-2-4" id="h37-2-4" class="i">+                    &quot;id INTEGER PRIMARY KEY&quot;,
</a><a href="#h37-2-5" id="h37-2-5" class="i">+                    &quot;edit_number INTEGER&quot;,
</a><a href="#h37-2-6" id="h37-2-6" class="i">+                    &quot;added_timestamp BIGINT&quot;,
</a><a href="#h37-2-7" id="h37-2-7" class="i">+                    &quot;conversation_id VARCHAR&quot;,
</a><a href="#h37-2-8" id="h37-2-8" class="i">+                    &quot;message_id BIGINT&quot;,
</a><a href="#h37-2-9" id="h37-2-9" class="i">+                    &quot;message_text BLOB&quot;
</a><a href="#h37-2-10" id="h37-2-10" class="i">+                ),
</a>                 &quot;stories&quot; to listOf(
                     &quot;id INTEGER PRIMARY KEY&quot;,
                     &quot;added_timestamp BIGINT&quot;,
<a href="#h37-3" id="h37-3" class="h">@@ -111,18 +129,66 @@ class LoggerWrapper(
</a>     }
 
     override fun addMessage(conversationId: String, messageId: Long, serializedMessage: ByteArray) {
<a href="#h37-3-3" id="h37-3-3" class="d">-        val cursor = database.rawQuery(&quot;SELECT message_id FROM messages WHERE conversation_id = ? AND message_id = ?&quot;, arrayOf(conversationId, messageId.toString()))
</a><a href="#h37-3-4" id="h37-3-4" class="d">-        val state = cursor.moveToFirst()
</a><a href="#h37-3-5" id="h37-3-5" class="d">-        cursor.close()
</a><a href="#h37-3-6" id="h37-3-6" class="d">-        if (state) return
</a><a href="#h37-3-7" id="h37-3-7" class="i">+        val hasMessage = database.rawQuery(&quot;SELECT message_id FROM messages WHERE conversation_id = ? AND message_id = ?&quot;, arrayOf(conversationId, messageId.toString())).use {
</a><a href="#h37-3-8" id="h37-3-8" class="i">+            it.moveToFirst()
</a><a href="#h37-3-9" id="h37-3-9" class="i">+            it.count &gt; 0
</a><a href="#h37-3-10" id="h37-3-10" class="i">+        }
</a><a href="#h37-3-11" id="h37-3-11" class="i">+
</a><a href="#h37-3-12" id="h37-3-12" class="i">+        if (!hasMessage) {
</a><a href="#h37-3-13" id="h37-3-13" class="i">+            runBlocking {
</a><a href="#h37-3-14" id="h37-3-14" class="i">+                withContext(coroutineScope.coroutineContext) {
</a><a href="#h37-3-15" id="h37-3-15" class="i">+                    database.insert(&quot;messages&quot;, null, ContentValues().apply {
</a><a href="#h37-3-16" id="h37-3-16" class="i">+                        put(&quot;added_timestamp&quot;, System.currentTimeMillis())
</a><a href="#h37-3-17" id="h37-3-17" class="i">+                        put(&quot;conversation_id&quot;, conversationId)
</a><a href="#h37-3-18" id="h37-3-18" class="i">+                        put(&quot;message_id&quot;, messageId)
</a><a href="#h37-3-19" id="h37-3-19" class="i">+                        put(&quot;message_data&quot;, serializedMessage)
</a><a href="#h37-3-20" id="h37-3-20" class="i">+                    })
</a><a href="#h37-3-21" id="h37-3-21" class="i">+                }
</a><a href="#h37-3-22" id="h37-3-22" class="i">+            }
</a><a href="#h37-3-23" id="h37-3-23" class="i">+        }
</a><a href="#h37-3-24" id="h37-3-24" class="i">+
</a><a href="#h37-3-25" id="h37-3-25" class="i">+        // handle message edits
</a>         runBlocking {
             withContext(coroutineScope.coroutineContext) {
<a href="#h37-3-28" id="h37-3-28" class="d">-                database.insert(&quot;messages&quot;, null, ContentValues().apply {
</a><a href="#h37-3-29" id="h37-3-29" class="d">-                    put(&quot;added_timestamp&quot;, System.currentTimeMillis())
</a><a href="#h37-3-30" id="h37-3-30" class="d">-                    put(&quot;conversation_id&quot;, conversationId)
</a><a href="#h37-3-31" id="h37-3-31" class="d">-                    put(&quot;message_id&quot;, messageId)
</a><a href="#h37-3-32" id="h37-3-32" class="d">-                    put(&quot;message_data&quot;, serializedMessage)
</a><a href="#h37-3-33" id="h37-3-33" class="d">-                })
</a><a href="#h37-3-34" id="h37-3-34" class="i">+                runCatching {
</a><a href="#h37-3-35" id="h37-3-35" class="i">+                    val messageObject = gson.fromJson(
</a><a href="#h37-3-36" id="h37-3-36" class="i">+                        serializedMessage.toString(Charsets.UTF_8),
</a><a href="#h37-3-37" id="h37-3-37" class="i">+                        JsonObject::class.java
</a><a href="#h37-3-38" id="h37-3-38" class="i">+                    )
</a><a href="#h37-3-39" id="h37-3-39" class="i">+                    if (messageObject.getAsJsonObject(&quot;mMessageContent&quot;)
</a><a href="#h37-3-40" id="h37-3-40" class="i">+                            ?.getAsJsonPrimitive(&quot;mContentType&quot;)?.asString != &quot;CHAT&quot;
</a><a href="#h37-3-41" id="h37-3-41" class="i">+                    ) return@withContext
</a><a href="#h37-3-42" id="h37-3-42" class="i">+
</a><a href="#h37-3-43" id="h37-3-43" class="i">+                    val metadata = messageObject.getAsJsonObject(&quot;mMetadata&quot;)
</a><a href="#h37-3-44" id="h37-3-44" class="i">+                    if (metadata.get(&quot;mIsEdited&quot;)?.asBoolean != true) return@withContext
</a><a href="#h37-3-45" id="h37-3-45" class="i">+
</a><a href="#h37-3-46" id="h37-3-46" class="i">+                    val messageTextContent =
</a><a href="#h37-3-47" id="h37-3-47" class="i">+                        messageObject.getAsJsonObject(&quot;mMessageContent&quot;)?.getAsJsonArray(&quot;mContent&quot;)
</a><a href="#h37-3-48" id="h37-3-48" class="i">+                            ?.map { it.asByte }?.toByteArray()?.let {
</a><a href="#h37-3-49" id="h37-3-49" class="i">+                                ProtoReader(it).getString(2, 1)
</a><a href="#h37-3-50" id="h37-3-50" class="i">+                            } ?: return@withContext
</a><a href="#h37-3-51" id="h37-3-51" class="i">+
</a><a href="#h37-3-52" id="h37-3-52" class="i">+                    database.rawQuery(
</a><a href="#h37-3-53" id="h37-3-53" class="i">+                        &quot;SELECT MAX(edit_number), message_text FROM chat_edits WHERE conversation_id = ? AND message_id = ?&quot;,
</a><a href="#h37-3-54" id="h37-3-54" class="i">+                        arrayOf(conversationId, messageId.toString())
</a><a href="#h37-3-55" id="h37-3-55" class="i">+                    ).use {
</a><a href="#h37-3-56" id="h37-3-56" class="i">+                        it.moveToFirst()
</a><a href="#h37-3-57" id="h37-3-57" class="i">+                        val editNumber = it.getInt(0)
</a><a href="#h37-3-58" id="h37-3-58" class="i">+                        val lastEditedMessage = it.getString(1)
</a><a href="#h37-3-59" id="h37-3-59" class="i">+
</a><a href="#h37-3-60" id="h37-3-60" class="i">+                        if (lastEditedMessage == messageTextContent) return@withContext
</a><a href="#h37-3-61" id="h37-3-61" class="i">+
</a><a href="#h37-3-62" id="h37-3-62" class="i">+                        database.insert(&quot;chat_edits&quot;, null, ContentValues().apply {
</a><a href="#h37-3-63" id="h37-3-63" class="i">+                            put(&quot;edit_number&quot;, editNumber + 1)
</a><a href="#h37-3-64" id="h37-3-64" class="i">+                            put(&quot;added_timestamp&quot;, System.currentTimeMillis())
</a><a href="#h37-3-65" id="h37-3-65" class="i">+                            put(&quot;conversation_id&quot;, conversationId)
</a><a href="#h37-3-66" id="h37-3-66" class="i">+                            put(&quot;message_id&quot;, messageId)
</a><a href="#h37-3-67" id="h37-3-67" class="i">+                            put(&quot;message_text&quot;, messageTextContent)
</a><a href="#h37-3-68" id="h37-3-68" class="i">+                        })
</a><a href="#h37-3-69" id="h37-3-69" class="i">+                    }
</a><a href="#h37-3-70" id="h37-3-70" class="i">+                }.onFailure {
</a><a href="#h37-3-71" id="h37-3-71" class="i">+                    AbstractLogger.directDebug(&quot;Failed to handle message edit: ${it.message}&quot;)
</a><a href="#h37-3-72" id="h37-3-72" class="i">+                }
</a>             }
         }
     }
<a href="#h37-4" id="h37-4" class="h">@@ -132,9 +198,11 @@ class LoggerWrapper(
</a>             maxAge?.let {
                 val maxTime = System.currentTimeMillis() - it
                 database.execSQL(&quot;DELETE FROM messages WHERE added_timestamp &lt; ?&quot;, arrayOf(maxTime.toString()))
<a href="#h37-4-3" id="h37-4-3" class="i">+                database.execSQL(&quot;DELETE FROM chat_edits WHERE added_timestamp &lt; ?&quot;, arrayOf(maxTime.toString()))
</a>                 database.execSQL(&quot;DELETE FROM stories WHERE added_timestamp &lt; ?&quot;, arrayOf(maxTime.toString()))
             } ?: run {
                 database.execSQL(&quot;DELETE FROM messages&quot;)
<a href="#h37-4-7" id="h37-4-7" class="i">+                database.execSQL(&quot;DELETE FROM chat_edits&quot;)
</a>                 database.execSQL(&quot;DELETE FROM stories&quot;)
             }
         }
<a href="#h37-5" id="h37-5" class="h">@@ -157,6 +225,7 @@ class LoggerWrapper(
</a>     override fun deleteMessage(conversationId: String, messageId: Long) {
         coroutineScope.launch {
             database.execSQL(&quot;DELETE FROM messages WHERE conversation_id = ? AND message_id = ?&quot;, arrayOf(conversationId, messageId.toString()))
<a href="#h37-5-3" id="h37-5-3" class="i">+            database.execSQL(&quot;DELETE FROM chat_edits WHERE conversation_id = ? AND message_id = ?&quot;, arrayOf(conversationId, messageId.toString()))
</a>         }
     }
 
<a href="#h37-6" id="h37-6" class="h">@@ -207,6 +276,12 @@ class LoggerWrapper(
</a>         }
     }
 
<a href="#h37-6-3" id="h37-6-3" class="i">+    fun deleteTrackerLog(id: Int) {
</a><a href="#h37-6-4" id="h37-6-4" class="i">+        coroutineScope.launch {
</a><a href="#h37-6-5" id="h37-6-5" class="i">+            database.execSQL(&quot;DELETE FROM tracker_events WHERE id = ?&quot;, arrayOf(id.toString()))
</a><a href="#h37-6-6" id="h37-6-6" class="i">+        }
</a><a href="#h37-6-7" id="h37-6-7" class="i">+    }
</a><a href="#h37-6-8" id="h37-6-8" class="i">+
</a>     fun getLogs(
         lastTimestamp: Long,
         filter: ((TrackerLog) -&gt; Boolean)? = null
<a href="#h37-7" id="h37-7" class="h">@@ -215,6 +290,7 @@ class LoggerWrapper(
</a>             val logs = mutableListOf&lt;TrackerLog&gt;()
             while (it.moveToNext() &amp;&amp; logs.size &lt; 50) {
                 val log = TrackerLog(
<a href="#h37-7-3" id="h37-7-3" class="i">+                    id = it.getIntOrNull(&quot;id&quot;) ?: continue,
</a>                     timestamp = it.getLongOrNull(&quot;timestamp&quot;) ?: continue,
                     conversationId = it.getStringOrNull(&quot;conversation_id&quot;) ?: continue,
                     conversationTitle = it.getStringOrNull(&quot;conversation_title&quot;),
<a href="#h37-8" id="h37-8" class="h">@@ -278,6 +354,22 @@ class LoggerWrapper(
</a>         }
     }
 
<a href="#h37-8-3" id="h37-8-3" class="i">+    fun getMessageEdits(conversationId: String, messageId: Long): List&lt;LoggedMessageEdit&gt; {
</a><a href="#h37-8-4" id="h37-8-4" class="i">+        val edits = mutableListOf&lt;LoggedMessageEdit&gt;()
</a><a href="#h37-8-5" id="h37-8-5" class="i">+        database.rawQuery(
</a><a href="#h37-8-6" id="h37-8-6" class="i">+            &quot;SELECT added_timestamp, message_text FROM chat_edits WHERE conversation_id = ? AND message_id = ?&quot;,
</a><a href="#h37-8-7" id="h37-8-7" class="i">+            arrayOf(conversationId, messageId.toString())
</a><a href="#h37-8-8" id="h37-8-8" class="i">+        ).use {
</a><a href="#h37-8-9" id="h37-8-9" class="i">+            while (it.moveToNext()) {
</a><a href="#h37-8-10" id="h37-8-10" class="i">+                edits.add(LoggedMessageEdit(
</a><a href="#h37-8-11" id="h37-8-11" class="i">+                    timestamp = it.getLongOrNull(&quot;added_timestamp&quot;) ?: continue,
</a><a href="#h37-8-12" id="h37-8-12" class="i">+                    messageText = it.getStringOrNull(&quot;message_text&quot;) ?: continue
</a><a href="#h37-8-13" id="h37-8-13" class="i">+                ))
</a><a href="#h37-8-14" id="h37-8-14" class="i">+            }
</a><a href="#h37-8-15" id="h37-8-15" class="i">+        }
</a><a href="#h37-8-16" id="h37-8-16" class="i">+        return edits
</a><a href="#h37-8-17" id="h37-8-17" class="i">+    }
</a><a href="#h37-8-18" id="h37-8-18" class="i">+
</a>     fun fetchMessages(
         conversationId: String,
         fromTimestamp: Long,
<b>diff --git a/<a id="h38" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/config/ConfigObjects.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/config/ConfigObjects.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/config/ConfigObjects.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/config/ConfigObjects.kt</a></b>
<a href="#h38-0" id="h38-0" class="h">@@ -1,5 +1,6 @@
</a> package me.rhunk.snapenhance.common.config
 
<a href="#h38-0-2" id="h38-0-2" class="i">+import androidx.compose.ui.graphics.vector.ImageVector
</a> import me.rhunk.snapenhance.common.bridge.wrapper.LocaleWrapper
 import kotlin.reflect.KProperty
 
<a href="#h38-1" id="h38-1" class="h">@@ -35,7 +36,7 @@ class ConfigParams(
</a>     private var _flags: Int? = null,
     private var _notices: Int? = null,
 
<a href="#h38-1-3" id="h38-1-3" class="d">-    var icon: String? = null,
</a><a href="#h38-1-4" id="h38-1-4" class="i">+    var icon: ImageVector? = null,
</a>     var disabledKey: String? = null,
     var customTranslationPath: String? = null,
     var customOptionTranslationPath: String? = null,
<b>diff --git a/<a id="h39" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/config/impl/Experimental.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/config/impl/Experimental.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/config/impl/Experimental.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/config/impl/Experimental.kt</a></b>
<a href="#h39-0" id="h39-0" class="h">@@ -1,14 +1,12 @@
</a> package me.rhunk.snapenhance.common.config.impl
 
<a href="#h39-0-2" id="h39-0-2" class="i">+import androidx.compose.material.icons.Icons
</a><a href="#h39-0-3" id="h39-0-3" class="i">+import androidx.compose.material.icons.filled.Fingerprint
</a><a href="#h39-0-4" id="h39-0-4" class="i">+import androidx.compose.material.icons.filled.Memory
</a> import me.rhunk.snapenhance.common.config.ConfigContainer
 import me.rhunk.snapenhance.common.config.FeatureNotice
 
 class Experimental : ConfigContainer() {
<a href="#h39-0-9" id="h39-0-9" class="d">-    class SessionEventsConfig : ConfigContainer(hasGlobalState = true) {
</a><a href="#h39-0-10" id="h39-0-10" class="d">-        val captureDuplexEvents = boolean(&quot;capture_duplex_events&quot;, true)
</a><a href="#h39-0-11" id="h39-0-11" class="d">-        val allowRunningInBackground = boolean(&quot;allow_running_in_background&quot;, true)
</a><a href="#h39-0-12" id="h39-0-12" class="d">-    }
</a><a href="#h39-0-13" id="h39-0-13" class="d">-
</a>     class ComposerHooksConfig: ConfigContainer(hasGlobalState = true) {
         val showFirstCreatedUsername = boolean(&quot;show_first_created_username&quot;)
         val bypassCameraRollLimit = boolean(&quot;bypass_camera_roll_limit&quot;)
<a href="#h39-1" id="h39-1" class="h">@@ -34,9 +32,8 @@ class Experimental : ConfigContainer() {
</a>         val lockOnResume = boolean(&quot;lock_on_resume&quot;, defaultValue = true)
     }
 
<a href="#h39-1-3" id="h39-1-3" class="d">-    val nativeHooks = container(&quot;native_hooks&quot;, NativeHooks()) { icon = &quot;Memory&quot;; requireRestart() }
</a><a href="#h39-1-4" id="h39-1-4" class="d">-    val sessionEvents = container(&quot;session_events&quot;, SessionEventsConfig()) { requireRestart(); nativeHooks() }
</a><a href="#h39-1-5" id="h39-1-5" class="d">-    val spoof = container(&quot;spoof&quot;, Spoof()) { icon = &quot;Fingerprint&quot; ; addNotices(FeatureNotice.BAN_RISK); requireRestart() }
</a><a href="#h39-1-6" id="h39-1-6" class="i">+    val nativeHooks = container(&quot;native_hooks&quot;, NativeHooks()) { icon = Icons.Default.Memory; requireRestart() }
</a><a href="#h39-1-7" id="h39-1-7" class="i">+    val spoof = container(&quot;spoof&quot;, Spoof()) { icon = Icons.Default.Fingerprint ; addNotices(FeatureNotice.BAN_RISK); requireRestart() }
</a>     val convertMessageLocally = boolean(&quot;convert_message_locally&quot;) { requireRestart() }
     val newChatActionMenu = boolean(&quot;new_chat_action_menu&quot;) { requireRestart() }
     val mediaFilePicker = boolean(&quot;media_file_picker&quot;) { requireRestart(); addNotices(FeatureNotice.UNSTABLE) }
<b>diff --git a/<a id="h40" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/config/impl/FriendTrackerConfig.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/config/impl/FriendTrackerConfig.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/config/impl/FriendTrackerConfig.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/config/impl/FriendTrackerConfig.kt</a></b>
<a href="#h40-0" id="h40-0" class="h">@@ -0,0 +1,8 @@
</a><a href="#h40-0-0" id="h40-0-0" class="i">+package me.rhunk.snapenhance.common.config.impl
</a><a href="#h40-0-1" id="h40-0-1" class="i">+
</a><a href="#h40-0-2" id="h40-0-2" class="i">+import me.rhunk.snapenhance.common.config.ConfigContainer
</a><a href="#h40-0-3" id="h40-0-3" class="i">+
</a><a href="#h40-0-4" id="h40-0-4" class="i">+class FriendTrackerConfig: ConfigContainer(hasGlobalState = true) {
</a><a href="#h40-0-5" id="h40-0-5" class="i">+    val recordMessagingEvents = boolean(&quot;record_messaging_events&quot;, false)
</a><a href="#h40-0-6" id="h40-0-6" class="i">+    val allowRunningInBackground = boolean(&quot;allow_running_in_background&quot;, false)
</a><a href="#h40-0-7" id="h40-0-7" class="i">+}</a><a href="#h40-0-8" id="h40-0-8" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h41" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/config/impl/RootConfig.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/config/impl/RootConfig.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/config/impl/RootConfig.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/config/impl/RootConfig.kt</a></b>
<a href="#h41-0" id="h41-0" class="h">@@ -1,17 +1,22 @@
</a> package me.rhunk.snapenhance.common.config.impl
 
<a href="#h41-0-2" id="h41-0-2" class="i">+import androidx.compose.material.icons.Icons
</a><a href="#h41-0-3" id="h41-0-3" class="i">+import androidx.compose.material.icons.automirrored.filled.Rule
</a><a href="#h41-0-4" id="h41-0-4" class="i">+import androidx.compose.material.icons.automirrored.filled.Send
</a><a href="#h41-0-5" id="h41-0-5" class="i">+import androidx.compose.material.icons.filled.*
</a> import me.rhunk.snapenhance.common.config.ConfigContainer
 import me.rhunk.snapenhance.common.config.FeatureNotice
 
 class RootConfig : ConfigContainer() {
<a href="#h41-0-10" id="h41-0-10" class="d">-    val downloader = container(&quot;downloader&quot;, DownloaderConfig()) { icon = &quot;Download&quot;}
</a><a href="#h41-0-11" id="h41-0-11" class="d">-    val userInterface = container(&quot;user_interface&quot;, UserInterfaceTweaks()) { icon = &quot;RemoveRedEye&quot;}
</a><a href="#h41-0-12" id="h41-0-12" class="d">-    val messaging = container(&quot;messaging&quot;, MessagingTweaks()) { icon = &quot;Send&quot; }
</a><a href="#h41-0-13" id="h41-0-13" class="d">-    val global = container(&quot;global&quot;, Global()) { icon = &quot;MiscellaneousServices&quot; }
</a><a href="#h41-0-14" id="h41-0-14" class="d">-    val rules = container(&quot;rules&quot;, Rules()) { icon = &quot;Rule&quot; }
</a><a href="#h41-0-15" id="h41-0-15" class="d">-    val camera = container(&quot;camera&quot;, Camera()) { icon = &quot;Camera&quot;; requireRestart() }
</a><a href="#h41-0-16" id="h41-0-16" class="d">-    val streaksReminder = container(&quot;streaks_reminder&quot;, StreaksReminderConfig()) { icon = &quot;Alarm&quot; }
</a><a href="#h41-0-17" id="h41-0-17" class="d">-    val experimental = container(&quot;experimental&quot;, Experimental()) { icon = &quot;Science&quot;; addNotices(
</a><a href="#h41-0-18" id="h41-0-18" class="i">+    val downloader = container(&quot;downloader&quot;, DownloaderConfig()) { icon = Icons.Default.Download }
</a><a href="#h41-0-19" id="h41-0-19" class="i">+    val userInterface = container(&quot;user_interface&quot;, UserInterfaceTweaks()) { icon = Icons.Default.RemoveRedEye }
</a><a href="#h41-0-20" id="h41-0-20" class="i">+    val messaging = container(&quot;messaging&quot;, MessagingTweaks()) { icon = Icons.AutoMirrored.Default.Send }
</a><a href="#h41-0-21" id="h41-0-21" class="i">+    val global = container(&quot;global&quot;, Global()) { icon = Icons.Default.MiscellaneousServices }
</a><a href="#h41-0-22" id="h41-0-22" class="i">+    val rules = container(&quot;rules&quot;, Rules()) { icon = Icons.AutoMirrored.Default.Rule }
</a><a href="#h41-0-23" id="h41-0-23" class="i">+    val camera = container(&quot;camera&quot;, Camera()) { icon = Icons.Default.Camera; requireRestart() }
</a><a href="#h41-0-24" id="h41-0-24" class="i">+    val streaksReminder = container(&quot;streaks_reminder&quot;, StreaksReminderConfig()) { icon = Icons.Default.Alarm }
</a><a href="#h41-0-25" id="h41-0-25" class="i">+    val experimental = container(&quot;experimental&quot;, Experimental()) { icon = Icons.Default.Science; addNotices(
</a>         FeatureNotice.UNSTABLE) }
<a href="#h41-0-27" id="h41-0-27" class="d">-    val scripting = container(&quot;scripting&quot;, Scripting()) { icon = &quot;DataObject&quot; }
</a><a href="#h41-0-28" id="h41-0-28" class="i">+    val scripting = container(&quot;scripting&quot;, Scripting()) { icon = Icons.Default.DataObject }
</a><a href="#h41-0-29" id="h41-0-29" class="i">+    val friendTracker = container(&quot;friend_tracker&quot;, FriendTrackerConfig()) { icon = Icons.Default.PersonSearch; nativeHooks() }
</a> } 
\ No newline at end of file
<b>diff --git a/<a id="h42" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/data/SessionEventsData.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/data/SessionEventsData.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/data/SessionEventsData.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/data/SessionEventsData.kt</a></b>
<a href="#h42-0" id="h42-0" class="h">@@ -35,6 +35,7 @@ enum class SessionEventType(
</a>     MESSAGE_DELETED(&quot;message_deleted&quot;),
     MESSAGE_SAVED(&quot;message_saved&quot;),
     MESSAGE_UNSAVED(&quot;message_unsaved&quot;),
<a href="#h42-0-3" id="h42-0-3" class="i">+    MESSAGE_EDITED(&quot;message_edited&quot;),
</a>     MESSAGE_REACTION_ADD(&quot;message_reaction_add&quot;),
     MESSAGE_REACTION_REMOVE(&quot;message_reaction_remove&quot;),
     SNAP_OPENED(&quot;snap_opened&quot;),
<a href="#h42-1" id="h42-1" class="h">@@ -44,70 +45,6 @@ enum class SessionEventType(
</a>     SNAP_SCREEN_RECORD(&quot;snap_screen_record&quot;),
 }
 
<a href="#h42-1-3" id="h42-1-3" class="d">-object TrackerFlags {
</a><a href="#h42-1-4" id="h42-1-4" class="d">-    const val TRACK = 1
</a><a href="#h42-1-5" id="h42-1-5" class="d">-    const val LOG = 2
</a><a href="#h42-1-6" id="h42-1-6" class="d">-    const val NOTIFY = 4
</a><a href="#h42-1-7" id="h42-1-7" class="d">-    const val APP_IS_ACTIVE = 8
</a><a href="#h42-1-8" id="h42-1-8" class="d">-    const val APP_IS_INACTIVE = 16
</a><a href="#h42-1-9" id="h42-1-9" class="d">-    const val IS_IN_CONVERSATION = 32
</a><a href="#h42-1-10" id="h42-1-10" class="d">-}
</a><a href="#h42-1-11" id="h42-1-11" class="d">-
</a><a href="#h42-1-12" id="h42-1-12" class="d">-@Parcelize
</a><a href="#h42-1-13" id="h42-1-13" class="d">-class TrackerEventsResult(
</a><a href="#h42-1-14" id="h42-1-14" class="d">-    private val rules: Map&lt;TrackerRule, List&lt;TrackerRuleEvent&gt;&gt;
</a><a href="#h42-1-15" id="h42-1-15" class="d">-): Parcelable {
</a><a href="#h42-1-16" id="h42-1-16" class="d">-    fun hasFlags(vararg flags: Int): Boolean {
</a><a href="#h42-1-17" id="h42-1-17" class="d">-        return rules.any { (_, ruleEvents) -&gt;
</a><a href="#h42-1-18" id="h42-1-18" class="d">-            ruleEvents.any { flags.all { flag -&gt; it.flags and flag != 0 } }
</a><a href="#h42-1-19" id="h42-1-19" class="d">-        }
</a><a href="#h42-1-20" id="h42-1-20" class="d">-    }
</a><a href="#h42-1-21" id="h42-1-21" class="d">-
</a><a href="#h42-1-22" id="h42-1-22" class="d">-    fun canTrackOn(conversationId: String?, userId: String?): Boolean {
</a><a href="#h42-1-23" id="h42-1-23" class="d">-        return rules.any t@{ (rule, ruleEvents) -&gt;
</a><a href="#h42-1-24" id="h42-1-24" class="d">-            ruleEvents.any { event -&gt;
</a><a href="#h42-1-25" id="h42-1-25" class="d">-                if (event.flags and TrackerFlags.TRACK == 0) {
</a><a href="#h42-1-26" id="h42-1-26" class="d">-                    return@any false
</a><a href="#h42-1-27" id="h42-1-27" class="d">-                }
</a><a href="#h42-1-28" id="h42-1-28" class="d">-
</a><a href="#h42-1-29" id="h42-1-29" class="d">-                // global rule
</a><a href="#h42-1-30" id="h42-1-30" class="d">-                if (rule.conversationId == null &amp;&amp; rule.userId == null) {
</a><a href="#h42-1-31" id="h42-1-31" class="d">-                    return@any true
</a><a href="#h42-1-32" id="h42-1-32" class="d">-                }
</a><a href="#h42-1-33" id="h42-1-33" class="d">-
</a><a href="#h42-1-34" id="h42-1-34" class="d">-                // user rule
</a><a href="#h42-1-35" id="h42-1-35" class="d">-                if (rule.conversationId == null &amp;&amp; rule.userId == userId) {
</a><a href="#h42-1-36" id="h42-1-36" class="d">-                    return@any true
</a><a href="#h42-1-37" id="h42-1-37" class="d">-                }
</a><a href="#h42-1-38" id="h42-1-38" class="d">-
</a><a href="#h42-1-39" id="h42-1-39" class="d">-                // conversation rule
</a><a href="#h42-1-40" id="h42-1-40" class="d">-                if (rule.conversationId == conversationId &amp;&amp; rule.userId == null) {
</a><a href="#h42-1-41" id="h42-1-41" class="d">-                    return@any true
</a><a href="#h42-1-42" id="h42-1-42" class="d">-                }
</a><a href="#h42-1-43" id="h42-1-43" class="d">-
</a><a href="#h42-1-44" id="h42-1-44" class="d">-                // conversation and user rule
</a><a href="#h42-1-45" id="h42-1-45" class="d">-                return@any rule.conversationId == conversationId &amp;&amp; rule.userId == userId
</a><a href="#h42-1-46" id="h42-1-46" class="d">-            }
</a><a href="#h42-1-47" id="h42-1-47" class="d">-        }
</a><a href="#h42-1-48" id="h42-1-48" class="d">-    }
</a><a href="#h42-1-49" id="h42-1-49" class="d">-}
</a><a href="#h42-1-50" id="h42-1-50" class="d">-
</a><a href="#h42-1-51" id="h42-1-51" class="d">-
</a><a href="#h42-1-52" id="h42-1-52" class="d">-@Parcelize
</a><a href="#h42-1-53" id="h42-1-53" class="d">-data class TrackerRule(
</a><a href="#h42-1-54" id="h42-1-54" class="d">-    val id: Int,
</a><a href="#h42-1-55" id="h42-1-55" class="d">-    val flags: Int,
</a><a href="#h42-1-56" id="h42-1-56" class="d">-    val conversationId: String?,
</a><a href="#h42-1-57" id="h42-1-57" class="d">-    val userId: String?
</a><a href="#h42-1-58" id="h42-1-58" class="d">-): Parcelable
</a><a href="#h42-1-59" id="h42-1-59" class="d">-
</a><a href="#h42-1-60" id="h42-1-60" class="d">-@Parcelize
</a><a href="#h42-1-61" id="h42-1-61" class="d">-data class TrackerRuleEvent(
</a><a href="#h42-1-62" id="h42-1-62" class="d">-    val id: Int,
</a><a href="#h42-1-63" id="h42-1-63" class="d">-    val flags: Int,
</a><a href="#h42-1-64" id="h42-1-64" class="d">-    val eventType: String,
</a><a href="#h42-1-65" id="h42-1-65" class="d">-): Parcelable
</a><a href="#h42-1-66" id="h42-1-66" class="d">-
</a> enum class TrackerEventType(
     val key: String
 ) {
<a href="#h42-2" id="h42-2" class="h">@@ -126,6 +63,7 @@ enum class TrackerEventType(
</a>     MESSAGE_DELETED(&quot;message_deleted&quot;),
     MESSAGE_SAVED(&quot;message_saved&quot;),
     MESSAGE_UNSAVED(&quot;message_unsaved&quot;),
<a href="#h42-2-3" id="h42-2-3" class="i">+    MESSAGE_EDITED(&quot;message_edited&quot;),
</a>     MESSAGE_REACTION_ADD(&quot;message_reaction_add&quot;),
     MESSAGE_REACTION_REMOVE(&quot;message_reaction_remove&quot;),
     SNAP_OPENED(&quot;snap_opened&quot;),
<a href="#h42-3" id="h42-3" class="h">@@ -134,3 +72,104 @@ enum class TrackerEventType(
</a>     SNAP_SCREENSHOT(&quot;snap_screenshot&quot;),
     SNAP_SCREEN_RECORD(&quot;snap_screen_record&quot;),
 }
<a href="#h42-3-3" id="h42-3-3" class="i">+
</a><a href="#h42-3-4" id="h42-3-4" class="i">+
</a><a href="#h42-3-5" id="h42-3-5" class="i">+@Parcelize
</a><a href="#h42-3-6" id="h42-3-6" class="i">+class TrackerEventsResult(
</a><a href="#h42-3-7" id="h42-3-7" class="i">+    val rules: Map&lt;ScopedTrackerRule, List&lt;TrackerRuleEvent&gt;&gt;,
</a><a href="#h42-3-8" id="h42-3-8" class="i">+): Parcelable {
</a><a href="#h42-3-9" id="h42-3-9" class="i">+    fun getActions(): Map&lt;TrackerRuleAction, TrackerRuleActionParams&gt; {
</a><a href="#h42-3-10" id="h42-3-10" class="i">+        return rules.flatMap {
</a><a href="#h42-3-11" id="h42-3-11" class="i">+            it.value
</a><a href="#h42-3-12" id="h42-3-12" class="i">+        }.fold(mutableMapOf()) { acc, ruleEvent -&gt;
</a><a href="#h42-3-13" id="h42-3-13" class="i">+            ruleEvent.actions.forEach { action -&gt;
</a><a href="#h42-3-14" id="h42-3-14" class="i">+                acc[action] = acc[action]?.merge(ruleEvent.params) ?: ruleEvent.params
</a><a href="#h42-3-15" id="h42-3-15" class="i">+            }
</a><a href="#h42-3-16" id="h42-3-16" class="i">+            acc
</a><a href="#h42-3-17" id="h42-3-17" class="i">+        }
</a><a href="#h42-3-18" id="h42-3-18" class="i">+    }
</a><a href="#h42-3-19" id="h42-3-19" class="i">+
</a><a href="#h42-3-20" id="h42-3-20" class="i">+    fun canTrackOn(conversationId: String?, userId: String?): Boolean {
</a><a href="#h42-3-21" id="h42-3-21" class="i">+        return rules.any { (scopedRule, events) -&gt;
</a><a href="#h42-3-22" id="h42-3-22" class="i">+            if (!events.any { it.enabled }) return@any false
</a><a href="#h42-3-23" id="h42-3-23" class="i">+            val scopes = scopedRule.scopes
</a><a href="#h42-3-24" id="h42-3-24" class="i">+
</a><a href="#h42-3-25" id="h42-3-25" class="i">+            when (scopes[userId]) {
</a><a href="#h42-3-26" id="h42-3-26" class="i">+                TrackerScopeType.WHITELIST -&gt; return@any true
</a><a href="#h42-3-27" id="h42-3-27" class="i">+                TrackerScopeType.BLACKLIST -&gt; return@any false
</a><a href="#h42-3-28" id="h42-3-28" class="i">+                else -&gt; {}
</a><a href="#h42-3-29" id="h42-3-29" class="i">+            }
</a><a href="#h42-3-30" id="h42-3-30" class="i">+
</a><a href="#h42-3-31" id="h42-3-31" class="i">+            when (scopes[conversationId]) {
</a><a href="#h42-3-32" id="h42-3-32" class="i">+                TrackerScopeType.WHITELIST -&gt; return@any true
</a><a href="#h42-3-33" id="h42-3-33" class="i">+                TrackerScopeType.BLACKLIST -&gt; return@any false
</a><a href="#h42-3-34" id="h42-3-34" class="i">+                else -&gt; {}
</a><a href="#h42-3-35" id="h42-3-35" class="i">+            }
</a><a href="#h42-3-36" id="h42-3-36" class="i">+
</a><a href="#h42-3-37" id="h42-3-37" class="i">+            return@any scopes.isEmpty() || scopes.any { it.value == TrackerScopeType.BLACKLIST }
</a><a href="#h42-3-38" id="h42-3-38" class="i">+        }
</a><a href="#h42-3-39" id="h42-3-39" class="i">+    }
</a><a href="#h42-3-40" id="h42-3-40" class="i">+}
</a><a href="#h42-3-41" id="h42-3-41" class="i">+
</a><a href="#h42-3-42" id="h42-3-42" class="i">+enum class TrackerRuleAction(
</a><a href="#h42-3-43" id="h42-3-43" class="i">+    val key: String
</a><a href="#h42-3-44" id="h42-3-44" class="i">+) {
</a><a href="#h42-3-45" id="h42-3-45" class="i">+    LOG(&quot;log&quot;),
</a><a href="#h42-3-46" id="h42-3-46" class="i">+    IN_APP_NOTIFICATION(&quot;in_app_notification&quot;),
</a><a href="#h42-3-47" id="h42-3-47" class="i">+    PUSH_NOTIFICATION(&quot;push_notification&quot;),
</a><a href="#h42-3-48" id="h42-3-48" class="i">+    CUSTOM(&quot;custom&quot;);
</a><a href="#h42-3-49" id="h42-3-49" class="i">+
</a><a href="#h42-3-50" id="h42-3-50" class="i">+    companion object {
</a><a href="#h42-3-51" id="h42-3-51" class="i">+        fun fromString(value: String): TrackerRuleAction? {
</a><a href="#h42-3-52" id="h42-3-52" class="i">+            return entries.find { it.key == value }
</a><a href="#h42-3-53" id="h42-3-53" class="i">+        }
</a><a href="#h42-3-54" id="h42-3-54" class="i">+    }
</a><a href="#h42-3-55" id="h42-3-55" class="i">+}
</a><a href="#h42-3-56" id="h42-3-56" class="i">+
</a><a href="#h42-3-57" id="h42-3-57" class="i">+@Parcelize
</a><a href="#h42-3-58" id="h42-3-58" class="i">+data class TrackerRuleActionParams(
</a><a href="#h42-3-59" id="h42-3-59" class="i">+    var onlyInsideConversation: Boolean = false,
</a><a href="#h42-3-60" id="h42-3-60" class="i">+    var onlyOutsideConversation: Boolean = false,
</a><a href="#h42-3-61" id="h42-3-61" class="i">+    var onlyWhenAppActive: Boolean = false,
</a><a href="#h42-3-62" id="h42-3-62" class="i">+    var onlyWhenAppInactive: Boolean = false,
</a><a href="#h42-3-63" id="h42-3-63" class="i">+    var noPushNotificationWhenAppActive: Boolean = false,
</a><a href="#h42-3-64" id="h42-3-64" class="i">+): Parcelable {
</a><a href="#h42-3-65" id="h42-3-65" class="i">+    fun merge(other: TrackerRuleActionParams): TrackerRuleActionParams {
</a><a href="#h42-3-66" id="h42-3-66" class="i">+        return TrackerRuleActionParams(
</a><a href="#h42-3-67" id="h42-3-67" class="i">+            onlyInsideConversation = onlyInsideConversation || other.onlyInsideConversation,
</a><a href="#h42-3-68" id="h42-3-68" class="i">+            onlyOutsideConversation = onlyOutsideConversation || other.onlyOutsideConversation,
</a><a href="#h42-3-69" id="h42-3-69" class="i">+            onlyWhenAppActive = onlyWhenAppActive || other.onlyWhenAppActive,
</a><a href="#h42-3-70" id="h42-3-70" class="i">+            onlyWhenAppInactive = onlyWhenAppInactive || other.onlyWhenAppInactive,
</a><a href="#h42-3-71" id="h42-3-71" class="i">+            noPushNotificationWhenAppActive = noPushNotificationWhenAppActive || other.noPushNotificationWhenAppActive,
</a><a href="#h42-3-72" id="h42-3-72" class="i">+        )
</a><a href="#h42-3-73" id="h42-3-73" class="i">+    }
</a><a href="#h42-3-74" id="h42-3-74" class="i">+}
</a><a href="#h42-3-75" id="h42-3-75" class="i">+
</a><a href="#h42-3-76" id="h42-3-76" class="i">+@Parcelize
</a><a href="#h42-3-77" id="h42-3-77" class="i">+data class TrackerRule(
</a><a href="#h42-3-78" id="h42-3-78" class="i">+    val id: Int,
</a><a href="#h42-3-79" id="h42-3-79" class="i">+    val enabled: Boolean,
</a><a href="#h42-3-80" id="h42-3-80" class="i">+    val name: String,
</a><a href="#h42-3-81" id="h42-3-81" class="i">+): Parcelable
</a><a href="#h42-3-82" id="h42-3-82" class="i">+
</a><a href="#h42-3-83" id="h42-3-83" class="i">+@Parcelize
</a><a href="#h42-3-84" id="h42-3-84" class="i">+data class ScopedTrackerRule(
</a><a href="#h42-3-85" id="h42-3-85" class="i">+    val rule: TrackerRule,
</a><a href="#h42-3-86" id="h42-3-86" class="i">+    val scopes: Map&lt;String, TrackerScopeType&gt;
</a><a href="#h42-3-87" id="h42-3-87" class="i">+): Parcelable
</a><a href="#h42-3-88" id="h42-3-88" class="i">+
</a><a href="#h42-3-89" id="h42-3-89" class="i">+enum class TrackerScopeType(
</a><a href="#h42-3-90" id="h42-3-90" class="i">+    val key: String
</a><a href="#h42-3-91" id="h42-3-91" class="i">+) {
</a><a href="#h42-3-92" id="h42-3-92" class="i">+    WHITELIST(&quot;whitelist&quot;),
</a><a href="#h42-3-93" id="h42-3-93" class="i">+    BLACKLIST(&quot;blacklist&quot;);
</a><a href="#h42-3-94" id="h42-3-94" class="i">+}
</a><a href="#h42-3-95" id="h42-3-95" class="i">+
</a><a href="#h42-3-96" id="h42-3-96" class="i">+@Parcelize
</a><a href="#h42-3-97" id="h42-3-97" class="i">+data class TrackerRuleEvent(
</a><a href="#h42-3-98" id="h42-3-98" class="i">+    val id: Int,
</a><a href="#h42-3-99" id="h42-3-99" class="i">+    val enabled: Boolean,
</a><a href="#h42-3-100" id="h42-3-100" class="i">+    val eventType: String,
</a><a href="#h42-3-101" id="h42-3-101" class="i">+    val params: TrackerRuleActionParams,
</a><a href="#h42-3-102" id="h42-3-102" class="i">+    val actions: List&lt;TrackerRuleAction&gt;
</a><a href="#h42-3-103" id="h42-3-103" class="i">+): Parcelable
</a><b>diff --git a/<a id="h43" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/JSModule.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/JSModule.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/JSModule.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/JSModule.kt</a></b>
<a href="#h43-0" id="h43-0" class="h">@@ -4,8 +4,8 @@ import android.os.Handler
</a> import android.widget.Toast
 import me.rhunk.snapenhance.common.scripting.bindings.AbstractBinding
 import me.rhunk.snapenhance.common.scripting.bindings.BindingsContext
<a href="#h43-0-3" id="h43-0-3" class="d">-import me.rhunk.snapenhance.common.scripting.impl.Networking
</a> import me.rhunk.snapenhance.common.scripting.impl.JavaInterfaces
<a href="#h43-0-5" id="h43-0-5" class="i">+import me.rhunk.snapenhance.common.scripting.impl.Networking
</a> import me.rhunk.snapenhance.common.scripting.ktx.contextScope
 import me.rhunk.snapenhance.common.scripting.ktx.putFunction
 import me.rhunk.snapenhance.common.scripting.ktx.scriptable
<a href="#h43-1" id="h43-1" class="h">@@ -18,13 +18,14 @@ import org.mozilla.javascript.NativeJavaObject
</a> import org.mozilla.javascript.ScriptableObject
 import org.mozilla.javascript.Undefined
 import org.mozilla.javascript.Wrapper
<a href="#h43-1-3" id="h43-1-3" class="i">+import java.io.Reader
</a> import java.lang.reflect.Modifier
 import kotlin.reflect.KClass
 
 class JSModule(
<a href="#h43-1-8" id="h43-1-8" class="d">-    val scriptRuntime: ScriptRuntime,
</a><a href="#h43-1-9" id="h43-1-9" class="i">+    private val scriptRuntime: ScriptRuntime,
</a>     val moduleInfo: ModuleInfo,
<a href="#h43-1-11" id="h43-1-11" class="d">-    val content: String,
</a><a href="#h43-1-12" id="h43-1-12" class="i">+    private val reader: Reader,
</a> ) {
     private val moduleBindings = mutableMapOf&lt;String, AbstractBinding&gt;()
     private lateinit var moduleObject: ScriptableObject
<a href="#h43-2" id="h43-2" class="h">@@ -53,6 +54,18 @@ class JSModule(
</a>                 })
             })
 
<a href="#h43-2-3" id="h43-2-3" class="i">+            scriptRuntime.logger.apply {
</a><a href="#h43-2-4" id="h43-2-4" class="i">+                moduleObject.putConst(&quot;console&quot;, moduleObject, scriptableObject {
</a><a href="#h43-2-5" id="h43-2-5" class="i">+                    putFunction(&quot;log&quot;) { info(argsToString(it)) }
</a><a href="#h43-2-6" id="h43-2-6" class="i">+                    putFunction(&quot;warn&quot;) { warn(argsToString(it)) }
</a><a href="#h43-2-7" id="h43-2-7" class="i">+                    putFunction(&quot;error&quot;) { error(argsToString(it)) }
</a><a href="#h43-2-8" id="h43-2-8" class="i">+                    putFunction(&quot;debug&quot;) { debug(argsToString(it)) }
</a><a href="#h43-2-9" id="h43-2-9" class="i">+                    putFunction(&quot;info&quot;) { info(argsToString(it)) }
</a><a href="#h43-2-10" id="h43-2-10" class="i">+                    putFunction(&quot;trace&quot;) { verbose(argsToString(it)) }
</a><a href="#h43-2-11" id="h43-2-11" class="i">+                    putFunction(&quot;verbose&quot;) { verbose(argsToString(it)) }
</a><a href="#h43-2-12" id="h43-2-12" class="i">+                })
</a><a href="#h43-2-13" id="h43-2-13" class="i">+            }
</a><a href="#h43-2-14" id="h43-2-14" class="i">+
</a>             registerBindings(
                 JavaInterfaces(),
                 InterfaceManager(),
<a href="#h43-3" id="h43-3" class="h">@@ -186,7 +199,7 @@ class JSModule(
</a>         }
 
         contextScope(shouldOptimize = true) {
<a href="#h43-3-3" id="h43-3-3" class="d">-            evaluateString(moduleObject, content, moduleInfo.name, 1, null)
</a><a href="#h43-3-4" id="h43-3-4" class="i">+            evaluateReader(moduleObject, reader, moduleInfo.name, 1, null)
</a>         }
     }
 
<a href="#h43-4" id="h43-4" class="h">@@ -233,7 +246,10 @@ class JSModule(
</a>     private fun argsToString(args: Array&lt;out Any?&gt;?): String {
         return args?.joinToString(&quot; &quot;) {
             when (it) {
<a href="#h43-4-3" id="h43-4-3" class="d">-                is Wrapper -&gt; it.unwrap().toString()
</a><a href="#h43-4-4" id="h43-4-4" class="i">+                is Wrapper -&gt; it.unwrap().let { value -&gt;
</a><a href="#h43-4-5" id="h43-4-5" class="i">+                    if (value is Throwable) value.message + &quot;\n&quot; + value.stackTraceToString()
</a><a href="#h43-4-6" id="h43-4-6" class="i">+                    else value.toString()
</a><a href="#h43-4-7" id="h43-4-7" class="i">+                }
</a>                 else -&gt; it.toString()
             }
         } ?: &quot;null&quot;
<b>diff --git a/<a id="h44" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/ScriptRuntime.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/ScriptRuntime.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/ScriptRuntime.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/ScriptRuntime.kt</a></b>
<a href="#h44-0" id="h44-0" class="h">@@ -3,11 +3,11 @@ package me.rhunk.snapenhance.common.scripting
</a> import android.content.Context
 import android.os.ParcelFileDescriptor
 import me.rhunk.snapenhance.bridge.scripting.IScripting
<a href="#h44-0-3" id="h44-0-3" class="i">+import me.rhunk.snapenhance.common.BuildConfig
</a> import me.rhunk.snapenhance.common.logger.AbstractLogger
 import me.rhunk.snapenhance.common.scripting.type.ModuleInfo
 import org.mozilla.javascript.ScriptableObject
 import java.io.BufferedReader
<a href="#h44-0-8" id="h44-0-8" class="d">-import java.io.ByteArrayInputStream
</a> import java.io.InputStream
 
 open class ScriptRuntime(
<a href="#h44-1" id="h44-1" class="h">@@ -35,7 +35,7 @@ open class ScriptRuntime(
</a>         return modules.values.find { it.moduleInfo.name == name }
     }
 
<a href="#h44-1-3" id="h44-1-3" class="d">-    private fun readModuleInfo(reader: BufferedReader): ModuleInfo {
</a><a href="#h44-1-4" id="h44-1-4" class="i">+    fun readModuleInfo(reader: BufferedReader): ModuleInfo {
</a>         val header = reader.readLine()
         if (!header.startsWith(&quot;// ==SE_module==&quot;)) {
             throw Exception(&quot;Invalid module header&quot;)
<a href="#h44-2" id="h44-2" class="h">@@ -74,6 +74,10 @@ open class ScriptRuntime(
</a>         return readModuleInfo(inputStream.bufferedReader())
     }
 
<a href="#h44-2-3" id="h44-2-3" class="i">+    fun removeModule(scriptPath: String) {
</a><a href="#h44-2-4" id="h44-2-4" class="i">+        modules.remove(scriptPath)
</a><a href="#h44-2-5" id="h44-2-5" class="i">+    }
</a><a href="#h44-2-6" id="h44-2-6" class="i">+
</a>     fun unload(scriptPath: String) {
         val module = modules[scriptPath] ?: return
         logger.info(&quot;Unloading module $scriptPath&quot;)
<a href="#h44-3" id="h44-3" class="h">@@ -81,27 +85,30 @@ open class ScriptRuntime(
</a>         modules.remove(scriptPath)
     }
 
<a href="#h44-3-3" id="h44-3-3" class="d">-    fun load(scriptPath: String, pfd: ParcelFileDescriptor) {
</a><a href="#h44-3-4" id="h44-3-4" class="d">-        load(scriptPath, ParcelFileDescriptor.AutoCloseInputStream(pfd).use {
</a><a href="#h44-3-5" id="h44-3-5" class="d">-            it.readBytes().toString(Charsets.UTF_8)
</a><a href="#h44-3-6" id="h44-3-6" class="d">-        })
</a><a href="#h44-3-7" id="h44-3-7" class="i">+    fun load(scriptPath: String, pfd: ParcelFileDescriptor): JSModule {
</a><a href="#h44-3-8" id="h44-3-8" class="i">+        return ParcelFileDescriptor.AutoCloseInputStream(pfd).use {
</a><a href="#h44-3-9" id="h44-3-9" class="i">+            load(scriptPath, it)
</a><a href="#h44-3-10" id="h44-3-10" class="i">+        }
</a>     }
 
<a href="#h44-3-13" id="h44-3-13" class="d">-    fun load(scriptPath: String, content: String): JSModule? {
</a><a href="#h44-3-14" id="h44-3-14" class="i">+    fun load(scriptPath: String, content: InputStream): JSModule {
</a>         logger.info(&quot;Loading module $scriptPath&quot;)
<a href="#h44-3-16" id="h44-3-16" class="d">-        return runCatching {
</a><a href="#h44-3-17" id="h44-3-17" class="d">-            JSModule(
</a><a href="#h44-3-18" id="h44-3-18" class="d">-                scriptRuntime = this,
</a><a href="#h44-3-19" id="h44-3-19" class="d">-                moduleInfo = readModuleInfo(ByteArrayInputStream(content.toByteArray(Charsets.UTF_8)).bufferedReader()),
</a><a href="#h44-3-20" id="h44-3-20" class="d">-                content = content,
</a><a href="#h44-3-21" id="h44-3-21" class="d">-            ).apply {
</a><a href="#h44-3-22" id="h44-3-22" class="d">-                load {
</a><a href="#h44-3-23" id="h44-3-23" class="d">-                    buildModuleObject(this, this@apply)
</a><a href="#h44-3-24" id="h44-3-24" class="d">-                }
</a><a href="#h44-3-25" id="h44-3-25" class="d">-                modules[scriptPath] = this
</a><a href="#h44-3-26" id="h44-3-26" class="i">+        val bufferedReader = content.bufferedReader()
</a><a href="#h44-3-27" id="h44-3-27" class="i">+        val moduleInfo = readModuleInfo(bufferedReader)
</a><a href="#h44-3-28" id="h44-3-28" class="i">+
</a><a href="#h44-3-29" id="h44-3-29" class="i">+        if (moduleInfo.minSEVersion != null &amp;&amp; moduleInfo.minSEVersion &gt; BuildConfig.VERSION_CODE) {
</a><a href="#h44-3-30" id="h44-3-30" class="i">+            throw Exception(&quot;Module requires a newer version of SnapEnhance (min version: ${moduleInfo.minSEVersion})&quot;)
</a><a href="#h44-3-31" id="h44-3-31" class="i">+        }
</a><a href="#h44-3-32" id="h44-3-32" class="i">+
</a><a href="#h44-3-33" id="h44-3-33" class="i">+        return JSModule(
</a><a href="#h44-3-34" id="h44-3-34" class="i">+            scriptRuntime = this,
</a><a href="#h44-3-35" id="h44-3-35" class="i">+            moduleInfo = moduleInfo,
</a><a href="#h44-3-36" id="h44-3-36" class="i">+            reader = bufferedReader,
</a><a href="#h44-3-37" id="h44-3-37" class="i">+        ).apply {
</a><a href="#h44-3-38" id="h44-3-38" class="i">+            load {
</a><a href="#h44-3-39" id="h44-3-39" class="i">+                buildModuleObject(this, this@apply)
</a>             }
<a href="#h44-3-41" id="h44-3-41" class="d">-        }.onFailure {
</a><a href="#h44-3-42" id="h44-3-42" class="d">-            logger.error(&quot;Failed to load module $scriptPath&quot;, it)
</a><a href="#h44-3-43" id="h44-3-43" class="d">-        }.getOrNull()
</a><a href="#h44-3-44" id="h44-3-44" class="i">+            modules[scriptPath] = this
</a><a href="#h44-3-45" id="h44-3-45" class="i">+        }
</a>     }
 } 
\ No newline at end of file
<b>diff --git a/<a id="h45" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/ui/AsyncMutableState.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/ui/AsyncMutableState.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/ui/AsyncMutableState.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/ui/AsyncMutableState.kt</a></b>
<a href="#h45-0" id="h45-0" class="h">@@ -0,0 +1,103 @@
</a><a href="#h45-0-0" id="h45-0-0" class="i">+package me.rhunk.snapenhance.common.ui
</a><a href="#h45-0-1" id="h45-0-1" class="i">+
</a><a href="#h45-0-2" id="h45-0-2" class="i">+import androidx.compose.runtime.*
</a><a href="#h45-0-3" id="h45-0-3" class="i">+import androidx.compose.runtime.snapshots.SnapshotStateList
</a><a href="#h45-0-4" id="h45-0-4" class="i">+import kotlinx.coroutines.Dispatchers
</a><a href="#h45-0-5" id="h45-0-5" class="i">+import kotlinx.coroutines.withContext
</a><a href="#h45-0-6" id="h45-0-6" class="i">+import java.util.concurrent.CopyOnWriteArrayList
</a><a href="#h45-0-7" id="h45-0-7" class="i">+
</a><a href="#h45-0-8" id="h45-0-8" class="i">+class AsyncUpdateDispatcher(
</a><a href="#h45-0-9" id="h45-0-9" class="i">+    val updateOnFirstComposition: Boolean = true
</a><a href="#h45-0-10" id="h45-0-10" class="i">+) {
</a><a href="#h45-0-11" id="h45-0-11" class="i">+    private val callbacks = CopyOnWriteArrayList&lt;suspend () -&gt; Unit&gt;()
</a><a href="#h45-0-12" id="h45-0-12" class="i">+
</a><a href="#h45-0-13" id="h45-0-13" class="i">+    suspend fun dispatch() {
</a><a href="#h45-0-14" id="h45-0-14" class="i">+        callbacks.forEach { it() }
</a><a href="#h45-0-15" id="h45-0-15" class="i">+    }
</a><a href="#h45-0-16" id="h45-0-16" class="i">+
</a><a href="#h45-0-17" id="h45-0-17" class="i">+    fun addCallback(callback: suspend () -&gt; Unit) {
</a><a href="#h45-0-18" id="h45-0-18" class="i">+        callbacks.add(callback)
</a><a href="#h45-0-19" id="h45-0-19" class="i">+    }
</a><a href="#h45-0-20" id="h45-0-20" class="i">+
</a><a href="#h45-0-21" id="h45-0-21" class="i">+    fun removeCallback(callback: suspend () -&gt; Unit) {
</a><a href="#h45-0-22" id="h45-0-22" class="i">+        callbacks.remove(callback)
</a><a href="#h45-0-23" id="h45-0-23" class="i">+    }
</a><a href="#h45-0-24" id="h45-0-24" class="i">+}
</a><a href="#h45-0-25" id="h45-0-25" class="i">+
</a><a href="#h45-0-26" id="h45-0-26" class="i">+@Composable
</a><a href="#h45-0-27" id="h45-0-27" class="i">+fun rememberAsyncUpdateDispatcher(): AsyncUpdateDispatcher {
</a><a href="#h45-0-28" id="h45-0-28" class="i">+    return remember { AsyncUpdateDispatcher() }
</a><a href="#h45-0-29" id="h45-0-29" class="i">+}
</a><a href="#h45-0-30" id="h45-0-30" class="i">+
</a><a href="#h45-0-31" id="h45-0-31" class="i">+@Composable
</a><a href="#h45-0-32" id="h45-0-32" class="i">+private fun &lt;T&gt; rememberCommonState(
</a><a href="#h45-0-33" id="h45-0-33" class="i">+    initialState: () -&gt; T,
</a><a href="#h45-0-34" id="h45-0-34" class="i">+    setter: suspend T.() -&gt; Unit,
</a><a href="#h45-0-35" id="h45-0-35" class="i">+    updateDispatcher: AsyncUpdateDispatcher? = null,
</a><a href="#h45-0-36" id="h45-0-36" class="i">+    keys: Array&lt;*&gt; = emptyArray&lt;Any&gt;(),
</a><a href="#h45-0-37" id="h45-0-37" class="i">+): T {
</a><a href="#h45-0-38" id="h45-0-38" class="i">+    return remember { initialState() }.apply {
</a><a href="#h45-0-39" id="h45-0-39" class="i">+        var asyncSetCallback by remember { mutableStateOf(suspend {}) }
</a><a href="#h45-0-40" id="h45-0-40" class="i">+
</a><a href="#h45-0-41" id="h45-0-41" class="i">+        LaunchedEffect(Unit) {
</a><a href="#h45-0-42" id="h45-0-42" class="i">+            asyncSetCallback = { setter(this@apply) }
</a><a href="#h45-0-43" id="h45-0-43" class="i">+            updateDispatcher?.addCallback(asyncSetCallback)
</a><a href="#h45-0-44" id="h45-0-44" class="i">+        }
</a><a href="#h45-0-45" id="h45-0-45" class="i">+
</a><a href="#h45-0-46" id="h45-0-46" class="i">+        DisposableEffect(Unit) {
</a><a href="#h45-0-47" id="h45-0-47" class="i">+            onDispose { updateDispatcher?.removeCallback(asyncSetCallback) }
</a><a href="#h45-0-48" id="h45-0-48" class="i">+        }
</a><a href="#h45-0-49" id="h45-0-49" class="i">+
</a><a href="#h45-0-50" id="h45-0-50" class="i">+        if (updateDispatcher?.updateOnFirstComposition != false) {
</a><a href="#h45-0-51" id="h45-0-51" class="i">+            LaunchedEffect(*keys) {
</a><a href="#h45-0-52" id="h45-0-52" class="i">+                setter(this@apply)
</a><a href="#h45-0-53" id="h45-0-53" class="i">+            }
</a><a href="#h45-0-54" id="h45-0-54" class="i">+        }
</a><a href="#h45-0-55" id="h45-0-55" class="i">+    }
</a><a href="#h45-0-56" id="h45-0-56" class="i">+}
</a><a href="#h45-0-57" id="h45-0-57" class="i">+
</a><a href="#h45-0-58" id="h45-0-58" class="i">+@Composable
</a><a href="#h45-0-59" id="h45-0-59" class="i">+fun &lt;T&gt; rememberAsyncMutableState(
</a><a href="#h45-0-60" id="h45-0-60" class="i">+    defaultValue: T,
</a><a href="#h45-0-61" id="h45-0-61" class="i">+    updateDispatcher: AsyncUpdateDispatcher? = null,
</a><a href="#h45-0-62" id="h45-0-62" class="i">+    keys: Array&lt;*&gt; = emptyArray&lt;Any&gt;(),
</a><a href="#h45-0-63" id="h45-0-63" class="i">+    getter: () -&gt; T,
</a><a href="#h45-0-64" id="h45-0-64" class="i">+): MutableState&lt;T&gt; {
</a><a href="#h45-0-65" id="h45-0-65" class="i">+    return rememberCommonState(
</a><a href="#h45-0-66" id="h45-0-66" class="i">+        initialState = { mutableStateOf(defaultValue) },
</a><a href="#h45-0-67" id="h45-0-67" class="i">+        setter = {
</a><a href="#h45-0-68" id="h45-0-68" class="i">+            withContext(Dispatchers.Main) {
</a><a href="#h45-0-69" id="h45-0-69" class="i">+                value = withContext(Dispatchers.IO) {
</a><a href="#h45-0-70" id="h45-0-70" class="i">+                    getter()
</a><a href="#h45-0-71" id="h45-0-71" class="i">+                }
</a><a href="#h45-0-72" id="h45-0-72" class="i">+            }
</a><a href="#h45-0-73" id="h45-0-73" class="i">+        },
</a><a href="#h45-0-74" id="h45-0-74" class="i">+        updateDispatcher = updateDispatcher,
</a><a href="#h45-0-75" id="h45-0-75" class="i">+        keys = keys,
</a><a href="#h45-0-76" id="h45-0-76" class="i">+    )
</a><a href="#h45-0-77" id="h45-0-77" class="i">+}
</a><a href="#h45-0-78" id="h45-0-78" class="i">+
</a><a href="#h45-0-79" id="h45-0-79" class="i">+@Composable
</a><a href="#h45-0-80" id="h45-0-80" class="i">+fun &lt;T&gt; rememberAsyncMutableStateList(
</a><a href="#h45-0-81" id="h45-0-81" class="i">+    defaultValue: List&lt;T&gt;,
</a><a href="#h45-0-82" id="h45-0-82" class="i">+    updateDispatcher: AsyncUpdateDispatcher? = null,
</a><a href="#h45-0-83" id="h45-0-83" class="i">+    keys: Array&lt;*&gt; = emptyArray&lt;Any&gt;(),
</a><a href="#h45-0-84" id="h45-0-84" class="i">+    getter: () -&gt; List&lt;T&gt;,
</a><a href="#h45-0-85" id="h45-0-85" class="i">+): SnapshotStateList&lt;T&gt; {
</a><a href="#h45-0-86" id="h45-0-86" class="i">+    return rememberCommonState(
</a><a href="#h45-0-87" id="h45-0-87" class="i">+        initialState = { mutableStateListOf&lt;T&gt;().apply {
</a><a href="#h45-0-88" id="h45-0-88" class="i">+            addAll(defaultValue)
</a><a href="#h45-0-89" id="h45-0-89" class="i">+        }},
</a><a href="#h45-0-90" id="h45-0-90" class="i">+        setter = {
</a><a href="#h45-0-91" id="h45-0-91" class="i">+            withContext(Dispatchers.Main) {
</a><a href="#h45-0-92" id="h45-0-92" class="i">+                clear()
</a><a href="#h45-0-93" id="h45-0-93" class="i">+                addAll(withContext(Dispatchers.IO) {
</a><a href="#h45-0-94" id="h45-0-94" class="i">+                    getter()
</a><a href="#h45-0-95" id="h45-0-95" class="i">+                })
</a><a href="#h45-0-96" id="h45-0-96" class="i">+            }
</a><a href="#h45-0-97" id="h45-0-97" class="i">+        },
</a><a href="#h45-0-98" id="h45-0-98" class="i">+        updateDispatcher = updateDispatcher,
</a><a href="#h45-0-99" id="h45-0-99" class="i">+        keys = keys,
</a><a href="#h45-0-100" id="h45-0-100" class="i">+    )
</a><a href="#h45-0-101" id="h45-0-101" class="i">+}
</a><a href="#h45-0-102" id="h45-0-102" class="i">+
</a><b>diff --git a/<a id="h46" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/util/snap/BitmojiSelfie.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/util/snap/BitmojiSelfie.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/util/snap/BitmojiSelfie.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/util/snap/BitmojiSelfie.kt</a></b>
<a href="#h46-0" id="h46-0" class="h">@@ -16,7 +16,7 @@ object BitmojiSelfie {
</a>         return when (type) {
             BitmojiSelfieType.STANDARD -&gt; &quot;${type.prefixUrl}$selfieId-$avatarId-v1.webp?transparent=1&quot;
             BitmojiSelfieType.THREE_D -&gt; &quot;${type.prefixUrl}$selfieId-$avatarId-v1.webp?trim=circle&quot;
<a href="#h46-0-3" id="h46-0-3" class="d">-            BitmojiSelfieType.NEW_THREE_D -&gt; &quot;${type.prefixUrl}$selfieId-$avatarId-v1.webp?trim=circle&amp;ua=1&quot;
</a><a href="#h46-0-4" id="h46-0-4" class="i">+            BitmojiSelfieType.NEW_THREE_D -&gt; &quot;${type.prefixUrl}$selfieId-$avatarId-v1.webp?trim=circle&amp;ua=2&quot;
</a>         }
     }
 } 
\ No newline at end of file
<b>diff --git a/<a id="h47" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/ModContext.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/ModContext.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/ModContext.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/ModContext.kt</a></b>
<a href="#h47-0" id="h47-0" class="h">@@ -17,15 +17,15 @@ import me.rhunk.snapenhance.common.Constants
</a> import me.rhunk.snapenhance.common.bridge.wrapper.LocaleWrapper
 import me.rhunk.snapenhance.common.bridge.wrapper.MappingsWrapper
 import me.rhunk.snapenhance.common.config.ModConfig
<a href="#h47-0-3" id="h47-0-3" class="i">+import me.rhunk.snapenhance.core.action.ActionManager
</a> import me.rhunk.snapenhance.core.bridge.BridgeClient
 import me.rhunk.snapenhance.core.bridge.loadFromBridge
 import me.rhunk.snapenhance.core.database.DatabaseAccess
 import me.rhunk.snapenhance.core.event.EventBus
 import me.rhunk.snapenhance.core.event.EventDispatcher
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h47-0-10" id="h47-0-10" class="d">-import me.rhunk.snapenhance.core.logger.CoreLogger
</a><a href="#h47-0-11" id="h47-0-11" class="d">-import me.rhunk.snapenhance.core.action.ActionManager
</a> import me.rhunk.snapenhance.core.features.FeatureManager
<a href="#h47-0-13" id="h47-0-13" class="i">+import me.rhunk.snapenhance.core.logger.CoreLogger
</a> import me.rhunk.snapenhance.core.messaging.CoreMessagingBridge
 import me.rhunk.snapenhance.core.messaging.MessageSender
 import me.rhunk.snapenhance.core.scripting.CoreScriptRuntime
<b>diff --git a/<a id="h48" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/action/impl/BulkMessagingAction.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/action/impl/BulkMessagingAction.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/action/impl/BulkMessagingAction.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/action/impl/BulkMessagingAction.kt</a></b>
<a href="#h48-0" id="h48-0" class="h">@@ -36,11 +36,13 @@ import kotlinx.coroutines.launch
</a> import kotlinx.coroutines.withContext
 import me.rhunk.snapenhance.common.data.ContentType
 import me.rhunk.snapenhance.common.data.FriendLinkType
<a href="#h48-0-3" id="h48-0-3" class="i">+import me.rhunk.snapenhance.common.database.impl.ConversationMessage
</a> import me.rhunk.snapenhance.common.database.impl.FriendInfo
 import me.rhunk.snapenhance.common.messaging.MessagingConstraints
 import me.rhunk.snapenhance.common.messaging.MessagingTask
 import me.rhunk.snapenhance.common.messaging.MessagingTaskType
 import me.rhunk.snapenhance.common.ui.createComposeAlertDialog
<a href="#h48-0-9" id="h48-0-9" class="i">+import me.rhunk.snapenhance.common.ui.rememberAsyncMutableState
</a> import me.rhunk.snapenhance.common.util.ktx.copyToClipboard
 import me.rhunk.snapenhance.common.util.snap.BitmojiSelfie
 import me.rhunk.snapenhance.core.action.AbstractAction
<a href="#h48-1" id="h48-1" class="h">@@ -62,6 +64,8 @@ class BulkMessagingAction : AbstractAction() {
</a>         ADDED_TIMESTAMP,
         SNAP_SCORE,
         STREAK_LENGTH,
<a href="#h48-1-3" id="h48-1-3" class="i">+        MOST_MESSAGES_SENT,
</a><a href="#h48-1-4" id="h48-1-4" class="i">+        MOST_RECENT_MESSAGE,
</a>     }
 
     enum class Filter {
<a href="#h48-2" id="h48-2" class="h">@@ -172,6 +176,12 @@ class BulkMessagingAction : AbstractAction() {
</a>         }
     }
 
<a href="#h48-2-3" id="h48-2-3" class="i">+    private fun getDMLastMessage(userId: String?): ConversationMessage? {
</a><a href="#h48-2-4" id="h48-2-4" class="i">+        return context.database.getConversationLinkFromUserId(userId ?: return null)?.clientConversationId?.let {
</a><a href="#h48-2-5" id="h48-2-5" class="i">+            context.database.getMessagesFromConversationId(it, 1)
</a><a href="#h48-2-6" id="h48-2-6" class="i">+        }?.firstOrNull()
</a><a href="#h48-2-7" id="h48-2-7" class="i">+    }
</a><a href="#h48-2-8" id="h48-2-8" class="i">+
</a>     @OptIn(ExperimentalMaterial3Api::class, ExperimentalFoundationApi::class)
     @Composable
     private fun BulkMessagingDialog() {
<a href="#h48-3" id="h48-3" class="h">@@ -198,6 +208,12 @@ class BulkMessagingAction : AbstractAction() {
</a>                     SortBy.ADDED_TIMESTAMP -&gt; newFriends.sortBy { it.addedTimestamp }
                     SortBy.SNAP_SCORE -&gt; newFriends.sortBy { it.snapScore }
                     SortBy.STREAK_LENGTH -&gt; newFriends.sortBy { it.streakLength }
<a href="#h48-3-3" id="h48-3-3" class="i">+                    SortBy.MOST_MESSAGES_SENT -&gt; newFriends.sortByDescending {
</a><a href="#h48-3-4" id="h48-3-4" class="i">+                        getDMLastMessage(it.userId)?.serverMessageId ?: 0
</a><a href="#h48-3-5" id="h48-3-5" class="i">+                    }
</a><a href="#h48-3-6" id="h48-3-6" class="i">+                    SortBy.MOST_RECENT_MESSAGE -&gt; newFriends.sortByDescending {
</a><a href="#h48-3-7" id="h48-3-7" class="i">+                        getDMLastMessage(it.userId)?.creationTimestamp
</a><a href="#h48-3-8" id="h48-3-8" class="i">+                    }
</a>                 }
                 if (sortReverseOrder) newFriends.reverse()
                 withContext(Dispatchers.Main) {
<a href="#h48-4" id="h48-4" class="h">@@ -288,7 +304,7 @@ class BulkMessagingAction : AbstractAction() {
</a>                 modifier = Modifier
                     .fillMaxWidth()
                     .weight(1f),
<a href="#h48-4-3" id="h48-4-3" class="d">-                verticalArrangement = Arrangement.spacedBy(2.dp)
</a><a href="#h48-4-4" id="h48-4-4" class="i">+                verticalArrangement = Arrangement.spacedBy(3.dp)
</a>             ) {
                 stickyHeader {
                     Row(
<a href="#h48-5" id="h48-5" class="h">@@ -398,10 +414,14 @@ class BulkMessagingAction : AbstractAction() {
</a>                                 horizontalArrangement = Arrangement.spacedBy(3.dp),
                                 verticalAlignment = Alignment.CenterVertically
                             ){
<a href="#h48-5-3" id="h48-5-3" class="d">-                                Text(text = (friendInfo.displayName ?: friendInfo.mutableUsername).toString(), fontSize = 16.sp, fontWeight = FontWeight.Bold, overflow = TextOverflow.Ellipsis, maxLines = 1)
</a><a href="#h48-5-4" id="h48-5-4" class="d">-                                Text(text = friendInfo.mutableUsername.toString(), fontSize = 10.sp, fontWeight = FontWeight.Light, overflow = TextOverflow.Ellipsis, maxLines = 1)
</a><a href="#h48-5-5" id="h48-5-5" class="i">+                                Text(text = (friendInfo.displayName ?: friendInfo.mutableUsername).toString(), fontSize = 16.sp, fontWeight = FontWeight.Bold, overflow = TextOverflow.Ellipsis, maxLines = 1, lineHeight = 10.sp)
</a><a href="#h48-5-6" id="h48-5-6" class="i">+                                Text(text = friendInfo.mutableUsername.toString(), fontSize = 10.sp, fontWeight = FontWeight.Light, overflow = TextOverflow.Ellipsis, maxLines = 1, lineHeight = 10.sp)
</a>                             }
<a href="#h48-5-8" id="h48-5-8" class="d">-                            val userInfo = remember(friendInfo) {
</a><a href="#h48-5-9" id="h48-5-9" class="i">+                            val lastMessage by rememberAsyncMutableState(defaultValue = null) {
</a><a href="#h48-5-10" id="h48-5-10" class="i">+                                getDMLastMessage(friendInfo.userId)
</a><a href="#h48-5-11" id="h48-5-11" class="i">+                            }
</a><a href="#h48-5-12" id="h48-5-12" class="i">+
</a><a href="#h48-5-13" id="h48-5-13" class="i">+                            val userInfo = remember(friendInfo, lastMessage) {
</a>                                 buildString {
                                     append(&quot;Relationship: &quot;)
                                     append(context.translation[&quot;friendship_link_type.${FriendLinkType.fromValue(friendInfo.friendLinkType).shortName}&quot;])
<a href="#h48-6" id="h48-6" class="h">@@ -414,9 +434,13 @@ class BulkMessagingAction : AbstractAction() {
</a>                                     friendInfo.streakLength.takeIf { it &gt; 0 }?.let {
                                         append(&quot;\nStreaks length: $it&quot;)
                                     }
<a href="#h48-6-3" id="h48-6-3" class="i">+                                    lastMessage?.let {
</a><a href="#h48-6-4" id="h48-6-4" class="i">+                                        append(&quot;\nSent messages: ${it.serverMessageId}&quot;)
</a><a href="#h48-6-5" id="h48-6-5" class="i">+                                        append(&quot;\nLast message date: ${DateFormat.getDateTimeInstance().format(Date(it.creationTimestamp))}&quot;)
</a><a href="#h48-6-6" id="h48-6-6" class="i">+                                    }
</a>                                 }
                             }
<a href="#h48-6-9" id="h48-6-9" class="d">-                            Text(text = userInfo, fontSize = 12.sp, fontWeight = FontWeight.Light, lineHeight = 16.sp, overflow = TextOverflow.Ellipsis)
</a><a href="#h48-6-10" id="h48-6-10" class="i">+                            Text(text = userInfo, fontSize = 12.sp, fontWeight = FontWeight.Light, lineHeight = 12.sp, overflow = TextOverflow.Ellipsis)
</a>                         }
 
                         Checkbox(
<b>diff --git a/<a id="h49" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/action/impl/ManageFriendList.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/action/impl/ManageFriendList.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/action/impl/ManageFriendList.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/action/impl/ManageFriendList.kt</a></b>
<a href="#h49-0" id="h49-0" class="h">@@ -20,7 +20,6 @@ import kotlinx.coroutines.Job
</a> import kotlinx.coroutines.delay
 import kotlinx.coroutines.launch
 import kotlinx.coroutines.withTimeout
<a href="#h49-0-3" id="h49-0-3" class="d">-import me.rhunk.snapenhance.common.action.EnumAction
</a> import me.rhunk.snapenhance.common.data.FriendLinkType
 import me.rhunk.snapenhance.common.ui.createComposeAlertDialog
 import me.rhunk.snapenhance.core.action.AbstractAction
<b>diff --git a/<a id="h50" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/FeatureManager.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/FeatureManager.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/FeatureManager.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/FeatureManager.kt</a></b>
<a href="#h50-0" id="h50-0" class="h">@@ -10,6 +10,7 @@ import me.rhunk.snapenhance.core.features.impl.downloader.ProfilePictureDownload
</a> import me.rhunk.snapenhance.core.features.impl.experiments.*
 import me.rhunk.snapenhance.core.features.impl.global.*
 import me.rhunk.snapenhance.core.features.impl.messaging.*
<a href="#h50-0-3" id="h50-0-3" class="i">+import me.rhunk.snapenhance.core.features.impl.spying.FriendTracker
</a> import me.rhunk.snapenhance.core.features.impl.spying.HalfSwipeNotifier
 import me.rhunk.snapenhance.core.features.impl.spying.MessageLogger
 import me.rhunk.snapenhance.core.features.impl.spying.StealthMode
<a href="#h50-1" id="h50-1" class="h">@@ -112,7 +113,7 @@ class FeatureManager(
</a>             OperaViewerParamsOverride(),
             StealthModeIndicator(),
             DisablePermissionRequests(),
<a href="#h50-1-3" id="h50-1-3" class="d">-            SessionEvents(),
</a><a href="#h50-1-4" id="h50-1-4" class="i">+            FriendTracker(),
</a>             DefaultVolumeControls(),
             CallRecorder(),
             DisableMemoriesSnapFeed(),
<b>diff --git a/<a id="h51" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/MixerStories.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/MixerStories.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/MixerStories.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/MixerStories.kt</a></b>
<a href="#h51-0" id="h51-0" class="h">@@ -2,8 +2,8 @@ package me.rhunk.snapenhance.core.features.impl
</a> 
 import kotlinx.coroutines.launch
 import kotlinx.coroutines.runBlocking
<a href="#h51-0-3" id="h51-0-3" class="d">-import me.rhunk.snapenhance.common.data.StoryData
</a> import me.rhunk.snapenhance.common.data.MixerStoryType
<a href="#h51-0-5" id="h51-0-5" class="i">+import me.rhunk.snapenhance.common.data.StoryData
</a> import me.rhunk.snapenhance.common.util.protobuf.ProtoEditor
 import me.rhunk.snapenhance.core.event.events.impl.NetworkApiRequestEvent
 import me.rhunk.snapenhance.core.features.Feature
<b>diff --git a/<a id="h52" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/downloader/ProfilePictureDownloader.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/downloader/ProfilePictureDownloader.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/downloader/ProfilePictureDownloader.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/downloader/ProfilePictureDownloader.kt</a></b>
<a href="#h52-0" id="h52-0" class="h">@@ -9,9 +9,6 @@ import me.rhunk.snapenhance.core.event.events.impl.NetworkApiRequestEvent
</a> import me.rhunk.snapenhance.core.features.Feature
 import me.rhunk.snapenhance.core.features.FeatureLoadParams
 import me.rhunk.snapenhance.core.ui.ViewAppearanceHelper
<a href="#h52-0-3" id="h52-0-3" class="d">-import me.rhunk.snapenhance.core.util.hook.HookStage
</a><a href="#h52-0-4" id="h52-0-4" class="d">-import me.rhunk.snapenhance.core.util.hook.Hooker
</a><a href="#h52-0-5" id="h52-0-5" class="d">-import java.nio.ByteBuffer
</a> 
 class ProfilePictureDownloader : Feature(&quot;ProfilePictureDownloader&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_ASYNC) {
     @SuppressLint(&quot;SetTextI18n&quot;)
<b>diff --git a/<a id="h53" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/SessionEvents.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/SessionEvents.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/SessionEvents.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/SessionEvents.kt</a></b>
<a href="#h53-0" id="h53-0" class="h">@@ -1,359 +0,0 @@
</a><a href="#h53-0-0" id="h53-0-0" class="d">-package me.rhunk.snapenhance.core.features.impl.experiments
</a><a href="#h53-0-1" id="h53-0-1" class="d">-
</a><a href="#h53-0-2" id="h53-0-2" class="d">-import android.app.Notification
</a><a href="#h53-0-3" id="h53-0-3" class="d">-import android.app.NotificationManager
</a><a href="#h53-0-4" id="h53-0-4" class="d">-import android.app.PendingIntent
</a><a href="#h53-0-5" id="h53-0-5" class="d">-import me.rhunk.snapenhance.common.Constants
</a><a href="#h53-0-6" id="h53-0-6" class="d">-import me.rhunk.snapenhance.common.data.*
</a><a href="#h53-0-7" id="h53-0-7" class="d">-import me.rhunk.snapenhance.common.util.protobuf.ProtoReader
</a><a href="#h53-0-8" id="h53-0-8" class="d">-import me.rhunk.snapenhance.common.util.toParcelable
</a><a href="#h53-0-9" id="h53-0-9" class="d">-import me.rhunk.snapenhance.core.features.Feature
</a><a href="#h53-0-10" id="h53-0-10" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a><a href="#h53-0-11" id="h53-0-11" class="d">-import me.rhunk.snapenhance.core.features.impl.messaging.Messaging
</a><a href="#h53-0-12" id="h53-0-12" class="d">-import me.rhunk.snapenhance.core.util.hook.HookStage
</a><a href="#h53-0-13" id="h53-0-13" class="d">-import me.rhunk.snapenhance.core.util.hook.hook
</a><a href="#h53-0-14" id="h53-0-14" class="d">-import me.rhunk.snapenhance.core.util.hook.hookConstructor
</a><a href="#h53-0-15" id="h53-0-15" class="d">-import me.rhunk.snapenhance.core.wrapper.impl.toSnapUUID
</a><a href="#h53-0-16" id="h53-0-16" class="d">-import me.rhunk.snapenhance.nativelib.NativeLib
</a><a href="#h53-0-17" id="h53-0-17" class="d">-import java.lang.reflect.Method
</a><a href="#h53-0-18" id="h53-0-18" class="d">-import java.nio.ByteBuffer
</a><a href="#h53-0-19" id="h53-0-19" class="d">-
</a><a href="#h53-0-20" id="h53-0-20" class="d">-class SessionEvents : Feature(&quot;Session Events&quot;, loadParams = FeatureLoadParams.INIT_SYNC) {
</a><a href="#h53-0-21" id="h53-0-21" class="d">-    private val conversationPresenceState = mutableMapOf&lt;String, MutableMap&lt;String, FriendPresenceState?&gt;&gt;() // conversationId -&gt; (userId -&gt; state)
</a><a href="#h53-0-22" id="h53-0-22" class="d">-    private val tracker by lazy { context.bridgeClient.getTracker() }
</a><a href="#h53-0-23" id="h53-0-23" class="d">-
</a><a href="#h53-0-24" id="h53-0-24" class="d">-    private fun getTrackedEvents(eventType: TrackerEventType): TrackerEventsResult? {
</a><a href="#h53-0-25" id="h53-0-25" class="d">-        return runCatching {
</a><a href="#h53-0-26" id="h53-0-26" class="d">-            tracker.getTrackedEvents(eventType.key)?.let {
</a><a href="#h53-0-27" id="h53-0-27" class="d">-                toParcelable&lt;TrackerEventsResult&gt;(it)
</a><a href="#h53-0-28" id="h53-0-28" class="d">-            }
</a><a href="#h53-0-29" id="h53-0-29" class="d">-        }.onFailure {
</a><a href="#h53-0-30" id="h53-0-30" class="d">-            context.log.error(&quot;Failed to get tracked events for $eventType&quot;, it)
</a><a href="#h53-0-31" id="h53-0-31" class="d">-        }.getOrNull()
</a><a href="#h53-0-32" id="h53-0-32" class="d">-    }
</a><a href="#h53-0-33" id="h53-0-33" class="d">-
</a><a href="#h53-0-34" id="h53-0-34" class="d">-    private fun isInConversation(conversationId: String) = context.feature(Messaging::class).openedConversationUUID?.toString() == conversationId
</a><a href="#h53-0-35" id="h53-0-35" class="d">-
</a><a href="#h53-0-36" id="h53-0-36" class="d">-    private fun sendInfoNotification(id: Int = System.nanoTime().toInt(), text: String) {
</a><a href="#h53-0-37" id="h53-0-37" class="d">-        context.androidContext.getSystemService(NotificationManager::class.java).notify(
</a><a href="#h53-0-38" id="h53-0-38" class="d">-            id,
</a><a href="#h53-0-39" id="h53-0-39" class="d">-                Notification.Builder(
</a><a href="#h53-0-40" id="h53-0-40" class="d">-                    context.androidContext,
</a><a href="#h53-0-41" id="h53-0-41" class="d">-                    &quot;general_group_generic_push_noisy_generic_push_B~LVSD2&quot;
</a><a href="#h53-0-42" id="h53-0-42" class="d">-                )
</a><a href="#h53-0-43" id="h53-0-43" class="d">-                .setSmallIcon(android.R.drawable.ic_dialog_info)
</a><a href="#h53-0-44" id="h53-0-44" class="d">-                .setAutoCancel(true)
</a><a href="#h53-0-45" id="h53-0-45" class="d">-                .setShowWhen(true)
</a><a href="#h53-0-46" id="h53-0-46" class="d">-                .setWhen(System.currentTimeMillis())
</a><a href="#h53-0-47" id="h53-0-47" class="d">-                .setContentIntent(context.androidContext.packageManager.getLaunchIntentForPackage(
</a><a href="#h53-0-48" id="h53-0-48" class="d">-                    Constants.SNAPCHAT_PACKAGE_NAME
</a><a href="#h53-0-49" id="h53-0-49" class="d">-                )?.let {
</a><a href="#h53-0-50" id="h53-0-50" class="d">-                    PendingIntent.getActivity(
</a><a href="#h53-0-51" id="h53-0-51" class="d">-                        context.androidContext,
</a><a href="#h53-0-52" id="h53-0-52" class="d">-                        0, it, PendingIntent.FLAG_IMMUTABLE
</a><a href="#h53-0-53" id="h53-0-53" class="d">-                    )
</a><a href="#h53-0-54" id="h53-0-54" class="d">-                })
</a><a href="#h53-0-55" id="h53-0-55" class="d">-                .setContentText(text)
</a><a href="#h53-0-56" id="h53-0-56" class="d">-                .build()
</a><a href="#h53-0-57" id="h53-0-57" class="d">-        )
</a><a href="#h53-0-58" id="h53-0-58" class="d">-    }
</a><a href="#h53-0-59" id="h53-0-59" class="d">-
</a><a href="#h53-0-60" id="h53-0-60" class="d">-    private fun handleVolatileEvent(protoReader: ProtoReader) {
</a><a href="#h53-0-61" id="h53-0-61" class="d">-        context.log.verbose(&quot;volatile event\n$protoReader&quot;)
</a><a href="#h53-0-62" id="h53-0-62" class="d">-    }
</a><a href="#h53-0-63" id="h53-0-63" class="d">-
</a><a href="#h53-0-64" id="h53-0-64" class="d">-    private fun onConversationPresenceUpdate(conversationId: String, userId: String, oldState: FriendPresenceState?, currentState: FriendPresenceState?) {
</a><a href="#h53-0-65" id="h53-0-65" class="d">-        context.log.verbose(&quot;presence state for $userId in conversation $conversationId\n$currentState&quot;)
</a><a href="#h53-0-66" id="h53-0-66" class="d">-
</a><a href="#h53-0-67" id="h53-0-67" class="d">-        val eventType = when {
</a><a href="#h53-0-68" id="h53-0-68" class="d">-            (oldState == null || currentState?.bitmojiPresent == false) &amp;&amp; currentState?.bitmojiPresent == true -&gt; TrackerEventType.CONVERSATION_ENTER
</a><a href="#h53-0-69" id="h53-0-69" class="d">-            (currentState == null || oldState?.bitmojiPresent == false) &amp;&amp; oldState?.bitmojiPresent == true -&gt; TrackerEventType.CONVERSATION_EXIT
</a><a href="#h53-0-70" id="h53-0-70" class="d">-            oldState?.typing == false &amp;&amp; currentState?.typing == true -&gt; if (currentState.speaking) TrackerEventType.STARTED_SPEAKING else TrackerEventType.STARTED_TYPING
</a><a href="#h53-0-71" id="h53-0-71" class="d">-            oldState?.typing == true &amp;&amp; (currentState == null || !currentState.typing) -&gt; if (oldState.speaking) TrackerEventType.STOPPED_SPEAKING else TrackerEventType.STOPPED_TYPING
</a><a href="#h53-0-72" id="h53-0-72" class="d">-            (oldState == null || !oldState.peeking) &amp;&amp; currentState?.peeking == true -&gt; TrackerEventType.STARTED_PEEKING
</a><a href="#h53-0-73" id="h53-0-73" class="d">-            oldState?.peeking == true &amp;&amp; (currentState == null || !currentState.peeking) -&gt; TrackerEventType.STOPPED_PEEKING
</a><a href="#h53-0-74" id="h53-0-74" class="d">-            else -&gt; null
</a><a href="#h53-0-75" id="h53-0-75" class="d">-        } ?: return
</a><a href="#h53-0-76" id="h53-0-76" class="d">-
</a><a href="#h53-0-77" id="h53-0-77" class="d">-        val feedEntry = context.database.getFeedEntryByConversationId(conversationId)
</a><a href="#h53-0-78" id="h53-0-78" class="d">-        val conversationName = feedEntry?.feedDisplayName ?: &quot;DMs&quot;
</a><a href="#h53-0-79" id="h53-0-79" class="d">-        val authorName = context.database.getFriendInfo(userId)?.mutableUsername ?: &quot;Unknown&quot;
</a><a href="#h53-0-80" id="h53-0-80" class="d">-
</a><a href="#h53-0-81" id="h53-0-81" class="d">-        context.log.verbose(&quot;$authorName $eventType in $conversationName&quot;)
</a><a href="#h53-0-82" id="h53-0-82" class="d">-
</a><a href="#h53-0-83" id="h53-0-83" class="d">-        getTrackedEvents(eventType)?.takeIf { it.canTrackOn(conversationId, userId) }?.apply {
</a><a href="#h53-0-84" id="h53-0-84" class="d">-            if (hasFlags(TrackerFlags.APP_IS_ACTIVE) &amp;&amp; context.isMainActivityPaused) return
</a><a href="#h53-0-85" id="h53-0-85" class="d">-            if (hasFlags(TrackerFlags.APP_IS_INACTIVE) &amp;&amp; !context.isMainActivityPaused) return
</a><a href="#h53-0-86" id="h53-0-86" class="d">-            if (hasFlags(TrackerFlags.IS_IN_CONVERSATION) &amp;&amp; !isInConversation(conversationId)) return
</a><a href="#h53-0-87" id="h53-0-87" class="d">-            if (hasFlags(TrackerFlags.NOTIFY)) sendInfoNotification(text = &quot;$authorName $eventType in $conversationName&quot;)
</a><a href="#h53-0-88" id="h53-0-88" class="d">-            if (hasFlags(TrackerFlags.LOG)) {
</a><a href="#h53-0-89" id="h53-0-89" class="d">-                context.bridgeClient.getMessageLogger().logTrackerEvent(
</a><a href="#h53-0-90" id="h53-0-90" class="d">-                    conversationId,
</a><a href="#h53-0-91" id="h53-0-91" class="d">-                    conversationName,
</a><a href="#h53-0-92" id="h53-0-92" class="d">-                    context.database.getConversationType(conversationId) == 1,
</a><a href="#h53-0-93" id="h53-0-93" class="d">-                    authorName,
</a><a href="#h53-0-94" id="h53-0-94" class="d">-                    userId,
</a><a href="#h53-0-95" id="h53-0-95" class="d">-                    eventType.key,
</a><a href="#h53-0-96" id="h53-0-96" class="d">-                    &quot;&quot;
</a><a href="#h53-0-97" id="h53-0-97" class="d">-                )
</a><a href="#h53-0-98" id="h53-0-98" class="d">-            }
</a><a href="#h53-0-99" id="h53-0-99" class="d">-        }
</a><a href="#h53-0-100" id="h53-0-100" class="d">-    }
</a><a href="#h53-0-101" id="h53-0-101" class="d">-
</a><a href="#h53-0-102" id="h53-0-102" class="d">-    private fun onConversationMessagingEvent(event: SessionEvent) {
</a><a href="#h53-0-103" id="h53-0-103" class="d">-        context.log.verbose(&quot;conversation messaging event\n${event.type} in ${event.conversationId} from ${event.authorUserId}&quot;)
</a><a href="#h53-0-104" id="h53-0-104" class="d">-        val isConversationGroup = context.database.getConversationType(event.conversationId) == 1
</a><a href="#h53-0-105" id="h53-0-105" class="d">-        val authorName = context.database.getFriendInfo(event.authorUserId)?.mutableUsername ?: &quot;Unknown&quot;
</a><a href="#h53-0-106" id="h53-0-106" class="d">-        val conversationName = context.database.getFeedEntryByConversationId(event.conversationId)?.feedDisplayName ?: &quot;DMs&quot;
</a><a href="#h53-0-107" id="h53-0-107" class="d">-
</a><a href="#h53-0-108" id="h53-0-108" class="d">-        val conversationMessage by lazy {
</a><a href="#h53-0-109" id="h53-0-109" class="d">-            (event as? SessionMessageEvent)?.serverMessageId?.let { context.database.getConversationServerMessage(event.conversationId, it) }
</a><a href="#h53-0-110" id="h53-0-110" class="d">-        }
</a><a href="#h53-0-111" id="h53-0-111" class="d">-
</a><a href="#h53-0-112" id="h53-0-112" class="d">-        val eventType = when(event.type) {
</a><a href="#h53-0-113" id="h53-0-113" class="d">-            SessionEventType.MESSAGE_READ_RECEIPTS -&gt; TrackerEventType.MESSAGE_READ
</a><a href="#h53-0-114" id="h53-0-114" class="d">-            SessionEventType.MESSAGE_DELETED -&gt; TrackerEventType.MESSAGE_DELETED
</a><a href="#h53-0-115" id="h53-0-115" class="d">-            SessionEventType.MESSAGE_REACTION_ADD -&gt; TrackerEventType.MESSAGE_REACTION_ADD
</a><a href="#h53-0-116" id="h53-0-116" class="d">-            SessionEventType.MESSAGE_REACTION_REMOVE -&gt; TrackerEventType.MESSAGE_REACTION_REMOVE
</a><a href="#h53-0-117" id="h53-0-117" class="d">-            SessionEventType.MESSAGE_SAVED -&gt; TrackerEventType.MESSAGE_SAVED
</a><a href="#h53-0-118" id="h53-0-118" class="d">-            SessionEventType.MESSAGE_UNSAVED -&gt; TrackerEventType.MESSAGE_UNSAVED
</a><a href="#h53-0-119" id="h53-0-119" class="d">-            SessionEventType.SNAP_OPENED -&gt; TrackerEventType.SNAP_OPENED
</a><a href="#h53-0-120" id="h53-0-120" class="d">-            SessionEventType.SNAP_REPLAYED -&gt; TrackerEventType.SNAP_REPLAYED
</a><a href="#h53-0-121" id="h53-0-121" class="d">-            SessionEventType.SNAP_REPLAYED_TWICE -&gt; TrackerEventType.SNAP_REPLAYED_TWICE
</a><a href="#h53-0-122" id="h53-0-122" class="d">-            SessionEventType.SNAP_SCREENSHOT -&gt; TrackerEventType.SNAP_SCREENSHOT
</a><a href="#h53-0-123" id="h53-0-123" class="d">-            SessionEventType.SNAP_SCREEN_RECORD -&gt; TrackerEventType.SNAP_SCREEN_RECORD
</a><a href="#h53-0-124" id="h53-0-124" class="d">-            else -&gt; return
</a><a href="#h53-0-125" id="h53-0-125" class="d">-        }
</a><a href="#h53-0-126" id="h53-0-126" class="d">-
</a><a href="#h53-0-127" id="h53-0-127" class="d">-        val messageEvents = arrayOf(
</a><a href="#h53-0-128" id="h53-0-128" class="d">-            TrackerEventType.MESSAGE_READ,
</a><a href="#h53-0-129" id="h53-0-129" class="d">-            TrackerEventType.MESSAGE_DELETED,
</a><a href="#h53-0-130" id="h53-0-130" class="d">-            TrackerEventType.MESSAGE_REACTION_ADD,
</a><a href="#h53-0-131" id="h53-0-131" class="d">-            TrackerEventType.MESSAGE_REACTION_REMOVE,
</a><a href="#h53-0-132" id="h53-0-132" class="d">-            TrackerEventType.MESSAGE_SAVED,
</a><a href="#h53-0-133" id="h53-0-133" class="d">-            TrackerEventType.MESSAGE_UNSAVED
</a><a href="#h53-0-134" id="h53-0-134" class="d">-        )
</a><a href="#h53-0-135" id="h53-0-135" class="d">-
</a><a href="#h53-0-136" id="h53-0-136" class="d">-        getTrackedEvents(eventType)?.takeIf { it.canTrackOn(event.conversationId, event.authorUserId) }?.apply {
</a><a href="#h53-0-137" id="h53-0-137" class="d">-            if (messageEvents.contains(eventType) &amp;&amp; conversationMessage?.senderId == context.database.myUserId) return
</a><a href="#h53-0-138" id="h53-0-138" class="d">-
</a><a href="#h53-0-139" id="h53-0-139" class="d">-            if (hasFlags(TrackerFlags.APP_IS_ACTIVE) &amp;&amp; context.isMainActivityPaused) return
</a><a href="#h53-0-140" id="h53-0-140" class="d">-            if (hasFlags(TrackerFlags.APP_IS_INACTIVE) &amp;&amp; !context.isMainActivityPaused) return
</a><a href="#h53-0-141" id="h53-0-141" class="d">-            if (hasFlags(TrackerFlags.IS_IN_CONVERSATION) &amp;&amp; !isInConversation(event.conversationId)) return
</a><a href="#h53-0-142" id="h53-0-142" class="d">-            if (hasFlags(TrackerFlags.NOTIFY)) sendInfoNotification(text = &quot;$authorName $eventType in $conversationName&quot;)
</a><a href="#h53-0-143" id="h53-0-143" class="d">-            if (hasFlags(TrackerFlags.LOG)) {
</a><a href="#h53-0-144" id="h53-0-144" class="d">-                context.bridgeClient.getMessageLogger().logTrackerEvent(
</a><a href="#h53-0-145" id="h53-0-145" class="d">-                    event.conversationId,
</a><a href="#h53-0-146" id="h53-0-146" class="d">-                    conversationName,
</a><a href="#h53-0-147" id="h53-0-147" class="d">-                    isConversationGroup,
</a><a href="#h53-0-148" id="h53-0-148" class="d">-                    authorName,
</a><a href="#h53-0-149" id="h53-0-149" class="d">-                    event.authorUserId,
</a><a href="#h53-0-150" id="h53-0-150" class="d">-                    eventType.key,
</a><a href="#h53-0-151" id="h53-0-151" class="d">-                    messageEvents.takeIf { it.contains(eventType) }?.let {
</a><a href="#h53-0-152" id="h53-0-152" class="d">-                        conversationMessage?.contentType?.let { ContentType.fromId(it) } ?.name
</a><a href="#h53-0-153" id="h53-0-153" class="d">-                    } ?: &quot;&quot;
</a><a href="#h53-0-154" id="h53-0-154" class="d">-                )
</a><a href="#h53-0-155" id="h53-0-155" class="d">-            }
</a><a href="#h53-0-156" id="h53-0-156" class="d">-        }
</a><a href="#h53-0-157" id="h53-0-157" class="d">-    }
</a><a href="#h53-0-158" id="h53-0-158" class="d">-
</a><a href="#h53-0-159" id="h53-0-159" class="d">-    private fun handlePresenceEvent(protoReader: ProtoReader) {
</a><a href="#h53-0-160" id="h53-0-160" class="d">-        val conversationId = protoReader.getString(6) ?: return
</a><a href="#h53-0-161" id="h53-0-161" class="d">-
</a><a href="#h53-0-162" id="h53-0-162" class="d">-        val presenceMap = conversationPresenceState.getOrPut(conversationId) { mutableMapOf() }.toMutableMap()
</a><a href="#h53-0-163" id="h53-0-163" class="d">-        val userIds = mutableSetOf&lt;String&gt;()
</a><a href="#h53-0-164" id="h53-0-164" class="d">-
</a><a href="#h53-0-165" id="h53-0-165" class="d">-        protoReader.eachBuffer(4) {
</a><a href="#h53-0-166" id="h53-0-166" class="d">-            val participantUserId = getString(1)?.takeIf { it.contains(&quot;:&quot;) }?.substringBefore(&quot;:&quot;) ?: return@eachBuffer
</a><a href="#h53-0-167" id="h53-0-167" class="d">-            userIds.add(participantUserId)
</a><a href="#h53-0-168" id="h53-0-168" class="d">-            if (participantUserId == context.database.myUserId) return@eachBuffer
</a><a href="#h53-0-169" id="h53-0-169" class="d">-            val stateMap = getVarInt(2, 1)?.toString(2)?.padStart(16, &#39;0&#39;)?.reversed()?.map { it == &#39;1&#39; } ?: return@eachBuffer
</a><a href="#h53-0-170" id="h53-0-170" class="d">-
</a><a href="#h53-0-171" id="h53-0-171" class="d">-            presenceMap[participantUserId] = FriendPresenceState(
</a><a href="#h53-0-172" id="h53-0-172" class="d">-                bitmojiPresent = stateMap[0],
</a><a href="#h53-0-173" id="h53-0-173" class="d">-                typing = stateMap[4],
</a><a href="#h53-0-174" id="h53-0-174" class="d">-                wasTyping = stateMap[5],
</a><a href="#h53-0-175" id="h53-0-175" class="d">-                speaking = stateMap[6] &amp;&amp; stateMap[4],
</a><a href="#h53-0-176" id="h53-0-176" class="d">-                peeking = stateMap[8]
</a><a href="#h53-0-177" id="h53-0-177" class="d">-            )
</a><a href="#h53-0-178" id="h53-0-178" class="d">-        }
</a><a href="#h53-0-179" id="h53-0-179" class="d">-
</a><a href="#h53-0-180" id="h53-0-180" class="d">-        presenceMap.keys.filterNot { it in userIds }.forEach { presenceMap[it] = null }
</a><a href="#h53-0-181" id="h53-0-181" class="d">-
</a><a href="#h53-0-182" id="h53-0-182" class="d">-        presenceMap.forEach { (userId, state) -&gt;
</a><a href="#h53-0-183" id="h53-0-183" class="d">-            val oldState = conversationPresenceState[conversationId]?.get(userId)
</a><a href="#h53-0-184" id="h53-0-184" class="d">-            if (oldState != state) {
</a><a href="#h53-0-185" id="h53-0-185" class="d">-                onConversationPresenceUpdate(conversationId, userId, oldState, state)
</a><a href="#h53-0-186" id="h53-0-186" class="d">-            }
</a><a href="#h53-0-187" id="h53-0-187" class="d">-        }
</a><a href="#h53-0-188" id="h53-0-188" class="d">-
</a><a href="#h53-0-189" id="h53-0-189" class="d">-        conversationPresenceState[conversationId] = presenceMap
</a><a href="#h53-0-190" id="h53-0-190" class="d">-    }
</a><a href="#h53-0-191" id="h53-0-191" class="d">-
</a><a href="#h53-0-192" id="h53-0-192" class="d">-    private fun handleMessagingEvent(protoReader: ProtoReader) {
</a><a href="#h53-0-193" id="h53-0-193" class="d">-        // read receipts
</a><a href="#h53-0-194" id="h53-0-194" class="d">-        protoReader.followPath(12) {
</a><a href="#h53-0-195" id="h53-0-195" class="d">-            val conversationId = getByteArray(1, 1)?.toSnapUUID()?.toString() ?: return@followPath
</a><a href="#h53-0-196" id="h53-0-196" class="d">-
</a><a href="#h53-0-197" id="h53-0-197" class="d">-            followPath(7) readReceipts@{
</a><a href="#h53-0-198" id="h53-0-198" class="d">-                val senderId = getByteArray(1, 1)?.toSnapUUID()?.toString() ?: return@readReceipts
</a><a href="#h53-0-199" id="h53-0-199" class="d">-                val serverMessageId = getVarInt(2, 2) ?: return@readReceipts
</a><a href="#h53-0-200" id="h53-0-200" class="d">-
</a><a href="#h53-0-201" id="h53-0-201" class="d">-                onConversationMessagingEvent(
</a><a href="#h53-0-202" id="h53-0-202" class="d">-                    SessionMessageEvent(
</a><a href="#h53-0-203" id="h53-0-203" class="d">-                        SessionEventType.MESSAGE_READ_RECEIPTS,
</a><a href="#h53-0-204" id="h53-0-204" class="d">-                        conversationId,
</a><a href="#h53-0-205" id="h53-0-205" class="d">-                        senderId,
</a><a href="#h53-0-206" id="h53-0-206" class="d">-                        serverMessageId,
</a><a href="#h53-0-207" id="h53-0-207" class="d">-                    )
</a><a href="#h53-0-208" id="h53-0-208" class="d">-                )
</a><a href="#h53-0-209" id="h53-0-209" class="d">-            }
</a><a href="#h53-0-210" id="h53-0-210" class="d">-        }
</a><a href="#h53-0-211" id="h53-0-211" class="d">-
</a><a href="#h53-0-212" id="h53-0-212" class="d">-        protoReader.followPath(6, 2) {
</a><a href="#h53-0-213" id="h53-0-213" class="d">-            val conversationId = getByteArray(3, 1)?.toSnapUUID()?.toString() ?: return@followPath
</a><a href="#h53-0-214" id="h53-0-214" class="d">-            val senderId = getByteArray(1, 1)?.toSnapUUID()?.toString() ?: return@followPath
</a><a href="#h53-0-215" id="h53-0-215" class="d">-            val serverMessageId = getVarInt(2) ?: return@followPath
</a><a href="#h53-0-216" id="h53-0-216" class="d">-
</a><a href="#h53-0-217" id="h53-0-217" class="d">-            if (contains(4)) {
</a><a href="#h53-0-218" id="h53-0-218" class="d">-                onConversationMessagingEvent(
</a><a href="#h53-0-219" id="h53-0-219" class="d">-                    SessionMessageEvent(
</a><a href="#h53-0-220" id="h53-0-220" class="d">-                        SessionEventType.SNAP_OPENED,
</a><a href="#h53-0-221" id="h53-0-221" class="d">-                        conversationId,
</a><a href="#h53-0-222" id="h53-0-222" class="d">-                        senderId,
</a><a href="#h53-0-223" id="h53-0-223" class="d">-                        serverMessageId
</a><a href="#h53-0-224" id="h53-0-224" class="d">-                    )
</a><a href="#h53-0-225" id="h53-0-225" class="d">-                )
</a><a href="#h53-0-226" id="h53-0-226" class="d">-            }
</a><a href="#h53-0-227" id="h53-0-227" class="d">-
</a><a href="#h53-0-228" id="h53-0-228" class="d">-            if (contains(13)) {
</a><a href="#h53-0-229" id="h53-0-229" class="d">-                onConversationMessagingEvent(
</a><a href="#h53-0-230" id="h53-0-230" class="d">-                    SessionMessageEvent(
</a><a href="#h53-0-231" id="h53-0-231" class="d">-                        if (getVarInt(13, 1) == 2L) SessionEventType.SNAP_REPLAYED_TWICE else SessionEventType.SNAP_REPLAYED,
</a><a href="#h53-0-232" id="h53-0-232" class="d">-                        conversationId,
</a><a href="#h53-0-233" id="h53-0-233" class="d">-                        senderId,
</a><a href="#h53-0-234" id="h53-0-234" class="d">-                        serverMessageId
</a><a href="#h53-0-235" id="h53-0-235" class="d">-                    )
</a><a href="#h53-0-236" id="h53-0-236" class="d">-                )
</a><a href="#h53-0-237" id="h53-0-237" class="d">-            }
</a><a href="#h53-0-238" id="h53-0-238" class="d">-
</a><a href="#h53-0-239" id="h53-0-239" class="d">-            if (contains(6) || contains(7)) {
</a><a href="#h53-0-240" id="h53-0-240" class="d">-                onConversationMessagingEvent(
</a><a href="#h53-0-241" id="h53-0-241" class="d">-                    SessionMessageEvent(
</a><a href="#h53-0-242" id="h53-0-242" class="d">-                        if (contains(6)) SessionEventType.MESSAGE_SAVED else SessionEventType.MESSAGE_UNSAVED,
</a><a href="#h53-0-243" id="h53-0-243" class="d">-                        conversationId,
</a><a href="#h53-0-244" id="h53-0-244" class="d">-                        senderId,
</a><a href="#h53-0-245" id="h53-0-245" class="d">-                        serverMessageId
</a><a href="#h53-0-246" id="h53-0-246" class="d">-                    )
</a><a href="#h53-0-247" id="h53-0-247" class="d">-                )
</a><a href="#h53-0-248" id="h53-0-248" class="d">-            }
</a><a href="#h53-0-249" id="h53-0-249" class="d">-
</a><a href="#h53-0-250" id="h53-0-250" class="d">-            if (contains(11) || contains(12)) {
</a><a href="#h53-0-251" id="h53-0-251" class="d">-                onConversationMessagingEvent(
</a><a href="#h53-0-252" id="h53-0-252" class="d">-                    SessionMessageEvent(
</a><a href="#h53-0-253" id="h53-0-253" class="d">-                        if (contains(11)) SessionEventType.SNAP_SCREENSHOT else SessionEventType.SNAP_SCREEN_RECORD,
</a><a href="#h53-0-254" id="h53-0-254" class="d">-                        conversationId,
</a><a href="#h53-0-255" id="h53-0-255" class="d">-                        senderId,
</a><a href="#h53-0-256" id="h53-0-256" class="d">-                        serverMessageId,
</a><a href="#h53-0-257" id="h53-0-257" class="d">-                    )
</a><a href="#h53-0-258" id="h53-0-258" class="d">-                )
</a><a href="#h53-0-259" id="h53-0-259" class="d">-            }
</a><a href="#h53-0-260" id="h53-0-260" class="d">-
</a><a href="#h53-0-261" id="h53-0-261" class="d">-            followPath(16) {
</a><a href="#h53-0-262" id="h53-0-262" class="d">-                onConversationMessagingEvent(
</a><a href="#h53-0-263" id="h53-0-263" class="d">-                    SessionMessageEvent(
</a><a href="#h53-0-264" id="h53-0-264" class="d">-                        SessionEventType.MESSAGE_REACTION_ADD, conversationId, senderId, serverMessageId, reactionId = getVarInt(1, 1, 1)?.toInt() ?: -1
</a><a href="#h53-0-265" id="h53-0-265" class="d">-                    )
</a><a href="#h53-0-266" id="h53-0-266" class="d">-                )
</a><a href="#h53-0-267" id="h53-0-267" class="d">-            }
</a><a href="#h53-0-268" id="h53-0-268" class="d">-
</a><a href="#h53-0-269" id="h53-0-269" class="d">-            if (contains(17)) {
</a><a href="#h53-0-270" id="h53-0-270" class="d">-                onConversationMessagingEvent(
</a><a href="#h53-0-271" id="h53-0-271" class="d">-                    SessionMessageEvent(SessionEventType.MESSAGE_REACTION_REMOVE, conversationId, senderId, serverMessageId)
</a><a href="#h53-0-272" id="h53-0-272" class="d">-                )
</a><a href="#h53-0-273" id="h53-0-273" class="d">-            }
</a><a href="#h53-0-274" id="h53-0-274" class="d">-
</a><a href="#h53-0-275" id="h53-0-275" class="d">-            followPath(8) {
</a><a href="#h53-0-276" id="h53-0-276" class="d">-                onConversationMessagingEvent(
</a><a href="#h53-0-277" id="h53-0-277" class="d">-                    SessionMessageEvent(SessionEventType.MESSAGE_DELETED, conversationId, senderId, serverMessageId, messageData = getByteArray(1))
</a><a href="#h53-0-278" id="h53-0-278" class="d">-                )
</a><a href="#h53-0-279" id="h53-0-279" class="d">-            }
</a><a href="#h53-0-280" id="h53-0-280" class="d">-        }
</a><a href="#h53-0-281" id="h53-0-281" class="d">-    }
</a><a href="#h53-0-282" id="h53-0-282" class="d">-
</a><a href="#h53-0-283" id="h53-0-283" class="d">-    override fun init() {
</a><a href="#h53-0-284" id="h53-0-284" class="d">-        val sessionEventsConfig = context.config.experimental.sessionEvents
</a><a href="#h53-0-285" id="h53-0-285" class="d">-        if (sessionEventsConfig.globalState != true) return
</a><a href="#h53-0-286" id="h53-0-286" class="d">-
</a><a href="#h53-0-287" id="h53-0-287" class="d">-        if (sessionEventsConfig.allowRunningInBackground.get()) {
</a><a href="#h53-0-288" id="h53-0-288" class="d">-            findClass(&quot;com.snapchat.client.duplex.DuplexClient\$CppProxy&quot;).apply {
</a><a href="#h53-0-289" id="h53-0-289" class="d">-                // prevent disabling events when the app is inactive
</a><a href="#h53-0-290" id="h53-0-290" class="d">-                hook(&quot;appStateChanged&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h53-0-291" id="h53-0-291" class="d">-                    if (param.arg&lt;Any&gt;(0).toString() == &quot;INACTIVE&quot;) param.setResult(null)
</a><a href="#h53-0-292" id="h53-0-292" class="d">-                }
</a><a href="#h53-0-293" id="h53-0-293" class="d">-                // allow events when a notification is received
</a><a href="#h53-0-294" id="h53-0-294" class="d">-                hookConstructor(HookStage.AFTER) { param -&gt;
</a><a href="#h53-0-295" id="h53-0-295" class="d">-                    methods.first { it.name == &quot;appStateChanged&quot; }.let { method -&gt;
</a><a href="#h53-0-296" id="h53-0-296" class="d">-                        method.invoke(param.thisObject(), method.parameterTypes[0].enumConstants.first { it.toString() == &quot;ACTIVE&quot; })
</a><a href="#h53-0-297" id="h53-0-297" class="d">-                    }
</a><a href="#h53-0-298" id="h53-0-298" class="d">-                }
</a><a href="#h53-0-299" id="h53-0-299" class="d">-            }
</a><a href="#h53-0-300" id="h53-0-300" class="d">-        }
</a><a href="#h53-0-301" id="h53-0-301" class="d">-
</a><a href="#h53-0-302" id="h53-0-302" class="d">-        if (sessionEventsConfig.captureDuplexEvents.get()) {
</a><a href="#h53-0-303" id="h53-0-303" class="d">-            val messageHandlerClass = findClass(&quot;com.snapchat.client.duplex.MessageHandler\$CppProxy&quot;).apply {
</a><a href="#h53-0-304" id="h53-0-304" class="d">-                hook(&quot;onReceive&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h53-0-305" id="h53-0-305" class="d">-                    param.setResult(null)
</a><a href="#h53-0-306" id="h53-0-306" class="d">-
</a><a href="#h53-0-307" id="h53-0-307" class="d">-                    val byteBuffer = param.arg&lt;ByteBuffer&gt;(0)
</a><a href="#h53-0-308" id="h53-0-308" class="d">-                    val content = byteBuffer.let {
</a><a href="#h53-0-309" id="h53-0-309" class="d">-                        val bytes = ByteArray(it.limit())
</a><a href="#h53-0-310" id="h53-0-310" class="d">-                        it.get(bytes)
</a><a href="#h53-0-311" id="h53-0-311" class="d">-                        bytes
</a><a href="#h53-0-312" id="h53-0-312" class="d">-                    }
</a><a href="#h53-0-313" id="h53-0-313" class="d">-                    val reader = ProtoReader(content)
</a><a href="#h53-0-314" id="h53-0-314" class="d">-                    reader.getString(1, 1)?.let {
</a><a href="#h53-0-315" id="h53-0-315" class="d">-                        val eventData = reader.followPath(1, 2) ?: return@let
</a><a href="#h53-0-316" id="h53-0-316" class="d">-                        if (it == &quot;volatile&quot;) {
</a><a href="#h53-0-317" id="h53-0-317" class="d">-                            handleVolatileEvent(eventData)
</a><a href="#h53-0-318" id="h53-0-318" class="d">-                            return@hook
</a><a href="#h53-0-319" id="h53-0-319" class="d">-                        }
</a><a href="#h53-0-320" id="h53-0-320" class="d">-
</a><a href="#h53-0-321" id="h53-0-321" class="d">-                        if (it == &quot;presence&quot;) {
</a><a href="#h53-0-322" id="h53-0-322" class="d">-                            handlePresenceEvent(eventData)
</a><a href="#h53-0-323" id="h53-0-323" class="d">-                            return@hook
</a><a href="#h53-0-324" id="h53-0-324" class="d">-                        }
</a><a href="#h53-0-325" id="h53-0-325" class="d">-                    }
</a><a href="#h53-0-326" id="h53-0-326" class="d">-                    handleMessagingEvent(reader)
</a><a href="#h53-0-327" id="h53-0-327" class="d">-                }
</a><a href="#h53-0-328" id="h53-0-328" class="d">-                hook(&quot;nativeDestroy&quot;, HookStage.BEFORE) { it.setResult(null) }
</a><a href="#h53-0-329" id="h53-0-329" class="d">-            }
</a><a href="#h53-0-330" id="h53-0-330" class="d">-
</a><a href="#h53-0-331" id="h53-0-331" class="d">-
</a><a href="#h53-0-332" id="h53-0-332" class="d">-            findClass(&quot;com.snapchat.client.messaging.Session&quot;).hook(&quot;create&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h53-0-333" id="h53-0-333" class="d">-                if (!NativeLib.initialized) {
</a><a href="#h53-0-334" id="h53-0-334" class="d">-                    context.log.warn(&quot;Can&#39;t register duplex message handler, native lib not initialized&quot;)
</a><a href="#h53-0-335" id="h53-0-335" class="d">-                    return@hook
</a><a href="#h53-0-336" id="h53-0-336" class="d">-                }
</a><a href="#h53-0-337" id="h53-0-337" class="d">-
</a><a href="#h53-0-338" id="h53-0-338" class="d">-                val method = param.method() as Method
</a><a href="#h53-0-339" id="h53-0-339" class="d">-                val duplexClient = method.parameterTypes.indexOfFirst { it.name.endsWith(&quot;DuplexClient&quot;) }.let {
</a><a href="#h53-0-340" id="h53-0-340" class="d">-                    param.arg&lt;Any&gt;(it)
</a><a href="#h53-0-341" id="h53-0-341" class="d">-                }
</a><a href="#h53-0-342" id="h53-0-342" class="d">-                val dispatchQueue = method.parameterTypes.indexOfFirst { it.name.endsWith(&quot;DispatchQueue&quot;) }.let {
</a><a href="#h53-0-343" id="h53-0-343" class="d">-                    param.arg&lt;Any&gt;(it)
</a><a href="#h53-0-344" id="h53-0-344" class="d">-                }
</a><a href="#h53-0-345" id="h53-0-345" class="d">-                for (channel in arrayOf(&quot;pcs&quot;, &quot;mcs&quot;)) {
</a><a href="#h53-0-346" id="h53-0-346" class="d">-                    duplexClient::class.java.methods.first {
</a><a href="#h53-0-347" id="h53-0-347" class="d">-                        it.name == &quot;registerHandler&quot;
</a><a href="#h53-0-348" id="h53-0-348" class="d">-                    }.invoke(
</a><a href="#h53-0-349" id="h53-0-349" class="d">-                        duplexClient,
</a><a href="#h53-0-350" id="h53-0-350" class="d">-                        channel,
</a><a href="#h53-0-351" id="h53-0-351" class="d">-                        messageHandlerClass.declaredConstructors.first().also { it.isAccessible = true }.newInstance(-1),
</a><a href="#h53-0-352" id="h53-0-352" class="d">-                        dispatchQueue
</a><a href="#h53-0-353" id="h53-0-353" class="d">-                    )
</a><a href="#h53-0-354" id="h53-0-354" class="d">-                }
</a><a href="#h53-0-355" id="h53-0-355" class="d">-            }
</a><a href="#h53-0-356" id="h53-0-356" class="d">-        }
</a><a href="#h53-0-357" id="h53-0-357" class="d">-    }
</a><a href="#h53-0-358" id="h53-0-358" class="d">-}</a><a href="#h53-0-359" id="h53-0-359" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h54" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/spying/FriendTracker.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/spying/FriendTracker.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/spying/FriendTracker.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/spying/FriendTracker.kt</a></b>
<a href="#h54-0" id="h54-0" class="h">@@ -0,0 +1,383 @@
</a><a href="#h54-0-0" id="h54-0-0" class="i">+package me.rhunk.snapenhance.core.features.impl.spying
</a><a href="#h54-0-1" id="h54-0-1" class="i">+
</a><a href="#h54-0-2" id="h54-0-2" class="i">+import android.app.Notification
</a><a href="#h54-0-3" id="h54-0-3" class="i">+import android.app.NotificationChannel
</a><a href="#h54-0-4" id="h54-0-4" class="i">+import android.app.NotificationManager
</a><a href="#h54-0-5" id="h54-0-5" class="i">+import android.app.PendingIntent
</a><a href="#h54-0-6" id="h54-0-6" class="i">+import androidx.compose.material.icons.Icons
</a><a href="#h54-0-7" id="h54-0-7" class="i">+import androidx.compose.material.icons.filled.Info
</a><a href="#h54-0-8" id="h54-0-8" class="i">+import me.rhunk.snapenhance.common.Constants
</a><a href="#h54-0-9" id="h54-0-9" class="i">+import me.rhunk.snapenhance.common.data.*
</a><a href="#h54-0-10" id="h54-0-10" class="i">+import me.rhunk.snapenhance.common.util.protobuf.ProtoReader
</a><a href="#h54-0-11" id="h54-0-11" class="i">+import me.rhunk.snapenhance.common.util.toParcelable
</a><a href="#h54-0-12" id="h54-0-12" class="i">+import me.rhunk.snapenhance.core.features.Feature
</a><a href="#h54-0-13" id="h54-0-13" class="i">+import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a><a href="#h54-0-14" id="h54-0-14" class="i">+import me.rhunk.snapenhance.core.features.impl.messaging.Messaging
</a><a href="#h54-0-15" id="h54-0-15" class="i">+import me.rhunk.snapenhance.core.util.hook.HookStage
</a><a href="#h54-0-16" id="h54-0-16" class="i">+import me.rhunk.snapenhance.core.util.hook.hook
</a><a href="#h54-0-17" id="h54-0-17" class="i">+import me.rhunk.snapenhance.core.util.hook.hookConstructor
</a><a href="#h54-0-18" id="h54-0-18" class="i">+import me.rhunk.snapenhance.core.wrapper.impl.SnapUUID
</a><a href="#h54-0-19" id="h54-0-19" class="i">+import me.rhunk.snapenhance.core.wrapper.impl.toSnapUUID
</a><a href="#h54-0-20" id="h54-0-20" class="i">+import me.rhunk.snapenhance.nativelib.NativeLib
</a><a href="#h54-0-21" id="h54-0-21" class="i">+import java.lang.reflect.Method
</a><a href="#h54-0-22" id="h54-0-22" class="i">+import java.nio.ByteBuffer
</a><a href="#h54-0-23" id="h54-0-23" class="i">+
</a><a href="#h54-0-24" id="h54-0-24" class="i">+class FriendTracker : Feature(&quot;Friend Tracker&quot;, loadParams = FeatureLoadParams.INIT_SYNC) {
</a><a href="#h54-0-25" id="h54-0-25" class="i">+    private val conversationPresenceState = mutableMapOf&lt;String, MutableMap&lt;String, FriendPresenceState?&gt;&gt;() // conversationId -&gt; (userId -&gt; state)
</a><a href="#h54-0-26" id="h54-0-26" class="i">+    private val tracker by lazy { context.bridgeClient.getTracker() }
</a><a href="#h54-0-27" id="h54-0-27" class="i">+    private val notificationManager by lazy { context.androidContext.getSystemService(NotificationManager::class.java).apply {
</a><a href="#h54-0-28" id="h54-0-28" class="i">+        createNotificationChannel(NotificationChannel(
</a><a href="#h54-0-29" id="h54-0-29" class="i">+            &quot;friend_tracker&quot;,
</a><a href="#h54-0-30" id="h54-0-30" class="i">+            &quot;Friend Tracker&quot;,
</a><a href="#h54-0-31" id="h54-0-31" class="i">+            NotificationManager.IMPORTANCE_DEFAULT
</a><a href="#h54-0-32" id="h54-0-32" class="i">+        ))
</a><a href="#h54-0-33" id="h54-0-33" class="i">+    } }
</a><a href="#h54-0-34" id="h54-0-34" class="i">+
</a><a href="#h54-0-35" id="h54-0-35" class="i">+    private fun getTrackedEvents(eventType: TrackerEventType): TrackerEventsResult? {
</a><a href="#h54-0-36" id="h54-0-36" class="i">+        return runCatching {
</a><a href="#h54-0-37" id="h54-0-37" class="i">+            tracker.getTrackedEvents(eventType.key)?.let {
</a><a href="#h54-0-38" id="h54-0-38" class="i">+                toParcelable&lt;TrackerEventsResult&gt;(it)
</a><a href="#h54-0-39" id="h54-0-39" class="i">+            }
</a><a href="#h54-0-40" id="h54-0-40" class="i">+        }.onFailure {
</a><a href="#h54-0-41" id="h54-0-41" class="i">+            context.log.error(&quot;Failed to get tracked events for $eventType&quot;, it)
</a><a href="#h54-0-42" id="h54-0-42" class="i">+        }.getOrNull()
</a><a href="#h54-0-43" id="h54-0-43" class="i">+    }
</a><a href="#h54-0-44" id="h54-0-44" class="i">+
</a><a href="#h54-0-45" id="h54-0-45" class="i">+    private fun isInConversation(conversationId: String?) = context.feature(Messaging::class).openedConversationUUID?.toString() == conversationId
</a><a href="#h54-0-46" id="h54-0-46" class="i">+
</a><a href="#h54-0-47" id="h54-0-47" class="i">+    private fun sendInfoNotification(id: Int = System.nanoTime().toInt(), text: String) {
</a><a href="#h54-0-48" id="h54-0-48" class="i">+        notificationManager.notify(
</a><a href="#h54-0-49" id="h54-0-49" class="i">+            id,
</a><a href="#h54-0-50" id="h54-0-50" class="i">+            Notification.Builder(
</a><a href="#h54-0-51" id="h54-0-51" class="i">+                context.androidContext,
</a><a href="#h54-0-52" id="h54-0-52" class="i">+                &quot;friend_tracker&quot;
</a><a href="#h54-0-53" id="h54-0-53" class="i">+                )
</a><a href="#h54-0-54" id="h54-0-54" class="i">+                .setSmallIcon(android.R.drawable.ic_dialog_info)
</a><a href="#h54-0-55" id="h54-0-55" class="i">+                .setAutoCancel(true)
</a><a href="#h54-0-56" id="h54-0-56" class="i">+                .setShowWhen(true)
</a><a href="#h54-0-57" id="h54-0-57" class="i">+                .setWhen(System.currentTimeMillis())
</a><a href="#h54-0-58" id="h54-0-58" class="i">+                .setContentIntent(context.androidContext.packageManager.getLaunchIntentForPackage(
</a><a href="#h54-0-59" id="h54-0-59" class="i">+                    Constants.SNAPCHAT_PACKAGE_NAME
</a><a href="#h54-0-60" id="h54-0-60" class="i">+                )?.let {
</a><a href="#h54-0-61" id="h54-0-61" class="i">+                    PendingIntent.getActivity(
</a><a href="#h54-0-62" id="h54-0-62" class="i">+                        context.androidContext,
</a><a href="#h54-0-63" id="h54-0-63" class="i">+                        0, it, PendingIntent.FLAG_IMMUTABLE
</a><a href="#h54-0-64" id="h54-0-64" class="i">+                    )
</a><a href="#h54-0-65" id="h54-0-65" class="i">+                })
</a><a href="#h54-0-66" id="h54-0-66" class="i">+                .setContentText(text)
</a><a href="#h54-0-67" id="h54-0-67" class="i">+                .build()
</a><a href="#h54-0-68" id="h54-0-68" class="i">+        )
</a><a href="#h54-0-69" id="h54-0-69" class="i">+    }
</a><a href="#h54-0-70" id="h54-0-70" class="i">+
</a><a href="#h54-0-71" id="h54-0-71" class="i">+    private fun handleVolatileEvent(protoReader: ProtoReader) {
</a><a href="#h54-0-72" id="h54-0-72" class="i">+        context.log.verbose(&quot;volatile event\n$protoReader&quot;)
</a><a href="#h54-0-73" id="h54-0-73" class="i">+    }
</a><a href="#h54-0-74" id="h54-0-74" class="i">+
</a><a href="#h54-0-75" id="h54-0-75" class="i">+    private fun dispatchEvents(
</a><a href="#h54-0-76" id="h54-0-76" class="i">+        eventType: TrackerEventType,
</a><a href="#h54-0-77" id="h54-0-77" class="i">+        conversationId: String,
</a><a href="#h54-0-78" id="h54-0-78" class="i">+        userId: String,
</a><a href="#h54-0-79" id="h54-0-79" class="i">+        extras: String = &quot;&quot;
</a><a href="#h54-0-80" id="h54-0-80" class="i">+    ) {
</a><a href="#h54-0-81" id="h54-0-81" class="i">+        val feedEntry = context.database.getFeedEntryByConversationId(conversationId)
</a><a href="#h54-0-82" id="h54-0-82" class="i">+        val conversationName = feedEntry?.feedDisplayName ?: &quot;DMs&quot;
</a><a href="#h54-0-83" id="h54-0-83" class="i">+        val authorName = context.database.getFriendInfo(userId)?.mutableUsername ?: &quot;Unknown&quot;
</a><a href="#h54-0-84" id="h54-0-84" class="i">+
</a><a href="#h54-0-85" id="h54-0-85" class="i">+        context.log.verbose(&quot;$authorName $eventType in $conversationName&quot;)
</a><a href="#h54-0-86" id="h54-0-86" class="i">+
</a><a href="#h54-0-87" id="h54-0-87" class="i">+        getTrackedEvents(eventType)?.takeIf { it.canTrackOn(conversationId, userId) }?.getActions()?.forEach { (action, params) -&gt;
</a><a href="#h54-0-88" id="h54-0-88" class="i">+            if ((params.onlyWhenAppActive || action == TrackerRuleAction.IN_APP_NOTIFICATION) &amp;&amp; context.isMainActivityPaused) return@forEach
</a><a href="#h54-0-89" id="h54-0-89" class="i">+            if (params.onlyWhenAppInactive &amp;&amp; !context.isMainActivityPaused) return@forEach
</a><a href="#h54-0-90" id="h54-0-90" class="i">+            if (params.onlyInsideConversation &amp;&amp; !isInConversation(conversationId)) return@forEach
</a><a href="#h54-0-91" id="h54-0-91" class="i">+            if (params.onlyOutsideConversation &amp;&amp; isInConversation(conversationId)) return@forEach
</a><a href="#h54-0-92" id="h54-0-92" class="i">+
</a><a href="#h54-0-93" id="h54-0-93" class="i">+            context.log.verbose(&quot;dispatching $action for $eventType in $conversationName&quot;)
</a><a href="#h54-0-94" id="h54-0-94" class="i">+
</a><a href="#h54-0-95" id="h54-0-95" class="i">+            when (action) {
</a><a href="#h54-0-96" id="h54-0-96" class="i">+                TrackerRuleAction.PUSH_NOTIFICATION -&gt; {
</a><a href="#h54-0-97" id="h54-0-97" class="i">+                    if (params.noPushNotificationWhenAppActive &amp;&amp; !context.isMainActivityPaused) return@forEach
</a><a href="#h54-0-98" id="h54-0-98" class="i">+                    sendInfoNotification(text = &quot;$authorName $eventType in $conversationName&quot;)
</a><a href="#h54-0-99" id="h54-0-99" class="i">+                }
</a><a href="#h54-0-100" id="h54-0-100" class="i">+                TrackerRuleAction.IN_APP_NOTIFICATION -&gt; context.inAppOverlay.showStatusToast(
</a><a href="#h54-0-101" id="h54-0-101" class="i">+                    icon = Icons.Default.Info,
</a><a href="#h54-0-102" id="h54-0-102" class="i">+                    text = &quot;$authorName $eventType in $conversationName&quot;
</a><a href="#h54-0-103" id="h54-0-103" class="i">+                )
</a><a href="#h54-0-104" id="h54-0-104" class="i">+                TrackerRuleAction.LOG -&gt; context.bridgeClient.getMessageLogger().logTrackerEvent(
</a><a href="#h54-0-105" id="h54-0-105" class="i">+                    conversationId,
</a><a href="#h54-0-106" id="h54-0-106" class="i">+                    conversationName,
</a><a href="#h54-0-107" id="h54-0-107" class="i">+                    context.database.getConversationType(conversationId) == 1,
</a><a href="#h54-0-108" id="h54-0-108" class="i">+                    authorName,
</a><a href="#h54-0-109" id="h54-0-109" class="i">+                    userId,
</a><a href="#h54-0-110" id="h54-0-110" class="i">+                    eventType.key,
</a><a href="#h54-0-111" id="h54-0-111" class="i">+                    extras
</a><a href="#h54-0-112" id="h54-0-112" class="i">+                )
</a><a href="#h54-0-113" id="h54-0-113" class="i">+                else -&gt; {}
</a><a href="#h54-0-114" id="h54-0-114" class="i">+            }
</a><a href="#h54-0-115" id="h54-0-115" class="i">+        }
</a><a href="#h54-0-116" id="h54-0-116" class="i">+    }
</a><a href="#h54-0-117" id="h54-0-117" class="i">+
</a><a href="#h54-0-118" id="h54-0-118" class="i">+    private fun onConversationPresenceUpdate(conversationId: String, userId: String, oldState: FriendPresenceState?, currentState: FriendPresenceState?) {
</a><a href="#h54-0-119" id="h54-0-119" class="i">+        context.log.verbose(&quot;presence state for $userId in conversation $conversationId\n$currentState&quot;)
</a><a href="#h54-0-120" id="h54-0-120" class="i">+
</a><a href="#h54-0-121" id="h54-0-121" class="i">+        val eventType = when {
</a><a href="#h54-0-122" id="h54-0-122" class="i">+            (oldState == null || currentState?.bitmojiPresent == false) &amp;&amp; currentState?.bitmojiPresent == true -&gt; TrackerEventType.CONVERSATION_ENTER
</a><a href="#h54-0-123" id="h54-0-123" class="i">+            (currentState == null || oldState?.bitmojiPresent == false) &amp;&amp; oldState?.bitmojiPresent == true -&gt; TrackerEventType.CONVERSATION_EXIT
</a><a href="#h54-0-124" id="h54-0-124" class="i">+            oldState?.typing == false &amp;&amp; currentState?.typing == true -&gt; if (currentState.speaking) TrackerEventType.STARTED_SPEAKING else TrackerEventType.STARTED_TYPING
</a><a href="#h54-0-125" id="h54-0-125" class="i">+            oldState?.typing == true &amp;&amp; (currentState == null || !currentState.typing) -&gt; if (oldState.speaking) TrackerEventType.STOPPED_SPEAKING else TrackerEventType.STOPPED_TYPING
</a><a href="#h54-0-126" id="h54-0-126" class="i">+            (oldState == null || !oldState.peeking) &amp;&amp; currentState?.peeking == true -&gt; TrackerEventType.STARTED_PEEKING
</a><a href="#h54-0-127" id="h54-0-127" class="i">+            oldState?.peeking == true &amp;&amp; (currentState == null || !currentState.peeking) -&gt; TrackerEventType.STOPPED_PEEKING
</a><a href="#h54-0-128" id="h54-0-128" class="i">+            else -&gt; null
</a><a href="#h54-0-129" id="h54-0-129" class="i">+        } ?: return
</a><a href="#h54-0-130" id="h54-0-130" class="i">+
</a><a href="#h54-0-131" id="h54-0-131" class="i">+        dispatchEvents(eventType, conversationId, userId)
</a><a href="#h54-0-132" id="h54-0-132" class="i">+    }
</a><a href="#h54-0-133" id="h54-0-133" class="i">+
</a><a href="#h54-0-134" id="h54-0-134" class="i">+    private fun onConversationMessagingEvent(event: SessionEvent) {
</a><a href="#h54-0-135" id="h54-0-135" class="i">+        context.log.verbose(&quot;conversation messaging event\n${event.type} in ${event.conversationId} from ${event.authorUserId}&quot;)
</a><a href="#h54-0-136" id="h54-0-136" class="i">+
</a><a href="#h54-0-137" id="h54-0-137" class="i">+        val eventType = when(event.type) {
</a><a href="#h54-0-138" id="h54-0-138" class="i">+            SessionEventType.MESSAGE_READ_RECEIPTS -&gt; TrackerEventType.MESSAGE_READ
</a><a href="#h54-0-139" id="h54-0-139" class="i">+            SessionEventType.MESSAGE_DELETED -&gt; TrackerEventType.MESSAGE_DELETED
</a><a href="#h54-0-140" id="h54-0-140" class="i">+            SessionEventType.MESSAGE_REACTION_ADD -&gt; TrackerEventType.MESSAGE_REACTION_ADD
</a><a href="#h54-0-141" id="h54-0-141" class="i">+            SessionEventType.MESSAGE_REACTION_REMOVE -&gt; TrackerEventType.MESSAGE_REACTION_REMOVE
</a><a href="#h54-0-142" id="h54-0-142" class="i">+            SessionEventType.MESSAGE_SAVED -&gt; TrackerEventType.MESSAGE_SAVED
</a><a href="#h54-0-143" id="h54-0-143" class="i">+            SessionEventType.MESSAGE_UNSAVED -&gt; TrackerEventType.MESSAGE_UNSAVED
</a><a href="#h54-0-144" id="h54-0-144" class="i">+            SessionEventType.MESSAGE_EDITED -&gt; TrackerEventType.MESSAGE_EDITED
</a><a href="#h54-0-145" id="h54-0-145" class="i">+            SessionEventType.SNAP_OPENED -&gt; TrackerEventType.SNAP_OPENED
</a><a href="#h54-0-146" id="h54-0-146" class="i">+            SessionEventType.SNAP_REPLAYED -&gt; TrackerEventType.SNAP_REPLAYED
</a><a href="#h54-0-147" id="h54-0-147" class="i">+            SessionEventType.SNAP_REPLAYED_TWICE -&gt; TrackerEventType.SNAP_REPLAYED_TWICE
</a><a href="#h54-0-148" id="h54-0-148" class="i">+            SessionEventType.SNAP_SCREENSHOT -&gt; TrackerEventType.SNAP_SCREENSHOT
</a><a href="#h54-0-149" id="h54-0-149" class="i">+            SessionEventType.SNAP_SCREEN_RECORD -&gt; TrackerEventType.SNAP_SCREEN_RECORD
</a><a href="#h54-0-150" id="h54-0-150" class="i">+            else -&gt; return
</a><a href="#h54-0-151" id="h54-0-151" class="i">+        }
</a><a href="#h54-0-152" id="h54-0-152" class="i">+
</a><a href="#h54-0-153" id="h54-0-153" class="i">+        val conversationMessage by lazy {
</a><a href="#h54-0-154" id="h54-0-154" class="i">+            (event as? SessionMessageEvent)?.serverMessageId?.let { context.database.getConversationServerMessage(event.conversationId, it) }
</a><a href="#h54-0-155" id="h54-0-155" class="i">+        }
</a><a href="#h54-0-156" id="h54-0-156" class="i">+
</a><a href="#h54-0-157" id="h54-0-157" class="i">+        dispatchEvents(eventType, event.conversationId, event.authorUserId, extras = conversationMessage?.takeIf {
</a><a href="#h54-0-158" id="h54-0-158" class="i">+            eventType == TrackerEventType.MESSAGE_READ ||
</a><a href="#h54-0-159" id="h54-0-159" class="i">+            eventType == TrackerEventType.MESSAGE_REACTION_ADD ||
</a><a href="#h54-0-160" id="h54-0-160" class="i">+            eventType == TrackerEventType.MESSAGE_REACTION_REMOVE ||
</a><a href="#h54-0-161" id="h54-0-161" class="i">+            eventType == TrackerEventType.MESSAGE_DELETED ||
</a><a href="#h54-0-162" id="h54-0-162" class="i">+            eventType == TrackerEventType.MESSAGE_SAVED ||
</a><a href="#h54-0-163" id="h54-0-163" class="i">+            eventType == TrackerEventType.MESSAGE_UNSAVED ||
</a><a href="#h54-0-164" id="h54-0-164" class="i">+            eventType == TrackerEventType.MESSAGE_EDITED
</a><a href="#h54-0-165" id="h54-0-165" class="i">+        }?.contentType?.let { ContentType.fromId(it).name } ?: &quot;&quot;)
</a><a href="#h54-0-166" id="h54-0-166" class="i">+    }
</a><a href="#h54-0-167" id="h54-0-167" class="i">+
</a><a href="#h54-0-168" id="h54-0-168" class="i">+    private fun handlePresenceEvent(protoReader: ProtoReader) {
</a><a href="#h54-0-169" id="h54-0-169" class="i">+        val conversationId = protoReader.getString(6) ?: return
</a><a href="#h54-0-170" id="h54-0-170" class="i">+
</a><a href="#h54-0-171" id="h54-0-171" class="i">+        val presenceMap = conversationPresenceState.getOrPut(conversationId) { mutableMapOf() }.toMutableMap()
</a><a href="#h54-0-172" id="h54-0-172" class="i">+        val userIds = mutableSetOf&lt;String&gt;()
</a><a href="#h54-0-173" id="h54-0-173" class="i">+
</a><a href="#h54-0-174" id="h54-0-174" class="i">+        protoReader.eachBuffer(4) {
</a><a href="#h54-0-175" id="h54-0-175" class="i">+            val participantUserId = getString(1)?.takeIf { it.contains(&quot;:&quot;) }?.substringBefore(&quot;:&quot;) ?: return@eachBuffer
</a><a href="#h54-0-176" id="h54-0-176" class="i">+            userIds.add(participantUserId)
</a><a href="#h54-0-177" id="h54-0-177" class="i">+            if (participantUserId == context.database.myUserId) return@eachBuffer
</a><a href="#h54-0-178" id="h54-0-178" class="i">+            val stateMap = getVarInt(2, 1)?.toString(2)?.padStart(16, &#39;0&#39;)?.reversed()?.map { it == &#39;1&#39; } ?: return@eachBuffer
</a><a href="#h54-0-179" id="h54-0-179" class="i">+
</a><a href="#h54-0-180" id="h54-0-180" class="i">+            presenceMap[participantUserId] = FriendPresenceState(
</a><a href="#h54-0-181" id="h54-0-181" class="i">+                bitmojiPresent = stateMap[0],
</a><a href="#h54-0-182" id="h54-0-182" class="i">+                typing = stateMap[4],
</a><a href="#h54-0-183" id="h54-0-183" class="i">+                wasTyping = stateMap[5],
</a><a href="#h54-0-184" id="h54-0-184" class="i">+                speaking = stateMap[6] &amp;&amp; stateMap[4],
</a><a href="#h54-0-185" id="h54-0-185" class="i">+                peeking = stateMap[8]
</a><a href="#h54-0-186" id="h54-0-186" class="i">+            )
</a><a href="#h54-0-187" id="h54-0-187" class="i">+        }
</a><a href="#h54-0-188" id="h54-0-188" class="i">+
</a><a href="#h54-0-189" id="h54-0-189" class="i">+        presenceMap.keys.filterNot { it in userIds }.forEach { presenceMap[it] = null }
</a><a href="#h54-0-190" id="h54-0-190" class="i">+
</a><a href="#h54-0-191" id="h54-0-191" class="i">+        presenceMap.forEach { (userId, state) -&gt;
</a><a href="#h54-0-192" id="h54-0-192" class="i">+            val oldState = conversationPresenceState[conversationId]?.get(userId)
</a><a href="#h54-0-193" id="h54-0-193" class="i">+            if (oldState != state) {
</a><a href="#h54-0-194" id="h54-0-194" class="i">+                onConversationPresenceUpdate(conversationId, userId, oldState, state)
</a><a href="#h54-0-195" id="h54-0-195" class="i">+            }
</a><a href="#h54-0-196" id="h54-0-196" class="i">+        }
</a><a href="#h54-0-197" id="h54-0-197" class="i">+
</a><a href="#h54-0-198" id="h54-0-198" class="i">+        conversationPresenceState[conversationId] = presenceMap
</a><a href="#h54-0-199" id="h54-0-199" class="i">+    }
</a><a href="#h54-0-200" id="h54-0-200" class="i">+
</a><a href="#h54-0-201" id="h54-0-201" class="i">+    private fun handleMessagingEvent(protoReader: ProtoReader) {
</a><a href="#h54-0-202" id="h54-0-202" class="i">+        // read receipts
</a><a href="#h54-0-203" id="h54-0-203" class="i">+        protoReader.followPath(12) {
</a><a href="#h54-0-204" id="h54-0-204" class="i">+            val conversationId = getByteArray(1, 1)?.toSnapUUID()?.toString() ?: return@followPath
</a><a href="#h54-0-205" id="h54-0-205" class="i">+
</a><a href="#h54-0-206" id="h54-0-206" class="i">+            followPath(7) readReceipts@{
</a><a href="#h54-0-207" id="h54-0-207" class="i">+                val senderId = getByteArray(1, 1)?.toSnapUUID()?.toString() ?: return@readReceipts
</a><a href="#h54-0-208" id="h54-0-208" class="i">+                val serverMessageId = getVarInt(2, 2) ?: return@readReceipts
</a><a href="#h54-0-209" id="h54-0-209" class="i">+
</a><a href="#h54-0-210" id="h54-0-210" class="i">+                onConversationMessagingEvent(
</a><a href="#h54-0-211" id="h54-0-211" class="i">+                    SessionMessageEvent(
</a><a href="#h54-0-212" id="h54-0-212" class="i">+                        SessionEventType.MESSAGE_READ_RECEIPTS,
</a><a href="#h54-0-213" id="h54-0-213" class="i">+                        conversationId,
</a><a href="#h54-0-214" id="h54-0-214" class="i">+                        senderId,
</a><a href="#h54-0-215" id="h54-0-215" class="i">+                        serverMessageId,
</a><a href="#h54-0-216" id="h54-0-216" class="i">+                    )
</a><a href="#h54-0-217" id="h54-0-217" class="i">+                )
</a><a href="#h54-0-218" id="h54-0-218" class="i">+            }
</a><a href="#h54-0-219" id="h54-0-219" class="i">+        }
</a><a href="#h54-0-220" id="h54-0-220" class="i">+
</a><a href="#h54-0-221" id="h54-0-221" class="i">+        protoReader.followPath(13, 1, 4) {
</a><a href="#h54-0-222" id="h54-0-222" class="i">+            val serverMessageId = getVarInt(1) ?: return@followPath
</a><a href="#h54-0-223" id="h54-0-223" class="i">+            val senderId = getByteArray(2, 1) ?: return@followPath
</a><a href="#h54-0-224" id="h54-0-224" class="i">+            val conversationId = getByteArray(3, 1, 1, 1) ?: return@followPath
</a><a href="#h54-0-225" id="h54-0-225" class="i">+
</a><a href="#h54-0-226" id="h54-0-226" class="i">+            onConversationMessagingEvent(
</a><a href="#h54-0-227" id="h54-0-227" class="i">+                SessionMessageEvent(
</a><a href="#h54-0-228" id="h54-0-228" class="i">+                    SessionEventType.MESSAGE_EDITED,
</a><a href="#h54-0-229" id="h54-0-229" class="i">+                    SnapUUID(conversationId).toString(),
</a><a href="#h54-0-230" id="h54-0-230" class="i">+                    SnapUUID(senderId).toString(),
</a><a href="#h54-0-231" id="h54-0-231" class="i">+                    serverMessageId
</a><a href="#h54-0-232" id="h54-0-232" class="i">+                )
</a><a href="#h54-0-233" id="h54-0-233" class="i">+            )
</a><a href="#h54-0-234" id="h54-0-234" class="i">+        }
</a><a href="#h54-0-235" id="h54-0-235" class="i">+
</a><a href="#h54-0-236" id="h54-0-236" class="i">+        protoReader.followPath(6, 2) {
</a><a href="#h54-0-237" id="h54-0-237" class="i">+            val conversationId = getByteArray(3, 1)?.toSnapUUID()?.toString() ?: return@followPath
</a><a href="#h54-0-238" id="h54-0-238" class="i">+            val senderId = getByteArray(1, 1)?.toSnapUUID()?.toString() ?: return@followPath
</a><a href="#h54-0-239" id="h54-0-239" class="i">+            val serverMessageId = getVarInt(2) ?: return@followPath
</a><a href="#h54-0-240" id="h54-0-240" class="i">+
</a><a href="#h54-0-241" id="h54-0-241" class="i">+            if (contains(4)) {
</a><a href="#h54-0-242" id="h54-0-242" class="i">+                onConversationMessagingEvent(
</a><a href="#h54-0-243" id="h54-0-243" class="i">+                    SessionMessageEvent(
</a><a href="#h54-0-244" id="h54-0-244" class="i">+                        SessionEventType.SNAP_OPENED,
</a><a href="#h54-0-245" id="h54-0-245" class="i">+                        conversationId,
</a><a href="#h54-0-246" id="h54-0-246" class="i">+                        senderId,
</a><a href="#h54-0-247" id="h54-0-247" class="i">+                        serverMessageId
</a><a href="#h54-0-248" id="h54-0-248" class="i">+                    )
</a><a href="#h54-0-249" id="h54-0-249" class="i">+                )
</a><a href="#h54-0-250" id="h54-0-250" class="i">+            }
</a><a href="#h54-0-251" id="h54-0-251" class="i">+
</a><a href="#h54-0-252" id="h54-0-252" class="i">+            if (contains(13)) {
</a><a href="#h54-0-253" id="h54-0-253" class="i">+                onConversationMessagingEvent(
</a><a href="#h54-0-254" id="h54-0-254" class="i">+                    SessionMessageEvent(
</a><a href="#h54-0-255" id="h54-0-255" class="i">+                        if (getVarInt(13, 1) == 2L) SessionEventType.SNAP_REPLAYED_TWICE else SessionEventType.SNAP_REPLAYED,
</a><a href="#h54-0-256" id="h54-0-256" class="i">+                        conversationId,
</a><a href="#h54-0-257" id="h54-0-257" class="i">+                        senderId,
</a><a href="#h54-0-258" id="h54-0-258" class="i">+                        serverMessageId
</a><a href="#h54-0-259" id="h54-0-259" class="i">+                    )
</a><a href="#h54-0-260" id="h54-0-260" class="i">+                )
</a><a href="#h54-0-261" id="h54-0-261" class="i">+            }
</a><a href="#h54-0-262" id="h54-0-262" class="i">+
</a><a href="#h54-0-263" id="h54-0-263" class="i">+            if (contains(6) || contains(7)) {
</a><a href="#h54-0-264" id="h54-0-264" class="i">+                onConversationMessagingEvent(
</a><a href="#h54-0-265" id="h54-0-265" class="i">+                    SessionMessageEvent(
</a><a href="#h54-0-266" id="h54-0-266" class="i">+                        if (contains(6)) SessionEventType.MESSAGE_SAVED else SessionEventType.MESSAGE_UNSAVED,
</a><a href="#h54-0-267" id="h54-0-267" class="i">+                        conversationId,
</a><a href="#h54-0-268" id="h54-0-268" class="i">+                        senderId,
</a><a href="#h54-0-269" id="h54-0-269" class="i">+                        serverMessageId
</a><a href="#h54-0-270" id="h54-0-270" class="i">+                    )
</a><a href="#h54-0-271" id="h54-0-271" class="i">+                )
</a><a href="#h54-0-272" id="h54-0-272" class="i">+            }
</a><a href="#h54-0-273" id="h54-0-273" class="i">+
</a><a href="#h54-0-274" id="h54-0-274" class="i">+            if (contains(11) || contains(12)) {
</a><a href="#h54-0-275" id="h54-0-275" class="i">+                onConversationMessagingEvent(
</a><a href="#h54-0-276" id="h54-0-276" class="i">+                    SessionMessageEvent(
</a><a href="#h54-0-277" id="h54-0-277" class="i">+                        if (contains(11)) SessionEventType.SNAP_SCREENSHOT else SessionEventType.SNAP_SCREEN_RECORD,
</a><a href="#h54-0-278" id="h54-0-278" class="i">+                        conversationId,
</a><a href="#h54-0-279" id="h54-0-279" class="i">+                        senderId,
</a><a href="#h54-0-280" id="h54-0-280" class="i">+                        serverMessageId,
</a><a href="#h54-0-281" id="h54-0-281" class="i">+                    )
</a><a href="#h54-0-282" id="h54-0-282" class="i">+                )
</a><a href="#h54-0-283" id="h54-0-283" class="i">+            }
</a><a href="#h54-0-284" id="h54-0-284" class="i">+
</a><a href="#h54-0-285" id="h54-0-285" class="i">+            followPath(16) {
</a><a href="#h54-0-286" id="h54-0-286" class="i">+                onConversationMessagingEvent(
</a><a href="#h54-0-287" id="h54-0-287" class="i">+                    SessionMessageEvent(
</a><a href="#h54-0-288" id="h54-0-288" class="i">+                        SessionEventType.MESSAGE_REACTION_ADD, conversationId, senderId, serverMessageId, reactionId = getVarInt(1, 1, 1)?.toInt() ?: -1
</a><a href="#h54-0-289" id="h54-0-289" class="i">+                    )
</a><a href="#h54-0-290" id="h54-0-290" class="i">+                )
</a><a href="#h54-0-291" id="h54-0-291" class="i">+            }
</a><a href="#h54-0-292" id="h54-0-292" class="i">+
</a><a href="#h54-0-293" id="h54-0-293" class="i">+            if (contains(17)) {
</a><a href="#h54-0-294" id="h54-0-294" class="i">+                onConversationMessagingEvent(
</a><a href="#h54-0-295" id="h54-0-295" class="i">+                    SessionMessageEvent(SessionEventType.MESSAGE_REACTION_REMOVE, conversationId, senderId, serverMessageId)
</a><a href="#h54-0-296" id="h54-0-296" class="i">+                )
</a><a href="#h54-0-297" id="h54-0-297" class="i">+            }
</a><a href="#h54-0-298" id="h54-0-298" class="i">+
</a><a href="#h54-0-299" id="h54-0-299" class="i">+            followPath(8) {
</a><a href="#h54-0-300" id="h54-0-300" class="i">+                onConversationMessagingEvent(
</a><a href="#h54-0-301" id="h54-0-301" class="i">+                    SessionMessageEvent(SessionEventType.MESSAGE_DELETED, conversationId, senderId, serverMessageId, messageData = getByteArray(1))
</a><a href="#h54-0-302" id="h54-0-302" class="i">+                )
</a><a href="#h54-0-303" id="h54-0-303" class="i">+            }
</a><a href="#h54-0-304" id="h54-0-304" class="i">+        }
</a><a href="#h54-0-305" id="h54-0-305" class="i">+    }
</a><a href="#h54-0-306" id="h54-0-306" class="i">+
</a><a href="#h54-0-307" id="h54-0-307" class="i">+    override fun init() {
</a><a href="#h54-0-308" id="h54-0-308" class="i">+        val sessionEventsConfig = context.config.friendTracker
</a><a href="#h54-0-309" id="h54-0-309" class="i">+        if (sessionEventsConfig.globalState != true) return
</a><a href="#h54-0-310" id="h54-0-310" class="i">+
</a><a href="#h54-0-311" id="h54-0-311" class="i">+        if (sessionEventsConfig.allowRunningInBackground.get()) {
</a><a href="#h54-0-312" id="h54-0-312" class="i">+            findClass(&quot;com.snapchat.client.duplex.DuplexClient\$CppProxy&quot;).apply {
</a><a href="#h54-0-313" id="h54-0-313" class="i">+                // prevent disabling events when the app is inactive
</a><a href="#h54-0-314" id="h54-0-314" class="i">+                hook(&quot;appStateChanged&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h54-0-315" id="h54-0-315" class="i">+                    if (param.arg&lt;Any&gt;(0).toString() == &quot;INACTIVE&quot;) param.setResult(null)
</a><a href="#h54-0-316" id="h54-0-316" class="i">+                }
</a><a href="#h54-0-317" id="h54-0-317" class="i">+                // allow events when a notification is received
</a><a href="#h54-0-318" id="h54-0-318" class="i">+                hookConstructor(HookStage.AFTER) { param -&gt;
</a><a href="#h54-0-319" id="h54-0-319" class="i">+                    methods.first { it.name == &quot;appStateChanged&quot; }.let { method -&gt;
</a><a href="#h54-0-320" id="h54-0-320" class="i">+                        method.invoke(param.thisObject(), method.parameterTypes[0].enumConstants.first { it.toString() == &quot;ACTIVE&quot; })
</a><a href="#h54-0-321" id="h54-0-321" class="i">+                    }
</a><a href="#h54-0-322" id="h54-0-322" class="i">+                }
</a><a href="#h54-0-323" id="h54-0-323" class="i">+            }
</a><a href="#h54-0-324" id="h54-0-324" class="i">+        }
</a><a href="#h54-0-325" id="h54-0-325" class="i">+
</a><a href="#h54-0-326" id="h54-0-326" class="i">+        if (sessionEventsConfig.recordMessagingEvents.get()) {
</a><a href="#h54-0-327" id="h54-0-327" class="i">+            val messageHandlerClass = findClass(&quot;com.snapchat.client.duplex.MessageHandler\$CppProxy&quot;).apply {
</a><a href="#h54-0-328" id="h54-0-328" class="i">+                hook(&quot;onReceive&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h54-0-329" id="h54-0-329" class="i">+                    param.setResult(null)
</a><a href="#h54-0-330" id="h54-0-330" class="i">+
</a><a href="#h54-0-331" id="h54-0-331" class="i">+                    val byteBuffer = param.arg&lt;ByteBuffer&gt;(0)
</a><a href="#h54-0-332" id="h54-0-332" class="i">+                    val content = byteBuffer.let {
</a><a href="#h54-0-333" id="h54-0-333" class="i">+                        val bytes = ByteArray(it.limit())
</a><a href="#h54-0-334" id="h54-0-334" class="i">+                        it.get(bytes)
</a><a href="#h54-0-335" id="h54-0-335" class="i">+                        bytes
</a><a href="#h54-0-336" id="h54-0-336" class="i">+                    }
</a><a href="#h54-0-337" id="h54-0-337" class="i">+                    val reader = ProtoReader(content)
</a><a href="#h54-0-338" id="h54-0-338" class="i">+                    reader.getString(1, 1)?.let {
</a><a href="#h54-0-339" id="h54-0-339" class="i">+                        val eventData = reader.followPath(1, 2) ?: return@let
</a><a href="#h54-0-340" id="h54-0-340" class="i">+                        if (it == &quot;volatile&quot;) {
</a><a href="#h54-0-341" id="h54-0-341" class="i">+                            handleVolatileEvent(eventData)
</a><a href="#h54-0-342" id="h54-0-342" class="i">+                            return@hook
</a><a href="#h54-0-343" id="h54-0-343" class="i">+                        }
</a><a href="#h54-0-344" id="h54-0-344" class="i">+
</a><a href="#h54-0-345" id="h54-0-345" class="i">+                        if (it == &quot;presence&quot;) {
</a><a href="#h54-0-346" id="h54-0-346" class="i">+                            handlePresenceEvent(eventData)
</a><a href="#h54-0-347" id="h54-0-347" class="i">+                            return@hook
</a><a href="#h54-0-348" id="h54-0-348" class="i">+                        }
</a><a href="#h54-0-349" id="h54-0-349" class="i">+                    }
</a><a href="#h54-0-350" id="h54-0-350" class="i">+                    handleMessagingEvent(reader)
</a><a href="#h54-0-351" id="h54-0-351" class="i">+                }
</a><a href="#h54-0-352" id="h54-0-352" class="i">+                hook(&quot;nativeDestroy&quot;, HookStage.BEFORE) { it.setResult(null) }
</a><a href="#h54-0-353" id="h54-0-353" class="i">+            }
</a><a href="#h54-0-354" id="h54-0-354" class="i">+
</a><a href="#h54-0-355" id="h54-0-355" class="i">+
</a><a href="#h54-0-356" id="h54-0-356" class="i">+            findClass(&quot;com.snapchat.client.messaging.Session&quot;).hook(&quot;create&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h54-0-357" id="h54-0-357" class="i">+                if (!NativeLib.initialized) {
</a><a href="#h54-0-358" id="h54-0-358" class="i">+                    context.log.warn(&quot;Can&#39;t register duplex message handler, native lib not initialized&quot;)
</a><a href="#h54-0-359" id="h54-0-359" class="i">+                    return@hook
</a><a href="#h54-0-360" id="h54-0-360" class="i">+                }
</a><a href="#h54-0-361" id="h54-0-361" class="i">+
</a><a href="#h54-0-362" id="h54-0-362" class="i">+                val method = param.method() as Method
</a><a href="#h54-0-363" id="h54-0-363" class="i">+                val duplexClient = method.parameterTypes.indexOfFirst { it.name.endsWith(&quot;DuplexClient&quot;) }.let {
</a><a href="#h54-0-364" id="h54-0-364" class="i">+                    param.arg&lt;Any&gt;(it)
</a><a href="#h54-0-365" id="h54-0-365" class="i">+                }
</a><a href="#h54-0-366" id="h54-0-366" class="i">+                val dispatchQueue = method.parameterTypes.indexOfFirst { it.name.endsWith(&quot;DispatchQueue&quot;) }.let {
</a><a href="#h54-0-367" id="h54-0-367" class="i">+                    param.arg&lt;Any&gt;(it)
</a><a href="#h54-0-368" id="h54-0-368" class="i">+                }
</a><a href="#h54-0-369" id="h54-0-369" class="i">+                for (channel in arrayOf(&quot;pcs&quot;, &quot;mcs&quot;)) {
</a><a href="#h54-0-370" id="h54-0-370" class="i">+                    duplexClient::class.java.methods.first {
</a><a href="#h54-0-371" id="h54-0-371" class="i">+                        it.name == &quot;registerHandler&quot;
</a><a href="#h54-0-372" id="h54-0-372" class="i">+                    }.invoke(
</a><a href="#h54-0-373" id="h54-0-373" class="i">+                        duplexClient,
</a><a href="#h54-0-374" id="h54-0-374" class="i">+                        channel,
</a><a href="#h54-0-375" id="h54-0-375" class="i">+                        messageHandlerClass.declaredConstructors.first().also { it.isAccessible = true }.newInstance(-1),
</a><a href="#h54-0-376" id="h54-0-376" class="i">+                        dispatchQueue
</a><a href="#h54-0-377" id="h54-0-377" class="i">+                    )
</a><a href="#h54-0-378" id="h54-0-378" class="i">+                }
</a><a href="#h54-0-379" id="h54-0-379" class="i">+            }
</a><a href="#h54-0-380" id="h54-0-380" class="i">+        }
</a><a href="#h54-0-381" id="h54-0-381" class="i">+    }
</a><a href="#h54-0-382" id="h54-0-382" class="i">+}</a><a href="#h54-0-383" id="h54-0-383" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h55" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/spying/MessageLogger.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/spying/MessageLogger.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/spying/MessageLogger.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/spying/MessageLogger.kt</a></b>
<a href="#h55-0" id="h55-0" class="h">@@ -119,8 +119,10 @@ class MessageLogger : Feature(&quot;MessageLogger&quot;,
</a> 
             if (!isMessageDeleted) {
                 if (messageFilter.isNotEmpty() &amp;&amp; !messageFilter.contains(messageContentType?.name)) return@subscribe
<a href="#h55-0-3" id="h55-0-3" class="d">-                if (fetchedMessages.contains(uniqueMessageIdentifier)) return@subscribe
</a><a href="#h55-0-4" id="h55-0-4" class="d">-                fetchedMessages.add(uniqueMessageIdentifier)
</a><a href="#h55-0-5" id="h55-0-5" class="i">+                if (event.message.messageMetadata?.isEdited != true) {
</a><a href="#h55-0-6" id="h55-0-6" class="i">+                    if (fetchedMessages.contains(uniqueMessageIdentifier)) return@subscribe
</a><a href="#h55-0-7" id="h55-0-7" class="i">+                    fetchedMessages.add(uniqueMessageIdentifier)
</a><a href="#h55-0-8" id="h55-0-8" class="i">+                }
</a> 
                 threadPool.execute {
                     try {
<b>diff --git a/<a id="h56" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/wrapper/AbstractWrapper.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/wrapper/AbstractWrapper.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/wrapper/AbstractWrapper.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/wrapper/AbstractWrapper.kt</a></b>
<a href="#h56-0" id="h56-0" class="h">@@ -19,12 +19,10 @@ abstract class AbstractWrapper(
</a>     inner class FieldAccessor&lt;T&gt;(private val fieldName: String, private val mapper: ((Any?) -&gt; T?)? = null) {
         @Suppress(&quot;UNCHECKED_CAST&quot;)
         operator fun getValue(obj: Any, property: KProperty&lt;*&gt;): T? {
<a href="#h56-0-3" id="h56-0-3" class="d">-            val value = runCatching { XposedHelpers.getObjectField(instance, fieldName) }.getOrNull()
</a><a href="#h56-0-4" id="h56-0-4" class="d">-            return if (mapper != null) {
</a><a href="#h56-0-5" id="h56-0-5" class="d">-                mapper.invoke(value)
</a><a href="#h56-0-6" id="h56-0-6" class="d">-            } else {
</a><a href="#h56-0-7" id="h56-0-7" class="d">-                value as? T
</a><a href="#h56-0-8" id="h56-0-8" class="d">-            }
</a><a href="#h56-0-9" id="h56-0-9" class="i">+            return runCatching {
</a><a href="#h56-0-10" id="h56-0-10" class="i">+                val value = XposedHelpers.getObjectField(instance, fieldName)
</a><a href="#h56-0-11" id="h56-0-11" class="i">+                mapper?.invoke(value) ?: value as? T
</a><a href="#h56-0-12" id="h56-0-12" class="i">+            }.getOrNull()
</a>         }
 
         operator fun setValue(obj: Any, property: KProperty&lt;*&gt;, value: Any?) {
<b>diff --git a/<a id="h57" href="../file/mapper/src/main/kotlin/me/rhunk/snapenhance/mapper/impl/BCryptClassMapper.kt.html">mapper/src/main/kotlin/me/rhunk/snapenhance/mapper/impl/BCryptClassMapper.kt</a> b/<a href="../file/mapper/src/main/kotlin/me/rhunk/snapenhance/mapper/impl/BCryptClassMapper.kt.html">mapper/src/main/kotlin/me/rhunk/snapenhance/mapper/impl/BCryptClassMapper.kt</a></b>
<a href="#h57-0" id="h57-0" class="h">@@ -1,10 +1,10 @@
</a> package me.rhunk.snapenhance.mapper.impl
 
<a href="#h57-0-2" id="h57-0-2" class="i">+import com.android.tools.smali.dexlib2.iface.instruction.formats.ArrayPayload
</a> import me.rhunk.snapenhance.mapper.AbstractClassMapper
 import me.rhunk.snapenhance.mapper.ext.getClassName
 import me.rhunk.snapenhance.mapper.ext.getStaticConstructor
 import me.rhunk.snapenhance.mapper.ext.isFinal
<a href="#h57-0-7" id="h57-0-7" class="d">-import com.android.tools.smali.dexlib2.iface.instruction.formats.ArrayPayload
</a> 
 class BCryptClassMapper : AbstractClassMapper(&quot;BCryptClass&quot;) {
     val classReference = classReference(&quot;class&quot;)
<b>diff --git a/<a id="h58" href="../file/mapper/src/main/kotlin/me/rhunk/snapenhance/mapper/impl/CompositeConfigurationProviderMapper.kt.html">mapper/src/main/kotlin/me/rhunk/snapenhance/mapper/impl/CompositeConfigurationProviderMapper.kt</a> b/<a href="../file/mapper/src/main/kotlin/me/rhunk/snapenhance/mapper/impl/CompositeConfigurationProviderMapper.kt.html">mapper/src/main/kotlin/me/rhunk/snapenhance/mapper/impl/CompositeConfigurationProviderMapper.kt</a></b>
<a href="#h58-0" id="h58-0" class="h">@@ -1,14 +1,14 @@
</a> package me.rhunk.snapenhance.mapper.impl
 
<a href="#h58-0-2" id="h58-0-2" class="i">+import com.android.tools.smali.dexlib2.iface.instruction.formats.Instruction21c
</a><a href="#h58-0-3" id="h58-0-3" class="i">+import com.android.tools.smali.dexlib2.iface.instruction.formats.Instruction35c
</a><a href="#h58-0-4" id="h58-0-4" class="i">+import com.android.tools.smali.dexlib2.iface.reference.FieldReference
</a><a href="#h58-0-5" id="h58-0-5" class="i">+import com.android.tools.smali.dexlib2.iface.reference.MethodReference
</a> import me.rhunk.snapenhance.mapper.AbstractClassMapper
 import me.rhunk.snapenhance.mapper.ext.findConstString
 import me.rhunk.snapenhance.mapper.ext.getClassName
 import me.rhunk.snapenhance.mapper.ext.hasStaticConstructorString
 import me.rhunk.snapenhance.mapper.ext.isEnum
<a href="#h58-0-11" id="h58-0-11" class="d">-import com.android.tools.smali.dexlib2.iface.instruction.formats.Instruction21c
</a><a href="#h58-0-12" id="h58-0-12" class="d">-import com.android.tools.smali.dexlib2.iface.instruction.formats.Instruction35c
</a><a href="#h58-0-13" id="h58-0-13" class="d">-import com.android.tools.smali.dexlib2.iface.reference.FieldReference
</a><a href="#h58-0-14" id="h58-0-14" class="d">-import com.android.tools.smali.dexlib2.iface.reference.MethodReference
</a> import java.lang.reflect.Modifier
 
 class CompositeConfigurationProviderMapper : AbstractClassMapper(&quot;CompositeConfigurationProvider&quot;) {
<b>diff --git a/<a id="h59" href="../file/mapper/src/main/kotlin/me/rhunk/snapenhance/mapper/impl/MediaQualityLevelProviderMapper.kt.html">mapper/src/main/kotlin/me/rhunk/snapenhance/mapper/impl/MediaQualityLevelProviderMapper.kt</a> b/<a href="../file/mapper/src/main/kotlin/me/rhunk/snapenhance/mapper/impl/MediaQualityLevelProviderMapper.kt.html">mapper/src/main/kotlin/me/rhunk/snapenhance/mapper/impl/MediaQualityLevelProviderMapper.kt</a></b>
<a href="#h59-0" id="h59-0" class="h">@@ -1,11 +1,11 @@
</a> package me.rhunk.snapenhance.mapper.impl
 
<a href="#h59-0-2" id="h59-0-2" class="i">+import com.android.tools.smali.dexlib2.AccessFlags
</a> import me.rhunk.snapenhance.mapper.AbstractClassMapper
 import me.rhunk.snapenhance.mapper.ext.getClassName
 import me.rhunk.snapenhance.mapper.ext.hasStaticConstructorString
 import me.rhunk.snapenhance.mapper.ext.isAbstract
 import me.rhunk.snapenhance.mapper.ext.isEnum
<a href="#h59-0-8" id="h59-0-8" class="d">-import com.android.tools.smali.dexlib2.AccessFlags
</a> 
 class MediaQualityLevelProviderMapper : AbstractClassMapper(&quot;MediaQualityLevelProvider&quot;) {
     val mediaQualityLevelProvider = classReference(&quot;mediaQualityLevelProvider&quot;)
<b>diff --git a/<a id="h60" href="../file/mapper/src/main/kotlin/me/rhunk/snapenhance/mapper/impl/OperaViewerParamsMapper.kt.html">mapper/src/main/kotlin/me/rhunk/snapenhance/mapper/impl/OperaViewerParamsMapper.kt</a> b/<a href="../file/mapper/src/main/kotlin/me/rhunk/snapenhance/mapper/impl/OperaViewerParamsMapper.kt.html">mapper/src/main/kotlin/me/rhunk/snapenhance/mapper/impl/OperaViewerParamsMapper.kt</a></b>
<a href="#h60-0" id="h60-0" class="h">@@ -1,11 +1,11 @@
</a> package me.rhunk.snapenhance.mapper.impl
 
 import com.android.tools.smali.dexlib2.iface.Method
<a href="#h60-0-3" id="h60-0-3" class="i">+import com.android.tools.smali.dexlib2.iface.instruction.formats.Instruction35c
</a><a href="#h60-0-4" id="h60-0-4" class="i">+import com.android.tools.smali.dexlib2.iface.reference.MethodReference
</a> import me.rhunk.snapenhance.mapper.AbstractClassMapper
 import me.rhunk.snapenhance.mapper.ext.findConstString
 import me.rhunk.snapenhance.mapper.ext.getClassName
<a href="#h60-0-8" id="h60-0-8" class="d">-import com.android.tools.smali.dexlib2.iface.instruction.formats.Instruction35c
</a><a href="#h60-0-9" id="h60-0-9" class="d">-import com.android.tools.smali.dexlib2.iface.reference.MethodReference
</a> 
 class OperaViewerParamsMapper : AbstractClassMapper(&quot;OperaViewerParams&quot;) {
     val classReference = classReference(&quot;class&quot;)
</pre>
</div>
</body>
</html>
