<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>refactor: feature load system - SnapEnhance - An Xposed module offering an enhanced Snapchat experience
</title>
<link rel="icon" type="image/svg+xml" href="../../logo.png"/>
<link rel="alternate icon" href="../../favicon.png"/>
<link rel="alternate" type="application/atom+xml" title="SnapEnhance Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="SnapEnhance Atom Feed (tags)" href="../tags.xml" />
<link rel="stylesheet" type="text/css" href="../../style.css" />
<link rel="stylesheet" type="text/css" href="../../fonts.css" />
</head>
<body>
<div id="head"><table><tr><td><a class="logo" href="../../"><img src="../../logo.png" alt="" width="32" height="32" /></a></td><td><strong>SnapEnhance</strong><span class="desc"> - An Xposed module offering an enhanced Snapchat experience
</span>
</td></tr></table>
<p><a href="../about.html">About</a> | <a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/LICENSE.html">License</a></p>
</div>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/d31591fd4753f9611b98e1bd1b68d8b908736f47.html">d31591fd4753f9611b98e1bd1b68d8b908736f47</a>
<b>parent</b> <a href="../commit/bf49bcbe11bb2bbbcb445ce6447e1cf16e663b7d.html">bf49bcbe11bb2bbbcb445ce6447e1cf16e663b7d</a>
<b>Author:</b> rhunk &lt;<a href="mailto:101876869+rhunk@users.noreply.github.com">101876869+rhunk@users.noreply.github.com</a>&gt;
<b>Date:</b>   Sun, 30 Jun 2024 23:58:28 +0200

refactor: feature load system

Signed-off-by: rhunk &lt;101876869+rhunk@users.noreply.github.com&gt;

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">core/src/main/kotlin/me/rhunk/snapenhance/core/ModContext.kt</a></td><td> | </td><td class="num">4</td><td><span class="i">++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">core/src/main/kotlin/me/rhunk/snapenhance/core/SnapEnhance.kt</a></td><td> | </td><td class="num">10</td><td><span class="i">+++++</span><span class="d">-----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h2">core/src/main/kotlin/me/rhunk/snapenhance/core/features/BridgeFileFeature.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h3">core/src/main/kotlin/me/rhunk/snapenhance/core/features/Feature.kt</a></td><td> | </td><td class="num">46</td><td><span class="i">++++++++++++++++++++++++++</span><span class="d">--------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h4">core/src/main/kotlin/me/rhunk/snapenhance/core/features/FeatureManager.kt</a></td><td> | </td><td class="num">79</td><td><span class="i">++++++++++++++++++++++++++</span><span class="d">-----------------------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h5">core/src/main/kotlin/me/rhunk/snapenhance/core/features/MessagingRuleFeature.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h6">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/COFOverride.kt</a></td><td> | </td><td class="num">4</td><td><span class="i">++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h7">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ConfigurationOverride.kt</a></td><td> | </td><td class="num">4</td><td><span class="i">++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h8">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/FriendMutationObserver.kt</a></td><td> | </td><td class="num">4</td><td><span class="i">++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h9">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/MixerStories.kt</a></td><td> | </td><td class="num">4</td><td><span class="i">++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h10">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/OperaViewerParamsOverride.kt</a></td><td> | </td><td class="num">57</td><td><span class="i">+++++++++++++++++++++++++++++</span><span class="d">----------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h11">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ScopeSync.kt</a></td><td> | </td><td class="num">3</td><td><span class="i">+</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h12">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/downloader/MediaDownloader.kt</a></td><td> | </td><td class="num">76</td><td><span class="i">++++++++++++++++++++++++++++++++++++++</span><span class="d">--------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h13">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/downloader/ProfilePictureDownloader.kt</a></td><td> | </td><td class="num">83</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++</span><span class="d">---------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h14">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/AccountSwitcher.kt</a></td><td> | </td><td class="num">29</td><td><span class="i">+++++++++++++</span><span class="d">----------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h15">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/AddFriendSourceSpoof.kt</a></td><td> | </td><td class="num">95</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++</span><span class="d">---------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h16">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/AppLock.kt</a></td><td> | </td><td class="num">45</td><td><span class="i">+++++++++++++++++++++++</span><span class="d">----------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h17">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/AutoOpenSnaps.kt</a></td><td> | </td><td class="num">3</td><td><span class="i">+</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h18">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/BestFriendPinning.kt</a></td><td> | </td><td class="num">3</td><td><span class="i">+</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h19">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/BetterLocation.kt</a></td><td> | </td><td class="num">3</td><td><span class="i">+</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h20">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/BetterTranscript.kt</a></td><td> | </td><td class="num">98</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++</span><span class="d">---------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h21">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/CallRecorder.kt</a></td><td> | </td><td class="num">3</td><td><span class="i">+</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h22">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/ComposerHooks.kt</a></td><td> | </td><td class="num">3</td><td><span class="i">+</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h23">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/ContextMenuFix.kt</a></td><td> | </td><td class="num">3</td><td><span class="i">+</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h24">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/ConvertMessageLocally.kt</a></td><td> | </td><td class="num">15</td><td><span class="i">++++++++</span><span class="d">-------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h25">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/DeviceSpooferHook.kt</a></td><td> | </td><td class="num">3</td><td><span class="i">+</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h26">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/EndToEndEncryption.kt</a></td><td> | </td><td class="num">401</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++</span><span class="d">----------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h27">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/InfiniteStoryBoost.kt</a></td><td> | </td><td class="num">21</td><td><span class="i">+++++++++++</span><span class="d">----------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h28">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/MediaFilePicker.kt</a></td><td> | </td><td class="num">321</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++</span><span class="d">---------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h29">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/MeoPasscodeBypass.kt</a></td><td> | </td><td class="num">21</td><td><span class="i">+++++++++++</span><span class="d">----------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h30">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/NoFriendScoreDelay.kt</a></td><td> | </td><td class="num">21</td><td><span class="i">+++++++++++</span><span class="d">----------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h31">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/PreventForcedLogout.kt</a></td><td> | </td><td class="num">3</td><td><span class="i">+</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h32">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/BypassVideoLengthRestriction.kt</a></td><td> | </td><td class="num">89</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++</span><span class="d">---------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h33">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/DisableCustomTabs.kt</a></td><td> | </td><td class="num">15</td><td><span class="i">++++++++</span><span class="d">-------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h34">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/DisableMemoriesSnapFeed.kt</a></td><td> | </td><td class="num">22</td><td><span class="i">+++++++++++</span><span class="d">-----------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h35">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/DisableMetrics.kt</a></td><td> | </td><td class="num">3</td><td><span class="i">+</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h36">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/DisableTelecomFramework.kt</a></td><td> | </td><td class="num">3</td><td><span class="i">+</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h37">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/GooglePlayServicesDialogs.kt</a></td><td> | </td><td class="num">19</td><td><span class="i">++++++++++</span><span class="d">---------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h38">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/MediaUploadQualityOverride.kt</a></td><td> | </td><td class="num">3</td><td><span class="i">+</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h39">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/SnapchatPlus.kt</a></td><td> | </td><td class="num">3</td><td><span class="i">+</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h40">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/AutoMarkAsRead.kt</a></td><td> | </td><td class="num">3</td><td><span class="i">+</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h41">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/AutoSave.kt</a></td><td> | </td><td class="num">57</td><td><span class="i">+++++++++++++++++++++++++++++</span><span class="d">----------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h42">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/BypassMessageActionRestrictions.kt</a></td><td> | </td><td class="num">15</td><td><span class="i">++++++++</span><span class="d">-------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h43">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/CallStartConfirmation.kt</a></td><td> | </td><td class="num">53</td><td><span class="i">+++++++++++++++++++++++++++</span><span class="d">--------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h44">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/DisableReplayInFF.kt</a></td><td> | </td><td class="num">19</td><td><span class="i">++++++++++</span><span class="d">---------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h45">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/Messaging.kt</a></td><td> | </td><td class="num">154</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++</span><span class="d">----------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h46">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/Notifications.kt</a></td><td> | </td><td class="num">5</td><td><span class="i">++</span><span class="d">---</span></td></tr>
<tr><td class="M">M</td><td><a href="#h47">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/PreventMessageSending.kt</a></td><td> | </td><td class="num">5</td><td><span class="i">++</span><span class="d">---</span></td></tr>
<tr><td class="M">M</td><td><a href="#h48">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/SendOverride.kt</a></td><td> | </td><td class="num">3</td><td><span class="i">+</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h49">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/UnlimitedSnapViewTime.kt</a></td><td> | </td><td class="num">34</td><td><span class="i">+++++++++++++++++</span><span class="d">-----------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h50">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/spying/FriendTracker.kt</a></td><td> | </td><td class="num">3</td><td><span class="i">+</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h51">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/spying/HalfSwipeNotifier.kt</a></td><td> | </td><td class="num">3</td><td><span class="i">+</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h52">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/spying/MessageLogger.kt</a></td><td> | </td><td class="num">32</td><td><span class="i">++++++++++</span><span class="d">----------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h53">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/spying/StealthMode.kt</a></td><td> | </td><td class="num">3</td><td><span class="i">+</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h54">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/tweaks/BypassScreenshotDetection.kt</a></td><td> | </td><td class="num">5</td><td><span class="i">++</span><span class="d">---</span></td></tr>
<tr><td class="M">M</td><td><a href="#h55">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/tweaks/CameraTweaks.kt</a></td><td> | </td><td class="num">133</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++</span><span class="d">---------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h56">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/tweaks/DisablePermissionRequests.kt</a></td><td> | </td><td class="num">3</td><td><span class="i">+</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h57">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/tweaks/HideActiveMusic.kt</a></td><td> | </td><td class="num">11</td><td><span class="i">++++++</span><span class="d">-----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h58">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/tweaks/PreventMessageListAutoScroll.kt</a></td><td> | </td><td class="num">89</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++</span><span class="d">---------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h59">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/tweaks/RemoveGroupsLockedStatus.kt</a></td><td> | </td><td class="num">13</td><td><span class="i">+++++++</span><span class="d">------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h60">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/tweaks/UnsaveableMessages.kt</a></td><td> | </td><td class="num">4</td><td><span class="i">+</span><span class="d">---</span></td></tr>
<tr><td class="M">M</td><td><a href="#h61">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/ClientBootstrapOverride.kt</a></td><td> | </td><td class="num">3</td><td><span class="i">+</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h62">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/ConversationToolbox.kt</a></td><td> | </td><td class="num">77</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++</span><span class="d">--------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h63">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/CustomStreaksExpirationFormat.kt</a></td><td> | </td><td class="num">61</td><td><span class="i">+++++++++++++++++++++++++++++++</span><span class="d">------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h64">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/CustomizeUI.kt</a></td><td> | </td><td class="num">5</td><td><span class="i">++</span><span class="d">---</span></td></tr>
<tr><td class="M">M</td><td><a href="#h65">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/DefaultVolumeControls.kt</a></td><td> | </td><td class="num">15</td><td><span class="i">++++++++</span><span class="d">-------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h66">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/DisableConfirmationDialogs.kt</a></td><td> | </td><td class="num">83</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++</span><span class="d">---------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h67">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/EditTextOverride.kt</a></td><td> | </td><td class="num">33</td><td><span class="i">+++++++++++++++++</span><span class="d">----------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h68">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/FriendFeedMessagePreview.kt</a></td><td> | </td><td class="num">132</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++</span><span class="d">---------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h69">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/HideFriendFeedEntry.kt</a></td><td> | </td><td class="num">4</td><td><span class="i">++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h70">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/HideQuickAddFriendFeed.kt</a></td><td> | </td><td class="num">19</td><td><span class="i">++++++++++</span><span class="d">---------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h71">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/HideStreakRestore.kt</a></td><td> | </td><td class="num">3</td><td><span class="i">+</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h72">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/MessageIndicators.kt</a></td><td> | </td><td class="num">187</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++</span><span class="d">---------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h73">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/OldBitmojiSelfie.kt</a></td><td> | </td><td class="num">3</td><td><span class="i">+</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h74">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/PinConversations.kt</a></td><td> | </td><td class="num">5</td><td><span class="i">++</span><span class="d">---</span></td></tr>
<tr><td class="M">M</td><td><a href="#h75">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/SnapPreview.kt</a></td><td> | </td><td class="num">69</td><td><span class="i">+++++++++++++++++++++++++++++++++</span><span class="d">------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h76">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/SpotlightCommentsUsername.kt</a></td><td> | </td><td class="num">53</td><td><span class="i">+++++++++++++++++++++++++++</span><span class="d">--------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h77">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/StealthModeIndicator.kt</a></td><td> | </td><td class="num">74</td><td><span class="i">++++++++++++++++++++++++++++++++++++++</span><span class="d">------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h78">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/UITweaks.kt</a></td><td> | </td><td class="num">11</td><td><span class="i">++++++++</span><span class="d">---</span></td></tr>
<tr><td class="M">M</td><td><a href="#h79">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/ViewAppearanceHelper.kt</a></td><td> | </td><td class="num">5</td><td><span class="i">+++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h80">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/MenuViewInjector.kt</a></td><td> | </td><td class="num">187</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++</span><span class="d">---------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h81">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/FriendFeedInfoMenu.kt</a></td><td> | </td><td class="num">5</td><td><span class="i">+++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h82">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/OperaContextActionMenu.kt</a></td><td> | </td><td class="num">3</td><td><span class="i">++</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h83">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/SettingsGearInjector.kt</a></td><td> | </td><td class="num">5</td><td><span class="i">+++</span><span class="d">--</span></td></tr>
</table></pre><pre>84 files changed, 1642 insertions(+), 1673 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/ModContext.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/ModContext.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/ModContext.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/ModContext.kt</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -79,7 +79,7 @@ class ModContext(
</a>     }
 
     fun runOnUiThread(runnable: () -&gt; Unit) {
<a href="#h0-0-3" id="h0-0-3" class="d">-        if (Looper.myLooper() == Looper.getMainLooper()) {
</a><a href="#h0-0-4" id="h0-0-4" class="i">+        if (Looper.getMainLooper().isCurrentThread) {
</a>             runnable()
             return
         }
<a href="#h0-1" id="h0-1" class="h">@@ -95,7 +95,7 @@ class ModContext(
</a>             runCatching {
                 runnable()
             }.onFailure {
<a href="#h0-1-3" id="h0-1-3" class="d">-                longToast(&quot;Async task failed &quot; + it.message)
</a><a href="#h0-1-4" id="h0-1-4" class="i">+                longToast(&quot;Async task failed: &quot; + it.message)
</a>                 log.error(&quot;Async task failed&quot;, it)
             }
         }
<b>diff --git a/<a id="h1" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/SnapEnhance.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/SnapEnhance.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/SnapEnhance.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/SnapEnhance.kt</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -106,7 +106,7 @@ class SnapEnhance {
</a>                     appContext.mainActivity = this
                     if (!appContext.mappings.isMappingsLoaded) return@hookMainActivity
                     appContext.isMainActivityPaused = false
<a href="#h1-0-3" id="h1-0-3" class="d">-                    onActivityCreate()
</a><a href="#h1-0-4" id="h1-0-4" class="i">+                    onActivityCreate(this)
</a>                     appContext.actionManager.onNewIntent(intent)
                 }
 
<a href="#h1-1" id="h1-1" class="h">@@ -166,12 +166,12 @@ class SnapEnhance {
</a>         }
     }
 
<a href="#h1-1-3" id="h1-1-3" class="d">-    private fun onActivityCreate() {
</a><a href="#h1-1-4" id="h1-1-4" class="i">+    private fun onActivityCreate(activity: Activity) {
</a>         measureTimeMillis {
             with(appContext) {
<a href="#h1-1-7" id="h1-1-7" class="d">-                features.onActivityCreate()
</a><a href="#h1-1-8" id="h1-1-8" class="d">-                inAppOverlay.onActivityCreate(mainActivity!!)
</a><a href="#h1-1-9" id="h1-1-9" class="d">-                scriptRuntime.eachModule { callFunction(&quot;module.onSnapMainActivityCreate&quot;, mainActivity!!) }
</a><a href="#h1-1-10" id="h1-1-10" class="i">+                features.onActivityCreate(activity)
</a><a href="#h1-1-11" id="h1-1-11" class="i">+                inAppOverlay.onActivityCreate(activity)
</a><a href="#h1-1-12" id="h1-1-12" class="i">+                scriptRuntime.eachModule { callFunction(&quot;module.onSnapMainActivityCreate&quot;, activity) }
</a>                 actionManager.onActivityCreate()
             }
         }.also { time -&gt;
<b>diff --git a/<a id="h2" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/BridgeFileFeature.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/BridgeFileFeature.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/BridgeFileFeature.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/BridgeFileFeature.kt</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -9,7 +9,7 @@ import java.io.BufferedReader
</a> import java.io.InputStreamReader
 import java.nio.charset.StandardCharsets
 
<a href="#h2-0-3" id="h2-0-3" class="d">-abstract class BridgeFileFeature(name: String, private val bridgeFileType: InternalFileHandleType, loadParams: Int) : Feature(name, loadParams) {
</a><a href="#h2-0-4" id="h2-0-4" class="i">+abstract class BridgeFileFeature(name: String, private val bridgeFileType: InternalFileHandleType) : Feature(name) {
</a>     private val fileLines = mutableListOf&lt;String&gt;()
     private val fileWrapper by mappedLazyBridge(LazyBridgeValue({ context.fileHandlerManager.getFileHandle(FileHandleScope.INTERNAL.key, bridgeFileType.key)!! }), map = { it.toWrapper() })
 
<b>diff --git a/<a id="h3" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/Feature.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/Feature.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/Feature.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/Feature.kt</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -1,33 +1,39 @@
</a> package me.rhunk.snapenhance.core.features
 
<a href="#h3-0-2" id="h3-0-2" class="i">+import android.app.Activity
</a><a href="#h3-0-3" id="h3-0-3" class="i">+import kotlinx.coroutines.launch
</a> import me.rhunk.snapenhance.core.ModContext
 
 abstract class Feature(
<a href="#h3-0-7" id="h3-0-7" class="d">-    val featureKey: String,
</a><a href="#h3-0-8" id="h3-0-8" class="d">-    val loadParams: Int = FeatureLoadParams.INIT_SYNC
</a><a href="#h3-0-9" id="h3-0-9" class="i">+    val key: String
</a> ) {
     lateinit var context: ModContext
<a href="#h3-0-12" id="h3-0-12" class="i">+    lateinit var registerNextActivityCallback: ((Activity) -&gt; Unit) -&gt; Unit
</a><a href="#h3-0-13" id="h3-0-13" class="i">+
</a><a href="#h3-0-14" id="h3-0-14" class="i">+    protected fun defer(block: () -&gt; Unit) {
</a><a href="#h3-0-15" id="h3-0-15" class="i">+        context.coroutineScope.launch {
</a><a href="#h3-0-16" id="h3-0-16" class="i">+            runCatching {
</a><a href="#h3-0-17" id="h3-0-17" class="i">+                block()
</a><a href="#h3-0-18" id="h3-0-18" class="i">+            }.onFailure {
</a><a href="#h3-0-19" id="h3-0-19" class="i">+                context.log.error(&quot;Failed to run onNextActivityCreate callback&quot;, it)
</a><a href="#h3-0-20" id="h3-0-20" class="i">+            }
</a><a href="#h3-0-21" id="h3-0-21" class="i">+        }
</a><a href="#h3-0-22" id="h3-0-22" class="i">+    }
</a> 
<a href="#h3-0-24" id="h3-0-24" class="d">-    /**
</a><a href="#h3-0-25" id="h3-0-25" class="d">-     * called on the main thread when the mod initialize
</a><a href="#h3-0-26" id="h3-0-26" class="d">-     */
</a><a href="#h3-0-27" id="h3-0-27" class="d">-    open fun init() {}
</a><a href="#h3-0-28" id="h3-0-28" class="d">-
</a><a href="#h3-0-29" id="h3-0-29" class="d">-    /**
</a><a href="#h3-0-30" id="h3-0-30" class="d">-     * called on a dedicated thread when the mod initialize
</a><a href="#h3-0-31" id="h3-0-31" class="d">-     */
</a><a href="#h3-0-32" id="h3-0-32" class="d">-    open fun asyncInit() {}
</a><a href="#h3-0-33" id="h3-0-33" class="d">-
</a><a href="#h3-0-34" id="h3-0-34" class="d">-    /**
</a><a href="#h3-0-35" id="h3-0-35" class="d">-     * called when the Snapchat Activity is created
</a><a href="#h3-0-36" id="h3-0-36" class="d">-     */
</a><a href="#h3-0-37" id="h3-0-37" class="d">-    open fun onActivityCreate() {}
</a><a href="#h3-0-38" id="h3-0-38" class="i">+    protected fun onNextActivityCreate(defer: Boolean = false, block: (Activity) -&gt; Unit) {
</a><a href="#h3-0-39" id="h3-0-39" class="i">+        if (defer) {
</a><a href="#h3-0-40" id="h3-0-40" class="i">+            registerNextActivityCallback {
</a><a href="#h3-0-41" id="h3-0-41" class="i">+                defer {
</a><a href="#h3-0-42" id="h3-0-42" class="i">+                    block(it)
</a><a href="#h3-0-43" id="h3-0-43" class="i">+                }
</a><a href="#h3-0-44" id="h3-0-44" class="i">+            }
</a><a href="#h3-0-45" id="h3-0-45" class="i">+            return
</a><a href="#h3-0-46" id="h3-0-46" class="i">+        }
</a><a href="#h3-0-47" id="h3-0-47" class="i">+        registerNextActivityCallback(block)
</a><a href="#h3-0-48" id="h3-0-48" class="i">+    }
</a> 
<a href="#h3-0-50" id="h3-0-50" class="i">+    open fun init() {}
</a> 
<a href="#h3-0-52" id="h3-0-52" class="d">-    /**
</a><a href="#h3-0-53" id="h3-0-53" class="d">-     * called on a dedicated thread when the Snapchat Activity is created
</a><a href="#h3-0-54" id="h3-0-54" class="d">-     */
</a><a href="#h3-0-55" id="h3-0-55" class="d">-    open fun asyncOnActivityCreate() {}
</a> 
     protected fun findClass(name: String): Class&lt;*&gt; {
         return context.androidContext.classLoader.loadClass(name)
<b>diff --git a/<a id="h4" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/FeatureManager.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/FeatureManager.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/FeatureManager.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/FeatureManager.kt</a></b>
<a href="#h4-0" id="h4-0" class="h">@@ -1,5 +1,6 @@
</a> package me.rhunk.snapenhance.core.features
 
<a href="#h4-0-2" id="h4-0-2" class="i">+import android.app.Activity
</a> import kotlinx.coroutines.Dispatchers
 import kotlinx.coroutines.launch
 import kotlinx.coroutines.runBlocking
<a href="#h4-1" id="h4-1" class="h">@@ -25,6 +26,7 @@ class FeatureManager(
</a>     private val context: ModContext
 ) {
     private val features = mutableMapOf&lt;KClass&lt;out Feature&gt;, Feature&gt;()
<a href="#h4-1-3" id="h4-1-3" class="i">+    private val onActivityCreateListeners = mutableListOf&lt;(Activity) -&gt; Unit&gt;()
</a> 
     private fun register(vararg featureList: Feature) {
         if (context.bridgeClient.getDebugProp(&quot;disable_feature_loading&quot;) == &quot;true&quot;) {
<a href="#h4-2" id="h4-2" class="h">@@ -37,11 +39,12 @@ class FeatureManager(
</a>                 launch(Dispatchers.IO) {
                     runCatching {
                         feature.context = context
<a href="#h4-2-3" id="h4-2-3" class="i">+                        feature.registerNextActivityCallback = { block -&gt; onActivityCreateListeners.add(block) }
</a>                         synchronized(features) {
                             features[feature::class] = feature
                         }
                     }.onFailure {
<a href="#h4-2-8" id="h4-2-8" class="d">-                        CoreLogger.xposedLog(&quot;Failed to register feature ${feature.featureKey}&quot;, it)
</a><a href="#h4-2-9" id="h4-2-9" class="i">+                        CoreLogger.xposedLog(&quot;Failed to register feature ${feature.key}&quot;, it)
</a>                     }
                 }
             }
<a href="#h4-3" id="h4-3" class="h">@@ -132,65 +135,35 @@ class FeatureManager(
</a>             DisableTelecomFramework(),
             BetterTranscript(),
         )
<a href="#h4-3-3" id="h4-3-3" class="d">-        initializeFeatures()
</a><a href="#h4-3-4" id="h4-3-4" class="d">-    }
</a><a href="#h4-3-5" id="h4-3-5" class="d">-
</a><a href="#h4-3-6" id="h4-3-6" class="d">-    private inline fun tryInit(feature: Feature, crossinline block: () -&gt; Unit) {
</a><a href="#h4-3-7" id="h4-3-7" class="d">-        runCatching {
</a><a href="#h4-3-8" id="h4-3-8" class="d">-            block()
</a><a href="#h4-3-9" id="h4-3-9" class="d">-        }.onFailure {
</a><a href="#h4-3-10" id="h4-3-10" class="d">-            context.log.error(&quot;Failed to init feature ${feature.featureKey}&quot;, it)
</a><a href="#h4-3-11" id="h4-3-11" class="d">-            context.longToast(&quot;Failed to init feature ${feature.featureKey}! Check logcat for more details.&quot;)
</a><a href="#h4-3-12" id="h4-3-12" class="d">-        }
</a><a href="#h4-3-13" id="h4-3-13" class="d">-    }
</a><a href="#h4-3-14" id="h4-3-14" class="d">-
</a><a href="#h4-3-15" id="h4-3-15" class="d">-    private fun initFeatures(
</a><a href="#h4-3-16" id="h4-3-16" class="d">-        syncParam: Int,
</a><a href="#h4-3-17" id="h4-3-17" class="d">-        asyncParam: Int,
</a><a href="#h4-3-18" id="h4-3-18" class="d">-        syncAction: (Feature) -&gt; Unit,
</a><a href="#h4-3-19" id="h4-3-19" class="d">-        asyncAction: (Feature) -&gt; Unit
</a><a href="#h4-3-20" id="h4-3-20" class="d">-    ) {
</a> 
         features.values.toList().forEach { feature -&gt;
<a href="#h4-3-23" id="h4-3-23" class="d">-            if (feature.loadParams and syncParam != 0) {
</a><a href="#h4-3-24" id="h4-3-24" class="d">-                tryInit(feature) {
</a><a href="#h4-3-25" id="h4-3-25" class="d">-                    syncAction(feature)
</a><a href="#h4-3-26" id="h4-3-26" class="i">+            runCatching {
</a><a href="#h4-3-27" id="h4-3-27" class="i">+                measureTimeMillis {
</a><a href="#h4-3-28" id="h4-3-28" class="i">+                    feature.init()
</a><a href="#h4-3-29" id="h4-3-29" class="i">+                }.also {
</a><a href="#h4-3-30" id="h4-3-30" class="i">+                    context.log.verbose(&quot;Feature ${feature.key} initialized in $it ms&quot;)
</a>                 }
<a href="#h4-3-32" id="h4-3-32" class="i">+            }.onFailure {
</a><a href="#h4-3-33" id="h4-3-33" class="i">+                context.log.error(&quot;Failed to init feature ${feature.key}&quot;, it)
</a><a href="#h4-3-34" id="h4-3-34" class="i">+                context.longToast(&quot;Failed to init feature ${feature.key}! Check logcat for more details.&quot;)
</a>             }
<a href="#h4-3-36" id="h4-3-36" class="d">-            if (feature.loadParams and asyncParam != 0) {
</a><a href="#h4-3-37" id="h4-3-37" class="d">-                context.coroutineScope.launch {
</a><a href="#h4-3-38" id="h4-3-38" class="d">-                    tryInit(feature) {
</a><a href="#h4-3-39" id="h4-3-39" class="d">-                        asyncAction(feature)
</a><a href="#h4-3-40" id="h4-3-40" class="d">-                    }
</a><a href="#h4-3-41" id="h4-3-41" class="d">-                }
</a><a href="#h4-3-42" id="h4-3-42" class="d">-            }
</a><a href="#h4-3-43" id="h4-3-43" class="d">-        }
</a><a href="#h4-3-44" id="h4-3-44" class="d">-    }
</a><a href="#h4-3-45" id="h4-3-45" class="d">-
</a><a href="#h4-3-46" id="h4-3-46" class="d">-    private fun initializeFeatures() {
</a><a href="#h4-3-47" id="h4-3-47" class="d">-        //TODO: async called when all features are initiated ?
</a><a href="#h4-3-48" id="h4-3-48" class="d">-        measureTimeMillis {
</a><a href="#h4-3-49" id="h4-3-49" class="d">-            initFeatures(
</a><a href="#h4-3-50" id="h4-3-50" class="d">-                FeatureLoadParams.INIT_SYNC,
</a><a href="#h4-3-51" id="h4-3-51" class="d">-                FeatureLoadParams.INIT_ASYNC,
</a><a href="#h4-3-52" id="h4-3-52" class="d">-                Feature::init,
</a><a href="#h4-3-53" id="h4-3-53" class="d">-                Feature::asyncInit
</a><a href="#h4-3-54" id="h4-3-54" class="d">-            )
</a><a href="#h4-3-55" id="h4-3-55" class="d">-        }.also {
</a><a href="#h4-3-56" id="h4-3-56" class="d">-            context.log.verbose(&quot;feature manager init took $it ms&quot;)
</a>         }
     }
 
<a href="#h4-3-60" id="h4-3-60" class="d">-    fun onActivityCreate() {
</a><a href="#h4-3-61" id="h4-3-61" class="d">-        measureTimeMillis {
</a><a href="#h4-3-62" id="h4-3-62" class="d">-            initFeatures(
</a><a href="#h4-3-63" id="h4-3-63" class="d">-                FeatureLoadParams.ACTIVITY_CREATE_SYNC,
</a><a href="#h4-3-64" id="h4-3-64" class="d">-                FeatureLoadParams.ACTIVITY_CREATE_ASYNC,
</a><a href="#h4-3-65" id="h4-3-65" class="d">-                Feature::onActivityCreate,
</a><a href="#h4-3-66" id="h4-3-66" class="d">-                Feature::asyncOnActivityCreate
</a><a href="#h4-3-67" id="h4-3-67" class="d">-            )
</a><a href="#h4-3-68" id="h4-3-68" class="d">-        }.also {
</a><a href="#h4-3-69" id="h4-3-69" class="d">-            context.log.verbose(&quot;feature manager onActivityCreate took $it ms&quot;)
</a><a href="#h4-3-70" id="h4-3-70" class="i">+    fun onActivityCreate(activity: Activity) {
</a><a href="#h4-3-71" id="h4-3-71" class="i">+        context.log.verbose(&quot;Activity created: ${activity.javaClass.simpleName}&quot;)
</a><a href="#h4-3-72" id="h4-3-72" class="i">+        onActivityCreateListeners.toList().also {
</a><a href="#h4-3-73" id="h4-3-73" class="i">+            onActivityCreateListeners.clear()
</a><a href="#h4-3-74" id="h4-3-74" class="i">+        }.forEach { activityListener -&gt;
</a><a href="#h4-3-75" id="h4-3-75" class="i">+            measureTimeMillis {
</a><a href="#h4-3-76" id="h4-3-76" class="i">+                runCatching {
</a><a href="#h4-3-77" id="h4-3-77" class="i">+                    activityListener(activity)
</a><a href="#h4-3-78" id="h4-3-78" class="i">+                }.onFailure {
</a><a href="#h4-3-79" id="h4-3-79" class="i">+                    context.log.error(&quot;Failed to run activity listener ${activityListener::class.simpleName}&quot;, it)
</a><a href="#h4-3-80" id="h4-3-80" class="i">+                }
</a><a href="#h4-3-81" id="h4-3-81" class="i">+            }.also {
</a><a href="#h4-3-82" id="h4-3-82" class="i">+                context.log.verbose(&quot;Activity listener ${activityListener::class.simpleName} executed in $it ms&quot;)
</a><a href="#h4-3-83" id="h4-3-83" class="i">+            }
</a>         }
     }
 }
<b>diff --git a/<a id="h5" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/MessagingRuleFeature.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/MessagingRuleFeature.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/MessagingRuleFeature.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/MessagingRuleFeature.kt</a></b>
<a href="#h5-0" id="h5-0" class="h">@@ -3,7 +3,7 @@ package me.rhunk.snapenhance.core.features
</a> import me.rhunk.snapenhance.common.data.MessagingRuleType
 import me.rhunk.snapenhance.common.data.RuleState
 
<a href="#h5-0-3" id="h5-0-3" class="d">-abstract class MessagingRuleFeature(name: String, val ruleType: MessagingRuleType, loadParams: Int = 0) : Feature(name, loadParams) {
</a><a href="#h5-0-4" id="h5-0-4" class="i">+abstract class MessagingRuleFeature(name: String, val ruleType: MessagingRuleType) : Feature(name) {
</a>     private val listeners = mutableListOf&lt;(String, Boolean) -&gt; Unit&gt;()
 
     fun addStateListener(listener: (conversationId: String, newState: Boolean) -&gt; Unit) {
<b>diff --git a/<a id="h6" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/COFOverride.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/COFOverride.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/COFOverride.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/COFOverride.kt</a></b>
<a href="#h6-0" id="h6-0" class="h">@@ -1,7 +1,7 @@
</a> package me.rhunk.snapenhance.core.features.impl
 
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h6-0-3" id="h6-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a><a href="#h6-0-4" id="h6-0-4" class="i">+
</a> import me.rhunk.snapenhance.core.util.dataBuilder
 import me.rhunk.snapenhance.core.util.hook.HookStage
 import me.rhunk.snapenhance.core.util.hook.hook
<a href="#h6-1" id="h6-1" class="h">@@ -9,7 +9,7 @@ import me.rhunk.snapenhance.core.util.ktx.getObjectField
</a> import me.rhunk.snapenhance.mapper.impl.COFObservableMapper
 import java.lang.reflect.Method
 
<a href="#h6-1-3" id="h6-1-3" class="d">-class COFOverride : Feature(&quot;COF Override&quot;, loadParams = FeatureLoadParams.INIT_SYNC) {
</a><a href="#h6-1-4" id="h6-1-4" class="i">+class COFOverride : Feature(&quot;COF Override&quot;) {
</a>     var hasActionMenuV2 = false
 
     override fun init() {
<b>diff --git a/<a id="h7" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ConfigurationOverride.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ConfigurationOverride.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ConfigurationOverride.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ConfigurationOverride.kt</a></b>
<a href="#h7-0" id="h7-0" class="h">@@ -2,7 +2,7 @@ package me.rhunk.snapenhance.core.features.impl
</a> 
 import de.robv.android.xposed.XposedHelpers
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h7-0-3" id="h7-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a><a href="#h7-0-4" id="h7-0-4" class="i">+
</a> import me.rhunk.snapenhance.core.util.hook.HookStage
 import me.rhunk.snapenhance.core.util.hook.Hooker
 import me.rhunk.snapenhance.core.util.hook.hook
<a href="#h7-1" id="h7-1" class="h">@@ -22,7 +22,7 @@ data class ConfigFilter(
</a>     val isAppExperiment: Boolean?
 )
 
<a href="#h7-1-3" id="h7-1-3" class="d">-class ConfigurationOverride : Feature(&quot;Configuration Override&quot;, loadParams = FeatureLoadParams.INIT_SYNC) {
</a><a href="#h7-1-4" id="h7-1-4" class="i">+class ConfigurationOverride : Feature(&quot;Configuration Override&quot;) {
</a>     override fun init() {
         context.mappings.useMapper(CompositeConfigurationProviderMapper::class) {
             fun getConfigKeyInfo(key: Any?) = runCatching {
<b>diff --git a/<a id="h8" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/FriendMutationObserver.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/FriendMutationObserver.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/FriendMutationObserver.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/FriendMutationObserver.kt</a></b>
<a href="#h8-0" id="h8-0" class="h">@@ -10,12 +10,12 @@ import me.rhunk.snapenhance.common.data.FriendLinkType
</a> import me.rhunk.snapenhance.common.database.impl.FriendInfo
 import me.rhunk.snapenhance.core.event.events.impl.NetworkApiRequestEvent
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h8-0-3" id="h8-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a><a href="#h8-0-4" id="h8-0-4" class="i">+
</a> import me.rhunk.snapenhance.core.util.EvictingMap
 import java.io.InputStreamReader
 import java.util.Calendar
 
<a href="#h8-0-9" id="h8-0-9" class="d">-class FriendMutationObserver: Feature(&quot;FriendMutationObserver&quot;, loadParams = FeatureLoadParams.INIT_SYNC) {
</a><a href="#h8-0-10" id="h8-0-10" class="i">+class FriendMutationObserver: Feature(&quot;FriendMutationObserver&quot;) {
</a>     private val translation by lazy { context.translation.getCategory(&quot;friend_mutation_observer&quot;) }
     private val addSourceCache = EvictingMap&lt;String, String&gt;(500)
 
<b>diff --git a/<a id="h9" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/MixerStories.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/MixerStories.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/MixerStories.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/MixerStories.kt</a></b>
<a href="#h9-0" id="h9-0" class="h">@@ -7,13 +7,13 @@ import me.rhunk.snapenhance.common.data.StoryData
</a> import me.rhunk.snapenhance.common.util.protobuf.ProtoEditor
 import me.rhunk.snapenhance.core.event.events.impl.NetworkApiRequestEvent
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h9-0-3" id="h9-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a><a href="#h9-0-4" id="h9-0-4" class="i">+
</a> import java.nio.ByteBuffer
 import kotlin.coroutines.suspendCoroutine
 import kotlin.io.encoding.Base64
 import kotlin.io.encoding.ExperimentalEncodingApi
 
<a href="#h9-0-10" id="h9-0-10" class="d">-class MixerStories : Feature(&quot;MixerStories&quot;, loadParams = FeatureLoadParams.INIT_SYNC) {
</a><a href="#h9-0-11" id="h9-0-11" class="i">+class MixerStories : Feature(&quot;MixerStories&quot;) {
</a>     @OptIn(ExperimentalEncodingApi::class)
     override fun init() {
         val disableDiscoverSections by context.config.global.disableStorySections
<b>diff --git a/<a id="h10" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/OperaViewerParamsOverride.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/OperaViewerParamsOverride.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/OperaViewerParamsOverride.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/OperaViewerParamsOverride.kt</a></b>
<a href="#h10-0" id="h10-0" class="h">@@ -1,12 +1,11 @@
</a> package me.rhunk.snapenhance.core.features.impl
 
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h10-0-3" id="h10-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.util.hook.HookStage
 import me.rhunk.snapenhance.core.util.hook.hook
 import me.rhunk.snapenhance.mapper.impl.OperaViewerParamsMapper
 
<a href="#h10-0-8" id="h10-0-8" class="d">-class OperaViewerParamsOverride : Feature(&quot;OperaViewerParamsOverride&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_SYNC) {
</a><a href="#h10-0-9" id="h10-0-9" class="i">+class OperaViewerParamsOverride : Feature(&quot;OperaViewerParamsOverride&quot;) {
</a>     var currentPlaybackRate = 1.0F
 
     data class OverrideKey(
<a href="#h10-1" id="h10-1" class="h">@@ -19,7 +18,7 @@ class OperaViewerParamsOverride : Feature(&quot;OperaViewerParamsOverride&quot;, loadParam
</a>         val value: (key: OverrideKey, value: Any?) -&gt; Any?
     )
 
<a href="#h10-1-3" id="h10-1-3" class="d">-    override fun onActivityCreate() {
</a><a href="#h10-1-4" id="h10-1-4" class="i">+    override fun init() {
</a>         val overrideMap = mutableMapOf&lt;String, Override&gt;()
 
         fun overrideParam(key: String, filter: (value: Any?) -&gt; Boolean, value: (overrideKey: OverrideKey, value: Any?) -&gt; Any?) {
<a href="#h10-2" id="h10-2" class="h">@@ -44,37 +43,39 @@ class OperaViewerParamsOverride : Feature(&quot;OperaViewerParamsOverride&quot;, loadParam
</a>             })
         }
 
<a href="#h10-2-3" id="h10-2-3" class="d">-        context.mappings.useMapper(OperaViewerParamsMapper::class) {
</a><a href="#h10-2-4" id="h10-2-4" class="d">-            fun overrideParamResult(paramKey: Any, value: Any?): Any? {
</a><a href="#h10-2-5" id="h10-2-5" class="d">-                val fields = paramKey::class.java.fields
</a><a href="#h10-2-6" id="h10-2-6" class="d">-                val key = OverrideKey(
</a><a href="#h10-2-7" id="h10-2-7" class="d">-                    name = fields.firstOrNull {
</a><a href="#h10-2-8" id="h10-2-8" class="d">-                        it.type == String::class.java
</a><a href="#h10-2-9" id="h10-2-9" class="d">-                    }?.get(paramKey)?.toString() ?: return value,
</a><a href="#h10-2-10" id="h10-2-10" class="d">-                    defaultValue = fields.firstOrNull {
</a><a href="#h10-2-11" id="h10-2-11" class="d">-                        it.type == Object::class.java
</a><a href="#h10-2-12" id="h10-2-12" class="d">-                    }?.get(paramKey)
</a><a href="#h10-2-13" id="h10-2-13" class="d">-                )
</a><a href="#h10-2-14" id="h10-2-14" class="i">+        onNextActivityCreate {
</a><a href="#h10-2-15" id="h10-2-15" class="i">+            context.mappings.useMapper(OperaViewerParamsMapper::class) {
</a><a href="#h10-2-16" id="h10-2-16" class="i">+                fun overrideParamResult(paramKey: Any, value: Any?): Any? {
</a><a href="#h10-2-17" id="h10-2-17" class="i">+                    val fields = paramKey::class.java.fields
</a><a href="#h10-2-18" id="h10-2-18" class="i">+                    val key = OverrideKey(
</a><a href="#h10-2-19" id="h10-2-19" class="i">+                        name = fields.firstOrNull {
</a><a href="#h10-2-20" id="h10-2-20" class="i">+                            it.type == String::class.java
</a><a href="#h10-2-21" id="h10-2-21" class="i">+                        }?.get(paramKey)?.toString() ?: return value,
</a><a href="#h10-2-22" id="h10-2-22" class="i">+                        defaultValue = fields.firstOrNull {
</a><a href="#h10-2-23" id="h10-2-23" class="i">+                            it.type == Object::class.java
</a><a href="#h10-2-24" id="h10-2-24" class="i">+                        }?.get(paramKey)
</a><a href="#h10-2-25" id="h10-2-25" class="i">+                    )
</a> 
<a href="#h10-2-27" id="h10-2-27" class="d">-                overrideMap[key.name]?.let { override -&gt;
</a><a href="#h10-2-28" id="h10-2-28" class="d">-                    if (override.filter(value)) {
</a><a href="#h10-2-29" id="h10-2-29" class="d">-                        runCatching {
</a><a href="#h10-2-30" id="h10-2-30" class="d">-                            return override.value(key, value)
</a><a href="#h10-2-31" id="h10-2-31" class="d">-                        }.onFailure {
</a><a href="#h10-2-32" id="h10-2-32" class="d">-                            context.log.error(&quot;Failed to override param $key&quot;, it)
</a><a href="#h10-2-33" id="h10-2-33" class="i">+                    overrideMap[key.name]?.let { override -&gt;
</a><a href="#h10-2-34" id="h10-2-34" class="i">+                        if (override.filter(value)) {
</a><a href="#h10-2-35" id="h10-2-35" class="i">+                            runCatching {
</a><a href="#h10-2-36" id="h10-2-36" class="i">+                                return override.value(key, value)
</a><a href="#h10-2-37" id="h10-2-37" class="i">+                            }.onFailure {
</a><a href="#h10-2-38" id="h10-2-38" class="i">+                                context.log.error(&quot;Failed to override param $key&quot;, it)
</a><a href="#h10-2-39" id="h10-2-39" class="i">+                            }
</a>                         }
                     }
<a href="#h10-2-42" id="h10-2-42" class="d">-                }
</a> 
<a href="#h10-2-44" id="h10-2-44" class="d">-                return value
</a><a href="#h10-2-45" id="h10-2-45" class="d">-            }
</a><a href="#h10-2-46" id="h10-2-46" class="i">+                    return value
</a><a href="#h10-2-47" id="h10-2-47" class="i">+                }
</a> 
<a href="#h10-2-49" id="h10-2-49" class="d">-            classReference.get()?.hook(getMethod.get()!!, HookStage.AFTER) { param -&gt;
</a><a href="#h10-2-50" id="h10-2-50" class="d">-                param.setResult(overrideParamResult(param.arg(0), param.getResult()))
</a><a href="#h10-2-51" id="h10-2-51" class="d">-            }
</a><a href="#h10-2-52" id="h10-2-52" class="i">+                classReference.get()?.hook(getMethod.get()!!, HookStage.AFTER) { param -&gt;
</a><a href="#h10-2-53" id="h10-2-53" class="i">+                    param.setResult(overrideParamResult(param.arg(0), param.getResult()))
</a><a href="#h10-2-54" id="h10-2-54" class="i">+                }
</a> 
<a href="#h10-2-56" id="h10-2-56" class="d">-            classReference.get()?.hook(getOrDefaultMethod.get()!!, HookStage.AFTER) { param -&gt;
</a><a href="#h10-2-57" id="h10-2-57" class="d">-                param.setResult(overrideParamResult(param.arg(0), param.getResult()))
</a><a href="#h10-2-58" id="h10-2-58" class="i">+                classReference.get()?.hook(getOrDefaultMethod.get()!!, HookStage.AFTER) { param -&gt;
</a><a href="#h10-2-59" id="h10-2-59" class="i">+                    param.setResult(overrideParamResult(param.arg(0), param.getResult()))
</a><a href="#h10-2-60" id="h10-2-60" class="i">+                }
</a>             }
         }
     }
<b>diff --git a/<a id="h11" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ScopeSync.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ScopeSync.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ScopeSync.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ScopeSync.kt</a></b>
<a href="#h11-0" id="h11-0" class="h">@@ -7,9 +7,8 @@ import me.rhunk.snapenhance.common.data.ContentType
</a> import me.rhunk.snapenhance.common.data.SocialScope
 import me.rhunk.snapenhance.core.event.events.impl.SendMessageWithContentEvent
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h11-0-3" id="h11-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> 
<a href="#h11-0-5" id="h11-0-5" class="d">-class ScopeSync : Feature(&quot;Scope Sync&quot;, loadParams = FeatureLoadParams.INIT_SYNC) {
</a><a href="#h11-0-6" id="h11-0-6" class="i">+class ScopeSync : Feature(&quot;Scope Sync&quot;) {
</a>     companion object {
         private const val DELAY_BEFORE_SYNC = 2000L
     }
<b>diff --git a/<a id="h12" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/downloader/MediaDownloader.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/downloader/MediaDownloader.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/downloader/MediaDownloader.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/downloader/MediaDownloader.kt</a></b>
<a href="#h12-0" id="h12-0" class="h">@@ -31,7 +31,6 @@ import me.rhunk.snapenhance.common.util.snap.MediaDownloaderHelper
</a> import me.rhunk.snapenhance.common.util.snap.RemoteMediaResolver
 import me.rhunk.snapenhance.core.DownloadManagerClient
 import me.rhunk.snapenhance.core.SnapEnhance
<a href="#h12-0-3" id="h12-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.features.MessagingRuleFeature
 import me.rhunk.snapenhance.core.features.impl.downloader.decoder.DecodedAttachment
 import me.rhunk.snapenhance.core.features.impl.downloader.decoder.MessageDecoder
<a href="#h12-1" id="h12-1" class="h">@@ -64,8 +63,7 @@ class SnapChapterInfo(
</a> )
 
 
<a href="#h12-1-3" id="h12-1-3" class="d">-@OptIn(ExperimentalEncodingApi::class)
</a><a href="#h12-1-4" id="h12-1-4" class="d">-class MediaDownloader : MessagingRuleFeature(&quot;MediaDownloader&quot;, MessagingRuleType.AUTO_DOWNLOAD, loadParams = FeatureLoadParams.ACTIVITY_CREATE_ASYNC) {
</a><a href="#h12-1-5" id="h12-1-5" class="i">+class MediaDownloader : MessagingRuleFeature(&quot;MediaDownloader&quot;, MessagingRuleType.AUTO_DOWNLOAD) {
</a>     private var lastSeenMediaInfoMap: MutableMap&lt;SplitMediaAssetType, MediaInfo&gt;? = null
     var lastSeenMapParams: ParamMap? = null
         private set
<a href="#h12-2" id="h12-2" class="h">@@ -487,50 +485,52 @@ class MediaDownloader : MessagingRuleFeature(&quot;MediaDownloader&quot;, MessagingRuleTyp
</a>         return options.any { keyFilter == null || it.contains(keyFilter, true) }
     }
 
<a href="#h12-2-3" id="h12-2-3" class="d">-    override fun asyncOnActivityCreate() {
</a><a href="#h12-2-4" id="h12-2-4" class="d">-        context.mappings.useMapper(OperaPageViewControllerMapper::class) {
</a><a href="#h12-2-5" id="h12-2-5" class="d">-            val onOperaViewStateCallback: (HookAdapter) -&gt; Unit = onOperaViewStateCallback@{ param -&gt;
</a><a href="#h12-2-6" id="h12-2-6" class="d">-                val viewState = (param.thisObject() as Any).getObjectField(viewStateField.get()!!).toString()
</a><a href="#h12-2-7" id="h12-2-7" class="d">-                if (viewState != &quot;FULLY_DISPLAYED&quot;) {
</a><a href="#h12-2-8" id="h12-2-8" class="d">-                    return@onOperaViewStateCallback
</a><a href="#h12-2-9" id="h12-2-9" class="d">-                }
</a><a href="#h12-2-10" id="h12-2-10" class="d">-                val operaLayerList = (param.thisObject() as Any).getObjectField(layerListField.get()!!) as ArrayList&lt;*&gt;
</a><a href="#h12-2-11" id="h12-2-11" class="d">-                val mediaParamMap: ParamMap = operaLayerList.map { Layer(it) }.first().paramMap
</a><a href="#h12-2-12" id="h12-2-12" class="i">+    override fun init() {
</a><a href="#h12-2-13" id="h12-2-13" class="i">+        onNextActivityCreate {
</a><a href="#h12-2-14" id="h12-2-14" class="i">+            context.mappings.useMapper(OperaPageViewControllerMapper::class) {
</a><a href="#h12-2-15" id="h12-2-15" class="i">+                val onOperaViewStateCallback: (HookAdapter) -&gt; Unit = onOperaViewStateCallback@{ param -&gt;
</a><a href="#h12-2-16" id="h12-2-16" class="i">+                    val viewState = (param.thisObject() as Any).getObjectField(viewStateField.get()!!).toString()
</a><a href="#h12-2-17" id="h12-2-17" class="i">+                    if (viewState != &quot;FULLY_DISPLAYED&quot;) {
</a><a href="#h12-2-18" id="h12-2-18" class="i">+                        return@onOperaViewStateCallback
</a><a href="#h12-2-19" id="h12-2-19" class="i">+                    }
</a><a href="#h12-2-20" id="h12-2-20" class="i">+                    val operaLayerList = (param.thisObject() as Any).getObjectField(layerListField.get()!!) as ArrayList&lt;*&gt;
</a><a href="#h12-2-21" id="h12-2-21" class="i">+                    val mediaParamMap: ParamMap = operaLayerList.map { Layer(it) }.first().paramMap
</a> 
<a href="#h12-2-23" id="h12-2-23" class="d">-                if (!mediaParamMap.containsKey(&quot;image_media_info&quot;) &amp;&amp; !mediaParamMap.containsKey(&quot;video_media_info_list&quot;))
</a><a href="#h12-2-24" id="h12-2-24" class="d">-                    return@onOperaViewStateCallback
</a><a href="#h12-2-25" id="h12-2-25" class="i">+                    if (!mediaParamMap.containsKey(&quot;image_media_info&quot;) &amp;&amp; !mediaParamMap.containsKey(&quot;video_media_info_list&quot;))
</a><a href="#h12-2-26" id="h12-2-26" class="i">+                        return@onOperaViewStateCallback
</a> 
<a href="#h12-2-28" id="h12-2-28" class="d">-                val mediaInfoMap = mutableMapOf&lt;SplitMediaAssetType, MediaInfo&gt;()
</a><a href="#h12-2-29" id="h12-2-29" class="d">-                val isVideo = mediaParamMap.containsKey(&quot;video_media_info_list&quot;)
</a><a href="#h12-2-30" id="h12-2-30" class="i">+                    val mediaInfoMap = mutableMapOf&lt;SplitMediaAssetType, MediaInfo&gt;()
</a><a href="#h12-2-31" id="h12-2-31" class="i">+                    val isVideo = mediaParamMap.containsKey(&quot;video_media_info_list&quot;)
</a> 
<a href="#h12-2-33" id="h12-2-33" class="d">-                mediaInfoMap[SplitMediaAssetType.ORIGINAL] = MediaInfo(
</a><a href="#h12-2-34" id="h12-2-34" class="d">-                    (if (isVideo) mediaParamMap[&quot;video_media_info_list&quot;] else mediaParamMap[&quot;image_media_info&quot;])!!
</a><a href="#h12-2-35" id="h12-2-35" class="d">-                )
</a><a href="#h12-2-36" id="h12-2-36" class="i">+                    mediaInfoMap[SplitMediaAssetType.ORIGINAL] = MediaInfo(
</a><a href="#h12-2-37" id="h12-2-37" class="i">+                        (if (isVideo) mediaParamMap[&quot;video_media_info_list&quot;] else mediaParamMap[&quot;image_media_info&quot;])!!
</a><a href="#h12-2-38" id="h12-2-38" class="i">+                    )
</a> 
<a href="#h12-2-40" id="h12-2-40" class="d">-                if (context.config.downloader.mergeOverlays.get() &amp;&amp; mediaParamMap.containsKey(&quot;overlay_image_media_info&quot;)) {
</a><a href="#h12-2-41" id="h12-2-41" class="d">-                    mediaInfoMap[SplitMediaAssetType.OVERLAY] =
</a><a href="#h12-2-42" id="h12-2-42" class="d">-                        MediaInfo(mediaParamMap[&quot;overlay_image_media_info&quot;]!!)
</a><a href="#h12-2-43" id="h12-2-43" class="d">-                }
</a><a href="#h12-2-44" id="h12-2-44" class="d">-                lastSeenMapParams = mediaParamMap
</a><a href="#h12-2-45" id="h12-2-45" class="d">-                lastSeenMediaInfoMap = mediaInfoMap
</a><a href="#h12-2-46" id="h12-2-46" class="i">+                    if (context.config.downloader.mergeOverlays.get() &amp;&amp; mediaParamMap.containsKey(&quot;overlay_image_media_info&quot;)) {
</a><a href="#h12-2-47" id="h12-2-47" class="i">+                        mediaInfoMap[SplitMediaAssetType.OVERLAY] =
</a><a href="#h12-2-48" id="h12-2-48" class="i">+                            MediaInfo(mediaParamMap[&quot;overlay_image_media_info&quot;]!!)
</a><a href="#h12-2-49" id="h12-2-49" class="i">+                    }
</a><a href="#h12-2-50" id="h12-2-50" class="i">+                    lastSeenMapParams = mediaParamMap
</a><a href="#h12-2-51" id="h12-2-51" class="i">+                    lastSeenMediaInfoMap = mediaInfoMap
</a> 
<a href="#h12-2-53" id="h12-2-53" class="d">-                if (!canAutoDownload()) return@onOperaViewStateCallback
</a><a href="#h12-2-54" id="h12-2-54" class="i">+                    if (!canAutoDownload()) return@onOperaViewStateCallback
</a> 
<a href="#h12-2-56" id="h12-2-56" class="d">-                context.executeAsync {
</a><a href="#h12-2-57" id="h12-2-57" class="d">-                    runCatching {
</a><a href="#h12-2-58" id="h12-2-58" class="d">-                        handleOperaMedia(mediaParamMap, mediaInfoMap, false)
</a><a href="#h12-2-59" id="h12-2-59" class="d">-                    }.onFailure {
</a><a href="#h12-2-60" id="h12-2-60" class="d">-                        context.log.error(&quot;Failed to handle opera media&quot;, it)
</a><a href="#h12-2-61" id="h12-2-61" class="d">-                        context.longToast(it.message)
</a><a href="#h12-2-62" id="h12-2-62" class="i">+                    context.executeAsync {
</a><a href="#h12-2-63" id="h12-2-63" class="i">+                        runCatching {
</a><a href="#h12-2-64" id="h12-2-64" class="i">+                            handleOperaMedia(mediaParamMap, mediaInfoMap, false)
</a><a href="#h12-2-65" id="h12-2-65" class="i">+                        }.onFailure {
</a><a href="#h12-2-66" id="h12-2-66" class="i">+                            context.log.error(&quot;Failed to handle opera media&quot;, it)
</a><a href="#h12-2-67" id="h12-2-67" class="i">+                            context.longToast(it.message)
</a><a href="#h12-2-68" id="h12-2-68" class="i">+                        }
</a>                     }
                 }
<a href="#h12-2-71" id="h12-2-71" class="d">-            }
</a> 
<a href="#h12-2-73" id="h12-2-73" class="d">-            arrayOf(onDisplayStateChange, onDisplayStateChangeGesture).forEach { methodName -&gt;
</a><a href="#h12-2-74" id="h12-2-74" class="d">-                classReference.get()?.hook(
</a><a href="#h12-2-75" id="h12-2-75" class="d">-                    methodName.get() ?: return@forEach,
</a><a href="#h12-2-76" id="h12-2-76" class="d">-                    HookStage.AFTER, onOperaViewStateCallback
</a><a href="#h12-2-77" id="h12-2-77" class="d">-                )
</a><a href="#h12-2-78" id="h12-2-78" class="i">+                arrayOf(onDisplayStateChange, onDisplayStateChangeGesture).forEach { methodName -&gt;
</a><a href="#h12-2-79" id="h12-2-79" class="i">+                    classReference.get()?.hook(
</a><a href="#h12-2-80" id="h12-2-80" class="i">+                        methodName.get() ?: return@forEach,
</a><a href="#h12-2-81" id="h12-2-81" class="i">+                        HookStage.AFTER, onOperaViewStateCallback
</a><a href="#h12-2-82" id="h12-2-82" class="i">+                    )
</a><a href="#h12-2-83" id="h12-2-83" class="i">+                }
</a>             }
         }
     }
<b>diff --git a/<a id="h13" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/downloader/ProfilePictureDownloader.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/downloader/ProfilePictureDownloader.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/downloader/ProfilePictureDownloader.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/downloader/ProfilePictureDownloader.kt</a></b>
<a href="#h13-0" id="h13-0" class="h">@@ -7,61 +7,62 @@ import me.rhunk.snapenhance.common.util.protobuf.ProtoReader
</a> import me.rhunk.snapenhance.core.event.events.impl.AddViewEvent
 import me.rhunk.snapenhance.core.event.events.impl.NetworkApiRequestEvent
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h13-0-3" id="h13-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.ui.ViewAppearanceHelper
 
<a href="#h13-0-6" id="h13-0-6" class="d">-class ProfilePictureDownloader : Feature(&quot;ProfilePictureDownloader&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_ASYNC) {
</a><a href="#h13-0-7" id="h13-0-7" class="i">+class ProfilePictureDownloader : Feature(&quot;ProfilePictureDownloader&quot;) {
</a>     @SuppressLint(&quot;SetTextI18n&quot;)
<a href="#h13-0-9" id="h13-0-9" class="d">-    override fun asyncOnActivityCreate() {
</a><a href="#h13-0-10" id="h13-0-10" class="i">+    override fun init() {
</a>         if (!context.config.downloader.downloadProfilePictures.get()) return
 
         var friendUsername: String? = null
         var backgroundUrl: String? = null
         var avatarUrl: String? = null
 
<a href="#h13-0-17" id="h13-0-17" class="d">-        context.event.subscribe(AddViewEvent::class) { event -&gt;
</a><a href="#h13-0-18" id="h13-0-18" class="d">-            if (event.view::class.java.name != &quot;com.snap.unifiedpublicprofile.UnifiedPublicProfileView&quot;) return@subscribe
</a><a href="#h13-0-19" id="h13-0-19" class="i">+        onNextActivityCreate(defer = true) {
</a><a href="#h13-0-20" id="h13-0-20" class="i">+            context.event.subscribe(AddViewEvent::class) { event -&gt;
</a><a href="#h13-0-21" id="h13-0-21" class="i">+                if (event.view::class.java.name != &quot;com.snap.unifiedpublicprofile.UnifiedPublicProfileView&quot;) return@subscribe
</a> 
<a href="#h13-0-23" id="h13-0-23" class="d">-            event.parent.addView(Button(event.parent.context).apply {
</a><a href="#h13-0-24" id="h13-0-24" class="d">-                text = this@ProfilePictureDownloader.context.translation[&quot;profile_picture_downloader.button&quot;]
</a><a href="#h13-0-25" id="h13-0-25" class="d">-                layoutParams = RelativeLayout.LayoutParams(RelativeLayout.LayoutParams.WRAP_CONTENT, RelativeLayout.LayoutParams.WRAP_CONTENT).apply {
</a><a href="#h13-0-26" id="h13-0-26" class="d">-                    setMargins(0, 200, 0, 0)
</a><a href="#h13-0-27" id="h13-0-27" class="d">-                }
</a><a href="#h13-0-28" id="h13-0-28" class="d">-                setOnClickListener {
</a><a href="#h13-0-29" id="h13-0-29" class="d">-                    ViewAppearanceHelper.newAlertDialogBuilder(
</a><a href="#h13-0-30" id="h13-0-30" class="d">-                        this@ProfilePictureDownloader.context.mainActivity!!
</a><a href="#h13-0-31" id="h13-0-31" class="d">-                    ).apply {
</a><a href="#h13-0-32" id="h13-0-32" class="d">-                        setTitle(this@ProfilePictureDownloader.context.translation[&quot;profile_picture_downloader.title&quot;])
</a><a href="#h13-0-33" id="h13-0-33" class="d">-                        val choices = mutableMapOf&lt;String, String&gt;()
</a><a href="#h13-0-34" id="h13-0-34" class="d">-                        backgroundUrl?.let { choices[&quot;background_option&quot;] = it }
</a><a href="#h13-0-35" id="h13-0-35" class="d">-                        avatarUrl?.let { choices[&quot;avatar_option&quot;] = it }
</a><a href="#h13-0-36" id="h13-0-36" class="i">+                event.parent.addView(Button(event.parent.context).apply {
</a><a href="#h13-0-37" id="h13-0-37" class="i">+                    text = this@ProfilePictureDownloader.context.translation[&quot;profile_picture_downloader.button&quot;]
</a><a href="#h13-0-38" id="h13-0-38" class="i">+                    layoutParams = RelativeLayout.LayoutParams(RelativeLayout.LayoutParams.WRAP_CONTENT, RelativeLayout.LayoutParams.WRAP_CONTENT).apply {
</a><a href="#h13-0-39" id="h13-0-39" class="i">+                        setMargins(0, 200, 0, 0)
</a><a href="#h13-0-40" id="h13-0-40" class="i">+                    }
</a><a href="#h13-0-41" id="h13-0-41" class="i">+                    setOnClickListener {
</a><a href="#h13-0-42" id="h13-0-42" class="i">+                        ViewAppearanceHelper.newAlertDialogBuilder(
</a><a href="#h13-0-43" id="h13-0-43" class="i">+                            this@ProfilePictureDownloader.context.mainActivity!!
</a><a href="#h13-0-44" id="h13-0-44" class="i">+                        ).apply {
</a><a href="#h13-0-45" id="h13-0-45" class="i">+                            setTitle(this@ProfilePictureDownloader.context.translation[&quot;profile_picture_downloader.title&quot;])
</a><a href="#h13-0-46" id="h13-0-46" class="i">+                            val choices = mutableMapOf&lt;String, String&gt;()
</a><a href="#h13-0-47" id="h13-0-47" class="i">+                            backgroundUrl?.let { choices[&quot;background_option&quot;] = it }
</a><a href="#h13-0-48" id="h13-0-48" class="i">+                            avatarUrl?.let { choices[&quot;avatar_option&quot;] = it }
</a> 
<a href="#h13-0-50" id="h13-0-50" class="d">-                        setItems(choices.keys.map {
</a><a href="#h13-0-51" id="h13-0-51" class="d">-                            this@ProfilePictureDownloader.context.translation[&quot;profile_picture_downloader.$it&quot;]
</a><a href="#h13-0-52" id="h13-0-52" class="d">-                        }.toTypedArray()) { _, which -&gt;
</a><a href="#h13-0-53" id="h13-0-53" class="d">-                            runCatching {
</a><a href="#h13-0-54" id="h13-0-54" class="d">-                                this@ProfilePictureDownloader.context.feature(MediaDownloader::class).downloadProfilePicture(
</a><a href="#h13-0-55" id="h13-0-55" class="d">-                                    choices.values.elementAt(which),
</a><a href="#h13-0-56" id="h13-0-56" class="d">-                                    friendUsername!!
</a><a href="#h13-0-57" id="h13-0-57" class="d">-                                )
</a><a href="#h13-0-58" id="h13-0-58" class="d">-                            }.onFailure {
</a><a href="#h13-0-59" id="h13-0-59" class="d">-                                this@ProfilePictureDownloader.context.log.error(&quot;Failed to download profile picture&quot;, it)
</a><a href="#h13-0-60" id="h13-0-60" class="i">+                            setItems(choices.keys.map {
</a><a href="#h13-0-61" id="h13-0-61" class="i">+                                this@ProfilePictureDownloader.context.translation[&quot;profile_picture_downloader.$it&quot;]
</a><a href="#h13-0-62" id="h13-0-62" class="i">+                            }.toTypedArray()) { _, which -&gt;
</a><a href="#h13-0-63" id="h13-0-63" class="i">+                                runCatching {
</a><a href="#h13-0-64" id="h13-0-64" class="i">+                                    this@ProfilePictureDownloader.context.feature(MediaDownloader::class).downloadProfilePicture(
</a><a href="#h13-0-65" id="h13-0-65" class="i">+                                        choices.values.elementAt(which),
</a><a href="#h13-0-66" id="h13-0-66" class="i">+                                        friendUsername!!
</a><a href="#h13-0-67" id="h13-0-67" class="i">+                                    )
</a><a href="#h13-0-68" id="h13-0-68" class="i">+                                }.onFailure {
</a><a href="#h13-0-69" id="h13-0-69" class="i">+                                    this@ProfilePictureDownloader.context.log.error(&quot;Failed to download profile picture&quot;, it)
</a><a href="#h13-0-70" id="h13-0-70" class="i">+                                }
</a>                             }
<a href="#h13-0-72" id="h13-0-72" class="d">-                        }
</a><a href="#h13-0-73" id="h13-0-73" class="d">-                    }.show()
</a><a href="#h13-0-74" id="h13-0-74" class="d">-                }
</a><a href="#h13-0-75" id="h13-0-75" class="d">-            })
</a><a href="#h13-0-76" id="h13-0-76" class="d">-        }
</a><a href="#h13-0-77" id="h13-0-77" class="i">+                        }.show()
</a><a href="#h13-0-78" id="h13-0-78" class="i">+                    }
</a><a href="#h13-0-79" id="h13-0-79" class="i">+                })
</a><a href="#h13-0-80" id="h13-0-80" class="i">+            }
</a> 
 
<a href="#h13-0-83" id="h13-0-83" class="d">-        context.event.subscribe(NetworkApiRequestEvent::class) { event -&gt;
</a><a href="#h13-0-84" id="h13-0-84" class="d">-            if (!event.url.endsWith(&quot;/rpc/getPublicProfile&quot;)) return@subscribe
</a><a href="#h13-0-85" id="h13-0-85" class="d">-            event.onSuccess {  buffer -&gt;
</a><a href="#h13-0-86" id="h13-0-86" class="d">-                ProtoReader(buffer ?: return@onSuccess).followPath(1, 1, 2) {
</a><a href="#h13-0-87" id="h13-0-87" class="d">-                    friendUsername = getString(2) ?: return@followPath
</a><a href="#h13-0-88" id="h13-0-88" class="d">-                    followPath(4) {
</a><a href="#h13-0-89" id="h13-0-89" class="d">-                        backgroundUrl = getString(2)
</a><a href="#h13-0-90" id="h13-0-90" class="d">-                        avatarUrl = getString(100)
</a><a href="#h13-0-91" id="h13-0-91" class="i">+            context.event.subscribe(NetworkApiRequestEvent::class) { event -&gt;
</a><a href="#h13-0-92" id="h13-0-92" class="i">+                if (!event.url.endsWith(&quot;/rpc/getPublicProfile&quot;)) return@subscribe
</a><a href="#h13-0-93" id="h13-0-93" class="i">+                event.onSuccess {  buffer -&gt;
</a><a href="#h13-0-94" id="h13-0-94" class="i">+                    ProtoReader(buffer ?: return@onSuccess).followPath(1, 1, 2) {
</a><a href="#h13-0-95" id="h13-0-95" class="i">+                        friendUsername = getString(2) ?: return@followPath
</a><a href="#h13-0-96" id="h13-0-96" class="i">+                        followPath(4) {
</a><a href="#h13-0-97" id="h13-0-97" class="i">+                            backgroundUrl = getString(2)
</a><a href="#h13-0-98" id="h13-0-98" class="i">+                            avatarUrl = getString(100)
</a><a href="#h13-0-99" id="h13-0-99" class="i">+                        }
</a>                     }
                 }
             }
<b>diff --git a/<a id="h14" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/AccountSwitcher.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/AccountSwitcher.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/AccountSwitcher.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/AccountSwitcher.kt</a></b>
<a href="#h14-0" id="h14-0" class="h">@@ -36,7 +36,6 @@ import me.rhunk.snapenhance.common.util.snap.MediaDownloaderHelper
</a> import me.rhunk.snapenhance.core.event.events.impl.ActivityResultEvent
 import me.rhunk.snapenhance.core.event.events.impl.AddViewEvent
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h14-0-3" id="h14-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.util.hook.HookStage
 import me.rhunk.snapenhance.core.util.hook.hook
 import me.rhunk.snapenhance.core.util.ktx.getId
<a href="#h14-1" id="h14-1" class="h">@@ -47,7 +46,7 @@ import java.util.zip.ZipInputStream
</a> import java.util.zip.ZipOutputStream
 import kotlin.random.Random
 
<a href="#h14-1-3" id="h14-1-3" class="d">-class AccountSwitcher: Feature(&quot;Account Switcher&quot;, loadParams = FeatureLoadParams.INIT_SYNC or FeatureLoadParams.ACTIVITY_CREATE_SYNC) {
</a><a href="#h14-1-4" id="h14-1-4" class="i">+class AccountSwitcher: Feature(&quot;Account Switcher&quot;) {
</a>     private var exportCallback: Pair&lt;Int, String&gt;? = null // requestCode -&gt; userId
     private var importRequestCode: Int? = null
 
<a href="#h14-2" id="h14-2" class="h">@@ -425,25 +424,23 @@ class AccountSwitcher: Feature(&quot;Account Switcher&quot;, loadParams = FeatureLoadParam
</a>         mainDbShmFile?.delete()
     }
 
<a href="#h14-2-3" id="h14-2-3" class="d">-    override fun onActivityCreate() {
</a><a href="#h14-2-4" id="h14-2-4" class="i">+    @SuppressLint(&quot;SetTextI18n&quot;)
</a><a href="#h14-2-5" id="h14-2-5" class="i">+    override fun init() {
</a>         if (context.config.experimental.accountSwitcher.globalState != true) return
 
<a href="#h14-2-8" id="h14-2-8" class="d">-        val hovaHeaderSearchIcon = context.mainActivity!!.resources.getId(&quot;hova_header_search_icon&quot;)
</a><a href="#h14-2-9" id="h14-2-9" class="i">+        onNextActivityCreate {
</a><a href="#h14-2-10" id="h14-2-10" class="i">+            val hovaHeaderSearchIcon = context.resources.getId(&quot;hova_header_search_icon&quot;)
</a> 
<a href="#h14-2-12" id="h14-2-12" class="d">-        context.event.subscribe(AddViewEvent::class) { event -&gt;
</a><a href="#h14-2-13" id="h14-2-13" class="d">-            if (event.view.id != hovaHeaderSearchIcon) return@subscribe
</a><a href="#h14-2-14" id="h14-2-14" class="i">+            context.event.subscribe(AddViewEvent::class) { event -&gt;
</a><a href="#h14-2-15" id="h14-2-15" class="i">+                if (event.view.id != hovaHeaderSearchIcon) return@subscribe
</a> 
<a href="#h14-2-17" id="h14-2-17" class="d">-            event.view.setOnLongClickListener {
</a><a href="#h14-2-18" id="h14-2-18" class="d">-                context.mainActivity!!.vibrateLongPress()
</a><a href="#h14-2-19" id="h14-2-19" class="d">-                showManagementPopup()
</a><a href="#h14-2-20" id="h14-2-20" class="d">-                false
</a><a href="#h14-2-21" id="h14-2-21" class="i">+                event.view.setOnLongClickListener {
</a><a href="#h14-2-22" id="h14-2-22" class="i">+                    context.mainActivity!!.vibrateLongPress()
</a><a href="#h14-2-23" id="h14-2-23" class="i">+                    showManagementPopup()
</a><a href="#h14-2-24" id="h14-2-24" class="i">+                    false
</a><a href="#h14-2-25" id="h14-2-25" class="i">+                }
</a>             }
         }
<a href="#h14-2-28" id="h14-2-28" class="d">-    }
</a><a href="#h14-2-29" id="h14-2-29" class="d">-
</a><a href="#h14-2-30" id="h14-2-30" class="d">-    @SuppressLint(&quot;SetTextI18n&quot;)
</a><a href="#h14-2-31" id="h14-2-31" class="d">-    override fun init() {
</a><a href="#h14-2-32" id="h14-2-32" class="d">-        if (context.config.experimental.accountSwitcher.globalState != true) return
</a> 
         context.event.subscribe(ActivityResultEvent::class) { event -&gt;
             if (importRequestCode == event.requestCode) {
<a href="#h14-3" id="h14-3" class="h">@@ -501,7 +498,7 @@ class AccountSwitcher: Feature(&quot;Account Switcher&quot;, loadParams = FeatureLoadParam
</a>         }
 
         findClass(&quot;com.snap.identity.loginsignup.ui.LoginSignupActivity&quot;).apply {
<a href="#h14-3-3" id="h14-3-3" class="d">-            hook(&quot;onPostCreate&quot;, HookStage.AFTER) { param -&gt;
</a><a href="#h14-3-4" id="h14-3-4" class="i">+            hook(&quot;onPostCreate&quot;, HookStage.AFTER) {
</a>                 context.mainActivity!!.findViewById&lt;FrameLayout&gt;(android.R.id.content).addView(createComposeView(context.mainActivity!!) {
                     Row(
                         modifier = Modifier.fillMaxWidth(),
<b>diff --git a/<a id="h15" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/AddFriendSourceSpoof.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/AddFriendSourceSpoof.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/AddFriendSourceSpoof.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/AddFriendSourceSpoof.kt</a></b>
<a href="#h15-0" id="h15-0" class="h">@@ -4,68 +4,69 @@ import me.rhunk.snapenhance.common.data.FriendAddSource
</a> import me.rhunk.snapenhance.common.util.protobuf.ProtoEditor
 import me.rhunk.snapenhance.core.event.events.impl.UnaryCallEvent
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h15-0-3" id="h15-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.util.hook.HookStage
 import me.rhunk.snapenhance.core.util.hook.hookConstructor
 import me.rhunk.snapenhance.mapper.impl.FriendRelationshipChangerMapper
 
<a href="#h15-0-8" id="h15-0-8" class="d">-class AddFriendSourceSpoof : Feature(&quot;AddFriendSourceSpoof&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_SYNC) {
</a><a href="#h15-0-9" id="h15-0-9" class="i">+class AddFriendSourceSpoof : Feature(&quot;AddFriendSourceSpoof&quot;) {
</a>     var friendRelationshipChangerInstance: Any? = null
         private set
 
<a href="#h15-0-13" id="h15-0-13" class="d">-    override fun onActivityCreate() {
</a><a href="#h15-0-14" id="h15-0-14" class="d">-        context.mappings.useMapper(FriendRelationshipChangerMapper::class) {
</a><a href="#h15-0-15" id="h15-0-15" class="d">-            classReference.get()?.hookConstructor(HookStage.AFTER) { param -&gt;
</a><a href="#h15-0-16" id="h15-0-16" class="d">-                friendRelationshipChangerInstance = param.thisObject()
</a><a href="#h15-0-17" id="h15-0-17" class="i">+    override fun init() {
</a><a href="#h15-0-18" id="h15-0-18" class="i">+        onNextActivityCreate {
</a><a href="#h15-0-19" id="h15-0-19" class="i">+            context.mappings.useMapper(FriendRelationshipChangerMapper::class) {
</a><a href="#h15-0-20" id="h15-0-20" class="i">+                classReference.get()?.hookConstructor(HookStage.AFTER) { param -&gt;
</a><a href="#h15-0-21" id="h15-0-21" class="i">+                    friendRelationshipChangerInstance = param.thisObject()
</a><a href="#h15-0-22" id="h15-0-22" class="i">+                }
</a>             }
<a href="#h15-0-24" id="h15-0-24" class="d">-        }
</a><a href="#h15-0-25" id="h15-0-25" class="d">-
</a><a href="#h15-0-26" id="h15-0-26" class="d">-        context.event.subscribe(UnaryCallEvent::class) { event -&gt;
</a><a href="#h15-0-27" id="h15-0-27" class="d">-            if (event.uri != &quot;/snapchat.friending.server.FriendAction/AddFriends&quot;) return@subscribe
</a><a href="#h15-0-28" id="h15-0-28" class="d">-            val spoofedSource = context.config.experimental.addFriendSourceSpoof.getNullable() ?: return@subscribe
</a><a href="#h15-0-29" id="h15-0-29" class="d">-            event.buffer = ProtoEditor(event.buffer).apply {
</a><a href="#h15-0-30" id="h15-0-30" class="d">-                edit {
</a><a href="#h15-0-31" id="h15-0-31" class="d">-                    fun setPage(value: String) {
</a><a href="#h15-0-32" id="h15-0-32" class="d">-                        remove(1)
</a><a href="#h15-0-33" id="h15-0-33" class="d">-                        addString(1, value)
</a><a href="#h15-0-34" id="h15-0-34" class="d">-                    }
</a> 
<a href="#h15-0-36" id="h15-0-36" class="d">-                    editEach(2) {
</a><a href="#h15-0-37" id="h15-0-37" class="d">-                        remove(3) // remove suggestion token
</a><a href="#h15-0-38" id="h15-0-38" class="d">-                        fun setSource(source: FriendAddSource) {
</a><a href="#h15-0-39" id="h15-0-39" class="d">-                            remove(2)
</a><a href="#h15-0-40" id="h15-0-40" class="d">-                            addVarInt(2, source.id)
</a><a href="#h15-0-41" id="h15-0-41" class="i">+            context.event.subscribe(UnaryCallEvent::class) { event -&gt;
</a><a href="#h15-0-42" id="h15-0-42" class="i">+                if (event.uri != &quot;/snapchat.friending.server.FriendAction/AddFriends&quot;) return@subscribe
</a><a href="#h15-0-43" id="h15-0-43" class="i">+                val spoofedSource = context.config.experimental.addFriendSourceSpoof.getNullable() ?: return@subscribe
</a><a href="#h15-0-44" id="h15-0-44" class="i">+                event.buffer = ProtoEditor(event.buffer).apply {
</a><a href="#h15-0-45" id="h15-0-45" class="i">+                    edit {
</a><a href="#h15-0-46" id="h15-0-46" class="i">+                        fun setPage(value: String) {
</a><a href="#h15-0-47" id="h15-0-47" class="i">+                            remove(1)
</a><a href="#h15-0-48" id="h15-0-48" class="i">+                            addString(1, value)
</a>                         }
 
<a href="#h15-0-51" id="h15-0-51" class="d">-                        when (spoofedSource) {
</a><a href="#h15-0-52" id="h15-0-52" class="d">-                            &quot;added_by_group_chat&quot; -&gt; {
</a><a href="#h15-0-53" id="h15-0-53" class="d">-                                setPage(&quot;group_profile&quot;)
</a><a href="#h15-0-54" id="h15-0-54" class="d">-                                setSource(FriendAddSource.GROUP_CHAT)
</a><a href="#h15-0-55" id="h15-0-55" class="d">-                            }
</a><a href="#h15-0-56" id="h15-0-56" class="d">-                            &quot;added_by_username&quot; -&gt; {
</a><a href="#h15-0-57" id="h15-0-57" class="d">-                                setPage(&quot;search&quot;)
</a><a href="#h15-0-58" id="h15-0-58" class="d">-                                setSource(FriendAddSource.USERNAME)
</a><a href="#h15-0-59" id="h15-0-59" class="d">-                            }
</a><a href="#h15-0-60" id="h15-0-60" class="d">-                            &quot;added_by_qr_code&quot; -&gt; {
</a><a href="#h15-0-61" id="h15-0-61" class="d">-                                setPage(&quot;scan_snapcode&quot;)
</a><a href="#h15-0-62" id="h15-0-62" class="d">-                                setSource(FriendAddSource.QR_CODE)
</a><a href="#h15-0-63" id="h15-0-63" class="i">+                        editEach(2) {
</a><a href="#h15-0-64" id="h15-0-64" class="i">+                            remove(3) // remove suggestion token
</a><a href="#h15-0-65" id="h15-0-65" class="i">+                            fun setSource(source: FriendAddSource) {
</a><a href="#h15-0-66" id="h15-0-66" class="i">+                                remove(2)
</a><a href="#h15-0-67" id="h15-0-67" class="i">+                                addVarInt(2, source.id)
</a>                             }
<a href="#h15-0-69" id="h15-0-69" class="d">-                            &quot;added_by_mention&quot; -&gt; {
</a><a href="#h15-0-70" id="h15-0-70" class="d">-                                setPage(&quot;context_card&quot;)
</a><a href="#h15-0-71" id="h15-0-71" class="d">-                                setSource(FriendAddSource.MENTION)
</a><a href="#h15-0-72" id="h15-0-72" class="d">-                            }
</a><a href="#h15-0-73" id="h15-0-73" class="d">-                            &quot;added_by_community&quot; -&gt; {
</a><a href="#h15-0-74" id="h15-0-74" class="d">-                                setPage(&quot;profile&quot;)
</a><a href="#h15-0-75" id="h15-0-75" class="d">-                                setSource(FriendAddSource.COMMUNITY)
</a><a href="#h15-0-76" id="h15-0-76" class="d">-                            }
</a><a href="#h15-0-77" id="h15-0-77" class="d">-                            &quot;added_by_quick_add&quot; -&gt; {
</a><a href="#h15-0-78" id="h15-0-78" class="d">-                                setPage(&quot;add_friends_button_on_top_bar_on_friends_feed&quot;)
</a><a href="#h15-0-79" id="h15-0-79" class="d">-                                setSource(FriendAddSource.SUGGESTED)
</a><a href="#h15-0-80" id="h15-0-80" class="i">+
</a><a href="#h15-0-81" id="h15-0-81" class="i">+                            when (spoofedSource) {
</a><a href="#h15-0-82" id="h15-0-82" class="i">+                                &quot;added_by_group_chat&quot; -&gt; {
</a><a href="#h15-0-83" id="h15-0-83" class="i">+                                    setPage(&quot;group_profile&quot;)
</a><a href="#h15-0-84" id="h15-0-84" class="i">+                                    setSource(FriendAddSource.GROUP_CHAT)
</a><a href="#h15-0-85" id="h15-0-85" class="i">+                                }
</a><a href="#h15-0-86" id="h15-0-86" class="i">+                                &quot;added_by_username&quot; -&gt; {
</a><a href="#h15-0-87" id="h15-0-87" class="i">+                                    setPage(&quot;search&quot;)
</a><a href="#h15-0-88" id="h15-0-88" class="i">+                                    setSource(FriendAddSource.USERNAME)
</a><a href="#h15-0-89" id="h15-0-89" class="i">+                                }
</a><a href="#h15-0-90" id="h15-0-90" class="i">+                                &quot;added_by_qr_code&quot; -&gt; {
</a><a href="#h15-0-91" id="h15-0-91" class="i">+                                    setPage(&quot;scan_snapcode&quot;)
</a><a href="#h15-0-92" id="h15-0-92" class="i">+                                    setSource(FriendAddSource.QR_CODE)
</a><a href="#h15-0-93" id="h15-0-93" class="i">+                                }
</a><a href="#h15-0-94" id="h15-0-94" class="i">+                                &quot;added_by_mention&quot; -&gt; {
</a><a href="#h15-0-95" id="h15-0-95" class="i">+                                    setPage(&quot;context_card&quot;)
</a><a href="#h15-0-96" id="h15-0-96" class="i">+                                    setSource(FriendAddSource.MENTION)
</a><a href="#h15-0-97" id="h15-0-97" class="i">+                                }
</a><a href="#h15-0-98" id="h15-0-98" class="i">+                                &quot;added_by_community&quot; -&gt; {
</a><a href="#h15-0-99" id="h15-0-99" class="i">+                                    setPage(&quot;profile&quot;)
</a><a href="#h15-0-100" id="h15-0-100" class="i">+                                    setSource(FriendAddSource.COMMUNITY)
</a><a href="#h15-0-101" id="h15-0-101" class="i">+                                }
</a><a href="#h15-0-102" id="h15-0-102" class="i">+                                &quot;added_by_quick_add&quot; -&gt; {
</a><a href="#h15-0-103" id="h15-0-103" class="i">+                                    setPage(&quot;add_friends_button_on_top_bar_on_friends_feed&quot;)
</a><a href="#h15-0-104" id="h15-0-104" class="i">+                                    setSource(FriendAddSource.SUGGESTED)
</a><a href="#h15-0-105" id="h15-0-105" class="i">+                                }
</a>                             }
                         }
                     }
<a href="#h15-0-109" id="h15-0-109" class="d">-                }
</a><a href="#h15-0-110" id="h15-0-110" class="d">-            }.toByteArray()
</a><a href="#h15-0-111" id="h15-0-111" class="i">+                }.toByteArray()
</a><a href="#h15-0-112" id="h15-0-112" class="i">+            }
</a>         }
     }
 } 
\ No newline at end of file
<b>diff --git a/<a id="h16" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/AppLock.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/AppLock.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/AppLock.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/AppLock.kt</a></b>
<a href="#h16-0" id="h16-0" class="h">@@ -31,7 +31,6 @@ import me.rhunk.snapenhance.common.ui.AppMaterialTheme
</a> import me.rhunk.snapenhance.common.ui.createComposeView
 import me.rhunk.snapenhance.core.event.events.impl.ActivityResultEvent
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h16-0-3" id="h16-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.ui.addForegroundDrawable
 import me.rhunk.snapenhance.core.ui.children
 import me.rhunk.snapenhance.core.ui.removeForegroundDrawable
<a href="#h16-1" id="h16-1" class="h">@@ -39,7 +38,7 @@ import me.rhunk.snapenhance.core.util.hook.HookStage
</a> import me.rhunk.snapenhance.core.util.hook.hook
 import kotlin.random.Random
 
<a href="#h16-1-3" id="h16-1-3" class="d">-class AppLock : Feature(&quot;AppLock&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_SYNC) {
</a><a href="#h16-1-4" id="h16-1-4" class="i">+class AppLock : Feature(&quot;AppLock&quot;) {
</a>     private var isUnlockRequested = false
 
     private val rootContentView get() = context.mainActivity!!.findViewById&lt;FrameLayout&gt;(android.R.id.content)
<a href="#h16-2" id="h16-2" class="h">@@ -122,32 +121,34 @@ class AppLock : Feature(&quot;AppLock&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREAT
</a>         }
     }
 
<a href="#h16-2-3" id="h16-2-3" class="d">-    override fun onActivityCreate() {
</a><a href="#h16-2-4" id="h16-2-4" class="i">+    override fun init() {
</a>         if (context.config.experimental.appLock.globalState != true) return
 
<a href="#h16-2-7" id="h16-2-7" class="d">-        Activity::class.java.apply {
</a><a href="#h16-2-8" id="h16-2-8" class="d">-            if (context.config.experimental.appLock.lockOnResume.get()) {
</a><a href="#h16-2-9" id="h16-2-9" class="d">-                hook(&quot;onResume&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h16-2-10" id="h16-2-10" class="d">-                    if (param.thisObject&lt;Activity&gt;().packageName != Constants.SNAPCHAT_PACKAGE_NAME) return@hook
</a><a href="#h16-2-11" id="h16-2-11" class="d">-                    if (isUnlockRequested) return@hook
</a><a href="#h16-2-12" id="h16-2-12" class="d">-                    lock(prompt = true)
</a><a href="#h16-2-13" id="h16-2-13" class="d">-                }
</a><a href="#h16-2-14" id="h16-2-14" class="d">-                hook(&quot;onPause&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h16-2-15" id="h16-2-15" class="d">-                    if (param.thisObject&lt;Activity&gt;().packageName != Constants.SNAPCHAT_PACKAGE_NAME) return@hook
</a><a href="#h16-2-16" id="h16-2-16" class="d">-                    if (isUnlockRequested) return@hook
</a><a href="#h16-2-17" id="h16-2-17" class="d">-                    hideRootView()
</a><a href="#h16-2-18" id="h16-2-18" class="i">+        onNextActivityCreate {
</a><a href="#h16-2-19" id="h16-2-19" class="i">+            Activity::class.java.apply {
</a><a href="#h16-2-20" id="h16-2-20" class="i">+                if (context.config.experimental.appLock.lockOnResume.get()) {
</a><a href="#h16-2-21" id="h16-2-21" class="i">+                    hook(&quot;onResume&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h16-2-22" id="h16-2-22" class="i">+                        if (param.thisObject&lt;Activity&gt;().packageName != Constants.SNAPCHAT_PACKAGE_NAME) return@hook
</a><a href="#h16-2-23" id="h16-2-23" class="i">+                        if (isUnlockRequested) return@hook
</a><a href="#h16-2-24" id="h16-2-24" class="i">+                        lock(prompt = true)
</a><a href="#h16-2-25" id="h16-2-25" class="i">+                    }
</a><a href="#h16-2-26" id="h16-2-26" class="i">+                    hook(&quot;onPause&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h16-2-27" id="h16-2-27" class="i">+                        if (param.thisObject&lt;Activity&gt;().packageName != Constants.SNAPCHAT_PACKAGE_NAME) return@hook
</a><a href="#h16-2-28" id="h16-2-28" class="i">+                        if (isUnlockRequested) return@hook
</a><a href="#h16-2-29" id="h16-2-29" class="i">+                        hideRootView()
</a><a href="#h16-2-30" id="h16-2-30" class="i">+                    }
</a>                 }
             }
<a href="#h16-2-33" id="h16-2-33" class="d">-        }
</a> 
<a href="#h16-2-35" id="h16-2-35" class="d">-        context.event.subscribe(ActivityResultEvent::class) { event -&gt;
</a><a href="#h16-2-36" id="h16-2-36" class="d">-            if (event.requestCode != requestCode) return@subscribe
</a><a href="#h16-2-37" id="h16-2-37" class="d">-            if (event.resultCode == Activity.RESULT_OK) {
</a><a href="#h16-2-38" id="h16-2-38" class="d">-                unlock()
</a><a href="#h16-2-39" id="h16-2-39" class="d">-                return@subscribe
</a><a href="#h16-2-40" id="h16-2-40" class="i">+            context.event.subscribe(ActivityResultEvent::class) { event -&gt;
</a><a href="#h16-2-41" id="h16-2-41" class="i">+                if (event.requestCode != requestCode) return@subscribe
</a><a href="#h16-2-42" id="h16-2-42" class="i">+                if (event.resultCode == Activity.RESULT_OK) {
</a><a href="#h16-2-43" id="h16-2-43" class="i">+                    unlock()
</a><a href="#h16-2-44" id="h16-2-44" class="i">+                    return@subscribe
</a><a href="#h16-2-45" id="h16-2-45" class="i">+                }
</a><a href="#h16-2-46" id="h16-2-46" class="i">+                lock(prompt = false)
</a>             }
<a href="#h16-2-48" id="h16-2-48" class="d">-            lock(prompt = false)
</a><a href="#h16-2-49" id="h16-2-49" class="i">+            lock()
</a>         }
<a href="#h16-2-51" id="h16-2-51" class="d">-        lock()
</a>     }
 } 
\ No newline at end of file
<b>diff --git a/<a id="h17" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/AutoOpenSnaps.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/AutoOpenSnaps.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/AutoOpenSnaps.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/AutoOpenSnaps.kt</a></b>
<a href="#h17-0" id="h17-0" class="h">@@ -11,7 +11,6 @@ import me.rhunk.snapenhance.common.data.ContentType
</a> import me.rhunk.snapenhance.common.data.MessageUpdate
 import me.rhunk.snapenhance.common.data.MessagingRuleType
 import me.rhunk.snapenhance.core.event.events.impl.BuildMessageEvent
<a href="#h17-0-3" id="h17-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.features.MessagingRuleFeature
 import me.rhunk.snapenhance.core.features.impl.messaging.Messaging
 import java.util.concurrent.atomic.AtomicInteger
<a href="#h17-1" id="h17-1" class="h">@@ -19,7 +18,7 @@ import kotlin.coroutines.resume
</a> import kotlin.coroutines.suspendCoroutine
 import kotlin.random.Random
 
<a href="#h17-1-3" id="h17-1-3" class="d">-class AutoOpenSnaps: MessagingRuleFeature(&quot;Auto Open Snaps&quot;, MessagingRuleType.AUTO_OPEN_SNAPS, loadParams = FeatureLoadParams.INIT_SYNC) {
</a><a href="#h17-1-4" id="h17-1-4" class="i">+class AutoOpenSnaps: MessagingRuleFeature(&quot;Auto Open Snaps&quot;, MessagingRuleType.AUTO_OPEN_SNAPS) {
</a>     private val snapQueue = MutableSharedFlow&lt;Pair&lt;String, Long&gt;&gt;()
     private var snapQueueSize = AtomicInteger(0)
     private val openedSnaps = mutableListOf&lt;Long&gt;()
<b>diff --git a/<a id="h18" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/BestFriendPinning.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/BestFriendPinning.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/BestFriendPinning.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/BestFriendPinning.kt</a></b>
<a href="#h18-0" id="h18-0" class="h">@@ -12,13 +12,12 @@ import me.rhunk.snapenhance.common.util.protobuf.ProtoReader
</a> import me.rhunk.snapenhance.core.event.events.impl.NetworkApiRequestEvent
 import me.rhunk.snapenhance.core.event.events.impl.UnaryCallEvent
 import me.rhunk.snapenhance.core.features.BridgeFileFeature
<a href="#h18-0-3" id="h18-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.ui.triggerRootCloseTouchEvent
 import java.io.InputStreamReader
 import java.nio.ByteBuffer
 import java.util.UUID
 
<a href="#h18-0-9" id="h18-0-9" class="d">-class BestFriendPinning: BridgeFileFeature(&quot;Best Friend Pinning&quot;, InternalFileHandleType.PINNED_BEST_FRIEND, loadParams = FeatureLoadParams.INIT_SYNC) {
</a><a href="#h18-0-10" id="h18-0-10" class="i">+class BestFriendPinning: BridgeFileFeature(&quot;Best Friend Pinning&quot;, InternalFileHandleType.PINNED_BEST_FRIEND) {
</a>     private fun updatePinnedBestFriendStatus() {
         lines().firstOrNull()?.trim()?.let {
             context.database.updatePinnedBestFriendStatus(it.substring(0, 36), &quot;number_one_bf_for_two_months&quot;)
<b>diff --git a/<a id="h19" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/BetterLocation.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/BetterLocation.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/BetterLocation.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/BetterLocation.kt</a></b>
<a href="#h19-0" id="h19-0" class="h">@@ -25,7 +25,6 @@ import me.rhunk.snapenhance.common.util.protobuf.ProtoReader
</a> import me.rhunk.snapenhance.core.event.events.impl.AddViewEvent
 import me.rhunk.snapenhance.core.event.events.impl.UnaryCallEvent
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h19-0-3" id="h19-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.util.RandomWalking
 import me.rhunk.snapenhance.core.util.hook.HookStage
 import me.rhunk.snapenhance.core.util.hook.hook
<a href="#h19-1" id="h19-1" class="h">@@ -44,7 +43,7 @@ data class FriendLocation(
</a>     val localityPieces: List&lt;String&gt;
 )
 
<a href="#h19-1-3" id="h19-1-3" class="d">-class BetterLocation : Feature(&quot;Better Location&quot;, loadParams = FeatureLoadParams.INIT_SYNC) {
</a><a href="#h19-1-4" id="h19-1-4" class="i">+class BetterLocation : Feature(&quot;Better Location&quot;) {
</a>     private val locationHistory = mutableMapOf&lt;String, FriendLocation&gt;()
 
     private val walkRadius by lazy {
<b>diff --git a/<a id="h20" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/BetterTranscript.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/BetterTranscript.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/BetterTranscript.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/BetterTranscript.kt</a></b>
<a href="#h20-0" id="h20-0" class="h">@@ -5,7 +5,6 @@ import me.rhunk.snapenhance.common.util.TranscriptApi
</a> import me.rhunk.snapenhance.common.util.protobuf.ProtoEditor
 import me.rhunk.snapenhance.core.event.events.impl.BuildMessageEvent
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h20-0-3" id="h20-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.util.dataBuilder
 import me.rhunk.snapenhance.core.util.hook.HookStage
 import me.rhunk.snapenhance.core.util.hook.hook
<a href="#h20-1" id="h20-1" class="h">@@ -15,62 +14,65 @@ import okhttp3.RequestBody.Companion.toRequestBody
</a> import java.lang.reflect.Method
 import java.nio.ByteBuffer
 
<a href="#h20-1-3" id="h20-1-3" class="d">-class BetterTranscript: Feature(&quot;Better Transcript&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_SYNC) {
</a><a href="#h20-1-4" id="h20-1-4" class="i">+class BetterTranscript: Feature(&quot;Better Transcript&quot;) {
</a>     val transcriptApi by lazy { TranscriptApi() }
 
<a href="#h20-1-7" id="h20-1-7" class="d">-    override fun onActivityCreate() {
</a><a href="#h20-1-8" id="h20-1-8" class="i">+    override fun init() {
</a>         if (context.config.experimental.betterTranscript.globalState != true) return
<a href="#h20-1-10" id="h20-1-10" class="d">-        val config = context.config.experimental.betterTranscript
</a><a href="#h20-1-11" id="h20-1-11" class="d">-        val preferredTranscriptionLang = config.preferredTranscriptionLang.getNullable()?.takeIf {
</a><a href="#h20-1-12" id="h20-1-12" class="d">-            it.isNotBlank()
</a><a href="#h20-1-13" id="h20-1-13" class="d">-        }
</a> 
<a href="#h20-1-15" id="h20-1-15" class="d">-        if (config.forceTranscription.get()) {
</a><a href="#h20-1-16" id="h20-1-16" class="d">-            context.event.subscribe(BuildMessageEvent::class, priority = 104) { event -&gt;
</a><a href="#h20-1-17" id="h20-1-17" class="d">-                if (event.message.messageContent?.contentType != ContentType.NOTE) return@subscribe
</a><a href="#h20-1-18" id="h20-1-18" class="d">-                event.message.messageContent!!.content = ProtoEditor(event.message.messageContent!!.content!!).apply {
</a><a href="#h20-1-19" id="h20-1-19" class="d">-                    edit(6, 1) {
</a><a href="#h20-1-20" id="h20-1-20" class="d">-                        if (firstOrNull(3) == null) {
</a><a href="#h20-1-21" id="h20-1-21" class="d">-                            addString(3, context.getConfigLocale())
</a><a href="#h20-1-22" id="h20-1-22" class="d">-                        }
</a><a href="#h20-1-23" id="h20-1-23" class="d">-                    }
</a><a href="#h20-1-24" id="h20-1-24" class="d">-                }.toByteArray()
</a><a href="#h20-1-25" id="h20-1-25" class="i">+        onNextActivityCreate {
</a><a href="#h20-1-26" id="h20-1-26" class="i">+            val config = context.config.experimental.betterTranscript
</a><a href="#h20-1-27" id="h20-1-27" class="i">+            val preferredTranscriptionLang = config.preferredTranscriptionLang.getNullable()?.takeIf {
</a><a href="#h20-1-28" id="h20-1-28" class="i">+                it.isNotBlank()
</a>             }
<a href="#h20-1-30" id="h20-1-30" class="d">-        }
</a> 
<a href="#h20-1-32" id="h20-1-32" class="d">-        findClass(&quot;com.snapchat.client.voiceml.IVoiceMLSDK\$CppProxy&quot;).hook(&quot;asrTranscribe&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h20-1-33" id="h20-1-33" class="d">-            if (config.enhancedTranscript.get()) {
</a><a href="#h20-1-34" id="h20-1-34" class="d">-                val buffer = param.arg&lt;ByteBuffer&gt;(2).let {
</a><a href="#h20-1-35" id="h20-1-35" class="d">-                    it.rewind()
</a><a href="#h20-1-36" id="h20-1-36" class="d">-                    ByteArray(it.remaining()).also { it1 -&gt; it.get(it1); it.rewind() }
</a><a href="#h20-1-37" id="h20-1-37" class="i">+            if (config.forceTranscription.get()) {
</a><a href="#h20-1-38" id="h20-1-38" class="i">+                context.event.subscribe(BuildMessageEvent::class, priority = 104) { event -&gt;
</a><a href="#h20-1-39" id="h20-1-39" class="i">+                    if (event.message.messageContent?.contentType != ContentType.NOTE) return@subscribe
</a><a href="#h20-1-40" id="h20-1-40" class="i">+                    event.message.messageContent!!.content = ProtoEditor(event.message.messageContent!!.content!!).apply {
</a><a href="#h20-1-41" id="h20-1-41" class="i">+                        edit(6, 1) {
</a><a href="#h20-1-42" id="h20-1-42" class="i">+                            if (firstOrNull(3) == null) {
</a><a href="#h20-1-43" id="h20-1-43" class="i">+                                addString(3, context.getConfigLocale())
</a><a href="#h20-1-44" id="h20-1-44" class="i">+                            }
</a><a href="#h20-1-45" id="h20-1-45" class="i">+                        }
</a><a href="#h20-1-46" id="h20-1-46" class="i">+                    }.toByteArray()
</a>                 }
<a href="#h20-1-48" id="h20-1-48" class="d">-                val result = runCatching {
</a><a href="#h20-1-49" id="h20-1-49" class="d">-                    transcriptApi.transcribe(
</a><a href="#h20-1-50" id="h20-1-50" class="d">-                        buffer.toRequestBody(),
</a><a href="#h20-1-51" id="h20-1-51" class="d">-                        lang = config.preferredTranscriptionLang.getNullable()?.takeIf {
</a><a href="#h20-1-52" id="h20-1-52" class="d">-                            it.isNotBlank()
</a><a href="#h20-1-53" id="h20-1-53" class="d">-                        }?.uppercase()
</a><a href="#h20-1-54" id="h20-1-54" class="d">-                    )
</a><a href="#h20-1-55" id="h20-1-55" class="d">-                }.onFailure {
</a><a href="#h20-1-56" id="h20-1-56" class="d">-                    context.log.error(&quot;Failed to transcribe audio&quot;, it)
</a><a href="#h20-1-57" id="h20-1-57" class="d">-                    context.shortToast(&quot;Failed to transcribe audio! Check logcat for more details.&quot;)
</a><a href="#h20-1-58" id="h20-1-58" class="d">-                }.getOrNull()
</a><a href="#h20-1-59" id="h20-1-59" class="i">+            }
</a> 
<a href="#h20-1-61" id="h20-1-61" class="d">-                param.setResult(
</a><a href="#h20-1-62" id="h20-1-62" class="d">-                    (param.method() as Method).returnType.dataBuilder {
</a><a href="#h20-1-63" id="h20-1-63" class="d">-                        set(&quot;mError&quot;, result == null)
</a><a href="#h20-1-64" id="h20-1-64" class="d">-                        set(&quot;mNlpResponses&quot;, ArrayList&lt;Any&gt;())
</a><a href="#h20-1-65" id="h20-1-65" class="d">-                        set(&quot;mWordInfo&quot;, ArrayList&lt;Any&gt;())
</a><a href="#h20-1-66" id="h20-1-66" class="d">-                        set(&quot;mTranscription&quot;, result)
</a><a href="#h20-1-67" id="h20-1-67" class="i">+            findClass(&quot;com.snapchat.client.voiceml.IVoiceMLSDK\$CppProxy&quot;).hook(&quot;asrTranscribe&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h20-1-68" id="h20-1-68" class="i">+                if (config.enhancedTranscript.get()) {
</a><a href="#h20-1-69" id="h20-1-69" class="i">+                    val buffer = param.arg&lt;ByteBuffer&gt;(2).let {
</a><a href="#h20-1-70" id="h20-1-70" class="i">+                        it.rewind()
</a><a href="#h20-1-71" id="h20-1-71" class="i">+                        ByteArray(it.remaining()).also { it1 -&gt; it.get(it1); it.rewind() }
</a><a href="#h20-1-72" id="h20-1-72" class="i">+                    }
</a><a href="#h20-1-73" id="h20-1-73" class="i">+                    val result = runCatching {
</a><a href="#h20-1-74" id="h20-1-74" class="i">+                        transcriptApi.transcribe(
</a><a href="#h20-1-75" id="h20-1-75" class="i">+                            buffer.toRequestBody(),
</a><a href="#h20-1-76" id="h20-1-76" class="i">+                            lang = config.preferredTranscriptionLang.getNullable()?.takeIf {
</a><a href="#h20-1-77" id="h20-1-77" class="i">+                                it.isNotBlank()
</a><a href="#h20-1-78" id="h20-1-78" class="i">+                            }?.uppercase()
</a><a href="#h20-1-79" id="h20-1-79" class="i">+                        )
</a><a href="#h20-1-80" id="h20-1-80" class="i">+                    }.onFailure {
</a><a href="#h20-1-81" id="h20-1-81" class="i">+                        context.log.error(&quot;Failed to transcribe audio&quot;, it)
</a><a href="#h20-1-82" id="h20-1-82" class="i">+                        context.shortToast(&quot;Failed to transcribe audio! Check logcat for more details.&quot;)
</a><a href="#h20-1-83" id="h20-1-83" class="i">+                    }.getOrNull()
</a><a href="#h20-1-84" id="h20-1-84" class="i">+
</a><a href="#h20-1-85" id="h20-1-85" class="i">+                    param.setResult(
</a><a href="#h20-1-86" id="h20-1-86" class="i">+                        (param.method() as Method).returnType.dataBuilder {
</a><a href="#h20-1-87" id="h20-1-87" class="i">+                            set(&quot;mError&quot;, result == null)
</a><a href="#h20-1-88" id="h20-1-88" class="i">+                            set(&quot;mNlpResponses&quot;, ArrayList&lt;Any&gt;())
</a><a href="#h20-1-89" id="h20-1-89" class="i">+                            set(&quot;mWordInfo&quot;, ArrayList&lt;Any&gt;())
</a><a href="#h20-1-90" id="h20-1-90" class="i">+                            set(&quot;mTranscription&quot;, result)
</a><a href="#h20-1-91" id="h20-1-91" class="i">+                        }
</a><a href="#h20-1-92" id="h20-1-92" class="i">+                    )
</a><a href="#h20-1-93" id="h20-1-93" class="i">+                    return@hook
</a><a href="#h20-1-94" id="h20-1-94" class="i">+                }
</a><a href="#h20-1-95" id="h20-1-95" class="i">+                preferredTranscriptionLang?.lowercase()?.let {
</a><a href="#h20-1-96" id="h20-1-96" class="i">+                    val asrConfig = param.arg&lt;Any&gt;(1)
</a><a href="#h20-1-97" id="h20-1-97" class="i">+                    asrConfig.getObjectFieldOrNull(&quot;mBaseConfig&quot;)?.apply {
</a><a href="#h20-1-98" id="h20-1-98" class="i">+                        setObjectField(&quot;mLanguageModel&quot;, it)
</a><a href="#h20-1-99" id="h20-1-99" class="i">+                        setObjectField(&quot;mUiLanguage&quot;, it)
</a>                     }
<a href="#h20-1-101" id="h20-1-101" class="d">-                )
</a><a href="#h20-1-102" id="h20-1-102" class="d">-                return@hook
</a><a href="#h20-1-103" id="h20-1-103" class="d">-            }
</a><a href="#h20-1-104" id="h20-1-104" class="d">-            preferredTranscriptionLang?.lowercase()?.let {
</a><a href="#h20-1-105" id="h20-1-105" class="d">-                val asrConfig = param.arg&lt;Any&gt;(1)
</a><a href="#h20-1-106" id="h20-1-106" class="d">-                asrConfig.getObjectFieldOrNull(&quot;mBaseConfig&quot;)?.apply {
</a><a href="#h20-1-107" id="h20-1-107" class="d">-                    setObjectField(&quot;mLanguageModel&quot;, it)
</a><a href="#h20-1-108" id="h20-1-108" class="d">-                    setObjectField(&quot;mUiLanguage&quot;, it)
</a>                 }
             }
         }
<b>diff --git a/<a id="h21" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/CallRecorder.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/CallRecorder.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/CallRecorder.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/CallRecorder.kt</a></b>
<a href="#h21-0" id="h21-0" class="h">@@ -8,7 +8,6 @@ import kotlinx.coroutines.withTimeoutOrNull
</a> import me.rhunk.snapenhance.common.data.download.AudioStreamFormat
 import me.rhunk.snapenhance.common.data.download.MediaDownloadSource
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h21-0-3" id="h21-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.features.impl.downloader.MediaDownloader
 import me.rhunk.snapenhance.core.util.hook.HookStage
 import me.rhunk.snapenhance.core.util.hook.hook
<a href="#h21-1" id="h21-1" class="h">@@ -23,7 +22,7 @@ import java.util.UUID
</a> import java.util.concurrent.ConcurrentHashMap
 import java.util.concurrent.CopyOnWriteArrayList
 
<a href="#h21-1-3" id="h21-1-3" class="d">-class CallRecorder : Feature(&quot;Call Recorder&quot;, loadParams = FeatureLoadParams.INIT_SYNC) {
</a><a href="#h21-1-4" id="h21-1-4" class="i">+class CallRecorder : Feature(&quot;Call Recorder&quot;) {
</a>     private val httpServer = HttpServer(
         timeout = Integer.MAX_VALUE
     )
<b>diff --git a/<a id="h22" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/ComposerHooks.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/ComposerHooks.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/ComposerHooks.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/ComposerHooks.kt</a></b>
<a href="#h22-0" id="h22-0" class="h">@@ -25,7 +25,6 @@ import me.rhunk.snapenhance.common.ui.AppMaterialTheme
</a> import me.rhunk.snapenhance.common.ui.createComposeAlertDialog
 import me.rhunk.snapenhance.common.ui.createComposeView
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h22-0-3" id="h22-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.features.impl.downloader.MediaDownloader
 import me.rhunk.snapenhance.core.util.hook.HookStage
 import me.rhunk.snapenhance.core.util.hook.Hooker
<a href="#h22-1" id="h22-1" class="h">@@ -36,7 +35,7 @@ import java.lang.reflect.Proxy
</a> import kotlin.math.absoluteValue
 import kotlin.random.Random
 
<a href="#h22-1-3" id="h22-1-3" class="d">-class ComposerHooks: Feature(&quot;ComposerHooks&quot;, loadParams = FeatureLoadParams.INIT_SYNC) {
</a><a href="#h22-1-4" id="h22-1-4" class="i">+class ComposerHooks: Feature(&quot;ComposerHooks&quot;) {
</a>     private val config by lazy { context.config.experimental.nativeHooks.composerHooks }
     private val getImportsFunctionName = Random.nextLong().absoluteValue.toString(16)
 
<b>diff --git a/<a id="h23" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/ContextMenuFix.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/ContextMenuFix.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/ContextMenuFix.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/ContextMenuFix.kt</a></b>
<a href="#h23-0" id="h23-0" class="h">@@ -2,10 +2,9 @@ package me.rhunk.snapenhance.core.features.impl.experiments
</a> 
 import me.rhunk.snapenhance.core.event.events.impl.UnaryCallEvent
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h23-0-3" id="h23-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import java.nio.ByteBuffer
 
<a href="#h23-0-6" id="h23-0-6" class="d">-class ContextMenuFix: Feature(&quot;Context Menu Fix&quot;, loadParams = FeatureLoadParams.INIT_SYNC) {
</a><a href="#h23-0-7" id="h23-0-7" class="i">+class ContextMenuFix: Feature(&quot;Context Menu Fix&quot;) {
</a>     override fun init() {
         if (!context.config.experimental.contextMenuFix.get()) return
         context.event.subscribe(UnaryCallEvent::class) { event -&gt;
<b>diff --git a/<a id="h24" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/ConvertMessageLocally.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/ConvertMessageLocally.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/ConvertMessageLocally.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/ConvertMessageLocally.kt</a></b>
<a href="#h24-0" id="h24-0" class="h">@@ -5,13 +5,12 @@ import me.rhunk.snapenhance.common.util.protobuf.ProtoReader
</a> import me.rhunk.snapenhance.common.util.protobuf.ProtoWriter
 import me.rhunk.snapenhance.core.event.events.impl.BuildMessageEvent
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h24-0-3" id="h24-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.features.impl.messaging.Messaging
 import me.rhunk.snapenhance.core.ui.ViewAppearanceHelper
 import me.rhunk.snapenhance.core.wrapper.impl.Message
 import me.rhunk.snapenhance.core.wrapper.impl.MessageContent
 
<a href="#h24-0-9" id="h24-0-9" class="d">-class ConvertMessageLocally : Feature(&quot;Convert Message Edit&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_SYNC) {
</a><a href="#h24-0-10" id="h24-0-10" class="i">+class ConvertMessageLocally : Feature(&quot;Convert Message Edit&quot;) {
</a>     private val messageCache = mutableMapOf&lt;Long, MessageContent&gt;()
 
     private fun dispatchMessageEdit(message: Message, restore: Boolean = false) {
<a href="#h24-1" id="h24-1" class="h">@@ -64,11 +63,13 @@ class ConvertMessageLocally : Feature(&quot;Convert Message Edit&quot;, loadParams = Featu
</a>         }.show()
     }
 
<a href="#h24-1-3" id="h24-1-3" class="d">-    override fun onActivityCreate() {
</a><a href="#h24-1-4" id="h24-1-4" class="d">-        context.event.subscribe(BuildMessageEvent::class, priority = 2) {
</a><a href="#h24-1-5" id="h24-1-5" class="d">-            val clientMessageId = it.message.messageDescriptor?.messageId ?: return@subscribe
</a><a href="#h24-1-6" id="h24-1-6" class="d">-            if (!messageCache.containsKey(clientMessageId)) return@subscribe
</a><a href="#h24-1-7" id="h24-1-7" class="d">-            it.message.messageContent = messageCache[clientMessageId]
</a><a href="#h24-1-8" id="h24-1-8" class="i">+    override fun init() {
</a><a href="#h24-1-9" id="h24-1-9" class="i">+        onNextActivityCreate {
</a><a href="#h24-1-10" id="h24-1-10" class="i">+            context.event.subscribe(BuildMessageEvent::class, priority = 2) {
</a><a href="#h24-1-11" id="h24-1-11" class="i">+                val clientMessageId = it.message.messageDescriptor?.messageId ?: return@subscribe
</a><a href="#h24-1-12" id="h24-1-12" class="i">+                if (!messageCache.containsKey(clientMessageId)) return@subscribe
</a><a href="#h24-1-13" id="h24-1-13" class="i">+                it.message.messageContent = messageCache[clientMessageId]
</a><a href="#h24-1-14" id="h24-1-14" class="i">+            }
</a>         }
     }
 } 
\ No newline at end of file
<b>diff --git a/<a id="h25" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/DeviceSpooferHook.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/DeviceSpooferHook.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/DeviceSpooferHook.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/DeviceSpooferHook.kt</a></b>
<a href="#h25-0" id="h25-0" class="h">@@ -7,12 +7,11 @@ import android.net.Network
</a> import android.net.NetworkCapabilities
 import android.os.Build
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h25-0-3" id="h25-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.util.LSPatchUpdater
 import me.rhunk.snapenhance.core.util.hook.HookStage
 import me.rhunk.snapenhance.core.util.hook.hook
 
<a href="#h25-0-8" id="h25-0-8" class="d">-class DeviceSpooferHook: Feature(&quot;device_spoofer&quot;, loadParams = FeatureLoadParams.INIT_SYNC)  {
</a><a href="#h25-0-9" id="h25-0-9" class="i">+class DeviceSpooferHook: Feature(&quot;device_spoofer&quot;)  {
</a> 	private fun hookInstallerPackageName() {
 		context.androidContext.packageManager::class.java.hook(&quot;getInstallerPackageName&quot;, HookStage.BEFORE) { param -&gt;
 			param.setResult(&quot;com.android.vending&quot;)
<b>diff --git a/<a id="h26" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/EndToEndEncryption.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/EndToEndEncryption.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/EndToEndEncryption.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/EndToEndEncryption.kt</a></b>
<a href="#h26-0" id="h26-0" class="h">@@ -33,7 +33,6 @@ import me.rhunk.snapenhance.core.event.events.impl.BindViewEvent
</a> import me.rhunk.snapenhance.core.event.events.impl.BuildMessageEvent
 import me.rhunk.snapenhance.core.event.events.impl.NativeUnaryCallEvent
 import me.rhunk.snapenhance.core.event.events.impl.SendMessageWithContentEvent
<a href="#h26-0-3" id="h26-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.features.MessagingRuleFeature
 import me.rhunk.snapenhance.core.features.impl.ui.ConversationToolbox
 import me.rhunk.snapenhance.core.ui.ViewAppearanceHelper
<a href="#h26-1" id="h26-1" class="h">@@ -55,8 +54,7 @@ import kotlin.random.Random
</a> 
 class EndToEndEncryption : MessagingRuleFeature(
     &quot;EndToEndEncryption&quot;,
<a href="#h26-1-3" id="h26-1-3" class="d">-    MessagingRuleType.E2E_ENCRYPTION,
</a><a href="#h26-1-4" id="h26-1-4" class="d">-    loadParams = FeatureLoadParams.ACTIVITY_CREATE_SYNC or FeatureLoadParams.INIT_SYNC or FeatureLoadParams.INIT_ASYNC
</a><a href="#h26-1-5" id="h26-1-5" class="i">+    MessagingRuleType.E2E_ENCRYPTION
</a> ) {
     val isEnabled get() = context.config.experimental.e2eEncryption.globalState == true
     private val e2eeInterface by lazyBridge { context.bridgeClient.getE2eeInterface() }
<a href="#h26-2" id="h26-2" class="h">@@ -174,96 +172,223 @@ class EndToEndEncryption : MessagingRuleFeature(
</a>     }
 
     @SuppressLint(&quot;SetTextI18n&quot;, &quot;DiscouragedApi&quot;)
<a href="#h26-2-3" id="h26-2-3" class="d">-    override fun onActivityCreate() {
</a><a href="#h26-2-4" id="h26-2-4" class="i">+    override fun init() {
</a>         if (!isEnabled) return
 
<a href="#h26-2-7" id="h26-2-7" class="d">-        context.feature(ConversationToolbox::class).addComposable(translation[&quot;confirmation_dialogs.title&quot;], filter = {
</a><a href="#h26-2-8" id="h26-2-8" class="d">-            context.database.getDMOtherParticipant(it) != null
</a><a href="#h26-2-9" id="h26-2-9" class="d">-        }) { dialog, conversationId -&gt;
</a><a href="#h26-2-10" id="h26-2-10" class="d">-            val friendId = remember {
</a><a href="#h26-2-11" id="h26-2-11" class="d">-                context.database.getDMOtherParticipant(conversationId)
</a><a href="#h26-2-12" id="h26-2-12" class="d">-            } ?: return@addComposable
</a><a href="#h26-2-13" id="h26-2-13" class="d">-            val fingerprint = remember {
</a><a href="#h26-2-14" id="h26-2-14" class="d">-                runCatching {
</a><a href="#h26-2-15" id="h26-2-15" class="d">-                    e2eeInterface.getSecretFingerprint(friendId)
</a><a href="#h26-2-16" id="h26-2-16" class="d">-                }.getOrNull()
</a><a href="#h26-2-17" id="h26-2-17" class="d">-            }
</a><a href="#h26-2-18" id="h26-2-18" class="d">-            if (fingerprint != null) {
</a><a href="#h26-2-19" id="h26-2-19" class="d">-                Text(translation.format(&quot;toolbox.shared_key_fingerprint&quot;, &quot;fingerprint&quot; to fingerprint))
</a><a href="#h26-2-20" id="h26-2-20" class="d">-            } else {
</a><a href="#h26-2-21" id="h26-2-21" class="d">-                Text(translation[&quot;toolbox.no_shared_key&quot;])
</a><a href="#h26-2-22" id="h26-2-22" class="d">-            }
</a><a href="#h26-2-23" id="h26-2-23" class="d">-            Spacer(modifier = Modifier.height(10.dp))
</a><a href="#h26-2-24" id="h26-2-24" class="d">-            Button(onClick = {
</a><a href="#h26-2-25" id="h26-2-25" class="d">-                dialog.dismiss()
</a><a href="#h26-2-26" id="h26-2-26" class="d">-                warnKeyOverwrite(friendId) {
</a><a href="#h26-2-27" id="h26-2-27" class="d">-                    askForKeys(conversationId)
</a><a href="#h26-2-28" id="h26-2-28" class="i">+        context.mappings.useMapper(CallbackMapper::class) {
</a><a href="#h26-2-29" id="h26-2-29" class="i">+            callbacks.getClass(&quot;ConversationManagerDelegate&quot;)?.hook(&quot;onSendComplete&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h26-2-30" id="h26-2-30" class="i">+                val sendMessageResult = param.arg&lt;Any&gt;(0)
</a><a href="#h26-2-31" id="h26-2-31" class="i">+                val messageDestinations = MessageDestinations(sendMessageResult.getObjectField(&quot;mCompletedDestinations&quot;) ?: return@hook)
</a><a href="#h26-2-32" id="h26-2-32" class="i">+                if (messageDestinations.mPhoneNumbers?.isNotEmpty() == true || messageDestinations.stories?.isNotEmpty() == true) return@hook
</a><a href="#h26-2-33" id="h26-2-33" class="i">+
</a><a href="#h26-2-34" id="h26-2-34" class="i">+                val completedConversationDestinations = sendMessageResult.getObjectField(&quot;mCompletedConversationDestinations&quot;) as? ArrayList&lt;*&gt; ?: return@hook
</a><a href="#h26-2-35" id="h26-2-35" class="i">+                val messageIds = completedConversationDestinations.filter { getState(SnapUUID(it.getObjectField(&quot;mConversationId&quot;)).toString()) }.mapNotNull {
</a><a href="#h26-2-36" id="h26-2-36" class="i">+                    it.getObjectFieldOrNull(&quot;mMessageId&quot;) as? Long
</a>                 }
<a href="#h26-2-38" id="h26-2-38" class="d">-            }) {
</a><a href="#h26-2-39" id="h26-2-39" class="d">-                Text(translation[&quot;toolbox.initiate_exchange_button&quot;])
</a><a href="#h26-2-40" id="h26-2-40" class="i">+
</a><a href="#h26-2-41" id="h26-2-41" class="i">+                encryptedMessages.addAll(messageIds)
</a>             }
         }
 
<a href="#h26-2-45" id="h26-2-45" class="d">-        val encryptedMessageIndicator by context.config.experimental.e2eEncryption.encryptedMessageIndicator
</a><a href="#h26-2-46" id="h26-2-46" class="d">-
</a><a href="#h26-2-47" id="h26-2-47" class="d">-        val specialCard = Random.nextLong().toString(16)
</a><a href="#h26-2-48" id="h26-2-48" class="i">+        context.event.subscribe(BuildMessageEvent::class, priority = 0) { event -&gt;
</a><a href="#h26-2-49" id="h26-2-49" class="i">+            val message = event.message
</a><a href="#h26-2-50" id="h26-2-50" class="i">+            val conversationId = message.messageDescriptor!!.conversationId.toString()
</a><a href="#h26-2-51" id="h26-2-51" class="i">+            val isMessageCommitted = message.messageState == MessageState.COMMITTED
</a><a href="#h26-2-52" id="h26-2-52" class="i">+            messageHook(
</a><a href="#h26-2-53" id="h26-2-53" class="i">+                conversationId = conversationId,
</a><a href="#h26-2-54" id="h26-2-54" class="i">+                messageId = message.messageDescriptor!!.messageId!!,
</a><a href="#h26-2-55" id="h26-2-55" class="i">+                senderId = message.senderId.toString(),
</a><a href="#h26-2-56" id="h26-2-56" class="i">+                messageContent = message.messageContent!!,
</a><a href="#h26-2-57" id="h26-2-57" class="i">+                committed = isMessageCommitted
</a><a href="#h26-2-58" id="h26-2-58" class="i">+            )
</a> 
<a href="#h26-2-60" id="h26-2-60" class="d">-        context.event.subscribe(BindViewEvent::class) { event -&gt;
</a><a href="#h26-2-61" id="h26-2-61" class="d">-            event.chatMessage { conversationId, messageId -&gt;
</a><a href="#h26-2-62" id="h26-2-62" class="d">-                val viewGroup = event.view.parent as? ViewGroup ?: return@subscribe
</a><a href="#h26-2-63" id="h26-2-63" class="i">+            message.messageContent!!.instanceNonNull()
</a><a href="#h26-2-64" id="h26-2-64" class="i">+                .getObjectField(&quot;mQuotedMessage&quot;)
</a><a href="#h26-2-65" id="h26-2-65" class="i">+                ?.getObjectField(&quot;mContent&quot;)
</a><a href="#h26-2-66" id="h26-2-66" class="i">+                ?.also { quotedMessage -&gt;
</a><a href="#h26-2-67" id="h26-2-67" class="i">+                    messageHook(
</a><a href="#h26-2-68" id="h26-2-68" class="i">+                        conversationId = conversationId,
</a><a href="#h26-2-69" id="h26-2-69" class="i">+                        messageId = quotedMessage.getObjectField(&quot;mMessageId&quot;)?.toString()?.toLong() ?: return@also,
</a><a href="#h26-2-70" id="h26-2-70" class="i">+                        senderId = SnapUUID(quotedMessage.getObjectField(&quot;mSenderId&quot;)).toString(),
</a><a href="#h26-2-71" id="h26-2-71" class="i">+                        messageContent = MessageContent(quotedMessage),
</a><a href="#h26-2-72" id="h26-2-72" class="i">+                        committed = isMessageCommitted
</a><a href="#h26-2-73" id="h26-2-73" class="i">+                    )
</a><a href="#h26-2-74" id="h26-2-74" class="i">+                }
</a><a href="#h26-2-75" id="h26-2-75" class="i">+        }
</a> 
<a href="#h26-2-77" id="h26-2-77" class="d">-                viewGroup.findViewWithTag&lt;View&gt;(specialCard)?.also {
</a><a href="#h26-2-78" id="h26-2-78" class="d">-                    viewGroup.removeView(it)
</a><a href="#h26-2-79" id="h26-2-79" class="i">+        onNextActivityCreate(defer = true) {
</a><a href="#h26-2-80" id="h26-2-80" class="i">+            context.feature(ConversationToolbox::class).addComposable(translation[&quot;confirmation_dialogs.title&quot;], filter = {
</a><a href="#h26-2-81" id="h26-2-81" class="i">+                context.database.getDMOtherParticipant(it) != null
</a><a href="#h26-2-82" id="h26-2-82" class="i">+            }) { dialog, conversationId -&gt;
</a><a href="#h26-2-83" id="h26-2-83" class="i">+                val friendId = remember {
</a><a href="#h26-2-84" id="h26-2-84" class="i">+                    context.database.getDMOtherParticipant(conversationId)
</a><a href="#h26-2-85" id="h26-2-85" class="i">+                } ?: return@addComposable
</a><a href="#h26-2-86" id="h26-2-86" class="i">+                val fingerprint = remember {
</a><a href="#h26-2-87" id="h26-2-87" class="i">+                    runCatching {
</a><a href="#h26-2-88" id="h26-2-88" class="i">+                        e2eeInterface.getSecretFingerprint(friendId)
</a><a href="#h26-2-89" id="h26-2-89" class="i">+                    }.getOrNull()
</a><a href="#h26-2-90" id="h26-2-90" class="i">+                }
</a><a href="#h26-2-91" id="h26-2-91" class="i">+                if (fingerprint != null) {
</a><a href="#h26-2-92" id="h26-2-92" class="i">+                    Text(translation.format(&quot;toolbox.shared_key_fingerprint&quot;, &quot;fingerprint&quot; to fingerprint))
</a><a href="#h26-2-93" id="h26-2-93" class="i">+                } else {
</a><a href="#h26-2-94" id="h26-2-94" class="i">+                    Text(translation[&quot;toolbox.no_shared_key&quot;])
</a><a href="#h26-2-95" id="h26-2-95" class="i">+                }
</a><a href="#h26-2-96" id="h26-2-96" class="i">+                Spacer(modifier = Modifier.height(10.dp))
</a><a href="#h26-2-97" id="h26-2-97" class="i">+                Button(onClick = {
</a><a href="#h26-2-98" id="h26-2-98" class="i">+                    dialog.dismiss()
</a><a href="#h26-2-99" id="h26-2-99" class="i">+                    warnKeyOverwrite(friendId) {
</a><a href="#h26-2-100" id="h26-2-100" class="i">+                        askForKeys(conversationId)
</a><a href="#h26-2-101" id="h26-2-101" class="i">+                    }
</a><a href="#h26-2-102" id="h26-2-102" class="i">+                }) {
</a><a href="#h26-2-103" id="h26-2-103" class="i">+                    Text(translation[&quot;toolbox.initiate_exchange_button&quot;])
</a>                 }
<a href="#h26-2-105" id="h26-2-105" class="i">+            }
</a> 
<a href="#h26-2-107" id="h26-2-107" class="d">-                if (encryptedMessageIndicator) {
</a><a href="#h26-2-108" id="h26-2-108" class="d">-                    viewGroup.removeForegroundDrawable(&quot;encryptedMessage&quot;)
</a><a href="#h26-2-109" id="h26-2-109" class="i">+            val encryptedMessageIndicator by context.config.experimental.e2eEncryption.encryptedMessageIndicator
</a> 
<a href="#h26-2-111" id="h26-2-111" class="d">-                    if (encryptedMessages.contains(messageId.toLong())) {
</a><a href="#h26-2-112" id="h26-2-112" class="d">-                        viewGroup.addForegroundDrawable(&quot;encryptedMessage&quot;, ShapeDrawable(object: Shape() {
</a><a href="#h26-2-113" id="h26-2-113" class="d">-                            override fun draw(canvas: Canvas, paint: Paint) {
</a><a href="#h26-2-114" id="h26-2-114" class="d">-                                paint.textSize = 20f
</a><a href="#h26-2-115" id="h26-2-115" class="d">-                                canvas.drawText(&quot;\uD83D\uDD12&quot;, 0f, canvas.height / 2f, paint)
</a><a href="#h26-2-116" id="h26-2-116" class="d">-                            }
</a><a href="#h26-2-117" id="h26-2-117" class="d">-                        }))
</a><a href="#h26-2-118" id="h26-2-118" class="i">+            val specialCard = Random.nextLong().toString(16)
</a><a href="#h26-2-119" id="h26-2-119" class="i">+
</a><a href="#h26-2-120" id="h26-2-120" class="i">+            context.event.subscribe(BindViewEvent::class) { event -&gt;
</a><a href="#h26-2-121" id="h26-2-121" class="i">+                event.chatMessage { conversationId, messageId -&gt;
</a><a href="#h26-2-122" id="h26-2-122" class="i">+                    val viewGroup = event.view.parent as? ViewGroup ?: return@subscribe
</a><a href="#h26-2-123" id="h26-2-123" class="i">+
</a><a href="#h26-2-124" id="h26-2-124" class="i">+                    viewGroup.findViewWithTag&lt;View&gt;(specialCard)?.also {
</a><a href="#h26-2-125" id="h26-2-125" class="i">+                        viewGroup.removeView(it)
</a>                     }
<a href="#h26-2-127" id="h26-2-127" class="d">-                }
</a> 
<a href="#h26-2-129" id="h26-2-129" class="d">-                val secret = secretResponses[messageId.toLong()]
</a><a href="#h26-2-130" id="h26-2-130" class="d">-                val publicKey = pkRequests[messageId.toLong()]
</a><a href="#h26-2-131" id="h26-2-131" class="i">+                    if (encryptedMessageIndicator) {
</a><a href="#h26-2-132" id="h26-2-132" class="i">+                        viewGroup.removeForegroundDrawable(&quot;encryptedMessage&quot;)
</a> 
<a href="#h26-2-134" id="h26-2-134" class="d">-                if (publicKey != null || secret != null) {
</a><a href="#h26-2-135" id="h26-2-135" class="d">-                    viewGroup.addView(createComposeView(context.mainActivity!!) {
</a><a href="#h26-2-136" id="h26-2-136" class="d">-                        Card(
</a><a href="#h26-2-137" id="h26-2-137" class="d">-                            modifier = Modifier.fillMaxWidth().padding(8.dp),
</a><a href="#h26-2-138" id="h26-2-138" class="d">-                            onClick = {
</a><a href="#h26-2-139" id="h26-2-139" class="d">-                                if (publicKey != null) {
</a><a href="#h26-2-140" id="h26-2-140" class="d">-                                    handlePublicKeyRequest(conversationId, publicKey)
</a><a href="#h26-2-141" id="h26-2-141" class="i">+                        if (encryptedMessages.contains(messageId.toLong())) {
</a><a href="#h26-2-142" id="h26-2-142" class="i">+                            viewGroup.addForegroundDrawable(&quot;encryptedMessage&quot;, ShapeDrawable(object: Shape() {
</a><a href="#h26-2-143" id="h26-2-143" class="i">+                                override fun draw(canvas: Canvas, paint: Paint) {
</a><a href="#h26-2-144" id="h26-2-144" class="i">+                                    paint.textSize = 20f
</a><a href="#h26-2-145" id="h26-2-145" class="i">+                                    canvas.drawText(&quot;\uD83D\uDD12&quot;, 0f, canvas.height / 2f, paint)
</a>                                 }
<a href="#h26-2-147" id="h26-2-147" class="d">-                                if (secret != null) {
</a><a href="#h26-2-148" id="h26-2-148" class="d">-                                    handleSecretResponse(conversationId, secret)
</a><a href="#h26-2-149" id="h26-2-149" class="i">+                            }))
</a><a href="#h26-2-150" id="h26-2-150" class="i">+                        }
</a><a href="#h26-2-151" id="h26-2-151" class="i">+                    }
</a><a href="#h26-2-152" id="h26-2-152" class="i">+
</a><a href="#h26-2-153" id="h26-2-153" class="i">+                    val secret = secretResponses[messageId.toLong()]
</a><a href="#h26-2-154" id="h26-2-154" class="i">+                    val publicKey = pkRequests[messageId.toLong()]
</a><a href="#h26-2-155" id="h26-2-155" class="i">+
</a><a href="#h26-2-156" id="h26-2-156" class="i">+                    if (publicKey != null || secret != null) {
</a><a href="#h26-2-157" id="h26-2-157" class="i">+                        viewGroup.addView(createComposeView(context.mainActivity!!) {
</a><a href="#h26-2-158" id="h26-2-158" class="i">+                            Card(
</a><a href="#h26-2-159" id="h26-2-159" class="i">+                                modifier = Modifier.fillMaxWidth().padding(8.dp),
</a><a href="#h26-2-160" id="h26-2-160" class="i">+                                onClick = {
</a><a href="#h26-2-161" id="h26-2-161" class="i">+                                    if (publicKey != null) {
</a><a href="#h26-2-162" id="h26-2-162" class="i">+                                        handlePublicKeyRequest(conversationId, publicKey)
</a><a href="#h26-2-163" id="h26-2-163" class="i">+                                    }
</a><a href="#h26-2-164" id="h26-2-164" class="i">+                                    if (secret != null) {
</a><a href="#h26-2-165" id="h26-2-165" class="i">+                                        handleSecretResponse(conversationId, secret)
</a><a href="#h26-2-166" id="h26-2-166" class="i">+                                    }
</a>                                 }
<a href="#h26-2-168" id="h26-2-168" class="d">-                            }
</a><a href="#h26-2-169" id="h26-2-169" class="d">-                        ) {
</a><a href="#h26-2-170" id="h26-2-170" class="d">-                            Box(
</a><a href="#h26-2-171" id="h26-2-171" class="d">-                                modifier = Modifier.fillMaxWidth().padding(5.dp),
</a><a href="#h26-2-172" id="h26-2-172" class="d">-                                contentAlignment = Alignment.Center
</a>                             ) {
<a href="#h26-2-174" id="h26-2-174" class="d">-                                if (publicKey != null) {
</a><a href="#h26-2-175" id="h26-2-175" class="d">-                                    Text(translation[&quot;accept_public_key_button&quot;])
</a><a href="#h26-2-176" id="h26-2-176" class="d">-                                }
</a><a href="#h26-2-177" id="h26-2-177" class="d">-                                if (secret != null) {
</a><a href="#h26-2-178" id="h26-2-178" class="d">-                                    Text(translation[&quot;accept_secret_button&quot;])
</a><a href="#h26-2-179" id="h26-2-179" class="i">+                                Box(
</a><a href="#h26-2-180" id="h26-2-180" class="i">+                                    modifier = Modifier.fillMaxWidth().padding(5.dp),
</a><a href="#h26-2-181" id="h26-2-181" class="i">+                                    contentAlignment = Alignment.Center
</a><a href="#h26-2-182" id="h26-2-182" class="i">+                                ) {
</a><a href="#h26-2-183" id="h26-2-183" class="i">+                                    if (publicKey != null) {
</a><a href="#h26-2-184" id="h26-2-184" class="i">+                                        Text(translation[&quot;accept_public_key_button&quot;])
</a><a href="#h26-2-185" id="h26-2-185" class="i">+                                    }
</a><a href="#h26-2-186" id="h26-2-186" class="i">+                                    if (secret != null) {
</a><a href="#h26-2-187" id="h26-2-187" class="i">+                                        Text(translation[&quot;accept_secret_button&quot;])
</a><a href="#h26-2-188" id="h26-2-188" class="i">+                                    }
</a>                                 }
                             }
<a href="#h26-2-191" id="h26-2-191" class="i">+                        }.apply {
</a><a href="#h26-2-192" id="h26-2-192" class="i">+                            tag = specialCard
</a><a href="#h26-2-193" id="h26-2-193" class="i">+                            layoutParams = ViewGroup.LayoutParams(
</a><a href="#h26-2-194" id="h26-2-194" class="i">+                                ViewGroup.LayoutParams.MATCH_PARENT,
</a><a href="#h26-2-195" id="h26-2-195" class="i">+                                ViewGroup.LayoutParams.WRAP_CONTENT,
</a><a href="#h26-2-196" id="h26-2-196" class="i">+                            )
</a><a href="#h26-2-197" id="h26-2-197" class="i">+                        })
</a><a href="#h26-2-198" id="h26-2-198" class="i">+                    }
</a><a href="#h26-2-199" id="h26-2-199" class="i">+                }
</a><a href="#h26-2-200" id="h26-2-200" class="i">+            }
</a><a href="#h26-2-201" id="h26-2-201" class="i">+        }
</a><a href="#h26-2-202" id="h26-2-202" class="i">+
</a><a href="#h26-2-203" id="h26-2-203" class="i">+        defer {
</a><a href="#h26-2-204" id="h26-2-204" class="i">+            val forceMessageEncryption by context.config.experimental.e2eEncryption.forceMessageEncryption
</a><a href="#h26-2-205" id="h26-2-205" class="i">+
</a><a href="#h26-2-206" id="h26-2-206" class="i">+            context.mappings.useMapper(CallbackMapper::class) {
</a><a href="#h26-2-207" id="h26-2-207" class="i">+                callbacks.getClass(&quot;UploadDelegate&quot;)?.hook(&quot;uploadMedia&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h26-2-208" id="h26-2-208" class="i">+                    val messageDestinations = MessageDestinations(param.arg(1))
</a><a href="#h26-2-209" id="h26-2-209" class="i">+                    val uploadCallback = param.arg&lt;Any&gt;(2)
</a><a href="#h26-2-210" id="h26-2-210" class="i">+                    val e2eeConversations = messageDestinations.getEndToEndConversations()
</a><a href="#h26-2-211" id="h26-2-211" class="i">+                    if (e2eeConversations.isEmpty()) return@hook
</a><a href="#h26-2-212" id="h26-2-212" class="i">+
</a><a href="#h26-2-213" id="h26-2-213" class="i">+                    if (messageDestinations.conversations!!.size != e2eeConversations.size || messageDestinations.stories?.isNotEmpty() == true) {
</a><a href="#h26-2-214" id="h26-2-214" class="i">+                        context.log.debug(&quot;skipping encryption&quot;)
</a><a href="#h26-2-215" id="h26-2-215" class="i">+                        return@hook
</a><a href="#h26-2-216" id="h26-2-216" class="i">+                    }
</a><a href="#h26-2-217" id="h26-2-217" class="i">+
</a><a href="#h26-2-218" id="h26-2-218" class="i">+                    Hooker.hookObjectMethod(uploadCallback::class.java, uploadCallback, &quot;onUploadFinished&quot;, HookStage.BEFORE) { methodParam -&gt;
</a><a href="#h26-2-219" id="h26-2-219" class="i">+                        val messageContent = MessageContent(methodParam.arg(1))
</a><a href="#h26-2-220" id="h26-2-220" class="i">+                        runCatching {
</a><a href="#h26-2-221" id="h26-2-221" class="i">+                            messageContent.content = ProtoWriter().apply {
</a><a href="#h26-2-222" id="h26-2-222" class="i">+                                writeEncryptedMessage(e2eeConversations.map { getE2EParticipants(it) }.flatten().distinct(), messageContent.content!!)
</a><a href="#h26-2-223" id="h26-2-223" class="i">+                            }.toByteArray()
</a><a href="#h26-2-224" id="h26-2-224" class="i">+                        }.onFailure {
</a><a href="#h26-2-225" id="h26-2-225" class="i">+                            context.log.error(&quot;Failed to encrypt message&quot;, it)
</a><a href="#h26-2-226" id="h26-2-226" class="i">+                            context.longToast(translation[&quot;encryption_failed_toast&quot;])
</a><a href="#h26-2-227" id="h26-2-227" class="i">+                        }
</a><a href="#h26-2-228" id="h26-2-228" class="i">+                    }
</a><a href="#h26-2-229" id="h26-2-229" class="i">+                }
</a><a href="#h26-2-230" id="h26-2-230" class="i">+            }
</a><a href="#h26-2-231" id="h26-2-231" class="i">+
</a><a href="#h26-2-232" id="h26-2-232" class="i">+            // trick to disable fidelius encryption
</a><a href="#h26-2-233" id="h26-2-233" class="i">+            context.event.subscribe(SendMessageWithContentEvent::class) { event -&gt;
</a><a href="#h26-2-234" id="h26-2-234" class="i">+                val messageContent = event.messageContent
</a><a href="#h26-2-235" id="h26-2-235" class="i">+                val destinations = event.destinations
</a><a href="#h26-2-236" id="h26-2-236" class="i">+
</a><a href="#h26-2-237" id="h26-2-237" class="i">+                val e2eeConversations = destinations.getEndToEndConversations().takeIf { it.isNotEmpty() } ?: return@subscribe
</a><a href="#h26-2-238" id="h26-2-238" class="i">+
</a><a href="#h26-2-239" id="h26-2-239" class="i">+                if (e2eeConversations.size != destinations.conversations!!.size || destinations.stories?.isNotEmpty() == true) {
</a><a href="#h26-2-240" id="h26-2-240" class="i">+                    if (!forceMessageEncryption) return@subscribe
</a><a href="#h26-2-241" id="h26-2-241" class="i">+                    context.longToast(translation[&quot;unencrypted_conversation_send_failure_toast&quot;])
</a><a href="#h26-2-242" id="h26-2-242" class="i">+                    event.canceled = true
</a><a href="#h26-2-243" id="h26-2-243" class="i">+                    return@subscribe
</a><a href="#h26-2-244" id="h26-2-244" class="i">+                }
</a><a href="#h26-2-245" id="h26-2-245" class="i">+
</a><a href="#h26-2-246" id="h26-2-246" class="i">+                if (!NativeLib.initialized) {
</a><a href="#h26-2-247" id="h26-2-247" class="i">+                    context.longToast(translation[&quot;native_hooks_send_failure_toast&quot;])
</a><a href="#h26-2-248" id="h26-2-248" class="i">+                    event.canceled = true
</a><a href="#h26-2-249" id="h26-2-249" class="i">+                    return@subscribe
</a><a href="#h26-2-250" id="h26-2-250" class="i">+                }
</a><a href="#h26-2-251" id="h26-2-251" class="i">+
</a><a href="#h26-2-252" id="h26-2-252" class="i">+                event.addInvokeLater {
</a><a href="#h26-2-253" id="h26-2-253" class="i">+                    if (event.messageContent.localMediaReferences?.isEmpty() == true) {
</a><a href="#h26-2-254" id="h26-2-254" class="i">+                        runCatching {
</a><a href="#h26-2-255" id="h26-2-255" class="i">+                            event.messageContent.content = ProtoWriter().apply {
</a><a href="#h26-2-256" id="h26-2-256" class="i">+                                writeEncryptedMessage(e2eeConversations.map { getE2EParticipants(it) }.flatten().distinct(), messageContent.content!!)
</a><a href="#h26-2-257" id="h26-2-257" class="i">+                            }.toByteArray()
</a><a href="#h26-2-258" id="h26-2-258" class="i">+                        }.onFailure {
</a><a href="#h26-2-259" id="h26-2-259" class="i">+                            context.log.error(&quot;Failed to encrypt message&quot;, it)
</a><a href="#h26-2-260" id="h26-2-260" class="i">+                            context.longToast(translation[&quot;encryption_failed_toast&quot;])
</a>                         }
<a href="#h26-2-262" id="h26-2-262" class="d">-                    }.apply {
</a><a href="#h26-2-263" id="h26-2-263" class="d">-                        tag = specialCard
</a><a href="#h26-2-264" id="h26-2-264" class="d">-                        layoutParams = ViewGroup.LayoutParams(
</a><a href="#h26-2-265" id="h26-2-265" class="d">-                            ViewGroup.LayoutParams.MATCH_PARENT,
</a><a href="#h26-2-266" id="h26-2-266" class="d">-                            ViewGroup.LayoutParams.WRAP_CONTENT,
</a><a href="#h26-2-267" id="h26-2-267" class="d">-                        )
</a><a href="#h26-2-268" id="h26-2-268" class="d">-                    })
</a><a href="#h26-2-269" id="h26-2-269" class="i">+                    }
</a><a href="#h26-2-270" id="h26-2-270" class="i">+
</a><a href="#h26-2-271" id="h26-2-271" class="i">+                    if (event.messageContent.contentType == ContentType.SNAP) {
</a><a href="#h26-2-272" id="h26-2-272" class="i">+                        event.messageContent.contentType = ContentType.EXTERNAL_MEDIA
</a><a href="#h26-2-273" id="h26-2-273" class="i">+                    }
</a><a href="#h26-2-274" id="h26-2-274" class="i">+                }
</a><a href="#h26-2-275" id="h26-2-275" class="i">+            }
</a><a href="#h26-2-276" id="h26-2-276" class="i">+
</a><a href="#h26-2-277" id="h26-2-277" class="i">+            context.event.subscribe(NativeUnaryCallEvent::class) { event -&gt;
</a><a href="#h26-2-278" id="h26-2-278" class="i">+                if (event.uri != &quot;/messagingcoreservice.MessagingCoreService/CreateContentMessage&quot;) return@subscribe
</a><a href="#h26-2-279" id="h26-2-279" class="i">+                val protoReader = ProtoReader(event.buffer)
</a><a href="#h26-2-280" id="h26-2-280" class="i">+                val messageReader = protoReader.followPath(4) ?: return@subscribe
</a><a href="#h26-2-281" id="h26-2-281" class="i">+
</a><a href="#h26-2-282" id="h26-2-282" class="i">+                if (messageReader.getVarInt(4, 2, 1, 5) == 1L) {
</a><a href="#h26-2-283" id="h26-2-283" class="i">+                    event.buffer = ProtoEditor(event.buffer).apply {
</a><a href="#h26-2-284" id="h26-2-284" class="i">+                        edit(4) {
</a><a href="#h26-2-285" id="h26-2-285" class="i">+                            remove(2)
</a><a href="#h26-2-286" id="h26-2-286" class="i">+                            addVarInt(2, ContentType.SNAP.id)
</a><a href="#h26-2-287" id="h26-2-287" class="i">+                            context.log.verbose(&quot;fixed snap content type&quot;)
</a><a href="#h26-2-288" id="h26-2-288" class="i">+                        }
</a><a href="#h26-2-289" id="h26-2-289" class="i">+                    }.toByteArray()
</a>                 }
             }
         }
<a href="#h26-3" id="h26-3" class="h">@@ -440,135 +565,5 @@ class EndToEndEncryption : MessagingRuleFeature(
</a>         return conversations!!.filter { getState(it.toString()) &amp;&amp; getE2EParticipants(it.toString()).isNotEmpty() }.map { it.toString() }
     }
 
<a href="#h26-3-3" id="h26-3-3" class="d">-    override fun asyncInit() {
</a><a href="#h26-3-4" id="h26-3-4" class="d">-        if (!isEnabled) return
</a><a href="#h26-3-5" id="h26-3-5" class="d">-        val forceMessageEncryption by context.config.experimental.e2eEncryption.forceMessageEncryption
</a><a href="#h26-3-6" id="h26-3-6" class="d">-
</a><a href="#h26-3-7" id="h26-3-7" class="d">-        context.mappings.useMapper(CallbackMapper::class) {
</a><a href="#h26-3-8" id="h26-3-8" class="d">-            callbacks.getClass(&quot;UploadDelegate&quot;)?.hook(&quot;uploadMedia&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h26-3-9" id="h26-3-9" class="d">-                val messageDestinations = MessageDestinations(param.arg(1))
</a><a href="#h26-3-10" id="h26-3-10" class="d">-                val uploadCallback = param.arg&lt;Any&gt;(2)
</a><a href="#h26-3-11" id="h26-3-11" class="d">-                val e2eeConversations = messageDestinations.getEndToEndConversations()
</a><a href="#h26-3-12" id="h26-3-12" class="d">-                if (e2eeConversations.isEmpty()) return@hook
</a><a href="#h26-3-13" id="h26-3-13" class="d">-
</a><a href="#h26-3-14" id="h26-3-14" class="d">-                if (messageDestinations.conversations!!.size != e2eeConversations.size || messageDestinations.stories?.isNotEmpty() == true) {
</a><a href="#h26-3-15" id="h26-3-15" class="d">-                    context.log.debug(&quot;skipping encryption&quot;)
</a><a href="#h26-3-16" id="h26-3-16" class="d">-                    return@hook
</a><a href="#h26-3-17" id="h26-3-17" class="d">-                }
</a><a href="#h26-3-18" id="h26-3-18" class="d">-
</a><a href="#h26-3-19" id="h26-3-19" class="d">-                Hooker.hookObjectMethod(uploadCallback::class.java, uploadCallback, &quot;onUploadFinished&quot;, HookStage.BEFORE) { methodParam -&gt;
</a><a href="#h26-3-20" id="h26-3-20" class="d">-                    val messageContent = MessageContent(methodParam.arg(1))
</a><a href="#h26-3-21" id="h26-3-21" class="d">-                    runCatching {
</a><a href="#h26-3-22" id="h26-3-22" class="d">-                        messageContent.content = ProtoWriter().apply {
</a><a href="#h26-3-23" id="h26-3-23" class="d">-                            writeEncryptedMessage(e2eeConversations.map { getE2EParticipants(it) }.flatten().distinct(), messageContent.content!!)
</a><a href="#h26-3-24" id="h26-3-24" class="d">-                        }.toByteArray()
</a><a href="#h26-3-25" id="h26-3-25" class="d">-                    }.onFailure {
</a><a href="#h26-3-26" id="h26-3-26" class="d">-                        context.log.error(&quot;Failed to encrypt message&quot;, it)
</a><a href="#h26-3-27" id="h26-3-27" class="d">-                        context.longToast(translation[&quot;encryption_failed_toast&quot;])
</a><a href="#h26-3-28" id="h26-3-28" class="d">-                    }
</a><a href="#h26-3-29" id="h26-3-29" class="d">-                }
</a><a href="#h26-3-30" id="h26-3-30" class="d">-            }
</a><a href="#h26-3-31" id="h26-3-31" class="d">-        }
</a><a href="#h26-3-32" id="h26-3-32" class="d">-
</a><a href="#h26-3-33" id="h26-3-33" class="d">-        // trick to disable fidelius encryption
</a><a href="#h26-3-34" id="h26-3-34" class="d">-        context.event.subscribe(SendMessageWithContentEvent::class) { event -&gt;
</a><a href="#h26-3-35" id="h26-3-35" class="d">-            val messageContent = event.messageContent
</a><a href="#h26-3-36" id="h26-3-36" class="d">-            val destinations = event.destinations
</a><a href="#h26-3-37" id="h26-3-37" class="d">-
</a><a href="#h26-3-38" id="h26-3-38" class="d">-            val e2eeConversations = destinations.getEndToEndConversations().takeIf { it.isNotEmpty() } ?: return@subscribe
</a><a href="#h26-3-39" id="h26-3-39" class="d">-
</a><a href="#h26-3-40" id="h26-3-40" class="d">-            if (e2eeConversations.size != destinations.conversations!!.size || destinations.stories?.isNotEmpty() == true) {
</a><a href="#h26-3-41" id="h26-3-41" class="d">-                if (!forceMessageEncryption) return@subscribe
</a><a href="#h26-3-42" id="h26-3-42" class="d">-                context.longToast(translation[&quot;unencrypted_conversation_send_failure_toast&quot;])
</a><a href="#h26-3-43" id="h26-3-43" class="d">-                event.canceled = true
</a><a href="#h26-3-44" id="h26-3-44" class="d">-                return@subscribe
</a><a href="#h26-3-45" id="h26-3-45" class="d">-            }
</a><a href="#h26-3-46" id="h26-3-46" class="d">-
</a><a href="#h26-3-47" id="h26-3-47" class="d">-            if (!NativeLib.initialized) {
</a><a href="#h26-3-48" id="h26-3-48" class="d">-                context.longToast(translation[&quot;native_hooks_send_failure_toast&quot;])
</a><a href="#h26-3-49" id="h26-3-49" class="d">-                event.canceled = true
</a><a href="#h26-3-50" id="h26-3-50" class="d">-                return@subscribe
</a><a href="#h26-3-51" id="h26-3-51" class="d">-            }
</a><a href="#h26-3-52" id="h26-3-52" class="d">-
</a><a href="#h26-3-53" id="h26-3-53" class="d">-            event.addInvokeLater {
</a><a href="#h26-3-54" id="h26-3-54" class="d">-                if (event.messageContent.localMediaReferences?.isEmpty() == true) {
</a><a href="#h26-3-55" id="h26-3-55" class="d">-                    runCatching {
</a><a href="#h26-3-56" id="h26-3-56" class="d">-                        event.messageContent.content = ProtoWriter().apply {
</a><a href="#h26-3-57" id="h26-3-57" class="d">-                            writeEncryptedMessage(e2eeConversations.map { getE2EParticipants(it) }.flatten().distinct(), messageContent.content!!)
</a><a href="#h26-3-58" id="h26-3-58" class="d">-                        }.toByteArray()
</a><a href="#h26-3-59" id="h26-3-59" class="d">-                    }.onFailure {
</a><a href="#h26-3-60" id="h26-3-60" class="d">-                        context.log.error(&quot;Failed to encrypt message&quot;, it)
</a><a href="#h26-3-61" id="h26-3-61" class="d">-                        context.longToast(translation[&quot;encryption_failed_toast&quot;])
</a><a href="#h26-3-62" id="h26-3-62" class="d">-                    }
</a><a href="#h26-3-63" id="h26-3-63" class="d">-                }
</a><a href="#h26-3-64" id="h26-3-64" class="d">-
</a><a href="#h26-3-65" id="h26-3-65" class="d">-                if (event.messageContent.contentType == ContentType.SNAP) {
</a><a href="#h26-3-66" id="h26-3-66" class="d">-                    event.messageContent.contentType = ContentType.EXTERNAL_MEDIA
</a><a href="#h26-3-67" id="h26-3-67" class="d">-                }
</a><a href="#h26-3-68" id="h26-3-68" class="d">-            }
</a><a href="#h26-3-69" id="h26-3-69" class="d">-        }
</a><a href="#h26-3-70" id="h26-3-70" class="d">-
</a><a href="#h26-3-71" id="h26-3-71" class="d">-        context.event.subscribe(NativeUnaryCallEvent::class) { event -&gt;
</a><a href="#h26-3-72" id="h26-3-72" class="d">-            if (event.uri != &quot;/messagingcoreservice.MessagingCoreService/CreateContentMessage&quot;) return@subscribe
</a><a href="#h26-3-73" id="h26-3-73" class="d">-            val protoReader = ProtoReader(event.buffer)
</a><a href="#h26-3-74" id="h26-3-74" class="d">-            val messageReader = protoReader.followPath(4) ?: return@subscribe
</a><a href="#h26-3-75" id="h26-3-75" class="d">-
</a><a href="#h26-3-76" id="h26-3-76" class="d">-            if (messageReader.getVarInt(4, 2, 1, 5) == 1L) {
</a><a href="#h26-3-77" id="h26-3-77" class="d">-                event.buffer = ProtoEditor(event.buffer).apply {
</a><a href="#h26-3-78" id="h26-3-78" class="d">-                    edit(4) {
</a><a href="#h26-3-79" id="h26-3-79" class="d">-                        remove(2)
</a><a href="#h26-3-80" id="h26-3-80" class="d">-                        addVarInt(2, ContentType.SNAP.id)
</a><a href="#h26-3-81" id="h26-3-81" class="d">-                        context.log.verbose(&quot;fixed snap content type&quot;)
</a><a href="#h26-3-82" id="h26-3-82" class="d">-                    }
</a><a href="#h26-3-83" id="h26-3-83" class="d">-                }.toByteArray()
</a><a href="#h26-3-84" id="h26-3-84" class="d">-            }
</a><a href="#h26-3-85" id="h26-3-85" class="d">-        }
</a><a href="#h26-3-86" id="h26-3-86" class="d">-    }
</a><a href="#h26-3-87" id="h26-3-87" class="d">-
</a><a href="#h26-3-88" id="h26-3-88" class="d">-    override fun init() {
</a><a href="#h26-3-89" id="h26-3-89" class="d">-        if (!isEnabled) return
</a><a href="#h26-3-90" id="h26-3-90" class="d">-
</a><a href="#h26-3-91" id="h26-3-91" class="d">-        context.mappings.useMapper(CallbackMapper::class) {
</a><a href="#h26-3-92" id="h26-3-92" class="d">-            callbacks.getClass(&quot;ConversationManagerDelegate&quot;)?.hook(&quot;onSendComplete&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h26-3-93" id="h26-3-93" class="d">-                val sendMessageResult = param.arg&lt;Any&gt;(0)
</a><a href="#h26-3-94" id="h26-3-94" class="d">-                val messageDestinations = MessageDestinations(sendMessageResult.getObjectField(&quot;mCompletedDestinations&quot;) ?: return@hook)
</a><a href="#h26-3-95" id="h26-3-95" class="d">-                if (messageDestinations.mPhoneNumbers?.isNotEmpty() == true || messageDestinations.stories?.isNotEmpty() == true) return@hook
</a><a href="#h26-3-96" id="h26-3-96" class="d">-
</a><a href="#h26-3-97" id="h26-3-97" class="d">-                val completedConversationDestinations = sendMessageResult.getObjectField(&quot;mCompletedConversationDestinations&quot;) as? ArrayList&lt;*&gt; ?: return@hook
</a><a href="#h26-3-98" id="h26-3-98" class="d">-                val messageIds = completedConversationDestinations.filter { getState(SnapUUID(it.getObjectField(&quot;mConversationId&quot;)).toString()) }.mapNotNull {
</a><a href="#h26-3-99" id="h26-3-99" class="d">-                    it.getObjectFieldOrNull(&quot;mMessageId&quot;) as? Long
</a><a href="#h26-3-100" id="h26-3-100" class="d">-                }
</a><a href="#h26-3-101" id="h26-3-101" class="d">-
</a><a href="#h26-3-102" id="h26-3-102" class="d">-                encryptedMessages.addAll(messageIds)
</a><a href="#h26-3-103" id="h26-3-103" class="d">-            }
</a><a href="#h26-3-104" id="h26-3-104" class="d">-        }
</a><a href="#h26-3-105" id="h26-3-105" class="d">-
</a><a href="#h26-3-106" id="h26-3-106" class="d">-        context.event.subscribe(BuildMessageEvent::class, priority = 0) { event -&gt;
</a><a href="#h26-3-107" id="h26-3-107" class="d">-            val message = event.message
</a><a href="#h26-3-108" id="h26-3-108" class="d">-            val conversationId = message.messageDescriptor!!.conversationId.toString()
</a><a href="#h26-3-109" id="h26-3-109" class="d">-            val isMessageCommitted = message.messageState == MessageState.COMMITTED
</a><a href="#h26-3-110" id="h26-3-110" class="d">-            messageHook(
</a><a href="#h26-3-111" id="h26-3-111" class="d">-                conversationId = conversationId,
</a><a href="#h26-3-112" id="h26-3-112" class="d">-                messageId = message.messageDescriptor!!.messageId!!,
</a><a href="#h26-3-113" id="h26-3-113" class="d">-                senderId = message.senderId.toString(),
</a><a href="#h26-3-114" id="h26-3-114" class="d">-                messageContent = message.messageContent!!,
</a><a href="#h26-3-115" id="h26-3-115" class="d">-                committed = isMessageCommitted
</a><a href="#h26-3-116" id="h26-3-116" class="d">-            )
</a><a href="#h26-3-117" id="h26-3-117" class="d">-
</a><a href="#h26-3-118" id="h26-3-118" class="d">-            message.messageContent!!.instanceNonNull()
</a><a href="#h26-3-119" id="h26-3-119" class="d">-                .getObjectField(&quot;mQuotedMessage&quot;)
</a><a href="#h26-3-120" id="h26-3-120" class="d">-                ?.getObjectField(&quot;mContent&quot;)
</a><a href="#h26-3-121" id="h26-3-121" class="d">-                ?.also { quotedMessage -&gt;
</a><a href="#h26-3-122" id="h26-3-122" class="d">-                messageHook(
</a><a href="#h26-3-123" id="h26-3-123" class="d">-                    conversationId = conversationId,
</a><a href="#h26-3-124" id="h26-3-124" class="d">-                    messageId = quotedMessage.getObjectField(&quot;mMessageId&quot;)?.toString()?.toLong() ?: return@also,
</a><a href="#h26-3-125" id="h26-3-125" class="d">-                    senderId = SnapUUID(quotedMessage.getObjectField(&quot;mSenderId&quot;)).toString(),
</a><a href="#h26-3-126" id="h26-3-126" class="d">-                    messageContent = MessageContent(quotedMessage),
</a><a href="#h26-3-127" id="h26-3-127" class="d">-                    committed = isMessageCommitted
</a><a href="#h26-3-128" id="h26-3-128" class="d">-                )
</a><a href="#h26-3-129" id="h26-3-129" class="d">-            }
</a><a href="#h26-3-130" id="h26-3-130" class="d">-        }
</a><a href="#h26-3-131" id="h26-3-131" class="d">-    }
</a><a href="#h26-3-132" id="h26-3-132" class="d">-
</a>     override fun getRuleState() = RuleState.WHITELIST
 } 
\ No newline at end of file
<b>diff --git a/<a id="h27" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/InfiniteStoryBoost.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/InfiniteStoryBoost.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/InfiniteStoryBoost.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/InfiniteStoryBoost.kt</a></b>
<a href="#h27-0" id="h27-0" class="h">@@ -1,22 +1,23 @@
</a> package me.rhunk.snapenhance.core.features.impl.experiments
 
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h27-0-3" id="h27-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.util.hook.HookStage
 import me.rhunk.snapenhance.core.util.hook.hookConstructor
 import me.rhunk.snapenhance.mapper.impl.StoryBoostStateMapper
 
<a href="#h27-0-8" id="h27-0-8" class="d">-class InfiniteStoryBoost : Feature(&quot;InfiniteStoryBoost&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_ASYNC) {
</a><a href="#h27-0-9" id="h27-0-9" class="d">-    override fun asyncOnActivityCreate() {
</a><a href="#h27-0-10" id="h27-0-10" class="i">+class InfiniteStoryBoost : Feature(&quot;InfiniteStoryBoost&quot;) {
</a><a href="#h27-0-11" id="h27-0-11" class="i">+    override fun init() {
</a>         if (!context.config.experimental.infiniteStoryBoost.get()) return
 
<a href="#h27-0-14" id="h27-0-14" class="d">-        context.mappings.useMapper(StoryBoostStateMapper::class) {
</a><a href="#h27-0-15" id="h27-0-15" class="d">-            classReference.get()?.hookConstructor(HookStage.BEFORE) { param -&gt;
</a><a href="#h27-0-16" id="h27-0-16" class="d">-                val startTimeMillis = param.arg&lt;Long&gt;(1)
</a><a href="#h27-0-17" id="h27-0-17" class="d">-                //reset timestamp if it&#39;s more than 24 hours
</a><a href="#h27-0-18" id="h27-0-18" class="d">-                if (System.currentTimeMillis() - startTimeMillis &gt; 86400000) {
</a><a href="#h27-0-19" id="h27-0-19" class="d">-                    param.setArg(1, 0)
</a><a href="#h27-0-20" id="h27-0-20" class="d">-                    param.setArg(2, 0)
</a><a href="#h27-0-21" id="h27-0-21" class="i">+        onNextActivityCreate(defer = true) {
</a><a href="#h27-0-22" id="h27-0-22" class="i">+            context.mappings.useMapper(StoryBoostStateMapper::class) {
</a><a href="#h27-0-23" id="h27-0-23" class="i">+                classReference.get()?.hookConstructor(HookStage.BEFORE) { param -&gt;
</a><a href="#h27-0-24" id="h27-0-24" class="i">+                    val startTimeMillis = param.arg&lt;Long&gt;(1)
</a><a href="#h27-0-25" id="h27-0-25" class="i">+                    //reset timestamp if it&#39;s more than 24 hours
</a><a href="#h27-0-26" id="h27-0-26" class="i">+                    if (System.currentTimeMillis() - startTimeMillis &gt; 86400000) {
</a><a href="#h27-0-27" id="h27-0-27" class="i">+                        param.setArg(1, 0)
</a><a href="#h27-0-28" id="h27-0-28" class="i">+                        param.setArg(2, 0)
</a><a href="#h27-0-29" id="h27-0-29" class="i">+                    }
</a>                 }
             }
         }
<b>diff --git a/<a id="h28" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/MediaFilePicker.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/MediaFilePicker.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/MediaFilePicker.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/MediaFilePicker.kt</a></b>
<a href="#h28-0" id="h28-0" class="h">@@ -31,7 +31,6 @@ import me.rhunk.snapenhance.common.util.ktx.getTypeArguments
</a> import me.rhunk.snapenhance.core.event.events.impl.ActivityResultEvent
 import me.rhunk.snapenhance.core.event.events.impl.AddViewEvent
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h28-0-3" id="h28-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.ui.ViewAppearanceHelper
 import me.rhunk.snapenhance.core.util.dataBuilder
 import me.rhunk.snapenhance.core.util.hook.HookStage
<a href="#h28-1" id="h28-1" class="h">@@ -41,198 +40,200 @@ import java.io.InputStream
</a> import java.lang.reflect.Method
 import kotlin.random.Random
 
<a href="#h28-1-3" id="h28-1-3" class="d">-class MediaFilePicker : Feature(&quot;Media File Picker&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_SYNC) {
</a><a href="#h28-1-4" id="h28-1-4" class="i">+class MediaFilePicker : Feature(&quot;Media File Picker&quot;) {
</a>     var lastMediaDuration: Long? = null
         private set
 
     @SuppressLint(&quot;Recycle&quot;)
<a href="#h28-1-9" id="h28-1-9" class="d">-    override fun onActivityCreate() {
</a><a href="#h28-1-10" id="h28-1-10" class="i">+    override fun init() {
</a>         if (!context.config.experimental.mediaFilePicker.get()) return
 
<a href="#h28-1-13" id="h28-1-13" class="d">-        lateinit var chatMediaDrawerActionHandler: Any
</a><a href="#h28-1-14" id="h28-1-14" class="d">-        lateinit var sendItemsMethod: Method
</a><a href="#h28-1-15" id="h28-1-15" class="d">-
</a><a href="#h28-1-16" id="h28-1-16" class="d">-        findClass(&quot;com.snap.composer.memories.ChatMediaDrawer&quot;).genericSuperclass?.getTypeArguments()?.getOrNull(1)?.apply {
</a><a href="#h28-1-17" id="h28-1-17" class="d">-            methods.first {
</a><a href="#h28-1-18" id="h28-1-18" class="d">-                it.parameterTypes.size == 1 &amp;&amp; it.parameterTypes[0].name.endsWith(&quot;ChatMediaDrawerActionHandler&quot;)
</a><a href="#h28-1-19" id="h28-1-19" class="d">-            }.also { method -&gt;
</a><a href="#h28-1-20" id="h28-1-20" class="d">-                sendItemsMethod = method.parameterTypes[0].methods.first { it.name == &quot;sendItems&quot; }
</a><a href="#h28-1-21" id="h28-1-21" class="d">-            }.hook(HookStage.AFTER) {
</a><a href="#h28-1-22" id="h28-1-22" class="d">-                chatMediaDrawerActionHandler = it.arg(0)
</a><a href="#h28-1-23" id="h28-1-23" class="i">+        onNextActivityCreate(defer = true) {
</a><a href="#h28-1-24" id="h28-1-24" class="i">+            lateinit var chatMediaDrawerActionHandler: Any
</a><a href="#h28-1-25" id="h28-1-25" class="i">+            lateinit var sendItemsMethod: Method
</a><a href="#h28-1-26" id="h28-1-26" class="i">+
</a><a href="#h28-1-27" id="h28-1-27" class="i">+            findClass(&quot;com.snap.composer.memories.ChatMediaDrawer&quot;).genericSuperclass?.getTypeArguments()?.getOrNull(1)?.apply {
</a><a href="#h28-1-28" id="h28-1-28" class="i">+                methods.first {
</a><a href="#h28-1-29" id="h28-1-29" class="i">+                    it.parameterTypes.size == 1 &amp;&amp; it.parameterTypes[0].name.endsWith(&quot;ChatMediaDrawerActionHandler&quot;)
</a><a href="#h28-1-30" id="h28-1-30" class="i">+                }.also { method -&gt;
</a><a href="#h28-1-31" id="h28-1-31" class="i">+                    sendItemsMethod = method.parameterTypes[0].methods.first { it.name == &quot;sendItems&quot; }
</a><a href="#h28-1-32" id="h28-1-32" class="i">+                }.hook(HookStage.AFTER) {
</a><a href="#h28-1-33" id="h28-1-33" class="i">+                    chatMediaDrawerActionHandler = it.arg(0)
</a><a href="#h28-1-34" id="h28-1-34" class="i">+                }
</a>             }
<a href="#h28-1-36" id="h28-1-36" class="d">-        }
</a> 
<a href="#h28-1-38" id="h28-1-38" class="d">-        var requestCode: Int? = null
</a><a href="#h28-1-39" id="h28-1-39" class="d">-        var firstVideoId: Long? = null
</a><a href="#h28-1-40" id="h28-1-40" class="d">-        var mediaInputStream: InputStream? = null
</a><a href="#h28-1-41" id="h28-1-41" class="i">+            var requestCode: Int? = null
</a><a href="#h28-1-42" id="h28-1-42" class="i">+            var firstVideoId: Long? = null
</a><a href="#h28-1-43" id="h28-1-43" class="i">+            var mediaInputStream: InputStream? = null
</a> 
<a href="#h28-1-45" id="h28-1-45" class="d">-        ContentResolver::class.java.apply {
</a><a href="#h28-1-46" id="h28-1-46" class="d">-            hook(&quot;query&quot;, HookStage.AFTER) { param -&gt;
</a><a href="#h28-1-47" id="h28-1-47" class="d">-                val uri = param.arg&lt;Uri&gt;(0)
</a><a href="#h28-1-48" id="h28-1-48" class="d">-                if (!uri.toString().endsWith(firstVideoId.toString())) return@hook
</a><a href="#h28-1-49" id="h28-1-49" class="i">+            ContentResolver::class.java.apply {
</a><a href="#h28-1-50" id="h28-1-50" class="i">+                hook(&quot;query&quot;, HookStage.AFTER) { param -&gt;
</a><a href="#h28-1-51" id="h28-1-51" class="i">+                    val uri = param.arg&lt;Uri&gt;(0)
</a><a href="#h28-1-52" id="h28-1-52" class="i">+                    if (!uri.toString().endsWith(firstVideoId.toString())) return@hook
</a> 
<a href="#h28-1-54" id="h28-1-54" class="d">-                param.setResult(object: CursorWrapper(param.getResult() as Cursor) {
</a><a href="#h28-1-55" id="h28-1-55" class="d">-                    override fun getLong(columnIndex: Int): Long {
</a><a href="#h28-1-56" id="h28-1-56" class="d">-                        if (getColumnName(columnIndex) == &quot;duration&quot;) {
</a><a href="#h28-1-57" id="h28-1-57" class="d">-                            return lastMediaDuration ?: -1
</a><a href="#h28-1-58" id="h28-1-58" class="i">+                    param.setResult(object: CursorWrapper(param.getResult() as Cursor) {
</a><a href="#h28-1-59" id="h28-1-59" class="i">+                        override fun getLong(columnIndex: Int): Long {
</a><a href="#h28-1-60" id="h28-1-60" class="i">+                            if (getColumnName(columnIndex) == &quot;duration&quot;) {
</a><a href="#h28-1-61" id="h28-1-61" class="i">+                                return lastMediaDuration ?: -1
</a><a href="#h28-1-62" id="h28-1-62" class="i">+                            }
</a><a href="#h28-1-63" id="h28-1-63" class="i">+                            return super.getLong(columnIndex)
</a>                         }
<a href="#h28-1-65" id="h28-1-65" class="d">-                        return super.getLong(columnIndex)
</a><a href="#h28-1-66" id="h28-1-66" class="i">+                    })
</a><a href="#h28-1-67" id="h28-1-67" class="i">+                }
</a><a href="#h28-1-68" id="h28-1-68" class="i">+                hook(&quot;openInputStream&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h28-1-69" id="h28-1-69" class="i">+                    val uri = param.arg&lt;Uri&gt;(0)
</a><a href="#h28-1-70" id="h28-1-70" class="i">+                    if (uri.toString().endsWith(firstVideoId.toString())) {
</a><a href="#h28-1-71" id="h28-1-71" class="i">+                        param.setResult(mediaInputStream)
</a><a href="#h28-1-72" id="h28-1-72" class="i">+                        mediaInputStream = null
</a>                     }
<a href="#h28-1-74" id="h28-1-74" class="d">-                })
</a><a href="#h28-1-75" id="h28-1-75" class="d">-            }
</a><a href="#h28-1-76" id="h28-1-76" class="d">-            hook(&quot;openInputStream&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h28-1-77" id="h28-1-77" class="d">-                val uri = param.arg&lt;Uri&gt;(0)
</a><a href="#h28-1-78" id="h28-1-78" class="d">-                if (uri.toString().endsWith(firstVideoId.toString())) {
</a><a href="#h28-1-79" id="h28-1-79" class="d">-                    param.setResult(mediaInputStream)
</a><a href="#h28-1-80" id="h28-1-80" class="d">-                    mediaInputStream = null
</a>                 }
             }
<a href="#h28-1-83" id="h28-1-83" class="d">-        }
</a> 
<a href="#h28-1-85" id="h28-1-85" class="d">-        context.event.subscribe(ActivityResultEvent::class) { event -&gt;
</a><a href="#h28-1-86" id="h28-1-86" class="d">-            if (event.requestCode != requestCode || event.resultCode != Activity.RESULT_OK) return@subscribe
</a><a href="#h28-1-87" id="h28-1-87" class="d">-            requestCode = null
</a><a href="#h28-1-88" id="h28-1-88" class="d">-
</a><a href="#h28-1-89" id="h28-1-89" class="d">-            firstVideoId = context.androidContext.contentResolver.query(
</a><a href="#h28-1-90" id="h28-1-90" class="d">-                MediaStore.Video.Media.EXTERNAL_CONTENT_URI,
</a><a href="#h28-1-91" id="h28-1-91" class="d">-                arrayOf(MediaStore.Video.Media._ID),
</a><a href="#h28-1-92" id="h28-1-92" class="d">-                null,
</a><a href="#h28-1-93" id="h28-1-93" class="d">-                null,
</a><a href="#h28-1-94" id="h28-1-94" class="d">-                &quot;${MediaStore.Video.Media.DATE_TAKEN} DESC&quot;
</a><a href="#h28-1-95" id="h28-1-95" class="d">-            )?.use { cursor -&gt;
</a><a href="#h28-1-96" id="h28-1-96" class="d">-                if (cursor.moveToFirst()) {
</a><a href="#h28-1-97" id="h28-1-97" class="d">-                    cursor.getLongOrNull(&quot;_id&quot;)
</a><a href="#h28-1-98" id="h28-1-98" class="d">-                } else {
</a><a href="#h28-1-99" id="h28-1-99" class="d">-                    null
</a><a href="#h28-1-100" id="h28-1-100" class="i">+            context.event.subscribe(ActivityResultEvent::class) { event -&gt;
</a><a href="#h28-1-101" id="h28-1-101" class="i">+                if (event.requestCode != requestCode || event.resultCode != Activity.RESULT_OK) return@subscribe
</a><a href="#h28-1-102" id="h28-1-102" class="i">+                requestCode = null
</a><a href="#h28-1-103" id="h28-1-103" class="i">+
</a><a href="#h28-1-104" id="h28-1-104" class="i">+                firstVideoId = context.androidContext.contentResolver.query(
</a><a href="#h28-1-105" id="h28-1-105" class="i">+                    MediaStore.Video.Media.EXTERNAL_CONTENT_URI,
</a><a href="#h28-1-106" id="h28-1-106" class="i">+                    arrayOf(MediaStore.Video.Media._ID),
</a><a href="#h28-1-107" id="h28-1-107" class="i">+                    null,
</a><a href="#h28-1-108" id="h28-1-108" class="i">+                    null,
</a><a href="#h28-1-109" id="h28-1-109" class="i">+                    &quot;${MediaStore.Video.Media.DATE_TAKEN} DESC&quot;
</a><a href="#h28-1-110" id="h28-1-110" class="i">+                )?.use { cursor -&gt;
</a><a href="#h28-1-111" id="h28-1-111" class="i">+                    if (cursor.moveToFirst()) {
</a><a href="#h28-1-112" id="h28-1-112" class="i">+                        cursor.getLongOrNull(&quot;_id&quot;)
</a><a href="#h28-1-113" id="h28-1-113" class="i">+                    } else {
</a><a href="#h28-1-114" id="h28-1-114" class="i">+                        null
</a><a href="#h28-1-115" id="h28-1-115" class="i">+                    }
</a>                 }
<a href="#h28-1-117" id="h28-1-117" class="d">-            }
</a> 
<a href="#h28-1-119" id="h28-1-119" class="d">-            if (firstVideoId == null) {
</a><a href="#h28-1-120" id="h28-1-120" class="d">-                context.inAppOverlay.showStatusToast(
</a><a href="#h28-1-121" id="h28-1-121" class="d">-                    Icons.Default.Upload,
</a><a href="#h28-1-122" id="h28-1-122" class="d">-                    &quot;Must have a video in gallery to upload.&quot;
</a><a href="#h28-1-123" id="h28-1-123" class="d">-                )
</a><a href="#h28-1-124" id="h28-1-124" class="d">-                return@subscribe
</a><a href="#h28-1-125" id="h28-1-125" class="d">-            }
</a><a href="#h28-1-126" id="h28-1-126" class="i">+                if (firstVideoId == null) {
</a><a href="#h28-1-127" id="h28-1-127" class="i">+                    context.inAppOverlay.showStatusToast(
</a><a href="#h28-1-128" id="h28-1-128" class="i">+                        Icons.Default.Upload,
</a><a href="#h28-1-129" id="h28-1-129" class="i">+                        &quot;Must have a video in gallery to upload.&quot;
</a><a href="#h28-1-130" id="h28-1-130" class="i">+                    )
</a><a href="#h28-1-131" id="h28-1-131" class="i">+                    return@subscribe
</a><a href="#h28-1-132" id="h28-1-132" class="i">+                }
</a> 
<a href="#h28-1-134" id="h28-1-134" class="d">-            fun sendMedia() {
</a><a href="#h28-1-135" id="h28-1-135" class="d">-                sendItemsMethod.invoke(chatMediaDrawerActionHandler, listOf&lt;Any&gt;(), listOf(
</a><a href="#h28-1-136" id="h28-1-136" class="d">-                    sendItemsMethod.genericParameterTypes[1].getTypeArguments().first().dataBuilder {
</a><a href="#h28-1-137" id="h28-1-137" class="d">-                        from(&quot;_item&quot;) {
</a><a href="#h28-1-138" id="h28-1-138" class="d">-                            set(&quot;_cameraRollSource&quot;, &quot;Snapchat&quot;)
</a><a href="#h28-1-139" id="h28-1-139" class="d">-                            set(&quot;_contentUri&quot;, &quot;&quot;)
</a><a href="#h28-1-140" id="h28-1-140" class="d">-                            set(&quot;_durationMs&quot;, 0.0)
</a><a href="#h28-1-141" id="h28-1-141" class="d">-                            set(&quot;_disabled&quot;, false)
</a><a href="#h28-1-142" id="h28-1-142" class="d">-                            set(&quot;_imageRotation&quot;, 0.0)
</a><a href="#h28-1-143" id="h28-1-143" class="d">-                            set(&quot;_width&quot;, 1080.0)
</a><a href="#h28-1-144" id="h28-1-144" class="d">-                            set(&quot;_height&quot;, 1920.0)
</a><a href="#h28-1-145" id="h28-1-145" class="d">-                            set(&quot;_timestampMs&quot;, System.currentTimeMillis().toDouble())
</a><a href="#h28-1-146" id="h28-1-146" class="d">-                            from(&quot;_itemId&quot;) {
</a><a href="#h28-1-147" id="h28-1-147" class="d">-                                set(&quot;_itemId&quot;, firstVideoId.toString())
</a><a href="#h28-1-148" id="h28-1-148" class="d">-                                set(&quot;_type&quot;, &quot;VIDEO&quot;)
</a><a href="#h28-1-149" id="h28-1-149" class="i">+                fun sendMedia() {
</a><a href="#h28-1-150" id="h28-1-150" class="i">+                    sendItemsMethod.invoke(chatMediaDrawerActionHandler, listOf&lt;Any&gt;(), listOf(
</a><a href="#h28-1-151" id="h28-1-151" class="i">+                        sendItemsMethod.genericParameterTypes[1].getTypeArguments().first().dataBuilder {
</a><a href="#h28-1-152" id="h28-1-152" class="i">+                            from(&quot;_item&quot;) {
</a><a href="#h28-1-153" id="h28-1-153" class="i">+                                set(&quot;_cameraRollSource&quot;, &quot;Snapchat&quot;)
</a><a href="#h28-1-154" id="h28-1-154" class="i">+                                set(&quot;_contentUri&quot;, &quot;&quot;)
</a><a href="#h28-1-155" id="h28-1-155" class="i">+                                set(&quot;_durationMs&quot;, 0.0)
</a><a href="#h28-1-156" id="h28-1-156" class="i">+                                set(&quot;_disabled&quot;, false)
</a><a href="#h28-1-157" id="h28-1-157" class="i">+                                set(&quot;_imageRotation&quot;, 0.0)
</a><a href="#h28-1-158" id="h28-1-158" class="i">+                                set(&quot;_width&quot;, 1080.0)
</a><a href="#h28-1-159" id="h28-1-159" class="i">+                                set(&quot;_height&quot;, 1920.0)
</a><a href="#h28-1-160" id="h28-1-160" class="i">+                                set(&quot;_timestampMs&quot;, System.currentTimeMillis().toDouble())
</a><a href="#h28-1-161" id="h28-1-161" class="i">+                                from(&quot;_itemId&quot;) {
</a><a href="#h28-1-162" id="h28-1-162" class="i">+                                    set(&quot;_itemId&quot;, firstVideoId.toString())
</a><a href="#h28-1-163" id="h28-1-163" class="i">+                                    set(&quot;_type&quot;, &quot;VIDEO&quot;)
</a><a href="#h28-1-164" id="h28-1-164" class="i">+                                }
</a>                             }
<a href="#h28-1-166" id="h28-1-166" class="i">+                            set(&quot;_order&quot;, 0.0)
</a>                         }
<a href="#h28-1-168" id="h28-1-168" class="d">-                        set(&quot;_order&quot;, 0.0)
</a><a href="#h28-1-169" id="h28-1-169" class="d">-                    }
</a><a href="#h28-1-170" id="h28-1-170" class="d">-                ))
</a><a href="#h28-1-171" id="h28-1-171" class="d">-            }
</a><a href="#h28-1-172" id="h28-1-172" class="i">+                    ))
</a><a href="#h28-1-173" id="h28-1-173" class="i">+                }
</a> 
<a href="#h28-1-175" id="h28-1-175" class="d">-            fun startConversation(audioOnly: Boolean) {
</a><a href="#h28-1-176" id="h28-1-176" class="d">-                context.coroutineScope.launch {
</a><a href="#h28-1-177" id="h28-1-177" class="d">-                    lastMediaDuration = MediaPlayer().run {
</a><a href="#h28-1-178" id="h28-1-178" class="d">-                        setDataSource(context.androidContext, event.intent.data!!)
</a><a href="#h28-1-179" id="h28-1-179" class="d">-                        prepare()
</a><a href="#h28-1-180" id="h28-1-180" class="d">-                        duration.toLong().also {
</a><a href="#h28-1-181" id="h28-1-181" class="d">-                            release()
</a><a href="#h28-1-182" id="h28-1-182" class="i">+                fun startConversation(audioOnly: Boolean) {
</a><a href="#h28-1-183" id="h28-1-183" class="i">+                    context.coroutineScope.launch {
</a><a href="#h28-1-184" id="h28-1-184" class="i">+                        lastMediaDuration = MediaPlayer().run {
</a><a href="#h28-1-185" id="h28-1-185" class="i">+                            setDataSource(context.androidContext, event.intent.data!!)
</a><a href="#h28-1-186" id="h28-1-186" class="i">+                            prepare()
</a><a href="#h28-1-187" id="h28-1-187" class="i">+                            duration.toLong().also {
</a><a href="#h28-1-188" id="h28-1-188" class="i">+                                release()
</a><a href="#h28-1-189" id="h28-1-189" class="i">+                            }
</a>                         }
<a href="#h28-1-191" id="h28-1-191" class="d">-                    }
</a> 
<a href="#h28-1-193" id="h28-1-193" class="d">-                    context.inAppOverlay.showStatusToast(Icons.Default.Crop, &quot;Converting media...&quot;, durationMs = 3000)
</a><a href="#h28-1-194" id="h28-1-194" class="d">-                    val pfd = context.bridgeClient.convertMedia(
</a><a href="#h28-1-195" id="h28-1-195" class="d">-                        context.androidContext.contentResolver.openFileDescriptor(event.intent.data!!, &quot;r&quot;)!!,
</a><a href="#h28-1-196" id="h28-1-196" class="d">-                        &quot;m4a&quot;,
</a><a href="#h28-1-197" id="h28-1-197" class="d">-                        &quot;m4a&quot;,
</a><a href="#h28-1-198" id="h28-1-198" class="d">-                        &quot;aac&quot;,
</a><a href="#h28-1-199" id="h28-1-199" class="d">-                        if (!audioOnly) &quot;libx264&quot; else null
</a><a href="#h28-1-200" id="h28-1-200" class="d">-                    )
</a><a href="#h28-1-201" id="h28-1-201" class="d">-
</a><a href="#h28-1-202" id="h28-1-202" class="d">-                    if (pfd == null) {
</a><a href="#h28-1-203" id="h28-1-203" class="d">-                        context.inAppOverlay.showStatusToast(Icons.Default.Error, &quot;Failed to convert media.&quot;)
</a><a href="#h28-1-204" id="h28-1-204" class="d">-                        return@launch
</a><a href="#h28-1-205" id="h28-1-205" class="d">-                    }
</a><a href="#h28-1-206" id="h28-1-206" class="i">+                        context.inAppOverlay.showStatusToast(Icons.Default.Crop, &quot;Converting media...&quot;, durationMs = 3000)
</a><a href="#h28-1-207" id="h28-1-207" class="i">+                        val pfd = context.bridgeClient.convertMedia(
</a><a href="#h28-1-208" id="h28-1-208" class="i">+                            context.androidContext.contentResolver.openFileDescriptor(event.intent.data!!, &quot;r&quot;)!!,
</a><a href="#h28-1-209" id="h28-1-209" class="i">+                            &quot;m4a&quot;,
</a><a href="#h28-1-210" id="h28-1-210" class="i">+                            &quot;m4a&quot;,
</a><a href="#h28-1-211" id="h28-1-211" class="i">+                            &quot;aac&quot;,
</a><a href="#h28-1-212" id="h28-1-212" class="i">+                            if (!audioOnly) &quot;libx264&quot; else null
</a><a href="#h28-1-213" id="h28-1-213" class="i">+                        )
</a><a href="#h28-1-214" id="h28-1-214" class="i">+
</a><a href="#h28-1-215" id="h28-1-215" class="i">+                        if (pfd == null) {
</a><a href="#h28-1-216" id="h28-1-216" class="i">+                            context.inAppOverlay.showStatusToast(Icons.Default.Error, &quot;Failed to convert media.&quot;)
</a><a href="#h28-1-217" id="h28-1-217" class="i">+                            return@launch
</a><a href="#h28-1-218" id="h28-1-218" class="i">+                        }
</a> 
<a href="#h28-1-220" id="h28-1-220" class="d">-                    context.inAppOverlay.showStatusToast(Icons.Default.CheckCircleOutline, &quot;Media converted successfully.&quot;)
</a><a href="#h28-1-221" id="h28-1-221" class="i">+                        context.inAppOverlay.showStatusToast(Icons.Default.CheckCircleOutline, &quot;Media converted successfully.&quot;)
</a> 
<a href="#h28-1-223" id="h28-1-223" class="d">-                    runCatching {
</a><a href="#h28-1-224" id="h28-1-224" class="d">-                        mediaInputStream = ParcelFileDescriptor.AutoCloseInputStream(pfd)
</a><a href="#h28-1-225" id="h28-1-225" class="d">-                        sendMedia()
</a><a href="#h28-1-226" id="h28-1-226" class="d">-                    }.onFailure {
</a><a href="#h28-1-227" id="h28-1-227" class="d">-                        mediaInputStream = null
</a><a href="#h28-1-228" id="h28-1-228" class="d">-                        context.log.error(it)
</a><a href="#h28-1-229" id="h28-1-229" class="d">-                        context.inAppOverlay.showStatusToast(Icons.Default.Error, &quot;Failed to send media.&quot;)
</a><a href="#h28-1-230" id="h28-1-230" class="i">+                        runCatching {
</a><a href="#h28-1-231" id="h28-1-231" class="i">+                            mediaInputStream = ParcelFileDescriptor.AutoCloseInputStream(pfd)
</a><a href="#h28-1-232" id="h28-1-232" class="i">+                            sendMedia()
</a><a href="#h28-1-233" id="h28-1-233" class="i">+                        }.onFailure {
</a><a href="#h28-1-234" id="h28-1-234" class="i">+                            mediaInputStream = null
</a><a href="#h28-1-235" id="h28-1-235" class="i">+                            context.log.error(it)
</a><a href="#h28-1-236" id="h28-1-236" class="i">+                            context.inAppOverlay.showStatusToast(Icons.Default.Error, &quot;Failed to send media.&quot;)
</a><a href="#h28-1-237" id="h28-1-237" class="i">+                        }
</a>                     }
                 }
<a href="#h28-1-240" id="h28-1-240" class="d">-            }
</a><a href="#h28-1-241" id="h28-1-241" class="d">-
</a><a href="#h28-1-242" id="h28-1-242" class="d">-            val isAudio = context.androidContext.contentResolver.getType(event.intent.data!!)!!.startsWith(&quot;audio/&quot;)
</a> 
<a href="#h28-1-244" id="h28-1-244" class="d">-            if (isAudio || context.config.messaging.galleryMediaSendOverride.getNullable() == null) {
</a><a href="#h28-1-245" id="h28-1-245" class="d">-                startConversation(isAudio)
</a><a href="#h28-1-246" id="h28-1-246" class="d">-                return@subscribe
</a><a href="#h28-1-247" id="h28-1-247" class="d">-            }
</a><a href="#h28-1-248" id="h28-1-248" class="i">+                val isAudio = context.androidContext.contentResolver.getType(event.intent.data!!)!!.startsWith(&quot;audio/&quot;)
</a> 
<a href="#h28-1-250" id="h28-1-250" class="d">-            ViewAppearanceHelper.newAlertDialogBuilder(context.mainActivity!!)
</a><a href="#h28-1-251" id="h28-1-251" class="d">-                .setTitle(&quot;Convert video file&quot;)
</a><a href="#h28-1-252" id="h28-1-252" class="d">-                .setItems(arrayOf(&quot;Send as video/audio&quot;, &quot;Send as audio only&quot;)) { _, which -&gt;
</a><a href="#h28-1-253" id="h28-1-253" class="d">-                    startConversation(which == 1)
</a><a href="#h28-1-254" id="h28-1-254" class="i">+                if (isAudio || context.config.messaging.galleryMediaSendOverride.getNullable() == null) {
</a><a href="#h28-1-255" id="h28-1-255" class="i">+                    startConversation(isAudio)
</a><a href="#h28-1-256" id="h28-1-256" class="i">+                    return@subscribe
</a>                 }
<a href="#h28-1-258" id="h28-1-258" class="d">-                .setNegativeButton(&quot;Cancel&quot;) { dialog, _ -&gt; dialog.dismiss() }.show()
</a><a href="#h28-1-259" id="h28-1-259" class="d">-        }
</a> 
<a href="#h28-1-261" id="h28-1-261" class="d">-        val buttonTag = Random.nextInt(0, 65535)
</a><a href="#h28-1-262" id="h28-1-262" class="d">-
</a><a href="#h28-1-263" id="h28-1-263" class="d">-        context.event.subscribe(AddViewEvent::class) { event -&gt;
</a><a href="#h28-1-264" id="h28-1-264" class="d">-            if (event.parent.id != context.resources.getId(&quot;chat_drawer_container&quot;) || !event.view::class.java.name.endsWith(&quot;ChatMediaDrawer&quot;)) return@subscribe
</a><a href="#h28-1-265" id="h28-1-265" class="d">-
</a><a href="#h28-1-266" id="h28-1-266" class="d">-            event.view.addOnAttachStateChangeListener(object: View.OnAttachStateChangeListener {
</a><a href="#h28-1-267" id="h28-1-267" class="d">-                override fun onViewAttachedToWindow(v: View) {
</a><a href="#h28-1-268" id="h28-1-268" class="d">-                    if (event.parent.findViewWithTag&lt;View&gt;(buttonTag)?.run {
</a><a href="#h28-1-269" id="h28-1-269" class="d">-                        visibility = View.VISIBLE
</a><a href="#h28-1-270" id="h28-1-270" class="d">-                        bringToFront()
</a><a href="#h28-1-271" id="h28-1-271" class="d">-                    } != null) return
</a><a href="#h28-1-272" id="h28-1-272" class="d">-                    event.parent.addView(
</a><a href="#h28-1-273" id="h28-1-273" class="d">-                        createComposeView(context.mainActivity!!) {
</a><a href="#h28-1-274" id="h28-1-274" class="d">-                            Row(
</a><a href="#h28-1-275" id="h28-1-275" class="d">-                                modifier = Modifier.fillMaxWidth(),
</a><a href="#h28-1-276" id="h28-1-276" class="d">-                                horizontalArrangement = Arrangement.End
</a><a href="#h28-1-277" id="h28-1-277" class="d">-                            ) {
</a><a href="#h28-1-278" id="h28-1-278" class="d">-                                FilledIconButton(onClick = {
</a><a href="#h28-1-279" id="h28-1-279" class="d">-                                    requestCode = Random.nextInt(0, 65535)
</a><a href="#h28-1-280" id="h28-1-280" class="d">-                                    this@MediaFilePicker.context.mainActivity!!.startActivityForResult(
</a><a href="#h28-1-281" id="h28-1-281" class="d">-                                        Intent(Intent.ACTION_OPEN_DOCUMENT).apply {
</a><a href="#h28-1-282" id="h28-1-282" class="d">-                                            addCategory(Intent.CATEGORY_OPENABLE)
</a><a href="#h28-1-283" id="h28-1-283" class="d">-                                            type = &quot;video/*&quot;
</a><a href="#h28-1-284" id="h28-1-284" class="d">-                                            putExtra(Intent.EXTRA_MIME_TYPES, arrayOf(&quot;video/*&quot;, &quot;audio/*&quot;))
</a><a href="#h28-1-285" id="h28-1-285" class="d">-                                        },
</a><a href="#h28-1-286" id="h28-1-286" class="d">-                                        requestCode!!
</a><a href="#h28-1-287" id="h28-1-287" class="d">-                                    )
</a><a href="#h28-1-288" id="h28-1-288" class="d">-                                }) {
</a><a href="#h28-1-289" id="h28-1-289" class="d">-                                    Icon(Icons.Default.Upload, &quot;Upload media&quot;)
</a><a href="#h28-1-290" id="h28-1-290" class="i">+                ViewAppearanceHelper.newAlertDialogBuilder(context.mainActivity!!)
</a><a href="#h28-1-291" id="h28-1-291" class="i">+                    .setTitle(&quot;Convert video file&quot;)
</a><a href="#h28-1-292" id="h28-1-292" class="i">+                    .setItems(arrayOf(&quot;Send as video/audio&quot;, &quot;Send as audio only&quot;)) { _, which -&gt;
</a><a href="#h28-1-293" id="h28-1-293" class="i">+                        startConversation(which == 1)
</a><a href="#h28-1-294" id="h28-1-294" class="i">+                    }
</a><a href="#h28-1-295" id="h28-1-295" class="i">+                    .setNegativeButton(&quot;Cancel&quot;) { dialog, _ -&gt; dialog.dismiss() }.show()
</a><a href="#h28-1-296" id="h28-1-296" class="i">+            }
</a><a href="#h28-1-297" id="h28-1-297" class="i">+
</a><a href="#h28-1-298" id="h28-1-298" class="i">+            val buttonTag = Random.nextInt(0, 65535)
</a><a href="#h28-1-299" id="h28-1-299" class="i">+
</a><a href="#h28-1-300" id="h28-1-300" class="i">+            context.event.subscribe(AddViewEvent::class) { event -&gt;
</a><a href="#h28-1-301" id="h28-1-301" class="i">+                if (event.parent.id != context.resources.getId(&quot;chat_drawer_container&quot;) || !event.view::class.java.name.endsWith(&quot;ChatMediaDrawer&quot;)) return@subscribe
</a><a href="#h28-1-302" id="h28-1-302" class="i">+
</a><a href="#h28-1-303" id="h28-1-303" class="i">+                event.view.addOnAttachStateChangeListener(object: View.OnAttachStateChangeListener {
</a><a href="#h28-1-304" id="h28-1-304" class="i">+                    override fun onViewAttachedToWindow(v: View) {
</a><a href="#h28-1-305" id="h28-1-305" class="i">+                        if (event.parent.findViewWithTag&lt;View&gt;(buttonTag)?.run {
</a><a href="#h28-1-306" id="h28-1-306" class="i">+                                visibility = View.VISIBLE
</a><a href="#h28-1-307" id="h28-1-307" class="i">+                                bringToFront()
</a><a href="#h28-1-308" id="h28-1-308" class="i">+                            } != null) return
</a><a href="#h28-1-309" id="h28-1-309" class="i">+                        event.parent.addView(
</a><a href="#h28-1-310" id="h28-1-310" class="i">+                            createComposeView(context.mainActivity!!) {
</a><a href="#h28-1-311" id="h28-1-311" class="i">+                                Row(
</a><a href="#h28-1-312" id="h28-1-312" class="i">+                                    modifier = Modifier.fillMaxWidth(),
</a><a href="#h28-1-313" id="h28-1-313" class="i">+                                    horizontalArrangement = Arrangement.End
</a><a href="#h28-1-314" id="h28-1-314" class="i">+                                ) {
</a><a href="#h28-1-315" id="h28-1-315" class="i">+                                    FilledIconButton(onClick = {
</a><a href="#h28-1-316" id="h28-1-316" class="i">+                                        requestCode = Random.nextInt(0, 65535)
</a><a href="#h28-1-317" id="h28-1-317" class="i">+                                        this@MediaFilePicker.context.mainActivity!!.startActivityForResult(
</a><a href="#h28-1-318" id="h28-1-318" class="i">+                                            Intent(Intent.ACTION_OPEN_DOCUMENT).apply {
</a><a href="#h28-1-319" id="h28-1-319" class="i">+                                                addCategory(Intent.CATEGORY_OPENABLE)
</a><a href="#h28-1-320" id="h28-1-320" class="i">+                                                type = &quot;video/*&quot;
</a><a href="#h28-1-321" id="h28-1-321" class="i">+                                                putExtra(Intent.EXTRA_MIME_TYPES, arrayOf(&quot;video/*&quot;, &quot;audio/*&quot;))
</a><a href="#h28-1-322" id="h28-1-322" class="i">+                                            },
</a><a href="#h28-1-323" id="h28-1-323" class="i">+                                            requestCode!!
</a><a href="#h28-1-324" id="h28-1-324" class="i">+                                        )
</a><a href="#h28-1-325" id="h28-1-325" class="i">+                                    }) {
</a><a href="#h28-1-326" id="h28-1-326" class="i">+                                        Icon(Icons.Default.Upload, &quot;Upload media&quot;)
</a><a href="#h28-1-327" id="h28-1-327" class="i">+                                    }
</a>                                 }
<a href="#h28-1-329" id="h28-1-329" class="i">+                            }.apply {
</a><a href="#h28-1-330" id="h28-1-330" class="i">+                                tag = buttonTag
</a><a href="#h28-1-331" id="h28-1-331" class="i">+                                layoutParams = FrameLayout.LayoutParams(
</a><a href="#h28-1-332" id="h28-1-332" class="i">+                                    ViewGroup.LayoutParams.MATCH_PARENT,
</a><a href="#h28-1-333" id="h28-1-333" class="i">+                                    ViewGroup.LayoutParams.WRAP_CONTENT
</a><a href="#h28-1-334" id="h28-1-334" class="i">+                                )
</a>                             }
<a href="#h28-1-336" id="h28-1-336" class="d">-                        }.apply {
</a><a href="#h28-1-337" id="h28-1-337" class="d">-                            tag = buttonTag
</a><a href="#h28-1-338" id="h28-1-338" class="d">-                            layoutParams = FrameLayout.LayoutParams(
</a><a href="#h28-1-339" id="h28-1-339" class="d">-                                ViewGroup.LayoutParams.MATCH_PARENT,
</a><a href="#h28-1-340" id="h28-1-340" class="d">-                                ViewGroup.LayoutParams.WRAP_CONTENT
</a><a href="#h28-1-341" id="h28-1-341" class="d">-                            )
</a><a href="#h28-1-342" id="h28-1-342" class="d">-                        }
</a><a href="#h28-1-343" id="h28-1-343" class="d">-                    )
</a><a href="#h28-1-344" id="h28-1-344" class="d">-                }
</a><a href="#h28-1-345" id="h28-1-345" class="d">-                override fun onViewDetachedFromWindow(v: View) {
</a><a href="#h28-1-346" id="h28-1-346" class="d">-                    event.parent.findViewWithTag&lt;View&gt;(buttonTag)?.visibility = View.GONE
</a><a href="#h28-1-347" id="h28-1-347" class="d">-                }
</a><a href="#h28-1-348" id="h28-1-348" class="d">-            })
</a><a href="#h28-1-349" id="h28-1-349" class="i">+                        )
</a><a href="#h28-1-350" id="h28-1-350" class="i">+                    }
</a><a href="#h28-1-351" id="h28-1-351" class="i">+                    override fun onViewDetachedFromWindow(v: View) {
</a><a href="#h28-1-352" id="h28-1-352" class="i">+                        event.parent.findViewWithTag&lt;View&gt;(buttonTag)?.visibility = View.GONE
</a><a href="#h28-1-353" id="h28-1-353" class="i">+                    }
</a><a href="#h28-1-354" id="h28-1-354" class="i">+                })
</a><a href="#h28-1-355" id="h28-1-355" class="i">+            }
</a>         }
     }
 } 
\ No newline at end of file
<b>diff --git a/<a id="h29" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/MeoPasscodeBypass.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/MeoPasscodeBypass.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/MeoPasscodeBypass.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/MeoPasscodeBypass.kt</a></b>
<a href="#h29-0" id="h29-0" class="h">@@ -1,22 +1,23 @@
</a> package me.rhunk.snapenhance.core.features.impl.experiments
 
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h29-0-3" id="h29-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.util.hook.HookStage
 import me.rhunk.snapenhance.core.util.hook.hook
 import me.rhunk.snapenhance.mapper.impl.BCryptClassMapper
 
<a href="#h29-0-8" id="h29-0-8" class="d">-class MeoPasscodeBypass : Feature(&quot;Meo Passcode Bypass&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_ASYNC) {
</a><a href="#h29-0-9" id="h29-0-9" class="d">-    override fun asyncOnActivityCreate() {
</a><a href="#h29-0-10" id="h29-0-10" class="i">+class MeoPasscodeBypass : Feature(&quot;Meo Passcode Bypass&quot;) {
</a><a href="#h29-0-11" id="h29-0-11" class="i">+    override fun init() {
</a>         if (!context.config.experimental.meoPasscodeBypass.get()) return
 
<a href="#h29-0-14" id="h29-0-14" class="d">-        context.mappings.useMapper(BCryptClassMapper::class) {
</a><a href="#h29-0-15" id="h29-0-15" class="d">-            classReference.get()?.hook(
</a><a href="#h29-0-16" id="h29-0-16" class="d">-                hashMethod.get()!!,
</a><a href="#h29-0-17" id="h29-0-17" class="d">-                HookStage.BEFORE,
</a><a href="#h29-0-18" id="h29-0-18" class="d">-            ) { param -&gt;
</a><a href="#h29-0-19" id="h29-0-19" class="d">-                //set the hash to the result of the method
</a><a href="#h29-0-20" id="h29-0-20" class="d">-                param.setResult(param.arg(1))
</a><a href="#h29-0-21" id="h29-0-21" class="i">+        onNextActivityCreate(defer = true) {
</a><a href="#h29-0-22" id="h29-0-22" class="i">+            context.mappings.useMapper(BCryptClassMapper::class) {
</a><a href="#h29-0-23" id="h29-0-23" class="i">+                classReference.get()?.hook(
</a><a href="#h29-0-24" id="h29-0-24" class="i">+                    hashMethod.get()!!,
</a><a href="#h29-0-25" id="h29-0-25" class="i">+                    HookStage.BEFORE,
</a><a href="#h29-0-26" id="h29-0-26" class="i">+                ) { param -&gt;
</a><a href="#h29-0-27" id="h29-0-27" class="i">+                    //set the hash to the result of the method
</a><a href="#h29-0-28" id="h29-0-28" class="i">+                    param.setResult(param.arg(1))
</a><a href="#h29-0-29" id="h29-0-29" class="i">+                }
</a>             }
         }
     }
<b>diff --git a/<a id="h30" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/NoFriendScoreDelay.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/NoFriendScoreDelay.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/NoFriendScoreDelay.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/NoFriendScoreDelay.kt</a></b>
<a href="#h30-0" id="h30-0" class="h">@@ -1,24 +1,25 @@
</a> package me.rhunk.snapenhance.core.features.impl.experiments
 
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h30-0-3" id="h30-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.util.hook.HookStage
 import me.rhunk.snapenhance.core.util.hook.hookConstructor
 import me.rhunk.snapenhance.mapper.impl.ScoreUpdateMapper
 import kotlin.time.Duration.Companion.days
 import kotlin.time.Duration.Companion.minutes
 
<a href="#h30-0-10" id="h30-0-10" class="d">-class NoFriendScoreDelay : Feature(&quot;NoFriendScoreDelay&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_SYNC) {
</a><a href="#h30-0-11" id="h30-0-11" class="d">-    override fun onActivityCreate() {
</a><a href="#h30-0-12" id="h30-0-12" class="i">+class NoFriendScoreDelay : Feature(&quot;NoFriendScoreDelay&quot;) {
</a><a href="#h30-0-13" id="h30-0-13" class="i">+    override fun init() {
</a>         if (!context.config.experimental.noFriendScoreDelay.get()) return
 
<a href="#h30-0-16" id="h30-0-16" class="d">-        context.mappings.useMapper(ScoreUpdateMapper::class) {
</a><a href="#h30-0-17" id="h30-0-17" class="d">-            classReference.get()?.hookConstructor(HookStage.BEFORE) { param -&gt;
</a><a href="#h30-0-18" id="h30-0-18" class="d">-                param.args().indexOfFirst {
</a><a href="#h30-0-19" id="h30-0-19" class="d">-                    val longValue = it.toString().toLongOrNull() ?: return@indexOfFirst false
</a><a href="#h30-0-20" id="h30-0-20" class="d">-                    longValue &gt; 30.minutes.inWholeMilliseconds &amp;&amp; longValue &lt; 10.days.inWholeMilliseconds
</a><a href="#h30-0-21" id="h30-0-21" class="d">-                }.takeIf { it != -1 }?.let { index -&gt;
</a><a href="#h30-0-22" id="h30-0-22" class="d">-                    param.setArg(index, 0)
</a><a href="#h30-0-23" id="h30-0-23" class="i">+        onNextActivityCreate {
</a><a href="#h30-0-24" id="h30-0-24" class="i">+            context.mappings.useMapper(ScoreUpdateMapper::class) {
</a><a href="#h30-0-25" id="h30-0-25" class="i">+                classReference.get()?.hookConstructor(HookStage.BEFORE) { param -&gt;
</a><a href="#h30-0-26" id="h30-0-26" class="i">+                    param.args().indexOfFirst {
</a><a href="#h30-0-27" id="h30-0-27" class="i">+                        val longValue = it.toString().toLongOrNull() ?: return@indexOfFirst false
</a><a href="#h30-0-28" id="h30-0-28" class="i">+                        longValue &gt; 30.minutes.inWholeMilliseconds &amp;&amp; longValue &lt; 10.days.inWholeMilliseconds
</a><a href="#h30-0-29" id="h30-0-29" class="i">+                    }.takeIf { it != -1 }?.let { index -&gt;
</a><a href="#h30-0-30" id="h30-0-30" class="i">+                        param.setArg(index, 0)
</a><a href="#h30-0-31" id="h30-0-31" class="i">+                    }
</a>                 }
             }
         }
<b>diff --git a/<a id="h31" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/PreventForcedLogout.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/PreventForcedLogout.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/PreventForcedLogout.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/PreventForcedLogout.kt</a></b>
<a href="#h31-0" id="h31-0" class="h">@@ -2,11 +2,10 @@ package me.rhunk.snapenhance.core.features.impl.experiments
</a> 
 import android.content.Intent
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h31-0-3" id="h31-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.util.hook.HookStage
 import me.rhunk.snapenhance.core.util.hook.hook
 
<a href="#h31-0-7" id="h31-0-7" class="d">-class PreventForcedLogout : Feature(&quot;Prevent Forced Logout&quot;, loadParams = FeatureLoadParams.INIT_SYNC) {
</a><a href="#h31-0-8" id="h31-0-8" class="i">+class PreventForcedLogout : Feature(&quot;Prevent Forced Logout&quot;) {
</a>     override fun init() {
         if (!context.config.experimental.preventForcedLogout.get()) return
         findClass(&quot;com.snap.identity.service.ForcedLogoutBroadcastReceiver&quot;).hook(&quot;onReceive&quot;, HookStage.BEFORE) { param -&gt;
<b>diff --git a/<a id="h32" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/BypassVideoLengthRestriction.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/BypassVideoLengthRestriction.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/BypassVideoLengthRestriction.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/BypassVideoLengthRestriction.kt</a></b>
<a href="#h32-0" id="h32-0" class="h">@@ -5,7 +5,6 @@ import android.os.FileObserver
</a> import com.google.gson.JsonParser
 import me.rhunk.snapenhance.core.event.events.impl.SendMessageWithContentEvent
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h32-0-3" id="h32-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.util.hook.HookStage
 import me.rhunk.snapenhance.core.util.hook.hookConstructor
 import me.rhunk.snapenhance.core.util.ktx.setObjectField
<a href="#h32-1" id="h32-1" class="h">@@ -13,63 +12,65 @@ import me.rhunk.snapenhance.mapper.impl.DefaultMediaItemMapper
</a> import java.io.File
 
 class BypassVideoLengthRestriction :
<a href="#h32-1-3" id="h32-1-3" class="d">-    Feature(&quot;BypassVideoLengthRestriction&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_ASYNC) {
</a><a href="#h32-1-4" id="h32-1-4" class="i">+    Feature(&quot;BypassVideoLengthRestriction&quot;) {
</a>     private lateinit var fileObserver: FileObserver
 
<a href="#h32-1-7" id="h32-1-7" class="d">-    override fun asyncOnActivityCreate() {
</a><a href="#h32-1-8" id="h32-1-8" class="d">-        val mode = context.config.global.bypassVideoLengthRestriction.getNullable()
</a><a href="#h32-1-9" id="h32-1-9" class="i">+    override fun init() {
</a><a href="#h32-1-10" id="h32-1-10" class="i">+        onNextActivityCreate(defer = true) {
</a><a href="#h32-1-11" id="h32-1-11" class="i">+            val mode = context.config.global.bypassVideoLengthRestriction.getNullable()
</a> 
<a href="#h32-1-13" id="h32-1-13" class="d">-        if (mode == &quot;single&quot;) {
</a><a href="#h32-1-14" id="h32-1-14" class="d">-            //fix black videos when story is posted
</a><a href="#h32-1-15" id="h32-1-15" class="d">-            if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.Q) {
</a><a href="#h32-1-16" id="h32-1-16" class="d">-                val postedStorySnapFolder =
</a><a href="#h32-1-17" id="h32-1-17" class="d">-                    File(context.androidContext.filesDir, &quot;file_manager/posted_story_snap&quot;)
</a><a href="#h32-1-18" id="h32-1-18" class="i">+            if (mode == &quot;single&quot;) {
</a><a href="#h32-1-19" id="h32-1-19" class="i">+                //fix black videos when story is posted
</a><a href="#h32-1-20" id="h32-1-20" class="i">+                if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.Q) {
</a><a href="#h32-1-21" id="h32-1-21" class="i">+                    val postedStorySnapFolder =
</a><a href="#h32-1-22" id="h32-1-22" class="i">+                        File(context.androidContext.filesDir, &quot;file_manager/posted_story_snap&quot;)
</a> 
<a href="#h32-1-24" id="h32-1-24" class="d">-                fileObserver = (object : FileObserver(postedStorySnapFolder, MOVED_TO) {
</a><a href="#h32-1-25" id="h32-1-25" class="d">-                    override fun onEvent(event: Int, path: String?) {
</a><a href="#h32-1-26" id="h32-1-26" class="d">-                        if (event != MOVED_TO || path?.endsWith(&quot;posted_story_snap.2&quot;) != true) return
</a><a href="#h32-1-27" id="h32-1-27" class="d">-                        fileObserver.stopWatching()
</a><a href="#h32-1-28" id="h32-1-28" class="i">+                    fileObserver = (object : FileObserver(postedStorySnapFolder, MOVED_TO) {
</a><a href="#h32-1-29" id="h32-1-29" class="i">+                        override fun onEvent(event: Int, path: String?) {
</a><a href="#h32-1-30" id="h32-1-30" class="i">+                            if (event != MOVED_TO || path?.endsWith(&quot;posted_story_snap.2&quot;) != true) return
</a><a href="#h32-1-31" id="h32-1-31" class="i">+                            fileObserver.stopWatching()
</a> 
<a href="#h32-1-33" id="h32-1-33" class="d">-                        val file = File(postedStorySnapFolder, path)
</a><a href="#h32-1-34" id="h32-1-34" class="d">-                        runCatching {
</a><a href="#h32-1-35" id="h32-1-35" class="d">-                            val fileContent = JsonParser.parseReader(file.reader()).asJsonObject
</a><a href="#h32-1-36" id="h32-1-36" class="d">-                            if (fileContent[&quot;timerOrDuration&quot;].asLong &lt; 0) file.delete()
</a><a href="#h32-1-37" id="h32-1-37" class="d">-                        }.onFailure {
</a><a href="#h32-1-38" id="h32-1-38" class="d">-                            context.log.error(&quot;Failed to read story metadata file&quot;, it)
</a><a href="#h32-1-39" id="h32-1-39" class="i">+                            val file = File(postedStorySnapFolder, path)
</a><a href="#h32-1-40" id="h32-1-40" class="i">+                            runCatching {
</a><a href="#h32-1-41" id="h32-1-41" class="i">+                                val fileContent = JsonParser.parseReader(file.reader()).asJsonObject
</a><a href="#h32-1-42" id="h32-1-42" class="i">+                                if (fileContent[&quot;timerOrDuration&quot;].asLong &lt; 0) file.delete()
</a><a href="#h32-1-43" id="h32-1-43" class="i">+                            }.onFailure {
</a><a href="#h32-1-44" id="h32-1-44" class="i">+                                context.log.error(&quot;Failed to read story metadata file&quot;, it)
</a><a href="#h32-1-45" id="h32-1-45" class="i">+                            }
</a>                         }
<a href="#h32-1-47" id="h32-1-47" class="d">-                    }
</a><a href="#h32-1-48" id="h32-1-48" class="d">-                })
</a><a href="#h32-1-49" id="h32-1-49" class="i">+                    })
</a> 
<a href="#h32-1-51" id="h32-1-51" class="d">-                context.event.subscribe(SendMessageWithContentEvent::class) { event -&gt;
</a><a href="#h32-1-52" id="h32-1-52" class="d">-                    if (event.destinations.stories!!.isEmpty()) return@subscribe
</a><a href="#h32-1-53" id="h32-1-53" class="d">-                    fileObserver.startWatching()
</a><a href="#h32-1-54" id="h32-1-54" class="i">+                    context.event.subscribe(SendMessageWithContentEvent::class) { event -&gt;
</a><a href="#h32-1-55" id="h32-1-55" class="i">+                        if (event.destinations.stories!!.isEmpty()) return@subscribe
</a><a href="#h32-1-56" id="h32-1-56" class="i">+                        fileObserver.startWatching()
</a><a href="#h32-1-57" id="h32-1-57" class="i">+                    }
</a>                 }
<a href="#h32-1-59" id="h32-1-59" class="d">-            }
</a> 
<a href="#h32-1-61" id="h32-1-61" class="d">-            context.mappings.useMapper(DefaultMediaItemMapper::class) {
</a><a href="#h32-1-62" id="h32-1-62" class="d">-                defaultMediaItem.getAsClass()?.hookConstructor(HookStage.BEFORE) { param -&gt;
</a><a href="#h32-1-63" id="h32-1-63" class="d">-                    //set the video length argument
</a><a href="#h32-1-64" id="h32-1-64" class="d">-                    param.setArg(5, -1L)
</a><a href="#h32-1-65" id="h32-1-65" class="i">+                context.mappings.useMapper(DefaultMediaItemMapper::class) {
</a><a href="#h32-1-66" id="h32-1-66" class="i">+                    defaultMediaItem.getAsClass()?.hookConstructor(HookStage.BEFORE) { param -&gt;
</a><a href="#h32-1-67" id="h32-1-67" class="i">+                        //set the video length argument
</a><a href="#h32-1-68" id="h32-1-68" class="i">+                        param.setArg(5, -1L)
</a><a href="#h32-1-69" id="h32-1-69" class="i">+                    }
</a>                 }
             }
<a href="#h32-1-72" id="h32-1-72" class="d">-        }
</a> 
<a href="#h32-1-74" id="h32-1-74" class="d">-        //TODO: allow split from any source
</a><a href="#h32-1-75" id="h32-1-75" class="d">-        if (mode == &quot;split&quot;) {
</a><a href="#h32-1-76" id="h32-1-76" class="d">-            // memories grid
</a><a href="#h32-1-77" id="h32-1-77" class="d">-            context.mappings.useMapper(DefaultMediaItemMapper::class) {
</a><a href="#h32-1-78" id="h32-1-78" class="d">-                cameraRollMediaId.getAsClass()?.hookConstructor(HookStage.AFTER) { param -&gt;
</a><a href="#h32-1-79" id="h32-1-79" class="d">-                    //set the durationMs field
</a><a href="#h32-1-80" id="h32-1-80" class="d">-                    param.thisObject&lt;Any&gt;()
</a><a href="#h32-1-81" id="h32-1-81" class="d">-                        .setObjectField(durationMsField.get()!!, -1L)
</a><a href="#h32-1-82" id="h32-1-82" class="i">+            //TODO: allow split from any source
</a><a href="#h32-1-83" id="h32-1-83" class="i">+            if (mode == &quot;split&quot;) {
</a><a href="#h32-1-84" id="h32-1-84" class="i">+                // memories grid
</a><a href="#h32-1-85" id="h32-1-85" class="i">+                context.mappings.useMapper(DefaultMediaItemMapper::class) {
</a><a href="#h32-1-86" id="h32-1-86" class="i">+                    cameraRollMediaId.getAsClass()?.hookConstructor(HookStage.AFTER) { param -&gt;
</a><a href="#h32-1-87" id="h32-1-87" class="i">+                        //set the durationMs field
</a><a href="#h32-1-88" id="h32-1-88" class="i">+                        param.thisObject&lt;Any&gt;()
</a><a href="#h32-1-89" id="h32-1-89" class="i">+                            .setObjectField(durationMsField.get()!!, -1L)
</a><a href="#h32-1-90" id="h32-1-90" class="i">+                    }
</a>                 }
<a href="#h32-1-92" id="h32-1-92" class="d">-            }
</a> 
<a href="#h32-1-94" id="h32-1-94" class="d">-            // chat camera roll grid
</a><a href="#h32-1-95" id="h32-1-95" class="d">-            findClass(&quot;com.snap.composer.memories.MemoriesPickerVideoDurationConfig&quot;).hookConstructor(HookStage.AFTER) { param -&gt;
</a><a href="#h32-1-96" id="h32-1-96" class="d">-                param.thisObject&lt;Any&gt;().apply {
</a><a href="#h32-1-97" id="h32-1-97" class="d">-                    setObjectField(&quot;_maxSingleItemDurationMs&quot;, null)
</a><a href="#h32-1-98" id="h32-1-98" class="d">-                    setObjectField(&quot;_maxTotalDurationMs&quot;, null)
</a><a href="#h32-1-99" id="h32-1-99" class="i">+                // chat camera roll grid
</a><a href="#h32-1-100" id="h32-1-100" class="i">+                findClass(&quot;com.snap.composer.memories.MemoriesPickerVideoDurationConfig&quot;).hookConstructor(HookStage.AFTER) { param -&gt;
</a><a href="#h32-1-101" id="h32-1-101" class="i">+                    param.thisObject&lt;Any&gt;().apply {
</a><a href="#h32-1-102" id="h32-1-102" class="i">+                        setObjectField(&quot;_maxSingleItemDurationMs&quot;, null)
</a><a href="#h32-1-103" id="h32-1-103" class="i">+                        setObjectField(&quot;_maxTotalDurationMs&quot;, null)
</a><a href="#h32-1-104" id="h32-1-104" class="i">+                    }
</a>                 }
             }
         }
<b>diff --git a/<a id="h33" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/DisableCustomTabs.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/DisableCustomTabs.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/DisableCustomTabs.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/DisableCustomTabs.kt</a></b>
<a href="#h33-0" id="h33-0" class="h">@@ -2,17 +2,18 @@ package me.rhunk.snapenhance.core.features.impl.global
</a> 
 import android.content.Intent
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h33-0-3" id="h33-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.util.hook.HookStage
 import me.rhunk.snapenhance.core.util.hook.hook
 
<a href="#h33-0-7" id="h33-0-7" class="d">-class DisableCustomTabs: Feature(&quot;Disable Custom Tabs&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_SYNC) {
</a><a href="#h33-0-8" id="h33-0-8" class="d">-    override fun onActivityCreate() {
</a><a href="#h33-0-9" id="h33-0-9" class="i">+class DisableCustomTabs: Feature(&quot;Disable Custom Tabs&quot;) {
</a><a href="#h33-0-10" id="h33-0-10" class="i">+    override fun init() {
</a>         if (!context.config.global.disableCustomTabs.get()) return
<a href="#h33-0-12" id="h33-0-12" class="d">-        context.mainActivity!!.packageManager.javaClass.hook(&quot;resolveService&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h33-0-13" id="h33-0-13" class="d">-            val intent = param.arg&lt;Intent&gt;(0)
</a><a href="#h33-0-14" id="h33-0-14" class="d">-            if (intent.action == &quot;android.support.customtabs.action.CustomTabsService&quot;) {
</a><a href="#h33-0-15" id="h33-0-15" class="d">-                param.setResult(null)
</a><a href="#h33-0-16" id="h33-0-16" class="i">+        onNextActivityCreate { activity -&gt;
</a><a href="#h33-0-17" id="h33-0-17" class="i">+            activity.packageManager.javaClass.hook(&quot;resolveService&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h33-0-18" id="h33-0-18" class="i">+                val intent = param.arg&lt;Intent&gt;(0)
</a><a href="#h33-0-19" id="h33-0-19" class="i">+                if (intent.action == &quot;android.support.customtabs.action.CustomTabsService&quot;) {
</a><a href="#h33-0-20" id="h33-0-20" class="i">+                    param.setResult(null)
</a><a href="#h33-0-21" id="h33-0-21" class="i">+                }
</a>             }
         }
     }
<b>diff --git a/<a id="h34" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/DisableMemoriesSnapFeed.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/DisableMemoriesSnapFeed.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/DisableMemoriesSnapFeed.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/DisableMemoriesSnapFeed.kt</a></b>
<a href="#h34-0" id="h34-0" class="h">@@ -1,24 +1,24 @@
</a> package me.rhunk.snapenhance.core.features.impl.global
 
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h34-0-3" id="h34-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.util.hook.HookStage
 import me.rhunk.snapenhance.core.util.hook.hook
 import me.rhunk.snapenhance.mapper.impl.MemoriesPresenterMapper
 
<a href="#h34-0-8" id="h34-0-8" class="d">-class DisableMemoriesSnapFeed : Feature(&quot;Disable Memories Snap Feed&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_SYNC) {
</a><a href="#h34-0-9" id="h34-0-9" class="d">-    override fun onActivityCreate() {
</a><a href="#h34-0-10" id="h34-0-10" class="i">+class DisableMemoriesSnapFeed : Feature(&quot;Disable Memories Snap Feed&quot;) {
</a><a href="#h34-0-11" id="h34-0-11" class="i">+    override fun init() {
</a>         if (!context.config.global.disableMemoriesSnapFeed.get()) return
<a href="#h34-0-13" id="h34-0-13" class="i">+        onNextActivityCreate {
</a><a href="#h34-0-14" id="h34-0-14" class="i">+            context.mappings.useMapper(MemoriesPresenterMapper::class) {
</a><a href="#h34-0-15" id="h34-0-15" class="i">+                classReference.get()?.apply {
</a><a href="#h34-0-16" id="h34-0-16" class="i">+                    val getNameMethod = getMethod(&quot;getName&quot;) ?: return@apply
</a> 
<a href="#h34-0-18" id="h34-0-18" class="d">-        context.mappings.useMapper(MemoriesPresenterMapper::class) {
</a><a href="#h34-0-19" id="h34-0-19" class="d">-            classReference.get()?.apply {
</a><a href="#h34-0-20" id="h34-0-20" class="d">-                val getNameMethod = getMethod(&quot;getName&quot;) ?: return@apply
</a><a href="#h34-0-21" id="h34-0-21" class="i">+                    hook(onNavigationEventMethod.get()!!, HookStage.BEFORE) { param -&gt;
</a><a href="#h34-0-22" id="h34-0-22" class="i">+                        val instance = param.thisObject&lt;Any&gt;()
</a> 
<a href="#h34-0-24" id="h34-0-24" class="d">-                hook(onNavigationEventMethod.get()!!, HookStage.BEFORE) { param -&gt;
</a><a href="#h34-0-25" id="h34-0-25" class="d">-                    val instance = param.thisObject&lt;Any&gt;()
</a><a href="#h34-0-26" id="h34-0-26" class="d">-
</a><a href="#h34-0-27" id="h34-0-27" class="d">-                    if (getNameMethod.invoke(instance) == &quot;MemoriesAsyncPresenterFragmentSubscriber&quot;) {
</a><a href="#h34-0-28" id="h34-0-28" class="d">-                        param.setResult(null)
</a><a href="#h34-0-29" id="h34-0-29" class="i">+                        if (getNameMethod.invoke(instance) == &quot;MemoriesAsyncPresenterFragmentSubscriber&quot;) {
</a><a href="#h34-0-30" id="h34-0-30" class="i">+                            param.setResult(null)
</a><a href="#h34-0-31" id="h34-0-31" class="i">+                        }
</a>                     }
                 }
             }
<b>diff --git a/<a id="h35" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/DisableMetrics.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/DisableMetrics.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/DisableMetrics.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/DisableMetrics.kt</a></b>
<a href="#h35-0" id="h35-0" class="h">@@ -4,9 +4,8 @@ import me.rhunk.snapenhance.common.util.protobuf.ProtoReader
</a> import me.rhunk.snapenhance.core.event.events.impl.NetworkApiRequestEvent
 import me.rhunk.snapenhance.core.event.events.impl.UnaryCallEvent
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h35-0-3" id="h35-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> 
<a href="#h35-0-5" id="h35-0-5" class="d">-class DisableMetrics : Feature(&quot;DisableMetrics&quot;, loadParams = FeatureLoadParams.INIT_SYNC) {
</a><a href="#h35-0-6" id="h35-0-6" class="i">+class DisableMetrics : Feature(&quot;DisableMetrics&quot;) {
</a>     override fun init() {
         if (!context.config.global.disableMetrics.get()) return
 
<b>diff --git a/<a id="h36" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/DisableTelecomFramework.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/DisableTelecomFramework.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/DisableTelecomFramework.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/DisableTelecomFramework.kt</a></b>
<a href="#h36-0" id="h36-0" class="h">@@ -2,11 +2,10 @@ package me.rhunk.snapenhance.core.features.impl.global
</a> 
 import android.content.ContextWrapper
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h36-0-3" id="h36-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.util.hook.HookStage
 import me.rhunk.snapenhance.core.util.hook.hook
 
<a href="#h36-0-7" id="h36-0-7" class="d">-class DisableTelecomFramework: Feature(&quot;Disable Telecom Framework&quot;, loadParams = FeatureLoadParams.INIT_SYNC) {
</a><a href="#h36-0-8" id="h36-0-8" class="i">+class DisableTelecomFramework: Feature(&quot;Disable Telecom Framework&quot;) {
</a>     override fun init() {
         if (!context.config.global.disableTelecomFramework.get()) return
 
<b>diff --git a/<a id="h37" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/GooglePlayServicesDialogs.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/GooglePlayServicesDialogs.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/GooglePlayServicesDialogs.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/GooglePlayServicesDialogs.kt</a></b>
<a href="#h37-0" id="h37-0" class="h">@@ -2,21 +2,22 @@ package me.rhunk.snapenhance.core.features.impl.global
</a> 
 import android.app.AlertDialog
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h37-0-3" id="h37-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.util.hook.HookStage
 import me.rhunk.snapenhance.core.util.hook.hook
 import java.lang.reflect.Modifier
 
<a href="#h37-0-8" id="h37-0-8" class="d">-class GooglePlayServicesDialogs : Feature(&quot;Disable GMS Dialogs&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_ASYNC) {
</a><a href="#h37-0-9" id="h37-0-9" class="d">-    override fun asyncOnActivityCreate() {
</a><a href="#h37-0-10" id="h37-0-10" class="i">+class GooglePlayServicesDialogs : Feature(&quot;Disable GMS Dialogs&quot;) {
</a><a href="#h37-0-11" id="h37-0-11" class="i">+    override fun init() {
</a>         if (!context.config.global.disableGooglePlayDialogs.get()) return
 
<a href="#h37-0-14" id="h37-0-14" class="d">-        findClass(&quot;com.google.android.gms.common.GoogleApiAvailability&quot;).methods
</a><a href="#h37-0-15" id="h37-0-15" class="d">-            .first { Modifier.isStatic(it.modifiers) &amp;&amp; it.returnType == AlertDialog::class.java }.let { method -&gt;
</a><a href="#h37-0-16" id="h37-0-16" class="d">-            method.hook(HookStage.BEFORE) { param -&gt;
</a><a href="#h37-0-17" id="h37-0-17" class="d">-                context.log.verbose(&quot;GoogleApiAvailability.showErrorDialogFragment() called, returning null&quot;)
</a><a href="#h37-0-18" id="h37-0-18" class="d">-                param.setResult(null)
</a><a href="#h37-0-19" id="h37-0-19" class="d">-            }
</a><a href="#h37-0-20" id="h37-0-20" class="i">+        onNextActivityCreate(defer = true) {
</a><a href="#h37-0-21" id="h37-0-21" class="i">+            findClass(&quot;com.google.android.gms.common.GoogleApiAvailability&quot;).methods
</a><a href="#h37-0-22" id="h37-0-22" class="i">+                .first { Modifier.isStatic(it.modifiers) &amp;&amp; it.returnType == AlertDialog::class.java }.let { method -&gt;
</a><a href="#h37-0-23" id="h37-0-23" class="i">+                    method.hook(HookStage.BEFORE) { param -&gt;
</a><a href="#h37-0-24" id="h37-0-24" class="i">+                        context.log.verbose(&quot;GoogleApiAvailability.showErrorDialogFragment() called, returning null&quot;)
</a><a href="#h37-0-25" id="h37-0-25" class="i">+                        param.setResult(null)
</a><a href="#h37-0-26" id="h37-0-26" class="i">+                    }
</a><a href="#h37-0-27" id="h37-0-27" class="i">+                }
</a>         }
     }
 } 
\ No newline at end of file
<b>diff --git a/<a id="h38" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/MediaUploadQualityOverride.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/MediaUploadQualityOverride.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/MediaUploadQualityOverride.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/MediaUploadQualityOverride.kt</a></b>
<a href="#h38-0" id="h38-0" class="h">@@ -2,13 +2,12 @@ package me.rhunk.snapenhance.core.features.impl.global
</a> 
 import android.graphics.Bitmap
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h38-0-3" id="h38-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.util.hook.HookStage
 import me.rhunk.snapenhance.core.util.hook.hook
 import me.rhunk.snapenhance.mapper.impl.MediaQualityLevelProviderMapper
 import java.lang.reflect.Method
 
<a href="#h38-0-9" id="h38-0-9" class="d">-class MediaUploadQualityOverride : Feature(&quot;Media Upload Quality Override&quot;, loadParams = FeatureLoadParams.INIT_SYNC) {
</a><a href="#h38-0-10" id="h38-0-10" class="i">+class MediaUploadQualityOverride : Feature(&quot;Media Upload Quality Override&quot;) {
</a>     override fun init() {
         if (context.config.global.mediaUploadQualityConfig.forceVideoUploadSourceQuality.get()) {
             context.mappings.useMapper(MediaQualityLevelProviderMapper::class) {
<b>diff --git a/<a id="h39" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/SnapchatPlus.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/SnapchatPlus.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/SnapchatPlus.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/SnapchatPlus.kt</a></b>
<a href="#h39-0" id="h39-0" class="h">@@ -1,7 +1,6 @@
</a> package me.rhunk.snapenhance.core.features.impl.global
 
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h39-0-3" id="h39-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.util.hook.HookStage
 import me.rhunk.snapenhance.core.util.hook.hook
 import me.rhunk.snapenhance.core.util.hook.hookConstructor
<a href="#h39-1" id="h39-1" class="h">@@ -9,7 +8,7 @@ import me.rhunk.snapenhance.core.util.ktx.getObjectField
</a> import me.rhunk.snapenhance.core.util.ktx.setObjectField
 import me.rhunk.snapenhance.mapper.impl.PlusSubscriptionMapper
 
<a href="#h39-1-3" id="h39-1-3" class="d">-class SnapchatPlus: Feature(&quot;SnapchatPlus&quot;, loadParams = FeatureLoadParams.INIT_SYNC) {
</a><a href="#h39-1-4" id="h39-1-4" class="i">+class SnapchatPlus: Feature(&quot;SnapchatPlus&quot;) {
</a>     private val originalSubscriptionTime = (System.currentTimeMillis() - 7776000000L)
     private val expirationTimeMillis = (System.currentTimeMillis() + 15552000000L)
 
<b>diff --git a/<a id="h40" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/AutoMarkAsRead.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/AutoMarkAsRead.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/AutoMarkAsRead.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/AutoMarkAsRead.kt</a></b>
<a href="#h40-0" id="h40-0" class="h">@@ -11,7 +11,6 @@ import me.rhunk.snapenhance.common.data.ContentType
</a> import me.rhunk.snapenhance.common.data.MessageUpdate
 import me.rhunk.snapenhance.core.event.events.impl.SendMessageWithContentEvent
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h40-0-3" id="h40-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.features.impl.spying.StealthMode
 import me.rhunk.snapenhance.core.ui.ViewAppearanceHelper
 import me.rhunk.snapenhance.core.util.ktx.getObjectFieldOrNull
<a href="#h40-1" id="h40-1" class="h">@@ -19,7 +18,7 @@ import kotlin.coroutines.resume
</a> import kotlin.coroutines.suspendCoroutine
 import kotlin.random.Random
 
<a href="#h40-1-3" id="h40-1-3" class="d">-class AutoMarkAsRead : Feature(&quot;Auto Mark As Read&quot;, loadParams = FeatureLoadParams.INIT_SYNC) {
</a><a href="#h40-1-4" id="h40-1-4" class="i">+class AutoMarkAsRead : Feature(&quot;Auto Mark As Read&quot;) {
</a>     val canMarkConversationAsRead by lazy { context.config.messaging.autoMarkAsRead.get().contains(&quot;conversation_read&quot;) }
 
     fun markConversationsAsRead(conversationIds: List&lt;String&gt;) {
<b>diff --git a/<a id="h41" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/AutoSave.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/AutoSave.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/AutoSave.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/AutoSave.kt</a></b>
<a href="#h41-0" id="h41-0" class="h">@@ -4,7 +4,6 @@ import me.rhunk.snapenhance.common.data.MessageState
</a> import me.rhunk.snapenhance.common.data.MessageUpdate
 import me.rhunk.snapenhance.common.data.MessagingRuleType
 import me.rhunk.snapenhance.core.event.events.impl.ConversationUpdateEvent
<a href="#h41-0-3" id="h41-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.features.MessagingRuleFeature
 import me.rhunk.snapenhance.core.features.impl.spying.MessageLogger
 import me.rhunk.snapenhance.core.features.impl.spying.StealthMode
<a href="#h41-1" id="h41-1" class="h">@@ -16,7 +15,7 @@ import me.rhunk.snapenhance.core.wrapper.impl.SnapUUID
</a> import me.rhunk.snapenhance.mapper.impl.CallbackMapper
 import java.util.concurrent.Executors
 
<a href="#h41-1-3" id="h41-1-3" class="d">-class AutoSave : MessagingRuleFeature(&quot;Auto Save&quot;, MessagingRuleType.AUTO_SAVE, loadParams = FeatureLoadParams.ACTIVITY_CREATE_ASYNC) {
</a><a href="#h41-1-4" id="h41-1-4" class="i">+class AutoSave : MessagingRuleFeature(&quot;Auto Save&quot;, MessagingRuleType.AUTO_SAVE) {
</a>     private val asyncSaveExecutorService = Executors.newSingleThreadExecutor()
 
     private val messageLogger by lazy { context.feature(MessageLogger::class) }
<a href="#h41-2" id="h41-2" class="h">@@ -68,37 +67,39 @@ class AutoSave : MessagingRuleFeature(&quot;Auto Save&quot;, MessagingRuleType.AUTO_SAVE, 
</a>         return canUseRule(targetConversationId)
     }
 
<a href="#h41-2-3" id="h41-2-3" class="d">-    override fun asyncOnActivityCreate() {
</a><a href="#h41-2-4" id="h41-2-4" class="d">-        // called when enter in a conversation
</a><a href="#h41-2-5" id="h41-2-5" class="d">-        context.mappings.useMapper(CallbackMapper::class) {
</a><a href="#h41-2-6" id="h41-2-6" class="d">-            callbacks.getClass(&quot;FetchConversationWithMessagesCallback&quot;)?.hook(
</a><a href="#h41-2-7" id="h41-2-7" class="d">-                &quot;onFetchConversationWithMessagesComplete&quot;,
</a><a href="#h41-2-8" id="h41-2-8" class="d">-                HookStage.BEFORE,
</a><a href="#h41-2-9" id="h41-2-9" class="d">-                { autoSaveFilter.isNotEmpty() }
</a><a href="#h41-2-10" id="h41-2-10" class="d">-            ) { param -&gt;
</a><a href="#h41-2-11" id="h41-2-11" class="d">-                val conversationId = SnapUUID(param.arg&lt;Any&gt;(0).getObjectField(&quot;mConversationId&quot;)!!)
</a><a href="#h41-2-12" id="h41-2-12" class="d">-                if (!canSaveInConversation(conversationId.toString())) return@hook
</a><a href="#h41-2-13" id="h41-2-13" class="d">-
</a><a href="#h41-2-14" id="h41-2-14" class="d">-                val messages = param.arg&lt;List&lt;Any&gt;&gt;(1).map { Message(it) }
</a><a href="#h41-2-15" id="h41-2-15" class="d">-                messages.forEach {
</a><a href="#h41-2-16" id="h41-2-16" class="d">-                    if (!canSaveMessage(it)) return@forEach
</a><a href="#h41-2-17" id="h41-2-17" class="d">-                    asyncSaveExecutorService.submit {
</a><a href="#h41-2-18" id="h41-2-18" class="d">-                        saveMessage(conversationId.toString(), it)
</a><a href="#h41-2-19" id="h41-2-19" class="i">+    override fun init() {
</a><a href="#h41-2-20" id="h41-2-20" class="i">+        onNextActivityCreate(defer = true) {
</a><a href="#h41-2-21" id="h41-2-21" class="i">+            // called when enter in a conversation
</a><a href="#h41-2-22" id="h41-2-22" class="i">+            context.mappings.useMapper(CallbackMapper::class) {
</a><a href="#h41-2-23" id="h41-2-23" class="i">+                callbacks.getClass(&quot;FetchConversationWithMessagesCallback&quot;)?.hook(
</a><a href="#h41-2-24" id="h41-2-24" class="i">+                    &quot;onFetchConversationWithMessagesComplete&quot;,
</a><a href="#h41-2-25" id="h41-2-25" class="i">+                    HookStage.BEFORE,
</a><a href="#h41-2-26" id="h41-2-26" class="i">+                    { autoSaveFilter.isNotEmpty() }
</a><a href="#h41-2-27" id="h41-2-27" class="i">+                ) { param -&gt;
</a><a href="#h41-2-28" id="h41-2-28" class="i">+                    val conversationId = SnapUUID(param.arg&lt;Any&gt;(0).getObjectField(&quot;mConversationId&quot;)!!)
</a><a href="#h41-2-29" id="h41-2-29" class="i">+                    if (!canSaveInConversation(conversationId.toString())) return@hook
</a><a href="#h41-2-30" id="h41-2-30" class="i">+
</a><a href="#h41-2-31" id="h41-2-31" class="i">+                    val messages = param.arg&lt;List&lt;Any&gt;&gt;(1).map { Message(it) }
</a><a href="#h41-2-32" id="h41-2-32" class="i">+                    messages.forEach {
</a><a href="#h41-2-33" id="h41-2-33" class="i">+                        if (!canSaveMessage(it)) return@forEach
</a><a href="#h41-2-34" id="h41-2-34" class="i">+                        asyncSaveExecutorService.submit {
</a><a href="#h41-2-35" id="h41-2-35" class="i">+                            saveMessage(conversationId.toString(), it)
</a><a href="#h41-2-36" id="h41-2-36" class="i">+                        }
</a>                     }
                 }
             }
<a href="#h41-2-40" id="h41-2-40" class="d">-        }
</a> 
<a href="#h41-2-42" id="h41-2-42" class="d">-        context.event.subscribe(
</a><a href="#h41-2-43" id="h41-2-43" class="d">-            ConversationUpdateEvent::class,
</a><a href="#h41-2-44" id="h41-2-44" class="d">-            { autoSaveFilter.isNotEmpty() }
</a><a href="#h41-2-45" id="h41-2-45" class="d">-        ) { event -&gt;
</a><a href="#h41-2-46" id="h41-2-46" class="d">-            if (!canSaveInConversation(event.conversationId)) return@subscribe
</a><a href="#h41-2-47" id="h41-2-47" class="i">+            context.event.subscribe(
</a><a href="#h41-2-48" id="h41-2-48" class="i">+                ConversationUpdateEvent::class,
</a><a href="#h41-2-49" id="h41-2-49" class="i">+                { autoSaveFilter.isNotEmpty() }
</a><a href="#h41-2-50" id="h41-2-50" class="i">+            ) { event -&gt;
</a><a href="#h41-2-51" id="h41-2-51" class="i">+                if (!canSaveInConversation(event.conversationId)) return@subscribe
</a> 
<a href="#h41-2-53" id="h41-2-53" class="d">-            event.messages.forEach { message -&gt;
</a><a href="#h41-2-54" id="h41-2-54" class="d">-                if (!canSaveMessage(message)) return@forEach
</a><a href="#h41-2-55" id="h41-2-55" class="d">-                asyncSaveExecutorService.submit {
</a><a href="#h41-2-56" id="h41-2-56" class="d">-                    saveMessage(event.conversationId, message)
</a><a href="#h41-2-57" id="h41-2-57" class="i">+                event.messages.forEach { message -&gt;
</a><a href="#h41-2-58" id="h41-2-58" class="i">+                    if (!canSaveMessage(message)) return@forEach
</a><a href="#h41-2-59" id="h41-2-59" class="i">+                    asyncSaveExecutorService.submit {
</a><a href="#h41-2-60" id="h41-2-60" class="i">+                        saveMessage(event.conversationId, message)
</a><a href="#h41-2-61" id="h41-2-61" class="i">+                    }
</a>                 }
             }
         }
<b>diff --git a/<a id="h42" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/BypassMessageActionRestrictions.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/BypassMessageActionRestrictions.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/BypassMessageActionRestrictions.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/BypassMessageActionRestrictions.kt</a></b>
<a href="#h42-0" id="h42-0" class="h">@@ -2,15 +2,16 @@ package me.rhunk.snapenhance.core.features.impl.messaging
</a> 
 import me.rhunk.snapenhance.core.event.events.impl.BuildMessageEvent
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h42-0-3" id="h42-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> 
<a href="#h42-0-5" id="h42-0-5" class="d">-class BypassMessageActionRestrictions : Feature(&quot;Bypass Message Action Restrictions&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_SYNC) {
</a><a href="#h42-0-6" id="h42-0-6" class="d">-    override fun onActivityCreate() {
</a><a href="#h42-0-7" id="h42-0-7" class="i">+class BypassMessageActionRestrictions : Feature(&quot;Bypass Message Action Restrictions&quot;) {
</a><a href="#h42-0-8" id="h42-0-8" class="i">+    override fun init() {
</a>         if (!context.config.messaging.bypassMessageActionRestrictions.get()) return
<a href="#h42-0-10" id="h42-0-10" class="d">-        context.event.subscribe(BuildMessageEvent::class, priority = 102) { event -&gt;
</a><a href="#h42-0-11" id="h42-0-11" class="d">-            event.message.messageMetadata?.apply {
</a><a href="#h42-0-12" id="h42-0-12" class="d">-                isSaveable = true
</a><a href="#h42-0-13" id="h42-0-13" class="d">-                isReactable = true
</a><a href="#h42-0-14" id="h42-0-14" class="i">+        onNextActivityCreate {
</a><a href="#h42-0-15" id="h42-0-15" class="i">+            context.event.subscribe(BuildMessageEvent::class, priority = 102) { event -&gt;
</a><a href="#h42-0-16" id="h42-0-16" class="i">+                event.message.messageMetadata?.apply {
</a><a href="#h42-0-17" id="h42-0-17" class="i">+                    isSaveable = true
</a><a href="#h42-0-18" id="h42-0-18" class="i">+                    isReactable = true
</a><a href="#h42-0-19" id="h42-0-19" class="i">+                }
</a>             }
         }
     }
<b>diff --git a/<a id="h43" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/CallStartConfirmation.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/CallStartConfirmation.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/CallStartConfirmation.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/CallStartConfirmation.kt</a></b>
<a href="#h43-0" id="h43-0" class="h">@@ -5,7 +5,6 @@ import android.view.MotionEvent
</a> import android.view.View
 import android.view.ViewGroup
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h43-0-3" id="h43-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.ui.ViewAppearanceHelper
 import me.rhunk.snapenhance.core.ui.children
 import me.rhunk.snapenhance.core.util.hook.HookAdapter
<a href="#h43-1" id="h43-1" class="h">@@ -13,7 +12,7 @@ import me.rhunk.snapenhance.core.util.hook.HookStage
</a> import me.rhunk.snapenhance.core.util.hook.hook
 import me.rhunk.snapenhance.core.util.ktx.getId
 
<a href="#h43-1-3" id="h43-1-3" class="d">-class CallStartConfirmation : Feature(&quot;CallStartConfirmation&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_SYNC) {
</a><a href="#h43-1-4" id="h43-1-4" class="i">+class CallStartConfirmation : Feature(&quot;CallStartConfirmation&quot;) {
</a>     private fun hookTouchEvent(param: HookAdapter, motionEvent: MotionEvent, onConfirm: () -&gt; Unit) {
         if (motionEvent.action != MotionEvent.ACTION_UP) return
         param.setResult(true)
<a href="#h43-2" id="h43-2" class="h">@@ -26,37 +25,39 @@ class CallStartConfirmation : Feature(&quot;CallStartConfirmation&quot;, loadParams = Feat
</a>     }
 
     @SuppressLint(&quot;DiscouragedApi&quot;)
<a href="#h43-2-3" id="h43-2-3" class="d">-    override fun onActivityCreate() {
</a><a href="#h43-2-4" id="h43-2-4" class="i">+    override fun init() {
</a>         if (!context.config.messaging.callStartConfirmation.get()) return
 
<a href="#h43-2-7" id="h43-2-7" class="d">-        val callButtonsStub = context.resources.getId(&quot;call_buttons_stub&quot;)
</a><a href="#h43-2-8" id="h43-2-8" class="i">+        onNextActivityCreate {
</a><a href="#h43-2-9" id="h43-2-9" class="i">+            val callButtonsStub = context.resources.getId(&quot;call_buttons_stub&quot;)
</a> 
<a href="#h43-2-11" id="h43-2-11" class="d">-        findClass(&quot;com.snap.composer.views.ComposerRootView&quot;).hook(&quot;dispatchTouchEvent&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h43-2-12" id="h43-2-12" class="d">-            val view = param.thisObject() as? ViewGroup ?: return@hook
</a><a href="#h43-2-13" id="h43-2-13" class="d">-            if (view.id != callButtonsStub) return@hook
</a><a href="#h43-2-14" id="h43-2-14" class="d">-            val childComposerView = view.getChildAt(0) as? ViewGroup ?: return@hook
</a><a href="#h43-2-15" id="h43-2-15" class="d">-            // check if the child composer view contains 2 call buttons
</a><a href="#h43-2-16" id="h43-2-16" class="d">-            if (childComposerView.children().count {
</a><a href="#h43-2-17" id="h43-2-17" class="d">-                it::class.java == childComposerView::class.java
</a><a href="#h43-2-18" id="h43-2-18" class="d">-            } != 2) return@hook
</a><a href="#h43-2-19" id="h43-2-19" class="d">-            hookTouchEvent(param, param.arg(0)) {
</a><a href="#h43-2-20" id="h43-2-20" class="d">-                param.invokeOriginal()
</a><a href="#h43-2-21" id="h43-2-21" class="i">+            findClass(&quot;com.snap.composer.views.ComposerRootView&quot;).hook(&quot;dispatchTouchEvent&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h43-2-22" id="h43-2-22" class="i">+                val view = param.thisObject() as? ViewGroup ?: return@hook
</a><a href="#h43-2-23" id="h43-2-23" class="i">+                if (view.id != callButtonsStub) return@hook
</a><a href="#h43-2-24" id="h43-2-24" class="i">+                val childComposerView = view.getChildAt(0) as? ViewGroup ?: return@hook
</a><a href="#h43-2-25" id="h43-2-25" class="i">+                // check if the child composer view contains 2 call buttons
</a><a href="#h43-2-26" id="h43-2-26" class="i">+                if (childComposerView.children().count {
</a><a href="#h43-2-27" id="h43-2-27" class="i">+                        it::class.java == childComposerView::class.java
</a><a href="#h43-2-28" id="h43-2-28" class="i">+                    } != 2) return@hook
</a><a href="#h43-2-29" id="h43-2-29" class="i">+                hookTouchEvent(param, param.arg(0)) {
</a><a href="#h43-2-30" id="h43-2-30" class="i">+                    param.invokeOriginal()
</a><a href="#h43-2-31" id="h43-2-31" class="i">+                }
</a>             }
<a href="#h43-2-33" id="h43-2-33" class="d">-        }
</a> 
<a href="#h43-2-35" id="h43-2-35" class="d">-        val callButton1 = context.resources.getId(&quot;friend_action_button3&quot;)
</a><a href="#h43-2-36" id="h43-2-36" class="d">-        val callButton2 = context.resources.getId(&quot;friend_action_button4&quot;)
</a><a href="#h43-2-37" id="h43-2-37" class="i">+            val callButton1 = context.resources.getId(&quot;friend_action_button3&quot;)
</a><a href="#h43-2-38" id="h43-2-38" class="i">+            val callButton2 = context.resources.getId(&quot;friend_action_button4&quot;)
</a> 
<a href="#h43-2-40" id="h43-2-40" class="d">-        findClass(&quot;com.snap.ui.view.stackdraw.StackDrawLayout&quot;).hook(&quot;onTouchEvent&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h43-2-41" id="h43-2-41" class="d">-            val view = param.thisObject&lt;View&gt;()
</a><a href="#h43-2-42" id="h43-2-42" class="d">-            if (view.id != callButton1 &amp;&amp; view.id != callButton2) return@hook
</a><a href="#h43-2-43" id="h43-2-43" class="i">+            findClass(&quot;com.snap.ui.view.stackdraw.StackDrawLayout&quot;).hook(&quot;onTouchEvent&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h43-2-44" id="h43-2-44" class="i">+                val view = param.thisObject&lt;View&gt;()
</a><a href="#h43-2-45" id="h43-2-45" class="i">+                if (view.id != callButton1 &amp;&amp; view.id != callButton2) return@hook
</a> 
<a href="#h43-2-47" id="h43-2-47" class="d">-            hookTouchEvent(param, param.arg(0)) {
</a><a href="#h43-2-48" id="h43-2-48" class="d">-                arrayOf(
</a><a href="#h43-2-49" id="h43-2-49" class="d">-                    MotionEvent.obtain(0, 0, MotionEvent.ACTION_DOWN, 0f, 0f, 0),
</a><a href="#h43-2-50" id="h43-2-50" class="d">-                    MotionEvent.obtain(0, 0, MotionEvent.ACTION_UP, 0f, 0f, 0)
</a><a href="#h43-2-51" id="h43-2-51" class="d">-                ).forEach {
</a><a href="#h43-2-52" id="h43-2-52" class="d">-                    param.invokeOriginal(arrayOf(it))
</a><a href="#h43-2-53" id="h43-2-53" class="i">+                hookTouchEvent(param, param.arg(0)) {
</a><a href="#h43-2-54" id="h43-2-54" class="i">+                    arrayOf(
</a><a href="#h43-2-55" id="h43-2-55" class="i">+                        MotionEvent.obtain(0, 0, MotionEvent.ACTION_DOWN, 0f, 0f, 0),
</a><a href="#h43-2-56" id="h43-2-56" class="i">+                        MotionEvent.obtain(0, 0, MotionEvent.ACTION_UP, 0f, 0f, 0)
</a><a href="#h43-2-57" id="h43-2-57" class="i">+                    ).forEach {
</a><a href="#h43-2-58" id="h43-2-58" class="i">+                        param.invokeOriginal(arrayOf(it))
</a><a href="#h43-2-59" id="h43-2-59" class="i">+                    }
</a>                 }
             }
         }
<b>diff --git a/<a id="h44" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/DisableReplayInFF.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/DisableReplayInFF.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/DisableReplayInFF.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/DisableReplayInFF.kt</a></b>
<a href="#h44-0" id="h44-0" class="h">@@ -1,22 +1,23 @@
</a> package me.rhunk.snapenhance.core.features.impl.messaging
 
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h44-0-3" id="h44-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.util.hook.HookStage
 import me.rhunk.snapenhance.core.util.hook.hookConstructor
 import me.rhunk.snapenhance.core.util.ktx.getObjectField
 import me.rhunk.snapenhance.core.util.ktx.setEnumField
 
<a href="#h44-0-9" id="h44-0-9" class="d">-class DisableReplayInFF : Feature(&quot;DisableReplayInFF&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_ASYNC) {
</a><a href="#h44-0-10" id="h44-0-10" class="d">-    override fun asyncOnActivityCreate() {
</a><a href="#h44-0-11" id="h44-0-11" class="i">+class DisableReplayInFF : Feature(&quot;DisableReplayInFF&quot;) {
</a><a href="#h44-0-12" id="h44-0-12" class="i">+    override fun init() {
</a>         val state by context.config.messaging.disableReplayInFF
 
<a href="#h44-0-15" id="h44-0-15" class="d">-        findClass(&quot;com.snapchat.client.messaging.InteractionInfo&quot;)
</a><a href="#h44-0-16" id="h44-0-16" class="d">-            .hookConstructor(HookStage.AFTER, { state }) { param -&gt;
</a><a href="#h44-0-17" id="h44-0-17" class="d">-            val instance = param.thisObject&lt;Any&gt;()
</a><a href="#h44-0-18" id="h44-0-18" class="d">-            if (instance.getObjectField(&quot;mLongPressActionState&quot;).toString() == &quot;REQUEST_SNAP_REPLAY&quot;) {
</a><a href="#h44-0-19" id="h44-0-19" class="d">-                instance.setEnumField(&quot;mLongPressActionState&quot;, &quot;SHOW_CONVERSATION_ACTION_MENU&quot;)
</a><a href="#h44-0-20" id="h44-0-20" class="d">-            }
</a><a href="#h44-0-21" id="h44-0-21" class="i">+        onNextActivityCreate(defer = true) {
</a><a href="#h44-0-22" id="h44-0-22" class="i">+            findClass(&quot;com.snapchat.client.messaging.InteractionInfo&quot;)
</a><a href="#h44-0-23" id="h44-0-23" class="i">+                .hookConstructor(HookStage.AFTER, { state }) { param -&gt;
</a><a href="#h44-0-24" id="h44-0-24" class="i">+                    val instance = param.thisObject&lt;Any&gt;()
</a><a href="#h44-0-25" id="h44-0-25" class="i">+                    if (instance.getObjectField(&quot;mLongPressActionState&quot;).toString() == &quot;REQUEST_SNAP_REPLAY&quot;) {
</a><a href="#h44-0-26" id="h44-0-26" class="i">+                        instance.setEnumField(&quot;mLongPressActionState&quot;, &quot;SHOW_CONVERSATION_ACTION_MENU&quot;)
</a><a href="#h44-0-27" id="h44-0-27" class="i">+                    }
</a><a href="#h44-0-28" id="h44-0-28" class="i">+                }
</a>         }
     }
 } 
\ No newline at end of file
<b>diff --git a/<a id="h45" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/Messaging.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/Messaging.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/Messaging.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/Messaging.kt</a></b>
<a href="#h45-0" id="h45-0" class="h">@@ -7,7 +7,6 @@ import me.rhunk.snapenhance.common.ReceiversConfig
</a> import me.rhunk.snapenhance.core.event.events.impl.ConversationUpdateEvent
 import me.rhunk.snapenhance.core.event.events.impl.OnSnapInteractionEvent
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h45-0-3" id="h45-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.features.impl.spying.StealthMode
 import me.rhunk.snapenhance.core.util.EvictingMap
 import me.rhunk.snapenhance.core.util.hook.HookStage
<a href="#h45-1" id="h45-1" class="h">@@ -25,7 +24,7 @@ import me.rhunk.snapenhance.mapper.impl.FriendsFeedEventDispatcherMapper
</a> import java.util.UUID
 import java.util.concurrent.Future
 
<a href="#h45-1-3" id="h45-1-3" class="d">-class Messaging : Feature(&quot;Messaging&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_SYNC or FeatureLoadParams.INIT_ASYNC or FeatureLoadParams.INIT_SYNC) {
</a><a href="#h45-1-4" id="h45-1-4" class="i">+class Messaging : Feature(&quot;Messaging&quot;) {
</a>     var conversationManager: ConversationManager? = null
         private set
     private var conversationManagerDelegate: Any? = null
<a href="#h45-2" id="h45-2" class="h">@@ -48,6 +47,7 @@ class Messaging : Feature(&quot;Messaging&quot;, loadParams = FeatureLoadParams.ACTIVITY_C
</a>     }
 
     override fun init() {
<a href="#h45-2-3" id="h45-2-3" class="i">+        val stealthMode = context.feature(StealthMode::class)
</a>         context.classCache.conversationManager.hookConstructor(HookStage.BEFORE) { param -&gt;
             conversationManager = ConversationManager(context, param.thisObject())
             context.messagingBridge.triggerSessionStart()
<a href="#h45-3" id="h45-3" class="h">@@ -83,6 +83,80 @@ class Messaging : Feature(&quot;Messaging&quot;, loadParams = FeatureLoadParams.ACTIVITY_C
</a>                 }
             }
         }
<a href="#h45-3-3" id="h45-3-3" class="i">+
</a><a href="#h45-3-4" id="h45-3-4" class="i">+        defer {
</a><a href="#h45-3-5" id="h45-3-5" class="i">+            arrayOf(&quot;activate&quot;, &quot;deactivate&quot;, &quot;processTypingActivity&quot;).forEach { hook -&gt;
</a><a href="#h45-3-6" id="h45-3-6" class="i">+                context.classCache.presenceSession.hook(hook, HookStage.BEFORE, {
</a><a href="#h45-3-7" id="h45-3-7" class="i">+                    context.config.messaging.hideBitmojiPresence.get() || stealthMode.canUseRule(openedConversationUUID.toString())
</a><a href="#h45-3-8" id="h45-3-8" class="i">+                }) {
</a><a href="#h45-3-9" id="h45-3-9" class="i">+                    it.setResult(null)
</a><a href="#h45-3-10" id="h45-3-10" class="i">+                }
</a><a href="#h45-3-11" id="h45-3-11" class="i">+            }
</a><a href="#h45-3-12" id="h45-3-12" class="i">+
</a><a href="#h45-3-13" id="h45-3-13" class="i">+            context.classCache.presenceSession.hook(&quot;startPeeking&quot;, HookStage.BEFORE, {
</a><a href="#h45-3-14" id="h45-3-14" class="i">+                context.config.messaging.hidePeekAPeek.get() || stealthMode.canUseRule(openedConversationUUID.toString())
</a><a href="#h45-3-15" id="h45-3-15" class="i">+            }) { it.setResult(null) }
</a><a href="#h45-3-16" id="h45-3-16" class="i">+
</a><a href="#h45-3-17" id="h45-3-17" class="i">+            //get last opened snap for media downloader
</a><a href="#h45-3-18" id="h45-3-18" class="i">+            context.event.subscribe(OnSnapInteractionEvent::class) { event -&gt;
</a><a href="#h45-3-19" id="h45-3-19" class="i">+                openedConversationUUID = event.conversationId
</a><a href="#h45-3-20" id="h45-3-20" class="i">+                lastFocusedMessageId = event.messageId
</a><a href="#h45-3-21" id="h45-3-21" class="i">+            }
</a><a href="#h45-3-22" id="h45-3-22" class="i">+
</a><a href="#h45-3-23" id="h45-3-23" class="i">+            context.classCache.conversationManager.hook(&quot;fetchMessage&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h45-3-24" id="h45-3-24" class="i">+                val conversationId = SnapUUID(param.arg(0)).toString()
</a><a href="#h45-3-25" id="h45-3-25" class="i">+                if (openedConversationUUID?.toString() == conversationId) {
</a><a href="#h45-3-26" id="h45-3-26" class="i">+                    lastFocusedMessageId = param.arg(1)
</a><a href="#h45-3-27" id="h45-3-27" class="i">+                }
</a><a href="#h45-3-28" id="h45-3-28" class="i">+            }
</a><a href="#h45-3-29" id="h45-3-29" class="i">+
</a><a href="#h45-3-30" id="h45-3-30" class="i">+            context.classCache.conversationManager.hook(&quot;sendTypingNotification&quot;, HookStage.BEFORE, {
</a><a href="#h45-3-31" id="h45-3-31" class="i">+                context.config.messaging.hideTypingNotifications.get() || stealthMode.canUseRule(openedConversationUUID.toString())
</a><a href="#h45-3-32" id="h45-3-32" class="i">+            }) {
</a><a href="#h45-3-33" id="h45-3-33" class="i">+                it.setResult(null)
</a><a href="#h45-3-34" id="h45-3-34" class="i">+            }
</a><a href="#h45-3-35" id="h45-3-35" class="i">+        }
</a><a href="#h45-3-36" id="h45-3-36" class="i">+
</a><a href="#h45-3-37" id="h45-3-37" class="i">+        onNextActivityCreate {
</a><a href="#h45-3-38" id="h45-3-38" class="i">+            context.mappings.useMapper(FriendsFeedEventDispatcherMapper::class) {
</a><a href="#h45-3-39" id="h45-3-39" class="i">+                classReference.getAsClass()?.hook(&quot;onItemLongPress&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h45-3-40" id="h45-3-40" class="i">+                    val viewItemContainer = param.arg&lt;Any&gt;(0)
</a><a href="#h45-3-41" id="h45-3-41" class="i">+                    val viewItem = viewItemContainer.getObjectField(viewModelField.get()!!).toString()
</a><a href="#h45-3-42" id="h45-3-42" class="i">+                    val conversationId = viewItem.substringAfter(&quot;conversationId: &quot;).substring(0, 36).also {
</a><a href="#h45-3-43" id="h45-3-43" class="i">+                        if (it.startsWith(&quot;null&quot;)) return@hook
</a><a href="#h45-3-44" id="h45-3-44" class="i">+                    }
</a><a href="#h45-3-45" id="h45-3-45" class="i">+                    lastFocusedConversationId = conversationId
</a><a href="#h45-3-46" id="h45-3-46" class="i">+                    lastFocusedConversationType = context.database.getConversationType(conversationId) ?: 0
</a><a href="#h45-3-47" id="h45-3-47" class="i">+                }
</a><a href="#h45-3-48" id="h45-3-48" class="i">+            }
</a><a href="#h45-3-49" id="h45-3-49" class="i">+
</a><a href="#h45-3-50" id="h45-3-50" class="i">+            context.classCache.feedEntry.hookConstructor(HookStage.AFTER) { param -&gt;
</a><a href="#h45-3-51" id="h45-3-51" class="i">+                val instance = param.thisObject&lt;Any&gt;()
</a><a href="#h45-3-52" id="h45-3-52" class="i">+                val interactionInfo = instance.getObjectFieldOrNull(&quot;mInteractionInfo&quot;) ?: return@hookConstructor
</a><a href="#h45-3-53" id="h45-3-53" class="i">+                val messages = (interactionInfo.getObjectFieldOrNull(&quot;mMessages&quot;) as? List&lt;*&gt;)?.map { Message(it) } ?: return@hookConstructor
</a><a href="#h45-3-54" id="h45-3-54" class="i">+                val conversationId = SnapUUID(instance.getObjectFieldOrNull(&quot;mConversationId&quot;) ?: return@hookConstructor).toString()
</a><a href="#h45-3-55" id="h45-3-55" class="i">+                val myUserId = context.database.myUserId
</a><a href="#h45-3-56" id="h45-3-56" class="i">+
</a><a href="#h45-3-57" id="h45-3-57" class="i">+                feedCachedSnapMessages[conversationId] = messages.filter { msg -&gt;
</a><a href="#h45-3-58" id="h45-3-58" class="i">+                    msg.messageMetadata?.openedBy?.none { it.toString() == myUserId } == true
</a><a href="#h45-3-59" id="h45-3-59" class="i">+                }.sortedBy { it.orderKey }.mapNotNull { it.messageDescriptor?.messageId }
</a><a href="#h45-3-60" id="h45-3-60" class="i">+            }
</a><a href="#h45-3-61" id="h45-3-61" class="i">+
</a><a href="#h45-3-62" id="h45-3-62" class="i">+            context.classCache.conversationManager.apply {
</a><a href="#h45-3-63" id="h45-3-63" class="i">+                hook(&quot;enterConversation&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h45-3-64" id="h45-3-64" class="i">+                    openedConversationUUID = SnapUUID(param.arg(0))
</a><a href="#h45-3-65" id="h45-3-65" class="i">+                    if (context.config.messaging.bypassMessageRetentionPolicy.get()) {
</a><a href="#h45-3-66" id="h45-3-66" class="i">+                        val callback = param.argNullable&lt;Any&gt;(2) ?: return@hook
</a><a href="#h45-3-67" id="h45-3-67" class="i">+                        callback::class.java.methods.firstOrNull { it.name == &quot;onSuccess&quot; }?.invoke(callback)
</a><a href="#h45-3-68" id="h45-3-68" class="i">+                        param.setResult(null)
</a><a href="#h45-3-69" id="h45-3-69" class="i">+                    }
</a><a href="#h45-3-70" id="h45-3-70" class="i">+                }
</a><a href="#h45-3-71" id="h45-3-71" class="i">+
</a><a href="#h45-3-72" id="h45-3-72" class="i">+                hook(&quot;exitConversation&quot;, HookStage.BEFORE) {
</a><a href="#h45-3-73" id="h45-3-73" class="i">+                    openedConversationUUID = null
</a><a href="#h45-3-74" id="h45-3-74" class="i">+                }
</a><a href="#h45-3-75" id="h45-3-75" class="i">+            }
</a><a href="#h45-3-76" id="h45-3-76" class="i">+        }
</a>     }
 
     fun getFeedCachedMessageIds(conversationId: String) = feedCachedSnapMessages[conversationId]
<a href="#h45-4" id="h45-4" class="h">@@ -116,82 +190,6 @@ class Messaging : Feature(&quot;Messaging&quot;, loadParams = FeatureLoadParams.ACTIVITY_C
</a>         }
     }
 
<a href="#h45-4-3" id="h45-4-3" class="d">-    override fun onActivityCreate() {
</a><a href="#h45-4-4" id="h45-4-4" class="d">-        context.mappings.useMapper(FriendsFeedEventDispatcherMapper::class) {
</a><a href="#h45-4-5" id="h45-4-5" class="d">-            classReference.getAsClass()?.hook(&quot;onItemLongPress&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h45-4-6" id="h45-4-6" class="d">-                val viewItemContainer = param.arg&lt;Any&gt;(0)
</a><a href="#h45-4-7" id="h45-4-7" class="d">-                val viewItem = viewItemContainer.getObjectField(viewModelField.get()!!).toString()
</a><a href="#h45-4-8" id="h45-4-8" class="d">-                val conversationId = viewItem.substringAfter(&quot;conversationId: &quot;).substring(0, 36).also {
</a><a href="#h45-4-9" id="h45-4-9" class="d">-                    if (it.startsWith(&quot;null&quot;)) return@hook
</a><a href="#h45-4-10" id="h45-4-10" class="d">-                }
</a><a href="#h45-4-11" id="h45-4-11" class="d">-                lastFocusedConversationId = conversationId
</a><a href="#h45-4-12" id="h45-4-12" class="d">-                lastFocusedConversationType = context.database.getConversationType(conversationId) ?: 0
</a><a href="#h45-4-13" id="h45-4-13" class="d">-            }
</a><a href="#h45-4-14" id="h45-4-14" class="d">-        }
</a><a href="#h45-4-15" id="h45-4-15" class="d">-
</a><a href="#h45-4-16" id="h45-4-16" class="d">-        context.classCache.feedEntry.hookConstructor(HookStage.AFTER) { param -&gt;
</a><a href="#h45-4-17" id="h45-4-17" class="d">-            val instance = param.thisObject&lt;Any&gt;()
</a><a href="#h45-4-18" id="h45-4-18" class="d">-            val interactionInfo = instance.getObjectFieldOrNull(&quot;mInteractionInfo&quot;) ?: return@hookConstructor
</a><a href="#h45-4-19" id="h45-4-19" class="d">-            val messages = (interactionInfo.getObjectFieldOrNull(&quot;mMessages&quot;) as? List&lt;*&gt;)?.map { Message(it) } ?: return@hookConstructor
</a><a href="#h45-4-20" id="h45-4-20" class="d">-            val conversationId = SnapUUID(instance.getObjectFieldOrNull(&quot;mConversationId&quot;) ?: return@hookConstructor).toString()
</a><a href="#h45-4-21" id="h45-4-21" class="d">-            val myUserId = context.database.myUserId
</a><a href="#h45-4-22" id="h45-4-22" class="d">-
</a><a href="#h45-4-23" id="h45-4-23" class="d">-            feedCachedSnapMessages[conversationId] = messages.filter { msg -&gt;
</a><a href="#h45-4-24" id="h45-4-24" class="d">-                msg.messageMetadata?.openedBy?.none { it.toString() == myUserId } == true
</a><a href="#h45-4-25" id="h45-4-25" class="d">-            }.sortedBy { it.orderKey }.mapNotNull { it.messageDescriptor?.messageId }
</a><a href="#h45-4-26" id="h45-4-26" class="d">-        }
</a><a href="#h45-4-27" id="h45-4-27" class="d">-
</a><a href="#h45-4-28" id="h45-4-28" class="d">-        context.classCache.conversationManager.apply {
</a><a href="#h45-4-29" id="h45-4-29" class="d">-            hook(&quot;enterConversation&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h45-4-30" id="h45-4-30" class="d">-                openedConversationUUID = SnapUUID(param.arg(0))
</a><a href="#h45-4-31" id="h45-4-31" class="d">-                if (context.config.messaging.bypassMessageRetentionPolicy.get()) {
</a><a href="#h45-4-32" id="h45-4-32" class="d">-                    val callback = param.argNullable&lt;Any&gt;(2) ?: return@hook
</a><a href="#h45-4-33" id="h45-4-33" class="d">-                    callback::class.java.methods.firstOrNull { it.name == &quot;onSuccess&quot; }?.invoke(callback)
</a><a href="#h45-4-34" id="h45-4-34" class="d">-                    param.setResult(null)
</a><a href="#h45-4-35" id="h45-4-35" class="d">-                }
</a><a href="#h45-4-36" id="h45-4-36" class="d">-            }
</a><a href="#h45-4-37" id="h45-4-37" class="d">-
</a><a href="#h45-4-38" id="h45-4-38" class="d">-            hook(&quot;exitConversation&quot;, HookStage.BEFORE) {
</a><a href="#h45-4-39" id="h45-4-39" class="d">-                openedConversationUUID = null
</a><a href="#h45-4-40" id="h45-4-40" class="d">-            }
</a><a href="#h45-4-41" id="h45-4-41" class="d">-        }
</a><a href="#h45-4-42" id="h45-4-42" class="d">-    }
</a><a href="#h45-4-43" id="h45-4-43" class="d">-
</a><a href="#h45-4-44" id="h45-4-44" class="d">-    override fun asyncInit() {
</a><a href="#h45-4-45" id="h45-4-45" class="d">-        val stealthMode = context.feature(StealthMode::class)
</a><a href="#h45-4-46" id="h45-4-46" class="d">-
</a><a href="#h45-4-47" id="h45-4-47" class="d">-        arrayOf(&quot;activate&quot;, &quot;deactivate&quot;, &quot;processTypingActivity&quot;).forEach { hook -&gt;
</a><a href="#h45-4-48" id="h45-4-48" class="d">-            context.classCache.presenceSession.hook(hook, HookStage.BEFORE, {
</a><a href="#h45-4-49" id="h45-4-49" class="d">-                context.config.messaging.hideBitmojiPresence.get() || stealthMode.canUseRule(openedConversationUUID.toString())
</a><a href="#h45-4-50" id="h45-4-50" class="d">-            }) {
</a><a href="#h45-4-51" id="h45-4-51" class="d">-                it.setResult(null)
</a><a href="#h45-4-52" id="h45-4-52" class="d">-            }
</a><a href="#h45-4-53" id="h45-4-53" class="d">-        }
</a><a href="#h45-4-54" id="h45-4-54" class="d">-
</a><a href="#h45-4-55" id="h45-4-55" class="d">-        context.classCache.presenceSession.hook(&quot;startPeeking&quot;, HookStage.BEFORE, {
</a><a href="#h45-4-56" id="h45-4-56" class="d">-            context.config.messaging.hidePeekAPeek.get() || stealthMode.canUseRule(openedConversationUUID.toString())
</a><a href="#h45-4-57" id="h45-4-57" class="d">-        }) { it.setResult(null) }
</a><a href="#h45-4-58" id="h45-4-58" class="d">-
</a><a href="#h45-4-59" id="h45-4-59" class="d">-        //get last opened snap for media downloader
</a><a href="#h45-4-60" id="h45-4-60" class="d">-        context.event.subscribe(OnSnapInteractionEvent::class) { event -&gt;
</a><a href="#h45-4-61" id="h45-4-61" class="d">-            openedConversationUUID = event.conversationId
</a><a href="#h45-4-62" id="h45-4-62" class="d">-            lastFocusedMessageId = event.messageId
</a><a href="#h45-4-63" id="h45-4-63" class="d">-        }
</a><a href="#h45-4-64" id="h45-4-64" class="d">-
</a><a href="#h45-4-65" id="h45-4-65" class="d">-        context.classCache.conversationManager.hook(&quot;fetchMessage&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h45-4-66" id="h45-4-66" class="d">-            val conversationId = SnapUUID(param.arg(0)).toString()
</a><a href="#h45-4-67" id="h45-4-67" class="d">-            if (openedConversationUUID?.toString() == conversationId) {
</a><a href="#h45-4-68" id="h45-4-68" class="d">-                lastFocusedMessageId = param.arg(1)
</a><a href="#h45-4-69" id="h45-4-69" class="d">-            }
</a><a href="#h45-4-70" id="h45-4-70" class="d">-        }
</a><a href="#h45-4-71" id="h45-4-71" class="d">-
</a><a href="#h45-4-72" id="h45-4-72" class="d">-        context.classCache.conversationManager.hook(&quot;sendTypingNotification&quot;, HookStage.BEFORE, {
</a><a href="#h45-4-73" id="h45-4-73" class="d">-            context.config.messaging.hideTypingNotifications.get() || stealthMode.canUseRule(openedConversationUUID.toString())
</a><a href="#h45-4-74" id="h45-4-74" class="d">-        }) {
</a><a href="#h45-4-75" id="h45-4-75" class="d">-            it.setResult(null)
</a><a href="#h45-4-76" id="h45-4-76" class="d">-        }
</a><a href="#h45-4-77" id="h45-4-77" class="d">-    }
</a><a href="#h45-4-78" id="h45-4-78" class="d">-
</a>     fun fetchSnapchatterInfos(userIds: List&lt;String&gt;): List&lt;Snapchatter&gt; {
         val identity = identityDelegate ?: return emptyList()
         val snapUUIDs = userIds.map {
<b>diff --git a/<a id="h46" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/Notifications.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/Notifications.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/Notifications.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/Notifications.kt</a></b>
<a href="#h46-0" id="h46-0" class="h">@@ -23,7 +23,6 @@ import me.rhunk.snapenhance.common.util.snap.MediaDownloaderHelper
</a> import me.rhunk.snapenhance.common.util.snap.SnapWidgetBroadcastReceiverHelper
 import me.rhunk.snapenhance.core.event.events.impl.SnapWidgetBroadcastReceiveEvent
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h46-0-3" id="h46-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.features.impl.FriendMutationObserver
 import me.rhunk.snapenhance.core.features.impl.downloader.MediaDownloader
 import me.rhunk.snapenhance.core.features.impl.downloader.decoder.AttachmentType
<a href="#h46-1" id="h46-1" class="h">@@ -39,7 +38,7 @@ import me.rhunk.snapenhance.core.wrapper.impl.SnapUUID
</a> import okhttp3.RequestBody.Companion.toRequestBody
 import kotlin.coroutines.suspendCoroutine
 
<a href="#h46-1-3" id="h46-1-3" class="d">-class Notifications : Feature(&quot;Notifications&quot;, loadParams = FeatureLoadParams.INIT_SYNC) {
</a><a href="#h46-1-4" id="h46-1-4" class="i">+class Notifications : Feature(&quot;Notifications&quot;) {
</a>     inner class NotificationData(
         val tag: String?,
         val id: Int,
<a href="#h46-2" id="h46-2" class="h">@@ -301,7 +300,7 @@ class Notifications : Feature(&quot;Notifications&quot;, loadParams = FeatureLoadParams.IN
</a>                     )
                 }
             }.onFailure {
<a href="#h46-2-3" id="h46-2-3" class="d">-                context.log.warn(&quot;Failed to set notification group key: ${it.stackTraceToString()}&quot;, featureKey)
</a><a href="#h46-2-4" id="h46-2-4" class="i">+                context.log.warn(&quot;Failed to set notification group key: ${it.stackTraceToString()}&quot;, key)
</a>             }
         }
 
<b>diff --git a/<a id="h47" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/PreventMessageSending.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/PreventMessageSending.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/PreventMessageSending.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/PreventMessageSending.kt</a></b>
<a href="#h47-0" id="h47-0" class="h">@@ -5,12 +5,11 @@ import me.rhunk.snapenhance.common.util.protobuf.ProtoEditor
</a> import me.rhunk.snapenhance.core.event.events.impl.NativeUnaryCallEvent
 import me.rhunk.snapenhance.core.event.events.impl.SendMessageWithContentEvent
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h47-0-3" id="h47-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.util.hook.HookStage
 import me.rhunk.snapenhance.core.util.hook.hook
 
<a href="#h47-0-7" id="h47-0-7" class="d">-class PreventMessageSending : Feature(&quot;Prevent message sending&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_ASYNC) {
</a><a href="#h47-0-8" id="h47-0-8" class="d">-    override fun asyncOnActivityCreate() {
</a><a href="#h47-0-9" id="h47-0-9" class="i">+class PreventMessageSending : Feature(&quot;Prevent message sending&quot;) {
</a><a href="#h47-0-10" id="h47-0-10" class="i">+    override fun init() {
</a>         val preventMessageSending by context.config.messaging.preventMessageSending
 
         context.event.subscribe(NativeUnaryCallEvent::class, { preventMessageSending.contains(&quot;snap_replay&quot;) }) { event -&gt;
<b>diff --git a/<a id="h48" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/SendOverride.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/SendOverride.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/SendOverride.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/SendOverride.kt</a></b>
<a href="#h48-0" id="h48-0" class="h">@@ -8,14 +8,13 @@ import me.rhunk.snapenhance.common.util.protobuf.ProtoReader
</a> import me.rhunk.snapenhance.core.event.events.impl.NativeUnaryCallEvent
 import me.rhunk.snapenhance.core.event.events.impl.SendMessageWithContentEvent
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h48-0-3" id="h48-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.features.impl.experiments.MediaFilePicker
 import me.rhunk.snapenhance.core.messaging.MessageSender
 import me.rhunk.snapenhance.core.ui.ViewAppearanceHelper
 import me.rhunk.snapenhance.nativelib.NativeLib
 import java.util.Locale
 
<a href="#h48-0-10" id="h48-0-10" class="d">-class SendOverride : Feature(&quot;Send Override&quot;, loadParams = FeatureLoadParams.INIT_SYNC) {
</a><a href="#h48-0-11" id="h48-0-11" class="i">+class SendOverride : Feature(&quot;Send Override&quot;) {
</a>     private var isLastSnapSavable = false
     private val typeNames by lazy {
         mutableListOf(&quot;ORIGINAL&quot;, &quot;SNAP&quot;, &quot;NOTE&quot;).also {
<b>diff --git a/<a id="h49" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/UnlimitedSnapViewTime.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/UnlimitedSnapViewTime.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/UnlimitedSnapViewTime.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/UnlimitedSnapViewTime.kt</a></b>
<a href="#h49-0" id="h49-0" class="h">@@ -6,27 +6,27 @@ import me.rhunk.snapenhance.common.util.protobuf.ProtoEditor
</a> import me.rhunk.snapenhance.common.util.protobuf.ProtoReader
 import me.rhunk.snapenhance.core.event.events.impl.BuildMessageEvent
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h49-0-3" id="h49-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> 
<a href="#h49-0-5" id="h49-0-5" class="d">-class UnlimitedSnapViewTime :
</a><a href="#h49-0-6" id="h49-0-6" class="d">-    Feature(&quot;UnlimitedSnapViewTime&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_SYNC) {
</a><a href="#h49-0-7" id="h49-0-7" class="d">-    override fun onActivityCreate() {
</a><a href="#h49-0-8" id="h49-0-8" class="d">-        val state by context.config.messaging.unlimitedSnapViewTime
</a><a href="#h49-0-9" id="h49-0-9" class="i">+class UnlimitedSnapViewTime : Feature(&quot;UnlimitedSnapViewTime&quot;) {
</a><a href="#h49-0-10" id="h49-0-10" class="i">+    override fun init() {
</a><a href="#h49-0-11" id="h49-0-11" class="i">+        onNextActivityCreate {
</a><a href="#h49-0-12" id="h49-0-12" class="i">+            val state by context.config.messaging.unlimitedSnapViewTime
</a> 
<a href="#h49-0-14" id="h49-0-14" class="d">-        context.event.subscribe(BuildMessageEvent::class, { state }, priority = 101) { event -&gt;
</a><a href="#h49-0-15" id="h49-0-15" class="d">-            if (event.message.messageState != MessageState.COMMITTED) return@subscribe
</a><a href="#h49-0-16" id="h49-0-16" class="d">-            if (event.message.messageContent!!.contentType != ContentType.SNAP) return@subscribe
</a><a href="#h49-0-17" id="h49-0-17" class="i">+            context.event.subscribe(BuildMessageEvent::class, { state }, priority = 101) { event -&gt;
</a><a href="#h49-0-18" id="h49-0-18" class="i">+                if (event.message.messageState != MessageState.COMMITTED) return@subscribe
</a><a href="#h49-0-19" id="h49-0-19" class="i">+                if (event.message.messageContent!!.contentType != ContentType.SNAP) return@subscribe
</a> 
<a href="#h49-0-21" id="h49-0-21" class="d">-            val messageContent = event.message.messageContent
</a><a href="#h49-0-22" id="h49-0-22" class="i">+                val messageContent = event.message.messageContent
</a> 
<a href="#h49-0-24" id="h49-0-24" class="d">-            val mediaAttributes = ProtoReader(messageContent!!.content!!).followPath(11, 5, 2) ?: return@subscribe
</a><a href="#h49-0-25" id="h49-0-25" class="d">-            if (mediaAttributes.contains(6)) return@subscribe
</a><a href="#h49-0-26" id="h49-0-26" class="d">-            messageContent.content = ProtoEditor(messageContent.content!!).apply {
</a><a href="#h49-0-27" id="h49-0-27" class="d">-                edit(11, 5, 2) {
</a><a href="#h49-0-28" id="h49-0-28" class="d">-                    remove(8)
</a><a href="#h49-0-29" id="h49-0-29" class="d">-                    addBuffer(6, byteArrayOf())
</a><a href="#h49-0-30" id="h49-0-30" class="d">-                }
</a><a href="#h49-0-31" id="h49-0-31" class="d">-            }.toByteArray()
</a><a href="#h49-0-32" id="h49-0-32" class="i">+                val mediaAttributes = ProtoReader(messageContent!!.content!!).followPath(11, 5, 2) ?: return@subscribe
</a><a href="#h49-0-33" id="h49-0-33" class="i">+                if (mediaAttributes.contains(6)) return@subscribe
</a><a href="#h49-0-34" id="h49-0-34" class="i">+                messageContent.content = ProtoEditor(messageContent.content!!).apply {
</a><a href="#h49-0-35" id="h49-0-35" class="i">+                    edit(11, 5, 2) {
</a><a href="#h49-0-36" id="h49-0-36" class="i">+                        remove(8)
</a><a href="#h49-0-37" id="h49-0-37" class="i">+                        addBuffer(6, byteArrayOf())
</a><a href="#h49-0-38" id="h49-0-38" class="i">+                    }
</a><a href="#h49-0-39" id="h49-0-39" class="i">+                }.toByteArray()
</a><a href="#h49-0-40" id="h49-0-40" class="i">+            }
</a>         }
     }
 }
<b>diff --git a/<a id="h50" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/spying/FriendTracker.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/spying/FriendTracker.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/spying/FriendTracker.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/spying/FriendTracker.kt</a></b>
<a href="#h50-0" id="h50-0" class="h">@@ -12,7 +12,6 @@ import me.rhunk.snapenhance.common.util.lazyBridge
</a> import me.rhunk.snapenhance.common.util.protobuf.ProtoReader
 import me.rhunk.snapenhance.common.util.toParcelable
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h50-0-3" id="h50-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.features.impl.messaging.Messaging
 import me.rhunk.snapenhance.core.util.hook.HookStage
 import me.rhunk.snapenhance.core.util.hook.hook
<a href="#h50-1" id="h50-1" class="h">@@ -23,7 +22,7 @@ import me.rhunk.snapenhance.nativelib.NativeLib
</a> import java.lang.reflect.Method
 import java.nio.ByteBuffer
 
<a href="#h50-1-3" id="h50-1-3" class="d">-class FriendTracker : Feature(&quot;Friend Tracker&quot;, loadParams = FeatureLoadParams.INIT_SYNC) {
</a><a href="#h50-1-4" id="h50-1-4" class="i">+class FriendTracker : Feature(&quot;Friend Tracker&quot;) {
</a>     private val conversationPresenceState = mutableMapOf&lt;String, MutableMap&lt;String, FriendPresenceState?&gt;&gt;() // conversationId -&gt; (userId -&gt; state)
     private val tracker by lazyBridge { context.bridgeClient.getTracker() }
     private val notificationManager by lazy { context.androidContext.getSystemService(NotificationManager::class.java).apply {
<b>diff --git a/<a id="h51" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/spying/HalfSwipeNotifier.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/spying/HalfSwipeNotifier.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/spying/HalfSwipeNotifier.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/spying/HalfSwipeNotifier.kt</a></b>
<a href="#h51-0" id="h51-0" class="h">@@ -6,7 +6,6 @@ import android.app.NotificationManager
</a> import android.app.PendingIntent
 import me.rhunk.snapenhance.common.Constants
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h51-0-3" id="h51-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.util.hook.HookStage
 import me.rhunk.snapenhance.core.util.hook.hook
 import me.rhunk.snapenhance.core.util.hook.hookConstructor
<a href="#h51-1" id="h51-1" class="h">@@ -16,7 +15,7 @@ import me.rhunk.snapenhance.mapper.impl.CallbackMapper
</a> import java.util.concurrent.ConcurrentHashMap
 import kotlin.time.Duration.Companion.milliseconds
 
<a href="#h51-1-3" id="h51-1-3" class="d">-class HalfSwipeNotifier : Feature(&quot;Half Swipe Notifier&quot;, loadParams = FeatureLoadParams.INIT_SYNC) {
</a><a href="#h51-1-4" id="h51-1-4" class="i">+class HalfSwipeNotifier : Feature(&quot;Half Swipe Notifier&quot;) {
</a>     private val peekingConversations = ConcurrentHashMap&lt;String, List&lt;String&gt;&gt;()
     private val startPeekingTimestamps = ConcurrentHashMap&lt;String, Long&gt;()
 
<b>diff --git a/<a id="h52" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/spying/MessageLogger.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/spying/MessageLogger.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/spying/MessageLogger.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/spying/MessageLogger.kt</a></b>
<a href="#h52-0" id="h52-0" class="h">@@ -18,18 +18,13 @@ import me.rhunk.snapenhance.common.util.protobuf.ProtoReader
</a> import me.rhunk.snapenhance.core.event.events.impl.BindViewEvent
 import me.rhunk.snapenhance.core.event.events.impl.BuildMessageEvent
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h52-0-3" id="h52-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.ui.addForegroundDrawable
 import me.rhunk.snapenhance.core.ui.removeForegroundDrawable
 import me.rhunk.snapenhance.core.util.EvictingMap
 import java.util.concurrent.Executors
 import kotlin.system.measureTimeMillis
 
<a href="#h52-0-10" id="h52-0-10" class="d">-class MessageLogger : Feature(&quot;MessageLogger&quot;,
</a><a href="#h52-0-11" id="h52-0-11" class="d">-    loadParams = FeatureLoadParams.INIT_SYNC or
</a><a href="#h52-0-12" id="h52-0-12" class="d">-        FeatureLoadParams.ACTIVITY_CREATE_SYNC or
</a><a href="#h52-0-13" id="h52-0-13" class="d">-        FeatureLoadParams.ACTIVITY_CREATE_ASYNC
</a><a href="#h52-0-14" id="h52-0-14" class="d">-) {
</a><a href="#h52-0-15" id="h52-0-15" class="i">+class MessageLogger : Feature(&quot;MessageLogger&quot;) {
</a>     companion object {
         const val PREFETCH_MESSAGE_COUNT = 20
         const val PREFETCH_FEED_COUNT = 20
<a href="#h52-1" id="h52-1" class="h">@@ -96,23 +91,20 @@ class MessageLogger : Feature(&quot;MessageLogger&quot;,
</a>         return computeMessageIdentifier(conversationId, serverMessageId)
     }
 
<a href="#h52-1-3" id="h52-1-3" class="d">-    override fun asyncOnActivityCreate() {
</a><a href="#h52-1-4" id="h52-1-4" class="d">-        if (!isEnabled || !context.database.hasArroyo()) {
</a><a href="#h52-1-5" id="h52-1-5" class="d">-            return
</a><a href="#h52-1-6" id="h52-1-6" class="d">-        }
</a><a href="#h52-1-7" id="h52-1-7" class="d">-
</a><a href="#h52-1-8" id="h52-1-8" class="d">-        measureTimeMillis {
</a><a href="#h52-1-9" id="h52-1-9" class="d">-            val conversationIds = context.database.getFeedEntries(PREFETCH_FEED_COUNT).map { it.key!! }
</a><a href="#h52-1-10" id="h52-1-10" class="d">-            if (conversationIds.isEmpty()) return@measureTimeMillis
</a><a href="#h52-1-11" id="h52-1-11" class="d">-            fetchedMessages.addAll(loggerInterface.getLoggedIds(conversationIds.toTypedArray(), PREFETCH_MESSAGE_COUNT).toList())
</a><a href="#h52-1-12" id="h52-1-12" class="d">-        }.also { context.log.verbose(&quot;Loaded ${fetchedMessages.size} cached messages in ${it}ms&quot;) }
</a><a href="#h52-1-13" id="h52-1-13" class="d">-    }
</a><a href="#h52-1-14" id="h52-1-14" class="d">-
</a>     override fun init() {
         if (!isEnabled) return
         val keepMyOwnMessages = context.config.messaging.messageLogger.keepMyOwnMessages.get()
         val messageFilter by context.config.messaging.messageLogger.messageFilter
 
<a href="#h52-1-20" id="h52-1-20" class="i">+        onNextActivityCreate(defer = true) {
</a><a href="#h52-1-21" id="h52-1-21" class="i">+            if (!context.database.hasArroyo()) return@onNextActivityCreate
</a><a href="#h52-1-22" id="h52-1-22" class="i">+            measureTimeMillis {
</a><a href="#h52-1-23" id="h52-1-23" class="i">+                val conversationIds = context.database.getFeedEntries(PREFETCH_FEED_COUNT).map { it.key!! }
</a><a href="#h52-1-24" id="h52-1-24" class="i">+                if (conversationIds.isEmpty()) return@measureTimeMillis
</a><a href="#h52-1-25" id="h52-1-25" class="i">+                fetchedMessages.addAll(loggerInterface.getLoggedIds(conversationIds.toTypedArray(), PREFETCH_MESSAGE_COUNT).toList())
</a><a href="#h52-1-26" id="h52-1-26" class="i">+            }.also { context.log.verbose(&quot;Loaded ${fetchedMessages.size} cached messages in ${it}ms&quot;) }
</a><a href="#h52-1-27" id="h52-1-27" class="i">+        }
</a><a href="#h52-1-28" id="h52-1-28" class="i">+
</a>         context.event.subscribe(BuildMessageEvent::class, priority = 1) { event -&gt;
             val messageInstance = event.message.instanceNonNull()
             if (event.message.messageState != MessageState.COMMITTED) return@subscribe
<a href="#h52-2" id="h52-2" class="h">@@ -183,10 +175,6 @@ class MessageLogger : Feature(&quot;MessageLogger&quot;,
</a> 
             deletedMessageCache[uniqueMessageIdentifier] = deletedMessageObject
         }
<a href="#h52-2-3" id="h52-2-3" class="d">-    }
</a><a href="#h52-2-4" id="h52-2-4" class="d">-
</a><a href="#h52-2-5" id="h52-2-5" class="d">-    override fun onActivityCreate() {
</a><a href="#h52-2-6" id="h52-2-6" class="d">-        if (!isEnabled) return
</a> 
         context.event.subscribe(BindViewEvent::class) { event -&gt;
             event.chatMessage { conversationId, messageId -&gt;
<b>diff --git a/<a id="h53" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/spying/StealthMode.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/spying/StealthMode.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/spying/StealthMode.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/spying/StealthMode.kt</a></b>
<a href="#h53-0" id="h53-0" class="h">@@ -2,14 +2,13 @@ package me.rhunk.snapenhance.core.features.impl.spying
</a> 
 import me.rhunk.snapenhance.common.data.MessagingRuleType
 import me.rhunk.snapenhance.core.event.events.impl.OnSnapInteractionEvent
<a href="#h53-0-3" id="h53-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.features.MessagingRuleFeature
 import me.rhunk.snapenhance.core.util.hook.HookStage
 import me.rhunk.snapenhance.core.util.hook.hook
 import me.rhunk.snapenhance.core.wrapper.impl.SnapUUID
 import java.util.concurrent.CopyOnWriteArraySet
 
<a href="#h53-0-10" id="h53-0-10" class="d">-class StealthMode : MessagingRuleFeature(&quot;StealthMode&quot;, MessagingRuleType.STEALTH, loadParams = FeatureLoadParams.INIT_SYNC) {
</a><a href="#h53-0-11" id="h53-0-11" class="i">+class StealthMode : MessagingRuleFeature(&quot;StealthMode&quot;, MessagingRuleType.STEALTH) {
</a>     private val displayedMessageQueue = CopyOnWriteArraySet&lt;Long&gt;()
 
     fun addDisplayedMessageException(clientMessageId: Long) {
<b>diff --git a/<a id="h54" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/tweaks/BypassScreenshotDetection.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/tweaks/BypassScreenshotDetection.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/tweaks/BypassScreenshotDetection.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/tweaks/BypassScreenshotDetection.kt</a></b>
<a href="#h54-0" id="h54-0" class="h">@@ -5,12 +5,11 @@ import android.content.ContentResolver
</a> import android.database.ContentObserver
 import android.net.Uri
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h54-0-3" id="h54-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.util.hook.HookStage
 import me.rhunk.snapenhance.core.util.hook.hook
 
<a href="#h54-0-7" id="h54-0-7" class="d">-class BypassScreenshotDetection : Feature(&quot;BypassScreenshotDetection&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_SYNC) {
</a><a href="#h54-0-8" id="h54-0-8" class="d">-    override fun onActivityCreate() {
</a><a href="#h54-0-9" id="h54-0-9" class="i">+class BypassScreenshotDetection : Feature(&quot;BypassScreenshotDetection&quot;) {
</a><a href="#h54-0-10" id="h54-0-10" class="i">+    override fun init() {
</a>         if (!context.config.messaging.bypassScreenshotDetection.get()) return
         Activity::class.java.hook(&quot;registerScreenCaptureCallback&quot;, HookStage.BEFORE) { param -&gt;
             param.setResult(null)
<b>diff --git a/<a id="h55" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/tweaks/CameraTweaks.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/tweaks/CameraTweaks.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/tweaks/CameraTweaks.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/tweaks/CameraTweaks.kt</a></b>
<a href="#h55-0" id="h55-0" class="h">@@ -12,100 +12,101 @@ import android.media.Image
</a> import android.media.ImageReader
 import android.util.Range
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h55-0-3" id="h55-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.util.hook.HookStage
 import me.rhunk.snapenhance.core.util.hook.hook
 import me.rhunk.snapenhance.core.util.ktx.setObjectField
 import java.io.ByteArrayOutputStream
 import java.nio.ByteBuffer
 
<a href="#h55-0-10" id="h55-0-10" class="d">-class CameraTweaks : Feature(&quot;Camera Tweaks&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_SYNC) {
</a><a href="#h55-0-11" id="h55-0-11" class="i">+class CameraTweaks : Feature(&quot;Camera Tweaks&quot;) {
</a> 
     private fun parseResolution(resolution: String): IntArray? {
         return runCatching { resolution.split(&quot;x&quot;).map { it.toInt() }.toIntArray() }.getOrNull()
     }
 
     @SuppressLint(&quot;MissingPermission&quot;, &quot;DiscouragedApi&quot;)
<a href="#h55-0-18" id="h55-0-18" class="d">-    override fun onActivityCreate() {
</a><a href="#h55-0-19" id="h55-0-19" class="d">-        val config = context.config.camera
</a><a href="#h55-0-20" id="h55-0-20" class="d">-
</a><a href="#h55-0-21" id="h55-0-21" class="d">-        val frontCameraId = runCatching { context.androidContext.getSystemService(CameraManager::class.java).run {
</a><a href="#h55-0-22" id="h55-0-22" class="d">-            cameraIdList.firstOrNull { getCameraCharacteristics(it).get(CameraCharacteristics.LENS_FACING) == CameraCharacteristics.LENS_FACING_FRONT }
</a><a href="#h55-0-23" id="h55-0-23" class="d">-        } }.getOrNull()
</a><a href="#h55-0-24" id="h55-0-24" class="d">-
</a><a href="#h55-0-25" id="h55-0-25" class="d">-        if (config.disableCameras.get().isNotEmpty() &amp;&amp; frontCameraId != null) {
</a><a href="#h55-0-26" id="h55-0-26" class="d">-            ContextWrapper::class.java.hook(&quot;checkPermission&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h55-0-27" id="h55-0-27" class="d">-                val permission = param.arg&lt;String&gt;(0)
</a><a href="#h55-0-28" id="h55-0-28" class="d">-                if (permission == Manifest.permission.CAMERA) {
</a><a href="#h55-0-29" id="h55-0-29" class="d">-                    param.setResult(PackageManager.PERMISSION_GRANTED)
</a><a href="#h55-0-30" id="h55-0-30" class="i">+    override fun init() {
</a><a href="#h55-0-31" id="h55-0-31" class="i">+        onNextActivityCreate {
</a><a href="#h55-0-32" id="h55-0-32" class="i">+            val config = context.config.camera
</a><a href="#h55-0-33" id="h55-0-33" class="i">+
</a><a href="#h55-0-34" id="h55-0-34" class="i">+            val frontCameraId = runCatching { context.androidContext.getSystemService(CameraManager::class.java).run {
</a><a href="#h55-0-35" id="h55-0-35" class="i">+                cameraIdList.firstOrNull { getCameraCharacteristics(it).get(CameraCharacteristics.LENS_FACING) == CameraCharacteristics.LENS_FACING_FRONT }
</a><a href="#h55-0-36" id="h55-0-36" class="i">+            } }.getOrNull()
</a><a href="#h55-0-37" id="h55-0-37" class="i">+
</a><a href="#h55-0-38" id="h55-0-38" class="i">+            if (config.disableCameras.get().isNotEmpty() &amp;&amp; frontCameraId != null) {
</a><a href="#h55-0-39" id="h55-0-39" class="i">+                ContextWrapper::class.java.hook(&quot;checkPermission&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h55-0-40" id="h55-0-40" class="i">+                    val permission = param.arg&lt;String&gt;(0)
</a><a href="#h55-0-41" id="h55-0-41" class="i">+                    if (permission == Manifest.permission.CAMERA) {
</a><a href="#h55-0-42" id="h55-0-42" class="i">+                        param.setResult(PackageManager.PERMISSION_GRANTED)
</a><a href="#h55-0-43" id="h55-0-43" class="i">+                    }
</a>                 }
             }
<a href="#h55-0-46" id="h55-0-46" class="d">-        }
</a> 
<a href="#h55-0-48" id="h55-0-48" class="d">-        var isLastCameraFront = false
</a><a href="#h55-0-49" id="h55-0-49" class="i">+            var isLastCameraFront = false
</a> 
<a href="#h55-0-51" id="h55-0-51" class="d">-        CameraManager::class.java.hook(&quot;openCamera&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h55-0-52" id="h55-0-52" class="d">-            val cameraManager = param.thisObject() as? CameraManager ?: return@hook
</a><a href="#h55-0-53" id="h55-0-53" class="d">-            val cameraId = param.arg&lt;String&gt;(0)
</a><a href="#h55-0-54" id="h55-0-54" class="d">-            val disabledCameras = config.disableCameras.get()
</a><a href="#h55-0-55" id="h55-0-55" class="i">+            CameraManager::class.java.hook(&quot;openCamera&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h55-0-56" id="h55-0-56" class="i">+                val cameraManager = param.thisObject() as? CameraManager ?: return@hook
</a><a href="#h55-0-57" id="h55-0-57" class="i">+                val cameraId = param.arg&lt;String&gt;(0)
</a><a href="#h55-0-58" id="h55-0-58" class="i">+                val disabledCameras = config.disableCameras.get()
</a> 
<a href="#h55-0-60" id="h55-0-60" class="d">-            if (disabledCameras.size &gt;= 2) {
</a><a href="#h55-0-61" id="h55-0-61" class="d">-                param.setResult(null)
</a><a href="#h55-0-62" id="h55-0-62" class="d">-                return@hook
</a><a href="#h55-0-63" id="h55-0-63" class="d">-            }
</a><a href="#h55-0-64" id="h55-0-64" class="i">+                if (disabledCameras.size &gt;= 2) {
</a><a href="#h55-0-65" id="h55-0-65" class="i">+                    param.setResult(null)
</a><a href="#h55-0-66" id="h55-0-66" class="i">+                    return@hook
</a><a href="#h55-0-67" id="h55-0-67" class="i">+                }
</a> 
<a href="#h55-0-69" id="h55-0-69" class="d">-            isLastCameraFront = cameraId == frontCameraId
</a><a href="#h55-0-70" id="h55-0-70" class="i">+                isLastCameraFront = cameraId == frontCameraId
</a> 
<a href="#h55-0-72" id="h55-0-72" class="d">-            if (disabledCameras.size != 1) return@hook
</a><a href="#h55-0-73" id="h55-0-73" class="i">+                if (disabledCameras.size != 1) return@hook
</a> 
<a href="#h55-0-75" id="h55-0-75" class="d">-            // trick to replace unwanted camera with another one
</a><a href="#h55-0-76" id="h55-0-76" class="d">-            if ((disabledCameras.contains(&quot;front&quot;) &amp;&amp; isLastCameraFront) || (disabledCameras.contains(&quot;back&quot;) &amp;&amp; !isLastCameraFront)) {
</a><a href="#h55-0-77" id="h55-0-77" class="d">-                param.setArg(0, cameraManager.cameraIdList.filterNot { it == cameraId }.firstOrNull() ?: return@hook)
</a><a href="#h55-0-78" id="h55-0-78" class="d">-                isLastCameraFront = !isLastCameraFront
</a><a href="#h55-0-79" id="h55-0-79" class="i">+                // trick to replace unwanted camera with another one
</a><a href="#h55-0-80" id="h55-0-80" class="i">+                if ((disabledCameras.contains(&quot;front&quot;) &amp;&amp; isLastCameraFront) || (disabledCameras.contains(&quot;back&quot;) &amp;&amp; !isLastCameraFront)) {
</a><a href="#h55-0-81" id="h55-0-81" class="i">+                    param.setArg(0, cameraManager.cameraIdList.filterNot { it == cameraId }.firstOrNull() ?: return@hook)
</a><a href="#h55-0-82" id="h55-0-82" class="i">+                    isLastCameraFront = !isLastCameraFront
</a><a href="#h55-0-83" id="h55-0-83" class="i">+                }
</a>             }
<a href="#h55-0-85" id="h55-0-85" class="d">-        }
</a><a href="#h55-0-86" id="h55-0-86" class="d">-
</a><a href="#h55-0-87" id="h55-0-87" class="d">-        ImageReader::class.java.hook(&quot;newInstance&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h55-0-88" id="h55-0-88" class="d">-            val captureResolutionConfig = config.customResolution.getNullable()?.takeIf { it.isNotEmpty() }?.let { parseResolution(it) }
</a><a href="#h55-0-89" id="h55-0-89" class="d">-                ?: (if (isLastCameraFront) config.overrideFrontResolution.getNullable() else config.overrideBackResolution.getNullable())?.let { parseResolution(it) } ?: return@hook
</a><a href="#h55-0-90" id="h55-0-90" class="d">-            param.setArg(0, captureResolutionConfig[0])
</a><a href="#h55-0-91" id="h55-0-91" class="d">-            param.setArg(1, captureResolutionConfig[1])
</a><a href="#h55-0-92" id="h55-0-92" class="d">-        }
</a> 
<a href="#h55-0-94" id="h55-0-94" class="d">-        CameraCharacteristics::class.java.hook(&quot;get&quot;, HookStage.AFTER)  { param -&gt;
</a><a href="#h55-0-95" id="h55-0-95" class="d">-            val key = param.argNullable&lt;Key&lt;*&gt;&gt;(0) ?: return@hook
</a><a href="#h55-0-96" id="h55-0-96" class="i">+            ImageReader::class.java.hook(&quot;newInstance&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h55-0-97" id="h55-0-97" class="i">+                val captureResolutionConfig = config.customResolution.getNullable()?.takeIf { it.isNotEmpty() }?.let { parseResolution(it) }
</a><a href="#h55-0-98" id="h55-0-98" class="i">+                    ?: (if (isLastCameraFront) config.overrideFrontResolution.getNullable() else config.overrideBackResolution.getNullable())?.let { parseResolution(it) } ?: return@hook
</a><a href="#h55-0-99" id="h55-0-99" class="i">+                param.setArg(0, captureResolutionConfig[0])
</a><a href="#h55-0-100" id="h55-0-100" class="i">+                param.setArg(1, captureResolutionConfig[1])
</a><a href="#h55-0-101" id="h55-0-101" class="i">+            }
</a> 
<a href="#h55-0-103" id="h55-0-103" class="d">-            if (key == CameraCharacteristics.LENS_FACING) {
</a><a href="#h55-0-104" id="h55-0-104" class="d">-                val disabledCameras = config.disableCameras.get()
</a><a href="#h55-0-105" id="h55-0-105" class="d">-                //FIXME: unexpected behavior when app is resumed
</a><a href="#h55-0-106" id="h55-0-106" class="d">-                if (disabledCameras.size == 1) {
</a><a href="#h55-0-107" id="h55-0-107" class="d">-                    val isFrontCamera = param.getResult() as? Int == CameraCharacteristics.LENS_FACING_FRONT
</a><a href="#h55-0-108" id="h55-0-108" class="d">-                    if ((disabledCameras.contains(&quot;front&quot;) &amp;&amp; isFrontCamera) || (disabledCameras.contains(&quot;back&quot;) &amp;&amp; !isFrontCamera)) {
</a><a href="#h55-0-109" id="h55-0-109" class="d">-                        param.setResult(if (isFrontCamera) CameraCharacteristics.LENS_FACING_BACK else CameraCharacteristics.LENS_FACING_FRONT)
</a><a href="#h55-0-110" id="h55-0-110" class="i">+            CameraCharacteristics::class.java.hook(&quot;get&quot;, HookStage.AFTER)  { param -&gt;
</a><a href="#h55-0-111" id="h55-0-111" class="i">+                val key = param.argNullable&lt;Key&lt;*&gt;&gt;(0) ?: return@hook
</a><a href="#h55-0-112" id="h55-0-112" class="i">+
</a><a href="#h55-0-113" id="h55-0-113" class="i">+                if (key == CameraCharacteristics.LENS_FACING) {
</a><a href="#h55-0-114" id="h55-0-114" class="i">+                    val disabledCameras = config.disableCameras.get()
</a><a href="#h55-0-115" id="h55-0-115" class="i">+                    //FIXME: unexpected behavior when app is resumed
</a><a href="#h55-0-116" id="h55-0-116" class="i">+                    if (disabledCameras.size == 1) {
</a><a href="#h55-0-117" id="h55-0-117" class="i">+                        val isFrontCamera = param.getResult() as? Int == CameraCharacteristics.LENS_FACING_FRONT
</a><a href="#h55-0-118" id="h55-0-118" class="i">+                        if ((disabledCameras.contains(&quot;front&quot;) &amp;&amp; isFrontCamera) || (disabledCameras.contains(&quot;back&quot;) &amp;&amp; !isFrontCamera)) {
</a><a href="#h55-0-119" id="h55-0-119" class="i">+                            param.setResult(if (isFrontCamera) CameraCharacteristics.LENS_FACING_BACK else CameraCharacteristics.LENS_FACING_FRONT)
</a><a href="#h55-0-120" id="h55-0-120" class="i">+                        }
</a>                     }
                 }
<a href="#h55-0-123" id="h55-0-123" class="d">-            }
</a> 
<a href="#h55-0-125" id="h55-0-125" class="d">-            if (key == CameraCharacteristics.CONTROL_AE_AVAILABLE_TARGET_FPS_RANGES) {
</a><a href="#h55-0-126" id="h55-0-126" class="d">-                val isFrontCamera = param.invokeOriginal(
</a><a href="#h55-0-127" id="h55-0-127" class="d">-                    arrayOf(CameraCharacteristics.LENS_FACING)
</a><a href="#h55-0-128" id="h55-0-128" class="d">-                ) == CameraCharacteristics.LENS_FACING_FRONT
</a><a href="#h55-0-129" id="h55-0-129" class="d">-                val customFrameRate = (if (isFrontCamera) config.frontCustomFrameRate.getNullable() else config.backCustomFrameRate.getNullable())?.toIntOrNull() ?: return@hook
</a><a href="#h55-0-130" id="h55-0-130" class="d">-                param.setResult(arrayOf(Range(customFrameRate, customFrameRate)))
</a><a href="#h55-0-131" id="h55-0-131" class="i">+                if (key == CameraCharacteristics.CONTROL_AE_AVAILABLE_TARGET_FPS_RANGES) {
</a><a href="#h55-0-132" id="h55-0-132" class="i">+                    val isFrontCamera = param.invokeOriginal(
</a><a href="#h55-0-133" id="h55-0-133" class="i">+                        arrayOf(CameraCharacteristics.LENS_FACING)
</a><a href="#h55-0-134" id="h55-0-134" class="i">+                    ) == CameraCharacteristics.LENS_FACING_FRONT
</a><a href="#h55-0-135" id="h55-0-135" class="i">+                    val customFrameRate = (if (isFrontCamera) config.frontCustomFrameRate.getNullable() else config.backCustomFrameRate.getNullable())?.toIntOrNull() ?: return@hook
</a><a href="#h55-0-136" id="h55-0-136" class="i">+                    param.setResult(arrayOf(Range(customFrameRate, customFrameRate)))
</a><a href="#h55-0-137" id="h55-0-137" class="i">+                }
</a>             }
<a href="#h55-0-139" id="h55-0-139" class="d">-        }
</a> 
<a href="#h55-0-141" id="h55-0-141" class="d">-        if (config.blackPhotos.get()) {
</a><a href="#h55-0-142" id="h55-0-142" class="d">-            findClass(&quot;android.media.ImageReader\$SurfaceImage&quot;).hook(&quot;getPlanes&quot;, HookStage.AFTER) { param -&gt;
</a><a href="#h55-0-143" id="h55-0-143" class="d">-                val image = param.thisObject() as? Image ?: return@hook
</a><a href="#h55-0-144" id="h55-0-144" class="d">-                val planes = param.getResult() as? Array&lt;*&gt; ?: return@hook
</a><a href="#h55-0-145" id="h55-0-145" class="d">-                val output = ByteArrayOutputStream()
</a><a href="#h55-0-146" id="h55-0-146" class="d">-                Bitmap.createBitmap(image.width, image.height, Bitmap.Config.ARGB_8888).apply {
</a><a href="#h55-0-147" id="h55-0-147" class="d">-                    compress(Bitmap.CompressFormat.JPEG, 100, output)
</a><a href="#h55-0-148" id="h55-0-148" class="d">-                    recycle()
</a><a href="#h55-0-149" id="h55-0-149" class="d">-                }
</a><a href="#h55-0-150" id="h55-0-150" class="d">-                planes.filterNotNull().forEach { plane -&gt;
</a><a href="#h55-0-151" id="h55-0-151" class="d">-                    plane.setObjectField(&quot;mBuffer&quot;, ByteBuffer.wrap(output.toByteArray()))
</a><a href="#h55-0-152" id="h55-0-152" class="i">+            if (config.blackPhotos.get()) {
</a><a href="#h55-0-153" id="h55-0-153" class="i">+                findClass(&quot;android.media.ImageReader\$SurfaceImage&quot;).hook(&quot;getPlanes&quot;, HookStage.AFTER) { param -&gt;
</a><a href="#h55-0-154" id="h55-0-154" class="i">+                    val image = param.thisObject() as? Image ?: return@hook
</a><a href="#h55-0-155" id="h55-0-155" class="i">+                    val planes = param.getResult() as? Array&lt;*&gt; ?: return@hook
</a><a href="#h55-0-156" id="h55-0-156" class="i">+                    val output = ByteArrayOutputStream()
</a><a href="#h55-0-157" id="h55-0-157" class="i">+                    Bitmap.createBitmap(image.width, image.height, Bitmap.Config.ARGB_8888).apply {
</a><a href="#h55-0-158" id="h55-0-158" class="i">+                        compress(Bitmap.CompressFormat.JPEG, 100, output)
</a><a href="#h55-0-159" id="h55-0-159" class="i">+                        recycle()
</a><a href="#h55-0-160" id="h55-0-160" class="i">+                    }
</a><a href="#h55-0-161" id="h55-0-161" class="i">+                    planes.filterNotNull().forEach { plane -&gt;
</a><a href="#h55-0-162" id="h55-0-162" class="i">+                        plane.setObjectField(&quot;mBuffer&quot;, ByteBuffer.wrap(output.toByteArray()))
</a><a href="#h55-0-163" id="h55-0-163" class="i">+                    }
</a>                 }
             }
         }
<b>diff --git a/<a id="h56" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/tweaks/DisablePermissionRequests.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/tweaks/DisablePermissionRequests.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/tweaks/DisablePermissionRequests.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/tweaks/DisablePermissionRequests.kt</a></b>
<a href="#h56-0" id="h56-0" class="h">@@ -4,11 +4,10 @@ import android.content.ContextWrapper
</a> import android.content.pm.PackageManager
 import me.rhunk.snapenhance.common.config.impl.Global
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h56-0-3" id="h56-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.util.hook.HookStage
 import me.rhunk.snapenhance.core.util.hook.hook
 
<a href="#h56-0-7" id="h56-0-7" class="d">-class DisablePermissionRequests : Feature(&quot;Disable Permission Requests&quot;, loadParams = FeatureLoadParams.INIT_SYNC) {
</a><a href="#h56-0-8" id="h56-0-8" class="i">+class DisablePermissionRequests : Feature(&quot;Disable Permission Requests&quot;) {
</a>     override fun init() {
         val deniedPermissions by context.config.global.disablePermissionRequests
         if (deniedPermissions.isEmpty()) return
<b>diff --git a/<a id="h57" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/tweaks/HideActiveMusic.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/tweaks/HideActiveMusic.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/tweaks/HideActiveMusic.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/tweaks/HideActiveMusic.kt</a></b>
<a href="#h57-0" id="h57-0" class="h">@@ -2,15 +2,16 @@ package me.rhunk.snapenhance.core.features.impl.tweaks
</a> 
 import android.media.AudioManager
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h57-0-3" id="h57-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.util.hook.HookStage
 import me.rhunk.snapenhance.core.util.hook.hook
 
<a href="#h57-0-7" id="h57-0-7" class="d">-class HideActiveMusic: Feature(&quot;Hide Active Music&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_SYNC) {
</a><a href="#h57-0-8" id="h57-0-8" class="d">-    override fun onActivityCreate() {
</a><a href="#h57-0-9" id="h57-0-9" class="i">+class HideActiveMusic: Feature(&quot;Hide Active Music&quot;) {
</a><a href="#h57-0-10" id="h57-0-10" class="i">+    override fun init() {
</a>         if (!context.config.global.hideActiveMusic.get()) return
<a href="#h57-0-12" id="h57-0-12" class="d">-        AudioManager::class.java.hook(&quot;isMusicActive&quot;, HookStage.BEFORE) {
</a><a href="#h57-0-13" id="h57-0-13" class="d">-            it.setResult(false)
</a><a href="#h57-0-14" id="h57-0-14" class="i">+        onNextActivityCreate {
</a><a href="#h57-0-15" id="h57-0-15" class="i">+            AudioManager::class.java.hook(&quot;isMusicActive&quot;, HookStage.BEFORE) {
</a><a href="#h57-0-16" id="h57-0-16" class="i">+                it.setResult(false)
</a><a href="#h57-0-17" id="h57-0-17" class="i">+            }
</a>         }
     }
 } 
\ No newline at end of file
<b>diff --git a/<a id="h58" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/tweaks/PreventMessageListAutoScroll.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/tweaks/PreventMessageListAutoScroll.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/tweaks/PreventMessageListAutoScroll.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/tweaks/PreventMessageListAutoScroll.kt</a></b>
<a href="#h58-0" id="h58-0" class="h">@@ -4,73 +4,74 @@ import android.view.View
</a> import me.rhunk.snapenhance.core.event.events.impl.BindViewEvent
 import me.rhunk.snapenhance.core.event.events.impl.ConversationUpdateEvent
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h58-0-3" id="h58-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.util.hook.HookStage
 import me.rhunk.snapenhance.core.util.hook.hook
 import me.rhunk.snapenhance.core.wrapper.impl.SnapUUID
 
<a href="#h58-0-8" id="h58-0-8" class="d">-class PreventMessageListAutoScroll : Feature(&quot;PreventMessageListAutoScroll&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_SYNC) {
</a><a href="#h58-0-9" id="h58-0-9" class="i">+class PreventMessageListAutoScroll : Feature(&quot;PreventMessageListAutoScroll&quot;) {
</a>     private var openedConversationId: String? = null
     private val focusedMessages = mutableMapOf&lt;View, Long&gt;()
     private var firstFocusedMessageId: Long? = null
     private val delayedMessageUpdates = mutableListOf&lt;() -&gt; Unit&gt;()
 
<a href="#h58-0-15" id="h58-0-15" class="d">-    override fun onActivityCreate() {
</a><a href="#h58-0-16" id="h58-0-16" class="i">+    override fun init() {
</a>         if (!context.config.userInterface.preventMessageListAutoScroll.get()) return
 
<a href="#h58-0-19" id="h58-0-19" class="d">-        context.event.subscribe(ConversationUpdateEvent::class) { event -&gt;
</a><a href="#h58-0-20" id="h58-0-20" class="d">-            val updatedMessage = event.messages.firstOrNull() ?: return@subscribe
</a><a href="#h58-0-21" id="h58-0-21" class="d">-            if (openedConversationId != updatedMessage.messageDescriptor?.conversationId.toString()) return@subscribe
</a><a href="#h58-0-22" id="h58-0-22" class="i">+        onNextActivityCreate {
</a><a href="#h58-0-23" id="h58-0-23" class="i">+            context.event.subscribe(ConversationUpdateEvent::class) { event -&gt;
</a><a href="#h58-0-24" id="h58-0-24" class="i">+                val updatedMessage = event.messages.firstOrNull() ?: return@subscribe
</a><a href="#h58-0-25" id="h58-0-25" class="i">+                if (openedConversationId != updatedMessage.messageDescriptor?.conversationId.toString()) return@subscribe
</a> 
<a href="#h58-0-27" id="h58-0-27" class="d">-            // cancel if the message is already in focus
</a><a href="#h58-0-28" id="h58-0-28" class="d">-            if (focusedMessages.entries.any { entry -&gt; entry.value == updatedMessage.messageDescriptor?.messageId &amp;&amp; entry.key.isAttachedToWindow }) return@subscribe
</a><a href="#h58-0-29" id="h58-0-29" class="i">+                // cancel if the message is already in focus
</a><a href="#h58-0-30" id="h58-0-30" class="i">+                if (focusedMessages.entries.any { entry -&gt; entry.value == updatedMessage.messageDescriptor?.messageId &amp;&amp; entry.key.isAttachedToWindow }) return@subscribe
</a> 
<a href="#h58-0-32" id="h58-0-32" class="d">-            val conversationLastMessages = context.database.getMessagesFromConversationId(
</a><a href="#h58-0-33" id="h58-0-33" class="d">-                openedConversationId.toString(),
</a><a href="#h58-0-34" id="h58-0-34" class="d">-                4
</a><a href="#h58-0-35" id="h58-0-35" class="d">-            ) ?: return@subscribe
</a><a href="#h58-0-36" id="h58-0-36" class="i">+                val conversationLastMessages = context.database.getMessagesFromConversationId(
</a><a href="#h58-0-37" id="h58-0-37" class="i">+                    openedConversationId.toString(),
</a><a href="#h58-0-38" id="h58-0-38" class="i">+                    4
</a><a href="#h58-0-39" id="h58-0-39" class="i">+                ) ?: return@subscribe
</a> 
<a href="#h58-0-41" id="h58-0-41" class="d">-            if (conversationLastMessages.none {
</a><a href="#h58-0-42" id="h58-0-42" class="d">-                    focusedMessages.entries.any { entry -&gt; entry.value == it.clientMessageId.toLong() &amp;&amp; entry.key.isAttachedToWindow }
</a><a href="#h58-0-43" id="h58-0-43" class="d">-                }) {
</a><a href="#h58-0-44" id="h58-0-44" class="d">-                synchronized(delayedMessageUpdates) {
</a><a href="#h58-0-45" id="h58-0-45" class="d">-                    if (firstFocusedMessageId == null) firstFocusedMessageId = conversationLastMessages.lastOrNull()?.clientMessageId?.toLong()
</a><a href="#h58-0-46" id="h58-0-46" class="d">-                    delayedMessageUpdates.add {
</a><a href="#h58-0-47" id="h58-0-47" class="d">-                        event.adapter.invokeOriginal()
</a><a href="#h58-0-48" id="h58-0-48" class="i">+                if (conversationLastMessages.none {
</a><a href="#h58-0-49" id="h58-0-49" class="i">+                        focusedMessages.entries.any { entry -&gt; entry.value == it.clientMessageId.toLong() &amp;&amp; entry.key.isAttachedToWindow }
</a><a href="#h58-0-50" id="h58-0-50" class="i">+                    }) {
</a><a href="#h58-0-51" id="h58-0-51" class="i">+                    synchronized(delayedMessageUpdates) {
</a><a href="#h58-0-52" id="h58-0-52" class="i">+                        if (firstFocusedMessageId == null) firstFocusedMessageId = conversationLastMessages.lastOrNull()?.clientMessageId?.toLong()
</a><a href="#h58-0-53" id="h58-0-53" class="i">+                        delayedMessageUpdates.add {
</a><a href="#h58-0-54" id="h58-0-54" class="i">+                            event.adapter.invokeOriginal()
</a><a href="#h58-0-55" id="h58-0-55" class="i">+                        }
</a>                     }
<a href="#h58-0-57" id="h58-0-57" class="i">+                    event.adapter.setResult(null)
</a>                 }
<a href="#h58-0-59" id="h58-0-59" class="d">-                event.adapter.setResult(null)
</a>             }
<a href="#h58-0-61" id="h58-0-61" class="d">-        }
</a> 
<a href="#h58-0-63" id="h58-0-63" class="d">-        context.classCache.conversationManager.apply {
</a><a href="#h58-0-64" id="h58-0-64" class="d">-            hook(&quot;enterConversation&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h58-0-65" id="h58-0-65" class="d">-                openedConversationId = SnapUUID(param.arg(0)).toString()
</a><a href="#h58-0-66" id="h58-0-66" class="d">-            }
</a><a href="#h58-0-67" id="h58-0-67" class="d">-            hook(&quot;exitConversation&quot;, HookStage.BEFORE) {
</a><a href="#h58-0-68" id="h58-0-68" class="d">-                openedConversationId = null
</a><a href="#h58-0-69" id="h58-0-69" class="d">-                firstFocusedMessageId = null
</a><a href="#h58-0-70" id="h58-0-70" class="d">-                synchronized(focusedMessages) {
</a><a href="#h58-0-71" id="h58-0-71" class="d">-                    focusedMessages.clear()
</a><a href="#h58-0-72" id="h58-0-72" class="i">+            context.classCache.conversationManager.apply {
</a><a href="#h58-0-73" id="h58-0-73" class="i">+                hook(&quot;enterConversation&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h58-0-74" id="h58-0-74" class="i">+                    openedConversationId = SnapUUID(param.arg(0)).toString()
</a>                 }
<a href="#h58-0-76" id="h58-0-76" class="d">-                synchronized(delayedMessageUpdates) {
</a><a href="#h58-0-77" id="h58-0-77" class="d">-                    delayedMessageUpdates.clear()
</a><a href="#h58-0-78" id="h58-0-78" class="i">+                hook(&quot;exitConversation&quot;, HookStage.BEFORE) {
</a><a href="#h58-0-79" id="h58-0-79" class="i">+                    openedConversationId = null
</a><a href="#h58-0-80" id="h58-0-80" class="i">+                    firstFocusedMessageId = null
</a><a href="#h58-0-81" id="h58-0-81" class="i">+                    synchronized(focusedMessages) {
</a><a href="#h58-0-82" id="h58-0-82" class="i">+                        focusedMessages.clear()
</a><a href="#h58-0-83" id="h58-0-83" class="i">+                    }
</a><a href="#h58-0-84" id="h58-0-84" class="i">+                    synchronized(delayedMessageUpdates) {
</a><a href="#h58-0-85" id="h58-0-85" class="i">+                        delayedMessageUpdates.clear()
</a><a href="#h58-0-86" id="h58-0-86" class="i">+                    }
</a>                 }
             }
<a href="#h58-0-89" id="h58-0-89" class="d">-        }
</a> 
<a href="#h58-0-91" id="h58-0-91" class="d">-        context.event.subscribe(BindViewEvent::class) { event -&gt;
</a><a href="#h58-0-92" id="h58-0-92" class="d">-            event.chatMessage { conversationId, messageId -&gt;
</a><a href="#h58-0-93" id="h58-0-93" class="d">-                if (conversationId != openedConversationId) return@chatMessage
</a><a href="#h58-0-94" id="h58-0-94" class="d">-                synchronized(focusedMessages) {
</a><a href="#h58-0-95" id="h58-0-95" class="d">-                    focusedMessages[event.view] = messageId.toLong()
</a><a href="#h58-0-96" id="h58-0-96" class="d">-                }
</a><a href="#h58-0-97" id="h58-0-97" class="i">+            context.event.subscribe(BindViewEvent::class) { event -&gt;
</a><a href="#h58-0-98" id="h58-0-98" class="i">+                event.chatMessage { conversationId, messageId -&gt;
</a><a href="#h58-0-99" id="h58-0-99" class="i">+                    if (conversationId != openedConversationId) return@chatMessage
</a><a href="#h58-0-100" id="h58-0-100" class="i">+                    synchronized(focusedMessages) {
</a><a href="#h58-0-101" id="h58-0-101" class="i">+                        focusedMessages[event.view] = messageId.toLong()
</a><a href="#h58-0-102" id="h58-0-102" class="i">+                    }
</a> 
<a href="#h58-0-104" id="h58-0-104" class="d">-                if (delayedMessageUpdates.isNotEmpty() &amp;&amp; focusedMessages.entries.any { entry -&gt; entry.value == firstFocusedMessageId &amp;&amp; entry.key.isAttachedToWindow }) {
</a><a href="#h58-0-105" id="h58-0-105" class="d">-                    delayedMessageUpdates.apply {
</a><a href="#h58-0-106" id="h58-0-106" class="d">-                        synchronized(this) {
</a><a href="#h58-0-107" id="h58-0-107" class="d">-                            removeIf { it(); true }
</a><a href="#h58-0-108" id="h58-0-108" class="d">-                            firstFocusedMessageId = null
</a><a href="#h58-0-109" id="h58-0-109" class="i">+                    if (delayedMessageUpdates.isNotEmpty() &amp;&amp; focusedMessages.entries.any { entry -&gt; entry.value == firstFocusedMessageId &amp;&amp; entry.key.isAttachedToWindow }) {
</a><a href="#h58-0-110" id="h58-0-110" class="i">+                        delayedMessageUpdates.apply {
</a><a href="#h58-0-111" id="h58-0-111" class="i">+                            synchronized(this) {
</a><a href="#h58-0-112" id="h58-0-112" class="i">+                                removeIf { it(); true }
</a><a href="#h58-0-113" id="h58-0-113" class="i">+                                firstFocusedMessageId = null
</a><a href="#h58-0-114" id="h58-0-114" class="i">+                            }
</a>                         }
                     }
                 }
<b>diff --git a/<a id="h59" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/tweaks/RemoveGroupsLockedStatus.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/tweaks/RemoveGroupsLockedStatus.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/tweaks/RemoveGroupsLockedStatus.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/tweaks/RemoveGroupsLockedStatus.kt</a></b>
<a href="#h59-0" id="h59-0" class="h">@@ -1,17 +1,18 @@
</a> package me.rhunk.snapenhance.core.features.impl.tweaks
 
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h59-0-3" id="h59-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.util.dataBuilder
 import me.rhunk.snapenhance.core.util.hook.HookStage
 import me.rhunk.snapenhance.core.util.hook.hookConstructor
 
<a href="#h59-0-8" id="h59-0-8" class="d">-class RemoveGroupsLockedStatus : Feature(&quot;Remove Groups Locked Status&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_SYNC) {
</a><a href="#h59-0-9" id="h59-0-9" class="d">-    override fun onActivityCreate() {
</a><a href="#h59-0-10" id="h59-0-10" class="i">+class RemoveGroupsLockedStatus : Feature(&quot;Remove Groups Locked Status&quot;) {
</a><a href="#h59-0-11" id="h59-0-11" class="i">+    override fun init() {
</a>         if (!context.config.messaging.removeGroupsLockedStatus.get()) return
<a href="#h59-0-13" id="h59-0-13" class="d">-        context.classCache.conversation.hookConstructor(HookStage.AFTER) { param -&gt;
</a><a href="#h59-0-14" id="h59-0-14" class="d">-            param.thisObject&lt;Any&gt;().dataBuilder {
</a><a href="#h59-0-15" id="h59-0-15" class="d">-                set(&quot;mLockedState&quot;, &quot;UNLOCKED&quot;)
</a><a href="#h59-0-16" id="h59-0-16" class="i">+        onNextActivityCreate(defer = true) {
</a><a href="#h59-0-17" id="h59-0-17" class="i">+            context.classCache.conversation.hookConstructor(HookStage.AFTER) { param -&gt;
</a><a href="#h59-0-18" id="h59-0-18" class="i">+                param.thisObject&lt;Any&gt;().dataBuilder {
</a><a href="#h59-0-19" id="h59-0-19" class="i">+                    set(&quot;mLockedState&quot;, &quot;UNLOCKED&quot;)
</a><a href="#h59-0-20" id="h59-0-20" class="i">+                }
</a>             }
         }
     }
<b>diff --git a/<a id="h60" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/tweaks/UnsaveableMessages.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/tweaks/UnsaveableMessages.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/tweaks/UnsaveableMessages.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/tweaks/UnsaveableMessages.kt</a></b>
<a href="#h60-0" id="h60-0" class="h">@@ -5,14 +5,12 @@ import me.rhunk.snapenhance.common.data.MessagingRuleType
</a> import me.rhunk.snapenhance.common.util.protobuf.ProtoEditor
 import me.rhunk.snapenhance.common.util.protobuf.ProtoReader
 import me.rhunk.snapenhance.core.event.events.impl.NativeUnaryCallEvent
<a href="#h60-0-3" id="h60-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.features.MessagingRuleFeature
 import me.rhunk.snapenhance.core.wrapper.impl.SnapUUID
 
 class UnsaveableMessages : MessagingRuleFeature(
     &quot;Unsaveable Messages&quot;,
<a href="#h60-0-9" id="h60-0-9" class="d">-    MessagingRuleType.UNSAVEABLE_MESSAGES,
</a><a href="#h60-0-10" id="h60-0-10" class="d">-    loadParams = FeatureLoadParams.INIT_SYNC
</a><a href="#h60-0-11" id="h60-0-11" class="i">+    MessagingRuleType.UNSAVEABLE_MESSAGES
</a> ) {
     override fun init() {
         if (context.config.rules.getRuleState(MessagingRuleType.UNSAVEABLE_MESSAGES) == null) return
<b>diff --git a/<a id="h61" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/ClientBootstrapOverride.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/ClientBootstrapOverride.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/ClientBootstrapOverride.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/ClientBootstrapOverride.kt</a></b>
<a href="#h61-0" id="h61-0" class="h">@@ -2,11 +2,10 @@ package me.rhunk.snapenhance.core.features.impl.ui
</a> 
 import me.rhunk.snapenhance.common.config.impl.UserInterfaceTweaks
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h61-0-3" id="h61-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import java.io.File
 
 
<a href="#h61-0-7" id="h61-0-7" class="d">-class ClientBootstrapOverride: Feature(&quot;ClientBootstrapOverride&quot;, loadParams = FeatureLoadParams.INIT_SYNC) {
</a><a href="#h61-0-8" id="h61-0-8" class="i">+class ClientBootstrapOverride: Feature(&quot;ClientBootstrapOverride&quot;) {
</a> 
     private val clientBootstrapFolder by lazy { File(context.androidContext.filesDir, &quot;client-bootstrap&quot;) }
 
<b>diff --git a/<a id="h62" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/ConversationToolbox.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/ConversationToolbox.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/ConversationToolbox.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/ConversationToolbox.kt</a></b>
<a href="#h62-0" id="h62-0" class="h">@@ -34,7 +34,6 @@ import me.rhunk.snapenhance.common.scripting.ui.ScriptInterface
</a> import me.rhunk.snapenhance.common.ui.createComposeAlertDialog
 import me.rhunk.snapenhance.core.event.events.impl.AddViewEvent
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h62-0-3" id="h62-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.features.impl.messaging.Messaging
 import me.rhunk.snapenhance.core.util.ktx.getId
 
<a href="#h62-1" id="h62-1" class="h">@@ -45,7 +44,7 @@ data class ComposableMenu(
</a>     val composable: @Composable (alertDialog: AlertDialog, conversationId: String) -&gt; Unit,
 )
 
<a href="#h62-1-3" id="h62-1-3" class="d">-class ConversationToolbox : Feature(&quot;Conversation Toolbox&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_SYNC) {
</a><a href="#h62-1-4" id="h62-1-4" class="i">+class ConversationToolbox : Feature(&quot;Conversation Toolbox&quot;) {
</a>     private val composableList = mutableListOf&lt;ComposableMenu&gt;()
     private val expandedComposableCache = mutableStateMapOf&lt;String, Boolean&gt;()
 
<a href="#h62-2" id="h62-2" class="h">@@ -56,49 +55,51 @@ class ConversationToolbox : Feature(&quot;Conversation Toolbox&quot;, loadParams = Feature
</a>     }
 
     @SuppressLint(&quot;SetTextI18n&quot;)
<a href="#h62-2-3" id="h62-2-3" class="d">-    override fun onActivityCreate() {
</a><a href="#h62-2-4" id="h62-2-4" class="d">-        val defaultInputBarId = context.resources.getId(&quot;default_input_bar&quot;)
</a><a href="#h62-2-5" id="h62-2-5" class="i">+    override fun init() {
</a><a href="#h62-2-6" id="h62-2-6" class="i">+        onNextActivityCreate {
</a><a href="#h62-2-7" id="h62-2-7" class="i">+            val defaultInputBarId = context.resources.getId(&quot;default_input_bar&quot;)
</a> 
<a href="#h62-2-9" id="h62-2-9" class="d">-        context.event.subscribe(AddViewEvent::class) { event -&gt;
</a><a href="#h62-2-10" id="h62-2-10" class="d">-            if (event.view.id != defaultInputBarId) return@subscribe
</a><a href="#h62-2-11" id="h62-2-11" class="d">-            if (composableList.isEmpty()) return@subscribe
</a><a href="#h62-2-12" id="h62-2-12" class="i">+            context.event.subscribe(AddViewEvent::class) { event -&gt;
</a><a href="#h62-2-13" id="h62-2-13" class="i">+                if (event.view.id != defaultInputBarId) return@subscribe
</a><a href="#h62-2-14" id="h62-2-14" class="i">+                if (composableList.isEmpty()) return@subscribe
</a> 
<a href="#h62-2-16" id="h62-2-16" class="d">-            (event.view as ViewGroup).addView(FrameLayout(event.view.context).apply {
</a><a href="#h62-2-17" id="h62-2-17" class="d">-                layoutParams = LinearLayout.LayoutParams(
</a><a href="#h62-2-18" id="h62-2-18" class="d">-                    ViewGroup.LayoutParams.WRAP_CONTENT,
</a><a href="#h62-2-19" id="h62-2-19" class="d">-                    (52 * context.resources.displayMetrics.density).toInt(),
</a><a href="#h62-2-20" id="h62-2-20" class="d">-                ).apply {
</a><a href="#h62-2-21" id="h62-2-21" class="d">-                    gravity = Gravity.BOTTOM
</a><a href="#h62-2-22" id="h62-2-22" class="d">-                }
</a><a href="#h62-2-23" id="h62-2-23" class="d">-                setPadding(25, 0, 25, 0)
</a><a href="#h62-2-24" id="h62-2-24" class="d">-
</a><a href="#h62-2-25" id="h62-2-25" class="d">-                addView(TextView(event.view.context).apply {
</a><a href="#h62-2-26" id="h62-2-26" class="d">-                    layoutParams = FrameLayout.LayoutParams(
</a><a href="#h62-2-27" id="h62-2-27" class="d">-                        ViewGroup.LayoutParams.WRAP_CONTENT,
</a><a href="#h62-2-28" id="h62-2-28" class="i">+                (event.view as ViewGroup).addView(FrameLayout(event.view.context).apply {
</a><a href="#h62-2-29" id="h62-2-29" class="i">+                    layoutParams = LinearLayout.LayoutParams(
</a>                         ViewGroup.LayoutParams.WRAP_CONTENT,
<a href="#h62-2-31" id="h62-2-31" class="i">+                        (52 * context.resources.displayMetrics.density).toInt(),
</a>                     ).apply {
<a href="#h62-2-33" id="h62-2-33" class="d">-                        gravity = Gravity.CENTER_VERTICAL
</a><a href="#h62-2-34" id="h62-2-34" class="i">+                        gravity = Gravity.BOTTOM
</a>                     }
<a href="#h62-2-36" id="h62-2-36" class="d">-                    setOnClickListener {
</a><a href="#h62-2-37" id="h62-2-37" class="d">-                        openToolbox()
</a><a href="#h62-2-38" id="h62-2-38" class="d">-                    }
</a><a href="#h62-2-39" id="h62-2-39" class="d">-                    textSize = 21f
</a><a href="#h62-2-40" id="h62-2-40" class="d">-                    text = &quot;\uD83E\uDDF0&quot;
</a><a href="#h62-2-41" id="h62-2-41" class="i">+                    setPadding(25, 0, 25, 0)
</a><a href="#h62-2-42" id="h62-2-42" class="i">+
</a><a href="#h62-2-43" id="h62-2-43" class="i">+                    addView(TextView(event.view.context).apply {
</a><a href="#h62-2-44" id="h62-2-44" class="i">+                        layoutParams = FrameLayout.LayoutParams(
</a><a href="#h62-2-45" id="h62-2-45" class="i">+                            ViewGroup.LayoutParams.WRAP_CONTENT,
</a><a href="#h62-2-46" id="h62-2-46" class="i">+                            ViewGroup.LayoutParams.WRAP_CONTENT,
</a><a href="#h62-2-47" id="h62-2-47" class="i">+                        ).apply {
</a><a href="#h62-2-48" id="h62-2-48" class="i">+                            gravity = Gravity.CENTER_VERTICAL
</a><a href="#h62-2-49" id="h62-2-49" class="i">+                        }
</a><a href="#h62-2-50" id="h62-2-50" class="i">+                        setOnClickListener {
</a><a href="#h62-2-51" id="h62-2-51" class="i">+                            openToolbox()
</a><a href="#h62-2-52" id="h62-2-52" class="i">+                        }
</a><a href="#h62-2-53" id="h62-2-53" class="i">+                        textSize = 21f
</a><a href="#h62-2-54" id="h62-2-54" class="i">+                        text = &quot;\uD83E\uDDF0&quot;
</a><a href="#h62-2-55" id="h62-2-55" class="i">+                    })
</a>                 })
<a href="#h62-2-57" id="h62-2-57" class="d">-            })
</a><a href="#h62-2-58" id="h62-2-58" class="d">-        }
</a><a href="#h62-2-59" id="h62-2-59" class="i">+            }
</a> 
<a href="#h62-2-61" id="h62-2-61" class="d">-        context.scriptRuntime.eachModule {
</a><a href="#h62-2-62" id="h62-2-62" class="d">-            val interfaceManager = getBinding(InterfaceManager::class)?.takeIf {
</a><a href="#h62-2-63" id="h62-2-63" class="d">-                it.hasInterface(EnumScriptInterface.CONVERSATION_TOOLBOX)
</a><a href="#h62-2-64" id="h62-2-64" class="d">-            } ?: return@eachModule
</a><a href="#h62-2-65" id="h62-2-65" class="d">-            addComposable(&quot;\uD83D\uDCDC ${moduleInfo.displayName}&quot;) { alertDialog, conversationId -&gt;
</a><a href="#h62-2-66" id="h62-2-66" class="d">-                ScriptInterface(remember {
</a><a href="#h62-2-67" id="h62-2-67" class="d">-                    interfaceManager.buildInterface(EnumScriptInterface.CONVERSATION_TOOLBOX, mapOf(
</a><a href="#h62-2-68" id="h62-2-68" class="d">-                        &quot;alertDialog&quot; to alertDialog,
</a><a href="#h62-2-69" id="h62-2-69" class="d">-                        &quot;conversationId&quot; to conversationId,
</a><a href="#h62-2-70" id="h62-2-70" class="d">-                    ))
</a><a href="#h62-2-71" id="h62-2-71" class="d">-                } ?: return@addComposable)
</a><a href="#h62-2-72" id="h62-2-72" class="i">+            context.scriptRuntime.eachModule {
</a><a href="#h62-2-73" id="h62-2-73" class="i">+                val interfaceManager = getBinding(InterfaceManager::class)?.takeIf {
</a><a href="#h62-2-74" id="h62-2-74" class="i">+                    it.hasInterface(EnumScriptInterface.CONVERSATION_TOOLBOX)
</a><a href="#h62-2-75" id="h62-2-75" class="i">+                } ?: return@eachModule
</a><a href="#h62-2-76" id="h62-2-76" class="i">+                addComposable(&quot;\uD83D\uDCDC ${moduleInfo.displayName}&quot;) { alertDialog, conversationId -&gt;
</a><a href="#h62-2-77" id="h62-2-77" class="i">+                    ScriptInterface(remember {
</a><a href="#h62-2-78" id="h62-2-78" class="i">+                        interfaceManager.buildInterface(EnumScriptInterface.CONVERSATION_TOOLBOX, mapOf(
</a><a href="#h62-2-79" id="h62-2-79" class="i">+                            &quot;alertDialog&quot; to alertDialog,
</a><a href="#h62-2-80" id="h62-2-80" class="i">+                            &quot;conversationId&quot; to conversationId,
</a><a href="#h62-2-81" id="h62-2-81" class="i">+                        ))
</a><a href="#h62-2-82" id="h62-2-82" class="i">+                    } ?: return@addComposable)
</a><a href="#h62-2-83" id="h62-2-83" class="i">+                }
</a>             }
         }
     }
<b>diff --git a/<a id="h63" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/CustomStreaksExpirationFormat.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/CustomStreaksExpirationFormat.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/CustomStreaksExpirationFormat.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/CustomStreaksExpirationFormat.kt</a></b>
<a href="#h63-0" id="h63-0" class="h">@@ -1,53 +1,54 @@
</a> package me.rhunk.snapenhance.core.features.impl.ui
 
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h63-0-3" id="h63-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.util.hook.HookStage
 import me.rhunk.snapenhance.core.util.hook.hook
 import me.rhunk.snapenhance.core.util.ktx.getObjectField
 import me.rhunk.snapenhance.mapper.impl.StreaksExpirationMapper
 import kotlin.time.Duration.Companion.milliseconds
 
<a href="#h63-0-10" id="h63-0-10" class="d">-class CustomStreaksExpirationFormat: Feature(&quot;CustomStreaksExpirationFormat&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_SYNC) {
</a><a href="#h63-0-11" id="h63-0-11" class="i">+class CustomStreaksExpirationFormat: Feature(&quot;CustomStreaksExpirationFormat&quot;) {
</a>     private fun Long.padZero(): String {
         return this.toString().padStart(2, &#39;0&#39;)
     }
 
<a href="#h63-0-16" id="h63-0-16" class="d">-    override fun onActivityCreate() {
</a><a href="#h63-0-17" id="h63-0-17" class="d">-        val expirationFormat by context.config.experimental.customStreaksExpirationFormat
</a><a href="#h63-0-18" id="h63-0-18" class="d">-        if (expirationFormat.isNotEmpty() || context.config.userInterface.streakExpirationInfo.get()) {
</a><a href="#h63-0-19" id="h63-0-19" class="d">-            context.mappings.useMapper(StreaksExpirationMapper::class) {
</a><a href="#h63-0-20" id="h63-0-20" class="d">-                runCatching {
</a><a href="#h63-0-21" id="h63-0-21" class="d">-                    simpleStreaksFormatterClass.getAsClass()?.hook(formatSimpleStreaksTextMethod.get() ?: return@useMapper, HookStage.BEFORE) { param -&gt;
</a><a href="#h63-0-22" id="h63-0-22" class="d">-                        param.setResult(null)
</a><a href="#h63-0-23" id="h63-0-23" class="i">+    override fun init() {
</a><a href="#h63-0-24" id="h63-0-24" class="i">+        onNextActivityCreate {
</a><a href="#h63-0-25" id="h63-0-25" class="i">+            val expirationFormat by context.config.experimental.customStreaksExpirationFormat
</a><a href="#h63-0-26" id="h63-0-26" class="i">+            if (expirationFormat.isNotEmpty() || context.config.userInterface.streakExpirationInfo.get()) {
</a><a href="#h63-0-27" id="h63-0-27" class="i">+                context.mappings.useMapper(StreaksExpirationMapper::class) {
</a><a href="#h63-0-28" id="h63-0-28" class="i">+                    runCatching {
</a><a href="#h63-0-29" id="h63-0-29" class="i">+                        simpleStreaksFormatterClass.getAsClass()?.hook(formatSimpleStreaksTextMethod.get() ?: return@useMapper, HookStage.BEFORE) { param -&gt;
</a><a href="#h63-0-30" id="h63-0-30" class="i">+                            param.setResult(null)
</a><a href="#h63-0-31" id="h63-0-31" class="i">+                        }
</a><a href="#h63-0-32" id="h63-0-32" class="i">+                    }.onFailure {
</a><a href="#h63-0-33" id="h63-0-33" class="i">+                        context.log.warn(&quot;Failed to hook simpleStreaksFormatterClass : &quot; + it.message)
</a>                     }
<a href="#h63-0-35" id="h63-0-35" class="d">-                }.onFailure {
</a><a href="#h63-0-36" id="h63-0-36" class="d">-                    context.log.warn(&quot;Failed to hook simpleStreaksFormatterClass : &quot; + it.message)
</a>                 }
             }
<a href="#h63-0-39" id="h63-0-39" class="d">-        }
</a><a href="#h63-0-40" id="h63-0-40" class="d">-        if (expirationFormat.isEmpty()) return
</a><a href="#h63-0-41" id="h63-0-41" class="i">+            if (expirationFormat.isEmpty()) return@onNextActivityCreate
</a> 
<a href="#h63-0-43" id="h63-0-43" class="d">-        context.mappings.useMapper(StreaksExpirationMapper::class) {
</a><a href="#h63-0-44" id="h63-0-44" class="d">-            streaksFormatterClass.getAsClass()?.hook(formatStreaksTextMethod.get() ?: return@useMapper, HookStage.AFTER) { param -&gt;
</a><a href="#h63-0-45" id="h63-0-45" class="d">-                val streaksCount = param.argNullable(2) ?: 0
</a><a href="#h63-0-46" id="h63-0-46" class="d">-                val streaksExpiration = param.argNullable&lt;Any&gt;(3) ?: return@hook
</a><a href="#h63-0-47" id="h63-0-47" class="i">+            context.mappings.useMapper(StreaksExpirationMapper::class) {
</a><a href="#h63-0-48" id="h63-0-48" class="i">+                streaksFormatterClass.getAsClass()?.hook(formatStreaksTextMethod.get() ?: return@useMapper, HookStage.AFTER) { param -&gt;
</a><a href="#h63-0-49" id="h63-0-49" class="i">+                    val streaksCount = param.argNullable(2) ?: 0
</a><a href="#h63-0-50" id="h63-0-50" class="i">+                    val streaksExpiration = param.argNullable&lt;Any&gt;(3) ?: return@hook
</a> 
<a href="#h63-0-52" id="h63-0-52" class="d">-                val hourGlassTimeRemaining = streaksExpiration.getObjectField(hourGlassTimeRemainingField.get() ?: return@hook) as? Long ?: return@hook
</a><a href="#h63-0-53" id="h63-0-53" class="d">-                val expirationTime = streaksExpiration.getObjectField(expirationTimeField.get() ?: return@hook) as? Long ?: return@hook
</a><a href="#h63-0-54" id="h63-0-54" class="d">-                val delta = (expirationTime - System.currentTimeMillis()).milliseconds
</a><a href="#h63-0-55" id="h63-0-55" class="i">+                    val hourGlassTimeRemaining = streaksExpiration.getObjectField(hourGlassTimeRemainingField.get() ?: return@hook) as? Long ?: return@hook
</a><a href="#h63-0-56" id="h63-0-56" class="i">+                    val expirationTime = streaksExpiration.getObjectField(expirationTimeField.get() ?: return@hook) as? Long ?: return@hook
</a><a href="#h63-0-57" id="h63-0-57" class="i">+                    val delta = (expirationTime - System.currentTimeMillis()).milliseconds
</a> 
<a href="#h63-0-59" id="h63-0-59" class="d">-                val hourGlassEmoji = if (delta.inWholeMilliseconds in 1..hourGlassTimeRemaining) if (expirationTime % 2 == 0L) &quot;\u23F3&quot; else &quot;\u231B&quot; else &quot;&quot;
</a><a href="#h63-0-60" id="h63-0-60" class="i">+                    val hourGlassEmoji = if (delta.inWholeMilliseconds in 1..hourGlassTimeRemaining) if (expirationTime % 2 == 0L) &quot;\u23F3&quot; else &quot;\u231B&quot; else &quot;&quot;
</a> 
<a href="#h63-0-62" id="h63-0-62" class="d">-                param.setResult(expirationFormat
</a><a href="#h63-0-63" id="h63-0-63" class="d">-                    .replace(&quot;%c&quot;, streaksCount.toString())
</a><a href="#h63-0-64" id="h63-0-64" class="d">-                    .replace(&quot;%e&quot;, hourGlassEmoji)
</a><a href="#h63-0-65" id="h63-0-65" class="d">-                    .replace(&quot;%d&quot;, delta.inWholeDays.toString())
</a><a href="#h63-0-66" id="h63-0-66" class="d">-                    .replace(&quot;%h&quot;, (delta.inWholeHours % 24).padZero())
</a><a href="#h63-0-67" id="h63-0-67" class="d">-                    .replace(&quot;%m&quot;, (delta.inWholeMinutes % 60).padZero())
</a><a href="#h63-0-68" id="h63-0-68" class="d">-                    .replace(&quot;%s&quot;, (delta.inWholeSeconds % 60).padZero())
</a><a href="#h63-0-69" id="h63-0-69" class="d">-                    .replace(&quot;%w&quot;, delta.toString())
</a><a href="#h63-0-70" id="h63-0-70" class="d">-                )
</a><a href="#h63-0-71" id="h63-0-71" class="i">+                    param.setResult(expirationFormat
</a><a href="#h63-0-72" id="h63-0-72" class="i">+                        .replace(&quot;%c&quot;, streaksCount.toString())
</a><a href="#h63-0-73" id="h63-0-73" class="i">+                        .replace(&quot;%e&quot;, hourGlassEmoji)
</a><a href="#h63-0-74" id="h63-0-74" class="i">+                        .replace(&quot;%d&quot;, delta.inWholeDays.toString())
</a><a href="#h63-0-75" id="h63-0-75" class="i">+                        .replace(&quot;%h&quot;, (delta.inWholeHours % 24).padZero())
</a><a href="#h63-0-76" id="h63-0-76" class="i">+                        .replace(&quot;%m&quot;, (delta.inWholeMinutes % 60).padZero())
</a><a href="#h63-0-77" id="h63-0-77" class="i">+                        .replace(&quot;%s&quot;, (delta.inWholeSeconds % 60).padZero())
</a><a href="#h63-0-78" id="h63-0-78" class="i">+                        .replace(&quot;%w&quot;, delta.toString())
</a><a href="#h63-0-79" id="h63-0-79" class="i">+                    )
</a><a href="#h63-0-80" id="h63-0-80" class="i">+                }
</a>             }
         }
     }
<b>diff --git a/<a id="h64" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/CustomizeUI.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/CustomizeUI.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/CustomizeUI.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/CustomizeUI.kt</a></b>
<a href="#h64-0" id="h64-0" class="h">@@ -7,18 +7,17 @@ import android.util.TypedValue
</a> import androidx.compose.material3.dynamicDarkColorScheme
 import androidx.compose.ui.graphics.toArgb
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h64-0-3" id="h64-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.util.hook.HookStage
 import me.rhunk.snapenhance.core.util.hook.Hooker
 import me.rhunk.snapenhance.core.util.hook.hook
 import me.rhunk.snapenhance.core.util.ktx.getIdentifier
 
<a href="#h64-0-9" id="h64-0-9" class="d">-class CustomizeUI: Feature(&quot;Customize UI&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_SYNC) {
</a><a href="#h64-0-10" id="h64-0-10" class="i">+class CustomizeUI: Feature(&quot;Customize UI&quot;) {
</a>     private fun getAttribute(name: String): Int {
         return context.resources.getIdentifier(name, &quot;attr&quot;)
     }
 
<a href="#h64-0-15" id="h64-0-15" class="d">-    override fun onActivityCreate() {
</a><a href="#h64-0-16" id="h64-0-16" class="i">+    override fun init() {
</a>         val customizeUIConfig = context.config.userInterface.customizeUi
         val themePicker = customizeUIConfig.themePicker.getNullable() ?: return
         val colorsConfig = context.config.userInterface.customizeUi.colors
<b>diff --git a/<a id="h65" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/DefaultVolumeControls.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/DefaultVolumeControls.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/DefaultVolumeControls.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/DefaultVolumeControls.kt</a></b>
<a href="#h65-0" id="h65-0" class="h">@@ -2,17 +2,18 @@ package me.rhunk.snapenhance.core.features.impl.ui
</a> 
 import android.view.KeyEvent
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h65-0-3" id="h65-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.util.hook.HookStage
 import me.rhunk.snapenhance.core.util.hook.hook
 
<a href="#h65-0-7" id="h65-0-7" class="d">-class DefaultVolumeControls : Feature(&quot;Default Volume Controls&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_SYNC) {
</a><a href="#h65-0-8" id="h65-0-8" class="d">-    override fun onActivityCreate() {
</a><a href="#h65-0-9" id="h65-0-9" class="i">+class DefaultVolumeControls : Feature(&quot;Default Volume Controls&quot;) {
</a><a href="#h65-0-10" id="h65-0-10" class="i">+    override fun init() {
</a>         if (!context.config.global.defaultVolumeControls.get()) return
<a href="#h65-0-12" id="h65-0-12" class="d">-        context.mainActivity!!::class.java.hook(&quot;onKeyDown&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h65-0-13" id="h65-0-13" class="d">-            val keyCode = param.arg&lt;Int&gt;(0)
</a><a href="#h65-0-14" id="h65-0-14" class="d">-            if (keyCode == KeyEvent.KEYCODE_VOLUME_DOWN || keyCode == KeyEvent.KEYCODE_VOLUME_UP) {
</a><a href="#h65-0-15" id="h65-0-15" class="d">-                param.setResult(false)
</a><a href="#h65-0-16" id="h65-0-16" class="i">+        onNextActivityCreate { activity -&gt;
</a><a href="#h65-0-17" id="h65-0-17" class="i">+            activity::class.java.hook(&quot;onKeyDown&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h65-0-18" id="h65-0-18" class="i">+                val keyCode = param.arg&lt;Int&gt;(0)
</a><a href="#h65-0-19" id="h65-0-19" class="i">+                if (keyCode == KeyEvent.KEYCODE_VOLUME_DOWN || keyCode == KeyEvent.KEYCODE_VOLUME_UP) {
</a><a href="#h65-0-20" id="h65-0-20" class="i">+                    param.setResult(false)
</a><a href="#h65-0-21" id="h65-0-21" class="i">+                }
</a>             }
         }
     }
<b>diff --git a/<a id="h66" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/DisableConfirmationDialogs.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/DisableConfirmationDialogs.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/DisableConfirmationDialogs.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/DisableConfirmationDialogs.kt</a></b>
<a href="#h66-0" id="h66-0" class="h">@@ -4,59 +4,60 @@ import android.view.View
</a> import android.widget.TextView
 import me.rhunk.snapenhance.core.event.events.impl.AddViewEvent
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h66-0-3" id="h66-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.ui.children
 import me.rhunk.snapenhance.core.ui.triggerRootCloseTouchEvent
 import me.rhunk.snapenhance.core.util.ktx.getId
 import me.rhunk.snapenhance.core.util.ktx.getIdentifier
 import java.util.regex.Pattern
 
<a href="#h66-0-10" id="h66-0-10" class="d">-class DisableConfirmationDialogs : Feature(&quot;Disable Confirmation Dialogs&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_SYNC) {
</a><a href="#h66-0-11" id="h66-0-11" class="d">-    override fun onActivityCreate() {
</a><a href="#h66-0-12" id="h66-0-12" class="d">-        val disableConfirmationDialogs = context.config.global.disableConfirmationDialogs.get().takeIf { it.isNotEmpty() } ?: return
</a><a href="#h66-0-13" id="h66-0-13" class="d">-        val dialogContent = context.resources.getId(&quot;dialog_content&quot;)
</a><a href="#h66-0-14" id="h66-0-14" class="d">-        val alertDialogTitle = context.resources.getId(&quot;alert_dialog_title&quot;)
</a><a href="#h66-0-15" id="h66-0-15" class="i">+class DisableConfirmationDialogs : Feature(&quot;Disable Confirmation Dialogs&quot;) {
</a><a href="#h66-0-16" id="h66-0-16" class="i">+    override fun init() {
</a><a href="#h66-0-17" id="h66-0-17" class="i">+        onNextActivityCreate {
</a><a href="#h66-0-18" id="h66-0-18" class="i">+            val disableConfirmationDialogs = context.config.global.disableConfirmationDialogs.get().takeIf { it.isNotEmpty() } ?: return@onNextActivityCreate
</a><a href="#h66-0-19" id="h66-0-19" class="i">+            val dialogContent = context.resources.getId(&quot;dialog_content&quot;)
</a><a href="#h66-0-20" id="h66-0-20" class="i">+            val alertDialogTitle = context.resources.getId(&quot;alert_dialog_title&quot;)
</a> 
<a href="#h66-0-22" id="h66-0-22" class="d">-        val questions = listOf(
</a><a href="#h66-0-23" id="h66-0-23" class="d">-            &quot;erase_message&quot; to &quot;erase_learn_more_dialog_title&quot;,
</a><a href="#h66-0-24" id="h66-0-24" class="d">-            &quot;erase_message&quot; to &quot;erase_dialog_title&quot;,
</a><a href="#h66-0-25" id="h66-0-25" class="d">-            &quot;erase_message&quot; to &quot;snap_erase_dialog_title&quot;,
</a><a href="#h66-0-26" id="h66-0-26" class="d">-            &quot;erase_message&quot; to &quot;snap_erase_learn_more_dialog_title&quot;,
</a><a href="#h66-0-27" id="h66-0-27" class="d">-            &quot;remove_friend&quot; to &quot;action_menu_remove_friend_question&quot;,
</a><a href="#h66-0-28" id="h66-0-28" class="d">-            &quot;block_friend&quot; to &quot;action_menu_block_friend_question&quot;,
</a><a href="#h66-0-29" id="h66-0-29" class="d">-            &quot;ignore_friend&quot; to &quot;action_menu_ignore_friend_question&quot;,
</a><a href="#h66-0-30" id="h66-0-30" class="d">-            &quot;hide_friend&quot; to &quot;action_menu_hide_friend_question&quot;,
</a><a href="#h66-0-31" id="h66-0-31" class="d">-            &quot;hide_conversation&quot; to &quot;hide_or_block_clear_conversation_dialog_title&quot;,
</a><a href="#h66-0-32" id="h66-0-32" class="d">-            &quot;clear_conversation&quot; to &quot;action_menu_clear_conversation_dialog_title&quot;
</a><a href="#h66-0-33" id="h66-0-33" class="d">-        ).map { pair -&gt;
</a><a href="#h66-0-34" id="h66-0-34" class="d">-            pair.first to runCatching {
</a><a href="#h66-0-35" id="h66-0-35" class="d">-                Pattern.compile(
</a><a href="#h66-0-36" id="h66-0-36" class="d">-                    context.resources.getString(context.resources.getIdentifier(pair.second, &quot;string&quot;))
</a><a href="#h66-0-37" id="h66-0-37" class="d">-                        .split(&quot;%s&quot;).joinToString(&quot;.*&quot;) {
</a><a href="#h66-0-38" id="h66-0-38" class="d">-                            Pattern.quote(it)
</a><a href="#h66-0-39" id="h66-0-39" class="d">-                        }, Pattern.CASE_INSENSITIVE)
</a><a href="#h66-0-40" id="h66-0-40" class="d">-            }.onFailure {
</a><a href="#h66-0-41" id="h66-0-41" class="d">-                context.log.error(&quot;Failed to compile regex for ${pair.second}&quot;, it)
</a><a href="#h66-0-42" id="h66-0-42" class="d">-            }.getOrNull()
</a><a href="#h66-0-43" id="h66-0-43" class="d">-        }
</a><a href="#h66-0-44" id="h66-0-44" class="i">+            val questions = listOf(
</a><a href="#h66-0-45" id="h66-0-45" class="i">+                &quot;erase_message&quot; to &quot;erase_learn_more_dialog_title&quot;,
</a><a href="#h66-0-46" id="h66-0-46" class="i">+                &quot;erase_message&quot; to &quot;erase_dialog_title&quot;,
</a><a href="#h66-0-47" id="h66-0-47" class="i">+                &quot;erase_message&quot; to &quot;snap_erase_dialog_title&quot;,
</a><a href="#h66-0-48" id="h66-0-48" class="i">+                &quot;erase_message&quot; to &quot;snap_erase_learn_more_dialog_title&quot;,
</a><a href="#h66-0-49" id="h66-0-49" class="i">+                &quot;remove_friend&quot; to &quot;action_menu_remove_friend_question&quot;,
</a><a href="#h66-0-50" id="h66-0-50" class="i">+                &quot;block_friend&quot; to &quot;action_menu_block_friend_question&quot;,
</a><a href="#h66-0-51" id="h66-0-51" class="i">+                &quot;ignore_friend&quot; to &quot;action_menu_ignore_friend_question&quot;,
</a><a href="#h66-0-52" id="h66-0-52" class="i">+                &quot;hide_friend&quot; to &quot;action_menu_hide_friend_question&quot;,
</a><a href="#h66-0-53" id="h66-0-53" class="i">+                &quot;hide_conversation&quot; to &quot;hide_or_block_clear_conversation_dialog_title&quot;,
</a><a href="#h66-0-54" id="h66-0-54" class="i">+                &quot;clear_conversation&quot; to &quot;action_menu_clear_conversation_dialog_title&quot;
</a><a href="#h66-0-55" id="h66-0-55" class="i">+            ).map { pair -&gt;
</a><a href="#h66-0-56" id="h66-0-56" class="i">+                pair.first to runCatching {
</a><a href="#h66-0-57" id="h66-0-57" class="i">+                    Pattern.compile(
</a><a href="#h66-0-58" id="h66-0-58" class="i">+                        context.resources.getString(context.resources.getIdentifier(pair.second, &quot;string&quot;))
</a><a href="#h66-0-59" id="h66-0-59" class="i">+                            .split(&quot;%s&quot;).joinToString(&quot;.*&quot;) {
</a><a href="#h66-0-60" id="h66-0-60" class="i">+                                Pattern.quote(it)
</a><a href="#h66-0-61" id="h66-0-61" class="i">+                            }, Pattern.CASE_INSENSITIVE)
</a><a href="#h66-0-62" id="h66-0-62" class="i">+                }.onFailure {
</a><a href="#h66-0-63" id="h66-0-63" class="i">+                    context.log.error(&quot;Failed to compile regex for ${pair.second}&quot;, it)
</a><a href="#h66-0-64" id="h66-0-64" class="i">+                }.getOrNull()
</a><a href="#h66-0-65" id="h66-0-65" class="i">+            }
</a> 
<a href="#h66-0-67" id="h66-0-67" class="d">-        context.event.subscribe(AddViewEvent::class) { event -&gt;
</a><a href="#h66-0-68" id="h66-0-68" class="d">-            if (event.parent.id != dialogContent || !event.view::class.java.name.endsWith(&quot;SnapButtonView&quot;)) return@subscribe
</a><a href="#h66-0-69" id="h66-0-69" class="i">+            context.event.subscribe(AddViewEvent::class) { event -&gt;
</a><a href="#h66-0-70" id="h66-0-70" class="i">+                if (event.parent.id != dialogContent || !event.view::class.java.name.endsWith(&quot;SnapButtonView&quot;)) return@subscribe
</a> 
<a href="#h66-0-72" id="h66-0-72" class="d">-            val dialogTitle = event.parent.findViewById&lt;TextView&gt;(alertDialogTitle)?.text?.toString() ?: return@subscribe
</a><a href="#h66-0-73" id="h66-0-73" class="d">-            if (event.parent.children().count { it::class.java.name.endsWith(&quot;SnapButtonView&quot;) } != 0) return@subscribe
</a><a href="#h66-0-74" id="h66-0-74" class="i">+                val dialogTitle = event.parent.findViewById&lt;TextView&gt;(alertDialogTitle)?.text?.toString() ?: return@subscribe
</a><a href="#h66-0-75" id="h66-0-75" class="i">+                if (event.parent.children().count { it::class.java.name.endsWith(&quot;SnapButtonView&quot;) } != 0) return@subscribe
</a> 
<a href="#h66-0-77" id="h66-0-77" class="d">-            questions.forEach { (key, value) -&gt;
</a><a href="#h66-0-78" id="h66-0-78" class="d">-                if (!disableConfirmationDialogs.contains(key)) return@forEach
</a><a href="#h66-0-79" id="h66-0-79" class="i">+                questions.forEach { (key, value) -&gt;
</a><a href="#h66-0-80" id="h66-0-80" class="i">+                    if (!disableConfirmationDialogs.contains(key)) return@forEach
</a> 
<a href="#h66-0-82" id="h66-0-82" class="d">-                if (value?.matcher(dialogTitle)?.matches() == true) {
</a><a href="#h66-0-83" id="h66-0-83" class="d">-                    event.parent.visibility = View.INVISIBLE
</a><a href="#h66-0-84" id="h66-0-84" class="d">-                    event.parent.post {
</a><a href="#h66-0-85" id="h66-0-85" class="d">-                        event.view.callOnClick()
</a><a href="#h66-0-86" id="h66-0-86" class="i">+                    if (value?.matcher(dialogTitle)?.matches() == true) {
</a><a href="#h66-0-87" id="h66-0-87" class="i">+                        event.parent.visibility = View.INVISIBLE
</a><a href="#h66-0-88" id="h66-0-88" class="i">+                        event.parent.post {
</a><a href="#h66-0-89" id="h66-0-89" class="i">+                            event.view.callOnClick()
</a><a href="#h66-0-90" id="h66-0-90" class="i">+                        }
</a><a href="#h66-0-91" id="h66-0-91" class="i">+                        event.parent.postDelayed({
</a><a href="#h66-0-92" id="h66-0-92" class="i">+                            context.mainActivity!!.triggerRootCloseTouchEvent()
</a><a href="#h66-0-93" id="h66-0-93" class="i">+                        }, 400)
</a>                     }
<a href="#h66-0-95" id="h66-0-95" class="d">-                    event.parent.postDelayed({
</a><a href="#h66-0-96" id="h66-0-96" class="d">-                        context.mainActivity!!.triggerRootCloseTouchEvent()
</a><a href="#h66-0-97" id="h66-0-97" class="d">-                    }, 400)
</a>                 }
             }
         }
<b>diff --git a/<a id="h67" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/EditTextOverride.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/EditTextOverride.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/EditTextOverride.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/EditTextOverride.kt</a></b>
<a href="#h67-0" id="h67-0" class="h">@@ -5,30 +5,31 @@ import android.text.InputType
</a> import android.widget.EditText
 import android.widget.TextView
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h67-0-3" id="h67-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.util.hook.HookStage
 import me.rhunk.snapenhance.core.util.hook.hook
 import me.rhunk.snapenhance.core.util.hook.hookConstructor
 
<a href="#h67-0-8" id="h67-0-8" class="d">-class EditTextOverride : Feature(&quot;Edit Text Override&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_SYNC) {
</a><a href="#h67-0-9" id="h67-0-9" class="d">-    override fun onActivityCreate() {
</a><a href="#h67-0-10" id="h67-0-10" class="i">+class EditTextOverride : Feature(&quot;Edit Text Override&quot;) {
</a><a href="#h67-0-11" id="h67-0-11" class="i">+    override fun init() {
</a>         val editTextOverride by context.config.userInterface.editTextOverride
         if (editTextOverride.isEmpty()) return
 
<a href="#h67-0-15" id="h67-0-15" class="d">-        if (editTextOverride.contains(&quot;bypass_text_input_limit&quot;)) {
</a><a href="#h67-0-16" id="h67-0-16" class="d">-            TextView::class.java.getMethod(&quot;setFilters&quot;, Array&lt;InputFilter&gt;::class.java)
</a><a href="#h67-0-17" id="h67-0-17" class="d">-                .hook(HookStage.BEFORE) { param -&gt;
</a><a href="#h67-0-18" id="h67-0-18" class="d">-                    param.setArg(0, param.arg&lt;Array&lt;InputFilter&gt;&gt;(0).filter {
</a><a href="#h67-0-19" id="h67-0-19" class="d">-                        it !is InputFilter.LengthFilter
</a><a href="#h67-0-20" id="h67-0-20" class="d">-                    }.toTypedArray())
</a><a href="#h67-0-21" id="h67-0-21" class="d">-                }
</a><a href="#h67-0-22" id="h67-0-22" class="d">-        }
</a><a href="#h67-0-23" id="h67-0-23" class="i">+        onNextActivityCreate {
</a><a href="#h67-0-24" id="h67-0-24" class="i">+            if (editTextOverride.contains(&quot;bypass_text_input_limit&quot;)) {
</a><a href="#h67-0-25" id="h67-0-25" class="i">+                TextView::class.java.getMethod(&quot;setFilters&quot;, Array&lt;InputFilter&gt;::class.java)
</a><a href="#h67-0-26" id="h67-0-26" class="i">+                    .hook(HookStage.BEFORE) { param -&gt;
</a><a href="#h67-0-27" id="h67-0-27" class="i">+                        param.setArg(0, param.arg&lt;Array&lt;InputFilter&gt;&gt;(0).filter {
</a><a href="#h67-0-28" id="h67-0-28" class="i">+                            it !is InputFilter.LengthFilter
</a><a href="#h67-0-29" id="h67-0-29" class="i">+                        }.toTypedArray())
</a><a href="#h67-0-30" id="h67-0-30" class="i">+                    }
</a><a href="#h67-0-31" id="h67-0-31" class="i">+            }
</a> 
<a href="#h67-0-33" id="h67-0-33" class="d">-        if (editTextOverride.contains(&quot;multi_line_chat_input&quot;)) {
</a><a href="#h67-0-34" id="h67-0-34" class="d">-            findClass(&quot;com.snap.messaging.chat.features.input.InputBarEditText&quot;).apply {
</a><a href="#h67-0-35" id="h67-0-35" class="d">-                hookConstructor(HookStage.AFTER) { param -&gt;
</a><a href="#h67-0-36" id="h67-0-36" class="d">-                    val editText = param.thisObject&lt;EditText&gt;()
</a><a href="#h67-0-37" id="h67-0-37" class="d">-                    editText.inputType = editText.inputType or InputType.TYPE_TEXT_FLAG_MULTI_LINE
</a><a href="#h67-0-38" id="h67-0-38" class="i">+            if (editTextOverride.contains(&quot;multi_line_chat_input&quot;)) {
</a><a href="#h67-0-39" id="h67-0-39" class="i">+                findClass(&quot;com.snap.messaging.chat.features.input.InputBarEditText&quot;).apply {
</a><a href="#h67-0-40" id="h67-0-40" class="i">+                    hookConstructor(HookStage.AFTER) { param -&gt;
</a><a href="#h67-0-41" id="h67-0-41" class="i">+                        val editText = param.thisObject&lt;EditText&gt;()
</a><a href="#h67-0-42" id="h67-0-42" class="i">+                        editText.inputType = editText.inputType or InputType.TYPE_TEXT_FLAG_MULTI_LINE
</a><a href="#h67-0-43" id="h67-0-43" class="i">+                    }
</a>                 }
             }
         }
<b>diff --git a/<a id="h68" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/FriendFeedMessagePreview.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/FriendFeedMessagePreview.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/FriendFeedMessagePreview.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/FriendFeedMessagePreview.kt</a></b>
<a href="#h68-0" id="h68-0" class="h">@@ -8,6 +8,7 @@ import android.graphics.drawable.shapes.Shape
</a> import android.text.TextPaint
 import android.view.View
 import android.view.ViewGroup
<a href="#h68-0-3" id="h68-0-3" class="i">+import androidx.core.content.res.use
</a> import kotlinx.coroutines.Dispatchers
 import kotlinx.coroutines.ExperimentalCoroutinesApi
 import kotlinx.coroutines.launch
<a href="#h68-1" id="h68-1" class="h">@@ -17,7 +18,6 @@ import me.rhunk.snapenhance.common.util.protobuf.ProtoReader
</a> import me.rhunk.snapenhance.core.event.events.impl.BindViewEvent
 import me.rhunk.snapenhance.core.event.events.impl.BuildMessageEvent
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h68-1-3" id="h68-1-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.features.impl.experiments.EndToEndEncryption
 import me.rhunk.snapenhance.core.ui.addForegroundDrawable
 import me.rhunk.snapenhance.core.ui.removeForegroundDrawable
<a href="#h68-2" id="h68-2" class="h">@@ -29,7 +29,7 @@ import me.rhunk.snapenhance.core.wrapper.impl.getMessageText
</a> import java.util.WeakHashMap
 import kotlin.math.absoluteValue
 
<a href="#h68-2-3" id="h68-2-3" class="d">-class FriendFeedMessagePreview : Feature(&quot;FriendFeedMessagePreview&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_SYNC) {
</a><a href="#h68-2-4" id="h68-2-4" class="i">+class FriendFeedMessagePreview : Feature(&quot;FriendFeedMessagePreview&quot;) {
</a>     private val endToEndEncryption by lazy { context.feature(EndToEndEncryption::class) }
     @OptIn(ExperimentalCoroutinesApi::class)
     private val coroutineDispatcher = Dispatchers.IO.limitedParallelism(1)
<a href="#h68-3" id="h68-3" class="h">@@ -39,7 +39,7 @@ class FriendFeedMessagePreview : Feature(&quot;FriendFeedMessagePreview&quot;, loadParams 
</a>     private val sigColorTextPrimary by lazy {
         context.mainActivity!!.theme.obtainStyledAttributes(
             intArrayOf(context.resources.getIdentifier(&quot;sigColorTextPrimary&quot;, &quot;attr&quot;))
<a href="#h68-3-3" id="h68-3-3" class="d">-        ).getColor(0, 0)
</a><a href="#h68-3-4" id="h68-3-4" class="i">+        ).use { it.getColor(0, 0) }
</a>     }
 
     private val cachedLayouts = WeakHashMap&lt;String, View&gt;()
<a href="#h68-4" id="h68-4" class="h">@@ -73,82 +73,84 @@ class FriendFeedMessagePreview : Feature(&quot;FriendFeedMessagePreview&quot;, loadParams 
</a>         }
     }
 
<a href="#h68-4-3" id="h68-4-3" class="d">-    override fun onActivityCreate() {
</a><a href="#h68-4-4" id="h68-4-4" class="i">+    override fun init() {
</a>         if (setting.globalState != true) return
 
<a href="#h68-4-7" id="h68-4-7" class="d">-        val ffItemId = context.resources.getId(&quot;ff_item&quot;)
</a><a href="#h68-4-8" id="h68-4-8" class="i">+        onNextActivityCreate {
</a><a href="#h68-4-9" id="h68-4-9" class="i">+            val ffItemId = context.resources.getId(&quot;ff_item&quot;)
</a> 
<a href="#h68-4-11" id="h68-4-11" class="d">-        val secondaryTextSize = context.resources.getDimens(&quot;ff_feed_cell_secondary_text_size&quot;).toFloat()
</a><a href="#h68-4-12" id="h68-4-12" class="d">-        val ffSdlAvatarMargin = context.resources.getDimens(&quot;ff_sdl_avatar_margin&quot;)
</a><a href="#h68-4-13" id="h68-4-13" class="d">-        val ffSdlAvatarSize = context.resources.getDimens(&quot;ff_sdl_avatar_size&quot;)
</a><a href="#h68-4-14" id="h68-4-14" class="d">-        val ffSdlPrimaryTextStartMargin = context.resources.getDimens(&quot;ff_sdl_primary_text_start_margin&quot;).toFloat()
</a><a href="#h68-4-15" id="h68-4-15" class="i">+            val secondaryTextSize = context.resources.getDimens(&quot;ff_feed_cell_secondary_text_size&quot;).toFloat()
</a><a href="#h68-4-16" id="h68-4-16" class="i">+            val ffSdlAvatarMargin = context.resources.getDimens(&quot;ff_sdl_avatar_margin&quot;)
</a><a href="#h68-4-17" id="h68-4-17" class="i">+            val ffSdlAvatarSize = context.resources.getDimens(&quot;ff_sdl_avatar_size&quot;)
</a><a href="#h68-4-18" id="h68-4-18" class="i">+            val ffSdlPrimaryTextStartMargin = context.resources.getDimens(&quot;ff_sdl_primary_text_start_margin&quot;).toFloat()
</a> 
<a href="#h68-4-20" id="h68-4-20" class="d">-        val feedEntryHeight = ffSdlAvatarSize + ffSdlAvatarMargin * 2 + (4 * context.resources.displayMetrics.density).toInt()
</a><a href="#h68-4-21" id="h68-4-21" class="d">-        val separatorHeight = (context.resources.displayMetrics.density * 2).toInt()
</a><a href="#h68-4-22" id="h68-4-22" class="d">-        val avenirNextMedium = context.resources.getFont(context.resources.getIdentifier(&quot;avenir_next_medium&quot;, &quot;font&quot;))
</a><a href="#h68-4-23" id="h68-4-23" class="d">-        val textPaint = TextPaint().apply {
</a><a href="#h68-4-24" id="h68-4-24" class="d">-            textSize = secondaryTextSize
</a><a href="#h68-4-25" id="h68-4-25" class="d">-            typeface = avenirNextMedium
</a><a href="#h68-4-26" id="h68-4-26" class="d">-        }
</a><a href="#h68-4-27" id="h68-4-27" class="i">+            val feedEntryHeight = ffSdlAvatarSize + ffSdlAvatarMargin * 2 + (4 * context.resources.displayMetrics.density).toInt()
</a><a href="#h68-4-28" id="h68-4-28" class="i">+            val separatorHeight = (context.resources.displayMetrics.density * 2).toInt()
</a><a href="#h68-4-29" id="h68-4-29" class="i">+            val avenirNextMedium = context.resources.getFont(context.resources.getIdentifier(&quot;avenir_next_medium&quot;, &quot;font&quot;))
</a><a href="#h68-4-30" id="h68-4-30" class="i">+            val textPaint = TextPaint().apply {
</a><a href="#h68-4-31" id="h68-4-31" class="i">+                textSize = secondaryTextSize
</a><a href="#h68-4-32" id="h68-4-32" class="i">+                typeface = avenirNextMedium
</a><a href="#h68-4-33" id="h68-4-33" class="i">+            }
</a> 
<a href="#h68-4-35" id="h68-4-35" class="d">-        context.event.subscribe(BuildMessageEvent::class) { param -&gt;
</a><a href="#h68-4-36" id="h68-4-36" class="d">-            val conversationId = param.message.messageDescriptor?.conversationId?.toString() ?: return@subscribe
</a><a href="#h68-4-37" id="h68-4-37" class="d">-            val cachedView = cachedLayouts[conversationId] ?: return@subscribe
</a><a href="#h68-4-38" id="h68-4-38" class="d">-            context.coroutineScope.launch {
</a><a href="#h68-4-39" id="h68-4-39" class="d">-                fetchMessages(conversationId) {
</a><a href="#h68-4-40" id="h68-4-40" class="d">-                    cachedView.postInvalidateDelayed(100L)
</a><a href="#h68-4-41" id="h68-4-41" class="i">+            context.event.subscribe(BuildMessageEvent::class) { param -&gt;
</a><a href="#h68-4-42" id="h68-4-42" class="i">+                val conversationId = param.message.messageDescriptor?.conversationId?.toString() ?: return@subscribe
</a><a href="#h68-4-43" id="h68-4-43" class="i">+                val cachedView = cachedLayouts[conversationId] ?: return@subscribe
</a><a href="#h68-4-44" id="h68-4-44" class="i">+                context.coroutineScope.launch {
</a><a href="#h68-4-45" id="h68-4-45" class="i">+                    fetchMessages(conversationId) {
</a><a href="#h68-4-46" id="h68-4-46" class="i">+                        cachedView.postInvalidateDelayed(100L)
</a><a href="#h68-4-47" id="h68-4-47" class="i">+                    }
</a>                 }
             }
<a href="#h68-4-50" id="h68-4-50" class="d">-        }
</a> 
<a href="#h68-4-52" id="h68-4-52" class="d">-        context.event.subscribe(BindViewEvent::class) { param -&gt;
</a><a href="#h68-4-53" id="h68-4-53" class="d">-            param.friendFeedItem { conversationId -&gt;
</a><a href="#h68-4-54" id="h68-4-54" class="d">-                val frameLayout = param.view as ViewGroup
</a><a href="#h68-4-55" id="h68-4-55" class="d">-                val ffItem = frameLayout.findViewById&lt;View&gt;(ffItemId)
</a><a href="#h68-4-56" id="h68-4-56" class="i">+            context.event.subscribe(BindViewEvent::class) { param -&gt;
</a><a href="#h68-4-57" id="h68-4-57" class="i">+                param.friendFeedItem { conversationId -&gt;
</a><a href="#h68-4-58" id="h68-4-58" class="i">+                    val frameLayout = param.view as ViewGroup
</a><a href="#h68-4-59" id="h68-4-59" class="i">+                    val ffItem = frameLayout.findViewById&lt;View&gt;(ffItemId)
</a> 
<a href="#h68-4-61" id="h68-4-61" class="d">-                context.coroutineScope.launch(coroutineDispatcher) {
</a><a href="#h68-4-62" id="h68-4-62" class="d">-                    withContext(Dispatchers.Main) {
</a><a href="#h68-4-63" id="h68-4-63" class="d">-                        cachedLayouts.remove(conversationId)
</a><a href="#h68-4-64" id="h68-4-64" class="d">-                        frameLayout.removeForegroundDrawable(&quot;ffItem&quot;)
</a><a href="#h68-4-65" id="h68-4-65" class="d">-                    }
</a><a href="#h68-4-66" id="h68-4-66" class="i">+                    context.coroutineScope.launch(coroutineDispatcher) {
</a><a href="#h68-4-67" id="h68-4-67" class="i">+                        withContext(Dispatchers.Main) {
</a><a href="#h68-4-68" id="h68-4-68" class="i">+                            cachedLayouts.remove(conversationId)
</a><a href="#h68-4-69" id="h68-4-69" class="i">+                            frameLayout.removeForegroundDrawable(&quot;ffItem&quot;)
</a><a href="#h68-4-70" id="h68-4-70" class="i">+                        }
</a> 
<a href="#h68-4-72" id="h68-4-72" class="d">-                    fetchMessages(conversationId) {
</a><a href="#h68-4-73" id="h68-4-73" class="d">-                        var maxTextHeight = 0
</a><a href="#h68-4-74" id="h68-4-74" class="d">-                        val previewContainerHeight = messageCache[conversationId]?.sumOf { msg -&gt;
</a><a href="#h68-4-75" id="h68-4-75" class="d">-                            val rect = Rect()
</a><a href="#h68-4-76" id="h68-4-76" class="d">-                            textPaint.getTextBounds(msg, 0, msg.length, rect)
</a><a href="#h68-4-77" id="h68-4-77" class="d">-                            rect.height().also {
</a><a href="#h68-4-78" id="h68-4-78" class="d">-                                if (it &gt; maxTextHeight) maxTextHeight = it
</a><a href="#h68-4-79" id="h68-4-79" class="d">-                            }.plus(separatorHeight)
</a><a href="#h68-4-80" id="h68-4-80" class="d">-                        } ?: run {
</a><a href="#h68-4-81" id="h68-4-81" class="d">-                            ffItem.layoutParams = ffItem.layoutParams.apply {
</a><a href="#h68-4-82" id="h68-4-82" class="d">-                                height = ViewGroup.LayoutParams.MATCH_PARENT
</a><a href="#h68-4-83" id="h68-4-83" class="i">+                        fetchMessages(conversationId) {
</a><a href="#h68-4-84" id="h68-4-84" class="i">+                            var maxTextHeight = 0
</a><a href="#h68-4-85" id="h68-4-85" class="i">+                            val previewContainerHeight = messageCache[conversationId]?.sumOf { msg -&gt;
</a><a href="#h68-4-86" id="h68-4-86" class="i">+                                val rect = Rect()
</a><a href="#h68-4-87" id="h68-4-87" class="i">+                                textPaint.getTextBounds(msg, 0, msg.length, rect)
</a><a href="#h68-4-88" id="h68-4-88" class="i">+                                rect.height().also {
</a><a href="#h68-4-89" id="h68-4-89" class="i">+                                    if (it &gt; maxTextHeight) maxTextHeight = it
</a><a href="#h68-4-90" id="h68-4-90" class="i">+                                }.plus(separatorHeight)
</a><a href="#h68-4-91" id="h68-4-91" class="i">+                            } ?: run {
</a><a href="#h68-4-92" id="h68-4-92" class="i">+                                ffItem.layoutParams = ffItem.layoutParams.apply {
</a><a href="#h68-4-93" id="h68-4-93" class="i">+                                    height = ViewGroup.LayoutParams.MATCH_PARENT
</a><a href="#h68-4-94" id="h68-4-94" class="i">+                                }
</a><a href="#h68-4-95" id="h68-4-95" class="i">+                                return@fetchMessages
</a>                             }
<a href="#h68-4-97" id="h68-4-97" class="d">-                            return@fetchMessages
</a><a href="#h68-4-98" id="h68-4-98" class="d">-                        }
</a> 
<a href="#h68-4-100" id="h68-4-100" class="d">-                        ffItem.layoutParams = ffItem.layoutParams.apply {
</a><a href="#h68-4-101" id="h68-4-101" class="d">-                            height = feedEntryHeight + previewContainerHeight + separatorHeight
</a><a href="#h68-4-102" id="h68-4-102" class="d">-                        }
</a><a href="#h68-4-103" id="h68-4-103" class="i">+                            ffItem.layoutParams = ffItem.layoutParams.apply {
</a><a href="#h68-4-104" id="h68-4-104" class="i">+                                height = feedEntryHeight + previewContainerHeight + separatorHeight
</a><a href="#h68-4-105" id="h68-4-105" class="i">+                            }
</a> 
<a href="#h68-4-107" id="h68-4-107" class="d">-                        cachedLayouts[conversationId] = frameLayout
</a><a href="#h68-4-108" id="h68-4-108" class="d">-
</a><a href="#h68-4-109" id="h68-4-109" class="d">-                        frameLayout.addForegroundDrawable(&quot;ffItem&quot;, ShapeDrawable(object: Shape() {
</a><a href="#h68-4-110" id="h68-4-110" class="d">-                            override fun draw(canvas: Canvas, paint: Paint) {
</a><a href="#h68-4-111" id="h68-4-111" class="d">-                                val offsetY = canvas.height.toFloat() - previewContainerHeight
</a><a href="#h68-4-112" id="h68-4-112" class="d">-                                paint.textSize = secondaryTextSize
</a><a href="#h68-4-113" id="h68-4-113" class="d">-                                paint.color = sigColorTextPrimary
</a><a href="#h68-4-114" id="h68-4-114" class="d">-                                paint.typeface = avenirNextMedium
</a><a href="#h68-4-115" id="h68-4-115" class="d">-
</a><a href="#h68-4-116" id="h68-4-116" class="d">-                                messageCache[conversationId]?.forEachIndexed { index, messageString -&gt;
</a><a href="#h68-4-117" id="h68-4-117" class="d">-                                    canvas.drawText(messageString,
</a><a href="#h68-4-118" id="h68-4-118" class="d">-                                        feedEntryHeight + ffSdlPrimaryTextStartMargin,
</a><a href="#h68-4-119" id="h68-4-119" class="d">-                                        offsetY + index * maxTextHeight,
</a><a href="#h68-4-120" id="h68-4-120" class="d">-                                        paint
</a><a href="#h68-4-121" id="h68-4-121" class="d">-                                    )
</a><a href="#h68-4-122" id="h68-4-122" class="i">+                            cachedLayouts[conversationId] = frameLayout
</a><a href="#h68-4-123" id="h68-4-123" class="i">+
</a><a href="#h68-4-124" id="h68-4-124" class="i">+                            frameLayout.addForegroundDrawable(&quot;ffItem&quot;, ShapeDrawable(object: Shape() {
</a><a href="#h68-4-125" id="h68-4-125" class="i">+                                override fun draw(canvas: Canvas, paint: Paint) {
</a><a href="#h68-4-126" id="h68-4-126" class="i">+                                    val offsetY = canvas.height.toFloat() - previewContainerHeight
</a><a href="#h68-4-127" id="h68-4-127" class="i">+                                    paint.textSize = secondaryTextSize
</a><a href="#h68-4-128" id="h68-4-128" class="i">+                                    paint.color = sigColorTextPrimary
</a><a href="#h68-4-129" id="h68-4-129" class="i">+                                    paint.typeface = avenirNextMedium
</a><a href="#h68-4-130" id="h68-4-130" class="i">+
</a><a href="#h68-4-131" id="h68-4-131" class="i">+                                    messageCache[conversationId]?.forEachIndexed { index, messageString -&gt;
</a><a href="#h68-4-132" id="h68-4-132" class="i">+                                        canvas.drawText(messageString,
</a><a href="#h68-4-133" id="h68-4-133" class="i">+                                            feedEntryHeight + ffSdlPrimaryTextStartMargin,
</a><a href="#h68-4-134" id="h68-4-134" class="i">+                                            offsetY + index * maxTextHeight,
</a><a href="#h68-4-135" id="h68-4-135" class="i">+                                            paint
</a><a href="#h68-4-136" id="h68-4-136" class="i">+                                        )
</a><a href="#h68-4-137" id="h68-4-137" class="i">+                                    }
</a>                                 }
<a href="#h68-4-139" id="h68-4-139" class="d">-                            }
</a><a href="#h68-4-140" id="h68-4-140" class="d">-                        }))
</a><a href="#h68-4-141" id="h68-4-141" class="i">+                            }))
</a><a href="#h68-4-142" id="h68-4-142" class="i">+                        }
</a>                     }
                 }
             }
<b>diff --git a/<a id="h69" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/HideFriendFeedEntry.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/HideFriendFeedEntry.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/HideFriendFeedEntry.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/HideFriendFeedEntry.kt</a></b>
<a href="#h69-0" id="h69-0" class="h">@@ -2,7 +2,7 @@ package me.rhunk.snapenhance.core.features.impl.ui
</a> 
 import me.rhunk.snapenhance.common.data.MessagingRuleType
 import me.rhunk.snapenhance.common.data.RuleState
<a href="#h69-0-3" id="h69-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a><a href="#h69-0-4" id="h69-0-4" class="i">+
</a> import me.rhunk.snapenhance.core.features.MessagingRuleFeature
 import me.rhunk.snapenhance.core.util.dataBuilder
 import me.rhunk.snapenhance.core.util.hook.HookStage
<a href="#h69-1" id="h69-1" class="h">@@ -11,7 +11,7 @@ import me.rhunk.snapenhance.core.util.ktx.getObjectField
</a> import me.rhunk.snapenhance.core.wrapper.impl.SnapUUID
 import me.rhunk.snapenhance.mapper.impl.CallbackMapper
 
<a href="#h69-1-3" id="h69-1-3" class="d">-class HideFriendFeedEntry : MessagingRuleFeature(&quot;HideFriendFeedEntry&quot;, ruleType = MessagingRuleType.HIDE_FRIEND_FEED, loadParams = FeatureLoadParams.INIT_SYNC) {
</a><a href="#h69-1-4" id="h69-1-4" class="i">+class HideFriendFeedEntry : MessagingRuleFeature(&quot;HideFriendFeedEntry&quot;, ruleType = MessagingRuleType.HIDE_FRIEND_FEED) {
</a>     private fun createDeletedFeedEntry(conversationIdInstance: Any) = findClass(&quot;com.snapchat.client.messaging.DeletedFeedEntry&quot;).dataBuilder {
         from(&quot;mFeedEntryIdentifier&quot;) {
             set(&quot;mConversationId&quot;, conversationIdInstance)
<b>diff --git a/<a id="h70" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/HideQuickAddFriendFeed.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/HideQuickAddFriendFeed.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/HideQuickAddFriendFeed.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/HideQuickAddFriendFeed.kt</a></b>
<a href="#h70-0" id="h70-0" class="h">@@ -1,22 +1,23 @@
</a> package me.rhunk.snapenhance.core.features.impl.ui
 
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h70-0-3" id="h70-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.util.hook.HookStage
 import me.rhunk.snapenhance.core.util.hook.hookConstructor
 import me.rhunk.snapenhance.core.util.ktx.setObjectField
 import me.rhunk.snapenhance.mapper.impl.FriendingDataSourcesMapper
 
<a href="#h70-0-9" id="h70-0-9" class="d">-class HideQuickAddFriendFeed : Feature(&quot;HideQuickAddFriendFeed&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_SYNC) {
</a><a href="#h70-0-10" id="h70-0-10" class="d">-    override fun onActivityCreate() {
</a><a href="#h70-0-11" id="h70-0-11" class="i">+class HideQuickAddFriendFeed : Feature(&quot;HideQuickAddFriendFeed&quot;) {
</a><a href="#h70-0-12" id="h70-0-12" class="i">+    override fun init() {
</a>         if (!context.config.userInterface.hideQuickAddFriendFeed.get()) return
 
<a href="#h70-0-15" id="h70-0-15" class="d">-        context.mappings.useMapper(FriendingDataSourcesMapper::class) {
</a><a href="#h70-0-16" id="h70-0-16" class="d">-            classReference.getAsClass()?.hookConstructor(HookStage.AFTER) { param -&gt;
</a><a href="#h70-0-17" id="h70-0-17" class="d">-                param.thisObject&lt;Any&gt;().setObjectField(
</a><a href="#h70-0-18" id="h70-0-18" class="d">-                    quickAddSourceListField.get()!!,
</a><a href="#h70-0-19" id="h70-0-19" class="d">-                    arrayListOf&lt;Any&gt;()
</a><a href="#h70-0-20" id="h70-0-20" class="d">-                )
</a><a href="#h70-0-21" id="h70-0-21" class="i">+        onNextActivityCreate {
</a><a href="#h70-0-22" id="h70-0-22" class="i">+            context.mappings.useMapper(FriendingDataSourcesMapper::class) {
</a><a href="#h70-0-23" id="h70-0-23" class="i">+                classReference.getAsClass()?.hookConstructor(HookStage.AFTER) { param -&gt;
</a><a href="#h70-0-24" id="h70-0-24" class="i">+                    param.thisObject&lt;Any&gt;().setObjectField(
</a><a href="#h70-0-25" id="h70-0-25" class="i">+                        quickAddSourceListField.get()!!,
</a><a href="#h70-0-26" id="h70-0-26" class="i">+                        arrayListOf&lt;Any&gt;()
</a><a href="#h70-0-27" id="h70-0-27" class="i">+                    )
</a><a href="#h70-0-28" id="h70-0-28" class="i">+                }
</a>             }
         }
     }
<b>diff --git a/<a id="h71" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/HideStreakRestore.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/HideStreakRestore.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/HideStreakRestore.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/HideStreakRestore.kt</a></b>
<a href="#h71-0" id="h71-0" class="h">@@ -1,7 +1,6 @@
</a> package me.rhunk.snapenhance.core.features.impl.ui
 
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h71-0-3" id="h71-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.features.impl.messaging.Messaging
 import me.rhunk.snapenhance.core.util.dataBuilder
 import me.rhunk.snapenhance.core.util.hook.HookStage
<a href="#h71-1" id="h71-1" class="h">@@ -11,7 +10,7 @@ import me.rhunk.snapenhance.core.util.ktx.getObjectFieldOrNull
</a> import me.rhunk.snapenhance.core.util.ktx.setObjectField
 import me.rhunk.snapenhance.core.wrapper.impl.SnapUUID
 
<a href="#h71-1-3" id="h71-1-3" class="d">-class HideStreakRestore : Feature(&quot;HideStreakRestore&quot;, loadParams = FeatureLoadParams.INIT_SYNC) {
</a><a href="#h71-1-4" id="h71-1-4" class="i">+class HideStreakRestore : Feature(&quot;HideStreakRestore&quot;) {
</a>     override fun init() {
         if (!context.config.userInterface.hideStreakRestore.get()) return
 
<b>diff --git a/<a id="h72" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/MessageIndicators.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/MessageIndicators.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/MessageIndicators.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/MessageIndicators.kt</a></b>
<a href="#h72-0" id="h72-0" class="h">@@ -26,119 +26,120 @@ import me.rhunk.snapenhance.common.ui.rememberAsyncMutableState
</a> import me.rhunk.snapenhance.common.util.protobuf.ProtoReader
 import me.rhunk.snapenhance.core.event.events.impl.BindViewEvent
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h72-0-3" id="h72-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.ui.AppleLogo
 import me.rhunk.snapenhance.core.ui.removeForegroundDrawable
 import kotlin.random.Random
 
<a href="#h72-0-8" id="h72-0-8" class="d">-class MessageIndicators : Feature(&quot;Message Indicators&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_SYNC) {
</a><a href="#h72-0-9" id="h72-0-9" class="d">-    override fun onActivityCreate() {
</a><a href="#h72-0-10" id="h72-0-10" class="i">+class MessageIndicators : Feature(&quot;Message Indicators&quot;) {
</a><a href="#h72-0-11" id="h72-0-11" class="i">+    override fun init() {
</a>         val messageIndicatorsConfig = context.config.userInterface.messageIndicators.getNullable() ?: return
         if (messageIndicatorsConfig.isEmpty()) return
 
         val messageInfoTag = Random.nextLong().toString()
<a href="#h72-0-16" id="h72-0-16" class="d">-        val appleLogo = AppleLogo
</a><a href="#h72-0-17" id="h72-0-17" class="i">+        onNextActivityCreate {
</a><a href="#h72-0-18" id="h72-0-18" class="i">+            val appleLogo = AppleLogo
</a> 
<a href="#h72-0-20" id="h72-0-20" class="d">-        context.event.subscribe(BindViewEvent::class) { event -&gt;
</a><a href="#h72-0-21" id="h72-0-21" class="d">-            event.chatMessage { _, messageId -&gt;
</a><a href="#h72-0-22" id="h72-0-22" class="d">-                val parentLinearLayout = event.view.parent as? ViewGroup ?: return@subscribe
</a><a href="#h72-0-23" id="h72-0-23" class="d">-                parentLinearLayout.findViewWithTag&lt;View&gt;(messageInfoTag)?.let { parentLinearLayout.removeView(it) }
</a><a href="#h72-0-24" id="h72-0-24" class="i">+            context.event.subscribe(BindViewEvent::class) { event -&gt;
</a><a href="#h72-0-25" id="h72-0-25" class="i">+                event.chatMessage { _, messageId -&gt;
</a><a href="#h72-0-26" id="h72-0-26" class="i">+                    val parentLinearLayout = event.view.parent as? ViewGroup ?: return@subscribe
</a><a href="#h72-0-27" id="h72-0-27" class="i">+                    parentLinearLayout.findViewWithTag&lt;View&gt;(messageInfoTag)?.let { parentLinearLayout.removeView(it) }
</a> 
<a href="#h72-0-29" id="h72-0-29" class="d">-                event.view.removeForegroundDrawable(&quot;messageIndicators&quot;)
</a><a href="#h72-0-30" id="h72-0-30" class="i">+                    event.view.removeForegroundDrawable(&quot;messageIndicators&quot;)
</a> 
<a href="#h72-0-32" id="h72-0-32" class="d">-                val message = context.database.getConversationMessageFromId(messageId.toLong()) ?: return@chatMessage
</a><a href="#h72-0-33" id="h72-0-33" class="d">-                if (message.contentType != ContentType.SNAP.id &amp;&amp; message.contentType != ContentType.EXTERNAL_MEDIA.id) return@chatMessage
</a><a href="#h72-0-34" id="h72-0-34" class="d">-                val reader = ProtoReader(message.messageContent ?: return@chatMessage)
</a><a href="#h72-0-35" id="h72-0-35" class="i">+                    val message = context.database.getConversationMessageFromId(messageId.toLong()) ?: return@chatMessage
</a><a href="#h72-0-36" id="h72-0-36" class="i">+                    if (message.contentType != ContentType.SNAP.id &amp;&amp; message.contentType != ContentType.EXTERNAL_MEDIA.id) return@chatMessage
</a><a href="#h72-0-37" id="h72-0-37" class="i">+                    val reader = ProtoReader(message.messageContent ?: return@chatMessage)
</a> 
<a href="#h72-0-39" id="h72-0-39" class="d">-                createComposeView(event.view.context) {
</a><a href="#h72-0-40" id="h72-0-40" class="d">-                    Box(
</a><a href="#h72-0-41" id="h72-0-41" class="d">-                        modifier = Modifier
</a><a href="#h72-0-42" id="h72-0-42" class="d">-                            .fillMaxWidth()
</a><a href="#h72-0-43" id="h72-0-43" class="d">-                            .height(50.dp)
</a><a href="#h72-0-44" id="h72-0-44" class="d">-                            .padding(top = 4.dp, end = 1.dp),
</a><a href="#h72-0-45" id="h72-0-45" class="d">-                        contentAlignment = Alignment.TopEnd
</a><a href="#h72-0-46" id="h72-0-46" class="d">-                    ) {
</a><a href="#h72-0-47" id="h72-0-47" class="d">-                        val hasEncryption by rememberAsyncMutableState(defaultValue = false) {
</a><a href="#h72-0-48" id="h72-0-48" class="d">-                            reader.getByteArray(4, 3, 3) != null || reader.containsPath(3, 99, 3)
</a><a href="#h72-0-49" id="h72-0-49" class="d">-                        }
</a><a href="#h72-0-50" id="h72-0-50" class="d">-                        val sentFromIosDevice by rememberAsyncMutableState(defaultValue = false) {
</a><a href="#h72-0-51" id="h72-0-51" class="d">-                            if (reader.containsPath(4, 4, 3)) !reader.containsPath(4, 4, 3, 3, 17) else reader.getVarInt(4, 4, 11, 17, 7) != null
</a><a href="#h72-0-52" id="h72-0-52" class="d">-                        }
</a><a href="#h72-0-53" id="h72-0-53" class="d">-                        val sentFromWebApp by rememberAsyncMutableState(defaultValue = false) {
</a><a href="#h72-0-54" id="h72-0-54" class="d">-                            reader.getVarInt(4, 4, *(if (reader.containsPath(4, 4, 3)) intArrayOf(3, 3, 22, 1) else intArrayOf(11, 22, 1))) == 7L
</a><a href="#h72-0-55" id="h72-0-55" class="d">-                        }
</a><a href="#h72-0-56" id="h72-0-56" class="d">-                        val sentWithLocation by rememberAsyncMutableState(defaultValue = false) {
</a><a href="#h72-0-57" id="h72-0-57" class="d">-                            reader.getVarInt(4, 4, 11, 17, 5) != null
</a><a href="#h72-0-58" id="h72-0-58" class="d">-                        }
</a><a href="#h72-0-59" id="h72-0-59" class="d">-                        val sentUsingOvfEditor by rememberAsyncMutableState(defaultValue = false) {
</a><a href="#h72-0-60" id="h72-0-60" class="d">-                            (reader.getString(4, 4, 11, 12, 1) ?: reader.getString(4, 4, 11, 13, 4, 1, 2, 12, 20, 1)) == &quot;c13129f7-fe4a-44c4-9b9d-e0b26fee8f82&quot;
</a><a href="#h72-0-61" id="h72-0-61" class="d">-                        }
</a><a href="#h72-0-62" id="h72-0-62" class="d">-                        val sentUsingDirectorMode by rememberAsyncMutableState(defaultValue = false) {
</a><a href="#h72-0-63" id="h72-0-63" class="d">-                            reader.followPath(4, 4, 11, 28)?.let {
</a><a href="#h72-0-64" id="h72-0-64" class="d">-                                (it.getVarInt(1) to it.getVarInt(2)) == (0L to 0L)
</a><a href="#h72-0-65" id="h72-0-65" class="d">-                            } == true || reader.getByteArray(4, 4, 11, 13, 4, 1, 2, 12, 27, 1) != null
</a><a href="#h72-0-66" id="h72-0-66" class="d">-                        }
</a><a href="#h72-0-67" id="h72-0-67" class="d">-
</a><a href="#h72-0-68" id="h72-0-68" class="d">-                        Row(
</a><a href="#h72-0-69" id="h72-0-69" class="d">-                            verticalAlignment = Alignment.CenterVertically
</a><a href="#h72-0-70" id="h72-0-70" class="i">+                    createComposeView(event.view.context) {
</a><a href="#h72-0-71" id="h72-0-71" class="i">+                        Box(
</a><a href="#h72-0-72" id="h72-0-72" class="i">+                            modifier = Modifier
</a><a href="#h72-0-73" id="h72-0-73" class="i">+                                .fillMaxWidth()
</a><a href="#h72-0-74" id="h72-0-74" class="i">+                                .height(50.dp)
</a><a href="#h72-0-75" id="h72-0-75" class="i">+                                .padding(top = 4.dp, end = 1.dp),
</a><a href="#h72-0-76" id="h72-0-76" class="i">+                            contentAlignment = Alignment.TopEnd
</a>                         ) {
<a href="#h72-0-78" id="h72-0-78" class="d">-                            if (sentWithLocation &amp;&amp; messageIndicatorsConfig.contains(&quot;location_indicator&quot;)) {
</a><a href="#h72-0-79" id="h72-0-79" class="d">-                                Image(
</a><a href="#h72-0-80" id="h72-0-80" class="d">-                                    imageVector = Icons.Default.LocationOn,
</a><a href="#h72-0-81" id="h72-0-81" class="d">-                                    colorFilter = ColorFilter.tint(Color.Green),
</a><a href="#h72-0-82" id="h72-0-82" class="d">-                                    contentDescription = null,
</a><a href="#h72-0-83" id="h72-0-83" class="d">-                                    modifier = Modifier.size(15.dp)
</a><a href="#h72-0-84" id="h72-0-84" class="d">-                                )
</a><a href="#h72-0-85" id="h72-0-85" class="i">+                            val hasEncryption by rememberAsyncMutableState(defaultValue = false) {
</a><a href="#h72-0-86" id="h72-0-86" class="i">+                                reader.getByteArray(4, 3, 3) != null || reader.containsPath(3, 99, 3)
</a><a href="#h72-0-87" id="h72-0-87" class="i">+                            }
</a><a href="#h72-0-88" id="h72-0-88" class="i">+                            val sentFromIosDevice by rememberAsyncMutableState(defaultValue = false) {
</a><a href="#h72-0-89" id="h72-0-89" class="i">+                                if (reader.containsPath(4, 4, 3)) !reader.containsPath(4, 4, 3, 3, 17) else reader.getVarInt(4, 4, 11, 17, 7) != null
</a><a href="#h72-0-90" id="h72-0-90" class="i">+                            }
</a><a href="#h72-0-91" id="h72-0-91" class="i">+                            val sentFromWebApp by rememberAsyncMutableState(defaultValue = false) {
</a><a href="#h72-0-92" id="h72-0-92" class="i">+                                reader.getVarInt(4, 4, *(if (reader.containsPath(4, 4, 3)) intArrayOf(3, 3, 22, 1) else intArrayOf(11, 22, 1))) == 7L
</a>                             }
<a href="#h72-0-94" id="h72-0-94" class="d">-                            if (messageIndicatorsConfig.contains(&quot;platform_indicator&quot;)) {
</a><a href="#h72-0-95" id="h72-0-95" class="d">-                                Image(
</a><a href="#h72-0-96" id="h72-0-96" class="d">-                                    imageVector = when {
</a><a href="#h72-0-97" id="h72-0-97" class="d">-                                        sentFromWebApp -&gt; Icons.Default.Laptop
</a><a href="#h72-0-98" id="h72-0-98" class="d">-                                        sentFromIosDevice -&gt; appleLogo
</a><a href="#h72-0-99" id="h72-0-99" class="d">-                                        else -&gt; Icons.Default.Android
</a><a href="#h72-0-100" id="h72-0-100" class="d">-                                    },
</a><a href="#h72-0-101" id="h72-0-101" class="d">-                                    colorFilter = ColorFilter.tint(Color.Green),
</a><a href="#h72-0-102" id="h72-0-102" class="d">-                                    contentDescription = null,
</a><a href="#h72-0-103" id="h72-0-103" class="d">-                                    modifier = Modifier.size(15.dp)
</a><a href="#h72-0-104" id="h72-0-104" class="d">-                                )
</a><a href="#h72-0-105" id="h72-0-105" class="i">+                            val sentWithLocation by rememberAsyncMutableState(defaultValue = false) {
</a><a href="#h72-0-106" id="h72-0-106" class="i">+                                reader.getVarInt(4, 4, 11, 17, 5) != null
</a>                             }
<a href="#h72-0-108" id="h72-0-108" class="d">-                            if (hasEncryption &amp;&amp; messageIndicatorsConfig.contains(&quot;encryption_indicator&quot;)) {
</a><a href="#h72-0-109" id="h72-0-109" class="d">-                                Image(
</a><a href="#h72-0-110" id="h72-0-110" class="d">-                                    imageVector = Icons.Default.Lock,
</a><a href="#h72-0-111" id="h72-0-111" class="d">-                                    colorFilter = ColorFilter.tint(Color.Green),
</a><a href="#h72-0-112" id="h72-0-112" class="d">-                                    contentDescription = null,
</a><a href="#h72-0-113" id="h72-0-113" class="d">-                                    modifier = Modifier.size(15.dp)
</a><a href="#h72-0-114" id="h72-0-114" class="d">-                                )
</a><a href="#h72-0-115" id="h72-0-115" class="i">+                            val sentUsingOvfEditor by rememberAsyncMutableState(defaultValue = false) {
</a><a href="#h72-0-116" id="h72-0-116" class="i">+                                (reader.getString(4, 4, 11, 12, 1) ?: reader.getString(4, 4, 11, 13, 4, 1, 2, 12, 20, 1)) == &quot;c13129f7-fe4a-44c4-9b9d-e0b26fee8f82&quot;
</a>                             }
<a href="#h72-0-118" id="h72-0-118" class="d">-                            if (sentUsingDirectorMode &amp;&amp; messageIndicatorsConfig.contains(&quot;director_mode_indicator&quot;)) {
</a><a href="#h72-0-119" id="h72-0-119" class="d">-                                Image(
</a><a href="#h72-0-120" id="h72-0-120" class="d">-                                    imageVector = Icons.Default.Edit,
</a><a href="#h72-0-121" id="h72-0-121" class="d">-                                    colorFilter = ColorFilter.tint(Color.Red),
</a><a href="#h72-0-122" id="h72-0-122" class="d">-                                    contentDescription = null,
</a><a href="#h72-0-123" id="h72-0-123" class="d">-                                    modifier = Modifier.size(15.dp)
</a><a href="#h72-0-124" id="h72-0-124" class="d">-                                )
</a><a href="#h72-0-125" id="h72-0-125" class="i">+                            val sentUsingDirectorMode by rememberAsyncMutableState(defaultValue = false) {
</a><a href="#h72-0-126" id="h72-0-126" class="i">+                                reader.followPath(4, 4, 11, 28)?.let {
</a><a href="#h72-0-127" id="h72-0-127" class="i">+                                    (it.getVarInt(1) to it.getVarInt(2)) == (0L to 0L)
</a><a href="#h72-0-128" id="h72-0-128" class="i">+                                } == true || reader.getByteArray(4, 4, 11, 13, 4, 1, 2, 12, 27, 1) != null
</a>                             }
<a href="#h72-0-130" id="h72-0-130" class="d">-                            if (sentUsingOvfEditor &amp;&amp; messageIndicatorsConfig.contains(&quot;ovf_editor_indicator&quot;)) {
</a><a href="#h72-0-131" id="h72-0-131" class="d">-                                Text(
</a><a href="#h72-0-132" id="h72-0-132" class="d">-                                    text = &quot;OVF&quot;,
</a><a href="#h72-0-133" id="h72-0-133" class="d">-                                    color = Color.Red,
</a><a href="#h72-0-134" id="h72-0-134" class="d">-                                    fontWeight = FontWeight.ExtraBold,
</a><a href="#h72-0-135" id="h72-0-135" class="d">-                                    fontSize = 10.sp,
</a><a href="#h72-0-136" id="h72-0-136" class="d">-                                )
</a><a href="#h72-0-137" id="h72-0-137" class="i">+
</a><a href="#h72-0-138" id="h72-0-138" class="i">+                            Row(
</a><a href="#h72-0-139" id="h72-0-139" class="i">+                                verticalAlignment = Alignment.CenterVertically
</a><a href="#h72-0-140" id="h72-0-140" class="i">+                            ) {
</a><a href="#h72-0-141" id="h72-0-141" class="i">+                                if (sentWithLocation &amp;&amp; messageIndicatorsConfig.contains(&quot;location_indicator&quot;)) {
</a><a href="#h72-0-142" id="h72-0-142" class="i">+                                    Image(
</a><a href="#h72-0-143" id="h72-0-143" class="i">+                                        imageVector = Icons.Default.LocationOn,
</a><a href="#h72-0-144" id="h72-0-144" class="i">+                                        colorFilter = ColorFilter.tint(Color.Green),
</a><a href="#h72-0-145" id="h72-0-145" class="i">+                                        contentDescription = null,
</a><a href="#h72-0-146" id="h72-0-146" class="i">+                                        modifier = Modifier.size(15.dp)
</a><a href="#h72-0-147" id="h72-0-147" class="i">+                                    )
</a><a href="#h72-0-148" id="h72-0-148" class="i">+                                }
</a><a href="#h72-0-149" id="h72-0-149" class="i">+                                if (messageIndicatorsConfig.contains(&quot;platform_indicator&quot;)) {
</a><a href="#h72-0-150" id="h72-0-150" class="i">+                                    Image(
</a><a href="#h72-0-151" id="h72-0-151" class="i">+                                        imageVector = when {
</a><a href="#h72-0-152" id="h72-0-152" class="i">+                                            sentFromWebApp -&gt; Icons.Default.Laptop
</a><a href="#h72-0-153" id="h72-0-153" class="i">+                                            sentFromIosDevice -&gt; appleLogo
</a><a href="#h72-0-154" id="h72-0-154" class="i">+                                            else -&gt; Icons.Default.Android
</a><a href="#h72-0-155" id="h72-0-155" class="i">+                                        },
</a><a href="#h72-0-156" id="h72-0-156" class="i">+                                        colorFilter = ColorFilter.tint(Color.Green),
</a><a href="#h72-0-157" id="h72-0-157" class="i">+                                        contentDescription = null,
</a><a href="#h72-0-158" id="h72-0-158" class="i">+                                        modifier = Modifier.size(15.dp)
</a><a href="#h72-0-159" id="h72-0-159" class="i">+                                    )
</a><a href="#h72-0-160" id="h72-0-160" class="i">+                                }
</a><a href="#h72-0-161" id="h72-0-161" class="i">+                                if (hasEncryption &amp;&amp; messageIndicatorsConfig.contains(&quot;encryption_indicator&quot;)) {
</a><a href="#h72-0-162" id="h72-0-162" class="i">+                                    Image(
</a><a href="#h72-0-163" id="h72-0-163" class="i">+                                        imageVector = Icons.Default.Lock,
</a><a href="#h72-0-164" id="h72-0-164" class="i">+                                        colorFilter = ColorFilter.tint(Color.Green),
</a><a href="#h72-0-165" id="h72-0-165" class="i">+                                        contentDescription = null,
</a><a href="#h72-0-166" id="h72-0-166" class="i">+                                        modifier = Modifier.size(15.dp)
</a><a href="#h72-0-167" id="h72-0-167" class="i">+                                    )
</a><a href="#h72-0-168" id="h72-0-168" class="i">+                                }
</a><a href="#h72-0-169" id="h72-0-169" class="i">+                                if (sentUsingDirectorMode &amp;&amp; messageIndicatorsConfig.contains(&quot;director_mode_indicator&quot;)) {
</a><a href="#h72-0-170" id="h72-0-170" class="i">+                                    Image(
</a><a href="#h72-0-171" id="h72-0-171" class="i">+                                        imageVector = Icons.Default.Edit,
</a><a href="#h72-0-172" id="h72-0-172" class="i">+                                        colorFilter = ColorFilter.tint(Color.Red),
</a><a href="#h72-0-173" id="h72-0-173" class="i">+                                        contentDescription = null,
</a><a href="#h72-0-174" id="h72-0-174" class="i">+                                        modifier = Modifier.size(15.dp)
</a><a href="#h72-0-175" id="h72-0-175" class="i">+                                    )
</a><a href="#h72-0-176" id="h72-0-176" class="i">+                                }
</a><a href="#h72-0-177" id="h72-0-177" class="i">+                                if (sentUsingOvfEditor &amp;&amp; messageIndicatorsConfig.contains(&quot;ovf_editor_indicator&quot;)) {
</a><a href="#h72-0-178" id="h72-0-178" class="i">+                                    Text(
</a><a href="#h72-0-179" id="h72-0-179" class="i">+                                        text = &quot;OVF&quot;,
</a><a href="#h72-0-180" id="h72-0-180" class="i">+                                        color = Color.Red,
</a><a href="#h72-0-181" id="h72-0-181" class="i">+                                        fontWeight = FontWeight.ExtraBold,
</a><a href="#h72-0-182" id="h72-0-182" class="i">+                                        fontSize = 10.sp,
</a><a href="#h72-0-183" id="h72-0-183" class="i">+                                    )
</a><a href="#h72-0-184" id="h72-0-184" class="i">+                                }
</a>                             }
                         }
<a href="#h72-0-187" id="h72-0-187" class="i">+                    }.apply {
</a><a href="#h72-0-188" id="h72-0-188" class="i">+                        tag = messageInfoTag
</a><a href="#h72-0-189" id="h72-0-189" class="i">+                        addOnLayoutChangeListener { _, left, _, right, _, _, _, _, _ -&gt;
</a><a href="#h72-0-190" id="h72-0-190" class="i">+                            layout(left, 0, right, 0)
</a><a href="#h72-0-191" id="h72-0-191" class="i">+                        }
</a><a href="#h72-0-192" id="h72-0-192" class="i">+                        setPadding(0, 0, 0, -(50 * event.view.resources.displayMetrics.density).toInt())
</a><a href="#h72-0-193" id="h72-0-193" class="i">+                        layoutParams = LinearLayout.LayoutParams(
</a><a href="#h72-0-194" id="h72-0-194" class="i">+                            LinearLayout.LayoutParams.MATCH_PARENT,
</a><a href="#h72-0-195" id="h72-0-195" class="i">+                            LinearLayout.LayoutParams.WRAP_CONTENT
</a><a href="#h72-0-196" id="h72-0-196" class="i">+                        )
</a><a href="#h72-0-197" id="h72-0-197" class="i">+                        parentLinearLayout.addView(this)
</a>                     }
<a href="#h72-0-199" id="h72-0-199" class="d">-                }.apply {
</a><a href="#h72-0-200" id="h72-0-200" class="d">-                    tag = messageInfoTag
</a><a href="#h72-0-201" id="h72-0-201" class="d">-                    addOnLayoutChangeListener { _, left, _, right, _, _, _, _, _ -&gt;
</a><a href="#h72-0-202" id="h72-0-202" class="d">-                        layout(left, 0, right, 0)
</a><a href="#h72-0-203" id="h72-0-203" class="d">-                    }
</a><a href="#h72-0-204" id="h72-0-204" class="d">-                    setPadding(0, 0, 0, -(50 * event.view.resources.displayMetrics.density).toInt())
</a><a href="#h72-0-205" id="h72-0-205" class="d">-                    layoutParams = LinearLayout.LayoutParams(
</a><a href="#h72-0-206" id="h72-0-206" class="d">-                        LinearLayout.LayoutParams.MATCH_PARENT,
</a><a href="#h72-0-207" id="h72-0-207" class="d">-                        LinearLayout.LayoutParams.WRAP_CONTENT
</a><a href="#h72-0-208" id="h72-0-208" class="d">-                    )
</a><a href="#h72-0-209" id="h72-0-209" class="d">-                    parentLinearLayout.addView(this)
</a>                 }
             }
         }
<b>diff --git a/<a id="h73" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/OldBitmojiSelfie.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/OldBitmojiSelfie.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/OldBitmojiSelfie.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/OldBitmojiSelfie.kt</a></b>
<a href="#h73-0" id="h73-0" class="h">@@ -4,9 +4,8 @@ import android.net.Uri
</a> import me.rhunk.snapenhance.common.util.snap.BitmojiSelfie
 import me.rhunk.snapenhance.core.event.events.impl.NetworkApiRequestEvent
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h73-0-3" id="h73-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> 
<a href="#h73-0-5" id="h73-0-5" class="d">-class OldBitmojiSelfie : Feature(&quot;OldBitmojiSelfie&quot;, loadParams = FeatureLoadParams.INIT_SYNC) {
</a><a href="#h73-0-6" id="h73-0-6" class="i">+class OldBitmojiSelfie : Feature(&quot;OldBitmojiSelfie&quot;) {
</a>     override fun init() {
         val urlPrefixes = arrayOf(&quot;https://images.bitmoji.com/3d/render/&quot;, &quot;https://cf-st.sc-cdn.net/3d/render/&quot;)
         val oldBitmojiSelfie = context.config.userInterface.oldBitmojiSelfie.getNullable() ?: return
<b>diff --git a/<a id="h74" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/PinConversations.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/PinConversations.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/PinConversations.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/PinConversations.kt</a></b>
<a href="#h74-0" id="h74-0" class="h">@@ -2,7 +2,6 @@ package me.rhunk.snapenhance.core.features.impl.ui
</a> 
 import me.rhunk.snapenhance.common.data.MessagingRuleType
 import me.rhunk.snapenhance.common.data.RuleState
<a href="#h74-0-3" id="h74-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.features.MessagingRuleFeature
 import me.rhunk.snapenhance.core.util.hook.HookStage
 import me.rhunk.snapenhance.core.util.hook.Hooker
<a href="#h74-1" id="h74-1" class="h">@@ -12,8 +11,8 @@ import me.rhunk.snapenhance.core.util.ktx.getObjectField
</a> import me.rhunk.snapenhance.core.util.ktx.setObjectField
 import me.rhunk.snapenhance.core.wrapper.impl.SnapUUID
 
<a href="#h74-1-3" id="h74-1-3" class="d">-class PinConversations : MessagingRuleFeature(&quot;PinConversations&quot;, MessagingRuleType.PIN_CONVERSATION, loadParams = FeatureLoadParams.ACTIVITY_CREATE_SYNC) {
</a><a href="#h74-1-4" id="h74-1-4" class="d">-    override fun onActivityCreate() {
</a><a href="#h74-1-5" id="h74-1-5" class="i">+class PinConversations : MessagingRuleFeature(&quot;PinConversations&quot;, MessagingRuleType.PIN_CONVERSATION) {
</a><a href="#h74-1-6" id="h74-1-6" class="i">+    override fun init() {
</a>         if (!context.config.messaging.unlimitedConversationPinning.get()) return
 
         context.classCache.feedManager.hook(&quot;setPinnedConversationStatus&quot;, HookStage.BEFORE) { param -&gt;
<b>diff --git a/<a id="h75" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/SnapPreview.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/SnapPreview.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/SnapPreview.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/SnapPreview.kt</a></b>
<a href="#h75-0" id="h75-0" class="h">@@ -10,7 +10,6 @@ import me.rhunk.snapenhance.common.data.ContentType
</a> import me.rhunk.snapenhance.common.util.protobuf.ProtoReader
 import me.rhunk.snapenhance.core.event.events.impl.BindViewEvent
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h75-0-3" id="h75-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.ui.addForegroundDrawable
 import me.rhunk.snapenhance.core.ui.removeForegroundDrawable
 import me.rhunk.snapenhance.core.util.EvictingMap
<a href="#h75-1" id="h75-1" class="h">@@ -22,7 +21,7 @@ import me.rhunk.snapenhance.core.util.media.PreviewUtils
</a> import me.rhunk.snapenhance.mapper.impl.CallbackMapper
 import java.io.File
 
<a href="#h75-1-3" id="h75-1-3" class="d">-class SnapPreview : Feature(&quot;SnapPreview&quot;, loadParams = FeatureLoadParams.INIT_SYNC or FeatureLoadParams.ACTIVITY_CREATE_SYNC) {
</a><a href="#h75-1-4" id="h75-1-4" class="i">+class SnapPreview : Feature(&quot;SnapPreview&quot;) {
</a>     private val mediaFileCache = EvictingMap&lt;String, File&gt;(500) // mMediaId =&gt; mediaFile
     private val bitmapCache = EvictingMap&lt;String, Bitmap&gt;(50) // filePath =&gt; bitmap
 
<a href="#h75-2" id="h75-2" class="h">@@ -44,48 +43,46 @@ class SnapPreview : Feature(&quot;SnapPreview&quot;, loadParams = FeatureLoadParams.INIT_S
</a>                 mediaFileCache[mediaId.substringAfter(&quot;-&quot;)] = File(filePath.toString())
             }
         }
<a href="#h75-2-3" id="h75-2-3" class="d">-    }
</a> 
<a href="#h75-2-5" id="h75-2-5" class="d">-    @SuppressLint(&quot;DiscouragedApi&quot;)
</a><a href="#h75-2-6" id="h75-2-6" class="d">-    override fun onActivityCreate() {
</a><a href="#h75-2-7" id="h75-2-7" class="d">-        if (!isEnabled) return
</a><a href="#h75-2-8" id="h75-2-8" class="d">-        val chatMediaCardHeight = context.resources.getDimens(&quot;chat_media_card_height&quot;)
</a><a href="#h75-2-9" id="h75-2-9" class="d">-        val chatMediaCardSnapMargin = context.resources.getDimens(&quot;chat_media_card_snap_margin&quot;)
</a><a href="#h75-2-10" id="h75-2-10" class="d">-        val chatMediaCardSnapMarginStartSdl = context.resources.getDimens(&quot;chat_media_card_snap_margin_start_sdl&quot;)
</a><a href="#h75-2-11" id="h75-2-11" class="i">+        onNextActivityCreate {
</a><a href="#h75-2-12" id="h75-2-12" class="i">+            val chatMediaCardHeight = context.resources.getDimens(&quot;chat_media_card_height&quot;)
</a><a href="#h75-2-13" id="h75-2-13" class="i">+            val chatMediaCardSnapMargin = context.resources.getDimens(&quot;chat_media_card_snap_margin&quot;)
</a><a href="#h75-2-14" id="h75-2-14" class="i">+            val chatMediaCardSnapMarginStartSdl = context.resources.getDimens(&quot;chat_media_card_snap_margin_start_sdl&quot;)
</a> 
<a href="#h75-2-16" id="h75-2-16" class="d">-        fun decodeMedia(file: File) = runCatching {
</a><a href="#h75-2-17" id="h75-2-17" class="d">-            bitmapCache.getOrPut(file.absolutePath) {
</a><a href="#h75-2-18" id="h75-2-18" class="d">-                PreviewUtils.resizeBitmap(
</a><a href="#h75-2-19" id="h75-2-19" class="d">-                    PreviewUtils.createPreviewFromFile(file) ?: return@runCatching null,
</a><a href="#h75-2-20" id="h75-2-20" class="d">-                    chatMediaCardHeight - chatMediaCardSnapMargin,
</a><a href="#h75-2-21" id="h75-2-21" class="d">-                    chatMediaCardHeight - chatMediaCardSnapMargin
</a><a href="#h75-2-22" id="h75-2-22" class="d">-                )
</a><a href="#h75-2-23" id="h75-2-23" class="d">-            }
</a><a href="#h75-2-24" id="h75-2-24" class="d">-        }.getOrNull()
</a><a href="#h75-2-25" id="h75-2-25" class="i">+            fun decodeMedia(file: File) = runCatching {
</a><a href="#h75-2-26" id="h75-2-26" class="i">+                bitmapCache.getOrPut(file.absolutePath) {
</a><a href="#h75-2-27" id="h75-2-27" class="i">+                    PreviewUtils.resizeBitmap(
</a><a href="#h75-2-28" id="h75-2-28" class="i">+                        PreviewUtils.createPreviewFromFile(file) ?: return@runCatching null,
</a><a href="#h75-2-29" id="h75-2-29" class="i">+                        chatMediaCardHeight - chatMediaCardSnapMargin,
</a><a href="#h75-2-30" id="h75-2-30" class="i">+                        chatMediaCardHeight - chatMediaCardSnapMargin
</a><a href="#h75-2-31" id="h75-2-31" class="i">+                    )
</a><a href="#h75-2-32" id="h75-2-32" class="i">+                }
</a><a href="#h75-2-33" id="h75-2-33" class="i">+            }.getOrNull()
</a> 
<a href="#h75-2-35" id="h75-2-35" class="d">-        context.event.subscribe(BindViewEvent::class) { event -&gt;
</a><a href="#h75-2-36" id="h75-2-36" class="d">-            event.chatMessage { _, messageId -&gt;
</a><a href="#h75-2-37" id="h75-2-37" class="d">-                event.view.removeForegroundDrawable(&quot;snapPreview&quot;)
</a><a href="#h75-2-38" id="h75-2-38" class="i">+            context.event.subscribe(BindViewEvent::class) { event -&gt;
</a><a href="#h75-2-39" id="h75-2-39" class="i">+                event.chatMessage { _, messageId -&gt;
</a><a href="#h75-2-40" id="h75-2-40" class="i">+                    event.view.removeForegroundDrawable(&quot;snapPreview&quot;)
</a> 
<a href="#h75-2-42" id="h75-2-42" class="d">-                val message = context.database.getConversationMessageFromId(messageId.toLong()) ?: return@chatMessage
</a><a href="#h75-2-43" id="h75-2-43" class="d">-                val messageReader = ProtoReader(message.messageContent ?: return@chatMessage)
</a><a href="#h75-2-44" id="h75-2-44" class="d">-                val contentType = ContentType.fromMessageContainer(messageReader.followPath(4, 4))
</a><a href="#h75-2-45" id="h75-2-45" class="i">+                    val message = context.database.getConversationMessageFromId(messageId.toLong()) ?: return@chatMessage
</a><a href="#h75-2-46" id="h75-2-46" class="i">+                    val messageReader = ProtoReader(message.messageContent ?: return@chatMessage)
</a><a href="#h75-2-47" id="h75-2-47" class="i">+                    val contentType = ContentType.fromMessageContainer(messageReader.followPath(4, 4))
</a> 
<a href="#h75-2-49" id="h75-2-49" class="d">-                if (contentType != ContentType.SNAP || message.isSaved == 1) return@chatMessage
</a><a href="#h75-2-50" id="h75-2-50" class="i">+                    if (contentType != ContentType.SNAP || message.isSaved == 1) return@chatMessage
</a> 
<a href="#h75-2-52" id="h75-2-52" class="d">-                val mediaIdKey = messageReader.getString(4, 5, 1, 3, 2, 2) ?: return@chatMessage
</a><a href="#h75-2-53" id="h75-2-53" class="i">+                    val mediaIdKey = messageReader.getString(4, 5, 1, 3, 2, 2) ?: return@chatMessage
</a> 
<a href="#h75-2-55" id="h75-2-55" class="d">-                event.view.addForegroundDrawable(&quot;snapPreview&quot;, ShapeDrawable(object: Shape() {
</a><a href="#h75-2-56" id="h75-2-56" class="d">-                    override fun draw(canvas: Canvas, paint: Paint) {
</a><a href="#h75-2-57" id="h75-2-57" class="d">-                        val bitmap = mediaFileCache[mediaIdKey]?.let { decodeMedia(it) } ?: return
</a><a href="#h75-2-58" id="h75-2-58" class="i">+                    event.view.addForegroundDrawable(&quot;snapPreview&quot;, ShapeDrawable(object: Shape() {
</a><a href="#h75-2-59" id="h75-2-59" class="i">+                        override fun draw(canvas: Canvas, paint: Paint) {
</a><a href="#h75-2-60" id="h75-2-60" class="i">+                            val bitmap = mediaFileCache[mediaIdKey]?.let { decodeMedia(it) } ?: return
</a> 
<a href="#h75-2-62" id="h75-2-62" class="d">-                        canvas.drawBitmap(bitmap,
</a><a href="#h75-2-63" id="h75-2-63" class="d">-                            canvas.width.toFloat() - bitmap.width - chatMediaCardSnapMarginStartSdl.toFloat() - chatMediaCardSnapMargin.toFloat(),
</a><a href="#h75-2-64" id="h75-2-64" class="d">-                            (canvas.height - bitmap.height) / 2f,
</a><a href="#h75-2-65" id="h75-2-65" class="d">-                            null
</a><a href="#h75-2-66" id="h75-2-66" class="d">-                        )
</a><a href="#h75-2-67" id="h75-2-67" class="d">-                    }
</a><a href="#h75-2-68" id="h75-2-68" class="d">-                }))
</a><a href="#h75-2-69" id="h75-2-69" class="i">+                            canvas.drawBitmap(bitmap,
</a><a href="#h75-2-70" id="h75-2-70" class="i">+                                canvas.width.toFloat() - bitmap.width - chatMediaCardSnapMarginStartSdl.toFloat() - chatMediaCardSnapMargin.toFloat(),
</a><a href="#h75-2-71" id="h75-2-71" class="i">+                                (canvas.height - bitmap.height) / 2f,
</a><a href="#h75-2-72" id="h75-2-72" class="i">+                                null
</a><a href="#h75-2-73" id="h75-2-73" class="i">+                            )
</a><a href="#h75-2-74" id="h75-2-74" class="i">+                        }
</a><a href="#h75-2-75" id="h75-2-75" class="i">+                    }))
</a><a href="#h75-2-76" id="h75-2-76" class="i">+                }
</a>             }
         }
     }
<b>diff --git a/<a id="h76" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/SpotlightCommentsUsername.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/SpotlightCommentsUsername.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/SpotlightCommentsUsername.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/SpotlightCommentsUsername.kt</a></b>
<a href="#h76-0" id="h76-0" class="h">@@ -7,47 +7,48 @@ import kotlinx.coroutines.launch
</a> import kotlinx.coroutines.withContext
 import me.rhunk.snapenhance.core.event.events.impl.BindViewEvent
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h76-0-3" id="h76-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.features.impl.messaging.Messaging
 import me.rhunk.snapenhance.core.util.EvictingMap
 import me.rhunk.snapenhance.core.util.ktx.getId
 
<a href="#h76-0-8" id="h76-0-8" class="d">-class SpotlightCommentsUsername : Feature(&quot;SpotlightCommentsUsername&quot;, loadParams =  FeatureLoadParams.ACTIVITY_CREATE_SYNC) {
</a><a href="#h76-0-9" id="h76-0-9" class="i">+class SpotlightCommentsUsername : Feature(&quot;SpotlightCommentsUsername&quot;) {
</a>     private val usernameCache = EvictingMap&lt;String, String&gt;(150)
 
     @SuppressLint(&quot;SetTextI18n&quot;)
<a href="#h76-0-13" id="h76-0-13" class="d">-    override fun onActivityCreate() {
</a><a href="#h76-0-14" id="h76-0-14" class="i">+    override fun init() {
</a>         if (!context.config.global.spotlightCommentsUsername.get()) return
 
<a href="#h76-0-17" id="h76-0-17" class="d">-        val messaging = context.feature(Messaging::class)
</a><a href="#h76-0-18" id="h76-0-18" class="d">-        val commentsCreatorBadgeTimestampId = context.resources.getId(&quot;comments_creator_badge_timestamp&quot;)
</a><a href="#h76-0-19" id="h76-0-19" class="i">+        onNextActivityCreate(defer = true) {
</a><a href="#h76-0-20" id="h76-0-20" class="i">+            val messaging = context.feature(Messaging::class)
</a><a href="#h76-0-21" id="h76-0-21" class="i">+            val commentsCreatorBadgeTimestampId = context.resources.getId(&quot;comments_creator_badge_timestamp&quot;)
</a> 
<a href="#h76-0-23" id="h76-0-23" class="d">-        context.event.subscribe(BindViewEvent::class) { event -&gt;
</a><a href="#h76-0-24" id="h76-0-24" class="d">-            val commentsCreatorBadgeTimestamp = event.view.findViewById&lt;TextView&gt;(commentsCreatorBadgeTimestampId) ?: return@subscribe
</a><a href="#h76-0-25" id="h76-0-25" class="i">+            context.event.subscribe(BindViewEvent::class) { event -&gt;
</a><a href="#h76-0-26" id="h76-0-26" class="i">+                val commentsCreatorBadgeTimestamp = event.view.findViewById&lt;TextView&gt;(commentsCreatorBadgeTimestampId) ?: return@subscribe
</a> 
<a href="#h76-0-28" id="h76-0-28" class="d">-            val posterUserId = event.prevModel.toString().takeIf { it.startsWith(&quot;Comment&quot;) }
</a><a href="#h76-0-29" id="h76-0-29" class="d">-                ?.substringAfter(&quot;posterUserId=&quot;)?.substringBefore(&quot;,&quot;)?.substringBefore(&quot;)&quot;) ?: return@subscribe
</a><a href="#h76-0-30" id="h76-0-30" class="i">+                val posterUserId = event.prevModel.toString().takeIf { it.startsWith(&quot;Comment&quot;) }
</a><a href="#h76-0-31" id="h76-0-31" class="i">+                    ?.substringAfter(&quot;posterUserId=&quot;)?.substringBefore(&quot;,&quot;)?.substringBefore(&quot;)&quot;) ?: return@subscribe
</a> 
<a href="#h76-0-33" id="h76-0-33" class="d">-            fun setUsername(username: String) {
</a><a href="#h76-0-34" id="h76-0-34" class="d">-                usernameCache[posterUserId] = username
</a><a href="#h76-0-35" id="h76-0-35" class="d">-                if (commentsCreatorBadgeTimestamp.text.contains(username)) return
</a><a href="#h76-0-36" id="h76-0-36" class="d">-                commentsCreatorBadgeTimestamp.text = &quot; (${username})&quot; + commentsCreatorBadgeTimestamp.text.toString()
</a><a href="#h76-0-37" id="h76-0-37" class="d">-            }
</a><a href="#h76-0-38" id="h76-0-38" class="i">+                fun setUsername(username: String) {
</a><a href="#h76-0-39" id="h76-0-39" class="i">+                    usernameCache[posterUserId] = username
</a><a href="#h76-0-40" id="h76-0-40" class="i">+                    if (commentsCreatorBadgeTimestamp.text.contains(username)) return
</a><a href="#h76-0-41" id="h76-0-41" class="i">+                    commentsCreatorBadgeTimestamp.text = &quot; (${username})&quot; + commentsCreatorBadgeTimestamp.text.toString()
</a><a href="#h76-0-42" id="h76-0-42" class="i">+                }
</a> 
<a href="#h76-0-44" id="h76-0-44" class="d">-            usernameCache[posterUserId]?.let {
</a><a href="#h76-0-45" id="h76-0-45" class="d">-                setUsername(it)
</a><a href="#h76-0-46" id="h76-0-46" class="d">-                return@subscribe
</a><a href="#h76-0-47" id="h76-0-47" class="d">-            }
</a><a href="#h76-0-48" id="h76-0-48" class="i">+                usernameCache[posterUserId]?.let {
</a><a href="#h76-0-49" id="h76-0-49" class="i">+                    setUsername(it)
</a><a href="#h76-0-50" id="h76-0-50" class="i">+                    return@subscribe
</a><a href="#h76-0-51" id="h76-0-51" class="i">+                }
</a> 
<a href="#h76-0-53" id="h76-0-53" class="d">-            context.coroutineScope.launch {
</a><a href="#h76-0-54" id="h76-0-54" class="d">-                val username = runCatching {
</a><a href="#h76-0-55" id="h76-0-55" class="d">-                    messaging.fetchSnapchatterInfos(listOf(posterUserId)).firstOrNull()
</a><a href="#h76-0-56" id="h76-0-56" class="d">-                }.onFailure {
</a><a href="#h76-0-57" id="h76-0-57" class="d">-                    context.log.error(&quot;Failed to fetch snapchatter info for user $posterUserId&quot;, it)
</a><a href="#h76-0-58" id="h76-0-58" class="d">-                }.getOrNull()?.username ?: return@launch
</a><a href="#h76-0-59" id="h76-0-59" class="i">+                context.coroutineScope.launch {
</a><a href="#h76-0-60" id="h76-0-60" class="i">+                    val username = runCatching {
</a><a href="#h76-0-61" id="h76-0-61" class="i">+                        messaging.fetchSnapchatterInfos(listOf(posterUserId)).firstOrNull()
</a><a href="#h76-0-62" id="h76-0-62" class="i">+                    }.onFailure {
</a><a href="#h76-0-63" id="h76-0-63" class="i">+                        context.log.error(&quot;Failed to fetch snapchatter info for user $posterUserId&quot;, it)
</a><a href="#h76-0-64" id="h76-0-64" class="i">+                    }.getOrNull()?.username ?: return@launch
</a> 
<a href="#h76-0-66" id="h76-0-66" class="d">-                withContext(Dispatchers.Main) {
</a><a href="#h76-0-67" id="h76-0-67" class="d">-                    setUsername(username)
</a><a href="#h76-0-68" id="h76-0-68" class="i">+                    withContext(Dispatchers.Main) {
</a><a href="#h76-0-69" id="h76-0-69" class="i">+                        setUsername(username)
</a><a href="#h76-0-70" id="h76-0-70" class="i">+                    }
</a>                 }
             }
         }
<b>diff --git a/<a id="h77" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/StealthModeIndicator.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/StealthModeIndicator.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/StealthModeIndicator.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/StealthModeIndicator.kt</a></b>
<a href="#h77-0" id="h77-0" class="h">@@ -4,12 +4,12 @@ import android.graphics.Canvas
</a> import android.graphics.Paint
 import android.graphics.drawable.ShapeDrawable
 import android.graphics.drawable.shapes.Shape
<a href="#h77-0-3" id="h77-0-3" class="i">+import androidx.core.content.res.use
</a> import kotlinx.coroutines.Dispatchers
 import kotlinx.coroutines.launch
 import kotlinx.coroutines.withContext
 import me.rhunk.snapenhance.core.event.events.impl.BindViewEvent
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h77-0-9" id="h77-0-9" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.features.impl.spying.StealthMode
 import me.rhunk.snapenhance.core.ui.addForegroundDrawable
 import me.rhunk.snapenhance.core.ui.removeForegroundDrawable
<a href="#h77-1" id="h77-1" class="h">@@ -17,7 +17,7 @@ import me.rhunk.snapenhance.core.util.EvictingMap
</a> import me.rhunk.snapenhance.core.util.ktx.getDimens
 import me.rhunk.snapenhance.core.util.ktx.getIdentifier
 
<a href="#h77-1-3" id="h77-1-3" class="d">-class StealthModeIndicator : Feature(&quot;StealthModeIndicator&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_SYNC) {
</a><a href="#h77-1-4" id="h77-1-4" class="i">+class StealthModeIndicator : Feature(&quot;StealthModeIndicator&quot;) {
</a>     private val stealthMode by lazy { context.feature(StealthMode::class) }
     private val listeners = EvictingMap&lt;String, (Boolean) -&gt; Unit&gt;(100)
 
<a href="#h77-2" id="h77-2" class="h">@@ -30,46 +30,48 @@ class StealthModeIndicator : Feature(&quot;StealthModeIndicator&quot;, loadParams = Featur
</a>         }
     }
 
<a href="#h77-2-3" id="h77-2-3" class="d">-    override fun onActivityCreate() {
</a><a href="#h77-2-4" id="h77-2-4" class="i">+    override fun init() {
</a>         if (!context.config.userInterface.stealthModeIndicator.get()) return
 
<a href="#h77-2-7" id="h77-2-7" class="d">-        val secondaryTextSize = context.resources.getDimens(&quot;ff_feed_cell_secondary_text_size&quot;).toFloat()
</a><a href="#h77-2-8" id="h77-2-8" class="d">-        val sigColorTextPrimary = context.mainActivity!!.obtainStyledAttributes(
</a><a href="#h77-2-9" id="h77-2-9" class="d">-            intArrayOf(context.resources.getIdentifier(&quot;sigColorTextPrimary&quot;, &quot;attr&quot;))
</a><a href="#h77-2-10" id="h77-2-10" class="d">-        ).use { it.getColor(0, 0) }
</a><a href="#h77-2-11" id="h77-2-11" class="i">+        onNextActivityCreate {
</a><a href="#h77-2-12" id="h77-2-12" class="i">+            val secondaryTextSize = context.resources.getDimens(&quot;ff_feed_cell_secondary_text_size&quot;).toFloat()
</a><a href="#h77-2-13" id="h77-2-13" class="i">+            val sigColorTextPrimary = context.mainActivity!!.obtainStyledAttributes(
</a><a href="#h77-2-14" id="h77-2-14" class="i">+                intArrayOf(context.resources.getIdentifier(&quot;sigColorTextPrimary&quot;, &quot;attr&quot;))
</a><a href="#h77-2-15" id="h77-2-15" class="i">+            ).use { it.getColor(0, 0) }
</a> 
<a href="#h77-2-17" id="h77-2-17" class="d">-        stealthMode.addStateListener { conversationId, state -&gt;
</a><a href="#h77-2-18" id="h77-2-18" class="d">-            runCatching {
</a><a href="#h77-2-19" id="h77-2-19" class="d">-                listeners[conversationId]?.invoke(state)
</a><a href="#h77-2-20" id="h77-2-20" class="d">-            }.onFailure {
</a><a href="#h77-2-21" id="h77-2-21" class="d">-                context.log.error(&quot;Failed to update stealth mode indicator&quot;, it)
</a><a href="#h77-2-22" id="h77-2-22" class="d">-            }
</a><a href="#h77-2-23" id="h77-2-23" class="d">-        }
</a><a href="#h77-2-24" id="h77-2-24" class="d">-
</a><a href="#h77-2-25" id="h77-2-25" class="d">-        context.event.subscribe(BindViewEvent::class) { event -&gt;
</a><a href="#h77-2-26" id="h77-2-26" class="d">-            fun updateStealthIndicator(isStealth: Boolean = true) {
</a><a href="#h77-2-27" id="h77-2-27" class="d">-                event.view.removeForegroundDrawable(&quot;stealthModeIndicator&quot;)
</a><a href="#h77-2-28" id="h77-2-28" class="d">-                if (!isStealth || !event.view.isAttachedToWindow) return
</a><a href="#h77-2-29" id="h77-2-29" class="d">-                event.view.addForegroundDrawable(&quot;stealthModeIndicator&quot;, ShapeDrawable(object : Shape() {
</a><a href="#h77-2-30" id="h77-2-30" class="d">-                    override fun draw(canvas: Canvas, paint: Paint) {
</a><a href="#h77-2-31" id="h77-2-31" class="d">-                        paint.textSize = secondaryTextSize
</a><a href="#h77-2-32" id="h77-2-32" class="d">-                        paint.color = sigColorTextPrimary
</a><a href="#h77-2-33" id="h77-2-33" class="d">-                        canvas.drawText(
</a><a href="#h77-2-34" id="h77-2-34" class="d">-                            &quot;\uD83D\uDC7B&quot;,
</a><a href="#h77-2-35" id="h77-2-35" class="d">-                            0f,
</a><a href="#h77-2-36" id="h77-2-36" class="d">-                            canvas.height.toFloat() - secondaryTextSize / 2,
</a><a href="#h77-2-37" id="h77-2-37" class="d">-                            paint
</a><a href="#h77-2-38" id="h77-2-38" class="d">-                        )
</a><a href="#h77-2-39" id="h77-2-39" class="d">-                    }
</a><a href="#h77-2-40" id="h77-2-40" class="d">-                }))
</a><a href="#h77-2-41" id="h77-2-41" class="i">+            stealthMode.addStateListener { conversationId, state -&gt;
</a><a href="#h77-2-42" id="h77-2-42" class="i">+                runCatching {
</a><a href="#h77-2-43" id="h77-2-43" class="i">+                    listeners[conversationId]?.invoke(state)
</a><a href="#h77-2-44" id="h77-2-44" class="i">+                }.onFailure {
</a><a href="#h77-2-45" id="h77-2-45" class="i">+                    context.log.error(&quot;Failed to update stealth mode indicator&quot;, it)
</a><a href="#h77-2-46" id="h77-2-46" class="i">+                }
</a>             }
 
<a href="#h77-2-49" id="h77-2-49" class="d">-            event.friendFeedItem { conversationId -&gt;
</a><a href="#h77-2-50" id="h77-2-50" class="d">-                listeners[conversationId] = addStateListener@{ stealth -&gt;
</a><a href="#h77-2-51" id="h77-2-51" class="d">-                    updateStealthIndicator(stealth)
</a><a href="#h77-2-52" id="h77-2-52" class="i">+            context.event.subscribe(BindViewEvent::class) { event -&gt;
</a><a href="#h77-2-53" id="h77-2-53" class="i">+                fun updateStealthIndicator(isStealth: Boolean = true) {
</a><a href="#h77-2-54" id="h77-2-54" class="i">+                    event.view.removeForegroundDrawable(&quot;stealthModeIndicator&quot;)
</a><a href="#h77-2-55" id="h77-2-55" class="i">+                    if (!isStealth || !event.view.isAttachedToWindow) return
</a><a href="#h77-2-56" id="h77-2-56" class="i">+                    event.view.addForegroundDrawable(&quot;stealthModeIndicator&quot;, ShapeDrawable(object : Shape() {
</a><a href="#h77-2-57" id="h77-2-57" class="i">+                        override fun draw(canvas: Canvas, paint: Paint) {
</a><a href="#h77-2-58" id="h77-2-58" class="i">+                            paint.textSize = secondaryTextSize
</a><a href="#h77-2-59" id="h77-2-59" class="i">+                            paint.color = sigColorTextPrimary
</a><a href="#h77-2-60" id="h77-2-60" class="i">+                            canvas.drawText(
</a><a href="#h77-2-61" id="h77-2-61" class="i">+                                &quot;\uD83D\uDC7B&quot;,
</a><a href="#h77-2-62" id="h77-2-62" class="i">+                                0f,
</a><a href="#h77-2-63" id="h77-2-63" class="i">+                                canvas.height.toFloat() - secondaryTextSize / 2,
</a><a href="#h77-2-64" id="h77-2-64" class="i">+                                paint
</a><a href="#h77-2-65" id="h77-2-65" class="i">+                            )
</a><a href="#h77-2-66" id="h77-2-66" class="i">+                        }
</a><a href="#h77-2-67" id="h77-2-67" class="i">+                    }))
</a>                 }
<a href="#h77-2-69" id="h77-2-69" class="d">-                fetchStealthState(conversationId) { isStealth -&gt;
</a><a href="#h77-2-70" id="h77-2-70" class="d">-                    updateStealthIndicator(isStealth)
</a><a href="#h77-2-71" id="h77-2-71" class="i">+
</a><a href="#h77-2-72" id="h77-2-72" class="i">+                event.friendFeedItem { conversationId -&gt;
</a><a href="#h77-2-73" id="h77-2-73" class="i">+                    listeners[conversationId] = addStateListener@{ stealth -&gt;
</a><a href="#h77-2-74" id="h77-2-74" class="i">+                        updateStealthIndicator(stealth)
</a><a href="#h77-2-75" id="h77-2-75" class="i">+                    }
</a><a href="#h77-2-76" id="h77-2-76" class="i">+                    fetchStealthState(conversationId) { isStealth -&gt;
</a><a href="#h77-2-77" id="h77-2-77" class="i">+                        updateStealthIndicator(isStealth)
</a><a href="#h77-2-78" id="h77-2-78" class="i">+                    }
</a>                 }
             }
         }
<b>diff --git a/<a id="h78" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/UITweaks.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/UITweaks.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/UITweaks.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/UITweaks.kt</a></b>
<a href="#h78-0" id="h78-0" class="h">@@ -10,13 +10,12 @@ import me.rhunk.snapenhance.core.event.events.impl.AddViewEvent
</a> import me.rhunk.snapenhance.core.event.events.impl.BindViewEvent
 import me.rhunk.snapenhance.core.event.events.impl.LayoutInflateEvent
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h78-0-3" id="h78-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.util.hook.HookStage
 import me.rhunk.snapenhance.core.util.hook.Hooker
 import me.rhunk.snapenhance.core.util.hook.hook
 import me.rhunk.snapenhance.core.util.ktx.getIdentifier
 
<a href="#h78-0-9" id="h78-0-9" class="d">-class UITweaks : Feature(&quot;UITweaks&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_SYNC) {
</a><a href="#h78-0-10" id="h78-0-10" class="i">+class UITweaks : Feature(&quot;UITweaks&quot;) {
</a>     private val identifierCache = mutableMapOf&lt;String, Int&gt;()
 
     fun getId(name: String, defType: String): Int {
<a href="#h78-1" id="h78-1" class="h">@@ -47,7 +46,7 @@ class UITweaks : Feature(&quot;UITweaks&quot;, loadParams = FeatureLoadParams.ACTIVITY_CRE
</a>         }
     }
 
<a href="#h78-1-3" id="h78-1-3" class="d">-    override fun onActivityCreate() {
</a><a href="#h78-1-4" id="h78-1-4" class="i">+    private fun onActivityCreate() {
</a>         val blockAds by context.config.global.blockAds
         val hiddenElements by context.config.userInterface.hideUiComponents
         val hideStorySuggestions by context.config.userInterface.hideStorySuggestions
<a href="#h78-2" id="h78-2" class="h">@@ -172,4 +171,10 @@ class UITweaks : Feature(&quot;UITweaks&quot;, loadParams = FeatureLoadParams.ACTIVITY_CRE
</a>             }
         }
     }
<a href="#h78-2-3" id="h78-2-3" class="i">+
</a><a href="#h78-2-4" id="h78-2-4" class="i">+    override fun init() {
</a><a href="#h78-2-5" id="h78-2-5" class="i">+        onNextActivityCreate {
</a><a href="#h78-2-6" id="h78-2-6" class="i">+            onActivityCreate()
</a><a href="#h78-2-7" id="h78-2-7" class="i">+        }
</a><a href="#h78-2-8" id="h78-2-8" class="i">+    }
</a> } 
\ No newline at end of file
<b>diff --git a/<a id="h79" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/ui/ViewAppearanceHelper.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/ViewAppearanceHelper.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/ui/ViewAppearanceHelper.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/ViewAppearanceHelper.kt</a></b>
<a href="#h79-0" id="h79-0" class="h">@@ -19,6 +19,7 @@ import android.view.View
</a> import android.view.ViewGroup
 import android.widget.Switch
 import android.widget.TextView
<a href="#h79-0-3" id="h79-0-3" class="i">+import androidx.core.content.res.use
</a> import me.rhunk.snapenhance.core.SnapEnhance
 import me.rhunk.snapenhance.core.util.ktx.getDimens
 import me.rhunk.snapenhance.core.util.ktx.getDimensFloat
<a href="#h79-1" id="h79-1" class="h">@@ -136,10 +137,10 @@ object ViewAppearanceHelper {
</a> 
         val sigColorTextPrimary = component.context.theme.obtainStyledAttributes(
             intArrayOf(resources.getIdentifier(&quot;sigColorTextPrimary&quot;, &quot;attr&quot;))
<a href="#h79-1-3" id="h79-1-3" class="d">-        ).getColor(0, 0)
</a><a href="#h79-1-4" id="h79-1-4" class="i">+        ).use { it.getColor(0, 0) }
</a>         val sigColorBackgroundSurface = component.context.theme.obtainStyledAttributes(
             intArrayOf(resources.getIdentifier(&quot;sigColorBackgroundSurface&quot;, &quot;attr&quot;))
<a href="#h79-1-7" id="h79-1-7" class="d">-        ).getColor(0, 0)
</a><a href="#h79-1-8" id="h79-1-8" class="i">+        ).use { it.getColor(0, 0) }
</a> 
         val actionSheetDefaultCellHeight = resources.getDimens(&quot;action_sheet_default_cell_height&quot;)
         val actionSheetCornerRadius = resources.getDimensFloat(&quot;action_sheet_corner_radius&quot;)
<b>diff --git a/<a id="h80" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/MenuViewInjector.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/MenuViewInjector.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/MenuViewInjector.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/MenuViewInjector.kt</a></b>
<a href="#h80-0" id="h80-0" class="h">@@ -9,7 +9,6 @@ import android.widget.LinearLayout
</a> import android.widget.ScrollView
 import me.rhunk.snapenhance.core.event.events.impl.AddViewEvent
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h80-0-3" id="h80-0-3" class="d">-import me.rhunk.snapenhance.core.features.FeatureLoadParams
</a> import me.rhunk.snapenhance.core.features.impl.COFOverride
 import me.rhunk.snapenhance.core.features.impl.messaging.Messaging
 import me.rhunk.snapenhance.core.ui.findParent
<a href="#h80-1" id="h80-1" class="h">@@ -18,7 +17,7 @@ import me.rhunk.snapenhance.core.util.ktx.getIdentifier
</a> import kotlin.reflect.KClass
 
 @SuppressLint(&quot;DiscouragedApi&quot;)
<a href="#h80-1-3" id="h80-1-3" class="d">-class MenuViewInjector : Feature(&quot;MenuViewInjector&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_ASYNC) {
</a><a href="#h80-1-4" id="h80-1-4" class="i">+class MenuViewInjector : Feature(&quot;MenuViewInjector&quot;) {
</a>     private val menuMap by lazy {
         arrayOf(
             NewChatActionMenu(),
<a href="#h80-2" id="h80-2" class="h">@@ -40,113 +39,115 @@ class MenuViewInjector : Feature(&quot;MenuViewInjector&quot;, loadParams = FeatureLoadPar
</a>         return menuMap[menuClass] as? T
     }
 
<a href="#h80-2-3" id="h80-2-3" class="d">-    override fun asyncOnActivityCreate() {
</a><a href="#h80-2-4" id="h80-2-4" class="d">-        menuMap.forEach { it.value.init() }
</a><a href="#h80-2-5" id="h80-2-5" class="d">-
</a><a href="#h80-2-6" id="h80-2-6" class="d">-        val messaging = context.feature(Messaging::class)
</a><a href="#h80-2-7" id="h80-2-7" class="d">-
</a><a href="#h80-2-8" id="h80-2-8" class="d">-        val actionSheetItemsContainerLayoutId = context.resources.getIdentifier(&quot;action_sheet_items_container&quot;, &quot;id&quot;)
</a><a href="#h80-2-9" id="h80-2-9" class="d">-        val actionMenuTitle = context.resources.getIdentifier(&quot;action_menu_title&quot;, &quot;id&quot;)
</a><a href="#h80-2-10" id="h80-2-10" class="d">-        val actionMenu = context.resources.getIdentifier(&quot;action_menu&quot;, &quot;id&quot;)
</a><a href="#h80-2-11" id="h80-2-11" class="d">-        val componentsHolder = context.resources.getIdentifier(&quot;components_holder&quot;, &quot;id&quot;)
</a><a href="#h80-2-12" id="h80-2-12" class="d">-        val feedNewChat = context.resources.getIdentifier(&quot;feed_new_chat&quot;, &quot;id&quot;)
</a><a href="#h80-2-13" id="h80-2-13" class="d">-        val contextMenuButtonIconView = context.resources.getIdentifier(&quot;context_menu_button_icon_view&quot;, &quot;id&quot;)
</a><a href="#h80-2-14" id="h80-2-14" class="d">-        val chatActionMenu = context.resources.getIdentifier(&quot;chat_action_menu&quot;, &quot;id&quot;)
</a><a href="#h80-2-15" id="h80-2-15" class="d">-
</a><a href="#h80-2-16" id="h80-2-16" class="d">-        val hasV2ActionMenu = { context.feature(COFOverride::class).hasActionMenuV2 }
</a><a href="#h80-2-17" id="h80-2-17" class="d">-
</a><a href="#h80-2-18" id="h80-2-18" class="d">-        context.event.subscribe(AddViewEvent::class) { event -&gt;
</a><a href="#h80-2-19" id="h80-2-19" class="d">-            val originalAddView: (View) -&gt; Unit = {
</a><a href="#h80-2-20" id="h80-2-20" class="d">-                event.adapter.invokeOriginal(arrayOf(it, -1,
</a><a href="#h80-2-21" id="h80-2-21" class="d">-                    FrameLayout.LayoutParams(
</a><a href="#h80-2-22" id="h80-2-22" class="d">-                        ViewGroup.LayoutParams.MATCH_PARENT,
</a><a href="#h80-2-23" id="h80-2-23" class="d">-                        ViewGroup.LayoutParams.MATCH_PARENT
</a><a href="#h80-2-24" id="h80-2-24" class="d">-                    ))
</a><a href="#h80-2-25" id="h80-2-25" class="d">-                )
</a><a href="#h80-2-26" id="h80-2-26" class="d">-            }
</a><a href="#h80-2-27" id="h80-2-27" class="i">+    override fun init() {
</a><a href="#h80-2-28" id="h80-2-28" class="i">+        onNextActivityCreate(defer = true) {
</a><a href="#h80-2-29" id="h80-2-29" class="i">+            menuMap.forEach { it.value.init() }
</a> 
<a href="#h80-2-31" id="h80-2-31" class="d">-            val viewGroup: ViewGroup = event.parent
</a><a href="#h80-2-32" id="h80-2-32" class="d">-            val childView: View = event.view
</a><a href="#h80-2-33" id="h80-2-33" class="d">-            menuMap[OperaContextActionMenu::class]!!.inject(viewGroup, childView, originalAddView)
</a><a href="#h80-2-34" id="h80-2-34" class="i">+            val messaging = context.feature(Messaging::class)
</a> 
<a href="#h80-2-36" id="h80-2-36" class="d">-            if (event.view.id == actionSheetItemsContainerLayoutId) {
</a><a href="#h80-2-37" id="h80-2-37" class="d">-                event.view.post {
</a><a href="#h80-2-38" id="h80-2-38" class="d">-                    if (event.parent.findParent(4) {
</a><a href="#h80-2-39" id="h80-2-39" class="d">-                        it.findViewById&lt;View&gt;(actionMenuTitle) != null
</a><a href="#h80-2-40" id="h80-2-40" class="d">-                    } == null) return@post
</a><a href="#h80-2-41" id="h80-2-41" class="i">+            val actionSheetItemsContainerLayoutId = context.resources.getIdentifier(&quot;action_sheet_items_container&quot;, &quot;id&quot;)
</a><a href="#h80-2-42" id="h80-2-42" class="i">+            val actionMenuTitle = context.resources.getIdentifier(&quot;action_menu_title&quot;, &quot;id&quot;)
</a><a href="#h80-2-43" id="h80-2-43" class="i">+            val actionMenu = context.resources.getIdentifier(&quot;action_menu&quot;, &quot;id&quot;)
</a><a href="#h80-2-44" id="h80-2-44" class="i">+            val componentsHolder = context.resources.getIdentifier(&quot;components_holder&quot;, &quot;id&quot;)
</a><a href="#h80-2-45" id="h80-2-45" class="i">+            val feedNewChat = context.resources.getIdentifier(&quot;feed_new_chat&quot;, &quot;id&quot;)
</a><a href="#h80-2-46" id="h80-2-46" class="i">+            val contextMenuButtonIconView = context.resources.getIdentifier(&quot;context_menu_button_icon_view&quot;, &quot;id&quot;)
</a><a href="#h80-2-47" id="h80-2-47" class="i">+            val chatActionMenu = context.resources.getIdentifier(&quot;chat_action_menu&quot;, &quot;id&quot;)
</a> 
<a href="#h80-2-49" id="h80-2-49" class="d">-                    val views = mutableListOf&lt;View&gt;()
</a><a href="#h80-2-50" id="h80-2-50" class="d">-                    menuMap[FriendFeedInfoMenu::class]?.inject(event.parent, event.view) {
</a><a href="#h80-2-51" id="h80-2-51" class="d">-                        views.add(it)
</a><a href="#h80-2-52" id="h80-2-52" class="d">-                    }
</a><a href="#h80-2-53" id="h80-2-53" class="d">-                    views.reversed().forEach { (event.view as ViewGroup).addView(it, 0) }
</a><a href="#h80-2-54" id="h80-2-54" class="i">+            val hasV2ActionMenu = { context.feature(COFOverride::class).hasActionMenuV2 }
</a><a href="#h80-2-55" id="h80-2-55" class="i">+
</a><a href="#h80-2-56" id="h80-2-56" class="i">+            context.event.subscribe(AddViewEvent::class) { event -&gt;
</a><a href="#h80-2-57" id="h80-2-57" class="i">+                val originalAddView: (View) -&gt; Unit = {
</a><a href="#h80-2-58" id="h80-2-58" class="i">+                    event.adapter.invokeOriginal(arrayOf(it, -1,
</a><a href="#h80-2-59" id="h80-2-59" class="i">+                        FrameLayout.LayoutParams(
</a><a href="#h80-2-60" id="h80-2-60" class="i">+                            ViewGroup.LayoutParams.MATCH_PARENT,
</a><a href="#h80-2-61" id="h80-2-61" class="i">+                            ViewGroup.LayoutParams.MATCH_PARENT
</a><a href="#h80-2-62" id="h80-2-62" class="i">+                        ))
</a><a href="#h80-2-63" id="h80-2-63" class="i">+                    )
</a>                 }
<a href="#h80-2-65" id="h80-2-65" class="d">-            }
</a> 
<a href="#h80-2-67" id="h80-2-67" class="d">-            if (childView.id == contextMenuButtonIconView) {
</a><a href="#h80-2-68" id="h80-2-68" class="d">-                menuMap[OperaViewerIcons::class]!!.inject(viewGroup, childView, originalAddView)
</a><a href="#h80-2-69" id="h80-2-69" class="d">-            }
</a><a href="#h80-2-70" id="h80-2-70" class="i">+                val viewGroup: ViewGroup = event.parent
</a><a href="#h80-2-71" id="h80-2-71" class="i">+                val childView: View = event.view
</a><a href="#h80-2-72" id="h80-2-72" class="i">+                menuMap[OperaContextActionMenu::class]!!.inject(viewGroup, childView, originalAddView)
</a> 
<a href="#h80-2-74" id="h80-2-74" class="d">-            if (event.parent.id == componentsHolder &amp;&amp; childView.id == feedNewChat) {
</a><a href="#h80-2-75" id="h80-2-75" class="d">-                menuMap[SettingsGearInjector::class]!!.inject(viewGroup, childView, originalAddView)
</a><a href="#h80-2-76" id="h80-2-76" class="d">-                return@subscribe
</a><a href="#h80-2-77" id="h80-2-77" class="d">-            }
</a><a href="#h80-2-78" id="h80-2-78" class="i">+                if (event.view.id == actionSheetItemsContainerLayoutId) {
</a><a href="#h80-2-79" id="h80-2-79" class="i">+                    event.view.post {
</a><a href="#h80-2-80" id="h80-2-80" class="i">+                        if (event.parent.findParent(4) {
</a><a href="#h80-2-81" id="h80-2-81" class="i">+                                it.findViewById&lt;View&gt;(actionMenuTitle) != null
</a><a href="#h80-2-82" id="h80-2-82" class="i">+                            } == null) return@post
</a> 
<a href="#h80-2-84" id="h80-2-84" class="d">-            if (viewGroup !is LinearLayout &amp;&amp; childView.id == chatActionMenu &amp;&amp; context.isDeveloper) {
</a><a href="#h80-2-85" id="h80-2-85" class="d">-                event.view = LinearLayout(childView.context).apply {
</a><a href="#h80-2-86" id="h80-2-86" class="d">-                    orientation = LinearLayout.VERTICAL
</a><a href="#h80-2-87" id="h80-2-87" class="d">-                    addView(
</a><a href="#h80-2-88" id="h80-2-88" class="d">-                        (menuMap[NewChatActionMenu::class]!! as NewChatActionMenu).createDebugInfoView(childView.context)
</a><a href="#h80-2-89" id="h80-2-89" class="d">-                    )
</a><a href="#h80-2-90" id="h80-2-90" class="d">-                    addView(event.view)
</a><a href="#h80-2-91" id="h80-2-91" class="i">+                        val views = mutableListOf&lt;View&gt;()
</a><a href="#h80-2-92" id="h80-2-92" class="i">+                        menuMap[FriendFeedInfoMenu::class]?.inject(event.parent, event.view) {
</a><a href="#h80-2-93" id="h80-2-93" class="i">+                            views.add(it)
</a><a href="#h80-2-94" id="h80-2-94" class="i">+                        }
</a><a href="#h80-2-95" id="h80-2-95" class="i">+                        views.reversed().forEach { (event.view as ViewGroup).addView(it, 0) }
</a><a href="#h80-2-96" id="h80-2-96" class="i">+                    }
</a>                 }
<a href="#h80-2-98" id="h80-2-98" class="d">-            }
</a> 
<a href="#h80-2-100" id="h80-2-100" class="d">-            if (childView.javaClass.name.endsWith(&quot;ChatActionMenuComponent&quot;) &amp;&amp; hasV2ActionMenu()) {
</a><a href="#h80-2-101" id="h80-2-101" class="d">-                (menuMap[NewChatActionMenu::class]!! as NewChatActionMenu).handle(event)
</a><a href="#h80-2-102" id="h80-2-102" class="d">-                return@subscribe
</a><a href="#h80-2-103" id="h80-2-103" class="d">-            }
</a><a href="#h80-2-104" id="h80-2-104" class="i">+                if (childView.id == contextMenuButtonIconView) {
</a><a href="#h80-2-105" id="h80-2-105" class="i">+                    menuMap[OperaViewerIcons::class]!!.inject(viewGroup, childView, originalAddView)
</a><a href="#h80-2-106" id="h80-2-106" class="i">+                }
</a> 
<a href="#h80-2-108" id="h80-2-108" class="d">-            if (viewGroup.javaClass.name.endsWith(&quot;ActionMenuChatItemContainer&quot;) &amp;&amp; !hasV2ActionMenu()) {
</a><a href="#h80-2-109" id="h80-2-109" class="d">-                if (viewGroup.parent == null || viewGroup.parent.parent == null) return@subscribe
</a><a href="#h80-2-110" id="h80-2-110" class="d">-                menuMap[ChatActionMenu::class]!!.inject(viewGroup, childView, originalAddView)
</a><a href="#h80-2-111" id="h80-2-111" class="d">-                return@subscribe
</a><a href="#h80-2-112" id="h80-2-112" class="d">-            }
</a><a href="#h80-2-113" id="h80-2-113" class="i">+                if (event.parent.id == componentsHolder &amp;&amp; childView.id == feedNewChat) {
</a><a href="#h80-2-114" id="h80-2-114" class="i">+                    menuMap[SettingsGearInjector::class]!!.inject(viewGroup, childView, originalAddView)
</a><a href="#h80-2-115" id="h80-2-115" class="i">+                    return@subscribe
</a><a href="#h80-2-116" id="h80-2-116" class="i">+                }
</a> 
<a href="#h80-2-118" id="h80-2-118" class="d">-            if (viewGroup !is LinearLayout &amp;&amp; childView.id == actionMenu &amp;&amp; messaging.lastFocusedConversationType == 1) {
</a><a href="#h80-2-119" id="h80-2-119" class="d">-                val injectedLayout = LinearLayout(childView.context).apply {
</a><a href="#h80-2-120" id="h80-2-120" class="d">-                    orientation = LinearLayout.VERTICAL
</a><a href="#h80-2-121" id="h80-2-121" class="d">-                    gravity = Gravity.BOTTOM
</a><a href="#h80-2-122" id="h80-2-122" class="d">-                    layoutParams = ViewGroup.LayoutParams(ViewGroup.LayoutParams.MATCH_PARENT, ViewGroup.LayoutParams.MATCH_PARENT)
</a><a href="#h80-2-123" id="h80-2-123" class="d">-                    addView(childView)
</a><a href="#h80-2-124" id="h80-2-124" class="i">+                if (viewGroup !is LinearLayout &amp;&amp; childView.id == chatActionMenu &amp;&amp; context.isDeveloper) {
</a><a href="#h80-2-125" id="h80-2-125" class="i">+                    event.view = LinearLayout(childView.context).apply {
</a><a href="#h80-2-126" id="h80-2-126" class="i">+                        orientation = LinearLayout.VERTICAL
</a><a href="#h80-2-127" id="h80-2-127" class="i">+                        addView(
</a><a href="#h80-2-128" id="h80-2-128" class="i">+                            (menuMap[NewChatActionMenu::class]!! as NewChatActionMenu).createDebugInfoView(childView.context)
</a><a href="#h80-2-129" id="h80-2-129" class="i">+                        )
</a><a href="#h80-2-130" id="h80-2-130" class="i">+                        addView(event.view)
</a><a href="#h80-2-131" id="h80-2-131" class="i">+                    }
</a>                 }
 
<a href="#h80-2-134" id="h80-2-134" class="d">-                event.parent.post {
</a><a href="#h80-2-135" id="h80-2-135" class="d">-                    injectedLayout.addView(ScrollView(injectedLayout.context).apply {
</a><a href="#h80-2-136" id="h80-2-136" class="d">-                        layoutParams = LinearLayout.LayoutParams(
</a><a href="#h80-2-137" id="h80-2-137" class="d">-                            ViewGroup.LayoutParams.MATCH_PARENT,
</a><a href="#h80-2-138" id="h80-2-138" class="d">-                            ViewGroup.LayoutParams.WRAP_CONTENT
</a><a href="#h80-2-139" id="h80-2-139" class="d">-                        ).apply {
</a><a href="#h80-2-140" id="h80-2-140" class="d">-                            weight = 1f;
</a><a href="#h80-2-141" id="h80-2-141" class="d">-                            setMargins(0, 100, 0, 0)
</a><a href="#h80-2-142" id="h80-2-142" class="d">-                        }
</a><a href="#h80-2-143" id="h80-2-143" class="i">+                if (childView.javaClass.name.endsWith(&quot;ChatActionMenuComponent&quot;) &amp;&amp; hasV2ActionMenu()) {
</a><a href="#h80-2-144" id="h80-2-144" class="i">+                    (menuMap[NewChatActionMenu::class]!! as NewChatActionMenu).handle(event)
</a><a href="#h80-2-145" id="h80-2-145" class="i">+                    return@subscribe
</a><a href="#h80-2-146" id="h80-2-146" class="i">+                }
</a> 
<a href="#h80-2-148" id="h80-2-148" class="d">-                        addView(LinearLayout(context).apply {
</a><a href="#h80-2-149" id="h80-2-149" class="d">-                            orientation = LinearLayout.VERTICAL
</a><a href="#h80-2-150" id="h80-2-150" class="d">-                            menuMap[FriendFeedInfoMenu::class]?.inject(event.parent, injectedLayout) { view -&gt;
</a><a href="#h80-2-151" id="h80-2-151" class="d">-                                view.layoutParams = LinearLayout.LayoutParams(
</a><a href="#h80-2-152" id="h80-2-152" class="d">-                                    ViewGroup.LayoutParams.MATCH_PARENT,
</a><a href="#h80-2-153" id="h80-2-153" class="d">-                                    ViewGroup.LayoutParams.WRAP_CONTENT
</a><a href="#h80-2-154" id="h80-2-154" class="d">-                                ).apply {
</a><a href="#h80-2-155" id="h80-2-155" class="d">-                                    setMargins(0, 5, 0, 5)
</a><a href="#h80-2-156" id="h80-2-156" class="d">-                                }
</a><a href="#h80-2-157" id="h80-2-157" class="d">-                                addView(view)
</a><a href="#h80-2-158" id="h80-2-158" class="d">-                            }
</a><a href="#h80-2-159" id="h80-2-159" class="d">-                        })
</a><a href="#h80-2-160" id="h80-2-160" class="d">-                    }, 0)
</a><a href="#h80-2-161" id="h80-2-161" class="i">+                if (viewGroup.javaClass.name.endsWith(&quot;ActionMenuChatItemContainer&quot;) &amp;&amp; !hasV2ActionMenu()) {
</a><a href="#h80-2-162" id="h80-2-162" class="i">+                    if (viewGroup.parent == null || viewGroup.parent.parent == null) return@subscribe
</a><a href="#h80-2-163" id="h80-2-163" class="i">+                    menuMap[ChatActionMenu::class]!!.inject(viewGroup, childView, originalAddView)
</a><a href="#h80-2-164" id="h80-2-164" class="i">+                    return@subscribe
</a>                 }
 
<a href="#h80-2-167" id="h80-2-167" class="d">-                event.view = injectedLayout
</a><a href="#h80-2-168" id="h80-2-168" class="i">+                if (viewGroup !is LinearLayout &amp;&amp; childView.id == actionMenu &amp;&amp; messaging.lastFocusedConversationType == 1) {
</a><a href="#h80-2-169" id="h80-2-169" class="i">+                    val injectedLayout = LinearLayout(childView.context).apply {
</a><a href="#h80-2-170" id="h80-2-170" class="i">+                        orientation = LinearLayout.VERTICAL
</a><a href="#h80-2-171" id="h80-2-171" class="i">+                        gravity = Gravity.BOTTOM
</a><a href="#h80-2-172" id="h80-2-172" class="i">+                        layoutParams = ViewGroup.LayoutParams(ViewGroup.LayoutParams.MATCH_PARENT, ViewGroup.LayoutParams.MATCH_PARENT)
</a><a href="#h80-2-173" id="h80-2-173" class="i">+                        addView(childView)
</a><a href="#h80-2-174" id="h80-2-174" class="i">+                    }
</a><a href="#h80-2-175" id="h80-2-175" class="i">+
</a><a href="#h80-2-176" id="h80-2-176" class="i">+                    event.parent.post {
</a><a href="#h80-2-177" id="h80-2-177" class="i">+                        injectedLayout.addView(ScrollView(injectedLayout.context).apply {
</a><a href="#h80-2-178" id="h80-2-178" class="i">+                            layoutParams = LinearLayout.LayoutParams(
</a><a href="#h80-2-179" id="h80-2-179" class="i">+                                ViewGroup.LayoutParams.MATCH_PARENT,
</a><a href="#h80-2-180" id="h80-2-180" class="i">+                                ViewGroup.LayoutParams.WRAP_CONTENT
</a><a href="#h80-2-181" id="h80-2-181" class="i">+                            ).apply {
</a><a href="#h80-2-182" id="h80-2-182" class="i">+                                weight = 1f;
</a><a href="#h80-2-183" id="h80-2-183" class="i">+                                setMargins(0, 100, 0, 0)
</a><a href="#h80-2-184" id="h80-2-184" class="i">+                            }
</a><a href="#h80-2-185" id="h80-2-185" class="i">+
</a><a href="#h80-2-186" id="h80-2-186" class="i">+                            addView(LinearLayout(context).apply {
</a><a href="#h80-2-187" id="h80-2-187" class="i">+                                orientation = LinearLayout.VERTICAL
</a><a href="#h80-2-188" id="h80-2-188" class="i">+                                menuMap[FriendFeedInfoMenu::class]?.inject(event.parent, injectedLayout) { view -&gt;
</a><a href="#h80-2-189" id="h80-2-189" class="i">+                                    view.layoutParams = LinearLayout.LayoutParams(
</a><a href="#h80-2-190" id="h80-2-190" class="i">+                                        ViewGroup.LayoutParams.MATCH_PARENT,
</a><a href="#h80-2-191" id="h80-2-191" class="i">+                                        ViewGroup.LayoutParams.WRAP_CONTENT
</a><a href="#h80-2-192" id="h80-2-192" class="i">+                                    ).apply {
</a><a href="#h80-2-193" id="h80-2-193" class="i">+                                        setMargins(0, 5, 0, 5)
</a><a href="#h80-2-194" id="h80-2-194" class="i">+                                    }
</a><a href="#h80-2-195" id="h80-2-195" class="i">+                                    addView(view)
</a><a href="#h80-2-196" id="h80-2-196" class="i">+                                }
</a><a href="#h80-2-197" id="h80-2-197" class="i">+                            })
</a><a href="#h80-2-198" id="h80-2-198" class="i">+                        }, 0)
</a><a href="#h80-2-199" id="h80-2-199" class="i">+                    }
</a><a href="#h80-2-200" id="h80-2-200" class="i">+
</a><a href="#h80-2-201" id="h80-2-201" class="i">+                    event.view = injectedLayout
</a><a href="#h80-2-202" id="h80-2-202" class="i">+                }
</a>             }
         }
     }
<b>diff --git a/<a id="h81" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/FriendFeedInfoMenu.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/FriendFeedInfoMenu.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/FriendFeedInfoMenu.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/FriendFeedInfoMenu.kt</a></b>
<a href="#h81-0" id="h81-0" class="h">@@ -33,6 +33,7 @@ import androidx.compose.ui.text.font.FontWeight
</a> import androidx.compose.ui.text.style.TextAlign
 import androidx.compose.ui.unit.dp
 import androidx.compose.ui.unit.sp
<a href="#h81-0-3" id="h81-0-3" class="i">+import androidx.core.content.res.use
</a> import kotlinx.coroutines.Dispatchers
 import kotlinx.coroutines.launch
 import kotlinx.coroutines.withContext
<a href="#h81-1" id="h81-1" class="h">@@ -74,12 +75,12 @@ class FriendFeedInfoMenu : AbstractMenu() {
</a>     private val sigColorTextPrimary by lazy {
         context.androidContext.theme.obtainStyledAttributes(
             intArrayOf(context.resources.getIdentifier(&quot;sigColorTextPrimary&quot;, &quot;attr&quot;))
<a href="#h81-1-3" id="h81-1-3" class="d">-        ).getColor(0, 0)
</a><a href="#h81-1-4" id="h81-1-4" class="i">+        ).use { it.getColor(0, 0) }
</a>     }
     private val sigColorBackgroundSurface by lazy {
         context.androidContext.theme.obtainStyledAttributes(
             intArrayOf(context.resources.getIdentifier(&quot;sigColorBackgroundSurface&quot;, &quot;attr&quot;))
<a href="#h81-1-9" id="h81-1-9" class="d">-        ).getColor(0, 0)
</a><a href="#h81-1-10" id="h81-1-10" class="i">+        ).use { it.getColor(0, 0) }
</a>     }
 
     private fun getImageDrawable(url: String): Drawable {
<b>diff --git a/<a id="h82" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/OperaContextActionMenu.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/OperaContextActionMenu.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/OperaContextActionMenu.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/OperaContextActionMenu.kt</a></b>
<a href="#h82-0" id="h82-0" class="h">@@ -21,6 +21,7 @@ import androidx.compose.ui.Modifier
</a> import androidx.compose.ui.graphics.Color
 import androidx.compose.ui.text.style.TextAlign
 import androidx.compose.ui.unit.dp
<a href="#h82-0-3" id="h82-0-3" class="i">+import androidx.core.content.res.use
</a> import me.rhunk.snapenhance.common.ui.createComposeView
 import me.rhunk.snapenhance.core.features.impl.OperaViewerParamsOverride
 import me.rhunk.snapenhance.core.features.impl.downloader.MediaDownloader
<a href="#h82-1" id="h82-1" class="h">@@ -170,7 +171,7 @@ class OperaContextActionMenu : AbstractMenu() {
</a>                             color = remember {
                                 view.context.theme.obtainStyledAttributes(
                                     intArrayOf(view.context.resources.getIdentifier(&quot;sigColorTextPrimary&quot;, &quot;attr&quot;))
<a href="#h82-1-3" id="h82-1-3" class="d">-                                ).getColor(0, 0).let { Color(it) }
</a><a href="#h82-1-4" id="h82-1-4" class="i">+                                ).use { Color(it.getColor(0, 0)) }
</a>                             },
                             textAlign = TextAlign.Center,
                             modifier = Modifier.fillMaxWidth()
<b>diff --git a/<a id="h83" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/SettingsGearInjector.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/SettingsGearInjector.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/SettingsGearInjector.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/SettingsGearInjector.kt</a></b>
<a href="#h83-0" id="h83-0" class="h">@@ -5,6 +5,7 @@ import android.view.View
</a> import android.view.ViewGroup
 import android.widget.FrameLayout
 import android.widget.ImageView
<a href="#h83-0-3" id="h83-0-3" class="i">+import androidx.core.content.res.use
</a> import me.rhunk.snapenhance.common.ui.OverlayType
 import me.rhunk.snapenhance.core.ui.menu.AbstractMenu
 import me.rhunk.snapenhance.core.util.ktx.getDimens
<a href="#h83-1" id="h83-1" class="h">@@ -65,8 +66,8 @@ class SettingsGearInjector : AbstractMenu() {
</a>                     gravity = android.view.Gravity.CENTER
                 }
                 setImageDrawable(context.resources.getDrawable(&quot;svg_settings_32x32&quot;, context.theme))
<a href="#h83-1-3" id="h83-1-3" class="d">-                context.resources.getStyledAttributes(&quot;headerButtonOpaqueIconTint&quot;, context.theme).getColorStateList(0)?.let {
</a><a href="#h83-1-4" id="h83-1-4" class="d">-                    imageTintList = it
</a><a href="#h83-1-5" id="h83-1-5" class="i">+                context.resources.getStyledAttributes(&quot;headerButtonOpaqueIconTint&quot;, context.theme).use {
</a><a href="#h83-1-6" id="h83-1-6" class="i">+                    imageTintList = it.getColorStateList(0)
</a>                 }
             })
         })
</pre>
</div>
</body>
</html>
