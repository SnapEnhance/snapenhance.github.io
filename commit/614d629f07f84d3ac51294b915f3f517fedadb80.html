<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>feat(experimental): story logger - SnapEnhance - An Xposed module offering an enhanced Snapchat experience
</title>
<link rel="icon" type="image/svg+xml" href="../../logo.png"/>
<link rel="alternate icon" href="../../favicon.png"/>
<link rel="alternate" type="application/atom+xml" title="SnapEnhance Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="SnapEnhance Atom Feed (tags)" href="../tags.xml" />
<link rel="stylesheet" type="text/css" href="../../style.css" />
<link rel="stylesheet" type="text/css" href="../../fonts.css" />
</head>
<body>
<div id="head"><table><tr><td><a class="logo" href="../../"><img src="../../logo.png" alt="" width="32" height="32" /></a></td><td><strong>SnapEnhance</strong><span class="desc"> - An Xposed module offering an enhanced Snapchat experience
</span>
</td></tr></table>
<p><a href="../about.html">About</a> | <a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/LICENSE.html">License</a></p>
</div>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/614d629f07f84d3ac51294b915f3f517fedadb80.html">614d629f07f84d3ac51294b915f3f517fedadb80</a>
<b>parent</b> <a href="../commit/195dd278d826fb2a9383025b62c043d1a2e2d080.html">195dd278d826fb2a9383025b62c043d1a2e2d080</a>
<b>Author:</b> rhunk &lt;<a href="mailto:101876869+rhunk@users.noreply.github.com">101876869+rhunk@users.noreply.github.com</a>&gt;
<b>Date:</b>   Sun, 17 Dec 2023 02:50:01 +0100

feat(experimental): story logger

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">app/src/main/AndroidManifest.xml</a></td><td> | </td><td class="num">10</td><td><span class="i">++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadProcessor.kt</a></td><td> | </td><td class="num">15</td><td><span class="i">++++++++</span><span class="d">-------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h2">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/home/SettingsSection.kt</a></td><td> | </td><td class="num">13</td><td><span class="i">+++++++++++</span><span class="d">--</span></td></tr>
<tr><td class="A">A</td><td><a href="#h3">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/social/LoggedStories.kt</a></td><td> | </td><td class="num">268</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h4">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/social/ScopeContent.kt</a></td><td> | </td><td class="num">20</td><td><span class="i">+++++++++++++++++++</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h5">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/social/SocialSection.kt</a></td><td> | </td><td class="num">6</td><td><span class="i">++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h6">app/src/main/res/xml/provider_paths.xml</a></td><td> | </td><td class="num">4</td><td><span class="i">++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h7">common/src/main/aidl/me/rhunk/snapenhance/bridge/MessageLoggerInterface.aidl</a></td><td> | </td><td class="num">5</td><td><span class="i">+++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h8">common/src/main/assets/lang/en_US.json</a></td><td> | </td><td class="num">4</td><td><span class="i">++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h9">common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/wrapper/MessageLoggerWrapper.kt</a></td><td> | </td><td class="num">61</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h10">common/src/main/kotlin/me/rhunk/snapenhance/common/config/impl/Experimental.kt</a></td><td> | </td><td class="num">1</td><td><span class="i">+</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h11">common/src/main/kotlin/me/rhunk/snapenhance/common/data/MessagingCoreObjects.kt</a></td><td> | </td><td class="num">10</td><td><span class="i">++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h12">common/src/main/kotlin/me/rhunk/snapenhance/common/data/download/DownloadRequest.kt</a></td><td> | </td><td class="num">55</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h13">common/src/main/kotlin/me/rhunk/snapenhance/common/data/download/MediaDownloadSource.kt</a></td><td> | </td><td class="num">3</td><td><span class="i">++</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h14">common/src/main/kotlin/me/rhunk/snapenhance/common/util/snap/MediaDownloaderHelper.kt</a></td><td> | </td><td class="num">20</td><td><span class="i">++++++++++</span><span class="d">----------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h15">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/Stories.kt</a></td><td> | </td><td class="num">45</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h16">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/downloader/MediaDownloader.kt</a></td><td> | </td><td class="num">67</td><td><span class="i">++++++++</span><span class="d">-----------------------------------------------------------</span></td></tr>
</table></pre><pre>17 files changed, 525 insertions(+), 82 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/app/src/main/AndroidManifest.xml.html">app/src/main/AndroidManifest.xml</a> b/<a href="../file/app/src/main/AndroidManifest.xml.html">app/src/main/AndroidManifest.xml</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -58,6 +58,16 @@
</a>             android:exported=&quot;true&quot; /&gt;
 
         &lt;receiver android:name=&quot;.messaging.StreaksReminder&quot; /&gt;
<a href="#h0-0-3" id="h0-0-3" class="i">+
</a><a href="#h0-0-4" id="h0-0-4" class="i">+        &lt;provider
</a><a href="#h0-0-5" id="h0-0-5" class="i">+            android:name=&quot;androidx.core.content.FileProvider&quot;
</a><a href="#h0-0-6" id="h0-0-6" class="i">+            android:authorities=&quot;me.rhunk.snapenhance.fileprovider&quot;
</a><a href="#h0-0-7" id="h0-0-7" class="i">+            android:exported=&quot;false&quot;
</a><a href="#h0-0-8" id="h0-0-8" class="i">+            android:grantUriPermissions=&quot;true&quot;&gt;
</a><a href="#h0-0-9" id="h0-0-9" class="i">+            &lt;meta-data
</a><a href="#h0-0-10" id="h0-0-10" class="i">+                android:name=&quot;android.support.FILE_PROVIDER_PATHS&quot;
</a><a href="#h0-0-11" id="h0-0-11" class="i">+                android:resource=&quot;@xml/provider_paths&quot; /&gt;
</a><a href="#h0-0-12" id="h0-0-12" class="i">+        &lt;/provider&gt;
</a>     &lt;/application&gt;
 
 &lt;/manifest&gt; 
\ No newline at end of file
<b>diff --git a/<a id="h1" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadProcessor.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadProcessor.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadProcessor.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadProcessor.kt</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -23,7 +23,6 @@ import me.rhunk.snapenhance.common.data.download.DownloadMetadata
</a> import me.rhunk.snapenhance.common.data.download.DownloadRequest
 import me.rhunk.snapenhance.common.data.download.InputMedia
 import me.rhunk.snapenhance.common.data.download.SplitMediaAssetType
<a href="#h1-0-3" id="h1-0-3" class="d">-import me.rhunk.snapenhance.common.util.ktx.longHashCode
</a> import me.rhunk.snapenhance.common.util.snap.MediaDownloaderHelper
 import me.rhunk.snapenhance.common.util.snap.RemoteMediaResolver
 import me.rhunk.snapenhance.task.PendingTask
<a href="#h1-1" id="h1-1" class="h">@@ -35,7 +34,6 @@ import java.io.File
</a> import java.io.InputStream
 import java.net.HttpURLConnection
 import java.net.URL
<a href="#h1-1-3" id="h1-1-3" class="d">-import java.util.UUID
</a> import java.util.concurrent.ConcurrentHashMap
 import javax.xml.parsers.DocumentBuilderFactory
 import javax.xml.transform.TransformerFactory
<a href="#h1-2" id="h1-2" class="h">@@ -44,7 +42,6 @@ import javax.xml.transform.stream.StreamResult
</a> import kotlin.coroutines.coroutineContext
 import kotlin.io.encoding.Base64
 import kotlin.io.encoding.ExperimentalEncodingApi
<a href="#h1-2-3" id="h1-2-3" class="d">-import kotlin.math.absoluteValue
</a> 
 data class DownloadedFile(
     val file: File,
<a href="#h1-3" id="h1-3" class="h">@@ -331,11 +328,8 @@ class DownloadProcessor (
</a>         return newFile
     }
 
<a href="#h1-3-3" id="h1-3-3" class="d">-    fun onReceive(intent: Intent) {
</a><a href="#h1-3-4" id="h1-3-4" class="i">+    fun enqueue(downloadRequest: DownloadRequest, downloadMetadata: DownloadMetadata) {
</a>         remoteSideContext.coroutineScope.launch {
<a href="#h1-3-6" id="h1-3-6" class="d">-            val downloadMetadata = gson.fromJson(intent.getStringExtra(ReceiversConfig.DOWNLOAD_METADATA_EXTRA)!!, DownloadMetadata::class.java)
</a><a href="#h1-3-7" id="h1-3-7" class="d">-            val downloadRequest = gson.fromJson(intent.getStringExtra(ReceiversConfig.DOWNLOAD_REQUEST_EXTRA)!!, DownloadRequest::class.java)
</a><a href="#h1-3-8" id="h1-3-8" class="d">-
</a>             remoteSideContext.taskManager.getTaskByHash(downloadMetadata.mediaIdentifier)?.let { task -&gt;
                 remoteSideContext.log.debug(&quot;already queued or downloaded&quot;)
 
<a href="#h1-4" id="h1-4" class="h">@@ -451,4 +445,11 @@ class DownloadProcessor (
</a>             }
         }
     }
<a href="#h1-4-3" id="h1-4-3" class="i">+
</a><a href="#h1-4-4" id="h1-4-4" class="i">+    fun onReceive(intent: Intent) {
</a><a href="#h1-4-5" id="h1-4-5" class="i">+        val downloadMetadata = gson.fromJson(intent.getStringExtra(ReceiversConfig.DOWNLOAD_METADATA_EXTRA)!!, DownloadMetadata::class.java)
</a><a href="#h1-4-6" id="h1-4-6" class="i">+        val downloadRequest = gson.fromJson(intent.getStringExtra(ReceiversConfig.DOWNLOAD_REQUEST_EXTRA)!!, DownloadRequest::class.java)
</a><a href="#h1-4-7" id="h1-4-7" class="i">+
</a><a href="#h1-4-8" id="h1-4-8" class="i">+        enqueue(downloadRequest, downloadMetadata)
</a><a href="#h1-4-9" id="h1-4-9" class="i">+    }
</a> } 
\ No newline at end of file
<b>diff --git a/<a id="h2" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/home/SettingsSection.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/home/SettingsSection.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/home/SettingsSection.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/home/SettingsSection.kt</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -122,9 +122,11 @@ class SettingsSection(
</a>                     verticalArrangement = Arrangement.spacedBy(4.dp),
                 ) {
                     var storedMessagesCount by remember { mutableIntStateOf(0) }
<a href="#h2-0-3" id="h2-0-3" class="i">+                    var storedStoriesCount by remember { mutableIntStateOf(0) }
</a>                     LaunchedEffect(Unit) {
                         withContext(Dispatchers.IO) {
                             storedMessagesCount = context.messageLogger.getStoredMessageCount()
<a href="#h2-0-7" id="h2-0-7" class="i">+                            storedStoriesCount = context.messageLogger.getStoredStoriesCount()
</a>                         }
                     }
                     Row(
<a href="#h2-1" id="h2-1" class="h">@@ -134,7 +136,13 @@ class SettingsSection(
</a>                             .fillMaxWidth()
                             .padding(5.dp)
                     ) {
<a href="#h2-1-3" id="h2-1-3" class="d">-                        Text(text = &quot;$storedMessagesCount messages&quot;, modifier = Modifier.weight(1f))
</a><a href="#h2-1-4" id="h2-1-4" class="i">+                        Column(
</a><a href="#h2-1-5" id="h2-1-5" class="i">+                            modifier = Modifier.weight(1f),
</a><a href="#h2-1-6" id="h2-1-6" class="i">+                            verticalArrangement = Arrangement.spacedBy(2.dp),
</a><a href="#h2-1-7" id="h2-1-7" class="i">+                        ) {
</a><a href="#h2-1-8" id="h2-1-8" class="i">+                            Text(text = &quot;$storedMessagesCount messages&quot;)
</a><a href="#h2-1-9" id="h2-1-9" class="i">+                            Text(text = &quot;$storedStoriesCount stories&quot;)
</a><a href="#h2-1-10" id="h2-1-10" class="i">+                        }
</a>                         Button(onClick = {
                             runCatching {
                                 activityLauncherHelper.saveFile(&quot;message_logger.db&quot;, &quot;application/octet-stream&quot;) { uri -&gt;
<a href="#h2-2" id="h2-2" class="h">@@ -153,8 +161,9 @@ class SettingsSection(
</a>                         }
                         Button(onClick = {
                             runCatching {
<a href="#h2-2-3" id="h2-2-3" class="d">-                                context.messageLogger.clearMessages()
</a><a href="#h2-2-4" id="h2-2-4" class="i">+                                context.messageLogger.clearAll()
</a>                                 storedMessagesCount = 0
<a href="#h2-2-6" id="h2-2-6" class="i">+                                storedStoriesCount = 0
</a>                             }.onFailure {
                                 context.log.error(&quot;Failed to clear messages&quot;, it)
                                 context.longToast(&quot;Failed to clear messages! ${it.localizedMessage}&quot;)
<b>diff --git a/<a id="h3" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/social/LoggedStories.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/social/LoggedStories.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/social/LoggedStories.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/social/LoggedStories.kt</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -0,0 +1,267 @@
</a><a href="#h3-0-0" id="h3-0-0" class="i">+package me.rhunk.snapenhance.ui.manager.sections.social
</a><a href="#h3-0-1" id="h3-0-1" class="i">+
</a><a href="#h3-0-2" id="h3-0-2" class="i">+import android.content.Intent
</a><a href="#h3-0-3" id="h3-0-3" class="i">+import android.graphics.Bitmap
</a><a href="#h3-0-4" id="h3-0-4" class="i">+import android.graphics.BitmapFactory
</a><a href="#h3-0-5" id="h3-0-5" class="i">+import androidx.compose.foundation.Image
</a><a href="#h3-0-6" id="h3-0-6" class="i">+import androidx.compose.foundation.clickable
</a><a href="#h3-0-7" id="h3-0-7" class="i">+import androidx.compose.foundation.layout.*
</a><a href="#h3-0-8" id="h3-0-8" class="i">+import androidx.compose.foundation.lazy.grid.GridCells
</a><a href="#h3-0-9" id="h3-0-9" class="i">+import androidx.compose.foundation.lazy.grid.LazyVerticalGrid
</a><a href="#h3-0-10" id="h3-0-10" class="i">+import androidx.compose.foundation.lazy.grid.items
</a><a href="#h3-0-11" id="h3-0-11" class="i">+import androidx.compose.material3.Button
</a><a href="#h3-0-12" id="h3-0-12" class="i">+import androidx.compose.material3.Card
</a><a href="#h3-0-13" id="h3-0-13" class="i">+import androidx.compose.material3.CircularProgressIndicator
</a><a href="#h3-0-14" id="h3-0-14" class="i">+import androidx.compose.material3.Text
</a><a href="#h3-0-15" id="h3-0-15" class="i">+import androidx.compose.runtime.*
</a><a href="#h3-0-16" id="h3-0-16" class="i">+import androidx.compose.ui.Alignment
</a><a href="#h3-0-17" id="h3-0-17" class="i">+import androidx.compose.ui.Modifier
</a><a href="#h3-0-18" id="h3-0-18" class="i">+import androidx.compose.ui.graphics.ImageBitmap
</a><a href="#h3-0-19" id="h3-0-19" class="i">+import androidx.compose.ui.graphics.asImageBitmap
</a><a href="#h3-0-20" id="h3-0-20" class="i">+import androidx.compose.ui.unit.dp
</a><a href="#h3-0-21" id="h3-0-21" class="i">+import androidx.core.content.FileProvider
</a><a href="#h3-0-22" id="h3-0-22" class="i">+import coil.annotation.ExperimentalCoilApi
</a><a href="#h3-0-23" id="h3-0-23" class="i">+import coil.disk.DiskCache
</a><a href="#h3-0-24" id="h3-0-24" class="i">+import kotlinx.coroutines.Dispatchers
</a><a href="#h3-0-25" id="h3-0-25" class="i">+import kotlinx.coroutines.withContext
</a><a href="#h3-0-26" id="h3-0-26" class="i">+import kotlinx.coroutines.withTimeout
</a><a href="#h3-0-27" id="h3-0-27" class="i">+import me.rhunk.snapenhance.RemoteSideContext
</a><a href="#h3-0-28" id="h3-0-28" class="i">+import me.rhunk.snapenhance.bridge.DownloadCallback
</a><a href="#h3-0-29" id="h3-0-29" class="i">+import me.rhunk.snapenhance.common.data.FileType
</a><a href="#h3-0-30" id="h3-0-30" class="i">+import me.rhunk.snapenhance.common.data.StoryData
</a><a href="#h3-0-31" id="h3-0-31" class="i">+import me.rhunk.snapenhance.common.data.download.*
</a><a href="#h3-0-32" id="h3-0-32" class="i">+import me.rhunk.snapenhance.common.util.ktx.longHashCode
</a><a href="#h3-0-33" id="h3-0-33" class="i">+import me.rhunk.snapenhance.common.util.snap.MediaDownloaderHelper
</a><a href="#h3-0-34" id="h3-0-34" class="i">+import me.rhunk.snapenhance.core.util.media.PreviewUtils
</a><a href="#h3-0-35" id="h3-0-35" class="i">+import me.rhunk.snapenhance.download.DownloadProcessor
</a><a href="#h3-0-36" id="h3-0-36" class="i">+import me.rhunk.snapenhance.ui.util.Dialog
</a><a href="#h3-0-37" id="h3-0-37" class="i">+import okhttp3.HttpUrl.Companion.toHttpUrl
</a><a href="#h3-0-38" id="h3-0-38" class="i">+import okhttp3.OkHttpClient
</a><a href="#h3-0-39" id="h3-0-39" class="i">+import okhttp3.Request
</a><a href="#h3-0-40" id="h3-0-40" class="i">+import java.io.File
</a><a href="#h3-0-41" id="h3-0-41" class="i">+import java.text.DateFormat
</a><a href="#h3-0-42" id="h3-0-42" class="i">+import java.util.Date
</a><a href="#h3-0-43" id="h3-0-43" class="i">+import java.util.UUID
</a><a href="#h3-0-44" id="h3-0-44" class="i">+import javax.crypto.Cipher
</a><a href="#h3-0-45" id="h3-0-45" class="i">+import javax.crypto.CipherInputStream
</a><a href="#h3-0-46" id="h3-0-46" class="i">+import javax.crypto.spec.IvParameterSpec
</a><a href="#h3-0-47" id="h3-0-47" class="i">+import javax.crypto.spec.SecretKeySpec
</a><a href="#h3-0-48" id="h3-0-48" class="i">+import kotlin.math.absoluteValue
</a><a href="#h3-0-49" id="h3-0-49" class="i">+
</a><a href="#h3-0-50" id="h3-0-50" class="i">+@OptIn(ExperimentalCoilApi::class)
</a><a href="#h3-0-51" id="h3-0-51" class="i">+@Composable
</a><a href="#h3-0-52" id="h3-0-52" class="i">+fun LoggedStories(
</a><a href="#h3-0-53" id="h3-0-53" class="i">+    context: RemoteSideContext,
</a><a href="#h3-0-54" id="h3-0-54" class="i">+    userId: String
</a><a href="#h3-0-55" id="h3-0-55" class="i">+) {
</a><a href="#h3-0-56" id="h3-0-56" class="i">+    val stories = remember {
</a><a href="#h3-0-57" id="h3-0-57" class="i">+        mutableStateListOf&lt;StoryData&gt;()
</a><a href="#h3-0-58" id="h3-0-58" class="i">+    }
</a><a href="#h3-0-59" id="h3-0-59" class="i">+    val friendInfo = remember {
</a><a href="#h3-0-60" id="h3-0-60" class="i">+        context.modDatabase.getFriendInfo(userId)
</a><a href="#h3-0-61" id="h3-0-61" class="i">+    }
</a><a href="#h3-0-62" id="h3-0-62" class="i">+    val httpClient = remember { OkHttpClient() }
</a><a href="#h3-0-63" id="h3-0-63" class="i">+    var lastStoryTimestamp by remember { mutableLongStateOf(Long.MAX_VALUE) }
</a><a href="#h3-0-64" id="h3-0-64" class="i">+
</a><a href="#h3-0-65" id="h3-0-65" class="i">+    var selectedStory by remember { mutableStateOf&lt;StoryData?&gt;(null) }
</a><a href="#h3-0-66" id="h3-0-66" class="i">+    var coilCacheFile by remember { mutableStateOf&lt;File?&gt;(null) }
</a><a href="#h3-0-67" id="h3-0-67" class="i">+
</a><a href="#h3-0-68" id="h3-0-68" class="i">+    selectedStory?.let { story -&gt;
</a><a href="#h3-0-69" id="h3-0-69" class="i">+        Dialog(onDismissRequest = {
</a><a href="#h3-0-70" id="h3-0-70" class="i">+            selectedStory = null
</a><a href="#h3-0-71" id="h3-0-71" class="i">+        }) {
</a><a href="#h3-0-72" id="h3-0-72" class="i">+            Card(
</a><a href="#h3-0-73" id="h3-0-73" class="i">+                modifier = Modifier
</a><a href="#h3-0-74" id="h3-0-74" class="i">+                    .padding(4.dp)
</a><a href="#h3-0-75" id="h3-0-75" class="i">+            ) {
</a><a href="#h3-0-76" id="h3-0-76" class="i">+                Column(
</a><a href="#h3-0-77" id="h3-0-77" class="i">+                    modifier = Modifier
</a><a href="#h3-0-78" id="h3-0-78" class="i">+                        .padding(16.dp)
</a><a href="#h3-0-79" id="h3-0-79" class="i">+                        .fillMaxWidth(),
</a><a href="#h3-0-80" id="h3-0-80" class="i">+                    verticalArrangement = Arrangement.spacedBy(8.dp),
</a><a href="#h3-0-81" id="h3-0-81" class="i">+                ) {
</a><a href="#h3-0-82" id="h3-0-82" class="i">+                    Text(text = &quot;Posted on ${story.postedAt.let {
</a><a href="#h3-0-83" id="h3-0-83" class="i">+                        DateFormat.getDateTimeInstance().format(Date(it))
</a><a href="#h3-0-84" id="h3-0-84" class="i">+                    }}&quot;)
</a><a href="#h3-0-85" id="h3-0-85" class="i">+                    Text(text = &quot;Created at ${story.createdAt.let {
</a><a href="#h3-0-86" id="h3-0-86" class="i">+                        DateFormat.getDateTimeInstance().format(Date(it))
</a><a href="#h3-0-87" id="h3-0-87" class="i">+                    }}&quot;)
</a><a href="#h3-0-88" id="h3-0-88" class="i">+
</a><a href="#h3-0-89" id="h3-0-89" class="i">+                    Row(
</a><a href="#h3-0-90" id="h3-0-90" class="i">+                        modifier = Modifier.fillMaxWidth(),
</a><a href="#h3-0-91" id="h3-0-91" class="i">+                        horizontalArrangement = Arrangement.SpaceEvenly,
</a><a href="#h3-0-92" id="h3-0-92" class="i">+                    ) {
</a><a href="#h3-0-93" id="h3-0-93" class="i">+                        Button(onClick = {
</a><a href="#h3-0-94" id="h3-0-94" class="i">+                            context.androidContext.externalCacheDir?.let { cacheDir -&gt;
</a><a href="#h3-0-95" id="h3-0-95" class="i">+                                val cacheFile = coilCacheFile ?: run {
</a><a href="#h3-0-96" id="h3-0-96" class="i">+                                    context.shortToast(&quot;Failed to get file&quot;)
</a><a href="#h3-0-97" id="h3-0-97" class="i">+                                    return@Button
</a><a href="#h3-0-98" id="h3-0-98" class="i">+                                }
</a><a href="#h3-0-99" id="h3-0-99" class="i">+                                val targetFile = File(cacheDir, cacheFile.name)
</a><a href="#h3-0-100" id="h3-0-100" class="i">+                                cacheFile.copyTo(targetFile, overwrite = true)
</a><a href="#h3-0-101" id="h3-0-101" class="i">+                                context.androidContext.startActivity(Intent().apply {
</a><a href="#h3-0-102" id="h3-0-102" class="i">+                                    action = Intent.ACTION_VIEW
</a><a href="#h3-0-103" id="h3-0-103" class="i">+                                    setDataAndType(
</a><a href="#h3-0-104" id="h3-0-104" class="i">+                                        FileProvider.getUriForFile(
</a><a href="#h3-0-105" id="h3-0-105" class="i">+                                            context.androidContext,
</a><a href="#h3-0-106" id="h3-0-106" class="i">+                                            &quot;me.rhunk.snapenhance.fileprovider&quot;,
</a><a href="#h3-0-107" id="h3-0-107" class="i">+                                            targetFile
</a><a href="#h3-0-108" id="h3-0-108" class="i">+                                        ),
</a><a href="#h3-0-109" id="h3-0-109" class="i">+                                        FileType.fromFile(targetFile).mimeType
</a><a href="#h3-0-110" id="h3-0-110" class="i">+                                    )
</a><a href="#h3-0-111" id="h3-0-111" class="i">+                                    addFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION or Intent.FLAG_ACTIVITY_NEW_TASK)
</a><a href="#h3-0-112" id="h3-0-112" class="i">+                                })
</a><a href="#h3-0-113" id="h3-0-113" class="i">+                            }
</a><a href="#h3-0-114" id="h3-0-114" class="i">+                        }) {
</a><a href="#h3-0-115" id="h3-0-115" class="i">+                            Text(text = &quot;Open&quot;)
</a><a href="#h3-0-116" id="h3-0-116" class="i">+                        }
</a><a href="#h3-0-117" id="h3-0-117" class="i">+
</a><a href="#h3-0-118" id="h3-0-118" class="i">+                        Button(onClick = {
</a><a href="#h3-0-119" id="h3-0-119" class="i">+                            val mediaAuthor = friendInfo?.mutableUsername ?: userId
</a><a href="#h3-0-120" id="h3-0-120" class="i">+                            val uniqueHash = selectedStory?.url?.longHashCode()?.absoluteValue?.toString(16) ?: UUID.randomUUID().toString()
</a><a href="#h3-0-121" id="h3-0-121" class="i">+
</a><a href="#h3-0-122" id="h3-0-122" class="i">+                            DownloadProcessor(
</a><a href="#h3-0-123" id="h3-0-123" class="i">+                                remoteSideContext = context,
</a><a href="#h3-0-124" id="h3-0-124" class="i">+                                callback = object: DownloadCallback.Default() {
</a><a href="#h3-0-125" id="h3-0-125" class="i">+                                    override fun onSuccess(outputPath: String?) {
</a><a href="#h3-0-126" id="h3-0-126" class="i">+                                        context.shortToast(&quot;Downloaded to $outputPath&quot;)
</a><a href="#h3-0-127" id="h3-0-127" class="i">+                                    }
</a><a href="#h3-0-128" id="h3-0-128" class="i">+
</a><a href="#h3-0-129" id="h3-0-129" class="i">+                                    override fun onFailure(message: String?, throwable: String?) {
</a><a href="#h3-0-130" id="h3-0-130" class="i">+                                        context.shortToast(&quot;Failed to download $message&quot;)
</a><a href="#h3-0-131" id="h3-0-131" class="i">+                                    }
</a><a href="#h3-0-132" id="h3-0-132" class="i">+                                }
</a><a href="#h3-0-133" id="h3-0-133" class="i">+                            ).enqueue(DownloadRequest(
</a><a href="#h3-0-134" id="h3-0-134" class="i">+                                inputMedias = arrayOf(
</a><a href="#h3-0-135" id="h3-0-135" class="i">+                                    InputMedia(
</a><a href="#h3-0-136" id="h3-0-136" class="i">+                                        content = story.url,
</a><a href="#h3-0-137" id="h3-0-137" class="i">+                                        type = DownloadMediaType.REMOTE_MEDIA,
</a><a href="#h3-0-138" id="h3-0-138" class="i">+                                        encryption = story.key?.let { it to story.iv!! }?.toKeyPair()
</a><a href="#h3-0-139" id="h3-0-139" class="i">+                                    )
</a><a href="#h3-0-140" id="h3-0-140" class="i">+                                )
</a><a href="#h3-0-141" id="h3-0-141" class="i">+                            ), DownloadMetadata(
</a><a href="#h3-0-142" id="h3-0-142" class="i">+                                mediaIdentifier = uniqueHash,
</a><a href="#h3-0-143" id="h3-0-143" class="i">+                                outputPath = createNewFilePath(
</a><a href="#h3-0-144" id="h3-0-144" class="i">+                                    context.config.root,
</a><a href="#h3-0-145" id="h3-0-145" class="i">+                                    uniqueHash,
</a><a href="#h3-0-146" id="h3-0-146" class="i">+                                    MediaDownloadSource.STORY_LOGGER,
</a><a href="#h3-0-147" id="h3-0-147" class="i">+                                    mediaAuthor,
</a><a href="#h3-0-148" id="h3-0-148" class="i">+                                    story.createdAt
</a><a href="#h3-0-149" id="h3-0-149" class="i">+                                ),
</a><a href="#h3-0-150" id="h3-0-150" class="i">+                                iconUrl = null,
</a><a href="#h3-0-151" id="h3-0-151" class="i">+                                mediaAuthor = friendInfo?.mutableUsername ?: userId,
</a><a href="#h3-0-152" id="h3-0-152" class="i">+                                downloadSource = MediaDownloadSource.STORY_LOGGER.key
</a><a href="#h3-0-153" id="h3-0-153" class="i">+                            ))
</a><a href="#h3-0-154" id="h3-0-154" class="i">+                        }) {
</a><a href="#h3-0-155" id="h3-0-155" class="i">+                            Text(text = &quot;Download&quot;)
</a><a href="#h3-0-156" id="h3-0-156" class="i">+                        }
</a><a href="#h3-0-157" id="h3-0-157" class="i">+                    }
</a><a href="#h3-0-158" id="h3-0-158" class="i">+                }
</a><a href="#h3-0-159" id="h3-0-159" class="i">+            }
</a><a href="#h3-0-160" id="h3-0-160" class="i">+        }
</a><a href="#h3-0-161" id="h3-0-161" class="i">+    }
</a><a href="#h3-0-162" id="h3-0-162" class="i">+
</a><a href="#h3-0-163" id="h3-0-163" class="i">+    LazyVerticalGrid(
</a><a href="#h3-0-164" id="h3-0-164" class="i">+        columns = GridCells.Adaptive(100.dp),
</a><a href="#h3-0-165" id="h3-0-165" class="i">+        contentPadding = PaddingValues(8.dp),
</a><a href="#h3-0-166" id="h3-0-166" class="i">+    ) {
</a><a href="#h3-0-167" id="h3-0-167" class="i">+        items(stories) { story -&gt;
</a><a href="#h3-0-168" id="h3-0-168" class="i">+            var imageBitmap by remember { mutableStateOf&lt;ImageBitmap?&gt;(null) }
</a><a href="#h3-0-169" id="h3-0-169" class="i">+            val uniqueHash = remember { story.url.hashCode().absoluteValue.toString(16) }
</a><a href="#h3-0-170" id="h3-0-170" class="i">+
</a><a href="#h3-0-171" id="h3-0-171" class="i">+            fun openDiskCacheSnapshot(snapshot: DiskCache.Snapshot): Boolean {
</a><a href="#h3-0-172" id="h3-0-172" class="i">+                runCatching {
</a><a href="#h3-0-173" id="h3-0-173" class="i">+                    val mediaList = mutableMapOf&lt;SplitMediaAssetType, ByteArray&gt;()
</a><a href="#h3-0-174" id="h3-0-174" class="i">+
</a><a href="#h3-0-175" id="h3-0-175" class="i">+                    snapshot.data.toFile().inputStream().use { inputStream -&gt;
</a><a href="#h3-0-176" id="h3-0-176" class="i">+                        MediaDownloaderHelper.getSplitElements(inputStream) { type, splitInputStream -&gt;
</a><a href="#h3-0-177" id="h3-0-177" class="i">+                            mediaList[type] = splitInputStream.readBytes()
</a><a href="#h3-0-178" id="h3-0-178" class="i">+                        }
</a><a href="#h3-0-179" id="h3-0-179" class="i">+                    }
</a><a href="#h3-0-180" id="h3-0-180" class="i">+
</a><a href="#h3-0-181" id="h3-0-181" class="i">+                    val originalMedia = mediaList[SplitMediaAssetType.ORIGINAL] ?: return@runCatching false
</a><a href="#h3-0-182" id="h3-0-182" class="i">+                    val overlay = mediaList[SplitMediaAssetType.OVERLAY]
</a><a href="#h3-0-183" id="h3-0-183" class="i">+
</a><a href="#h3-0-184" id="h3-0-184" class="i">+                    var bitmap: Bitmap? = PreviewUtils.createPreview(originalMedia, isVideo = FileType.fromByteArray(originalMedia).isVideo)
</a><a href="#h3-0-185" id="h3-0-185" class="i">+
</a><a href="#h3-0-186" id="h3-0-186" class="i">+                    overlay?.also {
</a><a href="#h3-0-187" id="h3-0-187" class="i">+                        bitmap = PreviewUtils.mergeBitmapOverlay(bitmap!!, BitmapFactory.decodeByteArray(it, 0, it.size))
</a><a href="#h3-0-188" id="h3-0-188" class="i">+                    }
</a><a href="#h3-0-189" id="h3-0-189" class="i">+
</a><a href="#h3-0-190" id="h3-0-190" class="i">+                    imageBitmap = bitmap?.asImageBitmap()
</a><a href="#h3-0-191" id="h3-0-191" class="i">+                    return true
</a><a href="#h3-0-192" id="h3-0-192" class="i">+                }
</a><a href="#h3-0-193" id="h3-0-193" class="i">+                return false
</a><a href="#h3-0-194" id="h3-0-194" class="i">+            }
</a><a href="#h3-0-195" id="h3-0-195" class="i">+
</a><a href="#h3-0-196" id="h3-0-196" class="i">+            LaunchedEffect(Unit) {
</a><a href="#h3-0-197" id="h3-0-197" class="i">+                withContext(Dispatchers.IO) {
</a><a href="#h3-0-198" id="h3-0-198" class="i">+                    withTimeout(10000L) {
</a><a href="#h3-0-199" id="h3-0-199" class="i">+                        context.imageLoader.diskCache?.openSnapshot(uniqueHash)?.let {
</a><a href="#h3-0-200" id="h3-0-200" class="i">+                            openDiskCacheSnapshot(it)
</a><a href="#h3-0-201" id="h3-0-201" class="i">+                            it.close()
</a><a href="#h3-0-202" id="h3-0-202" class="i">+                            return@withTimeout
</a><a href="#h3-0-203" id="h3-0-203" class="i">+                        }
</a><a href="#h3-0-204" id="h3-0-204" class="i">+
</a><a href="#h3-0-205" id="h3-0-205" class="i">+                        val response = httpClient.newCall(Request(
</a><a href="#h3-0-206" id="h3-0-206" class="i">+                            url = story.url.toHttpUrl()
</a><a href="#h3-0-207" id="h3-0-207" class="i">+                        )).execute()
</a><a href="#h3-0-208" id="h3-0-208" class="i">+                        response.body.byteStream().use {
</a><a href="#h3-0-209" id="h3-0-209" class="i">+                            val decrypted = story.key?.let { _ -&gt;
</a><a href="#h3-0-210" id="h3-0-210" class="i">+                                val cipher = Cipher.getInstance(&quot;AES/CBC/PKCS5Padding&quot;)
</a><a href="#h3-0-211" id="h3-0-211" class="i">+                                cipher.init(Cipher.DECRYPT_MODE, SecretKeySpec(story.key, &quot;AES&quot;), IvParameterSpec(story.iv))
</a><a href="#h3-0-212" id="h3-0-212" class="i">+                                CipherInputStream(it, cipher)
</a><a href="#h3-0-213" id="h3-0-213" class="i">+                            } ?: it
</a><a href="#h3-0-214" id="h3-0-214" class="i">+
</a><a href="#h3-0-215" id="h3-0-215" class="i">+                            context.imageLoader.diskCache?.openEditor(uniqueHash)?.apply {
</a><a href="#h3-0-216" id="h3-0-216" class="i">+                                data.toFile().outputStream().use { fos -&gt;
</a><a href="#h3-0-217" id="h3-0-217" class="i">+                                    decrypted.copyTo(fos)
</a><a href="#h3-0-218" id="h3-0-218" class="i">+                                }
</a><a href="#h3-0-219" id="h3-0-219" class="i">+                                commitAndOpenSnapshot()?.use { snapshot -&gt;
</a><a href="#h3-0-220" id="h3-0-220" class="i">+                                    openDiskCacheSnapshot(snapshot)
</a><a href="#h3-0-221" id="h3-0-221" class="i">+                                    snapshot.close()
</a><a href="#h3-0-222" id="h3-0-222" class="i">+                                }
</a><a href="#h3-0-223" id="h3-0-223" class="i">+                            }
</a><a href="#h3-0-224" id="h3-0-224" class="i">+                        }
</a><a href="#h3-0-225" id="h3-0-225" class="i">+                    }
</a><a href="#h3-0-226" id="h3-0-226" class="i">+                }
</a><a href="#h3-0-227" id="h3-0-227" class="i">+            }
</a><a href="#h3-0-228" id="h3-0-228" class="i">+
</a><a href="#h3-0-229" id="h3-0-229" class="i">+            Column(
</a><a href="#h3-0-230" id="h3-0-230" class="i">+                modifier = Modifier
</a><a href="#h3-0-231" id="h3-0-231" class="i">+                    .padding(8.dp)
</a><a href="#h3-0-232" id="h3-0-232" class="i">+                    .clickable {
</a><a href="#h3-0-233" id="h3-0-233" class="i">+                        selectedStory = story
</a><a href="#h3-0-234" id="h3-0-234" class="i">+                        coilCacheFile = context.imageLoader.diskCache?.openSnapshot(uniqueHash).use {
</a><a href="#h3-0-235" id="h3-0-235" class="i">+                            it?.data?.toFile()
</a><a href="#h3-0-236" id="h3-0-236" class="i">+                        }
</a><a href="#h3-0-237" id="h3-0-237" class="i">+                    }
</a><a href="#h3-0-238" id="h3-0-238" class="i">+                    .heightIn(min = 128.dp),
</a><a href="#h3-0-239" id="h3-0-239" class="i">+                horizontalAlignment = Alignment.CenterHorizontally,
</a><a href="#h3-0-240" id="h3-0-240" class="i">+                verticalArrangement = Arrangement.Center,
</a><a href="#h3-0-241" id="h3-0-241" class="i">+            ) {
</a><a href="#h3-0-242" id="h3-0-242" class="i">+                imageBitmap?.let {
</a><a href="#h3-0-243" id="h3-0-243" class="i">+                    Card {
</a><a href="#h3-0-244" id="h3-0-244" class="i">+                        Image(
</a><a href="#h3-0-245" id="h3-0-245" class="i">+                            bitmap = it,
</a><a href="#h3-0-246" id="h3-0-246" class="i">+                            modifier = Modifier.fillMaxSize(),
</a><a href="#h3-0-247" id="h3-0-247" class="i">+                            contentDescription = null,
</a><a href="#h3-0-248" id="h3-0-248" class="i">+                        )
</a><a href="#h3-0-249" id="h3-0-249" class="i">+                    }
</a><a href="#h3-0-250" id="h3-0-250" class="i">+                } ?: run {
</a><a href="#h3-0-251" id="h3-0-251" class="i">+                    CircularProgressIndicator()
</a><a href="#h3-0-252" id="h3-0-252" class="i">+                }
</a><a href="#h3-0-253" id="h3-0-253" class="i">+            }
</a><a href="#h3-0-254" id="h3-0-254" class="i">+        }
</a><a href="#h3-0-255" id="h3-0-255" class="i">+        item {
</a><a href="#h3-0-256" id="h3-0-256" class="i">+            LaunchedEffect(Unit) {
</a><a href="#h3-0-257" id="h3-0-257" class="i">+                context.messageLogger.getStories(userId, lastStoryTimestamp, 20).also { result -&gt;
</a><a href="#h3-0-258" id="h3-0-258" class="i">+                    stories.addAll(result.values)
</a><a href="#h3-0-259" id="h3-0-259" class="i">+                    result.keys.minOrNull()?.let {
</a><a href="#h3-0-260" id="h3-0-260" class="i">+                        lastStoryTimestamp = it
</a><a href="#h3-0-261" id="h3-0-261" class="i">+                    }
</a><a href="#h3-0-262" id="h3-0-262" class="i">+                }
</a><a href="#h3-0-263" id="h3-0-263" class="i">+            }
</a><a href="#h3-0-264" id="h3-0-264" class="i">+        }
</a><a href="#h3-0-265" id="h3-0-265" class="i">+    }
</a><a href="#h3-0-266" id="h3-0-266" class="i">+}</a><a href="#h3-0-267" id="h3-0-267" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h4" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/social/ScopeContent.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/social/ScopeContent.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/social/ScopeContent.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/social/ScopeContent.kt</a></b>
<a href="#h4-0" id="h4-0" class="h">@@ -4,6 +4,7 @@ import android.content.Intent
</a> import androidx.compose.foundation.layout.*
 import androidx.compose.foundation.rememberScrollState
 import androidx.compose.foundation.verticalScroll
<a href="#h4-0-3" id="h4-0-3" class="i">+import androidx.compose.material3.Button
</a> import androidx.compose.material3.Card
 import androidx.compose.material3.OutlinedButton
 import androidx.compose.material3.Switch
<a href="#h4-1" id="h4-1" class="h">@@ -143,7 +144,7 @@ class ScopeContent(
</a>         val hours = minutes / 60
         val days = hours / 24
         if (days &gt; 0) {
<a href="#h4-1-3" id="h4-1-3" class="d">-            stringBuilder.append(&quot;$days days &quot;)
</a><a href="#h4-1-4" id="h4-1-4" class="i">+            stringBuilder.append(&quot;$days day &quot;)
</a>             return stringBuilder.toString()
         }
         if (hours &gt; 0) {
<a href="#h4-2" id="h4-2" class="h">@@ -201,6 +202,22 @@ class ScopeContent(
</a>         }
 
         Spacer(modifier = Modifier.height(16.dp))
<a href="#h4-2-3" id="h4-2-3" class="i">+
</a><a href="#h4-2-4" id="h4-2-4" class="i">+        if (context.config.root.experimental.storyLogger.get()) {
</a><a href="#h4-2-5" id="h4-2-5" class="i">+            Row(
</a><a href="#h4-2-6" id="h4-2-6" class="i">+                modifier = Modifier.fillMaxWidth(),
</a><a href="#h4-2-7" id="h4-2-7" class="i">+                horizontalArrangement = Arrangement.spacedBy(10.dp, Alignment.CenterHorizontally),
</a><a href="#h4-2-8" id="h4-2-8" class="i">+            ) {
</a><a href="#h4-2-9" id="h4-2-9" class="i">+                Button(onClick = {
</a><a href="#h4-2-10" id="h4-2-10" class="i">+                    navController.navigate(SocialSection.LOGGED_STORIES_ROUTE.replace(&quot;{userId}&quot;, id))
</a><a href="#h4-2-11" id="h4-2-11" class="i">+                }) {
</a><a href="#h4-2-12" id="h4-2-12" class="i">+                    Text(&quot;Show Logged Stories&quot;)
</a><a href="#h4-2-13" id="h4-2-13" class="i">+                }
</a><a href="#h4-2-14" id="h4-2-14" class="i">+            }
</a><a href="#h4-2-15" id="h4-2-15" class="i">+
</a><a href="#h4-2-16" id="h4-2-16" class="i">+            Spacer(modifier = Modifier.height(16.dp))
</a><a href="#h4-2-17" id="h4-2-17" class="i">+        }
</a><a href="#h4-2-18" id="h4-2-18" class="i">+
</a>         Column {
             //streaks
             streaks?.let {
<a href="#h4-3" id="h4-3" class="h">@@ -241,6 +258,7 @@ class ScopeContent(
</a>                     }
                 }
             }
<a href="#h4-3-3" id="h4-3-3" class="i">+            Spacer(modifier = Modifier.height(16.dp))
</a>             // e2ee section
 
             SectionTitle(translation[&quot;e2ee_title&quot;])
<b>diff --git a/<a id="h5" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/social/SocialSection.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/social/SocialSection.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/social/SocialSection.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/social/SocialSection.kt</a></b>
<a href="#h5-0" id="h5-0" class="h">@@ -44,6 +44,7 @@ class SocialSection : Section() {
</a>     companion object {
         const val MAIN_ROUTE = &quot;social_route&quot;
         const val MESSAGING_PREVIEW_ROUTE = &quot;messaging_preview/?id={id}&amp;scope={scope}&quot;
<a href="#h5-0-3" id="h5-0-3" class="i">+        const val LOGGED_STORIES_ROUTE = &quot;logged_stories/?userId={userId}&quot;
</a>     }
 
     private var currentScopeContent: ScopeContent? = null
<a href="#h5-1" id="h5-1" class="h">@@ -84,6 +85,11 @@ class SocialSection : Section() {
</a>                 }
             }
 
<a href="#h5-1-3" id="h5-1-3" class="i">+            composable(LOGGED_STORIES_ROUTE) {
</a><a href="#h5-1-4" id="h5-1-4" class="i">+                val userId = it.arguments?.getString(&quot;userId&quot;) ?: return@composable
</a><a href="#h5-1-5" id="h5-1-5" class="i">+                LoggedStories(context, userId)
</a><a href="#h5-1-6" id="h5-1-6" class="i">+            }
</a><a href="#h5-1-7" id="h5-1-7" class="i">+
</a>             composable(MESSAGING_PREVIEW_ROUTE) { navBackStackEntry -&gt;
                 val id = navBackStackEntry.arguments?.getString(&quot;id&quot;) ?: return@composable
                 val scope = navBackStackEntry.arguments?.getString(&quot;scope&quot;) ?: return@composable
<b>diff --git a/<a id="h6" href="../file/app/src/main/res/xml/provider_paths.xml.html">app/src/main/res/xml/provider_paths.xml</a> b/<a href="../file/app/src/main/res/xml/provider_paths.xml.html">app/src/main/res/xml/provider_paths.xml</a></b>
<a href="#h6-0" id="h6-0" class="h">@@ -0,0 +1,4 @@
</a><a href="#h6-0-0" id="h6-0-0" class="i">+&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
</a><a href="#h6-0-1" id="h6-0-1" class="i">+&lt;paths&gt;
</a><a href="#h6-0-2" id="h6-0-2" class="i">+    &lt;external-path name=&quot;external_files&quot; path=&quot;.&quot;/&gt;
</a><a href="#h6-0-3" id="h6-0-3" class="i">+&lt;/paths&gt;
</a><b>diff --git a/<a id="h7" href="../file/common/src/main/aidl/me/rhunk/snapenhance/bridge/MessageLoggerInterface.aidl.html">common/src/main/aidl/me/rhunk/snapenhance/bridge/MessageLoggerInterface.aidl</a> b/<a href="../file/common/src/main/aidl/me/rhunk/snapenhance/bridge/MessageLoggerInterface.aidl.html">common/src/main/aidl/me/rhunk/snapenhance/bridge/MessageLoggerInterface.aidl</a></b>
<a href="#h7-0" id="h7-0" class="h">@@ -21,4 +21,9 @@ interface MessageLoggerInterface {
</a>      * Delete a message from the message logger database
      */
     void deleteMessage(String conversationId, long id);
<a href="#h7-0-3" id="h7-0-3" class="i">+
</a><a href="#h7-0-4" id="h7-0-4" class="i">+    /**
</a><a href="#h7-0-5" id="h7-0-5" class="i">+    * Add a story to the message logger database if it is not already there
</a><a href="#h7-0-6" id="h7-0-6" class="i">+    */
</a><a href="#h7-0-7" id="h7-0-7" class="i">+    boolean addStory(String userId, String url, long postedAt, long createdAt, in byte[] key, in byte[] iv);
</a> } 
\ No newline at end of file
<b>diff --git a/<a id="h8" href="../file/common/src/main/assets/lang/en_US.json.html">common/src/main/assets/lang/en_US.json</a> b/<a href="../file/common/src/main/assets/lang/en_US.json.html">common/src/main/assets/lang/en_US.json</a></b>
<a href="#h8-0" id="h8-0" class="h">@@ -597,6 +597,10 @@
</a>                         &quot;name&quot;: &quot;Convert Message Locally&quot;,
                         &quot;description&quot;: &quot;Converts snaps to chat external media locally. This appears in chat download context menu&quot;
                     },
<a href="#h8-0-3" id="h8-0-3" class="i">+                    &quot;story_logger&quot;: {
</a><a href="#h8-0-4" id="h8-0-4" class="i">+                        &quot;name&quot;: &quot;Story Logger&quot;,
</a><a href="#h8-0-5" id="h8-0-5" class="i">+                        &quot;description&quot;: &quot;Provides a history of friends stories&quot;
</a><a href="#h8-0-6" id="h8-0-6" class="i">+                    },
</a>                     &quot;app_passcode&quot;: {
                         &quot;name&quot;: &quot;App Passcode&quot;,
                         &quot;description&quot;: &quot;Sets a passcode to lock the app&quot;
<b>diff --git a/<a id="h9" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/wrapper/MessageLoggerWrapper.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/wrapper/MessageLoggerWrapper.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/wrapper/MessageLoggerWrapper.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/wrapper/MessageLoggerWrapper.kt</a></b>
<a href="#h9-0" id="h9-0" class="h">@@ -4,7 +4,11 @@ import android.content.ContentValues
</a> import android.database.sqlite.SQLiteDatabase
 import kotlinx.coroutines.*
 import me.rhunk.snapenhance.bridge.MessageLoggerInterface
<a href="#h9-0-3" id="h9-0-3" class="i">+import me.rhunk.snapenhance.common.data.StoryData
</a> import me.rhunk.snapenhance.common.util.SQLiteDatabaseHelper
<a href="#h9-0-5" id="h9-0-5" class="i">+import me.rhunk.snapenhance.common.util.ktx.getBlobOrNull
</a><a href="#h9-0-6" id="h9-0-6" class="i">+import me.rhunk.snapenhance.common.util.ktx.getLongOrNull
</a><a href="#h9-0-7" id="h9-0-7" class="i">+import me.rhunk.snapenhance.common.util.ktx.getStringOrNull
</a> import java.io.File
 import java.util.UUID
 
<a href="#h9-1" id="h9-1" class="h">@@ -25,6 +29,15 @@ class MessageLoggerWrapper(
</a>                     &quot;conversation_id VARCHAR&quot;,
                     &quot;message_id BIGINT&quot;,
                     &quot;message_data BLOB&quot;
<a href="#h9-1-3" id="h9-1-3" class="i">+                ),
</a><a href="#h9-1-4" id="h9-1-4" class="i">+                &quot;stories&quot; to listOf(
</a><a href="#h9-1-5" id="h9-1-5" class="i">+                    &quot;id INTEGER PRIMARY KEY&quot;,
</a><a href="#h9-1-6" id="h9-1-6" class="i">+                    &quot;user_id VARCHAR&quot;,
</a><a href="#h9-1-7" id="h9-1-7" class="i">+                    &quot;posted_timestamp BIGINT&quot;,
</a><a href="#h9-1-8" id="h9-1-8" class="i">+                    &quot;created_timestamp BIGINT&quot;,
</a><a href="#h9-1-9" id="h9-1-9" class="i">+                    &quot;url VARCHAR&quot;,
</a><a href="#h9-1-10" id="h9-1-10" class="i">+                    &quot;encryption_key BLOB&quot;,
</a><a href="#h9-1-11" id="h9-1-11" class="i">+                    &quot;encryption_iv BLOB&quot;
</a>                 )
             ))
             _database = openedDatabase
<a href="#h9-2" id="h9-2" class="h">@@ -89,9 +102,10 @@ class MessageLoggerWrapper(
</a>         return true
     }
 
<a href="#h9-2-3" id="h9-2-3" class="d">-    fun clearMessages() {
</a><a href="#h9-2-4" id="h9-2-4" class="i">+    fun clearAll() {
</a>         coroutineScope.launch {
             database.execSQL(&quot;DELETE FROM messages&quot;)
<a href="#h9-2-7" id="h9-2-7" class="i">+            database.execSQL(&quot;DELETE FROM stories&quot;)
</a>         }
     }
 
<a href="#h9-3" id="h9-3" class="h">@@ -103,9 +117,54 @@ class MessageLoggerWrapper(
</a>         return count
     }
 
<a href="#h9-3-3" id="h9-3-3" class="i">+    fun getStoredStoriesCount(): Int {
</a><a href="#h9-3-4" id="h9-3-4" class="i">+        val cursor = database.rawQuery(&quot;SELECT COUNT(*) FROM stories&quot;, null)
</a><a href="#h9-3-5" id="h9-3-5" class="i">+        cursor.moveToFirst()
</a><a href="#h9-3-6" id="h9-3-6" class="i">+        val count = cursor.getInt(0)
</a><a href="#h9-3-7" id="h9-3-7" class="i">+        cursor.close()
</a><a href="#h9-3-8" id="h9-3-8" class="i">+        return count
</a><a href="#h9-3-9" id="h9-3-9" class="i">+    }
</a><a href="#h9-3-10" id="h9-3-10" class="i">+
</a>     override fun deleteMessage(conversationId: String, messageId: Long) {
         coroutineScope.launch {
             database.execSQL(&quot;DELETE FROM messages WHERE conversation_id = ? AND message_id = ?&quot;, arrayOf(conversationId, messageId.toString()))
         }
     }
<a href="#h9-3-16" id="h9-3-16" class="i">+
</a><a href="#h9-3-17" id="h9-3-17" class="i">+    override fun addStory(userId: String, url: String, postedAt: Long, createdAt: Long, key: ByteArray?, iv: ByteArray?): Boolean {
</a><a href="#h9-3-18" id="h9-3-18" class="i">+        if (database.rawQuery(&quot;SELECT id FROM stories WHERE user_id = ? AND url = ?&quot;, arrayOf(userId, url)).use {
</a><a href="#h9-3-19" id="h9-3-19" class="i">+            it.moveToFirst()
</a><a href="#h9-3-20" id="h9-3-20" class="i">+        }) {
</a><a href="#h9-3-21" id="h9-3-21" class="i">+            return false
</a><a href="#h9-3-22" id="h9-3-22" class="i">+        }
</a><a href="#h9-3-23" id="h9-3-23" class="i">+        runBlocking {
</a><a href="#h9-3-24" id="h9-3-24" class="i">+            withContext(coroutineScope.coroutineContext) {
</a><a href="#h9-3-25" id="h9-3-25" class="i">+                database.insert(&quot;stories&quot;, null, ContentValues().apply {
</a><a href="#h9-3-26" id="h9-3-26" class="i">+                    put(&quot;user_id&quot;, userId)
</a><a href="#h9-3-27" id="h9-3-27" class="i">+                    put(&quot;url&quot;, url)
</a><a href="#h9-3-28" id="h9-3-28" class="i">+                    put(&quot;posted_timestamp&quot;, postedAt)
</a><a href="#h9-3-29" id="h9-3-29" class="i">+                    put(&quot;created_timestamp&quot;, createdAt)
</a><a href="#h9-3-30" id="h9-3-30" class="i">+                    put(&quot;encryption_key&quot;, key)
</a><a href="#h9-3-31" id="h9-3-31" class="i">+                    put(&quot;encryption_iv&quot;, iv)
</a><a href="#h9-3-32" id="h9-3-32" class="i">+                })
</a><a href="#h9-3-33" id="h9-3-33" class="i">+            }
</a><a href="#h9-3-34" id="h9-3-34" class="i">+        }
</a><a href="#h9-3-35" id="h9-3-35" class="i">+        return true
</a><a href="#h9-3-36" id="h9-3-36" class="i">+    }
</a><a href="#h9-3-37" id="h9-3-37" class="i">+
</a><a href="#h9-3-38" id="h9-3-38" class="i">+    fun getStories(userId: String, from: Long, limit: Int = Int.MAX_VALUE): Map&lt;Long, StoryData&gt; {
</a><a href="#h9-3-39" id="h9-3-39" class="i">+        val stories = sortedMapOf&lt;Long, StoryData&gt;()
</a><a href="#h9-3-40" id="h9-3-40" class="i">+        database.rawQuery(&quot;SELECT * FROM stories WHERE user_id = ? AND posted_timestamp &lt; ? ORDER BY posted_timestamp DESC LIMIT $limit&quot;, arrayOf(userId, from.toString())).use {
</a><a href="#h9-3-41" id="h9-3-41" class="i">+            while (it.moveToNext()) {
</a><a href="#h9-3-42" id="h9-3-42" class="i">+                stories[it.getLongOrNull(&quot;posted_timestamp&quot;) ?: continue] = StoryData(
</a><a href="#h9-3-43" id="h9-3-43" class="i">+                    url = it.getStringOrNull(&quot;url&quot;) ?: continue,
</a><a href="#h9-3-44" id="h9-3-44" class="i">+                    postedAt = it.getLongOrNull(&quot;posted_timestamp&quot;) ?: continue,
</a><a href="#h9-3-45" id="h9-3-45" class="i">+                    createdAt = it.getLongOrNull(&quot;created_timestamp&quot;) ?: continue,
</a><a href="#h9-3-46" id="h9-3-46" class="i">+                    key = it.getBlobOrNull(&quot;encryption_key&quot;),
</a><a href="#h9-3-47" id="h9-3-47" class="i">+                    iv = it.getBlobOrNull(&quot;encryption_iv&quot;)
</a><a href="#h9-3-48" id="h9-3-48" class="i">+                )
</a><a href="#h9-3-49" id="h9-3-49" class="i">+            }
</a><a href="#h9-3-50" id="h9-3-50" class="i">+        }
</a><a href="#h9-3-51" id="h9-3-51" class="i">+        return stories
</a><a href="#h9-3-52" id="h9-3-52" class="i">+    }
</a> } 
\ No newline at end of file
<b>diff --git a/<a id="h10" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/config/impl/Experimental.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/config/impl/Experimental.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/config/impl/Experimental.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/config/impl/Experimental.kt</a></b>
<a href="#h10-0" id="h10-0" class="h">@@ -11,6 +11,7 @@ class Experimental : ConfigContainer() {
</a>     val nativeHooks = container(&quot;native_hooks&quot;, NativeHooks()) { icon = &quot;Memory&quot;; requireRestart() }
     val spoof = container(&quot;spoof&quot;, Spoof()) { icon = &quot;Fingerprint&quot; ; addNotices(FeatureNotice.BAN_RISK); requireRestart() }
     val convertMessageLocally = boolean(&quot;convert_message_locally&quot;) { requireRestart() }
<a href="#h10-0-3" id="h10-0-3" class="i">+    val storyLogger = boolean(&quot;story_logger&quot;) { requireRestart(); addNotices(FeatureNotice.UNSTABLE); }
</a>     val appPasscode = string(&quot;app_passcode&quot;)
     val appLockOnResume = boolean(&quot;app_lock_on_resume&quot;)
     val infiniteStoryBoost = boolean(&quot;infinite_story_boost&quot;)
<b>diff --git a/<a id="h11" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/data/MessagingCoreObjects.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/data/MessagingCoreObjects.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/data/MessagingCoreObjects.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/data/MessagingCoreObjects.kt</a></b>
<a href="#h11-0" id="h11-0" class="h">@@ -71,3 +71,12 @@ data class MessagingFriendInfo(
</a>     val bitmojiId: String?,
     val selfieId: String?
 ) : SerializableDataObject()
<a href="#h11-0-3" id="h11-0-3" class="i">+
</a><a href="#h11-0-4" id="h11-0-4" class="i">+
</a><a href="#h11-0-5" id="h11-0-5" class="i">+class StoryData(
</a><a href="#h11-0-6" id="h11-0-6" class="i">+    val url: String,
</a><a href="#h11-0-7" id="h11-0-7" class="i">+    val postedAt: Long,
</a><a href="#h11-0-8" id="h11-0-8" class="i">+    val createdAt: Long,
</a><a href="#h11-0-9" id="h11-0-9" class="i">+    val key: ByteArray?,
</a><a href="#h11-0-10" id="h11-0-10" class="i">+    val iv: ByteArray?
</a><a href="#h11-0-11" id="h11-0-11" class="i">+) : SerializableDataObject()</a><a href="#h11-0-12" id="h11-0-12" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h12" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/data/download/DownloadRequest.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/data/download/DownloadRequest.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/data/download/DownloadRequest.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/data/download/DownloadRequest.kt</a></b>
<a href="#h12-0" id="h12-0" class="h">@@ -1,5 +1,9 @@
</a> package me.rhunk.snapenhance.common.data.download
 
<a href="#h12-0-2" id="h12-0-2" class="i">+import me.rhunk.snapenhance.common.config.impl.RootConfig
</a><a href="#h12-0-3" id="h12-0-3" class="i">+import java.text.SimpleDateFormat
</a><a href="#h12-0-4" id="h12-0-4" class="i">+import java.util.Locale
</a><a href="#h12-0-5" id="h12-0-5" class="i">+
</a> 
 data class DashOptions(val offsetTime: Long, val duration: Long?)
 data class InputMedia(
<a href="#h12-1" id="h12-1" class="h">@@ -25,4 +29,55 @@ class DownloadRequest(
</a> 
     val shouldMergeOverlay: Boolean
         get() = flags and Flags.MERGE_OVERLAY != 0
<a href="#h12-1-3" id="h12-1-3" class="i">+}
</a><a href="#h12-1-4" id="h12-1-4" class="i">+
</a><a href="#h12-1-5" id="h12-1-5" class="i">+fun String.sanitizeForPath(): String {
</a><a href="#h12-1-6" id="h12-1-6" class="i">+    return this.replace(&quot; &quot;, &quot;_&quot;)
</a><a href="#h12-1-7" id="h12-1-7" class="i">+        .replace(Regex(&quot;\\p{Cntrl}&quot;), &quot;&quot;)
</a><a href="#h12-1-8" id="h12-1-8" class="i">+}
</a><a href="#h12-1-9" id="h12-1-9" class="i">+
</a><a href="#h12-1-10" id="h12-1-10" class="i">+fun createNewFilePath(
</a><a href="#h12-1-11" id="h12-1-11" class="i">+    config: RootConfig,
</a><a href="#h12-1-12" id="h12-1-12" class="i">+    hexHash: String,
</a><a href="#h12-1-13" id="h12-1-13" class="i">+    downloadSource: MediaDownloadSource,
</a><a href="#h12-1-14" id="h12-1-14" class="i">+    mediaAuthor: String,
</a><a href="#h12-1-15" id="h12-1-15" class="i">+    creationTimestamp: Long?
</a><a href="#h12-1-16" id="h12-1-16" class="i">+): String {
</a><a href="#h12-1-17" id="h12-1-17" class="i">+    val pathFormat by config.downloader.pathFormat
</a><a href="#h12-1-18" id="h12-1-18" class="i">+    val sanitizedMediaAuthor = mediaAuthor.sanitizeForPath().ifEmpty { hexHash }
</a><a href="#h12-1-19" id="h12-1-19" class="i">+
</a><a href="#h12-1-20" id="h12-1-20" class="i">+    val currentDateTime = SimpleDateFormat(&quot;yyyy-MM-dd_HH-mm-ss&quot;, Locale.ENGLISH).format(creationTimestamp ?: System.currentTimeMillis())
</a><a href="#h12-1-21" id="h12-1-21" class="i">+
</a><a href="#h12-1-22" id="h12-1-22" class="i">+    val finalPath = StringBuilder()
</a><a href="#h12-1-23" id="h12-1-23" class="i">+
</a><a href="#h12-1-24" id="h12-1-24" class="i">+    fun appendFileName(string: String) {
</a><a href="#h12-1-25" id="h12-1-25" class="i">+        if (finalPath.isEmpty() || finalPath.endsWith(&quot;/&quot;)) {
</a><a href="#h12-1-26" id="h12-1-26" class="i">+            finalPath.append(string)
</a><a href="#h12-1-27" id="h12-1-27" class="i">+        } else {
</a><a href="#h12-1-28" id="h12-1-28" class="i">+            finalPath.append(&quot;_&quot;).append(string)
</a><a href="#h12-1-29" id="h12-1-29" class="i">+        }
</a><a href="#h12-1-30" id="h12-1-30" class="i">+    }
</a><a href="#h12-1-31" id="h12-1-31" class="i">+
</a><a href="#h12-1-32" id="h12-1-32" class="i">+    if (pathFormat.contains(&quot;create_author_folder&quot;)) {
</a><a href="#h12-1-33" id="h12-1-33" class="i">+        finalPath.append(sanitizedMediaAuthor).append(&quot;/&quot;)
</a><a href="#h12-1-34" id="h12-1-34" class="i">+    }
</a><a href="#h12-1-35" id="h12-1-35" class="i">+    if (pathFormat.contains(&quot;create_source_folder&quot;)) {
</a><a href="#h12-1-36" id="h12-1-36" class="i">+        finalPath.append(downloadSource.pathName).append(&quot;/&quot;)
</a><a href="#h12-1-37" id="h12-1-37" class="i">+    }
</a><a href="#h12-1-38" id="h12-1-38" class="i">+    if (pathFormat.contains(&quot;append_hash&quot;)) {
</a><a href="#h12-1-39" id="h12-1-39" class="i">+        appendFileName(hexHash)
</a><a href="#h12-1-40" id="h12-1-40" class="i">+    }
</a><a href="#h12-1-41" id="h12-1-41" class="i">+    if (pathFormat.contains(&quot;append_source&quot;)) {
</a><a href="#h12-1-42" id="h12-1-42" class="i">+        appendFileName(downloadSource.pathName)
</a><a href="#h12-1-43" id="h12-1-43" class="i">+    }
</a><a href="#h12-1-44" id="h12-1-44" class="i">+    if (pathFormat.contains(&quot;append_username&quot;)) {
</a><a href="#h12-1-45" id="h12-1-45" class="i">+        appendFileName(sanitizedMediaAuthor)
</a><a href="#h12-1-46" id="h12-1-46" class="i">+    }
</a><a href="#h12-1-47" id="h12-1-47" class="i">+    if (pathFormat.contains(&quot;append_date_time&quot;)) {
</a><a href="#h12-1-48" id="h12-1-48" class="i">+        appendFileName(currentDateTime)
</a><a href="#h12-1-49" id="h12-1-49" class="i">+    }
</a><a href="#h12-1-50" id="h12-1-50" class="i">+
</a><a href="#h12-1-51" id="h12-1-51" class="i">+    if (finalPath.isEmpty()) finalPath.append(hexHash)
</a><a href="#h12-1-52" id="h12-1-52" class="i">+
</a><a href="#h12-1-53" id="h12-1-53" class="i">+    return finalPath.toString()
</a> } 
\ No newline at end of file
<b>diff --git a/<a id="h13" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/data/download/MediaDownloadSource.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/data/download/MediaDownloadSource.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/data/download/MediaDownloadSource.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/data/download/MediaDownloadSource.kt</a></b>
<a href="#h13-0" id="h13-0" class="h">@@ -12,7 +12,8 @@ enum class MediaDownloadSource(
</a>     STORY(&quot;story&quot;, &quot;Story&quot;, &quot;story&quot;),
     PUBLIC_STORY(&quot;public_story&quot;, &quot;Public Story&quot;, &quot;public_story&quot;),
     SPOTLIGHT(&quot;spotlight&quot;, &quot;Spotlight&quot;, &quot;spotlight&quot;),
<a href="#h13-0-3" id="h13-0-3" class="d">-    PROFILE_PICTURE(&quot;profile_picture&quot;, &quot;Profile Picture&quot;, &quot;profile_picture&quot;);
</a><a href="#h13-0-4" id="h13-0-4" class="i">+    PROFILE_PICTURE(&quot;profile_picture&quot;, &quot;Profile Picture&quot;, &quot;profile_picture&quot;),
</a><a href="#h13-0-5" id="h13-0-5" class="i">+    STORY_LOGGER(&quot;story_logger&quot;, &quot;Story Logger&quot;, &quot;story_logger&quot;);
</a> 
     fun matches(source: String?): Boolean {
         if (source == null) return false
<b>diff --git a/<a id="h14" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/util/snap/MediaDownloaderHelper.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/util/snap/MediaDownloaderHelper.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/util/snap/MediaDownloaderHelper.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/util/snap/MediaDownloaderHelper.kt</a></b>
<a href="#h14-0" id="h14-0" class="h">@@ -22,7 +22,7 @@ object MediaDownloaderHelper {
</a>         inputStream: InputStream,
         callback: (SplitMediaAssetType, InputStream) -&gt; Unit
     ) {
<a href="#h14-0-3" id="h14-0-3" class="d">-        val bufferedInputStream = BufferedInputStream(inputStream)
</a><a href="#h14-0-4" id="h14-0-4" class="i">+        val bufferedInputStream = inputStream.buffered()
</a>         val fileType = getFileType(bufferedInputStream)
 
         if (fileType != FileType.ZIP) {
<a href="#h14-1" id="h14-1" class="h">@@ -30,16 +30,16 @@ object MediaDownloaderHelper {
</a>             return
         }
 
<a href="#h14-1-3" id="h14-1-3" class="d">-        val zipInputStream = ZipInputStream(bufferedInputStream)
</a><a href="#h14-1-4" id="h14-1-4" class="d">-
</a><a href="#h14-1-5" id="h14-1-5" class="d">-        var entry: ZipEntry? = zipInputStream.nextEntry
</a><a href="#h14-1-6" id="h14-1-6" class="d">-        while (entry != null) {
</a><a href="#h14-1-7" id="h14-1-7" class="d">-            if (entry.name.startsWith(&quot;overlay&quot;)) {
</a><a href="#h14-1-8" id="h14-1-8" class="d">-                callback(SplitMediaAssetType.OVERLAY, zipInputStream)
</a><a href="#h14-1-9" id="h14-1-9" class="d">-            } else if (entry.name.startsWith(&quot;media&quot;)) {
</a><a href="#h14-1-10" id="h14-1-10" class="d">-                callback(SplitMediaAssetType.ORIGINAL, zipInputStream)
</a><a href="#h14-1-11" id="h14-1-11" class="i">+        ZipInputStream(bufferedInputStream).use { zipInputStream -&gt;
</a><a href="#h14-1-12" id="h14-1-12" class="i">+            var entry: ZipEntry? = zipInputStream.nextEntry
</a><a href="#h14-1-13" id="h14-1-13" class="i">+            while (entry != null) {
</a><a href="#h14-1-14" id="h14-1-14" class="i">+                if (entry.name.startsWith(&quot;overlay&quot;)) {
</a><a href="#h14-1-15" id="h14-1-15" class="i">+                    callback(SplitMediaAssetType.OVERLAY, zipInputStream)
</a><a href="#h14-1-16" id="h14-1-16" class="i">+                } else if (entry.name.startsWith(&quot;media&quot;)) {
</a><a href="#h14-1-17" id="h14-1-17" class="i">+                    callback(SplitMediaAssetType.ORIGINAL, zipInputStream)
</a><a href="#h14-1-18" id="h14-1-18" class="i">+                }
</a><a href="#h14-1-19" id="h14-1-19" class="i">+                entry = zipInputStream.nextEntry
</a>             }
<a href="#h14-1-21" id="h14-1-21" class="d">-            entry = zipInputStream.nextEntry
</a>         }
     }
 } 
\ No newline at end of file
<b>diff --git a/<a id="h15" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/Stories.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/Stories.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/Stories.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/Stories.kt</a></b>
<a href="#h15-0" id="h15-0" class="h">@@ -1,16 +1,23 @@
</a> package me.rhunk.snapenhance.core.features.impl
 
<a href="#h15-0-2" id="h15-0-2" class="i">+import kotlinx.coroutines.launch
</a> import kotlinx.coroutines.runBlocking
<a href="#h15-0-4" id="h15-0-4" class="i">+import me.rhunk.snapenhance.common.data.StoryData
</a> import me.rhunk.snapenhance.common.util.protobuf.ProtoEditor
<a href="#h15-0-6" id="h15-0-6" class="i">+import me.rhunk.snapenhance.common.util.protobuf.ProtoReader
</a> import me.rhunk.snapenhance.core.event.events.impl.NetworkApiRequestEvent
 import me.rhunk.snapenhance.core.features.Feature
 import me.rhunk.snapenhance.core.features.FeatureLoadParams
 import java.nio.ByteBuffer
 import kotlin.coroutines.suspendCoroutine
<a href="#h15-0-12" id="h15-0-12" class="i">+import kotlin.io.encoding.Base64
</a><a href="#h15-0-13" id="h15-0-13" class="i">+import kotlin.io.encoding.ExperimentalEncodingApi
</a> 
 class Stories : Feature(&quot;Stories&quot;, loadParams = FeatureLoadParams.INIT_SYNC) {
<a href="#h15-0-16" id="h15-0-16" class="i">+    @OptIn(ExperimentalEncodingApi::class)
</a>     override fun init() {
         val disablePublicStories by context.config.global.disablePublicStories
<a href="#h15-0-19" id="h15-0-19" class="i">+        val storyLogger by context.config.experimental.storyLogger
</a> 
         context.event.subscribe(NetworkApiRequestEvent::class) { event -&gt;
             fun cancelRequest() {
<a href="#h15-1" id="h15-1" class="h">@@ -42,8 +49,8 @@ class Stories : Feature(&quot;Stories&quot;, loadParams = FeatureLoadParams.INIT_SYNC) {
</a>                         }
                     }.toByteArray()
                 }
<a href="#h15-1-3" id="h15-1-3" class="i">+                return@subscribe
</a>             }
<a href="#h15-1-5" id="h15-1-5" class="d">-
</a>             if (disablePublicStories &amp;&amp; (event.url.endsWith(&quot;df-mixer-prod/stories&quot;) || event.url.endsWith(&quot;df-mixer-prod/batch_stories&quot;)))  {
                 event.onSuccess { buffer -&gt;
                     val payload = ProtoEditor(buffer ?: return@onSuccess).apply {
<a href="#h15-2" id="h15-2" class="h">@@ -53,6 +60,42 @@ class Stories : Feature(&quot;Stories&quot;, loadParams = FeatureLoadParams.INIT_SYNC) {
</a>                 }
                 return@subscribe
             }
<a href="#h15-2-3" id="h15-2-3" class="i">+
</a><a href="#h15-2-4" id="h15-2-4" class="i">+            if (storyLogger &amp;&amp; event.url.endsWith(&quot;df-mixer-prod/soma/batch_stories&quot;)) {
</a><a href="#h15-2-5" id="h15-2-5" class="i">+                event.onSuccess { buffer -&gt;
</a><a href="#h15-2-6" id="h15-2-6" class="i">+                    val stories = mutableMapOf&lt;String, MutableList&lt;StoryData&gt;&gt;()
</a><a href="#h15-2-7" id="h15-2-7" class="i">+                    val reader = ProtoReader(buffer ?: return@onSuccess)
</a><a href="#h15-2-8" id="h15-2-8" class="i">+                    reader.followPath(3, 3) {
</a><a href="#h15-2-9" id="h15-2-9" class="i">+                        eachBuffer(3) {
</a><a href="#h15-2-10" id="h15-2-10" class="i">+                            followPath(36) {
</a><a href="#h15-2-11" id="h15-2-11" class="i">+                                eachBuffer(1) data@{
</a><a href="#h15-2-12" id="h15-2-12" class="i">+                                    val userId = getString(8, 1) ?: return@data
</a><a href="#h15-2-13" id="h15-2-13" class="i">+
</a><a href="#h15-2-14" id="h15-2-14" class="i">+                                    stories.getOrPut(userId) {
</a><a href="#h15-2-15" id="h15-2-15" class="i">+                                        mutableListOf()
</a><a href="#h15-2-16" id="h15-2-16" class="i">+                                    }.add(StoryData(
</a><a href="#h15-2-17" id="h15-2-17" class="i">+                                        url = getString(2, 2)?.substringBefore(&quot;?&quot;) ?: return@data,
</a><a href="#h15-2-18" id="h15-2-18" class="i">+                                        postedAt = getVarInt(3) ?: -1L,
</a><a href="#h15-2-19" id="h15-2-19" class="i">+                                        createdAt = getVarInt(27) ?: -1L,
</a><a href="#h15-2-20" id="h15-2-20" class="i">+                                        key = Base64.decode(getString(2, 5) ?: return@data),
</a><a href="#h15-2-21" id="h15-2-21" class="i">+                                        iv = Base64.decode(getString(2, 4) ?: return@data)
</a><a href="#h15-2-22" id="h15-2-22" class="i">+                                    ))
</a><a href="#h15-2-23" id="h15-2-23" class="i">+                                }
</a><a href="#h15-2-24" id="h15-2-24" class="i">+                            }
</a><a href="#h15-2-25" id="h15-2-25" class="i">+                        }
</a><a href="#h15-2-26" id="h15-2-26" class="i">+                    }
</a><a href="#h15-2-27" id="h15-2-27" class="i">+
</a><a href="#h15-2-28" id="h15-2-28" class="i">+                    context.coroutineScope.launch {
</a><a href="#h15-2-29" id="h15-2-29" class="i">+                        stories.forEach { (userId, stories) -&gt;
</a><a href="#h15-2-30" id="h15-2-30" class="i">+                            stories.forEach { story -&gt;
</a><a href="#h15-2-31" id="h15-2-31" class="i">+                                context.bridgeClient.getMessageLogger().addStory(userId, story.url, story.postedAt, story.createdAt, story.key, story.iv)
</a><a href="#h15-2-32" id="h15-2-32" class="i">+                            }
</a><a href="#h15-2-33" id="h15-2-33" class="i">+                        }
</a><a href="#h15-2-34" id="h15-2-34" class="i">+                    }
</a><a href="#h15-2-35" id="h15-2-35" class="i">+                }
</a><a href="#h15-2-36" id="h15-2-36" class="i">+
</a><a href="#h15-2-37" id="h15-2-37" class="i">+                return@subscribe
</a><a href="#h15-2-38" id="h15-2-38" class="i">+            }
</a>         }
     }
 } 
\ No newline at end of file
<b>diff --git a/<a id="h16" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/downloader/MediaDownloader.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/downloader/MediaDownloader.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/downloader/MediaDownloader.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/downloader/MediaDownloader.kt</a></b>
<a href="#h16-0" id="h16-0" class="h">@@ -18,11 +18,7 @@ import kotlinx.coroutines.runBlocking
</a> import me.rhunk.snapenhance.bridge.DownloadCallback
 import me.rhunk.snapenhance.common.data.FileType
 import me.rhunk.snapenhance.common.data.MessagingRuleType
<a href="#h16-0-3" id="h16-0-3" class="d">-import me.rhunk.snapenhance.common.data.download.DownloadMediaType
</a><a href="#h16-0-4" id="h16-0-4" class="d">-import me.rhunk.snapenhance.common.data.download.DownloadMetadata
</a><a href="#h16-0-5" id="h16-0-5" class="d">-import me.rhunk.snapenhance.common.data.download.InputMedia
</a><a href="#h16-0-6" id="h16-0-6" class="d">-import me.rhunk.snapenhance.common.data.download.MediaDownloadSource
</a><a href="#h16-0-7" id="h16-0-7" class="d">-import me.rhunk.snapenhance.common.data.download.SplitMediaAssetType
</a><a href="#h16-0-8" id="h16-0-8" class="i">+import me.rhunk.snapenhance.common.data.download.*
</a> import me.rhunk.snapenhance.common.database.impl.ConversationMessage
 import me.rhunk.snapenhance.common.database.impl.FriendInfo
 import me.rhunk.snapenhance.common.util.ktx.longHashCode
<a href="#h16-1" id="h16-1" class="h">@@ -53,19 +49,12 @@ import me.rhunk.snapenhance.core.wrapper.impl.media.opera.ParamMap
</a> import me.rhunk.snapenhance.core.wrapper.impl.media.toKeyPair
 import java.io.ByteArrayInputStream
 import java.nio.file.Paths
<a href="#h16-1-3" id="h16-1-3" class="d">-import java.text.SimpleDateFormat
</a><a href="#h16-1-4" id="h16-1-4" class="d">-import java.util.Locale
</a> import java.util.UUID
 import kotlin.coroutines.suspendCoroutine
 import kotlin.io.encoding.Base64
 import kotlin.io.encoding.ExperimentalEncodingApi
 import kotlin.math.absoluteValue
 
<a href="#h16-1-11" id="h16-1-11" class="d">-private fun String.sanitizeForPath(): String {
</a><a href="#h16-1-12" id="h16-1-12" class="d">-    return this.replace(&quot; &quot;, &quot;_&quot;)
</a><a href="#h16-1-13" id="h16-1-13" class="d">-        .replace(Regex(&quot;\\p{Cntrl}&quot;), &quot;&quot;)
</a><a href="#h16-1-14" id="h16-1-14" class="d">-}
</a><a href="#h16-1-15" id="h16-1-15" class="d">-
</a> class SnapChapterInfo(
     val offset: Long,
     val duration: Long?
<a href="#h16-2" id="h16-2" class="h">@@ -100,7 +89,13 @@ class MediaDownloader : MessagingRuleFeature(&quot;MediaDownloader&quot;, MessagingRuleTyp
</a>             context.shortToast(translations[&quot;download_started_toast&quot;])
         }
 
<a href="#h16-2-3" id="h16-2-3" class="d">-        val outputPath = createNewFilePath(generatedHash.substring(0, generatedHash.length.coerceAtMost(8)), downloadSource, mediaAuthor, creationTimestamp?.takeIf { it &gt; 0L })
</a><a href="#h16-2-4" id="h16-2-4" class="i">+        val outputPath = createNewFilePath(
</a><a href="#h16-2-5" id="h16-2-5" class="i">+            context.config,
</a><a href="#h16-2-6" id="h16-2-6" class="i">+            generatedHash.substring(0, generatedHash.length.coerceAtMost(8)),
</a><a href="#h16-2-7" id="h16-2-7" class="i">+            downloadSource,
</a><a href="#h16-2-8" id="h16-2-8" class="i">+            mediaAuthor,
</a><a href="#h16-2-9" id="h16-2-9" class="i">+            creationTimestamp?.takeIf { it &gt; 0L }
</a><a href="#h16-2-10" id="h16-2-10" class="i">+        )
</a> 
         return DownloadManagerClient(
             context = context,
<a href="#h16-3" id="h16-3" class="h">@@ -137,52 +132,6 @@ class MediaDownloader : MessagingRuleFeature(&quot;MediaDownloader&quot;, MessagingRuleTyp
</a>         )
     }
 
<a href="#h16-3-3" id="h16-3-3" class="d">-
</a><a href="#h16-3-4" id="h16-3-4" class="d">-    private fun createNewFilePath(
</a><a href="#h16-3-5" id="h16-3-5" class="d">-        hexHash: String,
</a><a href="#h16-3-6" id="h16-3-6" class="d">-        downloadSource: MediaDownloadSource,
</a><a href="#h16-3-7" id="h16-3-7" class="d">-        mediaAuthor: String,
</a><a href="#h16-3-8" id="h16-3-8" class="d">-        creationTimestamp: Long?
</a><a href="#h16-3-9" id="h16-3-9" class="d">-    ): String {
</a><a href="#h16-3-10" id="h16-3-10" class="d">-        val pathFormat by context.config.downloader.pathFormat
</a><a href="#h16-3-11" id="h16-3-11" class="d">-        val sanitizedMediaAuthor = mediaAuthor.sanitizeForPath().ifEmpty { hexHash }
</a><a href="#h16-3-12" id="h16-3-12" class="d">-
</a><a href="#h16-3-13" id="h16-3-13" class="d">-        val currentDateTime = SimpleDateFormat(&quot;yyyy-MM-dd_HH-mm-ss&quot;, Locale.ENGLISH).format(creationTimestamp ?: System.currentTimeMillis())
</a><a href="#h16-3-14" id="h16-3-14" class="d">-
</a><a href="#h16-3-15" id="h16-3-15" class="d">-        val finalPath = StringBuilder()
</a><a href="#h16-3-16" id="h16-3-16" class="d">-
</a><a href="#h16-3-17" id="h16-3-17" class="d">-        fun appendFileName(string: String) {
</a><a href="#h16-3-18" id="h16-3-18" class="d">-            if (finalPath.isEmpty() || finalPath.endsWith(&quot;/&quot;)) {
</a><a href="#h16-3-19" id="h16-3-19" class="d">-                finalPath.append(string)
</a><a href="#h16-3-20" id="h16-3-20" class="d">-            } else {
</a><a href="#h16-3-21" id="h16-3-21" class="d">-                finalPath.append(&quot;_&quot;).append(string)
</a><a href="#h16-3-22" id="h16-3-22" class="d">-            }
</a><a href="#h16-3-23" id="h16-3-23" class="d">-        }
</a><a href="#h16-3-24" id="h16-3-24" class="d">-
</a><a href="#h16-3-25" id="h16-3-25" class="d">-        if (pathFormat.contains(&quot;create_author_folder&quot;)) {
</a><a href="#h16-3-26" id="h16-3-26" class="d">-            finalPath.append(sanitizedMediaAuthor).append(&quot;/&quot;)
</a><a href="#h16-3-27" id="h16-3-27" class="d">-        }
</a><a href="#h16-3-28" id="h16-3-28" class="d">-        if (pathFormat.contains(&quot;create_source_folder&quot;)) {
</a><a href="#h16-3-29" id="h16-3-29" class="d">-            finalPath.append(downloadSource.pathName).append(&quot;/&quot;)
</a><a href="#h16-3-30" id="h16-3-30" class="d">-        }
</a><a href="#h16-3-31" id="h16-3-31" class="d">-        if (pathFormat.contains(&quot;append_hash&quot;)) {
</a><a href="#h16-3-32" id="h16-3-32" class="d">-            appendFileName(hexHash)
</a><a href="#h16-3-33" id="h16-3-33" class="d">-        }
</a><a href="#h16-3-34" id="h16-3-34" class="d">-        if (pathFormat.contains(&quot;append_source&quot;)) {
</a><a href="#h16-3-35" id="h16-3-35" class="d">-            appendFileName(downloadSource.pathName)
</a><a href="#h16-3-36" id="h16-3-36" class="d">-        }
</a><a href="#h16-3-37" id="h16-3-37" class="d">-        if (pathFormat.contains(&quot;append_username&quot;)) {
</a><a href="#h16-3-38" id="h16-3-38" class="d">-            appendFileName(sanitizedMediaAuthor)
</a><a href="#h16-3-39" id="h16-3-39" class="d">-        }
</a><a href="#h16-3-40" id="h16-3-40" class="d">-        if (pathFormat.contains(&quot;append_date_time&quot;)) {
</a><a href="#h16-3-41" id="h16-3-41" class="d">-            appendFileName(currentDateTime)
</a><a href="#h16-3-42" id="h16-3-42" class="d">-        }
</a><a href="#h16-3-43" id="h16-3-43" class="d">-
</a><a href="#h16-3-44" id="h16-3-44" class="d">-        if (finalPath.isEmpty()) finalPath.append(hexHash)
</a><a href="#h16-3-45" id="h16-3-45" class="d">-
</a><a href="#h16-3-46" id="h16-3-46" class="d">-        return finalPath.toString()
</a><a href="#h16-3-47" id="h16-3-47" class="d">-    }
</a><a href="#h16-3-48" id="h16-3-48" class="d">-
</a>     /*
      * Download the last seen media
      */
</pre>
</div>
</body>
</html>
