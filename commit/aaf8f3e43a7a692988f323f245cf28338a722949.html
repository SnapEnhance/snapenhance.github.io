<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>feat: end-to-end encryption - message_logger: fix view binder bugs and deleted message color - fix invalid message rule type - SnapEnhance - An Xposed module offering an enhanced Snapchat experience
</title>
<link rel="icon" type="image/svg+xml" href="../../logo.png"/>
<link rel="alternate icon" href="../../favicon.png"/>
<link rel="alternate" type="application/atom+xml" title="SnapEnhance Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="SnapEnhance Atom Feed (tags)" href="../tags.xml" />
<link rel="stylesheet" type="text/css" href="../../style.css" />
<link rel="stylesheet" type="text/css" href="../../fonts.css" />
</head>
<body>
<div id="head"><table><tr><td><a class="logo" href="../../"><img src="../../logo.png" alt="" width="32" height="32" /></a></td><td><strong>SnapEnhance</strong><span class="desc"> - An Xposed module offering an enhanced Snapchat experience
</span>
</td></tr></table>
<p><a href="../about.html">About</a> | <a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/LICENSE.html">License</a></p>
</div>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/aaf8f3e43a7a692988f323f245cf28338a722949.html">aaf8f3e43a7a692988f323f245cf28338a722949</a>
<b>parent</b> <a href="../commit/061f5cc5a87364a55afd1f0f6b31bb061cd8e213.html">061f5cc5a87364a55afd1f0f6b31bb061cd8e213</a>
<b>Author:</b> rhunk &lt;<a href="mailto:101876869+rhunk@users.noreply.github.com">101876869+rhunk@users.noreply.github.com</a>&gt;
<b>Date:</b>   Thu, 28 Sep 2023 02:12:03 +0200

feat: end-to-end encryption
- message_logger: fix view binder bugs and deleted message color
- fix invalid message rule type

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">app/build.gradle.kts</a></td><td> | </td><td class="num">1</td><td><span class="i">+</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">app/src/main/kotlin/me/rhunk/snapenhance/RemoteSideContext.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h2">app/src/main/kotlin/me/rhunk/snapenhance/bridge/BridgeService.kt</a></td><td> | </td><td class="num">3</td><td><span class="i">+++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h3">app/src/main/kotlin/me/rhunk/snapenhance/e2ee/E2EEImplementation.kt</a></td><td> | </td><td class="num">156</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h4">app/src/main/kotlin/me/rhunk/snapenhance/messaging/ModDatabase.kt</a></td><td> | </td><td class="num">8</td><td><span class="i">+++++++</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h5">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/social/ScopeContent.kt</a></td><td> | </td><td class="num">82</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">-------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h6">app/src/main/kotlin/me/rhunk/snapenhance/ui/util/AlertDialogs.kt</a></td><td> | </td><td class="num">40</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h7">core/src/main/aidl/me/rhunk/snapenhance/bridge/BridgeInterface.aidl</a></td><td> | </td><td class="num">3</td><td><span class="i">+++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h8">core/src/main/aidl/me/rhunk/snapenhance/bridge/e2ee/E2eeInterface.aidl</a></td><td> | </td><td class="num">35</td><td><span class="i">+++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h9">core/src/main/aidl/me/rhunk/snapenhance/bridge/e2ee/EncryptionResult.aidl</a></td><td> | </td><td class="num">7</td><td><span class="i">+++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h10">core/src/main/assets/lang/en_US.json</a></td><td> | </td><td class="num">13</td><td><span class="i">+++++++</span><span class="d">------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h11">core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/BridgeClient.kt</a></td><td> | </td><td class="num">3</td><td><span class="i">+++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h12">core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/Experimental.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h13">core/src/main/kotlin/me/rhunk/snapenhance/core/event/EventDispatcher.kt</a></td><td> | </td><td class="num">45</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++</span><span class="d">-----</span></td></tr>
<tr><td class="A">A</td><td><a href="#h14">core/src/main/kotlin/me/rhunk/snapenhance/core/event/events/impl/BindViewEvent.kt</a></td><td> | </td><td class="num">27</td><td><span class="i">+++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h15">core/src/main/kotlin/me/rhunk/snapenhance/core/messaging/MessagingCoreObjects.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h16">core/src/main/kotlin/me/rhunk/snapenhance/data/MessageSender.kt</a></td><td> | </td><td class="num">9</td><td><span class="i">+++++++++</span><span class="d"></span></td></tr>
<tr><td class="D">D</td><td><a href="#h17">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/experiments/AESMessageEncryption.kt</a></td><td> | </td><td class="num">162</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="A">A</td><td><a href="#h18">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/experiments/EndToEndEncryption.kt</a></td><td> | </td><td class="num">443</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h19">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/spying/MessageLogger.kt</a></td><td> | </td><td class="num">47</td><td><span class="i">+++++++++++</span><span class="d">------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h20">core/src/main/kotlin/me/rhunk/snapenhance/manager/impl/FeatureManager.kt</a></td><td> | </td><td class="num">3</td><td><span class="i">+</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h21">gradle/libs.versions.toml</a></td><td> | </td><td class="num">2</td><td><span class="i">++</span><span class="d"></span></td></tr>
</table></pre><pre>22 files changed, 874 insertions(+), 221 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/app/build.gradle.kts.html">app/build.gradle.kts</a> b/<a href="../file/app/build.gradle.kts.html">app/build.gradle.kts</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -103,6 +103,7 @@ dependencies {
</a>     implementation(libs.ffmpeg.kit)
     implementation(libs.osmdroid.android)
     implementation(libs.rhino)
<a href="#h0-0-3" id="h0-0-3" class="i">+    implementation(libs.bcprov.jdk18on)
</a> 
     debugImplementation(&quot;androidx.compose.ui:ui-tooling:1.4.3&quot;)
     implementation(&quot;androidx.compose.ui:ui-tooling-preview:1.4.3&quot;)
<b>diff --git a/<a id="h1" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/RemoteSideContext.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/RemoteSideContext.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/RemoteSideContext.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/RemoteSideContext.kt</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -22,6 +22,7 @@ import me.rhunk.snapenhance.core.bridge.wrapper.LocaleWrapper
</a> import me.rhunk.snapenhance.core.bridge.wrapper.MappingsWrapper
 import me.rhunk.snapenhance.core.config.ModConfig
 import me.rhunk.snapenhance.download.DownloadTaskManager
<a href="#h1-0-3" id="h1-0-3" class="i">+import me.rhunk.snapenhance.e2ee.E2EEImplementation
</a> import me.rhunk.snapenhance.messaging.ModDatabase
 import me.rhunk.snapenhance.messaging.StreaksReminder
 import me.rhunk.snapenhance.scripting.RemoteScriptManager
<a href="#h1-1" id="h1-1" class="h">@@ -58,6 +59,7 @@ class RemoteSideContext(
</a>     val log = LogManager(this)
     val scriptManager = RemoteScriptManager(this)
     val settingsOverlay = SettingsOverlay(this)
<a href="#h1-1-3" id="h1-1-3" class="i">+    val e2eeImplementation = E2EEImplementation(this)
</a> 
     //used to load bitmoji selfies and download previews
     val imageLoader by lazy {
<b>diff --git a/<a id="h2" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/BridgeService.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/BridgeService.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/BridgeService.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/BridgeService.kt</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -187,6 +187,9 @@ class BridgeService : Service() {
</a>         }
 
         override fun getScriptingInterface() = remoteSideContext.scriptManager
<a href="#h2-0-3" id="h2-0-3" class="i">+
</a><a href="#h2-0-4" id="h2-0-4" class="i">+        override fun getE2eeInterface() = remoteSideContext.e2eeImplementation
</a><a href="#h2-0-5" id="h2-0-5" class="i">+
</a>         override fun openSettingsOverlay() {
             runCatching {
                 remoteSideContext.settingsOverlay.show()
<b>diff --git a/<a id="h3" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/e2ee/E2EEImplementation.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/e2ee/E2EEImplementation.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/e2ee/E2EEImplementation.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/e2ee/E2EEImplementation.kt</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -0,0 +1,155 @@
</a><a href="#h3-0-0" id="h3-0-0" class="i">+package me.rhunk.snapenhance.e2ee
</a><a href="#h3-0-1" id="h3-0-1" class="i">+
</a><a href="#h3-0-2" id="h3-0-2" class="i">+import me.rhunk.snapenhance.RemoteSideContext
</a><a href="#h3-0-3" id="h3-0-3" class="i">+import me.rhunk.snapenhance.bridge.e2ee.E2eeInterface
</a><a href="#h3-0-4" id="h3-0-4" class="i">+import me.rhunk.snapenhance.bridge.e2ee.EncryptionResult
</a><a href="#h3-0-5" id="h3-0-5" class="i">+import org.bouncycastle.pqc.crypto.crystals.kyber.*
</a><a href="#h3-0-6" id="h3-0-6" class="i">+import java.io.File
</a><a href="#h3-0-7" id="h3-0-7" class="i">+import java.security.SecureRandom
</a><a href="#h3-0-8" id="h3-0-8" class="i">+import javax.crypto.Cipher
</a><a href="#h3-0-9" id="h3-0-9" class="i">+import javax.crypto.spec.IvParameterSpec
</a><a href="#h3-0-10" id="h3-0-10" class="i">+import javax.crypto.spec.SecretKeySpec
</a><a href="#h3-0-11" id="h3-0-11" class="i">+
</a><a href="#h3-0-12" id="h3-0-12" class="i">+
</a><a href="#h3-0-13" id="h3-0-13" class="i">+class E2EEImplementation (
</a><a href="#h3-0-14" id="h3-0-14" class="i">+    private val context: RemoteSideContext
</a><a href="#h3-0-15" id="h3-0-15" class="i">+) : E2eeInterface.Stub() {
</a><a href="#h3-0-16" id="h3-0-16" class="i">+    private val kyberDefaultParameters = KyberParameters.kyber1024_aes
</a><a href="#h3-0-17" id="h3-0-17" class="i">+    private val secureRandom = SecureRandom()
</a><a href="#h3-0-18" id="h3-0-18" class="i">+
</a><a href="#h3-0-19" id="h3-0-19" class="i">+    private val e2eeFolder by lazy { File(context.androidContext.filesDir, &quot;e2ee&quot;).also {
</a><a href="#h3-0-20" id="h3-0-20" class="i">+        if (!it.exists()) it.mkdirs()
</a><a href="#h3-0-21" id="h3-0-21" class="i">+    }}
</a><a href="#h3-0-22" id="h3-0-22" class="i">+    private val pairingFolder by lazy { File(context.androidContext.cacheDir, &quot;e2ee-pairing&quot;).also {
</a><a href="#h3-0-23" id="h3-0-23" class="i">+        if (!it.exists()) it.mkdirs()
</a><a href="#h3-0-24" id="h3-0-24" class="i">+    } }
</a><a href="#h3-0-25" id="h3-0-25" class="i">+
</a><a href="#h3-0-26" id="h3-0-26" class="i">+    fun storeSharedSecretKey(friendId: String, key: ByteArray) {
</a><a href="#h3-0-27" id="h3-0-27" class="i">+        File(e2eeFolder, &quot;$friendId.key&quot;).writeBytes(key)
</a><a href="#h3-0-28" id="h3-0-28" class="i">+    }
</a><a href="#h3-0-29" id="h3-0-29" class="i">+
</a><a href="#h3-0-30" id="h3-0-30" class="i">+    fun getSharedSecretKey(friendId: String): ByteArray? {
</a><a href="#h3-0-31" id="h3-0-31" class="i">+        return runCatching {
</a><a href="#h3-0-32" id="h3-0-32" class="i">+            File(e2eeFolder, &quot;$friendId.key&quot;).readBytes()
</a><a href="#h3-0-33" id="h3-0-33" class="i">+        }.onFailure {
</a><a href="#h3-0-34" id="h3-0-34" class="i">+            context.log.error(&quot;Failed to read shared secret key&quot;, it)
</a><a href="#h3-0-35" id="h3-0-35" class="i">+        }.getOrNull()
</a><a href="#h3-0-36" id="h3-0-36" class="i">+    }
</a><a href="#h3-0-37" id="h3-0-37" class="i">+
</a><a href="#h3-0-38" id="h3-0-38" class="i">+    fun deleteSharedSecretKey(friendId: String) {
</a><a href="#h3-0-39" id="h3-0-39" class="i">+        File(e2eeFolder, &quot;$friendId.key&quot;).delete()
</a><a href="#h3-0-40" id="h3-0-40" class="i">+    }
</a><a href="#h3-0-41" id="h3-0-41" class="i">+
</a><a href="#h3-0-42" id="h3-0-42" class="i">+
</a><a href="#h3-0-43" id="h3-0-43" class="i">+    override fun createKeyExchange(friendId: String): ByteArray? {
</a><a href="#h3-0-44" id="h3-0-44" class="i">+        val keyPairGenerator = KyberKeyPairGenerator()
</a><a href="#h3-0-45" id="h3-0-45" class="i">+        keyPairGenerator.init(
</a><a href="#h3-0-46" id="h3-0-46" class="i">+            KyberKeyGenerationParameters(secureRandom, kyberDefaultParameters)
</a><a href="#h3-0-47" id="h3-0-47" class="i">+        )
</a><a href="#h3-0-48" id="h3-0-48" class="i">+        val keyPair = keyPairGenerator.generateKeyPair()
</a><a href="#h3-0-49" id="h3-0-49" class="i">+        val publicKey = keyPair.public as KyberPublicKeyParameters
</a><a href="#h3-0-50" id="h3-0-50" class="i">+        val privateKey = keyPair.private as KyberPrivateKeyParameters
</a><a href="#h3-0-51" id="h3-0-51" class="i">+        runCatching {
</a><a href="#h3-0-52" id="h3-0-52" class="i">+            File(pairingFolder, &quot;$friendId.private&quot;).writeBytes(privateKey.encoded)
</a><a href="#h3-0-53" id="h3-0-53" class="i">+            File(pairingFolder, &quot;$friendId.public&quot;).writeBytes(publicKey.encoded)
</a><a href="#h3-0-54" id="h3-0-54" class="i">+        }.onFailure {
</a><a href="#h3-0-55" id="h3-0-55" class="i">+            context.log.error(&quot;Failed to write private key to file&quot;, it)
</a><a href="#h3-0-56" id="h3-0-56" class="i">+            return null
</a><a href="#h3-0-57" id="h3-0-57" class="i">+        }
</a><a href="#h3-0-58" id="h3-0-58" class="i">+        return publicKey.encoded
</a><a href="#h3-0-59" id="h3-0-59" class="i">+    }
</a><a href="#h3-0-60" id="h3-0-60" class="i">+
</a><a href="#h3-0-61" id="h3-0-61" class="i">+    override fun acceptPairingRequest(friendId: String, publicKey: ByteArray): ByteArray? {
</a><a href="#h3-0-62" id="h3-0-62" class="i">+        val kemGen = KyberKEMGenerator(secureRandom)
</a><a href="#h3-0-63" id="h3-0-63" class="i">+        val encapsulatedSecret =  runCatching {
</a><a href="#h3-0-64" id="h3-0-64" class="i">+            kemGen.generateEncapsulated(
</a><a href="#h3-0-65" id="h3-0-65" class="i">+                KyberPublicKeyParameters(
</a><a href="#h3-0-66" id="h3-0-66" class="i">+                    kyberDefaultParameters,
</a><a href="#h3-0-67" id="h3-0-67" class="i">+                    publicKey
</a><a href="#h3-0-68" id="h3-0-68" class="i">+                )
</a><a href="#h3-0-69" id="h3-0-69" class="i">+            )
</a><a href="#h3-0-70" id="h3-0-70" class="i">+        }.onFailure {
</a><a href="#h3-0-71" id="h3-0-71" class="i">+            context.log.error(&quot;Failed to generate encapsulated secret&quot;, it)
</a><a href="#h3-0-72" id="h3-0-72" class="i">+            return null
</a><a href="#h3-0-73" id="h3-0-73" class="i">+        }.getOrThrow()
</a><a href="#h3-0-74" id="h3-0-74" class="i">+
</a><a href="#h3-0-75" id="h3-0-75" class="i">+        runCatching {
</a><a href="#h3-0-76" id="h3-0-76" class="i">+            storeSharedSecretKey(friendId, encapsulatedSecret.secret)
</a><a href="#h3-0-77" id="h3-0-77" class="i">+        }.onFailure {
</a><a href="#h3-0-78" id="h3-0-78" class="i">+            context.log.error(&quot;Failed to store shared secret key&quot;, it)
</a><a href="#h3-0-79" id="h3-0-79" class="i">+            return null
</a><a href="#h3-0-80" id="h3-0-80" class="i">+        }
</a><a href="#h3-0-81" id="h3-0-81" class="i">+        return encapsulatedSecret.encapsulation
</a><a href="#h3-0-82" id="h3-0-82" class="i">+    }
</a><a href="#h3-0-83" id="h3-0-83" class="i">+
</a><a href="#h3-0-84" id="h3-0-84" class="i">+    override fun acceptPairingResponse(friendId: String, encapsulatedSecret: ByteArray): Boolean {
</a><a href="#h3-0-85" id="h3-0-85" class="i">+        val privateKey = runCatching {
</a><a href="#h3-0-86" id="h3-0-86" class="i">+            val secretKey = File(pairingFolder, &quot;$friendId.private&quot;).readBytes()
</a><a href="#h3-0-87" id="h3-0-87" class="i">+            object: KyberPrivateKeyParameters(kyberDefaultParameters, null, null, null, null, null) {
</a><a href="#h3-0-88" id="h3-0-88" class="i">+                override fun getEncoded() = secretKey
</a><a href="#h3-0-89" id="h3-0-89" class="i">+            }
</a><a href="#h3-0-90" id="h3-0-90" class="i">+        }.onFailure {
</a><a href="#h3-0-91" id="h3-0-91" class="i">+            context.log.error(&quot;Failed to read private key from file&quot;, it)
</a><a href="#h3-0-92" id="h3-0-92" class="i">+            return false
</a><a href="#h3-0-93" id="h3-0-93" class="i">+        }.getOrThrow()
</a><a href="#h3-0-94" id="h3-0-94" class="i">+
</a><a href="#h3-0-95" id="h3-0-95" class="i">+        val kemExtractor = KyberKEMExtractor(privateKey)
</a><a href="#h3-0-96" id="h3-0-96" class="i">+        val sharedSecret = runCatching {
</a><a href="#h3-0-97" id="h3-0-97" class="i">+            kemExtractor.extractSecret(encapsulatedSecret)
</a><a href="#h3-0-98" id="h3-0-98" class="i">+        }.onFailure {
</a><a href="#h3-0-99" id="h3-0-99" class="i">+            context.log.error(&quot;Failed to extract shared secret&quot;, it)
</a><a href="#h3-0-100" id="h3-0-100" class="i">+            return false
</a><a href="#h3-0-101" id="h3-0-101" class="i">+        }.getOrThrow()
</a><a href="#h3-0-102" id="h3-0-102" class="i">+
</a><a href="#h3-0-103" id="h3-0-103" class="i">+        runCatching {
</a><a href="#h3-0-104" id="h3-0-104" class="i">+            storeSharedSecretKey(friendId, sharedSecret)
</a><a href="#h3-0-105" id="h3-0-105" class="i">+        }.onFailure {
</a><a href="#h3-0-106" id="h3-0-106" class="i">+            context.log.error(&quot;Failed to store shared secret key&quot;, it)
</a><a href="#h3-0-107" id="h3-0-107" class="i">+            return false
</a><a href="#h3-0-108" id="h3-0-108" class="i">+        }
</a><a href="#h3-0-109" id="h3-0-109" class="i">+
</a><a href="#h3-0-110" id="h3-0-110" class="i">+        return true
</a><a href="#h3-0-111" id="h3-0-111" class="i">+    }
</a><a href="#h3-0-112" id="h3-0-112" class="i">+
</a><a href="#h3-0-113" id="h3-0-113" class="i">+    override fun friendKeyExists(friendId: String): Boolean {
</a><a href="#h3-0-114" id="h3-0-114" class="i">+        return File(e2eeFolder, &quot;$friendId.key&quot;).exists()
</a><a href="#h3-0-115" id="h3-0-115" class="i">+    }
</a><a href="#h3-0-116" id="h3-0-116" class="i">+
</a><a href="#h3-0-117" id="h3-0-117" class="i">+    override fun encryptMessage(friendId: String, message: ByteArray): EncryptionResult? {
</a><a href="#h3-0-118" id="h3-0-118" class="i">+        val encryptionKey = runCatching {
</a><a href="#h3-0-119" id="h3-0-119" class="i">+            File(e2eeFolder, &quot;$friendId.key&quot;).readBytes()
</a><a href="#h3-0-120" id="h3-0-120" class="i">+        }.onFailure {
</a><a href="#h3-0-121" id="h3-0-121" class="i">+            context.log.error(&quot;Failed to read shared secret key&quot;, it)
</a><a href="#h3-0-122" id="h3-0-122" class="i">+        }.getOrNull()
</a><a href="#h3-0-123" id="h3-0-123" class="i">+
</a><a href="#h3-0-124" id="h3-0-124" class="i">+        return runCatching {
</a><a href="#h3-0-125" id="h3-0-125" class="i">+            val iv = ByteArray(16).apply { secureRandom.nextBytes(this) }
</a><a href="#h3-0-126" id="h3-0-126" class="i">+            val cipher = Cipher.getInstance(&quot;AES/CBC/PKCS5Padding&quot;)
</a><a href="#h3-0-127" id="h3-0-127" class="i">+            cipher.init(Cipher.ENCRYPT_MODE, SecretKeySpec(encryptionKey, &quot;AES&quot;), IvParameterSpec(iv))
</a><a href="#h3-0-128" id="h3-0-128" class="i">+            EncryptionResult().apply {
</a><a href="#h3-0-129" id="h3-0-129" class="i">+                this.iv = iv
</a><a href="#h3-0-130" id="h3-0-130" class="i">+                this.ciphertext = cipher.doFinal(message)
</a><a href="#h3-0-131" id="h3-0-131" class="i">+            }
</a><a href="#h3-0-132" id="h3-0-132" class="i">+        }.onFailure {
</a><a href="#h3-0-133" id="h3-0-133" class="i">+            context.log.error(&quot;Failed to encrypt message for $friendId&quot;, it)
</a><a href="#h3-0-134" id="h3-0-134" class="i">+        }.getOrNull()
</a><a href="#h3-0-135" id="h3-0-135" class="i">+    }
</a><a href="#h3-0-136" id="h3-0-136" class="i">+
</a><a href="#h3-0-137" id="h3-0-137" class="i">+    override fun decryptMessage(friendId: String, message: ByteArray, iv: ByteArray): ByteArray? {
</a><a href="#h3-0-138" id="h3-0-138" class="i">+        val encryptionKey = runCatching {
</a><a href="#h3-0-139" id="h3-0-139" class="i">+            File(e2eeFolder, &quot;$friendId.key&quot;).readBytes()
</a><a href="#h3-0-140" id="h3-0-140" class="i">+        }.onFailure {
</a><a href="#h3-0-141" id="h3-0-141" class="i">+            context.log.error(&quot;Failed to read shared secret key&quot;, it)
</a><a href="#h3-0-142" id="h3-0-142" class="i">+            return null
</a><a href="#h3-0-143" id="h3-0-143" class="i">+        }.getOrNull()
</a><a href="#h3-0-144" id="h3-0-144" class="i">+
</a><a href="#h3-0-145" id="h3-0-145" class="i">+        return runCatching {
</a><a href="#h3-0-146" id="h3-0-146" class="i">+            val cipher = Cipher.getInstance(&quot;AES/CBC/PKCS5Padding&quot;)
</a><a href="#h3-0-147" id="h3-0-147" class="i">+            cipher.init(Cipher.DECRYPT_MODE, SecretKeySpec(encryptionKey, &quot;AES&quot;), IvParameterSpec(iv))
</a><a href="#h3-0-148" id="h3-0-148" class="i">+            cipher.doFinal(message)
</a><a href="#h3-0-149" id="h3-0-149" class="i">+        }.onFailure {
</a><a href="#h3-0-150" id="h3-0-150" class="i">+            context.log.error(&quot;Failed to decrypt message from $friendId&quot;, it)
</a><a href="#h3-0-151" id="h3-0-151" class="i">+            return null
</a><a href="#h3-0-152" id="h3-0-152" class="i">+        }.getOrNull()
</a><a href="#h3-0-153" id="h3-0-153" class="i">+    }
</a><a href="#h3-0-154" id="h3-0-154" class="i">+}</a><a href="#h3-0-155" id="h3-0-155" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h4" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/messaging/ModDatabase.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/messaging/ModDatabase.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/messaging/ModDatabase.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/messaging/ModDatabase.kt</a></b>
<a href="#h4-0" id="h4-0" class="h">@@ -158,7 +158,11 @@ class ModDatabase(
</a>         )).use { cursor -&gt;
             val rules = mutableListOf&lt;MessagingRuleType&gt;()
             while (cursor.moveToNext()) {
<a href="#h4-0-3" id="h4-0-3" class="d">-                rules.add(MessagingRuleType.getByName(cursor.getStringOrNull(&quot;type&quot;)!!))
</a><a href="#h4-0-4" id="h4-0-4" class="i">+                runCatching {
</a><a href="#h4-0-5" id="h4-0-5" class="i">+                    rules.add(MessagingRuleType.getByName(cursor.getStringOrNull(&quot;type&quot;)!!))
</a><a href="#h4-0-6" id="h4-0-6" class="i">+                }.onFailure {
</a><a href="#h4-0-7" id="h4-0-7" class="i">+                    context.log.error(&quot;Failed to parse rule&quot;, it)
</a><a href="#h4-0-8" id="h4-0-8" class="i">+                }
</a>             }
             rules
         }
<a href="#h4-1" id="h4-1" class="h">@@ -197,12 +201,14 @@ class ModDatabase(
</a>         executeAsync {
             database.execSQL(&quot;DELETE FROM friends WHERE userId = ?&quot;, arrayOf(userId))
             database.execSQL(&quot;DELETE FROM streaks WHERE userId = ?&quot;, arrayOf(userId))
<a href="#h4-1-3" id="h4-1-3" class="i">+            database.execSQL(&quot;DELETE FROM rules WHERE targetUuid = ?&quot;, arrayOf(userId))
</a>         }
     }
 
     fun deleteGroup(conversationId: String) {
         executeAsync {
             database.execSQL(&quot;DELETE FROM groups WHERE conversationId = ?&quot;, arrayOf(conversationId))
<a href="#h4-1-10" id="h4-1-10" class="i">+            database.execSQL(&quot;DELETE FROM rules WHERE targetUuid = ?&quot;, arrayOf(conversationId))
</a>         }
     }
 
<b>diff --git a/<a id="h5" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/social/ScopeContent.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/social/ScopeContent.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/social/ScopeContent.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/social/ScopeContent.kt</a></b>
<a href="#h5-0" id="h5-0" class="h">@@ -1,12 +1,7 @@
</a> package me.rhunk.snapenhance.ui.manager.sections.social
 
<a href="#h5-0-2" id="h5-0-2" class="d">-import androidx.compose.foundation.layout.Column
</a><a href="#h5-0-3" id="h5-0-3" class="d">-import androidx.compose.foundation.layout.Row
</a><a href="#h5-0-4" id="h5-0-4" class="d">-import androidx.compose.foundation.layout.Spacer
</a><a href="#h5-0-5" id="h5-0-5" class="d">-import androidx.compose.foundation.layout.fillMaxWidth
</a><a href="#h5-0-6" id="h5-0-6" class="d">-import androidx.compose.foundation.layout.height
</a><a href="#h5-0-7" id="h5-0-7" class="d">-import androidx.compose.foundation.layout.offset
</a><a href="#h5-0-8" id="h5-0-8" class="d">-import androidx.compose.foundation.layout.padding
</a><a href="#h5-0-9" id="h5-0-9" class="i">+import android.content.Intent
</a><a href="#h5-0-10" id="h5-0-10" class="i">+import androidx.compose.foundation.layout.*
</a> import androidx.compose.foundation.rememberScrollState
 import androidx.compose.foundation.verticalScroll
 import androidx.compose.material3.Card
<a href="#h5-1" id="h5-1" class="h">@@ -32,6 +27,10 @@ import me.rhunk.snapenhance.core.messaging.MessagingRuleType
</a> import me.rhunk.snapenhance.core.messaging.SocialScope
 import me.rhunk.snapenhance.ui.util.BitmojiImage
 import me.rhunk.snapenhance.core.util.snap.BitmojiSelfie
<a href="#h5-1-3" id="h5-1-3" class="i">+import me.rhunk.snapenhance.ui.util.AlertDialogs
</a><a href="#h5-1-4" id="h5-1-4" class="i">+import me.rhunk.snapenhance.ui.util.Dialog
</a><a href="#h5-1-5" id="h5-1-5" class="i">+import kotlin.io.encoding.Base64
</a><a href="#h5-1-6" id="h5-1-6" class="i">+import kotlin.io.encoding.ExperimentalEncodingApi
</a> 
 class ScopeContent(
     private val context: RemoteSideContext,
<a href="#h5-2" id="h5-2" class="h">@@ -40,6 +39,7 @@ class ScopeContent(
</a>     val scope: SocialScope,
     private val id: String
 ) {
<a href="#h5-2-3" id="h5-2-3" class="i">+    private val dialogs by lazy { AlertDialogs(context.translation) }
</a>     private val translation by lazy { context.translation.getCategory(&quot;manager.sections.social&quot;) }
 
     fun deleteScope(coroutineScope: CoroutineScope) {
<a href="#h5-3" id="h5-3" class="h">@@ -162,6 +162,7 @@ class ScopeContent(
</a>         return &quot;Expired&quot;
     }
 
<a href="#h5-3-3" id="h5-3-3" class="i">+    @OptIn(ExperimentalEncodingApi::class)
</a>     @Composable
     private fun Friend() {
         //fetch the friend from the database
<a href="#h5-4" id="h5-4" class="h">@@ -241,6 +242,73 @@ class ScopeContent(
</a>                     }
                 }
             }
<a href="#h5-4-3" id="h5-4-3" class="i">+            // e2ee section
</a><a href="#h5-4-4" id="h5-4-4" class="i">+
</a><a href="#h5-4-5" id="h5-4-5" class="i">+            SectionTitle(translation[&quot;e2ee_title&quot;])
</a><a href="#h5-4-6" id="h5-4-6" class="i">+            var hasSecretKey by remember { mutableStateOf(context.e2eeImplementation.friendKeyExists(friend.userId))}
</a><a href="#h5-4-7" id="h5-4-7" class="i">+            var importDialog by remember { mutableStateOf(false) }
</a><a href="#h5-4-8" id="h5-4-8" class="i">+
</a><a href="#h5-4-9" id="h5-4-9" class="i">+            if (importDialog) {
</a><a href="#h5-4-10" id="h5-4-10" class="i">+                Dialog(
</a><a href="#h5-4-11" id="h5-4-11" class="i">+                    onDismissRequest = { importDialog = false }
</a><a href="#h5-4-12" id="h5-4-12" class="i">+                ) {
</a><a href="#h5-4-13" id="h5-4-13" class="i">+                    dialogs.RawInputDialog(onDismiss = { importDialog = false  }, onConfirm = { newKey -&gt;
</a><a href="#h5-4-14" id="h5-4-14" class="i">+                        importDialog = false
</a><a href="#h5-4-15" id="h5-4-15" class="i">+                        runCatching {
</a><a href="#h5-4-16" id="h5-4-16" class="i">+                            val key = Base64.decode(newKey)
</a><a href="#h5-4-17" id="h5-4-17" class="i">+                            if (key.size != 32) {
</a><a href="#h5-4-18" id="h5-4-18" class="i">+                                context.longToast(&quot;Invalid key size (must be 32 bytes)&quot;)
</a><a href="#h5-4-19" id="h5-4-19" class="i">+                                return@runCatching
</a><a href="#h5-4-20" id="h5-4-20" class="i">+                            }
</a><a href="#h5-4-21" id="h5-4-21" class="i">+
</a><a href="#h5-4-22" id="h5-4-22" class="i">+                            context.e2eeImplementation.storeSharedSecretKey(friend.userId, key)
</a><a href="#h5-4-23" id="h5-4-23" class="i">+                            context.longToast(&quot;Successfully imported key&quot;)
</a><a href="#h5-4-24" id="h5-4-24" class="i">+                            hasSecretKey = true
</a><a href="#h5-4-25" id="h5-4-25" class="i">+                        }.onFailure {
</a><a href="#h5-4-26" id="h5-4-26" class="i">+                            context.longToast(&quot;Failed to import key: ${it.message}&quot;)
</a><a href="#h5-4-27" id="h5-4-27" class="i">+                            context.log.error(&quot;Failed to import key&quot;, it)
</a><a href="#h5-4-28" id="h5-4-28" class="i">+                        }
</a><a href="#h5-4-29" id="h5-4-29" class="i">+                    })
</a><a href="#h5-4-30" id="h5-4-30" class="i">+                }
</a><a href="#h5-4-31" id="h5-4-31" class="i">+            }
</a><a href="#h5-4-32" id="h5-4-32" class="i">+
</a><a href="#h5-4-33" id="h5-4-33" class="i">+            ContentCard {
</a><a href="#h5-4-34" id="h5-4-34" class="i">+                Row(
</a><a href="#h5-4-35" id="h5-4-35" class="i">+                    verticalAlignment = Alignment.CenterVertically,
</a><a href="#h5-4-36" id="h5-4-36" class="i">+                    horizontalArrangement = Arrangement.spacedBy(10.dp)
</a><a href="#h5-4-37" id="h5-4-37" class="i">+                ) {
</a><a href="#h5-4-38" id="h5-4-38" class="i">+                    if (hasSecretKey) {
</a><a href="#h5-4-39" id="h5-4-39" class="i">+                        OutlinedButton(onClick = {
</a><a href="#h5-4-40" id="h5-4-40" class="i">+                            val secretKey = Base64.encode(context.e2eeImplementation.getSharedSecretKey(friend.userId) ?: return@OutlinedButton)
</a><a href="#h5-4-41" id="h5-4-41" class="i">+                            //TODO: fingerprint auth
</a><a href="#h5-4-42" id="h5-4-42" class="i">+                            context.activity!!.startActivity(Intent.createChooser(Intent().apply {
</a><a href="#h5-4-43" id="h5-4-43" class="i">+                                action = Intent.ACTION_SEND
</a><a href="#h5-4-44" id="h5-4-44" class="i">+                                putExtra(Intent.EXTRA_TEXT, secretKey)
</a><a href="#h5-4-45" id="h5-4-45" class="i">+                                type = &quot;text/plain&quot;
</a><a href="#h5-4-46" id="h5-4-46" class="i">+                            }, &quot;&quot;).apply {
</a><a href="#h5-4-47" id="h5-4-47" class="i">+                                putExtra(Intent.EXTRA_INITIAL_INTENTS, arrayOf(
</a><a href="#h5-4-48" id="h5-4-48" class="i">+                                    Intent().apply {
</a><a href="#h5-4-49" id="h5-4-49" class="i">+                                        putExtra(Intent.EXTRA_TEXT, secretKey)
</a><a href="#h5-4-50" id="h5-4-50" class="i">+                                        putExtra(Intent.EXTRA_SUBJECT, secretKey)
</a><a href="#h5-4-51" id="h5-4-51" class="i">+                                    })
</a><a href="#h5-4-52" id="h5-4-52" class="i">+                                )
</a><a href="#h5-4-53" id="h5-4-53" class="i">+                            })
</a><a href="#h5-4-54" id="h5-4-54" class="i">+                        }) {
</a><a href="#h5-4-55" id="h5-4-55" class="i">+                            Text(
</a><a href="#h5-4-56" id="h5-4-56" class="i">+                                text = &quot;Export Base64&quot;,
</a><a href="#h5-4-57" id="h5-4-57" class="i">+                                maxLines = 1
</a><a href="#h5-4-58" id="h5-4-58" class="i">+                            )
</a><a href="#h5-4-59" id="h5-4-59" class="i">+                        }
</a><a href="#h5-4-60" id="h5-4-60" class="i">+                    }
</a><a href="#h5-4-61" id="h5-4-61" class="i">+
</a><a href="#h5-4-62" id="h5-4-62" class="i">+                    OutlinedButton(onClick = { importDialog = true }) {
</a><a href="#h5-4-63" id="h5-4-63" class="i">+                        Text(
</a><a href="#h5-4-64" id="h5-4-64" class="i">+                            text = &quot;Import Base64&quot;,
</a><a href="#h5-4-65" id="h5-4-65" class="i">+                            maxLines = 1
</a><a href="#h5-4-66" id="h5-4-66" class="i">+                        )
</a><a href="#h5-4-67" id="h5-4-67" class="i">+                    }
</a><a href="#h5-4-68" id="h5-4-68" class="i">+                }
</a><a href="#h5-4-69" id="h5-4-69" class="i">+            }
</a>         }
     }
 
<b>diff --git a/<a id="h6" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/util/AlertDialogs.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/util/AlertDialogs.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/util/AlertDialogs.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/util/AlertDialogs.kt</a></b>
<a href="#h6-0" id="h6-0" class="h">@@ -239,6 +239,46 @@ class AlertDialogs(
</a>     }
 
     @Composable
<a href="#h6-0-3" id="h6-0-3" class="i">+    fun RawInputDialog(onDismiss: () -&gt; Unit, onConfirm: (value: String) -&gt; Unit) {
</a><a href="#h6-0-4" id="h6-0-4" class="i">+        val focusRequester = remember { FocusRequester() }
</a><a href="#h6-0-5" id="h6-0-5" class="i">+
</a><a href="#h6-0-6" id="h6-0-6" class="i">+        DefaultDialogCard {
</a><a href="#h6-0-7" id="h6-0-7" class="i">+            val fieldValue = remember {
</a><a href="#h6-0-8" id="h6-0-8" class="i">+                mutableStateOf(TextFieldValue())
</a><a href="#h6-0-9" id="h6-0-9" class="i">+            }
</a><a href="#h6-0-10" id="h6-0-10" class="i">+
</a><a href="#h6-0-11" id="h6-0-11" class="i">+            TextField(
</a><a href="#h6-0-12" id="h6-0-12" class="i">+                modifier = Modifier
</a><a href="#h6-0-13" id="h6-0-13" class="i">+                    .fillMaxWidth()
</a><a href="#h6-0-14" id="h6-0-14" class="i">+                    .padding(all = 10.dp)
</a><a href="#h6-0-15" id="h6-0-15" class="i">+                    .onGloballyPositioned {
</a><a href="#h6-0-16" id="h6-0-16" class="i">+                        focusRequester.requestFocus()
</a><a href="#h6-0-17" id="h6-0-17" class="i">+                    }
</a><a href="#h6-0-18" id="h6-0-18" class="i">+                    .focusRequester(focusRequester),
</a><a href="#h6-0-19" id="h6-0-19" class="i">+                value = fieldValue.value,
</a><a href="#h6-0-20" id="h6-0-20" class="i">+                onValueChange = {
</a><a href="#h6-0-21" id="h6-0-21" class="i">+                    fieldValue.value = it
</a><a href="#h6-0-22" id="h6-0-22" class="i">+                },
</a><a href="#h6-0-23" id="h6-0-23" class="i">+                singleLine = true
</a><a href="#h6-0-24" id="h6-0-24" class="i">+            )
</a><a href="#h6-0-25" id="h6-0-25" class="i">+
</a><a href="#h6-0-26" id="h6-0-26" class="i">+            Row(
</a><a href="#h6-0-27" id="h6-0-27" class="i">+                modifier = Modifier.padding(top = 10.dp).fillMaxWidth(),
</a><a href="#h6-0-28" id="h6-0-28" class="i">+                horizontalArrangement = Arrangement.SpaceEvenly,
</a><a href="#h6-0-29" id="h6-0-29" class="i">+            ) {
</a><a href="#h6-0-30" id="h6-0-30" class="i">+                Button(onClick = { onDismiss() }) {
</a><a href="#h6-0-31" id="h6-0-31" class="i">+                    Text(text = translation[&quot;button.cancel&quot;])
</a><a href="#h6-0-32" id="h6-0-32" class="i">+                }
</a><a href="#h6-0-33" id="h6-0-33" class="i">+                Button(onClick = {
</a><a href="#h6-0-34" id="h6-0-34" class="i">+                    onConfirm(fieldValue.value.text)
</a><a href="#h6-0-35" id="h6-0-35" class="i">+                }) {
</a><a href="#h6-0-36" id="h6-0-36" class="i">+                    Text(text = translation[&quot;button.ok&quot;])
</a><a href="#h6-0-37" id="h6-0-37" class="i">+                }
</a><a href="#h6-0-38" id="h6-0-38" class="i">+            }
</a><a href="#h6-0-39" id="h6-0-39" class="i">+        }
</a><a href="#h6-0-40" id="h6-0-40" class="i">+    }
</a><a href="#h6-0-41" id="h6-0-41" class="i">+
</a><a href="#h6-0-42" id="h6-0-42" class="i">+    @Composable
</a>     @Suppress(&quot;UNCHECKED_CAST&quot;)
     fun MultipleSelectionDialog(property: PropertyPair&lt;*&gt;) {
         val defaultItems = property.value.defaultValues as List&lt;String&gt;
<b>diff --git a/<a id="h7" href="../file/core/src/main/aidl/me/rhunk/snapenhance/bridge/BridgeInterface.aidl.html">core/src/main/aidl/me/rhunk/snapenhance/bridge/BridgeInterface.aidl</a> b/<a href="../file/core/src/main/aidl/me/rhunk/snapenhance/bridge/BridgeInterface.aidl.html">core/src/main/aidl/me/rhunk/snapenhance/bridge/BridgeInterface.aidl</a></b>
<a href="#h7-0" id="h7-0" class="h">@@ -4,6 +4,7 @@ import java.util.List;
</a> import me.rhunk.snapenhance.bridge.DownloadCallback;
 import me.rhunk.snapenhance.bridge.SyncCallback;
 import me.rhunk.snapenhance.bridge.scripting.IScripting;
<a href="#h7-0-3" id="h7-0-3" class="i">+import me.rhunk.snapenhance.bridge.e2ee.E2eeInterface;
</a> 
 interface BridgeInterface {
     /**
<a href="#h7-1" id="h7-1" class="h">@@ -94,6 +95,8 @@ interface BridgeInterface {
</a> 
     IScripting getScriptingInterface();
 
<a href="#h7-1-3" id="h7-1-3" class="i">+    E2eeInterface getE2eeInterface();
</a><a href="#h7-1-4" id="h7-1-4" class="i">+
</a>     void openSettingsOverlay();
 
     void closeSettingsOverlay();
<b>diff --git a/<a id="h8" href="../file/core/src/main/aidl/me/rhunk/snapenhance/bridge/e2ee/E2eeInterface.aidl.html">core/src/main/aidl/me/rhunk/snapenhance/bridge/e2ee/E2eeInterface.aidl</a> b/<a href="../file/core/src/main/aidl/me/rhunk/snapenhance/bridge/e2ee/E2eeInterface.aidl.html">core/src/main/aidl/me/rhunk/snapenhance/bridge/e2ee/E2eeInterface.aidl</a></b>
<a href="#h8-0" id="h8-0" class="h">@@ -0,0 +1,34 @@
</a><a href="#h8-0-0" id="h8-0-0" class="i">+package me.rhunk.snapenhance.bridge.e2ee;
</a><a href="#h8-0-1" id="h8-0-1" class="i">+
</a><a href="#h8-0-2" id="h8-0-2" class="i">+import me.rhunk.snapenhance.bridge.e2ee.EncryptionResult;
</a><a href="#h8-0-3" id="h8-0-3" class="i">+
</a><a href="#h8-0-4" id="h8-0-4" class="i">+interface E2eeInterface {
</a><a href="#h8-0-5" id="h8-0-5" class="i">+    /**
</a><a href="#h8-0-6" id="h8-0-6" class="i">+    * Start a new pairing process with a friend
</a><a href="#h8-0-7" id="h8-0-7" class="i">+    * @param friendId
</a><a href="#h8-0-8" id="h8-0-8" class="i">+    * @return the pairing public key
</a><a href="#h8-0-9" id="h8-0-9" class="i">+    */
</a><a href="#h8-0-10" id="h8-0-10" class="i">+   @nullable byte[] createKeyExchange(String friendId);
</a><a href="#h8-0-11" id="h8-0-11" class="i">+
</a><a href="#h8-0-12" id="h8-0-12" class="i">+    /**
</a><a href="#h8-0-13" id="h8-0-13" class="i">+    * Accept a pairing request from a friend
</a><a href="#h8-0-14" id="h8-0-14" class="i">+    * @param friendId
</a><a href="#h8-0-15" id="h8-0-15" class="i">+    * @param publicKey the public key received from the friend
</a><a href="#h8-0-16" id="h8-0-16" class="i">+    * @return the encapsulated secret to send to the friend
</a><a href="#h8-0-17" id="h8-0-17" class="i">+    */
</a><a href="#h8-0-18" id="h8-0-18" class="i">+    @nullable byte[] acceptPairingRequest(String friendId, in byte[] publicKey);
</a><a href="#h8-0-19" id="h8-0-19" class="i">+
</a><a href="#h8-0-20" id="h8-0-20" class="i">+    /**
</a><a href="#h8-0-21" id="h8-0-21" class="i">+     * Accept a pairing response from a friend
</a><a href="#h8-0-22" id="h8-0-22" class="i">+     * @param friendId
</a><a href="#h8-0-23" id="h8-0-23" class="i">+     * @param encapsulatedSecret the encapsulated secret received from the friend
</a><a href="#h8-0-24" id="h8-0-24" class="i">+     * @return true if the pairing was successful
</a><a href="#h8-0-25" id="h8-0-25" class="i">+    */
</a><a href="#h8-0-26" id="h8-0-26" class="i">+    boolean acceptPairingResponse(String friendId, in byte[] encapsulatedSecret);
</a><a href="#h8-0-27" id="h8-0-27" class="i">+
</a><a href="#h8-0-28" id="h8-0-28" class="i">+    boolean friendKeyExists(String friendId);
</a><a href="#h8-0-29" id="h8-0-29" class="i">+
</a><a href="#h8-0-30" id="h8-0-30" class="i">+    @nullable EncryptionResult encryptMessage(String friendId, in byte[] message);
</a><a href="#h8-0-31" id="h8-0-31" class="i">+
</a><a href="#h8-0-32" id="h8-0-32" class="i">+    @nullable byte[] decryptMessage(String friendId, in byte[] message, in byte[] iv);
</a><a href="#h8-0-33" id="h8-0-33" class="i">+}</a><a href="#h8-0-34" id="h8-0-34" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h9" href="../file/core/src/main/aidl/me/rhunk/snapenhance/bridge/e2ee/EncryptionResult.aidl.html">core/src/main/aidl/me/rhunk/snapenhance/bridge/e2ee/EncryptionResult.aidl</a> b/<a href="../file/core/src/main/aidl/me/rhunk/snapenhance/bridge/e2ee/EncryptionResult.aidl.html">core/src/main/aidl/me/rhunk/snapenhance/bridge/e2ee/EncryptionResult.aidl</a></b>
<a href="#h9-0" id="h9-0" class="h">@@ -0,0 +1,6 @@
</a><a href="#h9-0-0" id="h9-0-0" class="i">+package me.rhunk.snapenhance.bridge.e2ee;
</a><a href="#h9-0-1" id="h9-0-1" class="i">+
</a><a href="#h9-0-2" id="h9-0-2" class="i">+parcelable EncryptionResult {
</a><a href="#h9-0-3" id="h9-0-3" class="i">+    byte[] ciphertext;
</a><a href="#h9-0-4" id="h9-0-4" class="i">+    byte[] iv;
</a><a href="#h9-0-5" id="h9-0-5" class="i">+}</a><a href="#h9-0-6" id="h9-0-6" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h10" href="../file/core/src/main/assets/lang/en_US.json.html">core/src/main/assets/lang/en_US.json</a> b/<a href="../file/core/src/main/assets/lang/en_US.json.html">core/src/main/assets/lang/en_US.json</a></b>
<a href="#h10-0" id="h10-0" class="h">@@ -44,6 +44,7 @@
</a>                 &quot;disabled&quot;: &quot;Disabled&quot;
             },
             &quot;social&quot;: {
<a href="#h10-0-3" id="h10-0-3" class="i">+                &quot;e2ee_title&quot;: &quot;End-to-End Encryption&quot;,
</a>                 &quot;rules_title&quot;: &quot;Rules&quot;,
                 &quot;participants_text&quot;: &quot;{count} participants&quot;,
                 &quot;not_found&quot;: &quot;Not found&quot;,
<a href="#h10-1" id="h10-1" class="h">@@ -98,8 +99,8 @@
</a>             &quot;hide_chat_feed&quot;: {
                 &quot;name&quot;: &quot;Hide from Chat feed&quot;
             },
<a href="#h10-1-3" id="h10-1-3" class="d">-            &quot;aes_encryption&quot;: {
</a><a href="#h10-1-4" id="h10-1-4" class="d">-                &quot;name&quot;: &quot;Use AES Encryption&quot;
</a><a href="#h10-1-5" id="h10-1-5" class="i">+            &quot;e2e_encryption&quot;: {
</a><a href="#h10-1-6" id="h10-1-6" class="i">+                &quot;name&quot;: &quot;Use E2E Encryption&quot;
</a>             },
             &quot;pin_conversation&quot;: {
                 &quot;name&quot;: &quot;Pin Conversation&quot;
<a href="#h10-2" id="h10-2" class="h">@@ -519,9 +520,9 @@
</a>                         &quot;name&quot;: &quot;No Friend Score Delay&quot;,
                         &quot;description&quot;: &quot;Removes the delay when viewing a Friends Score&quot;
                     },
<a href="#h10-2-3" id="h10-2-3" class="d">-                    &quot;use_message_aes_encryption&quot;: {
</a><a href="#h10-2-4" id="h10-2-4" class="d">-                        &quot;name&quot;: &quot;Use AES Encryption&quot;,
</a><a href="#h10-2-5" id="h10-2-5" class="d">-                        &quot;description&quot;: &quot;Encrypts your messages using AES\nMessages are only readable by other SnapEnhance users&quot;
</a><a href="#h10-2-6" id="h10-2-6" class="i">+                    &quot;e2e_encryption&quot;: {
</a><a href="#h10-2-7" id="h10-2-7" class="i">+                        &quot;name&quot;: &quot;End-To-End Encryption&quot;,
</a><a href="#h10-2-8" id="h10-2-8" class="i">+                        &quot;description&quot;: &quot;Encrypts your messages with AES using a shared secret key\nMake sure to save your key somewhere safe!&quot;
</a>                     },
                     &quot;add_friend_source_spoof&quot;: {
                         &quot;name&quot;: &quot;Add Friend Source Spoof&quot;,
<a href="#h10-3" id="h10-3" class="h">@@ -565,7 +566,7 @@
</a>                 &quot;auto_save&quot;: &quot;\uD83D\uDCAC Auto Save Messages&quot;,
                 &quot;stealth&quot;: &quot;\uD83D\uDC7B Stealth Mode&quot;,
                 &quot;conversation_info&quot;: &quot;\uD83D\uDC64 Conversation Info&quot;,
<a href="#h10-3-3" id="h10-3-3" class="d">-                &quot;aes_encryption&quot;: &quot;\uD83D\uDD12 Use AES Encryption&quot;
</a><a href="#h10-3-4" id="h10-3-4" class="i">+                &quot;e2e_encryption&quot;: &quot;\uD83D\uDD12 Use E2E Encryption&quot;
</a>             },
             &quot;path_format&quot;: {
                 &quot;create_author_folder&quot;: &quot;Create folder for each author&quot;,
<b>diff --git a/<a id="h11" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/BridgeClient.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/BridgeClient.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/BridgeClient.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/bridge/BridgeClient.kt</a></b>
<a href="#h11-0" id="h11-0" class="h">@@ -14,6 +14,7 @@ import me.rhunk.snapenhance.ModContext
</a> import me.rhunk.snapenhance.bridge.BridgeInterface
 import me.rhunk.snapenhance.bridge.DownloadCallback
 import me.rhunk.snapenhance.bridge.SyncCallback
<a href="#h11-0-3" id="h11-0-3" class="i">+import me.rhunk.snapenhance.bridge.e2ee.E2eeInterface
</a> import me.rhunk.snapenhance.bridge.scripting.IScripting
 import me.rhunk.snapenhance.core.BuildConfig
 import me.rhunk.snapenhance.core.bridge.types.BridgeFileType
<a href="#h11-1" id="h11-1" class="h">@@ -145,6 +146,8 @@ class BridgeClient(
</a> 
     fun getScriptingInterface(): IScripting = service.getScriptingInterface()
 
<a href="#h11-1-3" id="h11-1-3" class="i">+    fun getE2eeInterface(): E2eeInterface = service.getE2eeInterface()
</a><a href="#h11-1-4" id="h11-1-4" class="i">+
</a>     fun openSettingsOverlay() = service.openSettingsOverlay()
     fun closeSettingsOverlay() = service.closeSettingsOverlay()
 }
<b>diff --git a/<a id="h12" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/Experimental.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/Experimental.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/Experimental.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/Experimental.kt</a></b>
<a href="#h12-0" id="h12-0" class="h">@@ -12,7 +12,7 @@ class Experimental : ConfigContainer() {
</a>     val meoPasscodeBypass = boolean(&quot;meo_passcode_bypass&quot;)
     val unlimitedMultiSnap = boolean(&quot;unlimited_multi_snap&quot;) { addNotices(FeatureNotice.BAN_RISK)}
     val noFriendScoreDelay = boolean(&quot;no_friend_score_delay&quot;)
<a href="#h12-0-3" id="h12-0-3" class="d">-    val useMessageAESEncryption = boolean(&quot;use_message_aes_encryption&quot;)
</a><a href="#h12-0-4" id="h12-0-4" class="i">+    val useE2EEncryption = boolean(&quot;e2e_encryption&quot;)
</a>     val hiddenSnapchatPlusFeatures = boolean(&quot;hidden_snapchat_plus_features&quot;) { addNotices(FeatureNotice.BAN_RISK, FeatureNotice.UNSTABLE) }
     val addFriendSourceSpoof = unique(&quot;add_friend_source_spoof&quot;,
         &quot;added_by_username&quot;,
<b>diff --git a/<a id="h13" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/event/EventDispatcher.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/event/EventDispatcher.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/event/EventDispatcher.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/event/EventDispatcher.kt</a></b>
<a href="#h13-0" id="h13-0" class="h">@@ -5,11 +5,7 @@ import android.view.View
</a> import android.view.ViewGroup
 import android.view.ViewGroup.LayoutParams
 import me.rhunk.snapenhance.ModContext
<a href="#h13-0-3" id="h13-0-3" class="d">-import me.rhunk.snapenhance.core.event.events.impl.AddViewEvent
</a><a href="#h13-0-4" id="h13-0-4" class="d">-import me.rhunk.snapenhance.core.event.events.impl.NetworkApiRequestEvent
</a><a href="#h13-0-5" id="h13-0-5" class="d">-import me.rhunk.snapenhance.core.event.events.impl.OnSnapInteractionEvent
</a><a href="#h13-0-6" id="h13-0-6" class="d">-import me.rhunk.snapenhance.core.event.events.impl.SendMessageWithContentEvent
</a><a href="#h13-0-7" id="h13-0-7" class="d">-import me.rhunk.snapenhance.core.event.events.impl.SnapWidgetBroadcastReceiveEvent
</a><a href="#h13-0-8" id="h13-0-8" class="i">+import me.rhunk.snapenhance.core.event.events.impl.*
</a> import me.rhunk.snapenhance.core.util.ktx.getObjectField
 import me.rhunk.snapenhance.core.util.ktx.setObjectField
 import me.rhunk.snapenhance.core.util.snap.SnapWidgetBroadcastReceiverHelper
<a href="#h13-1" id="h13-1" class="h">@@ -18,11 +14,48 @@ import me.rhunk.snapenhance.data.wrapper.impl.MessageDestinations
</a> import me.rhunk.snapenhance.data.wrapper.impl.SnapUUID
 import me.rhunk.snapenhance.hook.HookStage
 import me.rhunk.snapenhance.hook.hook
<a href="#h13-1-3" id="h13-1-3" class="i">+import me.rhunk.snapenhance.hook.hookConstructor
</a> import me.rhunk.snapenhance.manager.Manager
 
 class EventDispatcher(
     private val context: ModContext
 ) : Manager {
<a href="#h13-1-9" id="h13-1-9" class="i">+    private fun findClass(name: String) = context.androidContext.classLoader.loadClass(name)
</a><a href="#h13-1-10" id="h13-1-10" class="i">+
</a><a href="#h13-1-11" id="h13-1-11" class="i">+    private fun hookViewBinder() {
</a><a href="#h13-1-12" id="h13-1-12" class="i">+        val cachedHooks = mutableListOf&lt;String&gt;()
</a><a href="#h13-1-13" id="h13-1-13" class="i">+        val viewBinderMappings = runCatching { context.mappings.getMappedMap(&quot;ViewBinder&quot;) }.getOrNull() ?: return
</a><a href="#h13-1-14" id="h13-1-14" class="i">+
</a><a href="#h13-1-15" id="h13-1-15" class="i">+        fun cacheHook(clazz: Class&lt;*&gt;, block: Class&lt;*&gt;.() -&gt; Unit) {
</a><a href="#h13-1-16" id="h13-1-16" class="i">+            if (!cachedHooks.contains(clazz.name)) {
</a><a href="#h13-1-17" id="h13-1-17" class="i">+                clazz.block()
</a><a href="#h13-1-18" id="h13-1-18" class="i">+                cachedHooks.add(clazz.name)
</a><a href="#h13-1-19" id="h13-1-19" class="i">+            }
</a><a href="#h13-1-20" id="h13-1-20" class="i">+        }
</a><a href="#h13-1-21" id="h13-1-21" class="i">+
</a><a href="#h13-1-22" id="h13-1-22" class="i">+        findClass(viewBinderMappings[&quot;class&quot;].toString()).hookConstructor(HookStage.AFTER) { methodParam -&gt;
</a><a href="#h13-1-23" id="h13-1-23" class="i">+            cacheHook(
</a><a href="#h13-1-24" id="h13-1-24" class="i">+                methodParam.thisObject&lt;Any&gt;()::class.java
</a><a href="#h13-1-25" id="h13-1-25" class="i">+            ) {
</a><a href="#h13-1-26" id="h13-1-26" class="i">+                hook(viewBinderMappings[&quot;bindMethod&quot;].toString(), HookStage.AFTER) bindViewMethod@{ param -&gt;
</a><a href="#h13-1-27" id="h13-1-27" class="i">+                    val instance = param.thisObject&lt;Any&gt;()
</a><a href="#h13-1-28" id="h13-1-28" class="i">+                    val view = instance::class.java.methods.first {
</a><a href="#h13-1-29" id="h13-1-29" class="i">+                        it.name == viewBinderMappings[&quot;getViewMethod&quot;].toString()
</a><a href="#h13-1-30" id="h13-1-30" class="i">+                    }.invoke(instance) as? View ?: return@bindViewMethod
</a><a href="#h13-1-31" id="h13-1-31" class="i">+
</a><a href="#h13-1-32" id="h13-1-32" class="i">+                    context.event.post(
</a><a href="#h13-1-33" id="h13-1-33" class="i">+                        BindViewEvent(
</a><a href="#h13-1-34" id="h13-1-34" class="i">+                            prevModel = param.arg(0),
</a><a href="#h13-1-35" id="h13-1-35" class="i">+                            nextModel = param.argNullable(1),
</a><a href="#h13-1-36" id="h13-1-36" class="i">+                            view = view
</a><a href="#h13-1-37" id="h13-1-37" class="i">+                        )
</a><a href="#h13-1-38" id="h13-1-38" class="i">+                    )
</a><a href="#h13-1-39" id="h13-1-39" class="i">+                }
</a><a href="#h13-1-40" id="h13-1-40" class="i">+            }
</a><a href="#h13-1-41" id="h13-1-41" class="i">+        }
</a><a href="#h13-1-42" id="h13-1-42" class="i">+    }
</a><a href="#h13-1-43" id="h13-1-43" class="i">+
</a><a href="#h13-1-44" id="h13-1-44" class="i">+
</a>     override fun init() {
         context.classCache.conversationManager.hook(&quot;sendMessageWithContent&quot;, HookStage.BEFORE) { param -&gt;
             context.event.post(SendMessageWithContentEvent(
<a href="#h13-2" id="h13-2" class="h">@@ -113,5 +146,7 @@ class EventDispatcher(
</a>                 if (event.canceled) param.setResult(null)
             }
         }
<a href="#h13-2-3" id="h13-2-3" class="i">+
</a><a href="#h13-2-4" id="h13-2-4" class="i">+        hookViewBinder()
</a>     }
 } 
\ No newline at end of file
<b>diff --git a/<a id="h14" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/event/events/impl/BindViewEvent.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/event/events/impl/BindViewEvent.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/event/events/impl/BindViewEvent.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/event/events/impl/BindViewEvent.kt</a></b>
<a href="#h14-0" id="h14-0" class="h">@@ -0,0 +1,26 @@
</a><a href="#h14-0-0" id="h14-0-0" class="i">+package me.rhunk.snapenhance.core.event.events.impl
</a><a href="#h14-0-1" id="h14-0-1" class="i">+
</a><a href="#h14-0-2" id="h14-0-2" class="i">+import android.view.View
</a><a href="#h14-0-3" id="h14-0-3" class="i">+import me.rhunk.snapenhance.core.event.Event
</a><a href="#h14-0-4" id="h14-0-4" class="i">+
</a><a href="#h14-0-5" id="h14-0-5" class="i">+class BindViewEvent(
</a><a href="#h14-0-6" id="h14-0-6" class="i">+    val prevModel: Any,
</a><a href="#h14-0-7" id="h14-0-7" class="i">+    val nextModel: Any?,
</a><a href="#h14-0-8" id="h14-0-8" class="i">+    val view: View
</a><a href="#h14-0-9" id="h14-0-9" class="i">+): Event() {
</a><a href="#h14-0-10" id="h14-0-10" class="i">+    fun chatMessage(block: (conversationId: String, messageId: String) -&gt; Unit) {
</a><a href="#h14-0-11" id="h14-0-11" class="i">+        val prevModelToString = prevModel.toString()
</a><a href="#h14-0-12" id="h14-0-12" class="i">+        if (!prevModelToString.startsWith(&quot;ChatViewModel&quot;)) return
</a><a href="#h14-0-13" id="h14-0-13" class="i">+        prevModelToString.substringAfter(&quot;messageId=&quot;).substringBefore(&quot;,&quot;).split(&quot;:&quot;).apply {
</a><a href="#h14-0-14" id="h14-0-14" class="i">+            if (size != 3) return
</a><a href="#h14-0-15" id="h14-0-15" class="i">+            block(this[0], this[2])
</a><a href="#h14-0-16" id="h14-0-16" class="i">+        }
</a><a href="#h14-0-17" id="h14-0-17" class="i">+    }
</a><a href="#h14-0-18" id="h14-0-18" class="i">+
</a><a href="#h14-0-19" id="h14-0-19" class="i">+    fun friendFeedItem(block: (conversationId: String) -&gt; Unit) {
</a><a href="#h14-0-20" id="h14-0-20" class="i">+        val prevModelToString = nextModel.toString()
</a><a href="#h14-0-21" id="h14-0-21" class="i">+        if (!prevModelToString.startsWith(&quot;FriendFeedItemViewModel&quot;)) return
</a><a href="#h14-0-22" id="h14-0-22" class="i">+        val conversationId = prevModelToString.substringAfter(&quot;conversationId: &quot;).substringBefore(&quot;\n&quot;)
</a><a href="#h14-0-23" id="h14-0-23" class="i">+        block(conversationId)
</a><a href="#h14-0-24" id="h14-0-24" class="i">+    }
</a><a href="#h14-0-25" id="h14-0-25" class="i">+}</a><a href="#h14-0-26" id="h14-0-26" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h15" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/messaging/MessagingCoreObjects.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/messaging/MessagingCoreObjects.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/messaging/MessagingCoreObjects.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/messaging/MessagingCoreObjects.kt</a></b>
<a href="#h15-0" id="h15-0" class="h">@@ -35,7 +35,7 @@ enum class MessagingRuleType(
</a>     STEALTH(&quot;stealth&quot;, true),
     AUTO_SAVE(&quot;auto_save&quot;, true),
     HIDE_CHAT_FEED(&quot;hide_chat_feed&quot;, false, showInFriendMenu = false),
<a href="#h15-0-3" id="h15-0-3" class="d">-    AES_ENCRYPTION(&quot;aes_encryption&quot;, false),
</a><a href="#h15-0-4" id="h15-0-4" class="i">+    E2E_ENCRYPTION(&quot;e2e_encryption&quot;, false),
</a>     PIN_CONVERSATION(&quot;pin_conversation&quot;, false, showInFriendMenu = false);
 
     fun translateOptionKey(optionKey: String): String {
<b>diff --git a/<a id="h16" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/data/MessageSender.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/data/MessageSender.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/data/MessageSender.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/data/MessageSender.kt</a></b>
<a href="#h16-0" id="h16-0" class="h">@@ -166,4 +166,13 @@ class MessageSender(
</a>             .override(&quot;onError&quot;, callback = { onError(it.arg(0)) })
             .build())
     }
<a href="#h16-0-3" id="h16-0-3" class="i">+
</a><a href="#h16-0-4" id="h16-0-4" class="i">+    fun sendCustomChatMessage(conversations: List&lt;SnapUUID&gt;, contentType: ContentType,  message: ProtoWriter.() -&gt; Unit, onError: (Any) -&gt; Unit = {}, onSuccess: () -&gt; Unit = {}) {
</a><a href="#h16-0-5" id="h16-0-5" class="i">+        internalSendMessage(conversations, createLocalMessageContentTemplate(contentType, ProtoWriter().apply {
</a><a href="#h16-0-6" id="h16-0-6" class="i">+            message()
</a><a href="#h16-0-7" id="h16-0-7" class="i">+        }.toByteArray(), savePolicy = &quot;LIFETIME&quot;), CallbackBuilder(sendMessageCallback)
</a><a href="#h16-0-8" id="h16-0-8" class="i">+            .override(&quot;onSuccess&quot;, callback = { onSuccess() })
</a><a href="#h16-0-9" id="h16-0-9" class="i">+            .override(&quot;onError&quot;, callback = { onError(it.arg(0)) })
</a><a href="#h16-0-10" id="h16-0-10" class="i">+            .build())
</a><a href="#h16-0-11" id="h16-0-11" class="i">+    }
</a> } 
\ No newline at end of file
<b>diff --git a/<a id="h17" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/experiments/AESMessageEncryption.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/experiments/AESMessageEncryption.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/experiments/AESMessageEncryption.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/experiments/AESMessageEncryption.kt</a></b>
<a href="#h17-0" id="h17-0" class="h">@@ -1,161 +0,0 @@
</a><a href="#h17-0-0" id="h17-0-0" class="d">-package me.rhunk.snapenhance.features.impl.experiments
</a><a href="#h17-0-1" id="h17-0-1" class="d">-
</a><a href="#h17-0-2" id="h17-0-2" class="d">-import me.rhunk.snapenhance.core.event.events.impl.SendMessageWithContentEvent
</a><a href="#h17-0-3" id="h17-0-3" class="d">-import me.rhunk.snapenhance.core.event.events.impl.UnaryCallEvent
</a><a href="#h17-0-4" id="h17-0-4" class="d">-import me.rhunk.snapenhance.core.messaging.MessagingRuleType
</a><a href="#h17-0-5" id="h17-0-5" class="d">-import me.rhunk.snapenhance.core.messaging.RuleState
</a><a href="#h17-0-6" id="h17-0-6" class="d">-import me.rhunk.snapenhance.core.util.protobuf.ProtoEditor
</a><a href="#h17-0-7" id="h17-0-7" class="d">-import me.rhunk.snapenhance.core.util.protobuf.ProtoReader
</a><a href="#h17-0-8" id="h17-0-8" class="d">-import me.rhunk.snapenhance.core.util.protobuf.ProtoWriter
</a><a href="#h17-0-9" id="h17-0-9" class="d">-import me.rhunk.snapenhance.data.ContentType
</a><a href="#h17-0-10" id="h17-0-10" class="d">-import me.rhunk.snapenhance.data.wrapper.impl.Message
</a><a href="#h17-0-11" id="h17-0-11" class="d">-import me.rhunk.snapenhance.data.wrapper.impl.SnapUUID
</a><a href="#h17-0-12" id="h17-0-12" class="d">-import me.rhunk.snapenhance.features.FeatureLoadParams
</a><a href="#h17-0-13" id="h17-0-13" class="d">-import me.rhunk.snapenhance.features.MessagingRuleFeature
</a><a href="#h17-0-14" id="h17-0-14" class="d">-import me.rhunk.snapenhance.hook.HookStage
</a><a href="#h17-0-15" id="h17-0-15" class="d">-import me.rhunk.snapenhance.hook.hookConstructor
</a><a href="#h17-0-16" id="h17-0-16" class="d">-import javax.crypto.Cipher
</a><a href="#h17-0-17" id="h17-0-17" class="d">-import javax.crypto.spec.IvParameterSpec
</a><a href="#h17-0-18" id="h17-0-18" class="d">-import javax.crypto.spec.SecretKeySpec
</a><a href="#h17-0-19" id="h17-0-19" class="d">-import kotlin.random.Random
</a><a href="#h17-0-20" id="h17-0-20" class="d">-
</a><a href="#h17-0-21" id="h17-0-21" class="d">-/*
</a><a href="#h17-0-22" id="h17-0-22" class="d">-    To prevent snapchat from using fidelius, snaps are spoofed to external media and chats into status before it&#39;s sent to the native.
</a><a href="#h17-0-23" id="h17-0-23" class="d">-    When the CreateContentMessage request is sent to the server, the content is encrypted
</a><a href="#h17-0-24" id="h17-0-24" class="d">- */
</a><a href="#h17-0-25" id="h17-0-25" class="d">-
</a><a href="#h17-0-26" id="h17-0-26" class="d">-//TODO: RSA encryption
</a><a href="#h17-0-27" id="h17-0-27" class="d">-class AESMessageEncryption : MessagingRuleFeature(
</a><a href="#h17-0-28" id="h17-0-28" class="d">-    &quot;AESMessageEncryption&quot;,
</a><a href="#h17-0-29" id="h17-0-29" class="d">-    MessagingRuleType.AES_ENCRYPTION,
</a><a href="#h17-0-30" id="h17-0-30" class="d">-    loadParams = FeatureLoadParams.INIT_ASYNC or FeatureLoadParams.INIT_SYNC
</a><a href="#h17-0-31" id="h17-0-31" class="d">-) {
</a><a href="#h17-0-32" id="h17-0-32" class="d">-    private val key = intArrayOf(
</a><a href="#h17-0-33" id="h17-0-33" class="d">-        0x6f, 0x6f, 0x6f, 0x6f, 0x6f, 0x6f, 0x6f, 0x6f,
</a><a href="#h17-0-34" id="h17-0-34" class="d">-        0x6f, 0x6f, 0x6f, 0x6f, 0x6f, 0x6f, 0x6f, 0x6f,
</a><a href="#h17-0-35" id="h17-0-35" class="d">-        0x6f, 0x6f, 0x6f, 0x6f, 0x6f, 0x6f, 0x6f, 0x6f,
</a><a href="#h17-0-36" id="h17-0-36" class="d">-        0x6f, 0x6f, 0x6f, 0x6f, 0x6f, 0x6f, 0x6f, 0x6f
</a><a href="#h17-0-37" id="h17-0-37" class="d">-    ).map { it.toByte() }.toByteArray()
</a><a href="#h17-0-38" id="h17-0-38" class="d">-
</a><a href="#h17-0-39" id="h17-0-39" class="d">-    private val isEnabled get() = context.config.experimental.useMessageAESEncryption.get()
</a><a href="#h17-0-40" id="h17-0-40" class="d">-
</a><a href="#h17-0-41" id="h17-0-41" class="d">-    private fun useCipher(input: ByteArray, iv: ByteArray, decrypt: Boolean = false): ByteArray {
</a><a href="#h17-0-42" id="h17-0-42" class="d">-        val cipher = Cipher.getInstance(&quot;AES/CBC/PKCS5Padding&quot;)
</a><a href="#h17-0-43" id="h17-0-43" class="d">-        cipher.init(if (decrypt) Cipher.DECRYPT_MODE else Cipher.ENCRYPT_MODE, SecretKeySpec(key, &quot;AES&quot;), IvParameterSpec(iv))
</a><a href="#h17-0-44" id="h17-0-44" class="d">-        return cipher.doFinal(input)
</a><a href="#h17-0-45" id="h17-0-45" class="d">-    }
</a><a href="#h17-0-46" id="h17-0-46" class="d">-
</a><a href="#h17-0-47" id="h17-0-47" class="d">-    private fun fixContentType(contentType: ContentType, message: ProtoReader): ContentType {
</a><a href="#h17-0-48" id="h17-0-48" class="d">-        return when {
</a><a href="#h17-0-49" id="h17-0-49" class="d">-            contentType == ContentType.EXTERNAL_MEDIA &amp;&amp; message.containsPath(11) -&gt; {
</a><a href="#h17-0-50" id="h17-0-50" class="d">-                ContentType.SNAP
</a><a href="#h17-0-51" id="h17-0-51" class="d">-            }
</a><a href="#h17-0-52" id="h17-0-52" class="d">-            contentType == ContentType.SHARE &amp;&amp; message.containsPath(2) -&gt; {
</a><a href="#h17-0-53" id="h17-0-53" class="d">-                ContentType.CHAT
</a><a href="#h17-0-54" id="h17-0-54" class="d">-            }
</a><a href="#h17-0-55" id="h17-0-55" class="d">-            else -&gt; contentType
</a><a href="#h17-0-56" id="h17-0-56" class="d">-        }
</a><a href="#h17-0-57" id="h17-0-57" class="d">-    }
</a><a href="#h17-0-58" id="h17-0-58" class="d">-
</a><a href="#h17-0-59" id="h17-0-59" class="d">-    override fun asyncInit() {
</a><a href="#h17-0-60" id="h17-0-60" class="d">-        // trick to disable fidelius encryption
</a><a href="#h17-0-61" id="h17-0-61" class="d">-        context.event.subscribe(SendMessageWithContentEvent::class, { isEnabled }) { param -&gt;
</a><a href="#h17-0-62" id="h17-0-62" class="d">-            val messageContent = param.messageContent
</a><a href="#h17-0-63" id="h17-0-63" class="d">-            val destinations = param.destinations
</a><a href="#h17-0-64" id="h17-0-64" class="d">-            if (destinations.conversations.size != 1 || destinations.stories.isNotEmpty()) return@subscribe
</a><a href="#h17-0-65" id="h17-0-65" class="d">-
</a><a href="#h17-0-66" id="h17-0-66" class="d">-            if (!getState(destinations.conversations.first().toString())) return@subscribe
</a><a href="#h17-0-67" id="h17-0-67" class="d">-
</a><a href="#h17-0-68" id="h17-0-68" class="d">-            if (messageContent.contentType == ContentType.SNAP) {
</a><a href="#h17-0-69" id="h17-0-69" class="d">-                messageContent.contentType = ContentType.EXTERNAL_MEDIA
</a><a href="#h17-0-70" id="h17-0-70" class="d">-            }
</a><a href="#h17-0-71" id="h17-0-71" class="d">-
</a><a href="#h17-0-72" id="h17-0-72" class="d">-            if (messageContent.contentType == ContentType.CHAT) {
</a><a href="#h17-0-73" id="h17-0-73" class="d">-                messageContent.contentType = ContentType.SHARE
</a><a href="#h17-0-74" id="h17-0-74" class="d">-            }
</a><a href="#h17-0-75" id="h17-0-75" class="d">-        }
</a><a href="#h17-0-76" id="h17-0-76" class="d">-    }
</a><a href="#h17-0-77" id="h17-0-77" class="d">-
</a><a href="#h17-0-78" id="h17-0-78" class="d">-    override fun init() {
</a><a href="#h17-0-79" id="h17-0-79" class="d">-        context.event.subscribe(UnaryCallEvent::class, { isEnabled }) { event -&gt;
</a><a href="#h17-0-80" id="h17-0-80" class="d">-            if (event.uri != &quot;/messagingcoreservice.MessagingCoreService/CreateContentMessage&quot;) return@subscribe
</a><a href="#h17-0-81" id="h17-0-81" class="d">-            val protoReader = ProtoReader(event.buffer)
</a><a href="#h17-0-82" id="h17-0-82" class="d">-
</a><a href="#h17-0-83" id="h17-0-83" class="d">-            val conversationIds = mutableListOf&lt;SnapUUID&gt;()
</a><a href="#h17-0-84" id="h17-0-84" class="d">-            protoReader.eachBuffer(3) {
</a><a href="#h17-0-85" id="h17-0-85" class="d">-                conversationIds.add(SnapUUID.fromBytes(getByteArray(1, 1, 1) ?: return@eachBuffer))
</a><a href="#h17-0-86" id="h17-0-86" class="d">-            }
</a><a href="#h17-0-87" id="h17-0-87" class="d">-
</a><a href="#h17-0-88" id="h17-0-88" class="d">-            if (conversationIds.size != 1) return@subscribe
</a><a href="#h17-0-89" id="h17-0-89" class="d">-
</a><a href="#h17-0-90" id="h17-0-90" class="d">-            if (!getState(conversationIds.first().toString())) return@subscribe
</a><a href="#h17-0-91" id="h17-0-91" class="d">-
</a><a href="#h17-0-92" id="h17-0-92" class="d">-            val generatedIv = ByteArray(16).also { Random.nextBytes(it) }
</a><a href="#h17-0-93" id="h17-0-93" class="d">-
</a><a href="#h17-0-94" id="h17-0-94" class="d">-            event.buffer = ProtoEditor(event.buffer).apply {
</a><a href="#h17-0-95" id="h17-0-95" class="d">-                protoReader.followPath(4) {
</a><a href="#h17-0-96" id="h17-0-96" class="d">-                    val contentType = fixContentType(ContentType.fromId(getVarInt(2)?.toInt() ?: -1), followPath(4) ?: return@followPath)
</a><a href="#h17-0-97" id="h17-0-97" class="d">-
</a><a href="#h17-0-98" id="h17-0-98" class="d">-                    runCatching {
</a><a href="#h17-0-99" id="h17-0-99" class="d">-                        val encryptedMessage = useCipher(getByteArray(4) ?: return@followPath, generatedIv, false)
</a><a href="#h17-0-100" id="h17-0-100" class="d">-                        edit(4) {
</a><a href="#h17-0-101" id="h17-0-101" class="d">-                            //set message content type
</a><a href="#h17-0-102" id="h17-0-102" class="d">-                            remove(2)
</a><a href="#h17-0-103" id="h17-0-103" class="d">-                            addVarInt(2, contentType.id)
</a><a href="#h17-0-104" id="h17-0-104" class="d">-
</a><a href="#h17-0-105" id="h17-0-105" class="d">-                            //set encrypted content
</a><a href="#h17-0-106" id="h17-0-106" class="d">-                            remove(4)
</a><a href="#h17-0-107" id="h17-0-107" class="d">-                            add(4) {
</a><a href="#h17-0-108" id="h17-0-108" class="d">-                                from(2) {
</a><a href="#h17-0-109" id="h17-0-109" class="d">-                                    from(1) {
</a><a href="#h17-0-110" id="h17-0-110" class="d">-                                        addBuffer(1, encryptedMessage)
</a><a href="#h17-0-111" id="h17-0-111" class="d">-                                        addBuffer(2, generatedIv)
</a><a href="#h17-0-112" id="h17-0-112" class="d">-                                    }
</a><a href="#h17-0-113" id="h17-0-113" class="d">-                                    addVarInt(2, 1)
</a><a href="#h17-0-114" id="h17-0-114" class="d">-                                }
</a><a href="#h17-0-115" id="h17-0-115" class="d">-                            }
</a><a href="#h17-0-116" id="h17-0-116" class="d">-                        }
</a><a href="#h17-0-117" id="h17-0-117" class="d">-                    }.onFailure {
</a><a href="#h17-0-118" id="h17-0-118" class="d">-                        event.canceled = true
</a><a href="#h17-0-119" id="h17-0-119" class="d">-                        context.log.error(&quot;Failed to encrypt message&quot;, it)
</a><a href="#h17-0-120" id="h17-0-120" class="d">-                        context.longToast(&quot;Failed to encrypt message! Check logcat for more details.&quot;)
</a><a href="#h17-0-121" id="h17-0-121" class="d">-                    }
</a><a href="#h17-0-122" id="h17-0-122" class="d">-                }
</a><a href="#h17-0-123" id="h17-0-123" class="d">-            }.toByteArray()
</a><a href="#h17-0-124" id="h17-0-124" class="d">-        }
</a><a href="#h17-0-125" id="h17-0-125" class="d">-
</a><a href="#h17-0-126" id="h17-0-126" class="d">-        context.classCache.message.hookConstructor(HookStage.AFTER, { isEnabled }) { param -&gt;
</a><a href="#h17-0-127" id="h17-0-127" class="d">-            val message = Message(param.thisObject())
</a><a href="#h17-0-128" id="h17-0-128" class="d">-            val reader = ProtoReader(message.messageContent.content)
</a><a href="#h17-0-129" id="h17-0-129" class="d">-
</a><a href="#h17-0-130" id="h17-0-130" class="d">-            // fix content type
</a><a href="#h17-0-131" id="h17-0-131" class="d">-            message.messageContent.contentType?.also {
</a><a href="#h17-0-132" id="h17-0-132" class="d">-                message.messageContent.contentType = fixContentType(it, reader)
</a><a href="#h17-0-133" id="h17-0-133" class="d">-            }
</a><a href="#h17-0-134" id="h17-0-134" class="d">-
</a><a href="#h17-0-135" id="h17-0-135" class="d">-            reader.followPath(2) {
</a><a href="#h17-0-136" id="h17-0-136" class="d">-                if (getVarInt(2) != 1L) return@followPath
</a><a href="#h17-0-137" id="h17-0-137" class="d">-
</a><a href="#h17-0-138" id="h17-0-138" class="d">-                runCatching {
</a><a href="#h17-0-139" id="h17-0-139" class="d">-                    followPath(1) path@{
</a><a href="#h17-0-140" id="h17-0-140" class="d">-                        val encryptedMessage = getByteArray(1) ?: return@path
</a><a href="#h17-0-141" id="h17-0-141" class="d">-                        val iv = getByteArray(2) ?: return@path
</a><a href="#h17-0-142" id="h17-0-142" class="d">-
</a><a href="#h17-0-143" id="h17-0-143" class="d">-                        val decryptedMessage = useCipher(encryptedMessage, iv, decrypt = true)
</a><a href="#h17-0-144" id="h17-0-144" class="d">-                        message.messageContent.content = decryptedMessage
</a><a href="#h17-0-145" id="h17-0-145" class="d">-                    }
</a><a href="#h17-0-146" id="h17-0-146" class="d">-                }.onFailure {
</a><a href="#h17-0-147" id="h17-0-147" class="d">-                    context.log.error(&quot;Failed to decrypt message id: ${message.messageDescriptor.messageId}&quot;, it)
</a><a href="#h17-0-148" id="h17-0-148" class="d">-                    message.messageContent.contentType = ContentType.CHAT
</a><a href="#h17-0-149" id="h17-0-149" class="d">-                    message.messageContent.content = ProtoWriter().apply {
</a><a href="#h17-0-150" id="h17-0-150" class="d">-                        from(2) {
</a><a href="#h17-0-151" id="h17-0-151" class="d">-                            addString(1, &quot;Failed to decrypt message, id=${message.messageDescriptor.messageId}. Check logcat for more details.&quot;)
</a><a href="#h17-0-152" id="h17-0-152" class="d">-                        }
</a><a href="#h17-0-153" id="h17-0-153" class="d">-                    }.toByteArray()
</a><a href="#h17-0-154" id="h17-0-154" class="d">-                }
</a><a href="#h17-0-155" id="h17-0-155" class="d">-            }
</a><a href="#h17-0-156" id="h17-0-156" class="d">-        }
</a><a href="#h17-0-157" id="h17-0-157" class="d">-    }
</a><a href="#h17-0-158" id="h17-0-158" class="d">-
</a><a href="#h17-0-159" id="h17-0-159" class="d">-    override fun getRuleState() = RuleState.WHITELIST
</a><a href="#h17-0-160" id="h17-0-160" class="d">-}</a><a href="#h17-0-161" id="h17-0-161" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h18" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/experiments/EndToEndEncryption.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/experiments/EndToEndEncryption.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/experiments/EndToEndEncryption.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/experiments/EndToEndEncryption.kt</a></b>
<a href="#h18-0" id="h18-0" class="h">@@ -0,0 +1,442 @@
</a><a href="#h18-0-0" id="h18-0-0" class="i">+package me.rhunk.snapenhance.features.impl.experiments
</a><a href="#h18-0-1" id="h18-0-1" class="i">+
</a><a href="#h18-0-2" id="h18-0-2" class="i">+import android.annotation.SuppressLint
</a><a href="#h18-0-3" id="h18-0-3" class="i">+import android.view.View
</a><a href="#h18-0-4" id="h18-0-4" class="i">+import android.view.ViewGroup
</a><a href="#h18-0-5" id="h18-0-5" class="i">+import android.view.ViewGroup.LayoutParams
</a><a href="#h18-0-6" id="h18-0-6" class="i">+import android.view.ViewGroup.MarginLayoutParams
</a><a href="#h18-0-7" id="h18-0-7" class="i">+import android.widget.Button
</a><a href="#h18-0-8" id="h18-0-8" class="i">+import android.widget.TextView
</a><a href="#h18-0-9" id="h18-0-9" class="i">+import me.rhunk.snapenhance.core.event.events.impl.AddViewEvent
</a><a href="#h18-0-10" id="h18-0-10" class="i">+import me.rhunk.snapenhance.core.event.events.impl.BindViewEvent
</a><a href="#h18-0-11" id="h18-0-11" class="i">+import me.rhunk.snapenhance.core.event.events.impl.SendMessageWithContentEvent
</a><a href="#h18-0-12" id="h18-0-12" class="i">+import me.rhunk.snapenhance.core.event.events.impl.UnaryCallEvent
</a><a href="#h18-0-13" id="h18-0-13" class="i">+import me.rhunk.snapenhance.core.messaging.MessagingRuleType
</a><a href="#h18-0-14" id="h18-0-14" class="i">+import me.rhunk.snapenhance.core.messaging.RuleState
</a><a href="#h18-0-15" id="h18-0-15" class="i">+import me.rhunk.snapenhance.core.util.ktx.getObjectField
</a><a href="#h18-0-16" id="h18-0-16" class="i">+import me.rhunk.snapenhance.core.util.protobuf.ProtoEditor
</a><a href="#h18-0-17" id="h18-0-17" class="i">+import me.rhunk.snapenhance.core.util.protobuf.ProtoReader
</a><a href="#h18-0-18" id="h18-0-18" class="i">+import me.rhunk.snapenhance.core.util.protobuf.ProtoWriter
</a><a href="#h18-0-19" id="h18-0-19" class="i">+import me.rhunk.snapenhance.data.ContentType
</a><a href="#h18-0-20" id="h18-0-20" class="i">+import me.rhunk.snapenhance.data.wrapper.impl.Message
</a><a href="#h18-0-21" id="h18-0-21" class="i">+import me.rhunk.snapenhance.data.wrapper.impl.MessageContent
</a><a href="#h18-0-22" id="h18-0-22" class="i">+import me.rhunk.snapenhance.data.wrapper.impl.SnapUUID
</a><a href="#h18-0-23" id="h18-0-23" class="i">+import me.rhunk.snapenhance.features.FeatureLoadParams
</a><a href="#h18-0-24" id="h18-0-24" class="i">+import me.rhunk.snapenhance.features.MessagingRuleFeature
</a><a href="#h18-0-25" id="h18-0-25" class="i">+import me.rhunk.snapenhance.features.impl.Messaging
</a><a href="#h18-0-26" id="h18-0-26" class="i">+import me.rhunk.snapenhance.hook.HookStage
</a><a href="#h18-0-27" id="h18-0-27" class="i">+import me.rhunk.snapenhance.hook.hookConstructor
</a><a href="#h18-0-28" id="h18-0-28" class="i">+import me.rhunk.snapenhance.ui.ViewAppearanceHelper
</a><a href="#h18-0-29" id="h18-0-29" class="i">+import java.security.MessageDigest
</a><a href="#h18-0-30" id="h18-0-30" class="i">+import kotlin.random.Random
</a><a href="#h18-0-31" id="h18-0-31" class="i">+
</a><a href="#h18-0-32" id="h18-0-32" class="i">+class EndToEndEncryption : MessagingRuleFeature(
</a><a href="#h18-0-33" id="h18-0-33" class="i">+    &quot;EndToEndEncryption&quot;,
</a><a href="#h18-0-34" id="h18-0-34" class="i">+    MessagingRuleType.E2E_ENCRYPTION,
</a><a href="#h18-0-35" id="h18-0-35" class="i">+    loadParams = FeatureLoadParams.ACTIVITY_CREATE_SYNC or FeatureLoadParams.INIT_SYNC or FeatureLoadParams.INIT_ASYNC
</a><a href="#h18-0-36" id="h18-0-36" class="i">+) {
</a><a href="#h18-0-37" id="h18-0-37" class="i">+    private val isEnabled get() = context.config.experimental.useE2EEncryption.get()
</a><a href="#h18-0-38" id="h18-0-38" class="i">+    private val e2eeInterface by lazy { context.bridgeClient.getE2eeInterface() }
</a><a href="#h18-0-39" id="h18-0-39" class="i">+
</a><a href="#h18-0-40" id="h18-0-40" class="i">+    companion object {
</a><a href="#h18-0-41" id="h18-0-41" class="i">+        const val REQUEST_PK_MESSAGE_ID = 1
</a><a href="#h18-0-42" id="h18-0-42" class="i">+        const val RESPONSE_SK_MESSAGE_ID = 2
</a><a href="#h18-0-43" id="h18-0-43" class="i">+        const val ENCRYPTED_MESSAGE_ID = 3
</a><a href="#h18-0-44" id="h18-0-44" class="i">+    }
</a><a href="#h18-0-45" id="h18-0-45" class="i">+
</a><a href="#h18-0-46" id="h18-0-46" class="i">+    private val pkRequests = mutableMapOf&lt;Long, ByteArray&gt;()
</a><a href="#h18-0-47" id="h18-0-47" class="i">+    private val secretResponses = mutableMapOf&lt;Long, ByteArray&gt;()
</a><a href="#h18-0-48" id="h18-0-48" class="i">+
</a><a href="#h18-0-49" id="h18-0-49" class="i">+    private fun getE2EParticipants(conversationId: String): List&lt;String&gt; {
</a><a href="#h18-0-50" id="h18-0-50" class="i">+        return context.database.getConversationParticipants(conversationId)?.filter { friendId -&gt; e2eeInterface.friendKeyExists(friendId) } ?: emptyList()
</a><a href="#h18-0-51" id="h18-0-51" class="i">+    }
</a><a href="#h18-0-52" id="h18-0-52" class="i">+
</a><a href="#h18-0-53" id="h18-0-53" class="i">+    private fun askForKeys(conversationId: String) {
</a><a href="#h18-0-54" id="h18-0-54" class="i">+        val friendId = context.database.getDMOtherParticipant(conversationId) ?: run {
</a><a href="#h18-0-55" id="h18-0-55" class="i">+            context.longToast(&quot;Can&#39;t find friendId for conversationId $conversationId&quot;)
</a><a href="#h18-0-56" id="h18-0-56" class="i">+            return
</a><a href="#h18-0-57" id="h18-0-57" class="i">+        }
</a><a href="#h18-0-58" id="h18-0-58" class="i">+
</a><a href="#h18-0-59" id="h18-0-59" class="i">+        val publicKey = e2eeInterface.createKeyExchange(friendId) ?: run {
</a><a href="#h18-0-60" id="h18-0-60" class="i">+            context.longToast(&quot;Can&#39;t create key exchange for friendId $friendId&quot;)
</a><a href="#h18-0-61" id="h18-0-61" class="i">+            return
</a><a href="#h18-0-62" id="h18-0-62" class="i">+        }
</a><a href="#h18-0-63" id="h18-0-63" class="i">+
</a><a href="#h18-0-64" id="h18-0-64" class="i">+        context.log.verbose(&quot;created publicKey: ${publicKey.contentToString()}&quot;)
</a><a href="#h18-0-65" id="h18-0-65" class="i">+
</a><a href="#h18-0-66" id="h18-0-66" class="i">+        sendCustomMessage(conversationId, REQUEST_PK_MESSAGE_ID) {
</a><a href="#h18-0-67" id="h18-0-67" class="i">+            addBuffer(2, publicKey)
</a><a href="#h18-0-68" id="h18-0-68" class="i">+        }
</a><a href="#h18-0-69" id="h18-0-69" class="i">+    }
</a><a href="#h18-0-70" id="h18-0-70" class="i">+
</a><a href="#h18-0-71" id="h18-0-71" class="i">+    private fun sendCustomMessage(conversationId: String, messageId: Int, message: ProtoWriter.() -&gt; Unit) {
</a><a href="#h18-0-72" id="h18-0-72" class="i">+        context.messageSender.sendCustomChatMessage(
</a><a href="#h18-0-73" id="h18-0-73" class="i">+            listOf(SnapUUID.fromString(conversationId)),
</a><a href="#h18-0-74" id="h18-0-74" class="i">+            ContentType.CHAT,
</a><a href="#h18-0-75" id="h18-0-75" class="i">+            message = {
</a><a href="#h18-0-76" id="h18-0-76" class="i">+                from(2) {
</a><a href="#h18-0-77" id="h18-0-77" class="i">+                    from(1) {
</a><a href="#h18-0-78" id="h18-0-78" class="i">+                        addVarInt(1, messageId)
</a><a href="#h18-0-79" id="h18-0-79" class="i">+                        addBuffer(2, ProtoWriter().apply(message).toByteArray())
</a><a href="#h18-0-80" id="h18-0-80" class="i">+                    }
</a><a href="#h18-0-81" id="h18-0-81" class="i">+                }
</a><a href="#h18-0-82" id="h18-0-82" class="i">+            }
</a><a href="#h18-0-83" id="h18-0-83" class="i">+        )
</a><a href="#h18-0-84" id="h18-0-84" class="i">+    }
</a><a href="#h18-0-85" id="h18-0-85" class="i">+
</a><a href="#h18-0-86" id="h18-0-86" class="i">+    private fun warnKeyOverwrite(friendId: String, block: () -&gt; Unit) {
</a><a href="#h18-0-87" id="h18-0-87" class="i">+        if (!e2eeInterface.friendKeyExists(friendId)) {
</a><a href="#h18-0-88" id="h18-0-88" class="i">+            block()
</a><a href="#h18-0-89" id="h18-0-89" class="i">+            return
</a><a href="#h18-0-90" id="h18-0-90" class="i">+        }
</a><a href="#h18-0-91" id="h18-0-91" class="i">+
</a><a href="#h18-0-92" id="h18-0-92" class="i">+        context.mainActivity?.runOnUiThread {
</a><a href="#h18-0-93" id="h18-0-93" class="i">+            val mainActivity = context.mainActivity ?: return@runOnUiThread
</a><a href="#h18-0-94" id="h18-0-94" class="i">+            ViewAppearanceHelper.newAlertDialogBuilder(mainActivity).apply {
</a><a href="#h18-0-95" id="h18-0-95" class="i">+                setTitle(&quot;End-to-end encryption&quot;)
</a><a href="#h18-0-96" id="h18-0-96" class="i">+                setMessage(&quot;WARNING: This will overwrite your existing key. You will loose access to all encrypted messages from this friend. Are you sure you want to continue?&quot;)
</a><a href="#h18-0-97" id="h18-0-97" class="i">+                setPositiveButton(&quot;Yes&quot;) { _, _ -&gt;
</a><a href="#h18-0-98" id="h18-0-98" class="i">+                    ViewAppearanceHelper.newAlertDialogBuilder(mainActivity).apply {
</a><a href="#h18-0-99" id="h18-0-99" class="i">+                        setTitle(&quot;End-to-end encryption&quot;)
</a><a href="#h18-0-100" id="h18-0-100" class="i">+                        setMessage(&quot;Are you REALLY sure you want to continue? This is your last chance to back out.&quot;)
</a><a href="#h18-0-101" id="h18-0-101" class="i">+                        setNeutralButton(&quot;Yes&quot;) { _, _ -&gt; block() }
</a><a href="#h18-0-102" id="h18-0-102" class="i">+                        setPositiveButton(&quot;No&quot;) { _, _ -&gt; }
</a><a href="#h18-0-103" id="h18-0-103" class="i">+                    }.show()
</a><a href="#h18-0-104" id="h18-0-104" class="i">+                }
</a><a href="#h18-0-105" id="h18-0-105" class="i">+                setNegativeButton(&quot;No&quot;) { _, _ -&gt; }
</a><a href="#h18-0-106" id="h18-0-106" class="i">+            }.show()
</a><a href="#h18-0-107" id="h18-0-107" class="i">+        }
</a><a href="#h18-0-108" id="h18-0-108" class="i">+    }
</a><a href="#h18-0-109" id="h18-0-109" class="i">+
</a><a href="#h18-0-110" id="h18-0-110" class="i">+    private fun handlePublicKeyRequest(conversationId: String, publicKey: ByteArray) {
</a><a href="#h18-0-111" id="h18-0-111" class="i">+        val friendId = context.database.getDMOtherParticipant(conversationId) ?: run {
</a><a href="#h18-0-112" id="h18-0-112" class="i">+            context.longToast(&quot;Can&#39;t find friendId for conversationId $conversationId&quot;)
</a><a href="#h18-0-113" id="h18-0-113" class="i">+            return
</a><a href="#h18-0-114" id="h18-0-114" class="i">+        }
</a><a href="#h18-0-115" id="h18-0-115" class="i">+        warnKeyOverwrite(friendId) {
</a><a href="#h18-0-116" id="h18-0-116" class="i">+            val encapsulatedSecret = e2eeInterface.acceptPairingRequest(friendId, publicKey)
</a><a href="#h18-0-117" id="h18-0-117" class="i">+            if (encapsulatedSecret == null) {
</a><a href="#h18-0-118" id="h18-0-118" class="i">+                context.longToast(&quot;Failed to accept public key&quot;)
</a><a href="#h18-0-119" id="h18-0-119" class="i">+                return@warnKeyOverwrite
</a><a href="#h18-0-120" id="h18-0-120" class="i">+            }
</a><a href="#h18-0-121" id="h18-0-121" class="i">+            context.longToast(&quot;Public key successfully accepted&quot;)
</a><a href="#h18-0-122" id="h18-0-122" class="i">+
</a><a href="#h18-0-123" id="h18-0-123" class="i">+            sendCustomMessage(conversationId, RESPONSE_SK_MESSAGE_ID) {
</a><a href="#h18-0-124" id="h18-0-124" class="i">+                addBuffer(2, encapsulatedSecret)
</a><a href="#h18-0-125" id="h18-0-125" class="i">+            }
</a><a href="#h18-0-126" id="h18-0-126" class="i">+        }
</a><a href="#h18-0-127" id="h18-0-127" class="i">+    }
</a><a href="#h18-0-128" id="h18-0-128" class="i">+
</a><a href="#h18-0-129" id="h18-0-129" class="i">+    private fun handleSecretResponse(conversationId: String, secret: ByteArray) {
</a><a href="#h18-0-130" id="h18-0-130" class="i">+        val friendId = context.database.getDMOtherParticipant(conversationId) ?: run {
</a><a href="#h18-0-131" id="h18-0-131" class="i">+            context.longToast(&quot;Can&#39;t find friendId for conversationId $conversationId&quot;)
</a><a href="#h18-0-132" id="h18-0-132" class="i">+            return
</a><a href="#h18-0-133" id="h18-0-133" class="i">+        }
</a><a href="#h18-0-134" id="h18-0-134" class="i">+        warnKeyOverwrite(friendId) {
</a><a href="#h18-0-135" id="h18-0-135" class="i">+            context.log.verbose(&quot;handleSecretResponse, secret = $secret&quot;)
</a><a href="#h18-0-136" id="h18-0-136" class="i">+            val result = e2eeInterface.acceptPairingResponse(friendId, secret)
</a><a href="#h18-0-137" id="h18-0-137" class="i">+            if (!result) {
</a><a href="#h18-0-138" id="h18-0-138" class="i">+                context.longToast(&quot;Failed to accept secret&quot;)
</a><a href="#h18-0-139" id="h18-0-139" class="i">+                return@warnKeyOverwrite
</a><a href="#h18-0-140" id="h18-0-140" class="i">+            }
</a><a href="#h18-0-141" id="h18-0-141" class="i">+            context.longToast(&quot;Done! You can now exchange encrypted messages with this friend.&quot;)
</a><a href="#h18-0-142" id="h18-0-142" class="i">+        }
</a><a href="#h18-0-143" id="h18-0-143" class="i">+    }
</a><a href="#h18-0-144" id="h18-0-144" class="i">+
</a><a href="#h18-0-145" id="h18-0-145" class="i">+    private fun openManagementPopup() {
</a><a href="#h18-0-146" id="h18-0-146" class="i">+        val conversationId = context.feature(Messaging::class).openedConversationUUID?.toString() ?: return
</a><a href="#h18-0-147" id="h18-0-147" class="i">+
</a><a href="#h18-0-148" id="h18-0-148" class="i">+        if (context.database.getDMOtherParticipant(conversationId) == null) {
</a><a href="#h18-0-149" id="h18-0-149" class="i">+            context.shortToast(&quot;This menu is only available in direct messages.&quot;)
</a><a href="#h18-0-150" id="h18-0-150" class="i">+            return
</a><a href="#h18-0-151" id="h18-0-151" class="i">+        }
</a><a href="#h18-0-152" id="h18-0-152" class="i">+
</a><a href="#h18-0-153" id="h18-0-153" class="i">+        val actions = listOf(
</a><a href="#h18-0-154" id="h18-0-154" class="i">+            &quot;Initiate a new shared secret&quot;
</a><a href="#h18-0-155" id="h18-0-155" class="i">+        )
</a><a href="#h18-0-156" id="h18-0-156" class="i">+
</a><a href="#h18-0-157" id="h18-0-157" class="i">+        ViewAppearanceHelper.newAlertDialogBuilder(context.mainActivity!!).apply {
</a><a href="#h18-0-158" id="h18-0-158" class="i">+            setTitle(&quot;End-to-end encryption&quot;)
</a><a href="#h18-0-159" id="h18-0-159" class="i">+            setItems(actions.toTypedArray()) { _, which -&gt;
</a><a href="#h18-0-160" id="h18-0-160" class="i">+                when (which) {
</a><a href="#h18-0-161" id="h18-0-161" class="i">+                    0 -&gt; askForKeys(conversationId)
</a><a href="#h18-0-162" id="h18-0-162" class="i">+                }
</a><a href="#h18-0-163" id="h18-0-163" class="i">+            }
</a><a href="#h18-0-164" id="h18-0-164" class="i">+            setPositiveButton(&quot;OK&quot;) { _, _ -&gt; }
</a><a href="#h18-0-165" id="h18-0-165" class="i">+        }.show()
</a><a href="#h18-0-166" id="h18-0-166" class="i">+    }
</a><a href="#h18-0-167" id="h18-0-167" class="i">+
</a><a href="#h18-0-168" id="h18-0-168" class="i">+    @SuppressLint(&quot;SetTextI18n&quot;)
</a><a href="#h18-0-169" id="h18-0-169" class="i">+    override fun onActivityCreate() {
</a><a href="#h18-0-170" id="h18-0-170" class="i">+        if (!isEnabled) return
</a><a href="#h18-0-171" id="h18-0-171" class="i">+        // add button to input bar
</a><a href="#h18-0-172" id="h18-0-172" class="i">+        context.event.subscribe(AddViewEvent::class) { param -&gt;
</a><a href="#h18-0-173" id="h18-0-173" class="i">+            if (param.view.toString().contains(&quot;default_input_bar&quot;)) {
</a><a href="#h18-0-174" id="h18-0-174" class="i">+                (param.view as ViewGroup).addView(TextView(param.view.context).apply {
</a><a href="#h18-0-175" id="h18-0-175" class="i">+                    layoutParams = MarginLayoutParams(LayoutParams.WRAP_CONTENT, LayoutParams.MATCH_PARENT)
</a><a href="#h18-0-176" id="h18-0-176" class="i">+                    setOnClickListener { openManagementPopup() }
</a><a href="#h18-0-177" id="h18-0-177" class="i">+                    setPadding(20, 20, 20, 20)
</a><a href="#h18-0-178" id="h18-0-178" class="i">+                    textSize = 23f
</a><a href="#h18-0-179" id="h18-0-179" class="i">+                    text = &quot;\uD83D\uDD12&quot;
</a><a href="#h18-0-180" id="h18-0-180" class="i">+                })
</a><a href="#h18-0-181" id="h18-0-181" class="i">+            }
</a><a href="#h18-0-182" id="h18-0-182" class="i">+        }
</a><a href="#h18-0-183" id="h18-0-183" class="i">+
</a><a href="#h18-0-184" id="h18-0-184" class="i">+        // hook view binder to add special buttons
</a><a href="#h18-0-185" id="h18-0-185" class="i">+        val receivePublicKeyTag = Random.nextLong().toString(16)
</a><a href="#h18-0-186" id="h18-0-186" class="i">+        val receiveSecretTag = Random.nextLong().toString(16)
</a><a href="#h18-0-187" id="h18-0-187" class="i">+
</a><a href="#h18-0-188" id="h18-0-188" class="i">+        context.event.subscribe(BindViewEvent::class) { event -&gt;
</a><a href="#h18-0-189" id="h18-0-189" class="i">+            event.chatMessage { conversationId, messageId -&gt;
</a><a href="#h18-0-190" id="h18-0-190" class="i">+                val viewGroup = event.view as ViewGroup
</a><a href="#h18-0-191" id="h18-0-191" class="i">+
</a><a href="#h18-0-192" id="h18-0-192" class="i">+                viewGroup.findViewWithTag&lt;View&gt;(receiveSecretTag)?.also {
</a><a href="#h18-0-193" id="h18-0-193" class="i">+                    viewGroup.removeView(it)
</a><a href="#h18-0-194" id="h18-0-194" class="i">+                }
</a><a href="#h18-0-195" id="h18-0-195" class="i">+
</a><a href="#h18-0-196" id="h18-0-196" class="i">+                viewGroup.findViewWithTag&lt;View&gt;(receivePublicKeyTag)?.also {
</a><a href="#h18-0-197" id="h18-0-197" class="i">+                    viewGroup.removeView(it)
</a><a href="#h18-0-198" id="h18-0-198" class="i">+                }
</a><a href="#h18-0-199" id="h18-0-199" class="i">+
</a><a href="#h18-0-200" id="h18-0-200" class="i">+                secretResponses[messageId.toLong()]?.also { secret -&gt;
</a><a href="#h18-0-201" id="h18-0-201" class="i">+                    viewGroup.addView(Button(context.mainActivity!!).apply {
</a><a href="#h18-0-202" id="h18-0-202" class="i">+                        text = &quot;Accept secret&quot;
</a><a href="#h18-0-203" id="h18-0-203" class="i">+                        tag = receiveSecretTag
</a><a href="#h18-0-204" id="h18-0-204" class="i">+                        setOnClickListener {
</a><a href="#h18-0-205" id="h18-0-205" class="i">+                            handleSecretResponse(conversationId, secret)
</a><a href="#h18-0-206" id="h18-0-206" class="i">+                        }
</a><a href="#h18-0-207" id="h18-0-207" class="i">+                    })
</a><a href="#h18-0-208" id="h18-0-208" class="i">+                }
</a><a href="#h18-0-209" id="h18-0-209" class="i">+
</a><a href="#h18-0-210" id="h18-0-210" class="i">+                pkRequests[messageId.toLong()]?.also { publicKey -&gt;
</a><a href="#h18-0-211" id="h18-0-211" class="i">+                    viewGroup.addView(Button(context.mainActivity!!).apply {
</a><a href="#h18-0-212" id="h18-0-212" class="i">+                        text = &quot;Receive public key&quot;
</a><a href="#h18-0-213" id="h18-0-213" class="i">+                        tag = receivePublicKeyTag
</a><a href="#h18-0-214" id="h18-0-214" class="i">+                        setOnClickListener {
</a><a href="#h18-0-215" id="h18-0-215" class="i">+                            handlePublicKeyRequest(conversationId, publicKey)
</a><a href="#h18-0-216" id="h18-0-216" class="i">+                        }
</a><a href="#h18-0-217" id="h18-0-217" class="i">+                    })
</a><a href="#h18-0-218" id="h18-0-218" class="i">+                }
</a><a href="#h18-0-219" id="h18-0-219" class="i">+            }
</a><a href="#h18-0-220" id="h18-0-220" class="i">+        }
</a><a href="#h18-0-221" id="h18-0-221" class="i">+    }
</a><a href="#h18-0-222" id="h18-0-222" class="i">+
</a><a href="#h18-0-223" id="h18-0-223" class="i">+    private fun fixContentType(contentType: ContentType, message: ProtoReader): ContentType {
</a><a href="#h18-0-224" id="h18-0-224" class="i">+        return when {
</a><a href="#h18-0-225" id="h18-0-225" class="i">+            contentType == ContentType.EXTERNAL_MEDIA &amp;&amp; message.containsPath(11) -&gt; {
</a><a href="#h18-0-226" id="h18-0-226" class="i">+                ContentType.SNAP
</a><a href="#h18-0-227" id="h18-0-227" class="i">+            }
</a><a href="#h18-0-228" id="h18-0-228" class="i">+            contentType == ContentType.SHARE &amp;&amp; message.containsPath(2) -&gt; {
</a><a href="#h18-0-229" id="h18-0-229" class="i">+                ContentType.CHAT
</a><a href="#h18-0-230" id="h18-0-230" class="i">+            }
</a><a href="#h18-0-231" id="h18-0-231" class="i">+            else -&gt; contentType
</a><a href="#h18-0-232" id="h18-0-232" class="i">+        }
</a><a href="#h18-0-233" id="h18-0-233" class="i">+    }
</a><a href="#h18-0-234" id="h18-0-234" class="i">+
</a><a href="#h18-0-235" id="h18-0-235" class="i">+    private fun hashParticipantId(participantId: String, salt: ByteArray): ByteArray {
</a><a href="#h18-0-236" id="h18-0-236" class="i">+        return MessageDigest.getInstance(&quot;SHA-256&quot;).apply {
</a><a href="#h18-0-237" id="h18-0-237" class="i">+            update(participantId.toByteArray())
</a><a href="#h18-0-238" id="h18-0-238" class="i">+            update(salt)
</a><a href="#h18-0-239" id="h18-0-239" class="i">+        }.digest()
</a><a href="#h18-0-240" id="h18-0-240" class="i">+    }
</a><a href="#h18-0-241" id="h18-0-241" class="i">+
</a><a href="#h18-0-242" id="h18-0-242" class="i">+    private fun messageHook(conversationId: String, messageId: Long, senderId: String, messageContent: MessageContent) {
</a><a href="#h18-0-243" id="h18-0-243" class="i">+        val reader = ProtoReader(messageContent.content)
</a><a href="#h18-0-244" id="h18-0-244" class="i">+
</a><a href="#h18-0-245" id="h18-0-245" class="i">+        fun replaceMessageText(text: String) {
</a><a href="#h18-0-246" id="h18-0-246" class="i">+            messageContent.content = ProtoWriter().apply {
</a><a href="#h18-0-247" id="h18-0-247" class="i">+                from(2) {
</a><a href="#h18-0-248" id="h18-0-248" class="i">+                    addString(1, text)
</a><a href="#h18-0-249" id="h18-0-249" class="i">+                }
</a><a href="#h18-0-250" id="h18-0-250" class="i">+            }.toByteArray()
</a><a href="#h18-0-251" id="h18-0-251" class="i">+        }
</a><a href="#h18-0-252" id="h18-0-252" class="i">+
</a><a href="#h18-0-253" id="h18-0-253" class="i">+        // decrypt messages
</a><a href="#h18-0-254" id="h18-0-254" class="i">+        reader.followPath(2, 1) {
</a><a href="#h18-0-255" id="h18-0-255" class="i">+            val messageTypeId = getVarInt(1)?.toInt() ?: return@followPath
</a><a href="#h18-0-256" id="h18-0-256" class="i">+            val isMe = context.database.myUserId == senderId
</a><a href="#h18-0-257" id="h18-0-257" class="i">+            val conversationParticipants by lazy {
</a><a href="#h18-0-258" id="h18-0-258" class="i">+                getE2EParticipants(conversationId)
</a><a href="#h18-0-259" id="h18-0-259" class="i">+            }
</a><a href="#h18-0-260" id="h18-0-260" class="i">+
</a><a href="#h18-0-261" id="h18-0-261" class="i">+            if (messageTypeId == ENCRYPTED_MESSAGE_ID) {
</a><a href="#h18-0-262" id="h18-0-262" class="i">+                runCatching {
</a><a href="#h18-0-263" id="h18-0-263" class="i">+                    replaceMessageText(&quot;Cannot find a key to decrypt this message.&quot;)
</a><a href="#h18-0-264" id="h18-0-264" class="i">+                    eachBuffer(2) {
</a><a href="#h18-0-265" id="h18-0-265" class="i">+                        val participantIdHash = getByteArray(1) ?: return@eachBuffer
</a><a href="#h18-0-266" id="h18-0-266" class="i">+                        val iv = getByteArray(2) ?: return@eachBuffer
</a><a href="#h18-0-267" id="h18-0-267" class="i">+                        val ciphertext = getByteArray(3) ?: return@eachBuffer
</a><a href="#h18-0-268" id="h18-0-268" class="i">+
</a><a href="#h18-0-269" id="h18-0-269" class="i">+                        if (isMe) {
</a><a href="#h18-0-270" id="h18-0-270" class="i">+                            if (conversationParticipants.isEmpty()) return@eachBuffer
</a><a href="#h18-0-271" id="h18-0-271" class="i">+                            val participantId = conversationParticipants.firstOrNull { participantIdHash.contentEquals(hashParticipantId(it, iv)) } ?: return@eachBuffer
</a><a href="#h18-0-272" id="h18-0-272" class="i">+                            messageContent.content = e2eeInterface.decryptMessage(participantId, ciphertext, iv)
</a><a href="#h18-0-273" id="h18-0-273" class="i">+                            return@eachBuffer
</a><a href="#h18-0-274" id="h18-0-274" class="i">+                        }
</a><a href="#h18-0-275" id="h18-0-275" class="i">+
</a><a href="#h18-0-276" id="h18-0-276" class="i">+                        if (!participantIdHash.contentEquals(hashParticipantId(context.database.myUserId, iv))) return@eachBuffer
</a><a href="#h18-0-277" id="h18-0-277" class="i">+
</a><a href="#h18-0-278" id="h18-0-278" class="i">+                        messageContent.content = e2eeInterface.decryptMessage(senderId, ciphertext, iv)
</a><a href="#h18-0-279" id="h18-0-279" class="i">+                    }
</a><a href="#h18-0-280" id="h18-0-280" class="i">+
</a><a href="#h18-0-281" id="h18-0-281" class="i">+                    // fix content type
</a><a href="#h18-0-282" id="h18-0-282" class="i">+                    messageContent.contentType?.also {
</a><a href="#h18-0-283" id="h18-0-283" class="i">+                        messageContent.contentType = fixContentType(it, reader)
</a><a href="#h18-0-284" id="h18-0-284" class="i">+                    }
</a><a href="#h18-0-285" id="h18-0-285" class="i">+                }.onFailure {
</a><a href="#h18-0-286" id="h18-0-286" class="i">+                    context.log.error(&quot;Failed to decrypt message id: $messageId&quot;, it)
</a><a href="#h18-0-287" id="h18-0-287" class="i">+                    messageContent.contentType = ContentType.CHAT
</a><a href="#h18-0-288" id="h18-0-288" class="i">+                    messageContent.content = ProtoWriter().apply {
</a><a href="#h18-0-289" id="h18-0-289" class="i">+                        from(2) {
</a><a href="#h18-0-290" id="h18-0-290" class="i">+                            addString(1, &quot;Failed to decrypt message, id=$messageId. Check logcat for more details.&quot;)
</a><a href="#h18-0-291" id="h18-0-291" class="i">+                        }
</a><a href="#h18-0-292" id="h18-0-292" class="i">+                    }.toByteArray()
</a><a href="#h18-0-293" id="h18-0-293" class="i">+                }
</a><a href="#h18-0-294" id="h18-0-294" class="i">+
</a><a href="#h18-0-295" id="h18-0-295" class="i">+                return@followPath
</a><a href="#h18-0-296" id="h18-0-296" class="i">+            }
</a><a href="#h18-0-297" id="h18-0-297" class="i">+
</a><a href="#h18-0-298" id="h18-0-298" class="i">+            val payload = getByteArray(2, 2) ?: return@followPath
</a><a href="#h18-0-299" id="h18-0-299" class="i">+
</a><a href="#h18-0-300" id="h18-0-300" class="i">+            if (senderId == context.database.myUserId) {
</a><a href="#h18-0-301" id="h18-0-301" class="i">+                when (messageTypeId) {
</a><a href="#h18-0-302" id="h18-0-302" class="i">+                    REQUEST_PK_MESSAGE_ID -&gt; {
</a><a href="#h18-0-303" id="h18-0-303" class="i">+                        replaceMessageText(&quot;[Key exchange request]&quot;)
</a><a href="#h18-0-304" id="h18-0-304" class="i">+                    }
</a><a href="#h18-0-305" id="h18-0-305" class="i">+                    RESPONSE_SK_MESSAGE_ID -&gt; {
</a><a href="#h18-0-306" id="h18-0-306" class="i">+                        replaceMessageText(&quot;[Key exchange response]&quot;)
</a><a href="#h18-0-307" id="h18-0-307" class="i">+                    }
</a><a href="#h18-0-308" id="h18-0-308" class="i">+                }
</a><a href="#h18-0-309" id="h18-0-309" class="i">+                return@followPath
</a><a href="#h18-0-310" id="h18-0-310" class="i">+            }
</a><a href="#h18-0-311" id="h18-0-311" class="i">+
</a><a href="#h18-0-312" id="h18-0-312" class="i">+            when (messageTypeId) {
</a><a href="#h18-0-313" id="h18-0-313" class="i">+                REQUEST_PK_MESSAGE_ID -&gt; {
</a><a href="#h18-0-314" id="h18-0-314" class="i">+                    pkRequests[messageId] = payload
</a><a href="#h18-0-315" id="h18-0-315" class="i">+                    replaceMessageText(&quot;You just received a public key request. Click below to accept it.&quot;)
</a><a href="#h18-0-316" id="h18-0-316" class="i">+                }
</a><a href="#h18-0-317" id="h18-0-317" class="i">+                RESPONSE_SK_MESSAGE_ID -&gt; {
</a><a href="#h18-0-318" id="h18-0-318" class="i">+                    secretResponses[messageId] = payload
</a><a href="#h18-0-319" id="h18-0-319" class="i">+                    replaceMessageText(&quot;Your friend just accepted your public key. Click below to accept the secret.&quot;)
</a><a href="#h18-0-320" id="h18-0-320" class="i">+                }
</a><a href="#h18-0-321" id="h18-0-321" class="i">+            }
</a><a href="#h18-0-322" id="h18-0-322" class="i">+        }
</a><a href="#h18-0-323" id="h18-0-323" class="i">+    }
</a><a href="#h18-0-324" id="h18-0-324" class="i">+
</a><a href="#h18-0-325" id="h18-0-325" class="i">+    override fun asyncInit() {
</a><a href="#h18-0-326" id="h18-0-326" class="i">+        if (!isEnabled) return
</a><a href="#h18-0-327" id="h18-0-327" class="i">+        // trick to disable fidelius encryption
</a><a href="#h18-0-328" id="h18-0-328" class="i">+        context.event.subscribe(SendMessageWithContentEvent::class) { param -&gt;
</a><a href="#h18-0-329" id="h18-0-329" class="i">+            val messageContent = param.messageContent
</a><a href="#h18-0-330" id="h18-0-330" class="i">+            val destinations = param.destinations
</a><a href="#h18-0-331" id="h18-0-331" class="i">+            if (destinations.conversations.size != 1 || destinations.stories.isNotEmpty()) return@subscribe
</a><a href="#h18-0-332" id="h18-0-332" class="i">+
</a><a href="#h18-0-333" id="h18-0-333" class="i">+            if (!getState(destinations.conversations.first().toString())) return@subscribe
</a><a href="#h18-0-334" id="h18-0-334" class="i">+
</a><a href="#h18-0-335" id="h18-0-335" class="i">+            if (messageContent.contentType == ContentType.SNAP) {
</a><a href="#h18-0-336" id="h18-0-336" class="i">+                messageContent.contentType = ContentType.EXTERNAL_MEDIA
</a><a href="#h18-0-337" id="h18-0-337" class="i">+            }
</a><a href="#h18-0-338" id="h18-0-338" class="i">+
</a><a href="#h18-0-339" id="h18-0-339" class="i">+            if (messageContent.contentType == ContentType.CHAT) {
</a><a href="#h18-0-340" id="h18-0-340" class="i">+                messageContent.contentType = ContentType.SHARE
</a><a href="#h18-0-341" id="h18-0-341" class="i">+            }
</a><a href="#h18-0-342" id="h18-0-342" class="i">+        }
</a><a href="#h18-0-343" id="h18-0-343" class="i">+    }
</a><a href="#h18-0-344" id="h18-0-344" class="i">+
</a><a href="#h18-0-345" id="h18-0-345" class="i">+    override fun init() {
</a><a href="#h18-0-346" id="h18-0-346" class="i">+        if (!isEnabled) return
</a><a href="#h18-0-347" id="h18-0-347" class="i">+        context.event.subscribe(UnaryCallEvent::class) { event -&gt;
</a><a href="#h18-0-348" id="h18-0-348" class="i">+            if (event.uri != &quot;/messagingcoreservice.MessagingCoreService/CreateContentMessage&quot;) return@subscribe
</a><a href="#h18-0-349" id="h18-0-349" class="i">+            val protoReader = ProtoReader(event.buffer)
</a><a href="#h18-0-350" id="h18-0-350" class="i">+
</a><a href="#h18-0-351" id="h18-0-351" class="i">+            val conversationIds = mutableListOf&lt;SnapUUID&gt;()
</a><a href="#h18-0-352" id="h18-0-352" class="i">+            protoReader.eachBuffer(3) {
</a><a href="#h18-0-353" id="h18-0-353" class="i">+                conversationIds.add(SnapUUID.fromBytes(getByteArray(1, 1, 1) ?: return@eachBuffer))
</a><a href="#h18-0-354" id="h18-0-354" class="i">+            }
</a><a href="#h18-0-355" id="h18-0-355" class="i">+
</a><a href="#h18-0-356" id="h18-0-356" class="i">+            if (conversationIds.any { !getState(it.toString()) }) {
</a><a href="#h18-0-357" id="h18-0-357" class="i">+                context.log.debug(&quot;Skipping encryption for conversation ids: ${conversationIds.joinToString(&quot;, &quot;)}&quot;)
</a><a href="#h18-0-358" id="h18-0-358" class="i">+                return@subscribe
</a><a href="#h18-0-359" id="h18-0-359" class="i">+            }
</a><a href="#h18-0-360" id="h18-0-360" class="i">+
</a><a href="#h18-0-361" id="h18-0-361" class="i">+            val participantsIds = conversationIds.map { getE2EParticipants(it.toString()) }.flatten().distinct()
</a><a href="#h18-0-362" id="h18-0-362" class="i">+
</a><a href="#h18-0-363" id="h18-0-363" class="i">+            if (participantsIds.isEmpty()) {
</a><a href="#h18-0-364" id="h18-0-364" class="i">+                context.longToast(&quot;You don&#39;t have any friends in this conversation to encrypt messages with!&quot;)
</a><a href="#h18-0-365" id="h18-0-365" class="i">+                event.canceled = true
</a><a href="#h18-0-366" id="h18-0-366" class="i">+                return@subscribe
</a><a href="#h18-0-367" id="h18-0-367" class="i">+            }
</a><a href="#h18-0-368" id="h18-0-368" class="i">+            val messageReader = protoReader.followPath(4) ?: return@subscribe
</a><a href="#h18-0-369" id="h18-0-369" class="i">+
</a><a href="#h18-0-370" id="h18-0-370" class="i">+            if (messageReader.getVarInt(4, 2, 1, 1) != null) {
</a><a href="#h18-0-371" id="h18-0-371" class="i">+                return@subscribe
</a><a href="#h18-0-372" id="h18-0-372" class="i">+            }
</a><a href="#h18-0-373" id="h18-0-373" class="i">+
</a><a href="#h18-0-374" id="h18-0-374" class="i">+            event.buffer = ProtoEditor(event.buffer).apply {
</a><a href="#h18-0-375" id="h18-0-375" class="i">+                val contentType = fixContentType(ContentType.fromId(messageReader.getVarInt(2)?.toInt() ?: -1), messageReader.followPath(4) ?: return@apply)
</a><a href="#h18-0-376" id="h18-0-376" class="i">+                val messageContent = messageReader.getByteArray(4) ?: return@apply
</a><a href="#h18-0-377" id="h18-0-377" class="i">+
</a><a href="#h18-0-378" id="h18-0-378" class="i">+                runCatching {
</a><a href="#h18-0-379" id="h18-0-379" class="i">+                    edit(4) {
</a><a href="#h18-0-380" id="h18-0-380" class="i">+                        //set message content type
</a><a href="#h18-0-381" id="h18-0-381" class="i">+                        remove(2)
</a><a href="#h18-0-382" id="h18-0-382" class="i">+                        addVarInt(2, contentType.id)
</a><a href="#h18-0-383" id="h18-0-383" class="i">+
</a><a href="#h18-0-384" id="h18-0-384" class="i">+                        //set encrypted content
</a><a href="#h18-0-385" id="h18-0-385" class="i">+                        remove(4)
</a><a href="#h18-0-386" id="h18-0-386" class="i">+                        add(4) {
</a><a href="#h18-0-387" id="h18-0-387" class="i">+                            from(2) {
</a><a href="#h18-0-388" id="h18-0-388" class="i">+                                from(1) {
</a><a href="#h18-0-389" id="h18-0-389" class="i">+                                    addVarInt(1, ENCRYPTED_MESSAGE_ID)
</a><a href="#h18-0-390" id="h18-0-390" class="i">+                                    participantsIds.forEach { participantId -&gt;
</a><a href="#h18-0-391" id="h18-0-391" class="i">+                                        val encryptedMessage = e2eeInterface.encryptMessage(participantId,
</a><a href="#h18-0-392" id="h18-0-392" class="i">+                                            messageContent
</a><a href="#h18-0-393" id="h18-0-393" class="i">+                                        ) ?: run {
</a><a href="#h18-0-394" id="h18-0-394" class="i">+                                            context.log.error(&quot;Failed to encrypt message for $participantId&quot;)
</a><a href="#h18-0-395" id="h18-0-395" class="i">+                                            return@forEach
</a><a href="#h18-0-396" id="h18-0-396" class="i">+                                        }
</a><a href="#h18-0-397" id="h18-0-397" class="i">+                                        context.log.debug(&quot;encrypted message size = ${encryptedMessage.ciphertext.size} for $participantId&quot;)
</a><a href="#h18-0-398" id="h18-0-398" class="i">+                                        from(2) {
</a><a href="#h18-0-399" id="h18-0-399" class="i">+                                            // participantId is hashed with iv to prevent leaking it when sending to multiple conversations
</a><a href="#h18-0-400" id="h18-0-400" class="i">+                                            addBuffer(1, hashParticipantId(participantId, encryptedMessage.iv))
</a><a href="#h18-0-401" id="h18-0-401" class="i">+                                            addBuffer(2, encryptedMessage.iv)
</a><a href="#h18-0-402" id="h18-0-402" class="i">+                                            addBuffer(3, encryptedMessage.ciphertext)
</a><a href="#h18-0-403" id="h18-0-403" class="i">+                                        }
</a><a href="#h18-0-404" id="h18-0-404" class="i">+                                    }
</a><a href="#h18-0-405" id="h18-0-405" class="i">+                                }
</a><a href="#h18-0-406" id="h18-0-406" class="i">+                            }
</a><a href="#h18-0-407" id="h18-0-407" class="i">+                        }
</a><a href="#h18-0-408" id="h18-0-408" class="i">+                    }
</a><a href="#h18-0-409" id="h18-0-409" class="i">+                }.onFailure {
</a><a href="#h18-0-410" id="h18-0-410" class="i">+                    event.canceled = true
</a><a href="#h18-0-411" id="h18-0-411" class="i">+                    context.log.error(&quot;Failed to encrypt message&quot;, it)
</a><a href="#h18-0-412" id="h18-0-412" class="i">+                    context.longToast(&quot;Failed to encrypt message! Check logcat for more details.&quot;)
</a><a href="#h18-0-413" id="h18-0-413" class="i">+                }
</a><a href="#h18-0-414" id="h18-0-414" class="i">+            }.toByteArray()
</a><a href="#h18-0-415" id="h18-0-415" class="i">+        }
</a><a href="#h18-0-416" id="h18-0-416" class="i">+
</a><a href="#h18-0-417" id="h18-0-417" class="i">+        context.classCache.message.hookConstructor(HookStage.AFTER) { param -&gt;
</a><a href="#h18-0-418" id="h18-0-418" class="i">+            val message = Message(param.thisObject())
</a><a href="#h18-0-419" id="h18-0-419" class="i">+            val conversationId = message.messageDescriptor.conversationId.toString()
</a><a href="#h18-0-420" id="h18-0-420" class="i">+            messageHook(
</a><a href="#h18-0-421" id="h18-0-421" class="i">+                conversationId = conversationId,
</a><a href="#h18-0-422" id="h18-0-422" class="i">+                messageId = message.messageDescriptor.messageId,
</a><a href="#h18-0-423" id="h18-0-423" class="i">+                senderId = message.senderId.toString(),
</a><a href="#h18-0-424" id="h18-0-424" class="i">+                messageContent = message.messageContent
</a><a href="#h18-0-425" id="h18-0-425" class="i">+            )
</a><a href="#h18-0-426" id="h18-0-426" class="i">+            message.messageContent.instanceNonNull()
</a><a href="#h18-0-427" id="h18-0-427" class="i">+                .getObjectField(&quot;mQuotedMessage&quot;)
</a><a href="#h18-0-428" id="h18-0-428" class="i">+                ?.getObjectField(&quot;mContent&quot;)
</a><a href="#h18-0-429" id="h18-0-429" class="i">+                ?.also { quotedMessage -&gt;
</a><a href="#h18-0-430" id="h18-0-430" class="i">+                messageHook(
</a><a href="#h18-0-431" id="h18-0-431" class="i">+                    conversationId = conversationId,
</a><a href="#h18-0-432" id="h18-0-432" class="i">+                    messageId = quotedMessage.getObjectField(&quot;mMessageId&quot;)?.toString()?.toLong() ?: return@also,
</a><a href="#h18-0-433" id="h18-0-433" class="i">+                    senderId = SnapUUID(quotedMessage.getObjectField(&quot;mSenderId&quot;)).toString(),
</a><a href="#h18-0-434" id="h18-0-434" class="i">+                    messageContent = MessageContent(quotedMessage)
</a><a href="#h18-0-435" id="h18-0-435" class="i">+                )
</a><a href="#h18-0-436" id="h18-0-436" class="i">+            }
</a><a href="#h18-0-437" id="h18-0-437" class="i">+        }
</a><a href="#h18-0-438" id="h18-0-438" class="i">+    }
</a><a href="#h18-0-439" id="h18-0-439" class="i">+
</a><a href="#h18-0-440" id="h18-0-440" class="i">+    override fun getRuleState() = RuleState.WHITELIST
</a><a href="#h18-0-441" id="h18-0-441" class="i">+}</a><a href="#h18-0-442" id="h18-0-442" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h19" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/spying/MessageLogger.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/spying/MessageLogger.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/spying/MessageLogger.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/spying/MessageLogger.kt</a></b>
<a href="#h19-0" id="h19-0" class="h">@@ -2,9 +2,9 @@ package me.rhunk.snapenhance.features.impl.spying
</a> 
 import android.graphics.drawable.ColorDrawable
 import android.os.DeadObjectException
<a href="#h19-0-3" id="h19-0-3" class="d">-import android.view.View
</a> import com.google.gson.JsonObject
 import com.google.gson.JsonParser
<a href="#h19-0-6" id="h19-0-6" class="i">+import me.rhunk.snapenhance.core.event.events.impl.BindViewEvent
</a> import me.rhunk.snapenhance.data.ContentType
 import me.rhunk.snapenhance.data.MessageState
 import me.rhunk.snapenhance.data.wrapper.impl.Message
<a href="#h19-1" id="h19-1" class="h">@@ -12,8 +12,6 @@ import me.rhunk.snapenhance.features.Feature
</a> import me.rhunk.snapenhance.features.FeatureLoadParams
 import me.rhunk.snapenhance.hook.HookStage
 import me.rhunk.snapenhance.hook.Hooker
<a href="#h19-1-3" id="h19-1-3" class="d">-import me.rhunk.snapenhance.hook.hook
</a><a href="#h19-1-4" id="h19-1-4" class="d">-import me.rhunk.snapenhance.hook.hookConstructor
</a> import java.util.concurrent.Executors
 import kotlin.time.ExperimentalTime
 import kotlin.time.measureTime
<a href="#h19-2" id="h19-2" class="h">@@ -33,6 +31,7 @@ class MessageLogger : Feature(&quot;MessageLogger&quot;,
</a>     companion object {
         const val PREFETCH_MESSAGE_COUNT = 20
         const val PREFETCH_FEED_COUNT = 20
<a href="#h19-2-3" id="h19-2-3" class="i">+        const val DELETED_MESSAGE_COLOR = 0x2Eb71c1c
</a>     }
 
     private val isEnabled get() = context.config.messaging.messageLogger.get()
<a href="#h19-3" id="h19-3" class="h">@@ -154,40 +153,16 @@ class MessageLogger : Feature(&quot;MessageLogger&quot;,
</a>     override fun onActivityCreate() {
         if (!isEnabled) return
 
<a href="#h19-3-3" id="h19-3-3" class="d">-        val viewBinderMappings = context.mappings.getMappedMap(&quot;ViewBinder&quot;)
</a><a href="#h19-3-4" id="h19-3-4" class="d">-        val cachedHooks = mutableListOf&lt;String&gt;()
</a><a href="#h19-3-5" id="h19-3-5" class="d">-
</a><a href="#h19-3-6" id="h19-3-6" class="d">-        fun cacheHook(clazz: Class&lt;*&gt;, block: Class&lt;*&gt;.() -&gt; Unit) {
</a><a href="#h19-3-7" id="h19-3-7" class="d">-            if (!cachedHooks.contains(clazz.name)) {
</a><a href="#h19-3-8" id="h19-3-8" class="d">-                clazz.block()
</a><a href="#h19-3-9" id="h19-3-9" class="d">-                cachedHooks.add(clazz.name)
</a><a href="#h19-3-10" id="h19-3-10" class="d">-            }
</a><a href="#h19-3-11" id="h19-3-11" class="d">-        }
</a><a href="#h19-3-12" id="h19-3-12" class="d">-
</a><a href="#h19-3-13" id="h19-3-13" class="d">-        findClass(viewBinderMappings[&quot;class&quot;].toString()).hookConstructor(HookStage.AFTER) { methodParam -&gt;
</a><a href="#h19-3-14" id="h19-3-14" class="d">-            cacheHook(
</a><a href="#h19-3-15" id="h19-3-15" class="d">-                methodParam.thisObject&lt;Any&gt;()::class.java
</a><a href="#h19-3-16" id="h19-3-16" class="d">-            ) {
</a><a href="#h19-3-17" id="h19-3-17" class="d">-                hook(viewBinderMappings[&quot;bindMethod&quot;].toString(), HookStage.BEFORE) bindViewMethod@{ param -&gt;
</a><a href="#h19-3-18" id="h19-3-18" class="d">-                    val instance = param.thisObject&lt;Any&gt;()
</a><a href="#h19-3-19" id="h19-3-19" class="d">-                    val model1 = param.arg&lt;Any&gt;(0).toString().also {
</a><a href="#h19-3-20" id="h19-3-20" class="d">-                        if (!it.startsWith(&quot;ChatViewModel&quot;)) return@bindViewMethod
</a><a href="#h19-3-21" id="h19-3-21" class="d">-                    }
</a><a href="#h19-3-22" id="h19-3-22" class="d">-
</a><a href="#h19-3-23" id="h19-3-23" class="d">-                    val messageId = model1.substringAfter(&quot;messageId=&quot;).substringBefore(&quot;,&quot;).split(&quot;:&quot;).let {
</a><a href="#h19-3-24" id="h19-3-24" class="d">-                        it[0] to it[2]
</a><a href="#h19-3-25" id="h19-3-25" class="d">-                    }
</a><a href="#h19-3-26" id="h19-3-26" class="d">-
</a><a href="#h19-3-27" id="h19-3-27" class="d">-                    getServerMessageIdentifier(messageId.first, messageId.second.toLong())?.let { serverMessageId -&gt;
</a><a href="#h19-3-28" id="h19-3-28" class="d">-                        if (!deletedMessageCache.contains(serverMessageId)) return@bindViewMethod
</a><a href="#h19-3-29" id="h19-3-29" class="d">-                    } ?: return@bindViewMethod
</a><a href="#h19-3-30" id="h19-3-30" class="d">-
</a><a href="#h19-3-31" id="h19-3-31" class="d">-                    val view = instance::class.java.methods.first {
</a><a href="#h19-3-32" id="h19-3-32" class="d">-                        it.name == viewBinderMappings[&quot;getViewMethod&quot;].toString()
</a><a href="#h19-3-33" id="h19-3-33" class="d">-                    }.invoke(instance) as? View ?: return@bindViewMethod
</a><a href="#h19-3-34" id="h19-3-34" class="d">-
</a><a href="#h19-3-35" id="h19-3-35" class="d">-                    view.foreground = ColorDrawable(0x1E90313e) // red with alpha
</a><a href="#h19-3-36" id="h19-3-36" class="i">+        context.event.subscribe(BindViewEvent::class) { event -&gt;
</a><a href="#h19-3-37" id="h19-3-37" class="i">+            event.chatMessage { conversationId, messageId -&gt;
</a><a href="#h19-3-38" id="h19-3-38" class="i">+                val foreground = event.view.foreground
</a><a href="#h19-3-39" id="h19-3-39" class="i">+                if (foreground is ColorDrawable &amp;&amp; foreground.color == DELETED_MESSAGE_COLOR) {
</a><a href="#h19-3-40" id="h19-3-40" class="i">+                    event.view.foreground = null
</a>                 }
<a href="#h19-3-42" id="h19-3-42" class="i">+                getServerMessageIdentifier(conversationId, messageId.toLong())?.let { serverMessageId -&gt;
</a><a href="#h19-3-43" id="h19-3-43" class="i">+                    if (!deletedMessageCache.contains(serverMessageId)) return@chatMessage
</a><a href="#h19-3-44" id="h19-3-44" class="i">+                } ?: return@chatMessage
</a><a href="#h19-3-45" id="h19-3-45" class="i">+                event.view.foreground = ColorDrawable(DELETED_MESSAGE_COLOR) // red with alpha
</a>             }
         }
     }
<b>diff --git a/<a id="h20" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/manager/impl/FeatureManager.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/manager/impl/FeatureManager.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/manager/impl/FeatureManager.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/manager/impl/FeatureManager.kt</a></b>
<a href="#h20-0" id="h20-0" class="h">@@ -2,7 +2,6 @@ package me.rhunk.snapenhance.manager.impl
</a> 
 import me.rhunk.snapenhance.ModContext
 import me.rhunk.snapenhance.core.Logger
<a href="#h20-0-3" id="h20-0-3" class="d">-import me.rhunk.snapenhance.features.impl.experiments.AESMessageEncryption
</a> import me.rhunk.snapenhance.features.Feature
 import me.rhunk.snapenhance.features.FeatureLoadParams
 import me.rhunk.snapenhance.features.MessagingRuleFeature
<a href="#h20-1" id="h20-1" class="h">@@ -54,7 +53,7 @@ class FeatureManager(private val context: ModContext) : Manager {
</a> 
     override fun init() {
         register(
<a href="#h20-1-3" id="h20-1-3" class="d">-            AESMessageEncryption::class,
</a><a href="#h20-1-4" id="h20-1-4" class="i">+            EndToEndEncryption::class,
</a>             ScopeSync::class,
             Messaging::class,
             MediaDownloader::class,
<b>diff --git a/<a id="h21" href="../file/gradle/libs.versions.toml.html">gradle/libs.versions.toml</a> b/<a href="../file/gradle/libs.versions.toml.html">gradle/libs.versions.toml</a></b>
<a href="#h21-0" id="h21-0" class="h">@@ -1,5 +1,6 @@
</a> [versions]
 agp = &quot;8.1.1&quot;
<a href="#h21-0-2" id="h21-0-2" class="i">+bcprov-jdk18on = &quot;1.76&quot;
</a> coil-compose = &quot;2.4.0&quot;
 junit = &quot;4.13.2&quot;
 kotlin = &quot;1.8.22&quot;
<a href="#h21-1" id="h21-1" class="h">@@ -26,6 +27,7 @@ androidx-material-icons-core = { module = &quot;androidx.compose.material:material-ic
</a> androidx-material-icons-extended = { module = &quot;androidx.compose.material:material-icons-extended&quot;, version.ref = &quot;material-icons-extended&quot; }
 androidx-material-ripple = { module = &quot;androidx.compose.material:material-ripple&quot;, version.ref = &quot;material-icons-core&quot; }
 androidx-navigation-compose = { module = &quot;androidx.navigation:navigation-compose&quot;, version.ref = &quot;navigation-compose&quot; }
<a href="#h21-1-3" id="h21-1-3" class="i">+bcprov-jdk18on = { module = &quot;org.bouncycastle:bcprov-jdk18on&quot;, version.ref = &quot;bcprov-jdk18on&quot; }
</a> coil-compose = { module = &quot;io.coil-kt:coil-compose&quot;, version.ref = &quot;coil-compose&quot; }
 coil-video = { module = &quot;io.coil-kt:coil-video&quot;, version.ref = &quot;coil-compose&quot; }
 coroutines = { group = &quot;org.jetbrains.kotlinx&quot;, name = &quot;kotlinx-coroutines-android&quot;, version.ref = &quot;kotlinx-coroutines-android&quot; }
</pre>
</div>
</body>
</html>
