<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>feat: experimental native hooks - SnapEnhance - An Xposed module offering an enhanced Snapchat experience
</title>
<link rel="icon" type="image/svg+xml" href="../../logo.png"/>
<link rel="alternate icon" href="../../favicon.png"/>
<link rel="alternate" type="application/atom+xml" title="SnapEnhance Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="SnapEnhance Atom Feed (tags)" href="../tags.xml" />
<link rel="stylesheet" type="text/css" href="../../style.css" />
<link rel="stylesheet" type="text/css" href="../../fonts.css" />
</head>
<body>
<div id="head"><table><tr><td><a class="logo" href="../../"><img src="../../logo.png" alt="" width="32" height="32" /></a></td><td><strong>SnapEnhance</strong><span class="desc"> - An Xposed module offering an enhanced Snapchat experience
</span>
</td></tr></table>
<p><a href="../about.html">About</a> | <a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/LICENSE.html">License</a></p>
</div>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/c0225919e977a3e29a46737b348babc3bfeae5b8.html">c0225919e977a3e29a46737b348babc3bfeae5b8</a>
<b>parent</b> <a href="../commit/b004f92b9cd9751fa0f22403b8b07ae426cd58cd.html">b004f92b9cd9751fa0f22403b8b07ae426cd58cd</a>
<b>Author:</b> rhunk &lt;<a href="mailto:101876869+rhunk@users.noreply.github.com">101876869+rhunk@users.noreply.github.com</a>&gt;
<b>Date:</b>   Fri, 25 Aug 2023 19:44:42 +0200

feat: experimental native hooks

<b>Diffstat:</b>
<table><tr><td class="A">A</td><td><a href="#h0">.gitmodules</a></td><td> | </td><td class="num">3</td><td><span class="i">+++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">core/build.gradle.kts</a></td><td> | </td><td class="num">1</td><td><span class="i">+</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h2">core/src/main/assets/lang/en_US.json</a></td><td> | </td><td class="num">4</td><td><span class="i">++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h3">core/src/main/kotlin/me/rhunk/snapenhance/ModContext.kt</a></td><td> | </td><td class="num">13</td><td><span class="i">+++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h4">core/src/main/kotlin/me/rhunk/snapenhance/SnapEnhance.kt</a></td><td> | </td><td class="num">6</td><td><span class="i">++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h5">core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/Global.kt</a></td><td> | </td><td class="num">1</td><td><span class="i">+</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h6">core/src/main/kotlin/me/rhunk/snapenhance/core/eventbus/EventBus.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="A">A</td><td><a href="#h7">native/.gitignore</a></td><td> | </td><td class="num">2</td><td><span class="i">++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h8">native/build.gradle.kts</a></td><td> | </td><td class="num">28</td><td><span class="i">++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h9">native/jni/CMakeLists.txt</a></td><td> | </td><td class="num">16</td><td><span class="i">++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h10">native/jni/external/dobby</a></td><td> | </td><td class="num">1</td><td><span class="i">+</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h11">native/jni/src/config.h</a></td><td> | </td><td class="num">7</td><td><span class="i">+++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h12">native/jni/src/library.cpp</a></td><td> | </td><td class="num">76</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h13">native/jni/src/logger.h</a></td><td> | </td><td class="num">10</td><td><span class="i">++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h14">native/src/main/kotlin/me/rhunk/snapenhance/nativelib/NativeConfig.kt</a></td><td> | </td><td class="num">6</td><td><span class="i">++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h15">native/src/main/kotlin/me/rhunk/snapenhance/nativelib/NativeLib.kt</a></td><td> | </td><td class="num">11</td><td><span class="i">+++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h16">settings.gradle.kts</a></td><td> | </td><td class="num">4</td><td><span class="i">++</span><span class="d">--</span></td></tr>
</table></pre><pre>17 files changed, 188 insertions(+), 3 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/.gitmodules.html">.gitmodules</a> b/<a href="../file/.gitmodules.html">.gitmodules</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -0,0 +1,3 @@
</a><a href="#h0-0-0" id="h0-0-0" class="i">+[submodule &quot;dobby&quot;]
</a><a href="#h0-0-1" id="h0-0-1" class="i">+	path = native/jni/external/dobby
</a><a href="#h0-0-2" id="h0-0-2" class="i">+	url = https://github.com/jmpews/Dobby
</a><b>diff --git a/<a id="h1" href="../file/core/build.gradle.kts.html">core/build.gradle.kts</a> b/<a href="../file/core/build.gradle.kts.html">core/build.gradle.kts</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -42,4 +42,5 @@ dependencies {
</a>     implementation(libs.androidx.documentfile)
 
     implementation(project(&quot;:mapper&quot;))
<a href="#h1-0-3" id="h1-0-3" class="i">+    implementation(project(&quot;:native&quot;))
</a> } 
\ No newline at end of file
<b>diff --git a/<a id="h2" href="../file/core/src/main/assets/lang/en_US.json.html">core/src/main/assets/lang/en_US.json</a> b/<a href="../file/core/src/main/assets/lang/en_US.json.html">core/src/main/assets/lang/en_US.json</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -249,6 +249,10 @@
</a>                         &quot;name&quot;: &quot;Disable Metrics&quot;,
                         &quot;description&quot;: &quot;Disables some analytics data sent to Snapchat&quot;
                     },
<a href="#h2-0-3" id="h2-0-3" class="i">+                    &quot;disable_bitmoji&quot;: {
</a><a href="#h2-0-4" id="h2-0-4" class="i">+                        &quot;name&quot;: &quot;Disable Bitmoji&quot;,
</a><a href="#h2-0-5" id="h2-0-5" class="i">+                        &quot;description&quot;: &quot;Disables friends profile bitmoji for the whole app&quot;
</a><a href="#h2-0-6" id="h2-0-6" class="i">+                    },
</a>                     &quot;block_ads&quot;: {
                         &quot;name&quot;: &quot;Block Ads&quot;,
                         &quot;description&quot;: &quot;Prevent ads from being displayed&quot;
<b>diff --git a/<a id="h3" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/ModContext.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/ModContext.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/ModContext.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/ModContext.kt</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -21,6 +21,8 @@ import me.rhunk.snapenhance.database.DatabaseAccess
</a> import me.rhunk.snapenhance.features.Feature
 import me.rhunk.snapenhance.manager.impl.ActionManager
 import me.rhunk.snapenhance.manager.impl.FeatureManager
<a href="#h3-0-3" id="h3-0-3" class="i">+import me.rhunk.snapenhance.nativelib.NativeConfig
</a><a href="#h3-0-4" id="h3-0-4" class="i">+import me.rhunk.snapenhance.nativelib.NativeLib
</a> import me.rhunk.snapenhance.util.download.HttpServer
 import java.util.concurrent.ExecutorService
 import java.util.concurrent.Executors
<a href="#h3-1" id="h3-1" class="h">@@ -44,6 +46,7 @@ class ModContext {
</a>     val config by modConfig
     val event = EventBus(this)
     val eventDispatcher = EventDispatcher(this)
<a href="#h3-1-3" id="h3-1-3" class="i">+    val native = NativeLib()
</a> 
     val translation = LocaleWrapper()
     val features = FeatureManager(this)
<a href="#h3-2" id="h3-2" class="h">@@ -121,6 +124,16 @@ class ModContext {
</a> 
     fun reloadConfig() {
         modConfig.loadFromBridge(bridgeClient)
<a href="#h3-2-3" id="h3-2-3" class="i">+        runCatching {
</a><a href="#h3-2-4" id="h3-2-4" class="i">+            native.loadConfig(
</a><a href="#h3-2-5" id="h3-2-5" class="i">+                NativeConfig(
</a><a href="#h3-2-6" id="h3-2-6" class="i">+                    disableBitmoji = config.global.disableBitmoji.get(),
</a><a href="#h3-2-7" id="h3-2-7" class="i">+                    disableMetrics = config.global.disableMetrics.get()
</a><a href="#h3-2-8" id="h3-2-8" class="i">+                )
</a><a href="#h3-2-9" id="h3-2-9" class="i">+            )
</a><a href="#h3-2-10" id="h3-2-10" class="i">+        }.onFailure {
</a><a href="#h3-2-11" id="h3-2-11" class="i">+            Logger.xposedLog(&quot;Failed to load native config&quot;, it)
</a><a href="#h3-2-12" id="h3-2-12" class="i">+        }
</a>     }
 
     fun getConfigLocale(): String {
<b>diff --git a/<a id="h4" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/SnapEnhance.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/SnapEnhance.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/SnapEnhance.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/SnapEnhance.kt</a></b>
<a href="#h4-0" id="h4-0" class="h">@@ -97,6 +97,12 @@ class SnapEnhance {
</a>     private suspend fun init() {
         measureTime {
             with(appContext) {
<a href="#h4-0-3" id="h4-0-3" class="i">+                runCatching {
</a><a href="#h4-0-4" id="h4-0-4" class="i">+                    native.init()
</a><a href="#h4-0-5" id="h4-0-5" class="i">+                }.onFailure {
</a><a href="#h4-0-6" id="h4-0-6" class="i">+                    Logger.xposedLog(&quot;Failed to init native&quot;, it)
</a><a href="#h4-0-7" id="h4-0-7" class="i">+                    return
</a><a href="#h4-0-8" id="h4-0-8" class="i">+                }
</a>                 reloadConfig()
                 withContext(appContext.coroutineDispatcher) {
                     translation.userLocale = getConfigLocale()
<b>diff --git a/<a id="h5" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/Global.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/Global.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/Global.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/Global.kt</a></b>
<a href="#h5-0" id="h5-0" class="h">@@ -8,6 +8,7 @@ class Global : ConfigContainer() {
</a>     val snapchatPlus = boolean(&quot;snapchat_plus&quot;) { addNotices(FeatureNotice.MAY_BAN) }
     val autoUpdater = unique(&quot;auto_updater&quot;, &quot;EVERY_LAUNCH&quot;, &quot;DAILY&quot;, &quot;WEEKLY&quot;).apply { set(&quot;DAILY&quot;) }
     val disableMetrics = boolean(&quot;disable_metrics&quot;)
<a href="#h5-0-3" id="h5-0-3" class="i">+    val disableBitmoji = boolean(&quot;disable_bitmoji&quot;) { addNotices(FeatureNotice.UNSTABLE) }
</a>     val blockAds = boolean(&quot;block_ads&quot;)
     val disableVideoLengthRestrictions = boolean(&quot;disable_video_length_restrictions&quot;) { addNotices(FeatureNotice.MAY_BAN) }
     val disableGooglePlayDialogs = boolean(&quot;disable_google_play_dialogs&quot;)
<b>diff --git a/<a id="h6" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/eventbus/EventBus.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/eventbus/EventBus.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/eventbus/EventBus.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/eventbus/EventBus.kt</a></b>
<a href="#h6-0" id="h6-0" class="h">@@ -56,7 +56,7 @@ class EventBus(
</a> 
         event.context = context
 
<a href="#h6-0-3" id="h6-0-3" class="d">-        subscribers[event::class]?.forEach { listener -&gt;
</a><a href="#h6-0-4" id="h6-0-4" class="i">+        subscribers[event::class]?.toTypedArray()?.forEach { listener -&gt;
</a>             @Suppress(&quot;UNCHECKED_CAST&quot;)
             runCatching {
                 (listener as IListener&lt;T&gt;).handle(event)
<b>diff --git a/<a id="h7" href="../file/native/.gitignore.html">native/.gitignore</a> b/<a href="../file/native/.gitignore.html">native/.gitignore</a></b>
<a href="#h7-0" id="h7-0" class="h">@@ -0,0 +1 @@
</a><a href="#h7-0-0" id="h7-0-0" class="i">+/build</a><a href="#h7-0-1" id="h7-0-1" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h8" href="../file/native/build.gradle.kts.html">native/build.gradle.kts</a> b/<a href="../file/native/build.gradle.kts.html">native/build.gradle.kts</a></b>
<a href="#h8-0" id="h8-0" class="h">@@ -0,0 +1,28 @@
</a><a href="#h8-0-0" id="h8-0-0" class="i">+@Suppress(&quot;DSL_SCOPE_VIOLATION&quot;) // TODO: Remove once KTIJ-19369 is fixed
</a><a href="#h8-0-1" id="h8-0-1" class="i">+plugins {
</a><a href="#h8-0-2" id="h8-0-2" class="i">+    alias(libs.plugins.androidLibrary)
</a><a href="#h8-0-3" id="h8-0-3" class="i">+    alias(libs.plugins.kotlinAndroid)
</a><a href="#h8-0-4" id="h8-0-4" class="i">+}
</a><a href="#h8-0-5" id="h8-0-5" class="i">+
</a><a href="#h8-0-6" id="h8-0-6" class="i">+android {
</a><a href="#h8-0-7" id="h8-0-7" class="i">+    namespace = &quot;me.rhunk.snapenhance.nativelib&quot;
</a><a href="#h8-0-8" id="h8-0-8" class="i">+    compileSdk = 34
</a><a href="#h8-0-9" id="h8-0-9" class="i">+
</a><a href="#h8-0-10" id="h8-0-10" class="i">+    defaultConfig {
</a><a href="#h8-0-11" id="h8-0-11" class="i">+        externalNativeBuild {
</a><a href="#h8-0-12" id="h8-0-12" class="i">+            cmake {
</a><a href="#h8-0-13" id="h8-0-13" class="i">+                cppFlags(&quot;&quot;)
</a><a href="#h8-0-14" id="h8-0-14" class="i">+            }
</a><a href="#h8-0-15" id="h8-0-15" class="i">+        }
</a><a href="#h8-0-16" id="h8-0-16" class="i">+    }
</a><a href="#h8-0-17" id="h8-0-17" class="i">+
</a><a href="#h8-0-18" id="h8-0-18" class="i">+    externalNativeBuild {
</a><a href="#h8-0-19" id="h8-0-19" class="i">+        cmake {
</a><a href="#h8-0-20" id="h8-0-20" class="i">+            path(&quot;jni/CMakeLists.txt&quot;)
</a><a href="#h8-0-21" id="h8-0-21" class="i">+            version = &quot;3.22.1&quot;
</a><a href="#h8-0-22" id="h8-0-22" class="i">+        }
</a><a href="#h8-0-23" id="h8-0-23" class="i">+    }
</a><a href="#h8-0-24" id="h8-0-24" class="i">+    kotlinOptions {
</a><a href="#h8-0-25" id="h8-0-25" class="i">+        jvmTarget = &quot;1.8&quot;
</a><a href="#h8-0-26" id="h8-0-26" class="i">+    }
</a><a href="#h8-0-27" id="h8-0-27" class="i">+}
</a><b>diff --git a/<a id="h9" href="../file/native/jni/CMakeLists.txt.html">native/jni/CMakeLists.txt</a> b/<a href="../file/native/jni/CMakeLists.txt.html">native/jni/CMakeLists.txt</a></b>
<a href="#h9-0" id="h9-0" class="h">@@ -0,0 +1,16 @@
</a><a href="#h9-0-0" id="h9-0-0" class="i">+cmake_minimum_required(VERSION 3.22.1)
</a><a href="#h9-0-1" id="h9-0-1" class="i">+
</a><a href="#h9-0-2" id="h9-0-2" class="i">+project(&quot;nativelib&quot;)
</a><a href="#h9-0-3" id="h9-0-3" class="i">+
</a><a href="#h9-0-4" id="h9-0-4" class="i">+set(DOBBY_GENERATE_SHARED OFF)
</a><a href="#h9-0-5" id="h9-0-5" class="i">+add_subdirectory(external/dobby)
</a><a href="#h9-0-6" id="h9-0-6" class="i">+
</a><a href="#h9-0-7" id="h9-0-7" class="i">+add_library(${CMAKE_PROJECT_NAME} SHARED
</a><a href="#h9-0-8" id="h9-0-8" class="i">+        src/library.cpp
</a><a href="#h9-0-9" id="h9-0-9" class="i">+    )
</a><a href="#h9-0-10" id="h9-0-10" class="i">+
</a><a href="#h9-0-11" id="h9-0-11" class="i">+target_link_libraries(${CMAKE_PROJECT_NAME}
</a><a href="#h9-0-12" id="h9-0-12" class="i">+        android
</a><a href="#h9-0-13" id="h9-0-13" class="i">+        log
</a><a href="#h9-0-14" id="h9-0-14" class="i">+        dobby_static
</a><a href="#h9-0-15" id="h9-0-15" class="i">+        )
</a><b>diff --git a/<a id="h10" href="../file/native/jni/external/dobby.html">native/jni/external/dobby</a> b/<a href="../file/native/jni/external/dobby.html">native/jni/external/dobby</a></b>
<a href="#h10-0" id="h10-0" class="h">@@ -0,0 +1 @@
</a><a href="#h10-0-0" id="h10-0-0" class="i">+Subproject commit b0176de574104726bb68dff3b77ee666300fc338
</a><b>diff --git a/<a id="h11" href="../file/native/jni/src/config.h.html">native/jni/src/config.h</a> b/<a href="../file/native/jni/src/config.h.html">native/jni/src/config.h</a></b>
<a href="#h11-0" id="h11-0" class="h">@@ -0,0 +1,6 @@
</a><a href="#h11-0-0" id="h11-0-0" class="i">+#pragma once
</a><a href="#h11-0-1" id="h11-0-1" class="i">+
</a><a href="#h11-0-2" id="h11-0-2" class="i">+typedef struct {
</a><a href="#h11-0-3" id="h11-0-3" class="i">+    bool disable_bitmoji;
</a><a href="#h11-0-4" id="h11-0-4" class="i">+    bool disable_metrics;
</a><a href="#h11-0-5" id="h11-0-5" class="i">+} native_config_t;</a><a href="#h11-0-6" id="h11-0-6" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h12" href="../file/native/jni/src/library.cpp.html">native/jni/src/library.cpp</a> b/<a href="../file/native/jni/src/library.cpp.html">native/jni/src/library.cpp</a></b>
<a href="#h12-0" id="h12-0" class="h">@@ -0,0 +1,76 @@
</a><a href="#h12-0-0" id="h12-0-0" class="i">+#include &lt;jni.h&gt;
</a><a href="#h12-0-1" id="h12-0-1" class="i">+#include &lt;string&gt;
</a><a href="#h12-0-2" id="h12-0-2" class="i">+#include &lt;dobby.h&gt;
</a><a href="#h12-0-3" id="h12-0-3" class="i">+#include &lt;sys/stat.h&gt;
</a><a href="#h12-0-4" id="h12-0-4" class="i">+#include &lt;unistd.h&gt;
</a><a href="#h12-0-5" id="h12-0-5" class="i">+#include &lt;fstream&gt;
</a><a href="#h12-0-6" id="h12-0-6" class="i">+#include &lt;vector&gt;
</a><a href="#h12-0-7" id="h12-0-7" class="i">+
</a><a href="#h12-0-8" id="h12-0-8" class="i">+#include &quot;logger.h&quot;
</a><a href="#h12-0-9" id="h12-0-9" class="i">+#include &quot;config.h&quot;
</a><a href="#h12-0-10" id="h12-0-10" class="i">+
</a><a href="#h12-0-11" id="h12-0-11" class="i">+static native_config_t *native_config;
</a><a href="#h12-0-12" id="h12-0-12" class="i">+
</a><a href="#h12-0-13" id="h12-0-13" class="i">+static auto fstat_original = fstat;
</a><a href="#h12-0-14" id="h12-0-14" class="i">+static int fstat_hook(int fd, struct stat *buf) {
</a><a href="#h12-0-15" id="h12-0-15" class="i">+    char name[256];
</a><a href="#h12-0-16" id="h12-0-16" class="i">+    memset(name, 0, 256);
</a><a href="#h12-0-17" id="h12-0-17" class="i">+    snprintf(name, sizeof(name), &quot;/proc/self/fd/%d&quot;, fd);
</a><a href="#h12-0-18" id="h12-0-18" class="i">+    readlink(name, name, sizeof(name));
</a><a href="#h12-0-19" id="h12-0-19" class="i">+
</a><a href="#h12-0-20" id="h12-0-20" class="i">+    auto fileName = std::string(name);
</a><a href="#h12-0-21" id="h12-0-21" class="i">+
</a><a href="#h12-0-22" id="h12-0-22" class="i">+    //prevent blizzardv2 metrics
</a><a href="#h12-0-23" id="h12-0-23" class="i">+    if (native_config-&gt;disable_metrics &amp;&amp; fileName.find(&quot;files/blizzardv2/queues&quot;) != std::string::npos) {
</a><a href="#h12-0-24" id="h12-0-24" class="i">+        unlink(name);
</a><a href="#h12-0-25" id="h12-0-25" class="i">+        return -1;
</a><a href="#h12-0-26" id="h12-0-26" class="i">+    }
</a><a href="#h12-0-27" id="h12-0-27" class="i">+
</a><a href="#h12-0-28" id="h12-0-28" class="i">+    //prevent bitmoji to load
</a><a href="#h12-0-29" id="h12-0-29" class="i">+    if (native_config-&gt;disable_bitmoji &amp;&amp; fileName.find(&quot;com.snap.file_manager_4_SCContent&quot;) != std::string::npos) {
</a><a href="#h12-0-30" id="h12-0-30" class="i">+        return -1;
</a><a href="#h12-0-31" id="h12-0-31" class="i">+    }
</a><a href="#h12-0-32" id="h12-0-32" class="i">+
</a><a href="#h12-0-33" id="h12-0-33" class="i">+    return fstat_original(fd, buf);
</a><a href="#h12-0-34" id="h12-0-34" class="i">+}
</a><a href="#h12-0-35" id="h12-0-35" class="i">+
</a><a href="#h12-0-36" id="h12-0-36" class="i">+
</a><a href="#h12-0-37" id="h12-0-37" class="i">+#define GET_BOOL_FIELD(env, clazz, field) env-&gt;GetBooleanField(clazz, env-&gt;GetFieldID(clazz, field, &quot;Z&quot;))
</a><a href="#h12-0-38" id="h12-0-38" class="i">+
</a><a href="#h12-0-39" id="h12-0-39" class="i">+extern &quot;C&quot; JNIEXPORT void JNICALL
</a><a href="#h12-0-40" id="h12-0-40" class="i">+loadConfig(JNIEnv *env, jobject  clazz, jobject config_object) {
</a><a href="#h12-0-41" id="h12-0-41" class="i">+    auto native_config_class = env-&gt;GetObjectClass(config_object);
</a><a href="#h12-0-42" id="h12-0-42" class="i">+
</a><a href="#h12-0-43" id="h12-0-43" class="i">+    native_config-&gt;disable_bitmoji = GET_BOOL_FIELD(env, native_config_class, &quot;disableBitmoji&quot;);
</a><a href="#h12-0-44" id="h12-0-44" class="i">+    native_config-&gt;disable_metrics = GET_BOOL_FIELD(env, native_config_class, &quot;disableMetrics&quot;);
</a><a href="#h12-0-45" id="h12-0-45" class="i">+
</a><a href="#h12-0-46" id="h12-0-46" class="i">+    LOGD(&quot;config loaded&quot;);
</a><a href="#h12-0-47" id="h12-0-47" class="i">+}
</a><a href="#h12-0-48" id="h12-0-48" class="i">+
</a><a href="#h12-0-49" id="h12-0-49" class="i">+//jni onload
</a><a href="#h12-0-50" id="h12-0-50" class="i">+extern &quot;C&quot; JNIEXPORT jint JNICALL
</a><a href="#h12-0-51" id="h12-0-51" class="i">+JNI_OnLoad(JavaVM *vm, void *reserved) {
</a><a href="#h12-0-52" id="h12-0-52" class="i">+    LOGD(&quot;initializing native&quot;);
</a><a href="#h12-0-53" id="h12-0-53" class="i">+    // config
</a><a href="#h12-0-54" id="h12-0-54" class="i">+    native_config = new native_config_t;
</a><a href="#h12-0-55" id="h12-0-55" class="i">+
</a><a href="#h12-0-56" id="h12-0-56" class="i">+    // hooks
</a><a href="#h12-0-57" id="h12-0-57" class="i">+    DobbyHook((void *) fstat_original,(void *) fstat_hook,(void **) &amp;fstat_original);
</a><a href="#h12-0-58" id="h12-0-58" class="i">+
</a><a href="#h12-0-59" id="h12-0-59" class="i">+    // register native methods
</a><a href="#h12-0-60" id="h12-0-60" class="i">+    JNIEnv *env = nullptr;
</a><a href="#h12-0-61" id="h12-0-61" class="i">+    vm-&gt;GetEnv((void **) &amp;env, JNI_VERSION_1_6);
</a><a href="#h12-0-62" id="h12-0-62" class="i">+
</a><a href="#h12-0-63" id="h12-0-63" class="i">+    auto methods = std::vector&lt;JNINativeMethod&gt;();
</a><a href="#h12-0-64" id="h12-0-64" class="i">+    methods.push_back({&quot;loadConfig&quot;, &quot;(Lme/rhunk/snapenhance/nativelib/NativeConfig;)V&quot;, (void *) loadConfig});
</a><a href="#h12-0-65" id="h12-0-65" class="i">+
</a><a href="#h12-0-66" id="h12-0-66" class="i">+    env-&gt;RegisterNatives(
</a><a href="#h12-0-67" id="h12-0-67" class="i">+            env-&gt;FindClass(&quot;me/rhunk/snapenhance/nativelib/NativeLib&quot;),
</a><a href="#h12-0-68" id="h12-0-68" class="i">+            methods.data(),
</a><a href="#h12-0-69" id="h12-0-69" class="i">+            methods.size()
</a><a href="#h12-0-70" id="h12-0-70" class="i">+    );
</a><a href="#h12-0-71" id="h12-0-71" class="i">+
</a><a href="#h12-0-72" id="h12-0-72" class="i">+    LOGD(&quot;native initialized&quot;);
</a><a href="#h12-0-73" id="h12-0-73" class="i">+
</a><a href="#h12-0-74" id="h12-0-74" class="i">+    return JNI_VERSION_1_6;
</a><a href="#h12-0-75" id="h12-0-75" class="i">+}
</a><b>diff --git a/<a id="h13" href="../file/native/jni/src/logger.h.html">native/jni/src/logger.h</a> b/<a href="../file/native/jni/src/logger.h.html">native/jni/src/logger.h</a></b>
<a href="#h13-0" id="h13-0" class="h">@@ -0,0 +1,10 @@
</a><a href="#h13-0-0" id="h13-0-0" class="i">+#pragma once
</a><a href="#h13-0-1" id="h13-0-1" class="i">+
</a><a href="#h13-0-2" id="h13-0-2" class="i">+#include &lt;android/log.h&gt;
</a><a href="#h13-0-3" id="h13-0-3" class="i">+
</a><a href="#h13-0-4" id="h13-0-4" class="i">+#define LOG_TAG &quot;SnapEnhanceNative&quot;
</a><a href="#h13-0-5" id="h13-0-5" class="i">+
</a><a href="#h13-0-6" id="h13-0-6" class="i">+#define LOGD(...) __android_log_print(ANDROID_LOG_DEBUG, LOG_TAG, __VA_ARGS__)
</a><a href="#h13-0-7" id="h13-0-7" class="i">+#define LOGI(...) __android_log_print(ANDROID_LOG_INFO,  LOG_TAG, __VA_ARGS__)
</a><a href="#h13-0-8" id="h13-0-8" class="i">+#define LOGW(...) __android_log_print(ANDROID_LOG_WARN,  LOG_TAG, __VA_ARGS__)
</a><a href="#h13-0-9" id="h13-0-9" class="i">+
</a><b>diff --git a/<a id="h14" href="../file/native/src/main/kotlin/me/rhunk/snapenhance/nativelib/NativeConfig.kt.html">native/src/main/kotlin/me/rhunk/snapenhance/nativelib/NativeConfig.kt</a> b/<a href="../file/native/src/main/kotlin/me/rhunk/snapenhance/nativelib/NativeConfig.kt.html">native/src/main/kotlin/me/rhunk/snapenhance/nativelib/NativeConfig.kt</a></b>
<a href="#h14-0" id="h14-0" class="h">@@ -0,0 +1,6 @@
</a><a href="#h14-0-0" id="h14-0-0" class="i">+package me.rhunk.snapenhance.nativelib
</a><a href="#h14-0-1" id="h14-0-1" class="i">+
</a><a href="#h14-0-2" id="h14-0-2" class="i">+data class NativeConfig(
</a><a href="#h14-0-3" id="h14-0-3" class="i">+    val disableBitmoji: Boolean = false,
</a><a href="#h14-0-4" id="h14-0-4" class="i">+    val disableMetrics: Boolean = false
</a><a href="#h14-0-5" id="h14-0-5" class="i">+)
</a><b>diff --git a/<a id="h15" href="../file/native/src/main/kotlin/me/rhunk/snapenhance/nativelib/NativeLib.kt.html">native/src/main/kotlin/me/rhunk/snapenhance/nativelib/NativeLib.kt</a> b/<a href="../file/native/src/main/kotlin/me/rhunk/snapenhance/nativelib/NativeLib.kt.html">native/src/main/kotlin/me/rhunk/snapenhance/nativelib/NativeLib.kt</a></b>
<a href="#h15-0" id="h15-0" class="h">@@ -0,0 +1,10 @@
</a><a href="#h15-0-0" id="h15-0-0" class="i">+package me.rhunk.snapenhance.nativelib
</a><a href="#h15-0-1" id="h15-0-1" class="i">+
</a><a href="#h15-0-2" id="h15-0-2" class="i">+class NativeLib {
</a><a href="#h15-0-3" id="h15-0-3" class="i">+    fun init() {
</a><a href="#h15-0-4" id="h15-0-4" class="i">+        System.loadLibrary(&quot;nativelib&quot;)
</a><a href="#h15-0-5" id="h15-0-5" class="i">+    }
</a><a href="#h15-0-6" id="h15-0-6" class="i">+
</a><a href="#h15-0-7" id="h15-0-7" class="i">+
</a><a href="#h15-0-8" id="h15-0-8" class="i">+    external fun loadConfig(config: NativeConfig)
</a><a href="#h15-0-9" id="h15-0-9" class="i">+}</a><a href="#h15-0-10" id="h15-0-10" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h16" href="../file/settings.gradle.kts.html">settings.gradle.kts</a> b/<a href="../file/settings.gradle.kts.html">settings.gradle.kts</a></b>
<a href="#h16-0" id="h16-0" class="h">@@ -19,4 +19,5 @@ dependencyResolutionManagement {
</a> rootProject.name = &quot;SnapEnhance&quot;
 include(&quot;:core&quot;)
 include(&quot;:app&quot;)
<a href="#h16-0-3" id="h16-0-3" class="d">-include(&quot;:mapper&quot;)</a><a href="#h16-0-4" id="h16-0-4" class="d">-
\ No newline at end of file
</a><a href="#h16-0-5" id="h16-0-5" class="i">+include(&quot;:mapper&quot;)
</a><a href="#h16-0-6" id="h16-0-6" class="i">+include(&quot;:native&quot;)
</a></pre>
</div>
</body>
</html>
