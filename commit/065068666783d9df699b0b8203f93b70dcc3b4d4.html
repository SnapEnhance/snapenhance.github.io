<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>initial commit - SnapEnhance - An Xposed module offering an enhanced Snapchat experience
</title>
<link rel="icon" type="image/svg+xml" href="../../logo.png"/>
<link rel="alternate icon" href="../../favicon.png"/>
<link rel="alternate" type="application/atom+xml" title="SnapEnhance Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="SnapEnhance Atom Feed (tags)" href="../tags.xml" />
<link rel="stylesheet" type="text/css" href="../../style.css" />
<link rel="stylesheet" type="text/css" href="../../fonts.css" />
</head>
<body>
<div id="head"><table><tr><td><a class="logo" href="../../"><img src="../../logo.png" alt="" width="32" height="32" /></a></td><td><strong>SnapEnhance</strong><span class="desc"> - An Xposed module offering an enhanced Snapchat experience
</span>
</td></tr></table>
<p><a href="../about.html">About</a> | <a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/LICENSE.html">License</a></p>
</div>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/065068666783d9df699b0b8203f93b70dcc3b4d4.html">065068666783d9df699b0b8203f93b70dcc3b4d4</a>
<b>Author:</b> rhunk &lt;<a href="mailto:101876869+rhunk@users.noreply.github.com">101876869+rhunk@users.noreply.github.com</a>&gt;
<b>Date:</b>   Mon, 15 May 2023 00:37:29 +0200

initial commit

<b>Diffstat:</b>
<table><tr><td class="A">A</td><td><a href="#h0">.gitignore</a></td><td> | </td><td class="num">10</td><td><span class="i">++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h1">README.md</a></td><td> | </td><td class="num">28</td><td><span class="i">++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h2">app/.gitignore</a></td><td> | </td><td class="num">16</td><td><span class="i">++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h3">app/build.gradle</a></td><td> | </td><td class="num">75</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h4">app/libs/LSPosed-api-1.0-SNAPSHOT-javadoc.jar</a></td><td> | </td><td class="num">0</td><td><span class="i"></span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h5">app/libs/LSPosed-api-1.0-SNAPSHOT-sources.jar</a></td><td> | </td><td class="num">0</td><td><span class="i"></span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h6">app/libs/LSPosed-api-1.0-SNAPSHOT.jar</a></td><td> | </td><td class="num">0</td><td><span class="i"></span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h7">app/proguard-rules.pro</a></td><td> | </td><td class="num">22</td><td><span class="i">++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h8">app/src/main/AndroidManifest.xml</a></td><td> | </td><td class="num">48</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h9">app/src/main/assets/xposed_init</a></td><td> | </td><td class="num">2</td><td><span class="i">++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h10">app/src/main/java/me/rhunk/snapenhance/XposedLoader.java</a></td><td> | </td><td class="num">14</td><td><span class="i">++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h11">app/src/main/kotlin/me/rhunk/snapenhance/Constants.kt</a></td><td> | </td><td class="num">22</td><td><span class="i">++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h12">app/src/main/kotlin/me/rhunk/snapenhance/Logger.kt</a></td><td> | </td><td class="num">43</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h13">app/src/main/kotlin/me/rhunk/snapenhance/ModContext.kt</a></td><td> | </td><td class="num">97</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h14">app/src/main/kotlin/me/rhunk/snapenhance/SnapEnhance.kt</a></td><td> | </td><td class="num">66</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h15">app/src/main/kotlin/me/rhunk/snapenhance/bridge/client/BridgeClient.kt</a></td><td> | </td><td class="num">238</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h16">app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/BridgeMessage.kt</a></td><td> | </td><td class="num">16</td><td><span class="i">++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h17">app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/BridgeMessageType.kt</a></td><td> | </td><td class="num">22</td><td><span class="i">++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h18">app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/impl/DownloadContentRequest.kt</a></td><td> | </td><td class="num">20</td><td><span class="i">++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h19">app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/impl/DownloadContentResult.kt</a></td><td> | </td><td class="num">17</td><td><span class="i">+++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h20">app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/impl/FileAccessRequest.kt</a></td><td> | </td><td class="num">43</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h21">app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/impl/FileAccessResult.kt</a></td><td> | </td><td class="num">20</td><td><span class="i">++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h22">app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/impl/LocaleRequest.kt</a></td><td> | </td><td class="num">18</td><td><span class="i">++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h23">app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/impl/LocaleResult.kt</a></td><td> | </td><td class="num">20</td><td><span class="i">++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h24">app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/impl/MessageLoggerRequest.kt</a></td><td> | </td><td class="num">30</td><td><span class="i">++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h25">app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/impl/MessageLoggerResult.kt</a></td><td> | </td><td class="num">21</td><td><span class="i">+++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h26">app/src/main/kotlin/me/rhunk/snapenhance/bridge/service/BridgeService.kt</a></td><td> | </td><td class="num">180</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h27">app/src/main/kotlin/me/rhunk/snapenhance/bridge/service/MainActivity.kt</a></td><td> | </td><td class="num">20</td><td><span class="i">++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h28">app/src/main/kotlin/me/rhunk/snapenhance/config/ConfigAccessor.kt</a></td><td> | </td><td class="num">59</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h29">app/src/main/kotlin/me/rhunk/snapenhance/config/ConfigCategory.kt</a></td><td> | </td><td class="num">14</td><td><span class="i">++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h30">app/src/main/kotlin/me/rhunk/snapenhance/config/ConfigProperty.kt</a></td><td> | </td><td class="num">182</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h31">app/src/main/kotlin/me/rhunk/snapenhance/data/FileType.kt</a></td><td> | </td><td class="num">50</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h32">app/src/main/kotlin/me/rhunk/snapenhance/data/SnapClassCache.kt</a></td><td> | </td><td class="num">26</td><td><span class="i">++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h33">app/src/main/kotlin/me/rhunk/snapenhance/data/SnapEnums.kt</a></td><td> | </td><td class="num">41</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h34">app/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/AbstractWrapper.kt</a></td><td> | </td><td class="num">30</td><td><span class="i">++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h35">app/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/Message.kt</a></td><td> | </td><td class="num">13</td><td><span class="i">+++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h36">app/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/MessageContent.kt</a></td><td> | </td><td class="num">16</td><td><span class="i">++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h37">app/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/MessageDescriptor.kt</a></td><td> | </td><td class="num">10</td><td><span class="i">++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h38">app/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/MessageMetadata.kt</a></td><td> | </td><td class="num">17</td><td><span class="i">+++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h39">app/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/SnapUUID.kt</a></td><td> | </td><td class="num">40</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h40">app/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/media/EncryptionWrapper.kt</a></td><td> | </td><td class="num">73</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h41">app/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/media/MediaInfo.kt</a></td><td> | </td><td class="num">34</td><td><span class="i">++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h42">app/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/media/opera/Layer.kt</a></td><td> | </td><td class="num">21</td><td><span class="i">+++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h43">app/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/media/opera/LayerController.kt</a></td><td> | </td><td class="num">18</td><td><span class="i">++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h44">app/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/media/opera/ParamMap.kt</a></td><td> | </td><td class="num">37</td><td><span class="i">+++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h45">app/src/main/kotlin/me/rhunk/snapenhance/database/DatabaseAccess.kt</a></td><td> | </td><td class="num">200</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h46">app/src/main/kotlin/me/rhunk/snapenhance/database/DatabaseObject.kt</a></td><td> | </td><td class="num">7</td><td><span class="i">+++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h47">app/src/main/kotlin/me/rhunk/snapenhance/database/objects/ConversationMessage.kt</a></td><td> | </td><td class="num">44</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h48">app/src/main/kotlin/me/rhunk/snapenhance/database/objects/FriendFeedInfo.kt</a></td><td> | </td><td class="num">33</td><td><span class="i">+++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h49">app/src/main/kotlin/me/rhunk/snapenhance/database/objects/FriendInfo.kt</a></td><td> | </td><td class="num">58</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h50">app/src/main/kotlin/me/rhunk/snapenhance/database/objects/StoryEntry.kt</a></td><td> | </td><td class="num">23</td><td><span class="i">+++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h51">app/src/main/kotlin/me/rhunk/snapenhance/database/objects/UserConversationLink.kt</a></td><td> | </td><td class="num">19</td><td><span class="i">+++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h52">app/src/main/kotlin/me/rhunk/snapenhance/event/EventBus.kt</a></td><td> | </td><td class="num">63</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h53">app/src/main/kotlin/me/rhunk/snapenhance/event/Events.kt</a></td><td> | </td><td class="num">4</td><td><span class="i">++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h54">app/src/main/kotlin/me/rhunk/snapenhance/features/Feature.kt</a></td><td> | </td><td class="num">32</td><td><span class="i">++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h55">app/src/main/kotlin/me/rhunk/snapenhance/features/FeatureLoadParams.kt</a></td><td> | </td><td class="num">12</td><td><span class="i">++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h56">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/ConfigEnumKeys.kt</a></td><td> | </td><td class="num">68</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h57">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/Messaging.kt</a></td><td> | </td><td class="num">72</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h58">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/MediaDownloader.kt</a></td><td> | </td><td class="num">431</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h59">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/extras/AutoSave.kt</a></td><td> | </td><td class="num">134</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h60">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/extras/Notifications.kt</a></td><td> | </td><td class="num">184</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h61">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/extras/SnapchatPlus.kt</a></td><td> | </td><td class="num">29</td><td><span class="i">+++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h62">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/privacy/DisableMetrics.kt</a></td><td> | </td><td class="num">46</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h63">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/privacy/PreventScreenshotDetections.kt</a></td><td> | </td><td class="num">17</td><td><span class="i">+++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h64">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/spy/AnonymousStoryViewing.kt</a></td><td> | </td><td class="num">20</td><td><span class="i">++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h65">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/spy/MessageLogger.kt</a></td><td> | </td><td class="num">65</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h66">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/spy/PreventReadReceipts.kt</a></td><td> | </td><td class="num">28</td><td><span class="i">++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h67">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/spy/PreventStatusNotifications.kt</a></td><td> | </td><td class="num">28</td><td><span class="i">++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h68">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/spy/StealthMode.kt</a></td><td> | </td><td class="num">62</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h69">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/UITweaks.kt</a></td><td> | </td><td class="num">62</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h70">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/menus/AbstractMenu.kt</a></td><td> | </td><td class="num">10</td><td><span class="i">++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h71">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/menus/MenuViewInjector.kt</a></td><td> | </td><td class="num">140</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h72">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/menus/ViewAppearanceHelper.kt</a></td><td> | </td><td class="num">53</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h73">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/menus/impl/ChatActionMenu.kt</a></td><td> | </td><td class="num">91</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h74">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/menus/impl/FriendFeedInfoMenu.kt</a></td><td> | </td><td class="num">232</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h75">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/menus/impl/OperaContextActionMenu.kt</a></td><td> | </td><td class="num">82</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h76">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/menus/impl/SettingsMenu.kt</a></td><td> | </td><td class="num">134</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h77">app/src/main/kotlin/me/rhunk/snapenhance/hook/HookAdapter.kt</a></td><td> | </td><td class="num">73</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h78">app/src/main/kotlin/me/rhunk/snapenhance/hook/HookStage.kt</a></td><td> | </td><td class="num">7</td><td><span class="i">+++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h79">app/src/main/kotlin/me/rhunk/snapenhance/hook/Hooker.kt</a></td><td> | </td><td class="num">95</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h80">app/src/main/kotlin/me/rhunk/snapenhance/manager/Manager.kt</a></td><td> | </td><td class="num">7</td><td><span class="i">+++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h81">app/src/main/kotlin/me/rhunk/snapenhance/manager/impl/ConfigManager.kt</a></td><td> | </td><td class="num">64</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h82">app/src/main/kotlin/me/rhunk/snapenhance/manager/impl/FeatureManager.kt</a></td><td> | </td><td class="num">94</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h83">app/src/main/kotlin/me/rhunk/snapenhance/manager/impl/MappingManager.kt</a></td><td> | </td><td class="num">179</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h84">app/src/main/kotlin/me/rhunk/snapenhance/manager/impl/TranslationManager.kt</a></td><td> | </td><td class="num">20</td><td><span class="i">++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h85">app/src/main/kotlin/me/rhunk/snapenhance/mapping/Mapper.kt</a></td><td> | </td><td class="num">13</td><td><span class="i">+++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h86">app/src/main/kotlin/me/rhunk/snapenhance/mapping/impl/CallbackMapper.kt</a></td><td> | </td><td class="num">29</td><td><span class="i">+++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h87">app/src/main/kotlin/me/rhunk/snapenhance/mapping/impl/EnumMapper.kt</a></td><td> | </td><td class="num">42</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h88">app/src/main/kotlin/me/rhunk/snapenhance/mapping/impl/OperaPageViewControllerMapper.kt</a></td><td> | </td><td class="num">77</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h89">app/src/main/kotlin/me/rhunk/snapenhance/mapping/impl/PlusSubscriptionMapper.kt</a></td><td> | </td><td class="num">33</td><td><span class="i">+++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h90">app/src/main/kotlin/me/rhunk/snapenhance/util/CallbackBuilder.kt</a></td><td> | </td><td class="num">94</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h91">app/src/main/kotlin/me/rhunk/snapenhance/util/EncryptionHelper.kt</a></td><td> | </td><td class="num">67</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h92">app/src/main/kotlin/me/rhunk/snapenhance/util/PreviewCreator.kt</a></td><td> | </td><td class="num">41</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h93">app/src/main/kotlin/me/rhunk/snapenhance/util/ReflectionHelper.kt</a></td><td> | </td><td class="num">119</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h94">app/src/main/kotlin/me/rhunk/snapenhance/util/XposedHelperMacros.kt</a></td><td> | </td><td class="num">20</td><td><span class="i">++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h95">app/src/main/kotlin/me/rhunk/snapenhance/util/download/CdnDownloader.kt</a></td><td> | </td><td class="num">83</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h96">app/src/main/kotlin/me/rhunk/snapenhance/util/download/DownloadServer.kt</a></td><td> | </td><td class="num">117</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h97">app/src/main/kotlin/me/rhunk/snapenhance/util/protobuf/ProtoReader.kt</a></td><td> | </td><td class="num">123</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h98">app/src/main/kotlin/me/rhunk/snapenhance/util/protobuf/ProtoWriter.kt</a></td><td> | </td><td class="num">67</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h99">app/src/main/kotlin/me/rhunk/snapenhance/util/snap/SnapUUID.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h100">app/src/main/res/values-fr/strings.xml</a></td><td> | </td><td class="num">5</td><td><span class="i">+++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h101">app/src/main/res/values/arrays.xml</a></td><td> | </td><td class="num">7</td><td><span class="i">+++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h102">app/src/main/res/values/strings.xml</a></td><td> | </td><td class="num">34</td><td><span class="i">++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h103">build.gradle</a></td><td> | </td><td class="num">11</td><td><span class="i">+++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h104">gradle.properties</a></td><td> | </td><td class="num">24</td><td><span class="i">++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h105">gradle/wrapper/gradle-wrapper.jar</a></td><td> | </td><td class="num">0</td><td><span class="i"></span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h106">gradle/wrapper/gradle-wrapper.properties</a></td><td> | </td><td class="num">6</td><td><span class="i">++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h107">gradlew</a></td><td> | </td><td class="num">185</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h108">gradlew.bat</a></td><td> | </td><td class="num">89</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h109">settings.gradle</a></td><td> | </td><td class="num">16</td><td><span class="i">++++++++++++++++</span><span class="d"></span></td></tr>
</table></pre><pre>110 files changed, 6115 insertions(+), 0 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/.gitignore.html">.gitignore</a> b/<a href="../file/.gitignore.html">.gitignore</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -0,0 +1,10 @@
</a><a href="#h0-0-0" id="h0-0-0" class="i">+*.iml
</a><a href="#h0-0-1" id="h0-0-1" class="i">+.gradle
</a><a href="#h0-0-2" id="h0-0-2" class="i">+/local.properties
</a><a href="#h0-0-3" id="h0-0-3" class="i">+/.idea/
</a><a href="#h0-0-4" id="h0-0-4" class="i">+.DS_Store
</a><a href="#h0-0-5" id="h0-0-5" class="i">+/build
</a><a href="#h0-0-6" id="h0-0-6" class="i">+/captures
</a><a href="#h0-0-7" id="h0-0-7" class="i">+.externalNativeBuild
</a><a href="#h0-0-8" id="h0-0-8" class="i">+.cxx
</a><a href="#h0-0-9" id="h0-0-9" class="i">+local.properties
</a><b>diff --git a/<a id="h1" href="../file/README.md.html">README.md</a> b/<a href="../file/README.md.html">README.md</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -0,0 +1,28 @@
</a><a href="#h1-0-0" id="h1-0-0" class="i">+# SnapEnhance
</a><a href="#h1-0-1" id="h1-0-1" class="i">+A xposed mod to enhance the Snapchat experience
</a><a href="#h1-0-2" id="h1-0-2" class="i">+The project is currently in development, so expect bugs and crashes. Feel free to open an issue if you find any bug.
</a><a href="#h1-0-3" id="h1-0-3" class="i">+
</a><a href="#h1-0-4" id="h1-0-4" class="i">+## build
</a><a href="#h1-0-5" id="h1-0-5" class="i">+   1. make sure you have the latest version of [LSPosed](https://github.com/LSPosed/LSPosed)
</a><a href="#h1-0-6" id="h1-0-6" class="i">+   2. clone this repo using ``git clone``
</a><a href="#h1-0-7" id="h1-0-7" class="i">+   3. run ``./gradlew assembleDebug``
</a><a href="#h1-0-8" id="h1-0-8" class="i">+   4. install the apk using adb ``adb install -r app/build/outputs/apk/debug/app-debug.apk``
</a><a href="#h1-0-9" id="h1-0-9" class="i">+
</a><a href="#h1-0-10" id="h1-0-10" class="i">+## features
</a><a href="#h1-0-11" id="h1-0-11" class="i">+- media downloader (+ overlay merging)
</a><a href="#h1-0-12" id="h1-0-12" class="i">+- message auto save
</a><a href="#h1-0-13" id="h1-0-13" class="i">+- message in notifications
</a><a href="#h1-0-14" id="h1-0-14" class="i">+- message logger
</a><a href="#h1-0-15" id="h1-0-15" class="i">+- snapchat plus features
</a><a href="#h1-0-16" id="h1-0-16" class="i">+- anonymous story viewing
</a><a href="#h1-0-17" id="h1-0-17" class="i">+- stealth mode
</a><a href="#h1-0-18" id="h1-0-18" class="i">+- screenshot detection bypass
</a><a href="#h1-0-19" id="h1-0-19" class="i">+- conversation preview
</a><a href="#h1-0-20" id="h1-0-20" class="i">+- prevent status notifications
</a><a href="#h1-0-21" id="h1-0-21" class="i">+- UI tweaks (remove call button, record button, ...)
</a><a href="#h1-0-22" id="h1-0-22" class="i">+- ad blocker
</a><a href="#h1-0-23" id="h1-0-23" class="i">+
</a><a href="#h1-0-24" id="h1-0-24" class="i">+## todo
</a><a href="#h1-0-25" id="h1-0-25" class="i">+- [] localization
</a><a href="#h1-0-26" id="h1-0-26" class="i">+- [] ui improvements
</a><a href="#h1-0-27" id="h1-0-27" class="i">+- [] snap splitting
</a><b>diff --git a/<a id="h2" href="../file/app/.gitignore.html">app/.gitignore</a> b/<a href="../file/app/.gitignore.html">app/.gitignore</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -0,0 +1,16 @@
</a><a href="#h2-0-0" id="h2-0-0" class="i">+*.iml
</a><a href="#h2-0-1" id="h2-0-1" class="i">+.gradle
</a><a href="#h2-0-2" id="h2-0-2" class="i">+/local.properties
</a><a href="#h2-0-3" id="h2-0-3" class="i">+/.idea/caches
</a><a href="#h2-0-4" id="h2-0-4" class="i">+/.idea/libraries
</a><a href="#h2-0-5" id="h2-0-5" class="i">+/.idea/modules.xml
</a><a href="#h2-0-6" id="h2-0-6" class="i">+/.idea/workspace.xml
</a><a href="#h2-0-7" id="h2-0-7" class="i">+/.idea/navEditor.xml
</a><a href="#h2-0-8" id="h2-0-8" class="i">+/.idea/assetWizardSettings.xml
</a><a href="#h2-0-9" id="h2-0-9" class="i">+/.idea/
</a><a href="#h2-0-10" id="h2-0-10" class="i">+.DS_Store
</a><a href="#h2-0-11" id="h2-0-11" class="i">+/build
</a><a href="#h2-0-12" id="h2-0-12" class="i">+/captures
</a><a href="#h2-0-13" id="h2-0-13" class="i">+.externalNativeBuild
</a><a href="#h2-0-14" id="h2-0-14" class="i">+.cxx
</a><a href="#h2-0-15" id="h2-0-15" class="i">+local.properties
</a><b>diff --git a/<a id="h3" href="../file/app/build.gradle.html">app/build.gradle</a> b/<a href="../file/app/build.gradle.html">app/build.gradle</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -0,0 +1,74 @@
</a><a href="#h3-0-0" id="h3-0-0" class="i">+plugins {
</a><a href="#h3-0-1" id="h3-0-1" class="i">+    id &#39;com.android.application&#39;
</a><a href="#h3-0-2" id="h3-0-2" class="i">+    id &#39;org.jetbrains.kotlin.android&#39;
</a><a href="#h3-0-3" id="h3-0-3" class="i">+}
</a><a href="#h3-0-4" id="h3-0-4" class="i">+
</a><a href="#h3-0-5" id="h3-0-5" class="i">+def appVersionName = &quot;0.0.1&quot;
</a><a href="#h3-0-6" id="h3-0-6" class="i">+def appVersionCode = 1
</a><a href="#h3-0-7" id="h3-0-7" class="i">+
</a><a href="#h3-0-8" id="h3-0-8" class="i">+android {
</a><a href="#h3-0-9" id="h3-0-9" class="i">+    compileSdk 32
</a><a href="#h3-0-10" id="h3-0-10" class="i">+
</a><a href="#h3-0-11" id="h3-0-11" class="i">+    defaultConfig {
</a><a href="#h3-0-12" id="h3-0-12" class="i">+        applicationId &quot;me.rhunk.snapenhance&quot;
</a><a href="#h3-0-13" id="h3-0-13" class="i">+        minSdk 29
</a><a href="#h3-0-14" id="h3-0-14" class="i">+        targetSdk 32
</a><a href="#h3-0-15" id="h3-0-15" class="i">+        versionCode appVersionCode
</a><a href="#h3-0-16" id="h3-0-16" class="i">+        versionName appVersionName
</a><a href="#h3-0-17" id="h3-0-17" class="i">+        multiDexEnabled true
</a><a href="#h3-0-18" id="h3-0-18" class="i">+    }
</a><a href="#h3-0-19" id="h3-0-19" class="i">+
</a><a href="#h3-0-20" id="h3-0-20" class="i">+    buildTypes {
</a><a href="#h3-0-21" id="h3-0-21" class="i">+        release {
</a><a href="#h3-0-22" id="h3-0-22" class="i">+            minifyEnabled true
</a><a href="#h3-0-23" id="h3-0-23" class="i">+            shrinkResources true
</a><a href="#h3-0-24" id="h3-0-24" class="i">+            proguardFiles getDefaultProguardFile(&#39;proguard-android-optimize.txt&#39;), &#39;proguard-rules.pro&#39;
</a><a href="#h3-0-25" id="h3-0-25" class="i">+        }
</a><a href="#h3-0-26" id="h3-0-26" class="i">+    }
</a><a href="#h3-0-27" id="h3-0-27" class="i">+    compileOptions {
</a><a href="#h3-0-28" id="h3-0-28" class="i">+        sourceCompatibility JavaVersion.VERSION_1_8
</a><a href="#h3-0-29" id="h3-0-29" class="i">+        targetCompatibility JavaVersion.VERSION_1_8
</a><a href="#h3-0-30" id="h3-0-30" class="i">+    }
</a><a href="#h3-0-31" id="h3-0-31" class="i">+
</a><a href="#h3-0-32" id="h3-0-32" class="i">+    //keep arm64-v8a native libs
</a><a href="#h3-0-33" id="h3-0-33" class="i">+    packagingOptions {
</a><a href="#h3-0-34" id="h3-0-34" class="i">+        exclude &quot;META-INF/**&quot;
</a><a href="#h3-0-35" id="h3-0-35" class="i">+        exclude &#39;lib/x86/**&#39;
</a><a href="#h3-0-36" id="h3-0-36" class="i">+        exclude &#39;lib/x86_64/**&#39;
</a><a href="#h3-0-37" id="h3-0-37" class="i">+        exclude &#39;lib/armeabi-v7a/**&#39;
</a><a href="#h3-0-38" id="h3-0-38" class="i">+    }
</a><a href="#h3-0-39" id="h3-0-39" class="i">+
</a><a href="#h3-0-40" id="h3-0-40" class="i">+    kotlinOptions {
</a><a href="#h3-0-41" id="h3-0-41" class="i">+        jvmTarget = &#39;1.8&#39;
</a><a href="#h3-0-42" id="h3-0-42" class="i">+    }
</a><a href="#h3-0-43" id="h3-0-43" class="i">+}
</a><a href="#h3-0-44" id="h3-0-44" class="i">+
</a><a href="#h3-0-45" id="h3-0-45" class="i">+afterEvaluate {
</a><a href="#h3-0-46" id="h3-0-46" class="i">+    //auto install for debug purpose
</a><a href="#h3-0-47" id="h3-0-47" class="i">+    getTasks().getByPath(&quot;:app:assembleDebug&quot;).doLast {
</a><a href="#h3-0-48" id="h3-0-48" class="i">+        try {
</a><a href="#h3-0-49" id="h3-0-49" class="i">+            println &quot;Killing Snapchat&quot;
</a><a href="#h3-0-50" id="h3-0-50" class="i">+            exec {
</a><a href="#h3-0-51" id="h3-0-51" class="i">+                commandLine &quot;adb&quot;, &quot;shell&quot;, &quot;am&quot;, &quot;force-stop&quot;, &quot;com.snapchat.android&quot;
</a><a href="#h3-0-52" id="h3-0-52" class="i">+            }
</a><a href="#h3-0-53" id="h3-0-53" class="i">+            println &quot;Installing debug build&quot;
</a><a href="#h3-0-54" id="h3-0-54" class="i">+            exec() {
</a><a href="#h3-0-55" id="h3-0-55" class="i">+                commandLine &quot;adb&quot;, &quot;install&quot;, &quot;-r&quot;, &quot;-d&quot;, &quot;${buildDir}/outputs/apk/debug/app-debug.apk&quot;
</a><a href="#h3-0-56" id="h3-0-56" class="i">+            }
</a><a href="#h3-0-57" id="h3-0-57" class="i">+            println &quot;Starting Snapchat&quot;
</a><a href="#h3-0-58" id="h3-0-58" class="i">+            exec {
</a><a href="#h3-0-59" id="h3-0-59" class="i">+                commandLine &quot;adb&quot;, &quot;shell&quot;, &quot;am&quot;, &quot;start&quot;, &quot;com.snapchat.android&quot;
</a><a href="#h3-0-60" id="h3-0-60" class="i">+            }
</a><a href="#h3-0-61" id="h3-0-61" class="i">+        } catch (Throwable t) {
</a><a href="#h3-0-62" id="h3-0-62" class="i">+            println &quot;Failed to install debug build&quot;
</a><a href="#h3-0-63" id="h3-0-63" class="i">+            t.printStackTrace()
</a><a href="#h3-0-64" id="h3-0-64" class="i">+        }
</a><a href="#h3-0-65" id="h3-0-65" class="i">+    }
</a><a href="#h3-0-66" id="h3-0-66" class="i">+}
</a><a href="#h3-0-67" id="h3-0-67" class="i">+
</a><a href="#h3-0-68" id="h3-0-68" class="i">+dependencies {
</a><a href="#h3-0-69" id="h3-0-69" class="i">+    implementation &#39;org.jetbrains.kotlinx:kotlinx-coroutines-android:1.6.1&#39;
</a><a href="#h3-0-70" id="h3-0-70" class="i">+    compileOnly files(&#39;libs/LSPosed-api-1.0-SNAPSHOT.jar&#39;)
</a><a href="#h3-0-71" id="h3-0-71" class="i">+    implementation &#39;com.google.code.gson:gson:2.10.1&#39;
</a><a href="#h3-0-72" id="h3-0-72" class="i">+    implementation &#39;com.arthenica:ffmpeg-kit-min-gpl:5.1&#39;
</a><a href="#h3-0-73" id="h3-0-73" class="i">+}</a><a href="#h3-0-74" id="h3-0-74" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h4" href="../file/app/libs/LSPosed-api-1.0-SNAPSHOT-javadoc.jar.html">app/libs/LSPosed-api-1.0-SNAPSHOT-javadoc.jar</a> b/<a href="../file/app/libs/LSPosed-api-1.0-SNAPSHOT-javadoc.jar.html">app/libs/LSPosed-api-1.0-SNAPSHOT-javadoc.jar</a></b>
Binary files differ.
<b>diff --git a/<a id="h5" href="../file/app/libs/LSPosed-api-1.0-SNAPSHOT-sources.jar.html">app/libs/LSPosed-api-1.0-SNAPSHOT-sources.jar</a> b/<a href="../file/app/libs/LSPosed-api-1.0-SNAPSHOT-sources.jar.html">app/libs/LSPosed-api-1.0-SNAPSHOT-sources.jar</a></b>
Binary files differ.
<b>diff --git a/<a id="h6" href="../file/app/libs/LSPosed-api-1.0-SNAPSHOT.jar.html">app/libs/LSPosed-api-1.0-SNAPSHOT.jar</a> b/<a href="../file/app/libs/LSPosed-api-1.0-SNAPSHOT.jar.html">app/libs/LSPosed-api-1.0-SNAPSHOT.jar</a></b>
Binary files differ.
<b>diff --git a/<a id="h7" href="../file/app/proguard-rules.pro.html">app/proguard-rules.pro</a> b/<a href="../file/app/proguard-rules.pro.html">app/proguard-rules.pro</a></b>
<a href="#h7-0" id="h7-0" class="h">@@ -0,0 +1,21 @@
</a><a href="#h7-0-0" id="h7-0-0" class="i">+# Add project specific ProGuard rules here.
</a><a href="#h7-0-1" id="h7-0-1" class="i">+# You can control the set of applied configuration files using the
</a><a href="#h7-0-2" id="h7-0-2" class="i">+# proguardFiles setting in build.gradle.
</a><a href="#h7-0-3" id="h7-0-3" class="i">+#
</a><a href="#h7-0-4" id="h7-0-4" class="i">+# For more details, see
</a><a href="#h7-0-5" id="h7-0-5" class="i">+#   http://developer.android.com/guide/developing/tools/proguard.html
</a><a href="#h7-0-6" id="h7-0-6" class="i">+
</a><a href="#h7-0-7" id="h7-0-7" class="i">+# If your project uses WebView with JS, uncomment the following
</a><a href="#h7-0-8" id="h7-0-8" class="i">+# and specify the fully qualified class name to the JavaScript interface
</a><a href="#h7-0-9" id="h7-0-9" class="i">+# class:
</a><a href="#h7-0-10" id="h7-0-10" class="i">+#-keepclassmembers class fqcn.of.javascript.interface.for.webview {
</a><a href="#h7-0-11" id="h7-0-11" class="i">+#   public *;
</a><a href="#h7-0-12" id="h7-0-12" class="i">+#}
</a><a href="#h7-0-13" id="h7-0-13" class="i">+
</a><a href="#h7-0-14" id="h7-0-14" class="i">+# Uncomment this to preserve the line number information for
</a><a href="#h7-0-15" id="h7-0-15" class="i">+# debugging stack traces.
</a><a href="#h7-0-16" id="h7-0-16" class="i">+#-keepattributes SourceFile,LineNumberTable
</a><a href="#h7-0-17" id="h7-0-17" class="i">+
</a><a href="#h7-0-18" id="h7-0-18" class="i">+# If you keep the line number information, uncomment this to
</a><a href="#h7-0-19" id="h7-0-19" class="i">+# hide the original source file name.
</a><a href="#h7-0-20" id="h7-0-20" class="i">+#-renamesourcefileattribute SourceFile</a><a href="#h7-0-21" id="h7-0-21" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h8" href="../file/app/src/main/AndroidManifest.xml.html">app/src/main/AndroidManifest.xml</a> b/<a href="../file/app/src/main/AndroidManifest.xml.html">app/src/main/AndroidManifest.xml</a></b>
<a href="#h8-0" id="h8-0" class="h">@@ -0,0 +1,47 @@
</a><a href="#h8-0-0" id="h8-0-0" class="i">+&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
</a><a href="#h8-0-1" id="h8-0-1" class="i">+&lt;manifest xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;
</a><a href="#h8-0-2" id="h8-0-2" class="i">+    xmlns:tools=&quot;http://schemas.android.com/tools&quot;
</a><a href="#h8-0-3" id="h8-0-3" class="i">+    package=&quot;me.rhunk.snapenhance&quot;&gt;
</a><a href="#h8-0-4" id="h8-0-4" class="i">+
</a><a href="#h8-0-5" id="h8-0-5" class="i">+    &lt;uses-permission android:name=&quot;android.permission.DOWNLOAD_WITHOUT_NOTIFICATION&quot; /&gt;
</a><a href="#h8-0-6" id="h8-0-6" class="i">+    &lt;uses-permission android:name=&quot;android.permission.INTERNET&quot; /&gt;
</a><a href="#h8-0-7" id="h8-0-7" class="i">+
</a><a href="#h8-0-8" id="h8-0-8" class="i">+    &lt;uses-permission android:name=&quot;android.permission.READ_EXTERNAL_STORAGE&quot; /&gt;
</a><a href="#h8-0-9" id="h8-0-9" class="i">+    &lt;uses-permission android:name=&quot;android.permission.WRITE_EXTERNAL_STORAGE&quot;
</a><a href="#h8-0-10" id="h8-0-10" class="i">+        tools:ignore=&quot;ScopedStorage&quot; /&gt;
</a><a href="#h8-0-11" id="h8-0-11" class="i">+    &lt;application
</a><a href="#h8-0-12" id="h8-0-12" class="i">+        android:usesCleartextTraffic=&quot;true&quot;
</a><a href="#h8-0-13" id="h8-0-13" class="i">+        android:label=&quot;@string/app_name&quot;
</a><a href="#h8-0-14" id="h8-0-14" class="i">+        tools:targetApi=&quot;31&quot;&gt;
</a><a href="#h8-0-15" id="h8-0-15" class="i">+        &lt;meta-data
</a><a href="#h8-0-16" id="h8-0-16" class="i">+            android:name=&quot;xposedmodule&quot;
</a><a href="#h8-0-17" id="h8-0-17" class="i">+            android:value=&quot;true&quot; /&gt;
</a><a href="#h8-0-18" id="h8-0-18" class="i">+        &lt;meta-data
</a><a href="#h8-0-19" id="h8-0-19" class="i">+            android:name=&quot;xposeddescription&quot;
</a><a href="#h8-0-20" id="h8-0-20" class="i">+            android:value=&quot;Enhanced Snapchat&quot; /&gt;
</a><a href="#h8-0-21" id="h8-0-21" class="i">+        &lt;meta-data
</a><a href="#h8-0-22" id="h8-0-22" class="i">+            android:name=&quot;xposedminversion&quot;
</a><a href="#h8-0-23" id="h8-0-23" class="i">+            android:value=&quot;53&quot; /&gt;
</a><a href="#h8-0-24" id="h8-0-24" class="i">+        &lt;meta-data
</a><a href="#h8-0-25" id="h8-0-25" class="i">+            android:name=&quot;xposedscope&quot;
</a><a href="#h8-0-26" id="h8-0-26" class="i">+            android:resource=&quot;@array/sc_scope&quot; /&gt;
</a><a href="#h8-0-27" id="h8-0-27" class="i">+
</a><a href="#h8-0-28" id="h8-0-28" class="i">+        &lt;service
</a><a href="#h8-0-29" id="h8-0-29" class="i">+            android:name=&quot;.bridge.service.BridgeService&quot;
</a><a href="#h8-0-30" id="h8-0-30" class="i">+            android:exported=&quot;true&quot;&gt;
</a><a href="#h8-0-31" id="h8-0-31" class="i">+        &lt;/service&gt;
</a><a href="#h8-0-32" id="h8-0-32" class="i">+
</a><a href="#h8-0-33" id="h8-0-33" class="i">+        &lt;activity
</a><a href="#h8-0-34" id="h8-0-34" class="i">+            android:theme=&quot;@android:style/Theme.NoDisplay&quot;
</a><a href="#h8-0-35" id="h8-0-35" class="i">+            android:name=&quot;.bridge.service.MainActivity&quot;
</a><a href="#h8-0-36" id="h8-0-36" class="i">+            android:exported=&quot;true&quot;
</a><a href="#h8-0-37" id="h8-0-37" class="i">+            android:excludeFromRecents=&quot;true&quot;&gt;
</a><a href="#h8-0-38" id="h8-0-38" class="i">+            &lt;intent-filter&gt;
</a><a href="#h8-0-39" id="h8-0-39" class="i">+                &lt;action android:name=&quot;android.intent.action.MAIN&quot; /&gt;
</a><a href="#h8-0-40" id="h8-0-40" class="i">+                &lt;category android:name=&quot;android.intent.category.LAUNCHER&quot; /&gt;
</a><a href="#h8-0-41" id="h8-0-41" class="i">+            &lt;/intent-filter&gt;
</a><a href="#h8-0-42" id="h8-0-42" class="i">+        &lt;/activity&gt;
</a><a href="#h8-0-43" id="h8-0-43" class="i">+
</a><a href="#h8-0-44" id="h8-0-44" class="i">+    &lt;/application&gt;
</a><a href="#h8-0-45" id="h8-0-45" class="i">+
</a><a href="#h8-0-46" id="h8-0-46" class="i">+&lt;/manifest&gt;</a><a href="#h8-0-47" id="h8-0-47" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h9" href="../file/app/src/main/assets/xposed_init.html">app/src/main/assets/xposed_init</a> b/<a href="../file/app/src/main/assets/xposed_init.html">app/src/main/assets/xposed_init</a></b>
<a href="#h9-0" id="h9-0" class="h">@@ -0,0 +1 @@
</a><a href="#h9-0-0" id="h9-0-0" class="i">+me.rhunk.snapenhance.XposedLoader</a><a href="#h9-0-1" id="h9-0-1" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h10" href="../file/app/src/main/java/me/rhunk/snapenhance/XposedLoader.java.html">app/src/main/java/me/rhunk/snapenhance/XposedLoader.java</a> b/<a href="../file/app/src/main/java/me/rhunk/snapenhance/XposedLoader.java.html">app/src/main/java/me/rhunk/snapenhance/XposedLoader.java</a></b>
<a href="#h10-0" id="h10-0" class="h">@@ -0,0 +1,14 @@
</a><a href="#h10-0-0" id="h10-0-0" class="i">+package me.rhunk.snapenhance;
</a><a href="#h10-0-1" id="h10-0-1" class="i">+
</a><a href="#h10-0-2" id="h10-0-2" class="i">+import de.robv.android.xposed.IXposedHookLoadPackage;
</a><a href="#h10-0-3" id="h10-0-3" class="i">+import de.robv.android.xposed.XposedBridge;
</a><a href="#h10-0-4" id="h10-0-4" class="i">+import de.robv.android.xposed.XposedHelpers;
</a><a href="#h10-0-5" id="h10-0-5" class="i">+import de.robv.android.xposed.callbacks.XC_LoadPackage;
</a><a href="#h10-0-6" id="h10-0-6" class="i">+
</a><a href="#h10-0-7" id="h10-0-7" class="i">+public class XposedLoader implements IXposedHookLoadPackage {
</a><a href="#h10-0-8" id="h10-0-8" class="i">+    @Override
</a><a href="#h10-0-9" id="h10-0-9" class="i">+    public void handleLoadPackage(XC_LoadPackage.LoadPackageParam packageParam) throws Throwable {
</a><a href="#h10-0-10" id="h10-0-10" class="i">+        if (!packageParam.packageName.equals(Constants.SNAPCHAT_PACKAGE_NAME)) return;
</a><a href="#h10-0-11" id="h10-0-11" class="i">+        new SnapEnhance();
</a><a href="#h10-0-12" id="h10-0-12" class="i">+    }
</a><a href="#h10-0-13" id="h10-0-13" class="i">+}
</a><b>diff --git a/<a id="h11" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/Constants.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/Constants.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/Constants.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/Constants.kt</a></b>
<a href="#h11-0" id="h11-0" class="h">@@ -0,0 +1,21 @@
</a><a href="#h11-0-0" id="h11-0-0" class="i">+package me.rhunk.snapenhance
</a><a href="#h11-0-1" id="h11-0-1" class="i">+
</a><a href="#h11-0-2" id="h11-0-2" class="i">+object Constants {
</a><a href="#h11-0-3" id="h11-0-3" class="i">+    const val TAG = &quot;SnapEnhance&quot;
</a><a href="#h11-0-4" id="h11-0-4" class="i">+    const val SNAPCHAT_PACKAGE_NAME = &quot;com.snapchat.android&quot;
</a><a href="#h11-0-5" id="h11-0-5" class="i">+
</a><a href="#h11-0-6" id="h11-0-6" class="i">+    const val VIEW_INJECTED_CODE = 0x7FFFFF02
</a><a href="#h11-0-7" id="h11-0-7" class="i">+    const val VIEW_DRAWER = 0x7FFFFF03
</a><a href="#h11-0-8" id="h11-0-8" class="i">+
</a><a href="#h11-0-9" id="h11-0-9" class="i">+    val ARROYO_NOTE_ENCRYPTION_PROTO_PATH = intArrayOf(4, 4, 6, 1, 1)
</a><a href="#h11-0-10" id="h11-0-10" class="i">+    val ARROYO_SNAP_ENCRYPTION_PROTO_PATH = intArrayOf(4, 4, 11, 5, 1, 1)
</a><a href="#h11-0-11" id="h11-0-11" class="i">+    val MESSAGE_SNAP_ENCRYPTION_PROTO_PATH = intArrayOf(11, 5, 1, 1)
</a><a href="#h11-0-12" id="h11-0-12" class="i">+    val ARROYO_EXTERNAL_MEDIA_ENCRYPTION_PROTO_PATH = intArrayOf(4, 4, 3, 3, 5, 1, 1)
</a><a href="#h11-0-13" id="h11-0-13" class="i">+    val ARROYO_STRING_CHAT_MESSAGE_PROTO = intArrayOf(4, 4, 2, 1)
</a><a href="#h11-0-14" id="h11-0-14" class="i">+    val ARROYO_URL_KEY_PROTO_PATH = intArrayOf(4, 5, 1, 3, 2, 2)
</a><a href="#h11-0-15" id="h11-0-15" class="i">+
</a><a href="#h11-0-16" id="h11-0-16" class="i">+    const val ARROYO_ENCRYPTION_PROTO_INDEX = 19
</a><a href="#h11-0-17" id="h11-0-17" class="i">+    const val ARROYO_ENCRYPTION_PROTO_INDEX_V2 = 4
</a><a href="#h11-0-18" id="h11-0-18" class="i">+
</a><a href="#h11-0-19" id="h11-0-19" class="i">+    const val USER_AGENT = &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36&quot;
</a><a href="#h11-0-20" id="h11-0-20" class="i">+}</a><a href="#h11-0-21" id="h11-0-21" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h12" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/Logger.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/Logger.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/Logger.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/Logger.kt</a></b>
<a href="#h12-0" id="h12-0" class="h">@@ -0,0 +1,42 @@
</a><a href="#h12-0-0" id="h12-0-0" class="i">+package me.rhunk.snapenhance
</a><a href="#h12-0-1" id="h12-0-1" class="i">+
</a><a href="#h12-0-2" id="h12-0-2" class="i">+import android.util.Log
</a><a href="#h12-0-3" id="h12-0-3" class="i">+import de.robv.android.xposed.XposedBridge
</a><a href="#h12-0-4" id="h12-0-4" class="i">+
</a><a href="#h12-0-5" id="h12-0-5" class="i">+object Logger {
</a><a href="#h12-0-6" id="h12-0-6" class="i">+    private const val TAG = &quot;SnapEnhance&quot;
</a><a href="#h12-0-7" id="h12-0-7" class="i">+
</a><a href="#h12-0-8" id="h12-0-8" class="i">+    fun log(message: Any?) {
</a><a href="#h12-0-9" id="h12-0-9" class="i">+        Log.i(TAG, message.toString())
</a><a href="#h12-0-10" id="h12-0-10" class="i">+    }
</a><a href="#h12-0-11" id="h12-0-11" class="i">+
</a><a href="#h12-0-12" id="h12-0-12" class="i">+    fun debug(message: Any?) {
</a><a href="#h12-0-13" id="h12-0-13" class="i">+        if (!BuildConfig.DEBUG) return
</a><a href="#h12-0-14" id="h12-0-14" class="i">+        Log.d(TAG, message.toString())
</a><a href="#h12-0-15" id="h12-0-15" class="i">+    }
</a><a href="#h12-0-16" id="h12-0-16" class="i">+
</a><a href="#h12-0-17" id="h12-0-17" class="i">+    fun error(throwable: Throwable) {
</a><a href="#h12-0-18" id="h12-0-18" class="i">+        Log.e(TAG, &quot;&quot;,throwable)
</a><a href="#h12-0-19" id="h12-0-19" class="i">+    }
</a><a href="#h12-0-20" id="h12-0-20" class="i">+
</a><a href="#h12-0-21" id="h12-0-21" class="i">+    fun error(message: Any?) {
</a><a href="#h12-0-22" id="h12-0-22" class="i">+        Log.e(TAG, message.toString())
</a><a href="#h12-0-23" id="h12-0-23" class="i">+    }
</a><a href="#h12-0-24" id="h12-0-24" class="i">+
</a><a href="#h12-0-25" id="h12-0-25" class="i">+    fun error(message: Any?, throwable: Throwable) {
</a><a href="#h12-0-26" id="h12-0-26" class="i">+        Log.e(TAG, message.toString(), throwable)
</a><a href="#h12-0-27" id="h12-0-27" class="i">+    }
</a><a href="#h12-0-28" id="h12-0-28" class="i">+
</a><a href="#h12-0-29" id="h12-0-29" class="i">+    fun xposedLog(message: Any?) {
</a><a href="#h12-0-30" id="h12-0-30" class="i">+        XposedBridge.log(message.toString())
</a><a href="#h12-0-31" id="h12-0-31" class="i">+    }
</a><a href="#h12-0-32" id="h12-0-32" class="i">+
</a><a href="#h12-0-33" id="h12-0-33" class="i">+    fun xposedLog(message: Any?, throwable: Throwable?) {
</a><a href="#h12-0-34" id="h12-0-34" class="i">+        XposedBridge.log(message.toString())
</a><a href="#h12-0-35" id="h12-0-35" class="i">+        XposedBridge.log(throwable)
</a><a href="#h12-0-36" id="h12-0-36" class="i">+    }
</a><a href="#h12-0-37" id="h12-0-37" class="i">+
</a><a href="#h12-0-38" id="h12-0-38" class="i">+    fun xposedLog(throwable: Throwable) {
</a><a href="#h12-0-39" id="h12-0-39" class="i">+        XposedBridge.log(throwable)
</a><a href="#h12-0-40" id="h12-0-40" class="i">+    }
</a><a href="#h12-0-41" id="h12-0-41" class="i">+}</a><a href="#h12-0-42" id="h12-0-42" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h13" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ModContext.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ModContext.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ModContext.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ModContext.kt</a></b>
<a href="#h13-0" id="h13-0" class="h">@@ -0,0 +1,96 @@
</a><a href="#h13-0-0" id="h13-0-0" class="i">+package me.rhunk.snapenhance
</a><a href="#h13-0-1" id="h13-0-1" class="i">+
</a><a href="#h13-0-2" id="h13-0-2" class="i">+import android.app.Activity
</a><a href="#h13-0-3" id="h13-0-3" class="i">+import android.content.Context
</a><a href="#h13-0-4" id="h13-0-4" class="i">+import android.content.Intent
</a><a href="#h13-0-5" id="h13-0-5" class="i">+import android.content.res.Resources
</a><a href="#h13-0-6" id="h13-0-6" class="i">+import android.os.Handler
</a><a href="#h13-0-7" id="h13-0-7" class="i">+import android.os.Looper
</a><a href="#h13-0-8" id="h13-0-8" class="i">+import android.os.Process
</a><a href="#h13-0-9" id="h13-0-9" class="i">+import android.widget.Toast
</a><a href="#h13-0-10" id="h13-0-10" class="i">+import com.google.gson.Gson
</a><a href="#h13-0-11" id="h13-0-11" class="i">+import com.google.gson.GsonBuilder
</a><a href="#h13-0-12" id="h13-0-12" class="i">+import me.rhunk.snapenhance.bridge.client.BridgeClient
</a><a href="#h13-0-13" id="h13-0-13" class="i">+import me.rhunk.snapenhance.database.DatabaseAccess
</a><a href="#h13-0-14" id="h13-0-14" class="i">+import me.rhunk.snapenhance.features.Feature
</a><a href="#h13-0-15" id="h13-0-15" class="i">+import me.rhunk.snapenhance.manager.impl.ConfigManager
</a><a href="#h13-0-16" id="h13-0-16" class="i">+import me.rhunk.snapenhance.manager.impl.FeatureManager
</a><a href="#h13-0-17" id="h13-0-17" class="i">+import me.rhunk.snapenhance.manager.impl.MappingManager
</a><a href="#h13-0-18" id="h13-0-18" class="i">+import me.rhunk.snapenhance.manager.impl.TranslationManager
</a><a href="#h13-0-19" id="h13-0-19" class="i">+import me.rhunk.snapenhance.util.download.DownloadServer
</a><a href="#h13-0-20" id="h13-0-20" class="i">+import java.util.concurrent.ExecutorService
</a><a href="#h13-0-21" id="h13-0-21" class="i">+import java.util.concurrent.Executors
</a><a href="#h13-0-22" id="h13-0-22" class="i">+import kotlin.reflect.KClass
</a><a href="#h13-0-23" id="h13-0-23" class="i">+import kotlin.system.exitProcess
</a><a href="#h13-0-24" id="h13-0-24" class="i">+
</a><a href="#h13-0-25" id="h13-0-25" class="i">+class ModContext {
</a><a href="#h13-0-26" id="h13-0-26" class="i">+    private val executorService: ExecutorService = Executors.newCachedThreadPool()
</a><a href="#h13-0-27" id="h13-0-27" class="i">+
</a><a href="#h13-0-28" id="h13-0-28" class="i">+    lateinit var androidContext: Context
</a><a href="#h13-0-29" id="h13-0-29" class="i">+    var mainActivity: Activity? = null
</a><a href="#h13-0-30" id="h13-0-30" class="i">+
</a><a href="#h13-0-31" id="h13-0-31" class="i">+    val gson: Gson = GsonBuilder().create()
</a><a href="#h13-0-32" id="h13-0-32" class="i">+
</a><a href="#h13-0-33" id="h13-0-33" class="i">+    val bridgeClient = BridgeClient(this)
</a><a href="#h13-0-34" id="h13-0-34" class="i">+    val translation = TranslationManager(this)
</a><a href="#h13-0-35" id="h13-0-35" class="i">+    val features = FeatureManager(this)
</a><a href="#h13-0-36" id="h13-0-36" class="i">+    val mappings = MappingManager(this)
</a><a href="#h13-0-37" id="h13-0-37" class="i">+    val config = ConfigManager(this)
</a><a href="#h13-0-38" id="h13-0-38" class="i">+    val database = DatabaseAccess(this)
</a><a href="#h13-0-39" id="h13-0-39" class="i">+    val downloadServer = DownloadServer(this)
</a><a href="#h13-0-40" id="h13-0-40" class="i">+    val classCache get() = SnapEnhance.classCache
</a><a href="#h13-0-41" id="h13-0-41" class="i">+    val resources: Resources get() = androidContext.resources
</a><a href="#h13-0-42" id="h13-0-42" class="i">+
</a><a href="#h13-0-43" id="h13-0-43" class="i">+    fun &lt;T : Feature&gt; feature(featureClass: KClass&lt;T&gt;): T {
</a><a href="#h13-0-44" id="h13-0-44" class="i">+        return features.get(featureClass)!!
</a><a href="#h13-0-45" id="h13-0-45" class="i">+    }
</a><a href="#h13-0-46" id="h13-0-46" class="i">+
</a><a href="#h13-0-47" id="h13-0-47" class="i">+    fun runOnUiThread(runnable: () -&gt; Unit) {
</a><a href="#h13-0-48" id="h13-0-48" class="i">+        Handler(Looper.getMainLooper()).post {
</a><a href="#h13-0-49" id="h13-0-49" class="i">+            runCatching(runnable).onFailure {
</a><a href="#h13-0-50" id="h13-0-50" class="i">+                Logger.xposedLog(&quot;UI thread runnable failed&quot;, it)
</a><a href="#h13-0-51" id="h13-0-51" class="i">+            }
</a><a href="#h13-0-52" id="h13-0-52" class="i">+        }
</a><a href="#h13-0-53" id="h13-0-53" class="i">+    }
</a><a href="#h13-0-54" id="h13-0-54" class="i">+
</a><a href="#h13-0-55" id="h13-0-55" class="i">+    fun executeAsync(runnable: () -&gt; Unit) {
</a><a href="#h13-0-56" id="h13-0-56" class="i">+        executorService.submit {
</a><a href="#h13-0-57" id="h13-0-57" class="i">+            runCatching {
</a><a href="#h13-0-58" id="h13-0-58" class="i">+                runnable()
</a><a href="#h13-0-59" id="h13-0-59" class="i">+            }.onFailure {
</a><a href="#h13-0-60" id="h13-0-60" class="i">+                Logger.xposedLog(&quot;Async task failed&quot;, it)
</a><a href="#h13-0-61" id="h13-0-61" class="i">+            }
</a><a href="#h13-0-62" id="h13-0-62" class="i">+        }
</a><a href="#h13-0-63" id="h13-0-63" class="i">+    }
</a><a href="#h13-0-64" id="h13-0-64" class="i">+
</a><a href="#h13-0-65" id="h13-0-65" class="i">+    fun shortToast(message: Any) {
</a><a href="#h13-0-66" id="h13-0-66" class="i">+        runOnUiThread {
</a><a href="#h13-0-67" id="h13-0-67" class="i">+            Toast.makeText(androidContext, message.toString(), Toast.LENGTH_SHORT).show()
</a><a href="#h13-0-68" id="h13-0-68" class="i">+        }
</a><a href="#h13-0-69" id="h13-0-69" class="i">+    }
</a><a href="#h13-0-70" id="h13-0-70" class="i">+
</a><a href="#h13-0-71" id="h13-0-71" class="i">+    fun longToast(message: Any) {
</a><a href="#h13-0-72" id="h13-0-72" class="i">+        runOnUiThread {
</a><a href="#h13-0-73" id="h13-0-73" class="i">+            Toast.makeText(androidContext, message.toString(), Toast.LENGTH_LONG).show()
</a><a href="#h13-0-74" id="h13-0-74" class="i">+        }
</a><a href="#h13-0-75" id="h13-0-75" class="i">+    }
</a><a href="#h13-0-76" id="h13-0-76" class="i">+
</a><a href="#h13-0-77" id="h13-0-77" class="i">+    fun restartApp() {
</a><a href="#h13-0-78" id="h13-0-78" class="i">+        androidContext.packageManager.getLaunchIntentForPackage(
</a><a href="#h13-0-79" id="h13-0-79" class="i">+            Constants.SNAPCHAT_PACKAGE_NAME
</a><a href="#h13-0-80" id="h13-0-80" class="i">+        )?.let {
</a><a href="#h13-0-81" id="h13-0-81" class="i">+            val intent = Intent.makeRestartActivityTask(it.component)
</a><a href="#h13-0-82" id="h13-0-82" class="i">+            androidContext.startActivity(intent)
</a><a href="#h13-0-83" id="h13-0-83" class="i">+            Runtime.getRuntime().exit(0)
</a><a href="#h13-0-84" id="h13-0-84" class="i">+        }
</a><a href="#h13-0-85" id="h13-0-85" class="i">+    }
</a><a href="#h13-0-86" id="h13-0-86" class="i">+
</a><a href="#h13-0-87" id="h13-0-87" class="i">+    fun softRestartApp() {
</a><a href="#h13-0-88" id="h13-0-88" class="i">+        exitProcess(0)
</a><a href="#h13-0-89" id="h13-0-89" class="i">+    }
</a><a href="#h13-0-90" id="h13-0-90" class="i">+
</a><a href="#h13-0-91" id="h13-0-91" class="i">+    fun forceCloseApp() {
</a><a href="#h13-0-92" id="h13-0-92" class="i">+        Process.killProcess(Process.myPid())
</a><a href="#h13-0-93" id="h13-0-93" class="i">+        exitProcess(1)
</a><a href="#h13-0-94" id="h13-0-94" class="i">+    }
</a><a href="#h13-0-95" id="h13-0-95" class="i">+}</a><a href="#h13-0-96" id="h13-0-96" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h14" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/SnapEnhance.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/SnapEnhance.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/SnapEnhance.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/SnapEnhance.kt</a></b>
<a href="#h14-0" id="h14-0" class="h">@@ -0,0 +1,65 @@
</a><a href="#h14-0-0" id="h14-0-0" class="i">+package me.rhunk.snapenhance
</a><a href="#h14-0-1" id="h14-0-1" class="i">+
</a><a href="#h14-0-2" id="h14-0-2" class="i">+import android.app.Activity
</a><a href="#h14-0-3" id="h14-0-3" class="i">+import android.app.Application
</a><a href="#h14-0-4" id="h14-0-4" class="i">+import android.content.Context
</a><a href="#h14-0-5" id="h14-0-5" class="i">+import me.rhunk.snapenhance.data.SnapClassCache
</a><a href="#h14-0-6" id="h14-0-6" class="i">+import me.rhunk.snapenhance.hook.HookStage
</a><a href="#h14-0-7" id="h14-0-7" class="i">+import me.rhunk.snapenhance.hook.Hooker
</a><a href="#h14-0-8" id="h14-0-8" class="i">+
</a><a href="#h14-0-9" id="h14-0-9" class="i">+class SnapEnhance {
</a><a href="#h14-0-10" id="h14-0-10" class="i">+    companion object {
</a><a href="#h14-0-11" id="h14-0-11" class="i">+        lateinit var classLoader: ClassLoader
</a><a href="#h14-0-12" id="h14-0-12" class="i">+        val classCache: SnapClassCache by lazy {
</a><a href="#h14-0-13" id="h14-0-13" class="i">+            SnapClassCache(classLoader)
</a><a href="#h14-0-14" id="h14-0-14" class="i">+        }
</a><a href="#h14-0-15" id="h14-0-15" class="i">+    }
</a><a href="#h14-0-16" id="h14-0-16" class="i">+    private val appContext = ModContext()
</a><a href="#h14-0-17" id="h14-0-17" class="i">+
</a><a href="#h14-0-18" id="h14-0-18" class="i">+    init {
</a><a href="#h14-0-19" id="h14-0-19" class="i">+        Hooker.hook(Application::class.java, &quot;attach&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h14-0-20" id="h14-0-20" class="i">+            appContext.androidContext = param.arg&lt;Context&gt;(0).also {
</a><a href="#h14-0-21" id="h14-0-21" class="i">+                classLoader = it.classLoader
</a><a href="#h14-0-22" id="h14-0-22" class="i">+            }
</a><a href="#h14-0-23" id="h14-0-23" class="i">+
</a><a href="#h14-0-24" id="h14-0-24" class="i">+            appContext.bridgeClient.start { bridgeResult -&gt;
</a><a href="#h14-0-25" id="h14-0-25" class="i">+                if (!bridgeResult) {
</a><a href="#h14-0-26" id="h14-0-26" class="i">+                    Logger.xposedLog(&quot;Cannot connect to bridge service&quot;)
</a><a href="#h14-0-27" id="h14-0-27" class="i">+                    appContext.restartApp()
</a><a href="#h14-0-28" id="h14-0-28" class="i">+                    return@start
</a><a href="#h14-0-29" id="h14-0-29" class="i">+                }
</a><a href="#h14-0-30" id="h14-0-30" class="i">+                runCatching {
</a><a href="#h14-0-31" id="h14-0-31" class="i">+                    init()
</a><a href="#h14-0-32" id="h14-0-32" class="i">+                }.onFailure {
</a><a href="#h14-0-33" id="h14-0-33" class="i">+                    Logger.xposedLog(&quot;Failed to initialize&quot;, it)
</a><a href="#h14-0-34" id="h14-0-34" class="i">+                }
</a><a href="#h14-0-35" id="h14-0-35" class="i">+            }
</a><a href="#h14-0-36" id="h14-0-36" class="i">+        }
</a><a href="#h14-0-37" id="h14-0-37" class="i">+
</a><a href="#h14-0-38" id="h14-0-38" class="i">+        Hooker.hook(Activity::class.java, &quot;onCreate&quot;, HookStage.AFTER) {
</a><a href="#h14-0-39" id="h14-0-39" class="i">+            val activity = it.thisObject() as Activity
</a><a href="#h14-0-40" id="h14-0-40" class="i">+            if (!activity.packageName.equals(Constants.SNAPCHAT_PACKAGE_NAME)) return@hook
</a><a href="#h14-0-41" id="h14-0-41" class="i">+            val isMainActivityNotNull = appContext.mainActivity != null
</a><a href="#h14-0-42" id="h14-0-42" class="i">+            appContext.mainActivity = activity
</a><a href="#h14-0-43" id="h14-0-43" class="i">+            if (isMainActivityNotNull) return@hook
</a><a href="#h14-0-44" id="h14-0-44" class="i">+            onActivityCreate()
</a><a href="#h14-0-45" id="h14-0-45" class="i">+        }
</a><a href="#h14-0-46" id="h14-0-46" class="i">+    }
</a><a href="#h14-0-47" id="h14-0-47" class="i">+
</a><a href="#h14-0-48" id="h14-0-48" class="i">+    private fun init() {
</a><a href="#h14-0-49" id="h14-0-49" class="i">+        val time = System.currentTimeMillis()
</a><a href="#h14-0-50" id="h14-0-50" class="i">+        with(appContext) {
</a><a href="#h14-0-51" id="h14-0-51" class="i">+            translation.init()
</a><a href="#h14-0-52" id="h14-0-52" class="i">+            config.init()
</a><a href="#h14-0-53" id="h14-0-53" class="i">+            mappings.init()
</a><a href="#h14-0-54" id="h14-0-54" class="i">+            features.init()
</a><a href="#h14-0-55" id="h14-0-55" class="i">+        }
</a><a href="#h14-0-56" id="h14-0-56" class="i">+        Logger.debug(&quot;initialized in ${System.currentTimeMillis() - time} ms&quot;)
</a><a href="#h14-0-57" id="h14-0-57" class="i">+    }
</a><a href="#h14-0-58" id="h14-0-58" class="i">+
</a><a href="#h14-0-59" id="h14-0-59" class="i">+    private fun onActivityCreate() {
</a><a href="#h14-0-60" id="h14-0-60" class="i">+        with(appContext) {
</a><a href="#h14-0-61" id="h14-0-61" class="i">+            features.onActivityCreate()
</a><a href="#h14-0-62" id="h14-0-62" class="i">+        }
</a><a href="#h14-0-63" id="h14-0-63" class="i">+    }
</a><a href="#h14-0-64" id="h14-0-64" class="i">+}</a><a href="#h14-0-65" id="h14-0-65" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h15" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/client/BridgeClient.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/client/BridgeClient.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/client/BridgeClient.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/client/BridgeClient.kt</a></b>
<a href="#h15-0" id="h15-0" class="h">@@ -0,0 +1,238 @@
</a><a href="#h15-0-0" id="h15-0-0" class="i">+package me.rhunk.snapenhance.bridge.client
</a><a href="#h15-0-1" id="h15-0-1" class="i">+
</a><a href="#h15-0-2" id="h15-0-2" class="i">+
</a><a href="#h15-0-3" id="h15-0-3" class="i">+import android.content.ComponentName
</a><a href="#h15-0-4" id="h15-0-4" class="i">+import android.content.Context
</a><a href="#h15-0-5" id="h15-0-5" class="i">+import android.content.Intent
</a><a href="#h15-0-6" id="h15-0-6" class="i">+import android.content.ServiceConnection
</a><a href="#h15-0-7" id="h15-0-7" class="i">+import android.os.*
</a><a href="#h15-0-8" id="h15-0-8" class="i">+import me.rhunk.snapenhance.BuildConfig
</a><a href="#h15-0-9" id="h15-0-9" class="i">+import me.rhunk.snapenhance.Logger.log
</a><a href="#h15-0-10" id="h15-0-10" class="i">+import me.rhunk.snapenhance.Logger.xposedLog
</a><a href="#h15-0-11" id="h15-0-11" class="i">+import me.rhunk.snapenhance.ModContext
</a><a href="#h15-0-12" id="h15-0-12" class="i">+import me.rhunk.snapenhance.bridge.common.BridgeMessage
</a><a href="#h15-0-13" id="h15-0-13" class="i">+import me.rhunk.snapenhance.bridge.common.BridgeMessageType
</a><a href="#h15-0-14" id="h15-0-14" class="i">+import me.rhunk.snapenhance.bridge.common.impl.*
</a><a href="#h15-0-15" id="h15-0-15" class="i">+import me.rhunk.snapenhance.bridge.service.BridgeService
</a><a href="#h15-0-16" id="h15-0-16" class="i">+import java.util.concurrent.CompletableFuture
</a><a href="#h15-0-17" id="h15-0-17" class="i">+import java.util.concurrent.Executors
</a><a href="#h15-0-18" id="h15-0-18" class="i">+import kotlin.reflect.KClass
</a><a href="#h15-0-19" id="h15-0-19" class="i">+import kotlin.system.exitProcess
</a><a href="#h15-0-20" id="h15-0-20" class="i">+
</a><a href="#h15-0-21" id="h15-0-21" class="i">+
</a><a href="#h15-0-22" id="h15-0-22" class="i">+class BridgeClient(
</a><a href="#h15-0-23" id="h15-0-23" class="i">+    private val context: ModContext
</a><a href="#h15-0-24" id="h15-0-24" class="i">+) : ServiceConnection {
</a><a href="#h15-0-25" id="h15-0-25" class="i">+    private val handlerThread = HandlerThread(&quot;BridgeClient&quot;)
</a><a href="#h15-0-26" id="h15-0-26" class="i">+
</a><a href="#h15-0-27" id="h15-0-27" class="i">+    private lateinit var messenger: Messenger
</a><a href="#h15-0-28" id="h15-0-28" class="i">+    private lateinit var future: CompletableFuture&lt;Boolean&gt;
</a><a href="#h15-0-29" id="h15-0-29" class="i">+
</a><a href="#h15-0-30" id="h15-0-30" class="i">+    fun start(callback: (Boolean) -&gt; Unit = {}) {
</a><a href="#h15-0-31" id="h15-0-31" class="i">+        this.future = CompletableFuture()
</a><a href="#h15-0-32" id="h15-0-32" class="i">+        this.handlerThread.start()
</a><a href="#h15-0-33" id="h15-0-33" class="i">+
</a><a href="#h15-0-34" id="h15-0-34" class="i">+        with(context.androidContext) {
</a><a href="#h15-0-35" id="h15-0-35" class="i">+            val intent = Intent()
</a><a href="#h15-0-36" id="h15-0-36" class="i">+                .setClassName(BuildConfig.APPLICATION_ID, BridgeService::class.java.name)
</a><a href="#h15-0-37" id="h15-0-37" class="i">+            bindService(
</a><a href="#h15-0-38" id="h15-0-38" class="i">+                intent,
</a><a href="#h15-0-39" id="h15-0-39" class="i">+                Context.BIND_AUTO_CREATE,
</a><a href="#h15-0-40" id="h15-0-40" class="i">+                Executors.newSingleThreadExecutor(),
</a><a href="#h15-0-41" id="h15-0-41" class="i">+                this@BridgeClient
</a><a href="#h15-0-42" id="h15-0-42" class="i">+            )
</a><a href="#h15-0-43" id="h15-0-43" class="i">+        }
</a><a href="#h15-0-44" id="h15-0-44" class="i">+        callback(future.get())
</a><a href="#h15-0-45" id="h15-0-45" class="i">+    }
</a><a href="#h15-0-46" id="h15-0-46" class="i">+
</a><a href="#h15-0-47" id="h15-0-47" class="i">+    private fun handleResponseMessage(
</a><a href="#h15-0-48" id="h15-0-48" class="i">+        msg: Message,
</a><a href="#h15-0-49" id="h15-0-49" class="i">+        future: CompletableFuture&lt;BridgeMessage&gt;
</a><a href="#h15-0-50" id="h15-0-50" class="i">+    ) {
</a><a href="#h15-0-51" id="h15-0-51" class="i">+        val message: BridgeMessage = when (BridgeMessageType.fromValue(msg.what)) {
</a><a href="#h15-0-52" id="h15-0-52" class="i">+            BridgeMessageType.FILE_ACCESS_RESULT -&gt; FileAccessResult()
</a><a href="#h15-0-53" id="h15-0-53" class="i">+            BridgeMessageType.DOWNLOAD_CONTENT_RESULT -&gt; DownloadContentResult()
</a><a href="#h15-0-54" id="h15-0-54" class="i">+            BridgeMessageType.MESSAGE_LOGGER_RESULT -&gt; MessageLoggerResult()
</a><a href="#h15-0-55" id="h15-0-55" class="i">+            else -&gt; {
</a><a href="#h15-0-56" id="h15-0-56" class="i">+                log(&quot;Unknown message type: ${msg.what}&quot;)
</a><a href="#h15-0-57" id="h15-0-57" class="i">+                null
</a><a href="#h15-0-58" id="h15-0-58" class="i">+            }
</a><a href="#h15-0-59" id="h15-0-59" class="i">+        } ?: return
</a><a href="#h15-0-60" id="h15-0-60" class="i">+
</a><a href="#h15-0-61" id="h15-0-61" class="i">+        with(message) {
</a><a href="#h15-0-62" id="h15-0-62" class="i">+            read(msg.data)
</a><a href="#h15-0-63" id="h15-0-63" class="i">+            future.complete(this)
</a><a href="#h15-0-64" id="h15-0-64" class="i">+        }
</a><a href="#h15-0-65" id="h15-0-65" class="i">+    }
</a><a href="#h15-0-66" id="h15-0-66" class="i">+
</a><a href="#h15-0-67" id="h15-0-67" class="i">+    @Suppress(&quot;UNCHECKED_CAST&quot;, &quot;UNUSED_PARAMETER&quot;)
</a><a href="#h15-0-68" id="h15-0-68" class="i">+    private fun &lt;T : BridgeMessage&gt; sendMessage(
</a><a href="#h15-0-69" id="h15-0-69" class="i">+        messageType: BridgeMessageType,
</a><a href="#h15-0-70" id="h15-0-70" class="i">+        message: BridgeMessage,
</a><a href="#h15-0-71" id="h15-0-71" class="i">+        resultType: KClass&lt;T&gt;? = null
</a><a href="#h15-0-72" id="h15-0-72" class="i">+    ): T {
</a><a href="#h15-0-73" id="h15-0-73" class="i">+        val future = CompletableFuture&lt;BridgeMessage&gt;()
</a><a href="#h15-0-74" id="h15-0-74" class="i">+
</a><a href="#h15-0-75" id="h15-0-75" class="i">+        val replyMessenger = Messenger(object : Handler(handlerThread.looper) {
</a><a href="#h15-0-76" id="h15-0-76" class="i">+            override fun handleMessage(msg: Message) {
</a><a href="#h15-0-77" id="h15-0-77" class="i">+                handleResponseMessage(msg, future)
</a><a href="#h15-0-78" id="h15-0-78" class="i">+            }
</a><a href="#h15-0-79" id="h15-0-79" class="i">+        })
</a><a href="#h15-0-80" id="h15-0-80" class="i">+
</a><a href="#h15-0-81" id="h15-0-81" class="i">+        runCatching {
</a><a href="#h15-0-82" id="h15-0-82" class="i">+            with(Message.obtain()) {
</a><a href="#h15-0-83" id="h15-0-83" class="i">+                what = messageType.value
</a><a href="#h15-0-84" id="h15-0-84" class="i">+                replyTo = replyMessenger
</a><a href="#h15-0-85" id="h15-0-85" class="i">+                data = Bundle()
</a><a href="#h15-0-86" id="h15-0-86" class="i">+                message.write(data)
</a><a href="#h15-0-87" id="h15-0-87" class="i">+                messenger.send(this)
</a><a href="#h15-0-88" id="h15-0-88" class="i">+            }
</a><a href="#h15-0-89" id="h15-0-89" class="i">+        }
</a><a href="#h15-0-90" id="h15-0-90" class="i">+
</a><a href="#h15-0-91" id="h15-0-91" class="i">+        return future.get() as T
</a><a href="#h15-0-92" id="h15-0-92" class="i">+    }
</a><a href="#h15-0-93" id="h15-0-93" class="i">+
</a><a href="#h15-0-94" id="h15-0-94" class="i">+    /**
</a><a href="#h15-0-95" id="h15-0-95" class="i">+     * Create a file if it doesn&#39;t exist, and read it
</a><a href="#h15-0-96" id="h15-0-96" class="i">+     *
</a><a href="#h15-0-97" id="h15-0-97" class="i">+     * @param fileType       the type of file to create and read
</a><a href="#h15-0-98" id="h15-0-98" class="i">+     * @param defaultContent the default content to write to the file if it doesn&#39;t exist
</a><a href="#h15-0-99" id="h15-0-99" class="i">+     * @return the content of the file
</a><a href="#h15-0-100" id="h15-0-100" class="i">+     */
</a><a href="#h15-0-101" id="h15-0-101" class="i">+    fun createAndReadFile(
</a><a href="#h15-0-102" id="h15-0-102" class="i">+        fileType: FileAccessRequest.FileType,
</a><a href="#h15-0-103" id="h15-0-103" class="i">+        defaultContent: ByteArray
</a><a href="#h15-0-104" id="h15-0-104" class="i">+    ): ByteArray {
</a><a href="#h15-0-105" id="h15-0-105" class="i">+        sendMessage(
</a><a href="#h15-0-106" id="h15-0-106" class="i">+            BridgeMessageType.FILE_ACCESS_REQUEST,
</a><a href="#h15-0-107" id="h15-0-107" class="i">+            FileAccessRequest(FileAccessRequest.FileAccessAction.EXISTS, fileType, null),
</a><a href="#h15-0-108" id="h15-0-108" class="i">+            FileAccessResult::class
</a><a href="#h15-0-109" id="h15-0-109" class="i">+        ).run {
</a><a href="#h15-0-110" id="h15-0-110" class="i">+            if (state!!) {
</a><a href="#h15-0-111" id="h15-0-111" class="i">+                return readFile(fileType)
</a><a href="#h15-0-112" id="h15-0-112" class="i">+            }
</a><a href="#h15-0-113" id="h15-0-113" class="i">+            writeFile(fileType, defaultContent)
</a><a href="#h15-0-114" id="h15-0-114" class="i">+            return defaultContent
</a><a href="#h15-0-115" id="h15-0-115" class="i">+        }
</a><a href="#h15-0-116" id="h15-0-116" class="i">+    }
</a><a href="#h15-0-117" id="h15-0-117" class="i">+
</a><a href="#h15-0-118" id="h15-0-118" class="i">+    /**
</a><a href="#h15-0-119" id="h15-0-119" class="i">+     * Read a file
</a><a href="#h15-0-120" id="h15-0-120" class="i">+     *
</a><a href="#h15-0-121" id="h15-0-121" class="i">+     * @param fileType the type of file to read
</a><a href="#h15-0-122" id="h15-0-122" class="i">+     * @return the content of the file
</a><a href="#h15-0-123" id="h15-0-123" class="i">+     */
</a><a href="#h15-0-124" id="h15-0-124" class="i">+    fun readFile(fileType: FileAccessRequest.FileType): ByteArray {
</a><a href="#h15-0-125" id="h15-0-125" class="i">+        sendMessage(
</a><a href="#h15-0-126" id="h15-0-126" class="i">+            BridgeMessageType.FILE_ACCESS_REQUEST,
</a><a href="#h15-0-127" id="h15-0-127" class="i">+            FileAccessRequest(FileAccessRequest.FileAccessAction.READ, fileType, null),
</a><a href="#h15-0-128" id="h15-0-128" class="i">+            FileAccessResult::class
</a><a href="#h15-0-129" id="h15-0-129" class="i">+        ).run {
</a><a href="#h15-0-130" id="h15-0-130" class="i">+            return content!!
</a><a href="#h15-0-131" id="h15-0-131" class="i">+        }
</a><a href="#h15-0-132" id="h15-0-132" class="i">+    }
</a><a href="#h15-0-133" id="h15-0-133" class="i">+
</a><a href="#h15-0-134" id="h15-0-134" class="i">+    /**
</a><a href="#h15-0-135" id="h15-0-135" class="i">+     * Write a file
</a><a href="#h15-0-136" id="h15-0-136" class="i">+     *
</a><a href="#h15-0-137" id="h15-0-137" class="i">+     * @param fileType the type of file to write
</a><a href="#h15-0-138" id="h15-0-138" class="i">+     * @param content  the content to write to the file
</a><a href="#h15-0-139" id="h15-0-139" class="i">+     * @return true if the file was written successfully
</a><a href="#h15-0-140" id="h15-0-140" class="i">+     */
</a><a href="#h15-0-141" id="h15-0-141" class="i">+    fun writeFile(
</a><a href="#h15-0-142" id="h15-0-142" class="i">+        fileType: FileAccessRequest.FileType,
</a><a href="#h15-0-143" id="h15-0-143" class="i">+        content: ByteArray?
</a><a href="#h15-0-144" id="h15-0-144" class="i">+    ): Boolean {
</a><a href="#h15-0-145" id="h15-0-145" class="i">+        sendMessage(
</a><a href="#h15-0-146" id="h15-0-146" class="i">+            BridgeMessageType.FILE_ACCESS_REQUEST,
</a><a href="#h15-0-147" id="h15-0-147" class="i">+            FileAccessRequest(FileAccessRequest.FileAccessAction.WRITE, fileType, content),
</a><a href="#h15-0-148" id="h15-0-148" class="i">+            FileAccessResult::class
</a><a href="#h15-0-149" id="h15-0-149" class="i">+        ).run {
</a><a href="#h15-0-150" id="h15-0-150" class="i">+            return state!!
</a><a href="#h15-0-151" id="h15-0-151" class="i">+        }
</a><a href="#h15-0-152" id="h15-0-152" class="i">+    }
</a><a href="#h15-0-153" id="h15-0-153" class="i">+
</a><a href="#h15-0-154" id="h15-0-154" class="i">+    /**
</a><a href="#h15-0-155" id="h15-0-155" class="i">+     * Delete a file
</a><a href="#h15-0-156" id="h15-0-156" class="i">+     *
</a><a href="#h15-0-157" id="h15-0-157" class="i">+     * @param fileType the type of file to delete
</a><a href="#h15-0-158" id="h15-0-158" class="i">+     * @return true if the file was deleted successfully
</a><a href="#h15-0-159" id="h15-0-159" class="i">+     */
</a><a href="#h15-0-160" id="h15-0-160" class="i">+    fun deleteFile(fileType: FileAccessRequest.FileType): Boolean {
</a><a href="#h15-0-161" id="h15-0-161" class="i">+        sendMessage(
</a><a href="#h15-0-162" id="h15-0-162" class="i">+            BridgeMessageType.FILE_ACCESS_REQUEST,
</a><a href="#h15-0-163" id="h15-0-163" class="i">+            FileAccessRequest(FileAccessRequest.FileAccessAction.DELETE, fileType, null),
</a><a href="#h15-0-164" id="h15-0-164" class="i">+            FileAccessResult::class
</a><a href="#h15-0-165" id="h15-0-165" class="i">+        ).run {
</a><a href="#h15-0-166" id="h15-0-166" class="i">+            return state!!
</a><a href="#h15-0-167" id="h15-0-167" class="i">+        }
</a><a href="#h15-0-168" id="h15-0-168" class="i">+    }
</a><a href="#h15-0-169" id="h15-0-169" class="i">+
</a><a href="#h15-0-170" id="h15-0-170" class="i">+    /**
</a><a href="#h15-0-171" id="h15-0-171" class="i">+     * Check if a file exists
</a><a href="#h15-0-172" id="h15-0-172" class="i">+     *
</a><a href="#h15-0-173" id="h15-0-173" class="i">+     * @param fileType the type of file to check
</a><a href="#h15-0-174" id="h15-0-174" class="i">+     * @return true if the file exists
</a><a href="#h15-0-175" id="h15-0-175" class="i">+     */
</a><a href="#h15-0-176" id="h15-0-176" class="i">+
</a><a href="#h15-0-177" id="h15-0-177" class="i">+    fun isFileExists(fileType: FileAccessRequest.FileType): Boolean {
</a><a href="#h15-0-178" id="h15-0-178" class="i">+        sendMessage(
</a><a href="#h15-0-179" id="h15-0-179" class="i">+            BridgeMessageType.FILE_ACCESS_REQUEST,
</a><a href="#h15-0-180" id="h15-0-180" class="i">+            FileAccessRequest(FileAccessRequest.FileAccessAction.EXISTS, fileType, null),
</a><a href="#h15-0-181" id="h15-0-181" class="i">+            FileAccessResult::class
</a><a href="#h15-0-182" id="h15-0-182" class="i">+        ).run {
</a><a href="#h15-0-183" id="h15-0-183" class="i">+            return state!!
</a><a href="#h15-0-184" id="h15-0-184" class="i">+        }
</a><a href="#h15-0-185" id="h15-0-185" class="i">+    }
</a><a href="#h15-0-186" id="h15-0-186" class="i">+
</a><a href="#h15-0-187" id="h15-0-187" class="i">+    /**
</a><a href="#h15-0-188" id="h15-0-188" class="i">+     * Download content from a URL and save it to a file
</a><a href="#h15-0-189" id="h15-0-189" class="i">+     *
</a><a href="#h15-0-190" id="h15-0-190" class="i">+     * @param url  the URL to download content from
</a><a href="#h15-0-191" id="h15-0-191" class="i">+     * @param path the path to save the content to
</a><a href="#h15-0-192" id="h15-0-192" class="i">+     * @return true if the content was downloaded successfully
</a><a href="#h15-0-193" id="h15-0-193" class="i">+     */
</a><a href="#h15-0-194" id="h15-0-194" class="i">+    fun downloadContent(url: String, path: String): Boolean {
</a><a href="#h15-0-195" id="h15-0-195" class="i">+        sendMessage(
</a><a href="#h15-0-196" id="h15-0-196" class="i">+            BridgeMessageType.DOWNLOAD_CONTENT_REQUEST,
</a><a href="#h15-0-197" id="h15-0-197" class="i">+            DownloadContentRequest(url, path),
</a><a href="#h15-0-198" id="h15-0-198" class="i">+            DownloadContentResult::class
</a><a href="#h15-0-199" id="h15-0-199" class="i">+        ).run {
</a><a href="#h15-0-200" id="h15-0-200" class="i">+            return state!!
</a><a href="#h15-0-201" id="h15-0-201" class="i">+        }
</a><a href="#h15-0-202" id="h15-0-202" class="i">+    }
</a><a href="#h15-0-203" id="h15-0-203" class="i">+
</a><a href="#h15-0-204" id="h15-0-204" class="i">+    fun getMessageLoggerMessage(id: Long): ByteArray? {
</a><a href="#h15-0-205" id="h15-0-205" class="i">+        sendMessage(
</a><a href="#h15-0-206" id="h15-0-206" class="i">+            BridgeMessageType.MESSAGE_LOGGER_REQUEST,
</a><a href="#h15-0-207" id="h15-0-207" class="i">+            MessageLoggerRequest(MessageLoggerRequest.Action.GET, id),
</a><a href="#h15-0-208" id="h15-0-208" class="i">+            MessageLoggerResult::class
</a><a href="#h15-0-209" id="h15-0-209" class="i">+        ).run {
</a><a href="#h15-0-210" id="h15-0-210" class="i">+            return message
</a><a href="#h15-0-211" id="h15-0-211" class="i">+        }
</a><a href="#h15-0-212" id="h15-0-212" class="i">+    }
</a><a href="#h15-0-213" id="h15-0-213" class="i">+
</a><a href="#h15-0-214" id="h15-0-214" class="i">+    fun addMessageLoggerMessage(id: Long, message: ByteArray) {
</a><a href="#h15-0-215" id="h15-0-215" class="i">+        sendMessage(
</a><a href="#h15-0-216" id="h15-0-216" class="i">+            BridgeMessageType.MESSAGE_LOGGER_REQUEST,
</a><a href="#h15-0-217" id="h15-0-217" class="i">+            MessageLoggerRequest(MessageLoggerRequest.Action.ADD, id, message),
</a><a href="#h15-0-218" id="h15-0-218" class="i">+            MessageLoggerResult::class
</a><a href="#h15-0-219" id="h15-0-219" class="i">+        )
</a><a href="#h15-0-220" id="h15-0-220" class="i">+    }
</a><a href="#h15-0-221" id="h15-0-221" class="i">+
</a><a href="#h15-0-222" id="h15-0-222" class="i">+    override fun onServiceConnected(name: ComponentName, service: IBinder) {
</a><a href="#h15-0-223" id="h15-0-223" class="i">+        messenger = Messenger(service)
</a><a href="#h15-0-224" id="h15-0-224" class="i">+        future.complete(true)
</a><a href="#h15-0-225" id="h15-0-225" class="i">+    }
</a><a href="#h15-0-226" id="h15-0-226" class="i">+
</a><a href="#h15-0-227" id="h15-0-227" class="i">+    override fun onNullBinding(name: ComponentName) {
</a><a href="#h15-0-228" id="h15-0-228" class="i">+        xposedLog(&quot;failed to connect to bridge service&quot;)
</a><a href="#h15-0-229" id="h15-0-229" class="i">+        future.complete(false)
</a><a href="#h15-0-230" id="h15-0-230" class="i">+    }
</a><a href="#h15-0-231" id="h15-0-231" class="i">+
</a><a href="#h15-0-232" id="h15-0-232" class="i">+    override fun onServiceDisconnected(name: ComponentName) {
</a><a href="#h15-0-233" id="h15-0-233" class="i">+        context.longToast(&quot;Bridge service disconnected&quot;)
</a><a href="#h15-0-234" id="h15-0-234" class="i">+        Thread.sleep(1000)
</a><a href="#h15-0-235" id="h15-0-235" class="i">+        exitProcess(0)
</a><a href="#h15-0-236" id="h15-0-236" class="i">+    }
</a><a href="#h15-0-237" id="h15-0-237" class="i">+}
</a><b>diff --git a/<a id="h16" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/BridgeMessage.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/BridgeMessage.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/BridgeMessage.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/BridgeMessage.kt</a></b>
<a href="#h16-0" id="h16-0" class="h">@@ -0,0 +1,16 @@
</a><a href="#h16-0-0" id="h16-0-0" class="i">+package me.rhunk.snapenhance.bridge.common
</a><a href="#h16-0-1" id="h16-0-1" class="i">+
</a><a href="#h16-0-2" id="h16-0-2" class="i">+import android.os.Bundle
</a><a href="#h16-0-3" id="h16-0-3" class="i">+import android.os.Message
</a><a href="#h16-0-4" id="h16-0-4" class="i">+
</a><a href="#h16-0-5" id="h16-0-5" class="i">+abstract class BridgeMessage {
</a><a href="#h16-0-6" id="h16-0-6" class="i">+    abstract fun write(bundle: Bundle)
</a><a href="#h16-0-7" id="h16-0-7" class="i">+    abstract fun read(bundle: Bundle)
</a><a href="#h16-0-8" id="h16-0-8" class="i">+
</a><a href="#h16-0-9" id="h16-0-9" class="i">+    fun toMessage(what: Int): Message {
</a><a href="#h16-0-10" id="h16-0-10" class="i">+        val message = Message.obtain(null, what)
</a><a href="#h16-0-11" id="h16-0-11" class="i">+        message.data = Bundle()
</a><a href="#h16-0-12" id="h16-0-12" class="i">+        write(message.data)
</a><a href="#h16-0-13" id="h16-0-13" class="i">+        return message
</a><a href="#h16-0-14" id="h16-0-14" class="i">+    }
</a><a href="#h16-0-15" id="h16-0-15" class="i">+}
</a><b>diff --git a/<a id="h17" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/BridgeMessageType.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/BridgeMessageType.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/BridgeMessageType.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/BridgeMessageType.kt</a></b>
<a href="#h17-0" id="h17-0" class="h">@@ -0,0 +1,22 @@
</a><a href="#h17-0-0" id="h17-0-0" class="i">+package me.rhunk.snapenhance.bridge.common
</a><a href="#h17-0-1" id="h17-0-1" class="i">+
</a><a href="#h17-0-2" id="h17-0-2" class="i">+
</a><a href="#h17-0-3" id="h17-0-3" class="i">+enum class BridgeMessageType(
</a><a href="#h17-0-4" id="h17-0-4" class="i">+    val value: Int = 0
</a><a href="#h17-0-5" id="h17-0-5" class="i">+) {
</a><a href="#h17-0-6" id="h17-0-6" class="i">+    UNKNOWN(-1),
</a><a href="#h17-0-7" id="h17-0-7" class="i">+    FILE_ACCESS_REQUEST(0),
</a><a href="#h17-0-8" id="h17-0-8" class="i">+    FILE_ACCESS_RESULT(1),
</a><a href="#h17-0-9" id="h17-0-9" class="i">+    DOWNLOAD_CONTENT_REQUEST(2),
</a><a href="#h17-0-10" id="h17-0-10" class="i">+    DOWNLOAD_CONTENT_RESULT(3),
</a><a href="#h17-0-11" id="h17-0-11" class="i">+    LOCALE_REQUEST(4),
</a><a href="#h17-0-12" id="h17-0-12" class="i">+    LOCALE_RESULT(5),
</a><a href="#h17-0-13" id="h17-0-13" class="i">+    MESSAGE_LOGGER_REQUEST(6),
</a><a href="#h17-0-14" id="h17-0-14" class="i">+    MESSAGE_LOGGER_RESULT(7);
</a><a href="#h17-0-15" id="h17-0-15" class="i">+
</a><a href="#h17-0-16" id="h17-0-16" class="i">+    companion object {
</a><a href="#h17-0-17" id="h17-0-17" class="i">+        fun fromValue(value: Int): BridgeMessageType {
</a><a href="#h17-0-18" id="h17-0-18" class="i">+            return values().firstOrNull { it.value == value } ?: UNKNOWN
</a><a href="#h17-0-19" id="h17-0-19" class="i">+        }
</a><a href="#h17-0-20" id="h17-0-20" class="i">+    }
</a><a href="#h17-0-21" id="h17-0-21" class="i">+}
</a><b>diff --git a/<a id="h18" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/impl/DownloadContentRequest.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/impl/DownloadContentRequest.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/impl/DownloadContentRequest.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/impl/DownloadContentRequest.kt</a></b>
<a href="#h18-0" id="h18-0" class="h">@@ -0,0 +1,20 @@
</a><a href="#h18-0-0" id="h18-0-0" class="i">+package me.rhunk.snapenhance.bridge.common.impl
</a><a href="#h18-0-1" id="h18-0-1" class="i">+
</a><a href="#h18-0-2" id="h18-0-2" class="i">+import android.os.Bundle
</a><a href="#h18-0-3" id="h18-0-3" class="i">+import me.rhunk.snapenhance.bridge.common.BridgeMessage
</a><a href="#h18-0-4" id="h18-0-4" class="i">+
</a><a href="#h18-0-5" id="h18-0-5" class="i">+class DownloadContentRequest(
</a><a href="#h18-0-6" id="h18-0-6" class="i">+    var url: String? = null,
</a><a href="#h18-0-7" id="h18-0-7" class="i">+    var path: String? = null
</a><a href="#h18-0-8" id="h18-0-8" class="i">+) : BridgeMessage() {
</a><a href="#h18-0-9" id="h18-0-9" class="i">+
</a><a href="#h18-0-10" id="h18-0-10" class="i">+    override fun write(bundle: Bundle) {
</a><a href="#h18-0-11" id="h18-0-11" class="i">+        bundle.putString(&quot;url&quot;, url)
</a><a href="#h18-0-12" id="h18-0-12" class="i">+        bundle.putString(&quot;path&quot;, path)
</a><a href="#h18-0-13" id="h18-0-13" class="i">+    }
</a><a href="#h18-0-14" id="h18-0-14" class="i">+
</a><a href="#h18-0-15" id="h18-0-15" class="i">+    override fun read(bundle: Bundle) {
</a><a href="#h18-0-16" id="h18-0-16" class="i">+        url = bundle.getString(&quot;url&quot;)
</a><a href="#h18-0-17" id="h18-0-17" class="i">+        path = bundle.getString(&quot;path&quot;)
</a><a href="#h18-0-18" id="h18-0-18" class="i">+    }
</a><a href="#h18-0-19" id="h18-0-19" class="i">+}
</a><b>diff --git a/<a id="h19" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/impl/DownloadContentResult.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/impl/DownloadContentResult.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/impl/DownloadContentResult.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/impl/DownloadContentResult.kt</a></b>
<a href="#h19-0" id="h19-0" class="h">@@ -0,0 +1,17 @@
</a><a href="#h19-0-0" id="h19-0-0" class="i">+package me.rhunk.snapenhance.bridge.common.impl
</a><a href="#h19-0-1" id="h19-0-1" class="i">+
</a><a href="#h19-0-2" id="h19-0-2" class="i">+import android.os.Bundle
</a><a href="#h19-0-3" id="h19-0-3" class="i">+import me.rhunk.snapenhance.bridge.common.BridgeMessage
</a><a href="#h19-0-4" id="h19-0-4" class="i">+
</a><a href="#h19-0-5" id="h19-0-5" class="i">+class DownloadContentResult(
</a><a href="#h19-0-6" id="h19-0-6" class="i">+    var state: Boolean? = null
</a><a href="#h19-0-7" id="h19-0-7" class="i">+) : BridgeMessage() {
</a><a href="#h19-0-8" id="h19-0-8" class="i">+
</a><a href="#h19-0-9" id="h19-0-9" class="i">+    override fun write(bundle: Bundle) {
</a><a href="#h19-0-10" id="h19-0-10" class="i">+        bundle.putBoolean(&quot;state&quot;, state!!)
</a><a href="#h19-0-11" id="h19-0-11" class="i">+    }
</a><a href="#h19-0-12" id="h19-0-12" class="i">+
</a><a href="#h19-0-13" id="h19-0-13" class="i">+    override fun read(bundle: Bundle) {
</a><a href="#h19-0-14" id="h19-0-14" class="i">+        state = bundle.getBoolean(&quot;state&quot;)
</a><a href="#h19-0-15" id="h19-0-15" class="i">+    }
</a><a href="#h19-0-16" id="h19-0-16" class="i">+}
</a><b>diff --git a/<a id="h20" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/impl/FileAccessRequest.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/impl/FileAccessRequest.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/impl/FileAccessRequest.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/impl/FileAccessRequest.kt</a></b>
<a href="#h20-0" id="h20-0" class="h">@@ -0,0 +1,43 @@
</a><a href="#h20-0-0" id="h20-0-0" class="i">+package me.rhunk.snapenhance.bridge.common.impl
</a><a href="#h20-0-1" id="h20-0-1" class="i">+
</a><a href="#h20-0-2" id="h20-0-2" class="i">+import android.os.Bundle
</a><a href="#h20-0-3" id="h20-0-3" class="i">+import me.rhunk.snapenhance.bridge.common.BridgeMessage
</a><a href="#h20-0-4" id="h20-0-4" class="i">+
</a><a href="#h20-0-5" id="h20-0-5" class="i">+class FileAccessRequest(
</a><a href="#h20-0-6" id="h20-0-6" class="i">+    var action: FileAccessAction? = null,
</a><a href="#h20-0-7" id="h20-0-7" class="i">+    var fileType: FileType? = null,
</a><a href="#h20-0-8" id="h20-0-8" class="i">+    var content: ByteArray? = null
</a><a href="#h20-0-9" id="h20-0-9" class="i">+) : BridgeMessage() {
</a><a href="#h20-0-10" id="h20-0-10" class="i">+
</a><a href="#h20-0-11" id="h20-0-11" class="i">+    override fun write(bundle: Bundle) {
</a><a href="#h20-0-12" id="h20-0-12" class="i">+        bundle.putInt(&quot;action&quot;, action!!.value)
</a><a href="#h20-0-13" id="h20-0-13" class="i">+        bundle.putInt(&quot;fileType&quot;, fileType!!.value)
</a><a href="#h20-0-14" id="h20-0-14" class="i">+        bundle.putByteArray(&quot;content&quot;, content)
</a><a href="#h20-0-15" id="h20-0-15" class="i">+    }
</a><a href="#h20-0-16" id="h20-0-16" class="i">+
</a><a href="#h20-0-17" id="h20-0-17" class="i">+    override fun read(bundle: Bundle) {
</a><a href="#h20-0-18" id="h20-0-18" class="i">+        action = FileAccessAction.fromValue(bundle.getInt(&quot;action&quot;))
</a><a href="#h20-0-19" id="h20-0-19" class="i">+        fileType = FileType.fromValue(bundle.getInt(&quot;fileType&quot;))
</a><a href="#h20-0-20" id="h20-0-20" class="i">+        content = bundle.getByteArray(&quot;content&quot;)
</a><a href="#h20-0-21" id="h20-0-21" class="i">+    }
</a><a href="#h20-0-22" id="h20-0-22" class="i">+
</a><a href="#h20-0-23" id="h20-0-23" class="i">+    enum class FileType(val value: Int) {
</a><a href="#h20-0-24" id="h20-0-24" class="i">+        CONFIG(0), MAPPINGS(1), STEALTH(2);
</a><a href="#h20-0-25" id="h20-0-25" class="i">+
</a><a href="#h20-0-26" id="h20-0-26" class="i">+        companion object {
</a><a href="#h20-0-27" id="h20-0-27" class="i">+            fun fromValue(value: Int): FileType? {
</a><a href="#h20-0-28" id="h20-0-28" class="i">+                return values().firstOrNull { it.value == value }
</a><a href="#h20-0-29" id="h20-0-29" class="i">+            }
</a><a href="#h20-0-30" id="h20-0-30" class="i">+        }
</a><a href="#h20-0-31" id="h20-0-31" class="i">+    }
</a><a href="#h20-0-32" id="h20-0-32" class="i">+
</a><a href="#h20-0-33" id="h20-0-33" class="i">+    enum class FileAccessAction(val value: Int) {
</a><a href="#h20-0-34" id="h20-0-34" class="i">+        READ(0), WRITE(1), DELETE(2), EXISTS(3);
</a><a href="#h20-0-35" id="h20-0-35" class="i">+
</a><a href="#h20-0-36" id="h20-0-36" class="i">+        companion object {
</a><a href="#h20-0-37" id="h20-0-37" class="i">+            fun fromValue(value: Int): FileAccessAction? {
</a><a href="#h20-0-38" id="h20-0-38" class="i">+                return values().firstOrNull { it.value == value }
</a><a href="#h20-0-39" id="h20-0-39" class="i">+            }
</a><a href="#h20-0-40" id="h20-0-40" class="i">+        }
</a><a href="#h20-0-41" id="h20-0-41" class="i">+    }
</a><a href="#h20-0-42" id="h20-0-42" class="i">+}
</a><b>diff --git a/<a id="h21" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/impl/FileAccessResult.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/impl/FileAccessResult.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/impl/FileAccessResult.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/impl/FileAccessResult.kt</a></b>
<a href="#h21-0" id="h21-0" class="h">@@ -0,0 +1,20 @@
</a><a href="#h21-0-0" id="h21-0-0" class="i">+package me.rhunk.snapenhance.bridge.common.impl
</a><a href="#h21-0-1" id="h21-0-1" class="i">+
</a><a href="#h21-0-2" id="h21-0-2" class="i">+import android.os.Bundle
</a><a href="#h21-0-3" id="h21-0-3" class="i">+import me.rhunk.snapenhance.bridge.common.BridgeMessage
</a><a href="#h21-0-4" id="h21-0-4" class="i">+
</a><a href="#h21-0-5" id="h21-0-5" class="i">+class FileAccessResult(
</a><a href="#h21-0-6" id="h21-0-6" class="i">+    var state: Boolean? = null,
</a><a href="#h21-0-7" id="h21-0-7" class="i">+    var content: ByteArray? = null
</a><a href="#h21-0-8" id="h21-0-8" class="i">+) : BridgeMessage() {
</a><a href="#h21-0-9" id="h21-0-9" class="i">+
</a><a href="#h21-0-10" id="h21-0-10" class="i">+    override fun write(bundle: Bundle) {
</a><a href="#h21-0-11" id="h21-0-11" class="i">+        bundle.putBoolean(&quot;state&quot;, state!!)
</a><a href="#h21-0-12" id="h21-0-12" class="i">+        bundle.putByteArray(&quot;content&quot;, content)
</a><a href="#h21-0-13" id="h21-0-13" class="i">+    }
</a><a href="#h21-0-14" id="h21-0-14" class="i">+
</a><a href="#h21-0-15" id="h21-0-15" class="i">+    override fun read(bundle: Bundle) {
</a><a href="#h21-0-16" id="h21-0-16" class="i">+        state = bundle.getBoolean(&quot;state&quot;)
</a><a href="#h21-0-17" id="h21-0-17" class="i">+        content = bundle.getByteArray(&quot;content&quot;)
</a><a href="#h21-0-18" id="h21-0-18" class="i">+    }
</a><a href="#h21-0-19" id="h21-0-19" class="i">+}
</a><b>diff --git a/<a id="h22" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/impl/LocaleRequest.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/impl/LocaleRequest.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/impl/LocaleRequest.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/impl/LocaleRequest.kt</a></b>
<a href="#h22-0" id="h22-0" class="h">@@ -0,0 +1,17 @@
</a><a href="#h22-0-0" id="h22-0-0" class="i">+package me.rhunk.snapenhance.bridge.common.impl
</a><a href="#h22-0-1" id="h22-0-1" class="i">+
</a><a href="#h22-0-2" id="h22-0-2" class="i">+import android.os.Bundle
</a><a href="#h22-0-3" id="h22-0-3" class="i">+import me.rhunk.snapenhance.bridge.common.BridgeMessage
</a><a href="#h22-0-4" id="h22-0-4" class="i">+
</a><a href="#h22-0-5" id="h22-0-5" class="i">+class LocaleRequest(
</a><a href="#h22-0-6" id="h22-0-6" class="i">+    var locale: String? = null
</a><a href="#h22-0-7" id="h22-0-7" class="i">+) : BridgeMessage() {
</a><a href="#h22-0-8" id="h22-0-8" class="i">+
</a><a href="#h22-0-9" id="h22-0-9" class="i">+    override fun write(bundle: Bundle) {
</a><a href="#h22-0-10" id="h22-0-10" class="i">+        bundle.putString(&quot;locale&quot;, locale)
</a><a href="#h22-0-11" id="h22-0-11" class="i">+    }
</a><a href="#h22-0-12" id="h22-0-12" class="i">+
</a><a href="#h22-0-13" id="h22-0-13" class="i">+    override fun read(bundle: Bundle) {
</a><a href="#h22-0-14" id="h22-0-14" class="i">+        locale = bundle.getString(&quot;locale&quot;)
</a><a href="#h22-0-15" id="h22-0-15" class="i">+    }
</a><a href="#h22-0-16" id="h22-0-16" class="i">+}</a><a href="#h22-0-17" id="h22-0-17" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h23" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/impl/LocaleResult.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/impl/LocaleResult.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/impl/LocaleResult.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/impl/LocaleResult.kt</a></b>
<a href="#h23-0" id="h23-0" class="h">@@ -0,0 +1,19 @@
</a><a href="#h23-0-0" id="h23-0-0" class="i">+package me.rhunk.snapenhance.bridge.common.impl
</a><a href="#h23-0-1" id="h23-0-1" class="i">+
</a><a href="#h23-0-2" id="h23-0-2" class="i">+import android.os.Bundle
</a><a href="#h23-0-3" id="h23-0-3" class="i">+import me.rhunk.snapenhance.bridge.common.BridgeMessage
</a><a href="#h23-0-4" id="h23-0-4" class="i">+
</a><a href="#h23-0-5" id="h23-0-5" class="i">+class LocaleResult(
</a><a href="#h23-0-6" id="h23-0-6" class="i">+    var locale: String? = null,
</a><a href="#h23-0-7" id="h23-0-7" class="i">+    var content: ByteArray? = null
</a><a href="#h23-0-8" id="h23-0-8" class="i">+) : BridgeMessage(){
</a><a href="#h23-0-9" id="h23-0-9" class="i">+    override fun write(bundle: Bundle) {
</a><a href="#h23-0-10" id="h23-0-10" class="i">+        bundle.putString(&quot;locale&quot;, locale)
</a><a href="#h23-0-11" id="h23-0-11" class="i">+        bundle.putByteArray(&quot;content&quot;, content)
</a><a href="#h23-0-12" id="h23-0-12" class="i">+    }
</a><a href="#h23-0-13" id="h23-0-13" class="i">+
</a><a href="#h23-0-14" id="h23-0-14" class="i">+    override fun read(bundle: Bundle) {
</a><a href="#h23-0-15" id="h23-0-15" class="i">+        locale = bundle.getString(&quot;locale&quot;)
</a><a href="#h23-0-16" id="h23-0-16" class="i">+        content = bundle.getByteArray(&quot;content&quot;)
</a><a href="#h23-0-17" id="h23-0-17" class="i">+    }
</a><a href="#h23-0-18" id="h23-0-18" class="i">+}</a><a href="#h23-0-19" id="h23-0-19" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h24" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/impl/MessageLoggerRequest.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/impl/MessageLoggerRequest.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/impl/MessageLoggerRequest.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/impl/MessageLoggerRequest.kt</a></b>
<a href="#h24-0" id="h24-0" class="h">@@ -0,0 +1,29 @@
</a><a href="#h24-0-0" id="h24-0-0" class="i">+package me.rhunk.snapenhance.bridge.common.impl
</a><a href="#h24-0-1" id="h24-0-1" class="i">+
</a><a href="#h24-0-2" id="h24-0-2" class="i">+import android.os.Bundle
</a><a href="#h24-0-3" id="h24-0-3" class="i">+import me.rhunk.snapenhance.bridge.common.BridgeMessage
</a><a href="#h24-0-4" id="h24-0-4" class="i">+
</a><a href="#h24-0-5" id="h24-0-5" class="i">+class MessageLoggerRequest(
</a><a href="#h24-0-6" id="h24-0-6" class="i">+    var action: Action? = null,
</a><a href="#h24-0-7" id="h24-0-7" class="i">+    var messageId: Long? = null,
</a><a href="#h24-0-8" id="h24-0-8" class="i">+    var message: ByteArray? = null
</a><a href="#h24-0-9" id="h24-0-9" class="i">+) : BridgeMessage(){
</a><a href="#h24-0-10" id="h24-0-10" class="i">+
</a><a href="#h24-0-11" id="h24-0-11" class="i">+    override fun write(bundle: Bundle) {
</a><a href="#h24-0-12" id="h24-0-12" class="i">+        bundle.putString(&quot;action&quot;, action!!.name)
</a><a href="#h24-0-13" id="h24-0-13" class="i">+        bundle.putLong(&quot;messageId&quot;, messageId!!)
</a><a href="#h24-0-14" id="h24-0-14" class="i">+        bundle.putByteArray(&quot;message&quot;, message)
</a><a href="#h24-0-15" id="h24-0-15" class="i">+    }
</a><a href="#h24-0-16" id="h24-0-16" class="i">+
</a><a href="#h24-0-17" id="h24-0-17" class="i">+    override fun read(bundle: Bundle) {
</a><a href="#h24-0-18" id="h24-0-18" class="i">+        action = Action.valueOf(bundle.getString(&quot;action&quot;)!!)
</a><a href="#h24-0-19" id="h24-0-19" class="i">+        messageId = bundle.getLong(&quot;messageId&quot;)
</a><a href="#h24-0-20" id="h24-0-20" class="i">+        message = bundle.getByteArray(&quot;message&quot;)
</a><a href="#h24-0-21" id="h24-0-21" class="i">+    }
</a><a href="#h24-0-22" id="h24-0-22" class="i">+
</a><a href="#h24-0-23" id="h24-0-23" class="i">+    enum class Action {
</a><a href="#h24-0-24" id="h24-0-24" class="i">+        ADD,
</a><a href="#h24-0-25" id="h24-0-25" class="i">+        GET,
</a><a href="#h24-0-26" id="h24-0-26" class="i">+        CLEAR
</a><a href="#h24-0-27" id="h24-0-27" class="i">+    }
</a><a href="#h24-0-28" id="h24-0-28" class="i">+}</a><a href="#h24-0-29" id="h24-0-29" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h25" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/impl/MessageLoggerResult.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/impl/MessageLoggerResult.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/impl/MessageLoggerResult.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/common/impl/MessageLoggerResult.kt</a></b>
<a href="#h25-0" id="h25-0" class="h">@@ -0,0 +1,20 @@
</a><a href="#h25-0-0" id="h25-0-0" class="i">+package me.rhunk.snapenhance.bridge.common.impl
</a><a href="#h25-0-1" id="h25-0-1" class="i">+
</a><a href="#h25-0-2" id="h25-0-2" class="i">+import android.os.Bundle
</a><a href="#h25-0-3" id="h25-0-3" class="i">+import me.rhunk.snapenhance.bridge.common.BridgeMessage
</a><a href="#h25-0-4" id="h25-0-4" class="i">+
</a><a href="#h25-0-5" id="h25-0-5" class="i">+class MessageLoggerResult(
</a><a href="#h25-0-6" id="h25-0-6" class="i">+    var state: Boolean? = null,
</a><a href="#h25-0-7" id="h25-0-7" class="i">+    var message: ByteArray? = null
</a><a href="#h25-0-8" id="h25-0-8" class="i">+) : BridgeMessage() {
</a><a href="#h25-0-9" id="h25-0-9" class="i">+
</a><a href="#h25-0-10" id="h25-0-10" class="i">+    override fun write(bundle: Bundle) {
</a><a href="#h25-0-11" id="h25-0-11" class="i">+        bundle.putBoolean(&quot;state&quot;, state!!)
</a><a href="#h25-0-12" id="h25-0-12" class="i">+        bundle.putByteArray(&quot;message&quot;, message)
</a><a href="#h25-0-13" id="h25-0-13" class="i">+    }
</a><a href="#h25-0-14" id="h25-0-14" class="i">+
</a><a href="#h25-0-15" id="h25-0-15" class="i">+    override fun read(bundle: Bundle) {
</a><a href="#h25-0-16" id="h25-0-16" class="i">+        state = bundle.getBoolean(&quot;state&quot;)
</a><a href="#h25-0-17" id="h25-0-17" class="i">+        message = bundle.getByteArray(&quot;message&quot;)
</a><a href="#h25-0-18" id="h25-0-18" class="i">+    }
</a><a href="#h25-0-19" id="h25-0-19" class="i">+}</a><a href="#h25-0-20" id="h25-0-20" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h26" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/service/BridgeService.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/service/BridgeService.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/service/BridgeService.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/service/BridgeService.kt</a></b>
<a href="#h26-0" id="h26-0" class="h">@@ -0,0 +1,180 @@
</a><a href="#h26-0-0" id="h26-0-0" class="i">+package me.rhunk.snapenhance.bridge.service
</a><a href="#h26-0-1" id="h26-0-1" class="i">+
</a><a href="#h26-0-2" id="h26-0-2" class="i">+import android.app.DownloadManager
</a><a href="#h26-0-3" id="h26-0-3" class="i">+import android.app.Service
</a><a href="#h26-0-4" id="h26-0-4" class="i">+import android.content.*
</a><a href="#h26-0-5" id="h26-0-5" class="i">+import android.database.sqlite.SQLiteDatabase
</a><a href="#h26-0-6" id="h26-0-6" class="i">+import android.net.Uri
</a><a href="#h26-0-7" id="h26-0-7" class="i">+import android.os.*
</a><a href="#h26-0-8" id="h26-0-8" class="i">+import me.rhunk.snapenhance.Logger
</a><a href="#h26-0-9" id="h26-0-9" class="i">+import me.rhunk.snapenhance.bridge.common.BridgeMessageType
</a><a href="#h26-0-10" id="h26-0-10" class="i">+import me.rhunk.snapenhance.bridge.common.impl.*
</a><a href="#h26-0-11" id="h26-0-11" class="i">+import java.io.File
</a><a href="#h26-0-12" id="h26-0-12" class="i">+
</a><a href="#h26-0-13" id="h26-0-13" class="i">+class BridgeService : Service() {
</a><a href="#h26-0-14" id="h26-0-14" class="i">+    companion object {
</a><a href="#h26-0-15" id="h26-0-15" class="i">+        const val CONFIG_FILE = &quot;config.json&quot;
</a><a href="#h26-0-16" id="h26-0-16" class="i">+        const val MAPPINGS_FILE = &quot;mappings.json&quot;
</a><a href="#h26-0-17" id="h26-0-17" class="i">+        const val STEALTH_FILE = &quot;stealth.txt&quot;
</a><a href="#h26-0-18" id="h26-0-18" class="i">+        const val MESSAGE_LOGGER_DATABASE = &quot;message_logger&quot;
</a><a href="#h26-0-19" id="h26-0-19" class="i">+    }
</a><a href="#h26-0-20" id="h26-0-20" class="i">+
</a><a href="#h26-0-21" id="h26-0-21" class="i">+    lateinit var messageLoggerDatabase: SQLiteDatabase
</a><a href="#h26-0-22" id="h26-0-22" class="i">+
</a><a href="#h26-0-23" id="h26-0-23" class="i">+    override fun onBind(intent: Intent): IBinder {
</a><a href="#h26-0-24" id="h26-0-24" class="i">+        with(openOrCreateDatabase(MESSAGE_LOGGER_DATABASE, Context.MODE_PRIVATE, null)) {
</a><a href="#h26-0-25" id="h26-0-25" class="i">+            messageLoggerDatabase = this
</a><a href="#h26-0-26" id="h26-0-26" class="i">+            execSQL(&quot;CREATE TABLE IF NOT EXISTS messages (message_id INTEGER PRIMARY KEY, serialized_message BLOB)&quot;)
</a><a href="#h26-0-27" id="h26-0-27" class="i">+        }
</a><a href="#h26-0-28" id="h26-0-28" class="i">+
</a><a href="#h26-0-29" id="h26-0-29" class="i">+        return Messenger(object : Handler(Looper.getMainLooper()) {
</a><a href="#h26-0-30" id="h26-0-30" class="i">+            override fun handleMessage(msg: Message) {
</a><a href="#h26-0-31" id="h26-0-31" class="i">+                runCatching {
</a><a href="#h26-0-32" id="h26-0-32" class="i">+                    this@BridgeService.handleMessage(msg)
</a><a href="#h26-0-33" id="h26-0-33" class="i">+                }.onFailure {
</a><a href="#h26-0-34" id="h26-0-34" class="i">+                    Logger.error(&quot;Failed to handle message&quot;, it)
</a><a href="#h26-0-35" id="h26-0-35" class="i">+                }
</a><a href="#h26-0-36" id="h26-0-36" class="i">+            }
</a><a href="#h26-0-37" id="h26-0-37" class="i">+        }).binder
</a><a href="#h26-0-38" id="h26-0-38" class="i">+    }
</a><a href="#h26-0-39" id="h26-0-39" class="i">+
</a><a href="#h26-0-40" id="h26-0-40" class="i">+
</a><a href="#h26-0-41" id="h26-0-41" class="i">+    private fun handleMessage(msg: Message) {
</a><a href="#h26-0-42" id="h26-0-42" class="i">+        val replyMessenger = msg.replyTo
</a><a href="#h26-0-43" id="h26-0-43" class="i">+        when (BridgeMessageType.fromValue(msg.what)) {
</a><a href="#h26-0-44" id="h26-0-44" class="i">+            BridgeMessageType.FILE_ACCESS_REQUEST -&gt; {
</a><a href="#h26-0-45" id="h26-0-45" class="i">+                with(FileAccessRequest()) {
</a><a href="#h26-0-46" id="h26-0-46" class="i">+                    read(msg.data)
</a><a href="#h26-0-47" id="h26-0-47" class="i">+                    handleFileAccess(this) { message -&gt;
</a><a href="#h26-0-48" id="h26-0-48" class="i">+                        replyMessenger.send(message)
</a><a href="#h26-0-49" id="h26-0-49" class="i">+                    }
</a><a href="#h26-0-50" id="h26-0-50" class="i">+                }
</a><a href="#h26-0-51" id="h26-0-51" class="i">+            }
</a><a href="#h26-0-52" id="h26-0-52" class="i">+            BridgeMessageType.DOWNLOAD_CONTENT_REQUEST -&gt; {
</a><a href="#h26-0-53" id="h26-0-53" class="i">+                with(DownloadContentRequest()) {
</a><a href="#h26-0-54" id="h26-0-54" class="i">+                    read(msg.data)
</a><a href="#h26-0-55" id="h26-0-55" class="i">+                    handleDownloadContent(this) { message -&gt;
</a><a href="#h26-0-56" id="h26-0-56" class="i">+                        replyMessenger.send(message)
</a><a href="#h26-0-57" id="h26-0-57" class="i">+                    }
</a><a href="#h26-0-58" id="h26-0-58" class="i">+                }
</a><a href="#h26-0-59" id="h26-0-59" class="i">+            }
</a><a href="#h26-0-60" id="h26-0-60" class="i">+            BridgeMessageType.LOCALE_REQUEST -&gt; {
</a><a href="#h26-0-61" id="h26-0-61" class="i">+                with(LocaleRequest()) {
</a><a href="#h26-0-62" id="h26-0-62" class="i">+                    read(msg.data)
</a><a href="#h26-0-63" id="h26-0-63" class="i">+                    handleLocaleRequest(this) { message -&gt;
</a><a href="#h26-0-64" id="h26-0-64" class="i">+                        replyMessenger.send(message)
</a><a href="#h26-0-65" id="h26-0-65" class="i">+                    }
</a><a href="#h26-0-66" id="h26-0-66" class="i">+                }
</a><a href="#h26-0-67" id="h26-0-67" class="i">+            }
</a><a href="#h26-0-68" id="h26-0-68" class="i">+            BridgeMessageType.MESSAGE_LOGGER_REQUEST -&gt; {
</a><a href="#h26-0-69" id="h26-0-69" class="i">+                with(MessageLoggerRequest()) {
</a><a href="#h26-0-70" id="h26-0-70" class="i">+                    read(msg.data)
</a><a href="#h26-0-71" id="h26-0-71" class="i">+                    handleMessageLoggerRequest(this) { message -&gt;
</a><a href="#h26-0-72" id="h26-0-72" class="i">+                        replyMessenger.send(message)
</a><a href="#h26-0-73" id="h26-0-73" class="i">+                    }
</a><a href="#h26-0-74" id="h26-0-74" class="i">+                }
</a><a href="#h26-0-75" id="h26-0-75" class="i">+            }
</a><a href="#h26-0-76" id="h26-0-76" class="i">+
</a><a href="#h26-0-77" id="h26-0-77" class="i">+            else -&gt; Logger.error(&quot;Unknown message type: &quot; + msg.what)
</a><a href="#h26-0-78" id="h26-0-78" class="i">+        }
</a><a href="#h26-0-79" id="h26-0-79" class="i">+    }
</a><a href="#h26-0-80" id="h26-0-80" class="i">+
</a><a href="#h26-0-81" id="h26-0-81" class="i">+    private fun handleMessageLoggerRequest(msg: MessageLoggerRequest, reply: (Message) -&gt; Unit) {
</a><a href="#h26-0-82" id="h26-0-82" class="i">+        when (msg.action) {
</a><a href="#h26-0-83" id="h26-0-83" class="i">+            MessageLoggerRequest.Action.ADD  -&gt; {
</a><a href="#h26-0-84" id="h26-0-84" class="i">+                messageLoggerDatabase.insert(&quot;messages&quot;, null, ContentValues().apply {
</a><a href="#h26-0-85" id="h26-0-85" class="i">+                    put(&quot;message_id&quot;, msg.messageId)
</a><a href="#h26-0-86" id="h26-0-86" class="i">+                    put(&quot;serialized_message&quot;, msg.message)
</a><a href="#h26-0-87" id="h26-0-87" class="i">+                })
</a><a href="#h26-0-88" id="h26-0-88" class="i">+            }
</a><a href="#h26-0-89" id="h26-0-89" class="i">+            MessageLoggerRequest.Action.CLEAR -&gt; {
</a><a href="#h26-0-90" id="h26-0-90" class="i">+                messageLoggerDatabase.execSQL(&quot;DELETE FROM messages&quot;)
</a><a href="#h26-0-91" id="h26-0-91" class="i">+            }
</a><a href="#h26-0-92" id="h26-0-92" class="i">+            MessageLoggerRequest.Action.GET -&gt; {
</a><a href="#h26-0-93" id="h26-0-93" class="i">+                val messageId = msg.messageId
</a><a href="#h26-0-94" id="h26-0-94" class="i">+                val cursor = messageLoggerDatabase.rawQuery(&quot;SELECT serialized_message FROM messages WHERE message_id = ?&quot;, arrayOf(messageId.toString()))
</a><a href="#h26-0-95" id="h26-0-95" class="i">+                val state = cursor.moveToFirst()
</a><a href="#h26-0-96" id="h26-0-96" class="i">+                val message: ByteArray? = if (state) {
</a><a href="#h26-0-97" id="h26-0-97" class="i">+                    cursor.getBlob(0)
</a><a href="#h26-0-98" id="h26-0-98" class="i">+                } else {
</a><a href="#h26-0-99" id="h26-0-99" class="i">+                    null
</a><a href="#h26-0-100" id="h26-0-100" class="i">+                }
</a><a href="#h26-0-101" id="h26-0-101" class="i">+                cursor.close()
</a><a href="#h26-0-102" id="h26-0-102" class="i">+                reply(MessageLoggerResult(state, message).toMessage(BridgeMessageType.MESSAGE_LOGGER_RESULT.value))
</a><a href="#h26-0-103" id="h26-0-103" class="i">+            }
</a><a href="#h26-0-104" id="h26-0-104" class="i">+            else -&gt; {
</a><a href="#h26-0-105" id="h26-0-105" class="i">+                Logger.error(Exception(&quot;Unknown message logger action: ${msg.action}&quot;))
</a><a href="#h26-0-106" id="h26-0-106" class="i">+            }
</a><a href="#h26-0-107" id="h26-0-107" class="i">+        }
</a><a href="#h26-0-108" id="h26-0-108" class="i">+
</a><a href="#h26-0-109" id="h26-0-109" class="i">+        reply(MessageLoggerResult(true).toMessage(BridgeMessageType.MESSAGE_LOGGER_RESULT.value))
</a><a href="#h26-0-110" id="h26-0-110" class="i">+    }
</a><a href="#h26-0-111" id="h26-0-111" class="i">+
</a><a href="#h26-0-112" id="h26-0-112" class="i">+    private fun handleLocaleRequest(msg: LocaleRequest, reply: (Message) -&gt; Unit) {
</a><a href="#h26-0-113" id="h26-0-113" class="i">+        val locale = resources.configuration.locales[0]
</a><a href="#h26-0-114" id="h26-0-114" class="i">+        Logger.log(&quot;Locale: ${locale.language}_${locale.country}&quot;)
</a><a href="#h26-0-115" id="h26-0-115" class="i">+        TODO()
</a><a href="#h26-0-116" id="h26-0-116" class="i">+    }
</a><a href="#h26-0-117" id="h26-0-117" class="i">+
</a><a href="#h26-0-118" id="h26-0-118" class="i">+    private fun handleDownloadContent(msg: DownloadContentRequest, reply: (Message) -&gt; Unit) {
</a><a href="#h26-0-119" id="h26-0-119" class="i">+        if (!msg.url!!.startsWith(&quot;http://127.0.0.1:&quot;)) return
</a><a href="#h26-0-120" id="h26-0-120" class="i">+
</a><a href="#h26-0-121" id="h26-0-121" class="i">+        val outputFile = File(msg.path!!)
</a><a href="#h26-0-122" id="h26-0-122" class="i">+        outputFile.parentFile?.let {
</a><a href="#h26-0-123" id="h26-0-123" class="i">+            if (!it.exists()) it.mkdirs()
</a><a href="#h26-0-124" id="h26-0-124" class="i">+        }
</a><a href="#h26-0-125" id="h26-0-125" class="i">+        val downloadManager = getSystemService(DOWNLOAD_SERVICE) as DownloadManager
</a><a href="#h26-0-126" id="h26-0-126" class="i">+        val request = DownloadManager.Request(Uri.parse(msg.url))
</a><a href="#h26-0-127" id="h26-0-127" class="i">+            .setNotificationVisibility(DownloadManager.Request.VISIBILITY_VISIBLE)
</a><a href="#h26-0-128" id="h26-0-128" class="i">+            .setAllowedOverMetered(true)
</a><a href="#h26-0-129" id="h26-0-129" class="i">+            .setAllowedOverRoaming(true)
</a><a href="#h26-0-130" id="h26-0-130" class="i">+            .setDestinationUri(Uri.fromFile(outputFile))
</a><a href="#h26-0-131" id="h26-0-131" class="i">+        val downloadId = downloadManager.enqueue(request)
</a><a href="#h26-0-132" id="h26-0-132" class="i">+        registerReceiver(object : BroadcastReceiver() {
</a><a href="#h26-0-133" id="h26-0-133" class="i">+            override fun onReceive(context: Context, intent: Intent) {
</a><a href="#h26-0-134" id="h26-0-134" class="i">+                if (intent.getLongExtra(DownloadManager.EXTRA_DOWNLOAD_ID, -1) != downloadId) return
</a><a href="#h26-0-135" id="h26-0-135" class="i">+                unregisterReceiver(this)
</a><a href="#h26-0-136" id="h26-0-136" class="i">+                reply(DownloadContentResult(true).toMessage(BridgeMessageType.DOWNLOAD_CONTENT_RESULT.value))
</a><a href="#h26-0-137" id="h26-0-137" class="i">+            }
</a><a href="#h26-0-138" id="h26-0-138" class="i">+        }, IntentFilter(DownloadManager.ACTION_DOWNLOAD_COMPLETE))
</a><a href="#h26-0-139" id="h26-0-139" class="i">+    }
</a><a href="#h26-0-140" id="h26-0-140" class="i">+
</a><a href="#h26-0-141" id="h26-0-141" class="i">+    private fun handleFileAccess(msg: FileAccessRequest, reply: (Message) -&gt; Unit) {
</a><a href="#h26-0-142" id="h26-0-142" class="i">+        val file = when (msg.fileType) {
</a><a href="#h26-0-143" id="h26-0-143" class="i">+            FileAccessRequest.FileType.CONFIG -&gt; CONFIG_FILE
</a><a href="#h26-0-144" id="h26-0-144" class="i">+            FileAccessRequest.FileType.MAPPINGS -&gt; MAPPINGS_FILE
</a><a href="#h26-0-145" id="h26-0-145" class="i">+            FileAccessRequest.FileType.STEALTH -&gt; STEALTH_FILE
</a><a href="#h26-0-146" id="h26-0-146" class="i">+            else -&gt; throw Exception(&quot;Unknown file type: &quot; + msg.fileType)
</a><a href="#h26-0-147" id="h26-0-147" class="i">+        }.let { File(filesDir, it) }
</a><a href="#h26-0-148" id="h26-0-148" class="i">+
</a><a href="#h26-0-149" id="h26-0-149" class="i">+        val result: FileAccessResult = when (msg.action) {
</a><a href="#h26-0-150" id="h26-0-150" class="i">+            FileAccessRequest.FileAccessAction.READ -&gt; {
</a><a href="#h26-0-151" id="h26-0-151" class="i">+                if (!file.exists()) {
</a><a href="#h26-0-152" id="h26-0-152" class="i">+                    FileAccessResult(false, null)
</a><a href="#h26-0-153" id="h26-0-153" class="i">+                } else {
</a><a href="#h26-0-154" id="h26-0-154" class="i">+                    FileAccessResult(true, file.readBytes())
</a><a href="#h26-0-155" id="h26-0-155" class="i">+                }
</a><a href="#h26-0-156" id="h26-0-156" class="i">+            }
</a><a href="#h26-0-157" id="h26-0-157" class="i">+            FileAccessRequest.FileAccessAction.WRITE -&gt; {
</a><a href="#h26-0-158" id="h26-0-158" class="i">+                if (!file.exists()) {
</a><a href="#h26-0-159" id="h26-0-159" class="i">+                    file.createNewFile()
</a><a href="#h26-0-160" id="h26-0-160" class="i">+                }
</a><a href="#h26-0-161" id="h26-0-161" class="i">+                file.writeBytes(msg.content!!)
</a><a href="#h26-0-162" id="h26-0-162" class="i">+                FileAccessResult(true, null)
</a><a href="#h26-0-163" id="h26-0-163" class="i">+            }
</a><a href="#h26-0-164" id="h26-0-164" class="i">+            FileAccessRequest.FileAccessAction.DELETE -&gt; {
</a><a href="#h26-0-165" id="h26-0-165" class="i">+                if (!file.exists()) {
</a><a href="#h26-0-166" id="h26-0-166" class="i">+                    FileAccessResult(false, null)
</a><a href="#h26-0-167" id="h26-0-167" class="i">+                } else {
</a><a href="#h26-0-168" id="h26-0-168" class="i">+                    file.delete()
</a><a href="#h26-0-169" id="h26-0-169" class="i">+                    FileAccessResult(true, null)
</a><a href="#h26-0-170" id="h26-0-170" class="i">+                }
</a><a href="#h26-0-171" id="h26-0-171" class="i">+            }
</a><a href="#h26-0-172" id="h26-0-172" class="i">+            FileAccessRequest.FileAccessAction.EXISTS -&gt; FileAccessResult(file.exists(), null)
</a><a href="#h26-0-173" id="h26-0-173" class="i">+            else -&gt; throw Exception(&quot;Unknown action: &quot; + msg.action)
</a><a href="#h26-0-174" id="h26-0-174" class="i">+        }
</a><a href="#h26-0-175" id="h26-0-175" class="i">+
</a><a href="#h26-0-176" id="h26-0-176" class="i">+        reply(result.toMessage(BridgeMessageType.FILE_ACCESS_RESULT.value))
</a><a href="#h26-0-177" id="h26-0-177" class="i">+    }
</a><a href="#h26-0-178" id="h26-0-178" class="i">+
</a><a href="#h26-0-179" id="h26-0-179" class="i">+}
</a><b>diff --git a/<a id="h27" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/service/MainActivity.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/service/MainActivity.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/service/MainActivity.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/service/MainActivity.kt</a></b>
<a href="#h27-0" id="h27-0" class="h">@@ -0,0 +1,20 @@
</a><a href="#h27-0-0" id="h27-0-0" class="i">+package me.rhunk.snapenhance.bridge.service
</a><a href="#h27-0-1" id="h27-0-1" class="i">+
</a><a href="#h27-0-2" id="h27-0-2" class="i">+import android.app.Activity
</a><a href="#h27-0-3" id="h27-0-3" class="i">+import android.content.Intent
</a><a href="#h27-0-4" id="h27-0-4" class="i">+import android.os.Bundle
</a><a href="#h27-0-5" id="h27-0-5" class="i">+import me.rhunk.snapenhance.Constants
</a><a href="#h27-0-6" id="h27-0-6" class="i">+
</a><a href="#h27-0-7" id="h27-0-7" class="i">+class MainActivity : Activity() {
</a><a href="#h27-0-8" id="h27-0-8" class="i">+    override fun onCreate(savedInstanceState: Bundle?) {
</a><a href="#h27-0-9" id="h27-0-9" class="i">+        super.onCreate(savedInstanceState)
</a><a href="#h27-0-10" id="h27-0-10" class="i">+        if (intent.getBooleanExtra(&quot;is_from_bridge&quot;, false)) {
</a><a href="#h27-0-11" id="h27-0-11" class="i">+            finish()
</a><a href="#h27-0-12" id="h27-0-12" class="i">+            return
</a><a href="#h27-0-13" id="h27-0-13" class="i">+        }
</a><a href="#h27-0-14" id="h27-0-14" class="i">+        val intent = packageManager.getLaunchIntentForPackage(Constants.SNAPCHAT_PACKAGE_NAME)
</a><a href="#h27-0-15" id="h27-0-15" class="i">+        intent!!.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK)
</a><a href="#h27-0-16" id="h27-0-16" class="i">+        startActivity(intent)
</a><a href="#h27-0-17" id="h27-0-17" class="i">+        finish()
</a><a href="#h27-0-18" id="h27-0-18" class="i">+    }
</a><a href="#h27-0-19" id="h27-0-19" class="i">+}
</a><b>diff --git a/<a id="h28" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/config/ConfigAccessor.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/config/ConfigAccessor.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/config/ConfigAccessor.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/config/ConfigAccessor.kt</a></b>
<a href="#h28-0" id="h28-0" class="h">@@ -0,0 +1,58 @@
</a><a href="#h28-0-0" id="h28-0-0" class="i">+package me.rhunk.snapenhance.config
</a><a href="#h28-0-1" id="h28-0-1" class="i">+
</a><a href="#h28-0-2" id="h28-0-2" class="i">+open class ConfigAccessor(
</a><a href="#h28-0-3" id="h28-0-3" class="i">+    private val configMap: MutableMap&lt;ConfigProperty, Any?&gt;
</a><a href="#h28-0-4" id="h28-0-4" class="i">+) {
</a><a href="#h28-0-5" id="h28-0-5" class="i">+    fun bool(key: ConfigProperty): Boolean {
</a><a href="#h28-0-6" id="h28-0-6" class="i">+        return get(key) as Boolean
</a><a href="#h28-0-7" id="h28-0-7" class="i">+    }
</a><a href="#h28-0-8" id="h28-0-8" class="i">+
</a><a href="#h28-0-9" id="h28-0-9" class="i">+    fun int(key: ConfigProperty): Int {
</a><a href="#h28-0-10" id="h28-0-10" class="i">+        return get(key) as Int
</a><a href="#h28-0-11" id="h28-0-11" class="i">+    }
</a><a href="#h28-0-12" id="h28-0-12" class="i">+
</a><a href="#h28-0-13" id="h28-0-13" class="i">+    fun string(key: ConfigProperty): String {
</a><a href="#h28-0-14" id="h28-0-14" class="i">+        return get(key) as String
</a><a href="#h28-0-15" id="h28-0-15" class="i">+    }
</a><a href="#h28-0-16" id="h28-0-16" class="i">+
</a><a href="#h28-0-17" id="h28-0-17" class="i">+    fun double(key: ConfigProperty): Double {
</a><a href="#h28-0-18" id="h28-0-18" class="i">+        return get(key) as Double
</a><a href="#h28-0-19" id="h28-0-19" class="i">+    }
</a><a href="#h28-0-20" id="h28-0-20" class="i">+
</a><a href="#h28-0-21" id="h28-0-21" class="i">+    fun float(key: ConfigProperty): Float {
</a><a href="#h28-0-22" id="h28-0-22" class="i">+        return get(key) as Float
</a><a href="#h28-0-23" id="h28-0-23" class="i">+    }
</a><a href="#h28-0-24" id="h28-0-24" class="i">+
</a><a href="#h28-0-25" id="h28-0-25" class="i">+    fun long(key: ConfigProperty): Long {
</a><a href="#h28-0-26" id="h28-0-26" class="i">+        return get(key) as Long
</a><a href="#h28-0-27" id="h28-0-27" class="i">+    }
</a><a href="#h28-0-28" id="h28-0-28" class="i">+
</a><a href="#h28-0-29" id="h28-0-29" class="i">+    fun short(key: ConfigProperty): Short {
</a><a href="#h28-0-30" id="h28-0-30" class="i">+        return get(key) as Short
</a><a href="#h28-0-31" id="h28-0-31" class="i">+    }
</a><a href="#h28-0-32" id="h28-0-32" class="i">+
</a><a href="#h28-0-33" id="h28-0-33" class="i">+    fun byte(key: ConfigProperty): Byte {
</a><a href="#h28-0-34" id="h28-0-34" class="i">+        return get(key) as Byte
</a><a href="#h28-0-35" id="h28-0-35" class="i">+    }
</a><a href="#h28-0-36" id="h28-0-36" class="i">+
</a><a href="#h28-0-37" id="h28-0-37" class="i">+    fun char(key: ConfigProperty): Char {
</a><a href="#h28-0-38" id="h28-0-38" class="i">+        return get(key) as Char
</a><a href="#h28-0-39" id="h28-0-39" class="i">+    }
</a><a href="#h28-0-40" id="h28-0-40" class="i">+
</a><a href="#h28-0-41" id="h28-0-41" class="i">+    @Suppress(&quot;UNCHECKED_CAST&quot;)
</a><a href="#h28-0-42" id="h28-0-42" class="i">+    fun &lt;T&gt; list(key: ConfigProperty): List&lt;T&gt; {
</a><a href="#h28-0-43" id="h28-0-43" class="i">+        return get(key) as List&lt;T&gt;
</a><a href="#h28-0-44" id="h28-0-44" class="i">+    }
</a><a href="#h28-0-45" id="h28-0-45" class="i">+
</a><a href="#h28-0-46" id="h28-0-46" class="i">+    fun get(key: ConfigProperty): Any? {
</a><a href="#h28-0-47" id="h28-0-47" class="i">+        return configMap[key]
</a><a href="#h28-0-48" id="h28-0-48" class="i">+    }
</a><a href="#h28-0-49" id="h28-0-49" class="i">+
</a><a href="#h28-0-50" id="h28-0-50" class="i">+    fun set(key: ConfigProperty, value: Any?) {
</a><a href="#h28-0-51" id="h28-0-51" class="i">+        configMap[key] = value
</a><a href="#h28-0-52" id="h28-0-52" class="i">+    }
</a><a href="#h28-0-53" id="h28-0-53" class="i">+
</a><a href="#h28-0-54" id="h28-0-54" class="i">+    fun entries(): Set&lt;Map.Entry&lt;ConfigProperty, Any?&gt;&gt; {
</a><a href="#h28-0-55" id="h28-0-55" class="i">+        return configMap.entries
</a><a href="#h28-0-56" id="h28-0-56" class="i">+    }
</a><a href="#h28-0-57" id="h28-0-57" class="i">+}</a><a href="#h28-0-58" id="h28-0-58" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h29" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/config/ConfigCategory.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/config/ConfigCategory.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/config/ConfigCategory.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/config/ConfigCategory.kt</a></b>
<a href="#h29-0" id="h29-0" class="h">@@ -0,0 +1,14 @@
</a><a href="#h29-0-0" id="h29-0-0" class="i">+package me.rhunk.snapenhance.config
</a><a href="#h29-0-1" id="h29-0-1" class="i">+
</a><a href="#h29-0-2" id="h29-0-2" class="i">+enum class ConfigCategory(
</a><a href="#h29-0-3" id="h29-0-3" class="i">+    val key: String
</a><a href="#h29-0-4" id="h29-0-4" class="i">+) {
</a><a href="#h29-0-5" id="h29-0-5" class="i">+    GENERAL(&quot;general&quot;),
</a><a href="#h29-0-6" id="h29-0-6" class="i">+    SPY(&quot;spy&quot;),
</a><a href="#h29-0-7" id="h29-0-7" class="i">+    MEDIA_DOWNLOADER(&quot;media_download&quot;),
</a><a href="#h29-0-8" id="h29-0-8" class="i">+    PRIVACY(&quot;privacy&quot;),
</a><a href="#h29-0-9" id="h29-0-9" class="i">+    UI(&quot;ui&quot;),
</a><a href="#h29-0-10" id="h29-0-10" class="i">+    EXTRAS(&quot;extras&quot;),
</a><a href="#h29-0-11" id="h29-0-11" class="i">+    TWEAKS(&quot;tweaks&quot;),
</a><a href="#h29-0-12" id="h29-0-12" class="i">+    EXPERIMENTS(&quot;experiments&quot;);
</a><a href="#h29-0-13" id="h29-0-13" class="i">+}
</a><b>diff --git a/<a id="h30" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/config/ConfigProperty.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/config/ConfigProperty.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/config/ConfigProperty.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/config/ConfigProperty.kt</a></b>
<a href="#h30-0" id="h30-0" class="h">@@ -0,0 +1,181 @@
</a><a href="#h30-0-0" id="h30-0-0" class="i">+package me.rhunk.snapenhance.config
</a><a href="#h30-0-1" id="h30-0-1" class="i">+
</a><a href="#h30-0-2" id="h30-0-2" class="i">+import android.os.Environment
</a><a href="#h30-0-3" id="h30-0-3" class="i">+import java.io.File
</a><a href="#h30-0-4" id="h30-0-4" class="i">+
</a><a href="#h30-0-5" id="h30-0-5" class="i">+enum class ConfigProperty(
</a><a href="#h30-0-6" id="h30-0-6" class="i">+    val nameKey: String,
</a><a href="#h30-0-7" id="h30-0-7" class="i">+    val descriptionKey: String,
</a><a href="#h30-0-8" id="h30-0-8" class="i">+    val category: ConfigCategory,
</a><a href="#h30-0-9" id="h30-0-9" class="i">+    val defaultValue: Any
</a><a href="#h30-0-10" id="h30-0-10" class="i">+) {
</a><a href="#h30-0-11" id="h30-0-11" class="i">+    SAVE_FOLDER(
</a><a href="#h30-0-12" id="h30-0-12" class="i">+        &quot;save_folder&quot;, &quot;description.save_folder&quot;, ConfigCategory.GENERAL,
</a><a href="#h30-0-13" id="h30-0-13" class="i">+        File(
</a><a href="#h30-0-14" id="h30-0-14" class="i">+            Environment.getExternalStoragePublicDirectory(Environment.DIRECTORY_DCIM).absolutePath + &quot;/Snapchat&quot;,
</a><a href="#h30-0-15" id="h30-0-15" class="i">+            &quot;SnapEnhance&quot;
</a><a href="#h30-0-16" id="h30-0-16" class="i">+        ).absolutePath
</a><a href="#h30-0-17" id="h30-0-17" class="i">+    ),
</a><a href="#h30-0-18" id="h30-0-18" class="i">+
</a><a href="#h30-0-19" id="h30-0-19" class="i">+    PREVENT_READ_RECEIPTS(
</a><a href="#h30-0-20" id="h30-0-20" class="i">+        &quot;prevent_read_receipts&quot;,
</a><a href="#h30-0-21" id="h30-0-21" class="i">+        &quot;description.prevent_read_receipts&quot;,
</a><a href="#h30-0-22" id="h30-0-22" class="i">+        ConfigCategory.SPY,
</a><a href="#h30-0-23" id="h30-0-23" class="i">+        false
</a><a href="#h30-0-24" id="h30-0-24" class="i">+    ),
</a><a href="#h30-0-25" id="h30-0-25" class="i">+    HIDE_BITMOJI_PRESENCE(
</a><a href="#h30-0-26" id="h30-0-26" class="i">+        &quot;hide_bitmoji_presence&quot;,
</a><a href="#h30-0-27" id="h30-0-27" class="i">+        &quot;description.hide_bitmoji_presence&quot;,
</a><a href="#h30-0-28" id="h30-0-28" class="i">+        ConfigCategory.SPY,
</a><a href="#h30-0-29" id="h30-0-29" class="i">+        false
</a><a href="#h30-0-30" id="h30-0-30" class="i">+    ),
</a><a href="#h30-0-31" id="h30-0-31" class="i">+    SHOW_MESSAGE_CONTENT(
</a><a href="#h30-0-32" id="h30-0-32" class="i">+        &quot;show_message_content&quot;,
</a><a href="#h30-0-33" id="h30-0-33" class="i">+        &quot;description.show_message_content&quot;,
</a><a href="#h30-0-34" id="h30-0-34" class="i">+        ConfigCategory.SPY,
</a><a href="#h30-0-35" id="h30-0-35" class="i">+        false
</a><a href="#h30-0-36" id="h30-0-36" class="i">+    ),
</a><a href="#h30-0-37" id="h30-0-37" class="i">+    MESSAGE_LOGGER(&quot;message_logger&quot;, &quot;description.message_logger&quot;, ConfigCategory.SPY, false),
</a><a href="#h30-0-38" id="h30-0-38" class="i">+
</a><a href="#h30-0-39" id="h30-0-39" class="i">+    MEDIA_DOWNLOADER_FEATURE(
</a><a href="#h30-0-40" id="h30-0-40" class="i">+        &quot;media_downloader_feature&quot;,
</a><a href="#h30-0-41" id="h30-0-41" class="i">+        &quot;description.media_downloader_feature&quot;,
</a><a href="#h30-0-42" id="h30-0-42" class="i">+        ConfigCategory.MEDIA_DOWNLOADER,
</a><a href="#h30-0-43" id="h30-0-43" class="i">+        true
</a><a href="#h30-0-44" id="h30-0-44" class="i">+    ),
</a><a href="#h30-0-45" id="h30-0-45" class="i">+    DOWNLOAD_STORIES(
</a><a href="#h30-0-46" id="h30-0-46" class="i">+        &quot;download_stories&quot;,
</a><a href="#h30-0-47" id="h30-0-47" class="i">+        &quot;description.download_stories&quot;,
</a><a href="#h30-0-48" id="h30-0-48" class="i">+        ConfigCategory.MEDIA_DOWNLOADER,
</a><a href="#h30-0-49" id="h30-0-49" class="i">+        false
</a><a href="#h30-0-50" id="h30-0-50" class="i">+    ),
</a><a href="#h30-0-51" id="h30-0-51" class="i">+    DOWNLOAD_PUBLIC_STORIES(
</a><a href="#h30-0-52" id="h30-0-52" class="i">+        &quot;download_public_stories&quot;,
</a><a href="#h30-0-53" id="h30-0-53" class="i">+        &quot;description.download_public_stories&quot;,
</a><a href="#h30-0-54" id="h30-0-54" class="i">+        ConfigCategory.MEDIA_DOWNLOADER,
</a><a href="#h30-0-55" id="h30-0-55" class="i">+        false
</a><a href="#h30-0-56" id="h30-0-56" class="i">+    ),
</a><a href="#h30-0-57" id="h30-0-57" class="i">+    DOWNLOAD_SPOTLIGHT(
</a><a href="#h30-0-58" id="h30-0-58" class="i">+        &quot;download_spotlight&quot;,
</a><a href="#h30-0-59" id="h30-0-59" class="i">+        &quot;description.download_spotlight&quot;,
</a><a href="#h30-0-60" id="h30-0-60" class="i">+        ConfigCategory.MEDIA_DOWNLOADER,
</a><a href="#h30-0-61" id="h30-0-61" class="i">+        false
</a><a href="#h30-0-62" id="h30-0-62" class="i">+    ),
</a><a href="#h30-0-63" id="h30-0-63" class="i">+    OVERLAY_MERGE(
</a><a href="#h30-0-64" id="h30-0-64" class="i">+        &quot;overlay_merge&quot;,
</a><a href="#h30-0-65" id="h30-0-65" class="i">+        &quot;description.overlay_merge&quot;,
</a><a href="#h30-0-66" id="h30-0-66" class="i">+        ConfigCategory.MEDIA_DOWNLOADER,
</a><a href="#h30-0-67" id="h30-0-67" class="i">+        true
</a><a href="#h30-0-68" id="h30-0-68" class="i">+    ),
</a><a href="#h30-0-69" id="h30-0-69" class="i">+    DOWNLOAD_INCHAT_SNAPS(
</a><a href="#h30-0-70" id="h30-0-70" class="i">+        &quot;download_inchat_snaps&quot;,
</a><a href="#h30-0-71" id="h30-0-71" class="i">+        &quot;description.download_inchat_snaps&quot;,
</a><a href="#h30-0-72" id="h30-0-72" class="i">+        ConfigCategory.MEDIA_DOWNLOADER,
</a><a href="#h30-0-73" id="h30-0-73" class="i">+        true
</a><a href="#h30-0-74" id="h30-0-74" class="i">+    ),
</a><a href="#h30-0-75" id="h30-0-75" class="i">+
</a><a href="#h30-0-76" id="h30-0-76" class="i">+    DISABLE_METRICS(&quot;disable_metrics&quot;, &quot;description.disable_metrics&quot;, ConfigCategory.PRIVACY, true),
</a><a href="#h30-0-77" id="h30-0-77" class="i">+    PREVENT_SCREENSHOTS(
</a><a href="#h30-0-78" id="h30-0-78" class="i">+        &quot;prevent_screenshots&quot;,
</a><a href="#h30-0-79" id="h30-0-79" class="i">+        &quot;description.prevent_screenshots&quot;,
</a><a href="#h30-0-80" id="h30-0-80" class="i">+        ConfigCategory.PRIVACY,
</a><a href="#h30-0-81" id="h30-0-81" class="i">+        true
</a><a href="#h30-0-82" id="h30-0-82" class="i">+    ),
</a><a href="#h30-0-83" id="h30-0-83" class="i">+    PREVENT_STATUS_NOTIFICATIONS(
</a><a href="#h30-0-84" id="h30-0-84" class="i">+        &quot;prevent_status_notifications&quot;,
</a><a href="#h30-0-85" id="h30-0-85" class="i">+        &quot;description.prevent_status_notifications&quot;,
</a><a href="#h30-0-86" id="h30-0-86" class="i">+        ConfigCategory.PRIVACY,
</a><a href="#h30-0-87" id="h30-0-87" class="i">+        true
</a><a href="#h30-0-88" id="h30-0-88" class="i">+    ),
</a><a href="#h30-0-89" id="h30-0-89" class="i">+    ANONYMOUS_STORY_VIEW(
</a><a href="#h30-0-90" id="h30-0-90" class="i">+        &quot;anonymous_story_view&quot;,
</a><a href="#h30-0-91" id="h30-0-91" class="i">+        &quot;description.anonymous_story_view&quot;,
</a><a href="#h30-0-92" id="h30-0-92" class="i">+        ConfigCategory.PRIVACY,
</a><a href="#h30-0-93" id="h30-0-93" class="i">+        false
</a><a href="#h30-0-94" id="h30-0-94" class="i">+    ),
</a><a href="#h30-0-95" id="h30-0-95" class="i">+    HIDE_TYPING_NOTIFICATION(
</a><a href="#h30-0-96" id="h30-0-96" class="i">+        &quot;hide_typing_notification&quot;,
</a><a href="#h30-0-97" id="h30-0-97" class="i">+        &quot;description.hide_typing_notification&quot;,
</a><a href="#h30-0-98" id="h30-0-98" class="i">+        ConfigCategory.PRIVACY,
</a><a href="#h30-0-99" id="h30-0-99" class="i">+        false
</a><a href="#h30-0-100" id="h30-0-100" class="i">+    ),
</a><a href="#h30-0-101" id="h30-0-101" class="i">+
</a><a href="#h30-0-102" id="h30-0-102" class="i">+    MENU_SLOT_ID(&quot;menu_slot_id&quot;, &quot;description.menu_slot_id&quot;, ConfigCategory.UI, 1),
</a><a href="#h30-0-103" id="h30-0-103" class="i">+    MESSAGE_PREVIEW_LENGTH(
</a><a href="#h30-0-104" id="h30-0-104" class="i">+        &quot;message_preview_length&quot;,
</a><a href="#h30-0-105" id="h30-0-105" class="i">+        &quot;description.message_preview_length&quot;,
</a><a href="#h30-0-106" id="h30-0-106" class="i">+        ConfigCategory.UI,
</a><a href="#h30-0-107" id="h30-0-107" class="i">+        20
</a><a href="#h30-0-108" id="h30-0-108" class="i">+    ),
</a><a href="#h30-0-109" id="h30-0-109" class="i">+
</a><a href="#h30-0-110" id="h30-0-110" class="i">+    AUTO_SAVE(&quot;auto_save&quot;, &quot;description.auto_save&quot;, ConfigCategory.EXTRAS, false),
</a><a href="#h30-0-111" id="h30-0-111" class="i">+    /*EXTERNAL_MEDIA_AS_SNAP(
</a><a href="#h30-0-112" id="h30-0-112" class="i">+        &quot;external_media_as_snap&quot;,
</a><a href="#h30-0-113" id="h30-0-113" class="i">+        &quot;description.external_media_as_snap&quot;,
</a><a href="#h30-0-114" id="h30-0-114" class="i">+        ConfigCategory.EXTRAS,
</a><a href="#h30-0-115" id="h30-0-115" class="i">+        false
</a><a href="#h30-0-116" id="h30-0-116" class="i">+    ),
</a><a href="#h30-0-117" id="h30-0-117" class="i">+    CONVERSATION_EXPORT(
</a><a href="#h30-0-118" id="h30-0-118" class="i">+        &quot;conversation_export&quot;,
</a><a href="#h30-0-119" id="h30-0-119" class="i">+        &quot;description.conversation_export&quot;,
</a><a href="#h30-0-120" id="h30-0-120" class="i">+        ConfigCategory.EXTRAS,
</a><a href="#h30-0-121" id="h30-0-121" class="i">+        false
</a><a href="#h30-0-122" id="h30-0-122" class="i">+    ),*/
</a><a href="#h30-0-123" id="h30-0-123" class="i">+    SNAPCHAT_PLUS(&quot;snapchat_plus&quot;, &quot;description.snapchat_plus&quot;, ConfigCategory.EXTRAS, false),
</a><a href="#h30-0-124" id="h30-0-124" class="i">+
</a><a href="#h30-0-125" id="h30-0-125" class="i">+    REMOVE_VOICE_RECORD_BUTTON(
</a><a href="#h30-0-126" id="h30-0-126" class="i">+        &quot;remove_voice_record_button&quot;,
</a><a href="#h30-0-127" id="h30-0-127" class="i">+        &quot;description.remove_voice_record_button&quot;,
</a><a href="#h30-0-128" id="h30-0-128" class="i">+        ConfigCategory.TWEAKS,
</a><a href="#h30-0-129" id="h30-0-129" class="i">+        false
</a><a href="#h30-0-130" id="h30-0-130" class="i">+    ),
</a><a href="#h30-0-131" id="h30-0-131" class="i">+    REMOVE_STICKERS_BUTTON(
</a><a href="#h30-0-132" id="h30-0-132" class="i">+        &quot;remove_stickers_button&quot;,
</a><a href="#h30-0-133" id="h30-0-133" class="i">+        &quot;description.remove_stickers_button&quot;,
</a><a href="#h30-0-134" id="h30-0-134" class="i">+        ConfigCategory.TWEAKS,
</a><a href="#h30-0-135" id="h30-0-135" class="i">+        false
</a><a href="#h30-0-136" id="h30-0-136" class="i">+    ),
</a><a href="#h30-0-137" id="h30-0-137" class="i">+    REMOVE_COGNAC_BUTTON(
</a><a href="#h30-0-138" id="h30-0-138" class="i">+        &quot;remove_cognac_button&quot;,
</a><a href="#h30-0-139" id="h30-0-139" class="i">+        &quot;description.remove_cognac_button&quot;,
</a><a href="#h30-0-140" id="h30-0-140" class="i">+        ConfigCategory.TWEAKS,
</a><a href="#h30-0-141" id="h30-0-141" class="i">+        false
</a><a href="#h30-0-142" id="h30-0-142" class="i">+    ),
</a><a href="#h30-0-143" id="h30-0-143" class="i">+    REMOVE_CALLBUTTONS(
</a><a href="#h30-0-144" id="h30-0-144" class="i">+        &quot;remove_callbuttons&quot;,
</a><a href="#h30-0-145" id="h30-0-145" class="i">+        &quot;description.remove_callbuttons&quot;,
</a><a href="#h30-0-146" id="h30-0-146" class="i">+        ConfigCategory.TWEAKS,
</a><a href="#h30-0-147" id="h30-0-147" class="i">+        false
</a><a href="#h30-0-148" id="h30-0-148" class="i">+    ),
</a><a href="#h30-0-149" id="h30-0-149" class="i">+    LONG_SNAP_SENDING(
</a><a href="#h30-0-150" id="h30-0-150" class="i">+        &quot;long_snap_sending&quot;,
</a><a href="#h30-0-151" id="h30-0-151" class="i">+        &quot;description.long_snap_sending&quot;,
</a><a href="#h30-0-152" id="h30-0-152" class="i">+        ConfigCategory.TWEAKS,
</a><a href="#h30-0-153" id="h30-0-153" class="i">+        false
</a><a href="#h30-0-154" id="h30-0-154" class="i">+    ),
</a><a href="#h30-0-155" id="h30-0-155" class="i">+    BLOCK_ADS(&quot;block_ads&quot;, &quot;description.block_ads&quot;, ConfigCategory.TWEAKS, false),
</a><a href="#h30-0-156" id="h30-0-156" class="i">+    STREAKEXPIRATIONINFO(
</a><a href="#h30-0-157" id="h30-0-157" class="i">+        &quot;streakexpirationinfo&quot;,
</a><a href="#h30-0-158" id="h30-0-158" class="i">+        &quot;description.streakexpirationinfo&quot;,
</a><a href="#h30-0-159" id="h30-0-159" class="i">+        ConfigCategory.TWEAKS,
</a><a href="#h30-0-160" id="h30-0-160" class="i">+        false
</a><a href="#h30-0-161" id="h30-0-161" class="i">+    ),
</a><a href="#h30-0-162" id="h30-0-162" class="i">+    NEW_MAP_UI(&quot;new_map_ui&quot;, &quot;description.new_map_ui&quot;, ConfigCategory.TWEAKS, false),
</a><a href="#h30-0-163" id="h30-0-163" class="i">+
</a><a href="#h30-0-164" id="h30-0-164" class="i">+    USE_DOWNLOAD_MANAGER(
</a><a href="#h30-0-165" id="h30-0-165" class="i">+        &quot;use_download_manager&quot;,
</a><a href="#h30-0-166" id="h30-0-166" class="i">+        &quot;description.use_download_manager&quot;,
</a><a href="#h30-0-167" id="h30-0-167" class="i">+        ConfigCategory.EXPERIMENTS,
</a><a href="#h30-0-168" id="h30-0-168" class="i">+        false
</a><a href="#h30-0-169" id="h30-0-169" class="i">+    );
</a><a href="#h30-0-170" id="h30-0-170" class="i">+
</a><a href="#h30-0-171" id="h30-0-171" class="i">+    companion object {
</a><a href="#h30-0-172" id="h30-0-172" class="i">+        fun fromNameKey(nameKey: String): ConfigProperty? {
</a><a href="#h30-0-173" id="h30-0-173" class="i">+            return values().find { it.nameKey == nameKey }
</a><a href="#h30-0-174" id="h30-0-174" class="i">+        }
</a><a href="#h30-0-175" id="h30-0-175" class="i">+
</a><a href="#h30-0-176" id="h30-0-176" class="i">+        fun sortedByCategory(): List&lt;ConfigProperty&gt; {
</a><a href="#h30-0-177" id="h30-0-177" class="i">+            return values().sortedBy { it.category.ordinal }
</a><a href="#h30-0-178" id="h30-0-178" class="i">+        }
</a><a href="#h30-0-179" id="h30-0-179" class="i">+    }
</a><a href="#h30-0-180" id="h30-0-180" class="i">+}</a><a href="#h30-0-181" id="h30-0-181" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h31" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/data/FileType.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/data/FileType.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/data/FileType.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/data/FileType.kt</a></b>
<a href="#h31-0" id="h31-0" class="h">@@ -0,0 +1,50 @@
</a><a href="#h31-0-0" id="h31-0-0" class="i">+package me.rhunk.snapenhance.data
</a><a href="#h31-0-1" id="h31-0-1" class="i">+
</a><a href="#h31-0-2" id="h31-0-2" class="i">+enum class FileType(
</a><a href="#h31-0-3" id="h31-0-3" class="i">+    val fileExtension: String? = null,
</a><a href="#h31-0-4" id="h31-0-4" class="i">+    val isVideo: Boolean = false,
</a><a href="#h31-0-5" id="h31-0-5" class="i">+    val isImage: Boolean = false,
</a><a href="#h31-0-6" id="h31-0-6" class="i">+    val isAudio: Boolean = false
</a><a href="#h31-0-7" id="h31-0-7" class="i">+) {
</a><a href="#h31-0-8" id="h31-0-8" class="i">+    GIF(&quot;gif&quot;, false, false, false),
</a><a href="#h31-0-9" id="h31-0-9" class="i">+    PNG(&quot;png&quot;, false, true, false),
</a><a href="#h31-0-10" id="h31-0-10" class="i">+    MP4(&quot;mp4&quot;, true, false, false),
</a><a href="#h31-0-11" id="h31-0-11" class="i">+    MP3(&quot;mp3&quot;, false, false, true),
</a><a href="#h31-0-12" id="h31-0-12" class="i">+    JPG(&quot;jpg&quot;, false, true, false),
</a><a href="#h31-0-13" id="h31-0-13" class="i">+    ZIP(&quot;zip&quot;, false, false, false),
</a><a href="#h31-0-14" id="h31-0-14" class="i">+    WEBP(&quot;webp&quot;, false, true, false),
</a><a href="#h31-0-15" id="h31-0-15" class="i">+    UNKNOWN(&quot;dat&quot;, false, false, false);
</a><a href="#h31-0-16" id="h31-0-16" class="i">+
</a><a href="#h31-0-17" id="h31-0-17" class="i">+    companion object {
</a><a href="#h31-0-18" id="h31-0-18" class="i">+        private val fileSignatures = HashMap&lt;String, FileType&gt;()
</a><a href="#h31-0-19" id="h31-0-19" class="i">+
</a><a href="#h31-0-20" id="h31-0-20" class="i">+        init {
</a><a href="#h31-0-21" id="h31-0-21" class="i">+            fileSignatures[&quot;52494646&quot;] = WEBP
</a><a href="#h31-0-22" id="h31-0-22" class="i">+            fileSignatures[&quot;504b0304&quot;] = ZIP
</a><a href="#h31-0-23" id="h31-0-23" class="i">+            fileSignatures[&quot;89504e47&quot;] = PNG
</a><a href="#h31-0-24" id="h31-0-24" class="i">+            fileSignatures[&quot;00000020&quot;] = MP4
</a><a href="#h31-0-25" id="h31-0-25" class="i">+            fileSignatures[&quot;00000018&quot;] = MP4
</a><a href="#h31-0-26" id="h31-0-26" class="i">+            fileSignatures[&quot;0000001c&quot;] = MP4
</a><a href="#h31-0-27" id="h31-0-27" class="i">+            fileSignatures[&quot;ffd8ffe0&quot;] = JPG
</a><a href="#h31-0-28" id="h31-0-28" class="i">+        }
</a><a href="#h31-0-29" id="h31-0-29" class="i">+
</a><a href="#h31-0-30" id="h31-0-30" class="i">+        fun fromString(string: String?): FileType {
</a><a href="#h31-0-31" id="h31-0-31" class="i">+            return values().firstOrNull { it.fileExtension.equals(string, ignoreCase = true) } ?: UNKNOWN
</a><a href="#h31-0-32" id="h31-0-32" class="i">+        }
</a><a href="#h31-0-33" id="h31-0-33" class="i">+
</a><a href="#h31-0-34" id="h31-0-34" class="i">+        private fun bytesToHex(bytes: ByteArray): String {
</a><a href="#h31-0-35" id="h31-0-35" class="i">+            val result = StringBuilder()
</a><a href="#h31-0-36" id="h31-0-36" class="i">+            for (b in bytes) {
</a><a href="#h31-0-37" id="h31-0-37" class="i">+                result.append(String.format(&quot;%02x&quot;, b))
</a><a href="#h31-0-38" id="h31-0-38" class="i">+            }
</a><a href="#h31-0-39" id="h31-0-39" class="i">+            return result.toString()
</a><a href="#h31-0-40" id="h31-0-40" class="i">+        }
</a><a href="#h31-0-41" id="h31-0-41" class="i">+
</a><a href="#h31-0-42" id="h31-0-42" class="i">+        fun fromByteArray(array: ByteArray): FileType {
</a><a href="#h31-0-43" id="h31-0-43" class="i">+            val headerBytes = ByteArray(16)
</a><a href="#h31-0-44" id="h31-0-44" class="i">+            System.arraycopy(array, 0, headerBytes, 0, 16)
</a><a href="#h31-0-45" id="h31-0-45" class="i">+            val hex = bytesToHex(headerBytes)
</a><a href="#h31-0-46" id="h31-0-46" class="i">+            return fileSignatures.entries.firstOrNull { hex.startsWith(it.key) }?.value ?: UNKNOWN
</a><a href="#h31-0-47" id="h31-0-47" class="i">+        }
</a><a href="#h31-0-48" id="h31-0-48" class="i">+    }
</a><a href="#h31-0-49" id="h31-0-49" class="i">+}
</a><b>diff --git a/<a id="h32" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/data/SnapClassCache.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/data/SnapClassCache.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/data/SnapClassCache.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/data/SnapClassCache.kt</a></b>
<a href="#h32-0" id="h32-0" class="h">@@ -0,0 +1,25 @@
</a><a href="#h32-0-0" id="h32-0-0" class="i">+package me.rhunk.snapenhance.data
</a><a href="#h32-0-1" id="h32-0-1" class="i">+
</a><a href="#h32-0-2" id="h32-0-2" class="i">+class SnapClassCache (
</a><a href="#h32-0-3" id="h32-0-3" class="i">+    private val classLoader: ClassLoader
</a><a href="#h32-0-4" id="h32-0-4" class="i">+) {
</a><a href="#h32-0-5" id="h32-0-5" class="i">+    val snapUUID by lazy { findClass(&quot;com.snapchat.client.messaging.UUID&quot;) }
</a><a href="#h32-0-6" id="h32-0-6" class="i">+    val composerLocalSubscriptionStore by lazy { findClass(&quot;com.snap.plus.lib.common.ComposerLocalSubscriptionStore&quot;) }
</a><a href="#h32-0-7" id="h32-0-7" class="i">+    val snapManager by lazy { findClass(&quot;com.snapchat.client.messaging.SnapManager\$CppProxy&quot;) }
</a><a href="#h32-0-8" id="h32-0-8" class="i">+    val conversationManager by lazy { findClass(&quot;com.snapchat.client.messaging.ConversationManager\$CppProxy&quot;) }
</a><a href="#h32-0-9" id="h32-0-9" class="i">+    val feedManager by lazy { findClass(&quot;com.snapchat.client.messaging.FeedManager\$CppProxy&quot;) }
</a><a href="#h32-0-10" id="h32-0-10" class="i">+    val presenceSession by lazy { findClass(&quot;com.snapchat.talkcorev3.PresenceSession\$CppProxy&quot;) }
</a><a href="#h32-0-11" id="h32-0-11" class="i">+    val message by lazy { findClass(&quot;com.snapchat.client.messaging.Message&quot;) }
</a><a href="#h32-0-12" id="h32-0-12" class="i">+    val messageUpdateEnum by lazy { findClass(&quot;com.snapchat.client.messaging.MessageUpdate&quot;) }
</a><a href="#h32-0-13" id="h32-0-13" class="i">+    val bestFriendWidgetProvider by lazy { findClass(&quot;com.snap.widgets.core.BestFriendsWidgetProvider&quot;) }
</a><a href="#h32-0-14" id="h32-0-14" class="i">+    val unifiedGrpcService by lazy { findClass(&quot;com.snapchat.client.grpc.UnifiedGrpcService\$CppProxy&quot;) }
</a><a href="#h32-0-15" id="h32-0-15" class="i">+    val networkApi by lazy { findClass(&quot;com.snapchat.client.network_api.NetworkApi\$CppProxy&quot;) }
</a><a href="#h32-0-16" id="h32-0-16" class="i">+
</a><a href="#h32-0-17" id="h32-0-17" class="i">+    private fun findClass(className: String): Class&lt;*&gt; {
</a><a href="#h32-0-18" id="h32-0-18" class="i">+        return try {
</a><a href="#h32-0-19" id="h32-0-19" class="i">+            classLoader.loadClass(className)
</a><a href="#h32-0-20" id="h32-0-20" class="i">+        } catch (e: ClassNotFoundException) {
</a><a href="#h32-0-21" id="h32-0-21" class="i">+            throw RuntimeException(&quot;Failed to find class $className&quot;, e)
</a><a href="#h32-0-22" id="h32-0-22" class="i">+        }
</a><a href="#h32-0-23" id="h32-0-23" class="i">+    }
</a><a href="#h32-0-24" id="h32-0-24" class="i">+}</a><a href="#h32-0-25" id="h32-0-25" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h33" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/data/SnapEnums.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/data/SnapEnums.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/data/SnapEnums.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/data/SnapEnums.kt</a></b>
<a href="#h33-0" id="h33-0" class="h">@@ -0,0 +1,41 @@
</a><a href="#h33-0-0" id="h33-0-0" class="i">+package me.rhunk.snapenhance.data
</a><a href="#h33-0-1" id="h33-0-1" class="i">+
</a><a href="#h33-0-2" id="h33-0-2" class="i">+enum class MessageState {
</a><a href="#h33-0-3" id="h33-0-3" class="i">+    PREPARING, SENDING, COMMITTED, FAILED, CANCELING
</a><a href="#h33-0-4" id="h33-0-4" class="i">+}
</a><a href="#h33-0-5" id="h33-0-5" class="i">+
</a><a href="#h33-0-6" id="h33-0-6" class="i">+enum class ContentType(val id: Int) {
</a><a href="#h33-0-7" id="h33-0-7" class="i">+    UNKNOWN(-1),
</a><a href="#h33-0-8" id="h33-0-8" class="i">+    SNAP(0),
</a><a href="#h33-0-9" id="h33-0-9" class="i">+    CHAT(1),
</a><a href="#h33-0-10" id="h33-0-10" class="i">+    EXTERNAL_MEDIA(2),
</a><a href="#h33-0-11" id="h33-0-11" class="i">+    SHARE(3),
</a><a href="#h33-0-12" id="h33-0-12" class="i">+    NOTE(4),
</a><a href="#h33-0-13" id="h33-0-13" class="i">+    STICKER(5),
</a><a href="#h33-0-14" id="h33-0-14" class="i">+    STATUS(6),
</a><a href="#h33-0-15" id="h33-0-15" class="i">+    LOCATION(7),
</a><a href="#h33-0-16" id="h33-0-16" class="i">+    STATUS_SAVE_TO_CAMERA_ROLL(8),
</a><a href="#h33-0-17" id="h33-0-17" class="i">+    STATUS_CONVERSATION_CAPTURE_SCREENSHOT(9),
</a><a href="#h33-0-18" id="h33-0-18" class="i">+    STATUS_CONVERSATION_CAPTURE_RECORD(10),
</a><a href="#h33-0-19" id="h33-0-19" class="i">+    STATUS_CALL_MISSED_VIDEO(11),
</a><a href="#h33-0-20" id="h33-0-20" class="i">+    STATUS_CALL_MISSED_AUDIO(12),
</a><a href="#h33-0-21" id="h33-0-21" class="i">+    LIVE_LOCATION_SHARE(13),
</a><a href="#h33-0-22" id="h33-0-22" class="i">+    CREATIVE_TOOL_ITEM(14),
</a><a href="#h33-0-23" id="h33-0-23" class="i">+    FAMILY_CENTER_INVITE(15),
</a><a href="#h33-0-24" id="h33-0-24" class="i">+    FAMILY_CENTER_ACCEPT(16),
</a><a href="#h33-0-25" id="h33-0-25" class="i">+    FAMILY_CENTER_LEAVE(17);
</a><a href="#h33-0-26" id="h33-0-26" class="i">+
</a><a href="#h33-0-27" id="h33-0-27" class="i">+    companion object {
</a><a href="#h33-0-28" id="h33-0-28" class="i">+        fun fromId(i: Int): ContentType {
</a><a href="#h33-0-29" id="h33-0-29" class="i">+            return values().firstOrNull { it.id == i } ?: UNKNOWN
</a><a href="#h33-0-30" id="h33-0-30" class="i">+        }
</a><a href="#h33-0-31" id="h33-0-31" class="i">+    }
</a><a href="#h33-0-32" id="h33-0-32" class="i">+}
</a><a href="#h33-0-33" id="h33-0-33" class="i">+
</a><a href="#h33-0-34" id="h33-0-34" class="i">+enum class PlayableSnapState {
</a><a href="#h33-0-35" id="h33-0-35" class="i">+    NOTDOWNLOADED, DOWNLOADING, DOWNLOADFAILED, PLAYABLE, VIEWEDREPLAYABLE, PLAYING, VIEWEDNOTREPLAYABLE
</a><a href="#h33-0-36" id="h33-0-36" class="i">+}
</a><a href="#h33-0-37" id="h33-0-37" class="i">+
</a><a href="#h33-0-38" id="h33-0-38" class="i">+enum class MediaReferenceType {
</a><a href="#h33-0-39" id="h33-0-39" class="i">+    UNASSIGNED, OVERLAY, IMAGE, VIDEO, ASSET_BUNDLE, AUDIO, ANIMATED_IMAGE, FONT, WEB_VIEW_CONTENT, VIDEO_NO_AUDIO
</a><a href="#h33-0-40" id="h33-0-40" class="i">+}
</a><b>diff --git a/<a id="h34" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/AbstractWrapper.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/AbstractWrapper.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/AbstractWrapper.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/AbstractWrapper.kt</a></b>
<a href="#h34-0" id="h34-0" class="h">@@ -0,0 +1,29 @@
</a><a href="#h34-0-0" id="h34-0-0" class="i">+package me.rhunk.snapenhance.data.wrapper
</a><a href="#h34-0-1" id="h34-0-1" class="i">+
</a><a href="#h34-0-2" id="h34-0-2" class="i">+import de.robv.android.xposed.XposedHelpers
</a><a href="#h34-0-3" id="h34-0-3" class="i">+
</a><a href="#h34-0-4" id="h34-0-4" class="i">+abstract class AbstractWrapper(
</a><a href="#h34-0-5" id="h34-0-5" class="i">+    protected var instance: Any
</a><a href="#h34-0-6" id="h34-0-6" class="i">+) {
</a><a href="#h34-0-7" id="h34-0-7" class="i">+    fun instance() = instance
</a><a href="#h34-0-8" id="h34-0-8" class="i">+
</a><a href="#h34-0-9" id="h34-0-9" class="i">+    override fun hashCode(): Int {
</a><a href="#h34-0-10" id="h34-0-10" class="i">+        return instance.hashCode()
</a><a href="#h34-0-11" id="h34-0-11" class="i">+    }
</a><a href="#h34-0-12" id="h34-0-12" class="i">+
</a><a href="#h34-0-13" id="h34-0-13" class="i">+    override fun toString(): String {
</a><a href="#h34-0-14" id="h34-0-14" class="i">+        return instance.toString()
</a><a href="#h34-0-15" id="h34-0-15" class="i">+    }
</a><a href="#h34-0-16" id="h34-0-16" class="i">+
</a><a href="#h34-0-17" id="h34-0-17" class="i">+
</a><a href="#h34-0-18" id="h34-0-18" class="i">+    fun &lt;T : Enum&lt;*&gt;&gt; getEnumValue(fieldName: String, defaultValue: T): T {
</a><a href="#h34-0-19" id="h34-0-19" class="i">+        val mContentType = XposedHelpers.getObjectField(instance, fieldName) as Enum&lt;*&gt;
</a><a href="#h34-0-20" id="h34-0-20" class="i">+        return java.lang.Enum.valueOf(defaultValue::class.java, mContentType.name) as T
</a><a href="#h34-0-21" id="h34-0-21" class="i">+    }
</a><a href="#h34-0-22" id="h34-0-22" class="i">+
</a><a href="#h34-0-23" id="h34-0-23" class="i">+    @Suppress(&quot;UNCHECKED_CAST&quot;)
</a><a href="#h34-0-24" id="h34-0-24" class="i">+    fun setEnumValue(fieldName: String, value: Enum&lt;*&gt;) {
</a><a href="#h34-0-25" id="h34-0-25" class="i">+        val type = instance.javaClass.fields.find { it.name == fieldName }?.type as Class&lt;out Enum&lt;*&gt;&gt;
</a><a href="#h34-0-26" id="h34-0-26" class="i">+        XposedHelpers.setObjectField(instance, fieldName, java.lang.Enum.valueOf(type, value.name))
</a><a href="#h34-0-27" id="h34-0-27" class="i">+    }
</a><a href="#h34-0-28" id="h34-0-28" class="i">+}</a><a href="#h34-0-29" id="h34-0-29" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h35" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/Message.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/Message.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/Message.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/Message.kt</a></b>
<a href="#h35-0" id="h35-0" class="h">@@ -0,0 +1,12 @@
</a><a href="#h35-0-0" id="h35-0-0" class="i">+package me.rhunk.snapenhance.data.wrapper.impl
</a><a href="#h35-0-1" id="h35-0-1" class="i">+
</a><a href="#h35-0-2" id="h35-0-2" class="i">+import me.rhunk.snapenhance.data.wrapper.AbstractWrapper
</a><a href="#h35-0-3" id="h35-0-3" class="i">+import me.rhunk.snapenhance.util.getObjectField
</a><a href="#h35-0-4" id="h35-0-4" class="i">+
</a><a href="#h35-0-5" id="h35-0-5" class="i">+class Message(obj: Any) : AbstractWrapper(obj) {
</a><a href="#h35-0-6" id="h35-0-6" class="i">+    val orderKey get() = instance.getObjectField(&quot;mOrderKey&quot;) as Long
</a><a href="#h35-0-7" id="h35-0-7" class="i">+    val senderId get() = SnapUUID(instance.getObjectField(&quot;mSenderId&quot;))
</a><a href="#h35-0-8" id="h35-0-8" class="i">+    val messageContent get() = MessageContent(instance.getObjectField(&quot;mMessageContent&quot;))
</a><a href="#h35-0-9" id="h35-0-9" class="i">+    val messageDescriptor get() = MessageDescriptor(instance.getObjectField(&quot;mDescriptor&quot;))
</a><a href="#h35-0-10" id="h35-0-10" class="i">+    val messageMetadata get() = MessageMetadata(instance.getObjectField(&quot;mMetadata&quot;))
</a><a href="#h35-0-11" id="h35-0-11" class="i">+}</a><a href="#h35-0-12" id="h35-0-12" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h36" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/MessageContent.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/MessageContent.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/MessageContent.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/MessageContent.kt</a></b>
<a href="#h36-0" id="h36-0" class="h">@@ -0,0 +1,15 @@
</a><a href="#h36-0-0" id="h36-0-0" class="i">+package me.rhunk.snapenhance.data.wrapper.impl
</a><a href="#h36-0-1" id="h36-0-1" class="i">+
</a><a href="#h36-0-2" id="h36-0-2" class="i">+import me.rhunk.snapenhance.data.ContentType
</a><a href="#h36-0-3" id="h36-0-3" class="i">+import me.rhunk.snapenhance.data.wrapper.AbstractWrapper
</a><a href="#h36-0-4" id="h36-0-4" class="i">+import me.rhunk.snapenhance.util.getObjectField
</a><a href="#h36-0-5" id="h36-0-5" class="i">+import me.rhunk.snapenhance.util.setObjectField
</a><a href="#h36-0-6" id="h36-0-6" class="i">+
</a><a href="#h36-0-7" id="h36-0-7" class="i">+class MessageContent(obj: Any) : AbstractWrapper(obj) {
</a><a href="#h36-0-8" id="h36-0-8" class="i">+    var content
</a><a href="#h36-0-9" id="h36-0-9" class="i">+        get() = instance.getObjectField(&quot;mContent&quot;) as ByteArray
</a><a href="#h36-0-10" id="h36-0-10" class="i">+        set(value) = instance.setObjectField(&quot;mContent&quot;, value)
</a><a href="#h36-0-11" id="h36-0-11" class="i">+    var contentType
</a><a href="#h36-0-12" id="h36-0-12" class="i">+        get() = getEnumValue(&quot;mContentType&quot;, ContentType.UNKNOWN)
</a><a href="#h36-0-13" id="h36-0-13" class="i">+        set(value) = setEnumValue(&quot;mContentType&quot;, value)
</a><a href="#h36-0-14" id="h36-0-14" class="i">+}</a><a href="#h36-0-15" id="h36-0-15" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h37" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/MessageDescriptor.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/MessageDescriptor.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/MessageDescriptor.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/MessageDescriptor.kt</a></b>
<a href="#h37-0" id="h37-0" class="h">@@ -0,0 +1,9 @@
</a><a href="#h37-0-0" id="h37-0-0" class="i">+package me.rhunk.snapenhance.data.wrapper.impl
</a><a href="#h37-0-1" id="h37-0-1" class="i">+
</a><a href="#h37-0-2" id="h37-0-2" class="i">+import me.rhunk.snapenhance.data.wrapper.AbstractWrapper
</a><a href="#h37-0-3" id="h37-0-3" class="i">+import me.rhunk.snapenhance.util.getObjectField
</a><a href="#h37-0-4" id="h37-0-4" class="i">+
</a><a href="#h37-0-5" id="h37-0-5" class="i">+class MessageDescriptor(obj: Any) : AbstractWrapper(obj) {
</a><a href="#h37-0-6" id="h37-0-6" class="i">+    val messageId: Long get() = instance.getObjectField(&quot;mMessageId&quot;) as Long
</a><a href="#h37-0-7" id="h37-0-7" class="i">+    val conversationId: SnapUUID get() = SnapUUID(instance.getObjectField(&quot;mConversationId&quot;))
</a><a href="#h37-0-8" id="h37-0-8" class="i">+}</a><a href="#h37-0-9" id="h37-0-9" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h38" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/MessageMetadata.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/MessageMetadata.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/MessageMetadata.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/MessageMetadata.kt</a></b>
<a href="#h38-0" id="h38-0" class="h">@@ -0,0 +1,16 @@
</a><a href="#h38-0-0" id="h38-0-0" class="i">+package me.rhunk.snapenhance.data.wrapper.impl
</a><a href="#h38-0-1" id="h38-0-1" class="i">+
</a><a href="#h38-0-2" id="h38-0-2" class="i">+import me.rhunk.snapenhance.data.PlayableSnapState
</a><a href="#h38-0-3" id="h38-0-3" class="i">+import me.rhunk.snapenhance.data.wrapper.AbstractWrapper
</a><a href="#h38-0-4" id="h38-0-4" class="i">+import me.rhunk.snapenhance.util.getObjectField
</a><a href="#h38-0-5" id="h38-0-5" class="i">+
</a><a href="#h38-0-6" id="h38-0-6" class="i">+class MessageMetadata(obj: Any) : AbstractWrapper(obj){
</a><a href="#h38-0-7" id="h38-0-7" class="i">+    val createdAt: Long get() = instance.getObjectField(&quot;mCreatedAt&quot;) as Long
</a><a href="#h38-0-8" id="h38-0-8" class="i">+    val readAt: Long get() = instance.getObjectField(&quot;mReadAt&quot;) as Long
</a><a href="#h38-0-9" id="h38-0-9" class="i">+    var playableSnapState: PlayableSnapState
</a><a href="#h38-0-10" id="h38-0-10" class="i">+    get() = getEnumValue(&quot;mPlayableSnapState&quot;, PlayableSnapState.PLAYABLE)
</a><a href="#h38-0-11" id="h38-0-11" class="i">+    set(value) {
</a><a href="#h38-0-12" id="h38-0-12" class="i">+        setEnumValue(&quot;mPlayableSnapState&quot;, value)
</a><a href="#h38-0-13" id="h38-0-13" class="i">+    }
</a><a href="#h38-0-14" id="h38-0-14" class="i">+    val savedBy: List&lt;SnapUUID&gt; = (instance.getObjectField(&quot;mSavedBy&quot;) as List&lt;*&gt;).map { SnapUUID(it!!) }
</a><a href="#h38-0-15" id="h38-0-15" class="i">+}</a><a href="#h38-0-16" id="h38-0-16" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h39" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/SnapUUID.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/SnapUUID.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/SnapUUID.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/SnapUUID.kt</a></b>
<a href="#h39-0" id="h39-0" class="h">@@ -0,0 +1,40 @@
</a><a href="#h39-0-0" id="h39-0-0" class="i">+package me.rhunk.snapenhance.data.wrapper.impl
</a><a href="#h39-0-1" id="h39-0-1" class="i">+
</a><a href="#h39-0-2" id="h39-0-2" class="i">+import me.rhunk.snapenhance.SnapEnhance
</a><a href="#h39-0-3" id="h39-0-3" class="i">+import me.rhunk.snapenhance.data.wrapper.AbstractWrapper
</a><a href="#h39-0-4" id="h39-0-4" class="i">+import me.rhunk.snapenhance.util.getObjectField
</a><a href="#h39-0-5" id="h39-0-5" class="i">+import java.nio.ByteBuffer
</a><a href="#h39-0-6" id="h39-0-6" class="i">+import java.util.*
</a><a href="#h39-0-7" id="h39-0-7" class="i">+
</a><a href="#h39-0-8" id="h39-0-8" class="i">+class SnapUUID(instance: Any) : AbstractWrapper(instance) {
</a><a href="#h39-0-9" id="h39-0-9" class="i">+    private val uuidString by lazy { toUUID().toString() }
</a><a href="#h39-0-10" id="h39-0-10" class="i">+
</a><a href="#h39-0-11" id="h39-0-11" class="i">+    val bytes: ByteArray get() {
</a><a href="#h39-0-12" id="h39-0-12" class="i">+        return instance.getObjectField(&quot;mId&quot;) as ByteArray
</a><a href="#h39-0-13" id="h39-0-13" class="i">+    }
</a><a href="#h39-0-14" id="h39-0-14" class="i">+
</a><a href="#h39-0-15" id="h39-0-15" class="i">+    private fun toUUID(): UUID {
</a><a href="#h39-0-16" id="h39-0-16" class="i">+        val buffer = ByteBuffer.wrap(bytes)
</a><a href="#h39-0-17" id="h39-0-17" class="i">+        return UUID(buffer.long, buffer.long)
</a><a href="#h39-0-18" id="h39-0-18" class="i">+    }
</a><a href="#h39-0-19" id="h39-0-19" class="i">+
</a><a href="#h39-0-20" id="h39-0-20" class="i">+    override fun toString(): String {
</a><a href="#h39-0-21" id="h39-0-21" class="i">+        return uuidString
</a><a href="#h39-0-22" id="h39-0-22" class="i">+    }
</a><a href="#h39-0-23" id="h39-0-23" class="i">+
</a><a href="#h39-0-24" id="h39-0-24" class="i">+    companion object {
</a><a href="#h39-0-25" id="h39-0-25" class="i">+        fun fromString(uuid: String): SnapUUID {
</a><a href="#h39-0-26" id="h39-0-26" class="i">+            return fromUUID(UUID.fromString(uuid))
</a><a href="#h39-0-27" id="h39-0-27" class="i">+        }
</a><a href="#h39-0-28" id="h39-0-28" class="i">+        fun fromBytes(bytes: ByteArray): SnapUUID {
</a><a href="#h39-0-29" id="h39-0-29" class="i">+            val constructor = SnapEnhance.classCache.snapUUID.getConstructor(ByteArray::class.java)
</a><a href="#h39-0-30" id="h39-0-30" class="i">+            return SnapUUID(constructor.newInstance(bytes))
</a><a href="#h39-0-31" id="h39-0-31" class="i">+        }
</a><a href="#h39-0-32" id="h39-0-32" class="i">+        fun fromUUID(uuid: UUID): SnapUUID {
</a><a href="#h39-0-33" id="h39-0-33" class="i">+            val buffer = ByteBuffer.allocate(16)
</a><a href="#h39-0-34" id="h39-0-34" class="i">+            buffer.putLong(uuid.mostSignificantBits)
</a><a href="#h39-0-35" id="h39-0-35" class="i">+            buffer.putLong(uuid.leastSignificantBits)
</a><a href="#h39-0-36" id="h39-0-36" class="i">+            return fromBytes(buffer.array())
</a><a href="#h39-0-37" id="h39-0-37" class="i">+        }
</a><a href="#h39-0-38" id="h39-0-38" class="i">+    }
</a><a href="#h39-0-39" id="h39-0-39" class="i">+}
</a><b>diff --git a/<a id="h40" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/media/EncryptionWrapper.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/media/EncryptionWrapper.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/media/EncryptionWrapper.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/media/EncryptionWrapper.kt</a></b>
<a href="#h40-0" id="h40-0" class="h">@@ -0,0 +1,73 @@
</a><a href="#h40-0-0" id="h40-0-0" class="i">+package me.rhunk.snapenhance.data.wrapper.impl.media
</a><a href="#h40-0-1" id="h40-0-1" class="i">+
</a><a href="#h40-0-2" id="h40-0-2" class="i">+import me.rhunk.snapenhance.data.wrapper.AbstractWrapper
</a><a href="#h40-0-3" id="h40-0-3" class="i">+import java.io.InputStream
</a><a href="#h40-0-4" id="h40-0-4" class="i">+import java.io.OutputStream
</a><a href="#h40-0-5" id="h40-0-5" class="i">+import java.lang.reflect.Field
</a><a href="#h40-0-6" id="h40-0-6" class="i">+import javax.crypto.Cipher
</a><a href="#h40-0-7" id="h40-0-7" class="i">+import javax.crypto.CipherInputStream
</a><a href="#h40-0-8" id="h40-0-8" class="i">+import javax.crypto.CipherOutputStream
</a><a href="#h40-0-9" id="h40-0-9" class="i">+import javax.crypto.spec.IvParameterSpec
</a><a href="#h40-0-10" id="h40-0-10" class="i">+import javax.crypto.spec.SecretKeySpec
</a><a href="#h40-0-11" id="h40-0-11" class="i">+
</a><a href="#h40-0-12" id="h40-0-12" class="i">+class EncryptionWrapper(instance: Any) : AbstractWrapper(instance) {
</a><a href="#h40-0-13" id="h40-0-13" class="i">+    fun decrypt(data: ByteArray?): ByteArray {
</a><a href="#h40-0-14" id="h40-0-14" class="i">+        return newCipher(Cipher.DECRYPT_MODE).doFinal(data)
</a><a href="#h40-0-15" id="h40-0-15" class="i">+    }
</a><a href="#h40-0-16" id="h40-0-16" class="i">+
</a><a href="#h40-0-17" id="h40-0-17" class="i">+    fun decrypt(inputStream: InputStream?): InputStream {
</a><a href="#h40-0-18" id="h40-0-18" class="i">+        return CipherInputStream(inputStream, newCipher(Cipher.DECRYPT_MODE))
</a><a href="#h40-0-19" id="h40-0-19" class="i">+    }
</a><a href="#h40-0-20" id="h40-0-20" class="i">+
</a><a href="#h40-0-21" id="h40-0-21" class="i">+    fun decrypt(outputStream: OutputStream?): OutputStream {
</a><a href="#h40-0-22" id="h40-0-22" class="i">+        return CipherOutputStream(outputStream, newCipher(Cipher.DECRYPT_MODE))
</a><a href="#h40-0-23" id="h40-0-23" class="i">+    }
</a><a href="#h40-0-24" id="h40-0-24" class="i">+
</a><a href="#h40-0-25" id="h40-0-25" class="i">+    /**
</a><a href="#h40-0-26" id="h40-0-26" class="i">+     * Search for a byte[] field with the specified length
</a><a href="#h40-0-27" id="h40-0-27" class="i">+     *
</a><a href="#h40-0-28" id="h40-0-28" class="i">+     * @param arrayLength the length of the byte[] field
</a><a href="#h40-0-29" id="h40-0-29" class="i">+     * @return the field
</a><a href="#h40-0-30" id="h40-0-30" class="i">+     */
</a><a href="#h40-0-31" id="h40-0-31" class="i">+    private fun searchByteArrayField(arrayLength: Int): Field {
</a><a href="#h40-0-32" id="h40-0-32" class="i">+        return instance::class.java.fields.first { f -&gt;
</a><a href="#h40-0-33" id="h40-0-33" class="i">+            try {
</a><a href="#h40-0-34" id="h40-0-34" class="i">+                if (!f.type.isArray || f.type
</a><a href="#h40-0-35" id="h40-0-35" class="i">+                        .componentType != Byte::class.javaPrimitiveType
</a><a href="#h40-0-36" id="h40-0-36" class="i">+                ) return@first false
</a><a href="#h40-0-37" id="h40-0-37" class="i">+                return@first (f.get(instance) as ByteArray).size == arrayLength
</a><a href="#h40-0-38" id="h40-0-38" class="i">+            } catch (e: Exception) {
</a><a href="#h40-0-39" id="h40-0-39" class="i">+                return@first false
</a><a href="#h40-0-40" id="h40-0-40" class="i">+            }
</a><a href="#h40-0-41" id="h40-0-41" class="i">+        }
</a><a href="#h40-0-42" id="h40-0-42" class="i">+    }
</a><a href="#h40-0-43" id="h40-0-43" class="i">+
</a><a href="#h40-0-44" id="h40-0-44" class="i">+    /**
</a><a href="#h40-0-45" id="h40-0-45" class="i">+     * Create a new cipher with the specified mode
</a><a href="#h40-0-46" id="h40-0-46" class="i">+     */
</a><a href="#h40-0-47" id="h40-0-47" class="i">+    fun newCipher(mode: Int): Cipher {
</a><a href="#h40-0-48" id="h40-0-48" class="i">+        val cipher = cipher
</a><a href="#h40-0-49" id="h40-0-49" class="i">+        cipher.init(mode, SecretKeySpec(keySpec, &quot;AES&quot;), IvParameterSpec(ivKeyParameterSpec))
</a><a href="#h40-0-50" id="h40-0-50" class="i">+        return cipher
</a><a href="#h40-0-51" id="h40-0-51" class="i">+    }
</a><a href="#h40-0-52" id="h40-0-52" class="i">+
</a><a href="#h40-0-53" id="h40-0-53" class="i">+    /**
</a><a href="#h40-0-54" id="h40-0-54" class="i">+     * Get the cipher from the encryption wrapper
</a><a href="#h40-0-55" id="h40-0-55" class="i">+     */
</a><a href="#h40-0-56" id="h40-0-56" class="i">+    private val cipher: Cipher
</a><a href="#h40-0-57" id="h40-0-57" class="i">+        get() = Cipher.getInstance(&quot;AES/CBC/PKCS5Padding&quot;)
</a><a href="#h40-0-58" id="h40-0-58" class="i">+
</a><a href="#h40-0-59" id="h40-0-59" class="i">+    /**
</a><a href="#h40-0-60" id="h40-0-60" class="i">+     * Get the key spec from the encryption wrapper
</a><a href="#h40-0-61" id="h40-0-61" class="i">+     */
</a><a href="#h40-0-62" id="h40-0-62" class="i">+    val keySpec: ByteArray by lazy {
</a><a href="#h40-0-63" id="h40-0-63" class="i">+        searchByteArrayField(32)[instance] as ByteArray
</a><a href="#h40-0-64" id="h40-0-64" class="i">+    }
</a><a href="#h40-0-65" id="h40-0-65" class="i">+
</a><a href="#h40-0-66" id="h40-0-66" class="i">+    /**
</a><a href="#h40-0-67" id="h40-0-67" class="i">+     * Get the iv key parameter spec from the encryption wrapper
</a><a href="#h40-0-68" id="h40-0-68" class="i">+     */
</a><a href="#h40-0-69" id="h40-0-69" class="i">+    val ivKeyParameterSpec: ByteArray by lazy {
</a><a href="#h40-0-70" id="h40-0-70" class="i">+        searchByteArrayField(16)[instance] as ByteArray
</a><a href="#h40-0-71" id="h40-0-71" class="i">+    }
</a><a href="#h40-0-72" id="h40-0-72" class="i">+}
</a><b>diff --git a/<a id="h41" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/media/MediaInfo.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/media/MediaInfo.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/media/MediaInfo.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/media/MediaInfo.kt</a></b>
<a href="#h41-0" id="h41-0" class="h">@@ -0,0 +1,34 @@
</a><a href="#h41-0-0" id="h41-0-0" class="i">+package me.rhunk.snapenhance.data.wrapper.impl.media
</a><a href="#h41-0-1" id="h41-0-1" class="i">+
</a><a href="#h41-0-2" id="h41-0-2" class="i">+import android.os.Parcelable
</a><a href="#h41-0-3" id="h41-0-3" class="i">+import me.rhunk.snapenhance.data.wrapper.AbstractWrapper
</a><a href="#h41-0-4" id="h41-0-4" class="i">+import me.rhunk.snapenhance.util.getObjectField
</a><a href="#h41-0-5" id="h41-0-5" class="i">+import java.lang.reflect.Field
</a><a href="#h41-0-6" id="h41-0-6" class="i">+
</a><a href="#h41-0-7" id="h41-0-7" class="i">+
</a><a href="#h41-0-8" id="h41-0-8" class="i">+class MediaInfo(obj: Any) : AbstractWrapper(obj) {
</a><a href="#h41-0-9" id="h41-0-9" class="i">+    val uri: String
</a><a href="#h41-0-10" id="h41-0-10" class="i">+        get() {
</a><a href="#h41-0-11" id="h41-0-11" class="i">+            val firstStringUriField = instance.javaClass.fields.first { f: Field -&gt; f.type == String::class.java }
</a><a href="#h41-0-12" id="h41-0-12" class="i">+            return instance.getObjectField(firstStringUriField.name) as String
</a><a href="#h41-0-13" id="h41-0-13" class="i">+        }
</a><a href="#h41-0-14" id="h41-0-14" class="i">+
</a><a href="#h41-0-15" id="h41-0-15" class="i">+    init {
</a><a href="#h41-0-16" id="h41-0-16" class="i">+        var mediaInfo: Any = instance
</a><a href="#h41-0-17" id="h41-0-17" class="i">+        if (mediaInfo is List&lt;*&gt;) {
</a><a href="#h41-0-18" id="h41-0-18" class="i">+            if (mediaInfo.size == 0) {
</a><a href="#h41-0-19" id="h41-0-19" class="i">+                throw RuntimeException(&quot;MediaInfo is empty&quot;)
</a><a href="#h41-0-20" id="h41-0-20" class="i">+            }
</a><a href="#h41-0-21" id="h41-0-21" class="i">+            mediaInfo = mediaInfo[0]!!
</a><a href="#h41-0-22" id="h41-0-22" class="i">+        }
</a><a href="#h41-0-23" id="h41-0-23" class="i">+        instance = mediaInfo
</a><a href="#h41-0-24" id="h41-0-24" class="i">+    }
</a><a href="#h41-0-25" id="h41-0-25" class="i">+
</a><a href="#h41-0-26" id="h41-0-26" class="i">+    val encryption: EncryptionWrapper?
</a><a href="#h41-0-27" id="h41-0-27" class="i">+        get() {
</a><a href="#h41-0-28" id="h41-0-28" class="i">+            val encryptionAlgorithmField = instance.javaClass.fields.first { f: Field -&gt;
</a><a href="#h41-0-29" id="h41-0-29" class="i">+                f.type.isInterface &amp;&amp; Parcelable::class.java.isAssignableFrom(f.type)
</a><a href="#h41-0-30" id="h41-0-30" class="i">+            }
</a><a href="#h41-0-31" id="h41-0-31" class="i">+            return encryptionAlgorithmField[instance]?.let { EncryptionWrapper(it) }
</a><a href="#h41-0-32" id="h41-0-32" class="i">+        }
</a><a href="#h41-0-33" id="h41-0-33" class="i">+}
</a><b>diff --git a/<a id="h42" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/media/opera/Layer.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/media/opera/Layer.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/media/opera/Layer.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/media/opera/Layer.kt</a></b>
<a href="#h42-0" id="h42-0" class="h">@@ -0,0 +1,21 @@
</a><a href="#h42-0-0" id="h42-0-0" class="i">+package me.rhunk.snapenhance.data.wrapper.impl.media.opera
</a><a href="#h42-0-1" id="h42-0-1" class="i">+
</a><a href="#h42-0-2" id="h42-0-2" class="i">+import me.rhunk.snapenhance.data.wrapper.AbstractWrapper
</a><a href="#h42-0-3" id="h42-0-3" class="i">+import me.rhunk.snapenhance.util.ReflectionHelper
</a><a href="#h42-0-4" id="h42-0-4" class="i">+
</a><a href="#h42-0-5" id="h42-0-5" class="i">+class Layer(obj: Any) : AbstractWrapper(obj) {
</a><a href="#h42-0-6" id="h42-0-6" class="i">+    val paramMap: ParamMap
</a><a href="#h42-0-7" id="h42-0-7" class="i">+        get() {
</a><a href="#h42-0-8" id="h42-0-8" class="i">+            val layerControllerField = ReflectionHelper.searchFieldContainsToString(
</a><a href="#h42-0-9" id="h42-0-9" class="i">+                instance::class.java,
</a><a href="#h42-0-10" id="h42-0-10" class="i">+                instance,
</a><a href="#h42-0-11" id="h42-0-11" class="i">+                &quot;OperaPageModel&quot;
</a><a href="#h42-0-12" id="h42-0-12" class="i">+            )!!
</a><a href="#h42-0-13" id="h42-0-13" class="i">+
</a><a href="#h42-0-14" id="h42-0-14" class="i">+            val paramsMapHashMap = ReflectionHelper.searchFieldStartsWithToString(
</a><a href="#h42-0-15" id="h42-0-15" class="i">+                layerControllerField.type,
</a><a href="#h42-0-16" id="h42-0-16" class="i">+                layerControllerField[instance] as Any, &quot;OperaPageModel&quot;
</a><a href="#h42-0-17" id="h42-0-17" class="i">+            )!!
</a><a href="#h42-0-18" id="h42-0-18" class="i">+            return ParamMap(paramsMapHashMap[layerControllerField[instance]]!!)
</a><a href="#h42-0-19" id="h42-0-19" class="i">+        }
</a><a href="#h42-0-20" id="h42-0-20" class="i">+}
</a><b>diff --git a/<a id="h43" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/media/opera/LayerController.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/media/opera/LayerController.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/media/opera/LayerController.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/media/opera/LayerController.kt</a></b>
<a href="#h43-0" id="h43-0" class="h">@@ -0,0 +1,18 @@
</a><a href="#h43-0-0" id="h43-0-0" class="i">+package me.rhunk.snapenhance.data.wrapper.impl.media.opera
</a><a href="#h43-0-1" id="h43-0-1" class="i">+
</a><a href="#h43-0-2" id="h43-0-2" class="i">+import de.robv.android.xposed.XposedHelpers
</a><a href="#h43-0-3" id="h43-0-3" class="i">+import me.rhunk.snapenhance.data.wrapper.AbstractWrapper
</a><a href="#h43-0-4" id="h43-0-4" class="i">+import me.rhunk.snapenhance.util.ReflectionHelper
</a><a href="#h43-0-5" id="h43-0-5" class="i">+import java.lang.reflect.Field
</a><a href="#h43-0-6" id="h43-0-6" class="i">+import java.util.concurrent.ConcurrentHashMap
</a><a href="#h43-0-7" id="h43-0-7" class="i">+
</a><a href="#h43-0-8" id="h43-0-8" class="i">+class LayerController(obj: Any) : AbstractWrapper(obj) {
</a><a href="#h43-0-9" id="h43-0-9" class="i">+    val paramMap: ParamMap
</a><a href="#h43-0-10" id="h43-0-10" class="i">+        get() {
</a><a href="#h43-0-11" id="h43-0-11" class="i">+            val paramMapField: Field = ReflectionHelper.searchFieldTypeInSuperClasses(
</a><a href="#h43-0-12" id="h43-0-12" class="i">+                instance::class.java,
</a><a href="#h43-0-13" id="h43-0-13" class="i">+                ConcurrentHashMap::class.java
</a><a href="#h43-0-14" id="h43-0-14" class="i">+            ) ?: throw RuntimeException(&quot;Could not find paramMap field&quot;)
</a><a href="#h43-0-15" id="h43-0-15" class="i">+            return ParamMap(XposedHelpers.getObjectField(instance, paramMapField.name))
</a><a href="#h43-0-16" id="h43-0-16" class="i">+        }
</a><a href="#h43-0-17" id="h43-0-17" class="i">+}
</a><b>diff --git a/<a id="h44" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/media/opera/ParamMap.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/media/opera/ParamMap.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/media/opera/ParamMap.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/data/wrapper/impl/media/opera/ParamMap.kt</a></b>
<a href="#h44-0" id="h44-0" class="h">@@ -0,0 +1,37 @@
</a><a href="#h44-0-0" id="h44-0-0" class="i">+package me.rhunk.snapenhance.data.wrapper.impl.media.opera
</a><a href="#h44-0-1" id="h44-0-1" class="i">+
</a><a href="#h44-0-2" id="h44-0-2" class="i">+import me.rhunk.snapenhance.data.wrapper.AbstractWrapper
</a><a href="#h44-0-3" id="h44-0-3" class="i">+import me.rhunk.snapenhance.util.ReflectionHelper
</a><a href="#h44-0-4" id="h44-0-4" class="i">+import me.rhunk.snapenhance.util.getObjectField
</a><a href="#h44-0-5" id="h44-0-5" class="i">+import java.lang.reflect.Field
</a><a href="#h44-0-6" id="h44-0-6" class="i">+import java.util.concurrent.ConcurrentHashMap
</a><a href="#h44-0-7" id="h44-0-7" class="i">+
</a><a href="#h44-0-8" id="h44-0-8" class="i">+@Suppress(&quot;UNCHECKED_CAST&quot;)
</a><a href="#h44-0-9" id="h44-0-9" class="i">+class ParamMap(obj: Any) : AbstractWrapper(obj) {
</a><a href="#h44-0-10" id="h44-0-10" class="i">+    private val paramMapField: Field by lazy {
</a><a href="#h44-0-11" id="h44-0-11" class="i">+        ReflectionHelper.searchFieldTypeInSuperClasses(
</a><a href="#h44-0-12" id="h44-0-12" class="i">+            instance.javaClass,
</a><a href="#h44-0-13" id="h44-0-13" class="i">+            ConcurrentHashMap::class.java
</a><a href="#h44-0-14" id="h44-0-14" class="i">+        )!!
</a><a href="#h44-0-15" id="h44-0-15" class="i">+    }
</a><a href="#h44-0-16" id="h44-0-16" class="i">+
</a><a href="#h44-0-17" id="h44-0-17" class="i">+    private val concurrentHashMap: ConcurrentHashMap&lt;Any, Any&gt;
</a><a href="#h44-0-18" id="h44-0-18" class="i">+        get() = instance.getObjectField(paramMapField.name) as ConcurrentHashMap&lt;Any, Any&gt;
</a><a href="#h44-0-19" id="h44-0-19" class="i">+
</a><a href="#h44-0-20" id="h44-0-20" class="i">+    operator fun get(key: String): Any? {
</a><a href="#h44-0-21" id="h44-0-21" class="i">+        return concurrentHashMap.keys.firstOrNull{ k: Any -&gt; k.toString() == key }?.let { concurrentHashMap[it] }
</a><a href="#h44-0-22" id="h44-0-22" class="i">+    }
</a><a href="#h44-0-23" id="h44-0-23" class="i">+
</a><a href="#h44-0-24" id="h44-0-24" class="i">+    fun put(key: String, value: Any) {
</a><a href="#h44-0-25" id="h44-0-25" class="i">+        val keyObject = concurrentHashMap.keys.firstOrNull { k: Any -&gt; k.toString() == key } ?: key
</a><a href="#h44-0-26" id="h44-0-26" class="i">+        concurrentHashMap[keyObject] = value
</a><a href="#h44-0-27" id="h44-0-27" class="i">+    }
</a><a href="#h44-0-28" id="h44-0-28" class="i">+
</a><a href="#h44-0-29" id="h44-0-29" class="i">+    fun containsKey(key: String): Boolean {
</a><a href="#h44-0-30" id="h44-0-30" class="i">+        return concurrentHashMap.keys.any { k: Any -&gt; k.toString() == key }
</a><a href="#h44-0-31" id="h44-0-31" class="i">+    }
</a><a href="#h44-0-32" id="h44-0-32" class="i">+
</a><a href="#h44-0-33" id="h44-0-33" class="i">+    override fun toString(): String {
</a><a href="#h44-0-34" id="h44-0-34" class="i">+        return concurrentHashMap.toString()
</a><a href="#h44-0-35" id="h44-0-35" class="i">+    }
</a><a href="#h44-0-36" id="h44-0-36" class="i">+}
</a><b>diff --git a/<a id="h45" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/database/DatabaseAccess.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/database/DatabaseAccess.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/database/DatabaseAccess.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/database/DatabaseAccess.kt</a></b>
<a href="#h45-0" id="h45-0" class="h">@@ -0,0 +1,199 @@
</a><a href="#h45-0-0" id="h45-0-0" class="i">+package me.rhunk.snapenhance.database
</a><a href="#h45-0-1" id="h45-0-1" class="i">+
</a><a href="#h45-0-2" id="h45-0-2" class="i">+import android.annotation.SuppressLint
</a><a href="#h45-0-3" id="h45-0-3" class="i">+import android.database.sqlite.SQLiteDatabase
</a><a href="#h45-0-4" id="h45-0-4" class="i">+import de.robv.android.xposed.XposedBridge
</a><a href="#h45-0-5" id="h45-0-5" class="i">+import me.rhunk.snapenhance.Logger
</a><a href="#h45-0-6" id="h45-0-6" class="i">+import me.rhunk.snapenhance.ModContext
</a><a href="#h45-0-7" id="h45-0-7" class="i">+import me.rhunk.snapenhance.database.objects.*
</a><a href="#h45-0-8" id="h45-0-8" class="i">+import me.rhunk.snapenhance.manager.Manager
</a><a href="#h45-0-9" id="h45-0-9" class="i">+import java.io.File
</a><a href="#h45-0-10" id="h45-0-10" class="i">+
</a><a href="#h45-0-11" id="h45-0-11" class="i">+@SuppressLint(&quot;Range&quot;)
</a><a href="#h45-0-12" id="h45-0-12" class="i">+class DatabaseAccess(private val context: ModContext) : Manager {
</a><a href="#h45-0-13" id="h45-0-13" class="i">+    private val databaseLock = Any()
</a><a href="#h45-0-14" id="h45-0-14" class="i">+
</a><a href="#h45-0-15" id="h45-0-15" class="i">+    private val arroyoDatabase: File by lazy {
</a><a href="#h45-0-16" id="h45-0-16" class="i">+        context.androidContext.getDatabasePath(&quot;arroyo.db&quot;)
</a><a href="#h45-0-17" id="h45-0-17" class="i">+    }
</a><a href="#h45-0-18" id="h45-0-18" class="i">+
</a><a href="#h45-0-19" id="h45-0-19" class="i">+    private val mainDatabase: File by lazy {
</a><a href="#h45-0-20" id="h45-0-20" class="i">+        context.androidContext.getDatabasePath(&quot;main.db&quot;)
</a><a href="#h45-0-21" id="h45-0-21" class="i">+    }
</a><a href="#h45-0-22" id="h45-0-22" class="i">+
</a><a href="#h45-0-23" id="h45-0-23" class="i">+    private fun openMain(): SQLiteDatabase {
</a><a href="#h45-0-24" id="h45-0-24" class="i">+        return SQLiteDatabase.openDatabase(
</a><a href="#h45-0-25" id="h45-0-25" class="i">+            mainDatabase.absolutePath,
</a><a href="#h45-0-26" id="h45-0-26" class="i">+            null,
</a><a href="#h45-0-27" id="h45-0-27" class="i">+            SQLiteDatabase.OPEN_READONLY
</a><a href="#h45-0-28" id="h45-0-28" class="i">+        )!!
</a><a href="#h45-0-29" id="h45-0-29" class="i">+    }
</a><a href="#h45-0-30" id="h45-0-30" class="i">+
</a><a href="#h45-0-31" id="h45-0-31" class="i">+    private fun openArroyo(): SQLiteDatabase {
</a><a href="#h45-0-32" id="h45-0-32" class="i">+        return SQLiteDatabase.openDatabase(
</a><a href="#h45-0-33" id="h45-0-33" class="i">+            arroyoDatabase.absolutePath,
</a><a href="#h45-0-34" id="h45-0-34" class="i">+            null,
</a><a href="#h45-0-35" id="h45-0-35" class="i">+            SQLiteDatabase.OPEN_READONLY
</a><a href="#h45-0-36" id="h45-0-36" class="i">+        )!!
</a><a href="#h45-0-37" id="h45-0-37" class="i">+    }
</a><a href="#h45-0-38" id="h45-0-38" class="i">+
</a><a href="#h45-0-39" id="h45-0-39" class="i">+    private fun &lt;T&gt; safeDatabaseOperation(
</a><a href="#h45-0-40" id="h45-0-40" class="i">+        database: SQLiteDatabase,
</a><a href="#h45-0-41" id="h45-0-41" class="i">+        query: (SQLiteDatabase) -&gt; T?
</a><a href="#h45-0-42" id="h45-0-42" class="i">+    ): T? {
</a><a href="#h45-0-43" id="h45-0-43" class="i">+        synchronized(databaseLock) {
</a><a href="#h45-0-44" id="h45-0-44" class="i">+            return runCatching {
</a><a href="#h45-0-45" id="h45-0-45" class="i">+                query(database)
</a><a href="#h45-0-46" id="h45-0-46" class="i">+            }.onFailure {
</a><a href="#h45-0-47" id="h45-0-47" class="i">+                Logger.xposedLog(&quot;Database operation failed&quot;, it)
</a><a href="#h45-0-48" id="h45-0-48" class="i">+            }.getOrNull()
</a><a href="#h45-0-49" id="h45-0-49" class="i">+        }
</a><a href="#h45-0-50" id="h45-0-50" class="i">+    }
</a><a href="#h45-0-51" id="h45-0-51" class="i">+
</a><a href="#h45-0-52" id="h45-0-52" class="i">+    private fun &lt;T : DatabaseObject&gt; readDatabaseObject(
</a><a href="#h45-0-53" id="h45-0-53" class="i">+        obj: T,
</a><a href="#h45-0-54" id="h45-0-54" class="i">+        database: SQLiteDatabase,
</a><a href="#h45-0-55" id="h45-0-55" class="i">+        table: String,
</a><a href="#h45-0-56" id="h45-0-56" class="i">+        where: String,
</a><a href="#h45-0-57" id="h45-0-57" class="i">+        args: Array&lt;String&gt;
</a><a href="#h45-0-58" id="h45-0-58" class="i">+    ): T? {
</a><a href="#h45-0-59" id="h45-0-59" class="i">+        val cursor = database.rawQuery(&quot;SELECT * FROM $table WHERE $where&quot;, args)
</a><a href="#h45-0-60" id="h45-0-60" class="i">+        if (!cursor.moveToFirst()) {
</a><a href="#h45-0-61" id="h45-0-61" class="i">+            cursor.close()
</a><a href="#h45-0-62" id="h45-0-62" class="i">+            return null
</a><a href="#h45-0-63" id="h45-0-63" class="i">+        }
</a><a href="#h45-0-64" id="h45-0-64" class="i">+        try {
</a><a href="#h45-0-65" id="h45-0-65" class="i">+            obj.write(cursor)
</a><a href="#h45-0-66" id="h45-0-66" class="i">+        } catch (e: Throwable) {
</a><a href="#h45-0-67" id="h45-0-67" class="i">+            Logger.xposedLog(e)
</a><a href="#h45-0-68" id="h45-0-68" class="i">+        }
</a><a href="#h45-0-69" id="h45-0-69" class="i">+        cursor.close()
</a><a href="#h45-0-70" id="h45-0-70" class="i">+        return obj
</a><a href="#h45-0-71" id="h45-0-71" class="i">+    }
</a><a href="#h45-0-72" id="h45-0-72" class="i">+
</a><a href="#h45-0-73" id="h45-0-73" class="i">+    fun getFriendFeedInfoByUserId(userId: String): FriendFeedInfo? {
</a><a href="#h45-0-74" id="h45-0-74" class="i">+        return safeDatabaseOperation(openMain()) { database -&gt;
</a><a href="#h45-0-75" id="h45-0-75" class="i">+            readDatabaseObject(
</a><a href="#h45-0-76" id="h45-0-76" class="i">+                FriendFeedInfo(),
</a><a href="#h45-0-77" id="h45-0-77" class="i">+                database,
</a><a href="#h45-0-78" id="h45-0-78" class="i">+                &quot;FriendsFeedView&quot;,
</a><a href="#h45-0-79" id="h45-0-79" class="i">+                &quot;friendUserId = ?&quot;,
</a><a href="#h45-0-80" id="h45-0-80" class="i">+                arrayOf(userId)
</a><a href="#h45-0-81" id="h45-0-81" class="i">+            )
</a><a href="#h45-0-82" id="h45-0-82" class="i">+        }
</a><a href="#h45-0-83" id="h45-0-83" class="i">+    }
</a><a href="#h45-0-84" id="h45-0-84" class="i">+
</a><a href="#h45-0-85" id="h45-0-85" class="i">+    fun getFriendFeedInfoByConversationId(conversationId: String): FriendFeedInfo? {
</a><a href="#h45-0-86" id="h45-0-86" class="i">+        return safeDatabaseOperation(openMain()) {
</a><a href="#h45-0-87" id="h45-0-87" class="i">+            readDatabaseObject(
</a><a href="#h45-0-88" id="h45-0-88" class="i">+                FriendFeedInfo(),
</a><a href="#h45-0-89" id="h45-0-89" class="i">+                it,
</a><a href="#h45-0-90" id="h45-0-90" class="i">+                &quot;FriendsFeedView&quot;,
</a><a href="#h45-0-91" id="h45-0-91" class="i">+                &quot;key = ?&quot;,
</a><a href="#h45-0-92" id="h45-0-92" class="i">+                arrayOf(conversationId)
</a><a href="#h45-0-93" id="h45-0-93" class="i">+            )
</a><a href="#h45-0-94" id="h45-0-94" class="i">+        }
</a><a href="#h45-0-95" id="h45-0-95" class="i">+    }
</a><a href="#h45-0-96" id="h45-0-96" class="i">+
</a><a href="#h45-0-97" id="h45-0-97" class="i">+    fun getFriendInfo(userId: String): FriendInfo? {
</a><a href="#h45-0-98" id="h45-0-98" class="i">+        return safeDatabaseOperation(openMain()) {
</a><a href="#h45-0-99" id="h45-0-99" class="i">+            readDatabaseObject(
</a><a href="#h45-0-100" id="h45-0-100" class="i">+                FriendInfo(),
</a><a href="#h45-0-101" id="h45-0-101" class="i">+                it,
</a><a href="#h45-0-102" id="h45-0-102" class="i">+                &quot;FriendWithUsername&quot;,
</a><a href="#h45-0-103" id="h45-0-103" class="i">+                &quot;userId = ?&quot;,
</a><a href="#h45-0-104" id="h45-0-104" class="i">+                arrayOf(userId)
</a><a href="#h45-0-105" id="h45-0-105" class="i">+            )
</a><a href="#h45-0-106" id="h45-0-106" class="i">+        }
</a><a href="#h45-0-107" id="h45-0-107" class="i">+    }
</a><a href="#h45-0-108" id="h45-0-108" class="i">+
</a><a href="#h45-0-109" id="h45-0-109" class="i">+    fun getConversationMessageFromId(clientMessageId: Long): ConversationMessage? {
</a><a href="#h45-0-110" id="h45-0-110" class="i">+        return safeDatabaseOperation(openArroyo()) {
</a><a href="#h45-0-111" id="h45-0-111" class="i">+            readDatabaseObject(
</a><a href="#h45-0-112" id="h45-0-112" class="i">+                ConversationMessage(),
</a><a href="#h45-0-113" id="h45-0-113" class="i">+                it,
</a><a href="#h45-0-114" id="h45-0-114" class="i">+                &quot;conversation_message&quot;,
</a><a href="#h45-0-115" id="h45-0-115" class="i">+                &quot;client_message_id = ?&quot;,
</a><a href="#h45-0-116" id="h45-0-116" class="i">+                arrayOf(clientMessageId.toString())
</a><a href="#h45-0-117" id="h45-0-117" class="i">+            )
</a><a href="#h45-0-118" id="h45-0-118" class="i">+        }
</a><a href="#h45-0-119" id="h45-0-119" class="i">+    }
</a><a href="#h45-0-120" id="h45-0-120" class="i">+
</a><a href="#h45-0-121" id="h45-0-121" class="i">+    fun getDMConversationIdFromUserId(userId: String): UserConversationLink? {
</a><a href="#h45-0-122" id="h45-0-122" class="i">+        return safeDatabaseOperation(openArroyo()) {
</a><a href="#h45-0-123" id="h45-0-123" class="i">+            readDatabaseObject(
</a><a href="#h45-0-124" id="h45-0-124" class="i">+                UserConversationLink(),
</a><a href="#h45-0-125" id="h45-0-125" class="i">+                it,
</a><a href="#h45-0-126" id="h45-0-126" class="i">+                &quot;user_conversation&quot;,
</a><a href="#h45-0-127" id="h45-0-127" class="i">+                &quot;user_id = ? AND conversation_type = 0&quot;,
</a><a href="#h45-0-128" id="h45-0-128" class="i">+                arrayOf(userId)
</a><a href="#h45-0-129" id="h45-0-129" class="i">+            )
</a><a href="#h45-0-130" id="h45-0-130" class="i">+        }
</a><a href="#h45-0-131" id="h45-0-131" class="i">+    }
</a><a href="#h45-0-132" id="h45-0-132" class="i">+
</a><a href="#h45-0-133" id="h45-0-133" class="i">+    fun getStoryEntryFromId(storyId: String): StoryEntry? {
</a><a href="#h45-0-134" id="h45-0-134" class="i">+        return safeDatabaseOperation(openMain()) {
</a><a href="#h45-0-135" id="h45-0-135" class="i">+            readDatabaseObject(StoryEntry(), it, &quot;Story&quot;, &quot;storyId = ?&quot;, arrayOf(storyId))
</a><a href="#h45-0-136" id="h45-0-136" class="i">+        }
</a><a href="#h45-0-137" id="h45-0-137" class="i">+    }
</a><a href="#h45-0-138" id="h45-0-138" class="i">+
</a><a href="#h45-0-139" id="h45-0-139" class="i">+    fun getConversationParticipants(conversationId: String): List&lt;String&gt;? {
</a><a href="#h45-0-140" id="h45-0-140" class="i">+        return safeDatabaseOperation(openArroyo()) { arroyoDatabase: SQLiteDatabase -&gt;
</a><a href="#h45-0-141" id="h45-0-141" class="i">+            val cursor = arroyoDatabase.rawQuery(
</a><a href="#h45-0-142" id="h45-0-142" class="i">+                &quot;SELECT * FROM user_conversation WHERE client_conversation_id = ?&quot;,
</a><a href="#h45-0-143" id="h45-0-143" class="i">+                arrayOf(conversationId)
</a><a href="#h45-0-144" id="h45-0-144" class="i">+            )
</a><a href="#h45-0-145" id="h45-0-145" class="i">+            if (!cursor.moveToFirst()) {
</a><a href="#h45-0-146" id="h45-0-146" class="i">+                cursor.close()
</a><a href="#h45-0-147" id="h45-0-147" class="i">+                return@safeDatabaseOperation emptyList()
</a><a href="#h45-0-148" id="h45-0-148" class="i">+            }
</a><a href="#h45-0-149" id="h45-0-149" class="i">+            val participants = mutableListOf&lt;String&gt;()
</a><a href="#h45-0-150" id="h45-0-150" class="i">+            do {
</a><a href="#h45-0-151" id="h45-0-151" class="i">+                participants.add(cursor.getString(cursor.getColumnIndex(&quot;user_id&quot;)))
</a><a href="#h45-0-152" id="h45-0-152" class="i">+            } while (cursor.moveToNext())
</a><a href="#h45-0-153" id="h45-0-153" class="i">+            cursor.close()
</a><a href="#h45-0-154" id="h45-0-154" class="i">+            participants
</a><a href="#h45-0-155" id="h45-0-155" class="i">+        }
</a><a href="#h45-0-156" id="h45-0-156" class="i">+    }
</a><a href="#h45-0-157" id="h45-0-157" class="i">+
</a><a href="#h45-0-158" id="h45-0-158" class="i">+    fun getMyUserId(): String? {
</a><a href="#h45-0-159" id="h45-0-159" class="i">+        return safeDatabaseOperation(openArroyo()) { arroyoDatabase: SQLiteDatabase -&gt;
</a><a href="#h45-0-160" id="h45-0-160" class="i">+            val cursor = arroyoDatabase.rawQuery(buildString {
</a><a href="#h45-0-161" id="h45-0-161" class="i">+                append(&quot;SELECT * FROM required_values WHERE key = &#39;USERID&#39;&quot;)
</a><a href="#h45-0-162" id="h45-0-162" class="i">+            }, null)
</a><a href="#h45-0-163" id="h45-0-163" class="i">+
</a><a href="#h45-0-164" id="h45-0-164" class="i">+            if (!cursor.moveToFirst()) {
</a><a href="#h45-0-165" id="h45-0-165" class="i">+                cursor.close()
</a><a href="#h45-0-166" id="h45-0-166" class="i">+                return@safeDatabaseOperation null
</a><a href="#h45-0-167" id="h45-0-167" class="i">+            }
</a><a href="#h45-0-168" id="h45-0-168" class="i">+
</a><a href="#h45-0-169" id="h45-0-169" class="i">+            val userId = cursor.getString(cursor.getColumnIndex(&quot;value&quot;))
</a><a href="#h45-0-170" id="h45-0-170" class="i">+            cursor.close()
</a><a href="#h45-0-171" id="h45-0-171" class="i">+            userId
</a><a href="#h45-0-172" id="h45-0-172" class="i">+        }
</a><a href="#h45-0-173" id="h45-0-173" class="i">+    }
</a><a href="#h45-0-174" id="h45-0-174" class="i">+
</a><a href="#h45-0-175" id="h45-0-175" class="i">+    fun getMessagesFromConversationId(
</a><a href="#h45-0-176" id="h45-0-176" class="i">+        conversationId: String,
</a><a href="#h45-0-177" id="h45-0-177" class="i">+        limit: Int
</a><a href="#h45-0-178" id="h45-0-178" class="i">+    ): List&lt;ConversationMessage&gt;? {
</a><a href="#h45-0-179" id="h45-0-179" class="i">+        return safeDatabaseOperation(openArroyo()) { arroyoDatabase: SQLiteDatabase -&gt;
</a><a href="#h45-0-180" id="h45-0-180" class="i">+            val cursor = arroyoDatabase.rawQuery(
</a><a href="#h45-0-181" id="h45-0-181" class="i">+                &quot;SELECT * FROM conversation_message WHERE client_conversation_id = ? ORDER BY creation_timestamp DESC LIMIT ?&quot;,
</a><a href="#h45-0-182" id="h45-0-182" class="i">+                arrayOf(conversationId, limit.toString())
</a><a href="#h45-0-183" id="h45-0-183" class="i">+            )
</a><a href="#h45-0-184" id="h45-0-184" class="i">+            if (!cursor.moveToFirst()) {
</a><a href="#h45-0-185" id="h45-0-185" class="i">+                cursor.close()
</a><a href="#h45-0-186" id="h45-0-186" class="i">+                return@safeDatabaseOperation emptyList()
</a><a href="#h45-0-187" id="h45-0-187" class="i">+            }
</a><a href="#h45-0-188" id="h45-0-188" class="i">+            val messages = mutableListOf&lt;ConversationMessage&gt;()
</a><a href="#h45-0-189" id="h45-0-189" class="i">+            do {
</a><a href="#h45-0-190" id="h45-0-190" class="i">+                val message = ConversationMessage()
</a><a href="#h45-0-191" id="h45-0-191" class="i">+                message.write(cursor)
</a><a href="#h45-0-192" id="h45-0-192" class="i">+                messages.add(message)
</a><a href="#h45-0-193" id="h45-0-193" class="i">+            } while (cursor.moveToNext())
</a><a href="#h45-0-194" id="h45-0-194" class="i">+            cursor.close()
</a><a href="#h45-0-195" id="h45-0-195" class="i">+            messages
</a><a href="#h45-0-196" id="h45-0-196" class="i">+        }
</a><a href="#h45-0-197" id="h45-0-197" class="i">+    }
</a><a href="#h45-0-198" id="h45-0-198" class="i">+}</a><a href="#h45-0-199" id="h45-0-199" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h46" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/database/DatabaseObject.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/database/DatabaseObject.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/database/DatabaseObject.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/database/DatabaseObject.kt</a></b>
<a href="#h46-0" id="h46-0" class="h">@@ -0,0 +1,7 @@
</a><a href="#h46-0-0" id="h46-0-0" class="i">+package me.rhunk.snapenhance.database
</a><a href="#h46-0-1" id="h46-0-1" class="i">+
</a><a href="#h46-0-2" id="h46-0-2" class="i">+import android.database.Cursor
</a><a href="#h46-0-3" id="h46-0-3" class="i">+
</a><a href="#h46-0-4" id="h46-0-4" class="i">+interface DatabaseObject {
</a><a href="#h46-0-5" id="h46-0-5" class="i">+    fun write(cursor: Cursor)
</a><a href="#h46-0-6" id="h46-0-6" class="i">+}
</a><b>diff --git a/<a id="h47" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/database/objects/ConversationMessage.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/database/objects/ConversationMessage.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/database/objects/ConversationMessage.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/database/objects/ConversationMessage.kt</a></b>
<a href="#h47-0" id="h47-0" class="h">@@ -0,0 +1,44 @@
</a><a href="#h47-0-0" id="h47-0-0" class="i">+package me.rhunk.snapenhance.database.objects
</a><a href="#h47-0-1" id="h47-0-1" class="i">+
</a><a href="#h47-0-2" id="h47-0-2" class="i">+import android.annotation.SuppressLint
</a><a href="#h47-0-3" id="h47-0-3" class="i">+import android.database.Cursor
</a><a href="#h47-0-4" id="h47-0-4" class="i">+import me.rhunk.snapenhance.Constants
</a><a href="#h47-0-5" id="h47-0-5" class="i">+import me.rhunk.snapenhance.data.ContentType
</a><a href="#h47-0-6" id="h47-0-6" class="i">+import me.rhunk.snapenhance.database.DatabaseObject
</a><a href="#h47-0-7" id="h47-0-7" class="i">+import me.rhunk.snapenhance.util.protobuf.ProtoReader
</a><a href="#h47-0-8" id="h47-0-8" class="i">+
</a><a href="#h47-0-9" id="h47-0-9" class="i">+@Suppress(&quot;ArrayInDataClass&quot;)
</a><a href="#h47-0-10" id="h47-0-10" class="i">+data class ConversationMessage(
</a><a href="#h47-0-11" id="h47-0-11" class="i">+    var client_conversation_id: String? = null,
</a><a href="#h47-0-12" id="h47-0-12" class="i">+    var client_message_id: Int = 0,
</a><a href="#h47-0-13" id="h47-0-13" class="i">+    var server_message_id: Int = 0,
</a><a href="#h47-0-14" id="h47-0-14" class="i">+    var message_content: ByteArray? = null,
</a><a href="#h47-0-15" id="h47-0-15" class="i">+    var is_saved: Int = 0,
</a><a href="#h47-0-16" id="h47-0-16" class="i">+    var is_viewed_by_user: Int = 0,
</a><a href="#h47-0-17" id="h47-0-17" class="i">+    var content_type: Int = 0,
</a><a href="#h47-0-18" id="h47-0-18" class="i">+    var creation_timestamp: Long = 0,
</a><a href="#h47-0-19" id="h47-0-19" class="i">+    var read_timestamp: Long = 0,
</a><a href="#h47-0-20" id="h47-0-20" class="i">+    var sender_id: String? = null
</a><a href="#h47-0-21" id="h47-0-21" class="i">+) : DatabaseObject {
</a><a href="#h47-0-22" id="h47-0-22" class="i">+
</a><a href="#h47-0-23" id="h47-0-23" class="i">+    @SuppressLint(&quot;Range&quot;)
</a><a href="#h47-0-24" id="h47-0-24" class="i">+    override fun write(cursor: Cursor) {
</a><a href="#h47-0-25" id="h47-0-25" class="i">+        client_conversation_id = cursor.getString(cursor.getColumnIndex(&quot;client_conversation_id&quot;))
</a><a href="#h47-0-26" id="h47-0-26" class="i">+        client_message_id = cursor.getInt(cursor.getColumnIndex(&quot;client_message_id&quot;))
</a><a href="#h47-0-27" id="h47-0-27" class="i">+        server_message_id = cursor.getInt(cursor.getColumnIndex(&quot;server_message_id&quot;))
</a><a href="#h47-0-28" id="h47-0-28" class="i">+        message_content = cursor.getBlob(cursor.getColumnIndex(&quot;message_content&quot;))
</a><a href="#h47-0-29" id="h47-0-29" class="i">+        is_saved = cursor.getInt(cursor.getColumnIndex(&quot;is_saved&quot;))
</a><a href="#h47-0-30" id="h47-0-30" class="i">+        is_viewed_by_user = cursor.getInt(cursor.getColumnIndex(&quot;is_viewed_by_user&quot;))
</a><a href="#h47-0-31" id="h47-0-31" class="i">+        content_type = cursor.getInt(cursor.getColumnIndex(&quot;content_type&quot;))
</a><a href="#h47-0-32" id="h47-0-32" class="i">+        creation_timestamp = cursor.getLong(cursor.getColumnIndex(&quot;creation_timestamp&quot;))
</a><a href="#h47-0-33" id="h47-0-33" class="i">+        read_timestamp = cursor.getLong(cursor.getColumnIndex(&quot;read_timestamp&quot;))
</a><a href="#h47-0-34" id="h47-0-34" class="i">+        sender_id = cursor.getString(cursor.getColumnIndex(&quot;sender_id&quot;))
</a><a href="#h47-0-35" id="h47-0-35" class="i">+    }
</a><a href="#h47-0-36" id="h47-0-36" class="i">+
</a><a href="#h47-0-37" id="h47-0-37" class="i">+    fun getMessageAsString(): String? {
</a><a href="#h47-0-38" id="h47-0-38" class="i">+        return when (ContentType.fromId(content_type)) {
</a><a href="#h47-0-39" id="h47-0-39" class="i">+            ContentType.CHAT -&gt; message_content?.let { ProtoReader(it).getString(*Constants.ARROYO_STRING_CHAT_MESSAGE_PROTO) }
</a><a href="#h47-0-40" id="h47-0-40" class="i">+            else -&gt; null
</a><a href="#h47-0-41" id="h47-0-41" class="i">+        }
</a><a href="#h47-0-42" id="h47-0-42" class="i">+    }
</a><a href="#h47-0-43" id="h47-0-43" class="i">+}
</a><b>diff --git a/<a id="h48" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/database/objects/FriendFeedInfo.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/database/objects/FriendFeedInfo.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/database/objects/FriendFeedInfo.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/database/objects/FriendFeedInfo.kt</a></b>
<a href="#h48-0" id="h48-0" class="h">@@ -0,0 +1,33 @@
</a><a href="#h48-0-0" id="h48-0-0" class="i">+package me.rhunk.snapenhance.database.objects
</a><a href="#h48-0-1" id="h48-0-1" class="i">+
</a><a href="#h48-0-2" id="h48-0-2" class="i">+import android.annotation.SuppressLint
</a><a href="#h48-0-3" id="h48-0-3" class="i">+import android.database.Cursor
</a><a href="#h48-0-4" id="h48-0-4" class="i">+import me.rhunk.snapenhance.database.DatabaseObject
</a><a href="#h48-0-5" id="h48-0-5" class="i">+
</a><a href="#h48-0-6" id="h48-0-6" class="i">+data class FriendFeedInfo(
</a><a href="#h48-0-7" id="h48-0-7" class="i">+    var id: Int = 0,
</a><a href="#h48-0-8" id="h48-0-8" class="i">+    var feedDisplayName: String? = null,
</a><a href="#h48-0-9" id="h48-0-9" class="i">+    var participantsSize: Int = 0,
</a><a href="#h48-0-10" id="h48-0-10" class="i">+    var lastInteractionTimestamp: Long = 0,
</a><a href="#h48-0-11" id="h48-0-11" class="i">+    var displayTimestamp: Long = 0,
</a><a href="#h48-0-12" id="h48-0-12" class="i">+    var displayInteractionType: String? = null,
</a><a href="#h48-0-13" id="h48-0-13" class="i">+    var lastInteractionUserId: Int = 0,
</a><a href="#h48-0-14" id="h48-0-14" class="i">+    var key: String? = null,
</a><a href="#h48-0-15" id="h48-0-15" class="i">+    var friendUserId: String? = null,
</a><a href="#h48-0-16" id="h48-0-16" class="i">+    var friendDisplayName: String? = null,
</a><a href="#h48-0-17" id="h48-0-17" class="i">+) : DatabaseObject {
</a><a href="#h48-0-18" id="h48-0-18" class="i">+
</a><a href="#h48-0-19" id="h48-0-19" class="i">+    @SuppressLint(&quot;Range&quot;)
</a><a href="#h48-0-20" id="h48-0-20" class="i">+    override fun write(cursor: Cursor) {
</a><a href="#h48-0-21" id="h48-0-21" class="i">+        id = cursor.getInt(cursor.getColumnIndex(&quot;_id&quot;))
</a><a href="#h48-0-22" id="h48-0-22" class="i">+        feedDisplayName = cursor.getString(cursor.getColumnIndex(&quot;feedDisplayName&quot;))
</a><a href="#h48-0-23" id="h48-0-23" class="i">+        participantsSize = cursor.getInt(cursor.getColumnIndex(&quot;participantsSize&quot;))
</a><a href="#h48-0-24" id="h48-0-24" class="i">+        lastInteractionTimestamp = cursor.getLong(cursor.getColumnIndex(&quot;lastInteractionTimestamp&quot;))
</a><a href="#h48-0-25" id="h48-0-25" class="i">+        displayTimestamp = cursor.getLong(cursor.getColumnIndex(&quot;displayTimestamp&quot;))
</a><a href="#h48-0-26" id="h48-0-26" class="i">+        displayInteractionType = cursor.getString(cursor.getColumnIndex(&quot;displayInteractionType&quot;))
</a><a href="#h48-0-27" id="h48-0-27" class="i">+        lastInteractionUserId = cursor.getInt(cursor.getColumnIndex(&quot;lastInteractionUserId&quot;))
</a><a href="#h48-0-28" id="h48-0-28" class="i">+        key = cursor.getString(cursor.getColumnIndex(&quot;key&quot;))
</a><a href="#h48-0-29" id="h48-0-29" class="i">+        friendUserId = cursor.getString(cursor.getColumnIndex(&quot;friendUserId&quot;))
</a><a href="#h48-0-30" id="h48-0-30" class="i">+        friendDisplayName = cursor.getString(cursor.getColumnIndex(&quot;friendDisplayUsername&quot;))
</a><a href="#h48-0-31" id="h48-0-31" class="i">+    }
</a><a href="#h48-0-32" id="h48-0-32" class="i">+}
</a><b>diff --git a/<a id="h49" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/database/objects/FriendInfo.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/database/objects/FriendInfo.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/database/objects/FriendInfo.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/database/objects/FriendInfo.kt</a></b>
<a href="#h49-0" id="h49-0" class="h">@@ -0,0 +1,58 @@
</a><a href="#h49-0-0" id="h49-0-0" class="i">+package me.rhunk.snapenhance.database.objects
</a><a href="#h49-0-1" id="h49-0-1" class="i">+
</a><a href="#h49-0-2" id="h49-0-2" class="i">+import android.annotation.SuppressLint
</a><a href="#h49-0-3" id="h49-0-3" class="i">+import android.database.Cursor
</a><a href="#h49-0-4" id="h49-0-4" class="i">+import me.rhunk.snapenhance.database.DatabaseObject
</a><a href="#h49-0-5" id="h49-0-5" class="i">+
</a><a href="#h49-0-6" id="h49-0-6" class="i">+data class FriendInfo(
</a><a href="#h49-0-7" id="h49-0-7" class="i">+    var id: Int = 0,
</a><a href="#h49-0-8" id="h49-0-8" class="i">+    var lastModifiedTimestamp: Long = 0,
</a><a href="#h49-0-9" id="h49-0-9" class="i">+    var username: String? = null,
</a><a href="#h49-0-10" id="h49-0-10" class="i">+    var userId: String? = null,
</a><a href="#h49-0-11" id="h49-0-11" class="i">+    var displayName: String? = null,
</a><a href="#h49-0-12" id="h49-0-12" class="i">+    var bitmojiAvatarId: String? = null,
</a><a href="#h49-0-13" id="h49-0-13" class="i">+    var bitmojiSelfieId: String? = null,
</a><a href="#h49-0-14" id="h49-0-14" class="i">+    var bitmojiSceneId: String? = null,
</a><a href="#h49-0-15" id="h49-0-15" class="i">+    var bitmojiBackgroundId: String? = null,
</a><a href="#h49-0-16" id="h49-0-16" class="i">+    var friendmojis: String? = null,
</a><a href="#h49-0-17" id="h49-0-17" class="i">+    var friendmojiCategories: String? = null,
</a><a href="#h49-0-18" id="h49-0-18" class="i">+    var snapScore: Int = 0,
</a><a href="#h49-0-19" id="h49-0-19" class="i">+    var birthday: Long = 0,
</a><a href="#h49-0-20" id="h49-0-20" class="i">+    var addedTimestamp: Long = 0,
</a><a href="#h49-0-21" id="h49-0-21" class="i">+    var reverseAddedTimestamp: Long = 0,
</a><a href="#h49-0-22" id="h49-0-22" class="i">+    var serverDisplayName: String? = null,
</a><a href="#h49-0-23" id="h49-0-23" class="i">+    var streakLength: Int = 0,
</a><a href="#h49-0-24" id="h49-0-24" class="i">+    var streakExpirationTimestamp: Long = 0,
</a><a href="#h49-0-25" id="h49-0-25" class="i">+    var reverseBestFriendRanking: Int = 0,
</a><a href="#h49-0-26" id="h49-0-26" class="i">+    var isPinnedBestFriend: Int = 0,
</a><a href="#h49-0-27" id="h49-0-27" class="i">+    var plusBadgeVisibility: Int = 0,
</a><a href="#h49-0-28" id="h49-0-28" class="i">+    var usernameForSorting: String? = null
</a><a href="#h49-0-29" id="h49-0-29" class="i">+) : DatabaseObject {
</a><a href="#h49-0-30" id="h49-0-30" class="i">+    @SuppressLint(&quot;Range&quot;)
</a><a href="#h49-0-31" id="h49-0-31" class="i">+    override fun write(cursor: Cursor) {
</a><a href="#h49-0-32" id="h49-0-32" class="i">+        id = cursor.getInt(cursor.getColumnIndex(&quot;_id&quot;))
</a><a href="#h49-0-33" id="h49-0-33" class="i">+        lastModifiedTimestamp = cursor.getLong(cursor.getColumnIndex(&quot;_lastModifiedTimestamp&quot;))
</a><a href="#h49-0-34" id="h49-0-34" class="i">+        username = cursor.getString(cursor.getColumnIndex(&quot;username&quot;))
</a><a href="#h49-0-35" id="h49-0-35" class="i">+        userId = cursor.getString(cursor.getColumnIndex(&quot;userId&quot;))
</a><a href="#h49-0-36" id="h49-0-36" class="i">+        displayName = cursor.getString(cursor.getColumnIndex(&quot;displayName&quot;))
</a><a href="#h49-0-37" id="h49-0-37" class="i">+        bitmojiAvatarId = cursor.getString(cursor.getColumnIndex(&quot;bitmojiAvatarId&quot;))
</a><a href="#h49-0-38" id="h49-0-38" class="i">+        bitmojiSelfieId = cursor.getString(cursor.getColumnIndex(&quot;bitmojiSelfieId&quot;))
</a><a href="#h49-0-39" id="h49-0-39" class="i">+        bitmojiSceneId = cursor.getString(cursor.getColumnIndex(&quot;bitmojiSceneId&quot;))
</a><a href="#h49-0-40" id="h49-0-40" class="i">+        bitmojiBackgroundId = cursor.getString(cursor.getColumnIndex(&quot;bitmojiBackgroundId&quot;))
</a><a href="#h49-0-41" id="h49-0-41" class="i">+        friendmojis = cursor.getString(cursor.getColumnIndex(&quot;friendmojis&quot;))
</a><a href="#h49-0-42" id="h49-0-42" class="i">+        friendmojiCategories = cursor.getString(cursor.getColumnIndex(&quot;friendmojiCategories&quot;))
</a><a href="#h49-0-43" id="h49-0-43" class="i">+        snapScore = cursor.getInt(cursor.getColumnIndex(&quot;score&quot;))
</a><a href="#h49-0-44" id="h49-0-44" class="i">+        birthday = cursor.getLong(cursor.getColumnIndex(&quot;birthday&quot;))
</a><a href="#h49-0-45" id="h49-0-45" class="i">+        addedTimestamp = cursor.getLong(cursor.getColumnIndex(&quot;addedTimestamp&quot;))
</a><a href="#h49-0-46" id="h49-0-46" class="i">+        reverseAddedTimestamp = cursor.getLong(cursor.getColumnIndex(&quot;reverseAddedTimestamp&quot;))
</a><a href="#h49-0-47" id="h49-0-47" class="i">+        serverDisplayName = cursor.getString(cursor.getColumnIndex(&quot;serverDisplayName&quot;))
</a><a href="#h49-0-48" id="h49-0-48" class="i">+        streakLength = cursor.getInt(cursor.getColumnIndex(&quot;streakLength&quot;))
</a><a href="#h49-0-49" id="h49-0-49" class="i">+        streakExpirationTimestamp = cursor.getLong(cursor.getColumnIndex(&quot;streakExpiration&quot;))
</a><a href="#h49-0-50" id="h49-0-50" class="i">+        reverseBestFriendRanking = cursor.getInt(cursor.getColumnIndex(&quot;reverseBestFriendRanking&quot;))
</a><a href="#h49-0-51" id="h49-0-51" class="i">+        usernameForSorting = cursor.getString(cursor.getColumnIndex(&quot;usernameForSorting&quot;))
</a><a href="#h49-0-52" id="h49-0-52" class="i">+        if (cursor.getColumnIndex(&quot;isPinnedBestFriend&quot;) != -1) isPinnedBestFriend =
</a><a href="#h49-0-53" id="h49-0-53" class="i">+            cursor.getInt(cursor.getColumnIndex(&quot;isPinnedBestFriend&quot;))
</a><a href="#h49-0-54" id="h49-0-54" class="i">+        if (cursor.getColumnIndex(&quot;plusBadgeVisibility&quot;) != -1) plusBadgeVisibility =
</a><a href="#h49-0-55" id="h49-0-55" class="i">+            cursor.getInt(cursor.getColumnIndex(&quot;plusBadgeVisibility&quot;))
</a><a href="#h49-0-56" id="h49-0-56" class="i">+    }
</a><a href="#h49-0-57" id="h49-0-57" class="i">+}
</a><b>diff --git a/<a id="h50" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/database/objects/StoryEntry.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/database/objects/StoryEntry.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/database/objects/StoryEntry.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/database/objects/StoryEntry.kt</a></b>
<a href="#h50-0" id="h50-0" class="h">@@ -0,0 +1,23 @@
</a><a href="#h50-0-0" id="h50-0-0" class="i">+package me.rhunk.snapenhance.database.objects
</a><a href="#h50-0-1" id="h50-0-1" class="i">+
</a><a href="#h50-0-2" id="h50-0-2" class="i">+import android.annotation.SuppressLint
</a><a href="#h50-0-3" id="h50-0-3" class="i">+import android.database.Cursor
</a><a href="#h50-0-4" id="h50-0-4" class="i">+import me.rhunk.snapenhance.database.DatabaseObject
</a><a href="#h50-0-5" id="h50-0-5" class="i">+
</a><a href="#h50-0-6" id="h50-0-6" class="i">+data class StoryEntry(
</a><a href="#h50-0-7" id="h50-0-7" class="i">+    var id: Int = 0,
</a><a href="#h50-0-8" id="h50-0-8" class="i">+    var storyId: String? = null,
</a><a href="#h50-0-9" id="h50-0-9" class="i">+    var displayName: String? = null,
</a><a href="#h50-0-10" id="h50-0-10" class="i">+    var isLocal: Boolean? = null,
</a><a href="#h50-0-11" id="h50-0-11" class="i">+    var userId: String? = null
</a><a href="#h50-0-12" id="h50-0-12" class="i">+) : DatabaseObject {
</a><a href="#h50-0-13" id="h50-0-13" class="i">+
</a><a href="#h50-0-14" id="h50-0-14" class="i">+    @SuppressLint(&quot;Range&quot;)
</a><a href="#h50-0-15" id="h50-0-15" class="i">+    override fun write(cursor: Cursor) {
</a><a href="#h50-0-16" id="h50-0-16" class="i">+        id = cursor.getInt(cursor.getColumnIndex(&quot;_id&quot;))
</a><a href="#h50-0-17" id="h50-0-17" class="i">+        storyId = cursor.getString(cursor.getColumnIndex(&quot;storyId&quot;))
</a><a href="#h50-0-18" id="h50-0-18" class="i">+        displayName = cursor.getString(cursor.getColumnIndex(&quot;displayName&quot;))
</a><a href="#h50-0-19" id="h50-0-19" class="i">+        isLocal = cursor.getInt(cursor.getColumnIndex(&quot;isLocal&quot;)) == 1
</a><a href="#h50-0-20" id="h50-0-20" class="i">+        userId = cursor.getString(cursor.getColumnIndex(&quot;userId&quot;))
</a><a href="#h50-0-21" id="h50-0-21" class="i">+    }
</a><a href="#h50-0-22" id="h50-0-22" class="i">+}
</a><b>diff --git a/<a id="h51" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/database/objects/UserConversationLink.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/database/objects/UserConversationLink.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/database/objects/UserConversationLink.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/database/objects/UserConversationLink.kt</a></b>
<a href="#h51-0" id="h51-0" class="h">@@ -0,0 +1,19 @@
</a><a href="#h51-0-0" id="h51-0-0" class="i">+package me.rhunk.snapenhance.database.objects
</a><a href="#h51-0-1" id="h51-0-1" class="i">+
</a><a href="#h51-0-2" id="h51-0-2" class="i">+import android.annotation.SuppressLint
</a><a href="#h51-0-3" id="h51-0-3" class="i">+import android.database.Cursor
</a><a href="#h51-0-4" id="h51-0-4" class="i">+import me.rhunk.snapenhance.database.DatabaseObject
</a><a href="#h51-0-5" id="h51-0-5" class="i">+
</a><a href="#h51-0-6" id="h51-0-6" class="i">+class UserConversationLink(
</a><a href="#h51-0-7" id="h51-0-7" class="i">+    var user_id: String? = null,
</a><a href="#h51-0-8" id="h51-0-8" class="i">+    var client_conversation_id: String? = null,
</a><a href="#h51-0-9" id="h51-0-9" class="i">+    var conversation_type: Int = 0
</a><a href="#h51-0-10" id="h51-0-10" class="i">+) : DatabaseObject {
</a><a href="#h51-0-11" id="h51-0-11" class="i">+
</a><a href="#h51-0-12" id="h51-0-12" class="i">+    @SuppressLint(&quot;Range&quot;)
</a><a href="#h51-0-13" id="h51-0-13" class="i">+    override fun write(cursor: Cursor) {
</a><a href="#h51-0-14" id="h51-0-14" class="i">+        user_id = cursor.getString(cursor.getColumnIndex(&quot;user_id&quot;))
</a><a href="#h51-0-15" id="h51-0-15" class="i">+        client_conversation_id = cursor.getString(cursor.getColumnIndex(&quot;client_conversation_id&quot;))
</a><a href="#h51-0-16" id="h51-0-16" class="i">+        conversation_type = cursor.getInt(cursor.getColumnIndex(&quot;conversation_type&quot;))
</a><a href="#h51-0-17" id="h51-0-17" class="i">+    }
</a><a href="#h51-0-18" id="h51-0-18" class="i">+}
</a><b>diff --git a/<a id="h52" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/event/EventBus.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/event/EventBus.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/event/EventBus.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/event/EventBus.kt</a></b>
<a href="#h52-0" id="h52-0" class="h">@@ -0,0 +1,62 @@
</a><a href="#h52-0-0" id="h52-0-0" class="i">+package me.rhunk.snapenhance.event
</a><a href="#h52-0-1" id="h52-0-1" class="i">+
</a><a href="#h52-0-2" id="h52-0-2" class="i">+import me.rhunk.snapenhance.ModContext
</a><a href="#h52-0-3" id="h52-0-3" class="i">+import kotlin.reflect.KClass
</a><a href="#h52-0-4" id="h52-0-4" class="i">+
</a><a href="#h52-0-5" id="h52-0-5" class="i">+abstract class Event {
</a><a href="#h52-0-6" id="h52-0-6" class="i">+    lateinit var context: ModContext
</a><a href="#h52-0-7" id="h52-0-7" class="i">+}
</a><a href="#h52-0-8" id="h52-0-8" class="i">+
</a><a href="#h52-0-9" id="h52-0-9" class="i">+interface IListener&lt;T&gt; {
</a><a href="#h52-0-10" id="h52-0-10" class="i">+    fun handle(event: T)
</a><a href="#h52-0-11" id="h52-0-11" class="i">+}
</a><a href="#h52-0-12" id="h52-0-12" class="i">+
</a><a href="#h52-0-13" id="h52-0-13" class="i">+class EventBus(
</a><a href="#h52-0-14" id="h52-0-14" class="i">+    private val context: ModContext
</a><a href="#h52-0-15" id="h52-0-15" class="i">+) {
</a><a href="#h52-0-16" id="h52-0-16" class="i">+    private val subscribers = mutableMapOf&lt;KClass&lt;out Event&gt;, MutableList&lt;IListener&lt;out Event&gt;&gt;&gt;()
</a><a href="#h52-0-17" id="h52-0-17" class="i">+
</a><a href="#h52-0-18" id="h52-0-18" class="i">+    fun &lt;T : Event&gt; subscribe(event: KClass&lt;T&gt;, listener: IListener&lt;T&gt;) {
</a><a href="#h52-0-19" id="h52-0-19" class="i">+        if (!subscribers.containsKey(event)) {
</a><a href="#h52-0-20" id="h52-0-20" class="i">+            subscribers[event] = mutableListOf()
</a><a href="#h52-0-21" id="h52-0-21" class="i">+        }
</a><a href="#h52-0-22" id="h52-0-22" class="i">+        subscribers[event]!!.add(listener)
</a><a href="#h52-0-23" id="h52-0-23" class="i">+    }
</a><a href="#h52-0-24" id="h52-0-24" class="i">+
</a><a href="#h52-0-25" id="h52-0-25" class="i">+    fun &lt;T : Event&gt; subscribe(event: KClass&lt;T&gt;, listener: (T) -&gt; Unit) {
</a><a href="#h52-0-26" id="h52-0-26" class="i">+        subscribe(event, object : IListener&lt;T&gt; {
</a><a href="#h52-0-27" id="h52-0-27" class="i">+            override fun handle(event: T) {
</a><a href="#h52-0-28" id="h52-0-28" class="i">+                listener(event)
</a><a href="#h52-0-29" id="h52-0-29" class="i">+            }
</a><a href="#h52-0-30" id="h52-0-30" class="i">+        })
</a><a href="#h52-0-31" id="h52-0-31" class="i">+    }
</a><a href="#h52-0-32" id="h52-0-32" class="i">+
</a><a href="#h52-0-33" id="h52-0-33" class="i">+    fun &lt;T : Event&gt; unsubscribe(event: KClass&lt;T&gt;, listener: IListener&lt;T&gt;) {
</a><a href="#h52-0-34" id="h52-0-34" class="i">+        if (!subscribers.containsKey(event)) {
</a><a href="#h52-0-35" id="h52-0-35" class="i">+            return
</a><a href="#h52-0-36" id="h52-0-36" class="i">+        }
</a><a href="#h52-0-37" id="h52-0-37" class="i">+        subscribers[event]!!.remove(listener)
</a><a href="#h52-0-38" id="h52-0-38" class="i">+    }
</a><a href="#h52-0-39" id="h52-0-39" class="i">+
</a><a href="#h52-0-40" id="h52-0-40" class="i">+    fun &lt;T : Event&gt; post(event: T) {
</a><a href="#h52-0-41" id="h52-0-41" class="i">+        if (!subscribers.containsKey(event::class)) {
</a><a href="#h52-0-42" id="h52-0-42" class="i">+            return
</a><a href="#h52-0-43" id="h52-0-43" class="i">+        }
</a><a href="#h52-0-44" id="h52-0-44" class="i">+
</a><a href="#h52-0-45" id="h52-0-45" class="i">+        event.context = context
</a><a href="#h52-0-46" id="h52-0-46" class="i">+
</a><a href="#h52-0-47" id="h52-0-47" class="i">+        subscribers[event::class]!!.forEach { listener -&gt;
</a><a href="#h52-0-48" id="h52-0-48" class="i">+            @Suppress(&quot;UNCHECKED_CAST&quot;)
</a><a href="#h52-0-49" id="h52-0-49" class="i">+            try {
</a><a href="#h52-0-50" id="h52-0-50" class="i">+                (listener as IListener&lt;T&gt;).handle(event)
</a><a href="#h52-0-51" id="h52-0-51" class="i">+            } catch (t: Throwable) {
</a><a href="#h52-0-52" id="h52-0-52" class="i">+                println(&quot;Error while handling event ${event::class.simpleName} by ${listener::class.simpleName}&quot;)
</a><a href="#h52-0-53" id="h52-0-53" class="i">+                t.printStackTrace()
</a><a href="#h52-0-54" id="h52-0-54" class="i">+            }
</a><a href="#h52-0-55" id="h52-0-55" class="i">+        }
</a><a href="#h52-0-56" id="h52-0-56" class="i">+    }
</a><a href="#h52-0-57" id="h52-0-57" class="i">+
</a><a href="#h52-0-58" id="h52-0-58" class="i">+    fun clear() {
</a><a href="#h52-0-59" id="h52-0-59" class="i">+        subscribers.clear()
</a><a href="#h52-0-60" id="h52-0-60" class="i">+    }
</a><a href="#h52-0-61" id="h52-0-61" class="i">+}</a><a href="#h52-0-62" id="h52-0-62" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h53" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/event/Events.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/event/Events.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/event/Events.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/event/Events.kt</a></b>
<a href="#h53-0" id="h53-0" class="h">@@ -0,0 +1,3 @@
</a><a href="#h53-0-0" id="h53-0-0" class="i">+package me.rhunk.snapenhance.event
</a><a href="#h53-0-1" id="h53-0-1" class="i">+
</a><a href="#h53-0-2" id="h53-0-2" class="i">+//TODO: addView event</a><a href="#h53-0-3" id="h53-0-3" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h54" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/Feature.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/Feature.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/Feature.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/Feature.kt</a></b>
<a href="#h54-0" id="h54-0" class="h">@@ -0,0 +1,31 @@
</a><a href="#h54-0-0" id="h54-0-0" class="i">+package me.rhunk.snapenhance.features
</a><a href="#h54-0-1" id="h54-0-1" class="i">+
</a><a href="#h54-0-2" id="h54-0-2" class="i">+import me.rhunk.snapenhance.ModContext
</a><a href="#h54-0-3" id="h54-0-3" class="i">+
</a><a href="#h54-0-4" id="h54-0-4" class="i">+abstract class Feature(
</a><a href="#h54-0-5" id="h54-0-5" class="i">+    val nameKey: String,
</a><a href="#h54-0-6" id="h54-0-6" class="i">+    val loadParams: Int = FeatureLoadParams.INIT_SYNC
</a><a href="#h54-0-7" id="h54-0-7" class="i">+) {
</a><a href="#h54-0-8" id="h54-0-8" class="i">+    lateinit var context: ModContext
</a><a href="#h54-0-9" id="h54-0-9" class="i">+
</a><a href="#h54-0-10" id="h54-0-10" class="i">+    /**
</a><a href="#h54-0-11" id="h54-0-11" class="i">+     * called on the main thread when the mod initialize
</a><a href="#h54-0-12" id="h54-0-12" class="i">+     */
</a><a href="#h54-0-13" id="h54-0-13" class="i">+    open fun init() {}
</a><a href="#h54-0-14" id="h54-0-14" class="i">+
</a><a href="#h54-0-15" id="h54-0-15" class="i">+    /**
</a><a href="#h54-0-16" id="h54-0-16" class="i">+     * called on a dedicated thread when the mod initialize
</a><a href="#h54-0-17" id="h54-0-17" class="i">+     */
</a><a href="#h54-0-18" id="h54-0-18" class="i">+    open fun asyncInit() {}
</a><a href="#h54-0-19" id="h54-0-19" class="i">+
</a><a href="#h54-0-20" id="h54-0-20" class="i">+    /**
</a><a href="#h54-0-21" id="h54-0-21" class="i">+     * called when the Snapchat Activity is created
</a><a href="#h54-0-22" id="h54-0-22" class="i">+     */
</a><a href="#h54-0-23" id="h54-0-23" class="i">+    open fun onActivityCreate() {}
</a><a href="#h54-0-24" id="h54-0-24" class="i">+
</a><a href="#h54-0-25" id="h54-0-25" class="i">+
</a><a href="#h54-0-26" id="h54-0-26" class="i">+    /**
</a><a href="#h54-0-27" id="h54-0-27" class="i">+     * called on a dedicated thread when the Snapchat Activity is created
</a><a href="#h54-0-28" id="h54-0-28" class="i">+     */
</a><a href="#h54-0-29" id="h54-0-29" class="i">+    open fun asyncOnActivityCreate() {}
</a><a href="#h54-0-30" id="h54-0-30" class="i">+}</a><a href="#h54-0-31" id="h54-0-31" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h55" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/FeatureLoadParams.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/FeatureLoadParams.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/FeatureLoadParams.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/FeatureLoadParams.kt</a></b>
<a href="#h55-0" id="h55-0" class="h">@@ -0,0 +1,11 @@
</a><a href="#h55-0-0" id="h55-0-0" class="i">+package me.rhunk.snapenhance.features
</a><a href="#h55-0-1" id="h55-0-1" class="i">+
</a><a href="#h55-0-2" id="h55-0-2" class="i">+object FeatureLoadParams {
</a><a href="#h55-0-3" id="h55-0-3" class="i">+    const val NO_INIT = 0
</a><a href="#h55-0-4" id="h55-0-4" class="i">+
</a><a href="#h55-0-5" id="h55-0-5" class="i">+    const val INIT_SYNC = 1
</a><a href="#h55-0-6" id="h55-0-6" class="i">+    const val ACTIVITY_CREATE_SYNC = 2
</a><a href="#h55-0-7" id="h55-0-7" class="i">+
</a><a href="#h55-0-8" id="h55-0-8" class="i">+    const val INIT_ASYNC = 3
</a><a href="#h55-0-9" id="h55-0-9" class="i">+    const val ACTIVITY_CREATE_ASYNC = 4
</a><a href="#h55-0-10" id="h55-0-10" class="i">+}</a><a href="#h55-0-11" id="h55-0-11" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h56" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/ConfigEnumKeys.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/ConfigEnumKeys.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/ConfigEnumKeys.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/ConfigEnumKeys.kt</a></b>
<a href="#h56-0" id="h56-0" class="h">@@ -0,0 +1,67 @@
</a><a href="#h56-0-0" id="h56-0-0" class="i">+package me.rhunk.snapenhance.features.impl
</a><a href="#h56-0-1" id="h56-0-1" class="i">+
</a><a href="#h56-0-2" id="h56-0-2" class="i">+import me.rhunk.snapenhance.config.ConfigProperty
</a><a href="#h56-0-3" id="h56-0-3" class="i">+import me.rhunk.snapenhance.features.Feature
</a><a href="#h56-0-4" id="h56-0-4" class="i">+import me.rhunk.snapenhance.features.FeatureLoadParams
</a><a href="#h56-0-5" id="h56-0-5" class="i">+import me.rhunk.snapenhance.util.setObjectField
</a><a href="#h56-0-6" id="h56-0-6" class="i">+import java.lang.reflect.Field
</a><a href="#h56-0-7" id="h56-0-7" class="i">+import java.lang.reflect.Modifier
</a><a href="#h56-0-8" id="h56-0-8" class="i">+import java.util.concurrent.atomic.AtomicReference
</a><a href="#h56-0-9" id="h56-0-9" class="i">+
</a><a href="#h56-0-10" id="h56-0-10" class="i">+class ConfigEnumKeys : Feature(&quot;Config enum keys&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_SYNC) {
</a><a href="#h56-0-11" id="h56-0-11" class="i">+    private fun hookAllEnums(enumClass: Class&lt;*&gt;, callback: (String, AtomicReference&lt;Any&gt;) -&gt; Unit) {
</a><a href="#h56-0-12" id="h56-0-12" class="i">+        //Enum(String, int, ?)
</a><a href="#h56-0-13" id="h56-0-13" class="i">+        //or Enum(?)
</a><a href="#h56-0-14" id="h56-0-14" class="i">+        val enumDataClass = enumClass.constructors[0].parameterTypes.first { clazz: Class&lt;*&gt; -&gt; clazz != String::class.java &amp;&amp; !clazz.isPrimitive }
</a><a href="#h56-0-15" id="h56-0-15" class="i">+
</a><a href="#h56-0-16" id="h56-0-16" class="i">+        //get the field which contains the enum data class
</a><a href="#h56-0-17" id="h56-0-17" class="i">+        val enumDataField = enumClass.declaredFields.first { field: Field -&gt; field.type == enumDataClass }
</a><a href="#h56-0-18" id="h56-0-18" class="i">+
</a><a href="#h56-0-19" id="h56-0-19" class="i">+        //get the field value of the enum data class (the first field of the class with the desc Object)
</a><a href="#h56-0-20" id="h56-0-20" class="i">+        val objectDataField = enumDataField.type.fields.first { field: Field -&gt;
</a><a href="#h56-0-21" id="h56-0-21" class="i">+            field.type == Any::class.java &amp;&amp; Modifier.isPublic(
</a><a href="#h56-0-22" id="h56-0-22" class="i">+                field.modifiers
</a><a href="#h56-0-23" id="h56-0-23" class="i">+            ) &amp;&amp; Modifier.isFinal(field.modifiers)
</a><a href="#h56-0-24" id="h56-0-24" class="i">+        }
</a><a href="#h56-0-25" id="h56-0-25" class="i">+
</a><a href="#h56-0-26" id="h56-0-26" class="i">+        enumClass.enumConstants.forEach { enum -&gt;
</a><a href="#h56-0-27" id="h56-0-27" class="i">+            enumDataField.get(enum)?.let { enumData -&gt;
</a><a href="#h56-0-28" id="h56-0-28" class="i">+                val key = objectDataField.get(enumData)!!.toString()
</a><a href="#h56-0-29" id="h56-0-29" class="i">+                val value = AtomicReference(objectDataField.get(enumData))
</a><a href="#h56-0-30" id="h56-0-30" class="i">+                callback(key, value)
</a><a href="#h56-0-31" id="h56-0-31" class="i">+                enumData.setObjectField(objectDataField.name, value.get())
</a><a href="#h56-0-32" id="h56-0-32" class="i">+            }
</a><a href="#h56-0-33" id="h56-0-33" class="i">+        }
</a><a href="#h56-0-34" id="h56-0-34" class="i">+    }
</a><a href="#h56-0-35" id="h56-0-35" class="i">+
</a><a href="#h56-0-36" id="h56-0-36" class="i">+    override fun onActivityCreate() {
</a><a href="#h56-0-37" id="h56-0-37" class="i">+        if (context.config.bool(ConfigProperty.NEW_MAP_UI)) {
</a><a href="#h56-0-38" id="h56-0-38" class="i">+            hookAllEnums(context.mappings.getMappedClass(&quot;enums&quot;, &quot;PLUS&quot;)) { key, atomicValue -&gt;
</a><a href="#h56-0-39" id="h56-0-39" class="i">+                if (key == &quot;REDUCE_MY_PROFILE_UI_COMPLEXITY&quot;) atomicValue.set(true)
</a><a href="#h56-0-40" id="h56-0-40" class="i">+            }
</a><a href="#h56-0-41" id="h56-0-41" class="i">+        }
</a><a href="#h56-0-42" id="h56-0-42" class="i">+
</a><a href="#h56-0-43" id="h56-0-43" class="i">+        if (context.config.bool(ConfigProperty.LONG_SNAP_SENDING)) {
</a><a href="#h56-0-44" id="h56-0-44" class="i">+            hookAllEnums(context.mappings.getMappedClass(&quot;enums&quot;, &quot;ARROYO&quot;)) { key, atomicValue -&gt;
</a><a href="#h56-0-45" id="h56-0-45" class="i">+                if (key == &quot;ENABLE_LONG_SNAP_SENDING&quot;) atomicValue.set(true)
</a><a href="#h56-0-46" id="h56-0-46" class="i">+            }
</a><a href="#h56-0-47" id="h56-0-47" class="i">+        }
</a><a href="#h56-0-48" id="h56-0-48" class="i">+
</a><a href="#h56-0-49" id="h56-0-49" class="i">+        if (context.config.bool(ConfigProperty.STREAKEXPIRATIONINFO)) {
</a><a href="#h56-0-50" id="h56-0-50" class="i">+            hookAllEnums(context.mappings.getMappedClass(&quot;enums&quot;, &quot;FRIENDS_FEED&quot;)) { key, atomicValue -&gt;
</a><a href="#h56-0-51" id="h56-0-51" class="i">+                if (key == &quot;STREAK_EXPIRATION_INFO&quot;) atomicValue.set(true)
</a><a href="#h56-0-52" id="h56-0-52" class="i">+            }
</a><a href="#h56-0-53" id="h56-0-53" class="i">+        }
</a><a href="#h56-0-54" id="h56-0-54" class="i">+
</a><a href="#h56-0-55" id="h56-0-55" class="i">+        if (context.config.bool(ConfigProperty.BLOCK_ADS)) {
</a><a href="#h56-0-56" id="h56-0-56" class="i">+            hookAllEnums(context.mappings.getMappedClass(&quot;enums&quot;, &quot;SNAPADS&quot;)) { key, atomicValue -&gt;
</a><a href="#h56-0-57" id="h56-0-57" class="i">+                if (key == &quot;BYPASS_AD_FEATURE_GATE&quot;) {
</a><a href="#h56-0-58" id="h56-0-58" class="i">+                    atomicValue.set(true)
</a><a href="#h56-0-59" id="h56-0-59" class="i">+                }
</a><a href="#h56-0-60" id="h56-0-60" class="i">+                if (key == &quot;CUSTOM_AD_SERVER_URL&quot; || key == &quot;CUSTOM_AD_INIT_SERVER_URL&quot; || key == &quot;CUSTOM_AD_TRACKER_URL&quot;) {
</a><a href="#h56-0-61" id="h56-0-61" class="i">+                    atomicValue.set(&quot;http://127.0.0.1&quot;)
</a><a href="#h56-0-62" id="h56-0-62" class="i">+                }
</a><a href="#h56-0-63" id="h56-0-63" class="i">+            }
</a><a href="#h56-0-64" id="h56-0-64" class="i">+        }
</a><a href="#h56-0-65" id="h56-0-65" class="i">+    }
</a><a href="#h56-0-66" id="h56-0-66" class="i">+}</a><a href="#h56-0-67" id="h56-0-67" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h57" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/Messaging.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/Messaging.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/Messaging.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/Messaging.kt</a></b>
<a href="#h57-0" id="h57-0" class="h">@@ -0,0 +1,71 @@
</a><a href="#h57-0-0" id="h57-0-0" class="i">+package me.rhunk.snapenhance.features.impl
</a><a href="#h57-0-1" id="h57-0-1" class="i">+
</a><a href="#h57-0-2" id="h57-0-2" class="i">+import me.rhunk.snapenhance.config.ConfigProperty
</a><a href="#h57-0-3" id="h57-0-3" class="i">+import me.rhunk.snapenhance.data.wrapper.impl.SnapUUID
</a><a href="#h57-0-4" id="h57-0-4" class="i">+import me.rhunk.snapenhance.features.Feature
</a><a href="#h57-0-5" id="h57-0-5" class="i">+import me.rhunk.snapenhance.features.FeatureLoadParams
</a><a href="#h57-0-6" id="h57-0-6" class="i">+import me.rhunk.snapenhance.hook.HookStage
</a><a href="#h57-0-7" id="h57-0-7" class="i">+import me.rhunk.snapenhance.hook.Hooker
</a><a href="#h57-0-8" id="h57-0-8" class="i">+
</a><a href="#h57-0-9" id="h57-0-9" class="i">+class Messaging : Feature(&quot;Messaging&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_SYNC or FeatureLoadParams.INIT_ASYNC or FeatureLoadParams.INIT_SYNC) {
</a><a href="#h57-0-10" id="h57-0-10" class="i">+    lateinit var conversationManager: Any
</a><a href="#h57-0-11" id="h57-0-11" class="i">+
</a><a href="#h57-0-12" id="h57-0-12" class="i">+    var lastOpenedConversationUUID: SnapUUID? = null
</a><a href="#h57-0-13" id="h57-0-13" class="i">+    var lastFetchConversationUserUUID: SnapUUID? = null
</a><a href="#h57-0-14" id="h57-0-14" class="i">+    var lastFetchConversationUUID: SnapUUID? = null
</a><a href="#h57-0-15" id="h57-0-15" class="i">+    var lastFocusedMessageId: Long = -1
</a><a href="#h57-0-16" id="h57-0-16" class="i">+
</a><a href="#h57-0-17" id="h57-0-17" class="i">+    override fun init() {
</a><a href="#h57-0-18" id="h57-0-18" class="i">+        Hooker.hookConstructor(context.classCache.conversationManager, HookStage.BEFORE) {
</a><a href="#h57-0-19" id="h57-0-19" class="i">+            conversationManager = it.thisObject()
</a><a href="#h57-0-20" id="h57-0-20" class="i">+        }
</a><a href="#h57-0-21" id="h57-0-21" class="i">+    }
</a><a href="#h57-0-22" id="h57-0-22" class="i">+
</a><a href="#h57-0-23" id="h57-0-23" class="i">+    override fun onActivityCreate() {
</a><a href="#h57-0-24" id="h57-0-24" class="i">+        with(context.classCache.conversationManager) {
</a><a href="#h57-0-25" id="h57-0-25" class="i">+            Hooker.hook(this, &quot;enterConversation&quot;, HookStage.BEFORE) {
</a><a href="#h57-0-26" id="h57-0-26" class="i">+                lastOpenedConversationUUID = SnapUUID(it.arg(0))
</a><a href="#h57-0-27" id="h57-0-27" class="i">+            }
</a><a href="#h57-0-28" id="h57-0-28" class="i">+
</a><a href="#h57-0-29" id="h57-0-29" class="i">+            Hooker.hook(this, &quot;getOneOnOneConversationIds&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h57-0-30" id="h57-0-30" class="i">+                val conversationIds: List&lt;Any&gt; = param.arg(0)
</a><a href="#h57-0-31" id="h57-0-31" class="i">+                if (conversationIds.isNotEmpty()) {
</a><a href="#h57-0-32" id="h57-0-32" class="i">+                    lastFetchConversationUserUUID = SnapUUID(conversationIds[0])
</a><a href="#h57-0-33" id="h57-0-33" class="i">+                }
</a><a href="#h57-0-34" id="h57-0-34" class="i">+            }
</a><a href="#h57-0-35" id="h57-0-35" class="i">+
</a><a href="#h57-0-36" id="h57-0-36" class="i">+            Hooker.hook(this, &quot;exitConversation&quot;, HookStage.BEFORE) {
</a><a href="#h57-0-37" id="h57-0-37" class="i">+                lastOpenedConversationUUID = null
</a><a href="#h57-0-38" id="h57-0-38" class="i">+            }
</a><a href="#h57-0-39" id="h57-0-39" class="i">+
</a><a href="#h57-0-40" id="h57-0-40" class="i">+            Hooker.hook(this, &quot;fetchConversation&quot;, HookStage.BEFORE) {
</a><a href="#h57-0-41" id="h57-0-41" class="i">+                lastFetchConversationUUID = SnapUUID(it.arg(0))
</a><a href="#h57-0-42" id="h57-0-42" class="i">+            }
</a><a href="#h57-0-43" id="h57-0-43" class="i">+        }
</a><a href="#h57-0-44" id="h57-0-44" class="i">+
</a><a href="#h57-0-45" id="h57-0-45" class="i">+    }
</a><a href="#h57-0-46" id="h57-0-46" class="i">+
</a><a href="#h57-0-47" id="h57-0-47" class="i">+    override fun asyncInit() {
</a><a href="#h57-0-48" id="h57-0-48" class="i">+        arrayOf(&quot;activate&quot;, &quot;deactivate&quot;, &quot;processTypingActivity&quot;).forEach { hook -&gt;
</a><a href="#h57-0-49" id="h57-0-49" class="i">+            Hooker.hook(context.classCache.presenceSession, hook, HookStage.BEFORE, { context.config.bool(ConfigProperty.HIDE_BITMOJI_PRESENCE) }) {
</a><a href="#h57-0-50" id="h57-0-50" class="i">+                it.setResult(null)
</a><a href="#h57-0-51" id="h57-0-51" class="i">+            }
</a><a href="#h57-0-52" id="h57-0-52" class="i">+        }
</a><a href="#h57-0-53" id="h57-0-53" class="i">+
</a><a href="#h57-0-54" id="h57-0-54" class="i">+        //get last opened snap for media downloader
</a><a href="#h57-0-55" id="h57-0-55" class="i">+        Hooker.hook(context.classCache.snapManager, &quot;onSnapInteraction&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h57-0-56" id="h57-0-56" class="i">+            lastOpenedConversationUUID = SnapUUID(param.arg(1))
</a><a href="#h57-0-57" id="h57-0-57" class="i">+            lastFocusedMessageId = param.arg(2)
</a><a href="#h57-0-58" id="h57-0-58" class="i">+        }
</a><a href="#h57-0-59" id="h57-0-59" class="i">+
</a><a href="#h57-0-60" id="h57-0-60" class="i">+        Hooker.hook(context.classCache.conversationManager, &quot;fetchMessage&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h57-0-61" id="h57-0-61" class="i">+            lastFetchConversationUserUUID = SnapUUID((param.arg(0) as Any))
</a><a href="#h57-0-62" id="h57-0-62" class="i">+            lastFocusedMessageId = param.arg(1)
</a><a href="#h57-0-63" id="h57-0-63" class="i">+        }
</a><a href="#h57-0-64" id="h57-0-64" class="i">+
</a><a href="#h57-0-65" id="h57-0-65" class="i">+        Hooker.hook(context.classCache.conversationManager, &quot;sendTypingNotification&quot;, HookStage.BEFORE,
</a><a href="#h57-0-66" id="h57-0-66" class="i">+            {context.config.bool(ConfigProperty.HIDE_TYPING_NOTIFICATION)}) {
</a><a href="#h57-0-67" id="h57-0-67" class="i">+            it.setResult(null)
</a><a href="#h57-0-68" id="h57-0-68" class="i">+        }
</a><a href="#h57-0-69" id="h57-0-69" class="i">+    }
</a><a href="#h57-0-70" id="h57-0-70" class="i">+}</a><a href="#h57-0-71" id="h57-0-71" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h58" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/MediaDownloader.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/MediaDownloader.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/MediaDownloader.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/MediaDownloader.kt</a></b>
<a href="#h58-0" id="h58-0" class="h">@@ -0,0 +1,430 @@
</a><a href="#h58-0-0" id="h58-0-0" class="i">+package me.rhunk.snapenhance.features.impl.downloader
</a><a href="#h58-0-1" id="h58-0-1" class="i">+
</a><a href="#h58-0-2" id="h58-0-2" class="i">+import android.app.AlertDialog
</a><a href="#h58-0-3" id="h58-0-3" class="i">+import android.content.DialogInterface
</a><a href="#h58-0-4" id="h58-0-4" class="i">+import android.graphics.Bitmap
</a><a href="#h58-0-5" id="h58-0-5" class="i">+import android.media.MediaScannerConnection
</a><a href="#h58-0-6" id="h58-0-6" class="i">+import android.net.Uri
</a><a href="#h58-0-7" id="h58-0-7" class="i">+import android.widget.ImageView
</a><a href="#h58-0-8" id="h58-0-8" class="i">+import com.arthenica.ffmpegkit.FFmpegKit
</a><a href="#h58-0-9" id="h58-0-9" class="i">+import de.robv.android.xposed.XposedBridge
</a><a href="#h58-0-10" id="h58-0-10" class="i">+import me.rhunk.snapenhance.Constants
</a><a href="#h58-0-11" id="h58-0-11" class="i">+import me.rhunk.snapenhance.Constants.ARROYO_URL_KEY_PROTO_PATH
</a><a href="#h58-0-12" id="h58-0-12" class="i">+import me.rhunk.snapenhance.Logger
</a><a href="#h58-0-13" id="h58-0-13" class="i">+import me.rhunk.snapenhance.Logger.xposedLog
</a><a href="#h58-0-14" id="h58-0-14" class="i">+import me.rhunk.snapenhance.config.ConfigProperty
</a><a href="#h58-0-15" id="h58-0-15" class="i">+import me.rhunk.snapenhance.data.ContentType
</a><a href="#h58-0-16" id="h58-0-16" class="i">+import me.rhunk.snapenhance.data.FileType
</a><a href="#h58-0-17" id="h58-0-17" class="i">+import me.rhunk.snapenhance.data.wrapper.impl.media.MediaInfo
</a><a href="#h58-0-18" id="h58-0-18" class="i">+import me.rhunk.snapenhance.data.wrapper.impl.media.opera.Layer
</a><a href="#h58-0-19" id="h58-0-19" class="i">+import me.rhunk.snapenhance.data.wrapper.impl.media.opera.ParamMap
</a><a href="#h58-0-20" id="h58-0-20" class="i">+import me.rhunk.snapenhance.features.Feature
</a><a href="#h58-0-21" id="h58-0-21" class="i">+import me.rhunk.snapenhance.features.FeatureLoadParams
</a><a href="#h58-0-22" id="h58-0-22" class="i">+import me.rhunk.snapenhance.features.impl.Messaging
</a><a href="#h58-0-23" id="h58-0-23" class="i">+import me.rhunk.snapenhance.features.impl.spy.MessageLogger
</a><a href="#h58-0-24" id="h58-0-24" class="i">+import me.rhunk.snapenhance.hook.HookAdapter
</a><a href="#h58-0-25" id="h58-0-25" class="i">+import me.rhunk.snapenhance.hook.HookStage
</a><a href="#h58-0-26" id="h58-0-26" class="i">+import me.rhunk.snapenhance.hook.Hooker
</a><a href="#h58-0-27" id="h58-0-27" class="i">+import me.rhunk.snapenhance.util.EncryptionUtils
</a><a href="#h58-0-28" id="h58-0-28" class="i">+import me.rhunk.snapenhance.util.PreviewUtils
</a><a href="#h58-0-29" id="h58-0-29" class="i">+import me.rhunk.snapenhance.util.download.CdnDownloader
</a><a href="#h58-0-30" id="h58-0-30" class="i">+import me.rhunk.snapenhance.util.getObjectField
</a><a href="#h58-0-31" id="h58-0-31" class="i">+import me.rhunk.snapenhance.util.protobuf.ProtoReader
</a><a href="#h58-0-32" id="h58-0-32" class="i">+import java.io.*
</a><a href="#h58-0-33" id="h58-0-33" class="i">+import java.net.HttpURLConnection
</a><a href="#h58-0-34" id="h58-0-34" class="i">+import java.net.URL
</a><a href="#h58-0-35" id="h58-0-35" class="i">+import java.nio.file.Paths
</a><a href="#h58-0-36" id="h58-0-36" class="i">+import java.util.*
</a><a href="#h58-0-37" id="h58-0-37" class="i">+import java.util.concurrent.atomic.AtomicReference
</a><a href="#h58-0-38" id="h58-0-38" class="i">+import java.util.zip.ZipInputStream
</a><a href="#h58-0-39" id="h58-0-39" class="i">+import javax.crypto.Cipher
</a><a href="#h58-0-40" id="h58-0-40" class="i">+import javax.crypto.CipherInputStream
</a><a href="#h58-0-41" id="h58-0-41" class="i">+import kotlin.io.path.inputStream
</a><a href="#h58-0-42" id="h58-0-42" class="i">+
</a><a href="#h58-0-43" id="h58-0-43" class="i">+enum class MediaType {
</a><a href="#h58-0-44" id="h58-0-44" class="i">+    ORIGINAL, OVERLAY
</a><a href="#h58-0-45" id="h58-0-45" class="i">+}
</a><a href="#h58-0-46" id="h58-0-46" class="i">+
</a><a href="#h58-0-47" id="h58-0-47" class="i">+class MediaDownloader : Feature(&quot;MediaDownloader&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_ASYNC) {
</a><a href="#h58-0-48" id="h58-0-48" class="i">+    private var lastSeenMediaInfoMap: MutableMap&lt;MediaType, MediaInfo&gt;? = null
</a><a href="#h58-0-49" id="h58-0-49" class="i">+    private var lastSeenMapParams: ParamMap? = null
</a><a href="#h58-0-50" id="h58-0-50" class="i">+    private var isFFmpegPresent: Boolean? = null
</a><a href="#h58-0-51" id="h58-0-51" class="i">+
</a><a href="#h58-0-52" id="h58-0-52" class="i">+    private fun canMergeOverlay(): Boolean {
</a><a href="#h58-0-53" id="h58-0-53" class="i">+        if (!context.config.bool(ConfigProperty.OVERLAY_MERGE)) return false
</a><a href="#h58-0-54" id="h58-0-54" class="i">+        if (isFFmpegPresent != null) {
</a><a href="#h58-0-55" id="h58-0-55" class="i">+            return isFFmpegPresent!!
</a><a href="#h58-0-56" id="h58-0-56" class="i">+        }
</a><a href="#h58-0-57" id="h58-0-57" class="i">+        //check if ffmpeg is correctly installed
</a><a href="#h58-0-58" id="h58-0-58" class="i">+        isFFmpegPresent = runCatching { FFmpegKit.execute(&quot;-version&quot;) }.isSuccess
</a><a href="#h58-0-59" id="h58-0-59" class="i">+        return isFFmpegPresent!!
</a><a href="#h58-0-60" id="h58-0-60" class="i">+    }
</a><a href="#h58-0-61" id="h58-0-61" class="i">+
</a><a href="#h58-0-62" id="h58-0-62" class="i">+    private fun createNewFilePath(hash: Int, author: String, fileType: FileType): String? {
</a><a href="#h58-0-63" id="h58-0-63" class="i">+        val hexHash = Integer.toHexString(hash)
</a><a href="#h58-0-64" id="h58-0-64" class="i">+        return author + &quot;/&quot; + hexHash + &quot;.&quot; + fileType.fileExtension
</a><a href="#h58-0-65" id="h58-0-65" class="i">+    }
</a><a href="#h58-0-66" id="h58-0-66" class="i">+
</a><a href="#h58-0-67" id="h58-0-67" class="i">+    private fun downloadFile(outputFile: File, content: ByteArray): Boolean {
</a><a href="#h58-0-68" id="h58-0-68" class="i">+        val onDownloadComplete = {
</a><a href="#h58-0-69" id="h58-0-69" class="i">+                context.shortToast(
</a><a href="#h58-0-70" id="h58-0-70" class="i">+                    &quot;Saved to &quot; + outputFile.absolutePath.replace(context.config.string(ConfigProperty.SAVE_FOLDER), &quot;&quot;)
</a><a href="#h58-0-71" id="h58-0-71" class="i">+                        .substring(1)
</a><a href="#h58-0-72" id="h58-0-72" class="i">+                )
</a><a href="#h58-0-73" id="h58-0-73" class="i">+            }
</a><a href="#h58-0-74" id="h58-0-74" class="i">+        if (!context.config.bool(ConfigProperty.USE_DOWNLOAD_MANAGER)) {
</a><a href="#h58-0-75" id="h58-0-75" class="i">+            try {
</a><a href="#h58-0-76" id="h58-0-76" class="i">+                val fos = FileOutputStream(outputFile)
</a><a href="#h58-0-77" id="h58-0-77" class="i">+                fos.write(content)
</a><a href="#h58-0-78" id="h58-0-78" class="i">+                fos.close()
</a><a href="#h58-0-79" id="h58-0-79" class="i">+                MediaScannerConnection.scanFile(
</a><a href="#h58-0-80" id="h58-0-80" class="i">+                    context.androidContext,
</a><a href="#h58-0-81" id="h58-0-81" class="i">+                    arrayOf(outputFile.absolutePath),
</a><a href="#h58-0-82" id="h58-0-82" class="i">+                    null,
</a><a href="#h58-0-83" id="h58-0-83" class="i">+                    null
</a><a href="#h58-0-84" id="h58-0-84" class="i">+                )
</a><a href="#h58-0-85" id="h58-0-85" class="i">+                onDownloadComplete()
</a><a href="#h58-0-86" id="h58-0-86" class="i">+            } catch (e: Throwable) {
</a><a href="#h58-0-87" id="h58-0-87" class="i">+                Logger.xposedLog(e)
</a><a href="#h58-0-88" id="h58-0-88" class="i">+                context.longToast(&quot;Failed to save file: &quot; + e.message)
</a><a href="#h58-0-89" id="h58-0-89" class="i">+                return false
</a><a href="#h58-0-90" id="h58-0-90" class="i">+            }
</a><a href="#h58-0-91" id="h58-0-91" class="i">+            return true
</a><a href="#h58-0-92" id="h58-0-92" class="i">+        }
</a><a href="#h58-0-93" id="h58-0-93" class="i">+        context.downloadServer.startFileDownload(outputFile, content) { result -&gt;
</a><a href="#h58-0-94" id="h58-0-94" class="i">+            if (result) {
</a><a href="#h58-0-95" id="h58-0-95" class="i">+                onDownloadComplete()
</a><a href="#h58-0-96" id="h58-0-96" class="i">+                return@startFileDownload
</a><a href="#h58-0-97" id="h58-0-97" class="i">+            }
</a><a href="#h58-0-98" id="h58-0-98" class="i">+            context.longToast(&quot;Failed to save file. Check logs for more info.&quot;)
</a><a href="#h58-0-99" id="h58-0-99" class="i">+        }
</a><a href="#h58-0-100" id="h58-0-100" class="i">+        return true
</a><a href="#h58-0-101" id="h58-0-101" class="i">+    }
</a><a href="#h58-0-102" id="h58-0-102" class="i">+
</a><a href="#h58-0-103" id="h58-0-103" class="i">+
</a><a href="#h58-0-104" id="h58-0-104" class="i">+    private fun mergeOverlay(original: ByteArray, overlay: ByteArray, isPreviewMode: Boolean): ByteArray? {
</a><a href="#h58-0-105" id="h58-0-105" class="i">+        context.longToast(&quot;Merging current media with overlay. This may take a while.&quot;)
</a><a href="#h58-0-106" id="h58-0-106" class="i">+        val originalFileType = FileType.fromByteArray(original)
</a><a href="#h58-0-107" id="h58-0-107" class="i">+        val overlayFileType = FileType.fromByteArray(overlay)
</a><a href="#h58-0-108" id="h58-0-108" class="i">+        //merge files
</a><a href="#h58-0-109" id="h58-0-109" class="i">+        val mergedFile = File.createTempFile(&quot;merged&quot;, &quot;.&quot; + originalFileType.fileExtension)
</a><a href="#h58-0-110" id="h58-0-110" class="i">+        val tempVideoFile = File.createTempFile(&quot;original&quot;, &quot;.&quot; + originalFileType.fileExtension).also {
</a><a href="#h58-0-111" id="h58-0-111" class="i">+            with(FileOutputStream(it)) {
</a><a href="#h58-0-112" id="h58-0-112" class="i">+                write(original)
</a><a href="#h58-0-113" id="h58-0-113" class="i">+                close()
</a><a href="#h58-0-114" id="h58-0-114" class="i">+            }
</a><a href="#h58-0-115" id="h58-0-115" class="i">+        }
</a><a href="#h58-0-116" id="h58-0-116" class="i">+        val tempOverlayFile = File.createTempFile(&quot;overlay&quot;, &quot;.&quot; + overlayFileType.fileExtension).also {
</a><a href="#h58-0-117" id="h58-0-117" class="i">+            with(FileOutputStream(it)) {
</a><a href="#h58-0-118" id="h58-0-118" class="i">+                write(overlay)
</a><a href="#h58-0-119" id="h58-0-119" class="i">+                close()
</a><a href="#h58-0-120" id="h58-0-120" class="i">+            }
</a><a href="#h58-0-121" id="h58-0-121" class="i">+        }
</a><a href="#h58-0-122" id="h58-0-122" class="i">+
</a><a href="#h58-0-123" id="h58-0-123" class="i">+        //TODO: improve ffmpeg speed
</a><a href="#h58-0-124" id="h58-0-124" class="i">+        val fFmpegSession = FFmpegKit.execute(
</a><a href="#h58-0-125" id="h58-0-125" class="i">+            &quot;-y -i &quot; +
</a><a href="#h58-0-126" id="h58-0-126" class="i">+                    tempVideoFile.absolutePath +
</a><a href="#h58-0-127" id="h58-0-127" class="i">+                    &quot; -i &quot; +
</a><a href="#h58-0-128" id="h58-0-128" class="i">+                    tempOverlayFile.absolutePath +
</a><a href="#h58-0-129" id="h58-0-129" class="i">+                    &quot; -filter_complex \&quot;[0]scale2ref[img][vid];[img]setsar=1[img];[vid]nullsink; [img][1]overlay=(W-w)/2:(H-h)/2,scale=2*trunc(iw*sar/2):2*trunc(ih/2)\&quot; -c:v libx264 -q:v 13 -c:a copy &quot; +
</a><a href="#h58-0-130" id="h58-0-130" class="i">+                    &quot;  -threads 6 ${(if (isPreviewMode) &quot;-frames:v 1&quot; else &quot;&quot;)} &quot; +
</a><a href="#h58-0-131" id="h58-0-131" class="i">+                    mergedFile.absolutePath
</a><a href="#h58-0-132" id="h58-0-132" class="i">+        )
</a><a href="#h58-0-133" id="h58-0-133" class="i">+        tempVideoFile.delete()
</a><a href="#h58-0-134" id="h58-0-134" class="i">+        tempOverlayFile.delete()
</a><a href="#h58-0-135" id="h58-0-135" class="i">+        if (fFmpegSession.returnCode.value != 0) {
</a><a href="#h58-0-136" id="h58-0-136" class="i">+            mergedFile.delete()
</a><a href="#h58-0-137" id="h58-0-137" class="i">+            context.longToast(&quot;Failed to merge video and overlay. See logs for more details.&quot;)
</a><a href="#h58-0-138" id="h58-0-138" class="i">+            Logger.xposedLog(fFmpegSession.output)
</a><a href="#h58-0-139" id="h58-0-139" class="i">+            return null
</a><a href="#h58-0-140" id="h58-0-140" class="i">+        }
</a><a href="#h58-0-141" id="h58-0-141" class="i">+        val mergedFileData: ByteArray = FileInputStream(mergedFile).readBytes()
</a><a href="#h58-0-142" id="h58-0-142" class="i">+        mergedFile.delete()
</a><a href="#h58-0-143" id="h58-0-143" class="i">+        return mergedFileData
</a><a href="#h58-0-144" id="h58-0-144" class="i">+    }
</a><a href="#h58-0-145" id="h58-0-145" class="i">+
</a><a href="#h58-0-146" id="h58-0-146" class="i">+    private fun queryMediaData(mediaInfo: MediaInfo): ByteArray {
</a><a href="#h58-0-147" id="h58-0-147" class="i">+        val mediaUri = Uri.parse(mediaInfo.uri)
</a><a href="#h58-0-148" id="h58-0-148" class="i">+        val mediaInputStream = AtomicReference&lt;InputStream&gt;()
</a><a href="#h58-0-149" id="h58-0-149" class="i">+        if (mediaUri.scheme == &quot;file&quot;) {
</a><a href="#h58-0-150" id="h58-0-150" class="i">+            mediaInputStream.set(Paths.get(mediaUri.path).inputStream())
</a><a href="#h58-0-151" id="h58-0-151" class="i">+        } else {
</a><a href="#h58-0-152" id="h58-0-152" class="i">+            val url = URL(mediaUri.toString())
</a><a href="#h58-0-153" id="h58-0-153" class="i">+            val connection = url.openConnection() as HttpURLConnection
</a><a href="#h58-0-154" id="h58-0-154" class="i">+            connection.requestMethod = &quot;GET&quot;
</a><a href="#h58-0-155" id="h58-0-155" class="i">+            connection.setRequestProperty(&quot;User-Agent&quot;, Constants.USER_AGENT)
</a><a href="#h58-0-156" id="h58-0-156" class="i">+            connection.connect()
</a><a href="#h58-0-157" id="h58-0-157" class="i">+            mediaInputStream.set(connection.inputStream)
</a><a href="#h58-0-158" id="h58-0-158" class="i">+        }
</a><a href="#h58-0-159" id="h58-0-159" class="i">+        mediaInfo.encryption?.let { encryption -&gt;
</a><a href="#h58-0-160" id="h58-0-160" class="i">+            mediaInputStream.set(CipherInputStream(mediaInputStream.get(), encryption.newCipher(Cipher.DECRYPT_MODE)))
</a><a href="#h58-0-161" id="h58-0-161" class="i">+        }
</a><a href="#h58-0-162" id="h58-0-162" class="i">+        return mediaInputStream.get().readBytes()
</a><a href="#h58-0-163" id="h58-0-163" class="i">+    }
</a><a href="#h58-0-164" id="h58-0-164" class="i">+
</a><a href="#h58-0-165" id="h58-0-165" class="i">+    private fun createNeededDirectories(file: File): File {
</a><a href="#h58-0-166" id="h58-0-166" class="i">+        val directory = file.parentFile ?: return file
</a><a href="#h58-0-167" id="h58-0-167" class="i">+        if (!directory.exists()) {
</a><a href="#h58-0-168" id="h58-0-168" class="i">+            directory.mkdirs()
</a><a href="#h58-0-169" id="h58-0-169" class="i">+        }
</a><a href="#h58-0-170" id="h58-0-170" class="i">+        return file
</a><a href="#h58-0-171" id="h58-0-171" class="i">+    }
</a><a href="#h58-0-172" id="h58-0-172" class="i">+
</a><a href="#h58-0-173" id="h58-0-173" class="i">+    private fun isFileExists(hash: Int, author: String, fileType: FileType): Boolean {
</a><a href="#h58-0-174" id="h58-0-174" class="i">+        val fileName: String = createNewFilePath(hash, author, fileType) ?: return false
</a><a href="#h58-0-175" id="h58-0-175" class="i">+        val outputFile: File =
</a><a href="#h58-0-176" id="h58-0-176" class="i">+            createNeededDirectories(File(context.config.string(ConfigProperty.SAVE_FOLDER), fileName))
</a><a href="#h58-0-177" id="h58-0-177" class="i">+        return outputFile.exists()
</a><a href="#h58-0-178" id="h58-0-178" class="i">+    }
</a><a href="#h58-0-179" id="h58-0-179" class="i">+
</a><a href="#h58-0-180" id="h58-0-180" class="i">+
</a><a href="#h58-0-181" id="h58-0-181" class="i">+    /*
</a><a href="#h58-0-182" id="h58-0-182" class="i">+     * Download the last seen media
</a><a href="#h58-0-183" id="h58-0-183" class="i">+     */
</a><a href="#h58-0-184" id="h58-0-184" class="i">+    fun downloadLastOperaMediaAsync() {
</a><a href="#h58-0-185" id="h58-0-185" class="i">+        if (lastSeenMapParams == null || lastSeenMediaInfoMap == null) return
</a><a href="#h58-0-186" id="h58-0-186" class="i">+        context.executeAsync {
</a><a href="#h58-0-187" id="h58-0-187" class="i">+            handleOperaMedia(
</a><a href="#h58-0-188" id="h58-0-188" class="i">+                lastSeenMapParams!!,
</a><a href="#h58-0-189" id="h58-0-189" class="i">+                lastSeenMediaInfoMap!!, true
</a><a href="#h58-0-190" id="h58-0-190" class="i">+            )
</a><a href="#h58-0-191" id="h58-0-191" class="i">+        }
</a><a href="#h58-0-192" id="h58-0-192" class="i">+    }
</a><a href="#h58-0-193" id="h58-0-193" class="i">+
</a><a href="#h58-0-194" id="h58-0-194" class="i">+    private fun downloadOperaMedia(mediaInfoMap: Map&lt;MediaType, MediaInfo&gt;, author: String) {
</a><a href="#h58-0-195" id="h58-0-195" class="i">+        if (mediaInfoMap.isEmpty()) return
</a><a href="#h58-0-196" id="h58-0-196" class="i">+        val originalMediaInfo = mediaInfoMap[MediaType.ORIGINAL]!!
</a><a href="#h58-0-197" id="h58-0-197" class="i">+        if (mediaInfoMap.containsKey(MediaType.OVERLAY)) {
</a><a href="#h58-0-198" id="h58-0-198" class="i">+            context.shortToast(&quot;Downloading split snap&quot;)
</a><a href="#h58-0-199" id="h58-0-199" class="i">+        }
</a><a href="#h58-0-200" id="h58-0-200" class="i">+        var mediaContent: ByteArray? = queryMediaData(originalMediaInfo)
</a><a href="#h58-0-201" id="h58-0-201" class="i">+        val hash = Arrays.hashCode(mediaContent)
</a><a href="#h58-0-202" id="h58-0-202" class="i">+        if (mediaInfoMap.containsKey(MediaType.OVERLAY)) {
</a><a href="#h58-0-203" id="h58-0-203" class="i">+            //prevent converting the same media twice
</a><a href="#h58-0-204" id="h58-0-204" class="i">+            if (isFileExists(hash, author, FileType.fromByteArray(mediaContent!!))) {
</a><a href="#h58-0-205" id="h58-0-205" class="i">+                context.shortToast(&quot;Media already exists&quot;)
</a><a href="#h58-0-206" id="h58-0-206" class="i">+                return
</a><a href="#h58-0-207" id="h58-0-207" class="i">+            }
</a><a href="#h58-0-208" id="h58-0-208" class="i">+            val overlayMediaInfo = mediaInfoMap[MediaType.OVERLAY]!!
</a><a href="#h58-0-209" id="h58-0-209" class="i">+            val overlayContent: ByteArray = queryMediaData(overlayMediaInfo)
</a><a href="#h58-0-210" id="h58-0-210" class="i">+            mediaContent = mergeOverlay(mediaContent, overlayContent, false)
</a><a href="#h58-0-211" id="h58-0-211" class="i">+        }
</a><a href="#h58-0-212" id="h58-0-212" class="i">+        val fileType = FileType.fromByteArray(mediaContent!!)
</a><a href="#h58-0-213" id="h58-0-213" class="i">+        downloadMediaContent(mediaContent, hash, author, fileType)
</a><a href="#h58-0-214" id="h58-0-214" class="i">+    }
</a><a href="#h58-0-215" id="h58-0-215" class="i">+
</a><a href="#h58-0-216" id="h58-0-216" class="i">+    private fun downloadMediaContent(
</a><a href="#h58-0-217" id="h58-0-217" class="i">+        data: ByteArray,
</a><a href="#h58-0-218" id="h58-0-218" class="i">+        hash: Int,
</a><a href="#h58-0-219" id="h58-0-219" class="i">+        messageAuthor: String,
</a><a href="#h58-0-220" id="h58-0-220" class="i">+        fileType: FileType
</a><a href="#h58-0-221" id="h58-0-221" class="i">+    ): Boolean {
</a><a href="#h58-0-222" id="h58-0-222" class="i">+        val fileName: String = createNewFilePath(hash, messageAuthor, fileType) ?: return false
</a><a href="#h58-0-223" id="h58-0-223" class="i">+        val outputFile: File = createNeededDirectories(File(context.config.string(ConfigProperty.SAVE_FOLDER), fileName))
</a><a href="#h58-0-224" id="h58-0-224" class="i">+        if (outputFile.exists()) {
</a><a href="#h58-0-225" id="h58-0-225" class="i">+            context.shortToast(&quot;Media already exists&quot;)
</a><a href="#h58-0-226" id="h58-0-226" class="i">+            return false
</a><a href="#h58-0-227" id="h58-0-227" class="i">+        }
</a><a href="#h58-0-228" id="h58-0-228" class="i">+        return downloadFile(outputFile, data)
</a><a href="#h58-0-229" id="h58-0-229" class="i">+    }
</a><a href="#h58-0-230" id="h58-0-230" class="i">+
</a><a href="#h58-0-231" id="h58-0-231" class="i">+    /**
</a><a href="#h58-0-232" id="h58-0-232" class="i">+     * Handles the media from the opera viewer
</a><a href="#h58-0-233" id="h58-0-233" class="i">+     *
</a><a href="#h58-0-234" id="h58-0-234" class="i">+     * @param paramMap      the parameters from the opera viewer
</a><a href="#h58-0-235" id="h58-0-235" class="i">+     * @param mediaInfoMap  the media info map
</a><a href="#h58-0-236" id="h58-0-236" class="i">+     * @param forceDownload if the media should be downloaded
</a><a href="#h58-0-237" id="h58-0-237" class="i">+     */
</a><a href="#h58-0-238" id="h58-0-238" class="i">+    private fun handleOperaMedia(
</a><a href="#h58-0-239" id="h58-0-239" class="i">+        paramMap: ParamMap,
</a><a href="#h58-0-240" id="h58-0-240" class="i">+        mediaInfoMap: Map&lt;MediaType, MediaInfo&gt;,
</a><a href="#h58-0-241" id="h58-0-241" class="i">+        forceDownload: Boolean
</a><a href="#h58-0-242" id="h58-0-242" class="i">+    ) {
</a><a href="#h58-0-243" id="h58-0-243" class="i">+        //messages
</a><a href="#h58-0-244" id="h58-0-244" class="i">+        if (paramMap.containsKey(&quot;MESSAGE_ID&quot;)) {
</a><a href="#h58-0-245" id="h58-0-245" class="i">+            val id = paramMap[&quot;MESSAGE_ID&quot;].toString()
</a><a href="#h58-0-246" id="h58-0-246" class="i">+            val messageId = id.substring(id.lastIndexOf(&quot;:&quot;) + 1).toLong()
</a><a href="#h58-0-247" id="h58-0-247" class="i">+            val senderId: String = context.database.getConversationMessageFromId(messageId)!!.sender_id!!
</a><a href="#h58-0-248" id="h58-0-248" class="i">+            val author = context.database.getFriendInfo(senderId)!!.usernameForSorting!!
</a><a href="#h58-0-249" id="h58-0-249" class="i">+            downloadOperaMedia(mediaInfoMap, author)
</a><a href="#h58-0-250" id="h58-0-250" class="i">+            return
</a><a href="#h58-0-251" id="h58-0-251" class="i">+        }
</a><a href="#h58-0-252" id="h58-0-252" class="i">+
</a><a href="#h58-0-253" id="h58-0-253" class="i">+        //private stories
</a><a href="#h58-0-254" id="h58-0-254" class="i">+        val playlistV2Group =
</a><a href="#h58-0-255" id="h58-0-255" class="i">+            if (paramMap.containsKey(&quot;PLAYLIST_V2_GROUP&quot;)) paramMap[&quot;PLAYLIST_V2_GROUP&quot;].toString() else null
</a><a href="#h58-0-256" id="h58-0-256" class="i">+        if (playlistV2Group != null &amp;&amp;
</a><a href="#h58-0-257" id="h58-0-257" class="i">+            playlistV2Group.contains(&quot;storyUserId=&quot;) &amp;&amp;
</a><a href="#h58-0-258" id="h58-0-258" class="i">+            (forceDownload || context.config.bool(ConfigProperty.DOWNLOAD_STORIES))
</a><a href="#h58-0-259" id="h58-0-259" class="i">+        ) {
</a><a href="#h58-0-260" id="h58-0-260" class="i">+            val storyIdStartIndex = playlistV2Group.indexOf(&quot;storyUserId=&quot;) + 12
</a><a href="#h58-0-261" id="h58-0-261" class="i">+            val storyUserId = playlistV2Group.substring(storyIdStartIndex, playlistV2Group.indexOf(&quot;,&quot;, storyIdStartIndex))
</a><a href="#h58-0-262" id="h58-0-262" class="i">+            val author = context.database.getFriendInfo(storyUserId)
</a><a href="#h58-0-263" id="h58-0-263" class="i">+            downloadOperaMedia(mediaInfoMap, author!!.usernameForSorting!!)
</a><a href="#h58-0-264" id="h58-0-264" class="i">+            return
</a><a href="#h58-0-265" id="h58-0-265" class="i">+        }
</a><a href="#h58-0-266" id="h58-0-266" class="i">+        val snapSource = paramMap[&quot;SNAP_SOURCE&quot;].toString()
</a><a href="#h58-0-267" id="h58-0-267" class="i">+
</a><a href="#h58-0-268" id="h58-0-268" class="i">+        //public stories
</a><a href="#h58-0-269" id="h58-0-269" class="i">+        if (snapSource == &quot;PUBLIC_USER&quot; &amp;&amp; (forceDownload || context.config.bool(ConfigProperty.DOWNLOAD_PUBLIC_STORIES))) {
</a><a href="#h58-0-270" id="h58-0-270" class="i">+            val userDisplayName = (if (paramMap.containsKey(&quot;USER_DISPLAY_NAME&quot;)) paramMap[&quot;USER_DISPLAY_NAME&quot;].toString() else &quot;&quot;).replace(
</a><a href="#h58-0-271" id="h58-0-271" class="i">+                    &quot;[^\\x00-\\x7F]&quot;.toRegex(),
</a><a href="#h58-0-272" id="h58-0-272" class="i">+                    &quot;&quot;)
</a><a href="#h58-0-273" id="h58-0-273" class="i">+            downloadOperaMedia(mediaInfoMap, &quot;Public-Stories/$userDisplayName&quot;)
</a><a href="#h58-0-274" id="h58-0-274" class="i">+        }
</a><a href="#h58-0-275" id="h58-0-275" class="i">+
</a><a href="#h58-0-276" id="h58-0-276" class="i">+        //spotlight
</a><a href="#h58-0-277" id="h58-0-277" class="i">+        if (snapSource == &quot;SINGLE_SNAP_STORY&quot; &amp;&amp; (forceDownload || context.config.bool(ConfigProperty.DOWNLOAD_SPOTLIGHT))) {
</a><a href="#h58-0-278" id="h58-0-278" class="i">+            downloadOperaMedia(mediaInfoMap, &quot;Spotlight&quot;)
</a><a href="#h58-0-279" id="h58-0-279" class="i">+        }
</a><a href="#h58-0-280" id="h58-0-280" class="i">+    }
</a><a href="#h58-0-281" id="h58-0-281" class="i">+
</a><a href="#h58-0-282" id="h58-0-282" class="i">+    override fun asyncOnActivityCreate() {
</a><a href="#h58-0-283" id="h58-0-283" class="i">+        val operaViewerControllerClass: Class&lt;*&gt; = context.mappings.getMappedClass(&quot;OperaPageViewController&quot;, &quot;Class&quot;)
</a><a href="#h58-0-284" id="h58-0-284" class="i">+
</a><a href="#h58-0-285" id="h58-0-285" class="i">+        val onOperaViewStateCallback: (HookAdapter) -&gt; Unit = onOperaViewStateCallback@{ param -&gt;
</a><a href="#h58-0-286" id="h58-0-286" class="i">+            val viewState = (param.thisObject() as Any).getObjectField(context.mappings.getMappedValue(&quot;OperaPageViewController&quot;, &quot;viewStateField&quot;)).toString()
</a><a href="#h58-0-287" id="h58-0-287" class="i">+            if (viewState != &quot;FULLY_DISPLAYED&quot;) {
</a><a href="#h58-0-288" id="h58-0-288" class="i">+                return@onOperaViewStateCallback
</a><a href="#h58-0-289" id="h58-0-289" class="i">+            }
</a><a href="#h58-0-290" id="h58-0-290" class="i">+            val operaLayerList = (param.thisObject() as Any).getObjectField(context.mappings.getMappedValue(&quot;OperaPageViewController&quot;, &quot;layerListField&quot;)) as ArrayList&lt;*&gt;
</a><a href="#h58-0-291" id="h58-0-291" class="i">+            val mediaParamMap: ParamMap = operaLayerList.map { Layer(it) }.first().paramMap
</a><a href="#h58-0-292" id="h58-0-292" class="i">+
</a><a href="#h58-0-293" id="h58-0-293" class="i">+            if (!mediaParamMap.containsKey(&quot;image_media_info&quot;) &amp;&amp; !mediaParamMap.containsKey(&quot;video_media_info_list&quot;))
</a><a href="#h58-0-294" id="h58-0-294" class="i">+                return@onOperaViewStateCallback
</a><a href="#h58-0-295" id="h58-0-295" class="i">+
</a><a href="#h58-0-296" id="h58-0-296" class="i">+            val mediaInfoMap = mutableMapOf&lt;MediaType, MediaInfo&gt;()
</a><a href="#h58-0-297" id="h58-0-297" class="i">+            val isVideo = mediaParamMap.containsKey(&quot;video_media_info_list&quot;)
</a><a href="#h58-0-298" id="h58-0-298" class="i">+            mediaInfoMap[MediaType.ORIGINAL] = MediaInfo(
</a><a href="#h58-0-299" id="h58-0-299" class="i">+                (if (isVideo) mediaParamMap[&quot;video_media_info_list&quot;] else mediaParamMap[&quot;image_media_info&quot;])!!
</a><a href="#h58-0-300" id="h58-0-300" class="i">+            )
</a><a href="#h58-0-301" id="h58-0-301" class="i">+            if (canMergeOverlay() &amp;&amp; mediaParamMap.containsKey(&quot;overlay_image_media_info&quot;)) {
</a><a href="#h58-0-302" id="h58-0-302" class="i">+                mediaInfoMap[MediaType.OVERLAY] =
</a><a href="#h58-0-303" id="h58-0-303" class="i">+                    MediaInfo(mediaParamMap[&quot;overlay_image_media_info&quot;]!!)
</a><a href="#h58-0-304" id="h58-0-304" class="i">+            }
</a><a href="#h58-0-305" id="h58-0-305" class="i">+            lastSeenMapParams = mediaParamMap
</a><a href="#h58-0-306" id="h58-0-306" class="i">+            lastSeenMediaInfoMap = mediaInfoMap
</a><a href="#h58-0-307" id="h58-0-307" class="i">+            if (!context.config.bool(ConfigProperty.MEDIA_DOWNLOADER_FEATURE)) return@onOperaViewStateCallback
</a><a href="#h58-0-308" id="h58-0-308" class="i">+
</a><a href="#h58-0-309" id="h58-0-309" class="i">+            context.executeAsync {
</a><a href="#h58-0-310" id="h58-0-310" class="i">+                try {
</a><a href="#h58-0-311" id="h58-0-311" class="i">+                    handleOperaMedia(mediaParamMap, mediaInfoMap, false)
</a><a href="#h58-0-312" id="h58-0-312" class="i">+                } catch (e: Throwable) {
</a><a href="#h58-0-313" id="h58-0-313" class="i">+                    Logger.xposedLog(e)
</a><a href="#h58-0-314" id="h58-0-314" class="i">+                    context.longToast(e.message!!)
</a><a href="#h58-0-315" id="h58-0-315" class="i">+                }
</a><a href="#h58-0-316" id="h58-0-316" class="i">+            }
</a><a href="#h58-0-317" id="h58-0-317" class="i">+        }
</a><a href="#h58-0-318" id="h58-0-318" class="i">+
</a><a href="#h58-0-319" id="h58-0-319" class="i">+        arrayOf(&quot;onDisplayStateChange&quot;, &quot;onDisplayStateChange2&quot;).forEach { methodName -&gt;
</a><a href="#h58-0-320" id="h58-0-320" class="i">+            Hooker.hook(
</a><a href="#h58-0-321" id="h58-0-321" class="i">+                operaViewerControllerClass,
</a><a href="#h58-0-322" id="h58-0-322" class="i">+                context.mappings.getMappedValue(&quot;OperaPageViewController&quot;, methodName),
</a><a href="#h58-0-323" id="h58-0-323" class="i">+                HookStage.AFTER, onOperaViewStateCallback
</a><a href="#h58-0-324" id="h58-0-324" class="i">+            )
</a><a href="#h58-0-325" id="h58-0-325" class="i">+        }
</a><a href="#h58-0-326" id="h58-0-326" class="i">+    }
</a><a href="#h58-0-327" id="h58-0-327" class="i">+
</a><a href="#h58-0-328" id="h58-0-328" class="i">+    /**
</a><a href="#h58-0-329" id="h58-0-329" class="i">+     * Called when a message is focused in chat
</a><a href="#h58-0-330" id="h58-0-330" class="i">+     */
</a><a href="#h58-0-331" id="h58-0-331" class="i">+    //TODO: use snapchat classes instead of database (when content is deleted)
</a><a href="#h58-0-332" id="h58-0-332" class="i">+    fun onMessageActionMenu(isPreviewMode: Boolean) {
</a><a href="#h58-0-333" id="h58-0-333" class="i">+        //check if the message was focused in a conversation
</a><a href="#h58-0-334" id="h58-0-334" class="i">+        val messaging = context.feature(Messaging::class)
</a><a href="#h58-0-335" id="h58-0-335" class="i">+        if (messaging.lastOpenedConversationUUID == null) return
</a><a href="#h58-0-336" id="h58-0-336" class="i">+        val message = context.database.getConversationMessageFromId(messaging.lastFocusedMessageId) ?: return
</a><a href="#h58-0-337" id="h58-0-337" class="i">+
</a><a href="#h58-0-338" id="h58-0-338" class="i">+        //get the message author
</a><a href="#h58-0-339" id="h58-0-339" class="i">+        val messageAuthor: String = context.database.getFriendInfo(message.sender_id!!)!!.usernameForSorting!!
</a><a href="#h58-0-340" id="h58-0-340" class="i">+
</a><a href="#h58-0-341" id="h58-0-341" class="i">+        //check if the messageId
</a><a href="#h58-0-342" id="h58-0-342" class="i">+        val contentType: ContentType = ContentType.fromId(message.content_type)
</a><a href="#h58-0-343" id="h58-0-343" class="i">+        if (context.feature(MessageLogger::class).isMessageRemoved(message.client_message_id.toLong())) {
</a><a href="#h58-0-344" id="h58-0-344" class="i">+            context.shortToast(&quot;Preview/Download are not yet available for deleted messages&quot;)
</a><a href="#h58-0-345" id="h58-0-345" class="i">+            return
</a><a href="#h58-0-346" id="h58-0-346" class="i">+        }
</a><a href="#h58-0-347" id="h58-0-347" class="i">+        if (contentType != ContentType.NOTE &amp;&amp;
</a><a href="#h58-0-348" id="h58-0-348" class="i">+            contentType != ContentType.SNAP &amp;&amp;
</a><a href="#h58-0-349" id="h58-0-349" class="i">+            contentType != ContentType.EXTERNAL_MEDIA) {
</a><a href="#h58-0-350" id="h58-0-350" class="i">+            context.shortToast(&quot;Unsupported content type $contentType&quot;)
</a><a href="#h58-0-351" id="h58-0-351" class="i">+            return
</a><a href="#h58-0-352" id="h58-0-352" class="i">+        }
</a><a href="#h58-0-353" id="h58-0-353" class="i">+        val messageReader = ProtoReader(message.message_content!!)
</a><a href="#h58-0-354" id="h58-0-354" class="i">+        val urlKey: String = messageReader.getString(*ARROYO_URL_KEY_PROTO_PATH)!!
</a><a href="#h58-0-355" id="h58-0-355" class="i">+
</a><a href="#h58-0-356" id="h58-0-356" class="i">+        //download the message content
</a><a href="#h58-0-357" id="h58-0-357" class="i">+        try {
</a><a href="#h58-0-358" id="h58-0-358" class="i">+            context.shortToast(&quot;Retriving message media&quot;)
</a><a href="#h58-0-359" id="h58-0-359" class="i">+            var inputStream: InputStream = CdnDownloader.downloadWithDefaultEndpoints(urlKey) ?: return
</a><a href="#h58-0-360" id="h58-0-360" class="i">+            inputStream = EncryptionUtils.decryptInputStreamFromArroyo(
</a><a href="#h58-0-361" id="h58-0-361" class="i">+                inputStream,
</a><a href="#h58-0-362" id="h58-0-362" class="i">+                contentType,
</a><a href="#h58-0-363" id="h58-0-363" class="i">+                messageReader
</a><a href="#h58-0-364" id="h58-0-364" class="i">+            )
</a><a href="#h58-0-365" id="h58-0-365" class="i">+
</a><a href="#h58-0-366" id="h58-0-366" class="i">+            var mediaData: ByteArray = inputStream.readBytes()
</a><a href="#h58-0-367" id="h58-0-367" class="i">+            var fileType = FileType.fromByteArray(mediaData)
</a><a href="#h58-0-368" id="h58-0-368" class="i">+            val isZipFile = fileType == FileType.ZIP
</a><a href="#h58-0-369" id="h58-0-369" class="i">+
</a><a href="#h58-0-370" id="h58-0-370" class="i">+            //videos with overlay are packed in a zip file
</a><a href="#h58-0-371" id="h58-0-371" class="i">+            //there are 2 files in the zip file, the video (webm) and the overlay (png)
</a><a href="#h58-0-372" id="h58-0-372" class="i">+            if (isZipFile) {
</a><a href="#h58-0-373" id="h58-0-373" class="i">+                var videoData: ByteArray? = null
</a><a href="#h58-0-374" id="h58-0-374" class="i">+                var overlayData: ByteArray? = null
</a><a href="#h58-0-375" id="h58-0-375" class="i">+                val zipInputStream = ZipInputStream(ByteArrayInputStream(mediaData))
</a><a href="#h58-0-376" id="h58-0-376" class="i">+                while (zipInputStream.nextEntry != null) {
</a><a href="#h58-0-377" id="h58-0-377" class="i">+                    val zipEntryData: ByteArray = zipInputStream.readBytes()
</a><a href="#h58-0-378" id="h58-0-378" class="i">+                    val entryFileType = FileType.fromByteArray(zipEntryData)
</a><a href="#h58-0-379" id="h58-0-379" class="i">+                    if (entryFileType.isVideo) {
</a><a href="#h58-0-380" id="h58-0-380" class="i">+                        videoData = zipEntryData
</a><a href="#h58-0-381" id="h58-0-381" class="i">+                    } else if (entryFileType.isImage) {
</a><a href="#h58-0-382" id="h58-0-382" class="i">+                        overlayData = zipEntryData
</a><a href="#h58-0-383" id="h58-0-383" class="i">+                    }
</a><a href="#h58-0-384" id="h58-0-384" class="i">+                }
</a><a href="#h58-0-385" id="h58-0-385" class="i">+                if (videoData == null || overlayData == null) {
</a><a href="#h58-0-386" id="h58-0-386" class="i">+                    Logger.xposedLog(&quot;Invalid data in zip file&quot;)
</a><a href="#h58-0-387" id="h58-0-387" class="i">+                    return
</a><a href="#h58-0-388" id="h58-0-388" class="i">+                }
</a><a href="#h58-0-389" id="h58-0-389" class="i">+                val mergedVideo = mergeOverlay(videoData, overlayData, isPreviewMode)
</a><a href="#h58-0-390" id="h58-0-390" class="i">+                val videoFileType = FileType.fromByteArray(videoData)
</a><a href="#h58-0-391" id="h58-0-391" class="i">+                if (!isPreviewMode) {
</a><a href="#h58-0-392" id="h58-0-392" class="i">+                    downloadMediaContent(
</a><a href="#h58-0-393" id="h58-0-393" class="i">+                        mergedVideo!!,
</a><a href="#h58-0-394" id="h58-0-394" class="i">+                        Arrays.hashCode(videoData),
</a><a href="#h58-0-395" id="h58-0-395" class="i">+                        messageAuthor,
</a><a href="#h58-0-396" id="h58-0-396" class="i">+                        videoFileType
</a><a href="#h58-0-397" id="h58-0-397" class="i">+                    )
</a><a href="#h58-0-398" id="h58-0-398" class="i">+                    return
</a><a href="#h58-0-399" id="h58-0-399" class="i">+                }
</a><a href="#h58-0-400" id="h58-0-400" class="i">+                mediaData = mergedVideo!!
</a><a href="#h58-0-401" id="h58-0-401" class="i">+                fileType = videoFileType
</a><a href="#h58-0-402" id="h58-0-402" class="i">+            }
</a><a href="#h58-0-403" id="h58-0-403" class="i">+            if (isPreviewMode) {
</a><a href="#h58-0-404" id="h58-0-404" class="i">+                runCatching {
</a><a href="#h58-0-405" id="h58-0-405" class="i">+                    val bitmap: Bitmap = PreviewUtils.createPreview(mediaData, fileType.isVideo)!!
</a><a href="#h58-0-406" id="h58-0-406" class="i">+                    val builder = AlertDialog.Builder(context.mainActivity)
</a><a href="#h58-0-407" id="h58-0-407" class="i">+                    builder.setTitle(&quot;Preview&quot;)
</a><a href="#h58-0-408" id="h58-0-408" class="i">+                    val imageView = ImageView(builder.context)
</a><a href="#h58-0-409" id="h58-0-409" class="i">+                    imageView.setImageBitmap(bitmap)
</a><a href="#h58-0-410" id="h58-0-410" class="i">+                    builder.setView(imageView)
</a><a href="#h58-0-411" id="h58-0-411" class="i">+                    builder.setPositiveButton(
</a><a href="#h58-0-412" id="h58-0-412" class="i">+                        &quot;Close&quot;
</a><a href="#h58-0-413" id="h58-0-413" class="i">+                    ) { dialog: DialogInterface, _: Int -&gt; dialog.dismiss() }
</a><a href="#h58-0-414" id="h58-0-414" class="i">+                    context.runOnUiThread { builder.show() }
</a><a href="#h58-0-415" id="h58-0-415" class="i">+                }.onFailure {
</a><a href="#h58-0-416" id="h58-0-416" class="i">+                    context.shortToast(&quot;Failed to create preview: ${it.message}&quot;)
</a><a href="#h58-0-417" id="h58-0-417" class="i">+                    xposedLog(it)
</a><a href="#h58-0-418" id="h58-0-418" class="i">+                }
</a><a href="#h58-0-419" id="h58-0-419" class="i">+                return
</a><a href="#h58-0-420" id="h58-0-420" class="i">+            }
</a><a href="#h58-0-421" id="h58-0-421" class="i">+            downloadMediaContent(mediaData, mediaData.contentHashCode(), messageAuthor, fileType)
</a><a href="#h58-0-422" id="h58-0-422" class="i">+        } catch (e: FileNotFoundException) {
</a><a href="#h58-0-423" id="h58-0-423" class="i">+            context.shortToast(&quot;Unable to get $urlKey from cdn list. Check the logs for more info&quot;)
</a><a href="#h58-0-424" id="h58-0-424" class="i">+        } catch (e: Throwable) {
</a><a href="#h58-0-425" id="h58-0-425" class="i">+            context.shortToast(&quot;Failed to download &quot; + e.message)
</a><a href="#h58-0-426" id="h58-0-426" class="i">+            xposedLog(e)
</a><a href="#h58-0-427" id="h58-0-427" class="i">+        }
</a><a href="#h58-0-428" id="h58-0-428" class="i">+    }
</a><a href="#h58-0-429" id="h58-0-429" class="i">+}</a><a href="#h58-0-430" id="h58-0-430" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h59" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/extras/AutoSave.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/extras/AutoSave.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/extras/AutoSave.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/extras/AutoSave.kt</a></b>
<a href="#h59-0" id="h59-0" class="h">@@ -0,0 +1,133 @@
</a><a href="#h59-0-0" id="h59-0-0" class="i">+package me.rhunk.snapenhance.features.impl.extras
</a><a href="#h59-0-1" id="h59-0-1" class="i">+
</a><a href="#h59-0-2" id="h59-0-2" class="i">+import me.rhunk.snapenhance.Logger
</a><a href="#h59-0-3" id="h59-0-3" class="i">+import me.rhunk.snapenhance.config.ConfigProperty
</a><a href="#h59-0-4" id="h59-0-4" class="i">+import me.rhunk.snapenhance.data.ContentType
</a><a href="#h59-0-5" id="h59-0-5" class="i">+import me.rhunk.snapenhance.data.wrapper.impl.Message
</a><a href="#h59-0-6" id="h59-0-6" class="i">+import me.rhunk.snapenhance.data.wrapper.impl.SnapUUID
</a><a href="#h59-0-7" id="h59-0-7" class="i">+import me.rhunk.snapenhance.features.Feature
</a><a href="#h59-0-8" id="h59-0-8" class="i">+import me.rhunk.snapenhance.features.FeatureLoadParams
</a><a href="#h59-0-9" id="h59-0-9" class="i">+import me.rhunk.snapenhance.features.impl.Messaging
</a><a href="#h59-0-10" id="h59-0-10" class="i">+import me.rhunk.snapenhance.features.impl.spy.MessageLogger
</a><a href="#h59-0-11" id="h59-0-11" class="i">+import me.rhunk.snapenhance.features.impl.spy.StealthMode
</a><a href="#h59-0-12" id="h59-0-12" class="i">+import me.rhunk.snapenhance.hook.HookStage
</a><a href="#h59-0-13" id="h59-0-13" class="i">+import me.rhunk.snapenhance.hook.Hooker
</a><a href="#h59-0-14" id="h59-0-14" class="i">+import me.rhunk.snapenhance.util.CallbackBuilder
</a><a href="#h59-0-15" id="h59-0-15" class="i">+import me.rhunk.snapenhance.util.getObjectField
</a><a href="#h59-0-16" id="h59-0-16" class="i">+import java.util.concurrent.Executors
</a><a href="#h59-0-17" id="h59-0-17" class="i">+
</a><a href="#h59-0-18" id="h59-0-18" class="i">+class AutoSave : Feature(&quot;Auto Save&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_ASYNC) {
</a><a href="#h59-0-19" id="h59-0-19" class="i">+    private val asyncSaveExecutorService = Executors.newSingleThreadExecutor()
</a><a href="#h59-0-20" id="h59-0-20" class="i">+
</a><a href="#h59-0-21" id="h59-0-21" class="i">+    private val messageLogger by lazy { context.feature(MessageLogger::class) }
</a><a href="#h59-0-22" id="h59-0-22" class="i">+    private val messaging by lazy { context.feature(Messaging::class) }
</a><a href="#h59-0-23" id="h59-0-23" class="i">+
</a><a href="#h59-0-24" id="h59-0-24" class="i">+    private val myUserId by lazy { context.database.getMyUserId() }
</a><a href="#h59-0-25" id="h59-0-25" class="i">+
</a><a href="#h59-0-26" id="h59-0-26" class="i">+    private val fetchConversationWithMessagesCallbackClass by lazy {  context.mappings.getMappedClass(&quot;callbacks&quot;, &quot;FetchConversationWithMessagesCallback&quot;) }
</a><a href="#h59-0-27" id="h59-0-27" class="i">+    private val callbackClass by lazy {  context.mappings.getMappedClass(&quot;callbacks&quot;, &quot;Callback&quot;) }
</a><a href="#h59-0-28" id="h59-0-28" class="i">+
</a><a href="#h59-0-29" id="h59-0-29" class="i">+    private val updateMessageMethod by lazy { context.classCache.conversationManager.methods.first { it.name == &quot;updateMessage&quot; } }
</a><a href="#h59-0-30" id="h59-0-30" class="i">+    private val fetchConversationWithMessagesPaginatedMethod by lazy {
</a><a href="#h59-0-31" id="h59-0-31" class="i">+        context.classCache.conversationManager.methods.first { it.name == &quot;fetchConversationWithMessagesPaginated&quot; }
</a><a href="#h59-0-32" id="h59-0-32" class="i">+    }
</a><a href="#h59-0-33" id="h59-0-33" class="i">+
</a><a href="#h59-0-34" id="h59-0-34" class="i">+    private fun saveMessage(conversationId: SnapUUID, message: Message) {
</a><a href="#h59-0-35" id="h59-0-35" class="i">+        val messageId = message.messageDescriptor.messageId
</a><a href="#h59-0-36" id="h59-0-36" class="i">+        if (messageLogger.isMessageRemoved(messageId)) return
</a><a href="#h59-0-37" id="h59-0-37" class="i">+
</a><a href="#h59-0-38" id="h59-0-38" class="i">+        val callback = CallbackBuilder(callbackClass)
</a><a href="#h59-0-39" id="h59-0-39" class="i">+            .override(&quot;onError&quot;) {
</a><a href="#h59-0-40" id="h59-0-40" class="i">+                Logger.xposedLog(&quot;Error saving message $messageId&quot;)
</a><a href="#h59-0-41" id="h59-0-41" class="i">+            }.build()
</a><a href="#h59-0-42" id="h59-0-42" class="i">+
</a><a href="#h59-0-43" id="h59-0-43" class="i">+        runCatching {
</a><a href="#h59-0-44" id="h59-0-44" class="i">+            updateMessageMethod.invoke(
</a><a href="#h59-0-45" id="h59-0-45" class="i">+                context.feature(Messaging::class).conversationManager,
</a><a href="#h59-0-46" id="h59-0-46" class="i">+                conversationId.instance(),
</a><a href="#h59-0-47" id="h59-0-47" class="i">+                messageId,
</a><a href="#h59-0-48" id="h59-0-48" class="i">+                context.classCache.messageUpdateEnum.enumConstants.first { it.toString() == &quot;SAVE&quot; },
</a><a href="#h59-0-49" id="h59-0-49" class="i">+                callback
</a><a href="#h59-0-50" id="h59-0-50" class="i">+            )
</a><a href="#h59-0-51" id="h59-0-51" class="i">+        }.onFailure {
</a><a href="#h59-0-52" id="h59-0-52" class="i">+            Logger.xposedLog(&quot;Error saving message $messageId&quot;, it)
</a><a href="#h59-0-53" id="h59-0-53" class="i">+        }
</a><a href="#h59-0-54" id="h59-0-54" class="i">+
</a><a href="#h59-0-55" id="h59-0-55" class="i">+        //delay between saves
</a><a href="#h59-0-56" id="h59-0-56" class="i">+        Thread.sleep(100L)
</a><a href="#h59-0-57" id="h59-0-57" class="i">+    }
</a><a href="#h59-0-58" id="h59-0-58" class="i">+
</a><a href="#h59-0-59" id="h59-0-59" class="i">+    private fun canSaveMessage(message: Message): Boolean {
</a><a href="#h59-0-60" id="h59-0-60" class="i">+        if (message.messageMetadata.savedBy.any { uuid -&gt; uuid.toString() == myUserId }) return false
</a><a href="#h59-0-61" id="h59-0-61" class="i">+        //only save chats
</a><a href="#h59-0-62" id="h59-0-62" class="i">+        with(message.messageContent.contentType) {
</a><a href="#h59-0-63" id="h59-0-63" class="i">+            if (this != ContentType.CHAT &amp;&amp;
</a><a href="#h59-0-64" id="h59-0-64" class="i">+                this != ContentType.NOTE &amp;&amp;
</a><a href="#h59-0-65" id="h59-0-65" class="i">+                this != ContentType.STICKER &amp;&amp;
</a><a href="#h59-0-66" id="h59-0-66" class="i">+                this != ContentType.EXTERNAL_MEDIA) return false
</a><a href="#h59-0-67" id="h59-0-67" class="i">+        }
</a><a href="#h59-0-68" id="h59-0-68" class="i">+        return true
</a><a href="#h59-0-69" id="h59-0-69" class="i">+    }
</a><a href="#h59-0-70" id="h59-0-70" class="i">+
</a><a href="#h59-0-71" id="h59-0-71" class="i">+    private fun canSave(): Boolean {
</a><a href="#h59-0-72" id="h59-0-72" class="i">+        with(context.feature(Messaging::class)) {
</a><a href="#h59-0-73" id="h59-0-73" class="i">+            if (lastOpenedConversationUUID == null || context.feature(StealthMode::class).isStealth(lastOpenedConversationUUID.toString())) return@canSave false
</a><a href="#h59-0-74" id="h59-0-74" class="i">+        }
</a><a href="#h59-0-75" id="h59-0-75" class="i">+        return true
</a><a href="#h59-0-76" id="h59-0-76" class="i">+    }
</a><a href="#h59-0-77" id="h59-0-77" class="i">+
</a><a href="#h59-0-78" id="h59-0-78" class="i">+    override fun asyncOnActivityCreate() {
</a><a href="#h59-0-79" id="h59-0-79" class="i">+        //called when enter in a conversation (or when a message is sent)
</a><a href="#h59-0-80" id="h59-0-80" class="i">+        Hooker.hook(
</a><a href="#h59-0-81" id="h59-0-81" class="i">+            context.mappings.getMappedClass(&quot;callbacks&quot;, &quot;FetchConversationWithMessagesCallback&quot;),
</a><a href="#h59-0-82" id="h59-0-82" class="i">+            &quot;onFetchConversationWithMessagesComplete&quot;,
</a><a href="#h59-0-83" id="h59-0-83" class="i">+            HookStage.BEFORE,
</a><a href="#h59-0-84" id="h59-0-84" class="i">+            { context.config.bool(ConfigProperty.AUTO_SAVE) &amp;&amp; canSave()}
</a><a href="#h59-0-85" id="h59-0-85" class="i">+        ) { param -&gt;
</a><a href="#h59-0-86" id="h59-0-86" class="i">+            val conversationId = SnapUUID(param.arg&lt;Any&gt;(0).getObjectField(&quot;mConversationId&quot;))
</a><a href="#h59-0-87" id="h59-0-87" class="i">+            val messages = param.arg&lt;List&lt;Any&gt;&gt;(1).map { Message(it) }
</a><a href="#h59-0-88" id="h59-0-88" class="i">+            messages.forEach {
</a><a href="#h59-0-89" id="h59-0-89" class="i">+                if (!canSaveMessage(it)) return@forEach
</a><a href="#h59-0-90" id="h59-0-90" class="i">+                asyncSaveExecutorService.submit {
</a><a href="#h59-0-91" id="h59-0-91" class="i">+                    saveMessage(conversationId, it)
</a><a href="#h59-0-92" id="h59-0-92" class="i">+                }
</a><a href="#h59-0-93" id="h59-0-93" class="i">+            }
</a><a href="#h59-0-94" id="h59-0-94" class="i">+        }
</a><a href="#h59-0-95" id="h59-0-95" class="i">+
</a><a href="#h59-0-96" id="h59-0-96" class="i">+        //called when a message is received
</a><a href="#h59-0-97" id="h59-0-97" class="i">+        Hooker.hook(
</a><a href="#h59-0-98" id="h59-0-98" class="i">+            context.mappings.getMappedClass(&quot;callbacks&quot;, &quot;FetchMessageCallback&quot;),
</a><a href="#h59-0-99" id="h59-0-99" class="i">+            &quot;onFetchMessageComplete&quot;,
</a><a href="#h59-0-100" id="h59-0-100" class="i">+            HookStage.BEFORE,
</a><a href="#h59-0-101" id="h59-0-101" class="i">+            { context.config.bool(ConfigProperty.AUTO_SAVE) &amp;&amp; canSave()}
</a><a href="#h59-0-102" id="h59-0-102" class="i">+        ) { param -&gt;
</a><a href="#h59-0-103" id="h59-0-103" class="i">+            val message = Message(param.arg(0))
</a><a href="#h59-0-104" id="h59-0-104" class="i">+            if (!canSaveMessage(message)) return@hook
</a><a href="#h59-0-105" id="h59-0-105" class="i">+            val conversationId = message.messageDescriptor.conversationId
</a><a href="#h59-0-106" id="h59-0-106" class="i">+
</a><a href="#h59-0-107" id="h59-0-107" class="i">+            asyncSaveExecutorService.submit {
</a><a href="#h59-0-108" id="h59-0-108" class="i">+                saveMessage(conversationId, message)
</a><a href="#h59-0-109" id="h59-0-109" class="i">+            }
</a><a href="#h59-0-110" id="h59-0-110" class="i">+        }
</a><a href="#h59-0-111" id="h59-0-111" class="i">+
</a><a href="#h59-0-112" id="h59-0-112" class="i">+        Hooker.hook(
</a><a href="#h59-0-113" id="h59-0-113" class="i">+            context.mappings.getMappedClass(&quot;callbacks&quot;, &quot;SendMessageCallback&quot;),
</a><a href="#h59-0-114" id="h59-0-114" class="i">+            &quot;onSuccess&quot;,
</a><a href="#h59-0-115" id="h59-0-115" class="i">+            HookStage.BEFORE,
</a><a href="#h59-0-116" id="h59-0-116" class="i">+            { context.config.bool(ConfigProperty.AUTO_SAVE) &amp;&amp; canSave()}
</a><a href="#h59-0-117" id="h59-0-117" class="i">+        ) {
</a><a href="#h59-0-118" id="h59-0-118" class="i">+            val callback = CallbackBuilder(fetchConversationWithMessagesCallbackClass).build()
</a><a href="#h59-0-119" id="h59-0-119" class="i">+            runCatching {
</a><a href="#h59-0-120" id="h59-0-120" class="i">+                fetchConversationWithMessagesPaginatedMethod.invoke(
</a><a href="#h59-0-121" id="h59-0-121" class="i">+                    messaging.conversationManager, messaging.lastOpenedConversationUUID!!.instance(),
</a><a href="#h59-0-122" id="h59-0-122" class="i">+                    Long.MAX_VALUE,
</a><a href="#h59-0-123" id="h59-0-123" class="i">+                    3,
</a><a href="#h59-0-124" id="h59-0-124" class="i">+                    callback
</a><a href="#h59-0-125" id="h59-0-125" class="i">+                )
</a><a href="#h59-0-126" id="h59-0-126" class="i">+            }.onFailure {
</a><a href="#h59-0-127" id="h59-0-127" class="i">+                Logger.xposedLog(&quot;failed to save message&quot;, it)
</a><a href="#h59-0-128" id="h59-0-128" class="i">+            }
</a><a href="#h59-0-129" id="h59-0-129" class="i">+        }
</a><a href="#h59-0-130" id="h59-0-130" class="i">+
</a><a href="#h59-0-131" id="h59-0-131" class="i">+    }
</a><a href="#h59-0-132" id="h59-0-132" class="i">+}</a><a href="#h59-0-133" id="h59-0-133" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h60" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/extras/Notifications.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/extras/Notifications.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/extras/Notifications.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/extras/Notifications.kt</a></b>
<a href="#h60-0" id="h60-0" class="h">@@ -0,0 +1,183 @@
</a><a href="#h60-0-0" id="h60-0-0" class="i">+package me.rhunk.snapenhance.features.impl.extras
</a><a href="#h60-0-1" id="h60-0-1" class="i">+
</a><a href="#h60-0-2" id="h60-0-2" class="i">+import android.app.Notification
</a><a href="#h60-0-3" id="h60-0-3" class="i">+import android.app.NotificationManager
</a><a href="#h60-0-4" id="h60-0-4" class="i">+import android.content.Context
</a><a href="#h60-0-5" id="h60-0-5" class="i">+import android.graphics.Bitmap
</a><a href="#h60-0-6" id="h60-0-6" class="i">+import android.os.Bundle
</a><a href="#h60-0-7" id="h60-0-7" class="i">+import android.os.UserHandle
</a><a href="#h60-0-8" id="h60-0-8" class="i">+import de.robv.android.xposed.XposedBridge
</a><a href="#h60-0-9" id="h60-0-9" class="i">+import de.robv.android.xposed.XposedHelpers
</a><a href="#h60-0-10" id="h60-0-10" class="i">+import me.rhunk.snapenhance.Constants
</a><a href="#h60-0-11" id="h60-0-11" class="i">+import me.rhunk.snapenhance.Logger
</a><a href="#h60-0-12" id="h60-0-12" class="i">+import me.rhunk.snapenhance.config.ConfigProperty
</a><a href="#h60-0-13" id="h60-0-13" class="i">+import me.rhunk.snapenhance.data.ContentType
</a><a href="#h60-0-14" id="h60-0-14" class="i">+import me.rhunk.snapenhance.data.MediaReferenceType
</a><a href="#h60-0-15" id="h60-0-15" class="i">+import me.rhunk.snapenhance.data.wrapper.impl.Message
</a><a href="#h60-0-16" id="h60-0-16" class="i">+import me.rhunk.snapenhance.data.wrapper.impl.SnapUUID
</a><a href="#h60-0-17" id="h60-0-17" class="i">+import me.rhunk.snapenhance.features.Feature
</a><a href="#h60-0-18" id="h60-0-18" class="i">+import me.rhunk.snapenhance.features.FeatureLoadParams
</a><a href="#h60-0-19" id="h60-0-19" class="i">+import me.rhunk.snapenhance.features.impl.Messaging
</a><a href="#h60-0-20" id="h60-0-20" class="i">+import me.rhunk.snapenhance.hook.HookStage
</a><a href="#h60-0-21" id="h60-0-21" class="i">+import me.rhunk.snapenhance.hook.Hooker
</a><a href="#h60-0-22" id="h60-0-22" class="i">+import me.rhunk.snapenhance.util.CallbackBuilder
</a><a href="#h60-0-23" id="h60-0-23" class="i">+import me.rhunk.snapenhance.util.EncryptionUtils
</a><a href="#h60-0-24" id="h60-0-24" class="i">+import me.rhunk.snapenhance.util.PreviewUtils
</a><a href="#h60-0-25" id="h60-0-25" class="i">+import me.rhunk.snapenhance.util.download.CdnDownloader
</a><a href="#h60-0-26" id="h60-0-26" class="i">+import me.rhunk.snapenhance.util.protobuf.ProtoReader
</a><a href="#h60-0-27" id="h60-0-27" class="i">+
</a><a href="#h60-0-28" id="h60-0-28" class="i">+class Notifications : Feature(&quot;Notifications&quot;, loadParams = FeatureLoadParams.INIT_SYNC) {
</a><a href="#h60-0-29" id="h60-0-29" class="i">+    private val notificationDataQueue = mutableMapOf&lt;Long, NotificationData&gt;()
</a><a href="#h60-0-30" id="h60-0-30" class="i">+    private val cachedNotifications = mutableMapOf&lt;String, MutableList&lt;String&gt;&gt;()
</a><a href="#h60-0-31" id="h60-0-31" class="i">+
</a><a href="#h60-0-32" id="h60-0-32" class="i">+    private val notifyAsUserMethod by lazy {
</a><a href="#h60-0-33" id="h60-0-33" class="i">+        XposedHelpers.findMethodExact(
</a><a href="#h60-0-34" id="h60-0-34" class="i">+            NotificationManager::class.java, &quot;notifyAsUser&quot;,
</a><a href="#h60-0-35" id="h60-0-35" class="i">+            String::class.java,
</a><a href="#h60-0-36" id="h60-0-36" class="i">+            Int::class.javaPrimitiveType,
</a><a href="#h60-0-37" id="h60-0-37" class="i">+            Notification::class.java,
</a><a href="#h60-0-38" id="h60-0-38" class="i">+            UserHandle::class.java
</a><a href="#h60-0-39" id="h60-0-39" class="i">+        )
</a><a href="#h60-0-40" id="h60-0-40" class="i">+    }
</a><a href="#h60-0-41" id="h60-0-41" class="i">+
</a><a href="#h60-0-42" id="h60-0-42" class="i">+    private val fetchConversationWithMessagesMethod by lazy {
</a><a href="#h60-0-43" id="h60-0-43" class="i">+        context.classCache.conversationManager.methods.first { it.name == &quot;fetchConversationWithMessages&quot;}
</a><a href="#h60-0-44" id="h60-0-44" class="i">+    }
</a><a href="#h60-0-45" id="h60-0-45" class="i">+
</a><a href="#h60-0-46" id="h60-0-46" class="i">+    private val notificationManager by lazy {
</a><a href="#h60-0-47" id="h60-0-47" class="i">+        context.androidContext.getSystemService(Context.NOTIFICATION_SERVICE) as NotificationManager
</a><a href="#h60-0-48" id="h60-0-48" class="i">+    }
</a><a href="#h60-0-49" id="h60-0-49" class="i">+
</a><a href="#h60-0-50" id="h60-0-50" class="i">+    private fun setNotificationText(notification: NotificationData, text: String) {
</a><a href="#h60-0-51" id="h60-0-51" class="i">+        with(notification.notification.extras) {
</a><a href="#h60-0-52" id="h60-0-52" class="i">+            putString(&quot;android.text&quot;, text)
</a><a href="#h60-0-53" id="h60-0-53" class="i">+            putString(&quot;android.bigText&quot;, text)
</a><a href="#h60-0-54" id="h60-0-54" class="i">+        }
</a><a href="#h60-0-55" id="h60-0-55" class="i">+    }
</a><a href="#h60-0-56" id="h60-0-56" class="i">+
</a><a href="#h60-0-57" id="h60-0-57" class="i">+    private fun computeNotificationText(conversationId: String): String {
</a><a href="#h60-0-58" id="h60-0-58" class="i">+        val messageBuilder = StringBuilder()
</a><a href="#h60-0-59" id="h60-0-59" class="i">+        cachedNotifications.computeIfAbsent(conversationId) { mutableListOf() }.forEach {
</a><a href="#h60-0-60" id="h60-0-60" class="i">+            if (messageBuilder.isNotEmpty()) messageBuilder.append(&quot;\n&quot;)
</a><a href="#h60-0-61" id="h60-0-61" class="i">+            messageBuilder.append(it)
</a><a href="#h60-0-62" id="h60-0-62" class="i">+        }
</a><a href="#h60-0-63" id="h60-0-63" class="i">+        return messageBuilder.toString()
</a><a href="#h60-0-64" id="h60-0-64" class="i">+    }
</a><a href="#h60-0-65" id="h60-0-65" class="i">+
</a><a href="#h60-0-66" id="h60-0-66" class="i">+    private fun fetchMessagesResult(conversationId: String, messages: List&lt;Message&gt;) {
</a><a href="#h60-0-67" id="h60-0-67" class="i">+        val sendNotificationData = { it: NotificationData -&gt;
</a><a href="#h60-0-68" id="h60-0-68" class="i">+            XposedBridge.invokeOriginalMethod(notifyAsUserMethod, notificationManager, arrayOf(
</a><a href="#h60-0-69" id="h60-0-69" class="i">+                it.tag, it.id, it.notification, it.userHandle
</a><a href="#h60-0-70" id="h60-0-70" class="i">+            ))
</a><a href="#h60-0-71" id="h60-0-71" class="i">+        }
</a><a href="#h60-0-72" id="h60-0-72" class="i">+
</a><a href="#h60-0-73" id="h60-0-73" class="i">+        notificationDataQueue.entries.onEach { (messageId, notificationData) -&gt;
</a><a href="#h60-0-74" id="h60-0-74" class="i">+            val snapMessage = messages.firstOrNull { message -&gt; message.orderKey == messageId } ?: return
</a><a href="#h60-0-75" id="h60-0-75" class="i">+            val senderUsername = context.database.getFriendInfo(snapMessage.senderId.toString())?.displayName ?: throw Throwable(&quot;Cant find senderId of message $snapMessage&quot;)
</a><a href="#h60-0-76" id="h60-0-76" class="i">+
</a><a href="#h60-0-77" id="h60-0-77" class="i">+            val contentType = snapMessage.messageContent.contentType
</a><a href="#h60-0-78" id="h60-0-78" class="i">+            val contentData = snapMessage.messageContent.content
</a><a href="#h60-0-79" id="h60-0-79" class="i">+
</a><a href="#h60-0-80" id="h60-0-80" class="i">+            val formatUsername: (String) -&gt; String = { &quot;$senderUsername: $it&quot; }
</a><a href="#h60-0-81" id="h60-0-81" class="i">+            val notificationCache = cachedNotifications.let { it.computeIfAbsent(conversationId) { mutableListOf() } }
</a><a href="#h60-0-82" id="h60-0-82" class="i">+            val appendNotifications: () -&gt; Unit = { setNotificationText(notificationData, computeNotificationText(conversationId))}
</a><a href="#h60-0-83" id="h60-0-83" class="i">+
</a><a href="#h60-0-84" id="h60-0-84" class="i">+            when (contentType) {
</a><a href="#h60-0-85" id="h60-0-85" class="i">+                ContentType.NOTE -&gt; {
</a><a href="#h60-0-86" id="h60-0-86" class="i">+                    notificationCache.add(formatUsername(&quot;sent audio note&quot;))
</a><a href="#h60-0-87" id="h60-0-87" class="i">+                    appendNotifications()
</a><a href="#h60-0-88" id="h60-0-88" class="i">+                }
</a><a href="#h60-0-89" id="h60-0-89" class="i">+                ContentType.CHAT -&gt; {
</a><a href="#h60-0-90" id="h60-0-90" class="i">+                    ProtoReader(contentData).getString(2, 1)?.trim()?.let {
</a><a href="#h60-0-91" id="h60-0-91" class="i">+                        notificationCache.add(formatUsername(it))
</a><a href="#h60-0-92" id="h60-0-92" class="i">+                    }
</a><a href="#h60-0-93" id="h60-0-93" class="i">+                    appendNotifications()
</a><a href="#h60-0-94" id="h60-0-94" class="i">+                }
</a><a href="#h60-0-95" id="h60-0-95" class="i">+                ContentType.SNAP -&gt; {
</a><a href="#h60-0-96" id="h60-0-96" class="i">+                    //serialize the message content into a json object
</a><a href="#h60-0-97" id="h60-0-97" class="i">+                    val serializedMessageContent = context.gson.toJsonTree(snapMessage.messageContent.instance()).asJsonObject
</a><a href="#h60-0-98" id="h60-0-98" class="i">+                    val mediaReferences = serializedMessageContent[&quot;mRemoteMediaReferences&quot;]
</a><a href="#h60-0-99" id="h60-0-99" class="i">+                        .asJsonArray.map { it.asJsonObject[&quot;mMediaReferences&quot;].asJsonArray }
</a><a href="#h60-0-100" id="h60-0-100" class="i">+                        .flatten()
</a><a href="#h60-0-101" id="h60-0-101" class="i">+
</a><a href="#h60-0-102" id="h60-0-102" class="i">+                    mediaReferences.forEach { media -&gt;
</a><a href="#h60-0-103" id="h60-0-103" class="i">+                        val mediaContent = media.asJsonObject[&quot;mContentObject&quot;].asJsonArray.map { it.asByte }.toByteArray()
</a><a href="#h60-0-104" id="h60-0-104" class="i">+                        val mediaType = MediaReferenceType.valueOf(media.asJsonObject[&quot;mMediaType&quot;].asString)
</a><a href="#h60-0-105" id="h60-0-105" class="i">+                        val urlKey = ProtoReader(mediaContent).getString(2, 2) ?: return@forEach
</a><a href="#h60-0-106" id="h60-0-106" class="i">+                        runCatching {
</a><a href="#h60-0-107" id="h60-0-107" class="i">+                            //download the media
</a><a href="#h60-0-108" id="h60-0-108" class="i">+                            var mediaInputStream = CdnDownloader.downloadWithDefaultEndpoints(urlKey)!!
</a><a href="#h60-0-109" id="h60-0-109" class="i">+                            val mediaInfo = ProtoReader(contentData).readPath(*Constants.MESSAGE_SNAP_ENCRYPTION_PROTO_PATH) ?: return@runCatching
</a><a href="#h60-0-110" id="h60-0-110" class="i">+                            //decrypt if necessary
</a><a href="#h60-0-111" id="h60-0-111" class="i">+                            if (mediaInfo.exists(Constants.ARROYO_ENCRYPTION_PROTO_INDEX)) {
</a><a href="#h60-0-112" id="h60-0-112" class="i">+                                mediaInputStream = EncryptionUtils.decryptInputStream(mediaInputStream, false, mediaInfo, Constants.ARROYO_ENCRYPTION_PROTO_INDEX)
</a><a href="#h60-0-113" id="h60-0-113" class="i">+                            }
</a><a href="#h60-0-114" id="h60-0-114" class="i">+
</a><a href="#h60-0-115" id="h60-0-115" class="i">+                            val mediaByteArray = mediaInputStream.readBytes()
</a><a href="#h60-0-116" id="h60-0-116" class="i">+                            val bitmapPreview = PreviewUtils.createPreview(mediaByteArray, mediaType == MediaReferenceType.VIDEO)!!
</a><a href="#h60-0-117" id="h60-0-117" class="i">+
</a><a href="#h60-0-118" id="h60-0-118" class="i">+                            val notificationBuilder = XposedHelpers.newInstance(
</a><a href="#h60-0-119" id="h60-0-119" class="i">+                                Notification.Builder::class.java,
</a><a href="#h60-0-120" id="h60-0-120" class="i">+                                context.androidContext,
</a><a href="#h60-0-121" id="h60-0-121" class="i">+                                notificationData.notification
</a><a href="#h60-0-122" id="h60-0-122" class="i">+                            ) as Notification.Builder
</a><a href="#h60-0-123" id="h60-0-123" class="i">+                            notificationBuilder.setLargeIcon(bitmapPreview)
</a><a href="#h60-0-124" id="h60-0-124" class="i">+                            notificationBuilder.style = Notification.BigPictureStyle().bigPicture(bitmapPreview).bigLargeIcon(null as Bitmap?)
</a><a href="#h60-0-125" id="h60-0-125" class="i">+
</a><a href="#h60-0-126" id="h60-0-126" class="i">+                            sendNotificationData(notificationData.copy(id = System.nanoTime().toInt(), notification = notificationBuilder.build()))
</a><a href="#h60-0-127" id="h60-0-127" class="i">+                            return@onEach
</a><a href="#h60-0-128" id="h60-0-128" class="i">+                        }.onFailure {
</a><a href="#h60-0-129" id="h60-0-129" class="i">+                            Logger.error(&quot;Failed to send preview notification&quot;, it)
</a><a href="#h60-0-130" id="h60-0-130" class="i">+                        }
</a><a href="#h60-0-131" id="h60-0-131" class="i">+                    }
</a><a href="#h60-0-132" id="h60-0-132" class="i">+                }
</a><a href="#h60-0-133" id="h60-0-133" class="i">+                else -&gt; {
</a><a href="#h60-0-134" id="h60-0-134" class="i">+                    notificationCache.add(formatUsername(&quot;sent $contentType&quot;))
</a><a href="#h60-0-135" id="h60-0-135" class="i">+                }
</a><a href="#h60-0-136" id="h60-0-136" class="i">+            }
</a><a href="#h60-0-137" id="h60-0-137" class="i">+
</a><a href="#h60-0-138" id="h60-0-138" class="i">+            sendNotificationData(notificationData)
</a><a href="#h60-0-139" id="h60-0-139" class="i">+        }.clear()
</a><a href="#h60-0-140" id="h60-0-140" class="i">+    }
</a><a href="#h60-0-141" id="h60-0-141" class="i">+
</a><a href="#h60-0-142" id="h60-0-142" class="i">+    override fun init() {
</a><a href="#h60-0-143" id="h60-0-143" class="i">+        val fetchConversationWithMessagesCallback = context.mappings.getMappedClass(&quot;callbacks&quot;, &quot;FetchConversationWithMessagesCallback&quot;)
</a><a href="#h60-0-144" id="h60-0-144" class="i">+
</a><a href="#h60-0-145" id="h60-0-145" class="i">+        Hooker.hook(notifyAsUserMethod, HookStage.BEFORE, { context.config.bool(ConfigProperty.SHOW_MESSAGE_CONTENT) }) {
</a><a href="#h60-0-146" id="h60-0-146" class="i">+            val notificationData = NotificationData(it.argNullable(0), it.arg(1), it.arg(2), it.arg(3))
</a><a href="#h60-0-147" id="h60-0-147" class="i">+
</a><a href="#h60-0-148" id="h60-0-148" class="i">+            if (!notificationData.notification.extras.containsKey(&quot;system_notification_extras&quot;)) {
</a><a href="#h60-0-149" id="h60-0-149" class="i">+                return@hook
</a><a href="#h60-0-150" id="h60-0-150" class="i">+            }
</a><a href="#h60-0-151" id="h60-0-151" class="i">+            val extras: Bundle = notificationData.notification.extras.getBundle(&quot;system_notification_extras&quot;)!!
</a><a href="#h60-0-152" id="h60-0-152" class="i">+
</a><a href="#h60-0-153" id="h60-0-153" class="i">+            val messageId = extras.getString(&quot;message_id&quot;)!!
</a><a href="#h60-0-154" id="h60-0-154" class="i">+            val notificationType = extras.getString(&quot;notification_type&quot;)!!
</a><a href="#h60-0-155" id="h60-0-155" class="i">+            val conversationId = extras.getString(&quot;conversation_id&quot;)!!
</a><a href="#h60-0-156" id="h60-0-156" class="i">+
</a><a href="#h60-0-157" id="h60-0-157" class="i">+            if (!notificationType.endsWith(&quot;CHAT&quot;) &amp;&amp; !notificationType.endsWith(&quot;SNAP&quot;)) return@hook
</a><a href="#h60-0-158" id="h60-0-158" class="i">+
</a><a href="#h60-0-159" id="h60-0-159" class="i">+            val conversationManager: Any = context.feature(Messaging::class).conversationManager
</a><a href="#h60-0-160" id="h60-0-160" class="i">+            notificationDataQueue[messageId.toLong()] =  notificationData
</a><a href="#h60-0-161" id="h60-0-161" class="i">+
</a><a href="#h60-0-162" id="h60-0-162" class="i">+            val callback = CallbackBuilder(fetchConversationWithMessagesCallback)
</a><a href="#h60-0-163" id="h60-0-163" class="i">+                .override(&quot;onFetchConversationWithMessagesComplete&quot;) { param -&gt;
</a><a href="#h60-0-164" id="h60-0-164" class="i">+                    val messageList = (param.arg(1) as List&lt;Any&gt;).map { msg -&gt; Message(msg) }
</a><a href="#h60-0-165" id="h60-0-165" class="i">+                    fetchMessagesResult(conversationId, messageList)
</a><a href="#h60-0-166" id="h60-0-166" class="i">+                }
</a><a href="#h60-0-167" id="h60-0-167" class="i">+                .override(&quot;onError&quot;) { param -&gt;
</a><a href="#h60-0-168" id="h60-0-168" class="i">+                    Logger.xposedLog(&quot;Failed to fetch message ${param.arg(0) as Any}&quot;)
</a><a href="#h60-0-169" id="h60-0-169" class="i">+                }.build()
</a><a href="#h60-0-170" id="h60-0-170" class="i">+
</a><a href="#h60-0-171" id="h60-0-171" class="i">+            fetchConversationWithMessagesMethod.invoke(conversationManager, SnapUUID.fromString(conversationId).instance(), callback)
</a><a href="#h60-0-172" id="h60-0-172" class="i">+            it.setResult(null)
</a><a href="#h60-0-173" id="h60-0-173" class="i">+        }
</a><a href="#h60-0-174" id="h60-0-174" class="i">+    }
</a><a href="#h60-0-175" id="h60-0-175" class="i">+
</a><a href="#h60-0-176" id="h60-0-176" class="i">+    data class NotificationData(
</a><a href="#h60-0-177" id="h60-0-177" class="i">+        val tag: String?,
</a><a href="#h60-0-178" id="h60-0-178" class="i">+        val id: Int,
</a><a href="#h60-0-179" id="h60-0-179" class="i">+        var notification: Notification,
</a><a href="#h60-0-180" id="h60-0-180" class="i">+        val userHandle: UserHandle
</a><a href="#h60-0-181" id="h60-0-181" class="i">+    )
</a><a href="#h60-0-182" id="h60-0-182" class="i">+}</a><a href="#h60-0-183" id="h60-0-183" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h61" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/extras/SnapchatPlus.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/extras/SnapchatPlus.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/extras/SnapchatPlus.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/extras/SnapchatPlus.kt</a></b>
<a href="#h61-0" id="h61-0" class="h">@@ -0,0 +1,28 @@
</a><a href="#h61-0-0" id="h61-0-0" class="i">+package me.rhunk.snapenhance.features.impl.extras
</a><a href="#h61-0-1" id="h61-0-1" class="i">+
</a><a href="#h61-0-2" id="h61-0-2" class="i">+import me.rhunk.snapenhance.config.ConfigProperty
</a><a href="#h61-0-3" id="h61-0-3" class="i">+import me.rhunk.snapenhance.features.Feature
</a><a href="#h61-0-4" id="h61-0-4" class="i">+import me.rhunk.snapenhance.features.FeatureLoadParams
</a><a href="#h61-0-5" id="h61-0-5" class="i">+import me.rhunk.snapenhance.hook.HookStage
</a><a href="#h61-0-6" id="h61-0-6" class="i">+import me.rhunk.snapenhance.hook.Hooker
</a><a href="#h61-0-7" id="h61-0-7" class="i">+
</a><a href="#h61-0-8" id="h61-0-8" class="i">+class SnapchatPlus: Feature(&quot;SnapchatPlus&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_ASYNC) {
</a><a href="#h61-0-9" id="h61-0-9" class="i">+    override fun asyncOnActivityCreate() {
</a><a href="#h61-0-10" id="h61-0-10" class="i">+        if (!context.config.bool(ConfigProperty.SNAPCHAT_PLUS)) return
</a><a href="#h61-0-11" id="h61-0-11" class="i">+
</a><a href="#h61-0-12" id="h61-0-12" class="i">+        Hooker.hookConstructor(context.mappings.getMappedClass(&quot;SubscriptionInfoClass&quot;), HookStage.BEFORE) { param -&gt;
</a><a href="#h61-0-13" id="h61-0-13" class="i">+            //check if the user is already premium
</a><a href="#h61-0-14" id="h61-0-14" class="i">+            if (param.arg(0) as Int == 2) {
</a><a href="#h61-0-15" id="h61-0-15" class="i">+                return@hookConstructor
</a><a href="#h61-0-16" id="h61-0-16" class="i">+            }
</a><a href="#h61-0-17" id="h61-0-17" class="i">+            //subscription info tier
</a><a href="#h61-0-18" id="h61-0-18" class="i">+            param.setArg(0, 2)
</a><a href="#h61-0-19" id="h61-0-19" class="i">+            //subscription status
</a><a href="#h61-0-20" id="h61-0-20" class="i">+            param.setArg(1, 2)
</a><a href="#h61-0-21" id="h61-0-21" class="i">+            //subscription time
</a><a href="#h61-0-22" id="h61-0-22" class="i">+            param.setArg(2, System.currentTimeMillis() - 7776000000L)
</a><a href="#h61-0-23" id="h61-0-23" class="i">+            //expiration time
</a><a href="#h61-0-24" id="h61-0-24" class="i">+            param.setArg(3, System.currentTimeMillis() + 15552000000L)
</a><a href="#h61-0-25" id="h61-0-25" class="i">+        }
</a><a href="#h61-0-26" id="h61-0-26" class="i">+    }
</a><a href="#h61-0-27" id="h61-0-27" class="i">+}</a><a href="#h61-0-28" id="h61-0-28" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h62" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/privacy/DisableMetrics.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/privacy/DisableMetrics.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/privacy/DisableMetrics.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/privacy/DisableMetrics.kt</a></b>
<a href="#h62-0" id="h62-0" class="h">@@ -0,0 +1,45 @@
</a><a href="#h62-0-0" id="h62-0-0" class="i">+package me.rhunk.snapenhance.features.impl.privacy
</a><a href="#h62-0-1" id="h62-0-1" class="i">+
</a><a href="#h62-0-2" id="h62-0-2" class="i">+import de.robv.android.xposed.XposedHelpers
</a><a href="#h62-0-3" id="h62-0-3" class="i">+import me.rhunk.snapenhance.Logger.debug
</a><a href="#h62-0-4" id="h62-0-4" class="i">+import me.rhunk.snapenhance.config.ConfigProperty
</a><a href="#h62-0-5" id="h62-0-5" class="i">+import me.rhunk.snapenhance.features.Feature
</a><a href="#h62-0-6" id="h62-0-6" class="i">+import me.rhunk.snapenhance.features.FeatureLoadParams
</a><a href="#h62-0-7" id="h62-0-7" class="i">+import me.rhunk.snapenhance.hook.HookAdapter
</a><a href="#h62-0-8" id="h62-0-8" class="i">+import me.rhunk.snapenhance.hook.HookStage
</a><a href="#h62-0-9" id="h62-0-9" class="i">+import me.rhunk.snapenhance.hook.Hooker
</a><a href="#h62-0-10" id="h62-0-10" class="i">+import java.nio.charset.StandardCharsets
</a><a href="#h62-0-11" id="h62-0-11" class="i">+import java.util.*
</a><a href="#h62-0-12" id="h62-0-12" class="i">+
</a><a href="#h62-0-13" id="h62-0-13" class="i">+class DisableMetrics : Feature(&quot;DisableMetrics&quot;, loadParams = FeatureLoadParams.INIT_SYNC) {
</a><a href="#h62-0-14" id="h62-0-14" class="i">+    override fun init() {
</a><a href="#h62-0-15" id="h62-0-15" class="i">+        val disableMetricsFilter: (HookAdapter) -&gt; Boolean = {
</a><a href="#h62-0-16" id="h62-0-16" class="i">+            context.config.bool(ConfigProperty.DISABLE_METRICS)
</a><a href="#h62-0-17" id="h62-0-17" class="i">+        }
</a><a href="#h62-0-18" id="h62-0-18" class="i">+
</a><a href="#h62-0-19" id="h62-0-19" class="i">+        Hooker.hook(context.classCache.unifiedGrpcService, &quot;unaryCall&quot;, HookStage.BEFORE, disableMetricsFilter) { param -&gt;
</a><a href="#h62-0-20" id="h62-0-20" class="i">+            val url: String = param.arg(0)
</a><a href="#h62-0-21" id="h62-0-21" class="i">+            if (url.endsWith(&quot;snapchat.valis.Valis/SendClientUpdate&quot;) ||
</a><a href="#h62-0-22" id="h62-0-22" class="i">+                url.endsWith(&quot;targetingQuery&quot;)
</a><a href="#h62-0-23" id="h62-0-23" class="i">+            ) {
</a><a href="#h62-0-24" id="h62-0-24" class="i">+                param.setResult(null)
</a><a href="#h62-0-25" id="h62-0-25" class="i">+            }
</a><a href="#h62-0-26" id="h62-0-26" class="i">+        }
</a><a href="#h62-0-27" id="h62-0-27" class="i">+
</a><a href="#h62-0-28" id="h62-0-28" class="i">+        Hooker.hook(context.classCache.networkApi, &quot;submit&quot;, HookStage.BEFORE, disableMetricsFilter) { param -&gt;
</a><a href="#h62-0-29" id="h62-0-29" class="i">+            val httpRequest: Any = param.arg(0)
</a><a href="#h62-0-30" id="h62-0-30" class="i">+            val url = XposedHelpers.getObjectField(httpRequest, &quot;mUrl&quot;).toString()
</a><a href="#h62-0-31" id="h62-0-31" class="i">+            if (url.contains(&quot;resolve?co=&quot;)) {
</a><a href="#h62-0-32" id="h62-0-32" class="i">+                val index = url.indexOf(&quot;co=&quot;)
</a><a href="#h62-0-33" id="h62-0-33" class="i">+                val end = url.lastIndexOf(&quot;&amp;&quot;)
</a><a href="#h62-0-34" id="h62-0-34" class="i">+                val co = url.substring(index + 3, end)
</a><a href="#h62-0-35" id="h62-0-35" class="i">+                val decoded = Base64.getDecoder().decode(co.toByteArray(StandardCharsets.UTF_8))
</a><a href="#h62-0-36" id="h62-0-36" class="i">+                debug(&quot;decoded : &quot; + decoded.toString(Charsets.UTF_8))
</a><a href="#h62-0-37" id="h62-0-37" class="i">+                debug(&quot;content: $co&quot;)
</a><a href="#h62-0-38" id="h62-0-38" class="i">+            }
</a><a href="#h62-0-39" id="h62-0-39" class="i">+            if (url.contains(&quot;app-analytics&quot;) || url.endsWith(&quot;v1/metrics&quot;)) {
</a><a href="#h62-0-40" id="h62-0-40" class="i">+                param.setResult(null)
</a><a href="#h62-0-41" id="h62-0-41" class="i">+            }
</a><a href="#h62-0-42" id="h62-0-42" class="i">+        }
</a><a href="#h62-0-43" id="h62-0-43" class="i">+    }
</a><a href="#h62-0-44" id="h62-0-44" class="i">+}</a><a href="#h62-0-45" id="h62-0-45" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h63" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/privacy/PreventScreenshotDetections.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/privacy/PreventScreenshotDetections.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/privacy/PreventScreenshotDetections.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/privacy/PreventScreenshotDetections.kt</a></b>
<a href="#h63-0" id="h63-0" class="h">@@ -0,0 +1,16 @@
</a><a href="#h63-0-0" id="h63-0-0" class="i">+package me.rhunk.snapenhance.features.impl.privacy
</a><a href="#h63-0-1" id="h63-0-1" class="i">+
</a><a href="#h63-0-2" id="h63-0-2" class="i">+import android.database.ContentObserver
</a><a href="#h63-0-3" id="h63-0-3" class="i">+import me.rhunk.snapenhance.config.ConfigProperty
</a><a href="#h63-0-4" id="h63-0-4" class="i">+import me.rhunk.snapenhance.features.Feature
</a><a href="#h63-0-5" id="h63-0-5" class="i">+import me.rhunk.snapenhance.features.FeatureLoadParams
</a><a href="#h63-0-6" id="h63-0-6" class="i">+import me.rhunk.snapenhance.hook.HookStage
</a><a href="#h63-0-7" id="h63-0-7" class="i">+import me.rhunk.snapenhance.hook.Hooker
</a><a href="#h63-0-8" id="h63-0-8" class="i">+
</a><a href="#h63-0-9" id="h63-0-9" class="i">+class PreventScreenshotDetections : Feature(&quot;Prevent Screenshot Detections&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_ASYNC) {
</a><a href="#h63-0-10" id="h63-0-10" class="i">+    override fun asyncOnActivityCreate() {
</a><a href="#h63-0-11" id="h63-0-11" class="i">+        Hooker.hook(ContentObserver::class.java,&quot;dispatchChange&quot;, HookStage.BEFORE, { context.config.bool(ConfigProperty.PREVENT_SCREENSHOTS) }) {
</a><a href="#h63-0-12" id="h63-0-12" class="i">+            it.setResult(null)
</a><a href="#h63-0-13" id="h63-0-13" class="i">+        }
</a><a href="#h63-0-14" id="h63-0-14" class="i">+    }
</a><a href="#h63-0-15" id="h63-0-15" class="i">+}</a><a href="#h63-0-16" id="h63-0-16" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h64" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/spy/AnonymousStoryViewing.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/spy/AnonymousStoryViewing.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/spy/AnonymousStoryViewing.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/spy/AnonymousStoryViewing.kt</a></b>
<a href="#h64-0" id="h64-0" class="h">@@ -0,0 +1,20 @@
</a><a href="#h64-0-0" id="h64-0-0" class="i">+package me.rhunk.snapenhance.features.impl.spy
</a><a href="#h64-0-1" id="h64-0-1" class="i">+
</a><a href="#h64-0-2" id="h64-0-2" class="i">+import me.rhunk.snapenhance.config.ConfigProperty
</a><a href="#h64-0-3" id="h64-0-3" class="i">+import me.rhunk.snapenhance.features.Feature
</a><a href="#h64-0-4" id="h64-0-4" class="i">+import me.rhunk.snapenhance.features.FeatureLoadParams
</a><a href="#h64-0-5" id="h64-0-5" class="i">+import me.rhunk.snapenhance.hook.HookStage
</a><a href="#h64-0-6" id="h64-0-6" class="i">+import me.rhunk.snapenhance.hook.Hooker
</a><a href="#h64-0-7" id="h64-0-7" class="i">+import me.rhunk.snapenhance.util.getObjectField
</a><a href="#h64-0-8" id="h64-0-8" class="i">+
</a><a href="#h64-0-9" id="h64-0-9" class="i">+class AnonymousStoryViewing : Feature(&quot;Anonymous Story Viewing&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_ASYNC) {
</a><a href="#h64-0-10" id="h64-0-10" class="i">+    override fun asyncOnActivityCreate() {
</a><a href="#h64-0-11" id="h64-0-11" class="i">+        Hooker.hook(context.classCache.networkApi,&quot;submit&quot;, HookStage.BEFORE, { context.config.bool(ConfigProperty.ANONYMOUS_STORY_VIEW) }) {
</a><a href="#h64-0-12" id="h64-0-12" class="i">+            val httpRequest: Any = it.arg(0)
</a><a href="#h64-0-13" id="h64-0-13" class="i">+            val url = httpRequest.getObjectField(&quot;mUrl&quot;) as String
</a><a href="#h64-0-14" id="h64-0-14" class="i">+            if (url.endsWith(&quot;readreceipt-indexer/batchuploadreadreceipts&quot;) || url.endsWith(&quot;v2/batch_cta&quot;)) {
</a><a href="#h64-0-15" id="h64-0-15" class="i">+                it.setResult(null)
</a><a href="#h64-0-16" id="h64-0-16" class="i">+            }
</a><a href="#h64-0-17" id="h64-0-17" class="i">+        }
</a><a href="#h64-0-18" id="h64-0-18" class="i">+    }
</a><a href="#h64-0-19" id="h64-0-19" class="i">+}
</a><b>diff --git a/<a id="h65" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/spy/MessageLogger.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/spy/MessageLogger.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/spy/MessageLogger.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/spy/MessageLogger.kt</a></b>
<a href="#h65-0" id="h65-0" class="h">@@ -0,0 +1,64 @@
</a><a href="#h65-0-0" id="h65-0-0" class="i">+package me.rhunk.snapenhance.features.impl.spy
</a><a href="#h65-0-1" id="h65-0-1" class="i">+
</a><a href="#h65-0-2" id="h65-0-2" class="i">+import com.google.gson.JsonParser
</a><a href="#h65-0-3" id="h65-0-3" class="i">+import me.rhunk.snapenhance.config.ConfigProperty
</a><a href="#h65-0-4" id="h65-0-4" class="i">+import me.rhunk.snapenhance.data.ContentType
</a><a href="#h65-0-5" id="h65-0-5" class="i">+import me.rhunk.snapenhance.data.MessageState
</a><a href="#h65-0-6" id="h65-0-6" class="i">+import me.rhunk.snapenhance.features.Feature
</a><a href="#h65-0-7" id="h65-0-7" class="i">+import me.rhunk.snapenhance.features.FeatureLoadParams
</a><a href="#h65-0-8" id="h65-0-8" class="i">+import me.rhunk.snapenhance.hook.HookStage
</a><a href="#h65-0-9" id="h65-0-9" class="i">+import me.rhunk.snapenhance.hook.Hooker
</a><a href="#h65-0-10" id="h65-0-10" class="i">+import me.rhunk.snapenhance.util.getObjectField
</a><a href="#h65-0-11" id="h65-0-11" class="i">+
</a><a href="#h65-0-12" id="h65-0-12" class="i">+class MessageLogger : Feature(&quot;MessageLogger&quot;, loadParams = FeatureLoadParams.INIT_SYNC) {
</a><a href="#h65-0-13" id="h65-0-13" class="i">+    private val messageCache = mutableMapOf&lt;Long, String&gt;()
</a><a href="#h65-0-14" id="h65-0-14" class="i">+    private val removedMessages = linkedSetOf&lt;Long&gt;()
</a><a href="#h65-0-15" id="h65-0-15" class="i">+
</a><a href="#h65-0-16" id="h65-0-16" class="i">+    fun isMessageRemoved(messageId: Long) = removedMessages.contains(messageId)
</a><a href="#h65-0-17" id="h65-0-17" class="i">+
</a><a href="#h65-0-18" id="h65-0-18" class="i">+    override fun init() {
</a><a href="#h65-0-19" id="h65-0-19" class="i">+        Hooker.hookConstructor(context.classCache.message, HookStage.AFTER, {
</a><a href="#h65-0-20" id="h65-0-20" class="i">+            context.config.bool(ConfigProperty.MESSAGE_LOGGER)
</a><a href="#h65-0-21" id="h65-0-21" class="i">+        }) {
</a><a href="#h65-0-22" id="h65-0-22" class="i">+            val message = it.thisObject&lt;Any&gt;()
</a><a href="#h65-0-23" id="h65-0-23" class="i">+            val messageId = message.getObjectField(&quot;mDescriptor&quot;).getObjectField(&quot;mMessageId&quot;) as Long
</a><a href="#h65-0-24" id="h65-0-24" class="i">+            val contentType = ContentType.valueOf(message.getObjectField(&quot;mMessageContent&quot;).getObjectField(&quot;mContentType&quot;).toString())
</a><a href="#h65-0-25" id="h65-0-25" class="i">+            val messageState = MessageState.valueOf(message.getObjectField(&quot;mState&quot;).toString())
</a><a href="#h65-0-26" id="h65-0-26" class="i">+
</a><a href="#h65-0-27" id="h65-0-27" class="i">+            if (messageState != MessageState.COMMITTED) return@hookConstructor
</a><a href="#h65-0-28" id="h65-0-28" class="i">+
</a><a href="#h65-0-29" id="h65-0-29" class="i">+            if (contentType == ContentType.STATUS) {
</a><a href="#h65-0-30" id="h65-0-30" class="i">+                //query the deleted message
</a><a href="#h65-0-31" id="h65-0-31" class="i">+                val deletedMessage: String = if (messageCache.containsKey(messageId)) messageCache[messageId] else {
</a><a href="#h65-0-32" id="h65-0-32" class="i">+                    context.bridgeClient.getMessageLoggerMessage(messageId)?.toString(Charsets.UTF_8)
</a><a href="#h65-0-33" id="h65-0-33" class="i">+                } ?: return@hookConstructor
</a><a href="#h65-0-34" id="h65-0-34" class="i">+
</a><a href="#h65-0-35" id="h65-0-35" class="i">+                val messageJsonObject = JsonParser.parseString(deletedMessage).asJsonObject
</a><a href="#h65-0-36" id="h65-0-36" class="i">+
</a><a href="#h65-0-37" id="h65-0-37" class="i">+                //if the message is a snap make it playable
</a><a href="#h65-0-38" id="h65-0-38" class="i">+                if (messageJsonObject[&quot;mMessageContent&quot;].asJsonObject[&quot;mContentType&quot;].asString == &quot;SNAP&quot;) {
</a><a href="#h65-0-39" id="h65-0-39" class="i">+                    messageJsonObject[&quot;mMetadata&quot;].asJsonObject.addProperty(&quot;mPlayableSnapState&quot;, &quot;PLAYABLE&quot;)
</a><a href="#h65-0-40" id="h65-0-40" class="i">+                }
</a><a href="#h65-0-41" id="h65-0-41" class="i">+
</a><a href="#h65-0-42" id="h65-0-42" class="i">+                //serialize all properties of messageJsonObject and put in the message object
</a><a href="#h65-0-43" id="h65-0-43" class="i">+                message.javaClass.declaredFields.forEach { field -&gt;
</a><a href="#h65-0-44" id="h65-0-44" class="i">+                    field.isAccessible = true
</a><a href="#h65-0-45" id="h65-0-45" class="i">+                    val fieldName = field.name
</a><a href="#h65-0-46" id="h65-0-46" class="i">+                    val fieldValue = messageJsonObject[fieldName]
</a><a href="#h65-0-47" id="h65-0-47" class="i">+                    if (fieldValue != null) {
</a><a href="#h65-0-48" id="h65-0-48" class="i">+                        field.set(message, context.gson.fromJson(fieldValue, field.type))
</a><a href="#h65-0-49" id="h65-0-49" class="i">+                    }
</a><a href="#h65-0-50" id="h65-0-50" class="i">+                }
</a><a href="#h65-0-51" id="h65-0-51" class="i">+
</a><a href="#h65-0-52" id="h65-0-52" class="i">+                removedMessages.add(messageId)
</a><a href="#h65-0-53" id="h65-0-53" class="i">+                return@hookConstructor
</a><a href="#h65-0-54" id="h65-0-54" class="i">+            }
</a><a href="#h65-0-55" id="h65-0-55" class="i">+
</a><a href="#h65-0-56" id="h65-0-56" class="i">+            if (!messageCache.containsKey(messageId)) {
</a><a href="#h65-0-57" id="h65-0-57" class="i">+                val serializedMessage = context.gson.toJson(message)
</a><a href="#h65-0-58" id="h65-0-58" class="i">+                messageCache[messageId] = serializedMessage
</a><a href="#h65-0-59" id="h65-0-59" class="i">+                context.bridgeClient.addMessageLoggerMessage(messageId, serializedMessage.toByteArray(Charsets.UTF_8))
</a><a href="#h65-0-60" id="h65-0-60" class="i">+            }
</a><a href="#h65-0-61" id="h65-0-61" class="i">+        }
</a><a href="#h65-0-62" id="h65-0-62" class="i">+    }
</a><a href="#h65-0-63" id="h65-0-63" class="i">+}</a><a href="#h65-0-64" id="h65-0-64" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h66" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/spy/PreventReadReceipts.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/spy/PreventReadReceipts.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/spy/PreventReadReceipts.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/spy/PreventReadReceipts.kt</a></b>
<a href="#h66-0" id="h66-0" class="h">@@ -0,0 +1,28 @@
</a><a href="#h66-0-0" id="h66-0-0" class="i">+package me.rhunk.snapenhance.features.impl.spy
</a><a href="#h66-0-1" id="h66-0-1" class="i">+
</a><a href="#h66-0-2" id="h66-0-2" class="i">+import me.rhunk.snapenhance.config.ConfigProperty
</a><a href="#h66-0-3" id="h66-0-3" class="i">+import me.rhunk.snapenhance.data.wrapper.impl.SnapUUID
</a><a href="#h66-0-4" id="h66-0-4" class="i">+import me.rhunk.snapenhance.features.Feature
</a><a href="#h66-0-5" id="h66-0-5" class="i">+import me.rhunk.snapenhance.features.FeatureLoadParams
</a><a href="#h66-0-6" id="h66-0-6" class="i">+import me.rhunk.snapenhance.hook.HookStage
</a><a href="#h66-0-7" id="h66-0-7" class="i">+import me.rhunk.snapenhance.hook.Hooker
</a><a href="#h66-0-8" id="h66-0-8" class="i">+
</a><a href="#h66-0-9" id="h66-0-9" class="i">+class PreventReadReceipts : Feature(&quot;PreventReadReceipts&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_SYNC) {
</a><a href="#h66-0-10" id="h66-0-10" class="i">+    override fun onActivityCreate() {
</a><a href="#h66-0-11" id="h66-0-11" class="i">+        val isConversationInStealthMode: (SnapUUID) -&gt; Boolean = hook@{
</a><a href="#h66-0-12" id="h66-0-12" class="i">+            if (context.config.bool(ConfigProperty.PREVENT_READ_RECEIPTS)) return@hook true
</a><a href="#h66-0-13" id="h66-0-13" class="i">+            context.feature(StealthMode::class).isStealth(it.toString())
</a><a href="#h66-0-14" id="h66-0-14" class="i">+        }
</a><a href="#h66-0-15" id="h66-0-15" class="i">+
</a><a href="#h66-0-16" id="h66-0-16" class="i">+        arrayOf(&quot;mediaMessagesDisplayed&quot;, &quot;displayedMessages&quot;).forEach { methodName: String -&gt;
</a><a href="#h66-0-17" id="h66-0-17" class="i">+            Hooker.hook(context.classCache.conversationManager, methodName, HookStage.BEFORE, { isConversationInStealthMode(SnapUUID(it.arg(0))) }) {
</a><a href="#h66-0-18" id="h66-0-18" class="i">+                it.setResult(null)
</a><a href="#h66-0-19" id="h66-0-19" class="i">+            }
</a><a href="#h66-0-20" id="h66-0-20" class="i">+        }
</a><a href="#h66-0-21" id="h66-0-21" class="i">+        Hooker.hook(context.classCache.snapManager, &quot;onSnapInteraction&quot;, HookStage.BEFORE) {
</a><a href="#h66-0-22" id="h66-0-22" class="i">+            if (isConversationInStealthMode(SnapUUID(it.arg(1) as Any))) {
</a><a href="#h66-0-23" id="h66-0-23" class="i">+                it.setResult(null)
</a><a href="#h66-0-24" id="h66-0-24" class="i">+            }
</a><a href="#h66-0-25" id="h66-0-25" class="i">+        }
</a><a href="#h66-0-26" id="h66-0-26" class="i">+    }
</a><a href="#h66-0-27" id="h66-0-27" class="i">+}
</a><b>diff --git a/<a id="h67" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/spy/PreventStatusNotifications.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/spy/PreventStatusNotifications.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/spy/PreventStatusNotifications.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/spy/PreventStatusNotifications.kt</a></b>
<a href="#h67-0" id="h67-0" class="h">@@ -0,0 +1,28 @@
</a><a href="#h67-0-0" id="h67-0-0" class="i">+package me.rhunk.snapenhance.features.impl.spy
</a><a href="#h67-0-1" id="h67-0-1" class="i">+
</a><a href="#h67-0-2" id="h67-0-2" class="i">+import me.rhunk.snapenhance.config.ConfigProperty
</a><a href="#h67-0-3" id="h67-0-3" class="i">+import me.rhunk.snapenhance.data.ContentType
</a><a href="#h67-0-4" id="h67-0-4" class="i">+import me.rhunk.snapenhance.features.Feature
</a><a href="#h67-0-5" id="h67-0-5" class="i">+import me.rhunk.snapenhance.features.FeatureLoadParams
</a><a href="#h67-0-6" id="h67-0-6" class="i">+import me.rhunk.snapenhance.hook.HookStage
</a><a href="#h67-0-7" id="h67-0-7" class="i">+import me.rhunk.snapenhance.hook.Hooker
</a><a href="#h67-0-8" id="h67-0-8" class="i">+import me.rhunk.snapenhance.util.getObjectField
</a><a href="#h67-0-9" id="h67-0-9" class="i">+
</a><a href="#h67-0-10" id="h67-0-10" class="i">+
</a><a href="#h67-0-11" id="h67-0-11" class="i">+class PreventStatusNotifications : Feature(&quot;PreventStatusNotifications&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_ASYNC) {
</a><a href="#h67-0-12" id="h67-0-12" class="i">+    override fun asyncOnActivityCreate() {
</a><a href="#h67-0-13" id="h67-0-13" class="i">+        Hooker.hook(
</a><a href="#h67-0-14" id="h67-0-14" class="i">+            context.classCache.conversationManager,
</a><a href="#h67-0-15" id="h67-0-15" class="i">+            &quot;sendMessageWithContent&quot;,
</a><a href="#h67-0-16" id="h67-0-16" class="i">+            HookStage.BEFORE,
</a><a href="#h67-0-17" id="h67-0-17" class="i">+            {context.config.bool(ConfigProperty.PREVENT_STATUS_NOTIFICATIONS) }) { param -&gt;
</a><a href="#h67-0-18" id="h67-0-18" class="i">+            val contentTypeString = (param.arg(1) as Any).getObjectField(&quot;mContentType&quot;)
</a><a href="#h67-0-19" id="h67-0-19" class="i">+
</a><a href="#h67-0-20" id="h67-0-20" class="i">+            if (contentTypeString == ContentType.STATUS_SAVE_TO_CAMERA_ROLL.name ||
</a><a href="#h67-0-21" id="h67-0-21" class="i">+                contentTypeString == ContentType.STATUS_CONVERSATION_CAPTURE_SCREENSHOT.name ||
</a><a href="#h67-0-22" id="h67-0-22" class="i">+                contentTypeString == ContentType.STATUS_CONVERSATION_CAPTURE_RECORD.name) {
</a><a href="#h67-0-23" id="h67-0-23" class="i">+                param.setResult(null)
</a><a href="#h67-0-24" id="h67-0-24" class="i">+            }
</a><a href="#h67-0-25" id="h67-0-25" class="i">+        }
</a><a href="#h67-0-26" id="h67-0-26" class="i">+    }
</a><a href="#h67-0-27" id="h67-0-27" class="i">+}
</a><b>diff --git a/<a id="h68" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/spy/StealthMode.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/spy/StealthMode.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/spy/StealthMode.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/spy/StealthMode.kt</a></b>
<a href="#h68-0" id="h68-0" class="h">@@ -0,0 +1,62 @@
</a><a href="#h68-0-0" id="h68-0-0" class="i">+package me.rhunk.snapenhance.features.impl.spy
</a><a href="#h68-0-1" id="h68-0-1" class="i">+
</a><a href="#h68-0-2" id="h68-0-2" class="i">+import me.rhunk.snapenhance.bridge.common.impl.FileAccessRequest
</a><a href="#h68-0-3" id="h68-0-3" class="i">+import me.rhunk.snapenhance.features.Feature
</a><a href="#h68-0-4" id="h68-0-4" class="i">+import me.rhunk.snapenhance.features.FeatureLoadParams
</a><a href="#h68-0-5" id="h68-0-5" class="i">+import java.io.BufferedReader
</a><a href="#h68-0-6" id="h68-0-6" class="i">+import java.io.ByteArrayInputStream
</a><a href="#h68-0-7" id="h68-0-7" class="i">+import java.io.InputStreamReader
</a><a href="#h68-0-8" id="h68-0-8" class="i">+import java.nio.charset.StandardCharsets
</a><a href="#h68-0-9" id="h68-0-9" class="i">+
</a><a href="#h68-0-10" id="h68-0-10" class="i">+
</a><a href="#h68-0-11" id="h68-0-11" class="i">+class StealthMode : Feature(&quot;StealthMode&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_SYNC) {
</a><a href="#h68-0-12" id="h68-0-12" class="i">+    private val stealthConversations = mutableListOf&lt;String&gt;()
</a><a href="#h68-0-13" id="h68-0-13" class="i">+
</a><a href="#h68-0-14" id="h68-0-14" class="i">+    override fun onActivityCreate() {
</a><a href="#h68-0-15" id="h68-0-15" class="i">+        readStealthFile()
</a><a href="#h68-0-16" id="h68-0-16" class="i">+    }
</a><a href="#h68-0-17" id="h68-0-17" class="i">+
</a><a href="#h68-0-18" id="h68-0-18" class="i">+    private fun writeStealthFile() {
</a><a href="#h68-0-19" id="h68-0-19" class="i">+        val sb = StringBuilder()
</a><a href="#h68-0-20" id="h68-0-20" class="i">+        for (stealthConversation in stealthConversations) {
</a><a href="#h68-0-21" id="h68-0-21" class="i">+            sb.append(stealthConversation).append(&quot;\n&quot;)
</a><a href="#h68-0-22" id="h68-0-22" class="i">+        }
</a><a href="#h68-0-23" id="h68-0-23" class="i">+        context.bridgeClient.writeFile(
</a><a href="#h68-0-24" id="h68-0-24" class="i">+            FileAccessRequest.FileType.STEALTH,
</a><a href="#h68-0-25" id="h68-0-25" class="i">+            sb.toString().toByteArray(StandardCharsets.UTF_8)
</a><a href="#h68-0-26" id="h68-0-26" class="i">+        )
</a><a href="#h68-0-27" id="h68-0-27" class="i">+    }
</a><a href="#h68-0-28" id="h68-0-28" class="i">+
</a><a href="#h68-0-29" id="h68-0-29" class="i">+    private fun readStealthFile() {
</a><a href="#h68-0-30" id="h68-0-30" class="i">+        val conversations = mutableListOf&lt;String&gt;()
</a><a href="#h68-0-31" id="h68-0-31" class="i">+        val stealthFileData: ByteArray = context.bridgeClient.createAndReadFile(FileAccessRequest.FileType.STEALTH, ByteArray(0))
</a><a href="#h68-0-32" id="h68-0-32" class="i">+        //read conversations
</a><a href="#h68-0-33" id="h68-0-33" class="i">+        with(BufferedReader(InputStreamReader(
</a><a href="#h68-0-34" id="h68-0-34" class="i">+                ByteArrayInputStream(stealthFileData),
</a><a href="#h68-0-35" id="h68-0-35" class="i">+                StandardCharsets.UTF_8
</a><a href="#h68-0-36" id="h68-0-36" class="i">+        ))) {
</a><a href="#h68-0-37" id="h68-0-37" class="i">+            var line: String = &quot;&quot;
</a><a href="#h68-0-38" id="h68-0-38" class="i">+            while (readLine()?.also { line = it } != null) {
</a><a href="#h68-0-39" id="h68-0-39" class="i">+                conversations.add(line)
</a><a href="#h68-0-40" id="h68-0-40" class="i">+            }
</a><a href="#h68-0-41" id="h68-0-41" class="i">+            close()
</a><a href="#h68-0-42" id="h68-0-42" class="i">+        }
</a><a href="#h68-0-43" id="h68-0-43" class="i">+        stealthConversations.clear()
</a><a href="#h68-0-44" id="h68-0-44" class="i">+        stealthConversations.addAll(conversations)
</a><a href="#h68-0-45" id="h68-0-45" class="i">+    }
</a><a href="#h68-0-46" id="h68-0-46" class="i">+
</a><a href="#h68-0-47" id="h68-0-47" class="i">+    fun setStealth(conversationId: String, stealth: Boolean) {
</a><a href="#h68-0-48" id="h68-0-48" class="i">+        conversationId.hashCode().toLong().toString(16).let {
</a><a href="#h68-0-49" id="h68-0-49" class="i">+            if (stealth) {
</a><a href="#h68-0-50" id="h68-0-50" class="i">+                stealthConversations.add(it)
</a><a href="#h68-0-51" id="h68-0-51" class="i">+            } else {
</a><a href="#h68-0-52" id="h68-0-52" class="i">+                stealthConversations.remove(it)
</a><a href="#h68-0-53" id="h68-0-53" class="i">+            }
</a><a href="#h68-0-54" id="h68-0-54" class="i">+        }
</a><a href="#h68-0-55" id="h68-0-55" class="i">+        writeStealthFile()
</a><a href="#h68-0-56" id="h68-0-56" class="i">+    }
</a><a href="#h68-0-57" id="h68-0-57" class="i">+
</a><a href="#h68-0-58" id="h68-0-58" class="i">+    fun isStealth(conversationId: String): Boolean {
</a><a href="#h68-0-59" id="h68-0-59" class="i">+        return stealthConversations.contains(conversationId.hashCode().toLong().toString(16))
</a><a href="#h68-0-60" id="h68-0-60" class="i">+    }
</a><a href="#h68-0-61" id="h68-0-61" class="i">+}
</a><b>diff --git a/<a id="h69" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/UITweaks.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/UITweaks.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/UITweaks.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/UITweaks.kt</a></b>
<a href="#h69-0" id="h69-0" class="h">@@ -0,0 +1,61 @@
</a><a href="#h69-0-0" id="h69-0-0" class="i">+package me.rhunk.snapenhance.features.impl.ui
</a><a href="#h69-0-1" id="h69-0-1" class="i">+
</a><a href="#h69-0-2" id="h69-0-2" class="i">+import android.view.View
</a><a href="#h69-0-3" id="h69-0-3" class="i">+import android.view.ViewGroup
</a><a href="#h69-0-4" id="h69-0-4" class="i">+import me.rhunk.snapenhance.Constants
</a><a href="#h69-0-5" id="h69-0-5" class="i">+import me.rhunk.snapenhance.config.ConfigProperty
</a><a href="#h69-0-6" id="h69-0-6" class="i">+import me.rhunk.snapenhance.features.Feature
</a><a href="#h69-0-7" id="h69-0-7" class="i">+import me.rhunk.snapenhance.features.FeatureLoadParams
</a><a href="#h69-0-8" id="h69-0-8" class="i">+import me.rhunk.snapenhance.hook.HookStage
</a><a href="#h69-0-9" id="h69-0-9" class="i">+import me.rhunk.snapenhance.hook.Hooker
</a><a href="#h69-0-10" id="h69-0-10" class="i">+
</a><a href="#h69-0-11" id="h69-0-11" class="i">+class UITweaks : Feature(&quot;UITweaks&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_SYNC) {
</a><a href="#h69-0-12" id="h69-0-12" class="i">+    override fun onActivityCreate() {
</a><a href="#h69-0-13" id="h69-0-13" class="i">+        val resources = context.resources
</a><a href="#h69-0-14" id="h69-0-14" class="i">+
</a><a href="#h69-0-15" id="h69-0-15" class="i">+        val callButtonsStub = resources.getIdentifier(&quot;call_buttons_stub&quot;, &quot;id&quot;, Constants.SNAPCHAT_PACKAGE_NAME)
</a><a href="#h69-0-16" id="h69-0-16" class="i">+        val callButton1 = resources.getIdentifier(&quot;friend_action_button3&quot;, &quot;id&quot;, Constants.SNAPCHAT_PACKAGE_NAME)
</a><a href="#h69-0-17" id="h69-0-17" class="i">+        val callButton2 = resources.getIdentifier(&quot;friend_action_button4&quot;, &quot;id&quot;, Constants.SNAPCHAT_PACKAGE_NAME)
</a><a href="#h69-0-18" id="h69-0-18" class="i">+
</a><a href="#h69-0-19" id="h69-0-19" class="i">+        val chatNoteRecordButton = resources.getIdentifier(&quot;chat_note_record_button&quot;, &quot;id&quot;, Constants.SNAPCHAT_PACKAGE_NAME)
</a><a href="#h69-0-20" id="h69-0-20" class="i">+        val chatInputBarSticker = resources.getIdentifier(&quot;chat_input_bar_sticker&quot;, &quot;id&quot;, Constants.SNAPCHAT_PACKAGE_NAME)
</a><a href="#h69-0-21" id="h69-0-21" class="i">+        val chatInputBarCognac = resources.getIdentifier(&quot;chat_input_bar_cognac&quot;, &quot;id&quot;, Constants.SNAPCHAT_PACKAGE_NAME)
</a><a href="#h69-0-22" id="h69-0-22" class="i">+
</a><a href="#h69-0-23" id="h69-0-23" class="i">+        Hooker.hook(View::class.java, &quot;setVisibility&quot;, HookStage.BEFORE) { methodParam -&gt;
</a><a href="#h69-0-24" id="h69-0-24" class="i">+            val viewId = (methodParam.thisObject() as View).id
</a><a href="#h69-0-25" id="h69-0-25" class="i">+            if (viewId == chatNoteRecordButton &amp;&amp; context.config.bool(ConfigProperty.REMOVE_VOICE_RECORD_BUTTON)) {
</a><a href="#h69-0-26" id="h69-0-26" class="i">+                methodParam.setArg(0, View.GONE)
</a><a href="#h69-0-27" id="h69-0-27" class="i">+            }
</a><a href="#h69-0-28" id="h69-0-28" class="i">+        }
</a><a href="#h69-0-29" id="h69-0-29" class="i">+
</a><a href="#h69-0-30" id="h69-0-30" class="i">+        //TODO: use the event bus to dispatch a addView event
</a><a href="#h69-0-31" id="h69-0-31" class="i">+        val addViewMethod = ViewGroup::class.java.getMethod(
</a><a href="#h69-0-32" id="h69-0-32" class="i">+            &quot;addView&quot;,
</a><a href="#h69-0-33" id="h69-0-33" class="i">+            View::class.java,
</a><a href="#h69-0-34" id="h69-0-34" class="i">+            Int::class.javaPrimitiveType,
</a><a href="#h69-0-35" id="h69-0-35" class="i">+            ViewGroup.LayoutParams::class.java
</a><a href="#h69-0-36" id="h69-0-36" class="i">+        )
</a><a href="#h69-0-37" id="h69-0-37" class="i">+        Hooker.hook(addViewMethod, HookStage.BEFORE) { param -&gt;
</a><a href="#h69-0-38" id="h69-0-38" class="i">+            val view: View = param.arg(0)
</a><a href="#h69-0-39" id="h69-0-39" class="i">+            val viewId = view.id
</a><a href="#h69-0-40" id="h69-0-40" class="i">+
</a><a href="#h69-0-41" id="h69-0-41" class="i">+            if (chatInputBarCognac == viewId &amp;&amp; context.config.bool(ConfigProperty.REMOVE_COGNAC_BUTTON)) {
</a><a href="#h69-0-42" id="h69-0-42" class="i">+                view.visibility = View.GONE
</a><a href="#h69-0-43" id="h69-0-43" class="i">+            }
</a><a href="#h69-0-44" id="h69-0-44" class="i">+            if (chatInputBarSticker == viewId &amp;&amp; context.config.bool(ConfigProperty.REMOVE_STICKERS_BUTTON)) {
</a><a href="#h69-0-45" id="h69-0-45" class="i">+                view.visibility = View.GONE
</a><a href="#h69-0-46" id="h69-0-46" class="i">+            }
</a><a href="#h69-0-47" id="h69-0-47" class="i">+            if (context.config.bool(ConfigProperty.REMOVE_CALLBUTTONS)) {
</a><a href="#h69-0-48" id="h69-0-48" class="i">+                if (viewId == callButton1 || viewId == callButton2) {
</a><a href="#h69-0-49" id="h69-0-49" class="i">+                    if (view.visibility == View.GONE) return@hook
</a><a href="#h69-0-50" id="h69-0-50" class="i">+                    Hooker.ephemeralHookObjectMethod(View::class.java, view, &quot;setVisibility&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h69-0-51" id="h69-0-51" class="i">+                        param.setArg(0, View.GONE)
</a><a href="#h69-0-52" id="h69-0-52" class="i">+                    }
</a><a href="#h69-0-53" id="h69-0-53" class="i">+                }
</a><a href="#h69-0-54" id="h69-0-54" class="i">+                if (viewId == callButtonsStub) {
</a><a href="#h69-0-55" id="h69-0-55" class="i">+                    param.setResult(null)
</a><a href="#h69-0-56" id="h69-0-56" class="i">+                }
</a><a href="#h69-0-57" id="h69-0-57" class="i">+            }
</a><a href="#h69-0-58" id="h69-0-58" class="i">+        }
</a><a href="#h69-0-59" id="h69-0-59" class="i">+    }
</a><a href="#h69-0-60" id="h69-0-60" class="i">+}</a><a href="#h69-0-61" id="h69-0-61" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h70" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/menus/AbstractMenu.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/menus/AbstractMenu.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/menus/AbstractMenu.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/menus/AbstractMenu.kt</a></b>
<a href="#h70-0" id="h70-0" class="h">@@ -0,0 +1,9 @@
</a><a href="#h70-0-0" id="h70-0-0" class="i">+package me.rhunk.snapenhance.features.impl.ui.menus
</a><a href="#h70-0-1" id="h70-0-1" class="i">+
</a><a href="#h70-0-2" id="h70-0-2" class="i">+import me.rhunk.snapenhance.ModContext
</a><a href="#h70-0-3" id="h70-0-3" class="i">+
</a><a href="#h70-0-4" id="h70-0-4" class="i">+abstract class AbstractMenu() {
</a><a href="#h70-0-5" id="h70-0-5" class="i">+    lateinit var context: ModContext
</a><a href="#h70-0-6" id="h70-0-6" class="i">+
</a><a href="#h70-0-7" id="h70-0-7" class="i">+    open fun init() {}
</a><a href="#h70-0-8" id="h70-0-8" class="i">+}</a><a href="#h70-0-9" id="h70-0-9" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h71" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/menus/MenuViewInjector.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/menus/MenuViewInjector.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/menus/MenuViewInjector.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/menus/MenuViewInjector.kt</a></b>
<a href="#h71-0" id="h71-0" class="h">@@ -0,0 +1,139 @@
</a><a href="#h71-0-0" id="h71-0-0" class="i">+package me.rhunk.snapenhance.features.impl.ui.menus
</a><a href="#h71-0-1" id="h71-0-1" class="i">+
</a><a href="#h71-0-2" id="h71-0-2" class="i">+import android.annotation.SuppressLint
</a><a href="#h71-0-3" id="h71-0-3" class="i">+import android.content.Context
</a><a href="#h71-0-4" id="h71-0-4" class="i">+import android.util.AttributeSet
</a><a href="#h71-0-5" id="h71-0-5" class="i">+import android.view.View
</a><a href="#h71-0-6" id="h71-0-6" class="i">+import android.view.ViewGroup
</a><a href="#h71-0-7" id="h71-0-7" class="i">+import android.widget.FrameLayout
</a><a href="#h71-0-8" id="h71-0-8" class="i">+import android.widget.LinearLayout
</a><a href="#h71-0-9" id="h71-0-9" class="i">+import de.robv.android.xposed.XposedBridge
</a><a href="#h71-0-10" id="h71-0-10" class="i">+import me.rhunk.snapenhance.Constants.VIEW_DRAWER
</a><a href="#h71-0-11" id="h71-0-11" class="i">+import me.rhunk.snapenhance.Constants.VIEW_INJECTED_CODE
</a><a href="#h71-0-12" id="h71-0-12" class="i">+import me.rhunk.snapenhance.config.ConfigProperty
</a><a href="#h71-0-13" id="h71-0-13" class="i">+import me.rhunk.snapenhance.features.Feature
</a><a href="#h71-0-14" id="h71-0-14" class="i">+import me.rhunk.snapenhance.features.FeatureLoadParams
</a><a href="#h71-0-15" id="h71-0-15" class="i">+import me.rhunk.snapenhance.features.impl.Messaging
</a><a href="#h71-0-16" id="h71-0-16" class="i">+import me.rhunk.snapenhance.features.impl.ui.menus.impl.ChatActionMenu
</a><a href="#h71-0-17" id="h71-0-17" class="i">+import me.rhunk.snapenhance.features.impl.ui.menus.impl.FriendFeedInfoMenu
</a><a href="#h71-0-18" id="h71-0-18" class="i">+import me.rhunk.snapenhance.features.impl.ui.menus.impl.OperaContextActionMenu
</a><a href="#h71-0-19" id="h71-0-19" class="i">+import me.rhunk.snapenhance.features.impl.ui.menus.impl.SettingsMenu
</a><a href="#h71-0-20" id="h71-0-20" class="i">+import me.rhunk.snapenhance.hook.HookStage
</a><a href="#h71-0-21" id="h71-0-21" class="i">+import me.rhunk.snapenhance.hook.Hooker
</a><a href="#h71-0-22" id="h71-0-22" class="i">+import java.lang.reflect.Field
</a><a href="#h71-0-23" id="h71-0-23" class="i">+import java.lang.reflect.Modifier
</a><a href="#h71-0-24" id="h71-0-24" class="i">+
</a><a href="#h71-0-25" id="h71-0-25" class="i">+class MenuViewInjector : Feature(&quot;MenuViewInjector&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_ASYNC) {
</a><a href="#h71-0-26" id="h71-0-26" class="i">+    private val friendFeedInfoMenu = FriendFeedInfoMenu()
</a><a href="#h71-0-27" id="h71-0-27" class="i">+    private val operaContextActionMenu = OperaContextActionMenu()
</a><a href="#h71-0-28" id="h71-0-28" class="i">+    private val chatActionMenu = ChatActionMenu()
</a><a href="#h71-0-29" id="h71-0-29" class="i">+    private val settingMenu = SettingsMenu()
</a><a href="#h71-0-30" id="h71-0-30" class="i">+
</a><a href="#h71-0-31" id="h71-0-31" class="i">+    private fun wasInjectedView(view: View): Boolean {
</a><a href="#h71-0-32" id="h71-0-32" class="i">+        if (view.getTag(VIEW_INJECTED_CODE) != null) return true
</a><a href="#h71-0-33" id="h71-0-33" class="i">+        view.setTag(VIEW_INJECTED_CODE, true)
</a><a href="#h71-0-34" id="h71-0-34" class="i">+        return false
</a><a href="#h71-0-35" id="h71-0-35" class="i">+    }
</a><a href="#h71-0-36" id="h71-0-36" class="i">+
</a><a href="#h71-0-37" id="h71-0-37" class="i">+    @SuppressLint(&quot;ResourceType&quot;)
</a><a href="#h71-0-38" id="h71-0-38" class="i">+    override fun asyncOnActivityCreate() {
</a><a href="#h71-0-39" id="h71-0-39" class="i">+        friendFeedInfoMenu.context = context
</a><a href="#h71-0-40" id="h71-0-40" class="i">+        operaContextActionMenu.context = context
</a><a href="#h71-0-41" id="h71-0-41" class="i">+        chatActionMenu.context = context
</a><a href="#h71-0-42" id="h71-0-42" class="i">+        settingMenu.context = context
</a><a href="#h71-0-43" id="h71-0-43" class="i">+
</a><a href="#h71-0-44" id="h71-0-44" class="i">+        val addViewMethod = ViewGroup::class.java.getMethod(
</a><a href="#h71-0-45" id="h71-0-45" class="i">+            &quot;addView&quot;,
</a><a href="#h71-0-46" id="h71-0-46" class="i">+            View::class.java,
</a><a href="#h71-0-47" id="h71-0-47" class="i">+            Int::class.javaPrimitiveType,
</a><a href="#h71-0-48" id="h71-0-48" class="i">+            ViewGroup.LayoutParams::class.java
</a><a href="#h71-0-49" id="h71-0-49" class="i">+        )
</a><a href="#h71-0-50" id="h71-0-50" class="i">+
</a><a href="#h71-0-51" id="h71-0-51" class="i">+        //catch the card view instance in the action drawer
</a><a href="#h71-0-52" id="h71-0-52" class="i">+        Hooker.hook(
</a><a href="#h71-0-53" id="h71-0-53" class="i">+            LinearLayout::class.java.getConstructor(
</a><a href="#h71-0-54" id="h71-0-54" class="i">+                Context::class.java,
</a><a href="#h71-0-55" id="h71-0-55" class="i">+                AttributeSet::class.java,
</a><a href="#h71-0-56" id="h71-0-56" class="i">+                Int::class.javaPrimitiveType
</a><a href="#h71-0-57" id="h71-0-57" class="i">+            ), HookStage.AFTER
</a><a href="#h71-0-58" id="h71-0-58" class="i">+        ) { param -&gt;
</a><a href="#h71-0-59" id="h71-0-59" class="i">+            val viewGroup: LinearLayout = param.thisObject()
</a><a href="#h71-0-60" id="h71-0-60" class="i">+            val attribute: Int = param.arg(2)
</a><a href="#h71-0-61" id="h71-0-61" class="i">+            if (attribute == 0) return@hook
</a><a href="#h71-0-62" id="h71-0-62" class="i">+            val resourceName = viewGroup.resources.getResourceName(attribute)
</a><a href="#h71-0-63" id="h71-0-63" class="i">+            if (!resourceName.endsWith(&quot;snapCardContentLayoutStyle&quot;)) return@hook
</a><a href="#h71-0-64" id="h71-0-64" class="i">+            viewGroup.setTag(VIEW_DRAWER, Any())
</a><a href="#h71-0-65" id="h71-0-65" class="i">+        }
</a><a href="#h71-0-66" id="h71-0-66" class="i">+
</a><a href="#h71-0-67" id="h71-0-67" class="i">+        Hooker.hook(addViewMethod, HookStage.BEFORE) { param -&gt;
</a><a href="#h71-0-68" id="h71-0-68" class="i">+            val viewGroup: ViewGroup = param.thisObject()
</a><a href="#h71-0-69" id="h71-0-69" class="i">+            val originalAddView: (View) -&gt; Unit = { view: View -&gt;
</a><a href="#h71-0-70" id="h71-0-70" class="i">+                XposedBridge.invokeOriginalMethod(
</a><a href="#h71-0-71" id="h71-0-71" class="i">+                    addViewMethod,
</a><a href="#h71-0-72" id="h71-0-72" class="i">+                    viewGroup,
</a><a href="#h71-0-73" id="h71-0-73" class="i">+                    arrayOf(
</a><a href="#h71-0-74" id="h71-0-74" class="i">+                        view,
</a><a href="#h71-0-75" id="h71-0-75" class="i">+                        -1,
</a><a href="#h71-0-76" id="h71-0-76" class="i">+                        FrameLayout.LayoutParams(
</a><a href="#h71-0-77" id="h71-0-77" class="i">+                            ViewGroup.LayoutParams.MATCH_PARENT,
</a><a href="#h71-0-78" id="h71-0-78" class="i">+                            ViewGroup.LayoutParams.MATCH_PARENT
</a><a href="#h71-0-79" id="h71-0-79" class="i">+                        )
</a><a href="#h71-0-80" id="h71-0-80" class="i">+                    )
</a><a href="#h71-0-81" id="h71-0-81" class="i">+                )
</a><a href="#h71-0-82" id="h71-0-82" class="i">+            }
</a><a href="#h71-0-83" id="h71-0-83" class="i">+
</a><a href="#h71-0-84" id="h71-0-84" class="i">+            val childView: View = param.arg(0)
</a><a href="#h71-0-85" id="h71-0-85" class="i">+            operaContextActionMenu.inject(viewGroup, childView)
</a><a href="#h71-0-86" id="h71-0-86" class="i">+
</a><a href="#h71-0-87" id="h71-0-87" class="i">+            //download in chat snaps and notes from the chat action menu
</a><a href="#h71-0-88" id="h71-0-88" class="i">+            if (viewGroup.javaClass.name.endsWith(&quot;ActionMenuChatItemContainer&quot;)) {
</a><a href="#h71-0-89" id="h71-0-89" class="i">+                if (viewGroup.parent == null || viewGroup.parent
</a><a href="#h71-0-90" id="h71-0-90" class="i">+                        .parent == null
</a><a href="#h71-0-91" id="h71-0-91" class="i">+                ) return@hook
</a><a href="#h71-0-92" id="h71-0-92" class="i">+                chatActionMenu.inject(viewGroup)
</a><a href="#h71-0-93" id="h71-0-93" class="i">+                return@hook
</a><a href="#h71-0-94" id="h71-0-94" class="i">+            }
</a><a href="#h71-0-95" id="h71-0-95" class="i">+
</a><a href="#h71-0-96" id="h71-0-96" class="i">+            //TODO : preview group chats
</a><a href="#h71-0-97" id="h71-0-97" class="i">+            if (viewGroup !is LinearLayout) return@hook
</a><a href="#h71-0-98" id="h71-0-98" class="i">+            if (viewGroup.getTag(VIEW_DRAWER) == null) return@hook
</a><a href="#h71-0-99" id="h71-0-99" class="i">+            val itemStringInterface =childView.javaClass.declaredFields.filter { field: Field -&gt;
</a><a href="#h71-0-100" id="h71-0-100" class="i">+                        !field.type.isPrimitive &amp;&amp; Modifier.isAbstract(
</a><a href="#h71-0-101" id="h71-0-101" class="i">+                            field.type.modifiers
</a><a href="#h71-0-102" id="h71-0-102" class="i">+                        )
</a><a href="#h71-0-103" id="h71-0-103" class="i">+                    }
</a><a href="#h71-0-104" id="h71-0-104" class="i">+                    .map { field: Field -&gt;
</a><a href="#h71-0-105" id="h71-0-105" class="i">+                        try {
</a><a href="#h71-0-106" id="h71-0-106" class="i">+                            field.isAccessible = true
</a><a href="#h71-0-107" id="h71-0-107" class="i">+                            return@map field[childView]
</a><a href="#h71-0-108" id="h71-0-108" class="i">+                        } catch (e: IllegalAccessException) {
</a><a href="#h71-0-109" id="h71-0-109" class="i">+                            e.printStackTrace()
</a><a href="#h71-0-110" id="h71-0-110" class="i">+                        }
</a><a href="#h71-0-111" id="h71-0-111" class="i">+                        null
</a><a href="#h71-0-112" id="h71-0-112" class="i">+                    }.firstOrNull()
</a><a href="#h71-0-113" id="h71-0-113" class="i">+
</a><a href="#h71-0-114" id="h71-0-114" class="i">+            //the 3 dot button shows a menu which contains the first item as a Plain object
</a><a href="#h71-0-115" id="h71-0-115" class="i">+            //FIXME: better way to detect the 3 dot button
</a><a href="#h71-0-116" id="h71-0-116" class="i">+           if (viewGroup.getChildCount() == 0 &amp;&amp; itemStringInterface != null &amp;&amp; itemStringInterface.toString().startsWith(&quot;Plain(primaryText=&quot;)) {
</a><a href="#h71-0-117" id="h71-0-117" class="i">+                if (wasInjectedView(viewGroup)) return@hook
</a><a href="#h71-0-118" id="h71-0-118" class="i">+
</a><a href="#h71-0-119" id="h71-0-119" class="i">+                settingMenu.inject(viewGroup, originalAddView)
</a><a href="#h71-0-120" id="h71-0-120" class="i">+                viewGroup.addOnAttachStateChangeListener(object: View.OnAttachStateChangeListener {
</a><a href="#h71-0-121" id="h71-0-121" class="i">+                    override fun onViewAttachedToWindow(v: View?) {}
</a><a href="#h71-0-122" id="h71-0-122" class="i">+                    override fun onViewDetachedFromWindow(v: View?) {
</a><a href="#h71-0-123" id="h71-0-123" class="i">+                        context.config.writeConfig()
</a><a href="#h71-0-124" id="h71-0-124" class="i">+                    }
</a><a href="#h71-0-125" id="h71-0-125" class="i">+                })
</a><a href="#h71-0-126" id="h71-0-126" class="i">+                return@hook
</a><a href="#h71-0-127" id="h71-0-127" class="i">+            }
</a><a href="#h71-0-128" id="h71-0-128" class="i">+            if (context.feature(Messaging::class).lastFetchConversationUserUUID == null) return@hook
</a><a href="#h71-0-129" id="h71-0-129" class="i">+
</a><a href="#h71-0-130" id="h71-0-130" class="i">+            //filter by the slot index
</a><a href="#h71-0-131" id="h71-0-131" class="i">+            if (viewGroup.getChildCount() != context.config.int(ConfigProperty.MENU_SLOT_ID)) return@hook
</a><a href="#h71-0-132" id="h71-0-132" class="i">+
</a><a href="#h71-0-133" id="h71-0-133" class="i">+            friendFeedInfoMenu.inject(viewGroup, originalAddView)
</a><a href="#h71-0-134" id="h71-0-134" class="i">+            childView.setTag(VIEW_DRAWER, null)
</a><a href="#h71-0-135" id="h71-0-135" class="i">+        }
</a><a href="#h71-0-136" id="h71-0-136" class="i">+    }
</a><a href="#h71-0-137" id="h71-0-137" class="i">+
</a><a href="#h71-0-138" id="h71-0-138" class="i">+}</a><a href="#h71-0-139" id="h71-0-139" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h72" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/menus/ViewAppearanceHelper.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/menus/ViewAppearanceHelper.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/menus/ViewAppearanceHelper.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/menus/ViewAppearanceHelper.kt</a></b>
<a href="#h72-0" id="h72-0" class="h">@@ -0,0 +1,53 @@
</a><a href="#h72-0-0" id="h72-0-0" class="i">+package me.rhunk.snapenhance.features.impl.ui.menus
</a><a href="#h72-0-1" id="h72-0-1" class="i">+
</a><a href="#h72-0-2" id="h72-0-2" class="i">+import android.annotation.SuppressLint
</a><a href="#h72-0-3" id="h72-0-3" class="i">+import android.content.res.ColorStateList
</a><a href="#h72-0-4" id="h72-0-4" class="i">+import android.graphics.Color
</a><a href="#h72-0-5" id="h72-0-5" class="i">+import android.graphics.Typeface
</a><a href="#h72-0-6" id="h72-0-6" class="i">+import android.view.Gravity
</a><a href="#h72-0-7" id="h72-0-7" class="i">+import android.view.View
</a><a href="#h72-0-8" id="h72-0-8" class="i">+import android.widget.Switch
</a><a href="#h72-0-9" id="h72-0-9" class="i">+import android.widget.TextView
</a><a href="#h72-0-10" id="h72-0-10" class="i">+
</a><a href="#h72-0-11" id="h72-0-11" class="i">+object ViewAppearanceHelper {
</a><a href="#h72-0-12" id="h72-0-12" class="i">+    fun applyIndentation(view: TextView) {
</a><a href="#h72-0-13" id="h72-0-13" class="i">+        view.setPadding(70, 0, 55, 0)
</a><a href="#h72-0-14" id="h72-0-14" class="i">+    }
</a><a href="#h72-0-15" id="h72-0-15" class="i">+
</a><a href="#h72-0-16" id="h72-0-16" class="i">+    @SuppressLint(&quot;UseSwitchCompatOrMaterialCode&quot;, &quot;RtlHardcoded&quot;)
</a><a href="#h72-0-17" id="h72-0-17" class="i">+    fun applyTheme(viewModel: View, view: TextView) {
</a><a href="#h72-0-18" id="h72-0-18" class="i">+        //remove the shadow
</a><a href="#h72-0-19" id="h72-0-19" class="i">+        view.setBackgroundColor(0x00000000)
</a><a href="#h72-0-20" id="h72-0-20" class="i">+        view.setTextColor(Color.parseColor(&quot;#000000&quot;))
</a><a href="#h72-0-21" id="h72-0-21" class="i">+        view.setShadowLayer(0f, 0f, 0f, 0)
</a><a href="#h72-0-22" id="h72-0-22" class="i">+        view.outlineProvider = null
</a><a href="#h72-0-23" id="h72-0-23" class="i">+        view.gravity = Gravity.LEFT or Gravity.CENTER_VERTICAL
</a><a href="#h72-0-24" id="h72-0-24" class="i">+        view.width = viewModel.width
</a><a href="#h72-0-25" id="h72-0-25" class="i">+        //FIXME: hardcoded dimensions
</a><a href="#h72-0-26" id="h72-0-26" class="i">+        view.height = 160
</a><a href="#h72-0-27" id="h72-0-27" class="i">+        view.setPadding(35, 0, 55, 0)
</a><a href="#h72-0-28" id="h72-0-28" class="i">+        view.isAllCaps = false
</a><a href="#h72-0-29" id="h72-0-29" class="i">+        view.textSize = 15f
</a><a href="#h72-0-30" id="h72-0-30" class="i">+        view.typeface = Typeface.DEFAULT
</a><a href="#h72-0-31" id="h72-0-31" class="i">+
</a><a href="#h72-0-32" id="h72-0-32" class="i">+        //remove click effect
</a><a href="#h72-0-33" id="h72-0-33" class="i">+        if (view.javaClass == TextView::class.java) {
</a><a href="#h72-0-34" id="h72-0-34" class="i">+            view.setBackgroundColor(0)
</a><a href="#h72-0-35" id="h72-0-35" class="i">+        }
</a><a href="#h72-0-36" id="h72-0-36" class="i">+        if (view is Switch) {
</a><a href="#h72-0-37" id="h72-0-37" class="i">+            //set the switch color to blue
</a><a href="#h72-0-38" id="h72-0-38" class="i">+            val colorStateList = ColorStateList(
</a><a href="#h72-0-39" id="h72-0-39" class="i">+                arrayOf(
</a><a href="#h72-0-40" id="h72-0-40" class="i">+                    intArrayOf(-android.R.attr.state_checked), intArrayOf(
</a><a href="#h72-0-41" id="h72-0-41" class="i">+                        android.R.attr.state_checked
</a><a href="#h72-0-42" id="h72-0-42" class="i">+                    )
</a><a href="#h72-0-43" id="h72-0-43" class="i">+                ), intArrayOf(
</a><a href="#h72-0-44" id="h72-0-44" class="i">+                    Color.parseColor(&quot;#000000&quot;),
</a><a href="#h72-0-45" id="h72-0-45" class="i">+                    Color.parseColor(&quot;#2196F3&quot;)
</a><a href="#h72-0-46" id="h72-0-46" class="i">+                )
</a><a href="#h72-0-47" id="h72-0-47" class="i">+            )
</a><a href="#h72-0-48" id="h72-0-48" class="i">+            view.trackTintList = colorStateList
</a><a href="#h72-0-49" id="h72-0-49" class="i">+            view.thumbTintList = colorStateList
</a><a href="#h72-0-50" id="h72-0-50" class="i">+        }
</a><a href="#h72-0-51" id="h72-0-51" class="i">+    }
</a><a href="#h72-0-52" id="h72-0-52" class="i">+}
</a><b>diff --git a/<a id="h73" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/menus/impl/ChatActionMenu.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/menus/impl/ChatActionMenu.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/menus/impl/ChatActionMenu.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/menus/impl/ChatActionMenu.kt</a></b>
<a href="#h73-0" id="h73-0" class="h">@@ -0,0 +1,91 @@
</a><a href="#h73-0-0" id="h73-0-0" class="i">+package me.rhunk.snapenhance.features.impl.ui.menus.impl
</a><a href="#h73-0-1" id="h73-0-1" class="i">+
</a><a href="#h73-0-2" id="h73-0-2" class="i">+import android.annotation.SuppressLint
</a><a href="#h73-0-3" id="h73-0-3" class="i">+import android.content.res.Resources
</a><a href="#h73-0-4" id="h73-0-4" class="i">+import android.graphics.BlendMode
</a><a href="#h73-0-5" id="h73-0-5" class="i">+import android.graphics.BlendModeColorFilter
</a><a href="#h73-0-6" id="h73-0-6" class="i">+import android.graphics.Color
</a><a href="#h73-0-7" id="h73-0-7" class="i">+import android.os.SystemClock
</a><a href="#h73-0-8" id="h73-0-8" class="i">+import android.util.TypedValue
</a><a href="#h73-0-9" id="h73-0-9" class="i">+import android.view.MotionEvent
</a><a href="#h73-0-10" id="h73-0-10" class="i">+import android.view.View
</a><a href="#h73-0-11" id="h73-0-11" class="i">+import android.view.ViewGroup
</a><a href="#h73-0-12" id="h73-0-12" class="i">+import android.view.ViewGroup.MarginLayoutParams
</a><a href="#h73-0-13" id="h73-0-13" class="i">+import android.widget.Button
</a><a href="#h73-0-14" id="h73-0-14" class="i">+import me.rhunk.snapenhance.Constants.VIEW_INJECTED_CODE
</a><a href="#h73-0-15" id="h73-0-15" class="i">+import me.rhunk.snapenhance.config.ConfigProperty
</a><a href="#h73-0-16" id="h73-0-16" class="i">+import me.rhunk.snapenhance.features.impl.downloader.MediaDownloader
</a><a href="#h73-0-17" id="h73-0-17" class="i">+import me.rhunk.snapenhance.features.impl.ui.menus.AbstractMenu
</a><a href="#h73-0-18" id="h73-0-18" class="i">+
</a><a href="#h73-0-19" id="h73-0-19" class="i">+
</a><a href="#h73-0-20" id="h73-0-20" class="i">+class ChatActionMenu : AbstractMenu() {
</a><a href="#h73-0-21" id="h73-0-21" class="i">+    private fun wasInjectedView(view: View): Boolean {
</a><a href="#h73-0-22" id="h73-0-22" class="i">+        if (view.getTag(VIEW_INJECTED_CODE) != null) return true
</a><a href="#h73-0-23" id="h73-0-23" class="i">+        view.setTag(VIEW_INJECTED_CODE, true)
</a><a href="#h73-0-24" id="h73-0-24" class="i">+        return false
</a><a href="#h73-0-25" id="h73-0-25" class="i">+    }
</a><a href="#h73-0-26" id="h73-0-26" class="i">+
</a><a href="#h73-0-27" id="h73-0-27" class="i">+    private fun applyButtonTheme(parent: View, button: Button) {
</a><a href="#h73-0-28" id="h73-0-28" class="i">+        button.background.colorFilter = BlendModeColorFilter(Color.WHITE, BlendMode.SRC_ATOP)
</a><a href="#h73-0-29" id="h73-0-29" class="i">+        button.setTextColor(Color.BLACK)
</a><a href="#h73-0-30" id="h73-0-30" class="i">+        button.transformationMethod = null
</a><a href="#h73-0-31" id="h73-0-31" class="i">+        val margin = TypedValue.applyDimension(
</a><a href="#h73-0-32" id="h73-0-32" class="i">+            TypedValue.COMPLEX_UNIT_DIP,
</a><a href="#h73-0-33" id="h73-0-33" class="i">+            20f,
</a><a href="#h73-0-34" id="h73-0-34" class="i">+            Resources.getSystem().displayMetrics
</a><a href="#h73-0-35" id="h73-0-35" class="i">+        ).toInt()
</a><a href="#h73-0-36" id="h73-0-36" class="i">+        val params = MarginLayoutParams(parent.layoutParams)
</a><a href="#h73-0-37" id="h73-0-37" class="i">+        params.setMargins(margin, 5, margin, 5)
</a><a href="#h73-0-38" id="h73-0-38" class="i">+        params.marginEnd = margin
</a><a href="#h73-0-39" id="h73-0-39" class="i">+        params.marginStart = margin
</a><a href="#h73-0-40" id="h73-0-40" class="i">+        button.layoutParams = params
</a><a href="#h73-0-41" id="h73-0-41" class="i">+        button.height = TypedValue.applyDimension(
</a><a href="#h73-0-42" id="h73-0-42" class="i">+            TypedValue.COMPLEX_UNIT_DIP,
</a><a href="#h73-0-43" id="h73-0-43" class="i">+            50f,
</a><a href="#h73-0-44" id="h73-0-44" class="i">+            Resources.getSystem().displayMetrics
</a><a href="#h73-0-45" id="h73-0-45" class="i">+        ).toInt()
</a><a href="#h73-0-46" id="h73-0-46" class="i">+    }
</a><a href="#h73-0-47" id="h73-0-47" class="i">+
</a><a href="#h73-0-48" id="h73-0-48" class="i">+    @SuppressLint(&quot;SetTextI18n&quot;)
</a><a href="#h73-0-49" id="h73-0-49" class="i">+    fun inject(viewGroup: ViewGroup) {
</a><a href="#h73-0-50" id="h73-0-50" class="i">+        val parent = viewGroup.parent.parent as ViewGroup
</a><a href="#h73-0-51" id="h73-0-51" class="i">+        if (wasInjectedView(parent)) return
</a><a href="#h73-0-52" id="h73-0-52" class="i">+        //close the action menu using a touch event
</a><a href="#h73-0-53" id="h73-0-53" class="i">+        val closeActionMenu = {
</a><a href="#h73-0-54" id="h73-0-54" class="i">+            viewGroup.dispatchTouchEvent(
</a><a href="#h73-0-55" id="h73-0-55" class="i">+                MotionEvent.obtain(
</a><a href="#h73-0-56" id="h73-0-56" class="i">+                    SystemClock.uptimeMillis(),
</a><a href="#h73-0-57" id="h73-0-57" class="i">+                    SystemClock.uptimeMillis(),
</a><a href="#h73-0-58" id="h73-0-58" class="i">+                    MotionEvent.ACTION_DOWN,
</a><a href="#h73-0-59" id="h73-0-59" class="i">+                    0f,
</a><a href="#h73-0-60" id="h73-0-60" class="i">+                    0f,
</a><a href="#h73-0-61" id="h73-0-61" class="i">+                    0
</a><a href="#h73-0-62" id="h73-0-62" class="i">+                )
</a><a href="#h73-0-63" id="h73-0-63" class="i">+            )
</a><a href="#h73-0-64" id="h73-0-64" class="i">+        }
</a><a href="#h73-0-65" id="h73-0-65" class="i">+        if (context.config.bool(ConfigProperty.DOWNLOAD_INCHAT_SNAPS)) {
</a><a href="#h73-0-66" id="h73-0-66" class="i">+            val previewButton = Button(viewGroup.context)
</a><a href="#h73-0-67" id="h73-0-67" class="i">+            applyButtonTheme(parent, previewButton)
</a><a href="#h73-0-68" id="h73-0-68" class="i">+            previewButton.text = &quot;Preview&quot;
</a><a href="#h73-0-69" id="h73-0-69" class="i">+            previewButton.setOnClickListener {
</a><a href="#h73-0-70" id="h73-0-70" class="i">+                closeActionMenu()
</a><a href="#h73-0-71" id="h73-0-71" class="i">+                context.executeAsync { context.feature(MediaDownloader::class).onMessageActionMenu(true) }
</a><a href="#h73-0-72" id="h73-0-72" class="i">+            }
</a><a href="#h73-0-73" id="h73-0-73" class="i">+            parent.addView(previewButton)
</a><a href="#h73-0-74" id="h73-0-74" class="i">+        }
</a><a href="#h73-0-75" id="h73-0-75" class="i">+
</a><a href="#h73-0-76" id="h73-0-76" class="i">+        //download snap in chat
</a><a href="#h73-0-77" id="h73-0-77" class="i">+        if (context.config.bool(ConfigProperty.DOWNLOAD_INCHAT_SNAPS)) {
</a><a href="#h73-0-78" id="h73-0-78" class="i">+            val downloadButton = Button(viewGroup.context)
</a><a href="#h73-0-79" id="h73-0-79" class="i">+            applyButtonTheme(parent, downloadButton)
</a><a href="#h73-0-80" id="h73-0-80" class="i">+            downloadButton.text = &quot;Download&quot;
</a><a href="#h73-0-81" id="h73-0-81" class="i">+            downloadButton.setOnClickListener {
</a><a href="#h73-0-82" id="h73-0-82" class="i">+                closeActionMenu()
</a><a href="#h73-0-83" id="h73-0-83" class="i">+                context.executeAsync { context.feature(MediaDownloader::class).onMessageActionMenu(false) }
</a><a href="#h73-0-84" id="h73-0-84" class="i">+            }
</a><a href="#h73-0-85" id="h73-0-85" class="i">+            parent.addView(downloadButton)
</a><a href="#h73-0-86" id="h73-0-86" class="i">+        }
</a><a href="#h73-0-87" id="h73-0-87" class="i">+
</a><a href="#h73-0-88" id="h73-0-88" class="i">+        //TODO: delete logged message button
</a><a href="#h73-0-89" id="h73-0-89" class="i">+    }
</a><a href="#h73-0-90" id="h73-0-90" class="i">+}
</a><b>diff --git a/<a id="h74" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/menus/impl/FriendFeedInfoMenu.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/menus/impl/FriendFeedInfoMenu.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/menus/impl/FriendFeedInfoMenu.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/menus/impl/FriendFeedInfoMenu.kt</a></b>
<a href="#h74-0" id="h74-0" class="h">@@ -0,0 +1,231 @@
</a><a href="#h74-0-0" id="h74-0-0" class="i">+package me.rhunk.snapenhance.features.impl.ui.menus.impl
</a><a href="#h74-0-1" id="h74-0-1" class="i">+
</a><a href="#h74-0-2" id="h74-0-2" class="i">+import android.annotation.SuppressLint
</a><a href="#h74-0-3" id="h74-0-3" class="i">+import android.app.AlertDialog
</a><a href="#h74-0-4" id="h74-0-4" class="i">+import android.content.Context
</a><a href="#h74-0-5" id="h74-0-5" class="i">+import android.content.DialogInterface
</a><a href="#h74-0-6" id="h74-0-6" class="i">+import android.content.res.Resources
</a><a href="#h74-0-7" id="h74-0-7" class="i">+import android.graphics.BitmapFactory
</a><a href="#h74-0-8" id="h74-0-8" class="i">+import android.graphics.drawable.BitmapDrawable
</a><a href="#h74-0-9" id="h74-0-9" class="i">+import android.graphics.drawable.Drawable
</a><a href="#h74-0-10" id="h74-0-10" class="i">+import android.view.View
</a><a href="#h74-0-11" id="h74-0-11" class="i">+import android.widget.Button
</a><a href="#h74-0-12" id="h74-0-12" class="i">+import android.widget.CompoundButton
</a><a href="#h74-0-13" id="h74-0-13" class="i">+import android.widget.Switch
</a><a href="#h74-0-14" id="h74-0-14" class="i">+import android.widget.Toast
</a><a href="#h74-0-15" id="h74-0-15" class="i">+import de.robv.android.xposed.XposedBridge
</a><a href="#h74-0-16" id="h74-0-16" class="i">+import me.rhunk.snapenhance.Logger
</a><a href="#h74-0-17" id="h74-0-17" class="i">+import me.rhunk.snapenhance.config.ConfigProperty
</a><a href="#h74-0-18" id="h74-0-18" class="i">+import me.rhunk.snapenhance.data.ContentType
</a><a href="#h74-0-19" id="h74-0-19" class="i">+import me.rhunk.snapenhance.database.objects.ConversationMessage
</a><a href="#h74-0-20" id="h74-0-20" class="i">+import me.rhunk.snapenhance.database.objects.FriendInfo
</a><a href="#h74-0-21" id="h74-0-21" class="i">+import me.rhunk.snapenhance.database.objects.UserConversationLink
</a><a href="#h74-0-22" id="h74-0-22" class="i">+import me.rhunk.snapenhance.features.impl.Messaging
</a><a href="#h74-0-23" id="h74-0-23" class="i">+import me.rhunk.snapenhance.features.impl.spy.StealthMode
</a><a href="#h74-0-24" id="h74-0-24" class="i">+import me.rhunk.snapenhance.features.impl.ui.menus.AbstractMenu
</a><a href="#h74-0-25" id="h74-0-25" class="i">+import me.rhunk.snapenhance.features.impl.ui.menus.ViewAppearanceHelper.applyTheme
</a><a href="#h74-0-26" id="h74-0-26" class="i">+import java.net.HttpURLConnection
</a><a href="#h74-0-27" id="h74-0-27" class="i">+import java.net.URL
</a><a href="#h74-0-28" id="h74-0-28" class="i">+import java.text.DateFormat
</a><a href="#h74-0-29" id="h74-0-29" class="i">+import java.text.SimpleDateFormat
</a><a href="#h74-0-30" id="h74-0-30" class="i">+import java.util.*
</a><a href="#h74-0-31" id="h74-0-31" class="i">+
</a><a href="#h74-0-32" id="h74-0-32" class="i">+class FriendFeedInfoMenu : AbstractMenu() {
</a><a href="#h74-0-33" id="h74-0-33" class="i">+    private fun getImageDrawable(url: String): Drawable {
</a><a href="#h74-0-34" id="h74-0-34" class="i">+        val connection = URL(url).openConnection() as HttpURLConnection
</a><a href="#h74-0-35" id="h74-0-35" class="i">+        connection.connect()
</a><a href="#h74-0-36" id="h74-0-36" class="i">+        val input = connection.inputStream
</a><a href="#h74-0-37" id="h74-0-37" class="i">+        return BitmapDrawable(Resources.getSystem(), BitmapFactory.decodeStream(input))
</a><a href="#h74-0-38" id="h74-0-38" class="i">+    }
</a><a href="#h74-0-39" id="h74-0-39" class="i">+
</a><a href="#h74-0-40" id="h74-0-40" class="i">+    private fun formatDate(timestamp: Long): String? {
</a><a href="#h74-0-41" id="h74-0-41" class="i">+        return SimpleDateFormat(&quot;yyyy-MM-dd HH:mm:ss&quot;, Locale.ENGLISH).format(Date(timestamp))
</a><a href="#h74-0-42" id="h74-0-42" class="i">+    }
</a><a href="#h74-0-43" id="h74-0-43" class="i">+
</a><a href="#h74-0-44" id="h74-0-44" class="i">+    fun showProfileInfo(profile: FriendInfo) {
</a><a href="#h74-0-45" id="h74-0-45" class="i">+        var icon: Drawable? = null
</a><a href="#h74-0-46" id="h74-0-46" class="i">+        try {
</a><a href="#h74-0-47" id="h74-0-47" class="i">+            if (profile.bitmojiSelfieId != null &amp;&amp; profile.bitmojiAvatarId != null) {
</a><a href="#h74-0-48" id="h74-0-48" class="i">+                icon = getImageDrawable(
</a><a href="#h74-0-49" id="h74-0-49" class="i">+                    &quot;https://sdk.bitmoji.com/render/panel/&quot; + profile.bitmojiSelfieId
</a><a href="#h74-0-50" id="h74-0-50" class="i">+                        .toString() + &quot;-&quot; + profile.bitmojiAvatarId
</a><a href="#h74-0-51" id="h74-0-51" class="i">+                        .toString() + &quot;-v1.webp?transparent=1&amp;scale=0&quot;
</a><a href="#h74-0-52" id="h74-0-52" class="i">+                )
</a><a href="#h74-0-53" id="h74-0-53" class="i">+            }
</a><a href="#h74-0-54" id="h74-0-54" class="i">+        } catch (e: Throwable) {
</a><a href="#h74-0-55" id="h74-0-55" class="i">+            Logger.xposedLog(e)
</a><a href="#h74-0-56" id="h74-0-56" class="i">+        }
</a><a href="#h74-0-57" id="h74-0-57" class="i">+        val finalIcon = icon
</a><a href="#h74-0-58" id="h74-0-58" class="i">+        context.runOnUiThread {
</a><a href="#h74-0-59" id="h74-0-59" class="i">+            val addedTimestamp: Long = profile.addedTimestamp.coerceAtLeast(profile.reverseAddedTimestamp)
</a><a href="#h74-0-60" id="h74-0-60" class="i">+            val builder = AlertDialog.Builder(context.mainActivity)
</a><a href="#h74-0-61" id="h74-0-61" class="i">+            builder.setIcon(finalIcon)
</a><a href="#h74-0-62" id="h74-0-62" class="i">+            builder.setTitle(profile.displayName)
</a><a href="#h74-0-63" id="h74-0-63" class="i">+            val birthday = Calendar.getInstance()
</a><a href="#h74-0-64" id="h74-0-64" class="i">+            birthday[Calendar.MONTH] = (profile.birthday shr 32).toInt() - 1
</a><a href="#h74-0-65" id="h74-0-65" class="i">+            val message: String = &quot;&quot;&quot;
</a><a href="#h74-0-66" id="h74-0-66" class="i">+                ${context.translation.get(&quot;info.username&quot;)}: ${profile.username}
</a><a href="#h74-0-67" id="h74-0-67" class="i">+                ${context.translation.get(&quot;info.display_name&quot;)}: ${profile.displayName}
</a><a href="#h74-0-68" id="h74-0-68" class="i">+                ${context.translation.get(&quot;info.added_date&quot;)}: ${formatDate(addedTimestamp)}
</a><a href="#h74-0-69" id="h74-0-69" class="i">+                ${birthday.getDisplayName(
</a><a href="#h74-0-70" id="h74-0-70" class="i">+                    Calendar.MONTH,
</a><a href="#h74-0-71" id="h74-0-71" class="i">+                    Calendar.LONG,
</a><a href="#h74-0-72" id="h74-0-72" class="i">+                    context.translation.getLocale()
</a><a href="#h74-0-73" id="h74-0-73" class="i">+                )?.let {
</a><a href="#h74-0-74" id="h74-0-74" class="i">+                    context.translation.get(&quot;info.birthday&quot;)
</a><a href="#h74-0-75" id="h74-0-75" class="i">+                        .replace(&quot;{month}&quot;, it)
</a><a href="#h74-0-76" id="h74-0-76" class="i">+                        .replace(&quot;{day}&quot;, profile.birthday.toInt().toString())
</a><a href="#h74-0-77" id="h74-0-77" class="i">+                }
</a><a href="#h74-0-78" id="h74-0-78" class="i">+            }
</a><a href="#h74-0-79" id="h74-0-79" class="i">+            &quot;&quot;&quot;.trimIndent()
</a><a href="#h74-0-80" id="h74-0-80" class="i">+            builder.setMessage(message)
</a><a href="#h74-0-81" id="h74-0-81" class="i">+            builder.setPositiveButton(
</a><a href="#h74-0-82" id="h74-0-82" class="i">+                &quot;OK&quot;
</a><a href="#h74-0-83" id="h74-0-83" class="i">+            ) { dialog: DialogInterface, _: Int -&gt; dialog.dismiss() }
</a><a href="#h74-0-84" id="h74-0-84" class="i">+            builder.show()
</a><a href="#h74-0-85" id="h74-0-85" class="i">+        }
</a><a href="#h74-0-86" id="h74-0-86" class="i">+    }
</a><a href="#h74-0-87" id="h74-0-87" class="i">+
</a><a href="#h74-0-88" id="h74-0-88" class="i">+    fun showPreview(userId: String?, conversationId: String, androidCtx: Context?) {
</a><a href="#h74-0-89" id="h74-0-89" class="i">+        //query message
</a><a href="#h74-0-90" id="h74-0-90" class="i">+        val messages: List&lt;ConversationMessage&gt;? = context.database.getMessagesFromConversationId(
</a><a href="#h74-0-91" id="h74-0-91" class="i">+            conversationId,
</a><a href="#h74-0-92" id="h74-0-92" class="i">+            context.config.int(ConfigProperty.MESSAGE_PREVIEW_LENGTH)
</a><a href="#h74-0-93" id="h74-0-93" class="i">+        )?.reversed()
</a><a href="#h74-0-94" id="h74-0-94" class="i">+
</a><a href="#h74-0-95" id="h74-0-95" class="i">+        if (messages == null || messages.isEmpty()) {
</a><a href="#h74-0-96" id="h74-0-96" class="i">+            Toast.makeText(androidCtx, &quot;No messages found&quot;, Toast.LENGTH_SHORT).show()
</a><a href="#h74-0-97" id="h74-0-97" class="i">+            return
</a><a href="#h74-0-98" id="h74-0-98" class="i">+        }
</a><a href="#h74-0-99" id="h74-0-99" class="i">+        val participants: Map&lt;String, FriendInfo&gt; = context.database.getConversationParticipants(conversationId)!!
</a><a href="#h74-0-100" id="h74-0-100" class="i">+            .map { context.database.getFriendInfo(it)!! }
</a><a href="#h74-0-101" id="h74-0-101" class="i">+            .associateBy { it.userId!! }
</a><a href="#h74-0-102" id="h74-0-102" class="i">+        
</a><a href="#h74-0-103" id="h74-0-103" class="i">+        val messageBuilder = StringBuilder()
</a><a href="#h74-0-104" id="h74-0-104" class="i">+
</a><a href="#h74-0-105" id="h74-0-105" class="i">+        messages.forEach{ message: ConversationMessage -&gt;
</a><a href="#h74-0-106" id="h74-0-106" class="i">+            val sender: FriendInfo? = participants[message.sender_id]
</a><a href="#h74-0-107" id="h74-0-107" class="i">+
</a><a href="#h74-0-108" id="h74-0-108" class="i">+            var messageString: String = message.getMessageAsString() ?: ContentType.fromId(message.content_type).name
</a><a href="#h74-0-109" id="h74-0-109" class="i">+
</a><a href="#h74-0-110" id="h74-0-110" class="i">+            if (message.content_type == ContentType.SNAP.id) {
</a><a href="#h74-0-111" id="h74-0-111" class="i">+                val readTimeStamp: Long = message.read_timestamp
</a><a href="#h74-0-112" id="h74-0-112" class="i">+                messageString = &quot;\uD83D\uDFE5&quot; //red square
</a><a href="#h74-0-113" id="h74-0-113" class="i">+                if (readTimeStamp &gt; 0) {
</a><a href="#h74-0-114" id="h74-0-114" class="i">+                    messageString += &quot; \uD83D\uDC40 &quot; //eyes
</a><a href="#h74-0-115" id="h74-0-115" class="i">+                    messageString += DateFormat.getDateTimeInstance(
</a><a href="#h74-0-116" id="h74-0-116" class="i">+                        DateFormat.SHORT,
</a><a href="#h74-0-117" id="h74-0-117" class="i">+                        DateFormat.SHORT
</a><a href="#h74-0-118" id="h74-0-118" class="i">+                    ).format(Date(readTimeStamp))
</a><a href="#h74-0-119" id="h74-0-119" class="i">+                }
</a><a href="#h74-0-120" id="h74-0-120" class="i">+            }
</a><a href="#h74-0-121" id="h74-0-121" class="i">+
</a><a href="#h74-0-122" id="h74-0-122" class="i">+            var displayUsername = sender?.displayName ?: &quot;Unknown user&quot;
</a><a href="#h74-0-123" id="h74-0-123" class="i">+
</a><a href="#h74-0-124" id="h74-0-124" class="i">+            if (displayUsername.length &gt; 12) {
</a><a href="#h74-0-125" id="h74-0-125" class="i">+                displayUsername = displayUsername.substring(0, 13) + &quot;... &quot;
</a><a href="#h74-0-126" id="h74-0-126" class="i">+            }
</a><a href="#h74-0-127" id="h74-0-127" class="i">+
</a><a href="#h74-0-128" id="h74-0-128" class="i">+            messageBuilder.append(displayUsername).append(&quot;: &quot;).append(messageString).append(&quot;\n&quot;)
</a><a href="#h74-0-129" id="h74-0-129" class="i">+        }
</a><a href="#h74-0-130" id="h74-0-130" class="i">+
</a><a href="#h74-0-131" id="h74-0-131" class="i">+        val targetPerson: FriendInfo? =
</a><a href="#h74-0-132" id="h74-0-132" class="i">+            if (userId == null) null else participants[userId]
</a><a href="#h74-0-133" id="h74-0-133" class="i">+
</a><a href="#h74-0-134" id="h74-0-134" class="i">+        targetPerson?.let {
</a><a href="#h74-0-135" id="h74-0-135" class="i">+            val timeSecondDiff = ((it.streakExpirationTimestamp - System.currentTimeMillis()) / 1000 / 60).toInt()
</a><a href="#h74-0-136" id="h74-0-136" class="i">+            messageBuilder.append(&quot;\n\n&quot;)
</a><a href="#h74-0-137" id="h74-0-137" class="i">+                .append(&quot;\uD83D\uDD25 &quot;) //fire emoji
</a><a href="#h74-0-138" id="h74-0-138" class="i">+                .append(context.translation.get(&quot;streak_expiration&quot;).format(
</a><a href="#h74-0-139" id="h74-0-139" class="i">+                    timeSecondDiff / 60 / 24,
</a><a href="#h74-0-140" id="h74-0-140" class="i">+                    timeSecondDiff / 60 % 24,
</a><a href="#h74-0-141" id="h74-0-141" class="i">+                    timeSecondDiff % 60
</a><a href="#h74-0-142" id="h74-0-142" class="i">+                ))
</a><a href="#h74-0-143" id="h74-0-143" class="i">+        }
</a><a href="#h74-0-144" id="h74-0-144" class="i">+
</a><a href="#h74-0-145" id="h74-0-145" class="i">+        //alert dialog
</a><a href="#h74-0-146" id="h74-0-146" class="i">+        val builder = AlertDialog.Builder(context.mainActivity)
</a><a href="#h74-0-147" id="h74-0-147" class="i">+        builder.setTitle(context.translation.get(&quot;preview&quot;))
</a><a href="#h74-0-148" id="h74-0-148" class="i">+        builder.setMessage(messageBuilder.toString())
</a><a href="#h74-0-149" id="h74-0-149" class="i">+        builder.setPositiveButton(
</a><a href="#h74-0-150" id="h74-0-150" class="i">+            &quot;OK&quot;
</a><a href="#h74-0-151" id="h74-0-151" class="i">+        ) { dialog: DialogInterface, _: Int -&gt; dialog.dismiss() }
</a><a href="#h74-0-152" id="h74-0-152" class="i">+        targetPerson?.let {
</a><a href="#h74-0-153" id="h74-0-153" class="i">+            builder.setNegativeButton(context.translation.get(&quot;profile_info&quot;)) {_, _ -&gt;
</a><a href="#h74-0-154" id="h74-0-154" class="i">+                context.executeAsync {
</a><a href="#h74-0-155" id="h74-0-155" class="i">+                    showProfileInfo(it)
</a><a href="#h74-0-156" id="h74-0-156" class="i">+                }
</a><a href="#h74-0-157" id="h74-0-157" class="i">+            }
</a><a href="#h74-0-158" id="h74-0-158" class="i">+        }
</a><a href="#h74-0-159" id="h74-0-159" class="i">+        builder.show()
</a><a href="#h74-0-160" id="h74-0-160" class="i">+    }
</a><a href="#h74-0-161" id="h74-0-161" class="i">+
</a><a href="#h74-0-162" id="h74-0-162" class="i">+    @SuppressLint(&quot;SetTextI18n&quot;, &quot;UseSwitchCompatOrMaterialCode&quot;, &quot;DefaultLocale&quot;)
</a><a href="#h74-0-163" id="h74-0-163" class="i">+    fun inject(viewModel: View, viewConsumer: ((View) -&gt; Unit)) {
</a><a href="#h74-0-164" id="h74-0-164" class="i">+        val messaging = context.feature(Messaging::class)
</a><a href="#h74-0-165" id="h74-0-165" class="i">+        var focusedConversationTargetUser: String? = null
</a><a href="#h74-0-166" id="h74-0-166" class="i">+        val conversationId: String
</a><a href="#h74-0-167" id="h74-0-167" class="i">+        if (messaging.lastFetchConversationUserUUID != null) {
</a><a href="#h74-0-168" id="h74-0-168" class="i">+            focusedConversationTargetUser = messaging.lastFetchConversationUserUUID.toString()
</a><a href="#h74-0-169" id="h74-0-169" class="i">+            val conversation: UserConversationLink = context.database.getDMConversationIdFromUserId(focusedConversationTargetUser) ?: return
</a><a href="#h74-0-170" id="h74-0-170" class="i">+            conversationId = conversation.client_conversation_id!!.trim().lowercase()
</a><a href="#h74-0-171" id="h74-0-171" class="i">+        } else {
</a><a href="#h74-0-172" id="h74-0-172" class="i">+            conversationId = messaging.lastFetchConversationUUID.toString()
</a><a href="#h74-0-173" id="h74-0-173" class="i">+        }
</a><a href="#h74-0-174" id="h74-0-174" class="i">+
</a><a href="#h74-0-175" id="h74-0-175" class="i">+        //preview button
</a><a href="#h74-0-176" id="h74-0-176" class="i">+        val previewButton = Button(viewModel.context)
</a><a href="#h74-0-177" id="h74-0-177" class="i">+        previewButton.text = context.translation.get(&quot;preview&quot;)
</a><a href="#h74-0-178" id="h74-0-178" class="i">+        applyTheme(viewModel, previewButton)
</a><a href="#h74-0-179" id="h74-0-179" class="i">+        val finalFocusedConversationTargetUser = focusedConversationTargetUser
</a><a href="#h74-0-180" id="h74-0-180" class="i">+        previewButton.setOnClickListener { v: View? -&gt;
</a><a href="#h74-0-181" id="h74-0-181" class="i">+            showPreview(
</a><a href="#h74-0-182" id="h74-0-182" class="i">+                finalFocusedConversationTargetUser,
</a><a href="#h74-0-183" id="h74-0-183" class="i">+                conversationId,
</a><a href="#h74-0-184" id="h74-0-184" class="i">+                previewButton.context
</a><a href="#h74-0-185" id="h74-0-185" class="i">+            )
</a><a href="#h74-0-186" id="h74-0-186" class="i">+        }
</a><a href="#h74-0-187" id="h74-0-187" class="i">+
</a><a href="#h74-0-188" id="h74-0-188" class="i">+        //export conversation
</a><a href="#h74-0-189" id="h74-0-189" class="i">+        /*val exportButton = Button(viewModel.context)
</a><a href="#h74-0-190" id="h74-0-190" class="i">+        exportButton.setText(context.translation.get(&quot;conversation_export&quot;))
</a><a href="#h74-0-191" id="h74-0-191" class="i">+        applyTheme(viewModel, exportButton)
</a><a href="#h74-0-192" id="h74-0-192" class="i">+        exportButton.setOnClickListener { event: View? -&gt;
</a><a href="#h74-0-193" id="h74-0-193" class="i">+            conversationExport.exportConversation(
</a><a href="#h74-0-194" id="h74-0-194" class="i">+                SnapUUID(conversationId)
</a><a href="#h74-0-195" id="h74-0-195" class="i">+            )
</a><a href="#h74-0-196" id="h74-0-196" class="i">+        }*/
</a><a href="#h74-0-197" id="h74-0-197" class="i">+
</a><a href="#h74-0-198" id="h74-0-198" class="i">+        //stealth switch
</a><a href="#h74-0-199" id="h74-0-199" class="i">+        val stealthSwitch = Switch(viewModel.context)
</a><a href="#h74-0-200" id="h74-0-200" class="i">+        stealthSwitch.text = context.translation.get(&quot;stealth_mode&quot;)
</a><a href="#h74-0-201" id="h74-0-201" class="i">+        stealthSwitch.isChecked = context.feature(StealthMode::class).isStealth(conversationId)
</a><a href="#h74-0-202" id="h74-0-202" class="i">+        applyTheme(viewModel, stealthSwitch)
</a><a href="#h74-0-203" id="h74-0-203" class="i">+        stealthSwitch.setOnCheckedChangeListener { _: CompoundButton?, isChecked: Boolean -&gt;
</a><a href="#h74-0-204" id="h74-0-204" class="i">+            context.feature(StealthMode::class).setStealth(
</a><a href="#h74-0-205" id="h74-0-205" class="i">+                conversationId,
</a><a href="#h74-0-206" id="h74-0-206" class="i">+                isChecked
</a><a href="#h74-0-207" id="h74-0-207" class="i">+            )
</a><a href="#h74-0-208" id="h74-0-208" class="i">+        }
</a><a href="#h74-0-209" id="h74-0-209" class="i">+
</a><a href="#h74-0-210" id="h74-0-210" class="i">+        /*//click to delete switch
</a><a href="#h74-0-211" id="h74-0-211" class="i">+        val clickToDeleteSwitch = Switch(viewModel.context)
</a><a href="#h74-0-212" id="h74-0-212" class="i">+        clickToDeleteSwitch.setText(context.translation.get(&quot;click_to_delete&quot;))
</a><a href="#h74-0-213" id="h74-0-213" class="i">+        clickToDeleteSwitch.isChecked = clickToDelete.isClickToDelete(conversationId)
</a><a href="#h74-0-214" id="h74-0-214" class="i">+        applyTheme(viewModel, clickToDeleteSwitch)
</a><a href="#h74-0-215" id="h74-0-215" class="i">+        clickToDeleteSwitch.setOnCheckedChangeListener { buttonView: CompoundButton?, isChecked: Boolean -&gt;
</a><a href="#h74-0-216" id="h74-0-216" class="i">+            clickToDelete.setClickToDelete(
</a><a href="#h74-0-217" id="h74-0-217" class="i">+                conversationId,
</a><a href="#h74-0-218" id="h74-0-218" class="i">+                isChecked
</a><a href="#h74-0-219" id="h74-0-219" class="i">+            )
</a><a href="#h74-0-220" id="h74-0-220" class="i">+        }*/
</a><a href="#h74-0-221" id="h74-0-221" class="i">+       /* if (configManager.getBoolean(ConfigCategory.EXTRAS, &quot;conversation_export&quot;)
</a><a href="#h74-0-222" id="h74-0-222" class="i">+                .isState()
</a><a href="#h74-0-223" id="h74-0-223" class="i">+        ) viewConsumer.accept(exportButton)
</a><a href="#h74-0-224" id="h74-0-224" class="i">+        if (configManager.getBoolean(ConfigCategory.PRIVACY, &quot;click_to_delete&quot;)
</a><a href="#h74-0-225" id="h74-0-225" class="i">+                .isState()
</a><a href="#h74-0-226" id="h74-0-226" class="i">+        ) viewConsumer.accept(clickToDeleteSwitch)*/
</a><a href="#h74-0-227" id="h74-0-227" class="i">+        viewConsumer(stealthSwitch)
</a><a href="#h74-0-228" id="h74-0-228" class="i">+        viewConsumer(previewButton)
</a><a href="#h74-0-229" id="h74-0-229" class="i">+    }
</a><a href="#h74-0-230" id="h74-0-230" class="i">+}</a><a href="#h74-0-231" id="h74-0-231" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h75" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/menus/impl/OperaContextActionMenu.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/menus/impl/OperaContextActionMenu.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/menus/impl/OperaContextActionMenu.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/menus/impl/OperaContextActionMenu.kt</a></b>
<a href="#h75-0" id="h75-0" class="h">@@ -0,0 +1,82 @@
</a><a href="#h75-0-0" id="h75-0-0" class="i">+package me.rhunk.snapenhance.features.impl.ui.menus.impl
</a><a href="#h75-0-1" id="h75-0-1" class="i">+
</a><a href="#h75-0-2" id="h75-0-2" class="i">+import android.annotation.SuppressLint
</a><a href="#h75-0-3" id="h75-0-3" class="i">+import android.view.Gravity
</a><a href="#h75-0-4" id="h75-0-4" class="i">+import android.view.View
</a><a href="#h75-0-5" id="h75-0-5" class="i">+import android.view.ViewGroup
</a><a href="#h75-0-6" id="h75-0-6" class="i">+import android.widget.Button
</a><a href="#h75-0-7" id="h75-0-7" class="i">+import android.widget.LinearLayout
</a><a href="#h75-0-8" id="h75-0-8" class="i">+import android.widget.ScrollView
</a><a href="#h75-0-9" id="h75-0-9" class="i">+import de.robv.android.xposed.XposedBridge
</a><a href="#h75-0-10" id="h75-0-10" class="i">+import me.rhunk.snapenhance.Constants
</a><a href="#h75-0-11" id="h75-0-11" class="i">+import me.rhunk.snapenhance.Logger
</a><a href="#h75-0-12" id="h75-0-12" class="i">+import me.rhunk.snapenhance.features.impl.downloader.MediaDownloader
</a><a href="#h75-0-13" id="h75-0-13" class="i">+import me.rhunk.snapenhance.features.impl.ui.menus.AbstractMenu
</a><a href="#h75-0-14" id="h75-0-14" class="i">+import me.rhunk.snapenhance.features.impl.ui.menus.ViewAppearanceHelper.applyTheme
</a><a href="#h75-0-15" id="h75-0-15" class="i">+
</a><a href="#h75-0-16" id="h75-0-16" class="i">+class OperaContextActionMenu : AbstractMenu() {
</a><a href="#h75-0-17" id="h75-0-17" class="i">+    private val contextCardsScrollView by lazy {
</a><a href="#h75-0-18" id="h75-0-18" class="i">+        context.resources.getIdentifier(&quot;context_cards_scroll_view&quot;, &quot;id&quot;, Constants.SNAPCHAT_PACKAGE_NAME)
</a><a href="#h75-0-19" id="h75-0-19" class="i">+    }
</a><a href="#h75-0-20" id="h75-0-20" class="i">+
</a><a href="#h75-0-21" id="h75-0-21" class="i">+    /*
</a><a href="#h75-0-22" id="h75-0-22" class="i">+    LinearLayout :
</a><a href="#h75-0-23" id="h75-0-23" class="i">+        - LinearLayout:
</a><a href="#h75-0-24" id="h75-0-24" class="i">+            - SnapFontTextView
</a><a href="#h75-0-25" id="h75-0-25" class="i">+            - ImageView
</a><a href="#h75-0-26" id="h75-0-26" class="i">+        - LinearLayout:
</a><a href="#h75-0-27" id="h75-0-27" class="i">+            - SnapFontTextView
</a><a href="#h75-0-28" id="h75-0-28" class="i">+            - ImageView
</a><a href="#h75-0-29" id="h75-0-29" class="i">+        - LinearLayout:
</a><a href="#h75-0-30" id="h75-0-30" class="i">+            - SnapFontTextView
</a><a href="#h75-0-31" id="h75-0-31" class="i">+            - ImageView
</a><a href="#h75-0-32" id="h75-0-32" class="i">+     */
</a><a href="#h75-0-33" id="h75-0-33" class="i">+    private fun isViewGroupButtonMenuContainer(viewGroup: ViewGroup): Boolean {
</a><a href="#h75-0-34" id="h75-0-34" class="i">+        if (viewGroup !is LinearLayout) return false
</a><a href="#h75-0-35" id="h75-0-35" class="i">+        val children = ArrayList&lt;View&gt;()
</a><a href="#h75-0-36" id="h75-0-36" class="i">+        for (i in 0 until viewGroup.getChildCount())
</a><a href="#h75-0-37" id="h75-0-37" class="i">+            children.add(viewGroup.getChildAt(i))
</a><a href="#h75-0-38" id="h75-0-38" class="i">+        return if (children.any { view: View? -&gt; view !is LinearLayout })
</a><a href="#h75-0-39" id="h75-0-39" class="i">+            false
</a><a href="#h75-0-40" id="h75-0-40" class="i">+        else children.map { view: View -&gt; view as LinearLayout }
</a><a href="#h75-0-41" id="h75-0-41" class="i">+            .any { linearLayout: LinearLayout -&gt;
</a><a href="#h75-0-42" id="h75-0-42" class="i">+                val viewChildren = ArrayList&lt;View&gt;()
</a><a href="#h75-0-43" id="h75-0-43" class="i">+                for (i in 0 until linearLayout.childCount) viewChildren.add(
</a><a href="#h75-0-44" id="h75-0-44" class="i">+                    linearLayout.getChildAt(
</a><a href="#h75-0-45" id="h75-0-45" class="i">+                        i
</a><a href="#h75-0-46" id="h75-0-46" class="i">+                    )
</a><a href="#h75-0-47" id="h75-0-47" class="i">+                )
</a><a href="#h75-0-48" id="h75-0-48" class="i">+                viewChildren.any { viewChild: View -&gt;
</a><a href="#h75-0-49" id="h75-0-49" class="i">+                    viewChild.javaClass.name.endsWith(&quot;SnapFontTextView&quot;)
</a><a href="#h75-0-50" id="h75-0-50" class="i">+                }
</a><a href="#h75-0-51" id="h75-0-51" class="i">+            }
</a><a href="#h75-0-52" id="h75-0-52" class="i">+    }
</a><a href="#h75-0-53" id="h75-0-53" class="i">+
</a><a href="#h75-0-54" id="h75-0-54" class="i">+    @SuppressLint(&quot;SetTextI18n&quot;)
</a><a href="#h75-0-55" id="h75-0-55" class="i">+    fun inject(viewGroup: ViewGroup, childView: View) {
</a><a href="#h75-0-56" id="h75-0-56" class="i">+        try {
</a><a href="#h75-0-57" id="h75-0-57" class="i">+            if (viewGroup.parent !is ScrollView) return
</a><a href="#h75-0-58" id="h75-0-58" class="i">+            val parent = viewGroup.parent as ScrollView
</a><a href="#h75-0-59" id="h75-0-59" class="i">+            if (parent.id != contextCardsScrollView) return
</a><a href="#h75-0-60" id="h75-0-60" class="i">+            if (childView !is LinearLayout) return
</a><a href="#h75-0-61" id="h75-0-61" class="i">+            if (!isViewGroupButtonMenuContainer(childView as ViewGroup)) return
</a><a href="#h75-0-62" id="h75-0-62" class="i">+
</a><a href="#h75-0-63" id="h75-0-63" class="i">+            val linearLayout = LinearLayout(childView.getContext())
</a><a href="#h75-0-64" id="h75-0-64" class="i">+            linearLayout.orientation = LinearLayout.VERTICAL
</a><a href="#h75-0-65" id="h75-0-65" class="i">+            linearLayout.gravity = Gravity.CENTER
</a><a href="#h75-0-66" id="h75-0-66" class="i">+            linearLayout.layoutParams =
</a><a href="#h75-0-67" id="h75-0-67" class="i">+                LinearLayout.LayoutParams(
</a><a href="#h75-0-68" id="h75-0-68" class="i">+                    ViewGroup.LayoutParams.MATCH_PARENT,
</a><a href="#h75-0-69" id="h75-0-69" class="i">+                    ViewGroup.LayoutParams.MATCH_PARENT
</a><a href="#h75-0-70" id="h75-0-70" class="i">+                )
</a><a href="#h75-0-71" id="h75-0-71" class="i">+            val button = Button(childView.getContext())
</a><a href="#h75-0-72" id="h75-0-72" class="i">+            button.text = context.translation.get(&quot;download_opera&quot;)
</a><a href="#h75-0-73" id="h75-0-73" class="i">+            button.setOnClickListener { context.feature(MediaDownloader::class).downloadLastOperaMediaAsync() }
</a><a href="#h75-0-74" id="h75-0-74" class="i">+            applyTheme(linearLayout, button)
</a><a href="#h75-0-75" id="h75-0-75" class="i">+            linearLayout.addView(button)
</a><a href="#h75-0-76" id="h75-0-76" class="i">+            (childView as ViewGroup).addView(linearLayout, 0)
</a><a href="#h75-0-77" id="h75-0-77" class="i">+        } catch (e: Throwable) {
</a><a href="#h75-0-78" id="h75-0-78" class="i">+            Logger.xposedLog(e)
</a><a href="#h75-0-79" id="h75-0-79" class="i">+        }
</a><a href="#h75-0-80" id="h75-0-80" class="i">+    }
</a><a href="#h75-0-81" id="h75-0-81" class="i">+}
</a><b>diff --git a/<a id="h76" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/menus/impl/SettingsMenu.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/menus/impl/SettingsMenu.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/menus/impl/SettingsMenu.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/features/impl/ui/menus/impl/SettingsMenu.kt</a></b>
<a href="#h76-0" id="h76-0" class="h">@@ -0,0 +1,133 @@
</a><a href="#h76-0-0" id="h76-0-0" class="i">+package me.rhunk.snapenhance.features.impl.ui.menus.impl
</a><a href="#h76-0-1" id="h76-0-1" class="i">+
</a><a href="#h76-0-2" id="h76-0-2" class="i">+import android.annotation.SuppressLint
</a><a href="#h76-0-3" id="h76-0-3" class="i">+import android.app.AlertDialog
</a><a href="#h76-0-4" id="h76-0-4" class="i">+import android.text.InputType
</a><a href="#h76-0-5" id="h76-0-5" class="i">+import android.view.View
</a><a href="#h76-0-6" id="h76-0-6" class="i">+import android.widget.Button
</a><a href="#h76-0-7" id="h76-0-7" class="i">+import android.widget.EditText
</a><a href="#h76-0-8" id="h76-0-8" class="i">+import android.widget.Switch
</a><a href="#h76-0-9" id="h76-0-9" class="i">+import android.widget.TextView
</a><a href="#h76-0-10" id="h76-0-10" class="i">+import me.rhunk.snapenhance.BuildConfig
</a><a href="#h76-0-11" id="h76-0-11" class="i">+import me.rhunk.snapenhance.Constants
</a><a href="#h76-0-12" id="h76-0-12" class="i">+import me.rhunk.snapenhance.config.ConfigProperty
</a><a href="#h76-0-13" id="h76-0-13" class="i">+import me.rhunk.snapenhance.features.impl.ui.menus.AbstractMenu
</a><a href="#h76-0-14" id="h76-0-14" class="i">+import me.rhunk.snapenhance.features.impl.ui.menus.ViewAppearanceHelper
</a><a href="#h76-0-15" id="h76-0-15" class="i">+
</a><a href="#h76-0-16" id="h76-0-16" class="i">+class SettingsMenu : AbstractMenu() {
</a><a href="#h76-0-17" id="h76-0-17" class="i">+    private fun createCategoryTitle(viewModel: View, key: String): TextView {
</a><a href="#h76-0-18" id="h76-0-18" class="i">+        val categoryText = TextView(viewModel.context)
</a><a href="#h76-0-19" id="h76-0-19" class="i">+        categoryText.text = context.translation.get(key)
</a><a href="#h76-0-20" id="h76-0-20" class="i">+        ViewAppearanceHelper.applyTheme(viewModel, categoryText)
</a><a href="#h76-0-21" id="h76-0-21" class="i">+        categoryText.textSize = 18f
</a><a href="#h76-0-22" id="h76-0-22" class="i">+        return categoryText
</a><a href="#h76-0-23" id="h76-0-23" class="i">+    }
</a><a href="#h76-0-24" id="h76-0-24" class="i">+
</a><a href="#h76-0-25" id="h76-0-25" class="i">+    @SuppressLint(&quot;SetTextI18n&quot;)
</a><a href="#h76-0-26" id="h76-0-26" class="i">+    private fun createPropertyView(viewModel: View, property: ConfigProperty): View {
</a><a href="#h76-0-27" id="h76-0-27" class="i">+        val updateButtonText: (TextView, String) -&gt; Unit = { textView, text -&gt;
</a><a href="#h76-0-28" id="h76-0-28" class="i">+            textView.text = &quot;${context.translation.get(property.nameKey)} $text&quot;
</a><a href="#h76-0-29" id="h76-0-29" class="i">+        }
</a><a href="#h76-0-30" id="h76-0-30" class="i">+
</a><a href="#h76-0-31" id="h76-0-31" class="i">+        val textEditor: ((String) -&gt; Unit) -&gt; Unit = { updateValue -&gt;
</a><a href="#h76-0-32" id="h76-0-32" class="i">+            val builder = AlertDialog.Builder(viewModel.context)
</a><a href="#h76-0-33" id="h76-0-33" class="i">+            builder.setTitle(context.translation.get(property.nameKey))
</a><a href="#h76-0-34" id="h76-0-34" class="i">+
</a><a href="#h76-0-35" id="h76-0-35" class="i">+            val input = EditText(viewModel.context)
</a><a href="#h76-0-36" id="h76-0-36" class="i">+            input.inputType = InputType.TYPE_CLASS_TEXT
</a><a href="#h76-0-37" id="h76-0-37" class="i">+            input.setText(context.config.string(property))
</a><a href="#h76-0-38" id="h76-0-38" class="i">+
</a><a href="#h76-0-39" id="h76-0-39" class="i">+            builder.setView(input)
</a><a href="#h76-0-40" id="h76-0-40" class="i">+            builder.setPositiveButton(&quot;OK&quot;) { _, _ -&gt;
</a><a href="#h76-0-41" id="h76-0-41" class="i">+                updateValue(input.text.toString())
</a><a href="#h76-0-42" id="h76-0-42" class="i">+            }
</a><a href="#h76-0-43" id="h76-0-43" class="i">+
</a><a href="#h76-0-44" id="h76-0-44" class="i">+            builder.setNegativeButton(&quot;Cancel&quot;) { dialog, _ -&gt; dialog.cancel() }
</a><a href="#h76-0-45" id="h76-0-45" class="i">+            builder.show()
</a><a href="#h76-0-46" id="h76-0-46" class="i">+        }
</a><a href="#h76-0-47" id="h76-0-47" class="i">+
</a><a href="#h76-0-48" id="h76-0-48" class="i">+        val resultView: View = when (property.defaultValue) {
</a><a href="#h76-0-49" id="h76-0-49" class="i">+            is String -&gt; {
</a><a href="#h76-0-50" id="h76-0-50" class="i">+                val textView = TextView(viewModel.context)
</a><a href="#h76-0-51" id="h76-0-51" class="i">+                updateButtonText(textView, context.config.string(property))
</a><a href="#h76-0-52" id="h76-0-52" class="i">+                ViewAppearanceHelper.applyTheme(viewModel, textView)
</a><a href="#h76-0-53" id="h76-0-53" class="i">+                textView.setOnClickListener {
</a><a href="#h76-0-54" id="h76-0-54" class="i">+                    textEditor { value -&gt;
</a><a href="#h76-0-55" id="h76-0-55" class="i">+                        context.config.set(property, value)
</a><a href="#h76-0-56" id="h76-0-56" class="i">+                        updateButtonText(textView, value)
</a><a href="#h76-0-57" id="h76-0-57" class="i">+                    }
</a><a href="#h76-0-58" id="h76-0-58" class="i">+                }
</a><a href="#h76-0-59" id="h76-0-59" class="i">+                textView
</a><a href="#h76-0-60" id="h76-0-60" class="i">+            }
</a><a href="#h76-0-61" id="h76-0-61" class="i">+            is Number -&gt; {
</a><a href="#h76-0-62" id="h76-0-62" class="i">+                val button = Button(viewModel.context)
</a><a href="#h76-0-63" id="h76-0-63" class="i">+                updateButtonText(button, context.config.get(property).toString())
</a><a href="#h76-0-64" id="h76-0-64" class="i">+                button.setOnClickListener {
</a><a href="#h76-0-65" id="h76-0-65" class="i">+                    textEditor { value -&gt;
</a><a href="#h76-0-66" id="h76-0-66" class="i">+                        runCatching {
</a><a href="#h76-0-67" id="h76-0-67" class="i">+                            context.config.set(property, when (property.defaultValue) {
</a><a href="#h76-0-68" id="h76-0-68" class="i">+                                is Int -&gt; value.toInt()
</a><a href="#h76-0-69" id="h76-0-69" class="i">+                                is Double -&gt; value.toDouble()
</a><a href="#h76-0-70" id="h76-0-70" class="i">+                                is Float -&gt; value.toFloat()
</a><a href="#h76-0-71" id="h76-0-71" class="i">+                                is Long -&gt; value.toLong()
</a><a href="#h76-0-72" id="h76-0-72" class="i">+                                is Short -&gt; value.toShort()
</a><a href="#h76-0-73" id="h76-0-73" class="i">+                                is Byte -&gt; value.toByte()
</a><a href="#h76-0-74" id="h76-0-74" class="i">+                                else -&gt; throw IllegalArgumentException()
</a><a href="#h76-0-75" id="h76-0-75" class="i">+                            })
</a><a href="#h76-0-76" id="h76-0-76" class="i">+                            updateButtonText(button, value)
</a><a href="#h76-0-77" id="h76-0-77" class="i">+                        }.onFailure {
</a><a href="#h76-0-78" id="h76-0-78" class="i">+                            context.shortToast(&quot;Invalid value&quot;)
</a><a href="#h76-0-79" id="h76-0-79" class="i">+                        }
</a><a href="#h76-0-80" id="h76-0-80" class="i">+                    }
</a><a href="#h76-0-81" id="h76-0-81" class="i">+                }
</a><a href="#h76-0-82" id="h76-0-82" class="i">+                ViewAppearanceHelper.applyTheme(viewModel, button)
</a><a href="#h76-0-83" id="h76-0-83" class="i">+                button
</a><a href="#h76-0-84" id="h76-0-84" class="i">+            }
</a><a href="#h76-0-85" id="h76-0-85" class="i">+            is Boolean -&gt; {
</a><a href="#h76-0-86" id="h76-0-86" class="i">+                val switch = Switch(viewModel.context)
</a><a href="#h76-0-87" id="h76-0-87" class="i">+                switch.text = context.translation.get(property.nameKey)
</a><a href="#h76-0-88" id="h76-0-88" class="i">+                switch.isChecked = context.config.bool(property)
</a><a href="#h76-0-89" id="h76-0-89" class="i">+                switch.setOnCheckedChangeListener { _, isChecked -&gt;
</a><a href="#h76-0-90" id="h76-0-90" class="i">+                    context.config.set(property, isChecked)
</a><a href="#h76-0-91" id="h76-0-91" class="i">+                }
</a><a href="#h76-0-92" id="h76-0-92" class="i">+                ViewAppearanceHelper.applyTheme(viewModel, switch)
</a><a href="#h76-0-93" id="h76-0-93" class="i">+                switch
</a><a href="#h76-0-94" id="h76-0-94" class="i">+            }
</a><a href="#h76-0-95" id="h76-0-95" class="i">+            else -&gt; {
</a><a href="#h76-0-96" id="h76-0-96" class="i">+                TextView(viewModel.context)
</a><a href="#h76-0-97" id="h76-0-97" class="i">+            }
</a><a href="#h76-0-98" id="h76-0-98" class="i">+        }
</a><a href="#h76-0-99" id="h76-0-99" class="i">+        return resultView
</a><a href="#h76-0-100" id="h76-0-100" class="i">+    }
</a><a href="#h76-0-101" id="h76-0-101" class="i">+
</a><a href="#h76-0-102" id="h76-0-102" class="i">+    @SuppressLint(&quot;SetTextI18n&quot;)
</a><a href="#h76-0-103" id="h76-0-103" class="i">+    fun inject(viewModel: View, addView: (View) -&gt; Unit) {
</a><a href="#h76-0-104" id="h76-0-104" class="i">+        val packageInfo = viewModel.context.packageManager.getPackageInfo(
</a><a href="#h76-0-105" id="h76-0-105" class="i">+            Constants.SNAPCHAT_PACKAGE_NAME,
</a><a href="#h76-0-106" id="h76-0-106" class="i">+            0
</a><a href="#h76-0-107" id="h76-0-107" class="i">+        )
</a><a href="#h76-0-108" id="h76-0-108" class="i">+        val versionTextBuilder = StringBuilder()
</a><a href="#h76-0-109" id="h76-0-109" class="i">+        versionTextBuilder.append(&quot;SnapEnhance &quot;).append(BuildConfig.VERSION_NAME)
</a><a href="#h76-0-110" id="h76-0-110" class="i">+            .append(&quot; by rhunk&quot;)
</a><a href="#h76-0-111" id="h76-0-111" class="i">+        if (BuildConfig.DEBUG) {
</a><a href="#h76-0-112" id="h76-0-112" class="i">+            versionTextBuilder.append(&quot;\n&quot;).append(&quot;Snapchat &quot;).append(packageInfo.versionName)
</a><a href="#h76-0-113" id="h76-0-113" class="i">+                .append(&quot; (&quot;).append(packageInfo.longVersionCode).append(&quot;)&quot;)
</a><a href="#h76-0-114" id="h76-0-114" class="i">+        }
</a><a href="#h76-0-115" id="h76-0-115" class="i">+        val titleText = TextView(viewModel.context)
</a><a href="#h76-0-116" id="h76-0-116" class="i">+        titleText.text = versionTextBuilder.toString()
</a><a href="#h76-0-117" id="h76-0-117" class="i">+        ViewAppearanceHelper.applyTheme(viewModel, titleText)
</a><a href="#h76-0-118" id="h76-0-118" class="i">+        titleText.textSize = 18f
</a><a href="#h76-0-119" id="h76-0-119" class="i">+        titleText.minHeight = 80 * versionTextBuilder.chars().filter { ch: Int -&gt; ch == &#39;\n&#39;.code }
</a><a href="#h76-0-120" id="h76-0-120" class="i">+                .count().coerceAtLeast(2).toInt()
</a><a href="#h76-0-121" id="h76-0-121" class="i">+        addView(titleText)
</a><a href="#h76-0-122" id="h76-0-122" class="i">+
</a><a href="#h76-0-123" id="h76-0-123" class="i">+        context.config.entries().groupBy {
</a><a href="#h76-0-124" id="h76-0-124" class="i">+            it.key.category
</a><a href="#h76-0-125" id="h76-0-125" class="i">+        }.forEach { (category, value) -&gt;
</a><a href="#h76-0-126" id="h76-0-126" class="i">+            addView(createCategoryTitle(viewModel, category.key))
</a><a href="#h76-0-127" id="h76-0-127" class="i">+            value.forEach {
</a><a href="#h76-0-128" id="h76-0-128" class="i">+                addView(createPropertyView(viewModel, it.key))
</a><a href="#h76-0-129" id="h76-0-129" class="i">+            }
</a><a href="#h76-0-130" id="h76-0-130" class="i">+        }
</a><a href="#h76-0-131" id="h76-0-131" class="i">+    }
</a><a href="#h76-0-132" id="h76-0-132" class="i">+}</a><a href="#h76-0-133" id="h76-0-133" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h77" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/hook/HookAdapter.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/hook/HookAdapter.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/hook/HookAdapter.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/hook/HookAdapter.kt</a></b>
<a href="#h77-0" id="h77-0" class="h">@@ -0,0 +1,72 @@
</a><a href="#h77-0-0" id="h77-0-0" class="i">+package me.rhunk.snapenhance.hook
</a><a href="#h77-0-1" id="h77-0-1" class="i">+
</a><a href="#h77-0-2" id="h77-0-2" class="i">+import de.robv.android.xposed.XC_MethodHook
</a><a href="#h77-0-3" id="h77-0-3" class="i">+import de.robv.android.xposed.XposedBridge
</a><a href="#h77-0-4" id="h77-0-4" class="i">+import java.lang.reflect.Member
</a><a href="#h77-0-5" id="h77-0-5" class="i">+import java.util.function.Consumer
</a><a href="#h77-0-6" id="h77-0-6" class="i">+
</a><a href="#h77-0-7" id="h77-0-7" class="i">+@Suppress(&quot;UNCHECKED_CAST&quot;)
</a><a href="#h77-0-8" id="h77-0-8" class="i">+class HookAdapter(
</a><a href="#h77-0-9" id="h77-0-9" class="i">+    private val methodHookParam: XC_MethodHook.MethodHookParam&lt;*&gt;
</a><a href="#h77-0-10" id="h77-0-10" class="i">+) {
</a><a href="#h77-0-11" id="h77-0-11" class="i">+    fun &lt;T : Any&gt; thisObject(): T {
</a><a href="#h77-0-12" id="h77-0-12" class="i">+        return methodHookParam.thisObject as T
</a><a href="#h77-0-13" id="h77-0-13" class="i">+    }
</a><a href="#h77-0-14" id="h77-0-14" class="i">+
</a><a href="#h77-0-15" id="h77-0-15" class="i">+    fun method(): Member {
</a><a href="#h77-0-16" id="h77-0-16" class="i">+        return methodHookParam.method
</a><a href="#h77-0-17" id="h77-0-17" class="i">+    }
</a><a href="#h77-0-18" id="h77-0-18" class="i">+
</a><a href="#h77-0-19" id="h77-0-19" class="i">+    fun &lt;T : Any&gt; arg(index: Int): T {
</a><a href="#h77-0-20" id="h77-0-20" class="i">+        return methodHookParam.args[index] as T
</a><a href="#h77-0-21" id="h77-0-21" class="i">+    }
</a><a href="#h77-0-22" id="h77-0-22" class="i">+
</a><a href="#h77-0-23" id="h77-0-23" class="i">+    fun &lt;T : Any&gt; argNullable(index: Int): T? {
</a><a href="#h77-0-24" id="h77-0-24" class="i">+        return methodHookParam.args[index] as T?
</a><a href="#h77-0-25" id="h77-0-25" class="i">+    }
</a><a href="#h77-0-26" id="h77-0-26" class="i">+
</a><a href="#h77-0-27" id="h77-0-27" class="i">+    fun setArg(index: Int, value: Any?) {
</a><a href="#h77-0-28" id="h77-0-28" class="i">+        if (index &lt; 0 || index &gt;= methodHookParam.args.size) return
</a><a href="#h77-0-29" id="h77-0-29" class="i">+        methodHookParam.args[index] = value
</a><a href="#h77-0-30" id="h77-0-30" class="i">+    }
</a><a href="#h77-0-31" id="h77-0-31" class="i">+
</a><a href="#h77-0-32" id="h77-0-32" class="i">+    fun args(): Array&lt;Any&gt; {
</a><a href="#h77-0-33" id="h77-0-33" class="i">+        return methodHookParam.args
</a><a href="#h77-0-34" id="h77-0-34" class="i">+    }
</a><a href="#h77-0-35" id="h77-0-35" class="i">+
</a><a href="#h77-0-36" id="h77-0-36" class="i">+    fun getResult(): Any? {
</a><a href="#h77-0-37" id="h77-0-37" class="i">+        return methodHookParam.result
</a><a href="#h77-0-38" id="h77-0-38" class="i">+    }
</a><a href="#h77-0-39" id="h77-0-39" class="i">+
</a><a href="#h77-0-40" id="h77-0-40" class="i">+    fun setResult(result: Any?) {
</a><a href="#h77-0-41" id="h77-0-41" class="i">+        methodHookParam.result = result
</a><a href="#h77-0-42" id="h77-0-42" class="i">+    }
</a><a href="#h77-0-43" id="h77-0-43" class="i">+
</a><a href="#h77-0-44" id="h77-0-44" class="i">+    fun setThrowable(throwable: Throwable) {
</a><a href="#h77-0-45" id="h77-0-45" class="i">+        methodHookParam.throwable = throwable
</a><a href="#h77-0-46" id="h77-0-46" class="i">+    }
</a><a href="#h77-0-47" id="h77-0-47" class="i">+
</a><a href="#h77-0-48" id="h77-0-48" class="i">+    fun throwable(): Throwable? {
</a><a href="#h77-0-49" id="h77-0-49" class="i">+        return methodHookParam.throwable
</a><a href="#h77-0-50" id="h77-0-50" class="i">+    }
</a><a href="#h77-0-51" id="h77-0-51" class="i">+
</a><a href="#h77-0-52" id="h77-0-52" class="i">+    fun invokeOriginal(): Any? {
</a><a href="#h77-0-53" id="h77-0-53" class="i">+        return XposedBridge.invokeOriginalMethod(method(), thisObject(), args())
</a><a href="#h77-0-54" id="h77-0-54" class="i">+    }
</a><a href="#h77-0-55" id="h77-0-55" class="i">+
</a><a href="#h77-0-56" id="h77-0-56" class="i">+    fun invokeOriginal(args: Array&lt;Any&gt;): Any? {
</a><a href="#h77-0-57" id="h77-0-57" class="i">+        return XposedBridge.invokeOriginalMethod(method(), thisObject(), args)
</a><a href="#h77-0-58" id="h77-0-58" class="i">+    }
</a><a href="#h77-0-59" id="h77-0-59" class="i">+
</a><a href="#h77-0-60" id="h77-0-60" class="i">+    fun invokeOriginalSafe(errorCallback: Consumer&lt;Throwable&gt;) {
</a><a href="#h77-0-61" id="h77-0-61" class="i">+        invokeOriginalSafe(args(), errorCallback)
</a><a href="#h77-0-62" id="h77-0-62" class="i">+    }
</a><a href="#h77-0-63" id="h77-0-63" class="i">+
</a><a href="#h77-0-64" id="h77-0-64" class="i">+    fun invokeOriginalSafe(args: Array&lt;Any&gt;, errorCallback: Consumer&lt;Throwable&gt;) {
</a><a href="#h77-0-65" id="h77-0-65" class="i">+        runCatching {
</a><a href="#h77-0-66" id="h77-0-66" class="i">+            setResult(XposedBridge.invokeOriginalMethod(method(), thisObject(), args))
</a><a href="#h77-0-67" id="h77-0-67" class="i">+        }.onFailure {
</a><a href="#h77-0-68" id="h77-0-68" class="i">+            errorCallback.accept(it)
</a><a href="#h77-0-69" id="h77-0-69" class="i">+        }
</a><a href="#h77-0-70" id="h77-0-70" class="i">+    }
</a><a href="#h77-0-71" id="h77-0-71" class="i">+}</a><a href="#h77-0-72" id="h77-0-72" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h78" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/hook/HookStage.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/hook/HookStage.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/hook/HookStage.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/hook/HookStage.kt</a></b>
<a href="#h78-0" id="h78-0" class="h">@@ -0,0 +1,6 @@
</a><a href="#h78-0-0" id="h78-0-0" class="i">+package me.rhunk.snapenhance.hook
</a><a href="#h78-0-1" id="h78-0-1" class="i">+
</a><a href="#h78-0-2" id="h78-0-2" class="i">+enum class HookStage {
</a><a href="#h78-0-3" id="h78-0-3" class="i">+    BEFORE,
</a><a href="#h78-0-4" id="h78-0-4" class="i">+    AFTER
</a><a href="#h78-0-5" id="h78-0-5" class="i">+}</a><a href="#h78-0-6" id="h78-0-6" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h79" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/hook/Hooker.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/hook/Hooker.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/hook/Hooker.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/hook/Hooker.kt</a></b>
<a href="#h79-0" id="h79-0" class="h">@@ -0,0 +1,94 @@
</a><a href="#h79-0-0" id="h79-0-0" class="i">+package me.rhunk.snapenhance.hook
</a><a href="#h79-0-1" id="h79-0-1" class="i">+
</a><a href="#h79-0-2" id="h79-0-2" class="i">+import de.robv.android.xposed.XC_MethodHook
</a><a href="#h79-0-3" id="h79-0-3" class="i">+import de.robv.android.xposed.XposedBridge
</a><a href="#h79-0-4" id="h79-0-4" class="i">+import java.lang.reflect.Member
</a><a href="#h79-0-5" id="h79-0-5" class="i">+
</a><a href="#h79-0-6" id="h79-0-6" class="i">+object Hooker {
</a><a href="#h79-0-7" id="h79-0-7" class="i">+    private fun newMethodHook(
</a><a href="#h79-0-8" id="h79-0-8" class="i">+        stage: HookStage,
</a><a href="#h79-0-9" id="h79-0-9" class="i">+        consumer: (HookAdapter) -&gt; Unit,
</a><a href="#h79-0-10" id="h79-0-10" class="i">+        filter: ((HookAdapter) -&gt; Boolean) = { true }
</a><a href="#h79-0-11" id="h79-0-11" class="i">+    ) = object : XC_MethodHook() {
</a><a href="#h79-0-12" id="h79-0-12" class="i">+        override fun beforeHookedMethod(param: MethodHookParam&lt;*&gt;) {
</a><a href="#h79-0-13" id="h79-0-13" class="i">+            if (stage != HookStage.BEFORE) return
</a><a href="#h79-0-14" id="h79-0-14" class="i">+            with(HookAdapter(param)) {
</a><a href="#h79-0-15" id="h79-0-15" class="i">+                if (!filter(this)) return
</a><a href="#h79-0-16" id="h79-0-16" class="i">+                consumer(this)
</a><a href="#h79-0-17" id="h79-0-17" class="i">+            }
</a><a href="#h79-0-18" id="h79-0-18" class="i">+        }
</a><a href="#h79-0-19" id="h79-0-19" class="i">+
</a><a href="#h79-0-20" id="h79-0-20" class="i">+        override fun afterHookedMethod(param: MethodHookParam&lt;*&gt;) {
</a><a href="#h79-0-21" id="h79-0-21" class="i">+            if (stage != HookStage.AFTER) return
</a><a href="#h79-0-22" id="h79-0-22" class="i">+            with(HookAdapter(param)) {
</a><a href="#h79-0-23" id="h79-0-23" class="i">+                if (!filter(this)) return
</a><a href="#h79-0-24" id="h79-0-24" class="i">+                consumer(this)
</a><a href="#h79-0-25" id="h79-0-25" class="i">+            }
</a><a href="#h79-0-26" id="h79-0-26" class="i">+        }
</a><a href="#h79-0-27" id="h79-0-27" class="i">+    }
</a><a href="#h79-0-28" id="h79-0-28" class="i">+
</a><a href="#h79-0-29" id="h79-0-29" class="i">+    fun hook(
</a><a href="#h79-0-30" id="h79-0-30" class="i">+        clazz: Class&lt;*&gt;,
</a><a href="#h79-0-31" id="h79-0-31" class="i">+        methodName: String,
</a><a href="#h79-0-32" id="h79-0-32" class="i">+        stage: HookStage,
</a><a href="#h79-0-33" id="h79-0-33" class="i">+        consumer: (HookAdapter) -&gt; Unit
</a><a href="#h79-0-34" id="h79-0-34" class="i">+    ): Set&lt;XC_MethodHook.Unhook&gt; = XposedBridge.hookAllMethods(clazz, methodName, newMethodHook(stage, consumer))
</a><a href="#h79-0-35" id="h79-0-35" class="i">+
</a><a href="#h79-0-36" id="h79-0-36" class="i">+    fun hook(
</a><a href="#h79-0-37" id="h79-0-37" class="i">+        clazz: Class&lt;*&gt;,
</a><a href="#h79-0-38" id="h79-0-38" class="i">+        methodName: String,
</a><a href="#h79-0-39" id="h79-0-39" class="i">+        stage: HookStage,
</a><a href="#h79-0-40" id="h79-0-40" class="i">+        filter: (HookAdapter) -&gt; Boolean,
</a><a href="#h79-0-41" id="h79-0-41" class="i">+        consumer: (HookAdapter) -&gt; Unit
</a><a href="#h79-0-42" id="h79-0-42" class="i">+    ): Set&lt;XC_MethodHook.Unhook&gt; = XposedBridge.hookAllMethods(clazz, methodName, newMethodHook(stage, consumer, filter))
</a><a href="#h79-0-43" id="h79-0-43" class="i">+
</a><a href="#h79-0-44" id="h79-0-44" class="i">+    fun hook(
</a><a href="#h79-0-45" id="h79-0-45" class="i">+        member: Member,
</a><a href="#h79-0-46" id="h79-0-46" class="i">+        stage: HookStage,
</a><a href="#h79-0-47" id="h79-0-47" class="i">+        consumer: (HookAdapter) -&gt; Unit
</a><a href="#h79-0-48" id="h79-0-48" class="i">+    ): XC_MethodHook.Unhook {
</a><a href="#h79-0-49" id="h79-0-49" class="i">+        return XposedBridge.hookMethod(member, newMethodHook(stage, consumer))
</a><a href="#h79-0-50" id="h79-0-50" class="i">+    }
</a><a href="#h79-0-51" id="h79-0-51" class="i">+
</a><a href="#h79-0-52" id="h79-0-52" class="i">+    fun hook(
</a><a href="#h79-0-53" id="h79-0-53" class="i">+        member: Member,
</a><a href="#h79-0-54" id="h79-0-54" class="i">+        stage: HookStage,
</a><a href="#h79-0-55" id="h79-0-55" class="i">+        filter: ((HookAdapter) -&gt; Boolean),
</a><a href="#h79-0-56" id="h79-0-56" class="i">+        consumer: (HookAdapter) -&gt; Unit
</a><a href="#h79-0-57" id="h79-0-57" class="i">+    ): XC_MethodHook.Unhook {
</a><a href="#h79-0-58" id="h79-0-58" class="i">+        return XposedBridge.hookMethod(member, newMethodHook(stage, consumer, filter))
</a><a href="#h79-0-59" id="h79-0-59" class="i">+    }
</a><a href="#h79-0-60" id="h79-0-60" class="i">+
</a><a href="#h79-0-61" id="h79-0-61" class="i">+
</a><a href="#h79-0-62" id="h79-0-62" class="i">+    fun hookConstructor(
</a><a href="#h79-0-63" id="h79-0-63" class="i">+        clazz: Class&lt;*&gt;,
</a><a href="#h79-0-64" id="h79-0-64" class="i">+        stage: HookStage,
</a><a href="#h79-0-65" id="h79-0-65" class="i">+        consumer: (HookAdapter) -&gt; Unit
</a><a href="#h79-0-66" id="h79-0-66" class="i">+    ) {
</a><a href="#h79-0-67" id="h79-0-67" class="i">+        XposedBridge.hookAllConstructors(clazz, newMethodHook(stage, consumer))
</a><a href="#h79-0-68" id="h79-0-68" class="i">+    }
</a><a href="#h79-0-69" id="h79-0-69" class="i">+
</a><a href="#h79-0-70" id="h79-0-70" class="i">+    fun hookConstructor(
</a><a href="#h79-0-71" id="h79-0-71" class="i">+        clazz: Class&lt;*&gt;,
</a><a href="#h79-0-72" id="h79-0-72" class="i">+        stage: HookStage,
</a><a href="#h79-0-73" id="h79-0-73" class="i">+        filter: ((HookAdapter) -&gt; Boolean),
</a><a href="#h79-0-74" id="h79-0-74" class="i">+        consumer: (HookAdapter) -&gt; Unit
</a><a href="#h79-0-75" id="h79-0-75" class="i">+    ) {
</a><a href="#h79-0-76" id="h79-0-76" class="i">+        XposedBridge.hookAllConstructors(clazz, newMethodHook(stage, consumer, filter))
</a><a href="#h79-0-77" id="h79-0-77" class="i">+    }
</a><a href="#h79-0-78" id="h79-0-78" class="i">+
</a><a href="#h79-0-79" id="h79-0-79" class="i">+    fun ephemeralHookObjectMethod(
</a><a href="#h79-0-80" id="h79-0-80" class="i">+        clazz: Class&lt;*&gt;,
</a><a href="#h79-0-81" id="h79-0-81" class="i">+        instance: Any,
</a><a href="#h79-0-82" id="h79-0-82" class="i">+        methodName: String,
</a><a href="#h79-0-83" id="h79-0-83" class="i">+        stage: HookStage,
</a><a href="#h79-0-84" id="h79-0-84" class="i">+        hookConsumer: (HookAdapter) -&gt; Unit
</a><a href="#h79-0-85" id="h79-0-85" class="i">+    ) {
</a><a href="#h79-0-86" id="h79-0-86" class="i">+        val unhooks: MutableSet&lt;XC_MethodHook.Unhook&gt; = HashSet()
</a><a href="#h79-0-87" id="h79-0-87" class="i">+        hook(clazz, methodName, stage) { param-&gt;
</a><a href="#h79-0-88" id="h79-0-88" class="i">+            if (param.thisObject&lt;Any&gt;() != instance) return@hook
</a><a href="#h79-0-89" id="h79-0-89" class="i">+            hookConsumer(param)
</a><a href="#h79-0-90" id="h79-0-90" class="i">+            unhooks.forEach{ it.unhook() }
</a><a href="#h79-0-91" id="h79-0-91" class="i">+        }.also { unhooks.addAll(it) }
</a><a href="#h79-0-92" id="h79-0-92" class="i">+    }
</a><a href="#h79-0-93" id="h79-0-93" class="i">+}</a><a href="#h79-0-94" id="h79-0-94" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h80" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/manager/Manager.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/manager/Manager.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/manager/Manager.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/manager/Manager.kt</a></b>
<a href="#h80-0" id="h80-0" class="h">@@ -0,0 +1,6 @@
</a><a href="#h80-0-0" id="h80-0-0" class="i">+package me.rhunk.snapenhance.manager
</a><a href="#h80-0-1" id="h80-0-1" class="i">+
</a><a href="#h80-0-2" id="h80-0-2" class="i">+interface Manager {
</a><a href="#h80-0-3" id="h80-0-3" class="i">+    fun init() {}
</a><a href="#h80-0-4" id="h80-0-4" class="i">+    fun onActivityCreate() {}
</a><a href="#h80-0-5" id="h80-0-5" class="i">+}</a><a href="#h80-0-6" id="h80-0-6" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h81" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/manager/impl/ConfigManager.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/manager/impl/ConfigManager.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/manager/impl/ConfigManager.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/manager/impl/ConfigManager.kt</a></b>
<a href="#h81-0" id="h81-0" class="h">@@ -0,0 +1,63 @@
</a><a href="#h81-0-0" id="h81-0-0" class="i">+package me.rhunk.snapenhance.manager.impl
</a><a href="#h81-0-1" id="h81-0-1" class="i">+
</a><a href="#h81-0-2" id="h81-0-2" class="i">+import com.google.gson.JsonObject
</a><a href="#h81-0-3" id="h81-0-3" class="i">+import me.rhunk.snapenhance.Logger
</a><a href="#h81-0-4" id="h81-0-4" class="i">+import me.rhunk.snapenhance.ModContext
</a><a href="#h81-0-5" id="h81-0-5" class="i">+import me.rhunk.snapenhance.bridge.common.impl.FileAccessRequest
</a><a href="#h81-0-6" id="h81-0-6" class="i">+import me.rhunk.snapenhance.config.ConfigAccessor
</a><a href="#h81-0-7" id="h81-0-7" class="i">+import me.rhunk.snapenhance.config.ConfigProperty
</a><a href="#h81-0-8" id="h81-0-8" class="i">+import me.rhunk.snapenhance.manager.Manager
</a><a href="#h81-0-9" id="h81-0-9" class="i">+import java.nio.charset.StandardCharsets
</a><a href="#h81-0-10" id="h81-0-10" class="i">+
</a><a href="#h81-0-11" id="h81-0-11" class="i">+class ConfigManager(
</a><a href="#h81-0-12" id="h81-0-12" class="i">+    private val context: ModContext,
</a><a href="#h81-0-13" id="h81-0-13" class="i">+    config: MutableMap&lt;ConfigProperty, Any?&gt; = mutableMapOf()
</a><a href="#h81-0-14" id="h81-0-14" class="i">+) : ConfigAccessor(config), Manager {
</a><a href="#h81-0-15" id="h81-0-15" class="i">+
</a><a href="#h81-0-16" id="h81-0-16" class="i">+    private val propertyList = ConfigProperty.sortedByCategory()
</a><a href="#h81-0-17" id="h81-0-17" class="i">+
</a><a href="#h81-0-18" id="h81-0-18" class="i">+    override fun init() {
</a><a href="#h81-0-19" id="h81-0-19" class="i">+        //generate default config
</a><a href="#h81-0-20" id="h81-0-20" class="i">+        propertyList.forEach { key -&gt;
</a><a href="#h81-0-21" id="h81-0-21" class="i">+            set(key, key.defaultValue)
</a><a href="#h81-0-22" id="h81-0-22" class="i">+        }
</a><a href="#h81-0-23" id="h81-0-23" class="i">+
</a><a href="#h81-0-24" id="h81-0-24" class="i">+        if (!context.bridgeClient.isFileExists(FileAccessRequest.FileType.CONFIG)) {
</a><a href="#h81-0-25" id="h81-0-25" class="i">+            writeConfig()
</a><a href="#h81-0-26" id="h81-0-26" class="i">+            return
</a><a href="#h81-0-27" id="h81-0-27" class="i">+        }
</a><a href="#h81-0-28" id="h81-0-28" class="i">+
</a><a href="#h81-0-29" id="h81-0-29" class="i">+        runCatching {
</a><a href="#h81-0-30" id="h81-0-30" class="i">+            loadConfig()
</a><a href="#h81-0-31" id="h81-0-31" class="i">+        }.onFailure {
</a><a href="#h81-0-32" id="h81-0-32" class="i">+            Logger.xposedLog(&quot;Failed to load config&quot;, it)
</a><a href="#h81-0-33" id="h81-0-33" class="i">+            writeConfig()
</a><a href="#h81-0-34" id="h81-0-34" class="i">+        }
</a><a href="#h81-0-35" id="h81-0-35" class="i">+    }
</a><a href="#h81-0-36" id="h81-0-36" class="i">+
</a><a href="#h81-0-37" id="h81-0-37" class="i">+    private fun loadConfig() {
</a><a href="#h81-0-38" id="h81-0-38" class="i">+        val configContent = context.bridgeClient.createAndReadFile(
</a><a href="#h81-0-39" id="h81-0-39" class="i">+            FileAccessRequest.FileType.CONFIG,
</a><a href="#h81-0-40" id="h81-0-40" class="i">+            &quot;{}&quot;.toByteArray(Charsets.UTF_8)
</a><a href="#h81-0-41" id="h81-0-41" class="i">+        )
</a><a href="#h81-0-42" id="h81-0-42" class="i">+        val configObject: JsonObject = context.gson.fromJson(
</a><a href="#h81-0-43" id="h81-0-43" class="i">+            String(configContent, StandardCharsets.UTF_8),
</a><a href="#h81-0-44" id="h81-0-44" class="i">+            JsonObject::class.java
</a><a href="#h81-0-45" id="h81-0-45" class="i">+        )
</a><a href="#h81-0-46" id="h81-0-46" class="i">+        propertyList.forEach { key -&gt;
</a><a href="#h81-0-47" id="h81-0-47" class="i">+            val value = context.gson.fromJson(configObject.get(key.name), key.defaultValue.javaClass) ?: key.defaultValue
</a><a href="#h81-0-48" id="h81-0-48" class="i">+            set(key, value)
</a><a href="#h81-0-49" id="h81-0-49" class="i">+        }
</a><a href="#h81-0-50" id="h81-0-50" class="i">+    }
</a><a href="#h81-0-51" id="h81-0-51" class="i">+
</a><a href="#h81-0-52" id="h81-0-52" class="i">+    fun writeConfig() {
</a><a href="#h81-0-53" id="h81-0-53" class="i">+        val configObject = JsonObject()
</a><a href="#h81-0-54" id="h81-0-54" class="i">+        propertyList.forEach { key -&gt;
</a><a href="#h81-0-55" id="h81-0-55" class="i">+            configObject.add(key.name, context.gson.toJsonTree(get(key)))
</a><a href="#h81-0-56" id="h81-0-56" class="i">+        }
</a><a href="#h81-0-57" id="h81-0-57" class="i">+        context.bridgeClient.writeFile(
</a><a href="#h81-0-58" id="h81-0-58" class="i">+            FileAccessRequest.FileType.CONFIG,
</a><a href="#h81-0-59" id="h81-0-59" class="i">+            context.gson.toJson(configObject).toByteArray(Charsets.UTF_8)
</a><a href="#h81-0-60" id="h81-0-60" class="i">+        )
</a><a href="#h81-0-61" id="h81-0-61" class="i">+    }
</a><a href="#h81-0-62" id="h81-0-62" class="i">+}</a><a href="#h81-0-63" id="h81-0-63" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h82" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/manager/impl/FeatureManager.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/manager/impl/FeatureManager.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/manager/impl/FeatureManager.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/manager/impl/FeatureManager.kt</a></b>
<a href="#h82-0" id="h82-0" class="h">@@ -0,0 +1,93 @@
</a><a href="#h82-0-0" id="h82-0-0" class="i">+package me.rhunk.snapenhance.manager.impl
</a><a href="#h82-0-1" id="h82-0-1" class="i">+
</a><a href="#h82-0-2" id="h82-0-2" class="i">+import me.rhunk.snapenhance.Logger
</a><a href="#h82-0-3" id="h82-0-3" class="i">+import me.rhunk.snapenhance.ModContext
</a><a href="#h82-0-4" id="h82-0-4" class="i">+import me.rhunk.snapenhance.features.Feature
</a><a href="#h82-0-5" id="h82-0-5" class="i">+import me.rhunk.snapenhance.features.FeatureLoadParams
</a><a href="#h82-0-6" id="h82-0-6" class="i">+import me.rhunk.snapenhance.features.impl.ConfigEnumKeys
</a><a href="#h82-0-7" id="h82-0-7" class="i">+import me.rhunk.snapenhance.features.impl.Messaging
</a><a href="#h82-0-8" id="h82-0-8" class="i">+import me.rhunk.snapenhance.features.impl.downloader.MediaDownloader
</a><a href="#h82-0-9" id="h82-0-9" class="i">+import me.rhunk.snapenhance.features.impl.extras.AutoSave
</a><a href="#h82-0-10" id="h82-0-10" class="i">+import me.rhunk.snapenhance.features.impl.extras.Notifications
</a><a href="#h82-0-11" id="h82-0-11" class="i">+import me.rhunk.snapenhance.features.impl.extras.SnapchatPlus
</a><a href="#h82-0-12" id="h82-0-12" class="i">+import me.rhunk.snapenhance.features.impl.privacy.DisableMetrics
</a><a href="#h82-0-13" id="h82-0-13" class="i">+import me.rhunk.snapenhance.features.impl.privacy.PreventScreenshotDetections
</a><a href="#h82-0-14" id="h82-0-14" class="i">+import me.rhunk.snapenhance.features.impl.spy.*
</a><a href="#h82-0-15" id="h82-0-15" class="i">+import me.rhunk.snapenhance.features.impl.ui.UITweaks
</a><a href="#h82-0-16" id="h82-0-16" class="i">+import me.rhunk.snapenhance.features.impl.ui.menus.MenuViewInjector
</a><a href="#h82-0-17" id="h82-0-17" class="i">+import me.rhunk.snapenhance.manager.Manager
</a><a href="#h82-0-18" id="h82-0-18" class="i">+import java.util.concurrent.Executors
</a><a href="#h82-0-19" id="h82-0-19" class="i">+import kotlin.reflect.KClass
</a><a href="#h82-0-20" id="h82-0-20" class="i">+
</a><a href="#h82-0-21" id="h82-0-21" class="i">+class FeatureManager(private val context: ModContext) : Manager {
</a><a href="#h82-0-22" id="h82-0-22" class="i">+    private val asyncLoadExecutorService = Executors.newCachedThreadPool()
</a><a href="#h82-0-23" id="h82-0-23" class="i">+    private val features = mutableListOf&lt;Feature&gt;()
</a><a href="#h82-0-24" id="h82-0-24" class="i">+
</a><a href="#h82-0-25" id="h82-0-25" class="i">+    private fun register(featureClass: KClass&lt;out Feature&gt;) {
</a><a href="#h82-0-26" id="h82-0-26" class="i">+        runCatching {
</a><a href="#h82-0-27" id="h82-0-27" class="i">+            with(featureClass.java.newInstance()) {
</a><a href="#h82-0-28" id="h82-0-28" class="i">+                if (loadParams and FeatureLoadParams.NO_INIT != 0) return@with
</a><a href="#h82-0-29" id="h82-0-29" class="i">+                context = this@FeatureManager.context
</a><a href="#h82-0-30" id="h82-0-30" class="i">+                features.add(this)
</a><a href="#h82-0-31" id="h82-0-31" class="i">+            }
</a><a href="#h82-0-32" id="h82-0-32" class="i">+        }.onFailure {
</a><a href="#h82-0-33" id="h82-0-33" class="i">+            Logger.xposedLog(&quot;Failed to register feature ${featureClass.simpleName}&quot;, it)
</a><a href="#h82-0-34" id="h82-0-34" class="i">+        }
</a><a href="#h82-0-35" id="h82-0-35" class="i">+    }
</a><a href="#h82-0-36" id="h82-0-36" class="i">+
</a><a href="#h82-0-37" id="h82-0-37" class="i">+    @Suppress(&quot;UNCHECKED_CAST&quot;)
</a><a href="#h82-0-38" id="h82-0-38" class="i">+    fun &lt;T : Feature&gt; get(featureClass: KClass&lt;T&gt;): T? {
</a><a href="#h82-0-39" id="h82-0-39" class="i">+        return features.find { it::class == featureClass } as? T
</a><a href="#h82-0-40" id="h82-0-40" class="i">+    }
</a><a href="#h82-0-41" id="h82-0-41" class="i">+
</a><a href="#h82-0-42" id="h82-0-42" class="i">+    override fun init() {
</a><a href="#h82-0-43" id="h82-0-43" class="i">+        register(Messaging::class)
</a><a href="#h82-0-44" id="h82-0-44" class="i">+        register(MediaDownloader::class)
</a><a href="#h82-0-45" id="h82-0-45" class="i">+        register(StealthMode::class)
</a><a href="#h82-0-46" id="h82-0-46" class="i">+        register(MenuViewInjector::class)
</a><a href="#h82-0-47" id="h82-0-47" class="i">+        register(PreventReadReceipts::class)
</a><a href="#h82-0-48" id="h82-0-48" class="i">+        register(AnonymousStoryViewing::class)
</a><a href="#h82-0-49" id="h82-0-49" class="i">+        register(MessageLogger::class)
</a><a href="#h82-0-50" id="h82-0-50" class="i">+        register(SnapchatPlus::class)
</a><a href="#h82-0-51" id="h82-0-51" class="i">+        register(DisableMetrics::class)
</a><a href="#h82-0-52" id="h82-0-52" class="i">+        register(PreventScreenshotDetections::class)
</a><a href="#h82-0-53" id="h82-0-53" class="i">+        register(PreventStatusNotifications::class)
</a><a href="#h82-0-54" id="h82-0-54" class="i">+        register(Notifications::class)
</a><a href="#h82-0-55" id="h82-0-55" class="i">+        register(AutoSave::class)
</a><a href="#h82-0-56" id="h82-0-56" class="i">+        register(UITweaks::class)
</a><a href="#h82-0-57" id="h82-0-57" class="i">+        register(ConfigEnumKeys::class)
</a><a href="#h82-0-58" id="h82-0-58" class="i">+
</a><a href="#h82-0-59" id="h82-0-59" class="i">+        initializeFeatures()
</a><a href="#h82-0-60" id="h82-0-60" class="i">+    }
</a><a href="#h82-0-61" id="h82-0-61" class="i">+
</a><a href="#h82-0-62" id="h82-0-62" class="i">+    private fun featureInitializer(isAsync: Boolean, param: Int, action: (Feature) -&gt; Unit) {
</a><a href="#h82-0-63" id="h82-0-63" class="i">+        features.forEach { feature -&gt;
</a><a href="#h82-0-64" id="h82-0-64" class="i">+            if (feature.loadParams and param == 0) return@forEach
</a><a href="#h82-0-65" id="h82-0-65" class="i">+            val callback = {
</a><a href="#h82-0-66" id="h82-0-66" class="i">+                runCatching {
</a><a href="#h82-0-67" id="h82-0-67" class="i">+                    action(feature)
</a><a href="#h82-0-68" id="h82-0-68" class="i">+                }.onFailure {
</a><a href="#h82-0-69" id="h82-0-69" class="i">+                    Logger.xposedLog(&quot;Failed to init feature ${feature.nameKey}&quot;, it)
</a><a href="#h82-0-70" id="h82-0-70" class="i">+                }
</a><a href="#h82-0-71" id="h82-0-71" class="i">+            }
</a><a href="#h82-0-72" id="h82-0-72" class="i">+            if (!isAsync) {
</a><a href="#h82-0-73" id="h82-0-73" class="i">+                callback()
</a><a href="#h82-0-74" id="h82-0-74" class="i">+                return@forEach
</a><a href="#h82-0-75" id="h82-0-75" class="i">+            }
</a><a href="#h82-0-76" id="h82-0-76" class="i">+            asyncLoadExecutorService.submit {
</a><a href="#h82-0-77" id="h82-0-77" class="i">+                callback()
</a><a href="#h82-0-78" id="h82-0-78" class="i">+            }
</a><a href="#h82-0-79" id="h82-0-79" class="i">+        }
</a><a href="#h82-0-80" id="h82-0-80" class="i">+    }
</a><a href="#h82-0-81" id="h82-0-81" class="i">+
</a><a href="#h82-0-82" id="h82-0-82" class="i">+    private fun initializeFeatures() {
</a><a href="#h82-0-83" id="h82-0-83" class="i">+        //TODO: async called when all features are initiated ?
</a><a href="#h82-0-84" id="h82-0-84" class="i">+        featureInitializer(false, FeatureLoadParams.INIT_SYNC) { it.init() }
</a><a href="#h82-0-85" id="h82-0-85" class="i">+        featureInitializer(true, FeatureLoadParams.INIT_ASYNC) { it.asyncInit() }
</a><a href="#h82-0-86" id="h82-0-86" class="i">+    }
</a><a href="#h82-0-87" id="h82-0-87" class="i">+
</a><a href="#h82-0-88" id="h82-0-88" class="i">+    override fun onActivityCreate() {
</a><a href="#h82-0-89" id="h82-0-89" class="i">+        featureInitializer(false, FeatureLoadParams.ACTIVITY_CREATE_SYNC) { it.onActivityCreate() }
</a><a href="#h82-0-90" id="h82-0-90" class="i">+        featureInitializer(true, FeatureLoadParams.ACTIVITY_CREATE_ASYNC) { it.asyncOnActivityCreate() }
</a><a href="#h82-0-91" id="h82-0-91" class="i">+    }
</a><a href="#h82-0-92" id="h82-0-92" class="i">+}</a><a href="#h82-0-93" id="h82-0-93" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h83" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/manager/impl/MappingManager.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/manager/impl/MappingManager.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/manager/impl/MappingManager.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/manager/impl/MappingManager.kt</a></b>
<a href="#h83-0" id="h83-0" class="h">@@ -0,0 +1,178 @@
</a><a href="#h83-0-0" id="h83-0-0" class="i">+package me.rhunk.snapenhance.manager.impl
</a><a href="#h83-0-1" id="h83-0-1" class="i">+
</a><a href="#h83-0-2" id="h83-0-2" class="i">+import com.google.gson.JsonElement
</a><a href="#h83-0-3" id="h83-0-3" class="i">+import com.google.gson.JsonObject
</a><a href="#h83-0-4" id="h83-0-4" class="i">+import com.google.gson.JsonParser
</a><a href="#h83-0-5" id="h83-0-5" class="i">+import dalvik.system.DexFile
</a><a href="#h83-0-6" id="h83-0-6" class="i">+import kotlinx.coroutines.Job
</a><a href="#h83-0-7" id="h83-0-7" class="i">+import kotlinx.coroutines.launch
</a><a href="#h83-0-8" id="h83-0-8" class="i">+import kotlinx.coroutines.runBlocking
</a><a href="#h83-0-9" id="h83-0-9" class="i">+import me.rhunk.snapenhance.Constants
</a><a href="#h83-0-10" id="h83-0-10" class="i">+import me.rhunk.snapenhance.Logger
</a><a href="#h83-0-11" id="h83-0-11" class="i">+import me.rhunk.snapenhance.ModContext
</a><a href="#h83-0-12" id="h83-0-12" class="i">+import me.rhunk.snapenhance.bridge.common.impl.FileAccessRequest
</a><a href="#h83-0-13" id="h83-0-13" class="i">+import me.rhunk.snapenhance.manager.Manager
</a><a href="#h83-0-14" id="h83-0-14" class="i">+import me.rhunk.snapenhance.mapping.Mapper
</a><a href="#h83-0-15" id="h83-0-15" class="i">+import me.rhunk.snapenhance.mapping.impl.CallbackMapper
</a><a href="#h83-0-16" id="h83-0-16" class="i">+import me.rhunk.snapenhance.mapping.impl.EnumMapper
</a><a href="#h83-0-17" id="h83-0-17" class="i">+import me.rhunk.snapenhance.mapping.impl.OperaPageViewControllerMapper
</a><a href="#h83-0-18" id="h83-0-18" class="i">+import me.rhunk.snapenhance.mapping.impl.PlusSubscriptionMapper
</a><a href="#h83-0-19" id="h83-0-19" class="i">+import me.rhunk.snapenhance.util.getObjectField
</a><a href="#h83-0-20" id="h83-0-20" class="i">+import java.io.FileNotFoundException
</a><a href="#h83-0-21" id="h83-0-21" class="i">+import java.nio.charset.StandardCharsets
</a><a href="#h83-0-22" id="h83-0-22" class="i">+import java.util.concurrent.ConcurrentHashMap
</a><a href="#h83-0-23" id="h83-0-23" class="i">+
</a><a href="#h83-0-24" id="h83-0-24" class="i">+@Suppress(&quot;UNCHECKED_CAST&quot;)
</a><a href="#h83-0-25" id="h83-0-25" class="i">+class MappingManager(private val context: ModContext) : Manager {
</a><a href="#h83-0-26" id="h83-0-26" class="i">+    private val mappers = mutableListOf&lt;Mapper&gt;().apply {
</a><a href="#h83-0-27" id="h83-0-27" class="i">+        add(CallbackMapper())
</a><a href="#h83-0-28" id="h83-0-28" class="i">+        add(EnumMapper())
</a><a href="#h83-0-29" id="h83-0-29" class="i">+        add(OperaPageViewControllerMapper())
</a><a href="#h83-0-30" id="h83-0-30" class="i">+        add(PlusSubscriptionMapper())
</a><a href="#h83-0-31" id="h83-0-31" class="i">+    }
</a><a href="#h83-0-32" id="h83-0-32" class="i">+
</a><a href="#h83-0-33" id="h83-0-33" class="i">+    private val mappings = ConcurrentHashMap&lt;String, Any&gt;()
</a><a href="#h83-0-34" id="h83-0-34" class="i">+    private var snapBuildNumber = 0
</a><a href="#h83-0-35" id="h83-0-35" class="i">+
</a><a href="#h83-0-36" id="h83-0-36" class="i">+    override fun init() {
</a><a href="#h83-0-37" id="h83-0-37" class="i">+        val currentBuildNumber = context.androidContext.packageManager.getPackageInfo(
</a><a href="#h83-0-38" id="h83-0-38" class="i">+            Constants.SNAPCHAT_PACKAGE_NAME,
</a><a href="#h83-0-39" id="h83-0-39" class="i">+            0
</a><a href="#h83-0-40" id="h83-0-40" class="i">+        ).longVersionCode.toInt()
</a><a href="#h83-0-41" id="h83-0-41" class="i">+        snapBuildNumber = currentBuildNumber
</a><a href="#h83-0-42" id="h83-0-42" class="i">+
</a><a href="#h83-0-43" id="h83-0-43" class="i">+        if (context.bridgeClient.isFileExists(FileAccessRequest.FileType.MAPPINGS)) {
</a><a href="#h83-0-44" id="h83-0-44" class="i">+            runCatching {
</a><a href="#h83-0-45" id="h83-0-45" class="i">+                loadCached()
</a><a href="#h83-0-46" id="h83-0-46" class="i">+            }.onFailure {
</a><a href="#h83-0-47" id="h83-0-47" class="i">+                if (it is FileNotFoundException) {
</a><a href="#h83-0-48" id="h83-0-48" class="i">+                    Logger.xposedLog(it)
</a><a href="#h83-0-49" id="h83-0-49" class="i">+                    context.forceCloseApp()
</a><a href="#h83-0-50" id="h83-0-50" class="i">+                }
</a><a href="#h83-0-51" id="h83-0-51" class="i">+                Logger.error(&quot;Failed to load cached mappings&quot;, it)
</a><a href="#h83-0-52" id="h83-0-52" class="i">+            }
</a><a href="#h83-0-53" id="h83-0-53" class="i">+            return
</a><a href="#h83-0-54" id="h83-0-54" class="i">+        }
</a><a href="#h83-0-55" id="h83-0-55" class="i">+        refresh()
</a><a href="#h83-0-56" id="h83-0-56" class="i">+    }
</a><a href="#h83-0-57" id="h83-0-57" class="i">+
</a><a href="#h83-0-58" id="h83-0-58" class="i">+    private fun loadCached() {
</a><a href="#h83-0-59" id="h83-0-59" class="i">+        if (!context.bridgeClient.isFileExists(FileAccessRequest.FileType.MAPPINGS)) {
</a><a href="#h83-0-60" id="h83-0-60" class="i">+            Logger.xposedLog(&quot;Mappings file does not exist&quot;)
</a><a href="#h83-0-61" id="h83-0-61" class="i">+            return
</a><a href="#h83-0-62" id="h83-0-62" class="i">+        }
</a><a href="#h83-0-63" id="h83-0-63" class="i">+        val mappingsObject = JsonParser.parseString(
</a><a href="#h83-0-64" id="h83-0-64" class="i">+            String(
</a><a href="#h83-0-65" id="h83-0-65" class="i">+                context.bridgeClient.readFile(FileAccessRequest.FileType.MAPPINGS),
</a><a href="#h83-0-66" id="h83-0-66" class="i">+                StandardCharsets.UTF_8
</a><a href="#h83-0-67" id="h83-0-67" class="i">+            )
</a><a href="#h83-0-68" id="h83-0-68" class="i">+        ).asJsonObject.also {
</a><a href="#h83-0-69" id="h83-0-69" class="i">+            snapBuildNumber = it[&quot;snap_build_number&quot;].asInt
</a><a href="#h83-0-70" id="h83-0-70" class="i">+        }
</a><a href="#h83-0-71" id="h83-0-71" class="i">+
</a><a href="#h83-0-72" id="h83-0-72" class="i">+        mappingsObject.entrySet().forEach { (key, value): Map.Entry&lt;String, JsonElement&gt; -&gt;
</a><a href="#h83-0-73" id="h83-0-73" class="i">+            if (value.isJsonArray) {
</a><a href="#h83-0-74" id="h83-0-74" class="i">+                mappings[key] = context.gson.fromJson(value, ArrayList::class.java)
</a><a href="#h83-0-75" id="h83-0-75" class="i">+                return@forEach
</a><a href="#h83-0-76" id="h83-0-76" class="i">+            }
</a><a href="#h83-0-77" id="h83-0-77" class="i">+            if (value.isJsonObject) {
</a><a href="#h83-0-78" id="h83-0-78" class="i">+                mappings[key] = context.gson.fromJson(value, ConcurrentHashMap::class.java)
</a><a href="#h83-0-79" id="h83-0-79" class="i">+                return@forEach
</a><a href="#h83-0-80" id="h83-0-80" class="i">+            }
</a><a href="#h83-0-81" id="h83-0-81" class="i">+            mappings[key] = value.asString
</a><a href="#h83-0-82" id="h83-0-82" class="i">+        }
</a><a href="#h83-0-83" id="h83-0-83" class="i">+    }
</a><a href="#h83-0-84" id="h83-0-84" class="i">+
</a><a href="#h83-0-85" id="h83-0-85" class="i">+    private fun executeMappers(classes: List&lt;Class&lt;*&gt;&gt;) = runBlocking {
</a><a href="#h83-0-86" id="h83-0-86" class="i">+        val jobs = mutableListOf&lt;Job&gt;()
</a><a href="#h83-0-87" id="h83-0-87" class="i">+        mappers.forEach { mapper -&gt;
</a><a href="#h83-0-88" id="h83-0-88" class="i">+            mapper.context = context
</a><a href="#h83-0-89" id="h83-0-89" class="i">+            launch {
</a><a href="#h83-0-90" id="h83-0-90" class="i">+                runCatching {
</a><a href="#h83-0-91" id="h83-0-91" class="i">+                    mapper.useClasses(context.androidContext.classLoader, classes, mappings)
</a><a href="#h83-0-92" id="h83-0-92" class="i">+                }.onFailure {
</a><a href="#h83-0-93" id="h83-0-93" class="i">+                    Logger.error(&quot;Failed to execute mapper ${mapper.javaClass.simpleName}&quot;, it)
</a><a href="#h83-0-94" id="h83-0-94" class="i">+                }
</a><a href="#h83-0-95" id="h83-0-95" class="i">+            }.also { jobs.add(it) }
</a><a href="#h83-0-96" id="h83-0-96" class="i">+        }
</a><a href="#h83-0-97" id="h83-0-97" class="i">+        jobs.forEach { it.join() }
</a><a href="#h83-0-98" id="h83-0-98" class="i">+    }
</a><a href="#h83-0-99" id="h83-0-99" class="i">+
</a><a href="#h83-0-100" id="h83-0-100" class="i">+    @Suppress(&quot;UNCHECKED_CAST&quot;, &quot;DEPRECATION&quot;)
</a><a href="#h83-0-101" id="h83-0-101" class="i">+    private fun refresh() {
</a><a href="#h83-0-102" id="h83-0-102" class="i">+        context.shortToast(&quot;Loading mappings (this may take a while)&quot;)
</a><a href="#h83-0-103" id="h83-0-103" class="i">+        val classes: MutableList&lt;Class&lt;*&gt;&gt; = ArrayList()
</a><a href="#h83-0-104" id="h83-0-104" class="i">+
</a><a href="#h83-0-105" id="h83-0-105" class="i">+        val classLoader = context.androidContext.classLoader
</a><a href="#h83-0-106" id="h83-0-106" class="i">+        val dexPathList = classLoader.getObjectField(&quot;pathList&quot;)
</a><a href="#h83-0-107" id="h83-0-107" class="i">+        val dexElements = dexPathList.getObjectField(&quot;dexElements&quot;) as Array&lt;Any&gt;
</a><a href="#h83-0-108" id="h83-0-108" class="i">+
</a><a href="#h83-0-109" id="h83-0-109" class="i">+        dexElements.forEach { dexElement: Any -&gt;
</a><a href="#h83-0-110" id="h83-0-110" class="i">+            val dexFile = dexElement.getObjectField(&quot;dexFile&quot;) as DexFile
</a><a href="#h83-0-111" id="h83-0-111" class="i">+            dexFile.entries().toList().forEach fileList@{ className -&gt;
</a><a href="#h83-0-112" id="h83-0-112" class="i">+                //ignore classes without a dot in them
</a><a href="#h83-0-113" id="h83-0-113" class="i">+                if (className.contains(&quot;.&quot;) &amp;&amp; !className.startsWith(&quot;com.snap&quot;)) return@fileList
</a><a href="#h83-0-114" id="h83-0-114" class="i">+                runCatching {
</a><a href="#h83-0-115" id="h83-0-115" class="i">+                    classLoader.loadClass(className)?.let { classes.add(it) }
</a><a href="#h83-0-116" id="h83-0-116" class="i">+                }
</a><a href="#h83-0-117" id="h83-0-117" class="i">+            }
</a><a href="#h83-0-118" id="h83-0-118" class="i">+        }
</a><a href="#h83-0-119" id="h83-0-119" class="i">+
</a><a href="#h83-0-120" id="h83-0-120" class="i">+        executeMappers(classes)
</a><a href="#h83-0-121" id="h83-0-121" class="i">+        write()
</a><a href="#h83-0-122" id="h83-0-122" class="i">+    }
</a><a href="#h83-0-123" id="h83-0-123" class="i">+
</a><a href="#h83-0-124" id="h83-0-124" class="i">+    private fun write() {
</a><a href="#h83-0-125" id="h83-0-125" class="i">+        val mappingsObject = JsonObject()
</a><a href="#h83-0-126" id="h83-0-126" class="i">+        mappingsObject.addProperty(&quot;snap_build_number&quot;, snapBuildNumber)
</a><a href="#h83-0-127" id="h83-0-127" class="i">+        mappings.forEach { (key, value) -&gt;
</a><a href="#h83-0-128" id="h83-0-128" class="i">+            if (value is List&lt;*&gt;) {
</a><a href="#h83-0-129" id="h83-0-129" class="i">+                mappingsObject.add(key, context.gson.toJsonTree(value))
</a><a href="#h83-0-130" id="h83-0-130" class="i">+                return@forEach
</a><a href="#h83-0-131" id="h83-0-131" class="i">+            }
</a><a href="#h83-0-132" id="h83-0-132" class="i">+            if (value is Map&lt;*, *&gt;) {
</a><a href="#h83-0-133" id="h83-0-133" class="i">+                mappingsObject.add(key, context.gson.toJsonTree(value))
</a><a href="#h83-0-134" id="h83-0-134" class="i">+                return@forEach
</a><a href="#h83-0-135" id="h83-0-135" class="i">+            }
</a><a href="#h83-0-136" id="h83-0-136" class="i">+            mappingsObject.addProperty(key, value.toString())
</a><a href="#h83-0-137" id="h83-0-137" class="i">+        }
</a><a href="#h83-0-138" id="h83-0-138" class="i">+
</a><a href="#h83-0-139" id="h83-0-139" class="i">+        context.bridgeClient.writeFile(
</a><a href="#h83-0-140" id="h83-0-140" class="i">+            FileAccessRequest.FileType.MAPPINGS,
</a><a href="#h83-0-141" id="h83-0-141" class="i">+            mappingsObject.toString().toByteArray()
</a><a href="#h83-0-142" id="h83-0-142" class="i">+        )
</a><a href="#h83-0-143" id="h83-0-143" class="i">+    }
</a><a href="#h83-0-144" id="h83-0-144" class="i">+
</a><a href="#h83-0-145" id="h83-0-145" class="i">+    fun getMappedObject(key: String): Any {
</a><a href="#h83-0-146" id="h83-0-146" class="i">+        if (mappings.containsKey(key)) {
</a><a href="#h83-0-147" id="h83-0-147" class="i">+            return mappings[key]!!
</a><a href="#h83-0-148" id="h83-0-148" class="i">+        }
</a><a href="#h83-0-149" id="h83-0-149" class="i">+        Logger.xposedLog(&quot;Mapping not found deleting cache&quot;)
</a><a href="#h83-0-150" id="h83-0-150" class="i">+        context.bridgeClient.deleteFile(FileAccessRequest.FileType.MAPPINGS)
</a><a href="#h83-0-151" id="h83-0-151" class="i">+        throw Exception(&quot;No mapping found for $key&quot;)
</a><a href="#h83-0-152" id="h83-0-152" class="i">+    }
</a><a href="#h83-0-153" id="h83-0-153" class="i">+
</a><a href="#h83-0-154" id="h83-0-154" class="i">+    fun getMappedClass(className: String): Class&lt;*&gt; {
</a><a href="#h83-0-155" id="h83-0-155" class="i">+        return context.androidContext.classLoader.loadClass(getMappedObject(className) as String)
</a><a href="#h83-0-156" id="h83-0-156" class="i">+    }
</a><a href="#h83-0-157" id="h83-0-157" class="i">+
</a><a href="#h83-0-158" id="h83-0-158" class="i">+    fun getMappedClass(key: String, subKey: String): Class&lt;*&gt; {
</a><a href="#h83-0-159" id="h83-0-159" class="i">+        return context.androidContext.classLoader.loadClass(getMappedValue(key, subKey))
</a><a href="#h83-0-160" id="h83-0-160" class="i">+    }
</a><a href="#h83-0-161" id="h83-0-161" class="i">+
</a><a href="#h83-0-162" id="h83-0-162" class="i">+    fun getMappedValue(key: String): String {
</a><a href="#h83-0-163" id="h83-0-163" class="i">+        return getMappedObject(key) as String
</a><a href="#h83-0-164" id="h83-0-164" class="i">+    }
</a><a href="#h83-0-165" id="h83-0-165" class="i">+
</a><a href="#h83-0-166" id="h83-0-166" class="i">+    fun &lt;T : Any&gt; getMappedList(key: String): List&lt;T&gt; {
</a><a href="#h83-0-167" id="h83-0-167" class="i">+        return listOf(getMappedObject(key) as List&lt;T&gt;).flatten()
</a><a href="#h83-0-168" id="h83-0-168" class="i">+    }
</a><a href="#h83-0-169" id="h83-0-169" class="i">+
</a><a href="#h83-0-170" id="h83-0-170" class="i">+    fun getMappedValue(key: String, subKey: String): String {
</a><a href="#h83-0-171" id="h83-0-171" class="i">+        return getMappedMap(key)[subKey] as String
</a><a href="#h83-0-172" id="h83-0-172" class="i">+    }
</a><a href="#h83-0-173" id="h83-0-173" class="i">+
</a><a href="#h83-0-174" id="h83-0-174" class="i">+    fun getMappedMap(key: String): Map&lt;String, *&gt; {
</a><a href="#h83-0-175" id="h83-0-175" class="i">+        return getMappedObject(key) as Map&lt;String, *&gt;
</a><a href="#h83-0-176" id="h83-0-176" class="i">+    }
</a><a href="#h83-0-177" id="h83-0-177" class="i">+}</a><a href="#h83-0-178" id="h83-0-178" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h84" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/manager/impl/TranslationManager.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/manager/impl/TranslationManager.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/manager/impl/TranslationManager.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/manager/impl/TranslationManager.kt</a></b>
<a href="#h84-0" id="h84-0" class="h">@@ -0,0 +1,19 @@
</a><a href="#h84-0-0" id="h84-0-0" class="i">+package me.rhunk.snapenhance.manager.impl
</a><a href="#h84-0-1" id="h84-0-1" class="i">+
</a><a href="#h84-0-2" id="h84-0-2" class="i">+import me.rhunk.snapenhance.ModContext
</a><a href="#h84-0-3" id="h84-0-3" class="i">+import me.rhunk.snapenhance.manager.Manager
</a><a href="#h84-0-4" id="h84-0-4" class="i">+import java.util.*
</a><a href="#h84-0-5" id="h84-0-5" class="i">+
</a><a href="#h84-0-6" id="h84-0-6" class="i">+class TranslationManager(
</a><a href="#h84-0-7" id="h84-0-7" class="i">+    private val context: ModContext
</a><a href="#h84-0-8" id="h84-0-8" class="i">+) : Manager {
</a><a href="#h84-0-9" id="h84-0-9" class="i">+    override fun init() {
</a><a href="#h84-0-10" id="h84-0-10" class="i">+
</a><a href="#h84-0-11" id="h84-0-11" class="i">+    }
</a><a href="#h84-0-12" id="h84-0-12" class="i">+
</a><a href="#h84-0-13" id="h84-0-13" class="i">+    fun getLocale(): Locale = Locale.getDefault()
</a><a href="#h84-0-14" id="h84-0-14" class="i">+
</a><a href="#h84-0-15" id="h84-0-15" class="i">+    fun get(key: String): String {
</a><a href="#h84-0-16" id="h84-0-16" class="i">+        return key
</a><a href="#h84-0-17" id="h84-0-17" class="i">+    }
</a><a href="#h84-0-18" id="h84-0-18" class="i">+}</a><a href="#h84-0-19" id="h84-0-19" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h85" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/mapping/Mapper.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/mapping/Mapper.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/mapping/Mapper.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/mapping/Mapper.kt</a></b>
<a href="#h85-0" id="h85-0" class="h">@@ -0,0 +1,13 @@
</a><a href="#h85-0-0" id="h85-0-0" class="i">+package me.rhunk.snapenhance.mapping
</a><a href="#h85-0-1" id="h85-0-1" class="i">+
</a><a href="#h85-0-2" id="h85-0-2" class="i">+import me.rhunk.snapenhance.ModContext
</a><a href="#h85-0-3" id="h85-0-3" class="i">+
</a><a href="#h85-0-4" id="h85-0-4" class="i">+abstract class Mapper {
</a><a href="#h85-0-5" id="h85-0-5" class="i">+    lateinit var context: ModContext
</a><a href="#h85-0-6" id="h85-0-6" class="i">+
</a><a href="#h85-0-7" id="h85-0-7" class="i">+    abstract fun useClasses(
</a><a href="#h85-0-8" id="h85-0-8" class="i">+        classLoader: ClassLoader,
</a><a href="#h85-0-9" id="h85-0-9" class="i">+        classes: List&lt;Class&lt;*&gt;&gt;,
</a><a href="#h85-0-10" id="h85-0-10" class="i">+        mappings: MutableMap&lt;String, Any&gt;
</a><a href="#h85-0-11" id="h85-0-11" class="i">+    )
</a><a href="#h85-0-12" id="h85-0-12" class="i">+}
</a><b>diff --git a/<a id="h86" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/mapping/impl/CallbackMapper.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/mapping/impl/CallbackMapper.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/mapping/impl/CallbackMapper.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/mapping/impl/CallbackMapper.kt</a></b>
<a href="#h86-0" id="h86-0" class="h">@@ -0,0 +1,29 @@
</a><a href="#h86-0-0" id="h86-0-0" class="i">+package me.rhunk.snapenhance.mapping.impl
</a><a href="#h86-0-1" id="h86-0-1" class="i">+
</a><a href="#h86-0-2" id="h86-0-2" class="i">+import me.rhunk.snapenhance.Logger.debug
</a><a href="#h86-0-3" id="h86-0-3" class="i">+import me.rhunk.snapenhance.mapping.Mapper
</a><a href="#h86-0-4" id="h86-0-4" class="i">+import java.lang.reflect.Method
</a><a href="#h86-0-5" id="h86-0-5" class="i">+import java.lang.reflect.Modifier
</a><a href="#h86-0-6" id="h86-0-6" class="i">+
</a><a href="#h86-0-7" id="h86-0-7" class="i">+class CallbackMapper : Mapper() {
</a><a href="#h86-0-8" id="h86-0-8" class="i">+    override fun useClasses(
</a><a href="#h86-0-9" id="h86-0-9" class="i">+        classLoader: ClassLoader,
</a><a href="#h86-0-10" id="h86-0-10" class="i">+        classes: List&lt;Class&lt;*&gt;&gt;,
</a><a href="#h86-0-11" id="h86-0-11" class="i">+        mappings: MutableMap&lt;String, Any&gt;
</a><a href="#h86-0-12" id="h86-0-12" class="i">+    ) {
</a><a href="#h86-0-13" id="h86-0-13" class="i">+        val callbackMappings = HashMap&lt;String, String&gt;()
</a><a href="#h86-0-14" id="h86-0-14" class="i">+        classes.forEach { clazz -&gt;
</a><a href="#h86-0-15" id="h86-0-15" class="i">+            val superClass = clazz.superclass ?: return@forEach
</a><a href="#h86-0-16" id="h86-0-16" class="i">+            if (!superClass.name.endsWith(&quot;Callback&quot;) || superClass.name.endsWith(&quot;\$Callback&quot;)) return@forEach
</a><a href="#h86-0-17" id="h86-0-17" class="i">+            if (!Modifier.isAbstract(superClass.modifiers)) return@forEach
</a><a href="#h86-0-18" id="h86-0-18" class="i">+
</a><a href="#h86-0-19" id="h86-0-19" class="i">+            if (superClass.declaredMethods.any { method: Method -&gt;
</a><a href="#h86-0-20" id="h86-0-20" class="i">+                    method.name == &quot;onError&quot;
</a><a href="#h86-0-21" id="h86-0-21" class="i">+                }) {
</a><a href="#h86-0-22" id="h86-0-22" class="i">+                callbackMappings[superClass.simpleName] = clazz.name
</a><a href="#h86-0-23" id="h86-0-23" class="i">+            }
</a><a href="#h86-0-24" id="h86-0-24" class="i">+        }
</a><a href="#h86-0-25" id="h86-0-25" class="i">+        debug(&quot;found &quot; + callbackMappings.size + &quot; callbacks&quot;)
</a><a href="#h86-0-26" id="h86-0-26" class="i">+        mappings[&quot;callbacks&quot;] = callbackMappings
</a><a href="#h86-0-27" id="h86-0-27" class="i">+    }
</a><a href="#h86-0-28" id="h86-0-28" class="i">+}
</a><b>diff --git a/<a id="h87" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/mapping/impl/EnumMapper.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/mapping/impl/EnumMapper.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/mapping/impl/EnumMapper.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/mapping/impl/EnumMapper.kt</a></b>
<a href="#h87-0" id="h87-0" class="h">@@ -0,0 +1,41 @@
</a><a href="#h87-0-0" id="h87-0-0" class="i">+package me.rhunk.snapenhance.mapping.impl
</a><a href="#h87-0-1" id="h87-0-1" class="i">+
</a><a href="#h87-0-2" id="h87-0-2" class="i">+import me.rhunk.snapenhance.Logger.debug
</a><a href="#h87-0-3" id="h87-0-3" class="i">+import me.rhunk.snapenhance.mapping.Mapper
</a><a href="#h87-0-4" id="h87-0-4" class="i">+import java.lang.reflect.Method
</a><a href="#h87-0-5" id="h87-0-5" class="i">+import java.util.*
</a><a href="#h87-0-6" id="h87-0-6" class="i">+
</a><a href="#h87-0-7" id="h87-0-7" class="i">+
</a><a href="#h87-0-8" id="h87-0-8" class="i">+class EnumMapper : Mapper() {
</a><a href="#h87-0-9" id="h87-0-9" class="i">+    override fun useClasses(
</a><a href="#h87-0-10" id="h87-0-10" class="i">+        classLoader: ClassLoader,
</a><a href="#h87-0-11" id="h87-0-11" class="i">+        classes: List&lt;Class&lt;*&gt;&gt;,
</a><a href="#h87-0-12" id="h87-0-12" class="i">+        mappings: MutableMap&lt;String, Any&gt;
</a><a href="#h87-0-13" id="h87-0-13" class="i">+    ) {
</a><a href="#h87-0-14" id="h87-0-14" class="i">+        val enumMappings = HashMap&lt;String, String&gt;()
</a><a href="#h87-0-15" id="h87-0-15" class="i">+        //settings classes have an interface that extends Serializable and contains the getName method
</a><a href="#h87-0-16" id="h87-0-16" class="i">+        //this enum classes are used to store the settings values
</a><a href="#h87-0-17" id="h87-0-17" class="i">+        //Setting enum class -&gt; implements an interface -&gt; getName method
</a><a href="#h87-0-18" id="h87-0-18" class="i">+        classes.forEach { clazz -&gt;
</a><a href="#h87-0-19" id="h87-0-19" class="i">+            if (!clazz.isEnum) return@forEach
</a><a href="#h87-0-20" id="h87-0-20" class="i">+            if (clazz.interfaces.isEmpty()) return@forEach
</a><a href="#h87-0-21" id="h87-0-21" class="i">+            val serializableInterfaceClass = clazz.interfaces[0]
</a><a href="#h87-0-22" id="h87-0-22" class="i">+            if (serializableInterfaceClass.methods
</a><a href="#h87-0-23" id="h87-0-23" class="i">+                    .filter { method: Method -&gt; method.declaringClass == serializableInterfaceClass }
</a><a href="#h87-0-24" id="h87-0-24" class="i">+                    .none { method: Method -&gt; method.name == &quot;getName&quot; }
</a><a href="#h87-0-25" id="h87-0-25" class="i">+            ) return@forEach
</a><a href="#h87-0-26" id="h87-0-26" class="i">+
</a><a href="#h87-0-27" id="h87-0-27" class="i">+            runCatching {
</a><a href="#h87-0-28" id="h87-0-28" class="i">+                val getEnumNameMethod =
</a><a href="#h87-0-29" id="h87-0-29" class="i">+                    serializableInterfaceClass.methods.first { it!!.returnType.isEnum }
</a><a href="#h87-0-30" id="h87-0-30" class="i">+                clazz.enumConstants?.onEach { enumConstant -&gt;
</a><a href="#h87-0-31" id="h87-0-31" class="i">+                    val enumName =
</a><a href="#h87-0-32" id="h87-0-32" class="i">+                        Objects.requireNonNull(getEnumNameMethod.invoke(enumConstant)).toString()
</a><a href="#h87-0-33" id="h87-0-33" class="i">+                    enumMappings[enumName] = clazz.name
</a><a href="#h87-0-34" id="h87-0-34" class="i">+                }
</a><a href="#h87-0-35" id="h87-0-35" class="i">+            }
</a><a href="#h87-0-36" id="h87-0-36" class="i">+        }
</a><a href="#h87-0-37" id="h87-0-37" class="i">+        debug(&quot;found &quot; + enumMappings.size + &quot; enums&quot;)
</a><a href="#h87-0-38" id="h87-0-38" class="i">+        mappings[&quot;enums&quot;] = enumMappings
</a><a href="#h87-0-39" id="h87-0-39" class="i">+    }
</a><a href="#h87-0-40" id="h87-0-40" class="i">+}</a><a href="#h87-0-41" id="h87-0-41" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h88" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/mapping/impl/OperaPageViewControllerMapper.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/mapping/impl/OperaPageViewControllerMapper.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/mapping/impl/OperaPageViewControllerMapper.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/mapping/impl/OperaPageViewControllerMapper.kt</a></b>
<a href="#h88-0" id="h88-0" class="h">@@ -0,0 +1,77 @@
</a><a href="#h88-0-0" id="h88-0-0" class="i">+package me.rhunk.snapenhance.mapping.impl
</a><a href="#h88-0-1" id="h88-0-1" class="i">+
</a><a href="#h88-0-2" id="h88-0-2" class="i">+import me.rhunk.snapenhance.mapping.Mapper
</a><a href="#h88-0-3" id="h88-0-3" class="i">+import me.rhunk.snapenhance.util.ReflectionHelper
</a><a href="#h88-0-4" id="h88-0-4" class="i">+import java.lang.reflect.Field
</a><a href="#h88-0-5" id="h88-0-5" class="i">+import java.lang.reflect.Method
</a><a href="#h88-0-6" id="h88-0-6" class="i">+import java.lang.reflect.Modifier
</a><a href="#h88-0-7" id="h88-0-7" class="i">+import java.util.*
</a><a href="#h88-0-8" id="h88-0-8" class="i">+
</a><a href="#h88-0-9" id="h88-0-9" class="i">+
</a><a href="#h88-0-10" id="h88-0-10" class="i">+class OperaPageViewControllerMapper : Mapper() {
</a><a href="#h88-0-11" id="h88-0-11" class="i">+    override fun useClasses(
</a><a href="#h88-0-12" id="h88-0-12" class="i">+        classLoader: ClassLoader,
</a><a href="#h88-0-13" id="h88-0-13" class="i">+        classes: List&lt;Class&lt;*&gt;&gt;,
</a><a href="#h88-0-14" id="h88-0-14" class="i">+        mappings: MutableMap&lt;String, Any&gt;
</a><a href="#h88-0-15" id="h88-0-15" class="i">+    ) {
</a><a href="#h88-0-16" id="h88-0-16" class="i">+        var operaPageViewControllerClass: Class&lt;*&gt;? = null
</a><a href="#h88-0-17" id="h88-0-17" class="i">+        for (aClass in classes) {
</a><a href="#h88-0-18" id="h88-0-18" class="i">+            if (!Modifier.isAbstract(aClass.modifiers)) continue
</a><a href="#h88-0-19" id="h88-0-19" class="i">+            if (aClass.interfaces.isEmpty()) continue
</a><a href="#h88-0-20" id="h88-0-20" class="i">+            val foundFields = Arrays.stream(aClass.declaredFields).filter { field: Field -&gt;
</a><a href="#h88-0-21" id="h88-0-21" class="i">+                val modifiers = field.modifiers
</a><a href="#h88-0-22" id="h88-0-22" class="i">+                Modifier.isStatic(modifiers) &amp;&amp; Modifier.isFinal(
</a><a href="#h88-0-23" id="h88-0-23" class="i">+                    modifiers
</a><a href="#h88-0-24" id="h88-0-24" class="i">+                )
</a><a href="#h88-0-25" id="h88-0-25" class="i">+            }.filter { field: Field -&gt;
</a><a href="#h88-0-26" id="h88-0-26" class="i">+                try {
</a><a href="#h88-0-27" id="h88-0-27" class="i">+                    return@filter &quot;ad_product_type&quot; == String.format(&quot;%s&quot;, field[null])
</a><a href="#h88-0-28" id="h88-0-28" class="i">+                } catch (e: IllegalAccessException) {
</a><a href="#h88-0-29" id="h88-0-29" class="i">+                    e.printStackTrace()
</a><a href="#h88-0-30" id="h88-0-30" class="i">+                }
</a><a href="#h88-0-31" id="h88-0-31" class="i">+                false
</a><a href="#h88-0-32" id="h88-0-32" class="i">+            }.count()
</a><a href="#h88-0-33" id="h88-0-33" class="i">+            if (foundFields == 0L) continue
</a><a href="#h88-0-34" id="h88-0-34" class="i">+            operaPageViewControllerClass = aClass
</a><a href="#h88-0-35" id="h88-0-35" class="i">+            break
</a><a href="#h88-0-36" id="h88-0-36" class="i">+        }
</a><a href="#h88-0-37" id="h88-0-37" class="i">+        if (operaPageViewControllerClass == null) throw RuntimeException(&quot;OperaPageViewController not found&quot;)
</a><a href="#h88-0-38" id="h88-0-38" class="i">+
</a><a href="#h88-0-39" id="h88-0-39" class="i">+        val members = HashMap&lt;String, String&gt;()
</a><a href="#h88-0-40" id="h88-0-40" class="i">+        members[&quot;Class&quot;] = operaPageViewControllerClass.name
</a><a href="#h88-0-41" id="h88-0-41" class="i">+
</a><a href="#h88-0-42" id="h88-0-42" class="i">+        operaPageViewControllerClass.fields.forEach { field -&gt;
</a><a href="#h88-0-43" id="h88-0-43" class="i">+            val fieldType = field.type
</a><a href="#h88-0-44" id="h88-0-44" class="i">+            if (fieldType.isEnum) {
</a><a href="#h88-0-45" id="h88-0-45" class="i">+                fieldType.enumConstants.firstOrNull { enumConstant: Any -&gt; enumConstant.toString() == &quot;FULLY_DISPLAYED&quot; }
</a><a href="#h88-0-46" id="h88-0-46" class="i">+                    .let { members[&quot;viewStateField&quot;] = field.name }
</a><a href="#h88-0-47" id="h88-0-47" class="i">+            }
</a><a href="#h88-0-48" id="h88-0-48" class="i">+            if (fieldType == ArrayList::class.java) {
</a><a href="#h88-0-49" id="h88-0-49" class="i">+                members[&quot;layerListField&quot;] = field.name
</a><a href="#h88-0-50" id="h88-0-50" class="i">+            }
</a><a href="#h88-0-51" id="h88-0-51" class="i">+        }
</a><a href="#h88-0-52" id="h88-0-52" class="i">+        val enumViewStateClass = operaPageViewControllerClass.fields.first { field: Field -&gt;
</a><a href="#h88-0-53" id="h88-0-53" class="i">+            field.name == members[&quot;viewStateField&quot;]
</a><a href="#h88-0-54" id="h88-0-54" class="i">+        }.type
</a><a href="#h88-0-55" id="h88-0-55" class="i">+
</a><a href="#h88-0-56" id="h88-0-56" class="i">+        //find the method that call the onDisplayStateChange method
</a><a href="#h88-0-57" id="h88-0-57" class="i">+        members[&quot;onDisplayStateChange&quot;] =
</a><a href="#h88-0-58" id="h88-0-58" class="i">+            operaPageViewControllerClass.methods.first { method: Method -&gt;
</a><a href="#h88-0-59" id="h88-0-59" class="i">+                if (method.returnType != Void.TYPE || method.parameterTypes.size != 1) return@first false
</a><a href="#h88-0-60" id="h88-0-60" class="i">+                val firstParameterClass = method.parameterTypes[0]
</a><a href="#h88-0-61" id="h88-0-61" class="i">+                //check if the class contains a field with the enumViewStateClass type
</a><a href="#h88-0-62" id="h88-0-62" class="i">+                ReflectionHelper.searchFieldByType(firstParameterClass, enumViewStateClass) != null
</a><a href="#h88-0-63" id="h88-0-63" class="i">+            }.name
</a><a href="#h88-0-64" id="h88-0-64" class="i">+
</a><a href="#h88-0-65" id="h88-0-65" class="i">+        //find the method that call the onDisplayStateChange method from gestures
</a><a href="#h88-0-66" id="h88-0-66" class="i">+        members[&quot;onDisplayStateChange2&quot;] =
</a><a href="#h88-0-67" id="h88-0-67" class="i">+            operaPageViewControllerClass.methods.first { method: Method -&gt;
</a><a href="#h88-0-68" id="h88-0-68" class="i">+                if (method.returnType != Void.TYPE || method.parameterTypes.size != 2) return@first false
</a><a href="#h88-0-69" id="h88-0-69" class="i">+                val firstParameterClass = method.parameterTypes[0]
</a><a href="#h88-0-70" id="h88-0-70" class="i">+                val secondParameterClass = method.parameterTypes[1]
</a><a href="#h88-0-71" id="h88-0-71" class="i">+                firstParameterClass.isEnum &amp;&amp; secondParameterClass.isEnum
</a><a href="#h88-0-72" id="h88-0-72" class="i">+            }.name
</a><a href="#h88-0-73" id="h88-0-73" class="i">+
</a><a href="#h88-0-74" id="h88-0-74" class="i">+        mappings[&quot;OperaPageViewController&quot;] = members
</a><a href="#h88-0-75" id="h88-0-75" class="i">+    }
</a><a href="#h88-0-76" id="h88-0-76" class="i">+}
</a><b>diff --git a/<a id="h89" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/mapping/impl/PlusSubscriptionMapper.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/mapping/impl/PlusSubscriptionMapper.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/mapping/impl/PlusSubscriptionMapper.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/mapping/impl/PlusSubscriptionMapper.kt</a></b>
<a href="#h89-0" id="h89-0" class="h">@@ -0,0 +1,32 @@
</a><a href="#h89-0-0" id="h89-0-0" class="i">+package me.rhunk.snapenhance.mapping.impl
</a><a href="#h89-0-1" id="h89-0-1" class="i">+
</a><a href="#h89-0-2" id="h89-0-2" class="i">+import me.rhunk.snapenhance.Logger
</a><a href="#h89-0-3" id="h89-0-3" class="i">+import me.rhunk.snapenhance.mapping.Mapper
</a><a href="#h89-0-4" id="h89-0-4" class="i">+import java.lang.reflect.Field
</a><a href="#h89-0-5" id="h89-0-5" class="i">+import java.lang.reflect.Method
</a><a href="#h89-0-6" id="h89-0-6" class="i">+
</a><a href="#h89-0-7" id="h89-0-7" class="i">+
</a><a href="#h89-0-8" id="h89-0-8" class="i">+class PlusSubscriptionMapper : Mapper() {
</a><a href="#h89-0-9" id="h89-0-9" class="i">+    override fun useClasses(
</a><a href="#h89-0-10" id="h89-0-10" class="i">+        classLoader: ClassLoader,
</a><a href="#h89-0-11" id="h89-0-11" class="i">+        classes: List&lt;Class&lt;*&gt;&gt;,
</a><a href="#h89-0-12" id="h89-0-12" class="i">+        mappings: MutableMap&lt;String, Any&gt;
</a><a href="#h89-0-13" id="h89-0-13" class="i">+    ) {
</a><a href="#h89-0-14" id="h89-0-14" class="i">+        //find a method that contains annotations with isSubscribed
</a><a href="#h89-0-15" id="h89-0-15" class="i">+        val loadSubscriptionMethod = context.classCache.composerLocalSubscriptionStore.declaredMethods.first { method: Method -&gt;
</a><a href="#h89-0-16" id="h89-0-16" class="i">+                val returnType = method.returnType
</a><a href="#h89-0-17" id="h89-0-17" class="i">+                returnType.declaredFields.any { field: Field -&gt;
</a><a href="#h89-0-18" id="h89-0-18" class="i">+                    field.declaredAnnotations.any { annotation: Annotation -&gt;
</a><a href="#h89-0-19" id="h89-0-19" class="i">+                        annotation.toString().contains(&quot;isSubscribed&quot;)
</a><a href="#h89-0-20" id="h89-0-20" class="i">+                    }
</a><a href="#h89-0-21" id="h89-0-21" class="i">+                }
</a><a href="#h89-0-22" id="h89-0-22" class="i">+            }
</a><a href="#h89-0-23" id="h89-0-23" class="i">+        //get the first param of the method which is the PlusSubscriptionState class
</a><a href="#h89-0-24" id="h89-0-24" class="i">+        val plusSubscriptionStateClass = loadSubscriptionMethod.parameterTypes[0]
</a><a href="#h89-0-25" id="h89-0-25" class="i">+        //get the first param of the constructor of PlusSubscriptionState which is the SubscriptionInfo class
</a><a href="#h89-0-26" id="h89-0-26" class="i">+        val subscriptionInfoClass = plusSubscriptionStateClass.constructors[0].parameterTypes[0]
</a><a href="#h89-0-27" id="h89-0-27" class="i">+        Logger.debug(&quot;subscriptionInfoClass ${subscriptionInfoClass.name}&quot;)
</a><a href="#h89-0-28" id="h89-0-28" class="i">+
</a><a href="#h89-0-29" id="h89-0-29" class="i">+        mappings[&quot;SubscriptionInfoClass&quot;] = subscriptionInfoClass.name
</a><a href="#h89-0-30" id="h89-0-30" class="i">+    }
</a><a href="#h89-0-31" id="h89-0-31" class="i">+}</a><a href="#h89-0-32" id="h89-0-32" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h90" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/util/CallbackBuilder.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/util/CallbackBuilder.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/util/CallbackBuilder.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/util/CallbackBuilder.kt</a></b>
<a href="#h90-0" id="h90-0" class="h">@@ -0,0 +1,93 @@
</a><a href="#h90-0-0" id="h90-0-0" class="i">+package me.rhunk.snapenhance.util
</a><a href="#h90-0-1" id="h90-0-1" class="i">+
</a><a href="#h90-0-2" id="h90-0-2" class="i">+import de.robv.android.xposed.XC_MethodHook
</a><a href="#h90-0-3" id="h90-0-3" class="i">+import me.rhunk.snapenhance.hook.HookAdapter
</a><a href="#h90-0-4" id="h90-0-4" class="i">+import me.rhunk.snapenhance.hook.HookStage
</a><a href="#h90-0-5" id="h90-0-5" class="i">+import me.rhunk.snapenhance.hook.Hooker
</a><a href="#h90-0-6" id="h90-0-6" class="i">+import java.lang.reflect.Constructor
</a><a href="#h90-0-7" id="h90-0-7" class="i">+import java.lang.reflect.Field
</a><a href="#h90-0-8" id="h90-0-8" class="i">+import java.lang.reflect.Modifier
</a><a href="#h90-0-9" id="h90-0-9" class="i">+
</a><a href="#h90-0-10" id="h90-0-10" class="i">+class CallbackBuilder(
</a><a href="#h90-0-11" id="h90-0-11" class="i">+    private val callbackClass: Class&lt;*&gt;
</a><a href="#h90-0-12" id="h90-0-12" class="i">+) {
</a><a href="#h90-0-13" id="h90-0-13" class="i">+    internal class Override(
</a><a href="#h90-0-14" id="h90-0-14" class="i">+        val methodName: String,
</a><a href="#h90-0-15" id="h90-0-15" class="i">+        val callback: (HookAdapter) -&gt; Unit
</a><a href="#h90-0-16" id="h90-0-16" class="i">+    )
</a><a href="#h90-0-17" id="h90-0-17" class="i">+
</a><a href="#h90-0-18" id="h90-0-18" class="i">+    private val methodOverrides = mutableListOf&lt;Override&gt;()
</a><a href="#h90-0-19" id="h90-0-19" class="i">+
</a><a href="#h90-0-20" id="h90-0-20" class="i">+    fun override(methodName: String, callback: (HookAdapter) -&gt; Unit = {}): CallbackBuilder {
</a><a href="#h90-0-21" id="h90-0-21" class="i">+        methodOverrides.add(Override(methodName, callback))
</a><a href="#h90-0-22" id="h90-0-22" class="i">+        return this
</a><a href="#h90-0-23" id="h90-0-23" class="i">+    }
</a><a href="#h90-0-24" id="h90-0-24" class="i">+
</a><a href="#h90-0-25" id="h90-0-25" class="i">+    fun build(): Any {
</a><a href="#h90-0-26" id="h90-0-26" class="i">+        //get the first param of the first constructor to get the class of the invoker
</a><a href="#h90-0-27" id="h90-0-27" class="i">+        val invokerClass: Class&lt;*&gt; = callbackClass.constructors[0].parameterTypes[0]
</a><a href="#h90-0-28" id="h90-0-28" class="i">+        //get the invoker field based on the invoker class
</a><a href="#h90-0-29" id="h90-0-29" class="i">+        val invokerField = callbackClass.fields.first { field: Field -&gt;
</a><a href="#h90-0-30" id="h90-0-30" class="i">+            field.type.isAssignableFrom(invokerClass)
</a><a href="#h90-0-31" id="h90-0-31" class="i">+        }
</a><a href="#h90-0-32" id="h90-0-32" class="i">+        //get the callback field based on the callback class
</a><a href="#h90-0-33" id="h90-0-33" class="i">+        val callbackInstance = createEmptyObject(callbackClass.constructors[0])!!
</a><a href="#h90-0-34" id="h90-0-34" class="i">+        val callbackInstanceHashCode: Int = callbackInstance.hashCode()
</a><a href="#h90-0-35" id="h90-0-35" class="i">+        val callbackInstanceClass = callbackInstance.javaClass
</a><a href="#h90-0-36" id="h90-0-36" class="i">+
</a><a href="#h90-0-37" id="h90-0-37" class="i">+        val unhooks = mutableListOf&lt;XC_MethodHook.Unhook&gt;()
</a><a href="#h90-0-38" id="h90-0-38" class="i">+
</a><a href="#h90-0-39" id="h90-0-39" class="i">+        callbackInstanceClass.methods.forEach { method -&gt;
</a><a href="#h90-0-40" id="h90-0-40" class="i">+            if (method.declaringClass != callbackInstanceClass) return@forEach
</a><a href="#h90-0-41" id="h90-0-41" class="i">+            if (Modifier.isPrivate(method.modifiers)) return@forEach
</a><a href="#h90-0-42" id="h90-0-42" class="i">+
</a><a href="#h90-0-43" id="h90-0-43" class="i">+            //default hook that unhooks the callback and returns null
</a><a href="#h90-0-44" id="h90-0-44" class="i">+            val defaultHook: (HookAdapter) -&gt; Boolean = defaultHook@{
</a><a href="#h90-0-45" id="h90-0-45" class="i">+                //checking invokerField ensure that&#39;s the callback was created by the CallbackBuilder
</a><a href="#h90-0-46" id="h90-0-46" class="i">+                if (invokerField.get(it.thisObject()) != null) return@defaultHook false
</a><a href="#h90-0-47" id="h90-0-47" class="i">+                if ((it.thisObject() as Any).hashCode() != callbackInstanceHashCode) return@defaultHook false
</a><a href="#h90-0-48" id="h90-0-48" class="i">+
</a><a href="#h90-0-49" id="h90-0-49" class="i">+                it.setResult(null)
</a><a href="#h90-0-50" id="h90-0-50" class="i">+                unhooks.forEach { unhook -&gt; unhook.unhook() }
</a><a href="#h90-0-51" id="h90-0-51" class="i">+                true
</a><a href="#h90-0-52" id="h90-0-52" class="i">+            }
</a><a href="#h90-0-53" id="h90-0-53" class="i">+
</a><a href="#h90-0-54" id="h90-0-54" class="i">+            var hook: (HookAdapter) -&gt; Unit = { defaultHook(it) }
</a><a href="#h90-0-55" id="h90-0-55" class="i">+
</a><a href="#h90-0-56" id="h90-0-56" class="i">+            //override the default hook if the method is in the override list
</a><a href="#h90-0-57" id="h90-0-57" class="i">+            methodOverrides.find { it.methodName == method.name }?.run {
</a><a href="#h90-0-58" id="h90-0-58" class="i">+                hook = {
</a><a href="#h90-0-59" id="h90-0-59" class="i">+                    if (defaultHook(it)) {
</a><a href="#h90-0-60" id="h90-0-60" class="i">+                        callback(it)
</a><a href="#h90-0-61" id="h90-0-61" class="i">+                    }
</a><a href="#h90-0-62" id="h90-0-62" class="i">+                }
</a><a href="#h90-0-63" id="h90-0-63" class="i">+            }
</a><a href="#h90-0-64" id="h90-0-64" class="i">+
</a><a href="#h90-0-65" id="h90-0-65" class="i">+            unhooks.add(Hooker.hook(method, HookStage.BEFORE, hook))
</a><a href="#h90-0-66" id="h90-0-66" class="i">+        }
</a><a href="#h90-0-67" id="h90-0-67" class="i">+        return callbackInstance
</a><a href="#h90-0-68" id="h90-0-68" class="i">+    }
</a><a href="#h90-0-69" id="h90-0-69" class="i">+
</a><a href="#h90-0-70" id="h90-0-70" class="i">+    companion object {
</a><a href="#h90-0-71" id="h90-0-71" class="i">+        private fun createEmptyObject(constructor: Constructor&lt;*&gt;): Any? {
</a><a href="#h90-0-72" id="h90-0-72" class="i">+            //compute the args for the constructor with null or default primitive values
</a><a href="#h90-0-73" id="h90-0-73" class="i">+            val args = constructor.parameterTypes.map { type: Class&lt;*&gt; -&gt;
</a><a href="#h90-0-74" id="h90-0-74" class="i">+                if (type.isPrimitive) {
</a><a href="#h90-0-75" id="h90-0-75" class="i">+                    when (type.name) {
</a><a href="#h90-0-76" id="h90-0-76" class="i">+                        &quot;boolean&quot; -&gt; return@map false
</a><a href="#h90-0-77" id="h90-0-77" class="i">+                        &quot;byte&quot; -&gt; return@map 0.toByte()
</a><a href="#h90-0-78" id="h90-0-78" class="i">+                        &quot;char&quot; -&gt; return@map 0.toChar()
</a><a href="#h90-0-79" id="h90-0-79" class="i">+                        &quot;short&quot; -&gt; return@map 0.toShort()
</a><a href="#h90-0-80" id="h90-0-80" class="i">+                        &quot;int&quot; -&gt; return@map 0
</a><a href="#h90-0-81" id="h90-0-81" class="i">+                        &quot;long&quot; -&gt; return@map 0L
</a><a href="#h90-0-82" id="h90-0-82" class="i">+                        &quot;float&quot; -&gt; return@map 0f
</a><a href="#h90-0-83" id="h90-0-83" class="i">+                        &quot;double&quot; -&gt; return@map 0.0
</a><a href="#h90-0-84" id="h90-0-84" class="i">+                    }
</a><a href="#h90-0-85" id="h90-0-85" class="i">+                }
</a><a href="#h90-0-86" id="h90-0-86" class="i">+                null
</a><a href="#h90-0-87" id="h90-0-87" class="i">+            }.toTypedArray()
</a><a href="#h90-0-88" id="h90-0-88" class="i">+            return constructor.newInstance(*args)
</a><a href="#h90-0-89" id="h90-0-89" class="i">+        }
</a><a href="#h90-0-90" id="h90-0-90" class="i">+
</a><a href="#h90-0-91" id="h90-0-91" class="i">+    }
</a><a href="#h90-0-92" id="h90-0-92" class="i">+}</a><a href="#h90-0-93" id="h90-0-93" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h91" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/util/EncryptionHelper.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/util/EncryptionHelper.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/util/EncryptionHelper.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/util/EncryptionHelper.kt</a></b>
<a href="#h91-0" id="h91-0" class="h">@@ -0,0 +1,67 @@
</a><a href="#h91-0-0" id="h91-0-0" class="i">+package me.rhunk.snapenhance.util
</a><a href="#h91-0-1" id="h91-0-1" class="i">+
</a><a href="#h91-0-2" id="h91-0-2" class="i">+import me.rhunk.snapenhance.Constants
</a><a href="#h91-0-3" id="h91-0-3" class="i">+import me.rhunk.snapenhance.data.ContentType
</a><a href="#h91-0-4" id="h91-0-4" class="i">+import me.rhunk.snapenhance.util.protobuf.ProtoReader
</a><a href="#h91-0-5" id="h91-0-5" class="i">+import java.io.InputStream
</a><a href="#h91-0-6" id="h91-0-6" class="i">+import java.util.*
</a><a href="#h91-0-7" id="h91-0-7" class="i">+import javax.crypto.Cipher
</a><a href="#h91-0-8" id="h91-0-8" class="i">+import javax.crypto.CipherInputStream
</a><a href="#h91-0-9" id="h91-0-9" class="i">+import javax.crypto.spec.IvParameterSpec
</a><a href="#h91-0-10" id="h91-0-10" class="i">+import javax.crypto.spec.SecretKeySpec
</a><a href="#h91-0-11" id="h91-0-11" class="i">+
</a><a href="#h91-0-12" id="h91-0-12" class="i">+object EncryptionUtils {
</a><a href="#h91-0-13" id="h91-0-13" class="i">+    fun decryptInputStreamFromArroyo(
</a><a href="#h91-0-14" id="h91-0-14" class="i">+        inputStream: InputStream,
</a><a href="#h91-0-15" id="h91-0-15" class="i">+        contentType: ContentType,
</a><a href="#h91-0-16" id="h91-0-16" class="i">+        messageProto: ProtoReader
</a><a href="#h91-0-17" id="h91-0-17" class="i">+    ): InputStream {
</a><a href="#h91-0-18" id="h91-0-18" class="i">+        var resultInputStream = inputStream
</a><a href="#h91-0-19" id="h91-0-19" class="i">+        val encryptionProtoPath: IntArray = when (contentType) {
</a><a href="#h91-0-20" id="h91-0-20" class="i">+            ContentType.NOTE -&gt; Constants.ARROYO_NOTE_ENCRYPTION_PROTO_PATH
</a><a href="#h91-0-21" id="h91-0-21" class="i">+            ContentType.SNAP -&gt; Constants.ARROYO_SNAP_ENCRYPTION_PROTO_PATH
</a><a href="#h91-0-22" id="h91-0-22" class="i">+            ContentType.EXTERNAL_MEDIA -&gt; Constants.ARROYO_EXTERNAL_MEDIA_ENCRYPTION_PROTO_PATH
</a><a href="#h91-0-23" id="h91-0-23" class="i">+            else -&gt; throw IllegalArgumentException(&quot;Invalid content type: $contentType&quot;)
</a><a href="#h91-0-24" id="h91-0-24" class="i">+        }
</a><a href="#h91-0-25" id="h91-0-25" class="i">+
</a><a href="#h91-0-26" id="h91-0-26" class="i">+        //decrypt the content if needed
</a><a href="#h91-0-27" id="h91-0-27" class="i">+        messageProto.readPath(*encryptionProtoPath)?.let {
</a><a href="#h91-0-28" id="h91-0-28" class="i">+            val encryptionProtoIndex: Int = if (it.exists(Constants.ARROYO_ENCRYPTION_PROTO_INDEX_V2)) {
</a><a href="#h91-0-29" id="h91-0-29" class="i">+                Constants.ARROYO_ENCRYPTION_PROTO_INDEX_V2
</a><a href="#h91-0-30" id="h91-0-30" class="i">+            } else if (it.exists(Constants.ARROYO_ENCRYPTION_PROTO_INDEX)) {
</a><a href="#h91-0-31" id="h91-0-31" class="i">+                Constants.ARROYO_ENCRYPTION_PROTO_INDEX
</a><a href="#h91-0-32" id="h91-0-32" class="i">+            } else {
</a><a href="#h91-0-33" id="h91-0-33" class="i">+                return resultInputStream
</a><a href="#h91-0-34" id="h91-0-34" class="i">+            }
</a><a href="#h91-0-35" id="h91-0-35" class="i">+            resultInputStream = decryptInputStream(
</a><a href="#h91-0-36" id="h91-0-36" class="i">+                resultInputStream,
</a><a href="#h91-0-37" id="h91-0-37" class="i">+                encryptionProtoIndex == Constants.ARROYO_ENCRYPTION_PROTO_INDEX_V2,
</a><a href="#h91-0-38" id="h91-0-38" class="i">+                it,
</a><a href="#h91-0-39" id="h91-0-39" class="i">+                encryptionProtoIndex
</a><a href="#h91-0-40" id="h91-0-40" class="i">+            )
</a><a href="#h91-0-41" id="h91-0-41" class="i">+        }
</a><a href="#h91-0-42" id="h91-0-42" class="i">+        return resultInputStream
</a><a href="#h91-0-43" id="h91-0-43" class="i">+    }
</a><a href="#h91-0-44" id="h91-0-44" class="i">+
</a><a href="#h91-0-45" id="h91-0-45" class="i">+    fun decryptInputStream(
</a><a href="#h91-0-46" id="h91-0-46" class="i">+        inputStream: InputStream,
</a><a href="#h91-0-47" id="h91-0-47" class="i">+        base64Encryption: Boolean,
</a><a href="#h91-0-48" id="h91-0-48" class="i">+        mediaInfoProto: ProtoReader,
</a><a href="#h91-0-49" id="h91-0-49" class="i">+        encryptionProtoIndex: Int
</a><a href="#h91-0-50" id="h91-0-50" class="i">+    ): InputStream {
</a><a href="#h91-0-51" id="h91-0-51" class="i">+        val mediaEncryption = mediaInfoProto.readPath(encryptionProtoIndex)!!
</a><a href="#h91-0-52" id="h91-0-52" class="i">+        var key: ByteArray = mediaEncryption.getByteArray(1)!!
</a><a href="#h91-0-53" id="h91-0-53" class="i">+        var iv: ByteArray = mediaEncryption.getByteArray(2)!!
</a><a href="#h91-0-54" id="h91-0-54" class="i">+
</a><a href="#h91-0-55" id="h91-0-55" class="i">+        //audio note and external medias have their key and iv encoded in base64
</a><a href="#h91-0-56" id="h91-0-56" class="i">+        if (base64Encryption) {
</a><a href="#h91-0-57" id="h91-0-57" class="i">+            val decoder = Base64.getMimeDecoder()
</a><a href="#h91-0-58" id="h91-0-58" class="i">+            key = decoder.decode(key)
</a><a href="#h91-0-59" id="h91-0-59" class="i">+            iv = decoder.decode(iv)
</a><a href="#h91-0-60" id="h91-0-60" class="i">+        }
</a><a href="#h91-0-61" id="h91-0-61" class="i">+
</a><a href="#h91-0-62" id="h91-0-62" class="i">+        val cipher = Cipher.getInstance(&quot;AES/CBC/PKCS5Padding&quot;)
</a><a href="#h91-0-63" id="h91-0-63" class="i">+        cipher.init(Cipher.DECRYPT_MODE, SecretKeySpec(key, &quot;AES&quot;), IvParameterSpec(iv))
</a><a href="#h91-0-64" id="h91-0-64" class="i">+        return CipherInputStream(inputStream, cipher)
</a><a href="#h91-0-65" id="h91-0-65" class="i">+    }
</a><a href="#h91-0-66" id="h91-0-66" class="i">+}
</a><b>diff --git a/<a id="h92" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/util/PreviewCreator.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/util/PreviewCreator.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/util/PreviewCreator.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/util/PreviewCreator.kt</a></b>
<a href="#h92-0" id="h92-0" class="h">@@ -0,0 +1,41 @@
</a><a href="#h92-0-0" id="h92-0-0" class="i">+package me.rhunk.snapenhance.util
</a><a href="#h92-0-1" id="h92-0-1" class="i">+
</a><a href="#h92-0-2" id="h92-0-2" class="i">+import android.graphics.Bitmap
</a><a href="#h92-0-3" id="h92-0-3" class="i">+import android.graphics.BitmapFactory
</a><a href="#h92-0-4" id="h92-0-4" class="i">+import android.media.MediaDataSource
</a><a href="#h92-0-5" id="h92-0-5" class="i">+import android.media.MediaMetadataRetriever
</a><a href="#h92-0-6" id="h92-0-6" class="i">+
</a><a href="#h92-0-7" id="h92-0-7" class="i">+object PreviewUtils {
</a><a href="#h92-0-8" id="h92-0-8" class="i">+    fun createPreview(data: ByteArray, isVideo: Boolean): Bitmap? {
</a><a href="#h92-0-9" id="h92-0-9" class="i">+        if (!isVideo) {
</a><a href="#h92-0-10" id="h92-0-10" class="i">+            return BitmapFactory.decodeByteArray(data, 0, data.size)
</a><a href="#h92-0-11" id="h92-0-11" class="i">+        }
</a><a href="#h92-0-12" id="h92-0-12" class="i">+        val retriever = MediaMetadataRetriever()
</a><a href="#h92-0-13" id="h92-0-13" class="i">+        retriever.setDataSource(object : MediaDataSource() {
</a><a href="#h92-0-14" id="h92-0-14" class="i">+            override fun readAt(
</a><a href="#h92-0-15" id="h92-0-15" class="i">+                position: Long,
</a><a href="#h92-0-16" id="h92-0-16" class="i">+                buffer: ByteArray,
</a><a href="#h92-0-17" id="h92-0-17" class="i">+                offset: Int,
</a><a href="#h92-0-18" id="h92-0-18" class="i">+                size: Int
</a><a href="#h92-0-19" id="h92-0-19" class="i">+            ): Int {
</a><a href="#h92-0-20" id="h92-0-20" class="i">+                var newSize = size
</a><a href="#h92-0-21" id="h92-0-21" class="i">+                val length = data.size
</a><a href="#h92-0-22" id="h92-0-22" class="i">+                if (position &gt;= length) {
</a><a href="#h92-0-23" id="h92-0-23" class="i">+                    return -1
</a><a href="#h92-0-24" id="h92-0-24" class="i">+                }
</a><a href="#h92-0-25" id="h92-0-25" class="i">+                if (position + newSize &gt; length) {
</a><a href="#h92-0-26" id="h92-0-26" class="i">+                    newSize = length - position.toInt()
</a><a href="#h92-0-27" id="h92-0-27" class="i">+                }
</a><a href="#h92-0-28" id="h92-0-28" class="i">+                System.arraycopy(data, position.toInt(), buffer, offset, newSize)
</a><a href="#h92-0-29" id="h92-0-29" class="i">+                return newSize
</a><a href="#h92-0-30" id="h92-0-30" class="i">+            }
</a><a href="#h92-0-31" id="h92-0-31" class="i">+
</a><a href="#h92-0-32" id="h92-0-32" class="i">+            override fun getSize(): Long {
</a><a href="#h92-0-33" id="h92-0-33" class="i">+                return data.size.toLong()
</a><a href="#h92-0-34" id="h92-0-34" class="i">+            }
</a><a href="#h92-0-35" id="h92-0-35" class="i">+
</a><a href="#h92-0-36" id="h92-0-36" class="i">+            override fun close() {}
</a><a href="#h92-0-37" id="h92-0-37" class="i">+        })
</a><a href="#h92-0-38" id="h92-0-38" class="i">+        return retriever.getFrameAtTime(0, MediaMetadataRetriever.OPTION_CLOSEST_SYNC)
</a><a href="#h92-0-39" id="h92-0-39" class="i">+    }
</a><a href="#h92-0-40" id="h92-0-40" class="i">+}
</a><b>diff --git a/<a id="h93" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/util/ReflectionHelper.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/util/ReflectionHelper.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/util/ReflectionHelper.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/util/ReflectionHelper.kt</a></b>
<a href="#h93-0" id="h93-0" class="h">@@ -0,0 +1,118 @@
</a><a href="#h93-0-0" id="h93-0-0" class="i">+package me.rhunk.snapenhance.util
</a><a href="#h93-0-1" id="h93-0-1" class="i">+
</a><a href="#h93-0-2" id="h93-0-2" class="i">+import java.lang.reflect.Field
</a><a href="#h93-0-3" id="h93-0-3" class="i">+import java.lang.reflect.Method
</a><a href="#h93-0-4" id="h93-0-4" class="i">+import java.util.*
</a><a href="#h93-0-5" id="h93-0-5" class="i">+
</a><a href="#h93-0-6" id="h93-0-6" class="i">+object ReflectionHelper {
</a><a href="#h93-0-7" id="h93-0-7" class="i">+    /**
</a><a href="#h93-0-8" id="h93-0-8" class="i">+     * Searches for a field with a class that has a method with the specified name
</a><a href="#h93-0-9" id="h93-0-9" class="i">+     */
</a><a href="#h93-0-10" id="h93-0-10" class="i">+    fun searchFieldWithClassMethod(clazz: Class&lt;*&gt;, methodName: String): Field? {
</a><a href="#h93-0-11" id="h93-0-11" class="i">+        return clazz.declaredFields.firstOrNull { f: Field? -&gt;
</a><a href="#h93-0-12" id="h93-0-12" class="i">+            try {
</a><a href="#h93-0-13" id="h93-0-13" class="i">+                return@firstOrNull Arrays.stream(
</a><a href="#h93-0-14" id="h93-0-14" class="i">+                    f!!.type.declaredMethods
</a><a href="#h93-0-15" id="h93-0-15" class="i">+                ).anyMatch { method: Method -&gt; method.name == methodName }
</a><a href="#h93-0-16" id="h93-0-16" class="i">+            } catch (e: Exception) {
</a><a href="#h93-0-17" id="h93-0-17" class="i">+                return@firstOrNull false
</a><a href="#h93-0-18" id="h93-0-18" class="i">+            }
</a><a href="#h93-0-19" id="h93-0-19" class="i">+        }
</a><a href="#h93-0-20" id="h93-0-20" class="i">+    }
</a><a href="#h93-0-21" id="h93-0-21" class="i">+
</a><a href="#h93-0-22" id="h93-0-22" class="i">+    fun searchFieldByType(clazz: Class&lt;*&gt;, type: Class&lt;*&gt;): Field? {
</a><a href="#h93-0-23" id="h93-0-23" class="i">+        return clazz.declaredFields.firstOrNull { f: Field? -&gt; f!!.type == type }
</a><a href="#h93-0-24" id="h93-0-24" class="i">+    }
</a><a href="#h93-0-25" id="h93-0-25" class="i">+
</a><a href="#h93-0-26" id="h93-0-26" class="i">+    fun searchFieldTypeInSuperClasses(clazz: Class&lt;*&gt;, type: Class&lt;*&gt;): Field? {
</a><a href="#h93-0-27" id="h93-0-27" class="i">+        val field = searchFieldByType(clazz, type)
</a><a href="#h93-0-28" id="h93-0-28" class="i">+        if (field != null) {
</a><a href="#h93-0-29" id="h93-0-29" class="i">+            return field
</a><a href="#h93-0-30" id="h93-0-30" class="i">+        }
</a><a href="#h93-0-31" id="h93-0-31" class="i">+        val superclass = clazz.superclass
</a><a href="#h93-0-32" id="h93-0-32" class="i">+        return superclass?.let { searchFieldTypeInSuperClasses(it, type) }
</a><a href="#h93-0-33" id="h93-0-33" class="i">+    }
</a><a href="#h93-0-34" id="h93-0-34" class="i">+
</a><a href="#h93-0-35" id="h93-0-35" class="i">+    fun searchFieldStartsWithToString(
</a><a href="#h93-0-36" id="h93-0-36" class="i">+        clazz: Class&lt;*&gt;,
</a><a href="#h93-0-37" id="h93-0-37" class="i">+        instance: Any,
</a><a href="#h93-0-38" id="h93-0-38" class="i">+        toString: String?
</a><a href="#h93-0-39" id="h93-0-39" class="i">+    ): Field? {
</a><a href="#h93-0-40" id="h93-0-40" class="i">+        return clazz.declaredFields.firstOrNull { f: Field -&gt;
</a><a href="#h93-0-41" id="h93-0-41" class="i">+            try {
</a><a href="#h93-0-42" id="h93-0-42" class="i">+                f.isAccessible = true
</a><a href="#h93-0-43" id="h93-0-43" class="i">+                return@firstOrNull Objects.requireNonNull(f[instance]).toString()
</a><a href="#h93-0-44" id="h93-0-44" class="i">+                    .startsWith(
</a><a href="#h93-0-45" id="h93-0-45" class="i">+                        toString!!
</a><a href="#h93-0-46" id="h93-0-46" class="i">+                    )
</a><a href="#h93-0-47" id="h93-0-47" class="i">+            } catch (e: Throwable) {
</a><a href="#h93-0-48" id="h93-0-48" class="i">+                return@firstOrNull false
</a><a href="#h93-0-49" id="h93-0-49" class="i">+            }
</a><a href="#h93-0-50" id="h93-0-50" class="i">+        }
</a><a href="#h93-0-51" id="h93-0-51" class="i">+    }
</a><a href="#h93-0-52" id="h93-0-52" class="i">+
</a><a href="#h93-0-53" id="h93-0-53" class="i">+
</a><a href="#h93-0-54" id="h93-0-54" class="i">+    fun searchFieldContainsToString(
</a><a href="#h93-0-55" id="h93-0-55" class="i">+        clazz: Class&lt;*&gt;,
</a><a href="#h93-0-56" id="h93-0-56" class="i">+        instance: Any?,
</a><a href="#h93-0-57" id="h93-0-57" class="i">+        toString: String?
</a><a href="#h93-0-58" id="h93-0-58" class="i">+    ): Field? {
</a><a href="#h93-0-59" id="h93-0-59" class="i">+        return clazz.declaredFields.firstOrNull { f: Field -&gt;
</a><a href="#h93-0-60" id="h93-0-60" class="i">+            try {
</a><a href="#h93-0-61" id="h93-0-61" class="i">+                f.isAccessible = true
</a><a href="#h93-0-62" id="h93-0-62" class="i">+                return@firstOrNull Objects.requireNonNull(f[instance]).toString()
</a><a href="#h93-0-63" id="h93-0-63" class="i">+                    .contains(toString!!)
</a><a href="#h93-0-64" id="h93-0-64" class="i">+            } catch (e: Throwable) {
</a><a href="#h93-0-65" id="h93-0-65" class="i">+                return@firstOrNull false
</a><a href="#h93-0-66" id="h93-0-66" class="i">+            }
</a><a href="#h93-0-67" id="h93-0-67" class="i">+        }
</a><a href="#h93-0-68" id="h93-0-68" class="i">+    }
</a><a href="#h93-0-69" id="h93-0-69" class="i">+
</a><a href="#h93-0-70" id="h93-0-70" class="i">+    fun searchFirstFieldTypeInClassRecursive(clazz: Class&lt;*&gt;, type: Class&lt;*&gt;): Field? {
</a><a href="#h93-0-71" id="h93-0-71" class="i">+        return clazz.declaredFields.firstOrNull {
</a><a href="#h93-0-72" id="h93-0-72" class="i">+            val field = searchFieldByType(it.type, type)
</a><a href="#h93-0-73" id="h93-0-73" class="i">+            return@firstOrNull field != null
</a><a href="#h93-0-74" id="h93-0-74" class="i">+        }
</a><a href="#h93-0-75" id="h93-0-75" class="i">+    }
</a><a href="#h93-0-76" id="h93-0-76" class="i">+
</a><a href="#h93-0-77" id="h93-0-77" class="i">+    /**
</a><a href="#h93-0-78" id="h93-0-78" class="i">+     * Searches for a field with a class that has a method with the specified return type
</a><a href="#h93-0-79" id="h93-0-79" class="i">+     */
</a><a href="#h93-0-80" id="h93-0-80" class="i">+    fun searchMethodWithReturnType(clazz: Class&lt;*&gt;, returnType: Class&lt;*&gt;): Method? {
</a><a href="#h93-0-81" id="h93-0-81" class="i">+        return clazz.declaredMethods.first { m: Method -&gt; m.returnType == returnType }
</a><a href="#h93-0-82" id="h93-0-82" class="i">+    }
</a><a href="#h93-0-83" id="h93-0-83" class="i">+
</a><a href="#h93-0-84" id="h93-0-84" class="i">+    /**
</a><a href="#h93-0-85" id="h93-0-85" class="i">+     * Searches for a field with a class that has a method with the specified return type and parameter types
</a><a href="#h93-0-86" id="h93-0-86" class="i">+     */
</a><a href="#h93-0-87" id="h93-0-87" class="i">+    fun searchMethodWithParameterAndReturnType(
</a><a href="#h93-0-88" id="h93-0-88" class="i">+        aClass: Class&lt;*&gt;,
</a><a href="#h93-0-89" id="h93-0-89" class="i">+        returnType: Class&lt;*&gt;,
</a><a href="#h93-0-90" id="h93-0-90" class="i">+        vararg parameters: Class&lt;*&gt;
</a><a href="#h93-0-91" id="h93-0-91" class="i">+    ): Method? {
</a><a href="#h93-0-92" id="h93-0-92" class="i">+        return aClass.declaredMethods.firstOrNull { m: Method -&gt;
</a><a href="#h93-0-93" id="h93-0-93" class="i">+            if (m.returnType != returnType) {
</a><a href="#h93-0-94" id="h93-0-94" class="i">+                return@firstOrNull false
</a><a href="#h93-0-95" id="h93-0-95" class="i">+            }
</a><a href="#h93-0-96" id="h93-0-96" class="i">+            val parameterTypes = m.parameterTypes
</a><a href="#h93-0-97" id="h93-0-97" class="i">+            if (parameterTypes.size != parameters.size) {
</a><a href="#h93-0-98" id="h93-0-98" class="i">+                return@firstOrNull false
</a><a href="#h93-0-99" id="h93-0-99" class="i">+            }
</a><a href="#h93-0-100" id="h93-0-100" class="i">+            for (i in parameterTypes.indices) {
</a><a href="#h93-0-101" id="h93-0-101" class="i">+                if (parameterTypes[i] != parameters[i]) {
</a><a href="#h93-0-102" id="h93-0-102" class="i">+                    return@firstOrNull false
</a><a href="#h93-0-103" id="h93-0-103" class="i">+                }
</a><a href="#h93-0-104" id="h93-0-104" class="i">+            }
</a><a href="#h93-0-105" id="h93-0-105" class="i">+            true
</a><a href="#h93-0-106" id="h93-0-106" class="i">+        }
</a><a href="#h93-0-107" id="h93-0-107" class="i">+    }
</a><a href="#h93-0-108" id="h93-0-108" class="i">+
</a><a href="#h93-0-109" id="h93-0-109" class="i">+    fun getDeclaredFieldsRecursively(clazz: Class&lt;*&gt;): List&lt;Field&gt; {
</a><a href="#h93-0-110" id="h93-0-110" class="i">+        val fields = clazz.declaredFields.toMutableList()
</a><a href="#h93-0-111" id="h93-0-111" class="i">+        val superclass = clazz.superclass
</a><a href="#h93-0-112" id="h93-0-112" class="i">+        if (superclass != null) {
</a><a href="#h93-0-113" id="h93-0-113" class="i">+            fields.addAll(getDeclaredFieldsRecursively(superclass))
</a><a href="#h93-0-114" id="h93-0-114" class="i">+        }
</a><a href="#h93-0-115" id="h93-0-115" class="i">+        return fields
</a><a href="#h93-0-116" id="h93-0-116" class="i">+    }
</a><a href="#h93-0-117" id="h93-0-117" class="i">+}</a><a href="#h93-0-118" id="h93-0-118" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h94" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/util/XposedHelperMacros.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/util/XposedHelperMacros.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/util/XposedHelperMacros.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/util/XposedHelperMacros.kt</a></b>
<a href="#h94-0" id="h94-0" class="h">@@ -0,0 +1,20 @@
</a><a href="#h94-0-0" id="h94-0-0" class="i">+package me.rhunk.snapenhance.util
</a><a href="#h94-0-1" id="h94-0-1" class="i">+
</a><a href="#h94-0-2" id="h94-0-2" class="i">+import de.robv.android.xposed.XposedHelpers
</a><a href="#h94-0-3" id="h94-0-3" class="i">+
</a><a href="#h94-0-4" id="h94-0-4" class="i">+fun Any.getObjectField(fieldName: String): Any {
</a><a href="#h94-0-5" id="h94-0-5" class="i">+    return XposedHelpers.getObjectField(this, fieldName)
</a><a href="#h94-0-6" id="h94-0-6" class="i">+}
</a><a href="#h94-0-7" id="h94-0-7" class="i">+
</a><a href="#h94-0-8" id="h94-0-8" class="i">+fun Any.setObjectField(fieldName: String, value: Any) {
</a><a href="#h94-0-9" id="h94-0-9" class="i">+    XposedHelpers.setObjectField(this, fieldName, value)
</a><a href="#h94-0-10" id="h94-0-10" class="i">+}
</a><a href="#h94-0-11" id="h94-0-11" class="i">+
</a><a href="#h94-0-12" id="h94-0-12" class="i">+fun Any.getObjectFieldOrNull(fieldName: String): Any? {
</a><a href="#h94-0-13" id="h94-0-13" class="i">+    return try {
</a><a href="#h94-0-14" id="h94-0-14" class="i">+        getObjectField(fieldName)
</a><a href="#h94-0-15" id="h94-0-15" class="i">+    } catch (e: Exception) {
</a><a href="#h94-0-16" id="h94-0-16" class="i">+        null
</a><a href="#h94-0-17" id="h94-0-17" class="i">+    }
</a><a href="#h94-0-18" id="h94-0-18" class="i">+}
</a><a href="#h94-0-19" id="h94-0-19" class="i">+
</a><b>diff --git a/<a id="h95" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/util/download/CdnDownloader.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/util/download/CdnDownloader.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/util/download/CdnDownloader.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/util/download/CdnDownloader.kt</a></b>
<a href="#h95-0" id="h95-0" class="h">@@ -0,0 +1,83 @@
</a><a href="#h95-0-0" id="h95-0-0" class="i">+package me.rhunk.snapenhance.util.download
</a><a href="#h95-0-1" id="h95-0-1" class="i">+
</a><a href="#h95-0-2" id="h95-0-2" class="i">+import kotlinx.coroutines.Job
</a><a href="#h95-0-3" id="h95-0-3" class="i">+import kotlinx.coroutines.launch
</a><a href="#h95-0-4" id="h95-0-4" class="i">+import kotlinx.coroutines.runBlocking
</a><a href="#h95-0-5" id="h95-0-5" class="i">+import me.rhunk.snapenhance.Constants
</a><a href="#h95-0-6" id="h95-0-6" class="i">+import java.io.InputStream
</a><a href="#h95-0-7" id="h95-0-7" class="i">+import java.net.URL
</a><a href="#h95-0-8" id="h95-0-8" class="i">+import javax.net.ssl.HttpsURLConnection
</a><a href="#h95-0-9" id="h95-0-9" class="i">+
</a><a href="#h95-0-10" id="h95-0-10" class="i">+object CdnDownloader {
</a><a href="#h95-0-11" id="h95-0-11" class="i">+    const val BOLT_CDN_U = &quot;https://bolt-gcdn.sc-cdn.net/u/&quot;
</a><a href="#h95-0-12" id="h95-0-12" class="i">+    const val BOLT_CDN_X = &quot;https://bolt-gcdn.sc-cdn.net/x/&quot;
</a><a href="#h95-0-13" id="h95-0-13" class="i">+    const val CF_ST_CDN_D = &quot;https://cf-st.sc-cdn.net/d/&quot;
</a><a href="#h95-0-14" id="h95-0-14" class="i">+    const val CF_ST_CDN_F = &quot;https://cf-st.sc-cdn.net/f/&quot;
</a><a href="#h95-0-15" id="h95-0-15" class="i">+    const val CF_ST_CDN_H = &quot;https://cf-st.sc-cdn.net/h/&quot;
</a><a href="#h95-0-16" id="h95-0-16" class="i">+    const val CF_ST_CDN_G = &quot;https://cf-st.sc-cdn.net/g/&quot;
</a><a href="#h95-0-17" id="h95-0-17" class="i">+    const val CF_ST_CDN_O = &quot;https://cf-st.sc-cdn.net/o/&quot;
</a><a href="#h95-0-18" id="h95-0-18" class="i">+    const val CF_ST_CDN_I = &quot;https://cf-st.sc-cdn.net/i/&quot;
</a><a href="#h95-0-19" id="h95-0-19" class="i">+    const val CF_ST_CDN_J = &quot;https://cf-st.sc-cdn.net/j/&quot;
</a><a href="#h95-0-20" id="h95-0-20" class="i">+    const val CF_ST_CDN_C = &quot;https://cf-st.sc-cdn.net/c/&quot;
</a><a href="#h95-0-21" id="h95-0-21" class="i">+    const val CF_ST_CDN_AA = &quot;https://cf-st.sc-cdn.net/aa/&quot;
</a><a href="#h95-0-22" id="h95-0-22" class="i">+
</a><a href="#h95-0-23" id="h95-0-23" class="i">+    private val keyCache: MutableMap&lt;String, String&gt; = mutableMapOf()
</a><a href="#h95-0-24" id="h95-0-24" class="i">+
</a><a href="#h95-0-25" id="h95-0-25" class="i">+    fun downloadRemoteContent(
</a><a href="#h95-0-26" id="h95-0-26" class="i">+        key: String,
</a><a href="#h95-0-27" id="h95-0-27" class="i">+        vararg endpoints: String
</a><a href="#h95-0-28" id="h95-0-28" class="i">+    ): InputStream? = runBlocking {
</a><a href="#h95-0-29" id="h95-0-29" class="i">+        if (keyCache.containsKey(key)) {
</a><a href="#h95-0-30" id="h95-0-30" class="i">+            return@runBlocking queryRemoteContent(
</a><a href="#h95-0-31" id="h95-0-31" class="i">+                keyCache[key]!!
</a><a href="#h95-0-32" id="h95-0-32" class="i">+            )
</a><a href="#h95-0-33" id="h95-0-33" class="i">+        }
</a><a href="#h95-0-34" id="h95-0-34" class="i">+        val jobs = mutableListOf&lt;Job&gt;()
</a><a href="#h95-0-35" id="h95-0-35" class="i">+        var inputStream: InputStream? = null
</a><a href="#h95-0-36" id="h95-0-36" class="i">+
</a><a href="#h95-0-37" id="h95-0-37" class="i">+        endpoints.forEach {
</a><a href="#h95-0-38" id="h95-0-38" class="i">+            launch {
</a><a href="#h95-0-39" id="h95-0-39" class="i">+                val url = it + key
</a><a href="#h95-0-40" id="h95-0-40" class="i">+                val result = queryRemoteContent(url)
</a><a href="#h95-0-41" id="h95-0-41" class="i">+                if (result != null) {
</a><a href="#h95-0-42" id="h95-0-42" class="i">+                    keyCache[key] = url
</a><a href="#h95-0-43" id="h95-0-43" class="i">+                    inputStream = result
</a><a href="#h95-0-44" id="h95-0-44" class="i">+                    jobs.forEach { it.cancel() }
</a><a href="#h95-0-45" id="h95-0-45" class="i">+                }
</a><a href="#h95-0-46" id="h95-0-46" class="i">+            }.also { jobs.add(it) }
</a><a href="#h95-0-47" id="h95-0-47" class="i">+        }
</a><a href="#h95-0-48" id="h95-0-48" class="i">+        jobs.forEach { it.join() }
</a><a href="#h95-0-49" id="h95-0-49" class="i">+        inputStream
</a><a href="#h95-0-50" id="h95-0-50" class="i">+    }
</a><a href="#h95-0-51" id="h95-0-51" class="i">+
</a><a href="#h95-0-52" id="h95-0-52" class="i">+
</a><a href="#h95-0-53" id="h95-0-53" class="i">+    private fun queryRemoteContent(url: String): InputStream? {
</a><a href="#h95-0-54" id="h95-0-54" class="i">+        try {
</a><a href="#h95-0-55" id="h95-0-55" class="i">+            val connection = URL(url).openConnection() as HttpsURLConnection
</a><a href="#h95-0-56" id="h95-0-56" class="i">+            connection.requestMethod = &quot;GET&quot;
</a><a href="#h95-0-57" id="h95-0-57" class="i">+            connection.connectTimeout = 5000
</a><a href="#h95-0-58" id="h95-0-58" class="i">+            connection.setRequestProperty(&quot;User-Agent&quot;, Constants.USER_AGENT)
</a><a href="#h95-0-59" id="h95-0-59" class="i">+            return connection.inputStream
</a><a href="#h95-0-60" id="h95-0-60" class="i">+        } catch (ignored: Throwable) {
</a><a href="#h95-0-61" id="h95-0-61" class="i">+        }
</a><a href="#h95-0-62" id="h95-0-62" class="i">+        return null
</a><a href="#h95-0-63" id="h95-0-63" class="i">+    }
</a><a href="#h95-0-64" id="h95-0-64" class="i">+
</a><a href="#h95-0-65" id="h95-0-65" class="i">+    //TODO: automatically detect the correct endpoint
</a><a href="#h95-0-66" id="h95-0-66" class="i">+    fun downloadWithDefaultEndpoints(key: String): InputStream? {
</a><a href="#h95-0-67" id="h95-0-67" class="i">+        return downloadRemoteContent(
</a><a href="#h95-0-68" id="h95-0-68" class="i">+            key,
</a><a href="#h95-0-69" id="h95-0-69" class="i">+            CF_ST_CDN_F,
</a><a href="#h95-0-70" id="h95-0-70" class="i">+            CF_ST_CDN_H,
</a><a href="#h95-0-71" id="h95-0-71" class="i">+            BOLT_CDN_U,
</a><a href="#h95-0-72" id="h95-0-72" class="i">+            BOLT_CDN_X,
</a><a href="#h95-0-73" id="h95-0-73" class="i">+            CF_ST_CDN_O,
</a><a href="#h95-0-74" id="h95-0-74" class="i">+            CF_ST_CDN_I,
</a><a href="#h95-0-75" id="h95-0-75" class="i">+            CF_ST_CDN_C,
</a><a href="#h95-0-76" id="h95-0-76" class="i">+            CF_ST_CDN_J,
</a><a href="#h95-0-77" id="h95-0-77" class="i">+            CF_ST_CDN_AA,
</a><a href="#h95-0-78" id="h95-0-78" class="i">+            CF_ST_CDN_G,
</a><a href="#h95-0-79" id="h95-0-79" class="i">+            CF_ST_CDN_D
</a><a href="#h95-0-80" id="h95-0-80" class="i">+        )
</a><a href="#h95-0-81" id="h95-0-81" class="i">+    }
</a><a href="#h95-0-82" id="h95-0-82" class="i">+}
</a><b>diff --git a/<a id="h96" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/util/download/DownloadServer.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/util/download/DownloadServer.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/util/download/DownloadServer.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/util/download/DownloadServer.kt</a></b>
<a href="#h96-0" id="h96-0" class="h">@@ -0,0 +1,116 @@
</a><a href="#h96-0-0" id="h96-0-0" class="i">+package me.rhunk.snapenhance.util.download
</a><a href="#h96-0-1" id="h96-0-1" class="i">+
</a><a href="#h96-0-2" id="h96-0-2" class="i">+import de.robv.android.xposed.XposedBridge
</a><a href="#h96-0-3" id="h96-0-3" class="i">+import me.rhunk.snapenhance.Logger
</a><a href="#h96-0-4" id="h96-0-4" class="i">+import me.rhunk.snapenhance.Logger.debug
</a><a href="#h96-0-5" id="h96-0-5" class="i">+import me.rhunk.snapenhance.ModContext
</a><a href="#h96-0-6" id="h96-0-6" class="i">+import java.io.BufferedReader
</a><a href="#h96-0-7" id="h96-0-7" class="i">+import java.io.File
</a><a href="#h96-0-8" id="h96-0-8" class="i">+import java.io.InputStreamReader
</a><a href="#h96-0-9" id="h96-0-9" class="i">+import java.io.PrintWriter
</a><a href="#h96-0-10" id="h96-0-10" class="i">+import java.net.ServerSocket
</a><a href="#h96-0-11" id="h96-0-11" class="i">+import java.net.Socket
</a><a href="#h96-0-12" id="h96-0-12" class="i">+import java.util.*
</a><a href="#h96-0-13" id="h96-0-13" class="i">+import java.util.concurrent.ConcurrentHashMap
</a><a href="#h96-0-14" id="h96-0-14" class="i">+import java.util.concurrent.ThreadLocalRandom
</a><a href="#h96-0-15" id="h96-0-15" class="i">+import java.util.function.Consumer
</a><a href="#h96-0-16" id="h96-0-16" class="i">+
</a><a href="#h96-0-17" id="h96-0-17" class="i">+class DownloadServer(
</a><a href="#h96-0-18" id="h96-0-18" class="i">+    private val context: ModContext
</a><a href="#h96-0-19" id="h96-0-19" class="i">+) {
</a><a href="#h96-0-20" id="h96-0-20" class="i">+    private val port = ThreadLocalRandom.current().nextInt(10000, 65535)
</a><a href="#h96-0-21" id="h96-0-21" class="i">+
</a><a href="#h96-0-22" id="h96-0-22" class="i">+    private val cachedData = ConcurrentHashMap&lt;String, ByteArray&gt;()
</a><a href="#h96-0-23" id="h96-0-23" class="i">+    private var serverSocket: ServerSocket? = null
</a><a href="#h96-0-24" id="h96-0-24" class="i">+
</a><a href="#h96-0-25" id="h96-0-25" class="i">+    fun startFileDownload(destination: File, content: ByteArray, callback: Consumer&lt;Boolean&gt;) {
</a><a href="#h96-0-26" id="h96-0-26" class="i">+        val httpKey = java.lang.Long.toHexString(System.nanoTime())
</a><a href="#h96-0-27" id="h96-0-27" class="i">+        ensureServerStarted {
</a><a href="#h96-0-28" id="h96-0-28" class="i">+            putDownloadableContent(httpKey, content)
</a><a href="#h96-0-29" id="h96-0-29" class="i">+            val url = &quot;http://127.0.0.1:$port/$httpKey&quot;
</a><a href="#h96-0-30" id="h96-0-30" class="i">+            context.executeAsync {
</a><a href="#h96-0-31" id="h96-0-31" class="i">+                val result: Boolean = context.bridgeClient.downloadContent(url, destination.absolutePath)
</a><a href="#h96-0-32" id="h96-0-32" class="i">+                callback.accept(result)
</a><a href="#h96-0-33" id="h96-0-33" class="i">+            }
</a><a href="#h96-0-34" id="h96-0-34" class="i">+        }
</a><a href="#h96-0-35" id="h96-0-35" class="i">+    }
</a><a href="#h96-0-36" id="h96-0-36" class="i">+
</a><a href="#h96-0-37" id="h96-0-37" class="i">+    private fun ensureServerStarted(callback: Runnable) {
</a><a href="#h96-0-38" id="h96-0-38" class="i">+        if (serverSocket != null &amp;&amp; !serverSocket!!.isClosed) {
</a><a href="#h96-0-39" id="h96-0-39" class="i">+            callback.run()
</a><a href="#h96-0-40" id="h96-0-40" class="i">+            return
</a><a href="#h96-0-41" id="h96-0-41" class="i">+        }
</a><a href="#h96-0-42" id="h96-0-42" class="i">+        Thread {
</a><a href="#h96-0-43" id="h96-0-43" class="i">+            try {
</a><a href="#h96-0-44" id="h96-0-44" class="i">+                debug(&quot;started web server on 127.0.0.1:$port&quot;)
</a><a href="#h96-0-45" id="h96-0-45" class="i">+                serverSocket = ServerSocket(port)
</a><a href="#h96-0-46" id="h96-0-46" class="i">+                callback.run()
</a><a href="#h96-0-47" id="h96-0-47" class="i">+                while (!serverSocket!!.isClosed) {
</a><a href="#h96-0-48" id="h96-0-48" class="i">+                    try {
</a><a href="#h96-0-49" id="h96-0-49" class="i">+                        val socket = serverSocket!!.accept()
</a><a href="#h96-0-50" id="h96-0-50" class="i">+                        Thread { handleRequest(socket) }.start()
</a><a href="#h96-0-51" id="h96-0-51" class="i">+                    } catch (e: Throwable) {
</a><a href="#h96-0-52" id="h96-0-52" class="i">+                        Logger.xposedLog(e)
</a><a href="#h96-0-53" id="h96-0-53" class="i">+                    }
</a><a href="#h96-0-54" id="h96-0-54" class="i">+                }
</a><a href="#h96-0-55" id="h96-0-55" class="i">+            } catch (e: Throwable) {
</a><a href="#h96-0-56" id="h96-0-56" class="i">+                Logger.xposedLog(e)
</a><a href="#h96-0-57" id="h96-0-57" class="i">+            }
</a><a href="#h96-0-58" id="h96-0-58" class="i">+        }.start()
</a><a href="#h96-0-59" id="h96-0-59" class="i">+    }
</a><a href="#h96-0-60" id="h96-0-60" class="i">+
</a><a href="#h96-0-61" id="h96-0-61" class="i">+    fun putDownloadableContent(key: String, data: ByteArray) {
</a><a href="#h96-0-62" id="h96-0-62" class="i">+        cachedData[key] = data
</a><a href="#h96-0-63" id="h96-0-63" class="i">+    }
</a><a href="#h96-0-64" id="h96-0-64" class="i">+
</a><a href="#h96-0-65" id="h96-0-65" class="i">+    private fun handleRequest(socket: Socket) {
</a><a href="#h96-0-66" id="h96-0-66" class="i">+        val reader = BufferedReader(InputStreamReader(socket.getInputStream()))
</a><a href="#h96-0-67" id="h96-0-67" class="i">+        val outputStream = socket.getOutputStream()
</a><a href="#h96-0-68" id="h96-0-68" class="i">+        val writer = PrintWriter(outputStream)
</a><a href="#h96-0-69" id="h96-0-69" class="i">+        val line = reader.readLine() ?: return
</a><a href="#h96-0-70" id="h96-0-70" class="i">+        val close = Runnable {
</a><a href="#h96-0-71" id="h96-0-71" class="i">+            try {
</a><a href="#h96-0-72" id="h96-0-72" class="i">+                reader.close()
</a><a href="#h96-0-73" id="h96-0-73" class="i">+                writer.close()
</a><a href="#h96-0-74" id="h96-0-74" class="i">+                outputStream.close()
</a><a href="#h96-0-75" id="h96-0-75" class="i">+                socket.close()
</a><a href="#h96-0-76" id="h96-0-76" class="i">+            } catch (e: Throwable) {
</a><a href="#h96-0-77" id="h96-0-77" class="i">+                Logger.xposedLog(e)
</a><a href="#h96-0-78" id="h96-0-78" class="i">+            }
</a><a href="#h96-0-79" id="h96-0-79" class="i">+        }
</a><a href="#h96-0-80" id="h96-0-80" class="i">+        val parse = StringTokenizer(line)
</a><a href="#h96-0-81" id="h96-0-81" class="i">+        val method = parse.nextToken().uppercase(Locale.getDefault())
</a><a href="#h96-0-82" id="h96-0-82" class="i">+        var fileRequested = parse.nextToken().lowercase(Locale.getDefault())
</a><a href="#h96-0-83" id="h96-0-83" class="i">+        if (method != &quot;GET&quot;) {
</a><a href="#h96-0-84" id="h96-0-84" class="i">+            writer.println(&quot;HTTP/1.1 501 Not Implemented&quot;)
</a><a href="#h96-0-85" id="h96-0-85" class="i">+            writer.println(&quot;Content-type: &quot; + &quot;application/octet-stream&quot;)
</a><a href="#h96-0-86" id="h96-0-86" class="i">+            writer.println(&quot;Content-length: &quot; + 0)
</a><a href="#h96-0-87" id="h96-0-87" class="i">+            writer.println()
</a><a href="#h96-0-88" id="h96-0-88" class="i">+            writer.flush()
</a><a href="#h96-0-89" id="h96-0-89" class="i">+            close.run()
</a><a href="#h96-0-90" id="h96-0-90" class="i">+            return
</a><a href="#h96-0-91" id="h96-0-91" class="i">+        }
</a><a href="#h96-0-92" id="h96-0-92" class="i">+        if (fileRequested.startsWith(&quot;/&quot;)) {
</a><a href="#h96-0-93" id="h96-0-93" class="i">+            fileRequested = fileRequested.substring(1)
</a><a href="#h96-0-94" id="h96-0-94" class="i">+        }
</a><a href="#h96-0-95" id="h96-0-95" class="i">+        if (!cachedData.containsKey(fileRequested)) {
</a><a href="#h96-0-96" id="h96-0-96" class="i">+            writer.println(&quot;HTTP/1.1 404 Not Found&quot;)
</a><a href="#h96-0-97" id="h96-0-97" class="i">+            writer.println(&quot;Content-type: &quot; + &quot;application/octet-stream&quot;)
</a><a href="#h96-0-98" id="h96-0-98" class="i">+            writer.println(&quot;Content-length: &quot; + 0)
</a><a href="#h96-0-99" id="h96-0-99" class="i">+            writer.println()
</a><a href="#h96-0-100" id="h96-0-100" class="i">+            writer.flush()
</a><a href="#h96-0-101" id="h96-0-101" class="i">+            close.run()
</a><a href="#h96-0-102" id="h96-0-102" class="i">+            return
</a><a href="#h96-0-103" id="h96-0-103" class="i">+        }
</a><a href="#h96-0-104" id="h96-0-104" class="i">+        val data = cachedData[fileRequested]!!
</a><a href="#h96-0-105" id="h96-0-105" class="i">+        writer.println(&quot;HTTP/1.1 200 OK&quot;)
</a><a href="#h96-0-106" id="h96-0-106" class="i">+        writer.println(&quot;Content-type: &quot; + &quot;application/octet-stream&quot;)
</a><a href="#h96-0-107" id="h96-0-107" class="i">+        writer.println(&quot;Content-length: &quot; + data.size)
</a><a href="#h96-0-108" id="h96-0-108" class="i">+        writer.println()
</a><a href="#h96-0-109" id="h96-0-109" class="i">+        writer.flush()
</a><a href="#h96-0-110" id="h96-0-110" class="i">+        outputStream.write(data, 0, data.size)
</a><a href="#h96-0-111" id="h96-0-111" class="i">+        outputStream.flush()
</a><a href="#h96-0-112" id="h96-0-112" class="i">+        close.run()
</a><a href="#h96-0-113" id="h96-0-113" class="i">+        cachedData.remove(fileRequested)
</a><a href="#h96-0-114" id="h96-0-114" class="i">+    }
</a><a href="#h96-0-115" id="h96-0-115" class="i">+}</a><a href="#h96-0-116" id="h96-0-116" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h97" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/util/protobuf/ProtoReader.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/util/protobuf/ProtoReader.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/util/protobuf/ProtoReader.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/util/protobuf/ProtoReader.kt</a></b>
<a href="#h97-0" id="h97-0" class="h">@@ -0,0 +1,122 @@
</a><a href="#h97-0-0" id="h97-0-0" class="i">+package me.rhunk.snapenhance.util.protobuf
</a><a href="#h97-0-1" id="h97-0-1" class="i">+
</a><a href="#h97-0-2" id="h97-0-2" class="i">+data class Wire(val type: Int, val value: Any)
</a><a href="#h97-0-3" id="h97-0-3" class="i">+
</a><a href="#h97-0-4" id="h97-0-4" class="i">+class ProtoReader(private val buffer: ByteArray) {
</a><a href="#h97-0-5" id="h97-0-5" class="i">+    private var offset: Int = 0
</a><a href="#h97-0-6" id="h97-0-6" class="i">+    private val values = mutableMapOf&lt;Int, MutableList&lt;Wire&gt;&gt;()
</a><a href="#h97-0-7" id="h97-0-7" class="i">+
</a><a href="#h97-0-8" id="h97-0-8" class="i">+    init {
</a><a href="#h97-0-9" id="h97-0-9" class="i">+        read()
</a><a href="#h97-0-10" id="h97-0-10" class="i">+    }
</a><a href="#h97-0-11" id="h97-0-11" class="i">+
</a><a href="#h97-0-12" id="h97-0-12" class="i">+    fun getBuffer() = buffer
</a><a href="#h97-0-13" id="h97-0-13" class="i">+
</a><a href="#h97-0-14" id="h97-0-14" class="i">+    private fun readByte() = buffer[offset++]
</a><a href="#h97-0-15" id="h97-0-15" class="i">+
</a><a href="#h97-0-16" id="h97-0-16" class="i">+    private fun readVarInt(): Long {
</a><a href="#h97-0-17" id="h97-0-17" class="i">+        var result = 0L
</a><a href="#h97-0-18" id="h97-0-18" class="i">+        var shift = 0
</a><a href="#h97-0-19" id="h97-0-19" class="i">+        while (true) {
</a><a href="#h97-0-20" id="h97-0-20" class="i">+            val b = readByte()
</a><a href="#h97-0-21" id="h97-0-21" class="i">+            result = result or ((b.toLong() and 0x7F) shl shift)
</a><a href="#h97-0-22" id="h97-0-22" class="i">+            if (b.toInt() and 0x80 == 0) {
</a><a href="#h97-0-23" id="h97-0-23" class="i">+                break
</a><a href="#h97-0-24" id="h97-0-24" class="i">+            }
</a><a href="#h97-0-25" id="h97-0-25" class="i">+            shift += 7
</a><a href="#h97-0-26" id="h97-0-26" class="i">+        }
</a><a href="#h97-0-27" id="h97-0-27" class="i">+        return result
</a><a href="#h97-0-28" id="h97-0-28" class="i">+    }
</a><a href="#h97-0-29" id="h97-0-29" class="i">+
</a><a href="#h97-0-30" id="h97-0-30" class="i">+    private fun read() {
</a><a href="#h97-0-31" id="h97-0-31" class="i">+        while (offset &lt; buffer.size) {
</a><a href="#h97-0-32" id="h97-0-32" class="i">+            val tag = readVarInt().toInt()
</a><a href="#h97-0-33" id="h97-0-33" class="i">+            val id = tag ushr 3
</a><a href="#h97-0-34" id="h97-0-34" class="i">+            val type = tag and 0x7
</a><a href="#h97-0-35" id="h97-0-35" class="i">+            try {
</a><a href="#h97-0-36" id="h97-0-36" class="i">+                val value = when (type) {
</a><a href="#h97-0-37" id="h97-0-37" class="i">+                    0 -&gt; readVarInt().toString().toByteArray()
</a><a href="#h97-0-38" id="h97-0-38" class="i">+                    2 -&gt; {
</a><a href="#h97-0-39" id="h97-0-39" class="i">+                        val length = readVarInt().toInt()
</a><a href="#h97-0-40" id="h97-0-40" class="i">+                        val value = buffer.copyOfRange(offset, offset + length)
</a><a href="#h97-0-41" id="h97-0-41" class="i">+                        offset += length
</a><a href="#h97-0-42" id="h97-0-42" class="i">+                        value
</a><a href="#h97-0-43" id="h97-0-43" class="i">+                    }
</a><a href="#h97-0-44" id="h97-0-44" class="i">+                    else -&gt; break
</a><a href="#h97-0-45" id="h97-0-45" class="i">+                }
</a><a href="#h97-0-46" id="h97-0-46" class="i">+                values.getOrPut(id) { mutableListOf() }.add(Wire(type, value))
</a><a href="#h97-0-47" id="h97-0-47" class="i">+            } catch (t: Throwable) {
</a><a href="#h97-0-48" id="h97-0-48" class="i">+                values.clear()
</a><a href="#h97-0-49" id="h97-0-49" class="i">+                break
</a><a href="#h97-0-50" id="h97-0-50" class="i">+            }
</a><a href="#h97-0-51" id="h97-0-51" class="i">+        }
</a><a href="#h97-0-52" id="h97-0-52" class="i">+    }
</a><a href="#h97-0-53" id="h97-0-53" class="i">+
</a><a href="#h97-0-54" id="h97-0-54" class="i">+    fun readPath(vararg ids: Int, reader: (ProtoReader.() -&gt; Unit)? = null): ProtoReader? {
</a><a href="#h97-0-55" id="h97-0-55" class="i">+        var thisReader = this
</a><a href="#h97-0-56" id="h97-0-56" class="i">+        ids.forEach { id -&gt;
</a><a href="#h97-0-57" id="h97-0-57" class="i">+            if (!thisReader.exists(id)) {
</a><a href="#h97-0-58" id="h97-0-58" class="i">+                return null
</a><a href="#h97-0-59" id="h97-0-59" class="i">+            }
</a><a href="#h97-0-60" id="h97-0-60" class="i">+            thisReader = ProtoReader(thisReader.get(id) as ByteArray)
</a><a href="#h97-0-61" id="h97-0-61" class="i">+        }
</a><a href="#h97-0-62" id="h97-0-62" class="i">+        if (reader != null) {
</a><a href="#h97-0-63" id="h97-0-63" class="i">+            thisReader.reader()
</a><a href="#h97-0-64" id="h97-0-64" class="i">+        }
</a><a href="#h97-0-65" id="h97-0-65" class="i">+        return thisReader
</a><a href="#h97-0-66" id="h97-0-66" class="i">+    }
</a><a href="#h97-0-67" id="h97-0-67" class="i">+
</a><a href="#h97-0-68" id="h97-0-68" class="i">+    fun pathExists(vararg ids: Int): Boolean {
</a><a href="#h97-0-69" id="h97-0-69" class="i">+        var thisReader = this
</a><a href="#h97-0-70" id="h97-0-70" class="i">+        ids.forEach { id -&gt;
</a><a href="#h97-0-71" id="h97-0-71" class="i">+            if (!thisReader.exists(id)) {
</a><a href="#h97-0-72" id="h97-0-72" class="i">+                return false
</a><a href="#h97-0-73" id="h97-0-73" class="i">+            }
</a><a href="#h97-0-74" id="h97-0-74" class="i">+            thisReader = ProtoReader(thisReader.get(id) as ByteArray)
</a><a href="#h97-0-75" id="h97-0-75" class="i">+        }
</a><a href="#h97-0-76" id="h97-0-76" class="i">+        return true
</a><a href="#h97-0-77" id="h97-0-77" class="i">+    }
</a><a href="#h97-0-78" id="h97-0-78" class="i">+
</a><a href="#h97-0-79" id="h97-0-79" class="i">+    fun getByteArray(id: Int) = values[id]?.first()?.value as ByteArray?
</a><a href="#h97-0-80" id="h97-0-80" class="i">+    fun getByteArray(vararg ids: Int): ByteArray? {
</a><a href="#h97-0-81" id="h97-0-81" class="i">+        if (ids.isEmpty() || ids.size &lt; 2) {
</a><a href="#h97-0-82" id="h97-0-82" class="i">+            return null
</a><a href="#h97-0-83" id="h97-0-83" class="i">+        }
</a><a href="#h97-0-84" id="h97-0-84" class="i">+        val lastId = ids.last()
</a><a href="#h97-0-85" id="h97-0-85" class="i">+        var value: ByteArray? = null
</a><a href="#h97-0-86" id="h97-0-86" class="i">+        readPath(*(ids.copyOfRange(0, ids.size - 1))) {
</a><a href="#h97-0-87" id="h97-0-87" class="i">+            value = getByteArray(lastId)
</a><a href="#h97-0-88" id="h97-0-88" class="i">+        }
</a><a href="#h97-0-89" id="h97-0-89" class="i">+        return value
</a><a href="#h97-0-90" id="h97-0-90" class="i">+    }
</a><a href="#h97-0-91" id="h97-0-91" class="i">+
</a><a href="#h97-0-92" id="h97-0-92" class="i">+    fun getString(id: Int) = getByteArray(id)?.toString(Charsets.UTF_8)
</a><a href="#h97-0-93" id="h97-0-93" class="i">+    fun getString(vararg ids: Int) = getByteArray(*ids)?.toString(Charsets.UTF_8)
</a><a href="#h97-0-94" id="h97-0-94" class="i">+
</a><a href="#h97-0-95" id="h97-0-95" class="i">+    fun getInt(id: Int) = getString(id)?.toInt()
</a><a href="#h97-0-96" id="h97-0-96" class="i">+    fun getInt(vararg ids: Int) = getString(*ids)?.toInt()
</a><a href="#h97-0-97" id="h97-0-97" class="i">+
</a><a href="#h97-0-98" id="h97-0-98" class="i">+    fun getLong(id: Int) = getString(id)?.toLong()
</a><a href="#h97-0-99" id="h97-0-99" class="i">+    fun getLong(vararg ids: Int) = getString(*ids)?.toLong()
</a><a href="#h97-0-100" id="h97-0-100" class="i">+
</a><a href="#h97-0-101" id="h97-0-101" class="i">+    fun exists(id: Int) = values.containsKey(id)
</a><a href="#h97-0-102" id="h97-0-102" class="i">+
</a><a href="#h97-0-103" id="h97-0-103" class="i">+    fun get(id: Int) = values[id]!!.first().value
</a><a href="#h97-0-104" id="h97-0-104" class="i">+
</a><a href="#h97-0-105" id="h97-0-105" class="i">+    fun isValid() = values.isNotEmpty()
</a><a href="#h97-0-106" id="h97-0-106" class="i">+
</a><a href="#h97-0-107" id="h97-0-107" class="i">+    fun getCount(id: Int) = values[id]!!.size
</a><a href="#h97-0-108" id="h97-0-108" class="i">+
</a><a href="#h97-0-109" id="h97-0-109" class="i">+    fun each(id: Int, reader: ProtoReader.(index: Int) -&gt; Unit) {
</a><a href="#h97-0-110" id="h97-0-110" class="i">+        values[id]!!.forEachIndexed { index, _ -&gt;
</a><a href="#h97-0-111" id="h97-0-111" class="i">+            ProtoReader(values[id]!![index].value as ByteArray).reader(index)
</a><a href="#h97-0-112" id="h97-0-112" class="i">+        }
</a><a href="#h97-0-113" id="h97-0-113" class="i">+    }
</a><a href="#h97-0-114" id="h97-0-114" class="i">+
</a><a href="#h97-0-115" id="h97-0-115" class="i">+    fun eachExists(id: Int, reader: ProtoReader.(index: Int) -&gt; Unit) {
</a><a href="#h97-0-116" id="h97-0-116" class="i">+        if (!exists(id)) {
</a><a href="#h97-0-117" id="h97-0-117" class="i">+            return
</a><a href="#h97-0-118" id="h97-0-118" class="i">+        }
</a><a href="#h97-0-119" id="h97-0-119" class="i">+        each(id, reader)
</a><a href="#h97-0-120" id="h97-0-120" class="i">+    }
</a><a href="#h97-0-121" id="h97-0-121" class="i">+}</a><a href="#h97-0-122" id="h97-0-122" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h98" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/util/protobuf/ProtoWriter.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/util/protobuf/ProtoWriter.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/util/protobuf/ProtoWriter.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/util/protobuf/ProtoWriter.kt</a></b>
<a href="#h98-0" id="h98-0" class="h">@@ -0,0 +1,66 @@
</a><a href="#h98-0-0" id="h98-0-0" class="i">+package me.rhunk.snapenhance.util.protobuf
</a><a href="#h98-0-1" id="h98-0-1" class="i">+
</a><a href="#h98-0-2" id="h98-0-2" class="i">+import java.io.ByteArrayOutputStream
</a><a href="#h98-0-3" id="h98-0-3" class="i">+
</a><a href="#h98-0-4" id="h98-0-4" class="i">+class ProtoWriter {
</a><a href="#h98-0-5" id="h98-0-5" class="i">+    private val stream: ByteArrayOutputStream = ByteArrayOutputStream()
</a><a href="#h98-0-6" id="h98-0-6" class="i">+
</a><a href="#h98-0-7" id="h98-0-7" class="i">+    private fun writeVarInt(value: Int) {
</a><a href="#h98-0-8" id="h98-0-8" class="i">+        var v = value
</a><a href="#h98-0-9" id="h98-0-9" class="i">+        while (v and -0x80 != 0) {
</a><a href="#h98-0-10" id="h98-0-10" class="i">+            stream.write(v and 0x7F or 0x80)
</a><a href="#h98-0-11" id="h98-0-11" class="i">+            v = v ushr 7
</a><a href="#h98-0-12" id="h98-0-12" class="i">+        }
</a><a href="#h98-0-13" id="h98-0-13" class="i">+        stream.write(v)
</a><a href="#h98-0-14" id="h98-0-14" class="i">+    }
</a><a href="#h98-0-15" id="h98-0-15" class="i">+
</a><a href="#h98-0-16" id="h98-0-16" class="i">+    private fun writeVarLong(value: Long) {
</a><a href="#h98-0-17" id="h98-0-17" class="i">+        var v = value
</a><a href="#h98-0-18" id="h98-0-18" class="i">+        while (v and -0x80L != 0L) {
</a><a href="#h98-0-19" id="h98-0-19" class="i">+            stream.write((v and 0x7FL or 0x80L).toInt())
</a><a href="#h98-0-20" id="h98-0-20" class="i">+            v = v ushr 7
</a><a href="#h98-0-21" id="h98-0-21" class="i">+        }
</a><a href="#h98-0-22" id="h98-0-22" class="i">+        stream.write(v.toInt())
</a><a href="#h98-0-23" id="h98-0-23" class="i">+    }
</a><a href="#h98-0-24" id="h98-0-24" class="i">+
</a><a href="#h98-0-25" id="h98-0-25" class="i">+    fun writeBuffer(id: Int, value: ByteArray) {
</a><a href="#h98-0-26" id="h98-0-26" class="i">+        writeVarInt(id shl 3 or 2)
</a><a href="#h98-0-27" id="h98-0-27" class="i">+        writeVarInt(value.size)
</a><a href="#h98-0-28" id="h98-0-28" class="i">+        stream.write(value)
</a><a href="#h98-0-29" id="h98-0-29" class="i">+    }
</a><a href="#h98-0-30" id="h98-0-30" class="i">+
</a><a href="#h98-0-31" id="h98-0-31" class="i">+    fun writeConstant(id: Int, value: Int) {
</a><a href="#h98-0-32" id="h98-0-32" class="i">+        writeVarInt(id shl 3)
</a><a href="#h98-0-33" id="h98-0-33" class="i">+        writeVarInt(value)
</a><a href="#h98-0-34" id="h98-0-34" class="i">+    }
</a><a href="#h98-0-35" id="h98-0-35" class="i">+
</a><a href="#h98-0-36" id="h98-0-36" class="i">+    fun writeConstant(id: Int, value: Long) {
</a><a href="#h98-0-37" id="h98-0-37" class="i">+        writeVarInt(id shl 3)
</a><a href="#h98-0-38" id="h98-0-38" class="i">+        writeVarLong(value)
</a><a href="#h98-0-39" id="h98-0-39" class="i">+    }
</a><a href="#h98-0-40" id="h98-0-40" class="i">+
</a><a href="#h98-0-41" id="h98-0-41" class="i">+    fun writeString(id: Int, value: String) = writeBuffer(id, value.toByteArray())
</a><a href="#h98-0-42" id="h98-0-42" class="i">+
</a><a href="#h98-0-43" id="h98-0-43" class="i">+    fun write(id: Int, writer: ProtoWriter.() -&gt; Unit) {
</a><a href="#h98-0-44" id="h98-0-44" class="i">+        val writerStream = ProtoWriter()
</a><a href="#h98-0-45" id="h98-0-45" class="i">+        writer(writerStream)
</a><a href="#h98-0-46" id="h98-0-46" class="i">+        writeBuffer(id, writerStream.stream.toByteArray())
</a><a href="#h98-0-47" id="h98-0-47" class="i">+    }
</a><a href="#h98-0-48" id="h98-0-48" class="i">+
</a><a href="#h98-0-49" id="h98-0-49" class="i">+    fun write(vararg ids: Int, writer: ProtoWriter.() -&gt; Unit) {
</a><a href="#h98-0-50" id="h98-0-50" class="i">+        val writerStream = ProtoWriter()
</a><a href="#h98-0-51" id="h98-0-51" class="i">+        writer(writerStream)
</a><a href="#h98-0-52" id="h98-0-52" class="i">+        var stream = writerStream.stream.toByteArray()
</a><a href="#h98-0-53" id="h98-0-53" class="i">+        ids.reversed().forEach { id -&gt;
</a><a href="#h98-0-54" id="h98-0-54" class="i">+            with(ProtoWriter()) {
</a><a href="#h98-0-55" id="h98-0-55" class="i">+                writeBuffer(id, stream)
</a><a href="#h98-0-56" id="h98-0-56" class="i">+                stream = this.stream.toByteArray()
</a><a href="#h98-0-57" id="h98-0-57" class="i">+            }
</a><a href="#h98-0-58" id="h98-0-58" class="i">+        }
</a><a href="#h98-0-59" id="h98-0-59" class="i">+        stream.let(this.stream::write)
</a><a href="#h98-0-60" id="h98-0-60" class="i">+    }
</a><a href="#h98-0-61" id="h98-0-61" class="i">+
</a><a href="#h98-0-62" id="h98-0-62" class="i">+    fun toByteArray(): ByteArray {
</a><a href="#h98-0-63" id="h98-0-63" class="i">+        return stream.toByteArray()
</a><a href="#h98-0-64" id="h98-0-64" class="i">+    }
</a><a href="#h98-0-65" id="h98-0-65" class="i">+}</a><a href="#h98-0-66" id="h98-0-66" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h99" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/util/snap/SnapUUID.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/util/snap/SnapUUID.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/util/snap/SnapUUID.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/util/snap/SnapUUID.kt</a></b>
<a href="#h99-0" id="h99-0" class="h">@@ -0,0 +1,2 @@
</a><a href="#h99-0-0" id="h99-0-0" class="i">+package me.rhunk.snapenhance.util.snap
</a><a href="#h99-0-1" id="h99-0-1" class="i">+
</a><b>diff --git a/<a id="h100" href="../file/app/src/main/res/values-fr/strings.xml.html">app/src/main/res/values-fr/strings.xml</a> b/<a href="../file/app/src/main/res/values-fr/strings.xml.html">app/src/main/res/values-fr/strings.xml</a></b>
<a href="#h100-0" id="h100-0" class="h">@@ -0,0 +1,4 @@
</a><a href="#h100-0-0" id="h100-0-0" class="i">+&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
</a><a href="#h100-0-1" id="h100-0-1" class="i">+&lt;resources&gt;
</a><a href="#h100-0-2" id="h100-0-2" class="i">+
</a><a href="#h100-0-3" id="h100-0-3" class="i">+&lt;/resources&gt;</a><a href="#h100-0-4" id="h100-0-4" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h101" href="../file/app/src/main/res/values/arrays.xml.html">app/src/main/res/values/arrays.xml</a> b/<a href="../file/app/src/main/res/values/arrays.xml.html">app/src/main/res/values/arrays.xml</a></b>
<a href="#h101-0" id="h101-0" class="h">@@ -0,0 +1,6 @@
</a><a href="#h101-0-0" id="h101-0-0" class="i">+&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
</a><a href="#h101-0-1" id="h101-0-1" class="i">+&lt;resources&gt;
</a><a href="#h101-0-2" id="h101-0-2" class="i">+    &lt;string-array name=&quot;sc_scope&quot;&gt;
</a><a href="#h101-0-3" id="h101-0-3" class="i">+        &lt;item&gt;com.snapchat.android&lt;/item&gt;
</a><a href="#h101-0-4" id="h101-0-4" class="i">+    &lt;/string-array&gt;
</a><a href="#h101-0-5" id="h101-0-5" class="i">+&lt;/resources&gt;</a><a href="#h101-0-6" id="h101-0-6" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h102" href="../file/app/src/main/res/values/strings.xml.html">app/src/main/res/values/strings.xml</a> b/<a href="../file/app/src/main/res/values/strings.xml.html">app/src/main/res/values/strings.xml</a></b>
<a href="#h102-0" id="h102-0" class="h">@@ -0,0 +1,33 @@
</a><a href="#h102-0-0" id="h102-0-0" class="i">+&lt;resources&gt;
</a><a href="#h102-0-1" id="h102-0-1" class="i">+    &lt;string name=&quot;app_name&quot; translatable=&quot;false&quot;&gt;Snap Enhance&lt;/string&gt;
</a><a href="#h102-0-2" id="h102-0-2" class="i">+    &lt;string name=&quot;property.save_folder&quot;&gt;Save folder&lt;/string&gt;
</a><a href="#h102-0-3" id="h102-0-3" class="i">+    &lt;string name=&quot;property.prevent_read_receipts&quot;&gt;Prevent read receipts&lt;/string&gt;
</a><a href="#h102-0-4" id="h102-0-4" class="i">+    &lt;string name=&quot;property.hide_bitmoji_presence&quot;&gt;Hide Bitmoji presence&lt;/string&gt;
</a><a href="#h102-0-5" id="h102-0-5" class="i">+    &lt;string name=&quot;property.show_message_content&quot;&gt;Show message content&lt;/string&gt;
</a><a href="#h102-0-6" id="h102-0-6" class="i">+    &lt;string name=&quot;property.message_logger&quot;&gt;Message logger&lt;/string&gt;
</a><a href="#h102-0-7" id="h102-0-7" class="i">+    &lt;string name=&quot;property.media_downloader_feature&quot;&gt;Media downloader feature&lt;/string&gt;
</a><a href="#h102-0-8" id="h102-0-8" class="i">+    &lt;string name=&quot;property.download_stories&quot;&gt;Download stories&lt;/string&gt;
</a><a href="#h102-0-9" id="h102-0-9" class="i">+    &lt;string name=&quot;property.download_public_stories&quot;&gt;Download public stories&lt;/string&gt;
</a><a href="#h102-0-10" id="h102-0-10" class="i">+    &lt;string name=&quot;property.download_spotlight&quot;&gt;Download spotlight&lt;/string&gt;
</a><a href="#h102-0-11" id="h102-0-11" class="i">+    &lt;string name=&quot;property.overlay_merge&quot;&gt;Overlay merge&lt;/string&gt;
</a><a href="#h102-0-12" id="h102-0-12" class="i">+    &lt;string name=&quot;property.download_inchat_snaps&quot;&gt;Download in chat snaps&lt;/string&gt;
</a><a href="#h102-0-13" id="h102-0-13" class="i">+    &lt;string name=&quot;property.disable_metrics&quot;&gt;Disable metrics&lt;/string&gt;
</a><a href="#h102-0-14" id="h102-0-14" class="i">+    &lt;string name=&quot;property.prevent_screenshot&quot;&gt;Prevent screenshot&lt;/string&gt;
</a><a href="#h102-0-15" id="h102-0-15" class="i">+    &lt;string name=&quot;property.anonymous_story_view&quot;&gt;Anonymous story view&lt;/string&gt;
</a><a href="#h102-0-16" id="h102-0-16" class="i">+    &lt;string name=&quot;property.hide_typing_notification&quot;&gt;Hide typing notification&lt;/string&gt;
</a><a href="#h102-0-17" id="h102-0-17" class="i">+    &lt;string name=&quot;property.menu_slot_id&quot;&gt;Menu slot id&lt;/string&gt;
</a><a href="#h102-0-18" id="h102-0-18" class="i">+    &lt;string name=&quot;property.message_preview_length&quot;&gt;Message preview length&lt;/string&gt;
</a><a href="#h102-0-19" id="h102-0-19" class="i">+    &lt;string name=&quot;property.auto_save&quot;&gt;Auto save&lt;/string&gt;
</a><a href="#h102-0-20" id="h102-0-20" class="i">+    &lt;string name=&quot;property.external_media_as_snap&quot;&gt;External media as snap&lt;/string&gt;
</a><a href="#h102-0-21" id="h102-0-21" class="i">+    &lt;string name=&quot;property.conversation_export&quot;&gt;Conversation export&lt;/string&gt;
</a><a href="#h102-0-22" id="h102-0-22" class="i">+    &lt;string name=&quot;property.snapchat_plus&quot;&gt;Snapchat Plus&lt;/string&gt;
</a><a href="#h102-0-23" id="h102-0-23" class="i">+    &lt;string name=&quot;property.remove_voice_record_button&quot;&gt;Remove voice record button&lt;/string&gt;
</a><a href="#h102-0-24" id="h102-0-24" class="i">+    &lt;string name=&quot;property.remove_stickers_button&quot;&gt;Remove stickers button&lt;/string&gt;
</a><a href="#h102-0-25" id="h102-0-25" class="i">+    &lt;string name=&quot;property.remove_cognac_button&quot;&gt;Remove cognac button&lt;/string&gt;
</a><a href="#h102-0-26" id="h102-0-26" class="i">+    &lt;string name=&quot;property.remove_callbuttons&quot;&gt;Remove call buttons&lt;/string&gt;
</a><a href="#h102-0-27" id="h102-0-27" class="i">+    &lt;string name=&quot;property.long_snap_sending&quot;&gt;Long snap sending&lt;/string&gt;
</a><a href="#h102-0-28" id="h102-0-28" class="i">+    &lt;string name=&quot;property.block_ads&quot;&gt;Block ads&lt;/string&gt;
</a><a href="#h102-0-29" id="h102-0-29" class="i">+    &lt;string name=&quot;property.streakexpirationinfo&quot;&gt;Streak Expiration Info&lt;/string&gt;
</a><a href="#h102-0-30" id="h102-0-30" class="i">+    &lt;string name=&quot;property.new_map_ui&quot;&gt;New map ui&lt;/string&gt;
</a><a href="#h102-0-31" id="h102-0-31" class="i">+    &lt;string name=&quot;property.use_download_manager&quot;&gt;Use download manager&lt;/string&gt;
</a><a href="#h102-0-32" id="h102-0-32" class="i">+&lt;/resources&gt;</a><a href="#h102-0-33" id="h102-0-33" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h103" href="../file/build.gradle.html">build.gradle</a> b/<a href="../file/build.gradle.html">build.gradle</a></b>
<a href="#h103-0" id="h103-0" class="h">@@ -0,0 +1,10 @@
</a><a href="#h103-0-0" id="h103-0-0" class="i">+// Top-level build file where you can add configuration options common to all sub-projects/modules.
</a><a href="#h103-0-1" id="h103-0-1" class="i">+plugins {
</a><a href="#h103-0-2" id="h103-0-2" class="i">+    id &#39;com.android.application&#39; version &#39;7.2.2&#39; apply false
</a><a href="#h103-0-3" id="h103-0-3" class="i">+    id &#39;com.android.library&#39; version &#39;7.2.2&#39; apply false
</a><a href="#h103-0-4" id="h103-0-4" class="i">+    id &#39;org.jetbrains.kotlin.android&#39; version &#39;1.8.21&#39; apply false
</a><a href="#h103-0-5" id="h103-0-5" class="i">+}
</a><a href="#h103-0-6" id="h103-0-6" class="i">+
</a><a href="#h103-0-7" id="h103-0-7" class="i">+task clean(type: Delete) {
</a><a href="#h103-0-8" id="h103-0-8" class="i">+    delete rootProject.buildDir
</a><a href="#h103-0-9" id="h103-0-9" class="i">+}</a><a href="#h103-0-10" id="h103-0-10" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h104" href="../file/gradle.properties.html">gradle.properties</a> b/<a href="../file/gradle.properties.html">gradle.properties</a></b>
<a href="#h104-0" id="h104-0" class="h">@@ -0,0 +1,23 @@
</a><a href="#h104-0-0" id="h104-0-0" class="i">+# Project-wide Gradle settings.
</a><a href="#h104-0-1" id="h104-0-1" class="i">+# IDE (e.g. Android Studio) users:
</a><a href="#h104-0-2" id="h104-0-2" class="i">+# Gradle settings configured through the IDE *will override*
</a><a href="#h104-0-3" id="h104-0-3" class="i">+# any settings specified in this file.
</a><a href="#h104-0-4" id="h104-0-4" class="i">+# For more details on how to configure your build environment visit
</a><a href="#h104-0-5" id="h104-0-5" class="i">+# http://www.gradle.org/docs/current/userguide/build_environment.html
</a><a href="#h104-0-6" id="h104-0-6" class="i">+# Specifies the JVM arguments used for the daemon process.
</a><a href="#h104-0-7" id="h104-0-7" class="i">+# The setting is particularly useful for tweaking memory settings.
</a><a href="#h104-0-8" id="h104-0-8" class="i">+org.gradle.jvmargs=-Xmx2048m -Dfile.encoding=UTF-8
</a><a href="#h104-0-9" id="h104-0-9" class="i">+# When configured, Gradle will run in incubating parallel mode.
</a><a href="#h104-0-10" id="h104-0-10" class="i">+# This option should only be used with decoupled projects. More details, visit
</a><a href="#h104-0-11" id="h104-0-11" class="i">+# http://www.gradle.org/docs/current/userguide/multi_project_builds.html#sec:decoupled_projects
</a><a href="#h104-0-12" id="h104-0-12" class="i">+# org.gradle.parallel=true
</a><a href="#h104-0-13" id="h104-0-13" class="i">+# AndroidX package structure to make it clearer which packages are bundled with the
</a><a href="#h104-0-14" id="h104-0-14" class="i">+# Android operating system, and which are packaged with your app&quot;s APK
</a><a href="#h104-0-15" id="h104-0-15" class="i">+# https://developer.android.com/topic/libraries/support-library/androidx-rn
</a><a href="#h104-0-16" id="h104-0-16" class="i">+android.useAndroidX=true
</a><a href="#h104-0-17" id="h104-0-17" class="i">+# Kotlin code style for this project: &quot;official&quot; or &quot;obsolete&quot;:
</a><a href="#h104-0-18" id="h104-0-18" class="i">+kotlin.code.style=official
</a><a href="#h104-0-19" id="h104-0-19" class="i">+# Enables namespacing of each library&#39;s R class so that its R class includes only the
</a><a href="#h104-0-20" id="h104-0-20" class="i">+# resources declared in the library itself and none from the library&#39;s dependencies,
</a><a href="#h104-0-21" id="h104-0-21" class="i">+# thereby reducing the size of the R class for that library
</a><a href="#h104-0-22" id="h104-0-22" class="i">+android.nonTransitiveRClass=true</a><a href="#h104-0-23" id="h104-0-23" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h105" href="../file/gradle/wrapper/gradle-wrapper.jar.html">gradle/wrapper/gradle-wrapper.jar</a> b/<a href="../file/gradle/wrapper/gradle-wrapper.jar.html">gradle/wrapper/gradle-wrapper.jar</a></b>
Binary files differ.
<b>diff --git a/<a id="h106" href="../file/gradle/wrapper/gradle-wrapper.properties.html">gradle/wrapper/gradle-wrapper.properties</a> b/<a href="../file/gradle/wrapper/gradle-wrapper.properties.html">gradle/wrapper/gradle-wrapper.properties</a></b>
<a href="#h106-0" id="h106-0" class="h">@@ -0,0 +1,6 @@
</a><a href="#h106-0-0" id="h106-0-0" class="i">+#Fri May 12 21:23:16 CEST 2023
</a><a href="#h106-0-1" id="h106-0-1" class="i">+distributionBase=GRADLE_USER_HOME
</a><a href="#h106-0-2" id="h106-0-2" class="i">+distributionUrl=https\://services.gradle.org/distributions/gradle-7.3.3-bin.zip
</a><a href="#h106-0-3" id="h106-0-3" class="i">+distributionPath=wrapper/dists
</a><a href="#h106-0-4" id="h106-0-4" class="i">+zipStorePath=wrapper/dists
</a><a href="#h106-0-5" id="h106-0-5" class="i">+zipStoreBase=GRADLE_USER_HOME
</a><b>diff --git a/<a id="h107" href="../file/gradlew.html">gradlew</a> b/<a href="../file/gradlew.html">gradlew</a></b>
<a href="#h107-0" id="h107-0" class="h">@@ -0,0 +1,185 @@
</a><a href="#h107-0-0" id="h107-0-0" class="i">+#!/usr/bin/env sh
</a><a href="#h107-0-1" id="h107-0-1" class="i">+
</a><a href="#h107-0-2" id="h107-0-2" class="i">+#
</a><a href="#h107-0-3" id="h107-0-3" class="i">+# Copyright 2015 the original author or authors.
</a><a href="#h107-0-4" id="h107-0-4" class="i">+#
</a><a href="#h107-0-5" id="h107-0-5" class="i">+# Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
</a><a href="#h107-0-6" id="h107-0-6" class="i">+# you may not use this file except in compliance with the License.
</a><a href="#h107-0-7" id="h107-0-7" class="i">+# You may obtain a copy of the License at
</a><a href="#h107-0-8" id="h107-0-8" class="i">+#
</a><a href="#h107-0-9" id="h107-0-9" class="i">+#      https://www.apache.org/licenses/LICENSE-2.0
</a><a href="#h107-0-10" id="h107-0-10" class="i">+#
</a><a href="#h107-0-11" id="h107-0-11" class="i">+# Unless required by applicable law or agreed to in writing, software
</a><a href="#h107-0-12" id="h107-0-12" class="i">+# distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
</a><a href="#h107-0-13" id="h107-0-13" class="i">+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
</a><a href="#h107-0-14" id="h107-0-14" class="i">+# See the License for the specific language governing permissions and
</a><a href="#h107-0-15" id="h107-0-15" class="i">+# limitations under the License.
</a><a href="#h107-0-16" id="h107-0-16" class="i">+#
</a><a href="#h107-0-17" id="h107-0-17" class="i">+
</a><a href="#h107-0-18" id="h107-0-18" class="i">+##############################################################################
</a><a href="#h107-0-19" id="h107-0-19" class="i">+##
</a><a href="#h107-0-20" id="h107-0-20" class="i">+##  Gradle start up script for UN*X
</a><a href="#h107-0-21" id="h107-0-21" class="i">+##
</a><a href="#h107-0-22" id="h107-0-22" class="i">+##############################################################################
</a><a href="#h107-0-23" id="h107-0-23" class="i">+
</a><a href="#h107-0-24" id="h107-0-24" class="i">+# Attempt to set APP_HOME
</a><a href="#h107-0-25" id="h107-0-25" class="i">+# Resolve links: $0 may be a link
</a><a href="#h107-0-26" id="h107-0-26" class="i">+PRG=&quot;$0&quot;
</a><a href="#h107-0-27" id="h107-0-27" class="i">+# Need this for relative symlinks.
</a><a href="#h107-0-28" id="h107-0-28" class="i">+while [ -h &quot;$PRG&quot; ] ; do
</a><a href="#h107-0-29" id="h107-0-29" class="i">+    ls=`ls -ld &quot;$PRG&quot;`
</a><a href="#h107-0-30" id="h107-0-30" class="i">+    link=`expr &quot;$ls&quot; : &#39;.*-&gt; \(.*\)$&#39;`
</a><a href="#h107-0-31" id="h107-0-31" class="i">+    if expr &quot;$link&quot; : &#39;/.*&#39; &gt; /dev/null; then
</a><a href="#h107-0-32" id="h107-0-32" class="i">+        PRG=&quot;$link&quot;
</a><a href="#h107-0-33" id="h107-0-33" class="i">+    else
</a><a href="#h107-0-34" id="h107-0-34" class="i">+        PRG=`dirname &quot;$PRG&quot;`&quot;/$link&quot;
</a><a href="#h107-0-35" id="h107-0-35" class="i">+    fi
</a><a href="#h107-0-36" id="h107-0-36" class="i">+done
</a><a href="#h107-0-37" id="h107-0-37" class="i">+SAVED=&quot;`pwd`&quot;
</a><a href="#h107-0-38" id="h107-0-38" class="i">+cd &quot;`dirname \&quot;$PRG\&quot;`/&quot; &gt;/dev/null
</a><a href="#h107-0-39" id="h107-0-39" class="i">+APP_HOME=&quot;`pwd -P`&quot;
</a><a href="#h107-0-40" id="h107-0-40" class="i">+cd &quot;$SAVED&quot; &gt;/dev/null
</a><a href="#h107-0-41" id="h107-0-41" class="i">+
</a><a href="#h107-0-42" id="h107-0-42" class="i">+APP_NAME=&quot;Gradle&quot;
</a><a href="#h107-0-43" id="h107-0-43" class="i">+APP_BASE_NAME=`basename &quot;$0&quot;`
</a><a href="#h107-0-44" id="h107-0-44" class="i">+
</a><a href="#h107-0-45" id="h107-0-45" class="i">+# Add default JVM options here. You can also use JAVA_OPTS and GRADLE_OPTS to pass JVM options to this script.
</a><a href="#h107-0-46" id="h107-0-46" class="i">+DEFAULT_JVM_OPTS=&#39;&quot;-Xmx64m&quot; &quot;-Xms64m&quot;&#39;
</a><a href="#h107-0-47" id="h107-0-47" class="i">+
</a><a href="#h107-0-48" id="h107-0-48" class="i">+# Use the maximum available, or set MAX_FD != -1 to use that value.
</a><a href="#h107-0-49" id="h107-0-49" class="i">+MAX_FD=&quot;maximum&quot;
</a><a href="#h107-0-50" id="h107-0-50" class="i">+
</a><a href="#h107-0-51" id="h107-0-51" class="i">+warn () {
</a><a href="#h107-0-52" id="h107-0-52" class="i">+    echo &quot;$*&quot;
</a><a href="#h107-0-53" id="h107-0-53" class="i">+}
</a><a href="#h107-0-54" id="h107-0-54" class="i">+
</a><a href="#h107-0-55" id="h107-0-55" class="i">+die () {
</a><a href="#h107-0-56" id="h107-0-56" class="i">+    echo
</a><a href="#h107-0-57" id="h107-0-57" class="i">+    echo &quot;$*&quot;
</a><a href="#h107-0-58" id="h107-0-58" class="i">+    echo
</a><a href="#h107-0-59" id="h107-0-59" class="i">+    exit 1
</a><a href="#h107-0-60" id="h107-0-60" class="i">+}
</a><a href="#h107-0-61" id="h107-0-61" class="i">+
</a><a href="#h107-0-62" id="h107-0-62" class="i">+# OS specific support (must be &#39;true&#39; or &#39;false&#39;).
</a><a href="#h107-0-63" id="h107-0-63" class="i">+cygwin=false
</a><a href="#h107-0-64" id="h107-0-64" class="i">+msys=false
</a><a href="#h107-0-65" id="h107-0-65" class="i">+darwin=false
</a><a href="#h107-0-66" id="h107-0-66" class="i">+nonstop=false
</a><a href="#h107-0-67" id="h107-0-67" class="i">+case &quot;`uname`&quot; in
</a><a href="#h107-0-68" id="h107-0-68" class="i">+  CYGWIN* )
</a><a href="#h107-0-69" id="h107-0-69" class="i">+    cygwin=true
</a><a href="#h107-0-70" id="h107-0-70" class="i">+    ;;
</a><a href="#h107-0-71" id="h107-0-71" class="i">+  Darwin* )
</a><a href="#h107-0-72" id="h107-0-72" class="i">+    darwin=true
</a><a href="#h107-0-73" id="h107-0-73" class="i">+    ;;
</a><a href="#h107-0-74" id="h107-0-74" class="i">+  MINGW* )
</a><a href="#h107-0-75" id="h107-0-75" class="i">+    msys=true
</a><a href="#h107-0-76" id="h107-0-76" class="i">+    ;;
</a><a href="#h107-0-77" id="h107-0-77" class="i">+  NONSTOP* )
</a><a href="#h107-0-78" id="h107-0-78" class="i">+    nonstop=true
</a><a href="#h107-0-79" id="h107-0-79" class="i">+    ;;
</a><a href="#h107-0-80" id="h107-0-80" class="i">+esac
</a><a href="#h107-0-81" id="h107-0-81" class="i">+
</a><a href="#h107-0-82" id="h107-0-82" class="i">+CLASSPATH=$APP_HOME/gradle/wrapper/gradle-wrapper.jar
</a><a href="#h107-0-83" id="h107-0-83" class="i">+
</a><a href="#h107-0-84" id="h107-0-84" class="i">+
</a><a href="#h107-0-85" id="h107-0-85" class="i">+# Determine the Java command to use to start the JVM.
</a><a href="#h107-0-86" id="h107-0-86" class="i">+if [ -n &quot;$JAVA_HOME&quot; ] ; then
</a><a href="#h107-0-87" id="h107-0-87" class="i">+    if [ -x &quot;$JAVA_HOME/jre/sh/java&quot; ] ; then
</a><a href="#h107-0-88" id="h107-0-88" class="i">+        # IBM&#39;s JDK on AIX uses strange locations for the executables
</a><a href="#h107-0-89" id="h107-0-89" class="i">+        JAVACMD=&quot;$JAVA_HOME/jre/sh/java&quot;
</a><a href="#h107-0-90" id="h107-0-90" class="i">+    else
</a><a href="#h107-0-91" id="h107-0-91" class="i">+        JAVACMD=&quot;$JAVA_HOME/bin/java&quot;
</a><a href="#h107-0-92" id="h107-0-92" class="i">+    fi
</a><a href="#h107-0-93" id="h107-0-93" class="i">+    if [ ! -x &quot;$JAVACMD&quot; ] ; then
</a><a href="#h107-0-94" id="h107-0-94" class="i">+        die &quot;ERROR: JAVA_HOME is set to an invalid directory: $JAVA_HOME
</a><a href="#h107-0-95" id="h107-0-95" class="i">+
</a><a href="#h107-0-96" id="h107-0-96" class="i">+Please set the JAVA_HOME variable in your environment to match the
</a><a href="#h107-0-97" id="h107-0-97" class="i">+location of your Java installation.&quot;
</a><a href="#h107-0-98" id="h107-0-98" class="i">+    fi
</a><a href="#h107-0-99" id="h107-0-99" class="i">+else
</a><a href="#h107-0-100" id="h107-0-100" class="i">+    JAVACMD=&quot;java&quot;
</a><a href="#h107-0-101" id="h107-0-101" class="i">+    which java &gt;/dev/null 2&gt;&amp;1 || die &quot;ERROR: JAVA_HOME is not set and no &#39;java&#39; command could be found in your PATH.
</a><a href="#h107-0-102" id="h107-0-102" class="i">+
</a><a href="#h107-0-103" id="h107-0-103" class="i">+Please set the JAVA_HOME variable in your environment to match the
</a><a href="#h107-0-104" id="h107-0-104" class="i">+location of your Java installation.&quot;
</a><a href="#h107-0-105" id="h107-0-105" class="i">+fi
</a><a href="#h107-0-106" id="h107-0-106" class="i">+
</a><a href="#h107-0-107" id="h107-0-107" class="i">+# Increase the maximum file descriptors if we can.
</a><a href="#h107-0-108" id="h107-0-108" class="i">+if [ &quot;$cygwin&quot; = &quot;false&quot; -a &quot;$darwin&quot; = &quot;false&quot; -a &quot;$nonstop&quot; = &quot;false&quot; ] ; then
</a><a href="#h107-0-109" id="h107-0-109" class="i">+    MAX_FD_LIMIT=`ulimit -H -n`
</a><a href="#h107-0-110" id="h107-0-110" class="i">+    if [ $? -eq 0 ] ; then
</a><a href="#h107-0-111" id="h107-0-111" class="i">+        if [ &quot;$MAX_FD&quot; = &quot;maximum&quot; -o &quot;$MAX_FD&quot; = &quot;max&quot; ] ; then
</a><a href="#h107-0-112" id="h107-0-112" class="i">+            MAX_FD=&quot;$MAX_FD_LIMIT&quot;
</a><a href="#h107-0-113" id="h107-0-113" class="i">+        fi
</a><a href="#h107-0-114" id="h107-0-114" class="i">+        ulimit -n $MAX_FD
</a><a href="#h107-0-115" id="h107-0-115" class="i">+        if [ $? -ne 0 ] ; then
</a><a href="#h107-0-116" id="h107-0-116" class="i">+            warn &quot;Could not set maximum file descriptor limit: $MAX_FD&quot;
</a><a href="#h107-0-117" id="h107-0-117" class="i">+        fi
</a><a href="#h107-0-118" id="h107-0-118" class="i">+    else
</a><a href="#h107-0-119" id="h107-0-119" class="i">+        warn &quot;Could not query maximum file descriptor limit: $MAX_FD_LIMIT&quot;
</a><a href="#h107-0-120" id="h107-0-120" class="i">+    fi
</a><a href="#h107-0-121" id="h107-0-121" class="i">+fi
</a><a href="#h107-0-122" id="h107-0-122" class="i">+
</a><a href="#h107-0-123" id="h107-0-123" class="i">+# For Darwin, add options to specify how the application appears in the dock
</a><a href="#h107-0-124" id="h107-0-124" class="i">+if $darwin; then
</a><a href="#h107-0-125" id="h107-0-125" class="i">+    GRADLE_OPTS=&quot;$GRADLE_OPTS \&quot;-Xdock:name=$APP_NAME\&quot; \&quot;-Xdock:icon=$APP_HOME/media/gradle.icns\&quot;&quot;
</a><a href="#h107-0-126" id="h107-0-126" class="i">+fi
</a><a href="#h107-0-127" id="h107-0-127" class="i">+
</a><a href="#h107-0-128" id="h107-0-128" class="i">+# For Cygwin or MSYS, switch paths to Windows format before running java
</a><a href="#h107-0-129" id="h107-0-129" class="i">+if [ &quot;$cygwin&quot; = &quot;true&quot; -o &quot;$msys&quot; = &quot;true&quot; ] ; then
</a><a href="#h107-0-130" id="h107-0-130" class="i">+    APP_HOME=`cygpath --path --mixed &quot;$APP_HOME&quot;`
</a><a href="#h107-0-131" id="h107-0-131" class="i">+    CLASSPATH=`cygpath --path --mixed &quot;$CLASSPATH&quot;`
</a><a href="#h107-0-132" id="h107-0-132" class="i">+
</a><a href="#h107-0-133" id="h107-0-133" class="i">+    JAVACMD=`cygpath --unix &quot;$JAVACMD&quot;`
</a><a href="#h107-0-134" id="h107-0-134" class="i">+
</a><a href="#h107-0-135" id="h107-0-135" class="i">+    # We build the pattern for arguments to be converted via cygpath
</a><a href="#h107-0-136" id="h107-0-136" class="i">+    ROOTDIRSRAW=`find -L / -maxdepth 1 -mindepth 1 -type d 2&gt;/dev/null`
</a><a href="#h107-0-137" id="h107-0-137" class="i">+    SEP=&quot;&quot;
</a><a href="#h107-0-138" id="h107-0-138" class="i">+    for dir in $ROOTDIRSRAW ; do
</a><a href="#h107-0-139" id="h107-0-139" class="i">+        ROOTDIRS=&quot;$ROOTDIRS$SEP$dir&quot;
</a><a href="#h107-0-140" id="h107-0-140" class="i">+        SEP=&quot;|&quot;
</a><a href="#h107-0-141" id="h107-0-141" class="i">+    done
</a><a href="#h107-0-142" id="h107-0-142" class="i">+    OURCYGPATTERN=&quot;(^($ROOTDIRS))&quot;
</a><a href="#h107-0-143" id="h107-0-143" class="i">+    # Add a user-defined pattern to the cygpath arguments
</a><a href="#h107-0-144" id="h107-0-144" class="i">+    if [ &quot;$GRADLE_CYGPATTERN&quot; != &quot;&quot; ] ; then
</a><a href="#h107-0-145" id="h107-0-145" class="i">+        OURCYGPATTERN=&quot;$OURCYGPATTERN|($GRADLE_CYGPATTERN)&quot;
</a><a href="#h107-0-146" id="h107-0-146" class="i">+    fi
</a><a href="#h107-0-147" id="h107-0-147" class="i">+    # Now convert the arguments - kludge to limit ourselves to /bin/sh
</a><a href="#h107-0-148" id="h107-0-148" class="i">+    i=0
</a><a href="#h107-0-149" id="h107-0-149" class="i">+    for arg in &quot;$@&quot; ; do
</a><a href="#h107-0-150" id="h107-0-150" class="i">+        CHECK=`echo &quot;$arg&quot;|egrep -c &quot;$OURCYGPATTERN&quot; -`
</a><a href="#h107-0-151" id="h107-0-151" class="i">+        CHECK2=`echo &quot;$arg&quot;|egrep -c &quot;^-&quot;`                                 ### Determine if an option
</a><a href="#h107-0-152" id="h107-0-152" class="i">+
</a><a href="#h107-0-153" id="h107-0-153" class="i">+        if [ $CHECK -ne 0 ] &amp;&amp; [ $CHECK2 -eq 0 ] ; then                    ### Added a condition
</a><a href="#h107-0-154" id="h107-0-154" class="i">+            eval `echo args$i`=`cygpath --path --ignore --mixed &quot;$arg&quot;`
</a><a href="#h107-0-155" id="h107-0-155" class="i">+        else
</a><a href="#h107-0-156" id="h107-0-156" class="i">+            eval `echo args$i`=&quot;\&quot;$arg\&quot;&quot;
</a><a href="#h107-0-157" id="h107-0-157" class="i">+        fi
</a><a href="#h107-0-158" id="h107-0-158" class="i">+        i=`expr $i + 1`
</a><a href="#h107-0-159" id="h107-0-159" class="i">+    done
</a><a href="#h107-0-160" id="h107-0-160" class="i">+    case $i in
</a><a href="#h107-0-161" id="h107-0-161" class="i">+        0) set -- ;;
</a><a href="#h107-0-162" id="h107-0-162" class="i">+        1) set -- &quot;$args0&quot; ;;
</a><a href="#h107-0-163" id="h107-0-163" class="i">+        2) set -- &quot;$args0&quot; &quot;$args1&quot; ;;
</a><a href="#h107-0-164" id="h107-0-164" class="i">+        3) set -- &quot;$args0&quot; &quot;$args1&quot; &quot;$args2&quot; ;;
</a><a href="#h107-0-165" id="h107-0-165" class="i">+        4) set -- &quot;$args0&quot; &quot;$args1&quot; &quot;$args2&quot; &quot;$args3&quot; ;;
</a><a href="#h107-0-166" id="h107-0-166" class="i">+        5) set -- &quot;$args0&quot; &quot;$args1&quot; &quot;$args2&quot; &quot;$args3&quot; &quot;$args4&quot; ;;
</a><a href="#h107-0-167" id="h107-0-167" class="i">+        6) set -- &quot;$args0&quot; &quot;$args1&quot; &quot;$args2&quot; &quot;$args3&quot; &quot;$args4&quot; &quot;$args5&quot; ;;
</a><a href="#h107-0-168" id="h107-0-168" class="i">+        7) set -- &quot;$args0&quot; &quot;$args1&quot; &quot;$args2&quot; &quot;$args3&quot; &quot;$args4&quot; &quot;$args5&quot; &quot;$args6&quot; ;;
</a><a href="#h107-0-169" id="h107-0-169" class="i">+        8) set -- &quot;$args0&quot; &quot;$args1&quot; &quot;$args2&quot; &quot;$args3&quot; &quot;$args4&quot; &quot;$args5&quot; &quot;$args6&quot; &quot;$args7&quot; ;;
</a><a href="#h107-0-170" id="h107-0-170" class="i">+        9) set -- &quot;$args0&quot; &quot;$args1&quot; &quot;$args2&quot; &quot;$args3&quot; &quot;$args4&quot; &quot;$args5&quot; &quot;$args6&quot; &quot;$args7&quot; &quot;$args8&quot; ;;
</a><a href="#h107-0-171" id="h107-0-171" class="i">+    esac
</a><a href="#h107-0-172" id="h107-0-172" class="i">+fi
</a><a href="#h107-0-173" id="h107-0-173" class="i">+
</a><a href="#h107-0-174" id="h107-0-174" class="i">+# Escape application args
</a><a href="#h107-0-175" id="h107-0-175" class="i">+save () {
</a><a href="#h107-0-176" id="h107-0-176" class="i">+    for i do printf %s\\n &quot;$i&quot; | sed &quot;s/&#39;/&#39;\\\\&#39;&#39;/g;1s/^/&#39;/;\$s/\$/&#39; \\\\/&quot; ; done
</a><a href="#h107-0-177" id="h107-0-177" class="i">+    echo &quot; &quot;
</a><a href="#h107-0-178" id="h107-0-178" class="i">+}
</a><a href="#h107-0-179" id="h107-0-179" class="i">+APP_ARGS=`save &quot;$@&quot;`
</a><a href="#h107-0-180" id="h107-0-180" class="i">+
</a><a href="#h107-0-181" id="h107-0-181" class="i">+# Collect all arguments for the java command, following the shell quoting and substitution rules
</a><a href="#h107-0-182" id="h107-0-182" class="i">+eval set -- $DEFAULT_JVM_OPTS $JAVA_OPTS $GRADLE_OPTS &quot;\&quot;-Dorg.gradle.appname=$APP_BASE_NAME\&quot;&quot; -classpath &quot;\&quot;$CLASSPATH\&quot;&quot; org.gradle.wrapper.GradleWrapperMain &quot;$APP_ARGS&quot;
</a><a href="#h107-0-183" id="h107-0-183" class="i">+
</a><a href="#h107-0-184" id="h107-0-184" class="i">+exec &quot;$JAVACMD&quot; &quot;$@&quot;
</a><b>diff --git a/<a id="h108" href="../file/gradlew.bat.html">gradlew.bat</a> b/<a href="../file/gradlew.bat.html">gradlew.bat</a></b>
<a href="#h108-0" id="h108-0" class="h">@@ -0,0 +1,89 @@
</a><a href="#h108-0-0" id="h108-0-0" class="i">+@rem
</a><a href="#h108-0-1" id="h108-0-1" class="i">+@rem Copyright 2015 the original author or authors.
</a><a href="#h108-0-2" id="h108-0-2" class="i">+@rem
</a><a href="#h108-0-3" id="h108-0-3" class="i">+@rem Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
</a><a href="#h108-0-4" id="h108-0-4" class="i">+@rem you may not use this file except in compliance with the License.
</a><a href="#h108-0-5" id="h108-0-5" class="i">+@rem You may obtain a copy of the License at
</a><a href="#h108-0-6" id="h108-0-6" class="i">+@rem
</a><a href="#h108-0-7" id="h108-0-7" class="i">+@rem      https://www.apache.org/licenses/LICENSE-2.0
</a><a href="#h108-0-8" id="h108-0-8" class="i">+@rem
</a><a href="#h108-0-9" id="h108-0-9" class="i">+@rem Unless required by applicable law or agreed to in writing, software
</a><a href="#h108-0-10" id="h108-0-10" class="i">+@rem distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
</a><a href="#h108-0-11" id="h108-0-11" class="i">+@rem WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
</a><a href="#h108-0-12" id="h108-0-12" class="i">+@rem See the License for the specific language governing permissions and
</a><a href="#h108-0-13" id="h108-0-13" class="i">+@rem limitations under the License.
</a><a href="#h108-0-14" id="h108-0-14" class="i">+@rem
</a><a href="#h108-0-15" id="h108-0-15" class="i">+
</a><a href="#h108-0-16" id="h108-0-16" class="i">+@if &quot;%DEBUG%&quot; == &quot;&quot; @echo off
</a><a href="#h108-0-17" id="h108-0-17" class="i">+@rem ##########################################################################
</a><a href="#h108-0-18" id="h108-0-18" class="i">+@rem
</a><a href="#h108-0-19" id="h108-0-19" class="i">+@rem  Gradle startup script for Windows
</a><a href="#h108-0-20" id="h108-0-20" class="i">+@rem
</a><a href="#h108-0-21" id="h108-0-21" class="i">+@rem ##########################################################################
</a><a href="#h108-0-22" id="h108-0-22" class="i">+
</a><a href="#h108-0-23" id="h108-0-23" class="i">+@rem Set local scope for the variables with windows NT shell
</a><a href="#h108-0-24" id="h108-0-24" class="i">+if &quot;%OS%&quot;==&quot;Windows_NT&quot; setlocal
</a><a href="#h108-0-25" id="h108-0-25" class="i">+
</a><a href="#h108-0-26" id="h108-0-26" class="i">+set DIRNAME=%~dp0
</a><a href="#h108-0-27" id="h108-0-27" class="i">+if &quot;%DIRNAME%&quot; == &quot;&quot; set DIRNAME=.
</a><a href="#h108-0-28" id="h108-0-28" class="i">+set APP_BASE_NAME=%~n0
</a><a href="#h108-0-29" id="h108-0-29" class="i">+set APP_HOME=%DIRNAME%
</a><a href="#h108-0-30" id="h108-0-30" class="i">+
</a><a href="#h108-0-31" id="h108-0-31" class="i">+@rem Resolve any &quot;.&quot; and &quot;..&quot; in APP_HOME to make it shorter.
</a><a href="#h108-0-32" id="h108-0-32" class="i">+for %%i in (&quot;%APP_HOME%&quot;) do set APP_HOME=%%~fi
</a><a href="#h108-0-33" id="h108-0-33" class="i">+
</a><a href="#h108-0-34" id="h108-0-34" class="i">+@rem Add default JVM options here. You can also use JAVA_OPTS and GRADLE_OPTS to pass JVM options to this script.
</a><a href="#h108-0-35" id="h108-0-35" class="i">+set DEFAULT_JVM_OPTS=&quot;-Xmx64m&quot; &quot;-Xms64m&quot;
</a><a href="#h108-0-36" id="h108-0-36" class="i">+
</a><a href="#h108-0-37" id="h108-0-37" class="i">+@rem Find java.exe
</a><a href="#h108-0-38" id="h108-0-38" class="i">+if defined JAVA_HOME goto findJavaFromJavaHome
</a><a href="#h108-0-39" id="h108-0-39" class="i">+
</a><a href="#h108-0-40" id="h108-0-40" class="i">+set JAVA_EXE=java.exe
</a><a href="#h108-0-41" id="h108-0-41" class="i">+%JAVA_EXE% -version &gt;NUL 2&gt;&amp;1
</a><a href="#h108-0-42" id="h108-0-42" class="i">+if &quot;%ERRORLEVEL%&quot; == &quot;0&quot; goto execute
</a><a href="#h108-0-43" id="h108-0-43" class="i">+
</a><a href="#h108-0-44" id="h108-0-44" class="i">+echo.
</a><a href="#h108-0-45" id="h108-0-45" class="i">+echo ERROR: JAVA_HOME is not set and no &#39;java&#39; command could be found in your PATH.
</a><a href="#h108-0-46" id="h108-0-46" class="i">+echo.
</a><a href="#h108-0-47" id="h108-0-47" class="i">+echo Please set the JAVA_HOME variable in your environment to match the
</a><a href="#h108-0-48" id="h108-0-48" class="i">+echo location of your Java installation.
</a><a href="#h108-0-49" id="h108-0-49" class="i">+
</a><a href="#h108-0-50" id="h108-0-50" class="i">+goto fail
</a><a href="#h108-0-51" id="h108-0-51" class="i">+
</a><a href="#h108-0-52" id="h108-0-52" class="i">+:findJavaFromJavaHome
</a><a href="#h108-0-53" id="h108-0-53" class="i">+set JAVA_HOME=%JAVA_HOME:&quot;=%
</a><a href="#h108-0-54" id="h108-0-54" class="i">+set JAVA_EXE=%JAVA_HOME%/bin/java.exe
</a><a href="#h108-0-55" id="h108-0-55" class="i">+
</a><a href="#h108-0-56" id="h108-0-56" class="i">+if exist &quot;%JAVA_EXE%&quot; goto execute
</a><a href="#h108-0-57" id="h108-0-57" class="i">+
</a><a href="#h108-0-58" id="h108-0-58" class="i">+echo.
</a><a href="#h108-0-59" id="h108-0-59" class="i">+echo ERROR: JAVA_HOME is set to an invalid directory: %JAVA_HOME%
</a><a href="#h108-0-60" id="h108-0-60" class="i">+echo.
</a><a href="#h108-0-61" id="h108-0-61" class="i">+echo Please set the JAVA_HOME variable in your environment to match the
</a><a href="#h108-0-62" id="h108-0-62" class="i">+echo location of your Java installation.
</a><a href="#h108-0-63" id="h108-0-63" class="i">+
</a><a href="#h108-0-64" id="h108-0-64" class="i">+goto fail
</a><a href="#h108-0-65" id="h108-0-65" class="i">+
</a><a href="#h108-0-66" id="h108-0-66" class="i">+:execute
</a><a href="#h108-0-67" id="h108-0-67" class="i">+@rem Setup the command line
</a><a href="#h108-0-68" id="h108-0-68" class="i">+
</a><a href="#h108-0-69" id="h108-0-69" class="i">+set CLASSPATH=%APP_HOME%\gradle\wrapper\gradle-wrapper.jar
</a><a href="#h108-0-70" id="h108-0-70" class="i">+
</a><a href="#h108-0-71" id="h108-0-71" class="i">+
</a><a href="#h108-0-72" id="h108-0-72" class="i">+@rem Execute Gradle
</a><a href="#h108-0-73" id="h108-0-73" class="i">+&quot;%JAVA_EXE%&quot; %DEFAULT_JVM_OPTS% %JAVA_OPTS% %GRADLE_OPTS% &quot;-Dorg.gradle.appname=%APP_BASE_NAME%&quot; -classpath &quot;%CLASSPATH%&quot; org.gradle.wrapper.GradleWrapperMain %*
</a><a href="#h108-0-74" id="h108-0-74" class="i">+
</a><a href="#h108-0-75" id="h108-0-75" class="i">+:end
</a><a href="#h108-0-76" id="h108-0-76" class="i">+@rem End local scope for the variables with windows NT shell
</a><a href="#h108-0-77" id="h108-0-77" class="i">+if &quot;%ERRORLEVEL%&quot;==&quot;0&quot; goto mainEnd
</a><a href="#h108-0-78" id="h108-0-78" class="i">+
</a><a href="#h108-0-79" id="h108-0-79" class="i">+:fail
</a><a href="#h108-0-80" id="h108-0-80" class="i">+rem Set variable GRADLE_EXIT_CONSOLE if you need the _script_ return code instead of
</a><a href="#h108-0-81" id="h108-0-81" class="i">+rem the _cmd.exe /c_ return code!
</a><a href="#h108-0-82" id="h108-0-82" class="i">+if  not &quot;&quot; == &quot;%GRADLE_EXIT_CONSOLE%&quot; exit 1
</a><a href="#h108-0-83" id="h108-0-83" class="i">+exit /b 1
</a><a href="#h108-0-84" id="h108-0-84" class="i">+
</a><a href="#h108-0-85" id="h108-0-85" class="i">+:mainEnd
</a><a href="#h108-0-86" id="h108-0-86" class="i">+if &quot;%OS%&quot;==&quot;Windows_NT&quot; endlocal
</a><a href="#h108-0-87" id="h108-0-87" class="i">+
</a><a href="#h108-0-88" id="h108-0-88" class="i">+:omega
</a><b>diff --git a/<a id="h109" href="../file/settings.gradle.html">settings.gradle</a> b/<a href="../file/settings.gradle.html">settings.gradle</a></b>
<a href="#h109-0" id="h109-0" class="h">@@ -0,0 +1,16 @@
</a><a href="#h109-0-0" id="h109-0-0" class="i">+pluginManagement {
</a><a href="#h109-0-1" id="h109-0-1" class="i">+    repositories {
</a><a href="#h109-0-2" id="h109-0-2" class="i">+        gradlePluginPortal()
</a><a href="#h109-0-3" id="h109-0-3" class="i">+        google()
</a><a href="#h109-0-4" id="h109-0-4" class="i">+        mavenCentral()
</a><a href="#h109-0-5" id="h109-0-5" class="i">+    }
</a><a href="#h109-0-6" id="h109-0-6" class="i">+}
</a><a href="#h109-0-7" id="h109-0-7" class="i">+dependencyResolutionManagement {
</a><a href="#h109-0-8" id="h109-0-8" class="i">+    repositoriesMode.set(RepositoriesMode.FAIL_ON_PROJECT_REPOS)
</a><a href="#h109-0-9" id="h109-0-9" class="i">+    repositories {
</a><a href="#h109-0-10" id="h109-0-10" class="i">+        google()
</a><a href="#h109-0-11" id="h109-0-11" class="i">+        mavenCentral()
</a><a href="#h109-0-12" id="h109-0-12" class="i">+    }
</a><a href="#h109-0-13" id="h109-0-13" class="i">+}
</a><a href="#h109-0-14" id="h109-0-14" class="i">+rootProject.name = &quot;SnapEnhance&quot;
</a><a href="#h109-0-15" id="h109-0-15" class="i">+include &#39;:app&#39;
</a></pre>
</div>
</body>
</html>
