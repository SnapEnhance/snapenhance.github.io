<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>feat(ui): setup activity - remote side context - fix float dialogs - fix choose folder - SnapEnhance - An Xposed module offering an enhanced Snapchat experience
</title>
<link rel="icon" type="image/svg+xml" href="../../logo.png"/>
<link rel="alternate icon" href="../../favicon.png"/>
<link rel="alternate" type="application/atom+xml" title="SnapEnhance Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="SnapEnhance Atom Feed (tags)" href="../tags.xml" />
<link rel="stylesheet" type="text/css" href="../../style.css" />
<link rel="stylesheet" type="text/css" href="../../fonts.css" />
</head>
<body>
<div id="head"><table><tr><td><a class="logo" href="../../"><img src="../../logo.png" alt="" width="32" height="32" /></a></td><td><strong>SnapEnhance</strong><span class="desc"> - An Xposed module offering an enhanced Snapchat experience
</span>
</td></tr></table>
<p><a href="../about.html">About</a> | <a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/LICENSE.html">License</a></p>
</div>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/641d66b208e67768e16beab0e54a84a332debcb3.html">641d66b208e67768e16beab0e54a84a332debcb3</a>
<b>parent</b> <a href="../commit/853ceec290c698ea7ba787abfb3e196832a575e5.html">853ceec290c698ea7ba787abfb3e196832a575e5</a>
<b>Author:</b> rhunk &lt;<a href="mailto:101876869+rhunk@users.noreply.github.com">101876869+rhunk@users.noreply.github.com</a>&gt;
<b>Date:</b>   Thu,  3 Aug 2023 21:48:23 +0200

feat(ui): setup activity
- remote side context
- fix float dialogs
- fix choose folder

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">app/build.gradle.kts</a></td><td> | </td><td class="num">2</td><td><span class="i">++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">app/src/main/AndroidManifest.xml</a></td><td> | </td><td class="num">3</td><td><span class="i">+</span><span class="d">--</span></td></tr>
<tr><td class="A">A</td><td><a href="#h2">app/src/main/kotlin/me/rhunk/snapenhance/RemoteSideContext.kt</a></td><td> | </td><td class="num">95</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h3">app/src/main/kotlin/me/rhunk/snapenhance/SharedContextHolder.kt</a></td><td> | </td><td class="num">16</td><td><span class="i">++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h4">app/src/main/kotlin/me/rhunk/snapenhance/bridge/BridgeService.kt</a></td><td> | </td><td class="num">114</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h5">app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadProcessor.kt</a></td><td> | </td><td class="num">385</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h6">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/MainActivity.kt</a></td><td> | </td><td class="num">36</td><td><span class="i">+++++++++++++++++++++</span><span class="d">---------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h7">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/ManagerContext.kt</a></td><td> | </td><td class="num">39</td><td><span class="i"></span><span class="d">---------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h8">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/Navigation.kt</a></td><td> | </td><td class="num">15</td><td><span class="i">+++</span><span class="d">------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h9">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/Section.kt</a></td><td> | </td><td class="num">5</td><td><span class="i">++++</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h10">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/HomeSection.kt</a></td><td> | </td><td class="num">7</td><td><span class="i">+++++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h11">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/features/Dialogs.kt</a></td><td> | </td><td class="num">22</td><td><span class="i">+++++++++++++++</span><span class="d">-------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h12">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/features/FeaturesSection.kt</a></td><td> | </td><td class="num">35</td><td><span class="i">++++++++++++++++++++++++++++++</span><span class="d">-----</span></td></tr>
<tr><td class="D">D</td><td><a href="#h13">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/util/SaveFolderChecker.kt</a></td><td> | </td><td class="num">43</td><td><span class="i"></span><span class="d">-------------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h14">app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/Requirements.kt</a></td><td> | </td><td class="num">42</td><td><span class="i">+++++++++++++++</span><span class="d">---------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h15">app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/SetupActivity.kt</a></td><td> | </td><td class="num">53</td><td><span class="i">++++++++++++++++++++++++++++++++++++++</span><span class="d">---------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h16">app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/SetupContext.kt</a></td><td> | </td><td class="num">15</td><td><span class="i"></span><span class="d">---------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h17">app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/screens/SetupScreen.kt</a></td><td> | </td><td class="num">20</td><td><span class="i">++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="D">D</td><td><a href="#h18">app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/screens/impl/LanguageScreen.kt</a></td><td> | </td><td class="num">12</td><td><span class="i"></span><span class="d">------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h19">app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/screens/impl/MappingsScreen.kt</a></td><td> | </td><td class="num">88</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">---</span></td></tr>
<tr><td class="A">A</td><td><a href="#h20">app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/screens/impl/PickLanguageScreen.kt</a></td><td> | </td><td class="num">116</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h21">app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/screens/impl/SaveFolderScreen.kt</a></td><td> | </td><td class="num">36</td><td><span class="i">+++++++++++++++++++++++++++++++++</span><span class="d">---</span></td></tr>
<tr><td class="A">A</td><td><a href="#h22">app/src/main/kotlin/me/rhunk/snapenhance/ui/util/ChooseFolderHelper.kt</a></td><td> | </td><td class="num">27</td><td><span class="i">+++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h23">app/src/main/kotlin/me/rhunk/snapenhance/ui/util/ObservableMutableState.kt</a></td><td> | </td><td class="num">20</td><td><span class="i">++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h24">core/src/main/aidl/me/rhunk/snapenhance/bridge/BridgeInterface.aidl</a></td><td> | </td><td class="num">6</td><td><span class="i">+++</span><span class="d">---</span></td></tr>
<tr><td class="M">M</td><td><a href="#h25">core/src/main/assets/lang/en_US.json</a></td><td> | </td><td class="num">17</td><td><span class="i">+++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h26">core/src/main/assets/lang/fr_FR.json</a></td><td> | </td><td class="num">8</td><td><span class="i">++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h27">core/src/main/kotlin/me/rhunk/snapenhance/Logger.kt</a></td><td> | </td><td class="num">5</td><td><span class="i">+++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h28">core/src/main/kotlin/me/rhunk/snapenhance/ModContext.kt</a></td><td> | </td><td class="num">4</td><td><span class="i">++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h29">core/src/main/kotlin/me/rhunk/snapenhance/SnapEnhance.kt</a></td><td> | </td><td class="num">10</td><td><span class="i">+++++</span><span class="d">-----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h30">core/src/main/kotlin/me/rhunk/snapenhance/bridge/BridgeClient.kt</a></td><td> | </td><td class="num">5</td><td><span class="i">+++</span><span class="d">--</span></td></tr>
<tr><td class="D">D</td><td><a href="#h31">core/src/main/kotlin/me/rhunk/snapenhance/bridge/BridgeService.kt</a></td><td> | </td><td class="num">105</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h32">core/src/main/kotlin/me/rhunk/snapenhance/bridge/wrapper/LocaleWrapper.kt</a></td><td> | </td><td class="num">38</td><td><span class="i">++++++++++++++++++++++++</span><span class="d">--------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h33">core/src/main/kotlin/me/rhunk/snapenhance/bridge/wrapper/MappingsWrapper.kt</a></td><td> | </td><td class="num">5</td><td><span class="i">+++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h34">core/src/main/kotlin/me/rhunk/snapenhance/core/config/ConfigContainer.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h35">core/src/main/kotlin/me/rhunk/snapenhance/core/config/ModConfig.kt</a></td><td> | </td><td class="num">13</td><td><span class="i">++++++</span><span class="d">-------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h36">core/src/main/kotlin/me/rhunk/snapenhance/download/DownloadManagerClient.kt</a></td><td> | </td><td class="num">9</td><td><span class="i">+++++++</span><span class="d">--</span></td></tr>
<tr><td class="D">D</td><td><a href="#h37">core/src/main/kotlin/me/rhunk/snapenhance/download/DownloadProcessor.kt</a></td><td> | </td><td class="num">387</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h38">core/src/main/kotlin/me/rhunk/snapenhance/features/FeatureLoadParams.kt</a></td><td> | </td><td class="num">8</td><td><span class="i">++++</span><span class="d">----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h39">core/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/FriendFeedInfoMenu.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h40">core/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/SettingsGearInjector.kt</a></td><td> | </td><td class="num">3</td><td><span class="i">+</span><span class="d">--</span></td></tr>
</table></pre><pre>41 files changed, 1137 insertions(+), 736 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/app/build.gradle.kts.html">app/build.gradle.kts</a> b/<a href="../file/app/build.gradle.kts.html">app/build.gradle.kts</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -85,6 +85,8 @@ dependencies {
</a>     implementation(libs.androidx.material)
     implementation(libs.androidx.activity.ktx)
     implementation(libs.androidx.navigation.compose)
<a href="#h0-0-3" id="h0-0-3" class="i">+    implementation(libs.androidx.documentfile)
</a><a href="#h0-0-4" id="h0-0-4" class="i">+    implementation(libs.gson)
</a> 
     debugImplementation(&quot;androidx.compose.ui:ui-tooling:1.4.3&quot;)
     debugImplementation(&quot;androidx.compose.ui:ui-tooling-preview:1.4.3&quot;)
<b>diff --git a/<a id="h1" href="../file/app/src/main/AndroidManifest.xml.html">app/src/main/AndroidManifest.xml</a> b/<a href="../file/app/src/main/AndroidManifest.xml.html">app/src/main/AndroidManifest.xml</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -50,8 +50,7 @@
</a>             android:name=&quot;.ui.setup.SetupActivity&quot;
             android:exported=&quot;true&quot;
             android:theme=&quot;@style/AppTheme&quot;
<a href="#h1-0-3" id="h1-0-3" class="d">-            android:excludeFromRecents=&quot;true&quot;&gt;
</a><a href="#h1-0-4" id="h1-0-4" class="d">-        &lt;/activity&gt;
</a><a href="#h1-0-5" id="h1-0-5" class="i">+            android:excludeFromRecents=&quot;true&quot; /&gt;
</a>         &lt;activity
             android:name=&quot;.ui.map.MapActivity&quot;
             android:exported=&quot;true&quot;
<b>diff --git a/<a id="h2" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/RemoteSideContext.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/RemoteSideContext.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/RemoteSideContext.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/RemoteSideContext.kt</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -0,0 +1,94 @@
</a><a href="#h2-0-0" id="h2-0-0" class="i">+package me.rhunk.snapenhance
</a><a href="#h2-0-1" id="h2-0-1" class="i">+
</a><a href="#h2-0-2" id="h2-0-2" class="i">+import android.app.Activity
</a><a href="#h2-0-3" id="h2-0-3" class="i">+import android.content.Context
</a><a href="#h2-0-4" id="h2-0-4" class="i">+import android.content.Intent
</a><a href="#h2-0-5" id="h2-0-5" class="i">+import android.net.Uri
</a><a href="#h2-0-6" id="h2-0-6" class="i">+import androidx.documentfile.provider.DocumentFile
</a><a href="#h2-0-7" id="h2-0-7" class="i">+import me.rhunk.snapenhance.bridge.wrapper.LocaleWrapper
</a><a href="#h2-0-8" id="h2-0-8" class="i">+import me.rhunk.snapenhance.bridge.wrapper.MappingsWrapper
</a><a href="#h2-0-9" id="h2-0-9" class="i">+import me.rhunk.snapenhance.core.config.ModConfig
</a><a href="#h2-0-10" id="h2-0-10" class="i">+import me.rhunk.snapenhance.ui.manager.data.InstallationSummary
</a><a href="#h2-0-11" id="h2-0-11" class="i">+import me.rhunk.snapenhance.ui.manager.data.ModMappingsInfo
</a><a href="#h2-0-12" id="h2-0-12" class="i">+import me.rhunk.snapenhance.ui.manager.data.SnapchatAppInfo
</a><a href="#h2-0-13" id="h2-0-13" class="i">+import me.rhunk.snapenhance.ui.setup.Requirements
</a><a href="#h2-0-14" id="h2-0-14" class="i">+import me.rhunk.snapenhance.ui.setup.SetupActivity
</a><a href="#h2-0-15" id="h2-0-15" class="i">+import java.lang.ref.WeakReference
</a><a href="#h2-0-16" id="h2-0-16" class="i">+import kotlin.system.exitProcess
</a><a href="#h2-0-17" id="h2-0-17" class="i">+
</a><a href="#h2-0-18" id="h2-0-18" class="i">+class RemoteSideContext(
</a><a href="#h2-0-19" id="h2-0-19" class="i">+    val androidContext: Context
</a><a href="#h2-0-20" id="h2-0-20" class="i">+) {
</a><a href="#h2-0-21" id="h2-0-21" class="i">+    private var _activity: WeakReference&lt;Activity&gt;? = null
</a><a href="#h2-0-22" id="h2-0-22" class="i">+    var activity: Activity?
</a><a href="#h2-0-23" id="h2-0-23" class="i">+        get() = _activity?.get()
</a><a href="#h2-0-24" id="h2-0-24" class="i">+        set(value) { _activity = WeakReference(value) }
</a><a href="#h2-0-25" id="h2-0-25" class="i">+
</a><a href="#h2-0-26" id="h2-0-26" class="i">+    val config = ModConfig()
</a><a href="#h2-0-27" id="h2-0-27" class="i">+    val translation = LocaleWrapper()
</a><a href="#h2-0-28" id="h2-0-28" class="i">+    val mappings = MappingsWrapper(androidContext)
</a><a href="#h2-0-29" id="h2-0-29" class="i">+
</a><a href="#h2-0-30" id="h2-0-30" class="i">+    init {
</a><a href="#h2-0-31" id="h2-0-31" class="i">+        config.loadFromContext(androidContext)
</a><a href="#h2-0-32" id="h2-0-32" class="i">+        translation.userLocale = config.locale
</a><a href="#h2-0-33" id="h2-0-33" class="i">+        translation.loadFromContext(androidContext)
</a><a href="#h2-0-34" id="h2-0-34" class="i">+        mappings.apply {
</a><a href="#h2-0-35" id="h2-0-35" class="i">+            loadFromContext(androidContext)
</a><a href="#h2-0-36" id="h2-0-36" class="i">+            init()
</a><a href="#h2-0-37" id="h2-0-37" class="i">+        }
</a><a href="#h2-0-38" id="h2-0-38" class="i">+    }
</a><a href="#h2-0-39" id="h2-0-39" class="i">+
</a><a href="#h2-0-40" id="h2-0-40" class="i">+    fun getInstallationSummary() = InstallationSummary(
</a><a href="#h2-0-41" id="h2-0-41" class="i">+        snapchatInfo = mappings.getSnapchatPackageInfo()?.let {
</a><a href="#h2-0-42" id="h2-0-42" class="i">+            SnapchatAppInfo(
</a><a href="#h2-0-43" id="h2-0-43" class="i">+                version = it.versionName,
</a><a href="#h2-0-44" id="h2-0-44" class="i">+                versionCode = it.longVersionCode
</a><a href="#h2-0-45" id="h2-0-45" class="i">+            )
</a><a href="#h2-0-46" id="h2-0-46" class="i">+        },
</a><a href="#h2-0-47" id="h2-0-47" class="i">+        mappingsInfo = if (mappings.isMappingsLoaded()) {
</a><a href="#h2-0-48" id="h2-0-48" class="i">+            ModMappingsInfo(
</a><a href="#h2-0-49" id="h2-0-49" class="i">+                generatedSnapchatVersion = mappings.getGeneratedBuildNumber(),
</a><a href="#h2-0-50" id="h2-0-50" class="i">+                isOutdated = mappings.isMappingsOutdated()
</a><a href="#h2-0-51" id="h2-0-51" class="i">+            )
</a><a href="#h2-0-52" id="h2-0-52" class="i">+        } else null
</a><a href="#h2-0-53" id="h2-0-53" class="i">+    )
</a><a href="#h2-0-54" id="h2-0-54" class="i">+
</a><a href="#h2-0-55" id="h2-0-55" class="i">+    fun checkForRequirements(overrideRequirements: Int? = null) {
</a><a href="#h2-0-56" id="h2-0-56" class="i">+        var requirements = overrideRequirements ?: 0
</a><a href="#h2-0-57" id="h2-0-57" class="i">+
</a><a href="#h2-0-58" id="h2-0-58" class="i">+        if (!config.wasPresent) {
</a><a href="#h2-0-59" id="h2-0-59" class="i">+            requirements = requirements or Requirements.FIRST_RUN
</a><a href="#h2-0-60" id="h2-0-60" class="i">+        }
</a><a href="#h2-0-61" id="h2-0-61" class="i">+
</a><a href="#h2-0-62" id="h2-0-62" class="i">+        config.root.downloader.saveFolder.get().let {
</a><a href="#h2-0-63" id="h2-0-63" class="i">+            if (it.isEmpty() || run {
</a><a href="#h2-0-64" id="h2-0-64" class="i">+                    val documentFile = runCatching { DocumentFile.fromTreeUri(androidContext, Uri.parse(it)) }.getOrNull()
</a><a href="#h2-0-65" id="h2-0-65" class="i">+                    documentFile == null || !documentFile.exists() || !documentFile.canWrite()
</a><a href="#h2-0-66" id="h2-0-66" class="i">+                }) {
</a><a href="#h2-0-67" id="h2-0-67" class="i">+                requirements = requirements or Requirements.SAVE_FOLDER
</a><a href="#h2-0-68" id="h2-0-68" class="i">+            }
</a><a href="#h2-0-69" id="h2-0-69" class="i">+        }
</a><a href="#h2-0-70" id="h2-0-70" class="i">+
</a><a href="#h2-0-71" id="h2-0-71" class="i">+        if (mappings.isMappingsOutdated() || !mappings.isMappingsLoaded()) {
</a><a href="#h2-0-72" id="h2-0-72" class="i">+            requirements = requirements or Requirements.MAPPINGS
</a><a href="#h2-0-73" id="h2-0-73" class="i">+        }
</a><a href="#h2-0-74" id="h2-0-74" class="i">+
</a><a href="#h2-0-75" id="h2-0-75" class="i">+        if (requirements == 0) return
</a><a href="#h2-0-76" id="h2-0-76" class="i">+
</a><a href="#h2-0-77" id="h2-0-77" class="i">+        val currentContext = activity ?: androidContext
</a><a href="#h2-0-78" id="h2-0-78" class="i">+
</a><a href="#h2-0-79" id="h2-0-79" class="i">+        Intent(currentContext, SetupActivity::class.java).apply {
</a><a href="#h2-0-80" id="h2-0-80" class="i">+            putExtra(&quot;requirements&quot;, requirements)
</a><a href="#h2-0-81" id="h2-0-81" class="i">+            if (currentContext !is Activity) {
</a><a href="#h2-0-82" id="h2-0-82" class="i">+                addFlags(Intent.FLAG_ACTIVITY_NEW_TASK)
</a><a href="#h2-0-83" id="h2-0-83" class="i">+                currentContext.startActivity(this)
</a><a href="#h2-0-84" id="h2-0-84" class="i">+                return@apply
</a><a href="#h2-0-85" id="h2-0-85" class="i">+            }
</a><a href="#h2-0-86" id="h2-0-86" class="i">+            currentContext.startActivityForResult(this, 22)
</a><a href="#h2-0-87" id="h2-0-87" class="i">+        }
</a><a href="#h2-0-88" id="h2-0-88" class="i">+
</a><a href="#h2-0-89" id="h2-0-89" class="i">+        if (currentContext !is Activity) {
</a><a href="#h2-0-90" id="h2-0-90" class="i">+            exitProcess(0)
</a><a href="#h2-0-91" id="h2-0-91" class="i">+        }
</a><a href="#h2-0-92" id="h2-0-92" class="i">+    }
</a><a href="#h2-0-93" id="h2-0-93" class="i">+}</a><a href="#h2-0-94" id="h2-0-94" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h3" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/SharedContextHolder.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/SharedContextHolder.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/SharedContextHolder.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/SharedContextHolder.kt</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -0,0 +1,15 @@
</a><a href="#h3-0-0" id="h3-0-0" class="i">+package me.rhunk.snapenhance
</a><a href="#h3-0-1" id="h3-0-1" class="i">+
</a><a href="#h3-0-2" id="h3-0-2" class="i">+import android.content.Context
</a><a href="#h3-0-3" id="h3-0-3" class="i">+import java.lang.ref.WeakReference
</a><a href="#h3-0-4" id="h3-0-4" class="i">+
</a><a href="#h3-0-5" id="h3-0-5" class="i">+object SharedContextHolder {
</a><a href="#h3-0-6" id="h3-0-6" class="i">+    private lateinit var _remoteSideContext: WeakReference&lt;RemoteSideContext&gt;
</a><a href="#h3-0-7" id="h3-0-7" class="i">+
</a><a href="#h3-0-8" id="h3-0-8" class="i">+    fun remote(context: Context): RemoteSideContext {
</a><a href="#h3-0-9" id="h3-0-9" class="i">+        if (!::_remoteSideContext.isInitialized || _remoteSideContext.get() == null) {
</a><a href="#h3-0-10" id="h3-0-10" class="i">+            _remoteSideContext = WeakReference(RemoteSideContext(context.applicationContext))
</a><a href="#h3-0-11" id="h3-0-11" class="i">+        }
</a><a href="#h3-0-12" id="h3-0-12" class="i">+        return _remoteSideContext.get()!!
</a><a href="#h3-0-13" id="h3-0-13" class="i">+    }
</a><a href="#h3-0-14" id="h3-0-14" class="i">+}</a><a href="#h3-0-15" id="h3-0-15" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h4" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/BridgeService.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/BridgeService.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/BridgeService.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/BridgeService.kt</a></b>
<a href="#h4-0" id="h4-0" class="h">@@ -0,0 +1,114 @@
</a><a href="#h4-0-0" id="h4-0-0" class="i">+package me.rhunk.snapenhance.bridge
</a><a href="#h4-0-1" id="h4-0-1" class="i">+
</a><a href="#h4-0-2" id="h4-0-2" class="i">+import android.app.Service
</a><a href="#h4-0-3" id="h4-0-3" class="i">+import android.content.Intent
</a><a href="#h4-0-4" id="h4-0-4" class="i">+import android.os.IBinder
</a><a href="#h4-0-5" id="h4-0-5" class="i">+import me.rhunk.snapenhance.RemoteSideContext
</a><a href="#h4-0-6" id="h4-0-6" class="i">+import me.rhunk.snapenhance.SharedContext
</a><a href="#h4-0-7" id="h4-0-7" class="i">+import me.rhunk.snapenhance.SharedContextHolder
</a><a href="#h4-0-8" id="h4-0-8" class="i">+import me.rhunk.snapenhance.bridge.types.BridgeFileType
</a><a href="#h4-0-9" id="h4-0-9" class="i">+import me.rhunk.snapenhance.bridge.wrapper.MessageLoggerWrapper
</a><a href="#h4-0-10" id="h4-0-10" class="i">+import me.rhunk.snapenhance.bridge.wrapper.LocaleWrapper
</a><a href="#h4-0-11" id="h4-0-11" class="i">+import me.rhunk.snapenhance.download.DownloadProcessor
</a><a href="#h4-0-12" id="h4-0-12" class="i">+
</a><a href="#h4-0-13" id="h4-0-13" class="i">+class BridgeService : Service() {
</a><a href="#h4-0-14" id="h4-0-14" class="i">+    private lateinit var messageLoggerWrapper: MessageLoggerWrapper
</a><a href="#h4-0-15" id="h4-0-15" class="i">+    private lateinit var remoteSideContext: RemoteSideContext
</a><a href="#h4-0-16" id="h4-0-16" class="i">+
</a><a href="#h4-0-17" id="h4-0-17" class="i">+    override fun onBind(intent: Intent): IBinder {
</a><a href="#h4-0-18" id="h4-0-18" class="i">+        remoteSideContext = SharedContextHolder.remote(this).apply {
</a><a href="#h4-0-19" id="h4-0-19" class="i">+            checkForRequirements()
</a><a href="#h4-0-20" id="h4-0-20" class="i">+        }
</a><a href="#h4-0-21" id="h4-0-21" class="i">+        messageLoggerWrapper = MessageLoggerWrapper(getDatabasePath(BridgeFileType.MESSAGE_LOGGER_DATABASE.fileName)).also { it.init() }
</a><a href="#h4-0-22" id="h4-0-22" class="i">+        return BridgeBinder()
</a><a href="#h4-0-23" id="h4-0-23" class="i">+    }
</a><a href="#h4-0-24" id="h4-0-24" class="i">+
</a><a href="#h4-0-25" id="h4-0-25" class="i">+    inner class BridgeBinder : BridgeInterface.Stub() {
</a><a href="#h4-0-26" id="h4-0-26" class="i">+        override fun createAndReadFile(fileType: Int, defaultContent: ByteArray?): ByteArray {
</a><a href="#h4-0-27" id="h4-0-27" class="i">+            val file = BridgeFileType.fromValue(fileType)?.resolve(this@BridgeService)
</a><a href="#h4-0-28" id="h4-0-28" class="i">+                ?: return defaultContent ?: ByteArray(0)
</a><a href="#h4-0-29" id="h4-0-29" class="i">+
</a><a href="#h4-0-30" id="h4-0-30" class="i">+            if (!file.exists()) {
</a><a href="#h4-0-31" id="h4-0-31" class="i">+                if (defaultContent == null) {
</a><a href="#h4-0-32" id="h4-0-32" class="i">+                    return ByteArray(0)
</a><a href="#h4-0-33" id="h4-0-33" class="i">+                }
</a><a href="#h4-0-34" id="h4-0-34" class="i">+
</a><a href="#h4-0-35" id="h4-0-35" class="i">+                file.writeBytes(defaultContent)
</a><a href="#h4-0-36" id="h4-0-36" class="i">+            }
</a><a href="#h4-0-37" id="h4-0-37" class="i">+
</a><a href="#h4-0-38" id="h4-0-38" class="i">+            return file.readBytes()
</a><a href="#h4-0-39" id="h4-0-39" class="i">+        }
</a><a href="#h4-0-40" id="h4-0-40" class="i">+
</a><a href="#h4-0-41" id="h4-0-41" class="i">+        override fun readFile(fileType: Int): ByteArray {
</a><a href="#h4-0-42" id="h4-0-42" class="i">+            val file = BridgeFileType.fromValue(fileType)?.resolve(this@BridgeService)
</a><a href="#h4-0-43" id="h4-0-43" class="i">+                ?: return ByteArray(0)
</a><a href="#h4-0-44" id="h4-0-44" class="i">+
</a><a href="#h4-0-45" id="h4-0-45" class="i">+            if (!file.exists()) {
</a><a href="#h4-0-46" id="h4-0-46" class="i">+                return ByteArray(0)
</a><a href="#h4-0-47" id="h4-0-47" class="i">+            }
</a><a href="#h4-0-48" id="h4-0-48" class="i">+
</a><a href="#h4-0-49" id="h4-0-49" class="i">+            return file.readBytes()
</a><a href="#h4-0-50" id="h4-0-50" class="i">+        }
</a><a href="#h4-0-51" id="h4-0-51" class="i">+
</a><a href="#h4-0-52" id="h4-0-52" class="i">+        override fun writeFile(fileType: Int, content: ByteArray?): Boolean {
</a><a href="#h4-0-53" id="h4-0-53" class="i">+            val file = BridgeFileType.fromValue(fileType)?.resolve(this@BridgeService)
</a><a href="#h4-0-54" id="h4-0-54" class="i">+                ?: return false
</a><a href="#h4-0-55" id="h4-0-55" class="i">+
</a><a href="#h4-0-56" id="h4-0-56" class="i">+            if (content == null) {
</a><a href="#h4-0-57" id="h4-0-57" class="i">+                return false
</a><a href="#h4-0-58" id="h4-0-58" class="i">+            }
</a><a href="#h4-0-59" id="h4-0-59" class="i">+
</a><a href="#h4-0-60" id="h4-0-60" class="i">+            file.writeBytes(content)
</a><a href="#h4-0-61" id="h4-0-61" class="i">+            return true
</a><a href="#h4-0-62" id="h4-0-62" class="i">+        }
</a><a href="#h4-0-63" id="h4-0-63" class="i">+
</a><a href="#h4-0-64" id="h4-0-64" class="i">+        override fun deleteFile(fileType: Int): Boolean {
</a><a href="#h4-0-65" id="h4-0-65" class="i">+            val file = BridgeFileType.fromValue(fileType)?.resolve(this@BridgeService)
</a><a href="#h4-0-66" id="h4-0-66" class="i">+                ?: return false
</a><a href="#h4-0-67" id="h4-0-67" class="i">+
</a><a href="#h4-0-68" id="h4-0-68" class="i">+            if (!file.exists()) {
</a><a href="#h4-0-69" id="h4-0-69" class="i">+                return false
</a><a href="#h4-0-70" id="h4-0-70" class="i">+            }
</a><a href="#h4-0-71" id="h4-0-71" class="i">+
</a><a href="#h4-0-72" id="h4-0-72" class="i">+            return file.delete()
</a><a href="#h4-0-73" id="h4-0-73" class="i">+        }
</a><a href="#h4-0-74" id="h4-0-74" class="i">+
</a><a href="#h4-0-75" id="h4-0-75" class="i">+        override fun isFileExists(fileType: Int): Boolean {
</a><a href="#h4-0-76" id="h4-0-76" class="i">+            val file = BridgeFileType.fromValue(fileType)?.resolve(this@BridgeService)
</a><a href="#h4-0-77" id="h4-0-77" class="i">+                ?: return false
</a><a href="#h4-0-78" id="h4-0-78" class="i">+
</a><a href="#h4-0-79" id="h4-0-79" class="i">+            return file.exists()
</a><a href="#h4-0-80" id="h4-0-80" class="i">+        }
</a><a href="#h4-0-81" id="h4-0-81" class="i">+
</a><a href="#h4-0-82" id="h4-0-82" class="i">+        override fun getLoggedMessageIds(conversationId: String, limit: Int) = messageLoggerWrapper.getMessageIds(conversationId, limit).toLongArray()
</a><a href="#h4-0-83" id="h4-0-83" class="i">+
</a><a href="#h4-0-84" id="h4-0-84" class="i">+        override fun getMessageLoggerMessage(conversationId: String, id: Long) = messageLoggerWrapper.getMessage(conversationId, id).second
</a><a href="#h4-0-85" id="h4-0-85" class="i">+
</a><a href="#h4-0-86" id="h4-0-86" class="i">+        override fun addMessageLoggerMessage(conversationId: String, id: Long, message: ByteArray) {
</a><a href="#h4-0-87" id="h4-0-87" class="i">+            messageLoggerWrapper.addMessage(conversationId, id, message)
</a><a href="#h4-0-88" id="h4-0-88" class="i">+        }
</a><a href="#h4-0-89" id="h4-0-89" class="i">+
</a><a href="#h4-0-90" id="h4-0-90" class="i">+        override fun deleteMessageLoggerMessage(conversationId: String, id: Long) = messageLoggerWrapper.deleteMessage(conversationId, id)
</a><a href="#h4-0-91" id="h4-0-91" class="i">+
</a><a href="#h4-0-92" id="h4-0-92" class="i">+        override fun clearMessageLogger() = messageLoggerWrapper.clearMessages()
</a><a href="#h4-0-93" id="h4-0-93" class="i">+
</a><a href="#h4-0-94" id="h4-0-94" class="i">+        override fun fetchLocales(userLocale: String) = LocaleWrapper.fetchLocales(context = this@BridgeService, userLocale).associate {
</a><a href="#h4-0-95" id="h4-0-95" class="i">+            it.locale to it.content
</a><a href="#h4-0-96" id="h4-0-96" class="i">+        }
</a><a href="#h4-0-97" id="h4-0-97" class="i">+
</a><a href="#h4-0-98" id="h4-0-98" class="i">+        override fun getAutoUpdaterTime(): Long {
</a><a href="#h4-0-99" id="h4-0-99" class="i">+            throw UnsupportedOperationException()
</a><a href="#h4-0-100" id="h4-0-100" class="i">+        }
</a><a href="#h4-0-101" id="h4-0-101" class="i">+
</a><a href="#h4-0-102" id="h4-0-102" class="i">+        override fun setAutoUpdaterTime(time: Long) {
</a><a href="#h4-0-103" id="h4-0-103" class="i">+            throw UnsupportedOperationException()
</a><a href="#h4-0-104" id="h4-0-104" class="i">+        }
</a><a href="#h4-0-105" id="h4-0-105" class="i">+
</a><a href="#h4-0-106" id="h4-0-106" class="i">+        override fun enqueueDownload(intent: Intent, callback: DownloadCallback) {
</a><a href="#h4-0-107" id="h4-0-107" class="i">+            SharedContextHolder.remote(this@BridgeService)
</a><a href="#h4-0-108" id="h4-0-108" class="i">+            //TODO: refactor shared context
</a><a href="#h4-0-109" id="h4-0-109" class="i">+            SharedContext.ensureInitialized(this@BridgeService)
</a><a href="#h4-0-110" id="h4-0-110" class="i">+            DownloadProcessor(this@BridgeService, callback).onReceive(intent)
</a><a href="#h4-0-111" id="h4-0-111" class="i">+        }
</a><a href="#h4-0-112" id="h4-0-112" class="i">+    }
</a><a href="#h4-0-113" id="h4-0-113" class="i">+}
</a><b>diff --git a/<a id="h5" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadProcessor.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadProcessor.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadProcessor.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadProcessor.kt</a></b>
<a href="#h5-0" id="h5-0" class="h">@@ -0,0 +1,384 @@
</a><a href="#h5-0-0" id="h5-0-0" class="i">+package me.rhunk.snapenhance.download
</a><a href="#h5-0-1" id="h5-0-1" class="i">+
</a><a href="#h5-0-2" id="h5-0-2" class="i">+import android.annotation.SuppressLint
</a><a href="#h5-0-3" id="h5-0-3" class="i">+import android.content.Context
</a><a href="#h5-0-4" id="h5-0-4" class="i">+import android.content.Intent
</a><a href="#h5-0-5" id="h5-0-5" class="i">+import android.net.Uri
</a><a href="#h5-0-6" id="h5-0-6" class="i">+import android.widget.Toast
</a><a href="#h5-0-7" id="h5-0-7" class="i">+import androidx.documentfile.provider.DocumentFile
</a><a href="#h5-0-8" id="h5-0-8" class="i">+import com.google.gson.GsonBuilder
</a><a href="#h5-0-9" id="h5-0-9" class="i">+import kotlinx.coroutines.CoroutineScope
</a><a href="#h5-0-10" id="h5-0-10" class="i">+import kotlinx.coroutines.Dispatchers
</a><a href="#h5-0-11" id="h5-0-11" class="i">+import kotlinx.coroutines.Job
</a><a href="#h5-0-12" id="h5-0-12" class="i">+import kotlinx.coroutines.job
</a><a href="#h5-0-13" id="h5-0-13" class="i">+import kotlinx.coroutines.joinAll
</a><a href="#h5-0-14" id="h5-0-14" class="i">+import kotlinx.coroutines.launch
</a><a href="#h5-0-15" id="h5-0-15" class="i">+import kotlinx.coroutines.runBlocking
</a><a href="#h5-0-16" id="h5-0-16" class="i">+import me.rhunk.snapenhance.Constants
</a><a href="#h5-0-17" id="h5-0-17" class="i">+import me.rhunk.snapenhance.Logger
</a><a href="#h5-0-18" id="h5-0-18" class="i">+import me.rhunk.snapenhance.SharedContext
</a><a href="#h5-0-19" id="h5-0-19" class="i">+import me.rhunk.snapenhance.bridge.DownloadCallback
</a><a href="#h5-0-20" id="h5-0-20" class="i">+import me.rhunk.snapenhance.core.config.ModConfig
</a><a href="#h5-0-21" id="h5-0-21" class="i">+import me.rhunk.snapenhance.data.FileType
</a><a href="#h5-0-22" id="h5-0-22" class="i">+import me.rhunk.snapenhance.download.data.DownloadMetadata
</a><a href="#h5-0-23" id="h5-0-23" class="i">+import me.rhunk.snapenhance.download.data.DownloadRequest
</a><a href="#h5-0-24" id="h5-0-24" class="i">+import me.rhunk.snapenhance.download.data.InputMedia
</a><a href="#h5-0-25" id="h5-0-25" class="i">+import me.rhunk.snapenhance.download.data.MediaEncryptionKeyPair
</a><a href="#h5-0-26" id="h5-0-26" class="i">+import me.rhunk.snapenhance.download.data.PendingDownload
</a><a href="#h5-0-27" id="h5-0-27" class="i">+import me.rhunk.snapenhance.download.enums.DownloadMediaType
</a><a href="#h5-0-28" id="h5-0-28" class="i">+import me.rhunk.snapenhance.download.enums.DownloadStage
</a><a href="#h5-0-29" id="h5-0-29" class="i">+import me.rhunk.snapenhance.util.download.RemoteMediaResolver
</a><a href="#h5-0-30" id="h5-0-30" class="i">+import me.rhunk.snapenhance.util.snap.MediaDownloaderHelper
</a><a href="#h5-0-31" id="h5-0-31" class="i">+import java.io.File
</a><a href="#h5-0-32" id="h5-0-32" class="i">+import java.io.InputStream
</a><a href="#h5-0-33" id="h5-0-33" class="i">+import java.net.HttpURLConnection
</a><a href="#h5-0-34" id="h5-0-34" class="i">+import java.net.URL
</a><a href="#h5-0-35" id="h5-0-35" class="i">+import java.util.zip.ZipInputStream
</a><a href="#h5-0-36" id="h5-0-36" class="i">+import javax.crypto.Cipher
</a><a href="#h5-0-37" id="h5-0-37" class="i">+import javax.crypto.CipherInputStream
</a><a href="#h5-0-38" id="h5-0-38" class="i">+import javax.crypto.spec.IvParameterSpec
</a><a href="#h5-0-39" id="h5-0-39" class="i">+import javax.crypto.spec.SecretKeySpec
</a><a href="#h5-0-40" id="h5-0-40" class="i">+import javax.xml.parsers.DocumentBuilderFactory
</a><a href="#h5-0-41" id="h5-0-41" class="i">+import javax.xml.transform.TransformerFactory
</a><a href="#h5-0-42" id="h5-0-42" class="i">+import javax.xml.transform.dom.DOMSource
</a><a href="#h5-0-43" id="h5-0-43" class="i">+import javax.xml.transform.stream.StreamResult
</a><a href="#h5-0-44" id="h5-0-44" class="i">+import kotlin.coroutines.coroutineContext
</a><a href="#h5-0-45" id="h5-0-45" class="i">+import kotlin.io.encoding.Base64
</a><a href="#h5-0-46" id="h5-0-46" class="i">+import kotlin.io.encoding.ExperimentalEncodingApi
</a><a href="#h5-0-47" id="h5-0-47" class="i">+
</a><a href="#h5-0-48" id="h5-0-48" class="i">+data class DownloadedFile(
</a><a href="#h5-0-49" id="h5-0-49" class="i">+    val file: File,
</a><a href="#h5-0-50" id="h5-0-50" class="i">+    val fileType: FileType
</a><a href="#h5-0-51" id="h5-0-51" class="i">+)
</a><a href="#h5-0-52" id="h5-0-52" class="i">+
</a><a href="#h5-0-53" id="h5-0-53" class="i">+/**
</a><a href="#h5-0-54" id="h5-0-54" class="i">+ * DownloadProcessor handles the download requests of the user
</a><a href="#h5-0-55" id="h5-0-55" class="i">+ */
</a><a href="#h5-0-56" id="h5-0-56" class="i">+@OptIn(ExperimentalEncodingApi::class)
</a><a href="#h5-0-57" id="h5-0-57" class="i">+class DownloadProcessor (
</a><a href="#h5-0-58" id="h5-0-58" class="i">+    private val context: Context,
</a><a href="#h5-0-59" id="h5-0-59" class="i">+    private val callback: DownloadCallback
</a><a href="#h5-0-60" id="h5-0-60" class="i">+) {
</a><a href="#h5-0-61" id="h5-0-61" class="i">+
</a><a href="#h5-0-62" id="h5-0-62" class="i">+    private val translation by lazy {
</a><a href="#h5-0-63" id="h5-0-63" class="i">+        SharedContext.translation.getCategory(&quot;download_processor&quot;)
</a><a href="#h5-0-64" id="h5-0-64" class="i">+    }
</a><a href="#h5-0-65" id="h5-0-65" class="i">+
</a><a href="#h5-0-66" id="h5-0-66" class="i">+    private val gson by lazy {
</a><a href="#h5-0-67" id="h5-0-67" class="i">+        GsonBuilder().setPrettyPrinting().create()
</a><a href="#h5-0-68" id="h5-0-68" class="i">+    }
</a><a href="#h5-0-69" id="h5-0-69" class="i">+
</a><a href="#h5-0-70" id="h5-0-70" class="i">+    private fun fallbackToast(message: Any) {
</a><a href="#h5-0-71" id="h5-0-71" class="i">+        android.os.Handler(context.mainLooper).post {
</a><a href="#h5-0-72" id="h5-0-72" class="i">+            Toast.makeText(context, message.toString(), Toast.LENGTH_SHORT).show()
</a><a href="#h5-0-73" id="h5-0-73" class="i">+        }
</a><a href="#h5-0-74" id="h5-0-74" class="i">+    }
</a><a href="#h5-0-75" id="h5-0-75" class="i">+
</a><a href="#h5-0-76" id="h5-0-76" class="i">+    private fun extractZip(inputStream: InputStream): List&lt;File&gt; {
</a><a href="#h5-0-77" id="h5-0-77" class="i">+        val files = mutableListOf&lt;File&gt;()
</a><a href="#h5-0-78" id="h5-0-78" class="i">+        val zipInputStream = ZipInputStream(inputStream)
</a><a href="#h5-0-79" id="h5-0-79" class="i">+        var entry = zipInputStream.nextEntry
</a><a href="#h5-0-80" id="h5-0-80" class="i">+
</a><a href="#h5-0-81" id="h5-0-81" class="i">+        while (entry != null) {
</a><a href="#h5-0-82" id="h5-0-82" class="i">+            createMediaTempFile().also { file -&gt;
</a><a href="#h5-0-83" id="h5-0-83" class="i">+                file.outputStream().use { outputStream -&gt;
</a><a href="#h5-0-84" id="h5-0-84" class="i">+                    zipInputStream.copyTo(outputStream)
</a><a href="#h5-0-85" id="h5-0-85" class="i">+                }
</a><a href="#h5-0-86" id="h5-0-86" class="i">+                files += file
</a><a href="#h5-0-87" id="h5-0-87" class="i">+            }
</a><a href="#h5-0-88" id="h5-0-88" class="i">+            entry = zipInputStream.nextEntry
</a><a href="#h5-0-89" id="h5-0-89" class="i">+        }
</a><a href="#h5-0-90" id="h5-0-90" class="i">+
</a><a href="#h5-0-91" id="h5-0-91" class="i">+        return files
</a><a href="#h5-0-92" id="h5-0-92" class="i">+    }
</a><a href="#h5-0-93" id="h5-0-93" class="i">+
</a><a href="#h5-0-94" id="h5-0-94" class="i">+    private fun decryptInputStream(inputStream: InputStream, encryption: MediaEncryptionKeyPair): InputStream {
</a><a href="#h5-0-95" id="h5-0-95" class="i">+        val cipher = Cipher.getInstance(&quot;AES/CBC/PKCS5Padding&quot;)
</a><a href="#h5-0-96" id="h5-0-96" class="i">+        val key = Base64.UrlSafe.decode(encryption.key)
</a><a href="#h5-0-97" id="h5-0-97" class="i">+        val iv = Base64.UrlSafe.decode(encryption.iv)
</a><a href="#h5-0-98" id="h5-0-98" class="i">+        cipher.init(Cipher.DECRYPT_MODE, SecretKeySpec(key, &quot;AES&quot;), IvParameterSpec(iv))
</a><a href="#h5-0-99" id="h5-0-99" class="i">+        return CipherInputStream(inputStream, cipher)
</a><a href="#h5-0-100" id="h5-0-100" class="i">+    }
</a><a href="#h5-0-101" id="h5-0-101" class="i">+
</a><a href="#h5-0-102" id="h5-0-102" class="i">+    private fun createNeededDirectories(file: File): File {
</a><a href="#h5-0-103" id="h5-0-103" class="i">+        val directory = file.parentFile ?: return file
</a><a href="#h5-0-104" id="h5-0-104" class="i">+        if (!directory.exists()) {
</a><a href="#h5-0-105" id="h5-0-105" class="i">+            directory.mkdirs()
</a><a href="#h5-0-106" id="h5-0-106" class="i">+        }
</a><a href="#h5-0-107" id="h5-0-107" class="i">+        return file
</a><a href="#h5-0-108" id="h5-0-108" class="i">+    }
</a><a href="#h5-0-109" id="h5-0-109" class="i">+
</a><a href="#h5-0-110" id="h5-0-110" class="i">+    @SuppressLint(&quot;UnspecifiedRegisterReceiverFlag&quot;)
</a><a href="#h5-0-111" id="h5-0-111" class="i">+    private suspend fun saveMediaToGallery(inputFile: File, pendingDownload: PendingDownload) {
</a><a href="#h5-0-112" id="h5-0-112" class="i">+        if (coroutineContext.job.isCancelled) return
</a><a href="#h5-0-113" id="h5-0-113" class="i">+
</a><a href="#h5-0-114" id="h5-0-114" class="i">+        val config by ModConfig().apply { loadFromContext(context) }
</a><a href="#h5-0-115" id="h5-0-115" class="i">+
</a><a href="#h5-0-116" id="h5-0-116" class="i">+        runCatching {
</a><a href="#h5-0-117" id="h5-0-117" class="i">+            val fileType = FileType.fromFile(inputFile)
</a><a href="#h5-0-118" id="h5-0-118" class="i">+            if (fileType == FileType.UNKNOWN) {
</a><a href="#h5-0-119" id="h5-0-119" class="i">+                callback.onFailure(translation.format(&quot;failed_gallery_toast&quot;, &quot;error&quot; to &quot;Unknown media type&quot;), null)
</a><a href="#h5-0-120" id="h5-0-120" class="i">+                return
</a><a href="#h5-0-121" id="h5-0-121" class="i">+            }
</a><a href="#h5-0-122" id="h5-0-122" class="i">+
</a><a href="#h5-0-123" id="h5-0-123" class="i">+            val fileName = pendingDownload.metadata.outputPath.substringAfterLast(&quot;/&quot;) + &quot;.&quot; + fileType.fileExtension
</a><a href="#h5-0-124" id="h5-0-124" class="i">+
</a><a href="#h5-0-125" id="h5-0-125" class="i">+            val outputFolder = DocumentFile.fromTreeUri(context, Uri.parse(config.downloader.saveFolder.get()))
</a><a href="#h5-0-126" id="h5-0-126" class="i">+                ?: throw Exception(&quot;Failed to open output folder&quot;)
</a><a href="#h5-0-127" id="h5-0-127" class="i">+
</a><a href="#h5-0-128" id="h5-0-128" class="i">+            val outputFileFolder = pendingDownload.metadata.outputPath.let {
</a><a href="#h5-0-129" id="h5-0-129" class="i">+                if (it.contains(&quot;/&quot;)) {
</a><a href="#h5-0-130" id="h5-0-130" class="i">+                    it.substringBeforeLast(&quot;/&quot;).split(&quot;/&quot;).fold(outputFolder) { folder, name -&gt;
</a><a href="#h5-0-131" id="h5-0-131" class="i">+                        folder.findFile(name) ?: folder.createDirectory(name)!!
</a><a href="#h5-0-132" id="h5-0-132" class="i">+                    }
</a><a href="#h5-0-133" id="h5-0-133" class="i">+                } else {
</a><a href="#h5-0-134" id="h5-0-134" class="i">+                    outputFolder
</a><a href="#h5-0-135" id="h5-0-135" class="i">+                }
</a><a href="#h5-0-136" id="h5-0-136" class="i">+            }
</a><a href="#h5-0-137" id="h5-0-137" class="i">+
</a><a href="#h5-0-138" id="h5-0-138" class="i">+            val outputFile = outputFileFolder.createFile(fileType.mimeType, fileName)!!
</a><a href="#h5-0-139" id="h5-0-139" class="i">+            val outputStream = context.contentResolver.openOutputStream(outputFile.uri)!!
</a><a href="#h5-0-140" id="h5-0-140" class="i">+
</a><a href="#h5-0-141" id="h5-0-141" class="i">+            inputFile.inputStream().use { inputStream -&gt;
</a><a href="#h5-0-142" id="h5-0-142" class="i">+                inputStream.copyTo(outputStream)
</a><a href="#h5-0-143" id="h5-0-143" class="i">+            }
</a><a href="#h5-0-144" id="h5-0-144" class="i">+
</a><a href="#h5-0-145" id="h5-0-145" class="i">+            pendingDownload.outputFile = outputFile.uri.toString()
</a><a href="#h5-0-146" id="h5-0-146" class="i">+            pendingDownload.downloadStage = DownloadStage.SAVED
</a><a href="#h5-0-147" id="h5-0-147" class="i">+
</a><a href="#h5-0-148" id="h5-0-148" class="i">+            runCatching {
</a><a href="#h5-0-149" id="h5-0-149" class="i">+                val mediaScanIntent = Intent(&quot;android.intent.action.MEDIA_SCANNER_SCAN_FILE&quot;)
</a><a href="#h5-0-150" id="h5-0-150" class="i">+                mediaScanIntent.setData(outputFile.uri)
</a><a href="#h5-0-151" id="h5-0-151" class="i">+                context.sendBroadcast(mediaScanIntent)
</a><a href="#h5-0-152" id="h5-0-152" class="i">+            }.onFailure {
</a><a href="#h5-0-153" id="h5-0-153" class="i">+                Logger.error(&quot;Failed to scan media file&quot;, it)
</a><a href="#h5-0-154" id="h5-0-154" class="i">+                callback.onFailure(translation.format(&quot;failed_gallery_toast&quot;, &quot;error&quot; to it.toString()), it.message)
</a><a href="#h5-0-155" id="h5-0-155" class="i">+            }
</a><a href="#h5-0-156" id="h5-0-156" class="i">+
</a><a href="#h5-0-157" id="h5-0-157" class="i">+            Logger.debug(&quot;download complete&quot;)
</a><a href="#h5-0-158" id="h5-0-158" class="i">+            fileName.let {
</a><a href="#h5-0-159" id="h5-0-159" class="i">+                runCatching { callback.onSuccess(it) }.onFailure { fallbackToast(it) }
</a><a href="#h5-0-160" id="h5-0-160" class="i">+            }
</a><a href="#h5-0-161" id="h5-0-161" class="i">+        }.onFailure { exception -&gt;
</a><a href="#h5-0-162" id="h5-0-162" class="i">+            Logger.error(exception)
</a><a href="#h5-0-163" id="h5-0-163" class="i">+            translation.format(&quot;failed_gallery_toast&quot;, &quot;error&quot; to exception.toString()).let {
</a><a href="#h5-0-164" id="h5-0-164" class="i">+                runCatching { callback.onFailure(it, exception.message) }.onFailure { fallbackToast(it) }
</a><a href="#h5-0-165" id="h5-0-165" class="i">+            }
</a><a href="#h5-0-166" id="h5-0-166" class="i">+            pendingDownload.downloadStage = DownloadStage.FAILED
</a><a href="#h5-0-167" id="h5-0-167" class="i">+        }
</a><a href="#h5-0-168" id="h5-0-168" class="i">+    }
</a><a href="#h5-0-169" id="h5-0-169" class="i">+
</a><a href="#h5-0-170" id="h5-0-170" class="i">+    private fun createMediaTempFile(): File {
</a><a href="#h5-0-171" id="h5-0-171" class="i">+        return File.createTempFile(&quot;media&quot;, &quot;.tmp&quot;)
</a><a href="#h5-0-172" id="h5-0-172" class="i">+    }
</a><a href="#h5-0-173" id="h5-0-173" class="i">+
</a><a href="#h5-0-174" id="h5-0-174" class="i">+    private fun downloadInputMedias(downloadRequest: DownloadRequest) = runBlocking {
</a><a href="#h5-0-175" id="h5-0-175" class="i">+        val jobs = mutableListOf&lt;Job&gt;()
</a><a href="#h5-0-176" id="h5-0-176" class="i">+        val downloadedMedias = mutableMapOf&lt;InputMedia, File&gt;()
</a><a href="#h5-0-177" id="h5-0-177" class="i">+
</a><a href="#h5-0-178" id="h5-0-178" class="i">+        downloadRequest.inputMedias.forEach { inputMedia -&gt;
</a><a href="#h5-0-179" id="h5-0-179" class="i">+            fun handleInputStream(inputStream: InputStream) {
</a><a href="#h5-0-180" id="h5-0-180" class="i">+                createMediaTempFile().apply {
</a><a href="#h5-0-181" id="h5-0-181" class="i">+                    if (inputMedia.encryption != null) {
</a><a href="#h5-0-182" id="h5-0-182" class="i">+                        decryptInputStream(inputStream,
</a><a href="#h5-0-183" id="h5-0-183" class="i">+                            inputMedia.encryption!!
</a><a href="#h5-0-184" id="h5-0-184" class="i">+                        ).use { decryptedInputStream -&gt;
</a><a href="#h5-0-185" id="h5-0-185" class="i">+                            decryptedInputStream.copyTo(outputStream())
</a><a href="#h5-0-186" id="h5-0-186" class="i">+                        }
</a><a href="#h5-0-187" id="h5-0-187" class="i">+                    } else {
</a><a href="#h5-0-188" id="h5-0-188" class="i">+                        inputStream.copyTo(outputStream())
</a><a href="#h5-0-189" id="h5-0-189" class="i">+                    }
</a><a href="#h5-0-190" id="h5-0-190" class="i">+                }.also { downloadedMedias[inputMedia] = it }
</a><a href="#h5-0-191" id="h5-0-191" class="i">+            }
</a><a href="#h5-0-192" id="h5-0-192" class="i">+
</a><a href="#h5-0-193" id="h5-0-193" class="i">+            launch {
</a><a href="#h5-0-194" id="h5-0-194" class="i">+                when (inputMedia.type) {
</a><a href="#h5-0-195" id="h5-0-195" class="i">+                    DownloadMediaType.PROTO_MEDIA -&gt; {
</a><a href="#h5-0-196" id="h5-0-196" class="i">+                        RemoteMediaResolver.downloadBoltMedia(Base64.UrlSafe.decode(inputMedia.content))?.let { inputStream -&gt;
</a><a href="#h5-0-197" id="h5-0-197" class="i">+                            handleInputStream(inputStream)
</a><a href="#h5-0-198" id="h5-0-198" class="i">+                        }
</a><a href="#h5-0-199" id="h5-0-199" class="i">+                    }
</a><a href="#h5-0-200" id="h5-0-200" class="i">+                    DownloadMediaType.DIRECT_MEDIA -&gt; {
</a><a href="#h5-0-201" id="h5-0-201" class="i">+                        val decoded = Base64.UrlSafe.decode(inputMedia.content)
</a><a href="#h5-0-202" id="h5-0-202" class="i">+                        createMediaTempFile().apply {
</a><a href="#h5-0-203" id="h5-0-203" class="i">+                            writeBytes(decoded)
</a><a href="#h5-0-204" id="h5-0-204" class="i">+                        }.also { downloadedMedias[inputMedia] = it }
</a><a href="#h5-0-205" id="h5-0-205" class="i">+                    }
</a><a href="#h5-0-206" id="h5-0-206" class="i">+                    DownloadMediaType.REMOTE_MEDIA -&gt; {
</a><a href="#h5-0-207" id="h5-0-207" class="i">+                        with(URL(inputMedia.content).openConnection() as HttpURLConnection) {
</a><a href="#h5-0-208" id="h5-0-208" class="i">+                            requestMethod = &quot;GET&quot;
</a><a href="#h5-0-209" id="h5-0-209" class="i">+                            setRequestProperty(&quot;User-Agent&quot;, Constants.USER_AGENT)
</a><a href="#h5-0-210" id="h5-0-210" class="i">+                            connect()
</a><a href="#h5-0-211" id="h5-0-211" class="i">+                            handleInputStream(inputStream)
</a><a href="#h5-0-212" id="h5-0-212" class="i">+                        }
</a><a href="#h5-0-213" id="h5-0-213" class="i">+                    }
</a><a href="#h5-0-214" id="h5-0-214" class="i">+                    else -&gt; {
</a><a href="#h5-0-215" id="h5-0-215" class="i">+                        downloadedMedias[inputMedia] = File(inputMedia.content)
</a><a href="#h5-0-216" id="h5-0-216" class="i">+                    }
</a><a href="#h5-0-217" id="h5-0-217" class="i">+                }
</a><a href="#h5-0-218" id="h5-0-218" class="i">+            }.also { jobs.add(it) }
</a><a href="#h5-0-219" id="h5-0-219" class="i">+        }
</a><a href="#h5-0-220" id="h5-0-220" class="i">+
</a><a href="#h5-0-221" id="h5-0-221" class="i">+        jobs.joinAll()
</a><a href="#h5-0-222" id="h5-0-222" class="i">+        downloadedMedias
</a><a href="#h5-0-223" id="h5-0-223" class="i">+    }
</a><a href="#h5-0-224" id="h5-0-224" class="i">+
</a><a href="#h5-0-225" id="h5-0-225" class="i">+    private suspend fun downloadRemoteMedia(pendingDownloadObject: PendingDownload, downloadedMedias: Map&lt;InputMedia, DownloadedFile&gt;, downloadRequest: DownloadRequest) {
</a><a href="#h5-0-226" id="h5-0-226" class="i">+        downloadRequest.inputMedias.first().let { inputMedia -&gt;
</a><a href="#h5-0-227" id="h5-0-227" class="i">+            val mediaType = inputMedia.type
</a><a href="#h5-0-228" id="h5-0-228" class="i">+            val media = downloadedMedias[inputMedia]!!
</a><a href="#h5-0-229" id="h5-0-229" class="i">+
</a><a href="#h5-0-230" id="h5-0-230" class="i">+            if (!downloadRequest.isDashPlaylist) {
</a><a href="#h5-0-231" id="h5-0-231" class="i">+                saveMediaToGallery(media.file, pendingDownloadObject)
</a><a href="#h5-0-232" id="h5-0-232" class="i">+                media.file.delete()
</a><a href="#h5-0-233" id="h5-0-233" class="i">+                return
</a><a href="#h5-0-234" id="h5-0-234" class="i">+            }
</a><a href="#h5-0-235" id="h5-0-235" class="i">+
</a><a href="#h5-0-236" id="h5-0-236" class="i">+            assert(mediaType == DownloadMediaType.REMOTE_MEDIA)
</a><a href="#h5-0-237" id="h5-0-237" class="i">+
</a><a href="#h5-0-238" id="h5-0-238" class="i">+            val playlistXml = DocumentBuilderFactory.newInstance().newDocumentBuilder().parse(media.file)
</a><a href="#h5-0-239" id="h5-0-239" class="i">+            val baseUrlNodeList = playlistXml.getElementsByTagName(&quot;BaseURL&quot;)
</a><a href="#h5-0-240" id="h5-0-240" class="i">+            for (i in 0 until baseUrlNodeList.length) {
</a><a href="#h5-0-241" id="h5-0-241" class="i">+                val baseUrlNode = baseUrlNodeList.item(i)
</a><a href="#h5-0-242" id="h5-0-242" class="i">+                val baseUrl = baseUrlNode.textContent
</a><a href="#h5-0-243" id="h5-0-243" class="i">+                baseUrlNode.textContent = &quot;${RemoteMediaResolver.CF_ST_CDN_D}$baseUrl&quot;
</a><a href="#h5-0-244" id="h5-0-244" class="i">+            }
</a><a href="#h5-0-245" id="h5-0-245" class="i">+
</a><a href="#h5-0-246" id="h5-0-246" class="i">+            val dashOptions = downloadRequest.dashOptions!!
</a><a href="#h5-0-247" id="h5-0-247" class="i">+
</a><a href="#h5-0-248" id="h5-0-248" class="i">+            val dashPlaylistFile = renameFromFileType(media.file, FileType.MPD)
</a><a href="#h5-0-249" id="h5-0-249" class="i">+            val xmlData = dashPlaylistFile.outputStream()
</a><a href="#h5-0-250" id="h5-0-250" class="i">+            TransformerFactory.newInstance().newTransformer().transform(DOMSource(playlistXml), StreamResult(xmlData))
</a><a href="#h5-0-251" id="h5-0-251" class="i">+
</a><a href="#h5-0-252" id="h5-0-252" class="i">+            translation.format(&quot;download_toast&quot;, &quot;path&quot; to dashPlaylistFile.nameWithoutExtension).let {
</a><a href="#h5-0-253" id="h5-0-253" class="i">+                runCatching { callback.onProgress(it) }.onFailure { fallbackToast(it) }
</a><a href="#h5-0-254" id="h5-0-254" class="i">+            }
</a><a href="#h5-0-255" id="h5-0-255" class="i">+            val outputFile = File.createTempFile(&quot;dash&quot;, &quot;.mp4&quot;)
</a><a href="#h5-0-256" id="h5-0-256" class="i">+            runCatching {
</a><a href="#h5-0-257" id="h5-0-257" class="i">+                MediaDownloaderHelper.downloadDashChapterFile(
</a><a href="#h5-0-258" id="h5-0-258" class="i">+                    dashPlaylist = dashPlaylistFile,
</a><a href="#h5-0-259" id="h5-0-259" class="i">+                    output = outputFile,
</a><a href="#h5-0-260" id="h5-0-260" class="i">+                    startTime = dashOptions.offsetTime,
</a><a href="#h5-0-261" id="h5-0-261" class="i">+                    duration = dashOptions.duration)
</a><a href="#h5-0-262" id="h5-0-262" class="i">+                saveMediaToGallery(outputFile, pendingDownloadObject)
</a><a href="#h5-0-263" id="h5-0-263" class="i">+            }.onFailure { exception -&gt;
</a><a href="#h5-0-264" id="h5-0-264" class="i">+                if (coroutineContext.job.isCancelled) return@onFailure
</a><a href="#h5-0-265" id="h5-0-265" class="i">+                Logger.error(exception)
</a><a href="#h5-0-266" id="h5-0-266" class="i">+                translation.format(&quot;failed_processing_toast&quot;, &quot;error&quot; to exception.toString()).let {
</a><a href="#h5-0-267" id="h5-0-267" class="i">+                    runCatching { callback.onFailure(it, exception.message) }.onFailure { fallbackToast(it) }
</a><a href="#h5-0-268" id="h5-0-268" class="i">+                }
</a><a href="#h5-0-269" id="h5-0-269" class="i">+                pendingDownloadObject.downloadStage = DownloadStage.FAILED
</a><a href="#h5-0-270" id="h5-0-270" class="i">+            }
</a><a href="#h5-0-271" id="h5-0-271" class="i">+
</a><a href="#h5-0-272" id="h5-0-272" class="i">+            dashPlaylistFile.delete()
</a><a href="#h5-0-273" id="h5-0-273" class="i">+            outputFile.delete()
</a><a href="#h5-0-274" id="h5-0-274" class="i">+            media.file.delete()
</a><a href="#h5-0-275" id="h5-0-275" class="i">+        }
</a><a href="#h5-0-276" id="h5-0-276" class="i">+    }
</a><a href="#h5-0-277" id="h5-0-277" class="i">+
</a><a href="#h5-0-278" id="h5-0-278" class="i">+    private fun renameFromFileType(file: File, fileType: FileType): File {
</a><a href="#h5-0-279" id="h5-0-279" class="i">+        val newFile = File(file.parentFile, file.nameWithoutExtension + &quot;.&quot; + fileType.fileExtension)
</a><a href="#h5-0-280" id="h5-0-280" class="i">+        file.renameTo(newFile)
</a><a href="#h5-0-281" id="h5-0-281" class="i">+        return newFile
</a><a href="#h5-0-282" id="h5-0-282" class="i">+    }
</a><a href="#h5-0-283" id="h5-0-283" class="i">+
</a><a href="#h5-0-284" id="h5-0-284" class="i">+    fun onReceive(intent: Intent) {
</a><a href="#h5-0-285" id="h5-0-285" class="i">+        CoroutineScope(Dispatchers.IO).launch {
</a><a href="#h5-0-286" id="h5-0-286" class="i">+            val downloadMetadata = gson.fromJson(intent.getStringExtra(DownloadManagerClient.DOWNLOAD_METADATA_EXTRA)!!, DownloadMetadata::class.java)
</a><a href="#h5-0-287" id="h5-0-287" class="i">+            val downloadRequest = gson.fromJson(intent.getStringExtra(DownloadManagerClient.DOWNLOAD_REQUEST_EXTRA)!!, DownloadRequest::class.java)
</a><a href="#h5-0-288" id="h5-0-288" class="i">+
</a><a href="#h5-0-289" id="h5-0-289" class="i">+            SharedContext.downloadTaskManager.canDownloadMedia(downloadMetadata.mediaIdentifier)?.let { downloadStage -&gt;
</a><a href="#h5-0-290" id="h5-0-290" class="i">+                translation[if (downloadStage.isFinalStage) {
</a><a href="#h5-0-291" id="h5-0-291" class="i">+                    &quot;already_downloaded_toast&quot;
</a><a href="#h5-0-292" id="h5-0-292" class="i">+                } else {
</a><a href="#h5-0-293" id="h5-0-293" class="i">+                    &quot;already_queued_toast&quot;
</a><a href="#h5-0-294" id="h5-0-294" class="i">+                }].let {
</a><a href="#h5-0-295" id="h5-0-295" class="i">+                    runCatching { callback.onFailure(it, null) }.onFailure { fallbackToast(it) }
</a><a href="#h5-0-296" id="h5-0-296" class="i">+                }
</a><a href="#h5-0-297" id="h5-0-297" class="i">+                return@launch
</a><a href="#h5-0-298" id="h5-0-298" class="i">+            }
</a><a href="#h5-0-299" id="h5-0-299" class="i">+
</a><a href="#h5-0-300" id="h5-0-300" class="i">+            val pendingDownloadObject = PendingDownload(
</a><a href="#h5-0-301" id="h5-0-301" class="i">+                metadata = downloadMetadata
</a><a href="#h5-0-302" id="h5-0-302" class="i">+            )
</a><a href="#h5-0-303" id="h5-0-303" class="i">+
</a><a href="#h5-0-304" id="h5-0-304" class="i">+            SharedContext.downloadTaskManager.addTask(pendingDownloadObject)
</a><a href="#h5-0-305" id="h5-0-305" class="i">+            pendingDownloadObject.apply {
</a><a href="#h5-0-306" id="h5-0-306" class="i">+                job = coroutineContext.job
</a><a href="#h5-0-307" id="h5-0-307" class="i">+                downloadStage = DownloadStage.DOWNLOADING
</a><a href="#h5-0-308" id="h5-0-308" class="i">+            }
</a><a href="#h5-0-309" id="h5-0-309" class="i">+
</a><a href="#h5-0-310" id="h5-0-310" class="i">+            runCatching {
</a><a href="#h5-0-311" id="h5-0-311" class="i">+                //first download all input medias into cache
</a><a href="#h5-0-312" id="h5-0-312" class="i">+                val downloadedMedias = downloadInputMedias(downloadRequest).map {
</a><a href="#h5-0-313" id="h5-0-313" class="i">+                    it.key to DownloadedFile(it.value, FileType.fromFile(it.value))
</a><a href="#h5-0-314" id="h5-0-314" class="i">+                }.toMap().toMutableMap()
</a><a href="#h5-0-315" id="h5-0-315" class="i">+                Logger.debug(&quot;downloaded ${downloadedMedias.size} medias&quot;)
</a><a href="#h5-0-316" id="h5-0-316" class="i">+
</a><a href="#h5-0-317" id="h5-0-317" class="i">+                var shouldMergeOverlay = downloadRequest.shouldMergeOverlay
</a><a href="#h5-0-318" id="h5-0-318" class="i">+
</a><a href="#h5-0-319" id="h5-0-319" class="i">+                //if there is a zip file, extract it and replace the downloaded media with the extracted ones
</a><a href="#h5-0-320" id="h5-0-320" class="i">+                downloadedMedias.values.find { it.fileType == FileType.ZIP }?.let { entry -&gt;
</a><a href="#h5-0-321" id="h5-0-321" class="i">+                    val extractedMedias = extractZip(entry.file.inputStream()).map {
</a><a href="#h5-0-322" id="h5-0-322" class="i">+                        InputMedia(
</a><a href="#h5-0-323" id="h5-0-323" class="i">+                            type = DownloadMediaType.LOCAL_MEDIA,
</a><a href="#h5-0-324" id="h5-0-324" class="i">+                            content = it.absolutePath
</a><a href="#h5-0-325" id="h5-0-325" class="i">+                        ) to DownloadedFile(it, FileType.fromFile(it))
</a><a href="#h5-0-326" id="h5-0-326" class="i">+                    }
</a><a href="#h5-0-327" id="h5-0-327" class="i">+
</a><a href="#h5-0-328" id="h5-0-328" class="i">+                    downloadedMedias.values.removeIf {
</a><a href="#h5-0-329" id="h5-0-329" class="i">+                        it.file.delete()
</a><a href="#h5-0-330" id="h5-0-330" class="i">+                        true
</a><a href="#h5-0-331" id="h5-0-331" class="i">+                    }
</a><a href="#h5-0-332" id="h5-0-332" class="i">+
</a><a href="#h5-0-333" id="h5-0-333" class="i">+                    downloadedMedias.putAll(extractedMedias)
</a><a href="#h5-0-334" id="h5-0-334" class="i">+                    shouldMergeOverlay = true
</a><a href="#h5-0-335" id="h5-0-335" class="i">+                }
</a><a href="#h5-0-336" id="h5-0-336" class="i">+
</a><a href="#h5-0-337" id="h5-0-337" class="i">+                if (shouldMergeOverlay) {
</a><a href="#h5-0-338" id="h5-0-338" class="i">+                    assert(downloadedMedias.size == 2)
</a><a href="#h5-0-339" id="h5-0-339" class="i">+                    val media = downloadedMedias.values.first { it.fileType.isVideo }
</a><a href="#h5-0-340" id="h5-0-340" class="i">+                    val overlayMedia = downloadedMedias.values.first { it.fileType.isImage }
</a><a href="#h5-0-341" id="h5-0-341" class="i">+
</a><a href="#h5-0-342" id="h5-0-342" class="i">+                    val renamedMedia = renameFromFileType(media.file, media.fileType)
</a><a href="#h5-0-343" id="h5-0-343" class="i">+                    val renamedOverlayMedia = renameFromFileType(overlayMedia.file, overlayMedia.fileType)
</a><a href="#h5-0-344" id="h5-0-344" class="i">+                    val mergedOverlay: File = File.createTempFile(&quot;merged&quot;, &quot;.&quot; + media.fileType.fileExtension)
</a><a href="#h5-0-345" id="h5-0-345" class="i">+                    runCatching {
</a><a href="#h5-0-346" id="h5-0-346" class="i">+                        translation.format(&quot;download_toast&quot;, &quot;path&quot; to media.file.nameWithoutExtension).let {
</a><a href="#h5-0-347" id="h5-0-347" class="i">+                            runCatching { callback.onProgress(it) }.onFailure { fallbackToast(it) }
</a><a href="#h5-0-348" id="h5-0-348" class="i">+                        }
</a><a href="#h5-0-349" id="h5-0-349" class="i">+                        pendingDownloadObject.downloadStage = DownloadStage.MERGING
</a><a href="#h5-0-350" id="h5-0-350" class="i">+
</a><a href="#h5-0-351" id="h5-0-351" class="i">+                        MediaDownloaderHelper.mergeOverlayFile(
</a><a href="#h5-0-352" id="h5-0-352" class="i">+                            media = renamedMedia,
</a><a href="#h5-0-353" id="h5-0-353" class="i">+                            overlay = renamedOverlayMedia,
</a><a href="#h5-0-354" id="h5-0-354" class="i">+                            output = mergedOverlay
</a><a href="#h5-0-355" id="h5-0-355" class="i">+                        )
</a><a href="#h5-0-356" id="h5-0-356" class="i">+
</a><a href="#h5-0-357" id="h5-0-357" class="i">+                        saveMediaToGallery(mergedOverlay, pendingDownloadObject)
</a><a href="#h5-0-358" id="h5-0-358" class="i">+                    }.onFailure { exception -&gt;
</a><a href="#h5-0-359" id="h5-0-359" class="i">+                        if (coroutineContext.job.isCancelled) return@onFailure
</a><a href="#h5-0-360" id="h5-0-360" class="i">+                        Logger.error(exception)
</a><a href="#h5-0-361" id="h5-0-361" class="i">+                        translation.format(&quot;failed_processing_toast&quot;, &quot;error&quot; to exception.toString()).let {
</a><a href="#h5-0-362" id="h5-0-362" class="i">+                            runCatching { callback.onFailure(it, exception.message) }.onFailure { fallbackToast(it) }
</a><a href="#h5-0-363" id="h5-0-363" class="i">+                        }
</a><a href="#h5-0-364" id="h5-0-364" class="i">+                        pendingDownloadObject.downloadStage = DownloadStage.MERGE_FAILED
</a><a href="#h5-0-365" id="h5-0-365" class="i">+                    }
</a><a href="#h5-0-366" id="h5-0-366" class="i">+
</a><a href="#h5-0-367" id="h5-0-367" class="i">+                    mergedOverlay.delete()
</a><a href="#h5-0-368" id="h5-0-368" class="i">+                    renamedOverlayMedia.delete()
</a><a href="#h5-0-369" id="h5-0-369" class="i">+                    renamedMedia.delete()
</a><a href="#h5-0-370" id="h5-0-370" class="i">+                    return@launch
</a><a href="#h5-0-371" id="h5-0-371" class="i">+                }
</a><a href="#h5-0-372" id="h5-0-372" class="i">+
</a><a href="#h5-0-373" id="h5-0-373" class="i">+                downloadRemoteMedia(pendingDownloadObject, downloadedMedias, downloadRequest)
</a><a href="#h5-0-374" id="h5-0-374" class="i">+            }.onFailure { exception -&gt;
</a><a href="#h5-0-375" id="h5-0-375" class="i">+                pendingDownloadObject.downloadStage = DownloadStage.FAILED
</a><a href="#h5-0-376" id="h5-0-376" class="i">+                Logger.error(exception)
</a><a href="#h5-0-377" id="h5-0-377" class="i">+                translation[&quot;failed_generic_toast&quot;].let {
</a><a href="#h5-0-378" id="h5-0-378" class="i">+                    runCatching { callback.onFailure(it, exception.message) }.onFailure { fallbackToast(it) }
</a><a href="#h5-0-379" id="h5-0-379" class="i">+                }
</a><a href="#h5-0-380" id="h5-0-380" class="i">+            }
</a><a href="#h5-0-381" id="h5-0-381" class="i">+        }
</a><a href="#h5-0-382" id="h5-0-382" class="i">+    }
</a><a href="#h5-0-383" id="h5-0-383" class="i">+}</a><a href="#h5-0-384" id="h5-0-384" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h6" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/MainActivity.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/MainActivity.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/MainActivity.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/MainActivity.kt</a></b>
<a href="#h6-0" id="h6-0" class="h">@@ -1,43 +1,49 @@
</a> package me.rhunk.snapenhance.ui.manager
 
<a href="#h6-0-2" id="h6-0-2" class="d">-import android.annotation.SuppressLint
</a> import android.os.Bundle
 import androidx.activity.ComponentActivity
 import androidx.activity.compose.setContent
 import androidx.compose.material3.MaterialTheme
 import androidx.compose.material3.Scaffold
<a href="#h6-0-8" id="h6-0-8" class="i">+import androidx.compose.runtime.remember
</a> import androidx.navigation.compose.rememberNavController
<a href="#h6-0-10" id="h6-0-10" class="i">+import me.rhunk.snapenhance.SharedContextHolder
</a> import me.rhunk.snapenhance.ui.AppMaterialTheme
<a href="#h6-0-12" id="h6-0-12" class="d">-import me.rhunk.snapenhance.ui.manager.util.SaveFolderChecker
</a><a href="#h6-0-13" id="h6-0-13" class="d">-import me.rhunk.snapenhance.util.ActivityResultCallback
</a> 
 class MainActivity : ComponentActivity() {
<a href="#h6-0-16" id="h6-0-16" class="d">-    private val activityResultCallbacks = mutableMapOf&lt;Int, ActivityResultCallback&gt;()
</a><a href="#h6-0-17" id="h6-0-17" class="d">-
</a><a href="#h6-0-18" id="h6-0-18" class="d">-    @SuppressLint(&quot;UnusedMaterialScaffoldPaddingParameter&quot;)
</a>     override fun onCreate(savedInstanceState: Bundle?) {
         super.onCreate(savedInstanceState)
 
         val startDestination = intent.getStringExtra(&quot;route&quot;)?.let { EnumSection.fromRoute(it) } ?: EnumSection.HOME
<a href="#h6-0-23" id="h6-0-23" class="d">-        val managerContext = ManagerContext(this)
</a><a href="#h6-0-24" id="h6-0-24" class="i">+        val managerContext = SharedContextHolder.remote(this).apply {
</a><a href="#h6-0-25" id="h6-0-25" class="i">+            activity = this@MainActivity
</a><a href="#h6-0-26" id="h6-0-26" class="i">+            checkForRequirements()
</a><a href="#h6-0-27" id="h6-0-27" class="i">+        }
</a> 
<a href="#h6-0-29" id="h6-0-29" class="d">-        //FIXME: temporary save folder
</a><a href="#h6-0-30" id="h6-0-30" class="d">-        SaveFolderChecker.askForFolder(
</a><a href="#h6-0-31" id="h6-0-31" class="d">-            this,
</a><a href="#h6-0-32" id="h6-0-32" class="d">-            managerContext.config.root.downloader.saveFolder)
</a><a href="#h6-0-33" id="h6-0-33" class="d">-        {
</a><a href="#h6-0-34" id="h6-0-34" class="d">-            managerContext.config.writeConfig()
</a><a href="#h6-0-35" id="h6-0-35" class="i">+        val sections = EnumSection.values().toList().associateWith {
</a><a href="#h6-0-36" id="h6-0-36" class="i">+            it.section.constructors.first().call()
</a><a href="#h6-0-37" id="h6-0-37" class="i">+        }.onEach { (section, instance) -&gt;
</a><a href="#h6-0-38" id="h6-0-38" class="i">+            with(instance) {
</a><a href="#h6-0-39" id="h6-0-39" class="i">+                enumSection = section
</a><a href="#h6-0-40" id="h6-0-40" class="i">+                context = managerContext
</a><a href="#h6-0-41" id="h6-0-41" class="i">+                init()
</a><a href="#h6-0-42" id="h6-0-42" class="i">+            }
</a>         }
 
         setContent {
             val navController = rememberNavController()
<a href="#h6-0-47" id="h6-0-47" class="d">-            val navigation = Navigation(managerContext)
</a><a href="#h6-0-48" id="h6-0-48" class="i">+            val navigation = remember { Navigation() }
</a>             AppMaterialTheme {
                 Scaffold(
                     containerColor = MaterialTheme.colorScheme.background,
                     bottomBar = { navigation.NavBar(navController = navController) }
                 ) { innerPadding -&gt;
<a href="#h6-0-54" id="h6-0-54" class="d">-                    navigation.NavigationHost(navController = navController, innerPadding = innerPadding, startDestination = startDestination)
</a><a href="#h6-0-55" id="h6-0-55" class="i">+                    navigation.NavigationHost(
</a><a href="#h6-0-56" id="h6-0-56" class="i">+                        sections = sections,
</a><a href="#h6-0-57" id="h6-0-57" class="i">+                        navController = navController,
</a><a href="#h6-0-58" id="h6-0-58" class="i">+                        innerPadding = innerPadding,
</a><a href="#h6-0-59" id="h6-0-59" class="i">+                        startDestination = startDestination
</a><a href="#h6-0-60" id="h6-0-60" class="i">+                    )
</a>                 }
             }
         }
<b>diff --git a/<a id="h7" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/ManagerContext.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/ManagerContext.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/ManagerContext.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/ManagerContext.kt</a></b>
<a href="#h7-0" id="h7-0" class="h">@@ -1,38 +0,0 @@
</a><a href="#h7-0-0" id="h7-0-0" class="d">-package me.rhunk.snapenhance.ui.manager
</a><a href="#h7-0-1" id="h7-0-1" class="d">-
</a><a href="#h7-0-2" id="h7-0-2" class="d">-import android.content.Context
</a><a href="#h7-0-3" id="h7-0-3" class="d">-import me.rhunk.snapenhance.bridge.wrapper.MappingsWrapper
</a><a href="#h7-0-4" id="h7-0-4" class="d">-import me.rhunk.snapenhance.bridge.wrapper.LocaleWrapper
</a><a href="#h7-0-5" id="h7-0-5" class="d">-import me.rhunk.snapenhance.core.config.ModConfig
</a><a href="#h7-0-6" id="h7-0-6" class="d">-import me.rhunk.snapenhance.ui.manager.data.InstallationSummary
</a><a href="#h7-0-7" id="h7-0-7" class="d">-import me.rhunk.snapenhance.ui.manager.data.ModMappingsInfo
</a><a href="#h7-0-8" id="h7-0-8" class="d">-import me.rhunk.snapenhance.ui.manager.data.SnapchatAppInfo
</a><a href="#h7-0-9" id="h7-0-9" class="d">-
</a><a href="#h7-0-10" id="h7-0-10" class="d">-class ManagerContext(
</a><a href="#h7-0-11" id="h7-0-11" class="d">-    private val context: Context
</a><a href="#h7-0-12" id="h7-0-12" class="d">-) {
</a><a href="#h7-0-13" id="h7-0-13" class="d">-    val config = ModConfig()
</a><a href="#h7-0-14" id="h7-0-14" class="d">-    val translation = LocaleWrapper()
</a><a href="#h7-0-15" id="h7-0-15" class="d">-    val mappings = MappingsWrapper(context)
</a><a href="#h7-0-16" id="h7-0-16" class="d">-
</a><a href="#h7-0-17" id="h7-0-17" class="d">-    init {
</a><a href="#h7-0-18" id="h7-0-18" class="d">-        config.loadFromContext(context)
</a><a href="#h7-0-19" id="h7-0-19" class="d">-        translation.loadFromContext(context)
</a><a href="#h7-0-20" id="h7-0-20" class="d">-        mappings.apply { loadFromContext(context) }.init()
</a><a href="#h7-0-21" id="h7-0-21" class="d">-    }
</a><a href="#h7-0-22" id="h7-0-22" class="d">-
</a><a href="#h7-0-23" id="h7-0-23" class="d">-    fun getInstallationSummary() = InstallationSummary(
</a><a href="#h7-0-24" id="h7-0-24" class="d">-        snapchatInfo = mappings.getSnapchatPackageInfo()?.let {
</a><a href="#h7-0-25" id="h7-0-25" class="d">-            SnapchatAppInfo(
</a><a href="#h7-0-26" id="h7-0-26" class="d">-                version = it.versionName,
</a><a href="#h7-0-27" id="h7-0-27" class="d">-                versionCode = it.longVersionCode
</a><a href="#h7-0-28" id="h7-0-28" class="d">-            )
</a><a href="#h7-0-29" id="h7-0-29" class="d">-        },
</a><a href="#h7-0-30" id="h7-0-30" class="d">-        mappingsInfo = if (mappings.isMappingsLoaded()) {
</a><a href="#h7-0-31" id="h7-0-31" class="d">-            ModMappingsInfo(
</a><a href="#h7-0-32" id="h7-0-32" class="d">-                generatedSnapchatVersion = mappings.getGeneratedBuildNumber(),
</a><a href="#h7-0-33" id="h7-0-33" class="d">-                isOutdated = mappings.isMappingsOutdated()
</a><a href="#h7-0-34" id="h7-0-34" class="d">-            )
</a><a href="#h7-0-35" id="h7-0-35" class="d">-        } else null
</a><a href="#h7-0-36" id="h7-0-36" class="d">-    )
</a><a href="#h7-0-37" id="h7-0-37" class="d">-}</a><a href="#h7-0-38" id="h7-0-38" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h8" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/Navigation.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/Navigation.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/Navigation.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/Navigation.kt</a></b>
<a href="#h8-0" id="h8-0" class="h">@@ -12,7 +12,6 @@ import androidx.compose.material3.NavigationBarItem
</a> import androidx.compose.material3.Text
 import androidx.compose.runtime.Composable
 import androidx.compose.runtime.getValue
<a href="#h8-0-3" id="h8-0-3" class="d">-import androidx.compose.runtime.remember
</a> import androidx.compose.ui.Modifier
 import androidx.compose.ui.unit.dp
 import androidx.navigation.NavController
<a href="#h8-1" id="h8-1" class="h">@@ -23,25 +22,17 @@ import androidx.navigation.compose.NavHost
</a> import androidx.navigation.compose.currentBackStackEntryAsState
 
 
<a href="#h8-1-3" id="h8-1-3" class="d">-class Navigation(
</a><a href="#h8-1-4" id="h8-1-4" class="d">-    private val context: ManagerContext
</a><a href="#h8-1-5" id="h8-1-5" class="d">-) {
</a><a href="#h8-1-6" id="h8-1-6" class="i">+class Navigation{
</a>     @Composable
     fun NavigationHost(
<a href="#h8-1-9" id="h8-1-9" class="i">+        sections: Map&lt;EnumSection, Section&gt;,
</a>         startDestination: EnumSection,
         navController: NavHostController,
         innerPadding: PaddingValues
     ) {
<a href="#h8-1-14" id="h8-1-14" class="d">-        val sections = remember { EnumSection.values().toList().map {
</a><a href="#h8-1-15" id="h8-1-15" class="d">-            it to it.section.constructors.first().call()
</a><a href="#h8-1-16" id="h8-1-16" class="d">-        }.onEach { (section, instance) -&gt;
</a><a href="#h8-1-17" id="h8-1-17" class="d">-            instance.enumSection = section
</a><a href="#h8-1-18" id="h8-1-18" class="d">-            instance.manager = context
</a><a href="#h8-1-19" id="h8-1-19" class="d">-            instance.navController = navController
</a><a href="#h8-1-20" id="h8-1-20" class="d">-        } }
</a><a href="#h8-1-21" id="h8-1-21" class="d">-
</a>         NavHost(navController, startDestination = startDestination.route, Modifier.padding(innerPadding)) {
             sections.forEach { (_, instance) -&gt;
<a href="#h8-1-24" id="h8-1-24" class="i">+                instance.navController = navController
</a>                 instance.build(this)
             }
         }
<b>diff --git a/<a id="h9" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/Section.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/Section.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/Section.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/Section.kt</a></b>
<a href="#h9-0" id="h9-0" class="h">@@ -11,6 +11,7 @@ import androidx.compose.ui.graphics.vector.ImageVector
</a> import androidx.navigation.NavController
 import androidx.navigation.NavGraphBuilder
 import androidx.navigation.compose.composable
<a href="#h9-0-3" id="h9-0-3" class="i">+import me.rhunk.snapenhance.RemoteSideContext
</a> import me.rhunk.snapenhance.ui.manager.sections.HomeSection
 import me.rhunk.snapenhance.ui.manager.sections.NotImplemented
 import me.rhunk.snapenhance.ui.manager.sections.features.FeaturesSection
<a href="#h9-1" id="h9-1" class="h">@@ -61,9 +62,11 @@ enum class EnumSection(
</a> 
 open class Section {
     lateinit var enumSection: EnumSection
<a href="#h9-1-3" id="h9-1-3" class="d">-    lateinit var manager: ManagerContext
</a><a href="#h9-1-4" id="h9-1-4" class="i">+    lateinit var context: RemoteSideContext
</a>     lateinit var navController: NavController
 
<a href="#h9-1-7" id="h9-1-7" class="i">+    open fun init() {}
</a><a href="#h9-1-8" id="h9-1-8" class="i">+
</a>     @Composable
     open fun Content() { NotImplemented() }
 
<b>diff --git a/<a id="h10" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/HomeSection.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/HomeSection.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/HomeSection.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/HomeSection.kt</a></b>
<a href="#h10-0" id="h10-0" class="h">@@ -25,6 +25,7 @@ import androidx.compose.ui.unit.dp
</a> import androidx.compose.ui.unit.sp
 import me.rhunk.snapenhance.ui.manager.Section
 import me.rhunk.snapenhance.ui.manager.data.InstallationSummary
<a href="#h10-0-3" id="h10-0-3" class="i">+import me.rhunk.snapenhance.ui.setup.Requirements
</a> 
 class HomeSection : Section() {
     companion object {
<a href="#h10-1" id="h10-1" class="h">@@ -76,7 +77,9 @@ class HomeSection : Section() {
</a>                 )
 
                 //inline button
<a href="#h10-1-3" id="h10-1-3" class="d">-                Button(onClick = {}, modifier = Modifier.height(40.dp)) {
</a><a href="#h10-1-4" id="h10-1-4" class="i">+                Button(onClick = {
</a><a href="#h10-1-5" id="h10-1-5" class="i">+                     context.checkForRequirements(Requirements.MAPPINGS)
</a><a href="#h10-1-6" id="h10-1-6" class="i">+                }, modifier = Modifier.height(40.dp)) {
</a>                     Icon(Icons.Filled.Refresh, contentDescription = &quot;Refresh&quot;)
                 }
             }
<a href="#h10-2" id="h10-2" class="h">@@ -102,7 +105,7 @@ class HomeSection : Section() {
</a>                 modifier = Modifier.padding(16.dp)
             )
 
<a href="#h10-2-3" id="h10-2-3" class="d">-            SummaryCards(manager.getInstallationSummary())
</a><a href="#h10-2-4" id="h10-2-4" class="i">+            SummaryCards(context.getInstallationSummary())
</a>         }
     }
 } 
\ No newline at end of file
<b>diff --git a/<a id="h11" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/features/Dialogs.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/features/Dialogs.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/features/Dialogs.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/features/Dialogs.kt</a></b>
<a href="#h11-0" id="h11-0" class="h">@@ -140,14 +140,22 @@ class Dialogs {
</a>                     Text(text = &quot;Cancel&quot;)
                 }
                 Button(onClick = {
<a href="#h11-0-3" id="h11-0-3" class="d">-                    if (property.key.dataType.type == DataProcessors.Type.INTEGER) {
</a><a href="#h11-0-4" id="h11-0-4" class="d">-                        runCatching {
</a><a href="#h11-0-5" id="h11-0-5" class="d">-                            property.value.setAny(fieldValue.value.text.toInt())
</a><a href="#h11-0-6" id="h11-0-6" class="d">-                        }.onFailure {
</a><a href="#h11-0-7" id="h11-0-7" class="d">-                            property.value.setAny(0)
</a><a href="#h11-0-8" id="h11-0-8" class="i">+                    when (property.key.dataType.type) {
</a><a href="#h11-0-9" id="h11-0-9" class="i">+                        DataProcessors.Type.INTEGER -&gt; {
</a><a href="#h11-0-10" id="h11-0-10" class="i">+                            runCatching {
</a><a href="#h11-0-11" id="h11-0-11" class="i">+                                property.value.setAny(fieldValue.value.text.toInt())
</a><a href="#h11-0-12" id="h11-0-12" class="i">+                            }.onFailure {
</a><a href="#h11-0-13" id="h11-0-13" class="i">+                                property.value.setAny(0)
</a><a href="#h11-0-14" id="h11-0-14" class="i">+                            }
</a>                         }
<a href="#h11-0-16" id="h11-0-16" class="d">-                    } else {
</a><a href="#h11-0-17" id="h11-0-17" class="d">-                        property.value.setAny(fieldValue.value.text)
</a><a href="#h11-0-18" id="h11-0-18" class="i">+                        DataProcessors.Type.FLOAT -&gt; {
</a><a href="#h11-0-19" id="h11-0-19" class="i">+                            runCatching {
</a><a href="#h11-0-20" id="h11-0-20" class="i">+                                property.value.setAny(fieldValue.value.text.toFloat())
</a><a href="#h11-0-21" id="h11-0-21" class="i">+                            }.onFailure {
</a><a href="#h11-0-22" id="h11-0-22" class="i">+                                property.value.setAny(0f)
</a><a href="#h11-0-23" id="h11-0-23" class="i">+                            }
</a><a href="#h11-0-24" id="h11-0-24" class="i">+                        }
</a><a href="#h11-0-25" id="h11-0-25" class="i">+                        else -&gt; property.value.setAny(fieldValue.value.text)
</a>                     }
                     dismiss()
                 }) {
<b>diff --git a/<a id="h12" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/features/FeaturesSection.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/features/FeaturesSection.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/features/FeaturesSection.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/features/FeaturesSection.kt</a></b>
<a href="#h12-0" id="h12-0" class="h">@@ -1,5 +1,6 @@
</a> package me.rhunk.snapenhance.ui.manager.sections.features
 
<a href="#h12-0-2" id="h12-0-2" class="i">+import androidx.activity.ComponentActivity
</a> import androidx.compose.foundation.background
 import androidx.compose.foundation.clickable
 import androidx.compose.foundation.layout.Arrangement
<a href="#h12-1" id="h12-1" class="h">@@ -20,6 +21,7 @@ import androidx.compose.foundation.shape.RoundedCornerShape
</a> import androidx.compose.material.MaterialTheme
 import androidx.compose.material.icons.Icons
 import androidx.compose.material.icons.filled.ArrowBack
<a href="#h12-1-3" id="h12-1-3" class="i">+import androidx.compose.material.icons.filled.FolderOpen
</a> import androidx.compose.material.icons.filled.OpenInNew
 import androidx.compose.material.icons.rounded.Save
 import androidx.compose.material3.Card
<a href="#h12-2" id="h12-2" class="h">@@ -55,6 +57,7 @@ import me.rhunk.snapenhance.core.config.ConfigContainer
</a> import me.rhunk.snapenhance.core.config.DataProcessors
 import me.rhunk.snapenhance.core.config.PropertyPair
 import me.rhunk.snapenhance.ui.manager.Section
<a href="#h12-2-3" id="h12-2-3" class="i">+import me.rhunk.snapenhance.ui.util.ChooseFolderHelper
</a> 
 class FeaturesSection : Section() {
     private val dialogs by lazy { Dialogs() }
<a href="#h12-3" id="h12-3" class="h">@@ -63,6 +66,15 @@ class FeaturesSection : Section() {
</a>         private const val MAIN_ROUTE = &quot;root&quot;
     }
 
<a href="#h12-3-3" id="h12-3-3" class="i">+    private lateinit var openFolderCallback: (uri: String) -&gt; Unit
</a><a href="#h12-3-4" id="h12-3-4" class="i">+    private lateinit var openFolderLauncher: () -&gt; Unit
</a><a href="#h12-3-5" id="h12-3-5" class="i">+
</a><a href="#h12-3-6" id="h12-3-6" class="i">+    override fun init() {
</a><a href="#h12-3-7" id="h12-3-7" class="i">+        openFolderLauncher = ChooseFolderHelper.createChooseFolder(context.activity!! as ComponentActivity) {
</a><a href="#h12-3-8" id="h12-3-8" class="i">+            openFolderCallback(it)
</a><a href="#h12-3-9" id="h12-3-9" class="i">+        }
</a><a href="#h12-3-10" id="h12-3-10" class="i">+    }
</a><a href="#h12-3-11" id="h12-3-11" class="i">+
</a>     @Composable
     private fun PropertyAction(property: PropertyPair&lt;*&gt;, registerClickCallback: RegisterClickCallback) {
         val showDialog = remember { mutableStateOf(false) }
<a href="#h12-4" id="h12-4" class="h">@@ -83,6 +95,18 @@ class FeaturesSection : Section() {
</a> 
         val propertyValue = property.value
 
<a href="#h12-4-3" id="h12-4-3" class="i">+        if (property.key.params.isFolder) {
</a><a href="#h12-4-4" id="h12-4-4" class="i">+            IconButton(onClick = registerClickCallback {
</a><a href="#h12-4-5" id="h12-4-5" class="i">+                openFolderCallback = { uri -&gt;
</a><a href="#h12-4-6" id="h12-4-6" class="i">+                    propertyValue.setAny(uri)
</a><a href="#h12-4-7" id="h12-4-7" class="i">+                }
</a><a href="#h12-4-8" id="h12-4-8" class="i">+                openFolderLauncher()
</a><a href="#h12-4-9" id="h12-4-9" class="i">+            }.let { { it.invoke(true) } }) {
</a><a href="#h12-4-10" id="h12-4-10" class="i">+                Icon(Icons.Filled.FolderOpen, contentDescription = null)
</a><a href="#h12-4-11" id="h12-4-11" class="i">+            }
</a><a href="#h12-4-12" id="h12-4-12" class="i">+            return
</a><a href="#h12-4-13" id="h12-4-13" class="i">+        }
</a><a href="#h12-4-14" id="h12-4-14" class="i">+
</a>         when (val dataType = remember { property.key.dataType.type }) {
             DataProcessors.Type.BOOLEAN -&gt; {
                 val state = remember { mutableStateOf(propertyValue.get() as Boolean) }
<a href="#h12-5" id="h12-5" class="h">@@ -116,7 +140,7 @@ class FeaturesSection : Section() {
</a>                         DataProcessors.Type.STRING_MULTIPLE_SELECTION -&gt; {
                             dialogs.MultipleSelectionDialog(property)
                         }
<a href="#h12-5-3" id="h12-5-3" class="d">-                        DataProcessors.Type.STRING, DataProcessors.Type.INTEGER -&gt; {
</a><a href="#h12-5-4" id="h12-5-4" class="i">+                        DataProcessors.Type.STRING, DataProcessors.Type.INTEGER, DataProcessors.Type.FLOAT -&gt; {
</a>                             dialogs.KeyboardInputDialog(property) { showDialog.value = false }
                         }
                         else -&gt; {}
<a href="#h12-6" id="h12-6" class="h">@@ -124,7 +148,8 @@ class FeaturesSection : Section() {
</a>                 }
 
                 registerDialogOnClickCallback().let { { it.invoke(true) } }.also {
<a href="#h12-6-3" id="h12-6-3" class="d">-                    if (dataType == DataProcessors.Type.INTEGER || dataType == DataProcessors.Type.FLOAT) {
</a><a href="#h12-6-4" id="h12-6-4" class="i">+                    if (dataType == DataProcessors.Type.INTEGER ||
</a><a href="#h12-6-5" id="h12-6-5" class="i">+                        dataType == DataProcessors.Type.FLOAT) {
</a>                         FilledIconButton(onClick = it) {
                             Text(
                                 text = propertyValue.get().toString(),
<a href="#h12-7" id="h12-7" class="h">@@ -256,7 +281,7 @@ class FeaturesSection : Section() {
</a>             floatingActionButton = {
                 FloatingActionButton(
                     onClick = {
<a href="#h12-7-3" id="h12-7-3" class="d">-                        manager.config.writeConfig()
</a><a href="#h12-7-4" id="h12-7-4" class="i">+                        context.config.writeConfig()
</a>                         scope.launch {
                             scaffoldState.snackbarHostState.showSnackbar(&quot;Saved&quot;)
                         }
<a href="#h12-8" id="h12-8" class="h">@@ -299,13 +324,13 @@ class FeaturesSection : Section() {
</a>                     }
                 }
             }
<a href="#h12-8-3" id="h12-8-3" class="d">-            queryContainerRecursive(manager.config.root)
</a><a href="#h12-8-4" id="h12-8-4" class="i">+            queryContainerRecursive(context.config.root)
</a>             containers
         }
 
         navGraphBuilder.navigation(route = &quot;features&quot;, startDestination = MAIN_ROUTE) {
             composable(MAIN_ROUTE) {
<a href="#h12-8-10" id="h12-8-10" class="d">-                Container(MAIN_ROUTE, manager.config.root)
</a><a href="#h12-8-11" id="h12-8-11" class="i">+                Container(MAIN_ROUTE, context.config.root)
</a>             }
 
             composable(&quot;container/{name}&quot;) { backStackEntry -&gt;
<b>diff --git a/<a id="h13" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/util/SaveFolderChecker.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/util/SaveFolderChecker.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/util/SaveFolderChecker.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/util/SaveFolderChecker.kt</a></b>
<a href="#h13-0" id="h13-0" class="h">@@ -1,42 +0,0 @@
</a><a href="#h13-0-0" id="h13-0-0" class="d">-package me.rhunk.snapenhance.ui.manager.util
</a><a href="#h13-0-1" id="h13-0-1" class="d">-
</a><a href="#h13-0-2" id="h13-0-2" class="d">-import android.app.Activity
</a><a href="#h13-0-3" id="h13-0-3" class="d">-import android.app.AlertDialog
</a><a href="#h13-0-4" id="h13-0-4" class="d">-import android.content.Intent
</a><a href="#h13-0-5" id="h13-0-5" class="d">-import android.widget.Toast
</a><a href="#h13-0-6" id="h13-0-6" class="d">-import androidx.activity.ComponentActivity
</a><a href="#h13-0-7" id="h13-0-7" class="d">-import androidx.activity.result.contract.ActivityResultContracts
</a><a href="#h13-0-8" id="h13-0-8" class="d">-import me.rhunk.snapenhance.core.config.PropertyValue
</a><a href="#h13-0-9" id="h13-0-9" class="d">-import kotlin.system.exitProcess
</a><a href="#h13-0-10" id="h13-0-10" class="d">-
</a><a href="#h13-0-11" id="h13-0-11" class="d">-object SaveFolderChecker {
</a><a href="#h13-0-12" id="h13-0-12" class="d">-    fun askForFolder(activity: ComponentActivity, property: PropertyValue&lt;String&gt;, saveConfig: () -&gt; Unit) {
</a><a href="#h13-0-13" id="h13-0-13" class="d">-        if (property.get().isEmpty() || !property.get().startsWith(&quot;content://&quot;)) {
</a><a href="#h13-0-14" id="h13-0-14" class="d">-            val startActivity = activity.registerForActivityResult(ActivityResultContracts.StartActivityForResult()) result@{
</a><a href="#h13-0-15" id="h13-0-15" class="d">-                if (it.resultCode != Activity.RESULT_OK) return@result
</a><a href="#h13-0-16" id="h13-0-16" class="d">-                val uri = it.data?.data ?: return@result
</a><a href="#h13-0-17" id="h13-0-17" class="d">-                val value = uri.toString()
</a><a href="#h13-0-18" id="h13-0-18" class="d">-                activity.contentResolver.takePersistableUriPermission(uri, Intent.FLAG_GRANT_READ_URI_PERMISSION or Intent.FLAG_GRANT_WRITE_URI_PERMISSION)
</a><a href="#h13-0-19" id="h13-0-19" class="d">-                property.set(value)
</a><a href="#h13-0-20" id="h13-0-20" class="d">-                saveConfig()
</a><a href="#h13-0-21" id="h13-0-21" class="d">-                Toast.makeText(activity, &quot;save folder set!&quot;, Toast.LENGTH_SHORT).show()
</a><a href="#h13-0-22" id="h13-0-22" class="d">-                activity.finish()
</a><a href="#h13-0-23" id="h13-0-23" class="d">-            }
</a><a href="#h13-0-24" id="h13-0-24" class="d">-
</a><a href="#h13-0-25" id="h13-0-25" class="d">-            AlertDialog.Builder(activity)
</a><a href="#h13-0-26" id="h13-0-26" class="d">-                .setTitle(&quot;Save folder&quot;)
</a><a href="#h13-0-27" id="h13-0-27" class="d">-                .setMessage(&quot;Please select a folder where you want to save downloaded files.&quot;)
</a><a href="#h13-0-28" id="h13-0-28" class="d">-                .setPositiveButton(&quot;Select&quot;) { _, _ -&gt;
</a><a href="#h13-0-29" id="h13-0-29" class="d">-                    startActivity.launch(
</a><a href="#h13-0-30" id="h13-0-30" class="d">-                        Intent(Intent.ACTION_OPEN_DOCUMENT_TREE)
</a><a href="#h13-0-31" id="h13-0-31" class="d">-                        .addFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION)
</a><a href="#h13-0-32" id="h13-0-32" class="d">-                        .addFlags(Intent.FLAG_GRANT_WRITE_URI_PERMISSION)
</a><a href="#h13-0-33" id="h13-0-33" class="d">-                    )
</a><a href="#h13-0-34" id="h13-0-34" class="d">-                }
</a><a href="#h13-0-35" id="h13-0-35" class="d">-                .setNegativeButton(&quot;Cancel&quot;) { _, _ -&gt;
</a><a href="#h13-0-36" id="h13-0-36" class="d">-                    exitProcess(0)
</a><a href="#h13-0-37" id="h13-0-37" class="d">-                }
</a><a href="#h13-0-38" id="h13-0-38" class="d">-                .show()
</a><a href="#h13-0-39" id="h13-0-39" class="d">-        }
</a><a href="#h13-0-40" id="h13-0-40" class="d">-    }
</a><a href="#h13-0-41" id="h13-0-41" class="d">-}</a><a href="#h13-0-42" id="h13-0-42" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h14" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/Requirements.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/Requirements.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/Requirements.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/Requirements.kt</a></b>
<a href="#h14-0" id="h14-0" class="h">@@ -1,33 +1,21 @@
</a> package me.rhunk.snapenhance.ui.setup
 
<a href="#h14-0-2" id="h14-0-2" class="d">-import android.os.Bundle
</a><a href="#h14-0-3" id="h14-0-3" class="i">+object Requirements {
</a><a href="#h14-0-4" id="h14-0-4" class="i">+    const val FIRST_RUN = 0b00001
</a><a href="#h14-0-5" id="h14-0-5" class="i">+    const val LANGUAGE = 0b00010
</a><a href="#h14-0-6" id="h14-0-6" class="i">+    const val MAPPINGS = 0b00100
</a><a href="#h14-0-7" id="h14-0-7" class="i">+    const val SAVE_FOLDER = 0b01000
</a><a href="#h14-0-8" id="h14-0-8" class="i">+    const val FFMPEG = 0b10000
</a> 
<a href="#h14-0-10" id="h14-0-10" class="d">-data class Requirements(
</a><a href="#h14-0-11" id="h14-0-11" class="d">-    val firstRun: Boolean = false,
</a><a href="#h14-0-12" id="h14-0-12" class="d">-    val language: Boolean = false,
</a><a href="#h14-0-13" id="h14-0-13" class="d">-    val mappings: Boolean = false,
</a><a href="#h14-0-14" id="h14-0-14" class="d">-    val saveFolder: Boolean = false,
</a><a href="#h14-0-15" id="h14-0-15" class="d">-    val ffmpeg: Boolean = false
</a><a href="#h14-0-16" id="h14-0-16" class="d">-) {
</a><a href="#h14-0-17" id="h14-0-17" class="d">-    companion object {
</a><a href="#h14-0-18" id="h14-0-18" class="d">-        fun fromBundle(bundle: Bundle): Requirements {
</a><a href="#h14-0-19" id="h14-0-19" class="d">-            return Requirements(
</a><a href="#h14-0-20" id="h14-0-20" class="d">-                firstRun = bundle.getBoolean(&quot;firstRun&quot;),
</a><a href="#h14-0-21" id="h14-0-21" class="d">-                language = bundle.getBoolean(&quot;language&quot;),
</a><a href="#h14-0-22" id="h14-0-22" class="d">-                mappings = bundle.getBoolean(&quot;mappings&quot;),
</a><a href="#h14-0-23" id="h14-0-23" class="d">-                saveFolder = bundle.getBoolean(&quot;saveFolder&quot;),
</a><a href="#h14-0-24" id="h14-0-24" class="d">-                ffmpeg = bundle.getBoolean(&quot;ffmpeg&quot;)
</a><a href="#h14-0-25" id="h14-0-25" class="d">-            )
</a><a href="#h14-0-26" id="h14-0-26" class="d">-        }
</a><a href="#h14-0-27" id="h14-0-27" class="d">-
</a><a href="#h14-0-28" id="h14-0-28" class="d">-        fun toBundle(requirements: Requirements): Bundle {
</a><a href="#h14-0-29" id="h14-0-29" class="d">-            return Bundle().apply {
</a><a href="#h14-0-30" id="h14-0-30" class="d">-                putBoolean(&quot;firstRun&quot;, requirements.firstRun)
</a><a href="#h14-0-31" id="h14-0-31" class="d">-                putBoolean(&quot;language&quot;, requirements.language)
</a><a href="#h14-0-32" id="h14-0-32" class="d">-                putBoolean(&quot;mappings&quot;, requirements.mappings)
</a><a href="#h14-0-33" id="h14-0-33" class="d">-                putBoolean(&quot;saveFolder&quot;, requirements.saveFolder)
</a><a href="#h14-0-34" id="h14-0-34" class="d">-                putBoolean(&quot;ffmpeg&quot;, requirements.ffmpeg)
</a><a href="#h14-0-35" id="h14-0-35" class="d">-            }
</a><a href="#h14-0-36" id="h14-0-36" class="i">+    fun getName(requirement: Int): String {
</a><a href="#h14-0-37" id="h14-0-37" class="i">+        return when (requirement) {
</a><a href="#h14-0-38" id="h14-0-38" class="i">+            FIRST_RUN -&gt; &quot;FIRST_RUN&quot;
</a><a href="#h14-0-39" id="h14-0-39" class="i">+            LANGUAGE -&gt; &quot;LANGUAGE&quot;
</a><a href="#h14-0-40" id="h14-0-40" class="i">+            MAPPINGS -&gt; &quot;MAPPINGS&quot;
</a><a href="#h14-0-41" id="h14-0-41" class="i">+            SAVE_FOLDER -&gt; &quot;SAVE_FOLDER&quot;
</a><a href="#h14-0-42" id="h14-0-42" class="i">+            FFMPEG -&gt; &quot;FFMPEG&quot;
</a><a href="#h14-0-43" id="h14-0-43" class="i">+            else -&gt; &quot;UNKNOWN&quot;
</a>         }
     }
 }
<a href="#h14-0-47" id="h14-0-47" class="i">+
</a><b>diff --git a/<a id="h15" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/SetupActivity.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/SetupActivity.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/SetupActivity.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/SetupActivity.kt</a></b>
<a href="#h15-0" id="h15-0" class="h">@@ -1,7 +1,9 @@
</a> package me.rhunk.snapenhance.ui.setup
 
<a href="#h15-0-2" id="h15-0-2" class="i">+import android.annotation.SuppressLint
</a> import android.os.Bundle
 import androidx.activity.ComponentActivity
<a href="#h15-0-5" id="h15-0-5" class="i">+import androidx.activity.compose.BackHandler
</a> import androidx.activity.compose.setContent
 import androidx.compose.animation.core.animateFloatAsState
 import androidx.compose.foundation.background
<a href="#h15-1" id="h15-1" class="h">@@ -14,6 +16,7 @@ import androidx.compose.foundation.layout.padding
</a> import androidx.compose.foundation.layout.width
 import androidx.compose.material.icons.Icons
 import androidx.compose.material.icons.filled.ArrowForwardIos
<a href="#h15-1-3" id="h15-1-3" class="i">+import androidx.compose.material.icons.filled.Check
</a> import androidx.compose.material3.FilledIconButton
 import androidx.compose.material3.Icon
 import androidx.compose.material3.MaterialTheme
<a href="#h15-2" id="h15-2" class="h">@@ -28,48 +31,64 @@ import androidx.compose.ui.unit.dp
</a> import androidx.navigation.compose.NavHost
 import androidx.navigation.compose.composable
 import androidx.navigation.compose.rememberNavController
<a href="#h15-2-3" id="h15-2-3" class="i">+import me.rhunk.snapenhance.SharedContextHolder
</a> import me.rhunk.snapenhance.ui.AppMaterialTheme
 import me.rhunk.snapenhance.ui.setup.screens.SetupScreen
 import me.rhunk.snapenhance.ui.setup.screens.impl.FfmpegScreen
<a href="#h15-2-7" id="h15-2-7" class="d">-import me.rhunk.snapenhance.ui.setup.screens.impl.LanguageScreen
</a> import me.rhunk.snapenhance.ui.setup.screens.impl.MappingsScreen
<a href="#h15-2-9" id="h15-2-9" class="i">+import me.rhunk.snapenhance.ui.setup.screens.impl.PickLanguageScreen
</a> import me.rhunk.snapenhance.ui.setup.screens.impl.SaveFolderScreen
<a href="#h15-2-11" id="h15-2-11" class="d">-import me.rhunk.snapenhance.ui.setup.screens.impl.WelcomeScreen
</a> 
 
 class SetupActivity : ComponentActivity() {
<a href="#h15-2-15" id="h15-2-15" class="i">+    @SuppressLint(&quot;UnusedMaterial3ScaffoldPaddingParameter&quot;)
</a>     override fun onCreate(savedInstanceState: Bundle?) {
         super.onCreate(savedInstanceState)
 
<a href="#h15-2-19" id="h15-2-19" class="d">-        val requirements = intent.getBundleExtra(&quot;requirements&quot;)?.let {
</a><a href="#h15-2-20" id="h15-2-20" class="d">-            Requirements.fromBundle(it)
</a><a href="#h15-2-21" id="h15-2-21" class="d">-        } ?: Requirements(firstRun = true)
</a><a href="#h15-2-22" id="h15-2-22" class="i">+        val setupContext = SharedContextHolder.remote(this).apply {
</a><a href="#h15-2-23" id="h15-2-23" class="i">+            activity = this@SetupActivity
</a><a href="#h15-2-24" id="h15-2-24" class="i">+        }
</a><a href="#h15-2-25" id="h15-2-25" class="i">+        val requirements = intent.getIntExtra(&quot;requirements&quot;, Requirements.FIRST_RUN)
</a><a href="#h15-2-26" id="h15-2-26" class="i">+
</a><a href="#h15-2-27" id="h15-2-27" class="i">+        fun hasRequirement(requirement: Int) = requirements and requirement == requirement
</a> 
         val requiredScreens = mutableListOf&lt;SetupScreen&gt;()
 
         with(requiredScreens) {
<a href="#h15-2-32" id="h15-2-32" class="d">-            with(requirements) {
</a><a href="#h15-2-33" id="h15-2-33" class="d">-                if (firstRun || language) add(LanguageScreen().apply { route = &quot;language&quot; })
</a><a href="#h15-2-34" id="h15-2-34" class="d">-                if (firstRun) add(WelcomeScreen().apply { route = &quot;welcome&quot; })
</a><a href="#h15-2-35" id="h15-2-35" class="d">-                if (firstRun || saveFolder) add(SaveFolderScreen().apply { route = &quot;saveFolder&quot; })
</a><a href="#h15-2-36" id="h15-2-36" class="d">-                if (firstRun || mappings) add(MappingsScreen().apply { route = &quot;mappings&quot; })
</a><a href="#h15-2-37" id="h15-2-37" class="d">-                if (firstRun || ffmpeg) add(FfmpegScreen().apply { route = &quot;ffmpeg&quot; })
</a><a href="#h15-2-38" id="h15-2-38" class="i">+            val isFirstRun = hasRequirement(Requirements.FIRST_RUN)
</a><a href="#h15-2-39" id="h15-2-39" class="i">+            if (isFirstRun || hasRequirement(Requirements.LANGUAGE)) {
</a><a href="#h15-2-40" id="h15-2-40" class="i">+                add(PickLanguageScreen().apply { route = &quot;language&quot; })
</a><a href="#h15-2-41" id="h15-2-41" class="i">+            }
</a><a href="#h15-2-42" id="h15-2-42" class="i">+            if (isFirstRun || hasRequirement(Requirements.SAVE_FOLDER)) {
</a><a href="#h15-2-43" id="h15-2-43" class="i">+                add(SaveFolderScreen().apply { route = &quot;saveFolder&quot; })
</a><a href="#h15-2-44" id="h15-2-44" class="i">+            }
</a><a href="#h15-2-45" id="h15-2-45" class="i">+            if (isFirstRun || hasRequirement(Requirements.MAPPINGS)) {
</a><a href="#h15-2-46" id="h15-2-46" class="i">+                add(MappingsScreen().apply { route = &quot;mappings&quot; })
</a><a href="#h15-2-47" id="h15-2-47" class="i">+            }
</a><a href="#h15-2-48" id="h15-2-48" class="i">+            if (isFirstRun || hasRequirement(Requirements.FFMPEG)) {
</a><a href="#h15-2-49" id="h15-2-49" class="i">+                add(FfmpegScreen().apply { route = &quot;ffmpeg&quot; })
</a>             }
         }
 
<a href="#h15-2-53" id="h15-2-53" class="i">+        // If there are no required screens, we can just finish the activity
</a>         if (requiredScreens.isEmpty()) {
             finish()
             return
         }
 
<a href="#h15-2-59" id="h15-2-59" class="i">+        requiredScreens.forEach { screen -&gt;
</a><a href="#h15-2-60" id="h15-2-60" class="i">+            screen.context = setupContext
</a><a href="#h15-2-61" id="h15-2-61" class="i">+            screen.init()
</a><a href="#h15-2-62" id="h15-2-62" class="i">+        }
</a><a href="#h15-2-63" id="h15-2-63" class="i">+
</a>         setContent {
             val navController = rememberNavController()
             val canGoNext = remember { mutableStateOf(false) }
 
             fun nextScreen() {
                 if (!canGoNext.value) return
<a href="#h15-2-70" id="h15-2-70" class="d">-                canGoNext.value = false
</a>                 if (requiredScreens.size &gt; 1) {
<a href="#h15-2-72" id="h15-2-72" class="i">+                    canGoNext.value = false
</a>                     requiredScreens.removeFirst()
                     navController.navigate(requiredScreens.first().route)
                 } else {
<a href="#h15-3" id="h15-3" class="h">@@ -98,18 +117,21 @@ class SetupActivity : ComponentActivity() {
</a>                                     .alpha(alpha)
                             ) {
                                 Icon(
<a href="#h15-3-3" id="h15-3-3" class="d">-                                    imageVector = Icons.Default.ArrowForwardIos,
</a><a href="#h15-3-4" id="h15-3-4" class="i">+                                    imageVector = if (requiredScreens.size &lt;= 1 &amp;&amp; canGoNext.value) {
</a><a href="#h15-3-5" id="h15-3-5" class="i">+                                        Icons.Default.Check
</a><a href="#h15-3-6" id="h15-3-6" class="i">+                                    } else {
</a><a href="#h15-3-7" id="h15-3-7" class="i">+                                        Icons.Default.ArrowForwardIos
</a><a href="#h15-3-8" id="h15-3-8" class="i">+                                    },
</a>                                     contentDescription = null
                                 )
                             }
                         }
                     },
<a href="#h15-3-14" id="h15-3-14" class="d">-                ) { paddingValues -&gt;
</a><a href="#h15-3-15" id="h15-3-15" class="i">+                ) {
</a>                     Column(
                         modifier = Modifier
                             .background(MaterialTheme.colorScheme.background)
                             .fillMaxSize()
<a href="#h15-3-20" id="h15-3-20" class="d">-                            .padding(paddingValues)
</a>                     ) {
                         NavHost(
                             navController = navController,
<a href="#h15-4" id="h15-4" class="h">@@ -118,6 +140,7 @@ class SetupActivity : ComponentActivity() {
</a>                             requiredScreens.forEach { screen -&gt;
                                 screen.allowNext = { canGoNext.value = it }
                                 composable(screen.route) {
<a href="#h15-4-3" id="h15-4-3" class="i">+                                    BackHandler(true) {}
</a>                                     Column(
                                         modifier = Modifier.fillMaxSize(),
                                         verticalArrangement = Arrangement.Center,
<b>diff --git a/<a id="h16" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/SetupContext.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/SetupContext.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/SetupContext.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/SetupContext.kt</a></b>
<a href="#h16-0" id="h16-0" class="h">@@ -1,14 +0,0 @@
</a><a href="#h16-0-0" id="h16-0-0" class="d">-package me.rhunk.snapenhance.ui.setup
</a><a href="#h16-0-1" id="h16-0-1" class="d">-
</a><a href="#h16-0-2" id="h16-0-2" class="d">-import android.content.Context
</a><a href="#h16-0-3" id="h16-0-3" class="d">-import me.rhunk.snapenhance.core.config.ModConfig
</a><a href="#h16-0-4" id="h16-0-4" class="d">-
</a><a href="#h16-0-5" id="h16-0-5" class="d">-class SetupContext(
</a><a href="#h16-0-6" id="h16-0-6" class="d">-    private val context: Context
</a><a href="#h16-0-7" id="h16-0-7" class="d">-) {
</a><a href="#h16-0-8" id="h16-0-8" class="d">-    val config = ModConfig()
</a><a href="#h16-0-9" id="h16-0-9" class="d">-
</a><a href="#h16-0-10" id="h16-0-10" class="d">-    init {
</a><a href="#h16-0-11" id="h16-0-11" class="d">-        config.loadFromContext(context)
</a><a href="#h16-0-12" id="h16-0-12" class="d">-    }
</a><a href="#h16-0-13" id="h16-0-13" class="d">-}</a><a href="#h16-0-14" id="h16-0-14" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h17" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/screens/SetupScreen.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/screens/SetupScreen.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/screens/SetupScreen.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/screens/SetupScreen.kt</a></b>
<a href="#h17-0" id="h17-0" class="h">@@ -1,11 +1,31 @@
</a> package me.rhunk.snapenhance.ui.setup.screens
 
<a href="#h17-0-2" id="h17-0-2" class="i">+import androidx.compose.foundation.layout.padding
</a><a href="#h17-0-3" id="h17-0-3" class="i">+import androidx.compose.material3.Text
</a> import androidx.compose.runtime.Composable
<a href="#h17-0-5" id="h17-0-5" class="i">+import androidx.compose.ui.Modifier
</a><a href="#h17-0-6" id="h17-0-6" class="i">+import androidx.compose.ui.text.font.FontWeight
</a><a href="#h17-0-7" id="h17-0-7" class="i">+import androidx.compose.ui.unit.dp
</a><a href="#h17-0-8" id="h17-0-8" class="i">+import androidx.compose.ui.unit.sp
</a><a href="#h17-0-9" id="h17-0-9" class="i">+import me.rhunk.snapenhance.RemoteSideContext
</a> 
 abstract class SetupScreen {
<a href="#h17-0-12" id="h17-0-12" class="i">+    lateinit var context: RemoteSideContext
</a>     lateinit var allowNext: (Boolean) -&gt; Unit
     lateinit var route: String
 
     @Composable
<a href="#h17-0-17" id="h17-0-17" class="i">+    fun DialogText(text: String, modifier: Modifier = Modifier) {
</a><a href="#h17-0-18" id="h17-0-18" class="i">+        Text(
</a><a href="#h17-0-19" id="h17-0-19" class="i">+            text = text,
</a><a href="#h17-0-20" id="h17-0-20" class="i">+            fontSize = 16.sp,
</a><a href="#h17-0-21" id="h17-0-21" class="i">+            fontWeight = FontWeight.Normal,
</a><a href="#h17-0-22" id="h17-0-22" class="i">+            modifier = Modifier.padding(16.dp).then(modifier)
</a><a href="#h17-0-23" id="h17-0-23" class="i">+        )
</a><a href="#h17-0-24" id="h17-0-24" class="i">+    }
</a><a href="#h17-0-25" id="h17-0-25" class="i">+
</a><a href="#h17-0-26" id="h17-0-26" class="i">+    open fun init() {}
</a><a href="#h17-0-27" id="h17-0-27" class="i">+
</a><a href="#h17-0-28" id="h17-0-28" class="i">+    @Composable
</a>     abstract fun Content()
 } 
\ No newline at end of file
<b>diff --git a/<a id="h18" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/screens/impl/LanguageScreen.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/screens/impl/LanguageScreen.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/screens/impl/LanguageScreen.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/screens/impl/LanguageScreen.kt</a></b>
<a href="#h18-0" id="h18-0" class="h">@@ -1,11 +0,0 @@
</a><a href="#h18-0-0" id="h18-0-0" class="d">-package me.rhunk.snapenhance.ui.setup.screens.impl
</a><a href="#h18-0-1" id="h18-0-1" class="d">-
</a><a href="#h18-0-2" id="h18-0-2" class="d">-import androidx.compose.runtime.Composable
</a><a href="#h18-0-3" id="h18-0-3" class="d">-import me.rhunk.snapenhance.ui.setup.screens.SetupScreen
</a><a href="#h18-0-4" id="h18-0-4" class="d">-
</a><a href="#h18-0-5" id="h18-0-5" class="d">-class LanguageScreen : SetupScreen(){
</a><a href="#h18-0-6" id="h18-0-6" class="d">-    @Composable
</a><a href="#h18-0-7" id="h18-0-7" class="d">-    override fun Content() {
</a><a href="#h18-0-8" id="h18-0-8" class="d">-
</a><a href="#h18-0-9" id="h18-0-9" class="d">-    }
</a><a href="#h18-0-10" id="h18-0-10" class="d">-}</a><a href="#h18-0-11" id="h18-0-11" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h19" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/screens/impl/MappingsScreen.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/screens/impl/MappingsScreen.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/screens/impl/MappingsScreen.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/screens/impl/MappingsScreen.kt</a></b>
<a href="#h19-0" id="h19-0" class="h">@@ -1,16 +1,98 @@
</a> package me.rhunk.snapenhance.ui.setup.screens.impl
 
<a href="#h19-0-2" id="h19-0-2" class="i">+import androidx.compose.foundation.layout.Column
</a><a href="#h19-0-3" id="h19-0-3" class="i">+import androidx.compose.foundation.layout.fillMaxWidth
</a><a href="#h19-0-4" id="h19-0-4" class="i">+import androidx.compose.foundation.layout.padding
</a><a href="#h19-0-5" id="h19-0-5" class="i">+import androidx.compose.foundation.layout.size
</a><a href="#h19-0-6" id="h19-0-6" class="i">+import androidx.compose.foundation.shape.RoundedCornerShape
</a><a href="#h19-0-7" id="h19-0-7" class="i">+import androidx.compose.material.MaterialTheme
</a> import androidx.compose.material3.Button
<a href="#h19-0-9" id="h19-0-9" class="i">+import androidx.compose.material3.CircularProgressIndicator
</a><a href="#h19-0-10" id="h19-0-10" class="i">+import androidx.compose.material3.Surface
</a> import androidx.compose.material3.Text
 import androidx.compose.runtime.Composable
<a href="#h19-0-13" id="h19-0-13" class="i">+import androidx.compose.runtime.mutableStateOf
</a><a href="#h19-0-14" id="h19-0-14" class="i">+import androidx.compose.runtime.remember
</a><a href="#h19-0-15" id="h19-0-15" class="i">+import androidx.compose.runtime.rememberCoroutineScope
</a><a href="#h19-0-16" id="h19-0-16" class="i">+import androidx.compose.ui.Modifier
</a><a href="#h19-0-17" id="h19-0-17" class="i">+import androidx.compose.ui.unit.dp
</a><a href="#h19-0-18" id="h19-0-18" class="i">+import androidx.compose.ui.window.Dialog
</a><a href="#h19-0-19" id="h19-0-19" class="i">+import kotlinx.coroutines.Dispatchers
</a><a href="#h19-0-20" id="h19-0-20" class="i">+import kotlinx.coroutines.launch
</a><a href="#h19-0-21" id="h19-0-21" class="i">+import me.rhunk.snapenhance.Logger
</a> import me.rhunk.snapenhance.ui.setup.screens.SetupScreen
 
 class MappingsScreen : SetupScreen() {
     @Composable
     override fun Content() {
<a href="#h19-0-27" id="h19-0-27" class="d">-        Text(text = &quot;Mappings&quot;)
</a><a href="#h19-0-28" id="h19-0-28" class="d">-        Button(onClick = { allowNext(true) }) {
</a><a href="#h19-0-29" id="h19-0-29" class="d">-            Text(text = &quot;Next&quot;)
</a><a href="#h19-0-30" id="h19-0-30" class="i">+        val coroutineScope = rememberCoroutineScope()
</a><a href="#h19-0-31" id="h19-0-31" class="i">+        val infoText = remember { mutableStateOf(null as String?) }
</a><a href="#h19-0-32" id="h19-0-32" class="i">+        val isGenerating = remember { mutableStateOf(false) }
</a><a href="#h19-0-33" id="h19-0-33" class="i">+
</a><a href="#h19-0-34" id="h19-0-34" class="i">+        if (infoText.value != null) {
</a><a href="#h19-0-35" id="h19-0-35" class="i">+            Dialog(onDismissRequest = {
</a><a href="#h19-0-36" id="h19-0-36" class="i">+                infoText.value = null
</a><a href="#h19-0-37" id="h19-0-37" class="i">+            }) {
</a><a href="#h19-0-38" id="h19-0-38" class="i">+                Surface(
</a><a href="#h19-0-39" id="h19-0-39" class="i">+                    modifier = Modifier.padding(16.dp).fillMaxWidth(),
</a><a href="#h19-0-40" id="h19-0-40" class="i">+                    color = MaterialTheme.colors.surface,
</a><a href="#h19-0-41" id="h19-0-41" class="i">+                    shape = RoundedCornerShape(16.dp),
</a><a href="#h19-0-42" id="h19-0-42" class="i">+                ) {
</a><a href="#h19-0-43" id="h19-0-43" class="i">+                    Column(
</a><a href="#h19-0-44" id="h19-0-44" class="i">+                        modifier = Modifier.padding(16.dp)
</a><a href="#h19-0-45" id="h19-0-45" class="i">+                    ) {
</a><a href="#h19-0-46" id="h19-0-46" class="i">+                        Text(text = infoText.value!!)
</a><a href="#h19-0-47" id="h19-0-47" class="i">+                        Button(onClick = {
</a><a href="#h19-0-48" id="h19-0-48" class="i">+                            infoText.value = null
</a><a href="#h19-0-49" id="h19-0-49" class="i">+                        },
</a><a href="#h19-0-50" id="h19-0-50" class="i">+                        modifier = Modifier.padding(top = 5.dp).align(alignment = androidx.compose.ui.Alignment.End)) {
</a><a href="#h19-0-51" id="h19-0-51" class="i">+                            Text(text = &quot;OK&quot;)
</a><a href="#h19-0-52" id="h19-0-52" class="i">+                        }
</a><a href="#h19-0-53" id="h19-0-53" class="i">+                    }
</a><a href="#h19-0-54" id="h19-0-54" class="i">+                }
</a><a href="#h19-0-55" id="h19-0-55" class="i">+            }
</a><a href="#h19-0-56" id="h19-0-56" class="i">+        }
</a><a href="#h19-0-57" id="h19-0-57" class="i">+
</a><a href="#h19-0-58" id="h19-0-58" class="i">+        fun tryToGenerateMappings() {
</a><a href="#h19-0-59" id="h19-0-59" class="i">+            //check for snapchat installation
</a><a href="#h19-0-60" id="h19-0-60" class="i">+            val installationSummary = context.getInstallationSummary()
</a><a href="#h19-0-61" id="h19-0-61" class="i">+            if (installationSummary.snapchatInfo == null) {
</a><a href="#h19-0-62" id="h19-0-62" class="i">+                throw Exception(context.translation[&quot;setup.mappings.generate_failure_no_snapchat&quot;])
</a><a href="#h19-0-63" id="h19-0-63" class="i">+            }
</a><a href="#h19-0-64" id="h19-0-64" class="i">+            with(context.mappings) {
</a><a href="#h19-0-65" id="h19-0-65" class="i">+                refresh()
</a><a href="#h19-0-66" id="h19-0-66" class="i">+            }
</a><a href="#h19-0-67" id="h19-0-67" class="i">+        }
</a><a href="#h19-0-68" id="h19-0-68" class="i">+
</a><a href="#h19-0-69" id="h19-0-69" class="i">+        val hasMappings = remember { mutableStateOf(false) }
</a><a href="#h19-0-70" id="h19-0-70" class="i">+
</a><a href="#h19-0-71" id="h19-0-71" class="i">+        DialogText(text = context.translation[&quot;setup.mappings.dialog&quot;])
</a><a href="#h19-0-72" id="h19-0-72" class="i">+        if (hasMappings.value) return
</a><a href="#h19-0-73" id="h19-0-73" class="i">+        Button(onClick = {
</a><a href="#h19-0-74" id="h19-0-74" class="i">+            if (isGenerating.value) return@Button
</a><a href="#h19-0-75" id="h19-0-75" class="i">+            isGenerating.value = true
</a><a href="#h19-0-76" id="h19-0-76" class="i">+            coroutineScope.launch(Dispatchers.IO) {
</a><a href="#h19-0-77" id="h19-0-77" class="i">+                runCatching {
</a><a href="#h19-0-78" id="h19-0-78" class="i">+                    tryToGenerateMappings()
</a><a href="#h19-0-79" id="h19-0-79" class="i">+                    allowNext(true)
</a><a href="#h19-0-80" id="h19-0-80" class="i">+                    infoText.value = context.translation[&quot;setup.mappings.generate_success&quot;]
</a><a href="#h19-0-81" id="h19-0-81" class="i">+                    hasMappings.value = true
</a><a href="#h19-0-82" id="h19-0-82" class="i">+                }.onFailure {
</a><a href="#h19-0-83" id="h19-0-83" class="i">+                    isGenerating.value = false
</a><a href="#h19-0-84" id="h19-0-84" class="i">+                    infoText.value = context.translation[&quot;setup.mappings.generate_failure&quot;] + &quot;\n\n&quot; + it.message
</a><a href="#h19-0-85" id="h19-0-85" class="i">+                    Logger.error(&quot;Failed to generate mappings&quot;, it)
</a><a href="#h19-0-86" id="h19-0-86" class="i">+                }
</a><a href="#h19-0-87" id="h19-0-87" class="i">+            }
</a><a href="#h19-0-88" id="h19-0-88" class="i">+        }) {
</a><a href="#h19-0-89" id="h19-0-89" class="i">+            if (isGenerating.value) {
</a><a href="#h19-0-90" id="h19-0-90" class="i">+                CircularProgressIndicator(
</a><a href="#h19-0-91" id="h19-0-91" class="i">+                    modifier = Modifier.padding(end = 5.dp).size(25.dp),
</a><a href="#h19-0-92" id="h19-0-92" class="i">+                    strokeWidth = 2.dp,
</a><a href="#h19-0-93" id="h19-0-93" class="i">+                    color = MaterialTheme.colors.onPrimary
</a><a href="#h19-0-94" id="h19-0-94" class="i">+                )
</a><a href="#h19-0-95" id="h19-0-95" class="i">+            } else {
</a><a href="#h19-0-96" id="h19-0-96" class="i">+                Text(text = context.translation[&quot;setup.mappings.generate_button&quot;])
</a><a href="#h19-0-97" id="h19-0-97" class="i">+            }
</a>         }
     }
 } 
\ No newline at end of file
<b>diff --git a/<a id="h20" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/screens/impl/PickLanguageScreen.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/screens/impl/PickLanguageScreen.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/screens/impl/PickLanguageScreen.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/screens/impl/PickLanguageScreen.kt</a></b>
<a href="#h20-0" id="h20-0" class="h">@@ -0,0 +1,115 @@
</a><a href="#h20-0-0" id="h20-0-0" class="i">+package me.rhunk.snapenhance.ui.setup.screens.impl
</a><a href="#h20-0-1" id="h20-0-1" class="i">+
</a><a href="#h20-0-2" id="h20-0-2" class="i">+import androidx.compose.foundation.clickable
</a><a href="#h20-0-3" id="h20-0-3" class="i">+import androidx.compose.foundation.gestures.Orientation
</a><a href="#h20-0-4" id="h20-0-4" class="i">+import androidx.compose.foundation.gestures.scrollable
</a><a href="#h20-0-5" id="h20-0-5" class="i">+import androidx.compose.foundation.layout.Box
</a><a href="#h20-0-6" id="h20-0-6" class="i">+import androidx.compose.foundation.layout.fillMaxWidth
</a><a href="#h20-0-7" id="h20-0-7" class="i">+import androidx.compose.foundation.layout.height
</a><a href="#h20-0-8" id="h20-0-8" class="i">+import androidx.compose.foundation.layout.padding
</a><a href="#h20-0-9" id="h20-0-9" class="i">+import androidx.compose.foundation.lazy.LazyColumn
</a><a href="#h20-0-10" id="h20-0-10" class="i">+import androidx.compose.foundation.lazy.items
</a><a href="#h20-0-11" id="h20-0-11" class="i">+import androidx.compose.foundation.rememberScrollState
</a><a href="#h20-0-12" id="h20-0-12" class="i">+import androidx.compose.material.Surface
</a><a href="#h20-0-13" id="h20-0-13" class="i">+import androidx.compose.material.Text
</a><a href="#h20-0-14" id="h20-0-14" class="i">+import androidx.compose.material3.MaterialTheme
</a><a href="#h20-0-15" id="h20-0-15" class="i">+import androidx.compose.material3.OutlinedButton
</a><a href="#h20-0-16" id="h20-0-16" class="i">+import androidx.compose.runtime.Composable
</a><a href="#h20-0-17" id="h20-0-17" class="i">+import androidx.compose.runtime.mutableStateOf
</a><a href="#h20-0-18" id="h20-0-18" class="i">+import androidx.compose.runtime.remember
</a><a href="#h20-0-19" id="h20-0-19" class="i">+import androidx.compose.ui.Alignment
</a><a href="#h20-0-20" id="h20-0-20" class="i">+import androidx.compose.ui.Modifier
</a><a href="#h20-0-21" id="h20-0-21" class="i">+import androidx.compose.ui.platform.LocalContext
</a><a href="#h20-0-22" id="h20-0-22" class="i">+import androidx.compose.ui.text.font.FontWeight
</a><a href="#h20-0-23" id="h20-0-23" class="i">+import androidx.compose.ui.unit.dp
</a><a href="#h20-0-24" id="h20-0-24" class="i">+import androidx.compose.ui.unit.sp
</a><a href="#h20-0-25" id="h20-0-25" class="i">+import androidx.compose.ui.window.Dialog
</a><a href="#h20-0-26" id="h20-0-26" class="i">+import me.rhunk.snapenhance.bridge.wrapper.LocaleWrapper
</a><a href="#h20-0-27" id="h20-0-27" class="i">+import me.rhunk.snapenhance.ui.util.ObservableMutableState
</a><a href="#h20-0-28" id="h20-0-28" class="i">+import me.rhunk.snapenhance.ui.setup.screens.SetupScreen
</a><a href="#h20-0-29" id="h20-0-29" class="i">+import java.util.Locale
</a><a href="#h20-0-30" id="h20-0-30" class="i">+
</a><a href="#h20-0-31" id="h20-0-31" class="i">+
</a><a href="#h20-0-32" id="h20-0-32" class="i">+class PickLanguageScreen : SetupScreen(){
</a><a href="#h20-0-33" id="h20-0-33" class="i">+    @Composable
</a><a href="#h20-0-34" id="h20-0-34" class="i">+    override fun Content() {
</a><a href="#h20-0-35" id="h20-0-35" class="i">+        val androidContext = LocalContext.current
</a><a href="#h20-0-36" id="h20-0-36" class="i">+        val availableLocales = remember { LocaleWrapper.fetchAvailableLocales(androidContext) }
</a><a href="#h20-0-37" id="h20-0-37" class="i">+
</a><a href="#h20-0-38" id="h20-0-38" class="i">+        allowNext(true)
</a><a href="#h20-0-39" id="h20-0-39" class="i">+
</a><a href="#h20-0-40" id="h20-0-40" class="i">+        fun getLocaleDisplayName(locale: String): String {
</a><a href="#h20-0-41" id="h20-0-41" class="i">+            locale.split(&quot;_&quot;).let {
</a><a href="#h20-0-42" id="h20-0-42" class="i">+                return java.util.Locale(it[0], it[1]).getDisplayName(java.util.Locale.getDefault())
</a><a href="#h20-0-43" id="h20-0-43" class="i">+            }
</a><a href="#h20-0-44" id="h20-0-44" class="i">+        }
</a><a href="#h20-0-45" id="h20-0-45" class="i">+
</a><a href="#h20-0-46" id="h20-0-46" class="i">+        val selectedLocale = remember {
</a><a href="#h20-0-47" id="h20-0-47" class="i">+            val deviceLocale = Locale.getDefault().toString()
</a><a href="#h20-0-48" id="h20-0-48" class="i">+            fun reloadTranslation(selectedLocale: String) {
</a><a href="#h20-0-49" id="h20-0-49" class="i">+                context.translation.reloadFromContext(androidContext, selectedLocale)
</a><a href="#h20-0-50" id="h20-0-50" class="i">+            }
</a><a href="#h20-0-51" id="h20-0-51" class="i">+            ObservableMutableState(
</a><a href="#h20-0-52" id="h20-0-52" class="i">+                defaultValue = availableLocales.firstOrNull {
</a><a href="#h20-0-53" id="h20-0-53" class="i">+                        locale -&gt; locale == deviceLocale
</a><a href="#h20-0-54" id="h20-0-54" class="i">+                } ?: LocaleWrapper.DEFAULT_LOCALE
</a><a href="#h20-0-55" id="h20-0-55" class="i">+            ) { _, newValue -&gt;
</a><a href="#h20-0-56" id="h20-0-56" class="i">+                context.config.locale = newValue
</a><a href="#h20-0-57" id="h20-0-57" class="i">+                context.config.writeConfig()
</a><a href="#h20-0-58" id="h20-0-58" class="i">+                reloadTranslation(newValue)
</a><a href="#h20-0-59" id="h20-0-59" class="i">+            }.also { reloadTranslation(it.value) }
</a><a href="#h20-0-60" id="h20-0-60" class="i">+        }
</a><a href="#h20-0-61" id="h20-0-61" class="i">+
</a><a href="#h20-0-62" id="h20-0-62" class="i">+        DialogText(text = context.translation[&quot;setup.dialogs.select_language&quot;])
</a><a href="#h20-0-63" id="h20-0-63" class="i">+
</a><a href="#h20-0-64" id="h20-0-64" class="i">+        val isDialog = remember { mutableStateOf(false) }
</a><a href="#h20-0-65" id="h20-0-65" class="i">+
</a><a href="#h20-0-66" id="h20-0-66" class="i">+        if (isDialog.value) {
</a><a href="#h20-0-67" id="h20-0-67" class="i">+            Dialog(onDismissRequest = { isDialog.value = false }) {
</a><a href="#h20-0-68" id="h20-0-68" class="i">+                Surface(
</a><a href="#h20-0-69" id="h20-0-69" class="i">+                    modifier = Modifier
</a><a href="#h20-0-70" id="h20-0-70" class="i">+                        .padding(10.dp)
</a><a href="#h20-0-71" id="h20-0-71" class="i">+                        .fillMaxWidth(),
</a><a href="#h20-0-72" id="h20-0-72" class="i">+                    elevation = 8.dp,
</a><a href="#h20-0-73" id="h20-0-73" class="i">+                    shape = MaterialTheme.shapes.medium
</a><a href="#h20-0-74" id="h20-0-74" class="i">+                ) {
</a><a href="#h20-0-75" id="h20-0-75" class="i">+                    LazyColumn(
</a><a href="#h20-0-76" id="h20-0-76" class="i">+                        modifier = Modifier.scrollable(rememberScrollState(), orientation = Orientation.Vertical)
</a><a href="#h20-0-77" id="h20-0-77" class="i">+                    ) {
</a><a href="#h20-0-78" id="h20-0-78" class="i">+                        items(availableLocales) { locale -&gt;
</a><a href="#h20-0-79" id="h20-0-79" class="i">+                            Box(
</a><a href="#h20-0-80" id="h20-0-80" class="i">+                                modifier = Modifier
</a><a href="#h20-0-81" id="h20-0-81" class="i">+                                    .height(70.dp)
</a><a href="#h20-0-82" id="h20-0-82" class="i">+                                    .fillMaxWidth()
</a><a href="#h20-0-83" id="h20-0-83" class="i">+                                    .clickable {
</a><a href="#h20-0-84" id="h20-0-84" class="i">+                                        selectedLocale.value = locale
</a><a href="#h20-0-85" id="h20-0-85" class="i">+                                        isDialog.value = false
</a><a href="#h20-0-86" id="h20-0-86" class="i">+                                    },
</a><a href="#h20-0-87" id="h20-0-87" class="i">+                                contentAlignment = Alignment.Center
</a><a href="#h20-0-88" id="h20-0-88" class="i">+                            ) {
</a><a href="#h20-0-89" id="h20-0-89" class="i">+                                Text(
</a><a href="#h20-0-90" id="h20-0-90" class="i">+                                    text = getLocaleDisplayName(locale),
</a><a href="#h20-0-91" id="h20-0-91" class="i">+                                    fontSize = 16.sp,
</a><a href="#h20-0-92" id="h20-0-92" class="i">+                                    fontWeight = FontWeight.Light,
</a><a href="#h20-0-93" id="h20-0-93" class="i">+                                )
</a><a href="#h20-0-94" id="h20-0-94" class="i">+                            }
</a><a href="#h20-0-95" id="h20-0-95" class="i">+                        }
</a><a href="#h20-0-96" id="h20-0-96" class="i">+                    }
</a><a href="#h20-0-97" id="h20-0-97" class="i">+                }
</a><a href="#h20-0-98" id="h20-0-98" class="i">+            }
</a><a href="#h20-0-99" id="h20-0-99" class="i">+        }
</a><a href="#h20-0-100" id="h20-0-100" class="i">+
</a><a href="#h20-0-101" id="h20-0-101" class="i">+        Box(
</a><a href="#h20-0-102" id="h20-0-102" class="i">+            modifier = Modifier
</a><a href="#h20-0-103" id="h20-0-103" class="i">+                .padding(top = 40.dp)
</a><a href="#h20-0-104" id="h20-0-104" class="i">+                .fillMaxWidth(),
</a><a href="#h20-0-105" id="h20-0-105" class="i">+            contentAlignment = Alignment.Center
</a><a href="#h20-0-106" id="h20-0-106" class="i">+        ) {
</a><a href="#h20-0-107" id="h20-0-107" class="i">+            OutlinedButton(onClick = {
</a><a href="#h20-0-108" id="h20-0-108" class="i">+                isDialog.value = true
</a><a href="#h20-0-109" id="h20-0-109" class="i">+            }) {
</a><a href="#h20-0-110" id="h20-0-110" class="i">+                Text(text = getLocaleDisplayName(selectedLocale.value), fontSize = 16.sp, fontWeight = FontWeight.Light)
</a><a href="#h20-0-111" id="h20-0-111" class="i">+            }
</a><a href="#h20-0-112" id="h20-0-112" class="i">+        }
</a><a href="#h20-0-113" id="h20-0-113" class="i">+    }
</a><a href="#h20-0-114" id="h20-0-114" class="i">+}</a><a href="#h20-0-115" id="h20-0-115" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h21" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/screens/impl/SaveFolderScreen.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/screens/impl/SaveFolderScreen.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/screens/impl/SaveFolderScreen.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/screens/impl/SaveFolderScreen.kt</a></b>
<a href="#h21-0" id="h21-0" class="h">@@ -1,17 +1,47 @@
</a> package me.rhunk.snapenhance.ui.setup.screens.impl
 
<a href="#h21-0-2" id="h21-0-2" class="i">+import androidx.activity.ComponentActivity
</a><a href="#h21-0-3" id="h21-0-3" class="i">+import androidx.compose.foundation.layout.Spacer
</a><a href="#h21-0-4" id="h21-0-4" class="i">+import androidx.compose.foundation.layout.height
</a> import androidx.compose.material3.Button
 import androidx.compose.material3.Text
 import androidx.compose.runtime.Composable
<a href="#h21-0-8" id="h21-0-8" class="i">+import androidx.compose.ui.Modifier
</a><a href="#h21-0-9" id="h21-0-9" class="i">+import androidx.compose.ui.unit.dp
</a><a href="#h21-0-10" id="h21-0-10" class="i">+import me.rhunk.snapenhance.Logger
</a><a href="#h21-0-11" id="h21-0-11" class="i">+import me.rhunk.snapenhance.ui.util.ObservableMutableState
</a> import me.rhunk.snapenhance.ui.setup.screens.SetupScreen
<a href="#h21-0-13" id="h21-0-13" class="i">+import me.rhunk.snapenhance.ui.util.ChooseFolderHelper
</a> 
 class SaveFolderScreen : SetupScreen() {
<a href="#h21-0-16" id="h21-0-16" class="i">+    private lateinit var saveFolder: ObservableMutableState&lt;String&gt;
</a><a href="#h21-0-17" id="h21-0-17" class="i">+    private lateinit var openFolderLauncher: () -&gt; Unit
</a><a href="#h21-0-18" id="h21-0-18" class="i">+
</a><a href="#h21-0-19" id="h21-0-19" class="i">+    override fun init() {
</a><a href="#h21-0-20" id="h21-0-20" class="i">+        saveFolder = ObservableMutableState(
</a><a href="#h21-0-21" id="h21-0-21" class="i">+                defaultValue = &quot;&quot;,
</a><a href="#h21-0-22" id="h21-0-22" class="i">+                onChange = { _, newValue -&gt;
</a><a href="#h21-0-23" id="h21-0-23" class="i">+                    Logger.debug(newValue)
</a><a href="#h21-0-24" id="h21-0-24" class="i">+                    if (newValue.isNotBlank()) {
</a><a href="#h21-0-25" id="h21-0-25" class="i">+                        context.config.root.downloader.saveFolder.set(newValue)
</a><a href="#h21-0-26" id="h21-0-26" class="i">+                        context.config.writeConfig()
</a><a href="#h21-0-27" id="h21-0-27" class="i">+                        allowNext(true)
</a><a href="#h21-0-28" id="h21-0-28" class="i">+                    }
</a><a href="#h21-0-29" id="h21-0-29" class="i">+                }
</a><a href="#h21-0-30" id="h21-0-30" class="i">+            )
</a><a href="#h21-0-31" id="h21-0-31" class="i">+        openFolderLauncher = ChooseFolderHelper.createChooseFolder(context.activity as ComponentActivity) { uri -&gt;
</a><a href="#h21-0-32" id="h21-0-32" class="i">+            saveFolder.value = uri
</a><a href="#h21-0-33" id="h21-0-33" class="i">+        }
</a><a href="#h21-0-34" id="h21-0-34" class="i">+    }
</a> 
     @Composable
     override fun Content() {
<a href="#h21-0-38" id="h21-0-38" class="d">-        Text(text = &quot;SaveFolder&quot;)
</a><a href="#h21-0-39" id="h21-0-39" class="d">-        Button(onClick = {allowNext(true)}) {
</a><a href="#h21-0-40" id="h21-0-40" class="d">-            Text(text = &quot;Next&quot;)
</a><a href="#h21-0-41" id="h21-0-41" class="i">+        DialogText(text = context.translation[&quot;setup.dialogs.save_folder&quot;])
</a><a href="#h21-0-42" id="h21-0-42" class="i">+        Spacer(modifier = Modifier.height(16.dp))
</a><a href="#h21-0-43" id="h21-0-43" class="i">+        Button(onClick = {
</a><a href="#h21-0-44" id="h21-0-44" class="i">+            openFolderLauncher()
</a><a href="#h21-0-45" id="h21-0-45" class="i">+        }) {
</a><a href="#h21-0-46" id="h21-0-46" class="i">+            Text(text = context.translation[&quot;setup.dialogs.select_save_folder_button&quot;])
</a>         }
     }
 } 
\ No newline at end of file
<b>diff --git a/<a id="h22" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/util/ChooseFolderHelper.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/util/ChooseFolderHelper.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/util/ChooseFolderHelper.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/util/ChooseFolderHelper.kt</a></b>
<a href="#h22-0" id="h22-0" class="h">@@ -0,0 +1,26 @@
</a><a href="#h22-0-0" id="h22-0-0" class="i">+package me.rhunk.snapenhance.ui.util
</a><a href="#h22-0-1" id="h22-0-1" class="i">+
</a><a href="#h22-0-2" id="h22-0-2" class="i">+import android.app.Activity
</a><a href="#h22-0-3" id="h22-0-3" class="i">+import android.content.Intent
</a><a href="#h22-0-4" id="h22-0-4" class="i">+import androidx.activity.ComponentActivity
</a><a href="#h22-0-5" id="h22-0-5" class="i">+import androidx.activity.result.contract.ActivityResultContracts
</a><a href="#h22-0-6" id="h22-0-6" class="i">+
</a><a href="#h22-0-7" id="h22-0-7" class="i">+object ChooseFolderHelper {
</a><a href="#h22-0-8" id="h22-0-8" class="i">+    fun createChooseFolder(activity: ComponentActivity, callback: (uri: String) -&gt; Unit): () -&gt; Unit {
</a><a href="#h22-0-9" id="h22-0-9" class="i">+        val activityResultLauncher = activity.registerForActivityResult(ActivityResultContracts.StartActivityForResult()) result@{
</a><a href="#h22-0-10" id="h22-0-10" class="i">+            if (it.resultCode != Activity.RESULT_OK) return@result
</a><a href="#h22-0-11" id="h22-0-11" class="i">+            val uri = it.data?.data ?: return@result
</a><a href="#h22-0-12" id="h22-0-12" class="i">+            val value = uri.toString()
</a><a href="#h22-0-13" id="h22-0-13" class="i">+            activity.contentResolver.takePersistableUriPermission(uri, Intent.FLAG_GRANT_READ_URI_PERMISSION or Intent.FLAG_GRANT_WRITE_URI_PERMISSION)
</a><a href="#h22-0-14" id="h22-0-14" class="i">+            callback(value)
</a><a href="#h22-0-15" id="h22-0-15" class="i">+        }
</a><a href="#h22-0-16" id="h22-0-16" class="i">+
</a><a href="#h22-0-17" id="h22-0-17" class="i">+        return {
</a><a href="#h22-0-18" id="h22-0-18" class="i">+            activityResultLauncher.launch(
</a><a href="#h22-0-19" id="h22-0-19" class="i">+                Intent(Intent.ACTION_OPEN_DOCUMENT_TREE)
</a><a href="#h22-0-20" id="h22-0-20" class="i">+                .addFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION)
</a><a href="#h22-0-21" id="h22-0-21" class="i">+                .addFlags(Intent.FLAG_GRANT_WRITE_URI_PERMISSION)
</a><a href="#h22-0-22" id="h22-0-22" class="i">+            )
</a><a href="#h22-0-23" id="h22-0-23" class="i">+        }
</a><a href="#h22-0-24" id="h22-0-24" class="i">+    }
</a><a href="#h22-0-25" id="h22-0-25" class="i">+}</a><a href="#h22-0-26" id="h22-0-26" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h23" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/util/ObservableMutableState.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/util/ObservableMutableState.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/util/ObservableMutableState.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/util/ObservableMutableState.kt</a></b>
<a href="#h23-0" id="h23-0" class="h">@@ -0,0 +1,19 @@
</a><a href="#h23-0-0" id="h23-0-0" class="i">+package me.rhunk.snapenhance.ui.util
</a><a href="#h23-0-1" id="h23-0-1" class="i">+
</a><a href="#h23-0-2" id="h23-0-2" class="i">+import androidx.compose.runtime.MutableState
</a><a href="#h23-0-3" id="h23-0-3" class="i">+
</a><a href="#h23-0-4" id="h23-0-4" class="i">+class ObservableMutableState&lt;T&gt;(
</a><a href="#h23-0-5" id="h23-0-5" class="i">+    defaultValue: T,
</a><a href="#h23-0-6" id="h23-0-6" class="i">+    inline val onChange: (T, T) -&gt; Unit = { _, _ -&gt; },
</a><a href="#h23-0-7" id="h23-0-7" class="i">+) : MutableState&lt;T&gt; {
</a><a href="#h23-0-8" id="h23-0-8" class="i">+    private var mutableValue: T = defaultValue
</a><a href="#h23-0-9" id="h23-0-9" class="i">+    override var value: T
</a><a href="#h23-0-10" id="h23-0-10" class="i">+        get() = mutableValue
</a><a href="#h23-0-11" id="h23-0-11" class="i">+        set(value) {
</a><a href="#h23-0-12" id="h23-0-12" class="i">+            val oldValue = mutableValue
</a><a href="#h23-0-13" id="h23-0-13" class="i">+            mutableValue = value
</a><a href="#h23-0-14" id="h23-0-14" class="i">+            onChange(oldValue, value)
</a><a href="#h23-0-15" id="h23-0-15" class="i">+        }
</a><a href="#h23-0-16" id="h23-0-16" class="i">+    override fun component1() = value
</a><a href="#h23-0-17" id="h23-0-17" class="i">+    override fun component2(): (T) -&gt; Unit = { value = it }
</a><a href="#h23-0-18" id="h23-0-18" class="i">+}</a><a href="#h23-0-19" id="h23-0-19" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h24" href="../file/core/src/main/aidl/me/rhunk/snapenhance/bridge/BridgeInterface.aidl.html">core/src/main/aidl/me/rhunk/snapenhance/bridge/BridgeInterface.aidl</a> b/<a href="../file/core/src/main/aidl/me/rhunk/snapenhance/bridge/BridgeInterface.aidl.html">core/src/main/aidl/me/rhunk/snapenhance/bridge/BridgeInterface.aidl</a></b>
<a href="#h24-0" id="h24-0" class="h">@@ -83,11 +83,11 @@ interface BridgeInterface {
</a>         void clearMessageLogger();
 
         /**
<a href="#h24-0-3" id="h24-0-3" class="d">-         * Fetch the translations
</a><a href="#h24-0-4" id="h24-0-4" class="i">+         * Fetch the locales
</a>          *
<a href="#h24-0-6" id="h24-0-6" class="d">-         * @return the translations result
</a><a href="#h24-0-7" id="h24-0-7" class="i">+         * @return the locale result
</a>          */
<a href="#h24-0-9" id="h24-0-9" class="d">-        Map&lt;String, String&gt; fetchTranslations();
</a><a href="#h24-0-10" id="h24-0-10" class="i">+        Map&lt;String, String&gt; fetchLocales(String userLocale);
</a> 
         /**
          * Get check for updates last time
<b>diff --git a/<a id="h25" href="../file/core/src/main/assets/lang/en_US.json.html">core/src/main/assets/lang/en_US.json</a> b/<a href="../file/core/src/main/assets/lang/en_US.json.html">core/src/main/assets/lang/en_US.json</a></b>
<a href="#h25-0" id="h25-0" class="h">@@ -1,4 +1,21 @@
</a> {
<a href="#h25-0-1" id="h25-0-1" class="i">+    &quot;setup&quot;: {
</a><a href="#h25-0-2" id="h25-0-2" class="i">+        &quot;dialogs&quot;: {
</a><a href="#h25-0-3" id="h25-0-3" class="i">+            &quot;select_language&quot;: &quot;Select Language&quot;,
</a><a href="#h25-0-4" id="h25-0-4" class="i">+            &quot;save_folder&quot;: &quot;For downloading snapchat media, you&#39;ll need to choose a save location. This can be changed later in the application settings.&quot;,
</a><a href="#h25-0-5" id="h25-0-5" class="i">+            &quot;select_save_folder_button&quot;: &quot;Select Save Folder&quot;,
</a><a href="#h25-0-6" id="h25-0-6" class="i">+            &quot;mappings&quot;: &quot;To support a wide range of versions, mappings need to be generated for the current snapchat version.&quot;
</a><a href="#h25-0-7" id="h25-0-7" class="i">+        },
</a><a href="#h25-0-8" id="h25-0-8" class="i">+        &quot;mappings&quot;: {
</a><a href="#h25-0-9" id="h25-0-9" class="i">+            &quot;dialog&quot;: &quot;To support a wide range of versions, mappings need to be generated for the current snapchat version.&quot;,
</a><a href="#h25-0-10" id="h25-0-10" class="i">+            &quot;snapchat_not_found&quot;: &quot;Snapchat could not be found on your device. Please install Snapchat and try again.&quot;,
</a><a href="#h25-0-11" id="h25-0-11" class="i">+            &quot;snapchat_not_supported&quot;: &quot;Snapchat is not supported. Please update Snapchat and try again.&quot;,
</a><a href="#h25-0-12" id="h25-0-12" class="i">+            &quot;generate_button&quot;: &quot;Generate&quot;,
</a><a href="#h25-0-13" id="h25-0-13" class="i">+            &quot;generate_error&quot;: &quot;An error occurred while generating mappings. Please try again.&quot;,
</a><a href="#h25-0-14" id="h25-0-14" class="i">+            &quot;generate_success&quot;: &quot;Mappings generated successfully.&quot;
</a><a href="#h25-0-15" id="h25-0-15" class="i">+        }
</a><a href="#h25-0-16" id="h25-0-16" class="i">+    },
</a><a href="#h25-0-17" id="h25-0-17" class="i">+
</a>     &quot;category&quot;: {
         &quot;spying_privacy&quot;: &quot;Spying &amp; Privacy&quot;,
         &quot;media_manager&quot;: &quot;Media Manager&quot;,
<b>diff --git a/<a id="h26" href="../file/core/src/main/assets/lang/fr_FR.json.html">core/src/main/assets/lang/fr_FR.json</a> b/<a href="../file/core/src/main/assets/lang/fr_FR.json.html">core/src/main/assets/lang/fr_FR.json</a></b>
<a href="#h26-0" id="h26-0" class="h">@@ -1,4 +1,12 @@
</a> {
<a href="#h26-0-1" id="h26-0-1" class="i">+    &quot;setup&quot;: {
</a><a href="#h26-0-2" id="h26-0-2" class="i">+        &quot;dialogs&quot;: {
</a><a href="#h26-0-3" id="h26-0-3" class="i">+            &quot;select_language&quot;: &quot;Selectionner une langue&quot;,
</a><a href="#h26-0-4" id="h26-0-4" class="i">+            &quot;save_folder&quot;: &quot;Pour télécharger les médias Snapchat, vous devez choisir un emplacement de sauvegarde. Cela peut être modifié plus tard dans les paramètres de l&#39;application.&quot;,
</a><a href="#h26-0-5" id="h26-0-5" class="i">+            &quot;select_save_folder_button&quot;: &quot;Choisir un emplacement de sauvegarde&quot;
</a><a href="#h26-0-6" id="h26-0-6" class="i">+        }
</a><a href="#h26-0-7" id="h26-0-7" class="i">+    },
</a><a href="#h26-0-8" id="h26-0-8" class="i">+
</a>     &quot;category&quot;: {
         &quot;spying_privacy&quot;: &quot;Espionnage et vie privée&quot;,
         &quot;media_manager&quot;: &quot;Gestionnaire de média&quot;,
<b>diff --git a/<a id="h27" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/Logger.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/Logger.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/Logger.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/Logger.kt</a></b>
<a href="#h27-0" id="h27-0" class="h">@@ -16,6 +16,11 @@ object Logger {
</a>         Log.d(TAG, message.toString())
     }
 
<a href="#h27-0-3" id="h27-0-3" class="i">+    fun debug(tag: String, message: Any?) {
</a><a href="#h27-0-4" id="h27-0-4" class="i">+        if (!BuildConfig.DEBUG) return
</a><a href="#h27-0-5" id="h27-0-5" class="i">+        Log.d(tag, message.toString())
</a><a href="#h27-0-6" id="h27-0-6" class="i">+    }
</a><a href="#h27-0-7" id="h27-0-7" class="i">+
</a>     fun error(throwable: Throwable) {
         Log.e(TAG, &quot;&quot;, throwable)
     }
<b>diff --git a/<a id="h28" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/ModContext.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/ModContext.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/ModContext.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/ModContext.kt</a></b>
<a href="#h28-0" id="h28-0" class="h">@@ -122,4 +122,8 @@ class ModContext {
</a>     fun reloadConfig() {
         modConfig.loadFromBridge(bridgeClient)
     }
<a href="#h28-0-3" id="h28-0-3" class="i">+
</a><a href="#h28-0-4" id="h28-0-4" class="i">+    fun getConfigLocale(): String {
</a><a href="#h28-0-5" id="h28-0-5" class="i">+        return modConfig.locale
</a><a href="#h28-0-6" id="h28-0-6" class="i">+    }
</a> } 
\ No newline at end of file
<b>diff --git a/<a id="h29" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/SnapEnhance.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/SnapEnhance.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/SnapEnhance.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/SnapEnhance.kt</a></b>
<a href="#h29-0" id="h29-0" class="h">@@ -90,14 +90,14 @@ class SnapEnhance {
</a> 
     @OptIn(ExperimentalTime::class)
     private suspend fun init() {
<a href="#h29-0-3" id="h29-0-3" class="d">-        //load translations in a coroutine to speed up initialization
</a><a href="#h29-0-4" id="h29-0-4" class="d">-        withContext(appContext.coroutineDispatcher) {
</a><a href="#h29-0-5" id="h29-0-5" class="d">-            appContext.translation.loadFromBridge(appContext.bridgeClient)
</a><a href="#h29-0-6" id="h29-0-6" class="d">-        }
</a><a href="#h29-0-7" id="h29-0-7" class="d">-
</a>         measureTime {
             with(appContext) {
                 reloadConfig()
<a href="#h29-0-11" id="h29-0-11" class="i">+                withContext(appContext.coroutineDispatcher) {
</a><a href="#h29-0-12" id="h29-0-12" class="i">+                    translation.userLocale = getConfigLocale()
</a><a href="#h29-0-13" id="h29-0-13" class="i">+                    translation.loadFromBridge(appContext.bridgeClient)
</a><a href="#h29-0-14" id="h29-0-14" class="i">+                }
</a><a href="#h29-0-15" id="h29-0-15" class="i">+
</a>                 mappings.init()
                 eventDispatcher.init()
                 //if mappings aren&#39;t loaded, we can&#39;t initialize features
<b>diff --git a/<a id="h30" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/bridge/BridgeClient.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/bridge/BridgeClient.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/bridge/BridgeClient.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/bridge/BridgeClient.kt</a></b>
<a href="#h30-0" id="h30-0" class="h">@@ -36,8 +36,9 @@ class BridgeClient(
</a>                 .addFlags(Intent.FLAG_ACTIVITY_NEW_TASK or Intent.FLAG_ACTIVITY_MULTIPLE_TASK)
             )
 
<a href="#h30-0-3" id="h30-0-3" class="i">+            //TODO: randomize package name
</a>             val intent = Intent()
<a href="#h30-0-5" id="h30-0-5" class="d">-                .setClassName(BuildConfig.APPLICATION_ID, BridgeService::class.java.name)
</a><a href="#h30-0-6" id="h30-0-6" class="i">+                .setClassName(BuildConfig.APPLICATION_ID, &quot;me.rhunk.snapenhance.bridge.BridgeService&quot;)
</a>             if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.Q) {
                 bindService(
                     intent,
<a href="#h30-1" id="h30-1" class="h">@@ -103,7 +104,7 @@ class BridgeClient(
</a> 
     fun clearMessageLogger() = service.clearMessageLogger()
 
<a href="#h30-1-3" id="h30-1-3" class="d">-    fun fetchTranslations() = service.fetchTranslations().map {
</a><a href="#h30-1-4" id="h30-1-4" class="i">+    fun fetchLocales(userLocale: String) = service.fetchLocales(userLocale).map {
</a>         LocalePair(it.key, it.value)
     }
 
<b>diff --git a/<a id="h31" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/bridge/BridgeService.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/bridge/BridgeService.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/bridge/BridgeService.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/bridge/BridgeService.kt</a></b>
<a href="#h31-0" id="h31-0" class="h">@@ -1,105 +0,0 @@
</a><a href="#h31-0-0" id="h31-0-0" class="d">-package me.rhunk.snapenhance.bridge
</a><a href="#h31-0-1" id="h31-0-1" class="d">-
</a><a href="#h31-0-2" id="h31-0-2" class="d">-import android.app.Service
</a><a href="#h31-0-3" id="h31-0-3" class="d">-import android.content.Intent
</a><a href="#h31-0-4" id="h31-0-4" class="d">-import android.os.IBinder
</a><a href="#h31-0-5" id="h31-0-5" class="d">-import me.rhunk.snapenhance.SharedContext
</a><a href="#h31-0-6" id="h31-0-6" class="d">-import me.rhunk.snapenhance.bridge.types.BridgeFileType
</a><a href="#h31-0-7" id="h31-0-7" class="d">-import me.rhunk.snapenhance.bridge.wrapper.MessageLoggerWrapper
</a><a href="#h31-0-8" id="h31-0-8" class="d">-import me.rhunk.snapenhance.bridge.wrapper.LocaleWrapper
</a><a href="#h31-0-9" id="h31-0-9" class="d">-import me.rhunk.snapenhance.download.DownloadProcessor
</a><a href="#h31-0-10" id="h31-0-10" class="d">-
</a><a href="#h31-0-11" id="h31-0-11" class="d">-class BridgeService : Service() {
</a><a href="#h31-0-12" id="h31-0-12" class="d">-    private lateinit var messageLoggerWrapper: MessageLoggerWrapper
</a><a href="#h31-0-13" id="h31-0-13" class="d">-    override fun onBind(intent: Intent): IBinder {
</a><a href="#h31-0-14" id="h31-0-14" class="d">-        messageLoggerWrapper = MessageLoggerWrapper(getDatabasePath(BridgeFileType.MESSAGE_LOGGER_DATABASE.fileName)).also { it.init() }
</a><a href="#h31-0-15" id="h31-0-15" class="d">-        return BridgeBinder()
</a><a href="#h31-0-16" id="h31-0-16" class="d">-    }
</a><a href="#h31-0-17" id="h31-0-17" class="d">-
</a><a href="#h31-0-18" id="h31-0-18" class="d">-    inner class BridgeBinder : BridgeInterface.Stub() {
</a><a href="#h31-0-19" id="h31-0-19" class="d">-        override fun createAndReadFile(fileType: Int, defaultContent: ByteArray?): ByteArray {
</a><a href="#h31-0-20" id="h31-0-20" class="d">-            val file = BridgeFileType.fromValue(fileType)?.resolve(this@BridgeService)
</a><a href="#h31-0-21" id="h31-0-21" class="d">-                ?: return defaultContent ?: ByteArray(0)
</a><a href="#h31-0-22" id="h31-0-22" class="d">-
</a><a href="#h31-0-23" id="h31-0-23" class="d">-            if (!file.exists()) {
</a><a href="#h31-0-24" id="h31-0-24" class="d">-                if (defaultContent == null) {
</a><a href="#h31-0-25" id="h31-0-25" class="d">-                    return ByteArray(0)
</a><a href="#h31-0-26" id="h31-0-26" class="d">-                }
</a><a href="#h31-0-27" id="h31-0-27" class="d">-
</a><a href="#h31-0-28" id="h31-0-28" class="d">-                file.writeBytes(defaultContent)
</a><a href="#h31-0-29" id="h31-0-29" class="d">-            }
</a><a href="#h31-0-30" id="h31-0-30" class="d">-
</a><a href="#h31-0-31" id="h31-0-31" class="d">-            return file.readBytes()
</a><a href="#h31-0-32" id="h31-0-32" class="d">-        }
</a><a href="#h31-0-33" id="h31-0-33" class="d">-
</a><a href="#h31-0-34" id="h31-0-34" class="d">-        override fun readFile(fileType: Int): ByteArray {
</a><a href="#h31-0-35" id="h31-0-35" class="d">-            val file = BridgeFileType.fromValue(fileType)?.resolve(this@BridgeService)
</a><a href="#h31-0-36" id="h31-0-36" class="d">-                ?: return ByteArray(0)
</a><a href="#h31-0-37" id="h31-0-37" class="d">-
</a><a href="#h31-0-38" id="h31-0-38" class="d">-            if (!file.exists()) {
</a><a href="#h31-0-39" id="h31-0-39" class="d">-                return ByteArray(0)
</a><a href="#h31-0-40" id="h31-0-40" class="d">-            }
</a><a href="#h31-0-41" id="h31-0-41" class="d">-
</a><a href="#h31-0-42" id="h31-0-42" class="d">-            return file.readBytes()
</a><a href="#h31-0-43" id="h31-0-43" class="d">-        }
</a><a href="#h31-0-44" id="h31-0-44" class="d">-
</a><a href="#h31-0-45" id="h31-0-45" class="d">-        override fun writeFile(fileType: Int, content: ByteArray?): Boolean {
</a><a href="#h31-0-46" id="h31-0-46" class="d">-            val file = BridgeFileType.fromValue(fileType)?.resolve(this@BridgeService)
</a><a href="#h31-0-47" id="h31-0-47" class="d">-                ?: return false
</a><a href="#h31-0-48" id="h31-0-48" class="d">-
</a><a href="#h31-0-49" id="h31-0-49" class="d">-            if (content == null) {
</a><a href="#h31-0-50" id="h31-0-50" class="d">-                return false
</a><a href="#h31-0-51" id="h31-0-51" class="d">-            }
</a><a href="#h31-0-52" id="h31-0-52" class="d">-
</a><a href="#h31-0-53" id="h31-0-53" class="d">-            file.writeBytes(content)
</a><a href="#h31-0-54" id="h31-0-54" class="d">-            return true
</a><a href="#h31-0-55" id="h31-0-55" class="d">-        }
</a><a href="#h31-0-56" id="h31-0-56" class="d">-
</a><a href="#h31-0-57" id="h31-0-57" class="d">-        override fun deleteFile(fileType: Int): Boolean {
</a><a href="#h31-0-58" id="h31-0-58" class="d">-            val file = BridgeFileType.fromValue(fileType)?.resolve(this@BridgeService)
</a><a href="#h31-0-59" id="h31-0-59" class="d">-                ?: return false
</a><a href="#h31-0-60" id="h31-0-60" class="d">-
</a><a href="#h31-0-61" id="h31-0-61" class="d">-            if (!file.exists()) {
</a><a href="#h31-0-62" id="h31-0-62" class="d">-                return false
</a><a href="#h31-0-63" id="h31-0-63" class="d">-            }
</a><a href="#h31-0-64" id="h31-0-64" class="d">-
</a><a href="#h31-0-65" id="h31-0-65" class="d">-            return file.delete()
</a><a href="#h31-0-66" id="h31-0-66" class="d">-        }
</a><a href="#h31-0-67" id="h31-0-67" class="d">-
</a><a href="#h31-0-68" id="h31-0-68" class="d">-        override fun isFileExists(fileType: Int): Boolean {
</a><a href="#h31-0-69" id="h31-0-69" class="d">-            val file = BridgeFileType.fromValue(fileType)?.resolve(this@BridgeService)
</a><a href="#h31-0-70" id="h31-0-70" class="d">-                ?: return false
</a><a href="#h31-0-71" id="h31-0-71" class="d">-
</a><a href="#h31-0-72" id="h31-0-72" class="d">-            return file.exists()
</a><a href="#h31-0-73" id="h31-0-73" class="d">-        }
</a><a href="#h31-0-74" id="h31-0-74" class="d">-
</a><a href="#h31-0-75" id="h31-0-75" class="d">-        override fun getLoggedMessageIds(conversationId: String, limit: Int) = messageLoggerWrapper.getMessageIds(conversationId, limit).toLongArray()
</a><a href="#h31-0-76" id="h31-0-76" class="d">-
</a><a href="#h31-0-77" id="h31-0-77" class="d">-        override fun getMessageLoggerMessage(conversationId: String, id: Long) = messageLoggerWrapper.getMessage(conversationId, id).second
</a><a href="#h31-0-78" id="h31-0-78" class="d">-
</a><a href="#h31-0-79" id="h31-0-79" class="d">-        override fun addMessageLoggerMessage(conversationId: String, id: Long, message: ByteArray) {
</a><a href="#h31-0-80" id="h31-0-80" class="d">-            messageLoggerWrapper.addMessage(conversationId, id, message)
</a><a href="#h31-0-81" id="h31-0-81" class="d">-        }
</a><a href="#h31-0-82" id="h31-0-82" class="d">-
</a><a href="#h31-0-83" id="h31-0-83" class="d">-        override fun deleteMessageLoggerMessage(conversationId: String, id: Long) = messageLoggerWrapper.deleteMessage(conversationId, id)
</a><a href="#h31-0-84" id="h31-0-84" class="d">-
</a><a href="#h31-0-85" id="h31-0-85" class="d">-        override fun clearMessageLogger() = messageLoggerWrapper.clearMessages()
</a><a href="#h31-0-86" id="h31-0-86" class="d">-
</a><a href="#h31-0-87" id="h31-0-87" class="d">-        override fun fetchTranslations() = LocaleWrapper.fetchLocales(context = this@BridgeService).associate {
</a><a href="#h31-0-88" id="h31-0-88" class="d">-            it.locale to it.content
</a><a href="#h31-0-89" id="h31-0-89" class="d">-        }
</a><a href="#h31-0-90" id="h31-0-90" class="d">-
</a><a href="#h31-0-91" id="h31-0-91" class="d">-        override fun getAutoUpdaterTime(): Long {
</a><a href="#h31-0-92" id="h31-0-92" class="d">-            throw UnsupportedOperationException()
</a><a href="#h31-0-93" id="h31-0-93" class="d">-        }
</a><a href="#h31-0-94" id="h31-0-94" class="d">-
</a><a href="#h31-0-95" id="h31-0-95" class="d">-        override fun setAutoUpdaterTime(time: Long) {
</a><a href="#h31-0-96" id="h31-0-96" class="d">-            throw UnsupportedOperationException()
</a><a href="#h31-0-97" id="h31-0-97" class="d">-        }
</a><a href="#h31-0-98" id="h31-0-98" class="d">-
</a><a href="#h31-0-99" id="h31-0-99" class="d">-        override fun enqueueDownload(intent: Intent, callback: DownloadCallback) {
</a><a href="#h31-0-100" id="h31-0-100" class="d">-            SharedContext.ensureInitialized(this@BridgeService)
</a><a href="#h31-0-101" id="h31-0-101" class="d">-            DownloadProcessor(this@BridgeService, callback).onReceive(intent)
</a><a href="#h31-0-102" id="h31-0-102" class="d">-        }
</a><a href="#h31-0-103" id="h31-0-103" class="d">-    }
</a><a href="#h31-0-104" id="h31-0-104" class="d">-}
</a><b>diff --git a/<a id="h32" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/bridge/wrapper/LocaleWrapper.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/bridge/wrapper/LocaleWrapper.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/bridge/wrapper/LocaleWrapper.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/bridge/wrapper/LocaleWrapper.kt</a></b>
<a href="#h32-0" id="h32-0" class="h">@@ -13,15 +13,14 @@ class LocaleWrapper {
</a>     companion object {
         const val DEFAULT_LOCALE = &quot;en_US&quot;
 
<a href="#h32-0-3" id="h32-0-3" class="d">-        fun fetchLocales(context: Context): List&lt;LocalePair&gt; {
</a><a href="#h32-0-4" id="h32-0-4" class="d">-            val deviceLocale = Locale.getDefault().toString()
</a><a href="#h32-0-5" id="h32-0-5" class="d">-            val locales = mutableListOf&lt;LocalePair&gt;()
</a><a href="#h32-0-6" id="h32-0-6" class="d">-
</a><a href="#h32-0-7" id="h32-0-7" class="d">-            locales.add(LocalePair(DEFAULT_LOCALE, context.resources.assets.open(&quot;lang/$DEFAULT_LOCALE.json&quot;).bufferedReader().use { it.readText() }))
</a><a href="#h32-0-8" id="h32-0-8" class="i">+        fun fetchLocales(context: Context, locale: String = DEFAULT_LOCALE): List&lt;LocalePair&gt; {
</a><a href="#h32-0-9" id="h32-0-9" class="i">+            val locales = mutableListOf&lt;LocalePair&gt;().apply {
</a><a href="#h32-0-10" id="h32-0-10" class="i">+                add(LocalePair(DEFAULT_LOCALE, context.resources.assets.open(&quot;lang/$DEFAULT_LOCALE.json&quot;).bufferedReader().use { it.readText() }))
</a><a href="#h32-0-11" id="h32-0-11" class="i">+            }
</a> 
<a href="#h32-0-13" id="h32-0-13" class="d">-            if (deviceLocale == DEFAULT_LOCALE) return locales
</a><a href="#h32-0-14" id="h32-0-14" class="i">+            if (locale == DEFAULT_LOCALE) return locales
</a> 
<a href="#h32-0-16" id="h32-0-16" class="d">-            val compatibleLocale = context.resources.assets.list(&quot;lang&quot;)?.firstOrNull { it.startsWith(deviceLocale) }?.substring(0, 5) ?: return locales
</a><a href="#h32-0-17" id="h32-0-17" class="i">+            val compatibleLocale = context.resources.assets.list(&quot;lang&quot;)?.firstOrNull { it.startsWith(locale) }?.substring(0, 5) ?: return locales
</a> 
             context.resources.assets.open(&quot;lang/$compatibleLocale.json&quot;).use { inputStream -&gt;
                 locales.add(LocalePair(compatibleLocale, inputStream.bufferedReader().use { it.readText() }))
<a href="#h32-1" id="h32-1" class="h">@@ -29,19 +28,24 @@ class LocaleWrapper {
</a> 
             return locales
         }
<a href="#h32-1-3" id="h32-1-3" class="i">+
</a><a href="#h32-1-4" id="h32-1-4" class="i">+        fun fetchAvailableLocales(context: Context): List&lt;String&gt; {
</a><a href="#h32-1-5" id="h32-1-5" class="i">+            return context.resources.assets.list(&quot;lang&quot;)?.map { it.substring(0, 5) } ?: listOf()
</a><a href="#h32-1-6" id="h32-1-6" class="i">+        }
</a>     }
 
<a href="#h32-1-9" id="h32-1-9" class="i">+    var userLocale = DEFAULT_LOCALE
</a> 
     private val translationMap = linkedMapOf&lt;String, String&gt;()
<a href="#h32-1-12" id="h32-1-12" class="d">-    private lateinit var _locale: String
</a><a href="#h32-1-13" id="h32-1-13" class="i">+    private lateinit var _loadedLocaleString: String
</a> 
<a href="#h32-1-15" id="h32-1-15" class="d">-    val locale by lazy {
</a><a href="#h32-1-16" id="h32-1-16" class="d">-        Locale(_locale.substring(0, 2), _locale.substring(3, 5))
</a><a href="#h32-1-17" id="h32-1-17" class="i">+    val loadedLocale by lazy {
</a><a href="#h32-1-18" id="h32-1-18" class="i">+        Locale(_loadedLocaleString.substring(0, 2), _loadedLocaleString.substring(3, 5))
</a>     }
 
     private fun load(localePair: LocalePair) {
<a href="#h32-1-22" id="h32-1-22" class="d">-        if (!::_locale.isInitialized) {
</a><a href="#h32-1-23" id="h32-1-23" class="d">-            _locale = localePair.locale
</a><a href="#h32-1-24" id="h32-1-24" class="i">+        if (!::_loadedLocaleString.isInitialized) {
</a><a href="#h32-1-25" id="h32-1-25" class="i">+            _loadedLocaleString = localePair.locale
</a>         }
 
         val translations = JsonParser.parseString(localePair.content).asJsonObject
<a href="#h32-2" id="h32-2" class="h">@@ -64,17 +68,23 @@ class LocaleWrapper {
</a>     }
 
     fun loadFromBridge(bridgeClient: BridgeClient) {
<a href="#h32-2-3" id="h32-2-3" class="d">-        bridgeClient.fetchTranslations().forEach {
</a><a href="#h32-2-4" id="h32-2-4" class="i">+        bridgeClient.fetchLocales(userLocale).forEach {
</a>             load(it)
         }
     }
 
     fun loadFromContext(context: Context) {
<a href="#h32-2-10" id="h32-2-10" class="d">-        fetchLocales(context).forEach {
</a><a href="#h32-2-11" id="h32-2-11" class="i">+        fetchLocales(context, userLocale).forEach {
</a>             load(it)
         }
     }
 
<a href="#h32-2-16" id="h32-2-16" class="i">+    fun reloadFromContext(context: Context, locale: String) {
</a><a href="#h32-2-17" id="h32-2-17" class="i">+        userLocale = locale
</a><a href="#h32-2-18" id="h32-2-18" class="i">+        translationMap.clear()
</a><a href="#h32-2-19" id="h32-2-19" class="i">+        loadFromContext(context)
</a><a href="#h32-2-20" id="h32-2-20" class="i">+    }
</a><a href="#h32-2-21" id="h32-2-21" class="i">+
</a>     operator fun get(key: String): String {
         return translationMap[key] ?: key.also { Logger.debug(&quot;Missing translation for $key&quot;) }
     }
<b>diff --git a/<a id="h33" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/bridge/wrapper/MappingsWrapper.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/bridge/wrapper/MappingsWrapper.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/bridge/wrapper/MappingsWrapper.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/bridge/wrapper/MappingsWrapper.kt</a></b>
<a href="#h33-0" id="h33-0" class="h">@@ -46,7 +46,6 @@ class MappingsWrapper(
</a>     private val mappings = ConcurrentHashMap&lt;String, Any&gt;()
     private var snapBuildNumber: Long = 0
 
<a href="#h33-0-3" id="h33-0-3" class="d">-    @Suppress(&quot;deprecation&quot;)
</a>     fun init() {
         snapBuildNumber = getSnapchatVersionCode()
 
<a href="#h33-1" id="h33-1" class="h">@@ -54,6 +53,7 @@ class MappingsWrapper(
</a>             runCatching {
                 loadCached()
             }.onFailure {
<a href="#h33-1-3" id="h33-1-3" class="i">+                Logger.error(&quot;Failed to load cached mappings&quot;, it)
</a>                 delete()
             }
         }
<a href="#h33-2" id="h33-2" class="h">@@ -100,6 +100,7 @@ class MappingsWrapper(
</a>     }
 
     fun refresh() {
<a href="#h33-2-3" id="h33-2-3" class="i">+        snapBuildNumber = getSnapchatVersionCode()
</a>         val mapper = Mapper(*mappers)
 
         runCatching {
<a href="#h33-3" id="h33-3" class="h">@@ -114,7 +115,7 @@ class MappingsWrapper(
</a>             }
             write(result.toString().toByteArray())
         }.also {
<a href="#h33-3-3" id="h33-3-3" class="d">-            Logger.xposedLog(&quot;Generated mappings in $it ms&quot;)
</a><a href="#h33-3-4" id="h33-3-4" class="i">+            Logger.debug(&quot;Generated mappings in $it ms&quot;)
</a>         }
     }
 
<b>diff --git a/<a id="h34" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/config/ConfigContainer.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/config/ConfigContainer.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/config/ConfigContainer.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/config/ConfigContainer.kt</a></b>
<a href="#h34-0" id="h34-0" class="h">@@ -38,7 +38,7 @@ open class ConfigContainer(
</a>         vararg values: String = emptyArray(),
         params: ConfigParamsBuilder = {}
     ) = registerProperty(key,
<a href="#h34-0-3" id="h34-0-3" class="d">-        DataProcessors.STRING_MULTIPLE_SELECTION, PropertyValue(emptyList&lt;String&gt;(), defaultValues = values.toList()), params)
</a><a href="#h34-0-4" id="h34-0-4" class="i">+        DataProcessors.STRING_MULTIPLE_SELECTION, PropertyValue(mutableListOf&lt;String&gt;(), defaultValues = values.toList()), params)
</a> 
     //null value is considered as Off/Disabled
     protected fun unique(
<b>diff --git a/<a id="h35" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/config/ModConfig.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/config/ModConfig.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/config/ModConfig.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/config/ModConfig.kt</a></b>
<a href="#h35-0" id="h35-0" class="h">@@ -10,22 +10,20 @@ import me.rhunk.snapenhance.bridge.FileLoaderWrapper
</a> import me.rhunk.snapenhance.bridge.types.BridgeFileType
 import me.rhunk.snapenhance.bridge.wrapper.LocaleWrapper
 import me.rhunk.snapenhance.core.config.impl.RootConfig
<a href="#h35-0-3" id="h35-0-3" class="i">+import kotlin.properties.Delegates
</a> 
 class ModConfig {
<a href="#h35-0-6" id="h35-0-6" class="d">-
</a>     var locale: String = LocaleWrapper.DEFAULT_LOCALE
<a href="#h35-0-8" id="h35-0-8" class="d">-        set(value) {
</a><a href="#h35-0-9" id="h35-0-9" class="d">-            field = value
</a><a href="#h35-0-10" id="h35-0-10" class="d">-            writeConfig()
</a><a href="#h35-0-11" id="h35-0-11" class="d">-        }
</a> 
     private val gson: Gson = GsonBuilder().setPrettyPrinting().create()
     private val file = FileLoaderWrapper(BridgeFileType.CONFIG, &quot;{}&quot;.toByteArray(Charsets.UTF_8))
<a href="#h35-0-15" id="h35-0-15" class="i">+    var wasPresent by Delegates.notNull&lt;Boolean&gt;()
</a> 
     val root = RootConfig()
     operator fun getValue(thisRef: Any?, property: Any?) = root
 
     private fun load() {
<a href="#h35-0-21" id="h35-0-21" class="i">+        wasPresent = file.isFileExists()
</a>         if (!file.isFileExists()) {
             writeConfig()
             return
<a href="#h35-1" id="h35-1" class="h">@@ -42,12 +40,13 @@ class ModConfig {
</a>     private fun loadConfig() {
         val configFileContent = file.read()
         val configObject = gson.fromJson(configFileContent.toString(Charsets.UTF_8), JsonObject::class.java)
<a href="#h35-1-3" id="h35-1-3" class="d">-        locale = configObject.get(&quot;language&quot;)?.asString ?: LocaleWrapper.DEFAULT_LOCALE
</a><a href="#h35-1-4" id="h35-1-4" class="i">+        locale = configObject.get(&quot;_locale&quot;)?.asString ?: LocaleWrapper.DEFAULT_LOCALE
</a><a href="#h35-1-5" id="h35-1-5" class="i">+        root.fromJson(configObject)
</a>     }
 
     fun writeConfig() {
         val configObject = root.toJson()
<a href="#h35-1-10" id="h35-1-10" class="d">-        configObject.addProperty(&quot;language&quot;, locale)
</a><a href="#h35-1-11" id="h35-1-11" class="i">+        configObject.addProperty(&quot;_locale&quot;, locale)
</a>         file.write(configObject.toString().toByteArray(Charsets.UTF_8))
     }
 
<b>diff --git a/<a id="h36" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/download/DownloadManagerClient.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/download/DownloadManagerClient.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/download/DownloadManagerClient.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/download/DownloadManagerClient.kt</a></b>
<a href="#h36-0" id="h36-0" class="h">@@ -16,11 +16,16 @@ class DownloadManagerClient (
</a>     private val metadata: DownloadMetadata,
     private val callback: DownloadCallback
 ) {
<a href="#h36-0-3" id="h36-0-3" class="i">+    companion object {
</a><a href="#h36-0-4" id="h36-0-4" class="i">+        const val DOWNLOAD_REQUEST_EXTRA = &quot;request&quot;
</a><a href="#h36-0-5" id="h36-0-5" class="i">+        const val DOWNLOAD_METADATA_EXTRA = &quot;metadata&quot;
</a><a href="#h36-0-6" id="h36-0-6" class="i">+    }
</a><a href="#h36-0-7" id="h36-0-7" class="i">+
</a>     private fun enqueueDownloadRequest(request: DownloadRequest) {
         context.bridgeClient.enqueueDownload(Intent().apply {
             putExtras(Bundle().apply {
<a href="#h36-0-11" id="h36-0-11" class="d">-                putString(DownloadProcessor.DOWNLOAD_REQUEST_EXTRA, context.gson.toJson(request))
</a><a href="#h36-0-12" id="h36-0-12" class="d">-                putString(DownloadProcessor.DOWNLOAD_METADATA_EXTRA, context.gson.toJson(metadata))
</a><a href="#h36-0-13" id="h36-0-13" class="i">+                putString(DOWNLOAD_REQUEST_EXTRA, context.gson.toJson(request))
</a><a href="#h36-0-14" id="h36-0-14" class="i">+                putString(DOWNLOAD_METADATA_EXTRA, context.gson.toJson(metadata))
</a>             })
         }, callback)
     }
<b>diff --git a/<a id="h37" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/download/DownloadProcessor.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/download/DownloadProcessor.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/download/DownloadProcessor.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/download/DownloadProcessor.kt</a></b>
<a href="#h37-0" id="h37-0" class="h">@@ -1,386 +0,0 @@
</a><a href="#h37-0-0" id="h37-0-0" class="d">-package me.rhunk.snapenhance.download
</a><a href="#h37-0-1" id="h37-0-1" class="d">-
</a><a href="#h37-0-2" id="h37-0-2" class="d">-import android.annotation.SuppressLint
</a><a href="#h37-0-3" id="h37-0-3" class="d">-import android.content.Context
</a><a href="#h37-0-4" id="h37-0-4" class="d">-import android.content.Intent
</a><a href="#h37-0-5" id="h37-0-5" class="d">-import android.net.Uri
</a><a href="#h37-0-6" id="h37-0-6" class="d">-import android.widget.Toast
</a><a href="#h37-0-7" id="h37-0-7" class="d">-import androidx.documentfile.provider.DocumentFile
</a><a href="#h37-0-8" id="h37-0-8" class="d">-import com.google.gson.GsonBuilder
</a><a href="#h37-0-9" id="h37-0-9" class="d">-import kotlinx.coroutines.CoroutineScope
</a><a href="#h37-0-10" id="h37-0-10" class="d">-import kotlinx.coroutines.Dispatchers
</a><a href="#h37-0-11" id="h37-0-11" class="d">-import kotlinx.coroutines.Job
</a><a href="#h37-0-12" id="h37-0-12" class="d">-import kotlinx.coroutines.job
</a><a href="#h37-0-13" id="h37-0-13" class="d">-import kotlinx.coroutines.joinAll
</a><a href="#h37-0-14" id="h37-0-14" class="d">-import kotlinx.coroutines.launch
</a><a href="#h37-0-15" id="h37-0-15" class="d">-import kotlinx.coroutines.runBlocking
</a><a href="#h37-0-16" id="h37-0-16" class="d">-import me.rhunk.snapenhance.Constants
</a><a href="#h37-0-17" id="h37-0-17" class="d">-import me.rhunk.snapenhance.Logger
</a><a href="#h37-0-18" id="h37-0-18" class="d">-import me.rhunk.snapenhance.SharedContext
</a><a href="#h37-0-19" id="h37-0-19" class="d">-import me.rhunk.snapenhance.bridge.DownloadCallback
</a><a href="#h37-0-20" id="h37-0-20" class="d">-import me.rhunk.snapenhance.core.config.ModConfig
</a><a href="#h37-0-21" id="h37-0-21" class="d">-import me.rhunk.snapenhance.data.FileType
</a><a href="#h37-0-22" id="h37-0-22" class="d">-import me.rhunk.snapenhance.download.data.DownloadMetadata
</a><a href="#h37-0-23" id="h37-0-23" class="d">-import me.rhunk.snapenhance.download.data.DownloadRequest
</a><a href="#h37-0-24" id="h37-0-24" class="d">-import me.rhunk.snapenhance.download.data.InputMedia
</a><a href="#h37-0-25" id="h37-0-25" class="d">-import me.rhunk.snapenhance.download.data.MediaEncryptionKeyPair
</a><a href="#h37-0-26" id="h37-0-26" class="d">-import me.rhunk.snapenhance.download.data.PendingDownload
</a><a href="#h37-0-27" id="h37-0-27" class="d">-import me.rhunk.snapenhance.download.enums.DownloadMediaType
</a><a href="#h37-0-28" id="h37-0-28" class="d">-import me.rhunk.snapenhance.download.enums.DownloadStage
</a><a href="#h37-0-29" id="h37-0-29" class="d">-import me.rhunk.snapenhance.util.download.RemoteMediaResolver
</a><a href="#h37-0-30" id="h37-0-30" class="d">-import me.rhunk.snapenhance.util.snap.MediaDownloaderHelper
</a><a href="#h37-0-31" id="h37-0-31" class="d">-import java.io.File
</a><a href="#h37-0-32" id="h37-0-32" class="d">-import java.io.InputStream
</a><a href="#h37-0-33" id="h37-0-33" class="d">-import java.net.HttpURLConnection
</a><a href="#h37-0-34" id="h37-0-34" class="d">-import java.net.URL
</a><a href="#h37-0-35" id="h37-0-35" class="d">-import java.util.zip.ZipInputStream
</a><a href="#h37-0-36" id="h37-0-36" class="d">-import javax.crypto.Cipher
</a><a href="#h37-0-37" id="h37-0-37" class="d">-import javax.crypto.CipherInputStream
</a><a href="#h37-0-38" id="h37-0-38" class="d">-import javax.crypto.spec.IvParameterSpec
</a><a href="#h37-0-39" id="h37-0-39" class="d">-import javax.crypto.spec.SecretKeySpec
</a><a href="#h37-0-40" id="h37-0-40" class="d">-import javax.xml.parsers.DocumentBuilderFactory
</a><a href="#h37-0-41" id="h37-0-41" class="d">-import javax.xml.transform.TransformerFactory
</a><a href="#h37-0-42" id="h37-0-42" class="d">-import javax.xml.transform.dom.DOMSource
</a><a href="#h37-0-43" id="h37-0-43" class="d">-import javax.xml.transform.stream.StreamResult
</a><a href="#h37-0-44" id="h37-0-44" class="d">-import kotlin.coroutines.coroutineContext
</a><a href="#h37-0-45" id="h37-0-45" class="d">-import kotlin.io.encoding.Base64
</a><a href="#h37-0-46" id="h37-0-46" class="d">-import kotlin.io.encoding.ExperimentalEncodingApi
</a><a href="#h37-0-47" id="h37-0-47" class="d">-
</a><a href="#h37-0-48" id="h37-0-48" class="d">-data class DownloadedFile(
</a><a href="#h37-0-49" id="h37-0-49" class="d">-    val file: File,
</a><a href="#h37-0-50" id="h37-0-50" class="d">-    val fileType: FileType
</a><a href="#h37-0-51" id="h37-0-51" class="d">-)
</a><a href="#h37-0-52" id="h37-0-52" class="d">-
</a><a href="#h37-0-53" id="h37-0-53" class="d">-/**
</a><a href="#h37-0-54" id="h37-0-54" class="d">- * DownloadProcessor handles the download requests of the user
</a><a href="#h37-0-55" id="h37-0-55" class="d">- */
</a><a href="#h37-0-56" id="h37-0-56" class="d">-@OptIn(ExperimentalEncodingApi::class)
</a><a href="#h37-0-57" id="h37-0-57" class="d">-class DownloadProcessor (
</a><a href="#h37-0-58" id="h37-0-58" class="d">-    private val context: Context,
</a><a href="#h37-0-59" id="h37-0-59" class="d">-    private val callback: DownloadCallback
</a><a href="#h37-0-60" id="h37-0-60" class="d">-) {
</a><a href="#h37-0-61" id="h37-0-61" class="d">-    companion object {
</a><a href="#h37-0-62" id="h37-0-62" class="d">-        const val DOWNLOAD_REQUEST_EXTRA = &quot;request&quot;
</a><a href="#h37-0-63" id="h37-0-63" class="d">-        const val DOWNLOAD_METADATA_EXTRA = &quot;metadata&quot;
</a><a href="#h37-0-64" id="h37-0-64" class="d">-    }
</a><a href="#h37-0-65" id="h37-0-65" class="d">-
</a><a href="#h37-0-66" id="h37-0-66" class="d">-    private val translation by lazy {
</a><a href="#h37-0-67" id="h37-0-67" class="d">-        SharedContext.translation.getCategory(&quot;download_processor&quot;)
</a><a href="#h37-0-68" id="h37-0-68" class="d">-    }
</a><a href="#h37-0-69" id="h37-0-69" class="d">-
</a><a href="#h37-0-70" id="h37-0-70" class="d">-    private val gson by lazy {
</a><a href="#h37-0-71" id="h37-0-71" class="d">-        GsonBuilder().setPrettyPrinting().create()
</a><a href="#h37-0-72" id="h37-0-72" class="d">-    }
</a><a href="#h37-0-73" id="h37-0-73" class="d">-
</a><a href="#h37-0-74" id="h37-0-74" class="d">-    private fun fallbackToast(message: Any) {
</a><a href="#h37-0-75" id="h37-0-75" class="d">-        android.os.Handler(context.mainLooper).post {
</a><a href="#h37-0-76" id="h37-0-76" class="d">-            Toast.makeText(context, message.toString(), Toast.LENGTH_SHORT).show()
</a><a href="#h37-0-77" id="h37-0-77" class="d">-        }
</a><a href="#h37-0-78" id="h37-0-78" class="d">-    }
</a><a href="#h37-0-79" id="h37-0-79" class="d">-
</a><a href="#h37-0-80" id="h37-0-80" class="d">-    private fun extractZip(inputStream: InputStream): List&lt;File&gt; {
</a><a href="#h37-0-81" id="h37-0-81" class="d">-        val files = mutableListOf&lt;File&gt;()
</a><a href="#h37-0-82" id="h37-0-82" class="d">-        val zipInputStream = ZipInputStream(inputStream)
</a><a href="#h37-0-83" id="h37-0-83" class="d">-        var entry = zipInputStream.nextEntry
</a><a href="#h37-0-84" id="h37-0-84" class="d">-
</a><a href="#h37-0-85" id="h37-0-85" class="d">-        while (entry != null) {
</a><a href="#h37-0-86" id="h37-0-86" class="d">-            createMediaTempFile().also { file -&gt;
</a><a href="#h37-0-87" id="h37-0-87" class="d">-                file.outputStream().use { outputStream -&gt;
</a><a href="#h37-0-88" id="h37-0-88" class="d">-                    zipInputStream.copyTo(outputStream)
</a><a href="#h37-0-89" id="h37-0-89" class="d">-                }
</a><a href="#h37-0-90" id="h37-0-90" class="d">-                files += file
</a><a href="#h37-0-91" id="h37-0-91" class="d">-            }
</a><a href="#h37-0-92" id="h37-0-92" class="d">-            entry = zipInputStream.nextEntry
</a><a href="#h37-0-93" id="h37-0-93" class="d">-        }
</a><a href="#h37-0-94" id="h37-0-94" class="d">-
</a><a href="#h37-0-95" id="h37-0-95" class="d">-        return files
</a><a href="#h37-0-96" id="h37-0-96" class="d">-    }
</a><a href="#h37-0-97" id="h37-0-97" class="d">-
</a><a href="#h37-0-98" id="h37-0-98" class="d">-    private fun decryptInputStream(inputStream: InputStream, encryption: MediaEncryptionKeyPair): InputStream {
</a><a href="#h37-0-99" id="h37-0-99" class="d">-        val cipher = Cipher.getInstance(&quot;AES/CBC/PKCS5Padding&quot;)
</a><a href="#h37-0-100" id="h37-0-100" class="d">-        val key = Base64.UrlSafe.decode(encryption.key)
</a><a href="#h37-0-101" id="h37-0-101" class="d">-        val iv = Base64.UrlSafe.decode(encryption.iv)
</a><a href="#h37-0-102" id="h37-0-102" class="d">-        cipher.init(Cipher.DECRYPT_MODE, SecretKeySpec(key, &quot;AES&quot;), IvParameterSpec(iv))
</a><a href="#h37-0-103" id="h37-0-103" class="d">-        return CipherInputStream(inputStream, cipher)
</a><a href="#h37-0-104" id="h37-0-104" class="d">-    }
</a><a href="#h37-0-105" id="h37-0-105" class="d">-
</a><a href="#h37-0-106" id="h37-0-106" class="d">-    private fun createNeededDirectories(file: File): File {
</a><a href="#h37-0-107" id="h37-0-107" class="d">-        val directory = file.parentFile ?: return file
</a><a href="#h37-0-108" id="h37-0-108" class="d">-        if (!directory.exists()) {
</a><a href="#h37-0-109" id="h37-0-109" class="d">-            directory.mkdirs()
</a><a href="#h37-0-110" id="h37-0-110" class="d">-        }
</a><a href="#h37-0-111" id="h37-0-111" class="d">-        return file
</a><a href="#h37-0-112" id="h37-0-112" class="d">-    }
</a><a href="#h37-0-113" id="h37-0-113" class="d">-
</a><a href="#h37-0-114" id="h37-0-114" class="d">-    @SuppressLint(&quot;UnspecifiedRegisterReceiverFlag&quot;)
</a><a href="#h37-0-115" id="h37-0-115" class="d">-    private suspend fun saveMediaToGallery(inputFile: File, pendingDownload: PendingDownload) {
</a><a href="#h37-0-116" id="h37-0-116" class="d">-        if (coroutineContext.job.isCancelled) return
</a><a href="#h37-0-117" id="h37-0-117" class="d">-
</a><a href="#h37-0-118" id="h37-0-118" class="d">-        val config by ModConfig().apply { loadFromContext(context) }
</a><a href="#h37-0-119" id="h37-0-119" class="d">-
</a><a href="#h37-0-120" id="h37-0-120" class="d">-        runCatching {
</a><a href="#h37-0-121" id="h37-0-121" class="d">-            val fileType = FileType.fromFile(inputFile)
</a><a href="#h37-0-122" id="h37-0-122" class="d">-            if (fileType == FileType.UNKNOWN) {
</a><a href="#h37-0-123" id="h37-0-123" class="d">-                callback.onFailure(translation.format(&quot;failed_gallery_toast&quot;, &quot;error&quot; to &quot;Unknown media type&quot;), null)
</a><a href="#h37-0-124" id="h37-0-124" class="d">-                return
</a><a href="#h37-0-125" id="h37-0-125" class="d">-            }
</a><a href="#h37-0-126" id="h37-0-126" class="d">-
</a><a href="#h37-0-127" id="h37-0-127" class="d">-            val fileName = pendingDownload.metadata.outputPath.substringAfterLast(&quot;/&quot;) + &quot;.&quot; + fileType.fileExtension
</a><a href="#h37-0-128" id="h37-0-128" class="d">-
</a><a href="#h37-0-129" id="h37-0-129" class="d">-            val outputFolder = DocumentFile.fromTreeUri(context, Uri.parse(config.downloader.saveFolder.get()))
</a><a href="#h37-0-130" id="h37-0-130" class="d">-                ?: throw Exception(&quot;Failed to open output folder&quot;)
</a><a href="#h37-0-131" id="h37-0-131" class="d">-
</a><a href="#h37-0-132" id="h37-0-132" class="d">-            val outputFileFolder = pendingDownload.metadata.outputPath.let {
</a><a href="#h37-0-133" id="h37-0-133" class="d">-                if (it.contains(&quot;/&quot;)) {
</a><a href="#h37-0-134" id="h37-0-134" class="d">-                    it.substringBeforeLast(&quot;/&quot;).split(&quot;/&quot;).fold(outputFolder) { folder, name -&gt;
</a><a href="#h37-0-135" id="h37-0-135" class="d">-                        folder.findFile(name) ?: folder.createDirectory(name)!!
</a><a href="#h37-0-136" id="h37-0-136" class="d">-                    }
</a><a href="#h37-0-137" id="h37-0-137" class="d">-                } else {
</a><a href="#h37-0-138" id="h37-0-138" class="d">-                    outputFolder
</a><a href="#h37-0-139" id="h37-0-139" class="d">-                }
</a><a href="#h37-0-140" id="h37-0-140" class="d">-            }
</a><a href="#h37-0-141" id="h37-0-141" class="d">-
</a><a href="#h37-0-142" id="h37-0-142" class="d">-            val outputFile = outputFileFolder.createFile(fileType.mimeType, fileName)!!
</a><a href="#h37-0-143" id="h37-0-143" class="d">-            val outputStream = context.contentResolver.openOutputStream(outputFile.uri)!!
</a><a href="#h37-0-144" id="h37-0-144" class="d">-
</a><a href="#h37-0-145" id="h37-0-145" class="d">-            inputFile.inputStream().use { inputStream -&gt;
</a><a href="#h37-0-146" id="h37-0-146" class="d">-                inputStream.copyTo(outputStream)
</a><a href="#h37-0-147" id="h37-0-147" class="d">-            }
</a><a href="#h37-0-148" id="h37-0-148" class="d">-
</a><a href="#h37-0-149" id="h37-0-149" class="d">-            pendingDownload.outputFile = outputFile.uri.toString()
</a><a href="#h37-0-150" id="h37-0-150" class="d">-            pendingDownload.downloadStage = DownloadStage.SAVED
</a><a href="#h37-0-151" id="h37-0-151" class="d">-
</a><a href="#h37-0-152" id="h37-0-152" class="d">-            runCatching {
</a><a href="#h37-0-153" id="h37-0-153" class="d">-                val mediaScanIntent = Intent(&quot;android.intent.action.MEDIA_SCANNER_SCAN_FILE&quot;)
</a><a href="#h37-0-154" id="h37-0-154" class="d">-                mediaScanIntent.setData(outputFile.uri)
</a><a href="#h37-0-155" id="h37-0-155" class="d">-                context.sendBroadcast(mediaScanIntent)
</a><a href="#h37-0-156" id="h37-0-156" class="d">-            }.onFailure {
</a><a href="#h37-0-157" id="h37-0-157" class="d">-                Logger.error(&quot;Failed to scan media file&quot;, it)
</a><a href="#h37-0-158" id="h37-0-158" class="d">-                callback.onFailure(translation.format(&quot;failed_gallery_toast&quot;, &quot;error&quot; to it.toString()), it.message)
</a><a href="#h37-0-159" id="h37-0-159" class="d">-            }
</a><a href="#h37-0-160" id="h37-0-160" class="d">-
</a><a href="#h37-0-161" id="h37-0-161" class="d">-            Logger.debug(&quot;download complete&quot;)
</a><a href="#h37-0-162" id="h37-0-162" class="d">-            fileName.let {
</a><a href="#h37-0-163" id="h37-0-163" class="d">-                runCatching { callback.onSuccess(it) }.onFailure { fallbackToast(it) }
</a><a href="#h37-0-164" id="h37-0-164" class="d">-            }
</a><a href="#h37-0-165" id="h37-0-165" class="d">-        }.onFailure { exception -&gt;
</a><a href="#h37-0-166" id="h37-0-166" class="d">-            Logger.error(exception)
</a><a href="#h37-0-167" id="h37-0-167" class="d">-            translation.format(&quot;failed_gallery_toast&quot;, &quot;error&quot; to exception.toString()).let {
</a><a href="#h37-0-168" id="h37-0-168" class="d">-                runCatching { callback.onFailure(it, exception.message) }.onFailure { fallbackToast(it) }
</a><a href="#h37-0-169" id="h37-0-169" class="d">-            }
</a><a href="#h37-0-170" id="h37-0-170" class="d">-            pendingDownload.downloadStage = DownloadStage.FAILED
</a><a href="#h37-0-171" id="h37-0-171" class="d">-        }
</a><a href="#h37-0-172" id="h37-0-172" class="d">-    }
</a><a href="#h37-0-173" id="h37-0-173" class="d">-
</a><a href="#h37-0-174" id="h37-0-174" class="d">-    private fun createMediaTempFile(): File {
</a><a href="#h37-0-175" id="h37-0-175" class="d">-        return File.createTempFile(&quot;media&quot;, &quot;.tmp&quot;)
</a><a href="#h37-0-176" id="h37-0-176" class="d">-    }
</a><a href="#h37-0-177" id="h37-0-177" class="d">-
</a><a href="#h37-0-178" id="h37-0-178" class="d">-    private fun downloadInputMedias(downloadRequest: DownloadRequest) = runBlocking {
</a><a href="#h37-0-179" id="h37-0-179" class="d">-        val jobs = mutableListOf&lt;Job&gt;()
</a><a href="#h37-0-180" id="h37-0-180" class="d">-        val downloadedMedias = mutableMapOf&lt;InputMedia, File&gt;()
</a><a href="#h37-0-181" id="h37-0-181" class="d">-
</a><a href="#h37-0-182" id="h37-0-182" class="d">-        downloadRequest.inputMedias.forEach { inputMedia -&gt;
</a><a href="#h37-0-183" id="h37-0-183" class="d">-            fun handleInputStream(inputStream: InputStream) {
</a><a href="#h37-0-184" id="h37-0-184" class="d">-                createMediaTempFile().apply {
</a><a href="#h37-0-185" id="h37-0-185" class="d">-                    if (inputMedia.encryption != null) {
</a><a href="#h37-0-186" id="h37-0-186" class="d">-                        decryptInputStream(inputStream, inputMedia.encryption).use { decryptedInputStream -&gt;
</a><a href="#h37-0-187" id="h37-0-187" class="d">-                            decryptedInputStream.copyTo(outputStream())
</a><a href="#h37-0-188" id="h37-0-188" class="d">-                        }
</a><a href="#h37-0-189" id="h37-0-189" class="d">-                    } else {
</a><a href="#h37-0-190" id="h37-0-190" class="d">-                        inputStream.copyTo(outputStream())
</a><a href="#h37-0-191" id="h37-0-191" class="d">-                    }
</a><a href="#h37-0-192" id="h37-0-192" class="d">-                }.also { downloadedMedias[inputMedia] = it }
</a><a href="#h37-0-193" id="h37-0-193" class="d">-            }
</a><a href="#h37-0-194" id="h37-0-194" class="d">-
</a><a href="#h37-0-195" id="h37-0-195" class="d">-            launch {
</a><a href="#h37-0-196" id="h37-0-196" class="d">-                when (inputMedia.type) {
</a><a href="#h37-0-197" id="h37-0-197" class="d">-                    DownloadMediaType.PROTO_MEDIA -&gt; {
</a><a href="#h37-0-198" id="h37-0-198" class="d">-                        RemoteMediaResolver.downloadBoltMedia(Base64.UrlSafe.decode(inputMedia.content))?.let { inputStream -&gt;
</a><a href="#h37-0-199" id="h37-0-199" class="d">-                            handleInputStream(inputStream)
</a><a href="#h37-0-200" id="h37-0-200" class="d">-                        }
</a><a href="#h37-0-201" id="h37-0-201" class="d">-                    }
</a><a href="#h37-0-202" id="h37-0-202" class="d">-                    DownloadMediaType.DIRECT_MEDIA -&gt; {
</a><a href="#h37-0-203" id="h37-0-203" class="d">-                        val decoded = Base64.UrlSafe.decode(inputMedia.content)
</a><a href="#h37-0-204" id="h37-0-204" class="d">-                        createMediaTempFile().apply {
</a><a href="#h37-0-205" id="h37-0-205" class="d">-                            writeBytes(decoded)
</a><a href="#h37-0-206" id="h37-0-206" class="d">-                        }.also { downloadedMedias[inputMedia] = it }
</a><a href="#h37-0-207" id="h37-0-207" class="d">-                    }
</a><a href="#h37-0-208" id="h37-0-208" class="d">-                    DownloadMediaType.REMOTE_MEDIA -&gt; {
</a><a href="#h37-0-209" id="h37-0-209" class="d">-                        with(URL(inputMedia.content).openConnection() as HttpURLConnection) {
</a><a href="#h37-0-210" id="h37-0-210" class="d">-                            requestMethod = &quot;GET&quot;
</a><a href="#h37-0-211" id="h37-0-211" class="d">-                            setRequestProperty(&quot;User-Agent&quot;, Constants.USER_AGENT)
</a><a href="#h37-0-212" id="h37-0-212" class="d">-                            connect()
</a><a href="#h37-0-213" id="h37-0-213" class="d">-                            handleInputStream(inputStream)
</a><a href="#h37-0-214" id="h37-0-214" class="d">-                        }
</a><a href="#h37-0-215" id="h37-0-215" class="d">-                    }
</a><a href="#h37-0-216" id="h37-0-216" class="d">-                    else -&gt; {
</a><a href="#h37-0-217" id="h37-0-217" class="d">-                        downloadedMedias[inputMedia] = File(inputMedia.content)
</a><a href="#h37-0-218" id="h37-0-218" class="d">-                    }
</a><a href="#h37-0-219" id="h37-0-219" class="d">-                }
</a><a href="#h37-0-220" id="h37-0-220" class="d">-            }.also { jobs.add(it) }
</a><a href="#h37-0-221" id="h37-0-221" class="d">-        }
</a><a href="#h37-0-222" id="h37-0-222" class="d">-
</a><a href="#h37-0-223" id="h37-0-223" class="d">-        jobs.joinAll()
</a><a href="#h37-0-224" id="h37-0-224" class="d">-        downloadedMedias
</a><a href="#h37-0-225" id="h37-0-225" class="d">-    }
</a><a href="#h37-0-226" id="h37-0-226" class="d">-
</a><a href="#h37-0-227" id="h37-0-227" class="d">-    private suspend fun downloadRemoteMedia(pendingDownloadObject: PendingDownload, downloadedMedias: Map&lt;InputMedia, DownloadedFile&gt;, downloadRequest: DownloadRequest) {
</a><a href="#h37-0-228" id="h37-0-228" class="d">-        downloadRequest.inputMedias.first().let { inputMedia -&gt;
</a><a href="#h37-0-229" id="h37-0-229" class="d">-            val mediaType = inputMedia.type
</a><a href="#h37-0-230" id="h37-0-230" class="d">-            val media = downloadedMedias[inputMedia]!!
</a><a href="#h37-0-231" id="h37-0-231" class="d">-
</a><a href="#h37-0-232" id="h37-0-232" class="d">-            if (!downloadRequest.isDashPlaylist) {
</a><a href="#h37-0-233" id="h37-0-233" class="d">-                saveMediaToGallery(media.file, pendingDownloadObject)
</a><a href="#h37-0-234" id="h37-0-234" class="d">-                media.file.delete()
</a><a href="#h37-0-235" id="h37-0-235" class="d">-                return
</a><a href="#h37-0-236" id="h37-0-236" class="d">-            }
</a><a href="#h37-0-237" id="h37-0-237" class="d">-
</a><a href="#h37-0-238" id="h37-0-238" class="d">-            assert(mediaType == DownloadMediaType.REMOTE_MEDIA)
</a><a href="#h37-0-239" id="h37-0-239" class="d">-
</a><a href="#h37-0-240" id="h37-0-240" class="d">-            val playlistXml = DocumentBuilderFactory.newInstance().newDocumentBuilder().parse(media.file)
</a><a href="#h37-0-241" id="h37-0-241" class="d">-            val baseUrlNodeList = playlistXml.getElementsByTagName(&quot;BaseURL&quot;)
</a><a href="#h37-0-242" id="h37-0-242" class="d">-            for (i in 0 until baseUrlNodeList.length) {
</a><a href="#h37-0-243" id="h37-0-243" class="d">-                val baseUrlNode = baseUrlNodeList.item(i)
</a><a href="#h37-0-244" id="h37-0-244" class="d">-                val baseUrl = baseUrlNode.textContent
</a><a href="#h37-0-245" id="h37-0-245" class="d">-                baseUrlNode.textContent = &quot;${RemoteMediaResolver.CF_ST_CDN_D}$baseUrl&quot;
</a><a href="#h37-0-246" id="h37-0-246" class="d">-            }
</a><a href="#h37-0-247" id="h37-0-247" class="d">-
</a><a href="#h37-0-248" id="h37-0-248" class="d">-            val dashOptions = downloadRequest.dashOptions!!
</a><a href="#h37-0-249" id="h37-0-249" class="d">-
</a><a href="#h37-0-250" id="h37-0-250" class="d">-            val dashPlaylistFile = renameFromFileType(media.file, FileType.MPD)
</a><a href="#h37-0-251" id="h37-0-251" class="d">-            val xmlData = dashPlaylistFile.outputStream()
</a><a href="#h37-0-252" id="h37-0-252" class="d">-            TransformerFactory.newInstance().newTransformer().transform(DOMSource(playlistXml), StreamResult(xmlData))
</a><a href="#h37-0-253" id="h37-0-253" class="d">-
</a><a href="#h37-0-254" id="h37-0-254" class="d">-            translation.format(&quot;download_toast&quot;, &quot;path&quot; to dashPlaylistFile.nameWithoutExtension).let {
</a><a href="#h37-0-255" id="h37-0-255" class="d">-                runCatching { callback.onProgress(it) }.onFailure { fallbackToast(it) }
</a><a href="#h37-0-256" id="h37-0-256" class="d">-            }
</a><a href="#h37-0-257" id="h37-0-257" class="d">-            val outputFile = File.createTempFile(&quot;dash&quot;, &quot;.mp4&quot;)
</a><a href="#h37-0-258" id="h37-0-258" class="d">-            runCatching {
</a><a href="#h37-0-259" id="h37-0-259" class="d">-                MediaDownloaderHelper.downloadDashChapterFile(
</a><a href="#h37-0-260" id="h37-0-260" class="d">-                    dashPlaylist = dashPlaylistFile,
</a><a href="#h37-0-261" id="h37-0-261" class="d">-                    output = outputFile,
</a><a href="#h37-0-262" id="h37-0-262" class="d">-                    startTime = dashOptions.offsetTime,
</a><a href="#h37-0-263" id="h37-0-263" class="d">-                    duration = dashOptions.duration)
</a><a href="#h37-0-264" id="h37-0-264" class="d">-                saveMediaToGallery(outputFile, pendingDownloadObject)
</a><a href="#h37-0-265" id="h37-0-265" class="d">-            }.onFailure { exception -&gt;
</a><a href="#h37-0-266" id="h37-0-266" class="d">-                if (coroutineContext.job.isCancelled) return@onFailure
</a><a href="#h37-0-267" id="h37-0-267" class="d">-                Logger.error(exception)
</a><a href="#h37-0-268" id="h37-0-268" class="d">-                translation.format(&quot;failed_processing_toast&quot;, &quot;error&quot; to exception.toString()).let {
</a><a href="#h37-0-269" id="h37-0-269" class="d">-                    runCatching { callback.onFailure(it, exception.message) }.onFailure { fallbackToast(it) }
</a><a href="#h37-0-270" id="h37-0-270" class="d">-                }
</a><a href="#h37-0-271" id="h37-0-271" class="d">-                pendingDownloadObject.downloadStage = DownloadStage.FAILED
</a><a href="#h37-0-272" id="h37-0-272" class="d">-            }
</a><a href="#h37-0-273" id="h37-0-273" class="d">-
</a><a href="#h37-0-274" id="h37-0-274" class="d">-            dashPlaylistFile.delete()
</a><a href="#h37-0-275" id="h37-0-275" class="d">-            outputFile.delete()
</a><a href="#h37-0-276" id="h37-0-276" class="d">-            media.file.delete()
</a><a href="#h37-0-277" id="h37-0-277" class="d">-        }
</a><a href="#h37-0-278" id="h37-0-278" class="d">-    }
</a><a href="#h37-0-279" id="h37-0-279" class="d">-
</a><a href="#h37-0-280" id="h37-0-280" class="d">-    private fun renameFromFileType(file: File, fileType: FileType): File {
</a><a href="#h37-0-281" id="h37-0-281" class="d">-        val newFile = File(file.parentFile, file.nameWithoutExtension + &quot;.&quot; + fileType.fileExtension)
</a><a href="#h37-0-282" id="h37-0-282" class="d">-        file.renameTo(newFile)
</a><a href="#h37-0-283" id="h37-0-283" class="d">-        return newFile
</a><a href="#h37-0-284" id="h37-0-284" class="d">-    }
</a><a href="#h37-0-285" id="h37-0-285" class="d">-
</a><a href="#h37-0-286" id="h37-0-286" class="d">-    fun onReceive(intent: Intent) {
</a><a href="#h37-0-287" id="h37-0-287" class="d">-        CoroutineScope(Dispatchers.IO).launch {
</a><a href="#h37-0-288" id="h37-0-288" class="d">-            val downloadMetadata = gson.fromJson(intent.getStringExtra(DOWNLOAD_METADATA_EXTRA)!!, DownloadMetadata::class.java)
</a><a href="#h37-0-289" id="h37-0-289" class="d">-            val downloadRequest = gson.fromJson(intent.getStringExtra(DOWNLOAD_REQUEST_EXTRA)!!, DownloadRequest::class.java)
</a><a href="#h37-0-290" id="h37-0-290" class="d">-
</a><a href="#h37-0-291" id="h37-0-291" class="d">-            SharedContext.downloadTaskManager.canDownloadMedia(downloadMetadata.mediaIdentifier)?.let { downloadStage -&gt;
</a><a href="#h37-0-292" id="h37-0-292" class="d">-                translation[if (downloadStage.isFinalStage) {
</a><a href="#h37-0-293" id="h37-0-293" class="d">-                    &quot;already_downloaded_toast&quot;
</a><a href="#h37-0-294" id="h37-0-294" class="d">-                } else {
</a><a href="#h37-0-295" id="h37-0-295" class="d">-                    &quot;already_queued_toast&quot;
</a><a href="#h37-0-296" id="h37-0-296" class="d">-                }].let {
</a><a href="#h37-0-297" id="h37-0-297" class="d">-                    runCatching { callback.onFailure(it, null) }.onFailure { fallbackToast(it) }
</a><a href="#h37-0-298" id="h37-0-298" class="d">-                }
</a><a href="#h37-0-299" id="h37-0-299" class="d">-                return@launch
</a><a href="#h37-0-300" id="h37-0-300" class="d">-            }
</a><a href="#h37-0-301" id="h37-0-301" class="d">-
</a><a href="#h37-0-302" id="h37-0-302" class="d">-            val pendingDownloadObject = PendingDownload(
</a><a href="#h37-0-303" id="h37-0-303" class="d">-                metadata = downloadMetadata
</a><a href="#h37-0-304" id="h37-0-304" class="d">-            )
</a><a href="#h37-0-305" id="h37-0-305" class="d">-
</a><a href="#h37-0-306" id="h37-0-306" class="d">-            SharedContext.downloadTaskManager.addTask(pendingDownloadObject)
</a><a href="#h37-0-307" id="h37-0-307" class="d">-            pendingDownloadObject.apply {
</a><a href="#h37-0-308" id="h37-0-308" class="d">-                job = coroutineContext.job
</a><a href="#h37-0-309" id="h37-0-309" class="d">-                downloadStage = DownloadStage.DOWNLOADING
</a><a href="#h37-0-310" id="h37-0-310" class="d">-            }
</a><a href="#h37-0-311" id="h37-0-311" class="d">-
</a><a href="#h37-0-312" id="h37-0-312" class="d">-            runCatching {
</a><a href="#h37-0-313" id="h37-0-313" class="d">-                //first download all input medias into cache
</a><a href="#h37-0-314" id="h37-0-314" class="d">-                val downloadedMedias = downloadInputMedias(downloadRequest).map {
</a><a href="#h37-0-315" id="h37-0-315" class="d">-                    it.key to DownloadedFile(it.value, FileType.fromFile(it.value))
</a><a href="#h37-0-316" id="h37-0-316" class="d">-                }.toMap().toMutableMap()
</a><a href="#h37-0-317" id="h37-0-317" class="d">-                Logger.debug(&quot;downloaded ${downloadedMedias.size} medias&quot;)
</a><a href="#h37-0-318" id="h37-0-318" class="d">-
</a><a href="#h37-0-319" id="h37-0-319" class="d">-                var shouldMergeOverlay = downloadRequest.shouldMergeOverlay
</a><a href="#h37-0-320" id="h37-0-320" class="d">-
</a><a href="#h37-0-321" id="h37-0-321" class="d">-                //if there is a zip file, extract it and replace the downloaded media with the extracted ones
</a><a href="#h37-0-322" id="h37-0-322" class="d">-                downloadedMedias.values.find { it.fileType == FileType.ZIP }?.let { entry -&gt;
</a><a href="#h37-0-323" id="h37-0-323" class="d">-                    val extractedMedias = extractZip(entry.file.inputStream()).map {
</a><a href="#h37-0-324" id="h37-0-324" class="d">-                        InputMedia(
</a><a href="#h37-0-325" id="h37-0-325" class="d">-                            type = DownloadMediaType.LOCAL_MEDIA,
</a><a href="#h37-0-326" id="h37-0-326" class="d">-                            content = it.absolutePath
</a><a href="#h37-0-327" id="h37-0-327" class="d">-                        ) to DownloadedFile(it, FileType.fromFile(it))
</a><a href="#h37-0-328" id="h37-0-328" class="d">-                    }
</a><a href="#h37-0-329" id="h37-0-329" class="d">-
</a><a href="#h37-0-330" id="h37-0-330" class="d">-                    downloadedMedias.values.removeIf {
</a><a href="#h37-0-331" id="h37-0-331" class="d">-                        it.file.delete()
</a><a href="#h37-0-332" id="h37-0-332" class="d">-                        true
</a><a href="#h37-0-333" id="h37-0-333" class="d">-                    }
</a><a href="#h37-0-334" id="h37-0-334" class="d">-
</a><a href="#h37-0-335" id="h37-0-335" class="d">-                    downloadedMedias.putAll(extractedMedias)
</a><a href="#h37-0-336" id="h37-0-336" class="d">-                    shouldMergeOverlay = true
</a><a href="#h37-0-337" id="h37-0-337" class="d">-                }
</a><a href="#h37-0-338" id="h37-0-338" class="d">-
</a><a href="#h37-0-339" id="h37-0-339" class="d">-                if (shouldMergeOverlay) {
</a><a href="#h37-0-340" id="h37-0-340" class="d">-                    assert(downloadedMedias.size == 2)
</a><a href="#h37-0-341" id="h37-0-341" class="d">-                    val media = downloadedMedias.values.first { it.fileType.isVideo }
</a><a href="#h37-0-342" id="h37-0-342" class="d">-                    val overlayMedia = downloadedMedias.values.first { it.fileType.isImage }
</a><a href="#h37-0-343" id="h37-0-343" class="d">-
</a><a href="#h37-0-344" id="h37-0-344" class="d">-                    val renamedMedia = renameFromFileType(media.file, media.fileType)
</a><a href="#h37-0-345" id="h37-0-345" class="d">-                    val renamedOverlayMedia = renameFromFileType(overlayMedia.file, overlayMedia.fileType)
</a><a href="#h37-0-346" id="h37-0-346" class="d">-                    val mergedOverlay: File = File.createTempFile(&quot;merged&quot;, &quot;.&quot; + media.fileType.fileExtension)
</a><a href="#h37-0-347" id="h37-0-347" class="d">-                    runCatching {
</a><a href="#h37-0-348" id="h37-0-348" class="d">-                        translation.format(&quot;download_toast&quot;, &quot;path&quot; to media.file.nameWithoutExtension).let {
</a><a href="#h37-0-349" id="h37-0-349" class="d">-                            runCatching { callback.onProgress(it) }.onFailure { fallbackToast(it) }
</a><a href="#h37-0-350" id="h37-0-350" class="d">-                        }
</a><a href="#h37-0-351" id="h37-0-351" class="d">-                        pendingDownloadObject.downloadStage = DownloadStage.MERGING
</a><a href="#h37-0-352" id="h37-0-352" class="d">-
</a><a href="#h37-0-353" id="h37-0-353" class="d">-                        MediaDownloaderHelper.mergeOverlayFile(
</a><a href="#h37-0-354" id="h37-0-354" class="d">-                            media = renamedMedia,
</a><a href="#h37-0-355" id="h37-0-355" class="d">-                            overlay = renamedOverlayMedia,
</a><a href="#h37-0-356" id="h37-0-356" class="d">-                            output = mergedOverlay
</a><a href="#h37-0-357" id="h37-0-357" class="d">-                        )
</a><a href="#h37-0-358" id="h37-0-358" class="d">-
</a><a href="#h37-0-359" id="h37-0-359" class="d">-                        saveMediaToGallery(mergedOverlay, pendingDownloadObject)
</a><a href="#h37-0-360" id="h37-0-360" class="d">-                    }.onFailure { exception -&gt;
</a><a href="#h37-0-361" id="h37-0-361" class="d">-                        if (coroutineContext.job.isCancelled) return@onFailure
</a><a href="#h37-0-362" id="h37-0-362" class="d">-                        Logger.error(exception)
</a><a href="#h37-0-363" id="h37-0-363" class="d">-                        translation.format(&quot;failed_processing_toast&quot;, &quot;error&quot; to exception.toString()).let {
</a><a href="#h37-0-364" id="h37-0-364" class="d">-                            runCatching { callback.onFailure(it, exception.message) }.onFailure { fallbackToast(it) }
</a><a href="#h37-0-365" id="h37-0-365" class="d">-                        }
</a><a href="#h37-0-366" id="h37-0-366" class="d">-                        pendingDownloadObject.downloadStage = DownloadStage.MERGE_FAILED
</a><a href="#h37-0-367" id="h37-0-367" class="d">-                    }
</a><a href="#h37-0-368" id="h37-0-368" class="d">-
</a><a href="#h37-0-369" id="h37-0-369" class="d">-                    mergedOverlay.delete()
</a><a href="#h37-0-370" id="h37-0-370" class="d">-                    renamedOverlayMedia.delete()
</a><a href="#h37-0-371" id="h37-0-371" class="d">-                    renamedMedia.delete()
</a><a href="#h37-0-372" id="h37-0-372" class="d">-                    return@launch
</a><a href="#h37-0-373" id="h37-0-373" class="d">-                }
</a><a href="#h37-0-374" id="h37-0-374" class="d">-
</a><a href="#h37-0-375" id="h37-0-375" class="d">-                downloadRemoteMedia(pendingDownloadObject, downloadedMedias, downloadRequest)
</a><a href="#h37-0-376" id="h37-0-376" class="d">-            }.onFailure { exception -&gt;
</a><a href="#h37-0-377" id="h37-0-377" class="d">-                pendingDownloadObject.downloadStage = DownloadStage.FAILED
</a><a href="#h37-0-378" id="h37-0-378" class="d">-                Logger.error(exception)
</a><a href="#h37-0-379" id="h37-0-379" class="d">-                translation[&quot;failed_generic_toast&quot;].let {
</a><a href="#h37-0-380" id="h37-0-380" class="d">-                    runCatching { callback.onFailure(it, exception.message) }.onFailure { fallbackToast(it) }
</a><a href="#h37-0-381" id="h37-0-381" class="d">-                }
</a><a href="#h37-0-382" id="h37-0-382" class="d">-            }
</a><a href="#h37-0-383" id="h37-0-383" class="d">-        }
</a><a href="#h37-0-384" id="h37-0-384" class="d">-    }
</a><a href="#h37-0-385" id="h37-0-385" class="d">-}</a><a href="#h37-0-386" id="h37-0-386" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h38" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/FeatureLoadParams.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/FeatureLoadParams.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/FeatureLoadParams.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/FeatureLoadParams.kt</a></b>
<a href="#h38-0" id="h38-0" class="h">@@ -3,9 +3,9 @@ package me.rhunk.snapenhance.features
</a> object FeatureLoadParams {
     const val NO_INIT = 0
 
<a href="#h38-0-3" id="h38-0-3" class="d">-    const val INIT_SYNC = 1
</a><a href="#h38-0-4" id="h38-0-4" class="d">-    const val ACTIVITY_CREATE_SYNC = 2
</a><a href="#h38-0-5" id="h38-0-5" class="i">+    const val INIT_SYNC = 0b0001
</a><a href="#h38-0-6" id="h38-0-6" class="i">+    const val ACTIVITY_CREATE_SYNC = 0b0010
</a> 
<a href="#h38-0-8" id="h38-0-8" class="d">-    const val INIT_ASYNC = 3
</a><a href="#h38-0-9" id="h38-0-9" class="d">-    const val ACTIVITY_CREATE_ASYNC = 4
</a><a href="#h38-0-10" id="h38-0-10" class="i">+    const val INIT_ASYNC = 0b0100
</a><a href="#h38-0-11" id="h38-0-11" class="i">+    const val ACTIVITY_CREATE_ASYNC = 0b1000
</a> } 
\ No newline at end of file
<b>diff --git a/<a id="h39" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/FriendFeedInfoMenu.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/FriendFeedInfoMenu.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/FriendFeedInfoMenu.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/FriendFeedInfoMenu.kt</a></b>
<a href="#h39-0" id="h39-0" class="h">@@ -84,7 +84,7 @@ class FriendFeedInfoMenu : AbstractMenu() {
</a>                 ${birthday.getDisplayName(
                     Calendar.MONTH,
                     Calendar.LONG,
<a href="#h39-0-3" id="h39-0-3" class="d">-                    context.translation.locale
</a><a href="#h39-0-4" id="h39-0-4" class="i">+                    context.translation.loadedLocale
</a>                 )?.let {
                     context.translation.format(&quot;profile_info.birthday&quot;,
                         &quot;month&quot; to it,
<b>diff --git a/<a id="h40" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/SettingsGearInjector.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/SettingsGearInjector.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/SettingsGearInjector.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/ui/menu/impl/SettingsGearInjector.kt</a></b>
<a href="#h40-0" id="h40-0" class="h">@@ -47,9 +47,8 @@ class SettingsGearInjector : AbstractMenu() {
</a> 
             setOnClickListener {
                 val intent = Intent().apply {
<a href="#h40-0-3" id="h40-0-3" class="d">-                    setClassName(BuildConfig.APPLICATION_ID, &quot;me.rhunk.snapenhance.manager.MainActivity&quot;)
</a><a href="#h40-0-4" id="h40-0-4" class="i">+                    setClassName(BuildConfig.APPLICATION_ID, &quot;me.rhunk.snapenhance.ui.manager.MainActivity&quot;)
</a>                     putExtra(&quot;route&quot;, &quot;features&quot;)
<a href="#h40-0-6" id="h40-0-6" class="d">-                    putExtra(&quot;lspatched&quot;, File(context.cacheDir, &quot;lspatch/origin&quot;).exists())
</a>                 }
                 context.startActivity(intent)
             }
</pre>
</div>
</body>
</html>
