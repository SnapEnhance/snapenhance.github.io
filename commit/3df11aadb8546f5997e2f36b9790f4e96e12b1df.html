<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>refactor: download - download task manager - fix installation summary update - SnapEnhance - An Xposed module offering an enhanced Snapchat experience
</title>
<link rel="icon" type="image/svg+xml" href="../../logo.png"/>
<link rel="alternate icon" href="../../favicon.png"/>
<link rel="alternate" type="application/atom+xml" title="SnapEnhance Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="SnapEnhance Atom Feed (tags)" href="../tags.xml" />
<link rel="stylesheet" type="text/css" href="../../style.css" />
<link rel="stylesheet" type="text/css" href="../../fonts.css" />
</head>
<body>
<div id="head"><table><tr><td><a class="logo" href="../../"><img src="../../logo.png" alt="" width="32" height="32" /></a></td><td><strong>SnapEnhance</strong><span class="desc"> - An Xposed module offering an enhanced Snapchat experience
</span>
</td></tr></table>
<p><a href="../about.html">About</a> | <a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/.gitmodules.html">Submodules</a> | <a href="../file/LICENSE.html">License</a></p>
</div>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/3df11aadb8546f5997e2f36b9790f4e96e12b1df.html">3df11aadb8546f5997e2f36b9790f4e96e12b1df</a>
<b>parent</b> <a href="../commit/2ff8a6940364a997f6c8515dc83bb7303609a930.html">2ff8a6940364a997f6c8515dc83bb7303609a930</a>
<b>Author:</b> rhunk &lt;<a href="mailto:101876869+rhunk@users.noreply.github.com">101876869+rhunk@users.noreply.github.com</a>&gt;
<b>Date:</b>   Fri,  4 Aug 2023 12:17:19 +0200

refactor: download
- download task manager
- fix installation summary update

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">app/src/main/kotlin/me/rhunk/snapenhance/RemoteSideContext.kt</a></td><td> | </td><td class="num">33</td><td><span class="i">+++++++++++++++++++++++++</span><span class="d">--------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">app/src/main/kotlin/me/rhunk/snapenhance/SharedContextHolder.kt</a></td><td> | </td><td class="num">14</td><td><span class="i">+++++++++</span><span class="d">-----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h2">app/src/main/kotlin/me/rhunk/snapenhance/bridge/BridgeService.kt</a></td><td> | </td><td class="num">11</td><td><span class="i">+++++</span><span class="d">------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h3">app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadProcessor.kt</a></td><td> | </td><td class="num">90</td><td><span class="i">+++++++++++++++++++++++++++++++++++++</span><span class="d">------------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h4">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/MainActivity.kt</a></td><td> | </td><td class="num">15</td><td><span class="i">+++++++++++++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h5">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/Section.kt</a></td><td> | </td><td class="num">5</td><td><span class="i">++++</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h6">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/HomeSection.kt</a></td><td> | </td><td class="num">16</td><td><span class="i">++++++++++++++</span><span class="d">--</span></td></tr>
<tr><td class="A">A</td><td><a href="#h7">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/download/DownloadSection.kt</a></td><td> | </td><td class="num">12</td><td><span class="i">++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h8">app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/Requirements.kt</a></td><td> | </td><td class="num">2</td><td><span class="i"></span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h9">app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/SetupActivity.kt</a></td><td> | </td><td class="num">4</td><td><span class="i"></span><span class="d">----</span></td></tr>
<tr><td class="D">D</td><td><a href="#h10">app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/screens/impl/FfmpegScreen.kt</a></td><td> | </td><td class="num">18</td><td><span class="i"></span><span class="d">------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h11">app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/screens/impl/PickLanguageScreen.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h12">core/src/main/kotlin/me/rhunk/snapenhance/SharedContext.kt</a></td><td> | </td><td class="num">45</td><td><span class="i"></span><span class="d">---------------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h13">core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/DownloaderConfig.kt</a></td><td> | </td><td class="num">6</td><td><span class="i">++++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h14">core/src/main/kotlin/me/rhunk/snapenhance/download/DownloadManagerClient.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h15">core/src/main/kotlin/me/rhunk/snapenhance/download/DownloadTaskManager.kt</a></td><td> | </td><td class="num">3</td><td><span class="i">++</span><span class="d">-</span></td></tr>
<tr><td class="A">A</td><td><a href="#h16">core/src/main/kotlin/me/rhunk/snapenhance/download/data/DownloadMediaType.kt</a></td><td> | </td><td class="num">23</td><td><span class="i">+++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h17">core/src/main/kotlin/me/rhunk/snapenhance/download/data/DownloadRequest.kt</a></td><td> | </td><td class="num">2</td><td><span class="i"></span><span class="d">--</span></td></tr>
<tr><td class="A">A</td><td><a href="#h18">core/src/main/kotlin/me/rhunk/snapenhance/download/data/DownloadStage.kt</a></td><td> | </td><td class="num">15</td><td><span class="i">+++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h19">core/src/main/kotlin/me/rhunk/snapenhance/download/data/PendingDownload.kt</a></td><td> | </td><td class="num">15</td><td><span class="i">+++++++</span><span class="d">--------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h20">core/src/main/kotlin/me/rhunk/snapenhance/download/enums/DownloadMediaType.kt</a></td><td> | </td><td class="num">23</td><td><span class="i"></span><span class="d">-----------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h21">core/src/main/kotlin/me/rhunk/snapenhance/download/enums/DownloadStage.kt</a></td><td> | </td><td class="num">15</td><td><span class="i"></span><span class="d">---------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h22">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/MediaDownloader.kt</a></td><td> | </td><td class="num">33</td><td><span class="i">+++++++++++</span><span class="d">----------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h23">core/src/main/kotlin/me/rhunk/snapenhance/ui/download/DownloadListAdapter.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
</table></pre><pre>24 files changed, 189 insertions(+), 217 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/RemoteSideContext.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/RemoteSideContext.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/RemoteSideContext.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/RemoteSideContext.kt</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -8,6 +8,7 @@ import androidx.documentfile.provider.DocumentFile
</a> import me.rhunk.snapenhance.bridge.wrapper.LocaleWrapper
 import me.rhunk.snapenhance.bridge.wrapper.MappingsWrapper
 import me.rhunk.snapenhance.core.config.ModConfig
<a href="#h0-0-3" id="h0-0-3" class="i">+import me.rhunk.snapenhance.download.DownloadTaskManager
</a> import me.rhunk.snapenhance.ui.manager.data.InstallationSummary
 import me.rhunk.snapenhance.ui.manager.data.ModMappingsInfo
 import me.rhunk.snapenhance.ui.manager.data.SnapchatAppInfo
<a href="#h0-1" id="h0-1" class="h">@@ -17,24 +18,40 @@ import java.lang.ref.WeakReference
</a> import kotlin.system.exitProcess
 
 class RemoteSideContext(
<a href="#h0-1-3" id="h0-1-3" class="d">-    val androidContext: Context
</a><a href="#h0-1-4" id="h0-1-4" class="i">+    ctx: Context
</a> ) {
<a href="#h0-1-6" id="h0-1-6" class="i">+    private var _context: WeakReference&lt;Context&gt; = WeakReference(ctx)
</a>     private var _activity: WeakReference&lt;Activity&gt;? = null
<a href="#h0-1-8" id="h0-1-8" class="i">+
</a><a href="#h0-1-9" id="h0-1-9" class="i">+    var androidContext: Context
</a><a href="#h0-1-10" id="h0-1-10" class="i">+        get() = synchronized(this) {
</a><a href="#h0-1-11" id="h0-1-11" class="i">+            _context.get() ?: error(&quot;Context is null&quot;)
</a><a href="#h0-1-12" id="h0-1-12" class="i">+        }
</a><a href="#h0-1-13" id="h0-1-13" class="i">+        set(value) { synchronized(this) {
</a><a href="#h0-1-14" id="h0-1-14" class="i">+            _context.clear(); _context = WeakReference(value)
</a><a href="#h0-1-15" id="h0-1-15" class="i">+        } }
</a><a href="#h0-1-16" id="h0-1-16" class="i">+
</a>     var activity: Activity?
         get() = _activity?.get()
<a href="#h0-1-19" id="h0-1-19" class="d">-        set(value) { _activity = WeakReference(value) }
</a><a href="#h0-1-20" id="h0-1-20" class="i">+        set(value) { _activity?.clear(); _activity = WeakReference(value) }
</a> 
     val config = ModConfig()
     val translation = LocaleWrapper()
     val mappings = MappingsWrapper(androidContext)
<a href="#h0-1-25" id="h0-1-25" class="i">+    val downloadTaskManager = DownloadTaskManager()
</a> 
     init {
<a href="#h0-1-28" id="h0-1-28" class="d">-        config.loadFromContext(androidContext)
</a><a href="#h0-1-29" id="h0-1-29" class="d">-        translation.userLocale = config.locale
</a><a href="#h0-1-30" id="h0-1-30" class="d">-        translation.loadFromContext(androidContext)
</a><a href="#h0-1-31" id="h0-1-31" class="d">-        mappings.apply {
</a><a href="#h0-1-32" id="h0-1-32" class="d">-            loadFromContext(androidContext)
</a><a href="#h0-1-33" id="h0-1-33" class="d">-            init()
</a><a href="#h0-1-34" id="h0-1-34" class="i">+        runCatching {
</a><a href="#h0-1-35" id="h0-1-35" class="i">+            config.loadFromContext(androidContext)
</a><a href="#h0-1-36" id="h0-1-36" class="i">+            translation.userLocale = config.locale
</a><a href="#h0-1-37" id="h0-1-37" class="i">+            translation.loadFromContext(androidContext)
</a><a href="#h0-1-38" id="h0-1-38" class="i">+            mappings.apply {
</a><a href="#h0-1-39" id="h0-1-39" class="i">+                loadFromContext(androidContext)
</a><a href="#h0-1-40" id="h0-1-40" class="i">+                init()
</a><a href="#h0-1-41" id="h0-1-41" class="i">+            }
</a><a href="#h0-1-42" id="h0-1-42" class="i">+            downloadTaskManager.init(androidContext)
</a><a href="#h0-1-43" id="h0-1-43" class="i">+        }.onFailure {
</a><a href="#h0-1-44" id="h0-1-44" class="i">+            Logger.error(&quot;Failed to initialize RemoteSideContext&quot;, it)
</a>         }
     }
 
<b>diff --git a/<a id="h1" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/SharedContextHolder.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/SharedContextHolder.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/SharedContextHolder.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/SharedContextHolder.kt</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -1,15 +1,19 @@
</a> package me.rhunk.snapenhance
 
 import android.content.Context
<a href="#h1-0-3" id="h1-0-3" class="d">-import java.lang.ref.WeakReference
</a> 
 object SharedContextHolder {
<a href="#h1-0-6" id="h1-0-6" class="d">-    private lateinit var _remoteSideContext: WeakReference&lt;RemoteSideContext&gt;
</a><a href="#h1-0-7" id="h1-0-7" class="i">+    private lateinit var _remoteSideContext: RemoteSideContext
</a> 
     fun remote(context: Context): RemoteSideContext {
<a href="#h1-0-10" id="h1-0-10" class="d">-        if (!::_remoteSideContext.isInitialized || _remoteSideContext.get() == null) {
</a><a href="#h1-0-11" id="h1-0-11" class="d">-            _remoteSideContext = WeakReference(RemoteSideContext(context.applicationContext))
</a><a href="#h1-0-12" id="h1-0-12" class="i">+        if (!::_remoteSideContext.isInitialized) {
</a><a href="#h1-0-13" id="h1-0-13" class="i">+            _remoteSideContext = RemoteSideContext(context)
</a>         }
<a href="#h1-0-15" id="h1-0-15" class="d">-        return _remoteSideContext.get()!!
</a><a href="#h1-0-16" id="h1-0-16" class="i">+
</a><a href="#h1-0-17" id="h1-0-17" class="i">+        if (_remoteSideContext.androidContext != context) {
</a><a href="#h1-0-18" id="h1-0-18" class="i">+            _remoteSideContext.androidContext = context
</a><a href="#h1-0-19" id="h1-0-19" class="i">+        }
</a><a href="#h1-0-20" id="h1-0-20" class="i">+
</a><a href="#h1-0-21" id="h1-0-21" class="i">+        return _remoteSideContext
</a>     }
 } 
\ No newline at end of file
<b>diff --git a/<a id="h2" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/BridgeService.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/BridgeService.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/bridge/BridgeService.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/bridge/BridgeService.kt</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -4,11 +4,10 @@ import android.app.Service
</a> import android.content.Intent
 import android.os.IBinder
 import me.rhunk.snapenhance.RemoteSideContext
<a href="#h2-0-3" id="h2-0-3" class="d">-import me.rhunk.snapenhance.SharedContext
</a> import me.rhunk.snapenhance.SharedContextHolder
 import me.rhunk.snapenhance.bridge.types.BridgeFileType
<a href="#h2-0-6" id="h2-0-6" class="d">-import me.rhunk.snapenhance.bridge.wrapper.MessageLoggerWrapper
</a> import me.rhunk.snapenhance.bridge.wrapper.LocaleWrapper
<a href="#h2-0-8" id="h2-0-8" class="i">+import me.rhunk.snapenhance.bridge.wrapper.MessageLoggerWrapper
</a> import me.rhunk.snapenhance.download.DownloadProcessor
 
 class BridgeService : Service() {
<a href="#h2-1" id="h2-1" class="h">@@ -105,10 +104,10 @@ class BridgeService : Service() {
</a>         }
 
         override fun enqueueDownload(intent: Intent, callback: DownloadCallback) {
<a href="#h2-1-3" id="h2-1-3" class="d">-            SharedContextHolder.remote(this@BridgeService)
</a><a href="#h2-1-4" id="h2-1-4" class="d">-            //TODO: refactor shared context
</a><a href="#h2-1-5" id="h2-1-5" class="d">-            SharedContext.ensureInitialized(this@BridgeService)
</a><a href="#h2-1-6" id="h2-1-6" class="d">-            DownloadProcessor(this@BridgeService, callback).onReceive(intent)
</a><a href="#h2-1-7" id="h2-1-7" class="i">+            DownloadProcessor(
</a><a href="#h2-1-8" id="h2-1-8" class="i">+                remoteSideContext = SharedContextHolder.remote(this@BridgeService),
</a><a href="#h2-1-9" id="h2-1-9" class="i">+                callback = callback
</a><a href="#h2-1-10" id="h2-1-10" class="i">+            ).onReceive(intent)
</a>         }
     }
 }
<b>diff --git a/<a id="h3" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadProcessor.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadProcessor.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadProcessor.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadProcessor.kt</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -1,7 +1,6 @@
</a> package me.rhunk.snapenhance.download
 
 import android.annotation.SuppressLint
<a href="#h3-0-3" id="h3-0-3" class="d">-import android.content.Context
</a> import android.content.Intent
 import android.net.Uri
 import android.widget.Toast
<a href="#h3-1" id="h3-1" class="h">@@ -16,17 +15,17 @@ import kotlinx.coroutines.launch
</a> import kotlinx.coroutines.runBlocking
 import me.rhunk.snapenhance.Constants
 import me.rhunk.snapenhance.Logger
<a href="#h3-1-3" id="h3-1-3" class="i">+import me.rhunk.snapenhance.RemoteSideContext
</a> import me.rhunk.snapenhance.SharedContext
 import me.rhunk.snapenhance.bridge.DownloadCallback
<a href="#h3-1-6" id="h3-1-6" class="d">-import me.rhunk.snapenhance.core.config.ModConfig
</a> import me.rhunk.snapenhance.data.FileType
<a href="#h3-1-8" id="h3-1-8" class="i">+import me.rhunk.snapenhance.download.data.DownloadMediaType
</a> import me.rhunk.snapenhance.download.data.DownloadMetadata
 import me.rhunk.snapenhance.download.data.DownloadRequest
<a href="#h3-1-11" id="h3-1-11" class="i">+import me.rhunk.snapenhance.download.data.DownloadStage
</a> import me.rhunk.snapenhance.download.data.InputMedia
 import me.rhunk.snapenhance.download.data.MediaEncryptionKeyPair
 import me.rhunk.snapenhance.download.data.PendingDownload
<a href="#h3-1-15" id="h3-1-15" class="d">-import me.rhunk.snapenhance.download.enums.DownloadMediaType
</a><a href="#h3-1-16" id="h3-1-16" class="d">-import me.rhunk.snapenhance.download.enums.DownloadStage
</a> import me.rhunk.snapenhance.util.download.RemoteMediaResolver
 import me.rhunk.snapenhance.util.snap.MediaDownloaderHelper
 import java.io.File
<a href="#h3-2" id="h3-2" class="h">@@ -56,7 +55,7 @@ data class DownloadedFile(
</a>  */
 @OptIn(ExperimentalEncodingApi::class)
 class DownloadProcessor (
<a href="#h3-2-3" id="h3-2-3" class="d">-    private val context: Context,
</a><a href="#h3-2-4" id="h3-2-4" class="i">+    private val remoteSideContext: RemoteSideContext,
</a>     private val callback: DownloadCallback
 ) {
 
<a href="#h3-3" id="h3-3" class="h">@@ -69,11 +68,29 @@ class DownloadProcessor (
</a>     }
 
     private fun fallbackToast(message: Any) {
<a href="#h3-3-3" id="h3-3-3" class="d">-        android.os.Handler(context.mainLooper).post {
</a><a href="#h3-3-4" id="h3-3-4" class="d">-            Toast.makeText(context, message.toString(), Toast.LENGTH_SHORT).show()
</a><a href="#h3-3-5" id="h3-3-5" class="i">+        android.os.Handler(remoteSideContext.androidContext.mainLooper).post {
</a><a href="#h3-3-6" id="h3-3-6" class="i">+            Toast.makeText(remoteSideContext.androidContext, message.toString(), Toast.LENGTH_SHORT).show()
</a>         }
     }
 
<a href="#h3-3-10" id="h3-3-10" class="i">+    private fun callbackOnSuccess(path: String) = runCatching {
</a><a href="#h3-3-11" id="h3-3-11" class="i">+        callback.onSuccess(path)
</a><a href="#h3-3-12" id="h3-3-12" class="i">+    }.onFailure {
</a><a href="#h3-3-13" id="h3-3-13" class="i">+        fallbackToast(it)
</a><a href="#h3-3-14" id="h3-3-14" class="i">+    }
</a><a href="#h3-3-15" id="h3-3-15" class="i">+
</a><a href="#h3-3-16" id="h3-3-16" class="i">+    private fun callbackOnFailure(message: String, throwable: String? = null) = runCatching {
</a><a href="#h3-3-17" id="h3-3-17" class="i">+        callback.onFailure(message, throwable)
</a><a href="#h3-3-18" id="h3-3-18" class="i">+    }.onFailure {
</a><a href="#h3-3-19" id="h3-3-19" class="i">+        fallbackToast(&quot;$message\n$throwable&quot;)
</a><a href="#h3-3-20" id="h3-3-20" class="i">+    }
</a><a href="#h3-3-21" id="h3-3-21" class="i">+
</a><a href="#h3-3-22" id="h3-3-22" class="i">+    private fun callbackOnProgress(message: String) = runCatching {
</a><a href="#h3-3-23" id="h3-3-23" class="i">+        callback.onProgress(message)
</a><a href="#h3-3-24" id="h3-3-24" class="i">+    }.onFailure {
</a><a href="#h3-3-25" id="h3-3-25" class="i">+        fallbackToast(it)
</a><a href="#h3-3-26" id="h3-3-26" class="i">+    }
</a><a href="#h3-3-27" id="h3-3-27" class="i">+
</a>     private fun extractZip(inputStream: InputStream): List&lt;File&gt; {
         val files = mutableListOf&lt;File&gt;()
         val zipInputStream = ZipInputStream(inputStream)
<a href="#h3-4" id="h3-4" class="h">@@ -100,30 +117,20 @@ class DownloadProcessor (
</a>         return CipherInputStream(inputStream, cipher)
     }
 
<a href="#h3-4-3" id="h3-4-3" class="d">-    private fun createNeededDirectories(file: File): File {
</a><a href="#h3-4-4" id="h3-4-4" class="d">-        val directory = file.parentFile ?: return file
</a><a href="#h3-4-5" id="h3-4-5" class="d">-        if (!directory.exists()) {
</a><a href="#h3-4-6" id="h3-4-6" class="d">-            directory.mkdirs()
</a><a href="#h3-4-7" id="h3-4-7" class="d">-        }
</a><a href="#h3-4-8" id="h3-4-8" class="d">-        return file
</a><a href="#h3-4-9" id="h3-4-9" class="d">-    }
</a><a href="#h3-4-10" id="h3-4-10" class="d">-
</a>     @SuppressLint(&quot;UnspecifiedRegisterReceiverFlag&quot;)
     private suspend fun saveMediaToGallery(inputFile: File, pendingDownload: PendingDownload) {
         if (coroutineContext.job.isCancelled) return
 
<a href="#h3-4-15" id="h3-4-15" class="d">-        val config by ModConfig().apply { loadFromContext(context) }
</a><a href="#h3-4-16" id="h3-4-16" class="d">-
</a>         runCatching {
             val fileType = FileType.fromFile(inputFile)
             if (fileType == FileType.UNKNOWN) {
<a href="#h3-4-20" id="h3-4-20" class="d">-                callback.onFailure(translation.format(&quot;failed_gallery_toast&quot;, &quot;error&quot; to &quot;Unknown media type&quot;), null)
</a><a href="#h3-4-21" id="h3-4-21" class="i">+                callbackOnFailure(translation.format(&quot;failed_gallery_toast&quot;, &quot;error&quot; to &quot;Unknown media type&quot;), null)
</a>                 return
             }
 
             val fileName = pendingDownload.metadata.outputPath.substringAfterLast(&quot;/&quot;) + &quot;.&quot; + fileType.fileExtension
 
<a href="#h3-4-27" id="h3-4-27" class="d">-            val outputFolder = DocumentFile.fromTreeUri(context, Uri.parse(config.downloader.saveFolder.get()))
</a><a href="#h3-4-28" id="h3-4-28" class="i">+            val outputFolder = DocumentFile.fromTreeUri(remoteSideContext.androidContext, Uri.parse(remoteSideContext.config.root.downloader.saveFolder.get()))
</a>                 ?: throw Exception(&quot;Failed to open output folder&quot;)
 
             val outputFileFolder = pendingDownload.metadata.outputPath.let {
<a href="#h3-5" id="h3-5" class="h">@@ -137,7 +144,7 @@ class DownloadProcessor (
</a>             }
 
             val outputFile = outputFileFolder.createFile(fileType.mimeType, fileName)!!
<a href="#h3-5-3" id="h3-5-3" class="d">-            val outputStream = context.contentResolver.openOutputStream(outputFile.uri)!!
</a><a href="#h3-5-4" id="h3-5-4" class="i">+            val outputStream = remoteSideContext.androidContext.contentResolver.openOutputStream(outputFile.uri)!!
</a> 
             inputFile.inputStream().use { inputStream -&gt;
                 inputStream.copyTo(outputStream)
<a href="#h3-6" id="h3-6" class="h">@@ -149,21 +156,17 @@ class DownloadProcessor (
</a>             runCatching {
                 val mediaScanIntent = Intent(&quot;android.intent.action.MEDIA_SCANNER_SCAN_FILE&quot;)
                 mediaScanIntent.setData(outputFile.uri)
<a href="#h3-6-3" id="h3-6-3" class="d">-                context.sendBroadcast(mediaScanIntent)
</a><a href="#h3-6-4" id="h3-6-4" class="i">+                remoteSideContext.androidContext.sendBroadcast(mediaScanIntent)
</a>             }.onFailure {
                 Logger.error(&quot;Failed to scan media file&quot;, it)
<a href="#h3-6-7" id="h3-6-7" class="d">-                callback.onFailure(translation.format(&quot;failed_gallery_toast&quot;, &quot;error&quot; to it.toString()), it.message)
</a><a href="#h3-6-8" id="h3-6-8" class="i">+                callbackOnFailure(translation.format(&quot;failed_gallery_toast&quot;, &quot;error&quot; to it.toString()), it.message)
</a>             }
 
             Logger.debug(&quot;download complete&quot;)
<a href="#h3-6-12" id="h3-6-12" class="d">-            fileName.let {
</a><a href="#h3-6-13" id="h3-6-13" class="d">-                runCatching { callback.onSuccess(it) }.onFailure { fallbackToast(it) }
</a><a href="#h3-6-14" id="h3-6-14" class="d">-            }
</a><a href="#h3-6-15" id="h3-6-15" class="i">+            callbackOnSuccess(fileName)
</a>         }.onFailure { exception -&gt;
             Logger.error(exception)
<a href="#h3-6-18" id="h3-6-18" class="d">-            translation.format(&quot;failed_gallery_toast&quot;, &quot;error&quot; to exception.toString()).let {
</a><a href="#h3-6-19" id="h3-6-19" class="d">-                runCatching { callback.onFailure(it, exception.message) }.onFailure { fallbackToast(it) }
</a><a href="#h3-6-20" id="h3-6-20" class="d">-            }
</a><a href="#h3-6-21" id="h3-6-21" class="i">+            callbackOnFailure(translation.format(&quot;failed_gallery_toast&quot;, &quot;error&quot; to exception.toString()), exception.message)
</a>             pendingDownload.downloadStage = DownloadStage.FAILED
         }
     }
<a href="#h3-7" id="h3-7" class="h">@@ -250,9 +253,7 @@ class DownloadProcessor (
</a>             val xmlData = dashPlaylistFile.outputStream()
             TransformerFactory.newInstance().newTransformer().transform(DOMSource(playlistXml), StreamResult(xmlData))
 
<a href="#h3-7-3" id="h3-7-3" class="d">-            translation.format(&quot;download_toast&quot;, &quot;path&quot; to dashPlaylistFile.nameWithoutExtension).let {
</a><a href="#h3-7-4" id="h3-7-4" class="d">-                runCatching { callback.onProgress(it) }.onFailure { fallbackToast(it) }
</a><a href="#h3-7-5" id="h3-7-5" class="d">-            }
</a><a href="#h3-7-6" id="h3-7-6" class="i">+            callbackOnProgress(translation.format(&quot;download_toast&quot;, &quot;path&quot; to dashPlaylistFile.nameWithoutExtension))
</a>             val outputFile = File.createTempFile(&quot;dash&quot;, &quot;.mp4&quot;)
             runCatching {
                 MediaDownloaderHelper.downloadDashChapterFile(
<a href="#h3-8" id="h3-8" class="h">@@ -264,9 +265,7 @@ class DownloadProcessor (
</a>             }.onFailure { exception -&gt;
                 if (coroutineContext.job.isCancelled) return@onFailure
                 Logger.error(exception)
<a href="#h3-8-3" id="h3-8-3" class="d">-                translation.format(&quot;failed_processing_toast&quot;, &quot;error&quot; to exception.toString()).let {
</a><a href="#h3-8-4" id="h3-8-4" class="d">-                    runCatching { callback.onFailure(it, exception.message) }.onFailure { fallbackToast(it) }
</a><a href="#h3-8-5" id="h3-8-5" class="d">-                }
</a><a href="#h3-8-6" id="h3-8-6" class="i">+                callbackOnFailure(translation.format(&quot;failed_processing_toast&quot;, &quot;error&quot; to exception.toString()), exception.message)
</a>                 pendingDownloadObject.downloadStage = DownloadStage.FAILED
             }
 
<a href="#h3-9" id="h3-9" class="h">@@ -287,23 +286,24 @@ class DownloadProcessor (
</a>             val downloadMetadata = gson.fromJson(intent.getStringExtra(DownloadManagerClient.DOWNLOAD_METADATA_EXTRA)!!, DownloadMetadata::class.java)
             val downloadRequest = gson.fromJson(intent.getStringExtra(DownloadManagerClient.DOWNLOAD_REQUEST_EXTRA)!!, DownloadRequest::class.java)
 
<a href="#h3-9-3" id="h3-9-3" class="d">-            SharedContext.downloadTaskManager.canDownloadMedia(downloadMetadata.mediaIdentifier)?.let { downloadStage -&gt;
</a><a href="#h3-9-4" id="h3-9-4" class="i">+            remoteSideContext.downloadTaskManager.canDownloadMedia(downloadMetadata.mediaIdentifier)?.let { downloadStage -&gt;
</a>                 translation[if (downloadStage.isFinalStage) {
                     &quot;already_downloaded_toast&quot;
                 } else {
                     &quot;already_queued_toast&quot;
                 }].let {
<a href="#h3-9-10" id="h3-9-10" class="d">-                    runCatching { callback.onFailure(it, null) }.onFailure { fallbackToast(it) }
</a><a href="#h3-9-11" id="h3-9-11" class="i">+                    callbackOnFailure(it, null)
</a>                 }
                 return@launch
             }
 
             val pendingDownloadObject = PendingDownload(
                 metadata = downloadMetadata
<a href="#h3-9-18" id="h3-9-18" class="d">-            )
</a><a href="#h3-9-19" id="h3-9-19" class="i">+            ).apply { downloadTaskManager = remoteSideContext.downloadTaskManager }
</a> 
<a href="#h3-9-21" id="h3-9-21" class="d">-            SharedContext.downloadTaskManager.addTask(pendingDownloadObject)
</a><a href="#h3-9-22" id="h3-9-22" class="d">-            pendingDownloadObject.apply {
</a><a href="#h3-9-23" id="h3-9-23" class="i">+            pendingDownloadObject.also {
</a><a href="#h3-9-24" id="h3-9-24" class="i">+                remoteSideContext.downloadTaskManager.addTask(it)
</a><a href="#h3-9-25" id="h3-9-25" class="i">+            }.apply {
</a>                 job = coroutineContext.job
                 downloadStage = DownloadStage.DOWNLOADING
             }
<a href="#h3-10" id="h3-10" class="h">@@ -344,9 +344,7 @@ class DownloadProcessor (
</a>                     val renamedOverlayMedia = renameFromFileType(overlayMedia.file, overlayMedia.fileType)
                     val mergedOverlay: File = File.createTempFile(&quot;merged&quot;, &quot;.&quot; + media.fileType.fileExtension)
                     runCatching {
<a href="#h3-10-3" id="h3-10-3" class="d">-                        translation.format(&quot;download_toast&quot;, &quot;path&quot; to media.file.nameWithoutExtension).let {
</a><a href="#h3-10-4" id="h3-10-4" class="d">-                            runCatching { callback.onProgress(it) }.onFailure { fallbackToast(it) }
</a><a href="#h3-10-5" id="h3-10-5" class="d">-                        }
</a><a href="#h3-10-6" id="h3-10-6" class="i">+                        callbackOnProgress(translation.format(&quot;download_toast&quot;, &quot;path&quot; to media.file.nameWithoutExtension))
</a>                         pendingDownloadObject.downloadStage = DownloadStage.MERGING
 
                         MediaDownloaderHelper.mergeOverlayFile(
<a href="#h3-11" id="h3-11" class="h">@@ -359,9 +357,7 @@ class DownloadProcessor (
</a>                     }.onFailure { exception -&gt;
                         if (coroutineContext.job.isCancelled) return@onFailure
                         Logger.error(exception)
<a href="#h3-11-3" id="h3-11-3" class="d">-                        translation.format(&quot;failed_processing_toast&quot;, &quot;error&quot; to exception.toString()).let {
</a><a href="#h3-11-4" id="h3-11-4" class="d">-                            runCatching { callback.onFailure(it, exception.message) }.onFailure { fallbackToast(it) }
</a><a href="#h3-11-5" id="h3-11-5" class="d">-                        }
</a><a href="#h3-11-6" id="h3-11-6" class="i">+                        callbackOnFailure(translation.format(&quot;failed_processing_toast&quot;, &quot;error&quot; to exception.toString()), exception.message)
</a>                         pendingDownloadObject.downloadStage = DownloadStage.MERGE_FAILED
                     }
 
<a href="#h3-12" id="h3-12" class="h">@@ -375,9 +371,7 @@ class DownloadProcessor (
</a>             }.onFailure { exception -&gt;
                 pendingDownloadObject.downloadStage = DownloadStage.FAILED
                 Logger.error(exception)
<a href="#h3-12-3" id="h3-12-3" class="d">-                translation[&quot;failed_generic_toast&quot;].let {
</a><a href="#h3-12-4" id="h3-12-4" class="d">-                    runCatching { callback.onFailure(it, exception.message) }.onFailure { fallbackToast(it) }
</a><a href="#h3-12-5" id="h3-12-5" class="d">-                }
</a><a href="#h3-12-6" id="h3-12-6" class="i">+                callbackOnFailure(translation[&quot;failed_generic_toast&quot;], exception.message)
</a>             }
         }
     }
<b>diff --git a/<a id="h4" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/MainActivity.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/MainActivity.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/MainActivity.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/MainActivity.kt</a></b>
<a href="#h4-0" id="h4-0" class="h">@@ -11,6 +11,13 @@ import me.rhunk.snapenhance.SharedContextHolder
</a> import me.rhunk.snapenhance.ui.AppMaterialTheme
 
 class MainActivity : ComponentActivity() {
<a href="#h4-0-3" id="h4-0-3" class="i">+    lateinit var sections: Map&lt;EnumSection, Section&gt;
</a><a href="#h4-0-4" id="h4-0-4" class="i">+
</a><a href="#h4-0-5" id="h4-0-5" class="i">+    override fun onPostResume() {
</a><a href="#h4-0-6" id="h4-0-6" class="i">+        super.onPostResume()
</a><a href="#h4-0-7" id="h4-0-7" class="i">+        sections.values.forEach { it.onResumed() }
</a><a href="#h4-0-8" id="h4-0-8" class="i">+    }
</a><a href="#h4-0-9" id="h4-0-9" class="i">+
</a>     override fun onCreate(savedInstanceState: Bundle?) {
         super.onCreate(savedInstanceState)
 
<a href="#h4-1" id="h4-1" class="h">@@ -20,8 +27,12 @@ class MainActivity : ComponentActivity() {
</a>             checkForRequirements()
         }
 
<a href="#h4-1-3" id="h4-1-3" class="d">-        val sections = EnumSection.values().toList().associateWith {
</a><a href="#h4-1-4" id="h4-1-4" class="d">-            it.section.constructors.first().call()
</a><a href="#h4-1-5" id="h4-1-5" class="i">+        sections = EnumSection.values().toList().associateWith {
</a><a href="#h4-1-6" id="h4-1-6" class="i">+            runCatching {
</a><a href="#h4-1-7" id="h4-1-7" class="i">+                it.section.constructors.first().call()
</a><a href="#h4-1-8" id="h4-1-8" class="i">+            }.onFailure {
</a><a href="#h4-1-9" id="h4-1-9" class="i">+                it.printStackTrace()
</a><a href="#h4-1-10" id="h4-1-10" class="i">+            }.getOrThrow()
</a>         }.onEach { (section, instance) -&gt;
             with(instance) {
                 enumSection = section
<b>diff --git a/<a id="h5" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/Section.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/Section.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/Section.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/Section.kt</a></b>
<a href="#h5-0" id="h5-0" class="h">@@ -14,6 +14,7 @@ import androidx.navigation.compose.composable
</a> import me.rhunk.snapenhance.RemoteSideContext
 import me.rhunk.snapenhance.ui.manager.sections.HomeSection
 import me.rhunk.snapenhance.ui.manager.sections.NotImplemented
<a href="#h5-0-3" id="h5-0-3" class="i">+import me.rhunk.snapenhance.ui.manager.sections.download.DownloadSection
</a> import me.rhunk.snapenhance.ui.manager.sections.features.FeaturesSection
 import kotlin.reflect.KClass
 
<a href="#h5-1" id="h5-1" class="h">@@ -26,7 +27,8 @@ enum class EnumSection(
</a>     DOWNLOADS(
         route = &quot;downloads&quot;,
         title = &quot;Downloads&quot;,
<a href="#h5-1-3" id="h5-1-3" class="d">-        icon = Icons.Filled.Download
</a><a href="#h5-1-4" id="h5-1-4" class="i">+        icon = Icons.Filled.Download,
</a><a href="#h5-1-5" id="h5-1-5" class="i">+        section = DownloadSection::class
</a>     ),
     FEATURES(
         route = &quot;features&quot;,
<a href="#h5-2" id="h5-2" class="h">@@ -66,6 +68,7 @@ open class Section {
</a>     lateinit var navController: NavController
 
     open fun init() {}
<a href="#h5-2-3" id="h5-2-3" class="i">+    open fun onResumed() {}
</a> 
     @Composable
     open fun Content() { NotImplemented() }
<b>diff --git a/<a id="h6" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/HomeSection.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/HomeSection.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/HomeSection.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/HomeSection.kt</a></b>
<a href="#h6-0" id="h6-0" class="h">@@ -18,11 +18,13 @@ import androidx.compose.material3.Icon
</a> import androidx.compose.material3.OutlinedCard
 import androidx.compose.material3.Text
 import androidx.compose.runtime.Composable
<a href="#h6-0-3" id="h6-0-3" class="i">+import androidx.compose.runtime.mutableStateOf
</a> import androidx.compose.ui.Alignment
 import androidx.compose.ui.Modifier
 import androidx.compose.ui.tooling.preview.Preview
 import androidx.compose.ui.unit.dp
 import androidx.compose.ui.unit.sp
<a href="#h6-0-9" id="h6-0-9" class="i">+import me.rhunk.snapenhance.Logger
</a> import me.rhunk.snapenhance.ui.manager.Section
 import me.rhunk.snapenhance.ui.manager.data.InstallationSummary
 import me.rhunk.snapenhance.ui.setup.Requirements
<a href="#h6-1" id="h6-1" class="h">@@ -31,6 +33,7 @@ class HomeSection : Section() {
</a>     companion object {
         val cardMargin = 10.dp
     }
<a href="#h6-1-3" id="h6-1-3" class="i">+    private val installationSummary = mutableStateOf(null as InstallationSummary?)
</a> 
     @OptIn(ExperimentalLayoutApi::class)
     @Composable
<a href="#h6-2" id="h6-2" class="h">@@ -72,7 +75,8 @@ class HomeSection : Section() {
</a>                     &quot;Mappings ${if (installationSummary.mappingsInfo == null) &quot;not generated&quot; else &quot;outdated&quot;}&quot;
                 } else {
                     &quot;Mappings version ${installationSummary.mappingsInfo.generatedSnapchatVersion}&quot;
<a href="#h6-2-3" id="h6-2-3" class="d">-                }, modifier = Modifier.weight(1f)
</a><a href="#h6-2-4" id="h6-2-4" class="i">+                }, modifier = Modifier
</a><a href="#h6-2-5" id="h6-2-5" class="i">+                    .weight(1f)
</a>                     .align(Alignment.CenterVertically)
                 )
 
<a href="#h6-3" id="h6-3" class="h">@@ -86,6 +90,14 @@ class HomeSection : Section() {
</a>         }
     }
 
<a href="#h6-3-3" id="h6-3-3" class="i">+    override fun onResumed() {
</a><a href="#h6-3-4" id="h6-3-4" class="i">+        Logger.debug(&quot;HomeSection resumed&quot;)
</a><a href="#h6-3-5" id="h6-3-5" class="i">+        if (!context.mappings.isMappingsLoaded()) {
</a><a href="#h6-3-6" id="h6-3-6" class="i">+            context.mappings.init()
</a><a href="#h6-3-7" id="h6-3-7" class="i">+        }
</a><a href="#h6-3-8" id="h6-3-8" class="i">+        installationSummary.value = context.getInstallationSummary()
</a><a href="#h6-3-9" id="h6-3-9" class="i">+    }
</a><a href="#h6-3-10" id="h6-3-10" class="i">+
</a>     @Composable
     @Preview
     override fun Content() {
<a href="#h6-4" id="h6-4" class="h">@@ -105,7 +117,7 @@ class HomeSection : Section() {
</a>                 modifier = Modifier.padding(16.dp)
             )
 
<a href="#h6-4-3" id="h6-4-3" class="d">-            SummaryCards(context.getInstallationSummary())
</a><a href="#h6-4-4" id="h6-4-4" class="i">+            SummaryCards(installationSummary = installationSummary.value ?: return)
</a>         }
     }
 } 
\ No newline at end of file
<b>diff --git a/<a id="h7" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/download/DownloadSection.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/download/DownloadSection.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/download/DownloadSection.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/download/DownloadSection.kt</a></b>
<a href="#h7-0" id="h7-0" class="h">@@ -0,0 +1,11 @@
</a><a href="#h7-0-0" id="h7-0-0" class="i">+package me.rhunk.snapenhance.ui.manager.sections.download
</a><a href="#h7-0-1" id="h7-0-1" class="i">+
</a><a href="#h7-0-2" id="h7-0-2" class="i">+import androidx.compose.runtime.Composable
</a><a href="#h7-0-3" id="h7-0-3" class="i">+import me.rhunk.snapenhance.ui.manager.Section
</a><a href="#h7-0-4" id="h7-0-4" class="i">+
</a><a href="#h7-0-5" id="h7-0-5" class="i">+class DownloadSection : Section() {
</a><a href="#h7-0-6" id="h7-0-6" class="i">+    @Composable
</a><a href="#h7-0-7" id="h7-0-7" class="i">+    override fun Content() {
</a><a href="#h7-0-8" id="h7-0-8" class="i">+
</a><a href="#h7-0-9" id="h7-0-9" class="i">+    }
</a><a href="#h7-0-10" id="h7-0-10" class="i">+}</a><a href="#h7-0-11" id="h7-0-11" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h8" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/Requirements.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/Requirements.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/Requirements.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/Requirements.kt</a></b>
<a href="#h8-0" id="h8-0" class="h">@@ -5,7 +5,6 @@ object Requirements {
</a>     const val LANGUAGE = 0b00010
     const val MAPPINGS = 0b00100
     const val SAVE_FOLDER = 0b01000
<a href="#h8-0-3" id="h8-0-3" class="d">-    const val FFMPEG = 0b10000
</a> 
     fun getName(requirement: Int): String {
         return when (requirement) {
<a href="#h8-1" id="h8-1" class="h">@@ -13,7 +12,6 @@ object Requirements {
</a>             LANGUAGE -&gt; &quot;LANGUAGE&quot;
             MAPPINGS -&gt; &quot;MAPPINGS&quot;
             SAVE_FOLDER -&gt; &quot;SAVE_FOLDER&quot;
<a href="#h8-1-3" id="h8-1-3" class="d">-            FFMPEG -&gt; &quot;FFMPEG&quot;
</a>             else -&gt; &quot;UNKNOWN&quot;
         }
     }
<b>diff --git a/<a id="h9" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/SetupActivity.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/SetupActivity.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/SetupActivity.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/SetupActivity.kt</a></b>
<a href="#h9-0" id="h9-0" class="h">@@ -34,7 +34,6 @@ import androidx.navigation.compose.rememberNavController
</a> import me.rhunk.snapenhance.SharedContextHolder
 import me.rhunk.snapenhance.ui.AppMaterialTheme
 import me.rhunk.snapenhance.ui.setup.screens.SetupScreen
<a href="#h9-0-3" id="h9-0-3" class="d">-import me.rhunk.snapenhance.ui.setup.screens.impl.FfmpegScreen
</a> import me.rhunk.snapenhance.ui.setup.screens.impl.MappingsScreen
 import me.rhunk.snapenhance.ui.setup.screens.impl.PickLanguageScreen
 import me.rhunk.snapenhance.ui.setup.screens.impl.SaveFolderScreen
<a href="#h9-1" id="h9-1" class="h">@@ -65,9 +64,6 @@ class SetupActivity : ComponentActivity() {
</a>             if (isFirstRun || hasRequirement(Requirements.MAPPINGS)) {
                 add(MappingsScreen().apply { route = &quot;mappings&quot; })
             }
<a href="#h9-1-3" id="h9-1-3" class="d">-            if (isFirstRun || hasRequirement(Requirements.FFMPEG)) {
</a><a href="#h9-1-4" id="h9-1-4" class="d">-                add(FfmpegScreen().apply { route = &quot;ffmpeg&quot; })
</a><a href="#h9-1-5" id="h9-1-5" class="d">-            }
</a>         }
 
         // If there are no required screens, we can just finish the activity
<b>diff --git a/<a id="h10" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/screens/impl/FfmpegScreen.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/screens/impl/FfmpegScreen.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/screens/impl/FfmpegScreen.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/screens/impl/FfmpegScreen.kt</a></b>
<a href="#h10-0" id="h10-0" class="h">@@ -1,17 +0,0 @@
</a><a href="#h10-0-0" id="h10-0-0" class="d">-package me.rhunk.snapenhance.ui.setup.screens.impl
</a><a href="#h10-0-1" id="h10-0-1" class="d">-
</a><a href="#h10-0-2" id="h10-0-2" class="d">-import androidx.compose.material3.Button
</a><a href="#h10-0-3" id="h10-0-3" class="d">-import androidx.compose.material3.Text
</a><a href="#h10-0-4" id="h10-0-4" class="d">-import androidx.compose.runtime.Composable
</a><a href="#h10-0-5" id="h10-0-5" class="d">-import me.rhunk.snapenhance.ui.setup.screens.SetupScreen
</a><a href="#h10-0-6" id="h10-0-6" class="d">-
</a><a href="#h10-0-7" id="h10-0-7" class="d">-class FfmpegScreen : SetupScreen() {
</a><a href="#h10-0-8" id="h10-0-8" class="d">-
</a><a href="#h10-0-9" id="h10-0-9" class="d">-    @Composable
</a><a href="#h10-0-10" id="h10-0-10" class="d">-    override fun Content() {
</a><a href="#h10-0-11" id="h10-0-11" class="d">-        Text(text = &quot;FFmpeg&quot;)
</a><a href="#h10-0-12" id="h10-0-12" class="d">-        Button(onClick = { allowNext(true) }) {
</a><a href="#h10-0-13" id="h10-0-13" class="d">-            Text(text = &quot;Next&quot;)
</a><a href="#h10-0-14" id="h10-0-14" class="d">-        }
</a><a href="#h10-0-15" id="h10-0-15" class="d">-    }
</a><a href="#h10-0-16" id="h10-0-16" class="d">-}</a><a href="#h10-0-17" id="h10-0-17" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h11" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/screens/impl/PickLanguageScreen.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/screens/impl/PickLanguageScreen.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/screens/impl/PickLanguageScreen.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/screens/impl/PickLanguageScreen.kt</a></b>
<a href="#h11-0" id="h11-0" class="h">@@ -40,7 +40,7 @@ class PickLanguageScreen : SetupScreen(){
</a> 
         fun getLocaleDisplayName(locale: String): String {
             locale.split(&quot;_&quot;).let {
<a href="#h11-0-3" id="h11-0-3" class="d">-                return java.util.Locale(it[0], it[1]).getDisplayName(java.util.Locale.getDefault())
</a><a href="#h11-0-4" id="h11-0-4" class="i">+                return Locale(it[0], it[1]).getDisplayName(Locale.getDefault())
</a>             }
         }
 
<b>diff --git a/<a id="h12" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/SharedContext.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/SharedContext.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/SharedContext.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/SharedContext.kt</a></b>
<a href="#h12-0" id="h12-0" class="h">@@ -18,51 +18,6 @@ object SharedContext {
</a>     lateinit var downloadTaskManager: DownloadTaskManager
     lateinit var translation: LocaleWrapper
 
<a href="#h12-0-3" id="h12-0-3" class="d">-    private fun askForStoragePermission(context: Context) {
</a><a href="#h12-0-4" id="h12-0-4" class="d">-        if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.R) {
</a><a href="#h12-0-5" id="h12-0-5" class="d">-            val intent = Intent(Settings.ACTION_MANAGE_APP_ALL_FILES_ACCESS_PERMISSION)
</a><a href="#h12-0-6" id="h12-0-6" class="d">-            intent.addCategory(&quot;android.intent.category.DEFAULT&quot;)
</a><a href="#h12-0-7" id="h12-0-7" class="d">-            intent.data = android.net.Uri.parse(&quot;package:${context.packageName}&quot;)
</a><a href="#h12-0-8" id="h12-0-8" class="d">-            if (context !is Activity) {
</a><a href="#h12-0-9" id="h12-0-9" class="d">-                intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK)
</a><a href="#h12-0-10" id="h12-0-10" class="d">-            }
</a><a href="#h12-0-11" id="h12-0-11" class="d">-            context.startActivity(intent)
</a><a href="#h12-0-12" id="h12-0-12" class="d">-            exitProcess(0)
</a><a href="#h12-0-13" id="h12-0-13" class="d">-        }
</a><a href="#h12-0-14" id="h12-0-14" class="d">-        if (context !is Activity) {
</a><a href="#h12-0-15" id="h12-0-15" class="d">-            Logger.log(&quot;Storage permission not granted, exiting&quot;)
</a><a href="#h12-0-16" id="h12-0-16" class="d">-            exitProcess(0)
</a><a href="#h12-0-17" id="h12-0-17" class="d">-        }
</a><a href="#h12-0-18" id="h12-0-18" class="d">-        context.requestPermissions(arrayOf(android.Manifest.permission.WRITE_EXTERNAL_STORAGE, android.Manifest.permission.READ_EXTERNAL_STORAGE), 0)
</a><a href="#h12-0-19" id="h12-0-19" class="d">-    }
</a><a href="#h12-0-20" id="h12-0-20" class="d">-
</a><a href="#h12-0-21" id="h12-0-21" class="d">-    private fun askForPermissions(context: Context) {
</a><a href="#h12-0-22" id="h12-0-22" class="d">-
</a><a href="#h12-0-23" id="h12-0-23" class="d">-        //ask for storage permission
</a><a href="#h12-0-24" id="h12-0-24" class="d">-        val hasStoragePermission = if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.R) {
</a><a href="#h12-0-25" id="h12-0-25" class="d">-            Environment.isExternalStorageManager()
</a><a href="#h12-0-26" id="h12-0-26" class="d">-        } else {
</a><a href="#h12-0-27" id="h12-0-27" class="d">-            context.checkSelfPermission(android.Manifest.permission.WRITE_EXTERNAL_STORAGE) == android.content.pm.PackageManager.PERMISSION_GRANTED
</a><a href="#h12-0-28" id="h12-0-28" class="d">-        }
</a><a href="#h12-0-29" id="h12-0-29" class="d">-
</a><a href="#h12-0-30" id="h12-0-30" class="d">-        if (hasStoragePermission) return
</a><a href="#h12-0-31" id="h12-0-31" class="d">-
</a><a href="#h12-0-32" id="h12-0-32" class="d">-        if (context !is Activity) {
</a><a href="#h12-0-33" id="h12-0-33" class="d">-            askForStoragePermission(context)
</a><a href="#h12-0-34" id="h12-0-34" class="d">-            return
</a><a href="#h12-0-35" id="h12-0-35" class="d">-        }
</a><a href="#h12-0-36" id="h12-0-36" class="d">-        AlertDialog.Builder(context)
</a><a href="#h12-0-37" id="h12-0-37" class="d">-            .setTitle(&quot;Storage permission&quot;)
</a><a href="#h12-0-38" id="h12-0-38" class="d">-            .setMessage(&quot;App needs storage permission to download files and save them to your device. Please allow it in the next screen.&quot;)
</a><a href="#h12-0-39" id="h12-0-39" class="d">-            .setPositiveButton(&quot;Grant&quot;) { _, _ -&gt;
</a><a href="#h12-0-40" id="h12-0-40" class="d">-                askForStoragePermission(context)
</a><a href="#h12-0-41" id="h12-0-41" class="d">-            }
</a><a href="#h12-0-42" id="h12-0-42" class="d">-            .setNegativeButton(&quot;Cancel&quot;) { _, _ -&gt;
</a><a href="#h12-0-43" id="h12-0-43" class="d">-                exitProcess(0)
</a><a href="#h12-0-44" id="h12-0-44" class="d">-            }
</a><a href="#h12-0-45" id="h12-0-45" class="d">-            .show()
</a><a href="#h12-0-46" id="h12-0-46" class="d">-    }
</a><a href="#h12-0-47" id="h12-0-47" class="d">-
</a>     fun ensureInitialized(context: Context) {
         if (!this::downloadTaskManager.isInitialized) {
             downloadTaskManager = DownloadTaskManager().apply {
<b>diff --git a/<a id="h13" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/DownloaderConfig.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/DownloaderConfig.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/DownloaderConfig.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/config/impl/DownloaderConfig.kt</a></b>
<a href="#h13-0" id="h13-0" class="h">@@ -16,9 +16,11 @@ class DownloaderConfig : ConfigContainer() {
</a>         &quot;append_date_time&quot;,
         &quot;append_type&quot;,
         &quot;append_username&quot;
<a href="#h13-0-3" id="h13-0-3" class="d">-    )
</a><a href="#h13-0-4" id="h13-0-4" class="i">+    ).apply { set(mutableListOf(&quot;append_hash&quot;, &quot;append_date_time&quot;, &quot;append_type&quot;, &quot;append_username&quot;)) }
</a>     val allowDuplicate = boolean(&quot;allow_duplicate&quot;)
     val mergeOverlays = boolean(&quot;merge_overlays&quot;)
     val chatDownloadContextMenu = boolean(&quot;chat_download_context_menu&quot;)
<a href="#h13-0-8" id="h13-0-8" class="d">-    val logging = multiple(&quot;logging&quot;, &quot;started&quot;, &quot;success&quot;, &quot;progress&quot;, &quot;failure&quot;)
</a><a href="#h13-0-9" id="h13-0-9" class="i">+    val logging = multiple(&quot;logging&quot;, &quot;started&quot;, &quot;success&quot;, &quot;progress&quot;, &quot;failure&quot;).apply {
</a><a href="#h13-0-10" id="h13-0-10" class="i">+        set(mutableListOf(&quot;started&quot;, &quot;success&quot;))
</a><a href="#h13-0-11" id="h13-0-11" class="i">+    }
</a> } 
\ No newline at end of file
<b>diff --git a/<a id="h14" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/download/DownloadManagerClient.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/download/DownloadManagerClient.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/download/DownloadManagerClient.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/download/DownloadManagerClient.kt</a></b>
<a href="#h14-0" id="h14-0" class="h">@@ -9,7 +9,7 @@ import me.rhunk.snapenhance.download.data.DownloadMetadata
</a> import me.rhunk.snapenhance.download.data.DownloadRequest
 import me.rhunk.snapenhance.download.data.InputMedia
 import me.rhunk.snapenhance.download.data.MediaEncryptionKeyPair
<a href="#h14-0-3" id="h14-0-3" class="d">-import me.rhunk.snapenhance.download.enums.DownloadMediaType
</a><a href="#h14-0-4" id="h14-0-4" class="i">+import me.rhunk.snapenhance.download.data.DownloadMediaType
</a> 
 class DownloadManagerClient (
     private val context: ModContext,
<b>diff --git a/<a id="h15" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/download/DownloadTaskManager.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/download/DownloadTaskManager.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/download/DownloadTaskManager.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/download/DownloadTaskManager.kt</a></b>
<a href="#h15-0" id="h15-0" class="h">@@ -5,7 +5,7 @@ import android.content.Context
</a> import android.database.sqlite.SQLiteDatabase
 import me.rhunk.snapenhance.download.data.DownloadMetadata
 import me.rhunk.snapenhance.download.data.PendingDownload
<a href="#h15-0-3" id="h15-0-3" class="d">-import me.rhunk.snapenhance.download.enums.DownloadStage
</a><a href="#h15-0-4" id="h15-0-4" class="i">+import me.rhunk.snapenhance.download.data.DownloadStage
</a> import me.rhunk.snapenhance.ui.download.MediaFilter
 import me.rhunk.snapenhance.util.SQLiteDatabaseHelper
 
<a href="#h15-1" id="h15-1" class="h">@@ -158,6 +158,7 @@ class DownloadTaskManager {
</a>                     iconUrl = cursor.getString(cursor.getColumnIndex(&quot;iconUrl&quot;))
                 )
             ).apply {
<a href="#h15-1-3" id="h15-1-3" class="i">+                downloadTaskManager = this@DownloadTaskManager
</a>                 downloadStage = DownloadStage.valueOf(cursor.getString(cursor.getColumnIndex(&quot;downloadStage&quot;)))
                 //if downloadStage is not saved, it means the app was killed before the download was finished
                 if (downloadStage != DownloadStage.SAVED) {
<b>diff --git a/<a id="h16" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/download/data/DownloadMediaType.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/download/data/DownloadMediaType.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/download/data/DownloadMediaType.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/download/data/DownloadMediaType.kt</a></b>
<a href="#h16-0" id="h16-0" class="h">@@ -0,0 +1,22 @@
</a><a href="#h16-0-0" id="h16-0-0" class="i">+package me.rhunk.snapenhance.download.data
</a><a href="#h16-0-1" id="h16-0-1" class="i">+
</a><a href="#h16-0-2" id="h16-0-2" class="i">+import android.net.Uri
</a><a href="#h16-0-3" id="h16-0-3" class="i">+
</a><a href="#h16-0-4" id="h16-0-4" class="i">+enum class DownloadMediaType {
</a><a href="#h16-0-5" id="h16-0-5" class="i">+    PROTO_MEDIA,
</a><a href="#h16-0-6" id="h16-0-6" class="i">+    DIRECT_MEDIA,
</a><a href="#h16-0-7" id="h16-0-7" class="i">+    REMOTE_MEDIA,
</a><a href="#h16-0-8" id="h16-0-8" class="i">+    LOCAL_MEDIA;
</a><a href="#h16-0-9" id="h16-0-9" class="i">+
</a><a href="#h16-0-10" id="h16-0-10" class="i">+    companion object {
</a><a href="#h16-0-11" id="h16-0-11" class="i">+        fun fromUri(uri: Uri): DownloadMediaType {
</a><a href="#h16-0-12" id="h16-0-12" class="i">+            return when (uri.scheme) {
</a><a href="#h16-0-13" id="h16-0-13" class="i">+                &quot;proto&quot; -&gt; PROTO_MEDIA
</a><a href="#h16-0-14" id="h16-0-14" class="i">+                &quot;direct&quot; -&gt; DIRECT_MEDIA
</a><a href="#h16-0-15" id="h16-0-15" class="i">+                &quot;http&quot;, &quot;https&quot; -&gt; REMOTE_MEDIA
</a><a href="#h16-0-16" id="h16-0-16" class="i">+                &quot;file&quot; -&gt; LOCAL_MEDIA
</a><a href="#h16-0-17" id="h16-0-17" class="i">+                else -&gt; throw IllegalArgumentException(&quot;Unknown uri scheme: ${uri.scheme}&quot;)
</a><a href="#h16-0-18" id="h16-0-18" class="i">+            }
</a><a href="#h16-0-19" id="h16-0-19" class="i">+        }
</a><a href="#h16-0-20" id="h16-0-20" class="i">+    }
</a><a href="#h16-0-21" id="h16-0-21" class="i">+}</a><a href="#h16-0-22" id="h16-0-22" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h17" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/download/data/DownloadRequest.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/download/data/DownloadRequest.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/download/data/DownloadRequest.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/download/data/DownloadRequest.kt</a></b>
<a href="#h17-0" id="h17-0" class="h">@@ -1,7 +1,5 @@
</a> package me.rhunk.snapenhance.download.data
 
<a href="#h17-0-2" id="h17-0-2" class="d">-import me.rhunk.snapenhance.download.enums.DownloadMediaType
</a><a href="#h17-0-3" id="h17-0-3" class="d">-
</a> 
 data class DashOptions(val offsetTime: Long, val duration: Long?)
 data class InputMedia(
<b>diff --git a/<a id="h18" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/download/data/DownloadStage.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/download/data/DownloadStage.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/download/data/DownloadStage.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/download/data/DownloadStage.kt</a></b>
<a href="#h18-0" id="h18-0" class="h">@@ -0,0 +1,14 @@
</a><a href="#h18-0-0" id="h18-0-0" class="i">+package me.rhunk.snapenhance.download.data
</a><a href="#h18-0-1" id="h18-0-1" class="i">+
</a><a href="#h18-0-2" id="h18-0-2" class="i">+enum class DownloadStage(
</a><a href="#h18-0-3" id="h18-0-3" class="i">+    val isFinalStage: Boolean = false,
</a><a href="#h18-0-4" id="h18-0-4" class="i">+) {
</a><a href="#h18-0-5" id="h18-0-5" class="i">+    PENDING(false),
</a><a href="#h18-0-6" id="h18-0-6" class="i">+    DOWNLOADING(false),
</a><a href="#h18-0-7" id="h18-0-7" class="i">+    MERGING(false),
</a><a href="#h18-0-8" id="h18-0-8" class="i">+    DOWNLOADED(true),
</a><a href="#h18-0-9" id="h18-0-9" class="i">+    SAVED(true),
</a><a href="#h18-0-10" id="h18-0-10" class="i">+    MERGE_FAILED(true),
</a><a href="#h18-0-11" id="h18-0-11" class="i">+    FAILED(true),
</a><a href="#h18-0-12" id="h18-0-12" class="i">+    CANCELLED(true)
</a><a href="#h18-0-13" id="h18-0-13" class="i">+}</a><a href="#h18-0-14" id="h18-0-14" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h19" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/download/data/PendingDownload.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/download/data/PendingDownload.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/download/data/PendingDownload.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/download/data/PendingDownload.kt</a></b>
<a href="#h19-0" id="h19-0" class="h">@@ -2,15 +2,16 @@ package me.rhunk.snapenhance.download.data
</a> 
 import kotlinx.coroutines.Job
 import me.rhunk.snapenhance.SharedContext
<a href="#h19-0-3" id="h19-0-3" class="d">-import me.rhunk.snapenhance.download.enums.DownloadStage
</a><a href="#h19-0-4" id="h19-0-4" class="i">+import me.rhunk.snapenhance.download.DownloadTaskManager
</a> 
 data class PendingDownload(
     var downloadId: Int = 0,
     var outputFile: String? = null,
<a href="#h19-0-9" id="h19-0-9" class="d">-    var job: Job? = null,
</a><a href="#h19-0-10" id="h19-0-10" class="d">-
</a>     val metadata : DownloadMetadata
 ) {
<a href="#h19-0-13" id="h19-0-13" class="i">+    lateinit var downloadTaskManager: DownloadTaskManager
</a><a href="#h19-0-14" id="h19-0-14" class="i">+    var job: Job? = null
</a><a href="#h19-0-15" id="h19-0-15" class="i">+
</a>     var changeListener = { _: DownloadStage, _: DownloadStage -&gt; }
     private var _stage: DownloadStage = DownloadStage.PENDING
     var downloadStage: DownloadStage
<a href="#h19-1" id="h19-1" class="h">@@ -20,15 +21,13 @@ data class PendingDownload(
</a>         set(value) = synchronized(this) {
             changeListener(_stage, value)
             _stage = value
<a href="#h19-1-3" id="h19-1-3" class="d">-            SharedContext.downloadTaskManager.updateTask(this)
</a><a href="#h19-1-4" id="h19-1-4" class="i">+            downloadTaskManager.updateTask(this)
</a>         }
 
<a href="#h19-1-7" id="h19-1-7" class="d">-    fun isJobActive(): Boolean {
</a><a href="#h19-1-8" id="h19-1-8" class="d">-        return job?.isActive ?: false
</a><a href="#h19-1-9" id="h19-1-9" class="d">-    }
</a><a href="#h19-1-10" id="h19-1-10" class="i">+    fun isJobActive() = job?.isActive == true
</a> 
     fun cancel() {
<a href="#h19-1-13" id="h19-1-13" class="d">-        job?.cancel()
</a>         downloadStage = DownloadStage.CANCELLED
<a href="#h19-1-15" id="h19-1-15" class="i">+        job?.cancel()
</a>     }
 }
<b>diff --git a/<a id="h20" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/download/enums/DownloadMediaType.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/download/enums/DownloadMediaType.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/download/enums/DownloadMediaType.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/download/enums/DownloadMediaType.kt</a></b>
<a href="#h20-0" id="h20-0" class="h">@@ -1,22 +0,0 @@
</a><a href="#h20-0-0" id="h20-0-0" class="d">-package me.rhunk.snapenhance.download.enums
</a><a href="#h20-0-1" id="h20-0-1" class="d">-
</a><a href="#h20-0-2" id="h20-0-2" class="d">-import android.net.Uri
</a><a href="#h20-0-3" id="h20-0-3" class="d">-
</a><a href="#h20-0-4" id="h20-0-4" class="d">-enum class DownloadMediaType {
</a><a href="#h20-0-5" id="h20-0-5" class="d">-    PROTO_MEDIA,
</a><a href="#h20-0-6" id="h20-0-6" class="d">-    DIRECT_MEDIA,
</a><a href="#h20-0-7" id="h20-0-7" class="d">-    REMOTE_MEDIA,
</a><a href="#h20-0-8" id="h20-0-8" class="d">-    LOCAL_MEDIA;
</a><a href="#h20-0-9" id="h20-0-9" class="d">-
</a><a href="#h20-0-10" id="h20-0-10" class="d">-    companion object {
</a><a href="#h20-0-11" id="h20-0-11" class="d">-        fun fromUri(uri: Uri): DownloadMediaType {
</a><a href="#h20-0-12" id="h20-0-12" class="d">-            return when (uri.scheme) {
</a><a href="#h20-0-13" id="h20-0-13" class="d">-                &quot;proto&quot; -&gt; PROTO_MEDIA
</a><a href="#h20-0-14" id="h20-0-14" class="d">-                &quot;direct&quot; -&gt; DIRECT_MEDIA
</a><a href="#h20-0-15" id="h20-0-15" class="d">-                &quot;http&quot;, &quot;https&quot; -&gt; REMOTE_MEDIA
</a><a href="#h20-0-16" id="h20-0-16" class="d">-                &quot;file&quot; -&gt; LOCAL_MEDIA
</a><a href="#h20-0-17" id="h20-0-17" class="d">-                else -&gt; throw IllegalArgumentException(&quot;Unknown uri scheme: ${uri.scheme}&quot;)
</a><a href="#h20-0-18" id="h20-0-18" class="d">-            }
</a><a href="#h20-0-19" id="h20-0-19" class="d">-        }
</a><a href="#h20-0-20" id="h20-0-20" class="d">-    }
</a><a href="#h20-0-21" id="h20-0-21" class="d">-}</a><a href="#h20-0-22" id="h20-0-22" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h21" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/download/enums/DownloadStage.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/download/enums/DownloadStage.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/download/enums/DownloadStage.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/download/enums/DownloadStage.kt</a></b>
<a href="#h21-0" id="h21-0" class="h">@@ -1,14 +0,0 @@
</a><a href="#h21-0-0" id="h21-0-0" class="d">-package me.rhunk.snapenhance.download.enums
</a><a href="#h21-0-1" id="h21-0-1" class="d">-
</a><a href="#h21-0-2" id="h21-0-2" class="d">-enum class DownloadStage(
</a><a href="#h21-0-3" id="h21-0-3" class="d">-    val isFinalStage: Boolean = false,
</a><a href="#h21-0-4" id="h21-0-4" class="d">-) {
</a><a href="#h21-0-5" id="h21-0-5" class="d">-    PENDING(false),
</a><a href="#h21-0-6" id="h21-0-6" class="d">-    DOWNLOADING(false),
</a><a href="#h21-0-7" id="h21-0-7" class="d">-    MERGING(false),
</a><a href="#h21-0-8" id="h21-0-8" class="d">-    DOWNLOADED(true),
</a><a href="#h21-0-9" id="h21-0-9" class="d">-    SAVED(true),
</a><a href="#h21-0-10" id="h21-0-10" class="d">-    MERGE_FAILED(true),
</a><a href="#h21-0-11" id="h21-0-11" class="d">-    FAILED(true),
</a><a href="#h21-0-12" id="h21-0-12" class="d">-    CANCELLED(true)
</a><a href="#h21-0-13" id="h21-0-13" class="d">-}</a><a href="#h21-0-14" id="h21-0-14" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h22" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/MediaDownloader.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/MediaDownloader.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/MediaDownloader.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/MediaDownloader.kt</a></b>
<a href="#h22-0" id="h22-0" class="h">@@ -5,7 +5,6 @@ import android.graphics.Bitmap
</a> import android.graphics.BitmapFactory
 import android.net.Uri
 import android.widget.ImageView
<a href="#h22-0-3" id="h22-0-3" class="d">-import com.arthenica.ffmpegkit.FFmpegKit
</a> import kotlinx.coroutines.runBlocking
 import me.rhunk.snapenhance.Constants.ARROYO_URL_KEY_PROTO_PATH
 import me.rhunk.snapenhance.Logger
<a href="#h22-1" id="h22-1" class="h">@@ -20,11 +19,11 @@ import me.rhunk.snapenhance.data.wrapper.impl.media.opera.Layer
</a> import me.rhunk.snapenhance.data.wrapper.impl.media.opera.ParamMap
 import me.rhunk.snapenhance.database.objects.FriendInfo
 import me.rhunk.snapenhance.download.DownloadManagerClient
<a href="#h22-1-3" id="h22-1-3" class="i">+import me.rhunk.snapenhance.download.data.DownloadMediaType
</a> import me.rhunk.snapenhance.download.data.DownloadMetadata
 import me.rhunk.snapenhance.download.data.InputMedia
 import me.rhunk.snapenhance.download.data.SplitMediaAssetType
 import me.rhunk.snapenhance.download.data.toKeyPair
<a href="#h22-1-8" id="h22-1-8" class="d">-import me.rhunk.snapenhance.download.enums.DownloadMediaType
</a> import me.rhunk.snapenhance.features.Feature
 import me.rhunk.snapenhance.features.FeatureLoadParams
 import me.rhunk.snapenhance.features.impl.Messaging
<a href="#h22-2" id="h22-2" class="h">@@ -52,11 +51,8 @@ import kotlin.io.encoding.ExperimentalEncodingApi
</a> class MediaDownloader : Feature(&quot;MediaDownloader&quot;, loadParams = FeatureLoadParams.ACTIVITY_CREATE_ASYNC) {
     private var lastSeenMediaInfoMap: MutableMap&lt;SplitMediaAssetType, MediaInfo&gt;? = null
     private var lastSeenMapParams: ParamMap? = null
<a href="#h22-2-3" id="h22-2-3" class="d">-    private val isFFmpegPresent by lazy {
</a><a href="#h22-2-4" id="h22-2-4" class="d">-        runCatching { FFmpegKit.execute(&quot;-version&quot;) }.isSuccess
</a><a href="#h22-2-5" id="h22-2-5" class="d">-    }
</a> 
<a href="#h22-2-7" id="h22-2-7" class="d">-    private fun provideClientDownloadManager(
</a><a href="#h22-2-8" id="h22-2-8" class="i">+    private fun provideDownloadManagerClient(
</a>         pathSuffix: String,
         mediaIdentifier: String,
         mediaDisplaySource: String? = null,
<a href="#h22-3" id="h22-3" class="h">@@ -115,10 +111,6 @@ class MediaDownloader : Feature(&quot;MediaDownloader&quot;, loadParams = FeatureLoadParam
</a>         )
     }
 
<a href="#h22-3-3" id="h22-3-3" class="d">-    private fun canMergeOverlay(): Boolean {
</a><a href="#h22-3-4" id="h22-3-4" class="d">-        if (!context.config.downloader.autoDownloadOptions.get().contains(&quot;merge_overlay&quot;)) return false
</a><a href="#h22-3-5" id="h22-3-5" class="d">-        return isFFmpegPresent
</a><a href="#h22-3-6" id="h22-3-6" class="d">-    }
</a> 
     //TODO: implement subfolder argument
     private fun createNewFilePath(hexHash: String, mediaDisplayType: String?, pathPrefix: String): String {
<a href="#h22-4" id="h22-4" class="h">@@ -246,7 +238,7 @@ class MediaDownloader : Feature(&quot;MediaDownloader&quot;, loadParams = FeatureLoadParam
</a>             val author = context.database.getFriendInfo(senderId) ?: return
             val authorUsername = author.usernameForSorting!!
 
<a href="#h22-4-3" id="h22-4-3" class="d">-            downloadOperaMedia(provideClientDownloadManager(
</a><a href="#h22-4-4" id="h22-4-4" class="i">+            downloadOperaMedia(provideDownloadManagerClient(
</a>                 pathSuffix = authorUsername,
                 mediaIdentifier = &quot;$conversationId$senderId${conversationMessage.server_message_id}&quot;,
                 mediaDisplaySource = authorUsername,
<a href="#h22-5" id="h22-5" class="h">@@ -286,7 +278,7 @@ class MediaDownloader : Feature(&quot;MediaDownloader&quot;, loadParams = FeatureLoadParam
</a>             ) ?: throw Exception(&quot;Friend not found in database&quot;)
             val authorName = author.usernameForSorting!!
 
<a href="#h22-5-3" id="h22-5-3" class="d">-            downloadOperaMedia(provideClientDownloadManager(
</a><a href="#h22-5-4" id="h22-5-4" class="i">+            downloadOperaMedia(provideDownloadManagerClient(
</a>                 pathSuffix = authorName,
                 mediaIdentifier = paramMap[&quot;MEDIA_ID&quot;].toString(),
                 mediaDisplaySource = authorName,
<a href="#h22-6" id="h22-6" class="h">@@ -305,7 +297,7 @@ class MediaDownloader : Feature(&quot;MediaDownloader&quot;, loadParams = FeatureLoadParam
</a>                     &quot;[^\\x00-\\x7F]&quot;.toRegex(),
                     &quot;&quot;)
 
<a href="#h22-6-3" id="h22-6-3" class="d">-            downloadOperaMedia(provideClientDownloadManager(
</a><a href="#h22-6-4" id="h22-6-4" class="i">+            downloadOperaMedia(provideDownloadManagerClient(
</a>                 pathSuffix = &quot;Public-Stories/$userDisplayName&quot;,
                 mediaIdentifier = paramMap[&quot;SNAP_ID&quot;].toString(),
                 mediaDisplayType = userDisplayName,
<a href="#h22-7" id="h22-7" class="h">@@ -316,7 +308,7 @@ class MediaDownloader : Feature(&quot;MediaDownloader&quot;, loadParams = FeatureLoadParam
</a> 
         //spotlight
         if (snapSource == &quot;SINGLE_SNAP_STORY&quot; &amp;&amp; (forceDownload || canAutoDownload(&quot;spotlight&quot;))) {
<a href="#h22-7-3" id="h22-7-3" class="d">-            downloadOperaMedia(provideClientDownloadManager(
</a><a href="#h22-7-4" id="h22-7-4" class="i">+            downloadOperaMedia(provideDownloadManagerClient(
</a>                 pathSuffix = &quot;Spotlight&quot;,
                 mediaIdentifier = paramMap[&quot;SNAP_ID&quot;].toString(),
                 mediaDisplayType = MediaFilter.SPOTLIGHT.mediaDisplayType,
<a href="#h22-8" id="h22-8" class="h">@@ -328,11 +320,6 @@ class MediaDownloader : Feature(&quot;MediaDownloader&quot;, loadParams = FeatureLoadParam
</a>         //stories with mpeg dash media
         //TODO: option to download multiple chapters
         if (paramMap.containsKey(&quot;LONGFORM_VIDEO_PLAYLIST_ITEM&quot;) &amp;&amp; forceDownload) {
<a href="#h22-8-3" id="h22-8-3" class="d">-            if (!isFFmpegPresent) {
</a><a href="#h22-8-4" id="h22-8-4" class="d">-                context.shortToast(&quot;Can&#39;t download media. ffmpeg was not found&quot;)
</a><a href="#h22-8-5" id="h22-8-5" class="d">-                return
</a><a href="#h22-8-6" id="h22-8-6" class="d">-            }
</a><a href="#h22-8-7" id="h22-8-7" class="d">-
</a>             val storyName = paramMap[&quot;STORY_NAME&quot;].toString().replace(
                 &quot;[^\\x00-\\x7F]&quot;.toRegex(),
                 &quot;&quot;)
<a href="#h22-9" id="h22-9" class="h">@@ -361,7 +348,7 @@ class MediaDownloader : Feature(&quot;MediaDownloader&quot;, loadParams = FeatureLoadParam
</a>                 }
             }
 
<a href="#h22-9-3" id="h22-9-3" class="d">-            provideClientDownloadManager(
</a><a href="#h22-9-4" id="h22-9-4" class="i">+            provideDownloadManagerClient(
</a>                 pathSuffix = &quot;Pro-Stories/${storyName}&quot;,
                 mediaIdentifier = &quot;${paramMap[&quot;STORY_ID&quot;]}-${snapItem.snapId}&quot;,
                 mediaDisplaySource = storyName,
<a href="#h22-10" id="h22-10" class="h">@@ -396,10 +383,12 @@ class MediaDownloader : Feature(&quot;MediaDownloader&quot;, loadParams = FeatureLoadParam
</a> 
             val mediaInfoMap = mutableMapOf&lt;SplitMediaAssetType, MediaInfo&gt;()
             val isVideo = mediaParamMap.containsKey(&quot;video_media_info_list&quot;)
<a href="#h22-10-3" id="h22-10-3" class="i">+            val canMergeOverlay = context.config.downloader.autoDownloadOptions.get().contains(&quot;merge_overlay&quot;)
</a><a href="#h22-10-4" id="h22-10-4" class="i">+
</a>             mediaInfoMap[SplitMediaAssetType.ORIGINAL] = MediaInfo(
                 (if (isVideo) mediaParamMap[&quot;video_media_info_list&quot;] else mediaParamMap[&quot;image_media_info&quot;])!!
             )
<a href="#h22-10-8" id="h22-10-8" class="d">-            if (canMergeOverlay() &amp;&amp; mediaParamMap.containsKey(&quot;overlay_image_media_info&quot;)) {
</a><a href="#h22-10-9" id="h22-10-9" class="i">+            if (canMergeOverlay &amp;&amp; mediaParamMap.containsKey(&quot;overlay_image_media_info&quot;)) {
</a>                 mediaInfoMap[SplitMediaAssetType.OVERLAY] =
                     MediaInfo(mediaParamMap[&quot;overlay_image_media_info&quot;]!!)
             }
<a href="#h22-11" id="h22-11" class="h">@@ -483,7 +472,7 @@ class MediaDownloader : Feature(&quot;MediaDownloader&quot;, loadParams = FeatureLoadParam
</a>         runCatching {
             if (!isPreview) {
                 val encryptionKeys = EncryptionHelper.getEncryptionKeys(contentType, messageReader, isArroyo = isArroyoMessage)
<a href="#h22-11-3" id="h22-11-3" class="d">-                provideClientDownloadManager(
</a><a href="#h22-11-4" id="h22-11-4" class="i">+                provideDownloadManagerClient(
</a>                     pathSuffix = authorName,
                     mediaIdentifier = &quot;${message.client_conversation_id}${message.sender_id}${message.server_message_id}&quot;,
                     mediaDisplaySource = authorName,
<b>diff --git a/<a id="h23" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/ui/download/DownloadListAdapter.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/ui/download/DownloadListAdapter.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/ui/download/DownloadListAdapter.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/ui/download/DownloadListAdapter.kt</a></b>
<a href="#h23-0" id="h23-0" class="h">@@ -27,7 +27,7 @@ import me.rhunk.snapenhance.SharedContext
</a> import me.rhunk.snapenhance.core.R
 import me.rhunk.snapenhance.data.FileType
 import me.rhunk.snapenhance.download.data.PendingDownload
<a href="#h23-0-3" id="h23-0-3" class="d">-import me.rhunk.snapenhance.download.enums.DownloadStage
</a><a href="#h23-0-4" id="h23-0-4" class="i">+import me.rhunk.snapenhance.download.data.DownloadStage
</a> import me.rhunk.snapenhance.util.snap.PreviewUtils
 import java.io.File
 import java.io.FileInputStream
</pre>
</div>
</body>
</html>
