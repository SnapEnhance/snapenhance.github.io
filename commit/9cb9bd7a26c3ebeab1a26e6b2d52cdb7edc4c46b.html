<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>feat: multiple media chat export - optimize message exporter download - optimize zip download/extract - SnapEnhance - An Xposed module offering an enhanced Snapchat experience
</title>
<link rel="icon" type="image/svg+xml" href="../../logo.png"/>
<link rel="alternate icon" href="../../favicon.png"/>
<link rel="alternate" type="application/atom+xml" title="SnapEnhance Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="SnapEnhance Atom Feed (tags)" href="../tags.xml" />
<link rel="stylesheet" type="text/css" href="../../style.css" />
<link rel="stylesheet" type="text/css" href="../../fonts.css" />
</head>
<body>
<div id="head"><table><tr><td><a class="logo" href="../../"><img src="../../logo.png" alt="" width="32" height="32" /></a></td><td><strong>SnapEnhance</strong><span class="desc"> - An Xposed module offering an enhanced Snapchat experience
</span>
</td></tr></table>
<p><a href="../about.html">About</a> | <a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/LICENSE.html">License</a></p>
</div>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/9cb9bd7a26c3ebeab1a26e6b2d52cdb7edc4c46b.html">9cb9bd7a26c3ebeab1a26e6b2d52cdb7edc4c46b</a>
<b>parent</b> <a href="../commit/5a47e04093d05b2f811a10475421a067220b46d8.html">5a47e04093d05b2f811a10475421a067220b46d8</a>
<b>Author:</b> rhunk &lt;<a href="mailto:101876869+rhunk@users.noreply.github.com">101876869+rhunk@users.noreply.github.com</a>&gt;
<b>Date:</b>   Sat, 16 Sep 2023 11:56:41 +0200

feat: multiple media chat export
- optimize message exporter download
- optimize zip download/extract

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadProcessor.kt</a></td><td> | </td><td class="num">57</td><td><span class="i">++++++++++++++++++++++</span><span class="d">-----------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">core/src/main/assets/web/export_template.html</a></td><td> | </td><td class="num">117</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">--------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h2">core/src/main/kotlin/me/rhunk/snapenhance/core/download/data/MediaEncryptionKeyPair.kt</a></td><td> | </td><td class="num">25</td><td><span class="i">+++++++++++++++++</span><span class="d">--------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h3">core/src/main/kotlin/me/rhunk/snapenhance/core/util/download/RemoteMediaResolver.kt</a></td><td> | </td><td class="num">31</td><td><span class="i">+++++++++++++++++++++++</span><span class="d">--------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h4">core/src/main/kotlin/me/rhunk/snapenhance/core/util/export/MessageExporter.kt</a></td><td> | </td><td class="num">101</td><td><span class="i">+++++++++++++++++++++++++++++++++</span><span class="d">----------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h5">core/src/main/kotlin/me/rhunk/snapenhance/core/util/snap/EncryptionHelper.kt</a></td><td> | </td><td class="num">73</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h6">core/src/main/kotlin/me/rhunk/snapenhance/core/util/snap/MediaDownloaderHelper.kt</a></td><td> | </td><td class="num">81</td><td><span class="i">+++++++++++++++++++++++++++</span><span class="d">----------------------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h7">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/MediaDownloader.kt</a></td><td> | </td><td class="num">52</td><td><span class="i">+++++++++++++++++++</span><span class="d">---------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h8">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/decoder/MessageDecoder.kt</a></td><td> | </td><td class="num">44</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h9">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/Notifications.kt</a></td><td> | </td><td class="num">35</td><td><span class="i">++++++++++++++++++</span><span class="d">-----------------</span></td></tr>
</table></pre><pre>10 files changed, 291 insertions(+), 325 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadProcessor.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadProcessor.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadProcessor.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/download/DownloadProcessor.kt</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -23,17 +23,14 @@ import me.rhunk.snapenhance.core.download.data.DownloadMetadata
</a> import me.rhunk.snapenhance.core.download.data.DownloadRequest
 import me.rhunk.snapenhance.core.download.data.DownloadStage
 import me.rhunk.snapenhance.core.download.data.InputMedia
<a href="#h0-0-3" id="h0-0-3" class="d">-import me.rhunk.snapenhance.core.download.data.MediaEncryptionKeyPair
</a><a href="#h0-0-4" id="h0-0-4" class="i">+import me.rhunk.snapenhance.core.download.data.SplitMediaAssetType
</a> import me.rhunk.snapenhance.core.util.download.RemoteMediaResolver
<a href="#h0-0-6" id="h0-0-6" class="i">+import me.rhunk.snapenhance.core.util.snap.MediaDownloaderHelper
</a> import java.io.File
 import java.io.InputStream
 import java.net.HttpURLConnection
 import java.net.URL
 import java.util.zip.ZipInputStream
<a href="#h0-0-12" id="h0-0-12" class="d">-import javax.crypto.Cipher
</a><a href="#h0-0-13" id="h0-0-13" class="d">-import javax.crypto.CipherInputStream
</a><a href="#h0-0-14" id="h0-0-14" class="d">-import javax.crypto.spec.IvParameterSpec
</a><a href="#h0-0-15" id="h0-0-15" class="d">-import javax.crypto.spec.SecretKeySpec
</a> import javax.xml.parsers.DocumentBuilderFactory
 import javax.xml.transform.TransformerFactory
 import javax.xml.transform.dom.DOMSource
<a href="#h0-1" id="h0-1" class="h">@@ -110,14 +107,6 @@ class DownloadProcessor (
</a>         return files
     }
 
<a href="#h0-1-3" id="h0-1-3" class="d">-    private fun decryptInputStream(inputStream: InputStream, encryption: MediaEncryptionKeyPair): InputStream {
</a><a href="#h0-1-4" id="h0-1-4" class="d">-        val cipher = Cipher.getInstance(&quot;AES/CBC/PKCS5Padding&quot;)
</a><a href="#h0-1-5" id="h0-1-5" class="d">-        val key = Base64.UrlSafe.decode(encryption.key)
</a><a href="#h0-1-6" id="h0-1-6" class="d">-        val iv = Base64.UrlSafe.decode(encryption.iv)
</a><a href="#h0-1-7" id="h0-1-7" class="d">-        cipher.init(Cipher.DECRYPT_MODE, SecretKeySpec(key, &quot;AES&quot;), IvParameterSpec(iv))
</a><a href="#h0-1-8" id="h0-1-8" class="d">-        return CipherInputStream(inputStream, cipher)
</a><a href="#h0-1-9" id="h0-1-9" class="d">-    }
</a><a href="#h0-1-10" id="h0-1-10" class="d">-
</a>     @SuppressLint(&quot;UnspecifiedRegisterReceiverFlag&quot;)
     private suspend fun saveMediaToGallery(inputFile: File, downloadObject: DownloadObject) {
         if (coroutineContext.job.isCancelled) return
<a href="#h0-2" id="h0-2" class="h">@@ -202,24 +191,16 @@ class DownloadProcessor (
</a>         downloadRequest.inputMedias.forEach { inputMedia -&gt;
             fun handleInputStream(inputStream: InputStream) {
                 createMediaTempFile().apply {
<a href="#h0-2-3" id="h0-2-3" class="d">-                    if (inputMedia.encryption != null) {
</a><a href="#h0-2-4" id="h0-2-4" class="d">-                        decryptInputStream(inputStream,
</a><a href="#h0-2-5" id="h0-2-5" class="d">-                            inputMedia.encryption!!
</a><a href="#h0-2-6" id="h0-2-6" class="d">-                        ).use { decryptedInputStream -&gt;
</a><a href="#h0-2-7" id="h0-2-7" class="d">-                            decryptedInputStream.copyTo(outputStream())
</a><a href="#h0-2-8" id="h0-2-8" class="d">-                        }
</a><a href="#h0-2-9" id="h0-2-9" class="d">-                    } else {
</a><a href="#h0-2-10" id="h0-2-10" class="d">-                        inputStream.copyTo(outputStream())
</a><a href="#h0-2-11" id="h0-2-11" class="d">-                    }
</a><a href="#h0-2-12" id="h0-2-12" class="i">+                    (inputMedia.encryption?.decryptInputStream(inputStream) ?: inputStream).copyTo(outputStream())
</a>                 }.also { downloadedMedias[inputMedia] = it }
             }
 
             launch {
                 when (inputMedia.type) {
                     DownloadMediaType.PROTO_MEDIA -&gt; {
<a href="#h0-2-19" id="h0-2-19" class="d">-                        RemoteMediaResolver.downloadBoltMedia(Base64.UrlSafe.decode(inputMedia.content))?.let { inputStream -&gt;
</a><a href="#h0-2-20" id="h0-2-20" class="d">-                            handleInputStream(inputStream)
</a><a href="#h0-2-21" id="h0-2-21" class="d">-                        }
</a><a href="#h0-2-22" id="h0-2-22" class="i">+                        RemoteMediaResolver.downloadBoltMedia(Base64.UrlSafe.decode(inputMedia.content), decryptionCallback = { it }, resultCallback = {
</a><a href="#h0-2-23" id="h0-2-23" class="i">+                            handleInputStream(it)
</a><a href="#h0-2-24" id="h0-2-24" class="i">+                        })
</a>                     }
                     DownloadMediaType.DIRECT_MEDIA -&gt; {
                         val decoded = Base64.UrlSafe.decode(inputMedia.content)
<a href="#h0-3" id="h0-3" class="h">@@ -359,20 +340,26 @@ class DownloadProcessor (
</a>                 var shouldMergeOverlay = downloadRequest.shouldMergeOverlay
 
                 //if there is a zip file, extract it and replace the downloaded media with the extracted ones
<a href="#h0-3-3" id="h0-3-3" class="d">-                downloadedMedias.values.find { it.fileType == FileType.ZIP }?.let { entry -&gt;
</a><a href="#h0-3-4" id="h0-3-4" class="d">-                    val extractedMedias = extractZip(entry.file.inputStream()).map {
</a><a href="#h0-3-5" id="h0-3-5" class="d">-                        InputMedia(
</a><a href="#h0-3-6" id="h0-3-6" class="d">-                            type = DownloadMediaType.LOCAL_MEDIA,
</a><a href="#h0-3-7" id="h0-3-7" class="d">-                            content = it.absolutePath
</a><a href="#h0-3-8" id="h0-3-8" class="d">-                        ) to DownloadedFile(it, FileType.fromFile(it))
</a><a href="#h0-3-9" id="h0-3-9" class="i">+                downloadedMedias.values.find { it.fileType == FileType.ZIP }?.let { zipFile -&gt;
</a><a href="#h0-3-10" id="h0-3-10" class="i">+                    val oldDownloadedMedias = downloadedMedias.toMap()
</a><a href="#h0-3-11" id="h0-3-11" class="i">+                    downloadedMedias.clear()
</a><a href="#h0-3-12" id="h0-3-12" class="i">+
</a><a href="#h0-3-13" id="h0-3-13" class="i">+                    MediaDownloaderHelper.getSplitElements(zipFile.file.inputStream()) { type, inputStream -&gt;
</a><a href="#h0-3-14" id="h0-3-14" class="i">+                        createMediaTempFile().apply {
</a><a href="#h0-3-15" id="h0-3-15" class="i">+                            inputStream.copyTo(outputStream())
</a><a href="#h0-3-16" id="h0-3-16" class="i">+                        }.also {
</a><a href="#h0-3-17" id="h0-3-17" class="i">+                            downloadedMedias[InputMedia(
</a><a href="#h0-3-18" id="h0-3-18" class="i">+                                type = DownloadMediaType.LOCAL_MEDIA,
</a><a href="#h0-3-19" id="h0-3-19" class="i">+                                content = it.absolutePath,
</a><a href="#h0-3-20" id="h0-3-20" class="i">+                                isOverlay = type == SplitMediaAssetType.OVERLAY
</a><a href="#h0-3-21" id="h0-3-21" class="i">+                            )] = DownloadedFile(it, FileType.fromFile(it))
</a><a href="#h0-3-22" id="h0-3-22" class="i">+                        }
</a>                     }
 
<a href="#h0-3-25" id="h0-3-25" class="d">-                    downloadedMedias.values.removeIf {
</a><a href="#h0-3-26" id="h0-3-26" class="d">-                        it.file.delete()
</a><a href="#h0-3-27" id="h0-3-27" class="d">-                        true
</a><a href="#h0-3-28" id="h0-3-28" class="i">+                    oldDownloadedMedias.forEach { (_, value) -&gt;
</a><a href="#h0-3-29" id="h0-3-29" class="i">+                        value.file.delete()
</a>                     }
 
<a href="#h0-3-32" id="h0-3-32" class="d">-                    downloadedMedias.putAll(extractedMedias)
</a>                     shouldMergeOverlay = true
                 }
 
<b>diff --git a/<a id="h1" href="../file/core/src/main/assets/web/export_template.html.html">core/src/main/assets/web/export_template.html</a> b/<a href="../file/core/src/main/assets/web/export_template.html.html">core/src/main/assets/web/export_template.html</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -122,11 +122,16 @@
</a> 
     }
 
<a href="#h1-0-3" id="h1-0-3" class="d">-    .media_container {
</a><a href="#h1-0-4" id="h1-0-4" class="i">+    .chat_media {
</a>         max-width: 300px;
         max-height: 500px;
     }
 
<a href="#h1-0-9" id="h1-0-9" class="i">+    .overlay_media {
</a><a href="#h1-0-10" id="h1-0-10" class="i">+        position: absolute;
</a><a href="#h1-0-11" id="h1-0-11" class="i">+        pointer-events: none;
</a><a href="#h1-0-12" id="h1-0-12" class="i">+    }
</a><a href="#h1-0-13" id="h1-0-13" class="i">+
</a>     .red_snap_svg {
         color: var(--sigSnapWithoutSound);
     }
<a href="#h1-1" id="h1-1" class="h">@@ -140,7 +145,7 @@
</a>     &lt;div style=&quot;display: none;&quot;&gt;
         &lt;svg class=&quot;red_snap_svg&quot; width=&quot;16&quot; height=&quot;16&quot; viewBox=&quot;0 0 16 16&quot; fill=&quot;none&quot; xmlns=&quot;http://www.w3.org/2000/svg&quot;&gt;
             &lt;rect x=&quot;2.75&quot; y=&quot;2.75&quot; width=&quot;10.5&quot; height=&quot;10.5&quot; rx=&quot;1.808&quot; stroke=&quot;currentColor&quot; stroke-width=&quot;1.5&quot;&gt;&lt;/rect&gt;
<a href="#h1-1-3" id="h1-1-3" class="d">-         &lt;/svg&gt;
</a><a href="#h1-1-4" id="h1-1-4" class="i">+        &lt;/svg&gt;
</a>     &lt;/div&gt;
 
     &lt;script&gt;
<a href="#h1-2" id="h1-2" class="h">@@ -152,13 +157,24 @@
</a>         }
 
         function makeConversationSummary() {
<a href="#h1-2-3" id="h1-2-3" class="d">-            const conversationTitle = conversationData.conversationName != null ? 
</a><a href="#h1-2-4" id="h1-2-4" class="d">-            conversationData.conversationName : 
</a><a href="#h1-2-5" id="h1-2-5" class="d">-            &quot;DM with &quot; + Object.values(participants).map(user =&gt; user.username).join(&quot;, &quot;)
</a><a href="#h1-2-6" id="h1-2-6" class="i">+            const conversationTitle = conversationData.conversationName != null ?
</a><a href="#h1-2-7" id="h1-2-7" class="i">+            conversationData.conversationName : &quot;DM with &quot; + Object.values(participants).map(user =&gt; user.username).join(&quot;, &quot;)
</a> 
             document.querySelector(&quot;.conversation_summary .title&quot;).textContent = conversationTitle
         }
 
<a href="#h1-2-12" id="h1-2-12" class="i">+        function decodeMedia(element) {
</a><a href="#h1-2-13" id="h1-2-13" class="i">+            const decodedData = new Uint8Array(
</a><a href="#h1-2-14" id="h1-2-14" class="i">+                inflate(
</a><a href="#h1-2-15" id="h1-2-15" class="i">+                    base64decode(
</a><a href="#h1-2-16" id="h1-2-16" class="i">+                        element.innerHTML.substring(5, element.innerHTML.length - 4)
</a><a href="#h1-2-17" id="h1-2-17" class="i">+                    )
</a><a href="#h1-2-18" id="h1-2-18" class="i">+                )
</a><a href="#h1-2-19" id="h1-2-19" class="i">+            )
</a><a href="#h1-2-20" id="h1-2-20" class="i">+
</a><a href="#h1-2-21" id="h1-2-21" class="i">+            return URL.createObjectURL(new Blob([decodedData]))
</a><a href="#h1-2-22" id="h1-2-22" class="i">+        }
</a><a href="#h1-2-23" id="h1-2-23" class="i">+
</a>         function makeConversationMessageContainer() {
             const messageTemplate = document.querySelector(&quot;#message_template&quot;)
             Object.values(conversationData.messages).forEach(message =&gt; {
<a href="#h1-3" id="h1-3" class="h">@@ -185,63 +201,88 @@
</a>                     return headerElement
                 })(document.createElement(&quot;div&quot;)))
 
<a href="#h1-3-3" id="h1-3-3" class="d">-                messageObject.appendChild(((elem) =&gt;{
</a><a href="#h1-3-4" id="h1-3-4" class="d">-                    elem.classList.add(&quot;content&quot;)
</a><a href="#h1-3-5" id="h1-3-5" class="i">+                messageObject.appendChild(((messageContainer) =&gt;{
</a><a href="#h1-3-6" id="h1-3-6" class="i">+                    messageContainer.classList.add(&quot;content&quot;)
</a> 
<a href="#h1-3-8" id="h1-3-8" class="d">-                    elem.innerHTML = message.serializedContent
</a><a href="#h1-3-9" id="h1-3-9" class="i">+                    messageContainer.innerHTML = message.serializedContent
</a> 
                     if (!message.serializedContent) {
<a href="#h1-3-12" id="h1-3-12" class="d">-                        elem.innerHTML = &quot;&quot;
</a><a href="#h1-3-13" id="h1-3-13" class="i">+                        messageContainer.innerHTML = &quot;&quot;
</a>                         let messageData = &quot;&quot;
                         switch(message.type) {
                             case &quot;SNAP&quot;:
<a href="#h1-3-17" id="h1-3-17" class="d">-                                elem.appendChild(document.querySelector(&#39;.red_snap_svg&#39;).cloneNode(true))
</a><a href="#h1-3-18" id="h1-3-18" class="i">+                                messageContainer.appendChild(document.querySelector(&#39;.red_snap_svg&#39;).cloneNode(true))
</a>                                 messageData = &quot;Snap&quot;
                                 break
                             default:
                                 messageData = message.type
<a href="#h1-3-23" id="h1-3-23" class="d">-
</a>                         }
<a href="#h1-3-25" id="h1-3-25" class="d">-                        elem.innerHTML += messageData
</a><a href="#h1-3-26" id="h1-3-26" class="i">+                        messageContainer.innerHTML += messageData
</a>                     }
 
<a href="#h1-3-29" id="h1-3-29" class="d">-                    if (message.mediaReferences &amp;&amp; message.mediaReferences.length &gt; 0) {
</a><a href="#h1-3-30" id="h1-3-30" class="d">-                        //only get the first reference
</a><a href="#h1-3-31" id="h1-3-31" class="d">-                        const reference = Object.values(message.mediaReferences)[0]
</a><a href="#h1-3-32" id="h1-3-32" class="d">-                        let fetched = false
</a><a href="#h1-3-33" id="h1-3-33" class="d">-                        var observer = new IntersectionObserver(function(entries) {
</a><a href="#h1-3-34" id="h1-3-34" class="d">-                            if(!fetched &amp;&amp; entries[0].isIntersecting === true) {
</a><a href="#h1-3-35" id="h1-3-35" class="d">-                                fetched = true
</a><a href="#h1-3-36" id="h1-3-36" class="i">+                    if (message.attachments &amp;&amp; message.attachments.length &gt; 0) {
</a><a href="#h1-3-37" id="h1-3-37" class="i">+                        let observers = []
</a><a href="#h1-3-38" id="h1-3-38" class="i">+
</a><a href="#h1-3-39" id="h1-3-39" class="i">+                        message.attachments.forEach((attachment, index) =&gt; {
</a><a href="#h1-3-40" id="h1-3-40" class="i">+                            const mediaKey = attachment.key.replace(/(=)/g, &quot;&quot;)
</a><a href="#h1-3-41" id="h1-3-41" class="i">+
</a><a href="#h1-3-42" id="h1-3-42" class="i">+                            observers.push(() =&gt; {
</a><a href="#h1-3-43" id="h1-3-43" class="i">+                                const originalMedia = document.querySelector(&#39;.media-ORIGINAL_&#39; + mediaKey)
</a><a href="#h1-3-44" id="h1-3-44" class="i">+                                if (!originalMedia) {
</a><a href="#h1-3-45" id="h1-3-45" class="i">+                                    return
</a><a href="#h1-3-46" id="h1-3-46" class="i">+                                }
</a><a href="#h1-3-47" id="h1-3-47" class="i">+
</a><a href="#h1-3-48" id="h1-3-48" class="i">+                                const originalMediaUrl = decodeMedia(originalMedia)
</a> 
<a href="#h1-3-50" id="h1-3-50" class="d">-                                const mediaDiv = document.querySelector(&#39;.media-ORIGINAL_&#39; + reference.content.replace(/(=)/g, &quot;&quot;))
</a><a href="#h1-3-51" id="h1-3-51" class="d">-                                if (!mediaDiv) return
</a><a href="#h1-3-52" id="h1-3-52" class="d">-                                
</a><a href="#h1-3-53" id="h1-3-53" class="d">-                                const content = mediaDiv.innerHTML.substring(5, mediaDiv.innerHTML.length - 4)
</a><a href="#h1-3-54" id="h1-3-54" class="d">-                                const decodedData = new Uint8Array(inflate(base64decode(content)))
</a><a href="#h1-3-55" id="h1-3-55" class="i">+                                const mediaContainer = document.createElement(&quot;div&quot;)
</a><a href="#h1-3-56" id="h1-3-56" class="i">+                                messageContainer.appendChild(mediaContainer)
</a> 
<a href="#h1-3-58" id="h1-3-58" class="d">-                                const blob = new Blob([decodedData])
</a><a href="#h1-3-59" id="h1-3-59" class="d">-                                const url = URL.createObjectURL(blob)
</a><a href="#h1-3-60" id="h1-3-60" class="d">-                                
</a>                                 const imageTag = document.createElement(&quot;img&quot;)
<a href="#h1-3-62" id="h1-3-62" class="d">-                                imageTag.classList.add(&quot;media_container&quot;)
</a><a href="#h1-3-63" id="h1-3-63" class="d">-                                imageTag.src = url
</a><a href="#h1-3-64" id="h1-3-64" class="i">+                                imageTag.src = originalMediaUrl
</a><a href="#h1-3-65" id="h1-3-65" class="i">+                                imageTag.classList.add(&quot;chat_media&quot;)
</a><a href="#h1-3-66" id="h1-3-66" class="i">+                                mediaContainer.appendChild(imageTag)
</a><a href="#h1-3-67" id="h1-3-67" class="i">+
</a>                                 imageTag.onerror = () =&gt; {
<a href="#h1-3-69" id="h1-3-69" class="d">-                                    elem.removeChild(imageTag)
</a><a href="#h1-3-70" id="h1-3-70" class="i">+                                    mediaContainer.removeChild(imageTag)
</a>                                     const mediaTag = document.createElement(message.type === &quot;NOTE&quot; ? &quot;audio&quot; : &quot;video&quot;)
<a href="#h1-3-72" id="h1-3-72" class="d">-                                    mediaTag.classList.add(&quot;media_container&quot;)
</a><a href="#h1-3-73" id="h1-3-73" class="d">-                                    mediaTag.src = url
</a><a href="#h1-3-74" id="h1-3-74" class="i">+                                    mediaTag.classList.add(&quot;chat_media&quot;)
</a><a href="#h1-3-75" id="h1-3-75" class="i">+                                    mediaTag.src = originalMediaUrl
</a>                                     mediaTag.preload = &quot;metadata&quot;
                                     mediaTag.controls = true
<a href="#h1-3-78" id="h1-3-78" class="d">-                                    elem.appendChild(mediaTag)
</a><a href="#h1-3-79" id="h1-3-79" class="i">+                                    mediaContainer.appendChild(mediaTag)
</a>                                 }
<a href="#h1-3-81" id="h1-3-81" class="d">-                                elem.innerHTML = &quot;&quot;
</a><a href="#h1-3-82" id="h1-3-82" class="d">-                                elem.appendChild(imageTag)
</a><a href="#h1-3-83" id="h1-3-83" class="i">+
</a><a href="#h1-3-84" id="h1-3-84" class="i">+                                const overlay = document.querySelector(&#39;.media-OVERLAY_&#39; + mediaKey)
</a><a href="#h1-3-85" id="h1-3-85" class="i">+                                if (!overlay) {
</a><a href="#h1-3-86" id="h1-3-86" class="i">+                                    return
</a><a href="#h1-3-87" id="h1-3-87" class="i">+                                }
</a><a href="#h1-3-88" id="h1-3-88" class="i">+
</a><a href="#h1-3-89" id="h1-3-89" class="i">+                                const overlayImage = document.createElement(&quot;img&quot;)
</a><a href="#h1-3-90" id="h1-3-90" class="i">+                                overlayImage.src = decodeMedia(overlay)
</a><a href="#h1-3-91" id="h1-3-91" class="i">+                                overlayImage.classList.add(&quot;chat_media&quot;)
</a><a href="#h1-3-92" id="h1-3-92" class="i">+                                overlayImage.classList.add(&quot;overlay_media&quot;)
</a><a href="#h1-3-93" id="h1-3-93" class="i">+                                mediaContainer.appendChild(overlayImage)
</a><a href="#h1-3-94" id="h1-3-94" class="i">+                            })
</a><a href="#h1-3-95" id="h1-3-95" class="i">+                        })
</a><a href="#h1-3-96" id="h1-3-96" class="i">+
</a><a href="#h1-3-97" id="h1-3-97" class="i">+                        let fetched = false
</a><a href="#h1-3-98" id="h1-3-98" class="i">+
</a><a href="#h1-3-99" id="h1-3-99" class="i">+                        new IntersectionObserver(entries =&gt; {
</a><a href="#h1-3-100" id="h1-3-100" class="i">+                            if(!fetched &amp;&amp; entries[0].isIntersecting === true) {
</a><a href="#h1-3-101" id="h1-3-101" class="i">+                                fetched = true
</a><a href="#h1-3-102" id="h1-3-102" class="i">+                                messageContainer.innerHTML = &quot;&quot;
</a><a href="#h1-3-103" id="h1-3-103" class="i">+                                observers.forEach(c =&gt; {
</a><a href="#h1-3-104" id="h1-3-104" class="i">+                                    try {
</a><a href="#h1-3-105" id="h1-3-105" class="i">+                                        c()
</a><a href="#h1-3-106" id="h1-3-106" class="i">+                                    } catch (e) {
</a><a href="#h1-3-107" id="h1-3-107" class="i">+                                        console.log(e)
</a><a href="#h1-3-108" id="h1-3-108" class="i">+                                    }
</a><a href="#h1-3-109" id="h1-3-109" class="i">+                                })
</a>                             }
<a href="#h1-3-111" id="h1-3-111" class="d">-                        }, { threshold: [1] });
</a><a href="#h1-3-112" id="h1-3-112" class="d">-                        observer.observe(elem)
</a><a href="#h1-3-113" id="h1-3-113" class="i">+                        }).observe(messageContainer)
</a>                     }
 
<a href="#h1-3-116" id="h1-3-116" class="d">-                    return elem
</a><a href="#h1-3-117" id="h1-3-117" class="i">+                    return messageContainer
</a>                 })(document.createElement(&quot;div&quot;)))
 
                 document.querySelector(&#39;.conversation_message_container&#39;).appendChild(messageObject)
<b>diff --git a/<a id="h2" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/download/data/MediaEncryptionKeyPair.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/download/data/MediaEncryptionKeyPair.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/download/data/MediaEncryptionKeyPair.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/download/data/MediaEncryptionKeyPair.kt</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -3,6 +3,11 @@
</a> package me.rhunk.snapenhance.core.download.data
 
 import me.rhunk.snapenhance.data.wrapper.impl.media.EncryptionWrapper
<a href="#h2-0-3" id="h2-0-3" class="i">+import java.io.InputStream
</a><a href="#h2-0-4" id="h2-0-4" class="i">+import javax.crypto.Cipher
</a><a href="#h2-0-5" id="h2-0-5" class="i">+import javax.crypto.CipherInputStream
</a><a href="#h2-0-6" id="h2-0-6" class="i">+import javax.crypto.spec.IvParameterSpec
</a><a href="#h2-0-7" id="h2-0-7" class="i">+import javax.crypto.spec.SecretKeySpec
</a> import kotlin.io.encoding.Base64
 import kotlin.io.encoding.ExperimentalEncodingApi
 
<a href="#h2-1" id="h2-1" class="h">@@ -10,12 +15,16 @@ import kotlin.io.encoding.ExperimentalEncodingApi
</a> data class MediaEncryptionKeyPair(
     val key: String,
     val iv: String
<a href="#h2-1-3" id="h2-1-3" class="d">-)
</a><a href="#h2-1-4" id="h2-1-4" class="d">-
</a><a href="#h2-1-5" id="h2-1-5" class="d">-fun Pair&lt;ByteArray, ByteArray&gt;.toKeyPair(): MediaEncryptionKeyPair {
</a><a href="#h2-1-6" id="h2-1-6" class="d">-    return MediaEncryptionKeyPair(Base64.UrlSafe.encode(this.first), Base64.UrlSafe.encode(this.second))
</a><a href="#h2-1-7" id="h2-1-7" class="i">+) {
</a><a href="#h2-1-8" id="h2-1-8" class="i">+    fun decryptInputStream(inputStream: InputStream): InputStream {
</a><a href="#h2-1-9" id="h2-1-9" class="i">+        val cipher = Cipher.getInstance(&quot;AES/CBC/PKCS5Padding&quot;)
</a><a href="#h2-1-10" id="h2-1-10" class="i">+        cipher.init(Cipher.DECRYPT_MODE, SecretKeySpec(Base64.UrlSafe.decode(key), &quot;AES&quot;), IvParameterSpec(Base64.UrlSafe.decode(iv)))
</a><a href="#h2-1-11" id="h2-1-11" class="i">+        return CipherInputStream(inputStream, cipher)
</a><a href="#h2-1-12" id="h2-1-12" class="i">+    }
</a> }
 
<a href="#h2-1-15" id="h2-1-15" class="d">-fun EncryptionWrapper.toKeyPair(): MediaEncryptionKeyPair {
</a><a href="#h2-1-16" id="h2-1-16" class="d">-    return MediaEncryptionKeyPair(Base64.UrlSafe.encode(this.keySpec), Base64.UrlSafe.encode(this.ivKeyParameterSpec))
</a><a href="#h2-1-17" id="h2-1-17" class="d">-}</a><a href="#h2-1-18" id="h2-1-18" class="d">-
\ No newline at end of file
</a><a href="#h2-1-19" id="h2-1-19" class="i">+fun Pair&lt;ByteArray, ByteArray&gt;.toKeyPair()
</a><a href="#h2-1-20" id="h2-1-20" class="i">+    = MediaEncryptionKeyPair(Base64.UrlSafe.encode(this.first), Base64.UrlSafe.encode(this.second))
</a><a href="#h2-1-21" id="h2-1-21" class="i">+
</a><a href="#h2-1-22" id="h2-1-22" class="i">+fun EncryptionWrapper.toKeyPair()
</a><a href="#h2-1-23" id="h2-1-23" class="i">+    = MediaEncryptionKeyPair(Base64.UrlSafe.encode(this.keySpec), Base64.UrlSafe.encode(this.ivKeyParameterSpec))</a><a href="#h2-1-24" id="h2-1-24" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h3" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/util/download/RemoteMediaResolver.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/util/download/RemoteMediaResolver.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/util/download/RemoteMediaResolver.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/util/download/RemoteMediaResolver.kt</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -4,7 +4,6 @@ import me.rhunk.snapenhance.Constants
</a> import me.rhunk.snapenhance.core.Logger
 import okhttp3.OkHttpClient
 import okhttp3.Request
<a href="#h3-0-3" id="h3-0-3" class="d">-import java.io.ByteArrayInputStream
</a> import java.io.InputStream
 import java.util.Base64
 
<a href="#h3-1" id="h3-1" class="h">@@ -36,18 +35,34 @@ object RemoteMediaResolver {
</a>         }
         .build()
 
<a href="#h3-1-3" id="h3-1-3" class="d">-    fun downloadBoltMedia(protoKey: ByteArray): InputStream? {
</a><a href="#h3-1-4" id="h3-1-4" class="d">-        val request = Request.Builder()
</a><a href="#h3-1-5" id="h3-1-5" class="d">-            .url(BOLT_HTTP_RESOLVER_URL + &quot;/resolve?co=&quot; + Base64.getUrlEncoder().encodeToString(protoKey))
</a><a href="#h3-1-6" id="h3-1-6" class="d">-            .addHeader(&quot;User-Agent&quot;, Constants.USER_AGENT)
</a><a href="#h3-1-7" id="h3-1-7" class="d">-            .build()
</a><a href="#h3-1-8" id="h3-1-8" class="i">+    private fun newResolveRequest(protoKey: ByteArray) = Request.Builder()
</a><a href="#h3-1-9" id="h3-1-9" class="i">+        .url(BOLT_HTTP_RESOLVER_URL + &quot;/resolve?co=&quot; + Base64.getUrlEncoder().encodeToString(protoKey))
</a><a href="#h3-1-10" id="h3-1-10" class="i">+        .addHeader(&quot;User-Agent&quot;, Constants.USER_AGENT)
</a><a href="#h3-1-11" id="h3-1-11" class="i">+        .build()
</a> 
<a href="#h3-1-13" id="h3-1-13" class="d">-        okHttpClient.newCall(request).execute().use { response -&gt;
</a><a href="#h3-1-14" id="h3-1-14" class="i">+    /**
</a><a href="#h3-1-15" id="h3-1-15" class="i">+     * Download bolt media with memory allocation
</a><a href="#h3-1-16" id="h3-1-16" class="i">+     */
</a><a href="#h3-1-17" id="h3-1-17" class="i">+    fun downloadBoltMedia(protoKey: ByteArray, decryptionCallback: (InputStream) -&gt; InputStream = { it }): ByteArray? {
</a><a href="#h3-1-18" id="h3-1-18" class="i">+        okHttpClient.newCall(newResolveRequest(protoKey)).execute().use { response -&gt;
</a>             if (!response.isSuccessful) {
                 Logger.directDebug(&quot;Unexpected code $response&quot;)
                 return null
             }
<a href="#h3-1-23" id="h3-1-23" class="d">-            return ByteArrayInputStream(response.body.bytes())
</a><a href="#h3-1-24" id="h3-1-24" class="i">+            return decryptionCallback(response.body.byteStream()).readBytes()
</a><a href="#h3-1-25" id="h3-1-25" class="i">+        }
</a><a href="#h3-1-26" id="h3-1-26" class="i">+    }
</a><a href="#h3-1-27" id="h3-1-27" class="i">+    
</a><a href="#h3-1-28" id="h3-1-28" class="i">+    fun downloadBoltMedia(protoKey: ByteArray, decryptionCallback: (InputStream) -&gt; InputStream = { it }, resultCallback: (InputStream) -&gt; Unit) {
</a><a href="#h3-1-29" id="h3-1-29" class="i">+        okHttpClient.newCall(newResolveRequest(protoKey)).execute().use { response -&gt;
</a><a href="#h3-1-30" id="h3-1-30" class="i">+            if (!response.isSuccessful) {
</a><a href="#h3-1-31" id="h3-1-31" class="i">+                throw Throwable(&quot;invalid response ${response.code}&quot;)
</a><a href="#h3-1-32" id="h3-1-32" class="i">+            }
</a><a href="#h3-1-33" id="h3-1-33" class="i">+            resultCallback(
</a><a href="#h3-1-34" id="h3-1-34" class="i">+                decryptionCallback(
</a><a href="#h3-1-35" id="h3-1-35" class="i">+                    response.body.byteStream()
</a><a href="#h3-1-36" id="h3-1-36" class="i">+                )
</a><a href="#h3-1-37" id="h3-1-37" class="i">+            )
</a>         }
     }
 }
<b>diff --git a/<a id="h4" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/util/export/MessageExporter.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/util/export/MessageExporter.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/util/export/MessageExporter.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/util/export/MessageExporter.kt</a></b>
<a href="#h4-0" id="h4-0" class="h">@@ -3,6 +3,7 @@ package me.rhunk.snapenhance.core.util.export
</a> import android.os.Environment
 import android.util.Base64InputStream
 import com.google.gson.JsonArray
<a href="#h4-0-3" id="h4-0-3" class="i">+import com.google.gson.JsonNull
</a> import com.google.gson.JsonObject
 import de.robv.android.xposed.XposedHelpers
 import kotlinx.coroutines.Dispatchers
<a href="#h4-1" id="h4-1" class="h">@@ -11,20 +12,21 @@ import me.rhunk.snapenhance.ModContext
</a> import me.rhunk.snapenhance.core.BuildConfig
 import me.rhunk.snapenhance.core.database.objects.FriendFeedEntry
 import me.rhunk.snapenhance.core.database.objects.FriendInfo
<a href="#h4-1-3" id="h4-1-3" class="i">+import me.rhunk.snapenhance.core.util.download.RemoteMediaResolver
</a> import me.rhunk.snapenhance.core.util.protobuf.ProtoReader
<a href="#h4-1-5" id="h4-1-5" class="d">-import me.rhunk.snapenhance.core.util.snap.EncryptionHelper
</a> import me.rhunk.snapenhance.core.util.snap.MediaDownloaderHelper
 import me.rhunk.snapenhance.data.ContentType
 import me.rhunk.snapenhance.data.FileType
<a href="#h4-1-9" id="h4-1-9" class="d">-import me.rhunk.snapenhance.data.MediaReferenceType
</a> import me.rhunk.snapenhance.data.wrapper.impl.Message
 import me.rhunk.snapenhance.data.wrapper.impl.SnapUUID
<a href="#h4-1-12" id="h4-1-12" class="i">+import me.rhunk.snapenhance.features.impl.downloader.decoder.AttachmentType
</a><a href="#h4-1-13" id="h4-1-13" class="i">+import me.rhunk.snapenhance.features.impl.downloader.decoder.MessageDecoder
</a><a href="#h4-1-14" id="h4-1-14" class="i">+import java.io.BufferedInputStream
</a> import java.io.File
 import java.io.FileOutputStream
 import java.io.InputStream
 import java.io.OutputStream
 import java.text.SimpleDateFormat
<a href="#h4-1-20" id="h4-1-20" class="d">-import java.util.Base64
</a> import java.util.Collections
 import java.util.Date
 import java.util.Locale
<a href="#h4-2" id="h4-2" class="h">@@ -33,6 +35,7 @@ import java.util.concurrent.TimeUnit
</a> import java.util.zip.Deflater
 import java.util.zip.DeflaterInputStream
 import java.util.zip.ZipFile
<a href="#h4-2-3" id="h4-2-3" class="i">+import kotlin.io.encoding.Base64
</a> import kotlin.io.encoding.ExperimentalEncodingApi
 
 
<a href="#h4-3" id="h4-3" class="h">@@ -44,6 +47,7 @@ enum class ExportFormat(
</a>     HTML(&quot;html&quot;);
 }
 
<a href="#h4-3-3" id="h4-3-3" class="i">+@OptIn(ExperimentalEncodingApi::class)
</a> class MessageExporter(
     private val context: ModContext,
     private val outputFile: File,
<a href="#h4-4" id="h4-4" class="h">@@ -94,7 +98,6 @@ class MessageExporter(
</a>         writer.flush()
     }
 
<a href="#h4-4-3" id="h4-4-3" class="d">-    @OptIn(ExperimentalEncodingApi::class)
</a>     suspend fun exportHtml(output: OutputStream) {
         val downloadMediaCacheFolder = File(Environment.getExternalStoragePublicDirectory(Environment.DIRECTORY_DOWNLOADS), &quot;SnapEnhance/cache&quot;).also { it.mkdirs() }
         val mediaFiles = Collections.synchronizedMap(mutableMapOf&lt;String, Pair&lt;FileType, File&gt;&gt;())
<a href="#h4-5" id="h4-5" class="h">@@ -115,34 +118,30 @@ class MessageExporter(
</a>                 mediaToDownload?.contains(it.messageContent.contentType) ?: false
             }.forEach { message -&gt;
                 threadPool.execute {
<a href="#h4-5-3" id="h4-5-3" class="d">-                    val remoteMediaReferences by lazy {
</a><a href="#h4-5-4" id="h4-5-4" class="d">-                        val serializedMessageContent = context.gson.toJsonTree(message.messageContent.instanceNonNull()).asJsonObject
</a><a href="#h4-5-5" id="h4-5-5" class="d">-                        serializedMessageContent[&quot;mRemoteMediaReferences&quot;]
</a><a href="#h4-5-6" id="h4-5-6" class="d">-                            .asJsonArray.map { it.asJsonObject[&quot;mMediaReferences&quot;].asJsonArray }
</a><a href="#h4-5-7" id="h4-5-7" class="d">-                            .flatten()
</a><a href="#h4-5-8" id="h4-5-8" class="d">-                    }
</a><a href="#h4-5-9" id="h4-5-9" class="d">-
</a><a href="#h4-5-10" id="h4-5-10" class="d">-                    remoteMediaReferences.firstOrNull().takeIf { it != null }?.let { media -&gt;
</a><a href="#h4-5-11" id="h4-5-11" class="d">-                        val protoMediaReference = media.asJsonObject[&quot;mContentObject&quot;].asJsonArray.map { it.asByte }.toByteArray()
</a><a href="#h4-5-12" id="h4-5-12" class="i">+                    MessageDecoder.decode(message.messageContent).forEach decode@{ attachment -&gt;
</a><a href="#h4-5-13" id="h4-5-13" class="i">+                        val protoMediaReference = Base64.UrlSafe.decode(attachment.mediaKey ?: return@decode)
</a> 
                         runCatching {
<a href="#h4-5-16" id="h4-5-16" class="d">-                            val downloadedMedia = MediaDownloaderHelper.downloadMediaFromReference(protoMediaReference) {
</a><a href="#h4-5-17" id="h4-5-17" class="d">-                                EncryptionHelper.decryptInputStream(it, message.messageContent.contentType!!, ProtoReader(message.messageContent.content), isArroyo = false)
</a><a href="#h4-5-18" id="h4-5-18" class="d">-                            }
</a><a href="#h4-5-19" id="h4-5-19" class="d">-
</a><a href="#h4-5-20" id="h4-5-20" class="d">-                            downloadedMedia.forEach { (type, mediaData) -&gt;
</a><a href="#h4-5-21" id="h4-5-21" class="d">-                                val fileType = FileType.fromByteArray(mediaData)
</a><a href="#h4-5-22" id="h4-5-22" class="d">-                                val fileName = &quot;${type}_${kotlin.io.encoding.Base64.UrlSafe.encode(protoMediaReference).replace(&quot;=&quot;, &quot;&quot;)}&quot;
</a><a href="#h4-5-23" id="h4-5-23" class="d">-
</a><a href="#h4-5-24" id="h4-5-24" class="d">-                                val mediaFile = File(downloadMediaCacheFolder, &quot;$fileName.${fileType.fileExtension}&quot;)
</a><a href="#h4-5-25" id="h4-5-25" class="d">-
</a><a href="#h4-5-26" id="h4-5-26" class="d">-                                FileOutputStream(mediaFile).use { fos -&gt;
</a><a href="#h4-5-27" id="h4-5-27" class="d">-                                    mediaData.inputStream().copyTo(fos)
</a><a href="#h4-5-28" id="h4-5-28" class="i">+                            RemoteMediaResolver.downloadBoltMedia(protoMediaReference, decryptionCallback = {
</a><a href="#h4-5-29" id="h4-5-29" class="i">+                                (attachment.attachmentInfo?.encryption?.decryptInputStream(it) ?: it)
</a><a href="#h4-5-30" id="h4-5-30" class="i">+                            }) {
</a><a href="#h4-5-31" id="h4-5-31" class="i">+                                it.use { inputStream -&gt;
</a><a href="#h4-5-32" id="h4-5-32" class="i">+                                    MediaDownloaderHelper.getSplitElements(inputStream) { type, splitInputStream -&gt;
</a><a href="#h4-5-33" id="h4-5-33" class="i">+                                        val fileName = &quot;${type}_${Base64.UrlSafe.encode(protoMediaReference).replace(&quot;=&quot;, &quot;&quot;)}&quot;
</a><a href="#h4-5-34" id="h4-5-34" class="i">+                                        val bufferedInputStream = BufferedInputStream(splitInputStream)
</a><a href="#h4-5-35" id="h4-5-35" class="i">+                                        val fileType = MediaDownloaderHelper.getFileType(bufferedInputStream)
</a><a href="#h4-5-36" id="h4-5-36" class="i">+                                        val mediaFile = File(downloadMediaCacheFolder, &quot;$fileName.${fileType.fileExtension}&quot;)
</a><a href="#h4-5-37" id="h4-5-37" class="i">+
</a><a href="#h4-5-38" id="h4-5-38" class="i">+                                        FileOutputStream(mediaFile).use { fos -&gt;
</a><a href="#h4-5-39" id="h4-5-39" class="i">+                                            bufferedInputStream.copyTo(fos)
</a><a href="#h4-5-40" id="h4-5-40" class="i">+                                        }
</a><a href="#h4-5-41" id="h4-5-41" class="i">+
</a><a href="#h4-5-42" id="h4-5-42" class="i">+                                        mediaFiles[fileName] = fileType to mediaFile
</a><a href="#h4-5-43" id="h4-5-43" class="i">+                                    }
</a>                                 }
<a href="#h4-5-45" id="h4-5-45" class="d">-
</a><a href="#h4-5-46" id="h4-5-46" class="d">-                                mediaFiles[fileName] = fileType to mediaFile
</a><a href="#h4-5-47" id="h4-5-47" class="d">-                                updateProgress(&quot;downloaded&quot;)
</a>                             }
<a href="#h4-5-49" id="h4-5-49" class="i">+
</a><a href="#h4-5-50" id="h4-5-50" class="i">+                            updateProgress(&quot;downloaded&quot;)
</a>                         }.onFailure {
                             printLog(&quot;failed to download media for ${message.messageDescriptor.conversationId}_${message.orderKey}&quot;)
                             context.log.error(&quot;failed to download media for ${message.messageDescriptor.conversationId}_${message.orderKey}&quot;, it)
<a href="#h4-6" id="h4-6" class="h">@@ -208,7 +207,7 @@ class MessageExporter(
</a> 
                     //export avenir next font
                     apkFile.getEntry(&quot;res/font/avenir_next_medium.ttf&quot;).let { entry -&gt;
<a href="#h4-6-3" id="h4-6-3" class="d">-                        val encodedFontData = kotlin.io.encoding.Base64.Default.encode(apkFile.getInputStream(entry).readBytes())
</a><a href="#h4-6-4" id="h4-6-4" class="i">+                        val encodedFontData = Base64.Default.encode(apkFile.getInputStream(entry).readBytes())
</a>                         output.write(&quot;&quot;&quot;
                         &lt;style&gt;
                             @font-face {
<a href="#h4-7" id="h4-7" class="h">@@ -284,41 +283,25 @@ class MessageExporter(
</a>                         addProperty(&quot;createdTimestamp&quot;, message.messageMetadata.createdAt)
                         addProperty(&quot;readTimestamp&quot;, message.messageMetadata.readAt)
                         addProperty(&quot;serializedContent&quot;, serializeMessageContent(message))
<a href="#h4-7-3" id="h4-7-3" class="d">-                        addProperty(&quot;rawContent&quot;, Base64.getUrlEncoder().encodeToString(message.messageContent.content))
</a><a href="#h4-7-4" id="h4-7-4" class="i">+                        addProperty(&quot;rawContent&quot;, Base64.UrlSafe.encode(message.messageContent.content))
</a> 
<a href="#h4-7-6" id="h4-7-6" class="d">-                        val messageContentType = message.messageContent.contentType ?: ContentType.CHAT
</a><a href="#h4-7-7" id="h4-7-7" class="d">-
</a><a href="#h4-7-8" id="h4-7-8" class="d">-                        EncryptionHelper.getEncryptionKeys(messageContentType, ProtoReader(message.messageContent.content), isArroyo = false)?.let { encryptionKeyPair -&gt;
</a><a href="#h4-7-9" id="h4-7-9" class="d">-                            add(&quot;encryption&quot;, JsonObject().apply encryption@{
</a><a href="#h4-7-10" id="h4-7-10" class="d">-                                addProperty(&quot;key&quot;, Base64.getEncoder().encodeToString(encryptionKeyPair.first))
</a><a href="#h4-7-11" id="h4-7-11" class="d">-                                addProperty(&quot;iv&quot;, Base64.getEncoder().encodeToString(encryptionKeyPair.second))
</a><a href="#h4-7-12" id="h4-7-12" class="d">-                            })
</a><a href="#h4-7-13" id="h4-7-13" class="d">-                        }
</a><a href="#h4-7-14" id="h4-7-14" class="d">-
</a><a href="#h4-7-15" id="h4-7-15" class="d">-                        val remoteMediaReferences by lazy {
</a><a href="#h4-7-16" id="h4-7-16" class="d">-                            val serializedMessageContent = context.gson.toJsonTree(message.messageContent.instanceNonNull()).asJsonObject
</a><a href="#h4-7-17" id="h4-7-17" class="d">-                            serializedMessageContent[&quot;mRemoteMediaReferences&quot;]
</a><a href="#h4-7-18" id="h4-7-18" class="d">-                                .asJsonArray.map { it.asJsonObject[&quot;mMediaReferences&quot;].asJsonArray }
</a><a href="#h4-7-19" id="h4-7-19" class="d">-                                .flatten()
</a><a href="#h4-7-20" id="h4-7-20" class="d">-                        }
</a><a href="#h4-7-21" id="h4-7-21" class="d">-
</a><a href="#h4-7-22" id="h4-7-22" class="d">-                        add(&quot;mediaReferences&quot;, JsonArray().apply mediaReferences@ {
</a><a href="#h4-7-23" id="h4-7-23" class="d">-                            if (messageContentType != ContentType.EXTERNAL_MEDIA &amp;&amp;
</a><a href="#h4-7-24" id="h4-7-24" class="d">-                                messageContentType != ContentType.STICKER &amp;&amp;
</a><a href="#h4-7-25" id="h4-7-25" class="d">-                                messageContentType != ContentType.SNAP &amp;&amp;
</a><a href="#h4-7-26" id="h4-7-26" class="d">-                                messageContentType != ContentType.NOTE)
</a><a href="#h4-7-27" id="h4-7-27" class="d">-                                return@mediaReferences
</a><a href="#h4-7-28" id="h4-7-28" class="d">-
</a><a href="#h4-7-29" id="h4-7-29" class="d">-                            remoteMediaReferences.forEach { media -&gt;
</a><a href="#h4-7-30" id="h4-7-30" class="d">-                                val protoMediaReference = media.asJsonObject[&quot;mContentObject&quot;].asJsonArray.map { it.asByte }.toByteArray()
</a><a href="#h4-7-31" id="h4-7-31" class="d">-                                val mediaType = MediaReferenceType.valueOf(media.asJsonObject[&quot;mMediaType&quot;].asString)
</a><a href="#h4-7-32" id="h4-7-32" class="i">+                        add(&quot;attachments&quot;, JsonArray().apply {
</a><a href="#h4-7-33" id="h4-7-33" class="i">+                            MessageDecoder.decode(message.messageContent)
</a><a href="#h4-7-34" id="h4-7-34" class="i">+                                .forEach attachments@{ attachments -&gt;
</a><a href="#h4-7-35" id="h4-7-35" class="i">+                                if (attachments.type == AttachmentType.STICKER) //TODO: implement stickers
</a><a href="#h4-7-36" id="h4-7-36" class="i">+                                    return@attachments
</a>                                 add(JsonObject().apply {
<a href="#h4-7-38" id="h4-7-38" class="d">-                                    addProperty(&quot;mediaType&quot;, mediaType.toString())
</a><a href="#h4-7-39" id="h4-7-39" class="d">-                                    addProperty(&quot;content&quot;, Base64.getUrlEncoder().encodeToString(protoMediaReference))
</a><a href="#h4-7-40" id="h4-7-40" class="i">+                                    addProperty(&quot;key&quot;, attachments.mediaKey?.replace(&quot;=&quot;, &quot;&quot;))
</a><a href="#h4-7-41" id="h4-7-41" class="i">+                                    addProperty(&quot;type&quot;, attachments.type.toString())
</a><a href="#h4-7-42" id="h4-7-42" class="i">+                                    add(&quot;encryption&quot;, attachments.attachmentInfo?.encryption?.let { encryption -&gt;
</a><a href="#h4-7-43" id="h4-7-43" class="i">+                                        JsonObject().apply {
</a><a href="#h4-7-44" id="h4-7-44" class="i">+                                            addProperty(&quot;key&quot;, encryption.key)
</a><a href="#h4-7-45" id="h4-7-45" class="i">+                                            addProperty(&quot;iv&quot;, encryption.iv)
</a><a href="#h4-7-46" id="h4-7-46" class="i">+                                        }
</a><a href="#h4-7-47" id="h4-7-47" class="i">+                                    } ?: JsonNull.INSTANCE)
</a>                                 })
                             }
                         })
<a href="#h4-7-51" id="h4-7-51" class="d">-
</a>                     })
                 }
             })
<b>diff --git a/<a id="h5" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/util/snap/EncryptionHelper.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/util/snap/EncryptionHelper.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/util/snap/EncryptionHelper.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/util/snap/EncryptionHelper.kt</a></b>
<a href="#h5-0" id="h5-0" class="h">@@ -1,73 +0,0 @@
</a><a href="#h5-0-0" id="h5-0-0" class="d">-package me.rhunk.snapenhance.core.util.snap
</a><a href="#h5-0-1" id="h5-0-1" class="d">-
</a><a href="#h5-0-2" id="h5-0-2" class="d">-import me.rhunk.snapenhance.Constants
</a><a href="#h5-0-3" id="h5-0-3" class="d">-import me.rhunk.snapenhance.core.download.data.MediaEncryptionKeyPair
</a><a href="#h5-0-4" id="h5-0-4" class="d">-import me.rhunk.snapenhance.core.util.protobuf.ProtoReader
</a><a href="#h5-0-5" id="h5-0-5" class="d">-import me.rhunk.snapenhance.data.ContentType
</a><a href="#h5-0-6" id="h5-0-6" class="d">-import java.io.InputStream
</a><a href="#h5-0-7" id="h5-0-7" class="d">-import javax.crypto.Cipher
</a><a href="#h5-0-8" id="h5-0-8" class="d">-import javax.crypto.CipherInputStream
</a><a href="#h5-0-9" id="h5-0-9" class="d">-import javax.crypto.spec.IvParameterSpec
</a><a href="#h5-0-10" id="h5-0-10" class="d">-import javax.crypto.spec.SecretKeySpec
</a><a href="#h5-0-11" id="h5-0-11" class="d">-import kotlin.io.encoding.Base64
</a><a href="#h5-0-12" id="h5-0-12" class="d">-import kotlin.io.encoding.ExperimentalEncodingApi
</a><a href="#h5-0-13" id="h5-0-13" class="d">-
</a><a href="#h5-0-14" id="h5-0-14" class="d">-@OptIn(ExperimentalEncodingApi::class)
</a><a href="#h5-0-15" id="h5-0-15" class="d">-object EncryptionHelper {
</a><a href="#h5-0-16" id="h5-0-16" class="d">-    fun getEncryptionKeys(contentType: ContentType, messageProto: ProtoReader, isArroyo: Boolean): Pair&lt;ByteArray, ByteArray&gt;? {
</a><a href="#h5-0-17" id="h5-0-17" class="d">-        val mediaEncryptionInfo = MediaDownloaderHelper.getMessageMediaEncryptionInfo(
</a><a href="#h5-0-18" id="h5-0-18" class="d">-            messageProto,
</a><a href="#h5-0-19" id="h5-0-19" class="d">-            contentType,
</a><a href="#h5-0-20" id="h5-0-20" class="d">-            isArroyo
</a><a href="#h5-0-21" id="h5-0-21" class="d">-        ) ?: return null
</a><a href="#h5-0-22" id="h5-0-22" class="d">-        val encryptionProtoIndex = if (mediaEncryptionInfo.contains(Constants.ENCRYPTION_PROTO_INDEX_V2)) {
</a><a href="#h5-0-23" id="h5-0-23" class="d">-            Constants.ENCRYPTION_PROTO_INDEX_V2
</a><a href="#h5-0-24" id="h5-0-24" class="d">-        } else {
</a><a href="#h5-0-25" id="h5-0-25" class="d">-            Constants.ENCRYPTION_PROTO_INDEX
</a><a href="#h5-0-26" id="h5-0-26" class="d">-        }
</a><a href="#h5-0-27" id="h5-0-27" class="d">-        val encryptionProto = mediaEncryptionInfo.followPath(encryptionProtoIndex) ?: return null
</a><a href="#h5-0-28" id="h5-0-28" class="d">-
</a><a href="#h5-0-29" id="h5-0-29" class="d">-        var key: ByteArray = encryptionProto.getByteArray(1)!!
</a><a href="#h5-0-30" id="h5-0-30" class="d">-        var iv: ByteArray = encryptionProto.getByteArray(2)!!
</a><a href="#h5-0-31" id="h5-0-31" class="d">-
</a><a href="#h5-0-32" id="h5-0-32" class="d">-        if (encryptionProtoIndex == Constants.ENCRYPTION_PROTO_INDEX_V2) {
</a><a href="#h5-0-33" id="h5-0-33" class="d">-            key = Base64.UrlSafe.decode(key)
</a><a href="#h5-0-34" id="h5-0-34" class="d">-            iv = Base64.UrlSafe.decode(iv)
</a><a href="#h5-0-35" id="h5-0-35" class="d">-        }
</a><a href="#h5-0-36" id="h5-0-36" class="d">-
</a><a href="#h5-0-37" id="h5-0-37" class="d">-        return Pair(key, iv)
</a><a href="#h5-0-38" id="h5-0-38" class="d">-    }
</a><a href="#h5-0-39" id="h5-0-39" class="d">-
</a><a href="#h5-0-40" id="h5-0-40" class="d">-    fun decryptInputStream(
</a><a href="#h5-0-41" id="h5-0-41" class="d">-        inputStream: InputStream,
</a><a href="#h5-0-42" id="h5-0-42" class="d">-        contentType: ContentType,
</a><a href="#h5-0-43" id="h5-0-43" class="d">-        messageProto: ProtoReader,
</a><a href="#h5-0-44" id="h5-0-44" class="d">-        isArroyo: Boolean
</a><a href="#h5-0-45" id="h5-0-45" class="d">-    ): InputStream {
</a><a href="#h5-0-46" id="h5-0-46" class="d">-        val encryptionKeys = getEncryptionKeys(contentType, messageProto, isArroyo) ?: throw Exception(&quot;Failed to get encryption keys&quot;)
</a><a href="#h5-0-47" id="h5-0-47" class="d">-
</a><a href="#h5-0-48" id="h5-0-48" class="d">-        Cipher.getInstance(&quot;AES/CBC/PKCS5Padding&quot;).apply {
</a><a href="#h5-0-49" id="h5-0-49" class="d">-            init(Cipher.DECRYPT_MODE, SecretKeySpec(encryptionKeys.first, &quot;AES&quot;), IvParameterSpec(encryptionKeys.second))
</a><a href="#h5-0-50" id="h5-0-50" class="d">-        }.let { cipher -&gt;
</a><a href="#h5-0-51" id="h5-0-51" class="d">-            return CipherInputStream(inputStream, cipher)
</a><a href="#h5-0-52" id="h5-0-52" class="d">-        }
</a><a href="#h5-0-53" id="h5-0-53" class="d">-    }
</a><a href="#h5-0-54" id="h5-0-54" class="d">-
</a><a href="#h5-0-55" id="h5-0-55" class="d">-    fun decryptInputStream(
</a><a href="#h5-0-56" id="h5-0-56" class="d">-        inputStream: InputStream,
</a><a href="#h5-0-57" id="h5-0-57" class="d">-        mediaEncryptionKeyPair: MediaEncryptionKeyPair?
</a><a href="#h5-0-58" id="h5-0-58" class="d">-    ): InputStream {
</a><a href="#h5-0-59" id="h5-0-59" class="d">-        if (mediaEncryptionKeyPair == null) {
</a><a href="#h5-0-60" id="h5-0-60" class="d">-            return inputStream
</a><a href="#h5-0-61" id="h5-0-61" class="d">-        }
</a><a href="#h5-0-62" id="h5-0-62" class="d">-
</a><a href="#h5-0-63" id="h5-0-63" class="d">-        Cipher.getInstance(&quot;AES/CBC/PKCS5Padding&quot;).apply {
</a><a href="#h5-0-64" id="h5-0-64" class="d">-            init(Cipher.DECRYPT_MODE,
</a><a href="#h5-0-65" id="h5-0-65" class="d">-                SecretKeySpec(Base64.UrlSafe.decode(mediaEncryptionKeyPair.key), &quot;AES&quot;),
</a><a href="#h5-0-66" id="h5-0-66" class="d">-                IvParameterSpec(Base64.UrlSafe.decode(mediaEncryptionKeyPair.iv))
</a><a href="#h5-0-67" id="h5-0-67" class="d">-            )
</a><a href="#h5-0-68" id="h5-0-68" class="d">-        }.let { cipher -&gt;
</a><a href="#h5-0-69" id="h5-0-69" class="d">-            return CipherInputStream(inputStream, cipher)
</a><a href="#h5-0-70" id="h5-0-70" class="d">-        }
</a><a href="#h5-0-71" id="h5-0-71" class="d">-    }
</a><a href="#h5-0-72" id="h5-0-72" class="d">-}
</a><b>diff --git a/<a id="h6" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/util/snap/MediaDownloaderHelper.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/util/snap/MediaDownloaderHelper.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/util/snap/MediaDownloaderHelper.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/util/snap/MediaDownloaderHelper.kt</a></b>
<a href="#h6-0" id="h6-0" class="h">@@ -1,70 +1,45 @@
</a> package me.rhunk.snapenhance.core.util.snap
 
<a href="#h6-0-2" id="h6-0-2" class="d">-import me.rhunk.snapenhance.Constants
</a> import me.rhunk.snapenhance.core.download.data.SplitMediaAssetType
<a href="#h6-0-4" id="h6-0-4" class="d">-import me.rhunk.snapenhance.core.util.download.RemoteMediaResolver
</a><a href="#h6-0-5" id="h6-0-5" class="d">-import me.rhunk.snapenhance.core.util.protobuf.ProtoReader
</a><a href="#h6-0-6" id="h6-0-6" class="d">-import me.rhunk.snapenhance.data.ContentType
</a> import me.rhunk.snapenhance.data.FileType
<a href="#h6-0-8" id="h6-0-8" class="d">-import java.io.ByteArrayInputStream
</a><a href="#h6-0-9" id="h6-0-9" class="d">-import java.io.FileNotFoundException
</a><a href="#h6-0-10" id="h6-0-10" class="i">+import java.io.BufferedInputStream
</a> import java.io.InputStream
<a href="#h6-0-12" id="h6-0-12" class="i">+import java.util.zip.ZipEntry
</a> import java.util.zip.ZipInputStream
 
 
 object MediaDownloaderHelper {
<a href="#h6-0-17" id="h6-0-17" class="d">-    fun getMessageMediaEncryptionInfo(protoReader: ProtoReader, contentType: ContentType, isArroyo: Boolean): ProtoReader? {
</a><a href="#h6-0-18" id="h6-0-18" class="d">-        val messageContainerPath = if (isArroyo) protoReader.followPath(*Constants.ARROYO_MEDIA_CONTAINER_PROTO_PATH)!! else protoReader
</a><a href="#h6-0-19" id="h6-0-19" class="d">-        val mediaContainerPath = if (contentType == ContentType.NOTE) intArrayOf(6, 1, 1) else intArrayOf(5, 1, 1)
</a><a href="#h6-0-20" id="h6-0-20" class="i">+    fun getFileType(bufferedInputStream: BufferedInputStream): FileType {
</a><a href="#h6-0-21" id="h6-0-21" class="i">+        val buffer = ByteArray(16)
</a><a href="#h6-0-22" id="h6-0-22" class="i">+        bufferedInputStream.mark(16)
</a><a href="#h6-0-23" id="h6-0-23" class="i">+        bufferedInputStream.read(buffer)
</a><a href="#h6-0-24" id="h6-0-24" class="i">+        bufferedInputStream.reset()
</a><a href="#h6-0-25" id="h6-0-25" class="i">+        return FileType.fromByteArray(buffer)
</a><a href="#h6-0-26" id="h6-0-26" class="i">+    }
</a> 
<a href="#h6-0-28" id="h6-0-28" class="d">-        return when (contentType) {
</a><a href="#h6-0-29" id="h6-0-29" class="d">-            ContentType.NOTE -&gt; messageContainerPath.followPath(*mediaContainerPath)
</a><a href="#h6-0-30" id="h6-0-30" class="d">-            ContentType.SNAP -&gt; messageContainerPath.followPath(*(intArrayOf(11) + mediaContainerPath))
</a><a href="#h6-0-31" id="h6-0-31" class="d">-            ContentType.EXTERNAL_MEDIA -&gt; {
</a><a href="#h6-0-32" id="h6-0-32" class="d">-                val externalMediaTypes = arrayOf(
</a><a href="#h6-0-33" id="h6-0-33" class="d">-                    intArrayOf(3, 3, *mediaContainerPath), //normal external media
</a><a href="#h6-0-34" id="h6-0-34" class="d">-                    intArrayOf(7, 15, 1, 1), //attached audio note
</a><a href="#h6-0-35" id="h6-0-35" class="d">-                    intArrayOf(7, 12, 3, *mediaContainerPath), //attached story reply
</a><a href="#h6-0-36" id="h6-0-36" class="d">-                    intArrayOf(7, 3, *mediaContainerPath), //original story reply
</a><a href="#h6-0-37" id="h6-0-37" class="d">-                )
</a><a href="#h6-0-38" id="h6-0-38" class="d">-                externalMediaTypes.forEach { path -&gt;
</a><a href="#h6-0-39" id="h6-0-39" class="d">-                    messageContainerPath.followPath(*path)?.also { return it }
</a><a href="#h6-0-40" id="h6-0-40" class="d">-                }
</a><a href="#h6-0-41" id="h6-0-41" class="d">-                null
</a><a href="#h6-0-42" id="h6-0-42" class="d">-            }
</a><a href="#h6-0-43" id="h6-0-43" class="d">-            else -&gt; null
</a><a href="#h6-0-44" id="h6-0-44" class="i">+
</a><a href="#h6-0-45" id="h6-0-45" class="i">+    fun getSplitElements(
</a><a href="#h6-0-46" id="h6-0-46" class="i">+        inputStream: InputStream,
</a><a href="#h6-0-47" id="h6-0-47" class="i">+        callback: (SplitMediaAssetType, InputStream) -&gt; Unit
</a><a href="#h6-0-48" id="h6-0-48" class="i">+    ) {
</a><a href="#h6-0-49" id="h6-0-49" class="i">+        val bufferedInputStream = BufferedInputStream(inputStream)
</a><a href="#h6-0-50" id="h6-0-50" class="i">+        val fileType = getFileType(bufferedInputStream)
</a><a href="#h6-0-51" id="h6-0-51" class="i">+
</a><a href="#h6-0-52" id="h6-0-52" class="i">+        if (fileType != FileType.ZIP) {
</a><a href="#h6-0-53" id="h6-0-53" class="i">+            callback(SplitMediaAssetType.ORIGINAL, bufferedInputStream)
</a><a href="#h6-0-54" id="h6-0-54" class="i">+            return
</a>         }
<a href="#h6-0-56" id="h6-0-56" class="d">-    }
</a> 
<a href="#h6-0-58" id="h6-0-58" class="d">-    fun downloadMediaFromReference(
</a><a href="#h6-0-59" id="h6-0-59" class="d">-        mediaReference: ByteArray,
</a><a href="#h6-0-60" id="h6-0-60" class="d">-        decryptionCallback: (InputStream) -&gt; InputStream,
</a><a href="#h6-0-61" id="h6-0-61" class="d">-    ): Map&lt;SplitMediaAssetType, ByteArray&gt; {
</a><a href="#h6-0-62" id="h6-0-62" class="d">-        val inputStream = RemoteMediaResolver.downloadBoltMedia(mediaReference) ?: throw FileNotFoundException(&quot;Unable to get media key. Check the logs for more info&quot;)
</a><a href="#h6-0-63" id="h6-0-63" class="d">-        val content = decryptionCallback(inputStream).readBytes()
</a><a href="#h6-0-64" id="h6-0-64" class="d">-        val fileType = FileType.fromByteArray(content)
</a><a href="#h6-0-65" id="h6-0-65" class="d">-        val isZipFile = fileType == FileType.ZIP
</a><a href="#h6-0-66" id="h6-0-66" class="i">+        val zipInputStream = ZipInputStream(bufferedInputStream)
</a> 
<a href="#h6-0-68" id="h6-0-68" class="d">-        //videos with overlay are packed in a zip file
</a><a href="#h6-0-69" id="h6-0-69" class="d">-        //there are 2 files in the zip file, the video (webm) and the overlay (png)
</a><a href="#h6-0-70" id="h6-0-70" class="d">-        if (isZipFile) {
</a><a href="#h6-0-71" id="h6-0-71" class="d">-            var videoData: ByteArray? = null
</a><a href="#h6-0-72" id="h6-0-72" class="d">-            var overlayData: ByteArray? = null
</a><a href="#h6-0-73" id="h6-0-73" class="d">-            val zipInputStream = ZipInputStream(ByteArrayInputStream(content))
</a><a href="#h6-0-74" id="h6-0-74" class="d">-            while (zipInputStream.nextEntry != null) {
</a><a href="#h6-0-75" id="h6-0-75" class="d">-                val zipEntryData: ByteArray = zipInputStream.readBytes()
</a><a href="#h6-0-76" id="h6-0-76" class="d">-                val entryFileType = FileType.fromByteArray(zipEntryData)
</a><a href="#h6-0-77" id="h6-0-77" class="d">-                if (entryFileType.isVideo) {
</a><a href="#h6-0-78" id="h6-0-78" class="d">-                    videoData = zipEntryData
</a><a href="#h6-0-79" id="h6-0-79" class="d">-                } else if (entryFileType.isImage) {
</a><a href="#h6-0-80" id="h6-0-80" class="d">-                    overlayData = zipEntryData
</a><a href="#h6-0-81" id="h6-0-81" class="d">-                }
</a><a href="#h6-0-82" id="h6-0-82" class="i">+        var entry: ZipEntry? = zipInputStream.nextEntry
</a><a href="#h6-0-83" id="h6-0-83" class="i">+        while (entry != null) {
</a><a href="#h6-0-84" id="h6-0-84" class="i">+            if (entry.name.startsWith(&quot;overlay&quot;)) {
</a><a href="#h6-0-85" id="h6-0-85" class="i">+                callback(SplitMediaAssetType.OVERLAY, zipInputStream)
</a><a href="#h6-0-86" id="h6-0-86" class="i">+            } else if (entry.name.startsWith(&quot;media&quot;)) {
</a><a href="#h6-0-87" id="h6-0-87" class="i">+                callback(SplitMediaAssetType.ORIGINAL, zipInputStream)
</a>             }
<a href="#h6-0-89" id="h6-0-89" class="d">-            videoData ?: throw FileNotFoundException(&quot;Unable to find video file in zip file&quot;)
</a><a href="#h6-0-90" id="h6-0-90" class="d">-            overlayData ?: throw FileNotFoundException(&quot;Unable to find overlay file in zip file&quot;)
</a><a href="#h6-0-91" id="h6-0-91" class="d">-            return mapOf(SplitMediaAssetType.ORIGINAL to videoData, SplitMediaAssetType.OVERLAY to overlayData)
</a><a href="#h6-0-92" id="h6-0-92" class="i">+            entry = zipInputStream.nextEntry
</a>         }
<a href="#h6-0-94" id="h6-0-94" class="d">-
</a><a href="#h6-0-95" id="h6-0-95" class="d">-        return mapOf(SplitMediaAssetType.ORIGINAL to content)
</a>     }
 } 
\ No newline at end of file
<b>diff --git a/<a id="h7" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/MediaDownloader.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/MediaDownloader.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/MediaDownloader.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/MediaDownloader.kt</a></b>
<a href="#h7-0" id="h7-0" class="h">@@ -28,7 +28,6 @@ import me.rhunk.snapenhance.core.util.download.RemoteMediaResolver
</a> import me.rhunk.snapenhance.core.util.ktx.getObjectField
 import me.rhunk.snapenhance.core.util.protobuf.ProtoReader
 import me.rhunk.snapenhance.core.util.snap.BitmojiSelfie
<a href="#h7-0-3" id="h7-0-3" class="d">-import me.rhunk.snapenhance.core.util.snap.EncryptionHelper
</a> import me.rhunk.snapenhance.core.util.snap.MediaDownloaderHelper
 import me.rhunk.snapenhance.core.util.snap.PreviewUtils
 import me.rhunk.snapenhance.data.FileType
<a href="#h7-1" id="h7-1" class="h">@@ -47,6 +46,7 @@ import me.rhunk.snapenhance.hook.HookAdapter
</a> import me.rhunk.snapenhance.hook.HookStage
 import me.rhunk.snapenhance.hook.Hooker
 import me.rhunk.snapenhance.ui.ViewAppearanceHelper
<a href="#h7-1-3" id="h7-1-3" class="i">+import java.io.ByteArrayInputStream
</a> import java.nio.file.Paths
 import java.text.SimpleDateFormat
 import java.util.Locale
<a href="#h7-2" id="h7-2" class="h">@@ -526,42 +526,24 @@ class MediaDownloader : MessagingRuleFeature(&quot;MediaDownloader&quot;, MessagingRuleTyp
</a>         val friendInfo: FriendInfo = context.database.getFriendInfo(message.senderId!!) ?: throw Exception(&quot;Friend not found in database&quot;)
         val authorName = friendInfo.usernameForSorting!!
 
<a href="#h7-2-3" id="h7-2-3" class="d">-        var messageContent = message.messageContent!!
</a><a href="#h7-2-4" id="h7-2-4" class="d">-        var customMediaReferences = mutableListOf&lt;String&gt;()
</a><a href="#h7-2-5" id="h7-2-5" class="d">-
</a><a href="#h7-2-6" id="h7-2-6" class="d">-        if (messageLogger.isMessageRemoved(message.clientConversationId!!, message.serverMessageId.toLong())) {
</a><a href="#h7-2-7" id="h7-2-7" class="i">+        val decodedAttachments = if (messageLogger.isMessageRemoved(message.clientConversationId!!, message.serverMessageId.toLong())) {
</a>             val messageObject = messageLogger.getMessageObject(message.clientConversationId!!, message.serverMessageId.toLong()) ?: throw Exception(&quot;Message not found in database&quot;)
<a href="#h7-2-9" id="h7-2-9" class="d">-            val messageContentObject = messageObject.getAsJsonObject(&quot;mMessageContent&quot;)
</a><a href="#h7-2-10" id="h7-2-10" class="d">-
</a><a href="#h7-2-11" id="h7-2-11" class="d">-            messageContent = messageContentObject
</a><a href="#h7-2-12" id="h7-2-12" class="d">-                .getAsJsonArray(&quot;mContent&quot;)
</a><a href="#h7-2-13" id="h7-2-13" class="d">-                .map { it.asByte }
</a><a href="#h7-2-14" id="h7-2-14" class="d">-                .toByteArray()
</a><a href="#h7-2-15" id="h7-2-15" class="d">-
</a><a href="#h7-2-16" id="h7-2-16" class="d">-            customMediaReferences = messageContentObject
</a><a href="#h7-2-17" id="h7-2-17" class="d">-                .getAsJsonArray(&quot;mRemoteMediaReferences&quot;)
</a><a href="#h7-2-18" id="h7-2-18" class="d">-                .map { it.asJsonObject.getAsJsonArray(&quot;mMediaReferences&quot;) }
</a><a href="#h7-2-19" id="h7-2-19" class="d">-                .flatten().map { reference -&gt;
</a><a href="#h7-2-20" id="h7-2-20" class="d">-                    Base64.UrlSafe.encode(
</a><a href="#h7-2-21" id="h7-2-21" class="d">-                        reference.asJsonObject.getAsJsonArray(&quot;mContentObject&quot;).map { it.asByte }.toByteArray()
</a><a href="#h7-2-22" id="h7-2-22" class="d">-                    )
</a><a href="#h7-2-23" id="h7-2-23" class="d">-                }
</a><a href="#h7-2-24" id="h7-2-24" class="d">-                .toMutableList()
</a><a href="#h7-2-25" id="h7-2-25" class="i">+            MessageDecoder.decode(messageObject.getAsJsonObject(&quot;mMessageContent&quot;))
</a><a href="#h7-2-26" id="h7-2-26" class="i">+        } else {
</a><a href="#h7-2-27" id="h7-2-27" class="i">+            MessageDecoder.decode(
</a><a href="#h7-2-28" id="h7-2-28" class="i">+                protoReader = ProtoReader(message.messageContent!!)
</a><a href="#h7-2-29" id="h7-2-29" class="i">+            )
</a>         }
 
<a href="#h7-2-32" id="h7-2-32" class="d">-        val messageReader = ProtoReader(messageContent)
</a><a href="#h7-2-33" id="h7-2-33" class="d">-        val decodedAttachments = MessageDecoder.decode(
</a><a href="#h7-2-34" id="h7-2-34" class="d">-            protoReader = messageReader,
</a><a href="#h7-2-35" id="h7-2-35" class="d">-            customMediaReferences = customMediaReferences.takeIf { it.isNotEmpty() }
</a><a href="#h7-2-36" id="h7-2-36" class="d">-        )
</a><a href="#h7-2-37" id="h7-2-37" class="d">-
</a>         if (decodedAttachments.isEmpty()) {
             context.shortToast(translations[&quot;no_attachments_toast&quot;])
             return
         }
 
         if (!isPreview) {
<a href="#h7-2-44" id="h7-2-44" class="d">-            if (decodedAttachments.size == 1) {
</a><a href="#h7-2-45" id="h7-2-45" class="i">+            if (decodedAttachments.size == 1 ||
</a><a href="#h7-2-46" id="h7-2-46" class="i">+                context.mainActivity == null // we can&#39;t show alert dialogs when it downloads from a notification, so it downloads the first one
</a><a href="#h7-2-47" id="h7-2-47" class="i">+            ) {
</a>                 downloadMessageAttachments(friendInfo, message, authorName,
                     listOf(decodedAttachments.first())
                 )
<a href="#h7-3" id="h7-3" class="h">@@ -600,11 +582,15 @@ class MediaDownloader : MessagingRuleFeature(&quot;MediaDownloader&quot;, MessagingRuleTyp
</a>             val firstAttachment = decodedAttachments.first()
 
             val previewCoroutine = async {
<a href="#h7-3-3" id="h7-3-3" class="d">-                val downloadedMediaList = MediaDownloaderHelper.downloadMediaFromReference(Base64.decode(firstAttachment.mediaKey!!)) {
</a><a href="#h7-3-4" id="h7-3-4" class="d">-                    EncryptionHelper.decryptInputStream(
</a><a href="#h7-3-5" id="h7-3-5" class="d">-                        it,
</a><a href="#h7-3-6" id="h7-3-6" class="d">-                        decodedAttachments.first().attachmentInfo?.encryption
</a><a href="#h7-3-7" id="h7-3-7" class="d">-                    )
</a><a href="#h7-3-8" id="h7-3-8" class="i">+                val downloadedMedia = RemoteMediaResolver.downloadBoltMedia(Base64.decode(firstAttachment.mediaKey!!), decryptionCallback = {
</a><a href="#h7-3-9" id="h7-3-9" class="i">+                    firstAttachment.attachmentInfo?.encryption?.decryptInputStream(it) ?: it
</a><a href="#h7-3-10" id="h7-3-10" class="i">+                }) ?: return@async null
</a><a href="#h7-3-11" id="h7-3-11" class="i">+
</a><a href="#h7-3-12" id="h7-3-12" class="i">+                val downloadedMediaList = mutableMapOf&lt;SplitMediaAssetType, ByteArray&gt;()
</a><a href="#h7-3-13" id="h7-3-13" class="i">+
</a><a href="#h7-3-14" id="h7-3-14" class="i">+                MediaDownloaderHelper.getSplitElements(ByteArrayInputStream(downloadedMedia)) {
</a><a href="#h7-3-15" id="h7-3-15" class="i">+                    type, inputStream -&gt;
</a><a href="#h7-3-16" id="h7-3-16" class="i">+                    downloadedMediaList[type] = inputStream.readBytes()
</a>                 }
 
                 val originalMedia = downloadedMediaList[SplitMediaAssetType.ORIGINAL] ?: return@async null
<b>diff --git a/<a id="h8" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/decoder/MessageDecoder.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/decoder/MessageDecoder.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/decoder/MessageDecoder.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/downloader/decoder/MessageDecoder.kt</a></b>
<a href="#h8-0" id="h8-0" class="h">@@ -1,7 +1,11 @@
</a> package me.rhunk.snapenhance.features.impl.downloader.decoder
 
<a href="#h8-0-2" id="h8-0-2" class="i">+import com.google.gson.GsonBuilder
</a><a href="#h8-0-3" id="h8-0-3" class="i">+import com.google.gson.JsonElement
</a><a href="#h8-0-4" id="h8-0-4" class="i">+import com.google.gson.JsonObject
</a> import me.rhunk.snapenhance.core.download.data.toKeyPair
 import me.rhunk.snapenhance.core.util.protobuf.ProtoReader
<a href="#h8-0-7" id="h8-0-7" class="i">+import me.rhunk.snapenhance.data.wrapper.impl.MessageContent
</a> import kotlin.io.encoding.Base64
 import kotlin.io.encoding.ExperimentalEncodingApi
 
<a href="#h8-1" id="h8-1" class="h">@@ -13,6 +17,8 @@ data class DecodedAttachment(
</a> 
 @OptIn(ExperimentalEncodingApi::class)
 object MessageDecoder {
<a href="#h8-1-3" id="h8-1-3" class="i">+    private val gson = GsonBuilder().create()
</a><a href="#h8-1-4" id="h8-1-4" class="i">+
</a>     private fun decodeAttachment(protoReader: ProtoReader): AttachmentInfo? {
         val mediaInfo =  protoReader.followPath(1, 1) ?: return null
 
<a href="#h8-2" id="h8-2" class="h">@@ -39,6 +45,43 @@ object MessageDecoder {
</a>         )
     }
 
<a href="#h8-2-3" id="h8-2-3" class="i">+    @OptIn(ExperimentalEncodingApi::class)
</a><a href="#h8-2-4" id="h8-2-4" class="i">+    fun getEncodedMediaReferences(messageContent: JsonElement): List&lt;String&gt; {
</a><a href="#h8-2-5" id="h8-2-5" class="i">+        return getMediaReferences(messageContent).map { reference -&gt;
</a><a href="#h8-2-6" id="h8-2-6" class="i">+                Base64.UrlSafe.encode(
</a><a href="#h8-2-7" id="h8-2-7" class="i">+                    reference.asJsonObject.getAsJsonArray(&quot;mContentObject&quot;).map { it.asByte }.toByteArray()
</a><a href="#h8-2-8" id="h8-2-8" class="i">+                )
</a><a href="#h8-2-9" id="h8-2-9" class="i">+            }
</a><a href="#h8-2-10" id="h8-2-10" class="i">+            .toList()
</a><a href="#h8-2-11" id="h8-2-11" class="i">+    }
</a><a href="#h8-2-12" id="h8-2-12" class="i">+
</a><a href="#h8-2-13" id="h8-2-13" class="i">+    fun getMediaReferences(messageContent: JsonElement): List&lt;JsonElement&gt; {
</a><a href="#h8-2-14" id="h8-2-14" class="i">+        return messageContent.asJsonObject.getAsJsonArray(&quot;mRemoteMediaReferences&quot;)
</a><a href="#h8-2-15" id="h8-2-15" class="i">+            .asSequence()
</a><a href="#h8-2-16" id="h8-2-16" class="i">+            .map { it.asJsonObject.getAsJsonArray(&quot;mMediaReferences&quot;) }
</a><a href="#h8-2-17" id="h8-2-17" class="i">+            .flatten()
</a><a href="#h8-2-18" id="h8-2-18" class="i">+            .sortedBy {
</a><a href="#h8-2-19" id="h8-2-19" class="i">+                it.asJsonObject[&quot;mMediaListId&quot;].asLong
</a><a href="#h8-2-20" id="h8-2-20" class="i">+            }.toList()
</a><a href="#h8-2-21" id="h8-2-21" class="i">+    }
</a><a href="#h8-2-22" id="h8-2-22" class="i">+
</a><a href="#h8-2-23" id="h8-2-23" class="i">+
</a><a href="#h8-2-24" id="h8-2-24" class="i">+    fun decode(messageContent: MessageContent): List&lt;DecodedAttachment&gt; {
</a><a href="#h8-2-25" id="h8-2-25" class="i">+        return decode(
</a><a href="#h8-2-26" id="h8-2-26" class="i">+            ProtoReader(messageContent.content),
</a><a href="#h8-2-27" id="h8-2-27" class="i">+            customMediaReferences = getEncodedMediaReferences(gson.toJsonTree(messageContent.instanceNonNull()))
</a><a href="#h8-2-28" id="h8-2-28" class="i">+        )
</a><a href="#h8-2-29" id="h8-2-29" class="i">+    }
</a><a href="#h8-2-30" id="h8-2-30" class="i">+
</a><a href="#h8-2-31" id="h8-2-31" class="i">+    fun decode(messageContent: JsonObject): List&lt;DecodedAttachment&gt; {
</a><a href="#h8-2-32" id="h8-2-32" class="i">+        return decode(
</a><a href="#h8-2-33" id="h8-2-33" class="i">+            ProtoReader(messageContent.getAsJsonArray(&quot;mContent&quot;)
</a><a href="#h8-2-34" id="h8-2-34" class="i">+                .map { it.asByte }
</a><a href="#h8-2-35" id="h8-2-35" class="i">+                .toByteArray()),
</a><a href="#h8-2-36" id="h8-2-36" class="i">+            customMediaReferences = getEncodedMediaReferences(messageContent)
</a><a href="#h8-2-37" id="h8-2-37" class="i">+        )
</a><a href="#h8-2-38" id="h8-2-38" class="i">+    }
</a><a href="#h8-2-39" id="h8-2-39" class="i">+
</a>     fun decode(
         protoReader: ProtoReader,
         customMediaReferences: List&lt;String&gt;? = null // when customReferences is null it means that the message is from arroyo database
<a href="#h8-3" id="h8-3" class="h">@@ -138,7 +181,6 @@ object MessageDecoder {
</a>             }
         }
 
<a href="#h8-3-3" id="h8-3-3" class="d">-
</a>         return decodedAttachment
     }
 } 
\ No newline at end of file
<b>diff --git a/<a id="h9" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/Notifications.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/Notifications.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/Notifications.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/features/impl/tweaks/Notifications.kt</a></b>
<a href="#h9-0" id="h9-0" class="h">@@ -16,9 +16,9 @@ import me.rhunk.snapenhance.core.Logger
</a> import me.rhunk.snapenhance.core.download.data.SplitMediaAssetType
 import me.rhunk.snapenhance.core.eventbus.events.impl.SnapWidgetBroadcastReceiveEvent
 import me.rhunk.snapenhance.core.util.CallbackBuilder
<a href="#h9-0-3" id="h9-0-3" class="i">+import me.rhunk.snapenhance.core.util.download.RemoteMediaResolver
</a> import me.rhunk.snapenhance.core.util.ktx.setObjectField
 import me.rhunk.snapenhance.core.util.protobuf.ProtoReader
<a href="#h9-0-6" id="h9-0-6" class="d">-import me.rhunk.snapenhance.core.util.snap.EncryptionHelper
</a> import me.rhunk.snapenhance.core.util.snap.MediaDownloaderHelper
 import me.rhunk.snapenhance.core.util.snap.PreviewUtils
 import me.rhunk.snapenhance.core.util.snap.SnapWidgetBroadcastReceiverHelper
<a href="#h9-1" id="h9-1" class="h">@@ -34,7 +34,6 @@ import me.rhunk.snapenhance.features.impl.downloader.decoder.MessageDecoder
</a> import me.rhunk.snapenhance.hook.HookStage
 import me.rhunk.snapenhance.hook.Hooker
 import me.rhunk.snapenhance.hook.hook
<a href="#h9-1-3" id="h9-1-3" class="d">-import kotlin.io.encoding.Base64
</a> import kotlin.io.encoding.ExperimentalEncodingApi
 
 class Notifications : Feature(&quot;Notifications&quot;, loadParams = FeatureLoadParams.INIT_SYNC) {
<a href="#h9-2" id="h9-2" class="h">@@ -246,29 +245,31 @@ class Notifications : Feature(&quot;Notifications&quot;, loadParams = FeatureLoadParams.IN
</a>                         appendNotifications()
                     }
                     ContentType.SNAP, ContentType.EXTERNAL_MEDIA -&gt; {
<a href="#h9-2-3" id="h9-2-3" class="d">-                        val serializedMessageContent = context.gson.toJsonTree(snapMessage.messageContent.instanceNonNull()).asJsonObject
</a><a href="#h9-2-4" id="h9-2-4" class="d">-                        val mediaReferences = serializedMessageContent
</a><a href="#h9-2-5" id="h9-2-5" class="d">-                            .getAsJsonArray(&quot;mRemoteMediaReferences&quot;)
</a><a href="#h9-2-6" id="h9-2-6" class="d">-                            .map { it.asJsonObject.getAsJsonArray(&quot;mMediaReferences&quot;) }
</a><a href="#h9-2-7" id="h9-2-7" class="d">-                            .flatten()
</a><a href="#h9-2-8" id="h9-2-8" class="i">+                        val mediaReferences = MessageDecoder.getMediaReferences(
</a><a href="#h9-2-9" id="h9-2-9" class="i">+                            messageContent = context.gson.toJsonTree(snapMessage.messageContent.instanceNonNull())
</a><a href="#h9-2-10" id="h9-2-10" class="i">+                        )
</a> 
<a href="#h9-2-12" id="h9-2-12" class="d">-                        val mediaReferenceUrls = mediaReferences.map { reference -&gt;
</a><a href="#h9-2-13" id="h9-2-13" class="i">+                        val mediaReferenceKeys = mediaReferences.map { reference -&gt;
</a>                             reference.asJsonObject.getAsJsonArray(&quot;mContentObject&quot;).map { it.asByte }.toByteArray()
                         }
 
<a href="#h9-2-17" id="h9-2-17" class="d">-                        MessageDecoder.decode(
</a><a href="#h9-2-18" id="h9-2-18" class="d">-                            ProtoReader(contentData),
</a><a href="#h9-2-19" id="h9-2-19" class="d">-                            customMediaReferences = mediaReferenceUrls.map { Base64.UrlSafe.encode(it) }
</a><a href="#h9-2-20" id="h9-2-20" class="d">-                        ).forEachIndexed { index, media -&gt;
</a><a href="#h9-2-21" id="h9-2-21" class="d">-                            val mediaType = MediaReferenceType.valueOf(mediaReferences[index].asJsonObject[&quot;mMediaType&quot;].asString)
</a><a href="#h9-2-22" id="h9-2-22" class="i">+                        MessageDecoder.decode(snapMessage.messageContent).firstOrNull()?.also { media -&gt;
</a><a href="#h9-2-23" id="h9-2-23" class="i">+                            val mediaType = MediaReferenceType.valueOf(mediaReferences.first().asJsonObject[&quot;mMediaType&quot;].asString)
</a><a href="#h9-2-24" id="h9-2-24" class="i">+
</a>                             runCatching {
<a href="#h9-2-26" id="h9-2-26" class="d">-                                val downloadedMediaList = MediaDownloaderHelper.downloadMediaFromReference(mediaReferenceUrls[index]) { inputStream -&gt;
</a><a href="#h9-2-27" id="h9-2-27" class="d">-                                    media.attachmentInfo?.encryption?.let { EncryptionHelper.decryptInputStream(inputStream, it) } ?: inputStream
</a><a href="#h9-2-28" id="h9-2-28" class="i">+                                val downloadedMedia = RemoteMediaResolver.downloadBoltMedia(mediaReferenceKeys.first(), decryptionCallback =  {
</a><a href="#h9-2-29" id="h9-2-29" class="i">+                                    media.attachmentInfo?.encryption?.decryptInputStream(it) ?: it
</a><a href="#h9-2-30" id="h9-2-30" class="i">+                                }) ?: throw Throwable(&quot;Unable to download media&quot;)
</a><a href="#h9-2-31" id="h9-2-31" class="i">+
</a><a href="#h9-2-32" id="h9-2-32" class="i">+                                val downloadedMedias = mutableMapOf&lt;SplitMediaAssetType, ByteArray&gt;()
</a><a href="#h9-2-33" id="h9-2-33" class="i">+
</a><a href="#h9-2-34" id="h9-2-34" class="i">+                                MediaDownloaderHelper.getSplitElements(downloadedMedia.inputStream()) { type, inputStream -&gt;
</a><a href="#h9-2-35" id="h9-2-35" class="i">+                                    downloadedMedias[type] = inputStream.readBytes()
</a>                                 }
 
<a href="#h9-2-38" id="h9-2-38" class="d">-                                var bitmapPreview = PreviewUtils.createPreview(downloadedMediaList[SplitMediaAssetType.ORIGINAL]!!, mediaType.name.contains(&quot;VIDEO&quot;))!!
</a><a href="#h9-2-39" id="h9-2-39" class="i">+                                var bitmapPreview = PreviewUtils.createPreview(downloadedMedias[SplitMediaAssetType.ORIGINAL]!!, mediaType.name.contains(&quot;VIDEO&quot;))!!
</a> 
<a href="#h9-2-41" id="h9-2-41" class="d">-                                downloadedMediaList[SplitMediaAssetType.OVERLAY]?.let {
</a><a href="#h9-2-42" id="h9-2-42" class="i">+                                downloadedMedias[SplitMediaAssetType.OVERLAY]?.let {
</a>                                     bitmapPreview = PreviewUtils.mergeBitmapOverlay(bitmapPreview, BitmapFactory.decodeByteArray(it, 0, it.size))
                                 }
 
</pre>
</div>
</body>
</html>
