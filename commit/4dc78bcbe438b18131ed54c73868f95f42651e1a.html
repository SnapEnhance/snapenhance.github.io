<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>refactor!: support resource obfuscation There are still many bugs but it is stable enough for daily usage - SnapEnhance - An Xposed module offering an enhanced Snapchat experience
</title>
<link rel="icon" type="image/svg+xml" href="../../logo.png"/>
<link rel="alternate icon" href="../../favicon.png"/>
<link rel="alternate" type="application/atom+xml" title="SnapEnhance Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="SnapEnhance Atom Feed (tags)" href="../tags.xml" />
<link rel="stylesheet" type="text/css" href="../../style.css" />
<link rel="stylesheet" type="text/css" href="../../fonts.css" />
</head>
<body>
<div id="head"><table><tr><td><a class="logo" href="../../"><img src="../../logo.png" alt="" width="32" height="32" /></a></td><td><strong>SnapEnhance</strong><span class="desc"> - An Xposed module offering an enhanced Snapchat experience
</span>
</td></tr></table>
<p><a href="../about.html">About</a> | <a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/LICENSE.html">License</a></p>
</div>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/4dc78bcbe438b18131ed54c73868f95f42651e1a.html">4dc78bcbe438b18131ed54c73868f95f42651e1a</a>
<b>parent</b> <a href="../commit/0fb25515408b82a89f8cbc137aa7419d7083bf1f.html">0fb25515408b82a89f8cbc137aa7419d7083bf1f</a>
<b>Author:</b> rhunk &lt;<a href="mailto:101876869+rhunk@users.noreply.github.com">101876869+rhunk@users.noreply.github.com</a>&gt;
<b>Date:</b>   Fri, 27 Sep 2024 22:23:05 +0200

refactor!: support resource obfuscation
There are still many bugs but it is stable enough for daily usage

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/features/FeaturesRootSection.kt</a></td><td> | </td><td class="num">25</td><td><span class="i">++++++++++++++++++++++++</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/screens/impl/MappingsScreen.kt</a></td><td> | </td><td class="num">24</td><td><span class="i">++++++++++++++++</span><span class="d">--------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h2">app/src/main/kotlin/me/rhunk/snapenhance/ui/util/AlertDialogs.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h3">common/src/main/assets/lang/en_US.json</a></td><td> | </td><td class="num">8</td><td><span class="i">+++</span><span class="d">-----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h4">common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/wrapper/MappingsWrapper.kt</a></td><td> | </td><td class="num">4</td><td><span class="i">+++</span><span class="d">-</span></td></tr>
<tr><td class="A">A</td><td><a href="#h5">common/src/main/kotlin/me/rhunk/snapenhance/common/config/ConfigConstants.kt</a></td><td> | </td><td class="num">7</td><td><span class="i">+++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h6">common/src/main/kotlin/me/rhunk/snapenhance/common/config/ConfigObjects.kt</a></td><td> | </td><td class="num">33</td><td><span class="i">+++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h7">common/src/main/kotlin/me/rhunk/snapenhance/common/config/impl/Camera.kt</a></td><td> | </td><td class="num">7</td><td><span class="i">++</span><span class="d">-----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h8">common/src/main/kotlin/me/rhunk/snapenhance/common/config/impl/UserInterfaceTweaks.kt</a></td><td> | </td><td class="num">6</td><td><span class="i">+++</span><span class="d">---</span></td></tr>
<tr><td class="M">M</td><td><a href="#h9">core/src/main/kotlin/me/rhunk/snapenhance/core/ModContext.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h10">core/src/main/kotlin/me/rhunk/snapenhance/core/SnapEnhance.kt</a></td><td> | </td><td class="num">1</td><td><span class="i">+</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h11">core/src/main/kotlin/me/rhunk/snapenhance/core/event/events/impl/AddViewEvent.kt</a></td><td> | </td><td class="num">6</td><td><span class="i">++++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h12">core/src/main/kotlin/me/rhunk/snapenhance/core/event/events/impl/BindViewEvent.kt</a></td><td> | </td><td class="num">11</td><td><span class="i">++++</span><span class="d">-------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h13">core/src/main/kotlin/me/rhunk/snapenhance/core/features/FeatureManager.kt</a></td><td> | </td><td class="num">7</td><td><span class="i">++</span><span class="d">-----</span></td></tr>
<tr><td class="A">A</td><td><a href="#h14">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/Debug.kt</a></td><td> | </td><td class="num">18</td><td><span class="i">++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h15">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/downloader/MediaDownloader.kt</a></td><td> | </td><td class="num">87</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++</span><span class="d">------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h16">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/BetterLocation.kt</a></td><td> | </td><td class="num">11</td><td><span class="i">+++++++</span><span class="d">----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h17">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/MediaFilePicker.kt</a></td><td> | </td><td class="num">3</td><td><span class="i">+</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h18">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/BypassVideoLengthRestriction.kt</a></td><td> | </td><td class="num">23</td><td><span class="i">++++++++++++++++++</span><span class="d">-----</span></td></tr>
<tr><td class="A">A</td><td><a href="#h19">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/CallButtonsOverride.kt</a></td><td> | </td><td class="num">91</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="D">D</td><td><a href="#h20">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/CallStartConfirmation.kt</a></td><td> | </td><td class="num">66</td><td><span class="i"></span><span class="d">------------------------------------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h21">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/ConversationToolbox.kt</a></td><td> | </td><td class="num">12</td><td><span class="i">++++++</span><span class="d">------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h22">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/FriendFeedMessagePreview.kt</a></td><td> | </td><td class="num">37</td><td><span class="i">+++++++++++++++</span><span class="d">----------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h23">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/MessageIndicators.kt</a></td><td> | </td><td class="num">6</td><td><span class="i">+++</span><span class="d">---</span></td></tr>
<tr><td class="M">M</td><td><a href="#h24">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/SnapPreview.kt</a></td><td> | </td><td class="num">12</td><td><span class="i">++++</span><span class="d">--------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h25">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/SpotlightCommentsUsername.kt</a></td><td> | </td><td class="num">39</td><td><span class="i">+++++++++++++++++++++</span><span class="d">------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h26">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/StealthModeIndicator.kt</a></td><td> | </td><td class="num">8</td><td><span class="i">++</span><span class="d">------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h27">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/UITweaks.kt</a></td><td> | </td><td class="num">119</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">---------------------------</span></td></tr>
<tr><td class="A">A</td><td><a href="#h28">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/UserInterface.kt</a></td><td> | </td><td class="num">63</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h29">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/ViewAppearanceHelper.kt</a></td><td> | </td><td class="num">129</td><td><span class="i">++++++++++++++++++++++++++++</span><span class="d">---------------------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h30">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/AbstractMenu.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h31">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/MenuViewInjector.kt</a></td><td> | </td><td class="num">81</td><td><span class="i">+++++</span><span class="d">--------------------------------------------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h32">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/ChatActionMenu.kt</a></td><td> | </td><td class="num">45</td><td><span class="i">++++++++++++++++++++++++++++++++++++</span><span class="d">---------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h33">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/FriendFeedInfoMenu.kt</a></td><td> | </td><td class="num">114</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">-----------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h34">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/NewChatActionMenu.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h35">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/OperaContextActionMenu.kt</a></td><td> | </td><td class="num">266</td><td><span class="i">+++++++++++++++++++++++++++++++++++++</span><span class="d">------------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h36">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/OperaViewerIcons.kt</a></td><td> | </td><td class="num">108</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">--------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h37">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/SettingsGearInjector.kt</a></td><td> | </td><td class="num">78</td><td><span class="i"></span><span class="d">------------------------------------------------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h38">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/SettingsMenu.kt</a></td><td> | </td><td class="num">33</td><td><span class="i">+++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h39">core/src/main/kotlin/me/rhunk/snapenhance/core/util/ktx/AndroidExt.kt</a></td><td> | </td><td class="num">15</td><td><span class="i">+++++++++++</span><span class="d">----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h40">mapper/src/main/kotlin/me/rhunk/snapenhance/mapper/AbstractClassMapper.kt</a></td><td> | </td><td class="num">7</td><td><span class="i">++++++</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h41">mapper/src/main/kotlin/me/rhunk/snapenhance/mapper/ClassMapper.kt</a></td><td> | </td><td class="num">5</td><td><span class="i">++++</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h42">native/build.gradle.kts</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
</table></pre><pre>43 files changed, 894 insertions(+), 731 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/features/FeaturesRootSection.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/features/FeaturesRootSection.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/features/FeaturesRootSection.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/pages/features/FeaturesRootSection.kt</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -21,6 +21,7 @@ import androidx.compose.ui.Modifier
</a> import androidx.compose.ui.focus.FocusRequester
 import androidx.compose.ui.focus.focusRequester
 import androidx.compose.ui.graphics.Color
<a href="#h0-0-3" id="h0-0-3" class="i">+import androidx.compose.ui.graphics.graphicsLayer
</a> import androidx.compose.ui.text.font.FontWeight
 import androidx.compose.ui.text.style.TextOverflow
 import androidx.compose.ui.unit.dp
<a href="#h0-1" id="h0-1" class="h">@@ -383,9 +384,17 @@ class FeaturesRootSection : Routes.Route() {
</a>             FeatureNotice.REQUIRE_NATIVE_HOOKS.key to Color(0xFFFF5722),
         )
 
<a href="#h0-1-3" id="h0-1-3" class="i">+        val versionCheck = remember { property.key.params.versionCheck }
</a><a href="#h0-1-4" id="h0-1-4" class="i">+        val versionCheckPair = remember(property) { versionCheck?.checkVersion(context.installationSummary.snapchatInfo?.versionCode ?: return@remember null)}
</a><a href="#h0-1-5" id="h0-1-5" class="i">+        val isComponentDisabled = remember { versionCheckPair != null &amp;&amp; versionCheck?.isDisabled == true }
</a><a href="#h0-1-6" id="h0-1-6" class="i">+
</a>         ElevatedCard(
             modifier = Modifier
                 .fillMaxWidth()
<a href="#h0-1-10" id="h0-1-10" class="i">+                .then(
</a><a href="#h0-1-11" id="h0-1-11" class="i">+                    if (isComponentDisabled) Modifier.graphicsLayer(alpha = 0.5f)
</a><a href="#h0-1-12" id="h0-1-12" class="i">+                    else Modifier
</a><a href="#h0-1-13" id="h0-1-13" class="i">+                )
</a>                 .padding(start = 10.dp, end = 10.dp, top = 5.dp, bottom = 5.dp)
         ) {
             Row(
<a href="#h0-2" id="h0-2" class="h">@@ -433,7 +442,21 @@ class FeaturesRootSection : Routes.Route() {
</a>                             lineHeight = 15.sp
                         )
                     }
<a href="#h0-2-3" id="h0-2-3" class="i">+
</a><a href="#h0-2-4" id="h0-2-4" class="i">+                    if (versionCheckPair != null) {
</a><a href="#h0-2-5" id="h0-2-5" class="i">+                        Spacer(modifier = Modifier.height(2.dp))
</a><a href="#h0-2-6" id="h0-2-6" class="i">+                        Text(
</a><a href="#h0-2-7" id="h0-2-7" class="i">+                            text = context.translation.format(
</a><a href="#h0-2-8" id="h0-2-8" class="i">+                                &quot;manager.sections.features.${versionCheckPair.second.key}&quot;,
</a><a href="#h0-2-9" id="h0-2-9" class="i">+                                &quot;version&quot; to versionCheckPair.first.first
</a><a href="#h0-2-10" id="h0-2-10" class="i">+                            ),
</a><a href="#h0-2-11" id="h0-2-11" class="i">+                            color = Color(0xFFFF8585),
</a><a href="#h0-2-12" id="h0-2-12" class="i">+                            fontSize = 12.sp,
</a><a href="#h0-2-13" id="h0-2-13" class="i">+                            lineHeight = 15.sp
</a><a href="#h0-2-14" id="h0-2-14" class="i">+                        )
</a><a href="#h0-2-15" id="h0-2-15" class="i">+                    }
</a>                 }
<a href="#h0-2-17" id="h0-2-17" class="i">+
</a>                 Row(
                     modifier = Modifier
                         .align(Alignment.CenterVertically)
<a href="#h0-3" id="h0-3" class="h">@@ -662,7 +685,7 @@ class FeaturesRootSection : Routes.Route() {
</a>                     contentPadding = PaddingValues(top = 10.dp, bottom = 110.dp),
                     verticalArrangement = Arrangement.Top
                 ) {
<a href="#h0-3-3" id="h0-3-3" class="d">-                    items(properties) {
</a><a href="#h0-3-4" id="h0-3-4" class="i">+                    items(properties, key = { it.key.propertyName() }) {
</a>                         PropertyCard(it)
                     }
                 }
<b>diff --git a/<a id="h1" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/screens/impl/MappingsScreen.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/screens/impl/MappingsScreen.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/screens/impl/MappingsScreen.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/setup/screens/impl/MappingsScreen.kt</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -10,7 +10,6 @@ import androidx.compose.ui.unit.dp
</a> import androidx.compose.ui.window.Dialog
 import kotlinx.coroutines.Dispatchers
 import kotlinx.coroutines.launch
<a href="#h1-0-3" id="h1-0-3" class="d">-import kotlinx.coroutines.withContext
</a> import me.rhunk.snapenhance.ui.setup.screens.SetupScreen
 import me.rhunk.snapenhance.ui.util.AlertDialogs
 
<a href="#h1-1" id="h1-1" class="h">@@ -22,12 +21,14 @@ class MappingsScreen : SetupScreen() {
</a>         var isGenerating by remember { mutableStateOf(false) }
 
         if (infoText != null) {
<a href="#h1-1-3" id="h1-1-3" class="d">-            Dialog(onDismissRequest = {
</a><a href="#h1-1-4" id="h1-1-4" class="i">+            fun dismiss() {
</a>                 infoText = null
<a href="#h1-1-6" id="h1-1-6" class="d">-            }) {
</a><a href="#h1-1-7" id="h1-1-7" class="i">+                goNext()
</a><a href="#h1-1-8" id="h1-1-8" class="i">+            }
</a><a href="#h1-1-9" id="h1-1-9" class="i">+
</a><a href="#h1-1-10" id="h1-1-10" class="i">+            Dialog(onDismissRequest = { dismiss() }) {
</a>                 remember { AlertDialogs(context.translation) }.InfoDialog(title = infoText!!) {
<a href="#h1-1-12" id="h1-1-12" class="d">-                    infoText = null
</a><a href="#h1-1-13" id="h1-1-13" class="d">-                    goNext()
</a><a href="#h1-1-14" id="h1-1-14" class="i">+                    dismiss()
</a>                 }
             }
         }
<a href="#h1-2" id="h1-2" class="h">@@ -40,10 +41,17 @@ class MappingsScreen : SetupScreen() {
</a>                     if (context.installationSummary.snapchatInfo == null) {
                         throw Exception(context.translation[&quot;setup.mappings.generate_failure_no_snapchat&quot;])
                     }
<a href="#h1-2-3" id="h1-2-3" class="d">-                    context.mappings.refresh()
</a><a href="#h1-2-4" id="h1-2-4" class="d">-                    withContext(Dispatchers.Main) {
</a><a href="#h1-2-5" id="h1-2-5" class="d">-                        goNext()
</a><a href="#h1-2-6" id="h1-2-6" class="i">+                    val warnings = context.mappings.refresh()
</a><a href="#h1-2-7" id="h1-2-7" class="i">+
</a><a href="#h1-2-8" id="h1-2-8" class="i">+                    if (warnings.isNotEmpty()) {
</a><a href="#h1-2-9" id="h1-2-9" class="i">+                        isGenerating = false
</a><a href="#h1-2-10" id="h1-2-10" class="i">+                        infoText = &quot;${warnings.size} warning(s) occurred while generating mappings:\n\n${warnings.joinToString(&quot;\n&quot;)}&quot;.also {
</a><a href="#h1-2-11" id="h1-2-11" class="i">+                            context.log.warn(it)
</a><a href="#h1-2-12" id="h1-2-12" class="i">+                        }
</a><a href="#h1-2-13" id="h1-2-13" class="i">+                        return@launch
</a>                     }
<a href="#h1-2-15" id="h1-2-15" class="i">+
</a><a href="#h1-2-16" id="h1-2-16" class="i">+                    goNext()
</a>                 }.onFailure {
                     isGenerating = false
                     infoText = context.translation[&quot;setup.mappings.generate_failure&quot;] + &quot;\n\n&quot; + it.message
<b>diff --git a/<a id="h2" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/util/AlertDialogs.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/util/AlertDialogs.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/util/AlertDialogs.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/util/AlertDialogs.kt</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -139,7 +139,7 @@ class AlertDialogs(
</a>             if (message != null) {
                 Text(
                     text = message,
<a href="#h2-0-3" id="h2-0-3" class="d">-                    style = MaterialTheme.typography.bodyMedium,
</a><a href="#h2-0-4" id="h2-0-4" class="i">+                    style = MaterialTheme.typography.bodySmall,
</a>                     modifier = Modifier.padding(bottom = 15.dp)
                 )
             }
<b>diff --git a/<a id="h3" href="../file/common/src/main/assets/lang/en_US.json.html">common/src/main/assets/lang/en_US.json</a> b/<a href="../file/common/src/main/assets/lang/en_US.json.html">common/src/main/assets/lang/en_US.json</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -94,7 +94,9 @@
</a>                 &quot;config_import_success_toast&quot;: &quot;Config imported successfully&quot;,
                 &quot;config_import_failure_toast&quot;: &quot;Failed to import config {error}&quot;,
                 &quot;config_export_failure_toast&quot;: &quot;Failed to export config {error}&quot;,
<a href="#h3-0-3" id="h3-0-3" class="d">-                &quot;saved_config_snackbar&quot;: &quot;Config saved&quot;
</a><a href="#h3-0-4" id="h3-0-4" class="i">+                &quot;saved_config_snackbar&quot;: &quot;Config saved&quot;,
</a><a href="#h3-0-5" id="h3-0-5" class="i">+                &quot;older_required&quot;: &quot;This feature requires Snapchat v{version} or older to work correctly&quot;,
</a><a href="#h3-0-6" id="h3-0-6" class="i">+                &quot;newer_required&quot;: &quot;This feature requires Snapchat v{version} or newer to work correctly&quot;
</a>             },
             &quot;manage_rule_feature&quot;: {
                 &quot;disable_state_option&quot;: &quot;Disabled&quot;,
<a href="#h3-1" id="h3-1" class="h">@@ -522,10 +524,6 @@
</a>                         &quot;name&quot;: &quot;Disable Spotlight&quot;,
                         &quot;description&quot;: &quot;Disables the Spotlight page&quot;
                     },
<a href="#h3-1-3" id="h3-1-3" class="d">-                    &quot;hide_settings_gear&quot;: {
</a><a href="#h3-1-4" id="h3-1-4" class="d">-                        &quot;name&quot;: &quot;Hide Settings Gear&quot;,
</a><a href="#h3-1-5" id="h3-1-5" class="d">-                        &quot;description&quot;: &quot;Hides the SnapEnhance Settings Gear in friend feed&quot;
</a><a href="#h3-1-6" id="h3-1-6" class="d">-                    },
</a>                     &quot;friend_feed_menu_buttons&quot;: {
                         &quot;name&quot;: &quot;Friend Feed Menu Buttons&quot;,
                         &quot;description&quot;: &quot;Select which buttons to show in the Friend Feed Menu&quot;
<b>diff --git a/<a id="h4" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/wrapper/MappingsWrapper.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/wrapper/MappingsWrapper.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/wrapper/MappingsWrapper.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/bridge/wrapper/MappingsWrapper.kt</a></b>
<a href="#h4-0" id="h4-0" class="h">@@ -67,7 +67,7 @@ class MappingsWrapper(
</a>         isMappingsLoaded = true
     }
 
<a href="#h4-0-3" id="h4-0-3" class="d">-    fun refresh() {
</a><a href="#h4-0-4" id="h4-0-4" class="i">+    fun refresh(): List&lt;String&gt; {
</a>         mappingUniqueHash = getUniqueBuildId()
 
         // reset native signature cache
<a href="#h4-1" id="h4-1" class="h">@@ -87,6 +87,8 @@ class MappingsWrapper(
</a>             }
             writeBytes(result.toString().toByteArray())
         }
<a href="#h4-1-3" id="h4-1-3" class="i">+
</a><a href="#h4-1-4" id="h4-1-4" class="i">+        return classMapper.getWarns()
</a>     }
 
     @Suppress(&quot;UNCHECKED_CAST&quot;)
<b>diff --git a/<a id="h5" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/config/ConfigConstants.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/config/ConfigConstants.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/config/ConfigConstants.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/config/ConfigConstants.kt</a></b>
<a href="#h5-0" id="h5-0" class="h">@@ -0,0 +1,6 @@
</a><a href="#h5-0-0" id="h5-0-0" class="i">+package me.rhunk.snapenhance.common.config
</a><a href="#h5-0-1" id="h5-0-1" class="i">+
</a><a href="#h5-0-2" id="h5-0-2" class="i">+/*
</a><a href="#h5-0-3" id="h5-0-3" class="i">+  Due to recent resource obfuscation, some UI features will no longer work because it depends on non obfuscated resources
</a><a href="#h5-0-4" id="h5-0-4" class="i">+*/
</a><a href="#h5-0-5" id="h5-0-5" class="i">+val RES_OBF_VERSION_CHECK = VersionCheck(maxVersion = (&quot;13.7.0.42&quot; to 157172))</a><a href="#h5-0-6" id="h5-0-6" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h6" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/config/ConfigObjects.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/config/ConfigObjects.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/config/ConfigObjects.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/config/ConfigObjects.kt</a></b>
<a href="#h6-0" id="h6-0" class="h">@@ -35,6 +35,38 @@ enum class ConfigFlag {
</a>     val id = 1 shl ordinal
 }
 
<a href="#h6-0-3" id="h6-0-3" class="i">+data class VersionCheck(
</a><a href="#h6-0-4" id="h6-0-4" class="i">+    // Pair&lt;versionString, versionCode&gt;
</a><a href="#h6-0-5" id="h6-0-5" class="i">+    val minVersion: Pair&lt;String, Long&gt;? = null,
</a><a href="#h6-0-6" id="h6-0-6" class="i">+    val maxVersion: Pair&lt;String, Long&gt;? = null,
</a><a href="#h6-0-7" id="h6-0-7" class="i">+    val isDisabled: Boolean = false,
</a><a href="#h6-0-8" id="h6-0-8" class="i">+)  {
</a><a href="#h6-0-9" id="h6-0-9" class="i">+    fun checkVersion(versionCode: Long): Pair&lt;Pair&lt;String, Long&gt;, VersionRequirement&gt;? {
</a><a href="#h6-0-10" id="h6-0-10" class="i">+        minVersion?.let {
</a><a href="#h6-0-11" id="h6-0-11" class="i">+            if (versionCode &lt;= it.second) {
</a><a href="#h6-0-12" id="h6-0-12" class="i">+                return minVersion to VersionRequirement.NEWER_REQUIRED
</a><a href="#h6-0-13" id="h6-0-13" class="i">+            }
</a><a href="#h6-0-14" id="h6-0-14" class="i">+        }
</a><a href="#h6-0-15" id="h6-0-15" class="i">+
</a><a href="#h6-0-16" id="h6-0-16" class="i">+        maxVersion?.let {
</a><a href="#h6-0-17" id="h6-0-17" class="i">+            if (versionCode &gt;= it.second) {
</a><a href="#h6-0-18" id="h6-0-18" class="i">+                return maxVersion to VersionRequirement.OLDER_REQUIRED
</a><a href="#h6-0-19" id="h6-0-19" class="i">+            }
</a><a href="#h6-0-20" id="h6-0-20" class="i">+        }
</a><a href="#h6-0-21" id="h6-0-21" class="i">+
</a><a href="#h6-0-22" id="h6-0-22" class="i">+        return null
</a><a href="#h6-0-23" id="h6-0-23" class="i">+    }
</a><a href="#h6-0-24" id="h6-0-24" class="i">+}
</a><a href="#h6-0-25" id="h6-0-25" class="i">+
</a><a href="#h6-0-26" id="h6-0-26" class="i">+enum class VersionRequirement(
</a><a href="#h6-0-27" id="h6-0-27" class="i">+    val key: String
</a><a href="#h6-0-28" id="h6-0-28" class="i">+) {
</a><a href="#h6-0-29" id="h6-0-29" class="i">+    OLDER_REQUIRED(&quot;older_required&quot;),
</a><a href="#h6-0-30" id="h6-0-30" class="i">+    NEWER_REQUIRED(&quot;newer_required&quot;);
</a><a href="#h6-0-31" id="h6-0-31" class="i">+
</a><a href="#h6-0-32" id="h6-0-32" class="i">+    val id = 1 shl ordinal
</a><a href="#h6-0-33" id="h6-0-33" class="i">+}
</a><a href="#h6-0-34" id="h6-0-34" class="i">+
</a> class ConfigParams(
     private var _flags: Int? = null,
     private var _notices: Int? = null,
<a href="#h6-1" id="h6-1" class="h">@@ -45,6 +77,7 @@ class ConfigParams(
</a>     var customOptionTranslationPath: String? = null,
     var inputCheck: ((String) -&gt; Boolean)? = { true },
     var filenameFilter: ((String) -&gt; Boolean)? = null,
<a href="#h6-1-3" id="h6-1-3" class="i">+    var versionCheck: VersionCheck? = null,
</a> ) {
     val notices get() = _notices?.let { FeatureNotice.entries.filter { flag -&gt; it and flag.id != 0 } } ?: emptyList()
     val flags get() = _flags?.let { ConfigFlag.entries.filter { flag -&gt; it and flag.id != 0 } } ?: emptyList()
<b>diff --git a/<a id="h7" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/config/impl/Camera.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/config/impl/Camera.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/config/impl/Camera.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/config/impl/Camera.kt</a></b>
<a href="#h7-0" id="h7-0" class="h">@@ -4,10 +4,7 @@ import android.content.Context
</a> import android.hardware.camera2.CameraCharacteristics
 import android.hardware.camera2.CameraManager
 import me.rhunk.snapenhance.common.Constants
<a href="#h7-0-3" id="h7-0-3" class="d">-import me.rhunk.snapenhance.common.config.ConfigContainer
</a><a href="#h7-0-4" id="h7-0-4" class="d">-import me.rhunk.snapenhance.common.config.ConfigFlag
</a><a href="#h7-0-5" id="h7-0-5" class="d">-import me.rhunk.snapenhance.common.config.FeatureNotice
</a><a href="#h7-0-6" id="h7-0-6" class="d">-import me.rhunk.snapenhance.common.config.PropertyValue
</a><a href="#h7-0-7" id="h7-0-7" class="i">+import me.rhunk.snapenhance.common.config.*
</a> import me.rhunk.snapenhance.common.logger.AbstractLogger
 
 class Camera : ConfigContainer() {
<a href="#h7-1" id="h7-1" class="h">@@ -51,7 +48,7 @@ class Camera : ConfigContainer() {
</a>     }
 
     val disableCameras = multiple(&quot;disable_cameras&quot;, &quot;front&quot;, &quot;back&quot;) { addNotices(FeatureNotice.INTERNAL_BEHAVIOR); requireRestart() }
<a href="#h7-1-3" id="h7-1-3" class="d">-    val immersiveCameraPreview = boolean(&quot;immersive_camera_preview&quot;) { addNotices(FeatureNotice.UNSTABLE) }
</a><a href="#h7-1-4" id="h7-1-4" class="i">+    val immersiveCameraPreview = boolean(&quot;immersive_camera_preview&quot;) { addNotices(FeatureNotice.UNSTABLE); versionCheck = RES_OBF_VERSION_CHECK.copy(isDisabled = true) }
</a>     val blackPhotos = boolean(&quot;black_photos&quot;)
     val frontCustomFrameRate = unique(&quot;front_custom_frame_rate&quot;, *customFrameRates) { requireRestart(); addFlags(ConfigFlag.NO_TRANSLATE) }
     val backCustomFrameRate = unique(&quot;back_custom_frame_rate&quot;, *customFrameRates) { requireRestart(); addFlags(ConfigFlag.NO_TRANSLATE) }
<b>diff --git a/<a id="h8" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/config/impl/UserInterfaceTweaks.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/config/impl/UserInterfaceTweaks.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/config/impl/UserInterfaceTweaks.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/config/impl/UserInterfaceTweaks.kt</a></b>
<a href="#h8-0" id="h8-0" class="h">@@ -2,6 +2,7 @@ package me.rhunk.snapenhance.common.config.impl
</a> 
 import me.rhunk.snapenhance.common.config.ConfigContainer
 import me.rhunk.snapenhance.common.config.FeatureNotice
<a href="#h8-0-3" id="h8-0-3" class="i">+import me.rhunk.snapenhance.common.config.RES_OBF_VERSION_CHECK
</a> import me.rhunk.snapenhance.common.data.MessagingRuleType
 
 class UserInterfaceTweaks : ConfigContainer() {
<a href="#h8-1" id="h8-1" class="h">@@ -30,7 +31,7 @@ class UserInterfaceTweaks : ConfigContainer() {
</a>         &quot;material_you_light&quot;,
         &quot;material_you_dark&quot;,
         &quot;custom&quot;,
<a href="#h8-1-3" id="h8-1-3" class="d">-    ) { addNotices(FeatureNotice.UNSTABLE); requireRestart() }
</a><a href="#h8-1-4" id="h8-1-4" class="i">+    ) { addNotices(FeatureNotice.UNSTABLE); requireRestart(); versionCheck = RES_OBF_VERSION_CHECK.copy(isDisabled = true) }
</a>     val friendFeedMessagePreview = container(&quot;friend_feed_message_preview&quot;, FriendFeedMessagePreview()) { requireRestart() }
     val snapPreview = boolean(&quot;snap_preview&quot;) { addNotices(FeatureNotice.UNSTABLE); requireRestart() }
     val bootstrapOverride = container(&quot;bootstrap_override&quot;, BootstrapOverride()) { requireRestart() }
<a href="#h8-2" id="h8-2" class="h">@@ -52,11 +53,10 @@ class UserInterfaceTweaks : ConfigContainer() {
</a>         &quot;hide_billboard_prompt&quot;,
         &quot;hide_snapchat_plus_gift_reminders&quot;,
         &quot;hide_map_reactions&quot;,
<a href="#h8-2-3" id="h8-2-3" class="d">-    ) { requireRestart() }
</a><a href="#h8-2-4" id="h8-2-4" class="i">+    ) { requireRestart(); versionCheck = RES_OBF_VERSION_CHECK }
</a>     val operaMediaQuickInfo = boolean(&quot;opera_media_quick_info&quot;) { requireRestart() }
     val oldBitmojiSelfie = unique(&quot;old_bitmoji_selfie&quot;, &quot;2d&quot;, &quot;3d&quot;) { requireCleanCache() }
     val disableSpotlight = boolean(&quot;disable_spotlight&quot;) { requireRestart() }
<a href="#h8-2-8" id="h8-2-8" class="d">-    val hideSettingsGear = boolean(&quot;hide_settings_gear&quot;) { requireRestart() }
</a>     val verticalStoryViewer = boolean(&quot;vertical_story_viewer&quot;) { requireRestart() }
     val messageIndicators = multiple(&quot;message_indicators&quot;, &quot;encryption_indicator&quot;, &quot;platform_indicator&quot;, &quot;location_indicator&quot;, &quot;ovf_editor_indicator&quot;, &quot;director_mode_indicator&quot;) { requireRestart() }
     val stealthModeIndicator = boolean(&quot;stealth_mode_indicator&quot;) { requireRestart() }
<b>diff --git a/<a id="h9" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/ModContext.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/ModContext.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/ModContext.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/ModContext.kt</a></b>
<a href="#h9-0" id="h9-0" class="h">@@ -31,6 +31,7 @@ import me.rhunk.snapenhance.core.messaging.CoreMessagingBridge
</a> import me.rhunk.snapenhance.core.messaging.MessageSender
 import me.rhunk.snapenhance.core.scripting.CoreScriptRuntime
 import me.rhunk.snapenhance.core.ui.InAppOverlay
<a href="#h9-0-3" id="h9-0-3" class="i">+import me.rhunk.snapenhance.core.ui.UserInterface
</a> import me.rhunk.snapenhance.core.util.media.HttpServer
 import me.rhunk.snapenhance.nativelib.NativeConfig
 import me.rhunk.snapenhance.nativelib.NativeLib
<a href="#h9-1" id="h9-1" class="h">@@ -69,6 +70,7 @@ class ModContext(
</a>     val scriptRuntime by lazy { CoreScriptRuntime(this, log) }
     val messagingBridge = CoreMessagingBridge(this)
     val inAppOverlay = InAppOverlay(this)
<a href="#h9-1-3" id="h9-1-3" class="i">+    val userInterface = UserInterface(this)
</a> 
     val isDeveloper by lazy { config.scripting.developerMode.get() }
 
<b>diff --git a/<a id="h10" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/SnapEnhance.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/SnapEnhance.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/SnapEnhance.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/SnapEnhance.kt</a></b>
<a href="#h10-0" id="h10-0" class="h">@@ -162,6 +162,7 @@ class SnapEnhance {
</a>             mappings.init(androidContext)
             database.init()
             eventDispatcher.init()
<a href="#h10-0-3" id="h10-0-3" class="i">+            userInterface.init()
</a>             //if mappings aren&#39;t loaded, we can&#39;t initialize features
             if (!mappings.isMappingsLoaded) return
             features.init()
<b>diff --git a/<a id="h11" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/event/events/impl/AddViewEvent.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/event/events/impl/AddViewEvent.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/event/events/impl/AddViewEvent.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/event/events/impl/AddViewEvent.kt</a></b>
<a href="#h11-0" id="h11-0" class="h">@@ -9,4 +9,6 @@ class AddViewEvent(
</a>     var view: View,
     var index: Int,
     var layoutParams: ViewGroup.LayoutParams
<a href="#h11-0-3" id="h11-0-3" class="d">-) : AbstractHookEvent()</a><a href="#h11-0-4" id="h11-0-4" class="d">-
\ No newline at end of file
</a><a href="#h11-0-5" id="h11-0-5" class="i">+) : AbstractHookEvent() {
</a><a href="#h11-0-6" id="h11-0-6" class="i">+    val viewClassName by lazy { view.javaClass.name }
</a><a href="#h11-0-7" id="h11-0-7" class="i">+}</a><a href="#h11-0-8" id="h11-0-8" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h12" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/event/events/impl/BindViewEvent.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/event/events/impl/BindViewEvent.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/event/events/impl/BindViewEvent.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/event/events/impl/BindViewEvent.kt</a></b>
<a href="#h12-0" id="h12-0" class="h">@@ -1,19 +1,16 @@
</a> package me.rhunk.snapenhance.core.event.events.impl
 
 import android.view.View
<a href="#h12-0-3" id="h12-0-3" class="i">+import android.view.ViewGroup
</a><a href="#h12-0-4" id="h12-0-4" class="i">+import android.widget.LinearLayout
</a> import me.rhunk.snapenhance.common.database.impl.ConversationMessage
 import me.rhunk.snapenhance.core.event.Event
<a href="#h12-0-7" id="h12-0-7" class="d">-import me.rhunk.snapenhance.core.util.ktx.getId
</a> 
 class BindViewEvent(
     val prevModel: Any,
     val nextModel: Any?,
     var view: View
 ): Event() {
<a href="#h12-0-14" id="h12-0-14" class="d">-    val chatMessageContentContainerId by lazy {
</a><a href="#h12-0-15" id="h12-0-15" class="d">-        view.resources.getId(&quot;chat_message_content_container&quot;)
</a><a href="#h12-0-16" id="h12-0-16" class="d">-    }
</a><a href="#h12-0-17" id="h12-0-17" class="d">-
</a>     val databaseMessage by lazy {
         var message: ConversationMessage? = null
         chatMessage { _, messageId -&gt;
<a href="#h12-1" id="h12-1" class="h">@@ -25,8 +22,8 @@ class BindViewEvent(
</a>     inline fun chatMessage(block: (conversationId: String, messageId: String) -&gt; Unit) {
         val modelToString = prevModel.toString()
         if (!modelToString.startsWith(&quot;ChatViewModel&quot;)) return
<a href="#h12-1-3" id="h12-1-3" class="d">-        if (view.id != chatMessageContentContainerId) {
</a><a href="#h12-1-4" id="h12-1-4" class="d">-            view = view.findViewById(chatMessageContentContainerId) ?: return
</a><a href="#h12-1-5" id="h12-1-5" class="i">+        if (view !is LinearLayout) {
</a><a href="#h12-1-6" id="h12-1-6" class="i">+            view = (view as ViewGroup).getChildAt(0)
</a>         }
         modelToString.substringAfter(&quot;messageId=&quot;).substringBefore(&quot;,&quot;).split(&quot;:&quot;).apply {
             if (size != 3) return
<b>diff --git a/<a id="h13" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/FeatureManager.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/FeatureManager.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/FeatureManager.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/FeatureManager.kt</a></b>
<a href="#h13-0" id="h13-0" class="h">@@ -60,6 +60,7 @@ class FeatureManager(
</a> 
     fun init() {
         register(
<a href="#h13-0-3" id="h13-0-3" class="i">+            Debug(),
</a>             SecurityFeatures(),
             EndToEndEncryption(),
             ScopeSync(),
<a href="#h13-1" id="h13-1" class="h">@@ -102,7 +103,7 @@ class FeatureManager(
</a>             HideStreakRestore(),
             HideFriendFeedEntry(),
             HideQuickAddFriendFeed(),
<a href="#h13-1-3" id="h13-1-3" class="d">-            CallStartConfirmation(),
</a><a href="#h13-1-4" id="h13-1-4" class="i">+            CallButtonsOverride(),
</a>             SnapPreview(),
             BypassScreenshotDetection(),
             HalfSwipeNotifier(),
<a href="#h13-2" id="h13-2" class="h">@@ -142,8 +143,6 @@ class FeatureManager(
</a>             runCatching {
                 measureTimeMillis {
                     feature.init()
<a href="#h13-2-3" id="h13-2-3" class="d">-                }.also {
</a><a href="#h13-2-4" id="h13-2-4" class="d">-                    context.log.verbose(&quot;Feature ${feature.key} initialized in $it ms&quot;)
</a>                 }
             }.onFailure {
                 context.log.error(&quot;Failed to init feature ${feature.key}&quot;, it)
<a href="#h13-3" id="h13-3" class="h">@@ -163,8 +162,6 @@ class FeatureManager(
</a>                 }.onFailure {
                     context.log.error(&quot;Failed to run activity listener ${activityListener::class.simpleName}&quot;, it)
                 }
<a href="#h13-3-3" id="h13-3-3" class="d">-            }.also {
</a><a href="#h13-3-4" id="h13-3-4" class="d">-                context.log.verbose(&quot;Activity listener ${activityListener::class.simpleName} executed in $it ms&quot;)
</a>             }
         }
     }
<b>diff --git a/<a id="h14" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/Debug.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/Debug.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/Debug.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/Debug.kt</a></b>
<a href="#h14-0" id="h14-0" class="h">@@ -0,0 +1,17 @@
</a><a href="#h14-0-0" id="h14-0-0" class="i">+package me.rhunk.snapenhance.core.features.impl
</a><a href="#h14-0-1" id="h14-0-1" class="i">+
</a><a href="#h14-0-2" id="h14-0-2" class="i">+import android.widget.TextView
</a><a href="#h14-0-3" id="h14-0-3" class="i">+import me.rhunk.snapenhance.core.event.events.impl.AddViewEvent
</a><a href="#h14-0-4" id="h14-0-4" class="i">+import me.rhunk.snapenhance.core.features.Feature
</a><a href="#h14-0-5" id="h14-0-5" class="i">+
</a><a href="#h14-0-6" id="h14-0-6" class="i">+class Debug : Feature(&quot;Debug&quot;) {
</a><a href="#h14-0-7" id="h14-0-7" class="i">+    override fun init() {
</a><a href="#h14-0-8" id="h14-0-8" class="i">+        if (!context.isDeveloper) return
</a><a href="#h14-0-9" id="h14-0-9" class="i">+        context.event.subscribe(AddViewEvent::class) { event -&gt;
</a><a href="#h14-0-10" id="h14-0-10" class="i">+            event.view.post {
</a><a href="#h14-0-11" id="h14-0-11" class="i">+                val viewText = event.view.takeIf { it is TextView }?.let { (it as TextView).text } ?: &quot;&quot;
</a><a href="#h14-0-12" id="h14-0-12" class="i">+                event.view.contentDescription = &quot;0x&quot; + (event.view.id.takeIf { it &gt; 0 }?.toString(16) ?: &quot;&quot;) + &quot; &quot; + viewText
</a><a href="#h14-0-13" id="h14-0-13" class="i">+            }
</a><a href="#h14-0-14" id="h14-0-14" class="i">+        }
</a><a href="#h14-0-15" id="h14-0-15" class="i">+    }
</a><a href="#h14-0-16" id="h14-0-16" class="i">+}</a><a href="#h14-0-17" id="h14-0-17" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h15" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/downloader/MediaDownloader.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/downloader/MediaDownloader.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/downloader/MediaDownloader.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/downloader/MediaDownloader.kt</a></b>
<a href="#h15-0" id="h15-0" class="h">@@ -38,7 +38,6 @@ import me.rhunk.snapenhance.core.features.impl.messaging.Messaging
</a> import me.rhunk.snapenhance.core.features.impl.spying.MessageLogger
 import me.rhunk.snapenhance.core.ui.ViewAppearanceHelper
 import me.rhunk.snapenhance.core.ui.debugEditText
<a href="#h15-0-3" id="h15-0-3" class="d">-import me.rhunk.snapenhance.core.util.hook.HookAdapter
</a> import me.rhunk.snapenhance.core.util.hook.HookStage
 import me.rhunk.snapenhance.core.util.hook.hook
 import me.rhunk.snapenhance.core.util.ktx.getObjectField
<a href="#h15-1" id="h15-1" class="h">@@ -259,7 +258,7 @@ class MediaDownloader : MessagingRuleFeature(&quot;MediaDownloader&quot;, MessagingRuleTyp
</a>         forceAllowDuplicate: Boolean = false
     ) {
         //messages
<a href="#h15-1-3" id="h15-1-3" class="d">-        paramMap[&quot;MESSAGE_ID&quot;]?.toString()?.takeIf { forceDownload || canAutoDownload(&quot;friend_snaps&quot;) }?.let { id -&gt;
</a><a href="#h15-1-4" id="h15-1-4" class="i">+        paramMap[&quot;MESSAGE_ID&quot;]?.toString()?.takeIf { forceDownload || shouldAutoDownload(&quot;friend_snaps&quot;) }?.let { id -&gt;
</a>             val messageId = id.substring(id.lastIndexOf(&quot;:&quot;) + 1).toLong()
             val conversationMessage = context.database.getConversationMessageFromId(messageId)!!
 
<a href="#h15-2" id="h15-2" class="h">@@ -294,7 +293,7 @@ class MediaDownloader : MessagingRuleFeature(&quot;MediaDownloader&quot;, MessagingRuleTyp
</a> 
         //private stories
         paramMap[&quot;PLAYLIST_V2_GROUP&quot;]?.takeIf {
<a href="#h15-2-3" id="h15-2-3" class="d">-            forceDownload || canAutoDownload(&quot;friend_stories&quot;)
</a><a href="#h15-2-4" id="h15-2-4" class="i">+            forceDownload || shouldAutoDownload(&quot;friend_stories&quot;)
</a>         }?.let { playlistGroup -&gt;
             val playlistGroupString = playlistGroup.toString()
 
<a href="#h15-3" id="h15-3" class="h">@@ -342,7 +341,7 @@ class MediaDownloader : MessagingRuleFeature(&quot;MediaDownloader&quot;, MessagingRuleTyp
</a> 
         //public stories
         if ((snapSource == &quot;PUBLIC_USER&quot; || snapSource == &quot;SAVED_STORY&quot;) &amp;&amp;
<a href="#h15-3-3" id="h15-3-3" class="d">-            (forceDownload || canAutoDownload(&quot;public_stories&quot;))) {
</a><a href="#h15-3-4" id="h15-3-4" class="i">+            (forceDownload || shouldAutoDownload(&quot;public_stories&quot;))) {
</a> 
             val author = (
                 paramMap[&quot;USER_ID&quot;]?.let { context.database.getFriendInfo(it.toString())?.mutableUsername } // only for following users
<a href="#h15-4" id="h15-4" class="h">@@ -369,7 +368,7 @@ class MediaDownloader : MessagingRuleFeature(&quot;MediaDownloader&quot;, MessagingRuleTyp
</a>         }
 
         //spotlight
<a href="#h15-4-3" id="h15-4-3" class="d">-        if (snapSource == &quot;SINGLE_SNAP_STORY&quot; &amp;&amp; (forceDownload || canAutoDownload(&quot;spotlight&quot;))) {
</a><a href="#h15-4-4" id="h15-4-4" class="i">+        if (snapSource == &quot;SINGLE_SNAP_STORY&quot; &amp;&amp; (forceDownload || shouldAutoDownload(&quot;spotlight&quot;))) {
</a>             downloadOperaMedia(provideDownloadManagerClient(
                 mediaIdentifier = paramMap[&quot;SNAP_ID&quot;].toString(),
                 downloadSource = MediaDownloadSource.SPOTLIGHT,
<a href="#h15-5" id="h15-5" class="h">@@ -484,7 +483,7 @@ class MediaDownloader : MessagingRuleFeature(&quot;MediaDownloader&quot;, MessagingRuleTyp
</a>         }
     }
 
<a href="#h15-5-3" id="h15-5-3" class="d">-    private fun canAutoDownload(keyFilter: String? = null): Boolean {
</a><a href="#h15-5-4" id="h15-5-4" class="i">+    private fun shouldAutoDownload(keyFilter: String? = null): Boolean {
</a>         val options by context.config.downloader.autoDownloadSources
         return options.any { keyFilter == null || it.contains(keyFilter, true) }
     }
<a href="#h15-6" id="h15-6" class="h">@@ -492,48 +491,56 @@ class MediaDownloader : MessagingRuleFeature(&quot;MediaDownloader&quot;, MessagingRuleTyp
</a>     override fun init() {
         onNextActivityCreate {
             context.mappings.useMapper(OperaPageViewControllerMapper::class) {
<a href="#h15-6-3" id="h15-6-3" class="d">-                val onOperaViewStateCallback: (HookAdapter) -&gt; Unit = onOperaViewStateCallback@{ param -&gt;
</a><a href="#h15-6-4" id="h15-6-4" class="d">-                    val viewState = (param.thisObject() as Any).getObjectField(viewStateField.get()!!).toString()
</a><a href="#h15-6-5" id="h15-6-5" class="d">-                    if (viewState != &quot;FULLY_DISPLAYED&quot;) {
</a><a href="#h15-6-6" id="h15-6-6" class="d">-                        return@onOperaViewStateCallback
</a><a href="#h15-6-7" id="h15-6-7" class="d">-                    }
</a><a href="#h15-6-8" id="h15-6-8" class="d">-                    val operaLayerList = (param.thisObject() as Any).getObjectField(layerListField.get()!!) as ArrayList&lt;*&gt;
</a><a href="#h15-6-9" id="h15-6-9" class="d">-                    val mediaParamMap: ParamMap = operaLayerList.map { Layer(it) }.first().paramMap
</a><a href="#h15-6-10" id="h15-6-10" class="i">+                arrayOf(onDisplayStateChange, onDisplayStateChangeGesture).forEach { methodName -&gt;
</a><a href="#h15-6-11" id="h15-6-11" class="i">+                    classReference.get()?.hook(
</a><a href="#h15-6-12" id="h15-6-12" class="i">+                        methodName.get() ?: return@forEach,
</a><a href="#h15-6-13" id="h15-6-13" class="i">+                        HookStage.AFTER
</a><a href="#h15-6-14" id="h15-6-14" class="i">+                    ) onOperaViewStateCallback@{ param -&gt;
</a><a href="#h15-6-15" id="h15-6-15" class="i">+                        val viewState = (param.thisObject() as Any).getObjectField(viewStateField.get()!!).toString()
</a> 
<a href="#h15-6-17" id="h15-6-17" class="d">-                    if (!mediaParamMap.containsKey(&quot;image_media_info&quot;) &amp;&amp; !mediaParamMap.containsKey(&quot;video_media_info_list&quot;))
</a><a href="#h15-6-18" id="h15-6-18" class="d">-                        return@onOperaViewStateCallback
</a><a href="#h15-6-19" id="h15-6-19" class="i">+                        if (viewState != &quot;FULLY_DISPLAYED&quot;) {
</a><a href="#h15-6-20" id="h15-6-20" class="i">+                            return@onOperaViewStateCallback
</a><a href="#h15-6-21" id="h15-6-21" class="i">+                        }
</a> 
<a href="#h15-6-23" id="h15-6-23" class="d">-                    val mediaInfoMap = mutableMapOf&lt;SplitMediaAssetType, MediaInfo&gt;()
</a><a href="#h15-6-24" id="h15-6-24" class="d">-                    val isVideo = mediaParamMap.containsKey(&quot;video_media_info_list&quot;)
</a><a href="#h15-6-25" id="h15-6-25" class="i">+                        val operaLayerList = (param.thisObject() as Any).getObjectField(layerListField.get()!!) as ArrayList&lt;*&gt;
</a><a href="#h15-6-26" id="h15-6-26" class="i">+                        val mediaParamMap: ParamMap = operaLayerList.map { Layer(it) }.first().paramMap
</a> 
<a href="#h15-6-28" id="h15-6-28" class="d">-                    mediaInfoMap[SplitMediaAssetType.ORIGINAL] = MediaInfo(
</a><a href="#h15-6-29" id="h15-6-29" class="d">-                        (if (isVideo) mediaParamMap[&quot;video_media_info_list&quot;] else mediaParamMap[&quot;image_media_info&quot;])!!
</a><a href="#h15-6-30" id="h15-6-30" class="d">-                    )
</a><a href="#h15-6-31" id="h15-6-31" class="i">+                        if (!mediaParamMap.containsKey(&quot;image_media_info&quot;) &amp;&amp; !mediaParamMap.containsKey(&quot;video_media_info_list&quot;)) {
</a><a href="#h15-6-32" id="h15-6-32" class="i">+                            return@onOperaViewStateCallback
</a><a href="#h15-6-33" id="h15-6-33" class="i">+                        }
</a> 
<a href="#h15-6-35" id="h15-6-35" class="d">-                    if (context.config.downloader.mergeOverlays.get() &amp;&amp; mediaParamMap.containsKey(&quot;overlay_image_media_info&quot;)) {
</a><a href="#h15-6-36" id="h15-6-36" class="d">-                        mediaInfoMap[SplitMediaAssetType.OVERLAY] =
</a><a href="#h15-6-37" id="h15-6-37" class="d">-                            MediaInfo(mediaParamMap[&quot;overlay_image_media_info&quot;]!!)
</a><a href="#h15-6-38" id="h15-6-38" class="d">-                    }
</a><a href="#h15-6-39" id="h15-6-39" class="d">-                    lastSeenMapParams = mediaParamMap
</a><a href="#h15-6-40" id="h15-6-40" class="d">-                    lastSeenMediaInfoMap = mediaInfoMap
</a><a href="#h15-6-41" id="h15-6-41" class="i">+                        val mediaInfoMap = mutableMapOf&lt;SplitMediaAssetType, MediaInfo&gt;()
</a><a href="#h15-6-42" id="h15-6-42" class="i">+                        val isVideo = mediaParamMap.containsKey(&quot;video_media_info_list&quot;)
</a> 
<a href="#h15-6-44" id="h15-6-44" class="d">-                    if (!canAutoDownload()) return@onOperaViewStateCallback
</a><a href="#h15-6-45" id="h15-6-45" class="i">+                        mediaInfoMap[SplitMediaAssetType.ORIGINAL] = MediaInfo(
</a><a href="#h15-6-46" id="h15-6-46" class="i">+                            (if (isVideo) mediaParamMap[&quot;video_media_info_list&quot;] else mediaParamMap[&quot;image_media_info&quot;])!!
</a><a href="#h15-6-47" id="h15-6-47" class="i">+                        )
</a> 
<a href="#h15-6-49" id="h15-6-49" class="d">-                    context.executeAsync {
</a><a href="#h15-6-50" id="h15-6-50" class="d">-                        runCatching {
</a><a href="#h15-6-51" id="h15-6-51" class="d">-                            handleOperaMedia(mediaParamMap, mediaInfoMap, false)
</a><a href="#h15-6-52" id="h15-6-52" class="d">-                        }.onFailure {
</a><a href="#h15-6-53" id="h15-6-53" class="d">-                            context.log.error(&quot;Failed to handle opera media&quot;, it)
</a><a href="#h15-6-54" id="h15-6-54" class="d">-                            context.longToast(it.message)
</a><a href="#h15-6-55" id="h15-6-55" class="i">+                        if (context.config.downloader.mergeOverlays.get() &amp;&amp; mediaParamMap.containsKey(&quot;overlay_image_media_info&quot;)) {
</a><a href="#h15-6-56" id="h15-6-56" class="i">+                            mediaInfoMap[SplitMediaAssetType.OVERLAY] =
</a><a href="#h15-6-57" id="h15-6-57" class="i">+                                MediaInfo(mediaParamMap[&quot;overlay_image_media_info&quot;]!!)
</a>                         }
<a href="#h15-6-59" id="h15-6-59" class="d">-                    }
</a><a href="#h15-6-60" id="h15-6-60" class="d">-                }
</a> 
<a href="#h15-6-62" id="h15-6-62" class="d">-                arrayOf(onDisplayStateChange, onDisplayStateChangeGesture).forEach { methodName -&gt;
</a><a href="#h15-6-63" id="h15-6-63" class="d">-                    classReference.get()?.hook(
</a><a href="#h15-6-64" id="h15-6-64" class="d">-                        methodName.get() ?: return@forEach,
</a><a href="#h15-6-65" id="h15-6-65" class="d">-                        HookStage.AFTER, onOperaViewStateCallback
</a><a href="#h15-6-66" id="h15-6-66" class="d">-                    )
</a><a href="#h15-6-67" id="h15-6-67" class="i">+                        val shouldAutoDownload = shouldAutoDownload()
</a><a href="#h15-6-68" id="h15-6-68" class="i">+
</a><a href="#h15-6-69" id="h15-6-69" class="i">+                        if (shouldAutoDownload &amp;&amp; lastSeenMediaInfoMap?.get(SplitMediaAssetType.ORIGINAL)?.uri == mediaInfoMap[SplitMediaAssetType.ORIGINAL]?.uri) return@onOperaViewStateCallback
</a><a href="#h15-6-70" id="h15-6-70" class="i">+
</a><a href="#h15-6-71" id="h15-6-71" class="i">+                        lastSeenMapParams = mediaParamMap
</a><a href="#h15-6-72" id="h15-6-72" class="i">+                        lastSeenMediaInfoMap = mediaInfoMap
</a><a href="#h15-6-73" id="h15-6-73" class="i">+
</a><a href="#h15-6-74" id="h15-6-74" class="i">+                        if (!shouldAutoDownload) {
</a><a href="#h15-6-75" id="h15-6-75" class="i">+                            return@onOperaViewStateCallback
</a><a href="#h15-6-76" id="h15-6-76" class="i">+                        }
</a><a href="#h15-6-77" id="h15-6-77" class="i">+
</a><a href="#h15-6-78" id="h15-6-78" class="i">+                        context.executeAsync {
</a><a href="#h15-6-79" id="h15-6-79" class="i">+                            runCatching {
</a><a href="#h15-6-80" id="h15-6-80" class="i">+                                handleOperaMedia(mediaParamMap, mediaInfoMap, false)
</a><a href="#h15-6-81" id="h15-6-81" class="i">+                            }.onFailure {
</a><a href="#h15-6-82" id="h15-6-82" class="i">+                                context.log.error(&quot;Failed to handle opera media&quot;, it)
</a><a href="#h15-6-83" id="h15-6-83" class="i">+                                context.longToast(it.message)
</a><a href="#h15-6-84" id="h15-6-84" class="i">+                            }
</a><a href="#h15-6-85" id="h15-6-85" class="i">+                        }
</a><a href="#h15-6-86" id="h15-6-86" class="i">+                    }
</a>                 }
             }
         }
<b>diff --git a/<a id="h16" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/BetterLocation.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/BetterLocation.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/BetterLocation.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/BetterLocation.kt</a></b>
<a href="#h16-0" id="h16-0" class="h">@@ -25,6 +25,7 @@ import me.rhunk.snapenhance.common.util.protobuf.ProtoReader
</a> import me.rhunk.snapenhance.core.event.events.impl.AddViewEvent
 import me.rhunk.snapenhance.core.event.events.impl.UnaryCallEvent
 import me.rhunk.snapenhance.core.features.Feature
<a href="#h16-0-3" id="h16-0-3" class="i">+import me.rhunk.snapenhance.core.ui.children
</a> import me.rhunk.snapenhance.core.util.RandomWalking
 import me.rhunk.snapenhance.core.util.dataBuilder
 import me.rhunk.snapenhance.core.util.hook.HookStage
<a href="#h16-1" id="h16-1" class="h">@@ -209,7 +210,7 @@ class BetterLocation : Feature(&quot;Better Location&quot;) {
</a>             hook(&quot;getLongitude&quot;, HookStage.BEFORE, { canSpoofLocation() }) { it.setResult(getLong()) }
         }
 
<a href="#h16-1-3" id="h16-1-3" class="d">-        val mapFeaturesRootId = context.resources.getId(&quot;map_features_root&quot;)
</a><a href="#h16-1-4" id="h16-1-4" class="i">+        val mapViewId = context.resources.getId(&quot;mapview&quot;)
</a> 
         if (context.config.global.betterLocation.showBatteryLevel.get()) {
             findClass(&quot;snap.snap_maps_sdk.nano.SnapMapsSdk\$PublicUserInfo&quot;).hook(&quot;setDisplayName&quot;, HookStage.BEFORE) { param -&gt;
<a href="#h16-2" id="h16-2" class="h">@@ -232,11 +233,13 @@ class BetterLocation : Feature(&quot;Better Location&quot;) {
</a>         }
 
         context.event.subscribe(AddViewEvent::class) { event -&gt;
<a href="#h16-2-3" id="h16-2-3" class="d">-            if (event.view.id != mapFeaturesRootId) return@subscribe
</a><a href="#h16-2-4" id="h16-2-4" class="d">-            val view = event.view as RelativeLayout
</a><a href="#h16-2-5" id="h16-2-5" class="i">+            if (!event.viewClassName.endsWith(&quot;MapScreenRoot&quot;)) return@subscribe
</a> 
<a href="#h16-2-7" id="h16-2-7" class="d">-            view.addOnAttachStateChangeListener(object: View.OnAttachStateChangeListener {
</a><a href="#h16-2-8" id="h16-2-8" class="i">+            event.view.addOnAttachStateChangeListener(object: View.OnAttachStateChangeListener {
</a>                 override fun onViewAttachedToWindow(v: View) {
<a href="#h16-2-10" id="h16-2-10" class="i">+                    val mapView = event.view.findViewById&lt;View&gt;(mapViewId) ?: throw IllegalStateException(&quot;Map view not found&quot;)
</a><a href="#h16-2-11" id="h16-2-11" class="i">+                    val view = (mapView.parent as ViewGroup).children().firstOrNull { it is RelativeLayout } as? RelativeLayout ?: throw IllegalStateException(&quot;Map view parent not found&quot;)
</a><a href="#h16-2-12" id="h16-2-12" class="i">+
</a>                     view.addView(createComposeView(view.context) {
                         val darkTheme = remember { context.androidContext.isDarkTheme() }
                         Box(
<b>diff --git a/<a id="h17" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/MediaFilePicker.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/MediaFilePicker.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/MediaFilePicker.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/experiments/MediaFilePicker.kt</a></b>
<a href="#h17-0" id="h17-0" class="h">@@ -35,7 +35,6 @@ import me.rhunk.snapenhance.core.ui.ViewAppearanceHelper
</a> import me.rhunk.snapenhance.core.util.dataBuilder
 import me.rhunk.snapenhance.core.util.hook.HookStage
 import me.rhunk.snapenhance.core.util.hook.hook
<a href="#h17-0-3" id="h17-0-3" class="d">-import me.rhunk.snapenhance.core.util.ktx.getId
</a> import java.io.InputStream
 import java.lang.reflect.Method
 import kotlin.random.Random
<a href="#h17-1" id="h17-1" class="h">@@ -192,7 +191,7 @@ class MediaFilePicker : Feature(&quot;Media File Picker&quot;) {
</a>             val buttonTag = Random.nextInt(0, 65535)
 
             context.event.subscribe(AddViewEvent::class) { event -&gt;
<a href="#h17-1-3" id="h17-1-3" class="d">-                if (event.parent.id != context.resources.getId(&quot;chat_drawer_container&quot;) || !event.view::class.java.name.endsWith(&quot;ChatMediaDrawer&quot;)) return@subscribe
</a><a href="#h17-1-4" id="h17-1-4" class="i">+                if (event.parent !is FrameLayout || !event.view::class.java.name.endsWith(&quot;ChatMediaDrawer&quot;)) return@subscribe
</a> 
                 event.view.addOnAttachStateChangeListener(object: View.OnAttachStateChangeListener {
                     override fun onViewAttachedToWindow(v: View) {
<b>diff --git a/<a id="h18" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/BypassVideoLengthRestriction.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/BypassVideoLengthRestriction.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/BypassVideoLengthRestriction.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/global/BypassVideoLengthRestriction.kt</a></b>
<a href="#h18-0" id="h18-0" class="h">@@ -28,13 +28,26 @@ class BypassVideoLengthRestriction :
</a> 
                     fileObserver = (object : FileObserver(postedStorySnapFolder, MOVED_TO) {
                         override fun onEvent(event: Int, path: String?) {
<a href="#h18-0-3" id="h18-0-3" class="d">-                            if (event != MOVED_TO || path?.endsWith(&quot;posted_story_snap.2&quot;) != true) return
</a><a href="#h18-0-4" id="h18-0-4" class="d">-                            fileObserver.stopWatching()
</a><a href="#h18-0-5" id="h18-0-5" class="i">+                            if (event != MOVED_TO || path?.contains(&quot;posted_story_snap.&quot;) != true) return
</a> 
<a href="#h18-0-7" id="h18-0-7" class="d">-                            val file = File(postedStorySnapFolder, path)
</a>                             runCatching {
<a href="#h18-0-9" id="h18-0-9" class="d">-                                val fileContent = JsonParser.parseReader(file.reader()).asJsonObject
</a><a href="#h18-0-10" id="h18-0-10" class="d">-                                if (fileContent[&quot;timerOrDuration&quot;].asLong &lt; 0) file.delete()
</a><a href="#h18-0-11" id="h18-0-11" class="i">+                                val file = File(postedStorySnapFolder, path)
</a><a href="#h18-0-12" id="h18-0-12" class="i">+                                file.bufferedReader().use { bufferedReader -&gt;
</a><a href="#h18-0-13" id="h18-0-13" class="i">+                                    bufferedReader.mark(1)
</a><a href="#h18-0-14" id="h18-0-14" class="i">+                                    if (bufferedReader.read() != 123) {
</a><a href="#h18-0-15" id="h18-0-15" class="i">+                                        context.log.verbose(&quot;Ignoring non-JSON file: $path&quot;)
</a><a href="#h18-0-16" id="h18-0-16" class="i">+                                        return@use
</a><a href="#h18-0-17" id="h18-0-17" class="i">+                                    }
</a><a href="#h18-0-18" id="h18-0-18" class="i">+                                    bufferedReader.reset()
</a><a href="#h18-0-19" id="h18-0-19" class="i">+                                    val fileContent = JsonParser.parseReader(bufferedReader).asJsonObject
</a><a href="#h18-0-20" id="h18-0-20" class="i">+                                    if ((fileContent[&quot;timerOrDuration&quot;]?.also {
</a><a href="#h18-0-21" id="h18-0-21" class="i">+                                            fileObserver.stopWatching()
</a><a href="#h18-0-22" id="h18-0-22" class="i">+                                    }?.takeIf { !it.isJsonNull }?.asLong ?: 1) &lt;= 0) {
</a><a href="#h18-0-23" id="h18-0-23" class="i">+                                        context.log.verbose(&quot;Deleting $path&quot;)
</a><a href="#h18-0-24" id="h18-0-24" class="i">+                                        file.delete()
</a><a href="#h18-0-25" id="h18-0-25" class="i">+                                    }
</a><a href="#h18-0-26" id="h18-0-26" class="i">+                                }
</a><a href="#h18-0-27" id="h18-0-27" class="i">+
</a>                             }.onFailure {
                                 context.log.error(&quot;Failed to read story metadata file&quot;, it)
                             }
<b>diff --git a/<a id="h19" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/CallButtonsOverride.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/CallButtonsOverride.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/CallButtonsOverride.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/CallButtonsOverride.kt</a></b>
<a href="#h19-0" id="h19-0" class="h">@@ -0,0 +1,90 @@
</a><a href="#h19-0-0" id="h19-0-0" class="i">+package me.rhunk.snapenhance.core.features.impl.messaging
</a><a href="#h19-0-1" id="h19-0-1" class="i">+
</a><a href="#h19-0-2" id="h19-0-2" class="i">+import android.view.MotionEvent
</a><a href="#h19-0-3" id="h19-0-3" class="i">+import android.view.View
</a><a href="#h19-0-4" id="h19-0-4" class="i">+import android.view.ViewGroup
</a><a href="#h19-0-5" id="h19-0-5" class="i">+import me.rhunk.snapenhance.core.event.events.impl.AddViewEvent
</a><a href="#h19-0-6" id="h19-0-6" class="i">+import me.rhunk.snapenhance.core.features.Feature
</a><a href="#h19-0-7" id="h19-0-7" class="i">+import me.rhunk.snapenhance.core.ui.ViewAppearanceHelper
</a><a href="#h19-0-8" id="h19-0-8" class="i">+import me.rhunk.snapenhance.core.ui.children
</a><a href="#h19-0-9" id="h19-0-9" class="i">+import me.rhunk.snapenhance.core.ui.hideViewCompletely
</a><a href="#h19-0-10" id="h19-0-10" class="i">+import me.rhunk.snapenhance.core.util.hook.HookAdapter
</a><a href="#h19-0-11" id="h19-0-11" class="i">+import me.rhunk.snapenhance.core.util.hook.HookStage
</a><a href="#h19-0-12" id="h19-0-12" class="i">+import me.rhunk.snapenhance.core.util.hook.hook
</a><a href="#h19-0-13" id="h19-0-13" class="i">+
</a><a href="#h19-0-14" id="h19-0-14" class="i">+class CallButtonsOverride : Feature(&quot;CallButtonsOverride&quot;) {
</a><a href="#h19-0-15" id="h19-0-15" class="i">+    private fun hookTouchEvent(param: HookAdapter, motionEvent: MotionEvent, onConfirm: () -&gt; Unit) {
</a><a href="#h19-0-16" id="h19-0-16" class="i">+        if (motionEvent.action != MotionEvent.ACTION_UP) return
</a><a href="#h19-0-17" id="h19-0-17" class="i">+        param.setResult(true)
</a><a href="#h19-0-18" id="h19-0-18" class="i">+        ViewAppearanceHelper.newAlertDialogBuilder(context.mainActivity)
</a><a href="#h19-0-19" id="h19-0-19" class="i">+            .setTitle(context.translation[&quot;call_start_confirmation.dialog_title&quot;])
</a><a href="#h19-0-20" id="h19-0-20" class="i">+            .setMessage(context.translation[&quot;call_start_confirmation.dialog_message&quot;])
</a><a href="#h19-0-21" id="h19-0-21" class="i">+            .setPositiveButton(context.translation[&quot;button.positive&quot;]) { _, _ -&gt; onConfirm() }
</a><a href="#h19-0-22" id="h19-0-22" class="i">+            .setNeutralButton(context.translation[&quot;button.negative&quot;]) { _, _ -&gt; }
</a><a href="#h19-0-23" id="h19-0-23" class="i">+            .show()
</a><a href="#h19-0-24" id="h19-0-24" class="i">+    }
</a><a href="#h19-0-25" id="h19-0-25" class="i">+
</a><a href="#h19-0-26" id="h19-0-26" class="i">+    override fun init() {
</a><a href="#h19-0-27" id="h19-0-27" class="i">+        val hideUiComponents by context.config.userInterface.hideUiComponents
</a><a href="#h19-0-28" id="h19-0-28" class="i">+
</a><a href="#h19-0-29" id="h19-0-29" class="i">+        val hideProfileCallButtons = hideUiComponents.contains(&quot;hide_profile_call_buttons&quot;)
</a><a href="#h19-0-30" id="h19-0-30" class="i">+        val hideChatCallButtons = hideUiComponents.contains(&quot;hide_chat_call_buttons&quot;)
</a><a href="#h19-0-31" id="h19-0-31" class="i">+        val callStartConfirmation = context.config.messaging.callStartConfirmation.get()
</a><a href="#h19-0-32" id="h19-0-32" class="i">+
</a><a href="#h19-0-33" id="h19-0-33" class="i">+        if (!hideProfileCallButtons &amp;&amp; !hideChatCallButtons &amp;&amp; !callStartConfirmation) return
</a><a href="#h19-0-34" id="h19-0-34" class="i">+
</a><a href="#h19-0-35" id="h19-0-35" class="i">+        var actionSheetVideoCallButtonId = -1
</a><a href="#h19-0-36" id="h19-0-36" class="i">+        var actionSheetAudioCallButtonId = -1
</a><a href="#h19-0-37" id="h19-0-37" class="i">+
</a><a href="#h19-0-38" id="h19-0-38" class="i">+        context.event.subscribe(AddViewEvent::class) { event -&gt;
</a><a href="#h19-0-39" id="h19-0-39" class="i">+            if (event.viewClassName.endsWith(&quot;ConstraintLayout&quot;)) {
</a><a href="#h19-0-40" id="h19-0-40" class="i">+                val layout = event.view as? ViewGroup ?: return@subscribe
</a><a href="#h19-0-41" id="h19-0-41" class="i">+                val children = layout.children()
</a><a href="#h19-0-42" id="h19-0-42" class="i">+                if (children.any { !it.javaClass.name.endsWith(&quot;FriendActionButton&quot;) } || children.size != 4) return@subscribe
</a><a href="#h19-0-43" id="h19-0-43" class="i">+
</a><a href="#h19-0-44" id="h19-0-44" class="i">+                actionSheetVideoCallButtonId = children.getOrNull(2)?.id ?: throw IllegalStateException(&quot;Video call button not found&quot;)
</a><a href="#h19-0-45" id="h19-0-45" class="i">+                actionSheetAudioCallButtonId = children.getOrNull(3)?.id ?: throw IllegalStateException(&quot;Audio call button not found&quot;)
</a><a href="#h19-0-46" id="h19-0-46" class="i">+
</a><a href="#h19-0-47" id="h19-0-47" class="i">+                if (hideProfileCallButtons) {
</a><a href="#h19-0-48" id="h19-0-48" class="i">+                    children.getOrNull(2)?.hideViewCompletely()
</a><a href="#h19-0-49" id="h19-0-49" class="i">+                    children.getOrNull(3)?.hideViewCompletely()
</a><a href="#h19-0-50" id="h19-0-50" class="i">+                }
</a><a href="#h19-0-51" id="h19-0-51" class="i">+            }
</a><a href="#h19-0-52" id="h19-0-52" class="i">+
</a><a href="#h19-0-53" id="h19-0-53" class="i">+            if (event.viewClassName.endsWith(&quot;CallButtonsView&quot;) &amp;&amp; hideChatCallButtons) {
</a><a href="#h19-0-54" id="h19-0-54" class="i">+                event.view.hideViewCompletely()
</a><a href="#h19-0-55" id="h19-0-55" class="i">+            }
</a><a href="#h19-0-56" id="h19-0-56" class="i">+        }
</a><a href="#h19-0-57" id="h19-0-57" class="i">+
</a><a href="#h19-0-58" id="h19-0-58" class="i">+        onNextActivityCreate {
</a><a href="#h19-0-59" id="h19-0-59" class="i">+            if (callStartConfirmation) {
</a><a href="#h19-0-60" id="h19-0-60" class="i">+                findClass(&quot;com.snap.composer.views.ComposerRootView&quot;).hook(&quot;dispatchTouchEvent&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h19-0-61" id="h19-0-61" class="i">+                    val view = param.thisObject() as? ViewGroup ?: return@hook
</a><a href="#h19-0-62" id="h19-0-62" class="i">+                    if (!view.javaClass.name.endsWith(&quot;CallButtonsView&quot;)) return@hook
</a><a href="#h19-0-63" id="h19-0-63" class="i">+                    val childComposerView = view.getChildAt(0) as? ViewGroup ?: return@hook
</a><a href="#h19-0-64" id="h19-0-64" class="i">+                    // check if the child composer view contains 2 call buttons
</a><a href="#h19-0-65" id="h19-0-65" class="i">+                    if (childComposerView.children().count {
</a><a href="#h19-0-66" id="h19-0-66" class="i">+                            it::class.java == childComposerView::class.java
</a><a href="#h19-0-67" id="h19-0-67" class="i">+                        } != 2) return@hook
</a><a href="#h19-0-68" id="h19-0-68" class="i">+                    hookTouchEvent(param, param.arg(0)) {
</a><a href="#h19-0-69" id="h19-0-69" class="i">+                        param.invokeOriginal()
</a><a href="#h19-0-70" id="h19-0-70" class="i">+                    }
</a><a href="#h19-0-71" id="h19-0-71" class="i">+                }
</a><a href="#h19-0-72" id="h19-0-72" class="i">+
</a><a href="#h19-0-73" id="h19-0-73" class="i">+                findClass(&quot;com.snap.ui.view.stackdraw.StackDrawLayout&quot;).hook(&quot;onTouchEvent&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h19-0-74" id="h19-0-74" class="i">+                    val view = param.thisObject&lt;View&gt;().takeIf { it.id != -1 } ?: return@hook
</a><a href="#h19-0-75" id="h19-0-75" class="i">+                    if (view.id != actionSheetAudioCallButtonId &amp;&amp; view.id != actionSheetVideoCallButtonId) return@hook
</a><a href="#h19-0-76" id="h19-0-76" class="i">+
</a><a href="#h19-0-77" id="h19-0-77" class="i">+                    hookTouchEvent(param, param.arg(0)) {
</a><a href="#h19-0-78" id="h19-0-78" class="i">+                        arrayOf(
</a><a href="#h19-0-79" id="h19-0-79" class="i">+                            MotionEvent.obtain(0, 0, MotionEvent.ACTION_DOWN, 0f, 0f, 0),
</a><a href="#h19-0-80" id="h19-0-80" class="i">+                            MotionEvent.obtain(0, 0, MotionEvent.ACTION_UP, 0f, 0f, 0)
</a><a href="#h19-0-81" id="h19-0-81" class="i">+                        ).forEach {
</a><a href="#h19-0-82" id="h19-0-82" class="i">+                            param.invokeOriginal(arrayOf(it))
</a><a href="#h19-0-83" id="h19-0-83" class="i">+                        }
</a><a href="#h19-0-84" id="h19-0-84" class="i">+                    }
</a><a href="#h19-0-85" id="h19-0-85" class="i">+                }
</a><a href="#h19-0-86" id="h19-0-86" class="i">+            }
</a><a href="#h19-0-87" id="h19-0-87" class="i">+        }
</a><a href="#h19-0-88" id="h19-0-88" class="i">+    }
</a><a href="#h19-0-89" id="h19-0-89" class="i">+}</a><a href="#h19-0-90" id="h19-0-90" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h20" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/CallStartConfirmation.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/CallStartConfirmation.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/CallStartConfirmation.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/messaging/CallStartConfirmation.kt</a></b>
<a href="#h20-0" id="h20-0" class="h">@@ -1,65 +0,0 @@
</a><a href="#h20-0-0" id="h20-0-0" class="d">-package me.rhunk.snapenhance.core.features.impl.messaging
</a><a href="#h20-0-1" id="h20-0-1" class="d">-
</a><a href="#h20-0-2" id="h20-0-2" class="d">-import android.annotation.SuppressLint
</a><a href="#h20-0-3" id="h20-0-3" class="d">-import android.view.MotionEvent
</a><a href="#h20-0-4" id="h20-0-4" class="d">-import android.view.View
</a><a href="#h20-0-5" id="h20-0-5" class="d">-import android.view.ViewGroup
</a><a href="#h20-0-6" id="h20-0-6" class="d">-import me.rhunk.snapenhance.core.features.Feature
</a><a href="#h20-0-7" id="h20-0-7" class="d">-import me.rhunk.snapenhance.core.ui.ViewAppearanceHelper
</a><a href="#h20-0-8" id="h20-0-8" class="d">-import me.rhunk.snapenhance.core.ui.children
</a><a href="#h20-0-9" id="h20-0-9" class="d">-import me.rhunk.snapenhance.core.util.hook.HookAdapter
</a><a href="#h20-0-10" id="h20-0-10" class="d">-import me.rhunk.snapenhance.core.util.hook.HookStage
</a><a href="#h20-0-11" id="h20-0-11" class="d">-import me.rhunk.snapenhance.core.util.hook.hook
</a><a href="#h20-0-12" id="h20-0-12" class="d">-import me.rhunk.snapenhance.core.util.ktx.getId
</a><a href="#h20-0-13" id="h20-0-13" class="d">-
</a><a href="#h20-0-14" id="h20-0-14" class="d">-class CallStartConfirmation : Feature(&quot;CallStartConfirmation&quot;) {
</a><a href="#h20-0-15" id="h20-0-15" class="d">-    private fun hookTouchEvent(param: HookAdapter, motionEvent: MotionEvent, onConfirm: () -&gt; Unit) {
</a><a href="#h20-0-16" id="h20-0-16" class="d">-        if (motionEvent.action != MotionEvent.ACTION_UP) return
</a><a href="#h20-0-17" id="h20-0-17" class="d">-        param.setResult(true)
</a><a href="#h20-0-18" id="h20-0-18" class="d">-        ViewAppearanceHelper.newAlertDialogBuilder(context.mainActivity)
</a><a href="#h20-0-19" id="h20-0-19" class="d">-            .setTitle(context.translation[&quot;call_start_confirmation.dialog_title&quot;])
</a><a href="#h20-0-20" id="h20-0-20" class="d">-            .setMessage(context.translation[&quot;call_start_confirmation.dialog_message&quot;])
</a><a href="#h20-0-21" id="h20-0-21" class="d">-            .setPositiveButton(context.translation[&quot;button.positive&quot;]) { _, _ -&gt; onConfirm() }
</a><a href="#h20-0-22" id="h20-0-22" class="d">-            .setNeutralButton(context.translation[&quot;button.negative&quot;]) { _, _ -&gt; }
</a><a href="#h20-0-23" id="h20-0-23" class="d">-            .show()
</a><a href="#h20-0-24" id="h20-0-24" class="d">-    }
</a><a href="#h20-0-25" id="h20-0-25" class="d">-
</a><a href="#h20-0-26" id="h20-0-26" class="d">-    @SuppressLint(&quot;DiscouragedApi&quot;)
</a><a href="#h20-0-27" id="h20-0-27" class="d">-    override fun init() {
</a><a href="#h20-0-28" id="h20-0-28" class="d">-        if (!context.config.messaging.callStartConfirmation.get()) return
</a><a href="#h20-0-29" id="h20-0-29" class="d">-
</a><a href="#h20-0-30" id="h20-0-30" class="d">-        onNextActivityCreate {
</a><a href="#h20-0-31" id="h20-0-31" class="d">-            val callButtonsStub = context.resources.getId(&quot;call_buttons_stub&quot;)
</a><a href="#h20-0-32" id="h20-0-32" class="d">-
</a><a href="#h20-0-33" id="h20-0-33" class="d">-            findClass(&quot;com.snap.composer.views.ComposerRootView&quot;).hook(&quot;dispatchTouchEvent&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h20-0-34" id="h20-0-34" class="d">-                val view = param.thisObject() as? ViewGroup ?: return@hook
</a><a href="#h20-0-35" id="h20-0-35" class="d">-                if (view.id != callButtonsStub) return@hook
</a><a href="#h20-0-36" id="h20-0-36" class="d">-                val childComposerView = view.getChildAt(0) as? ViewGroup ?: return@hook
</a><a href="#h20-0-37" id="h20-0-37" class="d">-                // check if the child composer view contains 2 call buttons
</a><a href="#h20-0-38" id="h20-0-38" class="d">-                if (childComposerView.children().count {
</a><a href="#h20-0-39" id="h20-0-39" class="d">-                        it::class.java == childComposerView::class.java
</a><a href="#h20-0-40" id="h20-0-40" class="d">-                    } != 2) return@hook
</a><a href="#h20-0-41" id="h20-0-41" class="d">-                hookTouchEvent(param, param.arg(0)) {
</a><a href="#h20-0-42" id="h20-0-42" class="d">-                    param.invokeOriginal()
</a><a href="#h20-0-43" id="h20-0-43" class="d">-                }
</a><a href="#h20-0-44" id="h20-0-44" class="d">-            }
</a><a href="#h20-0-45" id="h20-0-45" class="d">-
</a><a href="#h20-0-46" id="h20-0-46" class="d">-            val callButton1 = context.resources.getId(&quot;friend_action_button3&quot;)
</a><a href="#h20-0-47" id="h20-0-47" class="d">-            val callButton2 = context.resources.getId(&quot;friend_action_button4&quot;)
</a><a href="#h20-0-48" id="h20-0-48" class="d">-
</a><a href="#h20-0-49" id="h20-0-49" class="d">-            findClass(&quot;com.snap.ui.view.stackdraw.StackDrawLayout&quot;).hook(&quot;onTouchEvent&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h20-0-50" id="h20-0-50" class="d">-                val view = param.thisObject&lt;View&gt;()
</a><a href="#h20-0-51" id="h20-0-51" class="d">-                if (view.id != callButton1 &amp;&amp; view.id != callButton2) return@hook
</a><a href="#h20-0-52" id="h20-0-52" class="d">-
</a><a href="#h20-0-53" id="h20-0-53" class="d">-                hookTouchEvent(param, param.arg(0)) {
</a><a href="#h20-0-54" id="h20-0-54" class="d">-                    arrayOf(
</a><a href="#h20-0-55" id="h20-0-55" class="d">-                        MotionEvent.obtain(0, 0, MotionEvent.ACTION_DOWN, 0f, 0f, 0),
</a><a href="#h20-0-56" id="h20-0-56" class="d">-                        MotionEvent.obtain(0, 0, MotionEvent.ACTION_UP, 0f, 0f, 0)
</a><a href="#h20-0-57" id="h20-0-57" class="d">-                    ).forEach {
</a><a href="#h20-0-58" id="h20-0-58" class="d">-                        param.invokeOriginal(arrayOf(it))
</a><a href="#h20-0-59" id="h20-0-59" class="d">-                    }
</a><a href="#h20-0-60" id="h20-0-60" class="d">-                }
</a><a href="#h20-0-61" id="h20-0-61" class="d">-            }
</a><a href="#h20-0-62" id="h20-0-62" class="d">-        }
</a><a href="#h20-0-63" id="h20-0-63" class="d">-    }
</a><a href="#h20-0-64" id="h20-0-64" class="d">-}</a><a href="#h20-0-65" id="h20-0-65" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h21" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/ConversationToolbox.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/ConversationToolbox.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/ConversationToolbox.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/ConversationToolbox.kt</a></b>
<a href="#h21-0" id="h21-0" class="h">@@ -18,7 +18,9 @@ import androidx.compose.material.icons.filled.KeyboardArrowUp
</a> import androidx.compose.material3.Card
 import androidx.compose.material3.MaterialTheme
 import androidx.compose.material3.Text
<a href="#h21-0-3" id="h21-0-3" class="d">-import androidx.compose.runtime.*
</a><a href="#h21-0-4" id="h21-0-4" class="i">+import androidx.compose.runtime.Composable
</a><a href="#h21-0-5" id="h21-0-5" class="i">+import androidx.compose.runtime.mutableStateMapOf
</a><a href="#h21-0-6" id="h21-0-6" class="i">+import androidx.compose.runtime.remember
</a> import androidx.compose.ui.Alignment
 import androidx.compose.ui.Modifier
 import androidx.compose.ui.graphics.ColorFilter
<a href="#h21-1" id="h21-1" class="h">@@ -35,7 +37,6 @@ import me.rhunk.snapenhance.common.ui.createComposeAlertDialog
</a> import me.rhunk.snapenhance.core.event.events.impl.AddViewEvent
 import me.rhunk.snapenhance.core.features.Feature
 import me.rhunk.snapenhance.core.features.impl.messaging.Messaging
<a href="#h21-1-3" id="h21-1-3" class="d">-import me.rhunk.snapenhance.core.util.ktx.getId
</a> 
 
 data class ComposableMenu(
<a href="#h21-2" id="h21-2" class="h">@@ -57,13 +58,12 @@ class ConversationToolbox : Feature(&quot;Conversation Toolbox&quot;) {
</a>     @SuppressLint(&quot;SetTextI18n&quot;)
     override fun init() {
         onNextActivityCreate {
<a href="#h21-2-3" id="h21-2-3" class="d">-            val defaultInputBarId = context.resources.getId(&quot;default_input_bar&quot;)
</a><a href="#h21-2-4" id="h21-2-4" class="d">-
</a>             context.event.subscribe(AddViewEvent::class) { event -&gt;
<a href="#h21-2-6" id="h21-2-6" class="d">-                if (event.view.id != defaultInputBarId) return@subscribe
</a>                 if (composableList.isEmpty()) return@subscribe
 
<a href="#h21-2-9" id="h21-2-9" class="d">-                (event.view as ViewGroup).addView(FrameLayout(event.view.context).apply {
</a><a href="#h21-2-10" id="h21-2-10" class="i">+                val chatInputBar by getChatInputBar(event) ?: return@subscribe
</a><a href="#h21-2-11" id="h21-2-11" class="i">+
</a><a href="#h21-2-12" id="h21-2-12" class="i">+                chatInputBar?.addView(FrameLayout(event.view.context).apply {
</a>                     layoutParams = LinearLayout.LayoutParams(
                         ViewGroup.LayoutParams.WRAP_CONTENT,
                         (52 * context.resources.displayMetrics.density).toInt(),
<b>diff --git a/<a id="h22" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/FriendFeedMessagePreview.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/FriendFeedMessagePreview.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/FriendFeedMessagePreview.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/FriendFeedMessagePreview.kt</a></b>
<a href="#h22-0" id="h22-0" class="h">@@ -8,7 +8,6 @@ import android.graphics.drawable.shapes.Shape
</a> import android.text.TextPaint
 import android.view.View
 import android.view.ViewGroup
<a href="#h22-0-3" id="h22-0-3" class="d">-import androidx.core.content.res.use
</a> import kotlinx.coroutines.Dispatchers
 import kotlinx.coroutines.ExperimentalCoroutinesApi
 import kotlinx.coroutines.launch
<a href="#h22-1" id="h22-1" class="h">@@ -22,25 +21,15 @@ import me.rhunk.snapenhance.core.features.impl.experiments.EndToEndEncryption
</a> import me.rhunk.snapenhance.core.ui.addForegroundDrawable
 import me.rhunk.snapenhance.core.ui.removeForegroundDrawable
 import me.rhunk.snapenhance.core.util.EvictingMap
<a href="#h22-1-3" id="h22-1-3" class="d">-import me.rhunk.snapenhance.core.util.ktx.getDimens
</a> import me.rhunk.snapenhance.core.util.ktx.getId
<a href="#h22-1-5" id="h22-1-5" class="d">-import me.rhunk.snapenhance.core.util.ktx.getIdentifier
</a> import me.rhunk.snapenhance.core.wrapper.impl.getMessageText
 import java.util.WeakHashMap
 import kotlin.math.absoluteValue
 
 class FriendFeedMessagePreview : Feature(&quot;FriendFeedMessagePreview&quot;) {
<a href="#h22-1-11" id="h22-1-11" class="d">-    private val endToEndEncryption by lazy { context.feature(EndToEndEncryption::class) }
</a>     @OptIn(ExperimentalCoroutinesApi::class)
     private val coroutineDispatcher = Dispatchers.IO.limitedParallelism(1)
     private val setting get() = context.config.userInterface.friendFeedMessagePreview
<a href="#h22-1-15" id="h22-1-15" class="d">-    private val hasE2EE get() = context.config.experimental.e2eEncryption.globalState == true
</a><a href="#h22-1-16" id="h22-1-16" class="d">-
</a><a href="#h22-1-17" id="h22-1-17" class="d">-    private val sigColorTextPrimary by lazy {
</a><a href="#h22-1-18" id="h22-1-18" class="d">-        context.mainActivity!!.theme.obtainStyledAttributes(
</a><a href="#h22-1-19" id="h22-1-19" class="d">-            intArrayOf(context.resources.getIdentifier(&quot;sigColorTextPrimary&quot;, &quot;attr&quot;))
</a><a href="#h22-1-20" id="h22-1-20" class="d">-        ).use { it.getColor(0, 0) }
</a><a href="#h22-1-21" id="h22-1-21" class="d">-    }
</a> 
     private val cachedLayouts = WeakHashMap&lt;String, View&gt;()
     private val messageCache = EvictingMap&lt;String, List&lt;String&gt;&gt;(100)
<a href="#h22-2" id="h22-2" class="h">@@ -52,7 +41,7 @@ class FriendFeedMessagePreview : Feature(&quot;FriendFeedMessagePreview&quot;) {
</a>                 message.messageContent
                     ?.let { ProtoReader(it) }
                     ?.followPath(4, 4)?.let {
<a href="#h22-2-3" id="h22-2-3" class="d">-                        if (hasE2EE) endToEndEncryption.decryptDatabaseMessage(message) else it
</a><a href="#h22-2-4" id="h22-2-4" class="i">+                        if (context.config.experimental.e2eEncryption.globalState == true) context.feature(EndToEndEncryption::class).decryptDatabaseMessage(message) else it
</a>                     }
                     ?: return@mapNotNull null
 
<a href="#h22-3" id="h22-3" class="h">@@ -79,17 +68,21 @@ class FriendFeedMessagePreview : Feature(&quot;FriendFeedMessagePreview&quot;) {
</a>         onNextActivityCreate {
             val ffItemId = context.resources.getId(&quot;ff_item&quot;)
 
<a href="#h22-3-3" id="h22-3-3" class="d">-            val secondaryTextSize = context.resources.getDimens(&quot;ff_feed_cell_secondary_text_size&quot;).toFloat()
</a><a href="#h22-3-4" id="h22-3-4" class="d">-            val ffSdlAvatarMargin = context.resources.getDimens(&quot;ff_sdl_avatar_margin&quot;)
</a><a href="#h22-3-5" id="h22-3-5" class="d">-            val ffSdlAvatarSize = context.resources.getDimens(&quot;ff_sdl_avatar_size&quot;)
</a><a href="#h22-3-6" id="h22-3-6" class="d">-            val ffSdlPrimaryTextStartMargin = context.resources.getDimens(&quot;ff_sdl_primary_text_start_margin&quot;).toFloat()
</a><a href="#h22-3-7" id="h22-3-7" class="i">+            val density = context.resources.displayMetrics.density
</a><a href="#h22-3-8" id="h22-3-8" class="i">+
</a><a href="#h22-3-9" id="h22-3-9" class="i">+            val secondaryTextSize = 10 * density
</a><a href="#h22-3-10" id="h22-3-10" class="i">+            val ffSdlAvatarMargin = (7 * density).toInt()
</a><a href="#h22-3-11" id="h22-3-11" class="i">+            val ffSdlAvatarSize = (43 * density).toInt()
</a><a href="#h22-3-12" id="h22-3-12" class="i">+            val ffSdlPrimaryTextStartMargin = 6 * density
</a> 
<a href="#h22-3-14" id="h22-3-14" class="d">-            val feedEntryHeight = ffSdlAvatarSize + ffSdlAvatarMargin * 2 + (4 * context.resources.displayMetrics.density).toInt()
</a><a href="#h22-3-15" id="h22-3-15" class="d">-            val separatorHeight = (context.resources.displayMetrics.density * 2).toInt()
</a><a href="#h22-3-16" id="h22-3-16" class="d">-            val avenirNextMedium = context.resources.getFont(context.resources.getIdentifier(&quot;avenir_next_medium&quot;, &quot;font&quot;))
</a><a href="#h22-3-17" id="h22-3-17" class="i">+            val feedEntryHeight = ffSdlAvatarSize + ffSdlAvatarMargin * 2 + (4 * density).toInt()
</a><a href="#h22-3-18" id="h22-3-18" class="i">+            val separatorHeight = (density * 2).toInt()
</a>             val textPaint = TextPaint().apply {
                 textSize = secondaryTextSize
<a href="#h22-3-21" id="h22-3-21" class="d">-                typeface = avenirNextMedium
</a><a href="#h22-3-22" id="h22-3-22" class="i">+            }
</a><a href="#h22-3-23" id="h22-3-23" class="i">+
</a><a href="#h22-3-24" id="h22-3-24" class="i">+            val typeface by lazy {
</a><a href="#h22-3-25" id="h22-3-25" class="i">+                context.userInterface.avenirNextTypeface
</a>             }
 
             context.event.subscribe(BuildMessageEvent::class) { param -&gt;
<a href="#h22-4" id="h22-4" class="h">@@ -138,8 +131,8 @@ class FriendFeedMessagePreview : Feature(&quot;FriendFeedMessagePreview&quot;) {
</a>                                 override fun draw(canvas: Canvas, paint: Paint) {
                                     val offsetY = canvas.height.toFloat() - previewContainerHeight
                                     paint.textSize = secondaryTextSize
<a href="#h22-4-3" id="h22-4-3" class="d">-                                    paint.color = sigColorTextPrimary
</a><a href="#h22-4-4" id="h22-4-4" class="d">-                                    paint.typeface = avenirNextMedium
</a><a href="#h22-4-5" id="h22-4-5" class="i">+                                    paint.color = context.userInterface.colorPrimary
</a><a href="#h22-4-6" id="h22-4-6" class="i">+                                    paint.typeface = typeface
</a> 
                                     messageCache[conversationId]?.forEachIndexed { index, messageString -&gt;
                                         canvas.drawText(messageString,
<b>diff --git a/<a id="h23" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/MessageIndicators.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/MessageIndicators.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/MessageIndicators.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/MessageIndicators.kt</a></b>
<a href="#h23-0" id="h23-0" class="h">@@ -41,8 +41,8 @@ class MessageIndicators : Feature(&quot;Message Indicators&quot;) {
</a> 
             context.event.subscribe(BindViewEvent::class) { event -&gt;
                 event.chatMessage { _, _ -&gt;
<a href="#h23-0-3" id="h23-0-3" class="d">-                    val parentLinearLayout = event.view.parent as? ViewGroup ?: return@subscribe
</a><a href="#h23-0-4" id="h23-0-4" class="d">-                    parentLinearLayout.findViewWithTag&lt;View&gt;(messageInfoTag)?.let { parentLinearLayout.removeView(it) }
</a><a href="#h23-0-5" id="h23-0-5" class="i">+                    val view = event.view as? ViewGroup ?: return@subscribe
</a><a href="#h23-0-6" id="h23-0-6" class="i">+                    view.findViewWithTag&lt;View&gt;(messageInfoTag)?.let { view.removeView(it) }
</a> 
                     event.view.removeForegroundDrawable(&quot;messageIndicators&quot;)
 
<a href="#h23-1" id="h23-1" class="h">@@ -138,7 +138,7 @@ class MessageIndicators : Feature(&quot;Message Indicators&quot;) {
</a>                             LinearLayout.LayoutParams.MATCH_PARENT,
                             LinearLayout.LayoutParams.WRAP_CONTENT
                         )
<a href="#h23-1-3" id="h23-1-3" class="d">-                        parentLinearLayout.addView(this)
</a><a href="#h23-1-4" id="h23-1-4" class="i">+                        view.addView(this)
</a>                     }
                 }
             }
<b>diff --git a/<a id="h24" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/SnapPreview.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/SnapPreview.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/SnapPreview.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/SnapPreview.kt</a></b>
<a href="#h24-0" id="h24-0" class="h">@@ -1,6 +1,5 @@
</a> package me.rhunk.snapenhance.core.features.impl.ui
 
<a href="#h24-0-2" id="h24-0-2" class="d">-import android.annotation.SuppressLint
</a> import android.graphics.Bitmap
 import android.graphics.Canvas
 import android.graphics.Paint
<a href="#h24-1" id="h24-1" class="h">@@ -15,7 +14,6 @@ import me.rhunk.snapenhance.core.ui.removeForegroundDrawable
</a> import me.rhunk.snapenhance.core.util.EvictingMap
 import me.rhunk.snapenhance.core.util.hook.HookStage
 import me.rhunk.snapenhance.core.util.hook.hook
<a href="#h24-1-3" id="h24-1-3" class="d">-import me.rhunk.snapenhance.core.util.ktx.getDimens
</a> import me.rhunk.snapenhance.core.util.ktx.getObjectField
 import me.rhunk.snapenhance.core.util.media.PreviewUtils
 import me.rhunk.snapenhance.mapper.impl.CallbackMapper
<a href="#h24-2" id="h24-2" class="h">@@ -25,10 +23,8 @@ class SnapPreview : Feature(&quot;SnapPreview&quot;) {
</a>     private val mediaFileCache = EvictingMap&lt;String, File&gt;(500) // mMediaId =&gt; mediaFile
     private val bitmapCache = EvictingMap&lt;String, Bitmap&gt;(50) // filePath =&gt; bitmap
 
<a href="#h24-2-3" id="h24-2-3" class="d">-    private val isEnabled get() = context.config.userInterface.snapPreview.get()
</a><a href="#h24-2-4" id="h24-2-4" class="d">-
</a>     override fun init() {
<a href="#h24-2-6" id="h24-2-6" class="d">-        if (!isEnabled) return
</a><a href="#h24-2-7" id="h24-2-7" class="i">+        if (!context.config.userInterface.snapPreview.get()) return
</a>         context.mappings.useMapper(CallbackMapper::class) {
             callbacks.getClass(&quot;ContentCallback&quot;)?.hook(&quot;handleContentResult&quot;, HookStage.BEFORE) { param -&gt;
                 val contentResult = param.arg&lt;Any&gt;(0)
<a href="#h24-3" id="h24-3" class="h">@@ -45,9 +41,9 @@ class SnapPreview : Feature(&quot;SnapPreview&quot;) {
</a>         }
 
         onNextActivityCreate {
<a href="#h24-3-3" id="h24-3-3" class="d">-            val chatMediaCardHeight = context.resources.getDimens(&quot;chat_media_card_height&quot;)
</a><a href="#h24-3-4" id="h24-3-4" class="d">-            val chatMediaCardSnapMargin = context.resources.getDimens(&quot;chat_media_card_snap_margin&quot;)
</a><a href="#h24-3-5" id="h24-3-5" class="d">-            val chatMediaCardSnapMarginStartSdl = context.resources.getDimens(&quot;chat_media_card_snap_margin_start_sdl&quot;)
</a><a href="#h24-3-6" id="h24-3-6" class="i">+            val (chatMediaCardHeight, chatMediaCardSnapMargin, chatMediaCardSnapMarginStartSdl) = context.userInterface.run {
</a><a href="#h24-3-7" id="h24-3-7" class="i">+                Triple(dpToPx(60), dpToPx(10), dpToPx(15))
</a><a href="#h24-3-8" id="h24-3-8" class="i">+            }
</a> 
             fun decodeMedia(file: File) = runCatching {
                 bitmapCache.getOrPut(file.absolutePath) {
<b>diff --git a/<a id="h25" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/SpotlightCommentsUsername.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/SpotlightCommentsUsername.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/SpotlightCommentsUsername.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/SpotlightCommentsUsername.kt</a></b>
<a href="#h25-0" id="h25-0" class="h">@@ -1,6 +1,7 @@
</a> package me.rhunk.snapenhance.core.features.impl.ui
 
 import android.annotation.SuppressLint
<a href="#h25-0-3" id="h25-0-3" class="i">+import android.view.ViewGroup
</a> import android.widget.TextView
 import kotlinx.coroutines.Dispatchers
 import kotlinx.coroutines.launch
<a href="#h25-1" id="h25-1" class="h">@@ -8,8 +9,8 @@ import kotlinx.coroutines.withContext
</a> import me.rhunk.snapenhance.core.event.events.impl.BindViewEvent
 import me.rhunk.snapenhance.core.features.Feature
 import me.rhunk.snapenhance.core.features.impl.messaging.Messaging
<a href="#h25-1-3" id="h25-1-3" class="i">+import me.rhunk.snapenhance.core.ui.children
</a> import me.rhunk.snapenhance.core.util.EvictingMap
<a href="#h25-1-5" id="h25-1-5" class="d">-import me.rhunk.snapenhance.core.util.ktx.getId
</a> 
 class SpotlightCommentsUsername : Feature(&quot;SpotlightCommentsUsername&quot;) {
     private val usernameCache = EvictingMap&lt;String, String&gt;(150)
<a href="#h25-2" id="h25-2" class="h">@@ -20,34 +21,36 @@ class SpotlightCommentsUsername : Feature(&quot;SpotlightCommentsUsername&quot;) {
</a> 
         onNextActivityCreate(defer = true) {
             val messaging = context.feature(Messaging::class)
<a href="#h25-2-3" id="h25-2-3" class="d">-            val commentsCreatorBadgeTimestampId = context.resources.getId(&quot;comments_creator_badge_timestamp&quot;)
</a><a href="#h25-2-4" id="h25-2-4" class="d">-
</a>             context.event.subscribe(BindViewEvent::class) { event -&gt;
<a href="#h25-2-6" id="h25-2-6" class="d">-                val commentsCreatorBadgeTimestamp = event.view.findViewById&lt;TextView&gt;(commentsCreatorBadgeTimestampId) ?: return@subscribe
</a><a href="#h25-2-7" id="h25-2-7" class="d">-
</a>                 val posterUserId = event.prevModel.toString().takeIf { it.startsWith(&quot;Comment&quot;) }
                     ?.substringAfter(&quot;posterUserId=&quot;)?.substringBefore(&quot;,&quot;)?.substringBefore(&quot;)&quot;) ?: return@subscribe
 
<a href="#h25-2-11" id="h25-2-11" class="i">+                if (posterUserId == &quot;null&quot;) return@subscribe
</a><a href="#h25-2-12" id="h25-2-12" class="i">+
</a>                 fun setUsername(username: String) {
                     usernameCache[posterUserId] = username
<a href="#h25-2-15" id="h25-2-15" class="i">+                    val commentsCreatorBadgeTimestamp = (event.view as ViewGroup).children().filterIsInstance&lt;TextView&gt;()
</a><a href="#h25-2-16" id="h25-2-16" class="i">+                        .getOrNull(1) ?: return
</a>                     if (commentsCreatorBadgeTimestamp.text.contains(username)) return
<a href="#h25-2-18" id="h25-2-18" class="d">-                    commentsCreatorBadgeTimestamp.text = &quot; (${username})&quot; + commentsCreatorBadgeTimestamp.text.toString()
</a><a href="#h25-2-19" id="h25-2-19" class="i">+                    commentsCreatorBadgeTimestamp.text = &quot; (${username})&quot; + commentsCreatorBadgeTimestamp?.text.toString()
</a>                 }
 
<a href="#h25-2-22" id="h25-2-22" class="d">-                usernameCache[posterUserId]?.let {
</a><a href="#h25-2-23" id="h25-2-23" class="d">-                    setUsername(it)
</a><a href="#h25-2-24" id="h25-2-24" class="d">-                    return@subscribe
</a><a href="#h25-2-25" id="h25-2-25" class="d">-                }
</a><a href="#h25-2-26" id="h25-2-26" class="i">+                event.view.post {
</a><a href="#h25-2-27" id="h25-2-27" class="i">+                    usernameCache[posterUserId]?.let {
</a><a href="#h25-2-28" id="h25-2-28" class="i">+                        setUsername(it)
</a><a href="#h25-2-29" id="h25-2-29" class="i">+                        return@post
</a><a href="#h25-2-30" id="h25-2-30" class="i">+                    }
</a> 
<a href="#h25-2-32" id="h25-2-32" class="d">-                context.coroutineScope.launch {
</a><a href="#h25-2-33" id="h25-2-33" class="d">-                    val username = runCatching {
</a><a href="#h25-2-34" id="h25-2-34" class="d">-                        messaging.fetchSnapchatterInfos(listOf(posterUserId)).firstOrNull()
</a><a href="#h25-2-35" id="h25-2-35" class="d">-                    }.onFailure {
</a><a href="#h25-2-36" id="h25-2-36" class="d">-                        context.log.error(&quot;Failed to fetch snapchatter info for user $posterUserId&quot;, it)
</a><a href="#h25-2-37" id="h25-2-37" class="d">-                    }.getOrNull()?.username ?: return@launch
</a><a href="#h25-2-38" id="h25-2-38" class="i">+                    context.coroutineScope.launch {
</a><a href="#h25-2-39" id="h25-2-39" class="i">+                        val username = runCatching {
</a><a href="#h25-2-40" id="h25-2-40" class="i">+                            messaging.fetchSnapchatterInfos(listOf(posterUserId)).firstOrNull()
</a><a href="#h25-2-41" id="h25-2-41" class="i">+                        }.onFailure {
</a><a href="#h25-2-42" id="h25-2-42" class="i">+                            context.log.error(&quot;Failed to fetch snapchatter info for user $posterUserId&quot;, it)
</a><a href="#h25-2-43" id="h25-2-43" class="i">+                        }.getOrNull()?.username ?: return@launch
</a> 
<a href="#h25-2-45" id="h25-2-45" class="d">-                    withContext(Dispatchers.Main) {
</a><a href="#h25-2-46" id="h25-2-46" class="d">-                        setUsername(username)
</a><a href="#h25-2-47" id="h25-2-47" class="i">+                        withContext(Dispatchers.Main) {
</a><a href="#h25-2-48" id="h25-2-48" class="i">+                            setUsername(username)
</a><a href="#h25-2-49" id="h25-2-49" class="i">+                        }
</a>                     }
                 }
             }
<b>diff --git a/<a id="h26" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/StealthModeIndicator.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/StealthModeIndicator.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/StealthModeIndicator.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/StealthModeIndicator.kt</a></b>
<a href="#h26-0" id="h26-0" class="h">@@ -52,11 +52,6 @@ class StealthModeIndicator : Feature(&quot;StealthModeIndicator&quot;) {
</a>         if (!context.config.userInterface.stealthModeIndicator.get()) return
 
         onNextActivityCreate {
<a href="#h26-0-3" id="h26-0-3" class="d">-            val secondaryTextSize = context.resources.getDimens(&quot;ff_feed_cell_secondary_text_size&quot;).toFloat()
</a><a href="#h26-0-4" id="h26-0-4" class="d">-            val sigColorTextPrimary = context.mainActivity!!.obtainStyledAttributes(
</a><a href="#h26-0-5" id="h26-0-5" class="d">-                intArrayOf(context.resources.getIdentifier(&quot;sigColorTextPrimary&quot;, &quot;attr&quot;))
</a><a href="#h26-0-6" id="h26-0-6" class="d">-            ).use { it.getColor(0, 0) }
</a><a href="#h26-0-7" id="h26-0-7" class="d">-
</a>             stealthMode.addStateListener { conversationId, state -&gt;
                 runCatching {
                     listeners[conversationId]?.invoke(stealthMode.getRuleState()?.let { if (it == RuleState.BLACKLIST) !state else state } ?: state)
<a href="#h26-1" id="h26-1" class="h">@@ -71,8 +66,9 @@ class StealthModeIndicator : Feature(&quot;StealthModeIndicator&quot;) {
</a>                     if (!isStealth || !event.view.isAttachedToWindow) return
                     event.view.addForegroundDrawable(&quot;stealthModeIndicator&quot;, ShapeDrawable(object : Shape() {
                         override fun draw(canvas: Canvas, paint: Paint) {
<a href="#h26-1-3" id="h26-1-3" class="i">+                            val secondaryTextSize = context.userInterface.dpToPx(10).toFloat()
</a>                             paint.textSize = secondaryTextSize
<a href="#h26-1-5" id="h26-1-5" class="d">-                            paint.color = sigColorTextPrimary
</a><a href="#h26-1-6" id="h26-1-6" class="i">+                            paint.color = context.userInterface.colorPrimary
</a>                             canvas.drawText(
                                 &quot;\uD83D\uDC7B&quot;,
                                 0f,
<b>diff --git a/<a id="h27" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/UITweaks.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/UITweaks.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/UITweaks.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/features/impl/ui/UITweaks.kt</a></b>
<a href="#h27-0" id="h27-0" class="h">@@ -3,20 +3,35 @@ package me.rhunk.snapenhance.core.features.impl.ui
</a> import android.content.res.Resources
 import android.util.Size
 import android.view.View
<a href="#h27-0-3" id="h27-0-3" class="i">+import android.view.ViewGroup
</a> import android.view.ViewGroup.MarginLayoutParams
 import android.widget.FrameLayout
<a href="#h27-0-6" id="h27-0-6" class="i">+import android.widget.LinearLayout
</a> import me.rhunk.snapenhance.common.util.ktx.findFieldsToString
 import me.rhunk.snapenhance.core.event.events.impl.AddViewEvent
 import me.rhunk.snapenhance.core.event.events.impl.BindViewEvent
<a href="#h27-0-10" id="h27-0-10" class="d">-import me.rhunk.snapenhance.core.event.events.impl.LayoutInflateEvent
</a> import me.rhunk.snapenhance.core.features.Feature
<a href="#h27-0-12" id="h27-0-12" class="d">-import me.rhunk.snapenhance.core.ui.getComposerContext
</a><a href="#h27-0-13" id="h27-0-13" class="i">+import me.rhunk.snapenhance.core.ui.*
</a> import me.rhunk.snapenhance.core.util.dataBuilder
 import me.rhunk.snapenhance.core.util.hook.HookStage
 import me.rhunk.snapenhance.core.util.hook.Hooker
 import me.rhunk.snapenhance.core.util.hook.hook
 import me.rhunk.snapenhance.core.util.ktx.getIdentifier
 
<a href="#h27-0-20" id="h27-0-20" class="i">+fun getChatInputBar(event: AddViewEvent): Lazy&lt;ViewGroup?&gt;? {
</a><a href="#h27-0-21" id="h27-0-21" class="i">+    if (!event.parent.javaClass.name.endsWith(&quot;ChatInputLayout&quot;) || !event.viewClassName.endsWith(&quot;ViewSwitcher&quot;)) return null
</a><a href="#h27-0-22" id="h27-0-22" class="i">+
</a><a href="#h27-0-23" id="h27-0-23" class="i">+    return lazy {
</a><a href="#h27-0-24" id="h27-0-24" class="i">+        // get the first linear layout in the view switcher
</a><a href="#h27-0-25" id="h27-0-25" class="i">+        val firstLinearLayout = (event.view as ViewGroup).children()
</a><a href="#h27-0-26" id="h27-0-26" class="i">+            .firstOrNull { it is LinearLayout } as? ViewGroup ?: return@lazy null
</a><a href="#h27-0-27" id="h27-0-27" class="i">+        // get the first linear layout with at least 3 children
</a><a href="#h27-0-28" id="h27-0-28" class="i">+        firstLinearLayout.children()
</a><a href="#h27-0-29" id="h27-0-29" class="i">+            .firstOrNull { v -&gt; v is LinearLayout &amp;&amp; v.childCount &gt; 2 } as? LinearLayout
</a><a href="#h27-0-30" id="h27-0-30" class="i">+            ?: return@lazy null
</a><a href="#h27-0-31" id="h27-0-31" class="i">+    }
</a><a href="#h27-0-32" id="h27-0-32" class="i">+}
</a><a href="#h27-0-33" id="h27-0-33" class="i">+
</a> class UITweaks : Feature(&quot;UITweaks&quot;) {
     private val identifierCache = mutableMapOf&lt;String, Int&gt;()
 
<a href="#h27-1" id="h27-1" class="h">@@ -57,28 +72,10 @@ class UITweaks : Feature(&quot;UITweaks&quot;) {
</a>         val displayMetrics = context.resources.displayMetrics
         val deviceAspectRatio = displayMetrics.widthPixels.toFloat() / displayMetrics.heightPixels.toFloat()
 
<a href="#h27-1-3" id="h27-1-3" class="d">-        val callButtonsStub = getId(&quot;call_buttons_stub&quot;, &quot;id&quot;)
</a><a href="#h27-1-4" id="h27-1-4" class="d">-        val callButton1 = getId(&quot;friend_action_button3&quot;, &quot;id&quot;)
</a><a href="#h27-1-5" id="h27-1-5" class="d">-        val callButton2 = getId(&quot;friend_action_button4&quot;, &quot;id&quot;)
</a><a href="#h27-1-6" id="h27-1-6" class="d">-
</a>         val chatNoteRecordButton = getId(&quot;chat_note_record_button&quot;, &quot;id&quot;)
         val unreadHintButton = getId(&quot;unread_hint_button&quot;, &quot;id&quot;)
         val friendCardFrame = getId(&quot;friend_card_frame&quot;, &quot;id&quot;)
 
<a href="#h27-1-11" id="h27-1-11" class="d">-        View::class.java.hook(&quot;setVisibility&quot;, HookStage.BEFORE) { methodParam -&gt;
</a><a href="#h27-1-12" id="h27-1-12" class="d">-            val viewId = (methodParam.thisObject() as View).id
</a><a href="#h27-1-13" id="h27-1-13" class="d">-            if (viewId == callButton1 || viewId == callButton2) {
</a><a href="#h27-1-14" id="h27-1-14" class="d">-                if (!hiddenElements.contains(&quot;hide_profile_call_buttons&quot;)) return@hook
</a><a href="#h27-1-15" id="h27-1-15" class="d">-                methodParam.setArg(0, View.GONE)
</a><a href="#h27-1-16" id="h27-1-16" class="d">-            }
</a><a href="#h27-1-17" id="h27-1-17" class="d">-        }
</a><a href="#h27-1-18" id="h27-1-18" class="d">-
</a><a href="#h27-1-19" id="h27-1-19" class="d">-        context.event.subscribe(LayoutInflateEvent::class) { event -&gt;
</a><a href="#h27-1-20" id="h27-1-20" class="d">-            if (event.layoutId == getId(&quot;chat_input_bar_sharing_drawer_button&quot;, &quot;layout&quot;) &amp;&amp; hiddenElements.contains(&quot;hide_live_location_share_button&quot;)) {
</a><a href="#h27-1-21" id="h27-1-21" class="d">-                hideView(event.view ?: return@subscribe)
</a><a href="#h27-1-22" id="h27-1-22" class="d">-            }
</a><a href="#h27-1-23" id="h27-1-23" class="d">-        }
</a><a href="#h27-1-24" id="h27-1-24" class="d">-
</a>         Resources::class.java.methods.first { it.name == &quot;getDimensionPixelSize&quot;}.hook(
             HookStage.AFTER,
             { isImmersiveCamera }
<a href="#h27-2" id="h27-2" class="h">@@ -92,22 +89,24 @@ class UITweaks : Feature(&quot;UITweaks&quot;) {
</a> 
         var friendCardFrameSize: Size? = null
 
<a href="#h27-2-3" id="h27-2-3" class="d">-        val fourDp by lazy {
</a><a href="#h27-2-4" id="h27-2-4" class="d">-            (4 * context.androidContext.resources.displayMetrics.density).toInt()
</a><a href="#h27-2-5" id="h27-2-5" class="d">-        }
</a><a href="#h27-2-6" id="h27-2-6" class="d">-
</a>         context.event.subscribe(BindViewEvent::class, { hideStorySuggestions.isNotEmpty() }) { event -&gt;
             if (event.view is FrameLayout) {
<a href="#h27-2-9" id="h27-2-9" class="i">+                fun removeView() {
</a><a href="#h27-2-10" id="h27-2-10" class="i">+                    event.view.layoutParams = event.view.layoutParams?.apply {
</a><a href="#h27-2-11" id="h27-2-11" class="i">+                        width = 0; height = 0
</a><a href="#h27-2-12" id="h27-2-12" class="i">+                    } ?: return
</a><a href="#h27-2-13" id="h27-2-13" class="i">+                }
</a><a href="#h27-2-14" id="h27-2-14" class="i">+
</a>                 val viewModelString = event.prevModel.toString()
                 val isSuggestedFriend by lazy { viewModelString.startsWith(&quot;DFFriendSuggestionCardViewModel&quot;) }
                 val isMyStory by lazy { viewModelString.let { it.startsWith(&quot;CircularItemViewModel&quot;) &amp;&amp; it.contains(&quot;storyId=&quot;)} }
 
<a href="#h27-2-19" id="h27-2-19" class="d">-                if ((hideStorySuggestions.contains(&quot;hide_friend_suggestions&quot;) &amp;&amp; isSuggestedFriend) ||
</a><a href="#h27-2-20" id="h27-2-20" class="d">-                    (hideStorySuggestions.contains(&quot;hide_my_stories&quot;) &amp;&amp; isMyStory)) {
</a><a href="#h27-2-21" id="h27-2-21" class="d">-                    event.view.layoutParams.apply {
</a><a href="#h27-2-22" id="h27-2-22" class="d">-                        width = 0; height = 0
</a><a href="#h27-2-23" id="h27-2-23" class="d">-                        if (this is MarginLayoutParams) setMargins(-fourDp, 0, -fourDp, 0)
</a><a href="#h27-2-24" id="h27-2-24" class="d">-                    }
</a><a href="#h27-2-25" id="h27-2-25" class="i">+                if (hideStorySuggestions.contains(&quot;hide_friend_suggestions&quot;) &amp;&amp; isSuggestedFriend) {
</a><a href="#h27-2-26" id="h27-2-26" class="i">+                    removeView()
</a><a href="#h27-2-27" id="h27-2-27" class="i">+                    return@subscribe
</a><a href="#h27-2-28" id="h27-2-28" class="i">+                }
</a><a href="#h27-2-29" id="h27-2-29" class="i">+                if (hideStorySuggestions.contains(&quot;hide_my_stories&quot;) &amp;&amp; isMyStory) {
</a><a href="#h27-2-30" id="h27-2-30" class="i">+                    removeView()
</a>                     return@subscribe
                 }
             }
<a href="#h27-3" id="h27-3" class="h">@@ -167,19 +166,59 @@ class UITweaks : Feature(&quot;UITweaks&quot;) {
</a>                 }
             }
 
<a href="#h27-3-3" id="h27-3-3" class="d">-            if (event.parent.id == getId(&quot;map_reactions_layout&quot;, &quot;id&quot;) &amp;&amp; hiddenElements.contains(&quot;hide_map_reactions&quot;)) {
</a><a href="#h27-3-4" id="h27-3-4" class="d">-                hideView(view)
</a><a href="#h27-3-5" id="h27-3-5" class="i">+            if (event.parent.javaClass.name.endsWith(&quot;ConstraintLayout&quot;) &amp;&amp; event.view is LinearLayout &amp;&amp; hiddenElements.contains(&quot;hide_map_reactions&quot;)) {
</a><a href="#h27-3-6" id="h27-3-6" class="i">+                val viewGroup = event.view as ViewGroup
</a><a href="#h27-3-7" id="h27-3-7" class="i">+                val children = viewGroup.children()
</a><a href="#h27-3-8" id="h27-3-8" class="i">+
</a><a href="#h27-3-9" id="h27-3-9" class="i">+                // hide image views in the reaction bar
</a><a href="#h27-3-10" id="h27-3-10" class="i">+                if (children.takeIf { it.count() == 5 }?.all { it.javaClass.name.endsWith(&quot;SnapImageView&quot;) } == true) {
</a><a href="#h27-3-11" id="h27-3-11" class="i">+                    children.forEach { imageView -&gt;
</a><a href="#h27-3-12" id="h27-3-12" class="i">+                        imageView.hideViewCompletely()
</a><a href="#h27-3-13" id="h27-3-13" class="i">+                    }
</a><a href="#h27-3-14" id="h27-3-14" class="i">+                }
</a><a href="#h27-3-15" id="h27-3-15" class="i">+            }
</a><a href="#h27-3-16" id="h27-3-16" class="i">+
</a><a href="#h27-3-17" id="h27-3-17" class="i">+            if (event.parent.javaClass.name.endsWith(&quot;PreviewBottomToolbarView&quot;) &amp;&amp; hiddenElements.contains(&quot;hide_post_to_story_buttons&quot;)) {
</a><a href="#h27-3-18" id="h27-3-18" class="i">+                if (event.parent.childCount == 1) {
</a><a href="#h27-3-19" id="h27-3-19" class="i">+                    event.view.hideViewCompletely()
</a><a href="#h27-3-20" id="h27-3-20" class="i">+                }
</a><a href="#h27-3-21" id="h27-3-21" class="i">+            }
</a><a href="#h27-3-22" id="h27-3-22" class="i">+
</a><a href="#h27-3-23" id="h27-3-23" class="i">+            if (viewId == getId(&quot;send_btn&quot;, &quot;id&quot;) &amp;&amp; hiddenElements.contains(&quot;hide_post_to_story_buttons&quot;)) {
</a><a href="#h27-3-24" id="h27-3-24" class="i">+                // hide previous view
</a><a href="#h27-3-25" id="h27-3-25" class="i">+                if (event.parent.childCount &gt; 0) {
</a><a href="#h27-3-26" id="h27-3-26" class="i">+                    val lastChild = event.parent.getChildAt(event.parent.childCount - 1)?.takeIf { it is LinearLayout } ?: return@subscribe
</a><a href="#h27-3-27" id="h27-3-27" class="i">+                    context.log.verbose(&quot;Hiding post to story button&quot;)
</a><a href="#h27-3-28" id="h27-3-28" class="i">+                    lastChild.hideViewCompletely()
</a><a href="#h27-3-29" id="h27-3-29" class="i">+                }
</a>             }
 
<a href="#h27-3-32" id="h27-3-32" class="d">-            if (
</a><a href="#h27-3-33" id="h27-3-33" class="d">-                ((viewId == getId(&quot;post_tool&quot;, &quot;id&quot;) || viewId == getId(&quot;story_button&quot;, &quot;id&quot;)) &amp;&amp; hiddenElements.contains(&quot;hide_post_to_story_buttons&quot;)) ||
</a><a href="#h27-3-34" id="h27-3-34" class="d">-                (viewId == chatNoteRecordButton &amp;&amp; hiddenElements.contains(&quot;hide_voice_record_button&quot;)) ||
</a><a href="#h27-3-35" id="h27-3-35" class="d">-                (viewId == getId(&quot;chat_input_bar_sticker&quot;, &quot;id&quot;) &amp;&amp; hiddenElements.contains(&quot;hide_stickers_button&quot;)) ||
</a><a href="#h27-3-36" id="h27-3-36" class="d">-                (viewId == getId(&quot;chat_input_bar_sharing_drawer_button&quot;, &quot;id&quot;) &amp;&amp; hiddenElements.contains(&quot;hide_live_location_share_button&quot;)) ||
</a><a href="#h27-3-37" id="h27-3-37" class="d">-                (viewId == callButtonsStub &amp;&amp; hiddenElements.contains(&quot;hide_chat_call_buttons&quot;))
</a><a href="#h27-3-38" id="h27-3-38" class="d">-            ) {
</a><a href="#h27-3-39" id="h27-3-39" class="d">-                hideView(view)
</a><a href="#h27-3-40" id="h27-3-40" class="i">+            getChatInputBar(event)?.let { lazyChatInputBar -&gt;
</a><a href="#h27-3-41" id="h27-3-41" class="i">+                val chatInputBar by lazyChatInputBar
</a><a href="#h27-3-42" id="h27-3-42" class="i">+
</a><a href="#h27-3-43" id="h27-3-43" class="i">+                if (hiddenElements.contains(&quot;hide_live_location_share_button&quot;)) {
</a><a href="#h27-3-44" id="h27-3-44" class="i">+                    chatInputBar?.onLayoutChange {
</a><a href="#h27-3-45" id="h27-3-45" class="i">+                        chatInputBar!!.children().lastOrNull { it.javaClass.name.endsWith(&quot;AppCompatImageButton&quot;) &amp;&amp; runCatching { it.resources.getResourceName(it.id) }.getOrNull() == null }
</a><a href="#h27-3-46" id="h27-3-46" class="i">+                            ?.hideViewCompletely()
</a><a href="#h27-3-47" id="h27-3-47" class="i">+                    }
</a><a href="#h27-3-48" id="h27-3-48" class="i">+                }
</a><a href="#h27-3-49" id="h27-3-49" class="i">+
</a><a href="#h27-3-50" id="h27-3-50" class="i">+                if (hiddenElements.contains(&quot;hide_stickers_button&quot;)) {
</a><a href="#h27-3-51" id="h27-3-51" class="i">+                    chatInputBar
</a><a href="#h27-3-52" id="h27-3-52" class="i">+                        ?.children()
</a><a href="#h27-3-53" id="h27-3-53" class="i">+                        ?.lastOrNull { layout -&gt;
</a><a href="#h27-3-54" id="h27-3-54" class="i">+                            layout is FrameLayout &amp;&amp; layout.children().all {
</a><a href="#h27-3-55" id="h27-3-55" class="i">+                                it.javaClass.name.endsWith(&quot;SnapImageView&quot;)
</a><a href="#h27-3-56" id="h27-3-56" class="i">+                            }
</a><a href="#h27-3-57" id="h27-3-57" class="i">+                        }
</a><a href="#h27-3-58" id="h27-3-58" class="i">+                        ?.hideViewCompletely()
</a><a href="#h27-3-59" id="h27-3-59" class="i">+                }
</a><a href="#h27-3-60" id="h27-3-60" class="i">+            }
</a><a href="#h27-3-61" id="h27-3-61" class="i">+
</a><a href="#h27-3-62" id="h27-3-62" class="i">+            if (viewId == chatNoteRecordButton &amp;&amp; hiddenElements.contains(&quot;hide_voice_record_button&quot;)) {
</a><a href="#h27-3-63" id="h27-3-63" class="i">+                view.hideViewCompletely()
</a>             }
<a href="#h27-3-65" id="h27-3-65" class="i">+
</a>             if (viewId == unreadHintButton &amp;&amp; hiddenElements.contains(&quot;hide_unread_chat_hint&quot;)) {
                 event.canceled = true
             }
<b>diff --git a/<a id="h28" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/ui/UserInterface.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/UserInterface.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/ui/UserInterface.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/UserInterface.kt</a></b>
<a href="#h28-0" id="h28-0" class="h">@@ -0,0 +1,62 @@
</a><a href="#h28-0-0" id="h28-0-0" class="i">+package me.rhunk.snapenhance.core.ui
</a><a href="#h28-0-1" id="h28-0-1" class="i">+
</a><a href="#h28-0-2" id="h28-0-2" class="i">+import android.content.res.Resources
</a><a href="#h28-0-3" id="h28-0-3" class="i">+import android.graphics.Typeface
</a><a href="#h28-0-4" id="h28-0-4" class="i">+import android.util.TypedValue
</a><a href="#h28-0-5" id="h28-0-5" class="i">+import android.view.Gravity
</a><a href="#h28-0-6" id="h28-0-6" class="i">+import android.widget.TextView
</a><a href="#h28-0-7" id="h28-0-7" class="i">+import me.rhunk.snapenhance.core.ModContext
</a><a href="#h28-0-8" id="h28-0-8" class="i">+import me.rhunk.snapenhance.core.util.hook.HookStage
</a><a href="#h28-0-9" id="h28-0-9" class="i">+import me.rhunk.snapenhance.core.util.hook.hook
</a><a href="#h28-0-10" id="h28-0-10" class="i">+import me.rhunk.snapenhance.core.util.ktx.isDarkTheme
</a><a href="#h28-0-11" id="h28-0-11" class="i">+
</a><a href="#h28-0-12" id="h28-0-12" class="i">+class UserInterface(
</a><a href="#h28-0-13" id="h28-0-13" class="i">+    private val context: ModContext
</a><a href="#h28-0-14" id="h28-0-14" class="i">+) {
</a><a href="#h28-0-15" id="h28-0-15" class="i">+    private val fontMap = mutableMapOf&lt;Int, Int&gt;()
</a><a href="#h28-0-16" id="h28-0-16" class="i">+
</a><a href="#h28-0-17" id="h28-0-17" class="i">+    val colorPrimary get() = if (context.androidContext.isDarkTheme()) 0xfff5f5f5.toInt() else 0xff212121.toInt()
</a><a href="#h28-0-18" id="h28-0-18" class="i">+    val actionSheetBackground get() = if (context.androidContext.isDarkTheme()) 0xff1e1e1e.toInt() else 0xffffffff.toInt()
</a><a href="#h28-0-19" id="h28-0-19" class="i">+
</a><a href="#h28-0-20" id="h28-0-20" class="i">+    val avenirNextTypeface: Typeface by lazy {
</a><a href="#h28-0-21" id="h28-0-21" class="i">+        fontMap[600]?.let { context.resources.getFont(it) } ?: throw IllegalStateException(&quot;Avenir Next not loaded&quot;)
</a><a href="#h28-0-22" id="h28-0-22" class="i">+    }
</a><a href="#h28-0-23" id="h28-0-23" class="i">+
</a><a href="#h28-0-24" id="h28-0-24" class="i">+    fun dpToPx(dp: Int): Int {
</a><a href="#h28-0-25" id="h28-0-25" class="i">+        return (dp * context.resources.displayMetrics.density).toInt()
</a><a href="#h28-0-26" id="h28-0-26" class="i">+    }
</a><a href="#h28-0-27" id="h28-0-27" class="i">+
</a><a href="#h28-0-28" id="h28-0-28" class="i">+    @Suppress(&quot;unused&quot;)
</a><a href="#h28-0-29" id="h28-0-29" class="i">+    fun pxToDp(px: Int): Int {
</a><a href="#h28-0-30" id="h28-0-30" class="i">+        return (px / context.resources.displayMetrics.density).toInt()
</a><a href="#h28-0-31" id="h28-0-31" class="i">+    }
</a><a href="#h28-0-32" id="h28-0-32" class="i">+
</a><a href="#h28-0-33" id="h28-0-33" class="i">+    fun getFontResource(weight: Int): Int? {
</a><a href="#h28-0-34" id="h28-0-34" class="i">+        return fontMap[weight]
</a><a href="#h28-0-35" id="h28-0-35" class="i">+    }
</a><a href="#h28-0-36" id="h28-0-36" class="i">+
</a><a href="#h28-0-37" id="h28-0-37" class="i">+    fun applyActionButtonTheme(view: TextView) {
</a><a href="#h28-0-38" id="h28-0-38" class="i">+        view.apply {
</a><a href="#h28-0-39" id="h28-0-39" class="i">+            setTextColor(colorPrimary)
</a><a href="#h28-0-40" id="h28-0-40" class="i">+            typeface = avenirNextTypeface
</a><a href="#h28-0-41" id="h28-0-41" class="i">+            setShadowLayer(0F, 0F, 0F, 0)
</a><a href="#h28-0-42" id="h28-0-42" class="i">+            gravity = Gravity.CENTER_VERTICAL
</a><a href="#h28-0-43" id="h28-0-43" class="i">+            isAllCaps = false
</a><a href="#h28-0-44" id="h28-0-44" class="i">+            textSize = 16f
</a><a href="#h28-0-45" id="h28-0-45" class="i">+            outlineProvider = null
</a><a href="#h28-0-46" id="h28-0-46" class="i">+            setPadding(dpToPx(12),  dpToPx(15), 0, dpToPx(15))
</a><a href="#h28-0-47" id="h28-0-47" class="i">+            setBackgroundColor(0)
</a><a href="#h28-0-48" id="h28-0-48" class="i">+        }
</a><a href="#h28-0-49" id="h28-0-49" class="i">+    }
</a><a href="#h28-0-50" id="h28-0-50" class="i">+
</a><a href="#h28-0-51" id="h28-0-51" class="i">+    fun init() {
</a><a href="#h28-0-52" id="h28-0-52" class="i">+        Resources::class.java.hook(&quot;getValue&quot;, HookStage.AFTER) { param -&gt;
</a><a href="#h28-0-53" id="h28-0-53" class="i">+            val typedValue = param.arg&lt;TypedValue&gt;(1)
</a><a href="#h28-0-54" id="h28-0-54" class="i">+            val path = typedValue.string ?: return@hook
</a><a href="#h28-0-55" id="h28-0-55" class="i">+            if (!path.startsWith(&quot;res/&quot;) || !path.endsWith(&quot;.ttf&quot;)) return@hook
</a><a href="#h28-0-56" id="h28-0-56" class="i">+
</a><a href="#h28-0-57" id="h28-0-57" class="i">+            val typeface = context.resources.getFont(typedValue.resourceId)
</a><a href="#h28-0-58" id="h28-0-58" class="i">+            fontMap.getOrPut(typeface.weight) { typedValue.resourceId }
</a><a href="#h28-0-59" id="h28-0-59" class="i">+        }
</a><a href="#h28-0-60" id="h28-0-60" class="i">+    }
</a><a href="#h28-0-61" id="h28-0-61" class="i">+}</a><a href="#h28-0-62" id="h28-0-62" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h29" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/ui/ViewAppearanceHelper.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/ViewAppearanceHelper.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/ui/ViewAppearanceHelper.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/ViewAppearanceHelper.kt</a></b>
<a href="#h29-0" id="h29-0" class="h">@@ -3,34 +3,19 @@ package me.rhunk.snapenhance.core.ui
</a> import android.app.Activity
 import android.app.AlertDialog
 import android.content.Context
<a href="#h29-0-3" id="h29-0-3" class="d">-import android.content.res.ColorStateList
</a> import android.graphics.Canvas
<a href="#h29-0-5" id="h29-0-5" class="d">-import android.graphics.Color
</a> import android.graphics.Paint
<a href="#h29-0-7" id="h29-0-7" class="d">-import android.graphics.drawable.ColorDrawable
</a> import android.graphics.drawable.Drawable
 import android.graphics.drawable.ShapeDrawable
<a href="#h29-0-10" id="h29-0-10" class="d">-import android.graphics.drawable.StateListDrawable
</a> import android.graphics.drawable.shapes.Shape
 import android.os.SystemClock
<a href="#h29-0-13" id="h29-0-13" class="d">-import android.view.Gravity
</a> import android.view.MotionEvent
 import android.view.View
 import android.view.ViewGroup
<a href="#h29-0-17" id="h29-0-17" class="d">-import android.widget.Switch
</a><a href="#h29-0-18" id="h29-0-18" class="d">-import android.widget.TextView
</a><a href="#h29-0-19" id="h29-0-19" class="d">-import androidx.core.content.res.use
</a> import me.rhunk.snapenhance.core.SnapEnhance
<a href="#h29-0-21" id="h29-0-21" class="d">-import me.rhunk.snapenhance.core.util.ktx.getDimens
</a><a href="#h29-0-22" id="h29-0-22" class="d">-import me.rhunk.snapenhance.core.util.ktx.getDimensFloat
</a><a href="#h29-0-23" id="h29-0-23" class="d">-import me.rhunk.snapenhance.core.util.ktx.getIdentifier
</a> import me.rhunk.snapenhance.core.wrapper.impl.composer.ComposerContext
 import me.rhunk.snapenhance.core.wrapper.impl.composer.ComposerViewNode
 
<a href="#h29-0-27" id="h29-0-27" class="d">-fun View.applyTheme(componentWidth: Int? = null, hasRadius: Boolean = false, isAmoled: Boolean = true) {
</a><a href="#h29-0-28" id="h29-0-28" class="d">-    ViewAppearanceHelper.applyTheme(this, componentWidth, hasRadius, isAmoled)
</a><a href="#h29-0-29" id="h29-0-29" class="d">-}
</a><a href="#h29-0-30" id="h29-0-30" class="d">-
</a> private val foregroundDrawableListTag = randomTag()
 
 @Suppress(&quot;UNCHECKED_CAST&quot;)
<a href="#h29-1" id="h29-1" class="h">@@ -106,6 +91,51 @@ fun View.findParent(maxIteration: Int = Int.MAX_VALUE, predicate: (View) -&gt; Bool
</a> }
 
 
<a href="#h29-1-3" id="h29-1-3" class="i">+data class LayoutChangeParams(
</a><a href="#h29-1-4" id="h29-1-4" class="i">+    val view: View,
</a><a href="#h29-1-5" id="h29-1-5" class="i">+    val left: Int,
</a><a href="#h29-1-6" id="h29-1-6" class="i">+    val top: Int,
</a><a href="#h29-1-7" id="h29-1-7" class="i">+    val right: Int,
</a><a href="#h29-1-8" id="h29-1-8" class="i">+    val bottom: Int,
</a><a href="#h29-1-9" id="h29-1-9" class="i">+    val oldLeft: Int,
</a><a href="#h29-1-10" id="h29-1-10" class="i">+    val oldTop: Int,
</a><a href="#h29-1-11" id="h29-1-11" class="i">+    val oldRight: Int,
</a><a href="#h29-1-12" id="h29-1-12" class="i">+    val oldBottom: Int
</a><a href="#h29-1-13" id="h29-1-13" class="i">+)
</a><a href="#h29-1-14" id="h29-1-14" class="i">+
</a><a href="#h29-1-15" id="h29-1-15" class="i">+fun View.onLayoutChange(block: (LayoutChangeParams) -&gt; Unit): View.OnLayoutChangeListener {
</a><a href="#h29-1-16" id="h29-1-16" class="i">+    return View.OnLayoutChangeListener  { view, left, top, right, bottom, oldLeft, oldTop, oldRight, oldBottom -&gt;
</a><a href="#h29-1-17" id="h29-1-17" class="i">+        block(LayoutChangeParams(view, left, top, right, bottom, oldLeft, oldTop, oldRight, oldBottom))
</a><a href="#h29-1-18" id="h29-1-18" class="i">+    }.also { addOnLayoutChangeListener (it) }
</a><a href="#h29-1-19" id="h29-1-19" class="i">+}
</a><a href="#h29-1-20" id="h29-1-20" class="i">+
</a><a href="#h29-1-21" id="h29-1-21" class="i">+fun View.onAttachChange(onAttach: (View.OnAttachStateChangeListener) -&gt; Unit = {}, onDetach: (View.OnAttachStateChangeListener) -&gt; Unit = {}): View.OnAttachStateChangeListener {
</a><a href="#h29-1-22" id="h29-1-22" class="i">+    return object : View.OnAttachStateChangeListener {
</a><a href="#h29-1-23" id="h29-1-23" class="i">+        override fun onViewAttachedToWindow(v: View) {
</a><a href="#h29-1-24" id="h29-1-24" class="i">+            onAttach(this)
</a><a href="#h29-1-25" id="h29-1-25" class="i">+        }
</a><a href="#h29-1-26" id="h29-1-26" class="i">+        override fun onViewDetachedFromWindow(v: View) {
</a><a href="#h29-1-27" id="h29-1-27" class="i">+            onDetach(this)
</a><a href="#h29-1-28" id="h29-1-28" class="i">+        }
</a><a href="#h29-1-29" id="h29-1-29" class="i">+    }.also { addOnAttachStateChangeListener(it) }
</a><a href="#h29-1-30" id="h29-1-30" class="i">+}
</a><a href="#h29-1-31" id="h29-1-31" class="i">+
</a><a href="#h29-1-32" id="h29-1-32" class="i">+fun View.hideViewCompletely() {
</a><a href="#h29-1-33" id="h29-1-33" class="i">+    fun hide() {
</a><a href="#h29-1-34" id="h29-1-34" class="i">+        isEnabled = false
</a><a href="#h29-1-35" id="h29-1-35" class="i">+        visibility = View.GONE
</a><a href="#h29-1-36" id="h29-1-36" class="i">+        setWillNotDraw(true)
</a><a href="#h29-1-37" id="h29-1-37" class="i">+
</a><a href="#h29-1-38" id="h29-1-38" class="i">+        layoutParams = layoutParams?.apply {
</a><a href="#h29-1-39" id="h29-1-39" class="i">+            width = 0
</a><a href="#h29-1-40" id="h29-1-40" class="i">+            height = 0
</a><a href="#h29-1-41" id="h29-1-41" class="i">+        } ?: return
</a><a href="#h29-1-42" id="h29-1-42" class="i">+    }
</a><a href="#h29-1-43" id="h29-1-43" class="i">+    hide()
</a><a href="#h29-1-44" id="h29-1-44" class="i">+    post { hide() }
</a><a href="#h29-1-45" id="h29-1-45" class="i">+    onLayoutChange { hide() }
</a><a href="#h29-1-46" id="h29-1-46" class="i">+}
</a><a href="#h29-1-47" id="h29-1-47" class="i">+
</a> fun View.getComposerViewNode(): ComposerViewNode? {
     if (!SnapEnhance.classCache.composerView.isInstance(this)) return null
 
<a href="#h29-2" id="h29-2" class="h">@@ -125,74 +155,5 @@ fun View.getComposerContext(): ComposerContext? {
</a> }
 
 object ViewAppearanceHelper {
<a href="#h29-2-3" id="h29-2-3" class="d">-    private fun createRoundedBackground(color: Int, radius: Float, hasRadius: Boolean): Drawable {
</a><a href="#h29-2-4" id="h29-2-4" class="d">-        if (!hasRadius) return ColorDrawable(color)
</a><a href="#h29-2-5" id="h29-2-5" class="d">-        return ShapeDrawable().apply {
</a><a href="#h29-2-6" id="h29-2-6" class="d">-            paint.color = color
</a><a href="#h29-2-7" id="h29-2-7" class="d">-            shape = android.graphics.drawable.shapes.RoundRectShape(
</a><a href="#h29-2-8" id="h29-2-8" class="d">-                floatArrayOf(radius, radius, radius, radius, radius, radius, radius, radius),
</a><a href="#h29-2-9" id="h29-2-9" class="d">-                null,
</a><a href="#h29-2-10" id="h29-2-10" class="d">-                null
</a><a href="#h29-2-11" id="h29-2-11" class="d">-            )
</a><a href="#h29-2-12" id="h29-2-12" class="d">-        }
</a><a href="#h29-2-13" id="h29-2-13" class="d">-    }
</a><a href="#h29-2-14" id="h29-2-14" class="d">-
</a><a href="#h29-2-15" id="h29-2-15" class="d">-    fun applyTheme(component: View, componentWidth: Int? = null, hasRadius: Boolean = false, isAmoled: Boolean = true) {
</a><a href="#h29-2-16" id="h29-2-16" class="d">-        val resources = component.context.resources
</a><a href="#h29-2-17" id="h29-2-17" class="d">-        val actionSheetCellHorizontalPadding = resources.getDimens(&quot;action_sheet_cell_horizontal_padding&quot;)
</a><a href="#h29-2-18" id="h29-2-18" class="d">-        val v11ActionCellVerticalPadding = resources.getDimens(&quot;v11_action_cell_vertical_padding&quot;)
</a><a href="#h29-2-19" id="h29-2-19" class="d">-
</a><a href="#h29-2-20" id="h29-2-20" class="d">-        val sigColorTextPrimary = component.context.theme.obtainStyledAttributes(
</a><a href="#h29-2-21" id="h29-2-21" class="d">-            intArrayOf(resources.getIdentifier(&quot;sigColorTextPrimary&quot;, &quot;attr&quot;))
</a><a href="#h29-2-22" id="h29-2-22" class="d">-        ).use { it.getColor(0, 0) }
</a><a href="#h29-2-23" id="h29-2-23" class="d">-        val sigColorBackgroundSurface = component.context.theme.obtainStyledAttributes(
</a><a href="#h29-2-24" id="h29-2-24" class="d">-            intArrayOf(resources.getIdentifier(&quot;sigColorBackgroundSurface&quot;, &quot;attr&quot;))
</a><a href="#h29-2-25" id="h29-2-25" class="d">-        ).use { it.getColor(0, 0) }
</a><a href="#h29-2-26" id="h29-2-26" class="d">-
</a><a href="#h29-2-27" id="h29-2-27" class="d">-        val actionSheetDefaultCellHeight = resources.getDimens(&quot;action_sheet_default_cell_height&quot;)
</a><a href="#h29-2-28" id="h29-2-28" class="d">-        val actionSheetCornerRadius = resources.getDimensFloat(&quot;action_sheet_corner_radius&quot;)
</a><a href="#h29-2-29" id="h29-2-29" class="d">-        val snapchatFontResId = resources.getIdentifier(&quot;avenir_next_medium&quot;, &quot;font&quot;)
</a><a href="#h29-2-30" id="h29-2-30" class="d">-
</a><a href="#h29-2-31" id="h29-2-31" class="d">-        (component as? TextView)?.apply {
</a><a href="#h29-2-32" id="h29-2-32" class="d">-            setTextColor(sigColorTextPrimary)
</a><a href="#h29-2-33" id="h29-2-33" class="d">-            setShadowLayer(0F, 0F, 0F, 0)
</a><a href="#h29-2-34" id="h29-2-34" class="d">-            gravity = Gravity.CENTER_VERTICAL
</a><a href="#h29-2-35" id="h29-2-35" class="d">-            componentWidth?.let { width = it}
</a><a href="#h29-2-36" id="h29-2-36" class="d">-            isAllCaps = false
</a><a href="#h29-2-37" id="h29-2-37" class="d">-            minimumHeight = actionSheetDefaultCellHeight
</a><a href="#h29-2-38" id="h29-2-38" class="d">-            textSize = 16f
</a><a href="#h29-2-39" id="h29-2-39" class="d">-            typeface = resources.getFont(snapchatFontResId)
</a><a href="#h29-2-40" id="h29-2-40" class="d">-            outlineProvider = null
</a><a href="#h29-2-41" id="h29-2-41" class="d">-            setPadding(actionSheetCellHorizontalPadding, v11ActionCellVerticalPadding, actionSheetCellHorizontalPadding, v11ActionCellVerticalPadding)
</a><a href="#h29-2-42" id="h29-2-42" class="d">-        }
</a><a href="#h29-2-43" id="h29-2-43" class="d">-
</a><a href="#h29-2-44" id="h29-2-44" class="d">-        if (isAmoled) {
</a><a href="#h29-2-45" id="h29-2-45" class="d">-            component.background = StateListDrawable().apply {
</a><a href="#h29-2-46" id="h29-2-46" class="d">-                addState(intArrayOf(), createRoundedBackground(color = sigColorBackgroundSurface, radius = actionSheetCornerRadius, hasRadius))
</a><a href="#h29-2-47" id="h29-2-47" class="d">-                addState(intArrayOf(android.R.attr.state_pressed), createRoundedBackground(color = 0x5395026, radius = actionSheetCornerRadius, hasRadius))
</a><a href="#h29-2-48" id="h29-2-48" class="d">-            }
</a><a href="#h29-2-49" id="h29-2-49" class="d">-        } else {
</a><a href="#h29-2-50" id="h29-2-50" class="d">-            component.setBackgroundColor(0x0)
</a><a href="#h29-2-51" id="h29-2-51" class="d">-        }
</a><a href="#h29-2-52" id="h29-2-52" class="d">-
</a><a href="#h29-2-53" id="h29-2-53" class="d">-        (component as? Switch)?.apply {
</a><a href="#h29-2-54" id="h29-2-54" class="d">-            switchMinWidth = resources.getDimens(&quot;v11_switch_min_width&quot;)
</a><a href="#h29-2-55" id="h29-2-55" class="d">-            trackTintList = ColorStateList(
</a><a href="#h29-2-56" id="h29-2-56" class="d">-                arrayOf(intArrayOf(-android.R.attr.state_checked), intArrayOf(android.R.attr.state_checked)
</a><a href="#h29-2-57" id="h29-2-57" class="d">-                ), intArrayOf(
</a><a href="#h29-2-58" id="h29-2-58" class="d">-                    Color.parseColor(&quot;#1d1d1d&quot;),
</a><a href="#h29-2-59" id="h29-2-59" class="d">-                    Color.parseColor(&quot;#26bd49&quot;)
</a><a href="#h29-2-60" id="h29-2-60" class="d">-                )
</a><a href="#h29-2-61" id="h29-2-61" class="d">-            )
</a><a href="#h29-2-62" id="h29-2-62" class="d">-            thumbTintList = ColorStateList(
</a><a href="#h29-2-63" id="h29-2-63" class="d">-                arrayOf(intArrayOf(-android.R.attr.state_checked), intArrayOf(android.R.attr.state_checked)
</a><a href="#h29-2-64" id="h29-2-64" class="d">-                ), intArrayOf(
</a><a href="#h29-2-65" id="h29-2-65" class="d">-                    Color.parseColor(&quot;#F5F5F5&quot;),
</a><a href="#h29-2-66" id="h29-2-66" class="d">-                    Color.parseColor(&quot;#26bd49&quot;)
</a><a href="#h29-2-67" id="h29-2-67" class="d">-                )
</a><a href="#h29-2-68" id="h29-2-68" class="d">-            )
</a><a href="#h29-2-69" id="h29-2-69" class="d">-        }
</a><a href="#h29-2-70" id="h29-2-70" class="d">-    }
</a><a href="#h29-2-71" id="h29-2-71" class="d">-
</a>     fun newAlertDialogBuilder(context: Context?) = AlertDialog.Builder(context, android.R.style.Theme_DeviceDefault_Dialog_Alert)
 }
<b>diff --git a/<a id="h30" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/AbstractMenu.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/AbstractMenu.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/AbstractMenu.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/AbstractMenu.kt</a></b>
<a href="#h30-0" id="h30-0" class="h">@@ -3,12 +3,14 @@ package me.rhunk.snapenhance.core.ui.menu
</a> import android.view.View
 import android.view.ViewGroup
 import me.rhunk.snapenhance.core.ModContext
<a href="#h30-0-3" id="h30-0-3" class="i">+import me.rhunk.snapenhance.core.event.events.impl.AddViewEvent
</a> 
 abstract class AbstractMenu {
     lateinit var menuViewInjector: MenuViewInjector
     lateinit var context: ModContext
 
     open fun inject(parent: ViewGroup, view: View, viewConsumer: (View) -&gt; Unit) {}
<a href="#h30-0-10" id="h30-0-10" class="i">+    open fun onViewAdded(event: AddViewEvent) {}
</a> 
     open fun init() {}
 } 
\ No newline at end of file
<b>diff --git a/<a id="h31" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/MenuViewInjector.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/MenuViewInjector.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/MenuViewInjector.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/MenuViewInjector.kt</a></b>
<a href="#h31-0" id="h31-0" class="h">@@ -1,17 +1,13 @@
</a> package me.rhunk.snapenhance.core.ui.menu
 
 import android.annotation.SuppressLint
<a href="#h31-0-3" id="h31-0-3" class="d">-import android.view.Gravity
</a> import android.view.View
 import android.view.ViewGroup
 import android.widget.FrameLayout
 import android.widget.LinearLayout
<a href="#h31-0-8" id="h31-0-8" class="d">-import android.widget.ScrollView
</a> import me.rhunk.snapenhance.core.event.events.impl.AddViewEvent
 import me.rhunk.snapenhance.core.features.Feature
 import me.rhunk.snapenhance.core.features.impl.COFOverride
<a href="#h31-0-12" id="h31-0-12" class="d">-import me.rhunk.snapenhance.core.features.impl.messaging.Messaging
</a><a href="#h31-0-13" id="h31-0-13" class="d">-import me.rhunk.snapenhance.core.ui.findParent
</a> import me.rhunk.snapenhance.core.ui.menu.impl.*
 import me.rhunk.snapenhance.core.util.ktx.getIdentifier
 import kotlin.reflect.KClass
<a href="#h31-1" id="h31-1" class="h">@@ -20,13 +16,12 @@ import kotlin.reflect.KClass
</a> class MenuViewInjector : Feature(&quot;MenuViewInjector&quot;) {
     private val menuMap by lazy {
         arrayOf(
<a href="#h31-1-3" id="h31-1-3" class="i">+            SettingsMenu(),
</a>             NewChatActionMenu(),
             OperaContextActionMenu(),
             OperaViewerIcons(),
<a href="#h31-1-7" id="h31-1-7" class="d">-            SettingsGearInjector(),
</a>             FriendFeedInfoMenu(),
             ChatActionMenu(),
<a href="#h31-1-10" id="h31-1-10" class="d">-            SettingsMenu()
</a>         ).associateBy {
             it.context = context
             it.menuViewInjector = this
<a href="#h31-2" id="h31-2" class="h">@@ -43,20 +38,14 @@ class MenuViewInjector : Feature(&quot;MenuViewInjector&quot;) {
</a>         onNextActivityCreate(defer = true) {
             menuMap.forEach { it.value.init() }
 
<a href="#h31-2-3" id="h31-2-3" class="d">-            val messaging = context.feature(Messaging::class)
</a><a href="#h31-2-4" id="h31-2-4" class="d">-
</a><a href="#h31-2-5" id="h31-2-5" class="d">-            val actionSheetItemsContainerLayoutId = context.resources.getIdentifier(&quot;action_sheet_items_container&quot;, &quot;id&quot;)
</a><a href="#h31-2-6" id="h31-2-6" class="d">-            val actionMenuTitle = context.resources.getIdentifier(&quot;action_menu_title&quot;, &quot;id&quot;)
</a><a href="#h31-2-7" id="h31-2-7" class="d">-            val actionMenu = context.resources.getIdentifier(&quot;action_menu&quot;, &quot;id&quot;)
</a><a href="#h31-2-8" id="h31-2-8" class="d">-            val componentsHolder = context.resources.getIdentifier(&quot;components_holder&quot;, &quot;id&quot;)
</a><a href="#h31-2-9" id="h31-2-9" class="d">-            val feedNewChat = context.resources.getIdentifier(&quot;feed_new_chat&quot;, &quot;id&quot;)
</a><a href="#h31-2-10" id="h31-2-10" class="d">-            val hovaNavMapIcon = context.resources.getIdentifier(&quot;hova_header_search_icon&quot;, &quot;id&quot;)
</a><a href="#h31-2-11" id="h31-2-11" class="d">-            val contextMenuButtonIconView = context.resources.getIdentifier(&quot;context_menu_button_icon_view&quot;, &quot;id&quot;)
</a>             val chatActionMenu = context.resources.getIdentifier(&quot;chat_action_menu&quot;, &quot;id&quot;)
<a href="#h31-2-13" id="h31-2-13" class="d">-
</a>             val hasV2ActionMenu = { context.feature(COFOverride::class).hasActionMenuV2 }
 
             context.event.subscribe(AddViewEvent::class) { event -&gt;
<a href="#h31-2-17" id="h31-2-17" class="i">+                menuMap.forEach { it.value.onViewAdded(event) }
</a><a href="#h31-2-18" id="h31-2-18" class="i">+            }
</a><a href="#h31-2-19" id="h31-2-19" class="i">+
</a><a href="#h31-2-20" id="h31-2-20" class="i">+            context.event.subscribe(AddViewEvent::class) { event -&gt;
</a>                 val originalAddView: (View) -&gt; Unit = {
                     event.adapter.invokeOriginal(arrayOf(it, -1,
                         FrameLayout.LayoutParams(
<a href="#h31-3" id="h31-3" class="h">@@ -68,30 +57,6 @@ class MenuViewInjector : Feature(&quot;MenuViewInjector&quot;) {
</a> 
                 val viewGroup: ViewGroup = event.parent
                 val childView: View = event.view
<a href="#h31-3-3" id="h31-3-3" class="d">-                menuMap[OperaContextActionMenu::class]!!.inject(viewGroup, childView, originalAddView)
</a><a href="#h31-3-4" id="h31-3-4" class="d">-
</a><a href="#h31-3-5" id="h31-3-5" class="d">-                if (event.view.id == actionSheetItemsContainerLayoutId) {
</a><a href="#h31-3-6" id="h31-3-6" class="d">-                    event.view.post {
</a><a href="#h31-3-7" id="h31-3-7" class="d">-                        if (event.parent.findParent(4) {
</a><a href="#h31-3-8" id="h31-3-8" class="d">-                                it.findViewById&lt;View&gt;(actionMenuTitle) != null
</a><a href="#h31-3-9" id="h31-3-9" class="d">-                            } == null) return@post
</a><a href="#h31-3-10" id="h31-3-10" class="d">-
</a><a href="#h31-3-11" id="h31-3-11" class="d">-                        val views = mutableListOf&lt;View&gt;()
</a><a href="#h31-3-12" id="h31-3-12" class="d">-                        menuMap[FriendFeedInfoMenu::class]?.inject(event.parent, event.view) {
</a><a href="#h31-3-13" id="h31-3-13" class="d">-                            views.add(it)
</a><a href="#h31-3-14" id="h31-3-14" class="d">-                        }
</a><a href="#h31-3-15" id="h31-3-15" class="d">-                        views.reversed().forEach { (event.view as ViewGroup).addView(it, 0) }
</a><a href="#h31-3-16" id="h31-3-16" class="d">-                    }
</a><a href="#h31-3-17" id="h31-3-17" class="d">-                }
</a><a href="#h31-3-18" id="h31-3-18" class="d">-
</a><a href="#h31-3-19" id="h31-3-19" class="d">-                if (childView.id == contextMenuButtonIconView) {
</a><a href="#h31-3-20" id="h31-3-20" class="d">-                    menuMap[OperaViewerIcons::class]!!.inject(viewGroup, childView, originalAddView)
</a><a href="#h31-3-21" id="h31-3-21" class="d">-                }
</a><a href="#h31-3-22" id="h31-3-22" class="d">-
</a><a href="#h31-3-23" id="h31-3-23" class="d">-                if (event.parent.id == componentsHolder &amp;&amp; (childView.id == feedNewChat || childView.id == hovaNavMapIcon)) {
</a><a href="#h31-3-24" id="h31-3-24" class="d">-                    menuMap[SettingsGearInjector::class]!!.inject(viewGroup, childView, originalAddView)
</a><a href="#h31-3-25" id="h31-3-25" class="d">-                    return@subscribe
</a><a href="#h31-3-26" id="h31-3-26" class="d">-                }
</a> 
                 if (viewGroup !is LinearLayout &amp;&amp; childView.id == chatActionMenu &amp;&amp; context.isDeveloper) {
                     event.view = LinearLayout(childView.context).apply {
<a href="#h31-4" id="h31-4" class="h">@@ -113,42 +78,6 @@ class MenuViewInjector : Feature(&quot;MenuViewInjector&quot;) {
</a>                     menuMap[ChatActionMenu::class]!!.inject(viewGroup, childView, originalAddView)
                     return@subscribe
                 }
<a href="#h31-4-3" id="h31-4-3" class="d">-
</a><a href="#h31-4-4" id="h31-4-4" class="d">-                if (viewGroup !is LinearLayout &amp;&amp; childView.id == actionMenu &amp;&amp; messaging.lastFocusedConversationType == 1) {
</a><a href="#h31-4-5" id="h31-4-5" class="d">-                    val injectedLayout = LinearLayout(childView.context).apply {
</a><a href="#h31-4-6" id="h31-4-6" class="d">-                        orientation = LinearLayout.VERTICAL
</a><a href="#h31-4-7" id="h31-4-7" class="d">-                        gravity = Gravity.BOTTOM
</a><a href="#h31-4-8" id="h31-4-8" class="d">-                        layoutParams = ViewGroup.LayoutParams(ViewGroup.LayoutParams.MATCH_PARENT, ViewGroup.LayoutParams.MATCH_PARENT)
</a><a href="#h31-4-9" id="h31-4-9" class="d">-                        addView(childView)
</a><a href="#h31-4-10" id="h31-4-10" class="d">-                    }
</a><a href="#h31-4-11" id="h31-4-11" class="d">-
</a><a href="#h31-4-12" id="h31-4-12" class="d">-                    event.parent.post {
</a><a href="#h31-4-13" id="h31-4-13" class="d">-                        injectedLayout.addView(ScrollView(injectedLayout.context).apply {
</a><a href="#h31-4-14" id="h31-4-14" class="d">-                            layoutParams = LinearLayout.LayoutParams(
</a><a href="#h31-4-15" id="h31-4-15" class="d">-                                ViewGroup.LayoutParams.MATCH_PARENT,
</a><a href="#h31-4-16" id="h31-4-16" class="d">-                                ViewGroup.LayoutParams.WRAP_CONTENT
</a><a href="#h31-4-17" id="h31-4-17" class="d">-                            ).apply {
</a><a href="#h31-4-18" id="h31-4-18" class="d">-                                weight = 1f;
</a><a href="#h31-4-19" id="h31-4-19" class="d">-                                setMargins(0, 100, 0, 0)
</a><a href="#h31-4-20" id="h31-4-20" class="d">-                            }
</a><a href="#h31-4-21" id="h31-4-21" class="d">-
</a><a href="#h31-4-22" id="h31-4-22" class="d">-                            addView(LinearLayout(context).apply {
</a><a href="#h31-4-23" id="h31-4-23" class="d">-                                orientation = LinearLayout.VERTICAL
</a><a href="#h31-4-24" id="h31-4-24" class="d">-                                menuMap[FriendFeedInfoMenu::class]?.inject(event.parent, injectedLayout) { view -&gt;
</a><a href="#h31-4-25" id="h31-4-25" class="d">-                                    view.layoutParams = LinearLayout.LayoutParams(
</a><a href="#h31-4-26" id="h31-4-26" class="d">-                                        ViewGroup.LayoutParams.MATCH_PARENT,
</a><a href="#h31-4-27" id="h31-4-27" class="d">-                                        ViewGroup.LayoutParams.WRAP_CONTENT
</a><a href="#h31-4-28" id="h31-4-28" class="d">-                                    ).apply {
</a><a href="#h31-4-29" id="h31-4-29" class="d">-                                        setMargins(0, 5, 0, 5)
</a><a href="#h31-4-30" id="h31-4-30" class="d">-                                    }
</a><a href="#h31-4-31" id="h31-4-31" class="d">-                                    addView(view)
</a><a href="#h31-4-32" id="h31-4-32" class="d">-                                }
</a><a href="#h31-4-33" id="h31-4-33" class="d">-                            })
</a><a href="#h31-4-34" id="h31-4-34" class="d">-                        }, 0)
</a><a href="#h31-4-35" id="h31-4-35" class="d">-                    }
</a><a href="#h31-4-36" id="h31-4-36" class="d">-
</a><a href="#h31-4-37" id="h31-4-37" class="d">-                    event.view = injectedLayout
</a><a href="#h31-4-38" id="h31-4-38" class="d">-                }
</a>             }
         }
     }
<b>diff --git a/<a id="h32" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/ChatActionMenu.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/ChatActionMenu.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/ChatActionMenu.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/ChatActionMenu.kt</a></b>
<a href="#h32-0" id="h32-0" class="h">@@ -1,5 +1,9 @@
</a> package me.rhunk.snapenhance.core.ui.menu.impl
 
<a href="#h32-0-2" id="h32-0-2" class="i">+import android.graphics.drawable.ColorDrawable
</a><a href="#h32-0-3" id="h32-0-3" class="i">+import android.graphics.drawable.Drawable
</a><a href="#h32-0-4" id="h32-0-4" class="i">+import android.graphics.drawable.ShapeDrawable
</a><a href="#h32-0-5" id="h32-0-5" class="i">+import android.view.Gravity
</a> import android.view.View
 import android.view.ViewGroup
 import android.view.ViewGroup.MarginLayoutParams
<a href="#h32-1" id="h32-1" class="h">@@ -11,31 +15,41 @@ import me.rhunk.snapenhance.core.features.impl.experiments.ConvertMessageLocally
</a> import me.rhunk.snapenhance.core.features.impl.messaging.Messaging
 import me.rhunk.snapenhance.core.features.impl.spying.MessageLogger
 import me.rhunk.snapenhance.core.ui.ViewTagState
<a href="#h32-1-3" id="h32-1-3" class="d">-import me.rhunk.snapenhance.core.ui.applyTheme
</a> import me.rhunk.snapenhance.core.ui.menu.AbstractMenu
 import me.rhunk.snapenhance.core.ui.triggerCloseTouchEvent
 import me.rhunk.snapenhance.core.util.hook.HookStage
 import me.rhunk.snapenhance.core.util.hook.hook
<a href="#h32-1-8" id="h32-1-8" class="d">-import me.rhunk.snapenhance.core.util.ktx.getDimens
</a> import me.rhunk.snapenhance.core.util.ktx.vibrateLongPress
 
 
 class ChatActionMenu : AbstractMenu() {
     private val viewTagState = ViewTagState()
<a href="#h32-1-14" id="h32-1-14" class="d">-    private val defaultGap by lazy { context.resources.getDimens(&quot;default_gap&quot;) }
</a><a href="#h32-1-15" id="h32-1-15" class="d">-    private val chatActionMenuItemMargin by lazy { context.resources.getDimens(&quot;chat_action_menu_item_margin&quot;) }
</a><a href="#h32-1-16" id="h32-1-16" class="d">-    private val actionMenuItemHeight by lazy { context.resources.getDimens(&quot;action_menu_item_height&quot;) }
</a><a href="#h32-1-17" id="h32-1-17" class="i">+    private val defaultGap by lazy { context.userInterface.dpToPx(8) }
</a><a href="#h32-1-18" id="h32-1-18" class="i">+    private val chatActionMenuItemMargin by lazy { context.userInterface.dpToPx(15) }
</a><a href="#h32-1-19" id="h32-1-19" class="i">+    private val actionMenuItemHeight by lazy { context.userInterface.dpToPx(45) }
</a><a href="#h32-1-20" id="h32-1-20" class="i">+
</a><a href="#h32-1-21" id="h32-1-21" class="i">+    private fun createRoundedBackground(color: Int, radius: Float, hasRadius: Boolean): Drawable {
</a><a href="#h32-1-22" id="h32-1-22" class="i">+        if (!hasRadius) return ColorDrawable(color)
</a><a href="#h32-1-23" id="h32-1-23" class="i">+        return ShapeDrawable().apply {
</a><a href="#h32-1-24" id="h32-1-24" class="i">+            paint.color = color
</a><a href="#h32-1-25" id="h32-1-25" class="i">+            shape = android.graphics.drawable.shapes.RoundRectShape(
</a><a href="#h32-1-26" id="h32-1-26" class="i">+                floatArrayOf(radius, radius, radius, radius, radius, radius, radius, radius),
</a><a href="#h32-1-27" id="h32-1-27" class="i">+                null,
</a><a href="#h32-1-28" id="h32-1-28" class="i">+                null
</a><a href="#h32-1-29" id="h32-1-29" class="i">+            )
</a><a href="#h32-1-30" id="h32-1-30" class="i">+        }
</a><a href="#h32-1-31" id="h32-1-31" class="i">+    }
</a> 
     private fun createContainer(viewGroup: ViewGroup): LinearLayout {
<a href="#h32-1-34" id="h32-1-34" class="d">-        val parent = viewGroup.parent.parent as ViewGroup
</a><a href="#h32-1-35" id="h32-1-35" class="d">-
</a>         return LinearLayout(viewGroup.context).apply layout@{
             orientation = LinearLayout.VERTICAL
             layoutParams = MarginLayoutParams(
                 ViewGroup.LayoutParams.MATCH_PARENT,
                 ViewGroup.LayoutParams.WRAP_CONTENT
             ).apply {
<a href="#h32-1-42" id="h32-1-42" class="d">-                applyTheme(parent.width, true)
</a><a href="#h32-1-43" id="h32-1-43" class="i">+                this@ChatActionMenu.context.userInterface.apply {
</a><a href="#h32-1-44" id="h32-1-44" class="i">+                    background = createRoundedBackground(actionSheetBackground, 16F, true)
</a><a href="#h32-1-45" id="h32-1-45" class="i">+                }
</a>                 setMargins(chatActionMenuItemMargin, 0, chatActionMenuItemMargin, defaultGap)
             }
         }
<a href="#h32-2" id="h32-2" class="h">@@ -84,11 +98,24 @@ class ChatActionMenu : AbstractMenu() {
</a>             }
 
             with(button) {
<a href="#h32-2-3" id="h32-2-3" class="d">-                applyTheme(viewGroup.width, true)
</a><a href="#h32-2-4" id="h32-2-4" class="i">+                this@ChatActionMenu.context.userInterface.apply {
</a><a href="#h32-2-5" id="h32-2-5" class="i">+                    background = createRoundedBackground(actionSheetBackground, 16F, true)
</a><a href="#h32-2-6" id="h32-2-6" class="i">+                    setTextColor(colorPrimary)
</a><a href="#h32-2-7" id="h32-2-7" class="i">+                    typeface = resources.getFont(getFontResource(600) ?: throw IllegalStateException(&quot;Avenir Next not loaded&quot;))
</a><a href="#h32-2-8" id="h32-2-8" class="i">+                }
</a><a href="#h32-2-9" id="h32-2-9" class="i">+                isAllCaps = false
</a><a href="#h32-2-10" id="h32-2-10" class="i">+                setShadowLayer(0F, 0F, 0F, 0)
</a><a href="#h32-2-11" id="h32-2-11" class="i">+                setPadding(chatActionMenuItemMargin, 0, 0, 0)
</a><a href="#h32-2-12" id="h32-2-12" class="i">+
</a><a href="#h32-2-13" id="h32-2-13" class="i">+                gravity = Gravity.CENTER_VERTICAL
</a><a href="#h32-2-14" id="h32-2-14" class="i">+
</a>                 layoutParams = MarginLayoutParams(
                     ViewGroup.LayoutParams.MATCH_PARENT,
                     ViewGroup.LayoutParams.WRAP_CONTENT
                 ).apply {
<a href="#h32-2-19" id="h32-2-19" class="i">+                    post {
</a><a href="#h32-2-20" id="h32-2-20" class="i">+                        width = viewGroup.width
</a><a href="#h32-2-21" id="h32-2-21" class="i">+                    }
</a>                     height = actionMenuItemHeight + defaultGap
                 }
                 buttonContainer.addView(this)
<b>diff --git a/<a id="h33" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/FriendFeedInfoMenu.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/FriendFeedInfoMenu.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/FriendFeedInfoMenu.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/FriendFeedInfoMenu.kt</a></b>
<a href="#h33-0" id="h33-0" class="h">@@ -5,9 +5,12 @@ import android.content.res.Resources
</a> import android.graphics.BitmapFactory
 import android.graphics.drawable.BitmapDrawable
 import android.graphics.drawable.Drawable
<a href="#h33-0-3" id="h33-0-3" class="i">+import android.view.Gravity
</a> import android.view.View
 import android.view.ViewGroup
<a href="#h33-0-6" id="h33-0-6" class="i">+import android.widget.FrameLayout
</a> import android.widget.LinearLayout
<a href="#h33-0-8" id="h33-0-8" class="i">+import android.widget.ScrollView
</a> import androidx.compose.foundation.background
 import androidx.compose.foundation.gestures.detectTapGestures
 import androidx.compose.foundation.layout.*
<a href="#h33-1" id="h33-1" class="h">@@ -33,7 +36,6 @@ import androidx.compose.ui.text.font.FontWeight
</a> import androidx.compose.ui.text.style.TextAlign
 import androidx.compose.ui.unit.dp
 import androidx.compose.ui.unit.sp
<a href="#h33-1-3" id="h33-1-3" class="d">-import androidx.core.content.res.use
</a> import kotlinx.coroutines.Dispatchers
 import kotlinx.coroutines.launch
 import kotlinx.coroutines.withContext
<a href="#h33-2" id="h33-2" class="h">@@ -48,15 +50,16 @@ import me.rhunk.snapenhance.common.ui.createComposeAlertDialog
</a> import me.rhunk.snapenhance.common.ui.createComposeView
 import me.rhunk.snapenhance.common.util.protobuf.ProtoReader
 import me.rhunk.snapenhance.common.util.snap.BitmojiSelfie
<a href="#h33-2-3" id="h33-2-3" class="i">+import me.rhunk.snapenhance.core.event.events.impl.AddViewEvent
</a> import me.rhunk.snapenhance.core.features.impl.experiments.EndToEndEncryption
 import me.rhunk.snapenhance.core.features.impl.messaging.AutoMarkAsRead
 import me.rhunk.snapenhance.core.features.impl.messaging.Messaging
 import me.rhunk.snapenhance.core.features.impl.spying.MessageLogger
 import me.rhunk.snapenhance.core.ui.ViewAppearanceHelper
<a href="#h33-2-9" id="h33-2-9" class="d">-import me.rhunk.snapenhance.core.ui.applyTheme
</a><a href="#h33-2-10" id="h33-2-10" class="i">+import me.rhunk.snapenhance.core.ui.children
</a> import me.rhunk.snapenhance.core.ui.menu.AbstractMenu
<a href="#h33-2-12" id="h33-2-12" class="i">+import me.rhunk.snapenhance.core.ui.randomTag
</a> import me.rhunk.snapenhance.core.ui.triggerRootCloseTouchEvent
<a href="#h33-2-14" id="h33-2-14" class="d">-import me.rhunk.snapenhance.core.util.ktx.getIdentifier
</a> import me.rhunk.snapenhance.core.util.ktx.isDarkTheme
 import java.net.HttpURLConnection
 import java.net.URL
<a href="#h33-3" id="h33-3" class="h">@@ -67,22 +70,6 @@ import java.util.Date
</a> import java.util.Locale
 
 class FriendFeedInfoMenu : AbstractMenu() {
<a href="#h33-3-3" id="h33-3-3" class="d">-    private val avenirNextMediumFont by lazy {
</a><a href="#h33-3-4" id="h33-3-4" class="d">-        FontFamily(
</a><a href="#h33-3-5" id="h33-3-5" class="d">-            Font(context.resources.getIdentifier(&quot;avenir_next_medium&quot;, &quot;font&quot;), FontWeight.Medium)
</a><a href="#h33-3-6" id="h33-3-6" class="d">-        )
</a><a href="#h33-3-7" id="h33-3-7" class="d">-    }
</a><a href="#h33-3-8" id="h33-3-8" class="d">-    private val sigColorTextPrimary by lazy {
</a><a href="#h33-3-9" id="h33-3-9" class="d">-        context.androidContext.theme.obtainStyledAttributes(
</a><a href="#h33-3-10" id="h33-3-10" class="d">-            intArrayOf(context.resources.getIdentifier(&quot;sigColorTextPrimary&quot;, &quot;attr&quot;))
</a><a href="#h33-3-11" id="h33-3-11" class="d">-        ).use { it.getColor(0, 0) }
</a><a href="#h33-3-12" id="h33-3-12" class="d">-    }
</a><a href="#h33-3-13" id="h33-3-13" class="d">-    private val sigColorBackgroundSurface by lazy {
</a><a href="#h33-3-14" id="h33-3-14" class="d">-        context.androidContext.theme.obtainStyledAttributes(
</a><a href="#h33-3-15" id="h33-3-15" class="d">-            intArrayOf(context.resources.getIdentifier(&quot;sigColorBackgroundSurface&quot;, &quot;attr&quot;))
</a><a href="#h33-3-16" id="h33-3-16" class="d">-        ).use { it.getColor(0, 0) }
</a><a href="#h33-3-17" id="h33-3-17" class="d">-    }
</a><a href="#h33-3-18" id="h33-3-18" class="d">-
</a>     private fun getImageDrawable(url: String): Drawable {
         val connection = URL(url).openConnection() as HttpURLConnection
         connection.connect()
<a href="#h33-4" id="h33-4" class="h">@@ -172,7 +159,7 @@ class FriendFeedInfoMenu : AbstractMenu() {
</a>             createComposeAlertDialog(
                 context.mainActivity!!,
             ) {
<a href="#h33-4-3" id="h33-4-3" class="d">-                var pageIndex by remember { mutableStateOf(0) }
</a><a href="#h33-4-4" id="h33-4-4" class="i">+                var pageIndex by remember { mutableIntStateOf(0) }
</a>                 val messages = remember { mutableStateListOf&lt;@Composable () -&gt; Unit&gt;() }
                 var totalMessages by remember { mutableIntStateOf(-1) }
                 val coroutineScope = rememberCoroutineScope()
<a href="#h33-5" id="h33-5" class="h">@@ -334,12 +321,16 @@ class FriendFeedInfoMenu : AbstractMenu() {
</a>         if (index &gt; 0) {
             Spacer(modifier = Modifier
                 .height(1.dp)
<a href="#h33-5-3" id="h33-5-3" class="d">-                .background(remember { if (context.androidContext.isDarkTheme()) Color(0x1affffff) else Color(0xffeeeeee) })
</a><a href="#h33-5-4" id="h33-5-4" class="i">+                .background(remember {
</a><a href="#h33-5-5" id="h33-5-5" class="i">+                    if (context.androidContext.isDarkTheme()) Color(0x1affffff) else Color(
</a><a href="#h33-5-6" id="h33-5-6" class="i">+                        0xffeeeeee
</a><a href="#h33-5-7" id="h33-5-7" class="i">+                    )
</a><a href="#h33-5-8" id="h33-5-8" class="i">+                })
</a>                 .fillMaxWidth())
         }
         Surface(
<a href="#h33-5-12" id="h33-5-12" class="d">-            color = Color(sigColorBackgroundSurface),
</a><a href="#h33-5-13" id="h33-5-13" class="d">-            contentColor = Color(sigColorTextPrimary),
</a><a href="#h33-5-14" id="h33-5-14" class="i">+            color = Color(context.userInterface.actionSheetBackground),
</a><a href="#h33-5-15" id="h33-5-15" class="i">+            contentColor = Color(context.userInterface.colorPrimary),
</a>         ) {
             Row(
                 modifier = Modifier
<a href="#h33-6" id="h33-6" class="h">@@ -372,9 +363,66 @@ class FriendFeedInfoMenu : AbstractMenu() {
</a>         }
     }
 
<a href="#h33-6-3" id="h33-6-3" class="d">-    override fun inject(parent: ViewGroup, view: View, viewConsumer: ((View) -&gt; Unit)) {
</a><a href="#h33-6-4" id="h33-6-4" class="d">-        val modContext = context
</a><a href="#h33-6-5" id="h33-6-5" class="i">+    private val recyclerViewTag = randomTag()
</a><a href="#h33-6-6" id="h33-6-6" class="i">+    private val messaging by lazy { context.feature(Messaging::class)}
</a><a href="#h33-6-7" id="h33-6-7" class="i">+
</a><a href="#h33-6-8" id="h33-6-8" class="i">+    override fun onViewAdded(event: AddViewEvent) {
</a><a href="#h33-6-9" id="h33-6-9" class="i">+        fun hasAvatarHeader(viewGroup: ViewGroup): Boolean {
</a><a href="#h33-6-10" id="h33-6-10" class="i">+            val constraintLayout = viewGroup.getChildAt(0)?.takeIf { it.javaClass.name.endsWith(&quot;ConstraintLayout&quot;) } as? ViewGroup ?: return false
</a><a href="#h33-6-11" id="h33-6-11" class="i">+            return constraintLayout.children().firstOrNull { it.javaClass.name.endsWith(&quot;AvatarView&quot;) } != null
</a><a href="#h33-6-12" id="h33-6-12" class="i">+        }
</a><a href="#h33-6-13" id="h33-6-13" class="i">+
</a><a href="#h33-6-14" id="h33-6-14" class="i">+        if (event.parent is FrameLayout &amp;&amp; messaging.lastFocusedConversationType == 1 &amp;&amp; event.view.javaClass.name.endsWith(&quot;RecyclerView&quot;)) {
</a><a href="#h33-6-15" id="h33-6-15" class="i">+            event.view.addOnLayoutChangeListener { _, _, _, _, _, _, _, _, _ -&gt;
</a><a href="#h33-6-16" id="h33-6-16" class="i">+                if (event.view.tag == recyclerViewTag || !hasAvatarHeader(event.view as ViewGroup)) return@addOnLayoutChangeListener
</a><a href="#h33-6-17" id="h33-6-17" class="i">+                event.view.tag = recyclerViewTag
</a><a href="#h33-6-18" id="h33-6-18" class="i">+
</a><a href="#h33-6-19" id="h33-6-19" class="i">+                // remove recycler view
</a><a href="#h33-6-20" id="h33-6-20" class="i">+                event.parent.removeView(event.view)
</a><a href="#h33-6-21" id="h33-6-21" class="i">+
</a><a href="#h33-6-22" id="h33-6-22" class="i">+                val newLayout = LinearLayout(event.view.context).apply {
</a><a href="#h33-6-23" id="h33-6-23" class="i">+                    orientation = LinearLayout.VERTICAL
</a><a href="#h33-6-24" id="h33-6-24" class="i">+                    gravity = Gravity.BOTTOM
</a><a href="#h33-6-25" id="h33-6-25" class="i">+                    layoutParams = ViewGroup.LayoutParams(ViewGroup.LayoutParams.MATCH_PARENT, ViewGroup.LayoutParams.MATCH_PARENT)
</a><a href="#h33-6-26" id="h33-6-26" class="i">+                    addView(event.view)
</a><a href="#h33-6-27" id="h33-6-27" class="i">+                }
</a><a href="#h33-6-28" id="h33-6-28" class="i">+
</a><a href="#h33-6-29" id="h33-6-29" class="i">+                newLayout.addView(ScrollView(newLayout.context).apply {
</a><a href="#h33-6-30" id="h33-6-30" class="i">+                    layoutParams = LinearLayout.LayoutParams(
</a><a href="#h33-6-31" id="h33-6-31" class="i">+                        ViewGroup.LayoutParams.MATCH_PARENT,
</a><a href="#h33-6-32" id="h33-6-32" class="i">+                        ViewGroup.LayoutParams.WRAP_CONTENT
</a><a href="#h33-6-33" id="h33-6-33" class="i">+                    ).apply {
</a><a href="#h33-6-34" id="h33-6-34" class="i">+                        weight = 1f;
</a><a href="#h33-6-35" id="h33-6-35" class="i">+                        setMargins(0, 100, 0, 0)
</a><a href="#h33-6-36" id="h33-6-36" class="i">+                    }
</a><a href="#h33-6-37" id="h33-6-37" class="i">+
</a><a href="#h33-6-38" id="h33-6-38" class="i">+                    addView(LinearLayout(context).apply {
</a><a href="#h33-6-39" id="h33-6-39" class="i">+                        orientation = LinearLayout.VERTICAL
</a><a href="#h33-6-40" id="h33-6-40" class="i">+                        injectIntoActionSheetItems(newLayout) {
</a><a href="#h33-6-41" id="h33-6-41" class="i">+                            it.layoutParams = LinearLayout.LayoutParams(
</a><a href="#h33-6-42" id="h33-6-42" class="i">+                                ViewGroup.LayoutParams.MATCH_PARENT,
</a><a href="#h33-6-43" id="h33-6-43" class="i">+                                ViewGroup.LayoutParams.WRAP_CONTENT
</a><a href="#h33-6-44" id="h33-6-44" class="i">+                            ).apply {
</a><a href="#h33-6-45" id="h33-6-45" class="i">+                                setMargins(0, 5, 0, 5)
</a><a href="#h33-6-46" id="h33-6-46" class="i">+                            }
</a><a href="#h33-6-47" id="h33-6-47" class="i">+                            addView(it)
</a><a href="#h33-6-48" id="h33-6-48" class="i">+                        }
</a><a href="#h33-6-49" id="h33-6-49" class="i">+                    })
</a><a href="#h33-6-50" id="h33-6-50" class="i">+                }, 0)
</a> 
<a href="#h33-6-52" id="h33-6-52" class="i">+                event.parent.addView(newLayout)
</a><a href="#h33-6-53" id="h33-6-53" class="i">+            }
</a><a href="#h33-6-54" id="h33-6-54" class="i">+        }
</a><a href="#h33-6-55" id="h33-6-55" class="i">+
</a><a href="#h33-6-56" id="h33-6-56" class="i">+        if (event.parent is LinearLayout &amp;&amp; event.viewClassName.endsWith(&quot;SnapCardView&quot;) &amp;&amp; hasAvatarHeader(event.parent)) {
</a><a href="#h33-6-57" id="h33-6-57" class="i">+            val actionSheetItemsContainerLayout = (event.view as ViewGroup).getChildAt(0) as? ViewGroup ?: throw IllegalStateException(&quot;ActionSheetItemsContainerLayout not found&quot;)
</a><a href="#h33-6-58" id="h33-6-58" class="i">+            injectIntoActionSheetItems(actionSheetItemsContainerLayout) {
</a><a href="#h33-6-59" id="h33-6-59" class="i">+                actionSheetItemsContainerLayout.addView(it, 0)
</a><a href="#h33-6-60" id="h33-6-60" class="i">+            }
</a><a href="#h33-6-61" id="h33-6-61" class="i">+        }
</a><a href="#h33-6-62" id="h33-6-62" class="i">+    }
</a><a href="#h33-6-63" id="h33-6-63" class="i">+
</a><a href="#h33-6-64" id="h33-6-64" class="i">+    private fun injectIntoActionSheetItems(actionSheetItemsContainer: View, viewConsumer: ((View) -&gt; Unit)) {
</a>         val friendFeedMenuOptions by context.config.userInterface.friendFeedMenuButtons
         if (friendFeedMenuOptions.isEmpty()) return
 
<a href="#h33-7" id="h33-7" class="h">@@ -410,7 +458,7 @@ class FriendFeedInfoMenu : AbstractMenu() {
</a>                     )
                 }
 
<a href="#h33-7-3" id="h33-7-3" class="d">-                modContext.features.getRuleFeatures().forEach { ruleFeature -&gt;
</a><a href="#h33-7-4" id="h33-7-4" class="i">+                context.features.getRuleFeatures().forEach { ruleFeature -&gt;
</a>                     if (!friendFeedMenuOptions.contains(ruleFeature.ruleType.key)) return@forEach
 
                     val ruleState = ruleFeature.getRuleState() ?: return@forEach
<a href="#h33-8" id="h33-8" class="h">@@ -478,7 +526,7 @@ class FriendFeedInfoMenu : AbstractMenu() {
</a>                             }
                         },
                         onLongClick = {
<a href="#h33-8-3" id="h33-8-3" class="d">-                            view.post {
</a><a href="#h33-8-4" id="h33-8-4" class="i">+                            actionSheetItemsContainer.post {
</a>                                 context.apply {
                                     closeMenu()
                                     inAppOverlay.showStatusToast(
<a href="#h33-9" id="h33-9" class="h">@@ -496,9 +544,11 @@ class FriendFeedInfoMenu : AbstractMenu() {
</a>         }
 
         viewConsumer(
<a href="#h33-9-3" id="h33-9-3" class="d">-            createComposeView(view.context) {
</a><a href="#h33-9-4" id="h33-9-4" class="i">+            createComposeView(actionSheetItemsContainer.context) {
</a>                 CompositionLocalProvider(
<a href="#h33-9-6" id="h33-9-6" class="d">-                    LocalTextStyle provides LocalTextStyle.current.merge(TextStyle(fontFamily = avenirNextMediumFont))
</a><a href="#h33-9-7" id="h33-9-7" class="i">+                    LocalTextStyle provides LocalTextStyle.current.merge(TextStyle(fontFamily = FontFamily(
</a><a href="#h33-9-8" id="h33-9-8" class="i">+                        Font(context.userInterface.getFontResource(600) ?: throw IllegalStateException(&quot;Avenir Next font not found&quot;), FontWeight.Medium)
</a><a href="#h33-9-9" id="h33-9-9" class="i">+                    )))
</a>                 ) {
                     ComposeFriendFeedMenu()
                 }
<a href="#h33-10" id="h33-10" class="h">@@ -517,16 +567,14 @@ class FriendFeedInfoMenu : AbstractMenu() {
</a>                         it.hasInterface(EnumScriptInterface.FRIEND_FEED_CONTEXT_MENU)
                     } ?: return@eachModule
 
<a href="#h33-10-3" id="h33-10-3" class="d">-                viewConsumer(LinearLayout(view.context).apply {
</a><a href="#h33-10-4" id="h33-10-4" class="i">+                viewConsumer(LinearLayout(actionSheetItemsContainer.context).apply {
</a>                     layoutParams = ViewGroup.LayoutParams(
                         ViewGroup.LayoutParams.MATCH_PARENT,
                         ViewGroup.LayoutParams.WRAP_CONTENT
                     )
 
<a href="#h33-10-10" id="h33-10-10" class="d">-                    applyTheme(view.width, hasRadius = true)
</a><a href="#h33-10-11" id="h33-10-11" class="d">-
</a>                     orientation = LinearLayout.VERTICAL
<a href="#h33-10-13" id="h33-10-13" class="d">-                    addView(createComposeView(view.context) {
</a><a href="#h33-10-14" id="h33-10-14" class="i">+                    addView(createComposeView(actionSheetItemsContainer.context) {
</a>                         Surface(
                             modifier = Modifier.fillMaxWidth(),
                             color = MaterialTheme.colorScheme.surface
<b>diff --git a/<a id="h34" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/NewChatActionMenu.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/NewChatActionMenu.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/NewChatActionMenu.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/NewChatActionMenu.kt</a></b>
<a href="#h34-0" id="h34-0" class="h">@@ -300,7 +300,7 @@ class NewChatActionMenu : AbstractMenu() {
</a>             val primaryColor = remember { if (event.view.context.isDarkTheme()) Color.White else Color.Black }
             val avenirNextMediumFont = remember {
                 FontFamily(
<a href="#h34-0-3" id="h34-0-3" class="d">-                    Font(context.resources.getIdentifier(&quot;avenir_next_medium&quot;, &quot;font&quot;), FontWeight.Medium)
</a><a href="#h34-0-4" id="h34-0-4" class="i">+                    Font(context.userInterface.getFontResource(600) ?: throw IllegalStateException(&quot;Font not found&quot;), FontWeight.Medium)
</a>                 )
             }
 
<b>diff --git a/<a id="h35" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/OperaContextActionMenu.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/OperaContextActionMenu.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/OperaContextActionMenu.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/OperaContextActionMenu.kt</a></b>
<a href="#h35-0" id="h35-0" class="h">@@ -23,12 +23,12 @@ import androidx.compose.ui.text.style.TextAlign
</a> import androidx.compose.ui.unit.dp
 import androidx.core.content.res.use
 import me.rhunk.snapenhance.common.ui.createComposeView
<a href="#h35-0-3" id="h35-0-3" class="i">+import me.rhunk.snapenhance.core.event.events.impl.AddViewEvent
</a> import me.rhunk.snapenhance.core.features.impl.OperaViewerParamsOverride
 import me.rhunk.snapenhance.core.features.impl.downloader.MediaDownloader
<a href="#h35-0-6" id="h35-0-6" class="d">-import me.rhunk.snapenhance.core.ui.applyTheme
</a><a href="#h35-0-7" id="h35-0-7" class="i">+import me.rhunk.snapenhance.core.ui.children
</a> import me.rhunk.snapenhance.core.ui.menu.AbstractMenu
 import me.rhunk.snapenhance.core.ui.triggerCloseTouchEvent
<a href="#h35-0-10" id="h35-0-10" class="d">-import me.rhunk.snapenhance.core.util.ktx.getId
</a> import me.rhunk.snapenhance.core.util.ktx.getIdentifier
 import me.rhunk.snapenhance.core.util.ktx.vibrateLongPress
 import me.rhunk.snapenhance.core.wrapper.impl.ScSize
<a href="#h35-1" id="h35-1" class="h">@@ -37,8 +37,6 @@ import java.util.Date
</a> 
 @SuppressLint(&quot;DiscouragedApi&quot;)
 class OperaContextActionMenu : AbstractMenu() {
<a href="#h35-1-3" id="h35-1-3" class="d">-    private val contextCardsScrollView by lazy { context.resources.getId(&quot;context_cards_scroll_view&quot;) }
</a><a href="#h35-1-4" id="h35-1-4" class="d">-
</a>     /*
     LinearLayout :
         - LinearLayout:
<a href="#h35-2" id="h35-2" class="h">@@ -53,166 +51,150 @@ class OperaContextActionMenu : AbstractMenu() {
</a>      */
     private fun isViewGroupButtonMenuContainer(viewGroup: ViewGroup): Boolean {
         if (viewGroup !is LinearLayout) return false
<a href="#h35-2-3" id="h35-2-3" class="d">-        val children = ArrayList&lt;View&gt;()
</a><a href="#h35-2-4" id="h35-2-4" class="d">-        for (i in 0 until viewGroup.getChildCount())
</a><a href="#h35-2-5" id="h35-2-5" class="d">-            children.add(viewGroup.getChildAt(i))
</a><a href="#h35-2-6" id="h35-2-6" class="i">+        val children = viewGroup.children()
</a>         return if (children.any { view: View? -&gt; view !is LinearLayout })
             false
         else children.map { view: View -&gt; view as LinearLayout }
             .any { linearLayout: LinearLayout -&gt;
<a href="#h35-2-11" id="h35-2-11" class="d">-                val viewChildren = ArrayList&lt;View&gt;()
</a><a href="#h35-2-12" id="h35-2-12" class="d">-                for (i in 0 until linearLayout.childCount) viewChildren.add(
</a><a href="#h35-2-13" id="h35-2-13" class="d">-                    linearLayout.getChildAt(
</a><a href="#h35-2-14" id="h35-2-14" class="d">-                        i
</a><a href="#h35-2-15" id="h35-2-15" class="d">-                    )
</a><a href="#h35-2-16" id="h35-2-16" class="d">-                )
</a><a href="#h35-2-17" id="h35-2-17" class="d">-                viewChildren.any { viewChild: View -&gt;
</a><a href="#h35-2-18" id="h35-2-18" class="i">+                linearLayout.children().any { viewChild: View -&gt;
</a>                     viewChild.javaClass.name.endsWith(&quot;SnapFontTextView&quot;)
                 }
             }
     }
 
<a href="#h35-2-24" id="h35-2-24" class="d">-    @SuppressLint(&quot;SetTextI18n&quot;)
</a><a href="#h35-2-25" id="h35-2-25" class="d">-    override fun inject(parent: ViewGroup, view: View, viewConsumer: (View) -&gt; Unit) {
</a><a href="#h35-2-26" id="h35-2-26" class="d">-        try {
</a><a href="#h35-2-27" id="h35-2-27" class="d">-            if (parent.parent !is ScrollView) return
</a><a href="#h35-2-28" id="h35-2-28" class="d">-            val parentView = parent.parent as ScrollView
</a><a href="#h35-2-29" id="h35-2-29" class="d">-            if (parentView.id != contextCardsScrollView) return
</a><a href="#h35-2-30" id="h35-2-30" class="d">-            if (view !is LinearLayout) return
</a><a href="#h35-2-31" id="h35-2-31" class="d">-            if (!isViewGroupButtonMenuContainer(view as ViewGroup)) return
</a><a href="#h35-2-32" id="h35-2-32" class="i">+    override fun onViewAdded(event: AddViewEvent) {
</a><a href="#h35-2-33" id="h35-2-33" class="i">+        val parentView = event.parent.parent as? ScrollView ?: return
</a><a href="#h35-2-34" id="h35-2-34" class="i">+        val view = event.view
</a><a href="#h35-2-35" id="h35-2-35" class="i">+        if (view !is LinearLayout) return
</a><a href="#h35-2-36" id="h35-2-36" class="i">+        if (!isViewGroupButtonMenuContainer(view as ViewGroup)) return
</a> 
<a href="#h35-2-38" id="h35-2-38" class="d">-            val linearLayout = LinearLayout(view.context)
</a><a href="#h35-2-39" id="h35-2-39" class="d">-            linearLayout.orientation = LinearLayout.VERTICAL
</a><a href="#h35-2-40" id="h35-2-40" class="d">-            linearLayout.gravity = Gravity.CENTER
</a><a href="#h35-2-41" id="h35-2-41" class="d">-            linearLayout.layoutParams =
</a><a href="#h35-2-42" id="h35-2-42" class="d">-                LinearLayout.LayoutParams(
</a><a href="#h35-2-43" id="h35-2-43" class="d">-                    ViewGroup.LayoutParams.MATCH_PARENT,
</a><a href="#h35-2-44" id="h35-2-44" class="d">-                    ViewGroup.LayoutParams.MATCH_PARENT
</a><a href="#h35-2-45" id="h35-2-45" class="d">-                )
</a><a href="#h35-2-46" id="h35-2-46" class="d">-            val translation = context.translation.getCategory(&quot;opera_context_menu&quot;)
</a><a href="#h35-2-47" id="h35-2-47" class="d">-            val mediaDownloader = context.feature(MediaDownloader::class)
</a><a href="#h35-2-48" id="h35-2-48" class="d">-            val paramMap = mediaDownloader.lastSeenMapParams
</a><a href="#h35-2-49" id="h35-2-49" class="i">+        val linearLayout = LinearLayout(view.context)
</a><a href="#h35-2-50" id="h35-2-50" class="i">+        linearLayout.orientation = LinearLayout.VERTICAL
</a><a href="#h35-2-51" id="h35-2-51" class="i">+        linearLayout.gravity = Gravity.CENTER
</a><a href="#h35-2-52" id="h35-2-52" class="i">+        linearLayout.layoutParams =
</a><a href="#h35-2-53" id="h35-2-53" class="i">+            LinearLayout.LayoutParams(
</a><a href="#h35-2-54" id="h35-2-54" class="i">+                ViewGroup.LayoutParams.MATCH_PARENT,
</a><a href="#h35-2-55" id="h35-2-55" class="i">+                ViewGroup.LayoutParams.MATCH_PARENT
</a><a href="#h35-2-56" id="h35-2-56" class="i">+            )
</a><a href="#h35-2-57" id="h35-2-57" class="i">+        val translation = context.translation.getCategory(&quot;opera_context_menu&quot;)
</a><a href="#h35-2-58" id="h35-2-58" class="i">+        val mediaDownloader = context.feature(MediaDownloader::class)
</a><a href="#h35-2-59" id="h35-2-59" class="i">+        val paramMap = mediaDownloader.lastSeenMapParams
</a> 
<a href="#h35-2-61" id="h35-2-61" class="d">-            if (paramMap != null &amp;&amp; context.config.userInterface.operaMediaQuickInfo.get()) {
</a><a href="#h35-2-62" id="h35-2-62" class="d">-                val playableStorySnapRecord = paramMap[&quot;PLAYABLE_STORY_SNAP_RECORD&quot;]?.toString()
</a><a href="#h35-2-63" id="h35-2-63" class="d">-                val sentTimestamp = playableStorySnapRecord?.substringAfter(&quot;timestamp=&quot;)
</a><a href="#h35-2-64" id="h35-2-64" class="d">-                    ?.substringBefore(&quot;,&quot;)?.toLongOrNull()
</a><a href="#h35-2-65" id="h35-2-65" class="d">-                    ?: paramMap[&quot;MESSAGE_ID&quot;]?.toString()?.let { messageId -&gt;
</a><a href="#h35-2-66" id="h35-2-66" class="d">-                        context.database.getConversationMessageFromId(
</a><a href="#h35-2-67" id="h35-2-67" class="d">-                            messageId.substring(messageId.lastIndexOf(&quot;:&quot;) + 1)
</a><a href="#h35-2-68" id="h35-2-68" class="d">-                                .toLong()
</a><a href="#h35-2-69" id="h35-2-69" class="d">-                        )?.creationTimestamp
</a><a href="#h35-2-70" id="h35-2-70" class="d">-                    }
</a><a href="#h35-2-71" id="h35-2-71" class="d">-                    ?: paramMap[&quot;SNAP_TIMESTAMP&quot;]?.toString()?.toLongOrNull()
</a><a href="#h35-2-72" id="h35-2-72" class="d">-                val dateFormat = DateFormat.getDateTimeInstance()
</a><a href="#h35-2-73" id="h35-2-73" class="d">-                val creationTimestamp = playableStorySnapRecord?.substringAfter(&quot;creationTimestamp=&quot;)
</a><a href="#h35-2-74" id="h35-2-74" class="d">-                    ?.substringBefore(&quot;,&quot;)?.toLongOrNull()
</a><a href="#h35-2-75" id="h35-2-75" class="d">-                val expirationTimestamp = playableStorySnapRecord?.substringAfter(&quot;expirationTimestamp=&quot;)
</a><a href="#h35-2-76" id="h35-2-76" class="d">-                    ?.substringBefore(&quot;,&quot;)?.toLongOrNull()
</a><a href="#h35-2-77" id="h35-2-77" class="d">-                    ?: paramMap[&quot;SNAP_EXPIRATION_TIMESTAMP_MILLIS&quot;]?.toString()?.toLongOrNull()
</a><a href="#h35-2-78" id="h35-2-78" class="i">+        if (paramMap != null &amp;&amp; context.config.userInterface.operaMediaQuickInfo.get()) {
</a><a href="#h35-2-79" id="h35-2-79" class="i">+            val playableStorySnapRecord = paramMap[&quot;PLAYABLE_STORY_SNAP_RECORD&quot;]?.toString()
</a><a href="#h35-2-80" id="h35-2-80" class="i">+            val sentTimestamp = playableStorySnapRecord?.substringAfter(&quot;timestamp=&quot;)
</a><a href="#h35-2-81" id="h35-2-81" class="i">+                ?.substringBefore(&quot;,&quot;)?.toLongOrNull()
</a><a href="#h35-2-82" id="h35-2-82" class="i">+                ?: paramMap[&quot;MESSAGE_ID&quot;]?.toString()?.let { messageId -&gt;
</a><a href="#h35-2-83" id="h35-2-83" class="i">+                    context.database.getConversationMessageFromId(
</a><a href="#h35-2-84" id="h35-2-84" class="i">+                        messageId.substring(messageId.lastIndexOf(&quot;:&quot;) + 1)
</a><a href="#h35-2-85" id="h35-2-85" class="i">+                            .toLong()
</a><a href="#h35-2-86" id="h35-2-86" class="i">+                    )?.creationTimestamp
</a><a href="#h35-2-87" id="h35-2-87" class="i">+                }
</a><a href="#h35-2-88" id="h35-2-88" class="i">+                ?: paramMap[&quot;SNAP_TIMESTAMP&quot;]?.toString()?.toLongOrNull()
</a><a href="#h35-2-89" id="h35-2-89" class="i">+            val dateFormat = DateFormat.getDateTimeInstance()
</a><a href="#h35-2-90" id="h35-2-90" class="i">+            val creationTimestamp = playableStorySnapRecord?.substringAfter(&quot;creationTimestamp=&quot;)
</a><a href="#h35-2-91" id="h35-2-91" class="i">+                ?.substringBefore(&quot;,&quot;)?.toLongOrNull()
</a><a href="#h35-2-92" id="h35-2-92" class="i">+            val expirationTimestamp = playableStorySnapRecord?.substringAfter(&quot;expirationTimestamp=&quot;)
</a><a href="#h35-2-93" id="h35-2-93" class="i">+                ?.substringBefore(&quot;,&quot;)?.toLongOrNull()
</a><a href="#h35-2-94" id="h35-2-94" class="i">+                ?: paramMap[&quot;SNAP_EXPIRATION_TIMESTAMP_MILLIS&quot;]?.toString()?.toLongOrNull()
</a> 
<a href="#h35-2-96" id="h35-2-96" class="d">-                val mediaSize = paramMap[&quot;snap_size&quot;]?.let { ScSize(it) }
</a><a href="#h35-2-97" id="h35-2-97" class="d">-                val durationMs = paramMap[&quot;media_duration_ms&quot;]?.toString()
</a><a href="#h35-2-98" id="h35-2-98" class="i">+            val mediaSize = paramMap[&quot;snap_size&quot;]?.let { ScSize(it) }
</a><a href="#h35-2-99" id="h35-2-99" class="i">+            val durationMs = paramMap[&quot;media_duration_ms&quot;]?.toString()
</a> 
<a href="#h35-2-101" id="h35-2-101" class="d">-                val stringBuilder = StringBuilder().apply {
</a><a href="#h35-2-102" id="h35-2-102" class="d">-                    if (sentTimestamp != null) {
</a><a href="#h35-2-103" id="h35-2-103" class="d">-                        append(translation.format(&quot;sent_at&quot;, &quot;date&quot; to dateFormat.format(Date(sentTimestamp))))
</a><a href="#h35-2-104" id="h35-2-104" class="d">-                        append(&quot;\n&quot;)
</a><a href="#h35-2-105" id="h35-2-105" class="d">-                    }
</a><a href="#h35-2-106" id="h35-2-106" class="d">-                    if (creationTimestamp != null) {
</a><a href="#h35-2-107" id="h35-2-107" class="d">-                        append(translation.format(&quot;created_at&quot;, &quot;date&quot; to dateFormat.format(Date(creationTimestamp))))
</a><a href="#h35-2-108" id="h35-2-108" class="d">-                        append(&quot;\n&quot;)
</a><a href="#h35-2-109" id="h35-2-109" class="d">-                    }
</a><a href="#h35-2-110" id="h35-2-110" class="d">-                    if (expirationTimestamp != null) {
</a><a href="#h35-2-111" id="h35-2-111" class="d">-                        append(translation.format(&quot;expires_at&quot;, &quot;date&quot; to dateFormat.format(Date(expirationTimestamp))))
</a><a href="#h35-2-112" id="h35-2-112" class="d">-                        append(&quot;\n&quot;)
</a><a href="#h35-2-113" id="h35-2-113" class="d">-                    }
</a><a href="#h35-2-114" id="h35-2-114" class="d">-                    if (mediaSize != null) {
</a><a href="#h35-2-115" id="h35-2-115" class="d">-                        append(translation.format(&quot;media_size&quot;, &quot;size&quot; to &quot;${mediaSize.first}x${mediaSize.second}&quot;))
</a><a href="#h35-2-116" id="h35-2-116" class="d">-                        append(&quot;\n&quot;)
</a><a href="#h35-2-117" id="h35-2-117" class="d">-                    }
</a><a href="#h35-2-118" id="h35-2-118" class="d">-                    if (durationMs != null) {
</a><a href="#h35-2-119" id="h35-2-119" class="d">-                        append(translation.format(&quot;media_duration&quot;, &quot;duration&quot; to durationMs))
</a><a href="#h35-2-120" id="h35-2-120" class="d">-                        append(&quot;\n&quot;)
</a><a href="#h35-2-121" id="h35-2-121" class="d">-                    }
</a><a href="#h35-2-122" id="h35-2-122" class="d">-                    if (last() == &#39;\n&#39;) deleteCharAt(length - 1)
</a><a href="#h35-2-123" id="h35-2-123" class="i">+            val stringBuilder = StringBuilder().apply {
</a><a href="#h35-2-124" id="h35-2-124" class="i">+                if (sentTimestamp != null) {
</a><a href="#h35-2-125" id="h35-2-125" class="i">+                    append(translation.format(&quot;sent_at&quot;, &quot;date&quot; to dateFormat.format(Date(sentTimestamp))))
</a><a href="#h35-2-126" id="h35-2-126" class="i">+                    append(&quot;\n&quot;)
</a>                 }
<a href="#h35-2-128" id="h35-2-128" class="d">-
</a><a href="#h35-2-129" id="h35-2-129" class="d">-                if (stringBuilder.isNotEmpty()) {
</a><a href="#h35-2-130" id="h35-2-130" class="d">-                    linearLayout.addView(TextView(view.context).apply {
</a><a href="#h35-2-131" id="h35-2-131" class="d">-                        text = stringBuilder.toString()
</a><a href="#h35-2-132" id="h35-2-132" class="d">-                        setPadding(40, 10, 0, 0)
</a><a href="#h35-2-133" id="h35-2-133" class="d">-                    })
</a><a href="#h35-2-134" id="h35-2-134" class="i">+                if (creationTimestamp != null) {
</a><a href="#h35-2-135" id="h35-2-135" class="i">+                    append(translation.format(&quot;created_at&quot;, &quot;date&quot; to dateFormat.format(Date(creationTimestamp))))
</a><a href="#h35-2-136" id="h35-2-136" class="i">+                    append(&quot;\n&quot;)
</a>                 }
<a href="#h35-2-138" id="h35-2-138" class="i">+                if (expirationTimestamp != null) {
</a><a href="#h35-2-139" id="h35-2-139" class="i">+                    append(translation.format(&quot;expires_at&quot;, &quot;date&quot; to dateFormat.format(Date(expirationTimestamp))))
</a><a href="#h35-2-140" id="h35-2-140" class="i">+                    append(&quot;\n&quot;)
</a><a href="#h35-2-141" id="h35-2-141" class="i">+                }
</a><a href="#h35-2-142" id="h35-2-142" class="i">+                if (mediaSize != null) {
</a><a href="#h35-2-143" id="h35-2-143" class="i">+                    append(translation.format(&quot;media_size&quot;, &quot;size&quot; to &quot;${mediaSize.first}x${mediaSize.second}&quot;))
</a><a href="#h35-2-144" id="h35-2-144" class="i">+                    append(&quot;\n&quot;)
</a><a href="#h35-2-145" id="h35-2-145" class="i">+                }
</a><a href="#h35-2-146" id="h35-2-146" class="i">+                if (durationMs != null) {
</a><a href="#h35-2-147" id="h35-2-147" class="i">+                    append(translation.format(&quot;media_duration&quot;, &quot;duration&quot; to durationMs))
</a><a href="#h35-2-148" id="h35-2-148" class="i">+                    append(&quot;\n&quot;)
</a><a href="#h35-2-149" id="h35-2-149" class="i">+                }
</a><a href="#h35-2-150" id="h35-2-150" class="i">+                if (last() == &#39;\n&#39;) deleteCharAt(length - 1)
</a>             }
 
<a href="#h35-2-153" id="h35-2-153" class="d">-            if (context.config.global.videoPlaybackRateSlider.get()) {
</a><a href="#h35-2-154" id="h35-2-154" class="d">-                val operaViewerParamsOverride = context.feature(OperaViewerParamsOverride::class)
</a><a href="#h35-2-155" id="h35-2-155" class="d">-
</a><a href="#h35-2-156" id="h35-2-156" class="d">-                linearLayout.addView(createComposeView(view.context) {
</a><a href="#h35-2-157" id="h35-2-157" class="d">-                    Column(
</a><a href="#h35-2-158" id="h35-2-158" class="d">-                        modifier = Modifier
</a><a href="#h35-2-159" id="h35-2-159" class="d">-                            .fillMaxWidth()
</a><a href="#h35-2-160" id="h35-2-160" class="d">-                            .padding(10.dp)
</a><a href="#h35-2-161" id="h35-2-161" class="d">-                    ) {
</a><a href="#h35-2-162" id="h35-2-162" class="d">-                        var value by remember { mutableFloatStateOf(operaViewerParamsOverride.currentPlaybackRate) }
</a><a href="#h35-2-163" id="h35-2-163" class="d">-                        Slider(
</a><a href="#h35-2-164" id="h35-2-164" class="d">-                            value = value,
</a><a href="#h35-2-165" id="h35-2-165" class="d">-                            onValueChange = {
</a><a href="#h35-2-166" id="h35-2-166" class="d">-                                value = it
</a><a href="#h35-2-167" id="h35-2-167" class="d">-                                operaViewerParamsOverride.currentPlaybackRate = it
</a><a href="#h35-2-168" id="h35-2-168" class="d">-                            },
</a><a href="#h35-2-169" id="h35-2-169" class="d">-                            valueRange = 0.1F..4.0F,
</a><a href="#h35-2-170" id="h35-2-170" class="d">-                            steps = 0,
</a><a href="#h35-2-171" id="h35-2-171" class="d">-                            modifier = Modifier.fillMaxWidth()
</a><a href="#h35-2-172" id="h35-2-172" class="d">-                        )
</a><a href="#h35-2-173" id="h35-2-173" class="d">-                        Text(
</a><a href="#h35-2-174" id="h35-2-174" class="d">-                            text = &quot;x&quot; + value.toString().take(4),
</a><a href="#h35-2-175" id="h35-2-175" class="d">-                            color = remember {
</a><a href="#h35-2-176" id="h35-2-176" class="d">-                                view.context.theme.obtainStyledAttributes(
</a><a href="#h35-2-177" id="h35-2-177" class="d">-                                    intArrayOf(view.context.resources.getIdentifier(&quot;sigColorTextPrimary&quot;, &quot;attr&quot;))
</a><a href="#h35-2-178" id="h35-2-178" class="d">-                                ).use { Color(it.getColor(0, 0)) }
</a><a href="#h35-2-179" id="h35-2-179" class="d">-                            },
</a><a href="#h35-2-180" id="h35-2-180" class="d">-                            textAlign = TextAlign.Center,
</a><a href="#h35-2-181" id="h35-2-181" class="d">-                            modifier = Modifier.fillMaxWidth()
</a><a href="#h35-2-182" id="h35-2-182" class="d">-                        )
</a><a href="#h35-2-183" id="h35-2-183" class="d">-                    }
</a><a href="#h35-2-184" id="h35-2-184" class="d">-                }.apply {
</a><a href="#h35-2-185" id="h35-2-185" class="d">-                    layoutParams = ViewGroup.LayoutParams(
</a><a href="#h35-2-186" id="h35-2-186" class="d">-                        ViewGroup.LayoutParams.MATCH_PARENT,
</a><a href="#h35-2-187" id="h35-2-187" class="d">-                        ViewGroup.LayoutParams.WRAP_CONTENT
</a><a href="#h35-2-188" id="h35-2-188" class="d">-                    )
</a><a href="#h35-2-189" id="h35-2-189" class="i">+            if (stringBuilder.isNotEmpty()) {
</a><a href="#h35-2-190" id="h35-2-190" class="i">+                linearLayout.addView(TextView(view.context).apply {
</a><a href="#h35-2-191" id="h35-2-191" class="i">+                    text = stringBuilder.toString()
</a><a href="#h35-2-192" id="h35-2-192" class="i">+                    setPadding(40, 10, 0, 0)
</a>                 })
             }
<a href="#h35-2-195" id="h35-2-195" class="i">+        }
</a> 
<a href="#h35-2-197" id="h35-2-197" class="d">-            if (context.config.downloader.downloadContextMenu.get()) {
</a><a href="#h35-2-198" id="h35-2-198" class="d">-                linearLayout.addView(Button(view.context).apply {
</a><a href="#h35-2-199" id="h35-2-199" class="d">-                    text = translation[&quot;download&quot;]
</a><a href="#h35-2-200" id="h35-2-200" class="d">-                    setOnClickListener {
</a><a href="#h35-2-201" id="h35-2-201" class="d">-                        mediaDownloader.downloadLastOperaMediaAsync(allowDuplicate = false)
</a><a href="#h35-2-202" id="h35-2-202" class="d">-                        parentView.triggerCloseTouchEvent()
</a><a href="#h35-2-203" id="h35-2-203" class="d">-                    }
</a><a href="#h35-2-204" id="h35-2-204" class="d">-                    setOnLongClickListener {
</a><a href="#h35-2-205" id="h35-2-205" class="d">-                        context.vibrateLongPress()
</a><a href="#h35-2-206" id="h35-2-206" class="d">-                        mediaDownloader.downloadLastOperaMediaAsync(allowDuplicate = true)
</a><a href="#h35-2-207" id="h35-2-207" class="d">-                        parentView.triggerCloseTouchEvent()
</a><a href="#h35-2-208" id="h35-2-208" class="d">-                        true
</a><a href="#h35-2-209" id="h35-2-209" class="d">-                    }
</a><a href="#h35-2-210" id="h35-2-210" class="d">-                    applyTheme(isAmoled = false)
</a><a href="#h35-2-211" id="h35-2-211" class="d">-                })
</a><a href="#h35-2-212" id="h35-2-212" class="d">-            }
</a><a href="#h35-2-213" id="h35-2-213" class="i">+        if (context.config.global.videoPlaybackRateSlider.get()) {
</a><a href="#h35-2-214" id="h35-2-214" class="i">+            val operaViewerParamsOverride = context.feature(OperaViewerParamsOverride::class)
</a> 
<a href="#h35-2-216" id="h35-2-216" class="d">-            if (context.isDeveloper) {
</a><a href="#h35-2-217" id="h35-2-217" class="d">-                linearLayout.addView(Button(view.context).apply {
</a><a href="#h35-2-218" id="h35-2-218" class="d">-                    text = translation[&quot;show_debug_info&quot;]
</a><a href="#h35-2-219" id="h35-2-219" class="d">-                    setOnClickListener { mediaDownloader.showLastOperaDebugMediaInfo() }
</a><a href="#h35-2-220" id="h35-2-220" class="d">-                    applyTheme(isAmoled = false)
</a><a href="#h35-2-221" id="h35-2-221" class="d">-                })
</a><a href="#h35-2-222" id="h35-2-222" class="d">-            }
</a><a href="#h35-2-223" id="h35-2-223" class="i">+            linearLayout.addView(createComposeView(view.context) {
</a><a href="#h35-2-224" id="h35-2-224" class="i">+                Column(
</a><a href="#h35-2-225" id="h35-2-225" class="i">+                    modifier = Modifier
</a><a href="#h35-2-226" id="h35-2-226" class="i">+                        .fillMaxWidth()
</a><a href="#h35-2-227" id="h35-2-227" class="i">+                        .padding(10.dp)
</a><a href="#h35-2-228" id="h35-2-228" class="i">+                ) {
</a><a href="#h35-2-229" id="h35-2-229" class="i">+                    var value by remember { mutableFloatStateOf(operaViewerParamsOverride.currentPlaybackRate) }
</a><a href="#h35-2-230" id="h35-2-230" class="i">+                    Slider(
</a><a href="#h35-2-231" id="h35-2-231" class="i">+                        value = value,
</a><a href="#h35-2-232" id="h35-2-232" class="i">+                        onValueChange = {
</a><a href="#h35-2-233" id="h35-2-233" class="i">+                            value = it
</a><a href="#h35-2-234" id="h35-2-234" class="i">+                            operaViewerParamsOverride.currentPlaybackRate = it
</a><a href="#h35-2-235" id="h35-2-235" class="i">+                        },
</a><a href="#h35-2-236" id="h35-2-236" class="i">+                        valueRange = 0.1F..4.0F,
</a><a href="#h35-2-237" id="h35-2-237" class="i">+                        steps = 0,
</a><a href="#h35-2-238" id="h35-2-238" class="i">+                        modifier = Modifier.fillMaxWidth()
</a><a href="#h35-2-239" id="h35-2-239" class="i">+                    )
</a><a href="#h35-2-240" id="h35-2-240" class="i">+                    Text(
</a><a href="#h35-2-241" id="h35-2-241" class="i">+                        text = &quot;x&quot; + value.toString().take(4),
</a><a href="#h35-2-242" id="h35-2-242" class="i">+                        color = remember {
</a><a href="#h35-2-243" id="h35-2-243" class="i">+                            Color(context.userInterface.colorPrimary)
</a><a href="#h35-2-244" id="h35-2-244" class="i">+                        },
</a><a href="#h35-2-245" id="h35-2-245" class="i">+                        textAlign = TextAlign.Center,
</a><a href="#h35-2-246" id="h35-2-246" class="i">+                        modifier = Modifier.fillMaxWidth()
</a><a href="#h35-2-247" id="h35-2-247" class="i">+                    )
</a><a href="#h35-2-248" id="h35-2-248" class="i">+                }
</a><a href="#h35-2-249" id="h35-2-249" class="i">+            }.apply {
</a><a href="#h35-2-250" id="h35-2-250" class="i">+                layoutParams = ViewGroup.LayoutParams(
</a><a href="#h35-2-251" id="h35-2-251" class="i">+                    ViewGroup.LayoutParams.MATCH_PARENT,
</a><a href="#h35-2-252" id="h35-2-252" class="i">+                    ViewGroup.LayoutParams.WRAP_CONTENT
</a><a href="#h35-2-253" id="h35-2-253" class="i">+                )
</a><a href="#h35-2-254" id="h35-2-254" class="i">+            })
</a><a href="#h35-2-255" id="h35-2-255" class="i">+        }
</a> 
<a href="#h35-2-257" id="h35-2-257" class="d">-            (view as ViewGroup).addView(linearLayout, 0)
</a><a href="#h35-2-258" id="h35-2-258" class="d">-        } catch (e: Throwable) {
</a><a href="#h35-2-259" id="h35-2-259" class="d">-            context.log.error(&quot;Error while injecting OperaContextActionMenu&quot;, e)
</a><a href="#h35-2-260" id="h35-2-260" class="i">+        if (context.config.downloader.downloadContextMenu.get()) {
</a><a href="#h35-2-261" id="h35-2-261" class="i">+            linearLayout.addView(Button(view.context).apply {
</a><a href="#h35-2-262" id="h35-2-262" class="i">+                text = translation[&quot;download&quot;]
</a><a href="#h35-2-263" id="h35-2-263" class="i">+                setOnClickListener {
</a><a href="#h35-2-264" id="h35-2-264" class="i">+                    mediaDownloader.downloadLastOperaMediaAsync(allowDuplicate = false)
</a><a href="#h35-2-265" id="h35-2-265" class="i">+                    parentView.triggerCloseTouchEvent()
</a><a href="#h35-2-266" id="h35-2-266" class="i">+                }
</a><a href="#h35-2-267" id="h35-2-267" class="i">+                setOnLongClickListener {
</a><a href="#h35-2-268" id="h35-2-268" class="i">+                    context.vibrateLongPress()
</a><a href="#h35-2-269" id="h35-2-269" class="i">+                    mediaDownloader.downloadLastOperaMediaAsync(allowDuplicate = true)
</a><a href="#h35-2-270" id="h35-2-270" class="i">+                    parentView.triggerCloseTouchEvent()
</a><a href="#h35-2-271" id="h35-2-271" class="i">+                    true
</a><a href="#h35-2-272" id="h35-2-272" class="i">+                }
</a><a href="#h35-2-273" id="h35-2-273" class="i">+                this@OperaContextActionMenu.context.userInterface.applyActionButtonTheme(this)
</a><a href="#h35-2-274" id="h35-2-274" class="i">+            })
</a>         }
<a href="#h35-2-276" id="h35-2-276" class="i">+
</a><a href="#h35-2-277" id="h35-2-277" class="i">+        if (context.isDeveloper) {
</a><a href="#h35-2-278" id="h35-2-278" class="i">+            linearLayout.addView(Button(view.context).apply {
</a><a href="#h35-2-279" id="h35-2-279" class="i">+                text = translation[&quot;show_debug_info&quot;]
</a><a href="#h35-2-280" id="h35-2-280" class="i">+                setOnClickListener { mediaDownloader.showLastOperaDebugMediaInfo() }
</a><a href="#h35-2-281" id="h35-2-281" class="i">+                this@OperaContextActionMenu.context.userInterface.applyActionButtonTheme(this)
</a><a href="#h35-2-282" id="h35-2-282" class="i">+            })
</a><a href="#h35-2-283" id="h35-2-283" class="i">+        }
</a><a href="#h35-2-284" id="h35-2-284" class="i">+
</a><a href="#h35-2-285" id="h35-2-285" class="i">+        (view as? ViewGroup)?.addView(linearLayout, 0)
</a>     }
 }
<b>diff --git a/<a id="h36" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/OperaViewerIcons.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/OperaViewerIcons.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/OperaViewerIcons.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/OperaViewerIcons.kt</a></b>
<a href="#h36-0" id="h36-0" class="h">@@ -1,6 +1,5 @@
</a> package me.rhunk.snapenhance.core.ui.menu.impl
 
<a href="#h36-0-2" id="h36-0-2" class="d">-import android.graphics.Color
</a> import android.view.Gravity
 import android.view.View
 import android.view.ViewGroup
<a href="#h36-1" id="h36-1" class="h">@@ -9,32 +8,46 @@ import android.widget.ImageView
</a> import android.widget.LinearLayout
 import androidx.compose.material.icons.Icons
 import androidx.compose.material.icons.filled.Info
<a href="#h36-1-3" id="h36-1-3" class="i">+import androidx.compose.material.icons.filled.RemoveRedEye
</a><a href="#h36-1-4" id="h36-1-4" class="i">+import androidx.compose.material.icons.outlined.Download
</a><a href="#h36-1-5" id="h36-1-5" class="i">+import androidx.compose.material3.Icon
</a><a href="#h36-1-6" id="h36-1-6" class="i">+import androidx.compose.ui.graphics.Color
</a> import kotlinx.coroutines.Dispatchers
 import kotlinx.coroutines.delay
 import kotlinx.coroutines.launch
 import kotlinx.coroutines.withContext
<a href="#h36-1-11" id="h36-1-11" class="i">+import me.rhunk.snapenhance.common.ui.createComposeView
</a><a href="#h36-1-12" id="h36-1-12" class="i">+import me.rhunk.snapenhance.core.event.events.impl.AddViewEvent
</a> import me.rhunk.snapenhance.core.features.impl.downloader.MediaDownloader
 import me.rhunk.snapenhance.core.features.impl.messaging.AutoMarkAsRead
 import me.rhunk.snapenhance.core.ui.children
 import me.rhunk.snapenhance.core.ui.iterateParent
 import me.rhunk.snapenhance.core.ui.menu.AbstractMenu
 import me.rhunk.snapenhance.core.ui.triggerCloseTouchEvent
<a href="#h36-1-19" id="h36-1-19" class="d">-import me.rhunk.snapenhance.core.util.ktx.getDimens
</a><a href="#h36-1-20" id="h36-1-20" class="d">-import me.rhunk.snapenhance.core.util.ktx.getDrawable
</a> import me.rhunk.snapenhance.core.util.ktx.vibrateLongPress
 
 class OperaViewerIcons : AbstractMenu() {
<a href="#h36-1-24" id="h36-1-24" class="d">-    private val downloadSvgDrawable by lazy { context.resources.getDrawable(&quot;svg_download&quot;, context.androidContext.theme) }
</a><a href="#h36-1-25" id="h36-1-25" class="d">-    private val eyeSvgDrawable by lazy { context.resources.getDrawable(&quot;svg_eye_24x24&quot;, context.androidContext.theme) }
</a><a href="#h36-1-26" id="h36-1-26" class="d">-    private val actionMenuIconSize by lazy { context.resources.getDimens(&quot;action_menu_icon_size&quot;) }
</a><a href="#h36-1-27" id="h36-1-27" class="d">-    private val actionMenuIconMargin by lazy { context.resources.getDimens(&quot;action_menu_icon_margin&quot;) }
</a><a href="#h36-1-28" id="h36-1-28" class="d">-    private val actionMenuIconMarginTop by lazy { context.resources.getDimens(&quot;action_menu_icon_margin_top&quot;) }
</a><a href="#h36-1-29" id="h36-1-29" class="i">+    private val actionMenuIconSize by lazy { context.userInterface.dpToPx(32) }
</a><a href="#h36-1-30" id="h36-1-30" class="i">+    private val actionMenuIconMargin by lazy { context.userInterface.dpToPx(5) }
</a><a href="#h36-1-31" id="h36-1-31" class="i">+    private val actionMenuIconMarginTop by lazy { context.userInterface.dpToPx(10) }
</a> 
<a href="#h36-1-33" id="h36-1-33" class="d">-    override fun inject(parent: ViewGroup, view: View, viewConsumer: (View) -&gt; Unit) {
</a><a href="#h36-1-34" id="h36-1-34" class="i">+    override fun onViewAdded(event: AddViewEvent) {
</a><a href="#h36-1-35" id="h36-1-35" class="i">+        if (event.view is FrameLayout &amp;&amp; event.parent.javaClass.superclass?.name?.endsWith(&quot;OpenLayout&quot;) == true) {
</a><a href="#h36-1-36" id="h36-1-36" class="i">+            val viewGroup = event.view as? ViewGroup ?: return
</a><a href="#h36-1-37" id="h36-1-37" class="i">+            if (
</a><a href="#h36-1-38" id="h36-1-38" class="i">+                viewGroup.childCount == 0 ||
</a><a href="#h36-1-39" id="h36-1-39" class="i">+                viewGroup.children().any { it !is ImageView } ||
</a><a href="#h36-1-40" id="h36-1-40" class="i">+                event.parent.children().none { it.javaClass.name.endsWith(&quot;ScalableCircleMaskFrameLayout&quot;) }
</a><a href="#h36-1-41" id="h36-1-41" class="i">+            ) return
</a><a href="#h36-1-42" id="h36-1-42" class="i">+            inject(viewGroup)
</a><a href="#h36-1-43" id="h36-1-43" class="i">+        }
</a><a href="#h36-1-44" id="h36-1-44" class="i">+    }
</a><a href="#h36-1-45" id="h36-1-45" class="i">+
</a><a href="#h36-1-46" id="h36-1-46" class="i">+    private fun inject(parent: ViewGroup) {
</a>         val mediaDownloader = context.feature(MediaDownloader::class)
 
         if (context.config.downloader.operaDownloadButton.get()) {
<a href="#h36-1-50" id="h36-1-50" class="d">-            parent.addView(LinearLayout(view.context).apply {
</a><a href="#h36-1-51" id="h36-1-51" class="i">+            parent.addView(LinearLayout(parent.context).apply {
</a>                 orientation = LinearLayout.VERTICAL
                 layoutParams = FrameLayout.LayoutParams(
                     FrameLayout.LayoutParams.WRAP_CONTENT,
<a href="#h36-2" id="h36-2" class="h">@@ -58,15 +71,13 @@ class OperaViewerIcons : AbstractMenu() {
</a>                     override fun onViewDetachedFromWindow(v: View) {}
                 })
 
<a href="#h36-2-3" id="h36-2-3" class="d">-                addView(ImageView(view.context).apply {
</a><a href="#h36-2-4" id="h36-2-4" class="d">-                    setImageDrawable(downloadSvgDrawable)
</a><a href="#h36-2-5" id="h36-2-5" class="d">-                    setColorFilter(Color.WHITE)
</a><a href="#h36-2-6" id="h36-2-6" class="d">-                    layoutParams = LinearLayout.LayoutParams(
</a><a href="#h36-2-7" id="h36-2-7" class="d">-                        actionMenuIconSize,
</a><a href="#h36-2-8" id="h36-2-8" class="d">-                        actionMenuIconSize
</a><a href="#h36-2-9" id="h36-2-9" class="d">-                    ).apply {
</a><a href="#h36-2-10" id="h36-2-10" class="d">-                        setMargins(0, 0, 0, actionMenuIconMargin * 2)
</a><a href="#h36-2-11" id="h36-2-11" class="d">-                    }
</a><a href="#h36-2-12" id="h36-2-12" class="i">+                addView(createComposeView(parent.context) {
</a><a href="#h36-2-13" id="h36-2-13" class="i">+                    Icon(
</a><a href="#h36-2-14" id="h36-2-14" class="i">+                        imageVector = Icons.Outlined.Download,
</a><a href="#h36-2-15" id="h36-2-15" class="i">+                        tint = Color.White,
</a><a href="#h36-2-16" id="h36-2-16" class="i">+                        contentDescription = null
</a><a href="#h36-2-17" id="h36-2-17" class="i">+                    )
</a><a href="#h36-2-18" id="h36-2-18" class="i">+                }.apply {
</a>                     setOnClickListener {
                         mediaDownloader.downloadLastOperaMediaAsync(allowDuplicate = false)
                     }
<a href="#h36-3" id="h36-3" class="h">@@ -75,9 +86,14 @@ class OperaViewerIcons : AbstractMenu() {
</a>                         mediaDownloader.downloadLastOperaMediaAsync(allowDuplicate = true)
                         true
                     }
<a href="#h36-3-3" id="h36-3-3" class="i">+                    layoutParams = LinearLayout.LayoutParams(
</a><a href="#h36-3-4" id="h36-3-4" class="i">+                        actionMenuIconSize,
</a><a href="#h36-3-5" id="h36-3-5" class="i">+                        actionMenuIconSize
</a><a href="#h36-3-6" id="h36-3-6" class="i">+                    ).apply {
</a><a href="#h36-3-7" id="h36-3-7" class="i">+                        setMargins(0, 0, 0, actionMenuIconMargin * 2)
</a><a href="#h36-3-8" id="h36-3-8" class="i">+                    }
</a>                 })
             }, 0)
<a href="#h36-3-11" id="h36-3-11" class="d">-
</a>         }
 
         if (context.config.messaging.markSnapAsSeenButton.get()) {
<a href="#h36-4" id="h36-4" class="h">@@ -89,28 +105,13 @@ class OperaViewerIcons : AbstractMenu() {
</a>                     ?.let { return it[0] to it[2] }
             }
 
<a href="#h36-4-3" id="h36-4-3" class="d">-            parent.addView(ImageView(view.context).apply {
</a><a href="#h36-4-4" id="h36-4-4" class="d">-                setImageDrawable(eyeSvgDrawable)
</a><a href="#h36-4-5" id="h36-4-5" class="d">-                setColorFilter(Color.WHITE)
</a><a href="#h36-4-6" id="h36-4-6" class="d">-                addOnAttachStateChangeListener(object: View.OnAttachStateChangeListener {
</a><a href="#h36-4-7" id="h36-4-7" class="d">-                    override fun onViewAttachedToWindow(v: View) {
</a><a href="#h36-4-8" id="h36-4-8" class="d">-                        v.visibility = View.GONE
</a><a href="#h36-4-9" id="h36-4-9" class="d">-                        this@OperaViewerIcons.context.coroutineScope.launch(Dispatchers.Main) {
</a><a href="#h36-4-10" id="h36-4-10" class="d">-                            delay(300)
</a><a href="#h36-4-11" id="h36-4-11" class="d">-                            v.visibility = if (getMessageId() != null) View.VISIBLE else View.GONE
</a><a href="#h36-4-12" id="h36-4-12" class="d">-                        }
</a><a href="#h36-4-13" id="h36-4-13" class="d">-                    }
</a><a href="#h36-4-14" id="h36-4-14" class="d">-                    override fun onViewDetachedFromWindow(v: View) {}
</a><a href="#h36-4-15" id="h36-4-15" class="d">-                })
</a><a href="#h36-4-16" id="h36-4-16" class="d">-                layoutParams = FrameLayout.LayoutParams(
</a><a href="#h36-4-17" id="h36-4-17" class="d">-                    (actionMenuIconSize * 1.4).toInt(),
</a><a href="#h36-4-18" id="h36-4-18" class="d">-                    (actionMenuIconSize * 1.4).toInt()
</a><a href="#h36-4-19" id="h36-4-19" class="d">-                ).apply {
</a><a href="#h36-4-20" id="h36-4-20" class="d">-                    setMargins(0, 0, 0, actionMenuIconMarginTop * 2 + (80 * context.resources.displayMetrics.density).toInt())
</a><a href="#h36-4-21" id="h36-4-21" class="d">-                    marginEnd = actionMenuIconMarginTop * 2
</a><a href="#h36-4-22" id="h36-4-22" class="d">-                    marginStart = actionMenuIconMarginTop * 2
</a><a href="#h36-4-23" id="h36-4-23" class="d">-                    gravity = Gravity.BOTTOM or Gravity.END
</a><a href="#h36-4-24" id="h36-4-24" class="d">-                }
</a><a href="#h36-4-25" id="h36-4-25" class="i">+            parent.addView(createComposeView(parent.context)  {
</a><a href="#h36-4-26" id="h36-4-26" class="i">+                Icon(
</a><a href="#h36-4-27" id="h36-4-27" class="i">+                    imageVector = Icons.Default.RemoveRedEye,
</a><a href="#h36-4-28" id="h36-4-28" class="i">+                    tint = Color.White,
</a><a href="#h36-4-29" id="h36-4-29" class="i">+                    contentDescription = null
</a><a href="#h36-4-30" id="h36-4-30" class="i">+                )
</a><a href="#h36-4-31" id="h36-4-31" class="i">+            }.apply {
</a>                 setOnClickListener {
                     this@OperaViewerIcons.context.apply {
                         coroutineScope.launch {
<a href="#h36-5" id="h36-5" class="h">@@ -144,7 +145,28 @@ class OperaViewerIcons : AbstractMenu() {
</a>                         }
                     }
                 }
<a href="#h36-5-3" id="h36-5-3" class="d">-            }, 0)
</a><a href="#h36-5-4" id="h36-5-4" class="i">+
</a><a href="#h36-5-5" id="h36-5-5" class="i">+                addOnAttachStateChangeListener(object: View.OnAttachStateChangeListener {
</a><a href="#h36-5-6" id="h36-5-6" class="i">+                    override fun onViewAttachedToWindow(v: View) {
</a><a href="#h36-5-7" id="h36-5-7" class="i">+                        v.visibility = View.GONE
</a><a href="#h36-5-8" id="h36-5-8" class="i">+                        this@OperaViewerIcons.context.coroutineScope.launch(Dispatchers.Main) {
</a><a href="#h36-5-9" id="h36-5-9" class="i">+                            delay(250)
</a><a href="#h36-5-10" id="h36-5-10" class="i">+                            v.visibility = if (getMessageId() != null) View.VISIBLE else View.GONE
</a><a href="#h36-5-11" id="h36-5-11" class="i">+                        }
</a><a href="#h36-5-12" id="h36-5-12" class="i">+                    }
</a><a href="#h36-5-13" id="h36-5-13" class="i">+                    override fun onViewDetachedFromWindow(v: View) {}
</a><a href="#h36-5-14" id="h36-5-14" class="i">+                })
</a><a href="#h36-5-15" id="h36-5-15" class="i">+
</a><a href="#h36-5-16" id="h36-5-16" class="i">+                layoutParams = FrameLayout.LayoutParams(
</a><a href="#h36-5-17" id="h36-5-17" class="i">+                    (actionMenuIconSize * 1.5).toInt(),
</a><a href="#h36-5-18" id="h36-5-18" class="i">+                    (actionMenuIconSize * 1.5).toInt()
</a><a href="#h36-5-19" id="h36-5-19" class="i">+                ).apply {
</a><a href="#h36-5-20" id="h36-5-20" class="i">+                    setMargins(0, 0, 0, actionMenuIconMarginTop * 2 + this@OperaViewerIcons.context.userInterface.dpToPx(80))
</a><a href="#h36-5-21" id="h36-5-21" class="i">+                    marginEnd = actionMenuIconMarginTop * 2
</a><a href="#h36-5-22" id="h36-5-22" class="i">+                    marginStart = actionMenuIconMarginTop * 2
</a><a href="#h36-5-23" id="h36-5-23" class="i">+                    gravity = Gravity.BOTTOM or Gravity.END
</a><a href="#h36-5-24" id="h36-5-24" class="i">+                }
</a><a href="#h36-5-25" id="h36-5-25" class="i">+            })
</a>         }
     }
 } 
\ No newline at end of file
<b>diff --git a/<a id="h37" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/SettingsGearInjector.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/SettingsGearInjector.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/SettingsGearInjector.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/SettingsGearInjector.kt</a></b>
<a href="#h37-0" id="h37-0" class="h">@@ -1,77 +0,0 @@
</a><a href="#h37-0-0" id="h37-0-0" class="d">-package me.rhunk.snapenhance.core.ui.menu.impl
</a><a href="#h37-0-1" id="h37-0-1" class="d">-
</a><a href="#h37-0-2" id="h37-0-2" class="d">-import android.annotation.SuppressLint
</a><a href="#h37-0-3" id="h37-0-3" class="d">-import android.view.View
</a><a href="#h37-0-4" id="h37-0-4" class="d">-import android.view.ViewGroup
</a><a href="#h37-0-5" id="h37-0-5" class="d">-import android.widget.FrameLayout
</a><a href="#h37-0-6" id="h37-0-6" class="d">-import android.widget.ImageView
</a><a href="#h37-0-7" id="h37-0-7" class="d">-import androidx.core.content.res.use
</a><a href="#h37-0-8" id="h37-0-8" class="d">-import me.rhunk.snapenhance.common.ui.OverlayType
</a><a href="#h37-0-9" id="h37-0-9" class="d">-import me.rhunk.snapenhance.core.ui.menu.AbstractMenu
</a><a href="#h37-0-10" id="h37-0-10" class="d">-import me.rhunk.snapenhance.core.util.ktx.getDimens
</a><a href="#h37-0-11" id="h37-0-11" class="d">-import me.rhunk.snapenhance.core.util.ktx.getDrawable
</a><a href="#h37-0-12" id="h37-0-12" class="d">-import me.rhunk.snapenhance.core.util.ktx.getId
</a><a href="#h37-0-13" id="h37-0-13" class="d">-import me.rhunk.snapenhance.core.util.ktx.getStyledAttributes
</a><a href="#h37-0-14" id="h37-0-14" class="d">-
</a><a href="#h37-0-15" id="h37-0-15" class="d">-
</a><a href="#h37-0-16" id="h37-0-16" class="d">-@SuppressLint(&quot;DiscouragedApi&quot;)
</a><a href="#h37-0-17" id="h37-0-17" class="d">-class SettingsGearInjector : AbstractMenu() {
</a><a href="#h37-0-18" id="h37-0-18" class="d">-    override fun inject(parent: ViewGroup, view: View, viewConsumer: (View) -&gt; Unit) {
</a><a href="#h37-0-19" id="h37-0-19" class="d">-        if (context.config.userInterface.hideSettingsGear.get()) return
</a><a href="#h37-0-20" id="h37-0-20" class="d">-        val hovaNavMapIcon = parent.findViewById&lt;View&gt;(context.resources.getId(&quot;hova_nav_map_icon&quot;))
</a><a href="#h37-0-21" id="h37-0-21" class="d">-        val firstView = hovaNavMapIcon ?: (view as ViewGroup).getChildAt(0)
</a><a href="#h37-0-22" id="h37-0-22" class="d">-
</a><a href="#h37-0-23" id="h37-0-23" class="d">-        val ngsHovaHeaderSearchIconBackgroundMarginLeft = context.resources.getDimens(&quot;ngs_hova_header_search_icon_background_margin_left&quot;)
</a><a href="#h37-0-24" id="h37-0-24" class="d">-
</a><a href="#h37-0-25" id="h37-0-25" class="d">-        (view as ViewGroup).clipChildren = false
</a><a href="#h37-0-26" id="h37-0-26" class="d">-        view.addView(FrameLayout(parent.context).apply {
</a><a href="#h37-0-27" id="h37-0-27" class="d">-            visibility = View.GONE
</a><a href="#h37-0-28" id="h37-0-28" class="d">-            post {
</a><a href="#h37-0-29" id="h37-0-29" class="d">-                layoutParams = FrameLayout.LayoutParams(firstView.layoutParams.width, firstView.layoutParams.height).apply {
</a><a href="#h37-0-30" id="h37-0-30" class="d">-                    y = 0f
</a><a href="#h37-0-31" id="h37-0-31" class="d">-                    // TODO: find a better way to calculate the x position with the correct padding when Simple Snapchat is active
</a><a href="#h37-0-32" id="h37-0-32" class="d">-                    x = -(ngsHovaHeaderSearchIconBackgroundMarginLeft + firstView.layoutParams.width).toFloat() +
</a><a href="#h37-0-33" id="h37-0-33" class="d">-                        (hovaNavMapIcon.takeIf { it != null }?.let {
</a><a href="#h37-0-34" id="h37-0-34" class="d">-                            7 * context.resources.displayMetrics.density
</a><a href="#h37-0-35" id="h37-0-35" class="d">-                        } ?: 0f)
</a><a href="#h37-0-36" id="h37-0-36" class="d">-                }
</a><a href="#h37-0-37" id="h37-0-37" class="d">-                visibility = View.VISIBLE
</a><a href="#h37-0-38" id="h37-0-38" class="d">-            }
</a><a href="#h37-0-39" id="h37-0-39" class="d">-
</a><a href="#h37-0-40" id="h37-0-40" class="d">-            isClickable = true
</a><a href="#h37-0-41" id="h37-0-41" class="d">-
</a><a href="#h37-0-42" id="h37-0-42" class="d">-            setOnClickListener {
</a><a href="#h37-0-43" id="h37-0-43" class="d">-                this@SettingsGearInjector.context.bridgeClient.openOverlay(OverlayType.SETTINGS)
</a><a href="#h37-0-44" id="h37-0-44" class="d">-            }
</a><a href="#h37-0-45" id="h37-0-45" class="d">-
</a><a href="#h37-0-46" id="h37-0-46" class="d">-            parent.setOnTouchListener { _, event -&gt;
</a><a href="#h37-0-47" id="h37-0-47" class="d">-                if (view.visibility == View.INVISIBLE || view.alpha == 0F) return@setOnTouchListener false
</a><a href="#h37-0-48" id="h37-0-48" class="d">-
</a><a href="#h37-0-49" id="h37-0-49" class="d">-                val viewLocation = IntArray(2)
</a><a href="#h37-0-50" id="h37-0-50" class="d">-                getLocationOnScreen(viewLocation)
</a><a href="#h37-0-51" id="h37-0-51" class="d">-
</a><a href="#h37-0-52" id="h37-0-52" class="d">-                val x = event.rawX - viewLocation[0]
</a><a href="#h37-0-53" id="h37-0-53" class="d">-                val y = event.rawY - viewLocation[1]
</a><a href="#h37-0-54" id="h37-0-54" class="d">-
</a><a href="#h37-0-55" id="h37-0-55" class="d">-                if (x &gt; 0 &amp;&amp; x &lt; width &amp;&amp; y &gt; 0 &amp;&amp; y &lt; height) {
</a><a href="#h37-0-56" id="h37-0-56" class="d">-                    performClick()
</a><a href="#h37-0-57" id="h37-0-57" class="d">-                }
</a><a href="#h37-0-58" id="h37-0-58" class="d">-
</a><a href="#h37-0-59" id="h37-0-59" class="d">-                false
</a><a href="#h37-0-60" id="h37-0-60" class="d">-            }
</a><a href="#h37-0-61" id="h37-0-61" class="d">-            backgroundTintList = firstView.backgroundTintList
</a><a href="#h37-0-62" id="h37-0-62" class="d">-            background = firstView.background
</a><a href="#h37-0-63" id="h37-0-63" class="d">-
</a><a href="#h37-0-64" id="h37-0-64" class="d">-            addView(ImageView(context).apply {
</a><a href="#h37-0-65" id="h37-0-65" class="d">-                layoutParams = FrameLayout.LayoutParams(ViewGroup.LayoutParams.WRAP_CONTENT, ViewGroup.LayoutParams.WRAP_CONTENT, 17).apply {
</a><a href="#h37-0-66" id="h37-0-66" class="d">-                    gravity = android.view.Gravity.CENTER
</a><a href="#h37-0-67" id="h37-0-67" class="d">-                }
</a><a href="#h37-0-68" id="h37-0-68" class="d">-                setImageDrawable(context.resources.getDrawable(&quot;svg_settings_32x32&quot;, context.theme))
</a><a href="#h37-0-69" id="h37-0-69" class="d">-                // TODO: find a better way to tint the icon when Simple Snapchat is active
</a><a href="#h37-0-70" id="h37-0-70" class="d">-                context.resources.getStyledAttributes(&quot;headerButtonOpaqueIconTint&quot;, context.theme).use {
</a><a href="#h37-0-71" id="h37-0-71" class="d">-                    imageTintList = it.getColorStateList(0)
</a><a href="#h37-0-72" id="h37-0-72" class="d">-                }
</a><a href="#h37-0-73" id="h37-0-73" class="d">-            })
</a><a href="#h37-0-74" id="h37-0-74" class="d">-        })
</a><a href="#h37-0-75" id="h37-0-75" class="d">-    }
</a><a href="#h37-0-76" id="h37-0-76" class="d">-}</a><a href="#h37-0-77" id="h37-0-77" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h38" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/SettingsMenu.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/SettingsMenu.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/SettingsMenu.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/ui/menu/impl/SettingsMenu.kt</a></b>
<a href="#h38-0" id="h38-0" class="h">@@ -1,6 +1,39 @@
</a> package me.rhunk.snapenhance.core.ui.menu.impl
 
<a href="#h38-0-2" id="h38-0-2" class="i">+import android.view.View
</a><a href="#h38-0-3" id="h38-0-3" class="i">+import android.widget.FrameLayout
</a><a href="#h38-0-4" id="h38-0-4" class="i">+import me.rhunk.snapenhance.common.ui.OverlayType
</a> import me.rhunk.snapenhance.core.ui.menu.AbstractMenu
<a href="#h38-0-6" id="h38-0-6" class="i">+import me.rhunk.snapenhance.core.util.hook.HookStage
</a><a href="#h38-0-7" id="h38-0-7" class="i">+import me.rhunk.snapenhance.core.util.hook.hook
</a><a href="#h38-0-8" id="h38-0-8" class="i">+import me.rhunk.snapenhance.core.util.ktx.getId
</a><a href="#h38-0-9" id="h38-0-9" class="i">+import me.rhunk.snapenhance.core.util.ktx.getIdentifier
</a> 
 class SettingsMenu : AbstractMenu() {
<a href="#h38-0-12" id="h38-0-12" class="i">+    private val hovaHeaderSearchIconId by lazy {
</a><a href="#h38-0-13" id="h38-0-13" class="i">+        context.resources.getId(&quot;hova_header_search_icon&quot;)
</a><a href="#h38-0-14" id="h38-0-14" class="i">+    }
</a><a href="#h38-0-15" id="h38-0-15" class="i">+
</a><a href="#h38-0-16" id="h38-0-16" class="i">+    private val ngsChatLabel by lazy {
</a><a href="#h38-0-17" id="h38-0-17" class="i">+        context.resources.run {
</a><a href="#h38-0-18" id="h38-0-18" class="i">+            getString(getIdentifier(&quot;ngs_chat_label&quot;, &quot;string&quot;))
</a><a href="#h38-0-19" id="h38-0-19" class="i">+        }
</a><a href="#h38-0-20" id="h38-0-20" class="i">+    }
</a><a href="#h38-0-21" id="h38-0-21" class="i">+
</a><a href="#h38-0-22" id="h38-0-22" class="i">+    override fun init() {
</a><a href="#h38-0-23" id="h38-0-23" class="i">+        context.androidContext.classLoader.loadClass(&quot;com.snap.ui.view.SnapFontTextView&quot;).hook(&quot;setText&quot;, HookStage.BEFORE) { param -&gt;
</a><a href="#h38-0-24" id="h38-0-24" class="i">+            val view = param.thisObject&lt;View&gt;()
</a><a href="#h38-0-25" id="h38-0-25" class="i">+            if ((view.parent as? FrameLayout)?.findViewById&lt;View&gt;(hovaHeaderSearchIconId) != null) {
</a><a href="#h38-0-26" id="h38-0-26" class="i">+                view.post {
</a><a href="#h38-0-27" id="h38-0-27" class="i">+                    view.setOnClickListener {
</a><a href="#h38-0-28" id="h38-0-28" class="i">+                        context.bridgeClient.openOverlay(OverlayType.SETTINGS)
</a><a href="#h38-0-29" id="h38-0-29" class="i">+                    }
</a><a href="#h38-0-30" id="h38-0-30" class="i">+                }
</a><a href="#h38-0-31" id="h38-0-31" class="i">+
</a><a href="#h38-0-32" id="h38-0-32" class="i">+                if (param.argNullable&lt;String&gt;(0) == ngsChatLabel) {
</a><a href="#h38-0-33" id="h38-0-33" class="i">+                    param.setArg(0, &quot;SnapEnhance&quot;)
</a><a href="#h38-0-34" id="h38-0-34" class="i">+                }
</a><a href="#h38-0-35" id="h38-0-35" class="i">+            }
</a><a href="#h38-0-36" id="h38-0-36" class="i">+        }
</a><a href="#h38-0-37" id="h38-0-37" class="i">+    }
</a> } 
\ No newline at end of file
<b>diff --git a/<a id="h39" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/util/ktx/AndroidExt.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/util/ktx/AndroidExt.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/util/ktx/AndroidExt.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/util/ktx/AndroidExt.kt</a></b>
<a href="#h39-0" id="h39-0" class="h">@@ -10,11 +10,19 @@ import android.os.VibrationEffect
</a> import android.os.Vibrator
 import androidx.core.graphics.ColorUtils
 import me.rhunk.snapenhance.common.Constants
<a href="#h39-0-3" id="h39-0-3" class="i">+import me.rhunk.snapenhance.common.logger.AbstractLogger
</a> 
<a href="#h39-0-5" id="h39-0-5" class="i">+val notFoundCache = mutableSetOf&lt;String&gt;()
</a> 
 @SuppressLint(&quot;DiscouragedApi&quot;)
 fun Resources.getIdentifier(name: String, type: String): Int {
<a href="#h39-0-9" id="h39-0-9" class="d">-    return getIdentifier(name, type, Constants.SNAPCHAT_PACKAGE_NAME)
</a><a href="#h39-0-10" id="h39-0-10" class="i">+    return getIdentifier(name, type, Constants.SNAPCHAT_PACKAGE_NAME).also { id -&gt;
</a><a href="#h39-0-11" id="h39-0-11" class="i">+        if (id != 0) return@also
</a><a href="#h39-0-12" id="h39-0-12" class="i">+        &quot;$type#$name&quot;.takeIf { it !in notFoundCache}?.let {
</a><a href="#h39-0-13" id="h39-0-13" class="i">+            AbstractLogger.directDebug(&quot;Resource not found: $it&quot;)
</a><a href="#h39-0-14" id="h39-0-14" class="i">+            notFoundCache.add(it)
</a><a href="#h39-0-15" id="h39-0-15" class="i">+        }
</a><a href="#h39-0-16" id="h39-0-16" class="i">+    }
</a> }
 
 fun Resources.getId(name: String): Int {
<a href="#h39-1" id="h39-1" class="h">@@ -48,11 +56,10 @@ fun Context.vibrateLongPress() {
</a>     getSystemService(Vibrator::class.java).vibrate(VibrationEffect.createOneShot(50, VibrationEffect.DEFAULT_AMPLITUDE))
 }
 
<a href="#h39-1-3" id="h39-1-3" class="d">-@SuppressLint(&quot;DiscouragedApi&quot;)
</a> fun Context.isDarkTheme(): Boolean {
     return theme.obtainStyledAttributes(
<a href="#h39-1-6" id="h39-1-6" class="d">-        intArrayOf(resources.getIdentifier(&quot;sigColorTextPrimary&quot;, &quot;attr&quot;, packageName))
</a><a href="#h39-1-7" id="h39-1-7" class="i">+        intArrayOf(android.R.attr.colorPrimary)
</a>     ).getColor(0, 0).let {
<a href="#h39-1-9" id="h39-1-9" class="d">-        ColorUtils.calculateLuminance(it) &gt; 0.5
</a><a href="#h39-1-10" id="h39-1-10" class="i">+        ColorUtils.calculateLuminance(it) &lt; 0.5
</a>     }
 } 
\ No newline at end of file
<b>diff --git a/<a id="h40" href="../file/mapper/src/main/kotlin/me/rhunk/snapenhance/mapper/AbstractClassMapper.kt.html">mapper/src/main/kotlin/me/rhunk/snapenhance/mapper/AbstractClassMapper.kt</a> b/<a href="../file/mapper/src/main/kotlin/me/rhunk/snapenhance/mapper/AbstractClassMapper.kt.html">mapper/src/main/kotlin/me/rhunk/snapenhance/mapper/AbstractClassMapper.kt</a></b>
<a href="#h40-0" id="h40-0" class="h">@@ -83,7 +83,8 @@ abstract class AbstractClassMapper(
</a>         }
     }
 
<a href="#h40-0-3" id="h40-0-3" class="d">-    fun writeFromJson(json: JsonObject) {
</a><a href="#h40-0-4" id="h40-0-4" class="i">+    fun writeFromJson(json: JsonObject): List&lt;String&gt; {
</a><a href="#h40-0-5" id="h40-0-5" class="i">+        val warns = mutableListOf&lt;String&gt;()
</a>         values.forEach { (key, value) -&gt;
             runCatching {
                 when (value) {
<a href="#h40-1" id="h40-1" class="h">@@ -95,7 +96,11 @@ abstract class AbstractClassMapper(
</a>             }.onFailure {
                 Log.e(&quot;Mapper&quot;,&quot;Failed to serialize property $key&quot;)
             }
<a href="#h40-1-3" id="h40-1-3" class="i">+            if (json.get(key).let { it.isJsonNull || (it.isJsonPrimitive &amp;&amp; it.asString == &quot;null&quot;) }) {
</a><a href="#h40-1-4" id="h40-1-4" class="i">+                warns.add(&quot;Failed to serialize property $key in $mapperName&quot;)
</a><a href="#h40-1-5" id="h40-1-5" class="i">+            }
</a>         }
<a href="#h40-1-7" id="h40-1-7" class="i">+        return warns
</a>     }
 
     fun mapper(task: MapperContext.() -&gt; Unit) {
<b>diff --git a/<a id="h41" href="../file/mapper/src/main/kotlin/me/rhunk/snapenhance/mapper/ClassMapper.kt.html">mapper/src/main/kotlin/me/rhunk/snapenhance/mapper/ClassMapper.kt</a> b/<a href="../file/mapper/src/main/kotlin/me/rhunk/snapenhance/mapper/ClassMapper.kt.html">mapper/src/main/kotlin/me/rhunk/snapenhance/mapper/ClassMapper.kt</a></b>
<a href="#h41-0" id="h41-0" class="h">@@ -17,6 +17,7 @@ class ClassMapper(
</a>     private vararg val mappers: AbstractClassMapper = DEFAULT_MAPPERS,
 ) {
     private val classes = mutableListOf&lt;ClassDef&gt;()
<a href="#h41-0-3" id="h41-0-3" class="i">+    private val warnings = mutableListOf&lt;String&gt;()
</a> 
     companion object {
         val DEFAULT_MAPPERS get() = arrayOf(
<a href="#h41-1" id="h41-1" class="h">@@ -73,6 +74,8 @@ class ClassMapper(
</a>         }
     }
 
<a href="#h41-1-3" id="h41-1-3" class="i">+    fun getWarns() = warnings
</a><a href="#h41-1-4" id="h41-1-4" class="i">+
</a>     suspend fun run(): JsonObject {
         val context = MapperContext(classes.associateBy { it.type })
 
<a href="#h41-2" id="h41-2" class="h">@@ -87,7 +90,7 @@ class ClassMapper(
</a>         val outputJson = JsonObject()
         mappers.forEach { mapper -&gt;
             outputJson.add(mapper.mapperName, JsonObject().apply {
<a href="#h41-2-3" id="h41-2-3" class="d">-                mapper.writeFromJson(this)
</a><a href="#h41-2-4" id="h41-2-4" class="i">+                warnings.addAll(mapper.writeFromJson(this))
</a>             })
         }
         return outputJson
<b>diff --git a/<a id="h42" href="../file/native/build.gradle.kts.html">native/build.gradle.kts</a> b/<a href="../file/native/build.gradle.kts.html">native/build.gradle.kts</a></b>
<a href="#h42-0" id="h42-0" class="h">@@ -11,7 +11,7 @@ android {
</a>     compileSdk = 34
 
     buildToolsVersion = &quot;34.0.0&quot;
<a href="#h42-0-3" id="h42-0-3" class="d">-    ndkVersion = &quot;26.3.11579264&quot;
</a><a href="#h42-0-4" id="h42-0-4" class="i">+    ndkVersion = &quot;27.0.12077973&quot;
</a> 
     buildFeatures {
         buildConfig = true
</pre>
</div>
</body>
</html>
