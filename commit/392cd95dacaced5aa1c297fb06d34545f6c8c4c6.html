<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>feat(scripting): module system - SnapEnhance - An Xposed module offering an enhanced Snapchat experience
</title>
<link rel="icon" type="image/svg+xml" href="../../logo.png"/>
<link rel="alternate icon" href="../../favicon.png"/>
<link rel="alternate" type="application/atom+xml" title="SnapEnhance Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="SnapEnhance Atom Feed (tags)" href="../tags.xml" />
<link rel="stylesheet" type="text/css" href="../../style.css" />
<link rel="stylesheet" type="text/css" href="../../fonts.css" />
</head>
<body>
<div id="head"><table><tr><td><a class="logo" href="../../"><img src="../../logo.png" alt="" width="32" height="32" /></a></td><td><strong>SnapEnhance</strong><span class="desc"> - An Xposed module offering an enhanced Snapchat experience
</span>
</td></tr></table>
<p><a href="../about.html">About</a> | <a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/LICENSE.html">License</a></p>
</div>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/392cd95dacaced5aa1c297fb06d34545f6c8c4c6.html">392cd95dacaced5aa1c297fb06d34545f6c8c4c6</a>
<b>parent</b> <a href="../commit/7d6978f9618283715a9341a748e8dc57e21aead7.html">7d6978f9618283715a9341a748e8dc57e21aead7</a>
<b>Author:</b> rhunk &lt;<a href="mailto:101876869+rhunk@users.noreply.github.com">101876869+rhunk@users.noreply.github.com</a>&gt;
<b>Date:</b>   Sun, 24 Dec 2023 17:29:19 +0100

feat(scripting): module system

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">app/src/main/kotlin/me/rhunk/snapenhance/RemoteSideContext.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">app/src/main/kotlin/me/rhunk/snapenhance/messaging/ModDatabase.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h2">app/src/main/kotlin/me/rhunk/snapenhance/scripting/RemoteScriptManager.kt</a></td><td> | </td><td class="num">38</td><td><span class="i">++++++++++++++++++++++++</span><span class="d">--------------</span></td></tr>
<tr><td class="A">A</td><td><a href="#h3">app/src/main/kotlin/me/rhunk/snapenhance/scripting/impl/ManagerIPC.kt</a></td><td> | </td><td class="num">52</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h4">app/src/main/kotlin/me/rhunk/snapenhance/scripting/impl/ManagerScriptConfig.kt</a></td><td> | </td><td class="num">58</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="D">D</td><td><a href="#h5">app/src/main/kotlin/me/rhunk/snapenhance/scripting/impl/RemoteManagerIPC.kt</a></td><td> | </td><td class="num">56</td><td><span class="i"></span><span class="d">--------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h6">app/src/main/kotlin/me/rhunk/snapenhance/scripting/impl/RemoteScriptConfig.kt</a></td><td> | </td><td class="num">58</td><td><span class="i"></span><span class="d">----------------------------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h7">app/src/main/kotlin/me/rhunk/snapenhance/scripting/impl/ui/InterfaceManager.kt</a></td><td> | </td><td class="num">26</td><td><span class="i">+++++++++++++++</span><span class="d">-----------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h8">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/scripting/ScriptsSection.kt</a></td><td> | </td><td class="num">43</td><td><span class="i">+++++++++++++++++++++++++++++++++++++</span><span class="d">------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h9">common/src/main/kotlin/me/rhunk/snapenhance/common/logger/LogChannel.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h10">common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/JSModule.kt</a></td><td> | </td><td class="num">81</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h11">common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/ScriptRuntime.kt</a></td><td> | </td><td class="num">29</td><td><span class="i">+++++++++++++++</span><span class="d">--------------</span></td></tr>
<tr><td class="A">A</td><td><a href="#h12">common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/ScriptingLogger.kt</a></td><td> | </td><td class="num">41</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h13">common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/bindings/AbstractBinding.kt</a></td><td> | </td><td class="num">15</td><td><span class="i">+++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h14">common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/bindings/BindingSide.kt</a></td><td> | </td><td class="num">16</td><td><span class="i">++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h15">common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/bindings/BindingsContext.kt</a></td><td> | </td><td class="num">10</td><td><span class="i">++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h16">common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/impl/ConfigInterface.kt</a></td><td> | </td><td class="num">9</td><td><span class="i">+++++++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h17">common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/impl/IPCInterface.kt</a></td><td> | </td><td class="num">12</td><td><span class="i">+++++++++</span><span class="d">---</span></td></tr>
<tr><td class="M">M</td><td><a href="#h18">common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/type/ModuleInfo.kt</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h19">core/src/main/kotlin/me/rhunk/snapenhance/core/SnapEnhance.kt</a></td><td> | </td><td class="num">6</td><td><span class="i">+++</span><span class="d">---</span></td></tr>
<tr><td class="M">M</td><td><a href="#h20">core/src/main/kotlin/me/rhunk/snapenhance/core/scripting/CoreScriptRuntime.kt</a></td><td> | </td><td class="num">15</td><td><span class="i">+++++++</span><span class="d">--------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h21">core/src/main/kotlin/me/rhunk/snapenhance/core/scripting/impl/CoreIPC.kt</a></td><td> | </td><td class="num">17</td><td><span class="i">++++++</span><span class="d">-----------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h22">core/src/main/kotlin/me/rhunk/snapenhance/core/scripting/impl/CoreScriptConfig.kt</a></td><td> | </td><td class="num">19</td><td><span class="i">+++++++</span><span class="d">------------</span></td></tr>
<tr><td class="A">A</td><td><a href="#h23">core/src/main/kotlin/me/rhunk/snapenhance/core/scripting/impl/CoreScriptHooker.kt</a></td><td> | </td><td class="num">169</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="D">D</td><td><a href="#h24">core/src/main/kotlin/me/rhunk/snapenhance/core/scripting/impl/ScriptHooker.kt</a></td><td> | </td><td class="num">162</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
</table></pre><pre>25 files changed, 565 insertions(+), 375 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/RemoteSideContext.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/RemoteSideContext.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/RemoteSideContext.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/RemoteSideContext.kt</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -118,7 +118,7 @@ class RemoteSideContext(
</a>         }
 
         scriptManager.runtime.eachModule {
<a href="#h0-0-3" id="h0-0-3" class="d">-            callFunction(&quot;module.onManagerLoad&quot;, androidContext)
</a><a href="#h0-0-4" id="h0-0-4" class="i">+            callFunction(&quot;module.onSnapEnhanceLoad&quot;, androidContext)
</a>         }
     }
 
<b>diff --git a/<a id="h1" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/messaging/ModDatabase.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/messaging/ModDatabase.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/messaging/ModDatabase.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/messaging/ModDatabase.kt</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -268,7 +268,7 @@ class ModDatabase(
</a>                         version = cursor.getStringOrNull(&quot;version&quot;)!!,
                         description = cursor.getStringOrNull(&quot;description&quot;),
                         author = cursor.getStringOrNull(&quot;author&quot;),
<a href="#h1-0-3" id="h1-0-3" class="d">-                        grantPermissions = null
</a><a href="#h1-0-4" id="h1-0-4" class="i">+                        grantedPermissions = emptyList()
</a>                     )
                 )
             }
<b>diff --git a/<a id="h2" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/scripting/RemoteScriptManager.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/scripting/RemoteScriptManager.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/scripting/RemoteScriptManager.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/scripting/RemoteScriptManager.kt</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -11,8 +11,8 @@ import me.rhunk.snapenhance.common.scripting.impl.ConfigInterface
</a> import me.rhunk.snapenhance.common.scripting.impl.ConfigTransactionType
 import me.rhunk.snapenhance.common.scripting.type.ModuleInfo
 import me.rhunk.snapenhance.scripting.impl.IPCListeners
<a href="#h2-0-3" id="h2-0-3" class="d">-import me.rhunk.snapenhance.scripting.impl.RemoteManagerIPC
</a><a href="#h2-0-4" id="h2-0-4" class="d">-import me.rhunk.snapenhance.scripting.impl.RemoteScriptConfig
</a><a href="#h2-0-5" id="h2-0-5" class="i">+import me.rhunk.snapenhance.scripting.impl.ManagerIPC
</a><a href="#h2-0-6" id="h2-0-6" class="i">+import me.rhunk.snapenhance.scripting.impl.ManagerScriptConfig
</a> import me.rhunk.snapenhance.scripting.impl.ui.InterfaceManager
 import java.io.File
 import java.io.InputStream
<a href="#h2-1" id="h2-1" class="h">@@ -21,7 +21,9 @@ import kotlin.system.exitProcess
</a> class RemoteScriptManager(
     val context: RemoteSideContext,
 ) : IScripting.Stub() {
<a href="#h2-1-3" id="h2-1-3" class="d">-    val runtime = ScriptRuntime(context.androidContext, context.log)
</a><a href="#h2-1-4" id="h2-1-4" class="i">+    val runtime = ScriptRuntime(context.androidContext, context.log).apply {
</a><a href="#h2-1-5" id="h2-1-5" class="i">+        scripting = this@RemoteScriptManager
</a><a href="#h2-1-6" id="h2-1-6" class="i">+    }
</a> 
     private var autoReloadListener: AutoReloadListener? = null
     private val autoReloadHandler by lazy {
<a href="#h2-2" id="h2-2" class="h">@@ -61,11 +63,11 @@ class RemoteScriptManager(
</a> 
     fun init() {
         runtime.buildModuleObject = { module -&gt;
<a href="#h2-2-3" id="h2-2-3" class="d">-            module.extras[&quot;ipc&quot;] = RemoteManagerIPC(module.moduleInfo, context.log, ipcListeners)
</a><a href="#h2-2-4" id="h2-2-4" class="d">-            module.extras[&quot;im&quot;] = InterfaceManager(module.moduleInfo, context.log)
</a><a href="#h2-2-5" id="h2-2-5" class="d">-            module.extras[&quot;config&quot;] = RemoteScriptConfig(this@RemoteScriptManager, module.moduleInfo, context.log).also {
</a><a href="#h2-2-6" id="h2-2-6" class="d">-                it.load()
</a><a href="#h2-2-7" id="h2-2-7" class="d">-            }
</a><a href="#h2-2-8" id="h2-2-8" class="i">+            module.registerBindings(
</a><a href="#h2-2-9" id="h2-2-9" class="i">+                ManagerIPC(ipcListeners),
</a><a href="#h2-2-10" id="h2-2-10" class="i">+                InterfaceManager(),
</a><a href="#h2-2-11" id="h2-2-11" class="i">+                ManagerScriptConfig(this@RemoteScriptManager)
</a><a href="#h2-2-12" id="h2-2-12" class="i">+            )
</a>         }
 
         sync()
<a href="#h2-3" id="h2-3" class="h">@@ -74,12 +76,20 @@ class RemoteScriptManager(
</a>         }
     }
 
<a href="#h2-3-3" id="h2-3-3" class="d">-    fun loadScript(name: String) {
</a><a href="#h2-3-4" id="h2-3-4" class="d">-        val content = getScriptContent(name) ?: return
</a><a href="#h2-3-5" id="h2-3-5" class="i">+    fun getModulePath(name: String): String? {
</a><a href="#h2-3-6" id="h2-3-6" class="i">+        return cachedModuleInfo.entries.find { it.value.name == name }?.key
</a><a href="#h2-3-7" id="h2-3-7" class="i">+    }
</a><a href="#h2-3-8" id="h2-3-8" class="i">+
</a><a href="#h2-3-9" id="h2-3-9" class="i">+    fun loadScript(path: String) {
</a><a href="#h2-3-10" id="h2-3-10" class="i">+        val content = getScriptContent(path) ?: return
</a>         if (context.config.root.scripting.autoReload.getNullable() != null) {
<a href="#h2-3-12" id="h2-3-12" class="d">-            autoReloadHandler.addFile(getScriptsFolder()?.findFile(name) ?: return)
</a><a href="#h2-3-13" id="h2-3-13" class="i">+            autoReloadHandler.addFile(getScriptsFolder()?.findFile(path) ?: return)
</a>         }
<a href="#h2-3-15" id="h2-3-15" class="d">-        runtime.load(name, content)
</a><a href="#h2-3-16" id="h2-3-16" class="i">+        runtime.load(path, content)
</a><a href="#h2-3-17" id="h2-3-17" class="i">+    }
</a><a href="#h2-3-18" id="h2-3-18" class="i">+
</a><a href="#h2-3-19" id="h2-3-19" class="i">+    fun unloadScript(scriptPath: String) {
</a><a href="#h2-3-20" id="h2-3-20" class="i">+        runtime.unload(scriptPath)
</a>     }
 
     private fun &lt;R&gt; getScriptInputStream(name: String, callback: (InputStream?) -&gt; R): R {
<a href="#h2-4" id="h2-4" class="h">@@ -140,7 +150,7 @@ class RemoteScriptManager(
</a>         value: String?,
         save: Boolean
     ): String? {
<a href="#h2-4-3" id="h2-4-3" class="d">-        val scriptConfig = runtime.getModuleByName(module ?: return null)?.extras?.get(&quot;config&quot;) as? ConfigInterface ?: return null.also {
</a><a href="#h2-4-4" id="h2-4-4" class="i">+        val scriptConfig = runtime.getModuleByName(module ?: return null)?.getBinding(ConfigInterface::class) ?: return null.also {
</a>             context.log.warn(&quot;Failed to get config interface for $module&quot;)
         }
         val transactionType = ConfigTransactionType.fromKey(action)
<a href="#h2-5" id="h2-5" class="h">@@ -154,7 +164,7 @@ class RemoteScriptManager(
</a>                     ConfigTransactionType.SET -&gt; set(key ?: return@runCatching null, value, save)
                     ConfigTransactionType.SAVE -&gt; save()
                     ConfigTransactionType.LOAD -&gt; load()
<a href="#h2-5-3" id="h2-5-3" class="d">-                    ConfigTransactionType.DELETE -&gt; delete()
</a><a href="#h2-5-4" id="h2-5-4" class="i">+                    ConfigTransactionType.DELETE -&gt; deleteConfig()
</a>                     else -&gt; {}
                 }
                 null
<b>diff --git a/<a id="h3" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/scripting/impl/ManagerIPC.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/scripting/impl/ManagerIPC.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/scripting/impl/ManagerIPC.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/scripting/impl/ManagerIPC.kt</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -0,0 +1,51 @@
</a><a href="#h3-0-0" id="h3-0-0" class="i">+package me.rhunk.snapenhance.scripting.impl
</a><a href="#h3-0-1" id="h3-0-1" class="i">+
</a><a href="#h3-0-2" id="h3-0-2" class="i">+import android.os.DeadObjectException
</a><a href="#h3-0-3" id="h3-0-3" class="i">+import me.rhunk.snapenhance.bridge.scripting.IPCListener
</a><a href="#h3-0-4" id="h3-0-4" class="i">+import me.rhunk.snapenhance.common.scripting.impl.IPCInterface
</a><a href="#h3-0-5" id="h3-0-5" class="i">+import me.rhunk.snapenhance.common.scripting.impl.Listener
</a><a href="#h3-0-6" id="h3-0-6" class="i">+import java.util.concurrent.ConcurrentHashMap
</a><a href="#h3-0-7" id="h3-0-7" class="i">+
</a><a href="#h3-0-8" id="h3-0-8" class="i">+typealias IPCListeners = ConcurrentHashMap&lt;String, MutableMap&lt;String, MutableSet&lt;IPCListener&gt;&gt;&gt;  // channel, eventName -&gt; listeners
</a><a href="#h3-0-9" id="h3-0-9" class="i">+
</a><a href="#h3-0-10" id="h3-0-10" class="i">+class ManagerIPC(
</a><a href="#h3-0-11" id="h3-0-11" class="i">+    private val ipcListeners: IPCListeners = ConcurrentHashMap(),
</a><a href="#h3-0-12" id="h3-0-12" class="i">+) : IPCInterface() {
</a><a href="#h3-0-13" id="h3-0-13" class="i">+    companion object {
</a><a href="#h3-0-14" id="h3-0-14" class="i">+        private const val TAG = &quot;RemoteManagerIPC&quot;
</a><a href="#h3-0-15" id="h3-0-15" class="i">+    }
</a><a href="#h3-0-16" id="h3-0-16" class="i">+
</a><a href="#h3-0-17" id="h3-0-17" class="i">+    override fun on(eventName: String, listener: Listener) {
</a><a href="#h3-0-18" id="h3-0-18" class="i">+        onBroadcast(context.moduleInfo.name, eventName, listener)
</a><a href="#h3-0-19" id="h3-0-19" class="i">+    }
</a><a href="#h3-0-20" id="h3-0-20" class="i">+
</a><a href="#h3-0-21" id="h3-0-21" class="i">+    override fun emit(eventName: String, vararg args: String?) {
</a><a href="#h3-0-22" id="h3-0-22" class="i">+        emit(context.moduleInfo.name, eventName, *args)
</a><a href="#h3-0-23" id="h3-0-23" class="i">+    }
</a><a href="#h3-0-24" id="h3-0-24" class="i">+
</a><a href="#h3-0-25" id="h3-0-25" class="i">+    override fun onBroadcast(channel: String, eventName: String, listener: Listener) {
</a><a href="#h3-0-26" id="h3-0-26" class="i">+        ipcListeners.getOrPut(channel) { mutableMapOf() }.getOrPut(eventName) { mutableSetOf() }.add(object: IPCListener.Stub() {
</a><a href="#h3-0-27" id="h3-0-27" class="i">+            override fun onMessage(args: Array&lt;out String?&gt;) {
</a><a href="#h3-0-28" id="h3-0-28" class="i">+                try {
</a><a href="#h3-0-29" id="h3-0-29" class="i">+                    listener(args.toList())
</a><a href="#h3-0-30" id="h3-0-30" class="i">+                } catch (doe: DeadObjectException) {
</a><a href="#h3-0-31" id="h3-0-31" class="i">+                    ipcListeners[channel]?.get(eventName)?.remove(this)
</a><a href="#h3-0-32" id="h3-0-32" class="i">+                } catch (t: Throwable) {
</a><a href="#h3-0-33" id="h3-0-33" class="i">+                    context.runtime.logger.error(&quot;Failed to receive message for channel: $channel, event: $eventName&quot;, t, TAG)
</a><a href="#h3-0-34" id="h3-0-34" class="i">+                }
</a><a href="#h3-0-35" id="h3-0-35" class="i">+            }
</a><a href="#h3-0-36" id="h3-0-36" class="i">+        })
</a><a href="#h3-0-37" id="h3-0-37" class="i">+    }
</a><a href="#h3-0-38" id="h3-0-38" class="i">+
</a><a href="#h3-0-39" id="h3-0-39" class="i">+    override fun broadcast(channel: String, eventName: String, vararg args: String?) {
</a><a href="#h3-0-40" id="h3-0-40" class="i">+        ipcListeners[channel]?.get(eventName)?.toList()?.forEach {
</a><a href="#h3-0-41" id="h3-0-41" class="i">+            try {
</a><a href="#h3-0-42" id="h3-0-42" class="i">+                it.onMessage(args)
</a><a href="#h3-0-43" id="h3-0-43" class="i">+            } catch (doe: DeadObjectException) {
</a><a href="#h3-0-44" id="h3-0-44" class="i">+                ipcListeners[channel]?.get(eventName)?.remove(it)
</a><a href="#h3-0-45" id="h3-0-45" class="i">+            } catch (t: Throwable) {
</a><a href="#h3-0-46" id="h3-0-46" class="i">+                context.runtime.logger.error(&quot;Failed to send message for channel: $channel, event: $eventName&quot;, t, TAG)
</a><a href="#h3-0-47" id="h3-0-47" class="i">+            }
</a><a href="#h3-0-48" id="h3-0-48" class="i">+        }
</a><a href="#h3-0-49" id="h3-0-49" class="i">+    }
</a><a href="#h3-0-50" id="h3-0-50" class="i">+}</a><a href="#h3-0-51" id="h3-0-51" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h4" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/scripting/impl/ManagerScriptConfig.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/scripting/impl/ManagerScriptConfig.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/scripting/impl/ManagerScriptConfig.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/scripting/impl/ManagerScriptConfig.kt</a></b>
<a href="#h4-0" id="h4-0" class="h">@@ -0,0 +1,57 @@
</a><a href="#h4-0-0" id="h4-0-0" class="i">+package me.rhunk.snapenhance.scripting.impl
</a><a href="#h4-0-1" id="h4-0-1" class="i">+
</a><a href="#h4-0-2" id="h4-0-2" class="i">+import com.google.gson.JsonObject
</a><a href="#h4-0-3" id="h4-0-3" class="i">+import me.rhunk.snapenhance.common.scripting.impl.ConfigInterface
</a><a href="#h4-0-4" id="h4-0-4" class="i">+import me.rhunk.snapenhance.scripting.RemoteScriptManager
</a><a href="#h4-0-5" id="h4-0-5" class="i">+import java.io.File
</a><a href="#h4-0-6" id="h4-0-6" class="i">+
</a><a href="#h4-0-7" id="h4-0-7" class="i">+class ManagerScriptConfig(
</a><a href="#h4-0-8" id="h4-0-8" class="i">+    private val remoteScriptManager: RemoteScriptManager
</a><a href="#h4-0-9" id="h4-0-9" class="i">+) : ConfigInterface() {
</a><a href="#h4-0-10" id="h4-0-10" class="i">+    private val configFile by lazy { File(remoteScriptManager.getModuleDataFolder(context.moduleInfo.name), &quot;config.json&quot;) }
</a><a href="#h4-0-11" id="h4-0-11" class="i">+    private var config = JsonObject()
</a><a href="#h4-0-12" id="h4-0-12" class="i">+
</a><a href="#h4-0-13" id="h4-0-13" class="i">+    override fun get(key: String, defaultValue: Any?): String? {
</a><a href="#h4-0-14" id="h4-0-14" class="i">+        return config[key]?.asString ?: defaultValue?.toString()
</a><a href="#h4-0-15" id="h4-0-15" class="i">+    }
</a><a href="#h4-0-16" id="h4-0-16" class="i">+
</a><a href="#h4-0-17" id="h4-0-17" class="i">+    override fun set(key: String, value: Any?, save: Boolean) {
</a><a href="#h4-0-18" id="h4-0-18" class="i">+        when (value) {
</a><a href="#h4-0-19" id="h4-0-19" class="i">+            is Int -&gt; config.addProperty(key, value)
</a><a href="#h4-0-20" id="h4-0-20" class="i">+            is Double -&gt; config.addProperty(key, value)
</a><a href="#h4-0-21" id="h4-0-21" class="i">+            is Boolean -&gt; config.addProperty(key, value)
</a><a href="#h4-0-22" id="h4-0-22" class="i">+            is Long -&gt; config.addProperty(key, value)
</a><a href="#h4-0-23" id="h4-0-23" class="i">+            is Float -&gt; config.addProperty(key, value)
</a><a href="#h4-0-24" id="h4-0-24" class="i">+            is Byte -&gt; config.addProperty(key, value)
</a><a href="#h4-0-25" id="h4-0-25" class="i">+            is Short -&gt; config.addProperty(key, value)
</a><a href="#h4-0-26" id="h4-0-26" class="i">+            else -&gt; config.addProperty(key, value?.toString())
</a><a href="#h4-0-27" id="h4-0-27" class="i">+        }
</a><a href="#h4-0-28" id="h4-0-28" class="i">+
</a><a href="#h4-0-29" id="h4-0-29" class="i">+        if (save) save()
</a><a href="#h4-0-30" id="h4-0-30" class="i">+    }
</a><a href="#h4-0-31" id="h4-0-31" class="i">+
</a><a href="#h4-0-32" id="h4-0-32" class="i">+    override fun save() {
</a><a href="#h4-0-33" id="h4-0-33" class="i">+        configFile.writeText(config.toString())
</a><a href="#h4-0-34" id="h4-0-34" class="i">+    }
</a><a href="#h4-0-35" id="h4-0-35" class="i">+
</a><a href="#h4-0-36" id="h4-0-36" class="i">+    override fun load() {
</a><a href="#h4-0-37" id="h4-0-37" class="i">+        runCatching {
</a><a href="#h4-0-38" id="h4-0-38" class="i">+            if (!configFile.exists()) {
</a><a href="#h4-0-39" id="h4-0-39" class="i">+                save()
</a><a href="#h4-0-40" id="h4-0-40" class="i">+                return@runCatching
</a><a href="#h4-0-41" id="h4-0-41" class="i">+            }
</a><a href="#h4-0-42" id="h4-0-42" class="i">+            config = remoteScriptManager.context.gson.fromJson(configFile.readText(), JsonObject::class.java)
</a><a href="#h4-0-43" id="h4-0-43" class="i">+        }.onFailure {
</a><a href="#h4-0-44" id="h4-0-44" class="i">+            context.runtime.logger.error(&quot;Failed to load config file&quot;, it)
</a><a href="#h4-0-45" id="h4-0-45" class="i">+            save()
</a><a href="#h4-0-46" id="h4-0-46" class="i">+        }
</a><a href="#h4-0-47" id="h4-0-47" class="i">+    }
</a><a href="#h4-0-48" id="h4-0-48" class="i">+
</a><a href="#h4-0-49" id="h4-0-49" class="i">+    override fun deleteConfig() {
</a><a href="#h4-0-50" id="h4-0-50" class="i">+        configFile.delete()
</a><a href="#h4-0-51" id="h4-0-51" class="i">+    }
</a><a href="#h4-0-52" id="h4-0-52" class="i">+
</a><a href="#h4-0-53" id="h4-0-53" class="i">+    override fun onInit() {
</a><a href="#h4-0-54" id="h4-0-54" class="i">+        load()
</a><a href="#h4-0-55" id="h4-0-55" class="i">+    }
</a><a href="#h4-0-56" id="h4-0-56" class="i">+}</a><a href="#h4-0-57" id="h4-0-57" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h5" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/scripting/impl/RemoteManagerIPC.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/scripting/impl/RemoteManagerIPC.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/scripting/impl/RemoteManagerIPC.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/scripting/impl/RemoteManagerIPC.kt</a></b>
<a href="#h5-0" id="h5-0" class="h">@@ -1,55 +0,0 @@
</a><a href="#h5-0-0" id="h5-0-0" class="d">-package me.rhunk.snapenhance.scripting.impl
</a><a href="#h5-0-1" id="h5-0-1" class="d">-
</a><a href="#h5-0-2" id="h5-0-2" class="d">-import android.os.DeadObjectException
</a><a href="#h5-0-3" id="h5-0-3" class="d">-import me.rhunk.snapenhance.bridge.scripting.IPCListener
</a><a href="#h5-0-4" id="h5-0-4" class="d">-import me.rhunk.snapenhance.common.logger.AbstractLogger
</a><a href="#h5-0-5" id="h5-0-5" class="d">-import me.rhunk.snapenhance.common.scripting.impl.IPCInterface
</a><a href="#h5-0-6" id="h5-0-6" class="d">-import me.rhunk.snapenhance.common.scripting.impl.Listener
</a><a href="#h5-0-7" id="h5-0-7" class="d">-import me.rhunk.snapenhance.common.scripting.type.ModuleInfo
</a><a href="#h5-0-8" id="h5-0-8" class="d">-import java.util.concurrent.ConcurrentHashMap
</a><a href="#h5-0-9" id="h5-0-9" class="d">-
</a><a href="#h5-0-10" id="h5-0-10" class="d">-typealias IPCListeners = ConcurrentHashMap&lt;String, MutableMap&lt;String, MutableSet&lt;IPCListener&gt;&gt;&gt;  // channel, eventName -&gt; listeners
</a><a href="#h5-0-11" id="h5-0-11" class="d">-
</a><a href="#h5-0-12" id="h5-0-12" class="d">-class RemoteManagerIPC(
</a><a href="#h5-0-13" id="h5-0-13" class="d">-    private val moduleInfo: ModuleInfo,
</a><a href="#h5-0-14" id="h5-0-14" class="d">-    private val logger: AbstractLogger,
</a><a href="#h5-0-15" id="h5-0-15" class="d">-    private val ipcListeners: IPCListeners = ConcurrentHashMap(),
</a><a href="#h5-0-16" id="h5-0-16" class="d">-) : IPCInterface() {
</a><a href="#h5-0-17" id="h5-0-17" class="d">-    companion object {
</a><a href="#h5-0-18" id="h5-0-18" class="d">-        private const val TAG = &quot;RemoteManagerIPC&quot;
</a><a href="#h5-0-19" id="h5-0-19" class="d">-    }
</a><a href="#h5-0-20" id="h5-0-20" class="d">-
</a><a href="#h5-0-21" id="h5-0-21" class="d">-    override fun on(eventName: String, listener: Listener) {
</a><a href="#h5-0-22" id="h5-0-22" class="d">-        onBroadcast(moduleInfo.name, eventName, listener)
</a><a href="#h5-0-23" id="h5-0-23" class="d">-    }
</a><a href="#h5-0-24" id="h5-0-24" class="d">-
</a><a href="#h5-0-25" id="h5-0-25" class="d">-    override fun emit(eventName: String, vararg args: String?) {
</a><a href="#h5-0-26" id="h5-0-26" class="d">-        emit(moduleInfo.name, eventName, *args)
</a><a href="#h5-0-27" id="h5-0-27" class="d">-    }
</a><a href="#h5-0-28" id="h5-0-28" class="d">-
</a><a href="#h5-0-29" id="h5-0-29" class="d">-    override fun onBroadcast(channel: String, eventName: String, listener: Listener) {
</a><a href="#h5-0-30" id="h5-0-30" class="d">-        ipcListeners.getOrPut(channel) { mutableMapOf() }.getOrPut(eventName) { mutableSetOf() }.add(object: IPCListener.Stub() {
</a><a href="#h5-0-31" id="h5-0-31" class="d">-            override fun onMessage(args: Array&lt;out String?&gt;) {
</a><a href="#h5-0-32" id="h5-0-32" class="d">-                try {
</a><a href="#h5-0-33" id="h5-0-33" class="d">-                    listener(args)
</a><a href="#h5-0-34" id="h5-0-34" class="d">-                } catch (doe: DeadObjectException) {
</a><a href="#h5-0-35" id="h5-0-35" class="d">-                    ipcListeners[channel]?.get(eventName)?.remove(this)
</a><a href="#h5-0-36" id="h5-0-36" class="d">-                } catch (t: Throwable) {
</a><a href="#h5-0-37" id="h5-0-37" class="d">-                    logger.error(&quot;Failed to receive message for channel: $channel, event: $eventName&quot;, t, TAG)
</a><a href="#h5-0-38" id="h5-0-38" class="d">-                }
</a><a href="#h5-0-39" id="h5-0-39" class="d">-            }
</a><a href="#h5-0-40" id="h5-0-40" class="d">-        })
</a><a href="#h5-0-41" id="h5-0-41" class="d">-    }
</a><a href="#h5-0-42" id="h5-0-42" class="d">-
</a><a href="#h5-0-43" id="h5-0-43" class="d">-    override fun broadcast(channel: String, eventName: String, vararg args: String?) {
</a><a href="#h5-0-44" id="h5-0-44" class="d">-        ipcListeners[channel]?.get(eventName)?.toList()?.forEach {
</a><a href="#h5-0-45" id="h5-0-45" class="d">-            try {
</a><a href="#h5-0-46" id="h5-0-46" class="d">-                it.onMessage(args)
</a><a href="#h5-0-47" id="h5-0-47" class="d">-            } catch (doe: DeadObjectException) {
</a><a href="#h5-0-48" id="h5-0-48" class="d">-                ipcListeners[channel]?.get(eventName)?.remove(it)
</a><a href="#h5-0-49" id="h5-0-49" class="d">-            } catch (t: Throwable) {
</a><a href="#h5-0-50" id="h5-0-50" class="d">-                logger.error(&quot;Failed to send message for channel: $channel, event: $eventName&quot;, t, TAG)
</a><a href="#h5-0-51" id="h5-0-51" class="d">-            }
</a><a href="#h5-0-52" id="h5-0-52" class="d">-        }
</a><a href="#h5-0-53" id="h5-0-53" class="d">-    }
</a><a href="#h5-0-54" id="h5-0-54" class="d">-}</a><a href="#h5-0-55" id="h5-0-55" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h6" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/scripting/impl/RemoteScriptConfig.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/scripting/impl/RemoteScriptConfig.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/scripting/impl/RemoteScriptConfig.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/scripting/impl/RemoteScriptConfig.kt</a></b>
<a href="#h6-0" id="h6-0" class="h">@@ -1,57 +0,0 @@
</a><a href="#h6-0-0" id="h6-0-0" class="d">-package me.rhunk.snapenhance.scripting.impl
</a><a href="#h6-0-1" id="h6-0-1" class="d">-
</a><a href="#h6-0-2" id="h6-0-2" class="d">-import com.google.gson.JsonObject
</a><a href="#h6-0-3" id="h6-0-3" class="d">-import me.rhunk.snapenhance.common.logger.AbstractLogger
</a><a href="#h6-0-4" id="h6-0-4" class="d">-import me.rhunk.snapenhance.common.scripting.impl.ConfigInterface
</a><a href="#h6-0-5" id="h6-0-5" class="d">-import me.rhunk.snapenhance.common.scripting.type.ModuleInfo
</a><a href="#h6-0-6" id="h6-0-6" class="d">-import me.rhunk.snapenhance.scripting.RemoteScriptManager
</a><a href="#h6-0-7" id="h6-0-7" class="d">-import java.io.File
</a><a href="#h6-0-8" id="h6-0-8" class="d">-
</a><a href="#h6-0-9" id="h6-0-9" class="d">-class RemoteScriptConfig(
</a><a href="#h6-0-10" id="h6-0-10" class="d">-    private val remoteScriptManager: RemoteScriptManager,
</a><a href="#h6-0-11" id="h6-0-11" class="d">-    moduleInfo: ModuleInfo,
</a><a href="#h6-0-12" id="h6-0-12" class="d">-    private val logger: AbstractLogger,
</a><a href="#h6-0-13" id="h6-0-13" class="d">-) : ConfigInterface() {
</a><a href="#h6-0-14" id="h6-0-14" class="d">-    private val configFile = File(remoteScriptManager.getModuleDataFolder(moduleInfo.name), &quot;config.json&quot;)
</a><a href="#h6-0-15" id="h6-0-15" class="d">-    private var config = JsonObject()
</a><a href="#h6-0-16" id="h6-0-16" class="d">-
</a><a href="#h6-0-17" id="h6-0-17" class="d">-    override fun get(key: String, defaultValue: Any?): String? {
</a><a href="#h6-0-18" id="h6-0-18" class="d">-        return config[key]?.asString ?: defaultValue?.toString()
</a><a href="#h6-0-19" id="h6-0-19" class="d">-    }
</a><a href="#h6-0-20" id="h6-0-20" class="d">-
</a><a href="#h6-0-21" id="h6-0-21" class="d">-    override fun set(key: String, value: Any?, save: Boolean) {
</a><a href="#h6-0-22" id="h6-0-22" class="d">-        when (value) {
</a><a href="#h6-0-23" id="h6-0-23" class="d">-            is Int -&gt; config.addProperty(key, value)
</a><a href="#h6-0-24" id="h6-0-24" class="d">-            is Double -&gt; config.addProperty(key, value)
</a><a href="#h6-0-25" id="h6-0-25" class="d">-            is Boolean -&gt; config.addProperty(key, value)
</a><a href="#h6-0-26" id="h6-0-26" class="d">-            is Long -&gt; config.addProperty(key, value)
</a><a href="#h6-0-27" id="h6-0-27" class="d">-            is Float -&gt; config.addProperty(key, value)
</a><a href="#h6-0-28" id="h6-0-28" class="d">-            is Byte -&gt; config.addProperty(key, value)
</a><a href="#h6-0-29" id="h6-0-29" class="d">-            is Short -&gt; config.addProperty(key, value)
</a><a href="#h6-0-30" id="h6-0-30" class="d">-            else -&gt; config.addProperty(key, value?.toString())
</a><a href="#h6-0-31" id="h6-0-31" class="d">-        }
</a><a href="#h6-0-32" id="h6-0-32" class="d">-
</a><a href="#h6-0-33" id="h6-0-33" class="d">-        if (save) save()
</a><a href="#h6-0-34" id="h6-0-34" class="d">-    }
</a><a href="#h6-0-35" id="h6-0-35" class="d">-
</a><a href="#h6-0-36" id="h6-0-36" class="d">-    override fun save() {
</a><a href="#h6-0-37" id="h6-0-37" class="d">-        configFile.writeText(config.toString())
</a><a href="#h6-0-38" id="h6-0-38" class="d">-    }
</a><a href="#h6-0-39" id="h6-0-39" class="d">-
</a><a href="#h6-0-40" id="h6-0-40" class="d">-    override fun load() {
</a><a href="#h6-0-41" id="h6-0-41" class="d">-        runCatching {
</a><a href="#h6-0-42" id="h6-0-42" class="d">-            if (!configFile.exists()) {
</a><a href="#h6-0-43" id="h6-0-43" class="d">-                save()
</a><a href="#h6-0-44" id="h6-0-44" class="d">-                return@runCatching
</a><a href="#h6-0-45" id="h6-0-45" class="d">-            }
</a><a href="#h6-0-46" id="h6-0-46" class="d">-            config = remoteScriptManager.context.gson.fromJson(configFile.readText(), JsonObject::class.java)
</a><a href="#h6-0-47" id="h6-0-47" class="d">-        }.onFailure {
</a><a href="#h6-0-48" id="h6-0-48" class="d">-            logger.error(&quot;Failed to load config file&quot;, it)
</a><a href="#h6-0-49" id="h6-0-49" class="d">-            save()
</a><a href="#h6-0-50" id="h6-0-50" class="d">-        }
</a><a href="#h6-0-51" id="h6-0-51" class="d">-    }
</a><a href="#h6-0-52" id="h6-0-52" class="d">-
</a><a href="#h6-0-53" id="h6-0-53" class="d">-    override fun delete() {
</a><a href="#h6-0-54" id="h6-0-54" class="d">-        configFile.delete()
</a><a href="#h6-0-55" id="h6-0-55" class="d">-    }
</a><a href="#h6-0-56" id="h6-0-56" class="d">-}</a><a href="#h6-0-57" id="h6-0-57" class="d">-
\ No newline at end of file
</a><b>diff --git a/<a id="h7" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/scripting/impl/ui/InterfaceManager.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/scripting/impl/ui/InterfaceManager.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/scripting/impl/ui/InterfaceManager.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/scripting/impl/ui/InterfaceManager.kt</a></b>
<a href="#h7-0" id="h7-0" class="h">@@ -1,13 +1,13 @@
</a> package me.rhunk.snapenhance.scripting.impl.ui
 
<a href="#h7-0-2" id="h7-0-2" class="d">-import me.rhunk.snapenhance.common.logger.AbstractLogger
</a><a href="#h7-0-3" id="h7-0-3" class="d">-import me.rhunk.snapenhance.common.scripting.type.ModuleInfo
</a><a href="#h7-0-4" id="h7-0-4" class="i">+import me.rhunk.snapenhance.common.scripting.bindings.AbstractBinding
</a><a href="#h7-0-5" id="h7-0-5" class="i">+import me.rhunk.snapenhance.common.scripting.bindings.BindingSide
</a><a href="#h7-0-6" id="h7-0-6" class="i">+import me.rhunk.snapenhance.common.scripting.ktx.contextScope
</a> import me.rhunk.snapenhance.scripting.impl.ui.components.Node
 import me.rhunk.snapenhance.scripting.impl.ui.components.NodeType
 import me.rhunk.snapenhance.scripting.impl.ui.components.impl.ActionNode
 import me.rhunk.snapenhance.scripting.impl.ui.components.impl.ActionType
 import me.rhunk.snapenhance.scripting.impl.ui.components.impl.RowColumnNode
<a href="#h7-0-12" id="h7-0-12" class="d">-import org.mozilla.javascript.Context
</a> import org.mozilla.javascript.Function
 import org.mozilla.javascript.annotations.JSFunction
 
<a href="#h7-1" id="h7-1" class="h">@@ -73,27 +73,31 @@ class InterfaceBuilder {
</a> 
 
 
<a href="#h7-1-3" id="h7-1-3" class="d">-class InterfaceManager(
</a><a href="#h7-1-4" id="h7-1-4" class="d">-    private val moduleInfo: ModuleInfo,
</a><a href="#h7-1-5" id="h7-1-5" class="d">-    private val logger: AbstractLogger
</a><a href="#h7-1-6" id="h7-1-6" class="d">-) {
</a><a href="#h7-1-7" id="h7-1-7" class="i">+class InterfaceManager : AbstractBinding(&quot;interface-manager&quot;, BindingSide.MANAGER) {
</a>     private val interfaces = mutableMapOf&lt;String, () -&gt; InterfaceBuilder?&gt;()
 
     fun buildInterface(name: String): InterfaceBuilder? {
         return interfaces[name]?.invoke()
     }
 
<a href="#h7-1-14" id="h7-1-14" class="i">+    override fun onDispose() {
</a><a href="#h7-1-15" id="h7-1-15" class="i">+        interfaces.clear()
</a><a href="#h7-1-16" id="h7-1-16" class="i">+    }
</a><a href="#h7-1-17" id="h7-1-17" class="i">+
</a><a href="#h7-1-18" id="h7-1-18" class="i">+    @Suppress(&quot;unused&quot;)
</a>     @JSFunction fun create(name: String, callback: Function) {
         interfaces[name] = {
             val interfaceBuilder = InterfaceBuilder()
             runCatching {
<a href="#h7-1-23" id="h7-1-23" class="d">-                Context.enter()
</a><a href="#h7-1-24" id="h7-1-24" class="d">-                callback.call(Context.getCurrentContext(), callback, callback, arrayOf(interfaceBuilder))
</a><a href="#h7-1-25" id="h7-1-25" class="d">-                Context.exit()
</a><a href="#h7-1-26" id="h7-1-26" class="i">+                contextScope {
</a><a href="#h7-1-27" id="h7-1-27" class="i">+                    callback.call(this, callback, callback, arrayOf(interfaceBuilder))
</a><a href="#h7-1-28" id="h7-1-28" class="i">+                }
</a>                 interfaceBuilder
             }.onFailure {
<a href="#h7-1-31" id="h7-1-31" class="d">-                logger.error(&quot;Failed to create interface $name for ${moduleInfo.name}&quot;, it)
</a><a href="#h7-1-32" id="h7-1-32" class="i">+                context.runtime.logger.error(&quot;Failed to create interface $name for ${context.moduleInfo.name}&quot;, it)
</a>             }.getOrNull()
         }
     }
<a href="#h7-1-36" id="h7-1-36" class="i">+
</a><a href="#h7-1-37" id="h7-1-37" class="i">+    override fun getObject() = this
</a> } 
\ No newline at end of file
<b>diff --git a/<a id="h8" href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/scripting/ScriptsSection.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/scripting/ScriptsSection.kt</a> b/<a href="../file/app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/scripting/ScriptsSection.kt.html">app/src/main/kotlin/me/rhunk/snapenhance/ui/manager/sections/scripting/ScriptsSection.kt</a></b>
<a href="#h8-0" id="h8-0" class="h">@@ -6,6 +6,7 @@ import androidx.compose.foundation.layout.*
</a> import androidx.compose.foundation.lazy.LazyColumn
 import androidx.compose.material.icons.Icons
 import androidx.compose.material.icons.filled.FolderOpen
<a href="#h8-0-3" id="h8-0-3" class="i">+import androidx.compose.material.icons.filled.LibraryBooks
</a> import androidx.compose.material.icons.filled.Link
 import androidx.compose.material.icons.filled.Settings
 import androidx.compose.material3.*
<a href="#h8-1" id="h8-1" class="h">@@ -14,6 +15,7 @@ import androidx.compose.ui.Alignment
</a> import androidx.compose.ui.Modifier
 import androidx.compose.ui.unit.dp
 import androidx.compose.ui.unit.sp
<a href="#h8-1-3" id="h8-1-3" class="i">+import androidx.core.net.toUri
</a> import androidx.documentfile.provider.DocumentFile
 import kotlinx.coroutines.delay
 import kotlinx.coroutines.launch
<a href="#h8-2" id="h8-2" class="h">@@ -70,12 +72,27 @@ class ScriptsSection : Section() {
</a>                 }
                 Switch(
                     checked = enabled,
<a href="#h8-2-3" id="h8-2-3" class="d">-                    onCheckedChange = {
</a><a href="#h8-2-4" id="h8-2-4" class="d">-                        context.modDatabase.setScriptEnabled(script.name, it)
</a><a href="#h8-2-5" id="h8-2-5" class="d">-                        if (it) {
</a><a href="#h8-2-6" id="h8-2-6" class="d">-                            context.scriptManager.loadScript(script.name)
</a><a href="#h8-2-7" id="h8-2-7" class="i">+                    onCheckedChange = { isChecked -&gt;
</a><a href="#h8-2-8" id="h8-2-8" class="i">+                        context.modDatabase.setScriptEnabled(script.name, isChecked)
</a><a href="#h8-2-9" id="h8-2-9" class="i">+                        enabled = isChecked
</a><a href="#h8-2-10" id="h8-2-10" class="i">+                        runCatching {
</a><a href="#h8-2-11" id="h8-2-11" class="i">+                            val modulePath = context.scriptManager.getModulePath(script.name)!!
</a><a href="#h8-2-12" id="h8-2-12" class="i">+                            context.scriptManager.unloadScript(modulePath)
</a><a href="#h8-2-13" id="h8-2-13" class="i">+                            if (isChecked) {
</a><a href="#h8-2-14" id="h8-2-14" class="i">+                                context.scriptManager.loadScript(modulePath)
</a><a href="#h8-2-15" id="h8-2-15" class="i">+                                context.scriptManager.runtime.getModuleByName(script.name)
</a><a href="#h8-2-16" id="h8-2-16" class="i">+                                    ?.callFunction(&quot;module.onSnapEnhanceLoad&quot;)
</a><a href="#h8-2-17" id="h8-2-17" class="i">+                                context.shortToast(&quot;Loaded script ${script.name}&quot;)
</a><a href="#h8-2-18" id="h8-2-18" class="i">+                            } else {
</a><a href="#h8-2-19" id="h8-2-19" class="i">+                                context.shortToast(&quot;Unloaded script ${script.name}&quot;)
</a><a href="#h8-2-20" id="h8-2-20" class="i">+                            }
</a><a href="#h8-2-21" id="h8-2-21" class="i">+                        }.onFailure { throwable -&gt;
</a><a href="#h8-2-22" id="h8-2-22" class="i">+                            enabled = !isChecked
</a><a href="#h8-2-23" id="h8-2-23" class="i">+                            (&quot;Failed to ${if (isChecked) &quot;enable&quot; else &quot;disable&quot;} script&quot;).let {
</a><a href="#h8-2-24" id="h8-2-24" class="i">+                                context.log.error(it, throwable)
</a><a href="#h8-2-25" id="h8-2-25" class="i">+                                context.shortToast(it)
</a><a href="#h8-2-26" id="h8-2-26" class="i">+                            }
</a>                         }
<a href="#h8-2-28" id="h8-2-28" class="d">-                        enabled = it
</a>                     }
                 )
             }
<a href="#h8-3" id="h8-3" class="h">@@ -130,7 +147,7 @@ class ScriptsSection : Section() {
</a>         val settingsInterface = remember {
             val module = context.scriptManager.runtime.getModuleByName(script.name) ?: return@remember null
             runCatching {
<a href="#h8-3-3" id="h8-3-3" class="d">-                (module.extras[&quot;im&quot;] as? InterfaceManager)?.buildInterface(&quot;settings&quot;)
</a><a href="#h8-3-4" id="h8-3-4" class="i">+                (module.getBinding(InterfaceManager::class))?.buildInterface(&quot;settings&quot;)
</a>             }.onFailure {
                 settingsError = it
             }.getOrNull()
<a href="#h8-4" id="h8-4" class="h">@@ -228,4 +245,18 @@ class ScriptsSection : Section() {
</a>             )
         }
     }
<a href="#h8-4-3" id="h8-4-3" class="i">+
</a><a href="#h8-4-4" id="h8-4-4" class="i">+    @Composable
</a><a href="#h8-4-5" id="h8-4-5" class="i">+    override fun TopBarActions(rowScope: RowScope) {
</a><a href="#h8-4-6" id="h8-4-6" class="i">+        rowScope.apply {
</a><a href="#h8-4-7" id="h8-4-7" class="i">+            IconButton(onClick = {
</a><a href="#h8-4-8" id="h8-4-8" class="i">+                context.androidContext.startActivity(Intent(Intent.ACTION_VIEW).apply {
</a><a href="#h8-4-9" id="h8-4-9" class="i">+                    data = &quot;https://github.com/SnapEnhance/docs&quot;.toUri()
</a><a href="#h8-4-10" id="h8-4-10" class="i">+                    flags = Intent.FLAG_ACTIVITY_NEW_TASK
</a><a href="#h8-4-11" id="h8-4-11" class="i">+                })
</a><a href="#h8-4-12" id="h8-4-12" class="i">+            }) {
</a><a href="#h8-4-13" id="h8-4-13" class="i">+                Icon(imageVector = Icons.Default.LibraryBooks, contentDescription = &quot;Documentation&quot;)
</a><a href="#h8-4-14" id="h8-4-14" class="i">+            }
</a><a href="#h8-4-15" id="h8-4-15" class="i">+        }
</a><a href="#h8-4-16" id="h8-4-16" class="i">+    }
</a> } 
\ No newline at end of file
<b>diff --git a/<a id="h9" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/logger/LogChannel.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/logger/LogChannel.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/logger/LogChannel.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/logger/LogChannel.kt</a></b>
<a href="#h9-0" id="h9-0" class="h">@@ -5,6 +5,8 @@ enum class LogChannel(
</a>     val shortName: String
 ) {
     CORE(&quot;SnapEnhanceCore&quot;, &quot;core&quot;),
<a href="#h9-0-3" id="h9-0-3" class="i">+    COMMON(&quot;SnapEnhanceCommon&quot;, &quot;common&quot;),
</a><a href="#h9-0-4" id="h9-0-4" class="i">+    SCRIPTING(&quot;Scripting&quot;, &quot;scripting&quot;),
</a>     NATIVE(&quot;SnapEnhanceNative&quot;, &quot;native&quot;),
     MANAGER(&quot;SnapEnhanceManager&quot;, &quot;manager&quot;),
     XPOSED(&quot;LSPosed-Bridge&quot;, &quot;xposed&quot;);
<b>diff --git a/<a id="h10" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/JSModule.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/JSModule.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/JSModule.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/JSModule.kt</a></b>
<a href="#h10-0" id="h10-0" class="h">@@ -2,6 +2,8 @@ package me.rhunk.snapenhance.common.scripting
</a> 
 import android.os.Handler
 import android.widget.Toast
<a href="#h10-0-3" id="h10-0-3" class="i">+import me.rhunk.snapenhance.common.scripting.bindings.AbstractBinding
</a><a href="#h10-0-4" id="h10-0-4" class="i">+import me.rhunk.snapenhance.common.scripting.bindings.BindingsContext
</a> import me.rhunk.snapenhance.common.scripting.ktx.contextScope
 import me.rhunk.snapenhance.common.scripting.ktx.putFunction
 import me.rhunk.snapenhance.common.scripting.ktx.scriptableObject
<a href="#h10-1" id="h10-1" class="h">@@ -12,15 +14,23 @@ import org.mozilla.javascript.ScriptableObject
</a> import org.mozilla.javascript.Undefined
 import org.mozilla.javascript.Wrapper
 import java.lang.reflect.Modifier
<a href="#h10-1-3" id="h10-1-3" class="i">+import kotlin.reflect.KClass
</a> 
 class JSModule(
     val scriptRuntime: ScriptRuntime,
     val moduleInfo: ModuleInfo,
     val content: String,
 ) {
<a href="#h10-1-10" id="h10-1-10" class="d">-    val extras = mutableMapOf&lt;String, Any&gt;()
</a><a href="#h10-1-11" id="h10-1-11" class="i">+    private val moduleBindings = mutableMapOf&lt;String, AbstractBinding&gt;()
</a>     private lateinit var moduleObject: ScriptableObject
 
<a href="#h10-1-14" id="h10-1-14" class="i">+    private val moduleBindingContext by lazy {
</a><a href="#h10-1-15" id="h10-1-15" class="i">+        BindingsContext(
</a><a href="#h10-1-16" id="h10-1-16" class="i">+            moduleInfo = moduleInfo,
</a><a href="#h10-1-17" id="h10-1-17" class="i">+            runtime = scriptRuntime
</a><a href="#h10-1-18" id="h10-1-18" class="i">+        )
</a><a href="#h10-1-19" id="h10-1-19" class="i">+    }
</a><a href="#h10-1-20" id="h10-1-20" class="i">+
</a>     fun load(block: ScriptableObject.() -&gt; Unit) {
         contextScope {
             val classLoader = scriptRuntime.androidContext.classLoader
<a href="#h10-2" id="h10-2" class="h">@@ -33,7 +43,7 @@ class JSModule(
</a>                     putConst(&quot;author&quot;, this, moduleInfo.author)
                     putConst(&quot;minSnapchatVersion&quot;, this, moduleInfo.minSnapchatVersion)
                     putConst(&quot;minSEVersion&quot;, this, moduleInfo.minSEVersion)
<a href="#h10-2-3" id="h10-2-3" class="d">-                    putConst(&quot;grantPermissions&quot;, this, moduleInfo.grantPermissions)
</a><a href="#h10-2-4" id="h10-2-4" class="i">+                    putConst(&quot;grantedPermissions&quot;, this, moduleInfo.grantedPermissions)
</a>                 })
             })
 
<a href="#h10-3" id="h10-3" class="h">@@ -62,12 +72,16 @@ class JSModule(
</a> 
             moduleObject.putFunction(&quot;findClass&quot;) {
                 val className = it?.get(0).toString()
<a href="#h10-3-3" id="h10-3-3" class="d">-                classLoader.loadClass(className)
</a><a href="#h10-3-4" id="h10-3-4" class="i">+                runCatching {
</a><a href="#h10-3-5" id="h10-3-5" class="i">+                    classLoader.loadClass(className)
</a><a href="#h10-3-6" id="h10-3-6" class="i">+                }.onFailure { throwable -&gt;
</a><a href="#h10-3-7" id="h10-3-7" class="i">+                    scriptRuntime.logger.error(&quot;Failed to load class $className&quot;, throwable)
</a><a href="#h10-3-8" id="h10-3-8" class="i">+                }.getOrNull()
</a>             }
 
             moduleObject.putFunction(&quot;type&quot;) { args -&gt;
                 val className = args?.get(0).toString()
<a href="#h10-3-13" id="h10-3-13" class="d">-                val clazz = classLoader.loadClass(className)
</a><a href="#h10-3-14" id="h10-3-14" class="i">+                val clazz = runCatching { classLoader.loadClass(className) }.getOrNull() ?: return@putFunction Undefined.instance
</a> 
                 scriptableObject(&quot;JavaClassWrapper&quot;) {
                     putFunction(&quot;newInstance&quot;) newInstance@{ args -&gt;
<a href="#h10-4" id="h10-4" class="h">@@ -95,12 +109,12 @@ class JSModule(
</a>             }
 
             moduleObject.putFunction(&quot;logInfo&quot;) { args -&gt;
<a href="#h10-4-3" id="h10-4-3" class="d">-                scriptRuntime.logger.info(args?.joinToString(&quot; &quot;) {
</a><a href="#h10-4-4" id="h10-4-4" class="d">-                    when (it) {
</a><a href="#h10-4-5" id="h10-4-5" class="d">-                        is Wrapper -&gt; it.unwrap().toString()
</a><a href="#h10-4-6" id="h10-4-6" class="d">-                        else -&gt; it.toString()
</a><a href="#h10-4-7" id="h10-4-7" class="d">-                    }
</a><a href="#h10-4-8" id="h10-4-8" class="d">-                } ?: &quot;null&quot;)
</a><a href="#h10-4-9" id="h10-4-9" class="i">+                scriptRuntime.logger.info(argsToString(args))
</a><a href="#h10-4-10" id="h10-4-10" class="i">+                Undefined.instance
</a><a href="#h10-4-11" id="h10-4-11" class="i">+            }
</a><a href="#h10-4-12" id="h10-4-12" class="i">+
</a><a href="#h10-4-13" id="h10-4-13" class="i">+            moduleObject.putFunction(&quot;logError&quot;) { args -&gt;
</a><a href="#h10-4-14" id="h10-4-14" class="i">+                scriptRuntime.logger.error(argsToString(arrayOf(args?.get(0))), args?.get(1) as? Throwable ?: Throwable())
</a>                 Undefined.instance
             }
 
<a href="#h10-5" id="h10-5" class="h">@@ -116,16 +130,38 @@ class JSModule(
</a>                     Undefined.instance
                 }
             }
<a href="#h10-5-3" id="h10-5-3" class="i">+
</a>             block(moduleObject)
<a href="#h10-5-5" id="h10-5-5" class="d">-            extras.forEach { (key, value) -&gt;
</a><a href="#h10-5-6" id="h10-5-6" class="d">-                moduleObject.putConst(key, moduleObject, value)
</a><a href="#h10-5-7" id="h10-5-7" class="i">+
</a><a href="#h10-5-8" id="h10-5-8" class="i">+            moduleBindings.forEach { (_, instance) -&gt;
</a><a href="#h10-5-9" id="h10-5-9" class="i">+                instance.context = moduleBindingContext
</a><a href="#h10-5-10" id="h10-5-10" class="i">+
</a><a href="#h10-5-11" id="h10-5-11" class="i">+                runCatching {
</a><a href="#h10-5-12" id="h10-5-12" class="i">+                    instance.onInit()
</a><a href="#h10-5-13" id="h10-5-13" class="i">+                }.onFailure {
</a><a href="#h10-5-14" id="h10-5-14" class="i">+                    scriptRuntime.logger.error(&quot;Failed to init binding ${instance.name}&quot;, it)
</a><a href="#h10-5-15" id="h10-5-15" class="i">+                }
</a>             }
<a href="#h10-5-17" id="h10-5-17" class="i">+
</a><a href="#h10-5-18" id="h10-5-18" class="i">+            moduleObject.putFunction(&quot;require&quot;) { args -&gt;
</a><a href="#h10-5-19" id="h10-5-19" class="i">+                val bindingName = args?.get(0).toString()
</a><a href="#h10-5-20" id="h10-5-20" class="i">+                moduleBindings[bindingName]?.getObject()
</a><a href="#h10-5-21" id="h10-5-21" class="i">+            }
</a><a href="#h10-5-22" id="h10-5-22" class="i">+
</a>             evaluateString(moduleObject, content, moduleInfo.name, 1, null)
         }
     }
 
     fun unload() {
         callFunction(&quot;module.onUnload&quot;)
<a href="#h10-5-29" id="h10-5-29" class="i">+        moduleBindings.entries.removeIf { (name, binding) -&gt;
</a><a href="#h10-5-30" id="h10-5-30" class="i">+            runCatching {
</a><a href="#h10-5-31" id="h10-5-31" class="i">+                binding.onDispose()
</a><a href="#h10-5-32" id="h10-5-32" class="i">+            }.onFailure {
</a><a href="#h10-5-33" id="h10-5-33" class="i">+                scriptRuntime.logger.error(&quot;Failed to dispose binding $name&quot;, it)
</a><a href="#h10-5-34" id="h10-5-34" class="i">+            }
</a><a href="#h10-5-35" id="h10-5-35" class="i">+            true
</a><a href="#h10-5-36" id="h10-5-36" class="i">+        }
</a>     }
 
     fun callFunction(name: String, vararg args: Any?) {
<a href="#h10-6" id="h10-6" class="h">@@ -143,4 +179,25 @@ class JSModule(
</a>             }
         }
     }
<a href="#h10-6-3" id="h10-6-3" class="i">+    fun registerBindings(vararg bindings: AbstractBinding) {
</a><a href="#h10-6-4" id="h10-6-4" class="i">+        bindings.forEach {
</a><a href="#h10-6-5" id="h10-6-5" class="i">+            moduleBindings[it.name] = it.apply {
</a><a href="#h10-6-6" id="h10-6-6" class="i">+                context = moduleBindingContext
</a><a href="#h10-6-7" id="h10-6-7" class="i">+            }
</a><a href="#h10-6-8" id="h10-6-8" class="i">+        }
</a><a href="#h10-6-9" id="h10-6-9" class="i">+    }
</a><a href="#h10-6-10" id="h10-6-10" class="i">+
</a><a href="#h10-6-11" id="h10-6-11" class="i">+    @Suppress(&quot;UNCHECKED_CAST&quot;)
</a><a href="#h10-6-12" id="h10-6-12" class="i">+    fun &lt;T : Any&gt; getBinding(clazz: KClass&lt;T&gt;): T? {
</a><a href="#h10-6-13" id="h10-6-13" class="i">+        return moduleBindings.values.find { clazz.isInstance(it) } as? T
</a><a href="#h10-6-14" id="h10-6-14" class="i">+    }
</a><a href="#h10-6-15" id="h10-6-15" class="i">+
</a><a href="#h10-6-16" id="h10-6-16" class="i">+    private fun argsToString(args: Array&lt;out Any?&gt;?): String {
</a><a href="#h10-6-17" id="h10-6-17" class="i">+        return args?.joinToString(&quot; &quot;) {
</a><a href="#h10-6-18" id="h10-6-18" class="i">+            when (it) {
</a><a href="#h10-6-19" id="h10-6-19" class="i">+                is Wrapper -&gt; it.unwrap().toString()
</a><a href="#h10-6-20" id="h10-6-20" class="i">+                else -&gt; it.toString()
</a><a href="#h10-6-21" id="h10-6-21" class="i">+            }
</a><a href="#h10-6-22" id="h10-6-22" class="i">+        } ?: &quot;null&quot;
</a><a href="#h10-6-23" id="h10-6-23" class="i">+    }
</a> } 
\ No newline at end of file
<b>diff --git a/<a id="h11" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/ScriptRuntime.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/ScriptRuntime.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/ScriptRuntime.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/ScriptRuntime.kt</a></b>
<a href="#h11-0" id="h11-0" class="h">@@ -1,6 +1,7 @@
</a> package me.rhunk.snapenhance.common.scripting
 
 import android.content.Context
<a href="#h11-0-3" id="h11-0-3" class="i">+import me.rhunk.snapenhance.bridge.scripting.IScripting
</a> import me.rhunk.snapenhance.common.logger.AbstractLogger
 import me.rhunk.snapenhance.common.scripting.type.ModuleInfo
 import org.mozilla.javascript.ScriptableObject
<a href="#h11-1" id="h11-1" class="h">@@ -10,9 +11,13 @@ import java.io.InputStream
</a> 
 open class ScriptRuntime(
     val androidContext: Context,
<a href="#h11-1-3" id="h11-1-3" class="d">-    val logger: AbstractLogger,
</a><a href="#h11-1-4" id="h11-1-4" class="i">+    logger: AbstractLogger,
</a> ) {
<a href="#h11-1-6" id="h11-1-6" class="i">+    val logger = ScriptingLogger(logger)
</a><a href="#h11-1-7" id="h11-1-7" class="i">+
</a><a href="#h11-1-8" id="h11-1-8" class="i">+    lateinit var scripting: IScripting
</a>     var buildModuleObject: ScriptableObject.(JSModule) -&gt; Unit = {}
<a href="#h11-1-10" id="h11-1-10" class="i">+
</a>     private val modules = mutableMapOf&lt;String, JSModule&gt;()
 
     fun eachModule(f: JSModule.() -&gt; Unit) {
<a href="#h11-2" id="h11-2" class="h">@@ -55,7 +60,7 @@ open class ScriptRuntime(
</a>             author = properties[&quot;author&quot;],
             minSnapchatVersion = properties[&quot;minSnapchatVersion&quot;]?.toLong(),
             minSEVersion = properties[&quot;minSEVersion&quot;]?.toLong(),
<a href="#h11-2-3" id="h11-2-3" class="d">-            grantPermissions = properties[&quot;permissions&quot;]?.split(&quot;,&quot;)?.map { it.trim() },
</a><a href="#h11-2-4" id="h11-2-4" class="i">+            grantedPermissions = properties[&quot;permissions&quot;]?.split(&quot;,&quot;)?.map { it.trim() } ?: emptyList(),
</a>         )
     }
 
<a href="#h11-3" id="h11-3" class="h">@@ -63,19 +68,15 @@ open class ScriptRuntime(
</a>         return readModuleInfo(inputStream.bufferedReader())
     }
 
<a href="#h11-3-3" id="h11-3-3" class="d">-    fun reload(path: String, content: String) {
</a><a href="#h11-3-4" id="h11-3-4" class="d">-        unload(path)
</a><a href="#h11-3-5" id="h11-3-5" class="d">-        load(path, content)
</a><a href="#h11-3-6" id="h11-3-6" class="d">-    }
</a><a href="#h11-3-7" id="h11-3-7" class="d">-
</a><a href="#h11-3-8" id="h11-3-8" class="d">-    private fun unload(path: String) {
</a><a href="#h11-3-9" id="h11-3-9" class="d">-        val module = modules[path] ?: return
</a><a href="#h11-3-10" id="h11-3-10" class="i">+    fun unload(scriptPath: String) {
</a><a href="#h11-3-11" id="h11-3-11" class="i">+        val module = modules[scriptPath] ?: return
</a><a href="#h11-3-12" id="h11-3-12" class="i">+        logger.info(&quot;Unloading module $scriptPath&quot;)
</a>         module.unload()
<a href="#h11-3-14" id="h11-3-14" class="d">-        modules.remove(path)
</a><a href="#h11-3-15" id="h11-3-15" class="i">+        modules.remove(scriptPath)
</a>     }
 
<a href="#h11-3-18" id="h11-3-18" class="d">-    fun load(path: String, content: String): JSModule? {
</a><a href="#h11-3-19" id="h11-3-19" class="d">-        logger.info(&quot;Loading module $path&quot;)
</a><a href="#h11-3-20" id="h11-3-20" class="i">+    fun load(scriptPath: String, content: String): JSModule? {
</a><a href="#h11-3-21" id="h11-3-21" class="i">+        logger.info(&quot;Loading module $scriptPath&quot;)
</a>         return runCatching {
             JSModule(
                 scriptRuntime = this,
<a href="#h11-4" id="h11-4" class="h">@@ -85,10 +86,10 @@ open class ScriptRuntime(
</a>                 load {
                     buildModuleObject(this, this@apply)
                 }
<a href="#h11-4-3" id="h11-4-3" class="d">-                modules[path] = this
</a><a href="#h11-4-4" id="h11-4-4" class="i">+                modules[scriptPath] = this
</a>             }
         }.onFailure {
<a href="#h11-4-7" id="h11-4-7" class="d">-            logger.error(&quot;Failed to load module $path&quot;, it)
</a><a href="#h11-4-8" id="h11-4-8" class="i">+            logger.error(&quot;Failed to load module $scriptPath&quot;, it)
</a>         }.getOrNull()
     }
 } 
\ No newline at end of file
<b>diff --git a/<a id="h12" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/ScriptingLogger.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/ScriptingLogger.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/ScriptingLogger.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/ScriptingLogger.kt</a></b>
<a href="#h12-0" id="h12-0" class="h">@@ -0,0 +1,40 @@
</a><a href="#h12-0-0" id="h12-0-0" class="i">+package me.rhunk.snapenhance.common.scripting
</a><a href="#h12-0-1" id="h12-0-1" class="i">+
</a><a href="#h12-0-2" id="h12-0-2" class="i">+import me.rhunk.snapenhance.common.logger.AbstractLogger
</a><a href="#h12-0-3" id="h12-0-3" class="i">+import me.rhunk.snapenhance.common.logger.LogChannel
</a><a href="#h12-0-4" id="h12-0-4" class="i">+
</a><a href="#h12-0-5" id="h12-0-5" class="i">+class ScriptingLogger(
</a><a href="#h12-0-6" id="h12-0-6" class="i">+    private val logger: AbstractLogger
</a><a href="#h12-0-7" id="h12-0-7" class="i">+) {
</a><a href="#h12-0-8" id="h12-0-8" class="i">+    companion object {
</a><a href="#h12-0-9" id="h12-0-9" class="i">+        private val TAG = LogChannel.SCRIPTING.channel
</a><a href="#h12-0-10" id="h12-0-10" class="i">+    }
</a><a href="#h12-0-11" id="h12-0-11" class="i">+
</a><a href="#h12-0-12" id="h12-0-12" class="i">+    fun debug(message: Any?, tag: String = TAG) {
</a><a href="#h12-0-13" id="h12-0-13" class="i">+        logger.debug(message, tag)
</a><a href="#h12-0-14" id="h12-0-14" class="i">+    }
</a><a href="#h12-0-15" id="h12-0-15" class="i">+
</a><a href="#h12-0-16" id="h12-0-16" class="i">+    fun error(message: Any?, tag: String = TAG) {
</a><a href="#h12-0-17" id="h12-0-17" class="i">+        logger.error(message, tag)
</a><a href="#h12-0-18" id="h12-0-18" class="i">+    }
</a><a href="#h12-0-19" id="h12-0-19" class="i">+
</a><a href="#h12-0-20" id="h12-0-20" class="i">+    fun error(message: Any?, throwable: Throwable, tag: String = TAG) {
</a><a href="#h12-0-21" id="h12-0-21" class="i">+        logger.error(message, throwable, tag)
</a><a href="#h12-0-22" id="h12-0-22" class="i">+    }
</a><a href="#h12-0-23" id="h12-0-23" class="i">+
</a><a href="#h12-0-24" id="h12-0-24" class="i">+    fun info(message: Any?, tag: String = TAG) {
</a><a href="#h12-0-25" id="h12-0-25" class="i">+        logger.info(message, tag)
</a><a href="#h12-0-26" id="h12-0-26" class="i">+    }
</a><a href="#h12-0-27" id="h12-0-27" class="i">+
</a><a href="#h12-0-28" id="h12-0-28" class="i">+    fun verbose(message: Any?, tag: String = TAG) {
</a><a href="#h12-0-29" id="h12-0-29" class="i">+        logger.verbose(message, tag)
</a><a href="#h12-0-30" id="h12-0-30" class="i">+    }
</a><a href="#h12-0-31" id="h12-0-31" class="i">+
</a><a href="#h12-0-32" id="h12-0-32" class="i">+    fun warn(message: Any?, tag: String = TAG) {
</a><a href="#h12-0-33" id="h12-0-33" class="i">+        logger.warn(message, tag)
</a><a href="#h12-0-34" id="h12-0-34" class="i">+    }
</a><a href="#h12-0-35" id="h12-0-35" class="i">+
</a><a href="#h12-0-36" id="h12-0-36" class="i">+    fun assert(message: Any?, tag: String = TAG) {
</a><a href="#h12-0-37" id="h12-0-37" class="i">+        logger.assert(message, tag)
</a><a href="#h12-0-38" id="h12-0-38" class="i">+    }
</a><a href="#h12-0-39" id="h12-0-39" class="i">+}</a><a href="#h12-0-40" id="h12-0-40" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h13" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/bindings/AbstractBinding.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/bindings/AbstractBinding.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/bindings/AbstractBinding.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/bindings/AbstractBinding.kt</a></b>
<a href="#h13-0" id="h13-0" class="h">@@ -0,0 +1,14 @@
</a><a href="#h13-0-0" id="h13-0-0" class="i">+package me.rhunk.snapenhance.common.scripting.bindings
</a><a href="#h13-0-1" id="h13-0-1" class="i">+
</a><a href="#h13-0-2" id="h13-0-2" class="i">+abstract class AbstractBinding(
</a><a href="#h13-0-3" id="h13-0-3" class="i">+    val name: String,
</a><a href="#h13-0-4" id="h13-0-4" class="i">+    val side: BindingSide
</a><a href="#h13-0-5" id="h13-0-5" class="i">+) {
</a><a href="#h13-0-6" id="h13-0-6" class="i">+    lateinit var context: BindingsContext
</a><a href="#h13-0-7" id="h13-0-7" class="i">+
</a><a href="#h13-0-8" id="h13-0-8" class="i">+    open fun onInit() {}
</a><a href="#h13-0-9" id="h13-0-9" class="i">+
</a><a href="#h13-0-10" id="h13-0-10" class="i">+    open fun onDispose() {}
</a><a href="#h13-0-11" id="h13-0-11" class="i">+
</a><a href="#h13-0-12" id="h13-0-12" class="i">+    abstract fun getObject(): Any
</a><a href="#h13-0-13" id="h13-0-13" class="i">+}</a><a href="#h13-0-14" id="h13-0-14" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h14" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/bindings/BindingSide.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/bindings/BindingSide.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/bindings/BindingSide.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/bindings/BindingSide.kt</a></b>
<a href="#h14-0" id="h14-0" class="h">@@ -0,0 +1,15 @@
</a><a href="#h14-0-0" id="h14-0-0" class="i">+package me.rhunk.snapenhance.common.scripting.bindings
</a><a href="#h14-0-1" id="h14-0-1" class="i">+
</a><a href="#h14-0-2" id="h14-0-2" class="i">+enum class BindingSide(
</a><a href="#h14-0-3" id="h14-0-3" class="i">+    val key: String
</a><a href="#h14-0-4" id="h14-0-4" class="i">+) {
</a><a href="#h14-0-5" id="h14-0-5" class="i">+    COMMON(&quot;common&quot;),
</a><a href="#h14-0-6" id="h14-0-6" class="i">+    CORE(&quot;core&quot;),
</a><a href="#h14-0-7" id="h14-0-7" class="i">+    MANAGER(&quot;manager&quot;);
</a><a href="#h14-0-8" id="h14-0-8" class="i">+
</a><a href="#h14-0-9" id="h14-0-9" class="i">+    companion object {
</a><a href="#h14-0-10" id="h14-0-10" class="i">+        fun fromKey(key: String): BindingSide {
</a><a href="#h14-0-11" id="h14-0-11" class="i">+            return entries.firstOrNull { it.key == key } ?: COMMON
</a><a href="#h14-0-12" id="h14-0-12" class="i">+        }
</a><a href="#h14-0-13" id="h14-0-13" class="i">+    }
</a><a href="#h14-0-14" id="h14-0-14" class="i">+}</a><a href="#h14-0-15" id="h14-0-15" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h15" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/bindings/BindingsContext.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/bindings/BindingsContext.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/bindings/BindingsContext.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/bindings/BindingsContext.kt</a></b>
<a href="#h15-0" id="h15-0" class="h">@@ -0,0 +1,9 @@
</a><a href="#h15-0-0" id="h15-0-0" class="i">+package me.rhunk.snapenhance.common.scripting.bindings
</a><a href="#h15-0-1" id="h15-0-1" class="i">+
</a><a href="#h15-0-2" id="h15-0-2" class="i">+import me.rhunk.snapenhance.common.scripting.ScriptRuntime
</a><a href="#h15-0-3" id="h15-0-3" class="i">+import me.rhunk.snapenhance.common.scripting.type.ModuleInfo
</a><a href="#h15-0-4" id="h15-0-4" class="i">+
</a><a href="#h15-0-5" id="h15-0-5" class="i">+class BindingsContext(
</a><a href="#h15-0-6" id="h15-0-6" class="i">+    val moduleInfo: ModuleInfo,
</a><a href="#h15-0-7" id="h15-0-7" class="i">+    val runtime: ScriptRuntime
</a><a href="#h15-0-8" id="h15-0-8" class="i">+)</a><a href="#h15-0-9" id="h15-0-9" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h16" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/impl/ConfigInterface.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/impl/ConfigInterface.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/impl/ConfigInterface.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/impl/ConfigInterface.kt</a></b>
<a href="#h16-0" id="h16-0" class="h">@@ -1,5 +1,7 @@
</a> package me.rhunk.snapenhance.common.scripting.impl
 
<a href="#h16-0-2" id="h16-0-2" class="i">+import me.rhunk.snapenhance.common.scripting.bindings.AbstractBinding
</a><a href="#h16-0-3" id="h16-0-3" class="i">+import me.rhunk.snapenhance.common.scripting.bindings.BindingSide
</a> import org.mozilla.javascript.annotations.JSFunction
 
 
<a href="#h16-1" id="h16-1" class="h">@@ -18,7 +20,8 @@ enum class ConfigTransactionType(
</a> }
 
 
<a href="#h16-1-3" id="h16-1-3" class="d">-abstract class ConfigInterface {
</a><a href="#h16-1-4" id="h16-1-4" class="i">+@Suppress(&quot;unused&quot;)
</a><a href="#h16-1-5" id="h16-1-5" class="i">+abstract class ConfigInterface : AbstractBinding(&quot;config&quot;, BindingSide.COMMON) {
</a>     @JSFunction fun get(key: String): String? = get(key, null)
     @JSFunction abstract fun get(key: String, defaultValue: Any?): String?
 
<a href="#h16-2" id="h16-2" class="h">@@ -70,5 +73,7 @@ abstract class ConfigInterface {
</a> 
     @JSFunction abstract fun save()
     @JSFunction abstract fun load()
<a href="#h16-2-3" id="h16-2-3" class="d">-    @JSFunction abstract fun delete()
</a><a href="#h16-2-4" id="h16-2-4" class="i">+    @JSFunction abstract fun deleteConfig()
</a><a href="#h16-2-5" id="h16-2-5" class="i">+
</a><a href="#h16-2-6" id="h16-2-6" class="i">+    override fun getObject() = this
</a> } 
\ No newline at end of file
<b>diff --git a/<a id="h17" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/impl/IPCInterface.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/impl/IPCInterface.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/impl/IPCInterface.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/impl/IPCInterface.kt</a></b>
<a href="#h17-0" id="h17-0" class="h">@@ -1,8 +1,11 @@
</a> package me.rhunk.snapenhance.common.scripting.impl
 
<a href="#h17-0-2" id="h17-0-2" class="d">-typealias Listener = (Array&lt;out String?&gt;) -&gt; Unit
</a><a href="#h17-0-3" id="h17-0-3" class="i">+import me.rhunk.snapenhance.common.scripting.bindings.AbstractBinding
</a><a href="#h17-0-4" id="h17-0-4" class="i">+import me.rhunk.snapenhance.common.scripting.bindings.BindingSide
</a> 
<a href="#h17-0-6" id="h17-0-6" class="d">-abstract class IPCInterface {
</a><a href="#h17-0-7" id="h17-0-7" class="i">+typealias Listener = (List&lt;String?&gt;) -&gt; Unit
</a><a href="#h17-0-8" id="h17-0-8" class="i">+
</a><a href="#h17-0-9" id="h17-0-9" class="i">+abstract class IPCInterface : AbstractBinding(&quot;ipc&quot;, BindingSide.COMMON) {
</a>     abstract fun on(eventName: String, listener: Listener)
 
     abstract fun onBroadcast(channel: String, eventName: String, listener: Listener)
<a href="#h17-1" id="h17-1" class="h">@@ -13,5 +16,8 @@ abstract class IPCInterface {
</a>     @Suppress(&quot;unused&quot;)
     fun emit(eventName: String) = emit(eventName, *emptyArray())
     @Suppress(&quot;unused&quot;)
<a href="#h17-1-3" id="h17-1-3" class="d">-    fun emit(channel: String, eventName: String) = broadcast(channel, eventName)
</a><a href="#h17-1-4" id="h17-1-4" class="i">+    fun broadcast(channel: String, eventName: String) =
</a><a href="#h17-1-5" id="h17-1-5" class="i">+        broadcast(channel, eventName, *emptyArray())
</a><a href="#h17-1-6" id="h17-1-6" class="i">+
</a><a href="#h17-1-7" id="h17-1-7" class="i">+    override fun getObject() = this
</a> } 
\ No newline at end of file
<b>diff --git a/<a id="h18" href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/type/ModuleInfo.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/type/ModuleInfo.kt</a> b/<a href="../file/common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/type/ModuleInfo.kt.html">common/src/main/kotlin/me/rhunk/snapenhance/common/scripting/type/ModuleInfo.kt</a></b>
<a href="#h18-0" id="h18-0" class="h">@@ -7,5 +7,5 @@ data class ModuleInfo(
</a>     val author: String? = null,
     val minSnapchatVersion: Long? = null,
     val minSEVersion: Long? = null,
<a href="#h18-0-3" id="h18-0-3" class="d">-    val grantPermissions: List&lt;String&gt;? = null,
</a><a href="#h18-0-4" id="h18-0-4" class="i">+    val grantedPermissions: List&lt;String&gt;,
</a> ) 
\ No newline at end of file
<b>diff --git a/<a id="h19" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/SnapEnhance.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/SnapEnhance.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/SnapEnhance.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/SnapEnhance.kt</a></b>
<a href="#h19-0" id="h19-0" class="h">@@ -17,8 +17,8 @@ import me.rhunk.snapenhance.common.data.MessagingGroupInfo
</a> import me.rhunk.snapenhance.core.bridge.BridgeClient
 import me.rhunk.snapenhance.core.bridge.loadFromBridge
 import me.rhunk.snapenhance.core.data.SnapClassCache
<a href="#h19-0-3" id="h19-0-3" class="d">-import me.rhunk.snapenhance.core.event.events.impl.SnapWidgetBroadcastReceiveEvent
</a> import me.rhunk.snapenhance.core.event.events.impl.NativeUnaryCallEvent
<a href="#h19-0-5" id="h19-0-5" class="i">+import me.rhunk.snapenhance.core.event.events.impl.SnapWidgetBroadcastReceiveEvent
</a> import me.rhunk.snapenhance.core.util.LSPatchUpdater
 import me.rhunk.snapenhance.core.util.hook.HookStage
 import me.rhunk.snapenhance.core.util.hook.hook
<a href="#h19-1" id="h19-1" class="h">@@ -142,7 +142,7 @@ class SnapEnhance {
</a>             bridgeClient.registerMessagingBridge(messagingBridge)
             features.init()
             scriptRuntime.connect(bridgeClient.getScriptingInterface())
<a href="#h19-1-3" id="h19-1-3" class="d">-            scriptRuntime.eachModule { callFunction(&quot;module.onBeforeApplicationLoad&quot;, androidContext) }
</a><a href="#h19-1-4" id="h19-1-4" class="i">+            scriptRuntime.eachModule { callFunction(&quot;module.onSnapApplicationLoad&quot;, androidContext) }
</a>             syncRemote()
         }
     }
<a href="#h19-2" id="h19-2" class="h">@@ -151,7 +151,7 @@ class SnapEnhance {
</a>         measureTimeMillis {
             with(appContext) {
                 features.onActivityCreate()
<a href="#h19-2-3" id="h19-2-3" class="d">-                scriptRuntime.eachModule { callFunction(&quot;module.onSnapActivity&quot;, mainActivity!!) }
</a><a href="#h19-2-4" id="h19-2-4" class="i">+                scriptRuntime.eachModule { callFunction(&quot;module.onSnapMainActivityCreate&quot;, mainActivity!!) }
</a>             }
         }.also { time -&gt;
             appContext.log.verbose(&quot;onActivityCreate took $time&quot;)
<b>diff --git a/<a id="h20" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/scripting/CoreScriptRuntime.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/scripting/CoreScriptRuntime.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/scripting/CoreScriptRuntime.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/scripting/CoreScriptRuntime.kt</a></b>
<a href="#h20-0" id="h20-0" class="h">@@ -7,22 +7,21 @@ import me.rhunk.snapenhance.common.scripting.ScriptRuntime
</a> import me.rhunk.snapenhance.core.ModContext
 import me.rhunk.snapenhance.core.scripting.impl.CoreIPC
 import me.rhunk.snapenhance.core.scripting.impl.CoreScriptConfig
<a href="#h20-0-3" id="h20-0-3" class="d">-import me.rhunk.snapenhance.core.scripting.impl.ScriptHooker
</a><a href="#h20-0-4" id="h20-0-4" class="i">+import me.rhunk.snapenhance.core.scripting.impl.CoreScriptHooker
</a> 
 class CoreScriptRuntime(
     private val modContext: ModContext,
     logger: AbstractLogger,
 ): ScriptRuntime(modContext.androidContext, logger) {
<a href="#h20-0-10" id="h20-0-10" class="d">-    private val scriptHookers = mutableListOf&lt;ScriptHooker&gt;()
</a><a href="#h20-0-11" id="h20-0-11" class="d">-
</a>     fun connect(scriptingInterface: IScripting) {
<a href="#h20-0-13" id="h20-0-13" class="i">+        scripting = scriptingInterface
</a>         scriptingInterface.apply {
             buildModuleObject = { module -&gt;
<a href="#h20-0-16" id="h20-0-16" class="d">-                module.extras[&quot;ipc&quot;] = CoreIPC(this@apply, module.moduleInfo)
</a><a href="#h20-0-17" id="h20-0-17" class="d">-                module.extras[&quot;hooker&quot;] = ScriptHooker(module.moduleInfo, logger, androidContext.classLoader).also {
</a><a href="#h20-0-18" id="h20-0-18" class="d">-                    scriptHookers.add(it)
</a><a href="#h20-0-19" id="h20-0-19" class="d">-                }
</a><a href="#h20-0-20" id="h20-0-20" class="d">-                module.extras[&quot;config&quot;] = CoreScriptConfig(this@apply, module.moduleInfo)
</a><a href="#h20-0-21" id="h20-0-21" class="i">+                module.registerBindings(
</a><a href="#h20-0-22" id="h20-0-22" class="i">+                    CoreScriptConfig(),
</a><a href="#h20-0-23" id="h20-0-23" class="i">+                    CoreIPC(),
</a><a href="#h20-0-24" id="h20-0-24" class="i">+                    CoreScriptHooker(),
</a><a href="#h20-0-25" id="h20-0-25" class="i">+                )
</a>             }
 
             enabledScripts.forEach { path -&gt;
<b>diff --git a/<a id="h21" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/scripting/impl/CoreIPC.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/scripting/impl/CoreIPC.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/scripting/impl/CoreIPC.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/scripting/impl/CoreIPC.kt</a></b>
<a href="#h21-0" id="h21-0" class="h">@@ -1,32 +1,27 @@
</a> package me.rhunk.snapenhance.core.scripting.impl
 
 import me.rhunk.snapenhance.bridge.scripting.IPCListener
<a href="#h21-0-3" id="h21-0-3" class="d">-import me.rhunk.snapenhance.bridge.scripting.IScripting
</a> import me.rhunk.snapenhance.common.scripting.impl.IPCInterface
 import me.rhunk.snapenhance.common.scripting.impl.Listener
<a href="#h21-0-6" id="h21-0-6" class="d">-import me.rhunk.snapenhance.common.scripting.type.ModuleInfo
</a> 
<a href="#h21-0-8" id="h21-0-8" class="d">-class CoreIPC(
</a><a href="#h21-0-9" id="h21-0-9" class="d">-    private val scripting: IScripting,
</a><a href="#h21-0-10" id="h21-0-10" class="d">-    private val moduleInfo: ModuleInfo
</a><a href="#h21-0-11" id="h21-0-11" class="d">-) : IPCInterface() {
</a><a href="#h21-0-12" id="h21-0-12" class="i">+class CoreIPC : IPCInterface() {
</a>     override fun onBroadcast(channel: String, eventName: String, listener: Listener) {
<a href="#h21-0-14" id="h21-0-14" class="d">-        scripting.registerIPCListener(channel, eventName, object: IPCListener.Stub() {
</a><a href="#h21-0-15" id="h21-0-15" class="i">+        context.runtime.scripting.registerIPCListener(channel, eventName, object: IPCListener.Stub() {
</a>             override fun onMessage(args: Array&lt;out String?&gt;) {
<a href="#h21-0-17" id="h21-0-17" class="d">-                listener(args)
</a><a href="#h21-0-18" id="h21-0-18" class="i">+                listener(args.toList())
</a>             }
         })
     }
 
     override fun on(eventName: String, listener: Listener) {
<a href="#h21-0-24" id="h21-0-24" class="d">-        onBroadcast(moduleInfo.name, eventName, listener)
</a><a href="#h21-0-25" id="h21-0-25" class="i">+        onBroadcast(context.moduleInfo.name, eventName, listener)
</a>     }
 
     override fun emit(eventName: String, vararg args: String?) {
<a href="#h21-0-29" id="h21-0-29" class="d">-        broadcast(moduleInfo.name, eventName, *args)
</a><a href="#h21-0-30" id="h21-0-30" class="i">+        broadcast(context.moduleInfo.name, eventName, *args)
</a>     }
 
     override fun broadcast(channel: String, eventName: String, vararg args: String?) {
<a href="#h21-0-34" id="h21-0-34" class="d">-        scripting.sendIPCMessage(channel, eventName, args)
</a><a href="#h21-0-35" id="h21-0-35" class="i">+        context.runtime.scripting.sendIPCMessage(channel, eventName, args)
</a>     }
 } 
\ No newline at end of file
<b>diff --git a/<a id="h22" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/scripting/impl/CoreScriptConfig.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/scripting/impl/CoreScriptConfig.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/scripting/impl/CoreScriptConfig.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/scripting/impl/CoreScriptConfig.kt</a></b>
<a href="#h22-0" id="h22-0" class="h">@@ -1,31 +1,26 @@
</a> package me.rhunk.snapenhance.core.scripting.impl
 
<a href="#h22-0-2" id="h22-0-2" class="d">-import me.rhunk.snapenhance.bridge.scripting.IScripting
</a> import me.rhunk.snapenhance.common.scripting.impl.ConfigInterface
 import me.rhunk.snapenhance.common.scripting.impl.ConfigTransactionType
<a href="#h22-0-5" id="h22-0-5" class="d">-import me.rhunk.snapenhance.common.scripting.type.ModuleInfo
</a> 
<a href="#h22-0-7" id="h22-0-7" class="d">-class CoreScriptConfig(
</a><a href="#h22-0-8" id="h22-0-8" class="d">-    private val scripting: IScripting,
</a><a href="#h22-0-9" id="h22-0-9" class="d">-    private val moduleInfo: ModuleInfo
</a><a href="#h22-0-10" id="h22-0-10" class="d">-): ConfigInterface() {
</a><a href="#h22-0-11" id="h22-0-11" class="i">+class CoreScriptConfig: ConfigInterface() {
</a>     override fun get(key: String, defaultValue: Any?): String? {
<a href="#h22-0-13" id="h22-0-13" class="d">-        return scripting.configTransaction(moduleInfo.name, ConfigTransactionType.GET.key, key, defaultValue.toString(), false)
</a><a href="#h22-0-14" id="h22-0-14" class="i">+        return context.runtime.scripting.configTransaction(context.moduleInfo.name, ConfigTransactionType.GET.key, key, defaultValue.toString(), false)
</a>     }
 
     override fun set(key: String, value: Any?, save: Boolean) {
<a href="#h22-0-18" id="h22-0-18" class="d">-        scripting.configTransaction(moduleInfo.name, ConfigTransactionType.SET.key, key, value.toString(), save)
</a><a href="#h22-0-19" id="h22-0-19" class="i">+        context.runtime.scripting.configTransaction(context.moduleInfo.name, ConfigTransactionType.SET.key, key, value.toString(), save)
</a>     }
 
     override fun save() {
<a href="#h22-0-23" id="h22-0-23" class="d">-        scripting.configTransaction(moduleInfo.name, ConfigTransactionType.SAVE.key, null, null, false)
</a><a href="#h22-0-24" id="h22-0-24" class="i">+        context.runtime.scripting.configTransaction(context.moduleInfo.name, ConfigTransactionType.SAVE.key, null, null, false)
</a>     }
 
     override fun load() {
<a href="#h22-0-28" id="h22-0-28" class="d">-        scripting.configTransaction(moduleInfo.name, ConfigTransactionType.LOAD.key, null, null, false)
</a><a href="#h22-0-29" id="h22-0-29" class="i">+        context.runtime.scripting.configTransaction(context.moduleInfo.name, ConfigTransactionType.LOAD.key, null, null, false)
</a>     }
 
<a href="#h22-0-32" id="h22-0-32" class="d">-    override fun delete() {
</a><a href="#h22-0-33" id="h22-0-33" class="d">-        scripting.configTransaction(moduleInfo.name, ConfigTransactionType.DELETE.key, null, null, false)
</a><a href="#h22-0-34" id="h22-0-34" class="i">+    override fun deleteConfig() {
</a><a href="#h22-0-35" id="h22-0-35" class="i">+        context.runtime.scripting.configTransaction(context.moduleInfo.name, ConfigTransactionType.DELETE.key, null, null, false)
</a>     }
 } 
\ No newline at end of file
<b>diff --git a/<a id="h23" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/scripting/impl/CoreScriptHooker.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/scripting/impl/CoreScriptHooker.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/scripting/impl/CoreScriptHooker.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/scripting/impl/CoreScriptHooker.kt</a></b>
<a href="#h23-0" id="h23-0" class="h">@@ -0,0 +1,168 @@
</a><a href="#h23-0-0" id="h23-0-0" class="i">+package me.rhunk.snapenhance.core.scripting.impl
</a><a href="#h23-0-1" id="h23-0-1" class="i">+
</a><a href="#h23-0-2" id="h23-0-2" class="i">+import me.rhunk.snapenhance.common.scripting.bindings.AbstractBinding
</a><a href="#h23-0-3" id="h23-0-3" class="i">+import me.rhunk.snapenhance.common.scripting.bindings.BindingSide
</a><a href="#h23-0-4" id="h23-0-4" class="i">+import me.rhunk.snapenhance.common.scripting.ktx.scriptableObject
</a><a href="#h23-0-5" id="h23-0-5" class="i">+import me.rhunk.snapenhance.common.scripting.toPrimitiveValue
</a><a href="#h23-0-6" id="h23-0-6" class="i">+import me.rhunk.snapenhance.core.util.hook.HookAdapter
</a><a href="#h23-0-7" id="h23-0-7" class="i">+import me.rhunk.snapenhance.core.util.hook.HookStage
</a><a href="#h23-0-8" id="h23-0-8" class="i">+import me.rhunk.snapenhance.core.util.hook.Hooker
</a><a href="#h23-0-9" id="h23-0-9" class="i">+import me.rhunk.snapenhance.core.util.hook.hook
</a><a href="#h23-0-10" id="h23-0-10" class="i">+import me.rhunk.snapenhance.core.util.hook.hookConstructor
</a><a href="#h23-0-11" id="h23-0-11" class="i">+import org.mozilla.javascript.annotations.JSGetter
</a><a href="#h23-0-12" id="h23-0-12" class="i">+import org.mozilla.javascript.annotations.JSSetter
</a><a href="#h23-0-13" id="h23-0-13" class="i">+import java.lang.reflect.Constructor
</a><a href="#h23-0-14" id="h23-0-14" class="i">+import java.lang.reflect.Member
</a><a href="#h23-0-15" id="h23-0-15" class="i">+import java.lang.reflect.Method
</a><a href="#h23-0-16" id="h23-0-16" class="i">+
</a><a href="#h23-0-17" id="h23-0-17" class="i">+
</a><a href="#h23-0-18" id="h23-0-18" class="i">+class ScriptHookCallback(
</a><a href="#h23-0-19" id="h23-0-19" class="i">+    private val hookAdapter: HookAdapter
</a><a href="#h23-0-20" id="h23-0-20" class="i">+) {
</a><a href="#h23-0-21" id="h23-0-21" class="i">+    var result
</a><a href="#h23-0-22" id="h23-0-22" class="i">+        @JSGetter(&quot;result&quot;) get() = hookAdapter.getResult()
</a><a href="#h23-0-23" id="h23-0-23" class="i">+        @JSSetter(&quot;result&quot;) set(result) = hookAdapter.setResult(result.toPrimitiveValue(lazy {
</a><a href="#h23-0-24" id="h23-0-24" class="i">+            when (val member = hookAdapter.method()) {
</a><a href="#h23-0-25" id="h23-0-25" class="i">+                is Method -&gt; member.returnType.name
</a><a href="#h23-0-26" id="h23-0-26" class="i">+                else -&gt; &quot;void&quot;
</a><a href="#h23-0-27" id="h23-0-27" class="i">+            }
</a><a href="#h23-0-28" id="h23-0-28" class="i">+        }))
</a><a href="#h23-0-29" id="h23-0-29" class="i">+
</a><a href="#h23-0-30" id="h23-0-30" class="i">+    val thisObject
</a><a href="#h23-0-31" id="h23-0-31" class="i">+        @JSGetter(&quot;thisObject&quot;) get() = hookAdapter.nullableThisObject&lt;Any&gt;()
</a><a href="#h23-0-32" id="h23-0-32" class="i">+
</a><a href="#h23-0-33" id="h23-0-33" class="i">+    val method
</a><a href="#h23-0-34" id="h23-0-34" class="i">+        @JSGetter(&quot;method&quot;) get() = hookAdapter.method()
</a><a href="#h23-0-35" id="h23-0-35" class="i">+
</a><a href="#h23-0-36" id="h23-0-36" class="i">+    val args
</a><a href="#h23-0-37" id="h23-0-37" class="i">+        @JSGetter(&quot;args&quot;) get() = hookAdapter.args().toList()
</a><a href="#h23-0-38" id="h23-0-38" class="i">+
</a><a href="#h23-0-39" id="h23-0-39" class="i">+    private val parameterTypes by lazy {
</a><a href="#h23-0-40" id="h23-0-40" class="i">+        when (val member = hookAdapter.method()) {
</a><a href="#h23-0-41" id="h23-0-41" class="i">+            is Method -&gt; member.parameterTypes
</a><a href="#h23-0-42" id="h23-0-42" class="i">+            is Constructor&lt;*&gt; -&gt; member.parameterTypes
</a><a href="#h23-0-43" id="h23-0-43" class="i">+            else -&gt; emptyArray()
</a><a href="#h23-0-44" id="h23-0-44" class="i">+        }.toList()
</a><a href="#h23-0-45" id="h23-0-45" class="i">+    }
</a><a href="#h23-0-46" id="h23-0-46" class="i">+
</a><a href="#h23-0-47" id="h23-0-47" class="i">+    fun cancel() = hookAdapter.setResult(null)
</a><a href="#h23-0-48" id="h23-0-48" class="i">+
</a><a href="#h23-0-49" id="h23-0-49" class="i">+    fun arg(index: Int) = hookAdapter.argNullable&lt;Any&gt;(index)
</a><a href="#h23-0-50" id="h23-0-50" class="i">+
</a><a href="#h23-0-51" id="h23-0-51" class="i">+    fun setArg(index: Int, value: Any?) {
</a><a href="#h23-0-52" id="h23-0-52" class="i">+        hookAdapter.setArg(index, value.toPrimitiveValue(lazy { parameterTypes[index].name }))
</a><a href="#h23-0-53" id="h23-0-53" class="i">+    }
</a><a href="#h23-0-54" id="h23-0-54" class="i">+
</a><a href="#h23-0-55" id="h23-0-55" class="i">+    fun invokeOriginal() = hookAdapter.invokeOriginal()
</a><a href="#h23-0-56" id="h23-0-56" class="i">+
</a><a href="#h23-0-57" id="h23-0-57" class="i">+    fun invokeOriginal(args: Array&lt;Any&gt;) = hookAdapter.invokeOriginal(args.map {
</a><a href="#h23-0-58" id="h23-0-58" class="i">+        it.toPrimitiveValue(lazy { parameterTypes[args.indexOf(it)].name }) ?: it
</a><a href="#h23-0-59" id="h23-0-59" class="i">+    }.toTypedArray())
</a><a href="#h23-0-60" id="h23-0-60" class="i">+
</a><a href="#h23-0-61" id="h23-0-61" class="i">+    override fun toString(): String {
</a><a href="#h23-0-62" id="h23-0-62" class="i">+        return &quot;ScriptHookCallback(\n&quot; +
</a><a href="#h23-0-63" id="h23-0-63" class="i">+                &quot;  thisObject=${ runCatching { thisObject.toString() }.getOrNull() },\n&quot; +
</a><a href="#h23-0-64" id="h23-0-64" class="i">+                &quot;  args=${ runCatching { args.toString() }.getOrNull() }\n&quot; +
</a><a href="#h23-0-65" id="h23-0-65" class="i">+                &quot;  result=${ runCatching { result.toString() }.getOrNull() },\n&quot; +
</a><a href="#h23-0-66" id="h23-0-66" class="i">+                &quot;)&quot;
</a><a href="#h23-0-67" id="h23-0-67" class="i">+    }
</a><a href="#h23-0-68" id="h23-0-68" class="i">+}
</a><a href="#h23-0-69" id="h23-0-69" class="i">+
</a><a href="#h23-0-70" id="h23-0-70" class="i">+
</a><a href="#h23-0-71" id="h23-0-71" class="i">+typealias HookCallback = (ScriptHookCallback) -&gt; Unit
</a><a href="#h23-0-72" id="h23-0-72" class="i">+typealias HookUnhook = () -&gt; Unit
</a><a href="#h23-0-73" id="h23-0-73" class="i">+
</a><a href="#h23-0-74" id="h23-0-74" class="i">+@Suppress(&quot;unused&quot;)
</a><a href="#h23-0-75" id="h23-0-75" class="i">+class CoreScriptHooker: AbstractBinding(&quot;hooker&quot;, BindingSide.CORE) {
</a><a href="#h23-0-76" id="h23-0-76" class="i">+    private val hooks = mutableListOf&lt;HookUnhook&gt;()
</a><a href="#h23-0-77" id="h23-0-77" class="i">+
</a><a href="#h23-0-78" id="h23-0-78" class="i">+    val stage = scriptableObject {
</a><a href="#h23-0-79" id="h23-0-79" class="i">+        putConst(&quot;BEFORE&quot;, this, &quot;before&quot;)
</a><a href="#h23-0-80" id="h23-0-80" class="i">+        putConst(&quot;AFTER&quot;, this, &quot;after&quot;)
</a><a href="#h23-0-81" id="h23-0-81" class="i">+    }
</a><a href="#h23-0-82" id="h23-0-82" class="i">+
</a><a href="#h23-0-83" id="h23-0-83" class="i">+    private fun findClassSafe(className: String): Class&lt;*&gt;? {
</a><a href="#h23-0-84" id="h23-0-84" class="i">+        return runCatching {
</a><a href="#h23-0-85" id="h23-0-85" class="i">+            context.runtime.androidContext.classLoader.loadClass(className)
</a><a href="#h23-0-86" id="h23-0-86" class="i">+        }.onFailure {
</a><a href="#h23-0-87" id="h23-0-87" class="i">+            context.runtime.logger.warn(&quot;Failed to load class $className&quot;)
</a><a href="#h23-0-88" id="h23-0-88" class="i">+        }.getOrNull()
</a><a href="#h23-0-89" id="h23-0-89" class="i">+    }
</a><a href="#h23-0-90" id="h23-0-90" class="i">+
</a><a href="#h23-0-91" id="h23-0-91" class="i">+    private fun getHookStageFromString(stage: String): HookStage {
</a><a href="#h23-0-92" id="h23-0-92" class="i">+        return when (stage) {
</a><a href="#h23-0-93" id="h23-0-93" class="i">+            &quot;before&quot; -&gt; HookStage.BEFORE
</a><a href="#h23-0-94" id="h23-0-94" class="i">+            &quot;after&quot; -&gt; HookStage.AFTER
</a><a href="#h23-0-95" id="h23-0-95" class="i">+            else -&gt; throw IllegalArgumentException(&quot;Invalid stage: $stage&quot;)
</a><a href="#h23-0-96" id="h23-0-96" class="i">+        }
</a><a href="#h23-0-97" id="h23-0-97" class="i">+    }
</a><a href="#h23-0-98" id="h23-0-98" class="i">+
</a><a href="#h23-0-99" id="h23-0-99" class="i">+    fun findMethod(clazz: Class&lt;*&gt;, methodName: String): Member? {
</a><a href="#h23-0-100" id="h23-0-100" class="i">+        return clazz.declaredMethods.find { it.name == methodName }
</a><a href="#h23-0-101" id="h23-0-101" class="i">+    }
</a><a href="#h23-0-102" id="h23-0-102" class="i">+
</a><a href="#h23-0-103" id="h23-0-103" class="i">+    fun findMethodWithParameters(clazz: Class&lt;*&gt;, methodName: String, vararg types: String): Member? {
</a><a href="#h23-0-104" id="h23-0-104" class="i">+        return clazz.declaredMethods.find { method -&gt; method.name == methodName &amp;&amp; method.parameterTypes.map { it.name }.toTypedArray() contentEquals types }
</a><a href="#h23-0-105" id="h23-0-105" class="i">+    }
</a><a href="#h23-0-106" id="h23-0-106" class="i">+
</a><a href="#h23-0-107" id="h23-0-107" class="i">+    fun findMethod(className: String, methodName: String): Member? {
</a><a href="#h23-0-108" id="h23-0-108" class="i">+        return findClassSafe(className)?.let { findMethod(it, methodName) }
</a><a href="#h23-0-109" id="h23-0-109" class="i">+    }
</a><a href="#h23-0-110" id="h23-0-110" class="i">+
</a><a href="#h23-0-111" id="h23-0-111" class="i">+    fun findMethodWithParameters(className: String, methodName: String, vararg types: String): Member? {
</a><a href="#h23-0-112" id="h23-0-112" class="i">+        return findClassSafe(className)?.let { findMethodWithParameters(it, methodName, *types) }
</a><a href="#h23-0-113" id="h23-0-113" class="i">+    }
</a><a href="#h23-0-114" id="h23-0-114" class="i">+
</a><a href="#h23-0-115" id="h23-0-115" class="i">+    fun findConstructor(clazz: Class&lt;*&gt;, vararg types: String): Member? {
</a><a href="#h23-0-116" id="h23-0-116" class="i">+        return clazz.declaredConstructors.find { constructor -&gt;  constructor.parameterTypes.map { it.name }.toTypedArray() contentEquals types }
</a><a href="#h23-0-117" id="h23-0-117" class="i">+    }
</a><a href="#h23-0-118" id="h23-0-118" class="i">+
</a><a href="#h23-0-119" id="h23-0-119" class="i">+    fun findConstructorParameters(className: String, vararg types: String): Member? {
</a><a href="#h23-0-120" id="h23-0-120" class="i">+        return findClassSafe(className)?.let { findConstructor(it, *types) }
</a><a href="#h23-0-121" id="h23-0-121" class="i">+    }
</a><a href="#h23-0-122" id="h23-0-122" class="i">+
</a><a href="#h23-0-123" id="h23-0-123" class="i">+    // -- hooking
</a><a href="#h23-0-124" id="h23-0-124" class="i">+
</a><a href="#h23-0-125" id="h23-0-125" class="i">+    fun hook(method: Member, stage: String, callback: HookCallback): HookUnhook {
</a><a href="#h23-0-126" id="h23-0-126" class="i">+        val hookAdapter = Hooker.hook(method, getHookStageFromString(stage)) {
</a><a href="#h23-0-127" id="h23-0-127" class="i">+            callback(ScriptHookCallback(it))
</a><a href="#h23-0-128" id="h23-0-128" class="i">+        }
</a><a href="#h23-0-129" id="h23-0-129" class="i">+
</a><a href="#h23-0-130" id="h23-0-130" class="i">+        return {
</a><a href="#h23-0-131" id="h23-0-131" class="i">+            hookAdapter.unhook()
</a><a href="#h23-0-132" id="h23-0-132" class="i">+        }.also { hooks.add(it) }
</a><a href="#h23-0-133" id="h23-0-133" class="i">+    }
</a><a href="#h23-0-134" id="h23-0-134" class="i">+
</a><a href="#h23-0-135" id="h23-0-135" class="i">+    fun hookAllMethods(clazz: Class&lt;*&gt;, methodName: String, stage: String, callback: HookCallback): HookUnhook {
</a><a href="#h23-0-136" id="h23-0-136" class="i">+        val hookAdapter = clazz.hook(methodName, getHookStageFromString(stage)) {
</a><a href="#h23-0-137" id="h23-0-137" class="i">+            callback(ScriptHookCallback(it))
</a><a href="#h23-0-138" id="h23-0-138" class="i">+        }
</a><a href="#h23-0-139" id="h23-0-139" class="i">+
</a><a href="#h23-0-140" id="h23-0-140" class="i">+        return {
</a><a href="#h23-0-141" id="h23-0-141" class="i">+            hookAdapter.forEach { it.unhook() }
</a><a href="#h23-0-142" id="h23-0-142" class="i">+        }.also { hooks.add(it) }
</a><a href="#h23-0-143" id="h23-0-143" class="i">+    }
</a><a href="#h23-0-144" id="h23-0-144" class="i">+
</a><a href="#h23-0-145" id="h23-0-145" class="i">+    fun hookAllConstructors(clazz: Class&lt;*&gt;, stage: String, callback: HookCallback): HookUnhook {
</a><a href="#h23-0-146" id="h23-0-146" class="i">+        val hookAdapter = clazz.hookConstructor(getHookStageFromString(stage)) {
</a><a href="#h23-0-147" id="h23-0-147" class="i">+            callback(ScriptHookCallback(it))
</a><a href="#h23-0-148" id="h23-0-148" class="i">+        }
</a><a href="#h23-0-149" id="h23-0-149" class="i">+
</a><a href="#h23-0-150" id="h23-0-150" class="i">+        return {
</a><a href="#h23-0-151" id="h23-0-151" class="i">+            hookAdapter.forEach { it.unhook() }
</a><a href="#h23-0-152" id="h23-0-152" class="i">+        }.also { hooks.add(it) }
</a><a href="#h23-0-153" id="h23-0-153" class="i">+    }
</a><a href="#h23-0-154" id="h23-0-154" class="i">+
</a><a href="#h23-0-155" id="h23-0-155" class="i">+    fun hookAllMethods(className: String, methodName: String, stage: String, callback: HookCallback)
</a><a href="#h23-0-156" id="h23-0-156" class="i">+        = findClassSafe(className)?.let { hookAllMethods(it, methodName, stage, callback) }
</a><a href="#h23-0-157" id="h23-0-157" class="i">+
</a><a href="#h23-0-158" id="h23-0-158" class="i">+    fun hookAllConstructors(className: String, stage: String, callback: HookCallback)
</a><a href="#h23-0-159" id="h23-0-159" class="i">+        = findClassSafe(className)?.let { hookAllConstructors(it, stage, callback) }
</a><a href="#h23-0-160" id="h23-0-160" class="i">+
</a><a href="#h23-0-161" id="h23-0-161" class="i">+    override fun onDispose() {
</a><a href="#h23-0-162" id="h23-0-162" class="i">+        hooks.forEach { it() }
</a><a href="#h23-0-163" id="h23-0-163" class="i">+        hooks.clear()
</a><a href="#h23-0-164" id="h23-0-164" class="i">+    }
</a><a href="#h23-0-165" id="h23-0-165" class="i">+
</a><a href="#h23-0-166" id="h23-0-166" class="i">+    override fun getObject() = this
</a><a href="#h23-0-167" id="h23-0-167" class="i">+}</a><a href="#h23-0-168" id="h23-0-168" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h24" href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/scripting/impl/ScriptHooker.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/scripting/impl/ScriptHooker.kt</a> b/<a href="../file/core/src/main/kotlin/me/rhunk/snapenhance/core/scripting/impl/ScriptHooker.kt.html">core/src/main/kotlin/me/rhunk/snapenhance/core/scripting/impl/ScriptHooker.kt</a></b>
<a href="#h24-0" id="h24-0" class="h">@@ -1,161 +0,0 @@
</a><a href="#h24-0-0" id="h24-0-0" class="d">-package me.rhunk.snapenhance.core.scripting.impl
</a><a href="#h24-0-1" id="h24-0-1" class="d">-
</a><a href="#h24-0-2" id="h24-0-2" class="d">-import me.rhunk.snapenhance.common.logger.AbstractLogger
</a><a href="#h24-0-3" id="h24-0-3" class="d">-import me.rhunk.snapenhance.common.scripting.toPrimitiveValue
</a><a href="#h24-0-4" id="h24-0-4" class="d">-import me.rhunk.snapenhance.common.scripting.type.ModuleInfo
</a><a href="#h24-0-5" id="h24-0-5" class="d">-import me.rhunk.snapenhance.core.util.hook.HookAdapter
</a><a href="#h24-0-6" id="h24-0-6" class="d">-import me.rhunk.snapenhance.core.util.hook.HookStage
</a><a href="#h24-0-7" id="h24-0-7" class="d">-import me.rhunk.snapenhance.core.util.hook.Hooker
</a><a href="#h24-0-8" id="h24-0-8" class="d">-import me.rhunk.snapenhance.core.util.hook.hook
</a><a href="#h24-0-9" id="h24-0-9" class="d">-import me.rhunk.snapenhance.core.util.hook.hookConstructor
</a><a href="#h24-0-10" id="h24-0-10" class="d">-import org.mozilla.javascript.annotations.JSGetter
</a><a href="#h24-0-11" id="h24-0-11" class="d">-import org.mozilla.javascript.annotations.JSSetter
</a><a href="#h24-0-12" id="h24-0-12" class="d">-import java.lang.reflect.Constructor
</a><a href="#h24-0-13" id="h24-0-13" class="d">-import java.lang.reflect.Member
</a><a href="#h24-0-14" id="h24-0-14" class="d">-import java.lang.reflect.Method
</a><a href="#h24-0-15" id="h24-0-15" class="d">-
</a><a href="#h24-0-16" id="h24-0-16" class="d">-
</a><a href="#h24-0-17" id="h24-0-17" class="d">-class ScriptHookCallback(
</a><a href="#h24-0-18" id="h24-0-18" class="d">-    private val hookAdapter: HookAdapter
</a><a href="#h24-0-19" id="h24-0-19" class="d">-) {
</a><a href="#h24-0-20" id="h24-0-20" class="d">-    var result
</a><a href="#h24-0-21" id="h24-0-21" class="d">-        @JSGetter(&quot;result&quot;) get() = hookAdapter.getResult()
</a><a href="#h24-0-22" id="h24-0-22" class="d">-        @JSSetter(&quot;result&quot;) set(result) = hookAdapter.setResult(result.toPrimitiveValue(lazy {
</a><a href="#h24-0-23" id="h24-0-23" class="d">-            when (val member = hookAdapter.method()) {
</a><a href="#h24-0-24" id="h24-0-24" class="d">-                is Method -&gt; member.returnType.name
</a><a href="#h24-0-25" id="h24-0-25" class="d">-                else -&gt; &quot;void&quot;
</a><a href="#h24-0-26" id="h24-0-26" class="d">-            }
</a><a href="#h24-0-27" id="h24-0-27" class="d">-        }))
</a><a href="#h24-0-28" id="h24-0-28" class="d">-
</a><a href="#h24-0-29" id="h24-0-29" class="d">-    val thisObject
</a><a href="#h24-0-30" id="h24-0-30" class="d">-        @JSGetter(&quot;thisObject&quot;) get() = hookAdapter.nullableThisObject&lt;Any&gt;()
</a><a href="#h24-0-31" id="h24-0-31" class="d">-
</a><a href="#h24-0-32" id="h24-0-32" class="d">-    val method
</a><a href="#h24-0-33" id="h24-0-33" class="d">-        @JSGetter(&quot;method&quot;) get() = hookAdapter.method()
</a><a href="#h24-0-34" id="h24-0-34" class="d">-
</a><a href="#h24-0-35" id="h24-0-35" class="d">-    val args
</a><a href="#h24-0-36" id="h24-0-36" class="d">-        @JSGetter(&quot;args&quot;) get() = hookAdapter.args().toList()
</a><a href="#h24-0-37" id="h24-0-37" class="d">-
</a><a href="#h24-0-38" id="h24-0-38" class="d">-    private val parameterTypes by lazy {
</a><a href="#h24-0-39" id="h24-0-39" class="d">-        when (val member = hookAdapter.method()) {
</a><a href="#h24-0-40" id="h24-0-40" class="d">-            is Method -&gt; member.parameterTypes
</a><a href="#h24-0-41" id="h24-0-41" class="d">-            is Constructor&lt;*&gt; -&gt; member.parameterTypes
</a><a href="#h24-0-42" id="h24-0-42" class="d">-            else -&gt; emptyArray()
</a><a href="#h24-0-43" id="h24-0-43" class="d">-        }.toList()
</a><a href="#h24-0-44" id="h24-0-44" class="d">-    }
</a><a href="#h24-0-45" id="h24-0-45" class="d">-
</a><a href="#h24-0-46" id="h24-0-46" class="d">-    fun cancel() = hookAdapter.setResult(null)
</a><a href="#h24-0-47" id="h24-0-47" class="d">-
</a><a href="#h24-0-48" id="h24-0-48" class="d">-    fun arg(index: Int) = hookAdapter.argNullable&lt;Any&gt;(index)
</a><a href="#h24-0-49" id="h24-0-49" class="d">-
</a><a href="#h24-0-50" id="h24-0-50" class="d">-    fun setArg(index: Int, value: Any?) {
</a><a href="#h24-0-51" id="h24-0-51" class="d">-        hookAdapter.setArg(index, value.toPrimitiveValue(lazy { parameterTypes[index].name }))
</a><a href="#h24-0-52" id="h24-0-52" class="d">-    }
</a><a href="#h24-0-53" id="h24-0-53" class="d">-
</a><a href="#h24-0-54" id="h24-0-54" class="d">-    fun invokeOriginal() = hookAdapter.invokeOriginal()
</a><a href="#h24-0-55" id="h24-0-55" class="d">-
</a><a href="#h24-0-56" id="h24-0-56" class="d">-    fun invokeOriginal(args: Array&lt;Any&gt;) = hookAdapter.invokeOriginal(args.map {
</a><a href="#h24-0-57" id="h24-0-57" class="d">-        it.toPrimitiveValue(lazy { parameterTypes[args.indexOf(it)].name }) ?: it
</a><a href="#h24-0-58" id="h24-0-58" class="d">-    }.toTypedArray())
</a><a href="#h24-0-59" id="h24-0-59" class="d">-
</a><a href="#h24-0-60" id="h24-0-60" class="d">-    override fun toString(): String {
</a><a href="#h24-0-61" id="h24-0-61" class="d">-        return &quot;ScriptHookCallback(\n&quot; +
</a><a href="#h24-0-62" id="h24-0-62" class="d">-                &quot;  thisObject=${ runCatching { thisObject.toString() }.getOrNull() },\n&quot; +
</a><a href="#h24-0-63" id="h24-0-63" class="d">-                &quot;  args=${ runCatching { args.toString() }.getOrNull() }\n&quot; +
</a><a href="#h24-0-64" id="h24-0-64" class="d">-                &quot;  result=${ runCatching { result.toString() }.getOrNull() },\n&quot; +
</a><a href="#h24-0-65" id="h24-0-65" class="d">-                &quot;)&quot;
</a><a href="#h24-0-66" id="h24-0-66" class="d">-    }
</a><a href="#h24-0-67" id="h24-0-67" class="d">-}
</a><a href="#h24-0-68" id="h24-0-68" class="d">-
</a><a href="#h24-0-69" id="h24-0-69" class="d">-
</a><a href="#h24-0-70" id="h24-0-70" class="d">-typealias HookCallback = (ScriptHookCallback) -&gt; Unit
</a><a href="#h24-0-71" id="h24-0-71" class="d">-typealias HookUnhook = () -&gt; Unit
</a><a href="#h24-0-72" id="h24-0-72" class="d">-
</a><a href="#h24-0-73" id="h24-0-73" class="d">-@Suppress(&quot;unused&quot;, &quot;MemberVisibilityCanBePrivate&quot;)
</a><a href="#h24-0-74" id="h24-0-74" class="d">-class ScriptHooker(
</a><a href="#h24-0-75" id="h24-0-75" class="d">-    private val moduleInfo: ModuleInfo,
</a><a href="#h24-0-76" id="h24-0-76" class="d">-    private val logger: AbstractLogger,
</a><a href="#h24-0-77" id="h24-0-77" class="d">-    private val classLoader: ClassLoader
</a><a href="#h24-0-78" id="h24-0-78" class="d">-) {
</a><a href="#h24-0-79" id="h24-0-79" class="d">-    private val hooks = mutableListOf&lt;HookUnhook&gt;()
</a><a href="#h24-0-80" id="h24-0-80" class="d">-
</a><a href="#h24-0-81" id="h24-0-81" class="d">-    // -- search for class members
</a><a href="#h24-0-82" id="h24-0-82" class="d">-
</a><a href="#h24-0-83" id="h24-0-83" class="d">-    private fun findClassSafe(className: String): Class&lt;*&gt;? {
</a><a href="#h24-0-84" id="h24-0-84" class="d">-        return runCatching {
</a><a href="#h24-0-85" id="h24-0-85" class="d">-            classLoader.loadClass(className)
</a><a href="#h24-0-86" id="h24-0-86" class="d">-        }.onFailure {
</a><a href="#h24-0-87" id="h24-0-87" class="d">-            logger.warn(&quot;Failed to load class $className&quot;)
</a><a href="#h24-0-88" id="h24-0-88" class="d">-        }.getOrNull()
</a><a href="#h24-0-89" id="h24-0-89" class="d">-    }
</a><a href="#h24-0-90" id="h24-0-90" class="d">-
</a><a href="#h24-0-91" id="h24-0-91" class="d">-    private fun getHookStageFromString(stage: String): HookStage {
</a><a href="#h24-0-92" id="h24-0-92" class="d">-        return when (stage) {
</a><a href="#h24-0-93" id="h24-0-93" class="d">-            &quot;before&quot; -&gt; HookStage.BEFORE
</a><a href="#h24-0-94" id="h24-0-94" class="d">-            &quot;after&quot; -&gt; HookStage.AFTER
</a><a href="#h24-0-95" id="h24-0-95" class="d">-            else -&gt; throw IllegalArgumentException(&quot;Invalid stage: $stage&quot;)
</a><a href="#h24-0-96" id="h24-0-96" class="d">-        }
</a><a href="#h24-0-97" id="h24-0-97" class="d">-    }
</a><a href="#h24-0-98" id="h24-0-98" class="d">-
</a><a href="#h24-0-99" id="h24-0-99" class="d">-    fun findMethod(clazz: Class&lt;*&gt;, methodName: String): Member? {
</a><a href="#h24-0-100" id="h24-0-100" class="d">-        return clazz.declaredMethods.find { it.name == methodName }
</a><a href="#h24-0-101" id="h24-0-101" class="d">-    }
</a><a href="#h24-0-102" id="h24-0-102" class="d">-
</a><a href="#h24-0-103" id="h24-0-103" class="d">-    fun findMethodWithParameters(clazz: Class&lt;*&gt;, methodName: String, vararg types: String): Member? {
</a><a href="#h24-0-104" id="h24-0-104" class="d">-        return clazz.declaredMethods.find { method -&gt; method.name == methodName &amp;&amp; method.parameterTypes.map { it.name }.toTypedArray() contentEquals types }
</a><a href="#h24-0-105" id="h24-0-105" class="d">-    }
</a><a href="#h24-0-106" id="h24-0-106" class="d">-
</a><a href="#h24-0-107" id="h24-0-107" class="d">-    fun findMethod(className: String, methodName: String): Member? {
</a><a href="#h24-0-108" id="h24-0-108" class="d">-        return findClassSafe(className)?.let { findMethod(it, methodName) }
</a><a href="#h24-0-109" id="h24-0-109" class="d">-    }
</a><a href="#h24-0-110" id="h24-0-110" class="d">-
</a><a href="#h24-0-111" id="h24-0-111" class="d">-    fun findMethodWithParameters(className: String, methodName: String, vararg types: String): Member? {
</a><a href="#h24-0-112" id="h24-0-112" class="d">-        return findClassSafe(className)?.let { findMethodWithParameters(it, methodName, *types) }
</a><a href="#h24-0-113" id="h24-0-113" class="d">-    }
</a><a href="#h24-0-114" id="h24-0-114" class="d">-
</a><a href="#h24-0-115" id="h24-0-115" class="d">-    fun findConstructor(clazz: Class&lt;*&gt;, vararg types: String): Member? {
</a><a href="#h24-0-116" id="h24-0-116" class="d">-        return clazz.declaredConstructors.find { constructor -&gt;  constructor.parameterTypes.map { it.name }.toTypedArray() contentEquals types }
</a><a href="#h24-0-117" id="h24-0-117" class="d">-    }
</a><a href="#h24-0-118" id="h24-0-118" class="d">-
</a><a href="#h24-0-119" id="h24-0-119" class="d">-    fun findConstructorParameters(className: String, vararg types: String): Member? {
</a><a href="#h24-0-120" id="h24-0-120" class="d">-        return findClassSafe(className)?.let { findConstructor(it, *types) }
</a><a href="#h24-0-121" id="h24-0-121" class="d">-    }
</a><a href="#h24-0-122" id="h24-0-122" class="d">-
</a><a href="#h24-0-123" id="h24-0-123" class="d">-    // -- hooking
</a><a href="#h24-0-124" id="h24-0-124" class="d">-
</a><a href="#h24-0-125" id="h24-0-125" class="d">-    fun hook(method: Member, stage: String, callback: HookCallback): HookUnhook {
</a><a href="#h24-0-126" id="h24-0-126" class="d">-        val hookAdapter = Hooker.hook(method, getHookStageFromString(stage)) {
</a><a href="#h24-0-127" id="h24-0-127" class="d">-            callback(ScriptHookCallback(it))
</a><a href="#h24-0-128" id="h24-0-128" class="d">-        }
</a><a href="#h24-0-129" id="h24-0-129" class="d">-
</a><a href="#h24-0-130" id="h24-0-130" class="d">-        return {
</a><a href="#h24-0-131" id="h24-0-131" class="d">-            hookAdapter.unhook()
</a><a href="#h24-0-132" id="h24-0-132" class="d">-        }.also { hooks.add(it) }
</a><a href="#h24-0-133" id="h24-0-133" class="d">-    }
</a><a href="#h24-0-134" id="h24-0-134" class="d">-
</a><a href="#h24-0-135" id="h24-0-135" class="d">-    fun hookAllMethods(clazz: Class&lt;*&gt;, methodName: String, stage: String, callback: HookCallback): HookUnhook {
</a><a href="#h24-0-136" id="h24-0-136" class="d">-        val hookAdapter = clazz.hook(methodName, getHookStageFromString(stage)) {
</a><a href="#h24-0-137" id="h24-0-137" class="d">-            callback(ScriptHookCallback(it))
</a><a href="#h24-0-138" id="h24-0-138" class="d">-        }
</a><a href="#h24-0-139" id="h24-0-139" class="d">-
</a><a href="#h24-0-140" id="h24-0-140" class="d">-        return {
</a><a href="#h24-0-141" id="h24-0-141" class="d">-            hookAdapter.forEach { it.unhook() }
</a><a href="#h24-0-142" id="h24-0-142" class="d">-        }.also { hooks.add(it) }
</a><a href="#h24-0-143" id="h24-0-143" class="d">-    }
</a><a href="#h24-0-144" id="h24-0-144" class="d">-
</a><a href="#h24-0-145" id="h24-0-145" class="d">-    fun hookAllConstructors(clazz: Class&lt;*&gt;, stage: String, callback: HookCallback): HookUnhook {
</a><a href="#h24-0-146" id="h24-0-146" class="d">-        val hookAdapter = clazz.hookConstructor(getHookStageFromString(stage)) {
</a><a href="#h24-0-147" id="h24-0-147" class="d">-            callback(ScriptHookCallback(it))
</a><a href="#h24-0-148" id="h24-0-148" class="d">-        }
</a><a href="#h24-0-149" id="h24-0-149" class="d">-
</a><a href="#h24-0-150" id="h24-0-150" class="d">-        return {
</a><a href="#h24-0-151" id="h24-0-151" class="d">-            hookAdapter.forEach { it.unhook() }
</a><a href="#h24-0-152" id="h24-0-152" class="d">-        }.also { hooks.add(it) }
</a><a href="#h24-0-153" id="h24-0-153" class="d">-    }
</a><a href="#h24-0-154" id="h24-0-154" class="d">-
</a><a href="#h24-0-155" id="h24-0-155" class="d">-    fun hookAllMethods(className: String, methodName: String, stage: String, callback: HookCallback)
</a><a href="#h24-0-156" id="h24-0-156" class="d">-        = findClassSafe(className)?.let { hookAllMethods(it, methodName, stage, callback) }
</a><a href="#h24-0-157" id="h24-0-157" class="d">-
</a><a href="#h24-0-158" id="h24-0-158" class="d">-    fun hookAllConstructors(className: String, stage: String, callback: HookCallback)
</a><a href="#h24-0-159" id="h24-0-159" class="d">-        = findClassSafe(className)?.let { hookAllConstructors(it, stage, callback) }
</a><a href="#h24-0-160" id="h24-0-160" class="d">-}</a><a href="#h24-0-161" id="h24-0-161" class="d">-
\ No newline at end of file
</a></pre>
</div>
</body>
</html>
